int main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nX509 *x509;\r\nPKCS7 *p7;\r\nBIO *in;\r\nBIO *data,*p7bio;\r\nchar buf[1024*4];\r\nint i;\r\nint nodetach=1;\r\nchar *keyfile = NULL;\r\nconst EVP_CIPHER *cipher=NULL;\r\nSTACK_OF(X509) *recips=NULL;\r\nOpenSSL_add_all_algorithms();\r\ndata=BIO_new(BIO_s_file());\r\nwhile(argc > 1)\r\n{\r\nif (strcmp(argv[1],"-nd") == 0)\r\n{\r\nnodetach=1;\r\nargv++; argc--;\r\n}\r\nelse if ((strcmp(argv[1],"-c") == 0) && (argc >= 2)) {\r\nif(!(cipher = EVP_get_cipherbyname(argv[2]))) {\r\nfprintf(stderr, "Unknown cipher %s\n", argv[2]);\r\ngoto err;\r\n}\r\nargc-=2;\r\nargv+=2;\r\n} else if ((strcmp(argv[1],"-k") == 0) && (argc >= 2)) {\r\nkeyfile = argv[2];\r\nargc-=2;\r\nargv+=2;\r\nif (!(in=BIO_new_file(keyfile,"r"))) goto err;\r\nif (!(x509=PEM_read_bio_X509(in,NULL,NULL,NULL)))\r\ngoto err;\r\nif(!recips) recips = sk_X509_new_null();\r\nsk_X509_push(recips, x509);\r\nBIO_free(in);\r\n} else break;\r\n}\r\nif(!recips) {\r\nfprintf(stderr, "No recipients\n");\r\ngoto err;\r\n}\r\nif (!BIO_read_filename(data,argv[1])) goto err;\r\np7=PKCS7_new();\r\n#if 0\r\nBIO_reset(in);\r\nif ((pkey=PEM_read_bio_PrivateKey(in,NULL,NULL)) == NULL) goto err;\r\nBIO_free(in);\r\nPKCS7_set_type(p7,NID_pkcs7_signedAndEnveloped);\r\nif (PKCS7_add_signature(p7,x509,pkey,EVP_sha1()) == NULL) goto err;\r\nPKCS7_add_certificate(p7,x509);\r\n#else\r\nPKCS7_set_type(p7,NID_pkcs7_enveloped);\r\n#endif\r\nif(!cipher) {\r\n#ifndef NO_DES\r\ncipher = EVP_des_ede3_cbc();\r\n#else\r\nfprintf(stderr, "No cipher selected\n");\r\ngoto err;\r\n#endif\r\n}\r\nif (!PKCS7_set_cipher(p7,cipher)) goto err;\r\nfor(i = 0; i < sk_X509_num(recips); i++) {\r\nif (!PKCS7_add_recipient(p7,sk_X509_value(recips, i))) goto err;\r\n}\r\nsk_X509_pop_free(recips, X509_free);\r\nif ((p7bio=PKCS7_dataInit(p7,NULL)) == NULL) goto err;\r\nfor (;;)\r\n{\r\ni=BIO_read(data,buf,sizeof(buf));\r\nif (i <= 0) break;\r\nBIO_write(p7bio,buf,i);\r\n}\r\nBIO_flush(p7bio);\r\nif (!PKCS7_dataFinal(p7,p7bio)) goto err;\r\nBIO_free(p7bio);\r\nPEM_write_PKCS7(stdout,p7);\r\nPKCS7_free(p7);\r\nexit(0);\r\nerr:\r\nERR_load_crypto_strings();\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}

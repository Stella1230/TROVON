int BN_add(BIGNUM *r, const BIGNUM *a, const BIGNUM *b)\r\n{\r\nconst BIGNUM *tmp;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nif (a->neg ^ b->neg)\r\n{\r\nif (a->neg)\r\n{ tmp=a; a=b; b=tmp; }\r\nif (BN_ucmp(a,b) < 0)\r\n{\r\nif (!BN_usub(r,b,a)) return(0);\r\nr->neg=1;\r\n}\r\nelse\r\n{\r\nif (!BN_usub(r,a,b)) return(0);\r\nr->neg=0;\r\n}\r\nreturn(1);\r\n}\r\nif (a->neg)\r\nr->neg=1;\r\nelse\r\nr->neg=0;\r\nif (!BN_uadd(r,a,b)) return(0);\r\nreturn(1);\r\n}\r\nint BN_uadd(BIGNUM *r, const BIGNUM *a, const BIGNUM *b)\r\n{\r\nregister int i;\r\nint max,min;\r\nBN_ULONG *ap,*bp,*rp,carry,t1;\r\nconst BIGNUM *tmp;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nif (a->top < b->top)\r\n{ tmp=a; a=b; b=tmp; }\r\nmax=a->top;\r\nmin=b->top;\r\nif (bn_wexpand(r,max+1) == NULL)\r\nreturn(0);\r\nr->top=max;\r\nap=a->d;\r\nbp=b->d;\r\nrp=r->d;\r\ncarry=0;\r\ncarry=bn_add_words(rp,ap,bp,min);\r\nrp+=min;\r\nap+=min;\r\nbp+=min;\r\ni=min;\r\nif (carry)\r\n{\r\nwhile (i < max)\r\n{\r\ni++;\r\nt1= *(ap++);\r\nif ((*(rp++)=(t1+1)&BN_MASK2) >= t1)\r\n{\r\ncarry=0;\r\nbreak;\r\n}\r\n}\r\nif ((i >= max) && carry)\r\n{\r\n*(rp++)=1;\r\nr->top++;\r\n}\r\n}\r\nif (rp != ap)\r\n{\r\nfor (; i<max; i++)\r\n*(rp++)= *(ap++);\r\n}\r\nreturn(1);\r\n}\r\nint BN_usub(BIGNUM *r, const BIGNUM *a, const BIGNUM *b)\r\n{\r\nint max,min;\r\nregister BN_ULONG t1,t2,*ap,*bp,*rp;\r\nint i,carry;\r\n#if defined(IRIX_CC_BUG) && !defined(LINT)\r\nint dummy;\r\n#endif\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nif (a->top < b->top)\r\n{\r\nBNerr(BN_F_BN_USUB,BN_R_ARG2_LT_ARG3);\r\nreturn(0);\r\n}\r\nmax=a->top;\r\nmin=b->top;\r\nif (bn_wexpand(r,max) == NULL) return(0);\r\nap=a->d;\r\nbp=b->d;\r\nrp=r->d;\r\n#if 1\r\ncarry=0;\r\nfor (i=0; i<min; i++)\r\n{\r\nt1= *(ap++);\r\nt2= *(bp++);\r\nif (carry)\r\n{\r\ncarry=(t1 <= t2);\r\nt1=(t1-t2-1)&BN_MASK2;\r\n}\r\nelse\r\n{\r\ncarry=(t1 < t2);\r\nt1=(t1-t2)&BN_MASK2;\r\n}\r\n#if defined(IRIX_CC_BUG) && !defined(LINT)\r\ndummy=t1;\r\n#endif\r\n*(rp++)=t1&BN_MASK2;\r\n}\r\n#else\r\ncarry=bn_sub_words(rp,ap,bp,min);\r\nap+=min;\r\nbp+=min;\r\nrp+=min;\r\ni=min;\r\n#endif\r\nif (carry)\r\n{\r\nwhile (i < max)\r\n{\r\ni++;\r\nt1= *(ap++);\r\nt2=(t1-1)&BN_MASK2;\r\n*(rp++)=t2;\r\nif (t1 > t2) break;\r\n}\r\n}\r\n#if 0\r\nmemcpy(rp,ap,sizeof(*rp)*(max-i));\r\n#else\r\nif (rp != ap)\r\n{\r\nfor (;;)\r\n{\r\nif (i++ >= max) break;\r\nrp[0]=ap[0];\r\nif (i++ >= max) break;\r\nrp[1]=ap[1];\r\nif (i++ >= max) break;\r\nrp[2]=ap[2];\r\nif (i++ >= max) break;\r\nrp[3]=ap[3];\r\nrp+=4;\r\nap+=4;\r\n}\r\n}\r\n#endif\r\nr->top=max;\r\nbn_fix_top(r);\r\nreturn(1);\r\n}\r\nint BN_sub(BIGNUM *r, const BIGNUM *a, const BIGNUM *b)\r\n{\r\nint max;\r\nint add=0,neg=0;\r\nconst BIGNUM *tmp;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nif (a->neg)\r\n{\r\nif (b->neg)\r\n{ tmp=a; a=b; b=tmp; }\r\nelse\r\n{ add=1; neg=1; }\r\n}\r\nelse\r\n{\r\nif (b->neg) { add=1; neg=0; }\r\n}\r\nif (add)\r\n{\r\nif (!BN_uadd(r,a,b)) return(0);\r\nr->neg=neg;\r\nreturn(1);\r\n}\r\nmax=(a->top > b->top)?a->top:b->top;\r\nif (bn_wexpand(r,max) == NULL) return(0);\r\nif (BN_ucmp(a,b) < 0)\r\n{\r\nif (!BN_usub(r,b,a)) return(0);\r\nr->neg=1;\r\n}\r\nelse\r\n{\r\nif (!BN_usub(r,a,b)) return(0);\r\nr->neg=0;\r\n}\r\nreturn(1);\r\n}

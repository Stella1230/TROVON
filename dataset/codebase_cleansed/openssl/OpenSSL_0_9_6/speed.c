SIGRETTYPE sig_done(int sig)\r\n{\r\nsignal(SIGALRM,sig_done);\r\nrun=0;\r\n#ifdef LINT\r\nsig=sig;\r\n#endif\r\n}\r\ndouble Time_F(int s)\r\n{\r\ndouble ret;\r\n#ifdef TIMES\r\nstatic struct tms tstart,tend;\r\nif (s == START)\r\n{\r\ntimes(&tstart);\r\nreturn(0);\r\n}\r\nelse\r\n{\r\ntimes(&tend);\r\nret=((double)(tend.tms_utime-tstart.tms_utime))/HZ;\r\nreturn((ret == 0.0)?1e-6:ret);\r\n}\r\n#else\r\nstatic struct timeb tstart,tend;\r\nlong i;\r\nif (s == START)\r\n{\r\nftime(&tstart);\r\nreturn(0);\r\n}\r\nelse\r\n{\r\nftime(&tend);\r\ni=(long)tend.millitm-(long)tstart.millitm;\r\nret=((double)(tend.time-tstart.time))+((double)i)/1e3;\r\nreturn((ret == 0.0)?1e-6:ret);\r\n}\r\n#endif\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nlong count;\r\nstatic unsigned char buf[BUFSIZE];\r\nstatic des_cblock key ={0x12,0x34,0x56,0x78,0x9a,0xbc,0xde,0xf0};\r\nstatic des_cblock key2={0x34,0x56,0x78,0x9a,0xbc,0xde,0xf0,0x12};\r\nstatic des_cblock key3={0x56,0x78,0x9a,0xbc,0xde,0xf0,0x12,0x34};\r\ndes_key_schedule sch,sch2,sch3;\r\ndouble a,b,c,d,e;\r\n#ifndef SIGALRM\r\nlong ca,cb,cc,cd,ce;\r\n#endif\r\n#ifndef TIMES\r\nprintf("To get the most accurate results, try to run this\n");\r\nprintf("program when this computer is idle.\n");\r\n#endif\r\ndes_set_key_unchecked(&key2,sch2);\r\ndes_set_key_unchecked(&key3,sch3);\r\n#ifndef SIGALRM\r\nprintf("First we calculate the approximate speed ...\n");\r\ndes_set_key_unchecked(&key,sch);\r\ncount=10;\r\ndo {\r\nlong i;\r\nDES_LONG data[2];\r\ncount*=2;\r\nTime_F(START);\r\nfor (i=count; i; i--)\r\ndes_encrypt(data,&(sch[0]),DES_ENCRYPT);\r\nd=Time_F(STOP);\r\n} while (d < 3.0);\r\nca=count;\r\ncb=count*3;\r\ncc=count*3*8/BUFSIZE+1;\r\ncd=count*8/BUFSIZE+1;\r\nce=count/20+1;\r\nprintf("Doing set_key %ld times\n",ca);\r\n#define COND(d) (count != (d))\r\n#define COUNT(d) (d)\r\n#else\r\n#define COND(c) (run)\r\n#define COUNT(d) (count)\r\nsignal(SIGALRM,sig_done);\r\nprintf("Doing set_key for 10 seconds\n");\r\nalarm(10);\r\n#endif\r\nTime_F(START);\r\nfor (count=0,run=1; COND(ca); count++)\r\ndes_set_key_unchecked(&key,sch);\r\nd=Time_F(STOP);\r\nprintf("%ld set_key's in %.2f seconds\n",count,d);\r\na=((double)COUNT(ca))/d;\r\n#ifdef SIGALRM\r\nprintf("Doing des_encrypt's for 10 seconds\n");\r\nalarm(10);\r\n#else\r\nprintf("Doing des_encrypt %ld times\n",cb);\r\n#endif\r\nTime_F(START);\r\nfor (count=0,run=1; COND(cb); count++)\r\n{\r\nDES_LONG data[2];\r\ndes_encrypt(data,&(sch[0]),DES_ENCRYPT);\r\n}\r\nd=Time_F(STOP);\r\nprintf("%ld des_encrypt's in %.2f second\n",count,d);\r\nb=((double)COUNT(cb)*8)/d;\r\n#ifdef SIGALRM\r\nprintf("Doing des_cbc_encrypt on %ld byte blocks for 10 seconds\n",\r\nBUFSIZE);\r\nalarm(10);\r\n#else\r\nprintf("Doing des_cbc_encrypt %ld times on %ld byte blocks\n",cc,\r\nBUFSIZE);\r\n#endif\r\nTime_F(START);\r\nfor (count=0,run=1; COND(cc); count++)\r\ndes_ncbc_encrypt(buf,buf,BUFSIZE,&(sch[0]),\r\n&key,DES_ENCRYPT);\r\nd=Time_F(STOP);\r\nprintf("%ld des_cbc_encrypt's of %ld byte blocks in %.2f second\n",\r\ncount,BUFSIZE,d);\r\nc=((double)COUNT(cc)*BUFSIZE)/d;\r\n#ifdef SIGALRM\r\nprintf("Doing des_ede_cbc_encrypt on %ld byte blocks for 10 seconds\n",\r\nBUFSIZE);\r\nalarm(10);\r\n#else\r\nprintf("Doing des_ede_cbc_encrypt %ld times on %ld byte blocks\n",cd,\r\nBUFSIZE);\r\n#endif\r\nTime_F(START);\r\nfor (count=0,run=1; COND(cd); count++)\r\ndes_ede3_cbc_encrypt(buf,buf,BUFSIZE,\r\n&(sch[0]),\r\n&(sch2[0]),\r\n&(sch3[0]),\r\n&key,\r\nDES_ENCRYPT);\r\nd=Time_F(STOP);\r\nprintf("%ld des_ede_cbc_encrypt's of %ld byte blocks in %.2f second\n",\r\ncount,BUFSIZE,d);\r\nd=((double)COUNT(cd)*BUFSIZE)/d;\r\n#ifdef SIGALRM\r\nprintf("Doing crypt for 10 seconds\n");\r\nalarm(10);\r\n#else\r\nprintf("Doing crypt %ld times\n",ce);\r\n#endif\r\nTime_F(START);\r\nfor (count=0,run=1; COND(ce); count++)\r\ncrypt("testing1","ef");\r\ne=Time_F(STOP);\r\nprintf("%ld crypts in %.2f second\n",count,e);\r\ne=((double)COUNT(ce))/e;\r\nprintf("set_key per sec = %12.2f (%9.3fuS)\n",a,1.0e6/a);\r\nprintf("DES raw ecb bytes per sec = %12.2f (%9.3fuS)\n",b,8.0e6/b);\r\nprintf("DES cbc bytes per sec = %12.2f (%9.3fuS)\n",c,8.0e6/c);\r\nprintf("DES ede cbc bytes per sec = %12.2f (%9.3fuS)\n",d,8.0e6/d);\r\nprintf("crypt per sec = %12.2f (%9.3fuS)\n",e,1.0e6/e);\r\nexit(0);\r\n#if defined(LINT) || defined(MSDOS)\r\nreturn(0);\r\n#endif\r\n}

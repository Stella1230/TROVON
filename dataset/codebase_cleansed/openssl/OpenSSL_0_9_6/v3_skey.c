char *i2s_ASN1_OCTET_STRING(X509V3_EXT_METHOD *method,\r\nASN1_OCTET_STRING *oct)\r\n{\r\nreturn hex_to_string(oct->data, oct->length);\r\n}\r\nASN1_OCTET_STRING *s2i_ASN1_OCTET_STRING(X509V3_EXT_METHOD *method,\r\nX509V3_CTX *ctx, char *str)\r\n{\r\nASN1_OCTET_STRING *oct;\r\nlong length;\r\nif(!(oct = M_ASN1_OCTET_STRING_new())) {\r\nX509V3err(X509V3_F_S2I_ASN1_OCTET_STRING,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nif(!(oct->data = string_to_hex(str, &length))) {\r\nM_ASN1_OCTET_STRING_free(oct);\r\nreturn NULL;\r\n}\r\noct->length = length;\r\nreturn oct;\r\n}\r\nstatic ASN1_OCTET_STRING *s2i_skey_id(X509V3_EXT_METHOD *method,\r\nX509V3_CTX *ctx, char *str)\r\n{\r\nASN1_OCTET_STRING *oct;\r\nASN1_BIT_STRING *pk;\r\nunsigned char pkey_dig[EVP_MAX_MD_SIZE];\r\nEVP_MD_CTX md;\r\nunsigned int diglen;\r\nif(strcmp(str, "hash")) return s2i_ASN1_OCTET_STRING(method, ctx, str);\r\nif(!(oct = M_ASN1_OCTET_STRING_new())) {\r\nX509V3err(X509V3_F_S2I_S2I_SKEY_ID,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nif(ctx && (ctx->flags == CTX_TEST)) return oct;\r\nif(!ctx || (!ctx->subject_req && !ctx->subject_cert)) {\r\nX509V3err(X509V3_F_S2I_ASN1_SKEY_ID,X509V3_R_NO_PUBLIC_KEY);\r\ngoto err;\r\n}\r\nif(ctx->subject_req)\r\npk = ctx->subject_req->req_info->pubkey->public_key;\r\nelse pk = ctx->subject_cert->cert_info->key->public_key;\r\nif(!pk) {\r\nX509V3err(X509V3_F_S2I_ASN1_SKEY_ID,X509V3_R_NO_PUBLIC_KEY);\r\ngoto err;\r\n}\r\nEVP_DigestInit(&md, EVP_sha1());\r\nEVP_DigestUpdate(&md, pk->data, pk->length);\r\nEVP_DigestFinal(&md, pkey_dig, &diglen);\r\nif(!M_ASN1_OCTET_STRING_set(oct, pkey_dig, diglen)) {\r\nX509V3err(X509V3_F_S2I_S2I_SKEY_ID,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nreturn oct;\r\nerr:\r\nM_ASN1_OCTET_STRING_free(oct);\r\nreturn NULL;\r\n}

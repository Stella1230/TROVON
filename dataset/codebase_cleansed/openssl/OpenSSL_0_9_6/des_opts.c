SIGRETTYPE sig_done(int sig)\r\n{\r\nsignal(SIGALRM,sig_done);\r\nrun=0;\r\n#ifdef LINT\r\nsig=sig;\r\n#endif\r\n}\r\ndouble Time_F(int s)\r\n{\r\ndouble ret;\r\n#ifdef TIMES\r\nstatic struct tms tstart,tend;\r\nif (s == START)\r\n{\r\ntimes(&tstart);\r\nreturn(0);\r\n}\r\nelse\r\n{\r\ntimes(&tend);\r\nret=((double)(tend.tms_utime-tstart.tms_utime))/HZ;\r\nreturn((ret == 0.0)?1e-6:ret);\r\n}\r\n#else\r\nstatic struct timeb tstart,tend;\r\nlong i;\r\nif (s == START)\r\n{\r\nftime(&tstart);\r\nreturn(0);\r\n}\r\nelse\r\n{\r\nftime(&tend);\r\ni=(long)tend.millitm-(long)tstart.millitm;\r\nret=((double)(tend.time-tstart.time))+((double)i)/1000.0;\r\nreturn((ret == 0.0)?1e-6:ret);\r\n}\r\n#endif\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nlong count;\r\nstatic unsigned char buf[BUFSIZE];\r\nstatic des_cblock key ={0x12,0x34,0x56,0x78,0x9a,0xbc,0xde,0xf0};\r\nstatic des_cblock key2={0x34,0x56,0x78,0x9a,0xbc,0xde,0xf0,0x12};\r\nstatic des_cblock key3={0x56,0x78,0x9a,0xbc,0xde,0xf0,0x12,0x34};\r\ndes_key_schedule sch,sch2,sch3;\r\ndouble d,tm[16],max=0;\r\nint rank[16];\r\nchar *str[16];\r\nint max_idx=0,i,num=0,j;\r\n#ifndef SIGALARM\r\nlong ca,cb,cc,cd,ce;\r\n#endif\r\nfor (i=0; i<12; i++)\r\n{\r\ntm[i]=0.0;\r\nrank[i]=0;\r\n}\r\n#ifndef TIMES\r\nfprintf(stderr,"To get the most accurate results, try to run this\n");\r\nfprintf(stderr,"program when this computer is idle.\n");\r\n#endif\r\ndes_set_key_unchecked(&key,sch);\r\ndes_set_key_unchecked(&key2,sch2);\r\ndes_set_key_unchecked(&key3,sch3);\r\n#ifndef SIGALRM\r\nfprintf(stderr,"First we calculate the approximate speed ...\n");\r\ndes_set_key_unchecked(&key,sch);\r\ncount=10;\r\ndo {\r\nlong i;\r\nunsigned long data[2];\r\ncount*=2;\r\nTime_F(START);\r\nfor (i=count; i; i--)\r\ndes_encrypt(data,&(sch[0]),DES_ENCRYPT);\r\nd=Time_F(STOP);\r\n} while (d < 3.0);\r\nca=count;\r\ncb=count*3;\r\ncc=count*3*8/BUFSIZE+1;\r\ncd=count*8/BUFSIZE+1;\r\nce=count/20+1;\r\n#define COND(d) (count != (d))\r\n#define COUNT(d) (d)\r\n#else\r\n#define COND(c) (run)\r\n#define COUNT(d) (count)\r\nsignal(SIGALRM,sig_done);\r\nalarm(10);\r\n#endif\r\n#ifdef PART1\r\ntime_it(des_encrypt_u4_cisc_idx, "des_encrypt_u4_cisc_idx ", 0);\r\ntime_it(des_encrypt_u16_cisc_idx, "des_encrypt_u16_cisc_idx ", 1);\r\ntime_it(des_encrypt_u4_risc1_idx, "des_encrypt_u4_risc1_idx ", 2);\r\nnum+=3;\r\n#endif\r\n#ifdef PART2\r\ntime_it(des_encrypt_u16_risc1_idx,"des_encrypt_u16_risc1_idx", 3);\r\ntime_it(des_encrypt_u4_risc2_idx, "des_encrypt_u4_risc2_idx ", 4);\r\ntime_it(des_encrypt_u16_risc2_idx,"des_encrypt_u16_risc2_idx", 5);\r\nnum+=3;\r\n#endif\r\n#ifdef PART3\r\ntime_it(des_encrypt_u4_cisc_ptr, "des_encrypt_u4_cisc_ptr ", 6);\r\ntime_it(des_encrypt_u16_cisc_ptr, "des_encrypt_u16_cisc_ptr ", 7);\r\ntime_it(des_encrypt_u4_risc1_ptr, "des_encrypt_u4_risc1_ptr ", 8);\r\nnum+=3;\r\n#endif\r\n#ifdef PART4\r\ntime_it(des_encrypt_u16_risc1_ptr,"des_encrypt_u16_risc1_ptr", 9);\r\ntime_it(des_encrypt_u4_risc2_ptr, "des_encrypt_u4_risc2_ptr ",10);\r\ntime_it(des_encrypt_u16_risc2_ptr,"des_encrypt_u16_risc2_ptr",11);\r\nnum+=3;\r\n#endif\r\n#ifdef PART1\r\nstr[0]=" 4 c i";\r\nprint_it("des_encrypt_u4_cisc_idx ",0);\r\nmax=tm[0];\r\nmax_idx=0;\r\nstr[1]="16 c i";\r\nprint_it("des_encrypt_u16_cisc_idx ",1);\r\nif (max < tm[1]) { max=tm[1]; max_idx=1; }\r\nstr[2]=" 4 r1 i";\r\nprint_it("des_encrypt_u4_risc1_idx ",2);\r\nif (max < tm[2]) { max=tm[2]; max_idx=2; }\r\n#endif\r\n#ifdef PART2\r\nstr[3]="16 r1 i";\r\nprint_it("des_encrypt_u16_risc1_idx",3);\r\nif (max < tm[3]) { max=tm[3]; max_idx=3; }\r\nstr[4]=" 4 r2 i";\r\nprint_it("des_encrypt_u4_risc2_idx ",4);\r\nif (max < tm[4]) { max=tm[4]; max_idx=4; }\r\nstr[5]="16 r2 i";\r\nprint_it("des_encrypt_u16_risc2_idx",5);\r\nif (max < tm[5]) { max=tm[5]; max_idx=5; }\r\n#endif\r\n#ifdef PART3\r\nstr[6]=" 4 c p";\r\nprint_it("des_encrypt_u4_cisc_ptr ",6);\r\nif (max < tm[6]) { max=tm[6]; max_idx=6; }\r\nstr[7]="16 c p";\r\nprint_it("des_encrypt_u16_cisc_ptr ",7);\r\nif (max < tm[7]) { max=tm[7]; max_idx=7; }\r\nstr[8]=" 4 r1 p";\r\nprint_it("des_encrypt_u4_risc1_ptr ",8);\r\nif (max < tm[8]) { max=tm[8]; max_idx=8; }\r\n#endif\r\n#ifdef PART4\r\nstr[9]="16 r1 p";\r\nprint_it("des_encrypt_u16_risc1_ptr",9);\r\nif (max < tm[9]) { max=tm[9]; max_idx=9; }\r\nstr[10]=" 4 r2 p";\r\nprint_it("des_encrypt_u4_risc2_ptr ",10);\r\nif (max < tm[10]) { max=tm[10]; max_idx=10; }\r\nstr[11]="16 r2 p";\r\nprint_it("des_encrypt_u16_risc2_ptr",11);\r\nif (max < tm[11]) { max=tm[11]; max_idx=11; }\r\n#endif\r\nprintf("options des ecb/s\n");\r\nprintf("%s %12.2f 100.0%%\n",str[max_idx],tm[max_idx]);\r\nd=tm[max_idx];\r\ntm[max_idx]= -2.0;\r\nmax= -1.0;\r\nfor (;;)\r\n{\r\nfor (i=0; i<12; i++)\r\n{\r\nif (max < tm[i]) { max=tm[i]; j=i; }\r\n}\r\nif (max < 0.0) break;\r\nprintf("%s %12.2f %4.1f%%\n",str[j],tm[j],tm[j]/d*100.0);\r\ntm[j]= -2.0;\r\nmax= -1.0;\r\n}\r\nswitch (max_idx)\r\n{\r\ncase 0:\r\nprintf("-DDES_DEFAULT_OPTIONS\n");\r\nbreak;\r\ncase 1:\r\nprintf("-DDES_UNROLL\n");\r\nbreak;\r\ncase 2:\r\nprintf("-DDES_RISC1\n");\r\nbreak;\r\ncase 3:\r\nprintf("-DDES_UNROLL -DDES_RISC1\n");\r\nbreak;\r\ncase 4:\r\nprintf("-DDES_RISC2\n");\r\nbreak;\r\ncase 5:\r\nprintf("-DDES_UNROLL -DDES_RISC2\n");\r\nbreak;\r\ncase 6:\r\nprintf("-DDES_PTR\n");\r\nbreak;\r\ncase 7:\r\nprintf("-DDES_UNROLL -DDES_PTR\n");\r\nbreak;\r\ncase 8:\r\nprintf("-DDES_RISC1 -DDES_PTR\n");\r\nbreak;\r\ncase 9:\r\nprintf("-DDES_UNROLL -DDES_RISC1 -DDES_PTR\n");\r\nbreak;\r\ncase 10:\r\nprintf("-DDES_RISC2 -DDES_PTR\n");\r\nbreak;\r\ncase 11:\r\nprintf("-DDES_UNROLL -DDES_RISC2 -DDES_PTR\n");\r\nbreak;\r\n}\r\nexit(0);\r\n#if defined(LINT) || defined(MSDOS)\r\nreturn(0);\r\n#endif\r\n}

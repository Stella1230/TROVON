void des_3cbc_encrypt(des_cblock *input, des_cblock *output, long length,\r\ndes_key_schedule ks1, des_key_schedule ks2, des_cblock *iv1,\r\ndes_cblock *iv2, int enc)\r\n{\r\nint off=((int)length-1)/8;\r\nlong l8=((length+7)/8)*8;\r\ndes_cblock niv1,niv2;\r\nif (enc == DES_ENCRYPT)\r\n{\r\ndes_cbc_encrypt((unsigned char*)input,\r\n(unsigned char*)output,length,ks1,iv1,enc);\r\nif (length >= sizeof(des_cblock))\r\nmemcpy(niv1,output[off],sizeof(des_cblock));\r\ndes_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,l8,ks2,iv1,!enc);\r\ndes_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,l8,ks1,iv2,enc);\r\nif (length >= sizeof(des_cblock))\r\nmemcpy(niv2,output[off],sizeof(des_cblock));\r\n}\r\nelse\r\n{\r\nif (length >= sizeof(des_cblock))\r\nmemcpy(niv2,input[off],sizeof(des_cblock));\r\ndes_cbc_encrypt((unsigned char*)input,\r\n(unsigned char*)output,l8,ks1,iv2,enc);\r\ndes_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,l8,ks2,iv1,!enc);\r\nif (length >= sizeof(des_cblock))\r\nmemcpy(niv1,output[off],sizeof(des_cblock));\r\ndes_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,length,ks1,iv1,enc);\r\n}\r\nmemcpy(*iv1,niv1,sizeof(des_cblock));\r\nmemcpy(*iv2,niv2,sizeof(des_cblock));\r\n}

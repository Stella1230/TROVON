DSA *DSA_generate_parameters(int bits, unsigned char *seed_in, int seed_len,\r\nint *counter_ret, unsigned long *h_ret,\r\nvoid (*callback)(int, int, void *),\r\nvoid *cb_arg)\r\n{\r\nint ok=0;\r\nunsigned char seed[SHA_DIGEST_LENGTH];\r\nunsigned char md[SHA_DIGEST_LENGTH];\r\nunsigned char buf[SHA_DIGEST_LENGTH],buf2[SHA_DIGEST_LENGTH];\r\nBIGNUM *r0,*W,*X,*c,*test;\r\nBIGNUM *g=NULL,*q=NULL,*p=NULL;\r\nBN_MONT_CTX *mont=NULL;\r\nint k,n=0,i,b,m=0;\r\nint counter=0;\r\nint r=0;\r\nBN_CTX *ctx=NULL,*ctx2=NULL,*ctx3=NULL;\r\nunsigned int h=2;\r\nDSA *ret=NULL;\r\nif (bits < 512) bits=512;\r\nbits=(bits+63)/64*64;\r\nif (seed_len < 20)\r\nseed_in = NULL;\r\nif (seed_len > 20)\r\nseed_len = 20;\r\nif ((seed_in != NULL) && (seed_len == 20))\r\nmemcpy(seed,seed_in,seed_len);\r\nif ((ctx=BN_CTX_new()) == NULL) goto err;\r\nif ((ctx2=BN_CTX_new()) == NULL) goto err;\r\nif ((ctx3=BN_CTX_new()) == NULL) goto err;\r\nif ((ret=DSA_new()) == NULL) goto err;\r\nif ((mont=BN_MONT_CTX_new()) == NULL) goto err;\r\nBN_CTX_start(ctx2);\r\nr0 = BN_CTX_get(ctx2);\r\ng = BN_CTX_get(ctx2);\r\nW = BN_CTX_get(ctx2);\r\nq = BN_CTX_get(ctx2);\r\nX = BN_CTX_get(ctx2);\r\nc = BN_CTX_get(ctx2);\r\np = BN_CTX_get(ctx2);\r\ntest = BN_CTX_get(ctx2);\r\nBN_lshift(test,BN_value_one(),bits-1);\r\nfor (;;)\r\n{\r\nfor (;;)\r\n{\r\nint seed_is_random;\r\nif (callback != NULL) callback(0,m++,cb_arg);\r\nif (!seed_len)\r\n{\r\nRAND_pseudo_bytes(seed,SHA_DIGEST_LENGTH);\r\nseed_is_random = 1;\r\n}\r\nelse\r\n{\r\nseed_is_random = 0;\r\nseed_len=0;\r\n}\r\nmemcpy(buf,seed,SHA_DIGEST_LENGTH);\r\nmemcpy(buf2,seed,SHA_DIGEST_LENGTH);\r\nfor (i=SHA_DIGEST_LENGTH-1; i >= 0; i--)\r\n{\r\nbuf[i]++;\r\nif (buf[i] != 0) break;\r\n}\r\nHASH(seed,SHA_DIGEST_LENGTH,md);\r\nHASH(buf,SHA_DIGEST_LENGTH,buf2);\r\nfor (i=0; i<SHA_DIGEST_LENGTH; i++)\r\nmd[i]^=buf2[i];\r\nmd[0]|=0x80;\r\nmd[SHA_DIGEST_LENGTH-1]|=0x01;\r\nif (!BN_bin2bn(md,SHA_DIGEST_LENGTH,q)) goto err;\r\nr = BN_is_prime_fasttest(q, DSS_prime_checks, callback, ctx3, cb_arg, seed_is_random);\r\nif (r > 0)\r\nbreak;\r\nif (r != 0)\r\ngoto err;\r\n}\r\nif (callback != NULL) callback(2,0,cb_arg);\r\nif (callback != NULL) callback(3,0,cb_arg);\r\ncounter=0;\r\nn=(bits-1)/160;\r\nb=(bits-1)-n*160;\r\nfor (;;)\r\n{\r\nif (callback != NULL && counter != 0)\r\ncallback(0,counter,cb_arg);\r\nBN_zero(W);\r\nfor (k=0; k<=n; k++)\r\n{\r\nfor (i=SHA_DIGEST_LENGTH-1; i >= 0; i--)\r\n{\r\nbuf[i]++;\r\nif (buf[i] != 0) break;\r\n}\r\nHASH(buf,SHA_DIGEST_LENGTH,md);\r\nif (!BN_bin2bn(md,SHA_DIGEST_LENGTH,r0))\r\ngoto err;\r\nBN_lshift(r0,r0,160*k);\r\nBN_add(W,W,r0);\r\n}\r\nBN_mask_bits(W,bits-1);\r\nBN_copy(X,W);\r\nBN_add(X,X,test);\r\nBN_lshift1(r0,q);\r\nBN_mod(c,X,r0,ctx);\r\nBN_sub(r0,c,BN_value_one());\r\nBN_sub(p,X,r0);\r\nif (BN_cmp(p,test) >= 0)\r\n{\r\nr = BN_is_prime_fasttest(p, DSS_prime_checks, callback, ctx3, cb_arg, 1);\r\nif (r > 0)\r\ngoto end;\r\nif (r != 0)\r\ngoto err;\r\n}\r\ncounter++;\r\nif (counter >= 4096) break;\r\n}\r\n}\r\nend:\r\nif (callback != NULL) callback(2,1,cb_arg);\r\nBN_sub(test,p,BN_value_one());\r\nBN_div(r0,NULL,test,q,ctx);\r\nBN_set_word(test,h);\r\nBN_MONT_CTX_set(mont,p,ctx);\r\nfor (;;)\r\n{\r\nBN_mod_exp_mont(g,test,r0,p,ctx,mont);\r\nif (!BN_is_one(g)) break;\r\nBN_add(test,test,BN_value_one());\r\nh++;\r\n}\r\nif (callback != NULL) callback(3,1,cb_arg);\r\nok=1;\r\nerr:\r\nif (!ok)\r\n{\r\nif (ret != NULL) DSA_free(ret);\r\n}\r\nelse\r\n{\r\nret->p=BN_dup(p);\r\nret->q=BN_dup(q);\r\nret->g=BN_dup(g);\r\nif ((m > 1) && (seed_in != NULL)) memcpy(seed_in,seed,20);\r\nif (counter_ret != NULL) *counter_ret=counter;\r\nif (h_ret != NULL) *h_ret=h;\r\n}\r\nif (ctx != NULL) BN_CTX_free(ctx);\r\nif (ctx2 != NULL)\r\n{\r\nBN_CTX_end(ctx2);\r\nBN_CTX_free(ctx2);\r\n}\r\nif (ctx3 != NULL) BN_CTX_free(ctx3);\r\nif (mont != NULL) BN_MONT_CTX_free(mont);\r\nreturn(ok?ret:NULL);\r\n}

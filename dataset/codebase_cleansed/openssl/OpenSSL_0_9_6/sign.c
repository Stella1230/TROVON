int main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nX509 *x509;\r\nEVP_PKEY *pkey;\r\nPKCS7 *p7;\r\nPKCS7_SIGNER_INFO *si;\r\nBIO *in;\r\nBIO *data,*p7bio;\r\nchar buf[1024*4];\r\nint i;\r\nint nodetach=0;\r\n#ifndef NO_MD2\r\nEVP_add_digest(EVP_md2());\r\n#endif\r\n#ifndef NO_MD5\r\nEVP_add_digest(EVP_md5());\r\n#endif\r\n#ifndef NO_SHA1\r\nEVP_add_digest(EVP_sha1());\r\n#endif\r\n#ifndef NO_MDC2\r\nEVP_add_digest(EVP_mdc2());\r\n#endif\r\ndata=BIO_new(BIO_s_file());\r\nagain:\r\nif (argc > 1)\r\n{\r\nif (strcmp(argv[1],"-nd") == 0)\r\n{\r\nnodetach=1;\r\nargv++; argc--;\r\ngoto again;\r\n}\r\nif (!BIO_read_filename(data,argv[1]))\r\ngoto err;\r\n}\r\nelse\r\nBIO_set_fp(data,stdin,BIO_NOCLOSE);\r\nif ((in=BIO_new_file("server.pem","r")) == NULL) goto err;\r\nif ((x509=PEM_read_bio_X509(in,NULL,NULL,NULL)) == NULL) goto err;\r\nBIO_reset(in);\r\nif ((pkey=PEM_read_bio_PrivateKey(in,NULL,NULL,NULL)) == NULL) goto err;\r\nBIO_free(in);\r\np7=PKCS7_new();\r\nPKCS7_set_type(p7,NID_pkcs7_signed);\r\nsi=PKCS7_add_signature(p7,x509,pkey,EVP_sha1());\r\nif (si == NULL) goto err;\r\nPKCS7_add_signed_attribute(si, NID_pkcs9_contentType, V_ASN1_OBJECT,\r\nOBJ_nid2obj(NID_pkcs7_data));\r\nPKCS7_add_certificate(p7,x509);\r\nPKCS7_content_new(p7,NID_pkcs7_data);\r\nif (!nodetach)\r\nPKCS7_set_detached(p7,1);\r\nif ((p7bio=PKCS7_dataInit(p7,NULL)) == NULL) goto err;\r\nfor (;;)\r\n{\r\ni=BIO_read(data,buf,sizeof(buf));\r\nif (i <= 0) break;\r\nBIO_write(p7bio,buf,i);\r\n}\r\nif (!PKCS7_dataFinal(p7,p7bio)) goto err;\r\nBIO_free(p7bio);\r\nPEM_write_PKCS7(stdout,p7);\r\nPKCS7_free(p7);\r\nexit(0);\r\nerr:\r\nERR_load_crypto_strings();\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}

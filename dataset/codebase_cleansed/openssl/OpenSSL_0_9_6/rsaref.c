RSA_METHOD *RSA_PKCS1_RSAref(void)\r\n{\r\nreturn(&rsa_pkcs1_ref_meth);\r\n}\r\nstatic int RSA_ref_mod_exp(BIGNUM *r0, BIGNUM *I, RSA *rsa)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_MOD_EXP,ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED);\r\nreturn(0);\r\n}\r\nstatic int BN_ref_mod_exp(BIGNUM *r, BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nRSAREFerr(RSAREF_F_BN_REF_MOD_EXP,ERR_R_SHOULD_NOT_HAVE_BEEN_CALLED);\r\nreturn(0);\r\n}\r\nstatic int RSAref_bn2bin(BIGNUM *from, unsigned char *to, int max)\r\n{\r\nint i;\r\ni=BN_num_bytes(from);\r\nif (i > max)\r\n{\r\nRSAREFerr(RSAREF_F_RSAREF_BN2BIN,RSAREF_R_LEN);\r\nreturn(0);\r\n}\r\nmemset(to,0,(unsigned int)max);\r\nif (!BN_bn2bin(from,&(to[max-i])))\r\nreturn(0);\r\nreturn(1);\r\n}\r\nstatic BIGNUM *RSAref_bin2bn(unsigned char *from, BIGNUM *to, int max)\r\n{\r\nint i;\r\nBIGNUM *ret;\r\nfor (i=0; i<max; i++)\r\nif (from[i]) break;\r\nret=BN_bin2bn(&(from[i]),max-i,to);\r\nreturn(ret);\r\n}\r\nstatic int RSAref_Public_ref2eay(RSArefPublicKey *from, RSA *to)\r\n{\r\nto->n=RSAref_bin2bn(from->m,NULL,RSAref_MAX_LEN);\r\nto->e=RSAref_bin2bn(from->e,NULL,RSAref_MAX_LEN);\r\nif ((to->n == NULL) || (to->e == NULL)) return(0);\r\nreturn(1);\r\n}\r\nstatic int RSAref_Public_eay2ref(RSA *from, RSArefPublicKey *to)\r\n{\r\nto->bits=BN_num_bits(from->n);\r\nif (!RSAref_bn2bin(from->n,to->m,RSAref_MAX_LEN)) return(0);\r\nif (!RSAref_bn2bin(from->e,to->e,RSAref_MAX_LEN)) return(0);\r\nreturn(1);\r\n}\r\nstatic int RSAref_Private_ref2eay(RSArefPrivateKey *from, RSA *to)\r\n{\r\nif ((to->n=RSAref_bin2bn(from->m,NULL,RSAref_MAX_LEN)) == NULL)\r\nreturn(0);\r\nif ((to->e=RSAref_bin2bn(from->e,NULL,RSAref_MAX_LEN)) == NULL)\r\nreturn(0);\r\nif ((to->d=RSAref_bin2bn(from->d,NULL,RSAref_MAX_LEN)) == NULL)\r\nreturn(0);\r\nif ((to->p=RSAref_bin2bn(from->prime[0],NULL,RSAref_MAX_PLEN)) == NULL)\r\nreturn(0);\r\nif ((to->q=RSAref_bin2bn(from->prime[1],NULL,RSAref_MAX_PLEN)) == NULL)\r\nreturn(0);\r\nif ((to->dmp1=RSAref_bin2bn(from->pexp[0],NULL,RSAref_MAX_PLEN))\r\n== NULL)\r\nreturn(0);\r\nif ((to->dmq1=RSAref_bin2bn(from->pexp[1],NULL,RSAref_MAX_PLEN))\r\n== NULL)\r\nreturn(0);\r\nif ((to->iqmp=RSAref_bin2bn(from->coef,NULL,RSAref_MAX_PLEN)) == NULL)\r\nreturn(0);\r\nreturn(1);\r\n}\r\nstatic int RSAref_Private_eay2ref(RSA *from, RSArefPrivateKey *to)\r\n{\r\nto->bits=BN_num_bits(from->n);\r\nif (!RSAref_bn2bin(from->n,to->m,RSAref_MAX_LEN)) return(0);\r\nif (!RSAref_bn2bin(from->e,to->e,RSAref_MAX_LEN)) return(0);\r\nif (!RSAref_bn2bin(from->d,to->d,RSAref_MAX_LEN)) return(0);\r\nif (!RSAref_bn2bin(from->p,to->prime[0],RSAref_MAX_PLEN)) return(0);\r\nif (!RSAref_bn2bin(from->q,to->prime[1],RSAref_MAX_PLEN)) return(0);\r\nif (!RSAref_bn2bin(from->dmp1,to->pexp[0],RSAref_MAX_PLEN)) return(0);\r\nif (!RSAref_bn2bin(from->dmq1,to->pexp[1],RSAref_MAX_PLEN)) return(0);\r\nif (!RSAref_bn2bin(from->iqmp,to->coef,RSAref_MAX_PLEN)) return(0);\r\nreturn(1);\r\n}\r\nint RSA_ref_private_decrypt(int len, unsigned char *from, unsigned char *to,\r\nRSA *rsa, int padding)\r\n{\r\nint i,outlen= -1;\r\nRSArefPrivateKey RSAkey;\r\nif (!RSAref_Private_eay2ref(rsa,&RSAkey))\r\ngoto err;\r\nif ((i=RSAPrivateDecrypt(to,&outlen,from,len,&RSAkey)) != 0)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_PRIVATE_DECRYPT,i);\r\noutlen= -1;\r\n}\r\nerr:\r\nmemset(&RSAkey,0,sizeof(RSAkey));\r\nreturn(outlen);\r\n}\r\nint RSA_ref_private_encrypt(int len, unsigned char *from, unsigned char *to,\r\nRSA *rsa, int padding)\r\n{\r\nint i,outlen= -1;\r\nRSArefPrivateKey RSAkey;\r\nif (padding != RSA_PKCS1_PADDING)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_PRIVATE_ENCRYPT, RSA_R_UNKNOWN_PADDING_TYPE);\r\ngoto err;\r\n}\r\nif (!RSAref_Private_eay2ref(rsa,&RSAkey))\r\ngoto err;\r\nif ((i=RSAPrivateEncrypt(to,&outlen,from,len,&RSAkey)) != 0)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_PRIVATE_ENCRYPT,i);\r\noutlen= -1;\r\n}\r\nerr:\r\nmemset(&RSAkey,0,sizeof(RSAkey));\r\nreturn(outlen);\r\n}\r\nint RSA_ref_public_decrypt(int len, unsigned char *from, unsigned char *to,\r\nRSA *rsa, int padding)\r\n{\r\nint i,outlen= -1;\r\nRSArefPublicKey RSAkey;\r\nif (!RSAref_Public_eay2ref(rsa,&RSAkey))\r\ngoto err;\r\nif ((i=RSAPublicDecrypt(to,&outlen,from,len,&RSAkey)) != 0)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_PUBLIC_DECRYPT,i);\r\noutlen= -1;\r\n}\r\nerr:\r\nmemset(&RSAkey,0,sizeof(RSAkey));\r\nreturn(outlen);\r\n}\r\nint RSA_ref_public_encrypt(int len, unsigned char *from, unsigned char *to,\r\nRSA *rsa, int padding)\r\n{\r\nint outlen= -1;\r\nint i;\r\nRSArefPublicKey RSAkey;\r\nRSARandomState rnd;\r\nunsigned char buf[16];\r\nif (padding != RSA_PKCS1_PADDING && padding != RSA_SSLV23_PADDING)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_PUBLIC_ENCRYPT, RSA_R_UNKNOWN_PADDING_TYPE);\r\ngoto err;\r\n}\r\nR_RandomInit(&rnd);\r\nR_GetRandomBytesNeeded((unsigned int *)&i,&rnd);\r\nwhile (i > 0)\r\n{\r\nif (RAND_bytes(buf,16) <= 0)\r\ngoto err;\r\nR_RandomUpdate(&rnd,buf,(unsigned int)((i>16)?16:i));\r\ni-=16;\r\n}\r\nif (!RSAref_Public_eay2ref(rsa,&RSAkey))\r\ngoto err;\r\nif ((i=RSAPublicEncrypt(to,&outlen,from,len,&RSAkey,&rnd)) != 0)\r\n{\r\nRSAREFerr(RSAREF_F_RSA_REF_PUBLIC_ENCRYPT,i);\r\noutlen= -1;\r\ngoto err;\r\n}\r\nerr:\r\nmemset(&RSAkey,0,sizeof(RSAkey));\r\nR_RandomFinal(&rnd);\r\nmemset(&rnd,0,sizeof(rnd));\r\nreturn(outlen);\r\n}

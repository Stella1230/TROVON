EVP_PKEY *d2i_PrivateKey(int type, EVP_PKEY **a, unsigned char **pp,\r\nlong length)\r\n{\r\nEVP_PKEY *ret;\r\nif ((a == NULL) || (*a == NULL))\r\n{\r\nif ((ret=EVP_PKEY_new()) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ERR_R_EVP_LIB);\r\nreturn(NULL);\r\n}\r\n}\r\nelse ret= *a;\r\nret->save_type=type;\r\nret->type=EVP_PKEY_type(type);\r\nswitch (ret->type)\r\n{\r\n#ifndef NO_RSA\r\ncase EVP_PKEY_RSA:\r\nif ((ret->pkey.rsa=d2i_RSAPrivateKey(NULL,pp,length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\n#ifndef NO_DSA\r\ncase EVP_PKEY_DSA:\r\nif ((ret->pkey.dsa=d2i_DSAPrivateKey(NULL,pp,length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ASN1_R_UNKNOWN_PUBLIC_KEY_TYPE);\r\ngoto err;\r\n}\r\nif (a != NULL) (*a)=ret;\r\nreturn(ret);\r\nerr:\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret))) EVP_PKEY_free(ret);\r\nreturn(NULL);\r\n}\r\nEVP_PKEY *d2i_AutoPrivateKey(EVP_PKEY **a, unsigned char **pp,\r\nlong length)\r\n{\r\nSTACK_OF(ASN1_TYPE) *inkey;\r\nunsigned char *p;\r\nint keytype;\r\np = *pp;\r\ninkey = d2i_ASN1_SET_OF_ASN1_TYPE(NULL, &p, length, d2i_ASN1_TYPE,\r\nASN1_TYPE_free, V_ASN1_SEQUENCE, V_ASN1_UNIVERSAL);\r\nif(sk_ASN1_TYPE_num(inkey) == 6) keytype = EVP_PKEY_DSA;\r\nelse keytype = EVP_PKEY_RSA;\r\nsk_ASN1_TYPE_pop_free(inkey, ASN1_TYPE_free);\r\nreturn d2i_PrivateKey(keytype, a, pp, length);\r\n}

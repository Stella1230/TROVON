int main()\r\n{\r\nBIO *bio_err;\r\nX509 *x509=NULL;\r\nEVP_PKEY *pkey=NULL;\r\nCRYPTO_mem_ctrl(CRYPTO_MEM_CHECK_ON);\r\nbio_err=BIO_new_fp(stderr, BIO_NOCLOSE);\r\nmkit(&x509,&pkey,512,0,365);\r\nRSA_print_fp(stdout,pkey->pkey.rsa,0);\r\nX509_print_fp(stdout,x509);\r\nPEM_write_PrivateKey(stdout,pkey,NULL,NULL,0,NULL, NULL);\r\nPEM_write_X509(stdout,x509);\r\nX509_free(x509);\r\nEVP_PKEY_free(pkey);\r\n#ifdef CUSTOM_EXT\r\nX509V3_EXT_cleanup();\r\nOBJ_cleanup();\r\n#endif\r\nCRYPTO_mem_leaks(bio_err);\r\nBIO_free(bio_err);\r\nreturn(0);\r\n}\r\nstatic void MS_CALLBACK callback(p, n, arg)\r\nint p;\r\nint n;\r\nvoid *arg;\r\n{\r\nchar c='B';\r\nif (p == 0) c='.';\r\nif (p == 1) c='+';\r\nif (p == 2) c='*';\r\nif (p == 3) c='\n';\r\nfputc(c,stderr);\r\n}\r\nint mkit(x509p,pkeyp,bits,serial,days)\r\nX509 **x509p;\r\nEVP_PKEY **pkeyp;\r\nint bits;\r\nint serial;\r\nint days;\r\n{\r\nX509 *x;\r\nEVP_PKEY *pk;\r\nRSA *rsa;\r\nX509_NAME *name=NULL;\r\nX509_NAME_ENTRY *ne=NULL;\r\nX509_EXTENSION *ex=NULL;\r\nif ((pkeyp == NULL) || (*pkeyp == NULL))\r\n{\r\nif ((pk=EVP_PKEY_new()) == NULL)\r\n{\r\nabort();\r\nreturn(0);\r\n}\r\n}\r\nelse\r\npk= *pkeyp;\r\nif ((x509p == NULL) || (*x509p == NULL))\r\n{\r\nif ((x=X509_new()) == NULL)\r\ngoto err;\r\n}\r\nelse\r\nx= *x509p;\r\nrsa=RSA_generate_key(bits,RSA_F4,callback,NULL);\r\nif (!EVP_PKEY_assign_RSA(pk,rsa))\r\n{\r\nabort();\r\ngoto err;\r\n}\r\nrsa=NULL;\r\nX509_set_version(x,3);\r\nASN1_INTEGER_set(X509_get_serialNumber(x),serial);\r\nX509_gmtime_adj(X509_get_notBefore(x),0);\r\nX509_gmtime_adj(X509_get_notAfter(x),(long)60*60*24*days);\r\nX509_set_pubkey(x,pk);\r\nname=X509_get_subject_name(x);\r\nX509_NAME_add_entry_by_txt(name,"C",\r\nMBSTRING_ASC, "UK", -1, -1, 0);\r\nX509_NAME_add_entry_by_txt(name,"CN",\r\nMBSTRING_ASC, "OpenSSL Group", -1, -1, 0);\r\nX509_set_issuer_name(x,name);\r\nex = X509V3_EXT_conf_nid(NULL, NULL, NID_netscape_cert_type, "server");\r\nX509_add_ext(x,ex,-1);\r\nX509_EXTENSION_free(ex);\r\nex = X509V3_EXT_conf_nid(NULL, NULL, NID_netscape_comment,\r\n"example comment extension");\r\nX509_add_ext(x,ex,-1);\r\nX509_EXTENSION_free(ex);\r\nex = X509V3_EXT_conf_nid(NULL, NULL, NID_netscape_ssl_server_name,\r\n"www.openssl.org");\r\nX509_add_ext(x,ex,-1);\r\nX509_EXTENSION_free(ex);\r\n#if 0\r\nex = X509V3_EXT_conf_nid(NULL, NULL, NID_basic_constraints,\r\n"critical,CA:TRUE");\r\nX509_add_ext(x,ex,-1);\r\nX509_EXTENSION_free(ex);\r\n#endif\r\n#ifdef CUSTOM_EXT\r\n{\r\nint nid;\r\nnid = OBJ_create("1.2.3.4", "MyAlias", "My Test Alias Extension");\r\nX509V3_EXT_add_alias(nid, NID_netscape_comment);\r\nex = X509V3_EXT_conf_nid(NULL, NULL, nid,\r\n"example comment alias");\r\nX509_add_ext(x,ex,-1);\r\nX509_EXTENSION_free(ex);\r\n}\r\n#endif\r\nif (!X509_sign(x,pk,EVP_md5()))\r\ngoto err;\r\n*x509p=x;\r\n*pkeyp=pk;\r\nreturn(1);\r\nerr:\r\nreturn(0);\r\n}

int add_signed_time(PKCS7_SIGNER_INFO *si)\r\n{\r\nASN1_UTCTIME *sign_time;\r\nsign_time=X509_gmtime_adj(NULL,0);\r\nPKCS7_add_signed_attribute(si,NID_pkcs9_signingTime,\r\nV_ASN1_UTCTIME,(char *)sign_time);\r\nreturn(1);\r\n}\r\nASN1_UTCTIME *get_signed_time(PKCS7_SIGNER_INFO *si)\r\n{\r\nASN1_TYPE *so;\r\nso=PKCS7_get_signed_attribute(si,NID_pkcs9_signingTime);\r\nif (so->type == V_ASN1_UTCTIME)\r\nreturn so->value.utctime;\r\nreturn NULL;\r\n}\r\nvoid add_signed_string(PKCS7_SIGNER_INFO *si, char *str)\r\n{\r\nASN1_OCTET_STRING *os;\r\nif (signed_string_nid == -1)\r\nsigned_string_nid=\r\nOBJ_create("1.2.3.4.5","OID_example","Our example OID");\r\nos=ASN1_OCTET_STRING_new();\r\nASN1_OCTET_STRING_set(os,(unsigned char*)str,strlen(str));\r\nPKCS7_add_signed_attribute(si,signed_string_nid,\r\nV_ASN1_OCTET_STRING,(char *)os);\r\n}\r\nint get_signed_string(PKCS7_SIGNER_INFO *si, char *buf, int len)\r\n{\r\nASN1_TYPE *so;\r\nASN1_OCTET_STRING *os;\r\nint i;\r\nif (signed_string_nid == -1)\r\nsigned_string_nid=\r\nOBJ_create("1.2.3.4.5","OID_example","Our example OID");\r\nso=PKCS7_get_signed_attribute(si,signed_string_nid);\r\nif (so != NULL)\r\n{\r\nif (so->type == V_ASN1_OCTET_STRING)\r\n{\r\nos=so->value.octet_string;\r\ni=os->length;\r\nif ((i+1) > len)\r\ni=len-1;\r\nmemcpy(buf,os->data,i);\r\nreturn(i);\r\n}\r\n}\r\nreturn(0);\r\n}\r\nint add_signed_seq2string(PKCS7_SIGNER_INFO *si, char *str1, char *str2)\r\n{\r\nunsigned char *p;\r\nASN1_OCTET_STRING *os1,*os2;\r\nASN1_STRING *seq;\r\nunsigned char *data;\r\nint i,total;\r\nif (signed_seq2string_nid == -1)\r\nsigned_seq2string_nid=\r\nOBJ_create("1.9.9999","OID_example","Our example OID");\r\nos1=ASN1_OCTET_STRING_new();\r\nos2=ASN1_OCTET_STRING_new();\r\nASN1_OCTET_STRING_set(os1,(unsigned char*)str1,strlen(str1));\r\nASN1_OCTET_STRING_set(os2,(unsigned char*)str1,strlen(str1));\r\ni =i2d_ASN1_OCTET_STRING(os1,NULL);\r\ni+=i2d_ASN1_OCTET_STRING(os2,NULL);\r\ntotal=ASN1_object_size(1,i,V_ASN1_SEQUENCE);\r\ndata=malloc(total);\r\np=data;\r\nASN1_put_object(&p,1,i,V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_ASN1_OCTET_STRING(os1,&p);\r\ni2d_ASN1_OCTET_STRING(os2,&p);\r\nseq=ASN1_STRING_new();\r\nASN1_STRING_set(seq,data,total);\r\nfree(data);\r\nASN1_OCTET_STRING_free(os1);\r\nASN1_OCTET_STRING_free(os2);\r\nPKCS7_add_signed_attribute(si,signed_seq2string_nid,\r\nV_ASN1_SEQUENCE,(char *)seq);\r\nreturn(1);\r\n}\r\nint get_signed_seq2string(PKCS7_SIGNER_INFO *si, char **str1, char **str2)\r\n{\r\nASN1_TYPE *so;\r\nif (signed_seq2string_nid == -1)\r\nsigned_seq2string_nid=\r\nOBJ_create("1.9.9999","OID_example","Our example OID");\r\nso=PKCS7_get_signed_attribute(si,signed_seq2string_nid);\r\nif (so && (so->type == V_ASN1_SEQUENCE))\r\n{\r\nASN1_CTX c;\r\nASN1_STRING *s;\r\nlong length;\r\nASN1_OCTET_STRING *os1,*os2;\r\ns=so->value.sequence;\r\nc.p=ASN1_STRING_data(s);\r\nc.max=c.p+ASN1_STRING_length(s);\r\nif (!asn1_GetSequence(&c,&length)) goto err;\r\nc.q=c.p;\r\nif ((os1=d2i_ASN1_OCTET_STRING(NULL,&c.p,c.slen)) == NULL)\r\ngoto err;\r\nc.slen-=(c.p-c.q);\r\nc.q=c.p;\r\nif ((os2=d2i_ASN1_OCTET_STRING(NULL,&c.p,c.slen)) == NULL)\r\ngoto err;\r\nc.slen-=(c.p-c.q);\r\nif (!asn1_Finish(&c)) goto err;\r\n*str1=malloc(os1->length+1);\r\n*str2=malloc(os2->length+1);\r\nmemcpy(*str1,os1->data,os1->length);\r\nmemcpy(*str2,os2->data,os2->length);\r\n(*str1)[os1->length]='\0';\r\n(*str2)[os2->length]='\0';\r\nASN1_OCTET_STRING_free(os1);\r\nASN1_OCTET_STRING_free(os2);\r\nreturn(1);\r\n}\r\nerr:\r\nreturn(0);\r\n}\r\nX509_ATTRIBUTE *create_time(void)\r\n{\r\nASN1_UTCTIME *sign_time;\r\nX509_ATTRIBUTE *ret;\r\nsign_time=X509_gmtime_adj(NULL,0);\r\nret=X509_ATTRIBUTE_create(NID_pkcs9_signingTime,\r\nV_ASN1_UTCTIME,(char *)sign_time);\r\nreturn(ret);\r\n}\r\nX509_ATTRIBUTE *create_string(char *str)\r\n{\r\nASN1_OCTET_STRING *os;\r\nX509_ATTRIBUTE *ret;\r\nif (signed_string_nid == -1)\r\nsigned_string_nid=\r\nOBJ_create("1.2.3.4.5","OID_example","Our example OID");\r\nos=ASN1_OCTET_STRING_new();\r\nASN1_OCTET_STRING_set(os,(unsigned char*)str,strlen(str));\r\nret=X509_ATTRIBUTE_create(signed_string_nid,\r\nV_ASN1_OCTET_STRING,(char *)os);\r\nreturn(ret);\r\n}\r\nX509_ATTRIBUTE *add_seq2string(PKCS7_SIGNER_INFO *si, char *str1, char *str2)\r\n{\r\nunsigned char *p;\r\nASN1_OCTET_STRING *os1,*os2;\r\nASN1_STRING *seq;\r\nX509_ATTRIBUTE *ret;\r\nunsigned char *data;\r\nint i,total;\r\nif (signed_seq2string_nid == -1)\r\nsigned_seq2string_nid=\r\nOBJ_create("1.9.9999","OID_example","Our example OID");\r\nos1=ASN1_OCTET_STRING_new();\r\nos2=ASN1_OCTET_STRING_new();\r\nASN1_OCTET_STRING_set(os1,(unsigned char*)str1,strlen(str1));\r\nASN1_OCTET_STRING_set(os2,(unsigned char*)str1,strlen(str1));\r\ni =i2d_ASN1_OCTET_STRING(os1,NULL);\r\ni+=i2d_ASN1_OCTET_STRING(os2,NULL);\r\ntotal=ASN1_object_size(1,i,V_ASN1_SEQUENCE);\r\ndata=malloc(total);\r\np=data;\r\nASN1_put_object(&p,1,i,V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_ASN1_OCTET_STRING(os1,&p);\r\ni2d_ASN1_OCTET_STRING(os2,&p);\r\nseq=ASN1_STRING_new();\r\nASN1_STRING_set(seq,data,total);\r\nfree(data);\r\nASN1_OCTET_STRING_free(os1);\r\nASN1_OCTET_STRING_free(os2);\r\nret=X509_ATTRIBUTE_create(signed_seq2string_nid,\r\nV_ASN1_SEQUENCE,(char *)seq);\r\nreturn(ret);\r\n}

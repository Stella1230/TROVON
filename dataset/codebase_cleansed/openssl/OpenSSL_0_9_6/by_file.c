X509_LOOKUP_METHOD *X509_LOOKUP_file(void)\r\n{\r\nreturn(&x509_file_lookup);\r\n}\r\nstatic int by_file_ctrl(X509_LOOKUP *ctx, int cmd, const char *argp, long argl,\r\nchar **ret)\r\n{\r\nint ok=0;\r\nchar *file;\r\nswitch (cmd)\r\n{\r\ncase X509_L_FILE_LOAD:\r\nif (argl == X509_FILETYPE_DEFAULT)\r\n{\r\nok = (X509_load_cert_crl_file(ctx,X509_get_default_cert_file(),\r\nX509_FILETYPE_PEM) != 0);\r\nif (!ok)\r\n{\r\nX509err(X509_F_BY_FILE_CTRL,X509_R_LOADING_DEFAULTS);\r\n}\r\nelse\r\n{\r\nfile=(char *)Getenv(X509_get_default_cert_file_env());\r\nok = (X509_load_cert_crl_file(ctx,file,\r\nX509_FILETYPE_PEM) != 0);\r\n}\r\n}\r\nelse\r\n{\r\nif(argl == X509_FILETYPE_PEM)\r\nok = (X509_load_cert_crl_file(ctx,argp,\r\nX509_FILETYPE_PEM) != 0);\r\nelse\r\nok = (X509_load_cert_file(ctx,argp,(int)argl) != 0);\r\n}\r\nbreak;\r\n}\r\nreturn(ok);\r\n}\r\nint X509_load_cert_file(X509_LOOKUP *ctx, const char *file, int type)\r\n{\r\nint ret=0;\r\nBIO *in=NULL;\r\nint i,count=0;\r\nX509 *x=NULL;\r\nif (file == NULL) return(1);\r\nin=BIO_new(BIO_s_file_internal());\r\nif ((in == NULL) || (BIO_read_filename(in,file) <= 0))\r\n{\r\nX509err(X509_F_X509_LOAD_CERT_FILE,ERR_R_SYS_LIB);\r\ngoto err;\r\n}\r\nif (type == X509_FILETYPE_PEM)\r\n{\r\nfor (;;)\r\n{\r\nx=PEM_read_bio_X509_AUX(in,NULL,NULL,NULL);\r\nif (x == NULL)\r\n{\r\nif ((ERR_GET_REASON(ERR_peek_error()) ==\r\nPEM_R_NO_START_LINE) && (count > 0))\r\n{\r\nERR_clear_error();\r\nbreak;\r\n}\r\nelse\r\n{\r\nX509err(X509_F_X509_LOAD_CERT_FILE,\r\nERR_R_PEM_LIB);\r\ngoto err;\r\n}\r\n}\r\ni=X509_STORE_add_cert(ctx->store_ctx,x);\r\nif (!i) goto err;\r\ncount++;\r\nX509_free(x);\r\nx=NULL;\r\n}\r\nret=count;\r\n}\r\nelse if (type == X509_FILETYPE_ASN1)\r\n{\r\nx=d2i_X509_bio(in,NULL);\r\nif (x == NULL)\r\n{\r\nX509err(X509_F_X509_LOAD_CERT_FILE,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\ni=X509_STORE_add_cert(ctx->store_ctx,x);\r\nif (!i) goto err;\r\nret=i;\r\n}\r\nelse\r\n{\r\nX509err(X509_F_X509_LOAD_CERT_FILE,X509_R_BAD_X509_FILETYPE);\r\ngoto err;\r\n}\r\nerr:\r\nif (x != NULL) X509_free(x);\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint X509_load_crl_file(X509_LOOKUP *ctx, const char *file, int type)\r\n{\r\nint ret=0;\r\nBIO *in=NULL;\r\nint i,count=0;\r\nX509_CRL *x=NULL;\r\nif (file == NULL) return(1);\r\nin=BIO_new(BIO_s_file_internal());\r\nif ((in == NULL) || (BIO_read_filename(in,file) <= 0))\r\n{\r\nX509err(X509_F_X509_LOAD_CRL_FILE,ERR_R_SYS_LIB);\r\ngoto err;\r\n}\r\nif (type == X509_FILETYPE_PEM)\r\n{\r\nfor (;;)\r\n{\r\nx=PEM_read_bio_X509_CRL(in,NULL,NULL,NULL);\r\nif (x == NULL)\r\n{\r\nif ((ERR_GET_REASON(ERR_peek_error()) ==\r\nPEM_R_NO_START_LINE) && (count > 0))\r\n{\r\nERR_clear_error();\r\nbreak;\r\n}\r\nelse\r\n{\r\nX509err(X509_F_X509_LOAD_CRL_FILE,\r\nERR_R_PEM_LIB);\r\ngoto err;\r\n}\r\n}\r\ni=X509_STORE_add_crl(ctx->store_ctx,x);\r\nif (!i) goto err;\r\ncount++;\r\nX509_CRL_free(x);\r\nx=NULL;\r\n}\r\nret=count;\r\n}\r\nelse if (type == X509_FILETYPE_ASN1)\r\n{\r\nx=d2i_X509_CRL_bio(in,NULL);\r\nif (x == NULL)\r\n{\r\nX509err(X509_F_X509_LOAD_CRL_FILE,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\ni=X509_STORE_add_crl(ctx->store_ctx,x);\r\nif (!i) goto err;\r\nret=i;\r\n}\r\nelse\r\n{\r\nX509err(X509_F_X509_LOAD_CRL_FILE,X509_R_BAD_X509_FILETYPE);\r\ngoto err;\r\n}\r\nerr:\r\nif (x != NULL) X509_CRL_free(x);\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint X509_load_cert_crl_file(X509_LOOKUP *ctx, const char *file, int type)\r\n{\r\nSTACK_OF(X509_INFO) *inf;\r\nX509_INFO *itmp;\r\nBIO *in;\r\nint i, count = 0;\r\nif(type != X509_FILETYPE_PEM)\r\nreturn X509_load_cert_file(ctx, file, type);\r\nin = BIO_new_file(file, "r");\r\nif(!in) {\r\nX509err(X509_F_X509_LOAD_CERT_CRL_FILE,ERR_R_SYS_LIB);\r\nreturn 0;\r\n}\r\ninf = PEM_X509_INFO_read_bio(in, NULL, NULL, NULL);\r\nBIO_free(in);\r\nif(!inf) {\r\nX509err(X509_F_X509_LOAD_CERT_CRL_FILE,ERR_R_PEM_LIB);\r\nreturn 0;\r\n}\r\nfor(i = 0; i < sk_X509_INFO_num(inf); i++) {\r\nitmp = sk_X509_INFO_value(inf, i);\r\nif(itmp->x509) {\r\nX509_STORE_add_cert(ctx->store_ctx, itmp->x509);\r\ncount++;\r\n} else if(itmp->crl) {\r\nX509_STORE_add_crl(ctx->store_ctx, itmp->crl);\r\ncount++;\r\n}\r\n}\r\nsk_X509_INFO_pop_free(inf, X509_INFO_free);\r\nreturn count;\r\n}

DH *DH_generate_parameters(int prime_len, int generator,\r\nvoid (*callback)(int,int,void *), void *cb_arg)\r\n{\r\nBIGNUM *p=NULL,*t1,*t2;\r\nDH *ret=NULL;\r\nint g,ok= -1;\r\nBN_CTX *ctx=NULL;\r\nret=DH_new();\r\nif (ret == NULL) goto err;\r\nctx=BN_CTX_new();\r\nif (ctx == NULL) goto err;\r\nBN_CTX_start(ctx);\r\nt1 = BN_CTX_get(ctx);\r\nt2 = BN_CTX_get(ctx);\r\nif (t1 == NULL || t2 == NULL) goto err;\r\nif (generator == DH_GENERATOR_2)\r\n{\r\nBN_set_word(t1,24);\r\nBN_set_word(t2,11);\r\ng=2;\r\n}\r\n#ifdef undef\r\nelse if (generator == DH_GENERATOR_3)\r\n{\r\nBN_set_word(t1,12);\r\nBN_set_word(t2,5);\r\ng=3;\r\n}\r\n#endif\r\nelse if (generator == DH_GENERATOR_5)\r\n{\r\nBN_set_word(t1,10);\r\nBN_set_word(t2,3);\r\ng=5;\r\n}\r\nelse\r\ng=generator;\r\np=BN_generate_prime(NULL,prime_len,1,t1,t2,callback,cb_arg);\r\nif (p == NULL) goto err;\r\nif (callback != NULL) callback(3,0,cb_arg);\r\nret->p=p;\r\nret->g=BN_new();\r\nif (!BN_set_word(ret->g,g)) goto err;\r\nok=1;\r\nerr:\r\nif (ok == -1)\r\n{\r\nDHerr(DH_F_DH_GENERATE_PARAMETERS,ERR_R_BN_LIB);\r\nok=0;\r\n}\r\nif (ctx != NULL)\r\n{\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\n}\r\nif (!ok && (ret != NULL))\r\n{\r\nDH_free(ret);\r\nret=NULL;\r\n}\r\nreturn(ret);\r\n}

long PKCS7_ctrl(PKCS7 *p7, int cmd, long larg, char *parg)\r\n{\r\nint nid;\r\nlong ret;\r\nnid=OBJ_obj2nid(p7->type);\r\nswitch (cmd)\r\n{\r\ncase PKCS7_OP_SET_DETACHED_SIGNATURE:\r\nif (nid == NID_pkcs7_signed)\r\n{\r\nret=p7->detached=(int)larg;\r\n}\r\nelse\r\n{\r\nPKCS7err(PKCS7_F_PKCS7_CTRL,PKCS7_R_OPERATION_NOT_SUPPORTED_ON_THIS_TYPE);\r\nret=0;\r\n}\r\nbreak;\r\ncase PKCS7_OP_GET_DETACHED_SIGNATURE:\r\nif (nid == NID_pkcs7_signed)\r\n{\r\nret=p7->detached;\r\n}\r\nelse\r\n{\r\nPKCS7err(PKCS7_F_PKCS7_CTRL,PKCS7_R_OPERATION_NOT_SUPPORTED_ON_THIS_TYPE);\r\nret=0;\r\n}\r\nbreak;\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_CTRL,PKCS7_R_UNKNOWN_OPERATION);\r\nret=0;\r\n}\r\nreturn(ret);\r\n}\r\nint PKCS7_content_new(PKCS7 *p7, int type)\r\n{\r\nPKCS7 *ret=NULL;\r\nif ((ret=PKCS7_new()) == NULL) goto err;\r\nif (!PKCS7_set_type(ret,type)) goto err;\r\nif (!PKCS7_set_content(p7,ret)) goto err;\r\nreturn(1);\r\nerr:\r\nif (ret != NULL) PKCS7_free(ret);\r\nreturn(0);\r\n}\r\nint PKCS7_set_content(PKCS7 *p7, PKCS7 *p7_data)\r\n{\r\nint i;\r\ni=OBJ_obj2nid(p7->type);\r\nswitch (i)\r\n{\r\ncase NID_pkcs7_signed:\r\nif (p7->d.sign->contents != NULL)\r\nPKCS7_free(p7->d.sign->contents);\r\np7->d.sign->contents=p7_data;\r\nbreak;\r\ncase NID_pkcs7_digest:\r\ncase NID_pkcs7_data:\r\ncase NID_pkcs7_enveloped:\r\ncase NID_pkcs7_signedAndEnveloped:\r\ncase NID_pkcs7_encrypted:\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_SET_CONTENT,PKCS7_R_UNSUPPORTED_CONTENT_TYPE);\r\ngoto err;\r\n}\r\nreturn(1);\r\nerr:\r\nreturn(0);\r\n}\r\nint PKCS7_set_type(PKCS7 *p7, int type)\r\n{\r\nASN1_OBJECT *obj;\r\nPKCS7_content_free(p7);\r\nobj=OBJ_nid2obj(type);\r\nswitch (type)\r\n{\r\ncase NID_pkcs7_signed:\r\np7->type=obj;\r\nif ((p7->d.sign=PKCS7_SIGNED_new()) == NULL)\r\ngoto err;\r\nASN1_INTEGER_set(p7->d.sign->version,1);\r\nbreak;\r\ncase NID_pkcs7_data:\r\np7->type=obj;\r\nif ((p7->d.data=M_ASN1_OCTET_STRING_new()) == NULL)\r\ngoto err;\r\nbreak;\r\ncase NID_pkcs7_signedAndEnveloped:\r\np7->type=obj;\r\nif ((p7->d.signed_and_enveloped=PKCS7_SIGN_ENVELOPE_new())\r\n== NULL) goto err;\r\nASN1_INTEGER_set(p7->d.signed_and_enveloped->version,1);\r\nbreak;\r\ncase NID_pkcs7_enveloped:\r\np7->type=obj;\r\nif ((p7->d.enveloped=PKCS7_ENVELOPE_new())\r\n== NULL) goto err;\r\nASN1_INTEGER_set(p7->d.enveloped->version,0);\r\nbreak;\r\ncase NID_pkcs7_encrypted:\r\np7->type=obj;\r\nif ((p7->d.encrypted=PKCS7_ENCRYPT_new())\r\n== NULL) goto err;\r\nASN1_INTEGER_set(p7->d.encrypted->version,0);\r\nbreak;\r\ncase NID_pkcs7_digest:\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_SET_TYPE,PKCS7_R_UNSUPPORTED_CONTENT_TYPE);\r\ngoto err;\r\n}\r\nreturn(1);\r\nerr:\r\nreturn(0);\r\n}\r\nint PKCS7_add_signer(PKCS7 *p7, PKCS7_SIGNER_INFO *psi)\r\n{\r\nint i,j,nid;\r\nX509_ALGOR *alg;\r\nSTACK_OF(PKCS7_SIGNER_INFO) *signer_sk;\r\nSTACK_OF(X509_ALGOR) *md_sk;\r\ni=OBJ_obj2nid(p7->type);\r\nswitch (i)\r\n{\r\ncase NID_pkcs7_signed:\r\nsigner_sk= p7->d.sign->signer_info;\r\nmd_sk= p7->d.sign->md_algs;\r\nbreak;\r\ncase NID_pkcs7_signedAndEnveloped:\r\nsigner_sk= p7->d.signed_and_enveloped->signer_info;\r\nmd_sk= p7->d.signed_and_enveloped->md_algs;\r\nbreak;\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_ADD_SIGNER,PKCS7_R_WRONG_CONTENT_TYPE);\r\nreturn(0);\r\n}\r\nnid=OBJ_obj2nid(psi->digest_alg->algorithm);\r\nj=0;\r\nfor (i=0; i<sk_X509_ALGOR_num(md_sk); i++)\r\n{\r\nalg=sk_X509_ALGOR_value(md_sk,i);\r\nif (OBJ_obj2nid(alg->algorithm) == nid)\r\n{\r\nj=1;\r\nbreak;\r\n}\r\n}\r\nif (!j)\r\n{\r\nif(!(alg=X509_ALGOR_new())\r\n|| !(alg->parameter = ASN1_TYPE_new())) {\r\nPKCS7err(PKCS7_F_PKCS7_ADD_SIGNER,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nalg->algorithm=OBJ_nid2obj(nid);\r\nalg->parameter->type = V_ASN1_NULL;\r\nsk_X509_ALGOR_push(md_sk,alg);\r\n}\r\nsk_PKCS7_SIGNER_INFO_push(signer_sk,psi);\r\nreturn(1);\r\n}\r\nint PKCS7_add_certificate(PKCS7 *p7, X509 *x509)\r\n{\r\nint i;\r\nSTACK_OF(X509) **sk;\r\ni=OBJ_obj2nid(p7->type);\r\nswitch (i)\r\n{\r\ncase NID_pkcs7_signed:\r\nsk= &(p7->d.sign->cert);\r\nbreak;\r\ncase NID_pkcs7_signedAndEnveloped:\r\nsk= &(p7->d.signed_and_enveloped->cert);\r\nbreak;\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_ADD_CERTIFICATE,PKCS7_R_WRONG_CONTENT_TYPE);\r\nreturn(0);\r\n}\r\nif (*sk == NULL)\r\n*sk=sk_X509_new_null();\r\nCRYPTO_add(&x509->references,1,CRYPTO_LOCK_X509);\r\nsk_X509_push(*sk,x509);\r\nreturn(1);\r\n}\r\nint PKCS7_add_crl(PKCS7 *p7, X509_CRL *crl)\r\n{\r\nint i;\r\nSTACK_OF(X509_CRL) **sk;\r\ni=OBJ_obj2nid(p7->type);\r\nswitch (i)\r\n{\r\ncase NID_pkcs7_signed:\r\nsk= &(p7->d.sign->crl);\r\nbreak;\r\ncase NID_pkcs7_signedAndEnveloped:\r\nsk= &(p7->d.signed_and_enveloped->crl);\r\nbreak;\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_ADD_CRL,PKCS7_R_WRONG_CONTENT_TYPE);\r\nreturn(0);\r\n}\r\nif (*sk == NULL)\r\n*sk=sk_X509_CRL_new_null();\r\nCRYPTO_add(&crl->references,1,CRYPTO_LOCK_X509_CRL);\r\nsk_X509_CRL_push(*sk,crl);\r\nreturn(1);\r\n}\r\nint PKCS7_SIGNER_INFO_set(PKCS7_SIGNER_INFO *p7i, X509 *x509, EVP_PKEY *pkey,\r\nEVP_MD *dgst)\r\n{\r\nchar is_dsa;\r\nif (pkey->type == EVP_PKEY_DSA) is_dsa = 1;\r\nelse is_dsa = 0;\r\nASN1_INTEGER_set(p7i->version,1);\r\nX509_NAME_set(&p7i->issuer_and_serial->issuer,\r\nX509_get_issuer_name(x509));\r\nM_ASN1_INTEGER_free(p7i->issuer_and_serial->serial);\r\np7i->issuer_and_serial->serial=\r\nM_ASN1_INTEGER_dup(X509_get_serialNumber(x509));\r\nCRYPTO_add(&pkey->references,1,CRYPTO_LOCK_EVP_PKEY);\r\np7i->pkey=pkey;\r\nif (is_dsa) p7i->digest_alg->algorithm=OBJ_nid2obj(NID_sha1);\r\nelse\r\np7i->digest_alg->algorithm=OBJ_nid2obj(EVP_MD_type(dgst));\r\nif (p7i->digest_alg->parameter != NULL)\r\nASN1_TYPE_free(p7i->digest_alg->parameter);\r\nif ((p7i->digest_alg->parameter=ASN1_TYPE_new()) == NULL)\r\ngoto err;\r\np7i->digest_alg->parameter->type=V_ASN1_NULL;\r\np7i->digest_enc_alg->algorithm=OBJ_nid2obj(EVP_PKEY_type(pkey->type));\r\nif (p7i->digest_enc_alg->parameter != NULL)\r\nASN1_TYPE_free(p7i->digest_enc_alg->parameter);\r\nif(is_dsa) p7i->digest_enc_alg->parameter = NULL;\r\nelse {\r\nif (!(p7i->digest_enc_alg->parameter=ASN1_TYPE_new()))\r\ngoto err;\r\np7i->digest_enc_alg->parameter->type=V_ASN1_NULL;\r\n}\r\nreturn(1);\r\nerr:\r\nreturn(0);\r\n}\r\nPKCS7_SIGNER_INFO *PKCS7_add_signature(PKCS7 *p7, X509 *x509, EVP_PKEY *pkey,\r\nEVP_MD *dgst)\r\n{\r\nPKCS7_SIGNER_INFO *si;\r\nif ((si=PKCS7_SIGNER_INFO_new()) == NULL) goto err;\r\nif (!PKCS7_SIGNER_INFO_set(si,x509,pkey,dgst)) goto err;\r\nif (!PKCS7_add_signer(p7,si)) goto err;\r\nreturn(si);\r\nerr:\r\nreturn(NULL);\r\n}\r\nint PKCS7_RECIP_INFO_set(PKCS7_RECIP_INFO *p7i, X509 *x509)\r\n{\r\nASN1_INTEGER_set(p7i->version,0);\r\nX509_NAME_set(&p7i->issuer_and_serial->issuer,\r\nX509_get_issuer_name(x509));\r\nM_ASN1_INTEGER_free(p7i->issuer_and_serial->serial);\r\np7i->issuer_and_serial->serial=\r\nM_ASN1_INTEGER_dup(X509_get_serialNumber(x509));\r\nX509_ALGOR_free(p7i->key_enc_algor);\r\np7i->key_enc_algor=(X509_ALGOR *)ASN1_dup(i2d_X509_ALGOR,\r\n(char *(*)())d2i_X509_ALGOR,\r\n(char *)x509->cert_info->key->algor);\r\nCRYPTO_add(&x509->references,1,CRYPTO_LOCK_X509);\r\np7i->cert=x509;\r\nreturn(1);\r\n}\r\nX509 *PKCS7_cert_from_signer_info(PKCS7 *p7, PKCS7_SIGNER_INFO *si)\r\n{\r\nif (PKCS7_type_is_signed(p7))\r\nreturn(X509_find_by_issuer_and_serial(p7->d.sign->cert,\r\nsi->issuer_and_serial->issuer,\r\nsi->issuer_and_serial->serial));\r\nelse\r\nreturn(NULL);\r\n}\r\nint PKCS7_set_cipher(PKCS7 *p7, const EVP_CIPHER *cipher)\r\n{\r\nint i;\r\nASN1_OBJECT *objtmp;\r\nPKCS7_ENC_CONTENT *ec;\r\ni=OBJ_obj2nid(p7->type);\r\nswitch (i)\r\n{\r\ncase NID_pkcs7_signedAndEnveloped:\r\nec=p7->d.signed_and_enveloped->enc_data;\r\nbreak;\r\ncase NID_pkcs7_enveloped:\r\nec=p7->d.enveloped->enc_data;\r\nbreak;\r\ndefault:\r\nPKCS7err(PKCS7_F_PKCS7_SET_CIPHER,PKCS7_R_WRONG_CONTENT_TYPE);\r\nreturn(0);\r\n}\r\ni = EVP_CIPHER_type(cipher);\r\nif(i == NID_undef) {\r\nPKCS7err(PKCS7_F_PKCS7_SET_CIPHER,PKCS7_R_CIPHER_HAS_NO_OBJECT_IDENTIFIER);\r\nreturn(0);\r\n}\r\nobjtmp = OBJ_nid2obj(i);\r\nec->cipher = cipher;\r\nreturn 1;\r\n}

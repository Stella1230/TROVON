int SSL_use_certificate(SSL *ssl, X509 *x)\r\n{\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif (!ssl_cert_inst(&ssl->cert))\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nreturn(ssl_set_cert(ssl->cert,x));\r\n}\r\nint SSL_use_certificate_file(SSL *ssl, const char *file, int type)\r\n{\r\nint j;\r\nBIO *in;\r\nint ret=0;\r\nX509 *x=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nif (type == SSL_FILETYPE_ASN1)\r\n{\r\nj=ERR_R_ASN1_LIB;\r\nx=d2i_X509_bio(in,NULL);\r\n}\r\nelse if (type == SSL_FILETYPE_PEM)\r\n{\r\nj=ERR_R_PEM_LIB;\r\nx=PEM_read_bio_X509(in,NULL,ssl->ctx->default_passwd_callback,ssl->ctx->default_passwd_callback_userdata);\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE_FILE,SSL_R_BAD_SSL_FILETYPE);\r\ngoto end;\r\n}\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE_FILE,j);\r\ngoto end;\r\n}\r\nret=SSL_use_certificate(ssl,x);\r\nend:\r\nif (x != NULL) X509_free(x);\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint SSL_use_certificate_ASN1(SSL *ssl, unsigned char *d, int len)\r\n{\r\nX509 *x;\r\nint ret;\r\nx=d2i_X509(NULL,&d,(long)len);\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_CERTIFICATE_ASN1,ERR_R_ASN1_LIB);\r\nreturn(0);\r\n}\r\nret=SSL_use_certificate(ssl,x);\r\nX509_free(x);\r\nreturn(ret);\r\n}\r\nint SSL_use_RSAPrivateKey(SSL *ssl, RSA *rsa)\r\n{\r\nEVP_PKEY *pkey;\r\nint ret;\r\nif (rsa == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif (!ssl_cert_inst(&ssl->cert))\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nif ((pkey=EVP_PKEY_new()) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY,ERR_R_EVP_LIB);\r\nreturn(0);\r\n}\r\nCRYPTO_add(&rsa->references,1,CRYPTO_LOCK_RSA);\r\nEVP_PKEY_assign_RSA(pkey,rsa);\r\nret=ssl_set_pkey(ssl->cert,pkey);\r\nEVP_PKEY_free(pkey);\r\nreturn(ret);\r\n}\r\nstatic int ssl_set_pkey(CERT *c, EVP_PKEY *pkey)\r\n{\r\nint i,ok=0,bad=0;\r\ni=ssl_cert_type(NULL,pkey);\r\nif (i < 0)\r\n{\r\nSSLerr(SSL_F_SSL_SET_PKEY,SSL_R_UNKNOWN_CERTIFICATE_TYPE);\r\nreturn(0);\r\n}\r\nif (c->pkeys[i].x509 != NULL)\r\n{\r\nEVP_PKEY *pktmp;\r\npktmp = X509_get_pubkey(c->pkeys[i].x509);\r\nEVP_PKEY_copy_parameters(pktmp,pkey);\r\nEVP_PKEY_free(pktmp);\r\nERR_clear_error();\r\n#ifndef NO_RSA\r\nif ((pkey->type == EVP_PKEY_RSA) &&\r\n(RSA_flags(pkey->pkey.rsa) &\r\nRSA_METHOD_FLAG_NO_CHECK))\r\nok=1;\r\nelse\r\n#endif\r\nif (!X509_check_private_key(c->pkeys[i].x509,pkey))\r\n{\r\nif ((i == SSL_PKEY_DH_RSA) || (i == SSL_PKEY_DH_DSA))\r\n{\r\ni=(i == SSL_PKEY_DH_RSA)?\r\nSSL_PKEY_DH_DSA:SSL_PKEY_DH_RSA;\r\nif (c->pkeys[i].x509 == NULL)\r\nok=1;\r\nelse\r\n{\r\nif (!X509_check_private_key(\r\nc->pkeys[i].x509,pkey))\r\nbad=1;\r\nelse\r\nok=1;\r\n}\r\n}\r\nelse\r\nbad=1;\r\n}\r\nelse\r\nok=1;\r\n}\r\nelse\r\nok=1;\r\nif (bad)\r\n{\r\nX509_free(c->pkeys[i].x509);\r\nc->pkeys[i].x509=NULL;\r\nreturn(0);\r\n}\r\nif (c->pkeys[i].privatekey != NULL)\r\nEVP_PKEY_free(c->pkeys[i].privatekey);\r\nCRYPTO_add(&pkey->references,1,CRYPTO_LOCK_EVP_PKEY);\r\nc->pkeys[i].privatekey=pkey;\r\nc->key= &(c->pkeys[i]);\r\nc->valid=0;\r\nreturn(1);\r\n}\r\nint SSL_use_RSAPrivateKey_file(SSL *ssl, const char *file, int type)\r\n{\r\nint j,ret=0;\r\nBIO *in;\r\nRSA *rsa=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nif (type == SSL_FILETYPE_ASN1)\r\n{\r\nj=ERR_R_ASN1_LIB;\r\nrsa=d2i_RSAPrivateKey_bio(in,NULL);\r\n}\r\nelse if (type == SSL_FILETYPE_PEM)\r\n{\r\nj=ERR_R_PEM_LIB;\r\nrsa=PEM_read_bio_RSAPrivateKey(in,NULL,\r\nssl->ctx->default_passwd_callback,ssl->ctx->default_passwd_callback_userdata);\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY_FILE,SSL_R_BAD_SSL_FILETYPE);\r\ngoto end;\r\n}\r\nif (rsa == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY_FILE,j);\r\ngoto end;\r\n}\r\nret=SSL_use_RSAPrivateKey(ssl,rsa);\r\nRSA_free(rsa);\r\nend:\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint SSL_use_RSAPrivateKey_ASN1(SSL *ssl, unsigned char *d, long len)\r\n{\r\nint ret;\r\nunsigned char *p;\r\nRSA *rsa;\r\np=d;\r\nif ((rsa=d2i_RSAPrivateKey(NULL,&p,(long)len)) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_RSAPRIVATEKEY_ASN1,ERR_R_ASN1_LIB);\r\nreturn(0);\r\n}\r\nret=SSL_use_RSAPrivateKey(ssl,rsa);\r\nRSA_free(rsa);\r\nreturn(ret);\r\n}\r\nint SSL_use_PrivateKey(SSL *ssl, EVP_PKEY *pkey)\r\n{\r\nint ret;\r\nif (pkey == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif (!ssl_cert_inst(&ssl->cert))\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nret=ssl_set_pkey(ssl->cert,pkey);\r\nreturn(ret);\r\n}\r\nint SSL_use_PrivateKey_file(SSL *ssl, const char *file, int type)\r\n{\r\nint j,ret=0;\r\nBIO *in;\r\nEVP_PKEY *pkey=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nif (type == SSL_FILETYPE_PEM)\r\n{\r\nj=ERR_R_PEM_LIB;\r\npkey=PEM_read_bio_PrivateKey(in,NULL,\r\nssl->ctx->default_passwd_callback,ssl->ctx->default_passwd_callback_userdata);\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY_FILE,SSL_R_BAD_SSL_FILETYPE);\r\ngoto end;\r\n}\r\nif (pkey == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY_FILE,j);\r\ngoto end;\r\n}\r\nret=SSL_use_PrivateKey(ssl,pkey);\r\nEVP_PKEY_free(pkey);\r\nend:\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint SSL_use_PrivateKey_ASN1(int type, SSL *ssl, unsigned char *d, long len)\r\n{\r\nint ret;\r\nunsigned char *p;\r\nEVP_PKEY *pkey;\r\np=d;\r\nif ((pkey=d2i_PrivateKey(type,NULL,&p,(long)len)) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_USE_PRIVATEKEY_ASN1,ERR_R_ASN1_LIB);\r\nreturn(0);\r\n}\r\nret=SSL_use_PrivateKey(ssl,pkey);\r\nEVP_PKEY_free(pkey);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_certificate(SSL_CTX *ctx, X509 *x)\r\n{\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif (!ssl_cert_inst(&ctx->cert))\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nreturn(ssl_set_cert(ctx->cert, x));\r\n}\r\nstatic int ssl_set_cert(CERT *c, X509 *x)\r\n{\r\nEVP_PKEY *pkey;\r\nint i,ok=0,bad=0;\r\npkey=X509_get_pubkey(x);\r\nif (pkey == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_SET_CERT,SSL_R_X509_LIB);\r\nreturn(0);\r\n}\r\ni=ssl_cert_type(x,pkey);\r\nif (i < 0)\r\n{\r\nSSLerr(SSL_F_SSL_SET_CERT,SSL_R_UNKNOWN_CERTIFICATE_TYPE);\r\nEVP_PKEY_free(pkey);\r\nreturn(0);\r\n}\r\nif (c->pkeys[i].privatekey != NULL)\r\n{\r\nEVP_PKEY_copy_parameters(pkey,c->pkeys[i].privatekey);\r\nERR_clear_error();\r\n#ifndef NO_RSA\r\nif ((c->pkeys[i].privatekey->type == EVP_PKEY_RSA) &&\r\n(RSA_flags(c->pkeys[i].privatekey->pkey.rsa) &\r\nRSA_METHOD_FLAG_NO_CHECK))\r\nok=1;\r\nelse\r\n#endif\r\n{\r\nif (!X509_check_private_key(x,c->pkeys[i].privatekey))\r\n{\r\nif ((i == SSL_PKEY_DH_RSA) || (i == SSL_PKEY_DH_DSA))\r\n{\r\ni=(i == SSL_PKEY_DH_RSA)?\r\nSSL_PKEY_DH_DSA:SSL_PKEY_DH_RSA;\r\nif (c->pkeys[i].privatekey == NULL)\r\nok=1;\r\nelse\r\n{\r\nif (!X509_check_private_key(x,\r\nc->pkeys[i].privatekey))\r\nbad=1;\r\nelse\r\nok=1;\r\n}\r\n}\r\nelse\r\nbad=1;\r\n}\r\nelse\r\nok=1;\r\n}\r\n}\r\nelse\r\nok=1;\r\nEVP_PKEY_free(pkey);\r\nif (bad)\r\n{\r\nEVP_PKEY_free(c->pkeys[i].privatekey);\r\nc->pkeys[i].privatekey=NULL;\r\n}\r\nif (c->pkeys[i].x509 != NULL)\r\nX509_free(c->pkeys[i].x509);\r\nCRYPTO_add(&x->references,1,CRYPTO_LOCK_X509);\r\nc->pkeys[i].x509=x;\r\nc->key= &(c->pkeys[i]);\r\nc->valid=0;\r\nreturn(1);\r\n}\r\nint SSL_CTX_use_certificate_file(SSL_CTX *ctx, const char *file, int type)\r\n{\r\nint j;\r\nBIO *in;\r\nint ret=0;\r\nX509 *x=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nif (type == SSL_FILETYPE_ASN1)\r\n{\r\nj=ERR_R_ASN1_LIB;\r\nx=d2i_X509_bio(in,NULL);\r\n}\r\nelse if (type == SSL_FILETYPE_PEM)\r\n{\r\nj=ERR_R_PEM_LIB;\r\nx=PEM_read_bio_X509(in,NULL,ctx->default_passwd_callback,ctx->default_passwd_callback_userdata);\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_FILE,SSL_R_BAD_SSL_FILETYPE);\r\ngoto end;\r\n}\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_FILE,j);\r\ngoto end;\r\n}\r\nret=SSL_CTX_use_certificate(ctx,x);\r\nend:\r\nif (x != NULL) X509_free(x);\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_certificate_ASN1(SSL_CTX *ctx, int len, unsigned char *d)\r\n{\r\nX509 *x;\r\nint ret;\r\nx=d2i_X509(NULL,&d,(long)len);\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_ASN1,ERR_R_ASN1_LIB);\r\nreturn(0);\r\n}\r\nret=SSL_CTX_use_certificate(ctx,x);\r\nX509_free(x);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_RSAPrivateKey(SSL_CTX *ctx, RSA *rsa)\r\n{\r\nint ret;\r\nEVP_PKEY *pkey;\r\nif (rsa == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif (!ssl_cert_inst(&ctx->cert))\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nif ((pkey=EVP_PKEY_new()) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY,ERR_R_EVP_LIB);\r\nreturn(0);\r\n}\r\nCRYPTO_add(&rsa->references,1,CRYPTO_LOCK_RSA);\r\nEVP_PKEY_assign_RSA(pkey,rsa);\r\nret=ssl_set_pkey(ctx->cert, pkey);\r\nEVP_PKEY_free(pkey);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_RSAPrivateKey_file(SSL_CTX *ctx, const char *file, int type)\r\n{\r\nint j,ret=0;\r\nBIO *in;\r\nRSA *rsa=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nif (type == SSL_FILETYPE_ASN1)\r\n{\r\nj=ERR_R_ASN1_LIB;\r\nrsa=d2i_RSAPrivateKey_bio(in,NULL);\r\n}\r\nelse if (type == SSL_FILETYPE_PEM)\r\n{\r\nj=ERR_R_PEM_LIB;\r\nrsa=PEM_read_bio_RSAPrivateKey(in,NULL,\r\nctx->default_passwd_callback,ctx->default_passwd_callback_userdata);\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY_FILE,SSL_R_BAD_SSL_FILETYPE);\r\ngoto end;\r\n}\r\nif (rsa == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY_FILE,j);\r\ngoto end;\r\n}\r\nret=SSL_CTX_use_RSAPrivateKey(ctx,rsa);\r\nRSA_free(rsa);\r\nend:\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_RSAPrivateKey_ASN1(SSL_CTX *ctx, unsigned char *d, long len)\r\n{\r\nint ret;\r\nunsigned char *p;\r\nRSA *rsa;\r\np=d;\r\nif ((rsa=d2i_RSAPrivateKey(NULL,&p,(long)len)) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_RSAPRIVATEKEY_ASN1,ERR_R_ASN1_LIB);\r\nreturn(0);\r\n}\r\nret=SSL_CTX_use_RSAPrivateKey(ctx,rsa);\r\nRSA_free(rsa);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_PrivateKey(SSL_CTX *ctx, EVP_PKEY *pkey)\r\n{\r\nif (pkey == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif (!ssl_cert_inst(&ctx->cert))\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nreturn(ssl_set_pkey(ctx->cert,pkey));\r\n}\r\nint SSL_CTX_use_PrivateKey_file(SSL_CTX *ctx, const char *file, int type)\r\n{\r\nint j,ret=0;\r\nBIO *in;\r\nEVP_PKEY *pkey=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nif (type == SSL_FILETYPE_PEM)\r\n{\r\nj=ERR_R_PEM_LIB;\r\npkey=PEM_read_bio_PrivateKey(in,NULL,\r\nctx->default_passwd_callback,ctx->default_passwd_callback_userdata);\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY_FILE,SSL_R_BAD_SSL_FILETYPE);\r\ngoto end;\r\n}\r\nif (pkey == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY_FILE,j);\r\ngoto end;\r\n}\r\nret=SSL_CTX_use_PrivateKey(ctx,pkey);\r\nEVP_PKEY_free(pkey);\r\nend:\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_PrivateKey_ASN1(int type, SSL_CTX *ctx, unsigned char *d,\r\nlong len)\r\n{\r\nint ret;\r\nunsigned char *p;\r\nEVP_PKEY *pkey;\r\np=d;\r\nif ((pkey=d2i_PrivateKey(type,NULL,&p,(long)len)) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_PRIVATEKEY_ASN1,ERR_R_ASN1_LIB);\r\nreturn(0);\r\n}\r\nret=SSL_CTX_use_PrivateKey(ctx,pkey);\r\nEVP_PKEY_free(pkey);\r\nreturn(ret);\r\n}\r\nint SSL_CTX_use_certificate_chain_file(SSL_CTX *ctx, const char *file)\r\n{\r\nBIO *in;\r\nint ret=0;\r\nX509 *x=NULL;\r\nin=BIO_new(BIO_s_file_internal());\r\nif (in == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_CHAIN_FILE,ERR_R_BUF_LIB);\r\ngoto end;\r\n}\r\nif (BIO_read_filename(in,file) <= 0)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_CHAIN_FILE,ERR_R_SYS_LIB);\r\ngoto end;\r\n}\r\nx=PEM_read_bio_X509(in,NULL,ctx->default_passwd_callback,ctx->default_passwd_callback_userdata);\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL_CTX_USE_CERTIFICATE_CHAIN_FILE,ERR_R_PEM_LIB);\r\ngoto end;\r\n}\r\nret=SSL_CTX_use_certificate(ctx,x);\r\nif (ERR_peek_error() != 0)\r\nret = 0;\r\nif (ret)\r\n{\r\nX509 *ca;\r\nint r;\r\nunsigned long err;\r\nif (ctx->extra_certs != NULL)\r\n{\r\nsk_X509_pop_free(ctx->extra_certs, X509_free);\r\nctx->extra_certs = NULL;\r\n}\r\nwhile ((ca = PEM_read_bio_X509(in,NULL,ctx->default_passwd_callback,ctx->default_passwd_callback_userdata))\r\n!= NULL)\r\n{\r\nr = SSL_CTX_add_extra_chain_cert(ctx, ca);\r\nif (!r)\r\n{\r\nX509_free(ca);\r\nret = 0;\r\ngoto end;\r\n}\r\n}\r\nerr = ERR_peek_error();\r\nif (ERR_GET_LIB(err) == ERR_LIB_PEM && ERR_GET_REASON(err) == PEM_R_NO_START_LINE)\r\n(void) ERR_get_error();\r\nelse\r\nret = 0;\r\n}\r\nend:\r\nif (x != NULL) X509_free(x);\r\nif (in != NULL) BIO_free(in);\r\nreturn(ret);\r\n}

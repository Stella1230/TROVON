static double Time_F(int s)\r\n{\r\ndouble ret;\r\n#ifdef TIMES\r\nstatic struct tms tstart,tend;\r\nif (s == START)\r\n{\r\ntimes(&tstart);\r\nreturn(0);\r\n}\r\nelse\r\n{\r\ntimes(&tend);\r\nret=((double)(tend.tms_utime-tstart.tms_utime))/HZ;\r\nreturn((ret < 1e-3)?1e-3:ret);\r\n}\r\n#else\r\nstatic struct timeb tstart,tend;\r\nlong i;\r\nif (s == START)\r\n{\r\nftime(&tstart);\r\nreturn(0);\r\n}\r\nelse\r\n{\r\nftime(&tend);\r\ni=(long)tend.millitm-(long)tstart.millitm;\r\nret=((double)(tend.time-tstart.time))+((double)i)/1000.0;\r\nreturn((ret < 0.001)?0.001:ret);\r\n}\r\n#endif\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nBN_CTX *ctx;\r\nBIGNUM *a,*b,*c,*r;\r\nctx=BN_CTX_new();\r\na=BN_new();\r\nb=BN_new();\r\nc=BN_new();\r\nr=BN_new();\r\ndo_mul_exp(r,a,b,c,ctx);\r\n}\r\nvoid do_mul_exp(BIGNUM *r, BIGNUM *a, BIGNUM *b, BIGNUM *c, BN_CTX *ctx)\r\n{\r\nint i,k;\r\ndouble tm;\r\nlong num;\r\nBN_MONT_CTX m;\r\nmemset(&m,0,sizeof(m));\r\nnum=BASENUM;\r\nfor (i=0; i<NUM_SIZES; i++)\r\n{\r\nBN_rand(a,sizes[i],1,0);\r\nBN_rand(b,sizes[i],1,0);\r\nBN_rand(c,sizes[i],1,1);\r\nBN_mod(a,a,c,ctx);\r\nBN_mod(b,b,c,ctx);\r\nBN_MONT_CTX_set(&m,c,ctx);\r\nTime_F(START);\r\nfor (k=0; k<num; k++)\r\nBN_mod_exp_mont(r,a,b,c,ctx,&m);\r\ntm=Time_F(STOP);\r\nprintf("mul %4d ^ %4d %% %d -> %8.3fms %5.1f\n",sizes[i],sizes[i],sizes[i],tm*1000.0/num,tm*mul_c[i]/num);\r\nnum/=7;\r\nif (num <= 0) num=1;\r\n}\r\n}

static void s_time_init(void)\r\n{\r\nhost=SSL_CONNECT_NAME;\r\nt_cert_file=NULL;\r\nt_key_file=NULL;\r\nCApath=NULL;\r\nCAfile=NULL;\r\ntm_cipher=NULL;\r\ntm_verify = SSL_VERIFY_NONE;\r\nmaxTime = SECONDS;\r\ntm_ctx=NULL;\r\ns_time_meth=NULL;\r\ns_www_path=NULL;\r\nbytes_read=0;\r\nst_bugs=0;\r\nperform=0;\r\n#ifdef FIONBIO\r\nt_nbio=0;\r\n#endif\r\n#ifdef WIN32\r\nexitNow = 0;\r\n#endif\r\n}\r\nstatic void s_time_usage(void)\r\n{\r\nstatic char umsg[] = "\\r\n-time arg - max number of seconds to collect data, default %d\n\\r\n-verify arg - turn on peer certificate verification, arg == depth\n\\r\n-cert arg - certificate file to use, PEM format assumed\n\\r\n-key arg - RSA file to use, PEM format assumed, key is in cert file\n\\r\nfile if not specified by this option\n\\r\n-CApath arg - PEM format directory of CA's\n\\r\n-CAfile arg - PEM format file of CA's\n\\r\n-cipher - preferred cipher to use, play with 'openssl ciphers'\n\n";\r\nprintf( "usage: s_time <args>\n\n" );\r\nprintf("-connect host:port - host:port to connect to (default is %s)\n",SSL_CONNECT_NAME);\r\n#ifdef FIONBIO\r\nprintf("-nbio - Run with non-blocking IO\n");\r\nprintf("-ssl2 - Just use SSLv2\n");\r\nprintf("-ssl3 - Just use SSLv3\n");\r\nprintf("-bugs - Turn on SSL bug compatibility\n");\r\nprintf("-new - Just time new connections\n");\r\nprintf("-reuse - Just time connection reuse\n");\r\nprintf("-www page - Retrieve 'page' from the site\n");\r\n#endif\r\nprintf( umsg,SECONDS );\r\n}\r\nstatic int parseArgs(int argc, char **argv)\r\n{\r\nint badop = 0;\r\nverify_depth=0;\r\nverify_error=X509_V_OK;\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1) {\r\nif (strcmp(*argv,"-connect") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nhost= *(++argv);\r\n}\r\n#if 0\r\nelse if( strcmp(*argv,"-host") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nhost= *(++argv);\r\n}\r\nelse if( strcmp(*argv,"-port") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nport= *(++argv);\r\n}\r\n#endif\r\nelse if (strcmp(*argv,"-reuse") == 0)\r\nperform=2;\r\nelse if (strcmp(*argv,"-new") == 0)\r\nperform=1;\r\nelse if( strcmp(*argv,"-verify") == 0) {\r\ntm_verify=SSL_VERIFY_PEER|SSL_VERIFY_CLIENT_ONCE;\r\nif (--argc < 1) goto bad;\r\nverify_depth=atoi(*(++argv));\r\nBIO_printf(bio_err,"verify depth is %d\n",verify_depth);\r\n} else if( strcmp(*argv,"-cert") == 0) {\r\nif (--argc < 1) goto bad;\r\nt_cert_file= *(++argv);\r\n} else if( strcmp(*argv,"-key") == 0) {\r\nif (--argc < 1) goto bad;\r\nt_key_file= *(++argv);\r\n} else if( strcmp(*argv,"-CApath") == 0) {\r\nif (--argc < 1) goto bad;\r\nCApath= *(++argv);\r\n} else if( strcmp(*argv,"-CAfile") == 0) {\r\nif (--argc < 1) goto bad;\r\nCAfile= *(++argv);\r\n} else if( strcmp(*argv,"-cipher") == 0) {\r\nif (--argc < 1) goto bad;\r\ntm_cipher= *(++argv);\r\n}\r\n#ifdef FIONBIO\r\nelse if(strcmp(*argv,"-nbio") == 0) {\r\nt_nbio=1;\r\n}\r\n#endif\r\nelse if(strcmp(*argv,"-www") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ns_www_path= *(++argv);\r\n}\r\nelse if(strcmp(*argv,"-bugs") == 0)\r\nst_bugs=1;\r\n#ifndef NO_SSL2\r\nelse if(strcmp(*argv,"-ssl2") == 0)\r\ns_time_meth=SSLv2_client_method();\r\n#endif\r\n#ifndef NO_SSL3\r\nelse if(strcmp(*argv,"-ssl3") == 0)\r\ns_time_meth=SSLv3_client_method();\r\n#endif\r\nelse if( strcmp(*argv,"-time") == 0) {\r\nif (--argc < 1) goto bad;\r\nmaxTime= atoi(*(++argv));\r\n}\r\nelse {\r\nBIO_printf(bio_err,"unknown option %s\n",*argv);\r\nbadop=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (perform == 0) perform=3;\r\nif(badop) {\r\nbad:\r\ns_time_usage();\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic double tm_Time_F(int s)\r\n{\r\nstatic double ret;\r\n#ifdef TIMES\r\nstatic struct tms tstart,tend;\r\nif(s == START) {\r\ntimes(&tstart);\r\nreturn(0);\r\n} else {\r\ntimes(&tend);\r\nret=((double)(tend.tms_utime-tstart.tms_utime))/HZ;\r\nreturn((ret == 0.0)?1e-6:ret);\r\n}\r\n#else\r\nstatic struct timeb tstart,tend;\r\nlong i;\r\nif(s == START) {\r\nftime(&tstart);\r\nreturn(0);\r\n} else {\r\nftime(&tend);\r\ni=(long)tend.millitm-(long)tstart.millitm;\r\nret=((double)(tend.time-tstart.time))+((double)i)/1000.0;\r\nreturn((ret == 0.0)?1e-6:ret);\r\n}\r\n#endif\r\n}\r\nint MAIN(int argc, char **argv)\r\n{\r\ndouble totalTime = 0.0;\r\nint nConn = 0;\r\nSSL *scon=NULL;\r\nlong finishtime=0;\r\nint ret=1,i;\r\nMS_STATIC char buf[1024*8];\r\nint ver;\r\napps_startup();\r\ns_time_init();\r\nif (bio_err == NULL)\r\nbio_err=BIO_new_fp(stderr,BIO_NOCLOSE);\r\n#if !defined(NO_SSL2) && !defined(NO_SSL3)\r\ns_time_meth=SSLv23_client_method();\r\n#elif !defined(NO_SSL3)\r\ns_time_meth=SSLv3_client_method();\r\n#elif !defined(NO_SSL2)\r\ns_time_meth=SSLv2_client_method();\r\n#endif\r\nif( parseArgs( argc, argv ) < 0 )\r\ngoto end;\r\nOpenSSL_add_ssl_algorithms();\r\nif ((tm_ctx=SSL_CTX_new(s_time_meth)) == NULL) return(1);\r\nSSL_CTX_set_quiet_shutdown(tm_ctx,1);\r\nif (st_bugs) SSL_CTX_set_options(tm_ctx,SSL_OP_ALL);\r\nSSL_CTX_set_cipher_list(tm_ctx,tm_cipher);\r\nif(!set_cert_stuff(tm_ctx,t_cert_file,t_key_file))\r\ngoto end;\r\nSSL_load_error_strings();\r\nif ((!SSL_CTX_load_verify_locations(tm_ctx,CAfile,CApath)) ||\r\n(!SSL_CTX_set_default_verify_paths(tm_ctx)))\r\n{\r\nERR_print_errors(bio_err);\r\n}\r\nif (tm_cipher == NULL)\r\ntm_cipher = getenv("SSL_CIPHER");\r\nif (tm_cipher == NULL ) {\r\nfprintf( stderr, "No CIPHER specified\n" );\r\n}\r\nif (!(perform & 1)) goto next;\r\nprintf( "Collecting connection statistics for %d seconds\n", maxTime );\r\nbytes_read=0;\r\nfinishtime=(long)time(NULL)+maxTime;\r\ntm_Time_F(START);\r\nfor (;;)\r\n{\r\nif (finishtime < time(NULL)) break;\r\n#ifdef WIN32_STUFF\r\nif( flushWinMsgs(0) == -1 )\r\ngoto end;\r\nif( waitingToDie || exitNow )\r\ngoto end;\r\n#endif\r\nif( (scon = doConnection( NULL )) == NULL )\r\ngoto end;\r\nif (s_www_path != NULL)\r\n{\r\nsprintf(buf,"GET %s HTTP/1.0\r\n\r\n",s_www_path);\r\nSSL_write(scon,buf,strlen(buf));\r\nwhile ((i=SSL_read(scon,buf,sizeof(buf))) > 0)\r\nbytes_read+=i;\r\n}\r\n#ifdef NO_SHUTDOWN\r\nSSL_set_shutdown(scon,SSL_SENT_SHUTDOWN|SSL_RECEIVED_SHUTDOWN);\r\n#else\r\nSSL_shutdown(scon);\r\n#endif\r\nSHUTDOWN2(SSL_get_fd(scon));\r\nnConn += 1;\r\nif (SSL_session_reused(scon))\r\nver='r';\r\nelse\r\n{\r\nver=SSL_version(scon);\r\nif (ver == TLS1_VERSION)\r\nver='t';\r\nelse if (ver == SSL3_VERSION)\r\nver='3';\r\nelse if (ver == SSL2_VERSION)\r\nver='2';\r\nelse\r\nver='*';\r\n}\r\nfputc(ver,stdout);\r\nfflush(stdout);\r\nSSL_free( scon );\r\nscon=NULL;\r\n}\r\ntotalTime += tm_Time_F(STOP);\r\ni=(int)(time(NULL)-finishtime+maxTime);\r\nprintf( "\n\n%d connections in %.2fs; %.2f connections/user sec, bytes read %ld\n", nConn, totalTime, ((double)nConn/totalTime),bytes_read);\r\nprintf( "%d connections in %ld real seconds, %ld bytes read per connection\n",nConn,time(NULL)-finishtime+maxTime,bytes_read/nConn);\r\nnext:\r\nif (!(perform & 2)) goto end;\r\nprintf( "\n\nNow timing with session id reuse.\n" );\r\nif( (scon = doConnection( NULL )) == NULL )\r\n{\r\nfprintf( stderr, "Unable to get connection\n" );\r\ngoto end;\r\n}\r\nif (s_www_path != NULL)\r\n{\r\nsprintf(buf,"GET %s HTTP/1.0\r\n\r\n",s_www_path);\r\nSSL_write(scon,buf,strlen(buf));\r\nwhile (SSL_read(scon,buf,sizeof(buf)) > 0)\r\n;\r\n}\r\n#ifdef NO_SHUTDOWN\r\nSSL_set_shutdown(scon,SSL_SENT_SHUTDOWN|SSL_RECEIVED_SHUTDOWN);\r\n#else\r\nSSL_shutdown(scon);\r\n#endif\r\nSHUTDOWN2(SSL_get_fd(scon));\r\nnConn = 0;\r\ntotalTime = 0.0;\r\nfinishtime=time(NULL)+maxTime;\r\nprintf( "starting\n" );\r\nbytes_read=0;\r\ntm_Time_F(START);\r\nfor (;;)\r\n{\r\nif (finishtime < time(NULL)) break;\r\n#ifdef WIN32_STUFF\r\nif( flushWinMsgs(0) == -1 )\r\ngoto end;\r\nif( waitingToDie || exitNow )\r\ngoto end;\r\n#endif\r\nif( (doConnection( scon )) == NULL )\r\ngoto end;\r\nif (s_www_path)\r\n{\r\nsprintf(buf,"GET %s HTTP/1.0\r\n\r\n",s_www_path);\r\nSSL_write(scon,buf,strlen(buf));\r\nwhile ((i=SSL_read(scon,buf,sizeof(buf))) > 0)\r\nbytes_read+=i;\r\n}\r\n#ifdef NO_SHUTDOWN\r\nSSL_set_shutdown(scon,SSL_SENT_SHUTDOWN|SSL_RECEIVED_SHUTDOWN);\r\n#else\r\nSSL_shutdown(scon);\r\n#endif\r\nSHUTDOWN2(SSL_get_fd(scon));\r\nnConn += 1;\r\nif (SSL_session_reused(scon))\r\nver='r';\r\nelse\r\n{\r\nver=SSL_version(scon);\r\nif (ver == TLS1_VERSION)\r\nver='t';\r\nelse if (ver == SSL3_VERSION)\r\nver='3';\r\nelse if (ver == SSL2_VERSION)\r\nver='2';\r\nelse\r\nver='*';\r\n}\r\nfputc(ver,stdout);\r\nfflush(stdout);\r\n}\r\ntotalTime += tm_Time_F(STOP);\r\nprintf( "\n\n%d connections in %.2fs; %.2f connections/user sec, bytes read %ld\n", nConn, totalTime, ((double)nConn/totalTime),bytes_read);\r\nprintf( "%d connections in %ld real seconds, %ld bytes read per connection\n",nConn,time(NULL)-finishtime+maxTime,bytes_read/nConn);\r\nret=0;\r\nend:\r\nif (scon != NULL) SSL_free(scon);\r\nif (tm_ctx != NULL)\r\n{\r\nSSL_CTX_free(tm_ctx);\r\ntm_ctx=NULL;\r\n}\r\nEXIT(ret);\r\n}\r\nstatic SSL *doConnection(SSL *scon)\r\n{\r\nBIO *conn;\r\nSSL *serverCon;\r\nint width, i;\r\nfd_set readfds;\r\nif ((conn=BIO_new(BIO_s_connect())) == NULL)\r\nreturn(NULL);\r\nBIO_set_conn_hostname(conn,host);\r\nif (scon == NULL)\r\nserverCon=SSL_new(tm_ctx);\r\nelse\r\n{\r\nserverCon=scon;\r\nSSL_set_connect_state(serverCon);\r\n}\r\nSSL_set_bio(serverCon,conn,conn);\r\n#if 0\r\nif( scon != NULL )\r\nSSL_set_session(serverCon,SSL_get_session(scon));\r\n#endif\r\nfor(;;) {\r\ni=SSL_connect(serverCon);\r\nif (BIO_sock_should_retry(i))\r\n{\r\nBIO_printf(bio_err,"DELAY\n");\r\ni=SSL_get_fd(serverCon);\r\nwidth=i+1;\r\nFD_ZERO(&readfds);\r\nFD_SET(i,&readfds);\r\nselect(width,(void *)&readfds,NULL,NULL,NULL);\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\nif(i <= 0)\r\n{\r\nBIO_printf(bio_err,"ERROR\n");\r\nif (verify_error != X509_V_OK)\r\nBIO_printf(bio_err,"verify error:%s\n",\r\nX509_verify_cert_error_string(verify_error));\r\nelse\r\nERR_print_errors(bio_err);\r\nif (scon == NULL)\r\nSSL_free(serverCon);\r\nreturn NULL;\r\n}\r\nreturn serverCon;\r\n}

int BN_gcd(BIGNUM *r, BIGNUM *in_a, BIGNUM *in_b, BN_CTX *ctx)\r\n{\r\nBIGNUM *a,*b,*t;\r\nint ret=0;\r\nbn_check_top(in_a);\r\nbn_check_top(in_b);\r\nBN_CTX_start(ctx);\r\na = BN_CTX_get(ctx);\r\nb = BN_CTX_get(ctx);\r\nif (a == NULL || b == NULL) goto err;\r\nif (BN_copy(a,in_a) == NULL) goto err;\r\nif (BN_copy(b,in_b) == NULL) goto err;\r\nif (BN_cmp(a,b) < 0) { t=a; a=b; b=t; }\r\nt=euclid(a,b);\r\nif (t == NULL) goto err;\r\nif (BN_copy(r,t) == NULL) goto err;\r\nret=1;\r\nerr:\r\nBN_CTX_end(ctx);\r\nreturn(ret);\r\n}\r\nstatic BIGNUM *euclid(BIGNUM *a, BIGNUM *b)\r\n{\r\nBIGNUM *t;\r\nint shifts=0;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nfor (;;)\r\n{\r\nif (BN_is_zero(b))\r\nbreak;\r\nif (BN_is_odd(a))\r\n{\r\nif (BN_is_odd(b))\r\n{\r\nif (!BN_sub(a,a,b)) goto err;\r\nif (!BN_rshift1(a,a)) goto err;\r\nif (BN_cmp(a,b) < 0)\r\n{ t=a; a=b; b=t; }\r\n}\r\nelse\r\n{\r\nif (!BN_rshift1(b,b)) goto err;\r\nif (BN_cmp(a,b) < 0)\r\n{ t=a; a=b; b=t; }\r\n}\r\n}\r\nelse\r\n{\r\nif (BN_is_odd(b))\r\n{\r\nif (!BN_rshift1(a,a)) goto err;\r\nif (BN_cmp(a,b) < 0)\r\n{ t=a; a=b; b=t; }\r\n}\r\nelse\r\n{\r\nif (!BN_rshift1(a,a)) goto err;\r\nif (!BN_rshift1(b,b)) goto err;\r\nshifts++;\r\n}\r\n}\r\n}\r\nif (shifts)\r\n{\r\nif (!BN_lshift(a,a,shifts)) goto err;\r\n}\r\nreturn(a);\r\nerr:\r\nreturn(NULL);\r\n}\r\nBIGNUM *BN_mod_inverse(BIGNUM *in, BIGNUM *a, const BIGNUM *n, BN_CTX *ctx)\r\n{\r\nBIGNUM *A,*B,*X,*Y,*M,*D,*R=NULL;\r\nBIGNUM *T,*ret=NULL;\r\nint sign;\r\nbn_check_top(a);\r\nbn_check_top(n);\r\nBN_CTX_start(ctx);\r\nA = BN_CTX_get(ctx);\r\nB = BN_CTX_get(ctx);\r\nX = BN_CTX_get(ctx);\r\nD = BN_CTX_get(ctx);\r\nM = BN_CTX_get(ctx);\r\nY = BN_CTX_get(ctx);\r\nif (Y == NULL) goto err;\r\nif (in == NULL)\r\nR=BN_new();\r\nelse\r\nR=in;\r\nif (R == NULL) goto err;\r\nBN_zero(X);\r\nBN_one(Y);\r\nif (BN_copy(A,a) == NULL) goto err;\r\nif (BN_copy(B,n) == NULL) goto err;\r\nsign=1;\r\nwhile (!BN_is_zero(B))\r\n{\r\nif (!BN_div(D,M,A,B,ctx)) goto err;\r\nT=A;\r\nA=B;\r\nB=M;\r\nif (!BN_mul(T,D,X,ctx)) goto err;\r\nif (!BN_add(T,T,Y)) goto err;\r\nM=Y;\r\nY=X;\r\nX=T;\r\nsign= -sign;\r\n}\r\nif (sign < 0)\r\n{\r\nif (!BN_sub(Y,n,Y)) goto err;\r\n}\r\nif (BN_is_one(A))\r\n{ if (!BN_mod(R,Y,n,ctx)) goto err; }\r\nelse\r\n{\r\nBNerr(BN_F_BN_MOD_INVERSE,BN_R_NO_INVERSE);\r\ngoto err;\r\n}\r\nret=R;\r\nerr:\r\nif ((ret == NULL) && (in == NULL)) BN_free(R);\r\nBN_CTX_end(ctx);\r\nreturn(ret);\r\n}

void PKCS12_PBE_add(void)\r\n{\r\n#ifndef NO_RC4\r\nEVP_PBE_alg_add(NID_pbe_WithSHA1And128BitRC4, EVP_rc4(), EVP_sha1(),\r\nPKCS12_PBE_keyivgen);\r\nEVP_PBE_alg_add(NID_pbe_WithSHA1And40BitRC4, EVP_rc4_40(), EVP_sha1(),\r\nPKCS12_PBE_keyivgen);\r\n#endif\r\n#ifndef NO_DES\r\nEVP_PBE_alg_add(NID_pbe_WithSHA1And3_Key_TripleDES_CBC,\r\nEVP_des_ede3_cbc(), EVP_sha1(), PKCS12_PBE_keyivgen);\r\nEVP_PBE_alg_add(NID_pbe_WithSHA1And2_Key_TripleDES_CBC,\r\nEVP_des_ede_cbc(), EVP_sha1(), PKCS12_PBE_keyivgen);\r\n#endif\r\n#ifndef NO_RC2\r\nEVP_PBE_alg_add(NID_pbe_WithSHA1And128BitRC2_CBC, EVP_rc2_cbc(),\r\nEVP_sha1(), PKCS12_PBE_keyivgen);\r\nEVP_PBE_alg_add(NID_pbe_WithSHA1And40BitRC2_CBC, EVP_rc2_40_cbc(),\r\nEVP_sha1(), PKCS12_PBE_keyivgen);\r\n#endif\r\n}\r\nint PKCS12_PBE_keyivgen (EVP_CIPHER_CTX *ctx, const char *pass, int passlen,\r\nASN1_TYPE *param, EVP_CIPHER *cipher, EVP_MD *md, int en_de)\r\n{\r\nPBEPARAM *pbe;\r\nint saltlen, iter;\r\nunsigned char *salt, *pbuf;\r\nunsigned char key[EVP_MAX_KEY_LENGTH], iv[EVP_MAX_IV_LENGTH];\r\npbuf = param->value.sequence->data;\r\nif (!param || (param->type != V_ASN1_SEQUENCE) ||\r\n!(pbe = d2i_PBEPARAM (NULL, &pbuf, param->value.sequence->length))) {\r\nEVPerr(PKCS12_F_PKCS12_PBE_KEYIVGEN,EVP_R_DECODE_ERROR);\r\nreturn 0;\r\n}\r\nif (!pbe->iter) iter = 1;\r\nelse iter = ASN1_INTEGER_get (pbe->iter);\r\nsalt = pbe->salt->data;\r\nsaltlen = pbe->salt->length;\r\nif (!PKCS12_key_gen (pass, passlen, salt, saltlen, PKCS12_KEY_ID,\r\niter, EVP_CIPHER_key_length(cipher), key, md)) {\r\nPKCS12err(PKCS12_F_PKCS12_PBE_KEYIVGEN,PKCS12_R_KEY_GEN_ERROR);\r\nPBEPARAM_free(pbe);\r\nreturn 0;\r\n}\r\nif (!PKCS12_key_gen (pass, passlen, salt, saltlen, PKCS12_IV_ID,\r\niter, EVP_CIPHER_iv_length(cipher), iv, md)) {\r\nPKCS12err(PKCS12_F_PKCS12_PBE_KEYIVGEN,PKCS12_R_IV_GEN_ERROR);\r\nPBEPARAM_free(pbe);\r\nreturn 0;\r\n}\r\nPBEPARAM_free(pbe);\r\nEVP_CipherInit(ctx, cipher, key, iv, en_de);\r\nmemset(key, 0, EVP_MAX_KEY_LENGTH);\r\nmemset(iv, 0, EVP_MAX_IV_LENGTH);\r\nreturn 1;\r\n}

int TS_RESP_print_bio(BIO *bio, TS_RESP *a)\r\n{\r\nTS_TST_INFO *tst_info;\r\nBIO_printf(bio, "Status info:\n");\r\nTS_STATUS_INFO_print_bio(bio, TS_RESP_get_status_info(a));\r\nBIO_printf(bio, "\nTST info:\n");\r\ntst_info = TS_RESP_get_tst_info(a);\r\nif (tst_info != NULL)\r\nTS_TST_INFO_print_bio(bio, TS_RESP_get_tst_info(a));\r\nelse\r\nBIO_printf(bio, "Not included.\n");\r\nreturn 1;\r\n}\r\nint TS_STATUS_INFO_print_bio(BIO *bio, TS_STATUS_INFO *a)\r\n{\r\nstatic const char *status_map[] =\r\n{\r\n"Granted.",\r\n"Granted with modifications.",\r\n"Rejected.",\r\n"Waiting.",\r\n"Revocation warning.",\r\n"Revoked."\r\n};\r\nstatic struct status_map_st failure_map[] =\r\n{\r\n{ TS_INFO_BAD_ALG,\r\n"unrecognized or unsupported algorithm identifier" },\r\n{ TS_INFO_BAD_REQUEST,\r\n"transaction not permitted or supported" },\r\n{ TS_INFO_BAD_DATA_FORMAT,\r\n"the data submitted has the wrong format" },\r\n{ TS_INFO_TIME_NOT_AVAILABLE,\r\n"the TSA's time source is not available" },\r\n{ TS_INFO_UNACCEPTED_POLICY,\r\n"the requested TSA policy is not supported by the TSA" },\r\n{ TS_INFO_UNACCEPTED_EXTENSION,\r\n"the requested extension is not supported by the TSA" },\r\n{ TS_INFO_ADD_INFO_NOT_AVAILABLE,\r\n"the additional information requested could not be understood "\r\n"or is not available" },\r\n{ TS_INFO_SYSTEM_FAILURE,\r\n"the request cannot be handled due to system failure" },\r\n{ -1, NULL }\r\n};\r\nlong status;\r\nint i, lines = 0;\r\nBIO_printf(bio, "Status: ");\r\nstatus = ASN1_INTEGER_get(a->status);\r\nif (0 <= status && status < (long)(sizeof(status_map)/sizeof(status_map[0])))\r\nBIO_printf(bio, "%s\n", status_map[status]);\r\nelse\r\nBIO_printf(bio, "out of bounds\n");\r\nBIO_printf(bio, "Status description: ");\r\nfor (i = 0; i < sk_ASN1_UTF8STRING_num(a->text); ++i)\r\n{\r\nif (i > 0)\r\nBIO_puts(bio, "\t");\r\nASN1_STRING_print_ex(bio, sk_ASN1_UTF8STRING_value(a->text, i),\r\n0);\r\nBIO_puts(bio, "\n");\r\n}\r\nif (i == 0)\r\nBIO_printf(bio, "unspecified\n");\r\nBIO_printf(bio, "Failure info: ");\r\nif (a->failure_info != NULL)\r\nlines = TS_status_map_print(bio, failure_map,\r\na->failure_info);\r\nif (lines == 0)\r\nBIO_printf(bio, "unspecified");\r\nBIO_printf(bio, "\n");\r\nreturn 1;\r\n}\r\nstatic int TS_status_map_print(BIO *bio, struct status_map_st *a,\r\nASN1_BIT_STRING *v)\r\n{\r\nint lines = 0;\r\nfor (; a->bit >= 0; ++a)\r\n{\r\nif (ASN1_BIT_STRING_get_bit(v, a->bit))\r\n{\r\nif (++lines > 1)\r\nBIO_printf(bio, ", ");\r\nBIO_printf(bio, "%s", a->text);\r\n}\r\n}\r\nreturn lines;\r\n}\r\nint TS_TST_INFO_print_bio(BIO *bio, TS_TST_INFO *a)\r\n{\r\nint v;\r\nASN1_OBJECT *policy_id;\r\nconst ASN1_INTEGER *serial;\r\nconst ASN1_GENERALIZEDTIME *gtime;\r\nTS_ACCURACY *accuracy;\r\nconst ASN1_INTEGER *nonce;\r\nGENERAL_NAME *tsa_name;\r\nif (a == NULL) return 0;\r\nv = TS_TST_INFO_get_version(a);\r\nBIO_printf(bio, "Version: %d\n", v);\r\nBIO_printf(bio, "Policy OID: ");\r\npolicy_id = TS_TST_INFO_get_policy_id(a);\r\nTS_OBJ_print_bio(bio, policy_id);\r\nTS_MSG_IMPRINT_print_bio(bio, TS_TST_INFO_get_msg_imprint(a));\r\nBIO_printf(bio, "Serial number: ");\r\nserial = TS_TST_INFO_get_serial(a);\r\nif (serial == NULL)\r\nBIO_printf(bio, "unspecified");\r\nelse\r\nTS_ASN1_INTEGER_print_bio(bio, serial);\r\nBIO_write(bio, "\n", 1);\r\nBIO_printf(bio, "Time stamp: ");\r\ngtime = TS_TST_INFO_get_time(a);\r\nASN1_GENERALIZEDTIME_print(bio, gtime);\r\nBIO_write(bio, "\n", 1);\r\nBIO_printf(bio, "Accuracy: ");\r\naccuracy = TS_TST_INFO_get_accuracy(a);\r\nif (accuracy == NULL)\r\nBIO_printf(bio, "unspecified");\r\nelse\r\nTS_ACCURACY_print_bio(bio, accuracy);\r\nBIO_write(bio, "\n", 1);\r\nBIO_printf(bio, "Ordering: %s\n",\r\nTS_TST_INFO_get_ordering(a) ? "yes" : "no");\r\nBIO_printf(bio, "Nonce: ");\r\nnonce = TS_TST_INFO_get_nonce(a);\r\nif (nonce == NULL)\r\nBIO_printf(bio, "unspecified");\r\nelse\r\nTS_ASN1_INTEGER_print_bio(bio, nonce);\r\nBIO_write(bio, "\n", 1);\r\nBIO_printf(bio, "TSA: ");\r\ntsa_name = TS_TST_INFO_get_tsa(a);\r\nif (tsa_name == NULL)\r\nBIO_printf(bio, "unspecified");\r\nelse\r\n{\r\nSTACK_OF(CONF_VALUE) *nval;\r\nif ((nval = i2v_GENERAL_NAME(NULL, tsa_name, NULL)))\r\nX509V3_EXT_val_prn(bio, nval, 0, 0);\r\nsk_CONF_VALUE_pop_free(nval, X509V3_conf_free);\r\n}\r\nBIO_write(bio, "\n", 1);\r\nTS_ext_print_bio(bio, TS_TST_INFO_get_exts(a));\r\nreturn 1;\r\n}\r\nstatic int TS_ACCURACY_print_bio(BIO *bio, const TS_ACCURACY *accuracy)\r\n{\r\nconst ASN1_INTEGER *seconds = TS_ACCURACY_get_seconds(accuracy);\r\nconst ASN1_INTEGER *millis = TS_ACCURACY_get_millis(accuracy);\r\nconst ASN1_INTEGER *micros = TS_ACCURACY_get_micros(accuracy);\r\nif (seconds != NULL)\r\nTS_ASN1_INTEGER_print_bio(bio, seconds);\r\nelse\r\nBIO_printf(bio, "unspecified");\r\nBIO_printf(bio, " seconds, ");\r\nif (millis != NULL)\r\nTS_ASN1_INTEGER_print_bio(bio, millis);\r\nelse\r\nBIO_printf(bio, "unspecified");\r\nBIO_printf(bio, " millis, ");\r\nif (micros != NULL)\r\nTS_ASN1_INTEGER_print_bio(bio, micros);\r\nelse\r\nBIO_printf(bio, "unspecified");\r\nBIO_printf(bio, " micros");\r\nreturn 1;\r\n}

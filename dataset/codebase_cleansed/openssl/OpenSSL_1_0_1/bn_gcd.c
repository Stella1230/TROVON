int BN_gcd(BIGNUM *r, const BIGNUM *in_a, const BIGNUM *in_b, BN_CTX *ctx)\r\n{\r\nBIGNUM *a,*b,*t;\r\nint ret=0;\r\nbn_check_top(in_a);\r\nbn_check_top(in_b);\r\nBN_CTX_start(ctx);\r\na = BN_CTX_get(ctx);\r\nb = BN_CTX_get(ctx);\r\nif (a == NULL || b == NULL) goto err;\r\nif (BN_copy(a,in_a) == NULL) goto err;\r\nif (BN_copy(b,in_b) == NULL) goto err;\r\na->neg = 0;\r\nb->neg = 0;\r\nif (BN_cmp(a,b) < 0) { t=a; a=b; b=t; }\r\nt=euclid(a,b);\r\nif (t == NULL) goto err;\r\nif (BN_copy(r,t) == NULL) goto err;\r\nret=1;\r\nerr:\r\nBN_CTX_end(ctx);\r\nbn_check_top(r);\r\nreturn(ret);\r\n}\r\nstatic BIGNUM *euclid(BIGNUM *a, BIGNUM *b)\r\n{\r\nBIGNUM *t;\r\nint shifts=0;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nwhile (!BN_is_zero(b))\r\n{\r\nif (BN_is_odd(a))\r\n{\r\nif (BN_is_odd(b))\r\n{\r\nif (!BN_sub(a,a,b)) goto err;\r\nif (!BN_rshift1(a,a)) goto err;\r\nif (BN_cmp(a,b) < 0)\r\n{ t=a; a=b; b=t; }\r\n}\r\nelse\r\n{\r\nif (!BN_rshift1(b,b)) goto err;\r\nif (BN_cmp(a,b) < 0)\r\n{ t=a; a=b; b=t; }\r\n}\r\n}\r\nelse\r\n{\r\nif (BN_is_odd(b))\r\n{\r\nif (!BN_rshift1(a,a)) goto err;\r\nif (BN_cmp(a,b) < 0)\r\n{ t=a; a=b; b=t; }\r\n}\r\nelse\r\n{\r\nif (!BN_rshift1(a,a)) goto err;\r\nif (!BN_rshift1(b,b)) goto err;\r\nshifts++;\r\n}\r\n}\r\n}\r\nif (shifts)\r\n{\r\nif (!BN_lshift(a,a,shifts)) goto err;\r\n}\r\nbn_check_top(a);\r\nreturn(a);\r\nerr:\r\nreturn(NULL);\r\n}\r\nBIGNUM *BN_mod_inverse(BIGNUM *in,\r\nconst BIGNUM *a, const BIGNUM *n, BN_CTX *ctx)\r\n{\r\nBIGNUM *A,*B,*X,*Y,*M,*D,*T,*R=NULL;\r\nBIGNUM *ret=NULL;\r\nint sign;\r\nif ((BN_get_flags(a, BN_FLG_CONSTTIME) != 0) || (BN_get_flags(n, BN_FLG_CONSTTIME) != 0))\r\n{\r\nreturn BN_mod_inverse_no_branch(in, a, n, ctx);\r\n}\r\nbn_check_top(a);\r\nbn_check_top(n);\r\nBN_CTX_start(ctx);\r\nA = BN_CTX_get(ctx);\r\nB = BN_CTX_get(ctx);\r\nX = BN_CTX_get(ctx);\r\nD = BN_CTX_get(ctx);\r\nM = BN_CTX_get(ctx);\r\nY = BN_CTX_get(ctx);\r\nT = BN_CTX_get(ctx);\r\nif (T == NULL) goto err;\r\nif (in == NULL)\r\nR=BN_new();\r\nelse\r\nR=in;\r\nif (R == NULL) goto err;\r\nBN_one(X);\r\nBN_zero(Y);\r\nif (BN_copy(B,a) == NULL) goto err;\r\nif (BN_copy(A,n) == NULL) goto err;\r\nA->neg = 0;\r\nif (B->neg || (BN_ucmp(B, A) >= 0))\r\n{\r\nif (!BN_nnmod(B, B, A, ctx)) goto err;\r\n}\r\nsign = -1;\r\nif (BN_is_odd(n) && (BN_num_bits(n) <= (BN_BITS <= 32 ? 450 : 2048)))\r\n{\r\nint shift;\r\nwhile (!BN_is_zero(B))\r\n{\r\nshift = 0;\r\nwhile (!BN_is_bit_set(B, shift))\r\n{\r\nshift++;\r\nif (BN_is_odd(X))\r\n{\r\nif (!BN_uadd(X, X, n)) goto err;\r\n}\r\nif (!BN_rshift1(X, X)) goto err;\r\n}\r\nif (shift > 0)\r\n{\r\nif (!BN_rshift(B, B, shift)) goto err;\r\n}\r\nshift = 0;\r\nwhile (!BN_is_bit_set(A, shift))\r\n{\r\nshift++;\r\nif (BN_is_odd(Y))\r\n{\r\nif (!BN_uadd(Y, Y, n)) goto err;\r\n}\r\nif (!BN_rshift1(Y, Y)) goto err;\r\n}\r\nif (shift > 0)\r\n{\r\nif (!BN_rshift(A, A, shift)) goto err;\r\n}\r\nif (BN_ucmp(B, A) >= 0)\r\n{\r\nif (!BN_uadd(X, X, Y)) goto err;\r\nif (!BN_usub(B, B, A)) goto err;\r\n}\r\nelse\r\n{\r\nif (!BN_uadd(Y, Y, X)) goto err;\r\nif (!BN_usub(A, A, B)) goto err;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nwhile (!BN_is_zero(B))\r\n{\r\nBIGNUM *tmp;\r\nif (BN_num_bits(A) == BN_num_bits(B))\r\n{\r\nif (!BN_one(D)) goto err;\r\nif (!BN_sub(M,A,B)) goto err;\r\n}\r\nelse if (BN_num_bits(A) == BN_num_bits(B) + 1)\r\n{\r\nif (!BN_lshift1(T,B)) goto err;\r\nif (BN_ucmp(A,T) < 0)\r\n{\r\nif (!BN_one(D)) goto err;\r\nif (!BN_sub(M,A,B)) goto err;\r\n}\r\nelse\r\n{\r\nif (!BN_sub(M,A,T)) goto err;\r\nif (!BN_add(D,T,B)) goto err;\r\nif (BN_ucmp(A,D) < 0)\r\n{\r\nif (!BN_set_word(D,2)) goto err;\r\n}\r\nelse\r\n{\r\nif (!BN_set_word(D,3)) goto err;\r\nif (!BN_sub(M,M,B)) goto err;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif (!BN_div(D,M,A,B,ctx)) goto err;\r\n}\r\ntmp=A;\r\nA=B;\r\nB=M;\r\nif (BN_is_one(D))\r\n{\r\nif (!BN_add(tmp,X,Y)) goto err;\r\n}\r\nelse\r\n{\r\nif (BN_is_word(D,2))\r\n{\r\nif (!BN_lshift1(tmp,X)) goto err;\r\n}\r\nelse if (BN_is_word(D,4))\r\n{\r\nif (!BN_lshift(tmp,X,2)) goto err;\r\n}\r\nelse if (D->top == 1)\r\n{\r\nif (!BN_copy(tmp,X)) goto err;\r\nif (!BN_mul_word(tmp,D->d[0])) goto err;\r\n}\r\nelse\r\n{\r\nif (!BN_mul(tmp,D,X,ctx)) goto err;\r\n}\r\nif (!BN_add(tmp,tmp,Y)) goto err;\r\n}\r\nM=Y;\r\nY=X;\r\nX=tmp;\r\nsign = -sign;\r\n}\r\n}\r\nif (sign < 0)\r\n{\r\nif (!BN_sub(Y,n,Y)) goto err;\r\n}\r\nif (BN_is_one(A))\r\n{\r\nif (!Y->neg && BN_ucmp(Y,n) < 0)\r\n{\r\nif (!BN_copy(R,Y)) goto err;\r\n}\r\nelse\r\n{\r\nif (!BN_nnmod(R,Y,n,ctx)) goto err;\r\n}\r\n}\r\nelse\r\n{\r\nBNerr(BN_F_BN_MOD_INVERSE,BN_R_NO_INVERSE);\r\ngoto err;\r\n}\r\nret=R;\r\nerr:\r\nif ((ret == NULL) && (in == NULL)) BN_free(R);\r\nBN_CTX_end(ctx);\r\nbn_check_top(ret);\r\nreturn(ret);\r\n}\r\nstatic BIGNUM *BN_mod_inverse_no_branch(BIGNUM *in,\r\nconst BIGNUM *a, const BIGNUM *n, BN_CTX *ctx)\r\n{\r\nBIGNUM *A,*B,*X,*Y,*M,*D,*T,*R=NULL;\r\nBIGNUM local_A, local_B;\r\nBIGNUM *pA, *pB;\r\nBIGNUM *ret=NULL;\r\nint sign;\r\nbn_check_top(a);\r\nbn_check_top(n);\r\nBN_CTX_start(ctx);\r\nA = BN_CTX_get(ctx);\r\nB = BN_CTX_get(ctx);\r\nX = BN_CTX_get(ctx);\r\nD = BN_CTX_get(ctx);\r\nM = BN_CTX_get(ctx);\r\nY = BN_CTX_get(ctx);\r\nT = BN_CTX_get(ctx);\r\nif (T == NULL) goto err;\r\nif (in == NULL)\r\nR=BN_new();\r\nelse\r\nR=in;\r\nif (R == NULL) goto err;\r\nBN_one(X);\r\nBN_zero(Y);\r\nif (BN_copy(B,a) == NULL) goto err;\r\nif (BN_copy(A,n) == NULL) goto err;\r\nA->neg = 0;\r\nif (B->neg || (BN_ucmp(B, A) >= 0))\r\n{\r\npB = &local_B;\r\nBN_with_flags(pB, B, BN_FLG_CONSTTIME);\r\nif (!BN_nnmod(B, pB, A, ctx)) goto err;\r\n}\r\nsign = -1;\r\nwhile (!BN_is_zero(B))\r\n{\r\nBIGNUM *tmp;\r\npA = &local_A;\r\nBN_with_flags(pA, A, BN_FLG_CONSTTIME);\r\nif (!BN_div(D,M,pA,B,ctx)) goto err;\r\ntmp=A;\r\nA=B;\r\nB=M;\r\nif (!BN_mul(tmp,D,X,ctx)) goto err;\r\nif (!BN_add(tmp,tmp,Y)) goto err;\r\nM=Y;\r\nY=X;\r\nX=tmp;\r\nsign = -sign;\r\n}\r\nif (sign < 0)\r\n{\r\nif (!BN_sub(Y,n,Y)) goto err;\r\n}\r\nif (BN_is_one(A))\r\n{\r\nif (!Y->neg && BN_ucmp(Y,n) < 0)\r\n{\r\nif (!BN_copy(R,Y)) goto err;\r\n}\r\nelse\r\n{\r\nif (!BN_nnmod(R,Y,n,ctx)) goto err;\r\n}\r\n}\r\nelse\r\n{\r\nBNerr(BN_F_BN_MOD_INVERSE_NO_BRANCH,BN_R_NO_INVERSE);\r\ngoto err;\r\n}\r\nret=R;\r\nerr:\r\nif ((ret == NULL) && (in == NULL)) BN_free(R);\r\nBN_CTX_end(ctx);\r\nbn_check_top(ret);\r\nreturn(ret);\r\n}

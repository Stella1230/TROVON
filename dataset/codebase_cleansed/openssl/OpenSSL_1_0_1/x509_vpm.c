static void x509_verify_param_zero(X509_VERIFY_PARAM *param)\r\n{\r\nif (!param)\r\nreturn;\r\nparam->name = NULL;\r\nparam->purpose = 0;\r\nparam->trust = 0;\r\nparam->inh_flags = 0;\r\nparam->flags = 0;\r\nparam->depth = -1;\r\nif (param->policies)\r\n{\r\nsk_ASN1_OBJECT_pop_free(param->policies, ASN1_OBJECT_free);\r\nparam->policies = NULL;\r\n}\r\n}\r\nX509_VERIFY_PARAM *X509_VERIFY_PARAM_new(void)\r\n{\r\nX509_VERIFY_PARAM *param;\r\nparam = OPENSSL_malloc(sizeof(X509_VERIFY_PARAM));\r\nmemset(param, 0, sizeof(X509_VERIFY_PARAM));\r\nx509_verify_param_zero(param);\r\nreturn param;\r\n}\r\nvoid X509_VERIFY_PARAM_free(X509_VERIFY_PARAM *param)\r\n{\r\nx509_verify_param_zero(param);\r\nOPENSSL_free(param);\r\n}\r\nint X509_VERIFY_PARAM_inherit(X509_VERIFY_PARAM *dest,\r\nconst X509_VERIFY_PARAM *src)\r\n{\r\nunsigned long inh_flags;\r\nint to_default, to_overwrite;\r\nif (!src)\r\nreturn 1;\r\ninh_flags = dest->inh_flags | src->inh_flags;\r\nif (inh_flags & X509_VP_FLAG_ONCE)\r\ndest->inh_flags = 0;\r\nif (inh_flags & X509_VP_FLAG_LOCKED)\r\nreturn 1;\r\nif (inh_flags & X509_VP_FLAG_DEFAULT)\r\nto_default = 1;\r\nelse\r\nto_default = 0;\r\nif (inh_flags & X509_VP_FLAG_OVERWRITE)\r\nto_overwrite = 1;\r\nelse\r\nto_overwrite = 0;\r\nx509_verify_param_copy(purpose, 0);\r\nx509_verify_param_copy(trust, 0);\r\nx509_verify_param_copy(depth, -1);\r\nif (to_overwrite || !(dest->flags & X509_V_FLAG_USE_CHECK_TIME))\r\n{\r\ndest->check_time = src->check_time;\r\ndest->flags &= ~X509_V_FLAG_USE_CHECK_TIME;\r\n}\r\nif (inh_flags & X509_VP_FLAG_RESET_FLAGS)\r\ndest->flags = 0;\r\ndest->flags |= src->flags;\r\nif (test_x509_verify_param_copy(policies, NULL))\r\n{\r\nif (!X509_VERIFY_PARAM_set1_policies(dest, src->policies))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint X509_VERIFY_PARAM_set1(X509_VERIFY_PARAM *to,\r\nconst X509_VERIFY_PARAM *from)\r\n{\r\nunsigned long save_flags = to->inh_flags;\r\nint ret;\r\nto->inh_flags |= X509_VP_FLAG_DEFAULT;\r\nret = X509_VERIFY_PARAM_inherit(to, from);\r\nto->inh_flags = save_flags;\r\nreturn ret;\r\n}\r\nint X509_VERIFY_PARAM_set1_name(X509_VERIFY_PARAM *param, const char *name)\r\n{\r\nif (param->name)\r\nOPENSSL_free(param->name);\r\nparam->name = BUF_strdup(name);\r\nif (param->name)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint X509_VERIFY_PARAM_set_flags(X509_VERIFY_PARAM *param, unsigned long flags)\r\n{\r\nparam->flags |= flags;\r\nif (flags & X509_V_FLAG_POLICY_MASK)\r\nparam->flags |= X509_V_FLAG_POLICY_CHECK;\r\nreturn 1;\r\n}\r\nint X509_VERIFY_PARAM_clear_flags(X509_VERIFY_PARAM *param, unsigned long flags)\r\n{\r\nparam->flags &= ~flags;\r\nreturn 1;\r\n}\r\nunsigned long X509_VERIFY_PARAM_get_flags(X509_VERIFY_PARAM *param)\r\n{\r\nreturn param->flags;\r\n}\r\nint X509_VERIFY_PARAM_set_purpose(X509_VERIFY_PARAM *param, int purpose)\r\n{\r\nreturn X509_PURPOSE_set(&param->purpose, purpose);\r\n}\r\nint X509_VERIFY_PARAM_set_trust(X509_VERIFY_PARAM *param, int trust)\r\n{\r\nreturn X509_TRUST_set(&param->trust, trust);\r\n}\r\nvoid X509_VERIFY_PARAM_set_depth(X509_VERIFY_PARAM *param, int depth)\r\n{\r\nparam->depth = depth;\r\n}\r\nvoid X509_VERIFY_PARAM_set_time(X509_VERIFY_PARAM *param, time_t t)\r\n{\r\nparam->check_time = t;\r\nparam->flags |= X509_V_FLAG_USE_CHECK_TIME;\r\n}\r\nint X509_VERIFY_PARAM_add0_policy(X509_VERIFY_PARAM *param, ASN1_OBJECT *policy)\r\n{\r\nif (!param->policies)\r\n{\r\nparam->policies = sk_ASN1_OBJECT_new_null();\r\nif (!param->policies)\r\nreturn 0;\r\n}\r\nif (!sk_ASN1_OBJECT_push(param->policies, policy))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint X509_VERIFY_PARAM_get_depth(const X509_VERIFY_PARAM *param)\r\n{\r\nreturn param->depth;\r\n}\r\nstatic int table_cmp(const X509_VERIFY_PARAM *a, const X509_VERIFY_PARAM *b)\r\n{\r\nreturn strcmp(a->name, b->name);\r\n}\r\nstatic int param_cmp(const X509_VERIFY_PARAM * const *a,\r\nconst X509_VERIFY_PARAM * const *b)\r\n{\r\nreturn strcmp((*a)->name, (*b)->name);\r\n}\r\nint X509_VERIFY_PARAM_add0_table(X509_VERIFY_PARAM *param)\r\n{\r\nint idx;\r\nX509_VERIFY_PARAM *ptmp;\r\nif (!param_table)\r\n{\r\nparam_table = sk_X509_VERIFY_PARAM_new(param_cmp);\r\nif (!param_table)\r\nreturn 0;\r\n}\r\nelse\r\n{\r\nidx = sk_X509_VERIFY_PARAM_find(param_table, param);\r\nif (idx != -1)\r\n{\r\nptmp = sk_X509_VERIFY_PARAM_value(param_table, idx);\r\nX509_VERIFY_PARAM_free(ptmp);\r\n(void)sk_X509_VERIFY_PARAM_delete(param_table, idx);\r\n}\r\n}\r\nif (!sk_X509_VERIFY_PARAM_push(param_table, param))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nconst X509_VERIFY_PARAM *X509_VERIFY_PARAM_lookup(const char *name)\r\n{\r\nint idx;\r\nX509_VERIFY_PARAM pm;\r\npm.name = (char *)name;\r\nif (param_table)\r\n{\r\nidx = sk_X509_VERIFY_PARAM_find(param_table, &pm);\r\nif (idx != -1)\r\nreturn sk_X509_VERIFY_PARAM_value(param_table, idx);\r\n}\r\nreturn OBJ_bsearch_table(&pm, default_table,\r\nsizeof(default_table)/sizeof(X509_VERIFY_PARAM));\r\n}\r\nvoid X509_VERIFY_PARAM_table_cleanup(void)\r\n{\r\nif (param_table)\r\nsk_X509_VERIFY_PARAM_pop_free(param_table,\r\nX509_VERIFY_PARAM_free);\r\nparam_table = NULL;\r\n}

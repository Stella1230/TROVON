int ASN1_GENERALIZEDTIME_check(ASN1_GENERALIZEDTIME *d)\r\n{\r\nstatic const int min[9]={ 0, 0, 1, 1, 0, 0, 0, 0, 0};\r\nstatic const int max[9]={99, 99,12,31,23,59,59,12,59};\r\nchar *a;\r\nint n,i,l,o;\r\nif (d->type != V_ASN1_GENERALIZEDTIME) return(0);\r\nl=d->length;\r\na=(char *)d->data;\r\no=0;\r\nif (l < 13) goto err;\r\nfor (i=0; i<7; i++)\r\n{\r\nif ((i == 6) && ((a[o] == 'Z') ||\r\n(a[o] == '+') || (a[o] == '-')))\r\n{ i++; break; }\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn= a[o]-'0';\r\nif (++o > l) goto err;\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn=(n*10)+ a[o]-'0';\r\nif (++o > l) goto err;\r\nif ((n < min[i]) || (n > max[i])) goto err;\r\n}\r\nif (a[o] == '.')\r\n{\r\nif (++o > l) goto err;\r\ni = o;\r\nwhile ((a[o] >= '0') && (a[o] <= '9') && (o <= l))\r\no++;\r\nif (i == o) goto err;\r\n}\r\nif (a[o] == 'Z')\r\no++;\r\nelse if ((a[o] == '+') || (a[o] == '-'))\r\n{\r\no++;\r\nif (o+4 > l) goto err;\r\nfor (i=7; i<9; i++)\r\n{\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn= a[o]-'0';\r\no++;\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn=(n*10)+ a[o]-'0';\r\nif ((n < min[i]) || (n > max[i])) goto err;\r\no++;\r\n}\r\n}\r\nelse\r\n{\r\ngoto err;\r\n}\r\nreturn(o == l);\r\nerr:\r\nreturn(0);\r\n}\r\nint ASN1_GENERALIZEDTIME_set_string(ASN1_GENERALIZEDTIME *s, const char *str)\r\n{\r\nASN1_GENERALIZEDTIME t;\r\nt.type=V_ASN1_GENERALIZEDTIME;\r\nt.length=strlen(str);\r\nt.data=(unsigned char *)str;\r\nif (ASN1_GENERALIZEDTIME_check(&t))\r\n{\r\nif (s != NULL)\r\n{\r\nif (!ASN1_STRING_set((ASN1_STRING *)s,\r\n(unsigned char *)str,t.length))\r\nreturn 0;\r\ns->type=V_ASN1_GENERALIZEDTIME;\r\n}\r\nreturn(1);\r\n}\r\nelse\r\nreturn(0);\r\n}\r\nASN1_GENERALIZEDTIME *ASN1_GENERALIZEDTIME_set(ASN1_GENERALIZEDTIME *s,\r\ntime_t t)\r\n{\r\nreturn ASN1_GENERALIZEDTIME_adj(s, t, 0, 0);\r\n}\r\nASN1_GENERALIZEDTIME *ASN1_GENERALIZEDTIME_adj(ASN1_GENERALIZEDTIME *s,\r\ntime_t t, int offset_day, long offset_sec)\r\n{\r\nchar *p;\r\nstruct tm *ts;\r\nstruct tm data;\r\nsize_t len = 20;\r\nif (s == NULL)\r\ns=M_ASN1_GENERALIZEDTIME_new();\r\nif (s == NULL)\r\nreturn(NULL);\r\nts=OPENSSL_gmtime(&t, &data);\r\nif (ts == NULL)\r\nreturn(NULL);\r\nif (offset_day || offset_sec)\r\n{\r\nif (!OPENSSL_gmtime_adj(ts, offset_day, offset_sec))\r\nreturn NULL;\r\n}\r\np=(char *)s->data;\r\nif ((p == NULL) || ((size_t)s->length < len))\r\n{\r\np=OPENSSL_malloc(len);\r\nif (p == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_GENERALIZEDTIME_ADJ,\r\nERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nif (s->data != NULL)\r\nOPENSSL_free(s->data);\r\ns->data=(unsigned char *)p;\r\n}\r\nBIO_snprintf(p,len,"%04d%02d%02d%02d%02d%02dZ",ts->tm_year + 1900,\r\nts->tm_mon+1,ts->tm_mday,ts->tm_hour,ts->tm_min,ts->tm_sec);\r\ns->length=strlen(p);\r\ns->type=V_ASN1_GENERALIZEDTIME;\r\n#ifdef CHARSET_EBCDIC_not\r\nebcdic2ascii(s->data, s->data, s->length);\r\n#endif\r\nreturn(s);\r\n}

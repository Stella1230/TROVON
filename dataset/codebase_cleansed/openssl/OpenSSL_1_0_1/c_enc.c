void CAST_encrypt(CAST_LONG *data, const CAST_KEY *key)\r\n{\r\nregister CAST_LONG l,r,t;\r\nconst register CAST_LONG *k;\r\nk= &(key->data[0]);\r\nl=data[0];\r\nr=data[1];\r\nE_CAST( 0,k,l,r,+,^,-);\r\nE_CAST( 1,k,r,l,^,-,+);\r\nE_CAST( 2,k,l,r,-,+,^);\r\nE_CAST( 3,k,r,l,+,^,-);\r\nE_CAST( 4,k,l,r,^,-,+);\r\nE_CAST( 5,k,r,l,-,+,^);\r\nE_CAST( 6,k,l,r,+,^,-);\r\nE_CAST( 7,k,r,l,^,-,+);\r\nE_CAST( 8,k,l,r,-,+,^);\r\nE_CAST( 9,k,r,l,+,^,-);\r\nE_CAST(10,k,l,r,^,-,+);\r\nE_CAST(11,k,r,l,-,+,^);\r\nif(!key->short_key)\r\n{\r\nE_CAST(12,k,l,r,+,^,-);\r\nE_CAST(13,k,r,l,^,-,+);\r\nE_CAST(14,k,l,r,-,+,^);\r\nE_CAST(15,k,r,l,+,^,-);\r\n}\r\ndata[1]=l&0xffffffffL;\r\ndata[0]=r&0xffffffffL;\r\n}\r\nvoid CAST_decrypt(CAST_LONG *data, const CAST_KEY *key)\r\n{\r\nregister CAST_LONG l,r,t;\r\nconst register CAST_LONG *k;\r\nk= &(key->data[0]);\r\nl=data[0];\r\nr=data[1];\r\nif(!key->short_key)\r\n{\r\nE_CAST(15,k,l,r,+,^,-);\r\nE_CAST(14,k,r,l,-,+,^);\r\nE_CAST(13,k,l,r,^,-,+);\r\nE_CAST(12,k,r,l,+,^,-);\r\n}\r\nE_CAST(11,k,l,r,-,+,^);\r\nE_CAST(10,k,r,l,^,-,+);\r\nE_CAST( 9,k,l,r,+,^,-);\r\nE_CAST( 8,k,r,l,-,+,^);\r\nE_CAST( 7,k,l,r,^,-,+);\r\nE_CAST( 6,k,r,l,+,^,-);\r\nE_CAST( 5,k,l,r,-,+,^);\r\nE_CAST( 4,k,r,l,^,-,+);\r\nE_CAST( 3,k,l,r,+,^,-);\r\nE_CAST( 2,k,r,l,-,+,^);\r\nE_CAST( 1,k,l,r,^,-,+);\r\nE_CAST( 0,k,r,l,+,^,-);\r\ndata[1]=l&0xffffffffL;\r\ndata[0]=r&0xffffffffL;\r\n}\r\nvoid CAST_cbc_encrypt(const unsigned char *in, unsigned char *out, long length,\r\nconst CAST_KEY *ks, unsigned char *iv, int enc)\r\n{\r\nregister CAST_LONG tin0,tin1;\r\nregister CAST_LONG tout0,tout1,xor0,xor1;\r\nregister long l=length;\r\nCAST_LONG tin[2];\r\nif (enc)\r\n{\r\nn2l(iv,tout0);\r\nn2l(iv,tout1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nCAST_encrypt(tin,ks);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nn2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nCAST_encrypt(tin,ks);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\n}\r\nl2n(tout0,iv);\r\nl2n(tout1,iv);\r\n}\r\nelse\r\n{\r\nn2l(iv,xor0);\r\nn2l(iv,xor1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nCAST_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nif (l != -8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nCAST_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2nn(tout0,tout1,out,l+8);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nl2n(xor0,iv);\r\nl2n(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}

int main(int argc, char **argv)\r\n{\r\nBIO *bio_err;\r\nX509_REQ *req=NULL;\r\nEVP_PKEY *pkey=NULL;\r\nCRYPTO_mem_ctrl(CRYPTO_MEM_CHECK_ON);\r\nbio_err=BIO_new_fp(stderr, BIO_NOCLOSE);\r\nmkreq(&req,&pkey,512,0,365);\r\nRSA_print_fp(stdout,pkey->pkey.rsa,0);\r\nX509_REQ_print_fp(stdout,req);\r\nPEM_write_X509_REQ(stdout,req);\r\nX509_REQ_free(req);\r\nEVP_PKEY_free(pkey);\r\n#ifndef OPENSSL_NO_ENGINE\r\nENGINE_cleanup();\r\n#endif\r\nCRYPTO_cleanup_all_ex_data();\r\nCRYPTO_mem_leaks(bio_err);\r\nBIO_free(bio_err);\r\nreturn(0);\r\n}\r\nstatic void callback(int p, int n, void *arg)\r\n{\r\nchar c='B';\r\nif (p == 0) c='.';\r\nif (p == 1) c='+';\r\nif (p == 2) c='*';\r\nif (p == 3) c='\n';\r\nfputc(c,stderr);\r\n}\r\nint mkreq(X509_REQ **req, EVP_PKEY **pkeyp, int bits, int serial, int days)\r\n{\r\nX509_REQ *x;\r\nEVP_PKEY *pk;\r\nRSA *rsa;\r\nX509_NAME *name=NULL;\r\nSTACK_OF(X509_EXTENSION) *exts = NULL;\r\nif ((pk=EVP_PKEY_new()) == NULL)\r\ngoto err;\r\nif ((x=X509_REQ_new()) == NULL)\r\ngoto err;\r\nrsa=RSA_generate_key(bits,RSA_F4,callback,NULL);\r\nif (!EVP_PKEY_assign_RSA(pk,rsa))\r\ngoto err;\r\nrsa=NULL;\r\nX509_REQ_set_pubkey(x,pk);\r\nname=X509_REQ_get_subject_name(x);\r\nX509_NAME_add_entry_by_txt(name,"C",\r\nMBSTRING_ASC, "UK", -1, -1, 0);\r\nX509_NAME_add_entry_by_txt(name,"CN",\r\nMBSTRING_ASC, "OpenSSL Group", -1, -1, 0);\r\n#ifdef REQUEST_EXTENSIONS\r\nexts = sk_X509_EXTENSION_new_null();\r\nadd_ext(exts, NID_key_usage, "critical,digitalSignature,keyEncipherment");\r\nadd_ext(exts, NID_subject_alt_name, "email:steve@openssl.org");\r\nadd_ext(exts, NID_netscape_cert_type, "client,email");\r\n#ifdef CUSTOM_EXT\r\n{\r\nint nid;\r\nnid = OBJ_create("1.2.3.4", "MyAlias", "My Test Alias Extension");\r\nX509V3_EXT_add_alias(nid, NID_netscape_comment);\r\nadd_ext(x, nid, "example comment alias");\r\n}\r\n#endif\r\nX509_REQ_add_extensions(x, exts);\r\nsk_X509_EXTENSION_pop_free(exts, X509_EXTENSION_free);\r\n#endif\r\nif (!X509_REQ_sign(x,pk,EVP_sha1()))\r\ngoto err;\r\n*req=x;\r\n*pkeyp=pk;\r\nreturn(1);\r\nerr:\r\nreturn(0);\r\n}

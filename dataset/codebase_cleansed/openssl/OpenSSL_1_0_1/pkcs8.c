int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nchar **args, *infile = NULL, *outfile = NULL;\r\nchar *passargin = NULL, *passargout = NULL;\r\nBIO *in = NULL, *out = NULL;\r\nint topk8 = 0;\r\nint pbe_nid = -1;\r\nconst EVP_CIPHER *cipher = NULL;\r\nint iter = PKCS12_DEFAULT_ITER;\r\nint informat, outformat;\r\nint p8_broken = PKCS8_OK;\r\nint nocrypt = 0;\r\nX509_SIG *p8 = NULL;\r\nPKCS8_PRIV_KEY_INFO *p8inf = NULL;\r\nEVP_PKEY *pkey=NULL;\r\nchar pass[50], *passin = NULL, *passout = NULL, *p8pass = NULL;\r\nint badarg = 0;\r\nint ret = 1;\r\n#ifndef OPENSSL_NO_ENGINE\r\nchar *engine=NULL;\r\n#endif\r\nif (bio_err == NULL) bio_err = BIO_new_fp (stderr, BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\ninformat=FORMAT_PEM;\r\noutformat=FORMAT_PEM;\r\nERR_load_crypto_strings();\r\nOpenSSL_add_all_algorithms();\r\nargs = argv + 1;\r\nwhile (!badarg && *args && *args[0] == '-')\r\n{\r\nif (!strcmp(*args,"-v2"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\ncipher=EVP_get_cipherbyname(*args);\r\nif (!cipher)\r\n{\r\nBIO_printf(bio_err,\r\n"Unknown cipher %s\n", *args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse\r\nbadarg = 1;\r\n}\r\nelse if (!strcmp(*args,"-v1"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\npbe_nid=OBJ_txt2nid(*args);\r\nif (pbe_nid == NID_undef)\r\n{\r\nBIO_printf(bio_err,\r\n"Unknown PBE algorithm %s\n", *args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse\r\nbadarg = 1;\r\n}\r\nelse if (!strcmp(*args,"-inform"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\ninformat=str2fmt(*args);\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args,"-outform"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutformat=str2fmt(*args);\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-topk8"))\r\ntopk8 = 1;\r\nelse if (!strcmp (*args, "-noiter"))\r\niter = 1;\r\nelse if (!strcmp (*args, "-nocrypt"))\r\nnocrypt = 1;\r\nelse if (!strcmp (*args, "-nooct"))\r\np8_broken = PKCS8_NO_OCTET;\r\nelse if (!strcmp (*args, "-nsdb"))\r\np8_broken = PKCS8_NS_DB;\r\nelse if (!strcmp (*args, "-embed"))\r\np8_broken = PKCS8_EMBEDDED_PARAM;\r\nelse if (!strcmp(*args,"-passin"))\r\n{\r\nif (!args[1]) goto bad;\r\npassargin= *(++args);\r\n}\r\nelse if (!strcmp(*args,"-passout"))\r\n{\r\nif (!args[1]) goto bad;\r\npassargout= *(++args);\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\nelse if (strcmp(*args,"-engine") == 0)\r\n{\r\nif (!args[1]) goto bad;\r\nengine= *(++args);\r\n}\r\n#endif\r\nelse if (!strcmp (*args, "-in"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\ninfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-out"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse badarg = 1;\r\nargs++;\r\n}\r\nif (badarg)\r\n{\r\nbad:\r\nBIO_printf(bio_err, "Usage pkcs8 [options]\n");\r\nBIO_printf(bio_err, "where options are\n");\r\nBIO_printf(bio_err, "-in file input file\n");\r\nBIO_printf(bio_err, "-inform X input format (DER or PEM)\n");\r\nBIO_printf(bio_err, "-passin arg input file pass phrase source\n");\r\nBIO_printf(bio_err, "-outform X output format (DER or PEM)\n");\r\nBIO_printf(bio_err, "-out file output file\n");\r\nBIO_printf(bio_err, "-passout arg output file pass phrase source\n");\r\nBIO_printf(bio_err, "-topk8 output PKCS8 file\n");\r\nBIO_printf(bio_err, "-nooct use (nonstandard) no octet format\n");\r\nBIO_printf(bio_err, "-embed use (nonstandard) embedded DSA parameters format\n");\r\nBIO_printf(bio_err, "-nsdb use (nonstandard) DSA Netscape DB format\n");\r\nBIO_printf(bio_err, "-noiter use 1 as iteration count\n");\r\nBIO_printf(bio_err, "-nocrypt use or expect unencrypted private key\n");\r\nBIO_printf(bio_err, "-v2 alg use PKCS#5 v2.0 and cipher \"alg\"\n");\r\nBIO_printf(bio_err, "-v1 obj use PKCS#5 v1.5 and cipher \"alg\"\n");\r\n#ifndef OPENSSL_NO_ENGINE\r\nBIO_printf(bio_err," -engine e use engine e, possibly a hardware device.\n");\r\n#endif\r\ngoto end;\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\ne = setup_engine(bio_err, engine, 0);\r\n#endif\r\nif (!app_passwd(bio_err, passargin, passargout, &passin, &passout))\r\n{\r\nBIO_printf(bio_err, "Error getting passwords\n");\r\ngoto end;\r\n}\r\nif ((pbe_nid == -1) && !cipher)\r\npbe_nid = NID_pbeWithMD5AndDES_CBC;\r\nif (infile)\r\n{\r\nif (!(in = BIO_new_file(infile, "rb")))\r\n{\r\nBIO_printf(bio_err,\r\n"Can't open input file %s\n", infile);\r\ngoto end;\r\n}\r\n}\r\nelse\r\nin = BIO_new_fp (stdin, BIO_NOCLOSE);\r\nif (outfile)\r\n{\r\nif (!(out = BIO_new_file (outfile, "wb")))\r\n{\r\nBIO_printf(bio_err,\r\n"Can't open output file %s\n", outfile);\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nout = BIO_new_fp (stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nif (topk8)\r\n{\r\npkey = load_key(bio_err, infile, informat, 1,\r\npassin, e, "key");\r\nif (!pkey)\r\ngoto end;\r\nif (!(p8inf = EVP_PKEY2PKCS8_broken(pkey, p8_broken)))\r\n{\r\nBIO_printf(bio_err, "Error converting key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (nocrypt)\r\n{\r\nif (outformat == FORMAT_PEM)\r\nPEM_write_bio_PKCS8_PRIV_KEY_INFO(out, p8inf);\r\nelse if (outformat == FORMAT_ASN1)\r\ni2d_PKCS8_PRIV_KEY_INFO_bio(out, p8inf);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nif (passout)\r\np8pass = passout;\r\nelse\r\n{\r\np8pass = pass;\r\nif (EVP_read_pw_string(pass, sizeof pass, "Enter Encryption Password:", 1))\r\ngoto end;\r\n}\r\napp_RAND_load_file(NULL, bio_err, 0);\r\nif (!(p8 = PKCS8_encrypt(pbe_nid, cipher,\r\np8pass, strlen(p8pass),\r\nNULL, 0, iter, p8inf)))\r\n{\r\nBIO_printf(bio_err, "Error encrypting key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\napp_RAND_write_file(NULL, bio_err);\r\nif (outformat == FORMAT_PEM)\r\nPEM_write_bio_PKCS8(out, p8);\r\nelse if (outformat == FORMAT_ASN1)\r\ni2d_PKCS8_bio(out, p8);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\n}\r\nret = 0;\r\ngoto end;\r\n}\r\nif (nocrypt)\r\n{\r\nif (informat == FORMAT_PEM)\r\np8inf = PEM_read_bio_PKCS8_PRIV_KEY_INFO(in,NULL,NULL, NULL);\r\nelse if (informat == FORMAT_ASN1)\r\np8inf = d2i_PKCS8_PRIV_KEY_INFO_bio(in, NULL);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nif (informat == FORMAT_PEM)\r\np8 = PEM_read_bio_PKCS8(in, NULL, NULL, NULL);\r\nelse if (informat == FORMAT_ASN1)\r\np8 = d2i_PKCS8_bio(in, NULL);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\nif (!p8)\r\n{\r\nBIO_printf (bio_err, "Error reading key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (passin)\r\np8pass = passin;\r\nelse\r\n{\r\np8pass = pass;\r\nEVP_read_pw_string(pass, sizeof pass, "Enter Password:", 0);\r\n}\r\np8inf = PKCS8_decrypt(p8, p8pass, strlen(p8pass));\r\n}\r\nif (!p8inf)\r\n{\r\nBIO_printf(bio_err, "Error decrypting key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (!(pkey = EVP_PKCS82PKEY(p8inf)))\r\n{\r\nBIO_printf(bio_err, "Error converting key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (p8inf->broken)\r\n{\r\nBIO_printf(bio_err, "Warning: broken key encoding: ");\r\nswitch (p8inf->broken)\r\n{\r\ncase PKCS8_NO_OCTET:\r\nBIO_printf(bio_err, "No Octet String in PrivateKey\n");\r\nbreak;\r\ncase PKCS8_EMBEDDED_PARAM:\r\nBIO_printf(bio_err, "DSA parameters included in PrivateKey\n");\r\nbreak;\r\ncase PKCS8_NS_DB:\r\nBIO_printf(bio_err, "DSA public key include in PrivateKey\n");\r\nbreak;\r\ncase PKCS8_NEG_PRIVKEY:\r\nBIO_printf(bio_err, "DSA private key value is negative\n");\r\nbreak;\r\ndefault:\r\nBIO_printf(bio_err, "Unknown broken type\n");\r\nbreak;\r\n}\r\n}\r\nif (outformat == FORMAT_PEM)\r\nPEM_write_bio_PrivateKey(out, pkey, NULL, NULL, 0, NULL, passout);\r\nelse if (outformat == FORMAT_ASN1)\r\ni2d_PrivateKey_bio(out, pkey);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\nret = 0;\r\nend:\r\nX509_SIG_free(p8);\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\nEVP_PKEY_free(pkey);\r\nBIO_free_all(out);\r\nBIO_free(in);\r\nif (passin)\r\nOPENSSL_free(passin);\r\nif (passout)\r\nOPENSSL_free(passout);\r\nreturn ret;\r\n}

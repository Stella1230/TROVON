int RSA_padding_add_SSLv23(unsigned char *to, int tlen,\r\nconst unsigned char *from, int flen)\r\n{\r\nint i,j;\r\nunsigned char *p;\r\nif (flen > (tlen-11))\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_ADD_SSLV23,RSA_R_DATA_TOO_LARGE_FOR_KEY_SIZE);\r\nreturn(0);\r\n}\r\np=(unsigned char *)to;\r\n*(p++)=0;\r\n*(p++)=2;\r\nj=tlen-3-8-flen;\r\nif (RAND_bytes(p,j) <= 0)\r\nreturn(0);\r\nfor (i=0; i<j; i++)\r\n{\r\nif (*p == '\0')\r\ndo {\r\nif (RAND_bytes(p,1) <= 0)\r\nreturn(0);\r\n} while (*p == '\0');\r\np++;\r\n}\r\nmemset(p,3,8);\r\np+=8;\r\n*(p++)='\0';\r\nmemcpy(p,from,(unsigned int)flen);\r\nreturn(1);\r\n}\r\nint RSA_padding_check_SSLv23(unsigned char *to, int tlen,\r\nconst unsigned char *from, int flen, int num)\r\n{\r\nint i,j,k;\r\nconst unsigned char *p;\r\np=from;\r\nif (flen < 10)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_SSLV23,RSA_R_DATA_TOO_SMALL);\r\nreturn(-1);\r\n}\r\nif ((num != (flen+1)) || (*(p++) != 02))\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_SSLV23,RSA_R_BLOCK_TYPE_IS_NOT_02);\r\nreturn(-1);\r\n}\r\nj=flen-1;\r\nfor (i=0; i<j; i++)\r\nif (*(p++) == 0) break;\r\nif ((i == j) || (i < 8))\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_SSLV23,RSA_R_NULL_BEFORE_BLOCK_MISSING);\r\nreturn(-1);\r\n}\r\nfor (k = -9; k<-1; k++)\r\n{\r\nif (p[k] != 0x03) break;\r\n}\r\nif (k == -1)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_SSLV23,RSA_R_SSLV3_ROLLBACK_ATTACK);\r\nreturn(-1);\r\n}\r\ni++;\r\nj-=i;\r\nif (j > tlen)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_SSLV23,RSA_R_DATA_TOO_LARGE);\r\nreturn(-1);\r\n}\r\nmemcpy(to,p,(unsigned int)j);\r\nreturn(j);\r\n}

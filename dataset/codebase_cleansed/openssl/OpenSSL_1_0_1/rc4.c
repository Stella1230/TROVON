int main(int argc, char *argv[])\r\n{\r\nFILE *in=NULL,*out=NULL;\r\nchar *infile=NULL,*outfile=NULL,*keystr=NULL;\r\nRC4_KEY key;\r\nchar buf[BUFSIZ];\r\nint badops=0,i;\r\nchar **pp;\r\nunsigned char md[MD5_DIGEST_LENGTH];\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-key") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nkeystr= *(++argv);\r\n}\r\nelse\r\n{\r\nfprintf(stderr,"unknown option %s\n",*argv);\r\nbadops=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nfor (pp=usage; (*pp != NULL); pp++)\r\nfprintf(stderr,"%s",*pp);\r\nexit(1);\r\n}\r\nif (infile == NULL)\r\nin=stdin;\r\nelse\r\n{\r\nin=fopen(infile,"r");\r\nif (in == NULL)\r\n{\r\nperror("open");\r\nexit(1);\r\n}\r\n}\r\nif (outfile == NULL)\r\nout=stdout;\r\nelse\r\n{\r\nout=fopen(outfile,"w");\r\nif (out == NULL)\r\n{\r\nperror("open");\r\nexit(1);\r\n}\r\n}\r\n#ifdef OPENSSL_SYS_MSDOS\r\n{\r\n#include <fcntl.h>\r\nsetmode(fileno(in),O_BINARY);\r\nsetmode(fileno(out),O_BINARY);\r\n}\r\n#endif\r\nif (keystr == NULL)\r\n{\r\ni=EVP_read_pw_string(buf,BUFSIZ,"Enter RC4 password:",0);\r\nif (i != 0)\r\n{\r\nOPENSSL_cleanse(buf,BUFSIZ);\r\nfprintf(stderr,"bad password read\n");\r\nexit(1);\r\n}\r\nkeystr=buf;\r\n}\r\nEVP_Digest((unsigned char *)keystr,strlen(keystr),md,NULL,EVP_md5(),NULL);\r\nOPENSSL_cleanse(keystr,strlen(keystr));\r\nRC4_set_key(&key,MD5_DIGEST_LENGTH,md);\r\nfor(;;)\r\n{\r\ni=fread(buf,1,BUFSIZ,in);\r\nif (i == 0) break;\r\nif (i < 0)\r\n{\r\nperror("read");\r\nexit(1);\r\n}\r\nRC4(&key,(unsigned int)i,(unsigned char *)buf,\r\n(unsigned char *)buf);\r\ni=fwrite(buf,(unsigned int)i,1,out);\r\nif (i != 1)\r\n{\r\nperror("write");\r\nexit(1);\r\n}\r\n}\r\nfclose(out);\r\nfclose(in);\r\nexit(0);\r\nreturn(1);\r\n}

ASN1_TIME *ASN1_TIME_set(ASN1_TIME *s, time_t t)\r\n{\r\nreturn ASN1_TIME_adj(s, t, 0, 0);\r\n}\r\nASN1_TIME *ASN1_TIME_adj(ASN1_TIME *s, time_t t,\r\nint offset_day, long offset_sec)\r\n{\r\nstruct tm *ts;\r\nstruct tm data;\r\nts=OPENSSL_gmtime(&t,&data);\r\nif (ts == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_TIME_ADJ, ASN1_R_ERROR_GETTING_TIME);\r\nreturn NULL;\r\n}\r\nif (offset_day || offset_sec)\r\n{\r\nif (!OPENSSL_gmtime_adj(ts, offset_day, offset_sec))\r\nreturn NULL;\r\n}\r\nif((ts->tm_year >= 50) && (ts->tm_year < 150))\r\nreturn ASN1_UTCTIME_adj(s, t, offset_day, offset_sec);\r\nreturn ASN1_GENERALIZEDTIME_adj(s, t, offset_day, offset_sec);\r\n}\r\nint ASN1_TIME_check(ASN1_TIME *t)\r\n{\r\nif (t->type == V_ASN1_GENERALIZEDTIME)\r\nreturn ASN1_GENERALIZEDTIME_check(t);\r\nelse if (t->type == V_ASN1_UTCTIME)\r\nreturn ASN1_UTCTIME_check(t);\r\nreturn 0;\r\n}\r\nASN1_GENERALIZEDTIME *ASN1_TIME_to_generalizedtime(ASN1_TIME *t, ASN1_GENERALIZEDTIME **out)\r\n{\r\nASN1_GENERALIZEDTIME *ret;\r\nchar *str;\r\nint newlen;\r\nif (!ASN1_TIME_check(t)) return NULL;\r\nif (!out || !*out)\r\n{\r\nif (!(ret = ASN1_GENERALIZEDTIME_new ()))\r\nreturn NULL;\r\nif (out) *out = ret;\r\n}\r\nelse ret = *out;\r\nif (t->type == V_ASN1_GENERALIZEDTIME)\r\n{\r\nif(!ASN1_STRING_set(ret, t->data, t->length))\r\nreturn NULL;\r\nreturn ret;\r\n}\r\nif (!ASN1_STRING_set(ret, NULL, t->length + 2))\r\nreturn NULL;\r\nnewlen = t->length + 2 + 1;\r\nstr = (char *)ret->data;\r\nif (t->data[0] >= '5') BUF_strlcpy(str, "19", newlen);\r\nelse BUF_strlcpy(str, "20", newlen);\r\nBUF_strlcat(str, (char *)t->data, newlen);\r\nreturn ret;\r\n}\r\nint ASN1_TIME_set_string(ASN1_TIME *s, const char *str)\r\n{\r\nASN1_TIME t;\r\nt.length = strlen(str);\r\nt.data = (unsigned char *)str;\r\nt.flags = 0;\r\nt.type = V_ASN1_UTCTIME;\r\nif (!ASN1_TIME_check(&t))\r\n{\r\nt.type = V_ASN1_GENERALIZEDTIME;\r\nif (!ASN1_TIME_check(&t))\r\nreturn 0;\r\n}\r\nif (s && !ASN1_STRING_copy((ASN1_STRING *)s, (ASN1_STRING *)&t))\r\nreturn 0;\r\nreturn 1;\r\n}

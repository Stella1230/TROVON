int PEM_write_bio_PKCS8PrivateKey_nid(BIO *bp, EVP_PKEY *x, int nid,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey(bp, x, 0, nid, NULL, kstr, klen, cb, u);\r\n}\r\nint PEM_write_bio_PKCS8PrivateKey(BIO *bp, EVP_PKEY *x, const EVP_CIPHER *enc,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey(bp, x, 0, -1, enc, kstr, klen, cb, u);\r\n}\r\nint i2d_PKCS8PrivateKey_bio(BIO *bp, EVP_PKEY *x, const EVP_CIPHER *enc,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey(bp, x, 1, -1, enc, kstr, klen, cb, u);\r\n}\r\nint i2d_PKCS8PrivateKey_nid_bio(BIO *bp, EVP_PKEY *x, int nid,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey(bp, x, 1, nid, NULL, kstr, klen, cb, u);\r\n}\r\nstatic int do_pk8pkey(BIO *bp, EVP_PKEY *x, int isder, int nid, const EVP_CIPHER *enc,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nX509_SIG *p8;\r\nPKCS8_PRIV_KEY_INFO *p8inf;\r\nchar buf[PEM_BUFSIZE];\r\nint ret;\r\nif(!(p8inf = EVP_PKEY2PKCS8(x))) {\r\nPEMerr(PEM_F_DO_PK8PKEY,\r\nPEM_R_ERROR_CONVERTING_PRIVATE_KEY);\r\nreturn 0;\r\n}\r\nif(enc || (nid != -1)) {\r\nif(!kstr) {\r\nif(!cb) klen = PEM_def_callback(buf, PEM_BUFSIZE, 1, u);\r\nelse klen = cb(buf, PEM_BUFSIZE, 1, u);\r\nif(klen <= 0) {\r\nPEMerr(PEM_F_DO_PK8PKEY,PEM_R_READ_KEY);\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\nreturn 0;\r\n}\r\nkstr = buf;\r\n}\r\np8 = PKCS8_encrypt(nid, enc, kstr, klen, NULL, 0, 0, p8inf);\r\nif(kstr == buf) OPENSSL_cleanse(buf, klen);\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\nif(isder) ret = i2d_PKCS8_bio(bp, p8);\r\nelse ret = PEM_write_bio_PKCS8(bp, p8);\r\nX509_SIG_free(p8);\r\nreturn ret;\r\n} else {\r\nif(isder) ret = i2d_PKCS8_PRIV_KEY_INFO_bio(bp, p8inf);\r\nelse ret = PEM_write_bio_PKCS8_PRIV_KEY_INFO(bp, p8inf);\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\nreturn ret;\r\n}\r\n}\r\nEVP_PKEY *d2i_PKCS8PrivateKey_bio(BIO *bp, EVP_PKEY **x, pem_password_cb *cb, void *u)\r\n{\r\nPKCS8_PRIV_KEY_INFO *p8inf = NULL;\r\nX509_SIG *p8 = NULL;\r\nint klen;\r\nEVP_PKEY *ret;\r\nchar psbuf[PEM_BUFSIZE];\r\np8 = d2i_PKCS8_bio(bp, NULL);\r\nif(!p8) return NULL;\r\nif (cb) klen=cb(psbuf,PEM_BUFSIZE,0,u);\r\nelse klen=PEM_def_callback(psbuf,PEM_BUFSIZE,0,u);\r\nif (klen <= 0) {\r\nPEMerr(PEM_F_D2I_PKCS8PRIVATEKEY_BIO, PEM_R_BAD_PASSWORD_READ);\r\nX509_SIG_free(p8);\r\nreturn NULL;\r\n}\r\np8inf = PKCS8_decrypt(p8, psbuf, klen);\r\nX509_SIG_free(p8);\r\nif(!p8inf) return NULL;\r\nret = EVP_PKCS82PKEY(p8inf);\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\nif(!ret) return NULL;\r\nif(x) {\r\nif(*x) EVP_PKEY_free(*x);\r\n*x = ret;\r\n}\r\nreturn ret;\r\n}\r\nint i2d_PKCS8PrivateKey_fp(FILE *fp, EVP_PKEY *x, const EVP_CIPHER *enc,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey_fp(fp, x, 1, -1, enc, kstr, klen, cb, u);\r\n}\r\nint i2d_PKCS8PrivateKey_nid_fp(FILE *fp, EVP_PKEY *x, int nid,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey_fp(fp, x, 1, nid, NULL, kstr, klen, cb, u);\r\n}\r\nint PEM_write_PKCS8PrivateKey_nid(FILE *fp, EVP_PKEY *x, int nid,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey_fp(fp, x, 0, nid, NULL, kstr, klen, cb, u);\r\n}\r\nint PEM_write_PKCS8PrivateKey(FILE *fp, EVP_PKEY *x, const EVP_CIPHER *enc,\r\nchar *kstr, int klen, pem_password_cb *cb, void *u)\r\n{\r\nreturn do_pk8pkey_fp(fp, x, 0, -1, enc, kstr, klen, cb, u);\r\n}\r\nstatic int do_pk8pkey_fp(FILE *fp, EVP_PKEY *x, int isder, int nid, const EVP_CIPHER *enc,\r\nchar *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nBIO *bp;\r\nint ret;\r\nif(!(bp = BIO_new_fp(fp, BIO_NOCLOSE))) {\r\nPEMerr(PEM_F_DO_PK8PKEY_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nret = do_pk8pkey(bp, x, isder, nid, enc, kstr, klen, cb, u);\r\nBIO_free(bp);\r\nreturn ret;\r\n}\r\nEVP_PKEY *d2i_PKCS8PrivateKey_fp(FILE *fp, EVP_PKEY **x, pem_password_cb *cb, void *u)\r\n{\r\nBIO *bp;\r\nEVP_PKEY *ret;\r\nif(!(bp = BIO_new_fp(fp, BIO_NOCLOSE))) {\r\nPEMerr(PEM_F_D2I_PKCS8PRIVATEKEY_FP,ERR_R_BUF_LIB);\r\nreturn NULL;\r\n}\r\nret = d2i_PKCS8PrivateKey_bio(bp, x, cb, u);\r\nBIO_free(bp);\r\nreturn ret;\r\n}

int main(int argc, char **argv)\r\n{\r\nFILE *fp;\r\nEVP_PKEY *pkey;\r\nX509 *cert;\r\nSTACK_OF(X509) *ca = NULL;\r\nPKCS12 *p12;\r\nint i;\r\nif (argc != 4) {\r\nfprintf(stderr, "Usage: pkread p12file password opfile\n");\r\nexit (1);\r\n}\r\nOpenSSL_add_all_algorithms();\r\nERR_load_crypto_strings();\r\nif (!(fp = fopen(argv[1], "rb"))) {\r\nfprintf(stderr, "Error opening file %s\n", argv[1]);\r\nexit(1);\r\n}\r\np12 = d2i_PKCS12_fp(fp, NULL);\r\nfclose (fp);\r\nif (!p12) {\r\nfprintf(stderr, "Error reading PKCS#12 file\n");\r\nERR_print_errors_fp(stderr);\r\nexit (1);\r\n}\r\nif (!PKCS12_parse(p12, argv[2], &pkey, &cert, &ca)) {\r\nfprintf(stderr, "Error parsing PKCS#12 file\n");\r\nERR_print_errors_fp(stderr);\r\nexit (1);\r\n}\r\nPKCS12_free(p12);\r\nif (!(fp = fopen(argv[3], "w"))) {\r\nfprintf(stderr, "Error opening file %s\n", argv[1]);\r\nexit(1);\r\n}\r\nif (pkey) {\r\nfprintf(fp, "***Private Key***\n");\r\nPEM_write_PrivateKey(fp, pkey, NULL, NULL, 0, NULL, NULL);\r\n}\r\nif (cert) {\r\nfprintf(fp, "***User Certificate***\n");\r\nPEM_write_X509_AUX(fp, cert);\r\n}\r\nif (ca && sk_X509_num(ca)) {\r\nfprintf(fp, "***Other Certificates***\n");\r\nfor (i = 0; i < sk_X509_num(ca); i++)\r\nPEM_write_X509_AUX(fp, sk_X509_value(ca, i));\r\n}\r\nfclose(fp);\r\nreturn 0;\r\n}

void DES_cfb_encrypt(const unsigned char *in, unsigned char *out, int numbits,\r\nlong length, DES_key_schedule *schedule, DES_cblock *ivec,\r\nint enc)\r\n{\r\nregister DES_LONG d0,d1,v0,v1;\r\nregister unsigned long l=length;\r\nregister int num=numbits/8,n=(numbits+7)/8,i,rem=numbits%8;\r\nDES_LONG ti[2];\r\nunsigned char *iv;\r\n#ifndef L_ENDIAN\r\nunsigned char ovec[16];\r\n#else\r\nunsigned int sh[4];\r\nunsigned char *ovec=(unsigned char *)sh;\r\nassert (sizeof(sh[0])==4);\r\n#endif\r\nif (numbits<=0 || numbits > 64) return;\r\niv = &(*ivec)[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\nif (enc)\r\n{\r\nwhile (l >= (unsigned long)n)\r\n{\r\nl-=n;\r\nti[0]=v0;\r\nti[1]=v1;\r\nDES_encrypt1((DES_LONG *)ti,schedule,DES_ENCRYPT);\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nd0^=ti[0];\r\nd1^=ti[1];\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\nif (numbits == 32)\r\n{ v0=v1; v1=d0; }\r\nelse if (numbits == 64)\r\n{ v0=d0; v1=d1; }\r\nelse\r\n{\r\n#ifndef L_ENDIAN\r\niv=&ovec[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nl2c(d0,iv);\r\nl2c(d1,iv);\r\n#else\r\nsh[0]=v0, sh[1]=v1, sh[2]=d0, sh[3]=d1;\r\n#endif\r\nif (rem==0)\r\nmemmove(ovec,ovec+num,8);\r\nelse\r\nfor(i=0 ; i < 8 ; ++i)\r\novec[i]=ovec[i+num]<<rem |\r\novec[i+num+1]>>(8-rem);\r\n#ifdef L_ENDIAN\r\nv0=sh[0], v1=sh[1];\r\n#else\r\niv=&ovec[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\n#endif\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nwhile (l >= (unsigned long)n)\r\n{\r\nl-=n;\r\nti[0]=v0;\r\nti[1]=v1;\r\nDES_encrypt1((DES_LONG *)ti,schedule,DES_ENCRYPT);\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nif (numbits == 32)\r\n{ v0=v1; v1=d0; }\r\nelse if (numbits == 64)\r\n{ v0=d0; v1=d1; }\r\nelse\r\n{\r\n#ifndef L_ENDIAN\r\niv=&ovec[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nl2c(d0,iv);\r\nl2c(d1,iv);\r\n#else\r\nsh[0]=v0, sh[1]=v1, sh[2]=d0, sh[3]=d1;\r\n#endif\r\nif (rem==0)\r\nmemmove(ovec,ovec+num,8);\r\nelse\r\nfor(i=0 ; i < 8 ; ++i)\r\novec[i]=ovec[i+num]<<rem |\r\novec[i+num+1]>>(8-rem);\r\n#ifdef L_ENDIAN\r\nv0=sh[0], v1=sh[1];\r\n#else\r\niv=&ovec[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\n#endif\r\n}\r\nd0^=ti[0];\r\nd1^=ti[1];\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\n}\r\n}\r\niv = &(*ivec)[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nv0=v1=d0=d1=ti[0]=ti[1]=0;\r\n}

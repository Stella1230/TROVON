DSO *DSO_new(void)\r\n{\r\nreturn(DSO_new_method(NULL));\r\n}\r\nvoid DSO_set_default_method(DSO_METHOD *meth)\r\n{\r\ndefault_DSO_meth = meth;\r\n}\r\nDSO_METHOD *DSO_get_default_method(void)\r\n{\r\nreturn(default_DSO_meth);\r\n}\r\nDSO_METHOD *DSO_get_method(DSO *dso)\r\n{\r\nreturn(dso->meth);\r\n}\r\nDSO_METHOD *DSO_set_method(DSO *dso, DSO_METHOD *meth)\r\n{\r\nDSO_METHOD *mtmp;\r\nmtmp = dso->meth;\r\ndso->meth = meth;\r\nreturn(mtmp);\r\n}\r\nDSO *DSO_new_method(DSO_METHOD *meth)\r\n{\r\nDSO *ret;\r\nif(default_DSO_meth == NULL)\r\ndefault_DSO_meth = DSO_METHOD_openssl();\r\nret = (DSO *)OPENSSL_malloc(sizeof(DSO));\r\nif(ret == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_NEW_METHOD,ERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nmemset(ret, 0, sizeof(DSO));\r\nret->meth_data = sk_void_new_null();\r\nif(ret->meth_data == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_NEW_METHOD,ERR_R_MALLOC_FAILURE);\r\nOPENSSL_free(ret);\r\nreturn(NULL);\r\n}\r\nif(meth == NULL)\r\nret->meth = default_DSO_meth;\r\nelse\r\nret->meth = meth;\r\nret->references = 1;\r\nif((ret->meth->init != NULL) && !ret->meth->init(ret))\r\n{\r\nOPENSSL_free(ret);\r\nret=NULL;\r\n}\r\nreturn(ret);\r\n}\r\nint DSO_free(DSO *dso)\r\n{\r\nint i;\r\nif(dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_FREE,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\ni=CRYPTO_add(&dso->references,-1,CRYPTO_LOCK_DSO);\r\n#ifdef REF_PRINT\r\nREF_PRINT("DSO",dso);\r\n#endif\r\nif(i > 0) return(1);\r\n#ifdef REF_CHECK\r\nif(i < 0)\r\n{\r\nfprintf(stderr,"DSO_free, bad reference count\n");\r\nabort();\r\n}\r\n#endif\r\nif((dso->meth->dso_unload != NULL) && !dso->meth->dso_unload(dso))\r\n{\r\nDSOerr(DSO_F_DSO_FREE,DSO_R_UNLOAD_FAILED);\r\nreturn(0);\r\n}\r\nif((dso->meth->finish != NULL) && !dso->meth->finish(dso))\r\n{\r\nDSOerr(DSO_F_DSO_FREE,DSO_R_FINISH_FAILED);\r\nreturn(0);\r\n}\r\nsk_void_free(dso->meth_data);\r\nif(dso->filename != NULL)\r\nOPENSSL_free(dso->filename);\r\nif(dso->loaded_filename != NULL)\r\nOPENSSL_free(dso->loaded_filename);\r\nOPENSSL_free(dso);\r\nreturn(1);\r\n}\r\nint DSO_flags(DSO *dso)\r\n{\r\nreturn((dso == NULL) ? 0 : dso->flags);\r\n}\r\nint DSO_up_ref(DSO *dso)\r\n{\r\nif (dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_UP_REF,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nCRYPTO_add(&dso->references,1,CRYPTO_LOCK_DSO);\r\nreturn(1);\r\n}\r\nDSO *DSO_load(DSO *dso, const char *filename, DSO_METHOD *meth, int flags)\r\n{\r\nDSO *ret;\r\nint allocated = 0;\r\nif(dso == NULL)\r\n{\r\nret = DSO_new_method(meth);\r\nif(ret == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nallocated = 1;\r\nif(DSO_ctrl(ret, DSO_CTRL_SET_FLAGS, flags, NULL) < 0)\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,DSO_R_CTRL_FAILED);\r\ngoto err;\r\n}\r\n}\r\nelse\r\nret = dso;\r\nif(ret->filename != NULL)\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,DSO_R_DSO_ALREADY_LOADED);\r\ngoto err;\r\n}\r\nif(filename != NULL)\r\nif(!DSO_set_filename(ret, filename))\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,DSO_R_SET_FILENAME_FAILED);\r\ngoto err;\r\n}\r\nfilename = ret->filename;\r\nif(filename == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,DSO_R_NO_FILENAME);\r\ngoto err;\r\n}\r\nif(ret->meth->dso_load == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,DSO_R_UNSUPPORTED);\r\ngoto err;\r\n}\r\nif(!ret->meth->dso_load(ret))\r\n{\r\nDSOerr(DSO_F_DSO_LOAD,DSO_R_LOAD_FAILED);\r\ngoto err;\r\n}\r\nreturn(ret);\r\nerr:\r\nif(allocated)\r\nDSO_free(ret);\r\nreturn(NULL);\r\n}\r\nvoid *DSO_bind_var(DSO *dso, const char *symname)\r\n{\r\nvoid *ret = NULL;\r\nif((dso == NULL) || (symname == NULL))\r\n{\r\nDSOerr(DSO_F_DSO_BIND_VAR,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(NULL);\r\n}\r\nif(dso->meth->dso_bind_var == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_BIND_VAR,DSO_R_UNSUPPORTED);\r\nreturn(NULL);\r\n}\r\nif((ret = dso->meth->dso_bind_var(dso, symname)) == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_BIND_VAR,DSO_R_SYM_FAILURE);\r\nreturn(NULL);\r\n}\r\nreturn(ret);\r\n}\r\nDSO_FUNC_TYPE DSO_bind_func(DSO *dso, const char *symname)\r\n{\r\nDSO_FUNC_TYPE ret = NULL;\r\nif((dso == NULL) || (symname == NULL))\r\n{\r\nDSOerr(DSO_F_DSO_BIND_FUNC,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(NULL);\r\n}\r\nif(dso->meth->dso_bind_func == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_BIND_FUNC,DSO_R_UNSUPPORTED);\r\nreturn(NULL);\r\n}\r\nif((ret = dso->meth->dso_bind_func(dso, symname)) == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_BIND_FUNC,DSO_R_SYM_FAILURE);\r\nreturn(NULL);\r\n}\r\nreturn(ret);\r\n}\r\nlong DSO_ctrl(DSO *dso, int cmd, long larg, void *parg)\r\n{\r\nif(dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_CTRL,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(-1);\r\n}\r\nswitch(cmd)\r\n{\r\ncase DSO_CTRL_GET_FLAGS:\r\nreturn dso->flags;\r\ncase DSO_CTRL_SET_FLAGS:\r\ndso->flags = (int)larg;\r\nreturn(0);\r\ncase DSO_CTRL_OR_FLAGS:\r\ndso->flags |= (int)larg;\r\nreturn(0);\r\ndefault:\r\nbreak;\r\n}\r\nif((dso->meth == NULL) || (dso->meth->dso_ctrl == NULL))\r\n{\r\nDSOerr(DSO_F_DSO_CTRL,DSO_R_UNSUPPORTED);\r\nreturn(-1);\r\n}\r\nreturn(dso->meth->dso_ctrl(dso,cmd,larg,parg));\r\n}\r\nint DSO_set_name_converter(DSO *dso, DSO_NAME_CONVERTER_FUNC cb,\r\nDSO_NAME_CONVERTER_FUNC *oldcb)\r\n{\r\nif(dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_SET_NAME_CONVERTER,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif(oldcb)\r\n*oldcb = dso->name_converter;\r\ndso->name_converter = cb;\r\nreturn(1);\r\n}\r\nconst char *DSO_get_filename(DSO *dso)\r\n{\r\nif(dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_GET_FILENAME,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(NULL);\r\n}\r\nreturn(dso->filename);\r\n}\r\nint DSO_set_filename(DSO *dso, const char *filename)\r\n{\r\nchar *copied;\r\nif((dso == NULL) || (filename == NULL))\r\n{\r\nDSOerr(DSO_F_DSO_SET_FILENAME,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nif(dso->loaded_filename)\r\n{\r\nDSOerr(DSO_F_DSO_SET_FILENAME,DSO_R_DSO_ALREADY_LOADED);\r\nreturn(0);\r\n}\r\ncopied = OPENSSL_malloc(strlen(filename) + 1);\r\nif(copied == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_SET_FILENAME,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nBUF_strlcpy(copied, filename, strlen(filename) + 1);\r\nif(dso->filename)\r\nOPENSSL_free(dso->filename);\r\ndso->filename = copied;\r\nreturn(1);\r\n}\r\nchar *DSO_merge(DSO *dso, const char *filespec1, const char *filespec2)\r\n{\r\nchar *result = NULL;\r\nif(dso == NULL || filespec1 == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_MERGE,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(NULL);\r\n}\r\nif((dso->flags & DSO_FLAG_NO_NAME_TRANSLATION) == 0)\r\n{\r\nif(dso->merger != NULL)\r\nresult = dso->merger(dso, filespec1, filespec2);\r\nelse if(dso->meth->dso_merger != NULL)\r\nresult = dso->meth->dso_merger(dso,\r\nfilespec1, filespec2);\r\n}\r\nreturn(result);\r\n}\r\nchar *DSO_convert_filename(DSO *dso, const char *filename)\r\n{\r\nchar *result = NULL;\r\nif(dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_CONVERT_FILENAME,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(NULL);\r\n}\r\nif(filename == NULL)\r\nfilename = dso->filename;\r\nif(filename == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_CONVERT_FILENAME,DSO_R_NO_FILENAME);\r\nreturn(NULL);\r\n}\r\nif((dso->flags & DSO_FLAG_NO_NAME_TRANSLATION) == 0)\r\n{\r\nif(dso->name_converter != NULL)\r\nresult = dso->name_converter(dso, filename);\r\nelse if(dso->meth->dso_name_converter != NULL)\r\nresult = dso->meth->dso_name_converter(dso, filename);\r\n}\r\nif(result == NULL)\r\n{\r\nresult = OPENSSL_malloc(strlen(filename) + 1);\r\nif(result == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_CONVERT_FILENAME,\r\nERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nBUF_strlcpy(result, filename, strlen(filename) + 1);\r\n}\r\nreturn(result);\r\n}\r\nconst char *DSO_get_loaded_filename(DSO *dso)\r\n{\r\nif(dso == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_GET_LOADED_FILENAME,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn(NULL);\r\n}\r\nreturn(dso->loaded_filename);\r\n}\r\nint DSO_pathbyaddr(void *addr,char *path,int sz)\r\n{\r\nDSO_METHOD *meth = default_DSO_meth;\r\nif (meth == NULL) meth = DSO_METHOD_openssl();\r\nif (meth->pathbyaddr == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_PATHBYADDR,DSO_R_UNSUPPORTED);\r\nreturn -1;\r\n}\r\nreturn (*meth->pathbyaddr)(addr,path,sz);\r\n}\r\nvoid *DSO_global_lookup(const char *name)\r\n{\r\nDSO_METHOD *meth = default_DSO_meth;\r\nif (meth == NULL) meth = DSO_METHOD_openssl();\r\nif (meth->globallookup == NULL)\r\n{\r\nDSOerr(DSO_F_DSO_GLOBAL_LOOKUP,DSO_R_UNSUPPORTED);\r\nreturn NULL;\r\n}\r\nreturn (*meth->globallookup)(name);\r\n}

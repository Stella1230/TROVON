int MAIN(int argc, char **argv)\r\n{\r\nunsigned long nmflag = 0;\r\nX509_CRL *x=NULL;\r\nchar *CAfile = NULL, *CApath = NULL;\r\nint ret=1,i,num,badops=0;\r\nBIO *out=NULL;\r\nint informat,outformat;\r\nchar *infile=NULL,*outfile=NULL;\r\nint hash=0,issuer=0,lastupdate=0,nextupdate=0,noout=0,text=0;\r\nint fingerprint = 0, crlnumber = 0;\r\nconst char **pp;\r\nX509_STORE *store = NULL;\r\nX509_STORE_CTX ctx;\r\nX509_LOOKUP *lookup = NULL;\r\nX509_OBJECT xobj;\r\nEVP_PKEY *pkey;\r\nint do_ver = 0;\r\nconst EVP_MD *md_alg,*digest=EVP_sha1();\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE|BIO_FP_TEXT);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\nif (bio_out == NULL)\r\nif ((bio_out=BIO_new(BIO_s_file())) != NULL)\r\n{\r\nBIO_set_fp(bio_out,stdout,BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nbio_out = BIO_push(tmpbio, bio_out);\r\n}\r\n#endif\r\n}\r\ninformat=FORMAT_PEM;\r\noutformat=FORMAT_PEM;\r\nargc--;\r\nargv++;\r\nnum=0;\r\nwhile (argc >= 1)\r\n{\r\n#ifdef undef\r\nif (strcmp(*argv,"-p") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nif (!args_from_file(++argv,Nargc,Nargv)) { goto end; }*/\r\n}\r\n#endif\r\nif (strcmp(*argv,"-inform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-outform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-CApath") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nCApath = *(++argv);\r\ndo_ver = 1;\r\n}\r\nelse if (strcmp(*argv,"-CAfile") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nCAfile = *(++argv);\r\ndo_ver = 1;\r\n}\r\nelse if (strcmp(*argv,"-verify") == 0)\r\ndo_ver = 1;\r\nelse if (strcmp(*argv,"-text") == 0)\r\ntext = 1;\r\nelse if (strcmp(*argv,"-hash") == 0)\r\nhash= ++num;\r\nelse if (strcmp(*argv,"-nameopt") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nif (!set_name_ex(&nmflag, *(++argv))) goto bad;\r\n}\r\nelse if (strcmp(*argv,"-issuer") == 0)\r\nissuer= ++num;\r\nelse if (strcmp(*argv,"-lastupdate") == 0)\r\nlastupdate= ++num;\r\nelse if (strcmp(*argv,"-nextupdate") == 0)\r\nnextupdate= ++num;\r\nelse if (strcmp(*argv,"-noout") == 0)\r\nnoout= ++num;\r\nelse if (strcmp(*argv,"-fingerprint") == 0)\r\nfingerprint= ++num;\r\nelse if (strcmp(*argv,"-crlnumber") == 0)\r\ncrlnumber= ++num;\r\nelse if ((md_alg=EVP_get_digestbyname(*argv + 1)))\r\n{\r\ndigest=md_alg;\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_err,"unknown option %s\n",*argv);\r\nbadops=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nfor (pp=crl_usage; (*pp != NULL); pp++)\r\nBIO_printf(bio_err,"%s",*pp);\r\ngoto end;\r\n}\r\nERR_load_crypto_strings();\r\nx=load_crl(infile,informat);\r\nif (x == NULL) { goto end; }\r\nif(do_ver) {\r\nstore = X509_STORE_new();\r\nlookup=X509_STORE_add_lookup(store,X509_LOOKUP_file());\r\nif (lookup == NULL) goto end;\r\nif (!X509_LOOKUP_load_file(lookup,CAfile,X509_FILETYPE_PEM))\r\nX509_LOOKUP_load_file(lookup,NULL,X509_FILETYPE_DEFAULT);\r\nlookup=X509_STORE_add_lookup(store,X509_LOOKUP_hash_dir());\r\nif (lookup == NULL) goto end;\r\nif (!X509_LOOKUP_add_dir(lookup,CApath,X509_FILETYPE_PEM))\r\nX509_LOOKUP_add_dir(lookup,NULL,X509_FILETYPE_DEFAULT);\r\nERR_clear_error();\r\nif(!X509_STORE_CTX_init(&ctx, store, NULL, NULL)) {\r\nBIO_printf(bio_err,\r\n"Error initialising X509 store\n");\r\ngoto end;\r\n}\r\ni = X509_STORE_get_by_subject(&ctx, X509_LU_X509,\r\nX509_CRL_get_issuer(x), &xobj);\r\nif(i <= 0) {\r\nBIO_printf(bio_err,\r\n"Error getting CRL issuer certificate\n");\r\ngoto end;\r\n}\r\npkey = X509_get_pubkey(xobj.data.x509);\r\nX509_OBJECT_free_contents(&xobj);\r\nif(!pkey) {\r\nBIO_printf(bio_err,\r\n"Error getting CRL issuer public key\n");\r\ngoto end;\r\n}\r\ni = X509_CRL_verify(x, pkey);\r\nEVP_PKEY_free(pkey);\r\nif(i < 0) goto end;\r\nif(i == 0) BIO_printf(bio_err, "verify failure\n");\r\nelse BIO_printf(bio_err, "verify OK\n");\r\n}\r\nif (num)\r\n{\r\nfor (i=1; i<=num; i++)\r\n{\r\nif (issuer == i)\r\n{\r\nprint_name(bio_out, "issuer=", X509_CRL_get_issuer(x), nmflag);\r\n}\r\nif (crlnumber == i)\r\n{\r\nASN1_INTEGER *crlnum;\r\ncrlnum = X509_CRL_get_ext_d2i(x, NID_crl_number,\r\nNULL, NULL);\r\nBIO_printf(bio_out,"crlNumber=");\r\nif (crlnum)\r\n{\r\ni2a_ASN1_INTEGER(bio_out, crlnum);\r\nASN1_INTEGER_free(crlnum);\r\n}\r\nelse\r\nBIO_puts(bio_out, "<NONE>");\r\nBIO_printf(bio_out,"\n");\r\n}\r\nif (hash == i)\r\n{\r\nBIO_printf(bio_out,"%08lx\n",\r\nX509_NAME_hash(X509_CRL_get_issuer(x)));\r\n}\r\nif (lastupdate == i)\r\n{\r\nBIO_printf(bio_out,"lastUpdate=");\r\nASN1_TIME_print(bio_out,\r\nX509_CRL_get_lastUpdate(x));\r\nBIO_printf(bio_out,"\n");\r\n}\r\nif (nextupdate == i)\r\n{\r\nBIO_printf(bio_out,"nextUpdate=");\r\nif (X509_CRL_get_nextUpdate(x))\r\nASN1_TIME_print(bio_out,\r\nX509_CRL_get_nextUpdate(x));\r\nelse\r\nBIO_printf(bio_out,"NONE");\r\nBIO_printf(bio_out,"\n");\r\n}\r\nif (fingerprint == i)\r\n{\r\nint j;\r\nunsigned int n;\r\nunsigned char md[EVP_MAX_MD_SIZE];\r\nif (!X509_CRL_digest(x,digest,md,&n))\r\n{\r\nBIO_printf(bio_err,"out of memory\n");\r\ngoto end;\r\n}\r\nBIO_printf(bio_out,"%s Fingerprint=",\r\nOBJ_nid2sn(EVP_MD_type(digest)));\r\nfor (j=0; j<(int)n; j++)\r\n{\r\nBIO_printf(bio_out,"%02X%c",md[j],\r\n(j+1 == (int)n)\r\n?'\n':':');\r\n}\r\n}\r\n}\r\n}\r\nout=BIO_new(BIO_s_file());\r\nif (out == NULL)\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (outfile == NULL)\r\n{\r\nBIO_set_fp(out,stdout,BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nelse\r\n{\r\nif (BIO_write_filename(out,outfile) <= 0)\r\n{\r\nperror(outfile);\r\ngoto end;\r\n}\r\n}\r\nif (text) X509_CRL_print(out, x);\r\nif (noout)\r\n{\r\nret = 0;\r\ngoto end;\r\n}\r\nif (outformat == FORMAT_ASN1)\r\ni=(int)i2d_X509_CRL_bio(out,x);\r\nelse if (outformat == FORMAT_PEM)\r\ni=PEM_write_bio_X509_CRL(out,x);\r\nelse\r\n{\r\nBIO_printf(bio_err,"bad output format specified for outfile\n");\r\ngoto end;\r\n}\r\nif (!i) { BIO_printf(bio_err,"unable to write CRL\n"); goto end; }\r\nret=0;\r\nend:\r\nBIO_free_all(out);\r\nBIO_free_all(bio_out);\r\nbio_out=NULL;\r\nX509_CRL_free(x);\r\nif(store) {\r\nX509_STORE_CTX_cleanup(&ctx);\r\nX509_STORE_free(store);\r\n}\r\napps_shutdown();\r\nOPENSSL_EXIT(ret);\r\n}\r\nstatic X509_CRL *load_crl(char *infile, int format)\r\n{\r\nX509_CRL *x=NULL;\r\nBIO *in=NULL;\r\nin=BIO_new(BIO_s_file());\r\nif (in == NULL)\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (infile == NULL)\r\nBIO_set_fp(in,stdin,BIO_NOCLOSE);\r\nelse\r\n{\r\nif (BIO_read_filename(in,infile) <= 0)\r\n{\r\nperror(infile);\r\ngoto end;\r\n}\r\n}\r\nif (format == FORMAT_ASN1)\r\nx=d2i_X509_CRL_bio(in,NULL);\r\nelse if (format == FORMAT_PEM)\r\nx=PEM_read_bio_X509_CRL(in,NULL,NULL,NULL);\r\nelse {\r\nBIO_printf(bio_err,"bad input format specified for input crl\n");\r\ngoto end;\r\n}\r\nif (x == NULL)\r\n{\r\nBIO_printf(bio_err,"unable to load CRL\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nend:\r\nBIO_free(in);\r\nreturn(x);\r\n}

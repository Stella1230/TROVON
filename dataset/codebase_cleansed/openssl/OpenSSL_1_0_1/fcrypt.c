char *DES_crypt(const char *buf, const char *salt)\r\n{\r\nstatic char buff[14];\r\n#ifndef CHARSET_EBCDIC\r\nreturn(DES_fcrypt(buf,salt,buff));\r\n#else\r\nchar e_salt[2+1];\r\nchar e_buf[32+1];\r\nchar *ret;\r\nif ((e_salt[0] = salt[0]) != '\0')\r\ne_salt[1] = salt[1];\r\nstrncpy (e_buf, buf, sizeof(e_buf));\r\ne_salt[sizeof(e_salt)-1] = e_buf[sizeof(e_buf)-1] = '\0';\r\nebcdic2ascii(e_salt, e_salt, sizeof e_salt);\r\nebcdic2ascii(e_buf, e_buf, sizeof e_buf);\r\nret = DES_fcrypt(e_buf,e_salt,buff);\r\nascii2ebcdic(ret, ret, strlen(ret));\r\nreturn ret;\r\n#endif\r\n}\r\nchar *DES_fcrypt(const char *buf, const char *salt, char *ret)\r\n{\r\nunsigned int i,j,x,y;\r\nDES_LONG Eswap0,Eswap1;\r\nDES_LONG out[2],ll;\r\nDES_cblock key;\r\nDES_key_schedule ks;\r\nunsigned char bb[9];\r\nunsigned char *b=bb;\r\nunsigned char c,u;\r\n#ifndef CHARSET_EBCDIC\r\nx=ret[0]=((salt[0] == '\0')?'A':salt[0]);\r\nEswap0=con_salt[x]<<2;\r\nx=ret[1]=((salt[1] == '\0')?'A':salt[1]);\r\nEswap1=con_salt[x]<<6;\r\n#else\r\nx=ret[0]=((salt[0] == '\0')?os_toascii['A']:salt[0]);\r\nEswap0=con_salt[x]<<2;\r\nx=ret[1]=((salt[1] == '\0')?os_toascii['A']:salt[1]);\r\nEswap1=con_salt[x]<<6;\r\n#endif\r\nfor (i=0; i<8; i++)\r\n{\r\nc= *(buf++);\r\nif (!c) break;\r\nkey[i]=(c<<1);\r\n}\r\nfor (; i<8; i++)\r\nkey[i]=0;\r\nDES_set_key_unchecked(&key,&ks);\r\nfcrypt_body(&(out[0]),&ks,Eswap0,Eswap1);\r\nll=out[0]; l2c(ll,b);\r\nll=out[1]; l2c(ll,b);\r\ny=0;\r\nu=0x80;\r\nbb[8]=0;\r\nfor (i=2; i<13; i++)\r\n{\r\nc=0;\r\nfor (j=0; j<6; j++)\r\n{\r\nc<<=1;\r\nif (bb[y] & u) c|=1;\r\nu>>=1;\r\nif (!u)\r\n{\r\ny++;\r\nu=0x80;\r\n}\r\n}\r\nret[i]=cov_2char[c];\r\n}\r\nret[13]='\0';\r\nreturn(ret);\r\n}

EVP_PKEY *d2i_PublicKey(int type, EVP_PKEY **a, const unsigned char **pp,\r\nlong length)\r\n{\r\nEVP_PKEY *ret;\r\nif ((a == NULL) || (*a == NULL))\r\n{\r\nif ((ret=EVP_PKEY_new()) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_PUBLICKEY,ERR_R_EVP_LIB);\r\nreturn(NULL);\r\n}\r\n}\r\nelse ret= *a;\r\nif (!EVP_PKEY_set_type(ret, type))\r\n{\r\nASN1err(ASN1_F_D2I_PUBLICKEY,ERR_R_EVP_LIB);\r\ngoto err;\r\n}\r\nswitch (EVP_PKEY_id(ret))\r\n{\r\n#ifndef OPENSSL_NO_RSA\r\ncase EVP_PKEY_RSA:\r\nif ((ret->pkey.rsa=d2i_RSAPublicKey(NULL,\r\n(const unsigned char **)pp,length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_PUBLICKEY,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\ncase EVP_PKEY_DSA:\r\nif (!d2i_DSAPublicKey(&(ret->pkey.dsa),\r\n(const unsigned char **)pp,length))\r\n{\r\nASN1err(ASN1_F_D2I_PUBLICKEY,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\n#ifndef OPENSSL_NO_EC\r\ncase EVP_PKEY_EC:\r\nif (!o2i_ECPublicKey(&(ret->pkey.ec),\r\n(const unsigned char **)pp, length))\r\n{\r\nASN1err(ASN1_F_D2I_PUBLICKEY, ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\ndefault:\r\nASN1err(ASN1_F_D2I_PUBLICKEY,ASN1_R_UNKNOWN_PUBLIC_KEY_TYPE);\r\ngoto err;\r\n}\r\nif (a != NULL) (*a)=ret;\r\nreturn(ret);\r\nerr:\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret))) EVP_PKEY_free(ret);\r\nreturn(NULL);\r\n}

int RSA_padding_add_X931(unsigned char *to, int tlen,\r\nconst unsigned char *from, int flen)\r\n{\r\nint j;\r\nunsigned char *p;\r\nj = tlen - flen - 2;\r\nif (j < 0)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_ADD_X931,RSA_R_DATA_TOO_LARGE_FOR_KEY_SIZE);\r\nreturn -1;\r\n}\r\np=(unsigned char *)to;\r\nif (j == 0)\r\n*p++ = 0x6A;\r\nelse\r\n{\r\n*p++ = 0x6B;\r\nif (j > 1)\r\n{\r\nmemset(p, 0xBB, j - 1);\r\np += j - 1;\r\n}\r\n*p++ = 0xBA;\r\n}\r\nmemcpy(p,from,(unsigned int)flen);\r\np += flen;\r\n*p = 0xCC;\r\nreturn(1);\r\n}\r\nint RSA_padding_check_X931(unsigned char *to, int tlen,\r\nconst unsigned char *from, int flen, int num)\r\n{\r\nint i = 0,j;\r\nconst unsigned char *p;\r\np=from;\r\nif ((num != flen) || ((*p != 0x6A) && (*p != 0x6B)))\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_X931,RSA_R_INVALID_HEADER);\r\nreturn -1;\r\n}\r\nif (*p++ == 0x6B)\r\n{\r\nj=flen-3;\r\nfor (i = 0; i < j; i++)\r\n{\r\nunsigned char c = *p++;\r\nif (c == 0xBA)\r\nbreak;\r\nif (c != 0xBB)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_X931,\r\nRSA_R_INVALID_PADDING);\r\nreturn -1;\r\n}\r\n}\r\nj -= i;\r\nif (i == 0)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_X931, RSA_R_INVALID_PADDING);\r\nreturn -1;\r\n}\r\n}\r\nelse j = flen - 2;\r\nif (p[j] != 0xCC)\r\n{\r\nRSAerr(RSA_F_RSA_PADDING_CHECK_X931, RSA_R_INVALID_TRAILER);\r\nreturn -1;\r\n}\r\nmemcpy(to,p,(unsigned int)j);\r\nreturn(j);\r\n}\r\nint RSA_X931_hash_id(int nid)\r\n{\r\nswitch (nid)\r\n{\r\ncase NID_sha1:\r\nreturn 0x33;\r\ncase NID_sha256:\r\nreturn 0x34;\r\ncase NID_sha384:\r\nreturn 0x36;\r\ncase NID_sha512:\r\nreturn 0x35;\r\n}\r\nreturn -1;\r\n}

int fill_GOST2001_params(EC_KEY *eckey, int nid)\r\n{\r\nR3410_2001_params *params = R3410_2001_paramset;\r\nEC_GROUP *grp=NULL;\r\nBIGNUM *p=NULL,*q=NULL,*a=NULL,*b=NULL,*x=NULL,*y=NULL;\r\nEC_POINT *P=NULL;\r\nBN_CTX *ctx=BN_CTX_new();\r\nint ok=0;\r\nBN_CTX_start(ctx);\r\np=BN_CTX_get(ctx);\r\na=BN_CTX_get(ctx);\r\nb=BN_CTX_get(ctx);\r\nx=BN_CTX_get(ctx);\r\ny=BN_CTX_get(ctx);\r\nq=BN_CTX_get(ctx);\r\nwhile (params->nid!=NID_undef && params->nid != nid) params++;\r\nif (params->nid == NID_undef)\r\n{\r\nGOSTerr(GOST_F_FILL_GOST2001_PARAMS,GOST_R_UNSUPPORTED_PARAMETER_SET);\r\ngoto err;\r\n}\r\nBN_hex2bn(&p,params->p);\r\nBN_hex2bn(&a,params->a);\r\nBN_hex2bn(&b,params->b);\r\ngrp = EC_GROUP_new_curve_GFp(p,a,b,ctx);\r\nP = EC_POINT_new(grp);\r\nBN_hex2bn(&x,params->x);\r\nBN_hex2bn(&y,params->y);\r\nEC_POINT_set_affine_coordinates_GFp(grp,P,x,y,ctx);\r\nBN_hex2bn(&q,params->q);\r\n#ifdef DEBUG_KEYS\r\nfprintf(stderr,"Set params index %d oid %s\nq=",\r\n(params-R3410_2001_paramset),OBJ_nid2sn(params->nid));\r\nBN_print_fp(stderr,q);\r\nfprintf(stderr,"\n");\r\n#endif\r\nEC_GROUP_set_generator(grp,P,q,NULL);\r\nEC_GROUP_set_curve_name(grp,params->nid);\r\nEC_KEY_set_group(eckey,grp);\r\nok=1;\r\nerr:\r\nEC_POINT_free(P);\r\nEC_GROUP_free(grp);\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\nreturn ok;\r\n}\r\nDSA_SIG *gost2001_do_sign(const unsigned char *dgst,int dlen, EC_KEY *eckey)\r\n{\r\nDSA_SIG *newsig = NULL;\r\nBIGNUM *md = hashsum2bn(dgst);\r\nBIGNUM *order = NULL;\r\nconst EC_GROUP *group;\r\nconst BIGNUM *priv_key;\r\nBIGNUM *r=NULL,*s=NULL,*X=NULL,*tmp=NULL,*tmp2=NULL, *k=NULL,*e=NULL;\r\nEC_POINT *C=NULL;\r\nBN_CTX *ctx = BN_CTX_new();\r\nBN_CTX_start(ctx);\r\nOPENSSL_assert(dlen==32);\r\nnewsig=DSA_SIG_new();\r\nif (!newsig)\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_SIGN,GOST_R_NO_MEMORY);\r\ngoto err;\r\n}\r\ngroup = EC_KEY_get0_group(eckey);\r\norder=BN_CTX_get(ctx);\r\nEC_GROUP_get_order(group,order,ctx);\r\npriv_key = EC_KEY_get0_private_key(eckey);\r\ne = BN_CTX_get(ctx);\r\nBN_mod(e,md,order,ctx);\r\n#ifdef DEBUG_SIGN\r\nfprintf(stderr,"digest as bignum=");\r\nBN_print_fp(stderr,md);\r\nfprintf(stderr,"\ndigest mod q=");\r\nBN_print_fp(stderr,e);\r\nfprintf(stderr,"\n");\r\n#endif\r\nif (BN_is_zero(e))\r\n{\r\nBN_one(e);\r\n}\r\nk =BN_CTX_get(ctx);\r\nC=EC_POINT_new(group);\r\ndo\r\n{\r\ndo\r\n{\r\nif (!BN_rand_range(k,order))\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_SIGN,GOST_R_RANDOM_NUMBER_GENERATOR_FAILED);\r\nDSA_SIG_free(newsig);\r\nnewsig = NULL;\r\ngoto err;\r\n}\r\nif (!EC_POINT_mul(group,C,k,NULL,NULL,ctx))\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_SIGN,ERR_R_EC_LIB);\r\nDSA_SIG_free(newsig);\r\nnewsig = NULL;\r\ngoto err;\r\n}\r\nif (!X) X=BN_CTX_get(ctx);\r\nif (!EC_POINT_get_affine_coordinates_GFp(group,C,X,NULL,ctx))\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_SIGN,ERR_R_EC_LIB);\r\nDSA_SIG_free(newsig);\r\nnewsig = NULL;\r\ngoto err;\r\n}\r\nif (!r) r=BN_CTX_get(ctx);\r\nBN_nnmod(r,X,order,ctx);\r\n}\r\nwhile (BN_is_zero(r));\r\nif (!tmp) tmp = BN_CTX_get(ctx);\r\nBN_mod_mul(tmp,priv_key,r,order,ctx);\r\nif (!tmp2) tmp2 = BN_CTX_get(ctx);\r\nBN_mod_mul(tmp2,k,e,order,ctx);\r\nif (!s) s=BN_CTX_get(ctx);\r\nBN_mod_add(s,tmp,tmp2,order,ctx);\r\n}\r\nwhile (BN_is_zero(s));\r\nnewsig->s=BN_dup(s);\r\nnewsig->r=BN_dup(r);\r\nerr:\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\nEC_POINT_free(C);\r\nBN_free(md);\r\nreturn newsig;\r\n}\r\nint gost2001_do_verify(const unsigned char *dgst,int dgst_len,\r\nDSA_SIG *sig, EC_KEY *ec)\r\n{\r\nBN_CTX *ctx=BN_CTX_new();\r\nconst EC_GROUP *group = EC_KEY_get0_group(ec);\r\nBIGNUM *order;\r\nBIGNUM *md = NULL,*e=NULL,*R=NULL,*v=NULL,*z1=NULL,*z2=NULL;\r\nBIGNUM *X=NULL,*tmp=NULL;\r\nEC_POINT *C = NULL;\r\nconst EC_POINT *pub_key=NULL;\r\nint ok=0;\r\nBN_CTX_start(ctx);\r\norder = BN_CTX_get(ctx);\r\ne = BN_CTX_get(ctx);\r\nz1 = BN_CTX_get(ctx);\r\nz2 = BN_CTX_get(ctx);\r\ntmp = BN_CTX_get(ctx);\r\nX= BN_CTX_get(ctx);\r\nR=BN_CTX_get(ctx);\r\nv=BN_CTX_get(ctx);\r\nEC_GROUP_get_order(group,order,ctx);\r\npub_key = EC_KEY_get0_public_key(ec);\r\nif (BN_is_zero(sig->s) || BN_is_zero(sig->r) ||\r\n(BN_cmp(sig->s,order)>=1) || (BN_cmp(sig->r,order)>=1))\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_VERIFY,GOST_R_SIGNATURE_PARTS_GREATER_THAN_Q);\r\ngoto err;\r\n}\r\nmd = hashsum2bn(dgst);\r\nBN_mod(e,md,order,ctx);\r\n#ifdef DEBUG_SIGN\r\nfprintf(stderr,"digest as bignum: ");\r\nBN_print_fp(stderr,md);\r\nfprintf(stderr,"\ndigest mod q: ");\r\nBN_print_fp(stderr,e);\r\n#endif\r\nif (BN_is_zero(e)) BN_one(e);\r\nv=BN_mod_inverse(v,e,order,ctx);\r\nBN_mod_mul(z1,sig->s,v,order,ctx);\r\nBN_sub(tmp,order,sig->r);\r\nBN_mod_mul(z2,tmp,v,order,ctx);\r\n#ifdef DEBUG_SIGN\r\nfprintf(stderr,"\nInverted digest value: ");\r\nBN_print_fp(stderr,v);\r\nfprintf(stderr,"\nz1: ");\r\nBN_print_fp(stderr,z1);\r\nfprintf(stderr,"\nz2: ");\r\nBN_print_fp(stderr,z2);\r\n#endif\r\nC = EC_POINT_new(group);\r\nif (!EC_POINT_mul(group,C,z1,pub_key,z2,ctx))\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_VERIFY,ERR_R_EC_LIB);\r\ngoto err;\r\n}\r\nif (!EC_POINT_get_affine_coordinates_GFp(group,C,X,NULL,ctx))\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_VERIFY,ERR_R_EC_LIB);\r\ngoto err;\r\n}\r\nBN_mod(R,X,order,ctx);\r\n#ifdef DEBUG_SIGN\r\nfprintf(stderr,"\nX=");\r\nBN_print_fp(stderr,X);\r\nfprintf(stderr,"\nX mod q=");\r\nBN_print_fp(stderr,R);\r\nfprintf(stderr,"\n");\r\n#endif\r\nif (BN_cmp(R,sig->r)!=0)\r\n{\r\nGOSTerr(GOST_F_GOST2001_DO_VERIFY,GOST_R_SIGNATURE_MISMATCH);\r\n}\r\nelse\r\n{\r\nok = 1;\r\n}\r\nerr:\r\nEC_POINT_free(C);\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\nBN_free(md);\r\nreturn ok;\r\n}\r\nint gost2001_compute_public(EC_KEY *ec)\r\n{\r\nconst EC_GROUP *group = EC_KEY_get0_group(ec);\r\nEC_POINT *pub_key=NULL;\r\nconst BIGNUM *priv_key=NULL;\r\nBN_CTX *ctx=NULL;\r\nint ok=0;\r\nif (!group)\r\n{\r\nGOSTerr(GOST_F_GOST2001_COMPUTE_PUBLIC,GOST_R_KEY_IS_NOT_INITIALIZED);\r\nreturn 0;\r\n}\r\nctx=BN_CTX_new();\r\nBN_CTX_start(ctx);\r\nif (!(priv_key=EC_KEY_get0_private_key(ec)))\r\n{\r\nGOSTerr(GOST_F_GOST2001_COMPUTE_PUBLIC,ERR_R_EC_LIB);\r\ngoto err;\r\n}\r\npub_key = EC_POINT_new(group);\r\nif (!EC_POINT_mul(group,pub_key,priv_key,NULL,NULL,ctx))\r\n{\r\nGOSTerr(GOST_F_GOST2001_COMPUTE_PUBLIC,ERR_R_EC_LIB);\r\ngoto err;\r\n}\r\nif (!EC_KEY_set_public_key(ec,pub_key))\r\n{\r\nGOSTerr(GOST_F_GOST2001_COMPUTE_PUBLIC,ERR_R_EC_LIB);\r\ngoto err;\r\n}\r\nok = 256;\r\nerr:\r\nBN_CTX_end(ctx);\r\nEC_POINT_free(pub_key);\r\nBN_CTX_free(ctx);\r\nreturn ok;\r\n}\r\nint gost2001_keygen(EC_KEY *ec)\r\n{\r\nBIGNUM *order = BN_new(),*d=BN_new();\r\nconst EC_GROUP *group = EC_KEY_get0_group(ec);\r\nEC_GROUP_get_order(group,order,NULL);\r\ndo\r\n{\r\nif (!BN_rand_range(d,order))\r\n{\r\nGOSTerr(GOST_F_GOST2001_KEYGEN,GOST_R_RANDOM_NUMBER_GENERATOR_FAILED);\r\nBN_free(d);\r\nBN_free(order);\r\nreturn 0;\r\n}\r\n}\r\nwhile (BN_is_zero(d));\r\nEC_KEY_set_private_key(ec,d);\r\nBN_free(d);\r\nBN_free(order);\r\nreturn gost2001_compute_public(ec);\r\n}

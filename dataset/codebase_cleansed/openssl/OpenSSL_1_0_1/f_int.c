int i2a_ASN1_INTEGER(BIO *bp, ASN1_INTEGER *a)\r\n{\r\nint i,n=0;\r\nstatic const char *h="0123456789ABCDEF";\r\nchar buf[2];\r\nif (a == NULL) return(0);\r\nif (a->type & V_ASN1_NEG)\r\n{\r\nif (BIO_write(bp, "-", 1) != 1) goto err;\r\nn = 1;\r\n}\r\nif (a->length == 0)\r\n{\r\nif (BIO_write(bp,"00",2) != 2) goto err;\r\nn += 2;\r\n}\r\nelse\r\n{\r\nfor (i=0; i<a->length; i++)\r\n{\r\nif ((i != 0) && (i%35 == 0))\r\n{\r\nif (BIO_write(bp,"\\\n",2) != 2) goto err;\r\nn+=2;\r\n}\r\nbuf[0]=h[((unsigned char)a->data[i]>>4)&0x0f];\r\nbuf[1]=h[((unsigned char)a->data[i] )&0x0f];\r\nif (BIO_write(bp,buf,2) != 2) goto err;\r\nn+=2;\r\n}\r\n}\r\nreturn(n);\r\nerr:\r\nreturn(-1);\r\n}\r\nint a2i_ASN1_INTEGER(BIO *bp, ASN1_INTEGER *bs, char *buf, int size)\r\n{\r\nint ret=0;\r\nint i,j,k,m,n,again,bufsize;\r\nunsigned char *s=NULL,*sp;\r\nunsigned char *bufp;\r\nint num=0,slen=0,first=1;\r\nbs->type=V_ASN1_INTEGER;\r\nbufsize=BIO_gets(bp,buf,size);\r\nfor (;;)\r\n{\r\nif (bufsize < 1) goto err_sl;\r\ni=bufsize;\r\nif (buf[i-1] == '\n') buf[--i]='\0';\r\nif (i == 0) goto err_sl;\r\nif (buf[i-1] == '\r') buf[--i]='\0';\r\nif (i == 0) goto err_sl;\r\nagain=(buf[i-1] == '\\');\r\nfor (j=0; j<i; j++)\r\n{\r\n#ifndef CHARSET_EBCDIC\r\nif (!( ((buf[j] >= '0') && (buf[j] <= '9')) ||\r\n((buf[j] >= 'a') && (buf[j] <= 'f')) ||\r\n((buf[j] >= 'A') && (buf[j] <= 'F'))))\r\n#else\r\nif (!isxdigit(buf[j]))\r\n#endif\r\n{\r\ni=j;\r\nbreak;\r\n}\r\n}\r\nbuf[i]='\0';\r\nif (i < 2) goto err_sl;\r\nbufp=(unsigned char *)buf;\r\nif (first)\r\n{\r\nfirst=0;\r\nif ((bufp[0] == '0') && (buf[1] == '0'))\r\n{\r\nbufp+=2;\r\ni-=2;\r\n}\r\n}\r\nk=0;\r\ni-=again;\r\nif (i%2 != 0)\r\n{\r\nASN1err(ASN1_F_A2I_ASN1_INTEGER,ASN1_R_ODD_NUMBER_OF_CHARS);\r\ngoto err;\r\n}\r\ni/=2;\r\nif (num+i > slen)\r\n{\r\nif (s == NULL)\r\nsp=(unsigned char *)OPENSSL_malloc(\r\n(unsigned int)num+i*2);\r\nelse\r\nsp=OPENSSL_realloc_clean(s,slen,num+i*2);\r\nif (sp == NULL)\r\n{\r\nASN1err(ASN1_F_A2I_ASN1_INTEGER,ERR_R_MALLOC_FAILURE);\r\nif (s != NULL) OPENSSL_free(s);\r\ngoto err;\r\n}\r\ns=sp;\r\nslen=num+i*2;\r\n}\r\nfor (j=0; j<i; j++,k+=2)\r\n{\r\nfor (n=0; n<2; n++)\r\n{\r\nm=bufp[k+n];\r\nif ((m >= '0') && (m <= '9'))\r\nm-='0';\r\nelse if ((m >= 'a') && (m <= 'f'))\r\nm=m-'a'+10;\r\nelse if ((m >= 'A') && (m <= 'F'))\r\nm=m-'A'+10;\r\nelse\r\n{\r\nASN1err(ASN1_F_A2I_ASN1_INTEGER,ASN1_R_NON_HEX_CHARACTERS);\r\ngoto err;\r\n}\r\ns[num+j]<<=4;\r\ns[num+j]|=m;\r\n}\r\n}\r\nnum+=i;\r\nif (again)\r\nbufsize=BIO_gets(bp,buf,size);\r\nelse\r\nbreak;\r\n}\r\nbs->length=num;\r\nbs->data=s;\r\nret=1;\r\nerr:\r\nif (0)\r\n{\r\nerr_sl:\r\nASN1err(ASN1_F_A2I_ASN1_INTEGER,ASN1_R_SHORT_LINE);\r\n}\r\nreturn(ret);\r\n}

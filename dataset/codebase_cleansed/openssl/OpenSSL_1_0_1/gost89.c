static void kboxinit(gost_ctx *c, const gost_subst_block *b)\r\n{\r\nint i;\r\nfor (i = 0; i < 256; i++)\r\n{\r\nc->k87[i] = (b->k8[i>>4] <<4 | b->k7 [i &15])<<24;\r\nc->k65[i] = (b->k6[i>>4] << 4 | b->k5 [i &15])<<16;\r\nc->k43[i] = (b->k4[i>>4] <<4 | b->k3 [i &15])<<8;\r\nc->k21[i] = b->k2[i>>4] <<4 | b->k1 [i &15];\r\n}\r\n}\r\nstatic word32 f(gost_ctx *c,word32 x)\r\n{\r\nx = c->k87[x>>24 & 255] | c->k65[x>>16 & 255]|\r\nc->k43[x>> 8 & 255] | c->k21[x & 255];\r\nreturn x<<11 | x>>(32-11);\r\n}\r\nvoid gostcrypt(gost_ctx *c, const byte *in, byte *out)\r\n{\r\nregister word32 n1, n2;\r\nn1 = in[0]|(in[1]<<8)|(in[2]<<16)|(in[3]<<24);\r\nn2 = in[4]|(in[5]<<8)|(in[6]<<16)|(in[7]<<24);\r\nn2 ^= f(c,n1+c->k[0]); n1 ^= f(c,n2+c->k[1]);\r\nn2 ^= f(c,n1+c->k[2]); n1 ^= f(c,n2+c->k[3]);\r\nn2 ^= f(c,n1+c->k[4]); n1 ^= f(c,n2+c->k[5]);\r\nn2 ^= f(c,n1+c->k[6]); n1 ^= f(c,n2+c->k[7]);\r\nn2 ^= f(c,n1+c->k[0]); n1 ^= f(c,n2+c->k[1]);\r\nn2 ^= f(c,n1+c->k[2]); n1 ^= f(c,n2+c->k[3]);\r\nn2 ^= f(c,n1+c->k[4]); n1 ^= f(c,n2+c->k[5]);\r\nn2 ^= f(c,n1+c->k[6]); n1 ^= f(c,n2+c->k[7]);\r\nn2 ^= f(c,n1+c->k[0]); n1 ^= f(c,n2+c->k[1]);\r\nn2 ^= f(c,n1+c->k[2]); n1 ^= f(c,n2+c->k[3]);\r\nn2 ^= f(c,n1+c->k[4]); n1 ^= f(c,n2+c->k[5]);\r\nn2 ^= f(c,n1+c->k[6]); n1 ^= f(c,n2+c->k[7]);\r\nn2 ^= f(c,n1+c->k[7]); n1 ^= f(c,n2+c->k[6]);\r\nn2 ^= f(c,n1+c->k[5]); n1 ^= f(c,n2+c->k[4]);\r\nn2 ^= f(c,n1+c->k[3]); n1 ^= f(c,n2+c->k[2]);\r\nn2 ^= f(c,n1+c->k[1]); n1 ^= f(c,n2+c->k[0]);\r\nout[0] = (byte)(n2&0xff); out[1] = (byte)((n2>>8)&0xff);\r\nout[2] = (byte)((n2>>16)&0xff); out[3]=(byte)(n2>>24);\r\nout[4] = (byte)(n1&0xff); out[5] = (byte)((n1>>8)&0xff);\r\nout[6] = (byte)((n1>>16)&0xff); out[7] = (byte)(n1>>24);\r\n}\r\nvoid gostdecrypt(gost_ctx *c, const byte *in,byte *out)\r\n{\r\nregister word32 n1, n2;\r\nn1 = in[0]|(in[1]<<8)|(in[2]<<16)|(in[3]<<24);\r\nn2 = in[4]|(in[5]<<8)|(in[6]<<16)|(in[7]<<24);\r\nn2 ^= f(c,n1+c->k[0]); n1 ^= f(c,n2+c->k[1]);\r\nn2 ^= f(c,n1+c->k[2]); n1 ^= f(c,n2+c->k[3]);\r\nn2 ^= f(c,n1+c->k[4]); n1 ^= f(c,n2+c->k[5]);\r\nn2 ^= f(c,n1+c->k[6]); n1 ^= f(c,n2+c->k[7]);\r\nn2 ^= f(c,n1+c->k[7]); n1 ^= f(c,n2+c->k[6]);\r\nn2 ^= f(c,n1+c->k[5]); n1 ^= f(c,n2+c->k[4]);\r\nn2 ^= f(c,n1+c->k[3]); n1 ^= f(c,n2+c->k[2]);\r\nn2 ^= f(c,n1+c->k[1]); n1 ^= f(c,n2+c->k[0]);\r\nn2 ^= f(c,n1+c->k[7]); n1 ^= f(c,n2+c->k[6]);\r\nn2 ^= f(c,n1+c->k[5]); n1 ^= f(c,n2+c->k[4]);\r\nn2 ^= f(c,n1+c->k[3]); n1 ^= f(c,n2+c->k[2]);\r\nn2 ^= f(c,n1+c->k[1]); n1 ^= f(c,n2+c->k[0]);\r\nn2 ^= f(c,n1+c->k[7]); n1 ^= f(c,n2+c->k[6]);\r\nn2 ^= f(c,n1+c->k[5]); n1 ^= f(c,n2+c->k[4]);\r\nn2 ^= f(c,n1+c->k[3]); n1 ^= f(c,n2+c->k[2]);\r\nn2 ^= f(c,n1+c->k[1]); n1 ^= f(c,n2+c->k[0]);\r\nout[0] = (byte)(n2&0xff); out[1] = (byte)((n2>>8)&0xff);\r\nout[2] = (byte)((n2>>16)&0xff); out[3]=(byte)(n2>>24);\r\nout[4] = (byte)(n1&0xff); out[5] = (byte)((n1>>8)&0xff);\r\nout[6] = (byte)((n1>>16)&0xff); out[7] = (byte)(n1>>24);\r\n}\r\nvoid gost_enc(gost_ctx *c,const byte *clear,byte *cipher, int blocks)\r\n{\r\nint i;\r\nfor(i=0;i<blocks;i++)\r\n{\r\ngostcrypt(c,clear,cipher);\r\nclear+=8;\r\ncipher+=8;\r\n}\r\n}\r\nvoid gost_dec(gost_ctx *c, const byte *cipher,byte *clear, int blocks)\r\n{\r\nint i;\r\nfor(i=0;i<blocks;i++)\r\n{\r\ngostdecrypt(c,cipher,clear);\r\nclear+=8;\r\ncipher+=8;\r\n}\r\n}\r\nvoid gost_enc_cfb(gost_ctx *ctx,const byte *iv,const byte *clear,byte *cipher, int blocks)\r\n{\r\nbyte cur_iv[8];\r\nbyte gamma[8];\r\nint i,j;\r\nconst byte *in;\r\nbyte *out;\r\nmemcpy(cur_iv,iv,8);\r\nfor(i=0,in=clear,out=cipher;i<blocks;i++,in+=8,out+=8)\r\n{\r\ngostcrypt(ctx,cur_iv,gamma);\r\nfor (j=0;j<8;j++)\r\n{\r\ncur_iv[j]=out[j]=in[j]^gamma[j];\r\n}\r\n}\r\n}\r\nvoid gost_dec_cfb(gost_ctx *ctx,const byte *iv,const byte *cipher,byte *clear, int blocks)\r\n{\r\nbyte cur_iv[8];\r\nbyte gamma[8];\r\nint i,j;\r\nconst byte *in;\r\nbyte *out;\r\nmemcpy(cur_iv,iv,8);\r\nfor(i=0,in=cipher,out=clear;i<blocks;i++,in+=8,out+=8)\r\n{\r\ngostcrypt(ctx,cur_iv,gamma);\r\nfor (j=0;j<8;j++)\r\n{\r\nout[j]=(cur_iv[j]=in[j])^gamma[j];\r\n}\r\n}\r\n}\r\nvoid gost_enc_with_key(gost_ctx *c,byte *key,byte *inblock,byte *outblock)\r\n{\r\ngost_key(c,key);\r\ngostcrypt(c,inblock,outblock);\r\n}\r\nvoid gost_key(gost_ctx *c, const byte *k)\r\n{\r\nint i,j;\r\nfor(i=0,j=0;i<8;i++,j+=4)\r\n{\r\nc->k[i]=k[j]|(k[j+1]<<8)|(k[j+2]<<16)|(k[j+3]<<24);\r\n}\r\n}\r\nvoid gost_get_key(gost_ctx *c, byte *k)\r\n{\r\nint i,j;\r\nfor(i=0,j=0;i<8;i++,j+=4)\r\n{\r\nk[j]=(byte)(c->k[i]& 0xFF);\r\nk[j+1]=(byte)((c->k[i]>>8 )&0xFF);\r\nk[j+2]=(byte)((c->k[i]>>16) &0xFF);\r\nk[j+3]=(byte)((c->k[i]>>24) &0xFF);\r\n}\r\n}\r\nvoid gost_init(gost_ctx *c, const gost_subst_block *b)\r\n{\r\nif(!b)\r\n{\r\nb=&GostR3411_94_TestParamSet;\r\n}\r\nkboxinit(c,b);\r\n}\r\nvoid gost_destroy(gost_ctx *c)\r\n{\r\nint i; for(i=0;i<8;i++) c->k[i]=0;\r\n}\r\nvoid mac_block(gost_ctx *c,byte *buffer,const byte *block)\r\n{\r\nregister word32 n1, n2;\r\nint i;\r\nfor (i=0; i<8; i++)\r\n{\r\nbuffer[i]^=block[i];\r\n}\r\nn1 = buffer[0]|(buffer[1]<<8)|(buffer[2]<<16)|(buffer[3]<<24);\r\nn2 = buffer[4]|(buffer[5]<<8)|(buffer[6]<<16)|(buffer[7]<<24);\r\nn2 ^= f(c,n1+c->k[0]); n1 ^= f(c,n2+c->k[1]);\r\nn2 ^= f(c,n1+c->k[2]); n1 ^= f(c,n2+c->k[3]);\r\nn2 ^= f(c,n1+c->k[4]); n1 ^= f(c,n2+c->k[5]);\r\nn2 ^= f(c,n1+c->k[6]); n1 ^= f(c,n2+c->k[7]);\r\nn2 ^= f(c,n1+c->k[0]); n1 ^= f(c,n2+c->k[1]);\r\nn2 ^= f(c,n1+c->k[2]); n1 ^= f(c,n2+c->k[3]);\r\nn2 ^= f(c,n1+c->k[4]); n1 ^= f(c,n2+c->k[5]);\r\nn2 ^= f(c,n1+c->k[6]); n1 ^= f(c,n2+c->k[7]);\r\nbuffer[0] = (byte)(n1&0xff); buffer[1] = (byte)((n1>>8)&0xff);\r\nbuffer[2] = (byte)((n1>>16)&0xff); buffer[3] = (byte)(n1>>24);\r\nbuffer[4] = (byte)(n2&0xff); buffer[5] = (byte)((n2>>8)&0xff);\r\nbuffer[6] = (byte)((n2>>16)&0xff); buffer[7] = (byte)(n2>>24);\r\n}\r\nvoid get_mac(byte *buffer,int nbits,byte *out)\r\n{\r\nint nbytes= nbits >> 3;\r\nint rembits = nbits & 7;\r\nint mask =rembits?((1<rembits)-1):0;\r\nint i;\r\nfor (i=0;i<nbytes;i++) out[i]=buffer[i];\r\nif (rembits) out[i]=buffer[i]&mask;\r\n}\r\nint gost_mac(gost_ctx *ctx,int mac_len,const unsigned char *data,\r\nunsigned int data_len,unsigned char *mac)\r\n{\r\nbyte buffer[8]={0,0,0,0,0,0,0,0};\r\nbyte buf2[8];\r\nunsigned int i;\r\nfor (i=0;i+8<=data_len;i+=8)\r\nmac_block(ctx,buffer,data+i);\r\nif (i<data_len)\r\n{\r\nmemset(buf2,0,8);\r\nmemcpy(buf2,data+i,data_len-i);\r\nmac_block(ctx,buffer,buf2);\r\n}\r\nget_mac(buffer,mac_len,mac);\r\nreturn 1;\r\n}\r\nint gost_mac_iv(gost_ctx *ctx,int mac_len,const unsigned char *iv,const unsigned char *data,\r\nunsigned int data_len,unsigned char *mac)\r\n{\r\nbyte buffer[8];\r\nbyte buf2[8];\r\nunsigned int i;\r\nmemcpy (buffer,iv,8);\r\nfor (i=0;i+8<=data_len;i+=8)\r\nmac_block(ctx,buffer,data+i);\r\nif (i<data_len)\r\n{\r\nmemset(buf2,0,8);\r\nmemcpy(buf2,data+i,data_len-i);\r\nmac_block(ctx,buffer,buf2);\r\n}\r\nget_mac(buffer,mac_len,mac);\r\nreturn 1;\r\n}\r\nvoid cryptopro_key_meshing(gost_ctx *ctx, unsigned char *iv)\r\n{\r\nunsigned char newkey[32],newiv[8];\r\ngost_dec(ctx,CryptoProKeyMeshingKey,newkey,4);\r\ngost_key(ctx,newkey);\r\ngostcrypt(ctx,iv,newiv);\r\nmemcpy(iv,newiv,8);\r\n}

static int bnrand(int pseudorand, BIGNUM *rnd, int bits, int top, int bottom)\r\n{\r\nunsigned char *buf=NULL;\r\nint ret=0,bit,bytes,mask;\r\ntime_t tim;\r\nif (bits == 0)\r\n{\r\nBN_zero(rnd);\r\nreturn 1;\r\n}\r\nbytes=(bits+7)/8;\r\nbit=(bits-1)%8;\r\nmask=0xff<<(bit+1);\r\nbuf=(unsigned char *)OPENSSL_malloc(bytes);\r\nif (buf == NULL)\r\n{\r\nBNerr(BN_F_BNRAND,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\ntime(&tim);\r\nRAND_add(&tim,sizeof(tim),0.0);\r\nif (pseudorand)\r\n{\r\nif (RAND_pseudo_bytes(buf, bytes) == -1)\r\ngoto err;\r\n}\r\nelse\r\n{\r\nif (RAND_bytes(buf, bytes) <= 0)\r\ngoto err;\r\n}\r\n#if 1\r\nif (pseudorand == 2)\r\n{\r\nint i;\r\nunsigned char c;\r\nfor (i = 0; i < bytes; i++)\r\n{\r\nRAND_pseudo_bytes(&c, 1);\r\nif (c >= 128 && i > 0)\r\nbuf[i] = buf[i-1];\r\nelse if (c < 42)\r\nbuf[i] = 0;\r\nelse if (c < 84)\r\nbuf[i] = 255;\r\n}\r\n}\r\n#endif\r\nif (top != -1)\r\n{\r\nif (top)\r\n{\r\nif (bit == 0)\r\n{\r\nbuf[0]=1;\r\nbuf[1]|=0x80;\r\n}\r\nelse\r\n{\r\nbuf[0]|=(3<<(bit-1));\r\n}\r\n}\r\nelse\r\n{\r\nbuf[0]|=(1<<bit);\r\n}\r\n}\r\nbuf[0] &= ~mask;\r\nif (bottom)\r\nbuf[bytes-1]|=1;\r\nif (!BN_bin2bn(buf,bytes,rnd)) goto err;\r\nret=1;\r\nerr:\r\nif (buf != NULL)\r\n{\r\nOPENSSL_cleanse(buf,bytes);\r\nOPENSSL_free(buf);\r\n}\r\nbn_check_top(rnd);\r\nreturn(ret);\r\n}\r\nint BN_rand(BIGNUM *rnd, int bits, int top, int bottom)\r\n{\r\nreturn bnrand(0, rnd, bits, top, bottom);\r\n}\r\nint BN_pseudo_rand(BIGNUM *rnd, int bits, int top, int bottom)\r\n{\r\nreturn bnrand(1, rnd, bits, top, bottom);\r\n}\r\nint BN_bntest_rand(BIGNUM *rnd, int bits, int top, int bottom)\r\n{\r\nreturn bnrand(2, rnd, bits, top, bottom);\r\n}\r\nstatic int bn_rand_range(int pseudo, BIGNUM *r, const BIGNUM *range)\r\n{\r\nint (*bn_rand)(BIGNUM *, int, int, int) = pseudo ? BN_pseudo_rand : BN_rand;\r\nint n;\r\nint count = 100;\r\nif (range->neg || BN_is_zero(range))\r\n{\r\nBNerr(BN_F_BN_RAND_RANGE, BN_R_INVALID_RANGE);\r\nreturn 0;\r\n}\r\nn = BN_num_bits(range);\r\nif (n == 1)\r\nBN_zero(r);\r\nelse if (!BN_is_bit_set(range, n - 2) && !BN_is_bit_set(range, n - 3))\r\n{\r\ndo\r\n{\r\nif (!bn_rand(r, n + 1, -1, 0)) return 0;\r\nif (BN_cmp(r ,range) >= 0)\r\n{\r\nif (!BN_sub(r, r, range)) return 0;\r\nif (BN_cmp(r, range) >= 0)\r\nif (!BN_sub(r, r, range)) return 0;\r\n}\r\nif (!--count)\r\n{\r\nBNerr(BN_F_BN_RAND_RANGE, BN_R_TOO_MANY_ITERATIONS);\r\nreturn 0;\r\n}\r\n}\r\nwhile (BN_cmp(r, range) >= 0);\r\n}\r\nelse\r\n{\r\ndo\r\n{\r\nif (!bn_rand(r, n, -1, 0)) return 0;\r\nif (!--count)\r\n{\r\nBNerr(BN_F_BN_RAND_RANGE, BN_R_TOO_MANY_ITERATIONS);\r\nreturn 0;\r\n}\r\n}\r\nwhile (BN_cmp(r, range) >= 0);\r\n}\r\nbn_check_top(r);\r\nreturn 1;\r\n}\r\nint BN_rand_range(BIGNUM *r, const BIGNUM *range)\r\n{\r\nreturn bn_rand_range(0, r, range);\r\n}\r\nint BN_pseudo_rand_range(BIGNUM *r, const BIGNUM *range)\r\n{\r\nreturn bn_rand_range(1, r, range);\r\n}

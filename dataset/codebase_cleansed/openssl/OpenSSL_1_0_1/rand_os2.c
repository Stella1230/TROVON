int RAND_poll(void)\r\n{\r\nchar failed_module[20];\r\nQWORD qwTime;\r\nULONG SysVars[QSV_FOREGROUND_PROCESS];\r\nif (hDoscalls == 0) {\r\nULONG rc = DosLoadModule(failed_module, sizeof(failed_module), "DOSCALLS", &hDoscalls);\r\n#ifndef __KLIBC__\r\nif (rc == 0) {\r\nrc = DosQueryProcAddr(hDoscalls, 976, NULL, (PFN *)&DosPerfSysCall);\r\nif (rc)\r\nDosPerfSysCall = NULL;\r\nrc = DosQueryProcAddr(hDoscalls, 368, NULL, (PFN *)&DosQuerySysState);\r\nif (rc)\r\nDosQuerySysState = NULL;\r\n}\r\n#endif\r\n}\r\nDosTmrQueryTime(&qwTime);\r\nRAND_add(&qwTime, sizeof(qwTime), 2);\r\nDosQuerySysInfo(1, QSV_FOREGROUND_PROCESS, SysVars, sizeof(SysVars));\r\nRAND_add(SysVars, sizeof(SysVars), 4);\r\nif (DosPerfSysCall) {\r\nCPUUTIL util;\r\nif (DosPerfSysCall(CMD_KI_RDCNT, (ULONG)&util, 0, 0) == 0) {\r\nRAND_add(&util, sizeof(util), 10);\r\n}\r\nelse {\r\n#ifndef __KLIBC__\r\nDosPerfSysCall = NULL;\r\n#endif\r\n}\r\n}\r\nif (DosQuerySysState) {\r\nchar *buffer = OPENSSL_malloc(256 * 1024);\r\nif (DosQuerySysState(0x1F, 0, 0, 0, buffer, 256 * 1024) == 0) {\r\nRAND_add(buffer, 256 * 1024, **(ULONG **)buffer);\r\n}\r\nOPENSSL_free(buffer);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

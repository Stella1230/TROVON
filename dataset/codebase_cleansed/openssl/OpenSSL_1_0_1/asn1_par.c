static int asn1_print_info(BIO *bp, int tag, int xclass, int constructed,\r\nint indent)\r\n{\r\nstatic const char fmt[]="%-18s";\r\nchar str[128];\r\nconst char *p;\r\nif (constructed & V_ASN1_CONSTRUCTED)\r\np="cons: ";\r\nelse\r\np="prim: ";\r\nif (BIO_write(bp,p,6) < 6) goto err;\r\nBIO_indent(bp,indent,128);\r\np=str;\r\nif ((xclass & V_ASN1_PRIVATE) == V_ASN1_PRIVATE)\r\nBIO_snprintf(str,sizeof str,"priv [ %d ] ",tag);\r\nelse if ((xclass & V_ASN1_CONTEXT_SPECIFIC) == V_ASN1_CONTEXT_SPECIFIC)\r\nBIO_snprintf(str,sizeof str,"cont [ %d ]",tag);\r\nelse if ((xclass & V_ASN1_APPLICATION) == V_ASN1_APPLICATION)\r\nBIO_snprintf(str,sizeof str,"appl [ %d ]",tag);\r\nelse if (tag > 30)\r\nBIO_snprintf(str,sizeof str,"<ASN1 %d>",tag);\r\nelse\r\np = ASN1_tag2str(tag);\r\nif (BIO_printf(bp,fmt,p) <= 0)\r\ngoto err;\r\nreturn(1);\r\nerr:\r\nreturn(0);\r\n}\r\nint ASN1_parse(BIO *bp, const unsigned char *pp, long len, int indent)\r\n{\r\nreturn(asn1_parse2(bp,&pp,len,0,0,indent,0));\r\n}\r\nint ASN1_parse_dump(BIO *bp, const unsigned char *pp, long len, int indent, int dump)\r\n{\r\nreturn(asn1_parse2(bp,&pp,len,0,0,indent,dump));\r\n}\r\nstatic int asn1_parse2(BIO *bp, const unsigned char **pp, long length, int offset,\r\nint depth, int indent, int dump)\r\n{\r\nconst unsigned char *p,*ep,*tot,*op,*opp;\r\nlong len;\r\nint tag,xclass,ret=0;\r\nint nl,hl,j,r;\r\nASN1_OBJECT *o=NULL;\r\nASN1_OCTET_STRING *os=NULL;\r\nint dump_indent;\r\n#if 0\r\ndump_indent = indent;\r\n#else\r\ndump_indent = 6;\r\n#endif\r\np= *pp;\r\ntot=p+length;\r\nop=p-1;\r\nwhile ((p < tot) && (op < p))\r\n{\r\nop=p;\r\nj=ASN1_get_object(&p,&len,&tag,&xclass,length);\r\n#ifdef LINT\r\nj=j;\r\n#endif\r\nif (j & 0x80)\r\n{\r\nif (BIO_write(bp,"Error in encoding\n",18) <= 0)\r\ngoto end;\r\nret=0;\r\ngoto end;\r\n}\r\nhl=(p-op);\r\nlength-=hl;\r\nif (BIO_printf(bp,"%5ld:",(long)offset+(long)(op- *pp))\r\n<= 0) goto end;\r\nif (j != (V_ASN1_CONSTRUCTED | 1))\r\n{\r\nif (BIO_printf(bp,"d=%-2d hl=%ld l=%4ld ",\r\ndepth,(long)hl,len) <= 0)\r\ngoto end;\r\n}\r\nelse\r\n{\r\nif (BIO_printf(bp,"d=%-2d hl=%ld l=inf ",\r\ndepth,(long)hl) <= 0)\r\ngoto end;\r\n}\r\nif (!asn1_print_info(bp,tag,xclass,j,(indent)?depth:0))\r\ngoto end;\r\nif (j & V_ASN1_CONSTRUCTED)\r\n{\r\nep=p+len;\r\nif (BIO_write(bp,"\n",1) <= 0) goto end;\r\nif (len > length)\r\n{\r\nBIO_printf(bp,\r\n"length is greater than %ld\n",length);\r\nret=0;\r\ngoto end;\r\n}\r\nif ((j == 0x21) && (len == 0))\r\n{\r\nfor (;;)\r\n{\r\nr=asn1_parse2(bp,&p,(long)(tot-p),\r\noffset+(p - *pp),depth+1,\r\nindent,dump);\r\nif (r == 0) { ret=0; goto end; }\r\nif ((r == 2) || (p >= tot)) break;\r\n}\r\n}\r\nelse\r\nwhile (p < ep)\r\n{\r\nr=asn1_parse2(bp,&p,(long)len,\r\noffset+(p - *pp),depth+1,\r\nindent,dump);\r\nif (r == 0) { ret=0; goto end; }\r\n}\r\n}\r\nelse if (xclass != 0)\r\n{\r\np+=len;\r\nif (BIO_write(bp,"\n",1) <= 0) goto end;\r\n}\r\nelse\r\n{\r\nnl=0;\r\nif ( (tag == V_ASN1_PRINTABLESTRING) ||\r\n(tag == V_ASN1_T61STRING) ||\r\n(tag == V_ASN1_IA5STRING) ||\r\n(tag == V_ASN1_VISIBLESTRING) ||\r\n(tag == V_ASN1_NUMERICSTRING) ||\r\n(tag == V_ASN1_UTF8STRING) ||\r\n(tag == V_ASN1_UTCTIME) ||\r\n(tag == V_ASN1_GENERALIZEDTIME))\r\n{\r\nif (BIO_write(bp,":",1) <= 0) goto end;\r\nif ((len > 0) &&\r\nBIO_write(bp,(const char *)p,(int)len)\r\n!= (int)len)\r\ngoto end;\r\n}\r\nelse if (tag == V_ASN1_OBJECT)\r\n{\r\nopp=op;\r\nif (d2i_ASN1_OBJECT(&o,&opp,len+hl) != NULL)\r\n{\r\nif (BIO_write(bp,":",1) <= 0) goto end;\r\ni2a_ASN1_OBJECT(bp,o);\r\n}\r\nelse\r\n{\r\nif (BIO_write(bp,":BAD OBJECT",11) <= 0)\r\ngoto end;\r\n}\r\n}\r\nelse if (tag == V_ASN1_BOOLEAN)\r\n{\r\nint ii;\r\nopp=op;\r\nii=d2i_ASN1_BOOLEAN(NULL,&opp,len+hl);\r\nif (ii < 0)\r\n{\r\nif (BIO_write(bp,"Bad boolean\n",12) <= 0)\r\ngoto end;\r\n}\r\nBIO_printf(bp,":%d",ii);\r\n}\r\nelse if (tag == V_ASN1_BMPSTRING)\r\n{\r\n}\r\nelse if (tag == V_ASN1_OCTET_STRING)\r\n{\r\nint i,printable=1;\r\nopp=op;\r\nos=d2i_ASN1_OCTET_STRING(NULL,&opp,len+hl);\r\nif (os != NULL && os->length > 0)\r\n{\r\nopp = os->data;\r\nfor (i=0; i<os->length; i++)\r\n{\r\nif (( (opp[i] < ' ') &&\r\n(opp[i] != '\n') &&\r\n(opp[i] != '\r') &&\r\n(opp[i] != '\t')) ||\r\n(opp[i] > '~'))\r\n{\r\nprintable=0;\r\nbreak;\r\n}\r\n}\r\nif (printable)\r\n{\r\nif (BIO_write(bp,":",1) <= 0)\r\ngoto end;\r\nif (BIO_write(bp,(const char *)opp,\r\nos->length) <= 0)\r\ngoto end;\r\n}\r\nelse if (!dump)\r\n{\r\nif (BIO_write(bp,"[HEX DUMP]:",11) <= 0)\r\ngoto end;\r\nfor (i=0; i<os->length; i++)\r\n{\r\nif (BIO_printf(bp,"%02X"\r\n, opp[i]) <= 0)\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nif (!nl)\r\n{\r\nif (BIO_write(bp,"\n",1) <= 0)\r\ngoto end;\r\n}\r\nif (BIO_dump_indent(bp,\r\n(const char *)opp,\r\n((dump == -1 || dump >\r\nos->length)?os->length:dump),\r\ndump_indent) <= 0)\r\ngoto end;\r\nnl=1;\r\n}\r\n}\r\nif (os != NULL)\r\n{\r\nM_ASN1_OCTET_STRING_free(os);\r\nos=NULL;\r\n}\r\n}\r\nelse if (tag == V_ASN1_INTEGER)\r\n{\r\nASN1_INTEGER *bs;\r\nint i;\r\nopp=op;\r\nbs=d2i_ASN1_INTEGER(NULL,&opp,len+hl);\r\nif (bs != NULL)\r\n{\r\nif (BIO_write(bp,":",1) <= 0) goto end;\r\nif (bs->type == V_ASN1_NEG_INTEGER)\r\nif (BIO_write(bp,"-",1) <= 0)\r\ngoto end;\r\nfor (i=0; i<bs->length; i++)\r\n{\r\nif (BIO_printf(bp,"%02X",\r\nbs->data[i]) <= 0)\r\ngoto end;\r\n}\r\nif (bs->length == 0)\r\n{\r\nif (BIO_write(bp,"00",2) <= 0)\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nif (BIO_write(bp,"BAD INTEGER",11) <= 0)\r\ngoto end;\r\n}\r\nM_ASN1_INTEGER_free(bs);\r\n}\r\nelse if (tag == V_ASN1_ENUMERATED)\r\n{\r\nASN1_ENUMERATED *bs;\r\nint i;\r\nopp=op;\r\nbs=d2i_ASN1_ENUMERATED(NULL,&opp,len+hl);\r\nif (bs != NULL)\r\n{\r\nif (BIO_write(bp,":",1) <= 0) goto end;\r\nif (bs->type == V_ASN1_NEG_ENUMERATED)\r\nif (BIO_write(bp,"-",1) <= 0)\r\ngoto end;\r\nfor (i=0; i<bs->length; i++)\r\n{\r\nif (BIO_printf(bp,"%02X",\r\nbs->data[i]) <= 0)\r\ngoto end;\r\n}\r\nif (bs->length == 0)\r\n{\r\nif (BIO_write(bp,"00",2) <= 0)\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nif (BIO_write(bp,"BAD ENUMERATED",11) <= 0)\r\ngoto end;\r\n}\r\nM_ASN1_ENUMERATED_free(bs);\r\n}\r\nelse if (len > 0 && dump)\r\n{\r\nif (!nl)\r\n{\r\nif (BIO_write(bp,"\n",1) <= 0)\r\ngoto end;\r\n}\r\nif (BIO_dump_indent(bp,(const char *)p,\r\n((dump == -1 || dump > len)?len:dump),\r\ndump_indent) <= 0)\r\ngoto end;\r\nnl=1;\r\n}\r\nif (!nl)\r\n{\r\nif (BIO_write(bp,"\n",1) <= 0) goto end;\r\n}\r\np+=len;\r\nif ((tag == V_ASN1_EOC) && (xclass == 0))\r\n{\r\nret=2;\r\ngoto end;\r\n}\r\n}\r\nlength-=len;\r\n}\r\nret=1;\r\nend:\r\nif (o != NULL) ASN1_OBJECT_free(o);\r\nif (os != NULL) M_ASN1_OCTET_STRING_free(os);\r\n*pp=p;\r\nreturn(ret);\r\n}\r\nconst char *ASN1_tag2str(int tag)\r\n{\r\nstatic const char * const tag2str[] = {\r\n"EOC", "BOOLEAN", "INTEGER", "BIT STRING", "OCTET STRING",\r\n"NULL", "OBJECT", "OBJECT DESCRIPTOR", "EXTERNAL", "REAL",\r\n"ENUMERATED", "<ASN1 11>", "UTF8STRING", "<ASN1 13>",\r\n"<ASN1 14>", "<ASN1 15>", "SEQUENCE", "SET",\r\n"NUMERICSTRING", "PRINTABLESTRING", "T61STRING",\r\n"VIDEOTEXSTRING", "IA5STRING", "UTCTIME","GENERALIZEDTIME",\r\n"GRAPHICSTRING", "VISIBLESTRING", "GENERALSTRING",\r\n"UNIVERSALSTRING", "<ASN1 29>", "BMPSTRING"\r\n};\r\nif((tag == V_ASN1_NEG_INTEGER) || (tag == V_ASN1_NEG_ENUMERATED))\r\ntag &= ~0x100;\r\nif(tag < 0 || tag > 30) return "(unknown)";\r\nreturn tag2str[tag];\r\n}

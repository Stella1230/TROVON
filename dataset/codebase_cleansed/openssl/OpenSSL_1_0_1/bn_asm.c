BN_ULONG bn_mul_add_words(BN_ULONG *rp, const BN_ULONG *ap, int num, BN_ULONG w)\r\n{\r\nBN_ULONG c1=0;\r\nassert(num >= 0);\r\nif (num <= 0) return(c1);\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (num&~3)\r\n{\r\nmul_add(rp[0],ap[0],w,c1);\r\nmul_add(rp[1],ap[1],w,c1);\r\nmul_add(rp[2],ap[2],w,c1);\r\nmul_add(rp[3],ap[3],w,c1);\r\nap+=4; rp+=4; num-=4;\r\n}\r\n#endif\r\nwhile (num)\r\n{\r\nmul_add(rp[0],ap[0],w,c1);\r\nap++; rp++; num--;\r\n}\r\nreturn(c1);\r\n}\r\nBN_ULONG bn_mul_words(BN_ULONG *rp, const BN_ULONG *ap, int num, BN_ULONG w)\r\n{\r\nBN_ULONG c1=0;\r\nassert(num >= 0);\r\nif (num <= 0) return(c1);\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (num&~3)\r\n{\r\nmul(rp[0],ap[0],w,c1);\r\nmul(rp[1],ap[1],w,c1);\r\nmul(rp[2],ap[2],w,c1);\r\nmul(rp[3],ap[3],w,c1);\r\nap+=4; rp+=4; num-=4;\r\n}\r\n#endif\r\nwhile (num)\r\n{\r\nmul(rp[0],ap[0],w,c1);\r\nap++; rp++; num--;\r\n}\r\nreturn(c1);\r\n}\r\nvoid bn_sqr_words(BN_ULONG *r, const BN_ULONG *a, int n)\r\n{\r\nassert(n >= 0);\r\nif (n <= 0) return;\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (n&~3)\r\n{\r\nsqr(r[0],r[1],a[0]);\r\nsqr(r[2],r[3],a[1]);\r\nsqr(r[4],r[5],a[2]);\r\nsqr(r[6],r[7],a[3]);\r\na+=4; r+=8; n-=4;\r\n}\r\n#endif\r\nwhile (n)\r\n{\r\nsqr(r[0],r[1],a[0]);\r\na++; r+=2; n--;\r\n}\r\n}\r\nBN_ULONG bn_mul_add_words(BN_ULONG *rp, const BN_ULONG *ap, int num, BN_ULONG w)\r\n{\r\nBN_ULONG c=0;\r\nBN_ULONG bl,bh;\r\nassert(num >= 0);\r\nif (num <= 0) return((BN_ULONG)0);\r\nbl=LBITS(w);\r\nbh=HBITS(w);\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (num&~3)\r\n{\r\nmul_add(rp[0],ap[0],bl,bh,c);\r\nmul_add(rp[1],ap[1],bl,bh,c);\r\nmul_add(rp[2],ap[2],bl,bh,c);\r\nmul_add(rp[3],ap[3],bl,bh,c);\r\nap+=4; rp+=4; num-=4;\r\n}\r\n#endif\r\nwhile (num)\r\n{\r\nmul_add(rp[0],ap[0],bl,bh,c);\r\nap++; rp++; num--;\r\n}\r\nreturn(c);\r\n}\r\nBN_ULONG bn_mul_words(BN_ULONG *rp, const BN_ULONG *ap, int num, BN_ULONG w)\r\n{\r\nBN_ULONG carry=0;\r\nBN_ULONG bl,bh;\r\nassert(num >= 0);\r\nif (num <= 0) return((BN_ULONG)0);\r\nbl=LBITS(w);\r\nbh=HBITS(w);\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (num&~3)\r\n{\r\nmul(rp[0],ap[0],bl,bh,carry);\r\nmul(rp[1],ap[1],bl,bh,carry);\r\nmul(rp[2],ap[2],bl,bh,carry);\r\nmul(rp[3],ap[3],bl,bh,carry);\r\nap+=4; rp+=4; num-=4;\r\n}\r\n#endif\r\nwhile (num)\r\n{\r\nmul(rp[0],ap[0],bl,bh,carry);\r\nap++; rp++; num--;\r\n}\r\nreturn(carry);\r\n}\r\nvoid bn_sqr_words(BN_ULONG *r, const BN_ULONG *a, int n)\r\n{\r\nassert(n >= 0);\r\nif (n <= 0) return;\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (n&~3)\r\n{\r\nsqr64(r[0],r[1],a[0]);\r\nsqr64(r[2],r[3],a[1]);\r\nsqr64(r[4],r[5],a[2]);\r\nsqr64(r[6],r[7],a[3]);\r\na+=4; r+=8; n-=4;\r\n}\r\n#endif\r\nwhile (n)\r\n{\r\nsqr64(r[0],r[1],a[0]);\r\na++; r+=2; n--;\r\n}\r\n}\r\nBN_ULONG bn_div_words(BN_ULONG h, BN_ULONG l, BN_ULONG d)\r\n{\r\nreturn((BN_ULONG)(((((BN_ULLONG)h)<<BN_BITS2)|l)/(BN_ULLONG)d));\r\n}\r\nBN_ULONG bn_div_words(BN_ULONG h, BN_ULONG l, BN_ULONG d)\r\n{\r\nBN_ULONG dh,dl,q,ret=0,th,tl,t;\r\nint i,count=2;\r\nif (d == 0) return(BN_MASK2);\r\ni=BN_num_bits_word(d);\r\nassert((i == BN_BITS2) || (h <= (BN_ULONG)1<<i));\r\ni=BN_BITS2-i;\r\nif (h >= d) h-=d;\r\nif (i)\r\n{\r\nd<<=i;\r\nh=(h<<i)|(l>>(BN_BITS2-i));\r\nl<<=i;\r\n}\r\ndh=(d&BN_MASK2h)>>BN_BITS4;\r\ndl=(d&BN_MASK2l);\r\nfor (;;)\r\n{\r\nif ((h>>BN_BITS4) == dh)\r\nq=BN_MASK2l;\r\nelse\r\nq=h/dh;\r\nth=q*dh;\r\ntl=dl*q;\r\nfor (;;)\r\n{\r\nt=h-th;\r\nif ((t&BN_MASK2h) ||\r\n((tl) <= (\r\n(t<<BN_BITS4)|\r\n((l&BN_MASK2h)>>BN_BITS4))))\r\nbreak;\r\nq--;\r\nth-=dh;\r\ntl-=dl;\r\n}\r\nt=(tl>>BN_BITS4);\r\ntl=(tl<<BN_BITS4)&BN_MASK2h;\r\nth+=t;\r\nif (l < tl) th++;\r\nl-=tl;\r\nif (h < th)\r\n{\r\nh+=d;\r\nq--;\r\n}\r\nh-=th;\r\nif (--count == 0) break;\r\nret=q<<BN_BITS4;\r\nh=((h<<BN_BITS4)|(l>>BN_BITS4))&BN_MASK2;\r\nl=(l&BN_MASK2l)<<BN_BITS4;\r\n}\r\nret|=q;\r\nreturn(ret);\r\n}\r\nBN_ULONG bn_add_words(BN_ULONG *r, const BN_ULONG *a, const BN_ULONG *b, int n)\r\n{\r\nBN_ULLONG ll=0;\r\nassert(n >= 0);\r\nif (n <= 0) return((BN_ULONG)0);\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (n&~3)\r\n{\r\nll+=(BN_ULLONG)a[0]+b[0];\r\nr[0]=(BN_ULONG)ll&BN_MASK2;\r\nll>>=BN_BITS2;\r\nll+=(BN_ULLONG)a[1]+b[1];\r\nr[1]=(BN_ULONG)ll&BN_MASK2;\r\nll>>=BN_BITS2;\r\nll+=(BN_ULLONG)a[2]+b[2];\r\nr[2]=(BN_ULONG)ll&BN_MASK2;\r\nll>>=BN_BITS2;\r\nll+=(BN_ULLONG)a[3]+b[3];\r\nr[3]=(BN_ULONG)ll&BN_MASK2;\r\nll>>=BN_BITS2;\r\na+=4; b+=4; r+=4; n-=4;\r\n}\r\n#endif\r\nwhile (n)\r\n{\r\nll+=(BN_ULLONG)a[0]+b[0];\r\nr[0]=(BN_ULONG)ll&BN_MASK2;\r\nll>>=BN_BITS2;\r\na++; b++; r++; n--;\r\n}\r\nreturn((BN_ULONG)ll);\r\n}\r\nBN_ULONG bn_add_words(BN_ULONG *r, const BN_ULONG *a, const BN_ULONG *b, int n)\r\n{\r\nBN_ULONG c,l,t;\r\nassert(n >= 0);\r\nif (n <= 0) return((BN_ULONG)0);\r\nc=0;\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (n&~3)\r\n{\r\nt=a[0];\r\nt=(t+c)&BN_MASK2;\r\nc=(t < c);\r\nl=(t+b[0])&BN_MASK2;\r\nc+=(l < t);\r\nr[0]=l;\r\nt=a[1];\r\nt=(t+c)&BN_MASK2;\r\nc=(t < c);\r\nl=(t+b[1])&BN_MASK2;\r\nc+=(l < t);\r\nr[1]=l;\r\nt=a[2];\r\nt=(t+c)&BN_MASK2;\r\nc=(t < c);\r\nl=(t+b[2])&BN_MASK2;\r\nc+=(l < t);\r\nr[2]=l;\r\nt=a[3];\r\nt=(t+c)&BN_MASK2;\r\nc=(t < c);\r\nl=(t+b[3])&BN_MASK2;\r\nc+=(l < t);\r\nr[3]=l;\r\na+=4; b+=4; r+=4; n-=4;\r\n}\r\n#endif\r\nwhile(n)\r\n{\r\nt=a[0];\r\nt=(t+c)&BN_MASK2;\r\nc=(t < c);\r\nl=(t+b[0])&BN_MASK2;\r\nc+=(l < t);\r\nr[0]=l;\r\na++; b++; r++; n--;\r\n}\r\nreturn((BN_ULONG)c);\r\n}\r\nBN_ULONG bn_sub_words(BN_ULONG *r, const BN_ULONG *a, const BN_ULONG *b, int n)\r\n{\r\nBN_ULONG t1,t2;\r\nint c=0;\r\nassert(n >= 0);\r\nif (n <= 0) return((BN_ULONG)0);\r\n#ifndef OPENSSL_SMALL_FOOTPRINT\r\nwhile (n&~3)\r\n{\r\nt1=a[0]; t2=b[0];\r\nr[0]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nt1=a[1]; t2=b[1];\r\nr[1]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nt1=a[2]; t2=b[2];\r\nr[2]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nt1=a[3]; t2=b[3];\r\nr[3]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\na+=4; b+=4; r+=4; n-=4;\r\n}\r\n#endif\r\nwhile (n)\r\n{\r\nt1=a[0]; t2=b[0];\r\nr[0]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\na++; b++; r++; n--;\r\n}\r\nreturn(c);\r\n}\r\nvoid bn_mul_comba8(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b)\r\n{\r\n#ifdef BN_LLONG\r\nBN_ULLONG t;\r\n#else\r\nBN_ULONG bl,bh;\r\n#endif\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nmul_add_c(a[0],b[0],c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nmul_add_c(a[0],b[1],c2,c3,c1);\r\nmul_add_c(a[1],b[0],c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nmul_add_c(a[2],b[0],c3,c1,c2);\r\nmul_add_c(a[1],b[1],c3,c1,c2);\r\nmul_add_c(a[0],b[2],c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nmul_add_c(a[0],b[3],c1,c2,c3);\r\nmul_add_c(a[1],b[2],c1,c2,c3);\r\nmul_add_c(a[2],b[1],c1,c2,c3);\r\nmul_add_c(a[3],b[0],c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nmul_add_c(a[4],b[0],c2,c3,c1);\r\nmul_add_c(a[3],b[1],c2,c3,c1);\r\nmul_add_c(a[2],b[2],c2,c3,c1);\r\nmul_add_c(a[1],b[3],c2,c3,c1);\r\nmul_add_c(a[0],b[4],c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nmul_add_c(a[0],b[5],c3,c1,c2);\r\nmul_add_c(a[1],b[4],c3,c1,c2);\r\nmul_add_c(a[2],b[3],c3,c1,c2);\r\nmul_add_c(a[3],b[2],c3,c1,c2);\r\nmul_add_c(a[4],b[1],c3,c1,c2);\r\nmul_add_c(a[5],b[0],c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nmul_add_c(a[6],b[0],c1,c2,c3);\r\nmul_add_c(a[5],b[1],c1,c2,c3);\r\nmul_add_c(a[4],b[2],c1,c2,c3);\r\nmul_add_c(a[3],b[3],c1,c2,c3);\r\nmul_add_c(a[2],b[4],c1,c2,c3);\r\nmul_add_c(a[1],b[5],c1,c2,c3);\r\nmul_add_c(a[0],b[6],c1,c2,c3);\r\nr[6]=c1;\r\nc1=0;\r\nmul_add_c(a[0],b[7],c2,c3,c1);\r\nmul_add_c(a[1],b[6],c2,c3,c1);\r\nmul_add_c(a[2],b[5],c2,c3,c1);\r\nmul_add_c(a[3],b[4],c2,c3,c1);\r\nmul_add_c(a[4],b[3],c2,c3,c1);\r\nmul_add_c(a[5],b[2],c2,c3,c1);\r\nmul_add_c(a[6],b[1],c2,c3,c1);\r\nmul_add_c(a[7],b[0],c2,c3,c1);\r\nr[7]=c2;\r\nc2=0;\r\nmul_add_c(a[7],b[1],c3,c1,c2);\r\nmul_add_c(a[6],b[2],c3,c1,c2);\r\nmul_add_c(a[5],b[3],c3,c1,c2);\r\nmul_add_c(a[4],b[4],c3,c1,c2);\r\nmul_add_c(a[3],b[5],c3,c1,c2);\r\nmul_add_c(a[2],b[6],c3,c1,c2);\r\nmul_add_c(a[1],b[7],c3,c1,c2);\r\nr[8]=c3;\r\nc3=0;\r\nmul_add_c(a[2],b[7],c1,c2,c3);\r\nmul_add_c(a[3],b[6],c1,c2,c3);\r\nmul_add_c(a[4],b[5],c1,c2,c3);\r\nmul_add_c(a[5],b[4],c1,c2,c3);\r\nmul_add_c(a[6],b[3],c1,c2,c3);\r\nmul_add_c(a[7],b[2],c1,c2,c3);\r\nr[9]=c1;\r\nc1=0;\r\nmul_add_c(a[7],b[3],c2,c3,c1);\r\nmul_add_c(a[6],b[4],c2,c3,c1);\r\nmul_add_c(a[5],b[5],c2,c3,c1);\r\nmul_add_c(a[4],b[6],c2,c3,c1);\r\nmul_add_c(a[3],b[7],c2,c3,c1);\r\nr[10]=c2;\r\nc2=0;\r\nmul_add_c(a[4],b[7],c3,c1,c2);\r\nmul_add_c(a[5],b[6],c3,c1,c2);\r\nmul_add_c(a[6],b[5],c3,c1,c2);\r\nmul_add_c(a[7],b[4],c3,c1,c2);\r\nr[11]=c3;\r\nc3=0;\r\nmul_add_c(a[7],b[5],c1,c2,c3);\r\nmul_add_c(a[6],b[6],c1,c2,c3);\r\nmul_add_c(a[5],b[7],c1,c2,c3);\r\nr[12]=c1;\r\nc1=0;\r\nmul_add_c(a[6],b[7],c2,c3,c1);\r\nmul_add_c(a[7],b[6],c2,c3,c1);\r\nr[13]=c2;\r\nc2=0;\r\nmul_add_c(a[7],b[7],c3,c1,c2);\r\nr[14]=c3;\r\nr[15]=c1;\r\n}\r\nvoid bn_mul_comba4(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b)\r\n{\r\n#ifdef BN_LLONG\r\nBN_ULLONG t;\r\n#else\r\nBN_ULONG bl,bh;\r\n#endif\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nmul_add_c(a[0],b[0],c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nmul_add_c(a[0],b[1],c2,c3,c1);\r\nmul_add_c(a[1],b[0],c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nmul_add_c(a[2],b[0],c3,c1,c2);\r\nmul_add_c(a[1],b[1],c3,c1,c2);\r\nmul_add_c(a[0],b[2],c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nmul_add_c(a[0],b[3],c1,c2,c3);\r\nmul_add_c(a[1],b[2],c1,c2,c3);\r\nmul_add_c(a[2],b[1],c1,c2,c3);\r\nmul_add_c(a[3],b[0],c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nmul_add_c(a[3],b[1],c2,c3,c1);\r\nmul_add_c(a[2],b[2],c2,c3,c1);\r\nmul_add_c(a[1],b[3],c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nmul_add_c(a[2],b[3],c3,c1,c2);\r\nmul_add_c(a[3],b[2],c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nmul_add_c(a[3],b[3],c1,c2,c3);\r\nr[6]=c1;\r\nr[7]=c2;\r\n}\r\nvoid bn_sqr_comba8(BN_ULONG *r, const BN_ULONG *a)\r\n{\r\n#ifdef BN_LLONG\r\nBN_ULLONG t,tt;\r\n#else\r\nBN_ULONG bl,bh;\r\n#endif\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nsqr_add_c(a,0,c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nsqr_add_c2(a,1,0,c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nsqr_add_c(a,1,c3,c1,c2);\r\nsqr_add_c2(a,2,0,c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nsqr_add_c2(a,3,0,c1,c2,c3);\r\nsqr_add_c2(a,2,1,c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nsqr_add_c(a,2,c2,c3,c1);\r\nsqr_add_c2(a,3,1,c2,c3,c1);\r\nsqr_add_c2(a,4,0,c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nsqr_add_c2(a,5,0,c3,c1,c2);\r\nsqr_add_c2(a,4,1,c3,c1,c2);\r\nsqr_add_c2(a,3,2,c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nsqr_add_c(a,3,c1,c2,c3);\r\nsqr_add_c2(a,4,2,c1,c2,c3);\r\nsqr_add_c2(a,5,1,c1,c2,c3);\r\nsqr_add_c2(a,6,0,c1,c2,c3);\r\nr[6]=c1;\r\nc1=0;\r\nsqr_add_c2(a,7,0,c2,c3,c1);\r\nsqr_add_c2(a,6,1,c2,c3,c1);\r\nsqr_add_c2(a,5,2,c2,c3,c1);\r\nsqr_add_c2(a,4,3,c2,c3,c1);\r\nr[7]=c2;\r\nc2=0;\r\nsqr_add_c(a,4,c3,c1,c2);\r\nsqr_add_c2(a,5,3,c3,c1,c2);\r\nsqr_add_c2(a,6,2,c3,c1,c2);\r\nsqr_add_c2(a,7,1,c3,c1,c2);\r\nr[8]=c3;\r\nc3=0;\r\nsqr_add_c2(a,7,2,c1,c2,c3);\r\nsqr_add_c2(a,6,3,c1,c2,c3);\r\nsqr_add_c2(a,5,4,c1,c2,c3);\r\nr[9]=c1;\r\nc1=0;\r\nsqr_add_c(a,5,c2,c3,c1);\r\nsqr_add_c2(a,6,4,c2,c3,c1);\r\nsqr_add_c2(a,7,3,c2,c3,c1);\r\nr[10]=c2;\r\nc2=0;\r\nsqr_add_c2(a,7,4,c3,c1,c2);\r\nsqr_add_c2(a,6,5,c3,c1,c2);\r\nr[11]=c3;\r\nc3=0;\r\nsqr_add_c(a,6,c1,c2,c3);\r\nsqr_add_c2(a,7,5,c1,c2,c3);\r\nr[12]=c1;\r\nc1=0;\r\nsqr_add_c2(a,7,6,c2,c3,c1);\r\nr[13]=c2;\r\nc2=0;\r\nsqr_add_c(a,7,c3,c1,c2);\r\nr[14]=c3;\r\nr[15]=c1;\r\n}\r\nvoid bn_sqr_comba4(BN_ULONG *r, const BN_ULONG *a)\r\n{\r\n#ifdef BN_LLONG\r\nBN_ULLONG t,tt;\r\n#else\r\nBN_ULONG bl,bh;\r\n#endif\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nsqr_add_c(a,0,c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nsqr_add_c2(a,1,0,c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nsqr_add_c(a,1,c3,c1,c2);\r\nsqr_add_c2(a,2,0,c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nsqr_add_c2(a,3,0,c1,c2,c3);\r\nsqr_add_c2(a,2,1,c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nsqr_add_c(a,2,c2,c3,c1);\r\nsqr_add_c2(a,3,1,c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nsqr_add_c2(a,3,2,c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nsqr_add_c(a,3,c1,c2,c3);\r\nr[6]=c1;\r\nr[7]=c2;\r\n}\r\nint bn_mul_mont(BN_ULONG *rp, const BN_ULONG *ap, const BN_ULONG *bp, const BN_ULONG *np,const BN_ULONG *n0p, int num)\r\n{\r\nBN_ULONG c0,c1,ml,*tp,n0;\r\n#ifdef mul64\r\nBN_ULONG mh;\r\n#endif\r\nvolatile BN_ULONG *vp;\r\nint i=0,j;\r\n#if 0\r\nif (ap==bp) return bn_sqr_mont(rp,ap,np,n0p,num);\r\n#endif\r\nvp = tp = alloca((num+2)*sizeof(BN_ULONG));\r\nn0 = *n0p;\r\nc0 = 0;\r\nml = bp[0];\r\n#ifdef mul64\r\nmh = HBITS(ml);\r\nml = LBITS(ml);\r\nfor (j=0;j<num;++j)\r\nmul(tp[j],ap[j],ml,mh,c0);\r\n#else\r\nfor (j=0;j<num;++j)\r\nmul(tp[j],ap[j],ml,c0);\r\n#endif\r\ntp[num] = c0;\r\ntp[num+1] = 0;\r\ngoto enter;\r\nfor(i=0;i<num;i++)\r\n{\r\nc0 = 0;\r\nml = bp[i];\r\n#ifdef mul64\r\nmh = HBITS(ml);\r\nml = LBITS(ml);\r\nfor (j=0;j<num;++j)\r\nmul_add(tp[j],ap[j],ml,mh,c0);\r\n#else\r\nfor (j=0;j<num;++j)\r\nmul_add(tp[j],ap[j],ml,c0);\r\n#endif\r\nc1 = (tp[num] + c0)&BN_MASK2;\r\ntp[num] = c1;\r\ntp[num+1] = (c1<c0?1:0);\r\nenter:\r\nc1 = tp[0];\r\nml = (c1*n0)&BN_MASK2;\r\nc0 = 0;\r\n#ifdef mul64\r\nmh = HBITS(ml);\r\nml = LBITS(ml);\r\nmul_add(c1,np[0],ml,mh,c0);\r\n#else\r\nmul_add(c1,ml,np[0],c0);\r\n#endif\r\nfor(j=1;j<num;j++)\r\n{\r\nc1 = tp[j];\r\n#ifdef mul64\r\nmul_add(c1,np[j],ml,mh,c0);\r\n#else\r\nmul_add(c1,ml,np[j],c0);\r\n#endif\r\ntp[j-1] = c1&BN_MASK2;\r\n}\r\nc1 = (tp[num] + c0)&BN_MASK2;\r\ntp[num-1] = c1;\r\ntp[num] = tp[num+1] + (c1<c0?1:0);\r\n}\r\nif (tp[num]!=0 || tp[num-1]>=np[num-1])\r\n{\r\nc0 = bn_sub_words(rp,tp,np,num);\r\nif (tp[num]!=0 || c0==0)\r\n{\r\nfor(i=0;i<num+2;i++) vp[i] = 0;\r\nreturn 1;\r\n}\r\n}\r\nfor(i=0;i<num;i++) rp[i] = tp[i], vp[i] = 0;\r\nvp[num] = 0;\r\nvp[num+1] = 0;\r\nreturn 1;\r\n}\r\nint bn_mul_mont(BN_ULONG *rp, const BN_ULONG *ap, const BN_ULONG *bp, const BN_ULONG *np,const BN_ULONG *n0, int num)\r\n{ return 0; }\r\nvoid bn_sqr_comba4(BN_ULONG *r, const BN_ULONG *a)\r\n{\r\nBN_ULONG t[8];\r\nbn_sqr_normal(r,a,4,t);\r\n}\r\nvoid bn_sqr_comba8(BN_ULONG *r, const BN_ULONG *a)\r\n{\r\nBN_ULONG t[16];\r\nbn_sqr_normal(r,a,8,t);\r\n}\r\nvoid bn_mul_comba4(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b)\r\n{\r\nr[4]=bn_mul_words( &(r[0]),a,4,b[0]);\r\nr[5]=bn_mul_add_words(&(r[1]),a,4,b[1]);\r\nr[6]=bn_mul_add_words(&(r[2]),a,4,b[2]);\r\nr[7]=bn_mul_add_words(&(r[3]),a,4,b[3]);\r\n}\r\nvoid bn_mul_comba8(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b)\r\n{\r\nr[ 8]=bn_mul_words( &(r[0]),a,8,b[0]);\r\nr[ 9]=bn_mul_add_words(&(r[1]),a,8,b[1]);\r\nr[10]=bn_mul_add_words(&(r[2]),a,8,b[2]);\r\nr[11]=bn_mul_add_words(&(r[3]),a,8,b[3]);\r\nr[12]=bn_mul_add_words(&(r[4]),a,8,b[4]);\r\nr[13]=bn_mul_add_words(&(r[5]),a,8,b[5]);\r\nr[14]=bn_mul_add_words(&(r[6]),a,8,b[6]);\r\nr[15]=bn_mul_add_words(&(r[7]),a,8,b[7]);\r\n}\r\nint bn_mul_mont(BN_ULONG *rp, const BN_ULONG *ap, const BN_ULONG *bp, const BN_ULONG *np,const BN_ULONG *n0p, int num)\r\n{\r\nBN_ULONG c0,c1,*tp,n0=*n0p;\r\nvolatile BN_ULONG *vp;\r\nint i=0,j;\r\nvp = tp = alloca((num+2)*sizeof(BN_ULONG));\r\nfor(i=0;i<=num;i++) tp[i]=0;\r\nfor(i=0;i<num;i++)\r\n{\r\nc0 = bn_mul_add_words(tp,ap,num,bp[i]);\r\nc1 = (tp[num] + c0)&BN_MASK2;\r\ntp[num] = c1;\r\ntp[num+1] = (c1<c0?1:0);\r\nc0 = bn_mul_add_words(tp,np,num,tp[0]*n0);\r\nc1 = (tp[num] + c0)&BN_MASK2;\r\ntp[num] = c1;\r\ntp[num+1] += (c1<c0?1:0);\r\nfor(j=0;j<=num;j++) tp[j]=tp[j+1];\r\n}\r\nif (tp[num]!=0 || tp[num-1]>=np[num-1])\r\n{\r\nc0 = bn_sub_words(rp,tp,np,num);\r\nif (tp[num]!=0 || c0==0)\r\n{\r\nfor(i=0;i<num+2;i++) vp[i] = 0;\r\nreturn 1;\r\n}\r\n}\r\nfor(i=0;i<num;i++) rp[i] = tp[i], vp[i] = 0;\r\nvp[num] = 0;\r\nvp[num+1] = 0;\r\nreturn 1;\r\n}\r\nint bn_mul_mont(BN_ULONG *rp, const BN_ULONG *ap, const BN_ULONG *bp, const BN_ULONG *np,const BN_ULONG *n0, int num)\r\n{ return 0; }

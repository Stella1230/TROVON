int main(int argc, char **argv)\r\n{\r\nBIO *in = NULL, *out = NULL, *tbio = NULL, *dout = NULL;\r\nX509 *rcert = NULL;\r\nSTACK_OF(X509) *recips = NULL;\r\nCMS_ContentInfo *cms = NULL;\r\nint ret = 1;\r\nint flags = CMS_STREAM|CMS_DETACHED;\r\nOpenSSL_add_all_algorithms();\r\nERR_load_crypto_strings();\r\ntbio = BIO_new_file("signer.pem", "r");\r\nif (!tbio)\r\ngoto err;\r\nrcert = PEM_read_bio_X509(tbio, NULL, 0, NULL);\r\nif (!rcert)\r\ngoto err;\r\nrecips = sk_X509_new_null();\r\nif (!recips || !sk_X509_push(recips, rcert))\r\ngoto err;\r\nrcert = NULL;\r\nin = BIO_new_file("encr.txt", "r");\r\ndout = BIO_new_file("smencr.out", "wb");\r\nif (!in)\r\ngoto err;\r\ncms = CMS_encrypt(recips, in, EVP_des_ede3_cbc(), flags);\r\nif (!cms)\r\ngoto err;\r\nout = BIO_new_file("smencr.pem", "w");\r\nif (!out)\r\ngoto err;\r\nif (!CMS_final(cms, in, dout, flags))\r\ngoto err;\r\nif (!PEM_write_bio_CMS(out, cms))\r\ngoto err;\r\nret = 0;\r\nerr:\r\nif (ret)\r\n{\r\nfprintf(stderr, "Error Encrypting Data\n");\r\nERR_print_errors_fp(stderr);\r\n}\r\nif (cms)\r\nCMS_ContentInfo_free(cms);\r\nif (rcert)\r\nX509_free(rcert);\r\nif (recips)\r\nsk_X509_pop_free(recips, X509_free);\r\nif (in)\r\nBIO_free(in);\r\nif (out)\r\nBIO_free(out);\r\nif (dout)\r\nBIO_free(dout);\r\nif (tbio)\r\nBIO_free(tbio);\r\nreturn ret;\r\n}

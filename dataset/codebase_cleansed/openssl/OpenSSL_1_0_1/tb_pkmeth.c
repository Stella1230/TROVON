void ENGINE_unregister_pkey_meths(ENGINE *e)\r\n{\r\nengine_table_unregister(&pkey_meth_table, e);\r\n}\r\nstatic void engine_unregister_all_pkey_meths(void)\r\n{\r\nengine_table_cleanup(&pkey_meth_table);\r\n}\r\nint ENGINE_register_pkey_meths(ENGINE *e)\r\n{\r\nif(e->pkey_meths)\r\n{\r\nconst int *nids;\r\nint num_nids = e->pkey_meths(e, NULL, &nids, 0);\r\nif(num_nids > 0)\r\nreturn engine_table_register(&pkey_meth_table,\r\nengine_unregister_all_pkey_meths, e, nids,\r\nnum_nids, 0);\r\n}\r\nreturn 1;\r\n}\r\nvoid ENGINE_register_all_pkey_meths()\r\n{\r\nENGINE *e;\r\nfor(e=ENGINE_get_first() ; e ; e=ENGINE_get_next(e))\r\nENGINE_register_pkey_meths(e);\r\n}\r\nint ENGINE_set_default_pkey_meths(ENGINE *e)\r\n{\r\nif(e->pkey_meths)\r\n{\r\nconst int *nids;\r\nint num_nids = e->pkey_meths(e, NULL, &nids, 0);\r\nif(num_nids > 0)\r\nreturn engine_table_register(&pkey_meth_table,\r\nengine_unregister_all_pkey_meths, e, nids,\r\nnum_nids, 1);\r\n}\r\nreturn 1;\r\n}\r\nENGINE *ENGINE_get_pkey_meth_engine(int nid)\r\n{\r\nreturn engine_table_select(&pkey_meth_table, nid);\r\n}\r\nconst EVP_PKEY_METHOD *ENGINE_get_pkey_meth(ENGINE *e, int nid)\r\n{\r\nEVP_PKEY_METHOD *ret;\r\nENGINE_PKEY_METHS_PTR fn = ENGINE_get_pkey_meths(e);\r\nif(!fn || !fn(e, &ret, NULL, nid))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_GET_PKEY_METH,\r\nENGINE_R_UNIMPLEMENTED_PUBLIC_KEY_METHOD);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nENGINE_PKEY_METHS_PTR ENGINE_get_pkey_meths(const ENGINE *e)\r\n{\r\nreturn e->pkey_meths;\r\n}\r\nint ENGINE_set_pkey_meths(ENGINE *e, ENGINE_PKEY_METHS_PTR f)\r\n{\r\ne->pkey_meths = f;\r\nreturn 1;\r\n}\r\nvoid engine_pkey_meths_free(ENGINE *e)\r\n{\r\nint i;\r\nEVP_PKEY_METHOD *pkm;\r\nif (e->pkey_meths)\r\n{\r\nconst int *pknids;\r\nint npknids;\r\nnpknids = e->pkey_meths(e, NULL, &pknids, 0);\r\nfor (i = 0; i < npknids; i++)\r\n{\r\nif (e->pkey_meths(e, &pkm, NULL, pknids[i]))\r\n{\r\nEVP_PKEY_meth_free(pkm);\r\n}\r\n}\r\n}\r\n}

static char *skip_dot(char *name)\r\n{\r\nchar *p;\r\np = strchr(name, '.');\r\nif (p)\r\nreturn p + 1;\r\nreturn name;\r\n}\r\nstatic int int_engine_init(ENGINE *e)\r\n{\r\nif (!ENGINE_init(e))\r\nreturn 0;\r\nif (!initialized_engines)\r\ninitialized_engines = sk_ENGINE_new_null();\r\nif (!initialized_engines || !sk_ENGINE_push(initialized_engines, e))\r\n{\r\nENGINE_finish(e);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int int_engine_configure(char *name, char *value, const CONF *cnf)\r\n{\r\nint i;\r\nint ret = 0;\r\nlong do_init = -1;\r\nSTACK_OF(CONF_VALUE) *ecmds;\r\nCONF_VALUE *ecmd = NULL;\r\nchar *ctrlname, *ctrlvalue;\r\nENGINE *e = NULL;\r\nint soft = 0;\r\nname = skip_dot(name);\r\n#ifdef ENGINE_CONF_DEBUG\r\nfprintf(stderr, "Configuring engine %s\n", name);\r\n#endif\r\necmds = NCONF_get_section(cnf, value);\r\nif (!ecmds)\r\n{\r\nENGINEerr(ENGINE_F_INT_ENGINE_CONFIGURE, ENGINE_R_ENGINE_SECTION_ERROR);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < sk_CONF_VALUE_num(ecmds); i++)\r\n{\r\necmd = sk_CONF_VALUE_value(ecmds, i);\r\nctrlname = skip_dot(ecmd->name);\r\nctrlvalue = ecmd->value;\r\n#ifdef ENGINE_CONF_DEBUG\r\nfprintf(stderr, "ENGINE conf: doing ctrl(%s,%s)\n", ctrlname, ctrlvalue);\r\n#endif\r\nif (!strcmp(ctrlname, "engine_id"))\r\nname = ctrlvalue;\r\nelse if (!strcmp(ctrlname, "soft_load"))\r\nsoft = 1;\r\nelse if (!strcmp(ctrlname, "dynamic_path"))\r\n{\r\ne = ENGINE_by_id("dynamic");\r\nif (!e)\r\ngoto err;\r\nif (!ENGINE_ctrl_cmd_string(e, "SO_PATH", ctrlvalue, 0))\r\ngoto err;\r\nif (!ENGINE_ctrl_cmd_string(e, "LIST_ADD", "2", 0))\r\ngoto err;\r\nif (!ENGINE_ctrl_cmd_string(e, "LOAD", NULL, 0))\r\ngoto err;\r\n}\r\nelse\r\n{\r\nif (!e)\r\n{\r\ne = ENGINE_by_id(name);\r\nif (!e && soft)\r\n{\r\nERR_clear_error();\r\nreturn 1;\r\n}\r\nif (!e)\r\ngoto err;\r\n}\r\nif (!strcmp(ctrlvalue, "EMPTY"))\r\nctrlvalue = NULL;\r\nif (!strcmp(ctrlname, "init"))\r\n{\r\nif (!NCONF_get_number_e(cnf, value, "init", &do_init))\r\ngoto err;\r\nif (do_init == 1)\r\n{\r\nif (!int_engine_init(e))\r\ngoto err;\r\n}\r\nelse if (do_init != 0)\r\n{\r\nENGINEerr(ENGINE_F_INT_ENGINE_CONFIGURE, ENGINE_R_INVALID_INIT_VALUE);\r\ngoto err;\r\n}\r\n}\r\nelse if (!strcmp(ctrlname, "default_algorithms"))\r\n{\r\nif (!ENGINE_set_default_string(e, ctrlvalue))\r\ngoto err;\r\n}\r\nelse if (!ENGINE_ctrl_cmd_string(e,\r\nctrlname, ctrlvalue, 0))\r\ngoto err;\r\n}\r\n}\r\nif (e && (do_init == -1) && !int_engine_init(e))\r\n{\r\necmd = NULL;\r\ngoto err;\r\n}\r\nret = 1;\r\nerr:\r\nif (ret != 1)\r\n{\r\nENGINEerr(ENGINE_F_INT_ENGINE_CONFIGURE, ENGINE_R_ENGINE_CONFIGURATION_ERROR);\r\nif (ecmd)\r\nERR_add_error_data(6, "section=", ecmd->section,\r\n", name=", ecmd->name,\r\n", value=", ecmd->value);\r\n}\r\nif (e)\r\nENGINE_free(e);\r\nreturn ret;\r\n}\r\nstatic int int_engine_module_init(CONF_IMODULE *md, const CONF *cnf)\r\n{\r\nSTACK_OF(CONF_VALUE) *elist;\r\nCONF_VALUE *cval;\r\nint i;\r\n#ifdef ENGINE_CONF_DEBUG\r\nfprintf(stderr, "Called engine module: name %s, value %s\n",\r\nCONF_imodule_get_name(md), CONF_imodule_get_value(md));\r\n#endif\r\nelist = NCONF_get_section(cnf, CONF_imodule_get_value(md));\r\nif (!elist)\r\n{\r\nENGINEerr(ENGINE_F_INT_ENGINE_MODULE_INIT, ENGINE_R_ENGINES_SECTION_ERROR);\r\nreturn 0;\r\n}\r\nfor (i = 0; i < sk_CONF_VALUE_num(elist); i++)\r\n{\r\ncval = sk_CONF_VALUE_value(elist, i);\r\nif (!int_engine_configure(cval->name, cval->value, cnf))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void int_engine_module_finish(CONF_IMODULE *md)\r\n{\r\nENGINE *e;\r\nwhile ((e = sk_ENGINE_pop(initialized_engines)))\r\nENGINE_finish(e);\r\nsk_ENGINE_free(initialized_engines);\r\ninitialized_engines = NULL;\r\n}\r\nvoid ENGINE_add_conf_module(void)\r\n{\r\nCONF_module_add("engines",\r\nint_engine_module_init,\r\nint_engine_module_finish);\r\n}

int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nchar **args, *infile = NULL, *outfile = NULL;\r\nchar *passargin = NULL, *passargout = NULL;\r\nBIO *in = NULL, *out = NULL;\r\nconst EVP_CIPHER *cipher = NULL;\r\nint informat, outformat;\r\nint pubin = 0, pubout = 0, pubtext = 0, text = 0, noout = 0;\r\nEVP_PKEY *pkey=NULL;\r\nchar *passin = NULL, *passout = NULL;\r\nint badarg = 0;\r\n#ifndef OPENSSL_NO_ENGINE\r\nchar *engine=NULL;\r\n#endif\r\nint ret = 1;\r\nif (bio_err == NULL)\r\nbio_err = BIO_new_fp (stderr, BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\ninformat=FORMAT_PEM;\r\noutformat=FORMAT_PEM;\r\nERR_load_crypto_strings();\r\nOpenSSL_add_all_algorithms();\r\nargs = argv + 1;\r\nwhile (!badarg && *args && *args[0] == '-')\r\n{\r\nif (!strcmp(*args,"-inform"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\ninformat=str2fmt(*args);\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args,"-outform"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutformat=str2fmt(*args);\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args,"-passin"))\r\n{\r\nif (!args[1]) goto bad;\r\npassargin= *(++args);\r\n}\r\nelse if (!strcmp(*args,"-passout"))\r\n{\r\nif (!args[1]) goto bad;\r\npassargout= *(++args);\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\nelse if (strcmp(*args,"-engine") == 0)\r\n{\r\nif (!args[1]) goto bad;\r\nengine= *(++args);\r\n}\r\n#endif\r\nelse if (!strcmp (*args, "-in"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\ninfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-out"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (strcmp(*args,"-pubin") == 0)\r\n{\r\npubin=1;\r\npubout=1;\r\npubtext=1;\r\n}\r\nelse if (strcmp(*args,"-pubout") == 0)\r\npubout=1;\r\nelse if (strcmp(*args,"-text_pub") == 0)\r\n{\r\npubtext=1;\r\ntext=1;\r\n}\r\nelse if (strcmp(*args,"-text") == 0)\r\ntext=1;\r\nelse if (strcmp(*args,"-noout") == 0)\r\nnoout=1;\r\nelse\r\n{\r\ncipher = EVP_get_cipherbyname(*args + 1);\r\nif (!cipher)\r\n{\r\nBIO_printf(bio_err, "Unknown cipher %s\n",\r\n*args + 1);\r\nbadarg = 1;\r\n}\r\n}\r\nargs++;\r\n}\r\nif (badarg)\r\n{\r\nbad:\r\nBIO_printf(bio_err, "Usage pkey [options]\n");\r\nBIO_printf(bio_err, "where options are\n");\r\nBIO_printf(bio_err, "-in file input file\n");\r\nBIO_printf(bio_err, "-inform X input format (DER or PEM)\n");\r\nBIO_printf(bio_err, "-passin arg input file pass phrase source\n");\r\nBIO_printf(bio_err, "-outform X output format (DER or PEM)\n");\r\nBIO_printf(bio_err, "-out file output file\n");\r\nBIO_printf(bio_err, "-passout arg output file pass phrase source\n");\r\n#ifndef OPENSSL_NO_ENGINE\r\nBIO_printf(bio_err, "-engine e use engine e, possibly a hardware device.\n");\r\n#endif\r\nreturn 1;\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\ne = setup_engine(bio_err, engine, 0);\r\n#endif\r\nif (!app_passwd(bio_err, passargin, passargout, &passin, &passout))\r\n{\r\nBIO_printf(bio_err, "Error getting passwords\n");\r\ngoto end;\r\n}\r\nif (outfile)\r\n{\r\nif (!(out = BIO_new_file (outfile, "wb")))\r\n{\r\nBIO_printf(bio_err,\r\n"Can't open output file %s\n", outfile);\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nout = BIO_new_fp (stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nif (pubin)\r\npkey = load_pubkey(bio_err, infile, informat, 1,\r\npassin, e, "Public Key");\r\nelse\r\npkey = load_key(bio_err, infile, informat, 1,\r\npassin, e, "key");\r\nif (!pkey)\r\ngoto end;\r\nif (!noout)\r\n{\r\nif (outformat == FORMAT_PEM)\r\n{\r\nif (pubout)\r\nPEM_write_bio_PUBKEY(out,pkey);\r\nelse\r\nPEM_write_bio_PrivateKey(out, pkey, cipher,\r\nNULL, 0, NULL, passout);\r\n}\r\nelse if (outformat == FORMAT_ASN1)\r\n{\r\nif (pubout)\r\ni2d_PUBKEY_bio(out, pkey);\r\nelse\r\ni2d_PrivateKey_bio(out, pkey);\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\n}\r\nif (text)\r\n{\r\nif (pubtext)\r\nEVP_PKEY_print_public(out, pkey, 0, NULL);\r\nelse\r\nEVP_PKEY_print_private(out, pkey, 0, NULL);\r\n}\r\nret = 0;\r\nend:\r\nEVP_PKEY_free(pkey);\r\nBIO_free_all(out);\r\nBIO_free(in);\r\nif (passin)\r\nOPENSSL_free(passin);\r\nif (passout)\r\nOPENSSL_free(passout);\r\nreturn ret;\r\n}

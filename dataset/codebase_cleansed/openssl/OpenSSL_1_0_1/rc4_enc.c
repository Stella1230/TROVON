void RC4(RC4_KEY *key, size_t len, const unsigned char *indata,\r\nunsigned char *outdata)\r\n{\r\nregister RC4_INT *d;\r\nregister RC4_INT x,y,tx,ty;\r\nsize_t i;\r\nx=key->x;\r\ny=key->y;\r\nd=key->data;\r\n#if defined(RC4_CHUNK)\r\n# define RC4_STEP ( \\r\nx=(x+1) &0xff, \\r\ntx=d[x], \\r\ny=(tx+y)&0xff, \\r\nty=d[y], \\r\nd[y]=tx, \\r\nd[x]=ty, \\r\n(RC4_CHUNK)d[(tx+ty)&0xff]\\r\n)\r\nif ( ( ((size_t)indata & (sizeof(RC4_CHUNK)-1)) |\r\n((size_t)outdata & (sizeof(RC4_CHUNK)-1)) ) == 0 )\r\n{\r\nRC4_CHUNK ichunk,otp;\r\nconst union { long one; char little; } is_endian = {1};\r\nif (!is_endian.little)\r\n{\r\n# define BESHFT(c) (((sizeof(RC4_CHUNK)-(c)-1)*8)&(sizeof(RC4_CHUNK)*8-1))\r\nfor (;len&(0-sizeof(RC4_CHUNK));len-=sizeof(RC4_CHUNK))\r\n{\r\nichunk = *(RC4_CHUNK *)indata;\r\notp = RC4_STEP<<BESHFT(0);\r\notp |= RC4_STEP<<BESHFT(1);\r\notp |= RC4_STEP<<BESHFT(2);\r\notp |= RC4_STEP<<BESHFT(3);\r\nif (sizeof(RC4_CHUNK)==8)\r\n{\r\notp |= RC4_STEP<<BESHFT(4);\r\notp |= RC4_STEP<<BESHFT(5);\r\notp |= RC4_STEP<<BESHFT(6);\r\notp |= RC4_STEP<<BESHFT(7);\r\n}\r\n*(RC4_CHUNK *)outdata = otp^ichunk;\r\nindata += sizeof(RC4_CHUNK);\r\noutdata += sizeof(RC4_CHUNK);\r\n}\r\nif (len)\r\n{\r\nRC4_CHUNK mask=(RC4_CHUNK)-1, ochunk;\r\nichunk = *(RC4_CHUNK *)indata;\r\nochunk = *(RC4_CHUNK *)outdata;\r\notp = 0;\r\ni = BESHFT(0);\r\nmask <<= (sizeof(RC4_CHUNK)-len)<<3;\r\nswitch (len&(sizeof(RC4_CHUNK)-1))\r\n{\r\ncase 7: otp = RC4_STEP<<i, i-=8;\r\ncase 6: otp |= RC4_STEP<<i, i-=8;\r\ncase 5: otp |= RC4_STEP<<i, i-=8;\r\ncase 4: otp |= RC4_STEP<<i, i-=8;\r\ncase 3: otp |= RC4_STEP<<i, i-=8;\r\ncase 2: otp |= RC4_STEP<<i, i-=8;\r\ncase 1: otp |= RC4_STEP<<i, i-=8;\r\ncase 0: ;\r\n}\r\nochunk &= ~mask;\r\nochunk |= (otp^ichunk) & mask;\r\n*(RC4_CHUNK *)outdata = ochunk;\r\n}\r\nkey->x=x;\r\nkey->y=y;\r\nreturn;\r\n}\r\nelse\r\n{\r\n# define LESHFT(c) (((c)*8)&(sizeof(RC4_CHUNK)*8-1))\r\nfor (;len&(0-sizeof(RC4_CHUNK));len-=sizeof(RC4_CHUNK))\r\n{\r\nichunk = *(RC4_CHUNK *)indata;\r\notp = RC4_STEP;\r\notp |= RC4_STEP<<8;\r\notp |= RC4_STEP<<16;\r\notp |= RC4_STEP<<24;\r\nif (sizeof(RC4_CHUNK)==8)\r\n{\r\notp |= RC4_STEP<<LESHFT(4);\r\notp |= RC4_STEP<<LESHFT(5);\r\notp |= RC4_STEP<<LESHFT(6);\r\notp |= RC4_STEP<<LESHFT(7);\r\n}\r\n*(RC4_CHUNK *)outdata = otp^ichunk;\r\nindata += sizeof(RC4_CHUNK);\r\noutdata += sizeof(RC4_CHUNK);\r\n}\r\nif (len)\r\n{\r\nRC4_CHUNK mask=(RC4_CHUNK)-1, ochunk;\r\nichunk = *(RC4_CHUNK *)indata;\r\nochunk = *(RC4_CHUNK *)outdata;\r\notp = 0;\r\ni = 0;\r\nmask >>= (sizeof(RC4_CHUNK)-len)<<3;\r\nswitch (len&(sizeof(RC4_CHUNK)-1))\r\n{\r\ncase 7: otp = RC4_STEP, i+=8;\r\ncase 6: otp |= RC4_STEP<<i, i+=8;\r\ncase 5: otp |= RC4_STEP<<i, i+=8;\r\ncase 4: otp |= RC4_STEP<<i, i+=8;\r\ncase 3: otp |= RC4_STEP<<i, i+=8;\r\ncase 2: otp |= RC4_STEP<<i, i+=8;\r\ncase 1: otp |= RC4_STEP<<i, i+=8;\r\ncase 0: ;\r\n}\r\nochunk &= ~mask;\r\nochunk |= (otp^ichunk) & mask;\r\n*(RC4_CHUNK *)outdata = ochunk;\r\n}\r\nkey->x=x;\r\nkey->y=y;\r\nreturn;\r\n}\r\n}\r\n#endif\r\n#define LOOP(in,out) \\r\nx=((x+1)&0xff); \\r\ntx=d[x]; \\r\ny=(tx+y)&0xff; \\r\nd[x]=ty=d[y]; \\r\nd[y]=tx; \\r\n(out) = d[(tx+ty)&0xff]^ (in);\r\n#ifndef RC4_INDEX\r\n#define RC4_LOOP(a,b,i) LOOP(*((a)++),*((b)++))\r\n#else\r\n#define RC4_LOOP(a,b,i) LOOP(a[i],b[i])\r\n#endif\r\ni=len>>3;\r\nif (i)\r\n{\r\nfor (;;)\r\n{\r\nRC4_LOOP(indata,outdata,0);\r\nRC4_LOOP(indata,outdata,1);\r\nRC4_LOOP(indata,outdata,2);\r\nRC4_LOOP(indata,outdata,3);\r\nRC4_LOOP(indata,outdata,4);\r\nRC4_LOOP(indata,outdata,5);\r\nRC4_LOOP(indata,outdata,6);\r\nRC4_LOOP(indata,outdata,7);\r\n#ifdef RC4_INDEX\r\nindata+=8;\r\noutdata+=8;\r\n#endif\r\nif (--i == 0) break;\r\n}\r\n}\r\ni=len&0x07;\r\nif (i)\r\n{\r\nfor (;;)\r\n{\r\nRC4_LOOP(indata,outdata,0); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,1); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,2); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,3); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,4); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,5); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,6); if (--i == 0) break;\r\n}\r\n}\r\nkey->x=x;\r\nkey->y=y;\r\n}

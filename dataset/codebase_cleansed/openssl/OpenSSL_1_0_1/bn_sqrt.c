BIGNUM *BN_mod_sqrt(BIGNUM *in, const BIGNUM *a, const BIGNUM *p, BN_CTX *ctx)\r\n{\r\nBIGNUM *ret = in;\r\nint err = 1;\r\nint r;\r\nBIGNUM *A, *b, *q, *t, *x, *y;\r\nint e, i, j;\r\nif (!BN_is_odd(p) || BN_abs_is_word(p, 1))\r\n{\r\nif (BN_abs_is_word(p, 2))\r\n{\r\nif (ret == NULL)\r\nret = BN_new();\r\nif (ret == NULL)\r\ngoto end;\r\nif (!BN_set_word(ret, BN_is_bit_set(a, 0)))\r\n{\r\nif (ret != in)\r\nBN_free(ret);\r\nreturn NULL;\r\n}\r\nbn_check_top(ret);\r\nreturn ret;\r\n}\r\nBNerr(BN_F_BN_MOD_SQRT, BN_R_P_IS_NOT_PRIME);\r\nreturn(NULL);\r\n}\r\nif (BN_is_zero(a) || BN_is_one(a))\r\n{\r\nif (ret == NULL)\r\nret = BN_new();\r\nif (ret == NULL)\r\ngoto end;\r\nif (!BN_set_word(ret, BN_is_one(a)))\r\n{\r\nif (ret != in)\r\nBN_free(ret);\r\nreturn NULL;\r\n}\r\nbn_check_top(ret);\r\nreturn ret;\r\n}\r\nBN_CTX_start(ctx);\r\nA = BN_CTX_get(ctx);\r\nb = BN_CTX_get(ctx);\r\nq = BN_CTX_get(ctx);\r\nt = BN_CTX_get(ctx);\r\nx = BN_CTX_get(ctx);\r\ny = BN_CTX_get(ctx);\r\nif (y == NULL) goto end;\r\nif (ret == NULL)\r\nret = BN_new();\r\nif (ret == NULL) goto end;\r\nif (!BN_nnmod(A, a, p, ctx)) goto end;\r\ne = 1;\r\nwhile (!BN_is_bit_set(p, e))\r\ne++;\r\nif (e == 1)\r\n{\r\nif (!BN_rshift(q, p, 2)) goto end;\r\nq->neg = 0;\r\nif (!BN_add_word(q, 1)) goto end;\r\nif (!BN_mod_exp(ret, A, q, p, ctx)) goto end;\r\nerr = 0;\r\ngoto vrfy;\r\n}\r\nif (e == 2)\r\n{\r\nif (!BN_mod_lshift1_quick(t, A, p)) goto end;\r\nif (!BN_rshift(q, p, 3)) goto end;\r\nq->neg = 0;\r\nif (!BN_mod_exp(b, t, q, p, ctx)) goto end;\r\nif (!BN_mod_sqr(y, b, p, ctx)) goto end;\r\nif (!BN_mod_mul(t, t, y, p, ctx)) goto end;\r\nif (!BN_sub_word(t, 1)) goto end;\r\nif (!BN_mod_mul(x, A, b, p, ctx)) goto end;\r\nif (!BN_mod_mul(x, x, t, p, ctx)) goto end;\r\nif (!BN_copy(ret, x)) goto end;\r\nerr = 0;\r\ngoto vrfy;\r\n}\r\nif (!BN_copy(q, p)) goto end;\r\nq->neg = 0;\r\ni = 2;\r\ndo\r\n{\r\nif (i < 22)\r\n{\r\nif (!BN_set_word(y, i)) goto end;\r\n}\r\nelse\r\n{\r\nif (!BN_pseudo_rand(y, BN_num_bits(p), 0, 0)) goto end;\r\nif (BN_ucmp(y, p) >= 0)\r\n{\r\nif (!(p->neg ? BN_add : BN_sub)(y, y, p)) goto end;\r\n}\r\nif (BN_is_zero(y))\r\nif (!BN_set_word(y, i)) goto end;\r\n}\r\nr = BN_kronecker(y, q, ctx);\r\nif (r < -1) goto end;\r\nif (r == 0)\r\n{\r\nBNerr(BN_F_BN_MOD_SQRT, BN_R_P_IS_NOT_PRIME);\r\ngoto end;\r\n}\r\n}\r\nwhile (r == 1 && ++i < 82);\r\nif (r != -1)\r\n{\r\nBNerr(BN_F_BN_MOD_SQRT, BN_R_TOO_MANY_ITERATIONS);\r\ngoto end;\r\n}\r\nif (!BN_rshift(q, q, e)) goto end;\r\nif (!BN_mod_exp(y, y, q, p, ctx)) goto end;\r\nif (BN_is_one(y))\r\n{\r\nBNerr(BN_F_BN_MOD_SQRT, BN_R_P_IS_NOT_PRIME);\r\ngoto end;\r\n}\r\nif (!BN_rshift1(t, q)) goto end;\r\nif (BN_is_zero(t))\r\n{\r\nif (!BN_nnmod(t, A, p, ctx)) goto end;\r\nif (BN_is_zero(t))\r\n{\r\nBN_zero(ret);\r\nerr = 0;\r\ngoto end;\r\n}\r\nelse\r\nif (!BN_one(x)) goto end;\r\n}\r\nelse\r\n{\r\nif (!BN_mod_exp(x, A, t, p, ctx)) goto end;\r\nif (BN_is_zero(x))\r\n{\r\nBN_zero(ret);\r\nerr = 0;\r\ngoto end;\r\n}\r\n}\r\nif (!BN_mod_sqr(b, x, p, ctx)) goto end;\r\nif (!BN_mod_mul(b, b, A, p, ctx)) goto end;\r\nif (!BN_mod_mul(x, x, A, p, ctx)) goto end;\r\nwhile (1)\r\n{\r\nif (BN_is_one(b))\r\n{\r\nif (!BN_copy(ret, x)) goto end;\r\nerr = 0;\r\ngoto vrfy;\r\n}\r\ni = 1;\r\nif (!BN_mod_sqr(t, b, p, ctx)) goto end;\r\nwhile (!BN_is_one(t))\r\n{\r\ni++;\r\nif (i == e)\r\n{\r\nBNerr(BN_F_BN_MOD_SQRT, BN_R_NOT_A_SQUARE);\r\ngoto end;\r\n}\r\nif (!BN_mod_mul(t, t, t, p, ctx)) goto end;\r\n}\r\nif (!BN_copy(t, y)) goto end;\r\nfor (j = e - i - 1; j > 0; j--)\r\n{\r\nif (!BN_mod_sqr(t, t, p, ctx)) goto end;\r\n}\r\nif (!BN_mod_mul(y, t, t, p, ctx)) goto end;\r\nif (!BN_mod_mul(x, x, t, p, ctx)) goto end;\r\nif (!BN_mod_mul(b, b, y, p, ctx)) goto end;\r\ne = i;\r\n}\r\nvrfy:\r\nif (!err)\r\n{\r\nif (!BN_mod_sqr(x, ret, p, ctx))\r\nerr = 1;\r\nif (!err && 0 != BN_cmp(x, A))\r\n{\r\nBNerr(BN_F_BN_MOD_SQRT, BN_R_NOT_A_SQUARE);\r\nerr = 1;\r\n}\r\n}\r\nend:\r\nif (err)\r\n{\r\nif (ret != NULL && ret != in)\r\n{\r\nBN_clear_free(ret);\r\n}\r\nret = NULL;\r\n}\r\nBN_CTX_end(ctx);\r\nbn_check_top(ret);\r\nreturn ret;\r\n}

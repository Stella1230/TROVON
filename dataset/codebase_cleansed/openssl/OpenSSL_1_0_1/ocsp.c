int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nchar **args;\r\nchar *host = NULL, *port = NULL, *path = "/";\r\nchar *reqin = NULL, *respin = NULL;\r\nchar *reqout = NULL, *respout = NULL;\r\nchar *signfile = NULL, *keyfile = NULL;\r\nchar *rsignfile = NULL, *rkeyfile = NULL;\r\nchar *outfile = NULL;\r\nint add_nonce = 1, noverify = 0, use_ssl = -1;\r\nSTACK_OF(CONF_VALUE) *headers = NULL;\r\nOCSP_REQUEST *req = NULL;\r\nOCSP_RESPONSE *resp = NULL;\r\nOCSP_BASICRESP *bs = NULL;\r\nX509 *issuer = NULL, *cert = NULL;\r\nX509 *signer = NULL, *rsigner = NULL;\r\nEVP_PKEY *key = NULL, *rkey = NULL;\r\nBIO *acbio = NULL, *cbio = NULL;\r\nBIO *derbio = NULL;\r\nBIO *out = NULL;\r\nint req_timeout = -1;\r\nint req_text = 0, resp_text = 0;\r\nlong nsec = MAX_VALIDITY_PERIOD, maxage = -1;\r\nchar *CAfile = NULL, *CApath = NULL;\r\nX509_STORE *store = NULL;\r\nSTACK_OF(X509) *sign_other = NULL, *verify_other = NULL, *rother = NULL;\r\nchar *sign_certfile = NULL, *verify_certfile = NULL, *rcertfile = NULL;\r\nunsigned long sign_flags = 0, verify_flags = 0, rflags = 0;\r\nint ret = 1;\r\nint accept_count = -1;\r\nint badarg = 0;\r\nint i;\r\nint ignore_err = 0;\r\nSTACK_OF(OPENSSL_STRING) *reqnames = NULL;\r\nSTACK_OF(OCSP_CERTID) *ids = NULL;\r\nX509 *rca_cert = NULL;\r\nchar *ridx_filename = NULL;\r\nchar *rca_filename = NULL;\r\nCA_DB *rdb = NULL;\r\nint nmin = 0, ndays = -1;\r\nconst EVP_MD *cert_id_md = NULL;\r\nif (bio_err == NULL) bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\nSSL_load_error_strings();\r\nOpenSSL_add_ssl_algorithms();\r\nargs = argv + 1;\r\nreqnames = sk_OPENSSL_STRING_new_null();\r\nids = sk_OCSP_CERTID_new_null();\r\nwhile (!badarg && *args && *args[0] == '-')\r\n{\r\nif (!strcmp(*args, "-out"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-timeout"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nreq_timeout = atol(*args);\r\nif (req_timeout < 0)\r\n{\r\nBIO_printf(bio_err,\r\n"Illegal timeout value %s\n",\r\n*args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-url"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nif (!OCSP_parse_url(*args, &host, &port, &path, &use_ssl))\r\n{\r\nBIO_printf(bio_err, "Error parsing URL\n");\r\nbadarg = 1;\r\n}\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-host"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nhost = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-port"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nport = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-header"))\r\n{\r\nif (args[1] && args[2])\r\n{\r\nif (!X509V3_add_value(args[1], args[2], &headers))\r\ngoto end;\r\nargs += 2;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-ignore_err"))\r\nignore_err = 1;\r\nelse if (!strcmp(*args, "-noverify"))\r\nnoverify = 1;\r\nelse if (!strcmp(*args, "-nonce"))\r\nadd_nonce = 2;\r\nelse if (!strcmp(*args, "-no_nonce"))\r\nadd_nonce = 0;\r\nelse if (!strcmp(*args, "-resp_no_certs"))\r\nrflags |= OCSP_NOCERTS;\r\nelse if (!strcmp(*args, "-resp_key_id"))\r\nrflags |= OCSP_RESPID_KEY;\r\nelse if (!strcmp(*args, "-no_certs"))\r\nsign_flags |= OCSP_NOCERTS;\r\nelse if (!strcmp(*args, "-no_signature_verify"))\r\nverify_flags |= OCSP_NOSIGS;\r\nelse if (!strcmp(*args, "-no_cert_verify"))\r\nverify_flags |= OCSP_NOVERIFY;\r\nelse if (!strcmp(*args, "-no_chain"))\r\nverify_flags |= OCSP_NOCHAIN;\r\nelse if (!strcmp(*args, "-no_cert_checks"))\r\nverify_flags |= OCSP_NOCHECKS;\r\nelse if (!strcmp(*args, "-no_explicit"))\r\nverify_flags |= OCSP_NOEXPLICIT;\r\nelse if (!strcmp(*args, "-trust_other"))\r\nverify_flags |= OCSP_TRUSTOTHER;\r\nelse if (!strcmp(*args, "-no_intern"))\r\nverify_flags |= OCSP_NOINTERN;\r\nelse if (!strcmp(*args, "-text"))\r\n{\r\nreq_text = 1;\r\nresp_text = 1;\r\n}\r\nelse if (!strcmp(*args, "-req_text"))\r\nreq_text = 1;\r\nelse if (!strcmp(*args, "-resp_text"))\r\nresp_text = 1;\r\nelse if (!strcmp(*args, "-reqin"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nreqin = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-respin"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nrespin = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-signer"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nsignfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-VAfile"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nverify_certfile = *args;\r\nverify_flags |= OCSP_TRUSTOTHER;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-sign_other"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nsign_certfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-verify_other"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nverify_certfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-CAfile"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nCAfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-CApath"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nCApath = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-validity_period"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nnsec = atol(*args);\r\nif (nsec < 0)\r\n{\r\nBIO_printf(bio_err,\r\n"Illegal validity period %s\n",\r\n*args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-status_age"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nmaxage = atol(*args);\r\nif (maxage < 0)\r\n{\r\nBIO_printf(bio_err,\r\n"Illegal validity age %s\n",\r\n*args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-signkey"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nkeyfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-reqout"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nreqout = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-respout"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nrespout = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-path"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\npath = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-issuer"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nX509_free(issuer);\r\nissuer = load_cert(bio_err, *args, FORMAT_PEM,\r\nNULL, e, "issuer certificate");\r\nif(!issuer) goto end;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-cert"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nX509_free(cert);\r\ncert = load_cert(bio_err, *args, FORMAT_PEM,\r\nNULL, e, "certificate");\r\nif(!cert) goto end;\r\nif (!cert_id_md) cert_id_md = EVP_sha1();\r\nif(!add_ocsp_cert(&req, cert, cert_id_md, issuer, ids))\r\ngoto end;\r\nif(!sk_OPENSSL_STRING_push(reqnames, *args))\r\ngoto end;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-serial"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nif (!cert_id_md) cert_id_md = EVP_sha1();\r\nif(!add_ocsp_serial(&req, *args, cert_id_md, issuer, ids))\r\ngoto end;\r\nif(!sk_OPENSSL_STRING_push(reqnames, *args))\r\ngoto end;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-index"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nridx_filename = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-CA"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nrca_filename = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-nmin"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nnmin = atol(*args);\r\nif (nmin < 0)\r\n{\r\nBIO_printf(bio_err,\r\n"Illegal update period %s\n",\r\n*args);\r\nbadarg = 1;\r\n}\r\n}\r\nif (ndays == -1)\r\nndays = 0;\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-nrequest"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\naccept_count = atol(*args);\r\nif (accept_count < 0)\r\n{\r\nBIO_printf(bio_err,\r\n"Illegal accept count %s\n",\r\n*args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp (*args, "-ndays"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nndays = atol(*args);\r\nif (ndays < 0)\r\n{\r\nBIO_printf(bio_err,\r\n"Illegal update period %s\n",\r\n*args);\r\nbadarg = 1;\r\n}\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-rsigner"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nrsignfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-rkey"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nrkeyfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args, "-rother"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\nrcertfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if ((cert_id_md = EVP_get_digestbyname((*args)+1))==NULL)\r\n{\r\nbadarg = 1;\r\n}\r\nargs++;\r\n}\r\nif (!req && !reqin && !respin && !(port && ridx_filename)) badarg = 1;\r\nif (badarg)\r\n{\r\nBIO_printf (bio_err, "OCSP utility\n");\r\nBIO_printf (bio_err, "Usage ocsp [options]\n");\r\nBIO_printf (bio_err, "where options are\n");\r\nBIO_printf (bio_err, "-out file output filename\n");\r\nBIO_printf (bio_err, "-issuer file issuer certificate\n");\r\nBIO_printf (bio_err, "-cert file certificate to check\n");\r\nBIO_printf (bio_err, "-serial n serial number to check\n");\r\nBIO_printf (bio_err, "-signer file certificate to sign OCSP request with\n");\r\nBIO_printf (bio_err, "-signkey file private key to sign OCSP request with\n");\r\nBIO_printf (bio_err, "-sign_other file additional certificates to include in signed request\n");\r\nBIO_printf (bio_err, "-no_certs don't include any certificates in signed request\n");\r\nBIO_printf (bio_err, "-req_text print text form of request\n");\r\nBIO_printf (bio_err, "-resp_text print text form of response\n");\r\nBIO_printf (bio_err, "-text print text form of request and response\n");\r\nBIO_printf (bio_err, "-reqout file write DER encoded OCSP request to \"file\"\n");\r\nBIO_printf (bio_err, "-respout file write DER encoded OCSP reponse to \"file\"\n");\r\nBIO_printf (bio_err, "-reqin file read DER encoded OCSP request from \"file\"\n");\r\nBIO_printf (bio_err, "-respin file read DER encoded OCSP reponse from \"file\"\n");\r\nBIO_printf (bio_err, "-nonce add OCSP nonce to request\n");\r\nBIO_printf (bio_err, "-no_nonce don't add OCSP nonce to request\n");\r\nBIO_printf (bio_err, "-url URL OCSP responder URL\n");\r\nBIO_printf (bio_err, "-host host:n send OCSP request to host on port n\n");\r\nBIO_printf (bio_err, "-path path to use in OCSP request\n");\r\nBIO_printf (bio_err, "-CApath dir trusted certificates directory\n");\r\nBIO_printf (bio_err, "-CAfile file trusted certificates file\n");\r\nBIO_printf (bio_err, "-VAfile file validator certificates file\n");\r\nBIO_printf (bio_err, "-validity_period n maximum validity discrepancy in seconds\n");\r\nBIO_printf (bio_err, "-status_age n maximum status age in seconds\n");\r\nBIO_printf (bio_err, "-noverify don't verify response at all\n");\r\nBIO_printf (bio_err, "-verify_other file additional certificates to search for signer\n");\r\nBIO_printf (bio_err, "-trust_other don't verify additional certificates\n");\r\nBIO_printf (bio_err, "-no_intern don't search certificates contained in response for signer\n");\r\nBIO_printf (bio_err, "-no_signature_verify don't check signature on response\n");\r\nBIO_printf (bio_err, "-no_cert_verify don't check signing certificate\n");\r\nBIO_printf (bio_err, "-no_chain don't chain verify response\n");\r\nBIO_printf (bio_err, "-no_cert_checks don't do additional checks on signing certificate\n");\r\nBIO_printf (bio_err, "-port num port to run responder on\n");\r\nBIO_printf (bio_err, "-index file certificate status index file\n");\r\nBIO_printf (bio_err, "-CA file CA certificate\n");\r\nBIO_printf (bio_err, "-rsigner file responder certificate to sign responses with\n");\r\nBIO_printf (bio_err, "-rkey file responder key to sign responses with\n");\r\nBIO_printf (bio_err, "-rother file other certificates to include in response\n");\r\nBIO_printf (bio_err, "-resp_no_certs don't include any certificates in response\n");\r\nBIO_printf (bio_err, "-nmin n number of minutes before next update\n");\r\nBIO_printf (bio_err, "-ndays n number of days before next update\n");\r\nBIO_printf (bio_err, "-resp_key_id identify reponse by signing certificate key ID\n");\r\nBIO_printf (bio_err, "-nrequest n number of requests to accept (default unlimited)\n");\r\nBIO_printf (bio_err, "-<dgst alg> use specified digest in the request");\r\ngoto end;\r\n}\r\nif(outfile) out = BIO_new_file(outfile, "w");\r\nelse out = BIO_new_fp(stdout, BIO_NOCLOSE);\r\nif(!out)\r\n{\r\nBIO_printf(bio_err, "Error opening output file\n");\r\ngoto end;\r\n}\r\nif (!req && (add_nonce != 2)) add_nonce = 0;\r\nif (!req && reqin)\r\n{\r\nderbio = BIO_new_file(reqin, "rb");\r\nif (!derbio)\r\n{\r\nBIO_printf(bio_err, "Error Opening OCSP request file\n");\r\ngoto end;\r\n}\r\nreq = d2i_OCSP_REQUEST_bio(derbio, NULL);\r\nBIO_free(derbio);\r\nif(!req)\r\n{\r\nBIO_printf(bio_err, "Error reading OCSP request\n");\r\ngoto end;\r\n}\r\n}\r\nif (!req && port)\r\n{\r\nacbio = init_responder(port);\r\nif (!acbio)\r\ngoto end;\r\n}\r\nif (rsignfile && !rdb)\r\n{\r\nif (!rkeyfile) rkeyfile = rsignfile;\r\nrsigner = load_cert(bio_err, rsignfile, FORMAT_PEM,\r\nNULL, e, "responder certificate");\r\nif (!rsigner)\r\n{\r\nBIO_printf(bio_err, "Error loading responder certificate\n");\r\ngoto end;\r\n}\r\nrca_cert = load_cert(bio_err, rca_filename, FORMAT_PEM,\r\nNULL, e, "CA certificate");\r\nif (rcertfile)\r\n{\r\nrother = load_certs(bio_err, rcertfile, FORMAT_PEM,\r\nNULL, e, "responder other certificates");\r\nif (!rother) goto end;\r\n}\r\nrkey = load_key(bio_err, rkeyfile, FORMAT_PEM, 0, NULL, NULL,\r\n"responder private key");\r\nif (!rkey)\r\ngoto end;\r\n}\r\nif(acbio)\r\nBIO_printf(bio_err, "Waiting for OCSP client connections...\n");\r\nredo_accept:\r\nif (acbio)\r\n{\r\nif (!do_responder(&req, &cbio, acbio, port))\r\ngoto end;\r\nif (!req)\r\n{\r\nresp = OCSP_response_create(OCSP_RESPONSE_STATUS_MALFORMEDREQUEST, NULL);\r\nsend_ocsp_response(cbio, resp);\r\ngoto done_resp;\r\n}\r\n}\r\nif (!req && (signfile || reqout || host || add_nonce || ridx_filename))\r\n{\r\nBIO_printf(bio_err, "Need an OCSP request for this operation!\n");\r\ngoto end;\r\n}\r\nif (req && add_nonce) OCSP_request_add1_nonce(req, NULL, -1);\r\nif (signfile)\r\n{\r\nif (!keyfile) keyfile = signfile;\r\nsigner = load_cert(bio_err, signfile, FORMAT_PEM,\r\nNULL, e, "signer certificate");\r\nif (!signer)\r\n{\r\nBIO_printf(bio_err, "Error loading signer certificate\n");\r\ngoto end;\r\n}\r\nif (sign_certfile)\r\n{\r\nsign_other = load_certs(bio_err, sign_certfile, FORMAT_PEM,\r\nNULL, e, "signer certificates");\r\nif (!sign_other) goto end;\r\n}\r\nkey = load_key(bio_err, keyfile, FORMAT_PEM, 0, NULL, NULL,\r\n"signer private key");\r\nif (!key)\r\ngoto end;\r\nif (!OCSP_request_sign(req, signer, key, NULL, sign_other, sign_flags))\r\n{\r\nBIO_printf(bio_err, "Error signing OCSP request\n");\r\ngoto end;\r\n}\r\n}\r\nif (req_text && req) OCSP_REQUEST_print(out, req, 0);\r\nif (reqout)\r\n{\r\nderbio = BIO_new_file(reqout, "wb");\r\nif(!derbio)\r\n{\r\nBIO_printf(bio_err, "Error opening file %s\n", reqout);\r\ngoto end;\r\n}\r\ni2d_OCSP_REQUEST_bio(derbio, req);\r\nBIO_free(derbio);\r\n}\r\nif (ridx_filename && (!rkey || !rsigner || !rca_cert))\r\n{\r\nBIO_printf(bio_err, "Need a responder certificate, key and CA for this operation!\n");\r\ngoto end;\r\n}\r\nif (ridx_filename && !rdb)\r\n{\r\nrdb = load_index(ridx_filename, NULL);\r\nif (!rdb) goto end;\r\nif (!index_index(rdb)) goto end;\r\n}\r\nif (rdb)\r\n{\r\ni = make_ocsp_response(&resp, req, rdb, rca_cert, rsigner, rkey, rother, rflags, nmin, ndays);\r\nif (cbio)\r\nsend_ocsp_response(cbio, resp);\r\n}\r\nelse if (host)\r\n{\r\n#ifndef OPENSSL_NO_SOCK\r\nresp = process_responder(bio_err, req, host, path,\r\nport, use_ssl, headers, req_timeout);\r\nif (!resp)\r\ngoto end;\r\n#else\r\nBIO_printf(bio_err, "Error creating connect BIO - sockets not supported.\n");\r\ngoto end;\r\n#endif\r\n}\r\nelse if (respin)\r\n{\r\nderbio = BIO_new_file(respin, "rb");\r\nif (!derbio)\r\n{\r\nBIO_printf(bio_err, "Error Opening OCSP response file\n");\r\ngoto end;\r\n}\r\nresp = d2i_OCSP_RESPONSE_bio(derbio, NULL);\r\nBIO_free(derbio);\r\nif(!resp)\r\n{\r\nBIO_printf(bio_err, "Error reading OCSP response\n");\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nret = 0;\r\ngoto end;\r\n}\r\ndone_resp:\r\nif (respout)\r\n{\r\nderbio = BIO_new_file(respout, "wb");\r\nif(!derbio)\r\n{\r\nBIO_printf(bio_err, "Error opening file %s\n", respout);\r\ngoto end;\r\n}\r\ni2d_OCSP_RESPONSE_bio(derbio, resp);\r\nBIO_free(derbio);\r\n}\r\ni = OCSP_response_status(resp);\r\nif (i != OCSP_RESPONSE_STATUS_SUCCESSFUL)\r\n{\r\nBIO_printf(out, "Responder Error: %s (%d)\n",\r\nOCSP_response_status_str(i), i);\r\nif (ignore_err)\r\ngoto redo_accept;\r\nret = 0;\r\ngoto end;\r\n}\r\nif (resp_text) OCSP_RESPONSE_print(out, resp, 0);\r\nif (cbio)\r\n{\r\nif (accept_count > 0)\r\naccept_count--;\r\nif (accept_count)\r\n{\r\nBIO_free_all(cbio);\r\ncbio = NULL;\r\nOCSP_REQUEST_free(req);\r\nreq = NULL;\r\nOCSP_RESPONSE_free(resp);\r\nresp = NULL;\r\ngoto redo_accept;\r\n}\r\ngoto end;\r\n}\r\nif (!store)\r\nstore = setup_verify(bio_err, CAfile, CApath);\r\nif (!store)\r\ngoto end;\r\nif (verify_certfile)\r\n{\r\nverify_other = load_certs(bio_err, verify_certfile, FORMAT_PEM,\r\nNULL, e, "validator certificate");\r\nif (!verify_other) goto end;\r\n}\r\nbs = OCSP_response_get1_basic(resp);\r\nif (!bs)\r\n{\r\nBIO_printf(bio_err, "Error parsing response\n");\r\ngoto end;\r\n}\r\nif (!noverify)\r\n{\r\nif (req && ((i = OCSP_check_nonce(req, bs)) <= 0))\r\n{\r\nif (i == -1)\r\nBIO_printf(bio_err, "WARNING: no nonce in response\n");\r\nelse\r\n{\r\nBIO_printf(bio_err, "Nonce Verify error\n");\r\ngoto end;\r\n}\r\n}\r\ni = OCSP_basic_verify(bs, verify_other, store, verify_flags);\r\nif (i < 0) i = OCSP_basic_verify(bs, NULL, store, 0);\r\nif(i <= 0)\r\n{\r\nBIO_printf(bio_err, "Response Verify Failure\n");\r\nERR_print_errors(bio_err);\r\n}\r\nelse\r\nBIO_printf(bio_err, "Response verify OK\n");\r\n}\r\nif (!print_ocsp_summary(out, bs, req, reqnames, ids, nsec, maxage))\r\ngoto end;\r\nret = 0;\r\nend:\r\nERR_print_errors(bio_err);\r\nX509_free(signer);\r\nX509_STORE_free(store);\r\nEVP_PKEY_free(key);\r\nEVP_PKEY_free(rkey);\r\nX509_free(issuer);\r\nX509_free(cert);\r\nX509_free(rsigner);\r\nX509_free(rca_cert);\r\nfree_index(rdb);\r\nBIO_free_all(cbio);\r\nBIO_free_all(acbio);\r\nBIO_free(out);\r\nOCSP_REQUEST_free(req);\r\nOCSP_RESPONSE_free(resp);\r\nOCSP_BASICRESP_free(bs);\r\nsk_OPENSSL_STRING_free(reqnames);\r\nsk_OCSP_CERTID_free(ids);\r\nsk_X509_pop_free(sign_other, X509_free);\r\nsk_X509_pop_free(verify_other, X509_free);\r\nsk_CONF_VALUE_pop_free(headers, X509V3_conf_free);\r\nif (use_ssl != -1)\r\n{\r\nOPENSSL_free(host);\r\nOPENSSL_free(port);\r\nOPENSSL_free(path);\r\n}\r\nOPENSSL_EXIT(ret);\r\n}\r\nstatic char **lookup_serial(CA_DB *db, ASN1_INTEGER *ser)\r\n{\r\nint i;\r\nBIGNUM *bn = NULL;\r\nchar *itmp, *row[DB_NUMBER],**rrow;\r\nfor (i = 0; i < DB_NUMBER; i++) row[i] = NULL;\r\nbn = ASN1_INTEGER_to_BN(ser,NULL);\r\nOPENSSL_assert(bn);\r\nif (BN_is_zero(bn))\r\nitmp = BUF_strdup("00");\r\nelse\r\nitmp = BN_bn2hex(bn);\r\nrow[DB_serial] = itmp;\r\nBN_free(bn);\r\nrrow=TXT_DB_get_by_index(db->db,DB_serial,row);\r\nOPENSSL_free(itmp);\r\nreturn rrow;\r\n}\r\nstatic BIO *init_responder(char *port)\r\n{\r\nBIO *acbio = NULL, *bufbio = NULL;\r\nbufbio = BIO_new(BIO_f_buffer());\r\nif (!bufbio)\r\ngoto err;\r\n#ifndef OPENSSL_NO_SOCK\r\nacbio = BIO_new_accept(port);\r\n#else\r\nBIO_printf(bio_err, "Error setting up accept BIO - sockets not supported.\n");\r\n#endif\r\nif (!acbio)\r\ngoto err;\r\nBIO_set_accept_bios(acbio, bufbio);\r\nbufbio = NULL;\r\nif (BIO_do_accept(acbio) <= 0)\r\n{\r\nBIO_printf(bio_err, "Error setting up accept BIO\n");\r\nERR_print_errors(bio_err);\r\ngoto err;\r\n}\r\nreturn acbio;\r\nerr:\r\nBIO_free_all(acbio);\r\nBIO_free(bufbio);\r\nreturn NULL;\r\n}\r\nstatic int do_responder(OCSP_REQUEST **preq, BIO **pcbio, BIO *acbio, char *port)\r\n{\r\nint have_post = 0, len;\r\nOCSP_REQUEST *req = NULL;\r\nchar inbuf[1024];\r\nBIO *cbio = NULL;\r\nif (BIO_do_accept(acbio) <= 0)\r\n{\r\nBIO_printf(bio_err, "Error accepting connection\n");\r\nERR_print_errors(bio_err);\r\nreturn 0;\r\n}\r\ncbio = BIO_pop(acbio);\r\n*pcbio = cbio;\r\nfor(;;)\r\n{\r\nlen = BIO_gets(cbio, inbuf, sizeof inbuf);\r\nif (len <= 0)\r\nreturn 1;\r\nif (!have_post)\r\n{\r\nif(strncmp(inbuf, "POST", 4))\r\n{\r\nBIO_printf(bio_err, "Invalid request\n");\r\nreturn 1;\r\n}\r\nhave_post = 1;\r\n}\r\nif ((inbuf[0] == '\r') || (inbuf[0] == '\n'))\r\nbreak;\r\n}\r\nreq = d2i_OCSP_REQUEST_bio(cbio, NULL);\r\nif (!req)\r\n{\r\nBIO_printf(bio_err, "Error parsing OCSP request\n");\r\nERR_print_errors(bio_err);\r\n}\r\n*preq = req;\r\nreturn 1;\r\n}\r\nstatic int send_ocsp_response(BIO *cbio, OCSP_RESPONSE *resp)\r\n{\r\nchar http_resp[] =\r\n"HTTP/1.0 200 OK\r\nContent-type: application/ocsp-response\r\n"\r\n"Content-Length: %d\r\n\r\n";\r\nif (!cbio)\r\nreturn 0;\r\nBIO_printf(cbio, http_resp, i2d_OCSP_RESPONSE(resp, NULL));\r\ni2d_OCSP_RESPONSE_bio(cbio, resp);\r\n(void)BIO_flush(cbio);\r\nreturn 1;\r\n}

static void identity(char *ptr)\r\n{\r\nreturn;\r\n}\r\nstatic int append_buf(char **buf, const char *s, int *size, int step)\r\n{\r\nint l = strlen(s);\r\nif (*buf == NULL)\r\n{\r\n*size = step;\r\n*buf = OPENSSL_malloc(*size);\r\nif (*buf == NULL)\r\nreturn 0;\r\n**buf = '\0';\r\n}\r\nif (**buf != '\0')\r\nl += 2;\r\nif (strlen(*buf) + strlen(s) >= (unsigned int)*size)\r\n{\r\n*size += step;\r\n*buf = OPENSSL_realloc(*buf, *size);\r\n}\r\nif (*buf == NULL)\r\nreturn 0;\r\nif (**buf != '\0')\r\nBUF_strlcat(*buf, ", ", *size);\r\nBUF_strlcat(*buf, s, *size);\r\nreturn 1;\r\n}\r\nstatic int util_flags(BIO *bio_out, unsigned int flags, const char *indent)\r\n{\r\nint started = 0, err = 0;\r\nBIO_printf(bio_out, "%s%s(input flags): ", indent, indent);\r\nif(flags == 0)\r\n{\r\nBIO_printf(bio_out, "<no flags>\n");\r\nreturn 1;\r\n}\r\nif(flags & ENGINE_CMD_FLAG_INTERNAL)\r\n{\r\nBIO_printf(bio_out, "[Internal] ");\r\n}\r\nif(flags & ENGINE_CMD_FLAG_NUMERIC)\r\n{\r\nBIO_printf(bio_out, "NUMERIC");\r\nstarted = 1;\r\n}\r\nif(flags & ENGINE_CMD_FLAG_STRING)\r\n{\r\nif(started)\r\n{\r\nBIO_printf(bio_out, "|");\r\nerr = 1;\r\n}\r\nBIO_printf(bio_out, "STRING");\r\nstarted = 1;\r\n}\r\nif(flags & ENGINE_CMD_FLAG_NO_INPUT)\r\n{\r\nif(started)\r\n{\r\nBIO_printf(bio_out, "|");\r\nerr = 1;\r\n}\r\nBIO_printf(bio_out, "NO_INPUT");\r\nstarted = 1;\r\n}\r\nflags = flags & ~ENGINE_CMD_FLAG_NUMERIC &\r\n~ENGINE_CMD_FLAG_STRING &\r\n~ENGINE_CMD_FLAG_NO_INPUT &\r\n~ENGINE_CMD_FLAG_INTERNAL;\r\nif(flags)\r\n{\r\nif(started) BIO_printf(bio_out, "|");\r\nBIO_printf(bio_out, "<0x%04X>", flags);\r\n}\r\nif(err)\r\nBIO_printf(bio_out, " <illegal flags!>");\r\nBIO_printf(bio_out, "\n");\r\nreturn 1;\r\n}\r\nstatic int util_verbose(ENGINE *e, int verbose, BIO *bio_out, const char *indent)\r\n{\r\nstatic const int line_wrap = 78;\r\nint num;\r\nint ret = 0;\r\nchar *name = NULL;\r\nchar *desc = NULL;\r\nint flags;\r\nint xpos = 0;\r\nSTACK_OF(OPENSSL_STRING) *cmds = NULL;\r\nif(!ENGINE_ctrl(e, ENGINE_CTRL_HAS_CTRL_FUNCTION, 0, NULL, NULL) ||\r\n((num = ENGINE_ctrl(e, ENGINE_CTRL_GET_FIRST_CMD_TYPE,\r\n0, NULL, NULL)) <= 0))\r\n{\r\n#if 0\r\nBIO_printf(bio_out, "%s<no control commands>\n", indent);\r\n#endif\r\nreturn 1;\r\n}\r\ncmds = sk_OPENSSL_STRING_new_null();\r\nif(!cmds)\r\ngoto err;\r\ndo {\r\nint len;\r\nif((flags = ENGINE_ctrl(e, ENGINE_CTRL_GET_CMD_FLAGS, num,\r\nNULL, NULL)) < 0)\r\ngoto err;\r\nif (!(flags & ENGINE_CMD_FLAG_INTERNAL) || verbose >= 4)\r\n{\r\nif((len = ENGINE_ctrl(e, ENGINE_CTRL_GET_NAME_LEN_FROM_CMD, num,\r\nNULL, NULL)) <= 0)\r\ngoto err;\r\nif((name = OPENSSL_malloc(len + 1)) == NULL)\r\ngoto err;\r\nif(ENGINE_ctrl(e, ENGINE_CTRL_GET_NAME_FROM_CMD, num, name,\r\nNULL) <= 0)\r\ngoto err;\r\nif((len = ENGINE_ctrl(e, ENGINE_CTRL_GET_DESC_LEN_FROM_CMD, num,\r\nNULL, NULL)) < 0)\r\ngoto err;\r\nif(len > 0)\r\n{\r\nif((desc = OPENSSL_malloc(len + 1)) == NULL)\r\ngoto err;\r\nif(ENGINE_ctrl(e, ENGINE_CTRL_GET_DESC_FROM_CMD, num, desc,\r\nNULL) <= 0)\r\ngoto err;\r\n}\r\nif(xpos == 0)\r\nxpos = BIO_puts(bio_out, indent);\r\nelse\r\nxpos += BIO_printf(bio_out, ", ");\r\nif(verbose == 1)\r\n{\r\nif((xpos > (int)strlen(indent)) &&\r\n(xpos + (int)strlen(name) > line_wrap))\r\n{\r\nBIO_printf(bio_out, "\n");\r\nxpos = BIO_puts(bio_out, indent);\r\n}\r\nxpos += BIO_printf(bio_out, "%s", name);\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_out, "%s: %s\n", name,\r\n(desc == NULL) ? "<no description>" : desc);\r\nif((verbose >= 3) && !util_flags(bio_out, flags,\r\nindent))\r\ngoto err;\r\nxpos = 0;\r\n}\r\n}\r\nOPENSSL_free(name); name = NULL;\r\nif(desc) { OPENSSL_free(desc); desc = NULL; }\r\nnum = ENGINE_ctrl(e, ENGINE_CTRL_GET_NEXT_CMD_TYPE,\r\nnum, NULL, NULL);\r\n} while(num > 0);\r\nif(xpos > 0)\r\nBIO_printf(bio_out, "\n");\r\nret = 1;\r\nerr:\r\nif(cmds) sk_OPENSSL_STRING_pop_free(cmds, identity);\r\nif(name) OPENSSL_free(name);\r\nif(desc) OPENSSL_free(desc);\r\nreturn ret;\r\n}\r\nint MAIN(int argc, char **argv)\r\n{\r\nint ret=1,i;\r\nconst char **pp;\r\nint verbose=0, list_cap=0, test_avail=0, test_avail_noise = 0;\r\nENGINE *e;\r\nSTACK_OF(OPENSSL_STRING) *engines = sk_OPENSSL_STRING_new_null();\r\nSTACK_OF(OPENSSL_STRING) *pre_cmds = sk_OPENSSL_STRING_new_null();\r\nSTACK_OF(OPENSSL_STRING) *post_cmds = sk_OPENSSL_STRING_new_null();\r\nint badops=1;\r\nBIO *bio_out=NULL;\r\nconst char *indent = " ";\r\napps_startup();\r\nSSL_load_error_strings();\r\nif (bio_err == NULL)\r\nbio_err=BIO_new_fp(stderr,BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\nbio_out=BIO_new_fp(stdout,BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nbio_out = BIO_push(tmpbio, bio_out);\r\n}\r\n#endif\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1)\r\n{\r\nif (strncmp(*argv,"-v",2) == 0)\r\n{\r\nif(strspn(*argv + 1, "v") < strlen(*argv + 1))\r\ngoto skip_arg_loop;\r\nif((verbose=strlen(*argv + 1)) > 4)\r\ngoto skip_arg_loop;\r\n}\r\nelse if (strcmp(*argv,"-c") == 0)\r\nlist_cap=1;\r\nelse if (strncmp(*argv,"-t",2) == 0)\r\n{\r\ntest_avail=1;\r\nif(strspn(*argv + 1, "t") < strlen(*argv + 1))\r\ngoto skip_arg_loop;\r\nif((test_avail_noise = strlen(*argv + 1) - 1) > 1)\r\ngoto skip_arg_loop;\r\n}\r\nelse if (strcmp(*argv,"-pre") == 0)\r\n{\r\nargc--; argv++;\r\nif (argc == 0)\r\ngoto skip_arg_loop;\r\nsk_OPENSSL_STRING_push(pre_cmds,*argv);\r\n}\r\nelse if (strcmp(*argv,"-post") == 0)\r\n{\r\nargc--; argv++;\r\nif (argc == 0)\r\ngoto skip_arg_loop;\r\nsk_OPENSSL_STRING_push(post_cmds,*argv);\r\n}\r\nelse if ((strncmp(*argv,"-h",2) == 0) ||\r\n(strcmp(*argv,"-?") == 0))\r\ngoto skip_arg_loop;\r\nelse\r\nsk_OPENSSL_STRING_push(engines,*argv);\r\nargc--;\r\nargv++;\r\n}\r\nbadops = 0;\r\nskip_arg_loop:\r\nif (badops)\r\n{\r\nfor (pp=engine_usage; (*pp != NULL); pp++)\r\nBIO_printf(bio_err,"%s",*pp);\r\ngoto end;\r\n}\r\nif (sk_OPENSSL_STRING_num(engines) == 0)\r\n{\r\nfor(e = ENGINE_get_first(); e != NULL; e = ENGINE_get_next(e))\r\n{\r\nsk_OPENSSL_STRING_push(engines,(char *)ENGINE_get_id(e));\r\n}\r\n}\r\nfor (i=0; i<sk_OPENSSL_STRING_num(engines); i++)\r\n{\r\nconst char *id = sk_OPENSSL_STRING_value(engines,i);\r\nif ((e = ENGINE_by_id(id)) != NULL)\r\n{\r\nconst char *name = ENGINE_get_name(e);\r\nBIO_printf(bio_out, "(%s) %s\n", id, name);\r\nutil_do_cmds(e, pre_cmds, bio_out, indent);\r\nif (strcmp(ENGINE_get_id(e), id) != 0)\r\n{\r\nBIO_printf(bio_out, "Loaded: (%s) %s\n",\r\nENGINE_get_id(e), ENGINE_get_name(e));\r\n}\r\nif (list_cap)\r\n{\r\nint cap_size = 256;\r\nchar *cap_buf = NULL;\r\nint k,n;\r\nconst int *nids;\r\nENGINE_CIPHERS_PTR fn_c;\r\nENGINE_DIGESTS_PTR fn_d;\r\nENGINE_PKEY_METHS_PTR fn_pk;\r\nif (ENGINE_get_RSA(e) != NULL\r\n&& !append_buf(&cap_buf, "RSA",\r\n&cap_size, 256))\r\ngoto end;\r\nif (ENGINE_get_DSA(e) != NULL\r\n&& !append_buf(&cap_buf, "DSA",\r\n&cap_size, 256))\r\ngoto end;\r\nif (ENGINE_get_DH(e) != NULL\r\n&& !append_buf(&cap_buf, "DH",\r\n&cap_size, 256))\r\ngoto end;\r\nif (ENGINE_get_RAND(e) != NULL\r\n&& !append_buf(&cap_buf, "RAND",\r\n&cap_size, 256))\r\ngoto end;\r\nfn_c = ENGINE_get_ciphers(e);\r\nif(!fn_c) goto skip_ciphers;\r\nn = fn_c(e, NULL, &nids, 0);\r\nfor(k=0 ; k < n ; ++k)\r\nif(!append_buf(&cap_buf,\r\nOBJ_nid2sn(nids[k]),\r\n&cap_size, 256))\r\ngoto end;\r\nskip_ciphers:\r\nfn_d = ENGINE_get_digests(e);\r\nif(!fn_d) goto skip_digests;\r\nn = fn_d(e, NULL, &nids, 0);\r\nfor(k=0 ; k < n ; ++k)\r\nif(!append_buf(&cap_buf,\r\nOBJ_nid2sn(nids[k]),\r\n&cap_size, 256))\r\ngoto end;\r\nskip_digests:\r\nfn_pk = ENGINE_get_pkey_meths(e);\r\nif(!fn_pk) goto skip_pmeths;\r\nn = fn_pk(e, NULL, &nids, 0);\r\nfor(k=0 ; k < n ; ++k)\r\nif(!append_buf(&cap_buf,\r\nOBJ_nid2sn(nids[k]),\r\n&cap_size, 256))\r\ngoto end;\r\nskip_pmeths:\r\nif (cap_buf && (*cap_buf != '\0'))\r\nBIO_printf(bio_out, " [%s]\n", cap_buf);\r\nOPENSSL_free(cap_buf);\r\n}\r\nif(test_avail)\r\n{\r\nBIO_printf(bio_out, "%s", indent);\r\nif (ENGINE_init(e))\r\n{\r\nBIO_printf(bio_out, "[ available ]\n");\r\nutil_do_cmds(e, post_cmds, bio_out, indent);\r\nENGINE_finish(e);\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_out, "[ unavailable ]\n");\r\nif(test_avail_noise)\r\nERR_print_errors_fp(stdout);\r\nERR_clear_error();\r\n}\r\n}\r\nif((verbose > 0) && !util_verbose(e, verbose, bio_out, indent))\r\ngoto end;\r\nENGINE_free(e);\r\n}\r\nelse\r\nERR_print_errors(bio_err);\r\n}\r\nret=0;\r\nend:\r\nERR_print_errors(bio_err);\r\nsk_OPENSSL_STRING_pop_free(engines, identity);\r\nsk_OPENSSL_STRING_pop_free(pre_cmds, identity);\r\nsk_OPENSSL_STRING_pop_free(post_cmds, identity);\r\nif (bio_out != NULL) BIO_free_all(bio_out);\r\napps_shutdown();\r\nOPENSSL_EXIT(ret);\r\n}

int set_dist_point_name(DIST_POINT_NAME **pdp, X509V3_CTX *ctx,\r\nCONF_VALUE *cnf)\r\n{\r\nSTACK_OF(GENERAL_NAME) *fnm = NULL;\r\nSTACK_OF(X509_NAME_ENTRY) *rnm = NULL;\r\nif (!strncmp(cnf->name, "fullname", 9))\r\n{\r\nfnm = gnames_from_sectname(ctx, cnf->value);\r\nif (!fnm)\r\ngoto err;\r\n}\r\nelse if (!strcmp(cnf->name, "relativename"))\r\n{\r\nint ret;\r\nSTACK_OF(CONF_VALUE) *dnsect;\r\nX509_NAME *nm;\r\nnm = X509_NAME_new();\r\nif (!nm)\r\nreturn -1;\r\ndnsect = X509V3_get_section(ctx, cnf->value);\r\nif (!dnsect)\r\n{\r\nX509V3err(X509V3_F_SET_DIST_POINT_NAME,\r\nX509V3_R_SECTION_NOT_FOUND);\r\nreturn -1;\r\n}\r\nret = X509V3_NAME_from_section(nm, dnsect, MBSTRING_ASC);\r\nX509V3_section_free(ctx, dnsect);\r\nrnm = nm->entries;\r\nnm->entries = NULL;\r\nX509_NAME_free(nm);\r\nif (!ret || sk_X509_NAME_ENTRY_num(rnm) <= 0)\r\ngoto err;\r\nif (sk_X509_NAME_ENTRY_value(rnm,\r\nsk_X509_NAME_ENTRY_num(rnm) - 1)->set)\r\n{\r\nX509V3err(X509V3_F_SET_DIST_POINT_NAME,\r\nX509V3_R_INVALID_MULTIPLE_RDNS);\r\ngoto err;\r\n}\r\n}\r\nelse\r\nreturn 0;\r\nif (*pdp)\r\n{\r\nX509V3err(X509V3_F_SET_DIST_POINT_NAME,\r\nX509V3_R_DISTPOINT_ALREADY_SET);\r\ngoto err;\r\n}\r\n*pdp = DIST_POINT_NAME_new();\r\nif (!*pdp)\r\ngoto err;\r\nif (fnm)\r\n{\r\n(*pdp)->type = 0;\r\n(*pdp)->name.fullname = fnm;\r\n}\r\nelse\r\n{\r\n(*pdp)->type = 1;\r\n(*pdp)->name.relativename = rnm;\r\n}\r\nreturn 1;\r\nerr:\r\nif (fnm)\r\nsk_GENERAL_NAME_pop_free(fnm, GENERAL_NAME_free);\r\nif (rnm)\r\nsk_X509_NAME_ENTRY_pop_free(rnm, X509_NAME_ENTRY_free);\r\nreturn -1;\r\n}\r\nstatic int set_reasons(ASN1_BIT_STRING **preas, char *value)\r\n{\r\nSTACK_OF(CONF_VALUE) *rsk = NULL;\r\nconst BIT_STRING_BITNAME *pbn;\r\nconst char *bnam;\r\nint i, ret = 0;\r\nrsk = X509V3_parse_list(value);\r\nif (!rsk)\r\nreturn 0;\r\nif (*preas)\r\nreturn 0;\r\nfor (i = 0; i < sk_CONF_VALUE_num(rsk); i++)\r\n{\r\nbnam = sk_CONF_VALUE_value(rsk, i)->name;\r\nif (!*preas)\r\n{\r\n*preas = ASN1_BIT_STRING_new();\r\nif (!*preas)\r\ngoto err;\r\n}\r\nfor (pbn = reason_flags; pbn->lname; pbn++)\r\n{\r\nif (!strcmp(pbn->sname, bnam))\r\n{\r\nif (!ASN1_BIT_STRING_set_bit(*preas,\r\npbn->bitnum, 1))\r\ngoto err;\r\nbreak;\r\n}\r\n}\r\nif (!pbn->lname)\r\ngoto err;\r\n}\r\nret = 1;\r\nerr:\r\nsk_CONF_VALUE_pop_free(rsk, X509V3_conf_free);\r\nreturn ret;\r\n}\r\nstatic int print_reasons(BIO *out, const char *rname,\r\nASN1_BIT_STRING *rflags, int indent)\r\n{\r\nint first = 1;\r\nconst BIT_STRING_BITNAME *pbn;\r\nBIO_printf(out, "%*s%s:\n%*s", indent, "", rname, indent + 2, "");\r\nfor (pbn = reason_flags; pbn->lname; pbn++)\r\n{\r\nif (ASN1_BIT_STRING_get_bit(rflags, pbn->bitnum))\r\n{\r\nif (first)\r\nfirst = 0;\r\nelse\r\nBIO_puts(out, ", ");\r\nBIO_puts(out, pbn->lname);\r\n}\r\n}\r\nif (first)\r\nBIO_puts(out, "<EMPTY>\n");\r\nelse\r\nBIO_puts(out, "\n");\r\nreturn 1;\r\n}\r\nstatic int dpn_cb(int operation, ASN1_VALUE **pval, const ASN1_ITEM *it,\r\nvoid *exarg)\r\n{\r\nDIST_POINT_NAME *dpn = (DIST_POINT_NAME *)*pval;\r\nswitch(operation)\r\n{\r\ncase ASN1_OP_NEW_POST:\r\ndpn->dpname = NULL;\r\nbreak;\r\ncase ASN1_OP_FREE_POST:\r\nif (dpn->dpname)\r\nX509_NAME_free(dpn->dpname);\r\nbreak;\r\n}\r\nreturn 1;\r\n}\r\nstatic int print_distpoint(BIO *out, DIST_POINT_NAME *dpn, int indent)\r\n{\r\nif (dpn->type == 0)\r\n{\r\nBIO_printf(out, "%*sFull Name:\n", indent, "");\r\nprint_gens(out, dpn->name.fullname, indent);\r\n}\r\nelse\r\n{\r\nX509_NAME ntmp;\r\nntmp.entries = dpn->name.relativename;\r\nBIO_printf(out, "%*sRelative Name:\n%*s",\r\nindent, "", indent + 2, "");\r\nX509_NAME_print_ex(out, &ntmp, 0, XN_FLAG_ONELINE);\r\nBIO_puts(out, "\n");\r\n}\r\nreturn 1;\r\n}\r\nstatic int i2r_idp(const X509V3_EXT_METHOD *method, void *pidp, BIO *out,\r\nint indent)\r\n{\r\nISSUING_DIST_POINT *idp = pidp;\r\nif (idp->distpoint)\r\nprint_distpoint(out, idp->distpoint, indent);\r\nif (idp->onlyuser > 0)\r\nBIO_printf(out, "%*sOnly User Certificates\n", indent, "");\r\nif (idp->onlyCA > 0)\r\nBIO_printf(out, "%*sOnly CA Certificates\n", indent, "");\r\nif (idp->indirectCRL > 0)\r\nBIO_printf(out, "%*sIndirect CRL\n", indent, "");\r\nif (idp->onlysomereasons)\r\nprint_reasons(out, "Only Some Reasons",\r\nidp->onlysomereasons, indent);\r\nif (idp->onlyattr > 0)\r\nBIO_printf(out, "%*sOnly Attribute Certificates\n", indent, "");\r\nif (!idp->distpoint && (idp->onlyuser <= 0) && (idp->onlyCA <= 0)\r\n&& (idp->indirectCRL <= 0) && !idp->onlysomereasons\r\n&& (idp->onlyattr <= 0))\r\nBIO_printf(out, "%*s<EMPTY>\n", indent, "");\r\nreturn 1;\r\n}\r\nstatic int i2r_crldp(const X509V3_EXT_METHOD *method, void *pcrldp, BIO *out,\r\nint indent)\r\n{\r\nSTACK_OF(DIST_POINT) *crld = pcrldp;\r\nDIST_POINT *point;\r\nint i;\r\nfor(i = 0; i < sk_DIST_POINT_num(crld); i++)\r\n{\r\nBIO_puts(out, "\n");\r\npoint = sk_DIST_POINT_value(crld, i);\r\nif(point->distpoint)\r\nprint_distpoint(out, point->distpoint, indent);\r\nif(point->reasons)\r\nprint_reasons(out, "Reasons", point->reasons,\r\nindent);\r\nif(point->CRLissuer)\r\n{\r\nBIO_printf(out, "%*sCRL Issuer:\n", indent, "");\r\nprint_gens(out, point->CRLissuer, indent);\r\n}\r\n}\r\nreturn 1;\r\n}\r\nint DIST_POINT_set_dpname(DIST_POINT_NAME *dpn, X509_NAME *iname)\r\n{\r\nint i;\r\nSTACK_OF(X509_NAME_ENTRY) *frag;\r\nX509_NAME_ENTRY *ne;\r\nif (!dpn || (dpn->type != 1))\r\nreturn 1;\r\nfrag = dpn->name.relativename;\r\ndpn->dpname = X509_NAME_dup(iname);\r\nif (!dpn->dpname)\r\nreturn 0;\r\nfor (i = 0; i < sk_X509_NAME_ENTRY_num(frag); i++)\r\n{\r\nne = sk_X509_NAME_ENTRY_value(frag, i);\r\nif (!X509_NAME_add_entry(dpn->dpname, ne, -1, i ? 0 : 1))\r\n{\r\nX509_NAME_free(dpn->dpname);\r\ndpn->dpname = NULL;\r\nreturn 0;\r\n}\r\n}\r\nif (i2d_X509_NAME(dpn->dpname, NULL) < 0)\r\n{\r\nX509_NAME_free(dpn->dpname);\r\ndpn->dpname = NULL;\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}

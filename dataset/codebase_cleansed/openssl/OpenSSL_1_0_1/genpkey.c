int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nchar **args, *outfile = NULL;\r\nchar *passarg = NULL;\r\nBIO *in = NULL, *out = NULL;\r\nconst EVP_CIPHER *cipher = NULL;\r\nint outformat;\r\nint text = 0;\r\nEVP_PKEY *pkey=NULL;\r\nEVP_PKEY_CTX *ctx = NULL;\r\nchar *pass = NULL;\r\nint badarg = 0;\r\nint ret = 1, rv;\r\nint do_param = 0;\r\nif (bio_err == NULL)\r\nbio_err = BIO_new_fp (stderr, BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\noutformat=FORMAT_PEM;\r\nERR_load_crypto_strings();\r\nOpenSSL_add_all_algorithms();\r\nargs = argv + 1;\r\nwhile (!badarg && *args && *args[0] == '-')\r\n{\r\nif (!strcmp(*args,"-outform"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutformat=str2fmt(*args);\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (!strcmp(*args,"-pass"))\r\n{\r\nif (!args[1]) goto bad;\r\npassarg= *(++args);\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\nelse if (strcmp(*args,"-engine") == 0)\r\n{\r\nif (!args[1])\r\ngoto bad;\r\ne = setup_engine(bio_err, *(++args), 0);\r\n}\r\n#endif\r\nelse if (!strcmp (*args, "-paramfile"))\r\n{\r\nif (!args[1])\r\ngoto bad;\r\nargs++;\r\nif (do_param == 1)\r\ngoto bad;\r\nif (!init_keygen_file(bio_err, &ctx, *args, e))\r\ngoto end;\r\n}\r\nelse if (!strcmp (*args, "-out"))\r\n{\r\nif (args[1])\r\n{\r\nargs++;\r\noutfile = *args;\r\n}\r\nelse badarg = 1;\r\n}\r\nelse if (strcmp(*args,"-algorithm") == 0)\r\n{\r\nif (!args[1])\r\ngoto bad;\r\nif (!init_gen_str(bio_err, &ctx, *(++args),e, do_param))\r\ngoto end;\r\n}\r\nelse if (strcmp(*args,"-pkeyopt") == 0)\r\n{\r\nif (!args[1])\r\ngoto bad;\r\nif (!ctx)\r\n{\r\nBIO_puts(bio_err, "No keytype specified\n");\r\ngoto bad;\r\n}\r\nelse if (pkey_ctrl_string(ctx, *(++args)) <= 0)\r\n{\r\nBIO_puts(bio_err, "parameter setting error\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nelse if (strcmp(*args,"-genparam") == 0)\r\n{\r\nif (ctx)\r\ngoto bad;\r\ndo_param = 1;\r\n}\r\nelse if (strcmp(*args,"-text") == 0)\r\ntext=1;\r\nelse\r\n{\r\ncipher = EVP_get_cipherbyname(*args + 1);\r\nif (!cipher)\r\n{\r\nBIO_printf(bio_err, "Unknown cipher %s\n",\r\n*args + 1);\r\nbadarg = 1;\r\n}\r\nif (do_param == 1)\r\nbadarg = 1;\r\n}\r\nargs++;\r\n}\r\nif (!ctx)\r\nbadarg = 1;\r\nif (badarg)\r\n{\r\nbad:\r\nBIO_printf(bio_err, "Usage: genpkey [options]\n");\r\nBIO_printf(bio_err, "where options may be\n");\r\nBIO_printf(bio_err, "-out file output file\n");\r\nBIO_printf(bio_err, "-outform X output format (DER or PEM)\n");\r\nBIO_printf(bio_err, "-pass arg output file pass phrase source\n");\r\nBIO_printf(bio_err, "-<cipher> use cipher <cipher> to encrypt the key\n");\r\n#ifndef OPENSSL_NO_ENGINE\r\nBIO_printf(bio_err, "-engine e use engine e, possibly a hardware device.\n");\r\n#endif\r\nBIO_printf(bio_err, "-paramfile file parameters file\n");\r\nBIO_printf(bio_err, "-algorithm alg the public key algorithm\n");\r\nBIO_printf(bio_err, "-pkeyopt opt:value set the public key algorithm option <opt>\n"\r\n" to value <value>\n");\r\nBIO_printf(bio_err, "-genparam generate parameters, not key\n");\r\nBIO_printf(bio_err, "-text print the in text\n");\r\nBIO_printf(bio_err, "NB: options order may be important! See the manual page.\n");\r\ngoto end;\r\n}\r\nif (!app_passwd(bio_err, passarg, NULL, &pass, NULL))\r\n{\r\nBIO_puts(bio_err, "Error getting password\n");\r\ngoto end;\r\n}\r\nif (outfile)\r\n{\r\nif (!(out = BIO_new_file (outfile, "wb")))\r\n{\r\nBIO_printf(bio_err,\r\n"Can't open output file %s\n", outfile);\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nout = BIO_new_fp (stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nEVP_PKEY_CTX_set_cb(ctx, genpkey_cb);\r\nEVP_PKEY_CTX_set_app_data(ctx, bio_err);\r\nif (do_param)\r\n{\r\nif (EVP_PKEY_paramgen(ctx, &pkey) <= 0)\r\n{\r\nBIO_puts(bio_err, "Error generating parameters\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nif (EVP_PKEY_keygen(ctx, &pkey) <= 0)\r\n{\r\nBIO_puts(bio_err, "Error generating key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif (do_param)\r\nrv = PEM_write_bio_Parameters(out, pkey);\r\nelse if (outformat == FORMAT_PEM)\r\nrv = PEM_write_bio_PrivateKey(out, pkey, cipher, NULL, 0,\r\nNULL, pass);\r\nelse if (outformat == FORMAT_ASN1)\r\nrv = i2d_PrivateKey_bio(out, pkey);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad format specified for key\n");\r\ngoto end;\r\n}\r\nif (rv <= 0)\r\n{\r\nBIO_puts(bio_err, "Error writing key\n");\r\nERR_print_errors(bio_err);\r\n}\r\nif (text)\r\n{\r\nif (do_param)\r\nrv = EVP_PKEY_print_params(out, pkey, 0, NULL);\r\nelse\r\nrv = EVP_PKEY_print_private(out, pkey, 0, NULL);\r\nif (rv <= 0)\r\n{\r\nBIO_puts(bio_err, "Error printing key\n");\r\nERR_print_errors(bio_err);\r\n}\r\n}\r\nret = 0;\r\nend:\r\nif (pkey)\r\nEVP_PKEY_free(pkey);\r\nif (ctx)\r\nEVP_PKEY_CTX_free(ctx);\r\nif (out)\r\nBIO_free_all(out);\r\nBIO_free(in);\r\nif (pass)\r\nOPENSSL_free(pass);\r\nreturn ret;\r\n}\r\nstatic int init_keygen_file(BIO *err, EVP_PKEY_CTX **pctx,\r\nconst char *file, ENGINE *e)\r\n{\r\nBIO *pbio;\r\nEVP_PKEY *pkey = NULL;\r\nEVP_PKEY_CTX *ctx = NULL;\r\nif (*pctx)\r\n{\r\nBIO_puts(err, "Parameters already set!\n");\r\nreturn 0;\r\n}\r\npbio = BIO_new_file(file, "r");\r\nif (!pbio)\r\n{\r\nBIO_printf(err, "Can't open parameter file %s\n", file);\r\nreturn 0;\r\n}\r\npkey = PEM_read_bio_Parameters(pbio, NULL);\r\nBIO_free(pbio);\r\nif (!pkey)\r\n{\r\nBIO_printf(bio_err, "Error reading parameter file %s\n", file);\r\nreturn 0;\r\n}\r\nctx = EVP_PKEY_CTX_new(pkey, e);\r\nif (!ctx)\r\ngoto err;\r\nif (EVP_PKEY_keygen_init(ctx) <= 0)\r\ngoto err;\r\nEVP_PKEY_free(pkey);\r\n*pctx = ctx;\r\nreturn 1;\r\nerr:\r\nBIO_puts(err, "Error initializing context\n");\r\nERR_print_errors(err);\r\nif (ctx)\r\nEVP_PKEY_CTX_free(ctx);\r\nif (pkey)\r\nEVP_PKEY_free(pkey);\r\nreturn 0;\r\n}\r\nint init_gen_str(BIO *err, EVP_PKEY_CTX **pctx,\r\nconst char *algname, ENGINE *e, int do_param)\r\n{\r\nEVP_PKEY_CTX *ctx = NULL;\r\nconst EVP_PKEY_ASN1_METHOD *ameth;\r\nENGINE *tmpeng = NULL;\r\nint pkey_id;\r\nif (*pctx)\r\n{\r\nBIO_puts(err, "Algorithm already set!\n");\r\nreturn 0;\r\n}\r\nameth = EVP_PKEY_asn1_find_str(&tmpeng, algname, -1);\r\n#ifndef OPENSSL_NO_ENGINE\r\nif (!ameth && e)\r\nameth = ENGINE_get_pkey_asn1_meth_str(e, algname, -1);\r\n#endif\r\nif (!ameth)\r\n{\r\nBIO_printf(bio_err, "Algorithm %s not found\n", algname);\r\nreturn 0;\r\n}\r\nERR_clear_error();\r\nEVP_PKEY_asn1_get0_info(&pkey_id, NULL, NULL, NULL, NULL, ameth);\r\n#ifndef OPENSSL_NO_ENGINE\r\nif (tmpeng)\r\nENGINE_finish(tmpeng);\r\n#endif\r\nctx = EVP_PKEY_CTX_new_id(pkey_id, e);\r\nif (!ctx)\r\ngoto err;\r\nif (do_param)\r\n{\r\nif (EVP_PKEY_paramgen_init(ctx) <= 0)\r\ngoto err;\r\n}\r\nelse\r\n{\r\nif (EVP_PKEY_keygen_init(ctx) <= 0)\r\ngoto err;\r\n}\r\n*pctx = ctx;\r\nreturn 1;\r\nerr:\r\nBIO_printf(err, "Error initializing %s context\n", algname);\r\nERR_print_errors(err);\r\nif (ctx)\r\nEVP_PKEY_CTX_free(ctx);\r\nreturn 0;\r\n}\r\nstatic int genpkey_cb(EVP_PKEY_CTX *ctx)\r\n{\r\nchar c='*';\r\nBIO *b = EVP_PKEY_CTX_get_app_data(ctx);\r\nint p;\r\np = EVP_PKEY_CTX_get_keygen_info(ctx, 0);\r\nif (p == 0) c='.';\r\nif (p == 1) c='+';\r\nif (p == 2) c='*';\r\nif (p == 3) c='\n';\r\nBIO_write(b,&c,1);\r\n(void)BIO_flush(b);\r\n#ifdef LINT\r\np=n;\r\n#endif\r\nreturn 1;\r\n}

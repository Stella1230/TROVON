int X509_ATTRIBUTE_set1_data(X509_ATTRIBUTE *attr, int attrtype, const void *data, int len)\r\n{\r\nASN1_TYPE *ttmp;\r\nASN1_STRING *stmp = NULL;\r\nint atype = 0;\r\nif (!attr) return 0;\r\nif(attrtype & MBSTRING_FLAG) {\r\nstmp = ASN1_STRING_set_by_NID(NULL, data, len, attrtype,\r\nOBJ_obj2nid(attr->object));\r\nif(!stmp) {\r\nX509err(X509_F_X509_ATTRIBUTE_SET1_DATA, ERR_R_ASN1_LIB);\r\nreturn 0;\r\n}\r\natype = stmp->type;\r\n} else if (len != -1){\r\nif(!(stmp = ASN1_STRING_type_new(attrtype))) goto err;\r\nif(!ASN1_STRING_set(stmp, data, len)) goto err;\r\natype = attrtype;\r\n}\r\nif(!(attr->value.set = sk_ASN1_TYPE_new_null())) goto err;\r\nattr->single = 0;\r\nif (attrtype == 0)\r\nreturn 1;\r\nif(!(ttmp = ASN1_TYPE_new())) goto err;\r\nif ((len == -1) && !(attrtype & MBSTRING_FLAG))\r\n{\r\nif (!ASN1_TYPE_set1(ttmp, attrtype, data))\r\ngoto err;\r\n}\r\nelse\r\nASN1_TYPE_set(ttmp, atype, stmp);\r\nif(!sk_ASN1_TYPE_push(attr->value.set, ttmp)) goto err;\r\nreturn 1;\r\nerr:\r\nX509err(X509_F_X509_ATTRIBUTE_SET1_DATA, ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nint X509_ATTRIBUTE_count(X509_ATTRIBUTE *attr)\r\n{\r\nif(!attr->single) return sk_ASN1_TYPE_num(attr->value.set);\r\nif(attr->value.single) return 1;\r\nreturn 0;\r\n}\r\nASN1_OBJECT *X509_ATTRIBUTE_get0_object(X509_ATTRIBUTE *attr)\r\n{\r\nif (attr == NULL) return(NULL);\r\nreturn(attr->object);\r\n}\r\nvoid *X509_ATTRIBUTE_get0_data(X509_ATTRIBUTE *attr, int idx,\r\nint atrtype, void *data)\r\n{\r\nASN1_TYPE *ttmp;\r\nttmp = X509_ATTRIBUTE_get0_type(attr, idx);\r\nif(!ttmp) return NULL;\r\nif(atrtype != ASN1_TYPE_get(ttmp)){\r\nX509err(X509_F_X509_ATTRIBUTE_GET0_DATA, X509_R_WRONG_TYPE);\r\nreturn NULL;\r\n}\r\nreturn ttmp->value.ptr;\r\n}\r\nASN1_TYPE *X509_ATTRIBUTE_get0_type(X509_ATTRIBUTE *attr, int idx)\r\n{\r\nif (attr == NULL) return(NULL);\r\nif(idx >= X509_ATTRIBUTE_count(attr)) return NULL;\r\nif(!attr->single) return sk_ASN1_TYPE_value(attr->value.set, idx);\r\nelse return attr->value.single;\r\n}

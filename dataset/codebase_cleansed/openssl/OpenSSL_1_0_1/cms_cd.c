CMS_ContentInfo *cms_CompressedData_create(int comp_nid)\r\n{\r\nCMS_ContentInfo *cms;\r\nCMS_CompressedData *cd;\r\nif (comp_nid != NID_zlib_compression)\r\n{\r\nCMSerr(CMS_F_CMS_COMPRESSEDDATA_CREATE,\r\nCMS_R_UNSUPPORTED_COMPRESSION_ALGORITHM);\r\nreturn NULL;\r\n}\r\ncms = CMS_ContentInfo_new();\r\nif (!cms)\r\nreturn NULL;\r\ncd = M_ASN1_new_of(CMS_CompressedData);\r\nif (!cd)\r\ngoto err;\r\ncms->contentType = OBJ_nid2obj(NID_id_smime_ct_compressedData);\r\ncms->d.compressedData = cd;\r\ncd->version = 0;\r\nX509_ALGOR_set0(cd->compressionAlgorithm,\r\nOBJ_nid2obj(NID_zlib_compression),\r\nV_ASN1_UNDEF, NULL);\r\ncd->encapContentInfo->eContentType = OBJ_nid2obj(NID_pkcs7_data);\r\nreturn cms;\r\nerr:\r\nif (cms)\r\nCMS_ContentInfo_free(cms);\r\nreturn NULL;\r\n}\r\nBIO *cms_CompressedData_init_bio(CMS_ContentInfo *cms)\r\n{\r\nCMS_CompressedData *cd;\r\nASN1_OBJECT *compoid;\r\nif (OBJ_obj2nid(cms->contentType) != NID_id_smime_ct_compressedData)\r\n{\r\nCMSerr(CMS_F_CMS_COMPRESSEDDATA_INIT_BIO,\r\nCMS_R_CONTENT_TYPE_NOT_COMPRESSED_DATA);\r\nreturn NULL;\r\n}\r\ncd = cms->d.compressedData;\r\nX509_ALGOR_get0(&compoid, NULL, NULL, cd->compressionAlgorithm);\r\nif (OBJ_obj2nid(compoid) != NID_zlib_compression)\r\n{\r\nCMSerr(CMS_F_CMS_COMPRESSEDDATA_INIT_BIO,\r\nCMS_R_UNSUPPORTED_COMPRESSION_ALGORITHM);\r\nreturn NULL;\r\n}\r\nreturn BIO_new(BIO_f_zlib());\r\n}

int CONF_modules_load(const CONF *cnf, const char *appname,\r\nunsigned long flags)\r\n{\r\nSTACK_OF(CONF_VALUE) *values;\r\nCONF_VALUE *vl;\r\nchar *vsection = NULL;\r\nint ret, i;\r\nif (!cnf)\r\nreturn 1;\r\nif (appname)\r\nvsection = NCONF_get_string(cnf, NULL, appname);\r\nif (!appname || (!vsection && (flags & CONF_MFLAGS_DEFAULT_SECTION)))\r\nvsection = NCONF_get_string(cnf, NULL, "openssl_conf");\r\nif (!vsection)\r\n{\r\nERR_clear_error();\r\nreturn 1;\r\n}\r\nvalues = NCONF_get_section(cnf, vsection);\r\nif (!values)\r\nreturn 0;\r\nfor (i = 0; i < sk_CONF_VALUE_num(values); i++)\r\n{\r\nvl = sk_CONF_VALUE_value(values, i);\r\nret = module_run(cnf, vl->name, vl->value, flags);\r\nif (ret <= 0)\r\nif(!(flags & CONF_MFLAGS_IGNORE_ERRORS))\r\nreturn ret;\r\n}\r\nreturn 1;\r\n}\r\nint CONF_modules_load_file(const char *filename, const char *appname,\r\nunsigned long flags)\r\n{\r\nchar *file = NULL;\r\nCONF *conf = NULL;\r\nint ret = 0;\r\nconf = NCONF_new(NULL);\r\nif (!conf)\r\ngoto err;\r\nif (filename == NULL)\r\n{\r\nfile = CONF_get1_default_config_file();\r\nif (!file)\r\ngoto err;\r\n}\r\nelse\r\nfile = (char *)filename;\r\nif (NCONF_load(conf, file, NULL) <= 0)\r\n{\r\nif ((flags & CONF_MFLAGS_IGNORE_MISSING_FILE) &&\r\n(ERR_GET_REASON(ERR_peek_last_error()) == CONF_R_NO_SUCH_FILE))\r\n{\r\nERR_clear_error();\r\nret = 1;\r\n}\r\ngoto err;\r\n}\r\nret = CONF_modules_load(conf, appname, flags);\r\nerr:\r\nif (filename == NULL)\r\nOPENSSL_free(file);\r\nNCONF_free(conf);\r\nreturn ret;\r\n}\r\nstatic int module_run(const CONF *cnf, char *name, char *value,\r\nunsigned long flags)\r\n{\r\nCONF_MODULE *md;\r\nint ret;\r\nmd = module_find(name);\r\nif (!md && !(flags & CONF_MFLAGS_NO_DSO))\r\nmd = module_load_dso(cnf, name, value, flags);\r\nif (!md)\r\n{\r\nif (!(flags & CONF_MFLAGS_SILENT))\r\n{\r\nCONFerr(CONF_F_MODULE_RUN, CONF_R_UNKNOWN_MODULE_NAME);\r\nERR_add_error_data(2, "module=", name);\r\n}\r\nreturn -1;\r\n}\r\nret = module_init(md, name, value, cnf);\r\nif (ret <= 0)\r\n{\r\nif (!(flags & CONF_MFLAGS_SILENT))\r\n{\r\nchar rcode[DECIMAL_SIZE(ret)+1];\r\nCONFerr(CONF_F_MODULE_RUN, CONF_R_MODULE_INITIALIZATION_ERROR);\r\nBIO_snprintf(rcode, sizeof rcode, "%-8d", ret);\r\nERR_add_error_data(6, "module=", name, ", value=", value, ", retcode=", rcode);\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic CONF_MODULE *module_load_dso(const CONF *cnf, char *name, char *value,\r\nunsigned long flags)\r\n{\r\nDSO *dso = NULL;\r\nconf_init_func *ifunc;\r\nconf_finish_func *ffunc;\r\nchar *path = NULL;\r\nint errcode = 0;\r\nCONF_MODULE *md;\r\npath = NCONF_get_string(cnf, value, "path");\r\nif (!path)\r\n{\r\nERR_clear_error();\r\npath = name;\r\n}\r\ndso = DSO_load(NULL, path, NULL, 0);\r\nif (!dso)\r\n{\r\nerrcode = CONF_R_ERROR_LOADING_DSO;\r\ngoto err;\r\n}\r\nifunc = (conf_init_func *)DSO_bind_func(dso, DSO_mod_init_name);\r\nif (!ifunc)\r\n{\r\nerrcode = CONF_R_MISSING_INIT_FUNCTION;\r\ngoto err;\r\n}\r\nffunc = (conf_finish_func *)DSO_bind_func(dso, DSO_mod_finish_name);\r\nmd = module_add(dso, name, ifunc, ffunc);\r\nif (!md)\r\ngoto err;\r\nreturn md;\r\nerr:\r\nif (dso)\r\nDSO_free(dso);\r\nCONFerr(CONF_F_MODULE_LOAD_DSO, errcode);\r\nERR_add_error_data(4, "module=", name, ", path=", path);\r\nreturn NULL;\r\n}\r\nstatic CONF_MODULE *module_add(DSO *dso, const char *name,\r\nconf_init_func *ifunc, conf_finish_func *ffunc)\r\n{\r\nCONF_MODULE *tmod = NULL;\r\nif (supported_modules == NULL)\r\nsupported_modules = sk_CONF_MODULE_new_null();\r\nif (supported_modules == NULL)\r\nreturn NULL;\r\ntmod = OPENSSL_malloc(sizeof(CONF_MODULE));\r\nif (tmod == NULL)\r\nreturn NULL;\r\ntmod->dso = dso;\r\ntmod->name = BUF_strdup(name);\r\ntmod->init = ifunc;\r\ntmod->finish = ffunc;\r\ntmod->links = 0;\r\nif (!sk_CONF_MODULE_push(supported_modules, tmod))\r\n{\r\nOPENSSL_free(tmod);\r\nreturn NULL;\r\n}\r\nreturn tmod;\r\n}\r\nstatic CONF_MODULE *module_find(char *name)\r\n{\r\nCONF_MODULE *tmod;\r\nint i, nchar;\r\nchar *p;\r\np = strrchr(name, '.');\r\nif (p)\r\nnchar = p - name;\r\nelse\r\nnchar = strlen(name);\r\nfor (i = 0; i < sk_CONF_MODULE_num(supported_modules); i++)\r\n{\r\ntmod = sk_CONF_MODULE_value(supported_modules, i);\r\nif (!strncmp(tmod->name, name, nchar))\r\nreturn tmod;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int module_init(CONF_MODULE *pmod, char *name, char *value,\r\nconst CONF *cnf)\r\n{\r\nint ret = 1;\r\nint init_called = 0;\r\nCONF_IMODULE *imod = NULL;\r\nimod = OPENSSL_malloc(sizeof(CONF_IMODULE));\r\nif (!imod)\r\ngoto err;\r\nimod->pmod = pmod;\r\nimod->name = BUF_strdup(name);\r\nimod->value = BUF_strdup(value);\r\nimod->usr_data = NULL;\r\nif (!imod->name || !imod->value)\r\ngoto memerr;\r\nif(pmod->init)\r\n{\r\nret = pmod->init(imod, cnf);\r\ninit_called = 1;\r\nif (ret <= 0)\r\ngoto err;\r\n}\r\nif (initialized_modules == NULL)\r\n{\r\ninitialized_modules = sk_CONF_IMODULE_new_null();\r\nif (!initialized_modules)\r\n{\r\nCONFerr(CONF_F_MODULE_INIT, ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\nif (!sk_CONF_IMODULE_push(initialized_modules, imod))\r\n{\r\nCONFerr(CONF_F_MODULE_INIT, ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\npmod->links++;\r\nreturn ret;\r\nerr:\r\nif (pmod->finish && init_called)\r\npmod->finish(imod);\r\nmemerr:\r\nif (imod)\r\n{\r\nif (imod->name)\r\nOPENSSL_free(imod->name);\r\nif (imod->value)\r\nOPENSSL_free(imod->value);\r\nOPENSSL_free(imod);\r\n}\r\nreturn -1;\r\n}\r\nvoid CONF_modules_unload(int all)\r\n{\r\nint i;\r\nCONF_MODULE *md;\r\nCONF_modules_finish();\r\nfor (i = sk_CONF_MODULE_num(supported_modules) - 1; i >= 0; i--)\r\n{\r\nmd = sk_CONF_MODULE_value(supported_modules, i);\r\nif (((md->links > 0) || !md->dso) && !all)\r\ncontinue;\r\n(void)sk_CONF_MODULE_delete(supported_modules, i);\r\nmodule_free(md);\r\n}\r\nif (sk_CONF_MODULE_num(supported_modules) == 0)\r\n{\r\nsk_CONF_MODULE_free(supported_modules);\r\nsupported_modules = NULL;\r\n}\r\n}\r\nstatic void module_free(CONF_MODULE *md)\r\n{\r\nif (md->dso)\r\nDSO_free(md->dso);\r\nOPENSSL_free(md->name);\r\nOPENSSL_free(md);\r\n}\r\nvoid CONF_modules_finish(void)\r\n{\r\nCONF_IMODULE *imod;\r\nwhile (sk_CONF_IMODULE_num(initialized_modules) > 0)\r\n{\r\nimod = sk_CONF_IMODULE_pop(initialized_modules);\r\nmodule_finish(imod);\r\n}\r\nsk_CONF_IMODULE_free(initialized_modules);\r\ninitialized_modules = NULL;\r\n}\r\nstatic void module_finish(CONF_IMODULE *imod)\r\n{\r\nif (imod->pmod->finish)\r\nimod->pmod->finish(imod);\r\nimod->pmod->links--;\r\nOPENSSL_free(imod->name);\r\nOPENSSL_free(imod->value);\r\nOPENSSL_free(imod);\r\n}\r\nint CONF_module_add(const char *name, conf_init_func *ifunc,\r\nconf_finish_func *ffunc)\r\n{\r\nif (module_add(NULL, name, ifunc, ffunc))\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nvoid CONF_modules_free(void)\r\n{\r\nCONF_modules_finish();\r\nCONF_modules_unload(1);\r\n}\r\nconst char *CONF_imodule_get_name(const CONF_IMODULE *md)\r\n{\r\nreturn md->name;\r\n}\r\nconst char *CONF_imodule_get_value(const CONF_IMODULE *md)\r\n{\r\nreturn md->value;\r\n}\r\nvoid *CONF_imodule_get_usr_data(const CONF_IMODULE *md)\r\n{\r\nreturn md->usr_data;\r\n}\r\nvoid CONF_imodule_set_usr_data(CONF_IMODULE *md, void *usr_data)\r\n{\r\nmd->usr_data = usr_data;\r\n}\r\nCONF_MODULE *CONF_imodule_get_module(const CONF_IMODULE *md)\r\n{\r\nreturn md->pmod;\r\n}\r\nunsigned long CONF_imodule_get_flags(const CONF_IMODULE *md)\r\n{\r\nreturn md->flags;\r\n}\r\nvoid CONF_imodule_set_flags(CONF_IMODULE *md, unsigned long flags)\r\n{\r\nmd->flags = flags;\r\n}\r\nvoid *CONF_module_get_usr_data(CONF_MODULE *pmod)\r\n{\r\nreturn pmod->usr_data;\r\n}\r\nvoid CONF_module_set_usr_data(CONF_MODULE *pmod, void *usr_data)\r\n{\r\npmod->usr_data = usr_data;\r\n}\r\nchar *CONF_get1_default_config_file(void)\r\n{\r\nchar *file;\r\nint len;\r\nfile = getenv("OPENSSL_CONF");\r\nif (file)\r\nreturn BUF_strdup(file);\r\nlen = strlen(X509_get_default_cert_area());\r\n#ifndef OPENSSL_SYS_VMS\r\nlen++;\r\n#endif\r\nlen += strlen(OPENSSL_CONF);\r\nfile = OPENSSL_malloc(len + 1);\r\nif (!file)\r\nreturn NULL;\r\nBUF_strlcpy(file,X509_get_default_cert_area(),len + 1);\r\n#ifndef OPENSSL_SYS_VMS\r\nBUF_strlcat(file,"/",len + 1);\r\n#endif\r\nBUF_strlcat(file,OPENSSL_CONF,len + 1);\r\nreturn file;\r\n}\r\nint CONF_parse_list(const char *list_, int sep, int nospc,\r\nint (*list_cb)(const char *elem, int len, void *usr), void *arg)\r\n{\r\nint ret;\r\nconst char *lstart, *tmpend, *p;\r\nif(list_ == NULL)\r\n{\r\nCONFerr(CONF_F_CONF_PARSE_LIST, CONF_R_LIST_CANNOT_BE_NULL);\r\nreturn 0;\r\n}\r\nlstart = list_;\r\nfor(;;)\r\n{\r\nif (nospc)\r\n{\r\nwhile(*lstart && isspace((unsigned char)*lstart))\r\nlstart++;\r\n}\r\np = strchr(lstart, sep);\r\nif (p == lstart || !*lstart)\r\nret = list_cb(NULL, 0, arg);\r\nelse\r\n{\r\nif (p)\r\ntmpend = p - 1;\r\nelse\r\ntmpend = lstart + strlen(lstart) - 1;\r\nif (nospc)\r\n{\r\nwhile(isspace((unsigned char)*tmpend))\r\ntmpend--;\r\n}\r\nret = list_cb(lstart, tmpend - lstart + 1, arg);\r\n}\r\nif (ret <= 0)\r\nreturn ret;\r\nif (p == NULL)\r\nreturn 1;\r\nlstart = p + 1;\r\n}\r\n}

static int gost_engine_init(ENGINE *e)\r\n{\r\nreturn 1;\r\n}\r\nstatic int gost_engine_finish(ENGINE *e)\r\n{\r\nreturn 1;\r\n}\r\nstatic int gost_engine_destroy(ENGINE *e)\r\n{\r\ngost_param_free();\r\nreturn 1;\r\n}\r\nstatic int bind_gost (ENGINE *e,const char *id)\r\n{\r\nint ret = 0;\r\nif (id && strcmp(id, engine_gost_id)) return 0;\r\nif (!ENGINE_set_id(e, engine_gost_id))\r\n{\r\nprintf("ENGINE_set_id failed\n");\r\ngoto end;\r\n}\r\nif (!ENGINE_set_name(e, engine_gost_name))\r\n{\r\nprintf("ENGINE_set_name failed\n");\r\ngoto end;\r\n}\r\nif (!ENGINE_set_digests(e, gost_digests))\r\n{\r\nprintf("ENGINE_set_digests failed\n");\r\ngoto end;\r\n}\r\nif (! ENGINE_set_ciphers(e, gost_ciphers))\r\n{\r\nprintf("ENGINE_set_ciphers failed\n");\r\ngoto end;\r\n}\r\nif (! ENGINE_set_pkey_meths(e, gost_pkey_meths))\r\n{\r\nprintf("ENGINE_set_pkey_meths failed\n");\r\ngoto end;\r\n}\r\nif (! ENGINE_set_pkey_asn1_meths(e, gost_pkey_asn1_meths))\r\n{\r\nprintf("ENGINE_set_pkey_asn1_meths failed\n");\r\ngoto end;\r\n}\r\nif (!ENGINE_set_cmd_defns(e,gost_cmds))\r\n{\r\nfprintf(stderr,"ENGINE_set_cmd_defns failed\n");\r\ngoto end;\r\n}\r\nif (!ENGINE_set_ctrl_function(e,gost_control_func))\r\n{\r\nfprintf(stderr,"ENGINE_set_ctrl_func failed\n");\r\ngoto end;\r\n}\r\nif ( ! ENGINE_set_destroy_function(e, gost_engine_destroy)\r\n|| ! ENGINE_set_init_function(e,gost_engine_init)\r\n|| ! ENGINE_set_finish_function(e,gost_engine_finish))\r\n{\r\ngoto end;\r\n}\r\nif (!register_ameth_gost(NID_id_GostR3410_94, &ameth_GostR3410_94, "GOST94", "GOST R 34.10-94")) goto end;\r\nif (!register_ameth_gost(NID_id_GostR3410_2001, &ameth_GostR3410_2001, "GOST2001", "GOST R 34.10-2001")) goto end;\r\nif (!register_ameth_gost(NID_id_Gost28147_89_MAC, &ameth_Gost28147_MAC,\r\n"GOST-MAC", "GOST 28147-89 MAC")) goto end;\r\nif (!register_pmeth_gost(NID_id_GostR3410_94, &pmeth_GostR3410_94, 0)) goto end;\r\nif (!register_pmeth_gost(NID_id_GostR3410_2001, &pmeth_GostR3410_2001, 0)) goto end;\r\nif (!register_pmeth_gost(NID_id_Gost28147_89_MAC, &pmeth_Gost28147_MAC, 0))\r\ngoto end;\r\nif ( ! ENGINE_register_ciphers(e)\r\n|| ! ENGINE_register_digests(e)\r\n|| ! ENGINE_register_pkey_meths(e)\r\n|| ! EVP_add_cipher(&cipher_gost)\r\n|| ! EVP_add_cipher(&cipher_gost_cpacnt)\r\n|| ! EVP_add_digest(&digest_gost)\r\n|| ! EVP_add_digest(&imit_gost_cpa)\r\n)\r\n{\r\ngoto end;\r\n}\r\nERR_load_GOST_strings();\r\nret = 1;\r\nend:\r\nreturn ret;\r\n}\r\nstatic int gost_digests(ENGINE *e, const EVP_MD **digest,\r\nconst int **nids, int nid)\r\n{\r\nint ok =1 ;\r\nif (!digest)\r\n{\r\n*nids = gost_digest_nids;\r\nreturn 2;\r\n}\r\nif(nid == NID_id_GostR3411_94)\r\n{\r\n*digest = &digest_gost;\r\n}\r\nelse if (nid == NID_id_Gost28147_89_MAC)\r\n{\r\n*digest = &imit_gost_cpa;\r\n}\r\nelse\r\n{\r\nok =0;\r\n*digest = NULL;\r\n}\r\nreturn ok;\r\n}\r\nstatic int gost_ciphers (ENGINE *e,const EVP_CIPHER **cipher,\r\nconst int **nids, int nid)\r\n{\r\nint ok = 1;\r\nif (!cipher)\r\n{\r\n*nids = gost_cipher_nids;\r\nreturn 2;\r\n}\r\nif(nid == NID_id_Gost28147_89)\r\n{\r\n*cipher = &cipher_gost;\r\n}\r\nelse if (nid == NID_gost89_cnt)\r\n{\r\n*cipher = &cipher_gost_cpacnt;\r\n}\r\nelse\r\n{\r\nok = 0;\r\n*cipher = NULL;\r\n}\r\nreturn ok;\r\n}\r\nstatic int gost_pkey_meths (ENGINE *e, EVP_PKEY_METHOD **pmeth,\r\nconst int **nids, int nid)\r\n{\r\nif (!pmeth)\r\n{\r\n*nids = gost_pkey_meth_nids;\r\nreturn 3;\r\n}\r\nswitch (nid)\r\n{\r\ncase NID_id_GostR3410_94: *pmeth = pmeth_GostR3410_94; return 1;\r\ncase NID_id_GostR3410_2001: *pmeth = pmeth_GostR3410_2001; return 1;\r\ncase NID_id_Gost28147_89_MAC: *pmeth = pmeth_Gost28147_MAC; return 1;\r\ndefault:;\r\n}\r\n*pmeth = NULL;\r\nreturn 0;\r\n}\r\nstatic int gost_pkey_asn1_meths (ENGINE *e, EVP_PKEY_ASN1_METHOD **ameth,\r\nconst int **nids, int nid)\r\n{\r\nif (!ameth)\r\n{\r\n*nids = gost_pkey_meth_nids;\r\nreturn 3;\r\n}\r\nswitch (nid)\r\n{\r\ncase NID_id_GostR3410_94: *ameth = ameth_GostR3410_94; return 1;\r\ncase NID_id_GostR3410_2001: *ameth = ameth_GostR3410_2001; return 1;\r\ncase NID_id_Gost28147_89_MAC: *ameth = ameth_Gost28147_MAC; return 1;\r\ndefault:;\r\n}\r\n*ameth = NULL;\r\nreturn 0;\r\n}\r\nstatic ENGINE *engine_gost(void)\r\n{\r\nENGINE *ret = ENGINE_new();\r\nif (!ret)\r\nreturn NULL;\r\nif (!bind_gost(ret,engine_gost_id))\r\n{\r\nENGINE_free(ret);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nvoid ENGINE_load_gost(void)\r\n{\r\nENGINE *toadd =engine_gost();\r\nif (!toadd) return;\r\nENGINE_add(toadd);\r\nENGINE_free(toadd);\r\nERR_clear_error();\r\n}

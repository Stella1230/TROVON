BN_ULONG bn_mul_add_words(BN_ULONG *rp, const BN_ULONG *ap, int num, BN_ULONG w)\r\n{\r\nBN_ULONG c1=0;\r\nif (num <= 0) return(c1);\r\nwhile (num&~3)\r\n{\r\nmul_add(rp[0],ap[0],w,c1);\r\nmul_add(rp[1],ap[1],w,c1);\r\nmul_add(rp[2],ap[2],w,c1);\r\nmul_add(rp[3],ap[3],w,c1);\r\nap+=4; rp+=4; num-=4;\r\n}\r\nif (num)\r\n{\r\nmul_add(rp[0],ap[0],w,c1); if (--num==0) return c1;\r\nmul_add(rp[1],ap[1],w,c1); if (--num==0) return c1;\r\nmul_add(rp[2],ap[2],w,c1); return c1;\r\n}\r\nreturn(c1);\r\n}\r\nBN_ULONG bn_mul_words(BN_ULONG *rp, const BN_ULONG *ap, int num, BN_ULONG w)\r\n{\r\nBN_ULONG c1=0;\r\nif (num <= 0) return(c1);\r\nwhile (num&~3)\r\n{\r\nmul(rp[0],ap[0],w,c1);\r\nmul(rp[1],ap[1],w,c1);\r\nmul(rp[2],ap[2],w,c1);\r\nmul(rp[3],ap[3],w,c1);\r\nap+=4; rp+=4; num-=4;\r\n}\r\nif (num)\r\n{\r\nmul(rp[0],ap[0],w,c1); if (--num == 0) return c1;\r\nmul(rp[1],ap[1],w,c1); if (--num == 0) return c1;\r\nmul(rp[2],ap[2],w,c1);\r\n}\r\nreturn(c1);\r\n}\r\nvoid bn_sqr_words(BN_ULONG *r, const BN_ULONG *a, int n)\r\n{\r\nif (n <= 0) return;\r\nwhile (n&~3)\r\n{\r\nsqr(r[0],r[1],a[0]);\r\nsqr(r[2],r[3],a[1]);\r\nsqr(r[4],r[5],a[2]);\r\nsqr(r[6],r[7],a[3]);\r\na+=4; r+=8; n-=4;\r\n}\r\nif (n)\r\n{\r\nsqr(r[0],r[1],a[0]); if (--n == 0) return;\r\nsqr(r[2],r[3],a[1]); if (--n == 0) return;\r\nsqr(r[4],r[5],a[2]);\r\n}\r\n}\r\nBN_ULONG bn_div_words(BN_ULONG h, BN_ULONG l, BN_ULONG d)\r\n{ BN_ULONG ret,waste;\r\nasm ("divq %4"\r\n: "=a"(ret),"=d"(waste)\r\n: "a"(l),"d"(h),"g"(d)\r\n: "cc");\r\nreturn ret;\r\n}\r\nBN_ULONG bn_add_words (BN_ULONG *rp, const BN_ULONG *ap, const BN_ULONG *bp,int n)\r\n{ BN_ULONG ret=0,i=0;\r\nif (n <= 0) return 0;\r\nasm (\r\n" subq %2,%2 \n"\r\n".p2align 4 \n"\r\n"1: movq (%4,%2,8),%0 \n"\r\n" adcq (%5,%2,8),%0 \n"\r\n" movq %0,(%3,%2,8) \n"\r\n" leaq 1(%2),%2 \n"\r\n" loop 1b \n"\r\n" sbbq %0,%0 \n"\r\n: "=&a"(ret),"+c"(n),"=&r"(i)\r\n: "r"(rp),"r"(ap),"r"(bp)\r\n: "cc"\r\n);\r\nreturn ret&1;\r\n}\r\nBN_ULONG bn_sub_words (BN_ULONG *rp, const BN_ULONG *ap, const BN_ULONG *bp,int n)\r\n{ BN_ULONG ret=0,i=0;\r\nif (n <= 0) return 0;\r\nasm (\r\n" subq %2,%2 \n"\r\n".p2align 4 \n"\r\n"1: movq (%4,%2,8),%0 \n"\r\n" sbbq (%5,%2,8),%0 \n"\r\n" movq %0,(%3,%2,8) \n"\r\n" leaq 1(%2),%2 \n"\r\n" loop 1b \n"\r\n" sbbq %0,%0 \n"\r\n: "=&a"(ret),"+c"(n),"=&r"(i)\r\n: "r"(rp),"r"(ap),"r"(bp)\r\n: "cc"\r\n);\r\nreturn ret&1;\r\n}\r\nBN_ULONG bn_sub_words(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b, int n)\r\n{\r\nBN_ULONG t1,t2;\r\nint c=0;\r\nif (n <= 0) return((BN_ULONG)0);\r\nfor (;;)\r\n{\r\nt1=a[0]; t2=b[0];\r\nr[0]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nif (--n <= 0) break;\r\nt1=a[1]; t2=b[1];\r\nr[1]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nif (--n <= 0) break;\r\nt1=a[2]; t2=b[2];\r\nr[2]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nif (--n <= 0) break;\r\nt1=a[3]; t2=b[3];\r\nr[3]=(t1-t2-c)&BN_MASK2;\r\nif (t1 != t2) c=(t1 < t2);\r\nif (--n <= 0) break;\r\na+=4;\r\nb+=4;\r\nr+=4;\r\n}\r\nreturn(c);\r\n}\r\nvoid bn_mul_comba8(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b)\r\n{\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nmul_add_c(a[0],b[0],c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nmul_add_c(a[0],b[1],c2,c3,c1);\r\nmul_add_c(a[1],b[0],c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nmul_add_c(a[2],b[0],c3,c1,c2);\r\nmul_add_c(a[1],b[1],c3,c1,c2);\r\nmul_add_c(a[0],b[2],c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nmul_add_c(a[0],b[3],c1,c2,c3);\r\nmul_add_c(a[1],b[2],c1,c2,c3);\r\nmul_add_c(a[2],b[1],c1,c2,c3);\r\nmul_add_c(a[3],b[0],c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nmul_add_c(a[4],b[0],c2,c3,c1);\r\nmul_add_c(a[3],b[1],c2,c3,c1);\r\nmul_add_c(a[2],b[2],c2,c3,c1);\r\nmul_add_c(a[1],b[3],c2,c3,c1);\r\nmul_add_c(a[0],b[4],c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nmul_add_c(a[0],b[5],c3,c1,c2);\r\nmul_add_c(a[1],b[4],c3,c1,c2);\r\nmul_add_c(a[2],b[3],c3,c1,c2);\r\nmul_add_c(a[3],b[2],c3,c1,c2);\r\nmul_add_c(a[4],b[1],c3,c1,c2);\r\nmul_add_c(a[5],b[0],c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nmul_add_c(a[6],b[0],c1,c2,c3);\r\nmul_add_c(a[5],b[1],c1,c2,c3);\r\nmul_add_c(a[4],b[2],c1,c2,c3);\r\nmul_add_c(a[3],b[3],c1,c2,c3);\r\nmul_add_c(a[2],b[4],c1,c2,c3);\r\nmul_add_c(a[1],b[5],c1,c2,c3);\r\nmul_add_c(a[0],b[6],c1,c2,c3);\r\nr[6]=c1;\r\nc1=0;\r\nmul_add_c(a[0],b[7],c2,c3,c1);\r\nmul_add_c(a[1],b[6],c2,c3,c1);\r\nmul_add_c(a[2],b[5],c2,c3,c1);\r\nmul_add_c(a[3],b[4],c2,c3,c1);\r\nmul_add_c(a[4],b[3],c2,c3,c1);\r\nmul_add_c(a[5],b[2],c2,c3,c1);\r\nmul_add_c(a[6],b[1],c2,c3,c1);\r\nmul_add_c(a[7],b[0],c2,c3,c1);\r\nr[7]=c2;\r\nc2=0;\r\nmul_add_c(a[7],b[1],c3,c1,c2);\r\nmul_add_c(a[6],b[2],c3,c1,c2);\r\nmul_add_c(a[5],b[3],c3,c1,c2);\r\nmul_add_c(a[4],b[4],c3,c1,c2);\r\nmul_add_c(a[3],b[5],c3,c1,c2);\r\nmul_add_c(a[2],b[6],c3,c1,c2);\r\nmul_add_c(a[1],b[7],c3,c1,c2);\r\nr[8]=c3;\r\nc3=0;\r\nmul_add_c(a[2],b[7],c1,c2,c3);\r\nmul_add_c(a[3],b[6],c1,c2,c3);\r\nmul_add_c(a[4],b[5],c1,c2,c3);\r\nmul_add_c(a[5],b[4],c1,c2,c3);\r\nmul_add_c(a[6],b[3],c1,c2,c3);\r\nmul_add_c(a[7],b[2],c1,c2,c3);\r\nr[9]=c1;\r\nc1=0;\r\nmul_add_c(a[7],b[3],c2,c3,c1);\r\nmul_add_c(a[6],b[4],c2,c3,c1);\r\nmul_add_c(a[5],b[5],c2,c3,c1);\r\nmul_add_c(a[4],b[6],c2,c3,c1);\r\nmul_add_c(a[3],b[7],c2,c3,c1);\r\nr[10]=c2;\r\nc2=0;\r\nmul_add_c(a[4],b[7],c3,c1,c2);\r\nmul_add_c(a[5],b[6],c3,c1,c2);\r\nmul_add_c(a[6],b[5],c3,c1,c2);\r\nmul_add_c(a[7],b[4],c3,c1,c2);\r\nr[11]=c3;\r\nc3=0;\r\nmul_add_c(a[7],b[5],c1,c2,c3);\r\nmul_add_c(a[6],b[6],c1,c2,c3);\r\nmul_add_c(a[5],b[7],c1,c2,c3);\r\nr[12]=c1;\r\nc1=0;\r\nmul_add_c(a[6],b[7],c2,c3,c1);\r\nmul_add_c(a[7],b[6],c2,c3,c1);\r\nr[13]=c2;\r\nc2=0;\r\nmul_add_c(a[7],b[7],c3,c1,c2);\r\nr[14]=c3;\r\nr[15]=c1;\r\n}\r\nvoid bn_mul_comba4(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b)\r\n{\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nmul_add_c(a[0],b[0],c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nmul_add_c(a[0],b[1],c2,c3,c1);\r\nmul_add_c(a[1],b[0],c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nmul_add_c(a[2],b[0],c3,c1,c2);\r\nmul_add_c(a[1],b[1],c3,c1,c2);\r\nmul_add_c(a[0],b[2],c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nmul_add_c(a[0],b[3],c1,c2,c3);\r\nmul_add_c(a[1],b[2],c1,c2,c3);\r\nmul_add_c(a[2],b[1],c1,c2,c3);\r\nmul_add_c(a[3],b[0],c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nmul_add_c(a[3],b[1],c2,c3,c1);\r\nmul_add_c(a[2],b[2],c2,c3,c1);\r\nmul_add_c(a[1],b[3],c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nmul_add_c(a[2],b[3],c3,c1,c2);\r\nmul_add_c(a[3],b[2],c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nmul_add_c(a[3],b[3],c1,c2,c3);\r\nr[6]=c1;\r\nr[7]=c2;\r\n}\r\nvoid bn_sqr_comba8(BN_ULONG *r, const BN_ULONG *a)\r\n{\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nsqr_add_c(a,0,c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nsqr_add_c2(a,1,0,c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nsqr_add_c(a,1,c3,c1,c2);\r\nsqr_add_c2(a,2,0,c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nsqr_add_c2(a,3,0,c1,c2,c3);\r\nsqr_add_c2(a,2,1,c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nsqr_add_c(a,2,c2,c3,c1);\r\nsqr_add_c2(a,3,1,c2,c3,c1);\r\nsqr_add_c2(a,4,0,c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nsqr_add_c2(a,5,0,c3,c1,c2);\r\nsqr_add_c2(a,4,1,c3,c1,c2);\r\nsqr_add_c2(a,3,2,c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nsqr_add_c(a,3,c1,c2,c3);\r\nsqr_add_c2(a,4,2,c1,c2,c3);\r\nsqr_add_c2(a,5,1,c1,c2,c3);\r\nsqr_add_c2(a,6,0,c1,c2,c3);\r\nr[6]=c1;\r\nc1=0;\r\nsqr_add_c2(a,7,0,c2,c3,c1);\r\nsqr_add_c2(a,6,1,c2,c3,c1);\r\nsqr_add_c2(a,5,2,c2,c3,c1);\r\nsqr_add_c2(a,4,3,c2,c3,c1);\r\nr[7]=c2;\r\nc2=0;\r\nsqr_add_c(a,4,c3,c1,c2);\r\nsqr_add_c2(a,5,3,c3,c1,c2);\r\nsqr_add_c2(a,6,2,c3,c1,c2);\r\nsqr_add_c2(a,7,1,c3,c1,c2);\r\nr[8]=c3;\r\nc3=0;\r\nsqr_add_c2(a,7,2,c1,c2,c3);\r\nsqr_add_c2(a,6,3,c1,c2,c3);\r\nsqr_add_c2(a,5,4,c1,c2,c3);\r\nr[9]=c1;\r\nc1=0;\r\nsqr_add_c(a,5,c2,c3,c1);\r\nsqr_add_c2(a,6,4,c2,c3,c1);\r\nsqr_add_c2(a,7,3,c2,c3,c1);\r\nr[10]=c2;\r\nc2=0;\r\nsqr_add_c2(a,7,4,c3,c1,c2);\r\nsqr_add_c2(a,6,5,c3,c1,c2);\r\nr[11]=c3;\r\nc3=0;\r\nsqr_add_c(a,6,c1,c2,c3);\r\nsqr_add_c2(a,7,5,c1,c2,c3);\r\nr[12]=c1;\r\nc1=0;\r\nsqr_add_c2(a,7,6,c2,c3,c1);\r\nr[13]=c2;\r\nc2=0;\r\nsqr_add_c(a,7,c3,c1,c2);\r\nr[14]=c3;\r\nr[15]=c1;\r\n}\r\nvoid bn_sqr_comba4(BN_ULONG *r, const BN_ULONG *a)\r\n{\r\nBN_ULONG t1,t2;\r\nBN_ULONG c1,c2,c3;\r\nc1=0;\r\nc2=0;\r\nc3=0;\r\nsqr_add_c(a,0,c1,c2,c3);\r\nr[0]=c1;\r\nc1=0;\r\nsqr_add_c2(a,1,0,c2,c3,c1);\r\nr[1]=c2;\r\nc2=0;\r\nsqr_add_c(a,1,c3,c1,c2);\r\nsqr_add_c2(a,2,0,c3,c1,c2);\r\nr[2]=c3;\r\nc3=0;\r\nsqr_add_c2(a,3,0,c1,c2,c3);\r\nsqr_add_c2(a,2,1,c1,c2,c3);\r\nr[3]=c1;\r\nc1=0;\r\nsqr_add_c(a,2,c2,c3,c1);\r\nsqr_add_c2(a,3,1,c2,c3,c1);\r\nr[4]=c2;\r\nc2=0;\r\nsqr_add_c2(a,3,2,c3,c1,c2);\r\nr[5]=c3;\r\nc3=0;\r\nsqr_add_c(a,3,c1,c2,c3);\r\nr[6]=c1;\r\nr[7]=c2;\r\n}

X509_EXTENSION *X509V3_EXT_nconf(CONF *conf, X509V3_CTX *ctx, char *name,\r\nchar *value)\r\n{\r\nint crit;\r\nint ext_type;\r\nX509_EXTENSION *ret;\r\ncrit = v3_check_critical(&value);\r\nif ((ext_type = v3_check_generic(&value)))\r\nreturn v3_generic_extension(name, value, crit, ext_type, ctx);\r\nret = do_ext_nconf(conf, ctx, OBJ_sn2nid(name), crit, value);\r\nif (!ret)\r\n{\r\nX509V3err(X509V3_F_X509V3_EXT_NCONF,X509V3_R_ERROR_IN_EXTENSION);\r\nERR_add_error_data(4,"name=", name, ", value=", value);\r\n}\r\nreturn ret;\r\n}\r\nX509_EXTENSION *X509V3_EXT_nconf_nid(CONF *conf, X509V3_CTX *ctx, int ext_nid,\r\nchar *value)\r\n{\r\nint crit;\r\nint ext_type;\r\ncrit = v3_check_critical(&value);\r\nif ((ext_type = v3_check_generic(&value)))\r\nreturn v3_generic_extension(OBJ_nid2sn(ext_nid),\r\nvalue, crit, ext_type, ctx);\r\nreturn do_ext_nconf(conf, ctx, ext_nid, crit, value);\r\n}\r\nstatic X509_EXTENSION *do_ext_nconf(CONF *conf, X509V3_CTX *ctx, int ext_nid,\r\nint crit, char *value)\r\n{\r\nconst X509V3_EXT_METHOD *method;\r\nX509_EXTENSION *ext;\r\nSTACK_OF(CONF_VALUE) *nval;\r\nvoid *ext_struc;\r\nif (ext_nid == NID_undef)\r\n{\r\nX509V3err(X509V3_F_DO_EXT_NCONF,X509V3_R_UNKNOWN_EXTENSION_NAME);\r\nreturn NULL;\r\n}\r\nif (!(method = X509V3_EXT_get_nid(ext_nid)))\r\n{\r\nX509V3err(X509V3_F_DO_EXT_NCONF,X509V3_R_UNKNOWN_EXTENSION);\r\nreturn NULL;\r\n}\r\nif (method->v2i)\r\n{\r\nif(*value == '@') nval = NCONF_get_section(conf, value + 1);\r\nelse nval = X509V3_parse_list(value);\r\nif(sk_CONF_VALUE_num(nval) <= 0)\r\n{\r\nX509V3err(X509V3_F_DO_EXT_NCONF,X509V3_R_INVALID_EXTENSION_STRING);\r\nERR_add_error_data(4, "name=", OBJ_nid2sn(ext_nid), ",section=", value);\r\nreturn NULL;\r\n}\r\next_struc = method->v2i(method, ctx, nval);\r\nif(*value != '@') sk_CONF_VALUE_pop_free(nval,\r\nX509V3_conf_free);\r\nif(!ext_struc) return NULL;\r\n}\r\nelse if(method->s2i)\r\n{\r\nif(!(ext_struc = method->s2i(method, ctx, value))) return NULL;\r\n}\r\nelse if(method->r2i)\r\n{\r\nif(!ctx->db || !ctx->db_meth)\r\n{\r\nX509V3err(X509V3_F_DO_EXT_NCONF,X509V3_R_NO_CONFIG_DATABASE);\r\nreturn NULL;\r\n}\r\nif(!(ext_struc = method->r2i(method, ctx, value))) return NULL;\r\n}\r\nelse\r\n{\r\nX509V3err(X509V3_F_DO_EXT_NCONF,X509V3_R_EXTENSION_SETTING_NOT_SUPPORTED);\r\nERR_add_error_data(2, "name=", OBJ_nid2sn(ext_nid));\r\nreturn NULL;\r\n}\r\next = do_ext_i2d(method, ext_nid, crit, ext_struc);\r\nif(method->it) ASN1_item_free(ext_struc, ASN1_ITEM_ptr(method->it));\r\nelse method->ext_free(ext_struc);\r\nreturn ext;\r\n}\r\nstatic X509_EXTENSION *do_ext_i2d(const X509V3_EXT_METHOD *method, int ext_nid,\r\nint crit, void *ext_struc)\r\n{\r\nunsigned char *ext_der;\r\nint ext_len;\r\nASN1_OCTET_STRING *ext_oct;\r\nX509_EXTENSION *ext;\r\nif (method->it)\r\n{\r\next_der = NULL;\r\next_len = ASN1_item_i2d(ext_struc, &ext_der, ASN1_ITEM_ptr(method->it));\r\nif (ext_len < 0) goto merr;\r\n}\r\nelse\r\n{\r\nunsigned char *p;\r\next_len = method->i2d(ext_struc, NULL);\r\nif(!(ext_der = OPENSSL_malloc(ext_len))) goto merr;\r\np = ext_der;\r\nmethod->i2d(ext_struc, &p);\r\n}\r\nif (!(ext_oct = M_ASN1_OCTET_STRING_new())) goto merr;\r\next_oct->data = ext_der;\r\next_oct->length = ext_len;\r\next = X509_EXTENSION_create_by_NID(NULL, ext_nid, crit, ext_oct);\r\nif (!ext) goto merr;\r\nM_ASN1_OCTET_STRING_free(ext_oct);\r\nreturn ext;\r\nmerr:\r\nX509V3err(X509V3_F_DO_EXT_I2D,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nX509_EXTENSION *X509V3_EXT_i2d(int ext_nid, int crit, void *ext_struc)\r\n{\r\nconst X509V3_EXT_METHOD *method;\r\nif (!(method = X509V3_EXT_get_nid(ext_nid))) {\r\nX509V3err(X509V3_F_X509V3_EXT_I2D,X509V3_R_UNKNOWN_EXTENSION);\r\nreturn NULL;\r\n}\r\nreturn do_ext_i2d(method, ext_nid, crit, ext_struc);\r\n}\r\nstatic int v3_check_critical(char **value)\r\n{\r\nchar *p = *value;\r\nif ((strlen(p) < 9) || strncmp(p, "critical,", 9)) return 0;\r\np+=9;\r\nwhile(isspace((unsigned char)*p)) p++;\r\n*value = p;\r\nreturn 1;\r\n}\r\nstatic int v3_check_generic(char **value)\r\n{\r\nint gen_type = 0;\r\nchar *p = *value;\r\nif ((strlen(p) >= 4) && !strncmp(p, "DER:", 4))\r\n{\r\np+=4;\r\ngen_type = 1;\r\n}\r\nelse if ((strlen(p) >= 5) && !strncmp(p, "ASN1:", 5))\r\n{\r\np+=5;\r\ngen_type = 2;\r\n}\r\nelse\r\nreturn 0;\r\nwhile (isspace((unsigned char)*p)) p++;\r\n*value = p;\r\nreturn gen_type;\r\n}\r\nstatic X509_EXTENSION *v3_generic_extension(const char *ext, char *value,\r\nint crit, int gen_type,\r\nX509V3_CTX *ctx)\r\n{\r\nunsigned char *ext_der=NULL;\r\nlong ext_len;\r\nASN1_OBJECT *obj=NULL;\r\nASN1_OCTET_STRING *oct=NULL;\r\nX509_EXTENSION *extension=NULL;\r\nif (!(obj = OBJ_txt2obj(ext, 0)))\r\n{\r\nX509V3err(X509V3_F_V3_GENERIC_EXTENSION,X509V3_R_EXTENSION_NAME_ERROR);\r\nERR_add_error_data(2, "name=", ext);\r\ngoto err;\r\n}\r\nif (gen_type == 1)\r\next_der = string_to_hex(value, &ext_len);\r\nelse if (gen_type == 2)\r\next_der = generic_asn1(value, ctx, &ext_len);\r\nif (ext_der == NULL)\r\n{\r\nX509V3err(X509V3_F_V3_GENERIC_EXTENSION,X509V3_R_EXTENSION_VALUE_ERROR);\r\nERR_add_error_data(2, "value=", value);\r\ngoto err;\r\n}\r\nif (!(oct = M_ASN1_OCTET_STRING_new()))\r\n{\r\nX509V3err(X509V3_F_V3_GENERIC_EXTENSION,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\noct->data = ext_der;\r\noct->length = ext_len;\r\next_der = NULL;\r\nextension = X509_EXTENSION_create_by_OBJ(NULL, obj, crit, oct);\r\nerr:\r\nASN1_OBJECT_free(obj);\r\nM_ASN1_OCTET_STRING_free(oct);\r\nif(ext_der) OPENSSL_free(ext_der);\r\nreturn extension;\r\n}\r\nstatic unsigned char *generic_asn1(char *value, X509V3_CTX *ctx, long *ext_len)\r\n{\r\nASN1_TYPE *typ;\r\nunsigned char *ext_der = NULL;\r\ntyp = ASN1_generate_v3(value, ctx);\r\nif (typ == NULL)\r\nreturn NULL;\r\n*ext_len = i2d_ASN1_TYPE(typ, &ext_der);\r\nASN1_TYPE_free(typ);\r\nreturn ext_der;\r\n}\r\nint X509V3_EXT_add_nconf(CONF *conf, X509V3_CTX *ctx, char *section,\r\nX509 *cert)\r\n{\r\nSTACK_OF(X509_EXTENSION) **sk = NULL;\r\nif (cert)\r\nsk = &cert->cert_info->extensions;\r\nreturn X509V3_EXT_add_nconf_sk(conf, ctx, section, sk);\r\n}\r\nint X509V3_EXT_CRL_add_nconf(CONF *conf, X509V3_CTX *ctx, char *section,\r\nX509_CRL *crl)\r\n{\r\nSTACK_OF(X509_EXTENSION) **sk = NULL;\r\nif (crl)\r\nsk = &crl->crl->extensions;\r\nreturn X509V3_EXT_add_nconf_sk(conf, ctx, section, sk);\r\n}\r\nint X509V3_EXT_REQ_add_nconf(CONF *conf, X509V3_CTX *ctx, char *section,\r\nX509_REQ *req)\r\n{\r\nSTACK_OF(X509_EXTENSION) *extlist = NULL, **sk = NULL;\r\nint i;\r\nif (req)\r\nsk = &extlist;\r\ni = X509V3_EXT_add_nconf_sk(conf, ctx, section, sk);\r\nif (!i || !sk)\r\nreturn i;\r\ni = X509_REQ_add_extensions(req, extlist);\r\nsk_X509_EXTENSION_pop_free(extlist, X509_EXTENSION_free);\r\nreturn i;\r\n}\r\nchar * X509V3_get_string(X509V3_CTX *ctx, char *name, char *section)\r\n{\r\nif(!ctx->db || !ctx->db_meth || !ctx->db_meth->get_string)\r\n{\r\nX509V3err(X509V3_F_X509V3_GET_STRING,X509V3_R_OPERATION_NOT_DEFINED);\r\nreturn NULL;\r\n}\r\nif (ctx->db_meth->get_string)\r\nreturn ctx->db_meth->get_string(ctx->db, name, section);\r\nreturn NULL;\r\n}\r\nstatic char *nconf_get_string(void *db, char *section, char *value)\r\n{\r\nreturn NCONF_get_string(db, section, value);\r\n}\r\nvoid X509V3_set_nconf(X509V3_CTX *ctx, CONF *conf)\r\n{\r\nctx->db_meth = &nconf_method;\r\nctx->db = conf;\r\n}\r\nvoid X509V3_set_ctx(X509V3_CTX *ctx, X509 *issuer, X509 *subj, X509_REQ *req,\r\nX509_CRL *crl, int flags)\r\n{\r\nctx->issuer_cert = issuer;\r\nctx->subject_cert = subj;\r\nctx->crl = crl;\r\nctx->subject_req = req;\r\nctx->flags = flags;\r\n}\r\nstatic char *conf_lhash_get_string(void *db, char *section, char *value)\r\n{\r\nreturn CONF_get_string(db, section, value);\r\n}

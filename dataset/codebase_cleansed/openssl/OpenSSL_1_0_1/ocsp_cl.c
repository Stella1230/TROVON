OCSP_ONEREQ *OCSP_request_add0_id(OCSP_REQUEST *req, OCSP_CERTID *cid)\r\n{\r\nOCSP_ONEREQ *one = NULL;\r\nif (!(one = OCSP_ONEREQ_new())) goto err;\r\nif (one->reqCert) OCSP_CERTID_free(one->reqCert);\r\none->reqCert = cid;\r\nif (req &&\r\n!sk_OCSP_ONEREQ_push(req->tbsRequest->requestList, one))\r\ngoto err;\r\nreturn one;\r\nerr:\r\nOCSP_ONEREQ_free(one);\r\nreturn NULL;\r\n}\r\nint OCSP_request_set1_name(OCSP_REQUEST *req, X509_NAME *nm)\r\n{\r\nGENERAL_NAME *gen;\r\ngen = GENERAL_NAME_new();\r\nif (gen == NULL)\r\nreturn 0;\r\nif (!X509_NAME_set(&gen->d.directoryName, nm))\r\n{\r\nGENERAL_NAME_free(gen);\r\nreturn 0;\r\n}\r\ngen->type = GEN_DIRNAME;\r\nif (req->tbsRequest->requestorName)\r\nGENERAL_NAME_free(req->tbsRequest->requestorName);\r\nreq->tbsRequest->requestorName = gen;\r\nreturn 1;\r\n}\r\nint OCSP_request_add1_cert(OCSP_REQUEST *req, X509 *cert)\r\n{\r\nOCSP_SIGNATURE *sig;\r\nif (!req->optionalSignature)\r\nreq->optionalSignature = OCSP_SIGNATURE_new();\r\nsig = req->optionalSignature;\r\nif (!sig) return 0;\r\nif (!cert) return 1;\r\nif (!sig->certs && !(sig->certs = sk_X509_new_null()))\r\nreturn 0;\r\nif(!sk_X509_push(sig->certs, cert)) return 0;\r\nCRYPTO_add(&cert->references, 1, CRYPTO_LOCK_X509);\r\nreturn 1;\r\n}\r\nint OCSP_response_status(OCSP_RESPONSE *resp)\r\n{\r\nreturn ASN1_ENUMERATED_get(resp->responseStatus);\r\n}\r\nOCSP_BASICRESP *OCSP_response_get1_basic(OCSP_RESPONSE *resp)\r\n{\r\nOCSP_RESPBYTES *rb;\r\nrb = resp->responseBytes;\r\nif (!rb)\r\n{\r\nOCSPerr(OCSP_F_OCSP_RESPONSE_GET1_BASIC, OCSP_R_NO_RESPONSE_DATA);\r\nreturn NULL;\r\n}\r\nif (OBJ_obj2nid(rb->responseType) != NID_id_pkix_OCSP_basic)\r\n{\r\nOCSPerr(OCSP_F_OCSP_RESPONSE_GET1_BASIC, OCSP_R_NOT_BASIC_RESPONSE);\r\nreturn NULL;\r\n}\r\nreturn ASN1_item_unpack(rb->response, ASN1_ITEM_rptr(OCSP_BASICRESP));\r\n}\r\nint OCSP_resp_count(OCSP_BASICRESP *bs)\r\n{\r\nif (!bs) return -1;\r\nreturn sk_OCSP_SINGLERESP_num(bs->tbsResponseData->responses);\r\n}\r\nOCSP_SINGLERESP *OCSP_resp_get0(OCSP_BASICRESP *bs, int idx)\r\n{\r\nif (!bs) return NULL;\r\nreturn sk_OCSP_SINGLERESP_value(bs->tbsResponseData->responses, idx);\r\n}\r\nint OCSP_resp_find(OCSP_BASICRESP *bs, OCSP_CERTID *id, int last)\r\n{\r\nint i;\r\nSTACK_OF(OCSP_SINGLERESP) *sresp;\r\nOCSP_SINGLERESP *single;\r\nif (!bs) return -1;\r\nif (last < 0) last = 0;\r\nelse last++;\r\nsresp = bs->tbsResponseData->responses;\r\nfor (i = last; i < sk_OCSP_SINGLERESP_num(sresp); i++)\r\n{\r\nsingle = sk_OCSP_SINGLERESP_value(sresp, i);\r\nif (!OCSP_id_cmp(id, single->certId)) return i;\r\n}\r\nreturn -1;\r\n}\r\nint OCSP_single_get0_status(OCSP_SINGLERESP *single, int *reason,\r\nASN1_GENERALIZEDTIME **revtime,\r\nASN1_GENERALIZEDTIME **thisupd,\r\nASN1_GENERALIZEDTIME **nextupd)\r\n{\r\nint ret;\r\nOCSP_CERTSTATUS *cst;\r\nif(!single) return -1;\r\ncst = single->certStatus;\r\nret = cst->type;\r\nif (ret == V_OCSP_CERTSTATUS_REVOKED)\r\n{\r\nOCSP_REVOKEDINFO *rev = cst->value.revoked;\r\nif (revtime) *revtime = rev->revocationTime;\r\nif (reason)\r\n{\r\nif(rev->revocationReason)\r\n*reason = ASN1_ENUMERATED_get(rev->revocationReason);\r\nelse *reason = -1;\r\n}\r\n}\r\nif(thisupd) *thisupd = single->thisUpdate;\r\nif(nextupd) *nextupd = single->nextUpdate;\r\nreturn ret;\r\n}\r\nint OCSP_resp_find_status(OCSP_BASICRESP *bs, OCSP_CERTID *id, int *status,\r\nint *reason,\r\nASN1_GENERALIZEDTIME **revtime,\r\nASN1_GENERALIZEDTIME **thisupd,\r\nASN1_GENERALIZEDTIME **nextupd)\r\n{\r\nint i;\r\nOCSP_SINGLERESP *single;\r\ni = OCSP_resp_find(bs, id, -1);\r\nif(i < 0) return 0;\r\nsingle = OCSP_resp_get0(bs, i);\r\ni = OCSP_single_get0_status(single, reason, revtime, thisupd, nextupd);\r\nif(status) *status = i;\r\nreturn 1;\r\n}\r\nint OCSP_check_validity(ASN1_GENERALIZEDTIME *thisupd, ASN1_GENERALIZEDTIME *nextupd, long nsec, long maxsec)\r\n{\r\nint ret = 1;\r\ntime_t t_now, t_tmp;\r\ntime(&t_now);\r\nif (!ASN1_GENERALIZEDTIME_check(thisupd))\r\n{\r\nOCSPerr(OCSP_F_OCSP_CHECK_VALIDITY, OCSP_R_ERROR_IN_THISUPDATE_FIELD);\r\nret = 0;\r\n}\r\nelse\r\n{\r\nt_tmp = t_now + nsec;\r\nif (X509_cmp_time(thisupd, &t_tmp) > 0)\r\n{\r\nOCSPerr(OCSP_F_OCSP_CHECK_VALIDITY, OCSP_R_STATUS_NOT_YET_VALID);\r\nret = 0;\r\n}\r\nif (maxsec >= 0)\r\n{\r\nt_tmp = t_now - maxsec;\r\nif (X509_cmp_time(thisupd, &t_tmp) < 0)\r\n{\r\nOCSPerr(OCSP_F_OCSP_CHECK_VALIDITY, OCSP_R_STATUS_TOO_OLD);\r\nret = 0;\r\n}\r\n}\r\n}\r\nif (!nextupd) return ret;\r\nif (!ASN1_GENERALIZEDTIME_check(nextupd))\r\n{\r\nOCSPerr(OCSP_F_OCSP_CHECK_VALIDITY, OCSP_R_ERROR_IN_NEXTUPDATE_FIELD);\r\nret = 0;\r\n}\r\nelse\r\n{\r\nt_tmp = t_now - nsec;\r\nif (X509_cmp_time(nextupd, &t_tmp) < 0)\r\n{\r\nOCSPerr(OCSP_F_OCSP_CHECK_VALIDITY, OCSP_R_STATUS_EXPIRED);\r\nret = 0;\r\n}\r\n}\r\nif (ASN1_STRING_cmp(nextupd, thisupd) < 0)\r\n{\r\nOCSPerr(OCSP_F_OCSP_CHECK_VALIDITY, OCSP_R_NEXTUPDATE_BEFORE_THISUPDATE);\r\nret = 0;\r\n}\r\nreturn ret;\r\n}

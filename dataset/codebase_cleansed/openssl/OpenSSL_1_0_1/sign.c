int main ()\r\n{\r\nint err;\r\nint sig_len;\r\nunsigned char sig_buf [4096];\r\nstatic char certfile[] = "cert.pem";\r\nstatic char keyfile[] = "key.pem";\r\nstatic char data[] = "I owe you...";\r\nEVP_MD_CTX md_ctx;\r\nEVP_PKEY * pkey;\r\nFILE * fp;\r\nX509 * x509;\r\nERR_load_crypto_strings();\r\nfp = fopen (keyfile, "r");\r\nif (fp == NULL) exit (1);\r\npkey = PEM_read_PrivateKey(fp, NULL, NULL, NULL);\r\nfclose (fp);\r\nif (pkey == NULL) {\r\nERR_print_errors_fp (stderr);\r\nexit (1);\r\n}\r\nEVP_SignInit (&md_ctx, EVP_sha1());\r\nEVP_SignUpdate (&md_ctx, data, strlen(data));\r\nsig_len = sizeof(sig_buf);\r\nerr = EVP_SignFinal (&md_ctx, sig_buf, &sig_len, pkey);\r\nif (err != 1) {\r\nERR_print_errors_fp(stderr);\r\nexit (1);\r\n}\r\nEVP_PKEY_free (pkey);\r\nfp = fopen (certfile, "r");\r\nif (fp == NULL) exit (1);\r\nx509 = PEM_read_X509(fp, NULL, NULL, NULL);\r\nfclose (fp);\r\nif (x509 == NULL) {\r\nERR_print_errors_fp (stderr);\r\nexit (1);\r\n}\r\npkey=X509_get_pubkey(x509);\r\nif (pkey == NULL) {\r\nERR_print_errors_fp (stderr);\r\nexit (1);\r\n}\r\nEVP_VerifyInit (&md_ctx, EVP_sha1());\r\nEVP_VerifyUpdate (&md_ctx, data, strlen((char*)data));\r\nerr = EVP_VerifyFinal (&md_ctx, sig_buf, sig_len, pkey);\r\nEVP_PKEY_free (pkey);\r\nif (err != 1) {\r\nERR_print_errors_fp (stderr);\r\nexit (1);\r\n}\r\nprintf ("Signature Verified Ok.\n");\r\nreturn(0);\r\n}

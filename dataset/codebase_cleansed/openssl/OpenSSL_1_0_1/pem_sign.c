void PEM_SignInit(EVP_MD_CTX *ctx, EVP_MD *type)\r\n{\r\nEVP_DigestInit_ex(ctx, type, NULL);\r\n}\r\nvoid PEM_SignUpdate(EVP_MD_CTX *ctx, unsigned char *data,\r\nunsigned int count)\r\n{\r\nEVP_DigestUpdate(ctx,data,count);\r\n}\r\nint PEM_SignFinal(EVP_MD_CTX *ctx, unsigned char *sigret, unsigned int *siglen,\r\nEVP_PKEY *pkey)\r\n{\r\nunsigned char *m;\r\nint i,ret=0;\r\nunsigned int m_len;\r\nm=(unsigned char *)OPENSSL_malloc(EVP_PKEY_size(pkey)+2);\r\nif (m == NULL)\r\n{\r\nPEMerr(PEM_F_PEM_SIGNFINAL,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif (EVP_SignFinal(ctx,m,&m_len,pkey) <= 0) goto err;\r\ni=EVP_EncodeBlock(sigret,m,m_len);\r\n*siglen=i;\r\nret=1;\r\nerr:\r\nif (m != NULL) OPENSSL_free(m);\r\nreturn(ret);\r\n}

static void engine_list_cleanup(void)\r\n{\r\nENGINE *iterator = engine_list_head;\r\nwhile(iterator != NULL)\r\n{\r\nENGINE_remove(iterator);\r\niterator = engine_list_head;\r\n}\r\nreturn;\r\n}\r\nstatic int engine_list_add(ENGINE *e)\r\n{\r\nint conflict = 0;\r\nENGINE *iterator = NULL;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_LIST_ADD,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\niterator = engine_list_head;\r\nwhile(iterator && !conflict)\r\n{\r\nconflict = (strcmp(iterator->id, e->id) == 0);\r\niterator = iterator->next;\r\n}\r\nif(conflict)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_LIST_ADD,\r\nENGINE_R_CONFLICTING_ENGINE_ID);\r\nreturn 0;\r\n}\r\nif(engine_list_head == NULL)\r\n{\r\nif(engine_list_tail)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_LIST_ADD,\r\nENGINE_R_INTERNAL_LIST_ERROR);\r\nreturn 0;\r\n}\r\nengine_list_head = e;\r\ne->prev = NULL;\r\nengine_cleanup_add_last(engine_list_cleanup);\r\n}\r\nelse\r\n{\r\nif((engine_list_tail == NULL) ||\r\n(engine_list_tail->next != NULL))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_LIST_ADD,\r\nENGINE_R_INTERNAL_LIST_ERROR);\r\nreturn 0;\r\n}\r\nengine_list_tail->next = e;\r\ne->prev = engine_list_tail;\r\n}\r\ne->struct_ref++;\r\nengine_ref_debug(e, 0, 1)\r\nengine_list_tail = e;\r\ne->next = NULL;\r\nreturn 1;\r\n}\r\nstatic int engine_list_remove(ENGINE *e)\r\n{\r\nENGINE *iterator;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_LIST_REMOVE,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\niterator = engine_list_head;\r\nwhile(iterator && (iterator != e))\r\niterator = iterator->next;\r\nif(iterator == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_LIST_REMOVE,\r\nENGINE_R_ENGINE_IS_NOT_IN_LIST);\r\nreturn 0;\r\n}\r\nif(e->next)\r\ne->next->prev = e->prev;\r\nif(e->prev)\r\ne->prev->next = e->next;\r\nif(engine_list_head == e)\r\nengine_list_head = e->next;\r\nif(engine_list_tail == e)\r\nengine_list_tail = e->prev;\r\nengine_free_util(e, 0);\r\nreturn 1;\r\n}\r\nENGINE *ENGINE_get_first(void)\r\n{\r\nENGINE *ret;\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nret = engine_list_head;\r\nif(ret)\r\n{\r\nret->struct_ref++;\r\nengine_ref_debug(ret, 0, 1)\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nreturn ret;\r\n}\r\nENGINE *ENGINE_get_last(void)\r\n{\r\nENGINE *ret;\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nret = engine_list_tail;\r\nif(ret)\r\n{\r\nret->struct_ref++;\r\nengine_ref_debug(ret, 0, 1)\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nreturn ret;\r\n}\r\nENGINE *ENGINE_get_next(ENGINE *e)\r\n{\r\nENGINE *ret = NULL;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_GET_NEXT,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nret = e->next;\r\nif(ret)\r\n{\r\nret->struct_ref++;\r\nengine_ref_debug(ret, 0, 1)\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nENGINE_free(e);\r\nreturn ret;\r\n}\r\nENGINE *ENGINE_get_prev(ENGINE *e)\r\n{\r\nENGINE *ret = NULL;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_GET_PREV,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nret = e->prev;\r\nif(ret)\r\n{\r\nret->struct_ref++;\r\nengine_ref_debug(ret, 0, 1)\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nENGINE_free(e);\r\nreturn ret;\r\n}\r\nint ENGINE_add(ENGINE *e)\r\n{\r\nint to_return = 1;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_ADD,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif((e->id == NULL) || (e->name == NULL))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_ADD,\r\nENGINE_R_ID_OR_NAME_MISSING);\r\n}\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nif(!engine_list_add(e))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_ADD,\r\nENGINE_R_INTERNAL_LIST_ERROR);\r\nto_return = 0;\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nreturn to_return;\r\n}\r\nint ENGINE_remove(ENGINE *e)\r\n{\r\nint to_return = 1;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_REMOVE,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nif(!engine_list_remove(e))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_REMOVE,\r\nENGINE_R_INTERNAL_LIST_ERROR);\r\nto_return = 0;\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nreturn to_return;\r\n}\r\nstatic void engine_cpy(ENGINE *dest, const ENGINE *src)\r\n{\r\ndest->id = src->id;\r\ndest->name = src->name;\r\n#ifndef OPENSSL_NO_RSA\r\ndest->rsa_meth = src->rsa_meth;\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\ndest->dsa_meth = src->dsa_meth;\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\ndest->dh_meth = src->dh_meth;\r\n#endif\r\n#ifndef OPENSSL_NO_ECDH\r\ndest->ecdh_meth = src->ecdh_meth;\r\n#endif\r\n#ifndef OPENSSL_NO_ECDSA\r\ndest->ecdsa_meth = src->ecdsa_meth;\r\n#endif\r\ndest->rand_meth = src->rand_meth;\r\ndest->store_meth = src->store_meth;\r\ndest->ciphers = src->ciphers;\r\ndest->digests = src->digests;\r\ndest->pkey_meths = src->pkey_meths;\r\ndest->destroy = src->destroy;\r\ndest->init = src->init;\r\ndest->finish = src->finish;\r\ndest->ctrl = src->ctrl;\r\ndest->load_privkey = src->load_privkey;\r\ndest->load_pubkey = src->load_pubkey;\r\ndest->cmd_defns = src->cmd_defns;\r\ndest->flags = src->flags;\r\n}\r\nENGINE *ENGINE_by_id(const char *id)\r\n{\r\nENGINE *iterator;\r\nchar *load_dir = NULL;\r\nif(id == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_BY_ID,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\niterator = engine_list_head;\r\nwhile(iterator && (strcmp(id, iterator->id) != 0))\r\niterator = iterator->next;\r\nif(iterator)\r\n{\r\nif(iterator->flags & ENGINE_FLAGS_BY_ID_COPY)\r\n{\r\nENGINE *cp = ENGINE_new();\r\nif(!cp)\r\niterator = NULL;\r\nelse\r\n{\r\nengine_cpy(cp, iterator);\r\niterator = cp;\r\n}\r\n}\r\nelse\r\n{\r\niterator->struct_ref++;\r\nengine_ref_debug(iterator, 0, 1)\r\n}\r\n}\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\n#if 0\r\nif(iterator == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_BY_ID,\r\nENGINE_R_NO_SUCH_ENGINE);\r\nERR_add_error_data(2, "id=", id);\r\n}\r\nreturn iterator;\r\n#else\r\nif(iterator) return iterator;\r\nif (strcmp(id, "dynamic"))\r\n{\r\n#ifdef OPENSSL_SYS_VMS\r\nif((load_dir = getenv("OPENSSL_ENGINES")) == 0) load_dir = "SSLROOT:[ENGINES]";\r\n#else\r\nif((load_dir = getenv("OPENSSL_ENGINES")) == 0) load_dir = ENGINESDIR;\r\n#endif\r\niterator = ENGINE_by_id("dynamic");\r\nif(!iterator || !ENGINE_ctrl_cmd_string(iterator, "ID", id, 0) ||\r\n!ENGINE_ctrl_cmd_string(iterator, "DIR_LOAD", "2", 0) ||\r\n!ENGINE_ctrl_cmd_string(iterator, "DIR_ADD",\r\nload_dir, 0) ||\r\n!ENGINE_ctrl_cmd_string(iterator, "LOAD", NULL, 0))\r\ngoto notfound;\r\nreturn iterator;\r\n}\r\nnotfound:\r\nENGINE_free(iterator);\r\nENGINEerr(ENGINE_F_ENGINE_BY_ID,ENGINE_R_NO_SUCH_ENGINE);\r\nERR_add_error_data(2, "id=", id);\r\nreturn NULL;\r\n#endif\r\n}\r\nint ENGINE_up_ref(ENGINE *e)\r\n{\r\nif (e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_UP_REF,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&e->struct_ref,1,CRYPTO_LOCK_ENGINE);\r\nreturn 1;\r\n}

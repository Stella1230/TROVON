int ASN1_ENUMERATED_set(ASN1_ENUMERATED *a, long v)\r\n{\r\nint j,k;\r\nunsigned int i;\r\nunsigned char buf[sizeof(long)+1];\r\nlong d;\r\na->type=V_ASN1_ENUMERATED;\r\nif (a->length < (int)(sizeof(long)+1))\r\n{\r\nif (a->data != NULL)\r\nOPENSSL_free(a->data);\r\nif ((a->data=(unsigned char *)OPENSSL_malloc(sizeof(long)+1)) != NULL)\r\nmemset((char *)a->data,0,sizeof(long)+1);\r\n}\r\nif (a->data == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_ENUMERATED_SET,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nd=v;\r\nif (d < 0)\r\n{\r\nd= -d;\r\na->type=V_ASN1_NEG_ENUMERATED;\r\n}\r\nfor (i=0; i<sizeof(long); i++)\r\n{\r\nif (d == 0) break;\r\nbuf[i]=(int)d&0xff;\r\nd>>=8;\r\n}\r\nj=0;\r\nfor (k=i-1; k >=0; k--)\r\na->data[j++]=buf[k];\r\na->length=j;\r\nreturn(1);\r\n}\r\nlong ASN1_ENUMERATED_get(ASN1_ENUMERATED *a)\r\n{\r\nint neg=0,i;\r\nlong r=0;\r\nif (a == NULL) return(0L);\r\ni=a->type;\r\nif (i == V_ASN1_NEG_ENUMERATED)\r\nneg=1;\r\nelse if (i != V_ASN1_ENUMERATED)\r\nreturn -1;\r\nif (a->length > (int)sizeof(long))\r\n{\r\nreturn(0xffffffffL);\r\n}\r\nif (a->data == NULL)\r\nreturn 0;\r\nfor (i=0; i<a->length; i++)\r\n{\r\nr<<=8;\r\nr|=(unsigned char)a->data[i];\r\n}\r\nif (neg) r= -r;\r\nreturn(r);\r\n}\r\nASN1_ENUMERATED *BN_to_ASN1_ENUMERATED(BIGNUM *bn, ASN1_ENUMERATED *ai)\r\n{\r\nASN1_ENUMERATED *ret;\r\nint len,j;\r\nif (ai == NULL)\r\nret=M_ASN1_ENUMERATED_new();\r\nelse\r\nret=ai;\r\nif (ret == NULL)\r\n{\r\nASN1err(ASN1_F_BN_TO_ASN1_ENUMERATED,ERR_R_NESTED_ASN1_ERROR);\r\ngoto err;\r\n}\r\nif(BN_is_negative(bn)) ret->type = V_ASN1_NEG_ENUMERATED;\r\nelse ret->type=V_ASN1_ENUMERATED;\r\nj=BN_num_bits(bn);\r\nlen=((j == 0)?0:((j/8)+1));\r\nif (ret->length < len+4)\r\n{\r\nunsigned char *new_data=OPENSSL_realloc(ret->data, len+4);\r\nif (!new_data)\r\n{\r\nASN1err(ASN1_F_BN_TO_ASN1_ENUMERATED,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nret->data=new_data;\r\n}\r\nret->length=BN_bn2bin(bn,ret->data);\r\nreturn(ret);\r\nerr:\r\nif (ret != ai) M_ASN1_ENUMERATED_free(ret);\r\nreturn(NULL);\r\n}\r\nBIGNUM *ASN1_ENUMERATED_to_BN(ASN1_ENUMERATED *ai, BIGNUM *bn)\r\n{\r\nBIGNUM *ret;\r\nif ((ret=BN_bin2bn(ai->data,ai->length,bn)) == NULL)\r\nASN1err(ASN1_F_ASN1_ENUMERATED_TO_BN,ASN1_R_BN_LIB);\r\nelse if(ai->type == V_ASN1_NEG_ENUMERATED) BN_set_negative(ret,1);\r\nreturn(ret);\r\n}

static int copy_issuer(X509V3_CTX *ctx, GENERAL_NAMES *gens)\r\n{\r\nGENERAL_NAMES *ialt;\r\nGENERAL_NAME *gen;\r\nX509_EXTENSION *ext;\r\nint i;\r\nif(ctx && (ctx->flags == CTX_TEST)) return 1;\r\nif(!ctx || !ctx->issuer_cert) {\r\nX509V3err(X509V3_F_COPY_ISSUER,X509V3_R_NO_ISSUER_DETAILS);\r\ngoto err;\r\n}\r\ni = X509_get_ext_by_NID(ctx->issuer_cert, NID_subject_alt_name, -1);\r\nif(i < 0) return 1;\r\nif(!(ext = X509_get_ext(ctx->issuer_cert, i)) ||\r\n!(ialt = X509V3_EXT_d2i(ext)) ) {\r\nX509V3err(X509V3_F_COPY_ISSUER,X509V3_R_ISSUER_DECODE_ERROR);\r\ngoto err;\r\n}\r\nfor(i = 0; i < sk_GENERAL_NAME_num(ialt); i++) {\r\ngen = sk_GENERAL_NAME_value(ialt, i);\r\nif(!sk_GENERAL_NAME_push(gens, gen)) {\r\nX509V3err(X509V3_F_COPY_ISSUER,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\nsk_GENERAL_NAME_free(ialt);\r\nreturn 1;\r\nerr:\r\nreturn 0;\r\n}\r\nstatic int copy_email(X509V3_CTX *ctx, GENERAL_NAMES *gens, int move_p)\r\n{\r\nX509_NAME *nm;\r\nASN1_IA5STRING *email = NULL;\r\nX509_NAME_ENTRY *ne;\r\nGENERAL_NAME *gen = NULL;\r\nint i;\r\nif(ctx != NULL && ctx->flags == CTX_TEST)\r\nreturn 1;\r\nif(!ctx || (!ctx->subject_cert && !ctx->subject_req)) {\r\nX509V3err(X509V3_F_COPY_EMAIL,X509V3_R_NO_SUBJECT_DETAILS);\r\ngoto err;\r\n}\r\nif(ctx->subject_cert) nm = X509_get_subject_name(ctx->subject_cert);\r\nelse nm = X509_REQ_get_subject_name(ctx->subject_req);\r\ni = -1;\r\nwhile((i = X509_NAME_get_index_by_NID(nm,\r\nNID_pkcs9_emailAddress, i)) >= 0) {\r\nne = X509_NAME_get_entry(nm, i);\r\nemail = M_ASN1_IA5STRING_dup(X509_NAME_ENTRY_get_data(ne));\r\nif (move_p)\r\n{\r\nX509_NAME_delete_entry(nm, i);\r\nX509_NAME_ENTRY_free(ne);\r\ni--;\r\n}\r\nif(!email || !(gen = GENERAL_NAME_new())) {\r\nX509V3err(X509V3_F_COPY_EMAIL,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\ngen->d.ia5 = email;\r\nemail = NULL;\r\ngen->type = GEN_EMAIL;\r\nif(!sk_GENERAL_NAME_push(gens, gen)) {\r\nX509V3err(X509V3_F_COPY_EMAIL,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\ngen = NULL;\r\n}\r\nreturn 1;\r\nerr:\r\nGENERAL_NAME_free(gen);\r\nM_ASN1_IA5STRING_free(email);\r\nreturn 0;\r\n}\r\nGENERAL_NAME *v2i_GENERAL_NAME(const X509V3_EXT_METHOD *method, X509V3_CTX *ctx,\r\nCONF_VALUE *cnf)\r\n{\r\nreturn v2i_GENERAL_NAME_ex(NULL, method, ctx, cnf, 0);\r\n}\r\nGENERAL_NAME *a2i_GENERAL_NAME(GENERAL_NAME *out,\r\nconst X509V3_EXT_METHOD *method, X509V3_CTX *ctx,\r\nint gen_type, char *value, int is_nc)\r\n{\r\nchar is_string = 0;\r\nGENERAL_NAME *gen = NULL;\r\nif(!value)\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,X509V3_R_MISSING_VALUE);\r\nreturn NULL;\r\n}\r\nif (out)\r\ngen = out;\r\nelse\r\n{\r\ngen = GENERAL_NAME_new();\r\nif(gen == NULL)\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\n}\r\nswitch (gen_type)\r\n{\r\ncase GEN_URI:\r\ncase GEN_EMAIL:\r\ncase GEN_DNS:\r\nis_string = 1;\r\nbreak;\r\ncase GEN_RID:\r\n{\r\nASN1_OBJECT *obj;\r\nif(!(obj = OBJ_txt2obj(value,0)))\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,X509V3_R_BAD_OBJECT);\r\nERR_add_error_data(2, "value=", value);\r\ngoto err;\r\n}\r\ngen->d.rid = obj;\r\n}\r\nbreak;\r\ncase GEN_IPADD:\r\nif (is_nc)\r\ngen->d.ip = a2i_IPADDRESS_NC(value);\r\nelse\r\ngen->d.ip = a2i_IPADDRESS(value);\r\nif(gen->d.ip == NULL)\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,X509V3_R_BAD_IP_ADDRESS);\r\nERR_add_error_data(2, "value=", value);\r\ngoto err;\r\n}\r\nbreak;\r\ncase GEN_DIRNAME:\r\nif (!do_dirname(gen, value, ctx))\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,X509V3_R_DIRNAME_ERROR);\r\ngoto err;\r\n}\r\nbreak;\r\ncase GEN_OTHERNAME:\r\nif (!do_othername(gen, value, ctx))\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,X509V3_R_OTHERNAME_ERROR);\r\ngoto err;\r\n}\r\nbreak;\r\ndefault:\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,X509V3_R_UNSUPPORTED_TYPE);\r\ngoto err;\r\n}\r\nif(is_string)\r\n{\r\nif(!(gen->d.ia5 = M_ASN1_IA5STRING_new()) ||\r\n!ASN1_STRING_set(gen->d.ia5, (unsigned char*)value,\r\nstrlen(value)))\r\n{\r\nX509V3err(X509V3_F_A2I_GENERAL_NAME,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\ngen->type = gen_type;\r\nreturn gen;\r\nerr:\r\nif (!out)\r\nGENERAL_NAME_free(gen);\r\nreturn NULL;\r\n}\r\nGENERAL_NAME *v2i_GENERAL_NAME_ex(GENERAL_NAME *out,\r\nconst X509V3_EXT_METHOD *method,\r\nX509V3_CTX *ctx, CONF_VALUE *cnf, int is_nc)\r\n{\r\nint type;\r\nchar *name, *value;\r\nname = cnf->name;\r\nvalue = cnf->value;\r\nif(!value)\r\n{\r\nX509V3err(X509V3_F_V2I_GENERAL_NAME_EX,X509V3_R_MISSING_VALUE);\r\nreturn NULL;\r\n}\r\nif(!name_cmp(name, "email"))\r\ntype = GEN_EMAIL;\r\nelse if(!name_cmp(name, "URI"))\r\ntype = GEN_URI;\r\nelse if(!name_cmp(name, "DNS"))\r\ntype = GEN_DNS;\r\nelse if(!name_cmp(name, "RID"))\r\ntype = GEN_RID;\r\nelse if(!name_cmp(name, "IP"))\r\ntype = GEN_IPADD;\r\nelse if(!name_cmp(name, "dirName"))\r\ntype = GEN_DIRNAME;\r\nelse if(!name_cmp(name, "otherName"))\r\ntype = GEN_OTHERNAME;\r\nelse\r\n{\r\nX509V3err(X509V3_F_V2I_GENERAL_NAME_EX,X509V3_R_UNSUPPORTED_OPTION);\r\nERR_add_error_data(2, "name=", name);\r\nreturn NULL;\r\n}\r\nreturn a2i_GENERAL_NAME(out, method, ctx, type, value, is_nc);\r\n}\r\nstatic int do_othername(GENERAL_NAME *gen, char *value, X509V3_CTX *ctx)\r\n{\r\nchar *objtmp = NULL, *p;\r\nint objlen;\r\nif (!(p = strchr(value, ';')))\r\nreturn 0;\r\nif (!(gen->d.otherName = OTHERNAME_new()))\r\nreturn 0;\r\nASN1_TYPE_free(gen->d.otherName->value);\r\nif (!(gen->d.otherName->value = ASN1_generate_v3(p + 1, ctx)))\r\nreturn 0;\r\nobjlen = p - value;\r\nobjtmp = OPENSSL_malloc(objlen + 1);\r\nstrncpy(objtmp, value, objlen);\r\nobjtmp[objlen] = 0;\r\ngen->d.otherName->type_id = OBJ_txt2obj(objtmp, 0);\r\nOPENSSL_free(objtmp);\r\nif (!gen->d.otherName->type_id)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int do_dirname(GENERAL_NAME *gen, char *value, X509V3_CTX *ctx)\r\n{\r\nint ret;\r\nSTACK_OF(CONF_VALUE) *sk;\r\nX509_NAME *nm;\r\nif (!(nm = X509_NAME_new()))\r\nreturn 0;\r\nsk = X509V3_get_section(ctx, value);\r\nif (!sk)\r\n{\r\nX509V3err(X509V3_F_DO_DIRNAME,X509V3_R_SECTION_NOT_FOUND);\r\nERR_add_error_data(2, "section=", value);\r\nX509_NAME_free(nm);\r\nreturn 0;\r\n}\r\nret = X509V3_NAME_from_section(nm, sk, MBSTRING_ASC);\r\nif (!ret)\r\nX509_NAME_free(nm);\r\ngen->d.dirn = nm;\r\nX509V3_section_free(ctx, sk);\r\nreturn ret;\r\n}

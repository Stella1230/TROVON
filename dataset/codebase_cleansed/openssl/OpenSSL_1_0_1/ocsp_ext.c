int OCSP_REQUEST_get_ext_count(OCSP_REQUEST *x)\r\n{\r\nreturn(X509v3_get_ext_count(x->tbsRequest->requestExtensions));\r\n}\r\nint OCSP_REQUEST_get_ext_by_NID(OCSP_REQUEST *x, int nid, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_NID(x->tbsRequest->requestExtensions,nid,lastpos));\r\n}\r\nint OCSP_REQUEST_get_ext_by_OBJ(OCSP_REQUEST *x, ASN1_OBJECT *obj, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_OBJ(x->tbsRequest->requestExtensions,obj,lastpos));\r\n}\r\nint OCSP_REQUEST_get_ext_by_critical(OCSP_REQUEST *x, int crit, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_critical(x->tbsRequest->requestExtensions,crit,lastpos));\r\n}\r\nX509_EXTENSION *OCSP_REQUEST_get_ext(OCSP_REQUEST *x, int loc)\r\n{\r\nreturn(X509v3_get_ext(x->tbsRequest->requestExtensions,loc));\r\n}\r\nX509_EXTENSION *OCSP_REQUEST_delete_ext(OCSP_REQUEST *x, int loc)\r\n{\r\nreturn(X509v3_delete_ext(x->tbsRequest->requestExtensions,loc));\r\n}\r\nvoid *OCSP_REQUEST_get1_ext_d2i(OCSP_REQUEST *x, int nid, int *crit, int *idx)\r\n{\r\nreturn X509V3_get_d2i(x->tbsRequest->requestExtensions, nid, crit, idx);\r\n}\r\nint OCSP_REQUEST_add1_ext_i2d(OCSP_REQUEST *x, int nid, void *value, int crit,\r\nunsigned long flags)\r\n{\r\nreturn X509V3_add1_i2d(&x->tbsRequest->requestExtensions, nid, value, crit, flags);\r\n}\r\nint OCSP_REQUEST_add_ext(OCSP_REQUEST *x, X509_EXTENSION *ex, int loc)\r\n{\r\nreturn(X509v3_add_ext(&(x->tbsRequest->requestExtensions),ex,loc) != NULL);\r\n}\r\nint OCSP_ONEREQ_get_ext_count(OCSP_ONEREQ *x)\r\n{\r\nreturn(X509v3_get_ext_count(x->singleRequestExtensions));\r\n}\r\nint OCSP_ONEREQ_get_ext_by_NID(OCSP_ONEREQ *x, int nid, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_NID(x->singleRequestExtensions,nid,lastpos));\r\n}\r\nint OCSP_ONEREQ_get_ext_by_OBJ(OCSP_ONEREQ *x, ASN1_OBJECT *obj, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_OBJ(x->singleRequestExtensions,obj,lastpos));\r\n}\r\nint OCSP_ONEREQ_get_ext_by_critical(OCSP_ONEREQ *x, int crit, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_critical(x->singleRequestExtensions,crit,lastpos));\r\n}\r\nX509_EXTENSION *OCSP_ONEREQ_get_ext(OCSP_ONEREQ *x, int loc)\r\n{\r\nreturn(X509v3_get_ext(x->singleRequestExtensions,loc));\r\n}\r\nX509_EXTENSION *OCSP_ONEREQ_delete_ext(OCSP_ONEREQ *x, int loc)\r\n{\r\nreturn(X509v3_delete_ext(x->singleRequestExtensions,loc));\r\n}\r\nvoid *OCSP_ONEREQ_get1_ext_d2i(OCSP_ONEREQ *x, int nid, int *crit, int *idx)\r\n{\r\nreturn X509V3_get_d2i(x->singleRequestExtensions, nid, crit, idx);\r\n}\r\nint OCSP_ONEREQ_add1_ext_i2d(OCSP_ONEREQ *x, int nid, void *value, int crit,\r\nunsigned long flags)\r\n{\r\nreturn X509V3_add1_i2d(&x->singleRequestExtensions, nid, value, crit, flags);\r\n}\r\nint OCSP_ONEREQ_add_ext(OCSP_ONEREQ *x, X509_EXTENSION *ex, int loc)\r\n{\r\nreturn(X509v3_add_ext(&(x->singleRequestExtensions),ex,loc) != NULL);\r\n}\r\nint OCSP_BASICRESP_get_ext_count(OCSP_BASICRESP *x)\r\n{\r\nreturn(X509v3_get_ext_count(x->tbsResponseData->responseExtensions));\r\n}\r\nint OCSP_BASICRESP_get_ext_by_NID(OCSP_BASICRESP *x, int nid, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_NID(x->tbsResponseData->responseExtensions,nid,lastpos));\r\n}\r\nint OCSP_BASICRESP_get_ext_by_OBJ(OCSP_BASICRESP *x, ASN1_OBJECT *obj, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_OBJ(x->tbsResponseData->responseExtensions,obj,lastpos));\r\n}\r\nint OCSP_BASICRESP_get_ext_by_critical(OCSP_BASICRESP *x, int crit, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_critical(x->tbsResponseData->responseExtensions,crit,lastpos));\r\n}\r\nX509_EXTENSION *OCSP_BASICRESP_get_ext(OCSP_BASICRESP *x, int loc)\r\n{\r\nreturn(X509v3_get_ext(x->tbsResponseData->responseExtensions,loc));\r\n}\r\nX509_EXTENSION *OCSP_BASICRESP_delete_ext(OCSP_BASICRESP *x, int loc)\r\n{\r\nreturn(X509v3_delete_ext(x->tbsResponseData->responseExtensions,loc));\r\n}\r\nvoid *OCSP_BASICRESP_get1_ext_d2i(OCSP_BASICRESP *x, int nid, int *crit, int *idx)\r\n{\r\nreturn X509V3_get_d2i(x->tbsResponseData->responseExtensions, nid, crit, idx);\r\n}\r\nint OCSP_BASICRESP_add1_ext_i2d(OCSP_BASICRESP *x, int nid, void *value, int crit,\r\nunsigned long flags)\r\n{\r\nreturn X509V3_add1_i2d(&x->tbsResponseData->responseExtensions, nid, value, crit, flags);\r\n}\r\nint OCSP_BASICRESP_add_ext(OCSP_BASICRESP *x, X509_EXTENSION *ex, int loc)\r\n{\r\nreturn(X509v3_add_ext(&(x->tbsResponseData->responseExtensions),ex,loc) != NULL);\r\n}\r\nint OCSP_SINGLERESP_get_ext_count(OCSP_SINGLERESP *x)\r\n{\r\nreturn(X509v3_get_ext_count(x->singleExtensions));\r\n}\r\nint OCSP_SINGLERESP_get_ext_by_NID(OCSP_SINGLERESP *x, int nid, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_NID(x->singleExtensions,nid,lastpos));\r\n}\r\nint OCSP_SINGLERESP_get_ext_by_OBJ(OCSP_SINGLERESP *x, ASN1_OBJECT *obj, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_OBJ(x->singleExtensions,obj,lastpos));\r\n}\r\nint OCSP_SINGLERESP_get_ext_by_critical(OCSP_SINGLERESP *x, int crit, int lastpos)\r\n{\r\nreturn(X509v3_get_ext_by_critical(x->singleExtensions,crit,lastpos));\r\n}\r\nX509_EXTENSION *OCSP_SINGLERESP_get_ext(OCSP_SINGLERESP *x, int loc)\r\n{\r\nreturn(X509v3_get_ext(x->singleExtensions,loc));\r\n}\r\nX509_EXTENSION *OCSP_SINGLERESP_delete_ext(OCSP_SINGLERESP *x, int loc)\r\n{\r\nreturn(X509v3_delete_ext(x->singleExtensions,loc));\r\n}\r\nvoid *OCSP_SINGLERESP_get1_ext_d2i(OCSP_SINGLERESP *x, int nid, int *crit, int *idx)\r\n{\r\nreturn X509V3_get_d2i(x->singleExtensions, nid, crit, idx);\r\n}\r\nint OCSP_SINGLERESP_add1_ext_i2d(OCSP_SINGLERESP *x, int nid, void *value, int crit,\r\nunsigned long flags)\r\n{\r\nreturn X509V3_add1_i2d(&x->singleExtensions, nid, value, crit, flags);\r\n}\r\nint OCSP_SINGLERESP_add_ext(OCSP_SINGLERESP *x, X509_EXTENSION *ex, int loc)\r\n{\r\nreturn(X509v3_add_ext(&(x->singleExtensions),ex,loc) != NULL);\r\n}\r\nint OCSP_request_add1_nonce(OCSP_REQUEST *req, unsigned char *val, int len)\r\n{\r\nreturn ocsp_add1_nonce(&req->tbsRequest->requestExtensions, val, len);\r\n}\r\nint OCSP_basic_add1_nonce(OCSP_BASICRESP *resp, unsigned char *val, int len)\r\n{\r\nreturn ocsp_add1_nonce(&resp->tbsResponseData->responseExtensions, val, len);\r\n}\r\nint OCSP_check_nonce(OCSP_REQUEST *req, OCSP_BASICRESP *bs)\r\n{\r\nint req_idx, resp_idx;\r\nX509_EXTENSION *req_ext, *resp_ext;\r\nreq_idx = OCSP_REQUEST_get_ext_by_NID(req, NID_id_pkix_OCSP_Nonce, -1);\r\nresp_idx = OCSP_BASICRESP_get_ext_by_NID(bs, NID_id_pkix_OCSP_Nonce, -1);\r\nif((req_idx < 0) && (resp_idx < 0))\r\nreturn 2;\r\nif((req_idx >= 0) && (resp_idx < 0))\r\nreturn -1;\r\nif((req_idx < 0) && (resp_idx >= 0))\r\nreturn 3;\r\nreq_ext = OCSP_REQUEST_get_ext(req, req_idx);\r\nresp_ext = OCSP_BASICRESP_get_ext(bs, resp_idx);\r\nif(ASN1_OCTET_STRING_cmp(req_ext->value, resp_ext->value))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint OCSP_copy_nonce(OCSP_BASICRESP *resp, OCSP_REQUEST *req)\r\n{\r\nX509_EXTENSION *req_ext;\r\nint req_idx;\r\nreq_idx = OCSP_REQUEST_get_ext_by_NID(req, NID_id_pkix_OCSP_Nonce, -1);\r\nif (req_idx < 0) return 2;\r\nreq_ext = OCSP_REQUEST_get_ext(req, req_idx);\r\nreturn OCSP_BASICRESP_add_ext(resp, req_ext, -1);\r\n}\r\nX509_EXTENSION *OCSP_crlID_new(char *url, long *n, char *tim)\r\n{\r\nX509_EXTENSION *x = NULL;\r\nOCSP_CRLID *cid = NULL;\r\nif (!(cid = OCSP_CRLID_new())) goto err;\r\nif (url)\r\n{\r\nif (!(cid->crlUrl = ASN1_IA5STRING_new())) goto err;\r\nif (!(ASN1_STRING_set(cid->crlUrl, url, -1))) goto err;\r\n}\r\nif (n)\r\n{\r\nif (!(cid->crlNum = ASN1_INTEGER_new())) goto err;\r\nif (!(ASN1_INTEGER_set(cid->crlNum, *n))) goto err;\r\n}\r\nif (tim)\r\n{\r\nif (!(cid->crlTime = ASN1_GENERALIZEDTIME_new())) goto err;\r\nif (!(ASN1_GENERALIZEDTIME_set_string(cid->crlTime, tim)))\r\ngoto err;\r\n}\r\nx = X509V3_EXT_i2d(NID_id_pkix_OCSP_CrlID, 0, cid);\r\nerr:\r\nif (cid) OCSP_CRLID_free(cid);\r\nreturn x;\r\n}\r\nX509_EXTENSION *OCSP_accept_responses_new(char **oids)\r\n{\r\nint nid;\r\nSTACK_OF(ASN1_OBJECT) *sk = NULL;\r\nASN1_OBJECT *o = NULL;\r\nX509_EXTENSION *x = NULL;\r\nif (!(sk = sk_ASN1_OBJECT_new_null())) goto err;\r\nwhile (oids && *oids)\r\n{\r\nif ((nid=OBJ_txt2nid(*oids))!=NID_undef&&(o=OBJ_nid2obj(nid)))\r\nsk_ASN1_OBJECT_push(sk, o);\r\noids++;\r\n}\r\nx = X509V3_EXT_i2d(NID_id_pkix_OCSP_acceptableResponses, 0, sk);\r\nerr:\r\nif (sk) sk_ASN1_OBJECT_pop_free(sk, ASN1_OBJECT_free);\r\nreturn x;\r\n}\r\nX509_EXTENSION *OCSP_archive_cutoff_new(char* tim)\r\n{\r\nX509_EXTENSION *x=NULL;\r\nASN1_GENERALIZEDTIME *gt = NULL;\r\nif (!(gt = ASN1_GENERALIZEDTIME_new())) goto err;\r\nif (!(ASN1_GENERALIZEDTIME_set_string(gt, tim))) goto err;\r\nx = X509V3_EXT_i2d(NID_id_pkix_OCSP_archiveCutoff, 0, gt);\r\nerr:\r\nif (gt) ASN1_GENERALIZEDTIME_free(gt);\r\nreturn x;\r\n}\r\nX509_EXTENSION *OCSP_url_svcloc_new(X509_NAME* issuer, char **urls)\r\n{\r\nX509_EXTENSION *x = NULL;\r\nASN1_IA5STRING *ia5 = NULL;\r\nOCSP_SERVICELOC *sloc = NULL;\r\nACCESS_DESCRIPTION *ad = NULL;\r\nif (!(sloc = OCSP_SERVICELOC_new())) goto err;\r\nif (!(sloc->issuer = X509_NAME_dup(issuer))) goto err;\r\nif (urls && *urls && !(sloc->locator = sk_ACCESS_DESCRIPTION_new_null())) goto err;\r\nwhile (urls && *urls)\r\n{\r\nif (!(ad = ACCESS_DESCRIPTION_new())) goto err;\r\nif (!(ad->method=OBJ_nid2obj(NID_ad_OCSP))) goto err;\r\nif (!(ad->location = GENERAL_NAME_new())) goto err;\r\nif (!(ia5 = ASN1_IA5STRING_new())) goto err;\r\nif (!ASN1_STRING_set((ASN1_STRING*)ia5, *urls, -1)) goto err;\r\nad->location->type = GEN_URI;\r\nad->location->d.ia5 = ia5;\r\nif (!sk_ACCESS_DESCRIPTION_push(sloc->locator, ad)) goto err;\r\nurls++;\r\n}\r\nx = X509V3_EXT_i2d(NID_id_pkix_OCSP_serviceLocator, 0, sloc);\r\nerr:\r\nif (sloc) OCSP_SERVICELOC_free(sloc);\r\nreturn x;\r\n}

void dump_signature(const char *message,const unsigned char *buffer,size_t len)\r\n{\r\nsize_t i;\r\nfprintf(stderr,"signature %s Length=%d",message,len);\r\nfor (i=0; i<len; i++)\r\n{\r\nif (i% 16 ==0) fputc('\n',stderr);\r\nfprintf (stderr," %02x",buffer[i]);\r\n}\r\nfprintf(stderr,"\nEnd of signature\n");\r\n}\r\nvoid dump_dsa_sig(const char *message, DSA_SIG *sig)\r\n{\r\nfprintf(stderr,"%s\nR=",message);\r\nBN_print_fp(stderr,sig->r);\r\nfprintf(stderr,"\nS=");\r\nBN_print_fp(stderr,sig->s);\r\nfprintf(stderr,"\n");\r\n}\r\nDSA_SIG *gost_do_sign(const unsigned char *dgst,int dlen, DSA *dsa)\r\n{\r\nBIGNUM *k=NULL,*tmp=NULL,*tmp2=NULL;\r\nDSA_SIG *newsig = DSA_SIG_new();\r\nBIGNUM *md = hashsum2bn(dgst);\r\nBN_CTX *ctx=BN_CTX_new();\r\nBN_CTX_start(ctx);\r\nif (!newsig)\r\n{\r\nGOSTerr(GOST_F_GOST_DO_SIGN,GOST_R_NO_MEMORY);\r\ngoto err;\r\n}\r\ntmp=BN_CTX_get(ctx);\r\nk = BN_CTX_get(ctx);\r\ntmp2 = BN_CTX_get(ctx);\r\nBN_mod(tmp,md,dsa->q,ctx);\r\nif (BN_is_zero(tmp))\r\n{\r\nBN_one(md);\r\n}\r\ndo\r\n{\r\ndo\r\n{\r\nBN_rand_range(k,dsa->q);\r\nBN_mod_exp(tmp,dsa->g, k, dsa->p,ctx);\r\nif (!(newsig->r)) newsig->r=BN_new();\r\nBN_mod(newsig->r,tmp,dsa->q,ctx);\r\n}\r\nwhile (BN_is_zero(newsig->r));\r\nBN_mod_mul(tmp,dsa->priv_key,newsig->r,dsa->q,ctx);\r\nBN_mod_mul(tmp2,k,md,dsa->q,ctx);\r\nif (!newsig->s) newsig->s=BN_new();\r\nBN_mod_add(newsig->s,tmp,tmp2,dsa->q,ctx);\r\n}\r\nwhile (BN_is_zero(newsig->s));\r\nerr:\r\nBN_free(md);\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\nreturn newsig;\r\n}\r\nint pack_sign_cp(DSA_SIG *s,int order,unsigned char *sig, size_t *siglen)\r\n{\r\n*siglen = 2*order;\r\nmemset(sig,0,*siglen);\r\nstore_bignum(s->s, sig, order);\r\nstore_bignum(s->r, sig+order,order);\r\ndump_signature("serialized",sig,*siglen);\r\nDSA_SIG_free(s);\r\nreturn 1;\r\n}\r\nint gost_do_verify(const unsigned char *dgst, int dgst_len,\r\nDSA_SIG *sig, DSA *dsa)\r\n{\r\nBIGNUM *md, *tmp=NULL;\r\nBIGNUM *q2=NULL;\r\nBIGNUM *u=NULL,*v=NULL,*z1=NULL,*z2=NULL;\r\nBIGNUM *tmp2=NULL,*tmp3=NULL;\r\nint ok;\r\nBN_CTX *ctx = BN_CTX_new();\r\nBN_CTX_start(ctx);\r\nif (BN_cmp(sig->s,dsa->q)>=1||\r\nBN_cmp(sig->r,dsa->q)>=1)\r\n{\r\nGOSTerr(GOST_F_GOST_DO_VERIFY,GOST_R_SIGNATURE_PARTS_GREATER_THAN_Q);\r\nreturn 0;\r\n}\r\nmd=hashsum2bn(dgst);\r\ntmp=BN_CTX_get(ctx);\r\nv=BN_CTX_get(ctx);\r\nq2=BN_CTX_get(ctx);\r\nz1=BN_CTX_get(ctx);\r\nz2=BN_CTX_get(ctx);\r\ntmp2=BN_CTX_get(ctx);\r\ntmp3=BN_CTX_get(ctx);\r\nu = BN_CTX_get(ctx);\r\nBN_mod(tmp,md,dsa->q,ctx);\r\nif (BN_is_zero(tmp))\r\n{\r\nBN_one(md);\r\n}\r\nBN_copy(q2,dsa->q);\r\nBN_sub_word(q2,2);\r\nBN_mod_exp(v,md,q2,dsa->q,ctx);\r\nBN_mod_mul(z1,sig->s,v,dsa->q,ctx);\r\nBN_sub(tmp,dsa->q,sig->r);\r\nBN_mod_mul(z2,tmp,v,dsa->p,ctx);\r\nBN_mod_exp(tmp,dsa->g,z1,dsa->p,ctx);\r\nBN_mod_exp(tmp2,dsa->pub_key,z2,dsa->p,ctx);\r\nBN_mod_mul(tmp3,tmp,tmp2,dsa->p,ctx);\r\nBN_mod(u,tmp3,dsa->q,ctx);\r\nok= BN_cmp(u,sig->r);\r\nBN_free(md);\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\nif (ok!=0)\r\n{\r\nGOSTerr(GOST_F_GOST_DO_VERIFY,GOST_R_SIGNATURE_MISMATCH);\r\n}\r\nreturn (ok==0);\r\n}\r\nint gost94_compute_public(DSA *dsa)\r\n{\r\nBN_CTX *ctx = BN_CTX_new();\r\nif (!dsa->g)\r\n{\r\nGOSTerr(GOST_F_GOST94_COMPUTE_PUBLIC,GOST_R_KEY_IS_NOT_INITALIZED);\r\nreturn 0;\r\n}\r\ndsa->pub_key=BN_new();\r\nBN_mod_exp(dsa->pub_key, dsa->g,dsa->priv_key,dsa->p,ctx);\r\nBN_CTX_free(ctx);\r\nreturn 1;\r\n}\r\nint fill_GOST94_params(DSA *dsa,int nid)\r\n{\r\nR3410_params *params=R3410_paramset;\r\nwhile (params->nid!=NID_undef && params->nid !=nid) params++;\r\nif (params->nid == NID_undef)\r\n{\r\nGOSTerr(GOST_F_FILL_GOST94_PARAMS,GOST_R_UNSUPPORTED_PARAMETER_SET);\r\nreturn 0;\r\n}\r\n#define dump_signature(a,b,c)\r\nif (dsa->p) { BN_free(dsa->p); }\r\ndsa->p=NULL;\r\nBN_dec2bn(&(dsa->p),params->p);\r\nif (dsa->q) { BN_free(dsa->q); }\r\ndsa->q=NULL;\r\nBN_dec2bn(&(dsa->q),params->q);\r\nif (dsa->g) { BN_free(dsa->g); }\r\ndsa->g=NULL;\r\nBN_dec2bn(&(dsa->g),params->a);\r\nreturn 1;\r\n}\r\nint gost_sign_keygen(DSA *dsa)\r\n{\r\ndsa->priv_key = BN_new();\r\nBN_rand_range(dsa->priv_key,dsa->q);\r\nreturn gost94_compute_public( dsa);\r\n}\r\nDSA_SIG *unpack_cp_signature(const unsigned char *sig,size_t siglen)\r\n{\r\nDSA_SIG *s;\r\ns = DSA_SIG_new();\r\nif (s == NULL)\r\n{\r\nGOSTerr(GOST_F_UNPACK_CP_SIGNATURE,GOST_R_NO_MEMORY);\r\nreturn NULL;\r\n}\r\ns->s = getbnfrombuf(sig , siglen/2);\r\ns->r = getbnfrombuf(sig + siglen/2, siglen/2);\r\nreturn s;\r\n}\r\nBIGNUM *hashsum2bn(const unsigned char *dgst)\r\n{\r\nunsigned char buf[32];\r\nint i;\r\nfor (i=0;i<32;i++)\r\n{\r\nbuf[31-i]=dgst[i];\r\n}\r\nreturn getbnfrombuf(buf,32);\r\n}\r\nBIGNUM *getbnfrombuf(const unsigned char *buf,size_t len)\r\n{\r\nwhile (*buf==0&&len>0)\r\n{\r\nbuf++; len--;\r\n}\r\nif (len)\r\n{\r\nreturn BN_bin2bn(buf,len,NULL);\r\n}\r\nelse\r\n{\r\nBIGNUM *b=BN_new();\r\nBN_zero(b);\r\nreturn b;\r\n}\r\n}\r\nint store_bignum(BIGNUM *bn, unsigned char *buf,int len)\r\n{\r\nint bytes = BN_num_bytes(bn);\r\nif (bytes>len) return 0;\r\nmemset(buf,0,len);\r\nBN_bn2bin(bn,buf+len-bytes);\r\nreturn 1;\r\n}

int NETSCAPE_SPKI_set_pubkey(NETSCAPE_SPKI *x, EVP_PKEY *pkey)\r\n{\r\nif ((x == NULL) || (x->spkac == NULL)) return(0);\r\nreturn(X509_PUBKEY_set(&(x->spkac->pubkey),pkey));\r\n}\r\nEVP_PKEY *NETSCAPE_SPKI_get_pubkey(NETSCAPE_SPKI *x)\r\n{\r\nif ((x == NULL) || (x->spkac == NULL))\r\nreturn(NULL);\r\nreturn(X509_PUBKEY_get(x->spkac->pubkey));\r\n}\r\nNETSCAPE_SPKI * NETSCAPE_SPKI_b64_decode(const char *str, int len)\r\n{\r\nunsigned char *spki_der;\r\nconst unsigned char *p;\r\nint spki_len;\r\nNETSCAPE_SPKI *spki;\r\nif(len <= 0) len = strlen(str);\r\nif (!(spki_der = OPENSSL_malloc(len + 1))) {\r\nX509err(X509_F_NETSCAPE_SPKI_B64_DECODE, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nspki_len = EVP_DecodeBlock(spki_der, (const unsigned char *)str, len);\r\nif(spki_len < 0) {\r\nX509err(X509_F_NETSCAPE_SPKI_B64_DECODE,\r\nX509_R_BASE64_DECODE_ERROR);\r\nOPENSSL_free(spki_der);\r\nreturn NULL;\r\n}\r\np = spki_der;\r\nspki = d2i_NETSCAPE_SPKI(NULL, &p, spki_len);\r\nOPENSSL_free(spki_der);\r\nreturn spki;\r\n}\r\nchar * NETSCAPE_SPKI_b64_encode(NETSCAPE_SPKI *spki)\r\n{\r\nunsigned char *der_spki, *p;\r\nchar *b64_str;\r\nint der_len;\r\nder_len = i2d_NETSCAPE_SPKI(spki, NULL);\r\nder_spki = OPENSSL_malloc(der_len);\r\nb64_str = OPENSSL_malloc(der_len * 2);\r\nif(!der_spki || !b64_str) {\r\nX509err(X509_F_NETSCAPE_SPKI_B64_ENCODE, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\np = der_spki;\r\ni2d_NETSCAPE_SPKI(spki, &p);\r\nEVP_EncodeBlock((unsigned char *)b64_str, der_spki, der_len);\r\nOPENSSL_free(der_spki);\r\nreturn b64_str;\r\n}

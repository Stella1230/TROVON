int SXNET_add_id_asc(SXNET **psx, char *zone, char *user,\r\nint userlen)\r\n{\r\nASN1_INTEGER *izone = NULL;\r\nif(!(izone = s2i_ASN1_INTEGER(NULL, zone))) {\r\nX509V3err(X509V3_F_SXNET_ADD_ID_ASC,X509V3_R_ERROR_CONVERTING_ZONE);\r\nreturn 0;\r\n}\r\nreturn SXNET_add_id_INTEGER(psx, izone, user, userlen);\r\n}\r\nint SXNET_add_id_ulong(SXNET **psx, unsigned long lzone, char *user,\r\nint userlen)\r\n{\r\nASN1_INTEGER *izone = NULL;\r\nif(!(izone = M_ASN1_INTEGER_new()) || !ASN1_INTEGER_set(izone, lzone)) {\r\nX509V3err(X509V3_F_SXNET_ADD_ID_ULONG,ERR_R_MALLOC_FAILURE);\r\nM_ASN1_INTEGER_free(izone);\r\nreturn 0;\r\n}\r\nreturn SXNET_add_id_INTEGER(psx, izone, user, userlen);\r\n}\r\nint SXNET_add_id_INTEGER(SXNET **psx, ASN1_INTEGER *zone, char *user,\r\nint userlen)\r\n{\r\nSXNET *sx = NULL;\r\nSXNETID *id = NULL;\r\nif(!psx || !zone || !user) {\r\nX509V3err(X509V3_F_SXNET_ADD_ID_INTEGER,X509V3_R_INVALID_NULL_ARGUMENT);\r\nreturn 0;\r\n}\r\nif(userlen == -1) userlen = strlen(user);\r\nif(userlen > 64) {\r\nX509V3err(X509V3_F_SXNET_ADD_ID_INTEGER,X509V3_R_USER_TOO_LONG);\r\nreturn 0;\r\n}\r\nif(!*psx) {\r\nif(!(sx = SXNET_new())) goto err;\r\nif(!ASN1_INTEGER_set(sx->version, 0)) goto err;\r\n*psx = sx;\r\n} else sx = *psx;\r\nif(SXNET_get_id_INTEGER(sx, zone)) {\r\nX509V3err(X509V3_F_SXNET_ADD_ID_INTEGER,X509V3_R_DUPLICATE_ZONE_ID);\r\nreturn 0;\r\n}\r\nif(!(id = SXNETID_new())) goto err;\r\nif(userlen == -1) userlen = strlen(user);\r\nif(!M_ASN1_OCTET_STRING_set(id->user, user, userlen)) goto err;\r\nif(!sk_SXNETID_push(sx->ids, id)) goto err;\r\nid->zone = zone;\r\nreturn 1;\r\nerr:\r\nX509V3err(X509V3_F_SXNET_ADD_ID_INTEGER,ERR_R_MALLOC_FAILURE);\r\nSXNETID_free(id);\r\nSXNET_free(sx);\r\n*psx = NULL;\r\nreturn 0;\r\n}\r\nASN1_OCTET_STRING *SXNET_get_id_asc(SXNET *sx, char *zone)\r\n{\r\nASN1_INTEGER *izone = NULL;\r\nASN1_OCTET_STRING *oct;\r\nif(!(izone = s2i_ASN1_INTEGER(NULL, zone))) {\r\nX509V3err(X509V3_F_SXNET_GET_ID_ASC,X509V3_R_ERROR_CONVERTING_ZONE);\r\nreturn NULL;\r\n}\r\noct = SXNET_get_id_INTEGER(sx, izone);\r\nM_ASN1_INTEGER_free(izone);\r\nreturn oct;\r\n}\r\nASN1_OCTET_STRING *SXNET_get_id_ulong(SXNET *sx, unsigned long lzone)\r\n{\r\nASN1_INTEGER *izone = NULL;\r\nASN1_OCTET_STRING *oct;\r\nif(!(izone = M_ASN1_INTEGER_new()) || !ASN1_INTEGER_set(izone, lzone)) {\r\nX509V3err(X509V3_F_SXNET_GET_ID_ULONG,ERR_R_MALLOC_FAILURE);\r\nM_ASN1_INTEGER_free(izone);\r\nreturn NULL;\r\n}\r\noct = SXNET_get_id_INTEGER(sx, izone);\r\nM_ASN1_INTEGER_free(izone);\r\nreturn oct;\r\n}\r\nASN1_OCTET_STRING *SXNET_get_id_INTEGER(SXNET *sx, ASN1_INTEGER *zone)\r\n{\r\nSXNETID *id;\r\nint i;\r\nfor(i = 0; i < sk_SXNETID_num(sx->ids); i++) {\r\nid = sk_SXNETID_value(sx->ids, i);\r\nif(!M_ASN1_INTEGER_cmp(id->zone, zone)) return id->user;\r\n}\r\nreturn NULL;\r\n}

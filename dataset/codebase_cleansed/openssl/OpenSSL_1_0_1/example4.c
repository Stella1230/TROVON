int main(int argc, char *argv[])\r\n{\r\nif ((argc == 1))\r\n{\r\ndo_encode();\r\n}\r\nelse if ((argc == 2) && !strcmp(argv[1],"-d"))\r\n{\r\ndo_decode();\r\n}\r\nelse\r\n{\r\nfprintf(stderr,"%s", usage);\r\nexit(1);\r\n}\r\nreturn 0;\r\n}\r\nvoid do_encode()\r\n{\r\nchar buf[BUFLEN];\r\nchar ebuf[BUFLEN+24];\r\nunsigned int ebuflen;\r\nEVP_ENCODE_CTX ectx;\r\nEVP_EncodeInit(&ectx);\r\nwhile(1)\r\n{\r\nint readlen = read(STDIN, buf, sizeof(buf));\r\nif (readlen <= 0)\r\n{\r\nif (!readlen)\r\nbreak;\r\nelse\r\n{\r\nperror("read");\r\nexit(1);\r\n}\r\n}\r\nEVP_EncodeUpdate(&ectx, ebuf, &ebuflen, buf, readlen);\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}\r\nEVP_EncodeFinal(&ectx, ebuf, &ebuflen);\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}\r\nvoid do_decode()\r\n{\r\nchar buf[BUFLEN];\r\nchar ebuf[BUFLEN+24];\r\nunsigned int ebuflen;\r\nEVP_ENCODE_CTX ectx;\r\nEVP_DecodeInit(&ectx);\r\nwhile(1)\r\n{\r\nint readlen = read(STDIN, buf, sizeof(buf));\r\nint rc;\r\nif (readlen <= 0)\r\n{\r\nif (!readlen)\r\nbreak;\r\nelse\r\n{\r\nperror("read");\r\nexit(1);\r\n}\r\n}\r\nrc = EVP_DecodeUpdate(&ectx, ebuf, &ebuflen, buf, readlen);\r\nif (rc <= 0)\r\n{\r\nif (!rc)\r\n{\r\nwrite(STDOUT, ebuf, ebuflen);\r\nbreak;\r\n}\r\nfprintf(stderr, "Error: decoding message\n");\r\nreturn;\r\n}\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}\r\nEVP_DecodeFinal(&ectx, ebuf, &ebuflen);\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}

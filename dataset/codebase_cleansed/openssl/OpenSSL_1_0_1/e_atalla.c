static int bind_helper(ENGINE *e)\r\n{\r\n#ifndef OPENSSL_NO_RSA\r\nconst RSA_METHOD *meth1;\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\nconst DSA_METHOD *meth2;\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\nconst DH_METHOD *meth3;\r\n#endif\r\nif(!ENGINE_set_id(e, engine_atalla_id) ||\r\n!ENGINE_set_name(e, engine_atalla_name) ||\r\n#ifndef OPENSSL_NO_RSA\r\n!ENGINE_set_RSA(e, &atalla_rsa) ||\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\n!ENGINE_set_DSA(e, &atalla_dsa) ||\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\n!ENGINE_set_DH(e, &atalla_dh) ||\r\n#endif\r\n!ENGINE_set_destroy_function(e, atalla_destroy) ||\r\n!ENGINE_set_init_function(e, atalla_init) ||\r\n!ENGINE_set_finish_function(e, atalla_finish) ||\r\n!ENGINE_set_ctrl_function(e, atalla_ctrl) ||\r\n!ENGINE_set_cmd_defns(e, atalla_cmd_defns))\r\nreturn 0;\r\n#ifndef OPENSSL_NO_RSA\r\nmeth1 = RSA_PKCS1_SSLeay();\r\natalla_rsa.rsa_pub_enc = meth1->rsa_pub_enc;\r\natalla_rsa.rsa_pub_dec = meth1->rsa_pub_dec;\r\natalla_rsa.rsa_priv_enc = meth1->rsa_priv_enc;\r\natalla_rsa.rsa_priv_dec = meth1->rsa_priv_dec;\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\nmeth2 = DSA_OpenSSL();\r\natalla_dsa.dsa_do_sign = meth2->dsa_do_sign;\r\natalla_dsa.dsa_sign_setup = meth2->dsa_sign_setup;\r\natalla_dsa.dsa_do_verify = meth2->dsa_do_verify;\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\nmeth3 = DH_OpenSSL();\r\natalla_dh.generate_key = meth3->generate_key;\r\natalla_dh.compute_key = meth3->compute_key;\r\n#endif\r\nERR_load_ATALLA_strings();\r\nreturn 1;\r\n}\r\nstatic ENGINE *engine_atalla(void)\r\n{\r\nENGINE *ret = ENGINE_new();\r\nif(!ret)\r\nreturn NULL;\r\nif(!bind_helper(ret))\r\n{\r\nENGINE_free(ret);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nvoid ENGINE_load_atalla(void)\r\n{\r\nENGINE *toadd = engine_atalla();\r\nif(!toadd) return;\r\nENGINE_add(toadd);\r\nENGINE_free(toadd);\r\nERR_clear_error();\r\n}\r\nstatic const char *get_ATALLA_LIBNAME(void)\r\n{\r\nif(ATALLA_LIBNAME)\r\nreturn ATALLA_LIBNAME;\r\nreturn "atasi";\r\n}\r\nstatic void free_ATALLA_LIBNAME(void)\r\n{\r\nif(ATALLA_LIBNAME)\r\nOPENSSL_free((void*)ATALLA_LIBNAME);\r\nATALLA_LIBNAME = NULL;\r\n}\r\nstatic long set_ATALLA_LIBNAME(const char *name)\r\n{\r\nfree_ATALLA_LIBNAME();\r\nreturn (((ATALLA_LIBNAME = BUF_strdup(name)) != NULL) ? 1 : 0);\r\n}\r\nstatic int atalla_destroy(ENGINE *e)\r\n{\r\nfree_ATALLA_LIBNAME();\r\nERR_unload_ATALLA_strings();\r\nreturn 1;\r\n}\r\nstatic int atalla_init(ENGINE *e)\r\n{\r\ntfnASI_GetHardwareConfig *p1;\r\ntfnASI_RSAPrivateKeyOpFn *p2;\r\ntfnASI_GetPerformanceStatistics *p3;\r\nunsigned int config_buf[1024];\r\nif(atalla_dso != NULL)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_INIT,ATALLA_R_ALREADY_LOADED);\r\ngoto err;\r\n}\r\natalla_dso = DSO_load(NULL, get_ATALLA_LIBNAME(), NULL, 0);\r\nif(atalla_dso == NULL)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_INIT,ATALLA_R_NOT_LOADED);\r\ngoto err;\r\n}\r\nif(!(p1 = (tfnASI_GetHardwareConfig *)DSO_bind_func(\r\natalla_dso, ATALLA_F1)) ||\r\n!(p2 = (tfnASI_RSAPrivateKeyOpFn *)DSO_bind_func(\r\natalla_dso, ATALLA_F2)) ||\r\n!(p3 = (tfnASI_GetPerformanceStatistics *)DSO_bind_func(\r\natalla_dso, ATALLA_F3)))\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_INIT,ATALLA_R_NOT_LOADED);\r\ngoto err;\r\n}\r\np_Atalla_GetHardwareConfig = p1;\r\np_Atalla_RSAPrivateKeyOpFn = p2;\r\np_Atalla_GetPerformanceStatistics = p3;\r\nif(p1(0L, config_buf) != 0)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_INIT,ATALLA_R_UNIT_FAILURE);\r\ngoto err;\r\n}\r\nreturn 1;\r\nerr:\r\nif(atalla_dso)\r\nDSO_free(atalla_dso);\r\natalla_dso = NULL;\r\np_Atalla_GetHardwareConfig = NULL;\r\np_Atalla_RSAPrivateKeyOpFn = NULL;\r\np_Atalla_GetPerformanceStatistics = NULL;\r\nreturn 0;\r\n}\r\nstatic int atalla_finish(ENGINE *e)\r\n{\r\nfree_ATALLA_LIBNAME();\r\nif(atalla_dso == NULL)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_FINISH,ATALLA_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(!DSO_free(atalla_dso))\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_FINISH,ATALLA_R_UNIT_FAILURE);\r\nreturn 0;\r\n}\r\natalla_dso = NULL;\r\np_Atalla_GetHardwareConfig = NULL;\r\np_Atalla_RSAPrivateKeyOpFn = NULL;\r\np_Atalla_GetPerformanceStatistics = NULL;\r\nreturn 1;\r\n}\r\nstatic int atalla_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f)(void))\r\n{\r\nint initialised = ((atalla_dso == NULL) ? 0 : 1);\r\nswitch(cmd)\r\n{\r\ncase ATALLA_CMD_SO_PATH:\r\nif(p == NULL)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_CTRL,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif(initialised)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_CTRL,ATALLA_R_ALREADY_LOADED);\r\nreturn 0;\r\n}\r\nreturn set_ATALLA_LIBNAME((const char *)p);\r\ndefault:\r\nbreak;\r\n}\r\nATALLAerr(ATALLA_F_ATALLA_CTRL,ATALLA_R_CTRL_COMMAND_NOT_IMPLEMENTED);\r\nreturn 0;\r\n}\r\nstatic int atalla_mod_exp(BIGNUM *r, const BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx)\r\n{\r\nBIGNUM *modulus;\r\nBIGNUM *exponent;\r\nBIGNUM *argument;\r\nBIGNUM *result;\r\nRSAPrivateKey keydata;\r\nint to_return, numbytes;\r\nmodulus = exponent = argument = result = NULL;\r\nto_return = 0;\r\nif(!atalla_dso)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_MOD_EXP,ATALLA_R_NOT_LOADED);\r\ngoto err;\r\n}\r\nBN_CTX_start(ctx);\r\nmodulus = BN_CTX_get(ctx);\r\nexponent = BN_CTX_get(ctx);\r\nargument = BN_CTX_get(ctx);\r\nresult = BN_CTX_get(ctx);\r\nif (!result)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_MOD_EXP,ATALLA_R_BN_CTX_FULL);\r\ngoto err;\r\n}\r\nif(!bn_wexpand(modulus, m->top) || !bn_wexpand(exponent, m->top) ||\r\n!bn_wexpand(argument, m->top) || !bn_wexpand(result, m->top))\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_MOD_EXP,ATALLA_R_BN_EXPAND_FAIL);\r\ngoto err;\r\n}\r\nmemset(&keydata, 0,sizeof keydata);\r\nnumbytes = BN_num_bytes(m);\r\nmemset(exponent->d, 0, numbytes);\r\nmemset(modulus->d, 0, numbytes);\r\nBN_bn2bin(p, (unsigned char *)exponent->d + numbytes - BN_num_bytes(p));\r\nBN_bn2bin(m, (unsigned char *)modulus->d + numbytes - BN_num_bytes(m));\r\nkeydata.privateExponent.data = (unsigned char *)exponent->d;\r\nkeydata.privateExponent.len = numbytes;\r\nkeydata.modulus.data = (unsigned char *)modulus->d;\r\nkeydata.modulus.len = numbytes;\r\nmemset(argument->d, 0, numbytes);\r\nmemset(result->d, 0, numbytes);\r\nBN_bn2bin(a, (unsigned char *)argument->d + numbytes - BN_num_bytes(a));\r\nif(p_Atalla_RSAPrivateKeyOpFn(&keydata, (unsigned char *)result->d,\r\n(unsigned char *)argument->d,\r\nkeydata.modulus.len) != 0)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_MOD_EXP,ATALLA_R_REQUEST_FAILED);\r\ngoto err;\r\n}\r\nBN_bin2bn((unsigned char *)result->d, numbytes, r);\r\nto_return = 1;\r\nerr:\r\nBN_CTX_end(ctx);\r\nreturn to_return;\r\n}\r\nstatic int atalla_rsa_mod_exp(BIGNUM *r0, const BIGNUM *I, RSA *rsa, BN_CTX *ctx)\r\n{\r\nint to_return = 0;\r\nif(!atalla_dso)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_RSA_MOD_EXP,ATALLA_R_NOT_LOADED);\r\ngoto err;\r\n}\r\nif(!rsa->d || !rsa->n)\r\n{\r\nATALLAerr(ATALLA_F_ATALLA_RSA_MOD_EXP,ATALLA_R_MISSING_KEY_COMPONENTS);\r\ngoto err;\r\n}\r\nto_return = atalla_mod_exp(r0, I, rsa->d, rsa->n, ctx);\r\nerr:\r\nreturn to_return;\r\n}\r\nstatic int atalla_dsa_mod_exp(DSA *dsa, BIGNUM *rr, BIGNUM *a1,\r\nBIGNUM *p1, BIGNUM *a2, BIGNUM *p2, BIGNUM *m,\r\nBN_CTX *ctx, BN_MONT_CTX *in_mont)\r\n{\r\nBIGNUM t;\r\nint to_return = 0;\r\nBN_init(&t);\r\nif (!atalla_mod_exp(rr,a1,p1,m,ctx)) goto end;\r\nif (!atalla_mod_exp(&t,a2,p2,m,ctx)) goto end;\r\nif (!BN_mod_mul(rr,rr,&t,m,ctx)) goto end;\r\nto_return = 1;\r\nend:\r\nBN_free(&t);\r\nreturn to_return;\r\n}\r\nstatic int atalla_mod_exp_dsa(DSA *dsa, BIGNUM *r, BIGNUM *a,\r\nconst BIGNUM *p, const BIGNUM *m, BN_CTX *ctx,\r\nBN_MONT_CTX *m_ctx)\r\n{\r\nreturn atalla_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int atalla_mod_exp_mont(BIGNUM *r, const BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nreturn atalla_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int atalla_mod_exp_dh(const DH *dh, BIGNUM *r,\r\nconst BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nreturn atalla_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int bind_fn(ENGINE *e, const char *id)\r\n{\r\nif(id && (strcmp(id, engine_atalla_id) != 0))\r\nreturn 0;\r\nif(!bind_helper(e))\r\nreturn 0;\r\nreturn 1;\r\n}

void BN_RECP_CTX_init(BN_RECP_CTX *recp)\r\n{\r\nBN_init(&(recp->N));\r\nBN_init(&(recp->Nr));\r\nrecp->num_bits=0;\r\nrecp->flags=0;\r\n}\r\nBN_RECP_CTX *BN_RECP_CTX_new(void)\r\n{\r\nBN_RECP_CTX *ret;\r\nif ((ret=(BN_RECP_CTX *)OPENSSL_malloc(sizeof(BN_RECP_CTX))) == NULL)\r\nreturn(NULL);\r\nBN_RECP_CTX_init(ret);\r\nret->flags=BN_FLG_MALLOCED;\r\nreturn(ret);\r\n}\r\nvoid BN_RECP_CTX_free(BN_RECP_CTX *recp)\r\n{\r\nif(recp == NULL)\r\nreturn;\r\nBN_free(&(recp->N));\r\nBN_free(&(recp->Nr));\r\nif (recp->flags & BN_FLG_MALLOCED)\r\nOPENSSL_free(recp);\r\n}\r\nint BN_RECP_CTX_set(BN_RECP_CTX *recp, const BIGNUM *d, BN_CTX *ctx)\r\n{\r\nif (!BN_copy(&(recp->N),d)) return 0;\r\nBN_zero(&(recp->Nr));\r\nrecp->num_bits=BN_num_bits(d);\r\nrecp->shift=0;\r\nreturn(1);\r\n}\r\nint BN_mod_mul_reciprocal(BIGNUM *r, const BIGNUM *x, const BIGNUM *y,\r\nBN_RECP_CTX *recp, BN_CTX *ctx)\r\n{\r\nint ret=0;\r\nBIGNUM *a;\r\nconst BIGNUM *ca;\r\nBN_CTX_start(ctx);\r\nif ((a = BN_CTX_get(ctx)) == NULL) goto err;\r\nif (y != NULL)\r\n{\r\nif (x == y)\r\n{ if (!BN_sqr(a,x,ctx)) goto err; }\r\nelse\r\n{ if (!BN_mul(a,x,y,ctx)) goto err; }\r\nca = a;\r\n}\r\nelse\r\nca=x;\r\nret = BN_div_recp(NULL,r,ca,recp,ctx);\r\nerr:\r\nBN_CTX_end(ctx);\r\nbn_check_top(r);\r\nreturn(ret);\r\n}\r\nint BN_div_recp(BIGNUM *dv, BIGNUM *rem, const BIGNUM *m,\r\nBN_RECP_CTX *recp, BN_CTX *ctx)\r\n{\r\nint i,j,ret=0;\r\nBIGNUM *a,*b,*d,*r;\r\nBN_CTX_start(ctx);\r\na=BN_CTX_get(ctx);\r\nb=BN_CTX_get(ctx);\r\nif (dv != NULL)\r\nd=dv;\r\nelse\r\nd=BN_CTX_get(ctx);\r\nif (rem != NULL)\r\nr=rem;\r\nelse\r\nr=BN_CTX_get(ctx);\r\nif (a == NULL || b == NULL || d == NULL || r == NULL) goto err;\r\nif (BN_ucmp(m,&(recp->N)) < 0)\r\n{\r\nBN_zero(d);\r\nif (!BN_copy(r,m)) return 0;\r\nBN_CTX_end(ctx);\r\nreturn(1);\r\n}\r\ni=BN_num_bits(m);\r\nj=recp->num_bits<<1;\r\nif (j>i) i=j;\r\nif (i != recp->shift)\r\nrecp->shift=BN_reciprocal(&(recp->Nr),&(recp->N),\r\ni,ctx);\r\nif (recp->shift == -1) goto err;\r\nif (!BN_rshift(a,m,recp->num_bits)) goto err;\r\nif (!BN_mul(b,a,&(recp->Nr),ctx)) goto err;\r\nif (!BN_rshift(d,b,i-recp->num_bits)) goto err;\r\nd->neg=0;\r\nif (!BN_mul(b,&(recp->N),d,ctx)) goto err;\r\nif (!BN_usub(r,m,b)) goto err;\r\nr->neg=0;\r\n#if 1\r\nj=0;\r\nwhile (BN_ucmp(r,&(recp->N)) >= 0)\r\n{\r\nif (j++ > 2)\r\n{\r\nBNerr(BN_F_BN_DIV_RECP,BN_R_BAD_RECIPROCAL);\r\ngoto err;\r\n}\r\nif (!BN_usub(r,r,&(recp->N))) goto err;\r\nif (!BN_add_word(d,1)) goto err;\r\n}\r\n#endif\r\nr->neg=BN_is_zero(r)?0:m->neg;\r\nd->neg=m->neg^recp->N.neg;\r\nret=1;\r\nerr:\r\nBN_CTX_end(ctx);\r\nbn_check_top(dv);\r\nbn_check_top(rem);\r\nreturn(ret);\r\n}\r\nint BN_reciprocal(BIGNUM *r, const BIGNUM *m, int len, BN_CTX *ctx)\r\n{\r\nint ret= -1;\r\nBIGNUM *t;\r\nBN_CTX_start(ctx);\r\nif((t = BN_CTX_get(ctx)) == NULL) goto err;\r\nif (!BN_set_bit(t,len)) goto err;\r\nif (!BN_div(r,NULL,t,m,ctx)) goto err;\r\nret=len;\r\nerr:\r\nbn_check_top(r);\r\nBN_CTX_end(ctx);\r\nreturn(ret);\r\n}

X509 *TS_CONF_load_cert(const char *file)\r\n{\r\nBIO *cert = NULL;\r\nX509 *x = NULL;\r\nif ((cert = BIO_new_file(file, "r")) == NULL) goto end;\r\nx = PEM_read_bio_X509_AUX(cert, NULL, NULL, NULL);\r\nend:\r\nif (x == NULL)\r\nfprintf(stderr, "unable to load certificate: %s\n", file);\r\nBIO_free(cert);\r\nreturn x;\r\n}\r\nvoid TS_CONF_lookup_fail(const char *name, const char *tag)\r\n{\r\nfprintf(stderr, "variable lookup failed for %s::%s\n", name, tag);\r\n}\r\nstatic void TS_CONF_invalid(const char *name, const char *tag)\r\n{\r\nfprintf(stderr, "invalid variable value for %s::%s\n", name, tag);\r\n}\r\nconst char *TS_CONF_get_tsa_section(CONF *conf, const char *section)\r\n{\r\nif (!section)\r\n{\r\nsection = NCONF_get_string(conf, BASE_SECTION, ENV_DEFAULT_TSA);\r\nif (!section)\r\nTS_CONF_lookup_fail(BASE_SECTION, ENV_DEFAULT_TSA);\r\n}\r\nreturn section;\r\n}\r\nint TS_CONF_set_serial(CONF *conf, const char *section, TS_serial_cb cb,\r\nTS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nchar *serial = NCONF_get_string(conf, section, ENV_SERIAL);\r\nif (!serial)\r\n{\r\nTS_CONF_lookup_fail(section, ENV_SERIAL);\r\ngoto err;\r\n}\r\nTS_RESP_CTX_set_serial_cb(ctx, cb, serial);\r\nret = 1;\r\nerr:\r\nreturn ret;\r\n}\r\nint TS_CONF_set_crypto_device(CONF *conf, const char *section,\r\nconst char *device)\r\n{\r\nint ret = 0;\r\nif (!device)\r\ndevice = NCONF_get_string(conf, section,\r\nENV_CRYPTO_DEVICE);\r\nif (device && !TS_CONF_set_default_engine(device))\r\n{\r\nTS_CONF_invalid(section, ENV_CRYPTO_DEVICE);\r\ngoto err;\r\n}\r\nret = 1;\r\nerr:\r\nreturn ret;\r\n}\r\nint TS_CONF_set_default_engine(const char *name)\r\n{\r\nENGINE *e = NULL;\r\nint ret = 0;\r\nif (strcmp(name, "builtin") == 0) return 1;\r\nif (!(e = ENGINE_by_id(name))) goto err;\r\nif (strcmp(name, "chil") == 0)\r\nENGINE_ctrl(e, ENGINE_CTRL_CHIL_SET_FORKCHECK, 1, 0, 0);\r\nif (!ENGINE_set_default(e, ENGINE_METHOD_ALL)) goto err;\r\nret = 1;\r\nerr:\r\nif (!ret)\r\n{\r\nTSerr(TS_F_TS_CONF_SET_DEFAULT_ENGINE,\r\nTS_R_COULD_NOT_SET_ENGINE);\r\nERR_add_error_data(2, "engine:", name);\r\n}\r\nif (e) ENGINE_free(e);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_signer_cert(CONF *conf, const char *section,\r\nconst char *cert, TS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nX509 *cert_obj = NULL;\r\nif (!cert)\r\ncert = NCONF_get_string(conf, section, ENV_SIGNER_CERT);\r\nif (!cert)\r\n{\r\nTS_CONF_lookup_fail(section, ENV_SIGNER_CERT);\r\ngoto err;\r\n}\r\nif (!(cert_obj = TS_CONF_load_cert(cert)))\r\ngoto err;\r\nif (!TS_RESP_CTX_set_signer_cert(ctx, cert_obj))\r\ngoto err;\r\nret = 1;\r\nerr:\r\nX509_free(cert_obj);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_certs(CONF *conf, const char *section, const char *certs,\r\nTS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nSTACK_OF(X509) *certs_obj = NULL;\r\nif (!certs)\r\ncerts = NCONF_get_string(conf, section, ENV_CERTS);\r\nif (!certs) goto end;\r\nif (!(certs_obj = TS_CONF_load_certs(certs))) goto err;\r\nif (!TS_RESP_CTX_set_certs(ctx, certs_obj)) goto err;\r\nend:\r\nret = 1;\r\nerr:\r\nsk_X509_pop_free(certs_obj, X509_free);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_signer_key(CONF *conf, const char *section,\r\nconst char *key, const char *pass,\r\nTS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nEVP_PKEY *key_obj = NULL;\r\nif (!key)\r\nkey = NCONF_get_string(conf, section, ENV_SIGNER_KEY);\r\nif (!key)\r\n{\r\nTS_CONF_lookup_fail(section, ENV_SIGNER_KEY);\r\ngoto err;\r\n}\r\nif (!(key_obj = TS_CONF_load_key(key, pass))) goto err;\r\nif (!TS_RESP_CTX_set_signer_key(ctx, key_obj)) goto err;\r\nret = 1;\r\nerr:\r\nEVP_PKEY_free(key_obj);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_def_policy(CONF *conf, const char *section,\r\nconst char *policy, TS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nASN1_OBJECT *policy_obj = NULL;\r\nif (!policy)\r\npolicy = NCONF_get_string(conf, section,\r\nENV_DEFAULT_POLICY);\r\nif (!policy)\r\n{\r\nTS_CONF_lookup_fail(section, ENV_DEFAULT_POLICY);\r\ngoto err;\r\n}\r\nif (!(policy_obj = OBJ_txt2obj(policy, 0)))\r\n{\r\nTS_CONF_invalid(section, ENV_DEFAULT_POLICY);\r\ngoto err;\r\n}\r\nif (!TS_RESP_CTX_set_def_policy(ctx, policy_obj))\r\ngoto err;\r\nret = 1;\r\nerr:\r\nASN1_OBJECT_free(policy_obj);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_policies(CONF *conf, const char *section,\r\nTS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nint i;\r\nSTACK_OF(CONF_VALUE) *list = NULL;\r\nchar *policies = NCONF_get_string(conf, section,\r\nENV_OTHER_POLICIES);\r\nif (policies && !(list = X509V3_parse_list(policies)))\r\n{\r\nTS_CONF_invalid(section, ENV_OTHER_POLICIES);\r\ngoto err;\r\n}\r\nfor (i = 0; i < sk_CONF_VALUE_num(list); ++i)\r\n{\r\nCONF_VALUE *val = sk_CONF_VALUE_value(list, i);\r\nconst char *extval = val->value ? val->value : val->name;\r\nASN1_OBJECT *objtmp;\r\nif (!(objtmp = OBJ_txt2obj(extval, 0)))\r\n{\r\nTS_CONF_invalid(section, ENV_OTHER_POLICIES);\r\ngoto err;\r\n}\r\nif (!TS_RESP_CTX_add_policy(ctx, objtmp))\r\ngoto err;\r\nASN1_OBJECT_free(objtmp);\r\n}\r\nret = 1;\r\nerr:\r\nsk_CONF_VALUE_pop_free(list, X509V3_conf_free);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_digests(CONF *conf, const char *section,\r\nTS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nint i;\r\nSTACK_OF(CONF_VALUE) *list = NULL;\r\nchar *digests = NCONF_get_string(conf, section, ENV_DIGESTS);\r\nif (!digests)\r\n{\r\nTS_CONF_lookup_fail(section, ENV_DIGESTS);\r\ngoto err;\r\n}\r\nif (!(list = X509V3_parse_list(digests)))\r\n{\r\nTS_CONF_invalid(section, ENV_DIGESTS);\r\ngoto err;\r\n}\r\nif (sk_CONF_VALUE_num(list) == 0)\r\n{\r\nTS_CONF_invalid(section, ENV_DIGESTS);\r\ngoto err;\r\n}\r\nfor (i = 0; i < sk_CONF_VALUE_num(list); ++i)\r\n{\r\nCONF_VALUE *val = sk_CONF_VALUE_value(list, i);\r\nconst char *extval = val->value ? val->value : val->name;\r\nconst EVP_MD *md;\r\nif (!(md = EVP_get_digestbyname(extval)))\r\n{\r\nTS_CONF_invalid(section, ENV_DIGESTS);\r\ngoto err;\r\n}\r\nif (!TS_RESP_CTX_add_md(ctx, md))\r\ngoto err;\r\n}\r\nret = 1;\r\nerr:\r\nsk_CONF_VALUE_pop_free(list, X509V3_conf_free);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_accuracy(CONF *conf, const char *section, TS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nint i;\r\nint secs = 0, millis = 0, micros = 0;\r\nSTACK_OF(CONF_VALUE) *list = NULL;\r\nchar *accuracy = NCONF_get_string(conf, section, ENV_ACCURACY);\r\nif (accuracy && !(list = X509V3_parse_list(accuracy)))\r\n{\r\nTS_CONF_invalid(section, ENV_ACCURACY);\r\ngoto err;\r\n}\r\nfor (i = 0; i < sk_CONF_VALUE_num(list); ++i)\r\n{\r\nCONF_VALUE *val = sk_CONF_VALUE_value(list, i);\r\nif (strcmp(val->name, ENV_VALUE_SECS) == 0)\r\n{\r\nif (val->value) secs = atoi(val->value);\r\n}\r\nelse if (strcmp(val->name, ENV_VALUE_MILLISECS) == 0)\r\n{\r\nif (val->value) millis = atoi(val->value);\r\n}\r\nelse if (strcmp(val->name, ENV_VALUE_MICROSECS) == 0)\r\n{\r\nif (val->value) micros = atoi(val->value);\r\n}\r\nelse\r\n{\r\nTS_CONF_invalid(section, ENV_ACCURACY);\r\ngoto err;\r\n}\r\n}\r\nif (!TS_RESP_CTX_set_accuracy(ctx, secs, millis, micros))\r\ngoto err;\r\nret = 1;\r\nerr:\r\nsk_CONF_VALUE_pop_free(list, X509V3_conf_free);\r\nreturn ret;\r\n}\r\nint TS_CONF_set_clock_precision_digits(CONF *conf, const char *section,\r\nTS_RESP_CTX *ctx)\r\n{\r\nint ret = 0;\r\nlong digits = 0;\r\nif (!NCONF_get_number_e(conf, section, ENV_CLOCK_PRECISION_DIGITS,\r\n&digits))\r\ndigits = 0;\r\nif (digits < 0 || digits > TS_MAX_CLOCK_PRECISION_DIGITS)\r\n{\r\nTS_CONF_invalid(section, ENV_CLOCK_PRECISION_DIGITS);\r\ngoto err;\r\n}\r\nif (!TS_RESP_CTX_set_clock_precision_digits(ctx, digits))\r\ngoto err;\r\nreturn 1;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int TS_CONF_add_flag(CONF *conf, const char *section, const char *field,\r\nint flag, TS_RESP_CTX *ctx)\r\n{\r\nconst char *value = NCONF_get_string(conf, section, field);\r\nif (value)\r\n{\r\nif (strcmp(value, ENV_VALUE_YES) == 0)\r\nTS_RESP_CTX_add_flags(ctx, flag);\r\nelse if (strcmp(value, ENV_VALUE_NO) != 0)\r\n{\r\nTS_CONF_invalid(section, field);\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nint TS_CONF_set_ordering(CONF *conf, const char *section, TS_RESP_CTX *ctx)\r\n{\r\nreturn TS_CONF_add_flag(conf, section, ENV_ORDERING, TS_ORDERING, ctx);\r\n}\r\nint TS_CONF_set_tsa_name(CONF *conf, const char *section, TS_RESP_CTX *ctx)\r\n{\r\nreturn TS_CONF_add_flag(conf, section, ENV_TSA_NAME, TS_TSA_NAME, ctx);\r\n}\r\nint TS_CONF_set_ess_cert_id_chain(CONF *conf, const char *section,\r\nTS_RESP_CTX *ctx)\r\n{\r\nreturn TS_CONF_add_flag(conf, section, ENV_ESS_CERT_ID_CHAIN,\r\nTS_ESS_CERT_ID_CHAIN, ctx);\r\n}

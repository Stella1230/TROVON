int MAIN(int argc, char **argv)\r\n{\r\nint hex=0;\r\nint checks=20;\r\nint generate=0;\r\nint bits=0;\r\nint safe=0;\r\nBIGNUM *bn=NULL;\r\nBIO *bio_out;\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE|BIO_FP_TEXT);\r\n--argc;\r\n++argv;\r\nwhile (argc >= 1 && **argv == '-')\r\n{\r\nif(!strcmp(*argv,"-hex"))\r\nhex=1;\r\nelse if(!strcmp(*argv,"-generate"))\r\ngenerate=1;\r\nelse if(!strcmp(*argv,"-bits"))\r\nif(--argc < 1)\r\ngoto bad;\r\nelse\r\nbits=atoi(*++argv);\r\nelse if(!strcmp(*argv,"-safe"))\r\nsafe=1;\r\nelse if(!strcmp(*argv,"-checks"))\r\nif(--argc < 1)\r\ngoto bad;\r\nelse\r\nchecks=atoi(*++argv);\r\nelse\r\n{\r\nBIO_printf(bio_err,"Unknown option '%s'\n",*argv);\r\ngoto bad;\r\n}\r\n--argc;\r\n++argv;\r\n}\r\nif (argv[0] == NULL && !generate)\r\n{\r\nBIO_printf(bio_err,"No prime specified\n");\r\ngoto bad;\r\n}\r\nif ((bio_out=BIO_new(BIO_s_file())) != NULL)\r\n{\r\nBIO_set_fp(bio_out,stdout,BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nbio_out = BIO_push(tmpbio, bio_out);\r\n}\r\n#endif\r\n}\r\nif(generate)\r\n{\r\nchar *s;\r\nif(!bits)\r\n{\r\nBIO_printf(bio_err,"Specifiy the number of bits.\n");\r\nreturn 1;\r\n}\r\nbn=BN_new();\r\nBN_generate_prime_ex(bn,bits,safe,NULL,NULL,NULL);\r\ns=hex ? BN_bn2hex(bn) : BN_bn2dec(bn);\r\nBIO_printf(bio_out,"%s\n",s);\r\nOPENSSL_free(s);\r\n}\r\nelse\r\n{\r\nif(hex)\r\nBN_hex2bn(&bn,argv[0]);\r\nelse\r\nBN_dec2bn(&bn,argv[0]);\r\nBN_print(bio_out,bn);\r\nBIO_printf(bio_out," is %sprime\n",\r\nBN_is_prime_ex(bn,checks,NULL,NULL) ? "" : "not ");\r\n}\r\nBN_free(bn);\r\nBIO_free_all(bio_out);\r\nreturn 0;\r\nbad:\r\nBIO_printf(bio_err,"options are\n");\r\nBIO_printf(bio_err,"%-14s hex\n","-hex");\r\nBIO_printf(bio_err,"%-14s number of checks\n","-checks <n>");\r\nreturn 1;\r\n}

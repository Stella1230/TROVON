int CMS_get1_ReceiptRequest(CMS_SignerInfo *si, CMS_ReceiptRequest **prr)\r\n{\r\nASN1_STRING *str;\r\nCMS_ReceiptRequest *rr = NULL;\r\nif (prr)\r\n*prr = NULL;\r\nstr = CMS_signed_get0_data_by_OBJ(si,\r\nOBJ_nid2obj(NID_id_smime_aa_receiptRequest),\r\n-3, V_ASN1_SEQUENCE);\r\nif (!str)\r\nreturn 0;\r\nrr = ASN1_item_unpack(str, ASN1_ITEM_rptr(CMS_ReceiptRequest));\r\nif (!rr)\r\nreturn -1;\r\nif (prr)\r\n*prr = rr;\r\nelse\r\nCMS_ReceiptRequest_free(rr);\r\nreturn 1;\r\n}\r\nint CMS_add1_ReceiptRequest(CMS_SignerInfo *si, CMS_ReceiptRequest *rr)\r\n{\r\nunsigned char *rrder = NULL;\r\nint rrderlen, r = 0;\r\nrrderlen = i2d_CMS_ReceiptRequest(rr, &rrder);\r\nif (rrderlen < 0)\r\ngoto merr;\r\nif (!CMS_signed_add1_attr_by_NID(si, NID_id_smime_aa_receiptRequest,\r\nV_ASN1_SEQUENCE, rrder, rrderlen))\r\ngoto merr;\r\nr = 1;\r\nmerr:\r\nif (!r)\r\nCMSerr(CMS_F_CMS_ADD1_RECEIPTREQUEST, ERR_R_MALLOC_FAILURE);\r\nif (rrder)\r\nOPENSSL_free(rrder);\r\nreturn r;\r\n}\r\nstatic int cms_msgSigDigest(CMS_SignerInfo *si,\r\nunsigned char *dig, unsigned int *diglen)\r\n{\r\nconst EVP_MD *md;\r\nmd = EVP_get_digestbyobj(si->digestAlgorithm->algorithm);\r\nif (md == NULL)\r\nreturn 0;\r\nif (!ASN1_item_digest(ASN1_ITEM_rptr(CMS_Attributes_Verify), md,\r\nsi->signedAttrs, dig, diglen))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint cms_msgSigDigest_add1(CMS_SignerInfo *dest, CMS_SignerInfo *src)\r\n{\r\nunsigned char dig[EVP_MAX_MD_SIZE];\r\nunsigned int diglen;\r\nif (!cms_msgSigDigest(src, dig, &diglen))\r\n{\r\nCMSerr(CMS_F_CMS_MSGSIGDIGEST_ADD1, CMS_R_MSGSIGDIGEST_ERROR);\r\nreturn 0;\r\n}\r\nif (!CMS_signed_add1_attr_by_NID(dest, NID_id_smime_aa_msgSigDigest,\r\nV_ASN1_OCTET_STRING, dig, diglen))\r\n{\r\nCMSerr(CMS_F_CMS_MSGSIGDIGEST_ADD1, ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint cms_Receipt_verify(CMS_ContentInfo *cms, CMS_ContentInfo *req_cms)\r\n{\r\nint r = 0, i;\r\nCMS_ReceiptRequest *rr = NULL;\r\nCMS_Receipt *rct = NULL;\r\nSTACK_OF(CMS_SignerInfo) *sis, *osis;\r\nCMS_SignerInfo *si, *osi = NULL;\r\nASN1_OCTET_STRING *msig, **pcont;\r\nASN1_OBJECT *octype;\r\nunsigned char dig[EVP_MAX_MD_SIZE];\r\nunsigned int diglen;\r\nosis = CMS_get0_SignerInfos(req_cms);\r\nsis = CMS_get0_SignerInfos(cms);\r\nif (!osis || !sis)\r\ngoto err;\r\nif (sk_CMS_SignerInfo_num(sis) != 1)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NEED_ONE_SIGNER);\r\ngoto err;\r\n}\r\nif (OBJ_obj2nid(CMS_get0_eContentType(cms)) != NID_id_smime_ct_receipt)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NOT_A_SIGNED_RECEIPT);\r\ngoto err;\r\n}\r\npcont = CMS_get0_content(cms);\r\nif (!pcont || !*pcont)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NO_CONTENT);\r\ngoto err;\r\n}\r\nrct = ASN1_item_unpack(*pcont, ASN1_ITEM_rptr(CMS_Receipt));\r\nif (!rct)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_RECEIPT_DECODE_ERROR);\r\ngoto err;\r\n}\r\nfor (i = 0; i < sk_CMS_SignerInfo_num(osis); i++)\r\n{\r\nosi = sk_CMS_SignerInfo_value(osis, i);\r\nif (!ASN1_STRING_cmp(osi->signature,\r\nrct->originatorSignatureValue))\r\nbreak;\r\n}\r\nif (i == sk_CMS_SignerInfo_num(osis))\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NO_MATCHING_SIGNATURE);\r\ngoto err;\r\n}\r\nsi = sk_CMS_SignerInfo_value(sis, 0);\r\nmsig = CMS_signed_get0_data_by_OBJ(si,\r\nOBJ_nid2obj(NID_id_smime_aa_msgSigDigest),\r\n-3, V_ASN1_OCTET_STRING);\r\nif (!msig)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NO_MSGSIGDIGEST);\r\ngoto err;\r\n}\r\nif (!cms_msgSigDigest(osi, dig, &diglen))\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_MSGSIGDIGEST_ERROR);\r\ngoto err;\r\n}\r\nif (diglen != (unsigned int)msig->length)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY,\r\nCMS_R_MSGSIGDIGEST_WRONG_LENGTH);\r\ngoto err;\r\n}\r\nif (memcmp(dig, msig->data, diglen))\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY,\r\nCMS_R_MSGSIGDIGEST_VERIFICATION_FAILURE);\r\ngoto err;\r\n}\r\noctype = CMS_signed_get0_data_by_OBJ(osi,\r\nOBJ_nid2obj(NID_pkcs9_contentType),\r\n-3, V_ASN1_OBJECT);\r\nif (!octype)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NO_CONTENT_TYPE);\r\ngoto err;\r\n}\r\nif (OBJ_cmp(octype, rct->contentType))\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_CONTENT_TYPE_MISMATCH);\r\ngoto err;\r\n}\r\nif (CMS_get1_ReceiptRequest(osi, &rr) <= 0)\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY, CMS_R_NO_RECEIPT_REQUEST);\r\ngoto err;\r\n}\r\nif (ASN1_STRING_cmp(rr->signedContentIdentifier,\r\nrct->signedContentIdentifier))\r\n{\r\nCMSerr(CMS_F_CMS_RECEIPT_VERIFY,\r\nCMS_R_CONTENTIDENTIFIER_MISMATCH);\r\ngoto err;\r\n}\r\nr = 1;\r\nerr:\r\nif (rr)\r\nCMS_ReceiptRequest_free(rr);\r\nif (rct)\r\nM_ASN1_free_of(rct, CMS_Receipt);\r\nreturn r;\r\n}\r\nASN1_OCTET_STRING *cms_encode_Receipt(CMS_SignerInfo *si)\r\n{\r\nCMS_Receipt rct;\r\nCMS_ReceiptRequest *rr = NULL;\r\nASN1_OBJECT *ctype;\r\nASN1_OCTET_STRING *os = NULL;\r\nif (CMS_get1_ReceiptRequest(si, &rr) <= 0)\r\n{\r\nCMSerr(CMS_F_CMS_ENCODE_RECEIPT, CMS_R_NO_RECEIPT_REQUEST);\r\ngoto err;\r\n}\r\nctype = CMS_signed_get0_data_by_OBJ(si,\r\nOBJ_nid2obj(NID_pkcs9_contentType),\r\n-3, V_ASN1_OBJECT);\r\nif (!ctype)\r\n{\r\nCMSerr(CMS_F_CMS_ENCODE_RECEIPT, CMS_R_NO_CONTENT_TYPE);\r\ngoto err;\r\n}\r\nrct.version = 1;\r\nrct.contentType = ctype;\r\nrct.signedContentIdentifier = rr->signedContentIdentifier;\r\nrct.originatorSignatureValue = si->signature;\r\nos = ASN1_item_pack(&rct, ASN1_ITEM_rptr(CMS_Receipt), NULL);\r\nerr:\r\nif (rr)\r\nCMS_ReceiptRequest_free(rr);\r\nreturn os;\r\n}

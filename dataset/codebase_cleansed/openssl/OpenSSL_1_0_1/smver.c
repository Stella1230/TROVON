int main(int argc, char **argv)\r\n{\r\nBIO *in = NULL, *out = NULL, *tbio = NULL, *cont = NULL;\r\nX509_STORE *st = NULL;\r\nX509 *cacert = NULL;\r\nPKCS7 *p7 = NULL;\r\nint ret = 1;\r\nOpenSSL_add_all_algorithms();\r\nERR_load_crypto_strings();\r\nst = X509_STORE_new();\r\ntbio = BIO_new_file("cacert.pem", "r");\r\nif (!tbio)\r\ngoto err;\r\ncacert = PEM_read_bio_X509(tbio, NULL, 0, NULL);\r\nif (!cacert)\r\ngoto err;\r\nif (!X509_STORE_add_cert(st, cacert))\r\ngoto err;\r\nin = BIO_new_file("smout.txt", "r");\r\nif (!in)\r\ngoto err;\r\np7 = SMIME_read_PKCS7(in, &cont);\r\nif (!p7)\r\ngoto err;\r\nout = BIO_new_file("smver.txt", "w");\r\nif (!out)\r\ngoto err;\r\nif (!PKCS7_verify(p7, NULL, st, cont, out, 0))\r\n{\r\nfprintf(stderr, "Verification Failure\n");\r\ngoto err;\r\n}\r\nfprintf(stderr, "Verification Successful\n");\r\nret = 0;\r\nerr:\r\nif (ret)\r\n{\r\nfprintf(stderr, "Error Verifying Data\n");\r\nERR_print_errors_fp(stderr);\r\n}\r\nif (p7)\r\nPKCS7_free(p7);\r\nif (cacert)\r\nX509_free(cacert);\r\nif (in)\r\nBIO_free(in);\r\nif (out)\r\nBIO_free(out);\r\nif (tbio)\r\nBIO_free(tbio);\r\nreturn ret;\r\n}

static int des_ecb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\nBLOCK_CIPHER_ecb_loop()\r\nDES_ecb_encrypt((DES_cblock *)(in + i), (DES_cblock *)(out + i), ctx->cipher_data, ctx->encrypt);\r\nreturn 1;\r\n}\r\nstatic int des_ofb_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\nwhile(inl>=EVP_MAXCHUNK)\r\n{\r\nDES_ofb64_encrypt(in, out, (long)EVP_MAXCHUNK, ctx->cipher_data,\r\n(DES_cblock *)ctx->iv, &ctx->num);\r\ninl-=EVP_MAXCHUNK;\r\nin +=EVP_MAXCHUNK;\r\nout+=EVP_MAXCHUNK;\r\n}\r\nif (inl)\r\nDES_ofb64_encrypt(in, out, (long)inl, ctx->cipher_data,\r\n(DES_cblock *)ctx->iv, &ctx->num);\r\nreturn 1;\r\n}\r\nstatic int des_cbc_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\nwhile(inl>=EVP_MAXCHUNK)\r\n{\r\nDES_ncbc_encrypt(in, out, (long)EVP_MAXCHUNK, ctx->cipher_data,\r\n(DES_cblock *)ctx->iv, ctx->encrypt);\r\ninl-=EVP_MAXCHUNK;\r\nin +=EVP_MAXCHUNK;\r\nout+=EVP_MAXCHUNK;\r\n}\r\nif (inl)\r\nDES_ncbc_encrypt(in, out, (long)inl, ctx->cipher_data,\r\n(DES_cblock *)ctx->iv, ctx->encrypt);\r\nreturn 1;\r\n}\r\nstatic int des_cfb64_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\nwhile(inl>=EVP_MAXCHUNK)\r\n{\r\nDES_cfb64_encrypt(in,out, (long)EVP_MAXCHUNK, ctx->cipher_data,\r\n(DES_cblock *)ctx->iv, &ctx->num, ctx->encrypt);\r\ninl-=EVP_MAXCHUNK;\r\nin +=EVP_MAXCHUNK;\r\nout+=EVP_MAXCHUNK;\r\n}\r\nif (inl)\r\nDES_cfb64_encrypt(in, out, (long)inl, ctx->cipher_data,\r\n(DES_cblock *)ctx->iv, &ctx->num, ctx->encrypt);\r\nreturn 1;\r\n}\r\nstatic int des_cfb1_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\nsize_t n,chunk=EVP_MAXCHUNK/8;\r\nunsigned char c[1],d[1];\r\nif (inl<chunk) chunk=inl;\r\nwhile (inl && inl>=chunk)\r\n{\r\nfor(n=0 ; n < chunk*8; ++n)\r\n{\r\nc[0]=(in[n/8]&(1 << (7-n%8))) ? 0x80 : 0;\r\nDES_cfb_encrypt(c,d,1,1,ctx->cipher_data,(DES_cblock *)ctx->iv,\r\nctx->encrypt);\r\nout[n/8]=(out[n/8]&~(0x80 >> (unsigned int)(n%8))) |\r\n((d[0]&0x80) >> (unsigned int)(n%8));\r\n}\r\ninl-=chunk;\r\nin +=chunk;\r\nout+=chunk;\r\nif (inl<chunk) chunk=inl;\r\n}\r\nreturn 1;\r\n}\r\nstatic int des_cfb8_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\nwhile (inl>=EVP_MAXCHUNK)\r\n{\r\nDES_cfb_encrypt(in,out,8,(long)EVP_MAXCHUNK,ctx->cipher_data,\r\n(DES_cblock *)ctx->iv,ctx->encrypt);\r\ninl-=EVP_MAXCHUNK;\r\nin +=EVP_MAXCHUNK;\r\nout+=EVP_MAXCHUNK;\r\n}\r\nif (inl)\r\nDES_cfb_encrypt(in,out,8,(long)inl,ctx->cipher_data,\r\n(DES_cblock *)ctx->iv,ctx->encrypt);\r\nreturn 1;\r\n}\r\nstatic int des_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,\r\nconst unsigned char *iv, int enc)\r\n{\r\nDES_cblock *deskey = (DES_cblock *)key;\r\n#ifdef EVP_CHECK_DES_KEY\r\nif(DES_set_key_checked(deskey,ctx->cipher_data) != 0)\r\nreturn 0;\r\n#else\r\nDES_set_key_unchecked(deskey,ctx->cipher_data);\r\n#endif\r\nreturn 1;\r\n}\r\nstatic int des_ctrl(EVP_CIPHER_CTX *c, int type, int arg, void *ptr)\r\n{\r\nswitch(type)\r\n{\r\ncase EVP_CTRL_RAND_KEY:\r\nif (RAND_bytes(ptr, 8) <= 0)\r\nreturn 0;\r\nDES_set_odd_parity((DES_cblock *)ptr);\r\nreturn 1;\r\ndefault:\r\nreturn -1;\r\n}\r\n}

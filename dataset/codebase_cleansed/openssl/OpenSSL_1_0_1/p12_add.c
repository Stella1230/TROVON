PKCS12_SAFEBAG *PKCS12_item_pack_safebag(void *obj, const ASN1_ITEM *it, int nid1,\r\nint nid2)\r\n{\r\nPKCS12_BAGS *bag;\r\nPKCS12_SAFEBAG *safebag;\r\nif (!(bag = PKCS12_BAGS_new())) {\r\nPKCS12err(PKCS12_F_PKCS12_ITEM_PACK_SAFEBAG, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nbag->type = OBJ_nid2obj(nid1);\r\nif (!ASN1_item_pack(obj, it, &bag->value.octet)) {\r\nPKCS12err(PKCS12_F_PKCS12_ITEM_PACK_SAFEBAG, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nif (!(safebag = PKCS12_SAFEBAG_new())) {\r\nPKCS12err(PKCS12_F_PKCS12_ITEM_PACK_SAFEBAG, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nsafebag->value.bag = bag;\r\nsafebag->type = OBJ_nid2obj(nid2);\r\nreturn safebag;\r\n}\r\nPKCS12_SAFEBAG *PKCS12_MAKE_KEYBAG(PKCS8_PRIV_KEY_INFO *p8)\r\n{\r\nPKCS12_SAFEBAG *bag;\r\nif (!(bag = PKCS12_SAFEBAG_new())) {\r\nPKCS12err(PKCS12_F_PKCS12_MAKE_KEYBAG,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nbag->type = OBJ_nid2obj(NID_keyBag);\r\nbag->value.keybag = p8;\r\nreturn bag;\r\n}\r\nPKCS12_SAFEBAG *PKCS12_MAKE_SHKEYBAG(int pbe_nid, const char *pass,\r\nint passlen, unsigned char *salt, int saltlen, int iter,\r\nPKCS8_PRIV_KEY_INFO *p8)\r\n{\r\nPKCS12_SAFEBAG *bag;\r\nconst EVP_CIPHER *pbe_ciph;\r\nif (!(bag = PKCS12_SAFEBAG_new())) {\r\nPKCS12err(PKCS12_F_PKCS12_MAKE_SHKEYBAG, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nbag->type = OBJ_nid2obj(NID_pkcs8ShroudedKeyBag);\r\npbe_ciph = EVP_get_cipherbynid(pbe_nid);\r\nif (pbe_ciph)\r\npbe_nid = -1;\r\nif (!(bag->value.shkeybag =\r\nPKCS8_encrypt(pbe_nid, pbe_ciph, pass, passlen, salt, saltlen, iter,\r\np8))) {\r\nPKCS12err(PKCS12_F_PKCS12_MAKE_SHKEYBAG, ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nreturn bag;\r\n}

static const char *get_NURON_LIBNAME(void)\r\n{\r\nif(NURON_LIBNAME)\r\nreturn NURON_LIBNAME;\r\nreturn "nuronssl";\r\n}\r\nstatic void free_NURON_LIBNAME(void)\r\n{\r\nif(NURON_LIBNAME)\r\nOPENSSL_free((void*)NURON_LIBNAME);\r\nNURON_LIBNAME = NULL;\r\n}\r\nstatic long set_NURON_LIBNAME(const char *name)\r\n{\r\nfree_NURON_LIBNAME();\r\nreturn (((NURON_LIBNAME = BUF_strdup(name)) != NULL) ? 1 : 0);\r\n}\r\nstatic int nuron_destroy(ENGINE *e)\r\n{\r\nfree_NURON_LIBNAME();\r\nERR_unload_NURON_strings();\r\nreturn 1;\r\n}\r\nstatic int nuron_init(ENGINE *e)\r\n{\r\nif(pvDSOHandle != NULL)\r\n{\r\nNURONerr(NURON_F_NURON_INIT,NURON_R_ALREADY_LOADED);\r\nreturn 0;\r\n}\r\npvDSOHandle = DSO_load(NULL, get_NURON_LIBNAME(), NULL,\r\nDSO_FLAG_NAME_TRANSLATION_EXT_ONLY);\r\nif(!pvDSOHandle)\r\n{\r\nNURONerr(NURON_F_NURON_INIT,NURON_R_DSO_NOT_FOUND);\r\nreturn 0;\r\n}\r\npfnModExp = (tfnModExp *)DSO_bind_func(pvDSOHandle, NURON_F1);\r\nif(!pfnModExp)\r\n{\r\nNURONerr(NURON_F_NURON_INIT,NURON_R_DSO_FUNCTION_NOT_FOUND);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int nuron_finish(ENGINE *e)\r\n{\r\nfree_NURON_LIBNAME();\r\nif(pvDSOHandle == NULL)\r\n{\r\nNURONerr(NURON_F_NURON_FINISH,NURON_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(!DSO_free(pvDSOHandle))\r\n{\r\nNURONerr(NURON_F_NURON_FINISH,NURON_R_DSO_FAILURE);\r\nreturn 0;\r\n}\r\npvDSOHandle=NULL;\r\npfnModExp=NULL;\r\nreturn 1;\r\n}\r\nstatic int nuron_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f)(void))\r\n{\r\nint initialised = ((pvDSOHandle == NULL) ? 0 : 1);\r\nswitch(cmd)\r\n{\r\ncase NURON_CMD_SO_PATH:\r\nif(p == NULL)\r\n{\r\nNURONerr(NURON_F_NURON_CTRL,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif(initialised)\r\n{\r\nNURONerr(NURON_F_NURON_CTRL,NURON_R_ALREADY_LOADED);\r\nreturn 0;\r\n}\r\nreturn set_NURON_LIBNAME((const char *)p);\r\ndefault:\r\nbreak;\r\n}\r\nNURONerr(NURON_F_NURON_CTRL,NURON_R_CTRL_COMMAND_NOT_IMPLEMENTED);\r\nreturn 0;\r\n}\r\nstatic int nuron_mod_exp(BIGNUM *r,const BIGNUM *a,const BIGNUM *p,\r\nconst BIGNUM *m,BN_CTX *ctx)\r\n{\r\nif(!pvDSOHandle)\r\n{\r\nNURONerr(NURON_F_NURON_MOD_EXP,NURON_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nreturn pfnModExp(r,a,p,m);\r\n}\r\nstatic int nuron_rsa_mod_exp(BIGNUM *r0, const BIGNUM *I, RSA *rsa, BN_CTX *ctx)\r\n{\r\nreturn nuron_mod_exp(r0,I,rsa->d,rsa->n,ctx);\r\n}\r\nstatic int nuron_dsa_mod_exp(DSA *dsa, BIGNUM *rr, BIGNUM *a1,\r\nBIGNUM *p1, BIGNUM *a2, BIGNUM *p2, BIGNUM *m,\r\nBN_CTX *ctx, BN_MONT_CTX *in_mont)\r\n{\r\nBIGNUM t;\r\nint to_return = 0;\r\nBN_init(&t);\r\nif (!nuron_mod_exp(rr,a1,p1,m,ctx))\r\ngoto end;\r\nif (!nuron_mod_exp(&t,a2,p2,m,ctx))\r\ngoto end;\r\nif (!BN_mod_mul(rr,rr,&t,m,ctx))\r\ngoto end;\r\nto_return = 1;\r\nend:\r\nBN_free(&t);\r\nreturn to_return;\r\n}\r\nstatic int nuron_mod_exp_dsa(DSA *dsa, BIGNUM *r, BIGNUM *a,\r\nconst BIGNUM *p, const BIGNUM *m, BN_CTX *ctx,\r\nBN_MONT_CTX *m_ctx)\r\n{\r\nreturn nuron_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int nuron_mod_exp_mont(BIGNUM *r, const BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nreturn nuron_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int nuron_mod_exp_dh(const DH *dh, BIGNUM *r,\r\nconst BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nreturn nuron_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int bind_helper(ENGINE *e)\r\n{\r\n#ifndef OPENSSL_NO_RSA\r\nconst RSA_METHOD *meth1;\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\nconst DSA_METHOD *meth2;\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\nconst DH_METHOD *meth3;\r\n#endif\r\nif(!ENGINE_set_id(e, engine_nuron_id) ||\r\n!ENGINE_set_name(e, engine_nuron_name) ||\r\n#ifndef OPENSSL_NO_RSA\r\n!ENGINE_set_RSA(e, &nuron_rsa) ||\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\n!ENGINE_set_DSA(e, &nuron_dsa) ||\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\n!ENGINE_set_DH(e, &nuron_dh) ||\r\n#endif\r\n!ENGINE_set_destroy_function(e, nuron_destroy) ||\r\n!ENGINE_set_init_function(e, nuron_init) ||\r\n!ENGINE_set_finish_function(e, nuron_finish) ||\r\n!ENGINE_set_ctrl_function(e, nuron_ctrl) ||\r\n!ENGINE_set_cmd_defns(e, nuron_cmd_defns))\r\nreturn 0;\r\n#ifndef OPENSSL_NO_RSA\r\nmeth1=RSA_PKCS1_SSLeay();\r\nnuron_rsa.rsa_pub_enc=meth1->rsa_pub_enc;\r\nnuron_rsa.rsa_pub_dec=meth1->rsa_pub_dec;\r\nnuron_rsa.rsa_priv_enc=meth1->rsa_priv_enc;\r\nnuron_rsa.rsa_priv_dec=meth1->rsa_priv_dec;\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\nmeth2=DSA_OpenSSL();\r\nnuron_dsa.dsa_do_sign=meth2->dsa_do_sign;\r\nnuron_dsa.dsa_sign_setup=meth2->dsa_sign_setup;\r\nnuron_dsa.dsa_do_verify=meth2->dsa_do_verify;\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\nmeth3=DH_OpenSSL();\r\nnuron_dh.generate_key=meth3->generate_key;\r\nnuron_dh.compute_key=meth3->compute_key;\r\n#endif\r\nERR_load_NURON_strings();\r\nreturn 1;\r\n}\r\nstatic ENGINE *engine_nuron(void)\r\n{\r\nENGINE *ret = ENGINE_new();\r\nif(!ret)\r\nreturn NULL;\r\nif(!bind_helper(ret))\r\n{\r\nENGINE_free(ret);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nvoid ENGINE_load_nuron(void)\r\n{\r\nENGINE *toadd = engine_nuron();\r\nif(!toadd) return;\r\nENGINE_add(toadd);\r\nENGINE_free(toadd);\r\nERR_clear_error();\r\n}\r\nstatic int bind_fn(ENGINE *e, const char *id)\r\n{\r\nif(id && (strcmp(id, engine_nuron_id) != 0))\r\nreturn 0;\r\nif(!bind_helper(e))\r\nreturn 0;\r\nreturn 1;\r\n}

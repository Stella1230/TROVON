static int _asn1_check_infinite_end(const unsigned char **p, long len)\r\n{\r\nif (len <= 0)\r\nreturn(1);\r\nelse if ((len >= 2) && ((*p)[0] == 0) && ((*p)[1] == 0))\r\n{\r\n(*p)+=2;\r\nreturn(1);\r\n}\r\nreturn(0);\r\n}\r\nint ASN1_check_infinite_end(unsigned char **p, long len)\r\n{\r\nreturn _asn1_check_infinite_end((const unsigned char **)p, len);\r\n}\r\nint ASN1_const_check_infinite_end(const unsigned char **p, long len)\r\n{\r\nreturn _asn1_check_infinite_end(p, len);\r\n}\r\nint ASN1_get_object(const unsigned char **pp, long *plength, int *ptag,\r\nint *pclass, long omax)\r\n{\r\nint i,ret;\r\nlong l;\r\nconst unsigned char *p= *pp;\r\nint tag,xclass,inf;\r\nlong max=omax;\r\nif (!max) goto err;\r\nret=(*p&V_ASN1_CONSTRUCTED);\r\nxclass=(*p&V_ASN1_PRIVATE);\r\ni= *p&V_ASN1_PRIMITIVE_TAG;\r\nif (i == V_ASN1_PRIMITIVE_TAG)\r\n{\r\np++;\r\nif (--max == 0) goto err;\r\nl=0;\r\nwhile (*p&0x80)\r\n{\r\nl<<=7L;\r\nl|= *(p++)&0x7f;\r\nif (--max == 0) goto err;\r\nif (l > (INT_MAX >> 7L)) goto err;\r\n}\r\nl<<=7L;\r\nl|= *(p++)&0x7f;\r\ntag=(int)l;\r\nif (--max == 0) goto err;\r\n}\r\nelse\r\n{\r\ntag=i;\r\np++;\r\nif (--max == 0) goto err;\r\n}\r\n*ptag=tag;\r\n*pclass=xclass;\r\nif (!asn1_get_length(&p,&inf,plength,(int)max)) goto err;\r\n#if 0\r\nfprintf(stderr,"p=%d + *plength=%ld > omax=%ld + *pp=%d (%d > %d)\n",\r\n(int)p,*plength,omax,(int)*pp,(int)(p+ *plength),\r\n(int)(omax+ *pp));\r\n#endif\r\nif (*plength > (omax - (p - *pp)))\r\n{\r\nASN1err(ASN1_F_ASN1_GET_OBJECT,ASN1_R_TOO_LONG);\r\nret|=0x80;\r\n}\r\n*pp=p;\r\nreturn(ret|inf);\r\nerr:\r\nASN1err(ASN1_F_ASN1_GET_OBJECT,ASN1_R_HEADER_TOO_LONG);\r\nreturn(0x80);\r\n}\r\nstatic int asn1_get_length(const unsigned char **pp, int *inf, long *rl, int max)\r\n{\r\nconst unsigned char *p= *pp;\r\nunsigned long ret=0;\r\nunsigned int i;\r\nif (max-- < 1) return(0);\r\nif (*p == 0x80)\r\n{\r\n*inf=1;\r\nret=0;\r\np++;\r\n}\r\nelse\r\n{\r\n*inf=0;\r\ni= *p&0x7f;\r\nif (*(p++) & 0x80)\r\n{\r\nif (i > sizeof(long))\r\nreturn 0;\r\nif (max-- == 0) return(0);\r\nwhile (i-- > 0)\r\n{\r\nret<<=8L;\r\nret|= *(p++);\r\nif (max-- == 0) return(0);\r\n}\r\n}\r\nelse\r\nret=i;\r\n}\r\nif (ret > LONG_MAX)\r\nreturn 0;\r\n*pp=p;\r\n*rl=(long)ret;\r\nreturn(1);\r\n}\r\nvoid ASN1_put_object(unsigned char **pp, int constructed, int length, int tag,\r\nint xclass)\r\n{\r\nunsigned char *p= *pp;\r\nint i, ttag;\r\ni=(constructed)?V_ASN1_CONSTRUCTED:0;\r\ni|=(xclass&V_ASN1_PRIVATE);\r\nif (tag < 31)\r\n*(p++)=i|(tag&V_ASN1_PRIMITIVE_TAG);\r\nelse\r\n{\r\n*(p++)=i|V_ASN1_PRIMITIVE_TAG;\r\nfor(i = 0, ttag = tag; ttag > 0; i++) ttag >>=7;\r\nttag = i;\r\nwhile(i-- > 0)\r\n{\r\np[i] = tag & 0x7f;\r\nif(i != (ttag - 1)) p[i] |= 0x80;\r\ntag >>= 7;\r\n}\r\np += ttag;\r\n}\r\nif (constructed == 2)\r\n*(p++)=0x80;\r\nelse\r\nasn1_put_length(&p,length);\r\n*pp=p;\r\n}\r\nint ASN1_put_eoc(unsigned char **pp)\r\n{\r\nunsigned char *p = *pp;\r\n*p++ = 0;\r\n*p++ = 0;\r\n*pp = p;\r\nreturn 2;\r\n}\r\nstatic void asn1_put_length(unsigned char **pp, int length)\r\n{\r\nunsigned char *p= *pp;\r\nint i,l;\r\nif (length <= 127)\r\n*(p++)=(unsigned char)length;\r\nelse\r\n{\r\nl=length;\r\nfor (i=0; l > 0; i++)\r\nl>>=8;\r\n*(p++)=i|0x80;\r\nl=i;\r\nwhile (i-- > 0)\r\n{\r\np[i]=length&0xff;\r\nlength>>=8;\r\n}\r\np+=l;\r\n}\r\n*pp=p;\r\n}\r\nint ASN1_object_size(int constructed, int length, int tag)\r\n{\r\nint ret;\r\nret=length;\r\nret++;\r\nif (tag >= 31)\r\n{\r\nwhile (tag > 0)\r\n{\r\ntag>>=7;\r\nret++;\r\n}\r\n}\r\nif (constructed == 2)\r\nreturn ret + 3;\r\nret++;\r\nif (length > 127)\r\n{\r\nwhile (length > 0)\r\n{\r\nlength>>=8;\r\nret++;\r\n}\r\n}\r\nreturn(ret);\r\n}\r\nstatic int _asn1_Finish(ASN1_const_CTX *c)\r\n{\r\nif ((c->inf == (1|V_ASN1_CONSTRUCTED)) && (!c->eos))\r\n{\r\nif (!ASN1_const_check_infinite_end(&c->p,c->slen))\r\n{\r\nc->error=ERR_R_MISSING_ASN1_EOS;\r\nreturn(0);\r\n}\r\n}\r\nif ( ((c->slen != 0) && !(c->inf & 1)) ||\r\n((c->slen < 0) && (c->inf & 1)))\r\n{\r\nc->error=ERR_R_ASN1_LENGTH_MISMATCH;\r\nreturn(0);\r\n}\r\nreturn(1);\r\n}\r\nint asn1_Finish(ASN1_CTX *c)\r\n{\r\nreturn _asn1_Finish((ASN1_const_CTX *)c);\r\n}\r\nint asn1_const_Finish(ASN1_const_CTX *c)\r\n{\r\nreturn _asn1_Finish(c);\r\n}\r\nint asn1_GetSequence(ASN1_const_CTX *c, long *length)\r\n{\r\nconst unsigned char *q;\r\nq=c->p;\r\nc->inf=ASN1_get_object(&(c->p),&(c->slen),&(c->tag),&(c->xclass),\r\n*length);\r\nif (c->inf & 0x80)\r\n{\r\nc->error=ERR_R_BAD_GET_ASN1_OBJECT_CALL;\r\nreturn(0);\r\n}\r\nif (c->tag != V_ASN1_SEQUENCE)\r\n{\r\nc->error=ERR_R_EXPECTING_AN_ASN1_SEQUENCE;\r\nreturn(0);\r\n}\r\n(*length)-=(c->p-q);\r\nif (c->max && (*length < 0))\r\n{\r\nc->error=ERR_R_ASN1_LENGTH_MISMATCH;\r\nreturn(0);\r\n}\r\nif (c->inf == (1|V_ASN1_CONSTRUCTED))\r\nc->slen= *length+ *(c->pp)-c->p;\r\nc->eos=0;\r\nreturn(1);\r\n}\r\nint ASN1_STRING_copy(ASN1_STRING *dst, const ASN1_STRING *str)\r\n{\r\nif (str == NULL)\r\nreturn 0;\r\ndst->type = str->type;\r\nif (!ASN1_STRING_set(dst,str->data,str->length))\r\nreturn 0;\r\ndst->flags = str->flags;\r\nreturn 1;\r\n}\r\nASN1_STRING *ASN1_STRING_dup(const ASN1_STRING *str)\r\n{\r\nASN1_STRING *ret;\r\nif (!str)\r\nreturn NULL;\r\nret=ASN1_STRING_new();\r\nif (!ret)\r\nreturn NULL;\r\nif (!ASN1_STRING_copy(ret,str))\r\n{\r\nASN1_STRING_free(ret);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nint ASN1_STRING_set(ASN1_STRING *str, const void *_data, int len)\r\n{\r\nunsigned char *c;\r\nconst char *data=_data;\r\nif (len < 0)\r\n{\r\nif (data == NULL)\r\nreturn(0);\r\nelse\r\nlen=strlen(data);\r\n}\r\nif ((str->length < len) || (str->data == NULL))\r\n{\r\nc=str->data;\r\nif (c == NULL)\r\nstr->data=OPENSSL_malloc(len+1);\r\nelse\r\nstr->data=OPENSSL_realloc(c,len+1);\r\nif (str->data == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_STRING_SET,ERR_R_MALLOC_FAILURE);\r\nstr->data=c;\r\nreturn(0);\r\n}\r\n}\r\nstr->length=len;\r\nif (data != NULL)\r\n{\r\nmemcpy(str->data,data,len);\r\nstr->data[len]='\0';\r\n}\r\nreturn(1);\r\n}\r\nvoid ASN1_STRING_set0(ASN1_STRING *str, void *data, int len)\r\n{\r\nif (str->data)\r\nOPENSSL_free(str->data);\r\nstr->data = data;\r\nstr->length = len;\r\n}\r\nASN1_STRING *ASN1_STRING_new(void)\r\n{\r\nreturn(ASN1_STRING_type_new(V_ASN1_OCTET_STRING));\r\n}\r\nASN1_STRING *ASN1_STRING_type_new(int type)\r\n{\r\nASN1_STRING *ret;\r\nret=(ASN1_STRING *)OPENSSL_malloc(sizeof(ASN1_STRING));\r\nif (ret == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_STRING_TYPE_NEW,ERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nret->length=0;\r\nret->type=type;\r\nret->data=NULL;\r\nret->flags=0;\r\nreturn(ret);\r\n}\r\nvoid ASN1_STRING_free(ASN1_STRING *a)\r\n{\r\nif (a == NULL) return;\r\nif (a->data && !(a->flags & ASN1_STRING_FLAG_NDEF))\r\nOPENSSL_free(a->data);\r\nOPENSSL_free(a);\r\n}\r\nint ASN1_STRING_cmp(const ASN1_STRING *a, const ASN1_STRING *b)\r\n{\r\nint i;\r\ni=(a->length-b->length);\r\nif (i == 0)\r\n{\r\ni=memcmp(a->data,b->data,a->length);\r\nif (i == 0)\r\nreturn(a->type-b->type);\r\nelse\r\nreturn(i);\r\n}\r\nelse\r\nreturn(i);\r\n}\r\nvoid asn1_add_error(const unsigned char *address, int offset)\r\n{\r\nchar buf1[DECIMAL_SIZE(address)+1],buf2[DECIMAL_SIZE(offset)+1];\r\nBIO_snprintf(buf1,sizeof buf1,"%lu",(unsigned long)address);\r\nBIO_snprintf(buf2,sizeof buf2,"%d",offset);\r\nERR_add_error_data(4,"address=",buf1," offset=",buf2);\r\n}\r\nint ASN1_STRING_length(const ASN1_STRING *x)\r\n{ return M_ASN1_STRING_length(x); }\r\nvoid ASN1_STRING_length_set(ASN1_STRING *x, int len)\r\n{ M_ASN1_STRING_length_set(x, len); return; }\r\nint ASN1_STRING_type(ASN1_STRING *x)\r\n{ return M_ASN1_STRING_type(x); }\r\nunsigned char * ASN1_STRING_data(ASN1_STRING *x)\r\n{ return M_ASN1_STRING_data(x); }

int ASN1_UTCTIME_check(ASN1_UTCTIME *d)\r\n{\r\nstatic const int min[8]={ 0, 1, 1, 0, 0, 0, 0, 0};\r\nstatic const int max[8]={99,12,31,23,59,59,12,59};\r\nchar *a;\r\nint n,i,l,o;\r\nif (d->type != V_ASN1_UTCTIME) return(0);\r\nl=d->length;\r\na=(char *)d->data;\r\no=0;\r\nif (l < 11) goto err;\r\nfor (i=0; i<6; i++)\r\n{\r\nif ((i == 5) && ((a[o] == 'Z') ||\r\n(a[o] == '+') || (a[o] == '-')))\r\n{ i++; break; }\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn= a[o]-'0';\r\nif (++o > l) goto err;\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn=(n*10)+ a[o]-'0';\r\nif (++o > l) goto err;\r\nif ((n < min[i]) || (n > max[i])) goto err;\r\n}\r\nif (a[o] == 'Z')\r\no++;\r\nelse if ((a[o] == '+') || (a[o] == '-'))\r\n{\r\no++;\r\nif (o+4 > l) goto err;\r\nfor (i=6; i<8; i++)\r\n{\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn= a[o]-'0';\r\no++;\r\nif ((a[o] < '0') || (a[o] > '9')) goto err;\r\nn=(n*10)+ a[o]-'0';\r\nif ((n < min[i]) || (n > max[i])) goto err;\r\no++;\r\n}\r\n}\r\nreturn(o == l);\r\nerr:\r\nreturn(0);\r\n}\r\nint ASN1_UTCTIME_set_string(ASN1_UTCTIME *s, const char *str)\r\n{\r\nASN1_UTCTIME t;\r\nt.type=V_ASN1_UTCTIME;\r\nt.length=strlen(str);\r\nt.data=(unsigned char *)str;\r\nif (ASN1_UTCTIME_check(&t))\r\n{\r\nif (s != NULL)\r\n{\r\nif (!ASN1_STRING_set((ASN1_STRING *)s,\r\n(unsigned char *)str,t.length))\r\nreturn 0;\r\ns->type = V_ASN1_UTCTIME;\r\n}\r\nreturn(1);\r\n}\r\nelse\r\nreturn(0);\r\n}\r\nASN1_UTCTIME *ASN1_UTCTIME_set(ASN1_UTCTIME *s, time_t t)\r\n{\r\nreturn ASN1_UTCTIME_adj(s, t, 0, 0);\r\n}\r\nASN1_UTCTIME *ASN1_UTCTIME_adj(ASN1_UTCTIME *s, time_t t,\r\nint offset_day, long offset_sec)\r\n{\r\nchar *p;\r\nstruct tm *ts;\r\nstruct tm data;\r\nsize_t len = 20;\r\nif (s == NULL)\r\ns=M_ASN1_UTCTIME_new();\r\nif (s == NULL)\r\nreturn(NULL);\r\nts=OPENSSL_gmtime(&t, &data);\r\nif (ts == NULL)\r\nreturn(NULL);\r\nif (offset_day || offset_sec)\r\n{\r\nif (!OPENSSL_gmtime_adj(ts, offset_day, offset_sec))\r\nreturn NULL;\r\n}\r\nif((ts->tm_year < 50) || (ts->tm_year >= 150))\r\nreturn NULL;\r\np=(char *)s->data;\r\nif ((p == NULL) || ((size_t)s->length < len))\r\n{\r\np=OPENSSL_malloc(len);\r\nif (p == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_UTCTIME_ADJ,ERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nif (s->data != NULL)\r\nOPENSSL_free(s->data);\r\ns->data=(unsigned char *)p;\r\n}\r\nBIO_snprintf(p,len,"%02d%02d%02d%02d%02d%02dZ",ts->tm_year%100,\r\nts->tm_mon+1,ts->tm_mday,ts->tm_hour,ts->tm_min,ts->tm_sec);\r\ns->length=strlen(p);\r\ns->type=V_ASN1_UTCTIME;\r\n#ifdef CHARSET_EBCDIC_not\r\nebcdic2ascii(s->data, s->data, s->length);\r\n#endif\r\nreturn(s);\r\n}\r\nint ASN1_UTCTIME_cmp_time_t(const ASN1_UTCTIME *s, time_t t)\r\n{\r\nstruct tm *tm;\r\nstruct tm data;\r\nint offset;\r\nint year;\r\n#define g2(p) (((p)[0]-'0')*10+(p)[1]-'0')\r\nif (s->data[12] == 'Z')\r\noffset=0;\r\nelse\r\n{\r\noffset = g2(s->data+13)*60+g2(s->data+15);\r\nif (s->data[12] == '-')\r\noffset = -offset;\r\n}\r\nt -= offset*60;\r\ntm = OPENSSL_gmtime(&t, &data);\r\n#define return_cmp(a,b) if ((a)<(b)) return -1; else if ((a)>(b)) return 1\r\nyear = g2(s->data);\r\nif (year < 50)\r\nyear += 100;\r\nreturn_cmp(year, tm->tm_year);\r\nreturn_cmp(g2(s->data+2) - 1, tm->tm_mon);\r\nreturn_cmp(g2(s->data+4), tm->tm_mday);\r\nreturn_cmp(g2(s->data+6), tm->tm_hour);\r\nreturn_cmp(g2(s->data+8), tm->tm_min);\r\nreturn_cmp(g2(s->data+10), tm->tm_sec);\r\n#undef g2\r\n#undef return_cmp\r\nreturn 0;\r\n}

const char *LP_find_file(LP_DIR_CTX **ctx, const char *directory)\r\n{\r\nif (ctx == NULL || directory == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn 0;\r\n}\r\nerrno = 0;\r\nif (*ctx == NULL)\r\n{\r\n*ctx = (LP_DIR_CTX *)malloc(sizeof(LP_DIR_CTX));\r\nif (*ctx == NULL)\r\n{\r\nerrno = ENOMEM;\r\nreturn 0;\r\n}\r\nmemset(*ctx, '\0', sizeof(LP_DIR_CTX));\r\nif (sizeof(TCHAR) != sizeof(char))\r\n{\r\nTCHAR *wdir = NULL;\r\nsize_t index = 0,len_0 = strlen(directory) + 1;\r\nwdir = (TCHAR *)malloc(len_0 * sizeof(TCHAR));\r\nif (wdir == NULL)\r\n{\r\nfree(*ctx);\r\n*ctx = NULL;\r\nerrno = ENOMEM;\r\nreturn 0;\r\n}\r\n#ifdef LP_MULTIBYTE_AVAILABLE\r\nif (!MultiByteToWideChar(CP_ACP, 0, directory, len_0, (WCHAR *)wdir, len_0))\r\n#endif\r\nfor (index = 0; index < len_0; index++)\r\nwdir[index] = (TCHAR)directory[index];\r\n(*ctx)->handle = FindFirstFile(wdir, &(*ctx)->ctx);\r\nfree(wdir);\r\n}\r\nelse\r\n(*ctx)->handle = FindFirstFile((TCHAR *)directory, &(*ctx)->ctx);\r\nif ((*ctx)->handle == INVALID_HANDLE_VALUE)\r\n{\r\nfree(*ctx);\r\n*ctx = NULL;\r\nerrno = EINVAL;\r\nreturn 0;\r\n}\r\n}\r\nelse\r\n{\r\nif (FindNextFile((*ctx)->handle, &(*ctx)->ctx) == FALSE)\r\n{\r\nreturn 0;\r\n}\r\n}\r\nif (sizeof(TCHAR) != sizeof(char))\r\n{\r\nTCHAR *wdir = (*ctx)->ctx.cFileName;\r\nsize_t index, len_0 = 0;\r\nwhile (wdir[len_0] && len_0 < (sizeof((*ctx)->entry_name) - 1)) len_0++;\r\nlen_0++;\r\n#ifdef LP_MULTIBYTE_AVAILABLE\r\nif (!WideCharToMultiByte(CP_ACP, 0, (WCHAR *)wdir, len_0, (*ctx)->entry_name,\r\nsizeof((*ctx)->entry_name), NULL, 0))\r\n#endif\r\nfor (index = 0; index < len_0; index++)\r\n(*ctx)->entry_name[index] = (char)wdir[index];\r\n}\r\nelse\r\nstrncpy((*ctx)->entry_name, (const char *)(*ctx)->ctx.cFileName,\r\nsizeof((*ctx)->entry_name)-1);\r\n(*ctx)->entry_name[sizeof((*ctx)->entry_name)-1] = '\0';\r\nreturn (*ctx)->entry_name;\r\n}\r\nint LP_find_file_end(LP_DIR_CTX **ctx)\r\n{\r\nif (ctx != NULL && *ctx != NULL)\r\n{\r\nFindClose((*ctx)->handle);\r\nfree(*ctx);\r\n*ctx = NULL;\r\nreturn 1;\r\n}\r\nerrno = EINVAL;\r\nreturn 0;\r\n}

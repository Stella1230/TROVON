int ssl_add_clienthello_renegotiate_ext(SSL *s, unsigned char *p, int *len,\r\nint maxlen)\r\n{\r\nif(p)\r\n{\r\nif((s->s3->previous_client_finished_len+1) > maxlen)\r\n{\r\nSSLerr(SSL_F_SSL_ADD_CLIENTHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATE_EXT_TOO_LONG);\r\nreturn 0;\r\n}\r\n*p = s->s3->previous_client_finished_len;\r\np++;\r\nmemcpy(p, s->s3->previous_client_finished,\r\ns->s3->previous_client_finished_len);\r\n#ifdef OPENSSL_RI_DEBUG\r\nfprintf(stderr, "%s RI extension sent by client\n",\r\ns->s3->previous_client_finished_len ? "Non-empty" : "Empty");\r\n#endif\r\n}\r\n*len=s->s3->previous_client_finished_len + 1;\r\nreturn 1;\r\n}\r\nint ssl_parse_clienthello_renegotiate_ext(SSL *s, unsigned char *d, int len,\r\nint *al)\r\n{\r\nint ilen;\r\nif(len < 1)\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_CLIENTHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_ENCODING_ERR);\r\n*al=SSL_AD_ILLEGAL_PARAMETER;\r\nreturn 0;\r\n}\r\nilen = *d;\r\nd++;\r\nif((ilen+1) != len)\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_CLIENTHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_ENCODING_ERR);\r\n*al=SSL_AD_ILLEGAL_PARAMETER;\r\nreturn 0;\r\n}\r\nif(ilen != s->s3->previous_client_finished_len)\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_CLIENTHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_MISMATCH);\r\n*al=SSL_AD_HANDSHAKE_FAILURE;\r\nreturn 0;\r\n}\r\nif(memcmp(d, s->s3->previous_client_finished,\r\ns->s3->previous_client_finished_len))\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_CLIENTHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_MISMATCH);\r\n*al=SSL_AD_HANDSHAKE_FAILURE;\r\nreturn 0;\r\n}\r\n#ifdef OPENSSL_RI_DEBUG\r\nfprintf(stderr, "%s RI extension received by server\n",\r\nilen ? "Non-empty" : "Empty");\r\n#endif\r\ns->s3->send_connection_binding=1;\r\nreturn 1;\r\n}\r\nint ssl_add_serverhello_renegotiate_ext(SSL *s, unsigned char *p, int *len,\r\nint maxlen)\r\n{\r\nif(p)\r\n{\r\nif((s->s3->previous_client_finished_len +\r\ns->s3->previous_server_finished_len + 1) > maxlen)\r\n{\r\nSSLerr(SSL_F_SSL_ADD_SERVERHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATE_EXT_TOO_LONG);\r\nreturn 0;\r\n}\r\n*p = s->s3->previous_client_finished_len + s->s3->previous_server_finished_len;\r\np++;\r\nmemcpy(p, s->s3->previous_client_finished,\r\ns->s3->previous_client_finished_len);\r\np += s->s3->previous_client_finished_len;\r\nmemcpy(p, s->s3->previous_server_finished,\r\ns->s3->previous_server_finished_len);\r\n#ifdef OPENSSL_RI_DEBUG\r\nfprintf(stderr, "%s RI extension sent by server\n",\r\ns->s3->previous_client_finished_len ? "Non-empty" : "Empty");\r\n#endif\r\n}\r\n*len=s->s3->previous_client_finished_len\r\n+ s->s3->previous_server_finished_len + 1;\r\nreturn 1;\r\n}\r\nint ssl_parse_serverhello_renegotiate_ext(SSL *s, unsigned char *d, int len,\r\nint *al)\r\n{\r\nint expected_len=s->s3->previous_client_finished_len\r\n+ s->s3->previous_server_finished_len;\r\nint ilen;\r\nOPENSSL_assert(!expected_len || s->s3->previous_client_finished_len);\r\nOPENSSL_assert(!expected_len || s->s3->previous_server_finished_len);\r\nif(len < 1)\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_SERVERHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_ENCODING_ERR);\r\n*al=SSL_AD_ILLEGAL_PARAMETER;\r\nreturn 0;\r\n}\r\nilen = *d;\r\nd++;\r\nif(ilen+1 != len)\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_SERVERHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_ENCODING_ERR);\r\n*al=SSL_AD_ILLEGAL_PARAMETER;\r\nreturn 0;\r\n}\r\nif(ilen != expected_len)\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_SERVERHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_MISMATCH);\r\n*al=SSL_AD_HANDSHAKE_FAILURE;\r\nreturn 0;\r\n}\r\nif(memcmp(d, s->s3->previous_client_finished,\r\ns->s3->previous_client_finished_len))\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_SERVERHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_MISMATCH);\r\n*al=SSL_AD_HANDSHAKE_FAILURE;\r\nreturn 0;\r\n}\r\nd += s->s3->previous_client_finished_len;\r\nif(memcmp(d, s->s3->previous_server_finished,\r\ns->s3->previous_server_finished_len))\r\n{\r\nSSLerr(SSL_F_SSL_PARSE_SERVERHELLO_RENEGOTIATE_EXT,SSL_R_RENEGOTIATION_MISMATCH);\r\n*al=SSL_AD_ILLEGAL_PARAMETER;\r\nreturn 0;\r\n}\r\n#ifdef OPENSSL_RI_DEBUG\r\nfprintf(stderr, "%s RI extension received by client\n",\r\nilen ? "Non-empty" : "Empty");\r\n#endif\r\ns->s3->send_connection_binding=1;\r\nreturn 1;\r\n}

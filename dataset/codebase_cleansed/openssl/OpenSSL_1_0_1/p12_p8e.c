X509_SIG *PKCS8_encrypt(int pbe_nid, const EVP_CIPHER *cipher,\r\nconst char *pass, int passlen,\r\nunsigned char *salt, int saltlen, int iter,\r\nPKCS8_PRIV_KEY_INFO *p8inf)\r\n{\r\nX509_SIG *p8 = NULL;\r\nX509_ALGOR *pbe;\r\nif (!(p8 = X509_SIG_new())) {\r\nPKCS12err(PKCS12_F_PKCS8_ENCRYPT, ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif(pbe_nid == -1) pbe = PKCS5_pbe2_set(cipher, iter, salt, saltlen);\r\nelse pbe = PKCS5_pbe_set(pbe_nid, iter, salt, saltlen);\r\nif(!pbe) {\r\nPKCS12err(PKCS12_F_PKCS8_ENCRYPT, ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nX509_ALGOR_free(p8->algor);\r\np8->algor = pbe;\r\nM_ASN1_OCTET_STRING_free(p8->digest);\r\np8->digest = PKCS12_item_i2d_encrypt(pbe, ASN1_ITEM_rptr(PKCS8_PRIV_KEY_INFO),\r\npass, passlen, p8inf, 1);\r\nif(!p8->digest) {\r\nPKCS12err(PKCS12_F_PKCS8_ENCRYPT, PKCS12_R_ENCRYPT_ERROR);\r\ngoto err;\r\n}\r\nreturn p8;\r\nerr:\r\nX509_SIG_free(p8);\r\nreturn NULL;\r\n}

X509_REQ *X509_to_X509_REQ(X509 *x, EVP_PKEY *pkey, const EVP_MD *md)\r\n{\r\nX509_REQ *ret;\r\nX509_REQ_INFO *ri;\r\nint i;\r\nEVP_PKEY *pktmp;\r\nret=X509_REQ_new();\r\nif (ret == NULL)\r\n{\r\nX509err(X509_F_X509_TO_X509_REQ,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nri=ret->req_info;\r\nri->version->length=1;\r\nri->version->data=(unsigned char *)OPENSSL_malloc(1);\r\nif (ri->version->data == NULL) goto err;\r\nri->version->data[0]=0;\r\nif (!X509_REQ_set_subject_name(ret,X509_get_subject_name(x)))\r\ngoto err;\r\npktmp = X509_get_pubkey(x);\r\ni=X509_REQ_set_pubkey(ret,pktmp);\r\nEVP_PKEY_free(pktmp);\r\nif (!i) goto err;\r\nif (pkey != NULL)\r\n{\r\nif (!X509_REQ_sign(ret,pkey,md))\r\ngoto err;\r\n}\r\nreturn(ret);\r\nerr:\r\nX509_REQ_free(ret);\r\nreturn(NULL);\r\n}\r\nEVP_PKEY *X509_REQ_get_pubkey(X509_REQ *req)\r\n{\r\nif ((req == NULL) || (req->req_info == NULL))\r\nreturn(NULL);\r\nreturn(X509_PUBKEY_get(req->req_info->pubkey));\r\n}\r\nint X509_REQ_check_private_key(X509_REQ *x, EVP_PKEY *k)\r\n{\r\nEVP_PKEY *xk=NULL;\r\nint ok=0;\r\nxk=X509_REQ_get_pubkey(x);\r\nswitch (EVP_PKEY_cmp(xk, k))\r\n{\r\ncase 1:\r\nok=1;\r\nbreak;\r\ncase 0:\r\nX509err(X509_F_X509_REQ_CHECK_PRIVATE_KEY,X509_R_KEY_VALUES_MISMATCH);\r\nbreak;\r\ncase -1:\r\nX509err(X509_F_X509_REQ_CHECK_PRIVATE_KEY,X509_R_KEY_TYPE_MISMATCH);\r\nbreak;\r\ncase -2:\r\n#ifndef OPENSSL_NO_EC\r\nif (k->type == EVP_PKEY_EC)\r\n{\r\nX509err(X509_F_X509_REQ_CHECK_PRIVATE_KEY, ERR_R_EC_LIB);\r\nbreak;\r\n}\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\nif (k->type == EVP_PKEY_DH)\r\n{\r\nX509err(X509_F_X509_REQ_CHECK_PRIVATE_KEY,X509_R_CANT_CHECK_DH_KEY);\r\nbreak;\r\n}\r\n#endif\r\nX509err(X509_F_X509_REQ_CHECK_PRIVATE_KEY,X509_R_UNKNOWN_KEY_TYPE);\r\n}\r\nEVP_PKEY_free(xk);\r\nreturn(ok);\r\n}\r\nint X509_REQ_extension_nid(int req_nid)\r\n{\r\nint i, nid;\r\nfor(i = 0; ; i++) {\r\nnid = ext_nids[i];\r\nif(nid == NID_undef) return 0;\r\nelse if (req_nid == nid) return 1;\r\n}\r\n}\r\nint *X509_REQ_get_extension_nids(void)\r\n{\r\nreturn ext_nids;\r\n}\r\nvoid X509_REQ_set_extension_nids(int *nids)\r\n{\r\next_nids = nids;\r\n}\r\nint X509_REQ_get_attr_count(const X509_REQ *req)\r\n{\r\nreturn X509at_get_attr_count(req->req_info->attributes);\r\n}\r\nint X509_REQ_get_attr_by_NID(const X509_REQ *req, int nid,\r\nint lastpos)\r\n{\r\nreturn X509at_get_attr_by_NID(req->req_info->attributes, nid, lastpos);\r\n}\r\nint X509_REQ_get_attr_by_OBJ(const X509_REQ *req, ASN1_OBJECT *obj,\r\nint lastpos)\r\n{\r\nreturn X509at_get_attr_by_OBJ(req->req_info->attributes, obj, lastpos);\r\n}\r\nX509_ATTRIBUTE *X509_REQ_get_attr(const X509_REQ *req, int loc)\r\n{\r\nreturn X509at_get_attr(req->req_info->attributes, loc);\r\n}\r\nX509_ATTRIBUTE *X509_REQ_delete_attr(X509_REQ *req, int loc)\r\n{\r\nreturn X509at_delete_attr(req->req_info->attributes, loc);\r\n}\r\nint X509_REQ_add1_attr(X509_REQ *req, X509_ATTRIBUTE *attr)\r\n{\r\nif(X509at_add1_attr(&req->req_info->attributes, attr)) return 1;\r\nreturn 0;\r\n}\r\nint X509_REQ_add1_attr_by_OBJ(X509_REQ *req,\r\nconst ASN1_OBJECT *obj, int type,\r\nconst unsigned char *bytes, int len)\r\n{\r\nif(X509at_add1_attr_by_OBJ(&req->req_info->attributes, obj,\r\ntype, bytes, len)) return 1;\r\nreturn 0;\r\n}\r\nint X509_REQ_add1_attr_by_NID(X509_REQ *req,\r\nint nid, int type,\r\nconst unsigned char *bytes, int len)\r\n{\r\nif(X509at_add1_attr_by_NID(&req->req_info->attributes, nid,\r\ntype, bytes, len)) return 1;\r\nreturn 0;\r\n}\r\nint X509_REQ_add1_attr_by_txt(X509_REQ *req,\r\nconst char *attrname, int type,\r\nconst unsigned char *bytes, int len)\r\n{\r\nif(X509at_add1_attr_by_txt(&req->req_info->attributes, attrname,\r\ntype, bytes, len)) return 1;\r\nreturn 0;\r\n}

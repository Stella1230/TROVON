static int policy_cache_create(X509 *x,\r\nCERTIFICATEPOLICIES *policies, int crit)\r\n{\r\nint i;\r\nint ret = 0;\r\nX509_POLICY_CACHE *cache = x->policy_cache;\r\nX509_POLICY_DATA *data = NULL;\r\nPOLICYINFO *policy;\r\nif (sk_POLICYINFO_num(policies) == 0)\r\ngoto bad_policy;\r\ncache->data = sk_X509_POLICY_DATA_new(policy_data_cmp);\r\nif (!cache->data)\r\ngoto bad_policy;\r\nfor (i = 0; i < sk_POLICYINFO_num(policies); i++)\r\n{\r\npolicy = sk_POLICYINFO_value(policies, i);\r\ndata = policy_data_new(policy, NULL, crit);\r\nif (!data)\r\ngoto bad_policy;\r\nif (OBJ_obj2nid(data->valid_policy) == NID_any_policy)\r\n{\r\nif (cache->anyPolicy)\r\n{\r\nret = -1;\r\ngoto bad_policy;\r\n}\r\ncache->anyPolicy = data;\r\n}\r\nelse if (sk_X509_POLICY_DATA_find(cache->data, data) != -1)\r\n{\r\nret = -1;\r\ngoto bad_policy;\r\n}\r\nelse if (!sk_X509_POLICY_DATA_push(cache->data, data))\r\ngoto bad_policy;\r\ndata = NULL;\r\n}\r\nret = 1;\r\nbad_policy:\r\nif (ret == -1)\r\nx->ex_flags |= EXFLAG_INVALID_POLICY;\r\nif (data)\r\npolicy_data_free(data);\r\nsk_POLICYINFO_pop_free(policies, POLICYINFO_free);\r\nif (ret <= 0)\r\n{\r\nsk_X509_POLICY_DATA_pop_free(cache->data, policy_data_free);\r\ncache->data = NULL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int policy_cache_new(X509 *x)\r\n{\r\nX509_POLICY_CACHE *cache;\r\nASN1_INTEGER *ext_any = NULL;\r\nPOLICY_CONSTRAINTS *ext_pcons = NULL;\r\nCERTIFICATEPOLICIES *ext_cpols = NULL;\r\nPOLICY_MAPPINGS *ext_pmaps = NULL;\r\nint i;\r\ncache = OPENSSL_malloc(sizeof(X509_POLICY_CACHE));\r\nif (!cache)\r\nreturn 0;\r\ncache->anyPolicy = NULL;\r\ncache->data = NULL;\r\ncache->any_skip = -1;\r\ncache->explicit_skip = -1;\r\ncache->map_skip = -1;\r\nx->policy_cache = cache;\r\next_pcons = X509_get_ext_d2i(x, NID_policy_constraints, &i, NULL);\r\nif (!ext_pcons)\r\n{\r\nif (i != -1)\r\ngoto bad_cache;\r\n}\r\nelse\r\n{\r\nif (!ext_pcons->requireExplicitPolicy\r\n&& !ext_pcons->inhibitPolicyMapping)\r\ngoto bad_cache;\r\nif (!policy_cache_set_int(&cache->explicit_skip,\r\next_pcons->requireExplicitPolicy))\r\ngoto bad_cache;\r\nif (!policy_cache_set_int(&cache->map_skip,\r\next_pcons->inhibitPolicyMapping))\r\ngoto bad_cache;\r\n}\r\next_cpols = X509_get_ext_d2i(x, NID_certificate_policies, &i, NULL);\r\nif (!ext_cpols)\r\n{\r\nif (i != -1)\r\ngoto bad_cache;\r\nreturn 1;\r\n}\r\ni = policy_cache_create(x, ext_cpols, i);\r\nif (i <= 0)\r\nreturn i;\r\next_pmaps = X509_get_ext_d2i(x, NID_policy_mappings, &i, NULL);\r\nif (!ext_pmaps)\r\n{\r\nif (i != -1)\r\ngoto bad_cache;\r\n}\r\nelse\r\n{\r\ni = policy_cache_set_mapping(x, ext_pmaps);\r\nif (i <= 0)\r\ngoto bad_cache;\r\n}\r\next_any = X509_get_ext_d2i(x, NID_inhibit_any_policy, &i, NULL);\r\nif (!ext_any)\r\n{\r\nif (i != -1)\r\ngoto bad_cache;\r\n}\r\nelse if (!policy_cache_set_int(&cache->any_skip, ext_any))\r\ngoto bad_cache;\r\nif (0)\r\n{\r\nbad_cache:\r\nx->ex_flags |= EXFLAG_INVALID_POLICY;\r\n}\r\nif(ext_pcons)\r\nPOLICY_CONSTRAINTS_free(ext_pcons);\r\nif (ext_any)\r\nASN1_INTEGER_free(ext_any);\r\nreturn 1;\r\n}\r\nvoid policy_cache_free(X509_POLICY_CACHE *cache)\r\n{\r\nif (!cache)\r\nreturn;\r\nif (cache->anyPolicy)\r\npolicy_data_free(cache->anyPolicy);\r\nif (cache->data)\r\nsk_X509_POLICY_DATA_pop_free(cache->data, policy_data_free);\r\nOPENSSL_free(cache);\r\n}\r\nconst X509_POLICY_CACHE *policy_cache_set(X509 *x)\r\n{\r\nif (x->policy_cache == NULL)\r\n{\r\nCRYPTO_w_lock(CRYPTO_LOCK_X509);\r\npolicy_cache_new(x);\r\nCRYPTO_w_unlock(CRYPTO_LOCK_X509);\r\n}\r\nreturn x->policy_cache;\r\n}\r\nX509_POLICY_DATA *policy_cache_find_data(const X509_POLICY_CACHE *cache,\r\nconst ASN1_OBJECT *id)\r\n{\r\nint idx;\r\nX509_POLICY_DATA tmp;\r\ntmp.valid_policy = (ASN1_OBJECT *)id;\r\nidx = sk_X509_POLICY_DATA_find(cache->data, &tmp);\r\nif (idx == -1)\r\nreturn NULL;\r\nreturn sk_X509_POLICY_DATA_value(cache->data, idx);\r\n}\r\nstatic int policy_data_cmp(const X509_POLICY_DATA * const *a,\r\nconst X509_POLICY_DATA * const *b)\r\n{\r\nreturn OBJ_cmp((*a)->valid_policy, (*b)->valid_policy);\r\n}\r\nstatic int policy_cache_set_int(long *out, ASN1_INTEGER *value)\r\n{\r\nif (value == NULL)\r\nreturn 1;\r\nif (value->type == V_ASN1_NEG_INTEGER)\r\nreturn 0;\r\n*out = ASN1_INTEGER_get(value);\r\nreturn 1;\r\n}

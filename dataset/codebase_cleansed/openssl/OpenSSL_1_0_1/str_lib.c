STORE *STORE_new_method(const STORE_METHOD *method)\r\n{\r\nSTORE *ret;\r\nif (method == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_NEW_METHOD,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nret=(STORE *)OPENSSL_malloc(sizeof(STORE));\r\nif (ret == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_NEW_METHOD,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nret->meth=method;\r\nCRYPTO_new_ex_data(CRYPTO_EX_INDEX_STORE, ret, &ret->ex_data);\r\nif (ret->meth->init && !ret->meth->init(ret))\r\n{\r\nSTORE_free(ret);\r\nret = NULL;\r\n}\r\nreturn ret;\r\n}\r\nSTORE *STORE_new_engine(ENGINE *engine)\r\n{\r\nSTORE *ret = NULL;\r\nENGINE *e = engine;\r\nconst STORE_METHOD *meth = 0;\r\n#ifdef OPENSSL_NO_ENGINE\r\ne = NULL;\r\n#else\r\nif (engine)\r\n{\r\nif (!ENGINE_init(engine))\r\n{\r\nSTOREerr(STORE_F_STORE_NEW_ENGINE, ERR_R_ENGINE_LIB);\r\nreturn NULL;\r\n}\r\ne = engine;\r\n}\r\nelse\r\n{\r\nSTOREerr(STORE_F_STORE_NEW_ENGINE,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nif(e)\r\n{\r\nmeth = ENGINE_get_STORE(e);\r\nif(!meth)\r\n{\r\nSTOREerr(STORE_F_STORE_NEW_ENGINE,\r\nERR_R_ENGINE_LIB);\r\nENGINE_finish(e);\r\nreturn NULL;\r\n}\r\n}\r\n#endif\r\nret = STORE_new_method(meth);\r\nif (ret == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_NEW_ENGINE,ERR_R_STORE_LIB);\r\nreturn NULL;\r\n}\r\nret->engine = e;\r\nreturn(ret);\r\n}\r\nvoid STORE_free(STORE *store)\r\n{\r\nif (store == NULL)\r\nreturn;\r\nif (store->meth->clean)\r\nstore->meth->clean(store);\r\nCRYPTO_free_ex_data(CRYPTO_EX_INDEX_STORE, store, &store->ex_data);\r\nOPENSSL_free(store);\r\n}\r\nint STORE_ctrl(STORE *store, int cmd, long i, void *p, void (*f)(void))\r\n{\r\nif (store == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_CTRL,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (store->meth->ctrl)\r\nreturn store->meth->ctrl(store, cmd, i, p, f);\r\nSTOREerr(STORE_F_STORE_CTRL,STORE_R_NO_CONTROL_FUNCTION);\r\nreturn 0;\r\n}\r\nint STORE_get_ex_new_index(long argl, void *argp, CRYPTO_EX_new *new_func,\r\nCRYPTO_EX_dup *dup_func, CRYPTO_EX_free *free_func)\r\n{\r\nreturn CRYPTO_get_ex_new_index(CRYPTO_EX_INDEX_STORE, argl, argp,\r\nnew_func, dup_func, free_func);\r\n}\r\nint STORE_set_ex_data(STORE *r, int idx, void *arg)\r\n{\r\nreturn(CRYPTO_set_ex_data(&r->ex_data,idx,arg));\r\n}\r\nvoid *STORE_get_ex_data(STORE *r, int idx)\r\n{\r\nreturn(CRYPTO_get_ex_data(&r->ex_data,idx));\r\n}\r\nconst STORE_METHOD *STORE_get_method(STORE *store)\r\n{\r\nreturn store->meth;\r\n}\r\nconst STORE_METHOD *STORE_set_method(STORE *store, const STORE_METHOD *meth)\r\n{\r\nstore->meth=meth;\r\nreturn store->meth;\r\n}\r\nX509 *STORE_get_certificate(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nX509 *x;\r\ncheck_store(s,STORE_F_STORE_GET_CERTIFICATE,\r\nget_object,STORE_R_NO_GET_OBJECT_FUNCTION);\r\nobject = s->meth->get_object(s, STORE_OBJECT_TYPE_X509_CERTIFICATE,\r\nattributes, parameters);\r\nif (!object || !object->data.x509.certificate)\r\n{\r\nSTOREerr(STORE_F_STORE_GET_CERTIFICATE,\r\nSTORE_R_FAILED_GETTING_CERTIFICATE);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.x509.certificate->references,1,CRYPTO_LOCK_X509);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509",data);\r\n#endif\r\nx = object->data.x509.certificate;\r\nSTORE_OBJECT_free(object);\r\nreturn x;\r\n}\r\nint STORE_store_certificate(STORE *s, X509 *data, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nint i;\r\ncheck_store(s,STORE_F_STORE_CERTIFICATE,\r\nstore_object,STORE_R_NO_STORE_OBJECT_FUNCTION);\r\nobject = STORE_OBJECT_new();\r\nif (!object)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_CERTIFICATE,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&data->references,1,CRYPTO_LOCK_X509);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509",data);\r\n#endif\r\nobject->data.x509.certificate = data;\r\ni = s->meth->store_object(s, STORE_OBJECT_TYPE_X509_CERTIFICATE,\r\nobject, attributes, parameters);\r\nSTORE_OBJECT_free(object);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_CERTIFICATE,\r\nSTORE_R_FAILED_STORING_CERTIFICATE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_modify_certificate(STORE *s, OPENSSL_ITEM search_attributes[],\r\nOPENSSL_ITEM add_attributes[], OPENSSL_ITEM modify_attributes[],\r\nOPENSSL_ITEM delete_attributes[], OPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_MODIFY_CERTIFICATE,\r\nmodify_object,STORE_R_NO_MODIFY_OBJECT_FUNCTION);\r\nif (!s->meth->modify_object(s, STORE_OBJECT_TYPE_X509_CERTIFICATE,\r\nsearch_attributes, add_attributes, modify_attributes,\r\ndelete_attributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_MODIFY_CERTIFICATE,\r\nSTORE_R_FAILED_MODIFYING_CERTIFICATE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_revoke_certificate(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_REVOKE_CERTIFICATE,\r\nrevoke_object,STORE_R_NO_REVOKE_OBJECT_FUNCTION);\r\nif (!s->meth->revoke_object(s, STORE_OBJECT_TYPE_X509_CERTIFICATE,\r\nattributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_REVOKE_CERTIFICATE,\r\nSTORE_R_FAILED_REVOKING_CERTIFICATE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_delete_certificate(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_DELETE_CERTIFICATE,\r\ndelete_object,STORE_R_NO_DELETE_OBJECT_FUNCTION);\r\nif (!s->meth->delete_object(s, STORE_OBJECT_TYPE_X509_CERTIFICATE,\r\nattributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_DELETE_CERTIFICATE,\r\nSTORE_R_FAILED_DELETING_CERTIFICATE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nvoid *STORE_list_certificate_start(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nvoid *handle;\r\ncheck_store(s,STORE_F_STORE_LIST_CERTIFICATE_START,\r\nlist_object_start,STORE_R_NO_LIST_OBJECT_START_FUNCTION);\r\nhandle = s->meth->list_object_start(s,\r\nSTORE_OBJECT_TYPE_X509_CERTIFICATE, attributes, parameters);\r\nif (!handle)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CERTIFICATE_START,\r\nSTORE_R_FAILED_LISTING_CERTIFICATES);\r\nreturn 0;\r\n}\r\nreturn handle;\r\n}\r\nX509 *STORE_list_certificate_next(STORE *s, void *handle)\r\n{\r\nSTORE_OBJECT *object;\r\nX509 *x;\r\ncheck_store(s,STORE_F_STORE_LIST_CERTIFICATE_NEXT,\r\nlist_object_next,STORE_R_NO_LIST_OBJECT_NEXT_FUNCTION);\r\nobject = s->meth->list_object_next(s, handle);\r\nif (!object || !object->data.x509.certificate)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CERTIFICATE_NEXT,\r\nSTORE_R_FAILED_LISTING_CERTIFICATES);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.x509.certificate->references,1,CRYPTO_LOCK_X509);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509",data);\r\n#endif\r\nx = object->data.x509.certificate;\r\nSTORE_OBJECT_free(object);\r\nreturn x;\r\n}\r\nint STORE_list_certificate_end(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_CERTIFICATE_END,\r\nlist_object_end,STORE_R_NO_LIST_OBJECT_END_FUNCTION);\r\nif (!s->meth->list_object_end(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CERTIFICATE_END,\r\nSTORE_R_FAILED_LISTING_CERTIFICATES);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_list_certificate_endp(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_CERTIFICATE_ENDP,\r\nlist_object_endp,STORE_R_NO_LIST_OBJECT_ENDP_FUNCTION);\r\nif (!s->meth->list_object_endp(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CERTIFICATE_ENDP,\r\nSTORE_R_FAILED_LISTING_CERTIFICATES);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nEVP_PKEY *STORE_generate_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nEVP_PKEY *pkey;\r\ncheck_store(s,STORE_F_STORE_GENERATE_KEY,\r\ngenerate_object,STORE_R_NO_GENERATE_OBJECT_FUNCTION);\r\nobject = s->meth->generate_object(s, STORE_OBJECT_TYPE_PRIVATE_KEY,\r\nattributes, parameters);\r\nif (!object || !object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_GENERATE_KEY,\r\nSTORE_R_FAILED_GENERATING_KEY);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.key->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\npkey = object->data.key;\r\nSTORE_OBJECT_free(object);\r\nreturn pkey;\r\n}\r\nEVP_PKEY *STORE_get_private_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nEVP_PKEY *pkey;\r\ncheck_store(s,STORE_F_STORE_GET_PRIVATE_KEY,\r\nget_object,STORE_R_NO_GET_OBJECT_FUNCTION);\r\nobject = s->meth->get_object(s, STORE_OBJECT_TYPE_PRIVATE_KEY,\r\nattributes, parameters);\r\nif (!object || !object->data.key || !object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_GET_PRIVATE_KEY,\r\nSTORE_R_FAILED_GETTING_KEY);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.key->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\npkey = object->data.key;\r\nSTORE_OBJECT_free(object);\r\nreturn pkey;\r\n}\r\nint STORE_store_private_key(STORE *s, EVP_PKEY *data, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nint i;\r\ncheck_store(s,STORE_F_STORE_STORE_PRIVATE_KEY,\r\nstore_object,STORE_R_NO_STORE_OBJECT_FUNCTION);\r\nobject = STORE_OBJECT_new();\r\nif (!object)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_PRIVATE_KEY,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nobject->data.key = EVP_PKEY_new();\r\nif (!object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_PRIVATE_KEY,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&data->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\nobject->data.key = data;\r\ni = s->meth->store_object(s, STORE_OBJECT_TYPE_PRIVATE_KEY, object,\r\nattributes, parameters);\r\nSTORE_OBJECT_free(object);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_PRIVATE_KEY,\r\nSTORE_R_FAILED_STORING_KEY);\r\nreturn 0;\r\n}\r\nreturn i;\r\n}\r\nint STORE_modify_private_key(STORE *s, OPENSSL_ITEM search_attributes[],\r\nOPENSSL_ITEM add_attributes[], OPENSSL_ITEM modify_attributes[],\r\nOPENSSL_ITEM delete_attributes[], OPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_MODIFY_PRIVATE_KEY,\r\nmodify_object,STORE_R_NO_MODIFY_OBJECT_FUNCTION);\r\nif (!s->meth->modify_object(s, STORE_OBJECT_TYPE_PRIVATE_KEY,\r\nsearch_attributes, add_attributes, modify_attributes,\r\ndelete_attributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_MODIFY_PRIVATE_KEY,\r\nSTORE_R_FAILED_MODIFYING_PRIVATE_KEY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_revoke_private_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nint i;\r\ncheck_store(s,STORE_F_STORE_REVOKE_PRIVATE_KEY,\r\nrevoke_object,STORE_R_NO_REVOKE_OBJECT_FUNCTION);\r\ni = s->meth->revoke_object(s, STORE_OBJECT_TYPE_PRIVATE_KEY,\r\nattributes, parameters);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_REVOKE_PRIVATE_KEY,\r\nSTORE_R_FAILED_REVOKING_KEY);\r\nreturn 0;\r\n}\r\nreturn i;\r\n}\r\nint STORE_delete_private_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_DELETE_PRIVATE_KEY,\r\ndelete_object,STORE_R_NO_DELETE_OBJECT_FUNCTION);\r\nif (!s->meth->delete_object(s, STORE_OBJECT_TYPE_PRIVATE_KEY,\r\nattributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_DELETE_PRIVATE_KEY,\r\nSTORE_R_FAILED_DELETING_KEY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nvoid *STORE_list_private_key_start(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nvoid *handle;\r\ncheck_store(s,STORE_F_STORE_LIST_PRIVATE_KEY_START,\r\nlist_object_start,STORE_R_NO_LIST_OBJECT_START_FUNCTION);\r\nhandle = s->meth->list_object_start(s, STORE_OBJECT_TYPE_PRIVATE_KEY,\r\nattributes, parameters);\r\nif (!handle)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PRIVATE_KEY_START,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn handle;\r\n}\r\nEVP_PKEY *STORE_list_private_key_next(STORE *s, void *handle)\r\n{\r\nSTORE_OBJECT *object;\r\nEVP_PKEY *pkey;\r\ncheck_store(s,STORE_F_STORE_LIST_PRIVATE_KEY_NEXT,\r\nlist_object_next,STORE_R_NO_LIST_OBJECT_NEXT_FUNCTION);\r\nobject = s->meth->list_object_next(s, handle);\r\nif (!object || !object->data.key || !object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PRIVATE_KEY_NEXT,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.key->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\npkey = object->data.key;\r\nSTORE_OBJECT_free(object);\r\nreturn pkey;\r\n}\r\nint STORE_list_private_key_end(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_PRIVATE_KEY_END,\r\nlist_object_end,STORE_R_NO_LIST_OBJECT_END_FUNCTION);\r\nif (!s->meth->list_object_end(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PRIVATE_KEY_END,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_list_private_key_endp(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_PRIVATE_KEY_ENDP,\r\nlist_object_endp,STORE_R_NO_LIST_OBJECT_ENDP_FUNCTION);\r\nif (!s->meth->list_object_endp(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PRIVATE_KEY_ENDP,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nEVP_PKEY *STORE_get_public_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nEVP_PKEY *pkey;\r\ncheck_store(s,STORE_F_STORE_GET_PUBLIC_KEY,\r\nget_object,STORE_R_NO_GET_OBJECT_FUNCTION);\r\nobject = s->meth->get_object(s, STORE_OBJECT_TYPE_PUBLIC_KEY,\r\nattributes, parameters);\r\nif (!object || !object->data.key || !object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_GET_PUBLIC_KEY,\r\nSTORE_R_FAILED_GETTING_KEY);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.key->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\npkey = object->data.key;\r\nSTORE_OBJECT_free(object);\r\nreturn pkey;\r\n}\r\nint STORE_store_public_key(STORE *s, EVP_PKEY *data, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nint i;\r\ncheck_store(s,STORE_F_STORE_STORE_PUBLIC_KEY,\r\nstore_object,STORE_R_NO_STORE_OBJECT_FUNCTION);\r\nobject = STORE_OBJECT_new();\r\nif (!object)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_PUBLIC_KEY,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nobject->data.key = EVP_PKEY_new();\r\nif (!object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_PUBLIC_KEY,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&data->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\nobject->data.key = data;\r\ni = s->meth->store_object(s, STORE_OBJECT_TYPE_PUBLIC_KEY, object,\r\nattributes, parameters);\r\nSTORE_OBJECT_free(object);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_PUBLIC_KEY,\r\nSTORE_R_FAILED_STORING_KEY);\r\nreturn 0;\r\n}\r\nreturn i;\r\n}\r\nint STORE_modify_public_key(STORE *s, OPENSSL_ITEM search_attributes[],\r\nOPENSSL_ITEM add_attributes[], OPENSSL_ITEM modify_attributes[],\r\nOPENSSL_ITEM delete_attributes[], OPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_MODIFY_PUBLIC_KEY,\r\nmodify_object,STORE_R_NO_MODIFY_OBJECT_FUNCTION);\r\nif (!s->meth->modify_object(s, STORE_OBJECT_TYPE_PUBLIC_KEY,\r\nsearch_attributes, add_attributes, modify_attributes,\r\ndelete_attributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_MODIFY_PUBLIC_KEY,\r\nSTORE_R_FAILED_MODIFYING_PUBLIC_KEY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_revoke_public_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nint i;\r\ncheck_store(s,STORE_F_STORE_REVOKE_PUBLIC_KEY,\r\nrevoke_object,STORE_R_NO_REVOKE_OBJECT_FUNCTION);\r\ni = s->meth->revoke_object(s, STORE_OBJECT_TYPE_PUBLIC_KEY,\r\nattributes, parameters);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_REVOKE_PUBLIC_KEY,\r\nSTORE_R_FAILED_REVOKING_KEY);\r\nreturn 0;\r\n}\r\nreturn i;\r\n}\r\nint STORE_delete_public_key(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_DELETE_PUBLIC_KEY,\r\ndelete_object,STORE_R_NO_DELETE_OBJECT_FUNCTION);\r\nif (!s->meth->delete_object(s, STORE_OBJECT_TYPE_PUBLIC_KEY,\r\nattributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_DELETE_PUBLIC_KEY,\r\nSTORE_R_FAILED_DELETING_KEY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nvoid *STORE_list_public_key_start(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nvoid *handle;\r\ncheck_store(s,STORE_F_STORE_LIST_PUBLIC_KEY_START,\r\nlist_object_start,STORE_R_NO_LIST_OBJECT_START_FUNCTION);\r\nhandle = s->meth->list_object_start(s, STORE_OBJECT_TYPE_PUBLIC_KEY,\r\nattributes, parameters);\r\nif (!handle)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PUBLIC_KEY_START,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn handle;\r\n}\r\nEVP_PKEY *STORE_list_public_key_next(STORE *s, void *handle)\r\n{\r\nSTORE_OBJECT *object;\r\nEVP_PKEY *pkey;\r\ncheck_store(s,STORE_F_STORE_LIST_PUBLIC_KEY_NEXT,\r\nlist_object_next,STORE_R_NO_LIST_OBJECT_NEXT_FUNCTION);\r\nobject = s->meth->list_object_next(s, handle);\r\nif (!object || !object->data.key || !object->data.key)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PUBLIC_KEY_NEXT,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.key->references,1,CRYPTO_LOCK_EVP_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("EVP_PKEY",data);\r\n#endif\r\npkey = object->data.key;\r\nSTORE_OBJECT_free(object);\r\nreturn pkey;\r\n}\r\nint STORE_list_public_key_end(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_PUBLIC_KEY_END,\r\nlist_object_end,STORE_R_NO_LIST_OBJECT_END_FUNCTION);\r\nif (!s->meth->list_object_end(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PUBLIC_KEY_END,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_list_public_key_endp(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_PUBLIC_KEY_ENDP,\r\nlist_object_endp,STORE_R_NO_LIST_OBJECT_ENDP_FUNCTION);\r\nif (!s->meth->list_object_endp(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_PUBLIC_KEY_ENDP,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nX509_CRL *STORE_generate_crl(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nX509_CRL *crl;\r\ncheck_store(s,STORE_F_STORE_GENERATE_CRL,\r\ngenerate_object,STORE_R_NO_GENERATE_CRL_FUNCTION);\r\nobject = s->meth->generate_object(s, STORE_OBJECT_TYPE_X509_CRL,\r\nattributes, parameters);\r\nif (!object || !object->data.crl)\r\n{\r\nSTOREerr(STORE_F_STORE_GENERATE_CRL,\r\nSTORE_R_FAILED_GENERATING_CRL);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.crl->references,1,CRYPTO_LOCK_X509_CRL);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_CRL",data);\r\n#endif\r\ncrl = object->data.crl;\r\nSTORE_OBJECT_free(object);\r\nreturn crl;\r\n}\r\nX509_CRL *STORE_get_crl(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nX509_CRL *crl;\r\ncheck_store(s,STORE_F_STORE_GET_CRL,\r\nget_object,STORE_R_NO_GET_OBJECT_FUNCTION);\r\nobject = s->meth->get_object(s, STORE_OBJECT_TYPE_X509_CRL,\r\nattributes, parameters);\r\nif (!object || !object->data.crl)\r\n{\r\nSTOREerr(STORE_F_STORE_GET_CRL,\r\nSTORE_R_FAILED_GETTING_KEY);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.crl->references,1,CRYPTO_LOCK_X509_CRL);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_CRL",data);\r\n#endif\r\ncrl = object->data.crl;\r\nSTORE_OBJECT_free(object);\r\nreturn crl;\r\n}\r\nint STORE_store_crl(STORE *s, X509_CRL *data, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nint i;\r\ncheck_store(s,STORE_F_STORE_STORE_CRL,\r\nstore_object,STORE_R_NO_STORE_OBJECT_FUNCTION);\r\nobject = STORE_OBJECT_new();\r\nif (!object)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_CRL,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&data->references,1,CRYPTO_LOCK_X509_CRL);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_CRL",data);\r\n#endif\r\nobject->data.crl = data;\r\ni = s->meth->store_object(s, STORE_OBJECT_TYPE_X509_CRL, object,\r\nattributes, parameters);\r\nSTORE_OBJECT_free(object);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_CRL,\r\nSTORE_R_FAILED_STORING_KEY);\r\nreturn 0;\r\n}\r\nreturn i;\r\n}\r\nint STORE_modify_crl(STORE *s, OPENSSL_ITEM search_attributes[],\r\nOPENSSL_ITEM add_attributes[], OPENSSL_ITEM modify_attributes[],\r\nOPENSSL_ITEM delete_attributes[], OPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_MODIFY_CRL,\r\nmodify_object,STORE_R_NO_MODIFY_OBJECT_FUNCTION);\r\nif (!s->meth->modify_object(s, STORE_OBJECT_TYPE_X509_CRL,\r\nsearch_attributes, add_attributes, modify_attributes,\r\ndelete_attributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_MODIFY_CRL,\r\nSTORE_R_FAILED_MODIFYING_CRL);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_delete_crl(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_DELETE_CRL,\r\ndelete_object,STORE_R_NO_DELETE_OBJECT_FUNCTION);\r\nif (!s->meth->delete_object(s, STORE_OBJECT_TYPE_X509_CRL,\r\nattributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_DELETE_CRL,\r\nSTORE_R_FAILED_DELETING_KEY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nvoid *STORE_list_crl_start(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nvoid *handle;\r\ncheck_store(s,STORE_F_STORE_LIST_CRL_START,\r\nlist_object_start,STORE_R_NO_LIST_OBJECT_START_FUNCTION);\r\nhandle = s->meth->list_object_start(s, STORE_OBJECT_TYPE_X509_CRL,\r\nattributes, parameters);\r\nif (!handle)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CRL_START,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn handle;\r\n}\r\nX509_CRL *STORE_list_crl_next(STORE *s, void *handle)\r\n{\r\nSTORE_OBJECT *object;\r\nX509_CRL *crl;\r\ncheck_store(s,STORE_F_STORE_LIST_CRL_NEXT,\r\nlist_object_next,STORE_R_NO_LIST_OBJECT_NEXT_FUNCTION);\r\nobject = s->meth->list_object_next(s, handle);\r\nif (!object || !object->data.crl)\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CRL_NEXT,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nCRYPTO_add(&object->data.crl->references,1,CRYPTO_LOCK_X509_CRL);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_CRL",data);\r\n#endif\r\ncrl = object->data.crl;\r\nSTORE_OBJECT_free(object);\r\nreturn crl;\r\n}\r\nint STORE_list_crl_end(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_CRL_END,\r\nlist_object_end,STORE_R_NO_LIST_OBJECT_END_FUNCTION);\r\nif (!s->meth->list_object_end(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CRL_END,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_list_crl_endp(STORE *s, void *handle)\r\n{\r\ncheck_store(s,STORE_F_STORE_LIST_CRL_ENDP,\r\nlist_object_endp,STORE_R_NO_LIST_OBJECT_ENDP_FUNCTION);\r\nif (!s->meth->list_object_endp(s, handle))\r\n{\r\nSTOREerr(STORE_F_STORE_LIST_CRL_ENDP,\r\nSTORE_R_FAILED_LISTING_KEYS);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_store_number(STORE *s, BIGNUM *data, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nint i;\r\ncheck_store(s,STORE_F_STORE_STORE_NUMBER,\r\nstore_object,STORE_R_NO_STORE_OBJECT_NUMBER_FUNCTION);\r\nobject = STORE_OBJECT_new();\r\nif (!object)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_NUMBER,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nobject->data.number = data;\r\ni = s->meth->store_object(s, STORE_OBJECT_TYPE_NUMBER, object,\r\nattributes, parameters);\r\nSTORE_OBJECT_free(object);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_NUMBER,\r\nSTORE_R_FAILED_STORING_NUMBER);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_modify_number(STORE *s, OPENSSL_ITEM search_attributes[],\r\nOPENSSL_ITEM add_attributes[], OPENSSL_ITEM modify_attributes[],\r\nOPENSSL_ITEM delete_attributes[], OPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_MODIFY_NUMBER,\r\nmodify_object,STORE_R_NO_MODIFY_OBJECT_FUNCTION);\r\nif (!s->meth->modify_object(s, STORE_OBJECT_TYPE_NUMBER,\r\nsearch_attributes, add_attributes, modify_attributes,\r\ndelete_attributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_MODIFY_NUMBER,\r\nSTORE_R_FAILED_MODIFYING_NUMBER);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nBIGNUM *STORE_get_number(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nBIGNUM *n;\r\ncheck_store(s,STORE_F_STORE_GET_NUMBER,\r\nget_object,STORE_R_NO_GET_OBJECT_NUMBER_FUNCTION);\r\nobject = s->meth->get_object(s, STORE_OBJECT_TYPE_NUMBER, attributes,\r\nparameters);\r\nif (!object || !object->data.number)\r\n{\r\nSTOREerr(STORE_F_STORE_GET_NUMBER,\r\nSTORE_R_FAILED_GETTING_NUMBER);\r\nreturn 0;\r\n}\r\nn = object->data.number;\r\nobject->data.number = NULL;\r\nSTORE_OBJECT_free(object);\r\nreturn n;\r\n}\r\nint STORE_delete_number(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_DELETE_NUMBER,\r\ndelete_object,STORE_R_NO_DELETE_NUMBER_FUNCTION);\r\nif (!s->meth->delete_object(s, STORE_OBJECT_TYPE_NUMBER, attributes,\r\nparameters))\r\n{\r\nSTOREerr(STORE_F_STORE_DELETE_NUMBER,\r\nSTORE_R_FAILED_DELETING_NUMBER);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_store_arbitrary(STORE *s, BUF_MEM *data, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nint i;\r\ncheck_store(s,STORE_F_STORE_STORE_ARBITRARY,\r\nstore_object,STORE_R_NO_STORE_OBJECT_ARBITRARY_FUNCTION);\r\nobject = STORE_OBJECT_new();\r\nif (!object)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_ARBITRARY,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nobject->data.arbitrary = data;\r\ni = s->meth->store_object(s, STORE_OBJECT_TYPE_ARBITRARY, object,\r\nattributes, parameters);\r\nSTORE_OBJECT_free(object);\r\nif (!i)\r\n{\r\nSTOREerr(STORE_F_STORE_STORE_ARBITRARY,\r\nSTORE_R_FAILED_STORING_ARBITRARY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_modify_arbitrary(STORE *s, OPENSSL_ITEM search_attributes[],\r\nOPENSSL_ITEM add_attributes[], OPENSSL_ITEM modify_attributes[],\r\nOPENSSL_ITEM delete_attributes[], OPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_MODIFY_ARBITRARY,\r\nmodify_object,STORE_R_NO_MODIFY_OBJECT_FUNCTION);\r\nif (!s->meth->modify_object(s, STORE_OBJECT_TYPE_ARBITRARY,\r\nsearch_attributes, add_attributes, modify_attributes,\r\ndelete_attributes, parameters))\r\n{\r\nSTOREerr(STORE_F_STORE_MODIFY_ARBITRARY,\r\nSTORE_R_FAILED_MODIFYING_ARBITRARY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nBUF_MEM *STORE_get_arbitrary(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\nSTORE_OBJECT *object;\r\nBUF_MEM *b;\r\ncheck_store(s,STORE_F_STORE_GET_ARBITRARY,\r\nget_object,STORE_R_NO_GET_OBJECT_ARBITRARY_FUNCTION);\r\nobject = s->meth->get_object(s, STORE_OBJECT_TYPE_ARBITRARY,\r\nattributes, parameters);\r\nif (!object || !object->data.arbitrary)\r\n{\r\nSTOREerr(STORE_F_STORE_GET_ARBITRARY,\r\nSTORE_R_FAILED_GETTING_ARBITRARY);\r\nreturn 0;\r\n}\r\nb = object->data.arbitrary;\r\nobject->data.arbitrary = NULL;\r\nSTORE_OBJECT_free(object);\r\nreturn b;\r\n}\r\nint STORE_delete_arbitrary(STORE *s, OPENSSL_ITEM attributes[],\r\nOPENSSL_ITEM parameters[])\r\n{\r\ncheck_store(s,STORE_F_STORE_DELETE_ARBITRARY,\r\ndelete_object,STORE_R_NO_DELETE_ARBITRARY_FUNCTION);\r\nif (!s->meth->delete_object(s, STORE_OBJECT_TYPE_ARBITRARY, attributes,\r\nparameters))\r\n{\r\nSTOREerr(STORE_F_STORE_DELETE_ARBITRARY,\r\nSTORE_R_FAILED_DELETING_ARBITRARY);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nSTORE_OBJECT *STORE_OBJECT_new(void)\r\n{\r\nSTORE_OBJECT *object = OPENSSL_malloc(sizeof(STORE_OBJECT));\r\nif (object) memset(object, 0, sizeof(STORE_OBJECT));\r\nreturn object;\r\n}\r\nvoid STORE_OBJECT_free(STORE_OBJECT *data)\r\n{\r\nif (!data) return;\r\nswitch (data->type)\r\n{\r\ncase STORE_OBJECT_TYPE_X509_CERTIFICATE:\r\nX509_free(data->data.x509.certificate);\r\nbreak;\r\ncase STORE_OBJECT_TYPE_X509_CRL:\r\nX509_CRL_free(data->data.crl);\r\nbreak;\r\ncase STORE_OBJECT_TYPE_PRIVATE_KEY:\r\ncase STORE_OBJECT_TYPE_PUBLIC_KEY:\r\nEVP_PKEY_free(data->data.key);\r\nbreak;\r\ncase STORE_OBJECT_TYPE_NUMBER:\r\nBN_free(data->data.number);\r\nbreak;\r\ncase STORE_OBJECT_TYPE_ARBITRARY:\r\nBUF_MEM_free(data->data.arbitrary);\r\nbreak;\r\n}\r\nOPENSSL_free(data);\r\n}\r\nSTORE_ATTR_INFO *STORE_ATTR_INFO_new(void)\r\n{\r\nreturn (STORE_ATTR_INFO *)OPENSSL_malloc(sizeof(STORE_ATTR_INFO));\r\n}\r\nstatic void STORE_ATTR_INFO_attr_free(STORE_ATTR_INFO *attrs,\r\nSTORE_ATTR_TYPES code)\r\n{\r\nif (ATTR_IS_SET(attrs,code))\r\n{\r\nswitch(code)\r\n{\r\ncase STORE_ATTR_FRIENDLYNAME:\r\ncase STORE_ATTR_EMAIL:\r\ncase STORE_ATTR_FILENAME:\r\nSTORE_ATTR_INFO_modify_cstr(attrs, code, NULL, 0);\r\nbreak;\r\ncase STORE_ATTR_KEYID:\r\ncase STORE_ATTR_ISSUERKEYID:\r\ncase STORE_ATTR_SUBJECTKEYID:\r\ncase STORE_ATTR_ISSUERSERIALHASH:\r\ncase STORE_ATTR_CERTHASH:\r\nSTORE_ATTR_INFO_modify_sha1str(attrs, code, NULL, 0);\r\nbreak;\r\ncase STORE_ATTR_ISSUER:\r\ncase STORE_ATTR_SUBJECT:\r\nSTORE_ATTR_INFO_modify_dn(attrs, code, NULL);\r\nbreak;\r\ncase STORE_ATTR_SERIAL:\r\nSTORE_ATTR_INFO_modify_number(attrs, code, NULL);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nint STORE_ATTR_INFO_free(STORE_ATTR_INFO *attrs)\r\n{\r\nif (attrs)\r\n{\r\nSTORE_ATTR_TYPES i;\r\nfor(i = 0; i++ < STORE_ATTR_TYPE_NUM;)\r\nSTORE_ATTR_INFO_attr_free(attrs, i);\r\nOPENSSL_free(attrs);\r\n}\r\nreturn 1;\r\n}\r\nchar *STORE_ATTR_INFO_get0_cstr(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_CSTR,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\nreturn attrs->values[code].cstring;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_CSTR,\r\nSTORE_R_NO_VALUE);\r\nreturn NULL;\r\n}\r\nunsigned char *STORE_ATTR_INFO_get0_sha1str(STORE_ATTR_INFO *attrs,\r\nSTORE_ATTR_TYPES code)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_SHA1STR,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\nreturn attrs->values[code].sha1string;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_SHA1STR,\r\nSTORE_R_NO_VALUE);\r\nreturn NULL;\r\n}\r\nX509_NAME *STORE_ATTR_INFO_get0_dn(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_DN,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\nreturn attrs->values[code].dn;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_DN,\r\nSTORE_R_NO_VALUE);\r\nreturn NULL;\r\n}\r\nBIGNUM *STORE_ATTR_INFO_get0_number(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_NUMBER,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\nreturn attrs->values[code].number;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_GET0_NUMBER,\r\nSTORE_R_NO_VALUE);\r\nreturn NULL;\r\n}\r\nint STORE_ATTR_INFO_set_cstr(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nchar *cstr, size_t cstr_size)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_CSTR,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (!ATTR_IS_SET(attrs,code))\r\n{\r\nif ((attrs->values[code].cstring = BUF_strndup(cstr, cstr_size)))\r\nreturn 1;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_CSTR,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_CSTR, STORE_R_ALREADY_HAS_A_VALUE);\r\nreturn 0;\r\n}\r\nint STORE_ATTR_INFO_set_sha1str(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nunsigned char *sha1str, size_t sha1str_size)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_SHA1STR,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (!ATTR_IS_SET(attrs,code))\r\n{\r\nif ((attrs->values[code].sha1string =\r\n(unsigned char *)BUF_memdup(sha1str,\r\nsha1str_size)))\r\nreturn 1;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_SHA1STR,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_SHA1STR, STORE_R_ALREADY_HAS_A_VALUE);\r\nreturn 0;\r\n}\r\nint STORE_ATTR_INFO_set_dn(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nX509_NAME *dn)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_DN,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (!ATTR_IS_SET(attrs,code))\r\n{\r\nif ((attrs->values[code].dn = X509_NAME_dup(dn)))\r\nreturn 1;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_DN,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_DN, STORE_R_ALREADY_HAS_A_VALUE);\r\nreturn 0;\r\n}\r\nint STORE_ATTR_INFO_set_number(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nBIGNUM *number)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_NUMBER,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (!ATTR_IS_SET(attrs,code))\r\n{\r\nif ((attrs->values[code].number = BN_dup(number)))\r\nreturn 1;\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_NUMBER,\r\nERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_SET_NUMBER, STORE_R_ALREADY_HAS_A_VALUE);\r\nreturn 0;\r\n}\r\nint STORE_ATTR_INFO_modify_cstr(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nchar *cstr, size_t cstr_size)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_MODIFY_CSTR,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\n{\r\nOPENSSL_free(attrs->values[code].cstring);\r\nattrs->values[code].cstring = NULL;\r\nCLEAR_ATTRBIT(attrs, code);\r\n}\r\nreturn STORE_ATTR_INFO_set_cstr(attrs, code, cstr, cstr_size);\r\n}\r\nint STORE_ATTR_INFO_modify_sha1str(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nunsigned char *sha1str, size_t sha1str_size)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_MODIFY_SHA1STR,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\n{\r\nOPENSSL_free(attrs->values[code].sha1string);\r\nattrs->values[code].sha1string = NULL;\r\nCLEAR_ATTRBIT(attrs, code);\r\n}\r\nreturn STORE_ATTR_INFO_set_sha1str(attrs, code, sha1str, sha1str_size);\r\n}\r\nint STORE_ATTR_INFO_modify_dn(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nX509_NAME *dn)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_MODIFY_DN,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\n{\r\nOPENSSL_free(attrs->values[code].dn);\r\nattrs->values[code].dn = NULL;\r\nCLEAR_ATTRBIT(attrs, code);\r\n}\r\nreturn STORE_ATTR_INFO_set_dn(attrs, code, dn);\r\n}\r\nint STORE_ATTR_INFO_modify_number(STORE_ATTR_INFO *attrs, STORE_ATTR_TYPES code,\r\nBIGNUM *number)\r\n{\r\nif (!attrs)\r\n{\r\nSTOREerr(STORE_F_STORE_ATTR_INFO_MODIFY_NUMBER,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif (ATTR_IS_SET(attrs,code))\r\n{\r\nOPENSSL_free(attrs->values[code].number);\r\nattrs->values[code].number = NULL;\r\nCLEAR_ATTRBIT(attrs, code);\r\n}\r\nreturn STORE_ATTR_INFO_set_number(attrs, code, number);\r\n}\r\nvoid *STORE_parse_attrs_start(OPENSSL_ITEM *attributes)\r\n{\r\nif (attributes)\r\n{\r\nstruct attr_list_ctx_st *context =\r\n(struct attr_list_ctx_st *)OPENSSL_malloc(sizeof(struct attr_list_ctx_st));\r\nif (context)\r\ncontext->attributes = attributes;\r\nelse\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_START,\r\nERR_R_MALLOC_FAILURE);\r\nreturn context;\r\n}\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_START, ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nSTORE_ATTR_INFO *STORE_parse_attrs_next(void *handle)\r\n{\r\nstruct attr_list_ctx_st *context = (struct attr_list_ctx_st *)handle;\r\nif (context && context->attributes)\r\n{\r\nSTORE_ATTR_INFO *attrs = NULL;\r\nwhile(context->attributes\r\n&& context->attributes->code != STORE_ATTR_OR\r\n&& context->attributes->code != STORE_ATTR_END)\r\n{\r\nswitch(context->attributes->code)\r\n{\r\ncase STORE_ATTR_FRIENDLYNAME:\r\ncase STORE_ATTR_EMAIL:\r\ncase STORE_ATTR_FILENAME:\r\nif (!attrs) attrs = STORE_ATTR_INFO_new();\r\nif (attrs == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_NEXT,\r\nERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nSTORE_ATTR_INFO_set_cstr(attrs,\r\ncontext->attributes->code,\r\ncontext->attributes->value,\r\ncontext->attributes->value_size);\r\nbreak;\r\ncase STORE_ATTR_KEYID:\r\ncase STORE_ATTR_ISSUERKEYID:\r\ncase STORE_ATTR_SUBJECTKEYID:\r\ncase STORE_ATTR_ISSUERSERIALHASH:\r\ncase STORE_ATTR_CERTHASH:\r\nif (!attrs) attrs = STORE_ATTR_INFO_new();\r\nif (attrs == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_NEXT,\r\nERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nSTORE_ATTR_INFO_set_sha1str(attrs,\r\ncontext->attributes->code,\r\ncontext->attributes->value,\r\ncontext->attributes->value_size);\r\nbreak;\r\ncase STORE_ATTR_ISSUER:\r\ncase STORE_ATTR_SUBJECT:\r\nif (!attrs) attrs = STORE_ATTR_INFO_new();\r\nif (attrs == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_NEXT,\r\nERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nSTORE_ATTR_INFO_modify_dn(attrs,\r\ncontext->attributes->code,\r\ncontext->attributes->value);\r\nbreak;\r\ncase STORE_ATTR_SERIAL:\r\nif (!attrs) attrs = STORE_ATTR_INFO_new();\r\nif (attrs == NULL)\r\n{\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_NEXT,\r\nERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nSTORE_ATTR_INFO_modify_number(attrs,\r\ncontext->attributes->code,\r\ncontext->attributes->value);\r\nbreak;\r\n}\r\ncontext->attributes++;\r\n}\r\nif (context->attributes->code == STORE_ATTR_OR)\r\ncontext->attributes++;\r\nreturn attrs;\r\nerr:\r\nwhile(context->attributes\r\n&& context->attributes->code != STORE_ATTR_OR\r\n&& context->attributes->code != STORE_ATTR_END)\r\ncontext->attributes++;\r\nif (context->attributes->code == STORE_ATTR_OR)\r\ncontext->attributes++;\r\nreturn NULL;\r\n}\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_NEXT, ERR_R_PASSED_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nint STORE_parse_attrs_end(void *handle)\r\n{\r\nstruct attr_list_ctx_st *context = (struct attr_list_ctx_st *)handle;\r\nif (context && context->attributes)\r\n{\r\n#if 0\r\nOPENSSL_ITEM *attributes = context->attributes;\r\n#endif\r\nOPENSSL_free(context);\r\nreturn 1;\r\n}\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_END, ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nint STORE_parse_attrs_endp(void *handle)\r\n{\r\nstruct attr_list_ctx_st *context = (struct attr_list_ctx_st *)handle;\r\nif (context && context->attributes)\r\n{\r\nreturn context->attributes->code == STORE_ATTR_END;\r\n}\r\nSTOREerr(STORE_F_STORE_PARSE_ATTRS_ENDP, ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nstatic int attr_info_compare_compute_range(\r\nconst unsigned char *abits, const unsigned char *bbits,\r\nunsigned int *alowp, unsigned int *ahighp,\r\nunsigned int *blowp, unsigned int *bhighp)\r\n{\r\nunsigned int alow = (unsigned int)-1, ahigh = 0;\r\nunsigned int blow = (unsigned int)-1, bhigh = 0;\r\nint i, res = 0;\r\nfor (i = 0; i < (STORE_ATTR_TYPE_NUM + 8) / 8; i++, abits++, bbits++)\r\n{\r\nif (res == 0)\r\n{\r\nif (*abits < *bbits) res = -1;\r\nif (*abits > *bbits) res = 1;\r\n}\r\nif (*abits)\r\n{\r\nif (alow == (unsigned int)-1)\r\n{\r\nalow = i * 8;\r\nif (!(*abits & 0x01)) alow++;\r\nif (!(*abits & 0x02)) alow++;\r\nif (!(*abits & 0x04)) alow++;\r\nif (!(*abits & 0x08)) alow++;\r\nif (!(*abits & 0x10)) alow++;\r\nif (!(*abits & 0x20)) alow++;\r\nif (!(*abits & 0x40)) alow++;\r\n}\r\nahigh = i * 8 + 7;\r\nif (!(*abits & 0x80)) ahigh++;\r\nif (!(*abits & 0x40)) ahigh++;\r\nif (!(*abits & 0x20)) ahigh++;\r\nif (!(*abits & 0x10)) ahigh++;\r\nif (!(*abits & 0x08)) ahigh++;\r\nif (!(*abits & 0x04)) ahigh++;\r\nif (!(*abits & 0x02)) ahigh++;\r\n}\r\nif (*bbits)\r\n{\r\nif (blow == (unsigned int)-1)\r\n{\r\nblow = i * 8;\r\nif (!(*bbits & 0x01)) blow++;\r\nif (!(*bbits & 0x02)) blow++;\r\nif (!(*bbits & 0x04)) blow++;\r\nif (!(*bbits & 0x08)) blow++;\r\nif (!(*bbits & 0x10)) blow++;\r\nif (!(*bbits & 0x20)) blow++;\r\nif (!(*bbits & 0x40)) blow++;\r\n}\r\nbhigh = i * 8 + 7;\r\nif (!(*bbits & 0x80)) bhigh++;\r\nif (!(*bbits & 0x40)) bhigh++;\r\nif (!(*bbits & 0x20)) bhigh++;\r\nif (!(*bbits & 0x10)) bhigh++;\r\nif (!(*bbits & 0x08)) bhigh++;\r\nif (!(*bbits & 0x04)) bhigh++;\r\nif (!(*bbits & 0x02)) bhigh++;\r\n}\r\n}\r\nif (ahigh + alow < bhigh + blow) res = -1;\r\nif (ahigh + alow > bhigh + blow) res = 1;\r\nif (alowp) *alowp = alow;\r\nif (ahighp) *ahighp = ahigh;\r\nif (blowp) *blowp = blow;\r\nif (bhighp) *bhighp = bhigh;\r\nreturn res;\r\n}\r\nint STORE_ATTR_INFO_compare(const STORE_ATTR_INFO * const *a,\r\nconst STORE_ATTR_INFO * const *b)\r\n{\r\nif (a == b) return 0;\r\nif (!a) return -1;\r\nif (!b) return 1;\r\nreturn attr_info_compare_compute_range((*a)->set, (*b)->set, 0, 0, 0, 0);\r\n}\r\nint STORE_ATTR_INFO_in_range(STORE_ATTR_INFO *a, STORE_ATTR_INFO *b)\r\n{\r\nunsigned int alow, ahigh, blow, bhigh;\r\nif (a == b) return 1;\r\nif (!a) return 0;\r\nif (!b) return 0;\r\nattr_info_compare_compute_range(a->set, b->set,\r\n&alow, &ahigh, &blow, &bhigh);\r\nif (alow >= blow && ahigh <= bhigh)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint STORE_ATTR_INFO_in(STORE_ATTR_INFO *a, STORE_ATTR_INFO *b)\r\n{\r\nunsigned char *abits, *bbits;\r\nint i;\r\nif (a == b) return 1;\r\nif (!a) return 0;\r\nif (!b) return 0;\r\nabits = a->set;\r\nbbits = b->set;\r\nfor (i = 0; i < (STORE_ATTR_TYPE_NUM + 8) / 8; i++, abits++, bbits++)\r\n{\r\nif (*abits && (*bbits & *abits) != *abits)\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint STORE_ATTR_INFO_in_ex(STORE_ATTR_INFO *a, STORE_ATTR_INFO *b)\r\n{\r\nSTORE_ATTR_TYPES i;\r\nif (a == b) return 1;\r\nif (!STORE_ATTR_INFO_in(a, b)) return 0;\r\nfor (i = 1; i < STORE_ATTR_TYPE_NUM; i++)\r\nif (ATTR_IS_SET(a, i))\r\n{\r\nswitch(i)\r\n{\r\ncase STORE_ATTR_FRIENDLYNAME:\r\ncase STORE_ATTR_EMAIL:\r\ncase STORE_ATTR_FILENAME:\r\nif (strcmp(a->values[i].cstring,\r\nb->values[i].cstring))\r\nreturn 0;\r\nbreak;\r\ncase STORE_ATTR_KEYID:\r\ncase STORE_ATTR_ISSUERKEYID:\r\ncase STORE_ATTR_SUBJECTKEYID:\r\ncase STORE_ATTR_ISSUERSERIALHASH:\r\ncase STORE_ATTR_CERTHASH:\r\nif (memcmp(a->values[i].sha1string,\r\nb->values[i].sha1string,\r\na->value_sizes[i]))\r\nreturn 0;\r\nbreak;\r\ncase STORE_ATTR_ISSUER:\r\ncase STORE_ATTR_SUBJECT:\r\nif (X509_NAME_cmp(a->values[i].dn,\r\nb->values[i].dn))\r\nreturn 0;\r\nbreak;\r\ncase STORE_ATTR_SERIAL:\r\nif (BN_cmp(a->values[i].number,\r\nb->values[i].number))\r\nreturn 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn 1;\r\n}

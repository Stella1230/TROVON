int X509V3_EXT_print(BIO *out, X509_EXTENSION *ext, unsigned long flag, int indent)\r\n{\r\nvoid *ext_str = NULL;\r\nchar *value = NULL;\r\nconst unsigned char *p;\r\nconst X509V3_EXT_METHOD *method;\r\nSTACK_OF(CONF_VALUE) *nval = NULL;\r\nint ok = 1;\r\nif(!(method = X509V3_EXT_get(ext)))\r\nreturn unknown_ext_print(out, ext, flag, indent, 0);\r\np = ext->value->data;\r\nif(method->it) ext_str = ASN1_item_d2i(NULL, &p, ext->value->length, ASN1_ITEM_ptr(method->it));\r\nelse ext_str = method->d2i(NULL, &p, ext->value->length);\r\nif(!ext_str) return unknown_ext_print(out, ext, flag, indent, 1);\r\nif(method->i2s) {\r\nif(!(value = method->i2s(method, ext_str))) {\r\nok = 0;\r\ngoto err;\r\n}\r\n#ifndef CHARSET_EBCDIC\r\nBIO_printf(out, "%*s%s", indent, "", value);\r\n#else\r\n{\r\nint len;\r\nchar *tmp;\r\nlen = strlen(value)+1;\r\ntmp = OPENSSL_malloc(len);\r\nif (tmp)\r\n{\r\nascii2ebcdic(tmp, value, len);\r\nBIO_printf(out, "%*s%s", indent, "", tmp);\r\nOPENSSL_free(tmp);\r\n}\r\n}\r\n#endif\r\n} else if(method->i2v) {\r\nif(!(nval = method->i2v(method, ext_str, NULL))) {\r\nok = 0;\r\ngoto err;\r\n}\r\nX509V3_EXT_val_prn(out, nval, indent,\r\nmethod->ext_flags & X509V3_EXT_MULTILINE);\r\n} else if(method->i2r) {\r\nif(!method->i2r(method, ext_str, out, indent)) ok = 0;\r\n} else ok = 0;\r\nerr:\r\nsk_CONF_VALUE_pop_free(nval, X509V3_conf_free);\r\nif(value) OPENSSL_free(value);\r\nif(method->it) ASN1_item_free(ext_str, ASN1_ITEM_ptr(method->it));\r\nelse method->ext_free(ext_str);\r\nreturn ok;\r\n}\r\nstatic int unknown_ext_print(BIO *out, X509_EXTENSION *ext, unsigned long flag, int indent, int supported)\r\n{\r\nswitch(flag & X509V3_EXT_UNKNOWN_MASK) {\r\ncase X509V3_EXT_DEFAULT:\r\nreturn 0;\r\ncase X509V3_EXT_ERROR_UNKNOWN:\r\nif(supported)\r\nBIO_printf(out, "%*s<Parse Error>", indent, "");\r\nelse\r\nBIO_printf(out, "%*s<Not Supported>", indent, "");\r\nreturn 1;\r\ncase X509V3_EXT_PARSE_UNKNOWN:\r\nreturn ASN1_parse_dump(out,\r\next->value->data, ext->value->length, indent, -1);\r\ncase X509V3_EXT_DUMP_UNKNOWN:\r\nreturn BIO_dump_indent(out, (char *)ext->value->data, ext->value->length, indent);\r\ndefault:\r\nreturn 1;\r\n}\r\n}\r\nint X509V3_EXT_print_fp(FILE *fp, X509_EXTENSION *ext, int flag, int indent)\r\n{\r\nBIO *bio_tmp;\r\nint ret;\r\nif(!(bio_tmp = BIO_new_fp(fp, BIO_NOCLOSE))) return 0;\r\nret = X509V3_EXT_print(bio_tmp, ext, flag, indent);\r\nBIO_free(bio_tmp);\r\nreturn ret;\r\n}

int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nint i,badops=0, ret = 1;\r\nBIO *in = NULL,*out = NULL;\r\nint verify=0,noout=0,pubkey=0;\r\nchar *infile = NULL,*outfile = NULL,*prog;\r\nchar *passargin = NULL, *passin = NULL;\r\nconst char *spkac = "SPKAC", *spksect = "default";\r\nchar *spkstr = NULL;\r\nchar *challenge = NULL, *keyfile = NULL;\r\nCONF *conf = NULL;\r\nNETSCAPE_SPKI *spki = NULL;\r\nEVP_PKEY *pkey = NULL;\r\n#ifndef OPENSSL_NO_ENGINE\r\nchar *engine=NULL;\r\n#endif\r\napps_startup();\r\nif (!bio_err) bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\nprog=argv[0];\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-passin") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\npassargin= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-key") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nkeyfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-challenge") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nchallenge= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-spkac") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nspkac= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-spksect") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nspksect= *(++argv);\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\nelse if (strcmp(*argv,"-engine") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nengine= *(++argv);\r\n}\r\n#endif\r\nelse if (strcmp(*argv,"-noout") == 0)\r\nnoout=1;\r\nelse if (strcmp(*argv,"-pubkey") == 0)\r\npubkey=1;\r\nelse if (strcmp(*argv,"-verify") == 0)\r\nverify=1;\r\nelse badops = 1;\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nBIO_printf(bio_err,"%s [options]\n",prog);\r\nBIO_printf(bio_err,"where options are\n");\r\nBIO_printf(bio_err," -in arg input file\n");\r\nBIO_printf(bio_err," -out arg output file\n");\r\nBIO_printf(bio_err," -key arg create SPKAC using private key\n");\r\nBIO_printf(bio_err," -passin arg input file pass phrase source\n");\r\nBIO_printf(bio_err," -challenge arg challenge string\n");\r\nBIO_printf(bio_err," -spkac arg alternative SPKAC name\n");\r\nBIO_printf(bio_err," -noout don't print SPKAC\n");\r\nBIO_printf(bio_err," -pubkey output public key\n");\r\nBIO_printf(bio_err," -verify verify SPKAC signature\n");\r\n#ifndef OPENSSL_NO_ENGINE\r\nBIO_printf(bio_err," -engine e use engine e, possibly a hardware device.\n");\r\n#endif\r\ngoto end;\r\n}\r\nERR_load_crypto_strings();\r\nif(!app_passwd(bio_err, passargin, NULL, &passin, NULL)) {\r\nBIO_printf(bio_err, "Error getting password\n");\r\ngoto end;\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\ne = setup_engine(bio_err, engine, 0);\r\n#endif\r\nif(keyfile) {\r\npkey = load_key(bio_err,\r\nstrcmp(keyfile, "-") ? keyfile : NULL,\r\nFORMAT_PEM, 1, passin, e, "private key");\r\nif(!pkey) {\r\ngoto end;\r\n}\r\nspki = NETSCAPE_SPKI_new();\r\nif(challenge) ASN1_STRING_set(spki->spkac->challenge,\r\nchallenge, (int)strlen(challenge));\r\nNETSCAPE_SPKI_set_pubkey(spki, pkey);\r\nNETSCAPE_SPKI_sign(spki, pkey, EVP_md5());\r\nspkstr = NETSCAPE_SPKI_b64_encode(spki);\r\nif (outfile) out = BIO_new_file(outfile, "w");\r\nelse {\r\nout = BIO_new_fp(stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nif(!out) {\r\nBIO_printf(bio_err, "Error opening output file\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nBIO_printf(out, "SPKAC=%s\n", spkstr);\r\nOPENSSL_free(spkstr);\r\nret = 0;\r\ngoto end;\r\n}\r\nif (infile) in = BIO_new_file(infile, "r");\r\nelse in = BIO_new_fp(stdin, BIO_NOCLOSE);\r\nif(!in) {\r\nBIO_printf(bio_err, "Error opening input file\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nconf = NCONF_new(NULL);\r\ni = NCONF_load_bio(conf, in, NULL);\r\nif(!i) {\r\nBIO_printf(bio_err, "Error parsing config file\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nspkstr = NCONF_get_string(conf, spksect, spkac);\r\nif(!spkstr) {\r\nBIO_printf(bio_err, "Can't find SPKAC called \"%s\"\n", spkac);\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nspki = NETSCAPE_SPKI_b64_decode(spkstr, -1);\r\nif(!spki) {\r\nBIO_printf(bio_err, "Error loading SPKAC\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (outfile) out = BIO_new_file(outfile, "w");\r\nelse {\r\nout = BIO_new_fp(stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nif(!out) {\r\nBIO_printf(bio_err, "Error opening output file\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif(!noout) NETSCAPE_SPKI_print(out, spki);\r\npkey = NETSCAPE_SPKI_get_pubkey(spki);\r\nif(verify) {\r\ni = NETSCAPE_SPKI_verify(spki, pkey);\r\nif (i > 0) BIO_printf(bio_err, "Signature OK\n");\r\nelse {\r\nBIO_printf(bio_err, "Signature Failure\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif(pubkey) PEM_write_bio_PUBKEY(out, pkey);\r\nret = 0;\r\nend:\r\nNCONF_free(conf);\r\nNETSCAPE_SPKI_free(spki);\r\nBIO_free(in);\r\nBIO_free_all(out);\r\nEVP_PKEY_free(pkey);\r\nif(passin) OPENSSL_free(passin);\r\napps_shutdown();\r\nOPENSSL_EXIT(ret);\r\n}

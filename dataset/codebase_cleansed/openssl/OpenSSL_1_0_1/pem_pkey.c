EVP_PKEY *PEM_read_bio_PrivateKey(BIO *bp, EVP_PKEY **x, pem_password_cb *cb, void *u)\r\n{\r\nchar *nm=NULL;\r\nconst unsigned char *p=NULL;\r\nunsigned char *data=NULL;\r\nlong len;\r\nint slen;\r\nEVP_PKEY *ret=NULL;\r\nif (!PEM_bytes_read_bio(&data, &len, &nm, PEM_STRING_EVP_PKEY, bp, cb, u))\r\nreturn NULL;\r\np = data;\r\nif (strcmp(nm,PEM_STRING_PKCS8INF) == 0) {\r\nPKCS8_PRIV_KEY_INFO *p8inf;\r\np8inf=d2i_PKCS8_PRIV_KEY_INFO(NULL, &p, len);\r\nif(!p8inf) goto p8err;\r\nret = EVP_PKCS82PKEY(p8inf);\r\nif(x) {\r\nif(*x) EVP_PKEY_free((EVP_PKEY *)*x);\r\n*x = ret;\r\n}\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\n} else if (strcmp(nm,PEM_STRING_PKCS8) == 0) {\r\nPKCS8_PRIV_KEY_INFO *p8inf;\r\nX509_SIG *p8;\r\nint klen;\r\nchar psbuf[PEM_BUFSIZE];\r\np8 = d2i_X509_SIG(NULL, &p, len);\r\nif(!p8) goto p8err;\r\nif (cb) klen=cb(psbuf,PEM_BUFSIZE,0,u);\r\nelse klen=PEM_def_callback(psbuf,PEM_BUFSIZE,0,u);\r\nif (klen <= 0) {\r\nPEMerr(PEM_F_PEM_READ_BIO_PRIVATEKEY,\r\nPEM_R_BAD_PASSWORD_READ);\r\nX509_SIG_free(p8);\r\ngoto err;\r\n}\r\np8inf = PKCS8_decrypt(p8, psbuf, klen);\r\nX509_SIG_free(p8);\r\nif(!p8inf) goto p8err;\r\nret = EVP_PKCS82PKEY(p8inf);\r\nif(x) {\r\nif(*x) EVP_PKEY_free((EVP_PKEY *)*x);\r\n*x = ret;\r\n}\r\nPKCS8_PRIV_KEY_INFO_free(p8inf);\r\n} else if ((slen = pem_check_suffix(nm, "PRIVATE KEY")) > 0)\r\n{\r\nconst EVP_PKEY_ASN1_METHOD *ameth;\r\nameth = EVP_PKEY_asn1_find_str(NULL, nm, slen);\r\nif (!ameth || !ameth->old_priv_decode)\r\ngoto p8err;\r\nret=d2i_PrivateKey(ameth->pkey_id,x,&p,len);\r\n}\r\np8err:\r\nif (ret == NULL)\r\nPEMerr(PEM_F_PEM_READ_BIO_PRIVATEKEY,ERR_R_ASN1_LIB);\r\nerr:\r\nOPENSSL_free(nm);\r\nOPENSSL_cleanse(data, len);\r\nOPENSSL_free(data);\r\nreturn(ret);\r\n}\r\nint PEM_write_bio_PrivateKey(BIO *bp, EVP_PKEY *x, const EVP_CIPHER *enc,\r\nunsigned char *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nchar pem_str[80];\r\nif (!x->ameth || x->ameth->priv_encode)\r\nreturn PEM_write_bio_PKCS8PrivateKey(bp, x, enc,\r\n(char *)kstr, klen,\r\ncb, u);\r\nBIO_snprintf(pem_str, 80, "%s PRIVATE KEY", x->ameth->pem_str);\r\nreturn PEM_ASN1_write_bio((i2d_of_void *)i2d_PrivateKey,\r\npem_str,bp,x,enc,kstr,klen,cb,u);\r\n}\r\nEVP_PKEY *PEM_read_bio_Parameters(BIO *bp, EVP_PKEY **x)\r\n{\r\nchar *nm=NULL;\r\nconst unsigned char *p=NULL;\r\nunsigned char *data=NULL;\r\nlong len;\r\nint slen;\r\nEVP_PKEY *ret=NULL;\r\nif (!PEM_bytes_read_bio(&data, &len, &nm, PEM_STRING_PARAMETERS,\r\nbp, 0, NULL))\r\nreturn NULL;\r\np = data;\r\nif ((slen = pem_check_suffix(nm, "PARAMETERS")) > 0)\r\n{\r\nret = EVP_PKEY_new();\r\nif (!ret)\r\ngoto err;\r\nif (!EVP_PKEY_set_type_str(ret, nm, slen)\r\n|| !ret->ameth->param_decode\r\n|| !ret->ameth->param_decode(ret, &p, len))\r\n{\r\nEVP_PKEY_free(ret);\r\nret = NULL;\r\ngoto err;\r\n}\r\nif(x)\r\n{\r\nif(*x) EVP_PKEY_free((EVP_PKEY *)*x);\r\n*x = ret;\r\n}\r\n}\r\nerr:\r\nif (ret == NULL)\r\nPEMerr(PEM_F_PEM_READ_BIO_PARAMETERS,ERR_R_ASN1_LIB);\r\nOPENSSL_free(nm);\r\nOPENSSL_free(data);\r\nreturn(ret);\r\n}\r\nint PEM_write_bio_Parameters(BIO *bp, EVP_PKEY *x)\r\n{\r\nchar pem_str[80];\r\nif (!x->ameth || !x->ameth->param_encode)\r\nreturn 0;\r\nBIO_snprintf(pem_str, 80, "%s PARAMETERS", x->ameth->pem_str);\r\nreturn PEM_ASN1_write_bio(\r\n(i2d_of_void *)x->ameth->param_encode,\r\npem_str,bp,x,NULL,NULL,0,0,NULL);\r\n}\r\nEVP_PKEY *PEM_read_PrivateKey(FILE *fp, EVP_PKEY **x, pem_password_cb *cb, void *u)\r\n{\r\nBIO *b;\r\nEVP_PKEY *ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nPEMerr(PEM_F_PEM_READ_PRIVATEKEY,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=PEM_read_bio_PrivateKey(b,x,cb,u);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint PEM_write_PrivateKey(FILE *fp, EVP_PKEY *x, const EVP_CIPHER *enc,\r\nunsigned char *kstr, int klen,\r\npem_password_cb *cb, void *u)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new_fp(fp, BIO_NOCLOSE)) == NULL)\r\n{\r\nPEMerr(PEM_F_PEM_WRITE_PRIVATEKEY,ERR_R_BUF_LIB);\r\nreturn 0;\r\n}\r\nret=PEM_write_bio_PrivateKey(b, x, enc, kstr, klen, cb, u);\r\nBIO_free(b);\r\nreturn ret;\r\n}

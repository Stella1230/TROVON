EVP_PKEY *d2i_PrivateKey(int type, EVP_PKEY **a, const unsigned char **pp,\r\nlong length)\r\n{\r\nEVP_PKEY *ret;\r\nif ((a == NULL) || (*a == NULL))\r\n{\r\nif ((ret=EVP_PKEY_new()) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ERR_R_EVP_LIB);\r\nreturn(NULL);\r\n}\r\n}\r\nelse\r\n{\r\nret= *a;\r\n#ifndef OPENSSL_NO_ENGINE\r\nif (ret->engine)\r\n{\r\nENGINE_finish(ret->engine);\r\nret->engine = NULL;\r\n}\r\n#endif\r\n}\r\nif (!EVP_PKEY_set_type(ret, type))\r\n{\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ASN1_R_UNKNOWN_PUBLIC_KEY_TYPE);\r\ngoto err;\r\n}\r\nif (!ret->ameth->old_priv_decode ||\r\n!ret->ameth->old_priv_decode(ret, pp, length))\r\n{\r\nif (ret->ameth->priv_decode)\r\n{\r\nPKCS8_PRIV_KEY_INFO *p8=NULL;\r\np8=d2i_PKCS8_PRIV_KEY_INFO(NULL,pp,length);\r\nif (!p8) goto err;\r\nEVP_PKEY_free(ret);\r\nret = EVP_PKCS82PKEY(p8);\r\nPKCS8_PRIV_KEY_INFO_free(p8);\r\n}\r\nelse\r\n{\r\nASN1err(ASN1_F_D2I_PRIVATEKEY,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\n}\r\nif (a != NULL) (*a)=ret;\r\nreturn(ret);\r\nerr:\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret))) EVP_PKEY_free(ret);\r\nreturn(NULL);\r\n}\r\nEVP_PKEY *d2i_AutoPrivateKey(EVP_PKEY **a, const unsigned char **pp,\r\nlong length)\r\n{\r\nSTACK_OF(ASN1_TYPE) *inkey;\r\nconst unsigned char *p;\r\nint keytype;\r\np = *pp;\r\ninkey = d2i_ASN1_SEQUENCE_ANY(NULL, &p, length);\r\nif(sk_ASN1_TYPE_num(inkey) == 6)\r\nkeytype = EVP_PKEY_DSA;\r\nelse if (sk_ASN1_TYPE_num(inkey) == 4)\r\nkeytype = EVP_PKEY_EC;\r\nelse if (sk_ASN1_TYPE_num(inkey) == 3)\r\n{\r\nPKCS8_PRIV_KEY_INFO *p8 = d2i_PKCS8_PRIV_KEY_INFO(NULL,pp,length);\r\nEVP_PKEY *ret;\r\nsk_ASN1_TYPE_pop_free(inkey, ASN1_TYPE_free);\r\nif (!p8)\r\n{\r\nASN1err(ASN1_F_D2I_AUTOPRIVATEKEY,ASN1_R_UNSUPPORTED_PUBLIC_KEY_TYPE);\r\nreturn NULL;\r\n}\r\nret = EVP_PKCS82PKEY(p8);\r\nPKCS8_PRIV_KEY_INFO_free(p8);\r\nif (a) {\r\n*a = ret;\r\n}\r\nreturn ret;\r\n}\r\nelse keytype = EVP_PKEY_RSA;\r\nsk_ASN1_TYPE_pop_free(inkey, ASN1_TYPE_free);\r\nreturn d2i_PrivateKey(keytype, a, pp, length);\r\n}

int X509V3_EXT_add(X509V3_EXT_METHOD *ext)\r\n{\r\nif(!ext_list && !(ext_list = sk_X509V3_EXT_METHOD_new(ext_cmp))) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nif(!sk_X509V3_EXT_METHOD_push(ext_list, ext)) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ext_cmp(const X509V3_EXT_METHOD * const *a,\r\nconst X509V3_EXT_METHOD * const *b)\r\n{\r\nreturn ((*a)->ext_nid - (*b)->ext_nid);\r\n}\r\nconst X509V3_EXT_METHOD *X509V3_EXT_get_nid(int nid)\r\n{\r\nX509V3_EXT_METHOD tmp;\r\nconst X509V3_EXT_METHOD *t = &tmp, * const *ret;\r\nint idx;\r\nif(nid < 0) return NULL;\r\ntmp.ext_nid = nid;\r\nret = OBJ_bsearch_ext(&t, standard_exts, STANDARD_EXTENSION_COUNT);\r\nif(ret) return *ret;\r\nif(!ext_list) return NULL;\r\nidx = sk_X509V3_EXT_METHOD_find(ext_list, &tmp);\r\nif(idx == -1) return NULL;\r\nreturn sk_X509V3_EXT_METHOD_value(ext_list, idx);\r\n}\r\nconst X509V3_EXT_METHOD *X509V3_EXT_get(X509_EXTENSION *ext)\r\n{\r\nint nid;\r\nif((nid = OBJ_obj2nid(ext->object)) == NID_undef) return NULL;\r\nreturn X509V3_EXT_get_nid(nid);\r\n}\r\nint X509V3_EXT_add_list(X509V3_EXT_METHOD *extlist)\r\n{\r\nfor(;extlist->ext_nid!=-1;extlist++)\r\nif(!X509V3_EXT_add(extlist)) return 0;\r\nreturn 1;\r\n}\r\nint X509V3_EXT_add_alias(int nid_to, int nid_from)\r\n{\r\nconst X509V3_EXT_METHOD *ext;\r\nX509V3_EXT_METHOD *tmpext;\r\nif(!(ext = X509V3_EXT_get_nid(nid_from))) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD_ALIAS,X509V3_R_EXTENSION_NOT_FOUND);\r\nreturn 0;\r\n}\r\nif(!(tmpext = (X509V3_EXT_METHOD *)OPENSSL_malloc(sizeof(X509V3_EXT_METHOD)))) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD_ALIAS,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\n*tmpext = *ext;\r\ntmpext->ext_nid = nid_to;\r\ntmpext->ext_flags |= X509V3_EXT_DYNAMIC;\r\nreturn X509V3_EXT_add(tmpext);\r\n}\r\nvoid X509V3_EXT_cleanup(void)\r\n{\r\nsk_X509V3_EXT_METHOD_pop_free(ext_list, ext_list_free);\r\next_list = NULL;\r\n}\r\nstatic void ext_list_free(X509V3_EXT_METHOD *ext)\r\n{\r\nif(ext->ext_flags & X509V3_EXT_DYNAMIC) OPENSSL_free(ext);\r\n}\r\nint X509V3_add_standard_extensions(void)\r\n{\r\nreturn 1;\r\n}\r\nvoid *X509V3_EXT_d2i(X509_EXTENSION *ext)\r\n{\r\nconst X509V3_EXT_METHOD *method;\r\nconst unsigned char *p;\r\nif(!(method = X509V3_EXT_get(ext))) return NULL;\r\np = ext->value->data;\r\nif(method->it) return ASN1_item_d2i(NULL, &p, ext->value->length, ASN1_ITEM_ptr(method->it));\r\nreturn method->d2i(NULL, &p, ext->value->length);\r\n}

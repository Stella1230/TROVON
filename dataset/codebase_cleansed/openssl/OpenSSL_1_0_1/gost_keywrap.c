void keyDiversifyCryptoPro(gost_ctx *ctx,const unsigned char *inputKey, const unsigned char *ukm, unsigned char *outputKey)\r\n{\r\nu4 k,s1,s2;\r\nint i,j,mask;\r\nunsigned char S[8];\r\nmemcpy(outputKey,inputKey,32);\r\nfor (i=0;i<8;i++)\r\n{\r\ns1=0,s2=0;\r\nfor (j=0,mask=1;j<8;j++,mask<<=1)\r\n{\r\nk=((u4)outputKey[4*j])|(outputKey[4*j+1]<<8)|\r\n(outputKey[4*j+2]<<16)|(outputKey[4*j+3]<<24);\r\nif (mask & ukm[i])\r\n{\r\ns1+=k;\r\n}\r\nelse\r\n{\r\ns2+=k;\r\n}\r\n}\r\nS[0]=(unsigned char)(s1&0xff);\r\nS[1]=(unsigned char)((s1>>8)&0xff);\r\nS[2]=(unsigned char)((s1>>16)&0xff);\r\nS[3]=(unsigned char)((s1>>24)&0xff);\r\nS[4]=(unsigned char)(s2&0xff);\r\nS[5]=(unsigned char)((s2>>8)&0xff);\r\nS[6]=(unsigned char)((s2>>16)&0xff);\r\nS[7]=(unsigned char)((s2>>24)&0xff);\r\ngost_key(ctx,outputKey);\r\ngost_enc_cfb(ctx,S,outputKey,outputKey,4);\r\n}\r\n}\r\nint keyWrapCryptoPro(gost_ctx *ctx,const unsigned char *keyExchangeKey, const unsigned char *ukm,\r\nconst unsigned char *sessionKey, unsigned char *wrappedKey)\r\n{\r\nunsigned char kek_ukm[32];\r\nkeyDiversifyCryptoPro(ctx,keyExchangeKey,ukm,kek_ukm);\r\ngost_key(ctx,kek_ukm);\r\nmemcpy(wrappedKey,ukm,8);\r\ngost_enc(ctx,sessionKey,wrappedKey+8,4);\r\ngost_mac_iv(ctx,32,ukm,sessionKey,32,wrappedKey+40);\r\nreturn 1;\r\n}\r\nint keyUnwrapCryptoPro(gost_ctx *ctx,const unsigned char *keyExchangeKey,\r\nconst unsigned char *wrappedKey, unsigned char *sessionKey)\r\n{\r\nunsigned char kek_ukm[32],cek_mac[4];\r\nkeyDiversifyCryptoPro(ctx,keyExchangeKey,wrappedKey\r\n,kek_ukm);\r\ngost_key(ctx,kek_ukm);\r\ngost_dec(ctx,wrappedKey+8,sessionKey,4);\r\ngost_mac_iv(ctx,32,wrappedKey,sessionKey,32,cek_mac);\r\nif (memcmp(cek_mac,wrappedKey+40,4))\r\n{\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}

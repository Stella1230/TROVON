static int bind_helper(ENGINE *e)\r\n{\r\nif(!ENGINE_set_id(e, engine_openssl_id)\r\n|| !ENGINE_set_name(e, engine_openssl_name)\r\n#ifndef TEST_ENG_OPENSSL_NO_ALGORITHMS\r\n#ifndef OPENSSL_NO_RSA\r\n|| !ENGINE_set_RSA(e, RSA_get_default_method())\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\n|| !ENGINE_set_DSA(e, DSA_get_default_method())\r\n#endif\r\n#ifndef OPENSSL_NO_ECDH\r\n|| !ENGINE_set_ECDH(e, ECDH_OpenSSL())\r\n#endif\r\n#ifndef OPENSSL_NO_ECDSA\r\n|| !ENGINE_set_ECDSA(e, ECDSA_OpenSSL())\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\n|| !ENGINE_set_DH(e, DH_get_default_method())\r\n#endif\r\n|| !ENGINE_set_RAND(e, RAND_SSLeay())\r\n#ifdef TEST_ENG_OPENSSL_RC4\r\n|| !ENGINE_set_ciphers(e, openssl_ciphers)\r\n#endif\r\n#ifdef TEST_ENG_OPENSSL_SHA\r\n|| !ENGINE_set_digests(e, openssl_digests)\r\n#endif\r\n#endif\r\n#ifdef TEST_ENG_OPENSSL_PKEY\r\n|| !ENGINE_set_load_privkey_function(e, openssl_load_privkey)\r\n#endif\r\n)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic ENGINE *engine_openssl(void)\r\n{\r\nENGINE *ret = ENGINE_new();\r\nif(!ret)\r\nreturn NULL;\r\nif(!bind_helper(ret))\r\n{\r\nENGINE_free(ret);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nvoid ENGINE_load_openssl(void)\r\n{\r\nENGINE *toadd = engine_openssl();\r\nif(!toadd) return;\r\nENGINE_add(toadd);\r\nENGINE_free(toadd);\r\nERR_clear_error();\r\n}\r\nstatic int bind_fn(ENGINE *e, const char *id)\r\n{\r\nif(id && (strcmp(id, engine_openssl_id) != 0))\r\nreturn 0;\r\nif(!bind_helper(e))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic int test_rc4_init_key(EVP_CIPHER_CTX *ctx, const unsigned char *key,\r\nconst unsigned char *iv, int enc)\r\n{\r\n#ifdef TEST_ENG_OPENSSL_RC4_P_INIT\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_RC4) test_init_key() called\n");\r\n#endif\r\nmemcpy(&test(ctx)->key[0],key,EVP_CIPHER_CTX_key_length(ctx));\r\nRC4_set_key(&test(ctx)->ks,EVP_CIPHER_CTX_key_length(ctx),\r\ntest(ctx)->key);\r\nreturn 1;\r\n}\r\nstatic int test_rc4_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nconst unsigned char *in, size_t inl)\r\n{\r\n#ifdef TEST_ENG_OPENSSL_RC4_P_CIPHER\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_RC4) test_cipher() called\n");\r\n#endif\r\nRC4(&test(ctx)->ks,inl,in,out);\r\nreturn 1;\r\n}\r\nstatic int openssl_ciphers(ENGINE *e, const EVP_CIPHER **cipher,\r\nconst int **nids, int nid)\r\n{\r\nif(!cipher)\r\n{\r\n*nids = test_cipher_nids;\r\nreturn test_cipher_nids_number;\r\n}\r\nif(nid == NID_rc4)\r\n*cipher = &test_r4_cipher;\r\nelse if(nid == NID_rc4_40)\r\n*cipher = &test_r4_40_cipher;\r\nelse\r\n{\r\n#ifdef TEST_ENG_OPENSSL_RC4_OTHERS\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_RC4) returning NULL for "\r\n"nid %d\n", nid);\r\n#endif\r\n*cipher = NULL;\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int test_sha1_init(EVP_MD_CTX *ctx)\r\n{\r\n#ifdef TEST_ENG_OPENSSL_SHA_P_INIT\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_SHA) test_sha1_init() called\n");\r\n#endif\r\nreturn SHA1_Init(ctx->md_data);\r\n}\r\nstatic int test_sha1_update(EVP_MD_CTX *ctx,const void *data,size_t count)\r\n{\r\n#ifdef TEST_ENG_OPENSSL_SHA_P_UPDATE\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_SHA) test_sha1_update() called\n");\r\n#endif\r\nreturn SHA1_Update(ctx->md_data,data,count);\r\n}\r\nstatic int test_sha1_final(EVP_MD_CTX *ctx,unsigned char *md)\r\n{\r\n#ifdef TEST_ENG_OPENSSL_SHA_P_FINAL\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_SHA) test_sha1_final() called\n");\r\n#endif\r\nreturn SHA1_Final(md,ctx->md_data);\r\n}\r\nstatic int openssl_digests(ENGINE *e, const EVP_MD **digest,\r\nconst int **nids, int nid)\r\n{\r\nif(!digest)\r\n{\r\n*nids = test_digest_nids;\r\nreturn test_digest_nids_number;\r\n}\r\nif(nid == NID_sha1)\r\n*digest = &test_sha_md;\r\nelse\r\n{\r\n#ifdef TEST_ENG_OPENSSL_SHA_OTHERS\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_SHA) returning NULL for "\r\n"nid %d\n", nid);\r\n#endif\r\n*digest = NULL;\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic EVP_PKEY *openssl_load_privkey(ENGINE *eng, const char *key_id,\r\nUI_METHOD *ui_method, void *callback_data)\r\n{\r\nBIO *in;\r\nEVP_PKEY *key;\r\nfprintf(stderr, "(TEST_ENG_OPENSSL_PKEY)Loading Private key %s\n", key_id);\r\nin = BIO_new_file(key_id, "r");\r\nif (!in)\r\nreturn NULL;\r\nkey = PEM_read_bio_PrivateKey(in, NULL, 0, NULL);\r\nBIO_free(in);\r\nreturn key;\r\n}

int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nBIO *in = NULL, *out = NULL;\r\nchar *infile = NULL, *outfile = NULL;\r\n#ifndef OPENSSL_NO_ENGINE\r\nchar *engine = NULL;\r\n#endif\r\nchar *keyfile = NULL;\r\nchar rsa_mode = RSA_VERIFY, key_type = KEY_PRIVKEY;\r\nint keyform = FORMAT_PEM;\r\nchar need_priv = 0, badarg = 0, rev = 0;\r\nchar hexdump = 0, asn1parse = 0;\r\nX509 *x;\r\nEVP_PKEY *pkey = NULL;\r\nRSA *rsa = NULL;\r\nunsigned char *rsa_in = NULL, *rsa_out = NULL, pad;\r\nchar *passargin = NULL, *passin = NULL;\r\nint rsa_inlen, rsa_outlen = 0;\r\nint keysize;\r\nint ret = 1;\r\nargc--;\r\nargv++;\r\nif(!bio_err) bio_err = BIO_new_fp(stderr, BIO_NOCLOSE);\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\nERR_load_crypto_strings();\r\nOpenSSL_add_all_algorithms();\r\npad = RSA_PKCS1_PADDING;\r\nwhile(argc >= 1)\r\n{\r\nif (!strcmp(*argv,"-in")) {\r\nif (--argc < 1)\r\nbadarg = 1;\r\nelse\r\ninfile= *(++argv);\r\n} else if (!strcmp(*argv,"-out")) {\r\nif (--argc < 1)\r\nbadarg = 1;\r\nelse\r\noutfile= *(++argv);\r\n} else if(!strcmp(*argv, "-inkey")) {\r\nif (--argc < 1)\r\nbadarg = 1;\r\nelse\r\nkeyfile = *(++argv);\r\n} else if (!strcmp(*argv,"-passin")) {\r\nif (--argc < 1)\r\nbadarg = 1;\r\nelse\r\npassargin= *(++argv);\r\n} else if (strcmp(*argv,"-keyform") == 0) {\r\nif (--argc < 1)\r\nbadarg = 1;\r\nelse\r\nkeyform=str2fmt(*(++argv));\r\n#ifndef OPENSSL_NO_ENGINE\r\n} else if(!strcmp(*argv, "-engine")) {\r\nif (--argc < 1)\r\nbadarg = 1;\r\nelse\r\nengine = *(++argv);\r\n#endif\r\n} else if(!strcmp(*argv, "-pubin")) {\r\nkey_type = KEY_PUBKEY;\r\n} else if(!strcmp(*argv, "-certin")) {\r\nkey_type = KEY_CERT;\r\n}\r\nelse if(!strcmp(*argv, "-asn1parse")) asn1parse = 1;\r\nelse if(!strcmp(*argv, "-hexdump")) hexdump = 1;\r\nelse if(!strcmp(*argv, "-raw")) pad = RSA_NO_PADDING;\r\nelse if(!strcmp(*argv, "-oaep")) pad = RSA_PKCS1_OAEP_PADDING;\r\nelse if(!strcmp(*argv, "-ssl")) pad = RSA_SSLV23_PADDING;\r\nelse if(!strcmp(*argv, "-pkcs")) pad = RSA_PKCS1_PADDING;\r\nelse if(!strcmp(*argv, "-x931")) pad = RSA_X931_PADDING;\r\nelse if(!strcmp(*argv, "-sign")) {\r\nrsa_mode = RSA_SIGN;\r\nneed_priv = 1;\r\n} else if(!strcmp(*argv, "-verify")) rsa_mode = RSA_VERIFY;\r\nelse if(!strcmp(*argv, "-rev")) rev = 1;\r\nelse if(!strcmp(*argv, "-encrypt")) rsa_mode = RSA_ENCRYPT;\r\nelse if(!strcmp(*argv, "-decrypt")) {\r\nrsa_mode = RSA_DECRYPT;\r\nneed_priv = 1;\r\n} else badarg = 1;\r\nif(badarg) {\r\nusage();\r\ngoto end;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif(need_priv && (key_type != KEY_PRIVKEY)) {\r\nBIO_printf(bio_err, "A private key is needed for this operation\n");\r\ngoto end;\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\ne = setup_engine(bio_err, engine, 0);\r\n#endif\r\nif(!app_passwd(bio_err, passargin, NULL, &passin, NULL)) {\r\nBIO_printf(bio_err, "Error getting password\n");\r\ngoto end;\r\n}\r\napp_RAND_load_file(NULL, bio_err, 0);\r\nswitch(key_type) {\r\ncase KEY_PRIVKEY:\r\npkey = load_key(bio_err, keyfile, keyform, 0,\r\npassin, e, "Private Key");\r\nbreak;\r\ncase KEY_PUBKEY:\r\npkey = load_pubkey(bio_err, keyfile, keyform, 0,\r\nNULL, e, "Public Key");\r\nbreak;\r\ncase KEY_CERT:\r\nx = load_cert(bio_err, keyfile, keyform,\r\nNULL, e, "Certificate");\r\nif(x) {\r\npkey = X509_get_pubkey(x);\r\nX509_free(x);\r\n}\r\nbreak;\r\n}\r\nif(!pkey) {\r\nreturn 1;\r\n}\r\nrsa = EVP_PKEY_get1_RSA(pkey);\r\nEVP_PKEY_free(pkey);\r\nif(!rsa) {\r\nBIO_printf(bio_err, "Error getting RSA key\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif(infile) {\r\nif(!(in = BIO_new_file(infile, "rb"))) {\r\nBIO_printf(bio_err, "Error Reading Input File\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n} else in = BIO_new_fp(stdin, BIO_NOCLOSE);\r\nif(outfile) {\r\nif(!(out = BIO_new_file(outfile, "wb"))) {\r\nBIO_printf(bio_err, "Error Reading Output File\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n} else {\r\nout = BIO_new_fp(stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nkeysize = RSA_size(rsa);\r\nrsa_in = OPENSSL_malloc(keysize * 2);\r\nrsa_out = OPENSSL_malloc(keysize);\r\nrsa_inlen = BIO_read(in, rsa_in, keysize * 2);\r\nif(rsa_inlen <= 0) {\r\nBIO_printf(bio_err, "Error reading input Data\n");\r\nexit(1);\r\n}\r\nif(rev) {\r\nint i;\r\nunsigned char ctmp;\r\nfor(i = 0; i < rsa_inlen/2; i++) {\r\nctmp = rsa_in[i];\r\nrsa_in[i] = rsa_in[rsa_inlen - 1 - i];\r\nrsa_in[rsa_inlen - 1 - i] = ctmp;\r\n}\r\n}\r\nswitch(rsa_mode) {\r\ncase RSA_VERIFY:\r\nrsa_outlen = RSA_public_decrypt(rsa_inlen, rsa_in, rsa_out, rsa, pad);\r\nbreak;\r\ncase RSA_SIGN:\r\nrsa_outlen = RSA_private_encrypt(rsa_inlen, rsa_in, rsa_out, rsa, pad);\r\nbreak;\r\ncase RSA_ENCRYPT:\r\nrsa_outlen = RSA_public_encrypt(rsa_inlen, rsa_in, rsa_out, rsa, pad);\r\nbreak;\r\ncase RSA_DECRYPT:\r\nrsa_outlen = RSA_private_decrypt(rsa_inlen, rsa_in, rsa_out, rsa, pad);\r\nbreak;\r\n}\r\nif(rsa_outlen <= 0) {\r\nBIO_printf(bio_err, "RSA operation error\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nret = 0;\r\nif(asn1parse) {\r\nif(!ASN1_parse_dump(out, rsa_out, rsa_outlen, 1, -1)) {\r\nERR_print_errors(bio_err);\r\n}\r\n} else if(hexdump) BIO_dump(out, (char *)rsa_out, rsa_outlen);\r\nelse BIO_write(out, rsa_out, rsa_outlen);\r\nend:\r\nRSA_free(rsa);\r\nBIO_free(in);\r\nBIO_free_all(out);\r\nif(rsa_in) OPENSSL_free(rsa_in);\r\nif(rsa_out) OPENSSL_free(rsa_out);\r\nif(passin) OPENSSL_free(passin);\r\nreturn ret;\r\n}\r\nstatic void usage()\r\n{\r\nBIO_printf(bio_err, "Usage: rsautl [options]\n");\r\nBIO_printf(bio_err, "-in file input file\n");\r\nBIO_printf(bio_err, "-out file output file\n");\r\nBIO_printf(bio_err, "-inkey file input key\n");\r\nBIO_printf(bio_err, "-keyform arg private key format - default PEM\n");\r\nBIO_printf(bio_err, "-pubin input is an RSA public\n");\r\nBIO_printf(bio_err, "-certin input is a certificate carrying an RSA public key\n");\r\nBIO_printf(bio_err, "-ssl use SSL v2 padding\n");\r\nBIO_printf(bio_err, "-raw use no padding\n");\r\nBIO_printf(bio_err, "-pkcs use PKCS#1 v1.5 padding (default)\n");\r\nBIO_printf(bio_err, "-oaep use PKCS#1 OAEP\n");\r\nBIO_printf(bio_err, "-sign sign with private key\n");\r\nBIO_printf(bio_err, "-verify verify with public key\n");\r\nBIO_printf(bio_err, "-encrypt encrypt with public key\n");\r\nBIO_printf(bio_err, "-decrypt decrypt with private key\n");\r\nBIO_printf(bio_err, "-hexdump hex dump output\n");\r\n#ifndef OPENSSL_NO_ENGINE\r\nBIO_printf(bio_err, "-engine e use engine e, possibly a hardware device.\n");\r\nBIO_printf (bio_err, "-passin arg pass phrase source\n");\r\n#endif\r\n}

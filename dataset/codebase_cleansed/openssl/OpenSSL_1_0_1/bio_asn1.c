BIO_METHOD *BIO_f_asn1(void)\r\n{\r\nreturn(&methods_asn1);\r\n}\r\nstatic int asn1_bio_new(BIO *b)\r\n{\r\nBIO_ASN1_BUF_CTX *ctx;\r\nctx = OPENSSL_malloc(sizeof(BIO_ASN1_BUF_CTX));\r\nif (!ctx)\r\nreturn 0;\r\nif (!asn1_bio_init(ctx, DEFAULT_ASN1_BUF_SIZE))\r\nreturn 0;\r\nb->init = 1;\r\nb->ptr = (char *)ctx;\r\nb->flags = 0;\r\nreturn 1;\r\n}\r\nstatic int asn1_bio_init(BIO_ASN1_BUF_CTX *ctx, int size)\r\n{\r\nctx->buf = OPENSSL_malloc(size);\r\nif (!ctx->buf)\r\nreturn 0;\r\nctx->bufsize = size;\r\nctx->bufpos = 0;\r\nctx->buflen = 0;\r\nctx->copylen = 0;\r\nctx->asn1_class = V_ASN1_UNIVERSAL;\r\nctx->asn1_tag = V_ASN1_OCTET_STRING;\r\nctx->ex_buf = 0;\r\nctx->ex_pos = 0;\r\nctx->ex_len = 0;\r\nctx->state = ASN1_STATE_START;\r\nreturn 1;\r\n}\r\nstatic int asn1_bio_free(BIO *b)\r\n{\r\nBIO_ASN1_BUF_CTX *ctx;\r\nctx = (BIO_ASN1_BUF_CTX *) b->ptr;\r\nif (ctx == NULL)\r\nreturn 0;\r\nif (ctx->buf)\r\nOPENSSL_free(ctx->buf);\r\nOPENSSL_free(ctx);\r\nb->init = 0;\r\nb->ptr = NULL;\r\nb->flags = 0;\r\nreturn 1;\r\n}\r\nstatic int asn1_bio_write(BIO *b, const char *in , int inl)\r\n{\r\nBIO_ASN1_BUF_CTX *ctx;\r\nint wrmax, wrlen, ret;\r\nunsigned char *p;\r\nif (!in || (inl < 0) || (b->next_bio == NULL))\r\nreturn 0;\r\nctx = (BIO_ASN1_BUF_CTX *) b->ptr;\r\nif (ctx == NULL)\r\nreturn 0;\r\nwrlen = 0;\r\nret = -1;\r\nfor(;;)\r\n{\r\nswitch (ctx->state)\r\n{\r\ncase ASN1_STATE_START:\r\nif (!asn1_bio_setup_ex(b, ctx, ctx->prefix,\r\nASN1_STATE_PRE_COPY, ASN1_STATE_HEADER))\r\nreturn 0;\r\nbreak;\r\ncase ASN1_STATE_PRE_COPY:\r\nret = asn1_bio_flush_ex(b, ctx, ctx->prefix_free,\r\nASN1_STATE_HEADER);\r\nif (ret <= 0)\r\ngoto done;\r\nbreak;\r\ncase ASN1_STATE_HEADER:\r\nctx->buflen =\r\nASN1_object_size(0, inl, ctx->asn1_tag) - inl;\r\nOPENSSL_assert(ctx->buflen <= ctx->bufsize);\r\np = ctx->buf;\r\nASN1_put_object(&p, 0, inl,\r\nctx->asn1_tag, ctx->asn1_class);\r\nctx->copylen = inl;\r\nctx->state = ASN1_STATE_HEADER_COPY;\r\nbreak;\r\ncase ASN1_STATE_HEADER_COPY:\r\nret = BIO_write(b->next_bio,\r\nctx->buf + ctx->bufpos, ctx->buflen);\r\nif (ret <= 0)\r\ngoto done;\r\nctx->buflen -= ret;\r\nif (ctx->buflen)\r\nctx->bufpos += ret;\r\nelse\r\n{\r\nctx->bufpos = 0;\r\nctx->state = ASN1_STATE_DATA_COPY;\r\n}\r\nbreak;\r\ncase ASN1_STATE_DATA_COPY:\r\nif (inl > ctx->copylen)\r\nwrmax = ctx->copylen;\r\nelse\r\nwrmax = inl;\r\nret = BIO_write(b->next_bio, in, wrmax);\r\nif (ret <= 0)\r\nbreak;\r\nwrlen += ret;\r\nctx->copylen -= ret;\r\nin += ret;\r\ninl -= ret;\r\nif (ctx->copylen == 0)\r\nctx->state = ASN1_STATE_HEADER;\r\nif (inl == 0)\r\ngoto done;\r\nbreak;\r\ndefault:\r\nBIO_clear_retry_flags(b);\r\nreturn 0;\r\n}\r\n}\r\ndone:\r\nBIO_clear_retry_flags(b);\r\nBIO_copy_next_retry(b);\r\nreturn (wrlen > 0) ? wrlen : ret;\r\n}\r\nstatic int asn1_bio_flush_ex(BIO *b, BIO_ASN1_BUF_CTX *ctx,\r\nasn1_ps_func *cleanup, asn1_bio_state_t next)\r\n{\r\nint ret;\r\nif (ctx->ex_len <= 0)\r\nreturn 1;\r\nfor(;;)\r\n{\r\nret = BIO_write(b->next_bio, ctx->ex_buf + ctx->ex_pos,\r\nctx->ex_len);\r\nif (ret <= 0)\r\nbreak;\r\nctx->ex_len -= ret;\r\nif (ctx->ex_len > 0)\r\nctx->ex_pos += ret;\r\nelse\r\n{\r\nif(cleanup)\r\ncleanup(b, &ctx->ex_buf, &ctx->ex_len,\r\n&ctx->ex_arg);\r\nctx->state = next;\r\nctx->ex_pos = 0;\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int asn1_bio_setup_ex(BIO *b, BIO_ASN1_BUF_CTX *ctx,\r\nasn1_ps_func *setup,\r\nasn1_bio_state_t ex_state,\r\nasn1_bio_state_t other_state)\r\n{\r\nif (setup && !setup(b, &ctx->ex_buf, &ctx->ex_len, &ctx->ex_arg))\r\n{\r\nBIO_clear_retry_flags(b);\r\nreturn 0;\r\n}\r\nif (ctx->ex_len > 0)\r\nctx->state = ex_state;\r\nelse\r\nctx->state = other_state;\r\nreturn 1;\r\n}\r\nstatic int asn1_bio_read(BIO *b, char *in , int inl)\r\n{\r\nif (!b->next_bio)\r\nreturn 0;\r\nreturn BIO_read(b->next_bio, in , inl);\r\n}\r\nstatic int asn1_bio_puts(BIO *b, const char *str)\r\n{\r\nreturn asn1_bio_write(b, str, strlen(str));\r\n}\r\nstatic int asn1_bio_gets(BIO *b, char *str, int size)\r\n{\r\nif (!b->next_bio)\r\nreturn 0;\r\nreturn BIO_gets(b->next_bio, str , size);\r\n}\r\nstatic long asn1_bio_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)\r\n{\r\nif (b->next_bio == NULL) return(0);\r\nreturn BIO_callback_ctrl(b->next_bio,cmd,fp);\r\n}\r\nstatic long asn1_bio_ctrl(BIO *b, int cmd, long arg1, void *arg2)\r\n{\r\nBIO_ASN1_BUF_CTX *ctx;\r\nBIO_ASN1_EX_FUNCS *ex_func;\r\nlong ret = 1;\r\nctx = (BIO_ASN1_BUF_CTX *) b->ptr;\r\nif (ctx == NULL)\r\nreturn 0;\r\nswitch(cmd)\r\n{\r\ncase BIO_C_SET_PREFIX:\r\nex_func = arg2;\r\nctx->prefix = ex_func->ex_func;\r\nctx->prefix_free = ex_func->ex_free_func;\r\nbreak;\r\ncase BIO_C_GET_PREFIX:\r\nex_func = arg2;\r\nex_func->ex_func = ctx->prefix;\r\nex_func->ex_free_func = ctx->prefix_free;\r\nbreak;\r\ncase BIO_C_SET_SUFFIX:\r\nex_func = arg2;\r\nctx->suffix = ex_func->ex_func;\r\nctx->suffix_free = ex_func->ex_free_func;\r\nbreak;\r\ncase BIO_C_GET_SUFFIX:\r\nex_func = arg2;\r\nex_func->ex_func = ctx->suffix;\r\nex_func->ex_free_func = ctx->suffix_free;\r\nbreak;\r\ncase BIO_C_SET_EX_ARG:\r\nctx->ex_arg = arg2;\r\nbreak;\r\ncase BIO_C_GET_EX_ARG:\r\n*(void **)arg2 = ctx->ex_arg;\r\nbreak;\r\ncase BIO_CTRL_FLUSH:\r\nif (!b->next_bio)\r\nreturn 0;\r\nif (ctx->state == ASN1_STATE_HEADER)\r\n{\r\nif (!asn1_bio_setup_ex(b, ctx, ctx->suffix,\r\nASN1_STATE_POST_COPY, ASN1_STATE_DONE))\r\nreturn 0;\r\n}\r\nif (ctx->state == ASN1_STATE_POST_COPY)\r\n{\r\nret = asn1_bio_flush_ex(b, ctx, ctx->suffix_free,\r\nASN1_STATE_DONE);\r\nif (ret <= 0)\r\nreturn ret;\r\n}\r\nif (ctx->state == ASN1_STATE_DONE)\r\nreturn BIO_ctrl(b->next_bio, cmd, arg1, arg2);\r\nelse\r\n{\r\nBIO_clear_retry_flags(b);\r\nreturn 0;\r\n}\r\nbreak;\r\ndefault:\r\nif (!b->next_bio)\r\nreturn 0;\r\nreturn BIO_ctrl(b->next_bio, cmd, arg1, arg2);\r\n}\r\nreturn ret;\r\n}\r\nstatic int asn1_bio_set_ex(BIO *b, int cmd,\r\nasn1_ps_func *ex_func, asn1_ps_func *ex_free_func)\r\n{\r\nBIO_ASN1_EX_FUNCS extmp;\r\nextmp.ex_func = ex_func;\r\nextmp.ex_free_func = ex_free_func;\r\nreturn BIO_ctrl(b, cmd, 0, &extmp);\r\n}\r\nstatic int asn1_bio_get_ex(BIO *b, int cmd,\r\nasn1_ps_func **ex_func, asn1_ps_func **ex_free_func)\r\n{\r\nBIO_ASN1_EX_FUNCS extmp;\r\nint ret;\r\nret = BIO_ctrl(b, cmd, 0, &extmp);\r\nif (ret > 0)\r\n{\r\n*ex_func = extmp.ex_func;\r\n*ex_free_func = extmp.ex_free_func;\r\n}\r\nreturn ret;\r\n}\r\nint BIO_asn1_set_prefix(BIO *b, asn1_ps_func *prefix, asn1_ps_func *prefix_free)\r\n{\r\nreturn asn1_bio_set_ex(b, BIO_C_SET_PREFIX, prefix, prefix_free);\r\n}\r\nint BIO_asn1_get_prefix(BIO *b, asn1_ps_func **pprefix, asn1_ps_func **pprefix_free)\r\n{\r\nreturn asn1_bio_get_ex(b, BIO_C_GET_PREFIX, pprefix, pprefix_free);\r\n}\r\nint BIO_asn1_set_suffix(BIO *b, asn1_ps_func *suffix, asn1_ps_func *suffix_free)\r\n{\r\nreturn asn1_bio_set_ex(b, BIO_C_SET_SUFFIX, suffix, suffix_free);\r\n}\r\nint BIO_asn1_get_suffix(BIO *b, asn1_ps_func **psuffix, asn1_ps_func **psuffix_free)\r\n{\r\nreturn asn1_bio_get_ex(b, BIO_C_GET_SUFFIX, psuffix, psuffix_free);\r\n}

int MAIN(int argc, char **argv)\r\n{\r\nENGINE *e = NULL;\r\nint operation = 0;\r\nint ret = 0;\r\nchar **args;\r\nconst char *inmode = "r", *outmode = "w";\r\nchar *infile = NULL, *outfile = NULL;\r\nchar *signerfile = NULL, *recipfile = NULL;\r\nSTACK_OF(OPENSSL_STRING) *sksigners = NULL, *skkeys = NULL;\r\nchar *certfile = NULL, *keyfile = NULL, *contfile=NULL;\r\nconst EVP_CIPHER *cipher = NULL;\r\nPKCS7 *p7 = NULL;\r\nX509_STORE *store = NULL;\r\nX509 *cert = NULL, *recip = NULL, *signer = NULL;\r\nEVP_PKEY *key = NULL;\r\nSTACK_OF(X509) *encerts = NULL, *other = NULL;\r\nBIO *in = NULL, *out = NULL, *indata = NULL;\r\nint badarg = 0;\r\nint flags = PKCS7_DETACHED;\r\nchar *to = NULL, *from = NULL, *subject = NULL;\r\nchar *CAfile = NULL, *CApath = NULL;\r\nchar *passargin = NULL, *passin = NULL;\r\nchar *inrand = NULL;\r\nint need_rand = 0;\r\nint indef = 0;\r\nconst EVP_MD *sign_md = NULL;\r\nint informat = FORMAT_SMIME, outformat = FORMAT_SMIME;\r\nint keyform = FORMAT_PEM;\r\n#ifndef OPENSSL_NO_ENGINE\r\nchar *engine=NULL;\r\n#endif\r\nX509_VERIFY_PARAM *vpm = NULL;\r\nargs = argv + 1;\r\nret = 1;\r\napps_startup();\r\nif (bio_err == NULL)\r\n{\r\nif ((bio_err = BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err, stderr, BIO_NOCLOSE|BIO_FP_TEXT);\r\n}\r\nif (!load_config(bio_err, NULL))\r\ngoto end;\r\nwhile (!badarg && *args && *args[0] == '-')\r\n{\r\nif (!strcmp (*args, "-encrypt"))\r\noperation = SMIME_ENCRYPT;\r\nelse if (!strcmp (*args, "-decrypt"))\r\noperation = SMIME_DECRYPT;\r\nelse if (!strcmp (*args, "-sign"))\r\noperation = SMIME_SIGN;\r\nelse if (!strcmp (*args, "-resign"))\r\noperation = SMIME_RESIGN;\r\nelse if (!strcmp (*args, "-verify"))\r\noperation = SMIME_VERIFY;\r\nelse if (!strcmp (*args, "-pk7out"))\r\noperation = SMIME_PK7OUT;\r\n#ifndef OPENSSL_NO_DES\r\nelse if (!strcmp (*args, "-des3"))\r\ncipher = EVP_des_ede3_cbc();\r\nelse if (!strcmp (*args, "-des"))\r\ncipher = EVP_des_cbc();\r\n#endif\r\n#ifndef OPENSSL_NO_SEED\r\nelse if (!strcmp (*args, "-seed"))\r\ncipher = EVP_seed_cbc();\r\n#endif\r\n#ifndef OPENSSL_NO_RC2\r\nelse if (!strcmp (*args, "-rc2-40"))\r\ncipher = EVP_rc2_40_cbc();\r\nelse if (!strcmp (*args, "-rc2-128"))\r\ncipher = EVP_rc2_cbc();\r\nelse if (!strcmp (*args, "-rc2-64"))\r\ncipher = EVP_rc2_64_cbc();\r\n#endif\r\n#ifndef OPENSSL_NO_AES\r\nelse if (!strcmp(*args,"-aes128"))\r\ncipher = EVP_aes_128_cbc();\r\nelse if (!strcmp(*args,"-aes192"))\r\ncipher = EVP_aes_192_cbc();\r\nelse if (!strcmp(*args,"-aes256"))\r\ncipher = EVP_aes_256_cbc();\r\n#endif\r\n#ifndef OPENSSL_NO_CAMELLIA\r\nelse if (!strcmp(*args,"-camellia128"))\r\ncipher = EVP_camellia_128_cbc();\r\nelse if (!strcmp(*args,"-camellia192"))\r\ncipher = EVP_camellia_192_cbc();\r\nelse if (!strcmp(*args,"-camellia256"))\r\ncipher = EVP_camellia_256_cbc();\r\n#endif\r\nelse if (!strcmp (*args, "-text"))\r\nflags |= PKCS7_TEXT;\r\nelse if (!strcmp (*args, "-nointern"))\r\nflags |= PKCS7_NOINTERN;\r\nelse if (!strcmp (*args, "-noverify"))\r\nflags |= PKCS7_NOVERIFY;\r\nelse if (!strcmp (*args, "-nochain"))\r\nflags |= PKCS7_NOCHAIN;\r\nelse if (!strcmp (*args, "-nocerts"))\r\nflags |= PKCS7_NOCERTS;\r\nelse if (!strcmp (*args, "-noattr"))\r\nflags |= PKCS7_NOATTR;\r\nelse if (!strcmp (*args, "-nodetach"))\r\nflags &= ~PKCS7_DETACHED;\r\nelse if (!strcmp (*args, "-nosmimecap"))\r\nflags |= PKCS7_NOSMIMECAP;\r\nelse if (!strcmp (*args, "-binary"))\r\nflags |= PKCS7_BINARY;\r\nelse if (!strcmp (*args, "-nosigs"))\r\nflags |= PKCS7_NOSIGS;\r\nelse if (!strcmp (*args, "-stream"))\r\nindef = 1;\r\nelse if (!strcmp (*args, "-indef"))\r\nindef = 1;\r\nelse if (!strcmp (*args, "-noindef"))\r\nindef = 0;\r\nelse if (!strcmp (*args, "-nooldmime"))\r\nflags |= PKCS7_NOOLDMIMETYPE;\r\nelse if (!strcmp (*args, "-crlfeol"))\r\nflags |= PKCS7_CRLFEOL;\r\nelse if (!strcmp(*args,"-rand"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nargs++;\r\ninrand = *args;\r\nneed_rand = 1;\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\nelse if (!strcmp(*args,"-engine"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nengine = *++args;\r\n}\r\n#endif\r\nelse if (!strcmp(*args,"-passin"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\npassargin = *++args;\r\n}\r\nelse if (!strcmp (*args, "-to"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nto = *++args;\r\n}\r\nelse if (!strcmp (*args, "-from"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nfrom = *++args;\r\n}\r\nelse if (!strcmp (*args, "-subject"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nsubject = *++args;\r\n}\r\nelse if (!strcmp (*args, "-signer"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nif (signerfile)\r\n{\r\nif (!sksigners)\r\nsksigners = sk_OPENSSL_STRING_new_null();\r\nsk_OPENSSL_STRING_push(sksigners, signerfile);\r\nif (!keyfile)\r\nkeyfile = signerfile;\r\nif (!skkeys)\r\nskkeys = sk_OPENSSL_STRING_new_null();\r\nsk_OPENSSL_STRING_push(skkeys, keyfile);\r\nkeyfile = NULL;\r\n}\r\nsignerfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-recip"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nrecipfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-md"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nsign_md = EVP_get_digestbyname(*++args);\r\nif (sign_md == NULL)\r\n{\r\nBIO_printf(bio_err, "Unknown digest %s\n",\r\n*args);\r\ngoto argerr;\r\n}\r\n}\r\nelse if (!strcmp (*args, "-inkey"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nif (keyfile)\r\n{\r\nif (!signerfile)\r\n{\r\nBIO_puts(bio_err, "Illegal -inkey without -signer\n");\r\ngoto argerr;\r\n}\r\nif (!sksigners)\r\nsksigners = sk_OPENSSL_STRING_new_null();\r\nsk_OPENSSL_STRING_push(sksigners, signerfile);\r\nsignerfile = NULL;\r\nif (!skkeys)\r\nskkeys = sk_OPENSSL_STRING_new_null();\r\nsk_OPENSSL_STRING_push(skkeys, keyfile);\r\n}\r\nkeyfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-keyform"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nkeyform = str2fmt(*++args);\r\n}\r\nelse if (!strcmp (*args, "-certfile"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\ncertfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-CAfile"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nCAfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-CApath"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\nCApath = *++args;\r\n}\r\nelse if (!strcmp (*args, "-in"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\ninfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-inform"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\ninformat = str2fmt(*++args);\r\n}\r\nelse if (!strcmp (*args, "-outform"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\noutformat = str2fmt(*++args);\r\n}\r\nelse if (!strcmp (*args, "-out"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\noutfile = *++args;\r\n}\r\nelse if (!strcmp (*args, "-content"))\r\n{\r\nif (!args[1])\r\ngoto argerr;\r\ncontfile = *++args;\r\n}\r\nelse if (args_verify(&args, NULL, &badarg, bio_err, &vpm))\r\ncontinue;\r\nelse if ((cipher = EVP_get_cipherbyname(*args + 1)) == NULL)\r\nbadarg = 1;\r\nargs++;\r\n}\r\nif (!(operation & SMIME_SIGNERS) && (skkeys || sksigners))\r\n{\r\nBIO_puts(bio_err, "Multiple signers or keys not allowed\n");\r\ngoto argerr;\r\n}\r\nif (operation & SMIME_SIGNERS)\r\n{\r\nif (keyfile && !signerfile)\r\n{\r\nBIO_puts(bio_err, "Illegal -inkey without -signer\n");\r\ngoto argerr;\r\n}\r\nif (signerfile)\r\n{\r\nif (!sksigners)\r\nsksigners = sk_OPENSSL_STRING_new_null();\r\nsk_OPENSSL_STRING_push(sksigners, signerfile);\r\nif (!skkeys)\r\nskkeys = sk_OPENSSL_STRING_new_null();\r\nif (!keyfile)\r\nkeyfile = signerfile;\r\nsk_OPENSSL_STRING_push(skkeys, keyfile);\r\n}\r\nif (!sksigners)\r\n{\r\nBIO_printf(bio_err, "No signer certificate specified\n");\r\nbadarg = 1;\r\n}\r\nsignerfile = NULL;\r\nkeyfile = NULL;\r\nneed_rand = 1;\r\n}\r\nelse if (operation == SMIME_DECRYPT)\r\n{\r\nif (!recipfile && !keyfile)\r\n{\r\nBIO_printf(bio_err, "No recipient certificate or key specified\n");\r\nbadarg = 1;\r\n}\r\n}\r\nelse if (operation == SMIME_ENCRYPT)\r\n{\r\nif (!*args)\r\n{\r\nBIO_printf(bio_err, "No recipient(s) certificate(s) specified\n");\r\nbadarg = 1;\r\n}\r\nneed_rand = 1;\r\n}\r\nelse if (!operation)\r\nbadarg = 1;\r\nif (badarg)\r\n{\r\nargerr:\r\nBIO_printf (bio_err, "Usage smime [options] cert.pem ...\n");\r\nBIO_printf (bio_err, "where options are\n");\r\nBIO_printf (bio_err, "-encrypt encrypt message\n");\r\nBIO_printf (bio_err, "-decrypt decrypt encrypted message\n");\r\nBIO_printf (bio_err, "-sign sign message\n");\r\nBIO_printf (bio_err, "-verify verify signed message\n");\r\nBIO_printf (bio_err, "-pk7out output PKCS#7 structure\n");\r\n#ifndef OPENSSL_NO_DES\r\nBIO_printf (bio_err, "-des3 encrypt with triple DES\n");\r\nBIO_printf (bio_err, "-des encrypt with DES\n");\r\n#endif\r\n#ifndef OPENSSL_NO_SEED\r\nBIO_printf (bio_err, "-seed encrypt with SEED\n");\r\n#endif\r\n#ifndef OPENSSL_NO_RC2\r\nBIO_printf (bio_err, "-rc2-40 encrypt with RC2-40 (default)\n");\r\nBIO_printf (bio_err, "-rc2-64 encrypt with RC2-64\n");\r\nBIO_printf (bio_err, "-rc2-128 encrypt with RC2-128\n");\r\n#endif\r\n#ifndef OPENSSL_NO_AES\r\nBIO_printf (bio_err, "-aes128, -aes192, -aes256\n");\r\nBIO_printf (bio_err, " encrypt PEM output with cbc aes\n");\r\n#endif\r\n#ifndef OPENSSL_NO_CAMELLIA\r\nBIO_printf (bio_err, "-camellia128, -camellia192, -camellia256\n");\r\nBIO_printf (bio_err, " encrypt PEM output with cbc camellia\n");\r\n#endif\r\nBIO_printf (bio_err, "-nointern don't search certificates in message for signer\n");\r\nBIO_printf (bio_err, "-nosigs don't verify message signature\n");\r\nBIO_printf (bio_err, "-noverify don't verify signers certificate\n");\r\nBIO_printf (bio_err, "-nocerts don't include signers certificate when signing\n");\r\nBIO_printf (bio_err, "-nodetach use opaque signing\n");\r\nBIO_printf (bio_err, "-noattr don't include any signed attributes\n");\r\nBIO_printf (bio_err, "-binary don't translate message to text\n");\r\nBIO_printf (bio_err, "-certfile file other certificates file\n");\r\nBIO_printf (bio_err, "-signer file signer certificate file\n");\r\nBIO_printf (bio_err, "-recip file recipient certificate file for decryption\n");\r\nBIO_printf (bio_err, "-in file input file\n");\r\nBIO_printf (bio_err, "-inform arg input format SMIME (default), PEM or DER\n");\r\nBIO_printf (bio_err, "-inkey file input private key (if not signer or recipient)\n");\r\nBIO_printf (bio_err, "-keyform arg input private key format (PEM or ENGINE)\n");\r\nBIO_printf (bio_err, "-out file output file\n");\r\nBIO_printf (bio_err, "-outform arg output format SMIME (default), PEM or DER\n");\r\nBIO_printf (bio_err, "-content file supply or override content for detached signature\n");\r\nBIO_printf (bio_err, "-to addr to address\n");\r\nBIO_printf (bio_err, "-from ad from address\n");\r\nBIO_printf (bio_err, "-subject s subject\n");\r\nBIO_printf (bio_err, "-text include or delete text MIME headers\n");\r\nBIO_printf (bio_err, "-CApath dir trusted certificates directory\n");\r\nBIO_printf (bio_err, "-CAfile file trusted certificates file\n");\r\nBIO_printf (bio_err, "-crl_check check revocation status of signer's certificate using CRLs\n");\r\nBIO_printf (bio_err, "-crl_check_all check revocation status of signer's certificate chain using CRLs\n");\r\n#ifndef OPENSSL_NO_ENGINE\r\nBIO_printf (bio_err, "-engine e use engine e, possibly a hardware device.\n");\r\n#endif\r\nBIO_printf (bio_err, "-passin arg input file pass phrase source\n");\r\nBIO_printf(bio_err, "-rand file%cfile%c...\n", LIST_SEPARATOR_CHAR, LIST_SEPARATOR_CHAR);\r\nBIO_printf(bio_err, " load the file (or the files in the directory) into\n");\r\nBIO_printf(bio_err, " the random number generator\n");\r\nBIO_printf (bio_err, "cert.pem recipient certificate(s) for encryption\n");\r\ngoto end;\r\n}\r\n#ifndef OPENSSL_NO_ENGINE\r\ne = setup_engine(bio_err, engine, 0);\r\n#endif\r\nif (!app_passwd(bio_err, passargin, NULL, &passin, NULL))\r\n{\r\nBIO_printf(bio_err, "Error getting password\n");\r\ngoto end;\r\n}\r\nif (need_rand)\r\n{\r\napp_RAND_load_file(NULL, bio_err, (inrand != NULL));\r\nif (inrand != NULL)\r\nBIO_printf(bio_err,"%ld semi-random bytes loaded\n",\r\napp_RAND_load_files(inrand));\r\n}\r\nret = 2;\r\nif (!(operation & SMIME_SIGNERS))\r\nflags &= ~PKCS7_DETACHED;\r\nif (operation & SMIME_OP)\r\n{\r\nif (outformat == FORMAT_ASN1)\r\noutmode = "wb";\r\n}\r\nelse\r\n{\r\nif (flags & PKCS7_BINARY)\r\noutmode = "wb";\r\n}\r\nif (operation & SMIME_IP)\r\n{\r\nif (informat == FORMAT_ASN1)\r\ninmode = "rb";\r\n}\r\nelse\r\n{\r\nif (flags & PKCS7_BINARY)\r\ninmode = "rb";\r\n}\r\nif (operation == SMIME_ENCRYPT)\r\n{\r\nif (!cipher)\r\n{\r\n#ifndef OPENSSL_NO_RC2\r\ncipher = EVP_rc2_40_cbc();\r\n#else\r\nBIO_printf(bio_err, "No cipher selected\n");\r\ngoto end;\r\n#endif\r\n}\r\nencerts = sk_X509_new_null();\r\nwhile (*args)\r\n{\r\nif (!(cert = load_cert(bio_err,*args,FORMAT_PEM,\r\nNULL, e, "recipient certificate file")))\r\n{\r\n#if 0\r\nBIO_printf(bio_err, "Can't read recipient certificate file %s\n", *args);\r\n#endif\r\ngoto end;\r\n}\r\nsk_X509_push(encerts, cert);\r\ncert = NULL;\r\nargs++;\r\n}\r\n}\r\nif (certfile)\r\n{\r\nif (!(other = load_certs(bio_err,certfile,FORMAT_PEM, NULL,\r\ne, "certificate file")))\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif (recipfile && (operation == SMIME_DECRYPT))\r\n{\r\nif (!(recip = load_cert(bio_err,recipfile,FORMAT_PEM,NULL,\r\ne, "recipient certificate file")))\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif (operation == SMIME_DECRYPT)\r\n{\r\nif (!keyfile)\r\nkeyfile = recipfile;\r\n}\r\nelse if (operation == SMIME_SIGN)\r\n{\r\nif (!keyfile)\r\nkeyfile = signerfile;\r\n}\r\nelse keyfile = NULL;\r\nif (keyfile)\r\n{\r\nkey = load_key(bio_err, keyfile, keyform, 0, passin, e,\r\n"signing key file");\r\nif (!key)\r\ngoto end;\r\n}\r\nif (infile)\r\n{\r\nif (!(in = BIO_new_file(infile, inmode)))\r\n{\r\nBIO_printf (bio_err,\r\n"Can't open input file %s\n", infile);\r\ngoto end;\r\n}\r\n}\r\nelse\r\nin = BIO_new_fp(stdin, BIO_NOCLOSE);\r\nif (operation & SMIME_IP)\r\n{\r\nif (informat == FORMAT_SMIME)\r\np7 = SMIME_read_PKCS7(in, &indata);\r\nelse if (informat == FORMAT_PEM)\r\np7 = PEM_read_bio_PKCS7(in, NULL, NULL, NULL);\r\nelse if (informat == FORMAT_ASN1)\r\np7 = d2i_PKCS7_bio(in, NULL);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad input format for PKCS#7 file\n");\r\ngoto end;\r\n}\r\nif (!p7)\r\n{\r\nBIO_printf(bio_err, "Error reading S/MIME message\n");\r\ngoto end;\r\n}\r\nif (contfile)\r\n{\r\nBIO_free(indata);\r\nif (!(indata = BIO_new_file(contfile, "rb")))\r\n{\r\nBIO_printf(bio_err, "Can't read content file %s\n", contfile);\r\ngoto end;\r\n}\r\n}\r\n}\r\nif (outfile)\r\n{\r\nif (!(out = BIO_new_file(outfile, outmode)))\r\n{\r\nBIO_printf (bio_err,\r\n"Can't open output file %s\n", outfile);\r\ngoto end;\r\n}\r\n}\r\nelse\r\n{\r\nout = BIO_new_fp(stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nif (operation == SMIME_VERIFY)\r\n{\r\nif (!(store = setup_verify(bio_err, CAfile, CApath)))\r\ngoto end;\r\nX509_STORE_set_verify_cb(store, smime_cb);\r\nif (vpm)\r\nX509_STORE_set1_param(store, vpm);\r\n}\r\nret = 3;\r\nif (operation == SMIME_ENCRYPT)\r\n{\r\nif (indef)\r\nflags |= PKCS7_STREAM;\r\np7 = PKCS7_encrypt(encerts, in, cipher, flags);\r\n}\r\nelse if (operation & SMIME_SIGNERS)\r\n{\r\nint i;\r\nif (operation == SMIME_SIGN)\r\n{\r\nif (flags & PKCS7_DETACHED)\r\n{\r\nif (outformat == FORMAT_SMIME)\r\nflags |= PKCS7_STREAM;\r\n}\r\nelse if (indef)\r\nflags |= PKCS7_STREAM;\r\nflags |= PKCS7_PARTIAL;\r\np7 = PKCS7_sign(NULL, NULL, other, in, flags);\r\nif (!p7)\r\ngoto end;\r\n}\r\nelse\r\nflags |= PKCS7_REUSE_DIGEST;\r\nfor (i = 0; i < sk_OPENSSL_STRING_num(sksigners); i++)\r\n{\r\nsignerfile = sk_OPENSSL_STRING_value(sksigners, i);\r\nkeyfile = sk_OPENSSL_STRING_value(skkeys, i);\r\nsigner = load_cert(bio_err, signerfile,FORMAT_PEM, NULL,\r\ne, "signer certificate");\r\nif (!signer)\r\ngoto end;\r\nkey = load_key(bio_err, keyfile, keyform, 0, passin, e,\r\n"signing key file");\r\nif (!key)\r\ngoto end;\r\nif (!PKCS7_sign_add_signer(p7, signer, key,\r\nsign_md, flags))\r\ngoto end;\r\nX509_free(signer);\r\nsigner = NULL;\r\nEVP_PKEY_free(key);\r\nkey = NULL;\r\n}\r\nif ((operation == SMIME_SIGN) && !(flags & PKCS7_STREAM))\r\n{\r\nif (!PKCS7_final(p7, in, flags))\r\ngoto end;\r\n}\r\n}\r\nif (!p7)\r\n{\r\nBIO_printf(bio_err, "Error creating PKCS#7 structure\n");\r\ngoto end;\r\n}\r\nret = 4;\r\nif (operation == SMIME_DECRYPT)\r\n{\r\nif (!PKCS7_decrypt(p7, key, recip, out, flags))\r\n{\r\nBIO_printf(bio_err, "Error decrypting PKCS#7 structure\n");\r\ngoto end;\r\n}\r\n}\r\nelse if (operation == SMIME_VERIFY)\r\n{\r\nSTACK_OF(X509) *signers;\r\nif (PKCS7_verify(p7, other, store, indata, out, flags))\r\nBIO_printf(bio_err, "Verification successful\n");\r\nelse\r\n{\r\nBIO_printf(bio_err, "Verification failure\n");\r\ngoto end;\r\n}\r\nsigners = PKCS7_get0_signers(p7, other, flags);\r\nif (!save_certs(signerfile, signers))\r\n{\r\nBIO_printf(bio_err, "Error writing signers to %s\n",\r\nsignerfile);\r\nret = 5;\r\ngoto end;\r\n}\r\nsk_X509_free(signers);\r\n}\r\nelse if (operation == SMIME_PK7OUT)\r\nPEM_write_bio_PKCS7(out, p7);\r\nelse\r\n{\r\nif (to)\r\nBIO_printf(out, "To: %s\n", to);\r\nif (from)\r\nBIO_printf(out, "From: %s\n", from);\r\nif (subject)\r\nBIO_printf(out, "Subject: %s\n", subject);\r\nif (outformat == FORMAT_SMIME)\r\n{\r\nif (operation == SMIME_RESIGN)\r\nSMIME_write_PKCS7(out, p7, indata, flags);\r\nelse\r\nSMIME_write_PKCS7(out, p7, in, flags);\r\n}\r\nelse if (outformat == FORMAT_PEM)\r\nPEM_write_bio_PKCS7_stream(out, p7, in, flags);\r\nelse if (outformat == FORMAT_ASN1)\r\ni2d_PKCS7_bio_stream(out,p7, in, flags);\r\nelse\r\n{\r\nBIO_printf(bio_err, "Bad output format for PKCS#7 file\n");\r\ngoto end;\r\n}\r\n}\r\nret = 0;\r\nend:\r\nif (need_rand)\r\napp_RAND_write_file(NULL, bio_err);\r\nif (ret) ERR_print_errors(bio_err);\r\nsk_X509_pop_free(encerts, X509_free);\r\nsk_X509_pop_free(other, X509_free);\r\nif (vpm)\r\nX509_VERIFY_PARAM_free(vpm);\r\nif (sksigners)\r\nsk_OPENSSL_STRING_free(sksigners);\r\nif (skkeys)\r\nsk_OPENSSL_STRING_free(skkeys);\r\nX509_STORE_free(store);\r\nX509_free(cert);\r\nX509_free(recip);\r\nX509_free(signer);\r\nEVP_PKEY_free(key);\r\nPKCS7_free(p7);\r\nBIO_free(in);\r\nBIO_free(indata);\r\nBIO_free_all(out);\r\nif (passin) OPENSSL_free(passin);\r\nreturn (ret);\r\n}\r\nstatic int smime_cb(int ok, X509_STORE_CTX *ctx)\r\n{\r\nint error;\r\nerror = X509_STORE_CTX_get_error(ctx);\r\nif ((error != X509_V_ERR_NO_EXPLICIT_POLICY)\r\n&& ((error != X509_V_OK) || (ok != 2)))\r\nreturn ok;\r\npolicies_print(NULL, ctx);\r\nreturn ok;\r\n}

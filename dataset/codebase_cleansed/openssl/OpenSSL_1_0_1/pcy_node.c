static int node_cmp(const X509_POLICY_NODE * const *a,\r\nconst X509_POLICY_NODE * const *b)\r\n{\r\nreturn OBJ_cmp((*a)->data->valid_policy, (*b)->data->valid_policy);\r\n}\r\nX509_POLICY_NODE *level_find_node(const X509_POLICY_LEVEL *level,\r\nconst X509_POLICY_NODE *parent,\r\nconst ASN1_OBJECT *id)\r\n{\r\nX509_POLICY_NODE *node;\r\nint i;\r\nfor (i = 0; i < sk_X509_POLICY_NODE_num(level->nodes); i++)\r\n{\r\nnode = sk_X509_POLICY_NODE_value(level->nodes, i);\r\nif (node->parent == parent)\r\n{\r\nif (!OBJ_cmp(node->data->valid_policy, id))\r\nreturn node;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nX509_POLICY_NODE *level_add_node(X509_POLICY_LEVEL *level,\r\nconst X509_POLICY_DATA *data,\r\nX509_POLICY_NODE *parent,\r\nX509_POLICY_TREE *tree)\r\n{\r\nX509_POLICY_NODE *node;\r\nnode = OPENSSL_malloc(sizeof(X509_POLICY_NODE));\r\nif (!node)\r\nreturn NULL;\r\nnode->data = data;\r\nnode->parent = parent;\r\nnode->nchild = 0;\r\nif (level)\r\n{\r\nif (OBJ_obj2nid(data->valid_policy) == NID_any_policy)\r\n{\r\nif (level->anyPolicy)\r\ngoto node_error;\r\nlevel->anyPolicy = node;\r\n}\r\nelse\r\n{\r\nif (!level->nodes)\r\nlevel->nodes = policy_node_cmp_new();\r\nif (!level->nodes)\r\ngoto node_error;\r\nif (!sk_X509_POLICY_NODE_push(level->nodes, node))\r\ngoto node_error;\r\n}\r\n}\r\nif (tree)\r\n{\r\nif (!tree->extra_data)\r\ntree->extra_data = sk_X509_POLICY_DATA_new_null();\r\nif (!tree->extra_data)\r\ngoto node_error;\r\nif (!sk_X509_POLICY_DATA_push(tree->extra_data, data))\r\ngoto node_error;\r\n}\r\nif (parent)\r\nparent->nchild++;\r\nreturn node;\r\nnode_error:\r\npolicy_node_free(node);\r\nreturn 0;\r\n}\r\nvoid policy_node_free(X509_POLICY_NODE *node)\r\n{\r\nOPENSSL_free(node);\r\n}\r\nint policy_node_match(const X509_POLICY_LEVEL *lvl,\r\nconst X509_POLICY_NODE *node, const ASN1_OBJECT *oid)\r\n{\r\nint i;\r\nASN1_OBJECT *policy_oid;\r\nconst X509_POLICY_DATA *x = node->data;\r\nif ( (lvl->flags & X509_V_FLAG_INHIBIT_MAP)\r\n|| !(x->flags & POLICY_DATA_FLAG_MAP_MASK))\r\n{\r\nif (!OBJ_cmp(x->valid_policy, oid))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nfor (i = 0; i < sk_ASN1_OBJECT_num(x->expected_policy_set); i++)\r\n{\r\npolicy_oid = sk_ASN1_OBJECT_value(x->expected_policy_set, i);\r\nif (!OBJ_cmp(policy_oid, oid))\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

void ENGINE_unregister_pkey_asn1_meths(ENGINE *e)\r\n{\r\nengine_table_unregister(&pkey_asn1_meth_table, e);\r\n}\r\nstatic void engine_unregister_all_pkey_asn1_meths(void)\r\n{\r\nengine_table_cleanup(&pkey_asn1_meth_table);\r\n}\r\nint ENGINE_register_pkey_asn1_meths(ENGINE *e)\r\n{\r\nif(e->pkey_asn1_meths)\r\n{\r\nconst int *nids;\r\nint num_nids = e->pkey_asn1_meths(e, NULL, &nids, 0);\r\nif(num_nids > 0)\r\nreturn engine_table_register(&pkey_asn1_meth_table,\r\nengine_unregister_all_pkey_asn1_meths, e, nids,\r\nnum_nids, 0);\r\n}\r\nreturn 1;\r\n}\r\nvoid ENGINE_register_all_pkey_asn1_meths(void)\r\n{\r\nENGINE *e;\r\nfor(e=ENGINE_get_first() ; e ; e=ENGINE_get_next(e))\r\nENGINE_register_pkey_asn1_meths(e);\r\n}\r\nint ENGINE_set_default_pkey_asn1_meths(ENGINE *e)\r\n{\r\nif(e->pkey_asn1_meths)\r\n{\r\nconst int *nids;\r\nint num_nids = e->pkey_asn1_meths(e, NULL, &nids, 0);\r\nif(num_nids > 0)\r\nreturn engine_table_register(&pkey_asn1_meth_table,\r\nengine_unregister_all_pkey_asn1_meths, e, nids,\r\nnum_nids, 1);\r\n}\r\nreturn 1;\r\n}\r\nENGINE *ENGINE_get_pkey_asn1_meth_engine(int nid)\r\n{\r\nreturn engine_table_select(&pkey_asn1_meth_table, nid);\r\n}\r\nconst EVP_PKEY_ASN1_METHOD *ENGINE_get_pkey_asn1_meth(ENGINE *e, int nid)\r\n{\r\nEVP_PKEY_ASN1_METHOD *ret;\r\nENGINE_PKEY_ASN1_METHS_PTR fn = ENGINE_get_pkey_asn1_meths(e);\r\nif(!fn || !fn(e, &ret, NULL, nid))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_GET_PKEY_ASN1_METH,\r\nENGINE_R_UNIMPLEMENTED_PUBLIC_KEY_METHOD);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nENGINE_PKEY_ASN1_METHS_PTR ENGINE_get_pkey_asn1_meths(const ENGINE *e)\r\n{\r\nreturn e->pkey_asn1_meths;\r\n}\r\nint ENGINE_set_pkey_asn1_meths(ENGINE *e, ENGINE_PKEY_ASN1_METHS_PTR f)\r\n{\r\ne->pkey_asn1_meths = f;\r\nreturn 1;\r\n}\r\nvoid engine_pkey_asn1_meths_free(ENGINE *e)\r\n{\r\nint i;\r\nEVP_PKEY_ASN1_METHOD *pkm;\r\nif (e->pkey_asn1_meths)\r\n{\r\nconst int *pknids;\r\nint npknids;\r\nnpknids = e->pkey_asn1_meths(e, NULL, &pknids, 0);\r\nfor (i = 0; i < npknids; i++)\r\n{\r\nif (e->pkey_asn1_meths(e, &pkm, NULL, pknids[i]))\r\n{\r\nEVP_PKEY_asn1_free(pkm);\r\n}\r\n}\r\n}\r\n}\r\nconst EVP_PKEY_ASN1_METHOD *ENGINE_get_pkey_asn1_meth_str(ENGINE *e,\r\nconst char *str, int len)\r\n{\r\nint i, nidcount;\r\nconst int *nids;\r\nEVP_PKEY_ASN1_METHOD *ameth;\r\nif (!e->pkey_asn1_meths)\r\nreturn NULL;\r\nif (len == -1)\r\nlen = strlen(str);\r\nnidcount = e->pkey_asn1_meths(e, NULL, &nids, 0);\r\nfor (i = 0; i < nidcount; i++)\r\n{\r\ne->pkey_asn1_meths(e, &ameth, NULL, nids[i]);\r\nif (((int)strlen(ameth->pem_str) == len) &&\r\n!strncasecmp(ameth->pem_str, str, len))\r\nreturn ameth;\r\n}\r\nreturn NULL;\r\n}\r\nconst EVP_PKEY_ASN1_METHOD *ENGINE_pkey_asn1_find_str(ENGINE **pe,\r\nconst char *str, int len)\r\n{\r\nENGINE_FIND_STR fstr;\r\nfstr.e = NULL;\r\nfstr.ameth = NULL;\r\nfstr.str = str;\r\nfstr.len = len;\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nengine_table_doall(pkey_asn1_meth_table, look_str_cb, &fstr);\r\nif (fstr.e)\r\n{\r\nfstr.e->struct_ref++;\r\nengine_ref_debug(fstr.e, 0, 1)\r\n}\r\n*pe = fstr.e;\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nreturn fstr.ameth;\r\n}

void DES_xcbc_encrypt(const unsigned char *in, unsigned char *out,\r\nlong length, DES_key_schedule *schedule,\r\nDES_cblock *ivec, const_DES_cblock *inw,\r\nconst_DES_cblock *outw, int enc)\r\n{\r\nregister DES_LONG tin0,tin1;\r\nregister DES_LONG tout0,tout1,xor0,xor1;\r\nregister DES_LONG inW0,inW1,outW0,outW1;\r\nregister const unsigned char *in2;\r\nregister long l=length;\r\nDES_LONG tin[2];\r\nunsigned char *iv;\r\nin2 = &(*inw)[0];\r\nc2l(in2,inW0);\r\nc2l(in2,inW1);\r\nin2 = &(*outw)[0];\r\nc2l(in2,outW0);\r\nc2l(in2,outW1);\r\niv = &(*ivec)[0];\r\nif (enc)\r\n{\r\nc2l(iv,tout0);\r\nc2l(iv,tout1);\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\ntin0^=tout0^inW0; tin[0]=tin0;\r\ntin1^=tout1^inW1; tin[1]=tin1;\r\nDES_encrypt1(tin,schedule,DES_ENCRYPT);\r\ntout0=tin[0]^outW0; l2c(tout0,out);\r\ntout1=tin[1]^outW1; l2c(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nc2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0^inW0; tin[0]=tin0;\r\ntin1^=tout1^inW1; tin[1]=tin1;\r\nDES_encrypt1(tin,schedule,DES_ENCRYPT);\r\ntout0=tin[0]^outW0; l2c(tout0,out);\r\ntout1=tin[1]^outW1; l2c(tout1,out);\r\n}\r\niv = &(*ivec)[0];\r\nl2c(tout0,iv);\r\nl2c(tout1,iv);\r\n}\r\nelse\r\n{\r\nc2l(iv,xor0);\r\nc2l(iv,xor1);\r\nfor (l-=8; l>0; l-=8)\r\n{\r\nc2l(in,tin0); tin[0]=tin0^outW0;\r\nc2l(in,tin1); tin[1]=tin1^outW1;\r\nDES_encrypt1(tin,schedule,DES_DECRYPT);\r\ntout0=tin[0]^xor0^inW0;\r\ntout1=tin[1]^xor1^inW1;\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nif (l != -8)\r\n{\r\nc2l(in,tin0); tin[0]=tin0^outW0;\r\nc2l(in,tin1); tin[1]=tin1^outW1;\r\nDES_encrypt1(tin,schedule,DES_DECRYPT);\r\ntout0=tin[0]^xor0^inW0;\r\ntout1=tin[1]^xor1^inW1;\r\nl2cn(tout0,tout1,out,l+8);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\niv = &(*ivec)[0];\r\nl2c(xor0,iv);\r\nl2c(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ninW0=inW1=outW0=outW1=0;\r\ntin[0]=tin[1]=0;\r\n}

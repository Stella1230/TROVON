static int tr_cmp(const X509_TRUST * const *a,\r\nconst X509_TRUST * const *b)\r\n{\r\nreturn (*a)->trust - (*b)->trust;\r\n}\r\nint X509_check_trust(X509 *x, int id, int flags)\r\n{\r\nX509_TRUST *pt;\r\nint idx;\r\nif(id == -1) return 1;\r\nidx = X509_TRUST_get_by_id(id);\r\nif(idx == -1) return default_trust(id, x, flags);\r\npt = X509_TRUST_get0(idx);\r\nreturn pt->check_trust(pt, x, flags);\r\n}\r\nint X509_TRUST_get_count(void)\r\n{\r\nif(!trtable) return X509_TRUST_COUNT;\r\nreturn sk_X509_TRUST_num(trtable) + X509_TRUST_COUNT;\r\n}\r\nX509_TRUST * X509_TRUST_get0(int idx)\r\n{\r\nif(idx < 0) return NULL;\r\nif(idx < (int)X509_TRUST_COUNT) return trstandard + idx;\r\nreturn sk_X509_TRUST_value(trtable, idx - X509_TRUST_COUNT);\r\n}\r\nint X509_TRUST_get_by_id(int id)\r\n{\r\nX509_TRUST tmp;\r\nint idx;\r\nif((id >= X509_TRUST_MIN) && (id <= X509_TRUST_MAX))\r\nreturn id - X509_TRUST_MIN;\r\ntmp.trust = id;\r\nif(!trtable) return -1;\r\nidx = sk_X509_TRUST_find(trtable, &tmp);\r\nif(idx == -1) return -1;\r\nreturn idx + X509_TRUST_COUNT;\r\n}\r\nint X509_TRUST_set(int *t, int trust)\r\n{\r\nif(X509_TRUST_get_by_id(trust) == -1) {\r\nX509err(X509_F_X509_TRUST_SET, X509_R_INVALID_TRUST);\r\nreturn 0;\r\n}\r\n*t = trust;\r\nreturn 1;\r\n}\r\nint X509_TRUST_add(int id, int flags, int (*ck)(X509_TRUST *, X509 *, int),\r\nchar *name, int arg1, void *arg2)\r\n{\r\nint idx;\r\nX509_TRUST *trtmp;\r\nflags &= ~X509_TRUST_DYNAMIC;\r\nflags |= X509_TRUST_DYNAMIC_NAME;\r\nidx = X509_TRUST_get_by_id(id);\r\nif(idx == -1) {\r\nif(!(trtmp = OPENSSL_malloc(sizeof(X509_TRUST)))) {\r\nX509err(X509_F_X509_TRUST_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\ntrtmp->flags = X509_TRUST_DYNAMIC;\r\n} else trtmp = X509_TRUST_get0(idx);\r\nif(trtmp->flags & X509_TRUST_DYNAMIC_NAME) OPENSSL_free(trtmp->name);\r\nif(!(trtmp->name = BUF_strdup(name))) {\r\nX509err(X509_F_X509_TRUST_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\ntrtmp->flags &= X509_TRUST_DYNAMIC;\r\ntrtmp->flags |= flags;\r\ntrtmp->trust = id;\r\ntrtmp->check_trust = ck;\r\ntrtmp->arg1 = arg1;\r\ntrtmp->arg2 = arg2;\r\nif(idx == -1) {\r\nif(!trtable && !(trtable = sk_X509_TRUST_new(tr_cmp))) {\r\nX509err(X509_F_X509_TRUST_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nif (!sk_X509_TRUST_push(trtable, trtmp)) {\r\nX509err(X509_F_X509_TRUST_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic void trtable_free(X509_TRUST *p)\r\n{\r\nif(!p) return;\r\nif (p->flags & X509_TRUST_DYNAMIC)\r\n{\r\nif (p->flags & X509_TRUST_DYNAMIC_NAME)\r\nOPENSSL_free(p->name);\r\nOPENSSL_free(p);\r\n}\r\n}\r\nvoid X509_TRUST_cleanup(void)\r\n{\r\nunsigned int i;\r\nfor(i = 0; i < X509_TRUST_COUNT; i++) trtable_free(trstandard + i);\r\nsk_X509_TRUST_pop_free(trtable, trtable_free);\r\ntrtable = NULL;\r\n}\r\nint X509_TRUST_get_flags(X509_TRUST *xp)\r\n{\r\nreturn xp->flags;\r\n}\r\nchar *X509_TRUST_get0_name(X509_TRUST *xp)\r\n{\r\nreturn xp->name;\r\n}\r\nint X509_TRUST_get_trust(X509_TRUST *xp)\r\n{\r\nreturn xp->trust;\r\n}\r\nstatic int trust_1oidany(X509_TRUST *trust, X509 *x, int flags)\r\n{\r\nif(x->aux && (x->aux->trust || x->aux->reject))\r\nreturn obj_trust(trust->arg1, x, flags);\r\nreturn trust_compat(trust, x, flags);\r\n}\r\nstatic int trust_1oid(X509_TRUST *trust, X509 *x, int flags)\r\n{\r\nif(x->aux) return obj_trust(trust->arg1, x, flags);\r\nreturn X509_TRUST_UNTRUSTED;\r\n}\r\nstatic int trust_compat(X509_TRUST *trust, X509 *x, int flags)\r\n{\r\nX509_check_purpose(x, -1, 0);\r\nif(x->ex_flags & EXFLAG_SS) return X509_TRUST_TRUSTED;\r\nelse return X509_TRUST_UNTRUSTED;\r\n}\r\nstatic int obj_trust(int id, X509 *x, int flags)\r\n{\r\nASN1_OBJECT *obj;\r\nint i;\r\nX509_CERT_AUX *ax;\r\nax = x->aux;\r\nif(!ax) return X509_TRUST_UNTRUSTED;\r\nif(ax->reject) {\r\nfor(i = 0; i < sk_ASN1_OBJECT_num(ax->reject); i++) {\r\nobj = sk_ASN1_OBJECT_value(ax->reject, i);\r\nif(OBJ_obj2nid(obj) == id) return X509_TRUST_REJECTED;\r\n}\r\n}\r\nif(ax->trust) {\r\nfor(i = 0; i < sk_ASN1_OBJECT_num(ax->trust); i++) {\r\nobj = sk_ASN1_OBJECT_value(ax->trust, i);\r\nif(OBJ_obj2nid(obj) == id) return X509_TRUST_TRUSTED;\r\n}\r\n}\r\nreturn X509_TRUST_UNTRUSTED;\r\n}

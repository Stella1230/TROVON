int EC_GROUP_check(const EC_GROUP *group, BN_CTX *ctx)\r\n{\r\nint ret = 0;\r\nBIGNUM *order;\r\nBN_CTX *new_ctx = NULL;\r\nEC_POINT *point = NULL;\r\nif (ctx == NULL)\r\n{\r\nctx = new_ctx = BN_CTX_new();\r\nif (ctx == NULL)\r\n{\r\nECerr(EC_F_EC_GROUP_CHECK, ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\nBN_CTX_start(ctx);\r\nif ((order = BN_CTX_get(ctx)) == NULL) goto err;\r\nif (!EC_GROUP_check_discriminant(group, ctx))\r\n{\r\nECerr(EC_F_EC_GROUP_CHECK, EC_R_DISCRIMINANT_IS_ZERO);\r\ngoto err;\r\n}\r\nif (group->generator == NULL)\r\n{\r\nECerr(EC_F_EC_GROUP_CHECK, EC_R_UNDEFINED_GENERATOR);\r\ngoto err;\r\n}\r\nif (!EC_POINT_is_on_curve(group, group->generator, ctx))\r\n{\r\nECerr(EC_F_EC_GROUP_CHECK, EC_R_POINT_IS_NOT_ON_CURVE);\r\ngoto err;\r\n}\r\nif ((point = EC_POINT_new(group)) == NULL) goto err;\r\nif (!EC_GROUP_get_order(group, order, ctx)) goto err;\r\nif (BN_is_zero(order))\r\n{\r\nECerr(EC_F_EC_GROUP_CHECK, EC_R_UNDEFINED_ORDER);\r\ngoto err;\r\n}\r\nif (!EC_POINT_mul(group, point, order, NULL, NULL, ctx)) goto err;\r\nif (!EC_POINT_is_at_infinity(group, point))\r\n{\r\nECerr(EC_F_EC_GROUP_CHECK, EC_R_INVALID_GROUP_ORDER);\r\ngoto err;\r\n}\r\nret = 1;\r\nerr:\r\nif (ctx != NULL)\r\nBN_CTX_end(ctx);\r\nif (new_ctx != NULL)\r\nBN_CTX_free(new_ctx);\r\nif (point)\r\nEC_POINT_free(point);\r\nreturn ret;\r\n}

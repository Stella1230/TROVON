int main(argc,argv)\r\nint argc;\r\nchar **argv;\r\n{\r\nchar *strbuf=NULL;\r\nunsigned char *buff=NULL,*bufsize=NULL;\r\nint bsize=BSIZE,verbose=0;\r\nint ret=1,inl;\r\nchar *str=NULL;\r\nchar *hkey=NULL,*hiv=NULL;\r\nint enc=1,printkey=0,i,base64=0;\r\nint debug=0;\r\nEVP_CIPHER *cipher=NULL,*c;\r\nchar *inf=NULL,*outf=NULL;\r\nBIO *in=NULL,*out=NULL,*b64=NULL,*benc=NULL,*rbio=NULL,*wbio=NULL;\r\n#define PROG_NAME_SIZE 39\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE);\r\nbase64=1;\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-e") == 0)\r\nenc=1;\r\nif (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninf= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutf= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-d") == 0)\r\nenc=0;\r\nelse if (strcmp(*argv,"-v") == 0)\r\nverbose=1;\r\nelse if (strcmp(*argv,"-debug") == 0)\r\ndebug=1;\r\nelse if (strcmp(*argv,"-bufsize") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nbufsize=(unsigned char *)*(++argv);\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_err,"unknown option '%s'\n",*argv);\r\nbad:\r\nBIO_printf(bio_err,"options are\n");\r\nBIO_printf(bio_err,"%-14s input file\n","-in <file>");\r\nBIO_printf(bio_err,"%-14s output file\n","-out <file>");\r\nBIO_printf(bio_err,"%-14s encode\n","-e");\r\nBIO_printf(bio_err,"%-14s decode\n","-d");\r\nBIO_printf(bio_err,"%-14s buffer size\n","-bufsize <n>");\r\ngoto end;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (bufsize != NULL)\r\n{\r\nint i;\r\nunsigned long n;\r\nfor (n=0; *bufsize; bufsize++)\r\n{\r\ni= *bufsize;\r\nif ((i <= '9') && (i >= '0'))\r\nn=n*10+i-'0';\r\nelse if (i == 'k')\r\n{\r\nn*=1024;\r\nbufsize++;\r\nbreak;\r\n}\r\n}\r\nif (*bufsize != '\0')\r\n{\r\nBIO_printf(bio_err,"invalid 'bufsize' specified.\n");\r\ngoto end;\r\n}\r\nif (n < 80) n=80;\r\nbsize=(int)n;\r\nif (verbose) BIO_printf(bio_err,"bufsize=%d\n",bsize);\r\n}\r\nstrbuf=OPENSSL_malloc(SIZE);\r\nbuff=(unsigned char *)OPENSSL_malloc(EVP_ENCODE_LENGTH(bsize));\r\nif ((buff == NULL) || (strbuf == NULL))\r\n{\r\nBIO_printf(bio_err,"OPENSSL_malloc failure\n");\r\ngoto end;\r\n}\r\nin=BIO_new(BIO_s_file());\r\nout=BIO_new(BIO_s_file());\r\nif ((in == NULL) || (out == NULL))\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (debug)\r\n{\r\nBIO_set_callback(in,BIO_debug_callback);\r\nBIO_set_callback(out,BIO_debug_callback);\r\nBIO_set_callback_arg(in,bio_err);\r\nBIO_set_callback_arg(out,bio_err);\r\n}\r\nif (inf == NULL)\r\nBIO_set_fp(in,stdin,BIO_NOCLOSE);\r\nelse\r\n{\r\nif (BIO_read_filename(in,inf) <= 0)\r\n{\r\nperror(inf);\r\ngoto end;\r\n}\r\n}\r\nif (outf == NULL)\r\nBIO_set_fp(out,stdout,BIO_NOCLOSE);\r\nelse\r\n{\r\nif (BIO_write_filename(out,outf) <= 0)\r\n{\r\nperror(outf);\r\ngoto end;\r\n}\r\n}\r\nrbio=in;\r\nwbio=out;\r\nif (base64)\r\n{\r\nif ((b64=BIO_new(BIO_f_base64())) == NULL)\r\ngoto end;\r\nif (debug)\r\n{\r\nBIO_set_callback(b64,BIO_debug_callback);\r\nBIO_set_callback_arg(b64,bio_err);\r\n}\r\nif (enc)\r\nwbio=BIO_push(b64,wbio);\r\nelse\r\nrbio=BIO_push(b64,rbio);\r\n}\r\nfor (;;)\r\n{\r\ninl=BIO_read(rbio,(char *)buff,bsize);\r\nif (inl <= 0) break;\r\nif (BIO_write(wbio,(char *)buff,inl) != inl)\r\n{\r\nBIO_printf(bio_err,"error writing output file\n");\r\ngoto end;\r\n}\r\n}\r\nBIO_flush(wbio);\r\nret=0;\r\nif (verbose)\r\n{\r\nBIO_printf(bio_err,"bytes read :%8ld\n",BIO_number_read(in));\r\nBIO_printf(bio_err,"bytes written:%8ld\n",BIO_number_written(out));\r\n}\r\nend:\r\nif (strbuf != NULL) OPENSSL_free(strbuf);\r\nif (buff != NULL) OPENSSL_free(buff);\r\nif (in != NULL) BIO_free(in);\r\nif (out != NULL) BIO_free(out);\r\nif (benc != NULL) BIO_free(benc);\r\nif (b64 != NULL) BIO_free(b64);\r\nEXIT(ret);\r\n}

int BN_nnmod(BIGNUM *r, const BIGNUM *m, const BIGNUM *d, BN_CTX *ctx)\r\n{\r\nif (!(BN_mod(r,m,d,ctx)))\r\nreturn 0;\r\nif (!r->neg)\r\nreturn 1;\r\nreturn (d->neg ? BN_sub : BN_add)(r, r, d);\r\n}\r\nint BN_mod_add(BIGNUM *r, const BIGNUM *a, const BIGNUM *b, const BIGNUM *m, BN_CTX *ctx)\r\n{\r\nif (!BN_add(r, a, b)) return 0;\r\nreturn BN_nnmod(r, r, m, ctx);\r\n}\r\nint BN_mod_add_quick(BIGNUM *r, const BIGNUM *a, const BIGNUM *b, const BIGNUM *m)\r\n{\r\nif (!BN_uadd(r, a, b)) return 0;\r\nif (BN_ucmp(r, m) >= 0)\r\nreturn BN_usub(r, r, m);\r\nreturn 1;\r\n}\r\nint BN_mod_sub(BIGNUM *r, const BIGNUM *a, const BIGNUM *b, const BIGNUM *m, BN_CTX *ctx)\r\n{\r\nif (!BN_sub(r, a, b)) return 0;\r\nreturn BN_nnmod(r, r, m, ctx);\r\n}\r\nint BN_mod_sub_quick(BIGNUM *r, const BIGNUM *a, const BIGNUM *b, const BIGNUM *m)\r\n{\r\nif (!BN_sub(r, a, b)) return 0;\r\nif (r->neg)\r\nreturn BN_add(r, r, m);\r\nreturn 1;\r\n}\r\nint BN_mod_mul(BIGNUM *r, const BIGNUM *a, const BIGNUM *b, const BIGNUM *m,\r\nBN_CTX *ctx)\r\n{\r\nBIGNUM *t;\r\nint ret=0;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nbn_check_top(m);\r\nBN_CTX_start(ctx);\r\nif ((t = BN_CTX_get(ctx)) == NULL) goto err;\r\nif (a == b)\r\n{ if (!BN_sqr(t,a,ctx)) goto err; }\r\nelse\r\n{ if (!BN_mul(t,a,b,ctx)) goto err; }\r\nif (!BN_nnmod(r,t,m,ctx)) goto err;\r\nbn_check_top(r);\r\nret=1;\r\nerr:\r\nBN_CTX_end(ctx);\r\nreturn(ret);\r\n}\r\nint BN_mod_sqr(BIGNUM *r, const BIGNUM *a, const BIGNUM *m, BN_CTX *ctx)\r\n{\r\nif (!BN_sqr(r, a, ctx)) return 0;\r\nreturn BN_mod(r, r, m, ctx);\r\n}\r\nint BN_mod_lshift1(BIGNUM *r, const BIGNUM *a, const BIGNUM *m, BN_CTX *ctx)\r\n{\r\nif (!BN_lshift1(r, a)) return 0;\r\nbn_check_top(r);\r\nreturn BN_nnmod(r, r, m, ctx);\r\n}\r\nint BN_mod_lshift1_quick(BIGNUM *r, const BIGNUM *a, const BIGNUM *m)\r\n{\r\nif (!BN_lshift1(r, a)) return 0;\r\nbn_check_top(r);\r\nif (BN_cmp(r, m) >= 0)\r\nreturn BN_sub(r, r, m);\r\nreturn 1;\r\n}\r\nint BN_mod_lshift(BIGNUM *r, const BIGNUM *a, int n, const BIGNUM *m, BN_CTX *ctx)\r\n{\r\nBIGNUM *abs_m = NULL;\r\nint ret;\r\nif (!BN_nnmod(r, a, m, ctx)) return 0;\r\nif (m->neg)\r\n{\r\nabs_m = BN_dup(m);\r\nif (abs_m == NULL) return 0;\r\nabs_m->neg = 0;\r\n}\r\nret = BN_mod_lshift_quick(r, r, n, (abs_m ? abs_m : m));\r\nbn_check_top(r);\r\nif (abs_m)\r\nBN_free(abs_m);\r\nreturn ret;\r\n}\r\nint BN_mod_lshift_quick(BIGNUM *r, const BIGNUM *a, int n, const BIGNUM *m)\r\n{\r\nif (r != a)\r\n{\r\nif (BN_copy(r, a) == NULL) return 0;\r\n}\r\nwhile (n > 0)\r\n{\r\nint max_shift;\r\nmax_shift = BN_num_bits(m) - BN_num_bits(r);\r\nif (max_shift < 0)\r\n{\r\nBNerr(BN_F_BN_MOD_LSHIFT_QUICK, BN_R_INPUT_NOT_REDUCED);\r\nreturn 0;\r\n}\r\nif (max_shift > n)\r\nmax_shift = n;\r\nif (max_shift)\r\n{\r\nif (!BN_lshift(r, r, max_shift)) return 0;\r\nn -= max_shift;\r\n}\r\nelse\r\n{\r\nif (!BN_lshift1(r, r)) return 0;\r\n--n;\r\n}\r\nif (BN_cmp(r, m) >= 0)\r\n{\r\nif (!BN_sub(r, r, m)) return 0;\r\n}\r\n}\r\nbn_check_top(r);\r\nreturn 1;\r\n}

static DH *get_dh512(void)\r\n{\r\nDH *dh=NULL;\r\nif ((dh=DH_new()) == NULL) return(NULL);\r\ndh->p=BN_bin2bn(dh512_p,sizeof(dh512_p),NULL);\r\ndh->g=BN_bin2bn(dh512_g,sizeof(dh512_g),NULL);\r\nif ((dh->p == NULL) || (dh->g == NULL))\r\nreturn(NULL);\r\nreturn(dh);\r\n}\r\nstatic int usage(const char *errstr, int isunknownarg)\r\n{\r\nif(isunknownarg)\r\nfprintf(stderr, "Error: unknown argument '%s'\n", errstr);\r\nelse\r\nfprintf(stderr, "Error: %s\n", errstr);\r\nfprintf(stderr, "%s\n", helpstring);\r\nreturn 1;\r\n}\r\nstatic int err_str0(const char *str0)\r\n{\r\nfprintf(stderr, "%s\n", str0);\r\nreturn 1;\r\n}\r\nstatic int err_str1(const char *fmt, const char *str1)\r\n{\r\nfprintf(stderr, fmt, str1);\r\nfprintf(stderr, "\n");\r\nreturn 1;\r\n}\r\nstatic int parse_max_tunnels(const char *s, unsigned int *maxtunnels)\r\n{\r\nunsigned long l;\r\nif(!int_strtoul(s, &l) || (l < 1) || (l > 1024)) {\r\nfprintf(stderr, "Error, '%s' is an invalid value for "\r\n"maxtunnels\n", s);\r\nreturn 0;\r\n}\r\n*maxtunnels = (unsigned int)l;\r\nreturn 1;\r\n}\r\nstatic int parse_server_mode(const char *s, int *servermode)\r\n{\r\nunsigned long l;\r\nif(!int_strtoul(s, &l) || (l > 1)) {\r\nfprintf(stderr, "Error, '%s' is an invalid value for the "\r\n"server mode\n", s);\r\nreturn 0;\r\n}\r\n*servermode = (int)l;\r\nreturn 1;\r\n}\r\nstatic int parse_dh_special(const char *s, const char **dh_special)\r\n{\r\nif((strcmp(s, "NULL") == 0) || (strcmp(s, "generate") == 0) ||\r\n(strcmp(s, "standard") == 0)) {\r\n*dh_special = s;\r\nreturn 1;\r\n}\r\nfprintf(stderr, "Error, '%s' is an invalid value for 'dh_special'\n", s);\r\nreturn 0;\r\n}\r\nstatic int parse_verify_level(const char *s, unsigned int *verify_level)\r\n{\r\nunsigned long l;\r\nif(!int_strtoul(s, &l) || (l > 3)) {\r\nfprintf(stderr, "Error, '%s' is an invalid value for "\r\n"out_verify\n", s);\r\nreturn 0;\r\n}\r\n*verify_level = (unsigned int)l;\r\nreturn 1;\r\n}\r\nstatic int parse_verify_depth(const char *s, unsigned int *verify_depth)\r\n{\r\nunsigned long l;\r\nif(!int_strtoul(s, &l) || (l < 1) || (l > 50)) {\r\nfprintf(stderr, "Error, '%s' is an invalid value for "\r\n"verify_depth\n", s);\r\nreturn 0;\r\n}\r\n*verify_depth = (unsigned int)l;\r\nreturn 1;\r\n}\r\nstatic void tunala_world_del_item(tunala_world_t *world, unsigned int idx)\r\n{\r\ntunala_item_t *item = world->tunnels + idx;\r\nif(item->clean_read != -1)\r\nclose(item->clean_read);\r\nif(item->clean_send != item->clean_read)\r\nclose(item->clean_send);\r\nitem->clean_read = item->clean_send = -1;\r\nif(item->dirty_read != -1)\r\nclose(item->dirty_read);\r\nif(item->dirty_send != item->dirty_read)\r\nclose(item->dirty_send);\r\nitem->dirty_read = item->dirty_send = -1;\r\nstate_machine_close(&item->sm);\r\nif(idx + 1 < world->tunnels_used)\r\nmemmove(world->tunnels + idx,\r\nworld->tunnels + (idx + 1),\r\n(world->tunnels_used - (idx + 1)) *\r\nsizeof(tunala_item_t));\r\nworld->tunnels_used--;\r\n}\r\nstatic int tunala_item_io(tunala_selector_t *selector, tunala_item_t *item)\r\n{\r\nint c_r, c_s, d_r, d_s;\r\nif((item->clean_read != -1) && FD_ISSET(item->clean_read,\r\n&selector->last_selected.excepts))\r\nreturn 0;\r\nif((item->clean_send != -1) && FD_ISSET(item->clean_send,\r\n&selector->last_selected.excepts))\r\nreturn 0;\r\nif((item->dirty_read != -1) && FD_ISSET(item->dirty_read,\r\n&selector->last_selected.excepts))\r\nreturn 0;\r\nif((item->dirty_send != -1) && FD_ISSET(item->dirty_send,\r\n&selector->last_selected.excepts))\r\nreturn 0;\r\nc_r = c_s = d_r = d_s = 0;\r\nif(item->clean_read != -1)\r\nc_r = FD_ISSET(item->clean_read, &selector->last_selected.reads);\r\nif(item->clean_send != -1)\r\nc_s = FD_ISSET(item->clean_send, &selector->last_selected.sends);\r\nif(item->dirty_read != -1)\r\nd_r = FD_ISSET(item->dirty_read, &selector->last_selected.reads);\r\nif(item->dirty_send != -1)\r\nd_s = FD_ISSET(item->dirty_send, &selector->last_selected.sends);\r\nif(!c_r && !c_s && !d_r && !d_s)\r\nreturn 1;\r\nif(c_r)\r\nc_r = (buffer_from_fd(state_machine_get_buffer(&item->sm,\r\nSM_CLEAN_IN), item->clean_read) <= 0);\r\nif(c_s)\r\nc_s = (buffer_to_fd(state_machine_get_buffer(&item->sm,\r\nSM_CLEAN_OUT), item->clean_send) <= 0);\r\nif(d_r)\r\nd_r = (buffer_from_fd(state_machine_get_buffer(&item->sm,\r\nSM_DIRTY_IN), item->dirty_read) <= 0);\r\nif(d_s)\r\nd_s = (buffer_to_fd(state_machine_get_buffer(&item->sm,\r\nSM_DIRTY_OUT), item->dirty_send) <= 0);\r\nif(c_r) {\r\nclose(item->clean_read);\r\nif(item->clean_send == item->clean_read)\r\nitem->clean_send = -1;\r\nitem->clean_read = -1;\r\n}\r\nif(c_s && (item->clean_send != -1)) {\r\nclose(item->clean_send);\r\nif(item->clean_send == item->clean_read)\r\nitem->clean_read = -1;\r\nitem->clean_send = -1;\r\n}\r\nif(d_r) {\r\nclose(item->dirty_read);\r\nif(item->dirty_send == item->dirty_read)\r\nitem->dirty_send = -1;\r\nitem->dirty_read = -1;\r\n}\r\nif(d_s && (item->dirty_send != -1)) {\r\nclose(item->dirty_send);\r\nif(item->dirty_send == item->dirty_read)\r\nitem->dirty_read = -1;\r\nitem->dirty_send = -1;\r\n}\r\nif(!state_machine_churn(&item->sm))\r\nreturn 0;\r\nif(((item->clean_read == -1) || (item->clean_send == -1)) &&\r\n((item->dirty_read == -1) || (item->dirty_send == -1)))\r\nreturn 0;\r\nif((item->clean_read == -1) || (item->clean_send == -1)) {\r\nif(!state_machine_close_clean(&item->sm))\r\nreturn 0;\r\n}\r\nif((item->dirty_read == -1) || (item->dirty_send == -1)) {\r\nif(!state_machine_close_dirty(&item->sm))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}

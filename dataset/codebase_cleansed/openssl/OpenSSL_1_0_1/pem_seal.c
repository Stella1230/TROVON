int PEM_SealInit(PEM_ENCODE_SEAL_CTX *ctx, EVP_CIPHER *type, EVP_MD *md_type,\r\nunsigned char **ek, int *ekl, unsigned char *iv, EVP_PKEY **pubk,\r\nint npubk)\r\n{\r\nunsigned char key[EVP_MAX_KEY_LENGTH];\r\nint ret= -1;\r\nint i,j,max=0;\r\nchar *s=NULL;\r\nfor (i=0; i<npubk; i++)\r\n{\r\nif (pubk[i]->type != EVP_PKEY_RSA)\r\n{\r\nPEMerr(PEM_F_PEM_SEALINIT,PEM_R_PUBLIC_KEY_NO_RSA);\r\ngoto err;\r\n}\r\nj=RSA_size(pubk[i]->pkey.rsa);\r\nif (j > max) max=j;\r\n}\r\ns=(char *)OPENSSL_malloc(max*2);\r\nif (s == NULL)\r\n{\r\nPEMerr(PEM_F_PEM_SEALINIT,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nEVP_EncodeInit(&ctx->encode);\r\nEVP_MD_CTX_init(&ctx->md);\r\nEVP_SignInit(&ctx->md,md_type);\r\nEVP_CIPHER_CTX_init(&ctx->cipher);\r\nret=EVP_SealInit(&ctx->cipher,type,ek,ekl,iv,pubk,npubk);\r\nif (ret <= 0) goto err;\r\nfor (i=0; i<npubk; i++)\r\n{\r\nj=EVP_EncodeBlock((unsigned char *)s,ek[i],\r\nRSA_size(pubk[i]->pkey.rsa));\r\nekl[i]=j;\r\nmemcpy(ek[i],s,j+1);\r\n}\r\nret=npubk;\r\nerr:\r\nif (s != NULL) OPENSSL_free(s);\r\nOPENSSL_cleanse(key,EVP_MAX_KEY_LENGTH);\r\nreturn(ret);\r\n}\r\nvoid PEM_SealUpdate(PEM_ENCODE_SEAL_CTX *ctx, unsigned char *out, int *outl,\r\nunsigned char *in, int inl)\r\n{\r\nunsigned char buffer[1600];\r\nint i,j;\r\n*outl=0;\r\nEVP_SignUpdate(&ctx->md,in,inl);\r\nfor (;;)\r\n{\r\nif (inl <= 0) break;\r\nif (inl > 1200)\r\ni=1200;\r\nelse\r\ni=inl;\r\nEVP_EncryptUpdate(&ctx->cipher,buffer,&j,in,i);\r\nEVP_EncodeUpdate(&ctx->encode,out,&j,buffer,j);\r\n*outl+=j;\r\nout+=j;\r\nin+=i;\r\ninl-=i;\r\n}\r\n}\r\nint PEM_SealFinal(PEM_ENCODE_SEAL_CTX *ctx, unsigned char *sig, int *sigl,\r\nunsigned char *out, int *outl, EVP_PKEY *priv)\r\n{\r\nunsigned char *s=NULL;\r\nint ret=0,j;\r\nunsigned int i;\r\nif (priv->type != EVP_PKEY_RSA)\r\n{\r\nPEMerr(PEM_F_PEM_SEALFINAL,PEM_R_PUBLIC_KEY_NO_RSA);\r\ngoto err;\r\n}\r\ni=RSA_size(priv->pkey.rsa);\r\nif (i < 100) i=100;\r\ns=(unsigned char *)OPENSSL_malloc(i*2);\r\nif (s == NULL)\r\n{\r\nPEMerr(PEM_F_PEM_SEALFINAL,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nEVP_EncryptFinal_ex(&ctx->cipher,s,(int *)&i);\r\nEVP_EncodeUpdate(&ctx->encode,out,&j,s,i);\r\n*outl=j;\r\nout+=j;\r\nEVP_EncodeFinal(&ctx->encode,out,&j);\r\n*outl+=j;\r\nif (!EVP_SignFinal(&ctx->md,s,&i,priv)) goto err;\r\n*sigl=EVP_EncodeBlock(sig,s,i);\r\nret=1;\r\nerr:\r\nEVP_MD_CTX_cleanup(&ctx->md);\r\nEVP_CIPHER_CTX_cleanup(&ctx->cipher);\r\nif (s != NULL) OPENSSL_free(s);\r\nreturn(ret);\r\n}

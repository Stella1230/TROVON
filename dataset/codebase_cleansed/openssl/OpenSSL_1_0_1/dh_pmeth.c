static int pkey_dh_init(EVP_PKEY_CTX *ctx)\r\n{\r\nDH_PKEY_CTX *dctx;\r\ndctx = OPENSSL_malloc(sizeof(DH_PKEY_CTX));\r\nif (!dctx)\r\nreturn 0;\r\ndctx->prime_len = 1024;\r\ndctx->generator = 2;\r\ndctx->use_dsa = 0;\r\nctx->data = dctx;\r\nctx->keygen_info = dctx->gentmp;\r\nctx->keygen_info_count = 2;\r\nreturn 1;\r\n}\r\nstatic int pkey_dh_copy(EVP_PKEY_CTX *dst, EVP_PKEY_CTX *src)\r\n{\r\nDH_PKEY_CTX *dctx, *sctx;\r\nif (!pkey_dh_init(dst))\r\nreturn 0;\r\nsctx = src->data;\r\ndctx = dst->data;\r\ndctx->prime_len = sctx->prime_len;\r\ndctx->generator = sctx->generator;\r\ndctx->use_dsa = sctx->use_dsa;\r\nreturn 1;\r\n}\r\nstatic void pkey_dh_cleanup(EVP_PKEY_CTX *ctx)\r\n{\r\nDH_PKEY_CTX *dctx = ctx->data;\r\nif (dctx)\r\nOPENSSL_free(dctx);\r\n}\r\nstatic int pkey_dh_ctrl(EVP_PKEY_CTX *ctx, int type, int p1, void *p2)\r\n{\r\nDH_PKEY_CTX *dctx = ctx->data;\r\nswitch (type)\r\n{\r\ncase EVP_PKEY_CTRL_DH_PARAMGEN_PRIME_LEN:\r\nif (p1 < 256)\r\nreturn -2;\r\ndctx->prime_len = p1;\r\nreturn 1;\r\ncase EVP_PKEY_CTRL_DH_PARAMGEN_GENERATOR:\r\ndctx->generator = p1;\r\nreturn 1;\r\ncase EVP_PKEY_CTRL_PEER_KEY:\r\nreturn 1;\r\ndefault:\r\nreturn -2;\r\n}\r\n}\r\nstatic int pkey_dh_ctrl_str(EVP_PKEY_CTX *ctx,\r\nconst char *type, const char *value)\r\n{\r\nif (!strcmp(type, "dh_paramgen_prime_len"))\r\n{\r\nint len;\r\nlen = atoi(value);\r\nreturn EVP_PKEY_CTX_set_dh_paramgen_prime_len(ctx, len);\r\n}\r\nif (!strcmp(type, "dh_paramgen_generator"))\r\n{\r\nint len;\r\nlen = atoi(value);\r\nreturn EVP_PKEY_CTX_set_dh_paramgen_generator(ctx, len);\r\n}\r\nreturn -2;\r\n}\r\nstatic int pkey_dh_paramgen(EVP_PKEY_CTX *ctx, EVP_PKEY *pkey)\r\n{\r\nDH *dh = NULL;\r\nDH_PKEY_CTX *dctx = ctx->data;\r\nBN_GENCB *pcb, cb;\r\nint ret;\r\nif (ctx->pkey_gencb)\r\n{\r\npcb = &cb;\r\nevp_pkey_set_cb_translate(pcb, ctx);\r\n}\r\nelse\r\npcb = NULL;\r\ndh = DH_new();\r\nif (!dh)\r\nreturn 0;\r\nret = DH_generate_parameters_ex(dh,\r\ndctx->prime_len, dctx->generator, pcb);\r\nif (ret)\r\nEVP_PKEY_assign_DH(pkey, dh);\r\nelse\r\nDH_free(dh);\r\nreturn ret;\r\n}\r\nstatic int pkey_dh_keygen(EVP_PKEY_CTX *ctx, EVP_PKEY *pkey)\r\n{\r\nDH *dh = NULL;\r\nif (ctx->pkey == NULL)\r\n{\r\nDHerr(DH_F_PKEY_DH_KEYGEN, DH_R_NO_PARAMETERS_SET);\r\nreturn 0;\r\n}\r\ndh = DH_new();\r\nif (!dh)\r\nreturn 0;\r\nEVP_PKEY_assign_DH(pkey, dh);\r\nif (!EVP_PKEY_copy_parameters(pkey, ctx->pkey))\r\nreturn 0;\r\nreturn DH_generate_key(pkey->pkey.dh);\r\n}\r\nstatic int pkey_dh_derive(EVP_PKEY_CTX *ctx, unsigned char *key, size_t *keylen)\r\n{\r\nint ret;\r\nif (!ctx->pkey || !ctx->peerkey)\r\n{\r\nDHerr(DH_F_PKEY_DH_DERIVE, DH_R_KEYS_NOT_SET);\r\nreturn 0;\r\n}\r\nret = DH_compute_key(key, ctx->peerkey->pkey.dh->pub_key,\r\nctx->pkey->pkey.dh);\r\nif (ret < 0)\r\nreturn ret;\r\n*keylen = ret;\r\nreturn 1;\r\n}

CMS_ContentInfo *cms_DigestedData_create(const EVP_MD *md)\r\n{\r\nCMS_ContentInfo *cms;\r\nCMS_DigestedData *dd;\r\ncms = CMS_ContentInfo_new();\r\nif (!cms)\r\nreturn NULL;\r\ndd = M_ASN1_new_of(CMS_DigestedData);\r\nif (!dd)\r\ngoto err;\r\ncms->contentType = OBJ_nid2obj(NID_pkcs7_digest);\r\ncms->d.digestedData = dd;\r\ndd->version = 0;\r\ndd->encapContentInfo->eContentType = OBJ_nid2obj(NID_pkcs7_data);\r\ncms_DigestAlgorithm_set(dd->digestAlgorithm, md);\r\nreturn cms;\r\nerr:\r\nif (cms)\r\nCMS_ContentInfo_free(cms);\r\nreturn NULL;\r\n}\r\nBIO *cms_DigestedData_init_bio(CMS_ContentInfo *cms)\r\n{\r\nCMS_DigestedData *dd;\r\ndd = cms->d.digestedData;\r\nreturn cms_DigestAlgorithm_init_bio(dd->digestAlgorithm);\r\n}\r\nint cms_DigestedData_do_final(CMS_ContentInfo *cms, BIO *chain, int verify)\r\n{\r\nEVP_MD_CTX mctx;\r\nunsigned char md[EVP_MAX_MD_SIZE];\r\nunsigned int mdlen;\r\nint r = 0;\r\nCMS_DigestedData *dd;\r\nEVP_MD_CTX_init(&mctx);\r\ndd = cms->d.digestedData;\r\nif (!cms_DigestAlgorithm_find_ctx(&mctx, chain, dd->digestAlgorithm))\r\ngoto err;\r\nif (EVP_DigestFinal_ex(&mctx, md, &mdlen) <= 0)\r\ngoto err;\r\nif (verify)\r\n{\r\nif (mdlen != (unsigned int)dd->digest->length)\r\n{\r\nCMSerr(CMS_F_CMS_DIGESTEDDATA_DO_FINAL,\r\nCMS_R_MESSAGEDIGEST_WRONG_LENGTH);\r\ngoto err;\r\n}\r\nif (memcmp(md, dd->digest->data, mdlen))\r\nCMSerr(CMS_F_CMS_DIGESTEDDATA_DO_FINAL,\r\nCMS_R_VERIFICATION_FAILURE);\r\nelse\r\nr = 1;\r\n}\r\nelse\r\n{\r\nif (!ASN1_STRING_set(dd->digest, md, mdlen))\r\ngoto err;\r\nr = 1;\r\n}\r\nerr:\r\nEVP_MD_CTX_cleanup(&mctx);\r\nreturn r;\r\n}

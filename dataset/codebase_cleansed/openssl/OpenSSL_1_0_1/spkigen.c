int main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nRSA *rsa=NULL;\r\nNETSCAPE_SPKI *spki=NULL;\r\nEVP_PKEY *pkey=NULL;\r\nchar buf[128];\r\nint ok=0,i;\r\nFILE *fp;\r\npkey=EVP_PKEY_new();\r\nif (argc < 2)\r\n{\r\nfprintf(stderr,"generating RSA key, could take some time...\n");\r\nif ((rsa=RSA_generate_key(512,RSA_F4,NULL)) == NULL) goto err;\r\n}\r\nelse\r\n{\r\nif ((fp=fopen(argv[1],"r")) == NULL)\r\n{ perror(argv[1]); goto err; }\r\nif ((rsa=PEM_read_RSAPrivateKey(fp,NULL,NULL)) == NULL)\r\ngoto err;\r\nfclose(fp);\r\n}\r\nif (!EVP_PKEY_assign_RSA(pkey,rsa)) goto err;\r\nrsa=NULL;\r\nif ((spki=NETSCAPE_SPKI_new()) == NULL) goto err;\r\nif (!SPKI_set_pubkey(spki,pkey)) goto err;\r\nfprintf(stderr,"please enter challenge string:");\r\nfflush(stderr);\r\nbuf[0]='\0';\r\nfgets(buf,sizeof buf,stdin);\r\ni=strlen(buf);\r\nif (i > 0) buf[--i]='\0';\r\nif (!ASN1_STRING_set((ASN1_STRING *)spki->spkac->challenge,\r\nbuf,i)) goto err;\r\nif (!NETSCAPE_SPKI_sign(spki,pkey,EVP_md5())) goto err;\r\nPEM_write_SPKI(stdout,spki);\r\nif (argc < 2)\r\nPEM_write_RSAPrivateKey(stdout,pkey->pkey.rsa,NULL,NULL,0,NULL);\r\nok=1;\r\nerr:\r\nif (!ok)\r\n{\r\nfprintf(stderr,"something bad happened....");\r\nERR_print_errors_fp(stderr);\r\n}\r\nNETSCAPE_SPKI_free(spki);\r\nEVP_PKEY_free(pkey);\r\nexit(!ok);\r\n}\r\nint EVP_PKEY_assign(pkey,type,key)\r\nEVP_PKEY *pkey;\r\nint type;\r\nchar *key;\r\n{\r\nif (pkey == NULL) return(0);\r\nif (pkey->pkey.ptr != NULL)\r\n{\r\nif (pkey->type == EVP_PKEY_RSA)\r\nRSA_free(pkey->pkey.rsa);\r\n}\r\npkey->type=type;\r\npkey->pkey.ptr=key;\r\nreturn(1);\r\n}\r\nint SPKI_set_pubkey(x,pkey)\r\nNETSCAPE_SPKI *x;\r\nEVP_PKEY *pkey;\r\n{\r\nint ok=0;\r\nX509_PUBKEY *pk;\r\nX509_ALGOR *a;\r\nASN1_OBJECT *o;\r\nunsigned char *s,*p;\r\nint i;\r\nif (x == NULL) return(0);\r\nif ((pk=X509_PUBKEY_new()) == NULL) goto err;\r\na=pk->algor;\r\nif ((o=OBJ_nid2obj(pkey->type)) == NULL) goto err;\r\nASN1_OBJECT_free(a->algorithm);\r\na->algorithm=o;\r\nif ((a->parameter == NULL) || (a->parameter->type != V_ASN1_NULL))\r\n{\r\nASN1_TYPE_free(a->parameter);\r\na->parameter=ASN1_TYPE_new();\r\na->parameter->type=V_ASN1_NULL;\r\n}\r\ni=i2d_PublicKey(pkey,NULL);\r\nif ((s=(unsigned char *)malloc(i+1)) == NULL) goto err;\r\np=s;\r\ni2d_PublicKey(pkey,&p);\r\nif (!ASN1_BIT_STRING_set(pk->public_key,s,i)) goto err;\r\nfree(s);\r\nX509_PUBKEY_free(x->spkac->pubkey);\r\nx->spkac->pubkey=pk;\r\npk=NULL;\r\nok=1;\r\nerr:\r\nif (pk != NULL) X509_PUBKEY_free(pk);\r\nreturn(ok);\r\n}

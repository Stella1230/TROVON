void CAST_ofb64_encrypt(const unsigned char *in, unsigned char *out,\r\nlong length, const CAST_KEY *schedule, unsigned char *ivec,\r\nint *num)\r\n{\r\nregister CAST_LONG v0,v1,t;\r\nregister int n= *num;\r\nregister long l=length;\r\nunsigned char d[8];\r\nregister char *dp;\r\nCAST_LONG ti[2];\r\nunsigned char *iv;\r\nint save=0;\r\niv=ivec;\r\nn2l(iv,v0);\r\nn2l(iv,v1);\r\nti[0]=v0;\r\nti[1]=v1;\r\ndp=(char *)d;\r\nl2n(v0,dp);\r\nl2n(v1,dp);\r\nwhile (l--)\r\n{\r\nif (n == 0)\r\n{\r\nCAST_encrypt((CAST_LONG *)ti,schedule);\r\ndp=(char *)d;\r\nt=ti[0]; l2n(t,dp);\r\nt=ti[1]; l2n(t,dp);\r\nsave++;\r\n}\r\n*(out++)= *(in++)^d[n];\r\nn=(n+1)&0x07;\r\n}\r\nif (save)\r\n{\r\nv0=ti[0];\r\nv1=ti[1];\r\niv=ivec;\r\nl2n(v0,iv);\r\nl2n(v1,iv);\r\n}\r\nt=v0=v1=ti[0]=ti[1]=0;\r\n*num=n;\r\n}

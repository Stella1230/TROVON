int main(int argc, char **argv)\r\n{\r\nFILE *fp;\r\nEVP_PKEY *pkey;\r\nX509 *cert;\r\nPKCS12 *p12;\r\nif (argc != 5) {\r\nfprintf(stderr, "Usage: pkwrite infile password name p12file\n");\r\nexit(1);\r\n}\r\nSSLeay_add_all_algorithms();\r\nERR_load_crypto_strings();\r\nif (!(fp = fopen(argv[1], "r"))) {\r\nfprintf(stderr, "Error opening file %s\n", argv[1]);\r\nexit(1);\r\n}\r\ncert = PEM_read_X509(fp, NULL, NULL, NULL);\r\nrewind(fp);\r\npkey = PEM_read_PrivateKey(fp, NULL, NULL, NULL);\r\nfclose(fp);\r\np12 = PKCS12_create(argv[2], argv[3], pkey, cert, NULL, 0,0,0,0,0);\r\nif(!p12) {\r\nfprintf(stderr, "Error creating PKCS#12 structure\n");\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}\r\nif (!(fp = fopen(argv[4], "wb"))) {\r\nfprintf(stderr, "Error opening file %s\n", argv[1]);\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}\r\ni2d_PKCS12_fp(fp, p12);\r\nPKCS12_free(p12);\r\nfclose(fp);\r\nreturn 0;\r\n}

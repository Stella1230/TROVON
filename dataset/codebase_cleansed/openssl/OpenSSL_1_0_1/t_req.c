int X509_REQ_print_fp(FILE *fp, X509_REQ *x)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nX509err(X509_F_X509_REQ_PRINT_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=X509_REQ_print(b, x);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint X509_REQ_print_ex(BIO *bp, X509_REQ *x, unsigned long nmflags, unsigned long cflag)\r\n{\r\nunsigned long l;\r\nint i;\r\nconst char *neg;\r\nX509_REQ_INFO *ri;\r\nEVP_PKEY *pkey;\r\nSTACK_OF(X509_ATTRIBUTE) *sk;\r\nSTACK_OF(X509_EXTENSION) *exts;\r\nchar mlch = ' ';\r\nint nmindent = 0;\r\nif((nmflags & XN_FLAG_SEP_MASK) == XN_FLAG_SEP_MULTILINE) {\r\nmlch = '\n';\r\nnmindent = 12;\r\n}\r\nif(nmflags == X509_FLAG_COMPAT)\r\nnmindent = 16;\r\nri=x->req_info;\r\nif(!(cflag & X509_FLAG_NO_HEADER))\r\n{\r\nif (BIO_write(bp,"Certificate Request:\n",21) <= 0) goto err;\r\nif (BIO_write(bp," Data:\n",10) <= 0) goto err;\r\n}\r\nif(!(cflag & X509_FLAG_NO_VERSION))\r\n{\r\nneg=(ri->version->type == V_ASN1_NEG_INTEGER)?"-":"";\r\nl=0;\r\nfor (i=0; i<ri->version->length; i++)\r\n{ l<<=8; l+=ri->version->data[i]; }\r\nif(BIO_printf(bp,"%8sVersion: %s%lu (%s0x%lx)\n","",neg,l,neg,\r\nl) <= 0)\r\ngoto err;\r\n}\r\nif(!(cflag & X509_FLAG_NO_SUBJECT))\r\n{\r\nif (BIO_printf(bp," Subject:%c",mlch) <= 0) goto err;\r\nif (X509_NAME_print_ex(bp,ri->subject,nmindent, nmflags) < 0) goto err;\r\nif (BIO_write(bp,"\n",1) <= 0) goto err;\r\n}\r\nif(!(cflag & X509_FLAG_NO_PUBKEY))\r\n{\r\nif (BIO_write(bp," Subject Public Key Info:\n",33) <= 0)\r\ngoto err;\r\nif (BIO_printf(bp,"%12sPublic Key Algorithm: ","") <= 0)\r\ngoto err;\r\nif (i2a_ASN1_OBJECT(bp, ri->pubkey->algor->algorithm) <= 0)\r\ngoto err;\r\nif (BIO_puts(bp, "\n") <= 0)\r\ngoto err;\r\npkey=X509_REQ_get_pubkey(x);\r\nif (pkey == NULL)\r\n{\r\nBIO_printf(bp,"%12sUnable to load Public Key\n","");\r\nERR_print_errors(bp);\r\n}\r\nelse\r\n{\r\nEVP_PKEY_print_public(bp, pkey, 16, NULL);\r\nEVP_PKEY_free(pkey);\r\n}\r\n}\r\nif(!(cflag & X509_FLAG_NO_ATTRIBUTES))\r\n{\r\nif(BIO_printf(bp,"%8sAttributes:\n","") <= 0)\r\ngoto err;\r\nsk=x->req_info->attributes;\r\nif (sk_X509_ATTRIBUTE_num(sk) == 0)\r\n{\r\nif(BIO_printf(bp,"%12sa0:00\n","") <= 0)\r\ngoto err;\r\n}\r\nelse\r\n{\r\nfor (i=0; i<sk_X509_ATTRIBUTE_num(sk); i++)\r\n{\r\nASN1_TYPE *at;\r\nX509_ATTRIBUTE *a;\r\nASN1_BIT_STRING *bs=NULL;\r\nASN1_TYPE *t;\r\nint j,type=0,count=1,ii=0;\r\na=sk_X509_ATTRIBUTE_value(sk,i);\r\nif(X509_REQ_extension_nid(OBJ_obj2nid(a->object)))\r\ncontinue;\r\nif(BIO_printf(bp,"%12s","") <= 0)\r\ngoto err;\r\nif ((j=i2a_ASN1_OBJECT(bp,a->object)) > 0)\r\n{\r\nif (a->single)\r\n{\r\nt=a->value.single;\r\ntype=t->type;\r\nbs=t->value.bit_string;\r\n}\r\nelse\r\n{\r\nii=0;\r\ncount=sk_ASN1_TYPE_num(a->value.set);\r\nget_next:\r\nat=sk_ASN1_TYPE_value(a->value.set,ii);\r\ntype=at->type;\r\nbs=at->value.asn1_string;\r\n}\r\n}\r\nfor (j=25-j; j>0; j--)\r\nif (BIO_write(bp," ",1) != 1) goto err;\r\nif (BIO_puts(bp,":") <= 0) goto err;\r\nif ( (type == V_ASN1_PRINTABLESTRING) ||\r\n(type == V_ASN1_T61STRING) ||\r\n(type == V_ASN1_IA5STRING))\r\n{\r\nif (BIO_write(bp,(char *)bs->data,bs->length)\r\n!= bs->length)\r\ngoto err;\r\nBIO_puts(bp,"\n");\r\n}\r\nelse\r\n{\r\nBIO_puts(bp,"unable to print attribute\n");\r\n}\r\nif (++ii < count) goto get_next;\r\n}\r\n}\r\n}\r\nif(!(cflag & X509_FLAG_NO_EXTENSIONS))\r\n{\r\nexts = X509_REQ_get_extensions(x);\r\nif(exts)\r\n{\r\nBIO_printf(bp,"%8sRequested Extensions:\n","");\r\nfor (i=0; i<sk_X509_EXTENSION_num(exts); i++)\r\n{\r\nASN1_OBJECT *obj;\r\nX509_EXTENSION *ex;\r\nint j;\r\nex=sk_X509_EXTENSION_value(exts, i);\r\nif (BIO_printf(bp,"%12s","") <= 0) goto err;\r\nobj=X509_EXTENSION_get_object(ex);\r\ni2a_ASN1_OBJECT(bp,obj);\r\nj=X509_EXTENSION_get_critical(ex);\r\nif (BIO_printf(bp,": %s\n",j?"critical":"") <= 0)\r\ngoto err;\r\nif(!X509V3_EXT_print(bp, ex, cflag, 16))\r\n{\r\nBIO_printf(bp, "%16s", "");\r\nM_ASN1_OCTET_STRING_print(bp,ex->value);\r\n}\r\nif (BIO_write(bp,"\n",1) <= 0) goto err;\r\n}\r\nsk_X509_EXTENSION_pop_free(exts, X509_EXTENSION_free);\r\n}\r\n}\r\nif(!(cflag & X509_FLAG_NO_SIGDUMP))\r\n{\r\nif(!X509_signature_print(bp, x->sig_alg, x->signature)) goto err;\r\n}\r\nreturn(1);\r\nerr:\r\nX509err(X509_F_X509_REQ_PRINT_EX,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nint X509_REQ_print(BIO *bp, X509_REQ *x)\r\n{\r\nreturn X509_REQ_print_ex(bp, x, XN_FLAG_COMPAT, X509_FLAG_COMPAT);\r\n}

int policy_cache_set_mapping(X509 *x, POLICY_MAPPINGS *maps)\r\n{\r\nPOLICY_MAPPING *map;\r\nX509_POLICY_DATA *data;\r\nX509_POLICY_CACHE *cache = x->policy_cache;\r\nint i;\r\nint ret = 0;\r\nif (sk_POLICY_MAPPING_num(maps) == 0)\r\n{\r\nret = -1;\r\ngoto bad_mapping;\r\n}\r\nfor (i = 0; i < sk_POLICY_MAPPING_num(maps); i++)\r\n{\r\nmap = sk_POLICY_MAPPING_value(maps, i);\r\nif ((OBJ_obj2nid(map->subjectDomainPolicy) == NID_any_policy)\r\n|| (OBJ_obj2nid(map->issuerDomainPolicy) == NID_any_policy))\r\n{\r\nret = -1;\r\ngoto bad_mapping;\r\n}\r\ndata = policy_cache_find_data(cache, map->issuerDomainPolicy);\r\nif (!data && !cache->anyPolicy)\r\ncontinue;\r\nif (!data)\r\n{\r\ndata = policy_data_new(NULL, map->issuerDomainPolicy,\r\ncache->anyPolicy->flags\r\n& POLICY_DATA_FLAG_CRITICAL);\r\nif (!data)\r\ngoto bad_mapping;\r\ndata->qualifier_set = cache->anyPolicy->qualifier_set;\r\ndata->flags |= POLICY_DATA_FLAG_MAPPED_ANY;\r\ndata->flags |= POLICY_DATA_FLAG_SHARED_QUALIFIERS;\r\nif (!sk_X509_POLICY_DATA_push(cache->data, data))\r\n{\r\npolicy_data_free(data);\r\ngoto bad_mapping;\r\n}\r\n}\r\nelse\r\ndata->flags |= POLICY_DATA_FLAG_MAPPED;\r\nif (!sk_ASN1_OBJECT_push(data->expected_policy_set,\r\nmap->subjectDomainPolicy))\r\ngoto bad_mapping;\r\nmap->subjectDomainPolicy = NULL;\r\n}\r\nret = 1;\r\nbad_mapping:\r\nif (ret == -1)\r\nx->ex_flags |= EXFLAG_INVALID_POLICY;\r\nsk_POLICY_MAPPING_pop_free(maps, POLICY_MAPPING_free);\r\nreturn ret;\r\n}

int BN_kronecker(const BIGNUM *a, const BIGNUM *b, BN_CTX *ctx)\r\n{\r\nint i;\r\nint ret = -2;\r\nint err = 0;\r\nBIGNUM *A, *B, *tmp;\r\nstatic const int tab[8] = {0, 1, 0, -1, 0, -1, 0, 1};\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nBN_CTX_start(ctx);\r\nA = BN_CTX_get(ctx);\r\nB = BN_CTX_get(ctx);\r\nif (B == NULL) goto end;\r\nerr = !BN_copy(A, a);\r\nif (err) goto end;\r\nerr = !BN_copy(B, b);\r\nif (err) goto end;\r\nif (BN_is_zero(B))\r\n{\r\nret = BN_abs_is_word(A, 1);\r\ngoto end;\r\n}\r\nif (!BN_is_odd(A) && !BN_is_odd(B))\r\n{\r\nret = 0;\r\ngoto end;\r\n}\r\ni = 0;\r\nwhile (!BN_is_bit_set(B, i))\r\ni++;\r\nerr = !BN_rshift(B, B, i);\r\nif (err) goto end;\r\nif (i & 1)\r\n{\r\nret = tab[BN_lsw(A) & 7];\r\n}\r\nelse\r\n{\r\nret = 1;\r\n}\r\nif (B->neg)\r\n{\r\nB->neg = 0;\r\nif (A->neg)\r\nret = -ret;\r\n}\r\nwhile (1)\r\n{\r\nif (BN_is_zero(A))\r\n{\r\nret = BN_is_one(B) ? ret : 0;\r\ngoto end;\r\n}\r\ni = 0;\r\nwhile (!BN_is_bit_set(A, i))\r\ni++;\r\nerr = !BN_rshift(A, A, i);\r\nif (err) goto end;\r\nif (i & 1)\r\n{\r\nret = ret * tab[BN_lsw(B) & 7];\r\n}\r\nif ((A->neg ? ~BN_lsw(A) : BN_lsw(A)) & BN_lsw(B) & 2)\r\nret = -ret;\r\nerr = !BN_nnmod(B, B, A, ctx);\r\nif (err) goto end;\r\ntmp = A; A = B; B = tmp;\r\ntmp->neg = 0;\r\n}\r\nend:\r\nBN_CTX_end(ctx);\r\nif (err)\r\nreturn -2;\r\nelse\r\nreturn ret;\r\n}

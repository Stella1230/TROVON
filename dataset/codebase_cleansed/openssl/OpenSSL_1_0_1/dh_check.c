int DH_check(const DH *dh, int *ret)\r\n{\r\nint ok=0;\r\nBN_CTX *ctx=NULL;\r\nBN_ULONG l;\r\nBIGNUM *q=NULL;\r\n*ret=0;\r\nctx=BN_CTX_new();\r\nif (ctx == NULL) goto err;\r\nq=BN_new();\r\nif (q == NULL) goto err;\r\nif (BN_is_word(dh->g,DH_GENERATOR_2))\r\n{\r\nl=BN_mod_word(dh->p,24);\r\nif (l != 11) *ret|=DH_NOT_SUITABLE_GENERATOR;\r\n}\r\n#if 0\r\nelse if (BN_is_word(dh->g,DH_GENERATOR_3))\r\n{\r\nl=BN_mod_word(dh->p,12);\r\nif (l != 5) *ret|=DH_NOT_SUITABLE_GENERATOR;\r\n}\r\n#endif\r\nelse if (BN_is_word(dh->g,DH_GENERATOR_5))\r\n{\r\nl=BN_mod_word(dh->p,10);\r\nif ((l != 3) && (l != 7))\r\n*ret|=DH_NOT_SUITABLE_GENERATOR;\r\n}\r\nelse\r\n*ret|=DH_UNABLE_TO_CHECK_GENERATOR;\r\nif (!BN_is_prime_ex(dh->p,BN_prime_checks,ctx,NULL))\r\n*ret|=DH_CHECK_P_NOT_PRIME;\r\nelse\r\n{\r\nif (!BN_rshift1(q,dh->p)) goto err;\r\nif (!BN_is_prime_ex(q,BN_prime_checks,ctx,NULL))\r\n*ret|=DH_CHECK_P_NOT_SAFE_PRIME;\r\n}\r\nok=1;\r\nerr:\r\nif (ctx != NULL) BN_CTX_free(ctx);\r\nif (q != NULL) BN_free(q);\r\nreturn(ok);\r\n}\r\nint DH_check_pub_key(const DH *dh, const BIGNUM *pub_key, int *ret)\r\n{\r\nint ok=0;\r\nBIGNUM *q=NULL;\r\n*ret=0;\r\nq=BN_new();\r\nif (q == NULL) goto err;\r\nBN_set_word(q,1);\r\nif (BN_cmp(pub_key,q)<=0)\r\n*ret|=DH_CHECK_PUBKEY_TOO_SMALL;\r\nBN_copy(q,dh->p);\r\nBN_sub_word(q,1);\r\nif (BN_cmp(pub_key,q)>=0)\r\n*ret|=DH_CHECK_PUBKEY_TOO_LARGE;\r\nok = 1;\r\nerr:\r\nif (q != NULL) BN_free(q);\r\nreturn(ok);\r\n}

static int int_ctrl_cmd_is_null(const ENGINE_CMD_DEFN *defn)\r\n{\r\nif((defn->cmd_num == 0) || (defn->cmd_name == NULL))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int int_ctrl_cmd_by_name(const ENGINE_CMD_DEFN *defn, const char *s)\r\n{\r\nint idx = 0;\r\nwhile(!int_ctrl_cmd_is_null(defn) && (strcmp(defn->cmd_name, s) != 0))\r\n{\r\nidx++;\r\ndefn++;\r\n}\r\nif(int_ctrl_cmd_is_null(defn))\r\nreturn -1;\r\nreturn idx;\r\n}\r\nstatic int int_ctrl_cmd_by_num(const ENGINE_CMD_DEFN *defn, unsigned int num)\r\n{\r\nint idx = 0;\r\nwhile(!int_ctrl_cmd_is_null(defn) && (defn->cmd_num < num))\r\n{\r\nidx++;\r\ndefn++;\r\n}\r\nif(defn->cmd_num == num)\r\nreturn idx;\r\nreturn -1;\r\n}\r\nstatic int int_ctrl_helper(ENGINE *e, int cmd, long i, void *p,\r\nvoid (*f)(void))\r\n{\r\nint idx;\r\nchar *s = (char *)p;\r\nif(cmd == ENGINE_CTRL_GET_FIRST_CMD_TYPE)\r\n{\r\nif((e->cmd_defns == NULL) || int_ctrl_cmd_is_null(e->cmd_defns))\r\nreturn 0;\r\nreturn e->cmd_defns->cmd_num;\r\n}\r\nif((cmd == ENGINE_CTRL_GET_CMD_FROM_NAME) ||\r\n(cmd == ENGINE_CTRL_GET_NAME_FROM_CMD) ||\r\n(cmd == ENGINE_CTRL_GET_DESC_FROM_CMD))\r\n{\r\nif(s == NULL)\r\n{\r\nENGINEerr(ENGINE_F_INT_CTRL_HELPER,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn -1;\r\n}\r\n}\r\nif(cmd == ENGINE_CTRL_GET_CMD_FROM_NAME)\r\n{\r\nif((e->cmd_defns == NULL) || ((idx = int_ctrl_cmd_by_name(\r\ne->cmd_defns, s)) < 0))\r\n{\r\nENGINEerr(ENGINE_F_INT_CTRL_HELPER,\r\nENGINE_R_INVALID_CMD_NAME);\r\nreturn -1;\r\n}\r\nreturn e->cmd_defns[idx].cmd_num;\r\n}\r\nif((e->cmd_defns == NULL) || ((idx = int_ctrl_cmd_by_num(e->cmd_defns,\r\n(unsigned int)i)) < 0))\r\n{\r\nENGINEerr(ENGINE_F_INT_CTRL_HELPER,\r\nENGINE_R_INVALID_CMD_NUMBER);\r\nreturn -1;\r\n}\r\nswitch(cmd)\r\n{\r\ncase ENGINE_CTRL_GET_NEXT_CMD_TYPE:\r\nidx++;\r\nif(int_ctrl_cmd_is_null(e->cmd_defns + idx))\r\nreturn 0;\r\nelse\r\nreturn e->cmd_defns[idx].cmd_num;\r\ncase ENGINE_CTRL_GET_NAME_LEN_FROM_CMD:\r\nreturn strlen(e->cmd_defns[idx].cmd_name);\r\ncase ENGINE_CTRL_GET_NAME_FROM_CMD:\r\nreturn BIO_snprintf(s,strlen(e->cmd_defns[idx].cmd_name) + 1,\r\n"%s", e->cmd_defns[idx].cmd_name);\r\ncase ENGINE_CTRL_GET_DESC_LEN_FROM_CMD:\r\nif(e->cmd_defns[idx].cmd_desc)\r\nreturn strlen(e->cmd_defns[idx].cmd_desc);\r\nreturn strlen(int_no_description);\r\ncase ENGINE_CTRL_GET_DESC_FROM_CMD:\r\nif(e->cmd_defns[idx].cmd_desc)\r\nreturn BIO_snprintf(s,\r\nstrlen(e->cmd_defns[idx].cmd_desc) + 1,\r\n"%s", e->cmd_defns[idx].cmd_desc);\r\nreturn BIO_snprintf(s, strlen(int_no_description) + 1,"%s",\r\nint_no_description);\r\ncase ENGINE_CTRL_GET_CMD_FLAGS:\r\nreturn e->cmd_defns[idx].cmd_flags;\r\n}\r\nENGINEerr(ENGINE_F_INT_CTRL_HELPER,ENGINE_R_INTERNAL_LIST_ERROR);\r\nreturn -1;\r\n}\r\nint ENGINE_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f)(void))\r\n{\r\nint ctrl_exists, ref_exists;\r\nif(e == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nCRYPTO_w_lock(CRYPTO_LOCK_ENGINE);\r\nref_exists = ((e->struct_ref > 0) ? 1 : 0);\r\nCRYPTO_w_unlock(CRYPTO_LOCK_ENGINE);\r\nctrl_exists = ((e->ctrl == NULL) ? 0 : 1);\r\nif(!ref_exists)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL,ENGINE_R_NO_REFERENCE);\r\nreturn 0;\r\n}\r\nswitch(cmd)\r\n{\r\ncase ENGINE_CTRL_HAS_CTRL_FUNCTION:\r\nreturn ctrl_exists;\r\ncase ENGINE_CTRL_GET_FIRST_CMD_TYPE:\r\ncase ENGINE_CTRL_GET_NEXT_CMD_TYPE:\r\ncase ENGINE_CTRL_GET_CMD_FROM_NAME:\r\ncase ENGINE_CTRL_GET_NAME_LEN_FROM_CMD:\r\ncase ENGINE_CTRL_GET_NAME_FROM_CMD:\r\ncase ENGINE_CTRL_GET_DESC_LEN_FROM_CMD:\r\ncase ENGINE_CTRL_GET_DESC_FROM_CMD:\r\ncase ENGINE_CTRL_GET_CMD_FLAGS:\r\nif(ctrl_exists && !(e->flags & ENGINE_FLAGS_MANUAL_CMD_CTRL))\r\nreturn int_ctrl_helper(e,cmd,i,p,f);\r\nif(!ctrl_exists)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL,ENGINE_R_NO_CONTROL_FUNCTION);\r\nreturn -1;\r\n}\r\ndefault:\r\nbreak;\r\n}\r\nif(!ctrl_exists)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL,ENGINE_R_NO_CONTROL_FUNCTION);\r\nreturn 0;\r\n}\r\nreturn e->ctrl(e, cmd, i, p, f);\r\n}\r\nint ENGINE_cmd_is_executable(ENGINE *e, int cmd)\r\n{\r\nint flags;\r\nif((flags = ENGINE_ctrl(e, ENGINE_CTRL_GET_CMD_FLAGS, cmd, NULL, NULL)) < 0)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CMD_IS_EXECUTABLE,\r\nENGINE_R_INVALID_CMD_NUMBER);\r\nreturn 0;\r\n}\r\nif(!(flags & ENGINE_CMD_FLAG_NO_INPUT) &&\r\n!(flags & ENGINE_CMD_FLAG_NUMERIC) &&\r\n!(flags & ENGINE_CMD_FLAG_STRING))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint ENGINE_ctrl_cmd(ENGINE *e, const char *cmd_name,\r\nlong i, void *p, void (*f)(void), int cmd_optional)\r\n{\r\nint num;\r\nif((e == NULL) || (cmd_name == NULL))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif((e->ctrl == NULL) || ((num = ENGINE_ctrl(e,\r\nENGINE_CTRL_GET_CMD_FROM_NAME,\r\n0, (void *)cmd_name, NULL)) <= 0))\r\n{\r\nif(cmd_optional)\r\n{\r\nERR_clear_error();\r\nreturn 1;\r\n}\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD,\r\nENGINE_R_INVALID_CMD_NAME);\r\nreturn 0;\r\n}\r\nif (ENGINE_ctrl(e, num, i, p, f) > 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint ENGINE_ctrl_cmd_string(ENGINE *e, const char *cmd_name, const char *arg,\r\nint cmd_optional)\r\n{\r\nint num, flags;\r\nlong l;\r\nchar *ptr;\r\nif((e == NULL) || (cmd_name == NULL))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif((e->ctrl == NULL) || ((num = ENGINE_ctrl(e,\r\nENGINE_CTRL_GET_CMD_FROM_NAME,\r\n0, (void *)cmd_name, NULL)) <= 0))\r\n{\r\nif(cmd_optional)\r\n{\r\nERR_clear_error();\r\nreturn 1;\r\n}\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_INVALID_CMD_NAME);\r\nreturn 0;\r\n}\r\nif(!ENGINE_cmd_is_executable(e, num))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_CMD_NOT_EXECUTABLE);\r\nreturn 0;\r\n}\r\nif((flags = ENGINE_ctrl(e, ENGINE_CTRL_GET_CMD_FLAGS, num, NULL, NULL)) < 0)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_INTERNAL_LIST_ERROR);\r\nreturn 0;\r\n}\r\nif(flags & ENGINE_CMD_FLAG_NO_INPUT)\r\n{\r\nif(arg != NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_COMMAND_TAKES_NO_INPUT);\r\nreturn 0;\r\n}\r\nif(ENGINE_ctrl(e, num, 0, (void *)arg, NULL) > 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nif(arg == NULL)\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_COMMAND_TAKES_INPUT);\r\nreturn 0;\r\n}\r\nif(flags & ENGINE_CMD_FLAG_STRING)\r\n{\r\nif(ENGINE_ctrl(e, num, 0, (void *)arg, NULL) > 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nif(!(flags & ENGINE_CMD_FLAG_NUMERIC))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_INTERNAL_LIST_ERROR);\r\nreturn 0;\r\n}\r\nl = strtol(arg, &ptr, 10);\r\nif((arg == ptr) || (*ptr != '\0'))\r\n{\r\nENGINEerr(ENGINE_F_ENGINE_CTRL_CMD_STRING,\r\nENGINE_R_ARGUMENT_IS_NOT_A_NUMBER);\r\nreturn 0;\r\n}\r\nif(ENGINE_ctrl(e, num, l, NULL, NULL) > 0)\r\nreturn 1;\r\nreturn 0;\r\n}

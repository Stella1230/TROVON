int main(int argc, char *argv[])\r\n{\r\nif ((argc == 2))\r\n{\r\ndo_cipher(argv[1],ENCRYPT);\r\n}\r\nelse if ((argc == 3) && !strcmp(argv[1],"-d"))\r\n{\r\ndo_cipher(argv[2],DECRYPT);\r\n}\r\nelse\r\n{\r\nfprintf(stderr,"%s", usage);\r\nexit(1);\r\n}\r\nreturn 0;\r\n}\r\nvoid do_cipher(char *pw, int operation)\r\n{\r\nchar buf[BUFLEN];\r\nchar ebuf[BUFLEN + 8];\r\nunsigned int ebuflen;\r\nunsigned char iv[EVP_MAX_IV_LENGTH], key[EVP_MAX_KEY_LENGTH];\r\nEVP_CIPHER_CTX ectx;\r\nmemcpy(iv, INIT_VECTOR, sizeof(iv));\r\nEVP_BytesToKey(ALG, EVP_md5(), "salu", pw, strlen(pw), 1, key, iv);\r\nEVP_CIPHER_CTX_init(&ectx);\r\nEVP_CipherInit_ex(&ectx, ALG, NULL, key, iv, operation);\r\nwhile(1)\r\n{\r\nint readlen = read(STDIN, buf, sizeof(buf));\r\nif (readlen <= 0)\r\n{\r\nif (!readlen)\r\nbreak;\r\nelse\r\n{\r\nperror("read");\r\nexit(1);\r\n}\r\n}\r\nEVP_CipherUpdate(&ectx, ebuf, &ebuflen, buf, readlen);\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}\r\nEVP_CipherFinal_ex(&ectx, ebuf, &ebuflen);\r\nEVP_CIPHER_CTX_cleanup(&ectx);\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}

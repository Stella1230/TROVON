void RC5_32_cbc_encrypt(const unsigned char *in, unsigned char *out,\r\nlong length, RC5_32_KEY *ks, unsigned char *iv,\r\nint encrypt)\r\n{\r\nregister unsigned long tin0,tin1;\r\nregister unsigned long tout0,tout1,xor0,xor1;\r\nregister long l=length;\r\nunsigned long tin[2];\r\nif (encrypt)\r\n{\r\nc2l(iv,tout0);\r\nc2l(iv,tout1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nRC5_32_encrypt(tin,ks);\r\ntout0=tin[0]; l2c(tout0,out);\r\ntout1=tin[1]; l2c(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nc2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nRC5_32_encrypt(tin,ks);\r\ntout0=tin[0]; l2c(tout0,out);\r\ntout1=tin[1]; l2c(tout1,out);\r\n}\r\nl2c(tout0,iv);\r\nl2c(tout1,iv);\r\n}\r\nelse\r\n{\r\nc2l(iv,xor0);\r\nc2l(iv,xor1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0); tin[0]=tin0;\r\nc2l(in,tin1); tin[1]=tin1;\r\nRC5_32_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nif (l != -8)\r\n{\r\nc2l(in,tin0); tin[0]=tin0;\r\nc2l(in,tin1); tin[1]=tin1;\r\nRC5_32_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2cn(tout0,tout1,out,l+8);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nl2c(xor0,iv);\r\nl2c(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}\r\nvoid RC5_32_encrypt(unsigned long *d, RC5_32_KEY *key)\r\n{\r\nRC5_32_INT a,b,*s;\r\ns=key->data;\r\na=d[0]+s[0];\r\nb=d[1]+s[1];\r\nE_RC5_32(a,b,s, 2);\r\nE_RC5_32(a,b,s, 4);\r\nE_RC5_32(a,b,s, 6);\r\nE_RC5_32(a,b,s, 8);\r\nE_RC5_32(a,b,s,10);\r\nE_RC5_32(a,b,s,12);\r\nE_RC5_32(a,b,s,14);\r\nE_RC5_32(a,b,s,16);\r\nif (key->rounds == 12)\r\n{\r\nE_RC5_32(a,b,s,18);\r\nE_RC5_32(a,b,s,20);\r\nE_RC5_32(a,b,s,22);\r\nE_RC5_32(a,b,s,24);\r\n}\r\nelse if (key->rounds == 16)\r\n{\r\nE_RC5_32(a,b,s,18);\r\nE_RC5_32(a,b,s,20);\r\nE_RC5_32(a,b,s,22);\r\nE_RC5_32(a,b,s,24);\r\nE_RC5_32(a,b,s,26);\r\nE_RC5_32(a,b,s,28);\r\nE_RC5_32(a,b,s,30);\r\nE_RC5_32(a,b,s,32);\r\n}\r\nd[0]=a;\r\nd[1]=b;\r\n}\r\nvoid RC5_32_decrypt(unsigned long *d, RC5_32_KEY *key)\r\n{\r\nRC5_32_INT a,b,*s;\r\ns=key->data;\r\na=d[0];\r\nb=d[1];\r\nif (key->rounds == 16)\r\n{\r\nD_RC5_32(a,b,s,32);\r\nD_RC5_32(a,b,s,30);\r\nD_RC5_32(a,b,s,28);\r\nD_RC5_32(a,b,s,26);\r\nD_RC5_32(a,b,s,24);\r\nD_RC5_32(a,b,s,22);\r\nD_RC5_32(a,b,s,20);\r\nD_RC5_32(a,b,s,18);\r\n}\r\nelse if (key->rounds == 12)\r\n{\r\nD_RC5_32(a,b,s,24);\r\nD_RC5_32(a,b,s,22);\r\nD_RC5_32(a,b,s,20);\r\nD_RC5_32(a,b,s,18);\r\n}\r\nD_RC5_32(a,b,s,16);\r\nD_RC5_32(a,b,s,14);\r\nD_RC5_32(a,b,s,12);\r\nD_RC5_32(a,b,s,10);\r\nD_RC5_32(a,b,s, 8);\r\nD_RC5_32(a,b,s, 6);\r\nD_RC5_32(a,b,s, 4);\r\nD_RC5_32(a,b,s, 2);\r\nd[0]=a-s[0];\r\nd[1]=b-s[1];\r\n}

X509 *X509_REQ_to_X509(X509_REQ *r, int days, EVP_PKEY *pkey)\r\n{\r\nX509 *ret=NULL;\r\nX509_CINF *xi=NULL;\r\nX509_NAME *xn;\r\nif ((ret=X509_new()) == NULL)\r\n{\r\nX509err(X509_F_X509_REQ_TO_X509,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nxi=ret->cert_info;\r\nif (sk_X509_ATTRIBUTE_num(r->req_info->attributes) != 0)\r\n{\r\nif ((xi->version=M_ASN1_INTEGER_new()) == NULL) goto err;\r\nif (!ASN1_INTEGER_set(xi->version,2)) goto err;\r\n}\r\nxn=X509_REQ_get_subject_name(r);\r\nX509_set_subject_name(ret,X509_NAME_dup(xn));\r\nX509_set_issuer_name(ret,X509_NAME_dup(xn));\r\nX509_gmtime_adj(xi->validity->notBefore,0);\r\nX509_gmtime_adj(xi->validity->notAfter,(long)60*60*24*days);\r\nX509_set_pubkey(ret,X509_REQ_get_pubkey(r));\r\nif (!X509_sign(ret,pkey,EVP_md5()))\r\ngoto err;\r\nif (0)\r\n{\r\nerr:\r\nX509_free(ret);\r\nret=NULL;\r\n}\r\nreturn(ret);\r\n}

int main()\r\n{\r\nchar *ct = "This the clear text";\r\nchar *buf;\r\nchar *buf2;\r\nEVP_PKEY *pubKey;\r\nEVP_PKEY *privKey;\r\nint len;\r\nERR_load_crypto_strings();\r\nprivKey = ReadPrivateKey(PRIVFILE);\r\nif (!privKey)\r\n{\r\nERR_print_errors_fp (stderr);\r\nexit (1);\r\n}\r\npubKey = ReadPublicKey(PUBFILE);\r\nif(!pubKey)\r\n{\r\nEVP_PKEY_free(privKey);\r\nfprintf(stderr,"Error: can't load public key");\r\nexit(1);\r\n}\r\nbuf = malloc(EVP_PKEY_size(pubKey));\r\nbuf2 = malloc(EVP_PKEY_size(pubKey));\r\nlen = RSA_public_encrypt(strlen(ct)+1, ct, buf, pubKey->pkey.rsa,RSA_PKCS1_PADDING);\r\nif (len != EVP_PKEY_size(pubKey))\r\n{\r\nfprintf(stderr,"Error: ciphertext should match length of key\n");\r\nexit(1);\r\n}\r\nRSA_private_decrypt(len, buf, buf2, privKey->pkey.rsa,RSA_PKCS1_PADDING);\r\nprintf("%s\n", buf2);\r\nEVP_PKEY_free(privKey);\r\nEVP_PKEY_free(pubKey);\r\nfree(buf);\r\nfree(buf2);\r\nreturn 0;\r\n}

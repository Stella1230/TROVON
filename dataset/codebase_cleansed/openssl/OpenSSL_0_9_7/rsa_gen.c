RSA *RSA_generate_key(int bits, unsigned long e_value,\r\nvoid (*callback)(int,int,void *), void *cb_arg)\r\n{\r\nRSA *rsa=NULL;\r\nBIGNUM *r0=NULL,*r1=NULL,*r2=NULL,*r3=NULL,*tmp;\r\nint bitsp,bitsq,ok= -1,n=0,i;\r\nBN_CTX *ctx=NULL,*ctx2=NULL;\r\nctx=BN_CTX_new();\r\nif (ctx == NULL) goto err;\r\nctx2=BN_CTX_new();\r\nif (ctx2 == NULL) goto err;\r\nBN_CTX_start(ctx);\r\nr0 = BN_CTX_get(ctx);\r\nr1 = BN_CTX_get(ctx);\r\nr2 = BN_CTX_get(ctx);\r\nr3 = BN_CTX_get(ctx);\r\nif (r3 == NULL) goto err;\r\nbitsp=(bits+1)/2;\r\nbitsq=bits-bitsp;\r\nrsa=RSA_new();\r\nif (rsa == NULL) goto err;\r\nrsa->e=BN_new();\r\nif (rsa->e == NULL) goto err;\r\n#if 1\r\nfor (i=0; i<sizeof(unsigned long)*8; i++)\r\n{\r\nif (e_value & (1UL<<i))\r\nBN_set_bit(rsa->e,i);\r\n}\r\n#else\r\nif (!BN_set_word(rsa->e,e_value)) goto err;\r\n#endif\r\nfor (;;)\r\n{\r\nrsa->p=BN_generate_prime(NULL,bitsp,0,NULL,NULL,callback,cb_arg);\r\nif (rsa->p == NULL) goto err;\r\nif (!BN_sub(r2,rsa->p,BN_value_one())) goto err;\r\nif (!BN_gcd(r1,r2,rsa->e,ctx)) goto err;\r\nif (BN_is_one(r1)) break;\r\nif (callback != NULL) callback(2,n++,cb_arg);\r\nBN_free(rsa->p);\r\n}\r\nif (callback != NULL) callback(3,0,cb_arg);\r\nfor (;;)\r\n{\r\nrsa->q=BN_generate_prime(NULL,bitsq,0,NULL,NULL,callback,cb_arg);\r\nif (rsa->q == NULL) goto err;\r\nif (!BN_sub(r2,rsa->q,BN_value_one())) goto err;\r\nif (!BN_gcd(r1,r2,rsa->e,ctx)) goto err;\r\nif (BN_is_one(r1) && (BN_cmp(rsa->p,rsa->q) != 0))\r\nbreak;\r\nif (callback != NULL) callback(2,n++,cb_arg);\r\nBN_free(rsa->q);\r\n}\r\nif (callback != NULL) callback(3,1,cb_arg);\r\nif (BN_cmp(rsa->p,rsa->q) < 0)\r\n{\r\ntmp=rsa->p;\r\nrsa->p=rsa->q;\r\nrsa->q=tmp;\r\n}\r\nrsa->n=BN_new();\r\nif (rsa->n == NULL) goto err;\r\nif (!BN_mul(rsa->n,rsa->p,rsa->q,ctx)) goto err;\r\nif (!BN_sub(r1,rsa->p,BN_value_one())) goto err;\r\nif (!BN_sub(r2,rsa->q,BN_value_one())) goto err;\r\nif (!BN_mul(r0,r1,r2,ctx)) goto err;\r\nrsa->d=BN_mod_inverse(NULL,rsa->e,r0,ctx2);\r\nif (rsa->d == NULL) goto err;\r\nrsa->dmp1=BN_new();\r\nif (rsa->dmp1 == NULL) goto err;\r\nif (!BN_mod(rsa->dmp1,rsa->d,r1,ctx)) goto err;\r\nrsa->dmq1=BN_new();\r\nif (rsa->dmq1 == NULL) goto err;\r\nif (!BN_mod(rsa->dmq1,rsa->d,r2,ctx)) goto err;\r\nrsa->iqmp=BN_mod_inverse(NULL,rsa->q,rsa->p,ctx2);\r\nif (rsa->iqmp == NULL) goto err;\r\nok=1;\r\nerr:\r\nif (ok == -1)\r\n{\r\nRSAerr(RSA_F_RSA_GENERATE_KEY,ERR_LIB_BN);\r\nok=0;\r\n}\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\nBN_CTX_free(ctx2);\r\nif (!ok)\r\n{\r\nif (rsa != NULL) RSA_free(rsa);\r\nreturn(NULL);\r\n}\r\nelse\r\nreturn(rsa);\r\n}

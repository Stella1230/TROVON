BN_BLINDING *BN_BLINDING_new(BIGNUM *A, BIGNUM *Ai, BIGNUM *mod)\r\n{\r\nBN_BLINDING *ret=NULL;\r\nbn_check_top(Ai);\r\nbn_check_top(mod);\r\nif ((ret=(BN_BLINDING *)OPENSSL_malloc(sizeof(BN_BLINDING))) == NULL)\r\n{\r\nBNerr(BN_F_BN_BLINDING_NEW,ERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nmemset(ret,0,sizeof(BN_BLINDING));\r\nif ((ret->A=BN_new()) == NULL) goto err;\r\nif ((ret->Ai=BN_new()) == NULL) goto err;\r\nif (!BN_copy(ret->A,A)) goto err;\r\nif (!BN_copy(ret->Ai,Ai)) goto err;\r\nret->mod=mod;\r\nreturn(ret);\r\nerr:\r\nif (ret != NULL) BN_BLINDING_free(ret);\r\nreturn(NULL);\r\n}\r\nvoid BN_BLINDING_free(BN_BLINDING *r)\r\n{\r\nif(r == NULL)\r\nreturn;\r\nif (r->A != NULL) BN_free(r->A );\r\nif (r->Ai != NULL) BN_free(r->Ai);\r\nOPENSSL_free(r);\r\n}\r\nint BN_BLINDING_update(BN_BLINDING *b, BN_CTX *ctx)\r\n{\r\nint ret=0;\r\nif ((b->A == NULL) || (b->Ai == NULL))\r\n{\r\nBNerr(BN_F_BN_BLINDING_UPDATE,BN_R_NOT_INITIALIZED);\r\ngoto err;\r\n}\r\nif (!BN_mod_mul(b->A,b->A,b->A,b->mod,ctx)) goto err;\r\nif (!BN_mod_mul(b->Ai,b->Ai,b->Ai,b->mod,ctx)) goto err;\r\nret=1;\r\nerr:\r\nreturn(ret);\r\n}\r\nint BN_BLINDING_convert(BIGNUM *n, BN_BLINDING *b, BN_CTX *ctx)\r\n{\r\nbn_check_top(n);\r\nif ((b->A == NULL) || (b->Ai == NULL))\r\n{\r\nBNerr(BN_F_BN_BLINDING_CONVERT,BN_R_NOT_INITIALIZED);\r\nreturn(0);\r\n}\r\nreturn(BN_mod_mul(n,n,b->A,b->mod,ctx));\r\n}\r\nint BN_BLINDING_invert(BIGNUM *n, BN_BLINDING *b, BN_CTX *ctx)\r\n{\r\nint ret;\r\nbn_check_top(n);\r\nif ((b->A == NULL) || (b->Ai == NULL))\r\n{\r\nBNerr(BN_F_BN_BLINDING_INVERT,BN_R_NOT_INITIALIZED);\r\nreturn(0);\r\n}\r\nif ((ret=BN_mod_mul(n,n,b->Ai,b->mod,ctx)) >= 0)\r\n{\r\nif (!BN_BLINDING_update(b,ctx))\r\nreturn(0);\r\n}\r\nreturn(ret);\r\n}

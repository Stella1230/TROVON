int i2d_X509_KEY(X509 *a, unsigned char **pp)\r\n{\r\nM_ASN1_I2D_vars(a);\r\nM_ASN1_I2D_len(a->cert_info, i2d_X509_CINF);\r\nM_ASN1_I2D_len(a->sig_alg, i2d_X509_ALGOR);\r\nM_ASN1_I2D_len(a->signature, i2d_ASN1_BIT_STRING);\r\nM_ASN1_I2D_seq_total();\r\nM_ASN1_I2D_put(a->cert_info, i2d_X509_CINF);\r\nM_ASN1_I2D_put(a->sig_alg, i2d_X509_ALGOR);\r\nM_ASN1_I2D_put(a->signature, i2d_ASN1_BIT_STRING);\r\nM_ASN1_I2D_finish();\r\n}\r\nX509 *d2i_X509_KEY(X509 **a, unsigned char **pp, long length)\r\n{\r\nM_ASN1_D2I_vars(a,X509 *,X509_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(ret->cert_info,d2i_X509_CINF);\r\nM_ASN1_D2I_get(ret->sig_alg,d2i_X509_ALGOR);\r\nM_ASN1_D2I_get(ret->signature,d2i_ASN1_BIT_STRING);\r\nM_ASN1_D2I_Finish(a,X509_free,ASN1_F_D2I_X509);\r\n}\r\nX509 *X509_KEY_new(void)\r\n{\r\nX509_KEY *ret=NULL;\r\nM_ASN1_New_OPENSSL_malloc(ret,X509_KEY);\r\nret->references=1;\r\nret->type=NID\r\nM_ASN1_New(ret->cert_info,X509_CINF_new);\r\nM_ASN1_New(ret->sig_alg,X509_ALGOR_new);\r\nM_ASN1_New(ret->signature,ASN1_BIT_STRING_new);\r\nreturn(ret);\r\nM_ASN1_New_Error(ASN1_F_X509_NEW);\r\n}\r\nvoid X509_KEY_free(X509 *a)\r\n{\r\nint i;\r\nif (a == NULL) return;\r\ni=CRYPTO_add_lock(&a->references,-1,CRYPTO_LOCK_X509_KEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_KEY",a);\r\n#endif\r\nif (i > 0) return;\r\n#ifdef REF_CHECK\r\nif (i < 0)\r\n{\r\nfprintf(stderr,"X509_KEY_free, bad reference count\n");\r\nabort();\r\n}\r\n#endif\r\nX509_CINF_free(a->cert_info);\r\nX509_ALGOR_free(a->sig_alg);\r\nASN1_BIT_STRING_free(a->signature);\r\nOPENSSL_free(a);\r\n}

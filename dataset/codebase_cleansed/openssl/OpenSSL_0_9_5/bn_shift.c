int BN_lshift1(BIGNUM *r, BIGNUM *a)\r\n{\r\nregister BN_ULONG *ap,*rp,t,c;\r\nint i;\r\nif (r != a)\r\n{\r\nr->neg=a->neg;\r\nif (bn_wexpand(r,a->top+1) == NULL) return(0);\r\nr->top=a->top;\r\n}\r\nelse\r\n{\r\nif (bn_wexpand(r,a->top+1) == NULL) return(0);\r\n}\r\nap=a->d;\r\nrp=r->d;\r\nc=0;\r\nfor (i=0; i<a->top; i++)\r\n{\r\nt= *(ap++);\r\n*(rp++)=((t<<1)|c)&BN_MASK2;\r\nc=(t & BN_TBIT)?1:0;\r\n}\r\nif (c)\r\n{\r\n*rp=1;\r\nr->top++;\r\n}\r\nreturn(1);\r\n}\r\nint BN_rshift1(BIGNUM *r, BIGNUM *a)\r\n{\r\nBN_ULONG *ap,*rp,t,c;\r\nint i;\r\nif (BN_is_zero(a))\r\n{\r\nBN_zero(r);\r\nreturn(1);\r\n}\r\nif (a != r)\r\n{\r\nif (bn_wexpand(r,a->top) == NULL) return(0);\r\nr->top=a->top;\r\nr->neg=a->neg;\r\n}\r\nap=a->d;\r\nrp=r->d;\r\nc=0;\r\nfor (i=a->top-1; i>=0; i--)\r\n{\r\nt=ap[i];\r\nrp[i]=((t>>1)&BN_MASK2)|c;\r\nc=(t&1)?BN_TBIT:0;\r\n}\r\nbn_fix_top(r);\r\nreturn(1);\r\n}\r\nint BN_lshift(BIGNUM *r, const BIGNUM *a, int n)\r\n{\r\nint i,nw,lb,rb;\r\nBN_ULONG *t,*f;\r\nBN_ULONG l;\r\nr->neg=a->neg;\r\nif (bn_wexpand(r,a->top+(n/BN_BITS2)+1) == NULL) return(0);\r\nnw=n/BN_BITS2;\r\nlb=n%BN_BITS2;\r\nrb=BN_BITS2-lb;\r\nf=a->d;\r\nt=r->d;\r\nt[a->top+nw]=0;\r\nif (lb == 0)\r\nfor (i=a->top-1; i>=0; i--)\r\nt[nw+i]=f[i];\r\nelse\r\nfor (i=a->top-1; i>=0; i--)\r\n{\r\nl=f[i];\r\nt[nw+i+1]|=(l>>rb)&BN_MASK2;\r\nt[nw+i]=(l<<lb)&BN_MASK2;\r\n}\r\nmemset(t,0,nw*sizeof(t[0]));\r\nr->top=a->top+nw+1;\r\nbn_fix_top(r);\r\nreturn(1);\r\n}\r\nint BN_rshift(BIGNUM *r, BIGNUM *a, int n)\r\n{\r\nint i,j,nw,lb,rb;\r\nBN_ULONG *t,*f;\r\nBN_ULONG l,tmp;\r\nnw=n/BN_BITS2;\r\nrb=n%BN_BITS2;\r\nlb=BN_BITS2-rb;\r\nif (nw > a->top)\r\n{\r\nBN_zero(r);\r\nreturn(1);\r\n}\r\nif (r != a)\r\n{\r\nr->neg=a->neg;\r\nif (bn_wexpand(r,a->top-nw+1) == NULL) return(0);\r\n}\r\nf= &(a->d[nw]);\r\nt=r->d;\r\nj=a->top-nw;\r\nr->top=j;\r\nif (rb == 0)\r\n{\r\nfor (i=j+1; i > 0; i--)\r\n*(t++)= *(f++);\r\n}\r\nelse\r\n{\r\nl= *(f++);\r\nfor (i=1; i<j; i++)\r\n{\r\ntmp =(l>>rb)&BN_MASK2;\r\nl= *(f++);\r\n*(t++) =(tmp|(l<<lb))&BN_MASK2;\r\n}\r\n*(t++) =(l>>rb)&BN_MASK2;\r\n}\r\n*t=0;\r\nbn_fix_top(r);\r\nreturn(1);\r\n}

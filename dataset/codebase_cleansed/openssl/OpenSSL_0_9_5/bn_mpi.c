int BN_bn2mpi(const BIGNUM *a, unsigned char *d)\r\n{\r\nint bits;\r\nint num=0;\r\nint ext=0;\r\nlong l;\r\nbits=BN_num_bits(a);\r\nnum=(bits+7)/8;\r\nif (bits > 0)\r\n{\r\next=((bits & 0x07) == 0);\r\n}\r\nif (d == NULL)\r\nreturn(num+4+ext);\r\nl=num+ext;\r\nd[0]=(unsigned char)(l>>24)&0xff;\r\nd[1]=(unsigned char)(l>>16)&0xff;\r\nd[2]=(unsigned char)(l>> 8)&0xff;\r\nd[3]=(unsigned char)(l )&0xff;\r\nif (ext) d[4]=0;\r\nnum=BN_bn2bin(a,&(d[4+ext]));\r\nif (a->neg)\r\nd[4]|=0x80;\r\nreturn(num+4+ext);\r\n}\r\nBIGNUM *BN_mpi2bn(unsigned char *d, int n, BIGNUM *a)\r\n{\r\nlong len;\r\nint neg=0;\r\nif (n < 4)\r\n{\r\nBNerr(BN_F_BN_MPI2BN,BN_R_INVALID_LENGTH);\r\nreturn(NULL);\r\n}\r\nlen=((long)d[0]<<24)|((long)d[1]<<16)|((int)d[2]<<8)|(int)d[3];\r\nif ((len+4) != n)\r\n{\r\nBNerr(BN_F_BN_MPI2BN,BN_R_ENCODING_ERROR);\r\nreturn(NULL);\r\n}\r\nif (a == NULL) a=BN_new();\r\nif (a == NULL) return(NULL);\r\nif (len == 0)\r\n{\r\na->neg=0;\r\na->top=0;\r\nreturn(a);\r\n}\r\nd+=4;\r\nif ((*d) & 0x80)\r\nneg=1;\r\nif (BN_bin2bn(d,(int)len,a) == NULL)\r\nreturn(NULL);\r\na->neg=neg;\r\nif (neg)\r\n{\r\nBN_clear_bit(a,BN_num_bits(a)-1);\r\n}\r\nreturn(a);\r\n}

void des_ofb_encrypt(const unsigned char *in, unsigned char *out, int numbits,\r\nlong length, des_key_schedule schedule, des_cblock *ivec)\r\n{\r\nregister DES_LONG d0,d1,vv0,vv1,v0,v1,n=(numbits+7)/8;\r\nregister DES_LONG mask0,mask1;\r\nregister long l=length;\r\nregister int num=numbits;\r\nDES_LONG ti[2];\r\nunsigned char *iv;\r\nif (num > 64) return;\r\nif (num > 32)\r\n{\r\nmask0=0xffffffffL;\r\nif (num >= 64)\r\nmask1=mask0;\r\nelse\r\nmask1=(1L<<(num-32))-1;\r\n}\r\nelse\r\n{\r\nif (num == 32)\r\nmask0=0xffffffffL;\r\nelse\r\nmask0=(1L<<num)-1;\r\nmask1=0x00000000L;\r\n}\r\niv = &(*ivec)[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\nti[0]=v0;\r\nti[1]=v1;\r\nwhile (l-- > 0)\r\n{\r\nti[0]=v0;\r\nti[1]=v1;\r\ndes_encrypt((DES_LONG *)ti,schedule,DES_ENCRYPT);\r\nvv0=ti[0];\r\nvv1=ti[1];\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nd0=(d0^vv0)&mask0;\r\nd1=(d1^vv1)&mask1;\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\nif (num == 32)\r\n{ v0=v1; v1=vv0; }\r\nelse if (num == 64)\r\n{ v0=vv0; v1=vv1; }\r\nelse if (num > 32)\r\n{\r\nv0=((v1>>(num-32))|(vv0<<(64-num)))&0xffffffffL;\r\nv1=((vv0>>(num-32))|(vv1<<(64-num)))&0xffffffffL;\r\n}\r\nelse\r\n{\r\nv0=((v0>>num)|(v1<<(32-num)))&0xffffffffL;\r\nv1=((v1>>num)|(vv0<<(32-num)))&0xffffffffL;\r\n}\r\n}\r\niv = &(*ivec)[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nv0=v1=d0=d1=ti[0]=ti[1]=vv0=vv1=0;\r\n}

int PKCS5_PBKDF2_HMAC_SHA1(const char *pass, int passlen,\r\nunsigned char *salt, int saltlen, int iter,\r\nint keylen, unsigned char *out)\r\n{\r\nunsigned char digtmp[SHA_DIGEST_LENGTH], *p, itmp[4];\r\nint cplen, j, k, tkeylen;\r\nunsigned long i = 1;\r\nHMAC_CTX hctx;\r\np = out;\r\ntkeylen = keylen;\r\nif(passlen == -1) passlen = strlen(pass);\r\nwhile(tkeylen) {\r\nif(tkeylen > SHA_DIGEST_LENGTH) cplen = SHA_DIGEST_LENGTH;\r\nelse cplen = tkeylen;\r\nitmp[0] = (unsigned char)((i >> 24) & 0xff);\r\nitmp[1] = (unsigned char)((i >> 16) & 0xff);\r\nitmp[2] = (unsigned char)((i >> 8) & 0xff);\r\nitmp[3] = (unsigned char)(i & 0xff);\r\nHMAC_Init(&hctx, pass, passlen, EVP_sha1());\r\nHMAC_Update(&hctx, salt, saltlen);\r\nHMAC_Update(&hctx, itmp, 4);\r\nHMAC_Final(&hctx, digtmp, NULL);\r\nmemcpy(p, digtmp, cplen);\r\nfor(j = 1; j < iter; j++) {\r\nHMAC(EVP_sha1(), pass, passlen,\r\ndigtmp, SHA_DIGEST_LENGTH, digtmp, NULL);\r\nfor(k = 0; k < cplen; k++) p[k] ^= digtmp[k];\r\n}\r\ntkeylen-= cplen;\r\ni++;\r\np+= cplen;\r\n}\r\nHMAC_cleanup(&hctx);\r\n#ifdef DEBUG_PKCS5V2\r\nfprintf(stderr, "Password:\n");\r\nh__dump (pass, passlen);\r\nfprintf(stderr, "Salt:\n");\r\nh__dump (salt, saltlen);\r\nfprintf(stderr, "Iteration count %d\n", iter);\r\nfprintf(stderr, "Key:\n");\r\nh__dump (out, keylen);\r\n#endif\r\nreturn 1;\r\n}\r\nmain()\r\n{\r\nunsigned char out[4];\r\nunsigned char salt[] = {0x12, 0x34, 0x56, 0x78};\r\nPKCS5_PBKDF2_HMAC_SHA1("password", -1, salt, 4, 5, 4, out);\r\nfprintf(stderr, "Out %02X %02X %02X %02X\n",\r\nout[0], out[1], out[2], out[3]);\r\n}\r\nint PKCS5_v2_PBE_keyivgen(EVP_CIPHER_CTX *ctx, const char *pass, int passlen,\r\nASN1_TYPE *param, EVP_CIPHER *c, EVP_MD *md,\r\nint en_de)\r\n{\r\nunsigned char *pbuf, *salt, key[EVP_MAX_KEY_LENGTH];\r\nint saltlen, keylen, iter, plen;\r\nPBE2PARAM *pbe2 = NULL;\r\nconst EVP_CIPHER *cipher;\r\nPBKDF2PARAM *kdf = NULL;\r\npbuf = param->value.sequence->data;\r\nplen = param->value.sequence->length;\r\nif(!param || (param->type != V_ASN1_SEQUENCE) ||\r\n!(pbe2 = d2i_PBE2PARAM(NULL, &pbuf, plen))) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,EVP_R_DECODE_ERROR);\r\nreturn 0;\r\n}\r\nif(OBJ_obj2nid(pbe2->keyfunc->algorithm) != NID_id_pbkdf2) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,\r\nEVP_R_UNSUPPORTED_KEY_DERIVATION_FUNCTION);\r\ngoto err;\r\n}\r\ncipher = EVP_get_cipherbyname(\r\nOBJ_nid2sn(OBJ_obj2nid(pbe2->encryption->algorithm)));\r\nif(!cipher) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,\r\nEVP_R_UNSUPPORTED_CIPHER);\r\ngoto err;\r\n}\r\nEVP_CipherInit(ctx, cipher, NULL, NULL, en_de);\r\nif(EVP_CIPHER_asn1_to_param(ctx, pbe2->encryption->parameter) < 0) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,\r\nEVP_R_CIPHER_PARAMETER_ERROR);\r\ngoto err;\r\n}\r\nkeylen = EVP_CIPHER_CTX_key_length(ctx);\r\npbuf = pbe2->keyfunc->parameter->value.sequence->data;\r\nplen = pbe2->keyfunc->parameter->value.sequence->length;\r\nif(!pbe2->keyfunc->parameter ||\r\n(pbe2->keyfunc->parameter->type != V_ASN1_SEQUENCE) ||\r\n!(kdf = d2i_PBKDF2PARAM(NULL, &pbuf, plen)) ) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,EVP_R_DECODE_ERROR);\r\ngoto err;\r\n}\r\nPBE2PARAM_free(pbe2);\r\npbe2 = NULL;\r\nif(kdf->keylength && (ASN1_INTEGER_get(kdf->keylength) != keylen)){\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,\r\nEVP_R_UNSUPPORTED_KEYLENGTH);\r\ngoto err;\r\n}\r\nif(kdf->prf && (OBJ_obj2nid(kdf->prf->algorithm) != NID_hmacWithSHA1)) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN, EVP_R_UNSUPPORTED_PRF);\r\ngoto err;\r\n}\r\nif(kdf->salt->type != V_ASN1_OCTET_STRING) {\r\nEVPerr(EVP_F_PKCS5_V2_PBE_KEYIVGEN,\r\nEVP_R_UNSUPPORTED_SALT_TYPE);\r\ngoto err;\r\n}\r\nsalt = kdf->salt->value.octet_string->data;\r\nsaltlen = kdf->salt->value.octet_string->length;\r\niter = ASN1_INTEGER_get(kdf->iter);\r\nPKCS5_PBKDF2_HMAC_SHA1(pass, passlen, salt, saltlen, iter, keylen, key);\r\nEVP_CipherInit(ctx, NULL, key, NULL, en_de);\r\nmemset(key, 0, keylen);\r\nPBKDF2PARAM_free(kdf);\r\nreturn 1;\r\nerr:\r\nPBE2PARAM_free(pbe2);\r\nPBKDF2PARAM_free(kdf);\r\nreturn 0;\r\n}\r\nstatic void h__dump (const unsigned char *p, int len)\r\n{\r\nfor (; len --; p++) fprintf(stderr, "%02X ", *p);\r\nfprintf(stderr, "\n");\r\n}

STACK *ASN1_seq_unpack(unsigned char *buf, int len, char *(*d2i)(),\r\nvoid (*free_func)())\r\n{\r\nSTACK *sk;\r\nunsigned char *pbuf;\r\npbuf = buf;\r\nif (!(sk = d2i_ASN1_SET(NULL, &pbuf, len, d2i, free_func,\r\nV_ASN1_SEQUENCE, V_ASN1_UNIVERSAL)))\r\nASN1err(ASN1_F_ASN1_SEQ_UNPACK,ASN1_R_DECODE_ERROR);\r\nreturn sk;\r\n}\r\nunsigned char *ASN1_seq_pack(STACK *safes, int (*i2d)(), unsigned char **buf,\r\nint *len)\r\n{\r\nint safelen;\r\nunsigned char *safe, *p;\r\nif (!(safelen = i2d_ASN1_SET(safes, NULL, i2d, V_ASN1_SEQUENCE,\r\nV_ASN1_UNIVERSAL, IS_SEQUENCE))) {\r\nASN1err(ASN1_F_ASN1_SEQ_PACK,ASN1_R_ENCODE_ERROR);\r\nreturn NULL;\r\n}\r\nif (!(safe = Malloc (safelen))) {\r\nASN1err(ASN1_F_ASN1_SEQ_PACK,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\np = safe;\r\ni2d_ASN1_SET(safes, &p, i2d, V_ASN1_SEQUENCE, V_ASN1_UNIVERSAL,\r\nIS_SEQUENCE);\r\nif (len) *len = safelen;\r\nif (buf) *buf = safe;\r\nreturn safe;\r\n}\r\nvoid *ASN1_unpack_string (ASN1_STRING *oct, char *(*d2i)())\r\n{\r\nunsigned char *p;\r\nchar *ret;\r\np = oct->data;\r\nif(!(ret = d2i(NULL, &p, oct->length)))\r\nASN1err(ASN1_F_ASN1_UNPACK_STRING,ASN1_R_DECODE_ERROR);\r\nreturn ret;\r\n}\r\nASN1_STRING *ASN1_pack_string (void *obj, int (*i2d)(), ASN1_STRING **oct)\r\n{\r\nunsigned char *p;\r\nASN1_STRING *octmp;\r\nif (!oct || !*oct) {\r\nif (!(octmp = ASN1_STRING_new ())) {\r\nASN1err(ASN1_F_ASN1_PACK_STRING,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\nif (oct) *oct = octmp;\r\n} else octmp = *oct;\r\nif (!(octmp->length = i2d(obj, NULL))) {\r\nASN1err(ASN1_F_ASN1_PACK_STRING,ASN1_R_ENCODE_ERROR);\r\nreturn NULL;\r\n}\r\nif (!(p = Malloc (octmp->length))) {\r\nASN1err(ASN1_F_ASN1_PACK_STRING,ERR_R_MALLOC_FAILURE);\r\nreturn NULL;\r\n}\r\noctmp->data = p;\r\ni2d (obj, &p);\r\nreturn octmp;\r\n}

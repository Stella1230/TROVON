void PKCS5_PBE_add(void)\r\n{\r\n#ifndef NO_DES\r\n# ifndef NO_MD5\r\nEVP_PBE_alg_add(NID_pbeWithMD5AndDES_CBC, EVP_des_cbc(), EVP_md5(),\r\nPKCS5_PBE_keyivgen);\r\n# endif\r\n# ifndef NO_MD2\r\nEVP_PBE_alg_add(NID_pbeWithMD2AndDES_CBC, EVP_des_cbc(), EVP_md2(),\r\nPKCS5_PBE_keyivgen);\r\n# endif\r\n# ifndef NO_SHA\r\nEVP_PBE_alg_add(NID_pbeWithSHA1AndDES_CBC, EVP_des_cbc(), EVP_sha1(),\r\nPKCS5_PBE_keyivgen);\r\n# endif\r\n#endif\r\n#ifndef NO_RC2\r\n# ifndef NO_MD5\r\nEVP_PBE_alg_add(NID_pbeWithMD5AndRC2_CBC, EVP_rc2_64_cbc(), EVP_md5(),\r\nPKCS5_PBE_keyivgen);\r\n# endif\r\n# ifndef NO_MD2\r\nEVP_PBE_alg_add(NID_pbeWithMD2AndRC2_CBC, EVP_rc2_64_cbc(), EVP_md2(),\r\nPKCS5_PBE_keyivgen);\r\n# endif\r\n# ifndef NO_SHA\r\nEVP_PBE_alg_add(NID_pbeWithSHA1AndRC2_CBC, EVP_rc2_64_cbc(), EVP_sha1(),\r\nPKCS5_PBE_keyivgen);\r\n# endif\r\n#endif\r\n#ifndef NO_HMAC\r\nEVP_PBE_alg_add(NID_pbes2, NULL, NULL, PKCS5_v2_PBE_keyivgen);\r\n#endif\r\n}\r\nint PKCS5_PBE_keyivgen(EVP_CIPHER_CTX *cctx, const char *pass, int passlen,\r\nASN1_TYPE *param, EVP_CIPHER *cipher, EVP_MD *md,\r\nint en_de)\r\n{\r\nEVP_MD_CTX ctx;\r\nunsigned char md_tmp[EVP_MAX_MD_SIZE];\r\nunsigned char key[EVP_MAX_KEY_LENGTH], iv[EVP_MAX_IV_LENGTH];\r\nint i;\r\nPBEPARAM *pbe;\r\nint saltlen, iter;\r\nunsigned char *salt, *pbuf;\r\npbuf = param->value.sequence->data;\r\nif (!param || (param->type != V_ASN1_SEQUENCE) ||\r\n!(pbe = d2i_PBEPARAM (NULL, &pbuf, param->value.sequence->length))) {\r\nEVPerr(EVP_F_PKCS5_PBE_KEYIVGEN,EVP_R_DECODE_ERROR);\r\nreturn 0;\r\n}\r\nif (!pbe->iter) iter = 1;\r\nelse iter = ASN1_INTEGER_get (pbe->iter);\r\nsalt = pbe->salt->data;\r\nsaltlen = pbe->salt->length;\r\nEVP_DigestInit (&ctx, md);\r\nEVP_DigestUpdate (&ctx, pass, passlen);\r\nEVP_DigestUpdate (&ctx, salt, saltlen);\r\nPBEPARAM_free(pbe);\r\nEVP_DigestFinal (&ctx, md_tmp, NULL);\r\nfor (i = 1; i < iter; i++) {\r\nEVP_DigestInit(&ctx, md);\r\nEVP_DigestUpdate(&ctx, md_tmp, EVP_MD_size(md));\r\nEVP_DigestFinal (&ctx, md_tmp, NULL);\r\n}\r\nmemcpy (key, md_tmp, EVP_CIPHER_key_length(cipher));\r\nmemcpy (iv, md_tmp + (16 - EVP_CIPHER_iv_length(cipher)),\r\nEVP_CIPHER_iv_length(cipher));\r\nEVP_CipherInit(cctx, cipher, key, iv, en_de);\r\nmemset(md_tmp, 0, EVP_MAX_MD_SIZE);\r\nmemset(key, 0, EVP_MAX_KEY_LENGTH);\r\nmemset(iv, 0, EVP_MAX_IV_LENGTH);\r\nreturn 1;\r\n}

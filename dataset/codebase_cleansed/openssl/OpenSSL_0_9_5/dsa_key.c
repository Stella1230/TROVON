int DSA_generate_key(DSA *dsa)\r\n{\r\nint ok=0;\r\nunsigned int i;\r\nBN_CTX *ctx=NULL;\r\nBIGNUM *pub_key=NULL,*priv_key=NULL;\r\nif ((ctx=BN_CTX_new()) == NULL) goto err;\r\nif (dsa->priv_key == NULL)\r\n{\r\nif ((priv_key=BN_new()) == NULL) goto err;\r\n}\r\nelse\r\npriv_key=dsa->priv_key;\r\ni=BN_num_bits(dsa->q);\r\nfor (;;)\r\n{\r\nBN_rand(priv_key,i,1,0);\r\nif (BN_cmp(priv_key,dsa->q) >= 0)\r\nBN_sub(priv_key,priv_key,dsa->q);\r\nif (!BN_is_zero(priv_key)) break;\r\n}\r\nif (dsa->pub_key == NULL)\r\n{\r\nif ((pub_key=BN_new()) == NULL) goto err;\r\n}\r\nelse\r\npub_key=dsa->pub_key;\r\nif (!BN_mod_exp(pub_key,dsa->g,priv_key,dsa->p,ctx)) goto err;\r\ndsa->priv_key=priv_key;\r\ndsa->pub_key=pub_key;\r\nok=1;\r\nerr:\r\nif ((pub_key != NULL) && (dsa->pub_key == NULL)) BN_free(pub_key);\r\nif ((priv_key != NULL) && (dsa->priv_key == NULL)) BN_free(priv_key);\r\nif (ctx != NULL) BN_CTX_free(ctx);\r\nreturn(ok);\r\n}

static int zlib_compress_block(COMP_CTX *ctx, unsigned char *out,\r\nunsigned int olen, unsigned char *in, unsigned int ilen)\r\n{\r\nunsigned long l;\r\nint i;\r\nint clear=1;\r\nif (ilen > 128)\r\n{\r\nout[0]=1;\r\nl=olen-1;\r\ni=compress(&(out[1]),&l,in,(unsigned long)ilen);\r\nif (i != Z_OK)\r\nreturn(-1);\r\nif (ilen > l)\r\n{\r\nclear=0;\r\nl++;\r\n}\r\n}\r\nif (clear)\r\n{\r\nout[0]=0;\r\nmemcpy(&(out[1]),in,ilen);\r\nl=ilen+1;\r\n}\r\nfprintf(stderr,"compress(%4d)->%4d %s\n",ilen,(int)l,(clear)?"clear":"zlib");\r\nreturn((int)l);\r\n}\r\nstatic int zlib_expand_block(COMP_CTX *ctx, unsigned char *out,\r\nunsigned int olen, unsigned char *in, unsigned int ilen)\r\n{\r\nunsigned long l;\r\nint i;\r\nif (in[0])\r\n{\r\nl=olen;\r\ni=zz_uncompress(out,&l,&(in[1]),(unsigned long)ilen-1);\r\nif (i != Z_OK)\r\nreturn(-1);\r\n}\r\nelse\r\n{\r\nmemcpy(out,&(in[1]),ilen-1);\r\nl=ilen-1;\r\n}\r\nfprintf(stderr,"expand (%4d)->%4d %s\n",ilen,(int)l,in[0]?"zlib":"clear");\r\nreturn((int)l);\r\n}\r\nstatic int zz_uncompress (Bytef *dest, uLongf *destLen, const Bytef *source,\r\nuLong sourceLen)\r\n{\r\nz_stream stream;\r\nint err;\r\nstream.next_in = (Bytef*)source;\r\nstream.avail_in = (uInt)sourceLen;\r\nif ((uLong)stream.avail_in != sourceLen) return Z_BUF_ERROR;\r\nstream.next_out = dest;\r\nstream.avail_out = (uInt)*destLen;\r\nif ((uLong)stream.avail_out != *destLen) return Z_BUF_ERROR;\r\nstream.zalloc = (alloc_func)0;\r\nstream.zfree = (free_func)0;\r\nerr = inflateInit(&stream);\r\nif (err != Z_OK) return err;\r\nerr = inflate(&stream, Z_FINISH);\r\nif (err != Z_STREAM_END) {\r\ninflateEnd(&stream);\r\nreturn err;\r\n}\r\n*destLen = stream.total_out;\r\nerr = inflateEnd(&stream);\r\nreturn err;\r\n}\r\nCOMP_METHOD *COMP_zlib(void)\r\n{\r\nreturn(&zlib_method);\r\n}

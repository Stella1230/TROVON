int EVP_VerifyFinal(EVP_MD_CTX *ctx, unsigned char *sigbuf,\r\nunsigned int siglen, EVP_PKEY *pkey)\r\n{\r\nunsigned char m[EVP_MAX_MD_SIZE];\r\nunsigned int m_len;\r\nint i,ok=0,v;\r\nMS_STATIC EVP_MD_CTX tmp_ctx;\r\nfor (i=0; i<4; i++)\r\n{\r\nv=ctx->digest->required_pkey_type[i];\r\nif (v == 0) break;\r\nif (pkey->type == v)\r\n{\r\nok=1;\r\nbreak;\r\n}\r\n}\r\nif (!ok)\r\n{\r\nEVPerr(EVP_F_EVP_VERIFYFINAL,EVP_R_WRONG_PUBLIC_KEY_TYPE);\r\nreturn(-1);\r\n}\r\nEVP_MD_CTX_copy(&tmp_ctx,ctx);\r\nEVP_DigestFinal(&tmp_ctx,&(m[0]),&m_len);\r\nif (ctx->digest->verify == NULL)\r\n{\r\nEVPerr(EVP_F_EVP_VERIFYFINAL,EVP_R_NO_VERIFY_FUNCTION_CONFIGURED);\r\nreturn(0);\r\n}\r\nreturn(ctx->digest->verify(ctx->digest->type,m,m_len,\r\nsigbuf,siglen,pkey->pkey.ptr));\r\n}

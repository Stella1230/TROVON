int i2d_PKCS12_SAFEBAG(PKCS12_SAFEBAG *a, unsigned char **pp)\r\n{\r\nint bagnid, v = 0;\r\nM_ASN1_I2D_vars(a);\r\nbagnid = OBJ_obj2nid (a->type);\r\nM_ASN1_I2D_len (a->type, i2d_ASN1_OBJECT);\r\nswitch (bagnid) {\r\ncase NID_keyBag:\r\nM_ASN1_I2D_len_EXP_opt (a->value.keybag,\r\ni2d_PKCS8_PRIV_KEY_INFO, 0, v);\r\nbreak;\r\ncase NID_pkcs8ShroudedKeyBag:\r\nM_ASN1_I2D_len_EXP_opt (a->value.shkeybag,\r\ni2d_X509_SIG, 0, v);\r\nbreak;\r\ncase NID_safeContentsBag:\r\nM_ASN1_I2D_len_EXP_SEQUENCE_opt (a->value.safes,\r\ni2d_PKCS12_SAFEBAG, 0, V_ASN1_SEQUENCE, v);\r\nbreak;\r\ncase NID_certBag:\r\ncase NID_crlBag:\r\ncase NID_secretBag:\r\nM_ASN1_I2D_len_EXP_opt (a->value.bag,\r\ni2d_PKCS12_BAGS, 0, v);\r\nbreak;\r\ndefault:\r\nM_ASN1_I2D_len_EXP_opt (a->value.other,\r\ni2d_ASN1_TYPE, 0, v);\r\nbreak;\r\n}\r\nM_ASN1_I2D_len_SET_type (X509_ATTRIBUTE,a->attrib, i2d_X509_ATTRIBUTE);\r\nM_ASN1_I2D_seq_total ();\r\nM_ASN1_I2D_put (a->type, i2d_ASN1_OBJECT);\r\nswitch (bagnid) {\r\ncase NID_keyBag:\r\nM_ASN1_I2D_put_EXP_opt (a->value.keybag,\r\ni2d_PKCS8_PRIV_KEY_INFO, 0, v);\r\nbreak;\r\ncase NID_pkcs8ShroudedKeyBag:\r\nM_ASN1_I2D_put_EXP_opt (a->value.shkeybag,\r\ni2d_X509_SIG, 0, v);\r\nbreak;\r\ncase NID_safeContentsBag:\r\nM_ASN1_I2D_put_EXP_SEQUENCE_opt (a->value.safes,\r\ni2d_PKCS12_SAFEBAG, 0, V_ASN1_SEQUENCE, v);\r\nbreak;\r\ncase NID_certBag:\r\ncase NID_crlBag:\r\ncase NID_secretBag:\r\nM_ASN1_I2D_put_EXP_opt (a->value.bag,\r\ni2d_PKCS12_BAGS, 0, v);\r\nbreak;\r\ndefault:\r\nM_ASN1_I2D_put_EXP_opt (a->value.other,\r\ni2d_ASN1_TYPE, 0, v);\r\nbreak;\r\n}\r\nM_ASN1_I2D_put_SET_type (X509_ATTRIBUTE, a->attrib, i2d_X509_ATTRIBUTE);\r\nM_ASN1_I2D_finish();\r\n}\r\nPKCS12_SAFEBAG *PKCS12_SAFEBAG_new(void)\r\n{\r\nPKCS12_SAFEBAG *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret, PKCS12_SAFEBAG);\r\nret->type=NULL;\r\nret->value.other=NULL;\r\nM_ASN1_New(ret->attrib, sk_X509_ATTRIBUTE_new_null);\r\nret->rest=NULL;\r\nreturn (ret);\r\nM_ASN1_New_Error(ASN1_F_PKCS12_SAFEBAG_NEW);\r\n}\r\nPKCS12_SAFEBAG *d2i_PKCS12_SAFEBAG(PKCS12_SAFEBAG **a, unsigned char **pp,\r\nlong length)\r\n{\r\nint bagnid;\r\nM_ASN1_D2I_vars(a,PKCS12_SAFEBAG *,PKCS12_SAFEBAG_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get (ret->type, d2i_ASN1_OBJECT);\r\nbagnid = OBJ_obj2nid (ret->type);\r\nswitch (bagnid) {\r\ncase NID_keyBag:\r\nM_ASN1_D2I_get_EXP_opt (ret->value.keybag,\r\nd2i_PKCS8_PRIV_KEY_INFO, 0);\r\nbreak;\r\ncase NID_pkcs8ShroudedKeyBag:\r\nM_ASN1_D2I_get_EXP_opt (ret->value.shkeybag,\r\nd2i_X509_SIG, 0);\r\nbreak;\r\ncase NID_safeContentsBag:\r\nM_ASN1_D2I_get_EXP_set_opt(ret->value.safes,\r\nd2i_PKCS12_SAFEBAG, PKCS12_SAFEBAG_free,\r\n0, V_ASN1_SEQUENCE);\r\nbreak;\r\ncase NID_certBag:\r\ncase NID_crlBag:\r\ncase NID_secretBag:\r\nM_ASN1_D2I_get_EXP_opt (ret->value.bag,\r\nd2i_PKCS12_BAGS, 0);\r\nbreak;\r\ndefault:\r\nM_ASN1_D2I_get_EXP_opt (ret->value.other,\r\nd2i_ASN1_TYPE, 0);\r\nbreak;\r\n}\r\nM_ASN1_D2I_get_set_opt_type(X509_ATTRIBUTE,ret->attrib,\r\nd2i_X509_ATTRIBUTE,X509_ATTRIBUTE_free);\r\nM_ASN1_D2I_Finish(a, PKCS12_SAFEBAG_free, ASN1_F_D2I_PKCS12_SAFEBAG);\r\n}\r\nvoid PKCS12_SAFEBAG_free (PKCS12_SAFEBAG *a)\r\n{\r\nif (a == NULL) return;\r\nswitch (OBJ_obj2nid(a->type)) {\r\ncase NID_keyBag:\r\nPKCS8_PRIV_KEY_INFO_free (a->value.keybag);\r\nbreak;\r\ncase NID_pkcs8ShroudedKeyBag:\r\nX509_SIG_free (a->value.shkeybag);\r\nbreak;\r\ncase NID_certBag:\r\ncase NID_crlBag:\r\ncase NID_secretBag:\r\nPKCS12_BAGS_free (a->value.bag);\r\nbreak;\r\ndefault:\r\nASN1_TYPE_free (a->value.other);\r\nbreak;\r\n}\r\nASN1_OBJECT_free (a->type);\r\nsk_X509_ATTRIBUTE_pop_free (a->attrib, X509_ATTRIBUTE_free);\r\nFree (a);\r\n}

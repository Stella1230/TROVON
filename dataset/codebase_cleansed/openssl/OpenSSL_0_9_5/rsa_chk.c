int RSA_check_key(RSA *key)\r\n{\r\nBIGNUM *i, *j, *k, *l, *m;\r\nBN_CTX *ctx;\r\nint r;\r\nint ret=1;\r\ni = BN_new();\r\nj = BN_new();\r\nk = BN_new();\r\nl = BN_new();\r\nm = BN_new();\r\nctx = BN_CTX_new();\r\nif (i == NULL || j == NULL || k == NULL || l == NULL ||\r\nm == NULL || ctx == NULL)\r\n{\r\nret = -1;\r\nRSAerr(RSA_F_RSA_CHECK_KEY, ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nr = BN_is_prime(key->p, BN_prime_checks, NULL, NULL, NULL);\r\nif (r != 1)\r\n{\r\nret = r;\r\nif (r != 0)\r\ngoto err;\r\nRSAerr(RSA_F_RSA_CHECK_KEY, RSA_R_P_NOT_PRIME);\r\n}\r\nr = BN_is_prime(key->q, BN_prime_checks, NULL, NULL, NULL);\r\nif (r != 1)\r\n{\r\nret = r;\r\nif (r != 0)\r\ngoto err;\r\nRSAerr(RSA_F_RSA_CHECK_KEY, RSA_R_Q_NOT_PRIME);\r\n}\r\nr = BN_mul(i, key->p, key->q, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nif (BN_cmp(i, key->n) != 0)\r\n{\r\nret = 0;\r\nRSAerr(RSA_F_RSA_CHECK_KEY, RSA_R_N_DOES_NOT_EQUAL_P_Q);\r\n}\r\nr = BN_sub(i, key->p, BN_value_one());\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_sub(j, key->q, BN_value_one());\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_mul(l, i, j, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_gcd(m, i, j, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_div(k, NULL, l, m, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_mod_mul(i, key->d, key->e, k, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nif (!BN_is_one(i))\r\n{\r\nret = 0;\r\nRSAerr(RSA_F_RSA_CHECK_KEY, RSA_R_D_E_NOT_CONGRUENT_TO_1);\r\n}\r\nif (key->dmp1 != NULL && key->dmq1 != NULL && key->iqmp != NULL)\r\n{\r\nr = BN_sub(i, key->p, BN_value_one());\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_mod(j, key->d, i, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nif (BN_cmp(j, key->dmp1) != 0)\r\n{\r\nret = 0;\r\nRSAerr(RSA_F_RSA_CHECK_KEY,\r\nRSA_R_DMP1_NOT_CONGRUENT_TO_D);\r\n}\r\nr = BN_sub(i, key->q, BN_value_one());\r\nif (!r) { ret = -1; goto err; }\r\nr = BN_mod(j, key->d, i, ctx);\r\nif (!r) { ret = -1; goto err; }\r\nif (BN_cmp(j, key->dmq1) != 0)\r\n{\r\nret = 0;\r\nRSAerr(RSA_F_RSA_CHECK_KEY,\r\nRSA_R_DMQ1_NOT_CONGRUENT_TO_D);\r\n}\r\nif(!BN_mod_inverse(i, key->q, key->p, ctx))\r\n{\r\nret = -1;\r\ngoto err;\r\n}\r\nif (BN_cmp(i, key->iqmp) != 0)\r\n{\r\nret = 0;\r\nRSAerr(RSA_F_RSA_CHECK_KEY,\r\nRSA_R_IQMP_NOT_INVERSE_OF_Q);\r\n}\r\n}\r\nerr:\r\nif (i != NULL) BN_free(i);\r\nif (j != NULL) BN_free(j);\r\nif (k != NULL) BN_free(k);\r\nif (l != NULL) BN_free(l);\r\nif (m != NULL) BN_free(m);\r\nif (ctx != NULL) BN_CTX_free(ctx);\r\nreturn (ret);\r\n}

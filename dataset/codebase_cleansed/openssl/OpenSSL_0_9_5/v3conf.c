int main(int argc, char **argv)\r\n{\r\nLHASH *conf;\r\nX509 *cert;\r\nFILE *inf;\r\nchar *conf_file;\r\nint i;\r\nint count;\r\nX509_EXTENSION *ext;\r\nX509V3_add_standard_extensions();\r\nERR_load_crypto_strings();\r\nif(!argv[1]) {\r\nfprintf(stderr, "Usage: v3conf cert.pem [file.cnf]\n");\r\nexit(1);\r\n}\r\nconf_file = argv[2];\r\nif(!conf_file) conf_file = "test.cnf";\r\nconf = CONF_load(NULL, "test.cnf", NULL);\r\nif(!conf) {\r\nfprintf(stderr, "Error opening Config file %s\n", conf_file);\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}\r\ninf = fopen(argv[1], "r");\r\nif(!inf) {\r\nfprintf(stderr, "Can't open certificate file %s\n", argv[1]);\r\nexit(1);\r\n}\r\ncert = PEM_read_X509(inf, NULL, NULL);\r\nif(!cert) {\r\nfprintf(stderr, "Error reading certificate file %s\n", argv[1]);\r\nexit(1);\r\n}\r\nfclose(inf);\r\nsk_pop_free(cert->cert_info->extensions, X509_EXTENSION_free);\r\ncert->cert_info->extensions = NULL;\r\nif(!X509V3_EXT_add_conf(conf, NULL, "test_section", cert)) {\r\nfprintf(stderr, "Error adding extensions\n");\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}\r\ncount = X509_get_ext_count(cert);\r\nprintf("%d extensions\n", count);\r\nfor(i = 0; i < count; i++) {\r\next = X509_get_ext(cert, i);\r\nprintf("%s", OBJ_nid2ln(OBJ_obj2nid(ext->object)));\r\nif(ext->critical) printf(",critical:\n");\r\nelse printf(":\n");\r\nX509V3_EXT_print_fp(stdout, ext, 0);\r\nprintf("\n");\r\n}\r\nreturn 0;\r\n}

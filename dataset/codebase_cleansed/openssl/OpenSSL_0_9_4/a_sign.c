int ASN1_sign(int (*i2d)(), X509_ALGOR *algor1, X509_ALGOR *algor2,\r\nASN1_BIT_STRING *signature, char *data, EVP_PKEY *pkey,\r\nconst EVP_MD *type)\r\n{\r\nEVP_MD_CTX ctx;\r\nunsigned char *p,*buf_in=NULL,*buf_out=NULL;\r\nint i,inl=0,outl=0,outll=0;\r\nX509_ALGOR *a;\r\nfor (i=0; i<2; i++)\r\n{\r\nif (i == 0)\r\na=algor1;\r\nelse\r\na=algor2;\r\nif (a == NULL) continue;\r\nif ( (a->parameter == NULL) ||\r\n(a->parameter->type != V_ASN1_NULL))\r\n{\r\nASN1_TYPE_free(a->parameter);\r\nif ((a->parameter=ASN1_TYPE_new()) == NULL) goto err;\r\na->parameter->type=V_ASN1_NULL;\r\n}\r\nASN1_OBJECT_free(a->algorithm);\r\na->algorithm=OBJ_nid2obj(type->pkey_type);\r\nif (a->algorithm == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_SIGN,ASN1_R_UNKNOWN_OBJECT_TYPE);\r\ngoto err;\r\n}\r\nif (a->algorithm->length == 0)\r\n{\r\nASN1err(ASN1_F_ASN1_SIGN,ASN1_R_THE_ASN1_OBJECT_IDENTIFIER_IS_NOT_KNOWN_FOR_THIS_MD);\r\ngoto err;\r\n}\r\n}\r\ninl=i2d(data,NULL);\r\nbuf_in=(unsigned char *)Malloc((unsigned int)inl);\r\noutll=outl=EVP_PKEY_size(pkey);\r\nbuf_out=(unsigned char *)Malloc((unsigned int)outl);\r\nif ((buf_in == NULL) || (buf_out == NULL))\r\n{\r\noutl=0;\r\nASN1err(ASN1_F_ASN1_SIGN,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\np=buf_in;\r\ni2d(data,&p);\r\nEVP_SignInit(&ctx,type);\r\nEVP_SignUpdate(&ctx,(unsigned char *)buf_in,inl);\r\nif (!EVP_SignFinal(&ctx,(unsigned char *)buf_out,\r\n(unsigned int *)&outl,pkey))\r\n{\r\noutl=0;\r\nASN1err(ASN1_F_ASN1_SIGN,ERR_R_EVP_LIB);\r\ngoto err;\r\n}\r\nif (signature->data != NULL) Free((char *)signature->data);\r\nsignature->data=buf_out;\r\nbuf_out=NULL;\r\nsignature->length=outl;\r\nsignature->flags&= ~(ASN1_STRING_FLAG_BITS_LEFT|0x07);\r\nsignature->flags|=ASN1_STRING_FLAG_BITS_LEFT;\r\nerr:\r\nmemset(&ctx,0,sizeof(ctx));\r\nif (buf_in != NULL)\r\n{ memset((char *)buf_in,0,(unsigned int)inl); Free((char *)buf_in); }\r\nif (buf_out != NULL)\r\n{ memset((char *)buf_out,0,outll); Free((char *)buf_out); }\r\nreturn(outl);\r\n}

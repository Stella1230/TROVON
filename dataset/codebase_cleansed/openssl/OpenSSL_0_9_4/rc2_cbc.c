void RC2_cbc_encrypt(unsigned char *in, unsigned char *out, long length,\r\nRC2_KEY *ks, unsigned char *iv, int encrypt)\r\n{\r\nregister unsigned long tin0,tin1;\r\nregister unsigned long tout0,tout1,xor0,xor1;\r\nregister long l=length;\r\nunsigned long tin[2];\r\nif (encrypt)\r\n{\r\nc2l(iv,tout0);\r\nc2l(iv,tout1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nRC2_encrypt(tin,ks);\r\ntout0=tin[0]; l2c(tout0,out);\r\ntout1=tin[1]; l2c(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nc2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nRC2_encrypt(tin,ks);\r\ntout0=tin[0]; l2c(tout0,out);\r\ntout1=tin[1]; l2c(tout1,out);\r\n}\r\nl2c(tout0,iv);\r\nl2c(tout1,iv);\r\n}\r\nelse\r\n{\r\nc2l(iv,xor0);\r\nc2l(iv,xor1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0); tin[0]=tin0;\r\nc2l(in,tin1); tin[1]=tin1;\r\nRC2_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nif (l != -8)\r\n{\r\nc2l(in,tin0); tin[0]=tin0;\r\nc2l(in,tin1); tin[1]=tin1;\r\nRC2_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2cn(tout0,tout1,out,l+8);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nl2c(xor0,iv);\r\nl2c(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}\r\nvoid RC2_encrypt(unsigned long *d, RC2_KEY *key)\r\n{\r\nint i,n;\r\nregister RC2_INT *p0,*p1;\r\nregister RC2_INT x0,x1,x2,x3,t;\r\nunsigned long l;\r\nl=d[0];\r\nx0=(RC2_INT)l&0xffff;\r\nx1=(RC2_INT)(l>>16L);\r\nl=d[1];\r\nx2=(RC2_INT)l&0xffff;\r\nx3=(RC2_INT)(l>>16L);\r\nn=3;\r\ni=5;\r\np0=p1= &(key->data[0]);\r\nfor (;;)\r\n{\r\nt=(x0+(x1& ~x3)+(x2&x3)+ *(p0++))&0xffff;\r\nx0=(t<<1)|(t>>15);\r\nt=(x1+(x2& ~x0)+(x3&x0)+ *(p0++))&0xffff;\r\nx1=(t<<2)|(t>>14);\r\nt=(x2+(x3& ~x1)+(x0&x1)+ *(p0++))&0xffff;\r\nx2=(t<<3)|(t>>13);\r\nt=(x3+(x0& ~x2)+(x1&x2)+ *(p0++))&0xffff;\r\nx3=(t<<5)|(t>>11);\r\nif (--i == 0)\r\n{\r\nif (--n == 0) break;\r\ni=(n == 2)?6:5;\r\nx0+=p1[x3&0x3f];\r\nx1+=p1[x0&0x3f];\r\nx2+=p1[x1&0x3f];\r\nx3+=p1[x2&0x3f];\r\n}\r\n}\r\nd[0]=(unsigned long)(x0&0xffff)|((unsigned long)(x1&0xffff)<<16L);\r\nd[1]=(unsigned long)(x2&0xffff)|((unsigned long)(x3&0xffff)<<16L);\r\n}\r\nvoid RC2_decrypt(unsigned long *d, RC2_KEY *key)\r\n{\r\nint i,n;\r\nregister RC2_INT *p0,*p1;\r\nregister RC2_INT x0,x1,x2,x3,t;\r\nunsigned long l;\r\nl=d[0];\r\nx0=(RC2_INT)l&0xffff;\r\nx1=(RC2_INT)(l>>16L);\r\nl=d[1];\r\nx2=(RC2_INT)l&0xffff;\r\nx3=(RC2_INT)(l>>16L);\r\nn=3;\r\ni=5;\r\np0= &(key->data[63]);\r\np1= &(key->data[0]);\r\nfor (;;)\r\n{\r\nt=((x3<<11)|(x3>>5))&0xffff;\r\nx3=(t-(x0& ~x2)-(x1&x2)- *(p0--))&0xffff;\r\nt=((x2<<13)|(x2>>3))&0xffff;\r\nx2=(t-(x3& ~x1)-(x0&x1)- *(p0--))&0xffff;\r\nt=((x1<<14)|(x1>>2))&0xffff;\r\nx1=(t-(x2& ~x0)-(x3&x0)- *(p0--))&0xffff;\r\nt=((x0<<15)|(x0>>1))&0xffff;\r\nx0=(t-(x1& ~x3)-(x2&x3)- *(p0--))&0xffff;\r\nif (--i == 0)\r\n{\r\nif (--n == 0) break;\r\ni=(n == 2)?6:5;\r\nx3=(x3-p1[x2&0x3f])&0xffff;\r\nx2=(x2-p1[x1&0x3f])&0xffff;\r\nx1=(x1-p1[x0&0x3f])&0xffff;\r\nx0=(x0-p1[x3&0x3f])&0xffff;\r\n}\r\n}\r\nd[0]=(unsigned long)(x0&0xffff)|((unsigned long)(x1&0xffff)<<16L);\r\nd[1]=(unsigned long)(x2&0xffff)|((unsigned long)(x3&0xffff)<<16L);\r\n}

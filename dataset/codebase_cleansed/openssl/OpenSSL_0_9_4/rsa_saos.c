int RSA_sign_ASN1_OCTET_STRING(int type, unsigned char *m, unsigned int m_len,\r\nunsigned char *sigret, unsigned int *siglen, RSA *rsa)\r\n{\r\nASN1_OCTET_STRING sig;\r\nint i,j,ret=1;\r\nunsigned char *p,*s;\r\nsig.type=V_ASN1_OCTET_STRING;\r\nsig.length=m_len;\r\nsig.data=m;\r\ni=i2d_ASN1_OCTET_STRING(&sig,NULL);\r\nj=RSA_size(rsa);\r\nif ((i-RSA_PKCS1_PADDING) > j)\r\n{\r\nRSAerr(RSA_F_RSA_SIGN_ASN1_OCTET_STRING,RSA_R_DIGEST_TOO_BIG_FOR_RSA_KEY);\r\nreturn(0);\r\n}\r\ns=(unsigned char *)Malloc((unsigned int)j+1);\r\nif (s == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_SIGN_ASN1_OCTET_STRING,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\np=s;\r\ni2d_ASN1_OCTET_STRING(&sig,&p);\r\ni=RSA_private_encrypt(i,s,sigret,rsa,RSA_PKCS1_PADDING);\r\nif (i <= 0)\r\nret=0;\r\nelse\r\n*siglen=i;\r\nmemset(s,0,(unsigned int)j+1);\r\nFree(s);\r\nreturn(ret);\r\n}\r\nint RSA_verify_ASN1_OCTET_STRING(int dtype, unsigned char *m,\r\nunsigned int m_len, unsigned char *sigbuf, unsigned int siglen,\r\nRSA *rsa)\r\n{\r\nint i,ret=0;\r\nunsigned char *p,*s;\r\nASN1_OCTET_STRING *sig=NULL;\r\nif (siglen != (unsigned int)RSA_size(rsa))\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY_ASN1_OCTET_STRING,RSA_R_WRONG_SIGNATURE_LENGTH);\r\nreturn(0);\r\n}\r\ns=(unsigned char *)Malloc((unsigned int)siglen);\r\nif (s == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY_ASN1_OCTET_STRING,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\ni=RSA_public_decrypt((int)siglen,sigbuf,s,rsa,RSA_PKCS1_PADDING);\r\nif (i <= 0) goto err;\r\np=s;\r\nsig=d2i_ASN1_OCTET_STRING(NULL,&p,(long)i);\r\nif (sig == NULL) goto err;\r\nif ( ((unsigned int)sig->length != m_len) ||\r\n(memcmp(m,sig->data,m_len) != 0))\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY_ASN1_OCTET_STRING,RSA_R_BAD_SIGNATURE);\r\n}\r\nelse\r\nret=1;\r\nerr:\r\nif (sig != NULL) ASN1_OCTET_STRING_free(sig);\r\nmemset(s,0,(unsigned int)siglen);\r\nFree(s);\r\nreturn(ret);\r\n}

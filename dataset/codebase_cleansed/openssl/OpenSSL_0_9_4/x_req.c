int i2d_X509_REQ_INFO(X509_REQ_INFO *a, unsigned char **pp)\r\n{\r\nM_ASN1_I2D_vars(a);\r\nM_ASN1_I2D_len(a->version, i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_len(a->subject, i2d_X509_NAME);\r\nM_ASN1_I2D_len(a->pubkey, i2d_X509_PUBKEY);\r\nif (a->req_kludge)\r\n{\r\nM_ASN1_I2D_len_IMP_SET_opt_type(X509_ATTRIBUTE,a->attributes,i2d_X509_ATTRIBUTE,0);\r\n}\r\nelse\r\n{\r\nM_ASN1_I2D_len_IMP_SET_type(X509_ATTRIBUTE,a->attributes,\r\ni2d_X509_ATTRIBUTE,0);\r\n}\r\nM_ASN1_I2D_seq_total();\r\nM_ASN1_I2D_put(a->version, i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_put(a->subject, i2d_X509_NAME);\r\nM_ASN1_I2D_put(a->pubkey, i2d_X509_PUBKEY);\r\nif (a->req_kludge)\r\n{\r\nM_ASN1_I2D_put_IMP_SET_opt_type(X509_ATTRIBUTE,a->attributes,\r\ni2d_X509_ATTRIBUTE,0);\r\n}\r\nelse\r\n{\r\nM_ASN1_I2D_put_IMP_SET_type(X509_ATTRIBUTE,a->attributes,\r\ni2d_X509_ATTRIBUTE,0);\r\n}\r\nM_ASN1_I2D_finish();\r\n}\r\nX509_REQ_INFO *d2i_X509_REQ_INFO(X509_REQ_INFO **a, unsigned char **pp,\r\nlong length)\r\n{\r\nM_ASN1_D2I_vars(a,X509_REQ_INFO *,X509_REQ_INFO_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(ret->version,d2i_ASN1_INTEGER);\r\nM_ASN1_D2I_get(ret->subject,d2i_X509_NAME);\r\nM_ASN1_D2I_get(ret->pubkey,d2i_X509_PUBKEY);\r\nif (asn1_Finish(&c))\r\nret->req_kludge=1;\r\nelse\r\n{\r\nM_ASN1_D2I_get_IMP_set_type(X509_ATTRIBUTE,ret->attributes,\r\nd2i_X509_ATTRIBUTE,\r\nX509_ATTRIBUTE_free,0);\r\n}\r\nM_ASN1_D2I_Finish(a,X509_REQ_INFO_free,ASN1_F_D2I_X509_REQ_INFO);\r\n}\r\nX509_REQ_INFO *X509_REQ_INFO_new(void)\r\n{\r\nX509_REQ_INFO *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret,X509_REQ_INFO);\r\nM_ASN1_New(ret->version,ASN1_INTEGER_new);\r\nM_ASN1_New(ret->subject,X509_NAME_new);\r\nM_ASN1_New(ret->pubkey,X509_PUBKEY_new);\r\nM_ASN1_New(ret->attributes,sk_X509_ATTRIBUTE_new_null);\r\nret->req_kludge=0;\r\nreturn(ret);\r\nM_ASN1_New_Error(ASN1_F_X509_REQ_INFO_NEW);\r\n}\r\nvoid X509_REQ_INFO_free(X509_REQ_INFO *a)\r\n{\r\nif (a == NULL) return;\r\nASN1_INTEGER_free(a->version);\r\nX509_NAME_free(a->subject);\r\nX509_PUBKEY_free(a->pubkey);\r\nsk_X509_ATTRIBUTE_pop_free(a->attributes,X509_ATTRIBUTE_free);\r\nFree((char *)a);\r\n}\r\nint i2d_X509_REQ(X509_REQ *a, unsigned char **pp)\r\n{\r\nM_ASN1_I2D_vars(a);\r\nM_ASN1_I2D_len(a->req_info, i2d_X509_REQ_INFO);\r\nM_ASN1_I2D_len(a->sig_alg, i2d_X509_ALGOR);\r\nM_ASN1_I2D_len(a->signature, i2d_ASN1_BIT_STRING);\r\nM_ASN1_I2D_seq_total();\r\nM_ASN1_I2D_put(a->req_info, i2d_X509_REQ_INFO);\r\nM_ASN1_I2D_put(a->sig_alg, i2d_X509_ALGOR);\r\nM_ASN1_I2D_put(a->signature, i2d_ASN1_BIT_STRING);\r\nM_ASN1_I2D_finish();\r\n}\r\nX509_REQ *d2i_X509_REQ(X509_REQ **a, unsigned char **pp, long length)\r\n{\r\nM_ASN1_D2I_vars(a,X509_REQ *,X509_REQ_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(ret->req_info,d2i_X509_REQ_INFO);\r\nM_ASN1_D2I_get(ret->sig_alg,d2i_X509_ALGOR);\r\nM_ASN1_D2I_get(ret->signature,d2i_ASN1_BIT_STRING);\r\nM_ASN1_D2I_Finish(a,X509_REQ_free,ASN1_F_D2I_X509_REQ);\r\n}\r\nX509_REQ *X509_REQ_new(void)\r\n{\r\nX509_REQ *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret,X509_REQ);\r\nret->references=1;\r\nM_ASN1_New(ret->req_info,X509_REQ_INFO_new);\r\nM_ASN1_New(ret->sig_alg,X509_ALGOR_new);\r\nM_ASN1_New(ret->signature,ASN1_BIT_STRING_new);\r\nreturn(ret);\r\nM_ASN1_New_Error(ASN1_F_X509_REQ_NEW);\r\n}\r\nvoid X509_REQ_free(X509_REQ *a)\r\n{\r\nint i;\r\nif (a == NULL) return;\r\ni=CRYPTO_add(&a->references,-1,CRYPTO_LOCK_X509_REQ);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_REQ",a);\r\n#endif\r\nif (i > 0) return;\r\n#ifdef REF_CHECK\r\nif (i < 0)\r\n{\r\nfprintf(stderr,"X509_REQ_free, bad reference count\n");\r\nabort();\r\n}\r\n#endif\r\nX509_REQ_INFO_free(a->req_info);\r\nX509_ALGOR_free(a->sig_alg);\r\nASN1_BIT_STRING_free(a->signature);\r\nFree((char *)a);\r\n}

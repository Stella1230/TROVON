int i2d_ASN1_ENUMERATED(ASN1_ENUMERATED *a, unsigned char **pp)\r\n{\r\nint pad=0,ret,r,i,t;\r\nunsigned char *p,*n,pb=0;\r\nif ((a == NULL) || (a->data == NULL)) return(0);\r\nt=a->type;\r\nif (a->length == 0)\r\nret=1;\r\nelse\r\n{\r\nret=a->length;\r\ni=a->data[0];\r\nif ((t == V_ASN1_ENUMERATED) && (i > 127)) {\r\npad=1;\r\npb=0;\r\n} else if(t == V_ASN1_NEG_ENUMERATED) {\r\nif(i>128) {\r\npad=1;\r\npb=0xFF;\r\n} else if(i == 128) {\r\nfor(i = 1; i < a->length; i++) if(a->data[i]) {\r\npad=1;\r\npb=0xFF;\r\nbreak;\r\n}\r\n}\r\n}\r\nret+=pad;\r\n}\r\nr=ASN1_object_size(0,ret,V_ASN1_ENUMERATED);\r\nif (pp == NULL) return(r);\r\np= *pp;\r\nASN1_put_object(&p,0,ret,V_ASN1_ENUMERATED,V_ASN1_UNIVERSAL);\r\nif (pad) *(p++)=pb;\r\nif (a->length == 0)\r\n*(p++)=0;\r\nelse if (t == V_ASN1_ENUMERATED)\r\n{\r\nmemcpy(p,a->data,(unsigned int)a->length);\r\np+=a->length;\r\n}\r\nelse {\r\nn=a->data + a->length - 1;\r\np += a->length - 1;\r\ni = a->length;\r\nwhile(!*n) {\r\n*(p--) = 0;\r\nn--;\r\ni--;\r\n}\r\n*(p--) = ((*(n--)) ^ 0xff) + 1;\r\ni--;\r\nfor(;i > 0; i--) *(p--) = *(n--) ^ 0xff;\r\np += a->length;\r\n}\r\n*pp=p;\r\nreturn(r);\r\n}\r\nASN1_ENUMERATED *d2i_ASN1_ENUMERATED(ASN1_ENUMERATED **a, unsigned char **pp,\r\nlong length)\r\n{\r\nASN1_ENUMERATED *ret=NULL;\r\nunsigned char *p,*to,*s;\r\nlong len;\r\nint inf,tag,xclass;\r\nint i;\r\nif ((a == NULL) || ((*a) == NULL))\r\n{\r\nif ((ret=ASN1_ENUMERATED_new()) == NULL) return(NULL);\r\nret->type=V_ASN1_ENUMERATED;\r\n}\r\nelse\r\nret=(*a);\r\np= *pp;\r\ninf=ASN1_get_object(&p,&len,&tag,&xclass,length);\r\nif (inf & 0x80)\r\n{\r\ni=ASN1_R_BAD_OBJECT_HEADER;\r\ngoto err;\r\n}\r\nif (tag != V_ASN1_ENUMERATED)\r\n{\r\ni=ASN1_R_EXPECTING_AN_ENUMERATED;\r\ngoto err;\r\n}\r\ns=(unsigned char *)Malloc((int)len+1);\r\nif (s == NULL)\r\n{\r\ni=ERR_R_MALLOC_FAILURE;\r\ngoto err;\r\n}\r\nto=s;\r\nif (*p & 0x80)\r\n{\r\nret->type=V_ASN1_NEG_ENUMERATED;\r\nif ((*p == 0xff) && (len != 1)) {\r\np++;\r\nlen--;\r\n}\r\ni = len;\r\np += i - 1;\r\nto += i - 1;\r\nwhile((!*p) && i) {\r\n*(to--) = 0;\r\ni--;\r\np--;\r\n}\r\nif(!i) {\r\n*s = 1;\r\ns[len] = 0;\r\np += len;\r\nlen++;\r\n} else {\r\n*(to--) = (*(p--) ^ 0xff) + 1;\r\ni--;\r\nfor(;i > 0; i--) *(to--) = *(p--) ^ 0xff;\r\np += len;\r\n}\r\n} else {\r\nret->type=V_ASN1_ENUMERATED;\r\nif ((*p == 0) && (len != 1))\r\n{\r\np++;\r\nlen--;\r\n}\r\nmemcpy(s,p,(int)len);\r\np+=len;\r\n}\r\nif (ret->data != NULL) Free((char *)ret->data);\r\nret->data=s;\r\nret->length=(int)len;\r\nif (a != NULL) (*a)=ret;\r\n*pp=p;\r\nreturn(ret);\r\nerr:\r\nASN1err(ASN1_F_D2I_ASN1_ENUMERATED,i);\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret)))\r\nASN1_ENUMERATED_free(ret);\r\nreturn(NULL);\r\n}\r\nint ASN1_ENUMERATED_set(ASN1_ENUMERATED *a, long v)\r\n{\r\nint i,j,k;\r\nunsigned char buf[sizeof(long)+1];\r\nlong d;\r\na->type=V_ASN1_ENUMERATED;\r\nif (a->length < (sizeof(long)+1))\r\n{\r\nif (a->data != NULL)\r\nFree((char *)a->data);\r\nif ((a->data=(unsigned char *)Malloc(sizeof(long)+1)) != NULL)\r\nmemset((char *)a->data,0,sizeof(long)+1);\r\n}\r\nif (a->data == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_ENUMERATED_SET,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nd=v;\r\nif (d < 0)\r\n{\r\nd= -d;\r\na->type=V_ASN1_NEG_ENUMERATED;\r\n}\r\nfor (i=0; i<sizeof(long); i++)\r\n{\r\nif (d == 0) break;\r\nbuf[i]=(int)d&0xff;\r\nd>>=8;\r\n}\r\nj=0;\r\nfor (k=i-1; k >=0; k--)\r\na->data[j++]=buf[k];\r\na->length=j;\r\nreturn(1);\r\n}\r\nlong ASN1_ENUMERATED_get(ASN1_ENUMERATED *a)\r\n{\r\nint neg=0,i;\r\nlong r=0;\r\nif (a == NULL) return(0L);\r\ni=a->type;\r\nif (i == V_ASN1_NEG_ENUMERATED)\r\nneg=1;\r\nelse if (i != V_ASN1_ENUMERATED)\r\nreturn(0);\r\nif (a->length > sizeof(long))\r\n{\r\nreturn(0xffffffffL);\r\n}\r\nif (a->data == NULL)\r\nreturn(0);\r\nfor (i=0; i<a->length; i++)\r\n{\r\nr<<=8;\r\nr|=(unsigned char)a->data[i];\r\n}\r\nif (neg) r= -r;\r\nreturn(r);\r\n}\r\nASN1_ENUMERATED *BN_to_ASN1_ENUMERATED(BIGNUM *bn, ASN1_ENUMERATED *ai)\r\n{\r\nASN1_ENUMERATED *ret;\r\nint len,j;\r\nif (ai == NULL)\r\nret=ASN1_ENUMERATED_new();\r\nelse\r\nret=ai;\r\nif (ret == NULL)\r\n{\r\nASN1err(ASN1_F_BN_TO_ASN1_ENUMERATED,ERR_R_NESTED_ASN1_ERROR);\r\ngoto err;\r\n}\r\nif(bn->neg) ret->type = V_ASN1_NEG_ENUMERATED;\r\nelse ret->type=V_ASN1_ENUMERATED;\r\nj=BN_num_bits(bn);\r\nlen=((j == 0)?0:((j/8)+1));\r\nret->data=(unsigned char *)Malloc(len+4);\r\nret->length=BN_bn2bin(bn,ret->data);\r\nreturn(ret);\r\nerr:\r\nif (ret != ai) ASN1_ENUMERATED_free(ret);\r\nreturn(NULL);\r\n}\r\nBIGNUM *ASN1_ENUMERATED_to_BN(ASN1_ENUMERATED *ai, BIGNUM *bn)\r\n{\r\nBIGNUM *ret;\r\nif ((ret=BN_bin2bn(ai->data,ai->length,bn)) == NULL)\r\nASN1err(ASN1_F_ASN1_ENUMERATED_TO_BN,ASN1_R_BN_LIB);\r\nif(ai->type == V_ASN1_NEG_ENUMERATED) bn->neg = 1;\r\nreturn(ret);\r\n}

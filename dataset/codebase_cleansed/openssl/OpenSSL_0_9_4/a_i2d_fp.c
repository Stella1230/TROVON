int ASN1_i2d_fp(int (*i2d)(), FILE *out, unsigned char *x)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_I2D_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,out,BIO_NOCLOSE);\r\nret=ASN1_i2d_bio(i2d,b,x);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint ASN1_i2d_bio(int (*i2d)(), BIO *out, unsigned char *x)\r\n{\r\nchar *b;\r\nunsigned char *p;\r\nint i,j=0,n,ret=1;\r\nn=i2d(x,NULL);\r\nb=(char *)Malloc(n);\r\nif (b == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_I2D_BIO,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\np=(unsigned char *)b;\r\ni2d(x,&p);\r\nfor (;;)\r\n{\r\ni=BIO_write(out,&(b[j]),n);\r\nif (i == n) break;\r\nif (i <= 0)\r\n{\r\nret=0;\r\nbreak;\r\n}\r\nj+=i;\r\nn-=i;\r\n}\r\nFree((char *)b);\r\nreturn(ret);\r\n}

int X509_REQ_print_fp(FILE *fp, X509_REQ *x)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nX509err(X509_F_X509_REQ_PRINT_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=X509_REQ_print(b, x);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint X509_REQ_print(BIO *bp, X509_REQ *x)\r\n{\r\nunsigned long l;\r\nint i,n;\r\nchar *s;\r\nconst char *neg;\r\nX509_REQ_INFO *ri;\r\nEVP_PKEY *pkey;\r\nSTACK_OF(X509_ATTRIBUTE) *sk;\r\nchar str[128];\r\nri=x->req_info;\r\nsprintf(str,"Certificate Request:\n");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nsprintf(str,"%4sData:\n","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nneg=(ri->version->type == V_ASN1_NEG_INTEGER)?"-":"";\r\nl=0;\r\nfor (i=0; i<ri->version->length; i++)\r\n{ l<<=8; l+=ri->version->data[i]; }\r\nsprintf(str,"%8sVersion: %s%lu (%s0x%lx)\n","",neg,l,neg,l);\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nsprintf(str,"%8sSubject: ","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nX509_NAME_print(bp,ri->subject,16);\r\nsprintf(str,"\n%8sSubject Public Key Info:\n","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\ni=OBJ_obj2nid(ri->pubkey->algor->algorithm);\r\nsprintf(str,"%12sPublic Key Algorithm: %s\n","",\r\n(i == NID_undef)?"UNKNOWN":OBJ_nid2ln(i));\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\npkey=X509_REQ_get_pubkey(x);\r\n#ifndef NO_RSA\r\nif (pkey->type == EVP_PKEY_RSA)\r\n{\r\nBIO_printf(bp,"%12sRSA Public Key: (%d bit)\n","",\r\nBN_num_bits(pkey->pkey.rsa->n));\r\nRSA_print(bp,pkey->pkey.rsa,16);\r\n}\r\nelse\r\n#endif\r\n#ifndef NO_DSA\r\nif (pkey->type == EVP_PKEY_DSA)\r\n{\r\nBIO_printf(bp,"%12sDSA Public Key:\n","");\r\nDSA_print(bp,pkey->pkey.dsa,16);\r\n}\r\nelse\r\n#endif\r\nBIO_printf(bp,"%12sUnknown Public Key:\n","");\r\nEVP_PKEY_free(pkey);\r\nsprintf(str,"%8sAttributes:\n","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nsk=x->req_info->attributes;\r\nif ((sk == NULL) || (sk_X509_ATTRIBUTE_num(sk) == 0))\r\n{\r\nif (!x->req_info->req_kludge)\r\n{\r\nsprintf(str,"%12sa0:00\n","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\n}\r\n}\r\nelse\r\n{\r\nfor (i=0; i<sk_X509_ATTRIBUTE_num(sk); i++)\r\n{\r\nASN1_TYPE *at;\r\nX509_ATTRIBUTE *a;\r\nASN1_BIT_STRING *bs=NULL;\r\nASN1_TYPE *t;\r\nint j,type=0,count=1,ii=0;\r\na=sk_X509_ATTRIBUTE_value(sk,i);\r\nsprintf(str,"%12s","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nif ((j=i2a_ASN1_OBJECT(bp,a->object)) > 0)\r\n{\r\nif (a->set)\r\n{\r\nii=0;\r\ncount=sk_ASN1_TYPE_num(a->value.set);\r\nget_next:\r\nat=sk_ASN1_TYPE_value(a->value.set,ii);\r\ntype=at->type;\r\nbs=at->value.asn1_string;\r\n}\r\nelse\r\n{\r\nt=a->value.single;\r\ntype=t->type;\r\nbs=t->value.bit_string;\r\n}\r\n}\r\nfor (j=25-j; j>0; j--)\r\nif (BIO_write(bp," ",1) != 1) goto err;\r\nif (BIO_puts(bp,":") <= 0) goto err;\r\nif ( (type == V_ASN1_PRINTABLESTRING) ||\r\n(type == V_ASN1_T61STRING) ||\r\n(type == V_ASN1_IA5STRING))\r\n{\r\nif (BIO_write(bp,(char *)bs->data,bs->length)\r\n!= bs->length)\r\ngoto err;\r\nBIO_puts(bp,"\n");\r\n}\r\nelse\r\n{\r\nBIO_puts(bp,"unable to print attribute\n");\r\n}\r\nif (++ii < count) goto get_next;\r\n}\r\n}\r\ni=OBJ_obj2nid(x->sig_alg->algorithm);\r\nsprintf(str,"%4sSignature Algorithm: %s","",\r\n(i == NID_undef)?"UNKNOWN":OBJ_nid2ln(i));\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\nn=x->signature->length;\r\ns=(char *)x->signature->data;\r\nfor (i=0; i<n; i++)\r\n{\r\nif ((i%18) == 0)\r\n{\r\nsprintf(str,"\n%8s","");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\n}\r\nsprintf(str,"%02x%s",(unsigned char)s[i],((i+1) == n)?"":":");\r\nif (BIO_puts(bp,str) <= 0) goto err;\r\n}\r\nif (BIO_puts(bp,"\n") <= 0) goto err;\r\nreturn(1);\r\nerr:\r\nX509err(X509_F_X509_REQ_PRINT,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}

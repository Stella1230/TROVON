int RSA_print_fp(FILE *fp, RSA *x, int off)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_PRINT_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=RSA_print(b,x,off);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint RSA_print(BIO *bp, RSA *x, int off)\r\n{\r\nchar str[128];\r\nconst char *s;\r\nunsigned char *m=NULL;\r\nint i,ret=0;\r\ni=RSA_size(x);\r\nm=(unsigned char *)Malloc((unsigned int)i+10);\r\nif (m == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_PRINT,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif (off)\r\n{\r\nif (off > 128) off=128;\r\nmemset(str,' ',off);\r\n}\r\nif (x->d != NULL)\r\n{\r\nif (off && (BIO_write(bp,str,off) <= 0)) goto err;\r\nif (BIO_printf(bp,"Private-Key: (%d bit)\n",BN_num_bits(x->n))\r\n<= 0) goto err;\r\n}\r\nif (x->d == NULL)\r\nsprintf(str,"Modulus (%d bit):",BN_num_bits(x->n));\r\nelse\r\nstrcpy(str,"modulus:");\r\nif (!print(bp,str,x->n,m,off)) goto err;\r\ns=(x->d == NULL)?"Exponent:":"publicExponent:";\r\nif (!print(bp,s,x->e,m,off)) goto err;\r\nif (!print(bp,"privateExponent:",x->d,m,off)) goto err;\r\nif (!print(bp,"prime1:",x->p,m,off)) goto err;\r\nif (!print(bp,"prime2:",x->q,m,off)) goto err;\r\nif (!print(bp,"exponent1:",x->dmp1,m,off)) goto err;\r\nif (!print(bp,"exponent2:",x->dmq1,m,off)) goto err;\r\nif (!print(bp,"coefficient:",x->iqmp,m,off)) goto err;\r\nret=1;\r\nerr:\r\nif (m != NULL) Free((char *)m);\r\nreturn(ret);\r\n}\r\nint DSA_print_fp(FILE *fp, DSA *x, int off)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nDSAerr(DSA_F_DSA_PRINT_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=DSA_print(b,x,off);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint DSA_print(BIO *bp, DSA *x, int off)\r\n{\r\nchar str[128];\r\nunsigned char *m=NULL;\r\nint i,ret=0;\r\nBIGNUM *bn=NULL;\r\nif (x->p != NULL)\r\nbn=x->p;\r\nelse if (x->priv_key != NULL)\r\nbn=x->priv_key;\r\nelse if (x->pub_key != NULL)\r\nbn=x->pub_key;\r\nif (bn != NULL)\r\ni=BN_num_bytes(bn)*2;\r\nelse\r\ni=256;\r\nm=(unsigned char *)Malloc((unsigned int)i+10);\r\nif (m == NULL)\r\n{\r\nDSAerr(DSA_F_DSA_PRINT,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif (off)\r\n{\r\nif (off > 128) off=128;\r\nmemset(str,' ',off);\r\n}\r\nif (x->priv_key != NULL)\r\n{\r\nif (off && (BIO_write(bp,str,off) <= 0)) goto err;\r\nif (BIO_printf(bp,"Private-Key: (%d bit)\n",BN_num_bits(x->p))\r\n<= 0) goto err;\r\n}\r\nif ((x->priv_key != NULL) && !print(bp,"priv:",x->priv_key,m,off))\r\ngoto err;\r\nif ((x->pub_key != NULL) && !print(bp,"pub: ",x->pub_key,m,off))\r\ngoto err;\r\nif ((x->p != NULL) && !print(bp,"P: ",x->p,m,off)) goto err;\r\nif ((x->q != NULL) && !print(bp,"Q: ",x->q,m,off)) goto err;\r\nif ((x->g != NULL) && !print(bp,"G: ",x->g,m,off)) goto err;\r\nret=1;\r\nerr:\r\nif (m != NULL) Free((char *)m);\r\nreturn(ret);\r\n}\r\nstatic int print(BIO *bp, const char *number, BIGNUM *num, unsigned char *buf,\r\nint off)\r\n{\r\nint n,i;\r\nchar str[128];\r\nconst char *neg;\r\nif (num == NULL) return(1);\r\nneg=(num->neg)?"-":"";\r\nif (off)\r\n{\r\nif (off > 128) off=128;\r\nmemset(str,' ',off);\r\nif (BIO_write(bp,str,off) <= 0) return(0);\r\n}\r\nif (BN_num_bytes(num) <= BN_BYTES)\r\n{\r\nif (BIO_printf(bp,"%s %s%lu (%s0x%lx)\n",number,neg,\r\n(unsigned long)num->d[0],neg,(unsigned long)num->d[0])\r\n<= 0) return(0);\r\n}\r\nelse\r\n{\r\nbuf[0]=0;\r\nif (BIO_printf(bp,"%s%s",number,\r\n(neg[0] == '-')?" (Negative)":"") <= 0)\r\nreturn(0);\r\nn=BN_bn2bin(num,&buf[1]);\r\nif (buf[1] & 0x80)\r\nn++;\r\nelse buf++;\r\nfor (i=0; i<n; i++)\r\n{\r\nif ((i%15) == 0)\r\n{\r\nstr[0]='\n';\r\nmemset(&(str[1]),' ',off+4);\r\nif (BIO_write(bp,str,off+1+4) <= 0) return(0);\r\n}\r\nif (BIO_printf(bp,"%02x%s",buf[i],((i+1) == n)?"":":")\r\n<= 0) return(0);\r\n}\r\nif (BIO_write(bp,"\n",1) <= 0) return(0);\r\n}\r\nreturn(1);\r\n}\r\nint DHparams_print_fp(FILE *fp, DH *x)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nDHerr(DH_F_DHPARAMS_PRINT_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=DHparams_print(b, x);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint DHparams_print(BIO *bp, DH *x)\r\n{\r\nunsigned char *m=NULL;\r\nint reason=ERR_R_BUF_LIB,i,ret=0;\r\ni=BN_num_bytes(x->p);\r\nm=(unsigned char *)Malloc((unsigned int)i+10);\r\nif (m == NULL)\r\n{\r\nreason=ERR_R_MALLOC_FAILURE;\r\ngoto err;\r\n}\r\nif (BIO_printf(bp,"Diffie-Hellman-Parameters: (%d bit)\n",\r\nBN_num_bits(x->p)) <= 0)\r\ngoto err;\r\nif (!print(bp,"prime:",x->p,m,4)) goto err;\r\nif (!print(bp,"generator:",x->g,m,4)) goto err;\r\nif (x->length != 0)\r\n{\r\nif (BIO_printf(bp," recomented-private-length: %d bits\n",\r\n(int)x->length) <= 0) goto err;\r\n}\r\nret=1;\r\nif (0)\r\n{\r\nerr:\r\nDHerr(DH_F_DHPARAMS_PRINT,reason);\r\n}\r\nif (m != NULL) Free((char *)m);\r\nreturn(ret);\r\n}\r\nint DSAparams_print_fp(FILE *fp, DSA *x)\r\n{\r\nBIO *b;\r\nint ret;\r\nif ((b=BIO_new(BIO_s_file())) == NULL)\r\n{\r\nDSAerr(DSA_F_DSAPARAMS_PRINT_FP,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nBIO_set_fp(b,fp,BIO_NOCLOSE);\r\nret=DSAparams_print(b, x);\r\nBIO_free(b);\r\nreturn(ret);\r\n}\r\nint DSAparams_print(BIO *bp, DSA *x)\r\n{\r\nunsigned char *m=NULL;\r\nint reason=ERR_R_BUF_LIB,i,ret=0;\r\ni=BN_num_bytes(x->p);\r\nm=(unsigned char *)Malloc((unsigned int)i+10);\r\nif (m == NULL)\r\n{\r\nreason=ERR_R_MALLOC_FAILURE;\r\ngoto err;\r\n}\r\nif (BIO_printf(bp,"DSA-Parameters: (%d bit)\n",\r\nBN_num_bits(x->p)) <= 0)\r\ngoto err;\r\nif (!print(bp,"p:",x->p,m,4)) goto err;\r\nif (!print(bp,"q:",x->q,m,4)) goto err;\r\nif (!print(bp,"g:",x->g,m,4)) goto err;\r\nret=1;\r\nerr:\r\nif (m != NULL) Free((char *)m);\r\nDSAerr(DSA_F_DSAPARAMS_PRINT,reason);\r\nreturn(ret);\r\n}

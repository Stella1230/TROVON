BIO_METHOD *BIO_f_base64(void)\r\n{\r\nreturn(&methods_b64);\r\n}\r\nstatic int b64_new(BIO *bi)\r\n{\r\nBIO_B64_CTX *ctx;\r\nctx=(BIO_B64_CTX *)Malloc(sizeof(BIO_B64_CTX));\r\nif (ctx == NULL) return(0);\r\nctx->buf_len=0;\r\nctx->tmp_len=0;\r\nctx->tmp_nl=0;\r\nctx->buf_off=0;\r\nctx->cont=1;\r\nctx->start=1;\r\nctx->encode=0;\r\nbi->init=1;\r\nbi->ptr=(char *)ctx;\r\nbi->flags=0;\r\nreturn(1);\r\n}\r\nstatic int b64_free(BIO *a)\r\n{\r\nif (a == NULL) return(0);\r\nFree(a->ptr);\r\na->ptr=NULL;\r\na->init=0;\r\na->flags=0;\r\nreturn(1);\r\n}\r\nstatic int b64_read(BIO *b, char *out, int outl)\r\n{\r\nint ret=0,i,ii,j,k,x,n,num,ret_code=0;\r\nBIO_B64_CTX *ctx;\r\nunsigned char *p,*q;\r\nif (out == NULL) return(0);\r\nctx=(BIO_B64_CTX *)b->ptr;\r\nif ((ctx == NULL) || (b->next_bio == NULL)) return(0);\r\nif (ctx->encode != B64_DECODE)\r\n{\r\nctx->encode=B64_DECODE;\r\nctx->buf_len=0;\r\nctx->buf_off=0;\r\nctx->tmp_len=0;\r\nEVP_DecodeInit(&(ctx->base64));\r\n}\r\nif (ctx->buf_len > 0)\r\n{\r\ni=ctx->buf_len-ctx->buf_off;\r\nif (i > outl) i=outl;\r\nmemcpy(out,&(ctx->buf[ctx->buf_off]),i);\r\nret=i;\r\nout+=i;\r\noutl-=i;\r\nctx->buf_off+=i;\r\nif (ctx->buf_len == ctx->buf_off)\r\n{\r\nctx->buf_len=0;\r\nctx->buf_off=0;\r\n}\r\n}\r\nret_code=0;\r\nwhile (outl > 0)\r\n{\r\nif (ctx->cont <= 0) break;\r\ni=BIO_read(b->next_bio,&(ctx->tmp[ctx->tmp_len]),\r\nB64_BLOCK_SIZE-ctx->tmp_len);\r\nif (i <= 0)\r\n{\r\nret_code=i;\r\nif (!BIO_should_retry(b->next_bio))\r\nctx->cont=i;\r\nbreak;\r\n}\r\ni+=ctx->tmp_len;\r\nif (ctx->start && (BIO_get_flags(b) & BIO_FLAGS_BASE64_NO_NL))\r\n{\r\nctx->tmp_len=0;\r\n}\r\nelse if (ctx->start)\r\n{\r\nq=p=(unsigned char *)ctx->tmp;\r\nfor (j=0; j<i; j++)\r\n{\r\nif (*(q++) != '\n') continue;\r\nif (ctx->tmp_nl)\r\n{\r\np=q;\r\nctx->tmp_nl=0;\r\ncontinue;\r\n}\r\nk=EVP_DecodeUpdate(&(ctx->base64),\r\n(unsigned char *)ctx->buf,\r\n&num,p,q-p);\r\nif ((k <= 0) && (num == 0) && (ctx->start))\r\nEVP_DecodeInit(&ctx->base64);\r\nelse\r\n{\r\nif (p != (unsigned char *)\r\n&(ctx->tmp[0]))\r\n{\r\ni-=(p- (unsigned char *)\r\n&(ctx->tmp[0]));\r\nfor (x=0; x < i; x++)\r\nctx->tmp[x]=p[x];\r\nEVP_DecodeInit(&ctx->base64);\r\n}\r\nctx->start=0;\r\nbreak;\r\n}\r\np=q;\r\n}\r\nif (j == i)\r\n{\r\nif (p == (unsigned char *)&(ctx->tmp[0]))\r\n{\r\nctx->tmp_nl=1;\r\nctx->tmp_len=0;\r\n}\r\nelse if (p != q)\r\n{\r\nn=q-p;\r\nfor (ii=0; ii<n; ii++)\r\nctx->tmp[ii]=p[ii];\r\nctx->tmp_len=n;\r\n}\r\ncontinue;\r\n}\r\nelse\r\nctx->tmp_len=0;\r\n}\r\nif (BIO_get_flags(b) & BIO_FLAGS_BASE64_NO_NL)\r\n{\r\nint z,jj;\r\njj=(i>>2)<<2;\r\nz=EVP_DecodeBlock((unsigned char *)ctx->buf,\r\n(unsigned char *)ctx->tmp,jj);\r\nif (jj > 2)\r\n{\r\nif (ctx->tmp[jj-1] == '=')\r\n{\r\nz--;\r\nif (ctx->tmp[jj-2] == '=')\r\nz--;\r\n}\r\n}\r\nif (jj != i)\r\n{\r\nmemcpy((unsigned char *)ctx->tmp,\r\n(unsigned char *)&(ctx->tmp[jj]),i-jj);\r\nctx->tmp_len=i-jj;\r\n}\r\nctx->buf_len=0;\r\nif (z > 0)\r\n{\r\nctx->buf_len=z;\r\ni=1;\r\n}\r\nelse\r\ni=z;\r\n}\r\nelse\r\n{\r\ni=EVP_DecodeUpdate(&(ctx->base64),\r\n(unsigned char *)ctx->buf,&ctx->buf_len,\r\n(unsigned char *)ctx->tmp,i);\r\n}\r\nctx->cont=i;\r\nctx->buf_off=0;\r\nif (i < 0)\r\n{\r\nret_code=0;\r\nctx->buf_len=0;\r\nbreak;\r\n}\r\nif (ctx->buf_len <= outl)\r\ni=ctx->buf_len;\r\nelse\r\ni=outl;\r\nmemcpy(out,ctx->buf,i);\r\nret+=i;\r\nctx->buf_off=i;\r\nif (ctx->buf_off == ctx->buf_len)\r\n{\r\nctx->buf_len=0;\r\nctx->buf_off=0;\r\n}\r\noutl-=i;\r\nout+=i;\r\n}\r\nBIO_clear_retry_flags(b);\r\nBIO_copy_next_retry(b);\r\nreturn((ret == 0)?ret_code:ret);\r\n}\r\nstatic int b64_write(BIO *b, char *in, int inl)\r\n{\r\nint ret=inl,n,i;\r\nBIO_B64_CTX *ctx;\r\nctx=(BIO_B64_CTX *)b->ptr;\r\nBIO_clear_retry_flags(b);\r\nif (ctx->encode != B64_ENCODE)\r\n{\r\nctx->encode=B64_ENCODE;\r\nctx->buf_len=0;\r\nctx->buf_off=0;\r\nctx->tmp_len=0;\r\nEVP_EncodeInit(&(ctx->base64));\r\n}\r\nn=ctx->buf_len-ctx->buf_off;\r\nwhile (n > 0)\r\n{\r\ni=BIO_write(b->next_bio,&(ctx->buf[ctx->buf_off]),n);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nreturn(i);\r\n}\r\nctx->buf_off+=i;\r\nn-=i;\r\n}\r\nif ((in == NULL) || (inl <= 0)) return(0);\r\nctx->buf_off=0;\r\nwhile (inl > 0)\r\n{\r\nn=(inl > B64_BLOCK_SIZE)?B64_BLOCK_SIZE:inl;\r\nif (BIO_get_flags(b) & BIO_FLAGS_BASE64_NO_NL)\r\n{\r\nif (ctx->tmp_len > 0)\r\n{\r\nn=3-ctx->tmp_len;\r\nmemcpy(&(ctx->tmp[ctx->tmp_len]),in,n);\r\nctx->tmp_len+=n;\r\nn=ctx->tmp_len;\r\nif (n < 3)\r\nbreak;\r\nctx->buf_len=EVP_EncodeBlock(\r\n(unsigned char *)ctx->buf,\r\n(unsigned char *)ctx->tmp,n);\r\n}\r\nelse\r\n{\r\nif (n < 3)\r\n{\r\nmemcpy(&(ctx->tmp[0]),in,n);\r\nctx->tmp_len=n;\r\nbreak;\r\n}\r\nn-=n%3;\r\nctx->buf_len=EVP_EncodeBlock(\r\n(unsigned char *)ctx->buf,\r\n(unsigned char *)in,n);\r\n}\r\n}\r\nelse\r\n{\r\nEVP_EncodeUpdate(&(ctx->base64),\r\n(unsigned char *)ctx->buf,&ctx->buf_len,\r\n(unsigned char *)in,n);\r\n}\r\ninl-=n;\r\nin+=n;\r\nctx->buf_off=0;\r\nn=ctx->buf_len;\r\nwhile (n > 0)\r\n{\r\ni=BIO_write(b->next_bio,&(ctx->buf[ctx->buf_off]),n);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nreturn((ret == 0)?i:ret);\r\n}\r\nn-=i;\r\nctx->buf_off+=i;\r\n}\r\nctx->buf_len=0;\r\nctx->buf_off=0;\r\n}\r\nreturn(ret);\r\n}\r\nstatic long b64_ctrl(BIO *b, int cmd, long num, char *ptr)\r\n{\r\nBIO_B64_CTX *ctx;\r\nlong ret=1;\r\nint i;\r\nctx=(BIO_B64_CTX *)b->ptr;\r\nswitch (cmd)\r\n{\r\ncase BIO_CTRL_RESET:\r\nctx->cont=1;\r\nctx->start=1;\r\nctx->encode=B64_NONE;\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_EOF:\r\nif (ctx->cont <= 0)\r\nret=1;\r\nelse\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_WPENDING:\r\nret=ctx->buf_len-ctx->buf_off;\r\nif ((ret == 0) && (ctx->base64.num != 0))\r\nret=1;\r\nelse if (ret <= 0)\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_PENDING:\r\nret=ctx->buf_len-ctx->buf_off;\r\nif (ret <= 0)\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_FLUSH:\r\nagain:\r\nwhile (ctx->buf_len != ctx->buf_off)\r\n{\r\ni=b64_write(b,NULL,0);\r\nif (i < 0)\r\n{\r\nret=i;\r\nbreak;\r\n}\r\n}\r\nif (BIO_get_flags(b) & BIO_FLAGS_BASE64_NO_NL)\r\n{\r\nif (ctx->tmp_len != 0)\r\n{\r\nctx->buf_len=EVP_EncodeBlock(\r\n(unsigned char *)ctx->buf,\r\n(unsigned char *)ctx->tmp,\r\nctx->tmp_len);\r\nctx->buf_off=0;\r\nctx->tmp_len=0;\r\ngoto again;\r\n}\r\n}\r\nelse if (ctx->base64.num != 0)\r\n{\r\nctx->buf_off=0;\r\nEVP_EncodeFinal(&(ctx->base64),\r\n(unsigned char *)ctx->buf,\r\n&(ctx->buf_len));\r\ngoto again;\r\n}\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_C_DO_STATE_MACHINE:\r\nBIO_clear_retry_flags(b);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nBIO_copy_next_retry(b);\r\nbreak;\r\ncase BIO_CTRL_DUP:\r\nbreak;\r\ncase BIO_CTRL_INFO:\r\ncase BIO_CTRL_GET:\r\ncase BIO_CTRL_SET:\r\ndefault:\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nreturn(ret);\r\n}

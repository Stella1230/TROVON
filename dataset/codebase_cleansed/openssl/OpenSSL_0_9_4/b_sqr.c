int BN_mul(BIGNUM *r, BIGNUM *a, BIGNUM *b)\r\n{\r\nBN_ULONG *ap,*bp,*rp;\r\nBIGNUM *sk;\r\nint i,n,ret;\r\nint max,al,bl;\r\nBN_CTX ctx;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nal=a->top;\r\nbl=b->top;\r\nif ((al == 0) || (bl == 0))\r\n{\r\nr->top=0;\r\nreturn(1);\r\n}\r\n#ifdef BN_MUL_DEBUG\r\nprintf("BN_mul(%d,%d)\n",a->top,b->top);\r\n#endif\r\nif ( (bn_limit_bits > 0) &&\r\n(bl > bn_limit_num) && (al > bn_limit_num))\r\n{\r\nn=(BN_num_bits_word(al|bl)-bn_limit_bits);\r\nn*=2;\r\nsk=(BIGNUM *)Malloc(sizeof(BIGNUM)*n);\r\nmemset(sk,0,sizeof(BIGNUM)*n);\r\nmemset(&ctx,0,sizeof(ctx));\r\nret=bn_mm(r,a,b,&(sk[0]),&ctx);\r\nfor (i=0; i<n; i+=2)\r\n{\r\nBN_clear_free(&sk[i]);\r\nBN_clear_free(&sk[i+1]);\r\n}\r\nFree(sk);\r\nreturn(ret);\r\n}\r\nmax=(al+bl);\r\nif (bn_wexpand(r,max) == NULL) return(0);\r\nr->top=max;\r\nr->neg=a->neg^b->neg;\r\nap=a->d;\r\nbp=b->d;\r\nrp=r->d;\r\nrp[al]=bn_mul_words(rp,ap,al,*(bp++));\r\nrp++;\r\nfor (i=1; i<bl; i++)\r\n{\r\nrp[al]=bn_mul_add_words(rp,ap,al,*(bp++));\r\nrp++;\r\n}\r\nif ((max > 0) && (r->d[max-1] == 0)) r->top--;\r\nreturn(1);\r\n}\r\nint bn_mm(BIGNUM *m, BIGNUM *A, BIGNUM *B, BIGNUM *sk, BN_CTX *ctx)\r\n{\r\nint n,num,sqr=0;\r\nint an,bn;\r\nBIGNUM ah,al,bh,bl;\r\nan=A->top;\r\nbn=B->top;\r\n#ifdef BN_MUL_DEBUG\r\nprintf("bn_mm(%d,%d)\n",A->top,B->top);\r\n#endif\r\nif (A == B) sqr=1;\r\nnum=(an>bn)?an:bn;\r\nn=(num+1)/2;\r\nBN_init(&ah);\r\nBN_init(&al);\r\nBN_init(&bh);\r\nBN_init(&bl);\r\nbn_set_low (&al,A,n);\r\nbn_set_high(&ah,A,n);\r\nbn_set_low (&bl,B,n);\r\nbn_set_high(&bh,B,n);\r\nBN_sub(&ahal,&ah,&al);\r\nBN_sub(&blbh,&bl,&bh);\r\nif (num <= (bn_limit_num+bn_limit_num))\r\n{\r\nBN_mul(m,&ahal,&blbh);\r\nif (sqr)\r\n{\r\nBN_sqr(&ahal,&al,ctx);\r\nBN_sqr(&blbh,&ah,ctx);\r\n}\r\nelse\r\n{\r\nBN_mul(&ahal,&al,&bl);\r\nBN_mul(&blbh,&ah,&bh);\r\n}\r\n}\r\nelse\r\n{\r\nbn_mm(m,&ahal,&blbh,&(sk[2]),ctx);\r\nbn_mm(&ahal,&al,&bl,&(sk[2]),ctx);\r\nbn_mm(&blbh,&ah,&bh,&(sk[2]),ctx);\r\n}\r\nBN_add(m,m,&ahal);\r\nBN_add(m,m,&blbh);\r\nBN_lshift(m,m,n*BN_BITS2);\r\nBN_lshift(&blbh,&blbh,n*BN_BITS2*2);\r\nBN_add(m,m,&ahal);\r\nBN_add(m,m,&blbh);\r\nm->neg=A->neg^B->neg;\r\nreturn(1);\r\n}

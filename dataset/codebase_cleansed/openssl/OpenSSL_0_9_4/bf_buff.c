BIO_METHOD *BIO_f_buffer(void)\r\n{\r\nreturn(&methods_buffer);\r\n}\r\nstatic int buffer_new(BIO *bi)\r\n{\r\nBIO_F_BUFFER_CTX *ctx;\r\nctx=(BIO_F_BUFFER_CTX *)Malloc(sizeof(BIO_F_BUFFER_CTX));\r\nif (ctx == NULL) return(0);\r\nctx->ibuf=(char *)Malloc(DEFAULT_BUFFER_SIZE);\r\nif (ctx->ibuf == NULL) { Free(ctx); return(0); }\r\nctx->obuf=(char *)Malloc(DEFAULT_BUFFER_SIZE);\r\nif (ctx->obuf == NULL) { Free(ctx->ibuf); Free(ctx); return(0); }\r\nctx->ibuf_size=DEFAULT_BUFFER_SIZE;\r\nctx->obuf_size=DEFAULT_BUFFER_SIZE;\r\nctx->ibuf_len=0;\r\nctx->ibuf_off=0;\r\nctx->obuf_len=0;\r\nctx->obuf_off=0;\r\nbi->init=1;\r\nbi->ptr=(char *)ctx;\r\nbi->flags=0;\r\nreturn(1);\r\n}\r\nstatic int buffer_free(BIO *a)\r\n{\r\nBIO_F_BUFFER_CTX *b;\r\nif (a == NULL) return(0);\r\nb=(BIO_F_BUFFER_CTX *)a->ptr;\r\nif (b->ibuf != NULL) Free(b->ibuf);\r\nif (b->obuf != NULL) Free(b->obuf);\r\nFree(a->ptr);\r\na->ptr=NULL;\r\na->init=0;\r\na->flags=0;\r\nreturn(1);\r\n}\r\nstatic int buffer_read(BIO *b, char *out, int outl)\r\n{\r\nint i,num=0;\r\nBIO_F_BUFFER_CTX *ctx;\r\nif (out == NULL) return(0);\r\nctx=(BIO_F_BUFFER_CTX *)b->ptr;\r\nif ((ctx == NULL) || (b->next_bio == NULL)) return(0);\r\nnum=0;\r\nBIO_clear_retry_flags(b);\r\nstart:\r\ni=ctx->ibuf_len;\r\nif (i != 0)\r\n{\r\nif (i > outl) i=outl;\r\nmemcpy(out,&(ctx->ibuf[ctx->ibuf_off]),i);\r\nctx->ibuf_off+=i;\r\nctx->ibuf_len-=i;\r\nnum+=i;\r\nif (outl == i) return(num);\r\noutl-=i;\r\nout+=i;\r\n}\r\nif (outl > ctx->ibuf_size)\r\n{\r\nfor (;;)\r\n{\r\ni=BIO_read(b->next_bio,out,outl);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\nnum+=i;\r\nif (outl == i) return(num);\r\nout+=i;\r\noutl-=i;\r\n}\r\n}\r\ni=BIO_read(b->next_bio,ctx->ibuf,ctx->ibuf_size);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\nctx->ibuf_off=0;\r\nctx->ibuf_len=i;\r\ngoto start;\r\n}\r\nstatic int buffer_write(BIO *b, char *in, int inl)\r\n{\r\nint i,num=0;\r\nBIO_F_BUFFER_CTX *ctx;\r\nif ((in == NULL) || (inl <= 0)) return(0);\r\nctx=(BIO_F_BUFFER_CTX *)b->ptr;\r\nif ((ctx == NULL) || (b->next_bio == NULL)) return(0);\r\nBIO_clear_retry_flags(b);\r\nstart:\r\ni=ctx->obuf_size-(ctx->obuf_len+ctx->obuf_off);\r\nif (i >= inl)\r\n{\r\nmemcpy(&(ctx->obuf[ctx->obuf_len]),in,inl);\r\nctx->obuf_len+=inl;\r\nreturn(num+inl);\r\n}\r\nif (ctx->obuf_len != 0)\r\n{\r\nif (i > 0)\r\n{\r\nmemcpy(&(ctx->obuf[ctx->obuf_len]),in,i);\r\nin+=i;\r\ninl-=i;\r\nnum+=i;\r\nctx->obuf_len+=i;\r\n}\r\nfor (;;)\r\n{\r\ni=BIO_write(b->next_bio,&(ctx->obuf[ctx->obuf_off]),\r\nctx->obuf_len);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\nctx->obuf_off+=i;\r\nctx->obuf_len-=i;\r\nif (ctx->obuf_len == 0) break;\r\n}\r\n}\r\nctx->obuf_off=0;\r\nwhile (inl >= ctx->obuf_size)\r\n{\r\ni=BIO_write(b->next_bio,in,inl);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\nnum+=i;\r\nin+=i;\r\ninl-=i;\r\nif (inl == 0) return(num);\r\n}\r\ngoto start;\r\n}\r\nstatic long buffer_ctrl(BIO *b, int cmd, long num, char *ptr)\r\n{\r\nBIO *dbio;\r\nBIO_F_BUFFER_CTX *ctx;\r\nlong ret=1;\r\nchar *p1,*p2;\r\nint r,i,*ip;\r\nint ibs,obs;\r\nctx=(BIO_F_BUFFER_CTX *)b->ptr;\r\nswitch (cmd)\r\n{\r\ncase BIO_CTRL_RESET:\r\nctx->ibuf_off=0;\r\nctx->ibuf_len=0;\r\nctx->obuf_off=0;\r\nctx->obuf_len=0;\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_INFO:\r\nret=(long)ctx->obuf_len;\r\nbreak;\r\ncase BIO_C_GET_BUFF_NUM_LINES:\r\nret=0;\r\np1=ctx->ibuf;\r\nfor (i=ctx->ibuf_off; i<ctx->ibuf_len; i++)\r\n{\r\nif (p1[i] == '\n') ret++;\r\n}\r\nbreak;\r\ncase BIO_CTRL_WPENDING:\r\nret=(long)ctx->obuf_len;\r\nif (ret == 0)\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_PENDING:\r\nret=(long)ctx->ibuf_len;\r\nif (ret == 0)\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_C_SET_BUFF_READ_DATA:\r\nif (num > ctx->ibuf_size)\r\n{\r\np1=Malloc((int)num);\r\nif (p1 == NULL) goto malloc_error;\r\nif (ctx->ibuf != NULL) Free(ctx->ibuf);\r\nctx->ibuf=p1;\r\n}\r\nctx->ibuf_off=0;\r\nctx->ibuf_len=(int)num;\r\nmemcpy(ctx->ibuf,ptr,(int)num);\r\nret=1;\r\nbreak;\r\ncase BIO_C_SET_BUFF_SIZE:\r\nif (ptr != NULL)\r\n{\r\nip=(int *)ptr;\r\nif (*ip == 0)\r\n{\r\nibs=(int)num;\r\nobs=ctx->obuf_size;\r\n}\r\nelse\r\n{\r\nibs=ctx->ibuf_size;\r\nobs=(int)num;\r\n}\r\n}\r\nelse\r\n{\r\nibs=(int)num;\r\nobs=(int)num;\r\n}\r\np1=ctx->ibuf;\r\np2=ctx->obuf;\r\nif ((ibs > DEFAULT_BUFFER_SIZE) && (ibs != ctx->ibuf_size))\r\n{\r\np1=(char *)Malloc((int)num);\r\nif (p1 == NULL) goto malloc_error;\r\n}\r\nif ((obs > DEFAULT_BUFFER_SIZE) && (obs != ctx->obuf_size))\r\n{\r\np2=(char *)Malloc((int)num);\r\nif (p2 == NULL)\r\n{\r\nif (p1 != ctx->ibuf) Free(p1);\r\ngoto malloc_error;\r\n}\r\n}\r\nif (ctx->ibuf != p1)\r\n{\r\nFree(ctx->ibuf);\r\nctx->ibuf=p1;\r\nctx->ibuf_off=0;\r\nctx->ibuf_len=0;\r\nctx->ibuf_size=ibs;\r\n}\r\nif (ctx->obuf != p2)\r\n{\r\nFree(ctx->obuf);\r\nctx->obuf=p2;\r\nctx->obuf_off=0;\r\nctx->obuf_len=0;\r\nctx->obuf_size=obs;\r\n}\r\nbreak;\r\ncase BIO_C_DO_STATE_MACHINE:\r\nBIO_clear_retry_flags(b);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nBIO_copy_next_retry(b);\r\nbreak;\r\ncase BIO_CTRL_FLUSH:\r\nif (ctx->obuf_len <= 0)\r\n{\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nfor (;;)\r\n{\r\nBIO_clear_retry_flags(b);\r\nif (ctx->obuf_len > ctx->obuf_off)\r\n{\r\nr=BIO_write(b->next_bio,\r\n&(ctx->obuf[ctx->obuf_off]),\r\nctx->obuf_len-ctx->obuf_off);\r\n#if 0\r\nfprintf(stderr,"FLUSH [%3d] %3d -> %3d\n",ctx->obuf_off,ctx->obuf_len-ctx->obuf_off,r);\r\n#endif\r\nBIO_copy_next_retry(b);\r\nif (r <= 0) return((long)r);\r\nctx->obuf_off+=r;\r\n}\r\nelse\r\n{\r\nctx->obuf_len=0;\r\nctx->obuf_off=0;\r\nret=1;\r\nbreak;\r\n}\r\n}\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_DUP:\r\ndbio=(BIO *)ptr;\r\nif ( !BIO_set_read_buffer_size(dbio,ctx->ibuf_size) ||\r\n!BIO_set_write_buffer_size(dbio,ctx->obuf_size))\r\nret=0;\r\nbreak;\r\ndefault:\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nreturn(ret);\r\nmalloc_error:\r\nBIOerr(BIO_F_BUFFER_CTRL,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nstatic int buffer_gets(BIO *b, char *buf, int size)\r\n{\r\nBIO_F_BUFFER_CTX *ctx;\r\nint num=0,i,flag;\r\nchar *p;\r\nctx=(BIO_F_BUFFER_CTX *)b->ptr;\r\nsize--;\r\nBIO_clear_retry_flags(b);\r\nfor (;;)\r\n{\r\nif (ctx->ibuf_len > 0)\r\n{\r\np= &(ctx->ibuf[ctx->ibuf_off]);\r\nflag=0;\r\nfor (i=0; (i<ctx->ibuf_len) && (i<size); i++)\r\n{\r\n*(buf++)=p[i];\r\nif (p[i] == '\n')\r\n{\r\nflag=1;\r\ni++;\r\nbreak;\r\n}\r\n}\r\nnum+=i;\r\nsize-=i;\r\nctx->ibuf_len-=i;\r\nctx->ibuf_off+=i;\r\nif ((flag) || (i == size))\r\n{\r\n*buf='\0';\r\nreturn(num);\r\n}\r\n}\r\nelse\r\n{\r\ni=BIO_read(b->next_bio,ctx->ibuf,ctx->ibuf_size);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\nctx->ibuf_len=i;\r\nctx->ibuf_off=0;\r\n}\r\n}\r\n}\r\nstatic int buffer_puts(BIO *b, char *str)\r\n{\r\nreturn(BIO_write(b,str,strlen(str)));\r\n}

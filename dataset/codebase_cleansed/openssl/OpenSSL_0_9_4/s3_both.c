int ssl3_send_finished(SSL *s, int a, int b, unsigned char *sender,\r\nint slen)\r\n{\r\nunsigned char *p,*d;\r\nint i;\r\nunsigned long l;\r\nif (s->state == a)\r\n{\r\nd=(unsigned char *)s->init_buf->data;\r\np= &(d[4]);\r\ni=s->method->ssl3_enc->final_finish_mac(s,\r\n&(s->s3->finish_dgst1),\r\n&(s->s3->finish_dgst2),\r\nsender,slen,p);\r\np+=i;\r\nl=i;\r\n#ifdef WIN16\r\nl&=0xffff;\r\n#endif\r\n*(d++)=SSL3_MT_FINISHED;\r\nl2n3(l,d);\r\ns->init_num=(int)l+4;\r\ns->init_off=0;\r\ns->state=b;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\n}\r\nint ssl3_get_finished(SSL *s, int a, int b)\r\n{\r\nint al,i,ok;\r\nlong n;\r\nunsigned char *p;\r\nn=ssl3_get_message(s,\r\na,\r\nb,\r\nSSL3_MT_FINISHED,\r\n64,\r\n&ok);\r\nif (!ok) return((int)n);\r\nif (!s->s3->change_cipher_spec)\r\n{\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\nSSLerr(SSL_F_SSL3_GET_FINISHED,SSL_R_GOT_A_FIN_BEFORE_A_CCS);\r\ngoto f_err;\r\n}\r\ns->s3->change_cipher_spec=0;\r\np=(unsigned char *)s->init_buf->data;\r\ni=s->method->ssl3_enc->finish_mac_length;\r\nif (i != n)\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_FINISHED,SSL_R_BAD_DIGEST_LENGTH);\r\ngoto f_err;\r\n}\r\nif (memcmp( p, (char *)&(s->s3->tmp.finish_md[0]),i) != 0)\r\n{\r\nal=SSL_AD_DECRYPT_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_FINISHED,SSL_R_DIGEST_CHECK_FAILED);\r\ngoto f_err;\r\n}\r\nreturn(1);\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\nreturn(0);\r\n}\r\nint ssl3_send_change_cipher_spec(SSL *s, int a, int b)\r\n{\r\nunsigned char *p;\r\nif (s->state == a)\r\n{\r\np=(unsigned char *)s->init_buf->data;\r\n*p=SSL3_MT_CCS;\r\ns->init_num=1;\r\ns->init_off=0;\r\ns->state=b;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_CHANGE_CIPHER_SPEC));\r\n}\r\nunsigned long ssl3_output_cert_chain(SSL *s, X509 *x)\r\n{\r\nunsigned char *p;\r\nint n,i;\r\nunsigned long l=7;\r\nBUF_MEM *buf;\r\nX509_STORE_CTX xs_ctx;\r\nX509_OBJECT obj;\r\nbuf=s->init_buf;\r\nif (!BUF_MEM_grow(buf,(int)(10)))\r\n{\r\nSSLerr(SSL_F_SSL3_OUTPUT_CERT_CHAIN,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\nif (x != NULL)\r\n{\r\nX509_STORE_CTX_init(&xs_ctx,s->ctx->cert_store,NULL,NULL);\r\nfor (;;)\r\n{\r\nn=i2d_X509(x,NULL);\r\nif (!BUF_MEM_grow(buf,(int)(n+l+3)))\r\n{\r\nSSLerr(SSL_F_SSL3_OUTPUT_CERT_CHAIN,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\np=(unsigned char *)&(buf->data[l]);\r\nl2n3(n,p);\r\ni2d_X509(x,&p);\r\nl+=n+3;\r\nif (X509_NAME_cmp(X509_get_subject_name(x),\r\nX509_get_issuer_name(x)) == 0) break;\r\ni=X509_STORE_get_by_subject(&xs_ctx,X509_LU_X509,\r\nX509_get_issuer_name(x),&obj);\r\nif (i <= 0) break;\r\nx=obj.data.x509;\r\nX509_free(x);\r\n}\r\nX509_STORE_CTX_cleanup(&xs_ctx);\r\n}\r\nif (s->ctx->extra_certs != NULL)\r\nfor (i=0; i<sk_X509_num(s->ctx->extra_certs); i++)\r\n{\r\nx=sk_X509_value(s->ctx->extra_certs,i);\r\nn=i2d_X509(x,NULL);\r\nif (!BUF_MEM_grow(buf,(int)(n+l+3)))\r\n{\r\nSSLerr(SSL_F_SSL3_OUTPUT_CERT_CHAIN,ERR_R_BUF_LIB);\r\nreturn(0);\r\n}\r\np=(unsigned char *)&(buf->data[l]);\r\nl2n3(n,p);\r\ni2d_X509(x,&p);\r\nl+=n+3;\r\n}\r\nl-=7;\r\np=(unsigned char *)&(buf->data[4]);\r\nl2n3(l,p);\r\nl+=3;\r\np=(unsigned char *)&(buf->data[0]);\r\n*(p++)=SSL3_MT_CERTIFICATE;\r\nl2n3(l,p);\r\nl+=4;\r\nreturn(l);\r\n}\r\nlong ssl3_get_message(SSL *s, int st1, int stn, int mt, long max, int *ok)\r\n{\r\nunsigned char *p;\r\nunsigned long l;\r\nlong n;\r\nint i,al;\r\nif (s->s3->tmp.reuse_message)\r\n{\r\ns->s3->tmp.reuse_message=0;\r\nif ((mt >= 0) && (s->s3->tmp.message_type != mt))\r\n{\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\nSSLerr(SSL_F_SSL3_GET_MESSAGE,SSL_R_UNEXPECTED_MESSAGE);\r\ngoto f_err;\r\n}\r\n*ok=1;\r\nreturn((int)s->s3->tmp.message_size);\r\n}\r\np=(unsigned char *)s->init_buf->data;\r\nif (s->state == st1)\r\n{\r\ni=ssl3_read_bytes(s,SSL3_RT_HANDSHAKE,&p[s->init_num],\r\n4-s->init_num);\r\nif (i < (4-s->init_num))\r\n{\r\n*ok=0;\r\nreturn(ssl3_part_read(s,i));\r\n}\r\nif ((mt >= 0) && (*p != mt))\r\n{\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\nSSLerr(SSL_F_SSL3_GET_MESSAGE,SSL_R_UNEXPECTED_MESSAGE);\r\ngoto f_err;\r\n}\r\ns->s3->tmp.message_type= *(p++);\r\nn2l3(p,l);\r\nif (l > (unsigned long)max)\r\n{\r\nal=SSL_AD_ILLEGAL_PARAMETER;\r\nSSLerr(SSL_F_SSL3_GET_MESSAGE,SSL_R_EXCESSIVE_MESSAGE_SIZE);\r\ngoto f_err;\r\n}\r\nif (l && !BUF_MEM_grow(s->init_buf,(int)l))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_MESSAGE,ERR_R_BUF_LIB);\r\ngoto err;\r\n}\r\ns->s3->tmp.message_size=l;\r\ns->state=stn;\r\ns->init_num=0;\r\n}\r\np=(unsigned char *)s->init_buf->data;\r\nn=s->s3->tmp.message_size;\r\nif (n > 0)\r\n{\r\ni=ssl3_read_bytes(s,SSL3_RT_HANDSHAKE,&p[s->init_num],n);\r\nif (i != (int)n)\r\n{\r\n*ok=0;\r\nreturn(ssl3_part_read(s,i));\r\n}\r\n}\r\n*ok=1;\r\nreturn(n);\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\nerr:\r\n*ok=0;\r\nreturn(-1);\r\n}\r\nint ssl_cert_type(X509 *x, EVP_PKEY *pkey)\r\n{\r\nEVP_PKEY *pk;\r\nint ret= -1,i,j;\r\nif (pkey == NULL)\r\npk=X509_get_pubkey(x);\r\nelse\r\npk=pkey;\r\nif (pk == NULL) goto err;\r\ni=pk->type;\r\nif (i == EVP_PKEY_RSA)\r\n{\r\nret=SSL_PKEY_RSA_ENC;\r\nif (x != NULL)\r\n{\r\nj=X509_get_ext_count(x);\r\n}\r\n}\r\nelse if (i == EVP_PKEY_DSA)\r\n{\r\nret=SSL_PKEY_DSA_SIGN;\r\n}\r\nelse if (i == EVP_PKEY_DH)\r\n{\r\nif (x == NULL)\r\nret=SSL_PKEY_DH_DSA;\r\nelse\r\n{\r\nj=X509_get_signature_type(x);\r\nif (j == EVP_PKEY_RSA)\r\nret=SSL_PKEY_DH_RSA;\r\nelse if (j== EVP_PKEY_DSA)\r\nret=SSL_PKEY_DH_DSA;\r\nelse ret= -1;\r\n}\r\n}\r\nelse\r\nret= -1;\r\nerr:\r\nif(!pkey) EVP_PKEY_free(pk);\r\nreturn(ret);\r\n}\r\nint ssl_verify_alarm_type(long type)\r\n{\r\nint al;\r\nswitch(type)\r\n{\r\ncase X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT:\r\ncase X509_V_ERR_UNABLE_TO_GET_CRL:\r\nal=SSL_AD_UNKNOWN_CA;\r\nbreak;\r\ncase X509_V_ERR_UNABLE_TO_DECRYPT_CERT_SIGNATURE:\r\ncase X509_V_ERR_UNABLE_TO_DECRYPT_CRL_SIGNATURE:\r\ncase X509_V_ERR_UNABLE_TO_DECODE_ISSUER_PUBLIC_KEY:\r\ncase X509_V_ERR_ERROR_IN_CERT_NOT_BEFORE_FIELD:\r\ncase X509_V_ERR_ERROR_IN_CERT_NOT_AFTER_FIELD:\r\ncase X509_V_ERR_ERROR_IN_CRL_LAST_UPDATE_FIELD:\r\ncase X509_V_ERR_ERROR_IN_CRL_NEXT_UPDATE_FIELD:\r\ncase X509_V_ERR_CERT_NOT_YET_VALID:\r\ncase X509_V_ERR_CRL_NOT_YET_VALID:\r\nal=SSL_AD_BAD_CERTIFICATE;\r\nbreak;\r\ncase X509_V_ERR_CERT_SIGNATURE_FAILURE:\r\ncase X509_V_ERR_CRL_SIGNATURE_FAILURE:\r\nal=SSL_AD_DECRYPT_ERROR;\r\nbreak;\r\ncase X509_V_ERR_CERT_HAS_EXPIRED:\r\ncase X509_V_ERR_CRL_HAS_EXPIRED:\r\nal=SSL_AD_CERTIFICATE_EXPIRED;\r\nbreak;\r\ncase X509_V_ERR_CERT_REVOKED:\r\nal=SSL_AD_CERTIFICATE_REVOKED;\r\nbreak;\r\ncase X509_V_ERR_OUT_OF_MEM:\r\nal=SSL_AD_INTERNAL_ERROR;\r\nbreak;\r\ncase X509_V_ERR_DEPTH_ZERO_SELF_SIGNED_CERT:\r\ncase X509_V_ERR_SELF_SIGNED_CERT_IN_CHAIN:\r\ncase X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT_LOCALLY:\r\ncase X509_V_ERR_UNABLE_TO_VERIFY_LEAF_SIGNATURE:\r\ncase X509_V_ERR_CERT_CHAIN_TOO_LONG:\r\nal=SSL_AD_UNKNOWN_CA;\r\nbreak;\r\ncase X509_V_ERR_APPLICATION_VERIFICATION:\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nbreak;\r\ndefault:\r\nal=SSL_AD_CERTIFICATE_UNKNOWN;\r\nbreak;\r\n}\r\nreturn(al);\r\n}\r\nint ssl3_setup_buffers(SSL *s)\r\n{\r\nunsigned char *p;\r\nunsigned int extra;\r\nif (s->s3->rbuf.buf == NULL)\r\n{\r\nif (s->options & SSL_OP_MICROSOFT_BIG_SSLV3_BUFFER)\r\nextra=SSL3_RT_MAX_EXTRA;\r\nelse\r\nextra=0;\r\nif ((p=(unsigned char *)Malloc(SSL3_RT_MAX_PACKET_SIZE+extra))\r\n== NULL)\r\ngoto err;\r\ns->s3->rbuf.buf=p;\r\n}\r\nif (s->s3->wbuf.buf == NULL)\r\n{\r\nif ((p=(unsigned char *)Malloc(SSL3_RT_MAX_PACKET_SIZE))\r\n== NULL)\r\ngoto err;\r\ns->s3->wbuf.buf=p;\r\n}\r\ns->packet= &(s->s3->rbuf.buf[0]);\r\nreturn(1);\r\nerr:\r\nSSLerr(SSL_F_SSL3_SETUP_BUFFERS,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}

int main(int argc, char **argv)\r\n{\r\nPARMS p;\r\nBN_MONT_CTX *mont;\r\nint size=0,num;\r\nchar *name;\r\nint type=P_EXP;\r\nmont=BN_MONT_CTX_new();\r\np.mont=NULL;\r\np.ctx=BN_CTX_new();\r\nBN_init(&p.r);\r\nBN_init(&p.a);\r\nBN_init(&p.b);\r\nBN_init(&p.c);\r\nBN_init(&p.low);\r\np.w=0;\r\nfor (;;)\r\n{\r\nif (argc > 1)\r\n{\r\nif (argv[1][0] == '-')\r\n{\r\nswitch(argv[1][1])\r\n{\r\ncase 'e': type=P_EXP; break;\r\ncase 'm': type=P_MUL; break;\r\ncase 's': type=P_SQR; break;\r\ncase 'l': type=P_MULL; break;\r\ncase 'h': type=P_MULH; break;\r\ncase 'r': type=P_MRED; break;\r\ndefault:\r\nfprintf(stderr,"options: -[emslhr]\n");\r\nexit(1);\r\n}\r\n}\r\nelse\r\n{\r\nsize=atoi(argv[1]);\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nelse\r\nbreak;\r\n}\r\nif (size == 0)\r\nsize=DEFAULT_SIZE;\r\nprintf("bit size:%5d\n",size);\r\nBN_rand(&p.a,size,1,0);\r\nBN_rand(&p.b,size,1,0);\r\nBN_rand(&p.c,size,1,1);\r\nBN_mod(&p.a,&p.a,&p.c,p.ctx);\r\nBN_mod(&p.b,&p.b,&p.c,p.ctx);\r\np.w=(p.a.top+1)/2;\r\nBN_mul(&p.low,&p.a,&p.b,p.ctx);\r\np.low.top=p.a.top;\r\nswitch(type)\r\n{\r\ncase P_EXP:\r\np.name="r=a^b%c";\r\np.func=do_mul_exp;\r\np.mont=mont;\r\nbreak;\r\ncase P_MUL:\r\np.name="r=a*b";\r\np.func=do_mul;\r\nbreak;\r\ncase P_SQR:\r\np.name="r=a*a";\r\np.func=do_sqr;\r\nbreak;\r\ncase P_MULL:\r\np.name="r=low(a*b)";\r\np.func=do_mul_low;\r\nbreak;\r\ncase P_MULH:\r\np.name="r=high(a*b)";\r\np.func=do_mul_high;\r\nbreak;\r\ncase P_MRED:\r\np.name="r=montgomery_reduction(a)";\r\np.func=do_from_montgomery;\r\np.mont=mont;\r\nbreak;\r\ndefault:\r\nfprintf(stderr,"options: -[emslhr]\n");\r\nexit(1);\r\n}\r\nnum=time_it(DEFAULT_TIME,&p);\r\ndo_it(num,&p);\r\n}\r\nvoid do_it(int num, PARMS *p)\r\n{\r\nchar *start,*end;\r\nint i,j,number;\r\ndouble d;\r\nstart=ms_time_new();\r\nend=ms_time_new();\r\nnumber=BN_num_bits_word((BN_ULONG)BN_num_bits(&(p->c)))-\r\nBN_num_bits_word(BN_BITS2)+2;\r\nfor (i=number-1; i >=0; i--)\r\n{\r\nif (i == 1) continue;\r\nBN_set_params(i,i,i,1);\r\nif (p->mont != NULL)\r\nBN_MONT_CTX_set(p->mont,&(p->c),p->ctx);\r\nprintf("Timing %5d (%2d bit) %2d %2d %2d %2d :",\r\n(1<<i)*BN_BITS2,i,\r\nBN_get_params(0),\r\nBN_get_params(1),\r\nBN_get_params(2),\r\nBN_get_params(3));\r\nfflush(stdout);\r\nms_time_get(start);\r\np->func(num,p);\r\nms_time_get(end);\r\nd=ms_time_diff(start,end);\r\nprintf("%6.6f sec, or %d in %.4f seconds\n",\r\n(double)d/num,num,d);\r\n}\r\n}\r\nint time_it(int sec, PARMS *p)\r\n{\r\nchar *start,*end;\r\nint i,j;\r\ndouble d;\r\nif (p->mont != NULL)\r\nBN_MONT_CTX_set(p->mont,&(p->c),p->ctx);\r\nstart=ms_time_new();\r\nend=ms_time_new();\r\ni=1;\r\nfor (;;)\r\n{\r\nif (verbose)\r\nprintf("timing %s for %d interations\n",p->name,i);\r\nms_time_get(start);\r\np->func(i,p);\r\nms_time_get(end);\r\nd=ms_time_diff(start,end);\r\nif (d < 0.01) i*=100;\r\nelse if (d < 0.1 ) i*=10;\r\nelse if (d > (double)sec) break;\r\nelse\r\n{\r\ni=(int)(1.0*i*sec/d);\r\nbreak;\r\n}\r\n}\r\nif (verbose)\r\nprintf("using %d interations\n",i);\r\nreturn(i);\r\n}\r\nvoid do_mul_exp(int num, PARMS *p)\r\n{\r\nint i;\r\nfor (i=0; i<num; i++)\r\nBN_mod_exp_mont(&(p->r),&(p->a),&(p->b),&(p->c),\r\np->ctx,p->mont);\r\n}\r\nvoid do_mul(int num, PARMS *p)\r\n{\r\nint i;\r\nfor (i=0; i<num; i++)\r\nBN_mul(&(p->r),&(p->a),&(p->b),p->ctx);\r\n}\r\nvoid do_sqr(int num, PARMS *p)\r\n{\r\nint i;\r\nfor (i=0; i<num; i++)\r\nBN_sqr(&(p->r),&(p->a),p->ctx);\r\n}\r\nvoid do_mul_low(int num, PARMS *p)\r\n{\r\nint i;\r\nfor (i=0; i<num; i++)\r\nBN_mul_low(&(p->r),&(p->a),&(p->b),p->w,p->ctx);\r\n}\r\nvoid do_mul_high(int num, PARMS *p)\r\n{\r\nint i;\r\nfor (i=0; i<num; i++)\r\nBN_mul_low(&(p->r),&(p->a),&(p->b),&(p->low),p->w,p->ctx);\r\n}\r\nvoid do_from_montgomery(int num, PARMS *p)\r\n{\r\nint i;\r\nfor (i=0; i<num; i++)\r\nBN_from_montgomery(&(p->r),&(p->a),p->mont,p->ctx);\r\n}

int BN_sqr(BIGNUM *r, BIGNUM *a, BN_CTX *ctx)\r\n{\r\nint max,al;\r\nBIGNUM *tmp,*rr;\r\n#ifdef BN_COUNT\r\nprintf("BN_sqr %d * %d\n",a->top,a->top);\r\n#endif\r\nbn_check_top(a);\r\ntmp= &(ctx->bn[ctx->tos]);\r\nrr=(a != r)?r: (&ctx->bn[ctx->tos+1]);\r\nal=a->top;\r\nif (al <= 0)\r\n{\r\nr->top=0;\r\nreturn(1);\r\n}\r\nmax=(al+al);\r\nif (bn_wexpand(rr,max+1) == NULL) return(0);\r\nr->neg=0;\r\nif (al == 4)\r\n{\r\n#ifndef BN_SQR_COMBA\r\nBN_ULONG t[8];\r\nbn_sqr_normal(rr->d,a->d,4,t);\r\n#else\r\nbn_sqr_comba4(rr->d,a->d);\r\n#endif\r\n}\r\nelse if (al == 8)\r\n{\r\n#ifndef BN_SQR_COMBA\r\nBN_ULONG t[16];\r\nbn_sqr_normal(rr->d,a->d,8,t);\r\n#else\r\nbn_sqr_comba8(rr->d,a->d);\r\n#endif\r\n}\r\nelse\r\n{\r\n#if defined(BN_RECURSION)\r\nif (al < BN_SQR_RECURSIVE_SIZE_NORMAL)\r\n{\r\nBN_ULONG t[BN_SQR_RECURSIVE_SIZE_NORMAL*2];\r\nbn_sqr_normal(rr->d,a->d,al,t);\r\n}\r\nelse\r\n{\r\nint j,k;\r\nj=BN_num_bits_word((BN_ULONG)al);\r\nj=1<<(j-1);\r\nk=j+j;\r\nif (al == j)\r\n{\r\nif (bn_wexpand(a,k*2) == NULL) return(0);\r\nif (bn_wexpand(tmp,k*2) == NULL) return(0);\r\nbn_sqr_recursive(rr->d,a->d,al,tmp->d);\r\n}\r\nelse\r\n{\r\nif (bn_wexpand(tmp,max) == NULL) return(0);\r\nbn_sqr_normal(rr->d,a->d,al,tmp->d);\r\n}\r\n}\r\n#else\r\nif (bn_wexpand(tmp,max) == NULL) return(0);\r\nbn_sqr_normal(rr->d,a->d,al,tmp->d);\r\n#endif\r\n}\r\nrr->top=max;\r\nif ((max > 0) && (rr->d[max-1] == 0)) rr->top--;\r\nif (rr != r) BN_copy(r,rr);\r\nreturn(1);\r\n}\r\nvoid bn_sqr_normal(BN_ULONG *r, BN_ULONG *a, int n, BN_ULONG *tmp)\r\n{\r\nint i,j,max;\r\nBN_ULONG *ap,*rp;\r\nmax=n*2;\r\nap=a;\r\nrp=r;\r\nrp[0]=rp[max-1]=0;\r\nrp++;\r\nj=n;\r\nif (--j > 0)\r\n{\r\nap++;\r\nrp[j]=bn_mul_words(rp,ap,j,ap[-1]);\r\nrp+=2;\r\n}\r\nfor (i=n-2; i>0; i--)\r\n{\r\nj--;\r\nap++;\r\nrp[j]=bn_mul_add_words(rp,ap,j,ap[-1]);\r\nrp+=2;\r\n}\r\nbn_add_words(r,r,r,max);\r\nbn_sqr_words(tmp,a,n);\r\nbn_add_words(r,r,tmp,max);\r\n}\r\nvoid bn_sqr_recursive(BN_ULONG *r, BN_ULONG *a, int n2, BN_ULONG *t)\r\n{\r\nint n=n2/2;\r\nint zero,c1;\r\nBN_ULONG ln,lo,*p;\r\n#ifdef BN_COUNT\r\nprintf(" bn_sqr_recursive %d * %d\n",n2,n2);\r\n#endif\r\nif (n2 == 4)\r\n{\r\n#ifndef BN_SQR_COMBA\r\nbn_sqr_normal(r,a,4,t);\r\n#else\r\nbn_sqr_comba4(r,a);\r\n#endif\r\nreturn;\r\n}\r\nelse if (n2 == 8)\r\n{\r\n#ifndef BN_SQR_COMBA\r\nbn_sqr_normal(r,a,8,t);\r\n#else\r\nbn_sqr_comba8(r,a);\r\n#endif\r\nreturn;\r\n}\r\nif (n2 < BN_SQR_RECURSIVE_SIZE_NORMAL)\r\n{\r\nbn_sqr_normal(r,a,n2,t);\r\nreturn;\r\n}\r\nc1=bn_cmp_words(a,&(a[n]),n);\r\nzero=0;\r\nif (c1 > 0)\r\nbn_sub_words(t,a,&(a[n]),n);\r\nelse if (c1 < 0)\r\nbn_sub_words(t,&(a[n]),a,n);\r\nelse\r\nzero=1;\r\np= &(t[n2*2]);\r\nif (!zero)\r\nbn_sqr_recursive(&(t[n2]),t,n,p);\r\nelse\r\nmemset(&(t[n2]),0,n*sizeof(BN_ULONG));\r\nbn_sqr_recursive(r,a,n,p);\r\nbn_sqr_recursive(&(r[n2]),&(a[n]),n,p);\r\nc1=(int)(bn_add_words(t,r,&(r[n2]),n2));\r\nc1-=(int)(bn_sub_words(&(t[n2]),t,&(t[n2]),n2));\r\nc1+=(int)(bn_add_words(&(r[n]),&(r[n]),&(t[n2]),n2));\r\nif (c1)\r\n{\r\np= &(r[n+n2]);\r\nlo= *p;\r\nln=(lo+c1)&BN_MASK2;\r\n*p=ln;\r\nif (ln < (BN_ULONG)c1)\r\n{\r\ndo {\r\np++;\r\nlo= *p;\r\nln=(lo+1)&BN_MASK2;\r\n*p=ln;\r\n} while (ln == 0);\r\n}\r\n}\r\n}

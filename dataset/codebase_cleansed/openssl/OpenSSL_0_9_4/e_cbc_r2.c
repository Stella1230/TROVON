EVP_CIPHER *EVP_rc2_cbc(void)\r\n{\r\nreturn(&r2_cbc_cipher);\r\n}\r\nEVP_CIPHER *EVP_rc2_64_cbc(void)\r\n{\r\nreturn(&r2_64_cbc_cipher);\r\n}\r\nEVP_CIPHER *EVP_rc2_40_cbc(void)\r\n{\r\nreturn(&r2_40_cbc_cipher);\r\n}\r\nstatic void rc2_cbc_init_key(EVP_CIPHER_CTX *ctx, unsigned char *key,\r\nunsigned char *iv, int enc)\r\n{\r\nif (iv != NULL)\r\nmemcpy(&(ctx->oiv[0]),iv,8);\r\nmemcpy(&(ctx->iv[0]),&(ctx->oiv[0]),8);\r\nif (key != NULL)\r\nRC2_set_key(&(ctx->c.rc2_ks),EVP_CIPHER_CTX_key_length(ctx),\r\nkey,EVP_CIPHER_CTX_key_length(ctx)*8);\r\n}\r\nstatic void rc2_cbc_cipher(EVP_CIPHER_CTX *ctx, unsigned char *out,\r\nunsigned char *in, unsigned int inl)\r\n{\r\nRC2_cbc_encrypt(\r\nin,out,(long)inl,\r\n&(ctx->c.rc2_ks),&(ctx->iv[0]),\r\nctx->encrypt);\r\n}\r\nstatic int rc2_meth_to_magic(const EVP_CIPHER *e)\r\n{\r\nint i;\r\ni=EVP_CIPHER_key_length(e);\r\nif (i == 16) return(RC2_128_MAGIC);\r\nelse if (i == 8) return(RC2_64_MAGIC);\r\nelse if (i == 5) return(RC2_40_MAGIC);\r\nelse return(0);\r\n}\r\nstatic EVP_CIPHER *rc2_magic_to_meth(int i)\r\n{\r\nif (i == RC2_128_MAGIC) return(EVP_rc2_cbc());\r\nelse if (i == RC2_64_MAGIC) return(EVP_rc2_64_cbc());\r\nelse if (i == RC2_40_MAGIC) return(EVP_rc2_40_cbc());\r\nelse\r\n{\r\nEVPerr(EVP_F_RC2_MAGIC_TO_METH,EVP_R_UNSUPPORTED_KEY_SIZE);\r\nreturn(NULL);\r\n}\r\n}\r\nstatic int rc2_get_asn1_type_and_iv(EVP_CIPHER_CTX *c, ASN1_TYPE *type)\r\n{\r\nlong num=0;\r\nint i=0,l;\r\nEVP_CIPHER *e;\r\nif (type != NULL)\r\n{\r\nl=EVP_CIPHER_CTX_iv_length(c);\r\ni=ASN1_TYPE_get_int_octetstring(type,&num,c->oiv,l);\r\nif (i != l)\r\nreturn(-1);\r\nelse if (i > 0)\r\nmemcpy(c->iv,c->oiv,l);\r\ne=rc2_magic_to_meth((int)num);\r\nif (e == NULL)\r\nreturn(-1);\r\nif (e != EVP_CIPHER_CTX_cipher(c))\r\n{\r\nEVP_CIPHER_CTX_cipher(c)=e;\r\nrc2_cbc_init_key(c,NULL,NULL,1);\r\n}\r\n}\r\nreturn(i);\r\n}\r\nstatic int rc2_set_asn1_type_and_iv(EVP_CIPHER_CTX *c, ASN1_TYPE *type)\r\n{\r\nlong num;\r\nint i=0,j;\r\nif (type != NULL)\r\n{\r\nnum=rc2_meth_to_magic(EVP_CIPHER_CTX_cipher(c));\r\nj=EVP_CIPHER_CTX_iv_length(c);\r\ni=ASN1_TYPE_set_int_octetstring(type,num,c->oiv,j);\r\n}\r\nreturn(i);\r\n}

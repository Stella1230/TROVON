int bn_mull(BIGNUM *r, BIGNUM *a, BIGNUM *b, BN_CTX *ctx)\r\n{\r\nint top,i,j,k,al,bl;\r\nBIGNUM *t;\r\n#ifdef BN_COUNT\r\nprintf("bn_mull %d * %d\n",a->top,b->top);\r\n#endif\r\nbn_check_top(a);\r\nbn_check_top(b);\r\nbn_check_top(r);\r\nal=a->top;\r\nbl=b->top;\r\nr->neg=a->neg^b->neg;\r\ntop=al+bl;\r\nif ((al < 4) || (bl < 4))\r\n{\r\nif (bn_wexpand(r,top) == NULL) return(0);\r\nr->top=top;\r\nbn_mul_normal(r->d,a->d,al,b->d,bl);\r\ngoto end;\r\n}\r\nelse if (al == bl)\r\ngoto symetric;\r\nelse\r\n{\r\ni=(al-bl);\r\nif ((i == 1) && !BN_get_flags(b,BN_FLG_STATIC_DATA))\r\n{\r\nbn_wexpand(b,al);\r\nb->d[bl]=0;\r\nbl++;\r\ngoto symetric;\r\n}\r\nelse if ((i == -1) && !BN_get_flags(a,BN_FLG_STATIC_DATA))\r\n{\r\nbn_wexpand(a,bl);\r\na->d[al]=0;\r\nal++;\r\ngoto symetric;\r\n}\r\n}\r\nif (bn_wexpand(r,top) == NULL) return(0);\r\nr->top=top;\r\nbn_mul_normal(r->d,a->d,al,b->d,bl);\r\nif (0)\r\n{\r\nsymetric:\r\nif (al == 4)\r\n{\r\nif (bn_wexpand(r,al*2) == NULL) return(0);\r\nr->top=top;\r\nbn_mul_comba4(r->d,a->d,b->d);\r\ngoto end;\r\n}\r\nif (al == 8)\r\n{\r\nif (bn_wexpand(r,al*2) == NULL) return(0);\r\nr->top=top;\r\nbn_mul_comba8(r->d,a->d,b->d);\r\ngoto end;\r\n}\r\nif (al <= BN_MULL_NORMAL_SIZE)\r\n{\r\nif (bn_wexpand(r,al*2) == NULL) return(0);\r\nr->top=top;\r\nbn_mul_normal(r->d,a->d,al,b->d,bl);\r\ngoto end;\r\n}\r\nj=BN_num_bits_word((BN_ULONG)al);\r\nj=1<<(j-1);\r\nk=j+j;\r\nt= &(ctx->bn[ctx->tos]);\r\nif (al == j)\r\n{\r\nbn_wexpand(t,k*2);\r\nbn_wexpand(r,k*2);\r\nbn_mul_recursive(r->d,a->d,b->d,al,t->d);\r\n}\r\nelse\r\n{\r\nbn_wexpand(a,k);\r\nbn_wexpand(b,k);\r\nbn_wexpand(t,k*4);\r\nbn_wexpand(r,k*4);\r\nfor (i=a->top; i<k; i++)\r\na->d[i]=0;\r\nfor (i=b->top; i<k; i++)\r\nb->d[i]=0;\r\nbn_mul_part_recursive(r->d,a->d,b->d,al-j,j,t->d);\r\n}\r\nr->top=top;\r\n}\r\nend:\r\nbn_fix_top(r);\r\nreturn(1);\r\n}\r\nvoid bn_mul_normal(BN_ULONG *r, BN_ULONG *a, int na, BN_ULONG *b, int nb)\r\n{\r\nBN_ULONG *rr;\r\n#ifdef BN_COUNT\r\nprintf(" bn_mul_normal %d * %d\n",na,nb);\r\n#endif\r\nif (na < nb)\r\n{\r\nint itmp;\r\nBN_ULONG *ltmp;\r\nitmp=na; na=nb; nb=itmp;\r\nltmp=a; a=b; b=ltmp;\r\n}\r\nrr= &(r[na]);\r\nrr[0]=bn_mul_words(r,a,na,b[0]);\r\nfor (;;)\r\n{\r\nif (--nb <= 0) return;\r\nrr[1]=bn_mul_add_words(&(r[1]),a,na,b[1]);\r\nif (--nb <= 0) return;\r\nrr[2]=bn_mul_add_words(&(r[2]),a,na,b[2]);\r\nif (--nb <= 0) return;\r\nrr[3]=bn_mul_add_words(&(r[3]),a,na,b[3]);\r\nif (--nb <= 0) return;\r\nrr[4]=bn_mul_add_words(&(r[4]),a,na,b[4]);\r\nrr+=4;\r\nr+=4;\r\nb+=4;\r\n}\r\n}\r\nvoid bn_mul_low_normal(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b, int n)\r\n{\r\n#ifdef BN_COUNT\r\nprintf(" bn_mul_low_normal %d * %d\n",n,n);\r\n#endif\r\nbn_mul_words(r,a,n,b[0]);\r\nfor (;;)\r\n{\r\nif (--n <= 0) return;\r\nbn_mul_add_words(&(r[1]),a,n,b[1]);\r\nif (--n <= 0) return;\r\nbn_mul_add_words(&(r[2]),a,n,b[2]);\r\nif (--n <= 0) return;\r\nbn_mul_add_words(&(r[3]),a,n,b[3]);\r\nif (--n <= 0) return;\r\nbn_mul_add_words(&(r[4]),a,n,b[4]);\r\nr+=4;\r\nb+=4;\r\n}\r\n}

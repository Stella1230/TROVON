void BF_cbc_encrypt(unsigned char *in, unsigned char *out, long length,\r\nBF_KEY *ks, unsigned char *iv, int encrypt)\r\n{\r\nregister BF_LONG tin0,tin1;\r\nregister BF_LONG tout0,tout1,xor0,xor1;\r\nregister long l=length;\r\nBF_LONG tin[2];\r\nif (encrypt)\r\n{\r\nn2l(iv,tout0);\r\nn2l(iv,tout1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nBF_encrypt(tin,ks);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nn2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nBF_encrypt(tin,ks);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\n}\r\nl2n(tout0,iv);\r\nl2n(tout1,iv);\r\n}\r\nelse\r\n{\r\nn2l(iv,xor0);\r\nn2l(iv,xor1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nBF_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nif (l != -8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nBF_decrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2nn(tout0,tout1,out,l+8);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nl2n(xor0,iv);\r\nl2n(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}

void EVP_CIPHER_CTX_init(EVP_CIPHER_CTX *ctx)\r\n{\r\nmemset(ctx,0,sizeof(EVP_CIPHER_CTX));\r\n}\r\nvoid EVP_CipherInit(EVP_CIPHER_CTX *ctx, const EVP_CIPHER *data,\r\nunsigned char *key, unsigned char *iv, int enc)\r\n{\r\nif (enc)\r\nEVP_EncryptInit(ctx,data,key,iv);\r\nelse\r\nEVP_DecryptInit(ctx,data,key,iv);\r\n}\r\nvoid EVP_CipherUpdate(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl,\r\nunsigned char *in, int inl)\r\n{\r\nif (ctx->encrypt)\r\nEVP_EncryptUpdate(ctx,out,outl,in,inl);\r\nelse EVP_DecryptUpdate(ctx,out,outl,in,inl);\r\n}\r\nint EVP_CipherFinal(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl)\r\n{\r\nif (ctx->encrypt)\r\n{\r\nEVP_EncryptFinal(ctx,out,outl);\r\nreturn(1);\r\n}\r\nelse return(EVP_DecryptFinal(ctx,out,outl));\r\n}\r\nvoid EVP_EncryptInit(EVP_CIPHER_CTX *ctx, const EVP_CIPHER *cipher,\r\nunsigned char *key, unsigned char *iv)\r\n{\r\nif (cipher != NULL)\r\nctx->cipher=cipher;\r\nctx->cipher->init(ctx,key,iv,1);\r\nctx->encrypt=1;\r\nctx->buf_len=0;\r\n}\r\nvoid EVP_DecryptInit(EVP_CIPHER_CTX *ctx, const EVP_CIPHER *cipher,\r\nunsigned char *key, unsigned char *iv)\r\n{\r\nif (cipher != NULL)\r\nctx->cipher=cipher;\r\nctx->cipher->init(ctx,key,iv,0);\r\nctx->encrypt=0;\r\nctx->buf_len=0;\r\n}\r\nvoid EVP_EncryptUpdate(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl,\r\nunsigned char *in, int inl)\r\n{\r\nint i,j,bl;\r\ni=ctx->buf_len;\r\nbl=ctx->cipher->block_size;\r\n*outl=0;\r\nif ((inl == 0) && (i != bl)) return;\r\nif (i != 0)\r\n{\r\nif (i+inl < bl)\r\n{\r\nmemcpy(&(ctx->buf[i]),in,inl);\r\nctx->buf_len+=inl;\r\nreturn;\r\n}\r\nelse\r\n{\r\nj=bl-i;\r\nif (j != 0) memcpy(&(ctx->buf[i]),in,j);\r\nctx->cipher->do_cipher(ctx,out,ctx->buf,bl);\r\ninl-=j;\r\nin+=j;\r\nout+=bl;\r\n*outl+=bl;\r\n}\r\n}\r\ni=inl%bl;\r\ninl-=i;\r\nif (inl > 0)\r\n{\r\nctx->cipher->do_cipher(ctx,out,in,inl);\r\n*outl+=inl;\r\n}\r\nif (i != 0)\r\nmemcpy(ctx->buf,&(in[inl]),i);\r\nctx->buf_len=i;\r\n}\r\nvoid EVP_EncryptFinal(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl)\r\n{\r\nint i,n,b,bl;\r\nb=ctx->cipher->block_size;\r\nif (b == 1)\r\n{\r\n*outl=0;\r\nreturn;\r\n}\r\nbl=ctx->buf_len;\r\nn=b-bl;\r\nfor (i=bl; i<b; i++)\r\nctx->buf[i]=n;\r\nctx->cipher->do_cipher(ctx,out,ctx->buf,b);\r\n*outl=b;\r\n}\r\nvoid EVP_DecryptUpdate(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl,\r\nunsigned char *in, int inl)\r\n{\r\nint b,bl,n;\r\nint keep_last=0;\r\n*outl=0;\r\nif (inl == 0) return;\r\nb=ctx->cipher->block_size;\r\nif (b > 1)\r\n{\r\nbl=ctx->buf_len;\r\nn=inl+bl;\r\nif (n%b == 0)\r\n{\r\nif (inl < b)\r\n{\r\nmemcpy(&(ctx->buf[bl]),in,inl);\r\nctx->buf_len=b;\r\n*outl=0;\r\nreturn;\r\n}\r\nkeep_last=1;\r\ninl-=b;\r\n}\r\n}\r\nEVP_EncryptUpdate(ctx,out,outl,in,inl);\r\nif (keep_last)\r\n{\r\nmemcpy(&(ctx->buf[0]),&(in[inl]),b);\r\n#ifdef DEBUG\r\nif (ctx->buf_len != 0)\r\n{\r\nabort();\r\n}\r\n#endif\r\nctx->buf_len=b;\r\n}\r\n}\r\nint EVP_DecryptFinal(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl)\r\n{\r\nint i,b;\r\nint n;\r\n*outl=0;\r\nb=ctx->cipher->block_size;\r\nif (b > 1)\r\n{\r\nif (ctx->buf_len != b)\r\n{\r\nEVPerr(EVP_F_EVP_DECRYPTFINAL,EVP_R_WRONG_FINAL_BLOCK_LENGTH);\r\nreturn(0);\r\n}\r\nEVP_EncryptUpdate(ctx,ctx->buf,&n,ctx->buf,0);\r\nif (n != b)\r\nreturn(0);\r\nn=ctx->buf[b-1];\r\nif (n > b)\r\n{\r\nEVPerr(EVP_F_EVP_DECRYPTFINAL,EVP_R_BAD_DECRYPT);\r\nreturn(0);\r\n}\r\nfor (i=0; i<n; i++)\r\n{\r\nif (ctx->buf[--b] != n)\r\n{\r\nEVPerr(EVP_F_EVP_DECRYPTFINAL,EVP_R_BAD_DECRYPT);\r\nreturn(0);\r\n}\r\n}\r\nn=ctx->cipher->block_size-n;\r\nfor (i=0; i<n; i++)\r\nout[i]=ctx->buf[i];\r\n*outl=n;\r\n}\r\nelse\r\n*outl=0;\r\nreturn(1);\r\n}\r\nvoid EVP_CIPHER_CTX_cleanup(EVP_CIPHER_CTX *c)\r\n{\r\nif ((c->cipher != NULL) && (c->cipher->cleanup != NULL))\r\nc->cipher->cleanup(c);\r\nmemset(c,0,sizeof(EVP_CIPHER_CTX));\r\n}

void bn_mul_recursive(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b, int n2,\r\nBN_ULONG *t)\r\n{\r\nint n=n2/2;\r\nint neg,zero,c1,c2;\r\nBN_ULONG ln,lo,*p;\r\n#ifdef BN_COUNT\r\nprintf(" bn_mul_recursive %d * %d\n",n2,n2);\r\n#endif\r\nif (n2 <= 8)\r\n{\r\nif (n2 == 8)\r\nbn_mul_comba8(r,a,b);\r\nelse\r\nbn_mul_normal(r,a,n2,b,n2);\r\nreturn;\r\n}\r\nif (n2 < BN_MUL_RECURSIVE_SIZE_NORMAL)\r\n{\r\nbn_mul_normal(r,a,n2,b,n2);\r\nreturn;\r\n}\r\nc1=bn_cmp_words(a,&(a[n]),n);\r\nc2=bn_cmp_words(&(b[n]),b,n);\r\nzero=neg=0;\r\nswitch (c1*3+c2)\r\n{\r\ncase -4:\r\nbn_sub_words(t, &(a[n]),a, n);\r\nbn_sub_words(&(t[n]),b, &(b[n]),n);\r\nbreak;\r\ncase -3:\r\nzero=1;\r\nbreak;\r\ncase -2:\r\nbn_sub_words(t, &(a[n]),a, n);\r\nbn_sub_words(&(t[n]),&(b[n]),b, n);\r\nneg=1;\r\nbreak;\r\ncase -1:\r\ncase 0:\r\ncase 1:\r\nzero=1;\r\nbreak;\r\ncase 2:\r\nbn_sub_words(t, a, &(a[n]),n);\r\nbn_sub_words(&(t[n]),b, &(b[n]),n);\r\nneg=1;\r\nbreak;\r\ncase 3:\r\nzero=1;\r\nbreak;\r\ncase 4:\r\nbn_sub_words(t, a, &(a[n]),n);\r\nbn_sub_words(&(t[n]),&(b[n]),b, n);\r\nbreak;\r\n}\r\nif (n == 8)\r\n{\r\nif (!zero)\r\nbn_mul_comba8(&(t[n2]),t,&(t[n]));\r\nelse\r\nmemset(&(t[n2]),0,8*sizeof(BN_ULONG));\r\nbn_mul_comba8(r,a,b);\r\nbn_mul_comba8(&(r[n2]),&(a[n]),&(b[n]));\r\n}\r\nelse\r\n{\r\np= &(t[n2*2]);\r\nif (!zero)\r\nbn_mul_recursive(&(t[n2]),t,&(t[n]),n,p);\r\nelse\r\nmemset(&(t[n2]),0,n*sizeof(BN_ULONG));\r\nbn_mul_recursive(r,a,b,n,p);\r\nbn_mul_recursive(&(r[n2]),&(a[n]),&(b[n]),n,p);\r\n}\r\nc1=bn_add_words(t,r,&(r[n2]),n2);\r\nif (neg)\r\n{\r\nc1-=bn_sub_words(&(t[n2]),t,&(t[n2]),n2);\r\n}\r\nelse\r\n{\r\nc1+=bn_add_words(&(t[n2]),&(t[n2]),t,n2);\r\n}\r\nc1+=bn_add_words(&(r[n]),&(r[n]),&(t[n2]),n2);\r\nif (c1)\r\n{\r\np= &(r[n+n2]);\r\nlo= *p;\r\nln=(lo+c1)&BN_MASK2;\r\n*p=ln;\r\nif (ln < c1)\r\n{\r\ndo {\r\np++;\r\nlo= *p;\r\nln=(lo+1)&BN_MASK2;\r\n*p=ln;\r\n} while (ln == 0);\r\n}\r\n}\r\n}\r\nvoid bn_mul_part_recursive(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b, int tn,\r\nint n, BN_ULONG *t)\r\n{\r\nint n2=n*2,i,j;\r\nint c1;\r\nBN_ULONG ln,lo,*p;\r\n#ifdef BN_COUNT\r\nprintf(" bn_mul_part_recursive %d * %d\n",tn+n,tn+n);\r\n#endif\r\nif (n < 8)\r\n{\r\ni=tn+n;\r\nbn_mul_normal(r,a,i,b,i);\r\nreturn;\r\n}\r\nbn_sub_words(t, a, &(a[n]),n);\r\nbn_sub_words(&(t[n]),b, &(b[n]),n);\r\nif (n == 8)\r\n{\r\nbn_mul_comba8(&(t[n2]),t,&(t[n]));\r\nbn_mul_comba8(r,a,b);\r\nbn_mul_normal(&(r[n2]),&(a[n]),tn,&(b[n]),tn);\r\nmemset(&(r[n2+tn*2]),0,sizeof(BN_ULONG)*(n2-tn*2));\r\n}\r\nelse\r\n{\r\np= &(t[n2*2]);\r\nbn_mul_recursive(&(t[n2]),t,&(t[n]),n,p);\r\nbn_mul_recursive(r,a,b,n,p);\r\ni=n/2;\r\nj=tn-i;\r\nif (j == 0)\r\n{\r\nbn_mul_recursive(&(r[n2]),&(a[n]),&(b[n]),i,p);\r\nmemset(&(r[n2+i*2]),0,sizeof(BN_ULONG)*(n2-i*2));\r\n}\r\nelse if (j > 0)\r\n{\r\nbn_mul_part_recursive(&(r[n2]),&(a[n]),&(b[n]),\r\nj,i,p);\r\nmemset(&(r[n2+tn*2]),0,\r\nsizeof(BN_ULONG)*(n2-tn*2));\r\n}\r\nelse\r\n{\r\nmemset(&(r[n2]),0,sizeof(BN_ULONG)*(tn*2));\r\nfor (;;)\r\n{\r\ni/=2;\r\nif (i < tn)\r\n{\r\nbn_mul_part_recursive(&(r[n2]),\r\n&(a[n]),&(b[n]),\r\ntn-i,i,p);\r\nbreak;\r\n}\r\nelse if (i == tn)\r\n{\r\nbn_mul_recursive(&(r[n2]),\r\n&(a[n]),&(b[n]),\r\ni,p);\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nc1=bn_add_words(t,r,&(r[n2]),n2);\r\nc1-=bn_sub_words(&(t[n2]),t,&(t[n2]),n2);\r\nc1+=bn_add_words(&(r[n]),&(r[n]),&(t[n2]),n2);\r\nif (c1)\r\n{\r\np= &(r[n+n2]);\r\nlo= *p;\r\nln=(lo+c1)&BN_MASK2;\r\n*p=ln;\r\nif (ln < c1)\r\n{\r\ndo {\r\np++;\r\nlo= *p;\r\nln=(lo+1)&BN_MASK2;\r\n*p=ln;\r\n} while (ln == 0);\r\n}\r\n}\r\n}\r\nvoid bn_sqr_recursive(BN_ULONG *r, BN_ULONG *a, int n2, BN_ULONG *t)\r\n{\r\nint n=n2/2;\r\nint zero,c1;\r\nBN_ULONG ln,lo,*p;\r\n#ifdef BN_COUNT\r\nprintf(" bn_sqr_recursive %d * %d\n",n2,n2);\r\n#endif\r\nif (n2 == 4)\r\n{\r\nbn_sqr_comba4(r,a);\r\nreturn;\r\n}\r\nelse if (n2 == 8)\r\n{\r\nbn_sqr_comba8(r,a);\r\nreturn;\r\n}\r\nif (n2 < BN_SQR_RECURSIVE_SIZE_NORMAL)\r\n{\r\nbn_sqr_normal(r,a,n2,t);\r\nreturn;\r\nabort();\r\n}\r\nc1=bn_cmp_words(a,&(a[n]),n);\r\nzero=0;\r\nif (c1 > 0)\r\nbn_sub_words(t,a,&(a[n]),n);\r\nelse if (c1 < 0)\r\nbn_sub_words(t,&(a[n]),a,n);\r\nelse\r\nzero=1;\r\nif (n == 8)\r\n{\r\nif (!zero)\r\nbn_sqr_comba8(&(t[n2]),t);\r\nelse\r\nmemset(&(t[n2]),0,8*sizeof(BN_ULONG));\r\nbn_sqr_comba8(r,a);\r\nbn_sqr_comba8(&(r[n2]),&(a[n]));\r\n}\r\nelse\r\n{\r\np= &(t[n2*2]);\r\nif (!zero)\r\nbn_sqr_recursive(&(t[n2]),t,n,p);\r\nelse\r\nmemset(&(t[n2]),0,n*sizeof(BN_ULONG));\r\nbn_sqr_recursive(r,a,n,p);\r\nbn_sqr_recursive(&(r[n2]),&(a[n]),n,p);\r\n}\r\nc1=bn_add_words(t,r,&(r[n2]),n2);\r\nc1-=bn_sub_words(&(t[n2]),t,&(t[n2]),n2);\r\nc1+=bn_add_words(&(r[n]),&(r[n]),&(t[n2]),n2);\r\nif (c1)\r\n{\r\np= &(r[n+n2]);\r\nlo= *p;\r\nln=(lo+c1)&BN_MASK2;\r\n*p=ln;\r\nif (ln < c1)\r\n{\r\ndo {\r\np++;\r\nlo= *p;\r\nln=(lo+1)&BN_MASK2;\r\n*p=ln;\r\n} while (ln == 0);\r\n}\r\n}\r\n}\r\nvoid bn_mul_low_recursive(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b, int n2,\r\nBN_ULONG *t)\r\n{\r\nint n=n2/2;\r\n#ifdef BN_COUNT\r\nprintf(" bn_mul_low_recursive %d * %d\n",n2,n2);\r\n#endif\r\nbn_mul_recursive(r,a,b,n,&(t[0]));\r\nif (n > BN_MUL_LOW_RECURSIVE_SIZE_NORMAL)\r\n{\r\nbn_mul_low_recursive(&(t[0]),&(a[0]),&(b[n]),n,&(t[n2]));\r\nbn_add_words(&(r[n]),&(r[n]),&(t[0]),n);\r\nbn_mul_low_recursive(&(t[0]),&(a[n]),&(b[0]),n,&(t[n2]));\r\nbn_add_words(&(r[n]),&(r[n]),&(t[0]),n);\r\n}\r\nelse\r\n{\r\nbn_mul_low_normal(&(t[0]),&(a[0]),&(b[n]),n);\r\nbn_mul_low_normal(&(t[n]),&(a[n]),&(b[0]),n);\r\nbn_add_words(&(r[n]),&(r[n]),&(t[0]),n);\r\nbn_add_words(&(r[n]),&(r[n]),&(t[n]),n);\r\n}\r\n}\r\nvoid bn_mul_high(BN_ULONG *r, BN_ULONG *a, BN_ULONG *b, BN_ULONG *l, int n2,\r\nBN_ULONG *t)\r\n{\r\nint j,i,n,c1,c2;\r\nint neg,oneg,zero;\r\nBN_ULONG ll,lc,*lp,*mp;\r\n#ifdef BN_COUNT\r\nprintf(" bn_mul_high %d * %d\n",n2,n2);\r\n#endif\r\nn=(n2+1)/2;\r\nneg=zero=0;\r\nc1=bn_cmp_words(&(a[0]),&(a[n]),n);\r\nc2=bn_cmp_words(&(b[n]),&(b[0]),n);\r\nswitch (c1*3+c2)\r\n{\r\ncase -4:\r\nbn_sub_words(&(r[0]),&(a[n]),&(a[0]),n);\r\nbn_sub_words(&(r[n]),&(b[0]),&(b[n]),n);\r\nbreak;\r\ncase -3:\r\nzero=1;\r\nbreak;\r\ncase -2:\r\nbn_sub_words(&(r[0]),&(a[n]),&(a[0]),n);\r\nbn_sub_words(&(r[n]),&(b[n]),&(b[0]),n);\r\nneg=1;\r\nbreak;\r\ncase -1:\r\ncase 0:\r\ncase 1:\r\nzero=1;\r\nbreak;\r\ncase 2:\r\nbn_sub_words(&(r[0]),&(a[0]),&(a[n]),n);\r\nbn_sub_words(&(r[n]),&(b[0]),&(b[n]),n);\r\nneg=1;\r\nbreak;\r\ncase 3:\r\nzero=1;\r\nbreak;\r\ncase 4:\r\nbn_sub_words(&(r[0]),&(a[0]),&(a[n]),n);\r\nbn_sub_words(&(r[n]),&(b[n]),&(b[0]),n);\r\nbreak;\r\n}\r\noneg=neg;\r\nbn_mul_recursive(&(t[0]),&(r[0]),&(r[n]),n,&(t[n2]));\r\nbn_mul_recursive(r,&(a[n]),&(b[n]),n,&(t[n2]));\r\nif (l != NULL)\r\n{\r\nlp= &(t[n2+n]);\r\nc1=bn_add_words(lp,&(r[0]),&(l[0]),n);\r\n}\r\nelse\r\n{\r\nc1=0;\r\nlp= &(r[0]);\r\n}\r\nif (neg)\r\nneg=bn_sub_words(&(t[n2]),lp,&(t[0]),n);\r\nelse\r\n{\r\nbn_add_words(&(t[n2]),lp,&(t[0]),n);\r\nneg=0;\r\n}\r\nif (l != NULL)\r\n{\r\nbn_sub_words(&(t[n2+n]),&(l[n]),&(t[n2]),n);\r\n}\r\nelse\r\n{\r\nlp= &(t[n2+n]);\r\nmp= &(t[n2]);\r\nfor (i=0; i<n; i++)\r\nlp[i]=((~mp[i])+1)&BN_MASK2;\r\n}\r\nif (l != NULL)\r\n{\r\nlp= &(t[n2]);\r\nc1= bn_add_words(lp,&(t[n2+n]),&(l[0]),n);\r\n}\r\nelse\r\n{\r\nlp= &(t[n2+n]);\r\nc1=0;\r\n}\r\nc1+=bn_add_words(&(t[n2]),lp, &(r[0]),n);\r\nif (oneg)\r\nc1-=bn_sub_words(&(t[n2]),&(t[n2]),&(t[0]),n);\r\nelse\r\nc1+=bn_add_words(&(t[n2]),&(t[n2]),&(t[0]),n);\r\nc2 =bn_add_words(&(r[0]),&(r[0]),&(t[n2+n]),n);\r\nc2+=bn_add_words(&(r[0]),&(r[0]),&(r[n]),n);\r\nif (oneg)\r\nc2-=bn_sub_words(&(r[0]),&(r[0]),&(t[n]),n);\r\nelse\r\nc2+=bn_add_words(&(r[0]),&(r[0]),&(t[n]),n);\r\nif (c1 != 0)\r\n{\r\ni=0;\r\nif (c1 > 0)\r\n{\r\nlc=c1;\r\ndo {\r\nll=(r[i]+lc)&BN_MASK2;\r\nr[i++]=ll;\r\nlc=(lc > ll);\r\n} while (lc);\r\n}\r\nelse\r\n{\r\nlc= -c1;\r\ndo {\r\nll=r[i];\r\nr[i++]=(ll-lc)&BN_MASK2;\r\nlc=(lc > ll);\r\n} while (lc);\r\n}\r\n}\r\nif (c2 != 0)\r\n{\r\ni=n;\r\nif (c2 > 0)\r\n{\r\nlc=c2;\r\ndo {\r\nll=(r[i]+lc)&BN_MASK2;\r\nr[i++]=ll;\r\nlc=(lc > ll);\r\n} while (lc);\r\n}\r\nelse\r\n{\r\nlc= -c2;\r\ndo {\r\nll=r[i];\r\nr[i++]=(ll-lc)&BN_MASK2;\r\nlc=(lc > ll);\r\n} while (lc);\r\n}\r\n}\r\n}

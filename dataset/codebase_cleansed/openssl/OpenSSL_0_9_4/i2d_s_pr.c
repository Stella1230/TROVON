int i2d_DSAPrivateKey(DSA *a, unsigned char **pp)\r\n{\r\nBIGNUM *num[6];\r\nunsigned char data[1];\r\nASN1_INTEGER bs;\r\nunsigned int j,i,tot,t,len,max=0;\r\nunsigned char *p;\r\nif (a == NULL) return(0);\r\nnum[1]=a->p;\r\nnum[2]=a->q;\r\nnum[3]=a->g;\r\nnum[4]=a->pub_key;\r\nnum[5]=a->priv_key;\r\nbs.length=1;\r\nbs.data=data;\r\nbs.type=V_ASN1_INTEGER;\r\ndata[0]=a->version&0x7f;\r\ntot=i2d_ASN1_INTEGER(&(bs),NULL);\r\nfor (i=1; i<6; i++)\r\n{\r\nj=BN_num_bits(num[i]);\r\nlen=((j == 0)?0:((j/8)+1));\r\nif (len > max) max=len;\r\nlen=ASN1_object_size(0,len,\r\n(num[i]->neg)?V_ASN1_NEG_INTEGER:V_ASN1_INTEGER);\r\ntot+=len;\r\n}\r\nt=ASN1_object_size(1,tot,V_ASN1_SEQUENCE);\r\nif (pp == NULL) return(t);\r\np= *pp;\r\nASN1_put_object(&p,1,tot,V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_ASN1_INTEGER(&bs,&p);\r\nbs.data=(unsigned char *)Malloc(max+4);\r\nif (bs.data == NULL)\r\n{\r\nASN1err(ASN1_F_I2D_DSAPRIVATEKEY,ERR_R_MALLOC_FAILURE);\r\nreturn(-1);\r\n}\r\nfor (i=1; i<6; i++)\r\n{\r\nbs.length=BN_bn2bin(num[i],bs.data);\r\ni2d_ASN1_INTEGER(&bs,&p);\r\n}\r\nFree((char *)bs.data);\r\n*pp=p;\r\nreturn(t);\r\n}

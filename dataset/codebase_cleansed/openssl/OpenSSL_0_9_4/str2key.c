void des_string_to_key(const char *str, des_cblock *key)\r\n{\r\ndes_key_schedule ks;\r\nint i,length;\r\nregister unsigned char j;\r\nmemset(key,0,8);\r\nlength=strlen(str);\r\n#ifdef OLD_STR_TO_KEY\r\nfor (i=0; i<length; i++)\r\n(*key)[i%8]^=(str[i]<<1);\r\n#else\r\nfor (i=0; i<length; i++)\r\n{\r\nj=str[i];\r\nif ((i%16) < 8)\r\n(*key)[i%8]^=(j<<1);\r\nelse\r\n{\r\nj=((j<<4)&0xf0)|((j>>4)&0x0f);\r\nj=((j<<2)&0xcc)|((j>>2)&0x33);\r\nj=((j<<1)&0xaa)|((j>>1)&0x55);\r\n(*key)[7-(i%8)]^=j;\r\n}\r\n}\r\n#endif\r\ndes_set_odd_parity(key);\r\ni=des_check_key;\r\ndes_check_key=0;\r\ndes_set_key(key,ks);\r\ndes_check_key=i;\r\ndes_cbc_cksum((unsigned char*)str,key,length,ks,key);\r\nmemset(ks,0,sizeof(ks));\r\ndes_set_odd_parity(key);\r\n}\r\nvoid des_string_to_2keys(const char *str, des_cblock *key1, des_cblock *key2)\r\n{\r\ndes_key_schedule ks;\r\nint i,length;\r\nregister unsigned char j;\r\nmemset(key1,0,8);\r\nmemset(key2,0,8);\r\nlength=strlen(str);\r\n#ifdef OLD_STR_TO_KEY\r\nif (length <= 8)\r\n{\r\nfor (i=0; i<length; i++)\r\n{\r\n(*key2)[i]=(*key1)[i]=(str[i]<<1);\r\n}\r\n}\r\nelse\r\n{\r\nfor (i=0; i<length; i++)\r\n{\r\nif ((i/8)&1)\r\n(*key2)[i%8]^=(str[i]<<1);\r\nelse\r\n(*key1)[i%8]^=(str[i]<<1);\r\n}\r\n}\r\n#else\r\nfor (i=0; i<length; i++)\r\n{\r\nj=str[i];\r\nif ((i%32) < 16)\r\n{\r\nif ((i%16) < 8)\r\n(*key1)[i%8]^=(j<<1);\r\nelse\r\n(*key2)[i%8]^=(j<<1);\r\n}\r\nelse\r\n{\r\nj=((j<<4)&0xf0)|((j>>4)&0x0f);\r\nj=((j<<2)&0xcc)|((j>>2)&0x33);\r\nj=((j<<1)&0xaa)|((j>>1)&0x55);\r\nif ((i%16) < 8)\r\n(*key1)[7-(i%8)]^=j;\r\nelse\r\n(*key2)[7-(i%8)]^=j;\r\n}\r\n}\r\nif (length <= 8) memcpy(key2,key1,8);\r\n#endif\r\ndes_set_odd_parity(key1);\r\ndes_set_odd_parity(key2);\r\ni=des_check_key;\r\ndes_check_key=0;\r\ndes_set_key(key1,ks);\r\ndes_cbc_cksum((unsigned char*)str,key1,length,ks,key1);\r\ndes_set_key(key2,ks);\r\ndes_cbc_cksum((unsigned char*)str,key2,length,ks,key2);\r\ndes_check_key=i;\r\nmemset(ks,0,sizeof(ks));\r\ndes_set_odd_parity(key1);\r\ndes_set_odd_parity(key2);\r\n}

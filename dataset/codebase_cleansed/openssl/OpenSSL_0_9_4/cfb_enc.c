void des_cfb_encrypt(const unsigned char *in, unsigned char *out, int numbits,\r\nlong length, des_key_schedule schedule, des_cblock *ivec, int enc)\r\n{\r\nregister DES_LONG d0,d1,v0,v1,n=(numbits+7)/8;\r\nregister DES_LONG mask0,mask1;\r\nregister unsigned long l=length;\r\nregister int num=numbits;\r\nDES_LONG ti[2];\r\nunsigned char *iv;\r\nif (num > 64) return;\r\nif (num > 32)\r\n{\r\nmask0=0xffffffffL;\r\nif (num == 64)\r\nmask1=mask0;\r\nelse mask1=(1L<<(num-32))-1;\r\n}\r\nelse\r\n{\r\nif (num == 32)\r\nmask0=0xffffffffL;\r\nelse mask0=(1L<<num)-1;\r\nmask1=0x00000000L;\r\n}\r\niv = &(*ivec)[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\nif (enc)\r\n{\r\nwhile (l >= n)\r\n{\r\nl-=n;\r\nti[0]=v0;\r\nti[1]=v1;\r\ndes_encrypt((DES_LONG *)ti,schedule,DES_ENCRYPT);\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nd0=(d0^ti[0])&mask0;\r\nd1=(d1^ti[1])&mask1;\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\nif (num == 32)\r\n{ v0=v1; v1=d0; }\r\nelse if (num == 64)\r\n{ v0=d0; v1=d1; }\r\nelse if (num > 32)\r\n{\r\nv0=((v1>>(num-32))|(d0<<(64-num)))&0xffffffffL;\r\nv1=((d0>>(num-32))|(d1<<(64-num)))&0xffffffffL;\r\n}\r\nelse\r\n{\r\nv0=((v0>>num)|(v1<<(32-num)))&0xffffffffL;\r\nv1=((v1>>num)|(d0<<(32-num)))&0xffffffffL;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nwhile (l >= n)\r\n{\r\nl-=n;\r\nti[0]=v0;\r\nti[1]=v1;\r\ndes_encrypt((DES_LONG *)ti,schedule,DES_ENCRYPT);\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nif (num == 32)\r\n{ v0=v1; v1=d0; }\r\nelse if (num == 64)\r\n{ v0=d0; v1=d1; }\r\nelse if (num > 32)\r\n{\r\nv0=((v1>>(num-32))|(d0<<(64-num)))&0xffffffffL;\r\nv1=((d0>>(num-32))|(d1<<(64-num)))&0xffffffffL;\r\n}\r\nelse\r\n{\r\nv0=((v0>>num)|(v1<<(32-num)))&0xffffffffL;\r\nv1=((v1>>num)|(d0<<(32-num)))&0xffffffffL;\r\n}\r\nd0=(d0^ti[0])&mask0;\r\nd1=(d1^ti[1])&mask1;\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\n}\r\n}\r\niv = &(*ivec)[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nv0=v1=d0=d1=ti[0]=ti[1]=0;\r\n}

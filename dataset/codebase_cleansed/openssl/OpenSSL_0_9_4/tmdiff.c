char *ms_time_new(void)\r\n{\r\nMS_TM *ret;\r\nret=(MS_TM *)Malloc(sizeof(MS_TM));\r\nif (ret == NULL)\r\nreturn(NULL);\r\nmemset(ret,0,sizeof(MS_TM));\r\n#ifdef WIN32\r\nret->thread_id=GetCurrentThread();\r\n#endif\r\nreturn((char *)ret);\r\n}\r\nvoid ms_time_free(char *a)\r\n{\r\nif (a != NULL)\r\nFree(a);\r\n}\r\nvoid ms_time_get(char *a)\r\n{\r\nMS_TM *tm=(MS_TM *)a;\r\n#ifdef WIN32\r\nFILETIME tmpa,tmpb,tmpc;\r\n#endif\r\n#ifdef TIMES\r\ntimes(&tm->ms_tms);\r\n#else\r\n# ifdef WIN32\r\nGetThreadTimes(tm->thread_id,&tmpa,&tmpb,&tmpc,&(tm->ms_win32));\r\n# else\r\nftime(&tm->ms_timeb);\r\n# endif\r\n#endif\r\n}\r\ndouble ms_time_diff(char *ap, char *bp)\r\n{\r\nMS_TM *a=(MS_TM *)ap;\r\nMS_TM *b=(MS_TM *)bp;\r\ndouble ret;\r\n#ifdef TIMES\r\nret=(b->ms_tms.tms_utime-a->ms_tms.tms_utime)/HZ;\r\n#else\r\n# ifdef WIN32\r\n{\r\n#ifdef __GNUC__\r\nsigned long long la,lb;\r\n#else\r\nsigned _int64 la,lb;\r\n#endif\r\nla=a->ms_win32.dwHighDateTime;\r\nlb=b->ms_win32.dwHighDateTime;\r\nla<<=32;\r\nlb<<=32;\r\nla+=a->ms_win32.dwLowDateTime;\r\nlb+=b->ms_win32.dwLowDateTime;\r\nret=((double)(lb-la))/1e7;\r\n}\r\n# else\r\nret= (double)(b->ms_timeb.time-a->ms_timeb.time)+\r\n(((double)b->ms_timeb.millitm)-\r\n((double)a->ms_timeb.millitm))/1000.0;\r\n# endif\r\n#endif\r\nreturn((ret < 0.0000001)?0.0000001:ret);\r\n}\r\nint ms_time_cmp(char *ap, char *bp)\r\n{\r\nMS_TM *a=(MS_TM *)ap,*b=(MS_TM *)bp;\r\ndouble d;\r\nint ret;\r\n#ifdef TIMES\r\nd=(b->ms_tms.tms_utime-a->ms_tms.tms_utime)/HZ;\r\n#else\r\n# ifdef WIN32\r\nd =(b->ms_win32.dwHighDateTime&0x000fffff)*10+b->ms_win32.dwLowDateTime/1e7;\r\nd-=(a->ms_win32.dwHighDateTime&0x000fffff)*10+a->ms_win32.dwLowDateTime/1e7;\r\n# else\r\nd= (double)(b->ms_timeb.time-a->ms_timeb.time)+\r\n(((double)b->ms_timeb.millitm)-(double)a->ms_timeb.millitm)/1000.0;\r\n# endif\r\n#endif\r\nif (d == 0.0)\r\nret=0;\r\nelse if (d < 0)\r\nret= -1;\r\nelse\r\nret=1;\r\nreturn(ret);\r\n}

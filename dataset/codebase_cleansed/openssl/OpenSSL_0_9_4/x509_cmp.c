int X509_issuer_and_serial_cmp(X509 *a, X509 *b)\r\n{\r\nint i;\r\nX509_CINF *ai,*bi;\r\nai=a->cert_info;\r\nbi=b->cert_info;\r\ni=ASN1_INTEGER_cmp(ai->serialNumber,bi->serialNumber);\r\nif (i) return(i);\r\nreturn(X509_NAME_cmp(ai->issuer,bi->issuer));\r\n}\r\nunsigned long X509_issuer_and_serial_hash(X509 *a)\r\n{\r\nunsigned long ret=0;\r\nMD5_CTX ctx;\r\nunsigned char md[16];\r\nchar str[256];\r\nX509_NAME_oneline(a->cert_info->issuer,str,256);\r\nret=strlen(str);\r\nMD5_Init(&ctx);\r\nMD5_Update(&ctx,(unsigned char *)str,ret);\r\nMD5_Update(&ctx,(unsigned char *)a->cert_info->serialNumber->data,\r\n(unsigned long)a->cert_info->serialNumber->length);\r\nMD5_Final(&(md[0]),&ctx);\r\nret=( ((unsigned long)md[0] )|((unsigned long)md[1]<<8L)|\r\n((unsigned long)md[2]<<16L)|((unsigned long)md[3]<<24L)\r\n)&0xffffffffL;\r\nreturn(ret);\r\n}\r\nint X509_issuer_name_cmp(X509 *a, X509 *b)\r\n{\r\nreturn(X509_NAME_cmp(a->cert_info->issuer,b->cert_info->issuer));\r\n}\r\nint X509_subject_name_cmp(X509 *a, X509 *b)\r\n{\r\nreturn(X509_NAME_cmp(a->cert_info->subject,b->cert_info->subject));\r\n}\r\nint X509_CRL_cmp(X509_CRL *a, X509_CRL *b)\r\n{\r\nreturn(X509_NAME_cmp(a->crl->issuer,b->crl->issuer));\r\n}\r\nX509_NAME *X509_get_issuer_name(X509 *a)\r\n{\r\nreturn(a->cert_info->issuer);\r\n}\r\nunsigned long X509_issuer_name_hash(X509 *x)\r\n{\r\nreturn(X509_NAME_hash(x->cert_info->issuer));\r\n}\r\nX509_NAME *X509_get_subject_name(X509 *a)\r\n{\r\nreturn(a->cert_info->subject);\r\n}\r\nASN1_INTEGER *X509_get_serialNumber(X509 *a)\r\n{\r\nreturn(a->cert_info->serialNumber);\r\n}\r\nunsigned long X509_subject_name_hash(X509 *x)\r\n{\r\nreturn(X509_NAME_hash(x->cert_info->subject));\r\n}\r\nint X509_NAME_cmp(X509_NAME *a, X509_NAME *b)\r\n{\r\nint i,j;\r\nX509_NAME_ENTRY *na,*nb;\r\nif (sk_X509_NAME_ENTRY_num(a->entries)\r\n!= sk_X509_NAME_ENTRY_num(b->entries))\r\nreturn sk_X509_NAME_ENTRY_num(a->entries)\r\n-sk_X509_NAME_ENTRY_num(b->entries);\r\nfor (i=sk_X509_NAME_ENTRY_num(a->entries)-1; i>=0; i--)\r\n{\r\nna=sk_X509_NAME_ENTRY_value(a->entries,i);\r\nnb=sk_X509_NAME_ENTRY_value(b->entries,i);\r\nj=na->value->length-nb->value->length;\r\nif (j) return(j);\r\nj=memcmp(na->value->data,nb->value->data,\r\nna->value->length);\r\nif (j) return(j);\r\nj=na->set-nb->set;\r\nif (j) return(j);\r\n}\r\nfor (i=sk_X509_NAME_ENTRY_num(a->entries)-1; i>=0; i--)\r\n{\r\nna=sk_X509_NAME_ENTRY_value(a->entries,i);\r\nnb=sk_X509_NAME_ENTRY_value(b->entries,i);\r\nj=OBJ_cmp(na->object,nb->object);\r\nif (j) return(j);\r\n}\r\nreturn(0);\r\n}\r\nunsigned long X509_NAME_hash(X509_NAME *x)\r\n{\r\nunsigned long ret=0;\r\nunsigned char md[16];\r\nunsigned char str[256],*p,*pp;\r\nint i;\r\ni=i2d_X509_NAME(x,NULL);\r\nif (i > sizeof(str))\r\np=Malloc(i);\r\nelse\r\np=str;\r\npp=p;\r\ni2d_X509_NAME(x,&pp);\r\nMD5((unsigned char *)p,i,&(md[0]));\r\nif (p != str) Free(p);\r\nret=( ((unsigned long)md[0] )|((unsigned long)md[1]<<8L)|\r\n((unsigned long)md[2]<<16L)|((unsigned long)md[3]<<24L)\r\n)&0xffffffffL;\r\nreturn(ret);\r\n}\r\nEVP_PKEY *X509_get_pubkey(X509 *x)\r\n{\r\nif ((x == NULL) || (x->cert_info == NULL))\r\nreturn(NULL);\r\nreturn(X509_PUBKEY_get(x->cert_info->key));\r\n}\r\nint X509_check_private_key(X509 *x, EVP_PKEY *k)\r\n{\r\nEVP_PKEY *xk=NULL;\r\nint ok=0;\r\nxk=X509_get_pubkey(x);\r\nif (xk->type != k->type)\r\n{\r\nX509err(X509_F_X509_CHECK_PRIVATE_KEY,X509_R_KEY_TYPE_MISMATCH);\r\ngoto err;\r\n}\r\nswitch (k->type)\r\n{\r\n#ifndef NO_RSA\r\ncase EVP_PKEY_RSA:\r\nif (BN_cmp(xk->pkey.rsa->n,k->pkey.rsa->n) != 0\r\n|| BN_cmp(xk->pkey.rsa->e,k->pkey.rsa->e) != 0)\r\n{\r\nX509err(X509_F_X509_CHECK_PRIVATE_KEY,X509_R_KEY_VALUES_MISMATCH);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\n#ifndef NO_DSA\r\ncase EVP_PKEY_DSA:\r\nif (BN_cmp(xk->pkey.dsa->pub_key,k->pkey.dsa->pub_key) != 0)\r\n{\r\nX509err(X509_F_X509_CHECK_PRIVATE_KEY,X509_R_KEY_VALUES_MISMATCH);\r\ngoto err;\r\n}\r\nbreak;\r\n#endif\r\n#ifndef NO_DH\r\ncase EVP_PKEY_DH:\r\nX509err(X509_F_X509_CHECK_PRIVATE_KEY,X509_R_CANT_CHECK_DH_KEY);\r\ngoto err;\r\n#endif\r\ndefault:\r\nX509err(X509_F_X509_CHECK_PRIVATE_KEY,X509_R_UNKNOWN_KEY_TYPE);\r\ngoto err;\r\n}\r\nok=1;\r\nerr:\r\nEVP_PKEY_free(xk);\r\nreturn(ok);\r\n}

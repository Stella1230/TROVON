int X509_NAME_get_text_by_NID(X509_NAME *name, int nid, char *buf, int len)\r\n{\r\nASN1_OBJECT *obj;\r\nobj=OBJ_nid2obj(nid);\r\nif (obj == NULL) return(-1);\r\nreturn(X509_NAME_get_text_by_OBJ(name,obj,buf,len));\r\n}\r\nint X509_NAME_get_text_by_OBJ(X509_NAME *name, ASN1_OBJECT *obj, char *buf,\r\nint len)\r\n{\r\nint i;\r\nASN1_STRING *data;\r\ni=X509_NAME_get_index_by_OBJ(name,obj,-1);\r\nif (i < 0) return(-1);\r\ndata=X509_NAME_ENTRY_get_data(X509_NAME_get_entry(name,i));\r\ni=(data->length > (len-1))?(len-1):data->length;\r\nif (buf == NULL) return(data->length);\r\nmemcpy(buf,data->data,i);\r\nbuf[i]='\0';\r\nreturn(i);\r\n}\r\nint X509_NAME_entry_count(X509_NAME *name)\r\n{\r\nif (name == NULL) return(0);\r\nreturn(sk_X509_NAME_ENTRY_num(name->entries));\r\n}\r\nint X509_NAME_get_index_by_NID(X509_NAME *name, int nid, int lastpos)\r\n{\r\nASN1_OBJECT *obj;\r\nobj=OBJ_nid2obj(nid);\r\nif (obj == NULL) return(-2);\r\nreturn(X509_NAME_get_index_by_OBJ(name,obj,lastpos));\r\n}\r\nint X509_NAME_get_index_by_OBJ(X509_NAME *name, ASN1_OBJECT *obj,\r\nint lastpos)\r\n{\r\nint n;\r\nX509_NAME_ENTRY *ne;\r\nSTACK_OF(X509_NAME_ENTRY) *sk;\r\nif (name == NULL) return(-1);\r\nif (lastpos < 0)\r\nlastpos= -1;\r\nsk=name->entries;\r\nn=sk_X509_NAME_ENTRY_num(sk);\r\nfor (lastpos++; lastpos < n; lastpos++)\r\n{\r\nne=sk_X509_NAME_ENTRY_value(sk,lastpos);\r\nif (OBJ_cmp(ne->object,obj) == 0)\r\nreturn(lastpos);\r\n}\r\nreturn(-1);\r\n}\r\nX509_NAME_ENTRY *X509_NAME_get_entry(X509_NAME *name, int loc)\r\n{\r\nif(name == NULL || sk_X509_NAME_ENTRY_num(name->entries) <= loc\r\n|| loc < 0)\r\nreturn(NULL);\r\nelse\r\nreturn(sk_X509_NAME_ENTRY_value(name->entries,loc));\r\n}\r\nX509_NAME_ENTRY *X509_NAME_delete_entry(X509_NAME *name, int loc)\r\n{\r\nX509_NAME_ENTRY *ret;\r\nint i,n,set_prev,set_next;\r\nSTACK_OF(X509_NAME_ENTRY) *sk;\r\nif (name == NULL || sk_X509_NAME_ENTRY_num(name->entries) <= loc\r\n|| loc < 0)\r\nreturn(NULL);\r\nsk=name->entries;\r\nret=sk_X509_NAME_ENTRY_delete(sk,loc);\r\nn=sk_X509_NAME_ENTRY_num(sk);\r\nname->modified=1;\r\nif (loc == n) return(ret);\r\nif (loc != 0)\r\nset_prev=(sk_X509_NAME_ENTRY_value(sk,loc-1))->set;\r\nelse\r\nset_prev=ret->set-1;\r\nset_next=sk_X509_NAME_ENTRY_value(sk,loc)->set;\r\nif (set_prev+1 < set_next)\r\nfor (i=loc; i<n; i++)\r\nsk_X509_NAME_ENTRY_value(sk,i)->set--;\r\nreturn(ret);\r\n}\r\nint X509_NAME_add_entry(X509_NAME *name, X509_NAME_ENTRY *ne, int loc,\r\nint set)\r\n{\r\nX509_NAME_ENTRY *new_name=NULL;\r\nint n,i,inc;\r\nSTACK_OF(X509_NAME_ENTRY) *sk;\r\nif (name == NULL) return(0);\r\nsk=name->entries;\r\nn=sk_X509_NAME_ENTRY_num(sk);\r\nif (loc > n) loc=n;\r\nelse if (loc < 0) loc=n;\r\nname->modified=1;\r\nif (set == -1)\r\n{\r\nif (loc == 0)\r\n{\r\nset=0;\r\ninc=1;\r\n}\r\nelse\r\n{\r\nset=sk_X509_NAME_ENTRY_value(sk,loc-1)->set;\r\ninc=0;\r\n}\r\n}\r\nelse\r\n{\r\nif (loc >= n)\r\n{\r\nif (loc != 0)\r\nset=sk_X509_NAME_ENTRY_value(sk,loc-1)->set+1;\r\nelse\r\nset=0;\r\n}\r\nelse\r\nset=sk_X509_NAME_ENTRY_value(sk,loc)->set;\r\ninc=(set == 0)?1:0;\r\n}\r\nif ((new_name=X509_NAME_ENTRY_dup(ne)) == NULL)\r\ngoto err;\r\nnew_name->set=set;\r\nif (!sk_X509_NAME_ENTRY_insert(sk,new_name,loc))\r\n{\r\nX509err(X509_F_X509_NAME_ADD_ENTRY,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif (inc)\r\n{\r\nn=sk_X509_NAME_ENTRY_num(sk);\r\nfor (i=loc+1; i<n; i++)\r\nsk_X509_NAME_ENTRY_value(sk,i-1)->set+=1;\r\n}\r\nreturn(1);\r\nerr:\r\nif (new_name != NULL)\r\nX509_NAME_ENTRY_free(new_name);\r\nreturn(0);\r\n}\r\nX509_NAME_ENTRY *X509_NAME_ENTRY_create_by_NID(X509_NAME_ENTRY **ne, int nid,\r\nint type, unsigned char *bytes, int len)\r\n{\r\nASN1_OBJECT *obj;\r\nobj=OBJ_nid2obj(nid);\r\nif (obj == NULL)\r\n{\r\nX509err(X509_F_X509_NAME_ENTRY_CREATE_BY_NID,X509_R_UNKNOWN_NID);\r\nreturn(NULL);\r\n}\r\nreturn(X509_NAME_ENTRY_create_by_OBJ(ne,obj,type,bytes,len));\r\n}\r\nX509_NAME_ENTRY *X509_NAME_ENTRY_create_by_OBJ(X509_NAME_ENTRY **ne,\r\nASN1_OBJECT *obj, int type, unsigned char *bytes, int len)\r\n{\r\nX509_NAME_ENTRY *ret;\r\nif ((ne == NULL) || (*ne == NULL))\r\n{\r\nif ((ret=X509_NAME_ENTRY_new()) == NULL)\r\nreturn(NULL);\r\n}\r\nelse\r\nret= *ne;\r\nif (!X509_NAME_ENTRY_set_object(ret,obj))\r\ngoto err;\r\nif (!X509_NAME_ENTRY_set_data(ret,type,bytes,len))\r\ngoto err;\r\nif ((ne != NULL) && (*ne == NULL)) *ne=ret;\r\nreturn(ret);\r\nerr:\r\nif ((ne == NULL) || (ret != *ne))\r\nX509_NAME_ENTRY_free(ret);\r\nreturn(NULL);\r\n}\r\nint X509_NAME_ENTRY_set_object(X509_NAME_ENTRY *ne, ASN1_OBJECT *obj)\r\n{\r\nif ((ne == NULL) || (obj == NULL))\r\n{\r\nX509err(X509_F_X509_NAME_ENTRY_SET_OBJECT,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn(0);\r\n}\r\nASN1_OBJECT_free(ne->object);\r\nne->object=OBJ_dup(obj);\r\nreturn((ne->object == NULL)?0:1);\r\n}\r\nint X509_NAME_ENTRY_set_data(X509_NAME_ENTRY *ne, int type,\r\nunsigned char *bytes, int len)\r\n{\r\nint i;\r\nif ((ne == NULL) || ((bytes == NULL) && (len != 0))) return(0);\r\nif (len < 0) len=strlen((char *)bytes);\r\ni=ASN1_STRING_set(ne->value,bytes,len);\r\nif (!i) return(0);\r\nif (type != V_ASN1_UNDEF)\r\n{\r\nif (type == V_ASN1_APP_CHOOSE)\r\nne->value->type=ASN1_PRINTABLE_type(bytes,len);\r\nelse\r\nne->value->type=type;\r\n}\r\nreturn(1);\r\n}\r\nASN1_OBJECT *X509_NAME_ENTRY_get_object(X509_NAME_ENTRY *ne)\r\n{\r\nif (ne == NULL) return(NULL);\r\nreturn(ne->object);\r\n}\r\nASN1_STRING *X509_NAME_ENTRY_get_data(X509_NAME_ENTRY *ne)\r\n{\r\nif (ne == NULL) return(NULL);\r\nreturn(ne->value);\r\n}

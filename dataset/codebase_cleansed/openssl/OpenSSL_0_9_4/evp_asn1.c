int ASN1_TYPE_set_octetstring(ASN1_TYPE *a, unsigned char *data, int len)\r\n{\r\nASN1_STRING *os;\r\nif ((os=ASN1_OCTET_STRING_new()) == NULL) return(0);\r\nif (!ASN1_OCTET_STRING_set(os,data,len)) return(0);\r\nASN1_TYPE_set(a,V_ASN1_OCTET_STRING,os);\r\nreturn(1);\r\n}\r\nint ASN1_TYPE_get_octetstring(ASN1_TYPE *a, unsigned char *data,\r\nint max_len)\r\n{\r\nint ret,num;\r\nunsigned char *p;\r\nif ((a->type != V_ASN1_OCTET_STRING) || (a->value.octet_string == NULL))\r\n{\r\nASN1err(ASN1_F_ASN1_TYPE_GET_OCTETSTRING,ASN1_R_DATA_IS_WRONG);\r\nreturn(-1);\r\n}\r\np=ASN1_STRING_data(a->value.octet_string);\r\nret=ASN1_STRING_length(a->value.octet_string);\r\nif (ret < max_len)\r\nnum=ret;\r\nelse\r\nnum=max_len;\r\nmemcpy(data,p,num);\r\nreturn(ret);\r\n}\r\nint ASN1_TYPE_set_int_octetstring(ASN1_TYPE *a, long num, unsigned char *data,\r\nint len)\r\n{\r\nint n,size;\r\nASN1_OCTET_STRING os,*osp;\r\nASN1_INTEGER in;\r\nunsigned char *p;\r\nunsigned char buf[32];\r\nin.data=buf;\r\nin.length=32;\r\nos.data=data;\r\nos.type=V_ASN1_OCTET_STRING;\r\nos.length=len;\r\nASN1_INTEGER_set(&in,num);\r\nn = i2d_ASN1_INTEGER(&in,NULL);\r\nn+=M_i2d_ASN1_OCTET_STRING(&os,NULL);\r\nsize=ASN1_object_size(1,n,V_ASN1_SEQUENCE);\r\nif ((osp=ASN1_STRING_new()) == NULL) return(0);\r\nASN1_STRING_set(osp,NULL,size);\r\nASN1_STRING_length(osp)=size;\r\np=ASN1_STRING_data(osp);\r\nASN1_put_object(&p,1,n,V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_ASN1_INTEGER(&in,&p);\r\nM_i2d_ASN1_OCTET_STRING(&os,&p);\r\nASN1_TYPE_set(a,V_ASN1_SEQUENCE,osp);\r\nreturn(1);\r\n}\r\nint ASN1_TYPE_get_int_octetstring(ASN1_TYPE *a, long *num, unsigned char *data,\r\nint max_len)\r\n{\r\nint ret= -1,n;\r\nASN1_INTEGER *ai=NULL;\r\nASN1_OCTET_STRING *os=NULL;\r\nunsigned char *p;\r\nlong length;\r\nASN1_CTX c;\r\nif ((a->type != V_ASN1_SEQUENCE) || (a->value.sequence == NULL))\r\n{\r\ngoto err;\r\n}\r\np=ASN1_STRING_data(a->value.sequence);\r\nlength=ASN1_STRING_length(a->value.sequence);\r\nc.pp= &p;\r\nc.p=p;\r\nc.max=p+length;\r\nc.error=ASN1_R_DATA_IS_WRONG;\r\nM_ASN1_D2I_start_sequence();\r\nc.q=c.p;\r\nif ((ai=d2i_ASN1_INTEGER(NULL,&c.p,c.slen)) == NULL) goto err;\r\nc.slen-=(c.p-c.q);\r\nc.q=c.p;\r\nif ((os=d2i_ASN1_OCTET_STRING(NULL,&c.p,c.slen)) == NULL) goto err;\r\nc.slen-=(c.p-c.q);\r\nif (!M_ASN1_D2I_end_sequence()) goto err;\r\nif (num != NULL)\r\n*num=ASN1_INTEGER_get(ai);\r\nret=ASN1_STRING_length(os);\r\nif (max_len > ret)\r\nn=ret;\r\nelse\r\nn=max_len;\r\nif (data != NULL)\r\nmemcpy(data,ASN1_STRING_data(os),n);\r\nif (0)\r\n{\r\nerr:\r\nASN1err(ASN1_F_ASN1_TYPE_GET_INT_OCTETSTRING,ASN1_R_DATA_IS_WRONG);\r\n}\r\nif (os != NULL) ASN1_OCTET_STRING_free(os);\r\nif (ai != NULL) ASN1_INTEGER_free(ai);\r\nreturn(ret);\r\n}

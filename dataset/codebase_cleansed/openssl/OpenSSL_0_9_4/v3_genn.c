int i2d_GENERAL_NAME(GENERAL_NAME *a, unsigned char **pp)\r\n{\r\nunsigned char *p;\r\nint ret;\r\nret = 0;\r\nif(pp) p = *pp;\r\nelse p = NULL;\r\nif(a->type == GEN_DIRNAME) {\r\nint v = 0;\r\nM_ASN1_I2D_len_EXP_opt(a->d.dirn, i2d_X509_NAME, 4, v);\r\nif(!p) return ret;\r\nM_ASN1_I2D_put_EXP_opt(a->d.dirn, i2d_X509_NAME, 4, v);\r\n*pp = p;\r\nreturn ret;\r\n}\r\nswitch(a->type) {\r\ncase GEN_OTHERNAME:\r\ncase GEN_X400:\r\ncase GEN_EDIPARTY:\r\nret = i2d_ASN1_TYPE(a->d.other, pp);\r\nbreak;\r\ncase GEN_EMAIL:\r\ncase GEN_DNS:\r\ncase GEN_URI:\r\nret = i2d_ASN1_IA5STRING(a->d.ia5, pp);\r\nbreak;\r\ncase GEN_IPADD:\r\nret = i2d_ASN1_OCTET_STRING(a->d.ip, pp);\r\nbreak;\r\ncase GEN_RID:\r\nret = i2d_ASN1_OBJECT(a->d.rid, pp);\r\nbreak;\r\n}\r\nif(p) *p = (*p & V_ASN1_CONSTRUCTED) | a->type;\r\nreturn ret;\r\n}\r\nGENERAL_NAME *GENERAL_NAME_new()\r\n{\r\nGENERAL_NAME *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret, GENERAL_NAME);\r\nret->type = -1;\r\nret->d.ptr = NULL;\r\nreturn (ret);\r\nM_ASN1_New_Error(ASN1_F_GENERAL_NAME_NEW);\r\n}\r\nGENERAL_NAME *d2i_GENERAL_NAME(GENERAL_NAME **a, unsigned char **pp,\r\nlong length)\r\n{\r\nunsigned char _tmp;\r\nM_ASN1_D2I_vars(a,GENERAL_NAME *,GENERAL_NAME_new);\r\nM_ASN1_D2I_Init();\r\nc.slen = length;\r\n_tmp = M_ASN1_next;\r\nret->type = _tmp & ~V_ASN1_CONSTRUCTED;\r\nswitch(ret->type) {\r\ncase GEN_OTHERNAME:\r\ncase GEN_X400:\r\ncase GEN_EDIPARTY:\r\nM_ASN1_D2I_get_imp(ret->d.other, d2i_ASN1_TYPE,V_ASN1_SEQUENCE);\r\nbreak;\r\ncase GEN_EMAIL:\r\ncase GEN_DNS:\r\ncase GEN_URI:\r\nM_ASN1_D2I_get_imp(ret->d.ia5, d2i_ASN1_IA5STRING,\r\nV_ASN1_IA5STRING);\r\nbreak;\r\ncase GEN_DIRNAME:\r\nM_ASN1_D2I_get_EXP_opt(ret->d.dirn, d2i_X509_NAME, 4);\r\nbreak;\r\ncase GEN_IPADD:\r\nM_ASN1_D2I_get_imp(ret->d.ip, d2i_ASN1_OCTET_STRING,\r\nV_ASN1_OCTET_STRING);\r\nbreak;\r\ncase GEN_RID:\r\nM_ASN1_D2I_get_imp(ret->d.rid, d2i_ASN1_OBJECT,V_ASN1_OBJECT);\r\nbreak;\r\ndefault:\r\nc.error = ASN1_R_BAD_TAG;\r\ngoto err;\r\n}\r\nc.slen = 0;\r\nM_ASN1_D2I_Finish(a, GENERAL_NAME_free, ASN1_F_D2I_GENERAL_NAME);\r\n}\r\nvoid GENERAL_NAME_free(GENERAL_NAME *a)\r\n{\r\nif (a == NULL) return;\r\nswitch(a->type) {\r\ncase GEN_OTHERNAME:\r\ncase GEN_X400:\r\ncase GEN_EDIPARTY:\r\nASN1_TYPE_free(a->d.other);\r\nbreak;\r\ncase GEN_EMAIL:\r\ncase GEN_DNS:\r\ncase GEN_URI:\r\nASN1_IA5STRING_free(a->d.ia5);\r\nbreak;\r\ncase GEN_DIRNAME:\r\nX509_NAME_free(a->d.dirn);\r\nbreak;\r\ncase GEN_IPADD:\r\nASN1_OCTET_STRING_free(a->d.ip);\r\nbreak;\r\ncase GEN_RID:\r\nASN1_OBJECT_free(a->d.rid);\r\nbreak;\r\n}\r\nFree ((char *)a);\r\n}

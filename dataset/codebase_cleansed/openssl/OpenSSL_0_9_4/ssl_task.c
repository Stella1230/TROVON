static int get ( io_channel chan, char *buffer, int maxlen, int *length )\r\n{\r\nint status;\r\nstruct io_status iosb;\r\nstatus = SYS$QIOW ( 0, chan, IO$_READVBLK, &iosb, 0, 0,\r\nbuffer, maxlen, 0, 0, 0, 0 );\r\nif ( (status&1) == 1 ) status = iosb.status;\r\nif ( (status&1) == 1 ) *length = iosb.count;\r\nreturn status;\r\n}\r\nstatic int put ( io_channel chan, char *buffer, int length )\r\n{\r\nint status;\r\nstruct io_status iosb;\r\nstatus = SYS$QIOW ( 0, chan, IO$_WRITEVBLK, &iosb, 0, 0,\r\nbuffer, length, 0, 0, 0, 0 );\r\nif ( (status&1) == 1 ) status = iosb.status;\r\nreturn status;\r\n}\r\nstatic int general_request ( io_channel chan, struct rpc_msg *msg, int length )\r\n{\r\nreturn 48;\r\n}\r\nint main ( int argc, char **argv )\r\n{\r\nint status, length;\r\nio_channel chan;\r\nstruct rpc_msg msg;\r\nchar *CApath=NULL,*CAfile=NULL;\r\nint badop=0;\r\nint ret=1;\r\nint client_auth=0;\r\nint server_auth=0;\r\nSSL_CTX *s_ctx=NULL;\r\nLIB$INIT_TIMER();\r\nstatus = SYS$ASSIGN ( &sysnet, &chan, 0, 0, 0 );\r\nprintf("status of assign to SYS$NET: %d\n", status );\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE);\r\nif (bio_stdout == NULL)\r\nif ((bio_stdout=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_stdout,stdout,BIO_NOCLOSE);\r\nif (cipher == NULL) cipher=getenv("SSL_CIPHER");\r\nprintf("cipher list: %s\n", cipher ? cipher : "{undefined}" );\r\nSSL_load_error_strings();\r\nSSLeay_add_all_algorithms();\r\ns_ctx=SSL_CTX_new(SSLv2_server_method());\r\nif (s_ctx == NULL) goto end;\r\nSSL_CTX_use_certificate_file(s_ctx,TEST_SERVER_CERT,SSL_FILETYPE_PEM);\r\nSSL_CTX_use_RSAPrivateKey_file(s_ctx,TEST_SERVER_CERT,SSL_FILETYPE_PEM);\r\nprintf("Loaded server certificate: '%s'\n", TEST_SERVER_CERT );\r\nLIB$SHOW_TIMER();\r\nstatus = doit ( chan, s_ctx );\r\nLIB$SHOW_TIMER();\r\nend:\r\nif (s_ctx != NULL) SSL_CTX_free(s_ctx);\r\nLIB$SHOW_TIMER();\r\nreturn 1;\r\n}\r\nint doit(io_channel chan, SSL_CTX *s_ctx )\r\n{\r\nint status, length, link_state;\r\nstruct rpc_msg msg;\r\nstatic char cbuf[200],sbuf[200];\r\nSSL *s_ssl=NULL;\r\nBIO *c_to_s=NULL;\r\nBIO *s_to_c=NULL;\r\nBIO *c_bio=NULL;\r\nBIO *s_bio=NULL;\r\nint i;\r\nint done=0;\r\ns_ssl=SSL_new(s_ctx);\r\nif (s_ssl == NULL) goto err;\r\nc_to_s=BIO_new(BIO_s_rtcp());\r\ns_to_c=BIO_new(BIO_s_rtcp());\r\nif ((s_to_c == NULL) || (c_to_s == NULL)) goto err;\r\nBIO_set_fd ( c_to_s, 0, chan );\r\nBIO_set_fd ( s_to_c, 0, chan );\r\nc_bio=BIO_new(BIO_f_ssl());\r\ns_bio=BIO_new(BIO_f_ssl());\r\nif ((c_bio == NULL) || (s_bio == NULL)) goto err;\r\nSSL_set_accept_state(s_ssl);\r\nSSL_set_bio(s_ssl,c_to_s,s_to_c);\r\nBIO_set_ssl(s_bio,s_ssl,BIO_CLOSE);\r\nprintf("Begin doit main loop\n");\r\nfor (link_state = 0; link_state < 3; ) {\r\nwhile ( link_state == 0 ) {\r\nstatus = get ( chan, (char *) &msg, sizeof(msg), &length );\r\nif ( (status&1) == 0 ) {\r\nprintf("Error in main loop get: %d\n", status );\r\nlink_state = 3;\r\nbreak;\r\n}\r\nif ( length < RPC_HDR_SIZE ) {\r\nprintf("Error in main loop get size: %d\n", length );\r\nbreak;\r\nlink_state = 3;\r\n}\r\nif ( msg.channel != 'A' ) {\r\nprintf("Error in main loop, unexpected channel: %c\n",\r\nmsg.channel );\r\nbreak;\r\nlink_state = 3;\r\n}\r\nif ( msg.function == 'G' ) {\r\nlink_state = 1;\r\n} else if ( msg.function == 'P' ) {\r\nlink_state = 2;\r\n} else if ( msg.function == 'X' ) {\r\nlink_state = 3;\r\n} else {\r\nlink_state = 3;\r\n}\r\n}\r\nif ( link_state == 1 ) {\r\ni = BIO_read ( s_bio, msg.data, msg.length );\r\nif ( i < 0 ) link_state = 3;\r\nelse {\r\nmsg.channel = 'A';\r\nmsg.function = 'C';\r\nmsg.length = i;\r\nstatus = put ( chan, (char *) &msg, i+RPC_HDR_SIZE );\r\nif ( (status&1) == 0 ) break;\r\nlink_state = 0;\r\n}\r\n} else if ( link_state == 2 ) {\r\ni = BIO_write ( s_bio, msg.data, msg.length );\r\nif ( i < 0 ) link_state = 3;\r\nelse {\r\nmsg.channel = 'A';\r\nmsg.function = 'C';\r\nmsg.length = 0;\r\nstatus = put ( chan, (char *) &msg, RPC_HDR_SIZE );\r\nif ( (status&1) == 0 ) break;\r\nlink_state = 0;\r\n}\r\n}\r\n}\r\nfprintf(stdout,"DONE\n");\r\nerr:\r\ns_ssl->rbio=NULL;\r\ns_ssl->wbio=NULL;\r\nif (c_to_s != NULL) BIO_free(c_to_s);\r\nif (s_to_c != NULL) BIO_free(s_to_c);\r\nif (c_bio != NULL) BIO_free(c_bio);\r\nif (s_bio != NULL) BIO_free(s_bio);\r\nreturn(0);\r\n}

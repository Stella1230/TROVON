int BN_mul_low(BIGNUM *r, BIGNUM *a, BIGNUM *b, int num)\r\n{\r\nBN_ULONG *ap,*bp,*rp;\r\nBIGNUM *sk;\r\nint j,i,n,ret;\r\nint max,al,bl;\r\nBN_CTX ctx;\r\nbn_check_top(a);\r\nbn_check_top(b);\r\n#ifdef BN_MUL_DEBUG\r\nprintf("BN_mul_low(%d,%d,%d)\n",a->top,b->top,num);\r\n#endif\r\nal=a->top;\r\nbl=b->top;\r\nif ((al == 0) || (bl == 0))\r\n{\r\nr->top=0;\r\nreturn(1);\r\n}\r\nif ((bn_limit_bits_low > 0) && (num > bn_limit_num_low))\r\n{\r\nn=BN_num_bits_word(num*2)-bn_limit_bits_low;\r\nn*=2;\r\nsk=(BIGNUM *)Malloc(sizeof(BIGNUM)*n);\r\nmemset(sk,0,sizeof(BIGNUM)*n);\r\nmemset(&ctx,0,sizeof(ctx));\r\nret=bn_mm_low(r,a,b,num,&(sk[0]),&ctx);\r\nfor (i=0; i<n; i+=2)\r\n{\r\nBN_clear_free(&sk[i]);\r\nBN_clear_free(&sk[i+1]);\r\n}\r\nFree(sk);\r\nreturn(ret);\r\n}\r\nmax=(al+bl);\r\nif (bn_wexpand(r,max) == NULL) return(0);\r\nr->neg=a->neg^b->neg;\r\nap=a->d;\r\nbp=b->d;\r\nrp=r->d;\r\nr->top=(max > num)?num:max;\r\nrp[al]=bn_mul_words(rp,ap,al,*(bp++));\r\nrp++;\r\nj=bl;\r\nfor (i=1; i<j; i++)\r\n{\r\nif (al >= num--)\r\n{\r\nal--;\r\nif (al <= 0) break;\r\n}\r\nrp[al]=bn_mul_add_words(rp,ap,al,*(bp++));\r\nrp++;\r\n}\r\nwhile ((r->top > 0) && (r->d[r->top-1] == 0))\r\nr->top--;\r\nreturn(1);\r\n}\r\nint bn_mm_low(BIGNUM *m, BIGNUM *A, BIGNUM *B, int num, BIGNUM *sk,\r\nBN_CTX *ctx)\r\n{\r\nint n;\r\nint an,bn;\r\nBIGNUM ah,al,bh,bl;\r\nbn_wexpand(m,num+3);\r\nan=A->top;\r\nbn=B->top;\r\n#ifdef BN_MUL_DEBUG\r\nprintf("bn_mm_low(%d,%d,%d)\n",A->top,B->top,num);\r\n#endif\r\nn=(num+1)/2;\r\nBN_init(&ah); BN_init(&al); BN_init(&bh); BN_init(&bl);\r\nbn_set_low( &al,A,n);\r\nbn_set_high(&ah,A,n);\r\nbn_set_low( &bl,B,n);\r\nbn_set_high(&bh,B,n);\r\nif (num <= (bn_limit_num_low+bn_limit_num_low))\r\n{\r\nBN_mul(m,&al,&bl);\r\nBN_mul_low(&t1,&al,&bh,n);\r\nBN_mul_low(&t2,&ah,&bl,n);\r\n}\r\nelse\r\n{\r\nbn_mm(m ,&al,&bl,&(sk[2]),ctx);\r\nbn_mm_low(&t1,&al,&bh,n,&(sk[2]),ctx);\r\nbn_mm_low(&t2,&ah,&bl,n,&(sk[2]),ctx);\r\n}\r\nBN_add(&t1,&t1,&t2);\r\nbn_set_high(&ah,m,n); ah.max=num+2;\r\nBN_add(&ah,&ah,&t1);\r\nm->top=num;\r\nm->neg=A->neg^B->neg;\r\nreturn(1);\r\n}

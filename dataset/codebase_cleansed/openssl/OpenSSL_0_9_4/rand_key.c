void des_random_seed(des_cblock *key)\r\n{\r\nmemcpy(&init,key,sizeof(des_cblock));\r\nseed=1;\r\n}\r\nvoid des_random_key(des_cblock *ret)\r\n{\r\ndes_key_schedule ks;\r\nstatic DES_LONG c=0;\r\nstatic unsigned short pid=0;\r\nstatic des_cblock data={0x01,0x23,0x45,0x67,0x89,0xab,0xcd,0xef};\r\ndes_cblock key;\r\nunsigned char *p;\r\nDES_LONG t;\r\nint i;\r\n#ifdef MSDOS\r\npid=1;\r\n#else\r\nif (!pid) pid=getpid();\r\n#endif\r\np=key;\r\nif (seed)\r\n{\r\nfor (i=0; i<8; i++)\r\n{\r\ndata[i] ^= init[i];\r\ninit[i]=0;\r\n}\r\nseed=0;\r\n}\r\nt=(DES_LONG)time(NULL);\r\nl2c(t,p);\r\nt=(DES_LONG)((pid)|((c++)<<16));\r\nl2c(t,p);\r\ndes_set_odd_parity(&data);\r\ndes_set_key(&data,ks);\r\ndes_cbc_cksum(key,&key,sizeof(key),ks,&data);\r\ndes_set_odd_parity(&key);\r\ndes_set_key(&key,ks);\r\ndes_cbc_cksum(key,&data,sizeof(key),ks,&key);\r\nmemcpy(ret,data,sizeof(key));\r\nmemset(key,0,sizeof(key));\r\nmemset(ks,0,sizeof(ks));\r\nt=0;\r\n}

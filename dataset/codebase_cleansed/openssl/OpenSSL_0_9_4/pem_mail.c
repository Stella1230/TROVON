int main(int argc, char **argv)\r\n{\r\nFILE *in;\r\nRSA *rsa=NULL;\r\nEVP_MD_CTX ctx;\r\nunsigned int mic=0,i,n;\r\nunsigned char buf[1024*15];\r\nchar *prog,*infile=NULL,*outfile=NULL,*key=NULL;\r\nint badops=0;\r\napps_startup();\r\nprog=argv[0];\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-key") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nkey= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-mic") == 0)\r\nmic=1;\r\nelse\r\n{\r\nBIO_printf(bio_err,"unknown option %s\n",*argv);\r\nbadops=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nBIO_printf(bio_err,"%s [options] <infile >outfile\n",prog);\r\nBIO_printf(bio_err,"where options are\n");\r\nEXIT(1);\r\n}\r\nif (key == NULL)\r\n{ BIO_printf(bio_err,"you need to specify a key\n"); EXIT(1); }\r\nin=fopen(key,"r");\r\nif (in == NULL) { perror(key); EXIT(1); }\r\nrsa=PEM_read_RSAPrivateKey(in,NULL,NULL);\r\nif (rsa == NULL)\r\n{\r\nBIO_printf(bio_err,"unable to load Private Key\n");\r\nERR_print_errors(bio_err);\r\nEXIT(1);\r\n}\r\nfclose(in);\r\nPEM_SignInit(&ctx,EVP_md5());\r\nfor (;;)\r\n{\r\ni=fread(buf,1,1024*10,stdin);\r\nif (i <= 0) break;\r\nPEM_SignUpdate(&ctx,buf,i);\r\n}\r\nif (!PEM_SignFinal(&ctx,buf,&n,rsa)) goto err;\r\nBIO_printf(bio_err,"%s\n",buf);\r\nEXIT(0);\r\nerr:\r\nERR_print_errors(bio_err);\r\nEXIT(1);\r\n}

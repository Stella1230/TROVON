void RIPEMD160_Init(RIPEMD160_CTX *c)\r\n{\r\nc->A=RIPEMD160_A;\r\nc->B=RIPEMD160_B;\r\nc->C=RIPEMD160_C;\r\nc->D=RIPEMD160_D;\r\nc->E=RIPEMD160_E;\r\nc->Nl=0;\r\nc->Nh=0;\r\nc->num=0;\r\n}\r\nvoid RIPEMD160_Update(RIPEMD160_CTX *c, register unsigned char *data,\r\nunsigned long len)\r\n{\r\nregister ULONG *p;\r\nint sw,sc;\r\nULONG l;\r\nif (len == 0) return;\r\nl=(c->Nl+(len<<3))&0xffffffffL;\r\nif (l < c->Nl)\r\nc->Nh++;\r\nc->Nh+=(len>>29);\r\nc->Nl=l;\r\nif (c->num != 0)\r\n{\r\np=c->data;\r\nsw=c->num>>2;\r\nsc=c->num&0x03;\r\nif ((c->num+len) >= RIPEMD160_CBLOCK)\r\n{\r\nl= p[sw];\r\np_c2l(data,l,sc);\r\np[sw++]=l;\r\nfor (; sw<RIPEMD160_LBLOCK; sw++)\r\n{\r\nc2l(data,l);\r\np[sw]=l;\r\n}\r\nlen-=(RIPEMD160_CBLOCK-c->num);\r\nripemd160_block(c,p,64);\r\nc->num=0;\r\n}\r\nelse\r\n{\r\nint ew,ec;\r\nc->num+=(int)len;\r\nif ((sc+len) < 4)\r\n{\r\nl= p[sw];\r\np_c2l_p(data,l,sc,len);\r\np[sw]=l;\r\n}\r\nelse\r\n{\r\new=(c->num>>2);\r\nec=(c->num&0x03);\r\nl= p[sw];\r\np_c2l(data,l,sc);\r\np[sw++]=l;\r\nfor (; sw < ew; sw++)\r\n{ c2l(data,l); p[sw]=l; }\r\nif (ec)\r\n{\r\nc2l_p(data,l,ec);\r\np[sw]=l;\r\n}\r\n}\r\nreturn;\r\n}\r\n}\r\n#ifdef L_ENDIAN\r\nif ((((unsigned long)data)%sizeof(ULONG)) == 0)\r\n{\r\nsw=(int)len/RIPEMD160_CBLOCK;\r\nif (sw > 0)\r\n{\r\nsw*=RIPEMD160_CBLOCK;\r\nripemd160_block(c,(ULONG *)data,sw);\r\ndata+=sw;\r\nlen-=sw;\r\n}\r\n}\r\n#endif\r\np=c->data;\r\nwhile (len >= RIPEMD160_CBLOCK)\r\n{\r\n#if defined(L_ENDIAN) || defined(B_ENDIAN)\r\nif (p != (unsigned long *)data)\r\nmemcpy(p,data,RIPEMD160_CBLOCK);\r\ndata+=RIPEMD160_CBLOCK;\r\n#ifdef B_ENDIAN\r\nfor (sw=(RIPEMD160_LBLOCK/4); sw; sw--)\r\n{\r\nEndian_Reverse32(p[0]);\r\nEndian_Reverse32(p[1]);\r\nEndian_Reverse32(p[2]);\r\nEndian_Reverse32(p[3]);\r\np+=4;\r\n}\r\n#endif\r\n#else\r\nfor (sw=(RIPEMD160_LBLOCK/4); sw; sw--)\r\n{\r\nc2l(data,l); *(p++)=l;\r\nc2l(data,l); *(p++)=l;\r\nc2l(data,l); *(p++)=l;\r\nc2l(data,l); *(p++)=l;\r\n}\r\n#endif\r\np=c->data;\r\nripemd160_block(c,p,64);\r\nlen-=RIPEMD160_CBLOCK;\r\n}\r\nsc=(int)len;\r\nc->num=sc;\r\nif (sc)\r\n{\r\nsw=sc>>2;\r\n#ifdef L_ENDIAN\r\np[sw]=0;\r\nmemcpy(p,data,sc);\r\n#else\r\nsc&=0x03;\r\nfor ( ; sw; sw--)\r\n{ c2l(data,l); *(p++)=l; }\r\nc2l_p(data,l,sc);\r\n*p=l;\r\n#endif\r\n}\r\n}\r\nvoid RIPEMD160_Transform(RIPEMD160_CTX *c, unsigned char *b)\r\n{\r\nULONG p[16];\r\n#if !defined(L_ENDIAN)\r\nULONG *q;\r\nint i;\r\n#endif\r\n#if defined(B_ENDIAN) || defined(L_ENDIAN)\r\nmemcpy(p,b,64);\r\n#ifdef B_ENDIAN\r\nq=p;\r\nfor (i=(RIPEMD160_LBLOCK/4); i; i--)\r\n{\r\nEndian_Reverse32(q[0]);\r\nEndian_Reverse32(q[1]);\r\nEndian_Reverse32(q[2]);\r\nEndian_Reverse32(q[3]);\r\nq+=4;\r\n}\r\n#endif\r\n#else\r\nq=p;\r\nfor (i=(RIPEMD160_LBLOCK/4); i; i--)\r\n{\r\nULONG l;\r\nc2l(b,l); *(q++)=l;\r\nc2l(b,l); *(q++)=l;\r\nc2l(b,l); *(q++)=l;\r\nc2l(b,l); *(q++)=l;\r\n}\r\n#endif\r\nripemd160_block(c,p,64);\r\n}\r\nvoid ripemd160_block(RIPEMD160_CTX *ctx, register ULONG *X, int num)\r\n{\r\nregister ULONG A,B,C,D,E;\r\nULONG a,b,c,d,e;\r\nfor (;;)\r\n{\r\nA=ctx->A; B=ctx->B; C=ctx->C; D=ctx->D; E=ctx->E;\r\nRIP1(A,B,C,D,E,WL00,SL00);\r\nRIP1(E,A,B,C,D,WL01,SL01);\r\nRIP1(D,E,A,B,C,WL02,SL02);\r\nRIP1(C,D,E,A,B,WL03,SL03);\r\nRIP1(B,C,D,E,A,WL04,SL04);\r\nRIP1(A,B,C,D,E,WL05,SL05);\r\nRIP1(E,A,B,C,D,WL06,SL06);\r\nRIP1(D,E,A,B,C,WL07,SL07);\r\nRIP1(C,D,E,A,B,WL08,SL08);\r\nRIP1(B,C,D,E,A,WL09,SL09);\r\nRIP1(A,B,C,D,E,WL10,SL10);\r\nRIP1(E,A,B,C,D,WL11,SL11);\r\nRIP1(D,E,A,B,C,WL12,SL12);\r\nRIP1(C,D,E,A,B,WL13,SL13);\r\nRIP1(B,C,D,E,A,WL14,SL14);\r\nRIP1(A,B,C,D,E,WL15,SL15);\r\nRIP2(E,A,B,C,D,WL16,SL16,KL1);\r\nRIP2(D,E,A,B,C,WL17,SL17,KL1);\r\nRIP2(C,D,E,A,B,WL18,SL18,KL1);\r\nRIP2(B,C,D,E,A,WL19,SL19,KL1);\r\nRIP2(A,B,C,D,E,WL20,SL20,KL1);\r\nRIP2(E,A,B,C,D,WL21,SL21,KL1);\r\nRIP2(D,E,A,B,C,WL22,SL22,KL1);\r\nRIP2(C,D,E,A,B,WL23,SL23,KL1);\r\nRIP2(B,C,D,E,A,WL24,SL24,KL1);\r\nRIP2(A,B,C,D,E,WL25,SL25,KL1);\r\nRIP2(E,A,B,C,D,WL26,SL26,KL1);\r\nRIP2(D,E,A,B,C,WL27,SL27,KL1);\r\nRIP2(C,D,E,A,B,WL28,SL28,KL1);\r\nRIP2(B,C,D,E,A,WL29,SL29,KL1);\r\nRIP2(A,B,C,D,E,WL30,SL30,KL1);\r\nRIP2(E,A,B,C,D,WL31,SL31,KL1);\r\nRIP3(D,E,A,B,C,WL32,SL32,KL2);\r\nRIP3(C,D,E,A,B,WL33,SL33,KL2);\r\nRIP3(B,C,D,E,A,WL34,SL34,KL2);\r\nRIP3(A,B,C,D,E,WL35,SL35,KL2);\r\nRIP3(E,A,B,C,D,WL36,SL36,KL2);\r\nRIP3(D,E,A,B,C,WL37,SL37,KL2);\r\nRIP3(C,D,E,A,B,WL38,SL38,KL2);\r\nRIP3(B,C,D,E,A,WL39,SL39,KL2);\r\nRIP3(A,B,C,D,E,WL40,SL40,KL2);\r\nRIP3(E,A,B,C,D,WL41,SL41,KL2);\r\nRIP3(D,E,A,B,C,WL42,SL42,KL2);\r\nRIP3(C,D,E,A,B,WL43,SL43,KL2);\r\nRIP3(B,C,D,E,A,WL44,SL44,KL2);\r\nRIP3(A,B,C,D,E,WL45,SL45,KL2);\r\nRIP3(E,A,B,C,D,WL46,SL46,KL2);\r\nRIP3(D,E,A,B,C,WL47,SL47,KL2);\r\nRIP4(C,D,E,A,B,WL48,SL48,KL3);\r\nRIP4(B,C,D,E,A,WL49,SL49,KL3);\r\nRIP4(A,B,C,D,E,WL50,SL50,KL3);\r\nRIP4(E,A,B,C,D,WL51,SL51,KL3);\r\nRIP4(D,E,A,B,C,WL52,SL52,KL3);\r\nRIP4(C,D,E,A,B,WL53,SL53,KL3);\r\nRIP4(B,C,D,E,A,WL54,SL54,KL3);\r\nRIP4(A,B,C,D,E,WL55,SL55,KL3);\r\nRIP4(E,A,B,C,D,WL56,SL56,KL3);\r\nRIP4(D,E,A,B,C,WL57,SL57,KL3);\r\nRIP4(C,D,E,A,B,WL58,SL58,KL3);\r\nRIP4(B,C,D,E,A,WL59,SL59,KL3);\r\nRIP4(A,B,C,D,E,WL60,SL60,KL3);\r\nRIP4(E,A,B,C,D,WL61,SL61,KL3);\r\nRIP4(D,E,A,B,C,WL62,SL62,KL3);\r\nRIP4(C,D,E,A,B,WL63,SL63,KL3);\r\nRIP5(B,C,D,E,A,WL64,SL64,KL4);\r\nRIP5(A,B,C,D,E,WL65,SL65,KL4);\r\nRIP5(E,A,B,C,D,WL66,SL66,KL4);\r\nRIP5(D,E,A,B,C,WL67,SL67,KL4);\r\nRIP5(C,D,E,A,B,WL68,SL68,KL4);\r\nRIP5(B,C,D,E,A,WL69,SL69,KL4);\r\nRIP5(A,B,C,D,E,WL70,SL70,KL4);\r\nRIP5(E,A,B,C,D,WL71,SL71,KL4);\r\nRIP5(D,E,A,B,C,WL72,SL72,KL4);\r\nRIP5(C,D,E,A,B,WL73,SL73,KL4);\r\nRIP5(B,C,D,E,A,WL74,SL74,KL4);\r\nRIP5(A,B,C,D,E,WL75,SL75,KL4);\r\nRIP5(E,A,B,C,D,WL76,SL76,KL4);\r\nRIP5(D,E,A,B,C,WL77,SL77,KL4);\r\nRIP5(C,D,E,A,B,WL78,SL78,KL4);\r\nRIP5(B,C,D,E,A,WL79,SL79,KL4);\r\na=A; b=B; c=C; d=D; e=E;\r\nA=ctx->A; B=ctx->B; C=ctx->C; D=ctx->D; E=ctx->E;\r\nRIP5(A,B,C,D,E,WR00,SR00,KR0);\r\nRIP5(E,A,B,C,D,WR01,SR01,KR0);\r\nRIP5(D,E,A,B,C,WR02,SR02,KR0);\r\nRIP5(C,D,E,A,B,WR03,SR03,KR0);\r\nRIP5(B,C,D,E,A,WR04,SR04,KR0);\r\nRIP5(A,B,C,D,E,WR05,SR05,KR0);\r\nRIP5(E,A,B,C,D,WR06,SR06,KR0);\r\nRIP5(D,E,A,B,C,WR07,SR07,KR0);\r\nRIP5(C,D,E,A,B,WR08,SR08,KR0);\r\nRIP5(B,C,D,E,A,WR09,SR09,KR0);\r\nRIP5(A,B,C,D,E,WR10,SR10,KR0);\r\nRIP5(E,A,B,C,D,WR11,SR11,KR0);\r\nRIP5(D,E,A,B,C,WR12,SR12,KR0);\r\nRIP5(C,D,E,A,B,WR13,SR13,KR0);\r\nRIP5(B,C,D,E,A,WR14,SR14,KR0);\r\nRIP5(A,B,C,D,E,WR15,SR15,KR0);\r\nRIP4(E,A,B,C,D,WR16,SR16,KR1);\r\nRIP4(D,E,A,B,C,WR17,SR17,KR1);\r\nRIP4(C,D,E,A,B,WR18,SR18,KR1);\r\nRIP4(B,C,D,E,A,WR19,SR19,KR1);\r\nRIP4(A,B,C,D,E,WR20,SR20,KR1);\r\nRIP4(E,A,B,C,D,WR21,SR21,KR1);\r\nRIP4(D,E,A,B,C,WR22,SR22,KR1);\r\nRIP4(C,D,E,A,B,WR23,SR23,KR1);\r\nRIP4(B,C,D,E,A,WR24,SR24,KR1);\r\nRIP4(A,B,C,D,E,WR25,SR25,KR1);\r\nRIP4(E,A,B,C,D,WR26,SR26,KR1);\r\nRIP4(D,E,A,B,C,WR27,SR27,KR1);\r\nRIP4(C,D,E,A,B,WR28,SR28,KR1);\r\nRIP4(B,C,D,E,A,WR29,SR29,KR1);\r\nRIP4(A,B,C,D,E,WR30,SR30,KR1);\r\nRIP4(E,A,B,C,D,WR31,SR31,KR1);\r\nRIP3(D,E,A,B,C,WR32,SR32,KR2);\r\nRIP3(C,D,E,A,B,WR33,SR33,KR2);\r\nRIP3(B,C,D,E,A,WR34,SR34,KR2);\r\nRIP3(A,B,C,D,E,WR35,SR35,KR2);\r\nRIP3(E,A,B,C,D,WR36,SR36,KR2);\r\nRIP3(D,E,A,B,C,WR37,SR37,KR2);\r\nRIP3(C,D,E,A,B,WR38,SR38,KR2);\r\nRIP3(B,C,D,E,A,WR39,SR39,KR2);\r\nRIP3(A,B,C,D,E,WR40,SR40,KR2);\r\nRIP3(E,A,B,C,D,WR41,SR41,KR2);\r\nRIP3(D,E,A,B,C,WR42,SR42,KR2);\r\nRIP3(C,D,E,A,B,WR43,SR43,KR2);\r\nRIP3(B,C,D,E,A,WR44,SR44,KR2);\r\nRIP3(A,B,C,D,E,WR45,SR45,KR2);\r\nRIP3(E,A,B,C,D,WR46,SR46,KR2);\r\nRIP3(D,E,A,B,C,WR47,SR47,KR2);\r\nRIP2(C,D,E,A,B,WR48,SR48,KR3);\r\nRIP2(B,C,D,E,A,WR49,SR49,KR3);\r\nRIP2(A,B,C,D,E,WR50,SR50,KR3);\r\nRIP2(E,A,B,C,D,WR51,SR51,KR3);\r\nRIP2(D,E,A,B,C,WR52,SR52,KR3);\r\nRIP2(C,D,E,A,B,WR53,SR53,KR3);\r\nRIP2(B,C,D,E,A,WR54,SR54,KR3);\r\nRIP2(A,B,C,D,E,WR55,SR55,KR3);\r\nRIP2(E,A,B,C,D,WR56,SR56,KR3);\r\nRIP2(D,E,A,B,C,WR57,SR57,KR3);\r\nRIP2(C,D,E,A,B,WR58,SR58,KR3);\r\nRIP2(B,C,D,E,A,WR59,SR59,KR3);\r\nRIP2(A,B,C,D,E,WR60,SR60,KR3);\r\nRIP2(E,A,B,C,D,WR61,SR61,KR3);\r\nRIP2(D,E,A,B,C,WR62,SR62,KR3);\r\nRIP2(C,D,E,A,B,WR63,SR63,KR3);\r\nRIP1(B,C,D,E,A,WR64,SR64);\r\nRIP1(A,B,C,D,E,WR65,SR65);\r\nRIP1(E,A,B,C,D,WR66,SR66);\r\nRIP1(D,E,A,B,C,WR67,SR67);\r\nRIP1(C,D,E,A,B,WR68,SR68);\r\nRIP1(B,C,D,E,A,WR69,SR69);\r\nRIP1(A,B,C,D,E,WR70,SR70);\r\nRIP1(E,A,B,C,D,WR71,SR71);\r\nRIP1(D,E,A,B,C,WR72,SR72);\r\nRIP1(C,D,E,A,B,WR73,SR73);\r\nRIP1(B,C,D,E,A,WR74,SR74);\r\nRIP1(A,B,C,D,E,WR75,SR75);\r\nRIP1(E,A,B,C,D,WR76,SR76);\r\nRIP1(D,E,A,B,C,WR77,SR77);\r\nRIP1(C,D,E,A,B,WR78,SR78);\r\nRIP1(B,C,D,E,A,WR79,SR79);\r\nD =ctx->B+c+D;\r\nctx->B=ctx->C+d+E;\r\nctx->C=ctx->D+e+A;\r\nctx->D=ctx->E+a+B;\r\nctx->E=ctx->A+b+C;\r\nctx->A=D;\r\nX+=16;\r\nnum-=64;\r\nif (num <= 0) break;\r\n}\r\n}\r\nvoid RIPEMD160_Final(unsigned char *md, RIPEMD160_CTX *c)\r\n{\r\nregister int i,j;\r\nregister ULONG l;\r\nregister ULONG *p;\r\nstatic unsigned char end[4]={0x80,0x00,0x00,0x00};\r\nunsigned char *cp=end;\r\np=c->data;\r\nj=c->num;\r\ni=j>>2;\r\n#ifdef PURIFY\r\nif ((j&0x03) == 0) p[i]=0;\r\n#endif\r\nl=p[i];\r\np_c2l(cp,l,j&0x03);\r\np[i]=l;\r\ni++;\r\nif (c->num >= RIPEMD160_LAST_BLOCK)\r\n{\r\nfor (; i<RIPEMD160_LBLOCK; i++)\r\np[i]=0;\r\nripemd160_block(c,p,64);\r\ni=0;\r\n}\r\nfor (; i<(RIPEMD160_LBLOCK-2); i++)\r\np[i]=0;\r\np[RIPEMD160_LBLOCK-2]=c->Nl;\r\np[RIPEMD160_LBLOCK-1]=c->Nh;\r\nripemd160_block(c,p,64);\r\ncp=md;\r\nl=c->A; l2c(l,cp);\r\nl=c->B; l2c(l,cp);\r\nl=c->C; l2c(l,cp);\r\nl=c->D; l2c(l,cp);\r\nl=c->E; l2c(l,cp);\r\nc->num=0;\r\n}\r\nint printit(unsigned long *l)\r\n{\r\nint i,ii;\r\nfor (i=0; i<2; i++)\r\n{\r\nfor (ii=0; ii<8; ii++)\r\n{\r\nfprintf(stderr,"%08lx ",l[i*8+ii]);\r\n}\r\nfprintf(stderr,"\n");\r\n}\r\n}

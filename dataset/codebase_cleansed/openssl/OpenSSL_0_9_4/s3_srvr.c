static SSL_METHOD *ssl3_get_server_method(int ver)\r\n{\r\nif (ver == SSL3_VERSION)\r\nreturn(SSLv3_server_method());\r\nelse\r\nreturn(NULL);\r\n}\r\nSSL_METHOD *SSLv3_server_method(void)\r\n{\r\nstatic int init=1;\r\nstatic SSL_METHOD SSLv3_server_data;\r\nif (init)\r\n{\r\nmemcpy((char *)&SSLv3_server_data,(char *)sslv3_base_method(),\r\nsizeof(SSL_METHOD));\r\nSSLv3_server_data.ssl_accept=ssl3_accept;\r\nSSLv3_server_data.get_ssl_method=ssl3_get_server_method;\r\ninit=0;\r\n}\r\nreturn(&SSLv3_server_data);\r\n}\r\nint ssl3_accept(SSL *s)\r\n{\r\nBUF_MEM *buf;\r\nunsigned long l,Time=time(NULL);\r\nvoid (*cb)()=NULL;\r\nlong num1;\r\nint ret= -1;\r\nint new_state,state,skip=0;\r\nRAND_seed(&Time,sizeof(Time));\r\nERR_clear_error();\r\nclear_sys_error();\r\nif (s->info_callback != NULL)\r\ncb=s->info_callback;\r\nelse if (s->ctx->info_callback != NULL)\r\ncb=s->ctx->info_callback;\r\nif (!SSL_in_init(s) || SSL_in_before(s)) SSL_clear(s);\r\ns->in_handshake++;\r\nif (s->cert == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_ACCEPT,SSL_R_NO_CERTIFICATE_SET);\r\nreturn(-1);\r\n}\r\nfor (;;)\r\n{\r\nstate=s->state;\r\nswitch (s->state)\r\n{\r\ncase SSL_ST_RENEGOTIATE:\r\ns->new_session=1;\r\ncase SSL_ST_BEFORE:\r\ncase SSL_ST_ACCEPT:\r\ncase SSL_ST_BEFORE|SSL_ST_ACCEPT:\r\ncase SSL_ST_OK|SSL_ST_ACCEPT:\r\ns->server=1;\r\nif (cb != NULL) cb(s,SSL_CB_HANDSHAKE_START,1);\r\nif ((s->version>>8) != 3)\r\nabort();\r\ns->type=SSL_ST_ACCEPT;\r\nif (s->init_buf == NULL)\r\n{\r\nif ((buf=BUF_MEM_new()) == NULL)\r\n{\r\nret= -1;\r\ngoto end;\r\n}\r\nif (!BUF_MEM_grow(buf,SSL3_RT_MAX_PLAIN_LENGTH))\r\n{\r\nret= -1;\r\ngoto end;\r\n}\r\ns->init_buf=buf;\r\n}\r\nif (!ssl3_setup_buffers(s))\r\n{\r\nret= -1;\r\ngoto end;\r\n}\r\nif (!ssl_init_wbio_buffer(s,1)) { ret= -1; goto end; }\r\ns->init_num=0;\r\nif (s->state != SSL_ST_RENEGOTIATE)\r\n{\r\ns->state=SSL3_ST_SR_CLNT_HELLO_A;\r\nssl3_init_finished_mac(s);\r\ns->ctx->stats.sess_accept++;\r\n}\r\nelse\r\n{\r\ns->ctx->stats.sess_accept_renegotiate++;\r\ns->state=SSL3_ST_SW_HELLO_REQ_A;\r\n}\r\nbreak;\r\ncase SSL3_ST_SW_HELLO_REQ_A:\r\ncase SSL3_ST_SW_HELLO_REQ_B:\r\ns->shutdown=0;\r\nret=ssl3_send_hello_request(s);\r\nif (ret <= 0) goto end;\r\ns->s3->tmp.next_state=SSL3_ST_SW_HELLO_REQ_C;\r\ns->state=SSL3_ST_SW_FLUSH;\r\ns->init_num=0;\r\nssl3_init_finished_mac(s);\r\nbreak;\r\ncase SSL3_ST_SW_HELLO_REQ_C:\r\ns->state=SSL_ST_OK;\r\nret=1;\r\ngoto end;\r\ncase SSL3_ST_SR_CLNT_HELLO_A:\r\ncase SSL3_ST_SR_CLNT_HELLO_B:\r\ncase SSL3_ST_SR_CLNT_HELLO_C:\r\ns->shutdown=0;\r\nret=ssl3_get_client_hello(s);\r\nif (ret <= 0) goto end;\r\ns->state=SSL3_ST_SW_SRVR_HELLO_A;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SW_SRVR_HELLO_A:\r\ncase SSL3_ST_SW_SRVR_HELLO_B:\r\nret=ssl3_send_server_hello(s);\r\nif (ret <= 0) goto end;\r\nif (s->hit)\r\ns->state=SSL3_ST_SW_CHANGE_A;\r\nelse\r\ns->state=SSL3_ST_SW_CERT_A;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SW_CERT_A:\r\ncase SSL3_ST_SW_CERT_B:\r\nif (!(s->s3->tmp.new_cipher->algorithms & SSL_aNULL))\r\n{\r\nret=ssl3_send_server_certificate(s);\r\nif (ret <= 0) goto end;\r\n}\r\nelse\r\nskip=1;\r\ns->state=SSL3_ST_SW_KEY_EXCH_A;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SW_KEY_EXCH_A:\r\ncase SSL3_ST_SW_KEY_EXCH_B:\r\nl=s->s3->tmp.new_cipher->algorithms;\r\nif (s->options & SSL_OP_EPHEMERAL_RSA)\r\ns->s3->tmp.use_rsa_tmp=1;\r\nelse\r\ns->s3->tmp.use_rsa_tmp=0;\r\nif (s->s3->tmp.use_rsa_tmp\r\n|| (l & (SSL_DH|SSL_kFZA))\r\n|| ((l & SSL_kRSA)\r\n&& (s->cert->pkeys[SSL_PKEY_RSA_ENC].privatekey == NULL\r\n|| (SSL_IS_EXPORT(l)\r\n&& EVP_PKEY_size(s->cert->pkeys[SSL_PKEY_RSA_ENC].privatekey)*8 > SSL_EXPORT_PKEYLENGTH(l)\r\n)\r\n)\r\n)\r\n)\r\n{\r\nret=ssl3_send_server_key_exchange(s);\r\nif (ret <= 0) goto end;\r\n}\r\nelse\r\nskip=1;\r\ns->state=SSL3_ST_SW_CERT_REQ_A;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SW_CERT_REQ_A:\r\ncase SSL3_ST_SW_CERT_REQ_B:\r\nif (!(s->verify_mode & SSL_VERIFY_PEER) ||\r\n((s->session->peer != NULL) &&\r\n(s->verify_mode & SSL_VERIFY_CLIENT_ONCE)))\r\n{\r\nskip=1;\r\ns->s3->tmp.cert_request=0;\r\ns->state=SSL3_ST_SW_SRVR_DONE_A;\r\n}\r\nelse\r\n{\r\ns->s3->tmp.cert_request=1;\r\nret=ssl3_send_certificate_request(s);\r\nif (ret <= 0) goto end;\r\ns->state=SSL3_ST_SW_SRVR_DONE_A;\r\ns->init_num=0;\r\n}\r\nbreak;\r\ncase SSL3_ST_SW_SRVR_DONE_A:\r\ncase SSL3_ST_SW_SRVR_DONE_B:\r\nret=ssl3_send_server_done(s);\r\nif (ret <= 0) goto end;\r\ns->s3->tmp.next_state=SSL3_ST_SR_CERT_A;\r\ns->state=SSL3_ST_SW_FLUSH;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SW_FLUSH:\r\nnum1=BIO_ctrl(s->wbio,BIO_CTRL_INFO,0,NULL);\r\nif (num1 > 0)\r\n{\r\ns->rwstate=SSL_WRITING;\r\nnum1=BIO_flush(s->wbio);\r\nif (num1 <= 0) { ret= -1; goto end; }\r\ns->rwstate=SSL_NOTHING;\r\n}\r\ns->state=s->s3->tmp.next_state;\r\nbreak;\r\ncase SSL3_ST_SR_CERT_A:\r\ncase SSL3_ST_SR_CERT_B:\r\nret=ssl3_get_client_certificate(s);\r\nif (ret <= 0) goto end;\r\ns->init_num=0;\r\ns->state=SSL3_ST_SR_KEY_EXCH_A;\r\nbreak;\r\ncase SSL3_ST_SR_KEY_EXCH_A:\r\ncase SSL3_ST_SR_KEY_EXCH_B:\r\nret=ssl3_get_client_key_exchange(s);\r\nif (ret <= 0) goto end;\r\ns->state=SSL3_ST_SR_CERT_VRFY_A;\r\ns->init_num=0;\r\ns->method->ssl3_enc->cert_verify_mac(s,\r\n&(s->s3->finish_dgst1),\r\n&(s->s3->tmp.finish_md[0]));\r\ns->method->ssl3_enc->cert_verify_mac(s,\r\n&(s->s3->finish_dgst2),\r\n&(s->s3->tmp.finish_md[MD5_DIGEST_LENGTH]));\r\nbreak;\r\ncase SSL3_ST_SR_CERT_VRFY_A:\r\ncase SSL3_ST_SR_CERT_VRFY_B:\r\nret=ssl3_get_cert_verify(s);\r\nif (ret <= 0) goto end;\r\ns->state=SSL3_ST_SR_FINISHED_A;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SR_FINISHED_A:\r\ncase SSL3_ST_SR_FINISHED_B:\r\nret=ssl3_get_finished(s,SSL3_ST_SR_FINISHED_A,\r\nSSL3_ST_SR_FINISHED_B);\r\nif (ret <= 0) goto end;\r\nif (s->hit)\r\ns->state=SSL_ST_OK;\r\nelse\r\ns->state=SSL3_ST_SW_CHANGE_A;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL3_ST_SW_CHANGE_A:\r\ncase SSL3_ST_SW_CHANGE_B:\r\ns->session->cipher=s->s3->tmp.new_cipher;\r\nif (!s->method->ssl3_enc->setup_key_block(s))\r\n{ ret= -1; goto end; }\r\nret=ssl3_send_change_cipher_spec(s,\r\nSSL3_ST_SW_CHANGE_A,SSL3_ST_SW_CHANGE_B);\r\nif (ret <= 0) goto end;\r\ns->state=SSL3_ST_SW_FINISHED_A;\r\ns->init_num=0;\r\nif (!s->method->ssl3_enc->change_cipher_state(s,\r\nSSL3_CHANGE_CIPHER_SERVER_WRITE))\r\n{\r\nret= -1;\r\ngoto end;\r\n}\r\nbreak;\r\ncase SSL3_ST_SW_FINISHED_A:\r\ncase SSL3_ST_SW_FINISHED_B:\r\nret=ssl3_send_finished(s,\r\nSSL3_ST_SW_FINISHED_A,SSL3_ST_SW_FINISHED_B,\r\ns->method->ssl3_enc->server_finished,\r\ns->method->ssl3_enc->server_finished_len);\r\nif (ret <= 0) goto end;\r\ns->state=SSL3_ST_SW_FLUSH;\r\nif (s->hit)\r\ns->s3->tmp.next_state=SSL3_ST_SR_FINISHED_A;\r\nelse\r\ns->s3->tmp.next_state=SSL_ST_OK;\r\ns->init_num=0;\r\nbreak;\r\ncase SSL_ST_OK:\r\nssl3_cleanup_key_block(s);\r\nBUF_MEM_free(s->init_buf);\r\ns->init_buf=NULL;\r\nssl_free_wbio_buffer(s);\r\ns->new_session=0;\r\ns->init_num=0;\r\nssl_update_cache(s,SSL_SESS_CACHE_SERVER);\r\ns->ctx->stats.sess_accept_good++;\r\ns->handshake_func=ssl3_accept;\r\nret=1;\r\nif (cb != NULL) cb(s,SSL_CB_HANDSHAKE_DONE,1);\r\ngoto end;\r\ndefault:\r\nSSLerr(SSL_F_SSL3_ACCEPT,SSL_R_UNKNOWN_STATE);\r\nret= -1;\r\ngoto end;\r\n}\r\nif (!s->s3->tmp.reuse_message && !skip)\r\n{\r\nif (s->debug)\r\n{\r\nif ((ret=BIO_flush(s->wbio)) <= 0)\r\ngoto end;\r\n}\r\nif ((cb != NULL) && (s->state != state))\r\n{\r\nnew_state=s->state;\r\ns->state=state;\r\ncb(s,SSL_CB_ACCEPT_LOOP,1);\r\ns->state=new_state;\r\n}\r\n}\r\nskip=0;\r\n}\r\nend:\r\nif (cb != NULL)\r\ncb(s,SSL_CB_ACCEPT_EXIT,ret);\r\ns->in_handshake--;\r\nreturn(ret);\r\n}\r\nstatic int ssl3_send_hello_request(SSL *s)\r\n{\r\nunsigned char *p;\r\nif (s->state == SSL3_ST_SW_HELLO_REQ_A)\r\n{\r\np=(unsigned char *)s->init_buf->data;\r\n*(p++)=SSL3_MT_CLIENT_REQUEST;\r\n*(p++)=0;\r\n*(p++)=0;\r\n*(p++)=0;\r\ns->state=SSL3_ST_SW_HELLO_REQ_B;\r\ns->init_num=4;\r\ns->init_off=0;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\n}\r\nstatic int ssl3_get_client_hello(SSL *s)\r\n{\r\nint i,j,ok,al,ret= -1;\r\nlong n;\r\nunsigned long id;\r\nunsigned char *p,*d,*q;\r\nSSL_CIPHER *c;\r\nSSL_COMP *comp=NULL;\r\nSTACK_OF(SSL_CIPHER) *ciphers=NULL;\r\nif (s->state == SSL3_ST_SR_CLNT_HELLO_A)\r\n{\r\ns->first_packet=1;\r\ns->state=SSL3_ST_SR_CLNT_HELLO_B;\r\n}\r\nn=ssl3_get_message(s,\r\nSSL3_ST_SR_CLNT_HELLO_B,\r\nSSL3_ST_SR_CLNT_HELLO_C,\r\nSSL3_MT_CLIENT_HELLO,\r\nSSL3_RT_MAX_PLAIN_LENGTH,\r\n&ok);\r\nif (!ok) return((int)n);\r\nd=p=(unsigned char *)s->init_buf->data;\r\np+=2;\r\nmemcpy(s->s3->client_random,p,SSL3_RANDOM_SIZE);\r\np+=SSL3_RANDOM_SIZE;\r\nj= *(p++);\r\ns->hit=0;\r\nif (j == 0)\r\n{\r\nif (!ssl_get_new_session(s,1))\r\ngoto err;\r\n}\r\nelse\r\n{\r\ni=ssl_get_prev_session(s,p,j);\r\nif (i == 1)\r\n{\r\ns->hit=1;\r\n}\r\nelse if (i == -1)\r\ngoto err;\r\nelse\r\n{\r\nif (!ssl_get_new_session(s,1))\r\ngoto err;\r\n}\r\n}\r\np+=j;\r\nn2s(p,i);\r\nif ((i == 0) && (j != 0))\r\n{\r\nal=SSL_AD_ILLEGAL_PARAMETER;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_NO_CIPHERS_SPECIFIED);\r\ngoto f_err;\r\n}\r\nif ((i+p) > (d+n))\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_LENGTH_MISMATCH);\r\ngoto f_err;\r\n}\r\nif ((i > 0) && (ssl_bytes_to_cipher_list(s,p,i,&(ciphers))\r\n== NULL))\r\n{\r\ngoto err;\r\n}\r\np+=i;\r\nif ((s->hit) && (i > 0))\r\n{\r\nj=0;\r\nid=s->session->cipher->id;\r\n#ifdef CIPHER_DEBUG\r\nprintf("client sent %d ciphers\n",sk_num(ciphers));\r\n#endif\r\nfor (i=0; i<sk_SSL_CIPHER_num(ciphers); i++)\r\n{\r\nc=sk_SSL_CIPHER_value(ciphers,i);\r\n#ifdef CIPHER_DEBUG\r\nprintf("client [%2d of %2d]:%s\n",\r\ni,sk_num(ciphers),SSL_CIPHER_get_name(c));\r\n#endif\r\nif (c->id == id)\r\n{\r\nj=1;\r\nbreak;\r\n}\r\n}\r\nif (j == 0)\r\n{\r\nif ((s->options & SSL_OP_NETSCAPE_REUSE_CIPHER_CHANGE_BUG) && (sk_SSL_CIPHER_num(ciphers) == 1))\r\n{\r\ns->session->cipher=sk_SSL_CIPHER_value(ciphers,\r\n0);\r\n}\r\nelse\r\n{\r\nal=SSL_AD_ILLEGAL_PARAMETER;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_REQUIRED_CIPHER_MISSING);\r\ngoto f_err;\r\n}\r\n}\r\n}\r\ni= *(p++);\r\nq=p;\r\nfor (j=0; j<i; j++)\r\n{\r\nif (p[j] == 0) break;\r\n}\r\np+=i;\r\nif (j >= i)\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_NO_COMPRESSION_SPECIFIED);\r\ngoto f_err;\r\n}\r\ns->s3->tmp.new_compression=NULL;\r\nif (s->ctx->comp_methods != NULL)\r\n{\r\nint m,nn,o,v,done=0;\r\nnn=sk_SSL_COMP_num(s->ctx->comp_methods);\r\nfor (m=0; m<nn; m++)\r\n{\r\ncomp=sk_SSL_COMP_value(s->ctx->comp_methods,m);\r\nv=comp->id;\r\nfor (o=0; o<i; o++)\r\n{\r\nif (v == q[o])\r\n{\r\ndone=1;\r\nbreak;\r\n}\r\n}\r\nif (done) break;\r\n}\r\nif (done)\r\ns->s3->tmp.new_compression=comp;\r\nelse\r\ncomp=NULL;\r\n}\r\nif (s->version == SSL3_VERSION)\r\n{\r\nif (p > (d+n))\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_LENGTH_MISMATCH);\r\ngoto f_err;\r\n}\r\n}\r\nif (!s->hit)\r\n{\r\ns->session->compress_meth=(comp == NULL)?0:comp->id;\r\nif (s->session->ciphers != NULL)\r\nsk_SSL_CIPHER_free(s->session->ciphers);\r\ns->session->ciphers=ciphers;\r\nif (ciphers == NULL)\r\n{\r\nal=SSL_AD_ILLEGAL_PARAMETER;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_NO_CIPHERS_PASSED);\r\ngoto f_err;\r\n}\r\nciphers=NULL;\r\nc=ssl3_choose_cipher(s,s->session->ciphers,\r\nssl_get_ciphers_by_id(s));\r\nif (c == NULL)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_HELLO,SSL_R_NO_SHARED_CIPHER);\r\ngoto f_err;\r\n}\r\ns->s3->tmp.new_cipher=c;\r\n}\r\nelse\r\n{\r\n#ifdef REUSE_CIPHER_BUG\r\nSTACK_OF(SSL_CIPHER) *sk;\r\nSSL_CIPHER *nc=NULL;\r\nSSL_CIPHER *ec=NULL;\r\nif (s->options & SSL_OP_NETSCAPE_DEMO_CIPHER_CHANGE_BUG)\r\n{\r\nsk=s->session->ciphers;\r\nfor (i=0; i<sk_SSL_CIPHER_num(sk); i++)\r\n{\r\nc=sk_SSL_CIPHER_value(sk,i);\r\nif (c->algorithms & SSL_eNULL)\r\nnc=c;\r\nif (SSL_C_IS_EXPORT(c))\r\nec=c;\r\n}\r\nif (nc != NULL)\r\ns->s3->tmp.new_cipher=nc;\r\nelse if (ec != NULL)\r\ns->s3->tmp.new_cipher=ec;\r\nelse\r\ns->s3->tmp.new_cipher=s->session->cipher;\r\n}\r\nelse\r\n#endif\r\ns->s3->tmp.new_cipher=s->session->cipher;\r\n}\r\nret=1;\r\nif (0)\r\n{\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\n}\r\nerr:\r\nif (ciphers != NULL) sk_SSL_CIPHER_free(ciphers);\r\nreturn(ret);\r\n}\r\nstatic int ssl3_send_server_hello(SSL *s)\r\n{\r\nunsigned char *buf;\r\nunsigned char *p,*d;\r\nint i,sl;\r\nunsigned long l,Time;\r\nif (s->state == SSL3_ST_SW_SRVR_HELLO_A)\r\n{\r\nbuf=(unsigned char *)s->init_buf->data;\r\np=s->s3->server_random;\r\nTime=time(NULL);\r\nl2n(Time,p);\r\nRAND_bytes(p,SSL3_RANDOM_SIZE-sizeof(Time));\r\nd=p= &(buf[4]);\r\n*(p++)=s->version>>8;\r\n*(p++)=s->version&0xff;\r\nmemcpy(p,s->s3->server_random,SSL3_RANDOM_SIZE);\r\np+=SSL3_RANDOM_SIZE;\r\nif (!(s->ctx->session_cache_mode & SSL_SESS_CACHE_SERVER))\r\ns->session->session_id_length=0;\r\nsl=s->session->session_id_length;\r\n*(p++)=sl;\r\nmemcpy(p,s->session->session_id,sl);\r\np+=sl;\r\ni=ssl3_put_cipher_by_char(s->s3->tmp.new_cipher,p);\r\np+=i;\r\nif (s->s3->tmp.new_compression == NULL)\r\n*(p++)=0;\r\nelse\r\n*(p++)=s->s3->tmp.new_compression->id;\r\nl=(p-d);\r\nd=buf;\r\n*(d++)=SSL3_MT_SERVER_HELLO;\r\nl2n3(l,d);\r\ns->state=SSL3_ST_CW_CLNT_HELLO_B;\r\ns->init_num=p-buf;\r\ns->init_off=0;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\n}\r\nstatic int ssl3_send_server_done(SSL *s)\r\n{\r\nunsigned char *p;\r\nif (s->state == SSL3_ST_SW_SRVR_DONE_A)\r\n{\r\np=(unsigned char *)s->init_buf->data;\r\n*(p++)=SSL3_MT_SERVER_DONE;\r\n*(p++)=0;\r\n*(p++)=0;\r\n*(p++)=0;\r\ns->state=SSL3_ST_SW_SRVR_DONE_B;\r\ns->init_num=4;\r\ns->init_off=0;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\n}\r\nstatic int ssl3_send_server_key_exchange(SSL *s)\r\n{\r\n#ifndef NO_RSA\r\nunsigned char *q;\r\nint j,num;\r\nRSA *rsa;\r\nunsigned char md_buf[MD5_DIGEST_LENGTH+SHA_DIGEST_LENGTH];\r\n#endif\r\n#ifndef NO_DH\r\nDH *dh,*dhp;\r\n#endif\r\nEVP_PKEY *pkey;\r\nunsigned char *p,*d;\r\nint al,i;\r\nunsigned long type;\r\nint n;\r\nCERT *cert;\r\nBIGNUM *r[4];\r\nint nr[4],kn;\r\nBUF_MEM *buf;\r\nEVP_MD_CTX md_ctx;\r\nif (s->state == SSL3_ST_SW_KEY_EXCH_A)\r\n{\r\ntype=s->s3->tmp.new_cipher->algorithms & SSL_MKEY_MASK;\r\ncert=s->cert;\r\nbuf=s->init_buf;\r\nr[0]=r[1]=r[2]=r[3]=NULL;\r\nn=0;\r\n#ifndef NO_RSA\r\nif (type & SSL_kRSA)\r\n{\r\nrsa=cert->rsa_tmp;\r\nif ((rsa == NULL) && (s->cert->rsa_tmp_cb != NULL))\r\n{\r\nrsa=s->cert->rsa_tmp_cb(s,\r\nSSL_C_IS_EXPORT(s->s3->tmp.new_cipher),\r\nSSL_C_EXPORT_PKEYLENGTH(s->s3->tmp.new_cipher));\r\nCRYPTO_add(&rsa->references,1,CRYPTO_LOCK_RSA);\r\ncert->rsa_tmp=rsa;\r\n}\r\nif (rsa == NULL)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,SSL_R_MISSING_TMP_RSA_KEY);\r\ngoto f_err;\r\n}\r\nr[0]=rsa->n;\r\nr[1]=rsa->e;\r\ns->s3->tmp.use_rsa_tmp=1;\r\n}\r\nelse\r\n#endif\r\n#ifndef NO_DH\r\nif (type & SSL_kEDH)\r\n{\r\ndhp=cert->dh_tmp;\r\nif ((dhp == NULL) && (s->cert->dh_tmp_cb != NULL))\r\ndhp=s->cert->dh_tmp_cb(s,\r\n!SSL_C_IS_EXPORT(s->s3->tmp.new_cipher),\r\nSSL_C_EXPORT_PKEYLENGTH(s->s3->tmp.new_cipher));\r\nif (dhp == NULL)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,SSL_R_MISSING_TMP_DH_KEY);\r\ngoto f_err;\r\n}\r\nif ((dh=DHparams_dup(dhp)) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,ERR_R_DH_LIB);\r\ngoto err;\r\n}\r\ns->s3->tmp.dh=dh;\r\nif ((dhp->pub_key == NULL ||\r\ndhp->priv_key == NULL ||\r\n(s->options & SSL_OP_SINGLE_DH_USE)))\r\n{\r\nif(!DH_generate_key(dh))\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,\r\nERR_R_DH_LIB);\r\ngoto err;\r\n}\r\n}\r\nelse\r\n{\r\ndh->pub_key=BN_dup(dhp->pub_key);\r\ndh->priv_key=BN_dup(dhp->priv_key);\r\nif ((dh->pub_key == NULL) ||\r\n(dh->priv_key == NULL))\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,ERR_R_DH_LIB);\r\ngoto err;\r\n}\r\n}\r\nr[0]=dh->p;\r\nr[1]=dh->g;\r\nr[2]=dh->pub_key;\r\n}\r\nelse\r\n#endif\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,SSL_R_UNKNOWN_KEY_EXCHANGE_TYPE);\r\ngoto f_err;\r\n}\r\nfor (i=0; r[i] != NULL; i++)\r\n{\r\nnr[i]=BN_num_bytes(r[i]);\r\nn+=2+nr[i];\r\n}\r\nif (!(s->s3->tmp.new_cipher->algorithms & SSL_aNULL))\r\n{\r\nif ((pkey=ssl_get_sign_pkey(s,s->s3->tmp.new_cipher))\r\n== NULL)\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\ngoto f_err;\r\n}\r\nkn=EVP_PKEY_size(pkey);\r\n}\r\nelse\r\n{\r\npkey=NULL;\r\nkn=0;\r\n}\r\nif (!BUF_MEM_grow(buf,n+4+kn))\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,ERR_LIB_BUF);\r\ngoto err;\r\n}\r\nd=(unsigned char *)s->init_buf->data;\r\np= &(d[4]);\r\nfor (i=0; r[i] != NULL; i++)\r\n{\r\ns2n(nr[i],p);\r\nBN_bn2bin(r[i],p);\r\np+=nr[i];\r\n}\r\nif (pkey != NULL)\r\n{\r\n#ifndef NO_RSA\r\nif (pkey->type == EVP_PKEY_RSA)\r\n{\r\nq=md_buf;\r\nj=0;\r\nfor (num=2; num > 0; num--)\r\n{\r\nEVP_DigestInit(&md_ctx,(num == 2)\r\n?s->ctx->md5:s->ctx->sha1);\r\nEVP_DigestUpdate(&md_ctx,&(s->s3->client_random[0]),SSL3_RANDOM_SIZE);\r\nEVP_DigestUpdate(&md_ctx,&(s->s3->server_random[0]),SSL3_RANDOM_SIZE);\r\nEVP_DigestUpdate(&md_ctx,&(d[4]),n);\r\nEVP_DigestFinal(&md_ctx,q,\r\n(unsigned int *)&i);\r\nq+=i;\r\nj+=i;\r\n}\r\ni=RSA_private_encrypt(j,md_buf,&(p[2]),\r\npkey->pkey.rsa,RSA_PKCS1_PADDING);\r\nif (i <= 0)\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,ERR_LIB_RSA);\r\ngoto err;\r\n}\r\ns2n(i,p);\r\nn+=i+2;\r\n}\r\nelse\r\n#endif\r\n#if !defined(NO_DSA)\r\nif (pkey->type == EVP_PKEY_DSA)\r\n{\r\nEVP_SignInit(&md_ctx,EVP_dss1());\r\nEVP_SignUpdate(&md_ctx,&(s->s3->client_random[0]),SSL3_RANDOM_SIZE);\r\nEVP_SignUpdate(&md_ctx,&(s->s3->server_random[0]),SSL3_RANDOM_SIZE);\r\nEVP_SignUpdate(&md_ctx,&(d[4]),n);\r\nif (!EVP_SignFinal(&md_ctx,&(p[2]),\r\n(unsigned int *)&i,pkey))\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,ERR_LIB_DSA);\r\ngoto err;\r\n}\r\ns2n(i,p);\r\nn+=i+2;\r\n}\r\nelse\r\n#endif\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_KEY_EXCHANGE,SSL_R_UNKNOWN_PKEY_TYPE);\r\ngoto f_err;\r\n}\r\n}\r\n*(d++)=SSL3_MT_SERVER_KEY_EXCHANGE;\r\nl2n3(n,d);\r\ns->init_num=n+4;\r\ns->init_off=0;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\nerr:\r\nreturn(-1);\r\n}\r\nstatic int ssl3_send_certificate_request(SSL *s)\r\n{\r\nunsigned char *p,*d;\r\nint i,j,nl,off,n;\r\nSTACK_OF(X509_NAME) *sk=NULL;\r\nX509_NAME *name;\r\nBUF_MEM *buf;\r\nif (s->state == SSL3_ST_SW_CERT_REQ_A)\r\n{\r\nbuf=s->init_buf;\r\nd=p=(unsigned char *)&(buf->data[4]);\r\np++;\r\nn=ssl3_get_req_cert_type(s,p);\r\nd[0]=n;\r\np+=n;\r\nn++;\r\noff=n;\r\np+=2;\r\nn+=2;\r\nsk=SSL_get_client_CA_list(s);\r\nnl=0;\r\nif (sk != NULL)\r\n{\r\nfor (i=0; i<sk_X509_NAME_num(sk); i++)\r\n{\r\nname=sk_X509_NAME_value(sk,i);\r\nj=i2d_X509_NAME(name,NULL);\r\nif (!BUF_MEM_grow(buf,4+n+j+2))\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_CERTIFICATE_REQUEST,ERR_R_BUF_LIB);\r\ngoto err;\r\n}\r\np=(unsigned char *)&(buf->data[4+n]);\r\nif (!(s->options & SSL_OP_NETSCAPE_CA_DN_BUG))\r\n{\r\ns2n(j,p);\r\ni2d_X509_NAME(name,&p);\r\nn+=2+j;\r\nnl+=2+j;\r\n}\r\nelse\r\n{\r\nd=p;\r\ni2d_X509_NAME(name,&p);\r\nj-=2; s2n(j,d); j+=2;\r\nn+=j;\r\nnl+=j;\r\n}\r\n}\r\n}\r\np=(unsigned char *)&(buf->data[4+off]);\r\ns2n(nl,p);\r\nd=(unsigned char *)buf->data;\r\n*(d++)=SSL3_MT_CERTIFICATE_REQUEST;\r\nl2n3(n,d);\r\ns->init_num=n+4;\r\ns->init_off=0;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\nerr:\r\nreturn(-1);\r\n}\r\nstatic int ssl3_get_client_key_exchange(SSL *s)\r\n{\r\nint i,al,ok;\r\nlong n;\r\nunsigned long l;\r\nunsigned char *p;\r\n#ifndef NO_RSA\r\nRSA *rsa=NULL;\r\nEVP_PKEY *pkey=NULL;\r\n#endif\r\n#ifndef NO_DH\r\nBIGNUM *pub=NULL;\r\nDH *dh_srvr;\r\n#endif\r\nn=ssl3_get_message(s,\r\nSSL3_ST_SR_KEY_EXCH_A,\r\nSSL3_ST_SR_KEY_EXCH_B,\r\nSSL3_MT_CLIENT_KEY_EXCHANGE,\r\n400,\r\n&ok);\r\nif (!ok) return((int)n);\r\np=(unsigned char *)s->init_buf->data;\r\nl=s->s3->tmp.new_cipher->algorithms;\r\n#ifndef NO_RSA\r\nif (l & SSL_kRSA)\r\n{\r\nif (s->s3->tmp.use_rsa_tmp)\r\n{\r\nif ((s->cert != NULL) && (s->cert->rsa_tmp != NULL))\r\nrsa=s->cert->rsa_tmp;\r\nif (rsa == NULL)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_MISSING_TMP_RSA_PKEY);\r\ngoto f_err;\r\n}\r\n}\r\nelse\r\n{\r\npkey=s->cert->pkeys[SSL_PKEY_RSA_ENC].privatekey;\r\nif ( (pkey == NULL) ||\r\n(pkey->type != EVP_PKEY_RSA) ||\r\n(pkey->pkey.rsa == NULL))\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_MISSING_RSA_CERTIFICATE);\r\ngoto f_err;\r\n}\r\nrsa=pkey->pkey.rsa;\r\n}\r\nif (s->version > SSL3_VERSION)\r\n{\r\nn2s(p,i);\r\nif (n != i+2)\r\n{\r\nif (!(s->options & SSL_OP_TLS_D5_BUG))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_TLS_RSA_ENCRYPTED_VALUE_LENGTH_IS_WRONG);\r\ngoto err;\r\n}\r\nelse\r\np-=2;\r\n}\r\nelse\r\nn=i;\r\n}\r\ni=RSA_private_decrypt((int)n,p,p,rsa,RSA_PKCS1_PADDING);\r\n#if 1\r\nif ((i != SSL_MAX_MASTER_KEY_LENGTH) ||\r\n((p[0] != (s->client_version>>8)) ||\r\n(p[1] != (s->client_version & 0xff))))\r\n{\r\nint bad=1;\r\nif ((i == SSL_MAX_MASTER_KEY_LENGTH) &&\r\n(p[0] == (s->version>>8)) &&\r\n(p[1] == 0))\r\n{\r\nif (s->options & SSL_OP_TLS_ROLLBACK_BUG)\r\nbad=0;\r\n}\r\nif (bad)\r\n{\r\np[0]=(s->version>>8);\r\np[1]=(s->version & 0xff);\r\nRAND_bytes(&(p[2]),SSL_MAX_MASTER_KEY_LENGTH-2);\r\ni=SSL_MAX_MASTER_KEY_LENGTH;\r\n}\r\n}\r\n#else\r\nif (i != SSL_MAX_MASTER_KEY_LENGTH)\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_BAD_RSA_DECRYPT);\r\ngoto f_err;\r\n}\r\nif ((p[0] != (s->version>>8)) || (p[1] != (s->version & 0xff)))\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_BAD_PROTOCOL_VERSION_NUMBER);\r\ngoto f_err;\r\n}\r\n#endif\r\ns->session->master_key_length=\r\ns->method->ssl3_enc->generate_master_secret(s,\r\ns->session->master_key,\r\np,i);\r\nmemset(p,0,i);\r\n}\r\nelse\r\n#endif\r\n#ifndef NO_DH\r\nif (l & (SSL_kEDH|SSL_kDHr|SSL_kDHd))\r\n{\r\nn2s(p,i);\r\nif (n != i+2)\r\n{\r\nif (!(s->options & SSL_OP_SSLEAY_080_CLIENT_DH_BUG))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_DH_PUBLIC_VALUE_LENGTH_IS_WRONG);\r\ngoto err;\r\n}\r\nelse\r\n{\r\np-=2;\r\ni=(int)n;\r\n}\r\n}\r\nif (n == 0L)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_UNABLE_TO_DECODE_DH_CERTS);\r\ngoto f_err;\r\n}\r\nelse\r\n{\r\nif (s->s3->tmp.dh == NULL)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_MISSING_TMP_DH_KEY);\r\ngoto f_err;\r\n}\r\nelse\r\ndh_srvr=s->s3->tmp.dh;\r\n}\r\npub=BN_bin2bn(p,i,NULL);\r\nif (pub == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_BN_LIB);\r\ngoto err;\r\n}\r\ni=DH_compute_key(p,pub,dh_srvr);\r\nif (i <= 0)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,ERR_R_DH_LIB);\r\ngoto err;\r\n}\r\nDH_free(s->s3->tmp.dh);\r\ns->s3->tmp.dh=NULL;\r\nBN_clear_free(pub);\r\npub=NULL;\r\ns->session->master_key_length=\r\ns->method->ssl3_enc->generate_master_secret(s,\r\ns->session->master_key,p,i);\r\n}\r\nelse\r\n#endif\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_KEY_EXCHANGE,SSL_R_UNKNOWN_CIPHER_TYPE);\r\ngoto f_err;\r\n}\r\nreturn(1);\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\n#if !defined(NO_DH) || !defined(NO_RSA)\r\nerr:\r\n#endif\r\nreturn(-1);\r\n}\r\nstatic int ssl3_get_cert_verify(SSL *s)\r\n{\r\nEVP_PKEY *pkey=NULL;\r\nunsigned char *p;\r\nint al,ok,ret=0;\r\nlong n;\r\nint type=0,i,j;\r\nX509 *peer;\r\nn=ssl3_get_message(s,\r\nSSL3_ST_SR_CERT_VRFY_A,\r\nSSL3_ST_SR_CERT_VRFY_B,\r\n-1,\r\n512,\r\n&ok);\r\nif (!ok) return((int)n);\r\nif (s->session->peer != NULL)\r\n{\r\npeer=s->session->peer;\r\npkey=X509_get_pubkey(peer);\r\ntype=X509_certificate_type(peer,pkey);\r\n}\r\nelse\r\n{\r\npeer=NULL;\r\npkey=NULL;\r\n}\r\nif (s->s3->tmp.message_type != SSL3_MT_CERTIFICATE_VERIFY)\r\n{\r\ns->s3->tmp.reuse_message=1;\r\nif ((peer != NULL) && (type | EVP_PKT_SIGN))\r\n{\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_MISSING_VERIFY_MESSAGE);\r\ngoto f_err;\r\n}\r\nret=1;\r\ngoto end;\r\n}\r\nif (peer == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_NO_CLIENT_CERT_RECEIVED);\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\ngoto f_err;\r\n}\r\nif (!(type & EVP_PKT_SIGN))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_SIGNATURE_FOR_NON_SIGNING_CERTIFICATE);\r\nal=SSL_AD_ILLEGAL_PARAMETER;\r\ngoto f_err;\r\n}\r\nif (s->s3->change_cipher_spec)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_CCS_RECEIVED_EARLY);\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\ngoto f_err;\r\n}\r\np=(unsigned char *)s->init_buf->data;\r\nn2s(p,i);\r\nn-=2;\r\nif (i > n)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_LENGTH_MISMATCH);\r\nal=SSL_AD_DECODE_ERROR;\r\ngoto f_err;\r\n}\r\nj=EVP_PKEY_size(pkey);\r\nif ((i > j) || (n > j) || (n <= 0))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_WRONG_SIGNATURE_SIZE);\r\nal=SSL_AD_DECODE_ERROR;\r\ngoto f_err;\r\n}\r\n#ifndef NO_RSA\r\nif (pkey->type == EVP_PKEY_RSA)\r\n{\r\ni=RSA_public_decrypt(i,p,p,pkey->pkey.rsa,RSA_PKCS1_PADDING);\r\nif (i < 0)\r\n{\r\nal=SSL_AD_DECRYPT_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_BAD_RSA_DECRYPT);\r\ngoto f_err;\r\n}\r\nif ((i != (MD5_DIGEST_LENGTH+SHA_DIGEST_LENGTH)) ||\r\nmemcmp(&(s->s3->tmp.finish_md[0]),p,\r\nMD5_DIGEST_LENGTH+SHA_DIGEST_LENGTH))\r\n{\r\nal=SSL_AD_DECRYPT_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_BAD_RSA_SIGNATURE);\r\ngoto f_err;\r\n}\r\n}\r\nelse\r\n#endif\r\n#ifndef NO_DSA\r\nif (pkey->type == EVP_PKEY_DSA)\r\n{\r\nj=DSA_verify(pkey->save_type,\r\n&(s->s3->tmp.finish_md[MD5_DIGEST_LENGTH]),\r\nSHA_DIGEST_LENGTH,p,i,pkey->pkey.dsa);\r\nif (j <= 0)\r\n{\r\nal=SSL_AD_DECRYPT_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_BAD_DSA_SIGNATURE);\r\ngoto f_err;\r\n}\r\n}\r\nelse\r\n#endif\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CERT_VERIFY,SSL_R_INTERNAL_ERROR);\r\nal=SSL_AD_UNSUPPORTED_CERTIFICATE;\r\ngoto f_err;\r\n}\r\nret=1;\r\nif (0)\r\n{\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\n}\r\nend:\r\nEVP_PKEY_free(pkey);\r\nreturn(ret);\r\n}\r\nstatic int ssl3_get_client_certificate(SSL *s)\r\n{\r\nint i,ok,al,ret= -1;\r\nX509 *x=NULL;\r\nunsigned long l,nc,llen,n;\r\nunsigned char *p,*d,*q;\r\nSTACK_OF(X509) *sk=NULL;\r\nn=ssl3_get_message(s,\r\nSSL3_ST_SR_CERT_A,\r\nSSL3_ST_SR_CERT_B,\r\n-1,\r\n#if defined(MSDOS) && !defined(WIN32)\r\n1024*30,\r\n#else\r\n1024*100,\r\n#endif\r\n&ok);\r\nif (!ok) return((int)n);\r\nif (s->s3->tmp.message_type == SSL3_MT_CLIENT_KEY_EXCHANGE)\r\n{\r\nif ( (s->verify_mode & SSL_VERIFY_PEER) &&\r\n(s->verify_mode & SSL_VERIFY_FAIL_IF_NO_PEER_CERT))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_PEER_DID_NOT_RETURN_A_CERTIFICATE);\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\ngoto f_err;\r\n}\r\nif ((s->version > SSL3_VERSION) && s->s3->tmp.cert_request)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_TLS_PEER_DID_NOT_RESPOND_WITH_CERTIFICATE_LIST);\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\ngoto f_err;\r\n}\r\ns->s3->tmp.reuse_message=1;\r\nreturn(1);\r\n}\r\nif (s->s3->tmp.message_type != SSL3_MT_CERTIFICATE)\r\n{\r\nal=SSL_AD_UNEXPECTED_MESSAGE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_WRONG_MESSAGE_TYPE);\r\ngoto f_err;\r\n}\r\nd=p=(unsigned char *)s->init_buf->data;\r\nif ((sk=sk_X509_new_null()) == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nn2l3(p,llen);\r\nif (llen+3 != n)\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_LENGTH_MISMATCH);\r\ngoto f_err;\r\n}\r\nfor (nc=0; nc<llen; )\r\n{\r\nn2l3(p,l);\r\nif ((l+nc+3) > llen)\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_CERT_LENGTH_MISMATCH);\r\ngoto f_err;\r\n}\r\nq=p;\r\nx=d2i_X509(NULL,&p,l);\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,ERR_R_ASN1_LIB);\r\ngoto err;\r\n}\r\nif (p != (q+l))\r\n{\r\nal=SSL_AD_DECODE_ERROR;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_CERT_LENGTH_MISMATCH);\r\ngoto f_err;\r\n}\r\nif (!sk_X509_push(sk,x))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nx=NULL;\r\nnc+=l+3;\r\n}\r\nif (sk_X509_num(sk) <= 0)\r\n{\r\nif (s->version == SSL3_VERSION)\r\n{\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_NO_CERTIFICATES_RETURNED);\r\ngoto f_err;\r\n}\r\nelse if ((s->verify_mode & SSL_VERIFY_PEER) &&\r\n(s->verify_mode & SSL_VERIFY_FAIL_IF_NO_PEER_CERT))\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_PEER_DID_NOT_RETURN_A_CERTIFICATE);\r\nal=SSL_AD_HANDSHAKE_FAILURE;\r\ngoto f_err;\r\n}\r\n}\r\nelse\r\n{\r\ni=ssl_verify_cert_chain(s,sk);\r\nif (!i)\r\n{\r\nal=ssl_verify_alarm_type(s->verify_result);\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE,SSL_R_NO_CERTIFICATE_RETURNED);\r\ngoto f_err;\r\n}\r\n}\r\nif (s->session->peer != NULL)\r\nX509_free(s->session->peer);\r\ns->session->peer=sk_X509_shift(sk);\r\nif (s->session->sess_cert == NULL)\r\n{\r\ns->session->sess_cert = ssl_sess_cert_new();\r\nif (s->session->sess_cert == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_GET_CLIENT_CERTIFICATE, ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\nif (s->session->sess_cert->cert_chain != NULL)\r\nsk_X509_pop_free(s->session->sess_cert->cert_chain, X509_free);\r\ns->session->sess_cert->cert_chain=sk;\r\nsk=NULL;\r\nret=1;\r\nif (0)\r\n{\r\nf_err:\r\nssl3_send_alert(s,SSL3_AL_FATAL,al);\r\n}\r\nerr:\r\nif (x != NULL) X509_free(x);\r\nif (sk != NULL) sk_X509_pop_free(sk,X509_free);\r\nreturn(ret);\r\n}\r\nint ssl3_send_server_certificate(SSL *s)\r\n{\r\nunsigned long l;\r\nX509 *x;\r\nif (s->state == SSL3_ST_SW_CERT_A)\r\n{\r\nx=ssl_get_server_send_cert(s);\r\nif (x == NULL)\r\n{\r\nSSLerr(SSL_F_SSL3_SEND_SERVER_CERTIFICATE,SSL_R_INTERNAL_ERROR);\r\nreturn(0);\r\n}\r\nl=ssl3_output_cert_chain(s,x);\r\ns->state=SSL3_ST_SW_CERT_B;\r\ns->init_num=(int)l;\r\ns->init_off=0;\r\n}\r\nreturn(ssl3_do_write(s,SSL3_RT_HANDSHAKE));\r\n}

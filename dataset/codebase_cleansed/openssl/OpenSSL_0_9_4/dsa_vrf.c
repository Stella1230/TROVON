int DSA_do_verify(const unsigned char *dgst, int dgst_len, DSA_SIG *sig,\r\nDSA *dsa)\r\n{\r\nBN_CTX *ctx;\r\nBIGNUM u1,u2,t1;\r\nBN_MONT_CTX *mont=NULL;\r\nint ret = -1;\r\nif ((ctx=BN_CTX_new()) == NULL) goto err;\r\nBN_init(&u1);\r\nBN_init(&u2);\r\nBN_init(&t1);\r\nif ((BN_mod_inverse(&u2,sig->s,dsa->q,ctx)) == NULL) goto err;\r\nif (BN_bin2bn(dgst,dgst_len,&u1) == NULL) goto err;\r\nif (!BN_mod_mul(&u1,&u1,&u2,dsa->q,ctx)) goto err;\r\nif (!BN_mod_mul(&u2,sig->r,&u2,dsa->q,ctx)) goto err;\r\nif ((dsa->method_mont_p == NULL) && (dsa->flags & DSA_FLAG_CACHE_MONT_P))\r\n{\r\nif ((dsa->method_mont_p=(char *)BN_MONT_CTX_new()) != NULL)\r\nif (!BN_MONT_CTX_set((BN_MONT_CTX *)dsa->method_mont_p,\r\ndsa->p,ctx)) goto err;\r\n}\r\nmont=(BN_MONT_CTX *)dsa->method_mont_p;\r\n#if 0\r\n{\r\nBIGNUM t2;\r\nBN_init(&t2);\r\nif (!BN_mod_exp_mont(&t1,dsa->g,&u1,dsa->p,ctx,mont)) goto err;\r\nif (!BN_mod_exp_mont(&t2,dsa->pub_key,&u2,dsa->p,ctx,mont)) goto err;\r\nif (!BN_mod_mul(&u1,&t1,&t2,dsa->p,ctx)) goto err_bn;\r\nBN_free(&t2);\r\n}\r\nif (!BN_mod(&u1,&u1,dsa->q,ctx)) goto err;\r\n#else\r\n{\r\nif (!BN_mod_exp2_mont(&t1,dsa->g,&u1,dsa->pub_key,&u2,dsa->p,ctx,mont))\r\ngoto err;\r\nif (!BN_mod(&u1,&t1,dsa->q,ctx)) goto err;\r\n}\r\n#endif\r\nret=(BN_ucmp(&u1, sig->r) == 0);\r\nerr:\r\nif (ret != 1) DSAerr(DSA_F_DSA_DO_VERIFY,ERR_R_BN_LIB);\r\nif (ctx != NULL) BN_CTX_free(ctx);\r\nBN_free(&u1);\r\nBN_free(&u2);\r\nBN_free(&t1);\r\nreturn(ret);\r\n}\r\nint DSA_verify(int type, const unsigned char *dgst, int dgst_len,\r\nunsigned char *sigbuf, int siglen, DSA *dsa)\r\n{\r\nDSA_SIG *s;\r\nint ret=-1;\r\ns = DSA_SIG_new();\r\nif (s == NULL) return(ret);\r\nif (d2i_DSA_SIG(&s,&sigbuf,siglen) == NULL) goto err;\r\nret=DSA_do_verify(dgst,dgst_len,s,dsa);\r\nerr:\r\nDSA_SIG_free(s);\r\nreturn(ret);\r\n}

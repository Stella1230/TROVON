int X509V3_EXT_add(X509V3_EXT_METHOD *ext)\r\n{\r\nif(!ext_list && !(ext_list = sk_new(ext_cmp))) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nif(!sk_push(ext_list, (char *)ext)) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int ext_cmp(X509V3_EXT_METHOD **a, X509V3_EXT_METHOD **b)\r\n{\r\nreturn ((*a)->ext_nid - (*b)->ext_nid);\r\n}\r\nX509V3_EXT_METHOD *X509V3_EXT_get_nid(int nid)\r\n{\r\nX509V3_EXT_METHOD tmp;\r\nint idx;\r\ntmp.ext_nid = nid;\r\nif(!ext_list || (tmp.ext_nid < 0) ) return NULL;\r\nidx = sk_find(ext_list, (char *)&tmp);\r\nif(idx == -1) return NULL;\r\nreturn (X509V3_EXT_METHOD *)sk_value(ext_list, idx);\r\n}\r\nX509V3_EXT_METHOD *X509V3_EXT_get(X509_EXTENSION *ext)\r\n{\r\nint nid;\r\nif((nid = OBJ_obj2nid(ext->object)) == NID_undef) return NULL;\r\nreturn X509V3_EXT_get_nid(nid);\r\n}\r\nint X509V3_EXT_add_list(X509V3_EXT_METHOD *extlist)\r\n{\r\nfor(;extlist->ext_nid!=-1;extlist++)\r\nif(!X509V3_EXT_add(extlist)) return 0;\r\nreturn 1;\r\n}\r\nint X509V3_EXT_add_alias(int nid_to, int nid_from)\r\n{\r\nX509V3_EXT_METHOD *ext, *tmpext;\r\nif(!(ext = X509V3_EXT_get_nid(nid_from))) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD_ALIAS,X509V3_R_EXTENSION_NOT_FOUND);\r\nreturn 0;\r\n}\r\nif(!(tmpext = (X509V3_EXT_METHOD *)Malloc(sizeof(X509V3_EXT_METHOD)))) {\r\nX509V3err(X509V3_F_X509V3_EXT_ADD_ALIAS,ERR_R_MALLOC_FAILURE);\r\nreturn 0;\r\n}\r\n*tmpext = *ext;\r\ntmpext->ext_nid = nid_to;\r\ntmpext->ext_flags |= X509V3_EXT_DYNAMIC;\r\nreturn 1;\r\n}\r\nvoid X509V3_EXT_cleanup(void)\r\n{\r\nsk_pop_free(ext_list, ext_list_free);\r\next_list = NULL;\r\n}\r\nstatic void ext_list_free(X509V3_EXT_METHOD *ext)\r\n{\r\nif(ext->ext_flags & X509V3_EXT_DYNAMIC) Free(ext);\r\n}\r\nint X509V3_add_standard_extensions(void)\r\n{\r\nX509V3_EXT_add_list(v3_ns_ia5_list);\r\nX509V3_EXT_add_list(v3_alt);\r\nX509V3_EXT_add(&v3_bcons);\r\nX509V3_EXT_add(&v3_nscert);\r\nX509V3_EXT_add(&v3_key_usage);\r\nX509V3_EXT_add(&v3_ext_ku);\r\nX509V3_EXT_add(&v3_skey_id);\r\nX509V3_EXT_add(&v3_akey_id);\r\nX509V3_EXT_add(&v3_pkey_usage_period);\r\nX509V3_EXT_add(&v3_crl_num);\r\nX509V3_EXT_add(&v3_sxnet);\r\nX509V3_EXT_add(&v3_crl_reason);\r\nX509V3_EXT_add(&v3_cpols);\r\nX509V3_EXT_add(&v3_crld);\r\nreturn 1;\r\n}\r\nvoid *X509V3_EXT_d2i(X509_EXTENSION *ext)\r\n{\r\nX509V3_EXT_METHOD *method;\r\nunsigned char *p;\r\nif(!(method = X509V3_EXT_get(ext)) || !method->d2i) return NULL;\r\np = ext->value->data;\r\nreturn method->d2i(NULL, &p, ext->value->length);\r\n}

int i2d_Netscape_RSA(RSA *a, unsigned char **pp, int (*cb)())\r\n{\r\nint i,j,l[6];\r\nNETSCAPE_PKEY *pkey;\r\nunsigned char buf[256],*zz;\r\nunsigned char key[EVP_MAX_KEY_LENGTH];\r\nEVP_CIPHER_CTX ctx;\r\nX509_ALGOR *alg=NULL;\r\nASN1_OCTET_STRING os,os2;\r\nM_ASN1_I2D_vars(a);\r\nif (a == NULL) return(0);\r\n#ifdef WIN32\r\nr=r;\r\n#endif\r\nos.data=os2.data=NULL;\r\nif ((pkey=NETSCAPE_PKEY_new()) == NULL) goto err;\r\nif (!ASN1_INTEGER_set(pkey->version,0)) goto err;\r\nif (pkey->algor->algorithm != NULL)\r\nASN1_OBJECT_free(pkey->algor->algorithm);\r\npkey->algor->algorithm=OBJ_nid2obj(NID_rsaEncryption);\r\nif ((pkey->algor->parameter=ASN1_TYPE_new()) == NULL) goto err;\r\npkey->algor->parameter->type=V_ASN1_NULL;\r\nl[0]=i2d_RSAPrivateKey(a,NULL);\r\npkey->private_key->length=l[0];\r\nos2.length=i2d_NETSCAPE_PKEY(pkey,NULL);\r\nl[1]=i2d_ASN1_OCTET_STRING(&os2,NULL);\r\nif ((alg=X509_ALGOR_new()) == NULL) goto err;\r\nif (alg->algorithm != NULL)\r\nASN1_OBJECT_free(alg->algorithm);\r\nalg->algorithm=OBJ_nid2obj(NID_rc4);\r\nif ((alg->parameter=ASN1_TYPE_new()) == NULL) goto err;\r\nalg->parameter->type=V_ASN1_NULL;\r\nl[2]=i2d_X509_ALGOR(alg,NULL);\r\nl[3]=ASN1_object_size(1,l[2]+l[1],V_ASN1_SEQUENCE);\r\n#ifndef CONST_STRICT\r\nos.data=(unsigned char *)"private-key";\r\n#endif\r\nos.length=11;\r\nl[4]=i2d_ASN1_OCTET_STRING(&os,NULL);\r\nl[5]=ASN1_object_size(1,l[4]+l[3],V_ASN1_SEQUENCE);\r\nif (pp == NULL)\r\n{\r\nif (pkey != NULL) NETSCAPE_PKEY_free(pkey);\r\nif (alg != NULL) X509_ALGOR_free(alg);\r\nreturn(l[5]);\r\n}\r\nif (pkey->private_key->data != NULL)\r\nFree((char *)pkey->private_key->data);\r\nif ((pkey->private_key->data=(unsigned char *)Malloc(l[0])) == NULL)\r\n{\r\nASN1err(ASN1_F_I2D_NETSCAPE_RSA,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nzz=pkey->private_key->data;\r\ni2d_RSAPrivateKey(a,&zz);\r\nif ((os2.data=(unsigned char *)Malloc(os2.length)) == NULL)\r\n{\r\nASN1err(ASN1_F_I2D_NETSCAPE_RSA,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nzz=os2.data;\r\ni2d_NETSCAPE_PKEY(pkey,&zz);\r\nif (cb == NULL)\r\ncb=EVP_read_pw_string;\r\ni=cb(buf,256,"Enter Private Key password:",1);\r\nif (i != 0)\r\n{\r\nASN1err(ASN1_F_I2D_NETSCAPE_RSA,ASN1_R_BAD_PASSWORD_READ);\r\ngoto err;\r\n}\r\nEVP_BytesToKey(EVP_rc4(),EVP_md5(),NULL,buf,\r\nstrlen((char *)buf),1,key,NULL);\r\nmemset(buf,0,256);\r\nEVP_CIPHER_CTX_init(&ctx);\r\nEVP_EncryptInit(&ctx,EVP_rc4(),key,NULL);\r\nEVP_EncryptUpdate(&ctx,os2.data,&i,os2.data,os2.length);\r\nEVP_EncryptFinal(&ctx,&(os2.data[i]),&j);\r\nEVP_CIPHER_CTX_cleanup(&ctx);\r\np= *pp;\r\nASN1_put_object(&p,1,l[4]+l[3],V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_ASN1_OCTET_STRING(&os,&p);\r\nASN1_put_object(&p,1,l[2]+l[1],V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_X509_ALGOR(alg,&p);\r\ni2d_ASN1_OCTET_STRING(&os2,&p);\r\nret=l[5];\r\nerr:\r\nif (os2.data != NULL) Free(os2.data);\r\nif (alg != NULL) X509_ALGOR_free(alg);\r\nif (pkey != NULL) NETSCAPE_PKEY_free(pkey);\r\nr=r;\r\nreturn(ret);\r\n}\r\nRSA *d2i_Netscape_RSA(RSA **a, unsigned char **pp, long length, int (*cb)())\r\n{\r\nRSA *ret=NULL;\r\nASN1_OCTET_STRING *os=NULL;\r\nASN1_CTX c;\r\nc.pp=pp;\r\nc.error=ASN1_R_DECODING_ERROR;\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(os,d2i_ASN1_OCTET_STRING);\r\nif ((os->length != 11) || (strncmp("private-key",\r\n(char *)os->data,os->length) != 0))\r\n{\r\nASN1err(ASN1_F_D2I_NETSCAPE_RSA,ASN1_R_PRIVATE_KEY_HEADER_MISSING);\r\nASN1_BIT_STRING_free(os);\r\ngoto err;\r\n}\r\nASN1_BIT_STRING_free(os);\r\nc.q=c.p;\r\nif ((ret=d2i_Netscape_RSA_2(a,&c.p,c.slen,cb)) == NULL) goto err;\r\nc.slen-=(c.p-c.q);\r\nM_ASN1_D2I_Finish(a,RSA_free,ASN1_F_D2I_NETSCAPE_RSA);\r\n}\r\nRSA *d2i_Netscape_RSA_2(RSA **a, unsigned char **pp, long length,\r\nint (*cb)())\r\n{\r\nNETSCAPE_PKEY *pkey=NULL;\r\nRSA *ret=NULL;\r\nint i,j;\r\nunsigned char buf[256],*zz;\r\nunsigned char key[EVP_MAX_KEY_LENGTH];\r\nEVP_CIPHER_CTX ctx;\r\nX509_ALGOR *alg=NULL;\r\nASN1_OCTET_STRING *os=NULL;\r\nASN1_CTX c;\r\nc.error=ERR_R_NESTED_ASN1_ERROR;\r\nc.pp=pp;\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(alg,d2i_X509_ALGOR);\r\nif (OBJ_obj2nid(alg->algorithm) != NID_rc4)\r\n{\r\nASN1err(ASN1_F_D2I_NETSCAPE_RSA_2,ASN1_R_UNSUPPORTED_ENCRYPTION_ALGORITHM);\r\ngoto err;\r\n}\r\nM_ASN1_D2I_get(os,d2i_ASN1_OCTET_STRING);\r\nif (cb == NULL)\r\ncb=EVP_read_pw_string;\r\ni=cb(buf,256,"Enter Private Key password:",0);\r\nif (i != 0)\r\n{\r\nASN1err(ASN1_F_D2I_NETSCAPE_RSA_2,ASN1_R_BAD_PASSWORD_READ);\r\ngoto err;\r\n}\r\nEVP_BytesToKey(EVP_rc4(),EVP_md5(),NULL,buf,\r\nstrlen((char *)buf),1,key,NULL);\r\nmemset(buf,0,256);\r\nEVP_CIPHER_CTX_init(&ctx);\r\nEVP_DecryptInit(&ctx,EVP_rc4(),key,NULL);\r\nEVP_DecryptUpdate(&ctx,os->data,&i,os->data,os->length);\r\nEVP_DecryptFinal(&ctx,&(os->data[i]),&j);\r\nEVP_CIPHER_CTX_cleanup(&ctx);\r\nos->length=i+j;\r\nzz=os->data;\r\nif ((pkey=d2i_NETSCAPE_PKEY(NULL,&zz,os->length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_NETSCAPE_RSA_2,ASN1_R_UNABLE_TO_DECODE_RSA_PRIVATE_KEY);\r\ngoto err;\r\n}\r\nzz=pkey->private_key->data;\r\nif ((ret=d2i_RSAPrivateKey(a,&zz,pkey->private_key->length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_NETSCAPE_RSA_2,ASN1_R_UNABLE_TO_DECODE_RSA_KEY);\r\ngoto err;\r\n}\r\nif (!asn1_Finish(&c)) goto err;\r\n*pp=c.p;\r\nerr:\r\nif (pkey != NULL) NETSCAPE_PKEY_free(pkey);\r\nif (os != NULL) ASN1_BIT_STRING_free(os);\r\nif (alg != NULL) X509_ALGOR_free(alg);\r\nreturn(ret);\r\n}\r\nstatic int i2d_NETSCAPE_PKEY(NETSCAPE_PKEY *a, unsigned char **pp)\r\n{\r\nM_ASN1_I2D_vars(a);\r\nM_ASN1_I2D_len(a->version, i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_len(a->algor, i2d_X509_ALGOR);\r\nM_ASN1_I2D_len(a->private_key, i2d_ASN1_OCTET_STRING);\r\nM_ASN1_I2D_seq_total();\r\nM_ASN1_I2D_put(a->version, i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_put(a->algor, i2d_X509_ALGOR);\r\nM_ASN1_I2D_put(a->private_key, i2d_ASN1_OCTET_STRING);\r\nM_ASN1_I2D_finish();\r\n}\r\nstatic NETSCAPE_PKEY *d2i_NETSCAPE_PKEY(NETSCAPE_PKEY **a, unsigned char **pp,\r\nlong length)\r\n{\r\nM_ASN1_D2I_vars(a,NETSCAPE_PKEY *,NETSCAPE_PKEY_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(ret->version,d2i_ASN1_INTEGER);\r\nM_ASN1_D2I_get(ret->algor,d2i_X509_ALGOR);\r\nM_ASN1_D2I_get(ret->private_key,d2i_ASN1_OCTET_STRING);\r\nM_ASN1_D2I_Finish(a,NETSCAPE_PKEY_free,ASN1_F_D2I_NETSCAPE_PKEY);\r\n}\r\nstatic NETSCAPE_PKEY *NETSCAPE_PKEY_new(void)\r\n{\r\nNETSCAPE_PKEY *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret,NETSCAPE_PKEY);\r\nM_ASN1_New(ret->version,ASN1_INTEGER_new);\r\nM_ASN1_New(ret->algor,X509_ALGOR_new);\r\nM_ASN1_New(ret->private_key,ASN1_OCTET_STRING_new);\r\nreturn(ret);\r\nM_ASN1_New_Error(ASN1_F_NETSCAPE_PKEY_NEW);\r\n}\r\nstatic void NETSCAPE_PKEY_free(NETSCAPE_PKEY *a)\r\n{\r\nif (a == NULL) return;\r\nASN1_INTEGER_free(a->version);\r\nX509_ALGOR_free(a->algor);\r\nASN1_OCTET_STRING_free(a->private_key);\r\nFree((char *)a);\r\n}

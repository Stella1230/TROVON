int EVP_OpenInit(EVP_CIPHER_CTX *ctx, EVP_CIPHER *type, unsigned char *ek,\r\nint ekl, unsigned char *iv, EVP_PKEY *priv)\r\n{\r\nunsigned char *key=NULL;\r\nint i,size=0,ret=0;\r\nif (priv->type != EVP_PKEY_RSA)\r\n{\r\nEVPerr(EVP_F_EVP_OPENINIT,EVP_R_PUBLIC_KEY_NOT_RSA);\r\nret= -1;\r\ngoto err;\r\n}\r\nsize=RSA_size(priv->pkey.rsa);\r\nkey=(unsigned char *)Malloc(size+2);\r\nif (key == NULL)\r\n{\r\nEVPerr(EVP_F_EVP_OPENINIT,ERR_R_MALLOC_FAILURE);\r\nret= -1;\r\ngoto err;\r\n}\r\ni=EVP_PKEY_decrypt(key,ek,ekl,priv);\r\nif (i != type->key_len)\r\n{\r\ngoto err;\r\n}\r\nEVP_CIPHER_CTX_init(ctx);\r\nEVP_DecryptInit(ctx,type,key,iv);\r\nret=1;\r\nerr:\r\nif (key != NULL) memset(key,0,size);\r\nFree(key);\r\nreturn(ret);\r\n}\r\nint EVP_OpenFinal(EVP_CIPHER_CTX *ctx, unsigned char *out, int *outl)\r\n{\r\nint i;\r\ni=EVP_DecryptFinal(ctx,out,outl);\r\nEVP_DecryptInit(ctx,NULL,NULL,NULL);\r\nreturn(i);\r\n}

X509_REQ *X509_to_X509_REQ(X509 *x, EVP_PKEY *pkey, EVP_MD *md)\r\n{\r\nX509_REQ *ret;\r\nX509_REQ_INFO *ri;\r\nint i;\r\nEVP_PKEY *pktmp;\r\nret=X509_REQ_new();\r\nif (ret == NULL)\r\n{\r\nX509err(X509_F_X509_TO_X509_REQ,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nri=ret->req_info;\r\nri->version->length=1;\r\nri->version->data=(unsigned char *)Malloc(1);\r\nif (ri->version->data == NULL) goto err;\r\nri->version->data[0]=0;\r\nif (!X509_REQ_set_subject_name(ret,X509_get_subject_name(x)))\r\ngoto err;\r\npktmp = X509_get_pubkey(x);\r\ni=X509_REQ_set_pubkey(ret,pktmp);\r\nEVP_PKEY_free(pktmp);\r\nif (!i) goto err;\r\nif (pkey != NULL)\r\n{\r\nif (!X509_REQ_sign(ret,pkey,md))\r\ngoto err;\r\n}\r\nreturn(ret);\r\nerr:\r\nX509_REQ_free(ret);\r\nreturn(NULL);\r\n}\r\nEVP_PKEY *X509_REQ_get_pubkey(X509_REQ *req)\r\n{\r\nif ((req == NULL) || (req->req_info == NULL))\r\nreturn(NULL);\r\nreturn(X509_PUBKEY_get(req->req_info->pubkey));\r\n}

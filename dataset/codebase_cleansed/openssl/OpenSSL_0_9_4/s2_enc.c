int ssl2_enc_init(SSL *s, int client)\r\n{\r\nEVP_CIPHER_CTX *rs,*ws;\r\nconst EVP_CIPHER *c;\r\nconst EVP_MD *md;\r\nint num;\r\nif (!ssl_cipher_get_evp(s->session,&c,&md,NULL))\r\n{\r\nssl2_return_error(s,SSL2_PE_NO_CIPHER);\r\nSSLerr(SSL_F_SSL2_ENC_INIT,SSL_R_PROBLEMS_MAPPING_CIPHER_FUNCTIONS);\r\nreturn(0);\r\n}\r\ns->read_hash=md;\r\ns->write_hash=md;\r\nif ((s->enc_read_ctx == NULL) &&\r\n((s->enc_read_ctx=(EVP_CIPHER_CTX *)\r\nMalloc(sizeof(EVP_CIPHER_CTX))) == NULL))\r\ngoto err;\r\nif ((s->enc_write_ctx == NULL) &&\r\n((s->enc_write_ctx=(EVP_CIPHER_CTX *)\r\nMalloc(sizeof(EVP_CIPHER_CTX))) == NULL))\r\ngoto err;\r\nrs= s->enc_read_ctx;\r\nws= s->enc_write_ctx;\r\nEVP_CIPHER_CTX_init(rs);\r\nEVP_CIPHER_CTX_init(ws);\r\nnum=c->key_len;\r\ns->s2->key_material_length=num*2;\r\nssl2_generate_key_material(s);\r\nEVP_EncryptInit(ws,c,&(s->s2->key_material[(client)?num:0]),\r\ns->session->key_arg);\r\nEVP_DecryptInit(rs,c,&(s->s2->key_material[(client)?0:num]),\r\ns->session->key_arg);\r\ns->s2->read_key= &(s->s2->key_material[(client)?0:num]);\r\ns->s2->write_key= &(s->s2->key_material[(client)?num:0]);\r\nreturn(1);\r\nerr:\r\nSSLerr(SSL_F_SSL2_ENC_INIT,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nvoid ssl2_enc(SSL *s, int send)\r\n{\r\nEVP_CIPHER_CTX *ds;\r\nunsigned long l;\r\nint bs;\r\nif (send)\r\n{\r\nds=s->enc_write_ctx;\r\nl=s->s2->wlength;\r\n}\r\nelse\r\n{\r\nds=s->enc_read_ctx;\r\nl=s->s2->rlength;\r\n}\r\nif (ds == NULL) return;\r\nbs=ds->cipher->block_size;\r\nif (bs == 8)\r\nl=(l+7)/8*8;\r\nEVP_Cipher(ds,s->s2->mac_data,s->s2->mac_data,l);\r\n}\r\nvoid ssl2_mac(SSL *s, unsigned char *md, int send)\r\n{\r\nEVP_MD_CTX c;\r\nunsigned char sequence[4],*p,*sec,*act;\r\nunsigned long seq;\r\nunsigned int len;\r\nif (send)\r\n{\r\nseq=s->s2->write_sequence;\r\nsec=s->s2->write_key;\r\nlen=s->s2->wact_data_length;\r\nact=s->s2->wact_data;\r\n}\r\nelse\r\n{\r\nseq=s->s2->read_sequence;\r\nsec=s->s2->read_key;\r\nlen=s->s2->ract_data_length;\r\nact=s->s2->ract_data;\r\n}\r\np= &(sequence[0]);\r\nl2n(seq,p);\r\nEVP_DigestInit(&c,s->read_hash);\r\nEVP_DigestUpdate(&c,sec,\r\nEVP_CIPHER_CTX_key_length(s->enc_read_ctx));\r\nEVP_DigestUpdate(&c,act,len);\r\nEVP_DigestUpdate(&c,sequence,4);\r\nEVP_DigestFinal(&c,md,NULL);\r\n}

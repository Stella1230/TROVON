BN_ULONG BN_mod_word(BIGNUM *a, BN_ULONG w)\r\n{\r\n#ifndef BN_LLONG\r\nBN_ULONG ret=0;\r\n#else\r\nBN_ULLONG ret=0;\r\n#endif\r\nint i;\r\nw&=BN_MASK2;\r\nfor (i=a->top-1; i>=0; i--)\r\n{\r\n#ifndef BN_LLONG\r\nret=((ret<<BN_BITS4)|((a->d[i]>>BN_BITS4)&BN_MASK2l))%w;\r\nret=((ret<<BN_BITS4)|(a->d[i]&BN_MASK2l))%w;\r\n#else\r\nret=(BN_ULLONG)(((ret<<(BN_ULLONG)BN_BITS2)|a->d[i])%\r\n(BN_ULLONG)w);\r\n#endif\r\n}\r\nreturn((BN_ULONG)ret);\r\n}\r\nBN_ULONG BN_div_word(BIGNUM *a, BN_ULONG w)\r\n{\r\nBN_ULONG ret;\r\nint i;\r\nif (a->top == 0) return(0);\r\nret=0;\r\nw&=BN_MASK2;\r\nfor (i=a->top-1; i>=0; i--)\r\n{\r\nBN_ULONG l,d;\r\nl=a->d[i];\r\nd=bn_div_words(ret,l,w);\r\nret=(l-((d*w)&BN_MASK2))&BN_MASK2;\r\na->d[i]=d;\r\n}\r\nif ((a->top > 0) && (a->d[a->top-1] == 0))\r\na->top--;\r\nreturn(ret);\r\n}\r\nint BN_add_word(BIGNUM *a, BN_ULONG w)\r\n{\r\nBN_ULONG l;\r\nint i;\r\nif (a->neg)\r\n{\r\na->neg=0;\r\ni=BN_sub_word(a,w);\r\nif (!BN_is_zero(a))\r\na->neg=1;\r\nreturn(i);\r\n}\r\nw&=BN_MASK2;\r\nif (bn_wexpand(a,a->top+1) == NULL) return(0);\r\ni=0;\r\nfor (;;)\r\n{\r\nl=(a->d[i]+(BN_ULONG)w)&BN_MASK2;\r\na->d[i]=l;\r\nif (w > l)\r\nw=1;\r\nelse\r\nbreak;\r\ni++;\r\n}\r\nif (i >= a->top)\r\na->top++;\r\nreturn(1);\r\n}\r\nint BN_sub_word(BIGNUM *a, BN_ULONG w)\r\n{\r\nint i;\r\nif (a->neg)\r\n{\r\na->neg=0;\r\ni=BN_add_word(a,w);\r\na->neg=1;\r\nreturn(i);\r\n}\r\nw&=BN_MASK2;\r\nif ((a->top == 1) && (a->d[0] < w))\r\n{\r\na->d[0]=w-a->d[0];\r\na->neg=1;\r\nreturn(1);\r\n}\r\ni=0;\r\nfor (;;)\r\n{\r\nif (a->d[i] >= w)\r\n{\r\na->d[i]-=w;\r\nbreak;\r\n}\r\nelse\r\n{\r\na->d[i]=(a->d[i]-w)&BN_MASK2;\r\ni++;\r\nw=1;\r\n}\r\n}\r\nif ((a->d[i] == 0) && (i == (a->top-1)))\r\na->top--;\r\nreturn(1);\r\n}\r\nint BN_mul_word(BIGNUM *a, BN_ULONG w)\r\n{\r\nBN_ULONG ll;\r\nw&=BN_MASK2;\r\nif (a->top)\r\n{\r\nll=bn_mul_words(a->d,a->d,a->top,w);\r\nif (ll)\r\n{\r\nif (bn_wexpand(a,a->top+1) == NULL) return(0);\r\na->d[a->top++]=ll;\r\n}\r\n}\r\nreturn(1);\r\n}

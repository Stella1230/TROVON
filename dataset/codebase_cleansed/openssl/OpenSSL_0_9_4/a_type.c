int i2d_ASN1_TYPE(ASN1_TYPE *a, unsigned char **pp)\r\n{\r\nint r=0;\r\nif (a == NULL) return(0);\r\nswitch (a->type)\r\n{\r\ncase V_ASN1_NULL:\r\nif (pp != NULL)\r\nASN1_put_object(pp,0,0,V_ASN1_NULL,V_ASN1_UNIVERSAL);\r\nr=2;\r\nbreak;\r\ncase V_ASN1_INTEGER:\r\ncase V_ASN1_NEG_INTEGER:\r\nr=i2d_ASN1_INTEGER(a->value.integer,pp);\r\nbreak;\r\ncase V_ASN1_ENUMERATED:\r\ncase V_ASN1_NEG_ENUMERATED:\r\nr=i2d_ASN1_ENUMERATED(a->value.enumerated,pp);\r\nbreak;\r\ncase V_ASN1_BIT_STRING:\r\nr=i2d_ASN1_BIT_STRING(a->value.bit_string,pp);\r\nbreak;\r\ncase V_ASN1_OCTET_STRING:\r\nr=i2d_ASN1_OCTET_STRING(a->value.octet_string,pp);\r\nbreak;\r\ncase V_ASN1_OBJECT:\r\nr=i2d_ASN1_OBJECT(a->value.object,pp);\r\nbreak;\r\ncase V_ASN1_PRINTABLESTRING:\r\nr=M_i2d_ASN1_PRINTABLESTRING(a->value.printablestring,pp);\r\nbreak;\r\ncase V_ASN1_T61STRING:\r\nr=M_i2d_ASN1_T61STRING(a->value.t61string,pp);\r\nbreak;\r\ncase V_ASN1_IA5STRING:\r\nr=M_i2d_ASN1_IA5STRING(a->value.ia5string,pp);\r\nbreak;\r\ncase V_ASN1_GENERALSTRING:\r\nr=M_i2d_ASN1_GENERALSTRING(a->value.generalstring,pp);\r\nbreak;\r\ncase V_ASN1_UNIVERSALSTRING:\r\nr=M_i2d_ASN1_UNIVERSALSTRING(a->value.universalstring,pp);\r\nbreak;\r\ncase V_ASN1_UTF8STRING:\r\nr=M_i2d_ASN1_UTF8STRING(a->value.utf8string,pp);\r\nbreak;\r\ncase V_ASN1_VISIBLESTRING:\r\nr=M_i2d_ASN1_VISIBLESTRING(a->value.visiblestring,pp);\r\nbreak;\r\ncase V_ASN1_BMPSTRING:\r\nr=M_i2d_ASN1_BMPSTRING(a->value.bmpstring,pp);\r\nbreak;\r\ncase V_ASN1_UTCTIME:\r\nr=i2d_ASN1_UTCTIME(a->value.utctime,pp);\r\nbreak;\r\ncase V_ASN1_GENERALIZEDTIME:\r\nr=i2d_ASN1_GENERALIZEDTIME(a->value.generalizedtime,pp);\r\nbreak;\r\ncase V_ASN1_SET:\r\ncase V_ASN1_SEQUENCE:\r\nif (a->value.set == NULL)\r\nr=0;\r\nelse\r\n{\r\nr=a->value.set->length;\r\nif (pp != NULL)\r\n{\r\nmemcpy(*pp,a->value.set->data,r);\r\n*pp+=r;\r\n}\r\n}\r\nbreak;\r\n}\r\nreturn(r);\r\n}\r\nASN1_TYPE *d2i_ASN1_TYPE(ASN1_TYPE **a, unsigned char **pp, long length)\r\n{\r\nASN1_TYPE *ret=NULL;\r\nunsigned char *q,*p,*max;\r\nint inf,tag,xclass;\r\nlong len;\r\nif ((a == NULL) || ((*a) == NULL))\r\n{\r\nif ((ret=ASN1_TYPE_new()) == NULL) goto err;\r\n}\r\nelse\r\nret=(*a);\r\np= *pp;\r\nq=p;\r\nmax=(p+length);\r\ninf=ASN1_get_object(&q,&len,&tag,&xclass,length);\r\nif (inf & 0x80) goto err;\r\nASN1_TYPE_component_free(ret);\r\nswitch (tag)\r\n{\r\ncase V_ASN1_NULL:\r\np=q;\r\nret->value.ptr=NULL;\r\nbreak;\r\ncase V_ASN1_INTEGER:\r\nif ((ret->value.integer=\r\nd2i_ASN1_INTEGER(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_ENUMERATED:\r\nif ((ret->value.enumerated=\r\nd2i_ASN1_ENUMERATED(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_BIT_STRING:\r\nif ((ret->value.bit_string=\r\nd2i_ASN1_BIT_STRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_OCTET_STRING:\r\nif ((ret->value.octet_string=\r\nd2i_ASN1_OCTET_STRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_VISIBLESTRING:\r\nif ((ret->value.visiblestring=\r\nd2i_ASN1_VISIBLESTRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_UTF8STRING:\r\nif ((ret->value.utf8string=\r\nd2i_ASN1_UTF8STRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_OBJECT:\r\nif ((ret->value.object=\r\nd2i_ASN1_OBJECT(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_PRINTABLESTRING:\r\nif ((ret->value.printablestring=\r\nd2i_ASN1_PRINTABLESTRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_T61STRING:\r\nif ((ret->value.t61string=\r\nM_d2i_ASN1_T61STRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_IA5STRING:\r\nif ((ret->value.ia5string=\r\nM_d2i_ASN1_IA5STRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_GENERALSTRING:\r\nif ((ret->value.generalstring=\r\nM_d2i_ASN1_GENERALSTRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_UNIVERSALSTRING:\r\nif ((ret->value.universalstring=\r\nM_d2i_ASN1_UNIVERSALSTRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_BMPSTRING:\r\nif ((ret->value.bmpstring=\r\nM_d2i_ASN1_BMPSTRING(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_UTCTIME:\r\nif ((ret->value.utctime=\r\nd2i_ASN1_UTCTIME(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_GENERALIZEDTIME:\r\nif ((ret->value.generalizedtime=\r\nd2i_ASN1_GENERALIZEDTIME(NULL,&p,max-p)) == NULL)\r\ngoto err;\r\nbreak;\r\ncase V_ASN1_SET:\r\ncase V_ASN1_SEQUENCE:\r\nif ((ret->value.set=ASN1_STRING_new()) == NULL) goto err;\r\nret->value.set->type=tag;\r\nlen+=(q-p);\r\nif (!ASN1_STRING_set(ret->value.set,p,(int)len)) goto err;\r\np+=len;\r\nbreak;\r\ndefault:\r\nASN1err(ASN1_F_D2I_ASN1_TYPE,ASN1_R_BAD_TYPE);\r\ngoto err;\r\n}\r\nret->type=tag;\r\nif (a != NULL) (*a)=ret;\r\n*pp=p;\r\nreturn(ret);\r\nerr:\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret))) ASN1_TYPE_free(ret);\r\nreturn(NULL);\r\n}\r\nASN1_TYPE *ASN1_TYPE_new(void)\r\n{\r\nASN1_TYPE *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret,ASN1_TYPE);\r\nret->type= -1;\r\nret->value.ptr=NULL;\r\nreturn(ret);\r\nM_ASN1_New_Error(ASN1_F_ASN1_TYPE_NEW);\r\n}\r\nvoid ASN1_TYPE_free(ASN1_TYPE *a)\r\n{\r\nif (a == NULL) return;\r\nASN1_TYPE_component_free(a);\r\nFree((char *)(char *)a);\r\n}\r\nint ASN1_TYPE_get(ASN1_TYPE *a)\r\n{\r\nif (a->value.ptr != NULL)\r\nreturn(a->type);\r\nelse\r\nreturn(0);\r\n}\r\nvoid ASN1_TYPE_set(ASN1_TYPE *a, int type, void *value)\r\n{\r\nif (a->value.ptr != NULL)\r\nASN1_TYPE_component_free(a);\r\na->type=type;\r\na->value.ptr=value;\r\n}\r\nstatic void ASN1_TYPE_component_free(ASN1_TYPE *a)\r\n{\r\nif (a == NULL) return;\r\nif (a->value.ptr != NULL)\r\n{\r\nswitch (a->type)\r\n{\r\ncase V_ASN1_OBJECT:\r\nASN1_OBJECT_free(a->value.object);\r\nbreak;\r\ncase V_ASN1_INTEGER:\r\ncase V_ASN1_NEG_INTEGER:\r\ncase V_ASN1_ENUMERATED:\r\ncase V_ASN1_NEG_ENUMERATED:\r\ncase V_ASN1_BIT_STRING:\r\ncase V_ASN1_OCTET_STRING:\r\ncase V_ASN1_SEQUENCE:\r\ncase V_ASN1_SET:\r\ncase V_ASN1_NUMERICSTRING:\r\ncase V_ASN1_PRINTABLESTRING:\r\ncase V_ASN1_T61STRING:\r\ncase V_ASN1_VIDEOTEXSTRING:\r\ncase V_ASN1_IA5STRING:\r\ncase V_ASN1_UTCTIME:\r\ncase V_ASN1_GENERALIZEDTIME:\r\ncase V_ASN1_GRAPHICSTRING:\r\ncase V_ASN1_VISIBLESTRING:\r\ncase V_ASN1_GENERALSTRING:\r\ncase V_ASN1_UNIVERSALSTRING:\r\ncase V_ASN1_BMPSTRING:\r\ncase V_ASN1_UTF8STRING:\r\nASN1_STRING_free((ASN1_STRING *)a->value.ptr);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\na->type=0;\r\na->value.ptr=NULL;\r\n}\r\n}

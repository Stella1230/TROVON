int RSA_sign(int type, unsigned char *m, unsigned int m_len,\r\nunsigned char *sigret, unsigned int *siglen, RSA *rsa)\r\n{\r\nX509_SIG sig;\r\nASN1_TYPE parameter;\r\nint i,j,ret=1;\r\nunsigned char *p,*s;\r\nX509_ALGOR algor;\r\nASN1_OCTET_STRING digest;\r\nsig.algor= &algor;\r\nsig.algor->algorithm=OBJ_nid2obj(type);\r\nif (sig.algor->algorithm == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_SIGN,RSA_R_UNKNOWN_ALGORITHM_TYPE);\r\nreturn(0);\r\n}\r\nif (sig.algor->algorithm->length == 0)\r\n{\r\nRSAerr(RSA_F_RSA_SIGN,RSA_R_THE_ASN1_OBJECT_IDENTIFIER_IS_NOT_KNOWN_FOR_THIS_MD);\r\nreturn(0);\r\n}\r\nparameter.type=V_ASN1_NULL;\r\nparameter.value.ptr=NULL;\r\nsig.algor->parameter= &parameter;\r\nsig.digest= &digest;\r\nsig.digest->data=m;\r\nsig.digest->length=m_len;\r\ni=i2d_X509_SIG(&sig,NULL);\r\nj=RSA_size(rsa);\r\nif ((i-RSA_PKCS1_PADDING) > j)\r\n{\r\nRSAerr(RSA_F_RSA_SIGN,RSA_R_DIGEST_TOO_BIG_FOR_RSA_KEY);\r\nreturn(0);\r\n}\r\ns=(unsigned char *)Malloc((unsigned int)j+1);\r\nif (s == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_SIGN,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\np=s;\r\ni2d_X509_SIG(&sig,&p);\r\ni=RSA_private_encrypt(i,s,sigret,rsa,RSA_PKCS1_PADDING);\r\nif (i <= 0)\r\nret=0;\r\nelse\r\n*siglen=i;\r\nmemset(s,0,(unsigned int)j+1);\r\nFree(s);\r\nreturn(ret);\r\n}\r\nint RSA_verify(int dtype, unsigned char *m, unsigned int m_len,\r\nunsigned char *sigbuf, unsigned int siglen, RSA *rsa)\r\n{\r\nint i,ret=0,sigtype;\r\nunsigned char *p,*s;\r\nX509_SIG *sig=NULL;\r\nif (siglen != (unsigned int)RSA_size(rsa))\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY,RSA_R_WRONG_SIGNATURE_LENGTH);\r\nreturn(0);\r\n}\r\ns=(unsigned char *)Malloc((unsigned int)siglen);\r\nif (s == NULL)\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\ni=RSA_public_decrypt((int)siglen,sigbuf,s,rsa,RSA_PKCS1_PADDING);\r\nif (i <= 0) goto err;\r\np=s;\r\nsig=d2i_X509_SIG(NULL,&p,(long)i);\r\nif (sig == NULL) goto err;\r\nsigtype=OBJ_obj2nid(sig->algor->algorithm);\r\n#ifdef RSA_DEBUG\r\nfprintf(stderr,"in(%s) expect(%s)\n",OBJ_nid2ln(sigtype),\r\nOBJ_nid2ln(dtype));\r\n#endif\r\nif (sigtype != dtype)\r\n{\r\nif (((dtype == NID_md5) &&\r\n(sigtype == NID_md5WithRSAEncryption)) ||\r\n((dtype == NID_md2) &&\r\n(sigtype == NID_md2WithRSAEncryption)))\r\n{\r\n#if !defined(NO_STDIO) && !defined(WIN16)\r\nfprintf(stderr,"signature has problems, re-make with post SSLeay045\n");\r\n#endif\r\n}\r\nelse\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY,RSA_R_ALGORITHM_MISMATCH);\r\ngoto err;\r\n}\r\n}\r\nif ( ((unsigned int)sig->digest->length != m_len) ||\r\n(memcmp(m,sig->digest->data,m_len) != 0))\r\n{\r\nRSAerr(RSA_F_RSA_VERIFY,RSA_R_BAD_SIGNATURE);\r\n}\r\nelse\r\nret=1;\r\nerr:\r\nif (sig != NULL) X509_SIG_free(sig);\r\nmemset(s,0,(unsigned int)siglen);\r\nFree(s);\r\nreturn(ret);\r\n}

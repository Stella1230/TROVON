int BN_rand(BIGNUM *rnd, int bits, int top, int bottom)\r\n{\r\nunsigned char *buf=NULL;\r\nint ret=0,bit,bytes,mask;\r\ntime_t tim;\r\nbytes=(bits+7)/8;\r\nbit=(bits-1)%8;\r\nmask=0xff<<bit;\r\nbuf=(unsigned char *)Malloc(bytes);\r\nif (buf == NULL)\r\n{\r\nBNerr(BN_F_BN_RAND,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\ntime(&tim);\r\nRAND_seed(&tim,sizeof(tim));\r\nRAND_bytes(buf,(int)bytes);\r\nif (top)\r\n{\r\nif (bit == 0)\r\n{\r\nbuf[0]=1;\r\nbuf[1]|=0x80;\r\n}\r\nelse\r\n{\r\nbuf[0]|=(3<<(bit-1));\r\nbuf[0]&= ~(mask<<1);\r\n}\r\n}\r\nelse\r\n{\r\nbuf[0]|=(1<<bit);\r\nbuf[0]&= ~(mask<<1);\r\n}\r\nif (bottom)\r\nbuf[bytes-1]|=1;\r\nif (!BN_bin2bn(buf,bytes,rnd)) goto err;\r\nret=1;\r\nerr:\r\nif (buf != NULL)\r\n{\r\nmemset(buf,0,bytes);\r\nFree(buf);\r\n}\r\nreturn(ret);\r\n}

int i2d_DSAparams(DSA *a, unsigned char **pp)\r\n{\r\nBIGNUM *num[3];\r\nASN1_INTEGER bs;\r\nunsigned int j,i,tot=0,len,max=0;\r\nint t,ret= -1;\r\nunsigned char *p;\r\nif (a == NULL) return(0);\r\nnum[0]=a->p;\r\nnum[1]=a->q;\r\nnum[2]=a->g;\r\nfor (i=0; i<3; i++)\r\n{\r\nif (num[i] == NULL) continue;\r\nj=BN_num_bits(num[i]);\r\nlen=((j == 0)?0:((j/8)+1));\r\nif (len > max) max=len;\r\nlen=ASN1_object_size(0,len,\r\n(num[i]->neg)?V_ASN1_NEG_INTEGER:V_ASN1_INTEGER);\r\ntot+=len;\r\n}\r\nt=ASN1_object_size(1,tot,V_ASN1_SEQUENCE);\r\nif (pp == NULL) return(t);\r\np= *pp;\r\nASN1_put_object(&p,1,tot,V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\nbs.type=V_ASN1_INTEGER;\r\nbs.data=(unsigned char *)Malloc(max+4);\r\nif (bs.data == NULL)\r\n{\r\nASN1err(ASN1_F_I2D_DSAPARAMS,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nfor (i=0; i<3; i++)\r\n{\r\nif (num[i] == NULL) continue;\r\nbs.length=BN_bn2bin(num[i],bs.data);\r\ni2d_ASN1_INTEGER(&bs,&p);\r\n}\r\nFree((char *)bs.data);\r\nret=t;\r\nerr:\r\n*pp=p;\r\nreturn(ret);\r\n}

void RC4(RC4_KEY *key, unsigned long len, unsigned char *indata,\r\nunsigned char *outdata)\r\n{\r\nregister RC4_INT *d;\r\nregister RC4_INT x,y,tx,ty;\r\nint i;\r\nx=key->x;\r\ny=key->y;\r\nd=key->data;\r\n#define LOOP(in,out) \\r\nx=((x+1)&0xff); \\r\ntx=d[x]; \\r\ny=(tx+y)&0xff; \\r\nd[x]=ty=d[y]; \\r\nd[y]=tx; \\r\n(out) = d[(tx+ty)&0xff]^ (in);\r\n#ifndef RC4_INDEX\r\n#define RC4_LOOP(a,b,i) LOOP(*((a)++),*((b)++))\r\n#else\r\n#define RC4_LOOP(a,b,i) LOOP(a[i],b[i])\r\n#endif\r\ni=(int)(len>>3L);\r\nif (i)\r\n{\r\nfor (;;)\r\n{\r\nRC4_LOOP(indata,outdata,0);\r\nRC4_LOOP(indata,outdata,1);\r\nRC4_LOOP(indata,outdata,2);\r\nRC4_LOOP(indata,outdata,3);\r\nRC4_LOOP(indata,outdata,4);\r\nRC4_LOOP(indata,outdata,5);\r\nRC4_LOOP(indata,outdata,6);\r\nRC4_LOOP(indata,outdata,7);\r\n#ifdef RC4_INDEX\r\nindata+=8;\r\noutdata+=8;\r\n#endif\r\nif (--i == 0) break;\r\n}\r\n}\r\ni=(int)len&0x07;\r\nif (i)\r\n{\r\nfor (;;)\r\n{\r\nRC4_LOOP(indata,outdata,0); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,1); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,2); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,3); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,4); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,5); if (--i == 0) break;\r\nRC4_LOOP(indata,outdata,6); if (--i == 0) break;\r\n}\r\n}\r\nkey->x=x;\r\nkey->y=y;\r\n}

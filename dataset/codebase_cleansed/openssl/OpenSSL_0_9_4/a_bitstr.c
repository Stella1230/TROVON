int i2d_ASN1_BIT_STRING(ASN1_BIT_STRING *a, unsigned char **pp)\r\n{\r\nint ret,j,r,bits,len;\r\nunsigned char *p,*d;\r\nif (a == NULL) return(0);\r\nlen=a->length;\r\nif (len > 0)\r\n{\r\nif (a->flags & ASN1_STRING_FLAG_BITS_LEFT)\r\n{\r\nbits=(int)a->flags&0x07;\r\n}\r\nelse\r\n{\r\nfor ( ; len > 0; len--)\r\n{\r\nif (a->data[len-1]) break;\r\n}\r\nj=a->data[len-1];\r\nif (j & 0x01) bits=0;\r\nelse if (j & 0x02) bits=1;\r\nelse if (j & 0x04) bits=2;\r\nelse if (j & 0x08) bits=3;\r\nelse if (j & 0x10) bits=4;\r\nelse if (j & 0x20) bits=5;\r\nelse if (j & 0x40) bits=6;\r\nelse if (j & 0x80) bits=7;\r\nelse bits=0;\r\n}\r\n}\r\nelse\r\nbits=0;\r\nret=1+len;\r\nr=ASN1_object_size(0,ret,V_ASN1_BIT_STRING);\r\nif (pp == NULL) return(r);\r\np= *pp;\r\nASN1_put_object(&p,0,ret,V_ASN1_BIT_STRING,V_ASN1_UNIVERSAL);\r\n*(p++)=(unsigned char)bits;\r\nd=a->data;\r\nmemcpy(p,d,len);\r\np+=len;\r\nif (len > 0) p[-1]&=(0xff<<bits);\r\n*pp=p;\r\nreturn(r);\r\n}\r\nASN1_BIT_STRING *d2i_ASN1_BIT_STRING(ASN1_BIT_STRING **a, unsigned char **pp,\r\nlong length)\r\n{\r\nASN1_BIT_STRING *ret=NULL;\r\nunsigned char *p,*s;\r\nlong len;\r\nint inf,tag,xclass;\r\nint i;\r\nif ((a == NULL) || ((*a) == NULL))\r\n{\r\nif ((ret=ASN1_BIT_STRING_new()) == NULL) return(NULL);\r\n}\r\nelse\r\nret=(*a);\r\np= *pp;\r\ninf=ASN1_get_object(&p,&len,&tag,&xclass,length);\r\nif (inf & 0x80)\r\n{\r\ni=ASN1_R_BAD_OBJECT_HEADER;\r\ngoto err;\r\n}\r\nif (tag != V_ASN1_BIT_STRING)\r\n{\r\ni=ASN1_R_EXPECTING_A_BIT_STRING;\r\ngoto err;\r\n}\r\nif (len < 1) { i=ASN1_R_STRING_TOO_SHORT; goto err; }\r\ni= *(p++);\r\nret->flags&= ~(ASN1_STRING_FLAG_BITS_LEFT|0x07);\r\nret->flags|=(ASN1_STRING_FLAG_BITS_LEFT|(i&0x07));\r\nif (len-- > 1)\r\n{\r\ns=(unsigned char *)Malloc((int)len);\r\nif (s == NULL)\r\n{\r\ni=ERR_R_MALLOC_FAILURE;\r\ngoto err;\r\n}\r\nmemcpy(s,p,(int)len);\r\ns[len-1]&=(0xff<<i);\r\np+=len;\r\n}\r\nelse\r\ns=NULL;\r\nret->length=(int)len;\r\nif (ret->data != NULL) Free((char *)ret->data);\r\nret->data=s;\r\nret->type=V_ASN1_BIT_STRING;\r\nif (a != NULL) (*a)=ret;\r\n*pp=p;\r\nreturn(ret);\r\nerr:\r\nASN1err(ASN1_F_D2I_ASN1_BIT_STRING,i);\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret)))\r\nASN1_BIT_STRING_free(ret);\r\nreturn(NULL);\r\n}\r\nint ASN1_BIT_STRING_set_bit(ASN1_BIT_STRING *a, int n, int value)\r\n{\r\nint w,v,iv;\r\nunsigned char *c;\r\nw=n/8;\r\nv=1<<(7-(n&0x07));\r\niv= ~v;\r\na->flags&= ~(ASN1_STRING_FLAG_BITS_LEFT|0x07);\r\nif (a == NULL) return(0);\r\nif ((a->length < (w+1)) || (a->data == NULL))\r\n{\r\nif (!value) return(1);\r\nif (a->data == NULL)\r\nc=(unsigned char *)Malloc(w+1);\r\nelse\r\nc=(unsigned char *)Realloc(a->data,w+1);\r\nif (c == NULL) return(0);\r\na->data=c;\r\na->length=w+1;\r\nc[w]=0;\r\n}\r\na->data[w]=((a->data[w])&iv)|v;\r\nwhile ((a->length > 0) && (a->data[a->length-1] == 0))\r\na->length--;\r\nreturn(1);\r\n}\r\nint ASN1_BIT_STRING_get_bit(ASN1_BIT_STRING *a, int n)\r\n{\r\nint w,v;\r\nw=n/8;\r\nv=1<<(7-(n&0x07));\r\nif ((a == NULL) || (a->length < (w+1)) || (a->data == NULL))\r\nreturn(0);\r\nreturn((a->data[w]&v) != 0);\r\n}

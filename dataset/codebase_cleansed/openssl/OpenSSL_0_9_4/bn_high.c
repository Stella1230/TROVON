int BN_mul_high(BIGNUM *r, BIGNUM *a, BIGNUM *b, BIGNUM *low, int words)\r\n{\r\nint w2,borrow=0,full=0;\r\nBIGNUM t1,t2,t3,h,ah,al,bh,bl,m,s0,s1;\r\nBN_ULONG ul1,ul2;\r\nBN_mul(r,a,b);\r\nBN_rshift(r,r,words*BN_BITS2);\r\nreturn(1);\r\nw2=(words+1)/2;\r\n#ifdef BN_MUL_HIGH_DEBUG\r\nfprintf(stdout,"words=%d w2=%d\n",words,w2);\r\n#endif\r\ndebug_BN_print(stdout,a," a\n");\r\ndebug_BN_print(stdout,b," b\n");\r\ndebug_BN_print(stdout,low," low\n");\r\nBN_init(&al); BN_init(&ah);\r\nBN_init(&bl); BN_init(&bh);\r\nBN_init(&t1); BN_init(&t2); BN_init(&t3);\r\nBN_init(&s0); BN_init(&s1);\r\nBN_init(&h); BN_init(&m);\r\nbn_set_low (&al,a,w2);\r\nbn_set_high(&ah,a,w2);\r\nbn_set_low (&bl,b,w2);\r\nbn_set_high(&bh,b,w2);\r\nbn_set_low(&s0,low,w2);\r\nbn_set_high(&s1,low,w2);\r\ndebug_BN_print(stdout,&al," al\n");\r\ndebug_BN_print(stdout,&ah," ah\n");\r\ndebug_BN_print(stdout,&bl," bl\n");\r\ndebug_BN_print(stdout,&bh," bh\n");\r\ndebug_BN_print(stdout,&s0," s0\n");\r\ndebug_BN_print(stdout,&s1," s1\n");\r\nBN_sub(&t1,&al,&ah);\r\nBN_sub(&t2,&bh,&bl);\r\nBN_mul(&m,&t1,&t2);\r\nBN_mul(&h,&ah,&bh);\r\nBN_add(&m,&m,&h);\r\nBN_add(&t2,&m,&s0);\r\ndebug_BN_print(stdout,&t2," middle value\n");\r\nif (w2 < t2.top) t2.top=w2;\r\n#if 0\r\nbn_set_low(&t3,&t2,w2);\r\n#endif\r\ndebug_BN_print(stdout,&t2," low middle value\n");\r\nBN_sub(&t1,&s1,&t2);\r\nif (t1.neg)\r\n{\r\ndebug_BN_print(stdout,&t1," before\n");\r\nBN_zero(&t2);\r\nBN_set_bit(&t2,w2*BN_BITS2);\r\nBN_add(&t1,&t2,&t1);\r\ndebug_BN_print(stdout,&t1," after\n");\r\nborrow=1;\r\n}\r\nBN_lshift(&t1,&t1,w2*BN_BITS2);\r\nBN_add(&t1,&t1,&s0);\r\nif (w2*2 < t1.top) t1.top=w2*2;\r\n#if 0\r\nBN_add(&m,&m,&t1);\r\ndebug_BN_print(stdout,&t1," s10\n");\r\ndebug_BN_print(stdout,&m," s21\n");\r\ndebug_BN_print(stdout,&h," s32\n");\r\nBN_lshift(&m,&m,w2*BN_BITS2);\r\nBN_lshift(&h,&h,w2*2*BN_BITS2);\r\nBN_add(r,&m,&t1);\r\nBN_add(r,r,&h);\r\nBN_rshift(r,r,w2*2*BN_BITS2);\r\n#else\r\nBN_add(&m,&m,&t1);\r\nbn_set_high(&t3,&t1,w2);\r\nBN_add(&m,&m,&t3);\r\nbn_set_high(&t3,&m,w2);\r\nBN_add(r,&h,&t3);\r\n#endif\r\n#ifdef BN_MUL_HIGH_DEBUG\r\nprintf("carry=%d\n",borrow);\r\n#endif\r\ndebug_BN_print(stdout,r," ret\n");\r\nBN_free(&t1); BN_free(&t2);\r\nBN_free(&m); BN_free(&h);\r\nreturn(1);\r\n}

BIO_METHOD *BIO_s_log(void)\r\n{\r\nreturn(&methods_slg);\r\n}\r\nstatic int MS_CALLBACK slg_new(BIO *bi)\r\n{\r\nbi->init=1;\r\nbi->num=0;\r\nbi->ptr=NULL;\r\n#ifndef WIN32\r\nxopenlog(bi, "application", LOG_DAEMON);\r\n#else\r\nxopenlog(bi, "application", 0);\r\n#endif\r\nreturn(1);\r\n}\r\nstatic int MS_CALLBACK slg_free(BIO *a)\r\n{\r\nif (a == NULL) return(0);\r\nxcloselog(a);\r\nreturn(1);\r\n}\r\nstatic int MS_CALLBACK slg_write(BIO *b, char *in, int inl)\r\n{\r\nint ret= inl;\r\nchar* buf= in;\r\nchar* pp;\r\n#if defined(WIN32)\r\nLPTSTR lpszStrings[1];\r\nWORD evtype= EVENTLOG_ERROR_TYPE;\r\n#else\r\nint priority;\r\n#endif\r\nif((buf= (char *)Malloc(inl+ 1)) == NULL){\r\nreturn(0);\r\n}\r\nstrncpy(buf, in, inl);\r\nbuf[inl]= '\0';\r\n#if defined(WIN32)\r\nif(strncmp(buf, "ERR ", 4) == 0){\r\nevtype= EVENTLOG_ERROR_TYPE;\r\npp= buf+ 4;\r\n}else if(strncmp(buf, "WAR ", 4) == 0){\r\nevtype= EVENTLOG_WARNING_TYPE;\r\npp= buf+ 4;\r\n}else if(strncmp(buf, "INF ", 4) == 0){\r\nevtype= EVENTLOG_INFORMATION_TYPE;\r\npp= buf+ 4;\r\n}else{\r\nevtype= EVENTLOG_ERROR_TYPE;\r\npp= buf;\r\n}\r\nlpszStrings[0]= pp;\r\nif(b->ptr)\r\nReportEvent(b->ptr, evtype, 0, 1024, NULL, 1, 0,\r\nlpszStrings, NULL);\r\n#else\r\nif(strncmp(buf, "ERR ", 4) == 0){\r\npriority= LOG_ERR;\r\npp= buf+ 4;\r\n}else if(strncmp(buf, "WAR ", 4) == 0){\r\npriority= LOG_WARNING;\r\npp= buf+ 4;\r\n}else if(strncmp(buf, "INF ", 4) == 0){\r\npriority= LOG_INFO;\r\npp= buf+ 4;\r\n}else{\r\npriority= LOG_ERR;\r\npp= buf;\r\n}\r\nsyslog(priority, "%s", pp);\r\n#endif\r\nFree(buf);\r\nreturn(ret);\r\n}\r\nstatic long MS_CALLBACK slg_ctrl(BIO *b, int cmd, long num, char *ptr)\r\n{\r\nswitch (cmd)\r\n{\r\ncase BIO_CTRL_SET:\r\nxcloselog(b);\r\nxopenlog(b, ptr, num);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn(0);\r\n}\r\nstatic int MS_CALLBACK slg_puts(BIO *bp, char *str)\r\n{\r\nint n,ret;\r\nn=strlen(str);\r\nret=slg_write(bp,str,n);\r\nreturn(ret);\r\n}\r\nstatic int xopenlog(BIO* bp, const char* name, int level)\r\n{\r\n#if defined(WIN32)\r\nif((bp->ptr= (char *)RegisterEventSource(NULL, name)) == NULL){\r\nreturn(0);\r\n}\r\n#else\r\nopenlog(name, LOG_PID|LOG_CONS, level);\r\n#endif\r\nreturn(1);\r\n}\r\nstatic int xcloselog(BIO* bp)\r\n{\r\n#if defined(WIN32)\r\nif(bp->ptr)\r\nDeregisterEventSource((HANDLE)(bp->ptr));\r\nbp->ptr= NULL;\r\n#else\r\ncloselog();\r\n#endif\r\nreturn(1);\r\n}

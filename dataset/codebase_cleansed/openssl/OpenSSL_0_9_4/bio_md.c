BIO_METHOD *BIO_f_md(void)\r\n{\r\nreturn(&methods_md);\r\n}\r\nstatic int md_new(BIO *bi)\r\n{\r\nEVP_MD_CTX *ctx;\r\nctx=(EVP_MD_CTX *)Malloc(sizeof(EVP_MD_CTX));\r\nif (ctx == NULL) return(0);\r\nbi->init=0;\r\nbi->ptr=(char *)ctx;\r\nbi->flags=0;\r\nreturn(1);\r\n}\r\nstatic int md_free(BIO *a)\r\n{\r\nif (a == NULL) return(0);\r\nFree(a->ptr);\r\na->ptr=NULL;\r\na->init=0;\r\na->flags=0;\r\nreturn(1);\r\n}\r\nstatic int md_read(BIO *b, char *out, int outl)\r\n{\r\nint ret=0;\r\nEVP_MD_CTX *ctx;\r\nif (out == NULL) return(0);\r\nctx=(EVP_MD_CTX *)b->ptr;\r\nif ((ctx == NULL) || (b->next_bio == NULL)) return(0);\r\nret=BIO_read(b->next_bio,out,outl);\r\nif (b->init)\r\n{\r\nif (ret > 0)\r\n{\r\nEVP_DigestUpdate(ctx,(unsigned char *)out,\r\n(unsigned int)ret);\r\n}\r\n}\r\nBIO_clear_retry_flags(b);\r\nBIO_copy_next_retry(b);\r\nreturn(ret);\r\n}\r\nstatic int md_write(BIO *b, char *in, int inl)\r\n{\r\nint ret=0;\r\nEVP_MD_CTX *ctx;\r\nif ((in == NULL) || (inl <= 0)) return(0);\r\nctx=(EVP_MD_CTX *)b->ptr;\r\nif ((ctx != NULL) && (b->next_bio != NULL))\r\nret=BIO_write(b->next_bio,in,inl);\r\nif (b->init)\r\n{\r\nif (ret > 0)\r\n{\r\nEVP_DigestUpdate(ctx,(unsigned char *)in,\r\n(unsigned int)ret);\r\n}\r\n}\r\nBIO_clear_retry_flags(b);\r\nBIO_copy_next_retry(b);\r\nreturn(ret);\r\n}\r\nstatic long md_ctrl(BIO *b, int cmd, long num, char *ptr)\r\n{\r\nEVP_MD_CTX *ctx,*dctx,**pctx;\r\nconst EVP_MD **ppmd;\r\nEVP_MD *md;\r\nlong ret=1;\r\nBIO *dbio;\r\nctx=(EVP_MD_CTX *)b->ptr;\r\nswitch (cmd)\r\n{\r\ncase BIO_CTRL_RESET:\r\nif (b->init)\r\nEVP_DigestInit(ctx,ctx->digest);\r\nelse\r\nret=0;\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_C_GET_MD:\r\nif (b->init)\r\n{\r\nppmd=(const EVP_MD **)ptr;\r\n*ppmd=ctx->digest;\r\n}\r\nelse\r\nret=0;\r\nbreak;\r\ncase BIO_C_GET_MD_CTX:\r\nif (b->init)\r\n{\r\npctx=(EVP_MD_CTX **)ptr;\r\n*pctx=ctx;\r\n}\r\nelse\r\nret=0;\r\nbreak;\r\ncase BIO_C_DO_STATE_MACHINE:\r\nBIO_clear_retry_flags(b);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nBIO_copy_next_retry(b);\r\nbreak;\r\ncase BIO_C_SET_MD:\r\nmd=(EVP_MD *)ptr;\r\nEVP_DigestInit(ctx,md);\r\nb->init=1;\r\nbreak;\r\ncase BIO_CTRL_DUP:\r\ndbio=(BIO *)ptr;\r\ndctx=(EVP_MD_CTX *)dbio->ptr;\r\nmemcpy(dctx,ctx,sizeof(ctx));\r\nb->init=1;\r\nbreak;\r\ndefault:\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nreturn(ret);\r\n}\r\nstatic int md_gets(BIO *bp, char *buf, int size)\r\n{\r\nEVP_MD_CTX *ctx;\r\nunsigned int ret;\r\nctx=(EVP_MD_CTX *)bp->ptr;\r\nif (size < ctx->digest->md_size)\r\nreturn(0);\r\nEVP_DigestFinal(ctx,(unsigned char *)buf,&ret);\r\nreturn((int)ret);\r\n}

int i2d_SSL_SESSION(SSL_SESSION *in, unsigned char **pp)\r\n{\r\n#define LSIZE2 (sizeof(long)*2)\r\nint v1=0,v2=0,v3=0,v4=0;\r\nunsigned char buf[4],ibuf1[LSIZE2],ibuf2[LSIZE2];\r\nunsigned char ibuf3[LSIZE2],ibuf4[LSIZE2];\r\nlong l;\r\nSSL_SESSION_ASN1 a;\r\nM_ASN1_I2D_vars(in);\r\nif ((in == NULL) || ((in->cipher == NULL) && (in->cipher_id == 0)))\r\nreturn(0);\r\na.version.length=LSIZE2;\r\na.version.type=V_ASN1_INTEGER;\r\na.version.data=ibuf1;\r\nASN1_INTEGER_set(&(a.version),SSL_SESSION_ASN1_VERSION);\r\na.ssl_version.length=LSIZE2;\r\na.ssl_version.type=V_ASN1_INTEGER;\r\na.ssl_version.data=ibuf2;\r\nASN1_INTEGER_set(&(a.ssl_version),in->ssl_version);\r\na.cipher.type=V_ASN1_OCTET_STRING;\r\na.cipher.data=buf;\r\nif (in->cipher == NULL)\r\nl=in->cipher_id;\r\nelse\r\nl=in->cipher->id;\r\nif (in->ssl_version == SSL2_VERSION)\r\n{\r\na.cipher.length=3;\r\nbuf[0]=((unsigned char)(l>>16L))&0xff;\r\nbuf[1]=((unsigned char)(l>> 8L))&0xff;\r\nbuf[2]=((unsigned char)(l ))&0xff;\r\n}\r\nelse\r\n{\r\na.cipher.length=2;\r\nbuf[0]=((unsigned char)(l>>8L))&0xff;\r\nbuf[1]=((unsigned char)(l ))&0xff;\r\n}\r\na.master_key.length=in->master_key_length;\r\na.master_key.type=V_ASN1_OCTET_STRING;\r\na.master_key.data=in->master_key;\r\na.session_id.length=in->session_id_length;\r\na.session_id.type=V_ASN1_OCTET_STRING;\r\na.session_id.data=in->session_id;\r\na.session_id_context.length=in->sid_ctx_length;\r\na.session_id_context.type=V_ASN1_OCTET_STRING;\r\na.session_id_context.data=in->sid_ctx;\r\na.key_arg.length=in->key_arg_length;\r\na.key_arg.type=V_ASN1_OCTET_STRING;\r\na.key_arg.data=in->key_arg;\r\nif (in->time != 0L)\r\n{\r\na.time.length=LSIZE2;\r\na.time.type=V_ASN1_INTEGER;\r\na.time.data=ibuf3;\r\nASN1_INTEGER_set(&(a.time),in->time);\r\n}\r\nif (in->timeout != 0L)\r\n{\r\na.timeout.length=LSIZE2;\r\na.timeout.type=V_ASN1_INTEGER;\r\na.timeout.data=ibuf4;\r\nASN1_INTEGER_set(&(a.timeout),in->timeout);\r\n}\r\nM_ASN1_I2D_len(&(a.version), i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_len(&(a.ssl_version), i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_len(&(a.cipher), i2d_ASN1_OCTET_STRING);\r\nM_ASN1_I2D_len(&(a.session_id), i2d_ASN1_OCTET_STRING);\r\nM_ASN1_I2D_len(&(a.master_key), i2d_ASN1_OCTET_STRING);\r\nif (in->key_arg_length > 0)\r\nM_ASN1_I2D_len_IMP_opt(&(a.key_arg),i2d_ASN1_OCTET_STRING);\r\nif (in->time != 0L)\r\nM_ASN1_I2D_len_EXP_opt(&(a.time),i2d_ASN1_INTEGER,1,v1);\r\nif (in->timeout != 0L)\r\nM_ASN1_I2D_len_EXP_opt(&(a.timeout),i2d_ASN1_INTEGER,2,v2);\r\nif (in->peer != NULL)\r\nM_ASN1_I2D_len_EXP_opt(in->peer,i2d_X509,3,v3);\r\nM_ASN1_I2D_len_EXP_opt(&a.session_id_context,i2d_ASN1_OCTET_STRING,4,v4);\r\nM_ASN1_I2D_seq_total();\r\nM_ASN1_I2D_put(&(a.version), i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_put(&(a.ssl_version), i2d_ASN1_INTEGER);\r\nM_ASN1_I2D_put(&(a.cipher), i2d_ASN1_OCTET_STRING);\r\nM_ASN1_I2D_put(&(a.session_id), i2d_ASN1_OCTET_STRING);\r\nM_ASN1_I2D_put(&(a.master_key), i2d_ASN1_OCTET_STRING);\r\nif (in->key_arg_length > 0)\r\nM_ASN1_I2D_put_IMP_opt(&(a.key_arg),i2d_ASN1_OCTET_STRING,0);\r\nif (in->time != 0L)\r\nM_ASN1_I2D_put_EXP_opt(&(a.time),i2d_ASN1_INTEGER,1,v1);\r\nif (in->timeout != 0L)\r\nM_ASN1_I2D_put_EXP_opt(&(a.timeout),i2d_ASN1_INTEGER,2,v2);\r\nif (in->peer != NULL)\r\nM_ASN1_I2D_put_EXP_opt(in->peer,i2d_X509,3,v3);\r\nM_ASN1_I2D_put_EXP_opt(&a.session_id_context,i2d_ASN1_OCTET_STRING,4,\r\nv4);\r\nM_ASN1_I2D_finish();\r\n}\r\nSSL_SESSION *d2i_SSL_SESSION(SSL_SESSION **a, unsigned char **pp,\r\nlong length)\r\n{\r\nint version,ssl_version=0,i;\r\nlong id;\r\nASN1_INTEGER ai,*aip;\r\nASN1_OCTET_STRING os,*osp;\r\nM_ASN1_D2I_vars(a,SSL_SESSION *,SSL_SESSION_new);\r\naip= &ai;\r\nosp= &os;\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nai.data=NULL; ai.length=0;\r\nM_ASN1_D2I_get(aip,d2i_ASN1_INTEGER);\r\nversion=(int)ASN1_INTEGER_get(aip);\r\nif (ai.data != NULL) { Free(ai.data); ai.data=NULL; ai.length=0; }\r\nM_ASN1_D2I_get(aip,d2i_ASN1_INTEGER);\r\nssl_version=(int)ASN1_INTEGER_get(aip);\r\nret->ssl_version=ssl_version;\r\nif (ai.data != NULL) { Free(ai.data); ai.data=NULL; ai.length=0; }\r\nos.data=NULL; os.length=0;\r\nM_ASN1_D2I_get(osp,d2i_ASN1_OCTET_STRING);\r\nif (ssl_version == SSL2_VERSION)\r\n{\r\nif (os.length != 3)\r\n{\r\nc.error=SSL_R_CIPHER_CODE_WRONG_LENGTH;\r\ngoto err;\r\n}\r\nid=0x02000000L|\r\n((unsigned long)os.data[0]<<16L)|\r\n((unsigned long)os.data[1]<< 8L)|\r\n(unsigned long)os.data[2];\r\n}\r\nelse if ((ssl_version>>8) == 3)\r\n{\r\nif (os.length != 2)\r\n{\r\nc.error=SSL_R_CIPHER_CODE_WRONG_LENGTH;\r\ngoto err;\r\n}\r\nid=0x03000000L|\r\n((unsigned long)os.data[0]<<8L)|\r\n(unsigned long)os.data[1];\r\n}\r\nelse\r\n{\r\nSSLerr(SSL_F_D2I_SSL_SESSION,SSL_R_UNKNOWN_SSL_VERSION);\r\nreturn(NULL);\r\n}\r\nret->cipher=NULL;\r\nret->cipher_id=id;\r\nM_ASN1_D2I_get(osp,d2i_ASN1_OCTET_STRING);\r\nif ((ssl_version>>8) == SSL3_VERSION)\r\ni=SSL3_MAX_SSL_SESSION_ID_LENGTH;\r\nelse\r\ni=SSL2_MAX_SSL_SESSION_ID_LENGTH;\r\nif (os.length > i)\r\nos.length=i;\r\nret->session_id_length=os.length;\r\nmemcpy(ret->session_id,os.data,os.length);\r\nM_ASN1_D2I_get(osp,d2i_ASN1_OCTET_STRING);\r\nif (ret->master_key_length > SSL_MAX_MASTER_KEY_LENGTH)\r\nret->master_key_length=SSL_MAX_MASTER_KEY_LENGTH;\r\nelse\r\nret->master_key_length=os.length;\r\nmemcpy(ret->master_key,os.data,ret->master_key_length);\r\nos.length=0;\r\nM_ASN1_D2I_get_IMP_opt(osp,d2i_ASN1_OCTET_STRING,0,V_ASN1_OCTET_STRING);\r\nif (os.length > SSL_MAX_KEY_ARG_LENGTH)\r\nret->key_arg_length=SSL_MAX_KEY_ARG_LENGTH;\r\nelse\r\nret->key_arg_length=os.length;\r\nmemcpy(ret->key_arg,os.data,ret->key_arg_length);\r\nif (os.data != NULL) Free(os.data);\r\nai.length=0;\r\nM_ASN1_D2I_get_EXP_opt(aip,d2i_ASN1_INTEGER,1);\r\nif (ai.data != NULL)\r\n{\r\nret->time=ASN1_INTEGER_get(aip);\r\nFree(ai.data); ai.data=NULL; ai.length=0;\r\n}\r\nelse\r\nret->time=time(NULL);\r\nai.length=0;\r\nM_ASN1_D2I_get_EXP_opt(aip,d2i_ASN1_INTEGER,2);\r\nif (ai.data != NULL)\r\n{\r\nret->timeout=ASN1_INTEGER_get(aip);\r\nFree(ai.data); ai.data=NULL; ai.length=0;\r\n}\r\nelse\r\nret->timeout=3;\r\nif (ret->peer != NULL)\r\n{\r\nX509_free(ret->peer);\r\nret->peer=NULL;\r\n}\r\nM_ASN1_D2I_get_EXP_opt(ret->peer,d2i_X509,3);\r\nos.length=0;\r\nos.data=NULL;\r\nM_ASN1_D2I_get_EXP_opt(osp,d2i_ASN1_OCTET_STRING,4);\r\nif(os.data != NULL)\r\n{\r\nif (os.length > SSL_MAX_SID_CTX_LENGTH)\r\nSSLerr(SSL_F_D2I_SSL_SESSION,SSL_R_BAD_LENGTH);\r\nret->sid_ctx_length=os.length;\r\nmemcpy(ret->sid_ctx,os.data,os.length);\r\nFree(os.data); os.data=NULL; os.length=0;\r\n}\r\nelse\r\nret->sid_ctx_length=0;\r\nM_ASN1_D2I_Finish(a,SSL_SESSION_free,SSL_F_D2I_SSL_SESSION);\r\n}

int DH_generate_key(DH *dh)\r\n{\r\nint ok=0;\r\nunsigned int i;\r\nBN_CTX ctx;\r\nBN_MONT_CTX *mont;\r\nBIGNUM *pub_key=NULL,*priv_key=NULL;\r\nBN_CTX_init(&ctx);\r\nif (dh->priv_key == NULL)\r\n{\r\ni=dh->length;\r\nif (i == 0)\r\n{\r\ni=BN_num_bits(dh->p)-1;\r\n}\r\npriv_key=BN_new();\r\nif (priv_key == NULL) goto err;\r\nif (!BN_rand(priv_key,i,0,0)) goto err;\r\n}\r\nelse\r\npriv_key=dh->priv_key;\r\nif (dh->pub_key == NULL)\r\n{\r\npub_key=BN_new();\r\nif (pub_key == NULL) goto err;\r\n}\r\nelse\r\npub_key=dh->pub_key;\r\nif ((dh->method_mont_p == NULL) && (dh->flags & DH_FLAG_CACHE_MONT_P))\r\n{\r\nif ((dh->method_mont_p=(char *)BN_MONT_CTX_new()) != NULL)\r\nif (!BN_MONT_CTX_set((BN_MONT_CTX *)dh->method_mont_p,\r\ndh->p,&ctx)) goto err;\r\n}\r\nmont=(BN_MONT_CTX *)dh->method_mont_p;\r\nif (!BN_mod_exp_mont(pub_key,dh->g,priv_key,dh->p,&ctx,mont)) goto err;\r\ndh->pub_key=pub_key;\r\ndh->priv_key=priv_key;\r\nok=1;\r\nerr:\r\nif (ok != 1)\r\nDHerr(DH_F_DH_GENERATE_KEY,ERR_R_BN_LIB);\r\nif ((pub_key != NULL) && (dh->pub_key == NULL)) BN_free(pub_key);\r\nif ((priv_key != NULL) && (dh->priv_key == NULL)) BN_free(priv_key);\r\nBN_CTX_free(&ctx);\r\nreturn(ok);\r\n}\r\nint DH_compute_key(unsigned char *key, BIGNUM *pub_key, DH *dh)\r\n{\r\nBN_CTX ctx;\r\nBN_MONT_CTX *mont;\r\nBIGNUM *tmp;\r\nint ret= -1;\r\nBN_CTX_init(&ctx);\r\ntmp= &(ctx.bn[ctx.tos++]);\r\nif (dh->priv_key == NULL)\r\n{\r\nDHerr(DH_F_DH_COMPUTE_KEY,DH_R_NO_PRIVATE_VALUE);\r\ngoto err;\r\n}\r\nif ((dh->method_mont_p == NULL) && (dh->flags & DH_FLAG_CACHE_MONT_P))\r\n{\r\nif ((dh->method_mont_p=(char *)BN_MONT_CTX_new()) != NULL)\r\nif (!BN_MONT_CTX_set((BN_MONT_CTX *)dh->method_mont_p,\r\ndh->p,&ctx)) goto err;\r\n}\r\nmont=(BN_MONT_CTX *)dh->method_mont_p;\r\nif (!BN_mod_exp_mont(tmp,pub_key,dh->priv_key,dh->p,&ctx,mont))\r\n{\r\nDHerr(DH_F_DH_COMPUTE_KEY,ERR_R_BN_LIB);\r\ngoto err;\r\n}\r\nret=BN_bn2bin(tmp,key);\r\nerr:\r\nBN_CTX_free(&ctx);\r\nreturn(ret);\r\n}

int MAIN(int argc, char **argv)\r\n{\r\nint i,badops=0,offset=0,ret=1,j;\r\nunsigned int length=0;\r\nlong num,tmplen;\r\nBIO *in=NULL,*out=NULL,*b64=NULL, *derout = NULL;\r\nint informat,indent=0;\r\nchar *infile=NULL,*str=NULL,*prog,*oidfile=NULL, *derfile=NULL;\r\nunsigned char *tmpbuf;\r\nBUF_MEM *buf=NULL;\r\nSTACK *osk=NULL;\r\nASN1_TYPE *at=NULL;\r\ninformat=FORMAT_PEM;\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE|BIO_FP_TEXT);\r\nprog=argv[0];\r\nargc--;\r\nargv++;\r\nif ((osk=sk_new_null()) == NULL)\r\n{\r\nBIO_printf(bio_err,"Malloc failure\n");\r\ngoto end;\r\n}\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-inform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nderfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-i") == 0)\r\n{\r\nindent=1;\r\n}\r\nelse if (strcmp(*argv,"-oid") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noidfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-offset") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noffset= atoi(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-length") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nlength= atoi(*(++argv));\r\nif (length == 0) goto bad;\r\n}\r\nelse if (strcmp(*argv,"-strparse") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nsk_push(osk,*(++argv));\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_err,"unknown option %s\n",*argv);\r\nbadops=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nBIO_printf(bio_err,"%s [options] <infile\n",prog);\r\nBIO_printf(bio_err,"where options are\n");\r\nBIO_printf(bio_err," -inform arg input format - one of DER TXT PEM\n");\r\nBIO_printf(bio_err," -in arg input file\n");\r\nBIO_printf(bio_err," -offset arg offset into file\n");\r\nBIO_printf(bio_err," -length arg lenth of section in file\n");\r\nBIO_printf(bio_err," -i indent entries\n");\r\nBIO_printf(bio_err," -oid file file of extra oid definitions\n");\r\nBIO_printf(bio_err," -strparse offset\n");\r\nBIO_printf(bio_err," a series of these can be used to 'dig' into multiple\n");\r\nBIO_printf(bio_err," ASN1 blob wrappings\n");\r\nBIO_printf(bio_err," -out filename output DER encoding to file\n");\r\ngoto end;\r\n}\r\nERR_load_crypto_strings();\r\nin=BIO_new(BIO_s_file());\r\nout=BIO_new(BIO_s_file());\r\nif ((in == NULL) || (out == NULL))\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nBIO_set_fp(out,stdout,BIO_NOCLOSE|BIO_FP_TEXT);\r\nif (oidfile != NULL)\r\n{\r\nif (BIO_read_filename(in,oidfile) <= 0)\r\n{\r\nBIO_printf(bio_err,"problems opening %s\n",oidfile);\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nOBJ_create_objects(in);\r\n}\r\nif (infile == NULL)\r\nBIO_set_fp(in,stdin,BIO_NOCLOSE);\r\nelse\r\n{\r\nif (BIO_read_filename(in,infile) <= 0)\r\n{\r\nperror(infile);\r\ngoto end;\r\n}\r\n}\r\nif (derfile) {\r\nif(!(derout = BIO_new_file(derfile, "wb"))) {\r\nBIO_printf(bio_err,"problems opening %s\n",derfile);\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif ((buf=BUF_MEM_new()) == NULL) goto end;\r\nif (!BUF_MEM_grow(buf,BUFSIZ*8)) goto end;\r\nif (informat == FORMAT_PEM)\r\n{\r\nBIO *tmp;\r\nif ((b64=BIO_new(BIO_f_base64())) == NULL)\r\ngoto end;\r\nBIO_push(b64,in);\r\ntmp=in;\r\nin=b64;\r\nb64=tmp;\r\n}\r\nnum=0;\r\nfor (;;)\r\n{\r\nif (!BUF_MEM_grow(buf,(int)num+BUFSIZ)) goto end;\r\ni=BIO_read(in,&(buf->data[num]),BUFSIZ);\r\nif (i <= 0) break;\r\nnum+=i;\r\n}\r\nstr=buf->data;\r\nif (sk_num(osk))\r\n{\r\ntmpbuf=(unsigned char *)str;\r\ntmplen=num;\r\nfor (i=0; i<sk_num(osk); i++)\r\n{\r\nASN1_TYPE *atmp;\r\nj=atoi(sk_value(osk,i));\r\nif (j == 0)\r\n{\r\nBIO_printf(bio_err,"'%s' is an invalid number\n",sk_value(osk,i));\r\ncontinue;\r\n}\r\ntmpbuf+=j;\r\ntmplen-=j;\r\natmp = at;\r\nat = d2i_ASN1_TYPE(NULL,&tmpbuf,tmplen);\r\nASN1_TYPE_free(atmp);\r\nif(!at)\r\n{\r\nBIO_printf(bio_err,"Error parsing structure\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\ntmpbuf=at->value.asn1_string->data;\r\ntmplen=at->value.asn1_string->length;\r\n}\r\nstr=(char *)tmpbuf;\r\nnum=tmplen;\r\n}\r\nif (length == 0) length=(unsigned int)num;\r\nif(derout) {\r\nif(BIO_write(derout, str + offset, length) != (int)length) {\r\nBIO_printf(bio_err, "Error writing output\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif (!ASN1_parse(out,(unsigned char *)&(str[offset]),length,indent))\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nret=0;\r\nend:\r\nBIO_free(derout);\r\nif (in != NULL) BIO_free(in);\r\nif (out != NULL) BIO_free(out);\r\nif (b64 != NULL) BIO_free(b64);\r\nif (ret != 0)\r\nERR_print_errors(bio_err);\r\nif (buf != NULL) BUF_MEM_free(buf);\r\nif (at != NULL) ASN1_TYPE_free(at);\r\nif (osk != NULL) sk_free(osk);\r\nOBJ_cleanup();\r\nEXIT(ret);\r\n}

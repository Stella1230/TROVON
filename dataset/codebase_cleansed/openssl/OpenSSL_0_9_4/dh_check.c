int DH_check(DH *dh, int *ret)\r\n{\r\nint ok=0;\r\nBN_CTX *ctx=NULL;\r\nBN_ULONG l;\r\nBIGNUM *q=NULL;\r\n*ret=0;\r\nctx=BN_CTX_new();\r\nif (ctx == NULL) goto err;\r\nq=BN_new();\r\nif (q == NULL) goto err;\r\nif (BN_is_word(dh->g,DH_GENERATOR_2))\r\n{\r\nl=BN_mod_word(dh->p,24);\r\nif (l != 11) *ret|=DH_NOT_SUITABLE_GENERATOR;\r\n}\r\nelse if (BN_is_word(dh->g,DH_GENERATOR_5))\r\n{\r\nl=BN_mod_word(dh->p,10);\r\nif ((l != 3) && (l != 7))\r\n*ret|=DH_NOT_SUITABLE_GENERATOR;\r\n}\r\nelse\r\n*ret|=DH_UNABLE_TO_CHECK_GENERATOR;\r\nif (!BN_is_prime(dh->p,BN_prime_checks,NULL,ctx,NULL))\r\n*ret|=DH_CHECK_P_NOT_PRIME;\r\nelse\r\n{\r\nif (!BN_rshift1(q,dh->p)) goto err;\r\nif (!BN_is_prime(q,BN_prime_checks,NULL,ctx,NULL))\r\n*ret|=DH_CHECK_P_NOT_STRONG_PRIME;\r\n}\r\nok=1;\r\nerr:\r\nif (ctx != NULL) BN_CTX_free(ctx);\r\nif (q != NULL) BN_free(q);\r\nreturn(ok);\r\n}

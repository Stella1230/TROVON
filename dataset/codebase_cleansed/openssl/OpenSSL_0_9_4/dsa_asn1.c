DSA_SIG *DSA_SIG_new(void)\r\n{\r\nDSA_SIG *ret;\r\nret = Malloc(sizeof(DSA_SIG));\r\nif (ret == NULL)\r\n{\r\nDSAerr(DSA_F_DSA_SIG_NEW,ERR_R_MALLOC_FAILURE);\r\nreturn(NULL);\r\n}\r\nret->r = NULL;\r\nret->s = NULL;\r\nreturn(ret);\r\n}\r\nvoid DSA_SIG_free(DSA_SIG *r)\r\n{\r\nif (r == NULL) return;\r\nif (r->r) BN_clear_free(r->r);\r\nif (r->s) BN_clear_free(r->s);\r\nFree(r);\r\n}\r\nint i2d_DSA_SIG(DSA_SIG *v, unsigned char **pp)\r\n{\r\nint t=0,len;\r\nASN1_INTEGER rbs,sbs;\r\nunsigned char *p;\r\nrbs.data=Malloc(BN_num_bits(v->r)/8+1);\r\nif (rbs.data == NULL)\r\n{\r\nDSAerr(DSA_F_I2D_DSA_SIG, ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nrbs.type=V_ASN1_INTEGER;\r\nrbs.length=BN_bn2bin(v->r,rbs.data);\r\nsbs.data=Malloc(BN_num_bits(v->s)/8+1);\r\nif (sbs.data == NULL)\r\n{\r\nFree(rbs.data);\r\nDSAerr(DSA_F_I2D_DSA_SIG, ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nsbs.type=V_ASN1_INTEGER;\r\nsbs.length=BN_bn2bin(v->s,sbs.data);\r\nlen=i2d_ASN1_INTEGER(&rbs,NULL);\r\nlen+=i2d_ASN1_INTEGER(&sbs,NULL);\r\nif (pp)\r\n{\r\np=*pp;\r\nASN1_put_object(&p,1,len,V_ASN1_SEQUENCE,V_ASN1_UNIVERSAL);\r\ni2d_ASN1_INTEGER(&rbs,&p);\r\ni2d_ASN1_INTEGER(&sbs,&p);\r\n}\r\nt=ASN1_object_size(1,len,V_ASN1_SEQUENCE);\r\nFree(rbs.data);\r\nFree(sbs.data);\r\nreturn(t);\r\n}\r\nDSA_SIG *d2i_DSA_SIG(DSA_SIG **a, unsigned char **pp, long length)\r\n{\r\nint i=ERR_R_NESTED_ASN1_ERROR;\r\nASN1_INTEGER *bs=NULL;\r\nM_ASN1_D2I_vars(a,DSA_SIG *,DSA_SIG_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get(bs,d2i_ASN1_INTEGER);\r\nif ((ret->r=BN_bin2bn(bs->data,bs->length,ret->r)) == NULL)\r\ngoto err_bn;\r\nM_ASN1_D2I_get(bs,d2i_ASN1_INTEGER);\r\nif ((ret->s=BN_bin2bn(bs->data,bs->length,ret->s)) == NULL)\r\ngoto err_bn;\r\nASN1_BIT_STRING_free(bs);\r\nM_ASN1_D2I_Finish_2(a);\r\nerr_bn:\r\ni=ERR_R_BN_LIB;\r\nerr:\r\nDSAerr(DSA_F_D2I_DSA_SIG,i);\r\nif ((ret != NULL) && ((a == NULL) || (*a != ret))) DSA_SIG_free(ret);\r\nif (bs != NULL) ASN1_BIT_STRING_free(bs);\r\nreturn(NULL);\r\n}

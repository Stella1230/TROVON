int ASN1_verify(int (*i2d)(), X509_ALGOR *a, ASN1_BIT_STRING *signature,\r\nchar *data, EVP_PKEY *pkey)\r\n{\r\nEVP_MD_CTX ctx;\r\nconst EVP_MD *type;\r\nunsigned char *p,*buf_in=NULL;\r\nint ret= -1,i,inl;\r\ni=OBJ_obj2nid(a->algorithm);\r\ntype=EVP_get_digestbyname(OBJ_nid2sn(i));\r\nif (type == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_VERIFY,ASN1_R_UNKNOWN_MESSAGE_DIGEST_ALGORITHM);\r\ngoto err;\r\n}\r\ninl=i2d(data,NULL);\r\nbuf_in=Malloc((unsigned int)inl);\r\nif (buf_in == NULL)\r\n{\r\nASN1err(ASN1_F_ASN1_VERIFY,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\np=buf_in;\r\ni2d(data,&p);\r\nEVP_VerifyInit(&ctx,type);\r\nEVP_VerifyUpdate(&ctx,(unsigned char *)buf_in,inl);\r\nmemset(buf_in,0,(unsigned int)inl);\r\nFree((char *)buf_in);\r\nif (EVP_VerifyFinal(&ctx,(unsigned char *)signature->data,\r\n(unsigned int)signature->length,pkey) <= 0)\r\n{\r\nASN1err(ASN1_F_ASN1_VERIFY,ERR_R_EVP_LIB);\r\nret=0;\r\ngoto err;\r\n}\r\nret=1;\r\nerr:\r\nreturn(ret);\r\n}

BIO_METHOD *BIO_f_nbio_test(void)\r\n{\r\nreturn(&methods_nbiof);\r\n}\r\nstatic int nbiof_new(BIO *bi)\r\n{\r\nNBIO_TEST *nt;\r\nnt=(NBIO_TEST *)Malloc(sizeof(NBIO_TEST));\r\nnt->lrn= -1;\r\nnt->lwn= -1;\r\nbi->ptr=(char *)nt;\r\nbi->init=1;\r\nbi->flags=0;\r\nreturn(1);\r\n}\r\nstatic int nbiof_free(BIO *a)\r\n{\r\nif (a == NULL) return(0);\r\nif (a->ptr != NULL)\r\nFree(a->ptr);\r\na->ptr=NULL;\r\na->init=0;\r\na->flags=0;\r\nreturn(1);\r\n}\r\nstatic int nbiof_read(BIO *b, char *out, int outl)\r\n{\r\nNBIO_TEST *nt;\r\nint ret=0;\r\n#if 0\r\nint num;\r\nunsigned char n;\r\n#endif\r\nif (out == NULL) return(0);\r\nif (b->next_bio == NULL) return(0);\r\nnt=(NBIO_TEST *)b->ptr;\r\nBIO_clear_retry_flags(b);\r\n#if 0\r\nRAND_bytes(&n,1);\r\nnum=(n&0x07);\r\nif (outl > num) outl=num;\r\nif (num == 0)\r\n{\r\nret= -1;\r\nBIO_set_retry_read(b);\r\n}\r\nelse\r\n#endif\r\n{\r\nret=BIO_read(b->next_bio,out,outl);\r\nif (ret < 0)\r\nBIO_copy_next_retry(b);\r\n}\r\nreturn(ret);\r\n}\r\nstatic int nbiof_write(BIO *b, char *in, int inl)\r\n{\r\nNBIO_TEST *nt;\r\nint ret=0;\r\nint num;\r\nunsigned char n;\r\nif ((in == NULL) || (inl <= 0)) return(0);\r\nif (b->next_bio == NULL) return(0);\r\nnt=(NBIO_TEST *)b->ptr;\r\nBIO_clear_retry_flags(b);\r\n#if 1\r\nif (nt->lwn > 0)\r\n{\r\nnum=nt->lwn;\r\nnt->lwn=0;\r\n}\r\nelse\r\n{\r\nRAND_bytes(&n,1);\r\nnum=(n&7);\r\n}\r\nif (inl > num) inl=num;\r\nif (num == 0)\r\n{\r\nret= -1;\r\nBIO_set_retry_write(b);\r\n}\r\nelse\r\n#endif\r\n{\r\nret=BIO_write(b->next_bio,in,inl);\r\nif (ret < 0)\r\n{\r\nBIO_copy_next_retry(b);\r\nnt->lwn=inl;\r\n}\r\n}\r\nreturn(ret);\r\n}\r\nstatic long nbiof_ctrl(BIO *b, int cmd, long num, char *ptr)\r\n{\r\nlong ret;\r\nif (b->next_bio == NULL) return(0);\r\nswitch (cmd)\r\n{\r\ncase BIO_C_DO_STATE_MACHINE:\r\nBIO_clear_retry_flags(b);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nBIO_copy_next_retry(b);\r\nbreak;\r\ncase BIO_CTRL_DUP:\r\nret=0L;\r\nbreak;\r\ndefault:\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nreturn(ret);\r\n}\r\nstatic int nbiof_gets(BIO *bp, char *buf, int size)\r\n{\r\nif (bp->next_bio == NULL) return(0);\r\nreturn(BIO_gets(bp->next_bio,buf,size));\r\n}\r\nstatic int nbiof_puts(BIO *bp, char *str)\r\n{\r\nif (bp->next_bio == NULL) return(0);\r\nreturn(BIO_puts(bp->next_bio,str));\r\n}

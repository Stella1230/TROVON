int BN_mod_exp2_mont(BIGNUM *rr, BIGNUM *a1, BIGNUM *p1, BIGNUM *a2,\r\nBIGNUM *p2, BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *in_mont)\r\n{\r\nint i,j,k,bits,bits1,bits2,ret=0,wstart,wend,window,xvalue,yvalue;\r\nint start=1,ts=0,x,y;\r\nBIGNUM *d,*aa1,*aa2,*r;\r\nBIGNUM val[EXP2_TABLE_SIZE][EXP2_TABLE_SIZE];\r\nBN_MONT_CTX *mont=NULL;\r\nbn_check_top(a1);\r\nbn_check_top(p1);\r\nbn_check_top(a2);\r\nbn_check_top(p2);\r\nbn_check_top(m);\r\nif (!(m->d[0] & 1))\r\n{\r\nBNerr(BN_F_BN_MOD_EXP_MONT,BN_R_CALLED_WITH_EVEN_MODULUS);\r\nreturn(0);\r\n}\r\nd= &(ctx->bn[ctx->tos++]);\r\nr= &(ctx->bn[ctx->tos++]);\r\nbits1=BN_num_bits(p1);\r\nbits2=BN_num_bits(p2);\r\nif ((bits1 == 0) && (bits2 == 0))\r\n{\r\nBN_one(r);\r\nreturn(1);\r\n}\r\nbits=(bits1 > bits2)?bits1:bits2;\r\nif (in_mont != NULL)\r\nmont=in_mont;\r\nelse\r\n{\r\nif ((mont=BN_MONT_CTX_new()) == NULL) goto err;\r\nif (!BN_MONT_CTX_set(mont,m,ctx)) goto err;\r\n}\r\nBN_init(&(val[0][0]));\r\nBN_init(&(val[1][1]));\r\nBN_init(&(val[0][1]));\r\nBN_init(&(val[1][0]));\r\nts=1;\r\nif (BN_ucmp(a1,m) >= 0)\r\n{\r\nBN_mod(&(val[1][0]),a1,m,ctx);\r\naa1= &(val[1][0]);\r\n}\r\nelse\r\naa1=a1;\r\nif (BN_ucmp(a2,m) >= 0)\r\n{\r\nBN_mod(&(val[0][1]),a2,m,ctx);\r\naa2= &(val[0][1]);\r\n}\r\nelse\r\naa2=a2;\r\nif (!BN_to_montgomery(&(val[1][0]),aa1,mont,ctx)) goto err;\r\nif (!BN_to_montgomery(&(val[0][1]),aa2,mont,ctx)) goto err;\r\nif (!BN_mod_mul_montgomery(&(val[1][1]),\r\n&(val[1][0]),&(val[0][1]),mont,ctx))\r\ngoto err;\r\n#if 0\r\nif (bits <= 20)\r\nwindow=1;\r\nelse if (bits > 250)\r\nwindow=5;\r\nelse if (bits >= 120)\r\nwindow=4;\r\nelse\r\nwindow=3;\r\n#else\r\nwindow=EXP2_TABLE_BITS;\r\n#endif\r\nk=1<<window;\r\nfor (x=0; x<k; x++)\r\n{\r\nif (x >= 2)\r\n{\r\nBN_init(&(val[x][0]));\r\nBN_init(&(val[x][1]));\r\nif (!BN_mod_mul_montgomery(&(val[x][0]),\r\n&(val[1][0]),&(val[x-1][0]),mont,ctx)) goto err;\r\nif (!BN_mod_mul_montgomery(&(val[x][1]),\r\n&(val[1][0]),&(val[x-1][1]),mont,ctx)) goto err;\r\n}\r\nfor (y=2; y<k; y++)\r\n{\r\nBN_init(&(val[x][y]));\r\nif (!BN_mod_mul_montgomery(&(val[x][y]),\r\n&(val[x][y-1]),&(val[0][1]),mont,ctx))\r\ngoto err;\r\n}\r\n}\r\nts=k;\r\nstart=1;\r\nxvalue=0;\r\nyvalue=0;\r\nwstart=bits-1;\r\nwend=0;\r\nif (!BN_to_montgomery(r,BN_value_one(),mont,ctx)) goto err;\r\nfor (;;)\r\n{\r\nxvalue=BN_is_bit_set(p1,wstart);\r\nyvalue=BN_is_bit_set(p2,wstart);\r\nif (!(xvalue || yvalue))\r\n{\r\nif (!start)\r\n{\r\nif (!BN_mod_mul_montgomery(r,r,r,mont,ctx))\r\ngoto err;\r\n}\r\nwstart--;\r\nif (wstart < 0) break;\r\ncontinue;\r\n}\r\nj=wstart;\r\nwend=0;\r\nfor (i=1; i<window; i++)\r\n{\r\nif (wstart-i < 0) break;\r\nxvalue+=xvalue;\r\nxvalue|=BN_is_bit_set(p1,wstart-i);\r\nyvalue+=yvalue;\r\nyvalue|=BN_is_bit_set(p2,wstart-i);\r\n}\r\nif (!start)\r\nfor (j=0; j<i; j++)\r\n{\r\nif (!BN_mod_mul_montgomery(r,r,r,mont,ctx))\r\ngoto err;\r\n}\r\nif (xvalue || yvalue)\r\n{\r\nif (!BN_mod_mul_montgomery(r,r,&(val[xvalue][yvalue]),\r\nmont,ctx)) goto err;\r\n}\r\nwstart-=i;\r\nstart=0;\r\nif (wstart < 0) break;\r\n}\r\nBN_from_montgomery(rr,r,mont,ctx);\r\nret=1;\r\nerr:\r\nif ((in_mont == NULL) && (mont != NULL)) BN_MONT_CTX_free(mont);\r\nctx->tos-=2;\r\nfor (i=0; i<ts; i++)\r\n{\r\nfor (j=0; j<ts; j++)\r\n{\r\nBN_clear_free(&(val[i][j]));\r\n}\r\n}\r\nreturn(ret);\r\n}

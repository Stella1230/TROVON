BIO_METHOD *BIO_f_linebuffer(void)\r\n{\r\nreturn(&methods_linebuffer);\r\n}\r\nstatic int linebuffer_new(BIO *bi)\r\n{\r\nBIO_LINEBUFFER_CTX *ctx;\r\nctx=(BIO_LINEBUFFER_CTX *)OPENSSL_malloc(sizeof(BIO_LINEBUFFER_CTX));\r\nif (ctx == NULL) return(0);\r\nctx->obuf=(char *)OPENSSL_malloc(DEFAULT_LINEBUFFER_SIZE);\r\nif (ctx->obuf == NULL) { OPENSSL_free(ctx); return(0); }\r\nctx->obuf_size=DEFAULT_LINEBUFFER_SIZE;\r\nctx->obuf_len=0;\r\nbi->init=1;\r\nbi->ptr=(char *)ctx;\r\nbi->flags=0;\r\nreturn(1);\r\n}\r\nstatic int linebuffer_free(BIO *a)\r\n{\r\nBIO_LINEBUFFER_CTX *b;\r\nif (a == NULL) return(0);\r\nb=(BIO_LINEBUFFER_CTX *)a->ptr;\r\nif (b->obuf != NULL) OPENSSL_free(b->obuf);\r\nOPENSSL_free(a->ptr);\r\na->ptr=NULL;\r\na->init=0;\r\na->flags=0;\r\nreturn(1);\r\n}\r\nstatic int linebuffer_read(BIO *b, char *out, int outl)\r\n{\r\nint ret=0;\r\nif (out == NULL) return(0);\r\nif (b->next_bio == NULL) return(0);\r\nret=BIO_read(b->next_bio,out,outl);\r\nBIO_clear_retry_flags(b);\r\nBIO_copy_next_retry(b);\r\nreturn(ret);\r\n}\r\nstatic int linebuffer_write(BIO *b, const char *in, int inl)\r\n{\r\nint i,num=0,foundnl;\r\nBIO_LINEBUFFER_CTX *ctx;\r\nif ((in == NULL) || (inl <= 0)) return(0);\r\nctx=(BIO_LINEBUFFER_CTX *)b->ptr;\r\nif ((ctx == NULL) || (b->next_bio == NULL)) return(0);\r\nBIO_clear_retry_flags(b);\r\ndo\r\n{\r\nconst char *p;\r\nfor(p = in; p < in + inl && *p != '\n'; p++)\r\n;\r\nif (*p == '\n')\r\n{\r\np++;\r\nfoundnl = 1;\r\n}\r\nelse\r\nfoundnl = 0;\r\nwhile ((foundnl || p - in > ctx->obuf_size - ctx->obuf_len)\r\n&& ctx->obuf_len > 0)\r\n{\r\nint orig_olen = ctx->obuf_len;\r\ni = ctx->obuf_size - ctx->obuf_len;\r\nif (p - in > 0)\r\n{\r\nif (i >= p - in)\r\n{\r\nmemcpy(&(ctx->obuf[ctx->obuf_len]),\r\nin,p - in);\r\nctx->obuf_len += p - in;\r\ninl -= p - in;\r\nnum += p - in;\r\nin = p;\r\n}\r\nelse\r\n{\r\nmemcpy(&(ctx->obuf[ctx->obuf_len]),\r\nin,i);\r\nctx->obuf_len += i;\r\ninl -= i;\r\nin += i;\r\nnum += i;\r\n}\r\n}\r\n#if 0\r\nBIO_write(b->next_bio, "<*<", 3);\r\n#endif\r\ni=BIO_write(b->next_bio,\r\nctx->obuf, ctx->obuf_len);\r\nif (i <= 0)\r\n{\r\nctx->obuf_len = orig_olen;\r\nBIO_copy_next_retry(b);\r\n#if 0\r\nBIO_write(b->next_bio, ">*>", 3);\r\n#endif\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\n#if 0\r\nBIO_write(b->next_bio, ">*>", 3);\r\n#endif\r\nif (i < ctx->obuf_len)\r\nmemmove(ctx->obuf, ctx->obuf + i,\r\nctx->obuf_len - i);\r\nctx->obuf_len-=i;\r\n}\r\nif ((foundnl || p - in > ctx->obuf_size) && p - in > 0)\r\n{\r\n#if 0\r\nBIO_write(b->next_bio, "<*<", 3);\r\n#endif\r\ni=BIO_write(b->next_bio,in,p - in);\r\nif (i <= 0)\r\n{\r\nBIO_copy_next_retry(b);\r\n#if 0\r\nBIO_write(b->next_bio, ">*>", 3);\r\n#endif\r\nif (i < 0) return((num > 0)?num:i);\r\nif (i == 0) return(num);\r\n}\r\n#if 0\r\nBIO_write(b->next_bio, ">*>", 3);\r\n#endif\r\nnum+=i;\r\nin+=i;\r\ninl-=i;\r\n}\r\n}\r\nwhile(foundnl && inl > 0);\r\nif (inl > 0)\r\n{\r\nmemcpy(&(ctx->obuf[ctx->obuf_len]), in, inl);\r\nctx->obuf_len += inl;\r\nnum += inl;\r\n}\r\nreturn num;\r\n}\r\nstatic long linebuffer_ctrl(BIO *b, int cmd, long num, void *ptr)\r\n{\r\nBIO *dbio;\r\nBIO_LINEBUFFER_CTX *ctx;\r\nlong ret=1;\r\nchar *p;\r\nint r;\r\nint obs;\r\nctx=(BIO_LINEBUFFER_CTX *)b->ptr;\r\nswitch (cmd)\r\n{\r\ncase BIO_CTRL_RESET:\r\nctx->obuf_len=0;\r\nif (b->next_bio == NULL) return(0);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_INFO:\r\nret=(long)ctx->obuf_len;\r\nbreak;\r\ncase BIO_CTRL_WPENDING:\r\nret=(long)ctx->obuf_len;\r\nif (ret == 0)\r\n{\r\nif (b->next_bio == NULL) return(0);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\n}\r\nbreak;\r\ncase BIO_C_SET_BUFF_SIZE:\r\nobs=(int)num;\r\np=ctx->obuf;\r\nif ((obs > DEFAULT_LINEBUFFER_SIZE) && (obs != ctx->obuf_size))\r\n{\r\np=(char *)OPENSSL_malloc((int)num);\r\nif (p == NULL)\r\ngoto malloc_error;\r\n}\r\nif (ctx->obuf != p)\r\n{\r\nif (ctx->obuf_len > obs)\r\n{\r\nctx->obuf_len = obs;\r\n}\r\nmemcpy(p, ctx->obuf, ctx->obuf_len);\r\nOPENSSL_free(ctx->obuf);\r\nctx->obuf=p;\r\nctx->obuf_size=obs;\r\n}\r\nbreak;\r\ncase BIO_C_DO_STATE_MACHINE:\r\nif (b->next_bio == NULL) return(0);\r\nBIO_clear_retry_flags(b);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nBIO_copy_next_retry(b);\r\nbreak;\r\ncase BIO_CTRL_FLUSH:\r\nif (b->next_bio == NULL) return(0);\r\nif (ctx->obuf_len <= 0)\r\n{\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nfor (;;)\r\n{\r\nBIO_clear_retry_flags(b);\r\nif (ctx->obuf_len > 0)\r\n{\r\nr=BIO_write(b->next_bio,\r\nctx->obuf, ctx->obuf_len);\r\n#if 0\r\nfprintf(stderr,"FLUSH %3d -> %3d\n",ctx->obuf_len,r);\r\n#endif\r\nBIO_copy_next_retry(b);\r\nif (r <= 0) return((long)r);\r\nif (r < ctx->obuf_len)\r\nmemmove(ctx->obuf, ctx->obuf + r,\r\nctx->obuf_len - r);\r\nctx->obuf_len-=r;\r\n}\r\nelse\r\n{\r\nctx->obuf_len=0;\r\nret=1;\r\nbreak;\r\n}\r\n}\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\ncase BIO_CTRL_DUP:\r\ndbio=(BIO *)ptr;\r\nif ( !BIO_set_write_buffer_size(dbio,ctx->obuf_size))\r\nret=0;\r\nbreak;\r\ndefault:\r\nif (b->next_bio == NULL) return(0);\r\nret=BIO_ctrl(b->next_bio,cmd,num,ptr);\r\nbreak;\r\n}\r\nreturn(ret);\r\nmalloc_error:\r\nBIOerr(BIO_F_LINEBUFFER_CTRL,ERR_R_MALLOC_FAILURE);\r\nreturn(0);\r\n}\r\nstatic long linebuffer_callback_ctrl(BIO *b, int cmd, bio_info_cb *fp)\r\n{\r\nlong ret=1;\r\nif (b->next_bio == NULL) return(0);\r\nswitch (cmd)\r\n{\r\ndefault:\r\nret=BIO_callback_ctrl(b->next_bio,cmd,fp);\r\nbreak;\r\n}\r\nreturn(ret);\r\n}\r\nstatic int linebuffer_gets(BIO *b, char *buf, int size)\r\n{\r\nif (b->next_bio == NULL) return(0);\r\nreturn(BIO_gets(b->next_bio,buf,size));\r\n}\r\nstatic int linebuffer_puts(BIO *b, const char *str)\r\n{\r\nreturn(linebuffer_write(b,str,strlen(str)));\r\n}

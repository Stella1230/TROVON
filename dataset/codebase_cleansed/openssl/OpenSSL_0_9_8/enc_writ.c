int DES_enc_write(int fd, const void *_buf, int len,\r\nDES_key_schedule *sched, DES_cblock *iv)\r\n{\r\n#ifdef _LIBC\r\nextern unsigned long time();\r\nextern int write();\r\n#endif\r\nconst unsigned char *buf=_buf;\r\nlong rnum;\r\nint i,j,k,outnum;\r\nstatic unsigned char *outbuf=NULL;\r\nunsigned char shortbuf[8];\r\nunsigned char *p;\r\nconst unsigned char *cp;\r\nstatic int start=1;\r\nif (outbuf == NULL)\r\n{\r\noutbuf=OPENSSL_malloc(BSIZE+HDRSIZE);\r\nif (outbuf == NULL) return(-1);\r\n}\r\nif (start)\r\n{\r\nstart=0;\r\n}\r\nif (len > MAXWRITE)\r\n{\r\nj=0;\r\nfor (i=0; i<len; i+=k)\r\n{\r\nk=DES_enc_write(fd,&(buf[i]),\r\n((len-i) > MAXWRITE)?MAXWRITE:(len-i),sched,iv);\r\nif (k < 0)\r\nreturn(k);\r\nelse\r\nj+=k;\r\n}\r\nreturn(j);\r\n}\r\np=outbuf;\r\nl2n(len,p);\r\nif (len < 8)\r\n{\r\ncp=shortbuf;\r\nmemcpy(shortbuf,buf,len);\r\nRAND_pseudo_bytes(shortbuf+len, 8-len);\r\nrnum=8;\r\n}\r\nelse\r\n{\r\ncp=buf;\r\nrnum=((len+7)/8*8);\r\n}\r\nif (DES_rw_mode & DES_PCBC_MODE)\r\nDES_pcbc_encrypt(cp,&(outbuf[HDRSIZE]),(len<8)?8:len,sched,iv,\r\nDES_ENCRYPT);\r\nelse\r\nDES_cbc_encrypt(cp,&(outbuf[HDRSIZE]),(len<8)?8:len,sched,iv,\r\nDES_ENCRYPT);\r\noutnum=rnum+HDRSIZE;\r\nfor (j=0; j<outnum; j+=i)\r\n{\r\ni=write(fd,(void *)&(outbuf[j]),outnum-j);\r\nif (i == -1)\r\n{\r\n#ifdef EINTR\r\nif (errno == EINTR)\r\ni=0;\r\nelse\r\n#endif\r\nreturn(-1);\r\n}\r\n}\r\nreturn(len);\r\n}

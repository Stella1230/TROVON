void DES_encrypt1(DES_LONG *data, DES_key_schedule *ks, int enc)\r\n{\r\nregister DES_LONG l,r,t,u;\r\n#ifdef DES_PTR\r\nregister const unsigned char *des_SP=(const unsigned char *)DES_SPtrans;\r\n#endif\r\n#ifndef DES_UNROLL\r\nregister int i;\r\n#endif\r\nregister DES_LONG *s;\r\nr=data[0];\r\nl=data[1];\r\nIP(r,l);\r\nr=ROTATE(r,29)&0xffffffffL;\r\nl=ROTATE(l,29)&0xffffffffL;\r\ns=ks->ks->deslong;\r\nif (enc)\r\n{\r\n#ifdef DES_UNROLL\r\nD_ENCRYPT(l,r, 0);\r\nD_ENCRYPT(r,l, 2);\r\nD_ENCRYPT(l,r, 4);\r\nD_ENCRYPT(r,l, 6);\r\nD_ENCRYPT(l,r, 8);\r\nD_ENCRYPT(r,l,10);\r\nD_ENCRYPT(l,r,12);\r\nD_ENCRYPT(r,l,14);\r\nD_ENCRYPT(l,r,16);\r\nD_ENCRYPT(r,l,18);\r\nD_ENCRYPT(l,r,20);\r\nD_ENCRYPT(r,l,22);\r\nD_ENCRYPT(l,r,24);\r\nD_ENCRYPT(r,l,26);\r\nD_ENCRYPT(l,r,28);\r\nD_ENCRYPT(r,l,30);\r\n#else\r\nfor (i=0; i<32; i+=8)\r\n{\r\nD_ENCRYPT(l,r,i+0);\r\nD_ENCRYPT(r,l,i+2);\r\nD_ENCRYPT(l,r,i+4);\r\nD_ENCRYPT(r,l,i+6);\r\n}\r\n#endif\r\n}\r\nelse\r\n{\r\n#ifdef DES_UNROLL\r\nD_ENCRYPT(l,r,30);\r\nD_ENCRYPT(r,l,28);\r\nD_ENCRYPT(l,r,26);\r\nD_ENCRYPT(r,l,24);\r\nD_ENCRYPT(l,r,22);\r\nD_ENCRYPT(r,l,20);\r\nD_ENCRYPT(l,r,18);\r\nD_ENCRYPT(r,l,16);\r\nD_ENCRYPT(l,r,14);\r\nD_ENCRYPT(r,l,12);\r\nD_ENCRYPT(l,r,10);\r\nD_ENCRYPT(r,l, 8);\r\nD_ENCRYPT(l,r, 6);\r\nD_ENCRYPT(r,l, 4);\r\nD_ENCRYPT(l,r, 2);\r\nD_ENCRYPT(r,l, 0);\r\n#else\r\nfor (i=30; i>0; i-=8)\r\n{\r\nD_ENCRYPT(l,r,i-0);\r\nD_ENCRYPT(r,l,i-2);\r\nD_ENCRYPT(l,r,i-4);\r\nD_ENCRYPT(r,l,i-6);\r\n}\r\n#endif\r\n}\r\nl=ROTATE(l,3)&0xffffffffL;\r\nr=ROTATE(r,3)&0xffffffffL;\r\nFP(r,l);\r\ndata[0]=l;\r\ndata[1]=r;\r\nl=r=t=u=0;\r\n}\r\nvoid DES_encrypt2(DES_LONG *data, DES_key_schedule *ks, int enc)\r\n{\r\nregister DES_LONG l,r,t,u;\r\n#ifdef DES_PTR\r\nregister const unsigned char *des_SP=(const unsigned char *)DES_SPtrans;\r\n#endif\r\n#ifndef DES_UNROLL\r\nregister int i;\r\n#endif\r\nregister DES_LONG *s;\r\nr=data[0];\r\nl=data[1];\r\nr=ROTATE(r,29)&0xffffffffL;\r\nl=ROTATE(l,29)&0xffffffffL;\r\ns=ks->ks->deslong;\r\nif (enc)\r\n{\r\n#ifdef DES_UNROLL\r\nD_ENCRYPT(l,r, 0);\r\nD_ENCRYPT(r,l, 2);\r\nD_ENCRYPT(l,r, 4);\r\nD_ENCRYPT(r,l, 6);\r\nD_ENCRYPT(l,r, 8);\r\nD_ENCRYPT(r,l,10);\r\nD_ENCRYPT(l,r,12);\r\nD_ENCRYPT(r,l,14);\r\nD_ENCRYPT(l,r,16);\r\nD_ENCRYPT(r,l,18);\r\nD_ENCRYPT(l,r,20);\r\nD_ENCRYPT(r,l,22);\r\nD_ENCRYPT(l,r,24);\r\nD_ENCRYPT(r,l,26);\r\nD_ENCRYPT(l,r,28);\r\nD_ENCRYPT(r,l,30);\r\n#else\r\nfor (i=0; i<32; i+=8)\r\n{\r\nD_ENCRYPT(l,r,i+0);\r\nD_ENCRYPT(r,l,i+2);\r\nD_ENCRYPT(l,r,i+4);\r\nD_ENCRYPT(r,l,i+6);\r\n}\r\n#endif\r\n}\r\nelse\r\n{\r\n#ifdef DES_UNROLL\r\nD_ENCRYPT(l,r,30);\r\nD_ENCRYPT(r,l,28);\r\nD_ENCRYPT(l,r,26);\r\nD_ENCRYPT(r,l,24);\r\nD_ENCRYPT(l,r,22);\r\nD_ENCRYPT(r,l,20);\r\nD_ENCRYPT(l,r,18);\r\nD_ENCRYPT(r,l,16);\r\nD_ENCRYPT(l,r,14);\r\nD_ENCRYPT(r,l,12);\r\nD_ENCRYPT(l,r,10);\r\nD_ENCRYPT(r,l, 8);\r\nD_ENCRYPT(l,r, 6);\r\nD_ENCRYPT(r,l, 4);\r\nD_ENCRYPT(l,r, 2);\r\nD_ENCRYPT(r,l, 0);\r\n#else\r\nfor (i=30; i>0; i-=8)\r\n{\r\nD_ENCRYPT(l,r,i-0);\r\nD_ENCRYPT(r,l,i-2);\r\nD_ENCRYPT(l,r,i-4);\r\nD_ENCRYPT(r,l,i-6);\r\n}\r\n#endif\r\n}\r\ndata[0]=ROTATE(l,3)&0xffffffffL;\r\ndata[1]=ROTATE(r,3)&0xffffffffL;\r\nl=r=t=u=0;\r\n}\r\nvoid DES_encrypt3(DES_LONG *data, DES_key_schedule *ks1,\r\nDES_key_schedule *ks2, DES_key_schedule *ks3)\r\n{\r\nregister DES_LONG l,r;\r\nl=data[0];\r\nr=data[1];\r\nIP(l,r);\r\ndata[0]=l;\r\ndata[1]=r;\r\nDES_encrypt2((DES_LONG *)data,ks1,DES_ENCRYPT);\r\nDES_encrypt2((DES_LONG *)data,ks2,DES_DECRYPT);\r\nDES_encrypt2((DES_LONG *)data,ks3,DES_ENCRYPT);\r\nl=data[0];\r\nr=data[1];\r\nFP(r,l);\r\ndata[0]=l;\r\ndata[1]=r;\r\n}\r\nvoid DES_decrypt3(DES_LONG *data, DES_key_schedule *ks1,\r\nDES_key_schedule *ks2, DES_key_schedule *ks3)\r\n{\r\nregister DES_LONG l,r;\r\nl=data[0];\r\nr=data[1];\r\nIP(l,r);\r\ndata[0]=l;\r\ndata[1]=r;\r\nDES_encrypt2((DES_LONG *)data,ks3,DES_DECRYPT);\r\nDES_encrypt2((DES_LONG *)data,ks2,DES_ENCRYPT);\r\nDES_encrypt2((DES_LONG *)data,ks1,DES_DECRYPT);\r\nl=data[0];\r\nr=data[1];\r\nFP(r,l);\r\ndata[0]=l;\r\ndata[1]=r;\r\n}\r\nvoid DES_ede3_cbc_encrypt(const unsigned char *input, unsigned char *output,\r\nlong length, DES_key_schedule *ks1,\r\nDES_key_schedule *ks2, DES_key_schedule *ks3,\r\nDES_cblock *ivec, int enc)\r\n{\r\nregister DES_LONG tin0,tin1;\r\nregister DES_LONG tout0,tout1,xor0,xor1;\r\nregister const unsigned char *in;\r\nunsigned char *out;\r\nregister long l=length;\r\nDES_LONG tin[2];\r\nunsigned char *iv;\r\nin=input;\r\nout=output;\r\niv = &(*ivec)[0];\r\nif (enc)\r\n{\r\nc2l(iv,tout0);\r\nc2l(iv,tout1);\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nDES_encrypt3((DES_LONG *)tin,ks1,ks2,ks3);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nc2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nDES_encrypt3((DES_LONG *)tin,ks1,ks2,ks3);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\n}\r\niv = &(*ivec)[0];\r\nl2c(tout0,iv);\r\nl2c(tout1,iv);\r\n}\r\nelse\r\n{\r\nregister DES_LONG t0,t1;\r\nc2l(iv,xor0);\r\nc2l(iv,xor1);\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\nt0=tin0;\r\nt1=tin1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nDES_decrypt3((DES_LONG *)tin,ks1,ks2,ks3);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\ntout0^=xor0;\r\ntout1^=xor1;\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\nxor0=t0;\r\nxor1=t1;\r\n}\r\nif (l != -8)\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\nt0=tin0;\r\nt1=tin1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nDES_decrypt3((DES_LONG *)tin,ks1,ks2,ks3);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\ntout0^=xor0;\r\ntout1^=xor1;\r\nl2cn(tout0,tout1,out,l+8);\r\nxor0=t0;\r\nxor1=t1;\r\n}\r\niv = &(*ivec)[0];\r\nl2c(xor0,iv);\r\nl2c(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}

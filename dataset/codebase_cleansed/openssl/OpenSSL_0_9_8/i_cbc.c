void idea_cbc_encrypt(const unsigned char *in, unsigned char *out, long length,\r\nIDEA_KEY_SCHEDULE *ks, unsigned char *iv, int encrypt)\r\n{\r\nregister unsigned long tin0,tin1;\r\nregister unsigned long tout0,tout1,xor0,xor1;\r\nregister long l=length;\r\nunsigned long tin[2];\r\nif (encrypt)\r\n{\r\nn2l(iv,tout0);\r\nn2l(iv,tout1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nn2l(in,tin0);\r\nn2l(in,tin1);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nidea_encrypt(tin,ks);\r\ntout0=tin[0]; l2n(tout0,out);\r\ntout1=tin[1]; l2n(tout1,out);\r\n}\r\nif (l != -8)\r\n{\r\nn2ln(in,tin0,tin1,l+8);\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nidea_encrypt(tin,ks);\r\ntout0=tin[0]; l2n(tout0,out);\r\ntout1=tin[1]; l2n(tout1,out);\r\n}\r\nl2n(tout0,iv);\r\nl2n(tout1,iv);\r\n}\r\nelse\r\n{\r\nn2l(iv,xor0);\r\nn2l(iv,xor1);\r\niv-=8;\r\nfor (l-=8; l>=0; l-=8)\r\n{\r\nn2l(in,tin0); tin[0]=tin0;\r\nn2l(in,tin1); tin[1]=tin1;\r\nidea_encrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2n(tout0,out);\r\nl2n(tout1,out);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nif (l != -8)\r\n{\r\nn2l(in,tin0); tin[0]=tin0;\r\nn2l(in,tin1); tin[1]=tin1;\r\nidea_encrypt(tin,ks);\r\ntout0=tin[0]^xor0;\r\ntout1=tin[1]^xor1;\r\nl2nn(tout0,tout1,out,l+8);\r\nxor0=tin0;\r\nxor1=tin1;\r\n}\r\nl2n(xor0,iv);\r\nl2n(xor1,iv);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}\r\nvoid idea_encrypt(unsigned long *d, IDEA_KEY_SCHEDULE *key)\r\n{\r\nregister IDEA_INT *p;\r\nregister unsigned long x1,x2,x3,x4,t0,t1,ul;\r\nx2=d[0];\r\nx1=(x2>>16);\r\nx4=d[1];\r\nx3=(x4>>16);\r\np= &(key->data[0][0]);\r\nE_IDEA(0);\r\nE_IDEA(1);\r\nE_IDEA(2);\r\nE_IDEA(3);\r\nE_IDEA(4);\r\nE_IDEA(5);\r\nE_IDEA(6);\r\nE_IDEA(7);\r\nx1&=0xffff;\r\nidea_mul(x1,x1,*p,ul); p++;\r\nt0= x3+ *(p++);\r\nt1= x2+ *(p++);\r\nx4&=0xffff;\r\nidea_mul(x4,x4,*p,ul);\r\nd[0]=(t0&0xffff)|((x1&0xffff)<<16);\r\nd[1]=(x4&0xffff)|((t1&0xffff)<<16);\r\n}

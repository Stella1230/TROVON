BIO_METHOD *BIO_s_mem(void)\r\n{\r\nreturn(&mem_method);\r\n}\r\nBIO *BIO_new_mem_buf(void *buf, int len)\r\n{\r\nBIO *ret;\r\nBUF_MEM *b;\r\nif (!buf) {\r\nBIOerr(BIO_F_BIO_NEW_MEM_BUF,BIO_R_NULL_PARAMETER);\r\nreturn NULL;\r\n}\r\nif(len == -1) len = strlen(buf);\r\nif(!(ret = BIO_new(BIO_s_mem())) ) return NULL;\r\nb = (BUF_MEM *)ret->ptr;\r\nb->data = buf;\r\nb->length = len;\r\nb->max = len;\r\nret->flags |= BIO_FLAGS_MEM_RDONLY;\r\nret->num = 0;\r\nreturn ret;\r\n}\r\nstatic int mem_new(BIO *bi)\r\n{\r\nBUF_MEM *b;\r\nif ((b=BUF_MEM_new()) == NULL)\r\nreturn(0);\r\nbi->shutdown=1;\r\nbi->init=1;\r\nbi->num= -1;\r\nbi->ptr=(char *)b;\r\nreturn(1);\r\n}\r\nstatic int mem_free(BIO *a)\r\n{\r\nif (a == NULL) return(0);\r\nif (a->shutdown)\r\n{\r\nif ((a->init) && (a->ptr != NULL))\r\n{\r\nBUF_MEM *b;\r\nb = (BUF_MEM *)a->ptr;\r\nif(a->flags & BIO_FLAGS_MEM_RDONLY) b->data = NULL;\r\nBUF_MEM_free(b);\r\na->ptr=NULL;\r\n}\r\n}\r\nreturn(1);\r\n}\r\nstatic int mem_read(BIO *b, char *out, int outl)\r\n{\r\nint ret= -1;\r\nBUF_MEM *bm;\r\nint i;\r\nchar *from,*to;\r\nbm=(BUF_MEM *)b->ptr;\r\nBIO_clear_retry_flags(b);\r\nret=(outl > bm->length)?bm->length:outl;\r\nif ((out != NULL) && (ret > 0)) {\r\nmemcpy(out,bm->data,ret);\r\nbm->length-=ret;\r\nif(b->flags & BIO_FLAGS_MEM_RDONLY) bm->data += ret;\r\nelse {\r\nfrom=(char *)&(bm->data[ret]);\r\nto=(char *)&(bm->data[0]);\r\nfor (i=0; i<bm->length; i++)\r\nto[i]=from[i];\r\n}\r\n} else if (bm->length == 0)\r\n{\r\nret = b->num;\r\nif (ret != 0)\r\nBIO_set_retry_read(b);\r\n}\r\nreturn(ret);\r\n}\r\nstatic int mem_write(BIO *b, const char *in, int inl)\r\n{\r\nint ret= -1;\r\nint blen;\r\nBUF_MEM *bm;\r\nbm=(BUF_MEM *)b->ptr;\r\nif (in == NULL)\r\n{\r\nBIOerr(BIO_F_MEM_WRITE,BIO_R_NULL_PARAMETER);\r\ngoto end;\r\n}\r\nif(b->flags & BIO_FLAGS_MEM_RDONLY) {\r\nBIOerr(BIO_F_MEM_WRITE,BIO_R_WRITE_TO_READ_ONLY_BIO);\r\ngoto end;\r\n}\r\nBIO_clear_retry_flags(b);\r\nblen=bm->length;\r\nif (BUF_MEM_grow_clean(bm,blen+inl) != (blen+inl))\r\ngoto end;\r\nmemcpy(&(bm->data[blen]),in,inl);\r\nret=inl;\r\nend:\r\nreturn(ret);\r\n}\r\nstatic long mem_ctrl(BIO *b, int cmd, long num, void *ptr)\r\n{\r\nlong ret=1;\r\nchar **pptr;\r\nBUF_MEM *bm=(BUF_MEM *)b->ptr;\r\nswitch (cmd)\r\n{\r\ncase BIO_CTRL_RESET:\r\nif (bm->data != NULL)\r\n{\r\nif(b->flags & BIO_FLAGS_MEM_RDONLY)\r\n{\r\nbm->data -= bm->max - bm->length;\r\nbm->length = bm->max;\r\n}\r\nelse\r\n{\r\nmemset(bm->data,0,bm->max);\r\nbm->length=0;\r\n}\r\n}\r\nbreak;\r\ncase BIO_CTRL_EOF:\r\nret=(long)(bm->length == 0);\r\nbreak;\r\ncase BIO_C_SET_BUF_MEM_EOF_RETURN:\r\nb->num=(int)num;\r\nbreak;\r\ncase BIO_CTRL_INFO:\r\nret=(long)bm->length;\r\nif (ptr != NULL)\r\n{\r\npptr=(char **)ptr;\r\n*pptr=(char *)&(bm->data[0]);\r\n}\r\nbreak;\r\ncase BIO_C_SET_BUF_MEM:\r\nmem_free(b);\r\nb->shutdown=(int)num;\r\nb->ptr=ptr;\r\nbreak;\r\ncase BIO_C_GET_BUF_MEM_PTR:\r\nif (ptr != NULL)\r\n{\r\npptr=(char **)ptr;\r\n*pptr=(char *)bm;\r\n}\r\nbreak;\r\ncase BIO_CTRL_GET_CLOSE:\r\nret=(long)b->shutdown;\r\nbreak;\r\ncase BIO_CTRL_SET_CLOSE:\r\nb->shutdown=(int)num;\r\nbreak;\r\ncase BIO_CTRL_WPENDING:\r\nret=0L;\r\nbreak;\r\ncase BIO_CTRL_PENDING:\r\nret=(long)bm->length;\r\nbreak;\r\ncase BIO_CTRL_DUP:\r\ncase BIO_CTRL_FLUSH:\r\nret=1;\r\nbreak;\r\ncase BIO_CTRL_PUSH:\r\ncase BIO_CTRL_POP:\r\ndefault:\r\nret=0;\r\nbreak;\r\n}\r\nreturn(ret);\r\n}\r\nstatic int mem_gets(BIO *bp, char *buf, int size)\r\n{\r\nint i,j;\r\nint ret= -1;\r\nchar *p;\r\nBUF_MEM *bm=(BUF_MEM *)bp->ptr;\r\nBIO_clear_retry_flags(bp);\r\nj=bm->length;\r\nif (j <= 0)\r\n{\r\n*buf='\0';\r\nreturn 0;\r\n}\r\np=bm->data;\r\nfor (i=0; i<j; i++)\r\n{\r\nif (p[i] == '\n') break;\r\n}\r\nif (i == j)\r\n{\r\nBIO_set_retry_read(bp);\r\n}\r\nelse\r\ni++;\r\nif ((size-1) < i) i=size-1;\r\ni=mem_read(bp,buf,i);\r\nif (i > 0) buf[i]='\0';\r\nret=i;\r\nreturn(ret);\r\n}\r\nstatic int mem_puts(BIO *bp, const char *str)\r\n{\r\nint n,ret;\r\nn=strlen(str);\r\nret=mem_write(bp,str,n);\r\nreturn(ret);\r\n}

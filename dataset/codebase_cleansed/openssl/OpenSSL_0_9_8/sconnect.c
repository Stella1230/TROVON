int main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nchar *host;\r\nBIO *out;\r\nchar buf[1024*10],*p;\r\nSSL_CTX *ssl_ctx=NULL;\r\nSSL *ssl;\r\nBIO *ssl_bio;\r\nint i,len,off,ret=1;\r\nif (argc <= 1)\r\nhost="localhost:4433";\r\nelse\r\nhost=argv[1];\r\n#ifdef WATT32\r\ndbug_init();\r\nsock_init();\r\n#endif\r\nSSL_load_error_strings();\r\nOpenSSL_add_ssl_algorithms();\r\nssl_ctx=SSL_CTX_new(SSLv23_client_method());\r\nssl=SSL_new(ssl_ctx);\r\nSSL_set_connect_state(ssl);\r\nssl_bio=BIO_new(BIO_f_ssl());\r\nBIO_set_ssl(ssl_bio,ssl,BIO_CLOSE);\r\nout=BIO_new(BIO_s_connect());\r\nBIO_set_conn_hostname(out,host);\r\nBIO_set_nbio(out,1);\r\nout=BIO_push(ssl_bio,out);\r\np="GET / HTTP/1.0\r\n\r\n";\r\nlen=strlen(p);\r\noff=0;\r\nfor (;;)\r\n{\r\ni=BIO_write(out,&(p[off]),len);\r\nif (i <= 0)\r\n{\r\nif (BIO_should_retry(out))\r\n{\r\nfprintf(stderr,"write DELAY\n");\r\nsleep(1);\r\ncontinue;\r\n}\r\nelse\r\n{\r\ngoto err;\r\n}\r\n}\r\noff+=i;\r\nlen-=i;\r\nif (len <= 0) break;\r\n}\r\nfor (;;)\r\n{\r\ni=BIO_read(out,buf,sizeof(buf));\r\nif (i == 0) break;\r\nif (i < 0)\r\n{\r\nif (BIO_should_retry(out))\r\n{\r\nfprintf(stderr,"read DELAY\n");\r\nsleep(1);\r\ncontinue;\r\n}\r\ngoto err;\r\n}\r\nfwrite(buf,1,i,stdout);\r\n}\r\nret=1;\r\nif (0)\r\n{\r\nerr:\r\nif (ERR_peek_error() == 0)\r\n{\r\nfprintf(stderr,"errno=%d ",errno);\r\nperror("error");\r\n}\r\nelse\r\nERR_print_errors_fp(stderr);\r\n}\r\nBIO_free_all(out);\r\nif (ssl_ctx != NULL) SSL_CTX_free(ssl_ctx);\r\nexit(!ret);\r\nreturn(ret);\r\n}

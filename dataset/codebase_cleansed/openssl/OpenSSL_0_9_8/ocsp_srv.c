int OCSP_request_onereq_count(OCSP_REQUEST *req)\r\n{\r\nreturn sk_OCSP_ONEREQ_num(req->tbsRequest->requestList);\r\n}\r\nOCSP_ONEREQ *OCSP_request_onereq_get0(OCSP_REQUEST *req, int i)\r\n{\r\nreturn sk_OCSP_ONEREQ_value(req->tbsRequest->requestList, i);\r\n}\r\nOCSP_CERTID *OCSP_onereq_get0_id(OCSP_ONEREQ *one)\r\n{\r\nreturn one->reqCert;\r\n}\r\nint OCSP_id_get0_info(ASN1_OCTET_STRING **piNameHash, ASN1_OBJECT **pmd,\r\nASN1_OCTET_STRING **pikeyHash,\r\nASN1_INTEGER **pserial, OCSP_CERTID *cid)\r\n{\r\nif (!cid) return 0;\r\nif (pmd) *pmd = cid->hashAlgorithm->algorithm;\r\nif(piNameHash) *piNameHash = cid->issuerNameHash;\r\nif (pikeyHash) *pikeyHash = cid->issuerKeyHash;\r\nif (pserial) *pserial = cid->serialNumber;\r\nreturn 1;\r\n}\r\nint OCSP_request_is_signed(OCSP_REQUEST *req)\r\n{\r\nif(req->optionalSignature) return 1;\r\nreturn 0;\r\n}\r\nOCSP_RESPONSE *OCSP_response_create(int status, OCSP_BASICRESP *bs)\r\n{\r\nOCSP_RESPONSE *rsp = NULL;\r\nif (!(rsp = OCSP_RESPONSE_new())) goto err;\r\nif (!(ASN1_ENUMERATED_set(rsp->responseStatus, status))) goto err;\r\nif (!bs) return rsp;\r\nif (!(rsp->responseBytes = OCSP_RESPBYTES_new())) goto err;\r\nrsp->responseBytes->responseType = OBJ_nid2obj(NID_id_pkix_OCSP_basic);\r\nif (!ASN1_item_pack(bs, ASN1_ITEM_rptr(OCSP_BASICRESP), &rsp->responseBytes->response))\r\ngoto err;\r\nreturn rsp;\r\nerr:\r\nif (rsp) OCSP_RESPONSE_free(rsp);\r\nreturn NULL;\r\n}\r\nOCSP_SINGLERESP *OCSP_basic_add1_status(OCSP_BASICRESP *rsp,\r\nOCSP_CERTID *cid,\r\nint status, int reason,\r\nASN1_TIME *revtime,\r\nASN1_TIME *thisupd, ASN1_TIME *nextupd)\r\n{\r\nOCSP_SINGLERESP *single = NULL;\r\nOCSP_CERTSTATUS *cs;\r\nOCSP_REVOKEDINFO *ri;\r\nif(!rsp->tbsResponseData->responses &&\r\n!(rsp->tbsResponseData->responses = sk_OCSP_SINGLERESP_new_null()))\r\ngoto err;\r\nif (!(single = OCSP_SINGLERESP_new()))\r\ngoto err;\r\nif (!ASN1_TIME_to_generalizedtime(thisupd, &single->thisUpdate))\r\ngoto err;\r\nif (nextupd &&\r\n!ASN1_TIME_to_generalizedtime(nextupd, &single->nextUpdate))\r\ngoto err;\r\nOCSP_CERTID_free(single->certId);\r\nif(!(single->certId = OCSP_CERTID_dup(cid)))\r\ngoto err;\r\ncs = single->certStatus;\r\nswitch(cs->type = status)\r\n{\r\ncase V_OCSP_CERTSTATUS_REVOKED:\r\nif (!revtime)\r\n{\r\nOCSPerr(OCSP_F_OCSP_BASIC_ADD1_STATUS,OCSP_R_NO_REVOKED_TIME);\r\ngoto err;\r\n}\r\nif (!(cs->value.revoked = ri = OCSP_REVOKEDINFO_new())) goto err;\r\nif (!ASN1_TIME_to_generalizedtime(revtime, &ri->revocationTime))\r\ngoto err;\r\nif (reason != OCSP_REVOKED_STATUS_NOSTATUS)\r\n{\r\nif (!(ri->revocationReason = ASN1_ENUMERATED_new()))\r\ngoto err;\r\nif (!(ASN1_ENUMERATED_set(ri->revocationReason,\r\nreason)))\r\ngoto err;\r\n}\r\nbreak;\r\ncase V_OCSP_CERTSTATUS_GOOD:\r\ncs->value.good = ASN1_NULL_new();\r\nbreak;\r\ncase V_OCSP_CERTSTATUS_UNKNOWN:\r\ncs->value.unknown = ASN1_NULL_new();\r\nbreak;\r\ndefault:\r\ngoto err;\r\n}\r\nif (!(sk_OCSP_SINGLERESP_push(rsp->tbsResponseData->responses, single)))\r\ngoto err;\r\nreturn single;\r\nerr:\r\nOCSP_SINGLERESP_free(single);\r\nreturn NULL;\r\n}\r\nint OCSP_basic_add1_cert(OCSP_BASICRESP *resp, X509 *cert)\r\n{\r\nif (!resp->certs && !(resp->certs = sk_X509_new_null()))\r\nreturn 0;\r\nif(!sk_X509_push(resp->certs, cert)) return 0;\r\nCRYPTO_add(&cert->references, 1, CRYPTO_LOCK_X509);\r\nreturn 1;\r\n}

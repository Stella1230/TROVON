int main(int argc, char *argv[])\r\n{\r\nERR_load_crypto_strings();\r\nif ((argc == 1))\r\n{\r\nmain_encrypt();\r\n}\r\nelse if ((argc == 2) && !strcmp(argv[1],"-d"))\r\n{\r\nmain_decrypt();\r\n}\r\nelse\r\n{\r\nprintf("%s",usage);\r\nexit(1);\r\n}\r\nreturn 0;\r\n}\r\nvoid main_encrypt(void)\r\n{\r\nunsigned int ebuflen;\r\nEVP_CIPHER_CTX ectx;\r\nunsigned char iv[EVP_MAX_IV_LENGTH];\r\nunsigned char *ekey[1];\r\nint readlen;\r\nint ekeylen, net_ekeylen;\r\nEVP_PKEY *pubKey[1];\r\nchar buf[512];\r\nchar ebuf[512];\r\nmemset(iv, '\0', sizeof(iv));\r\npubKey[0] = ReadPublicKey(PUBFILE);\r\nif(!pubKey[0])\r\n{\r\nfprintf(stderr,"Error: can't load public key");\r\nexit(1);\r\n}\r\nekey[0] = malloc(EVP_PKEY_size(pubKey[0]));\r\nif (!ekey[0])\r\n{\r\nEVP_PKEY_free(pubKey[0]);\r\nperror("malloc");\r\nexit(1);\r\n}\r\nEVP_SealInit(&ectx,\r\nEVP_des_ede3_cbc(),\r\nekey,\r\n&ekeylen,\r\niv,\r\npubKey,\r\n1);\r\nnet_ekeylen = htonl(ekeylen);\r\nwrite(STDOUT, (char*)&net_ekeylen, sizeof(net_ekeylen));\r\nwrite(STDOUT, ekey[0], ekeylen);\r\nwrite(STDOUT, iv, sizeof(iv));\r\nwhile(1)\r\n{\r\nreadlen = read(STDIN, buf, sizeof(buf));\r\nif (readlen <= 0)\r\n{\r\nif (readlen < 0)\r\nperror("read");\r\nbreak;\r\n}\r\nEVP_SealUpdate(&ectx, ebuf, &ebuflen, buf, readlen);\r\nwrite(STDOUT, ebuf, ebuflen);\r\n}\r\nEVP_SealFinal(&ectx, ebuf, &ebuflen);\r\nwrite(STDOUT, ebuf, ebuflen);\r\nEVP_PKEY_free(pubKey[0]);\r\nfree(ekey[0]);\r\n}\r\nvoid main_decrypt(void)\r\n{\r\nchar buf[520];\r\nchar ebuf[512];\r\nunsigned int buflen;\r\nEVP_CIPHER_CTX ectx;\r\nunsigned char iv[EVP_MAX_IV_LENGTH];\r\nunsigned char *encryptKey;\r\nunsigned int ekeylen;\r\nEVP_PKEY *privateKey;\r\nmemset(iv, '\0', sizeof(iv));\r\nprivateKey = ReadPrivateKey(PRIVFILE);\r\nif (!privateKey)\r\n{\r\nfprintf(stderr, "Error: can't load private key");\r\nexit(1);\r\n}\r\nread(STDIN, &ekeylen, sizeof(ekeylen));\r\nekeylen = ntohl(ekeylen);\r\nif (ekeylen != EVP_PKEY_size(privateKey))\r\n{\r\nEVP_PKEY_free(privateKey);\r\nfprintf(stderr, "keylength mismatch");\r\nexit(1);\r\n}\r\nencryptKey = malloc(sizeof(char) * ekeylen);\r\nif (!encryptKey)\r\n{\r\nEVP_PKEY_free(privateKey);\r\nperror("malloc");\r\nexit(1);\r\n}\r\nread(STDIN, encryptKey, ekeylen);\r\nread(STDIN, iv, sizeof(iv));\r\nEVP_OpenInit(&ectx,\r\nEVP_des_ede3_cbc(),\r\nencryptKey,\r\nekeylen,\r\niv,\r\nprivateKey);\r\nwhile(1)\r\n{\r\nint readlen = read(STDIN, ebuf, sizeof(ebuf));\r\nif (readlen <= 0)\r\n{\r\nif (readlen < 0)\r\nperror("read");\r\nbreak;\r\n}\r\nEVP_OpenUpdate(&ectx, buf, &buflen, ebuf, readlen);\r\nwrite(STDOUT, buf, buflen);\r\n}\r\nEVP_OpenFinal(&ectx, buf, &buflen);\r\nwrite(STDOUT, buf, buflen);\r\nEVP_PKEY_free(privateKey);\r\nfree(encryptKey);\r\n}

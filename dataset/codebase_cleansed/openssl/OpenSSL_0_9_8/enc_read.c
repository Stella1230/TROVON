int DES_enc_read(int fd, void *buf, int len, DES_key_schedule *sched,\r\nDES_cblock *iv)\r\n{\r\nint net_num=0;\r\nstatic unsigned char *net=NULL;\r\nstatic unsigned char *unnet=NULL;\r\nstatic int unnet_start=0;\r\nstatic int unnet_left=0;\r\nstatic unsigned char *tmpbuf=NULL;\r\nint i;\r\nlong num=0,rnum;\r\nunsigned char *p;\r\nif (tmpbuf == NULL)\r\n{\r\ntmpbuf=OPENSSL_malloc(BSIZE);\r\nif (tmpbuf == NULL) return(-1);\r\n}\r\nif (net == NULL)\r\n{\r\nnet=OPENSSL_malloc(BSIZE);\r\nif (net == NULL) return(-1);\r\n}\r\nif (unnet == NULL)\r\n{\r\nunnet=OPENSSL_malloc(BSIZE);\r\nif (unnet == NULL) return(-1);\r\n}\r\nif (unnet_left != 0)\r\n{\r\nif (unnet_left < len)\r\n{\r\nmemcpy(buf,&(unnet[unnet_start]),\r\nunnet_left);\r\ni=unnet_left;\r\nunnet_start=unnet_left=0;\r\n}\r\nelse\r\n{\r\nmemcpy(buf,&(unnet[unnet_start]),len);\r\nunnet_start+=len;\r\nunnet_left-=len;\r\ni=len;\r\n}\r\nreturn(i);\r\n}\r\nif (len > MAXWRITE) len=MAXWRITE;\r\nwhile (net_num < HDRSIZE)\r\n{\r\ni=read(fd,(void *)&(net[net_num]),HDRSIZE-net_num);\r\n#ifdef EINTR\r\nif ((i == -1) && (errno == EINTR)) continue;\r\n#endif\r\nif (i <= 0) return(0);\r\nnet_num+=i;\r\n}\r\np=net;\r\nn2l(p,num);\r\nif ((num > MAXWRITE) || (num < 0))\r\nreturn(-1);\r\nrnum=(num < 8)?8:((num+7)/8*8);\r\nnet_num=0;\r\nwhile (net_num < rnum)\r\n{\r\ni=read(fd,(void *)&(net[net_num]),rnum-net_num);\r\n#ifdef EINTR\r\nif ((i == -1) && (errno == EINTR)) continue;\r\n#endif\r\nif (i <= 0) return(0);\r\nnet_num+=i;\r\n}\r\nif (len < num)\r\n{\r\nif (DES_rw_mode & DES_PCBC_MODE)\r\nDES_pcbc_encrypt(net,unnet,num,sched,iv,DES_DECRYPT);\r\nelse\r\nDES_cbc_encrypt(net,unnet,num,sched,iv,DES_DECRYPT);\r\nmemcpy(buf,unnet,len);\r\nunnet_start=len;\r\nunnet_left=num-len;\r\nnum=len;\r\n}\r\nelse\r\n{\r\nif (len < rnum)\r\n{\r\nif (DES_rw_mode & DES_PCBC_MODE)\r\nDES_pcbc_encrypt(net,tmpbuf,num,sched,iv,\r\nDES_DECRYPT);\r\nelse\r\nDES_cbc_encrypt(net,tmpbuf,num,sched,iv,\r\nDES_DECRYPT);\r\nmemcpy(buf,tmpbuf,num);\r\n}\r\nelse\r\n{\r\nif (DES_rw_mode & DES_PCBC_MODE)\r\nDES_pcbc_encrypt(net,buf,num,sched,iv,\r\nDES_DECRYPT);\r\nelse\r\nDES_cbc_encrypt(net,buf,num,sched,iv,\r\nDES_DECRYPT);\r\n}\r\n}\r\nreturn num;\r\n}

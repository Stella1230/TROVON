int MAIN(int argc, char **argv)\r\n{\r\nint i,badops=0;\r\nBIO *in=NULL,*out=NULL;\r\nint informat,outformat;\r\nchar *infile,*outfile,*prog,*certfile;\r\nPKCS7 *p7 = NULL;\r\nPKCS7_SIGNED *p7s = NULL;\r\nX509_CRL *crl=NULL;\r\nSTACK *certflst=NULL;\r\nSTACK_OF(X509_CRL) *crl_stack=NULL;\r\nSTACK_OF(X509) *cert_stack=NULL;\r\nint ret=1,nocrl=0;\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE|BIO_FP_TEXT);\r\ninfile=NULL;\r\noutfile=NULL;\r\ninformat=FORMAT_PEM;\r\noutformat=FORMAT_PEM;\r\nprog=argv[0];\r\nargc--;\r\nargv++;\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-inform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-outform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-nocrl") == 0)\r\n{\r\nnocrl=1;\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-certfile") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\nif(!certflst) certflst = sk_new_null();\r\nsk_push(certflst,*(++argv));\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_err,"unknown option %s\n",*argv);\r\nbadops=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nBIO_printf(bio_err,"%s [options] <infile >outfile\n",prog);\r\nBIO_printf(bio_err,"where options are\n");\r\nBIO_printf(bio_err," -inform arg input format - DER or PEM\n");\r\nBIO_printf(bio_err," -outform arg output format - DER or PEM\n");\r\nBIO_printf(bio_err," -in arg input file\n");\r\nBIO_printf(bio_err," -out arg output file\n");\r\nBIO_printf(bio_err," -certfile arg certificates file of chain to a trusted CA\n");\r\nBIO_printf(bio_err," (can be used more than once)\n");\r\nBIO_printf(bio_err," -nocrl no crl to load, just certs from '-certfile'\n");\r\nret = 1;\r\ngoto end;\r\n}\r\nERR_load_crypto_strings();\r\nin=BIO_new(BIO_s_file());\r\nout=BIO_new(BIO_s_file());\r\nif ((in == NULL) || (out == NULL))\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (!nocrl)\r\n{\r\nif (infile == NULL)\r\nBIO_set_fp(in,stdin,BIO_NOCLOSE);\r\nelse\r\n{\r\nif (BIO_read_filename(in,infile) <= 0)\r\n{\r\nperror(infile);\r\ngoto end;\r\n}\r\n}\r\nif (informat == FORMAT_ASN1)\r\ncrl=d2i_X509_CRL_bio(in,NULL);\r\nelse if (informat == FORMAT_PEM)\r\ncrl=PEM_read_bio_X509_CRL(in,NULL,NULL,NULL);\r\nelse {\r\nBIO_printf(bio_err,"bad input format specified for input crl\n");\r\ngoto end;\r\n}\r\nif (crl == NULL)\r\n{\r\nBIO_printf(bio_err,"unable to load CRL\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nif ((p7=PKCS7_new()) == NULL) goto end;\r\nif ((p7s=PKCS7_SIGNED_new()) == NULL) goto end;\r\np7->type=OBJ_nid2obj(NID_pkcs7_signed);\r\np7->d.sign=p7s;\r\np7s->contents->type=OBJ_nid2obj(NID_pkcs7_data);\r\nif (!ASN1_INTEGER_set(p7s->version,1)) goto end;\r\nif ((crl_stack=sk_X509_CRL_new_null()) == NULL) goto end;\r\np7s->crl=crl_stack;\r\nif (crl != NULL)\r\n{\r\nsk_X509_CRL_push(crl_stack,crl);\r\ncrl=NULL;\r\n}\r\nif ((cert_stack=sk_X509_new_null()) == NULL) goto end;\r\np7s->cert=cert_stack;\r\nif(certflst) for(i = 0; i < sk_num(certflst); i++) {\r\ncertfile = sk_value(certflst, i);\r\nif (add_certs_from_file(cert_stack,certfile) < 0)\r\n{\r\nBIO_printf(bio_err, "error loading certificates\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\n}\r\nsk_free(certflst);\r\nif (outfile == NULL)\r\n{\r\nBIO_set_fp(out,stdout,BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nelse\r\n{\r\nif (BIO_write_filename(out,outfile) <= 0)\r\n{\r\nperror(outfile);\r\ngoto end;\r\n}\r\n}\r\nif (outformat == FORMAT_ASN1)\r\ni=i2d_PKCS7_bio(out,p7);\r\nelse if (outformat == FORMAT_PEM)\r\ni=PEM_write_bio_PKCS7(out,p7);\r\nelse {\r\nBIO_printf(bio_err,"bad output format specified for outfile\n");\r\ngoto end;\r\n}\r\nif (!i)\r\n{\r\nBIO_printf(bio_err,"unable to write pkcs7 object\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nret=0;\r\nend:\r\nif (in != NULL) BIO_free(in);\r\nif (out != NULL) BIO_free_all(out);\r\nif (p7 != NULL) PKCS7_free(p7);\r\nif (crl != NULL) X509_CRL_free(crl);\r\napps_shutdown();\r\nOPENSSL_EXIT(ret);\r\n}

int UTF8_getc(const unsigned char *str, int len, unsigned long *val)\r\n{\r\nconst unsigned char *p;\r\nunsigned long value;\r\nint ret;\r\nif(len <= 0) return 0;\r\np = str;\r\nif((*p & 0x80) == 0) {\r\nvalue = *p++ & 0x7f;\r\nret = 1;\r\n} else if((*p & 0xe0) == 0xc0) {\r\nif(len < 2) return -1;\r\nif((p[1] & 0xc0) != 0x80) return -3;\r\nvalue = (*p++ & 0x1f) << 6;\r\nvalue |= *p++ & 0x3f;\r\nif(value < 0x80) return -4;\r\nret = 2;\r\n} else if((*p & 0xf0) == 0xe0) {\r\nif(len < 3) return -1;\r\nif( ((p[1] & 0xc0) != 0x80)\r\n|| ((p[2] & 0xc0) != 0x80) ) return -3;\r\nvalue = (*p++ & 0xf) << 12;\r\nvalue |= (*p++ & 0x3f) << 6;\r\nvalue |= *p++ & 0x3f;\r\nif(value < 0x800) return -4;\r\nret = 3;\r\n} else if((*p & 0xf8) == 0xf0) {\r\nif(len < 4) return -1;\r\nif( ((p[1] & 0xc0) != 0x80)\r\n|| ((p[2] & 0xc0) != 0x80)\r\n|| ((p[3] & 0xc0) != 0x80) ) return -3;\r\nvalue = ((unsigned long)(*p++ & 0x7)) << 18;\r\nvalue |= (*p++ & 0x3f) << 12;\r\nvalue |= (*p++ & 0x3f) << 6;\r\nvalue |= *p++ & 0x3f;\r\nif(value < 0x10000) return -4;\r\nret = 4;\r\n} else if((*p & 0xfc) == 0xf8) {\r\nif(len < 5) return -1;\r\nif( ((p[1] & 0xc0) != 0x80)\r\n|| ((p[2] & 0xc0) != 0x80)\r\n|| ((p[3] & 0xc0) != 0x80)\r\n|| ((p[4] & 0xc0) != 0x80) ) return -3;\r\nvalue = ((unsigned long)(*p++ & 0x3)) << 24;\r\nvalue |= ((unsigned long)(*p++ & 0x3f)) << 18;\r\nvalue |= ((unsigned long)(*p++ & 0x3f)) << 12;\r\nvalue |= (*p++ & 0x3f) << 6;\r\nvalue |= *p++ & 0x3f;\r\nif(value < 0x200000) return -4;\r\nret = 5;\r\n} else if((*p & 0xfe) == 0xfc) {\r\nif(len < 6) return -1;\r\nif( ((p[1] & 0xc0) != 0x80)\r\n|| ((p[2] & 0xc0) != 0x80)\r\n|| ((p[3] & 0xc0) != 0x80)\r\n|| ((p[4] & 0xc0) != 0x80)\r\n|| ((p[5] & 0xc0) != 0x80) ) return -3;\r\nvalue = ((unsigned long)(*p++ & 0x1)) << 30;\r\nvalue |= ((unsigned long)(*p++ & 0x3f)) << 24;\r\nvalue |= ((unsigned long)(*p++ & 0x3f)) << 18;\r\nvalue |= ((unsigned long)(*p++ & 0x3f)) << 12;\r\nvalue |= (*p++ & 0x3f) << 6;\r\nvalue |= *p++ & 0x3f;\r\nif(value < 0x4000000) return -4;\r\nret = 6;\r\n} else return -2;\r\n*val = value;\r\nreturn ret;\r\n}\r\nint UTF8_putc(unsigned char *str, int len, unsigned long value)\r\n{\r\nif(!str) len = 6;\r\nelse if(len <= 0) return -1;\r\nif(value < 0x80) {\r\nif(str) *str = (unsigned char)value;\r\nreturn 1;\r\n}\r\nif(value < 0x800) {\r\nif(len < 2) return -1;\r\nif(str) {\r\n*str++ = (unsigned char)(((value >> 6) & 0x1f) | 0xc0);\r\n*str = (unsigned char)((value & 0x3f) | 0x80);\r\n}\r\nreturn 2;\r\n}\r\nif(value < 0x10000) {\r\nif(len < 3) return -1;\r\nif(str) {\r\n*str++ = (unsigned char)(((value >> 12) & 0xf) | 0xe0);\r\n*str++ = (unsigned char)(((value >> 6) & 0x3f) | 0x80);\r\n*str = (unsigned char)((value & 0x3f) | 0x80);\r\n}\r\nreturn 3;\r\n}\r\nif(value < 0x200000) {\r\nif(len < 4) return -1;\r\nif(str) {\r\n*str++ = (unsigned char)(((value >> 18) & 0x7) | 0xf0);\r\n*str++ = (unsigned char)(((value >> 12) & 0x3f) | 0x80);\r\n*str++ = (unsigned char)(((value >> 6) & 0x3f) | 0x80);\r\n*str = (unsigned char)((value & 0x3f) | 0x80);\r\n}\r\nreturn 4;\r\n}\r\nif(value < 0x4000000) {\r\nif(len < 5) return -1;\r\nif(str) {\r\n*str++ = (unsigned char)(((value >> 24) & 0x3) | 0xf8);\r\n*str++ = (unsigned char)(((value >> 18) & 0x3f) | 0x80);\r\n*str++ = (unsigned char)(((value >> 12) & 0x3f) | 0x80);\r\n*str++ = (unsigned char)(((value >> 6) & 0x3f) | 0x80);\r\n*str = (unsigned char)((value & 0x3f) | 0x80);\r\n}\r\nreturn 5;\r\n}\r\nif(len < 6) return -1;\r\nif(str) {\r\n*str++ = (unsigned char)(((value >> 30) & 0x1) | 0xfc);\r\n*str++ = (unsigned char)(((value >> 24) & 0x3f) | 0x80);\r\n*str++ = (unsigned char)(((value >> 18) & 0x3f) | 0x80);\r\n*str++ = (unsigned char)(((value >> 12) & 0x3f) | 0x80);\r\n*str++ = (unsigned char)(((value >> 6) & 0x3f) | 0x80);\r\n*str = (unsigned char)((value & 0x3f) | 0x80);\r\n}\r\nreturn 6;\r\n}

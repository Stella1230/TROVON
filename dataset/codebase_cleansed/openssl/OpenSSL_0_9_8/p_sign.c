void EVP_SignInit(EVP_MD_CTX *ctx, EVP_MD *type)\r\n{\r\nEVP_DigestInit_ex(ctx,type);\r\n}\r\nvoid EVP_SignUpdate(EVP_MD_CTX *ctx, unsigned char *data,\r\nunsigned int count)\r\n{\r\nEVP_DigestUpdate(ctx,data,count);\r\n}\r\nint EVP_SignFinal(EVP_MD_CTX *ctx, unsigned char *sigret, unsigned int *siglen,\r\nEVP_PKEY *pkey)\r\n{\r\nunsigned char m[EVP_MAX_MD_SIZE];\r\nunsigned int m_len;\r\nint i,ok=0,v;\r\nMS_STATIC EVP_MD_CTX tmp_ctx;\r\n*siglen=0;\r\nEVP_MD_CTX_init(&tmp_ctx);\r\nEVP_MD_CTX_copy_ex(&tmp_ctx,ctx);\r\nEVP_DigestFinal_ex(&tmp_ctx,&(m[0]),&m_len);\r\nEVP_MD_CTX_cleanup(&tmp_ctx);\r\nfor (i=0; i<4; i++)\r\n{\r\nv=ctx->digest->required_pkey_type[i];\r\nif (v == 0) break;\r\nif (pkey->type == v)\r\n{\r\nok=1;\r\nbreak;\r\n}\r\n}\r\nif (!ok)\r\n{\r\nEVPerr(EVP_F_EVP_SIGNFINAL,EVP_R_WRONG_PUBLIC_KEY_TYPE);\r\nreturn(0);\r\n}\r\nif (ctx->digest->sign == NULL)\r\n{\r\nEVPerr(EVP_F_EVP_SIGNFINAL,EVP_R_NO_SIGN_FUNCTION_CONFIGURED);\r\nreturn(0);\r\n}\r\nreturn(ctx->digest->sign(ctx->digest->type,m,m_len,sigret,siglen,\r\npkey->pkey.ptr));\r\n}

int MAIN(int argc, char **argv)\r\n{\r\nchar **args, *infile = NULL, *outfile = NULL;\r\nBIO *in = NULL, *out = NULL;\r\nint toseq = 0;\r\nX509 *x509 = NULL;\r\nNETSCAPE_CERT_SEQUENCE *seq = NULL;\r\nint i, ret = 1;\r\nint badarg = 0;\r\nif (bio_err == NULL) bio_err = BIO_new_fp (stderr, BIO_NOCLOSE);\r\nERR_load_crypto_strings();\r\nargs = argv + 1;\r\nwhile (!badarg && *args && *args[0] == '-') {\r\nif (!strcmp (*args, "-toseq")) toseq = 1;\r\nelse if (!strcmp (*args, "-in")) {\r\nif (args[1]) {\r\nargs++;\r\ninfile = *args;\r\n} else badarg = 1;\r\n} else if (!strcmp (*args, "-out")) {\r\nif (args[1]) {\r\nargs++;\r\noutfile = *args;\r\n} else badarg = 1;\r\n} else badarg = 1;\r\nargs++;\r\n}\r\nif (badarg) {\r\nBIO_printf (bio_err, "Netscape certificate sequence utility\n");\r\nBIO_printf (bio_err, "Usage nseq [options]\n");\r\nBIO_printf (bio_err, "where options are\n");\r\nBIO_printf (bio_err, "-in file input file\n");\r\nBIO_printf (bio_err, "-out file output file\n");\r\nBIO_printf (bio_err, "-toseq output NS Sequence file\n");\r\nOPENSSL_EXIT(1);\r\n}\r\nif (infile) {\r\nif (!(in = BIO_new_file (infile, "r"))) {\r\nBIO_printf (bio_err,\r\n"Can't open input file %s\n", infile);\r\ngoto end;\r\n}\r\n} else in = BIO_new_fp(stdin, BIO_NOCLOSE);\r\nif (outfile) {\r\nif (!(out = BIO_new_file (outfile, "w"))) {\r\nBIO_printf (bio_err,\r\n"Can't open output file %s\n", outfile);\r\ngoto end;\r\n}\r\n} else {\r\nout = BIO_new_fp(stdout, BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nif (toseq) {\r\nseq = NETSCAPE_CERT_SEQUENCE_new();\r\nseq->certs = sk_X509_new_null();\r\nwhile((x509 = PEM_read_bio_X509(in, NULL, NULL, NULL)))\r\nsk_X509_push(seq->certs,x509);\r\nif(!sk_X509_num(seq->certs))\r\n{\r\nBIO_printf (bio_err, "Error reading certs file %s\n", infile);\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nPEM_write_bio_NETSCAPE_CERT_SEQUENCE(out, seq);\r\nret = 0;\r\ngoto end;\r\n}\r\nif (!(seq = PEM_read_bio_NETSCAPE_CERT_SEQUENCE(in, NULL, NULL, NULL))) {\r\nBIO_printf (bio_err, "Error reading sequence file %s\n", infile);\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nfor(i = 0; i < sk_X509_num(seq->certs); i++) {\r\nx509 = sk_X509_value(seq->certs, i);\r\ndump_cert_text(out, x509);\r\nPEM_write_bio_X509(out, x509);\r\n}\r\nret = 0;\r\nend:\r\nBIO_free(in);\r\nBIO_free_all(out);\r\nNETSCAPE_CERT_SEQUENCE_free(seq);\r\nOPENSSL_EXIT(ret);\r\n}

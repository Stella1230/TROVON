const ECDH_METHOD *ECDH_OpenSSL(void)\r\n{\r\nreturn &openssl_ecdh_meth;\r\n}\r\nstatic int ecdh_compute_key(void *out, size_t outlen, const EC_POINT *pub_key,\r\nEC_KEY *ecdh,\r\nvoid *(*KDF)(const void *in, size_t inlen, void *out, size_t *outlen))\r\n{\r\nBN_CTX *ctx;\r\nEC_POINT *tmp=NULL;\r\nBIGNUM *x=NULL, *y=NULL;\r\nconst BIGNUM *priv_key;\r\nconst EC_GROUP* group;\r\nint ret= -1;\r\nsize_t buflen, len;\r\nunsigned char *buf=NULL;\r\nif (outlen > INT_MAX)\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ERR_R_MALLOC_FAILURE);\r\nreturn -1;\r\n}\r\nif ((ctx = BN_CTX_new()) == NULL) goto err;\r\nBN_CTX_start(ctx);\r\nx = BN_CTX_get(ctx);\r\ny = BN_CTX_get(ctx);\r\npriv_key = EC_KEY_get0_private_key(ecdh);\r\nif (priv_key == NULL)\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ECDH_R_NO_PRIVATE_VALUE);\r\ngoto err;\r\n}\r\ngroup = EC_KEY_get0_group(ecdh);\r\nif ((tmp=EC_POINT_new(group)) == NULL)\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif (!EC_POINT_mul(group, tmp, NULL, pub_key, priv_key, ctx))\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ECDH_R_POINT_ARITHMETIC_FAILURE);\r\ngoto err;\r\n}\r\nif (EC_METHOD_get_field_type(EC_GROUP_method_of(group)) == NID_X9_62_prime_field)\r\n{\r\nif (!EC_POINT_get_affine_coordinates_GFp(group, tmp, x, y, ctx))\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ECDH_R_POINT_ARITHMETIC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\nelse\r\n{\r\nif (!EC_POINT_get_affine_coordinates_GF2m(group, tmp, x, y, ctx))\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ECDH_R_POINT_ARITHMETIC_FAILURE);\r\ngoto err;\r\n}\r\n}\r\nbuflen = (EC_GROUP_get_degree(group) + 7)/8;\r\nlen = BN_num_bytes(x);\r\nif (len > buflen)\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ERR_R_INTERNAL_ERROR);\r\ngoto err;\r\n}\r\nif ((buf = OPENSSL_malloc(buflen)) == NULL)\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nmemset(buf, 0, buflen - len);\r\nif (len != (size_t)BN_bn2bin(x, buf + buflen - len))\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ERR_R_BN_LIB);\r\ngoto err;\r\n}\r\nif (KDF != 0)\r\n{\r\nif (KDF(buf, buflen, out, &outlen) == NULL)\r\n{\r\nECDHerr(ECDH_F_ECDH_COMPUTE_KEY,ECDH_R_KDF_FAILED);\r\ngoto err;\r\n}\r\nret = outlen;\r\n}\r\nelse\r\n{\r\nif (outlen > buflen)\r\noutlen = buflen;\r\nmemcpy(out, buf, outlen);\r\nret = outlen;\r\n}\r\nerr:\r\nif (tmp) EC_POINT_free(tmp);\r\nif (ctx) BN_CTX_end(ctx);\r\nif (ctx) BN_CTX_free(ctx);\r\nif (buf) OPENSSL_free(buf);\r\nreturn(ret);\r\n}

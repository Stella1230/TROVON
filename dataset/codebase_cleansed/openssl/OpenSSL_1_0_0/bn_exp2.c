int BN_mod_exp2_mont(BIGNUM *rr, const BIGNUM *a1, const BIGNUM *p1,\r\nconst BIGNUM *a2, const BIGNUM *p2, const BIGNUM *m,\r\nBN_CTX *ctx, BN_MONT_CTX *in_mont)\r\n{\r\nint i,j,bits,b,bits1,bits2,ret=0,wpos1,wpos2,window1,window2,wvalue1,wvalue2;\r\nint r_is_one=1;\r\nBIGNUM *d,*r;\r\nconst BIGNUM *a_mod_m;\r\nBIGNUM *val1[TABLE_SIZE], *val2[TABLE_SIZE];\r\nBN_MONT_CTX *mont=NULL;\r\nbn_check_top(a1);\r\nbn_check_top(p1);\r\nbn_check_top(a2);\r\nbn_check_top(p2);\r\nbn_check_top(m);\r\nif (!(m->d[0] & 1))\r\n{\r\nBNerr(BN_F_BN_MOD_EXP2_MONT,BN_R_CALLED_WITH_EVEN_MODULUS);\r\nreturn(0);\r\n}\r\nbits1=BN_num_bits(p1);\r\nbits2=BN_num_bits(p2);\r\nif ((bits1 == 0) && (bits2 == 0))\r\n{\r\nret = BN_one(rr);\r\nreturn ret;\r\n}\r\nbits=(bits1 > bits2)?bits1:bits2;\r\nBN_CTX_start(ctx);\r\nd = BN_CTX_get(ctx);\r\nr = BN_CTX_get(ctx);\r\nval1[0] = BN_CTX_get(ctx);\r\nval2[0] = BN_CTX_get(ctx);\r\nif(!d || !r || !val1[0] || !val2[0]) goto err;\r\nif (in_mont != NULL)\r\nmont=in_mont;\r\nelse\r\n{\r\nif ((mont=BN_MONT_CTX_new()) == NULL) goto err;\r\nif (!BN_MONT_CTX_set(mont,m,ctx)) goto err;\r\n}\r\nwindow1 = BN_window_bits_for_exponent_size(bits1);\r\nwindow2 = BN_window_bits_for_exponent_size(bits2);\r\nif (a1->neg || BN_ucmp(a1,m) >= 0)\r\n{\r\nif (!BN_mod(val1[0],a1,m,ctx))\r\ngoto err;\r\na_mod_m = val1[0];\r\n}\r\nelse\r\na_mod_m = a1;\r\nif (BN_is_zero(a_mod_m))\r\n{\r\nBN_zero(rr);\r\nret = 1;\r\ngoto err;\r\n}\r\nif (!BN_to_montgomery(val1[0],a_mod_m,mont,ctx)) goto err;\r\nif (window1 > 1)\r\n{\r\nif (!BN_mod_mul_montgomery(d,val1[0],val1[0],mont,ctx)) goto err;\r\nj=1<<(window1-1);\r\nfor (i=1; i<j; i++)\r\n{\r\nif(((val1[i] = BN_CTX_get(ctx)) == NULL) ||\r\n!BN_mod_mul_montgomery(val1[i],val1[i-1],\r\nd,mont,ctx))\r\ngoto err;\r\n}\r\n}\r\nif (a2->neg || BN_ucmp(a2,m) >= 0)\r\n{\r\nif (!BN_mod(val2[0],a2,m,ctx))\r\ngoto err;\r\na_mod_m = val2[0];\r\n}\r\nelse\r\na_mod_m = a2;\r\nif (BN_is_zero(a_mod_m))\r\n{\r\nBN_zero(rr);\r\nret = 1;\r\ngoto err;\r\n}\r\nif (!BN_to_montgomery(val2[0],a_mod_m,mont,ctx)) goto err;\r\nif (window2 > 1)\r\n{\r\nif (!BN_mod_mul_montgomery(d,val2[0],val2[0],mont,ctx)) goto err;\r\nj=1<<(window2-1);\r\nfor (i=1; i<j; i++)\r\n{\r\nif(((val2[i] = BN_CTX_get(ctx)) == NULL) ||\r\n!BN_mod_mul_montgomery(val2[i],val2[i-1],\r\nd,mont,ctx))\r\ngoto err;\r\n}\r\n}\r\nr_is_one=1;\r\nwvalue1=0;\r\nwvalue2=0;\r\nwpos1=0;\r\nwpos2=0;\r\nif (!BN_to_montgomery(r,BN_value_one(),mont,ctx)) goto err;\r\nfor (b=bits-1; b>=0; b--)\r\n{\r\nif (!r_is_one)\r\n{\r\nif (!BN_mod_mul_montgomery(r,r,r,mont,ctx))\r\ngoto err;\r\n}\r\nif (!wvalue1)\r\nif (BN_is_bit_set(p1, b))\r\n{\r\ni = b-window1+1;\r\nwhile (!BN_is_bit_set(p1, i))\r\ni++;\r\nwpos1 = i;\r\nwvalue1 = 1;\r\nfor (i = b-1; i >= wpos1; i--)\r\n{\r\nwvalue1 <<= 1;\r\nif (BN_is_bit_set(p1, i))\r\nwvalue1++;\r\n}\r\n}\r\nif (!wvalue2)\r\nif (BN_is_bit_set(p2, b))\r\n{\r\ni = b-window2+1;\r\nwhile (!BN_is_bit_set(p2, i))\r\ni++;\r\nwpos2 = i;\r\nwvalue2 = 1;\r\nfor (i = b-1; i >= wpos2; i--)\r\n{\r\nwvalue2 <<= 1;\r\nif (BN_is_bit_set(p2, i))\r\nwvalue2++;\r\n}\r\n}\r\nif (wvalue1 && b == wpos1)\r\n{\r\nif (!BN_mod_mul_montgomery(r,r,val1[wvalue1>>1],mont,ctx))\r\ngoto err;\r\nwvalue1 = 0;\r\nr_is_one = 0;\r\n}\r\nif (wvalue2 && b == wpos2)\r\n{\r\nif (!BN_mod_mul_montgomery(r,r,val2[wvalue2>>1],mont,ctx))\r\ngoto err;\r\nwvalue2 = 0;\r\nr_is_one = 0;\r\n}\r\n}\r\nBN_from_montgomery(rr,r,mont,ctx);\r\nret=1;\r\nerr:\r\nif ((in_mont == NULL) && (mont != NULL)) BN_MONT_CTX_free(mont);\r\nBN_CTX_end(ctx);\r\nbn_check_top(rr);\r\nreturn(ret);\r\n}

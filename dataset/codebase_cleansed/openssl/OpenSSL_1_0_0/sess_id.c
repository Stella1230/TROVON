int MAIN(int argc, char **argv)\r\n{\r\nSSL_SESSION *x=NULL;\r\nint ret=1,i,num,badops=0;\r\nBIO *out=NULL;\r\nint informat,outformat;\r\nchar *infile=NULL,*outfile=NULL,*context=NULL;\r\nint cert=0,noout=0,text=0;\r\nconst char **pp;\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE|BIO_FP_TEXT);\r\ninformat=FORMAT_PEM;\r\noutformat=FORMAT_PEM;\r\nargc--;\r\nargv++;\r\nnum=0;\r\nwhile (argc >= 1)\r\n{\r\nif (strcmp(*argv,"-inform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-outform") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutformat=str2fmt(*(++argv));\r\n}\r\nelse if (strcmp(*argv,"-in") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\ninfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-out") == 0)\r\n{\r\nif (--argc < 1) goto bad;\r\noutfile= *(++argv);\r\n}\r\nelse if (strcmp(*argv,"-text") == 0)\r\ntext= ++num;\r\nelse if (strcmp(*argv,"-cert") == 0)\r\ncert= ++num;\r\nelse if (strcmp(*argv,"-noout") == 0)\r\nnoout= ++num;\r\nelse if (strcmp(*argv,"-context") == 0)\r\n{\r\nif(--argc < 1) goto bad;\r\ncontext=*++argv;\r\n}\r\nelse\r\n{\r\nBIO_printf(bio_err,"unknown option %s\n",*argv);\r\nbadops=1;\r\nbreak;\r\n}\r\nargc--;\r\nargv++;\r\n}\r\nif (badops)\r\n{\r\nbad:\r\nfor (pp=sess_id_usage; (*pp != NULL); pp++)\r\nBIO_printf(bio_err,"%s",*pp);\r\ngoto end;\r\n}\r\nERR_load_crypto_strings();\r\nx=load_sess_id(infile,informat);\r\nif (x == NULL) { goto end; }\r\nif(context)\r\n{\r\nx->sid_ctx_length=strlen(context);\r\nif(x->sid_ctx_length > SSL_MAX_SID_CTX_LENGTH)\r\n{\r\nBIO_printf(bio_err,"Context too long\n");\r\ngoto end;\r\n}\r\nmemcpy(x->sid_ctx,context,x->sid_ctx_length);\r\n}\r\n#ifdef undef\r\n{\r\nSSL_SESSION *s;\r\nchar buf[1024*10],*p;\r\nint i;\r\ns=SSL_SESSION_new();\r\np= &buf;\r\ni=i2d_SSL_SESSION(x,&p);\r\np= &buf;\r\nd2i_SSL_SESSION(&s,&p,(long)i);\r\np= &buf;\r\nd2i_SSL_SESSION(&s,&p,(long)i);\r\np= &buf;\r\nd2i_SSL_SESSION(&s,&p,(long)i);\r\nSSL_SESSION_free(s);\r\n}\r\n#endif\r\nif (!noout || text)\r\n{\r\nout=BIO_new(BIO_s_file());\r\nif (out == NULL)\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (outfile == NULL)\r\n{\r\nBIO_set_fp(out,stdout,BIO_NOCLOSE);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\n}\r\nelse\r\n{\r\nif (BIO_write_filename(out,outfile) <= 0)\r\n{\r\nperror(outfile);\r\ngoto end;\r\n}\r\n}\r\n}\r\nif (text)\r\n{\r\nSSL_SESSION_print(out,x);\r\nif (cert)\r\n{\r\nif (x->peer == NULL)\r\nBIO_puts(out,"No certificate present\n");\r\nelse\r\nX509_print(out,x->peer);\r\n}\r\n}\r\nif (!noout && !cert)\r\n{\r\nif (outformat == FORMAT_ASN1)\r\ni=i2d_SSL_SESSION_bio(out,x);\r\nelse if (outformat == FORMAT_PEM)\r\ni=PEM_write_bio_SSL_SESSION(out,x);\r\nelse {\r\nBIO_printf(bio_err,"bad output format specified for outfile\n");\r\ngoto end;\r\n}\r\nif (!i) {\r\nBIO_printf(bio_err,"unable to write SSL_SESSION\n");\r\ngoto end;\r\n}\r\n}\r\nelse if (!noout && (x->peer != NULL))\r\n{\r\nif (outformat == FORMAT_ASN1)\r\ni=(int)i2d_X509_bio(out,x->peer);\r\nelse if (outformat == FORMAT_PEM)\r\ni=PEM_write_bio_X509(out,x->peer);\r\nelse {\r\nBIO_printf(bio_err,"bad output format specified for outfile\n");\r\ngoto end;\r\n}\r\nif (!i) {\r\nBIO_printf(bio_err,"unable to write X509\n");\r\ngoto end;\r\n}\r\n}\r\nret=0;\r\nend:\r\nif (out != NULL) BIO_free_all(out);\r\nif (x != NULL) SSL_SESSION_free(x);\r\napps_shutdown();\r\nOPENSSL_EXIT(ret);\r\n}\r\nstatic SSL_SESSION *load_sess_id(char *infile, int format)\r\n{\r\nSSL_SESSION *x=NULL;\r\nBIO *in=NULL;\r\nin=BIO_new(BIO_s_file());\r\nif (in == NULL)\r\n{\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nif (infile == NULL)\r\nBIO_set_fp(in,stdin,BIO_NOCLOSE);\r\nelse\r\n{\r\nif (BIO_read_filename(in,infile) <= 0)\r\n{\r\nperror(infile);\r\ngoto end;\r\n}\r\n}\r\nif (format == FORMAT_ASN1)\r\nx=d2i_SSL_SESSION_bio(in,NULL);\r\nelse if (format == FORMAT_PEM)\r\nx=PEM_read_bio_SSL_SESSION(in,NULL,NULL,NULL);\r\nelse {\r\nBIO_printf(bio_err,"bad input format specified for input crl\n");\r\ngoto end;\r\n}\r\nif (x == NULL)\r\n{\r\nBIO_printf(bio_err,"unable to load SSL_SESSION\n");\r\nERR_print_errors(bio_err);\r\ngoto end;\r\n}\r\nend:\r\nif (in != NULL) BIO_free(in);\r\nreturn(x);\r\n}

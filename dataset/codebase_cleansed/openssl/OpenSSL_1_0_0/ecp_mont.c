const EC_METHOD *EC_GFp_mont_method(void)\r\n{\r\nstatic const EC_METHOD ret = {\r\nNID_X9_62_prime_field,\r\nec_GFp_mont_group_init,\r\nec_GFp_mont_group_finish,\r\nec_GFp_mont_group_clear_finish,\r\nec_GFp_mont_group_copy,\r\nec_GFp_mont_group_set_curve,\r\nec_GFp_simple_group_get_curve,\r\nec_GFp_simple_group_get_degree,\r\nec_GFp_simple_group_check_discriminant,\r\nec_GFp_simple_point_init,\r\nec_GFp_simple_point_finish,\r\nec_GFp_simple_point_clear_finish,\r\nec_GFp_simple_point_copy,\r\nec_GFp_simple_point_set_to_infinity,\r\nec_GFp_simple_set_Jprojective_coordinates_GFp,\r\nec_GFp_simple_get_Jprojective_coordinates_GFp,\r\nec_GFp_simple_point_set_affine_coordinates,\r\nec_GFp_simple_point_get_affine_coordinates,\r\nec_GFp_simple_set_compressed_coordinates,\r\nec_GFp_simple_point2oct,\r\nec_GFp_simple_oct2point,\r\nec_GFp_simple_add,\r\nec_GFp_simple_dbl,\r\nec_GFp_simple_invert,\r\nec_GFp_simple_is_at_infinity,\r\nec_GFp_simple_is_on_curve,\r\nec_GFp_simple_cmp,\r\nec_GFp_simple_make_affine,\r\nec_GFp_simple_points_make_affine,\r\n0 ,\r\n0 ,\r\n0 ,\r\nec_GFp_mont_field_mul,\r\nec_GFp_mont_field_sqr,\r\n0 ,\r\nec_GFp_mont_field_encode,\r\nec_GFp_mont_field_decode,\r\nec_GFp_mont_field_set_to_one };\r\nreturn &ret;\r\n}\r\nint ec_GFp_mont_group_init(EC_GROUP *group)\r\n{\r\nint ok;\r\nok = ec_GFp_simple_group_init(group);\r\ngroup->field_data1 = NULL;\r\ngroup->field_data2 = NULL;\r\nreturn ok;\r\n}\r\nvoid ec_GFp_mont_group_finish(EC_GROUP *group)\r\n{\r\nif (group->field_data1 != NULL)\r\n{\r\nBN_MONT_CTX_free(group->field_data1);\r\ngroup->field_data1 = NULL;\r\n}\r\nif (group->field_data2 != NULL)\r\n{\r\nBN_free(group->field_data2);\r\ngroup->field_data2 = NULL;\r\n}\r\nec_GFp_simple_group_finish(group);\r\n}\r\nvoid ec_GFp_mont_group_clear_finish(EC_GROUP *group)\r\n{\r\nif (group->field_data1 != NULL)\r\n{\r\nBN_MONT_CTX_free(group->field_data1);\r\ngroup->field_data1 = NULL;\r\n}\r\nif (group->field_data2 != NULL)\r\n{\r\nBN_clear_free(group->field_data2);\r\ngroup->field_data2 = NULL;\r\n}\r\nec_GFp_simple_group_clear_finish(group);\r\n}\r\nint ec_GFp_mont_group_copy(EC_GROUP *dest, const EC_GROUP *src)\r\n{\r\nif (dest->field_data1 != NULL)\r\n{\r\nBN_MONT_CTX_free(dest->field_data1);\r\ndest->field_data1 = NULL;\r\n}\r\nif (dest->field_data2 != NULL)\r\n{\r\nBN_clear_free(dest->field_data2);\r\ndest->field_data2 = NULL;\r\n}\r\nif (!ec_GFp_simple_group_copy(dest, src)) return 0;\r\nif (src->field_data1 != NULL)\r\n{\r\ndest->field_data1 = BN_MONT_CTX_new();\r\nif (dest->field_data1 == NULL) return 0;\r\nif (!BN_MONT_CTX_copy(dest->field_data1, src->field_data1)) goto err;\r\n}\r\nif (src->field_data2 != NULL)\r\n{\r\ndest->field_data2 = BN_dup(src->field_data2);\r\nif (dest->field_data2 == NULL) goto err;\r\n}\r\nreturn 1;\r\nerr:\r\nif (dest->field_data1 != NULL)\r\n{\r\nBN_MONT_CTX_free(dest->field_data1);\r\ndest->field_data1 = NULL;\r\n}\r\nreturn 0;\r\n}\r\nint ec_GFp_mont_group_set_curve(EC_GROUP *group, const BIGNUM *p, const BIGNUM *a, const BIGNUM *b, BN_CTX *ctx)\r\n{\r\nBN_CTX *new_ctx = NULL;\r\nBN_MONT_CTX *mont = NULL;\r\nBIGNUM *one = NULL;\r\nint ret = 0;\r\nif (group->field_data1 != NULL)\r\n{\r\nBN_MONT_CTX_free(group->field_data1);\r\ngroup->field_data1 = NULL;\r\n}\r\nif (group->field_data2 != NULL)\r\n{\r\nBN_free(group->field_data2);\r\ngroup->field_data2 = NULL;\r\n}\r\nif (ctx == NULL)\r\n{\r\nctx = new_ctx = BN_CTX_new();\r\nif (ctx == NULL)\r\nreturn 0;\r\n}\r\nmont = BN_MONT_CTX_new();\r\nif (mont == NULL) goto err;\r\nif (!BN_MONT_CTX_set(mont, p, ctx))\r\n{\r\nECerr(EC_F_EC_GFP_MONT_GROUP_SET_CURVE, ERR_R_BN_LIB);\r\ngoto err;\r\n}\r\none = BN_new();\r\nif (one == NULL) goto err;\r\nif (!BN_to_montgomery(one, BN_value_one(), mont, ctx)) goto err;\r\ngroup->field_data1 = mont;\r\nmont = NULL;\r\ngroup->field_data2 = one;\r\none = NULL;\r\nret = ec_GFp_simple_group_set_curve(group, p, a, b, ctx);\r\nif (!ret)\r\n{\r\nBN_MONT_CTX_free(group->field_data1);\r\ngroup->field_data1 = NULL;\r\nBN_free(group->field_data2);\r\ngroup->field_data2 = NULL;\r\n}\r\nerr:\r\nif (new_ctx != NULL)\r\nBN_CTX_free(new_ctx);\r\nif (mont != NULL)\r\nBN_MONT_CTX_free(mont);\r\nreturn ret;\r\n}\r\nint ec_GFp_mont_field_mul(const EC_GROUP *group, BIGNUM *r, const BIGNUM *a, const BIGNUM *b, BN_CTX *ctx)\r\n{\r\nif (group->field_data1 == NULL)\r\n{\r\nECerr(EC_F_EC_GFP_MONT_FIELD_MUL, EC_R_NOT_INITIALIZED);\r\nreturn 0;\r\n}\r\nreturn BN_mod_mul_montgomery(r, a, b, group->field_data1, ctx);\r\n}\r\nint ec_GFp_mont_field_sqr(const EC_GROUP *group, BIGNUM *r, const BIGNUM *a, BN_CTX *ctx)\r\n{\r\nif (group->field_data1 == NULL)\r\n{\r\nECerr(EC_F_EC_GFP_MONT_FIELD_SQR, EC_R_NOT_INITIALIZED);\r\nreturn 0;\r\n}\r\nreturn BN_mod_mul_montgomery(r, a, a, group->field_data1, ctx);\r\n}\r\nint ec_GFp_mont_field_encode(const EC_GROUP *group, BIGNUM *r, const BIGNUM *a, BN_CTX *ctx)\r\n{\r\nif (group->field_data1 == NULL)\r\n{\r\nECerr(EC_F_EC_GFP_MONT_FIELD_ENCODE, EC_R_NOT_INITIALIZED);\r\nreturn 0;\r\n}\r\nreturn BN_to_montgomery(r, a, (BN_MONT_CTX *)group->field_data1, ctx);\r\n}\r\nint ec_GFp_mont_field_decode(const EC_GROUP *group, BIGNUM *r, const BIGNUM *a, BN_CTX *ctx)\r\n{\r\nif (group->field_data1 == NULL)\r\n{\r\nECerr(EC_F_EC_GFP_MONT_FIELD_DECODE, EC_R_NOT_INITIALIZED);\r\nreturn 0;\r\n}\r\nreturn BN_from_montgomery(r, a, group->field_data1, ctx);\r\n}\r\nint ec_GFp_mont_field_set_to_one(const EC_GROUP *group, BIGNUM *r, BN_CTX *ctx)\r\n{\r\nif (group->field_data2 == NULL)\r\n{\r\nECerr(EC_F_EC_GFP_MONT_FIELD_SET_TO_ONE, EC_R_NOT_INITIALIZED);\r\nreturn 0;\r\n}\r\nif (!BN_copy(r, group->field_data2)) return 0;\r\nreturn 1;\r\n}

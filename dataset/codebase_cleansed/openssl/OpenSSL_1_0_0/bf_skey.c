void BF_set_key(BF_KEY *key, int len, const unsigned char *data)\r\n{\r\nint i;\r\nBF_LONG *p,ri,in[2];\r\nconst unsigned char *d,*end;\r\nmemcpy(key,&bf_init,sizeof(BF_KEY));\r\np=key->P;\r\nif (len > ((BF_ROUNDS+2)*4)) len=(BF_ROUNDS+2)*4;\r\nd=data;\r\nend= &(data[len]);\r\nfor (i=0; i<(BF_ROUNDS+2); i++)\r\n{\r\nri= *(d++);\r\nif (d >= end) d=data;\r\nri<<=8;\r\nri|= *(d++);\r\nif (d >= end) d=data;\r\nri<<=8;\r\nri|= *(d++);\r\nif (d >= end) d=data;\r\nri<<=8;\r\nri|= *(d++);\r\nif (d >= end) d=data;\r\np[i]^=ri;\r\n}\r\nin[0]=0L;\r\nin[1]=0L;\r\nfor (i=0; i<(BF_ROUNDS+2); i+=2)\r\n{\r\nBF_encrypt(in,key);\r\np[i ]=in[0];\r\np[i+1]=in[1];\r\n}\r\np=key->S;\r\nfor (i=0; i<4*256; i+=2)\r\n{\r\nBF_encrypt(in,key);\r\np[i ]=in[0];\r\np[i+1]=in[1];\r\n}\r\n}

int main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nPROXY *pxy;\r\nchar *host;\r\nchar buf[1024*10],*p;\r\nBIO *bio;\r\nint i,len,off,ret=1;\r\nif (argc <= 1)\r\nhost="localhost:4433";\r\nelse\r\nhost=argv[1];\r\nERR_load_crypto_strings();\r\npxy=PROXY_new();\r\nPROXY_add_server(pxy,PROXY_PROTOCOL_SOCKS,"gromit:1080");\r\nbio=BIO_new(BIO_s_socks4a_connect());\r\nBIO_set_conn_hostname(bio,host);\r\nBIO_set_proxies(bio,pxy);\r\nBIO_set_socks_userid(bio,"eay");\r\nBIO_set_nbio(bio,1);\r\np="GET / HTTP/1.0\r\n\r\n";\r\nlen=strlen(p);\r\noff=0;\r\nfor (;;)\r\n{\r\ni=BIO_write(bio,&(p[off]),len);\r\nif (i <= 0)\r\n{\r\nif (BIO_should_retry(bio))\r\n{\r\nfprintf(stderr,"write DELAY\n");\r\nsleep(1);\r\ncontinue;\r\n}\r\nelse\r\n{\r\ngoto err;\r\n}\r\n}\r\noff+=i;\r\nlen-=i;\r\nif (len <= 0) break;\r\n}\r\nfor (;;)\r\n{\r\ni=BIO_read(bio,buf,sizeof(buf));\r\nif (i == 0) break;\r\nif (i < 0)\r\n{\r\nif (BIO_should_retry(bio))\r\n{\r\nfprintf(stderr,"read DELAY\n");\r\nsleep(1);\r\ncontinue;\r\n}\r\ngoto err;\r\n}\r\nfwrite(buf,1,i,stdout);\r\n}\r\nret=1;\r\nif (0)\r\n{\r\nerr:\r\nif (ERR_peek_error() == 0)\r\n{\r\nfprintf(stderr,"errno=%d ",errno);\r\nperror("error");\r\n}\r\nelse\r\nERR_print_errors_fp(stderr);\r\n}\r\nBIO_free_all(bio);\r\nif (pxy != NULL) PROXY_free(pxy);\r\nexit(!ret);\r\nreturn(ret);\r\n}

static int bind_helper(ENGINE *e)\r\n{\r\nif(!ENGINE_set_id(e, engine_cluster_labs_id) ||\r\n!ENGINE_set_name(e, engine_cluster_labs_name) ||\r\n#ifndef OPENSSL_NO_RSA\r\n!ENGINE_set_RSA(e, &cluster_labs_rsa) ||\r\n#endif\r\n#ifndef OPENSSL_NO_DSA\r\n!ENGINE_set_DSA(e, &cluster_labs_dsa) ||\r\n#endif\r\n#ifndef OPENSSL_NO_DH\r\n!ENGINE_set_DH(e, &cluster_labs_dh) ||\r\n#endif\r\n!ENGINE_set_RAND(e, &cluster_labs_rand) ||\r\n!ENGINE_set_destroy_function(e, cluster_labs_destroy) ||\r\n!ENGINE_set_init_function(e, cluster_labs_init) ||\r\n!ENGINE_set_finish_function(e, cluster_labs_finish) ||\r\n!ENGINE_set_ctrl_function(e, cluster_labs_ctrl) ||\r\n!ENGINE_set_cmd_defns(e, cluster_labs_cmd_defns))\r\nreturn 0;\r\nERR_load_CL_strings();\r\nreturn 1;\r\n}\r\nstatic ENGINE *engine_cluster_labs(void)\r\n{\r\nENGINE *ret = ENGINE_new();\r\nif(!ret)\r\nreturn NULL;\r\nif(!bind_helper(ret))\r\n{\r\nENGINE_free(ret);\r\nreturn NULL;\r\n}\r\nreturn ret;\r\n}\r\nstatic\r\n#endif\r\nvoid ENGINE_load_cluster_labs(void)\r\n{\r\nENGINE *cluster_labs = engine_cluster_labs();\r\nif(!cluster_labs) return;\r\nENGINE_add(cluster_labs);\r\nENGINE_free(cluster_labs);\r\nERR_clear_error();\r\n}\r\nstatic int cluster_labs_destroy(ENGINE *e)\r\n{\r\nERR_unload_CL_strings();\r\nreturn 1;\r\n}\r\nint cluster_labs_init(ENGINE *e)\r\n{\r\ncl_engine_init *p1;\r\ncl_mod_exp *p2;\r\ncl_mod_exp_crt *p3;\r\ncl_rsa_mod_exp *p4;\r\ncl_rsa_priv_enc *p5;\r\ncl_rsa_priv_dec *p6;\r\ncl_rsa_pub_enc *p7;\r\ncl_rsa_pub_dec *p8;\r\ncl_rand_bytes *p20;\r\ncl_dsa_sign *p30;\r\ncl_dsa_verify *p31;\r\nif(cluster_labs_dso != NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_INIT,CL_R_ALREADY_LOADED);\r\ngoto err;\r\n}\r\ncluster_labs_dso = DSO_load(NULL, CLUSTER_LABS_LIB_NAME, NULL,0);\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_INIT,CL_R_DSO_FAILURE);\r\ngoto err;\r\n}\r\nif( !(p1 = (cl_engine_init *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F1)) ||\r\n!(p2 = (cl_mod_exp *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F2)) ||\r\n!(p3 = (cl_mod_exp_crt *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F3)) ||\r\n!(p4 = (cl_rsa_mod_exp *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F4)) ||\r\n!(p5 = (cl_rsa_priv_enc *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F5)) ||\r\n!(p6 = (cl_rsa_priv_dec *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F6)) ||\r\n!(p7 = (cl_rsa_pub_enc *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F7)) ||\r\n!(p8 = (cl_rsa_pub_dec *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F8)) ||\r\n!(p20= (cl_rand_bytes *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F20)) ||\r\n!(p30= (cl_dsa_sign *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F30)) ||\r\n!(p31= (cl_dsa_verify *)DSO_bind_func(\r\ncluster_labs_dso, CLUSTER_LABS_F31)))\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_INIT,CL_R_DSO_FAILURE);\r\ngoto err;\r\n}\r\np_cl_engine_init = p1;\r\np_cl_mod_exp = p2;\r\np_cl_mod_exp_crt = p3;\r\np_cl_rsa_mod_exp = p4;\r\np_cl_rsa_priv_enc = p5;\r\np_cl_rsa_priv_dec = p6;\r\np_cl_rsa_pub_enc = p7;\r\np_cl_rsa_pub_dec = p8;\r\np_cl_rand_bytes = p20;\r\np_cl_dsa_sign = p30;\r\np_cl_dsa_verify = p31;\r\nif(p_cl_engine_init()== 0){\r\nCLerr(CL_F_CLUSTER_LABS_INIT,CL_R_INIT_FAILED);\r\ngoto err;\r\n}\r\nreturn(1);\r\nerr:\r\nif(cluster_labs_dso)\r\nDSO_free(cluster_labs_dso);\r\ncluster_labs_dso = NULL;\r\np_cl_engine_init = NULL;\r\np_cl_mod_exp = NULL;\r\np_cl_mod_exp_crt = NULL;\r\np_cl_rsa_mod_exp = NULL;\r\np_cl_rsa_priv_enc = NULL;\r\np_cl_rsa_priv_dec = NULL;\r\np_cl_rsa_pub_enc = NULL;\r\np_cl_rsa_pub_dec = NULL;\r\np_cl_rand_bytes = NULL;\r\np_cl_dsa_sign = NULL;\r\np_cl_dsa_verify = NULL;\r\nreturn(0);\r\n}\r\nstatic int cluster_labs_finish(ENGINE *e)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_FINISH,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(!DSO_free(cluster_labs_dso))\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_FINISH,CL_R_DSO_FAILURE);\r\nreturn 0;\r\n}\r\ncluster_labs_dso = NULL;\r\np_cl_engine_init = NULL;\r\np_cl_mod_exp = NULL;\r\np_cl_rsa_mod_exp = NULL;\r\np_cl_mod_exp_crt = NULL;\r\np_cl_rsa_priv_enc = NULL;\r\np_cl_rsa_priv_dec = NULL;\r\np_cl_rsa_pub_enc = NULL;\r\np_cl_rsa_pub_dec = NULL;\r\np_cl_rand_bytes = NULL;\r\np_cl_dsa_sign = NULL;\r\np_cl_dsa_verify = NULL;\r\nreturn(1);\r\n}\r\nstatic int cluster_labs_ctrl(ENGINE *e, int cmd, long i, void *p, void (*f)())\r\n{\r\nint initialised = ((cluster_labs_dso == NULL) ? 0 : 1);\r\nswitch(cmd)\r\n{\r\ncase CLUSTER_LABS_CMD_SO_PATH:\r\nif(p == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_CTRL,ERR_R_PASSED_NULL_PARAMETER);\r\nreturn 0;\r\n}\r\nif(initialised)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_CTRL,CL_R_ALREADY_LOADED);\r\nreturn 0;\r\n}\r\nCLUSTER_LABS_LIB_NAME = (const char *)p;\r\nreturn 1;\r\ndefault:\r\nbreak;\r\n}\r\nCLerr(CL_F_CLUSTER_LABS_CTRL,CL_R_COMMAND_NOT_IMPLEMENTED);\r\nreturn 0;\r\n}\r\nstatic int cluster_labs_mod_exp(BIGNUM *r, const BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_MOD_EXP,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_mod_exp == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_MOD_EXP,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int cluster_labs_mod_exp_crt(BIGNUM *r, BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *q, const BIGNUM *dmp1, const BIGNUM *dmq1,\r\nconst BIGNUM *iqmp, BN_CTX *ctx)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_MOD_EXP_CRT,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_mod_exp_crt == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_MOD_EXP_CRT,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_mod_exp_crt(r, a, p, q,dmp1, dmq1, iqmp, ctx);\r\n}\r\nstatic int cluster_labs_rsa_mod_exp(BIGNUM *r0, const BIGNUM *I, RSA *rsa)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_MOD_EXP,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_rsa_mod_exp == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_MOD_EXP,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_rsa_mod_exp(r0, I, rsa);\r\n}\r\nstatic DSA_SIG *cluster_labs_dsa_sign(const unsigned char *dgst, int dlen, DSA *dsa)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_DSA_SIGN,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_dsa_sign == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_DSA_SIGN,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_dsa_sign(dgst, dlen, dsa);\r\n}\r\nstatic int cluster_labs_dsa_verify(const unsigned char *dgst, int dgst_len,\r\nDSA_SIG *sig, DSA *dsa)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_DSA_VERIFY,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_dsa_verify == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_DSA_VERIFY,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_dsa_verify(dgst, dgst_len, sig, dsa);\r\n}\r\nstatic int cluster_labs_dsa_mod_exp(DSA *dsa, BIGNUM *rr, BIGNUM *a1,\r\nBIGNUM *p1, BIGNUM *a2, BIGNUM *p2, BIGNUM *m,\r\nBN_CTX *ctx, BN_MONT_CTX *in_mont)\r\n{\r\nBIGNUM t;\r\nint status = 0;\r\nBN_init(&t);\r\nif (!cluster_labs_mod_exp(rr,a1,p1,m,ctx)) goto end;\r\nif (!cluster_labs_mod_exp(&t,a2,p2,m,ctx)) goto end;\r\nif (!BN_mod_mul(rr,rr,&t,m,ctx)) goto end;\r\nstatus = 1;\r\nend:\r\nBN_free(&t);\r\nreturn(1);\r\n}\r\nstatic int cluster_labs_mod_exp_dsa(DSA *dsa, BIGNUM *r, BIGNUM *a,\r\nconst BIGNUM *p, const BIGNUM *m, BN_CTX *ctx,\r\nBN_MONT_CTX *m_ctx)\r\n{\r\nreturn cluster_labs_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int cluster_labs_mod_exp_mont(BIGNUM *r, const BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nreturn cluster_labs_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int cluster_labs_mod_exp_dh(const DH *dh, BIGNUM *r, const BIGNUM *a, const BIGNUM *p,\r\nconst BIGNUM *m, BN_CTX *ctx, BN_MONT_CTX *m_ctx)\r\n{\r\nreturn cluster_labs_mod_exp(r, a, p, m, ctx);\r\n}\r\nstatic int cluster_labs_rsa_pub_enc(int flen, const unsigned char *from,\r\nunsigned char *to, RSA *rsa, int padding)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PUB_ENC,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_rsa_priv_enc == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PUB_ENC,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_rsa_pub_enc(flen, from, to, rsa, padding);\r\n}\r\nstatic int cluster_labs_rsa_pub_dec(int flen, const unsigned char *from,\r\nunsigned char *to, RSA *rsa, int padding)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PUB_DEC,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_rsa_priv_enc == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PUB_DEC,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_rsa_pub_dec(flen, from, to, rsa, padding);\r\n}\r\nstatic int cluster_labs_rsa_priv_enc(int flen, const unsigned char *from,\r\nunsigned char *to, RSA *rsa, int padding)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PRIV_ENC,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_rsa_priv_enc == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PRIV_ENC,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_rsa_priv_enc(flen, from, to, rsa, padding);\r\n}\r\nstatic int cluster_labs_rsa_priv_dec(int flen, const unsigned char *from,\r\nunsigned char *to, RSA *rsa, int padding)\r\n{\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PRIV_DEC,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_rsa_priv_dec == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RSA_PRIV_DEC,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_rsa_priv_dec(flen, from, to, rsa, padding);\r\n}\r\nstatic int cluster_labs_rand_bytes(unsigned char *buf, int num){\r\nif(cluster_labs_dso == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RAND_BYTES,CL_R_NOT_LOADED);\r\nreturn 0;\r\n}\r\nif(p_cl_mod_exp_crt == NULL)\r\n{\r\nCLerr(CL_F_CLUSTER_LABS_RAND_BYTES,CL_R_FUNCTION_NOT_BINDED);\r\nreturn 0;\r\n}\r\nreturn p_cl_rand_bytes(buf, num);\r\n}\r\nstatic int bind_fn(ENGINE *e, const char *id)\r\n{\r\nfprintf(stderr, "bind_fn CLUSTER_LABS\n");\r\nif(id && (strcmp(id, engine_cluster_labs_id) != 0)) {\r\nfprintf(stderr, "bind_fn return(0) first\n");\r\nreturn 0;\r\n}\r\nif(!bind_helper(e)) {\r\nfprintf(stderr, "bind_fn return(1) first\n");\r\nreturn 0;\r\n}\r\nfprintf(stderr, "bind_fn return(1)\n");\r\nreturn 1;\r\n}

void state_machine_init(state_machine_t *machine)\r\n{\r\nmachine->ssl = NULL;\r\nmachine->bio_intossl = machine->bio_fromssl = NULL;\r\nbuffer_init(&machine->clean_in);\r\nbuffer_init(&machine->clean_out);\r\nbuffer_init(&machine->dirty_in);\r\nbuffer_init(&machine->dirty_out);\r\n}\r\nvoid state_machine_close(state_machine_t *machine)\r\n{\r\nif(machine->ssl)\r\nSSL_free(machine->ssl);\r\n#if 0\r\nif(machine->bio_intossl)\r\nBIO_free(machine->bio_intossl);\r\nif(machine->bio_fromssl)\r\nBIO_free(machine->bio_fromssl);\r\n#endif\r\nbuffer_close(&machine->clean_in);\r\nbuffer_close(&machine->clean_out);\r\nbuffer_close(&machine->dirty_in);\r\nbuffer_close(&machine->dirty_out);\r\nstate_machine_init(machine);\r\n}\r\nbuffer_t *state_machine_get_buffer(state_machine_t *machine, sm_buffer_t type)\r\n{\r\nswitch(type) {\r\ncase SM_CLEAN_IN:\r\nreturn &machine->clean_in;\r\ncase SM_CLEAN_OUT:\r\nreturn &machine->clean_out;\r\ncase SM_DIRTY_IN:\r\nreturn &machine->dirty_in;\r\ncase SM_DIRTY_OUT:\r\nreturn &machine->dirty_out;\r\ndefault:\r\nbreak;\r\n}\r\nabort();\r\nreturn NULL;\r\n}\r\nSSL *state_machine_get_SSL(state_machine_t *machine)\r\n{\r\nreturn machine->ssl;\r\n}\r\nint state_machine_set_SSL(state_machine_t *machine, SSL *ssl, int is_server)\r\n{\r\nif(machine->ssl)\r\nabort();\r\nmachine->ssl = ssl;\r\nif((machine->bio_intossl = BIO_new(BIO_s_mem())) == NULL)\r\nabort();\r\nif((machine->bio_fromssl = BIO_new(BIO_s_mem())) == NULL)\r\nabort();\r\nSSL_set_bio(machine->ssl, machine->bio_intossl, machine->bio_fromssl);\r\nif(is_server)\r\nSSL_set_accept_state(machine->ssl);\r\nelse\r\nSSL_set_connect_state(machine->ssl);\r\nreturn state_machine_churn(machine);\r\n}\r\nint state_machine_churn(state_machine_t *machine)\r\n{\r\nunsigned int loop;\r\nif(machine->ssl == NULL) {\r\nif(buffer_empty(&machine->clean_out))\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nfor(loop = 0; loop < 2; loop++) {\r\nbuffer_to_SSL(&machine->clean_in, machine->ssl);\r\nbuffer_to_BIO(&machine->dirty_in, machine->bio_intossl);\r\nbuffer_from_SSL(&machine->clean_out, machine->ssl);\r\nbuffer_from_BIO(&machine->dirty_out, machine->bio_fromssl);\r\n}\r\nif(SSL_get_app_data(machine->ssl) || (SSL_get_shutdown(machine->ssl) &&\r\nbuffer_empty(&machine->dirty_out))) {\r\nif(!state_machine_close_dirty(machine))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint state_machine_close_clean(state_machine_t *machine)\r\n{\r\nbuffer_close(&machine->clean_in);\r\nbuffer_close(&machine->clean_out);\r\nif(machine->ssl)\r\nSSL_shutdown(machine->ssl);\r\nstate_machine_churn(machine);\r\nif(buffer_empty(&machine->dirty_in) &&\r\nbuffer_empty(&machine->dirty_out))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint state_machine_close_dirty(state_machine_t *machine)\r\n{\r\nbuffer_close(&machine->dirty_in);\r\nbuffer_close(&machine->dirty_out);\r\nbuffer_close(&machine->clean_in);\r\nif(machine->ssl)\r\nSSL_free(machine->ssl);\r\nmachine->ssl = NULL;\r\nmachine->bio_intossl = machine->bio_fromssl = NULL;\r\nif(buffer_empty(&machine->clean_out))\r\nreturn 0;\r\nreturn 1;\r\n}

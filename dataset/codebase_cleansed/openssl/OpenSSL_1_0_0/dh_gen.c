int DH_generate_parameters_ex(DH *ret, int prime_len, int generator, BN_GENCB *cb)\r\n{\r\nif(ret->meth->generate_params)\r\nreturn ret->meth->generate_params(ret, prime_len, generator, cb);\r\nreturn dh_builtin_genparams(ret, prime_len, generator, cb);\r\n}\r\nstatic int dh_builtin_genparams(DH *ret, int prime_len, int generator, BN_GENCB *cb)\r\n{\r\nBIGNUM *t1,*t2;\r\nint g,ok= -1;\r\nBN_CTX *ctx=NULL;\r\nctx=BN_CTX_new();\r\nif (ctx == NULL) goto err;\r\nBN_CTX_start(ctx);\r\nt1 = BN_CTX_get(ctx);\r\nt2 = BN_CTX_get(ctx);\r\nif (t1 == NULL || t2 == NULL) goto err;\r\nif(!ret->p && ((ret->p = BN_new()) == NULL)) goto err;\r\nif(!ret->g && ((ret->g = BN_new()) == NULL)) goto err;\r\nif (generator <= 1)\r\n{\r\nDHerr(DH_F_DH_BUILTIN_GENPARAMS, DH_R_BAD_GENERATOR);\r\ngoto err;\r\n}\r\nif (generator == DH_GENERATOR_2)\r\n{\r\nif (!BN_set_word(t1,24)) goto err;\r\nif (!BN_set_word(t2,11)) goto err;\r\ng=2;\r\n}\r\n#if 0\r\nelse if (generator == DH_GENERATOR_3)\r\n{\r\nif (!BN_set_word(t1,12)) goto err;\r\nif (!BN_set_word(t2,5)) goto err;\r\ng=3;\r\n}\r\n#endif\r\nelse if (generator == DH_GENERATOR_5)\r\n{\r\nif (!BN_set_word(t1,10)) goto err;\r\nif (!BN_set_word(t2,3)) goto err;\r\ng=5;\r\n}\r\nelse\r\n{\r\nif (!BN_set_word(t1,2)) goto err;\r\nif (!BN_set_word(t2,1)) goto err;\r\ng=generator;\r\n}\r\nif(!BN_generate_prime_ex(ret->p,prime_len,1,t1,t2,cb)) goto err;\r\nif(!BN_GENCB_call(cb, 3, 0)) goto err;\r\nif (!BN_set_word(ret->g,g)) goto err;\r\nok=1;\r\nerr:\r\nif (ok == -1)\r\n{\r\nDHerr(DH_F_DH_BUILTIN_GENPARAMS,ERR_R_BN_LIB);\r\nok=0;\r\n}\r\nif (ctx != NULL)\r\n{\r\nBN_CTX_end(ctx);\r\nBN_CTX_free(ctx);\r\n}\r\nreturn ok;\r\n}

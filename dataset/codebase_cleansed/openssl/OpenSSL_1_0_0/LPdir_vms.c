const char *LP_find_file(LP_DIR_CTX **ctx, const char *directory)\r\n{\r\nint status;\r\nchar *p, *r;\r\nsize_t l;\r\nunsigned long flags = 0;\r\n#ifdef NAML$C_MAXRSS\r\nflags |= LIB$M_FIL_LONG_NAMES;\r\n#endif\r\nif (ctx == NULL || directory == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn 0;\r\n}\r\nerrno = 0;\r\nif (*ctx == NULL)\r\n{\r\nsize_t filespeclen = strlen(directory);\r\nchar *filespec = NULL;\r\nif (directory[filespeclen-1] != ']'\r\n&& directory[filespeclen-1] != '>'\r\n&& directory[filespeclen-1] != ':')\r\n{\r\nerrno = EINVAL;\r\nreturn 0;\r\n}\r\nfilespeclen += 4;\r\nif (filespeclen >\r\n#ifdef NAML$C_MAXRSS\r\nNAML$C_MAXRSS\r\n#else\r\n255\r\n#endif\r\n)\r\n{\r\nerrno = ENAMETOOLONG;\r\nreturn 0;\r\n}\r\n*ctx = (LP_DIR_CTX *)malloc(sizeof(LP_DIR_CTX));\r\nif (*ctx == NULL)\r\n{\r\nerrno = ENOMEM;\r\nreturn 0;\r\n}\r\nmemset(*ctx, '\0', sizeof(LP_DIR_CTX));\r\nstrcpy((*ctx)->filespec,directory);\r\nstrcat((*ctx)->filespec,"*.*;");\r\n(*ctx)->filespec_dsc.dsc$w_length = filespeclen;\r\n(*ctx)->filespec_dsc.dsc$b_dtype = DSC$K_DTYPE_T;\r\n(*ctx)->filespec_dsc.dsc$b_class = DSC$K_CLASS_S;\r\n(*ctx)->filespec_dsc.dsc$a_pointer = (*ctx)->filespec;\r\n(*ctx)->result_dsc.dsc$w_length = 0;\r\n(*ctx)->result_dsc.dsc$b_dtype = DSC$K_DTYPE_T;\r\n(*ctx)->result_dsc.dsc$b_class = DSC$K_CLASS_D;\r\n(*ctx)->result_dsc.dsc$a_pointer = 0;\r\n}\r\n(*ctx)->result_dsc.dsc$w_length = 0;\r\n(*ctx)->result_dsc.dsc$b_dtype = DSC$K_DTYPE_T;\r\n(*ctx)->result_dsc.dsc$b_class = DSC$K_CLASS_D;\r\n(*ctx)->result_dsc.dsc$a_pointer = 0;\r\nstatus = lib$find_file(&(*ctx)->filespec_dsc, &(*ctx)->result_dsc,\r\n&(*ctx)->VMS_context, 0, 0, 0, &flags);\r\nif (status == RMS$_NMF)\r\n{\r\nerrno = 0;\r\nvaxc$errno = status;\r\nreturn NULL;\r\n}\r\nif(!$VMS_STATUS_SUCCESS(status))\r\n{\r\nerrno = EVMSERR;\r\nvaxc$errno = status;\r\nreturn NULL;\r\n}\r\nl = (*ctx)->result_dsc.dsc$w_length;\r\np = (*ctx)->result_dsc.dsc$a_pointer;\r\nr = p;\r\nfor (; *p; p++)\r\n{\r\nif (*p == '^' && p[1] != '\0')\r\n{\r\np++;\r\n}\r\nelse if (*p == ':' || *p == '>' || *p == ']')\r\n{\r\nl -= p + 1 - r;\r\nr = p + 1;\r\n}\r\nelse if (*p == ';')\r\n{\r\nl = p - r;\r\nbreak;\r\n}\r\n}\r\nstrncpy((*ctx)->result, r, l);\r\n(*ctx)->result[l] = '\0';\r\nstr$free1_dx(&(*ctx)->result_dsc);\r\nreturn (*ctx)->result;\r\n}\r\nint LP_find_file_end(LP_DIR_CTX **ctx)\r\n{\r\nif (ctx != NULL && *ctx != NULL)\r\n{\r\nint status = lib$find_file_end(&(*ctx)->VMS_context);\r\nfree(*ctx);\r\nif(!$VMS_STATUS_SUCCESS(status))\r\n{\r\nerrno = EVMSERR;\r\nvaxc$errno = status;\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nerrno = EINVAL;\r\nreturn 0;\r\n}

int i2d_X509_PKEY(X509_PKEY *a, unsigned char **pp)\r\n{\r\nreturn(0);\r\n}\r\nX509_PKEY *d2i_X509_PKEY(X509_PKEY **a, const unsigned char **pp, long length)\r\n{\r\nint i;\r\nM_ASN1_D2I_vars(a,X509_PKEY *,X509_PKEY_new);\r\nM_ASN1_D2I_Init();\r\nM_ASN1_D2I_start_sequence();\r\nM_ASN1_D2I_get_x(X509_ALGOR,ret->enc_algor,d2i_X509_ALGOR);\r\nM_ASN1_D2I_get_x(ASN1_OCTET_STRING,ret->enc_pkey,d2i_ASN1_OCTET_STRING);\r\nret->cipher.cipher=EVP_get_cipherbyname(\r\nOBJ_nid2ln(OBJ_obj2nid(ret->enc_algor->algorithm)));\r\nif (ret->cipher.cipher == NULL)\r\n{\r\nc.error=ASN1_R_UNSUPPORTED_CIPHER;\r\nc.line=__LINE__;\r\ngoto err;\r\n}\r\nif (ret->enc_algor->parameter->type == V_ASN1_OCTET_STRING)\r\n{\r\ni=ret->enc_algor->parameter->value.octet_string->length;\r\nif (i > EVP_MAX_IV_LENGTH)\r\n{\r\nc.error=ASN1_R_IV_TOO_LARGE;\r\nc.line=__LINE__;\r\ngoto err;\r\n}\r\nmemcpy(ret->cipher.iv,\r\nret->enc_algor->parameter->value.octet_string->data,i);\r\n}\r\nelse\r\nmemset(ret->cipher.iv,0,EVP_MAX_IV_LENGTH);\r\nM_ASN1_D2I_Finish(a,X509_PKEY_free,ASN1_F_D2I_X509_PKEY);\r\n}\r\nX509_PKEY *X509_PKEY_new(void)\r\n{\r\nX509_PKEY *ret=NULL;\r\nASN1_CTX c;\r\nM_ASN1_New_Malloc(ret,X509_PKEY);\r\nret->version=0;\r\nM_ASN1_New(ret->enc_algor,X509_ALGOR_new);\r\nM_ASN1_New(ret->enc_pkey,M_ASN1_OCTET_STRING_new);\r\nret->dec_pkey=NULL;\r\nret->key_length=0;\r\nret->key_data=NULL;\r\nret->key_free=0;\r\nret->cipher.cipher=NULL;\r\nmemset(ret->cipher.iv,0,EVP_MAX_IV_LENGTH);\r\nret->references=1;\r\nreturn(ret);\r\nM_ASN1_New_Error(ASN1_F_X509_PKEY_NEW);\r\n}\r\nvoid X509_PKEY_free(X509_PKEY *x)\r\n{\r\nint i;\r\nif (x == NULL) return;\r\ni=CRYPTO_add(&x->references,-1,CRYPTO_LOCK_X509_PKEY);\r\n#ifdef REF_PRINT\r\nREF_PRINT("X509_PKEY",x);\r\n#endif\r\nif (i > 0) return;\r\n#ifdef REF_CHECK\r\nif (i < 0)\r\n{\r\nfprintf(stderr,"X509_PKEY_free, bad reference count\n");\r\nabort();\r\n}\r\n#endif\r\nif (x->enc_algor != NULL) X509_ALGOR_free(x->enc_algor);\r\nif (x->enc_pkey != NULL) M_ASN1_OCTET_STRING_free(x->enc_pkey);\r\nif (x->dec_pkey != NULL)EVP_PKEY_free(x->dec_pkey);\r\nif ((x->key_data != NULL) && (x->key_free)) OPENSSL_free(x->key_data);\r\nOPENSSL_free(x);\r\n}

int ip_initialise(void)\r\n{\r\nstruct sigaction sa;\r\nsa.sa_handler = SIG_IGN;\r\nsa.sa_flags = 0;\r\nsigemptyset(&sa.sa_mask);\r\nif(sigaction(SIGPIPE, &sa, NULL) != 0)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint ip_create_listener_split(const char *ip, unsigned short port)\r\n{\r\nstruct sockaddr_in in_addr;\r\nint fd = -1;\r\nint reuseVal = 1;\r\nif((fd = socket(PF_INET, SOCK_STREAM, 0)) == -1)\r\ngoto err;\r\nif(setsockopt(fd, SOL_SOCKET, SO_REUSEADDR, (char *)(&reuseVal),\r\nsizeof(reuseVal)) != 0)\r\ngoto err;\r\nin_addr.sin_family = AF_INET;\r\nmemcpy(&in_addr.sin_addr.s_addr, ip, 4);\r\nin_addr.sin_port = htons(port);\r\nif(bind(fd, (struct sockaddr *)&in_addr, sizeof(struct sockaddr_in)) != 0)\r\ngoto err;\r\nif(listen(fd, IP_LISTENER_BACKLOG) != 0)\r\ngoto err;\r\nreturn fd;\r\nerr:\r\nif(fd != -1)\r\nclose(fd);\r\nreturn -1;\r\n}\r\nint ip_create_connection_split(const char *ip, unsigned short port)\r\n{\r\nstruct sockaddr_in in_addr;\r\nint flags, fd = -1;\r\nif((fd = socket(PF_INET, SOCK_STREAM, 0)) == -1)\r\ngoto err;\r\nif(((flags = fcntl(fd, F_GETFL, 0)) < 0) ||\r\n(fcntl(fd, F_SETFL, flags | O_NONBLOCK) < 0))\r\ngoto err;\r\nin_addr.sin_family = AF_INET;\r\nmemcpy(&in_addr.sin_addr.s_addr, ip, 4);\r\nin_addr.sin_port = htons(port);\r\nif((connect(fd, (struct sockaddr *)&in_addr,\r\nsizeof(struct sockaddr_in)) != 0) &&\r\n(errno != EINPROGRESS))\r\ngoto err;\r\nreturn fd;\r\nerr:\r\nif(fd != -1)\r\nclose(fd);\r\nreturn -1;\r\n}\r\nint ip_parse_address(const char *address, const char **parsed_ip,\r\nunsigned short *parsed_port, int accept_all_ip)\r\n{\r\nchar buf[256];\r\nstruct hostent *lookup;\r\nunsigned long port;\r\nconst char *ptr = strstr(address, ":");\r\nconst char *ip = all_local_ip;\r\nif(!ptr) {\r\nif(!accept_all_ip)\r\nreturn 0;\r\nptr = address;\r\ngoto determine_port;\r\n}\r\nif((ptr - address) > 255)\r\nreturn 0;\r\nmemset(buf, 0, 256);\r\nmemcpy(buf, address, ptr - address);\r\nptr++;\r\nif((lookup = gethostbyname(buf)) == NULL) {\r\nfprintf(stderr, "hostname lookup for '%s' failed\n", buf);\r\nreturn 0;\r\n}\r\nip = lookup->h_addr_list[0];\r\ndetermine_port:\r\nif(strlen(ptr) < 1)\r\nreturn 0;\r\nif(!int_strtoul(ptr, &port) || (port > 65535))\r\nreturn 0;\r\n*parsed_ip = ip;\r\n*parsed_port = (unsigned short)port;\r\nreturn 1;\r\n}\r\nint ip_create_listener(const char *address)\r\n{\r\nconst char *ip;\r\nunsigned short port;\r\nif(!ip_parse_address(address, &ip, &port, 1))\r\nreturn -1;\r\nreturn ip_create_listener_split(ip, port);\r\n}\r\nint ip_create_connection(const char *address)\r\n{\r\nconst char *ip;\r\nunsigned short port;\r\nif(!ip_parse_address(address, &ip, &port, 0))\r\nreturn -1;\r\nreturn ip_create_connection_split(ip, port);\r\n}\r\nint ip_accept_connection(int listen_fd)\r\n{\r\nreturn accept(listen_fd, NULL, NULL);\r\n}

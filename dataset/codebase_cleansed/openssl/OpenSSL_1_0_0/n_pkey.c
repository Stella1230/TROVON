int i2d_Netscape_RSA(const RSA *a, unsigned char **pp,\r\nint (*cb)(char *buf, int len, const char *prompt,\r\nint verify))\r\n{\r\nreturn i2d_RSA_NET(a, pp, cb, 0);\r\n}\r\nint i2d_RSA_NET(const RSA *a, unsigned char **pp,\r\nint (*cb)(char *buf, int len, const char *prompt, int verify),\r\nint sgckey)\r\n{\r\nint i, j, ret = 0;\r\nint rsalen, pkeylen, olen;\r\nNETSCAPE_PKEY *pkey = NULL;\r\nNETSCAPE_ENCRYPTED_PKEY *enckey = NULL;\r\nunsigned char buf[256],*zz;\r\nunsigned char key[EVP_MAX_KEY_LENGTH];\r\nEVP_CIPHER_CTX ctx;\r\nif (a == NULL) return(0);\r\nif ((pkey=NETSCAPE_PKEY_new()) == NULL) goto err;\r\nif ((enckey=NETSCAPE_ENCRYPTED_PKEY_new()) == NULL) goto err;\r\npkey->version = 0;\r\npkey->algor->algorithm=OBJ_nid2obj(NID_rsaEncryption);\r\nif ((pkey->algor->parameter=ASN1_TYPE_new()) == NULL) goto err;\r\npkey->algor->parameter->type=V_ASN1_NULL;\r\nrsalen = i2d_RSAPrivateKey(a, NULL);\r\npkey->private_key->length=rsalen;\r\npkeylen=i2d_NETSCAPE_PKEY(pkey,NULL);\r\nenckey->enckey->digest->length = pkeylen;\r\nenckey->os->length = 11;\r\nenckey->enckey->algor->algorithm=OBJ_nid2obj(NID_rc4);\r\nif ((enckey->enckey->algor->parameter=ASN1_TYPE_new()) == NULL) goto err;\r\nenckey->enckey->algor->parameter->type=V_ASN1_NULL;\r\nif (pp == NULL)\r\n{\r\nolen = i2d_NETSCAPE_ENCRYPTED_PKEY(enckey, NULL);\r\nNETSCAPE_PKEY_free(pkey);\r\nNETSCAPE_ENCRYPTED_PKEY_free(enckey);\r\nreturn olen;\r\n}\r\nif ((zz=(unsigned char *)OPENSSL_malloc(rsalen)) == NULL)\r\n{\r\nASN1err(ASN1_F_I2D_RSA_NET,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\npkey->private_key->data = zz;\r\ni2d_RSAPrivateKey(a,&zz);\r\nif ((zz=OPENSSL_malloc(pkeylen)) == NULL)\r\n{\r\nASN1err(ASN1_F_I2D_RSA_NET,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nif (!ASN1_STRING_set(enckey->os, "private-key", -1))\r\n{\r\nASN1err(ASN1_F_I2D_RSA_NET,ERR_R_MALLOC_FAILURE);\r\ngoto err;\r\n}\r\nenckey->enckey->digest->data = zz;\r\ni2d_NETSCAPE_PKEY(pkey,&zz);\r\nOPENSSL_cleanse(pkey->private_key->data, rsalen);\r\nif (cb == NULL)\r\ncb=EVP_read_pw_string;\r\ni=cb((char *)buf,256,"Enter Private Key password:",1);\r\nif (i != 0)\r\n{\r\nASN1err(ASN1_F_I2D_RSA_NET,ASN1_R_BAD_PASSWORD_READ);\r\ngoto err;\r\n}\r\ni = strlen((char *)buf);\r\nif(sgckey) {\r\nEVP_Digest(buf, i, buf, NULL, EVP_md5(), NULL);\r\nmemcpy(buf + 16, "SGCKEYSALT", 10);\r\ni = 26;\r\n}\r\nEVP_BytesToKey(EVP_rc4(),EVP_md5(),NULL,buf,i,1,key,NULL);\r\nOPENSSL_cleanse(buf,256);\r\nzz = enckey->enckey->digest->data;\r\nEVP_CIPHER_CTX_init(&ctx);\r\nEVP_EncryptInit_ex(&ctx,EVP_rc4(),NULL,key,NULL);\r\nEVP_EncryptUpdate(&ctx,zz,&i,zz,pkeylen);\r\nEVP_EncryptFinal_ex(&ctx,zz + i,&j);\r\nEVP_CIPHER_CTX_cleanup(&ctx);\r\nret = i2d_NETSCAPE_ENCRYPTED_PKEY(enckey, pp);\r\nerr:\r\nNETSCAPE_ENCRYPTED_PKEY_free(enckey);\r\nNETSCAPE_PKEY_free(pkey);\r\nreturn(ret);\r\n}\r\nRSA *d2i_Netscape_RSA(RSA **a, const unsigned char **pp, long length,\r\nint (*cb)(char *buf, int len, const char *prompt,\r\nint verify))\r\n{\r\nreturn d2i_RSA_NET(a, pp, length, cb, 0);\r\n}\r\nRSA *d2i_RSA_NET(RSA **a, const unsigned char **pp, long length,\r\nint (*cb)(char *buf, int len, const char *prompt, int verify),\r\nint sgckey)\r\n{\r\nRSA *ret=NULL;\r\nconst unsigned char *p, *kp;\r\nNETSCAPE_ENCRYPTED_PKEY *enckey = NULL;\r\np = *pp;\r\nenckey = d2i_NETSCAPE_ENCRYPTED_PKEY(NULL, &p, length);\r\nif(!enckey) {\r\nASN1err(ASN1_F_D2I_RSA_NET,ASN1_R_DECODING_ERROR);\r\nreturn NULL;\r\n}\r\nif ((enckey->os->length != 11) || (strncmp("private-key",\r\n(char *)enckey->os->data,11) != 0))\r\n{\r\nASN1err(ASN1_F_D2I_RSA_NET,ASN1_R_PRIVATE_KEY_HEADER_MISSING);\r\nNETSCAPE_ENCRYPTED_PKEY_free(enckey);\r\nreturn NULL;\r\n}\r\nif (OBJ_obj2nid(enckey->enckey->algor->algorithm) != NID_rc4)\r\n{\r\nASN1err(ASN1_F_D2I_RSA_NET,ASN1_R_UNSUPPORTED_ENCRYPTION_ALGORITHM);\r\ngoto err;\r\n}\r\nkp = enckey->enckey->digest->data;\r\nif (cb == NULL)\r\ncb=EVP_read_pw_string;\r\nif ((ret=d2i_RSA_NET_2(a, enckey->enckey->digest,cb, sgckey)) == NULL) goto err;\r\n*pp = p;\r\nerr:\r\nNETSCAPE_ENCRYPTED_PKEY_free(enckey);\r\nreturn ret;\r\n}\r\nstatic RSA *d2i_RSA_NET_2(RSA **a, ASN1_OCTET_STRING *os,\r\nint (*cb)(char *buf, int len, const char *prompt,\r\nint verify), int sgckey)\r\n{\r\nNETSCAPE_PKEY *pkey=NULL;\r\nRSA *ret=NULL;\r\nint i,j;\r\nunsigned char buf[256];\r\nconst unsigned char *zz;\r\nunsigned char key[EVP_MAX_KEY_LENGTH];\r\nEVP_CIPHER_CTX ctx;\r\ni=cb((char *)buf,256,"Enter Private Key password:",0);\r\nif (i != 0)\r\n{\r\nASN1err(ASN1_F_D2I_RSA_NET_2,ASN1_R_BAD_PASSWORD_READ);\r\ngoto err;\r\n}\r\ni = strlen((char *)buf);\r\nif(sgckey){\r\nEVP_Digest(buf, i, buf, NULL, EVP_md5(), NULL);\r\nmemcpy(buf + 16, "SGCKEYSALT", 10);\r\ni = 26;\r\n}\r\nEVP_BytesToKey(EVP_rc4(),EVP_md5(),NULL,buf,i,1,key,NULL);\r\nOPENSSL_cleanse(buf,256);\r\nEVP_CIPHER_CTX_init(&ctx);\r\nEVP_DecryptInit_ex(&ctx,EVP_rc4(),NULL, key,NULL);\r\nEVP_DecryptUpdate(&ctx,os->data,&i,os->data,os->length);\r\nEVP_DecryptFinal_ex(&ctx,&(os->data[i]),&j);\r\nEVP_CIPHER_CTX_cleanup(&ctx);\r\nos->length=i+j;\r\nzz=os->data;\r\nif ((pkey=d2i_NETSCAPE_PKEY(NULL,&zz,os->length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_RSA_NET_2,ASN1_R_UNABLE_TO_DECODE_RSA_PRIVATE_KEY);\r\ngoto err;\r\n}\r\nzz=pkey->private_key->data;\r\nif ((ret=d2i_RSAPrivateKey(a,&zz,pkey->private_key->length)) == NULL)\r\n{\r\nASN1err(ASN1_F_D2I_RSA_NET_2,ASN1_R_UNABLE_TO_DECODE_RSA_KEY);\r\ngoto err;\r\n}\r\nerr:\r\nNETSCAPE_PKEY_free(pkey);\r\nreturn(ret);\r\n}

int main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nchar *keyfile=NULL;\r\nBIO *in;\r\nEVP_PKEY *pkey;\r\nX509 *x509;\r\nPKCS7 *p7;\r\nPKCS7_SIGNER_INFO *si;\r\nX509_STORE_CTX cert_ctx;\r\nX509_STORE *cert_store=NULL;\r\nBIO *data,*detached=NULL,*p7bio=NULL;\r\nchar buf[1024*4];\r\nunsigned char *pp;\r\nint i,printit=0;\r\nSTACK_OF(PKCS7_SIGNER_INFO) *sk;\r\nOpenSSL_add_all_algorithms();\r\nbio_err=BIO_new_fp(stderr,BIO_NOCLOSE);\r\ndata=BIO_new(BIO_s_file());\r\npp=NULL;\r\nwhile (argc > 1)\r\n{\r\nargc--;\r\nargv++;\r\nif (strcmp(argv[0],"-p") == 0)\r\n{\r\nprintit=1;\r\n}\r\nelse if ((strcmp(argv[0],"-k") == 0) && (argc >= 2)) {\r\nkeyfile = argv[1];\r\nargc-=1;\r\nargv+=1;\r\n} else if ((strcmp(argv[0],"-d") == 0) && (argc >= 2))\r\n{\r\ndetached=BIO_new(BIO_s_file());\r\nif (!BIO_read_filename(detached,argv[1]))\r\ngoto err;\r\nargc-=1;\r\nargv+=1;\r\n}\r\nelse break;\r\n}\r\nif (!BIO_read_filename(data,argv[0])) goto err;\r\nif(!keyfile) {\r\nfprintf(stderr, "No private key file specified\n");\r\ngoto err;\r\n}\r\nif ((in=BIO_new_file(keyfile,"r")) == NULL) goto err;\r\nif ((x509=PEM_read_bio_X509(in,NULL,NULL,NULL)) == NULL) goto err;\r\nBIO_reset(in);\r\nif ((pkey=PEM_read_bio_PrivateKey(in,NULL,NULL,NULL)) == NULL)\r\ngoto err;\r\nBIO_free(in);\r\nif (pp == NULL)\r\nBIO_set_fp(data,stdin,BIO_NOCLOSE);\r\nif ((p7=PEM_read_bio_PKCS7(data,NULL,NULL,NULL)) == NULL) goto err;\r\ncert_store=X509_STORE_new();\r\nX509_STORE_set_default_paths(cert_store);\r\nX509_STORE_load_locations(cert_store,NULL,"../../certs");\r\nX509_STORE_set_verify_cb_func(cert_store,verify_callback);\r\nERR_clear_error();\r\np7bio=PKCS7_dataDecode(p7,pkey,detached,x509);\r\nif (p7bio == NULL)\r\n{\r\nprintf("problems decoding\n");\r\ngoto err;\r\n}\r\nfor (;;)\r\n{\r\ni=BIO_read(p7bio,buf,sizeof(buf));\r\nif (i <= 0) break;\r\nfwrite(buf,1, i, stdout);\r\n}\r\nsk=PKCS7_get_signer_info(p7);\r\nif (sk == NULL)\r\n{\r\nfprintf(stderr, "there are no signatures on this data\n");\r\n}\r\nelse\r\n{\r\nERR_clear_error();\r\nfor (i=0; i<sk_PKCS7_SIGNER_INFO_num(sk); i++)\r\n{\r\nsi=sk_PKCS7_SIGNER_INFO_value(sk,i);\r\ni=PKCS7_dataVerify(cert_store,&cert_ctx,p7bio,p7,si);\r\nif (i <= 0)\r\ngoto err;\r\nelse\r\nfprintf(stderr,"Signature verified\n");\r\n}\r\n}\r\nX509_STORE_free(cert_store);\r\nexit(0);\r\nerr:\r\nERR_load_crypto_strings();\r\nERR_print_errors_fp(stderr);\r\nexit(1);\r\n}\r\nint verify_callback(int ok, X509_STORE_CTX *ctx)\r\n{\r\nchar buf[256];\r\nX509 *err_cert;\r\nint err,depth;\r\nerr_cert=X509_STORE_CTX_get_current_cert(ctx);\r\nerr= X509_STORE_CTX_get_error(ctx);\r\ndepth= X509_STORE_CTX_get_error_depth(ctx);\r\nX509_NAME_oneline(X509_get_subject_name(err_cert),buf,256);\r\nBIO_printf(bio_err,"depth=%d %s\n",depth,buf);\r\nif (!ok)\r\n{\r\nBIO_printf(bio_err,"verify error:num=%d:%s\n",err,\r\nX509_verify_cert_error_string(err));\r\nif (depth < 6)\r\n{\r\nok=1;\r\nX509_STORE_CTX_set_error(ctx,X509_V_OK);\r\n}\r\nelse\r\n{\r\nok=0;\r\nX509_STORE_CTX_set_error(ctx,X509_V_ERR_CERT_CHAIN_TOO_LONG);\r\n}\r\n}\r\nswitch (ctx->error)\r\n{\r\ncase X509_V_ERR_UNABLE_TO_GET_ISSUER_CERT:\r\nX509_NAME_oneline(X509_get_issuer_name(ctx->current_cert),buf,256);\r\nBIO_printf(bio_err,"issuer= %s\n",buf);\r\nbreak;\r\ncase X509_V_ERR_CERT_NOT_YET_VALID:\r\ncase X509_V_ERR_ERROR_IN_CERT_NOT_BEFORE_FIELD:\r\nBIO_printf(bio_err,"notBefore=");\r\nASN1_UTCTIME_print(bio_err,X509_get_notBefore(ctx->current_cert));\r\nBIO_printf(bio_err,"\n");\r\nbreak;\r\ncase X509_V_ERR_CERT_HAS_EXPIRED:\r\ncase X509_V_ERR_ERROR_IN_CERT_NOT_AFTER_FIELD:\r\nBIO_printf(bio_err,"notAfter=");\r\nASN1_UTCTIME_print(bio_err,X509_get_notAfter(ctx->current_cert));\r\nBIO_printf(bio_err,"\n");\r\nbreak;\r\n}\r\nBIO_printf(bio_err,"verify return:%d\n",ok);\r\nreturn(ok);\r\n}

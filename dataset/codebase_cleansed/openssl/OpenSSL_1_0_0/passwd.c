int MAIN(int argc, char **argv)\r\n{\r\nint ret = 1;\r\nchar *infile = NULL;\r\nint in_stdin = 0;\r\nint in_noverify = 0;\r\nchar *salt = NULL, *passwd = NULL, **passwds = NULL;\r\nchar *salt_malloc = NULL, *passwd_malloc = NULL;\r\nsize_t passwd_malloc_size = 0;\r\nint pw_source_defined = 0;\r\nBIO *in = NULL, *out = NULL;\r\nint i, badopt, opt_done;\r\nint passed_salt = 0, quiet = 0, table = 0, reverse = 0;\r\nint usecrypt = 0, use1 = 0, useapr1 = 0;\r\nsize_t pw_maxlen = 0;\r\napps_startup();\r\nif (bio_err == NULL)\r\nif ((bio_err=BIO_new(BIO_s_file())) != NULL)\r\nBIO_set_fp(bio_err,stderr,BIO_NOCLOSE|BIO_FP_TEXT);\r\nif (!load_config(bio_err, NULL))\r\ngoto err;\r\nout = BIO_new(BIO_s_file());\r\nif (out == NULL)\r\ngoto err;\r\nBIO_set_fp(out, stdout, BIO_NOCLOSE | BIO_FP_TEXT);\r\n#ifdef OPENSSL_SYS_VMS\r\n{\r\nBIO *tmpbio = BIO_new(BIO_f_linebuffer());\r\nout = BIO_push(tmpbio, out);\r\n}\r\n#endif\r\nbadopt = 0, opt_done = 0;\r\ni = 0;\r\nwhile (!badopt && !opt_done && argv[++i] != NULL)\r\n{\r\nif (strcmp(argv[i], "-crypt") == 0)\r\nusecrypt = 1;\r\nelse if (strcmp(argv[i], "-1") == 0)\r\nuse1 = 1;\r\nelse if (strcmp(argv[i], "-apr1") == 0)\r\nuseapr1 = 1;\r\nelse if (strcmp(argv[i], "-salt") == 0)\r\n{\r\nif ((argv[i+1] != NULL) && (salt == NULL))\r\n{\r\npassed_salt = 1;\r\nsalt = argv[++i];\r\n}\r\nelse\r\nbadopt = 1;\r\n}\r\nelse if (strcmp(argv[i], "-in") == 0)\r\n{\r\nif ((argv[i+1] != NULL) && !pw_source_defined)\r\n{\r\npw_source_defined = 1;\r\ninfile = argv[++i];\r\n}\r\nelse\r\nbadopt = 1;\r\n}\r\nelse if (strcmp(argv[i], "-stdin") == 0)\r\n{\r\nif (!pw_source_defined)\r\n{\r\npw_source_defined = 1;\r\nin_stdin = 1;\r\n}\r\nelse\r\nbadopt = 1;\r\n}\r\nelse if (strcmp(argv[i], "-noverify") == 0)\r\nin_noverify = 1;\r\nelse if (strcmp(argv[i], "-quiet") == 0)\r\nquiet = 1;\r\nelse if (strcmp(argv[i], "-table") == 0)\r\ntable = 1;\r\nelse if (strcmp(argv[i], "-reverse") == 0)\r\nreverse = 1;\r\nelse if (argv[i][0] == '-')\r\nbadopt = 1;\r\nelse if (!pw_source_defined)\r\n{\r\npw_source_defined = 1;\r\npasswds = &argv[i];\r\nopt_done = 1;\r\n}\r\nelse\r\nbadopt = 1;\r\n}\r\nif (!usecrypt && !use1 && !useapr1)\r\nusecrypt = 1;\r\nif (usecrypt + use1 + useapr1 > 1)\r\nbadopt = 1;\r\n#ifdef OPENSSL_NO_DES\r\nif (usecrypt) badopt = 1;\r\n#endif\r\n#ifdef NO_MD5CRYPT_1\r\nif (use1 || useapr1) badopt = 1;\r\n#endif\r\nif (badopt)\r\n{\r\nBIO_printf(bio_err, "Usage: passwd [options] [passwords]\n");\r\nBIO_printf(bio_err, "where options are\n");\r\n#ifndef OPENSSL_NO_DES\r\nBIO_printf(bio_err, "-crypt standard Unix password algorithm (default)\n");\r\n#endif\r\n#ifndef NO_MD5CRYPT_1\r\nBIO_printf(bio_err, "-1 MD5-based password algorithm\n");\r\nBIO_printf(bio_err, "-apr1 MD5-based password algorithm, Apache variant\n");\r\n#endif\r\nBIO_printf(bio_err, "-salt string use provided salt\n");\r\nBIO_printf(bio_err, "-in file read passwords from file\n");\r\nBIO_printf(bio_err, "-stdin read passwords from stdin\n");\r\nBIO_printf(bio_err, "-noverify never verify when reading password from terminal\n");\r\nBIO_printf(bio_err, "-quiet no warnings\n");\r\nBIO_printf(bio_err, "-table format output as table\n");\r\nBIO_printf(bio_err, "-reverse switch table columns\n");\r\ngoto err;\r\n}\r\nif ((infile != NULL) || in_stdin)\r\n{\r\nin = BIO_new(BIO_s_file());\r\nif (in == NULL)\r\ngoto err;\r\nif (infile != NULL)\r\n{\r\nassert(in_stdin == 0);\r\nif (BIO_read_filename(in, infile) <= 0)\r\ngoto err;\r\n}\r\nelse\r\n{\r\nassert(in_stdin);\r\nBIO_set_fp(in, stdin, BIO_NOCLOSE);\r\n}\r\n}\r\nif (usecrypt)\r\npw_maxlen = 8;\r\nelse if (use1 || useapr1)\r\npw_maxlen = 256;\r\nif (passwds == NULL)\r\n{\r\npasswd_malloc_size = pw_maxlen + 2;\r\npasswd = passwd_malloc = OPENSSL_malloc(passwd_malloc_size);\r\nif (passwd_malloc == NULL)\r\ngoto err;\r\n}\r\nif ((in == NULL) && (passwds == NULL))\r\n{\r\nstatic char *passwds_static[2] = {NULL, NULL};\r\npasswds = passwds_static;\r\nif (in == NULL)\r\nif (EVP_read_pw_string(passwd_malloc, passwd_malloc_size, "Password: ", !(passed_salt || in_noverify)) != 0)\r\ngoto err;\r\npasswds[0] = passwd_malloc;\r\n}\r\nif (in == NULL)\r\n{\r\nassert(passwds != NULL);\r\nassert(*passwds != NULL);\r\ndo\r\n{\r\npasswd = *passwds++;\r\nif (!do_passwd(passed_salt, &salt, &salt_malloc, passwd, out,\r\nquiet, table, reverse, pw_maxlen, usecrypt, use1, useapr1))\r\ngoto err;\r\n}\r\nwhile (*passwds != NULL);\r\n}\r\nelse\r\n{\r\nint done;\r\nassert (passwd != NULL);\r\ndo\r\n{\r\nint r = BIO_gets(in, passwd, pw_maxlen + 1);\r\nif (r > 0)\r\n{\r\nchar *c = (strchr(passwd, '\n')) ;\r\nif (c != NULL)\r\n*c = 0;\r\nelse\r\n{\r\nchar trash[BUFSIZ];\r\ndo\r\nr = BIO_gets(in, trash, sizeof trash);\r\nwhile ((r > 0) && (!strchr(trash, '\n')));\r\n}\r\nif (!do_passwd(passed_salt, &salt, &salt_malloc, passwd, out,\r\nquiet, table, reverse, pw_maxlen, usecrypt, use1, useapr1))\r\ngoto err;\r\n}\r\ndone = (r <= 0);\r\n}\r\nwhile (!done);\r\n}\r\nret = 0;\r\nerr:\r\nERR_print_errors(bio_err);\r\nif (salt_malloc)\r\nOPENSSL_free(salt_malloc);\r\nif (passwd_malloc)\r\nOPENSSL_free(passwd_malloc);\r\nif (in)\r\nBIO_free(in);\r\nif (out)\r\nBIO_free_all(out);\r\napps_shutdown();\r\nOPENSSL_EXIT(ret);\r\n}\r\nstatic char *md5crypt(const char *passwd, const char *magic, const char *salt)\r\n{\r\nstatic char out_buf[6 + 9 + 24 + 2];\r\nunsigned char buf[MD5_DIGEST_LENGTH];\r\nchar *salt_out;\r\nint n;\r\nunsigned int i;\r\nEVP_MD_CTX md,md2;\r\nsize_t passwd_len, salt_len;\r\npasswd_len = strlen(passwd);\r\nout_buf[0] = '$';\r\nout_buf[1] = 0;\r\nassert(strlen(magic) <= 4);\r\nstrncat(out_buf, magic, 4);\r\nstrncat(out_buf, "$", 1);\r\nstrncat(out_buf, salt, 8);\r\nassert(strlen(out_buf) <= 6 + 8);\r\nsalt_out = out_buf + 2 + strlen(magic);\r\nsalt_len = strlen(salt_out);\r\nassert(salt_len <= 8);\r\nEVP_MD_CTX_init(&md);\r\nEVP_DigestInit_ex(&md,EVP_md5(), NULL);\r\nEVP_DigestUpdate(&md, passwd, passwd_len);\r\nEVP_DigestUpdate(&md, "$", 1);\r\nEVP_DigestUpdate(&md, magic, strlen(magic));\r\nEVP_DigestUpdate(&md, "$", 1);\r\nEVP_DigestUpdate(&md, salt_out, salt_len);\r\nEVP_MD_CTX_init(&md2);\r\nEVP_DigestInit_ex(&md2,EVP_md5(), NULL);\r\nEVP_DigestUpdate(&md2, passwd, passwd_len);\r\nEVP_DigestUpdate(&md2, salt_out, salt_len);\r\nEVP_DigestUpdate(&md2, passwd, passwd_len);\r\nEVP_DigestFinal_ex(&md2, buf, NULL);\r\nfor (i = passwd_len; i > sizeof buf; i -= sizeof buf)\r\nEVP_DigestUpdate(&md, buf, sizeof buf);\r\nEVP_DigestUpdate(&md, buf, i);\r\nn = passwd_len;\r\nwhile (n)\r\n{\r\nEVP_DigestUpdate(&md, (n & 1) ? "\0" : passwd, 1);\r\nn >>= 1;\r\n}\r\nEVP_DigestFinal_ex(&md, buf, NULL);\r\nfor (i = 0; i < 1000; i++)\r\n{\r\nEVP_DigestInit_ex(&md2,EVP_md5(), NULL);\r\nEVP_DigestUpdate(&md2, (i & 1) ? (unsigned const char *) passwd : buf,\r\n(i & 1) ? passwd_len : sizeof buf);\r\nif (i % 3)\r\nEVP_DigestUpdate(&md2, salt_out, salt_len);\r\nif (i % 7)\r\nEVP_DigestUpdate(&md2, passwd, passwd_len);\r\nEVP_DigestUpdate(&md2, (i & 1) ? buf : (unsigned const char *) passwd,\r\n(i & 1) ? sizeof buf : passwd_len);\r\nEVP_DigestFinal_ex(&md2, buf, NULL);\r\n}\r\nEVP_MD_CTX_cleanup(&md2);\r\n{\r\nunsigned char buf_perm[sizeof buf];\r\nint dest, source;\r\nchar *output;\r\nfor (dest = 0, source = 0; dest < 14; dest++, source = (source + 6) % 17)\r\nbuf_perm[dest] = buf[source];\r\nbuf_perm[14] = buf[5];\r\nbuf_perm[15] = buf[11];\r\n#ifndef PEDANTIC\r\nassert(16 == sizeof buf_perm);\r\n#endif\r\noutput = salt_out + salt_len;\r\nassert(output == out_buf + strlen(out_buf));\r\n*output++ = '$';\r\nfor (i = 0; i < 15; i += 3)\r\n{\r\n*output++ = cov_2char[buf_perm[i+2] & 0x3f];\r\n*output++ = cov_2char[((buf_perm[i+1] & 0xf) << 2) |\r\n(buf_perm[i+2] >> 6)];\r\n*output++ = cov_2char[((buf_perm[i] & 3) << 4) |\r\n(buf_perm[i+1] >> 4)];\r\n*output++ = cov_2char[buf_perm[i] >> 2];\r\n}\r\nassert(i == 15);\r\n*output++ = cov_2char[buf_perm[i] & 0x3f];\r\n*output++ = cov_2char[buf_perm[i] >> 6];\r\n*output = 0;\r\nassert(strlen(out_buf) < sizeof(out_buf));\r\n}\r\nEVP_MD_CTX_cleanup(&md);\r\nreturn out_buf;\r\n}\r\nstatic int do_passwd(int passed_salt, char **salt_p, char **salt_malloc_p,\r\nchar *passwd, BIO *out, int quiet, int table, int reverse,\r\nsize_t pw_maxlen, int usecrypt, int use1, int useapr1)\r\n{\r\nchar *hash = NULL;\r\nassert(salt_p != NULL);\r\nassert(salt_malloc_p != NULL);\r\nif (!passed_salt)\r\n{\r\n#ifndef OPENSSL_NO_DES\r\nif (usecrypt)\r\n{\r\nif (*salt_malloc_p == NULL)\r\n{\r\n*salt_p = *salt_malloc_p = OPENSSL_malloc(3);\r\nif (*salt_malloc_p == NULL)\r\ngoto err;\r\n}\r\nif (RAND_pseudo_bytes((unsigned char *)*salt_p, 2) < 0)\r\ngoto err;\r\n(*salt_p)[0] = cov_2char[(*salt_p)[0] & 0x3f];\r\n(*salt_p)[1] = cov_2char[(*salt_p)[1] & 0x3f];\r\n(*salt_p)[2] = 0;\r\n#ifdef CHARSET_EBCDIC\r\nascii2ebcdic(*salt_p, *salt_p, 2);\r\n#endif\r\n}\r\n#endif\r\n#ifndef NO_MD5CRYPT_1\r\nif (use1 || useapr1)\r\n{\r\nint i;\r\nif (*salt_malloc_p == NULL)\r\n{\r\n*salt_p = *salt_malloc_p = OPENSSL_malloc(9);\r\nif (*salt_malloc_p == NULL)\r\ngoto err;\r\n}\r\nif (RAND_pseudo_bytes((unsigned char *)*salt_p, 8) < 0)\r\ngoto err;\r\nfor (i = 0; i < 8; i++)\r\n(*salt_p)[i] = cov_2char[(*salt_p)[i] & 0x3f];\r\n(*salt_p)[8] = 0;\r\n}\r\n#endif\r\n}\r\nassert(*salt_p != NULL);\r\nif ((strlen(passwd) > pw_maxlen))\r\n{\r\nif (!quiet)\r\nBIO_printf(bio_err, "Warning: truncating password to %u characters\n", (unsigned)pw_maxlen);\r\npasswd[pw_maxlen] = 0;\r\n}\r\nassert(strlen(passwd) <= pw_maxlen);\r\n#ifndef OPENSSL_NO_DES\r\nif (usecrypt)\r\nhash = DES_crypt(passwd, *salt_p);\r\n#endif\r\n#ifndef NO_MD5CRYPT_1\r\nif (use1 || useapr1)\r\nhash = md5crypt(passwd, (use1 ? "1" : "apr1"), *salt_p);\r\n#endif\r\nassert(hash != NULL);\r\nif (table && !reverse)\r\nBIO_printf(out, "%s\t%s\n", passwd, hash);\r\nelse if (table && reverse)\r\nBIO_printf(out, "%s\t%s\n", hash, passwd);\r\nelse\r\nBIO_printf(out, "%s\n", hash);\r\nreturn 1;\r\nerr:\r\nreturn 0;\r\n}\r\nint MAIN(int argc, char **argv)\r\n{\r\nfputs("Program not available.\n", stderr)\r\nOPENSSL_EXIT(1);\r\n}

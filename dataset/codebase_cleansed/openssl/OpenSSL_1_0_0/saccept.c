void close_up()\r\n{\r\nif (in != NULL)\r\nBIO_free(in);\r\n}\r\nint main(argc,argv)\r\nint argc;\r\nchar *argv[];\r\n{\r\nchar *port=NULL;\r\nBIO *ssl_bio,*tmp;\r\nSSL_CTX *ctx;\r\nSSL *ssl;\r\nchar buf[512];\r\nint ret=1,i;\r\nif (argc <= 1)\r\nport="*:4433";\r\nelse\r\nport=argv[1];\r\nsignal(SIGINT,close_up);\r\nSSL_load_error_strings();\r\n#ifdef WATT32\r\ndbug_init();\r\nsock_init();\r\n#endif\r\nOpenSSL_add_ssl_algorithms();\r\nctx=SSL_CTX_new(SSLv23_server_method());\r\nif (!SSL_CTX_use_certificate_file(ctx,CERT_FILE,SSL_FILETYPE_PEM))\r\ngoto err;\r\nif (!SSL_CTX_use_PrivateKey_file(ctx,CERT_FILE,SSL_FILETYPE_PEM))\r\ngoto err;\r\nif (!SSL_CTX_check_private_key(ctx))\r\ngoto err;\r\nssl=SSL_new(ctx);\r\nssl_bio=BIO_new_ssl(ctx,0);\r\nif ((in=BIO_new_accept(port)) == NULL) goto err;\r\nBIO_set_accept_bios(in,ssl_bio);\r\nagain:\r\nif (BIO_do_accept(in) <= 0) goto err;\r\nfor (;;)\r\n{\r\ni=BIO_read(in,buf,512);\r\nif (i == 0)\r\n{\r\nprintf("Done\n");\r\ntmp=BIO_pop(in);\r\nBIO_free_all(tmp);\r\ngoto again;\r\n}\r\nif (i < 0) goto err;\r\nfwrite(buf,1,i,stdout);\r\nfflush(stdout);\r\n}\r\nret=0;\r\nerr:\r\nif (ret)\r\n{\r\nERR_print_errors_fp(stderr);\r\n}\r\nif (in != NULL) BIO_free(in);\r\nexit(ret);\r\nreturn(!ret);\r\n}

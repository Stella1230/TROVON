int MDC2_Init(MDC2_CTX *c)\r\n{\r\nc->num=0;\r\nc->pad_type=1;\r\nmemset(&(c->h[0]),0x52,MDC2_BLOCK);\r\nmemset(&(c->hh[0]),0x25,MDC2_BLOCK);\r\nreturn 1;\r\n}\r\nint MDC2_Update(MDC2_CTX *c, const unsigned char *in, size_t len)\r\n{\r\nsize_t i,j;\r\ni=c->num;\r\nif (i != 0)\r\n{\r\nif (i+len < MDC2_BLOCK)\r\n{\r\nmemcpy(&(c->data[i]),in,len);\r\nc->num+=(int)len;\r\nreturn 1;\r\n}\r\nelse\r\n{\r\nj=MDC2_BLOCK-i;\r\nmemcpy(&(c->data[i]),in,j);\r\nlen-=j;\r\nin+=j;\r\nc->num=0;\r\nmdc2_body(c,&(c->data[0]),MDC2_BLOCK);\r\n}\r\n}\r\ni=len&~((size_t)MDC2_BLOCK-1);\r\nif (i > 0) mdc2_body(c,in,i);\r\nj=len-i;\r\nif (j > 0)\r\n{\r\nmemcpy(&(c->data[0]),&(in[i]),j);\r\nc->num=(int)j;\r\n}\r\nreturn 1;\r\n}\r\nstatic void mdc2_body(MDC2_CTX *c, const unsigned char *in, size_t len)\r\n{\r\nregister DES_LONG tin0,tin1;\r\nregister DES_LONG ttin0,ttin1;\r\nDES_LONG d[2],dd[2];\r\nDES_key_schedule k;\r\nunsigned char *p;\r\nsize_t i;\r\nfor (i=0; i<len; i+=8)\r\n{\r\nc2l(in,tin0); d[0]=dd[0]=tin0;\r\nc2l(in,tin1); d[1]=dd[1]=tin1;\r\nc->h[0]=(c->h[0]&0x9f)|0x40;\r\nc->hh[0]=(c->hh[0]&0x9f)|0x20;\r\nDES_set_odd_parity(&c->h);\r\nDES_set_key_unchecked(&c->h,&k);\r\nDES_encrypt1(d,&k,1);\r\nDES_set_odd_parity(&c->hh);\r\nDES_set_key_unchecked(&c->hh,&k);\r\nDES_encrypt1(dd,&k,1);\r\nttin0=tin0^dd[0];\r\nttin1=tin1^dd[1];\r\ntin0^=d[0];\r\ntin1^=d[1];\r\np=c->h;\r\nl2c(tin0,p);\r\nl2c(ttin1,p);\r\np=c->hh;\r\nl2c(ttin0,p);\r\nl2c(tin1,p);\r\n}\r\n}\r\nint MDC2_Final(unsigned char *md, MDC2_CTX *c)\r\n{\r\nunsigned int i;\r\nint j;\r\ni=c->num;\r\nj=c->pad_type;\r\nif ((i > 0) || (j == 2))\r\n{\r\nif (j == 2)\r\nc->data[i++]=0x80;\r\nmemset(&(c->data[i]),0,MDC2_BLOCK-i);\r\nmdc2_body(c,c->data,MDC2_BLOCK);\r\n}\r\nmemcpy(md,(char *)c->h,MDC2_BLOCK);\r\nmemcpy(&(md[MDC2_BLOCK]),(char *)c->hh,MDC2_BLOCK);\r\nreturn 1;\r\n}\r\nmain()\r\n{\r\nunsigned char md[MDC2_DIGEST_LENGTH];\r\nint i;\r\nMDC2_CTX c;\r\nstatic char *text="Now is the time for all ";\r\nMDC2_Init(&c);\r\nMDC2_Update(&c,text,strlen(text));\r\nMDC2_Final(&(md[0]),&c);\r\nfor (i=0; i<MDC2_DIGEST_LENGTH; i++)\r\nprintf("%02X",md[i]);\r\nprintf("\n");\r\n}

void DES_ede3_cbcm_encrypt(const unsigned char *in, unsigned char *out,\r\nlong length, DES_key_schedule *ks1, DES_key_schedule *ks2,\r\nDES_key_schedule *ks3, DES_cblock *ivec1, DES_cblock *ivec2,\r\nint enc)\r\n{\r\nregister DES_LONG tin0,tin1;\r\nregister DES_LONG tout0,tout1,xor0,xor1,m0,m1;\r\nregister long l=length;\r\nDES_LONG tin[2];\r\nunsigned char *iv1,*iv2;\r\niv1 = &(*ivec1)[0];\r\niv2 = &(*ivec2)[0];\r\nif (enc)\r\n{\r\nc2l(iv1,m0);\r\nc2l(iv1,m1);\r\nc2l(iv2,tout0);\r\nc2l(iv2,tout1);\r\nfor (l-=8; l>=-7; l-=8)\r\n{\r\ntin[0]=m0;\r\ntin[1]=m1;\r\nDES_encrypt1(tin,ks3,1);\r\nm0=tin[0];\r\nm1=tin[1];\r\nif(l < 0)\r\n{\r\nc2ln(in,tin0,tin1,l+8);\r\n}\r\nelse\r\n{\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\n}\r\ntin0^=tout0;\r\ntin1^=tout1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nDES_encrypt1(tin,ks1,1);\r\ntin[0]^=m0;\r\ntin[1]^=m1;\r\nDES_encrypt1(tin,ks2,0);\r\ntin[0]^=m0;\r\ntin[1]^=m1;\r\nDES_encrypt1(tin,ks1,1);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\n}\r\niv1=&(*ivec1)[0];\r\nl2c(m0,iv1);\r\nl2c(m1,iv1);\r\niv2=&(*ivec2)[0];\r\nl2c(tout0,iv2);\r\nl2c(tout1,iv2);\r\n}\r\nelse\r\n{\r\nregister DES_LONG t0,t1;\r\nc2l(iv1,m0);\r\nc2l(iv1,m1);\r\nc2l(iv2,xor0);\r\nc2l(iv2,xor1);\r\nfor (l-=8; l>=-7; l-=8)\r\n{\r\ntin[0]=m0;\r\ntin[1]=m1;\r\nDES_encrypt1(tin,ks3,1);\r\nm0=tin[0];\r\nm1=tin[1];\r\nc2l(in,tin0);\r\nc2l(in,tin1);\r\nt0=tin0;\r\nt1=tin1;\r\ntin[0]=tin0;\r\ntin[1]=tin1;\r\nDES_encrypt1(tin,ks1,0);\r\ntin[0]^=m0;\r\ntin[1]^=m1;\r\nDES_encrypt1(tin,ks2,1);\r\ntin[0]^=m0;\r\ntin[1]^=m1;\r\nDES_encrypt1(tin,ks1,0);\r\ntout0=tin[0];\r\ntout1=tin[1];\r\ntout0^=xor0;\r\ntout1^=xor1;\r\nif(l < 0)\r\n{\r\nl2cn(tout0,tout1,out,l+8);\r\n}\r\nelse\r\n{\r\nl2c(tout0,out);\r\nl2c(tout1,out);\r\n}\r\nxor0=t0;\r\nxor1=t1;\r\n}\r\niv1=&(*ivec1)[0];\r\nl2c(m0,iv1);\r\nl2c(m1,iv1);\r\niv2=&(*ivec2)[0];\r\nl2c(xor0,iv2);\r\nl2c(xor1,iv2);\r\n}\r\ntin0=tin1=tout0=tout1=xor0=xor1=0;\r\ntin[0]=tin[1]=0;\r\n}

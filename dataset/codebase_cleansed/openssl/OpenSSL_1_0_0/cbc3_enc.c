void DES_3cbc_encrypt(DES_cblock *input, DES_cblock *output, long length,\r\nDES_key_schedule ks1, DES_key_schedule ks2, DES_cblock *iv1,\r\nDES_cblock *iv2, int enc)\r\n{\r\nint off=((int)length-1)/8;\r\nlong l8=((length+7)/8)*8;\r\nDES_cblock niv1,niv2;\r\nif (enc == DES_ENCRYPT)\r\n{\r\nDES_cbc_encrypt((unsigned char*)input,\r\n(unsigned char*)output,length,&ks1,iv1,enc);\r\nif (length >= sizeof(DES_cblock))\r\nmemcpy(niv1,output[off],sizeof(DES_cblock));\r\nDES_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,l8,&ks2,iv1,!enc);\r\nDES_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,l8,&ks1,iv2,enc);\r\nif (length >= sizeof(DES_cblock))\r\nmemcpy(niv2,output[off],sizeof(DES_cblock));\r\n}\r\nelse\r\n{\r\nif (length >= sizeof(DES_cblock))\r\nmemcpy(niv2,input[off],sizeof(DES_cblock));\r\nDES_cbc_encrypt((unsigned char*)input,\r\n(unsigned char*)output,l8,&ks1,iv2,enc);\r\nDES_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,l8,&ks2,iv1,!enc);\r\nif (length >= sizeof(DES_cblock))\r\nmemcpy(niv1,output[off],sizeof(DES_cblock));\r\nDES_cbc_encrypt((unsigned char*)output,\r\n(unsigned char*)output,length,&ks1,iv1,enc);\r\n}\r\nmemcpy(*iv1,niv1,sizeof(DES_cblock));\r\nmemcpy(*iv2,niv2,sizeof(DES_cblock));\r\n}

BIGNUM *EC_POINT_point2bn(const EC_GROUP *group,\r\nconst EC_POINT *point,\r\npoint_conversion_form_t form,\r\nBIGNUM *ret,\r\nBN_CTX *ctx)\r\n{\r\nsize_t buf_len=0;\r\nunsigned char *buf;\r\nbuf_len = EC_POINT_point2oct(group, point, form,\r\nNULL, 0, ctx);\r\nif (buf_len == 0)\r\nreturn NULL;\r\nif ((buf = OPENSSL_malloc(buf_len)) == NULL)\r\nreturn NULL;\r\nif (!EC_POINT_point2oct(group, point, form, buf, buf_len, ctx))\r\n{\r\nOPENSSL_free(buf);\r\nreturn NULL;\r\n}\r\nret = BN_bin2bn(buf, buf_len, ret);\r\nOPENSSL_free(buf);\r\nreturn ret;\r\n}\r\nEC_POINT *EC_POINT_bn2point(const EC_GROUP *group,\r\nconst BIGNUM *bn,\r\nEC_POINT *point,\r\nBN_CTX *ctx)\r\n{\r\nsize_t buf_len=0;\r\nunsigned char *buf;\r\nEC_POINT *ret;\r\nif ((buf_len = BN_num_bytes(bn)) == 0) return NULL;\r\nbuf = OPENSSL_malloc(buf_len);\r\nif (buf == NULL)\r\nreturn NULL;\r\nif (!BN_bn2bin(bn, buf))\r\n{\r\nOPENSSL_free(buf);\r\nreturn NULL;\r\n}\r\nif (point == NULL)\r\n{\r\nif ((ret = EC_POINT_new(group)) == NULL)\r\n{\r\nOPENSSL_free(buf);\r\nreturn NULL;\r\n}\r\n}\r\nelse\r\nret = point;\r\nif (!EC_POINT_oct2point(group, ret, buf, buf_len, ctx))\r\n{\r\nif (point == NULL)\r\nEC_POINT_clear_free(ret);\r\nOPENSSL_free(buf);\r\nreturn NULL;\r\n}\r\nOPENSSL_free(buf);\r\nreturn ret;\r\n}\r\nchar *EC_POINT_point2hex(const EC_GROUP *group,\r\nconst EC_POINT *point,\r\npoint_conversion_form_t form,\r\nBN_CTX *ctx)\r\n{\r\nchar *ret, *p;\r\nsize_t buf_len=0,i;\r\nunsigned char *buf, *pbuf;\r\nbuf_len = EC_POINT_point2oct(group, point, form,\r\nNULL, 0, ctx);\r\nif (buf_len == 0)\r\nreturn NULL;\r\nif ((buf = OPENSSL_malloc(buf_len)) == NULL)\r\nreturn NULL;\r\nif (!EC_POINT_point2oct(group, point, form, buf, buf_len, ctx))\r\n{\r\nOPENSSL_free(buf);\r\nreturn NULL;\r\n}\r\nret = (char *)OPENSSL_malloc(buf_len*2+2);\r\nif (ret == NULL)\r\n{\r\nOPENSSL_free(buf);\r\nreturn NULL;\r\n}\r\np = ret;\r\npbuf = buf;\r\nfor (i=buf_len; i > 0; i--)\r\n{\r\nint v = (int) *(pbuf++);\r\n*(p++)=HEX_DIGITS[v>>4];\r\n*(p++)=HEX_DIGITS[v&0x0F];\r\n}\r\n*p='\0';\r\nOPENSSL_free(buf);\r\nreturn ret;\r\n}\r\nEC_POINT *EC_POINT_hex2point(const EC_GROUP *group,\r\nconst char *buf,\r\nEC_POINT *point,\r\nBN_CTX *ctx)\r\n{\r\nEC_POINT *ret=NULL;\r\nBIGNUM *tmp_bn=NULL;\r\nif (!BN_hex2bn(&tmp_bn, buf))\r\nreturn NULL;\r\nret = EC_POINT_bn2point(group, tmp_bn, point, ctx);\r\nBN_clear_free(tmp_bn);\r\nreturn ret;\r\n}

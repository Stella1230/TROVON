int BIO_dump_cb(int (*cb)(const void *data, size_t len, void *u),\r\nvoid *u, const char *s, int len)\r\n{\r\nreturn BIO_dump_indent_cb(cb, u, s, len, 0);\r\n}\r\nint BIO_dump_indent_cb(int (*cb)(const void *data, size_t len, void *u),\r\nvoid *u, const char *s, int len, int indent)\r\n{\r\nint ret=0;\r\nchar buf[288+1],tmp[20],str[128+1];\r\nint i,j,rows,trc;\r\nunsigned char ch;\r\nint dump_width;\r\ntrc=0;\r\n#ifdef TRUNCATE\r\nfor(; (len > 0) && ((s[len-1] == ' ') || (s[len-1] == '\0')); len--)\r\ntrc++;\r\n#endif\r\nif (indent < 0)\r\nindent = 0;\r\nif (indent)\r\n{\r\nif (indent > 128) indent=128;\r\nmemset(str,' ',indent);\r\n}\r\nstr[indent]='\0';\r\ndump_width=DUMP_WIDTH_LESS_INDENT(indent);\r\nrows=(len/dump_width);\r\nif ((rows*dump_width)<len)\r\nrows++;\r\nfor(i=0;i<rows;i++)\r\n{\r\nbuf[0]='\0';\r\nBUF_strlcpy(buf,str,sizeof buf);\r\nBIO_snprintf(tmp,sizeof tmp,"%04x - ",i*dump_width);\r\nBUF_strlcat(buf,tmp,sizeof buf);\r\nfor(j=0;j<dump_width;j++)\r\n{\r\nif (((i*dump_width)+j)>=len)\r\n{\r\nBUF_strlcat(buf," ",sizeof buf);\r\n}\r\nelse\r\n{\r\nch=((unsigned char)*(s+i*dump_width+j)) & 0xff;\r\nBIO_snprintf(tmp,sizeof tmp,"%02x%c",ch,\r\nj==7?'-':' ');\r\nBUF_strlcat(buf,tmp,sizeof buf);\r\n}\r\n}\r\nBUF_strlcat(buf," ",sizeof buf);\r\nfor(j=0;j<dump_width;j++)\r\n{\r\nif (((i*dump_width)+j)>=len)\r\nbreak;\r\nch=((unsigned char)*(s+i*dump_width+j)) & 0xff;\r\n#ifndef CHARSET_EBCDIC\r\nBIO_snprintf(tmp,sizeof tmp,"%c",\r\n((ch>=' ')&&(ch<='~'))?ch:'.');\r\n#else\r\nBIO_snprintf(tmp,sizeof tmp,"%c",\r\n((ch>=os_toascii[' '])&&(ch<=os_toascii['~']))\r\n? os_toebcdic[ch]\r\n: '.');\r\n#endif\r\nBUF_strlcat(buf,tmp,sizeof buf);\r\n}\r\nBUF_strlcat(buf,"\n",sizeof buf);\r\nret+=cb((void *)buf,strlen(buf),u);\r\n}\r\n#ifdef TRUNCATE\r\nif (trc > 0)\r\n{\r\nBIO_snprintf(buf,sizeof buf,"%s%04x - <SPACES/NULS>\n",str,\r\nlen+trc);\r\nret+=cb((void *)buf,strlen(buf),u);\r\n}\r\n#endif\r\nreturn(ret);\r\n}\r\nstatic int write_fp(const void *data, size_t len, void *fp)\r\n{\r\nreturn UP_fwrite(data, len, 1, fp);\r\n}\r\nint BIO_dump_fp(FILE *fp, const char *s, int len)\r\n{\r\nreturn BIO_dump_cb(write_fp, fp, s, len);\r\n}\r\nint BIO_dump_indent_fp(FILE *fp, const char *s, int len, int indent)\r\n{\r\nreturn BIO_dump_indent_cb(write_fp, fp, s, len, indent);\r\n}\r\nstatic int write_bio(const void *data, size_t len, void *bp)\r\n{\r\nreturn BIO_write((BIO *)bp, (const char *)data, len);\r\n}\r\nint BIO_dump(BIO *bp, const char *s, int len)\r\n{\r\nreturn BIO_dump_cb(write_bio, bp, s, len);\r\n}\r\nint BIO_dump_indent(BIO *bp, const char *s, int len, int indent)\r\n{\r\nreturn BIO_dump_indent_cb(write_bio, bp, s, len, indent);\r\n}

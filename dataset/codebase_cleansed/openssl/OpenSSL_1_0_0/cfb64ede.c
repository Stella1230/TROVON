void DES_ede3_cfb64_encrypt(const unsigned char *in, unsigned char *out,\r\nlong length, DES_key_schedule *ks1,\r\nDES_key_schedule *ks2, DES_key_schedule *ks3,\r\nDES_cblock *ivec, int *num, int enc)\r\n{\r\nregister DES_LONG v0,v1;\r\nregister long l=length;\r\nregister int n= *num;\r\nDES_LONG ti[2];\r\nunsigned char *iv,c,cc;\r\niv=&(*ivec)[0];\r\nif (enc)\r\n{\r\nwhile (l--)\r\n{\r\nif (n == 0)\r\n{\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\nti[0]=v0;\r\nti[1]=v1;\r\nDES_encrypt3(ti,ks1,ks2,ks3);\r\nv0=ti[0];\r\nv1=ti[1];\r\niv = &(*ivec)[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\niv = &(*ivec)[0];\r\n}\r\nc= *(in++)^iv[n];\r\n*(out++)=c;\r\niv[n]=c;\r\nn=(n+1)&0x07;\r\n}\r\n}\r\nelse\r\n{\r\nwhile (l--)\r\n{\r\nif (n == 0)\r\n{\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\nti[0]=v0;\r\nti[1]=v1;\r\nDES_encrypt3(ti,ks1,ks2,ks3);\r\nv0=ti[0];\r\nv1=ti[1];\r\niv = &(*ivec)[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\niv = &(*ivec)[0];\r\n}\r\ncc= *(in++);\r\nc=iv[n];\r\niv[n]=cc;\r\n*(out++)=c^cc;\r\nn=(n+1)&0x07;\r\n}\r\n}\r\nv0=v1=ti[0]=ti[1]=c=cc=0;\r\n*num=n;\r\n}\r\nvoid DES_ede3_cfb_encrypt(const unsigned char *in,unsigned char *out,\r\nint numbits,long length,DES_key_schedule *ks1,\r\nDES_key_schedule *ks2,DES_key_schedule *ks3,\r\nDES_cblock *ivec,int enc)\r\n{\r\nregister DES_LONG d0,d1,v0,v1;\r\nregister unsigned long l=length,n=((unsigned int)numbits+7)/8;\r\nregister int num=numbits,i;\r\nDES_LONG ti[2];\r\nunsigned char *iv;\r\nunsigned char ovec[16];\r\nif (num > 64) return;\r\niv = &(*ivec)[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\nif (enc)\r\n{\r\nwhile (l >= n)\r\n{\r\nl-=n;\r\nti[0]=v0;\r\nti[1]=v1;\r\nDES_encrypt3(ti,ks1,ks2,ks3);\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nd0^=ti[0];\r\nd1^=ti[1];\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\nif (num == 32)\r\n{ v0=v1; v1=d0; }\r\nelse if (num == 64)\r\n{ v0=d0; v1=d1; }\r\nelse\r\n{\r\niv=&ovec[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nl2c(d0,iv);\r\nl2c(d1,iv);\r\nmemmove(ovec,ovec+num/8,8+(num%8 ? 1 : 0));\r\nif(num%8 != 0)\r\nfor(i=0 ; i < 8 ; ++i)\r\n{\r\novec[i]<<=num%8;\r\novec[i]|=ovec[i+1]>>(8-num%8);\r\n}\r\niv=&ovec[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nwhile (l >= n)\r\n{\r\nl-=n;\r\nti[0]=v0;\r\nti[1]=v1;\r\nDES_encrypt3(ti,ks1,ks2,ks3);\r\nc2ln(in,d0,d1,n);\r\nin+=n;\r\nif (num == 32)\r\n{ v0=v1; v1=d0; }\r\nelse if (num == 64)\r\n{ v0=d0; v1=d1; }\r\nelse\r\n{\r\niv=&ovec[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nl2c(d0,iv);\r\nl2c(d1,iv);\r\nmemmove(ovec,ovec+num/8,8+(num%8 ? 1 : 0));\r\nif(num%8 != 0)\r\nfor(i=0 ; i < 8 ; ++i)\r\n{\r\novec[i]<<=num%8;\r\novec[i]|=ovec[i+1]>>(8-num%8);\r\n}\r\niv=&ovec[0];\r\nc2l(iv,v0);\r\nc2l(iv,v1);\r\n}\r\nd0^=ti[0];\r\nd1^=ti[1];\r\nl2cn(d0,d1,out,n);\r\nout+=n;\r\n}\r\n}\r\niv = &(*ivec)[0];\r\nl2c(v0,iv);\r\nl2c(v1,iv);\r\nv0=v1=d0=d1=ti[0]=ti[1]=0;\r\n}

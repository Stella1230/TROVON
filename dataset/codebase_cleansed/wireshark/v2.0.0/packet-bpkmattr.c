static void\r\ndissect_attrs (tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree)\r\n{\r\nguint8 type;\r\nguint16 length;\r\nint pos = 0;\r\ngint total_len;\r\nproto_tree *cmid_tree, *tekp_tree, *scap_tree;\r\nproto_tree *saqry_tree, *dnld_tree, *sadsc_tree;\r\ntvbuff_t *cmid_tvb, *tekp_tvb, *scap_tvb;\r\ntvbuff_t *saqry_tvb, *dnld_tvb, *sadsc_tvb;\r\ntotal_len = tvb_reported_length_remaining (tvb, 0);\r\nwhile (pos < total_len)\r\n{\r\ntype = tvb_get_guint8 (tvb, pos++);\r\nlength = tvb_get_ntohs (tvb, pos);\r\npos += 2;\r\nswitch (type)\r\n{\r\ncase BPKM_RESERVED:\r\nbreak;\r\ncase BPKM_SERIAL_NUM:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_serial_num, tvb, pos,\r\nlength, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase BPKM_MANUFACTURER_ID:\r\nif (length == 3)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_manf_id, tvb, pos,\r\nlength, ENC_NA);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_MAC_ADDR:\r\nif (length == 6)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_mac_addr, tvb, pos,\r\nlength, ENC_NA);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_RSA_PUB_KEY:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_rsa_pub_key, tvb, pos,\r\nlength, ENC_NA);\r\nbreak;\r\ncase BPKM_CM_ID:\r\ncmid_tree =\r\nproto_tree_add_subtree(tree, tvb, pos, length,\r\nett_docsis_bpkmattr_cmid, NULL, "5 CM Identification");\r\ncmid_tvb = tvb_new_subset_length (tvb, pos, length);\r\ndissect_attrs (cmid_tvb, pinfo, cmid_tree);\r\nbreak;\r\ncase BPKM_DISPLAY_STR:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_display_str, tvb, pos,\r\nlength, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase BPKM_AUTH_KEY:\r\nif ((length == 96) || (length == 128))\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_auth_key, tvb, pos,\r\nlength, ENC_NA);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_TEK:\r\nif (length == 8 || length == 16)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_tek, tvb, pos,\r\nlength, ENC_NA);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_KEY_LIFETIME:\r\nif (length == 4)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_key_life, tvb, pos,\r\nlength, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_KEY_SEQ_NUM:\r\nif (length == 1)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_key_seq, tvb, pos,\r\nlength, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_HMAC_DIGEST:\r\nif (length == 20)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_hmac_digest, tvb,\r\npos, length, ENC_NA);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_SAID:\r\nif (length == 2)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_said, tvb, pos,\r\nlength, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_TEK_PARAM:\r\ntekp_tree =\r\nproto_tree_add_subtree(tree, tvb, pos, length, ett_docsis_bpkmattr_tekp, NULL, "13 TEK Parameters");\r\ntekp_tvb = tvb_new_subset_length (tvb, pos, length);\r\ndissect_attrs (tekp_tvb, pinfo, tekp_tree);\r\nbreak;\r\ncase BPKM_OBSOLETED:\r\nbreak;\r\ncase BPKM_CBC_IV:\r\nif (length == 8 || length == 16)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_cbc_iv, tvb, pos,\r\nlength, ENC_NA);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_ERROR_CODE:\r\nif (length == 1)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_error_code, tvb,\r\npos, length, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_CA_CERT:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_ca_cert, tvb, pos,\r\nlength, ENC_NA);\r\nbreak;\r\ncase BPKM_CM_CERT:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_cm_cert, tvb, pos,\r\nlength, ENC_NA);\r\nbreak;\r\ncase BPKM_SEC_CAPABILITIES:\r\nscap_tree =\r\nproto_tree_add_subtree(tree, tvb, pos, length,\r\nett_docsis_bpkmattr_scap, NULL, "19 Security Capabilities");\r\nscap_tvb = tvb_new_subset_length (tvb, pos, length);\r\ndissect_attrs (scap_tvb, pinfo, scap_tree);\r\nbreak;\r\ncase BPKM_CRYPTO_SUITE:\r\nif (length == 2)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_crypto_suite, tvb,\r\npos, length, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_CRYPTO_SUITE_LIST:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_crypto_suite_list,\r\ntvb, pos, length, ENC_NA);\r\nbreak;\r\ncase BPKM_BPI_VERSION:\r\nif (length == 1)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_bpi_version, tvb,\r\npos, length, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_SA_DESCRIPTOR:\r\nsadsc_tree =\r\nproto_tree_add_subtree(tree, tvb, pos, length, ett_docsis_bpkmattr_sadsc, NULL, "23 SA Descriptor");\r\nsadsc_tvb = tvb_new_subset_length (tvb, pos, length);\r\ndissect_attrs (sadsc_tvb, pinfo, sadsc_tree);\r\nbreak;\r\ncase BPKM_SA_TYPE:\r\nif (length == 1)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_sa_type, tvb, pos,\r\nlength, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_SA_QUERY:\r\nsaqry_tree =\r\nproto_tree_add_subtree(tree, tvb, pos, length, ett_docsis_bpkmattr_saqry, NULL, "25 SA Query");\r\nsaqry_tvb = tvb_new_subset_length (tvb, pos, length);\r\ndissect_attrs (saqry_tvb, pinfo, saqry_tree);\r\nbreak;\r\ncase BPKM_SA_QUERY_TYPE:\r\nif (length == 1)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_sa_query_type, tvb,\r\npos, length, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_IP_ADDRESS:\r\nif (length == 4)\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_ip_address, tvb,\r\npos, length, ENC_BIG_ENDIAN);\r\nelse\r\nTHROW (ReportedBoundsError);\r\nbreak;\r\ncase BPKM_VENDOR_DEFINED:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_vendor_def, tvb, pos,\r\nlength, ENC_NA);\r\nbreak;\r\ncase BPKM_DNLD_PARAMS:\r\ndnld_tree =\r\nproto_tree_add_subtree(tree, tvb, pos, length,\r\nett_docsis_bpkmattr_dnld, NULL, "28 Download Parameters");\r\ndnld_tvb = tvb_new_subset_length (tvb, pos, length);\r\ndissect_attrs (dnld_tvb, pinfo, dnld_tree);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item (tree, hf_docsis_bpkmattr_vendor_def, tvb, pos,\r\nlength, ENC_NA);\r\nbreak;\r\n}\r\npos += length;\r\n}\r\n}\r\nstatic void\r\ndissect_bpkmattr (tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree)\r\n{\r\nproto_item *it;\r\nproto_tree *bpkmattr_tree;\r\nif (tree)\r\n{\r\nit =\r\nproto_tree_add_protocol_format (tree, proto_docsis_bpkmattr, tvb, 0, -1,\r\n"BPKM Attributes");\r\nbpkmattr_tree = proto_item_add_subtree (it, ett_docsis_bpkmattr);\r\ndissect_attrs (tvb, pinfo, bpkmattr_tree);\r\n}\r\n}\r\nvoid\r\nproto_register_docsis_bpkmattr (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_docsis_bpkmattr_serial_num,\r\n{"1 Serial Number", "docsis_bpkmattr.serialnum",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Serial Number", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_manf_id,\r\n{"2 Manufacturer Id", "docsis_bpkmattr.manfid",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Manufacturer Id", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_mac_addr,\r\n{"3 Mac Address", "docsis_bpkmattr.macaddr",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\n"Mac Address", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_rsa_pub_key,\r\n{"4 RSA Public Key", "docsis_bpkmattr.rsa_pub_key",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"RSA Public Key", HFILL}\r\n},\r\n#if 0\r\n{&hf_docsis_bpkmattr_cm_id,\r\n{"5 CM Identification", "docsis_bpkmattr.cmid",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"CM Identification", HFILL}\r\n},\r\n#endif\r\n{&hf_docsis_bpkmattr_display_str,\r\n{"6 Display String", "docsis_bpkmattr.dispstr",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Display String", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_auth_key,\r\n{"7 Auth Key", "docsis_bpkmattr.auth_key",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Auth Key", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_tek,\r\n{"8 Traffic Encryption Key", "docsis_bpkmattr.tek",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Traffic Encryption Key", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_key_life,\r\n{"9 Key Lifetime (s)", "docsis_bpkmattr.keylife",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Key Lifetime (s)", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_key_seq,\r\n{"10 Key Sequence Number", "docsis_bpkmattr.keyseq",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Key Sequence Number", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_hmac_digest,\r\n{"11 HMAC Digest", "docsis_bpkmattr.hmacdigest",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"HMAC Digest", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_said,\r\n{"12 SAID", "docsis_bpkmattr.said",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Security Association ID", HFILL}\r\n},\r\n#if 0\r\n{&hf_docsis_bpkmattr_tek_params,\r\n{"13 TEK Parameters", "docsis_bpkmattr.tekparams",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"TEK Parameters", HFILL}\r\n},\r\n#endif\r\n{&hf_docsis_bpkmattr_cbc_iv,\r\n{"14 CBC IV", "docsis_bpkmattr.cbciv",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Cypher Block Chaining", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_error_code,\r\n{"16 Error Code", "docsis_bpkmattr.errcode",\r\nFT_UINT8, BASE_DEC, VALS (error_code_vals), 0x0,\r\n"Error Code", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_vendor_def,\r\n{"127 Vendor Defined", "docsis_bpkmattr.vendordef",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Vendor Defined", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_ca_cert,\r\n{"17 CA Certificate", "docsis_bpkmattr.cacert",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"CA Certificate", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_cm_cert,\r\n{"18 CM Certificate", "docsis_bpkmattr.cmcert",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"CM Certificate", HFILL}\r\n},\r\n#if 0\r\n{&hf_docsis_bpkmattr_security_cap,\r\n{"19 Security Capabilities", "docsis_bpkmattr.seccap",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Security Capabilities", HFILL}\r\n},\r\n#endif\r\n{&hf_docsis_bpkmattr_crypto_suite,\r\n{"20 Cryptographic Suite", "docsis_bpkmattr.cryptosuite",\r\nFT_UINT16, BASE_HEX, VALS(crypto_suite_attr_vals), 0x0,\r\n"Cryptographic Suite", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_crypto_suite_list,\r\n{"21 Cryptographic Suite List", "docsis_bpkmattr.crypto_suite_lst",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Cryptographic Suite", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_bpi_version,\r\n{"22 BPI Version", "docsis_bpkmattr.bpiver",\r\nFT_UINT8, BASE_DEC, VALS (bpi_ver_vals), 0x0,\r\n"BPKM Attributes", HFILL}\r\n},\r\n#if 0\r\n{&hf_docsis_bpkmattr_sa_descr,\r\n{"23 SA Descriptor", "docsis_bpkmattr.sadescr",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"SA Descriptor", HFILL}\r\n},\r\n#endif\r\n{&hf_docsis_bpkmattr_sa_type,\r\n{"24 SA Type", "docsis_bpkmattr.satype",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"SA Type", HFILL}\r\n},\r\n#if 0\r\n{&hf_docsis_bpkmattr_sa_query,\r\n{"25 SA Query", "docsis_bpkmattr.saquery",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"SA Query", HFILL}\r\n},\r\n#endif\r\n{&hf_docsis_bpkmattr_sa_query_type,\r\n{"26 SA Query Type", "docsis_bpkmattr.saquery_type",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\n"SA Query Type", HFILL}\r\n},\r\n{&hf_docsis_bpkmattr_ip_address,\r\n{"27 IP Address", "docsis_bpkmattr.ipaddr",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"IP Address", HFILL}\r\n},\r\n#if 0\r\n{&hf_docsis_bpkmattr_download_param,\r\n{"28 Download Parameters", "docsis_bpkmattr.dnld_params",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Download Parameters", HFILL}\r\n},\r\n#endif\r\n};\r\nstatic gint *ett[] = {\r\n&ett_docsis_bpkmattr,\r\n&ett_docsis_bpkmattr_cmid,\r\n&ett_docsis_bpkmattr_scap,\r\n&ett_docsis_bpkmattr_tekp,\r\n&ett_docsis_bpkmattr_sadsc,\r\n&ett_docsis_bpkmattr_saqry,\r\n&ett_docsis_bpkmattr_dnld\r\n};\r\nproto_docsis_bpkmattr =\r\nproto_register_protocol\r\n("DOCSIS Baseline Privacy Key Management Attributes", "DOCSIS BPKM-ATTR",\r\n"docsis_bpkmattr");\r\nproto_register_field_array (proto_docsis_bpkmattr, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\nregister_dissector ("docsis_bpkmattr", dissect_bpkmattr,\r\nproto_docsis_bpkmattr);\r\n}\r\nvoid\r\nproto_reg_handoff_docsis_bpkmattr (void)\r\n{\r\n#if 0\r\ndissector_handle_t docsis_bpkmattr_handle;\r\ndocsis_bpkmattr_handle = find_dissector ("docsis_bpkmattr");\r\ndissector_add_uint ("docsis", 0xFE, docsis_bpkmattr_handle);\r\n#endif\r\n}

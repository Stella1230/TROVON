condition *cnd_new(const char *class_id, ...) {\r\nva_list ap;\r\ncondition *cnd = NULL;\r\ncondition *cnd_ref = NULL;\r\n_cnd_class *cls = NULL;\r\nchar *id = NULL;\r\n_cnd_init();\r\nif ((cls = (_cnd_class *)g_hash_table_lookup(classes, class_id)) == NULL) {\r\ng_warning("cnd_new: Couldn't find class ID \"%s\"", class_id);\r\nreturn NULL;\r\n}\r\nif ((cnd_ref = (condition *)g_malloc(sizeof(condition))) == NULL)\r\nreturn NULL;\r\ncnd_ref->user_data = NULL;\r\ncnd_ref->eval_func = cls->eval_func;\r\ncnd_ref->reset_func = cls->reset_func;\r\ncnd_ref->class_id = g_strdup(class_id);\r\nva_start(ap, class_id);\r\ncnd = (cls->constr_func)(cnd_ref, ap);\r\nva_end(ap);\r\nif (cnd == NULL) {\r\ng_free(cnd_ref);\r\ng_free(id);\r\n}\r\nreturn cnd;\r\n}\r\nvoid cnd_delete(condition *cnd) {\r\n_cnd_class *cls = NULL;\r\nconst char* class_id;\r\nif (cnd == NULL)\r\nreturn;\r\nclass_id = cnd->class_id;\r\n_cnd_init();\r\ncls = (_cnd_class *)g_hash_table_lookup(classes, class_id);\r\nif (cls != NULL)\r\n(cls->destr_func)(cnd);\r\ng_free(cnd->class_id);\r\ng_free(cnd);\r\n}\r\ngboolean cnd_eval(condition *cnd, ...) {\r\nva_list ap;\r\ngboolean ret_val = FALSE;\r\nif (cnd == NULL)\r\nreturn FALSE;\r\nva_start(ap, cnd);\r\nret_val = (cnd->eval_func)(cnd, ap);\r\nva_end(ap);\r\nreturn ret_val;\r\n}\r\nvoid cnd_reset(condition *cnd) {\r\nif (cnd != NULL)\r\n(cnd->reset_func)(cnd);\r\n}\r\nvoid* cnd_get_user_data(condition *cnd) {\r\nreturn cnd->user_data;\r\n}\r\nvoid cnd_set_user_data(condition *cnd, void *user_data) {\r\ncnd->user_data = user_data;\r\n}\r\ngboolean cnd_register_class(const char *class_id,\r\n_cnd_constr constr_func,\r\n_cnd_destr destr_func,\r\n_cnd_eval eval_func,\r\n_cnd_reset reset_func) {\r\nchar *key = NULL;\r\n_cnd_class *cls = NULL;\r\nif ((constr_func == NULL) || (destr_func == NULL) ||\r\n(eval_func == NULL) || (reset_func == NULL) || (class_id == NULL))\r\nreturn FALSE;\r\n_cnd_init();\r\nif (g_hash_table_lookup(classes, class_id) != NULL) {\r\ng_warning("cnd_register_class: Duplicate class ID \"%s\"", class_id);\r\nreturn FALSE;\r\n}\r\nkey = g_strdup(class_id);\r\nif ((cls = (_cnd_class*)g_malloc(sizeof(_cnd_class))) == NULL) {\r\ng_free(key);\r\nreturn FALSE;\r\n}\r\ncls->constr_func = constr_func;\r\ncls->destr_func = destr_func;\r\ncls->eval_func = eval_func;\r\ncls->reset_func = reset_func;\r\ng_hash_table_insert(classes, key, cls);\r\nreturn TRUE;\r\n}\r\nvoid cnd_unregister_class(const char* class_id) {\r\nconst char *key = (const char*)class_id;\r\n_cnd_class *cls = NULL;\r\n_cnd_init();\r\ng_hash_table_foreach(classes,\r\n_cnd_find_hash_key_for_class_id,\r\n(gpointer)key);\r\ncls = (_cnd_class*)g_hash_table_lookup(classes, class_id);\r\ng_hash_table_remove(classes, class_id);\r\ng_free(pkey);\r\npkey = NULL;\r\ng_free(cls);\r\n}\r\nstatic void _cnd_init(void) {\r\nif (classes != NULL)\r\nreturn;\r\nclasses = g_hash_table_new(g_str_hash, g_str_equal);\r\n}\r\nvoid _cnd_find_hash_key_for_class_id(gpointer key,\r\ngpointer value _U_,\r\ngpointer user_data) {\r\nchar *class_id = (char *)user_data;\r\nchar *key_value = (char *)key;\r\nif (strcmp(class_id, key_value) == 0)\r\npkey = key_value;\r\n}

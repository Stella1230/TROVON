static UBits barg(lua_State *L, int idx)\r\n{\r\nBitNum bn;\r\nUBits b;\r\n#if LUA_VERSION_NUM < 502\r\nbn.n = lua_tonumber(L, idx);\r\n#else\r\nbn.n = luaL_checknumber(L, idx);\r\n#endif\r\n#if defined(LUA_NUMBER_DOUBLE)\r\nbn.n += 6755399441055744.0;\r\n#ifdef SWAPPED_DOUBLE\r\nb = (UBits)(bn.b >> 32);\r\n#else\r\nb = (UBits)bn.b;\r\n#endif\r\n#elif defined(LUA_NUMBER_INT) || defined(LUA_NUMBER_LONG) || \\r\ndefined(LUA_NUMBER_LONGLONG) || defined(LUA_NUMBER_LONG_LONG) || \\r\ndefined(LUA_NUMBER_LLONG)\r\nif (sizeof(UBits) == sizeof(lua_Number))\r\nb = bn.b;\r\nelse\r\nb = (UBits)(SBits)bn.n;\r\n#elif defined(LUA_NUMBER_FLOAT)\r\n#error "A 'float' lua_Number type is incompatible with this library"\r\n#else\r\n#error "Unknown number type, check LUA_NUMBER_* in luaconf.h"\r\n#endif\r\n#if LUA_VERSION_NUM < 502\r\nif (b == 0 && !lua_isnumber(L, idx)) {\r\nluaL_typerror(L, idx, "number");\r\n}\r\n#endif\r\nreturn b;\r\n}\r\nstatic int bit_tobit(lua_State *L) { BRET(barg(L, 1)) }\r\nstatic int bit_bnot(lua_State *L) { BRET(~barg(L, 1)) }\r\nstatic int bit_bswap(lua_State *L)\r\n{\r\nUBits b = barg(L, 1);\r\nb = (b >> 24) | ((b >> 8) & 0xff00) | ((b & 0xff00) << 8) | (b << 24);\r\nBRET(b)\r\n}\r\nstatic int bit_tohex(lua_State *L)\r\n{\r\nUBits b = barg(L, 1);\r\nSBits n = lua_isnone(L, 2) ? 8 : (SBits)barg(L, 2);\r\nconst char *hexdigits = "0123456789abcdef";\r\nchar buf[8];\r\nint i;\r\nif (n < 0) { n = -n; hexdigits = "0123456789ABCDEF"; }\r\nif (n > 8) n = 8;\r\nfor (i = (int)n; --i >= 0; ) { buf[i] = hexdigits[b & 15]; b >>= 4; }\r\nlua_pushlstring(L, buf, (size_t)n);\r\nreturn 1;\r\n}\r\nLUALIB_API int luaopen_bit(lua_State *L)\r\n{\r\nUBits b;\r\nlua_pushnumber(L, (lua_Number)1437217655L);\r\nb = barg(L, -1);\r\nif (b != (UBits)1437217655L || BAD_SAR) {\r\nconst char *msg = "compiled with incompatible luaconf.h";\r\n#ifdef LUA_NUMBER_DOUBLE\r\n#ifdef _WIN32\r\nif (b == (UBits)1610612736L)\r\nmsg = "use D3DCREATE_FPU_PRESERVE with DirectX";\r\n#endif\r\nif (b == (UBits)1127743488L)\r\nmsg = "not compiled with SWAPPED_DOUBLE";\r\n#endif\r\nif (BAD_SAR)\r\nmsg = "arithmetic right-shift broken";\r\nluaL_error(L, "bit library self-test failed (%s)", msg);\r\n}\r\n#if LUA_VERSION_NUM < 502\r\nluaL_register(L, "bit", bit_funcs);\r\nreturn 1;\r\n#else\r\nluaL_newlib(L, bit_funcs);\r\nlua_setglobal(L, "bit");\r\nreturn 0;\r\n#endif\r\n}

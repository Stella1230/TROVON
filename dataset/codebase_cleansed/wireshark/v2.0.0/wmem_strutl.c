gchar *\r\nwmem_strdup(wmem_allocator_t *allocator, const gchar *src)\r\n{\r\nsize_t len;\r\nif (!src) {\r\nsrc = "<NULL>";\r\n}\r\nlen = strlen(src) + 1;\r\nreturn (gchar *)memcpy(wmem_alloc(allocator, len), src, len);\r\n}\r\ngchar *\r\nwmem_strndup(wmem_allocator_t *allocator, const gchar *src, const size_t len)\r\n{\r\ngchar *dst;\r\nguint i;\r\ndst = (gchar *)wmem_alloc(allocator, len+1);\r\nfor (i=0; (i < len) && src[i]; i++) {\r\ndst[i] = src[i];\r\n}\r\ndst[i] = '\0';\r\nreturn dst;\r\n}\r\ngchar *\r\nwmem_strdup_printf(wmem_allocator_t *allocator, const gchar *fmt, ...)\r\n{\r\nva_list ap;\r\ngchar *dst;\r\nva_start(ap, fmt);\r\ndst = wmem_strdup_vprintf(allocator, fmt, ap);\r\nva_end(ap);\r\nreturn dst;\r\n}\r\ngchar *\r\nwmem_strdup_vprintf(wmem_allocator_t *allocator, const gchar *fmt, va_list ap)\r\n{\r\nva_list ap2;\r\ngchar *dst;\r\nint needed_len;\r\nG_VA_COPY(ap2, ap);\r\ndst = (gchar *)wmem_alloc(allocator, WMEM_STRDUP_VPRINTF_DEFAULT_BUFFER);\r\nneeded_len = g_vsnprintf(dst, (gulong) WMEM_STRDUP_VPRINTF_DEFAULT_BUFFER, fmt, ap2) + 1;\r\nva_end(ap2);\r\nif (needed_len > WMEM_STRDUP_VPRINTF_DEFAULT_BUFFER) {\r\nwmem_free(allocator, dst);\r\ndst = (gchar *)wmem_alloc(allocator, needed_len);\r\nG_VA_COPY(ap2, ap);\r\ng_vsnprintf(dst, (gulong) needed_len, fmt, ap2);\r\nva_end(ap2);\r\n}\r\nreturn dst;\r\n}\r\ngchar *\r\nwmem_strconcat(wmem_allocator_t *allocator, const gchar *first, ...)\r\n{\r\ngsize len;\r\nva_list args;\r\ngchar *s;\r\ngchar *concat;\r\ngchar *ptr;\r\nif (!first)\r\nreturn NULL;\r\nlen = 1 + strlen(first);\r\nva_start(args, first);\r\nwhile ((s = va_arg(args, gchar*))) {\r\nlen += strlen(s);\r\n}\r\nva_end(args);\r\nptr = concat = (gchar *)wmem_alloc(allocator, len);\r\nptr = g_stpcpy(ptr, first);\r\nva_start(args, first);\r\nwhile ((s = va_arg(args, gchar*))) {\r\nptr = g_stpcpy(ptr, s);\r\n}\r\nva_end(args);\r\nreturn concat;\r\n}\r\ngchar **\r\nwmem_strsplit(wmem_allocator_t *allocator, const gchar *src,\r\nconst gchar *delimiter, int max_tokens)\r\n{\r\ngchar* splitted;\r\ngchar* s;\r\nguint tokens;\r\nguint str_len;\r\nguint sep_len;\r\nguint i;\r\ngchar** vec;\r\nenum { AT_START, IN_PAD, IN_TOKEN } state;\r\nguint curr_tok = 0;\r\nif ( ! src\r\n|| ! delimiter\r\n|| ! delimiter[0])\r\nreturn NULL;\r\ns = splitted = wmem_strdup(allocator, src);\r\nstr_len = (guint) strlen(splitted);\r\nsep_len = (guint) strlen(delimiter);\r\nif (max_tokens < 1) max_tokens = INT_MAX;\r\ntokens = 1;\r\nwhile (tokens <= (guint)max_tokens && ( s = strstr(s,delimiter) )) {\r\ntokens++;\r\nfor(i=0; i < sep_len; i++ )\r\ns[i] = '\0';\r\ns += sep_len;\r\n}\r\nvec = wmem_alloc_array(allocator, gchar*,tokens+1);\r\nstate = AT_START;\r\nfor (i=0; i< str_len; i++) {\r\nswitch(state) {\r\ncase AT_START:\r\nif (splitted[i] == '\0') {\r\nstate = IN_PAD;\r\n}\r\nelse {\r\nvec[curr_tok] = &(splitted[i]);\r\ncurr_tok++;\r\nstate = IN_TOKEN;\r\n}\r\nbreak;\r\ncase IN_TOKEN:\r\nif (splitted[i] == '\0') {\r\nstate = IN_PAD;\r\n}\r\nbreak;\r\ncase IN_PAD:\r\nif (splitted[i] != '\0') {\r\nvec[curr_tok] = &(splitted[i]);\r\ncurr_tok++;\r\nstate = IN_TOKEN;\r\n}\r\nbreak;\r\n}\r\n}\r\nvec[curr_tok] = NULL;\r\nreturn vec;\r\n}\r\ngchar*\r\nwmem_ascii_strdown(wmem_allocator_t *allocator, const gchar *str, gssize len)\r\n{\r\ngchar *result, *s;\r\ng_return_val_if_fail (str != NULL, NULL);\r\nif (len < 0)\r\nlen = strlen (str);\r\nresult = wmem_strndup(allocator, str, len);\r\nfor (s = result; *s; s++)\r\n*s = g_ascii_tolower (*s);\r\nreturn result;\r\n}

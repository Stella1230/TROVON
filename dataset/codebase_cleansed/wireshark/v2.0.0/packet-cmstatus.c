static void\r\ndissect_cmstatus_tlv (tvbuff_t * tvb, proto_tree * tree, guint8 start, guint16 len)\r\n{\r\nproto_item *it;\r\nproto_tree *tlv_tree;\r\nguint16 pos = start + 1;\r\nguint8 type, length;\r\nit = proto_tree_add_protocol_format (tree, proto_docsis_cmstatus, tvb, 0, len, "TLV Data");\r\ntlv_tree = proto_item_add_subtree (it, ett_docsis_cmstatus_tlv);\r\nwhile (pos < (len + start + 1))\r\n{\r\nlength = tvb_get_guint8 (tvb, pos++);\r\ntype = tvb_get_guint8 (tvb, pos++);\r\nswitch (type)\r\n{\r\ncase EVENT_DS_CH_ID:\r\nif (length == 3)\r\n{\r\nproto_tree_add_item (tlv_tree, hf_docsis_cmstatus_ds_ch_id, tvb, pos + 1, 1, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nTHROW (ReportedBoundsError);\r\n}\r\nbreak;\r\ncase EVENT_US_CH_ID:\r\nif (length == 3)\r\n{\r\nproto_tree_add_item (tlv_tree, hf_docsis_cmstatus_us_ch_id, tvb, pos + 1, 1, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nTHROW (ReportedBoundsError);\r\n}\r\nbreak;\r\ncase EVENT_DSID:\r\nif (length == 5)\r\n{\r\nproto_tree_add_item (tlv_tree, hf_docsis_cmstatus_dsid, tvb, pos + 1, 3, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nTHROW (ReportedBoundsError);\r\n}\r\nbreak;\r\ncase EVENT_DESCR:\r\nif (length >= 3 && length <= 82)\r\n{\r\nproto_tree_add_item (tlv_tree, hf_docsis_cmstatus_descr, tvb, pos + 1, length - 2, ENC_NA);\r\n}\r\nelse\r\n{\r\nTHROW (ReportedBoundsError);\r\n}\r\nbreak;\r\n}\r\npos = pos + length;\r\n}\r\n}\r\nstatic void\r\ndissect_cmstatus (tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree)\r\n{\r\nproto_item *it;\r\nproto_tree *cmstatus_tree = NULL;\r\nguint16 transid;\r\nguint8 event_type;\r\nguint16 len;\r\ntransid = tvb_get_ntohs (tvb, 0);\r\nevent_type = tvb_get_guint8 (tvb, 2);\r\nlen = tvb_reported_length_remaining (tvb, 3);\r\ncol_add_fstr (pinfo->cinfo, COL_INFO, "CM-STATUS Report: Transaction ID = %u", transid);\r\nif (tree)\r\n{\r\nit = proto_tree_add_protocol_format (tree, proto_docsis_cmstatus, tvb, 0, -1, "CM-STATUS Report");\r\ncmstatus_tree = proto_item_add_subtree (it, ett_docsis_cmstatus);\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_tranid, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nswitch (event_type)\r\n{\r\ncase SEC_CH_MDD_TIMEOUT:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_mdd_t, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase QAM_FEC_LOCK_FAILURE:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_qfl_f, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase SEQ_OUT_OF_RANGE:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_s_o, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase SEC_CH_MDD_RECOVERY:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_mdd_r, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase QAM_FEC_LOCK_RECOVERY:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_qfl_r, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase T4_TIMEOUT:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_t4_t, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase T3_RETRIES_EXCEEDED:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_t3_e, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase SUCCESS_RANGING_AFTER_T3_RETRIES_EXCEEDED:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_rng_s, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CM_ON_BATTERY:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_cm_b, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CM_ON_AC_POWER:\r\nproto_tree_add_item (cmstatus_tree, hf_docsis_cmstatus_e_t_cm_a, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\n}\r\ndissect_cmstatus_tlv(tvb, cmstatus_tree, 3, len);\r\n}\r\nvoid\r\nproto_register_docsis_cmstatus (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_docsis_cmstatus_tranid,\r\n{"Transaction ID", "docsis_cmstatus.tranid",FT_UINT16, BASE_DEC, NULL, 0x0,NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_mdd_t,\r\n{"Secondary Channel MDD timeout", "docsis_cmstatus.mdd_timeout", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_qfl_f,\r\n{"QAM/FEC lock failure", "docsis_cmstatus.qam_fec_lock_failure", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_s_o,\r\n{"Sequence out-of-range", "docsis_cmstatus.sequence_out_of_range", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_mdd_r,\r\n{"Secondary Channel MDD Recovery", "docsis_cmstatus.mdd_recovery", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_qfl_r,\r\n{"QAM/FEC Lock Recovery", "docsis_cmstatus.qam_fec_lock_recovery", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_t4_t,\r\n{"T4 timeout", "docsis_cmstatus.t4_timeout", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_t3_e,\r\n{"T3 retries exceeded", "docsis_cmstatus.t3_retries_exceeded", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_rng_s,\r\n{"Successful ranging after T3 retries exceeded", "docsis_cmstatus.successful_ranging_after_t3_retries_exceeded", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_cm_b,\r\n{"CM operating on battery backup", "docsis_cmstatus.cm_on_battery", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_e_t_cm_a,\r\n{"CM returned to A/C power", "docsis_cmstatus.cm_on_ac_power", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_docsis_cmstatus_descr,\r\n{"1.2 Description", "docsis_cmstatus.description",FT_BYTES, BASE_NONE, NULL, 0x0,"Description", HFILL}\r\n},\r\n{&hf_docsis_cmstatus_ds_ch_id,\r\n{"1.4 Downstream Channel ID", "docsis_cmstatus.ds_chid",FT_UINT8, BASE_DEC, NULL, 0x0, "Downstream Channel ID", HFILL}\r\n},\r\n{&hf_docsis_cmstatus_us_ch_id,\r\n{"1.5 Upstream Channel ID", "docsis_cmstatus.us_chid",FT_UINT8, BASE_DEC, NULL, 0x0, "Upstream Channel ID", HFILL}\r\n},\r\n{&hf_docsis_cmstatus_dsid,\r\n{"1.6 DSID", "docsis_cmstatus.dsid", FT_UINT24, BASE_DEC, NULL, 0x0, "DSID", HFILL}\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_docsis_cmstatus,\r\n&ett_docsis_cmstatus_tlv\r\n};\r\nproto_docsis_cmstatus = proto_register_protocol ("DOCSIS CM-STATUS Report", "DOCSIS CM-STATUS", "docsis_cmstatus");\r\nproto_register_field_array (proto_docsis_cmstatus, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\nregister_dissector ("docsis_cmstatus", dissect_cmstatus, proto_docsis_cmstatus);\r\n}\r\nvoid\r\nproto_reg_handoff_docsis_cmstatus (void)\r\n{\r\ndissector_handle_t docsis_cmstatus_handle;\r\ndocsis_cmstatus_handle = find_dissector ("docsis_cmstatus");\r\ndissector_add_uint ("docsis_mgmt", 0x29, docsis_cmstatus_handle);\r\n}

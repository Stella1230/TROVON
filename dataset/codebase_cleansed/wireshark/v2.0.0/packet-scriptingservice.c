static guint\r\ndissect_ssprotocol_message(tvbuff_t *message_tvb, packet_info *pinfo, proto_tree *ssprotocol_tree)\r\n{\r\nproto_item* flags_item;\r\nproto_tree* flags_tree;\r\nguint8 type;\r\nguint16 data_length;\r\nguint16 info_length;\r\nguint total_length;\r\ntype = tvb_get_guint8(message_tvb, MESSAGE_TYPE_OFFSET);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ", val_to_str(type, message_type_values, "Unknown SSP type: %u"));\r\nproto_tree_add_item(ssprotocol_tree, hf_message_type, message_tvb, MESSAGE_TYPE_OFFSET, MESSAGE_TYPE_LENGTH, ENC_BIG_ENDIAN);\r\nflags_item = proto_tree_add_item(ssprotocol_tree, hf_message_flags, message_tvb, MESSAGE_FLAGS_OFFSET, MESSAGE_FLAGS_LENGTH, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ssprotocol_tree, hf_message_length, message_tvb, MESSAGE_LENGTH_OFFSET, MESSAGE_LENGTH_LENGTH, ENC_BIG_ENDIAN);\r\ntotal_length = MESSAGE_LENGTH_OFFSET + MESSAGE_LENGTH_LENGTH;\r\nswitch (type) {\r\ncase SS_KEEPALIVE_ACK_TYPE:\r\ncase SS_STATUS_TYPE:\r\ninfo_length = tvb_get_ntohs(message_tvb, MESSAGE_LENGTH_OFFSET) - MESSAGE_STATUS_OFFSET;\r\nif (info_length == MESSAGE_STATUS_LENGTH) {\r\nproto_tree_add_item(ssprotocol_tree, hf_message_status, message_tvb, MESSAGE_STATUS_OFFSET, MESSAGE_STATUS_LENGTH, ENC_BIG_ENDIAN);\r\ntotal_length += MESSAGE_STATUS_LENGTH;\r\n}\r\nbreak;\r\ncase SS_UPLOAD_TYPE:\r\ncase SS_DOWNLOAD_TYPE:\r\ndata_length = tvb_get_ntohs(message_tvb, MESSAGE_LENGTH_OFFSET) - MESSAGE_DATA_OFFSET;\r\nif (data_length > 0) {\r\nproto_tree_add_item(ssprotocol_tree, hf_message_data, message_tvb, MESSAGE_DATA_OFFSET, data_length, ENC_NA);\r\ntotal_length += data_length;\r\n}\r\nbreak;\r\ncase SS_READY_TYPE:\r\ninfo_length = tvb_get_ntohs(message_tvb, MESSAGE_LENGTH_OFFSET) - MESSAGE_RDY_INFO_OFFSET;\r\nif (info_length > 0) {\r\nproto_tree_add_item(ssprotocol_tree, hf_message_info, message_tvb, MESSAGE_RDY_INFO_OFFSET, info_length, ENC_ASCII|ENC_NA);\r\ntotal_length += info_length;\r\n}\r\nbreak;\r\ncase SS_NOTREADY_TYPE:\r\ninfo_length = tvb_get_ntohs(message_tvb, MESSAGE_LENGTH_OFFSET) - MESSAGE_NOTRDY_INFO_OFFSET;\r\nif (info_length > 0) {\r\nproto_tree_add_item(ssprotocol_tree, hf_message_reason, message_tvb, MESSAGE_NOTRDY_REASON_OFFSET, MESSAGE_NOTRDY_REASON_LENGTH, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ssprotocol_tree, hf_message_info, message_tvb, MESSAGE_NOTRDY_INFO_OFFSET, info_length, ENC_ASCII|ENC_NA);\r\ntotal_length += info_length;\r\n}\r\nbreak;\r\ncase SS_ENVIRONMENT_TYPE:\r\nflags_tree = proto_item_add_subtree(flags_item, ett_environment_flags);\r\nproto_tree_add_item(flags_tree, hf_environment_u_bit, message_tvb, MESSAGE_FLAGS_OFFSET, MESSAGE_FLAGS_LENGTH, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ssprotocol_tree, hf_message_hash, message_tvb, MESSAGE_ENVIRON_HASH_OFFSET, MESSAGE_ENVIRON_HASH_LENGTH, ENC_NA);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn total_length;\r\n}\r\nstatic int\r\ndissect_ssprotocol(tvbuff_t *message_tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ssprotocol_item;\r\nproto_tree *ssprotocol_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SSP");\r\nssprotocol_item = proto_tree_add_item(tree, proto_ssprotocol, message_tvb, 0, -1, ENC_NA);\r\nssprotocol_tree = proto_item_add_subtree(ssprotocol_item, ett_ssprotocol);\r\nreturn dissect_ssprotocol_message(message_tvb, pinfo, ssprotocol_tree);\r\n}\r\nvoid\r\nproto_register_ssprotocol(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_message_type, { "Type", "ssp.message_type", FT_UINT8, BASE_DEC, VALS(message_type_values), 0x0, NULL, HFILL } },\r\n{ &hf_message_flags, { "Flags", "ssp.message_flags", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_message_length, { "Length", "ssp.message_length", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_message_status, { "Status", "ssp.message_status", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_message_reason, { "Reason", "ssp.message_reason", FT_UINT32, BASE_DEC, VALS(notrdy_reason_values), 0x0, NULL, HFILL } },\r\n{ &hf_message_info, { "Info", "ssp.message_info", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_message_data, { "Data", "ssp.message_data", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_message_hash, { "Hash", "ssp.message_hash", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_environment_u_bit, { "U-Bit", "ssp.environment_u_bit", FT_BOOLEAN, 8,TFS(&environment_u_bit), SSP_ENVIRONMENT_U_BIT, NULL, HFILL } }\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ssprotocol,\r\n&ett_environment_flags\r\n};\r\nproto_ssprotocol = proto_register_protocol("Scripting Service Protocol", "SSP", "ssp");\r\nproto_register_field_array(proto_ssprotocol, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_ssprotocol(void)\r\n{\r\ndissector_handle_t ssprotocol_handle;\r\nssprotocol_handle = new_create_dissector_handle(dissect_ssprotocol, proto_ssprotocol);\r\ndissector_add_uint("sctp.ppi", SSPROTOCOL_PAYLOAD_PROTOCOL_ID_LEGACY, ssprotocol_handle);\r\ndissector_add_uint("sctp.ppi", SSP_PAYLOAD_PROTOCOL_ID, ssprotocol_handle);\r\n}

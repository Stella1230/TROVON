void\r\nwpcap_packet_load(void)\r\n{\r\nstatic const symbol_table_t symbols[] = {\r\nSYM(PacketGetVersion, FALSE),\r\nSYM(PacketOpenAdapter, FALSE),\r\nSYM(PacketCloseAdapter, FALSE),\r\nSYM(PacketRequest, FALSE),\r\n{ NULL, NULL, FALSE }\r\n};\r\nGModule *wh;\r\nconst symbol_table_t *sym;\r\nwh = ws_module_open("packet.dll", 0);\r\nif (!wh) {\r\nreturn;\r\n}\r\nsym = symbols;\r\nwhile (sym->name) {\r\nif (!g_module_symbol(wh, sym->name, sym->ptr)) {\r\nif (sym->optional) {\r\n*sym->ptr = NULL;\r\n} else {\r\nreturn;\r\n}\r\n}\r\nsym++;\r\n}\r\nhas_wpacket = TRUE;\r\n}\r\nchar *\r\nwpcap_packet_get_version(void)\r\n{\r\nif(!has_wpacket) {\r\nreturn NULL;\r\n}\r\nreturn p_PacketGetVersion();\r\n}\r\nvoid *\r\nwpcap_packet_open(char *if_name)\r\n{\r\nLPADAPTER adapter;\r\ng_assert(has_wpacket);\r\nadapter = p_PacketOpenAdapter(if_name);\r\nreturn adapter;\r\n}\r\nvoid\r\nwpcap_packet_close(void *adapter)\r\n{\r\ng_assert(has_wpacket);\r\np_PacketCloseAdapter(adapter);\r\n}\r\nint\r\nwpcap_packet_request(void *adapter, ULONG Oid, int set, char *value, unsigned int *length)\r\n{\r\nBOOLEAN Status;\r\nULONG IoCtlBufferLength=(sizeof(PACKET_OID_DATA) + (*length) - 1);\r\nPPACKET_OID_DATA OidData;\r\ng_assert(has_wpacket);\r\nif(p_PacketRequest == NULL) {\r\ng_warning("packet_request not available\n");\r\nreturn 0;\r\n}\r\nOidData=GlobalAllocPtr(GMEM_MOVEABLE | GMEM_ZEROINIT,IoCtlBufferLength);\r\nif (OidData == NULL) {\r\ng_warning("GlobalAllocPtr failed for %u\n", IoCtlBufferLength);\r\nreturn 0;\r\n}\r\nOidData->Oid = Oid;\r\nOidData->Length = *length;\r\nmemcpy(OidData->Data, value, *length);\r\nStatus = p_PacketRequest(adapter, set, OidData);\r\nif(Status) {\r\nif(OidData->Length <= *length) {\r\nmemcpy(value, OidData->Data, OidData->Length);\r\n*length = OidData->Length;\r\n} else {\r\ng_warning("returned oid too long, Oid: 0x%x OidLen:%u MaxLen:%u", Oid, OidData->Length, *length);\r\nStatus = FALSE;\r\n}\r\n}\r\nGlobalFreePtr (OidData);\r\nif(Status) {\r\nreturn 1;\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\nint\r\nwpcap_packet_request_uint(void *adapter, ULONG Oid, UINT *value)\r\n{\r\nBOOLEAN Status;\r\nint length = sizeof(UINT);\r\nStatus = wpcap_packet_request(adapter, Oid, FALSE , (char *) value, &length);\r\nif(Status && length == sizeof(UINT)) {\r\nreturn 1;\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\nint\r\nwpcap_packet_request_ulong(void *adapter, ULONG Oid, ULONG *value)\r\n{\r\nBOOLEAN Status;\r\nint length = sizeof(ULONG);\r\nStatus = wpcap_packet_request(adapter, Oid, FALSE , (char *) value, &length);\r\nif(Status && length == sizeof(ULONG)) {\r\nreturn 1;\r\n} else {\r\nreturn 0;\r\n}\r\n}\r\nvoid\r\nwpcap_packet_load(void)\r\n{\r\nreturn;\r\n}

static gboolean\r\ncapture_ieee8021ah(const guchar *pd, int offset, int len, capture_packet_info_t *cpinfo, const union wtap_pseudo_header *pseudo_header _U_)\r\n{\r\nguint16 encap_proto;\r\nif (!BYTES_ARE_IN_FRAME(offset, len, IEEE8021AH_LEN + 1))\r\nreturn FALSE;\r\nencap_proto = pntoh16( &pd[offset + IEEE8021AH_LEN - 2] );\r\nif (encap_proto <= IEEE_802_3_MAX_LEN) {\r\nif ( pd[offset + IEEE8021AH_LEN] == 0xff\r\n&& pd[offset + IEEE8021AH_LEN + 1] == 0xff ) {\r\nreturn capture_ipx(pd, offset + IEEE8021AH_LEN, len, cpinfo, pseudo_header);\r\n}\r\nelse {\r\nreturn capture_llc(pd, offset + IEEE8021AH_LEN, len, cpinfo, pseudo_header);\r\n}\r\n}\r\nreturn try_capture_dissector("ethertype", encap_proto, pd, offset + IEEE8021AH_LEN, len, cpinfo, pseudo_header);\r\n}\r\nstatic\r\nint dissect_ieee8021ad(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *ptree = NULL;\r\nproto_tree *tagtree = NULL;\r\nguint32 tci, ctci;\r\nguint16 encap_proto;\r\nint proto_tree_index;\r\nethertype_data_t ethertype_data;\r\ntvbuff_t *next_tvb = NULL;\r\nproto_tree *ieee8021ad_tree;\r\nproto_tree *ieee8021ad_tag_tree;\r\nproto_tree_index = proto_ieee8021ad;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "802.1ad");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntci = tvb_get_ntohs( tvb, 0 );\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"PRI: %d DROP: %d ID: %d",\r\n(tci >> 13), ((tci >> 12) & 1), (tci & 0xFFF));\r\nptree = proto_tree_add_item(tree, proto_tree_index, tvb, 0, IEEE8021AD_LEN, ENC_NA);\r\nieee8021ad_tree = proto_item_add_subtree(ptree, ett_ieee8021ad);\r\nencap_proto = tvb_get_ntohs(tvb, IEEE8021AD_LEN - 2);\r\nethertype_data.fh_tree = ieee8021ad_tree;\r\nethertype_data.etype_id = hf_ieee8021ah_etype;\r\nethertype_data.trailer_id = hf_ieee8021ah_trailer;\r\nethertype_data.fcs_len = 0;\r\nif (encap_proto == ETHERTYPE_IEEE_802_1AH) {\r\nif (tree) {\r\ntagtree = proto_tree_add_item(ptree, proto_tree_index, tvb, 0, 2, ENC_NA);\r\nieee8021ad_tag_tree = proto_item_add_subtree(tagtree, ett_ieee8021ad);\r\nproto_tree_add_uint(ieee8021ad_tag_tree, hf_ieee8021ad_priority, tvb,\r\n0, 1, tci);\r\nproto_tree_add_uint(ieee8021ad_tag_tree, hf_ieee8021ad_cfi, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ad_tag_tree, hf_ieee8021ad_id, tvb, 0, 2, tci);\r\nproto_item_set_text(ieee8021ad_tag_tree, "B-Tag, B-VID: %d", tci & 0x0FFF);\r\n}\r\nnext_tvb = tvb_new_subset_remaining(tvb, IEEE8021AD_LEN);\r\nif (ptree) {\r\nproto_item_set_text(ptree, "IEEE 802.1ah, B-VID: %d", tci & 0x0FFF);\r\ndissect_ieee8021ah_common(next_tvb, pinfo, ptree, tree, proto_tree_index);\r\n}\r\nelse {\r\ndissect_ieee8021ah_common(next_tvb, pinfo, tree, NULL, proto_tree_index);\r\n}\r\n} else if (encap_proto == ETHERTYPE_IEEE_802_1AD) {\r\nctci = tvb_get_ntohs(tvb, IEEE8021AD_LEN);\r\nif (tree) {\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_priority, tvb,\r\n0, 1, tci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_cfi, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_svid, tvb, 0, 2, tci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_priority, tvb,\r\nIEEE8021AD_LEN, 1, ctci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_cfi, tvb,\r\nIEEE8021AD_LEN, 1, ctci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_cvid, tvb, IEEE8021AD_LEN,\r\n2, ctci);\r\n}\r\nproto_item_set_text(ptree, "IEEE 802.1ad, S-VID: %d, C-VID: %d", tci & 0x0FFF,\r\nctci & 0x0FFF);\r\nethertype_data.etype = tvb_get_ntohs(tvb, IEEE8021AD_LEN * 2 - 2);\r\nethertype_data.offset_after_ethertype = IEEE8021AD_LEN * 2;\r\ncall_dissector_with_data(ethertype_handle, tvb, pinfo, tree, &ethertype_data);\r\n} else {\r\nif (tree) {\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_priority, tvb,\r\n0, 1, tci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_cfi, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ad_tree, hf_ieee8021ad_id, tvb, 0, 2, tci);\r\n}\r\nproto_item_set_text(ptree, "IEEE 802.1ad, ID: %d", tci & 0x0FFF);\r\nethertype_data.etype = encap_proto;\r\nethertype_data.offset_after_ethertype = IEEE8021AD_LEN;\r\ncall_dissector_with_data(ethertype_handle, tvb, pinfo, tree, &ethertype_data);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\ndissect_ieee8021ah_common(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, proto_tree *parent, int tree_index) {\r\nguint32 tci;\r\nguint16 encap_proto;\r\nproto_tree *ptree;\r\nethertype_data_t ethertype_data;\r\nproto_tree *ieee8021ah_tag_tree;\r\ntci = tvb_get_ntohl( tvb, 0 );\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"PRI: %d Drop: %d NCA: %d Res1: %d Res2: %d I-SID: %d",\r\n(tci >> 29), ((tci >> 28) & 1), ((tci >> 27) & 1),\r\n((tci >> 26) & 1), ((tci >> 24) & 3), tci & IEEE8021AH_ISIDMASK);\r\nptree = NULL;\r\nieee8021ah_tag_tree = NULL;\r\nif (tree) {\r\nptree = proto_tree_add_item(tree, tree_index, tvb, 0, 4, ENC_NA);\r\nieee8021ah_tag_tree = proto_item_add_subtree(ptree, ett_ieee8021ah);\r\nproto_tree_add_uint(ieee8021ah_tag_tree, hf_ieee8021ah_priority, tvb,\r\n0, 1, tci);\r\nproto_tree_add_uint(ieee8021ah_tag_tree, hf_ieee8021ah_drop, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ah_tag_tree, hf_ieee8021ah_nca, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ah_tag_tree, hf_ieee8021ah_res1, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ah_tag_tree, hf_ieee8021ah_res2, tvb, 0, 1, tci);\r\nproto_tree_add_uint(ieee8021ah_tag_tree, hf_ieee8021ah_isid, tvb, 1, 3, tci);\r\nproto_item_set_text(ieee8021ah_tag_tree, "I-Tag, I-SID: %d",\r\ntci & IEEE8021AH_ISIDMASK);\r\nproto_tree_add_item(tree, hf_ieee8021ah_c_daddr, tvb, 4, 6, ENC_NA);\r\nproto_tree_add_item(tree, hf_ieee8021ah_c_saddr, tvb, 10, 6, ENC_NA);\r\nif (parent) {\r\nproto_item_append_text(tree, ", I-SID: %d, C-Src: %s, C-Dst: %s",\r\ntci & IEEE8021AH_ISIDMASK,\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 10),\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 4));\r\n}\r\n}\r\nencap_proto = tvb_get_ntohs(tvb, IEEE8021AH_LEN - 2);\r\nethertype_data.etype = encap_proto;\r\nethertype_data.fh_tree = tree;\r\nethertype_data.offset_after_ethertype = IEEE8021AH_LEN;\r\nethertype_data.etype_id = hf_ieee8021ah_etype;\r\nethertype_data.trailer_id = hf_ieee8021ah_trailer;\r\nethertype_data.fcs_len = 0;\r\nif (parent) {\r\ncall_dissector_with_data(ethertype_handle, tvb, pinfo, parent, &ethertype_data);\r\n}\r\nelse {\r\ncall_dissector_with_data(ethertype_handle, tvb, pinfo, tree, &ethertype_data);\r\n}\r\n}\r\nstatic\r\nint dissect_ieee8021ah(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nproto_item *pi;\r\nguint32 tci;\r\nint proto_tree_index;\r\nproto_tree *ieee8021ah_tree;\r\nproto_tree_index = proto_ieee8021ah;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "802.1ah");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntci = tvb_get_ntohl( tvb, 0 );\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"PRI: %d Drop: %d NCA: %d Res1: %d Res2: %d I-SID: %d",\r\n(tci >> 29), ((tci >> 28) & 1), ((tci >> 27) & 1),\r\n((tci >> 26) & 1), ((tci >> 24) & 3), (tci & 0x00FFFFFF));\r\npi = proto_tree_add_item(tree, proto_tree_index, tvb, 0, IEEE8021AH_LEN, ENC_NA);\r\nieee8021ah_tree = proto_item_add_subtree(pi, ett_ieee8021ah);\r\nif (ieee8021ah_tree) {\r\ndissect_ieee8021ah_common(tvb, pinfo, ieee8021ah_tree, tree, proto_tree_index);\r\n} else {\r\ndissect_ieee8021ah_common(tvb, pinfo, tree, NULL, proto_tree_index);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ieee8021ah(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ieee8021ah_priority, {\r\n"Priority", "ieee8021ah.priority", FT_UINT32, BASE_DEC,\r\n0, 0xE0000000, NULL, HFILL }},\r\n{ &hf_ieee8021ah_drop, {\r\n"DROP", "ieee8021ah.drop", FT_UINT32, BASE_DEC,\r\n0, 0x10000000, NULL, HFILL }},\r\n{ &hf_ieee8021ah_nca, {\r\n"NCA", "ieee8021ah.nca", FT_UINT32, BASE_DEC,\r\n0, 0x08000000, "No Customer Addresses", HFILL }},\r\n{ &hf_ieee8021ah_res1, {\r\n"RES1", "ieee8021ah.res1", FT_UINT32, BASE_DEC,\r\n0, 0x04000000, "Reserved1", HFILL }},\r\n{ &hf_ieee8021ah_res2, {\r\n"RES2", "ieee8021ah.res2", FT_UINT32, BASE_DEC,\r\n0, 0x03000000, "Reserved2", HFILL }},\r\n{ &hf_ieee8021ah_isid, {\r\n"I-SID", "ieee8021ah.isid", FT_UINT32, BASE_DEC,\r\n0, 0x00FFFFFF, NULL, HFILL }},\r\n{ &hf_ieee8021ah_c_daddr, {\r\n"C-Destination", "ieee8021ah.cdst", FT_ETHER, BASE_NONE,\r\nNULL, 0x0, "Customer Destination Address", HFILL }},\r\n{ &hf_ieee8021ah_c_saddr, {\r\n"C-Source", "ieee8021ah.csrc", FT_ETHER, BASE_NONE,\r\nNULL, 0x0, "Customer Source Address", HFILL }},\r\n{ &hf_ieee8021ah_etype, {\r\n"Type", "ieee8021ah.etype", FT_UINT16, BASE_HEX,\r\nVALS(etype_vals), 0x0, NULL, HFILL }},\r\n#if 0\r\n{ &hf_ieee8021ah_len, {\r\n"Length", "ieee8021ah.len", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n#endif\r\n{ &hf_ieee8021ah_trailer, {\r\n"Trailer", "ieee8021ah.trailer", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, "802.1ah Trailer", HFILL }}\r\n};\r\nstatic hf_register_info hf_1ad[] = {\r\n{ &hf_ieee8021ad_priority, {\r\n"Priority", "ieee8021ad.priority", FT_UINT16, BASE_DEC,\r\n0, 0xE000, NULL, HFILL }},\r\n{ &hf_ieee8021ad_cfi, {\r\n"DEI", "ieee8021ad.dei", FT_UINT16, BASE_DEC,\r\n0, 0x1000, "Drop Eligibility", HFILL }},\r\n{ &hf_ieee8021ad_id, {\r\n"ID", "ieee8021ad.id", FT_UINT16, BASE_DEC,\r\n0, 0x0FFF, "Vlan ID", HFILL }},\r\n{ &hf_ieee8021ad_svid, {\r\n"ID", "ieee8021ad.svid", FT_UINT16, BASE_DEC,\r\n0, 0x0FFF, "S-Vlan ID", HFILL }},\r\n{ &hf_ieee8021ad_cvid, {\r\n"ID", "ieee8021ad.cvid", FT_UINT16, BASE_DEC,\r\n0, 0x0FFF, "C-Vlan ID", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ieee8021ah,\r\n&ett_ieee8021ad\r\n};\r\nmodule_t *ieee8021ah_module;\r\nproto_ieee8021ah = proto_register_protocol("IEEE 802.1ah", "IEEE 802.1AH",\r\n"ieee8021ah");\r\nproto_register_field_array(proto_ieee8021ah, hf, array_length(hf));\r\nproto_ieee8021ad = proto_register_protocol("IEEE 802.1ad", "IEEE 802.1AD",\r\n"ieee8021ad");\r\nproto_register_field_array(proto_ieee8021ad, hf_1ad, array_length(hf_1ad));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nieee8021ah_module = prefs_register_protocol(proto_ieee8021ah,\r\nproto_reg_handoff_ieee8021ah);\r\nprefs_register_uint_preference(ieee8021ah_module, "8021ah_ethertype",\r\n"802.1ah Ethertype (in hex)",\r\n"(Hexadecimal) Ethertype used to indicate IEEE 802.1ah tag.",\r\n16, &ieee8021ah_ethertype);\r\n}\r\nvoid\r\nproto_reg_handoff_ieee8021ah(void)\r\n{\r\nstatic gboolean prefs_initialized = FALSE;\r\nstatic dissector_handle_t ieee8021ah_handle;\r\nstatic unsigned int old_ieee8021ah_ethertype;\r\nif (!prefs_initialized){\r\ndissector_handle_t ieee8021ad_handle;\r\nieee8021ah_handle = create_dissector_handle(dissect_ieee8021ah,\r\nproto_ieee8021ah);\r\nieee8021ad_handle = create_dissector_handle(dissect_ieee8021ad,\r\nproto_ieee8021ad);\r\ndissector_add_uint("ethertype", ETHERTYPE_IEEE_802_1AD, ieee8021ad_handle);\r\nethertype_handle = find_dissector_add_dependency("ethertype", proto_ieee8021ah);\r\nfind_dissector_add_dependency("ethertype", proto_ieee8021ad);\r\nregister_capture_dissector("ethertype", ETHERTYPE_IEEE_802_1AD, capture_ieee8021ah, proto_ieee8021ah);\r\nregister_capture_dissector("ethertype", ETHERTYPE_IEEE_802_1AH, capture_ieee8021ah, proto_ieee8021ah);\r\nprefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("ethertype", old_ieee8021ah_ethertype, ieee8021ah_handle);\r\n}\r\nold_ieee8021ah_ethertype = ieee8021ah_ethertype;\r\ndissector_add_uint("ethertype", ieee8021ah_ethertype, ieee8021ah_handle);\r\n}

static void\r\ndissect_msrp_common1(proto_tree *msg_tree, tvbuff_t *tvb, int msg_offset)\r\n{\r\nproto_tree_add_item(msg_tree, hf_msrp_attribute_type, tvb,\r\nMSRP_ATTRIBUTE_TYPE_OFFSET + msg_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(msg_tree, hf_msrp_attribute_length, tvb,\r\nMSRP_ATTRIBUTE_LENGTH_OFFSET + msg_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(msg_tree, hf_msrp_attribute_list_length, tvb,\r\nMSRP_ATTRIBUTE_LIST_LENGTH_OFFSET + msg_offset, 2, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_msrp_common2(proto_tree *vect_attr_tree, tvbuff_t *tvb, int msg_offset)\r\n{\r\nproto_tree_add_bitmask(vect_attr_tree, tvb, MSRP_VECTOR_HEADER_OFFSET + msg_offset,\r\nhf_msrp_vector_header, ett_vector_header, vector_header_fields, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_msrp_talker_common(proto_tree *first_value_tree, tvbuff_t *tvb, int msg_offset)\r\n{\r\nproto_tree_add_item(first_value_tree, hf_msrp_stream_da, tvb,\r\nMSRP_STREAM_DA_OFFSET + msg_offset, 6, ENC_NA);\r\nproto_tree_add_item(first_value_tree, hf_msrp_vlan_id, tvb,\r\nMSRP_VLAN_ID_OFFSET + msg_offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(first_value_tree, hf_msrp_tspec_max_frame_size, tvb,\r\nMSRP_TSPEC_MAX_FRAME_SIZE_OFFSET + msg_offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(first_value_tree, hf_msrp_tspec_max_interval_frames, tvb,\r\nMSRP_TSPEC_MAX_INTERVAL_FRAMES_OFFSET + msg_offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_bitmask(first_value_tree, tvb, MSRP_PRIORITY_AND_RANK_OFFSET + msg_offset,\r\nhf_msrp_priority_and_rank, ett_priority_and_rank, priority_and_rank_fields, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(first_value_tree, hf_msrp_accumulated_latency, tvb,\r\nMSRP_ACCUMULATED_LATENCY_OFFSET + msg_offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_msrp_talker_failed(proto_tree *first_value_tree, tvbuff_t *tvb, int msg_offset)\r\n{\r\nproto_tree_add_item(first_value_tree, hf_msrp_failure_bridge_id, tvb,\r\nMSRP_FAILURE_BRIDGE_ID_OFFSET + msg_offset, 8, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(first_value_tree, hf_msrp_failure_code, tvb,\r\nMSRP_FAILURE_CODE_OFFSET + msg_offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic guint\r\ndissect_msrp_three_packed_event(proto_tree *vect_attr_tree, tvbuff_t *tvb, guint offset, guint16 number_of_values)\r\n{\r\nguint counter;\r\nfor ( counter = 0; counter < number_of_values; ) {\r\nguint8 value;\r\nguint8 three_packed_event[3];\r\nvalue = tvb_get_guint8(tvb, offset);\r\nthree_packed_event[0] = value / 36;\r\nvalue -= 36 * three_packed_event[0];\r\nthree_packed_event[1] = value / 6;\r\nvalue -= 6 * three_packed_event[1];\r\nthree_packed_event[2] = value;\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_three_packed_event, tvb, offset, sizeof(guint8),\r\nthree_packed_event[0]);\r\ncounter++;\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_three_packed_event, tvb, offset, sizeof(guint8),\r\nthree_packed_event[1]);\r\ncounter++;\r\n}\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_three_packed_event, tvb, offset, sizeof(guint8),\r\nthree_packed_event[2]);\r\ncounter++;\r\n}\r\noffset++;\r\n}\r\nreturn( offset );\r\n}\r\nstatic guint\r\ndissect_msrp_four_packed_event(proto_tree *vect_attr_tree, tvbuff_t *tvb, guint offset, guint16 number_of_values)\r\n{\r\nguint counter;\r\nfor ( counter = 0; counter < number_of_values; ) {\r\nguint8 value;\r\nguint8 four_packed_event[4];\r\nvalue = tvb_get_guint8(tvb, offset);\r\nfour_packed_event[0] = (value & 0xc0) >> 6;\r\nfour_packed_event[1] = (value & 0x30) >> 4;\r\nfour_packed_event[2] = (value & 0x0c) >> 2;\r\nfour_packed_event[3] = (value & 0x03);\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_four_packed_event, tvb, offset, sizeof(guint8),\r\nfour_packed_event[0]);\r\ncounter++;\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_four_packed_event, tvb, offset, sizeof(guint8),\r\nfour_packed_event[1]);\r\ncounter++;\r\n}\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_four_packed_event, tvb, offset, sizeof(guint8),\r\nfour_packed_event[2]);\r\ncounter++;\r\n}\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_msrp_four_packed_event, tvb, offset, sizeof(guint8),\r\nfour_packed_event[3]);\r\ncounter++;\r\n}\r\noffset++;\r\n}\r\nreturn( offset );\r\n}\r\nstatic int\r\ndissect_msrp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti, *msg_ti, *attr_list_ti, *vect_attr_ti, *first_value_ti;\r\nproto_tree *msrp_tree, *msg_tree, *attr_list_tree, *vect_attr_tree, *first_value_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MRP-MSRP");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Multiple Stream Reservation Protocol");\r\nif (tree) {\r\nguint8 attribute_type;\r\nguint8 attribute_length;\r\nguint16 number_of_values;\r\nguint16 attribute_list_length;\r\nguint offset = 0;\r\nint vect_attr_len;\r\nint msg_length;\r\nint msg_offset;\r\nint vect_offset;\r\nti = proto_tree_add_item(tree, proto_msrp, tvb, 0, -1, ENC_NA);\r\nmsrp_tree = proto_item_add_subtree(ti, ett_msrp);\r\nproto_tree_add_item(msrp_tree, hf_msrp_proto_id, tvb, MSRP_PROTOCOL_VERSION_OFFSET, 1, ENC_BIG_ENDIAN);\r\nmsg_offset = 0;\r\nwhile (tvb_get_ntohs(tvb, MSRP_ATTRIBUTE_TYPE_OFFSET + msg_offset) != MSRP_END_MARK) {\r\nattribute_type = tvb_get_guint8(tvb, MSRP_ATTRIBUTE_TYPE_OFFSET + msg_offset);\r\nattribute_length = tvb_get_guint8(tvb, MSRP_ATTRIBUTE_LENGTH_OFFSET + msg_offset);\r\nattribute_list_length = tvb_get_ntohs(tvb, MSRP_ATTRIBUTE_LIST_LENGTH_OFFSET + msg_offset);\r\nmsg_length = 1 + 1 + 2 + attribute_list_length;\r\nmsg_ti = proto_tree_add_item(msrp_tree, hf_msrp_message, tvb,\r\nMSRP_MESSAGE_GROUP_OFFSET + msg_offset,\r\nmsg_length, ENC_NA);\r\nmsg_tree = proto_item_add_subtree(msg_ti, ett_msg);\r\nproto_item_append_text(msg_tree, ": %s (%d)",\r\nval_to_str_const(attribute_type, attribute_type_vals, "<Unknown>"),\r\nattribute_type);\r\ndissect_msrp_common1(msg_tree, tvb, msg_offset);\r\nattr_list_ti = proto_tree_add_item(msg_tree, hf_msrp_attribute_list, tvb,\r\nMSRP_ATTRIBUTE_LIST_GROUP_OFFSET + msg_offset,\r\nattribute_list_length, ENC_NA);\r\nattr_list_tree = proto_item_add_subtree(attr_list_ti, ett_attr_list);\r\nvect_offset = 0;\r\nwhile (tvb_get_ntohs(tvb, MSRP_VECTOR_HEADER_OFFSET + msg_offset + vect_offset) != MSRP_END_MARK) {\r\nnumber_of_values = tvb_get_ntohs(tvb, MSRP_NUMBER_OF_VALUES_OFFSET + msg_offset + vect_offset)\r\n& MSRP_NUMBER_OF_VALUES_MASK;\r\nvect_attr_len = 2 + attribute_length + (number_of_values + 2)/3;\r\nif (attribute_type == MSRP_ATTRIBUTE_TYPE_LISTENER)\r\nvect_attr_len += (number_of_values + 3)/4;\r\nvect_attr_ti = proto_tree_add_item(attr_list_tree, hf_msrp_vector_attribute, tvb,\r\nMSRP_VECTOR_ATTRIBUTE_GROUP_OFFSET + msg_offset + vect_offset,\r\nvect_attr_len, ENC_NA);\r\nvect_attr_tree = proto_item_add_subtree(vect_attr_ti, ett_vect_attr);\r\ndissect_msrp_common2(vect_attr_tree, tvb, msg_offset + vect_offset);\r\nif(attribute_type == MSRP_ATTRIBUTE_TYPE_DOMAIN) {\r\nfirst_value_ti = proto_tree_add_item(vect_attr_tree, hf_msrp_first_value, tvb,\r\nMSRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset,\r\nattribute_length, ENC_NA);\r\nfirst_value_tree = proto_item_add_subtree(first_value_ti, ett_first_value);\r\nproto_tree_add_item(first_value_tree, hf_msrp_sr_class_id, tvb,\r\nMSRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(first_value_tree, hf_msrp_sr_class_priority, tvb,\r\nMSRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset + 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(first_value_tree, hf_msrp_sr_class_vid, tvb,\r\nMSRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset + 2, 2, ENC_BIG_ENDIAN);\r\noffset = dissect_msrp_three_packed_event(vect_attr_tree, tvb,\r\nMSRP_DOMAIN_THREE_PACKED_OFFSET + msg_offset + vect_offset,\r\nnumber_of_values);\r\n}\r\nelse {\r\nfirst_value_ti = proto_tree_add_item(vect_attr_tree, hf_msrp_first_value, tvb,\r\nMSRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset,\r\nattribute_length, ENC_NA);\r\nfirst_value_tree = proto_item_add_subtree(first_value_ti, ett_first_value);\r\nproto_tree_add_item(first_value_tree, hf_msrp_stream_id, tvb,\r\nMSRP_STREAM_ID_OFFSET + msg_offset + vect_offset, 8, ENC_BIG_ENDIAN);\r\nswitch ( attribute_type ) {\r\ncase MSRP_ATTRIBUTE_TYPE_LISTENER:\r\noffset = dissect_msrp_three_packed_event(vect_attr_tree, tvb,\r\nMSRP_LISTENER_THREE_PACKED_OFFSET + msg_offset + vect_offset,\r\nnumber_of_values);\r\noffset = dissect_msrp_four_packed_event(vect_attr_tree, tvb, offset, number_of_values);\r\nbreak;\r\ncase MSRP_ATTRIBUTE_TYPE_TALKER_ADVERTISE:\r\ndissect_msrp_talker_common(first_value_tree, tvb, msg_offset + vect_offset);\r\noffset = dissect_msrp_three_packed_event(vect_attr_tree, tvb,\r\nMSRP_TALKER_ADVERTISE_THREE_PACKED_OFFSET + msg_offset + vect_offset,\r\nnumber_of_values);\r\nbreak;\r\ncase MSRP_ATTRIBUTE_TYPE_TALKER_FAILED:\r\ndissect_msrp_talker_common(first_value_tree, tvb, msg_offset + vect_offset);\r\ndissect_msrp_talker_failed(first_value_tree, tvb, msg_offset + vect_offset);\r\noffset = dissect_msrp_three_packed_event(vect_attr_tree, tvb,\r\nMSRP_TALKER_FAILED_THREE_PACKED_OFFSET + msg_offset + vect_offset,\r\nnumber_of_values);\r\nbreak;\r\ndefault:\r\nproto_tree_add_expert(first_value_tree, pinfo, &ei_msrp_attribute_type, tvb, msg_offset + vect_offset, vect_attr_len);\r\nbreak;\r\n}\r\n}\r\nvect_offset += vect_attr_len;\r\n}\r\nproto_tree_add_item(attr_list_tree, hf_msrp_end_mark, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nmsg_offset += msg_length;\r\n}\r\nproto_tree_add_item(msrp_tree, hf_msrp_end_mark, tvb, offset+2, 2, ENC_BIG_ENDIAN);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_mrp_msrp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_msrp_proto_id,\r\n{ "Protocol Version", "mrp-msrp.protocol_version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_message,\r\n{ "Message", "mrp-msrp.message",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_attribute_type,\r\n{ "Attribute Type", "mrp-msrp.attribute_type",\r\nFT_UINT8, BASE_DEC, VALS(attribute_type_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_attribute_length,\r\n{ "Attribute Length", "mrp-msrp.attribute_length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_attribute_list_length,\r\n{ "Attribute List Length", "mrp-msrp.attribute_list_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_attribute_list,\r\n{ "Attribute List", "mrp-msrp.attribute_list",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_vector_attribute,\r\n{ "Vector Attribute", "mrp-msrp.vector_attribute",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_vector_header,\r\n{ "Vector Header", "mrp-msrp.vector_header",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_leave_all_event,\r\n{ "Leave All Event", "mrp-msrp.leave_all_event",\r\nFT_UINT16, BASE_DEC, VALS(leave_all_vals), MSRP_LEAVE_ALL_EVENT_MASK, NULL, HFILL }\r\n},\r\n{ &hf_msrp_number_of_values,\r\n{ "Number of Values", "mrp-msrp.number_of_values",\r\nFT_UINT16, BASE_DEC, NULL, MSRP_NUMBER_OF_VALUES_MASK, NULL, HFILL }\r\n},\r\n{ &hf_msrp_first_value,\r\n{ "First Value", "mrp-msrp.first_value",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_stream_id,\r\n{ "Stream ID", "mrp-msrp.stream_id",\r\nFT_UINT64, BASE_HEX, NULL, 0x00, NULL, HFILL }\r\n},\r\n{ &hf_msrp_stream_da,\r\n{ "Stream DA", "mrp-msrp.stream_da",\r\nFT_ETHER, BASE_NONE, NULL, 0x00, NULL, HFILL }\r\n},\r\n{ &hf_msrp_vlan_id,\r\n{ "VLAN ID", "mrp-msrp.vlan_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x00, NULL, HFILL }\r\n},\r\n{ &hf_msrp_tspec_max_frame_size,\r\n{ "TSpec Max Frame Size", "mrp-msrp.tspec_max_frame_size",\r\nFT_UINT16, BASE_DEC, NULL, 0x00, NULL, HFILL }\r\n},\r\n{ &hf_msrp_tspec_max_interval_frames,\r\n{ "TSpec Max Frame Interval", "mrp-msrp.tspec_max_interval_frames",\r\nFT_UINT16, BASE_DEC, NULL, 0x00, NULL, HFILL }\r\n},\r\n{ &hf_msrp_priority_and_rank,\r\n{ "Priority and Rank", "mrp-msrp.priority_and_rank",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_priority,\r\n{ "Priority", "mrp-msrp.priority",\r\nFT_UINT8, BASE_DEC, VALS(priority_vals), MSRP_PRIORITY_MASK, NULL, HFILL }\r\n},\r\n{ &hf_msrp_rank,\r\n{ "Rank", "mrp-msrp.rank",\r\nFT_UINT8, BASE_DEC, VALS(rank_vals), MSRP_RANK_MASK, NULL, HFILL }\r\n},\r\n{ &hf_msrp_reserved,\r\n{ "Reserved", "mrp-msrp.reserved",\r\nFT_UINT8, BASE_DEC, VALS(reserved_vals), MSRP_RESERVED_MASK, NULL, HFILL }\r\n},\r\n{ &hf_msrp_accumulated_latency,\r\n{ "Accumulated Latency", "mrp-msrp.accumulated_latency",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_failure_bridge_id,\r\n{ "Failure Bridge ID", "mrp-msrp.failure_bridge_id",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_failure_code,\r\n{ "Failure Code", "mrp-msrp.failure_code",\r\nFT_UINT8, BASE_DEC, VALS(failure_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_sr_class_id,\r\n{ "SR Class ID", "mrp-msrp.sr_class_id",\r\nFT_UINT8, BASE_DEC, VALS(sr_class_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_sr_class_priority,\r\n{ "SR Class Priority", "mrp-msrp.sr_class_priority",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_sr_class_vid,\r\n{ "SR Class VID", "mrp-msrp.sr_class_vid",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_three_packed_event,\r\n{ "Attribute Event", "mrp-msrp.three_packed_event",\r\nFT_UINT8, BASE_DEC, VALS(three_packed_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_four_packed_event,\r\n{ "Declaration Type", "mrp-msrp.four_packed_event",\r\nFT_UINT8, BASE_DEC, VALS(four_packed_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_msrp_end_mark,\r\n{ "End Mark", "mrp-msrp.end_mark",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_msrp,\r\n&ett_msg,\r\n&ett_attr_list,\r\n&ett_vect_attr,\r\n&ett_vector_header,\r\n&ett_first_value,\r\n&ett_priority_and_rank\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_msrp_attribute_type, { "mrp-msrp.attribute_type.unknown", PI_PROTOCOL, PI_WARN, "Malformed TCP/IP Status", EXPFILL }},\r\n};\r\nexpert_module_t* expert_msrp;\r\nproto_msrp = proto_register_protocol("Multiple Stream Reservation Protocol",\r\n"MRP-MSRP", "mrp-msrp");\r\nproto_register_field_array(proto_msrp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_msrp = expert_register_protocol(proto_msrp);\r\nexpert_register_field_array(expert_msrp, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_mrp_msrp(void)\r\n{\r\ndissector_handle_t msrp_handle;\r\nmsrp_handle = create_dissector_handle(dissect_msrp, proto_msrp);\r\ndissector_add_uint("ethertype", ETHERTYPE_MSRP, msrp_handle);\r\n}

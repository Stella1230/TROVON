static gboolean info_line(const gchar *line)\r\n{\r\nint i=NETSCREEN_SPACES_ON_INFO_LINE;\r\nwhile (i-- > 0) {\r\nif (g_ascii_isspace(*line)) {\r\nline++;\r\ncontinue;\r\n} else {\r\nreturn FALSE;\r\n}\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gint64 netscreen_seek_next_packet(wtap *wth, int *err, gchar **err_info,\r\nchar *hdr)\r\n{\r\ngint64 cur_off;\r\nchar buf[NETSCREEN_LINE_LENGTH];\r\nwhile (1) {\r\ncur_off = file_tell(wth->fh);\r\nif (cur_off == -1) {\r\n*err = file_error(wth->fh, err_info);\r\nreturn -1;\r\n}\r\nif (file_gets(buf, sizeof(buf), wth->fh) == NULL) {\r\n*err = file_error(wth->fh, err_info);\r\nbreak;\r\n}\r\nif (strstr(buf, NETSCREEN_REC_MAGIC_STR1) ||\r\nstrstr(buf, NETSCREEN_REC_MAGIC_STR2)) {\r\ng_strlcpy(hdr, buf, NETSCREEN_LINE_LENGTH);\r\nreturn cur_off;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic gboolean netscreen_check_file_type(wtap *wth, int *err, gchar **err_info)\r\n{\r\nchar buf[NETSCREEN_LINE_LENGTH];\r\nguint reclen, line;\r\nbuf[NETSCREEN_LINE_LENGTH-1] = '\0';\r\nfor (line = 0; line < NETSCREEN_HEADER_LINES_TO_CHECK; line++) {\r\nif (file_gets(buf, NETSCREEN_LINE_LENGTH, wth->fh) == NULL) {\r\n*err = file_error(wth->fh, err_info);\r\nreturn FALSE;\r\n}\r\nreclen = (guint) strlen(buf);\r\nif (reclen < strlen(NETSCREEN_HDR_MAGIC_STR1) ||\r\nreclen < strlen(NETSCREEN_HDR_MAGIC_STR2)) {\r\ncontinue;\r\n}\r\nif (strstr(buf, NETSCREEN_HDR_MAGIC_STR1) ||\r\nstrstr(buf, NETSCREEN_HDR_MAGIC_STR2)) {\r\nreturn TRUE;\r\n}\r\n}\r\n*err = 0;\r\nreturn FALSE;\r\n}\r\nwtap_open_return_val netscreen_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nif (!netscreen_check_file_type(wth, err, err_info)) {\r\nif (*err != 0 && *err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (file_seek(wth->fh, 0L, SEEK_SET, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_encap = WTAP_ENCAP_UNKNOWN;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_NETSCREEN;\r\nwth->snapshot_length = 0;\r\nwth->subtype_read = netscreen_read;\r\nwth->subtype_seek_read = netscreen_seek_read;\r\nwth->file_tsprec = WTAP_TSPREC_DSEC;\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic gboolean netscreen_read(wtap *wth, int *err, gchar **err_info,\r\ngint64 *data_offset)\r\n{\r\ngint64 offset;\r\nchar line[NETSCREEN_LINE_LENGTH];\r\noffset = netscreen_seek_next_packet(wth, err, err_info, line);\r\nif (offset < 0)\r\nreturn FALSE;\r\nif (!parse_netscreen_packet(wth->fh, &wth->phdr,\r\nwth->frame_buffer, line, err, err_info))\r\nreturn FALSE;\r\nif (wth->file_encap == WTAP_ENCAP_UNKNOWN)\r\nwth->file_encap = wth->phdr.pkt_encap;\r\nelse {\r\nif (wth->file_encap != wth->phdr.pkt_encap)\r\nwth->file_encap = WTAP_ENCAP_PER_PACKET;\r\n}\r\n*data_offset = offset;\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nnetscreen_seek_read(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf,\r\nint *err, gchar **err_info)\r\n{\r\nchar line[NETSCREEN_LINE_LENGTH];\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1) {\r\nreturn FALSE;\r\n}\r\nif (file_gets(line, NETSCREEN_LINE_LENGTH, wth->random_fh) == NULL) {\r\n*err = file_error(wth->random_fh, err_info);\r\nif (*err == 0) {\r\n*err = WTAP_ERR_SHORT_READ;\r\n}\r\nreturn FALSE;\r\n}\r\nreturn parse_netscreen_packet(wth->random_fh, phdr, buf, line,\r\nerr, err_info);\r\n}\r\nstatic gboolean\r\nparse_netscreen_packet(FILE_T fh, struct wtap_pkthdr *phdr, Buffer* buf,\r\nchar *line, int *err, gchar **err_info)\r\n{\r\nint pkt_len;\r\nint sec;\r\nint dsec;\r\nchar cap_int[NETSCREEN_MAX_INT_NAME_LENGTH];\r\nchar direction[2];\r\nchar cap_src[13];\r\nchar cap_dst[13];\r\nguint8 *pd;\r\ngchar *p;\r\nint n, i = 0;\r\nint offset = 0;\r\ngchar dststr[13];\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = WTAP_HAS_TS|WTAP_HAS_CAP_LEN;\r\nif (sscanf(line, "%9d.%9d: %15[a-z0-9/:.-](%1[io]) len=%9d:%12s->%12s/",\r\n&sec, &dsec, cap_int, direction, &pkt_len, cap_src, cap_dst) < 5) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("netscreen: Can't parse packet-header");\r\nreturn -1;\r\n}\r\nif (pkt_len < 0) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("netscreen: packet header has a negative packet length");\r\nreturn FALSE;\r\n}\r\nif (pkt_len > WTAP_MAX_PACKET_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("netscreen: File has %u-byte packet, bigger than maximum of %u",\r\npkt_len, WTAP_MAX_PACKET_SIZE);\r\nreturn FALSE;\r\n}\r\nphdr->ts.secs = sec;\r\nphdr->ts.nsecs = dsec * 100000000;\r\nphdr->len = pkt_len;\r\nws_buffer_assure_space(buf, pkt_len);\r\npd = ws_buffer_start_ptr(buf);\r\nwhile(1) {\r\nif (file_gets(line, NETSCREEN_LINE_LENGTH, fh) == NULL) {\r\nbreak;\r\n}\r\nfor (p = &line[0]; g_ascii_isspace(*p); p++)\r\n;\r\nif (*p == '\0') {\r\nbreak;\r\n}\r\nn = parse_single_hex_dump_line(p, pd, offset);\r\nif (offset == 0 && n < 6) {\r\nif (info_line(line)) {\r\nif (++i <= NETSCREEN_MAX_INFOLINES) {\r\ncontinue;\r\n}\r\n} else {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("netscreen: cannot parse hex-data");\r\nreturn FALSE;\r\n}\r\n}\r\nif (n == -1) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("netscreen: cannot parse hex-data");\r\nreturn FALSE;\r\n}\r\noffset += n;\r\nif (offset > pkt_len) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("netscreen: too much hex-data");\r\nreturn FALSE;\r\n}\r\n}\r\nif (strncmp(cap_int, "adsl", 4) == 0) {\r\ng_snprintf(dststr, 13, "%02x%02x%02x%02x%02x%02x",\r\npd[0], pd[1], pd[2], pd[3], pd[4], pd[5]);\r\nif (strncmp(dststr, cap_dst, 12) == 0)\r\nphdr->pkt_encap = WTAP_ENCAP_ETHERNET;\r\nelse\r\nphdr->pkt_encap = WTAP_ENCAP_PPP;\r\n}\r\nelse if (strncmp(cap_int, "seri", 4) == 0)\r\nphdr->pkt_encap = WTAP_ENCAP_PPP;\r\nelse\r\nphdr->pkt_encap = WTAP_ENCAP_ETHERNET;\r\nphdr->caplen = offset;\r\nreturn TRUE;\r\n}\r\nstatic int\r\nparse_single_hex_dump_line(char* rec, guint8 *buf, guint byte_offset)\r\n{\r\nint num_items_scanned;\r\nguint8 character;\r\nguint8 byte;\r\nfor (num_items_scanned = 0; num_items_scanned < 16; num_items_scanned++) {\r\ncharacter = *rec++;\r\nif (character >= '0' && character <= '9')\r\nbyte = character - '0' + 0;\r\nelse if (character >= 'A' && character <= 'F')\r\nbyte = character - 'A' + 0xA;\r\nelse if (character >= 'a' && character <= 'f')\r\nbyte = character - 'a' + 0xa;\r\nelse if (character == ' ' || character == '\r' || character == '\n' || character == '\0') {\r\nbreak;\r\n} else\r\nreturn -1;\r\nbyte <<= 4;\r\ncharacter = *rec++ & 0xFF;\r\nif (character >= '0' && character <= '9')\r\nbyte += character - '0' + 0;\r\nelse if (character >= 'A' && character <= 'F')\r\nbyte += character - 'A' + 0xA;\r\nelse if (character >= 'a' && character <= 'f')\r\nbyte += character - 'a' + 0xa;\r\nelse\r\nreturn -1;\r\nbuf[byte_offset + num_items_scanned] = byte;\r\ncharacter = *rec++ & 0xFF;\r\nif (character == '\0' || character == '\r' || character == '\n') {\r\nbreak;\r\n} else if (character != ' ') {\r\nreturn -1;\r\n}\r\n}\r\nif (num_items_scanned == 0)\r\nreturn -1;\r\nreturn num_items_scanned;\r\n}

static guint32 dissect_mqpcf_getDigits(guint uCnt)\r\n{\r\nreturn (guint32)(log10( (double)uCnt ) + 1);\r\n}\r\nstatic const guint8 *dissect_mqpcf_parm_getintval(guint uPrm, guint uVal)\r\n{\r\nconst value_string *pVs;\r\npVs = (const value_string *)try_val_to_str_ext(uPrm, GET_VALS_EXTP(MQCFINT_Parse));\r\nif (pVs)\r\n{\r\nreturn (const guint8 *)try_val_to_str(uVal, pVs);\r\n}\r\nreturn NULL;\r\n}\r\nstatic void dissect_mqpcf_parm_int(tvbuff_t *tvb, proto_tree *tree, guint offset, guint uPrm,\r\nguint uVal, int hfindex, guint iCnt, guint iMaxCnt,\r\nguint iDigit, gboolean bParse)\r\n{\r\nheader_field_info *hfinfo;\r\nconst guint8 *pVal = NULL;\r\nif (bParse)\r\npVal = dissect_mqpcf_parm_getintval(uPrm, uVal);\r\nhfinfo = proto_registrar_get_nth(hfindex);\r\nif (iMaxCnt > 1)\r\n{\r\nif (pVal)\r\n{\r\nproto_tree_add_int_format(tree, hfindex, tvb, offset, 4, uVal,\r\n"%s[%*d]: %8x-(%9d)-%s", hfinfo->name, iDigit, iCnt, uVal, uVal, pVal);\r\n}\r\nelse\r\n{\r\nproto_tree_add_int_format(tree, hfindex, tvb, offset, 4, uVal,\r\n"%s[%*d]: %8x-(%9d)", hfinfo->name, iDigit, iCnt, uVal, uVal);\r\n}\r\n}\r\nelse\r\n{\r\nif (pVal)\r\n{\r\nproto_tree_add_int_format_value(tree, hfindex, tvb, offset, 4, uVal,\r\n"%8x-(%9d)-%s", uVal, uVal, pVal);\r\n}\r\nelse\r\n{\r\nproto_tree_add_int_format_value(tree, hfindex, tvb, offset, 4, uVal,\r\n"%8x-(%9d)", uVal, uVal);\r\n}\r\n}\r\n}\r\nvoid dissect_mqpcf_parm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *mq_tree,\r\nguint offset, guint32 uCount, guint bLittleEndian, gboolean bParse)\r\n{\r\nguint32 u = 0;\r\nguint32 tOfs = 0;\r\nguint32 uLenF;\r\nchar strPrm[256];\r\nguint32 uTyp;\r\nguint32 uLen = 0;\r\nguint32 uPrm;\r\nguint32 uCnt;\r\nguint32 uCCS;\r\nguint32 uSLn;\r\nguint32 uVal;\r\nguint64 uVal64;\r\nguint32 uDig;\r\nconst char sMaxLst[] = " Max # of List reached. DECODE interrupted (actual %u of %u)";\r\nconst char sPrmLn0[] = " MQPrm[%3u] has a zero length. DECODE Failed (MQPrm Count: %u)";\r\nconst char sMaxPrm[] = " Max # of Parm reached. DECODE interrupted (actual %u of %u)";\r\nconst char sPrmCnt[] = " Cnt=-1 and Length(%u) < 16. DECODE interrupted for elem %u";\r\nproto_item *ti = NULL;\r\nproto_tree *tree = NULL;\r\nif (uCount == (guint32)-1)\r\n{\r\nguint32 xOfs = offset;\r\nuCnt = 0;\r\nwhile (tvb_reported_length_remaining(tvb, xOfs) >= 16)\r\n{\r\nuLen = tvb_get_guint32(tvb, xOfs + 4, bLittleEndian);\r\nif (uLen < 16)\r\n{\r\nproto_tree_add_expert_format(tree, pinfo, &ei_mq_pcf_PrmCnt, tvb, xOfs, 16, sPrmCnt, uLen, uCnt);\r\nbreak;\r\n}\r\nuCnt++;\r\nxOfs += uLen;\r\n}\r\nuCount = uCnt;\r\n}\r\nuDig = dissect_mqpcf_getDigits(uCount);\r\nfor (u = 0; u < uCount && u < mq_pcf_maxprm; u++)\r\n{\r\ntOfs = offset;\r\nuTyp = tvb_get_guint32(tvb, offset , bLittleEndian);\r\nuLen = tvb_get_guint32(tvb, offset + 4, bLittleEndian);\r\nif (uLen == 0)\r\n{\r\nproto_tree_add_expert_format(tree, pinfo, &ei_mq_pcf_prmln0, tvb, offset, 12, sPrmLn0, u+1, uCount);\r\nu = uCount;\r\nbreak;\r\n}\r\nuPrm = tvb_get_guint32(tvb, offset + 8, bLittleEndian);\r\nuLenF = 12;\r\nif (bParse)\r\ng_snprintf(strPrm, (gulong)sizeof(strPrm) - 1, " %-s[%*u] {%2d-%-15.15s} %8x/%5d-%-30.30s",\r\n"MQPrm", uDig, u+1,\r\nuTyp, val_to_str_ext_const(uTyp, GET_VALS_EXTP(PrmTyp), " Unknown") + 6,\r\nuPrm, uPrm, val_to_str_ext_const(uPrm, GET_VALS_EXTP(PrmId), "Unknown"));\r\nelse\r\ng_snprintf(strPrm, (gulong)sizeof(strPrm) - 1, " %-s[%*u] {%2d-%-15.15s} %8x/%5d",\r\n"XtraD", uDig, u+1,\r\nuTyp, val_to_str_ext_const(uTyp, GET_VALS_EXTP(PrmTyp), " Unknown") + 6,\r\nuPrm, uPrm);\r\nswitch (uTyp)\r\n{\r\ncase MQ_MQCFT_NONE:\r\nbreak;\r\ncase MQ_MQCFT_COMMAND:\r\nbreak;\r\ncase MQ_MQCFT_RESPONSE:\r\nbreak;\r\ncase MQ_MQCFT_INTEGER:\r\n{\r\nconst guint8 *pVal = NULL;\r\nuVal = tvb_get_guint32(tvb, offset + uLenF, bLittleEndian);\r\nif (bParse)\r\npVal = dissect_mqpcf_parm_getintval(uPrm, uVal);\r\nif (pVal)\r\n{\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL,\r\n"%s %8x-(%9d) %s", strPrm, uVal, uVal, pVal);\r\n}\r\nelse\r\n{\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL,\r\n"%s %8x-(%9d)", strPrm, uVal, uVal);\r\n}\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp, tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen, tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\ndissect_mqpcf_parm_int(tvb, tree, offset+uLenF, uPrm, uVal, hf_mq_pcf_int, 0, 0, 0, bParse);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_STRING:\r\n{\r\nguint8 *sStr;\r\nuCCS = tvb_get_guint32(tvb, offset + uLenF, bLittleEndian);\r\nuSLn = tvb_get_guint32(tvb, offset + uLenF + 4, bLittleEndian);\r\nsStr = tvb_get_string_enc(wmem_packet_scope(), tvb, offset + uLenF + 8,\r\nuSLn, (uCCS != 500) ? ENC_ASCII : ENC_EBCDIC);\r\nif (*sStr)\r\nstrip_trailing_blanks(sStr, uSLn);\r\nif (*sStr)\r\nformat_text_chr(sStr, strlen((const char *)sStr), '.');\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s %s", strPrm, sStr);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmccsid , tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmstrlen, tvb, offset + 16, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_string, tvb, offset + uLenF + 8, uSLn, (uCCS != 500) ? ENC_ASCII : ENC_EBCDIC);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_INTEGER_LIST:\r\n{\r\nguint32 u2;\r\nguint32 uDigit = 0;\r\nuCnt = tvb_get_guint32(tvb, offset+uLenF, bLittleEndian);\r\nuDigit = dissect_mqpcf_getDigits(uCnt);\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, &ti, "%s Cnt(%d)", strPrm, uCnt);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmcount, tvb, offset + 12, 4, bLittleEndian);\r\noffset += uLenF+4;\r\nfor (u2 = 0; u2 < uCnt && u2 < mq_pcf_maxlst; u2++)\r\n{\r\nuVal = tvb_get_guint32(tvb, offset, bLittleEndian);\r\ndissect_mqpcf_parm_int(tvb, tree, offset, uPrm, uVal, hf_mq_pcf_intlist, u2+1, uCnt, uDigit, bParse);\r\noffset += 4;\r\n}\r\nif (u2 != uCnt)\r\n{\r\nproto_tree_add_expert_format(tree, pinfo, &ei_mq_pcf_MaxInt, tvb, offset, (uCnt- u2) * 4, sMaxLst, u2, uCnt);\r\n}\r\n}\r\nbreak;\r\ncase MQ_MQCFT_STRING_LIST:\r\n{\r\nguint32 u2;\r\nguint32 uDigit;\r\nguint8 *sStr;\r\nheader_field_info *hfinfo;\r\nhfinfo = proto_registrar_get_nth(hf_mq_pcf_stringlist);\r\nuCCS = tvb_get_guint32(tvb, offset + uLenF , bLittleEndian);\r\nuCnt = tvb_get_guint32(tvb, offset + uLenF + 4, bLittleEndian);\r\nuSLn = tvb_get_guint32(tvb, offset + uLenF + 8, bLittleEndian);\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s Cnt(%d)", strPrm, uCnt);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmccsid , tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmcount , tvb, offset + 16, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmstrlen, tvb, offset + 20, 4, bLittleEndian);\r\nuDigit = dissect_mqpcf_getDigits(uCnt);\r\noffset += uLenF+12;\r\nfor (u2 = 0; u2 < uCnt && u2 < mq_pcf_maxlst; u2++)\r\n{\r\nsStr = tvb_get_string_enc(wmem_packet_scope(), tvb, offset,\r\nuSLn, (uCCS != 500) ? ENC_ASCII : ENC_EBCDIC);\r\nif (*sStr)\r\nstrip_trailing_blanks(sStr, uSLn);\r\nif (*sStr)\r\nformat_text_chr(sStr, strlen((const char *)sStr), '.');\r\nproto_tree_add_string_format(tree, hf_mq_pcf_stringlist, tvb, offset, uSLn, (const char *)sStr,\r\n"%s[%*d]: %s", hfinfo->name, uDigit, u2+1, sStr);\r\noffset += uSLn;\r\n}\r\nif (u2 != uCnt)\r\n{\r\nproto_tree_add_expert_format(tree, pinfo, &ei_mq_pcf_MaxStr, tvb, offset,(uCnt - u2) * uSLn, sMaxLst, u2, uCnt);\r\n}\r\n}\r\nbreak;\r\ncase MQ_MQCFT_EVENT:\r\nbreak;\r\ncase MQ_MQCFT_USER:\r\n{\r\ntree = proto_tree_add_subtree(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, strPrm);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_bytestring, tvb, offset + 8, uLen - 8, bLittleEndian);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_BYTE_STRING:\r\n{\r\nuSLn = tvb_get_guint32(tvb, offset + uLenF, bLittleEndian);\r\nif (uSLn)\r\n{\r\nguint8 *sStrA = (guint8 *)format_text_chr(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + uLenF + 4, uSLn, ENC_ASCII) , uSLn, '.');\r\nguint8 *sStrE = (guint8 *)format_text_chr(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + uLenF + 4, uSLn, ENC_EBCDIC), uSLn, '.');\r\nif (uSLn > 35)\r\n{\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL,\r\n"%s [Truncated] A(%-.35s) E(%-.35s)", strPrm, sStrA, sStrE);\r\n}\r\nelse\r\n{\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL,\r\n"%s A(%s) E(%s)", strPrm, sStrA, sStrE);\r\n}\r\n}\r\nelse\r\n{\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s <MISSING>", strPrm);\r\n}\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmstrlen, tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_bytestring, tvb, offset + uLenF + 4 , uSLn, bLittleEndian);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_TRACE_ROUTE:\r\nbreak;\r\ncase MQ_MQCFT_REPORT:\r\nbreak;\r\ncase MQ_MQCFT_INTEGER_FILTER:\r\n{\r\nguint32 uOpe;\r\nuOpe = tvb_get_guint32(tvb, offset + uLenF , bLittleEndian);\r\nuVal = tvb_get_guint32(tvb, offset + uLenF + 4, bLittleEndian);\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s %s %8x-(%9d)",\r\nstrPrm, val_to_str(uOpe, GET_VALSV(FilterOP), " Unknown (0x%02x)")+7, uVal, uVal);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_filterop , tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_int, tvb, offset + uLenF + 4, 4, bLittleEndian);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_STRING_FILTER:\r\n{\r\nguint8 *sStr;\r\nguint32 uOpe;\r\nuOpe = tvb_get_guint32(tvb, offset + uLenF, bLittleEndian);\r\nuCCS = tvb_get_guint32(tvb, offset + uLenF + 4, bLittleEndian);\r\nuSLn = tvb_get_guint32(tvb, offset + uLenF + 8, bLittleEndian);\r\nsStr = (guint8 *)format_text_chr(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + uLenF + 12, uSLn, (uCCS != 500) ? ENC_ASCII : ENC_EBCDIC), uSLn, '.');\r\nstrip_trailing_blanks(sStr, uSLn);\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s %s %s",\r\nstrPrm, val_to_str(uOpe, GET_VALSV(FilterOP), " Unknown (0x%02x)")+7, sStr);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_filterop , tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmccsid , tvb, offset + 16, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmstrlen, tvb, offset + 20, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_string, tvb, offset + uLenF + 12, uSLn, (uCCS != 500) ? ENC_ASCII : ENC_EBCDIC);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_BYTE_STRING_FILTER:\r\n{\r\nguint32 uOpe;\r\nuOpe = tvb_get_guint32(tvb, offset + uLenF, bLittleEndian);\r\nuSLn = tvb_get_guint32(tvb, offset + uLenF + 4, bLittleEndian);\r\nif (uSLn)\r\n{\r\nguint8 *sStrA = (guint8 *)format_text_chr(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + uLenF + 8, uSLn, ENC_ASCII), uSLn, '.');\r\nguint8 *sStrE = (guint8 *)format_text_chr(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + uLenF + 8, uSLn, ENC_EBCDIC), uSLn, '.');\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s %s A(%s) E(%s)",\r\nstrPrm, val_to_str(uOpe, GET_VALSV(FilterOP), " Unknown (0x%02x)")+7, sStrA, sStrE);\r\n}\r\nelse\r\n{\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s %s <MISSING>",\r\nstrPrm, val_to_str(uOpe, GET_VALSV(FilterOP), " Unknown (0x%02x)")+7);\r\n}\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_filterop , tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmstrlen, tvb, offset + 16, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_bytestring, tvb, offset + uLenF + 8 , uSLn, bLittleEndian);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_COMMAND_XR:\r\nbreak;\r\ncase MQ_MQCFT_XR_MSG:\r\nbreak;\r\ncase MQ_MQCFT_XR_ITEM:\r\nbreak;\r\ncase MQ_MQCFT_XR_SUMMARY:\r\nbreak;\r\ncase MQ_MQCFT_GROUP:\r\nbreak;\r\ncase MQ_MQCFT_STATISTICS:\r\nbreak;\r\ncase MQ_MQCFT_ACCOUNTING:\r\nbreak;\r\ncase MQ_MQCFT_INTEGER64:\r\n{\r\nuVal64 = tvb_get_guint64(tvb, offset + uLenF + 4, bLittleEndian);\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL,\r\n"%s %" G_GINT64_MODIFIER "x (%" G_GINT64_MODIFIER "d)", strPrm, uVal64, uVal64);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmunused, tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_int64, tvb, offset + uLenF + 4, 8, bLittleEndian);\r\n}\r\nbreak;\r\ncase MQ_MQCFT_INTEGER64_LIST:\r\n{\r\nguint32 u2;\r\nguint32 uDigit;\r\nheader_field_info *hfinfo;\r\nhfinfo = proto_registrar_get_nth(hf_mq_pcf_int64list);\r\nuCnt = tvb_get_guint32(tvb, offset + uLenF, bLittleEndian);\r\ntree = proto_tree_add_subtree_format(mq_tree, tvb, offset, uLen, ett_mqpcf_prm, NULL, "%s Cnt(%d)", strPrm, uCnt);\r\nuDigit = dissect_mqpcf_getDigits(uCnt);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmtyp , tvb, offset , 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmlen , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(tree, (bParse) ? hf_mq_pcf_prmid : hf_mq_pcf_prmidnovals, tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(tree, hf_mq_pcf_prmcount, tvb, offset + 12, 4, bLittleEndian);\r\noffset += uLenF + 4;\r\nfor (u2 = 0; u2 < uCnt && u2 < mq_pcf_maxlst; u2++)\r\n{\r\nuVal64 = tvb_get_guint64(tvb, offset, bLittleEndian);\r\nproto_tree_add_int64_format(tree, hf_mq_pcf_int64list, tvb, offset, 8, uVal64,\r\n"%s[%*d]: %" G_GINT64_MODIFIER "x (%" G_GINT64_MODIFIER "d)",\r\nhfinfo->name, uDigit, u2+1, uVal64, uVal64);\r\noffset += 8;\r\n}\r\nif (u2 != uCnt)\r\n{\r\nproto_tree_add_expert_format(tree, pinfo, &ei_mq_pcf_MaxI64, tvb, offset, (uCnt - u2) * 8, sMaxLst, u2, uCnt);\r\n}\r\n}\r\nbreak;\r\n}\r\noffset = tOfs+uLen;\r\n}\r\nif (u != uCount)\r\n{\r\nproto_tree_add_expert_format(mq_tree, pinfo, &ei_mq_pcf_MaxPrm, tvb, offset, tvb_reported_length_remaining(tvb, offset), sMaxPrm, u, uCount);\r\n}\r\n}\r\nstatic void dissect_mqpcf(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, mq_parm_t* p_mq_parm)\r\n{\r\ngint offset = 0;\r\ngboolean bLittleEndian;\r\nbLittleEndian = ((p_mq_parm->mq_cur_ccsid.encod & MQ_MQENC_INTEGER_MASK) == MQ_MQENC_INTEGER_REVERSED) ? ENC_LITTLE_ENDIAN : ENC_BIG_ENDIAN;\r\nif (tvb_reported_length(tvb) >= 36)\r\n{\r\ngint iSizeMQCFH = 36;\r\nguint32 iCommand = tvb_get_guint32(tvb, offset + 12, bLittleEndian);\r\nif (tree)\r\n{\r\nproto_item *ti;\r\nproto_tree *mq_tree;\r\nproto_tree *mqroot_tree;\r\nchar sTmp[256];\r\nguint32 uCnt;\r\nguint32 uTyp;\r\nguint32 uCmd;\r\nguint32 uCC;\r\nguint32 uRC;\r\nuTyp = tvb_get_guint32(tvb, offset , bLittleEndian);\r\nuCmd = tvb_get_guint32(tvb, offset + 12, bLittleEndian);\r\nuCC = tvb_get_guint32(tvb, offset + 24, bLittleEndian);\r\nuRC = tvb_get_guint32(tvb, offset + 28, bLittleEndian);\r\nuCnt = tvb_get_guint32(tvb, offset + 32, bLittleEndian);\r\nif (uCC || uRC)\r\n{\r\ng_snprintf(sTmp, (gulong)sizeof(sTmp)-1, " %-s [%d-%s] {%d-%s} PrmCnt(%d) CC(%d-%s) RC(%d-%s)",\r\nMQ_TEXT_CFH,\r\nuTyp, val_to_str_const(uTyp, GET_VALSV(mqcft), "Unknown"),\r\nuCmd, val_to_str_ext_const(uCmd, GET_VALS_EXTP(mqcmd), "Unknown"),\r\nuCnt,\r\nuCC, val_to_str_const(uCC, GET_VALSV(mqcc), "Unknown"),\r\nuRC, val_to_str_ext_const(uRC, GET_VALS_EXTP(mqrc), "Unknown"));\r\n}\r\nelse\r\n{\r\ng_snprintf(sTmp, (gulong)sizeof(sTmp)-1, " %-s [%d-%s] {%d-%s} PrmCnt(%d)",\r\nMQ_TEXT_CFH,\r\nuTyp, val_to_str_const(uTyp, GET_VALSV(mqcft), "Unknown"),\r\nuCmd, val_to_str_ext_const(uCmd, GET_VALS_EXTP(mqcmd), "Unknown"),\r\nuCnt);\r\n}\r\nti = proto_tree_add_item(tree, proto_mqpcf, tvb, offset, -1, ENC_NA);\r\nproto_item_append_text(ti, " (%s)", val_to_str_ext_const(iCommand, GET_VALS_EXTP(mqcmd), "Unknown (0x%02x)"));\r\nmqroot_tree = proto_item_add_subtree(ti, ett_mqpcf);\r\nmq_tree = proto_tree_add_subtree(mqroot_tree, tvb, offset, iSizeMQCFH, ett_mqpcf_cfh, NULL, sTmp);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_type , tvb, offset + 0, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_length , tvb, offset + 4, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_version , tvb, offset + 8, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_command , tvb, offset + 12, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_MsgSeqNbr, tvb, offset + 16, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_control , tvb, offset + 20, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_compcode , tvb, offset + 24, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_reason , tvb, offset + 28, 4, bLittleEndian);\r\nproto_tree_add_item(mq_tree, hf_mqpcf_cfh_ParmCount, tvb, offset + 32, 4, bLittleEndian);\r\ndissect_mqpcf_parm(tvb, pinfo, mqroot_tree, offset + iSizeMQCFH, uCnt, bLittleEndian, TRUE);\r\n}\r\n}\r\n}\r\nstatic gboolean dissect_mqpcf_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nif (data && tvb_reported_length(tvb) >= 36)\r\n{\r\nmq_parm_t *p_mq_parm = (mq_parm_t *)data;\r\nif (strncmp((const char*)p_mq_parm->mq_format, MQ_MQFMT_ADMIN, 8) == 0\r\n|| strncmp((const char*)p_mq_parm->mq_format, MQ_MQFMT_EVENT, 8) == 0\r\n|| strncmp((const char*)p_mq_parm->mq_format, MQ_MQFMT_PCF, 8) == 0)\r\n{\r\ndissect_mqpcf(tvb, pinfo, tree, p_mq_parm);\r\nreturn TRUE;\r\n}\r\nif (strncmp((const char *)p_mq_parm->mq_format, "LPOO", 4) == 0)\r\n{\r\ngboolean bLittleEndian;\r\nbLittleEndian = ((p_mq_parm->mq_cur_ccsid.encod & MQ_MQENC_INTEGER_MASK) == MQ_MQENC_INTEGER_REVERSED) ? ENC_LITTLE_ENDIAN:ENC_BIG_ENDIAN;\r\ndissect_mqpcf_parm(tvb, pinfo, tree, 0, (guint32)-1, bLittleEndian, FALSE);\r\nreturn TRUE;\r\n}\r\n}\r\nreturn FALSE;\r\n}\r\nvoid proto_register_mqpcf(void)\r\n{\r\nexpert_module_t *expert_mqpcf;\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_mqpcf_cfh_type , { "Type.....", "mqpcf.cfh.type" , FT_UINT32, BASE_DEC, VALS(mq_mqcft_vals), 0x0, "CFH type", HFILL }},\r\n{ &hf_mqpcf_cfh_length , { "Length...", "mqpcf.cfh.length" , FT_UINT32, BASE_DEC, NULL, 0x0, "CFH length", HFILL }},\r\n{ &hf_mqpcf_cfh_version , { "Version..", "mqpcf.cfh.version" , FT_UINT32, BASE_DEC, NULL, 0x0, "CFH version", HFILL }},\r\n{ &hf_mqpcf_cfh_command , { "Command..", "mqpcf.cfh.command" , FT_UINT32, BASE_DEC | BASE_EXT_STRING, &mq_mqcmd_xvals, 0x0, "CFH command", HFILL }},\r\n{ &hf_mqpcf_cfh_MsgSeqNbr, { "MsgSeqNbr", "mqpcf.cfh.MsgSeqNbr" , FT_UINT32, BASE_DEC, NULL, 0x0, "CFH message sequence number", HFILL }},\r\n{ &hf_mqpcf_cfh_control , { "Control..", "mqpcf.cfh.control" , FT_UINT32, BASE_DEC, VALS(mq_CtlOpt_vals), 0x0, "CFH control", HFILL }},\r\n{ &hf_mqpcf_cfh_compcode , { "CompCode.", "mqpcf.cfh.compcode" , FT_UINT32, BASE_DEC, VALS(mq_mqcc_vals), 0x0, "CFH completion code", HFILL }},\r\n{ &hf_mqpcf_cfh_reason , { "ReasCode.", "mqpcf.cfh.reasoncode", FT_UINT32, BASE_DEC | BASE_EXT_STRING, &mq_mqrc_xvals, 0x0, "CFH reason code", HFILL }},\r\n{ &hf_mqpcf_cfh_ParmCount, { "ParmCount", "mqpcf.cfh.ParmCount" , FT_UINT32, BASE_DEC, NULL, 0x0, "CFH parameter count", HFILL }},\r\n{ &hf_mq_pcf_prmtyp , { "ParmTyp..", "mqpcf.parm.type" , FT_UINT32 , BASE_DEC | BASE_EXT_STRING, &mq_PrmTyp_xvals, 0x0, "MQPCF parameter type", HFILL }},\r\n{ &hf_mq_pcf_prmlen , { "ParmLen..", "mqpcf.parm.len" , FT_UINT32 , BASE_DEC, NULL, 0x0, "MQPCF parameter length", HFILL }},\r\n{ &hf_mq_pcf_prmid , { "ParmID...", "mqpcf.parm.id" , FT_UINT32 , BASE_DEC | BASE_EXT_STRING, &mq_PrmId_xvals, 0x0, "MQPCF parameter id", HFILL }},\r\n{ &hf_mq_pcf_prmidnovals , { "ParmID...", "mqpcf.parm.idNoVals" , FT_UINT32 , BASE_HEX_DEC, NULL, 0x0, "MQPCF parameter id No Vals", HFILL }},\r\n{ &hf_mq_pcf_filterop , { "FilterOP.", "mqpcf.filter.op" , FT_UINT32 , BASE_DEC, VALS(mq_FilterOP_vals), 0x0, "MQPCF Filter operator", HFILL }},\r\n{ &hf_mq_pcf_prmccsid , { "ParmCCSID", "mqpcf.parm.ccsid" , FT_UINT32 , BASE_DEC | BASE_RANGE_STRING, RVALS(mq_ccsid_rvals), 0x0, "MQPCF parameter ccsid", HFILL }},\r\n{ &hf_mq_pcf_prmstrlen , { "ParmStrLn", "mqpcf.parm.strlen" , FT_UINT32 , BASE_DEC, NULL, 0x0, "MQPCF parameter strlen", HFILL }},\r\n{ &hf_mq_pcf_prmcount , { "ParmCount", "mqpcf.parm.count" , FT_UINT32 , BASE_DEC, NULL, 0x0, "MQPCF parameter count", HFILL }},\r\n{ &hf_mq_pcf_prmunused , { "ParmUnuse", "mqpcf.parm.unused" , FT_UINT32 , BASE_DEC, NULL, 0x0, "MQPCF parameter unused", HFILL }},\r\n{ &hf_mq_pcf_string , { "String...", "mqpcf.parm.string" , FT_STRINGZ, BASE_NONE, NULL, 0x0, "MQPCF parameter string", HFILL }},\r\n{ &hf_mq_pcf_stringlist , { "StrList..", "mqpcf.parm.stringlist", FT_STRINGZ, BASE_NONE, NULL, 0x0, "MQPCF parameter string list", HFILL }},\r\n{ &hf_mq_pcf_int , { "Integer..", "mqpcf.parm.int" , FT_INT32 , BASE_DEC, NULL, 0x0, "MQPCF parameter int", HFILL }},\r\n{ &hf_mq_pcf_intlist , { "IntList..", "mqpcf.parm.intlist" , FT_INT32 , BASE_DEC, NULL, 0x0, "MQPCF parameter int list", HFILL }},\r\n{ &hf_mq_pcf_bytestring , { "ByteStr..", "mqpcf.parm.bytestring", FT_BYTES , BASE_NONE, NULL, 0x0, "MQPCF parameter byte string", HFILL }},\r\n{ &hf_mq_pcf_int64 , { "Int64....", "mqpcf.parm.int64" , FT_INT64 , BASE_DEC, NULL, 0x0, "MQPCF parameter int64", HFILL }},\r\n{ &hf_mq_pcf_int64list , { "Int64List", "mqpcf.parm.int64list" , FT_INT64 , BASE_DEC, NULL, 0x0, "MQPCF parameter int64 list", HFILL }},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_mqpcf,\r\n&ett_mqpcf_prm,\r\n&ett_mqpcf_cfh,\r\n};\r\nstatic ei_register_info ei[] =\r\n{\r\n{ &ei_mq_pcf_prmln0, { "mqpcf.parm.len0" , PI_MALFORMED, PI_ERROR, "MQPCF Parameter length is 0", EXPFILL }},\r\n{ &ei_mq_pcf_MaxInt, { "mqpcf.parm.IntList" , PI_UNDECODED, PI_WARN , "MQPCF Parameter Integer list exhausted", EXPFILL }},\r\n{ &ei_mq_pcf_MaxStr, { "mqpcf.parm.StrList" , PI_UNDECODED, PI_WARN , "MQPCF Parameter String list exhausted", EXPFILL }},\r\n{ &ei_mq_pcf_MaxI64, { "mqpcf.parm.Int64List", PI_UNDECODED, PI_WARN , "MQPCF Parameter Int64 list exhausted", EXPFILL }},\r\n{ &ei_mq_pcf_MaxPrm, { "mqpcf.parm.MaxPrm" , PI_UNDECODED, PI_WARN , "MQPCF Max number of parameter exhausted", EXPFILL }},\r\n{ &ei_mq_pcf_PrmCnt, { "mqpcf.parm.PrmCnt" , PI_UNDECODED, PI_WARN , "MQPCF Unkn Parm Cnt Length invalid", EXPFILL }},\r\n};\r\nmodule_t *mq_pcf_module;\r\nproto_mqpcf = proto_register_protocol("WebSphere MQ Programmable Command Formats", "MQ PCF", "mqpcf");\r\nproto_register_field_array(proto_mqpcf, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_mqpcf = expert_register_protocol(proto_mqpcf);\r\nexpert_register_field_array(expert_mqpcf, ei, array_length(ei));\r\nmq_pcf_module = prefs_register_protocol(proto_mqpcf, NULL);\r\nprefs_register_uint_preference(mq_pcf_module, "maxprm",\r\n"Set the maximum number of parameters in the PCF to decode",\r\n"When dissecting PCF there can be a lot of parameters."\r\n" You can limit the number of parameter decoded, before it continue with the next PCF.",\r\n10, &mq_pcf_maxprm);\r\nprefs_register_uint_preference(mq_pcf_module, "maxlst",\r\n"Set the maximum number of Parameter List that are displayed",\r\n"When dissecting a parameter of a PCFm, if it is a StringList, IntegerList or Integer64 List, "\r\n" You can limit the number of elements displayed, before it continues with the next Parameter.",\r\n10, &mq_pcf_maxlst);\r\n}\r\nvoid proto_reg_handoff_mqpcf(void)\r\n{\r\nheur_dissector_add("mq", dissect_mqpcf_heur, "WebSphere MQ PCF", "mqpcf_mq", proto_mqpcf, HEURISTIC_ENABLE);\r\n}

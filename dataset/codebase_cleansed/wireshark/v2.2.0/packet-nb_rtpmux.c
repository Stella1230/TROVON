static int\r\ndissect_nb_rtpmux(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *nb_rtpmux_tree, *nb_rtpmux_cmp_rtp_tree;\r\nunsigned int offset = 0;\r\ngboolean first_rtp_payload_seen = FALSE;\r\nif (tvb_captured_length(tvb) < 6)\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "NB_RTPMUX");\r\nwhile (offset < tvb_reported_length(tvb)-5)\r\n{\r\nguint16 dstport, srcport;\r\nunsigned int length;\r\ngint captured_length;\r\ntvbuff_t *next_tvb;\r\ngboolean tbit;\r\nlength = tvb_get_guint8(tvb, offset+2);\r\nti = proto_tree_add_item(tree, proto_nb_rtpmux, tvb, offset, length+5, ENC_NA);\r\nnb_rtpmux_tree = proto_item_add_subtree(ti, ett_nb_rtpmux);\r\nproto_tree_add_item(nb_rtpmux_tree, hf_nb_rtpmux_compressed, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ntbit = tvb_get_guint8(tvb,offset)>>7;\r\nif(tbit == 1){\r\ndstport = (tvb_get_ntohs(tvb, offset) & 0x7fff) << 1;\r\nproto_tree_add_uint(nb_rtpmux_tree, hf_nb_rtpmux_dstport, tvb, offset, 2, dstport );\r\nproto_tree_add_item(nb_rtpmux_tree, hf_nb_rtpmux_length, tvb, offset+2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nb_rtpmux_tree, hf_nb_r_bit, tvb, offset+3, 2, ENC_BIG_ENDIAN);\r\nsrcport = (tvb_get_ntohs(tvb, offset+3) & 0x7fff) << 1;\r\nproto_tree_add_uint(nb_rtpmux_tree, hf_nb_rtpmux_srcport, tvb, offset+3, 2, srcport );\r\nnb_rtpmux_cmp_rtp_tree = proto_tree_add_subtree( nb_rtpmux_tree, tvb, offset+5, 3, ett_nb_rtpmux_cmp_rtp_hdr, NULL, "Compressed RTP header" );\r\nproto_tree_add_item(nb_rtpmux_cmp_rtp_tree, hf_nb_rtpmux_cmp_rtp_sequence_no, tvb, offset+5, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nb_rtpmux_cmp_rtp_tree, hf_nb_rtpmux_cmp_rtp_timestamp, tvb, offset+6, 2, ENC_BIG_ENDIAN);\r\nif (length != 0)\r\nproto_tree_add_item(nb_rtpmux_cmp_rtp_tree, hf_nb_rtpmux_cmp_rtp_data,tvb, offset+8, length-3, ENC_NA);\r\nproto_item_append_text(ti, ", Src Port: %u, Dst Port: %u Length: %u", srcport, dstport, length);\r\n}else{\r\ndstport = (tvb_get_ntohs(tvb, offset) & 0x7fff) << 1;\r\nproto_tree_add_uint(nb_rtpmux_tree, hf_nb_rtpmux_dstport, tvb, offset, 2, dstport );\r\nproto_tree_add_item(nb_rtpmux_tree,\r\nhf_nb_rtpmux_length, tvb, offset+2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nb_rtpmux_tree, hf_nb_r_bit, tvb, offset+3, 1, ENC_BIG_ENDIAN);\r\nsrcport = (tvb_get_ntohs(tvb, offset+3) & 0x7fff) << 1;\r\nproto_tree_add_uint(nb_rtpmux_tree, hf_nb_rtpmux_srcport, tvb, offset+3, 2, srcport );\r\nproto_item_append_text(ti, ", Src Port: %u, Dst Port: %u Length: %u", srcport, dstport, length);\r\nif (length != 0)\r\n{\r\nif (rtpdissector)\r\n{\r\ncaptured_length = tvb_reported_length_remaining(tvb, offset + 5);\r\nif (captured_length > (gint)length)\r\ncaptured_length = length;\r\nnext_tvb = tvb_new_subset(tvb, offset+5, captured_length,\r\nlength);\r\nif (first_rtp_payload_seen)\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, " | ");\r\ncol_set_fence(pinfo->cinfo, COL_INFO);\r\n}\r\ncall_dissector(rtpdissector, next_tvb, pinfo, nb_rtpmux_tree);\r\nfirst_rtp_payload_seen = TRUE;\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(nb_rtpmux_tree,\r\nhf_nb_rtpmux_data, tvb, offset+5, length, ENC_NA);\r\n}\r\n}\r\n}\r\noffset += 5+length;\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_nb_rtpmux(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_nb_rtpmux_compressed,\r\n{ "Compressed headers(T bit)", "nb_rtpmux.compressed",\r\nFT_BOOLEAN, 16, NULL, 0x8000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_dstport,\r\n{ "Dst port", "nb_rtpmux.dstport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_length,\r\n{ "Length", "nb_rtpmux.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_r_bit,\r\n{ "R bit", "nb_rtpmux.r_bit",\r\nFT_BOOLEAN, 16, NULL, 0x8000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_srcport,\r\n{ "Src port", "nb_rtpmux.srcport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_data,\r\n{ "RTP Packet", "nb_rtpmux.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_cmp_rtp_sequence_no,\r\n{ "Sequence Number", "nb_rtpmux.cmp_rtp.sequence_no",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_cmp_rtp_timestamp,\r\n{ "Timestamp", "nb_rtpmux.cmp_rtp.timestamp",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nb_rtpmux_cmp_rtp_data,\r\n{ "RTP Data", "nb_rtpmux.cmp_rtp.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL,HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_nb_rtpmux,\r\n&ett_nb_rtpmux_cmp_rtp_hdr\r\n};\r\nmodule_t *nb_rtpmux_module;\r\nproto_nb_rtpmux = proto_register_protocol("3GPP Nb Interface RTP Multiplex",\r\n"NB_RTPMUX", "nb_rtpmux");\r\nproto_register_field_array(proto_nb_rtpmux, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nrange_convert_str(&global_nb_rtpmux_port_range, UDP_PORT_NB_RTPMUX_RANGE, MAX_UDP_PORT);\r\nnb_rtpmux_module = prefs_register_protocol(proto_nb_rtpmux, proto_reg_handoff_nb_rtpmux);\r\nprefs_register_range_preference(nb_rtpmux_module, "udp_ports",\r\n"NB RTPMUX server port numbers",\r\n"UDP port numbers used for NB RTPMUX traffic "\r\n"(default " UDP_PORT_NB_RTPMUX_RANGE ")",\r\n&global_nb_rtpmux_port_range, MAX_UDP_PORT);\r\n}\r\nvoid\r\nproto_reg_handoff_nb_rtpmux(void)\r\n{\r\nstatic range_t *nb_rtpmux_port_range;\r\nstatic gboolean nb_rtpmux_initialized = FALSE;\r\ndissector_handle_t nb_rtpmux_handle;\r\nnb_rtpmux_handle = create_dissector_handle(dissect_nb_rtpmux,\r\nproto_nb_rtpmux);\r\nif (!nb_rtpmux_initialized)\r\n{\r\nnb_rtpmux_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint_range("udp.port", nb_rtpmux_port_range, nb_rtpmux_handle);\r\ng_free(nb_rtpmux_port_range);\r\n}\r\nnb_rtpmux_port_range = range_copy(global_nb_rtpmux_port_range);\r\ndissector_add_uint_range("udp.port", nb_rtpmux_port_range, nb_rtpmux_handle);\r\ndissector_add_for_decode_as("udp.port", nb_rtpmux_handle);\r\nrtpdissector = find_dissector_add_dependency("rtp", proto_nb_rtpmux);\r\n}

static gboolean\r\nis_acn(tvbuff_t *tvb)\r\n{\r\nstatic const char acn_packet_id[] = "ASC-E1.17\0\0\0";\r\nif (tvb_captured_length(tvb) < (4+sizeof(acn_packet_id)))\r\nreturn FALSE;\r\nif (tvb_memeql(tvb, 4, acn_packet_id, sizeof(acn_packet_id)-1) != 0)\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\ndissect_acn_heur( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_ )\r\n{\r\nif (!is_acn(tvb)) return FALSE;\r\ndissect_acn(tvb, pinfo, tree);\r\nreturn TRUE;\r\n}\r\nstatic guint32\r\nacn_add_channel_owner_info_block(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nproto_item *pi;\r\nproto_tree *this_tree;\r\nguint32 session_count;\r\nguint32 x;\r\nthis_tree = proto_tree_add_subtree(tree, tvb, offset, 8, ett_acn_channel_owner_info_block, NULL,\r\n"Channel Owner Info Block");\r\nproto_tree_add_item(this_tree, hf_acn_member_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(this_tree, hf_acn_channel_number, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += acn_add_address(tvb, pinfo, this_tree, offset, "Destination Address:");\r\noffset += acn_add_address(tvb, pinfo, this_tree, offset, "Source Address:");\r\nsession_count = tvb_get_ntohs(tvb, offset);\r\nfor (x=0; x<session_count; x++) {\r\npi = proto_tree_add_item(this_tree, hf_acn_protocol_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_item_append_text(pi, " #%d", x+1);\r\noffset += 4;\r\n}\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_channel_member_info_block(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nproto_item *pi;\r\nproto_tree *this_tree;\r\nguint32 session_count;\r\nguint32 x;\r\nthis_tree = proto_tree_add_subtree(tree, tvb, offset, 8, ett_acn_channel_member_info_block,\r\nNULL, "Channel Member Info Block");\r\nproto_tree_add_item(this_tree, hf_acn_member_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(this_tree, hf_acn_cid, tvb, offset, 16, ENC_BIG_ENDIAN);\r\noffset += 16;\r\nproto_tree_add_item(this_tree, hf_acn_channel_number, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += acn_add_address(tvb, pinfo, this_tree, offset, "Destination Address:");\r\noffset += acn_add_address(tvb, pinfo, this_tree, offset, "Source Address:");\r\nproto_tree_add_item(this_tree, hf_acn_reciprocal_channel, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nsession_count = tvb_get_ntohs(tvb, offset);\r\nfor (x=0; x<session_count; x++) {\r\npi = proto_tree_add_item(this_tree, hf_acn_protocol_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_item_append_text(pi, " #%d", x+1);\r\noffset += 4;\r\n}\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_expiry(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset, int hf)\r\n{\r\nproto_tree_add_item(tree, hf, tvb, offset, 2, ENC_NA);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_channel_parameter(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *param_tree;\r\nparam_tree = proto_tree_add_subtree(tree, tvb, offset, 8, ett_acn_channel_parameter,\r\nNULL, "Channel Parameter Block");\r\nproto_tree_add_item(param_tree, hf_acn_expiry, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(param_tree, hf_acn_nak_outbound_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(param_tree, hf_acn_nak_holdoff, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(param_tree, hf_acn_nak_modulus, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(param_tree, hf_acn_nak_max_wait, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_address(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset, const char *label)\r\n{\r\nproto_item *pi;\r\nproto_tree *addr_tree = NULL;\r\nguint8 ip_address_type;\r\nguint32 port;\r\nip_address_type = tvb_get_guint8(tvb, offset);\r\nswitch (ip_address_type) {\r\ncase ACN_ADDR_NULL:\r\nproto_tree_add_item(tree, hf_acn_ip_address_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase ACN_ADDR_IPV4:\r\naddr_tree = proto_tree_add_subtree(tree, tvb, offset, 7, ett_acn_address, &pi, label);\r\nproto_tree_add_item(addr_tree, hf_acn_ip_address_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nport = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(addr_tree, hf_acn_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(addr_tree, hf_acn_ipv4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_item_append_text(pi, " %s, Port %d", tvb_address_to_str(wmem_packet_scope(), tvb, AT_IPv4, offset), port);\r\noffset += 4;\r\nbreak;\r\ncase ACN_ADDR_IPV6:\r\naddr_tree = proto_tree_add_subtree(tree, tvb, offset, 19, ett_acn_address, &pi, label);\r\nproto_tree_add_item(addr_tree, hf_acn_ip_address_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nport = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(addr_tree, hf_acn_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(addr_tree, hf_acn_ipv6, tvb, offset, 16, ENC_NA);\r\nproto_item_append_text(pi, " %s, Port %d", tvb_address_to_str(wmem_packet_scope(), tvb, AT_IPv6, offset), port);\r\noffset += 16;\r\nbreak;\r\ncase ACN_ADDR_IPPORT:\r\naddr_tree = proto_tree_add_subtree(tree, tvb, offset, 3, ett_acn_address, &pi, label);\r\nproto_tree_add_item(addr_tree, hf_acn_ip_address_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nport = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(addr_tree, hf_acn_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_item_append_text(pi, " Port %d", port);\r\noffset += 2;\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_dmp_address_type(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset, acn_dmp_adt_type *adt)\r\n{\r\nproto_tree *this_tree;\r\nguint8 D;\r\nconst gchar *name;\r\nadt->flags = tvb_get_guint8(tvb, offset);\r\nD = ACN_DMP_ADT_EXTRACT_D(adt->flags);\r\nname = val_to_str(D, acn_dmp_adt_d_vals, "not valid (%d)");\r\nthis_tree = proto_tree_add_subtree_format(tree, tvb, offset, 1, ett_acn_address_type,\r\nNULL, "Address and Data Type: %s", name);\r\nproto_tree_add_uint(this_tree, hf_acn_dmp_adt_v, tvb, offset, 1, adt->flags);\r\nproto_tree_add_uint(this_tree, hf_acn_dmp_adt_r, tvb, offset, 1, adt->flags);\r\nproto_tree_add_uint(this_tree, hf_acn_dmp_adt_d, tvb, offset, 1, adt->flags);\r\nproto_tree_add_uint(this_tree, hf_acn_dmp_adt_x, tvb, offset, 1, adt->flags);\r\nproto_tree_add_uint(this_tree, hf_acn_dmp_adt_a, tvb, offset, 1, adt->flags);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_dmp_address(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset, acn_dmp_adt_type *adt)\r\n{\r\nguint32 start_offset;\r\nguint32 bytes_used;\r\nguint8 D, A;\r\nstart_offset = offset;\r\nD = ACN_DMP_ADT_EXTRACT_D(adt->flags);\r\nA = ACN_DMP_ADT_EXTRACT_A(adt->flags);\r\nswitch (D) {\r\ncase ACN_DMP_ADT_D_NS:\r\nadt->increment = 1;\r\nadt->count = 1;\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\nadt->address = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nbytes_used = 1;\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\nadt->address = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nbytes_used = 2;\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\nadt->address = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nbytes_used = 4;\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\nif (adt->flags & ACN_DMP_ADT_FLAG_V) {\r\nproto_tree_add_uint(tree, hf_acn_dmp_virtual_address, tvb, start_offset, bytes_used, adt->address);\r\n} else {\r\nproto_tree_add_uint(tree, hf_acn_dmp_actual_address, tvb, start_offset, bytes_used, adt->address);\r\n}\r\nbreak;\r\ncase ACN_DMP_ADT_D_RS:\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\nadt->address = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nadt->increment = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nadt->count = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nbytes_used = 3;\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\nadt->address = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nadt->increment = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nadt->count = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nbytes_used = 6;\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\nadt->address = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nadt->increment = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nadt->count = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nbytes_used = 12;\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\nif (adt->flags & ACN_DMP_ADT_FLAG_V) {\r\nproto_tree_add_uint_format_value(tree, hf_acn_dmp_virtual_address_first, tvb, start_offset, bytes_used,\r\nadt->address, "0x%X, inc: %d, count: %d",\r\nadt->address, adt->increment, adt->count);\r\n} else {\r\nproto_tree_add_uint_format_value(tree, hf_acn_dmp_actual_address_first, tvb, start_offset, bytes_used,\r\nadt->address, "0x%X, inc: %d, count: %d",\r\nadt->address, adt->increment, adt->count);\r\n}\r\nbreak;\r\ncase ACN_DMP_ADT_D_RE:\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\nadt->address = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nadt->increment = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nadt->count = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nbytes_used = 3;\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\nadt->address = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nadt->increment = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nadt->count = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nbytes_used = 6;\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\nadt->address = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nadt->increment = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nadt->count = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nbytes_used = 12;\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\nif (adt->flags & ACN_DMP_ADT_FLAG_V) {\r\nproto_tree_add_uint_format_value(tree, hf_acn_dmp_virtual_address_first, tvb, start_offset, bytes_used,\r\nadt->address, "0x%X, inc: %d, count: %d",\r\nadt->address, adt->increment, adt->count);\r\n} else {\r\nproto_tree_add_uint_format_value(tree, hf_acn_dmp_actual_address_first, tvb, start_offset, bytes_used,\r\nadt->address, "0x%X, inc: %d, count: %d",\r\nadt->address, adt->increment, adt->count);\r\n}\r\nbreak;\r\ncase ACN_DMP_ADT_D_RM:\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\nadt->address = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nadt->increment = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nadt->count = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nbytes_used = 3;\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\nadt->address = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nadt->increment = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nadt->count = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nbytes_used = 6;\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\nadt->address = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nadt->increment = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nadt->count = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nbytes_used = 12;\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\nif (adt->flags & ACN_DMP_ADT_FLAG_V) {\r\nproto_tree_add_uint_format_value(tree, hf_acn_dmp_virtual_address_first, tvb, start_offset, bytes_used,\r\nadt->address, "0x%X, inc: %d, count: %d",\r\nadt->address, adt->increment, adt->count);\r\n} else {\r\nproto_tree_add_uint_format_value(tree, hf_acn_dmp_actual_address_first, tvb, start_offset, bytes_used,\r\nadt->address, "0x%X, inc: %d, count: %d",\r\nadt->address, adt->increment, adt->count);\r\n}\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_dmp_data(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset, acn_dmp_adt_type *adt)\r\n{\r\nguint8 D, A;\r\nguint32 data_size;\r\nguint32 data_value;\r\nguint32 data_address;\r\nguint32 x,y;\r\ngchar buffer[BUFFER_SIZE];\r\nproto_item *ti;\r\nguint32 ok_to_process = FALSE;\r\nbuffer[0] = 0;\r\nD = ACN_DMP_ADT_EXTRACT_D(adt->flags);\r\nswitch (D) {\r\ncase ACN_DMP_ADT_D_NS:\r\ncase ACN_DMP_ADT_D_RS:\r\nif (adt->data_length <= adt->count + 4) {\r\nok_to_process = TRUE;\r\n}\r\nbreak;\r\ncase ACN_DMP_ADT_D_RE:\r\nif (adt->count == 0) {\r\nbreak;\r\n}\r\nif (adt->data_length <= adt->count + 4) {\r\nok_to_process = TRUE;\r\n}\r\nbreak;\r\n}\r\nif (!ok_to_process) {\r\ndata_size = adt->data_length;\r\nti = proto_tree_add_item(tree, hf_acn_data, tvb, offset, data_size, ENC_NA);\r\noffset += data_size;\r\nproto_item_set_text(ti, "Data and more Address-Data Pairs (further dissection not possible)");\r\nreturn offset;\r\n}\r\nA = ACN_DMP_ADT_EXTRACT_A(adt->flags);\r\nswitch (D) {\r\ncase ACN_DMP_ADT_D_NS:\r\ndata_size = adt->data_length;\r\ndata_address = adt->address;\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%2.2X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%4.4X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%8.8X ->", data_address);\r\nbreak;\r\ndefault:\r\noffset += data_size;\r\nreturn offset;\r\n}\r\nswitch (data_size) {\r\ncase 1:\r\ndata_value = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 1, data_value, "%s %2.2X", buffer, data_value);\r\nbreak;\r\ncase 2:\r\ndata_value = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data16, tvb, offset, 2, data_value, "%s %4.4X", buffer, data_value);\r\nbreak;\r\ncase 3:\r\ndata_value = tvb_get_ntoh24(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data24, tvb, offset, 3, data_value, "%s %6.6X", buffer, data_value);\r\nbreak;\r\ncase 4:\r\ndata_value = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data32, tvb, offset, 4, data_value, "%s %8.8X", buffer, data_value);\r\nbreak;\r\ndefault:\r\nfor (y=0; y<20 && y<data_size; y++) {\r\ndata_value = tvb_get_guint8(tvb, offset+y);\r\ng_snprintf(buffer, BUFFER_SIZE, "%s %2.2X", buffer, data_value);\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_data, tvb, offset, data_size, ENC_NA);\r\noffset += data_size;\r\nproto_item_set_text(ti, "%s", buffer);\r\nbreak;\r\n}\r\noffset += data_size;\r\nbreak;\r\ncase ACN_DMP_ADT_D_RS:\r\ndata_size = adt->data_length;\r\ndata_address = adt->address;\r\nfor (x=0; x<adt->count; x++) {\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%2.2X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%4.4X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%8.8X ->", data_address);\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\nswitch (data_size) {\r\ncase 1:\r\ndata_value = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 1, data_value, "%s %2.2X", buffer, data_value);\r\nbreak;\r\ncase 2:\r\ndata_value = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 2, data_value, "%s %4.4X", buffer, data_value);\r\nbreak;\r\ncase 3:\r\ndata_value = tvb_get_ntoh24(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 3, data_value, "%s %6.6X", buffer, data_value);\r\nbreak;\r\ncase 4:\r\ndata_value = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 4, data_value, "%s %8.8X", buffer, data_value);\r\nbreak;\r\ndefault:\r\nfor (y=0; y<20 && y<data_size; y++) {\r\ndata_value = tvb_get_guint8(tvb, offset+y);\r\ng_snprintf(buffer, BUFFER_SIZE, "%s %2.2X", buffer, data_value);\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_data, tvb, offset, data_size, ENC_NA);\r\nproto_item_set_text(ti, "%s", buffer);\r\nbreak;\r\n}\r\ndata_address += adt->increment;\r\n}\r\noffset += data_size;\r\nbreak;\r\ncase ACN_DMP_ADT_D_RE:\r\ndata_size = adt->data_length / adt->count;\r\ndata_address = adt->address;\r\nfor (x=0; x<adt->count; x++) {\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%2.2X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%4.4X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%8.8X ->", data_address);\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\nswitch (data_size) {\r\ncase 1:\r\ndata_value = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 1, data_value, "%s %2.2X", buffer, data_value);\r\nbreak;\r\ncase 2:\r\ndata_value = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 2, data_value, "%s %4.4X", buffer, data_value);\r\nbreak;\r\ncase 3:\r\ndata_value = tvb_get_ntoh24(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 3, data_value, "%s %6.6X", buffer, data_value);\r\nbreak;\r\ncase 4:\r\ndata_value = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 4, data_value, "%s %8.8X", buffer, data_value);\r\nbreak;\r\ndefault:\r\nfor (y=0; y<20 && y<data_size; y++) {\r\ndata_value = tvb_get_guint8(tvb, offset+y);\r\ng_snprintf(buffer, BUFFER_SIZE, "%s %2.2X", buffer, data_value);\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_data, tvb, offset, data_size, ENC_NA);\r\nproto_item_set_text(ti, "%s", buffer);\r\nbreak;\r\n}\r\noffset += data_size;\r\ndata_address += adt->increment;\r\n}\r\nbreak;\r\ncase ACN_DMP_ADT_D_RM:\r\ndata_size = adt->data_length;\r\nti = proto_tree_add_item(tree, hf_acn_data, tvb, offset, data_size, ENC_NA);\r\noffset += data_size;\r\nproto_item_set_text(ti, "Mixed size data items");\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic guint32\r\nacn_add_dmp_reason_codes(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset, acn_dmp_adt_type *adt)\r\n{\r\nguint8 D, A;\r\nguint32 data_value;\r\nguint32 data_address;\r\nguint32 x;\r\ngchar buffer[BUFFER_SIZE];\r\nconst gchar *name;\r\nbuffer[0] = 0;\r\nD = ACN_DMP_ADT_EXTRACT_D(adt->flags);\r\nA = ACN_DMP_ADT_EXTRACT_A(adt->flags);\r\nswitch (D) {\r\ncase ACN_DMP_ADT_D_NS:\r\ndata_address = adt->address;\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%2.2X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%4.4X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%8.8X ->", data_address);\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\ndata_value = tvb_get_guint8(tvb, offset);\r\nname = val_to_str(data_value, acn_dmp_reason_code_vals, "reason not valid (%d)");\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 1, data_value, "%s %s", buffer, name);\r\noffset += 1;\r\nbreak;\r\ncase ACN_DMP_ADT_D_RS:\r\ndata_address = adt->address;\r\nfor (x=0; x<adt->count; x++) {\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%2.2X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%4.4X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%8.8X ->", data_address);\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\ndata_value = tvb_get_guint8(tvb, offset);\r\nname = val_to_str(data_value, acn_dmp_reason_code_vals, "reason not valid (%d)");\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 1, data_value, "%s %s", buffer, name);\r\ndata_address += adt->increment;\r\n}\r\noffset += 1;\r\nbreak;\r\ncase ACN_DMP_ADT_D_RE:\r\ncase ACN_DMP_ADT_D_RM:\r\ndata_address = adt->address;\r\nfor (x=0; x<adt->count; x++) {\r\nswitch (A) {\r\ncase ACN_DMP_ADT_A_1:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%2.2X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_2:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%4.4X ->", data_address);\r\nbreak;\r\ncase ACN_DMP_ADT_A_4:\r\ng_snprintf(buffer, BUFFER_SIZE, "Addr 0x%8.8X ->", data_address);\r\nbreak;\r\ndefault:\r\nreturn offset;\r\n}\r\ndata_value = tvb_get_guint8(tvb, offset);\r\nname = val_to_str(data_value, acn_dmp_reason_code_vals, "reason not valid (%d)");\r\nproto_tree_add_uint_format(tree, hf_acn_data8, tvb, offset, 1, data_value, "%s %s", buffer, name);\r\ndata_address += adt->increment;\r\noffset += 1;\r\n}\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic guint32\r\ndissect_acn_dmp_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nguint8 D;\r\nguint8 octet;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 header_offset;\r\nguint32 data_offset;\r\nguint32 old_offset;\r\nguint32 end_offset;\r\nguint32 data_length;\r\nguint32 address_count;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree = NULL;\r\nproto_tree *flag_tree = NULL;\r\nconst gchar *name;\r\nacn_dmp_adt_type adt = {0,0,0,0,0,0};\r\nacn_dmp_adt_type adt2 = {0,0,0,0,0,0};\r\nguint32 vector;\r\npdu_start = offset;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_dmp_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 1;\r\npdu_flvh_length++;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nvector = tvb_get_guint8(tvb, vector_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_dmp_vector, tvb, vector_offset, 1, vector);\r\nname = val_to_str(vector, acn_dmp_vector_vals, "not valid (%d)");\r\nproto_item_append_text(ti, ": ");\r\nproto_item_append_text(ti, "%s", name);\r\nif (pdu_flags & ACN_PDU_FLAG_H) {\r\nheader_offset = offset;\r\nlast_pdu_offsets->header = offset;\r\noffset += 1;\r\npdu_flvh_length++;\r\n} else {\r\nheader_offset = last_pdu_offsets->header;\r\n}\r\nacn_add_dmp_address_type(tvb, pinfo, pdu_tree, header_offset, &adt);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\ndata_length = last_pdu_offsets->data_length;\r\n}\r\nend_offset = data_offset + data_length;\r\nswitch (vector) {\r\ncase ACN_DMP_VECTOR_UNKNOWN:\r\nbreak;\r\ncase ACN_DMP_VECTOR_GET_PROPERTY:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_SET_PROPERTY:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_data(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_GET_PROPERTY_REPLY:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_data(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_EVENT:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_data(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_MAP_PROPERTY:\r\ndata_offset = acn_add_dmp_address_type(tvb, pinfo, pdu_tree, data_offset, &adt2);\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nD = ACN_DMP_ADT_EXTRACT_D(adt.flags);\r\nswitch (D) {\r\ncase ACN_DMP_ADT_D_NS:\r\naddress_count = 1;\r\nbreak;\r\ncase ACN_DMP_ADT_D_RS:\r\naddress_count = 1;\r\nbreak;\r\ncase ACN_DMP_ADT_D_RE:\r\naddress_count = adt.count;\r\nbreak;\r\ndefault:\r\nreturn pdu_start + pdu_length;\r\nbreak;\r\n}\r\nwhile (address_count > 0) {\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt2);\r\naddress_count--;\r\n}\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_UNMAP_PROPERTY:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_SUBSCRIBE:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_UNSUBSCRIBE:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_GET_PROPERTY_FAIL:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_reason_codes(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_SET_PROPERTY_FAIL:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_reason_codes(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_MAP_PROPERTY_FAIL:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_reason_codes(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_SUBSCRIBE_ACCEPT:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_SUBSCRIBE_REJECT:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_address(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\nadt.data_length = data_length - (data_offset - old_offset);\r\nold_offset = data_offset;\r\ndata_offset = acn_add_dmp_reason_codes(tvb, pinfo, pdu_tree, data_offset, &adt);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_DMP_VECTOR_ALLOCATE_MAP:\r\nbreak;\r\ncase ACN_DMP_VECTOR_ALLOCATE_MAP_REPLY:\r\nproto_tree_add_item(pdu_tree, hf_acn_dmp_reason_code, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\ncase ACN_DMP_VECTOR_DEALLOCATE_MAP:\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic guint32\r\ndissect_acn_sdt_wrapped_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nguint8 octet;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 data_offset;\r\nguint32 data_length;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree = NULL;\r\nproto_tree *flag_tree = NULL;\r\nconst gchar *name;\r\nguint32 vector;\r\npdu_start = offset;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_sdt_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 1;\r\npdu_flvh_length++;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nvector = tvb_get_guint8(tvb, vector_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_sdt_vector, tvb, vector_offset, 1, vector);\r\nname = val_to_str(vector, acn_sdt_vector_vals, "not valid (%d)");\r\nproto_item_append_text(ti, ": ");\r\nproto_item_append_text(ti, "%s", name);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\n}\r\nswitch (vector) {\r\ncase ACN_SDT_VECTOR_ACK:\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_CHANNEL_PARAMS:\r\ndata_offset = acn_add_channel_parameter(tvb, pinfo, pdu_tree, data_offset);\r\ndata_offset = acn_add_address(tvb, pinfo, pdu_tree, data_offset, "Ad-hoc Address:");\r\nacn_add_expiry(tvb, pinfo, pdu_tree, data_offset, hf_acn_adhoc_expiry);\r\nbreak;\r\ncase ACN_SDT_VECTOR_LEAVE:\r\nbreak;\r\ncase ACN_SDT_VECTOR_CONNECT:\r\nproto_tree_add_item(pdu_tree, hf_acn_protocol_id, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_CONNECT_ACCEPT:\r\nproto_tree_add_item(pdu_tree, hf_acn_protocol_id, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_CONNECT_REFUSE:\r\nproto_tree_add_item(pdu_tree, hf_acn_protocol_id, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_refuse_code, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_DISCONNECT:\r\nproto_tree_add_item(pdu_tree, hf_acn_protocol_id, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_DISCONNECTING:\r\nproto_tree_add_item(pdu_tree, hf_acn_protocol_id, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_reason_code, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic guint32\r\ndissect_acn_sdt_client_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nacn_pdu_offsets pdu_offsets = {0,0,0,0,0};\r\nguint8 octet;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 header_offset;\r\nguint32 data_offset;\r\nguint32 data_length;\r\nguint32 old_offset;\r\nguint32 end_offset;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree = NULL;\r\nproto_tree *flag_tree = NULL;\r\nconst gchar *name;\r\nguint32 member_id;\r\nguint32 protocol_id;\r\nguint16 association;\r\npdu_start = offset;\r\npdu_offsets.start = pdu_start;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_sdt_client_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 2;\r\npdu_flvh_length += 2;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nmember_id = tvb_get_ntohs(tvb, vector_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_member_id, tvb, vector_offset, 2, member_id);\r\nif (pdu_flags & ACN_PDU_FLAG_H) {\r\nheader_offset = offset;\r\nlast_pdu_offsets->header = offset;\r\noffset += 6;\r\npdu_flvh_length += 6;\r\n} else {\r\nheader_offset = last_pdu_offsets->header;\r\n}\r\nprotocol_id = tvb_get_ntohl(tvb, header_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_protocol_id, tvb, header_offset, 4, protocol_id);\r\nheader_offset += 4;\r\nname = val_to_str(protocol_id, acn_protocol_id_vals, "id not valid (%d)");\r\nproto_item_append_text(ti, ": ");\r\nproto_item_append_text(ti, "%s", name);\r\nassociation = tvb_get_ntohs(tvb, header_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_association, tvb, header_offset, 2, association);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\ndata_length = last_pdu_offsets->data_length;\r\n}\r\nend_offset = data_offset + data_length;\r\nswitch (protocol_id) {\r\ncase ACN_PROTOCOL_ID_SDT:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = dissect_acn_sdt_wrapped_pdu(tvb, pinfo, pdu_tree, data_offset, &pdu_offsets);\r\nif (old_offset == data_offset) break;\r\n}\r\nbreak;\r\ncase ACN_PROTOCOL_ID_DMP:\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = dissect_acn_dmp_pdu(tvb, pinfo, pdu_tree, data_offset, &pdu_offsets);\r\nif (data_offset == old_offset) break;\r\n}\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic char *\r\nltos(guint8 level, gchar *string, guint8 base, gchar leading_char, guint8 min_chars, gboolean show_zero)\r\n{\r\nguint8 i;\r\nif (base < 2 || base > 16) {\r\n*string = '\0';\r\nreturn(string);\r\n}\r\nif ((level == 0) && (!show_zero)) {\r\nfor (i=0; i<min_chars; i++) {\r\nstring[i] = '.';\r\n}\r\nstring[i++] = ' ';\r\nstring[i] = '\0';\r\nreturn(string + i);\r\n}\r\ni = 0;\r\ndo {\r\nstring[i++] = "0123456789ABCDEF"[level % base];\r\n} while ((level /= base) > 0);\r\nfor (; i<min_chars; i++) {\r\nstring[i] = leading_char;\r\n}\r\nstring[i] = '\0';\r\ng_strreverse(string);\r\nstring[i++] = ' ';\r\nstring[i] = '\0';\r\nreturn(string + i);\r\n}\r\nstatic guint32\r\ndissect_acn_dmx_data_pdu(guint32 protocol_id, tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nguint8 octet;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 data_offset;\r\nguint32 end_offset;\r\nguint32 data_length;\r\nguint32 header_offset;\r\nguint32 total_cnt;\r\nguint32 item_cnt;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree;\r\nproto_tree *flag_tree;\r\nacn_dmp_adt_type adt = {0,0,0,0,0,0};\r\nconst gchar *name;\r\nguint32 vector;\r\ngchar buffer[BUFFER_SIZE];\r\nchar *buf_ptr;\r\nguint x;\r\nguint8 level;\r\nguint8 min_char;\r\nguint8 base;\r\ngchar leading_char;\r\nguint perline;\r\nguint halfline;\r\nguint16 dmx_count;\r\nguint16 dmx_start_code;\r\nbuffer[0] = 0;\r\npdu_start = offset;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_dmx_data_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 1;\r\npdu_flvh_length += 1;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nvector = tvb_get_guint8(tvb, vector_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_dmp_vector, tvb, vector_offset, 1, vector);\r\nname = val_to_str(vector, acn_dmp_vector_vals, "not valid (%d)");\r\nproto_item_append_text(ti, ": ");\r\nproto_item_append_text(ti, "%s", name);\r\nif (pdu_flags & ACN_PDU_FLAG_H) {\r\nheader_offset = offset;\r\nlast_pdu_offsets->header = offset;\r\noffset += 1;\r\npdu_flvh_length++;\r\n} else {\r\nheader_offset = last_pdu_offsets->header;\r\n}\r\nacn_add_dmp_address_type(tvb, pinfo, pdu_tree, header_offset, &adt);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\ndata_length = last_pdu_offsets->data_length;\r\n}\r\nend_offset = data_offset + data_length;\r\nswitch (vector) {\r\ncase ACN_DMP_VECTOR_SET_PROPERTY:\r\ndmx_start_code = tvb_get_ntohs(tvb, data_offset);\r\nif (protocol_id==ACN_PROTOCOL_ID_DMX_2) {\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_2_first_property_address, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\n} else{\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_start_code, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\n}\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_increment, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\ndmx_count = tvb_get_ntohs(tvb, data_offset);\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_count, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nif (protocol_id==ACN_PROTOCOL_ID_DMX_2) {\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_2_start_code, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\ndata_offset += 1;\r\ndmx_count -= 1;\r\n}\r\nbuf_ptr = buffer;\r\nswitch (global_acn_dmx_display_line_format) {\r\ncase ACN_PREF_DMX_DISPLAY_16PL:\r\nperline = 16;\r\nhalfline = 8;\r\nbreak;\r\ndefault:\r\nperline = 20;\r\nhalfline = 10;\r\n}\r\nswitch ((guint)global_acn_dmx_display_view) {\r\ncase ACN_PREF_DMX_DISPLAY_HEX:\r\nmin_char = 2;\r\nbase = 16;\r\nbreak;\r\ndefault:\r\nmin_char = 3;\r\nbase = 10;\r\n}\r\nif (global_acn_dmx_display_leading_zeros) {\r\nleading_char = '0';\r\n} else {\r\nleading_char = ' ';\r\n}\r\ncol_append_fstr(pinfo->cinfo,COL_INFO, ", Sc %02x, [%02x %02x %02x %02x %02x %02x...]",\r\ndmx_start_code,\r\ntvb_get_guint8(tvb, data_offset),\r\ntvb_get_guint8(tvb, data_offset+1),\r\ntvb_get_guint8(tvb, data_offset+2),\r\ntvb_get_guint8(tvb, data_offset+3),\r\ntvb_get_guint8(tvb, data_offset+4),\r\ntvb_get_guint8(tvb, data_offset+5));\r\nfor (x=0; x<perline; x++) {\r\nbuf_ptr = ltos((guint8)(x+1), buf_ptr, 10, ' ', min_char, FALSE);\r\nif ((x+1)==halfline) {\r\n*buf_ptr++ = '|';\r\n*buf_ptr++ = ' ';\r\n}\r\n}\r\n*buf_ptr = '\0';\r\nproto_tree_add_string(pdu_tree, hf_acn_dmx_data, tvb, data_offset, dmx_count, buffer);\r\ng_snprintf(buffer, BUFFER_SIZE, "001-%03d: ", perline);\r\nbuf_ptr = buffer + 9;\r\ntotal_cnt = 0;\r\nitem_cnt = 0;\r\nfor (x=data_offset; x<end_offset; x++) {\r\nlevel = tvb_get_guint8(tvb, x);\r\nif (global_acn_dmx_display_view==ACN_PREF_DMX_DISPLAY_PER) {\r\nif ((level > 0) && (level < 3)) {\r\nlevel = 1;\r\n} else {\r\nlevel = level * 100 / 255;\r\n}\r\n}\r\nbuf_ptr = ltos(level, buf_ptr, base, leading_char, min_char, global_acn_dmx_display_zeros);\r\ntotal_cnt++;\r\nitem_cnt++;\r\nif (item_cnt == perline || x == (end_offset-1)) {\r\nproto_tree_add_string_format(pdu_tree, hf_acn_dmx_data, tvb, data_offset, item_cnt, buffer, "%s", buffer);\r\ndata_offset += perline;\r\ng_snprintf(buffer, BUFFER_SIZE, "%03d-%03d: ",total_cnt, total_cnt+perline);\r\nbuf_ptr = buffer + 9;\r\nitem_cnt = 0;\r\n} else {\r\nif (item_cnt == halfline) {\r\n*buf_ptr++ = '|';\r\n*buf_ptr++ = ' ';\r\n*buf_ptr = '\0';\r\n}\r\n}\r\n}\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic guint32\r\ndissect_acn_dmx_pdu(guint32 protocol_id, tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nacn_pdu_offsets pdu_offsets = {0,0,0,0,0};\r\nguint8 octet;\r\nguint8 option_flags;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 data_offset;\r\nguint32 data_length;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree;\r\nproto_tree *flag_tree;\r\nconst char *name;\r\nguint32 vector;\r\nguint32 universe;\r\nguint32 priority;\r\nguint32 sequence;\r\npdu_start = offset;\r\npdu_offsets.start = pdu_start;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_dmx_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 4;\r\npdu_flvh_length += 4;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nvector = tvb_get_ntohl(tvb, vector_offset);\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_vector, tvb, vector_offset, 4, ENC_BIG_ENDIAN);\r\nname = val_to_str(vector, acn_dmx_vector_vals, "not valid (%d)");\r\nproto_item_append_text(ti, ": %s", name);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\n}\r\nswitch (vector) {\r\ncase 0x02:\r\nif (protocol_id==ACN_PROTOCOL_ID_DMX_2) {\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_source_name, tvb, data_offset, 64, ENC_UTF_8|ENC_NA);\r\ndata_offset += 64;\r\n} else{\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_source_name, tvb, data_offset, 32, ENC_UTF_8|ENC_NA);\r\ndata_offset += 32;\r\n}\r\npriority = tvb_get_guint8(tvb, data_offset);\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_priority, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\ndata_offset += 1;\r\nif (protocol_id==ACN_PROTOCOL_ID_DMX_2) {\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_2_reserved, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\n}\r\nsequence = tvb_get_guint8(tvb, data_offset);\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_sequence_number, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\ndata_offset += 1;\r\nif (protocol_id == ACN_PROTOCOL_ID_DMX_2) {\r\noption_flags = tvb_get_guint8(tvb, data_offset);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_dmx_2_options, tvb, data_offset, 1, option_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_dmx_2_options);\r\nproto_tree_add_item(flag_tree, hf_acn_dmx_2_option_p, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_dmx_2_option_s, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\ndata_offset += 1;\r\n}\r\nuniverse = tvb_get_ntohs(tvb, data_offset);\r\nproto_tree_add_item(pdu_tree, hf_acn_dmx_universe , tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\ncol_append_fstr(pinfo->cinfo,COL_INFO, ", Universe %d, Seq %3d", universe, sequence );\r\nproto_item_append_text(ti, ", Universe: %d, Priority: %d", universe, priority);\r\ndissect_acn_dmx_data_pdu(protocol_id, tvb, pinfo, pdu_tree, data_offset, &pdu_offsets);\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic guint32\r\ndissect_acn_sdt_base_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nacn_pdu_offsets pdu_offsets = {0,0,0,0,0};\r\nguint8 octet;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 data_offset;\r\nguint32 end_offset;\r\nguint32 old_offset;\r\nguint32 data_length;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree;\r\nproto_tree *flag_tree;\r\nconst gchar *name;\r\nguint32 vector;\r\nguint32 member_id;\r\npdu_start = offset;\r\npdu_offsets.start = pdu_start;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_sdt_base_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 1;\r\npdu_flvh_length++;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nvector = tvb_get_guint8(tvb, vector_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_sdt_vector, tvb, vector_offset, 1, vector);\r\nname = val_to_str(vector, acn_sdt_vector_vals, "not valid (%d)");\r\nproto_item_append_text(ti, ": ");\r\nproto_item_append_text(ti, "%s", name);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\ndata_length = last_pdu_offsets->data_length;\r\n}\r\nend_offset = data_offset + data_length;\r\nswitch (vector) {\r\ncase ACN_SDT_VECTOR_UNKNOWN:\r\nbreak;\r\ncase ACN_SDT_VECTOR_REL_WRAP:\r\ncase ACN_SDT_VECTOR_UNREL_WRAP:\r\nproto_tree_add_item(pdu_tree, hf_acn_channel_number, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_total_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_oldest_available_wrapper, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_first_memeber_to_ack, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_last_memeber_to_ack, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_mak_threshold, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = dissect_acn_sdt_client_pdu(tvb, pinfo, pdu_tree, data_offset, &pdu_offsets);\r\nif (data_offset == old_offset) break;\r\n}\r\nbreak;\r\ncase ACN_SDT_VECTOR_CHANNEL_PARAMS:\r\nbreak;\r\ncase ACN_SDT_VECTOR_JOIN:\r\nproto_tree_add_item(pdu_tree, hf_acn_cid, tvb, data_offset, 16, ENC_BIG_ENDIAN);\r\ndata_offset += 16;\r\nproto_tree_add_item(pdu_tree, hf_acn_member_id, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_channel_number, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_reciprocal_channel, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_total_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\ndata_offset = acn_add_address(tvb, pinfo, pdu_tree, data_offset, "Destination Address:");\r\ndata_offset = acn_add_channel_parameter(tvb, pinfo, pdu_tree, data_offset);\r\nacn_add_expiry(tvb, pinfo, pdu_tree, data_offset, hf_acn_adhoc_expiry);\r\nbreak;\r\ncase ACN_SDT_VECTOR_JOIN_REFUSE:\r\npi = proto_tree_add_item(pdu_tree, hf_acn_cid, tvb, data_offset, 16, ENC_BIG_ENDIAN);\r\ndata_offset += 16;\r\nproto_item_append_text(pi, "(Leader)");\r\nproto_tree_add_item(pdu_tree, hf_acn_channel_number, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_member_id, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_refuse_code, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_JOIN_ACCEPT:\r\npi = proto_tree_add_item(pdu_tree, hf_acn_cid, tvb, data_offset, 16, ENC_BIG_ENDIAN);\r\ndata_offset += 16;\r\nproto_item_append_text(pi, "(Leader)");\r\nproto_tree_add_item(pdu_tree, hf_acn_channel_number, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_member_id, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_reciprocal_channel, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_LEAVE:\r\nbreak;\r\ncase ACN_SDT_VECTOR_LEAVING:\r\npi = proto_tree_add_item(pdu_tree, hf_acn_cid, tvb, data_offset, 16, ENC_BIG_ENDIAN);\r\ndata_offset += 16;\r\nproto_item_append_text(pi, "(Leader)");\r\nproto_tree_add_item(pdu_tree, hf_acn_channel_number, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_member_id, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_reason_code, tvb, data_offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_CONNECT:\r\nbreak;\r\ncase ACN_SDT_VECTOR_CONNECT_ACCEPT:\r\nbreak;\r\ncase ACN_SDT_VECTOR_CONNECT_REFUSE:\r\nbreak;\r\ncase ACN_SDT_VECTOR_DISCONNECT:\r\nbreak;\r\ncase ACN_SDT_VECTOR_DISCONNECTING:\r\nbreak;\r\ncase ACN_SDT_VECTOR_ACK:\r\nbreak;\r\ncase ACN_SDT_VECTOR_NAK:\r\npi = proto_tree_add_item(pdu_tree, hf_acn_cid, tvb, data_offset, 16, ENC_BIG_ENDIAN);\r\ndata_offset += 16;\r\nproto_item_append_text(pi, "(Leader)");\r\nproto_tree_add_item(pdu_tree, hf_acn_channel_number, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_member_id, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(pdu_tree, hf_acn_reliable_sequence_number, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_first_missed_sequence, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\ndata_offset += 4;\r\nproto_tree_add_item(pdu_tree, hf_acn_last_missed_sequence, tvb, data_offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_GET_SESSION:\r\nproto_tree_add_item(pdu_tree, hf_acn_cid, tvb, data_offset, 16, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase ACN_SDT_VECTOR_SESSIONS:\r\nmember_id = tvb_get_ntohs(tvb, data_offset);\r\nswitch (member_id) {\r\ncase 0:\r\nacn_add_channel_owner_info_block(tvb, pinfo, pdu_tree, data_offset);\r\nbreak;\r\ncase 1:\r\nacn_add_channel_member_info_block(tvb, pinfo, pdu_tree, data_offset);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic guint32\r\ndissect_acn_root_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, acn_pdu_offsets *last_pdu_offsets)\r\n{\r\nguint8 pdu_flags;\r\nguint32 pdu_start;\r\nguint32 pdu_length;\r\nguint32 pdu_flvh_length;\r\nacn_pdu_offsets pdu_offsets = {0,0,0,0,0};\r\nguint8 octet;\r\nguint32 length1;\r\nguint32 length2;\r\nguint32 length3;\r\nguint32 vector_offset;\r\nguint32 header_offset;\r\nguint32 data_offset;\r\nguint32 end_offset;\r\nguint32 old_offset;\r\nguint32 data_length;\r\nproto_item *ti, *pi;\r\nproto_tree *pdu_tree;\r\nproto_tree *flag_tree;\r\nguint32 protocol_id;\r\ne_guid_t guid;\r\npdu_start = offset;\r\npdu_offsets.start = pdu_start;\r\noctet = tvb_get_guint8(tvb, offset++);\r\npdu_flags = octet & 0xf0;\r\nlength1 = octet & 0x0f;\r\nlength2 = tvb_get_guint8(tvb, offset++);\r\nif (pdu_flags & ACN_PDU_FLAG_L) {\r\nlength3 = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\npdu_length = length3 | (length2 << 8) | (length1 << 16);\r\npdu_flvh_length = 3;\r\n} else {\r\npdu_length = length2 | (length1 << 8);\r\npdu_flvh_length = 2;\r\n}\r\nti = proto_tree_add_item(tree, hf_acn_pdu, tvb, pdu_start, pdu_length, ENC_NA);\r\npdu_tree = proto_item_add_subtree(ti, ett_acn_root_pdu);\r\npi = proto_tree_add_uint(pdu_tree, hf_acn_pdu_flags, tvb, pdu_start, 1, pdu_flags);\r\nflag_tree = proto_item_add_subtree(pi, ett_acn_pdu_flags);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_l, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_v, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_h, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_acn_pdu_flag_d, tvb, pdu_start, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(pdu_tree, hf_acn_pdu_length, tvb, pdu_start, pdu_flvh_length, pdu_length);\r\nif (pdu_flags & ACN_PDU_FLAG_V) {\r\nvector_offset = offset;\r\nlast_pdu_offsets->vector = offset;\r\noffset += 4;\r\npdu_flvh_length += 4;\r\n} else {\r\nvector_offset = last_pdu_offsets->vector;\r\n}\r\nprotocol_id = tvb_get_ntohl(tvb, vector_offset);\r\nproto_tree_add_uint(pdu_tree, hf_acn_protocol_id, tvb, vector_offset, 4, protocol_id);\r\nswitch (protocol_id) {\r\ncase ACN_PROTOCOL_ID_DMX:\r\ncase ACN_PROTOCOL_ID_DMX_2:\r\nif (global_acn_dmx_enable) {\r\nproto_item_append_text(ti,": Root DMX");\r\nif (pdu_flags & ACN_PDU_FLAG_H) {\r\nheader_offset = offset;\r\nlast_pdu_offsets->header = offset;\r\noffset += 16;\r\npdu_flvh_length += 16;\r\n} else {\r\nheader_offset = last_pdu_offsets->header;\r\n}\r\ntvb_get_guid(tvb, header_offset, &guid, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Src: %s", guid_to_str(wmem_packet_scope(), &guid));\r\ncol_add_fstr(pinfo->cinfo,COL_INFO, "CID %s", guid_to_str(wmem_packet_scope(), &guid));\r\nproto_tree_add_item(pdu_tree, hf_acn_cid, tvb, header_offset, 16, ENC_BIG_ENDIAN);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\ndata_length = last_pdu_offsets->data_length;\r\n}\r\nend_offset = data_offset + data_length;\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = dissect_acn_dmx_pdu(protocol_id, tvb, pinfo, pdu_tree, data_offset, &pdu_offsets);\r\nif (data_offset == old_offset) break;\r\n}\r\n}\r\nbreak;\r\ncase ACN_PROTOCOL_ID_SDT:\r\nproto_item_append_text(ti,": Root SDT");\r\nif (pdu_flags & ACN_PDU_FLAG_H) {\r\nheader_offset = offset;\r\nlast_pdu_offsets->header = offset;\r\noffset += 16;\r\npdu_flvh_length += 16;\r\n} else {\r\nheader_offset = last_pdu_offsets->header;\r\n}\r\ntvb_get_guid(tvb, header_offset, &guid, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Src: %s", guid_to_str(wmem_packet_scope(), &guid));\r\nproto_tree_add_item(pdu_tree, hf_acn_cid, tvb, header_offset, 16, ENC_BIG_ENDIAN);\r\nif (pdu_flags & ACN_PDU_FLAG_D) {\r\ndata_offset = offset;\r\ndata_length = pdu_length - pdu_flvh_length;\r\nlast_pdu_offsets->data = offset;\r\nlast_pdu_offsets->data_length = data_length;\r\n} else {\r\ndata_offset = last_pdu_offsets->data;\r\ndata_length = last_pdu_offsets->data_length;\r\n}\r\nend_offset = data_offset + data_length;\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = dissect_acn_sdt_base_pdu(tvb, pinfo, pdu_tree, data_offset, &pdu_offsets);\r\nif (data_offset == old_offset) break;\r\n}\r\nbreak;\r\n}\r\nreturn pdu_start + pdu_length;\r\n}\r\nstatic int\r\ndissect_acn(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *ti;\r\nproto_tree *acn_tree;\r\nguint32 data_offset = 0;\r\nguint32 old_offset;\r\nguint32 end_offset;\r\nacn_pdu_offsets pdu_offsets = {0,0,0,0,0};\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ACN");\r\ncol_add_fstr(pinfo->cinfo,COL_INFO, "ACN [Src Port: %d, Dst Port: %d]", pinfo->srcport, pinfo->destport );\r\nti = proto_tree_add_item(tree, proto_acn, tvb, 0, -1, ENC_NA);\r\nacn_tree = proto_item_add_subtree(ti, ett_acn);\r\nproto_tree_add_item(acn_tree, hf_acn_preamble_size, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(acn_tree, hf_acn_postamble_size, tvb, data_offset, 2, ENC_BIG_ENDIAN);\r\ndata_offset += 2;\r\nproto_tree_add_item(acn_tree, hf_acn_packet_identifier, tvb, data_offset, 12, ENC_UTF_8|ENC_NA);\r\ndata_offset += 12;\r\nend_offset = data_offset + tvb_reported_length_remaining(tvb, data_offset);\r\nwhile (data_offset < end_offset) {\r\nold_offset = data_offset;\r\ndata_offset = dissect_acn_root_pdu(tvb, pinfo, acn_tree, data_offset, &pdu_offsets);\r\nif (data_offset == old_offset) break;\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_acn(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_acn_ip_address_type,\r\n{ "Addr Type", "acn.ip_address_type",\r\nFT_UINT8, BASE_DEC, VALS(acn_ip_address_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_association,\r\n{ "Association", "acn.association",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_channel_number,\r\n{ "Channel Number", "acn.channel_number",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_cid,\r\n{ "CID", "acn.cid",\r\nFT_GUID, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_acn_client_protocol_id,\r\n{ "Client Protocol ID", "acn.client_protocol_id",\r\nFT_UINT32, BASE_DEC, VALS(acn_protocol_id_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_acn_data,\r\n{ "Data", "acn.dmp_data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_data8,\r\n{ "Addr", "acn.dmp_data8",\r\nFT_UINT8, BASE_DEC_HEX, NULL, 0x0,\r\n"Data8", HFILL }\r\n},\r\n{ &hf_acn_data16,\r\n{ "Addr", "acn.dmp_data16",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\n"Data16", HFILL }\r\n},\r\n{ &hf_acn_data24,\r\n{ "Addr", "acn.dmp_data24",\r\nFT_UINT24, BASE_DEC_HEX, NULL, 0x0,\r\n"Data24", HFILL }\r\n},\r\n{ &hf_acn_data32,\r\n{ "Addr", "acn.dmp_data32",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x0,\r\n"Data32", HFILL }\r\n},\r\n#if 0\r\n{ &hf_acn_dmp_adt,\r\n{ "Address and Data Type", "acn.dmp_adt",\r\nFT_UINT8, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_acn_dmp_adt_a,\r\n{ "Size", "acn.dmp_adt_a",\r\nFT_UINT8, BASE_DEC, VALS(acn_dmp_adt_a_vals), 0x03,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_adt_d,\r\n{ "Data Type", "acn.dmp_adt_d",\r\nFT_UINT8, BASE_DEC, VALS(acn_dmp_adt_d_vals), 0x30,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_adt_r,\r\n{ "Relative", "acn.dmp_adt_r",\r\nFT_UINT8, BASE_DEC, VALS(acn_dmp_adt_r_vals), 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_adt_v,\r\n{ "Virtual", "acn.dmp_adt_v",\r\nFT_UINT8, BASE_DEC, VALS(acn_dmp_adt_v_vals), 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_adt_x,\r\n{ "Reserved", "acn.dmp_adt_x",\r\nFT_UINT8, BASE_DEC, NULL, 0x0c,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_reason_code,\r\n{ "Reason Code", "acn.dmp_reason_code",\r\nFT_UINT8, BASE_DEC, VALS(acn_dmp_reason_code_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_vector,\r\n{ "DMP Vector", "acn.dmp_vector",\r\nFT_UINT8, BASE_DEC, VALS(acn_dmp_vector_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_actual_address,\r\n{ "Actual Address", "acn.dmp_actual_address",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_virtual_address,\r\n{ "Virtual Address", "acn.dmp_virtual_address",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_actual_address_first,\r\n{ "Actual Address First", "acn.dmp_actual_address_first",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmp_virtual_address_first,\r\n{ "Virtual Address First", "acn.dmp_virtual_address_first",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_expiry,\r\n{ "Expiry", "acn.expiry",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_first_memeber_to_ack,\r\n{ "First Member to ACK", "acn.first_member_to_ack",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_first_missed_sequence,\r\n{ "First Missed Sequence", "acn.first_missed_sequence",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_ipv4,\r\n{ "IPV4", "acn.ipv4",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_ipv6,\r\n{ "IPV6", "acn.ipv6",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_last_memeber_to_ack,\r\n{ "Last Member to ACK", "acn.last_member_to_ack",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_last_missed_sequence,\r\n{ "Last Missed Sequence", "acn.last_missed_sequence",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_mak_threshold,\r\n{ "MAK Threshold", "acn.mak_threshold",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_member_id,\r\n{ "Member ID", "acn.member_id",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_nak_holdoff,\r\n{ "NAK holdoff (ms)", "acn.nak_holdoff",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_nak_max_wait,\r\n{ "NAK Max Wait (ms)", "acn.nak_max_wait",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_nak_modulus,\r\n{ "NAK Modulus", "acn.nak_modulus",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_nak_outbound_flag,\r\n{ "NAK Outbound Flag", "acn.nak_outbound_flag",\r\nFT_BOOLEAN, 8, NULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_oldest_available_wrapper,\r\n{ "Oldest Available Wrapper", "acn.oldest_available_wrapper",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_preamble_size,\r\n{ "Size of preamble", "acn.preamble_size",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Preamble size in bytes", HFILL }\r\n},\r\n{ &hf_acn_packet_identifier,\r\n{ "Packet Identifier", "acn.packet_identifier",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_pdu,\r\n{ "PDU", "acn.pdu",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_pdu_flags,\r\n{ "Flags", "acn.pdu.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\n"PDU Flags", HFILL }\r\n},\r\n{ &hf_acn_pdu_flag_d,\r\n{ "Data", "acn.pdu.flag_d",\r\nFT_BOOLEAN, 8, NULL, ACN_PDU_FLAG_D,\r\n"Data flag", HFILL }\r\n},\r\n{ &hf_acn_pdu_flag_h,\r\n{ "Header", "acn.pdu.flag_h",\r\nFT_BOOLEAN, 8, NULL, ACN_PDU_FLAG_H,\r\n"Header flag", HFILL }\r\n},\r\n{ &hf_acn_pdu_flag_l,\r\n{ "Length", "acn.pdu.flag_l",\r\nFT_BOOLEAN, 8, NULL, ACN_PDU_FLAG_L,\r\n"Length flag", HFILL }\r\n},\r\n{ &hf_acn_pdu_flag_v,\r\n{ "Vector", "acn.pdu.flag_v",\r\nFT_BOOLEAN, 8, NULL, ACN_PDU_FLAG_V,\r\n"Vector flag", HFILL }\r\n},\r\n{ &hf_acn_pdu_length,\r\n{ "Length", "acn.pdu.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"PDU Length", HFILL }\r\n},\r\n{ &hf_acn_port,\r\n{ "Port", "acn.port",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_postamble_size,\r\n{ "Size of postamble", "acn.postamble_size",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Postamble size in bytes", HFILL }\r\n},\r\n{ &hf_acn_protocol_id,\r\n{ "Protocol ID", "acn.protocol_id",\r\nFT_UINT32, BASE_DEC, VALS(acn_protocol_id_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_reason_code,\r\n{ "Reason Code", "acn.reason_code",\r\nFT_UINT8, BASE_DEC, VALS(acn_reason_code_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_reciprocal_channel,\r\n{ "Reciprocal Channel Number", "acn.reciprocal_channel",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\n"Reciprocal Channel", HFILL }\r\n},\r\n{ &hf_acn_refuse_code,\r\n{ "Refuse Code", "acn.refuse_code",\r\nFT_UINT8, BASE_DEC, VALS(acn_refuse_code_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_reliable_sequence_number,\r\n{ "Reliable Sequence Number", "acn.reliable_sequence_number",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_adhoc_expiry,\r\n{ "Ad-hoc Expiry", "acn.adhoc_expiry",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_sdt_vector,\r\n{ "STD Vector", "acn.sdt_vector",\r\nFT_UINT8, BASE_DEC, VALS(acn_sdt_vector_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_acn_dmx_vector,\r\n{ "Vector", "acn.dmx_vector",\r\nFT_UINT32, BASE_DEC, VALS(acn_dmx_vector_vals), 0x0,\r\n"DMX Vector", HFILL }\r\n},\r\n{ &hf_acn_dmx_source_name,\r\n{ "Source", "acn.dmx.source_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"DMX Source Name", HFILL }\r\n},\r\n{ &hf_acn_dmx_priority,\r\n{ "Priority", "acn.dmx.priority",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"DMX Priority", HFILL }\r\n},\r\n{ &hf_acn_dmx_2_reserved,\r\n{ "Reserved", "acn.dmx.reserved",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"DMX Reserved", HFILL }\r\n},\r\n{ &hf_acn_dmx_sequence_number,\r\n{ "Seq No", "acn.dmx.seq_number",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"DMX Sequence Number", HFILL }\r\n},\r\n{ &hf_acn_dmx_2_options,\r\n{ "Options", "acn.dmx.options",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"DMX Options", HFILL }\r\n},\r\n{ &hf_acn_dmx_2_option_p,\r\n{ "Preview Data", "acn.dmx.option_p",\r\nFT_BOOLEAN, 8, NULL, ACN_DMX_OPTION_P,\r\n"Preview Data flag", HFILL }\r\n},\r\n{ &hf_acn_dmx_2_option_s,\r\n{ "Stream Terminated", "acn.dmx.option_s",\r\nFT_BOOLEAN, 8, NULL, ACN_DMX_OPTION_S,\r\n"Stream Terminated flag", HFILL }\r\n},\r\n{ &hf_acn_dmx_universe,\r\n{ "Universe", "acn.dmx.universe",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"DMX Universe", HFILL }\r\n},\r\n{ &hf_acn_dmx_start_code,\r\n{ "Start Code", "acn.dmx.start_code",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\n"DMX Start Code", HFILL }\r\n},\r\n{ &hf_acn_dmx_2_first_property_address,\r\n{ "First Property Address", "acn.dmx.start_code",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\n"DMX First Property Address", HFILL }\r\n},\r\n{ &hf_acn_dmx_increment,\r\n{ "Increment", "acn.dmx.increment",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"DMX Increment", HFILL }\r\n},\r\n{ &hf_acn_dmx_count,\r\n{ "Count", "acn.dmx.count",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"DMX Count", HFILL }\r\n},\r\n{ &hf_acn_dmx_2_start_code,\r\n{ "Start Code", "acn.dmx.start_code2",\r\nFT_UINT8, BASE_DEC_HEX, NULL, 0x0,\r\n"DMX Start Code", HFILL }\r\n},\r\n{ &hf_acn_dmx_data,\r\n{ "Data", "acn.dmx.data",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_acn_session_count,\r\n{ "Session Count", "acn.session_count",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_acn_total_sequence_number,\r\n{ "Total Sequence Number", "acn.total_sequence_number",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_acn,\r\n&ett_acn_channel_owner_info_block,\r\n&ett_acn_channel_member_info_block,\r\n&ett_acn_channel_parameter,\r\n&ett_acn_address,\r\n&ett_acn_address_type,\r\n&ett_acn_pdu_flags,\r\n&ett_acn_dmp_pdu,\r\n&ett_acn_sdt_pdu,\r\n&ett_acn_sdt_client_pdu,\r\n&ett_acn_sdt_base_pdu,\r\n&ett_acn_root_pdu,\r\n&ett_acn_dmx_address,\r\n&ett_acn_dmx_2_options,\r\n&ett_acn_dmx_data_pdu,\r\n&ett_acn_dmx_pdu\r\n};\r\nmodule_t *acn_module;\r\nproto_acn = proto_register_protocol (\r\n"Architecture for Control Networks",\r\n"ACN",\r\n"acn"\r\n);\r\nproto_register_field_array(proto_acn, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nacn_module = prefs_register_protocol(proto_acn, NULL);\r\nprefs_register_obsolete_preference(acn_module, "heuristic_acn");\r\nprefs_register_bool_preference(acn_module, "dmx_enable",\r\n"Streaming DMX",\r\n"Enable Streaming DMX extension dissector (ANSI BSR E1.31)",\r\n&global_acn_dmx_enable);\r\nprefs_register_enum_preference(acn_module, "dmx_display_view",\r\n"DMX, display format",\r\n"Display format",\r\n&global_acn_dmx_display_view,\r\ndmx_display_view,\r\nTRUE);\r\nprefs_register_bool_preference(acn_module, "dmx_display_zeros",\r\n"DMX, display zeros",\r\n"Display zeros instead of dots",\r\n&global_acn_dmx_display_zeros);\r\nprefs_register_bool_preference(acn_module, "dmx_display_leading_zeros",\r\n"DMX, display leading zeros",\r\n"Display leading zeros on levels",\r\n&global_acn_dmx_display_leading_zeros);\r\nprefs_register_enum_preference(acn_module, "dmx_display_line_format",\r\n"DMX, display line format",\r\n"Display line format",\r\n&global_acn_dmx_display_line_format,\r\ndmx_display_line_format,\r\nTRUE);\r\n}\r\nvoid\r\nproto_reg_handoff_acn(void)\r\n{\r\nheur_dissector_add("udp", dissect_acn_heur, "ACN over UDP", "acn_udp", proto_acn, HEURISTIC_DISABLE);\r\n}

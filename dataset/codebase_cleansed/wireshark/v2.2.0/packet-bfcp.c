static int\r\ndissect_bfcp_attributes(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, int bfcp_payload_length)\r\n{\r\nproto_item *ti, *item;\r\nproto_tree *bfcp_attr_tree = NULL;\r\ngint attr_start_offset;\r\ngint length;\r\nguint8 attribute_type;\r\ngint read_attr = 0;\r\nguint8 first_byte, pad_len;\r\nwhile ((tvb_reported_length_remaining(tvb, offset) >= 2) &&\r\n((bfcp_payload_length - read_attr) >= 2))\r\n{\r\nattr_start_offset = offset;\r\nfirst_byte = tvb_get_guint8(tvb, offset);\r\nif (first_byte == 0){\r\nread_attr++;\r\ncontinue;\r\n}\r\nti = proto_tree_add_item(tree, hf_bfcp_attribute_types, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nbfcp_attr_tree = proto_item_add_subtree(ti, ett_bfcp_attr);\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_attribute_types_m_bit, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nattribute_type = (first_byte & 0xFE) >> 1;\r\noffset++;\r\nitem = proto_tree_add_item(bfcp_attr_tree, hf_bfcp_attribute_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nlength = tvb_get_guint8(tvb, offset);\r\noffset++;\r\npad_len = 0;\r\nswitch(attribute_type){\r\ncase 1:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_beneficiary_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_floor_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_floor_request_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_priority, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nbreak;\r\ncase 5:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_request_status, tvb, offset,1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_queue_pos, tvb, offset,1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_error_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif(length>3){\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_error_specific_details, tvb, offset, length-3, ENC_NA);\r\n}\r\noffset = offset + length-3;\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 7:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_error_info_text, tvb, offset, length-3, ENC_ASCII|ENC_NA);\r\noffset = offset + length-3;\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 8:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_part_prov_info_text, tvb, offset, length-3, ENC_ASCII|ENC_NA);\r\noffset = offset + length-3;\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 9:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_status_info_text, tvb, offset, length-3, ENC_ASCII|ENC_NA);\r\noffset = offset + length-3;\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 10:\r\nwhile(offset < (attr_start_offset+length)){\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_supp_attr, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset+=1;\r\n}\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 11:\r\nwhile(offset < (attr_start_offset+length)){\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_supp_prim, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset+=1;\r\n}\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 12:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_user_disp_name, tvb, offset, length-3, ENC_ASCII|ENC_NA);\r\noffset = offset + length-3;\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 13:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_user_uri, tvb, offset, length-3, ENC_ASCII|ENC_NA);\r\noffset = offset + length-3;\r\npad_len = length & 0x03;\r\nif(pad_len != 0){\r\npad_len = 4 - pad_len;\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_padding, tvb, offset, pad_len, ENC_NA);\r\n}\r\noffset = offset + pad_len;\r\nbreak;\r\ncase 14:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_beneficiary_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\noffset = dissect_bfcp_attributes(tvb, pinfo, bfcp_attr_tree, offset, length -4);\r\nbreak;\r\ncase 15:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_floor_request_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\noffset = dissect_bfcp_attributes(tvb, pinfo, bfcp_attr_tree, offset, length -4);\r\nbreak;\r\ncase 16:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_req_by_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\noffset = dissect_bfcp_attributes(tvb, pinfo, bfcp_attr_tree, offset, length -4);\r\nbreak;\r\ncase 17:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_floor_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\noffset = dissect_bfcp_attributes(tvb, pinfo, bfcp_attr_tree, offset, length -4);\r\nbreak;\r\ncase 18:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_floor_request_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\noffset = dissect_bfcp_attributes(tvb, pinfo, bfcp_attr_tree, offset, length -4);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(bfcp_attr_tree, hf_bfcp_payload, tvb, offset, length-2, ENC_NA);\r\noffset = offset + length - 2;\r\nbreak;\r\n}\r\nif ((length+pad_len) < (offset - attr_start_offset)){\r\nexpert_add_info_format(pinfo, item, &ei_bfcp_attribute_length_too_small,\r\n"Attribute length is too small (%d bytes)", length);\r\nbreak;\r\n}\r\nread_attr = read_attr + length;\r\n}\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ndissect_bfcp_heur_check(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree _U_, void *data _U_)\r\n{\r\nguint8 primitive;\r\nguint8 first_byte;\r\nconst gchar *str;\r\nif (tvb_captured_length(tvb) < 12)\r\nreturn FALSE;\r\nfirst_byte = tvb_get_guint8(tvb, 0);\r\nif ((first_byte != 0x20) && (first_byte != 0x30))\r\nreturn FALSE;\r\nprimitive = tvb_get_guint8(tvb, 1);\r\nif ((primitive < 1) || (primitive > 18))\r\nreturn FALSE;\r\nstr = try_val_to_str(primitive, map_bfcp_primitive);\r\nif (NULL == str)\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_bfcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nint offset = 0;\r\nguint8 primitive;\r\nconst gchar *str;\r\ngint bfcp_payload_length;\r\nproto_tree *bfcp_tree;\r\nproto_item *ti;\r\nif (!dissect_bfcp_heur_check(tvb, pinfo, tree, data))\r\nreturn 0;\r\nprimitive = tvb_get_guint8(tvb, 1);\r\nstr = try_val_to_str(primitive, map_bfcp_primitive);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BFCP");\r\ncol_add_str(pinfo->cinfo, COL_INFO, str);\r\nti = proto_tree_add_item(tree, proto_bfcp, tvb, 0, -1, ENC_NA);\r\nbfcp_tree = proto_item_add_subtree(ti, ett_bfcp);\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_hdr_r_bit, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_hdr_f_bit, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_primitive, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_payload_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_conference_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_transaction_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nproto_tree_add_item(bfcp_tree, hf_bfcp_user_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nbfcp_payload_length = tvb_get_ntohs(tvb,\r\nBFCP_OFFSET_PAYLOAD_LENGTH) * 4;\r\ndissect_bfcp_attributes(tvb, pinfo, bfcp_tree, offset, bfcp_payload_length);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_bfcp_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nif (!dissect_bfcp_heur_check(tvb, pinfo, tree, data))\r\nreturn FALSE;\r\ndissect_bfcp(tvb, pinfo, tree, data);\r\nreturn TRUE;\r\n}\r\nvoid proto_register_bfcp(void)\r\n{\r\nmodule_t *bfcp_module;\r\nexpert_module_t* expert_bfcp;\r\nstatic hf_register_info hf[] = {\r\n{\r\n&hf_bfcp_version,\r\n{ "Version(ver)", "bfcp.ver",\r\nFT_UINT8, BASE_DEC, NULL, 0xe0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_hdr_r_bit,\r\n{ "Transaction Responder (R)", "bfcp.hdr_r_bit",\r\nFT_BOOLEAN, 8, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_hdr_f_bit,\r\n{ "Fragmentation (F)", "bfcp.hdr_f_bit",\r\nFT_BOOLEAN, 8, NULL, 0x08,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_primitive,\r\n{ "Primitive", "bfcp.primitive",\r\nFT_UINT8, BASE_DEC, VALS(map_bfcp_primitive), 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_payload_length,\r\n{ "Payload Length", "bfcp.payload_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_conference_id,\r\n{ "Conference ID", "bfcp.conference_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_transaction_id,\r\n{ "Transaction ID", "bfcp.transaction_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_user_id,\r\n{ "User ID", "bfcp.user_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_payload,\r\n{ "Payload", "bfcp.payload",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL,\r\nHFILL }\r\n},\r\n{\r\n&hf_bfcp_attribute_types,\r\n{ "Attribute Type", "bfcp.attribute_type",\r\nFT_UINT8, BASE_DEC, VALS(map_bfcp_attribute_types), 0xFE,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_attribute_types_m_bit,\r\n{ "Mandatory bit(M)", "bfcp.attribute_types_m_bit",\r\nFT_BOOLEAN, 8, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_attribute_length,\r\n{ "Attribute Length", "bfcp.attribute_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_beneficiary_id,\r\n{ "BENEFICIARY-ID", "bfcp.beneficiary_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_floor_id,\r\n{ "FLOOR-ID", "bfcp.floor_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_floor_request_id,\r\n{ "FLOOR-REQUEST-ID", "bfcp.floorrequest_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_priority,\r\n{ "FLOOR-REQUEST-ID", "bfcp.priority",\r\nFT_UINT16, BASE_DEC, NULL, 0xe000,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_request_status,\r\n{ "Request Status", "bfcp.request_status",\r\nFT_UINT8, BASE_DEC, VALS(map_bfcp_request_status), 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_queue_pos,\r\n{ "Queue Position", "bfcp.queue_pos",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_error_code,\r\n{ "Error Code", "bfcp.error_code",\r\nFT_UINT8, BASE_DEC, VALS(bfcp_error_code_valuse), 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_error_info_text,\r\n{ "Text", "bfcp.error_info_text",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_part_prov_info_text,\r\n{ "Text", "bfcp.part_prov_info_text",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_status_info_text,\r\n{ "Text", "bfcp.status_info_text",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_supp_attr,\r\n{ "Supported Attribute", "bfcp.supp_attr",\r\nFT_UINT8, BASE_DEC, VALS(map_bfcp_attribute_types), 0xFE,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_supp_prim,\r\n{ "Supported Primitive", "bfcp.supp_primitive",\r\nFT_UINT8, BASE_DEC, VALS(map_bfcp_primitive), 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_user_disp_name,\r\n{ "Name", "bfcp.user_disp_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_user_uri,\r\n{ "URI", "bfcp.user_uri",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_req_by_id,\r\n{ "Requested-by ID", "bfcp.req_by_i",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_padding,\r\n{ "Padding", "bfcp.padding",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{\r\n&hf_bfcp_error_specific_details,\r\n{ "Error Specific Details", "bfcp.error_specific_details",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_bfcp,\r\n&ett_bfcp_attr,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_bfcp_attribute_length_too_small, { "bfcp.attribute_length.too_small", PI_MALFORMED, PI_ERROR, "Attribute length is too small", EXPFILL }},\r\n};\r\nproto_bfcp = proto_register_protocol("Binary Floor Control Protocol",\r\n"BFCP", "bfcp");\r\nbfcp_handle = register_dissector("bfcp", dissect_bfcp, proto_bfcp);\r\nbfcp_module = prefs_register_protocol(proto_bfcp,\r\nproto_reg_handoff_bfcp);\r\nprefs_register_obsolete_preference(bfcp_module, "enable");\r\nproto_register_field_array(proto_bfcp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_bfcp = expert_register_protocol(proto_bfcp);\r\nexpert_register_field_array(expert_bfcp, ei, array_length(ei));\r\n}\r\nvoid proto_reg_handoff_bfcp(void)\r\n{\r\nstatic gboolean prefs_initialized = FALSE;\r\nif (!prefs_initialized)\r\n{\r\nheur_dissector_add("tcp", dissect_bfcp_heur, "BFCP over TCP", "bfcp_tcp", proto_bfcp, HEURISTIC_DISABLE);\r\nheur_dissector_add("udp", dissect_bfcp_heur, "BFCP over UDP", "bfcp_udp", proto_bfcp, HEURISTIC_DISABLE);\r\ndissector_add_for_decode_as("tcp.port", bfcp_handle);\r\ndissector_add_for_decode_as("udp.port", bfcp_handle);\r\nprefs_initialized = TRUE;\r\n}\r\n}

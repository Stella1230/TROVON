static void\r\nsfloat_ieee_11073_fvalue_new(fvalue_t *fv)\r\n{\r\nfv->value.sfloat_ieee_11073 = 0x0000;\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_val_from_unparsed(fvalue_t *fv, const char *s, gboolean allow_partial_value _U_, gchar **err_msg _U_)\r\n{\r\nconst char *i_char = s;\r\nchar c;\r\nguint8 mantissa_sign = 0;\r\nguint32 mantissa = 0;\r\ngint8 exponent = 0;\r\ngboolean fraction_mode = FALSE;\r\nconst guint16 mantissa_max = 0x07FF;\r\nc = *i_char;\r\nif (c== '\0')\r\nreturn FALSE;\r\nif (c == '.')\r\nreturn FALSE;\r\nif (c == '-' && s[1] == '.')\r\nreturn FALSE;\r\nif (c == '-' && (s[1] == 'I' || s[1] == 'i')) {\r\nif (!g_ascii_strcasecmp(s, "-INFINITY")) {\r\nfv->value.sfloat_ieee_11073 = SFLOAT_VALUE_INFINITY_MINUS;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n} else if (c == 'R' || c == 'r') {\r\nif (!g_ascii_strcasecmp(s, "RFU")) {\r\nfv->value.sfloat_ieee_11073 = SFLOAT_VALUE_RFU;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n} else if (c == 'N' || c == 'n') {\r\nif (!g_ascii_strcasecmp(s, "NRes")) {\r\nfv->value.sfloat_ieee_11073 = SFLOAT_VALUE_NRES;\r\nreturn TRUE;\r\n}\r\nif (!g_ascii_strcasecmp(s, "NaN")) {\r\nfv->value.sfloat_ieee_11073 = SFLOAT_VALUE_NAN;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n} else if (c == '+') {\r\nif (!g_ascii_strcasecmp(s, "+INFINITY")) {\r\nfv->value.sfloat_ieee_11073 = SFLOAT_VALUE_INFINITY_PLUS;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nif (c == '-') {\r\nif (s[1] == '\0')\r\nreturn FALSE;\r\nmantissa_sign = 1;\r\ni_char += 1;\r\n}\r\nwhile (*i_char == '0') {\r\ni_char += 1;\r\n}\r\nc = *i_char;\r\ndo {\r\nif (c == '0') {\r\nif (mantissa * 10 > (guint32) mantissa_max + mantissa_sign) {\r\nexponent += 1;\r\nif (exponent > 7)\r\nreturn FALSE;\r\n} else {\r\nmantissa *= 10;\r\n}\r\n} else if (c == '1') {\r\nmantissa *= 10;\r\nmantissa += 1;\r\n} else if (c == '2') {\r\nmantissa *= 10;\r\nmantissa += 2;\r\n} else if (c == '3') {\r\nmantissa *= 10;\r\nmantissa += 3;\r\n} else if (c == '4') {\r\nmantissa *= 10;\r\nmantissa += 4;\r\n} else if (c == '5') {\r\nmantissa *= 10;\r\nmantissa += 5;\r\n} else if (c == '6') {\r\nmantissa *= 10;\r\nmantissa += 6;\r\n} else if (c == '7') {\r\nmantissa *= 10;\r\nmantissa += 7;\r\n} else if (c == '8') {\r\nmantissa *= 10;\r\nmantissa += 8;\r\n} else if (c == '9') {\r\nmantissa *= 10;\r\nmantissa += 9;\r\n} else if (c == '.') {\r\nif (fraction_mode)\r\nreturn FALSE;\r\nfraction_mode = TRUE;\r\ni_char += 1;\r\nwhile (*i_char == '0') {\r\ni_char += 1;\r\nif (mantissa * 10 <= (guint32) mantissa_max + mantissa_sign) {\r\nmantissa *= 10;\r\nif (exponent > -8 - 4)\r\nexponent -= 1;\r\n}\r\n}\r\ni_char -= 1;\r\n} else if (c != '\0') {\r\nreturn FALSE;\r\n}\r\nif (mantissa > (guint32) mantissa_max + mantissa_sign)\r\nreturn FALSE;\r\nif (c != '.' && fraction_mode)\r\nexponent -= 1;\r\ni_char += 1;\r\n} while ((c = *i_char));\r\nif (mantissa_sign) {\r\nmantissa = ~(mantissa - 1);\r\nmantissa &= 0x0FFF;\r\n}\r\nif (mantissa == 0)\r\nexponent = 0;\r\nwhile (mantissa > 0 && mantissa % 10 == 0 && exponent < 7) {\r\nmantissa /= 10;\r\nexponent += 1;\r\n}\r\nif (exponent < -8)\r\nreturn FALSE;\r\nfv->value.sfloat_ieee_11073 = ((exponent & 0x0F) << 12) | mantissa;\r\nreturn TRUE;\r\n}\r\nstatic void\r\nsfloat_ieee_11073_val_to_repr(fvalue_t *fv, ftrepr_t rtype _U_, int field_display _U_, char *buf, unsigned int size)\r\n{\r\ngint8 exponent;\r\nguint16 mantissa;\r\nguint16 mantissa_sign;\r\nguint32 offset = 0;\r\ngchar mantissa_str[5];\r\nguint8 mantissa_digits;\r\nif (fv->value.sfloat_ieee_11073 >= 0x07FE && fv->value.sfloat_ieee_11073 <= 0x0802) {\r\nswitch (fv->value.sfloat_ieee_11073) {\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\ng_strlcpy(buf, "+INFINITY", size);\r\nbreak;\r\ncase SFLOAT_VALUE_NAN:\r\ng_strlcpy(buf, "NaN", size);\r\nbreak;\r\ncase SFLOAT_VALUE_NRES:\r\ng_strlcpy(buf, "NRes", size);\r\nbreak;\r\ncase SFLOAT_VALUE_RFU:\r\ng_strlcpy(buf, "RFU", size);\r\nbreak;\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\ng_strlcpy(buf, "-INFINITY", size);\r\nbreak;\r\n}\r\n}\r\nexponent = fv->value.sfloat_ieee_11073 >> 12;\r\nif (exponent & 0x8)\r\nexponent |= 0xF0;\r\nmantissa = fv->value.sfloat_ieee_11073 & 0x07FF;\r\nmantissa_sign = (fv->value.sfloat_ieee_11073 & 0x0800);\r\nif (mantissa_sign)\r\nmantissa = -((gint16)mantissa | 0xF800);\r\nif (mantissa == 0) {\r\nbuf[0] = '0';\r\nbuf[1] = '\0';\r\nreturn;\r\n}\r\nif (mantissa_sign) {\r\nbuf[0] = '-';\r\noffset += 1;\r\n}\r\nmantissa_digits = g_snprintf(mantissa_str, size, "%u", mantissa);\r\nif (exponent == 0) {\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits);\r\noffset += mantissa_digits;\r\n} else if (exponent > 0) {\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits);\r\noffset += mantissa_digits;\r\nmemset(buf + offset, '0', exponent);\r\noffset += exponent;\r\n} else {\r\nif (-exponent < mantissa_digits) {\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits + exponent);\r\noffset += mantissa_digits + exponent;\r\nbuf[offset] = '.';\r\noffset += 1;\r\nmemcpy(buf + offset, mantissa_str + mantissa_digits + exponent, -exponent);\r\noffset += -exponent;\r\n} else {\r\nbuf[offset] = '0';\r\noffset += 1;\r\nbuf[offset] = '.';\r\noffset += 1;\r\nif (-exponent - mantissa_digits > 0) {\r\nmemset(buf + offset, '0', -exponent - mantissa_digits);\r\noffset += -exponent - mantissa_digits;\r\n}\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits);\r\noffset += mantissa_digits;\r\n}\r\n}\r\nbuf[offset] = '\0';\r\n}\r\nstatic int\r\nsfloat_ieee_11073_val_repr_len(fvalue_t *fv _U_, ftrepr_t rtype _U_, int field_display _U_)\r\n{\r\nreturn 13;\r\n}\r\nstatic void\r\nsfloat_ieee_11073_value_set(fvalue_t *fv, guint32 value)\r\n{\r\nfv->value.sfloat_ieee_11073 = (guint16) value;\r\n}\r\nstatic guint32\r\nsfloat_ieee_11073_value_get(fvalue_t *fv)\r\n{\r\nreturn (guint32) fv->value.sfloat_ieee_11073;\r\n}\r\nstatic guint16 sfloat_to_normal_form(guint16 value)\r\n{\r\ngint8 exponent;\r\nguint16 mantissa;\r\nguint8 mantissa_sign;\r\nif (value >= 0x07FE && value <= 0x0802)\r\nreturn value;\r\nmantissa = value & 0x07FF;\r\nif (value & 0x0800) {\r\nmantissa = -((gint16)mantissa | 0xF800);\r\nmantissa_sign = 1;\r\n} else {\r\nmantissa_sign = 0;\r\n}\r\nexponent = value >> 12;\r\nif (exponent & 0x08) {\r\nexponent |= 0xF0;\r\n}\r\nwhile ((!(mantissa % 10)) && mantissa != 0) {\r\nmantissa /= 10;\r\nif (exponent == 7)\r\nbreak;\r\nexponent += 1;\r\n}\r\nreturn ((((exponent & 0x80) ? 0x8 : 0x0 ) | (exponent & 0x7)) << 12) | (mantissa_sign << 11) | mantissa;\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_eq(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn sfloat_to_normal_form(a->value.sfloat_ieee_11073) == sfloat_to_normal_form(b->value.sfloat_ieee_11073);\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_ne(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn sfloat_to_normal_form(a->value.sfloat_ieee_11073) != sfloat_to_normal_form(b->value.sfloat_ieee_11073);\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_gt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint16 a_norm;\r\nguint16 b_norm;\r\ngint16 a_norm_mantissa;\r\ngint16 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = sfloat_to_normal_form(a->value.sfloat_ieee_11073);\r\nb_norm = sfloat_to_normal_form(b->value.sfloat_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn FALSE;\r\nswitch (a_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\nswitch (b_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x0FFF;\r\nb_norm_mantissa = b_norm & 0x0FFF;\r\nif (a_norm & 0x0800)\r\na_norm_mantissa |= 0xF000;\r\nif (b_norm & 0x0800)\r\nb_norm_mantissa |= 0xF000;\r\na_norm_exponent = a_norm >> 12;\r\nb_norm_exponent = b_norm >> 12;\r\nif (a_norm_exponent & 0x08) {\r\na_norm_exponent |= 0xF0;\r\n}\r\nif (b_norm_exponent & 0x08) {\r\nb_norm_exponent |= 0xF0;\r\n}\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent > b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa > b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa > b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_ge(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint16 a_norm;\r\nguint16 b_norm;\r\ngint16 a_norm_mantissa;\r\ngint16 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = sfloat_to_normal_form(a->value.sfloat_ieee_11073);\r\nb_norm = sfloat_to_normal_form(b->value.sfloat_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn TRUE;\r\nswitch (a_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\nswitch (b_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x0FFF;\r\nb_norm_mantissa = b_norm & 0x0FFF;\r\nif (a_norm & 0x0800)\r\na_norm_mantissa |= 0xF000;\r\nif (b_norm & 0x0800)\r\nb_norm_mantissa |= 0xF000;\r\na_norm_exponent = a_norm >> 12;\r\nb_norm_exponent = b_norm >> 12;\r\nif (a_norm_exponent & 0x08) {\r\na_norm_exponent |= 0xF0;\r\n}\r\nif (b_norm_exponent & 0x08) {\r\nb_norm_exponent |= 0xF0;\r\n}\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent >= b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa >= b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa > b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_lt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint16 a_norm;\r\nguint16 b_norm;\r\ngint16 a_norm_mantissa;\r\ngint16 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = sfloat_to_normal_form(a->value.sfloat_ieee_11073);\r\nb_norm = sfloat_to_normal_form(b->value.sfloat_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn FALSE;\r\nswitch (a_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\nswitch (b_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x0FFF;\r\nb_norm_mantissa = b_norm & 0x0FFF;\r\nif (a_norm & 0x0800)\r\na_norm_mantissa |= 0xFFFFF000;\r\nif (b_norm & 0x0800)\r\nb_norm_mantissa |= 0xFFFFF000;\r\na_norm_exponent = a_norm >> 12;\r\nb_norm_exponent = b_norm >> 12;\r\nif (a_norm_exponent & 0x08) {\r\na_norm_exponent |= 0xF0;\r\n}\r\nif (b_norm_exponent & 0x08) {\r\nb_norm_exponent |= 0xF0;\r\n}\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent < b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa < b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa < b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_le(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint16 a_norm;\r\nguint16 b_norm;\r\ngint16 a_norm_mantissa;\r\ngint16 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = sfloat_to_normal_form(a->value.sfloat_ieee_11073);\r\nb_norm = sfloat_to_normal_form(b->value.sfloat_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn TRUE;\r\nswitch (a_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\nswitch (b_norm) {\r\ncase SFLOAT_VALUE_NAN:\r\ncase SFLOAT_VALUE_NRES:\r\ncase SFLOAT_VALUE_RFU:\r\ncase SFLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase SFLOAT_VALUE_INFINITY_PLUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x0FFF;\r\nb_norm_mantissa = b_norm & 0x0FFF;\r\nif (a_norm & 0x0800)\r\na_norm_mantissa |= 0xF000;\r\nif (b_norm & 0x0800)\r\nb_norm_mantissa |= 0xF000;\r\na_norm_exponent = a_norm >> 12;\r\nb_norm_exponent = b_norm >> 12;\r\nif (a_norm_exponent & 0x08) {\r\na_norm_exponent |= 0xF0;\r\n}\r\nif (b_norm_exponent & 0x08) {\r\nb_norm_exponent |= 0xF0;\r\n}\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent <= b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa <= b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 4)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa < b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nsfloat_ieee_11073_cmp_bitwise_and(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn ((a->value.uinteger & b->value.uinteger) != 0);\r\n}\r\nstatic void\r\nfloat_ieee_11073_fvalue_new(fvalue_t *fv)\r\n{\r\nfv->value.float_ieee_11073 = 0x0000;\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_val_from_unparsed(fvalue_t *fv, const char *s, gboolean allow_partial_value _U_, gchar **err_msg _U_)\r\n{\r\nconst char *i_char = s;\r\nchar c;\r\nguint8 mantissa_sign = 0;\r\nguint32 mantissa = 0;\r\ngint16 exponent = 0;\r\ngboolean fraction_mode = FALSE;\r\nconst guint32 mantissa_max = 0x007FFFFF;\r\nc = *i_char;\r\nif (c== '\0')\r\nreturn FALSE;\r\nif (c == '.')\r\nreturn FALSE;\r\nif (c == '-' && s[1] == '.')\r\nreturn FALSE;\r\nif (c == '-' && (s[1] == 'I' || s[1] == 'i')) {\r\nif (!g_ascii_strcasecmp(s, "-INFINITY")) {\r\nfv->value.float_ieee_11073 = FLOAT_VALUE_INFINITY_MINUS;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n} else if (c == 'R' || c == 'r') {\r\nif (!g_ascii_strcasecmp(s, "RFU")) {\r\nfv->value.float_ieee_11073 = FLOAT_VALUE_RFU;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n} else if (c == 'N' || c == 'n') {\r\nif (!g_ascii_strcasecmp(s, "NRes")) {\r\nfv->value.float_ieee_11073 = FLOAT_VALUE_NRES;\r\nreturn TRUE;\r\n}\r\nif (!g_ascii_strcasecmp(s, "NaN")) {\r\nfv->value.float_ieee_11073 = FLOAT_VALUE_NAN;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n} else if (c == '+') {\r\nif (!g_ascii_strcasecmp(s, "+INFINITY")) {\r\nfv->value.float_ieee_11073 = FLOAT_VALUE_INFINITY_PLUS;\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nif (c == '-') {\r\nif (s[1] == '\0')\r\nreturn FALSE;\r\nmantissa_sign = 1;\r\ni_char += 1;\r\n}\r\nwhile (*i_char == '0') {\r\ni_char += 1;\r\n}\r\nc = *i_char;\r\ndo {\r\nif (c == '0') {\r\nif (mantissa * 10 > mantissa_sign + mantissa_max) {\r\nexponent += 1;\r\nif (exponent <= 127)\r\nreturn FALSE;\r\n} else {\r\nmantissa *= 10;\r\n}\r\n} else if (c == '1') {\r\nmantissa *= 10;\r\nmantissa += 1;\r\n} else if (c == '2') {\r\nmantissa *= 10;\r\nmantissa += 2;\r\n} else if (c == '3') {\r\nmantissa *= 10;\r\nmantissa += 3;\r\n} else if (c == '4') {\r\nmantissa *= 10;\r\nmantissa += 4;\r\n} else if (c == '5') {\r\nmantissa *= 10;\r\nmantissa += 5;\r\n} else if (c == '6') {\r\nmantissa *= 10;\r\nmantissa += 6;\r\n} else if (c == '7') {\r\nmantissa *= 10;\r\nmantissa += 7;\r\n} else if (c == '8') {\r\nmantissa *= 10;\r\nmantissa += 8;\r\n} else if (c == '9') {\r\nmantissa *= 10;\r\nmantissa += 9;\r\n} else if (c == '.') {\r\nif (fraction_mode)\r\nreturn FALSE;\r\nfraction_mode = TRUE;\r\ni_char += 1;\r\nwhile (*i_char == '0') {\r\ni_char += 1;\r\nif (mantissa * 10 <= mantissa_max + mantissa_sign) {\r\nmantissa *= 10;\r\nif (exponent > -128 - 7)\r\nexponent -= 1;\r\n}\r\n}\r\ni_char -= 1;\r\n} else if (c != '\0') {\r\nreturn FALSE;\r\n}\r\nif (mantissa > mantissa_max + mantissa_sign)\r\nreturn FALSE;\r\nif (c != '.' && fraction_mode)\r\nexponent -= 1;\r\ni_char += 1;\r\n} while ((c = *i_char));\r\nif (mantissa_sign) {\r\nmantissa = ~(mantissa - 1);\r\nmantissa &= 0x00FFFFFF;\r\n}\r\nif (mantissa == 0)\r\nexponent = 0;\r\nwhile (mantissa > 0 && mantissa % 10 == 0 && exponent < 127) {\r\nmantissa /= 10;\r\nexponent += 1;\r\n}\r\nif (exponent < -128)\r\nreturn FALSE;\r\nfv->value.float_ieee_11073 = ((exponent & 0xFF) << 24) | mantissa;\r\nreturn TRUE;\r\n}\r\nstatic void\r\nfloat_ieee_11073_val_to_repr(fvalue_t *fv, ftrepr_t rtype _U_, int field_display _U_, char *buf, unsigned int size)\r\n{\r\ngint8 exponent;\r\nguint32 mantissa;\r\nguint32 mantissa_sign;\r\nguint32 offset = 0;\r\ngchar mantissa_str[8];\r\nguint8 mantissa_digits;\r\nif (fv->value.float_ieee_11073 >= 0x007FFFFE && fv->value.float_ieee_11073 <= 0x00800002) {\r\nswitch (fv->value.float_ieee_11073) {\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\ng_strlcpy(buf, "+INFINITY", size);\r\nbreak;\r\ncase FLOAT_VALUE_NAN:\r\ng_strlcpy(buf, "NaN", size);\r\nbreak;\r\ncase FLOAT_VALUE_NRES:\r\ng_strlcpy(buf, "NRes", size);\r\nbreak;\r\ncase FLOAT_VALUE_RFU:\r\ng_strlcpy(buf, "RFU", size);\r\nbreak;\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\ng_strlcpy(buf, "-INFINITY", size);\r\nbreak;\r\n}\r\n}\r\nexponent = fv->value.float_ieee_11073 >> 24;\r\nmantissa = fv->value.float_ieee_11073 & 0x007FFFFF;\r\nmantissa_sign = (fv->value.float_ieee_11073 & 0x00800000);\r\nif (mantissa_sign)\r\nmantissa = (guint32)(-((gint32)(mantissa | 0xFF000000)));\r\nif (mantissa == 0) {\r\nbuf[0] = '0';\r\nbuf[1] = '\0';\r\nreturn;\r\n}\r\nif (mantissa_sign) {\r\nbuf[0] = '-';\r\noffset += 1;\r\n}\r\nmantissa_digits = g_snprintf(mantissa_str, size, "%u", mantissa);\r\nif (exponent == 0) {\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits);\r\noffset += mantissa_digits;\r\n} else if (exponent > 0) {\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits);\r\noffset += mantissa_digits;\r\nmemset(buf + offset, '0', exponent);\r\noffset += exponent;\r\n} else {\r\nif (-exponent < mantissa_digits) {\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits + exponent);\r\noffset += mantissa_digits + exponent;\r\nbuf[offset] = '.';\r\noffset += 1;\r\nmemcpy(buf + offset, mantissa_str + mantissa_digits + exponent, -exponent);\r\noffset += -exponent;\r\n} else {\r\nbuf[offset] = '0';\r\noffset += 1;\r\nbuf[offset] = '.';\r\noffset += 1;\r\nif (-exponent - mantissa_digits > 0) {\r\nmemset(buf + offset, '0', -exponent - mantissa_digits);\r\noffset += -exponent - mantissa_digits;\r\n}\r\nmemcpy(buf + offset, mantissa_str, mantissa_digits);\r\noffset += mantissa_digits;\r\n}\r\n}\r\nbuf[offset] = '\0';\r\n}\r\nstatic int\r\nfloat_ieee_11073_val_repr_len(fvalue_t *fv _U_, ftrepr_t rtype _U_, int field_display _U_)\r\n{\r\nreturn 136;\r\n}\r\nstatic void\r\nfloat_ieee_11073_value_set(fvalue_t *fv, guint32 value)\r\n{\r\nfv->value.float_ieee_11073 = value;\r\n}\r\nstatic guint32\r\nfloat_ieee_11073_value_get(fvalue_t *fv)\r\n{\r\nreturn fv->value.float_ieee_11073;\r\n}\r\nstatic guint32 float_to_normal_form(guint32 value)\r\n{\r\ngint8 exponent;\r\nguint16 mantissa;\r\nguint8 mantissa_sign;\r\nif (value >= 0x007FFFFE && value <= 0x00800002)\r\nreturn value;\r\nmantissa = value & 0x907FFFFF;\r\nif (value & 0x00800000) {\r\nmantissa = (guint32)(-((gint32)(mantissa | 0xFF000000)));\r\nmantissa_sign = 1;\r\n} else {\r\nmantissa_sign = 0;\r\n}\r\nexponent = value >> 24;\r\nwhile ((!(mantissa % 10)) && mantissa != 0) {\r\nmantissa /= 10;\r\nif (exponent == 127)\r\nbreak;\r\nexponent += 1;\r\n}\r\nreturn (exponent << 24) | (mantissa_sign << 23) | mantissa;\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_eq(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn float_to_normal_form(a->value.float_ieee_11073) == float_to_normal_form(b->value.float_ieee_11073);\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_ne(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn float_to_normal_form(a->value.float_ieee_11073) != float_to_normal_form(b->value.float_ieee_11073);\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_gt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint32 a_norm;\r\nguint32 b_norm;\r\ngint32 a_norm_mantissa;\r\ngint32 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = float_to_normal_form(a->value.float_ieee_11073);\r\nb_norm = float_to_normal_form(b->value.float_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn FALSE;\r\nswitch (a_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\nswitch (b_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x00FFFFFF;\r\nb_norm_mantissa = b_norm & 0x00FFFFFF;\r\nif (a_norm & 0x00800000)\r\na_norm_mantissa |= 0xFF000000;\r\nif (b_norm & 0x00800000)\r\nb_norm_mantissa |= 0xFF000000;\r\na_norm_exponent = a_norm >> 24;\r\nb_norm_exponent = b_norm >> 24;\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent > b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa > b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa > b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_ge(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint32 a_norm;\r\nguint32 b_norm;\r\ngint32 a_norm_mantissa;\r\ngint32 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = float_to_normal_form(a->value.float_ieee_11073);\r\nb_norm = float_to_normal_form(b->value.float_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn TRUE;\r\nswitch (a_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\nswitch (b_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x00FFFFFF;\r\nb_norm_mantissa = b_norm & 0x00FFFFFF;\r\nif (a_norm & 0x00800000)\r\na_norm_mantissa |= 0xFF000000;\r\nif (b_norm & 0x00800000)\r\nb_norm_mantissa |= 0xFF000000;\r\na_norm_exponent = a_norm >> 24;\r\nb_norm_exponent = b_norm >> 24;\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent >= b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa >= b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa > b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_lt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint32 a_norm;\r\nguint32 b_norm;\r\ngint32 a_norm_mantissa;\r\ngint32 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = float_to_normal_form(a->value.float_ieee_11073);\r\nb_norm = float_to_normal_form(b->value.float_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn FALSE;\r\nswitch (a_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\nswitch (b_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x00FFFFFF;\r\nb_norm_mantissa = b_norm & 0x00FFFFFF;\r\nif (a_norm & 0x00800000)\r\na_norm_mantissa |= 0xFF000000;\r\nif (b_norm & 0x00800000)\r\nb_norm_mantissa |= 0xFF000000;\r\na_norm_exponent = a_norm >> 24;\r\nb_norm_exponent = b_norm >> 24;\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent < b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa < b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa < b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_le(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nguint32 a_norm;\r\nguint32 b_norm;\r\ngint32 a_norm_mantissa;\r\ngint32 b_norm_mantissa;\r\ngint8 a_norm_exponent;\r\ngint8 b_norm_exponent;\r\na_norm = float_to_normal_form(a->value.float_ieee_11073);\r\nb_norm = float_to_normal_form(b->value.float_ieee_11073);\r\nif (a_norm == b_norm)\r\nreturn TRUE;\r\nswitch (a_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\nswitch (b_norm) {\r\ncase FLOAT_VALUE_NAN:\r\ncase FLOAT_VALUE_NRES:\r\ncase FLOAT_VALUE_RFU:\r\ncase FLOAT_VALUE_INFINITY_MINUS:\r\nreturn FALSE;\r\ncase FLOAT_VALUE_INFINITY_PLUS:\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\na_norm_mantissa = a_norm & 0x00FFFFFF;\r\nb_norm_mantissa = b_norm & 0x00FFFFFF;\r\nif (a_norm & 0x00800000)\r\na_norm_mantissa |= 0xFF000000;\r\nif (b_norm & 0x00800000)\r\nb_norm_mantissa |= 0xFF000000;\r\na_norm_exponent = a_norm >> 24;\r\nb_norm_exponent = b_norm >> 24;\r\nif (a_norm_mantissa == b_norm_mantissa && a_norm_exponent <= b_norm_exponent)\r\nreturn TRUE;\r\nif (a_norm_exponent == b_norm_exponent && a_norm_mantissa <= b_norm_mantissa)\r\nreturn TRUE;\r\nif (a_norm_exponent < b_norm_exponent) {\r\nguint8 exponent_difference;\r\nexponent_difference = b_norm_exponent - a_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn TRUE;\r\nwhile (exponent_difference--) {\r\nb_norm_mantissa *= 10;\r\n}\r\n} else {\r\nguint8 exponent_difference;\r\nexponent_difference = a_norm_exponent - b_norm_exponent;\r\nif (exponent_difference >= 7)\r\nreturn FALSE;\r\nwhile (exponent_difference--) {\r\na_norm_mantissa *= 10;\r\n}\r\n}\r\nif (a_norm_mantissa < b_norm_mantissa)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfloat_ieee_11073_cmp_bitwise_and(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn ((a->value.uinteger & b->value.uinteger) != 0);\r\n}\r\nvoid\r\nftype_register_ieee_11073_float(void)\r\n{\r\nstatic ftype_t sfloat_type = {\r\nFT_IEEE_11073_SFLOAT,\r\n"FT_IEEE_11073_SFLOAT",\r\n"IEEE-11073 Floating point (16-bit)",\r\n2,\r\nsfloat_ieee_11073_fvalue_new,\r\nNULL,\r\nsfloat_ieee_11073_val_from_unparsed,\r\nNULL,\r\nsfloat_ieee_11073_val_to_repr,\r\nsfloat_ieee_11073_val_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nsfloat_ieee_11073_value_set,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nsfloat_ieee_11073_value_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nsfloat_ieee_11073_cmp_eq,\r\nsfloat_ieee_11073_cmp_ne,\r\nsfloat_ieee_11073_cmp_gt,\r\nsfloat_ieee_11073_cmp_ge,\r\nsfloat_ieee_11073_cmp_lt,\r\nsfloat_ieee_11073_cmp_le,\r\nsfloat_ieee_11073_cmp_bitwise_and,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\n};\r\nstatic ftype_t float_type = {\r\nFT_IEEE_11073_FLOAT,\r\n"FT_IEEE_11073_FLOAT",\r\n"IEEE-11073 Floating point (32-bit)",\r\n4,\r\nfloat_ieee_11073_fvalue_new,\r\nNULL,\r\nfloat_ieee_11073_val_from_unparsed,\r\nNULL,\r\nfloat_ieee_11073_val_to_repr,\r\nfloat_ieee_11073_val_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nfloat_ieee_11073_value_set,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nfloat_ieee_11073_value_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nfloat_ieee_11073_cmp_eq,\r\nfloat_ieee_11073_cmp_ne,\r\nfloat_ieee_11073_cmp_gt,\r\nfloat_ieee_11073_cmp_ge,\r\nfloat_ieee_11073_cmp_lt,\r\nfloat_ieee_11073_cmp_le,\r\nfloat_ieee_11073_cmp_bitwise_and,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\n};\r\nftype_register(FT_IEEE_11073_SFLOAT, &sfloat_type);\r\nftype_register(FT_IEEE_11073_FLOAT, &float_type);\r\n}

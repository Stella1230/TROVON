gchar *\r\ndissect_e212_mcc_mnc_wmem_packet_str(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, e212_number_type_t number_type, gboolean little_endian)\r\n{\r\nint start_offset, mcc_mnc;\r\nguint8 octet;\r\nguint16 mcc, mnc;\r\nguint8 mcc1, mcc2, mcc3, mnc1, mnc2, mnc3;\r\nproto_item *item;\r\ngchar *mcc_mnc_str;\r\ngboolean long_mnc = FALSE;\r\nint hf_E212_mcc_id, hf_E212_mnc_id;\r\nswitch(number_type){\r\ncase E212_LAI:\r\nhf_E212_mcc_id = hf_E212_mcc_lai;\r\nhf_E212_mnc_id = hf_E212_mnc_lai;\r\nbreak;\r\ncase E212_RAI:\r\nhf_E212_mcc_id = hf_E212_mcc_rai;\r\nhf_E212_mnc_id = hf_E212_mnc_rai;\r\nbreak;\r\ncase E212_SAI:\r\nhf_E212_mcc_id = hf_E212_mcc_sai;\r\nhf_E212_mnc_id = hf_E212_mnc_sai;\r\nbreak;\r\ndefault:\r\nhf_E212_mcc_id = hf_E212_mcc;\r\nhf_E212_mnc_id = hf_E212_mnc;\r\n}\r\nstart_offset = offset;\r\nmcc_mnc = tvb_get_ntoh24(tvb,offset);\r\noctet = tvb_get_guint8(tvb,offset);\r\nmcc1 = octet & 0x0f;\r\nmcc2 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmcc3 = octet & 0x0f;\r\nmnc3 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmnc1 = octet & 0x0f;\r\nmnc2 = octet >> 4;\r\nmcc = 100 * mcc1 + 10 * mcc2 + mcc3;\r\nmnc = 10 * mnc1 + mnc2;\r\nif ((mnc3 != 0xf) || (mcc_mnc == 0xffffff)) {\r\nlong_mnc = TRUE;\r\nif(little_endian)\r\nmnc = 10 * mnc + mnc3;\r\nelse\r\nmnc = 100 * mnc3 + mnc;\r\n}\r\nitem = proto_tree_add_uint(tree, hf_E212_mcc_id , tvb, start_offset, 2, mcc );\r\nif (((mcc1 > 9) || (mcc2 > 9) || (mcc3 > 9)) && (mcc_mnc != 0xffffff))\r\nexpert_add_info(pinfo, item, &ei_E212_mcc_non_decimal);\r\nif (long_mnc) {\r\nitem = proto_tree_add_uint_format_value(tree, hf_E212_mnc_id , tvb, start_offset + 1, 2, mnc,\r\n"%s (%03u)",\r\nval_to_str_ext_const(mcc * 1000 + mnc, &mcc_mnc_codes_ext, "Unknown"),\r\nmnc);\r\nmcc_mnc_str = wmem_strdup_printf(wmem_packet_scope(), "MCC %u %s, MNC %03u %s",\r\nmcc,\r\nval_to_str_ext_const(mcc,&E212_codes_ext,""),\r\nmnc,\r\nval_to_str_ext_const(mcc * 1000 + mnc, &mcc_mnc_codes_ext, ""));\r\n} else {\r\nitem = proto_tree_add_uint_format_value(tree, hf_E212_mnc , tvb, start_offset + 1, 2, mnc,\r\n"%s (%02u)",\r\nval_to_str_ext_const(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext, "Unknown"),\r\nmnc);\r\nmcc_mnc_str = wmem_strdup_printf(wmem_packet_scope(), "MCC %u %s, MNC %02u %s",\r\nmcc,\r\nval_to_str_ext_const(mcc,&E212_codes_ext,""),\r\nmnc,\r\nval_to_str_ext_const(mcc * 1000 + mnc, &mcc_mnc_codes_ext, ""));\r\n}\r\nif (((mnc1 > 9) || (mnc2 > 9) || ((mnc3 > 9) && (mnc3 != 0x0f))) && (mcc_mnc != 0xffffff))\r\nexpert_add_info(pinfo, item, &ei_E212_mnc_non_decimal);\r\nreturn mcc_mnc_str;\r\n}\r\nint\r\ndissect_e212_mcc_mnc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, e212_number_type_t number_type, gboolean little_endian)\r\n{\r\ndissect_e212_mcc_mnc_wmem_packet_str(tvb, pinfo, tree, offset, number_type, little_endian);\r\nreturn offset +3;\r\n}\r\nint\r\ndissect_e212_mcc_mnc_in_address(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 start_offset, mcc_mnc;\r\nguint8 octet;\r\nguint16 mcc, mnc;\r\nguint8 mcc1, mcc2, mcc3, mnc1, mnc2, mnc3;\r\nproto_item *item;\r\ngboolean long_mnc;\r\nlong_mnc = FALSE;\r\nstart_offset = offset;\r\nmcc_mnc = tvb_get_ntoh24(tvb,offset);\r\noctet = tvb_get_guint8(tvb,offset);\r\nmcc1 = octet & 0x0f;\r\nmcc2 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmcc3 = octet & 0x0f;\r\nmnc1 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmnc2 = octet & 0x0f;\r\nmnc3 = octet >> 4;\r\nmcc = 100 * mcc1 + 10 * mcc2 + mcc3;\r\nmnc = 10 * mnc1 + mnc2;\r\nif (!try_val_to_str_ext(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext)) {\r\nmnc = 10 * mnc + mnc3;\r\nlong_mnc = TRUE;\r\n}\r\nitem = proto_tree_add_uint(tree, hf_E212_mcc , tvb, start_offset, 2, mcc );\r\nif (((mcc1 > 9) || (mcc2 > 9) || (mcc3 > 9)) & (mcc_mnc != 0xffffff))\r\nexpert_add_info(pinfo, item, &ei_E212_mcc_non_decimal);\r\nif (long_mnc)\r\nitem = proto_tree_add_uint_format_value(tree, hf_E212_mnc , tvb, start_offset + 1, 2, mnc,\r\n"%s (%03u)",\r\nval_to_str_ext_const(mcc * 1000 + mnc, &mcc_mnc_codes_ext, "Unknown"),\r\nmnc);\r\nelse\r\nitem = proto_tree_add_uint_format_value(tree, hf_E212_mnc , tvb, start_offset + 1, 2, mnc,\r\n"%s (%02u)",\r\nval_to_str_ext_const(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext, "Unknown"),\r\nmnc);\r\nif (((mnc1 > 9) || (mnc2 > 9) || (long_mnc && (mnc3 > 9))) && (mcc_mnc != 0xffffff))\r\nexpert_add_info(pinfo, item, &ei_E212_mnc_non_decimal);\r\nif (long_mnc)\r\nreturn 6;\r\nelse\r\nreturn 5;\r\n}\r\nstatic int\r\ndissect_e212_mcc_mnc_high_nibble(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nguint32 start_offset;\r\nguint8 octet;\r\nguint16 mcc, mnc;\r\nguint8 mcc1, mcc2, mcc3, mnc1, mnc2, mnc3;\r\ngboolean long_mnc;\r\nlong_mnc = FALSE;\r\nstart_offset = offset;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmcc1 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmcc2 = octet & 0x0f;\r\nmcc3 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmnc1 = octet & 0x0f;\r\nmnc2 = octet >> 4;\r\noffset++;\r\noctet = tvb_get_guint8(tvb,offset);\r\nmnc3 = octet & 0x0f;\r\nmcc = 100 * mcc1 + 10 * mcc2 + mcc3;\r\nmnc = 10 * mnc1 + mnc2;\r\nif (!try_val_to_str_ext(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext)) {\r\nmnc = 10 * mnc + mnc3;\r\nlong_mnc = TRUE;\r\n}\r\nproto_tree_add_uint(tree, hf_E212_mcc , tvb, start_offset, 2, mcc );\r\nif (long_mnc)\r\nproto_tree_add_uint_format_value(tree, hf_E212_mnc , tvb, start_offset + 2, 2, mnc,\r\n"%s (%03u)",\r\nval_to_str_ext_const(mcc * 1000 + mnc, &mcc_mnc_codes_ext, "Unknown"),\r\nmnc);\r\nelse\r\nproto_tree_add_uint_format_value(tree, hf_E212_mnc , tvb, start_offset + 2, 1, mnc,\r\n"%s (%02u)",\r\nval_to_str_ext_const(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext, "Unknown"),\r\nmnc);\r\nif (long_mnc)\r\nreturn 7;\r\nelse\r\nreturn 5;\r\n}\r\nstatic int\r\ndissect_e212_mcc_mnc_in_utf8_address(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nguint16 mcc, mnc;\r\ngboolean long_mnc = FALSE;\r\nmcc = atoi(tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 3, ENC_UTF_8));\r\nmnc = atoi(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 3, 2, ENC_UTF_8));\r\nif (!try_val_to_str_ext(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext)) {\r\nmnc = atoi(tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 3, 3, ENC_UTF_8));\r\nlong_mnc = TRUE;\r\n}\r\nproto_tree_add_uint(tree, hf_E212_mcc, tvb, offset, 3, mcc );\r\nif (long_mnc)\r\nproto_tree_add_uint_format_value(tree, hf_E212_mnc, tvb, offset + 3, 3, mnc,\r\n"%s (%03u)",\r\nval_to_str_ext_const(mcc * 1000 + mnc, &mcc_mnc_codes_ext, "Unknown1"),\r\nmnc);\r\nelse\r\nproto_tree_add_uint_format_value(tree, hf_E212_mnc, tvb, offset + 3, 2, mnc,\r\n"%s (%02u)",\r\nval_to_str_ext_const(mcc * 1000 + 10 * mnc, &mcc_mnc_codes_ext, "Unknown2"),\r\nmnc);\r\nif (long_mnc)\r\nreturn 6;\r\nelse\r\nreturn 5;\r\n}\r\nconst gchar *\r\ndissect_e212_imsi(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, int length, gboolean skip_first)\r\n{\r\nproto_item *item;\r\nproto_tree *subtree;\r\nconst gchar *imsi_str;\r\nimsi_str = tvb_bcd_dig_to_wmem_packet_str( tvb, offset, length, NULL, skip_first);\r\nitem = proto_tree_add_string(tree, hf_E212_imsi, tvb, offset, length, imsi_str);\r\nsubtree = proto_item_add_subtree(item, ett_e212_imsi);\r\nif(skip_first) {\r\ndissect_e212_mcc_mnc_high_nibble(tvb, pinfo, subtree, offset);\r\n} else {\r\ndissect_e212_mcc_mnc_in_address(tvb, pinfo, subtree, offset);\r\n}\r\nreturn imsi_str;\r\n}\r\nconst gchar *\r\ndissect_e212_utf8_imsi(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, int length)\r\n{\r\nproto_item *item;\r\nproto_tree *subtree;\r\nconst gchar *imsi_str;\r\nimsi_str = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, length, ENC_UTF_8);\r\nitem = proto_tree_add_string(tree, hf_E212_imsi, tvb, offset, length, imsi_str);\r\nsubtree = proto_item_add_subtree(item, ett_e212_imsi);\r\ndissect_e212_mcc_mnc_in_utf8_address(tvb, pinfo, subtree, offset);\r\nreturn imsi_str;\r\n}\r\nvoid\r\nproto_register_e212(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_E212_imsi,\r\n{ "IMSI","e212.imsi",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"International mobile subscriber identity(IMSI)", HFILL }\r\n},\r\n{ &hf_E212_mcc,\r\n{ "Mobile Country Code (MCC)","e212.mcc",\r\nFT_UINT16, BASE_DEC|BASE_EXT_STRING, &E212_codes_ext, 0x0,\r\n"Mobile Country Code MCC", HFILL }\r\n},\r\n{ &hf_E212_mcc_lai,\r\n{ "Mobile Country Code (MCC)","e212.lai.mcc",\r\nFT_UINT16, BASE_DEC|BASE_EXT_STRING, &E212_codes_ext, 0x0,\r\n"Mobile Country Code MCC", HFILL }\r\n},\r\n{ &hf_E212_mcc_rai,\r\n{ "Mobile Country Code (MCC)","e212.rai.mcc",\r\nFT_UINT16, BASE_DEC|BASE_EXT_STRING, &E212_codes_ext, 0x0,\r\n"Mobile Country Code MCC", HFILL }\r\n},\r\n{ &hf_E212_mcc_sai,\r\n{ "Mobile Country Code (MCC)","e212.sai.mcc",\r\nFT_UINT16, BASE_DEC|BASE_EXT_STRING, &E212_codes_ext, 0x0,\r\n"Mobile Country Code MCC", HFILL }\r\n},\r\n{ &hf_E212_mnc,\r\n{ "Mobile Network Code (MNC)","e212.mnc",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Mobile network code", HFILL }\r\n},\r\n{ &hf_E212_mnc_lai,\r\n{ "Mobile Network Code (MNC)","e212.lai.mnc",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Mobile network code", HFILL }\r\n},\r\n{ &hf_E212_mnc_rai,\r\n{ "Mobile Network Code (MNC)","e212.rai.mnc",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Mobile network code", HFILL }\r\n},\r\n{ &hf_E212_mnc_sai,\r\n{ "Mobile Network Code (MNC)","e212.sai.mnc",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Mobile network code", HFILL }\r\n},\r\n#if 0\r\n{ &hf_E212_msin,\r\n{ "Mobile Subscriber Identification Number (MSIN)", "e212.msin",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\n"Mobile Subscriber Identification Number(MSIN)", HFILL }},\r\n#endif\r\n};\r\nstatic gint *ett_e212_array[] = {\r\n&ett_e212_imsi,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_E212_mcc_non_decimal, { "e212.mcc.non_decimal", PI_MALFORMED, PI_WARN, "MCC contains non-decimal digits", EXPFILL }},\r\n{ &ei_E212_mnc_non_decimal, { "e212.mnc.non_decimal", PI_MALFORMED, PI_WARN, "MNC contains non-decimal digits", EXPFILL }},\r\n};\r\nexpert_module_t* expert_e212;\r\nproto_e212 = proto_register_protocol(\r\n"ITU-T E.212 number",\r\n"E.212",\r\n"e212");\r\nproto_register_field_array(proto_e212, hf, array_length(hf));\r\nproto_register_subtree_array(ett_e212_array, array_length(ett_e212_array));\r\nexpert_e212 = expert_register_protocol(proto_e212);\r\nexpert_register_field_array(expert_e212, ei, array_length(ei));\r\n}

static int\r\ndissect_lpd(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *lpd_tree;\r\nproto_item *ti, *hidden_item;\r\nenum lpr_type lpr_packet_type;\r\nguint8 code;\r\ngint printer_len;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LPD");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncode = tvb_get_guint8(tvb, 0);\r\nif (tvb_reported_length(tvb) == 1) {\r\nlpr_packet_type = response;\r\n}\r\nelse if (code <= 9) {\r\nlpr_packet_type = request;\r\n}\r\nelse {\r\nlpr_packet_type = unknown;\r\n}\r\nif (lpr_packet_type == request && code !=0) {\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str(code, lpd_client_code, "Unknown client code: %u"));\r\n}\r\nelse if (lpr_packet_type == response) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "LPD response");\r\n}\r\nelse {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "LPD continuation");\r\n}\r\nti = proto_tree_add_item(tree, proto_lpd, tvb, 0, -1, ENC_NA);\r\nlpd_tree = proto_item_add_subtree(ti, ett_lpd);\r\nif (lpr_packet_type == response) {\r\nhidden_item = proto_tree_add_boolean(lpd_tree, hf_lpd_response,\r\ntvb, 0, 0, TRUE);\r\n} else {\r\nhidden_item = proto_tree_add_boolean(lpd_tree, hf_lpd_request,\r\ntvb, 0, 0, TRUE);\r\n}\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\nif (lpr_packet_type == request) {\r\nprinter_len = find_printer_string(tvb, 1);\r\nif (code <= 9 && printer_len != -1) {\r\nproto_tree_add_uint_format(lpd_tree, hf_lpd_client_code, tvb, 0, 1, code,\r\n"%s", val_to_str(code, lpd_client_code, "Unknown client code: %u"));\r\nproto_tree_add_item(lpd_tree, hf_lpd_printer_option, tvb, 1, printer_len, ENC_ASCII|ENC_NA);\r\n}\r\nelse {\r\ncall_data_dissector(tvb, pinfo, lpd_tree);\r\n}\r\n}\r\nelse if (lpr_packet_type == response) {\r\nif (code <= 3) {\r\nproto_tree_add_item(lpd_tree, hf_lpd_response_code, tvb, 0, 1, ENC_BIG_ENDIAN);\r\n}\r\nelse {\r\ncall_data_dissector(tvb, pinfo, lpd_tree);\r\n}\r\n}\r\nelse {\r\ncall_data_dissector(tvb, pinfo, lpd_tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gint\r\nfind_printer_string(tvbuff_t *tvb, int offset)\r\n{\r\nint i;\r\ni = tvb_find_guint8(tvb, offset, -1, '\0');\r\nif (i == -1)\r\ni = tvb_find_guint8(tvb, offset, -1, '\n');\r\nif (i == -1)\r\nreturn -1;\r\nreturn i - offset;\r\n}\r\nvoid\r\nproto_register_lpd(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_lpd_response,\r\n{ "Response", "lpd.response",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"TRUE if LPD response", HFILL }},\r\n{ &hf_lpd_request,\r\n{ "Request", "lpd.request",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"TRUE if LPD request", HFILL }},\r\n{ &hf_lpd_client_code,\r\n{ "Client code", "lpd.client_code",\r\nFT_UINT8, BASE_DEC, VALS(lpd_client_code), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_lpd_printer_option,\r\n{ "Printer/options", "lpd.printer_option",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_lpd_response_code,\r\n{ "Response", "lpd.response_code",\r\nFT_UINT8, BASE_DEC, VALS(lpd_server_code), 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_lpd,\r\n};\r\nproto_lpd = proto_register_protocol("Line Printer Daemon Protocol", "LPD", "lpd");\r\nproto_register_field_array(proto_lpd, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_lpd(void)\r\n{\r\ndissector_handle_t lpd_handle;\r\nlpd_handle = create_dissector_handle(dissect_lpd, proto_lpd);\r\ndissector_add_uint("tcp.port", TCP_PORT_PRINTER, lpd_handle);\r\n}

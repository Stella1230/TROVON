static void\r\ndissect_brdwlk_err(proto_tree *parent_tree, tvbuff_t *tvb, int offset)\r\n{\r\nstatic const int * flags[] = {\r\n&hf_brdwlk_error_plp,\r\n&hf_brdwlk_error_ef,\r\n&hf_brdwlk_error_nd,\r\n&hf_brdwlk_error_tr,\r\n&hf_brdwlk_error_badcrc,\r\n&hf_brdwlk_error_ff,\r\n&hf_brdwlk_error_jumbo,\r\n&hf_brdwlk_error_ctrl,\r\nNULL\r\n};\r\nproto_tree_add_bitmask_with_flags(parent_tree, tvb, offset, hf_brdwlk_error, ett_brdwlk_error, flags, ENC_NA, BMT_NO_FALSE|BMT_NO_TFS);\r\n}\r\nstatic int\r\ndissect_brdwlk(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti, *hidden_item;\r\nproto_tree *brdwlk_tree;\r\ntvbuff_t *next_tvb;\r\nguint8 error, eof, sof;\r\nint hdrlen = 2,\r\noffset = 0;\r\ngint len, reported_len, plen;\r\nguint16 pkt_cnt;\r\ngboolean dropped_packets;\r\nfc_data_t fc_data;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Boardwalk");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nsof = (tvb_get_guint8(tvb, offset) & 0xF0) >> 4;\r\nfc_data.sof_eof = 0;\r\nif ((sof == FCM_DELIM_SOFI3) || (sof == FCM_DELIM_SOFI2) || (sof == FCM_DELIM_SOFI1)\r\n|| (sof == FCM_DELIM_SOFI4)) {\r\nfc_data.sof_eof = FC_DATA_SOF_FIRST_FRAME;\r\n}\r\nelse if (sof == FCM_DELIM_SOFF) {\r\nfc_data.sof_eof = FC_DATA_SOF_SOFF;\r\n}\r\nti = proto_tree_add_protocol_format(tree, proto_brdwlk, tvb, 0,\r\nhdrlen, "Boardwalk");\r\nbrdwlk_tree = proto_item_add_subtree(ti, ett_brdwlk);\r\nproto_tree_add_item(brdwlk_tree, hf_brdwlk_sof, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(brdwlk_tree, hf_brdwlk_vsan, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlen = tvb_captured_length_remaining(tvb, hdrlen);\r\nreported_len = tvb_reported_length_remaining(tvb, hdrlen);\r\nif (reported_len < 4) {\r\n;\r\n}\r\nelse if (len < reported_len) {\r\nreported_len -= 4;\r\nif (len > reported_len)\r\nlen = reported_len;\r\n}\r\nelse {\r\nlen -= 4;\r\nreported_len -= 4;\r\noffset = tvb_reported_length(tvb) - 4;\r\npkt_cnt = tvb_get_ntohs(tvb, offset);\r\nif (tree) {\r\nproto_tree_add_uint(brdwlk_tree, hf_brdwlk_pktcnt, tvb, offset,\r\n2, pkt_cnt);\r\n}\r\ndropped_packets = FALSE;\r\nif (pinfo->fd->flags.visited) {\r\nif (p_get_proto_data(wmem_file_scope(), pinfo, proto_brdwlk, 0) != NULL)\r\ndropped_packets = TRUE;\r\n} else {\r\nif (pkt_cnt != packet_count + 1) {\r\nif (!first_pkt &&\r\n(pkt_cnt != 0 || (packet_count != BRDWLK_MAX_PACKET_CNT))) {\r\ndropped_packets = TRUE;\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_brdwlk, 0, &packet_count);\r\n}\r\n}\r\n}\r\nhidden_item = proto_tree_add_boolean(brdwlk_tree, hf_brdwlk_drop,\r\ntvb, offset, 0, dropped_packets);\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\npacket_count = pkt_cnt;\r\nerror=tvb_get_guint8(tvb, offset+2);\r\ndissect_brdwlk_err(brdwlk_tree, tvb, offset+2);\r\neof = tvb_get_guint8(tvb, offset+3);\r\nif (eof != FCM_DELIM_EOFN) {\r\nfc_data.sof_eof |= FC_DATA_EOF_LAST_FRAME;\r\n}\r\nelse if (eof != FCM_DELIM_EOFT) {\r\nfc_data.sof_eof |= FC_DATA_EOF_INVALID;\r\n}\r\nproto_tree_add_item(brdwlk_tree, hf_brdwlk_eof, tvb, offset+3,\r\n1, ENC_BIG_ENDIAN);\r\nif ((error & BRDWLK_HAS_PLEN) && tree) {\r\nplen = tvb_get_ntohl(tvb, offset-4);\r\nplen *= 4;\r\nproto_tree_add_uint(brdwlk_tree, hf_brdwlk_plen, tvb, offset-4,\r\n4, plen);\r\n#if 0\r\nif (error & BRDWLK_TRUNCATED_BIT) {\r\ntvb_set_reported_length(tvb, plen);\r\n}\r\n#endif\r\n}\r\n}\r\nfc_data.ethertype = ETHERTYPE_BRDWALK;\r\nnext_tvb = tvb_new_subset(tvb, 2, len, reported_len);\r\ncall_dissector_with_data(fc_dissector_handle, next_tvb, pinfo, tree, &fc_data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\nbrdwlk_init(void)\r\n{\r\npacket_count = 0;\r\nfirst_pkt = TRUE;\r\n}\r\nvoid\r\nproto_register_brdwlk(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_brdwlk_sof,\r\n{"SOF", "brdwlk.sof", FT_UINT8, BASE_HEX, VALS(brdwlk_sof_vals),\r\n0xF0, NULL, HFILL}},\r\n{ &hf_brdwlk_eof,\r\n{"EOF", "brdwlk.eof", FT_UINT8, BASE_HEX, VALS(brdwlk_eof_vals),\r\n0x0F, NULL, HFILL}},\r\n{ &hf_brdwlk_error,\r\n{"Error", "brdwlk.error", FT_UINT8, BASE_HEX, NULL, 0x0, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_pktcnt,\r\n{"Packet Count", "brdwlk.pktcnt", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_brdwlk_drop,\r\n{"Packet Dropped", "brdwlk.drop", FT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_brdwlk_vsan,\r\n{"VSAN", "brdwlk.vsan", FT_UINT16, BASE_DEC, NULL, 0xFFF, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_plen,\r\n{"Original Packet Length", "brdwlk.plen", FT_UINT32, BASE_DEC, NULL, 0x0, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_plp,\r\n{"Packet Length Present", "brdwlk.error.plp", FT_BOOLEAN, 8, TFS(&tfs_error_plp), 0x01, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_ef,\r\n{"Empty Frame", "brdwlk.error.ef", FT_BOOLEAN, 8, TFS(&tfs_error_ef), 0x02, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_nd,\r\n{"No Data", "brdwlk.error.nd", FT_BOOLEAN, 8, TFS(&tfs_error_nd), 0x04, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_tr,\r\n{"Truncated", "brdwlk.error.tr", FT_BOOLEAN, 8, TFS(&tfs_error_tr), 0x08, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_badcrc,\r\n{"CRC", "brdwlk.error.crc", FT_BOOLEAN, 8, TFS(&tfs_error_crc), 0x10, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_ff,\r\n{"Fifo Full", "brdwlk.error.ff", FT_BOOLEAN, 8, TFS(&tfs_error_ff), 0x20, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_jumbo,\r\n{"Jumbo FC Frame", "brdwlk.error.jumbo", FT_BOOLEAN, 8, TFS(&tfs_error_jumbo), 0x40, NULL,\r\nHFILL}},\r\n{ &hf_brdwlk_error_ctrl,\r\n{"Ctrl Char Inside Frame", "brdwlk.error.ctrl", FT_BOOLEAN, 8, TFS(&tfs_error_ctrl), 0x80, NULL,\r\nHFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_brdwlk,\r\n&ett_brdwlk_error,\r\n};\r\nproto_brdwlk = proto_register_protocol("Boardwalk",\r\n"Boardwalk", "brdwlk");\r\nproto_register_field_array(proto_brdwlk, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_init_routine(&brdwlk_init);\r\n}\r\nvoid\r\nproto_reg_handoff_brdwlk(void)\r\n{\r\ndissector_handle_t brdwlk_handle;\r\nbrdwlk_handle = create_dissector_handle(dissect_brdwlk, proto_brdwlk);\r\ndissector_add_uint("ethertype", ETHERTYPE_BRDWALK, brdwlk_handle);\r\ndissector_add_uint("ethertype", 0xABCD, brdwlk_handle);\r\nfc_dissector_handle = find_dissector_add_dependency("fc", proto_brdwlk);\r\n}

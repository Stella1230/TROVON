static guint16\r\nde_sgsap_eps_loc_upd_type(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\nguint8 oct;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_eps_location_update_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (add_string) {\r\noct = tvb_get_guint8(tvb, curr_offset);\r\ng_snprintf(add_string, string_len, " - %s", val_to_str_const(oct, sgsap_eps_location_update_type_values, "Reserved"));\r\n}\r\ncurr_offset++;\r\nreturn(curr_offset - offset);\r\n}\r\nstatic guint16\r\nde_sgsap_err_msg(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string , int string_len)\r\n{\r\nconst gchar *msg_str;\r\ngint ett_tree;\r\nint hf_idx;\r\nvoid(*msg_fcn_p)(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len);\r\nguint8 oct;\r\noct = tvb_get_guint8(tvb, offset);\r\nmsg_fcn_p = NULL;\r\nett_tree = -1;\r\nhf_idx = -1;\r\nmsg_str = NULL;\r\nproto_tree_add_item(tree, hf_sgsap_msg_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nget_sgsap_msg_params(oct, &msg_str, &ett_tree, &hf_idx, &msg_fcn_p);\r\nif (msg_str) {\r\nif (add_string)\r\ng_snprintf(add_string, string_len, " - %s", msg_str);\r\n}\r\nif (msg_fcn_p){\r\noffset++;\r\n(*msg_fcn_p)(tvb, tree, pinfo, offset, len - offset);\r\n}\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_ecgi(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\ndissect_e212_mcc_mnc(tvb, pinfo, tree, offset, E212_NONE, TRUE);\r\ncurr_offset += 3;\r\nproto_tree_add_item(tree, hf_sgsap_eci, tvb, curr_offset, 4, ENC_BIG_ENDIAN);\r\ncurr_offset += 4;\r\nreturn(curr_offset-offset);\r\n}\r\nstatic guint16\r\nde_sgsap_g_cn_id(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\ndissect_e212_mcc_mnc(tvb, pinfo, tree, offset, E212_NONE, TRUE);\r\ncurr_offset += 3;\r\nproto_tree_add_item(tree, hf_sgsap_cn_id, tvb, curr_offset, 2, ENC_BIG_ENDIAN);\r\ncurr_offset += 2;\r\nreturn(curr_offset-offset);\r\n}\r\nstatic guint16\r\nde_sgsap_imeisv(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nconst char *imeisv_str;\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\nimeisv_str = tvb_bcd_dig_to_wmem_packet_str( tvb, curr_offset, len, NULL, FALSE);\r\nproto_tree_add_string(tree, hf_sgsap_imeisv, tvb, curr_offset, len, imeisv_str);\r\nif (add_string) {\r\ng_snprintf(add_string, (len<<2)+4, " - %s", imeisv_str);\r\n}\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_imsi_det_eps(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_imsi_det_eps, tvb, curr_offset, 1, ENC_BIG_ENDIAN);\r\ncurr_offset += 1;\r\nreturn(curr_offset-offset);\r\n}\r\nstatic guint16\r\nde_sgsap_imsi_det_non_eps(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_imsi_det_non_eps, tvb, curr_offset, 1, ENC_BIG_ENDIAN);\r\ncurr_offset += 1;\r\nreturn(curr_offset-offset);\r\n}\r\nstatic guint16\r\nde_sgsap_lcs_indic(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_lcs_indic, tvb, curr_offset, 1, ENC_BIG_ENDIAN);\r\ncurr_offset += 1;\r\nreturn(curr_offset-offset);\r\n}\r\nstatic guint16\r\nde_sgsap_mm_info(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\ndtap_mm_mm_info(tvb, tree, pinfo, curr_offset, len);\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_mme_name(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint name_len, tmp;\r\nguint8 *fqdn = NULL;\r\nif (len > 0) {\r\nname_len = tvb_get_guint8(tvb, offset);\r\nif (name_len < 0x20) {\r\nfqdn = tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 1, len - 1, ENC_ASCII);\r\nfor (;;) {\r\nif (name_len >= len - 1)\r\nbreak;\r\ntmp = name_len;\r\nname_len = name_len + fqdn[tmp] + 1;\r\nfqdn[tmp] = '.';\r\n}\r\n} else{\r\nfqdn = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, len, ENC_ASCII);\r\n}\r\nproto_tree_add_string(tree, hf_sgsap_mme_name, tvb, offset, len, fqdn);\r\nif (add_string)\r\ng_snprintf(add_string, string_len, " - %s", fqdn);\r\n}\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_nas_msg_container(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len, gchar *add_string _U_, int string_len _U_)\r\n{\r\ntvbuff_t *new_tvb;\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\nnew_tvb = tvb_new_subset_length(tvb, curr_offset, len);\r\nif (gsm_a_dtap_handle) {\r\ncall_dissector(gsm_a_dtap_handle, new_tvb, pinfo, tree);\r\n}\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_serv_indic(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\nguint8 oct;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_service_indicator_value, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (add_string) {\r\noct = tvb_get_guint8(tvb, curr_offset);\r\ng_snprintf(add_string, string_len, " - %s", val_to_str_const(oct, sgsap_service_indicator_values, "Reserved"));\r\n}\r\ncurr_offset++;\r\nreturn(curr_offset - offset);\r\n}\r\nstatic guint16\r\nde_sgsap_sgs_cause(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\nguint8 oct;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_sgs_cause, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (add_string) {\r\noct = tvb_get_guint8(tvb, curr_offset);\r\ng_snprintf(add_string, string_len, " - %s", val_to_str_ext_const(oct, &sgsap_sgs_cause_values_ext, "Reserved"));\r\n}\r\ncurr_offset++;\r\nreturn(curr_offset - offset);\r\n}\r\nstatic guint16\r\nde_sgsap_ue_emm_mode(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint32 curr_offset;\r\ncurr_offset = offset;\r\nproto_tree_add_item(tree, hf_sgsap_ue_emm_mode, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncurr_offset += 1;\r\nreturn(curr_offset - offset);\r\n}\r\nstatic guint16\r\nde_sgsap_vlr_name(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nguint name_len, tmp;\r\nguint8 *fqdn = NULL;\r\nif (len > 0) {\r\nname_len = tvb_get_guint8(tvb, offset);\r\nif (name_len < 0x20) {\r\nfqdn = tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 1, len - 1, ENC_ASCII);\r\nfor (;;) {\r\nif (name_len >= len - 1)\r\nbreak;\r\ntmp = name_len;\r\nname_len = name_len + fqdn[tmp] + 1;\r\nfqdn[tmp] = '.';\r\n}\r\n} else{\r\nfqdn = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, len, ENC_ASCII);\r\n}\r\nproto_tree_add_string(tree, hf_sgsap_vlr_name, tvb, offset, len, fqdn);\r\nif (add_string)\r\ng_snprintf(add_string, string_len, " - %s", fqdn);\r\n}\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_add_paging_ind(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nproto_tree_add_item(tree, hf_sgsap_csri, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nreturn(len);\r\n}\r\nstatic guint16\r\nde_sgsap_selected_cs_dmn_op(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len _U_, gchar *add_string _U_, int string_len _U_)\r\n{\r\nproto_item *item;\r\nproto_tree *sub_tree;\r\nitem = proto_tree_add_item(tree, hf_sgsap_sel_cs_dmn_op, tvb, offset, 1, ENC_NA);\r\nsub_tree = proto_item_add_subtree(item, ett_sgsap_sel_cs_dmn_op);\r\ndissect_e212_mcc_mnc_wmem_packet_str(tvb, pinfo, sub_tree, offset, E212_LAI, TRUE);\r\nreturn(len);\r\n}\r\nstatic void\r\nsgsap_alert_ack(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_alert_rej(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x08, SGSAP_PDU_TYPE, DE_SGSAP_SGS_CAUSE, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_alert_req(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_dl_unitdata(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x16, SGSAP_PDU_TYPE, DE_SGSAP_NAS_MSG_CONTAINER, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_eps_det_ack(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_eps_det_ind(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x09, SGSAP_PDU_TYPE, DE_SGSAP_MME_NAME, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x10, SGSAP_PDU_TYPE, DE_SGSAP_IMSI_DET_EPS, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_imsi_det_ack(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_imsi_det_ind(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x09, SGSAP_PDU_TYPE, DE_SGSAP_MME_NAME, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x11, SGSAP_PDU_TYPE, DE_SGSAP_IMSI_DET_NON_EPS, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_imsi_loc_update_acc(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x04, GSM_A_PDU_TYPE_COMMON, DE_LAI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x0e, GSM_A_PDU_TYPE_COMMON, DE_MID, " - New TMSI, or IMSI");\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_imsi_loc_update_rej(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x0f, GSM_A_PDU_TYPE_DTAP, DE_REJ_CAUSE, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x04, GSM_A_PDU_TYPE_COMMON, DE_LAI, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_imsi_loc_update_req(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x09, SGSAP_PDU_TYPE, DE_SGSAP_MME_NAME, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x0a, SGSAP_PDU_TYPE, DE_SGSAP_EPS_LOC_UPD_TYPE, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x04, GSM_A_PDU_TYPE_COMMON, DE_LAI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x04, GSM_A_PDU_TYPE_COMMON, DE_LAI, " - Old location area identifier");\r\nELEM_OPT_TLV( 0x07 , GSM_A_PDU_TYPE_GM, DE_TMSI_STAT , NULL );\r\nELEM_OPT_TLV(0x15, SGSAP_PDU_TYPE, DE_SGSAP_IMEISV, NULL);\r\nELEM_OPT_TLV(0x23, NAS_PDU_TYPE_EMM, DE_EMM_TRAC_AREA_ID, NULL);\r\nELEM_OPT_TLV(0x24, SGSAP_PDU_TYPE, DE_SGSAP_ECGI, NULL);\r\nELEM_OPT_TLV(0x27, GSM_A_PDU_TYPE_GM, DE_NET_RES_ID_CONT, " - TMSI based NRI container");\r\nELEM_OPT_TLV(0x28, SGSAP_PDU_TYPE, DE_SGSAP_SELECTED_CS_DMN_OP, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_mm_info_req(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x17, SGSAP_PDU_TYPE, DE_SGSAP_MM_INFO, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_paging_rej(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x08, SGSAP_PDU_TYPE, DE_SGSAP_SGS_CAUSE, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_paging_req(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x02, SGSAP_PDU_TYPE, DE_SGSAP_VLR_NAME, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x20, SGSAP_PDU_TYPE, DE_SGSAP_SERV_INDIC, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x03, GSM_A_PDU_TYPE_BSSMAP, BE_TMSI, NULL);\r\nELEM_OPT_TLV(0x1c, GSM_A_PDU_TYPE_DTAP, DE_CLG_PARTY_BCD_NUM, " - CLI");\r\nELEM_OPT_TLV(0x04, GSM_A_PDU_TYPE_COMMON, DE_LAI, NULL);\r\nELEM_OPT_TLV(0x0b, SGSAP_PDU_TYPE, DE_SGSAP_GLOBAL_CN_ID, NULL);\r\nELEM_OPT_TLV(0x1f, NAS_PDU_TYPE_EMM, DE_EMM_SS_CODE, NULL);\r\nELEM_OPT_TLV(0x1e, SGSAP_PDU_TYPE, DE_SGSAP_LCS_INDIC, NULL);\r\nELEM_OPT_TLV(0x1d, NAS_PDU_TYPE_EMM, DE_EMM_LCS_CLIENT_ID, NULL);\r\nELEM_OPT_TLV(0x05, GSM_A_PDU_TYPE_BSSMAP, BE_CHAN_NEEDED, NULL);\r\nELEM_OPT_TLV(0x06, GSM_A_PDU_TYPE_BSSMAP, BE_EMLPP_PRIO, NULL);\r\nELEM_OPT_TLV(0x26, SGSAP_PDU_TYPE, DE_SGSAP_ADD_PAGING_IND, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_reset_ack(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_OPT_TLV(0x09, SGSAP_PDU_TYPE, DE_SGSAP_MME_NAME, NULL);\r\nELEM_OPT_TLV(0x02, SGSAP_PDU_TYPE, DE_SGSAP_VLR_NAME, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_reset_ind(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_OPT_TLV(0x09, SGSAP_PDU_TYPE, DE_SGSAP_MME_NAME, NULL);\r\nELEM_OPT_TLV(0x02, SGSAP_PDU_TYPE, DE_SGSAP_VLR_NAME, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_service_req(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x20, SGSAP_PDU_TYPE, DE_SGSAP_SERV_INDIC, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x15, SGSAP_PDU_TYPE, DE_SGSAP_IMEISV, NULL);\r\nELEM_OPT_TLV(0x21, GSM_A_PDU_TYPE_DTAP, DE_TIME_ZONE, " - UE Time Zone");\r\nELEM_OPT_TLV(0x22 , GSM_A_PDU_TYPE_COMMON, DE_MS_CM_2, NULL);\r\nELEM_OPT_TLV(0x23, NAS_PDU_TYPE_EMM, DE_EMM_TRAC_AREA_ID, NULL);\r\nELEM_OPT_TLV(0x24, SGSAP_PDU_TYPE, DE_SGSAP_ECGI, NULL);\r\nELEM_OPT_TLV(0x25, SGSAP_PDU_TYPE, DE_SGSAP_UE_EMM_MODE, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_status(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_OPT_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL);\r\nELEM_MAND_TLV(0x08, SGSAP_PDU_TYPE, DE_SGSAP_SGS_CAUSE, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x1b, SGSAP_PDU_TYPE, DE_SGSAP_ERR_MSG, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_tmsi_realloc_comp(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_ue_act_ind(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_ue_unreachable(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x08, SGSAP_PDU_TYPE, DE_SGSAP_SGS_CAUSE, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_ue_ul_unitdata(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x16, SGSAP_PDU_TYPE, DE_SGSAP_NAS_MSG_CONTAINER, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x15, SGSAP_PDU_TYPE, DE_SGSAP_IMEISV, NULL);\r\nELEM_OPT_TLV(0x21, GSM_A_PDU_TYPE_DTAP, DE_TIME_ZONE, " - UE Time Zone");\r\nELEM_OPT_TLV(0x22 , GSM_A_PDU_TYPE_COMMON, DE_MS_CM_2, NULL);\r\nELEM_OPT_TLV(0x23, NAS_PDU_TYPE_EMM, DE_EMM_TRAC_AREA_ID, NULL);\r\nELEM_OPT_TLV(0x24, SGSAP_PDU_TYPE, DE_SGSAP_ECGI, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_release_req(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_MAND_TLV(0x08, SGSAP_PDU_TYPE, DE_SGSAP_SGS_CAUSE, NULL, ei_sgsap_missing_mandatory_element);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void\r\nsgsap_mo_csfb_ind(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo _U_, guint32 offset, guint len)\r\n{\r\nguint32 curr_offset;\r\nguint32 consumed;\r\nguint curr_len;\r\ncurr_offset = offset;\r\ncurr_len = len;\r\nELEM_MAND_TLV(0x01, GSM_A_PDU_TYPE_BSSMAP, BE_IMSI, NULL, ei_sgsap_missing_mandatory_element);\r\nELEM_OPT_TLV(0x23, NAS_PDU_TYPE_EMM, DE_EMM_TRAC_AREA_ID, NULL);\r\nELEM_OPT_TLV(0x24, SGSAP_PDU_TYPE, DE_SGSAP_ECGI, NULL);\r\nEXTRANEOUS_DATA_CHECK(curr_len, 0, pinfo, &ei_sgsap_extraneous_data);\r\n}\r\nstatic void get_sgsap_msg_params(guint8 oct, const gchar **msg_str, int *ett_tree, int *hf_idx, msg_fcn *msg_fcn_p)\r\n{\r\ngint idx;\r\n*msg_str = try_val_to_str_idx_ext((guint32) (oct & 0xff), &sgsap_msg_strings_ext, &idx);\r\n*hf_idx = hf_sgsap_msg_type;\r\nif (*msg_str != NULL) {\r\n*ett_tree = ett_sgsap_msg[idx];\r\n*msg_fcn_p = sgsap_msg_fcn[idx];\r\n}\r\nreturn;\r\n}\r\nstatic int\r\ndissect_sgsap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *item;\r\nproto_tree *sgsap_tree;\r\nint offset = 0;\r\nguint32 len;\r\nconst gchar *msg_str;\r\ngint ett_tree;\r\nint hf_idx;\r\nvoid (*msg_fcn_p)(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, guint32 offset, guint len);\r\nguint8 oct;\r\nlen = tvb_reported_length(tvb);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PSNAME);\r\nitem = proto_tree_add_item(tree, proto_sgsap, tvb, 0, -1, ENC_NA);\r\nsgsap_tree = proto_item_add_subtree(item, ett_sgsap);\r\noct = tvb_get_guint8(tvb, offset);\r\nmsg_fcn_p = NULL;\r\nett_tree = -1;\r\nhf_idx = -1;\r\nmsg_str = NULL;\r\nget_sgsap_msg_params(oct, &msg_str, &ett_tree, &hf_idx, &msg_fcn_p);\r\nif (msg_str) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", msg_str);\r\n}else{\r\nproto_tree_add_item(tree, hf_sgsap_unknown_msg, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nproto_tree_add_item(sgsap_tree, hf_idx, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (msg_fcn_p == NULL)\r\n{\r\nproto_tree_add_item(sgsap_tree, hf_sgsap_message_elements, tvb, offset, len - offset, ENC_NA);\r\n}\r\nelse\r\n{\r\n(*msg_fcn_p)(tvb, sgsap_tree, pinfo, offset, len - offset);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_sgsap(void) {\r\nguint i;\r\nguint last_offset;\r\nmodule_t *sgsap_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sgsap_msg_type,\r\n{ "SGSAP Message Type", "sgsap.msg_type",\r\nFT_UINT8, BASE_HEX|BASE_EXT_STRING, &sgsap_msg_strings_ext, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_elem_id,\r\n{ "Element ID", "sgsap.elem_id",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_eps_location_update_type,\r\n{ "EPS location update type", "sgsap.eps_location_update_type",\r\nFT_UINT8, BASE_DEC, VALS(sgsap_eps_location_update_type_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_service_indicator_value,\r\n{ "Service indicator", "sgsap.service_indicator",\r\nFT_UINT8, BASE_DEC, VALS(sgsap_service_indicator_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_sgs_cause,\r\n{ "SGs cause", "sgsap.sgs_cause",\r\nFT_UINT8, BASE_DEC|BASE_EXT_STRING, &sgsap_sgs_cause_values_ext, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_ue_emm_mode,\r\n{ "UE EMM mode", "sgsap.ue_emm_mode",\r\nFT_UINT8, BASE_DEC, VALS(sgsap_ue_emm_mode_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_eci,\r\n{"ECI (E-UTRAN Cell Identifier)", "sgsap.eci",\r\nFT_UINT32, BASE_DEC, NULL, 0x0fffffff,\r\nNULL, HFILL}\r\n},\r\n{ &hf_sgsap_cn_id,\r\n{"CN_ID", "sgsap.cn_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_sgsap_imsi_det_eps,\r\n{ "IMSI detach from EPS service type", "sgsap.imsi_det_eps",\r\nFT_UINT8, BASE_DEC, VALS(sgsap_imsi_det_from_eps_serv_type_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_imsi_det_non_eps,\r\n{ "IMSI detach from non-EPS service type", "sgsap.imsi_det_non_eps",\r\nFT_UINT8, BASE_DEC, VALS(sgsap_imsi_det_from_non_eps_serv_type_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_lcs_indic,\r\n{ "LCS indicator", "sgsap.lcs_indicator",\r\nFT_UINT8, BASE_DEC, VALS(sgsap_lcs_indic_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_mme_name,\r\n{"MME name", "sgsap.mme_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_sgsap_vlr_name,\r\n{"VLR name", "sgsap.vlr_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_sgsap_imeisv,\r\n{"IMEISV", "sgsap.imeisv",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_sgsap_unknown_msg,\r\n{ "Unknown message", "sgsap.unknown_msg",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_message_elements,\r\n{"Message Elements", "sgsap.message_elements",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_sgsap_csri,\r\n{"CS restoration indicator (CSRI)", "sgsap.csri",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sgsap_sel_cs_dmn_op,\r\n{ "Selected CS domain operato", "sgsap.sel_cs_dmn_op",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_sgsap_extraneous_data, { "sgsap.extraneous_data", PI_PROTOCOL, PI_NOTE, "Extraneous Data, dissector bug or later version spec(report to wireshark.org)", EXPFILL }},\r\n{ &ei_sgsap_missing_mandatory_element, { "sgsap.missing_mandatory_element", PI_PROTOCOL, PI_WARN, "Missing Mandatory element, rest of dissection is suspect", EXPFILL }},\r\n};\r\nexpert_module_t* expert_sgsap;\r\n#define NUM_INDIVIDUAL_ELEMS 2\r\ngint *ett[NUM_INDIVIDUAL_ELEMS +\r\nNUM_SGSAP_ELEM +\r\nNUM_SGSAP_MSG];\r\nett[0] = &ett_sgsap;\r\nett[1] = &ett_sgsap_sel_cs_dmn_op;\r\nlast_offset = NUM_INDIVIDUAL_ELEMS;\r\nfor (i=0; i < NUM_SGSAP_ELEM; i++, last_offset++)\r\n{\r\nett_sgsap_elem[i] = -1;\r\nett[last_offset] = &ett_sgsap_elem[i];\r\n}\r\nfor (i=0; i < NUM_SGSAP_MSG; i++, last_offset++)\r\n{\r\nett_sgsap_msg[i] = -1;\r\nett[last_offset] = &ett_sgsap_msg[i];\r\n}\r\nproto_sgsap = proto_register_protocol(PNAME, PSNAME, PFNAME);\r\nproto_register_field_array(proto_sgsap, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_sgsap = expert_register_protocol(proto_sgsap);\r\nexpert_register_field_array(expert_sgsap, ei, array_length(ei));\r\nregister_dissector(PFNAME, dissect_sgsap, proto_sgsap);\r\nrange_convert_str(&global_sgsap_port_range, SGSAP_SCTP_PORT_RANGE, MAX_SCTP_PORT);\r\nsgsap_module = prefs_register_protocol(proto_sgsap, proto_reg_handoff_sgsap);\r\nprefs_register_range_preference(sgsap_module, "sctp_ports",\r\n"SGsAP SCTP port numbers",\r\n"Port numbers used for SGsAP traffic "\r\n"(default " SGSAP_SCTP_PORT_RANGE ")",\r\n&global_sgsap_port_range, MAX_SCTP_PORT);\r\n}\r\nvoid\r\nproto_reg_handoff_sgsap(void)\r\n{\r\nstatic gboolean Initialized = FALSE;\r\nstatic dissector_handle_t sgsap_handle;\r\nstatic range_t *sgsap_port_range;\r\nsgsap_handle = find_dissector("sgsap");\r\ngsm_a_dtap_handle = find_dissector_add_dependency("gsm_a_dtap", proto_sgsap);\r\nif (!Initialized) {\r\ndissector_add_for_decode_as("sctp.port", sgsap_handle);\r\nInitialized=TRUE;\r\n} else {\r\ndissector_delete_uint_range("sctp.port", sgsap_port_range, sgsap_handle);\r\ng_free(sgsap_port_range);\r\n}\r\nsgsap_port_range = range_copy(global_sgsap_port_range);\r\ndissector_add_uint_range("sctp.port", sgsap_port_range, sgsap_handle);\r\n}

static int\r\ndissect_ddtp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *ddtp_tree;\r\nproto_item *ti;\r\nif (tvb_reported_length(tvb) < 4)\r\nreturn 0;\r\nif (try_val_to_str(tvb_get_ntohl(tvb, 0), vals_ddtp_version) == NULL)\r\nreturn 0;\r\ncol_set_str (pinfo->cinfo, COL_PROTOCOL, "DDTP");\r\ncol_clear (pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_ddtp, tvb, 0, -1, ENC_NA);\r\nddtp_tree = proto_item_add_subtree(ti, ett_ddtp);\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_version, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_encrypt, tvb, 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_hostid, tvb, 8, 4, ENC_BIG_ENDIAN);\r\nif (tvb_get_ntohl(tvb, 4) == DDTP_ENCRYPT_PLAINTEXT) {\r\nti = proto_tree_add_item(ddtp_tree, hf_ddtp_msgtype, tvb, 12, 4, ENC_BIG_ENDIAN);\r\nswitch (tvb_get_ntohl(tvb, 12)) {\r\ncase DDTP_MESSAGE_ERROR :\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Message Error");\r\nbreak;\r\ncase DDTP_UPDATE_QUERY :\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Update Query");\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_opcode, tvb, 16, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_ipaddr, tvb, 20, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DDTP_UPDATE_REPLY :\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Update Reply");\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_status, tvb, 16, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DDTP_ALIVE_QUERY :\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Alive Query");\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_alive, tvb, 16, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DDTP_ALIVE_REPLY :\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Alive Reply");\r\nproto_tree_add_item(ddtp_tree, hf_ddtp_alive, tvb, 16, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault :\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Unknown type");\r\nexpert_add_info(pinfo, ti, &ei_ddtp_msgtype);\r\n}\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Encrypted payload");\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_ddtp(void)\r\n{\r\nstatic hf_register_info hf_ddtp[] = {\r\n{ &hf_ddtp_version,\r\n{ "Version", "ddtp.version", FT_UINT32, BASE_DEC, VALS(vals_ddtp_version), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ddtp_encrypt,\r\n{ "Encryption", "ddtp.encrypt", FT_UINT32, BASE_DEC, VALS(vals_ddtp_encrypt), 0x0,\r\n"Encryption type", HFILL }},\r\n{ &hf_ddtp_hostid,\r\n{ "Hostid", "ddtp.hostid", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Host ID", HFILL }},\r\n{ &hf_ddtp_msgtype,\r\n{ "Message type", "ddtp.msgtype", FT_UINT32, BASE_DEC, VALS(vals_ddtp_msgtype), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ddtp_opcode,\r\n{ "Opcode", "ddtp.opcode", FT_UINT32, BASE_DEC, VALS(vals_ddtp_opcode), 0x0,\r\n"Update query opcode", HFILL }},\r\n{ &hf_ddtp_ipaddr,\r\n{ "IP address", "ddtp.ipaddr", FT_IPv4, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ddtp_status,\r\n{ "Status", "ddtp.status", FT_UINT32, BASE_DEC, VALS(vals_ddtp_status), 0x0,\r\n"Update reply status", HFILL }},\r\n{ &hf_ddtp_alive,\r\n{ "Dummy", "ddtp.alive", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = { &ett_ddtp };\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ddtp_msgtype, { "ddtp.msgtype.unknown", PI_PROTOCOL, PI_WARN, "Unknown type", EXPFILL }},\r\n};\r\nexpert_module_t* expert_ddtp;\r\nproto_ddtp = proto_register_protocol("Dynamic DNS Tools Protocol",\r\n"DDTP", "ddtp");\r\nproto_register_field_array(proto_ddtp, hf_ddtp, array_length(hf_ddtp));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_ddtp = expert_register_protocol(proto_ddtp);\r\nexpert_register_field_array(expert_ddtp, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_ddtp(void)\r\n{\r\ndissector_handle_t ddtp_handle;\r\nddtp_handle = create_dissector_handle(dissect_ddtp, proto_ddtp);\r\ndissector_add_uint("udp.port", UDP_PORT_DDTP, ddtp_handle);\r\n}

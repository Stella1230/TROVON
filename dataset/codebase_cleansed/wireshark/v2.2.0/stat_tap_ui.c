static gint\r\nsort_by_name(gconstpointer a, gconstpointer b)\r\n{\r\nreturn strcmp(((const stat_cmd_arg *)a)->cmd, ((const stat_cmd_arg *)b)->cmd);\r\n}\r\nvoid\r\nregister_stat_tap_ui(stat_tap_ui *ui, void *userdata)\r\n{\r\nstat_cmd_arg *newsca;\r\nnewsca=(stat_cmd_arg *)g_malloc(sizeof(stat_cmd_arg));\r\nnewsca->cmd=ui->cli_string;\r\nnewsca->func=ui->tap_init_cb;\r\nnewsca->userdata=userdata;\r\nstat_cmd_arg_list=g_list_insert_sorted(stat_cmd_arg_list, newsca, sort_by_name);\r\n}\r\ngboolean\r\nprocess_stat_cmd_arg(char *optstr)\r\n{\r\nGList *entry;\r\nstat_cmd_arg *sca;\r\nstat_requested *tr;\r\nfor(entry=g_list_last(stat_cmd_arg_list);entry;entry=g_list_previous(entry)){\r\nsca=(stat_cmd_arg *)entry->data;\r\nif(!strncmp(sca->cmd,optstr,strlen(sca->cmd))){\r\ntr=(stat_requested *)g_malloc(sizeof (stat_requested));\r\ntr->sca = sca;\r\ntr->arg=g_strdup(optstr);\r\nstats_requested=g_slist_append(stats_requested, tr);\r\nreturn TRUE;\r\n}\r\n}\r\nreturn FALSE;\r\n}\r\nvoid\r\nlist_stat_cmd_args(void)\r\n{\r\nGList *entry;\r\nstat_cmd_arg *sca;\r\nfor(entry=stat_cmd_arg_list;entry;entry=g_list_next(entry)){\r\nsca=(stat_cmd_arg *)entry->data;\r\nfprintf(stderr," %s\n",sca->cmd);\r\n}\r\n}\r\nvoid\r\nstart_requested_stats(void)\r\n{\r\nstat_requested *sr;\r\nwhile(stats_requested){\r\nsr=(stat_requested *)stats_requested->data;\r\n(*sr->sca->func)(sr->arg,sr->sca->userdata);\r\ng_free(sr->arg);\r\ng_free(sr);\r\nstats_requested=g_slist_remove(stats_requested, sr);\r\n}\r\n}\r\nstatic gint\r\ninsert_sorted_by_cli_string(gconstpointer aparam, gconstpointer bparam)\r\n{\r\nconst stat_tap_table_ui *a = (const stat_tap_table_ui *)aparam;\r\nconst stat_tap_table_ui *b = (const stat_tap_table_ui *)bparam;\r\nreturn g_ascii_strcasecmp(a->cli_string, b->cli_string);\r\n}\r\nvoid register_stat_tap_table_ui(stat_tap_table_ui *ui)\r\n{\r\nregistered_stat_tables = g_slist_insert_sorted(registered_stat_tables, ui, insert_sorted_by_cli_string);\r\n}\r\nvoid new_stat_tap_iterate_tables(GFunc func, gpointer user_data)\r\n{\r\ng_slist_foreach(registered_stat_tables, func, user_data);\r\n}\r\nvoid new_stat_tap_get_filter(stat_tap_table_ui* new_stat, const char *opt_arg, const char **filter, char** err)\r\n{\r\nguint len = (guint) strlen(new_stat->cli_string);\r\n*filter=NULL;\r\n*err=NULL;\r\nif (!strncmp(opt_arg, new_stat->cli_string, len))\r\n{\r\nif (opt_arg[len] == ',')\r\n{\r\n*filter = opt_arg + len+1;\r\n}\r\n}\r\nif (new_stat->stat_filter_check_cb)\r\nnew_stat->stat_filter_check_cb(opt_arg, filter, err);\r\n}\r\nstat_tap_table* new_stat_tap_init_table(const char *name, int num_fields, int num_elements,\r\nconst char *filter_string, new_stat_tap_gui_init_cb gui_callback, void* gui_data)\r\n{\r\nstat_tap_table* new_table = g_new0(stat_tap_table, 1);\r\nnew_table->title = name;\r\nnew_table->num_elements = num_elements;\r\nnew_table->num_fields = num_fields;\r\nnew_table->filter_string = filter_string;\r\nnew_table->elements = g_new0(stat_tap_table_item_type*, num_elements);\r\nif (gui_callback)\r\ngui_callback(new_table, gui_data);\r\nreturn new_table;\r\n}\r\nvoid new_stat_tap_add_table(stat_tap_table_ui* new_stat, stat_tap_table* table)\r\n{\r\nif (new_stat->tables == NULL)\r\nnew_stat->tables = g_array_new(FALSE, TRUE, sizeof(stat_tap_table*));\r\ng_array_insert_val(new_stat->tables, new_stat->tables->len, table);\r\n}\r\nvoid new_stat_tap_init_table_row(stat_tap_table *stat_table, guint table_index, guint num_fields, const stat_tap_table_item_type* fields)\r\n{\r\nif(table_index>=stat_table->num_elements){\r\nguint old_num_elements=stat_table->num_elements;\r\nguint i;\r\nstat_table->num_elements=table_index+1;\r\nstat_table->elements = (stat_tap_table_item_type**)g_realloc(stat_table->elements, sizeof(stat_tap_table_item_type*)*(stat_table->num_elements));\r\nfor(i=old_num_elements;i<stat_table->num_elements;i++){\r\nstat_table->elements[i] = g_new0(stat_tap_table_item_type, stat_table->num_fields);\r\n}\r\n}\r\nmemcpy(stat_table->elements[table_index], fields, num_fields*sizeof(stat_tap_table_item_type));\r\n}\r\nstat_tap_table_item_type* new_stat_tap_get_field_data(const stat_tap_table *stat_table, guint table_index, guint field_index)\r\n{\r\nstat_tap_table_item_type* field_value;\r\ng_assert(table_index < stat_table->num_elements);\r\nfield_value = stat_table->elements[table_index];\r\ng_assert(field_index < stat_table->num_fields);\r\nreturn &field_value[field_index];\r\n}\r\nvoid new_stat_tap_set_field_data(stat_tap_table *stat_table, guint table_index, guint field_index, stat_tap_table_item_type* field_data)\r\n{\r\nstat_tap_table_item_type* field_value;\r\ng_assert(table_index < stat_table->num_elements);\r\nfield_value = stat_table->elements[table_index];\r\ng_assert(field_index < stat_table->num_fields);\r\nfield_value[field_index] = *field_data;\r\n}\r\nvoid reset_stat_table(stat_tap_table_ui* new_stat, new_stat_tap_gui_reset_cb gui_callback, void *callback_data)\r\n{\r\nguint i = 0;\r\nstat_tap_table *stat_table;\r\nfor (i = 0; i < new_stat->tables->len; i++)\r\n{\r\nstat_table = g_array_index(new_stat->tables, stat_tap_table*, i);\r\nif (gui_callback)\r\ngui_callback(stat_table, callback_data);\r\nif (new_stat->stat_tap_reset_table_cb)\r\nnew_stat->stat_tap_reset_table_cb(stat_table);\r\n}\r\n}\r\nvoid free_stat_tables(stat_tap_table_ui* new_stat, new_stat_tap_gui_free_cb gui_callback, void *callback_data)\r\n{\r\nguint i = 0, element, field_index;\r\nstat_tap_table *stat_table;\r\nstat_tap_table_item_type* field_data;\r\nfor (i = 0; i < new_stat->tables->len; i++)\r\n{\r\nstat_table = g_array_index(new_stat->tables, stat_tap_table*, i);\r\nif (gui_callback)\r\ngui_callback(stat_table, callback_data);\r\nfor (element = 0; element < stat_table->num_elements; element++)\r\n{\r\nfor (field_index = 0; field_index < stat_table->num_fields; field_index++)\r\n{\r\nfield_data = new_stat_tap_get_field_data(stat_table, element, field_index);\r\nif (new_stat->stat_tap_free_table_item_cb)\r\nnew_stat->stat_tap_free_table_item_cb(stat_table, element, field_index, field_data);\r\n}\r\ng_free(stat_table->elements[element]);\r\n}\r\ng_free(stat_table->elements);\r\ng_free(stat_table);\r\n}\r\ng_array_set_size(new_stat->tables, 0);\r\n}

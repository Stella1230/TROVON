static int\r\ndissect_daap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *daap_tree;\r\nguint first_tag;\r\nfirst_tag = tvb_get_ntohl(tvb, 0);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "DAAP");\r\nif (first_tag == daap_png) {\r\ncall_dissector(png_handle, tvb, pinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\ncol_set_str(pinfo->cinfo, COL_INFO, "DAAP Response");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [first tag: %s, size: %d]",\r\ntvb_format_text(tvb, 0, 4),\r\ntvb_get_ntohl(tvb, 4));\r\nti = proto_tree_add_item(tree, proto_daap, tvb, 0, -1, ENC_NA);\r\ndaap_tree = proto_item_add_subtree(ti, ett_daap);\r\ndissect_daap_one_tag(daap_tree, tvb);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\ndissect_daap_one_tag(proto_tree *tree, tvbuff_t *tvb)\r\n{\r\nguint offset = 0;\r\nguint32 tagname, tagsize;\r\nproto_item *tag_ti;\r\nproto_tree *tag_tree;\r\ntvbuff_t *new_tvb;\r\nwhile (offset < tvb_reported_length(tvb)) {\r\ntagname = tvb_get_ntohl(tvb, offset);\r\ntagsize = tvb_get_ntohl(tvb, offset+4);\r\ntag_tree = proto_tree_add_subtree(tree, tvb, offset, -1,\r\nett_daap_sub, &tag_ti, "Tag: ");\r\nproto_tree_add_item_ret_uint(tag_tree, hf_daap_name,\r\ntvb, offset, 4, ENC_ASCII|ENC_NA, &tagname);\r\noffset += 4;\r\nproto_tree_add_item_ret_uint(tag_tree, hf_daap_size,\r\ntvb, offset, 4, ENC_BIG_ENDIAN, &tagsize);\r\noffset += 4;\r\nproto_item_append_text(tag_ti, "%s, %u byte%c",\r\nval_to_str_ext(tagname, &vals_tag_code_ext, "Unknown tag (0x%0x)"),\r\ntagsize, plurality(tagsize, ' ', 's'));\r\nproto_item_set_len(tag_ti, 8+tagsize);\r\nif (tagsize > G_MAXINT)\r\nbreak;\r\nswitch (tagname) {\r\ncase daap_mcon:\r\ncase daap_msrv:\r\ncase daap_mccr:\r\ncase daap_mdcl:\r\ncase daap_mlog:\r\ncase daap_mupd:\r\ncase daap_avdb:\r\ncase daap_mlcl:\r\ncase daap_mlit:\r\ncase daap_mbcl:\r\ncase daap_adbs:\r\ncase daap_aply:\r\ncase daap_apso:\r\ncase daap_mudl:\r\ncase daap_abro:\r\ncase daap_abar:\r\ncase daap_arsv:\r\ncase daap_abal:\r\ncase daap_abcp:\r\ncase daap_abgn:\r\ncase daap_prsv:\r\ncase daap_arif:\r\ncase dacp_casp:\r\ncase dacp_cmgt:\r\ncase dacp_cmst:\r\nnew_tvb = tvb_new_subset_length(tvb, offset, (gint)tagsize);\r\ndissect_daap_one_tag(tag_tree, new_tvb);\r\nbreak;\r\ncase daap_minm:\r\ncase daap_msts:\r\ncase daap_mcnm:\r\ncase daap_mcna:\r\ncase daap_asal:\r\ncase daap_asar:\r\ncase daap_ascm:\r\ncase daap_asfm:\r\ncase daap_aseq:\r\ncase daap_asgn:\r\ncase daap_asdt:\r\ncase daap_asul:\r\ncase daap_ascp:\r\ncase daap_asct:\r\ncase daap_ascn:\r\ncase daap_aslc:\r\ncase daap_asky:\r\ncase daap_aeSN:\r\ncase daap_aeNN:\r\ncase daap_aeEN:\r\ncase daap_assn:\r\ncase daap_assa:\r\ncase daap_assl:\r\ncase daap_assc:\r\ncase daap_asss:\r\ncase daap_asaa:\r\ncase daap_aspu:\r\ncase daap_aeCR:\r\ncase dacp_cana:\r\ncase dacp_cang:\r\ncase dacp_canl:\r\ncase dacp_cann:\r\nproto_tree_add_item(tag_tree, hf_daap_data_string,\r\ntvb, offset, tagsize, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase daap_mper:\r\ncase daap_aeGR:\r\ncase daap_aeGU:\r\ncase daap_asai:\r\ncase daap_asls:\r\nproto_tree_add_item(tag_tree, hf_daap_persistent_id,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_mstt:\r\nproto_tree_add_item(tag_tree, hf_daap_status,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_musr:\r\ncase daap_msur:\r\nproto_tree_add_item(tag_tree, hf_daap_rev,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_miid:\r\ncase daap_mcti:\r\ncase daap_mpco:\r\ncase daap_mlid:\r\nproto_tree_add_item(tag_tree, hf_daap_id,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_mrco:\r\ncase daap_mtco:\r\ncase daap_mimc:\r\ncase daap_msdc:\r\ncase daap_mctc:\r\nproto_tree_add_item(tag_tree, hf_daap_cnt,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_mstm:\r\nproto_tree_add_item(tag_tree, hf_daap_timeout,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_asda:\r\ncase daap_asdm:\r\ncase daap_assr:\r\ncase daap_assz:\r\ncase daap_asst:\r\ncase daap_assp:\r\ncase daap_astm:\r\ncase daap_aeNV:\r\ncase daap_ascd:\r\ncase daap_ascs:\r\ncase daap_aeSV:\r\ncase daap_aePI:\r\ncase daap_aeCI:\r\ncase daap_aeGI:\r\ncase daap_aeAI:\r\ncase daap_aeSI:\r\ncase daap_aeES:\r\ncase daap_asbo:\r\ncase daap_aeGH:\r\ncase daap_aeGD:\r\ncase daap_aeGE:\r\ncase dacp_cant:\r\ncase dacp_cast:\r\ncase dacp_cmsr:\r\ncase dacp_cmvo:\r\ncase daap_meds:\r\nproto_tree_add_item(tag_tree, hf_daap_data,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_mcty:\r\ncase daap_asbt:\r\ncase daap_asbr:\r\ncase daap_asdc:\r\ncase daap_asdn:\r\ncase daap_astc:\r\ncase daap_astn:\r\ncase daap_asyr:\r\ncase daap_ased:\r\nproto_tree_add_item(tag_tree, hf_daap_data,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_mikd:\r\ncase daap_msau:\r\ncase daap_msty:\r\ncase daap_asrv:\r\ncase daap_asur:\r\ncase daap_asdk:\r\ncase daap_muty:\r\ncase daap_msas:\r\ncase daap_aeHV:\r\ncase daap_aeHD:\r\ncase daap_aePC:\r\ncase daap_aePP:\r\ncase daap_aeMK:\r\ncase daap_aeSG:\r\ncase daap_apsm:\r\ncase daap_aprm:\r\ncase daap_asgp:\r\ncase daap_aePS:\r\ncase dacp_cafs:\r\ncase dacp_caps:\r\ncase dacp_carp:\r\ncase dacp_cash:\r\ncase dacp_cavs:\r\nproto_tree_add_item(tag_tree, hf_daap_data,\r\ntvb, offset, tagsize, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase daap_mslr:\r\ncase daap_msal:\r\ncase daap_msup:\r\ncase daap_mspi:\r\ncase daap_msex:\r\ncase daap_msbr:\r\ncase daap_msqy:\r\ncase daap_msix:\r\ncase daap_msrs:\r\ncase daap_asco:\r\ncase daap_asdb:\r\ncase daap_abpl:\r\ncase daap_aeSP:\r\ncase daap_asbk:\r\nproto_item_append_text(tag_ti, "; Data: True");\r\nbreak;\r\ncase daap_mpro:\r\ncase daap_apro:\r\nproto_item_append_text(tag_ti, "; Version: %d.%d.%d.%d",\r\ntvb_get_guint8(tvb, offset),\r\ntvb_get_guint8(tvb, offset+1),\r\ntvb_get_guint8(tvb, offset+2),\r\ntvb_get_guint8(tvb, offset+3));\r\nbreak;\r\ncase dacp_canp:\r\nproto_tree_add_item(tag_tree, hf_daap_playlist_id,\r\ntvb, offset+4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tag_tree, hf_daap_track_id,\r\ntvb, offset+12, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\noffset += tagsize;\r\n}\r\n}\r\nvoid\r\nproto_register_daap(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_daap_name,\r\n{ "Tag name", "daap.name", FT_UINT32,\r\nBASE_HEX|BASE_EXT_STRING, &vals_tag_code_ext, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_size,\r\n{ "Tag size", "daap.size",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_data_string,\r\n{ "Data string", "daap.data_string",\r\nFT_STRING, STR_ASCII, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_persistent_id,\r\n{ "Persistent Id", "daap.persistent_id",\r\nFT_UINT64, BASE_HEX, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_status,\r\n{ "Staus", "daap.status",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_rev,\r\n{ "Revision", "daap.revision",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_id,\r\n{ "Id", "daap.id",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_cnt,\r\n{ "Count", "daap.count",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_timeout,\r\n{ "Timeout (seconds)", "daap.timeout",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_data,\r\n{ "Data", "daap.data",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_playlist_id,\r\n{ "Playlist Id", "daap.playlist_id",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_daap_track_id,\r\n{ "Track Id", "daap.track_id",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_daap,\r\n&ett_daap_sub,\r\n};\r\nproto_daap = proto_register_protocol("Digital Audio Access Protocol",\r\n"DAAP", "daap");\r\nproto_register_field_array(proto_daap, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_daap(void)\r\n{\r\ndissector_handle_t daap_handle;\r\ndaap_handle = create_dissector_handle(dissect_daap, proto_daap);\r\nhttp_tcp_port_add(TCP_PORT_DAAP);\r\ndissector_add_string("media_type", "application/x-dmap-tagged", daap_handle);\r\npng_handle = find_dissector_add_dependency("png", proto_daap);\r\n}

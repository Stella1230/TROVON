GtkWidget*\r\ngui_prefs_show(void)\r\n{\r\nGtkWidget *main_grid, *main_vb;\r\n#ifdef _WIN32\r\nGtkWidget *console_open_om, *enable_update_cb;\r\n#endif\r\nGtkWidget *fileopen_rb, *fileopen_dir_te, *fileopen_preview_te;\r\nGtkWidget *recent_files_count_max_te, *recent_df_entries_max_te, *ask_unsaved_cb, *find_wrap_cb;\r\nGtkWidget *use_pref_save_cb;\r\nGtkWidget *show_version_om;\r\nGtkWidget *auto_scroll_cb, *scroll_percent_te;\r\nGtkWidget *webbrowser_te;\r\nGtkWidget *save_position_cb, *save_size_cb, *save_maximized_cb;\r\n#if defined(HAVE_IGE_MAC_INTEGRATION) || defined(HAVE_GTKOSXAPPLICATION)\r\nGtkWidget *macosx_style_cb;\r\n#endif\r\nGtkWidget *expert_info_eyecandy_cb;\r\nGtkWidget *packet_editor_cb;\r\nint pos = 0;\r\nchar current_val_str[128];\r\ncfile.columns_changed = FALSE;\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 7, FALSE);\r\ngtk_container_set_border_width( GTK_CONTAINER(main_vb), 5 );\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_set_vexpand(GTK_WIDGET(main_grid), FALSE);\r\n#endif\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 15);\r\nsave_position_cb = create_preference_check_button(main_grid, pos++,\r\n"Save window position:",\r\n"Save the position of the main window.",\r\nprefs.gui_geometry_save_position);\r\ng_object_set_data(G_OBJECT(main_vb), GEOMETRY_POSITION_KEY, save_position_cb);\r\nsave_size_cb = create_preference_check_button(main_grid, pos++,\r\n"Save window size:",\r\n"Save the size of the main window.",\r\nprefs.gui_geometry_save_size);\r\ng_object_set_data(G_OBJECT(main_vb), GEOMETRY_SIZE_KEY, save_size_cb);\r\nsave_maximized_cb = create_preference_check_button(main_grid, pos++,\r\n"Save maximized state:",\r\n"Save the maximized state of the main window.",\r\nprefs.gui_geometry_save_maximized);\r\ng_object_set_data(G_OBJECT(main_vb), GEOMETRY_MAXIMIZED_KEY, save_maximized_cb);\r\n#ifdef _WIN32\r\nenable_update_cb = create_preference_check_button(main_grid, pos++,\r\n"Check for updates:",\r\n"Periodically check for new versions of Wireshark.",\r\nprefs.gui_update_enabled);\r\ng_object_set_data(G_OBJECT(main_vb), ENABLE_UPDATE_KEY, enable_update_cb);\r\n#endif\r\n#if defined(HAVE_IGE_MAC_INTEGRATION) || defined(HAVE_GTKOSXAPPLICATION)\r\nmacosx_style_cb = create_preference_check_button(main_grid, pos++,\r\n"OS X style",\r\n"Create an OS X look and feel. Checking this box will move the "\r\n"menu bar to the top of the screen instead of the top of the Wireshark window. "\r\n"Requires a restart of Wireshark to take effect.",\r\nprefs.gui_macosx_style);\r\ng_object_set_data(G_OBJECT(main_vb), MACOSX_STYLE_KEY, macosx_style_cb);\r\n#endif\r\n#ifdef _WIN32\r\nconsole_open_om = create_preference_option_menu(main_grid, pos++,\r\n"Open a console window",\r\n"Whether to open a console window "\r\n"(Automatic will open a console if messages appear).",\r\ngui_console_open_vals, prefs.gui_console_open);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_CONSOLE_OPEN_KEY, console_open_om);\r\n#endif\r\nfileopen_rb = create_preference_radio_buttons(main_grid, pos++,\r\n"\"File Open\" dialog behavior:",\r\n"Which directory the \"File Open\" dialog should start with.",\r\ngui_fileopen_vals, prefs.gui_fileopen_style);\r\nfileopen_dir_te = create_preference_entry(main_grid, pos++,\r\n"Directory:",\r\n"The \"File Open\" dialog defaults always to this directory.",\r\nprefs.gui_fileopen_dir);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_FILEOPEN_KEY, fileopen_rb);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_FILEOPEN_DIR_KEY, fileopen_dir_te);\r\ng_signal_connect(fileopen_rb, "clicked", G_CALLBACK(fileopen_selected_cb), main_vb);\r\ng_signal_connect(fileopen_dir_te, "focus-out-event",\r\nG_CALLBACK(fileopen_dir_changed_cb), main_vb);\r\nfileopen_preview_te = create_preference_entry(main_grid, pos++,\r\n"\"File Open\" preview timeout:",\r\n"Reading preview data in the \"File Open\" dialog will be stopped after given seconds.",\r\nopen_file_preview_str);\r\ng_snprintf(current_val_str, sizeof(current_val_str), "%d", prefs.gui_fileopen_preview);\r\ngtk_entry_set_text(GTK_ENTRY(fileopen_preview_te), current_val_str);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_FILEOPEN_PREVIEW_KEY, fileopen_preview_te);\r\ng_signal_connect(fileopen_preview_te, "focus_out_event", G_CALLBACK(fileopen_preview_changed_cb), main_vb);\r\nrecent_df_entries_max_te = create_preference_entry(main_grid, pos++,\r\n"Maximum recent filters:",\r\n"Maximum number of recent entries in filter display list.",\r\nrecent_df_entries_max_str);\r\ng_snprintf(current_val_str, sizeof(current_val_str), "%d", prefs.gui_recent_df_entries_max);\r\ngtk_entry_set_text(GTK_ENTRY(recent_df_entries_max_te), current_val_str);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_RECENT_DF_ENTRIES_KEY, recent_df_entries_max_te);\r\ng_signal_connect(recent_df_entries_max_te, "focus_out_event", G_CALLBACK(recent_df_entries_changed_cb), main_vb);\r\nrecent_files_count_max_te = create_preference_entry(main_grid, pos++,\r\n"Maximum recent files:",\r\n"Maximum number of entries in the \"File/Open Recent\" list.",\r\nrecent_files_count_max_str);\r\ng_snprintf(current_val_str, sizeof(current_val_str), "%d", prefs.gui_recent_files_count_max);\r\ngtk_entry_set_text(GTK_ENTRY(recent_files_count_max_te), current_val_str);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_RECENT_FILES_COUNT_KEY, recent_files_count_max_te);\r\ng_signal_connect(recent_files_count_max_te, "focus_out_event", G_CALLBACK(recent_files_count_changed_cb), main_vb);\r\nfileopen_selected_cb(NULL, main_vb);\r\nask_unsaved_cb = create_preference_check_button(main_grid, pos++,\r\n"Confirm unsaved capture files:",\r\n"Whether a dialog should pop up in case of an unsaved capture file.",\r\nprefs.gui_ask_unsaved);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_ASK_UNSAVED_KEY, ask_unsaved_cb);\r\nfind_wrap_cb = create_preference_check_button(main_grid, pos++,\r\n"Wrap to end/beginning of file during a find:",\r\n"Whether a search should wrap in a capture file.",\r\nprefs.gui_find_wrap);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_FIND_WRAP_KEY, find_wrap_cb);\r\nuse_pref_save_cb = create_preference_check_button(main_grid, pos++,\r\n"Settings dialogs show a save button:",\r\n"Whether the various settings dialogs (e.g. Preferences) should "\r\n"use an explicit save button - for advanced users.",\r\nprefs.gui_use_pref_save);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_USE_PREF_SAVE_KEY, use_pref_save_cb);\r\nshow_version_om = create_preference_option_menu(main_grid, pos++,\r\n"Welcome screen and title bar shows version",\r\n"Whether version should be shown in the start page and/or main screen's title bar.",\r\ngui_version_placement_vals, prefs.gui_version_placement);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_SHOW_VERSION_KEY, show_version_om);\r\nauto_scroll_cb = create_preference_check_button(main_grid, pos++,\r\n"Auto scroll on expansion:",\r\n"Whether the details view should be automatically scrolled up when expanding an item.",\r\nprefs.gui_auto_scroll_on_expand );\r\ng_object_set_data(G_OBJECT(main_vb), GUI_AUTO_SCROLL_KEY, auto_scroll_cb);\r\nscroll_percent_te = create_preference_entry(main_grid, pos++,\r\n"Auto scroll percentage:",\r\n"Where to scroll the expanded item to within the view e.g. 0% = top of view, 50% = center of view.",\r\nscroll_percent_preview_str);\r\ng_snprintf(current_val_str, sizeof(current_val_str), "%d", prefs.gui_auto_scroll_percentage);\r\ngtk_entry_set_text(GTK_ENTRY(scroll_percent_te), current_val_str);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_SCROLL_PERCENT_KEY, scroll_percent_te);\r\ng_signal_connect(scroll_percent_te, "focus_out_event", G_CALLBACK(scroll_percent_changed_cb), main_vb);\r\nif (browser_needs_pref()) {\r\nwebbrowser_te = create_preference_entry(main_grid, pos++,\r\n"Web browser command:",\r\n"Command line to desired browser.",\r\nprefs.gui_webbrowser);\r\ngtk_entry_set_text(GTK_ENTRY(webbrowser_te), prefs.gui_webbrowser);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_WEBBROWSER_KEY, webbrowser_te);\r\n}\r\nexpert_info_eyecandy_cb = create_preference_check_button(main_grid, pos++,\r\n"Display icons in the Expert Infos dialog tab labels:",\r\n"Whether icon images should be displayed in the Expert Infos dialog tab labels.",\r\nprefs.gui_expert_composite_eyecandy );\r\ng_object_set_data(G_OBJECT(main_vb), GUI_EXPERT_EYECANDY_KEY, expert_info_eyecandy_cb);\r\npacket_editor_cb = create_preference_check_button(main_grid, pos++,\r\n"Enable Packet Editor (Experimental):",\r\n"Activate Packet Editor (Experimental)",\r\nprefs.gui_packet_editor);\r\ng_object_set_data(G_OBJECT(main_vb), GUI_PACKET_EDITOR, packet_editor_cb);\r\ngtk_widget_show_all(main_vb);\r\nreturn(main_vb);\r\n}\r\nstatic gint\r\nfetch_enum_value(gpointer control, const enum_val_t *enumvals)\r\n{\r\nreturn fetch_preference_option_menu_val(GTK_WIDGET(control), enumvals);\r\n}\r\nvoid\r\ngui_prefs_fetch(GtkWidget *w)\r\n{\r\nprefs.gui_geometry_save_position =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GEOMETRY_POSITION_KEY));\r\nprefs.gui_geometry_save_size =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GEOMETRY_SIZE_KEY));\r\nprefs.gui_geometry_save_maximized =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GEOMETRY_MAXIMIZED_KEY));\r\n#ifdef _WIN32\r\nprefs.gui_update_enabled =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), ENABLE_UPDATE_KEY));\r\n#endif\r\n#if defined(HAVE_IGE_MAC_INTEGRATION) || defined(HAVE_GTKOSXAPPLICATION)\r\nprefs.gui_macosx_style =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), MACOSX_STYLE_KEY));\r\n#endif\r\n#ifdef _WIN32\r\nprefs.gui_console_open = fetch_enum_value(\r\ng_object_get_data(G_OBJECT(w), GUI_CONSOLE_OPEN_KEY), gui_console_open_vals);\r\n#endif\r\nprefs.gui_fileopen_style = fetch_preference_radio_buttons_val(\r\n(GtkWidget *)g_object_get_data(G_OBJECT(w), GUI_FILEOPEN_KEY), gui_fileopen_vals);\r\ng_free(prefs.gui_fileopen_dir);\r\nprefs.gui_fileopen_dir = g_strdup(gtk_entry_get_text(\r\nGTK_ENTRY(g_object_get_data(G_OBJECT(w), GUI_FILEOPEN_DIR_KEY))));\r\nprefs.gui_ask_unsaved =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GUI_ASK_UNSAVED_KEY));\r\nprefs.gui_find_wrap =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GUI_FIND_WRAP_KEY));\r\nprefs.gui_use_pref_save =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GUI_USE_PREF_SAVE_KEY));\r\nprefs.gui_version_placement = (version_info_e)\r\nfetch_enum_value(g_object_get_data(G_OBJECT(w), GUI_SHOW_VERSION_KEY), gui_version_placement_vals);\r\nprefs.gui_auto_scroll_on_expand =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GUI_AUTO_SCROLL_KEY));\r\nif (browser_needs_pref()) {\r\ng_free(prefs.gui_webbrowser);\r\nprefs.gui_webbrowser = g_strdup(gtk_entry_get_text(\r\nGTK_ENTRY(g_object_get_data(G_OBJECT(w), GUI_WEBBROWSER_KEY))));\r\n}\r\nprefs.gui_expert_composite_eyecandy =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GUI_EXPERT_EYECANDY_KEY));\r\nprefs.gui_packet_editor =\r\ngtk_toggle_button_get_active((GtkToggleButton *)g_object_get_data(G_OBJECT(w), GUI_PACKET_EDITOR));\r\n}\r\nvoid\r\ngui_prefs_apply(GtkWidget *w _U_)\r\n{\r\n#ifdef _WIN32\r\nif (prefs.gui_console_open == console_open_always) {\r\ncreate_console();\r\n}\r\n#endif\r\nmain_titlebar_update();\r\nwelcome_header_set_message(NULL);\r\nsupported_redraw();\r\nhelp_redraw();\r\ntoolbar_redraw_all();\r\nset_tree_styles_all();\r\nmain_widgets_rearrange();\r\n}\r\nvoid\r\ngui_prefs_destroy(GtkWidget *w _U_)\r\n{\r\n}\r\nstatic gboolean\r\nrecent_df_entries_changed_cb(GtkWidget *recent_df_entry _U_,\r\nGdkEvent *event _U_, gpointer parent_w)\r\n{\r\nGtkWidget *recent_df_entries_count_te;\r\nguint newval;\r\nrecent_df_entries_count_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), GUI_RECENT_DF_ENTRIES_KEY);\r\nnewval = (guint)strtol(gtk_entry_get_text (GTK_ENTRY(recent_df_entries_count_te)), NULL, 10);\r\nif (newval > 0) {\r\nprefs.gui_recent_df_entries_max = newval;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nrecent_files_count_changed_cb(GtkWidget *recent_files_entry _U_,\r\nGdkEvent *event _U_, gpointer parent_w)\r\n{\r\nGtkWidget *recent_files_count_te;\r\nguint newval;\r\nrecent_files_count_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), GUI_RECENT_FILES_COUNT_KEY);\r\nnewval = (guint)strtol(gtk_entry_get_text (GTK_ENTRY(recent_files_count_te)), NULL, 10);\r\nif (newval > 0) {\r\nprefs.gui_recent_files_count_max = newval;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfileopen_preview_changed_cb(GtkWidget *recent_files_entry _U_,\r\nGdkEvent *event _U_, gpointer parent_w)\r\n{\r\nGtkWidget *fileopen_preview_te;\r\nguint newval;\r\nfileopen_preview_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), GUI_FILEOPEN_PREVIEW_KEY);\r\nnewval = (guint)strtol(gtk_entry_get_text (GTK_ENTRY(fileopen_preview_te)), NULL, 10);\r\nif (newval > 0) {\r\nprefs.gui_fileopen_preview = newval;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfileopen_dir_changed_cb(GtkWidget *fileopen_dir_te, GdkEvent *event _U_, gpointer parent_w _U_)\r\n{\r\nchar *lastchar;\r\ngint fileopen_dir_te_length;\r\nfileopen_dir_te_length = (gint) strlen(gtk_entry_get_text (GTK_ENTRY(fileopen_dir_te)));\r\nif (fileopen_dir_te_length == 0)\r\nreturn FALSE;\r\nlastchar = gtk_editable_get_chars(GTK_EDITABLE(fileopen_dir_te), fileopen_dir_te_length-1, -1);\r\nif (strcmp(lastchar, G_DIR_SEPARATOR_S) != 0){\r\ngtk_editable_insert_text(GTK_EDITABLE(fileopen_dir_te), G_DIR_SEPARATOR_S,\r\n1,\r\n&fileopen_dir_te_length);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\nfileopen_selected_cb(GtkWidget *mybutton_rb _U_, gpointer parent_w)\r\n{\r\nGtkWidget *fileopen_rb, *fileopen_dir_te;\r\nfileopen_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), GUI_FILEOPEN_KEY);\r\nfileopen_dir_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), GUI_FILEOPEN_DIR_KEY);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(fileopen_rb)))\r\n{\r\ngtk_widget_set_sensitive(GTK_WIDGET(fileopen_dir_te), TRUE);\r\n}\r\nelse\r\n{\r\ngtk_widget_set_sensitive(GTK_WIDGET(fileopen_dir_te), FALSE);\r\n}\r\nreturn;\r\n}\r\nstatic gboolean\r\nscroll_percent_changed_cb(GtkWidget *recent_files_entry _U_,\r\nGdkEvent *event _U_, gpointer parent_w)\r\n{\r\nGtkWidget *scroll_percent_te;\r\nguint newval;\r\nscroll_percent_te = (GtkWidget*)g_object_get_data(G_OBJECT(parent_w), GUI_SCROLL_PERCENT_KEY);\r\nnewval = (guint)strtol(gtk_entry_get_text(GTK_ENTRY(scroll_percent_te)), NULL, 10);\r\nif (newval <= 100) {\r\nprefs.gui_auto_scroll_percentage = newval;\r\n}\r\nif (newval <= 100) {\r\nprefs.gui_auto_scroll_percentage = newval;\r\n}\r\nreturn FALSE;\r\n}

static void\r\nconsole_log_handler(const char *log_domain, GLogLevelFlags log_level,\r\nconst char *message, gpointer user_data _U_)\r\n{\r\ntime_t curr;\r\nstruct tm *today;\r\nconst char *level;\r\nif((log_level & G_LOG_LEVEL_MASK & prefs.console_log_level) == 0 &&\r\nprefs.console_log_level != 0) {\r\nreturn;\r\n}\r\n#ifdef _WIN32\r\nif (prefs.gui_console_open != console_open_never || log_level & G_LOG_LEVEL_ERROR) {\r\ncreate_console();\r\n}\r\nif (get_has_console()) {\r\n#endif\r\nswitch(log_level & G_LOG_LEVEL_MASK) {\r\ncase G_LOG_LEVEL_ERROR:\r\nlevel = "Err ";\r\nbreak;\r\ncase G_LOG_LEVEL_CRITICAL:\r\nlevel = "Crit";\r\nbreak;\r\ncase G_LOG_LEVEL_WARNING:\r\nlevel = "Warn";\r\nbreak;\r\ncase G_LOG_LEVEL_MESSAGE:\r\nlevel = "Msg ";\r\nbreak;\r\ncase G_LOG_LEVEL_INFO:\r\nlevel = "Info";\r\nbreak;\r\ncase G_LOG_LEVEL_DEBUG:\r\nlevel = "Dbg ";\r\nbreak;\r\ndefault:\r\nfprintf(stderr, "unknown log_level %d\n", log_level);\r\nlevel = NULL;\r\ng_assert_not_reached();\r\n}\r\ntime(&curr);\r\ntoday = localtime(&curr);\r\nfprintf(stderr, "%02d:%02d:%02d %8s %s %s\n",\r\ntoday->tm_hour, today->tm_min, today->tm_sec,\r\nlog_domain != NULL ? log_domain : "",\r\nlevel, message);\r\n#ifdef _WIN32\r\nif(log_level & G_LOG_LEVEL_ERROR) {\r\nprintf("\n\nPress any key to exit\n");\r\n_getch();\r\n}\r\n} else {\r\ng_log_default_handler(log_domain, log_level, message, user_data);\r\n}\r\n#endif\r\n}\r\nvoid set_console_log_handler(void)\r\n{\r\nGLogLevelFlags log_flags;\r\nlog_flags = (GLogLevelFlags)\r\n(G_LOG_LEVEL_ERROR|\r\nG_LOG_LEVEL_CRITICAL|\r\nG_LOG_LEVEL_WARNING|\r\nG_LOG_LEVEL_MESSAGE|\r\nG_LOG_LEVEL_INFO|\r\nG_LOG_LEVEL_DEBUG|\r\nG_LOG_FLAG_FATAL|\r\nG_LOG_FLAG_RECURSION);\r\ng_log_set_handler(NULL,\r\nlog_flags,\r\nconsole_log_handler, NULL );\r\ng_log_set_handler(LOG_DOMAIN_MAIN,\r\nlog_flags,\r\nconsole_log_handler, NULL );\r\n#ifdef HAVE_LIBPCAP\r\ng_log_set_handler(LOG_DOMAIN_CAPTURE,\r\nlog_flags,\r\nconsole_log_handler, NULL );\r\ng_log_set_handler(LOG_DOMAIN_CAPTURE_CHILD,\r\nlog_flags,\r\nconsole_log_handler, NULL );\r\n#endif\r\n}

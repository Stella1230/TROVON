static int\r\ndissect_cimetrics_mstp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *subtree;\r\ngint offset = 0;\r\n#ifdef BACNET_MSTP_SUMMARY_IN_TREE\r\nguint8 mstp_frame_type = 0;\r\nguint8 mstp_frame_source = 0;\r\nguint8 mstp_frame_destination = 0;\r\n#endif\r\n#ifdef BACNET_MSTP_SUMMARY_IN_TREE\r\nmstp_frame_type = tvb_get_guint8(tvb, offset+3);\r\nmstp_frame_destination = tvb_get_guint8(tvb, offset+4);\r\nmstp_frame_source = tvb_get_guint8(tvb, offset+5);\r\nti = proto_tree_add_protocol_format(tree,\r\nproto_cimetrics_mstp, tvb, offset, 9,\r\n"BACnet MS/TP, Src (%u), Dst (%u), %s",\r\nmstp_frame_source, mstp_frame_destination,\r\nmstp_frame_type_text(mstp_frame_type));\r\n#else\r\nti = proto_tree_add_item(tree, proto_cimetrics_mstp, tvb, offset, 9, ENC_NA);\r\n#endif\r\nsubtree = proto_item_add_subtree(ti, ett_cimetrics_mstp);\r\nproto_tree_add_item(subtree, hf_cimetrics_mstp_timer, tvb,\r\noffset++, 2, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(subtree, hf_cimetrics_mstp_value, tvb,\r\noffset++, 1, ENC_LITTLE_ENDIAN);\r\ndissect_mstp(tvb, pinfo, tree, subtree, offset);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_cimetrics(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_cimetrics_mstp_timer,\r\n{ "Delta Time", "cimetrics.mstp_timer",\r\nFT_UINT16, BASE_DEC, NULL, 0,\r\n"Milliseconds", HFILL }\r\n},\r\n{ &hf_cimetrics_mstp_value,\r\n{ "8-bit value", "cimetrics.mstp_value",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\n"value", HFILL }\r\n}\r\n};\r\nstatic hf_register_info hf2[] = {\r\n{ &hf_llc_cimetrics_pid,\r\n{ "PID", "llc.cimetrics_pid",\r\nFT_UINT16, BASE_HEX, VALS(cimetrics_pid_vals), 0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_cimetrics_mstp\r\n};\r\nproto_cimetrics_mstp = proto_register_protocol("Cimetrics MS/TP",\r\n"Cimetrics MS/TP", "cimetrics");\r\nproto_register_field_array(proto_cimetrics_mstp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("cimetrics", dissect_cimetrics_mstp,\r\nproto_cimetrics_mstp);\r\nllc_add_oui(OUI_CIMETRICS, "llc.cimetrics_pid",\r\n"LLC Cimetrics OUI PID", hf2, proto_cimetrics_mstp);\r\n}\r\nvoid\r\nproto_reg_handoff_cimetrics(void)\r\n{\r\ndissector_handle_t mstp_handle;\r\nmstp_handle = find_dissector("cimetrics");\r\ndissector_add_uint("llc.cimetrics_pid", 1, mstp_handle);\r\n}

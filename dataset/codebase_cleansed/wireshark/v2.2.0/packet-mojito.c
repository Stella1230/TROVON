static int\r\ndissect_mojito_address(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nint offset, const char *title)\r\n{\r\nint offset_start;\r\nguint8 socket_address_version;\r\nproto_tree *socket_tree;\r\nproto_item *socket_item;\r\noffset_start = offset;\r\nsocket_address_version = tvb_get_guint8(tvb, offset);\r\nsocket_tree = proto_tree_add_subtree(tree, tvb, offset, 1, ett_mojito_socket_address, &socket_item, title);\r\nproto_tree_add_item(socket_tree, hf_mojito_socketaddress_version, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nswitch (socket_address_version)\r\n{\r\ncase FT_IPv4_LEN:\r\nproto_tree_add_item(socket_tree, hf_mojito_socketaddress_ipv4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase FT_IPv6_LEN:\r\nproto_tree_add_item(socket_tree, hf_mojito_socketaddress_ipv6, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, socket_item, &ei_mojito_socketaddress_unknown);\r\nreturn 0;\r\n}\r\nproto_tree_add_item(socket_tree, hf_mojito_socketaddress_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_item_set_len(socket_item, offset - offset_start);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_mojito_contact(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, int contact_id)\r\n{\r\nint offset_start;\r\nproto_tree *contact_tree, *version_tree;\r\nproto_item *contact_item, *version_item;\r\noffset_start = offset;\r\nif (contact_id > 0)\r\n{\r\ncontact_tree = proto_tree_add_subtree_format(tree, tvb, offset, 1, ett_mojito_contact, &contact_item, "Contact #%d", contact_id);\r\n}\r\nelse\r\n{\r\ncontact_tree = proto_tree_add_subtree(tree, tvb, offset, 1, ett_mojito_contact, &contact_item, "Contact");\r\n}\r\nproto_tree_add_item(contact_tree, hf_mojito_contactvendor, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\noffset += 4;\r\nversion_item = proto_tree_add_item(contact_tree, hf_mojito_contactversion, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nversion_tree = proto_item_add_subtree(version_item, ett_mojito_contact_version);\r\nproto_tree_add_item(version_tree, hf_mojito_mjrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(version_tree, hf_mojito_mnrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(contact_tree, hf_mojito_contactkuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\noffset = dissect_mojito_address(tvb, pinfo, contact_tree, offset, "Socket Address");\r\nif (offset == 0)\r\n{\r\nreturn 0;\r\n}\r\nproto_item_set_len(contact_item, offset - offset_start);\r\nreturn offset - offset_start;\r\n}\r\nstatic int\r\ndissect_mojito_header(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nint offset, mojito_header_data_t* header_data)\r\n{\r\nproto_tree *header_tree, *version_tree, *contact_tree, *flag_tree;\r\nproto_item *header_item, *contact_item, *flag_item;\r\nint start_offset = offset;\r\nint contact_start_offset;\r\nheader_tree = proto_tree_add_subtree(tree, tvb, offset, 61, ett_mojito_header, &header_item, "Gnutella Header");\r\nproto_tree_add_item(header_tree, hf_mojito_messageid, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item(header_tree, hf_mojito_fdhtmessage, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nversion_tree = proto_tree_add_subtree(header_tree, tvb, offset, 2, ett_mojito_header_version, NULL, "Version");\r\nproto_tree_add_item(version_tree, hf_mojito_mjrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(version_tree, hf_mojito_mnrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nheader_data->payloadlength = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(header_tree, hf_mojito_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nheader_data->opcode = tvb_get_guint8(tvb, offset);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", val_to_str_const(header_data->opcode, opcodeflags, "Unknown"));\r\nproto_tree_add_item(header_tree, hf_mojito_opcode, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncontact_start_offset = offset;\r\ncontact_tree = proto_tree_add_subtree(header_tree, tvb, offset, 35, ett_mojito_contact, &contact_item, "Originating Contact");\r\nproto_tree_add_item(contact_tree, hf_mojito_vendor, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\noffset += 4;\r\nversion_tree = proto_tree_add_subtree(contact_tree, tvb, offset, 2, ett_mojito_contact_version, NULL, "Contact Version");\r\nproto_tree_add_item(version_tree, hf_mojito_origmjrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(version_tree, hf_mojito_origmnrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(contact_tree, hf_mojito_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\noffset = dissect_mojito_address(tvb, pinfo, contact_tree, offset, "Socket Address");\r\nif (offset == 0)\r\n{\r\nreturn 0;\r\n}\r\nproto_item_set_len(contact_item, offset - contact_start_offset);\r\nproto_tree_add_item(header_tree, hf_mojito_instanceid, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nflag_item = proto_tree_add_item(header_tree, hf_mojito_flags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nflag_tree = proto_item_add_subtree(flag_item, ett_mojito_flags);\r\nproto_tree_add_item(flag_tree, hf_mojito_flags_shutdown, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flag_tree, hf_mojito_flags_firewalled, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(header_tree, hf_mojito_extendedlength, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_item_set_len(header_item, offset-start_offset);\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_mojito_ping_response(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint8 bigintlen;\r\nproto_tree *bigint_tree;\r\nproto_item *bigint_item;\r\noffset = dissect_mojito_address(tvb, pinfo, tree,\r\noffset, "Requester's External Socket Address");\r\nif (offset == 0)\r\n{\r\nreturn;\r\n}\r\nbigintlen = tvb_get_guint8(tvb, offset);\r\nbigint_tree = proto_tree_add_subtree(tree, tvb, offset, bigintlen + 1, ett_mojito_bigint, &bigint_item, "Estimated DHT size");\r\nproto_tree_add_item(bigint_tree, hf_mojito_bigintegerlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (bigintlen)\r\n{\r\ncase 1:\r\nproto_tree_add_item(bigint_tree, hf_mojito_bigint_value_one, tvb, offset, bigintlen, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(bigint_tree, hf_mojito_bigint_value_two, tvb, offset, bigintlen, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(bigint_tree, hf_mojito_bigint_value_three, tvb, offset, bigintlen, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(bigint_tree, hf_mojito_bigint_value_four, tvb, offset, bigintlen, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, bigint_item, &ei_mojito_bigint_unsupported);\r\nreturn;\r\n}\r\nproto_tree_add_item(bigint_tree, hf_mojito_bigintegerval, tvb, offset, bigintlen, ENC_NA);\r\n}\r\nstatic void\r\ndissect_mojito_store_request(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nproto_tree *dht_tree, *version_tree;\r\nproto_item *dht_item, *version_item;\r\nguint8 ii, contactcount;\r\nguint8 sectokenlen = tvb_get_guint8(tvb, offset);\r\nguint16 dhtvaluelength;\r\nint contact_offset, start_offset;\r\nproto_tree_add_item(tree, hf_mojito_sectokenlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_mojito_sectoken, tvb, offset, sectokenlen, ENC_NA);\r\noffset += sectokenlen;\r\nproto_tree_add_item(tree, hf_mojito_dhtvaluecount, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncontactcount = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nfor (ii = 0; ii < contactcount; ii++)\r\n{\r\ndht_tree = proto_tree_add_subtree_format(tree, tvb, offset, 1, ett_mojito_dht, &dht_item, "DHTValue #%d", ii+1);\r\nstart_offset = offset;\r\ncontact_offset = dissect_mojito_contact(tvb, pinfo, dht_tree, offset, -1);\r\nif (contact_offset == 0)\r\nreturn;\r\noffset += contact_offset;\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_valuetype, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\noffset += 4;\r\nversion_item = proto_tree_add_item(dht_tree, hf_mojito_dhtvalue_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nversion_tree = proto_item_add_subtree(version_item, ett_mojito_dht_version);\r\nproto_tree_add_item(version_tree, hf_mojito_mjrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(version_tree, hf_mojito_mnrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ndhtvaluelength = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_value, tvb, offset, dhtvaluelength, ENC_ASCII|ENC_NA);\r\noffset += dhtvaluelength;\r\nproto_item_set_len(dht_item, offset-start_offset);\r\n}\r\n}\r\nstatic void\r\ndissect_mojito_store_response(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *sc_tree;\r\nproto_item *sc_item;\r\nguint8 ii, contactcount = tvb_get_guint8(tvb, offset);\r\nguint16 dhtvaluelength;\r\nint start_offset;\r\nproto_tree_add_item(tree, hf_mojito_storestatuscode_count, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (ii = 0; ii < contactcount; ii++)\r\n{\r\nsc_tree = proto_tree_add_subtree_format(tree, tvb, offset, 23, ett_mojito_status_code, &sc_item, "Status Code %d", ii+1);\r\nstart_offset = offset;\r\nproto_tree_add_item(sc_tree, hf_mojito_storestatuscode_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nif (tvb_reported_length_remaining(tvb, offset+3) > 0)\r\n{\r\nproto_tree_add_item(sc_tree, hf_mojito_storestatuscode_secondary_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\n}\r\nproto_tree_add_item(sc_tree, hf_mojito_storestatuscode_code, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ndhtvaluelength = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(sc_tree, hf_mojito_dhtvalue_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sc_tree, hf_mojito_dhtvalue_value, tvb, offset, dhtvaluelength, ENC_ASCII|ENC_NA);\r\noffset += dhtvaluelength;\r\nproto_item_set_len(sc_item, offset-start_offset);\r\n}\r\n}\r\nstatic void\r\ndissect_mojito_find_node_response(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint8 ii, contactcount;\r\nguint8 sectokenlen = tvb_get_guint8(tvb, offset);\r\nint contact_offset;\r\nproto_tree_add_item(tree, hf_mojito_sectokenlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_mojito_sectoken, tvb, offset, sectokenlen, ENC_NA);\r\noffset += sectokenlen;\r\ncontactcount = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_mojito_contactcount, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (ii = 0; ii < contactcount; ii++)\r\n{\r\ncontact_offset = dissect_mojito_contact(tvb, pinfo, tree, offset, ii+1);\r\nif (contact_offset == 0)\r\nreturn;\r\noffset += contact_offset;\r\n}\r\n}\r\nstatic void\r\ndissect_mojito_find_value_request(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *kuid_tree;\r\nguint8 i, kuidcount;\r\nif (!tree)\r\nreturn;\r\nproto_tree_add_item(tree, hf_mojito_target_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nkuidcount = tvb_get_guint8(tvb, offset);\r\nkuid_tree = proto_tree_add_subtree(tree, tvb, offset, (20 * kuidcount) + 1, ett_mojito_kuids, NULL, "Secondary KUID\'s");\r\nproto_tree_add_item(kuid_tree, hf_mojito_kuidcount, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (i = 0; i < kuidcount; i++)\r\n{\r\nproto_tree_add_item(kuid_tree, hf_mojito_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\n}\r\nproto_tree_add_item(tree, hf_mojito_dhtvaluetype, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\n}\r\nstatic void\r\ndissect_mojito_find_value_response(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nproto_tree *dht_tree, *version_tree, *kuid_tree;\r\nproto_item *dht_item, *version_item;\r\nguint16 dhtvaluelength;\r\nint contact_offset, start_offset;\r\nguint8 ii, dhtvaluescount, kuidcount;\r\nproto_tree_add_item(tree, hf_mojito_requestload, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndhtvaluescount = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_mojito_dhtvaluecount, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (ii = 0; ii < dhtvaluescount; ii++)\r\n{\r\ndht_tree = proto_tree_add_subtree_format(tree, tvb, offset, 1, ett_mojito_dht, &dht_item, "DHTValue #%d", ii+1);\r\nstart_offset = offset;\r\ncontact_offset = dissect_mojito_contact(tvb, pinfo, dht_tree, offset, -1);\r\nif (contact_offset == 0)\r\nreturn;\r\noffset += contact_offset;\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_valuetype, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\noffset += 4;\r\nversion_item = proto_tree_add_item(dht_tree, hf_mojito_dhtvalue_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nversion_tree = proto_item_add_subtree(version_item, ett_mojito_dht_version);\r\nproto_tree_add_item(version_tree, hf_mojito_mjrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(version_tree, hf_mojito_mnrversion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ndhtvaluelength = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dht_tree, hf_mojito_dhtvalue_value, tvb, offset, dhtvaluelength, ENC_ASCII|ENC_NA);\r\noffset += dhtvaluelength;\r\nproto_item_set_len(dht_item, offset-start_offset);\r\n}\r\nkuidcount = tvb_get_guint8(tvb, offset);\r\nkuid_tree = proto_tree_add_subtree(tree, tvb, offset, (20 * kuidcount) + 1, ett_mojito_kuids, NULL, "Secondary KUID\'s");\r\nproto_tree_add_item(kuid_tree, hf_mojito_kuidcount, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (ii = 0; ii < kuidcount; ii++)\r\n{\r\nproto_tree_add_item(kuid_tree, hf_mojito_kuid, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\n}\r\n}\r\nstatic int\r\ndissect_mojito(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *mojito_tree, *opcode_tree;\r\nproto_item *ti;\r\nmojito_header_data_t header_data;\r\ngint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Mojito");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_mojito, tvb, 0, -1, ENC_NA);\r\nmojito_tree = proto_item_add_subtree(ti, ett_mojito);\r\noffset = dissect_mojito_header(tvb, pinfo, mojito_tree, offset, &header_data);\r\nif (offset == 0)\r\nreturn 0;\r\nopcode_tree = proto_tree_add_subtree_format(mojito_tree, tvb,\r\noffset, header_data.payloadlength - MOJITO_HEADER_LENGTH,\r\nett_mojito_opcode, NULL, "Opcode specific data (%s)",\r\nval_to_str_const(header_data.opcode, opcodeflags, "Unknown"));\r\nswitch (header_data.opcode)\r\n{\r\ncase MOJITO_PING_RESPONSE:\r\ndissect_mojito_ping_response(tvb, pinfo, opcode_tree, offset);\r\nbreak;\r\ncase MOJITO_STORE_REQUEST:\r\ndissect_mojito_store_request(tvb, pinfo, opcode_tree, offset);\r\nbreak;\r\ncase MOJITO_STORE_RESPONSE:\r\ndissect_mojito_store_response(tvb, pinfo, opcode_tree, offset);\r\nbreak;\r\ncase MOJITO_FIND_NODE_REQUEST:\r\nproto_tree_add_item(opcode_tree, hf_mojito_target_kuid, tvb, offset, 20, ENC_NA);\r\nbreak;\r\ncase MOJITO_FIND_NODE_RESPONSE:\r\ndissect_mojito_find_node_response(tvb, pinfo, opcode_tree, offset);\r\nbreak;\r\ncase MOJITO_FIND_VALUE_REQUEST:\r\ndissect_mojito_find_value_request(tvb, pinfo, opcode_tree, offset);\r\nbreak;\r\ncase MOJITO_FIND_VALUE_RESPONSE:\r\ndissect_mojito_find_value_response(tvb, pinfo, opcode_tree, offset);\r\nbreak;\r\ncase MOJITO_PING_REQUEST:\r\ncase MOJITO_STATS_REQUEST_DEPRECATED:\r\ncase MOJITO_STATS_RESPONSE_DEPRECATED:\r\ndefault:\r\nif (header_data.payloadlength - MOJITO_HEADER_LENGTH > 0)\r\nproto_tree_add_item(opcode_tree, hf_mojito_opcode_data, tvb,\r\noffset, header_data.payloadlength - MOJITO_HEADER_LENGTH, ENC_NA);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean dissect_mojito_heuristic (tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif ((tvb_captured_length(tvb) >= 60) &&\r\n(tvb_get_guint8(tvb, 16) == 68) &&\r\n((tvb_get_letohl(tvb, 19) + 23) == tvb_reported_length(tvb)))\r\n{\r\ndissect_mojito(tvb, pinfo, tree, NULL);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nvoid\r\nproto_register_mojito(void)\r\n{\r\nmodule_t *mojito_module;\r\nexpert_module_t* expert_mojito;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_mojito_dhtvaluecount,\r\n{ "DHTValue Count", "mojito.dhtvaluecount",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_messageid,\r\n{ "Message ID", "mojito.messageid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_requestload,\r\n{ "Request Load", "mojito.requestload",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_fdhtmessage,\r\n{ "FDHTMessage", "mojito.fdhtmessage",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_mjrversion,\r\n{ "Major Version", "mojito.majorversion",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_mnrversion,\r\n{ "Minor Version", "mojito.minorversion",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_length,\r\n{ "Payload Length", "mojito.payloadlength",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_opcode,\r\n{ "OPCode", "mojito.opcode",\r\nFT_UINT8, BASE_DEC,\r\nVALS(opcodeflags), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_vendor,\r\n{ "Vendor", "mojito.vendor",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_origmjrversion,\r\n{ "Major Version", "mojito.majorversion",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_origmnrversion,\r\n{ "Minor Version", "mojito.minorversion",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_kuid,\r\n{ "Kademlia Unique ID (KUID)", "mojito.kuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_socketaddress_version,\r\n{ "IP Version", "mojito.socketaddressversion",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_socketaddress_ipv4,\r\n{ "IP Address", "mojito.socketaddressipv4",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_socketaddress_ipv6,\r\n{ "IP Address", "mojito.socketaddressipv6",\r\nFT_IPv6, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_socketaddress_port,\r\n{ "IP Port", "mojito.socketaddressport",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_instanceid,\r\n{ "Instance ID", "mojito.instanceid",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_flags,\r\n{ "Flags", "mojito.flags",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_flags_shutdown,\r\n{ "SHUTDOWN", "mojito.shutdownflag",\r\nFT_BOOLEAN, 8,\r\nNULL, 2,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_flags_firewalled,\r\n{ "Firewalled", "mojito.firewalledflag",\r\nFT_BOOLEAN, 8,\r\nNULL, 1,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_extendedlength,\r\n{ "Extended Length", "mojito.extlength",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_kuidcount,\r\n{ "Secondary KUID Count", "mojito.kuidcount",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_dhtvaluetype,\r\n{ "DHT Value Type", "mojito.dhtvaluetype",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_bigintegerlen,\r\n{ "Big Integer Length", "mojito.bigintegerlen",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_bigintegerval,\r\n{ "Big Integer HEX Value", "mojito.bigintegerhexval",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_sectokenlen,\r\n{ "Security Token Length", "mojito.sectokenlen",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_sectoken,\r\n{ "Security Token", "mojito.sectoken",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_contactcount,\r\n{ "Contact Count", "mojito.contactcount",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_contactvendor,\r\n{ "Vendor", "mojito.contactvendor",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_contactversion,\r\n{ "Contact Version", "mojito.contactversion",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_contactkuid,\r\n{ "KUID of the Contact", "mojito.contactkuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_dhtvalue_valuetype,\r\n{ "DHTValue ValueType", "mojito.dhtvaluevaluetype",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_dhtvalue_version,\r\n{ "DHTValue Version", "mojito.dhtvalueversion",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_dhtvalue_length,\r\n{ "DHTValue Length", "mojito.dhtvaluelength",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_dhtvalue_value,\r\n{ "DHTValue", "mojito.dhtvaluehexvalue",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_bigint_value_one,\r\n{ "Big Integer DEC Value", "mojito.bigintegerval",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_bigint_value_two,\r\n{ "Big Integer DEC Value", "mojito.bigintegerval",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_bigint_value_three,\r\n{ "Big Integer DEC Value", "mojito.bigintegerval",\r\nFT_UINT24, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_bigint_value_four,\r\n{ "Big Integer DEC Value", "mojito.bigintegerval",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_dhtvalue_kuid,\r\n{ "Kademlia Unique ID (KUID)", "mojito.kuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_target_kuid,\r\n{ "Target Kademlia Unique ID (KUID)", "mojito.kuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_storestatuscode_count,\r\n{ "Status Code Count", "mojito.statuscodecount",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_storestatuscode_code,\r\n{ "StatusCode", "mojito.statuscodecount",\r\nFT_UINT16, BASE_DEC,\r\nVALS(statuscodeflags), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_storestatuscode_kuid,\r\n{ "Primary KUID of the Status Code", "mojito.statuscodekuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_storestatuscode_secondary_kuid,\r\n{ "Secondary KUID of the Status Code", "mojito.statuscodesecondarykuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mojito_opcode_data,\r\n{ "Data", "mojito.opcode.data",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mojito,\r\n&ett_mojito_header,\r\n&ett_mojito_header_version,\r\n&ett_mojito_contact,\r\n&ett_mojito_contact_version,\r\n&ett_mojito_socket_address,\r\n&ett_mojito_flags,\r\n&ett_mojito_bigint,\r\n&ett_mojito_opcode,\r\n&ett_mojito_dht_version,\r\n&ett_mojito_dht,\r\n&ett_mojito_status_code,\r\n&ett_mojito_kuids\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_mojito_socketaddress_unknown, { "mojito.socketaddress.unknown", PI_PROTOCOL, PI_ERROR, "Unsupported Socket Address Type", EXPFILL }},\r\n{ &ei_mojito_bigint_unsupported, { "mojito.bigint.unsupported", PI_PROTOCOL, PI_ERROR, "Unsupported BigInt length", EXPFILL }},\r\n};\r\nproto_mojito = proto_register_protocol("Mojito DHT", "Mojito", "mojito");\r\nproto_register_field_array(proto_mojito, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_mojito = expert_register_protocol(proto_mojito);\r\nexpert_register_field_array(expert_mojito, ei, array_length(ei));\r\nmojito_module = prefs_register_protocol(proto_mojito, NULL);\r\nprefs_register_uint_preference(mojito_module,\r\n"udp.port",\r\n"Mojito UDP Port",\r\n"Mojito UDP Port",\r\n10,\r\n&udp_mojito_port);\r\n}\r\nvoid\r\nproto_reg_handoff_mojito(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic int old_mojito_udp_port = 0;\r\nstatic dissector_handle_t mojito_handle;\r\nif (!initialized) {\r\nmojito_handle = create_dissector_handle(dissect_mojito, proto_mojito);\r\nheur_dissector_add("udp", dissect_mojito_heuristic, "Mojito over UDP", "mojito_udp", proto_mojito, HEURISTIC_ENABLE);\r\ninitialized = TRUE;\r\n}\r\nif(old_mojito_udp_port != 0 && old_mojito_udp_port != udp_mojito_port){\r\ndissector_delete_uint("udp.port", old_mojito_udp_port, mojito_handle);\r\n}\r\nif(udp_mojito_port != 0 && old_mojito_udp_port != udp_mojito_port) {\r\ndissector_add_uint("udp.port", udp_mojito_port, mojito_handle);\r\n}\r\nold_mojito_udp_port = udp_mojito_port;\r\n}

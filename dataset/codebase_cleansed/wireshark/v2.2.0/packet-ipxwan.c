static int\r\ndissect_ipxwan(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *ipxwan_tree = NULL;\r\nint offset = 0;\r\nguint8 packet_type;\r\nguint8 num_options;\r\nguint8 option_number;\r\nproto_tree *option_tree;\r\nguint16 option_data_len;\r\nguint16 wan_link_delay;\r\nguint32 delay;\r\nguint32 throughput;\r\nguint32 delta_time;\r\nguint8 compression_type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "IPX WAN");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_ipxwan, tvb, 0, -1,\r\nENC_NA);\r\nipxwan_tree = proto_item_add_subtree(ti, ett_ipxwan);\r\nproto_tree_add_item(ipxwan_tree, hf_ipxwan_identifier, tvb,\r\noffset, 4, ENC_ASCII|ENC_NA);\r\noffset += 4;\r\npacket_type = tvb_get_guint8(tvb, offset);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(packet_type, ipxwan_packet_type_vals,\r\n"Unknown packet type %u"));\r\nproto_tree_add_uint(ipxwan_tree, hf_ipxwan_packet_type, tvb,\r\noffset, 1, packet_type);\r\noffset += 1;\r\nproto_tree_add_item(ipxwan_tree, hf_ipxwan_node_id, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ipxwan_tree, hf_ipxwan_sequence_number, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nnum_options = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(ipxwan_tree, hf_ipxwan_num_options, tvb,\r\noffset, 1, num_options);\r\noffset += 1;\r\nwhile (num_options != 0) {\r\noption_number = tvb_get_guint8(tvb, offset);\r\noption_tree = proto_tree_add_subtree_format(ipxwan_tree, tvb, offset, -1,\r\nett_ipxwan_option, &ti, "Option: %s",\r\nval_to_str(option_number, ipxwan_option_num_vals,\r\n"Unknown (%u)"));\r\nproto_tree_add_uint(option_tree, hf_ipxwan_option_num,\r\ntvb, offset, 1, option_number);\r\noffset += 1;\r\nproto_tree_add_item(option_tree, hf_ipxwan_accept_option,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noption_data_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_uint(option_tree, hf_ipxwan_option_data_len,\r\ntvb, offset, 2, option_data_len);\r\noffset += 2;\r\nproto_item_set_len(ti, option_data_len+4);\r\nswitch (option_number) {\r\ncase OPT_ROUTING_TYPE:\r\nif (option_data_len != 1) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be 1", option_data_len);\r\n} else {\r\nproto_tree_add_item(option_tree,\r\nhf_ipxwan_routing_type, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\ncase OPT_RIP_SAP_INFO_EXCHANGE:\r\nif (option_data_len != 54) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be 54", option_data_len);\r\n} else {\r\nwan_link_delay = tvb_get_ntohs(tvb,\r\noffset);\r\nproto_tree_add_uint_format_value(option_tree,\r\nhf_ipxwan_wan_link_delay, tvb,\r\noffset, 2, wan_link_delay,\r\n"%ums",\r\nwan_link_delay);\r\nproto_tree_add_item(option_tree,\r\nhf_ipxwan_common_network_number,\r\ntvb, offset+2, 4, ENC_NA);\r\nproto_tree_add_item(option_tree,\r\nhf_ipxwan_router_name, tvb,\r\noffset+6, 48, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase OPT_NLSP_INFORMATION:\r\nif (option_data_len != 8) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be 8", option_data_len);\r\n} else {\r\ndelay = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format_value(option_tree,\r\nhf_ipxwan_delay, tvb,\r\noffset, 4, delay,\r\n"%uus", delay);\r\nthroughput = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format_value(option_tree,\r\nhf_ipxwan_throughput, tvb,\r\noffset, 4, throughput,\r\n"%uus",\r\nthroughput);\r\n}\r\nbreak;\r\ncase OPT_NLSP_RAW_THROUGHPUT_DATA:\r\nif (option_data_len != 8) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be 8", option_data_len);\r\n} else {\r\nproto_tree_add_item(option_tree,\r\nhf_ipxwan_request_size, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\ndelta_time = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format_value(option_tree,\r\nhf_ipxwan_delta_time, tvb,\r\noffset, 4, delta_time,\r\n"%uus",\r\ndelta_time);\r\n}\r\nbreak;\r\ncase OPT_EXTENDED_NODE_ID:\r\nif (option_data_len != 4) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be 4", option_data_len);\r\n} else {\r\nproto_tree_add_item(option_tree,\r\nhf_ipxwan_extended_node_id, tvb,\r\noffset, 4, ENC_NA);\r\n}\r\nbreak;\r\ncase OPT_NODE_NUMBER:\r\nif (option_data_len != 6) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be 6", option_data_len);\r\n} else {\r\nproto_tree_add_item(option_tree,\r\nhf_ipxwan_node_number, tvb,\r\noffset, 6, ENC_NA);\r\n}\r\nbreak;\r\ncase OPT_COMPRESSION:\r\nif (option_data_len < 1) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be >= 1", option_data_len);\r\n} else {\r\ncompression_type = tvb_get_guint8(tvb,\r\noffset);\r\nti = proto_tree_add_uint(option_tree,\r\nhf_ipxwan_compression_type, tvb,\r\noffset, 1, compression_type);\r\nswitch (compression_type) {\r\ncase COMP_TYPE_TELEBIT:\r\nif (option_data_len < 3) {\r\nexpert_add_info_format(pinfo, ti, &ei_ipxwan_option_data_len,\r\n"Bogus length: %u, should be >= 3", option_data_len);\r\n} else {\r\nproto_tree_add_item(option_tree, hf_ipxwan_compression_options,\r\ntvb, offset+1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(option_tree, hf_ipxwan_compression_slots,\r\ntvb, offset+2, 1, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(option_tree, hf_ipxwan_compression_parameters,\r\ntvb, offset+1, option_data_len-1, ENC_NA);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase OPT_PAD:\r\nproto_tree_add_item(option_tree, hf_ipxwan_padding,\r\ntvb, offset, option_data_len, ENC_NA);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(option_tree, hf_ipxwan_option_value,\r\ntvb, offset, option_data_len, ENC_NA);\r\nbreak;\r\n}\r\noffset += option_data_len;\r\nnum_options--;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ipxwan(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ipxwan_identifier,\r\n{ "Identifier", "ipxwan.identifier",\r\nFT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_packet_type,\r\n{ "Packet Type", "ipxwan.packet_type",\r\nFT_UINT8, BASE_DEC, VALS(ipxwan_packet_type_vals), 0x0, NULL,\r\nHFILL }},\r\n{ &hf_ipxwan_node_id,\r\n{ "Node ID", "ipxwan.node_id", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_sequence_number,\r\n{ "Sequence Number", "ipxwan.sequence_number", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_num_options,\r\n{ "Number of Options", "ipxwan.num_options", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_option_num,\r\n{ "Option Number", "ipxwan.option_num", FT_UINT8,\r\nBASE_HEX, VALS(ipxwan_option_num_vals), 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_accept_option,\r\n{ "Accept Option", "ipxwan.accept_option", FT_UINT8,\r\nBASE_DEC, VALS(ipxwan_accept_option_vals), 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_option_data_len,\r\n{ "Option Data Length", "ipxwan.option_data_len", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_routing_type,\r\n{ "Routing Type", "ipxwan.routing_type", FT_UINT8,\r\nBASE_DEC, VALS(ipxwan_routing_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_wan_link_delay,\r\n{ "WAN Link Delay", "ipxwan.rip_sap_info_exchange.wan_link_delay",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_common_network_number,\r\n{ "Common Network Number", "ipxwan.rip_sap_info_exchange.common_network_number",\r\nFT_IPXNET, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_router_name,\r\n{ "Router Name", "ipxwan.rip_sap_info_exchange.router_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_delay,\r\n{ "Delay", "ipxwan.nlsp_information.delay",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_throughput,\r\n{ "Throughput", "ipxwan.nlsp_information.throughput",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_request_size,\r\n{ "Request Size", "ipxwan.nlsp_raw_throughput_data.request_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_delta_time,\r\n{ "Delta Time", "ipxwan.nlsp_raw_throughput_data.delta_time",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_extended_node_id,\r\n{ "Extended Node ID", "ipxwan.extended_node_id",\r\nFT_IPXNET, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_node_number,\r\n{ "Node Number", "ipxwan.node_number",\r\nFT_ETHER, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_compression_type,\r\n{ "Compression Type", "ipxwan.compression.type",\r\nFT_UINT8, BASE_DEC, VALS(ipxwan_compression_type_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ipxwan_compression_options,\r\n{ "Compression options", "ipxwan.compression.options",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ipxwan_compression_slots,\r\n{ "Number of compression slots", "ipxwan.compression.slots",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ipxwan_compression_parameters,\r\n{ "Option parameters", "ipxwan.compression.parameters",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_padding,\r\n{ "Padding", "ipxwan.padding",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_ipxwan_option_value,\r\n{ "Option value", "ipxwan.option_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ipxwan,\r\n&ett_ipxwan_option,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ipxwan_option_data_len, { "ipxwan.option_data_len.invalid", PI_MALFORMED, PI_ERROR, "Wrong length", EXPFILL }},\r\n};\r\nexpert_module_t* expert_ipxwan;\r\nproto_ipxwan = proto_register_protocol("IPX WAN", "IPX WAN", "ipxwan");\r\nproto_register_field_array(proto_ipxwan, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_ipxwan = expert_register_protocol(proto_ipxwan);\r\nexpert_register_field_array(expert_ipxwan, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_ipxwan(void)\r\n{\r\ndissector_handle_t ipxwan_handle;\r\nipxwan_handle = create_dissector_handle(dissect_ipxwan,\r\nproto_ipxwan);\r\ndissector_add_uint("ipx.socket", IPX_SOCKET_IPXWAN, ipxwan_handle);\r\n}

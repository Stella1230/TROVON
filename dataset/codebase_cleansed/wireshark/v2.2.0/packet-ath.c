static int\r\ndissect_ath(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nguint8 hlen = 0;\r\ngint32 clen = 0;\r\ngint32 dlen = 0;\r\ngint32 plen = 0;\r\ngint tribes_version_mark;\r\nconst gchar *info_srcaddr = "";\r\nconst gchar *info_domain = "";\r\nconst gchar *info_command = "";\r\nproto_item *ti, *hlen_item;\r\nproto_tree *ath_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ATH");\r\ncol_clear(pinfo->cinfo,COL_INFO);\r\nti = proto_tree_add_item(tree, proto_ath, tvb, 0, -1, ENC_NA);\r\nath_tree = proto_item_add_subtree(ti, ett_ath);\r\ntribes_version_mark = tvb_get_ntohs(tvb, tvb_reported_length(tvb) - 2);\r\nif (tribes_version_mark == 11589) {\r\nproto_tree_add_item(ath_tree, hf_ath_begin, tvb, offset, 8, ENC_ASCII|ENC_NA);\r\noffset += 8;\r\nproto_tree_add_item(ath_tree, hf_ath_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_alive, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(ath_tree, hf_ath_port, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_sport, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nhlen_item = proto_tree_add_item(ath_tree, hf_ath_hlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nhlen = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nif (hlen == 4) {\r\nproto_tree_add_item(ath_tree, hf_ath_ipv4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ninfo_srcaddr = tvb_ip_to_str(tvb, offset);\r\n} else if (hlen == 6) {\r\nproto_tree_add_item(ath_tree, hf_ath_ipv6, tvb, offset, 6, ENC_NA);\r\ninfo_srcaddr = tvb_ip6_to_str(tvb, offset);\r\n} else {\r\nexpert_add_info(pinfo, hlen_item, &ei_ath_hlen_invalid);\r\n}\r\noffset += hlen;\r\nproto_tree_add_item_ret_int(ath_tree, hf_ath_clen, tvb, offset, 4, ENC_BIG_ENDIAN, &clen);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_comm, tvb, offset, clen, ENC_ASCII|ENC_NA);\r\nif (clen != -1)\r\ninfo_command = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, clen, ENC_ASCII);\r\noffset += clen;\r\nproto_tree_add_item_ret_int(ath_tree, hf_ath_dlen, tvb, offset, 4, ENC_BIG_ENDIAN, &dlen);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_domain, tvb, offset, dlen, ENC_ASCII|ENC_NA);\r\nif (dlen != 0)\r\ninfo_domain = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, dlen, ENC_ASCII);\r\noffset += dlen;\r\nproto_tree_add_item(ath_tree, hf_ath_unique, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item_ret_int(ath_tree, hf_ath_plen, tvb, offset, 4, ENC_BIG_ENDIAN, &plen);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_payload, tvb, offset, plen, ENC_ASCII|ENC_NA);\r\noffset += plen;\r\nproto_tree_add_item(ath_tree, hf_ath_end, tvb, offset, 8, ENC_ASCII|ENC_NA);\r\n}\r\nelse if (tribes_version_mark == 256) {\r\nproto_tree_add_item(ath_tree, hf_ath_begin, tvb, offset, 8, ENC_ASCII|ENC_NA);\r\noffset += 8;\r\nproto_tree_add_item(ath_tree, hf_ath_padding, tvb, offset, 2, ENC_ASCII|ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(ath_tree, hf_ath_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_alive, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(ath_tree, hf_ath_port, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_sport, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_uport, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nhlen_item = proto_tree_add_item(ath_tree, hf_ath_hlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nhlen = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nif (hlen == 4) {\r\nproto_tree_add_item(ath_tree, hf_ath_ipv4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ninfo_srcaddr = tvb_ip_to_str(tvb, offset);\r\n} else if (hlen == 6) {\r\nproto_tree_add_item(ath_tree, hf_ath_ipv6, tvb, offset, 6, ENC_NA);\r\ninfo_srcaddr = tvb_ip6_to_str(tvb, offset);\r\n} else {\r\nexpert_add_info(pinfo, hlen_item, &ei_ath_hlen_invalid);\r\n}\r\noffset += hlen;\r\nproto_tree_add_item_ret_int(ath_tree, hf_ath_clen, tvb, offset, 4, ENC_BIG_ENDIAN, &clen);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_comm, tvb, offset, clen, ENC_ASCII|ENC_NA);\r\nif (clen != -1)\r\ninfo_command = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, clen, ENC_ASCII);\r\noffset += clen;\r\nproto_tree_add_item_ret_int(ath_tree, hf_ath_dlen, tvb, offset, 4, ENC_BIG_ENDIAN, &dlen);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_domain, tvb, offset, dlen, ENC_ASCII|ENC_NA);\r\nif (dlen != 0)\r\ninfo_domain = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, dlen, ENC_ASCII);\r\noffset += dlen;\r\nproto_tree_add_item(ath_tree, hf_ath_unique, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item_ret_int(ath_tree, hf_ath_plen, tvb, offset, 4, ENC_BIG_ENDIAN, &plen);\r\noffset += 4;\r\nproto_tree_add_item(ath_tree, hf_ath_payload, tvb, offset, plen, ENC_ASCII|ENC_NA);\r\noffset += plen;\r\nproto_tree_add_item(ath_tree, hf_ath_end, tvb, offset, 8, ENC_ASCII|ENC_NA);\r\n} else {\r\nproto_tree_add_expert(tree, pinfo, &ei_ath_hmark_invalid, tvb, offset, -1);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nif (strcmp(info_command, "") != 0) {\r\nif (strcmp(info_command, "BABY-ALEX") == 0) {\r\nif (strcmp(info_domain, "") != 0) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s is leaving domain %s", info_srcaddr, info_domain);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s is leaving default domain", info_srcaddr);\r\n}\r\n} else {\r\nif (strcmp(info_domain, "") != 0) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Heartbeat from %s to domain %s", info_srcaddr, info_domain);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Heartbeat from %s to default domain", info_srcaddr);\r\n}\r\n}\r\n} else {\r\nif (strcmp(info_domain, "") != 0) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Heartbeat from %s to domain %s", info_srcaddr, info_domain);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Heartbeat from %s to default domain", info_srcaddr);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ath(void)\r\n{\r\nexpert_module_t* expert_ath;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ath_begin,\r\n{ "Begin", "ath.begin", FT_STRING, BASE_NONE, NULL, 0x0, "Begin mark",\r\nHFILL }\r\n},\r\n{ &hf_ath_padding,\r\n{ "Padding", "ath.padding", FT_UINT16, BASE_HEX, NULL, 0x0, NULL,\r\nHFILL }\r\n},\r\n{ &hf_ath_length,\r\n{ "Length", "ath.length", FT_UINT32, BASE_DEC, NULL, 0x0, "Data Length",\r\nHFILL }\r\n},\r\n{ &hf_ath_alive,\r\n{ "Alive Time", "ath.alive", FT_UINT64, BASE_DEC, NULL, 0x0, "Alive Time counter",\r\nHFILL }\r\n},\r\n{ &hf_ath_port,\r\n{ "Port", "ath.port", FT_UINT32, BASE_DEC, NULL, 0x0, "RMI Port",\r\nHFILL }\r\n},\r\n{ &hf_ath_sport,\r\n{ "Secure Port", "ath.sport", FT_INT32, BASE_DEC, NULL, 0x0, "RMI Secure Port",\r\nHFILL }\r\n},\r\n{ &hf_ath_uport,\r\n{ "UDP Port", "ath.uport", FT_INT32, BASE_DEC, NULL, 0x0, "RMI UDP Port",\r\nHFILL }\r\n},\r\n{ &hf_ath_hlen,\r\n{ "Host Length", "ath.hlen", FT_INT8, BASE_DEC, NULL, 0x0, "Host IP Length",\r\nHFILL }\r\n},\r\n{ &hf_ath_ipv4,\r\n{ "Host", "ath.ipv4", FT_IPv4, BASE_NONE, NULL, 0x0, "IPv4 Host",\r\nHFILL }\r\n},\r\n{ &hf_ath_ipv6,\r\n{ "Host", "ath.ipv6", FT_IPv6, BASE_NONE, NULL, 0x0, "IPv6 Host",\r\nHFILL }\r\n},\r\n{ &hf_ath_clen,\r\n{ "Command Length", "ath.clen", FT_INT32, BASE_DEC, NULL, 0x0, "Command Length for members",\r\nHFILL }\r\n},\r\n{ &hf_ath_comm,\r\n{ "Command", "ath.comm", FT_STRING, BASE_NONE, NULL, 0x0, "Command for members",\r\nHFILL }\r\n},\r\n{ &hf_ath_dlen,\r\n{ "Domain Length", "ath.dlen", FT_INT32, BASE_DEC, NULL, 0x0, "Cluster Domain Length",\r\nHFILL }\r\n},\r\n{ &hf_ath_domain,\r\n{ "Domain", "ath.domain", FT_STRING, BASE_NONE, NULL, 0x0, "Cluster Domain",\r\nHFILL }\r\n},\r\n{ &hf_ath_unique,\r\n{ "uniqueId", "ath.unique", FT_BYTES, BASE_NONE, NULL, 0x0, "UniqueID identifier",\r\nHFILL }\r\n},\r\n{ &hf_ath_plen,\r\n{ "Payload Length", "ath.plen", FT_INT32, BASE_DEC, NULL, 0x0, "Packet Payload Length",\r\nHFILL }\r\n},\r\n{ &hf_ath_payload,\r\n{ "Payload", "ath.payload", FT_STRING, BASE_NONE, NULL, 0x0, "Packet Payload",\r\nHFILL }\r\n},\r\n{ &hf_ath_end,\r\n{ "End", "ath.end", FT_STRING, BASE_NONE, NULL, 0x0, "End mark",\r\nHFILL }\r\n},\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ath_hlen_invalid, { "ath.hlen.invalid", PI_MALFORMED, PI_ERROR, "Decode aborted: invalid IP length", EXPFILL }},\r\n{ &ei_ath_hmark_invalid, { "ath.hmark.invalid", PI_MALFORMED, PI_ERROR, "Decode aborted: not an ATH packet", EXPFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ath,\r\n};\r\nproto_ath = proto_register_protocol("Apache Tribes Heartbeat Protocol", "ATH", "ath");\r\nproto_register_field_array(proto_ath, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_ath = expert_register_protocol(proto_ath);\r\nexpert_register_field_array(expert_ath, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_ath(void)\r\n{\r\nstatic dissector_handle_t ath_handle;\r\nath_handle = create_dissector_handle(dissect_ath, proto_ath);\r\ndissector_add_uint("udp.port", ATH_PORT, ath_handle);\r\n}

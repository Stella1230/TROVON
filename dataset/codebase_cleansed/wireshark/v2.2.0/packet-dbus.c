static gboolean\r\ndbus_validate_object_path(const char *path)\r\n{\r\nif (*path != '/')\r\nreturn FALSE;\r\ndo {\r\npath++;\r\nif (*path == '/')\r\nreturn FALSE;\r\nwhile ((*path >= 'A' && *path <= 'Z') || (*path >= 'a' && *path <= 'z') || (*path >= '0' && *path <= '9') || *path == '_')\r\npath++;\r\nif (*path == '\0')\r\nreturn TRUE;\r\n} while (*path == '/');\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ndbus_validate_signature(const char *sig _U_)\r\n{\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndbus_type_alignment(char sig)\r\n{\r\nswitch (sig) {\r\ncase 'y':\r\ncase 'g':\r\nreturn 1;\r\ncase 'n':\r\ncase 'q':\r\nreturn 2;\r\ncase 'i':\r\ncase 'u':\r\ncase 'b':\r\ncase 'o':\r\ncase 'a':\r\ncase 's':\r\nreturn 4;\r\ncase 'x':\r\ncase 't':\r\ncase 'd':\r\nreturn 8;\r\ndefault:\r\nreturn 1;\r\n}\r\n}\r\nstatic int\r\ndissect_dbus_sig(tvbuff_t *tvb, dbus_info_t *dinfo, proto_tree *tree, int offset, char sig, dbus_val_t *ret)\r\n{\r\nproto_item *ti;\r\nconst int align = dbus_type_alignment(sig);\r\nconst int org_offset = (offset + align - 1) / align * align;\r\noffset = org_offset;\r\nswitch (sig) {\r\ncase 'y':\r\n{\r\nguint8 val;\r\nval = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_uint_format(tree, hfi_dbus_value_uint.id, tvb, org_offset, offset - org_offset, val, "BYTE: %u", val);\r\nret->uint = val;\r\nreturn offset;\r\n}\r\ncase 'b':\r\n{\r\nguint32 val;\r\nval = dinfo->get32(tvb, offset);\r\noffset += 4;\r\nti = proto_tree_add_boolean_format(tree, hfi_dbus_value_bool.id, tvb, org_offset, offset - org_offset, val, "BOOLEAN: %s", val ? "True" : "False");\r\nif (val != 0 && val != 1) {\r\nexpert_add_info_format(dinfo->pinfo, ti, &ei_dbus_value_bool_invalid, "Invalid boolean value (must be 0 or 1 is: %u)", val);\r\nreturn -1;\r\n}\r\nret->uint = val;\r\nreturn offset;\r\n}\r\ncase 'n':\r\n{\r\ngint16 val;\r\nval = (gint16 )dinfo->get16(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_uint_format(tree, hfi_dbus_value_int.id, tvb, org_offset, offset - org_offset, val, "INT16: %d", val);\r\nreturn offset;\r\n}\r\ncase 'q':\r\n{\r\nguint16 val;\r\nval = dinfo->get16(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_uint_format(tree, hfi_dbus_value_uint.id, tvb, org_offset, offset - org_offset, val, "UINT16: %u", val);\r\nret->uint = val;\r\nreturn offset;\r\n}\r\ncase 'i':\r\n{\r\ngint32 val;\r\nval = (gint32) dinfo->get32(tvb, offset);\r\noffset += 4;\r\nproto_tree_add_int_format(tree, hfi_dbus_value_int.id, tvb, org_offset, offset - org_offset, val, "INT32: %d", val);\r\nreturn offset;\r\n}\r\ncase 'u':\r\n{\r\nguint32 val;\r\nval = dinfo->get32(tvb, offset);\r\noffset += 4;\r\nproto_tree_add_uint_format(tree, hfi_dbus_value_uint.id, tvb, org_offset, offset - org_offset, val, "UINT32: %u", val);\r\nret->uint = val;\r\nreturn offset;\r\n}\r\ncase 'x':\r\ncase 't':\r\nreturn -1;\r\ncase 'd':\r\n{\r\ngdouble val;\r\nval = dinfo->getdouble(tvb, offset);\r\noffset += 8;\r\nproto_tree_add_double_format(tree, hfi_dbus_value_double.id, tvb, org_offset, offset - org_offset, val, "DOUBLE: %." G_STRINGIFY(DBL_DIG) "g", val);\r\nreturn offset;\r\n}\r\ncase 's':\r\ncase 'o':\r\n{\r\nguint32 len;\r\nchar *val;\r\nlen = dinfo->get32(tvb, offset);\r\noffset += 4;\r\nval = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, len, ENC_ASCII);\r\noffset += (len + 1 );\r\nif (sig == 's') {\r\nti = proto_tree_add_string_format(tree, hfi_dbus_value_str.id, tvb, org_offset, offset - org_offset, val, "STRING: %s", val);\r\nif (!g_utf8_validate(val, -1, NULL)) {\r\nexpert_add_info(dinfo->pinfo, ti, &ei_dbus_value_str_invalid);\r\nreturn -1;\r\n}\r\n} else {\r\nti = proto_tree_add_string_format(tree, hfi_dbus_value_str.id, tvb, org_offset, offset - org_offset, val, "OBJECT_PATH: %s", val);\r\nif (!dbus_validate_object_path(val)) {\r\nexpert_add_info(dinfo->pinfo, ti, &ei_dbus_invalid_object_path);\r\nreturn -1;\r\n}\r\n}\r\nret->str = val;\r\nreturn offset;\r\n}\r\ncase 'g':\r\n{\r\nguint8 len;\r\nchar *val;\r\nlen = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nval = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, len, ENC_ASCII);\r\noffset += (len + 1);\r\nti = proto_tree_add_string_format(tree, hfi_dbus_value_str.id, tvb, org_offset, offset - org_offset, val, "SIGNATURE: %s", val);\r\nif (!dbus_validate_signature(val)) {\r\nexpert_add_info(dinfo->pinfo, ti, &ei_dbus_invalid_signature);\r\nreturn -1;\r\n}\r\nret->str = val;\r\nreturn offset;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int\r\ndissect_dbus_field_signature(tvbuff_t *tvb, packet_info *pinfo, dbus_info_t *dinfo, proto_tree *tree, int offset, int field_code)\r\n{\r\nconst int org_offset = offset;\r\nproto_item *ti;\r\nguint sig_len;\r\nchar *sig;\r\nsig_len = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nsig = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, sig_len, ENC_ASCII);\r\noffset += (sig_len + 1);\r\nti = proto_tree_add_string(tree, &hfi_dbus_type_signature, tvb, org_offset, offset - org_offset, sig);\r\nif (!dbus_validate_signature(sig)) {\r\nexpert_add_info(dinfo->pinfo, ti, &ei_dbus_invalid_signature);\r\nreturn -1;\r\n}\r\nswitch (field_code) {\r\ncase DBUS_HEADER_FIELD_REPLY_SERIAL:\r\nif (!strcmp(sig, "u")) {\r\ndbus_val_t serial_val;\r\noffset = dissect_dbus_sig(tvb, dinfo, tree, offset, 'u', &serial_val);\r\nif (offset != -1)\r\n{ }\r\nreturn offset;\r\n}\r\nbreak;\r\ncase DBUS_HEADER_FIELD_DESTINATION:\r\ncase DBUS_HEADER_FIELD_SENDER:\r\nif (!strcmp(sig, "s")) {\r\ndbus_val_t addr_val;\r\noffset = dissect_dbus_sig(tvb, dinfo, tree, offset, 's', &addr_val);\r\nif (offset != -1)\r\nset_address((field_code == DBUS_HEADER_FIELD_DESTINATION) ? &dinfo->pinfo->dst : &dinfo->pinfo->src,\r\nAT_STRINGZ, (int)strlen(addr_val.str)+1, wmem_strdup(pinfo->pool, addr_val.str));\r\nreturn offset;\r\n}\r\nbreak;\r\ncase DBUS_HEADER_FIELD_SIGNATURE:\r\nif (!strcmp(sig, "g")) {\r\ndbus_val_t sig_val;\r\noffset = dissect_dbus_sig(tvb, dinfo, tree, offset, 'g', &sig_val);\r\nif (offset != -1)\r\ndinfo->body_sig = sig_val.str;\r\nreturn offset;\r\n}\r\nbreak;\r\n}\r\nwhile (*sig) {\r\ndbus_val_t val;\r\noffset = dissect_dbus_sig(tvb, dinfo, tree, offset, *sig, &val);\r\nif (offset == -1)\r\nreturn -1;\r\nsig++;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dbus_hdr_fields(tvbuff_t *tvb, packet_info *pinfo, dbus_info_t *dinfo, proto_tree *tree, int offset)\r\n{\r\nint end_offset;\r\nend_offset = offset + dinfo->fields_len;\r\nwhile (offset < end_offset) {\r\nproto_tree *field_tree;\r\nproto_item *ti;\r\nguint8 field_code;\r\nti = proto_tree_add_item(tree, &hfi_dbus_hdr_field, tvb, offset, 0, ENC_NA);\r\nfield_tree = proto_item_add_subtree(ti, ett_dbus_field);\r\nfield_code = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(field_tree, &hfi_dbus_hdr_field_code, tvb, offset, 1, dinfo->enc);\r\nproto_item_append_text(ti, ": %s", val_to_str(field_code, field_code_vals, "Unknown: %d"));\r\noffset += 1;\r\noffset = dissect_dbus_field_signature(tvb, pinfo, dinfo, field_tree, offset, field_code);\r\nif (offset == -1)\r\nbreak;\r\noffset = (offset + 7) & ~7;\r\nproto_item_set_end(ti, tvb, offset);\r\n}\r\nif (offset >= end_offset) {\r\n}\r\nreturn end_offset;\r\n}\r\nstatic int\r\ndissect_dbus_hdr(tvbuff_t *tvb, dbus_info_t *dinfo, proto_tree *tree, int offset)\r\n{\r\nproto_tree *hdr_tree;\r\nproto_item *ti;\r\nguint8 type;\r\nti = proto_tree_add_item(tree, &hfi_dbus_hdr, tvb, offset, 0, ENC_NA);\r\nhdr_tree = proto_item_add_subtree(ti, ett_dbus_hdr);\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_endianness, tvb, offset, 1, ENC_ASCII | ENC_NA);\r\noffset += 1;\r\ntype = tvb_get_guint8(tvb, offset);\r\ncol_set_str(dinfo->pinfo->cinfo, COL_INFO, val_to_str_const(type, message_type_vals, ""));\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_type, tvb, offset, 1, dinfo->enc);\r\noffset += 1;\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_flags, tvb, offset, 1, dinfo->enc);\r\noffset += 1;\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_version, tvb, offset, 1, dinfo->enc);\r\noffset += 1;\r\ndinfo->body_len = dinfo->get32(tvb, offset);\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_body_length, tvb, offset, 4, dinfo->enc);\r\noffset += 4;\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_serial, tvb, offset, 4, dinfo->enc);\r\noffset += 4;\r\ndinfo->fields_len = dinfo->get32(tvb, offset);\r\nproto_tree_add_item(hdr_tree, &hfi_dbus_hdr_fields_length, tvb, offset, 4, dinfo->enc);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dbus_body(tvbuff_t *tvb, dbus_info_t *dinfo, proto_tree *tree, int offset)\r\n{\r\nproto_tree *body_tree;\r\nproto_item *ti;\r\nif (dinfo->body_len && dinfo->body_sig[0]) {\r\nconst char *sig = dinfo->body_sig;\r\nti = proto_tree_add_item(tree, &hfi_dbus_body, tvb, offset, 0, ENC_NA);\r\nbody_tree = proto_item_add_subtree(ti, ett_dbus_body);\r\nwhile (*sig) {\r\ndbus_val_t val;\r\noffset = dissect_dbus_sig(tvb, dinfo, body_tree, offset, *sig, &val);\r\nif (offset == -1)\r\nreturn -1;\r\nsig++;\r\n}\r\nproto_item_set_end(ti, tvb, offset);\r\n} else if (dinfo->body_len || dinfo->body_sig[0]) {\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dbus(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *dbus_tree = NULL;\r\ndbus_info_t dinfo;\r\nint offset;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "D-BUS");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nmemset(&dinfo, 0, sizeof(dinfo));\r\ndinfo.pinfo = pinfo;\r\nswitch (tvb_get_guint8(tvb, 0)) {\r\ncase 'l':\r\ndinfo.enc = ENC_LITTLE_ENDIAN;\r\ndinfo.get16 = tvb_get_letohs;\r\ndinfo.get32 = tvb_get_letohl;\r\ndinfo.getdouble = tvb_get_letohieee_double;\r\nbreak;\r\ncase 'B':\r\ndinfo.enc = ENC_BIG_ENDIAN;\r\ndinfo.get16 = tvb_get_ntohs;\r\ndinfo.get32 = tvb_get_ntohl;\r\ndinfo.getdouble = tvb_get_ntohieee_double;\r\nbreak;\r\ndefault:\r\ndinfo.enc = ENC_NA;\r\ndinfo.get16 = tvb_get_ntohs;\r\ndinfo.get32 = tvb_get_ntohl;\r\ndinfo.getdouble = tvb_get_ntohieee_double;\r\n}\r\nif (tree) {\r\nproto_item *ti = proto_tree_add_item(tree, hfi_dbus, tvb, 0, -1, ENC_NA);\r\ndbus_tree = proto_item_add_subtree(ti, ett_dbus);\r\n}\r\noffset = 0;\r\noffset = dissect_dbus_hdr(tvb, &dinfo, dbus_tree, offset);\r\noffset = dissect_dbus_hdr_fields(tvb, pinfo, &dinfo, dbus_tree, offset);\r\noffset = (offset + 7) & ~7;\r\nif (!dinfo.body_sig)\r\ndinfo.body_sig = "";\r\noffset = dissect_dbus_body(tvb, &dinfo, dbus_tree, offset);\r\nreturn offset;\r\n}\r\nstatic guint\r\nget_dbus_message_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint32 (*get_guint32)(tvbuff_t *, const gint);\r\nguint32 len_body, len_hdr;\r\nswitch (tvb_get_guint8(tvb, offset)) {\r\ncase 'l':\r\nget_guint32 = tvb_get_letohl;\r\nbreak;\r\ncase 'B':\r\ndefault:\r\nget_guint32 = tvb_get_ntohl;\r\nbreak;\r\n}\r\nlen_hdr = DBUS_HEADER_LEN + get_guint32(tvb, offset + 12);\r\nlen_hdr = (len_hdr + 7) & ~7;\r\nlen_body = get_guint32(tvb, offset + 4);\r\nreturn len_hdr + len_body;\r\n}\r\nstatic int\r\ndissect_dbus_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nreturn dissect_dbus(tvb, pinfo, tree, data);\r\n}\r\nstatic int\r\ndissect_dbus_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, dbus_desegment, DBUS_HEADER_LEN, get_dbus_message_len, dissect_dbus_pdu, data);\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_dbus(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_dbus_hdr,\r\n&hfi_dbus_hdr_endianness,\r\n&hfi_dbus_hdr_type,\r\n&hfi_dbus_hdr_flags,\r\n&hfi_dbus_hdr_version,\r\n&hfi_dbus_hdr_body_length,\r\n&hfi_dbus_hdr_serial,\r\n&hfi_dbus_hdr_fields_length,\r\n&hfi_dbus_hdr_field,\r\n&hfi_dbus_hdr_field_code,\r\n&hfi_dbus_type_signature,\r\n&hfi_dbus_body,\r\n&hfi_dbus_value_bool,\r\n&hfi_dbus_value_int,\r\n&hfi_dbus_value_uint,\r\n&hfi_dbus_value_str,\r\n&hfi_dbus_value_double,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_dbus,\r\n&ett_dbus_hdr,\r\n&ett_dbus_body,\r\n&ett_dbus_field\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_dbus_value_bool_invalid, { "dbus.value.bool.invalid", PI_PROTOCOL, PI_WARN, "Invalid boolean value", EXPFILL }},\r\n{ &ei_dbus_value_str_invalid, { "dbus.value.str.invalid", PI_PROTOCOL, PI_WARN, "Invalid string (not UTF-8)", EXPFILL }},\r\n{ &ei_dbus_invalid_object_path, { "dbus.invalid_object_path", PI_PROTOCOL, PI_WARN, "Invalid object_path", EXPFILL }},\r\n{ &ei_dbus_invalid_signature, { "dbus.invalid_signature", PI_PROTOCOL, PI_WARN, "Invalid signature", EXPFILL }},\r\n};\r\nexpert_module_t *expert_dbus;\r\nint proto_dbus;\r\nproto_dbus = proto_register_protocol("D-Bus", "D-BUS", "dbus");\r\nhfi_dbus = proto_registrar_get_nth(proto_dbus);\r\nproto_register_fields(proto_dbus, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_dbus = expert_register_protocol(proto_dbus);\r\nexpert_register_field_array(expert_dbus, ei, array_length(ei));\r\ndbus_handle = create_dissector_handle(dissect_dbus, proto_dbus);\r\ndbus_handle_tcp = create_dissector_handle(dissect_dbus_tcp, proto_dbus);\r\n}\r\nvoid\r\nproto_reg_handoff_dbus(void)\r\n{\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_DBUS, dbus_handle);\r\ndissector_add_for_decode_as("tcp.port", dbus_handle_tcp);\r\n}

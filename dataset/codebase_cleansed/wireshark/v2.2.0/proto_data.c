static gint\r\np_compare(gconstpointer a, gconstpointer b)\r\n{\r\nconst proto_data_t *ap = (const proto_data_t *)a;\r\nconst proto_data_t *bp = (const proto_data_t *)b;\r\nif (ap -> proto > bp -> proto) {\r\nreturn 1;\r\n} else if (ap -> proto == bp -> proto) {\r\nif (ap->key > bp->key){\r\nreturn 1;\r\n} else if (ap -> key == bp -> key) {\r\nreturn 0;\r\n}\r\nreturn -1;\r\n} else {\r\nreturn -1;\r\n}\r\n}\r\nvoid\r\np_add_proto_data(wmem_allocator_t *tmp_scope, struct _packet_info* pinfo, int proto, guint32 key, void *proto_data)\r\n{\r\nproto_data_t *p1;\r\nGSList **proto_list;\r\nwmem_allocator_t *scope;\r\nif (tmp_scope == pinfo->pool) {\r\nscope = tmp_scope;\r\nproto_list = &pinfo->proto_data;\r\n} else {\r\nscope = wmem_file_scope();\r\nproto_list = &pinfo->fd->pfd;\r\n}\r\np1 = (proto_data_t *)wmem_alloc(scope, sizeof(proto_data_t));\r\np1->proto = proto;\r\np1->key = key;\r\np1->proto_data = proto_data;\r\n*proto_list = g_slist_prepend(*proto_list, p1);\r\n}\r\nvoid *\r\np_get_proto_data(wmem_allocator_t *scope, struct _packet_info* pinfo, int proto, guint32 key)\r\n{\r\nproto_data_t temp, *p1;\r\nGSList *item;\r\ntemp.proto = proto;\r\ntemp.key = key;\r\ntemp.proto_data = NULL;\r\nif (scope == pinfo->pool) {\r\nitem = g_slist_find_custom(pinfo->proto_data, &temp, p_compare);\r\n} else {\r\nitem = g_slist_find_custom(pinfo->fd->pfd, &temp, p_compare);\r\n}\r\nif (item) {\r\np1 = (proto_data_t *)item->data;\r\nreturn p1->proto_data;\r\n}\r\nreturn NULL;\r\n}\r\nvoid\r\np_remove_proto_data(wmem_allocator_t *scope, struct _packet_info* pinfo, int proto, guint32 key)\r\n{\r\nproto_data_t temp;\r\nGSList *item;\r\nGSList **proto_list;\r\ntemp.proto = proto;\r\ntemp.key = key;\r\ntemp.proto_data = NULL;\r\nif (scope == pinfo->pool) {\r\nitem = g_slist_find_custom(pinfo->fd->pfd, &temp, p_compare);\r\nproto_list = &pinfo->proto_data;\r\n} else {\r\nitem = g_slist_find_custom(pinfo->fd->pfd, &temp, p_compare);\r\nproto_list = &pinfo->fd->pfd;\r\n}\r\nif (item) {\r\n*proto_list = g_slist_remove(*proto_list, item->data);\r\n}\r\n}\r\ngchar *\r\np_get_proto_name_and_key(wmem_allocator_t *scope, struct _packet_info* pinfo, guint pfd_index){\r\nproto_data_t *temp;\r\nif (scope == pinfo->pool) {\r\ntemp = (proto_data_t *)g_slist_nth_data(pinfo->proto_data, pfd_index);\r\n} else {\r\ntemp = (proto_data_t *)g_slist_nth_data(pinfo->fd->pfd, pfd_index);\r\n}\r\nreturn wmem_strdup_printf(wmem_packet_scope(),"[%s, key %u]",proto_get_protocol_name(temp->proto), temp->key);\r\n}

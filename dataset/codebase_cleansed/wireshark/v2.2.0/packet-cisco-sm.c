static int\r\ndissect_sm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *sm_tree;\r\ntvbuff_t *next_tvb = NULL;\r\nguint32 sm_message_type;\r\nguint32 bh_event_code = 0;\r\nguint16 protocol;\r\nguint16 msg_type = 0;\r\nguint16 length;\r\nguint16 tag;\r\nint offset = 0;\r\nsm_message_type = tvb_get_ntohl(tvb,offset);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SM");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Cisco SM Packet (%s)",\r\nval_to_str_const(sm_message_type, sm_message_type_value_info,"reserved"));\r\nti = proto_tree_add_item(tree, proto_sm, tvb, offset, 0, ENC_NA);\r\nsm_tree = proto_item_add_subtree(ti, ett_sm);\r\nproto_tree_add_uint_format_value(sm_tree, hf_sm_sm_msg_type, tvb, offset, 4, sm_message_type,\r\n"%s (0x%0x)", val_to_str_const(sm_message_type, sm_message_type_value, "reserved"), sm_message_type);\r\noffset = offset + 4;\r\nif (sm_message_type == MESSAGE_TYPE_PDU) {\r\nproto_tree_add_item(sm_tree, hf_sm_protocol, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nprotocol = tvb_get_ntohs(tvb,offset);\r\noffset = offset + 2;\r\nswitch(protocol){\r\ncase SM_PROTOCOL_X004:\r\nproto_tree_add_item(sm_tree, hf_sm_msg_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset +2;\r\nmsg_type = tvb_get_ntohs(tvb,offset);\r\nproto_tree_add_uint_format_value(sm_tree, hf_sm_msg_type, tvb, offset, 2, msg_type,\r\n"%s (0x%0x)", val_to_str_const(msg_type, sm_pdu_type_value, "reserved"),\r\nmsg_type);\r\nmsg_type = tvb_get_ntohs(tvb,offset);\r\noffset = offset + 2;\r\nproto_tree_add_item(sm_tree, hf_sm_channel, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(sm_tree, hf_sm_bearer, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset +2;\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset +2;\r\nproto_item_set_len(ti, 16);\r\nif (length > 0) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\nif ((msg_type == PDU_MTP3_TO_SLT || msg_type == PDU_MTP3_FROM_SLT)) {\r\ncall_dissector(q931_handle, next_tvb, pinfo, tree);\r\n} else {\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nbreak;\r\ncase SM_PROTOCOL_X100:\r\ncase SM_PROTOCOL_X122:\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset + 2;\r\nproto_item_set_len(ti, 8);\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\ncall_data_dissector(next_tvb, pinfo, sm_tree);\r\nbreak;\r\ncase SM_PROTOCOL_X101:\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset + 2;\r\nproto_item_set_len(ti, length + offset);\r\nproto_tree_add_item(sm_tree, hf_sm_ip_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset = offset + 4;\r\nproto_tree_add_item(sm_tree, hf_sm_context, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset = offset +4;\r\nproto_tree_add_item(sm_tree, hf_sm_eisup_msg_id, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset = offset + 1;\r\nproto_tree_add_item(sm_tree, hf_sm_tag, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ntag = tvb_get_ntohs(tvb,offset);\r\noffset = offset +2;\r\nif (tag== 0x01ac) {\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset +2;\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\ncall_dissector(sdp_handle, next_tvb, pinfo, sm_tree);\r\n}\r\nbreak;\r\ncase SM_PROTOCOL_X114:\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset + 2;\r\nproto_item_set_len(ti, length + offset);\r\nproto_tree_add_item(sm_tree, hf_sm_ip_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset = offset + 4;\r\nproto_tree_add_item(sm_tree, hf_sm_context, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset = offset +4;\r\nproto_tree_add_item(sm_tree, hf_sm_eisup_msg_id, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset = offset + 1;\r\nproto_tree_add_item(sm_tree, hf_sm_tag, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ntag = tvb_get_ntohs(tvb,offset);\r\noffset = offset +2;\r\nif (tag== 0x01ac) {\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset +2;\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\ncall_dissector(sdp_handle, next_tvb, pinfo, sm_tree);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(sm_tree, hf_sm_msg_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset +2;\r\nmsg_type = tvb_get_ntohs(tvb,offset);\r\nproto_tree_add_uint_format_value(sm_tree, hf_sm_msg_type, tvb, offset, 2, msg_type,\r\n"%s (0x%0x)", val_to_str_const(msg_type, sm_pdu_type_value, "reserved"),\r\nmsg_type);\r\nmsg_type = tvb_get_ntohs(tvb,offset);\r\noffset = offset + 2;\r\nproto_tree_add_item(sm_tree, hf_sm_channel, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(sm_tree, hf_sm_bearer, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset +2;\r\nproto_tree_add_item(sm_tree, hf_sm_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb,offset);\r\noffset = offset +2;\r\nproto_item_set_len(ti, 16);\r\nif (length > 0) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\nswitch (msg_type) {\r\ncase PDU_MTP3_TO_SLT:\r\ncase PDU_MTP3_FROM_SLT:\r\ncall_dissector(mtp3_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PDU_CONNECT_REQUEST:\r\ncase PDU_CONNECT_CONFIRM:\r\nproto_tree_add_item(sm_tree, hf_sm_alignment_type, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase PDU_DISCONNECT_CONFIRM:\r\ncase PDU_DISCONNECT_INDICATION:\r\nproto_tree_add_item(sm_tree, hf_sm_backhaul_reason_code, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase PDU_RETRIEVAL_REQUEST:\r\ncase PDU_RETRIEVAL_CONFIRM:\r\nproto_tree_add_item(sm_tree, hf_sm_retrieval_type, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nif (msg_type == PDU_RETRIEVAL_CONFIRM && tvb_get_ntohl(tvb,offset) == 0x01) {\r\noffset += 4;\r\nproto_tree_add_item(sm_tree, hf_sm_bsn_num, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\ncase PDU_LSC_REQUEST:\r\ncase PDU_LSC_CONFIRM:\r\nproto_tree_add_item(sm_tree, hf_sm_lsc_state_type, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase PDU_LSC_INDICATION:\r\nproto_tree_add_item(sm_tree, hf_sm_backhaul_event_code, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbh_event_code = tvb_get_ntohl(tvb,offset);\r\nif (bh_event_code == 0x02 || bh_event_code == 0x04) {\r\noffset += 4;\r\nproto_tree_add_item(sm_tree, hf_sm_linkdown_cause_code, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n} else if (bh_event_code == 0x06) {\r\noffset += 4;\r\nproto_tree_add_item(sm_tree, hf_sm_backhaul_cause_code, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\ncase PDU_STAT_REQUEST:\r\nproto_tree_add_item(sm_tree, hf_sm_stat_request_type, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_sm(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sm_sm_msg_type,\r\n{ "SM Message Type", "sm.sm_msg_type",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_protocol,\r\n{ "Protocol Type", "sm.protocol",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_msg_id,\r\n{ "Message ID", "sm.msgid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_msg_type,\r\n{ "Message Type", "sm.msg_type",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_channel,\r\n{ "Channel ID", "sm.channel",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_bearer,\r\n{ "Bearer ID", "sm.bearer",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_len,\r\n{ "Length", "sm.len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_ip_addr,\r\n{ "IPv4 address","sm.ip_addr",\r\nFT_IPv4,BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_context,\r\n{ "Context","sm.context",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Context(guesswork!)", HFILL }\r\n},\r\n{ &hf_sm_eisup_msg_id,\r\n{ "Message id","sm.eisup_message_id",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Message id(guesswork!)", HFILL }\r\n},\r\n{ &hf_sm_tag,\r\n{ "Tag","sm.tag",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Tag(guesswork!)", HFILL }\r\n},\r\n{ &hf_sm_alignment_type,\r\n{ "Alignment type","sm.connect_type",\r\nFT_UINT32, BASE_HEX, VALS(sm_alignment_type), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_backhaul_reason_code,\r\n{ "Backhaul reason code","sm.backhaul_reason",\r\nFT_UINT32, BASE_HEX, VALS(sm_backhaul_reason_code), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_backhaul_event_code,\r\n{ "Backhaul event code","sm.backhaul_event",\r\nFT_UINT32, BASE_HEX, VALS(sm_backhaul_event_code), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_backhaul_cause_code,\r\n{ "Backhaul cause code","sm.backhaul_cause",\r\nFT_UINT32, BASE_HEX, VALS(sm_backhaul_cause_code), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_linkdown_cause_code,\r\n{ "Link down cause","sm.linkdown_reason",\r\nFT_UINT32, BASE_HEX, VALS(sm_linkdown_cause_code), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_retrieval_type,\r\n{ "Retrieval type","sm.retrieval_type",\r\nFT_UINT32, BASE_HEX, VALS(sm_retrieval_type), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_lsc_state_type,\r\n{ "LSC Request type","sm.lsc_state_type",\r\nFT_UINT32, BASE_HEX, VALS(sm_lsc_state_type), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_stat_request_type,\r\n{ "Statistic request type","sm.stat_request_type",\r\nFT_UINT32, BASE_HEX, VALS(sm_stat_request_type), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sm_bsn_num,\r\n{ "BSN","sm.bsn_num",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_sm,\r\n};\r\nproto_sm = proto_register_protocol("Cisco Session Management",\r\n"SM", "sm");\r\nregister_dissector("sm", dissect_sm, proto_sm);\r\nproto_register_field_array(proto_sm, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_sm(void)\r\n{\r\nsdp_handle = find_dissector_add_dependency("sdp", proto_sm);\r\nmtp3_handle = find_dissector_add_dependency("mtp3", proto_sm);\r\nq931_handle = find_dissector_add_dependency("q931", proto_sm);\r\n}

wtap_open_return_val aethra_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nstruct aethra_hdr hdr;\r\nstruct tm tm;\r\naethra_t *aethra;\r\nif (!wtap_read_bytes(wth->fh, hdr.magic, sizeof hdr.magic, err,\r\nerr_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (memcmp(hdr.magic, aethra_magic, sizeof aethra_magic) != 0)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (!wtap_read_bytes(wth->fh, (char *)&hdr + sizeof hdr.magic,\r\nsizeof hdr - sizeof hdr.magic, err, err_info))\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_AETHRA;\r\naethra = (aethra_t *)g_malloc(sizeof(aethra_t));\r\nwth->priv = (void *)aethra;\r\nwth->subtype_read = aethra_read;\r\nwth->subtype_seek_read = aethra_seek_read;\r\ntm.tm_year = pletoh16(&hdr.start_year) - 1900;\r\ntm.tm_mon = pletoh16(&hdr.start_month) - 1;\r\ntm.tm_mday = pletoh16(&hdr.start_day);\r\ntm.tm_hour = hdr.start_hour;\r\ntm.tm_min = hdr.start_min;\r\ntm.tm_sec = hdr.start_sec;\r\ntm.tm_isdst = -1;\r\naethra->start = mktime(&tm);\r\nwth->file_encap = WTAP_ENCAP_ISDN;\r\nwth->snapshot_length = 0;\r\nwth->file_tsprec = WTAP_TSPREC_MSEC;\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic gboolean aethra_read(wtap *wth, int *err, gchar **err_info,\r\ngint64 *data_offset)\r\n{\r\nstruct aethrarec_hdr hdr;\r\nfor (;;) {\r\n*data_offset = file_tell(wth->fh);\r\nif (!aethra_read_rec_header(wth, wth->fh, &hdr, &wth->phdr, err, err_info))\r\nreturn FALSE;\r\nif (wth->phdr.caplen != 0) {\r\nif (!wtap_read_packet_bytes(wth->fh, wth->frame_buffer,\r\nwth->phdr.caplen, err, err_info))\r\nreturn FALSE;\r\n}\r\n#if 0\r\npacket++;\r\n#endif\r\nswitch (hdr.rec_type) {\r\ncase AETHRA_ISDN_LINK:\r\n#if 0\r\nfprintf(stderr, "Packet %u: type 0x%02x (AETHRA_ISDN_LINK)\n",\r\npacket, hdr.rec_type);\r\n#endif\r\nswitch (hdr.flags & AETHRA_ISDN_LINK_SUBTYPE) {\r\ncase AETHRA_ISDN_LINK_LAPD:\r\n#if 0\r\nfprintf(stderr, " subtype 0x%02x (AETHRA_ISDN_LINK_LAPD)\n", hdr.flags & AETHRA_ISDN_LINK_SUBTYPE);\r\n#endif\r\ngoto found;\r\ncase AETHRA_ISDN_LINK_SA_BITS:\r\n#if 0\r\nfprintf(stderr, " subtype 0x%02x (AETHRA_ISDN_LINK_SA_BITS)\n", hdr.flags & AETHRA_ISDN_LINK_SUBTYPE);\r\n#endif\r\nbreak;\r\ncase AETHRA_ISDN_LINK_ALL_ALARMS_CLEARED:\r\n#if 0\r\nfprintf(stderr, " subtype 0x%02x (AETHRA_ISDN_LINK_ALL_ALARMS_CLEARED)\n", hdr.flags & AETHRA_ISDN_LINK_SUBTYPE);\r\n#endif\r\nbreak;\r\ndefault:\r\n#if 0\r\nfprintf(stderr, " subtype 0x%02x, packet_size %u, direction 0x%02x\n",\r\nhdr.flags & AETHRA_ISDN_LINK_SUBTYPE, wth->phdr.caplen, hdr.flags & AETHRA_U_TO_N);\r\n#endif\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\n#if 0\r\nfprintf(stderr, "Packet %u: type 0x%02x, packet_size %u, flags 0x%02x\n",\r\npacket, hdr.rec_type, wth->phdr.caplen, hdr.flags);\r\n#endif\r\nbreak;\r\n}\r\n}\r\nfound:\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\naethra_seek_read(wtap *wth, gint64 seek_off, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nstruct aethrarec_hdr hdr;\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nif (!aethra_read_rec_header(wth, wth->random_fh, &hdr, phdr, err,\r\nerr_info)) {\r\nif (*err == 0)\r\n*err = WTAP_ERR_SHORT_READ;\r\nreturn FALSE;\r\n}\r\nif (!wtap_read_packet_bytes(wth->random_fh, buf, phdr->caplen, err, err_info))\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\naethra_read_rec_header(wtap *wth, FILE_T fh, struct aethrarec_hdr *hdr,\r\nstruct wtap_pkthdr *phdr, int *err, gchar **err_info)\r\n{\r\naethra_t *aethra = (aethra_t *)wth->priv;\r\nguint32 rec_size;\r\nguint32 packet_size;\r\nguint32 msecs;\r\nif (!wtap_read_bytes_or_eof(fh, hdr, sizeof *hdr, err, err_info))\r\nreturn FALSE;\r\nrec_size = pletoh16(hdr->rec_size);\r\nif (rec_size < (sizeof *hdr - sizeof hdr->rec_size)) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("aethra: File has %u-byte record, less than minimum of %u",\r\nrec_size,\r\n(unsigned int)(sizeof *hdr - sizeof hdr->rec_size));\r\nreturn FALSE;\r\n}\r\nif (rec_size > WTAP_MAX_PACKET_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("aethra: File has %u-byte packet, bigger than maximum of %u",\r\nrec_size, WTAP_MAX_PACKET_SIZE);\r\nreturn FALSE;\r\n}\r\npacket_size = rec_size - (guint32)(sizeof *hdr - sizeof hdr->rec_size);\r\nmsecs = pletoh32(hdr->timestamp);\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = WTAP_HAS_TS;\r\nphdr->ts.secs = aethra->start + (msecs / 1000);\r\nphdr->ts.nsecs = (msecs % 1000) * 1000000;\r\nphdr->caplen = packet_size;\r\nphdr->len = packet_size;\r\nphdr->pseudo_header.isdn.uton = (hdr->flags & AETHRA_U_TO_N);\r\nphdr->pseudo_header.isdn.channel = 0;\r\nreturn TRUE;\r\n}

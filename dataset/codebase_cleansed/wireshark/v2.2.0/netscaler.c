static guint64 ns_hrtime2nsec(guint32 tm)\r\n{\r\nguint32 val = tm & NSPR_HRTIME_MASKTM;\r\nswitch(tm & NSPR_HRTIME_MASKFMT)\r\n{\r\ncase NSPR_HRTIME_SEC: return (guint64)val*1000000000;\r\ncase NSPR_HRTIME_MSEC: return (guint64)val*1000000;\r\ncase NSPR_HRTIME_USEC: return (guint64)val*1000;\r\ncase NSPR_HRTIME_NSEC: return val;\r\n}\r\nreturn tm;\r\n}\r\nwtap_open_return_val nstrace_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\ngchar *nstrace_buf;\r\ngint64 file_size;\r\ngint32 page_size;\r\nnstrace_t *nstrace;\r\nif ((file_size = wtap_file_size(wth, err)) == -1)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nnstrace_buf = (gchar *)g_malloc(NSPR_PAGESIZE);\r\npage_size = GET_READ_PAGE_SIZE(file_size);\r\nswitch ((wth->file_type_subtype = nspm_signature_version(wth, nstrace_buf, page_size)))\r\n{\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0:\r\nwth->file_encap = WTAP_ENCAP_NSTRACE_1_0;\r\nbreak;\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0:\r\nwth->file_encap = WTAP_ENCAP_NSTRACE_2_0;\r\nbreak;\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0:\r\nwth->file_encap = WTAP_ENCAP_NSTRACE_3_0;\r\ng_free(nstrace_buf);\r\nnstrace_buf = (gchar *)g_malloc(NSPR_PAGESIZE_TRACE);\r\npage_size = GET_READ_PAGE_SIZEV3(file_size);\r\nbreak;\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5:\r\nwth->file_encap = WTAP_ENCAP_NSTRACE_3_5;\r\ng_free(nstrace_buf);\r\nnstrace_buf = (gchar *)g_malloc(NSPR_PAGESIZE_TRACE);\r\npage_size = GET_READ_PAGE_SIZEV3(file_size);\r\nbreak;\r\ndefault:\r\ng_free(nstrace_buf);\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif ((file_seek(wth->fh, 0, SEEK_SET, err)) == -1)\r\n{\r\ng_free(nstrace_buf);\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nif (!wtap_read_bytes(wth->fh, nstrace_buf, page_size, err, err_info))\r\n{\r\ng_free(nstrace_buf);\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nswitch (wth->file_type_subtype)\r\n{\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0:\r\nwth->subtype_read = nstrace_read_v10;\r\nwth->subtype_seek_read = nstrace_seek_read_v10;\r\nbreak;\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0:\r\nwth->subtype_read = nstrace_read_v20;\r\nwth->subtype_seek_read = nstrace_seek_read_v20;\r\nbreak;\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0:\r\nwth->subtype_read = nstrace_read_v30;\r\nwth->subtype_seek_read = nstrace_seek_read_v30;\r\nbreak;\r\ncase WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5:\r\nwth->subtype_read = nstrace_read_v30;\r\nwth->subtype_seek_read = nstrace_seek_read_v30;\r\nbreak;\r\n}\r\nwth->subtype_close = nstrace_close;\r\nnstrace = (nstrace_t *)g_malloc(sizeof(nstrace_t));\r\nwth->priv = (void *)nstrace;\r\nnstrace->pnstrace_buf = nstrace_buf;\r\nnstrace->xxx_offset = 0;\r\nnstrace->nstrace_buflen = page_size;\r\nnstrace->nstrace_buf_offset = 0;\r\nnstrace->nspm_curtime = 0;\r\nnstrace->nspm_curtimemsec = 0;\r\nnstrace->nspm_curtimelastmsec = 0;\r\nnstrace->nsg_creltime = 0;\r\nnstrace->file_size = file_size;\r\nif ((nstrace_set_start_time(wth)) == FALSE)\r\n{\r\nif ((file_seek(wth->fh, 0, SEEK_SET, err)) == -1)\r\n{\r\ng_free(nstrace->pnstrace_buf);\r\ng_free(nstrace);\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nif (!wtap_read_bytes(wth->fh, nstrace_buf, page_size, err, err_info))\r\n{\r\ng_free(nstrace->pnstrace_buf);\r\ng_free(nstrace);\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nnstrace->nstrace_buf_offset = 0;\r\n}\r\nwth->file_tsprec = WTAP_TSPREC_NSEC;\r\nwth->phdr.ts.secs = nstrace->nspm_curtime;\r\nwth->phdr.ts.nsecs = 0;\r\n*err = 0;\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic guint32\r\nnspm_signature_version(wtap *wth, gchar *nstrace_buf, gint32 len)\r\n{\r\ngchar *dp = nstrace_buf;\r\nint bytes_read;\r\nbytes_read = file_read(dp, len, wth->fh);\r\nif (bytes_read == len) {\r\nfor ( ; len > (gint32)(MIN(sizeof(NSPR_SIGSTR_V10), sizeof(NSPR_SIGSTR_V20))); dp++, len--)\r\n{\r\n#define sigv10p ((nspr_signature_v10_t*)dp)\r\nif ((pletoh16(&sigv10p->nsprRecordType) == NSPR_SIGNATURE_V10) &&\r\n(pletoh16(&sigv10p->nsprRecordSize) <= len) &&\r\n((gint32)sizeof(NSPR_SIGSTR_V10) <= len) &&\r\n(!nspm_signature_isv10(sigv10p->sig_Signature)))\r\nreturn WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0;\r\n#undef sigv10p\r\n#define sigv20p ((nspr_signature_v20_t*)dp)\r\nif ((sigv20p->sig_RecordType == NSPR_SIGNATURE_V20) &&\r\n(sigv20p->sig_RecordSize <= len) &&\r\n((gint32)sizeof(NSPR_SIGSTR_V20) <= len))\r\n{\r\nif (!nspm_signature_isv20(sigv20p->sig_Signature)){\r\nreturn WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0;\r\n} else if (!nspm_signature_isv30(sigv20p->sig_Signature)){\r\nreturn WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0;\r\n}else if (!nspm_signature_isv35(sigv20p->sig_Signature)){\r\nreturn WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5;\r\n}\r\n}\r\n#undef sigv20p\r\n}\r\n}\r\nreturn WTAP_FILE_TYPE_SUBTYPE_UNKNOWN;\r\n}\r\nstatic gboolean nstrace_set_start_time(wtap *wth)\r\n{\r\nif (wth->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\nreturn nstrace_set_start_time_v10(wth);\r\nelse if (wth->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0)\r\nreturn nstrace_set_start_time_v20(wth);\r\nelse if (wth->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0)\r\nreturn nstrace_set_start_time_v20(wth);\r\nreturn FALSE;\r\n}\r\nstatic gboolean nstrace_read_v10(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\nnstrace_t *nstrace = (nstrace_t *)wth->priv;\r\nguint64 nsg_creltime = nstrace->nsg_creltime;\r\ngchar *nstrace_buf = nstrace->pnstrace_buf;\r\ngint32 nstrace_buf_offset = nstrace->nstrace_buf_offset;\r\ngint32 nstrace_buflen = nstrace->nstrace_buflen;\r\nint bytes_read;\r\n*err = 0;\r\n*err_info = NULL;\r\ndo\r\n{\r\nwhile ((nstrace_buf_offset < nstrace_buflen) &&\r\n((nstrace_buflen - nstrace_buf_offset) >= ((gint32)sizeof((( nspr_header_v10_t*)&nstrace_buf[nstrace_buf_offset])->ph_RecordType))))\r\n{\r\n#define GENERATE_CASE_FULL(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,full,ver,fp,HEADERVER);\r\n#define GENERATE_CASE_PART(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEPARTTX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTTXB_V##ver:\\r\ncase NSPR_PDPKTRACEPARTRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,PART,part,ver,pp,HEADERVER);\r\nswitch (pletoh16(&(( nspr_header_v10_t*)&nstrace_buf[nstrace_buf_offset])->ph_RecordType))\r\n{\r\nGENERATE_CASE_FULL(&wth->phdr,10,100)\r\nGENERATE_CASE_PART(&wth->phdr,10,100)\r\n#undef GENERATE_CASE_FULL\r\n#undef GENERATE_CASE_PART\r\ncase NSPR_ABSTIME_V10:\r\n{\r\nnspr_pktracefull_v10_t *fp = (nspr_pktracefull_v10_t *) &nstrace_buf[nstrace_buf_offset];\r\nns_setabstime(nstrace, pletoh32(((nspr_abstime_v10_t *) fp)->abs_Time), pletoh32(&((nspr_abstime_v10_t *) fp)->abs_RelTime));\r\nnstrace_buf_offset += pletoh16(&fp->nsprRecordSize);\r\nbreak;\r\n}\r\ncase NSPR_RELTIME_V10:\r\n{\r\nnspr_pktracefull_v10_t *fp = (nspr_pktracefull_v10_t *) &nstrace_buf[nstrace_buf_offset];\r\nns_setrelativetime(nstrace, pletoh32(((nspr_abstime_v10_t *) fp)->abs_RelTime));\r\nnstrace_buf_offset += pletoh16(&fp->nsprRecordSize);\r\nbreak;\r\n}\r\ncase NSPR_UNUSEDSPACE_V10:\r\nnstrace_buf_offset = nstrace_buflen;\r\nbreak;\r\ndefault:\r\n{\r\nnspr_pktracefull_v10_t *fp = (nspr_pktracefull_v10_t *) &nstrace_buf[nstrace_buf_offset];\r\nnstrace_buf_offset += pletoh16(&fp->nsprRecordSize);\r\nbreak;\r\n}\r\n}\r\n}\r\nnstrace_buf_offset = 0;\r\nnstrace->xxx_offset += nstrace_buflen;\r\nnstrace_buflen = GET_READ_PAGE_SIZE((nstrace->file_size - nstrace->xxx_offset));\r\n}while((nstrace_buflen > 0) && (bytes_read = file_read(nstrace_buf, nstrace_buflen, wth->fh)) && (bytes_read == nstrace_buflen));\r\nreturn FALSE;\r\n}\r\nstatic gboolean nstrace_read_v20(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\nnstrace_t *nstrace = (nstrace_t *)wth->priv;\r\nguint64 nsg_creltime = nstrace->nsg_creltime;\r\ngchar *nstrace_buf = nstrace->pnstrace_buf;\r\ngint32 nstrace_buf_offset = nstrace->nstrace_buf_offset;\r\ngint32 nstrace_buflen = nstrace->nstrace_buflen;\r\nint bytes_read;\r\n*err = 0;\r\n*err_info = NULL;\r\ndo\r\n{\r\nwhile ((nstrace_buf_offset < nstrace_buflen) &&\r\n((nstrace_buflen - nstrace_buf_offset) >= ((gint32)sizeof((( nspr_hd_v20_t*)&nstrace_buf[nstrace_buf_offset])->phd_RecordType))))\r\n{\r\nswitch ((( nspr_hd_v20_t*)&nstrace_buf[nstrace_buf_offset])->phd_RecordType)\r\n{\r\n#define GENERATE_CASE_FULL(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\n#define GENERATE_CASE_FULL_V25(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\n#define GENERATE_CASE_PART(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEPARTTX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTTXB_V##ver:\\r\ncase NSPR_PDPKTRACEPARTRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,PART,ver,v##ver##_part,pp,pktracepart_v##ver,HEADERVER);\r\n#define GENERATE_CASE_PART_V25(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEPARTTX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTTXB_V##ver:\\r\ncase NSPR_PDPKTRACEPARTRX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,PART,ver,v##ver##_part,pp,pktracepart_v##ver,HEADERVER);\r\nGENERATE_CASE_FULL(&wth->phdr,20,200);\r\nGENERATE_CASE_PART(&wth->phdr,20,200);\r\nGENERATE_CASE_FULL(&wth->phdr,21,201);\r\nGENERATE_CASE_PART(&wth->phdr,21,201);\r\nGENERATE_CASE_FULL(&wth->phdr,22,202);\r\nGENERATE_CASE_PART(&wth->phdr,22,202);\r\nGENERATE_CASE_FULL(&wth->phdr,23,203);\r\nGENERATE_CASE_PART(&wth->phdr,23,203);\r\nGENERATE_CASE_FULL_V25(&wth->phdr,24,204);\r\nGENERATE_CASE_PART_V25(&wth->phdr,24,204);\r\nGENERATE_CASE_FULL_V25(&wth->phdr,25,205);\r\nGENERATE_CASE_PART_V25(&wth->phdr,25,205);\r\nGENERATE_CASE_FULL_V25(&wth->phdr,26,206);\r\nGENERATE_CASE_PART_V25(&wth->phdr,26,206);\r\n#undef GENERATE_CASE_FULL\r\n#undef GENERATE_CASE_FULL_V25\r\n#undef GENERATE_CASE_PART\r\n#undef GENERATE_CASE_PART_V25\r\ncase NSPR_ABSTIME_V20:\r\n{\r\nnspr_pktracefull_v20_t *fp20 = (nspr_pktracefull_v20_t *) &nstrace_buf[nstrace_buf_offset];\r\nnstrace_buf_offset += nspr_getv20recordsize((nspr_hd_v20_t *)fp20);\r\nns_setabstime(nstrace, pletoh32(&((nspr_abstime_v20_t *) fp20)->abs_Time), pletoh16(&((nspr_abstime_v20_t *) fp20)->abs_RelTime));\r\nbreak;\r\n}\r\ncase NSPR_RELTIME_V20:\r\n{\r\nnspr_pktracefull_v20_t *fp20 = (nspr_pktracefull_v20_t *) &nstrace_buf[nstrace_buf_offset];\r\nns_setrelativetime(nstrace, pletoh16(&((nspr_abstime_v20_t *) fp20)->abs_RelTime));\r\nnstrace_buf_offset += nspr_getv20recordsize((nspr_hd_v20_t *)fp20);\r\nbreak;\r\n}\r\ncase NSPR_UNUSEDSPACE_V20:\r\n{\r\nif (nstrace_buf_offset >= NSPR_PAGESIZE/2)\r\nnstrace_buf_offset = nstrace_buflen;\r\nelse\r\nnstrace_buf_offset = NSPR_PAGESIZE/2;\r\nbreak;\r\n}\r\ndefault:\r\n{\r\nnspr_pktracefull_v20_t *fp20 = (nspr_pktracefull_v20_t *) &nstrace_buf[nstrace_buf_offset];\r\nnstrace_buf_offset += nspr_getv20recordsize((nspr_hd_v20_t *)fp20);\r\nbreak;\r\n}\r\n}\r\n}\r\nnstrace_buf_offset = 0;\r\nnstrace->xxx_offset += nstrace_buflen;\r\nnstrace_buflen = GET_READ_PAGE_SIZE((nstrace->file_size - nstrace->xxx_offset));\r\n}while((nstrace_buflen > 0) && (bytes_read = file_read(nstrace_buf, nstrace_buflen, wth->fh)) && (bytes_read == nstrace_buflen));\r\nreturn FALSE;\r\n}\r\nstatic gboolean nstrace_read_v30(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\nnstrace_t *nstrace = (nstrace_t *)wth->priv;\r\nguint64 nsg_creltime;\r\ngchar *nstrace_buf = nstrace->pnstrace_buf;\r\ngint32 nstrace_buf_offset = nstrace->nstrace_buf_offset;\r\ngint32 nstrace_buflen = nstrace->nstrace_buflen;\r\nguint8 nstrace_tmpbuff[65536];\r\nguint32 nstrace_tmpbuff_off=0,nst_dataSize=0,rec_size=0,nsg_nextPageOffset=0;\r\nnspr_hd_v20_t *hdp;\r\nint bytes_read = 0;\r\n*err = 0;\r\n*err_info = NULL;\r\nif(nstrace_buflen == 0){\r\nreturn FALSE;\r\n}\r\ndo\r\n{\r\nif (!nstrace_buf[nstrace_buf_offset] && nstrace_buf_offset <= NSPR_PAGESIZE_TRACE){\r\nnstrace_buf_offset = NSPR_PAGESIZE_TRACE;\r\n}\r\nif(file_eof(wth->fh) && bytes_read>0 ){\r\nmemset(&nstrace_buf[bytes_read], 0, NSPR_PAGESIZE_TRACE-bytes_read);\r\n}\r\nwhile ((nstrace_buf_offset < NSPR_PAGESIZE_TRACE) &&\r\nnstrace_buf[nstrace_buf_offset])\r\n{\r\nhdp = (nspr_hd_v20_t *) &nstrace_buf[nstrace_buf_offset];\r\nif(nspr_getv20recordsize(hdp) == 0){\r\n*err=WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("Zero size record found");\r\nreturn FALSE;\r\n}\r\nswitch (hdp->phd_RecordType)\r\n{\r\n#define GENERATE_CASE_FULL_V30(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\nGENERATE_CASE_FULL_V30(&wth->phdr,30,300);\r\n#undef GENERATE_CASE_FULL_V30\r\n#define GENERATE_CASE_FULL_V35(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\nGENERATE_CASE_FULL_V35(&wth->phdr,35,350);\r\n#undef GENERATE_CASE_FULL_V35\r\ncase NSPR_ABSTIME_V20:\r\n{\r\nnstrace_buf_offset += nspr_getv20recordsize(hdp);\r\nns_setabstime(nstrace, pletoh32(&((nspr_abstime_v20_t *) &nstrace_buf[nstrace_buf_offset])->abs_Time), pletoh16(&((nspr_abstime_v20_t *) &nstrace_buf[nstrace_buf_offset])->abs_RelTime));\r\nbreak;\r\n}\r\ncase NSPR_RELTIME_V20:\r\n{\r\nns_setrelativetime(nstrace, pletoh16(&((nspr_abstime_v20_t *) &nstrace_buf[nstrace_buf_offset])->abs_RelTime));\r\nnstrace_buf_offset += nspr_getv20recordsize(hdp);\r\nbreak;\r\n}\r\ndefault:\r\n{\r\nnstrace_buf_offset += nspr_getv20recordsize(hdp);\r\nbreak;\r\n}\r\n}\r\n}\r\nnstrace_buf_offset = 0;\r\nnstrace->xxx_offset += nstrace_buflen;\r\nnstrace_buflen = NSPR_PAGESIZE_TRACE;\r\n} while((nstrace_buflen > 0) && (bytes_read = file_read(nstrace_buf, nstrace_buflen, wth->fh)) && (file_eof(wth->fh) || bytes_read == nstrace_buflen));\r\nreturn FALSE;\r\n}\r\nstatic gboolean nstrace_seek_read_v10(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf, int *err, gchar **err_info)\r\n{\r\nnspr_hd_v10_t hdr;\r\nguint record_length;\r\nguint8 *pd;\r\nunsigned int bytes_to_read;\r\n*err = 0;\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nif (!wtap_read_bytes(wth->random_fh, (void *)&hdr, sizeof hdr,\r\nerr, err_info))\r\nreturn FALSE;\r\nrecord_length = nspr_getv10recordsize(&hdr);\r\nws_buffer_assure_space(buf, record_length);\r\npd = ws_buffer_start_ptr(buf);\r\nmemcpy(pd, (void *)&hdr, sizeof hdr);\r\nif (record_length > sizeof hdr) {\r\nbytes_to_read = (unsigned int)(record_length - sizeof hdr);\r\nif (!wtap_read_bytes(wth->random_fh, pd + sizeof hdr, bytes_to_read,\r\nerr, err_info))\r\nreturn FALSE;\r\n}\r\n#define GENERATE_CASE_FULL(phdr,type,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##type:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##type:\\r\ncase NSPR_PDPKTRACEFULLRX_V##type:\\r\nPACKET_DESCRIBE(phdr,FULL,full,type,fp,HEADERVER);\\r\nbreak;\r\n#define GENERATE_CASE_PART(phdr,type,HEADERVER) \\r\ncase NSPR_PDPKTRACEPARTTX_V##type:\\r\ncase NSPR_PDPKTRACEPARTTXB_V##type:\\r\ncase NSPR_PDPKTRACEPARTRX_V##type:\\r\nPACKET_DESCRIBE(phdr,PART,part,type,pp,HEADERVER);\\r\nbreak;\r\nswitch (pletoh16(&(( nspr_header_v10_t*)pd)->ph_RecordType))\r\n{\r\nGENERATE_CASE_FULL(phdr,10,100)\r\nGENERATE_CASE_PART(phdr,10,100)\r\n}\r\n#undef GENERATE_CASE_FULL\r\n#undef GENERATE_CASE_PART\r\nreturn TRUE;\r\n}\r\nstatic gboolean nstrace_seek_read_v20(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf, int *err, gchar **err_info)\r\n{\r\nnspr_hd_v20_t hdr;\r\nguint record_length;\r\nguint hdrlen;\r\nguint8 *pd;\r\nunsigned int bytes_to_read;\r\nguint64 nsg_creltime;\r\n*err = 0;\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nif (!wtap_read_bytes(wth->random_fh, (void *)&hdr, 2, err, err_info))\r\nreturn FALSE;\r\nhdrlen = 2;\r\nif (hdr.phd_RecordSizeLow & NSPR_V20RECORDSIZE_2BYTES) {\r\nif (!wtap_read_bytes(wth->random_fh, (void *)&hdr.phd_RecordSizeHigh, 1,\r\nerr, err_info))\r\nreturn FALSE;\r\nhdrlen = 3;\r\n}\r\nrecord_length = nspr_getv20recordsize(&hdr);\r\nws_buffer_assure_space(buf, record_length);\r\npd = ws_buffer_start_ptr(buf);\r\nmemcpy(pd, (void *)&hdr, hdrlen);\r\nif (record_length > hdrlen) {\r\nbytes_to_read = (unsigned int)(record_length - hdrlen);\r\nif (!wtap_read_bytes(wth->random_fh, pd + hdrlen, bytes_to_read,\r\nerr, err_info))\r\nreturn FALSE;\r\n}\r\n#define GENERATE_CASE_FULL(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\n#define GENERATE_CASE_FULL_V25(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\n#define GENERATE_CASE_PART(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEPARTTX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTTXB_V##ver:\\r\ncase NSPR_PDPKTRACEPARTRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,PART,ver,v##ver##_part,pp,pktracepart_v##ver,HEADERVER);\r\n#define GENERATE_CASE_PART_V25(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEPARTTX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTTXB_V##ver:\\r\ncase NSPR_PDPKTRACEPARTRX_V##ver:\\r\ncase NSPR_PDPKTRACEPARTNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,PART,ver,v##ver##_part,pp,pktracepart_v##ver,HEADERVER);\r\nswitch ((( nspr_hd_v20_t*)pd)->phd_RecordType)\r\n{\r\nGENERATE_CASE_FULL(phdr,20,200)\r\nGENERATE_CASE_PART(phdr,20,200)\r\nGENERATE_CASE_FULL(phdr,21,201)\r\nGENERATE_CASE_PART(phdr,21,201)\r\nGENERATE_CASE_FULL(phdr,22,202)\r\nGENERATE_CASE_PART(phdr,22,202)\r\nGENERATE_CASE_FULL(phdr,23,203)\r\nGENERATE_CASE_PART(phdr,23,203)\r\nGENERATE_CASE_FULL_V25(phdr,24,204)\r\nGENERATE_CASE_PART_V25(phdr,24,204)\r\nGENERATE_CASE_FULL_V25(phdr,25,205)\r\nGENERATE_CASE_PART_V25(phdr,25,205)\r\nGENERATE_CASE_FULL_V25(phdr,26,206)\r\nGENERATE_CASE_PART_V25(phdr,26,206)\r\n}\r\n#undef GENERATE_CASE_FULL\r\n#undef GENERATE_CASE_FULL_V25\r\n#undef GENERATE_CASE_PART\r\n#undef GENERATE_CASE_PART_V25\r\nreturn TRUE;\r\n}\r\nstatic gboolean nstrace_seek_read_v30(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf, int *err, gchar **err_info)\r\n{\r\nnspr_hd_v20_t hdr;\r\nguint record_length;\r\nguint hdrlen;\r\nguint8 *pd;\r\nunsigned int bytes_to_read;\r\nguint64 nsg_creltime;\r\n*err = 0;\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nif (!wtap_read_bytes(wth->random_fh, (void *)&hdr, 2, err, err_info))\r\nreturn FALSE;\r\nhdrlen = 2;\r\nif (hdr.phd_RecordSizeLow & NSPR_V20RECORDSIZE_2BYTES) {\r\nif (!wtap_read_bytes(wth->random_fh, (void *)&hdr.phd_RecordSizeHigh, 1,\r\nerr, err_info))\r\nreturn FALSE;\r\nhdrlen = 3;\r\n}\r\nrecord_length = nspr_getv20recordsize(&hdr);\r\nws_buffer_assure_space(buf, record_length);\r\npd = ws_buffer_start_ptr(buf);\r\nmemcpy(pd, (void *)&hdr, hdrlen);\r\nif (record_length > hdrlen) {\r\nbytes_to_read = (unsigned int)(record_length - hdrlen);\r\nif (!wtap_read_bytes(wth->random_fh, pd + hdrlen, bytes_to_read,\r\nerr, err_info))\r\nreturn FALSE;\r\n}\r\n(phdr)->caplen = (phdr)->len = record_length;\r\n#define GENERATE_CASE_V30(phdr,ver,HEADERVER) \\r\ncase NSPR_PDPKTRACEFULLTX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLTXB_V##ver:\\r\ncase NSPR_PDPKTRACEFULLRX_V##ver:\\r\ncase NSPR_PDPKTRACEFULLNEWRX_V##ver:\\r\nPACKET_DESCRIBE(phdr,FULL,ver,v##ver##_full,fp,pktracefull_v##ver,HEADERVER);\r\nswitch ((( nspr_hd_v20_t*)pd)->phd_RecordType)\r\n{\r\nGENERATE_CASE_V30(phdr,30, 300);\r\nGENERATE_CASE_V30(phdr,35, 350);\r\n}\r\nreturn TRUE;\r\n}\r\nstatic void nstrace_close(wtap *wth)\r\n{\r\nnstrace_t *nstrace = (nstrace_t *)wth->priv;\r\ng_free(nstrace->pnstrace_buf);\r\n}\r\nint nstrace_10_dump_can_write_encap(int encap)\r\n{\r\nif (encap == WTAP_ENCAP_NSTRACE_1_0)\r\nreturn 0;\r\nreturn WTAP_ERR_UNWRITABLE_ENCAP;\r\n}\r\nint nstrace_20_dump_can_write_encap(int encap)\r\n{\r\nif (encap == WTAP_ENCAP_NSTRACE_2_0)\r\nreturn 0;\r\nreturn WTAP_ERR_UNWRITABLE_ENCAP;\r\n}\r\nint nstrace_30_dump_can_write_encap(int encap)\r\n{\r\nif (encap == WTAP_ENCAP_NSTRACE_3_0)\r\nreturn 0;\r\nreturn WTAP_ERR_UNWRITABLE_ENCAP;\r\n}\r\nint nstrace_35_dump_can_write_encap(int encap)\r\n{\r\nif (encap == WTAP_ENCAP_NSTRACE_3_5)\r\nreturn 0;\r\nreturn WTAP_ERR_UNWRITABLE_ENCAP;\r\n}\r\ngboolean nstrace_dump_open(wtap_dumper *wdh, int *err _U_)\r\n{\r\nnstrace_dump_t *nstrace;\r\nwdh->subtype_write = nstrace_dump;\r\nnstrace = (nstrace_dump_t *)g_malloc(sizeof(nstrace_dump_t));\r\nwdh->priv = (void *)nstrace;\r\nnstrace->page_offset = 0;\r\nif ((wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0) ||\r\n(wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5))\r\nnstrace->page_len = NSPR_PAGESIZE_TRACE;\r\nelse\r\nnstrace->page_len = NSPR_PAGESIZE;\r\nnstrace->absrec_time = 0;\r\nnstrace->newfile = TRUE;\r\nreturn TRUE;\r\n}\r\nstatic gboolean nstrace_add_signature(wtap_dumper *wdh, int *err)\r\n{\r\nnstrace_dump_t *nstrace = (nstrace_dump_t *)wdh->priv;\r\nif (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\n{\r\nguint16 val16b;\r\nnspr_signature_v10_t sig10;\r\nval16b = GUINT16_TO_LE(NSPR_SIGNATURE_V10);\r\nmemcpy(sig10.phd.ph_RecordType, &val16b, sizeof sig10.phd.ph_RecordType);\r\nval16b = GUINT16_TO_LE(nspr_signature_v10_s);\r\nmemcpy(sig10.phd.ph_RecordSize, &val16b, sizeof sig10.phd.ph_RecordSize);\r\nmemset(sig10.sig_Signature, 0, NSPR_SIGSIZE_V10);\r\ng_strlcpy(sig10.sig_Signature, NSPR_SIGSTR_V10, NSPR_SIGSIZE_V10);\r\nif (!wtap_dump_file_write(wdh, &sig10, nspr_signature_v10_s,\r\nerr))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) nspr_signature_v10_s;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0)\r\n{\r\nnspr_signature_v20_t sig20;\r\nsig20.sig_RecordType = NSPR_SIGNATURE_V20;\r\nsig20.sig_RecordSize = nspr_signature_v20_s;\r\nmemcpy(sig20.sig_Signature, NSPR_SIGSTR_V20, sizeof(NSPR_SIGSTR_V20));\r\nif (!wtap_dump_file_write(wdh, &sig20, sig20.sig_RecordSize,\r\nerr))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) sig20.sig_RecordSize;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0)\r\n{\r\nnspr_signature_v30_t sig30;\r\nsig30.sig_RecordType = NSPR_SIGNATURE_V30;\r\nsig30.sig_RecordSize = nspr_signature_v30_s;\r\nmemcpy(sig30.sig_Signature, NSPR_SIGSTR_V30, sizeof(NSPR_SIGSTR_V30));\r\nif (!wtap_dump_file_write(wdh, &sig30, sig30.sig_RecordSize,\r\nerr))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) sig30.sig_RecordSize;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5)\r\n{\r\nnspr_signature_v35_t sig35;\r\nsig35.sig_RecordType = NSPR_SIGNATURE_V35;\r\nsig35.sig_RecordSize = nspr_signature_v35_s;\r\nmemcpy(sig35.sig_Signature, NSPR_SIGSTR_V35, sizeof(NSPR_SIGSTR_V35));\r\nif (!wtap_dump_file_write(wdh, &sig35, sig35.sig_RecordSize,\r\nerr))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) sig35.sig_RecordSize;\r\n} else\r\n{\r\ng_assert_not_reached();\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nnstrace_add_abstime(wtap_dumper *wdh, const struct wtap_pkthdr *phdr,\r\nconst guint8 *pd, int *err)\r\n{\r\nnstrace_dump_t *nstrace = (nstrace_dump_t *)wdh->priv;\r\nguint64 nsg_creltime;\r\nif (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\n{\r\nguint16 val16;\r\nguint32 reltime;\r\nguint64 abstime;\r\nnspr_abstime_v10_t abs10;\r\nval16 = GUINT16_TO_LE(NSPR_ABSTIME_V10);\r\nmemcpy(abs10.phd.ph_RecordType, &val16, sizeof abs10.phd.ph_RecordType);\r\nval16 = GUINT16_TO_LE(nspr_abstime_v10_s);\r\nmemcpy(abs10.phd.ph_RecordSize, &val16, sizeof abs10.phd.ph_RecordSize);\r\nmemcpy(&reltime, ((const nspr_pktracefull_v10_t *)pd)->fp_RelTimeHr, sizeof reltime);\r\nnsg_creltime = ns_hrtime2nsec(reltime);\r\nmemset(abs10.abs_RelTime, 0, sizeof abs10.abs_RelTime);\r\nabstime = GUINT32_TO_LE((guint32)phdr->ts.secs - (guint32)(nsg_creltime/1000000000));\r\nmemcpy(abs10.abs_Time, &abstime, sizeof abs10.abs_Time);\r\nif (!wtap_dump_file_write(wdh, &abs10, nspr_abstime_v10_s, err))\r\nreturn FALSE;\r\nnstrace->page_offset += nspr_abstime_v10_s;\r\n} else if ((wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0) ||\r\n(wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0) ||\r\n(wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5)) {\r\nguint32 reltime;\r\nguint64 abstime;\r\nnspr_abstime_v20_t abs20;\r\nabs20.abs_RecordType = NSPR_ABSTIME_V20;\r\nabs20.abs_RecordSize = nspr_abstime_v20_s;\r\nmemcpy(&reltime, ((const nspr_pktracefull_v20_t *)pd)->fp_RelTimeHr, sizeof reltime);\r\nnsg_creltime = ns_hrtime2nsec(reltime);\r\nmemset(abs20.abs_RelTime, 0, sizeof abs20.abs_RelTime);\r\nabstime = GUINT32_TO_LE((guint32)phdr->ts.secs - (guint32)(nsg_creltime/1000000000));\r\nmemcpy(abs20.abs_RelTime, &abstime, sizeof abs20.abs_RelTime);\r\nif (!wtap_dump_file_write(wdh, &abs20, nspr_abstime_v20_s, err))\r\nreturn FALSE;\r\nnstrace->page_offset += nspr_abstime_v20_s;\r\n} else\r\n{\r\ng_assert_not_reached();\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean nstrace_dump(wtap_dumper *wdh, const struct wtap_pkthdr *phdr,\r\nconst guint8 *pd, int *err, gchar **err_info _U_)\r\n{\r\nnstrace_dump_t *nstrace = (nstrace_dump_t *)wdh->priv;\r\nif (phdr->rec_type != REC_TYPE_PACKET) {\r\n*err = WTAP_ERR_UNWRITABLE_REC_TYPE;\r\nreturn FALSE;\r\n}\r\nif (nstrace->newfile == TRUE)\r\n{\r\nnstrace->newfile = FALSE;\r\nif (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\n{\r\nif (!nstrace_add_signature(wdh, err) ||\r\n!nstrace_add_abstime(wdh, phdr, pd, err))\r\nreturn FALSE;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0)\r\n{\r\nif (!nstrace_add_signature(wdh, err) ||\r\n!nstrace_add_abstime(wdh, phdr, pd, err))\r\nreturn FALSE;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0 ||\r\nwdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5 )\r\n{\r\nif (!nstrace_add_signature(wdh, err) ||\r\n!nstrace_add_abstime(wdh, phdr, pd, err))\r\nreturn FALSE;\r\n} else\r\n{\r\ng_assert_not_reached();\r\nreturn FALSE;\r\n}\r\n}\r\nswitch (phdr->pseudo_header.nstr.rec_type)\r\n{\r\ncase NSPR_HEADER_VERSION100:\r\nif (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\n{\r\nif (nstrace->page_offset + phdr->caplen >= nstrace->page_len)\r\n{\r\nif (wtap_dump_file_seek(wdh, (nstrace->page_len - nstrace->page_offset), SEEK_CUR, err) == -1)\r\nreturn FALSE;\r\nnstrace->page_offset = 0;\r\nif (!nstrace_add_signature(wdh, err))\r\nreturn FALSE;\r\n}\r\nif (!wtap_dump_file_write(wdh, pd, phdr->caplen, err))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) phdr->caplen;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0)\r\n{\r\n*err = WTAP_ERR_UNWRITABLE_FILE_TYPE;\r\nreturn FALSE;\r\n}\r\nbreak;\r\ncase NSPR_HEADER_VERSION200:\r\ncase NSPR_HEADER_VERSION201:\r\ncase NSPR_HEADER_VERSION202:\r\ncase NSPR_HEADER_VERSION203:\r\ncase NSPR_HEADER_VERSION204:\r\ncase NSPR_HEADER_VERSION205:\r\ncase NSPR_HEADER_VERSION206:\r\nif (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\n{\r\n*err = WTAP_ERR_UNWRITABLE_FILE_TYPE;\r\nreturn FALSE;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0)\r\n{\r\nif (nstrace->page_offset + phdr->caplen >= nstrace->page_len)\r\n{\r\nif (wtap_dump_file_seek(wdh, (nstrace->page_len - nstrace->page_offset), SEEK_CUR, err) == -1)\r\nreturn FALSE;\r\nnstrace->page_offset = 0;\r\nif (!nstrace_add_signature(wdh, err))\r\nreturn FALSE;\r\n}\r\nif (!wtap_dump_file_write(wdh, pd, phdr->caplen, err))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) phdr->caplen;\r\n}\r\nbreak;\r\ncase NSPR_HEADER_VERSION300:\r\ncase NSPR_HEADER_VERSION350:\r\nif (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_1_0)\r\n{\r\n*err = WTAP_ERR_UNWRITABLE_FILE_TYPE;\r\nreturn FALSE;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_2_0)\r\n{\r\n*err = WTAP_ERR_UNWRITABLE_FILE_TYPE;\r\nreturn FALSE;\r\n} else if (wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_0 || wdh->file_type_subtype == WTAP_FILE_TYPE_SUBTYPE_NETSCALER_3_5)\r\n{\r\nif (nstrace->page_offset + phdr->caplen >= nstrace->page_len)\r\n{\r\nif (wtap_dump_file_seek(wdh, (nstrace->page_len - nstrace->page_offset), SEEK_CUR, err) == -1)\r\nreturn FALSE;\r\nnstrace->page_offset = 0;\r\nif (!nstrace_add_signature(wdh, err))\r\nreturn FALSE;\r\n}\r\nif (!wtap_dump_file_write(wdh, pd, phdr->caplen, err))\r\nreturn FALSE;\r\nnstrace->page_offset += (guint16) phdr->caplen;\r\n} else\r\n{\r\ng_assert_not_reached();\r\nreturn FALSE;\r\n}\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}

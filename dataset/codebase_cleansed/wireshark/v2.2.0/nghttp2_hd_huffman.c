static ssize_t huff_encode_sym(nghttp2_bufs *bufs, size_t *avail_ptr,\r\nsize_t rembits, const nghttp2_huff_sym *sym) {\r\nint rv;\r\nsize_t nbits = sym->nbits;\r\nuint32_t code = sym->code;\r\nif (rembits > nbits) {\r\nnghttp2_bufs_fast_orb_hold(bufs, (uint8_t)(code << (rembits - nbits)));\r\nreturn (ssize_t)(rembits - nbits);\r\n}\r\nif (rembits == nbits) {\r\nnghttp2_bufs_fast_orb(bufs, (uint8_t)code);\r\n--*avail_ptr;\r\nreturn 8;\r\n}\r\nnghttp2_bufs_fast_orb(bufs, (uint8_t)(code >> (nbits - rembits)));\r\n--*avail_ptr;\r\nnbits -= rembits;\r\nif (nbits & 0x7) {\r\ncode <<= 8 - (nbits & 0x7);\r\n}\r\nif (*avail_ptr < (nbits + 7) / 8) {\r\nrv = nghttp2_bufs_advance(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\nassert(*avail_ptr >= 3);\r\n}\r\nif (nbits < 8) {\r\nnghttp2_bufs_fast_addb_hold(bufs, (uint8_t)code);\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\nreturn (ssize_t)(8 - nbits);\r\n}\r\nif (nbits > 24) {\r\nnghttp2_bufs_fast_addb(bufs, (uint8_t)(code >> 24));\r\nnbits -= 8;\r\n}\r\nif (nbits > 16) {\r\nnghttp2_bufs_fast_addb(bufs, (uint8_t)(code >> 16));\r\nnbits -= 8;\r\n}\r\nif (nbits > 8) {\r\nnghttp2_bufs_fast_addb(bufs, (uint8_t)(code >> 8));\r\nnbits -= 8;\r\n}\r\nif (nbits == 8) {\r\nnghttp2_bufs_fast_addb(bufs, (uint8_t)code);\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\nreturn 8;\r\n}\r\nnghttp2_bufs_fast_addb_hold(bufs, (uint8_t)code);\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\nreturn (ssize_t)(8 - nbits);\r\n}\r\nsize_t nghttp2_hd_huff_encode_count(const uint8_t *src, size_t len) {\r\nsize_t i;\r\nsize_t nbits = 0;\r\nfor (i = 0; i < len; ++i) {\r\nnbits += huff_sym_table[src[i]].nbits;\r\n}\r\nreturn (nbits + 7) / 8;\r\n}\r\nint nghttp2_hd_huff_encode(nghttp2_bufs *bufs, const uint8_t *src,\r\nsize_t srclen) {\r\nint rv;\r\nssize_t rembits = 8;\r\nsize_t i;\r\nsize_t avail;\r\navail = nghttp2_bufs_cur_avail(bufs);\r\nfor (i = 0; i < srclen; ++i) {\r\nconst nghttp2_huff_sym *sym = &huff_sym_table[src[i]];\r\nif (rembits == 8) {\r\nif (avail) {\r\nnghttp2_bufs_fast_addb_hold(bufs, 0);\r\n} else {\r\nrv = nghttp2_bufs_addb_hold(bufs, 0);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\navail = nghttp2_bufs_cur_avail(bufs);\r\n}\r\n}\r\nrembits = huff_encode_sym(bufs, &avail, (size_t)rembits, sym);\r\nif (rembits < 0) {\r\nreturn (int)rembits;\r\n}\r\n}\r\nif (rembits < 8) {\r\nconst nghttp2_huff_sym *sym = &huff_sym_table[256];\r\nassert(avail);\r\nnghttp2_bufs_fast_orb(\r\nbufs, (uint8_t)(sym->code >> (sym->nbits - (size_t)rembits)));\r\n}\r\nreturn 0;\r\n}\r\nvoid nghttp2_hd_huff_decode_context_init(nghttp2_hd_huff_decode_context *ctx) {\r\nctx->state = 0;\r\nctx->accept = 1;\r\n}\r\nssize_t nghttp2_hd_huff_decode(nghttp2_hd_huff_decode_context *ctx,\r\nnghttp2_buf *buf, const uint8_t *src,\r\nsize_t srclen, int final) {\r\nsize_t i;\r\nfor (i = 0; i < srclen; ++i) {\r\nconst nghttp2_huff_decode *t;\r\nt = &huff_decode_table[ctx->state][src[i] >> 4];\r\nif (t->flags & NGHTTP2_HUFF_FAIL) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nif (t->flags & NGHTTP2_HUFF_SYM) {\r\n*buf->last++ = t->sym;\r\n}\r\nt = &huff_decode_table[t->state][src[i] & 0xf];\r\nif (t->flags & NGHTTP2_HUFF_FAIL) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nif (t->flags & NGHTTP2_HUFF_SYM) {\r\n*buf->last++ = t->sym;\r\n}\r\nctx->state = t->state;\r\nctx->accept = (t->flags & NGHTTP2_HUFF_ACCEPTED) != 0;\r\n}\r\nif (final && !ctx->accept) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nreturn (ssize_t)i;\r\n}

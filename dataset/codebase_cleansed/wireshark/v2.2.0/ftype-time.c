static gboolean\r\ncmp_eq(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn ((a->value.time.secs) ==(b->value.time.secs))\r\n&&((a->value.time.nsecs)==(b->value.time.nsecs));\r\n}\r\nstatic gboolean\r\ncmp_ne(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (a->value.time.secs !=b->value.time.secs)\r\n||(a->value.time.nsecs!=b->value.time.nsecs);\r\n}\r\nstatic gboolean\r\ncmp_gt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nif (a->value.time.secs > b->value.time.secs) {\r\nreturn TRUE;\r\n}\r\nif (a->value.time.secs < b->value.time.secs) {\r\nreturn FALSE;\r\n}\r\nreturn a->value.time.nsecs > b->value.time.nsecs;\r\n}\r\nstatic gboolean\r\ncmp_ge(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nif (a->value.time.secs > b->value.time.secs) {\r\nreturn TRUE;\r\n}\r\nif (a->value.time.secs < b->value.time.secs) {\r\nreturn FALSE;\r\n}\r\nreturn a->value.time.nsecs >= b->value.time.nsecs;\r\n}\r\nstatic gboolean\r\ncmp_lt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nif (a->value.time.secs < b->value.time.secs) {\r\nreturn TRUE;\r\n}\r\nif (a->value.time.secs > b->value.time.secs) {\r\nreturn FALSE;\r\n}\r\nreturn a->value.time.nsecs < b->value.time.nsecs;\r\n}\r\nstatic gboolean\r\ncmp_le(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nif (a->value.time.secs < b->value.time.secs) {\r\nreturn TRUE;\r\n}\r\nif (a->value.time.secs > b->value.time.secs) {\r\nreturn FALSE;\r\n}\r\nreturn a->value.time.nsecs <= b->value.time.nsecs;\r\n}\r\nstatic gboolean\r\nget_nsecs(const char *startp, int *nsecs)\r\n{\r\nint ndigits;\r\nint scale;\r\nconst char *p;\r\nint val;\r\nint digit;\r\nint i;\r\nndigits = (int)strlen(startp);\r\nscale = 9 - ndigits;\r\np = startp + ndigits;\r\nval = 0;\r\nwhile (p != startp) {\r\np--;\r\nif (!g_ascii_isdigit(*p)) {\r\nreturn FALSE;\r\n}\r\ndigit = *p - '0';\r\nif (digit != 0) {\r\nif (scale < 0)\r\nreturn FALSE;\r\nfor (i = 0; i < scale; i++)\r\ndigit *= 10;\r\nval += digit;\r\n}\r\nscale++;\r\n}\r\n*nsecs = val;\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nrelative_val_from_unparsed(fvalue_t *fv, const char *s, gboolean allow_partial_value _U_, gchar **err_msg)\r\n{\r\nconst char *curptr;\r\nchar *endptr;\r\ngboolean negative = FALSE;\r\ncurptr = s;\r\nif(*curptr == '-') {\r\nnegative = TRUE;\r\ncurptr++;\r\n}\r\nif (*curptr != '.') {\r\nfv->value.time.secs = strtoul(curptr, &endptr, 10);\r\nif (endptr == curptr || (*endptr != '\0' && *endptr != '.'))\r\ngoto fail;\r\ncurptr = endptr;\r\nif (*curptr == '.')\r\ncurptr++;\r\n} else {\r\nfv->value.time.secs = 0;\r\ncurptr++;\r\n}\r\nif (*curptr != '\0') {\r\nif (!get_nsecs(curptr, &fv->value.time.nsecs))\r\ngoto fail;\r\n} else {\r\nfv->value.time.nsecs = 0;\r\n}\r\nif(negative) {\r\nfv->value.time.secs = -fv->value.time.secs;\r\nfv->value.time.nsecs = -fv->value.time.nsecs;\r\n}\r\nreturn TRUE;\r\nfail:\r\nif (err_msg != NULL)\r\n*err_msg = g_strdup_printf("\"%s\" is not a valid time.", s);\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nabsolute_val_from_string(fvalue_t *fv, const char *s, gchar **err_msg)\r\n{\r\nstruct tm tm;\r\nchar *curptr;\r\nmemset(&tm, 0, sizeof(tm));\r\ncurptr = strptime(s,"%b %d, %Y %H:%M:%S", &tm);\r\nif (curptr == NULL)\r\ncurptr = strptime(s,"%Y-%m-%dT%H:%M:%S", &tm);\r\nif (curptr == NULL)\r\ncurptr = strptime(s,"%Y-%m-%d %H:%M:%S", &tm);\r\nif (curptr == NULL)\r\ncurptr = strptime(s,"%Y-%m-%d %H:%M", &tm);\r\nif (curptr == NULL)\r\ncurptr = strptime(s,"%Y-%m-%d %H", &tm);\r\nif (curptr == NULL)\r\ncurptr = strptime(s,"%Y-%m-%d", &tm);\r\nif (curptr == NULL)\r\ngoto fail;\r\ntm.tm_isdst = -1;\r\nfv->value.time.secs = mktime(&tm);\r\nif (*curptr != '\0') {\r\nif (*curptr != '.')\r\ngoto fail;\r\ncurptr++;\r\nif (!g_ascii_isdigit((unsigned char)*curptr))\r\ngoto fail;\r\nif (!get_nsecs(curptr, &fv->value.time.nsecs))\r\ngoto fail;\r\n} else {\r\nfv->value.time.nsecs = 0;\r\n}\r\nif (fv->value.time.secs == -1) {\r\ngoto fail;\r\n}\r\nreturn TRUE;\r\nfail:\r\nif (err_msg != NULL)\r\n*err_msg = g_strdup_printf("\"%s\" is not a valid absolute time. Example: \"Nov 12, 1999 08:55:44.123\" or \"2011-07-04 12:34:56\"",\r\ns);\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nabsolute_val_from_unparsed(fvalue_t *fv, const char *s, gboolean allow_partial_value _U_, gchar **err_msg)\r\n{\r\nreturn absolute_val_from_string(fv, s, err_msg);\r\n}\r\nstatic void\r\ntime_fvalue_new(fvalue_t *fv)\r\n{\r\nfv->value.time.secs = 0;\r\nfv->value.time.nsecs = 0;\r\n}\r\nstatic void\r\ntime_fvalue_set(fvalue_t *fv, const nstime_t *value)\r\n{\r\nfv->value.time = *value;\r\n}\r\nstatic gpointer\r\nvalue_get(fvalue_t *fv)\r\n{\r\nreturn &(fv->value.time);\r\n}\r\nstatic int\r\nabsolute_val_repr_len(fvalue_t *fv, ftrepr_t rtype, int field_display _U_)\r\n{\r\ngchar *rep;\r\nint ret;\r\nrep = abs_time_to_str(NULL, &fv->value.time, ABSOLUTE_TIME_LOCAL,\r\nrtype == FTREPR_DISPLAY);\r\nret = (int)strlen(rep) + ((rtype == FTREPR_DFILTER) ? 2 : 0);\r\nwmem_free(NULL, rep);\r\nreturn ret;\r\n}\r\nstatic void\r\nabsolute_val_to_repr(fvalue_t *fv, ftrepr_t rtype, int field_display _U_, char *buf, unsigned int size)\r\n{\r\ngchar *rep = abs_time_to_str(NULL, &fv->value.time, ABSOLUTE_TIME_LOCAL,\r\nrtype == FTREPR_DISPLAY);\r\nif (rtype == FTREPR_DFILTER) {\r\n*buf++ = '\"';\r\n}\r\ng_strlcpy(buf, rep, size);\r\nif (rtype == FTREPR_DFILTER) {\r\nbuf += strlen(rep);\r\n*buf++ = '\"';\r\n*buf++ = '\0';\r\n}\r\nwmem_free(NULL, rep);\r\n}\r\nstatic int\r\nrelative_val_repr_len(fvalue_t *fv, ftrepr_t rtype _U_, int field_display _U_)\r\n{\r\ngchar *rep;\r\nint ret;\r\nrep = rel_time_to_secs_str(NULL, &fv->value.time);\r\nret = (int)strlen(rep);\r\nwmem_free(NULL, rep);\r\nreturn ret;\r\n}\r\nstatic void\r\nrelative_val_to_repr(fvalue_t *fv, ftrepr_t rtype _U_, int field_display _U_, char *buf, unsigned int size)\r\n{\r\ngchar *rep;\r\nrep = rel_time_to_secs_str(NULL, &fv->value.time);\r\ng_strlcpy(buf, rep, size);\r\nwmem_free(NULL, rep);\r\n}\r\nvoid\r\nftype_register_time(void)\r\n{\r\nstatic ftype_t abstime_type = {\r\nFT_ABSOLUTE_TIME,\r\n"FT_ABSOLUTE_TIME",\r\n"Date and time",\r\n0,\r\ntime_fvalue_new,\r\nNULL,\r\nabsolute_val_from_unparsed,\r\nabsolute_val_from_string,\r\nabsolute_val_to_repr,\r\nabsolute_val_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\ntime_fvalue_set,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nvalue_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\ncmp_eq,\r\ncmp_ne,\r\ncmp_gt,\r\ncmp_ge,\r\ncmp_lt,\r\ncmp_le,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL\r\n};\r\nstatic ftype_t reltime_type = {\r\nFT_RELATIVE_TIME,\r\n"FT_RELATIVE_TIME",\r\n"Time offset",\r\n0,\r\ntime_fvalue_new,\r\nNULL,\r\nrelative_val_from_unparsed,\r\nNULL,\r\nrelative_val_to_repr,\r\nrelative_val_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\ntime_fvalue_set,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nvalue_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\ncmp_eq,\r\ncmp_ne,\r\ncmp_gt,\r\ncmp_ge,\r\ncmp_lt,\r\ncmp_le,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL\r\n};\r\nftype_register(FT_ABSOLUTE_TIME, &abstime_type);\r\nftype_register(FT_RELATIVE_TIME, &reltime_type);\r\n}

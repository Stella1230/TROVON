static int\r\ndissect_aruba_adp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *ti = NULL;\r\nproto_tree *aruba_adp_tree = NULL;\r\nguint16 type;\r\nconst gchar *mac_str;\r\nconst gchar *switchip;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ADP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_aruba_adp, tvb, 0, 0, ENC_NA);\r\naruba_adp_tree = proto_item_add_subtree(ti, ett_aruba_adp);\r\n}\r\nproto_tree_add_item(aruba_adp_tree, hf_adp_version, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(aruba_adp_tree, hf_adp_type, tvb, 2, 2, ENC_BIG_ENDIAN);\r\ntype = tvb_get_ntohs(tvb, 2);\r\nproto_tree_add_item(aruba_adp_tree, hf_adp_id, tvb, 4, 2, ENC_BIG_ENDIAN);\r\nswitch(type){\r\ncase ADP_REQUEST:\r\nproto_tree_add_item(aruba_adp_tree, hf_adp_mac, tvb, 6, 6, ENC_NA);\r\nmac_str = tvb_ether_to_str(tvb, 6);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "ADP Request Src MAC: %s", mac_str);\r\nproto_item_append_text(ti, ", Request Src MAC: %s", mac_str);\r\nbreak;\r\ncase ADP_RESPONSE:\r\nproto_tree_add_item(aruba_adp_tree, hf_adp_switchip, tvb, 6, 4, ENC_BIG_ENDIAN);\r\nswitchip = tvb_ip_to_str(tvb, 6);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "ADP Response Switch IP: %s", switchip);\r\nproto_item_append_text(ti, ", Response Switch IP: %s", switchip);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_aruba_adp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_adp_version,\r\n{ "Version", "adp.version", FT_UINT16, BASE_DEC, NULL,0x0,\r\n"ADP version", HFILL}},\r\n{ &hf_adp_type,\r\n{ "Type", "adp.type", FT_UINT16, BASE_DEC, VALS(adp_type_val), 0x0,\r\n"ADP type", HFILL}},\r\n{ &hf_adp_id,\r\n{ "Transaction ID", "adp.id", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"ADP transaction ID", HFILL}},\r\n{ &hf_adp_mac,\r\n{ "MAC address", "adp.mac", FT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_adp_switchip,\r\n{ "Switch IP", "adp.switch", FT_IPv4, BASE_NONE, NULL, 0x0,\r\n"Switch IP address", HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_aruba_adp,\r\n};\r\nproto_aruba_adp = proto_register_protocol("Aruba Discovery Protocol",\r\n"ADP", "adp");\r\nproto_register_field_array(proto_aruba_adp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_aruba_adp(void)\r\n{\r\ndissector_handle_t adp_handle;\r\nadp_handle = create_dissector_handle(dissect_aruba_adp, proto_aruba_adp);\r\ndissector_add_uint("udp.port", UDP_PORT_ADP, adp_handle);\r\n}

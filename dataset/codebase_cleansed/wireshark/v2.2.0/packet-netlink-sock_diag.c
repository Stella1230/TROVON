static int\r\n_tvb_check_if_zeros(tvbuff_t *tvb, int offset, int len)\r\n{\r\nwhile (len >= 0) {\r\nif (tvb_get_guint8(tvb, offset) != 0)\r\nreturn 1;\r\noffset++;\r\nlen--;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\n_dissect_padding(proto_tree *tree _U_, tvbuff_t *tvb, int offset, int len)\r\n{\r\nif (_tvb_check_if_zeros(tvb, offset, len)) {\r\n}\r\n}\r\nstatic int\r\ndissect_sock_diag_meminfo(proto_tree *tree, netlink_sock_diag_info_t *info, tvbuff_t *tvb, int offset, int len)\r\n{\r\nstatic header_field_info *hfis[] = {\r\n&hfi_netlink_sock_diag_rmem_alloc,\r\n&hfi_netlink_sock_diag_rcvbuf,\r\n&hfi_netlink_sock_diag_wmem_alloc,\r\n&hfi_netlink_sock_diag_sndbuf,\r\n&hfi_netlink_sock_diag_fwd_alloc,\r\n&hfi_netlink_sock_diag_wmem_queued,\r\n};\r\nguint i;\r\nif (len == 0 || (len % 4) != 0)\r\nreturn 0;\r\nfor (i = 0; len >= 4 && i < G_N_ELEMENTS(hfis); i++) {\r\nproto_tree_add_item(tree, hfis[i], tvb, offset, 4, info->encoding);\r\noffset += 4; len -= 4;\r\n}\r\nif (len != 0) {\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nsock_diag_proto_tree_add_cookie(proto_tree *tree, netlink_sock_diag_info_t *info _U_, tvbuff_t *tvb, int offset)\r\n{\r\nguint64 cookie;\r\ncookie = tvb_get_letohl(tvb, offset + 4);\r\ncookie <<= 32;\r\ncookie |= tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint64(tree, hfi_netlink_sock_diag_cookie.id, tvb, offset, 8, cookie);\r\n}\r\nstatic void\r\nsock_diag_proto_tree_add_shutdown(proto_tree *tree, tvbuff_t *tvb, int offset)\r\n{\r\nguint8 how = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_shutdown, tvb, offset, 1, ENC_NA);\r\nproto_item_append_text(tree, ": %s", val_to_str(how, netlink_sock_diag_shutdown_flags_vals, "Invalid how value (%x)"));\r\n}\r\nstatic int\r\ndissect_netlink_unix_sock_diag_reply_attrs(tvbuff_t *tvb, void *data, proto_tree *tree, int nla_type, int offset, int len)\r\n{\r\nenum ws_unix_diag_attr_type type = (enum ws_unix_diag_attr_type) nla_type;\r\nnetlink_sock_diag_info_t *info = (netlink_sock_diag_info_t *) data;\r\nswitch (type) {\r\ncase WS_UNIX_DIAG_NAME:\r\n{\r\nconst char *name;\r\nif (len > 0 && tvb_get_guint8(tvb, offset) == '\0') {\r\nname = wmem_strconcat(wmem_packet_scope(),\r\n"@",\r\ntvb_get_string_enc(wmem_packet_scope(), tvb, offset+1, len-1, ENC_ASCII | ENC_NA),\r\nNULL);\r\n} else\r\nname = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, len, ENC_ASCII | ENC_NA);\r\nproto_item_append_text(tree, ": %s", name);\r\nproto_tree_add_string(tree, &hfi_netlink_sock_diag_unix_name, tvb, offset, len, name);\r\nreturn 1;\r\n}\r\ncase WS_UNIX_DIAG_PEER:\r\nif (len == 4) {\r\nproto_item_append_text(tree, ": Peer inode %u", tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_unix_peer_inode, tvb, offset, 4, info->encoding);\r\nreturn 1;\r\n}\r\nreturn 0;\r\ncase WS_UNIX_DIAG_RQLEN:\r\nif (len == 8) {\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_rqueue, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_wqueue, tvb, offset, 4, info->encoding);\r\nreturn 1;\r\n}\r\nreturn 0;\r\ncase WS_UNIX_DIAG_MEMINFO:\r\nreturn dissect_sock_diag_meminfo(tree, info, tvb, offset, len);\r\ncase WS_UNIX_DIAG_SHUTDOWN:\r\nif (len == 1)\r\nsock_diag_proto_tree_add_shutdown(tree, tvb, offset);\r\nreturn 0;\r\ncase WS_UNIX_DIAG_VFS:\r\ncase WS_UNIX_DIAG_ICONS:\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\ndissect_sock_diag_unix_reply(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_type, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_state, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\n_dissect_padding(tree, tvb, offset, 1);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn dissect_netlink_attributes(tvb, &hfi_netlink_sock_diag_unix_attr, ett_netlink_sock_diag_attr, info, tree, offset, dissect_netlink_unix_sock_diag_reply_attrs);\r\n}\r\nstatic int\r\ndissect_sock_diag_unix_request_show(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_item *ti;\r\nproto_tree *flags_tree;\r\nti = proto_tree_add_item(tree, &hfi_netlink_sock_diag_unix_show, tvb, offset, 4, info->encoding);\r\nflags_tree = proto_item_add_subtree(ti, ett_netlink_sock_diag_show);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_unix_show_name, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_unix_show_vfs, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_unix_show_peer, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_unix_show_icons, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_unix_show_rqlen, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_unix_show_meminfo, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_unix_request(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\noffset += 1;\r\n_dissect_padding(tree, tvb, offset, 2);\r\noffset += 2;\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\noffset = dissect_sock_diag_unix_request_show(tvb, info, tree, offset);\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_inet_attributes(tvbuff_t *tvb, void *data, proto_tree *tree, int nla_type, int offset, int len)\r\n{\r\nenum ws_inet_diag_attr_type type = (enum ws_inet_diag_attr_type) nla_type;\r\nnetlink_sock_diag_info_t *info = (netlink_sock_diag_info_t *) data;\r\nswitch (type) {\r\ncase WS_INET_DIAG_MEMINFO:\r\nif (len == 16) {\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_rmem_alloc, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_wmem_queued, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_fwd_alloc, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_wmem_alloc, tvb, offset, 4, info->encoding);\r\nreturn 1;\r\n}\r\nreturn 0;\r\ncase WS_INET_DIAG_SKMEMINFO:\r\nreturn dissect_sock_diag_meminfo(tree, info, tvb, offset, len);\r\ncase WS_INET_DIAG_SHUTDOWN:\r\nif (len == 1)\r\nsock_diag_proto_tree_add_shutdown(tree, tvb, offset);\r\nreturn 0;\r\ncase WS_INET_DIAG_INFO:\r\ncase WS_INET_DIAG_VEGASINFO:\r\ncase WS_INET_DIAG_CONG:\r\ncase WS_INET_DIAG_TOS:\r\ncase WS_INET_DIAG_TCLASS:\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\ndissect_sock_diag_inet_sockid(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset, int family)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_sport, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_dport, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nswitch (family) {\r\ncase LINUX_AF_INET:\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_src_ip4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n_dissect_padding(tree, tvb, offset, 12);\r\noffset += 12;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_dst_ip4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n_dissect_padding(tree, tvb, offset, 12);\r\noffset += 12;\r\nbreak;\r\ncase LINUX_AF_INET6:\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_src_ip6, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_dst_ip6, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ndefault:\r\nDISSECTOR_ASSERT_NOT_REACHED();\r\nbreak;\r\n}\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_interface, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_inet_reply(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nguint8 af_family;\r\naf_family = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_state, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\noffset += 2;\r\noffset = dissect_sock_diag_inet_sockid(tvb, info, tree, offset, af_family);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_rqueue, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_wqueue, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nreturn dissect_netlink_attributes(tvb, &hfi_netlink_sock_diag_inet_attr, ett_netlink_sock_diag_attr, info, tree, offset, dissect_sock_diag_inet_attributes);\r\n}\r\nstatic int\r\ndissect_sock_diag_inet_request(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nguint8 af_family;\r\naf_family = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inet_proto, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\noffset += 1;\r\n_dissect_padding(tree, tvb, offset, 1);\r\noffset += 1;\r\noffset += 4;\r\noffset = dissect_sock_diag_inet_sockid(tvb, info, tree, offset, af_family);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_netlink_attributes(tvbuff_t *tvb, void *data, proto_tree *tree, int nla_type, int offset, int len)\r\n{\r\nenum ws_netlink_diag_attr_type type = (enum ws_netlink_diag_attr_type) nla_type;\r\nnetlink_sock_diag_info_t *info = (netlink_sock_diag_info_t *) data;\r\nswitch (type) {\r\ncase WS_NETLINK_DIAG_MEMINFO:\r\nreturn dissect_sock_diag_meminfo(tree, info, tvb, offset, len);\r\ncase WS_NETLINK_DIAG_GROUPS:\r\ncase WS_NETLINK_DIAG_RX_RING:\r\ncase WS_NETLINK_DIAG_TX_RING:\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\ndissect_sock_diag_netlink_reply(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_type, tvb, offset, 1, ENC_NA);\r\nswitch (tvb_get_guint8(tvb, offset)) {\r\ncase WS_SOCK_DGRAM:\r\ncase WS_SOCK_RAW:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_netlink_proto, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_state, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_netlink_port_id, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_netlink_dst_port_id, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn dissect_netlink_attributes(tvb, &hfi_netlink_sock_diag_netlink_attr, ett_netlink_sock_diag_attr, info, tree, offset, dissect_sock_diag_netlink_attributes);\r\n}\r\nstatic int\r\ndissect_sock_diag_netlink_request_show(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_item *ti;\r\nproto_tree *flags_tree;\r\nti = proto_tree_add_item(tree, &hfi_netlink_sock_diag_netlink_show, tvb, offset, 4, info->encoding);\r\nflags_tree = proto_item_add_subtree(ti, ett_netlink_sock_diag_show);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_netlink_show_meminfo, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_netlink_show_groups, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_netlink_show_ring_cfg, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_netlink_request(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_netlink_proto, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\n_dissect_padding(tree, tvb, offset, 2);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\noffset = dissect_sock_diag_netlink_request_show(tvb, info, tree, offset);\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_netlink_packet_sock_diag_reply_attrs(tvbuff_t *tvb, void *data, proto_tree *tree, int nla_type, int offset, int len)\r\n{\r\nenum ws_packet_diag_attr_type type = (enum ws_packet_diag_attr_type) nla_type;\r\nnetlink_sock_diag_info_t *info = (netlink_sock_diag_info_t *) data;\r\nswitch (type) {\r\ncase WS_PACKET_DIAG_MEMINFO:\r\nreturn dissect_sock_diag_meminfo(tree, info, tvb, offset, len);\r\ncase WS_PACKET_DIAG_INFO:\r\ncase WS_PACKET_DIAG_MCLIST:\r\ncase WS_PACKET_DIAG_RX_RING:\r\ncase WS_PACKET_DIAG_TX_RING:\r\ncase WS_PACKET_DIAG_FANOUT:\r\ncase WS_PACKET_DIAG_UID:\r\ncase WS_PACKET_DIAG_FILTER:\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int\r\ndissect_sock_diag_packet_reply(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_type, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_packet_proto, tvb, offset, 2, info->encoding);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn dissect_netlink_attributes(tvb, &hfi_netlink_sock_diag_packet_attr, ett_netlink_sock_diag_attr, info, tree, offset, dissect_netlink_packet_sock_diag_reply_attrs);\r\n}\r\nstatic int\r\ndissect_sock_diag_packet_request_show(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_item *ti;\r\nproto_tree *flags_tree;\r\nti = proto_tree_add_item(tree, &hfi_netlink_sock_diag_packet_show, tvb, offset, 4, info->encoding);\r\nflags_tree = proto_item_add_subtree(ti, ett_netlink_sock_diag_show);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_packet_show_info, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_packet_show_mclist, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_packet_show_ring_cfg, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_packet_show_fanout, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_packet_show_meminfo, tvb, offset, 4, info->encoding);\r\nproto_tree_add_item(flags_tree, &hfi_netlink_sock_diag_packet_show_filter, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_packet_request(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_family, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_packet_proto, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\n_dissect_padding(tree, tvb, offset, 2);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_netlink_sock_diag_inode, tvb, offset, 4, info->encoding);\r\noffset += 4;\r\noffset = dissect_sock_diag_packet_request_show(tvb, info, tree, offset);\r\nsock_diag_proto_tree_add_cookie(tree, info, tvb, offset);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_sock_diag_by_family(tvbuff_t *tvb, netlink_sock_diag_info_t *info, proto_tree *tree, int offset)\r\n{\r\nconst gboolean is_req = (info->pinfo->p2p_dir == P2P_DIR_SENT);\r\nguint8 af_family;\r\naf_family = tvb_get_guint8(tvb, offset);\r\nswitch (af_family) {\r\ncase LINUX_AF_LOCAL:\r\noffset = (is_req) ?\r\ndissect_sock_diag_unix_request(tvb, info, tree, offset) :\r\ndissect_sock_diag_unix_reply(tvb, info, tree, offset);\r\nbreak;\r\ncase LINUX_AF_INET:\r\ncase LINUX_AF_INET6:\r\noffset = (is_req) ?\r\ndissect_sock_diag_inet_request(tvb, info, tree, offset) :\r\ndissect_sock_diag_inet_reply(tvb, info, tree, offset);\r\nbreak;\r\ncase LINUX_AF_NETLINK:\r\noffset = (is_req) ?\r\ndissect_sock_diag_netlink_request(tvb, info, tree, offset) :\r\ndissect_sock_diag_netlink_reply(tvb, info, tree, offset);\r\nbreak;\r\ncase LINUX_AF_PACKET:\r\noffset = (is_req) ?\r\ndissect_sock_diag_packet_request(tvb, info, tree, offset) :\r\ndissect_sock_diag_packet_reply(tvb, info, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_netlink_sock_diag(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *_data)\r\n{\r\nstruct packet_netlink_data *data = NULL;\r\nnetlink_sock_diag_info_t info;\r\nint offset;\r\nif (_data) {\r\nif (((struct packet_netlink_data *) _data)->magic == PACKET_NETLINK_MAGIC)\r\ndata = (struct packet_netlink_data *) _data;\r\n}\r\nDISSECTOR_ASSERT(data);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Netlink sock diag");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item_set_text(tree, "Linux netlink sock diag message");\r\nproto_tree_add_uint(tree, &hfi_netlink_sock_diag_nltype, NULL, 0, 0, data->type);\r\n}\r\ninfo.encoding = data->encoding;\r\ninfo.pinfo = pinfo;\r\ninfo.data = data;\r\noffset = 0;\r\nswitch (data->type) {\r\ncase WS_TCPDIAG_GETSOCK:\r\ncase WS_DCCPDIAG_GETSOCK:\r\nbreak;\r\ncase WS_SOCK_DIAG_BY_FAMILY:\r\noffset = dissect_sock_diag_by_family(tvb, &info, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_netlink_sock_diag(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_netlink_sock_diag_nltype,\r\n&hfi_netlink_sock_diag_family,\r\n&hfi_netlink_sock_diag_type,\r\n&hfi_netlink_sock_diag_state,\r\n&hfi_netlink_sock_diag_inode,\r\n&hfi_netlink_sock_diag_rqueue,\r\n&hfi_netlink_sock_diag_wqueue,\r\n&hfi_netlink_sock_diag_shutdown,\r\n&hfi_netlink_sock_diag_cookie,\r\n&hfi_netlink_sock_diag_rmem_alloc,\r\n&hfi_netlink_sock_diag_rcvbuf,\r\n&hfi_netlink_sock_diag_wmem_alloc,\r\n&hfi_netlink_sock_diag_sndbuf,\r\n&hfi_netlink_sock_diag_fwd_alloc,\r\n&hfi_netlink_sock_diag_wmem_queued,\r\n&hfi_netlink_sock_diag_unix_show,\r\n&hfi_netlink_sock_diag_unix_show_name,\r\n&hfi_netlink_sock_diag_unix_show_vfs,\r\n&hfi_netlink_sock_diag_unix_show_peer,\r\n&hfi_netlink_sock_diag_unix_show_icons,\r\n&hfi_netlink_sock_diag_unix_show_rqlen,\r\n&hfi_netlink_sock_diag_unix_show_meminfo,\r\n&hfi_netlink_sock_diag_unix_attr,\r\n&hfi_netlink_sock_diag_unix_name,\r\n&hfi_netlink_sock_diag_unix_peer_inode,\r\n&hfi_netlink_sock_diag_inet_proto,\r\n&hfi_netlink_sock_diag_inet_attr,\r\n&hfi_netlink_sock_diag_inet_sport,\r\n&hfi_netlink_sock_diag_inet_dport,\r\n&hfi_netlink_sock_diag_inet_src_ip4,\r\n&hfi_netlink_sock_diag_inet_dst_ip4,\r\n&hfi_netlink_sock_diag_inet_src_ip6,\r\n&hfi_netlink_sock_diag_inet_dst_ip6,\r\n&hfi_netlink_sock_diag_inet_interface,\r\n&hfi_netlink_sock_diag_netlink_show,\r\n&hfi_netlink_sock_diag_netlink_show_meminfo,\r\n&hfi_netlink_sock_diag_netlink_show_groups,\r\n&hfi_netlink_sock_diag_netlink_show_ring_cfg,\r\n&hfi_netlink_sock_diag_netlink_proto,\r\n&hfi_netlink_sock_diag_netlink_attr,\r\n&hfi_netlink_sock_diag_netlink_port_id,\r\n&hfi_netlink_sock_diag_netlink_dst_port_id,\r\n&hfi_netlink_sock_diag_packet_show,\r\n&hfi_netlink_sock_diag_packet_show_info,\r\n&hfi_netlink_sock_diag_packet_show_mclist,\r\n&hfi_netlink_sock_diag_packet_show_ring_cfg,\r\n&hfi_netlink_sock_diag_packet_show_fanout,\r\n&hfi_netlink_sock_diag_packet_show_meminfo,\r\n&hfi_netlink_sock_diag_packet_show_filter,\r\n&hfi_netlink_sock_diag_packet_proto,\r\n&hfi_netlink_sock_diag_packet_attr\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_netlink_sock_diag,\r\n&ett_netlink_sock_diag_show,\r\n&ett_netlink_sock_diag_attr\r\n};\r\nint proto_netlink_sock_diag;\r\nproto_netlink_sock_diag = proto_register_protocol("Linux netlink sock diag protocol", "sock_diag", "netlink-sock_diag" );\r\nhfi_netlink_sock_diag = proto_registrar_get_nth(proto_netlink_sock_diag);\r\nproto_register_fields(proto_netlink_sock_diag, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nnetlink_sock_diag_handle = create_dissector_handle(dissect_netlink_sock_diag, proto_netlink_sock_diag);\r\n}\r\nvoid\r\nproto_reg_handoff_netlink_sock_diag(void)\r\n{\r\ndissector_add_uint("netlink.protocol", WS_NETLINK_SOCK_DIAG, netlink_sock_diag_handle);\r\n}

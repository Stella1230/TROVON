static void\r\nsndcp_defragment_init(void)\r\n{\r\nreassembly_table_init(&npdu_reassembly_table, &addresses_reassembly_table_functions);\r\n}\r\nstatic void\r\nsndcp_defragment_cleanup(void)\r\n{\r\nreassembly_table_destroy(&npdu_reassembly_table);\r\n}\r\nstatic int\r\ndissect_sndcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 addr_field, comp_field, npdu_field1, dcomp=0, pcomp=0;\r\nguint16 offset=0, npdu=0, segment=0, npdu_field2;\r\ntvbuff_t *next_tvb, *npdu_tvb;\r\ngint len;\r\ngboolean first, more_frags, unack;\r\nstatic const int * addr_fields[] = {\r\n&hf_sndcp_x,\r\n&hf_sndcp_f,\r\n&hf_sndcp_t,\r\n&hf_sndcp_m,\r\n&hf_sndcp_nsapib,\r\nNULL\r\n};\r\nproto_item *ti;\r\nproto_tree *sndcp_tree, *compression_field_tree, *npdu_field_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SNDCP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_sndcp, tvb, 0, -1, ENC_NA);\r\nsndcp_tree = proto_item_add_subtree(ti, ett_sndcp);\r\naddr_field = tvb_get_guint8(tvb,offset);\r\nfirst = addr_field & MASK_F;\r\nmore_frags = addr_field & MASK_M;\r\nunack = addr_field & MASK_T;\r\nproto_tree_add_bitmask_with_flags(sndcp_tree, tvb, offset, hf_sndcp_nsapi,\r\nett_sndcp_address_field, addr_fields, ENC_NA, BMT_NO_APPEND);\r\noffset++;\r\nif (first) {\r\ncomp_field = tvb_get_guint8(tvb,offset);\r\ndcomp = comp_field & 0xF0;\r\npcomp = comp_field & 0x0F;\r\nif (tree) {\r\nif (!pcomp) {\r\nif (!dcomp) {\r\ncompression_field_tree = proto_tree_add_subtree(sndcp_tree, tvb, offset, 1, ett_sndcp_compression_field, NULL, "No compression");\r\n}\r\nelse {\r\ncompression_field_tree = proto_tree_add_subtree(sndcp_tree, tvb, offset, 1, ett_sndcp_compression_field, NULL, "Data compression");\r\n}\r\n}\r\nelse {\r\nif (!dcomp) {\r\ncompression_field_tree = proto_tree_add_subtree(sndcp_tree, tvb, offset, 1, ett_sndcp_compression_field, NULL, "Protocol compression");\r\n}\r\nelse {\r\ncompression_field_tree = proto_tree_add_subtree(sndcp_tree, tvb, offset, 1, ett_sndcp_compression_field, NULL, "Data and Protocol compression");\r\n}\r\n}\r\nproto_tree_add_uint(compression_field_tree, hf_sndcp_dcomp, tvb, offset, 1, comp_field );\r\nproto_tree_add_uint(compression_field_tree, hf_sndcp_pcomp, tvb, offset, 1, comp_field );\r\n}\r\noffset++;\r\nif (!unack) {\r\nnpdu = npdu_field1 = tvb_get_guint8(tvb,offset);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "SN-DATA N-PDU %d", npdu_field1);\r\nif (tree) {\r\nnpdu_field_tree = proto_tree_add_subtree_format(sndcp_tree, tvb, offset, 1, ett_sndcp_npdu_field, NULL, "Acknowledged mode, N-PDU %d", npdu_field1 );\r\nproto_tree_add_uint(npdu_field_tree, hf_sndcp_npdu1, tvb, offset, 1, npdu_field1 );\r\n}\r\noffset++;\r\n}\r\n}\r\nif (unack) {\r\nnpdu_field2 = tvb_get_ntohs(tvb, offset);\r\nsegment = (npdu_field2 & 0xF000) >> 12;\r\nnpdu = (npdu_field2 & 0x0FFF);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "SN-UNITDATA N-PDU %d (segment %d)", npdu, segment);\r\nif (tree) {\r\nnpdu_field_tree = proto_tree_add_subtree_format(sndcp_tree, tvb, offset, 2, ett_sndcp_npdu_field, NULL,\r\n"Unacknowledged mode, N-PDU %d (segment %d)", npdu, segment );\r\nproto_tree_add_uint(npdu_field_tree, hf_sndcp_segment, tvb, offset, 2, npdu_field2 );\r\nproto_tree_add_uint(npdu_field_tree, hf_sndcp_npdu2, tvb, offset, 2, npdu_field2 );\r\n}\r\noffset += 2;\r\n}\r\nif (first && !more_frags) {\r\nnext_tvb = tvb_new_subset_remaining (tvb, offset);\r\nif (!dcomp && !pcomp) {\r\ncall_dissector(ip_handle, next_tvb, pinfo, tree);\r\n}\r\nelse {\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nelse {\r\nfragment_head *fd_npdu = NULL;\r\nguint32 reassembled_in = 0;\r\ngboolean save_fragmented = pinfo->fragmented;\r\nlen = tvb_captured_length_remaining(tvb, offset);\r\nif(len<=0){\r\nreturn offset;\r\n}\r\npinfo->fragmented = TRUE;\r\nif (unack)\r\nfd_npdu = fragment_add_seq_check(&npdu_reassembly_table, tvb, offset,\r\npinfo, npdu, NULL, segment, len, more_frags);\r\nelse\r\nfd_npdu = fragment_add(&npdu_reassembly_table, tvb, offset, pinfo, npdu, NULL,\r\noffset, len, more_frags);\r\nnpdu_tvb = process_reassembled_data(tvb, offset, pinfo,\r\n"Reassembled N-PDU", fd_npdu, &npdu_frag_items,\r\nNULL, sndcp_tree);\r\nif (fd_npdu) {\r\nreassembled_in = fd_npdu->reassembled_in;\r\nif (pinfo->num == reassembled_in) {\r\ncall_dissector(ip_handle, npdu_tvb, pinfo, tree);\r\n}\r\nelse {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n" (N-PDU payload reassembled in packet %u)",\r\nfd_npdu->reassembled_in);\r\nproto_tree_add_item(sndcp_tree, hf_sndcp_payload, tvb, offset, -1, ENC_NA);\r\n}\r\n} else {\r\nif (unack)\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " (Unreassembled fragment %u)", segment);\r\nelse\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (Unreassembled fragment)");\r\nproto_tree_add_item(sndcp_tree, hf_sndcp_payload, tvb, offset, -1, ENC_NA);\r\n}\r\npinfo->fragmented = save_fragmented;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_sndcp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sndcp_nsapi,\r\n{ "Address field NSAPI",\r\n"sndcp.nsapi",\r\nFT_UINT8, BASE_DEC, VALS(nsapi_abrv), 0x0,\r\n"Network Layer Service Access Point Identifier", HFILL\r\n}\r\n},\r\n{ &hf_sndcp_x,\r\n{ "Spare bit",\r\n"sndcp.x",\r\nFT_BOOLEAN,8, TFS(&x_bit), MASK_X,\r\n"Spare bit (should be 0)", HFILL\r\n}\r\n},\r\n{ &hf_sndcp_f,\r\n{ "First segment indicator bit",\r\n"sndcp.f",\r\nFT_BOOLEAN,8, TFS(&f_bit), MASK_F,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_sndcp_t,\r\n{ "Type",\r\n"sndcp.t",\r\nFT_BOOLEAN,8, TFS(&t_bit), MASK_T,\r\n"SN-PDU Type", HFILL\r\n}\r\n},\r\n{ &hf_sndcp_m,\r\n{ "More bit",\r\n"sndcp.m",\r\nFT_BOOLEAN,8, TFS(&m_bit), MASK_M,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_sndcp_dcomp,\r\n{ "DCOMP",\r\n"sndcp.dcomp",\r\nFT_UINT8, BASE_DEC, VALS(compression_vals), 0xF0,\r\n"Data compression coding", HFILL\r\n}\r\n},\r\n{ &hf_sndcp_pcomp,\r\n{ "PCOMP",\r\n"sndcp.pcomp",\r\nFT_UINT8, BASE_DEC, VALS(compression_vals), 0x0F,\r\n"Protocol compression coding", HFILL\r\n}\r\n},\r\n{ &hf_sndcp_nsapib,\r\n{ "NSAPI",\r\n"sndcp.nsapib",\r\nFT_UINT8, BASE_DEC , VALS(nsapi_t), 0xf,\r\n"Network Layer Service Access Point Identifier",HFILL\r\n}\r\n},\r\n{ &hf_sndcp_segment,\r\n{ "Segment",\r\n"sndcp.segment",\r\nFT_UINT16, BASE_DEC, NULL, 0xF000,\r\n"Segment number", HFILL\r\n}\r\n},\r\n{ &hf_sndcp_npdu1,\r\n{ "N-PDU",\r\n"sndcp.npdu",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_sndcp_npdu2,\r\n{ "N-PDU",\r\n"sndcp.npdu",\r\nFT_UINT16, BASE_DEC, NULL, 0x0FFF,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_sndcp_payload,\r\n{ "Payload",\r\n"sndcp.payload",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment_overlap,\r\n{ "Fragment overlap",\r\n"sndcp.npdu.fragment.overlap",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"Fragment overlaps with other fragments", HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment_overlap_conflict,\r\n{ "Conflicting data in fragment overlap",\r\n"sndcp.npdu.fragment.overlap.conflict",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"Overlapping fragments contained conflicting data", HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment_multiple_tails,\r\n{ "Multiple tail fragments found",\r\n"sndcp.npdu.fragment.multipletails",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"Several tails were found when defragmenting the packet", HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment_too_long_fragment,\r\n{ "Fragment too long",\r\n"sndcp.npdu.fragment.toolongfragment",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"Fragment contained data past end of packet", HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment_error,\r\n{ "Defragmentation error",\r\n"sndcp.npdu.fragment.error",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"Defragmentation error due to illegal fragments", HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment_count,\r\n{ "Fragment count",\r\n"sndcp.npdu.fragment.count",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_npdu_reassembled_in,\r\n{ "Reassembled in",\r\n"sndcp.npdu.reassembled.in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"N-PDU fragments are reassembled in the given packet", HFILL\r\n}\r\n},\r\n{ &hf_npdu_reassembled_length,\r\n{ "Reassembled N-PDU length",\r\n"sndcp.npdu.reassembled.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"The total length of the reassembled payload", HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragment,\r\n{ "N-PDU Fragment",\r\n"sndcp.npdu.fragment",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_npdu_fragments,\r\n{ "N-PDU Fragments",\r\n"sndcp.npdu.fragments",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_sndcp ,\r\n&ett_sndcp_address_field,\r\n&ett_sndcp_compression_field,\r\n&ett_sndcp_npdu_field,\r\n&ett_npdu_fragment,\r\n&ett_npdu_fragments,\r\n};\r\nproto_sndcp = proto_register_protocol("Subnetwork Dependent Convergence Protocol",\r\n"SNDCP", "sndcp");\r\nproto_register_field_array(proto_sndcp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("sndcp", dissect_sndcp, proto_sndcp);\r\nregister_init_routine(sndcp_defragment_init);\r\nregister_cleanup_routine(sndcp_defragment_cleanup);\r\n}\r\nvoid\r\nproto_reg_handoff_sndcp(void)\r\n{\r\ndissector_handle_t sndcp_handle;\r\nsndcp_handle = find_dissector("sndcp");\r\ndissector_add_uint("llcgprs.sapi", 3, sndcp_handle);\r\ndissector_add_uint("llcgprs.sapi", 5, sndcp_handle);\r\ndissector_add_uint("llcgprs.sapi", 9, sndcp_handle);\r\ndissector_add_uint("llcgprs.sapi", 11, sndcp_handle);\r\nip_handle = find_dissector_add_dependency("ip", proto_sndcp);\r\n}

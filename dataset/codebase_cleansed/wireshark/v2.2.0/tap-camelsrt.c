static void camelsrt_reset(void *phs)\r\n{\r\nstruct camelsrt_t *hs = (struct camelsrt_t *)phs;\r\nmemset(hs, 0, sizeof(struct camelsrt_t));\r\n}\r\nstatic int camelsrt_packet(void *phs,\r\npacket_info *pinfo _U_,\r\nepan_dissect_t *edt _U_,\r\nconst void *phi)\r\n{\r\nstruct camelsrt_t *hs = (struct camelsrt_t *)phs;\r\nconst struct camelsrt_info_t * pi = (const struct camelsrt_info_t *)phi;\r\nint i;\r\nfor (i=0; i<NB_CAMELSRT_CATEGORY; i++) {\r\nif (pi->bool_msginfo[i] &&\r\npi->msginfo[i].is_delta_time\r\n&& pi->msginfo[i].request_available\r\n&& !pi->msginfo[i].is_duplicate ) {\r\ntime_stat_update(&(hs->stats[i]),\r\n&(pi->msginfo[i].delta_time),\r\npinfo);\r\nif (hs->count[i] < NUM_RAS_STATS) {\r\nhs->delta_time[i][hs->count[i]++]\r\n= pi->msginfo[i].delta_time;\r\n}\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic void camelsrt_draw(void *phs)\r\n{\r\nstruct camelsrt_t *hs = (struct camelsrt_t *)phs;\r\nguint j, z;\r\nguint32 li;\r\nint somme, iteration = 0;\r\ntimestat_t *rtd_temp;\r\ndouble x, delay, delay_max, delay_min, delta;\r\ndouble criteria[NB_CRITERIA] = { 5.0, 10.0, 75.0, 90.0, 95.0, 99.0, 99.90 };\r\ndouble delay_criteria[NB_CRITERIA];\r\ngchar* tmp_str;\r\nprintf("\n");\r\nprintf("Camel Service Response Time (SRT) Statistics:\n");\r\nprintf("=================================================================================================\n");\r\nprintf("| Category | Measure | Min SRT | Max SRT | Avg SRT | Min frame | Max frame |\n");\r\nprintf("|-------------------------|---------|-----------|-----------|-----------|-----------|-----------|\n");\r\nj = 1;\r\ntmp_str = val_to_str_wmem(NULL, j, camelSRTtype_naming, "Unknown Message 0x%02x");\r\nprintf("|%24s |%8u |%8.2f s |%8.2f s |%8.2f s |%10u |%10u |\n",\r\ntmp_str,\r\nhs->stats[j].num,\r\nnstime_to_sec(&(hs->stats[j].min)),\r\nnstime_to_sec(&(hs->stats[j].max)),\r\nget_average(&(hs->stats[j].tot), hs->stats[j].num)/1000.0,\r\nhs->stats[j].min_num,\r\nhs->stats[j].max_num\r\n);\r\nwmem_free(NULL, tmp_str);\r\nfor (j=2; j<NB_CAMELSRT_CATEGORY; j++) {\r\nif (hs->stats[j].num == 0) {\r\ntmp_str = val_to_str_wmem(NULL, j, camelSRTtype_naming, "Unknown Message 0x%02x");\r\nprintf("|%24s |%8u |%8.2f ms|%8.2f ms|%8.2f ms|%10u |%10u |\n",\r\ntmp_str, 0U, 0.0, 0.0, 0.0, 0U, 0U);\r\nwmem_free(NULL, tmp_str);\r\ncontinue;\r\n}\r\ntmp_str = val_to_str_wmem(NULL, j, camelSRTtype_naming, "Unknown Message 0x%02x");\r\nprintf("|%24s |%8u |%8.2f ms|%8.2f ms|%8.2f ms|%10u |%10u |\n",\r\ntmp_str,\r\nhs->stats[j].num,\r\nMIN(9999, nstime_to_msec(&(hs->stats[j].min))),\r\nMIN(9999, nstime_to_msec(&(hs->stats[j].max))),\r\nMIN(9999, get_average(&(hs->stats[j].tot), hs->stats[j].num)),\r\nhs->stats[j].min_num,\r\nhs->stats[j].max_num\r\n);\r\nwmem_free(NULL, tmp_str);\r\n}\r\nprintf("=================================================================================================\n");\r\nprintf("| Category/Criteria |");\r\nfor (z=0; z<NB_CRITERIA; z++) printf("%7.2f%% |", criteria[z]);\r\nprintf("\n");\r\nprintf("|-------------------------|");\r\nfor (z=0; z<NB_CRITERIA; z++) printf("---------|");\r\nprintf("\n");\r\nfor (j=2; j<NB_CAMELSRT_CATEGORY;j++) {\r\nrtd_temp = &(hs->stats[j]);\r\nif (hs->count[j] > 0) {\r\nfor (z=0; z<NB_CRITERIA; z++) {\r\niteration = 0;\r\ndelay_max = (double)rtd_temp->max.secs*1000 +(double)rtd_temp->max.nsecs/1000000;\r\ndelay_min = (double)rtd_temp->min.secs*1000 +(double)rtd_temp->min.nsecs/1000000;\r\ndelay = delay_min;\r\ndelta = delay_max-delay_min;\r\nwhile ( (delta > 0.001) && (iteration < 10000) ) {\r\nsomme = 0;\r\niteration++;\r\nfor (li=0; li<hs->count[j]; li++) {\r\nx = hs->delta_time[j][li].secs*1000\r\n+ (double)hs->delta_time[j][li].nsecs/1000000;\r\nif (x <= delay) somme++;\r\n}\r\nif ( somme*100 > hs->count[j]*criteria[z] ) {\r\ndelay_max = delay;\r\ndelay = (delay_max+delay_min)/2;\r\ndelta = delay_max-delay_min;\r\n} else {\r\ndelay_min = delay;\r\ndelay = (delay_max+delay_min)/2;\r\ndelta = delay_max-delay_min;\r\n}\r\n}\r\ndelay_criteria[z] = delay;\r\n}\r\ntmp_str = val_to_str_wmem(NULL, j, camelSRTtype_naming, "Unknown Message 0x%02x");\r\nprintf("X%24s |", tmp_str);\r\nwmem_free(NULL, tmp_str);\r\nfor (z=0; z<NB_CRITERIA; z++) printf("%8.2f |", MIN(9999, delay_criteria[z]));\r\nprintf("\n");\r\n} else {\r\ntmp_str = val_to_str_wmem(NULL, j, camelSRTtype_naming, "Unknown Message 0x%02x");\r\nprintf("X%24s |", tmp_str);\r\nwmem_free(NULL, tmp_str);\r\nfor (z=0; z<NB_CRITERIA; z++) printf("%8.2f |", 0.0);\r\nprintf("\n");\r\n}\r\n}\r\nprintf("===========================");\r\nfor (z=0; z<NB_CRITERIA; z++) printf("==========");\r\nprintf("\n");\r\n}\r\nstatic void camelsrt_init(const char *opt_arg, void *userdata _U_)\r\n{\r\nstruct camelsrt_t *p_camelsrt;\r\nGString *error_string;\r\np_camelsrt = g_new(struct camelsrt_t, 1);\r\nif (!strncmp(opt_arg, "camel,srt,", 9)) {\r\np_camelsrt->filter = g_strdup(opt_arg+9);\r\n} else {\r\np_camelsrt->filter = NULL;\r\n}\r\ncamelsrt_reset(p_camelsrt);\r\nerror_string = register_tap_listener("CAMEL",\r\np_camelsrt,\r\np_camelsrt->filter,\r\n0,\r\nNULL,\r\ncamelsrt_packet,\r\ncamelsrt_draw);\r\nif (error_string) {\r\ng_free(p_camelsrt->filter);\r\ng_free(p_camelsrt);\r\nfprintf(stderr, "tshark: Couldn't register camel,srt tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\ngtcap_StatSRT = TRUE;\r\ngcamel_StatSRT = TRUE;\r\n}\r\nvoid\r\nregister_tap_listener_camelsrt(void)\r\n{\r\nregister_stat_tap_ui(&camelsrt_ui, NULL);\r\n}

static int\r\ndissect_brp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *brp_item = NULL;\r\nproto_tree *brp_tree = NULL;\r\ngint offset = 0;\r\nguint8 type = 0;\r\nguint8 packet_type = tvb_get_guint8(tvb, 0);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PROTO_TAG_BRP);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Message Type - %s",\r\nval_to_str(packet_type, brp_packettype_names, "Unknown (0x%02x)"));\r\nif (tree) {\r\nbrp_item = proto_tree_add_item( tree, proto_brp, tvb, 0, -1, ENC_NA );\r\nbrp_tree = proto_item_add_subtree( brp_item, ett_brp);\r\ntype = tvb_get_guint8(tvb, offset);\r\noffset += 0;\r\nbrp_item = proto_tree_add_item( brp_tree, hf_brp_type, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset += 1;\r\nswitch(type)\r\n{\r\ncase 1:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_ver, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_stat, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nbreak;\r\ncase 5:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nbreak;\r\ncase 7:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_srcip, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_dstip, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_dstuport, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset +=2;\r\nproto_tree_add_item( brp_tree, hf_brp_mbz, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset +=2;\r\nproto_tree_add_item( brp_tree, hf_brp_bw, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_life, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 8:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_stat, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 9:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 10:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_stat, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 11:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 12:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_stat, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_rmttl, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_srcip, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_dstip, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_dstuport, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset +=2;\r\nproto_tree_add_item( brp_tree, hf_brp_mbz, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset +=2;\r\nproto_tree_add_item( brp_tree, hf_brp_fltype, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset +=1;\r\nproto_tree_add_item( brp_tree, hf_brp_bw, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset +=3;\r\nproto_tree_add_item( brp_tree, hf_brp_life, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 13:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 14:\r\nproto_tree_add_item( brp_tree, hf_brp_trans, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( brp_tree, hf_brp_stat, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_rmttl, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_srcip, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_dstip, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_dstuport, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset +=2;\r\nproto_tree_add_item( brp_tree, hf_brp_mbz, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset +=2;\r\nproto_tree_add_item( brp_tree, hf_brp_fltype, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset +=1;\r\nproto_tree_add_item( brp_tree, hf_brp_bw, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset +=3;\r\nproto_tree_add_item( brp_tree, hf_brp_life, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ncase 15:\r\nproto_tree_add_item( brp_tree, hf_brp_mbz, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset +=3;\r\nproto_tree_add_item( brp_tree, hf_brp_flid, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset +=4;\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, brp_item, &ei_brp_type_unknown);\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nvoid proto_register_brp (void)\r\n{\r\nmodule_t *brp_module;\r\nexpert_module_t* expert_brp;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_brp_type,\r\n{ "Type", "brp.type", FT_UINT8, BASE_DEC, VALS(brp_packettype_names), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_trans,\r\n{ "Transaction ID", "brp.trans", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_ver,\r\n{ "Version", "brp.ver", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_stat,\r\n{ "Status", "brp.stat", FT_UINT8, BASE_DEC, VALS(brp_stat_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_srcip,\r\n{ "Source IP Address", "brp.srcip", FT_IPv4, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_dstip,\r\n{ "Destination IP Address", "brp.dstip", FT_IPv4, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_dstuport,\r\n{ "Destination UDP Port", "brp.dstuport", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_mbz,\r\n{ "MBZ", "brp.mbz", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_bw,\r\n{ "Bandwidth - Kbytes/sec", "brp.bw", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_life,\r\n{ "Lifetime", "brp.life", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_flid,\r\n{ "Flow Identifier", "brp.flid", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_fltype,\r\n{ "Flow Type", "brp.fltype", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_brp_rmttl,\r\n{ "Remaining TTL", "brp.rmttl", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_brp,\r\n&ett_brp_type,\r\n&ett_brp_trans,\r\n&ett_brp_ver,\r\n&ett_brp_stat,\r\n&ett_brp_srcip,\r\n&ett_brp_dstip,\r\n&ett_brp_dstuport,\r\n&ett_brp_mbz,\r\n&ett_brp_bw,\r\n&ett_brp_life,\r\n&ett_brp_flid,\r\n&ett_brp_fltype,\r\n&ett_brp_rmttl\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_brp_type_unknown, { "brp.type.unknown", PI_UNDECODED, PI_WARN, "Unknown packet type", EXPFILL }},\r\n};\r\nproto_brp = proto_register_protocol ("BRP Protocol", "BRP", "brp");\r\nproto_register_field_array (proto_brp, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\nexpert_brp = expert_register_protocol(proto_brp);\r\nexpert_register_field_array(expert_brp, ei, array_length(ei));\r\nbrp_module = prefs_register_protocol(proto_brp, proto_reg_handoff_brp);\r\nprefs_register_uint_preference(brp_module, "port",\r\n"BRP Port",\r\n"Set the UDP port for BRP messages",\r\n10, &global_brp_port);\r\nbrp_handle = register_dissector("brp", dissect_brp, proto_brp);\r\n}\r\nvoid proto_reg_handoff_brp(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic guint saved_brp_port;\r\nif (!initialized) {\r\ndissector_add_for_decode_as("udp.port", brp_handle);\r\ninitialized = TRUE;\r\n} else {\r\nif (saved_brp_port != 0) {\r\ndissector_delete_uint("udp.port", saved_brp_port, brp_handle);\r\n}\r\n}\r\nif (global_brp_port != 0) {\r\ndissector_add_uint("udp.port", global_brp_port, brp_handle);\r\n}\r\nsaved_brp_port = global_brp_port;\r\n}

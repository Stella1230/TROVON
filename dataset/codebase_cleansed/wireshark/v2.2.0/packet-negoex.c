static void\r\ndissect_negoex_alert_message(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree,\r\nguint32 start_off)\r\n{\r\nguint32 offset;\r\noffset = start_off;\r\nproto_tree_add_item(tree, hf_negoex_authscheme, tvb, offset, 16, ENC_LITTLE_ENDIAN);\r\noffset += 16;\r\nproto_tree_add_item(tree, hf_negoex_errorcode, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_bytes_format(tree, hf_negoex_data, tvb, offset, -1, NULL,\r\n"The rest of the alert message");\r\n}\r\nstatic void\r\ndissect_negoex_verify_message(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree,\r\nguint32 start_off)\r\n{\r\nguint32 offset;\r\nguint32 checksum_vector_offset;\r\nguint32 checksum_vector_count;\r\nproto_tree *checksum;\r\nproto_tree *checksum_vector;\r\noffset = start_off;\r\nproto_tree_add_item(tree, hf_negoex_authscheme, tvb, offset, 16, ENC_LITTLE_ENDIAN);\r\noffset += 16;\r\nchecksum = proto_tree_add_subtree(tree, tvb, offset, 20, ett_negoex_checksum, NULL, "Checksum");\r\nproto_tree_add_item(checksum, hf_negoex_header_len, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(checksum, hf_negoex_checksum_scheme, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(checksum, hf_negoex_checksum_type, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nchecksum_vector_offset = tvb_get_letohl(tvb, offset);\r\nchecksum_vector_count = tvb_get_letohs(tvb, offset + 4);\r\nchecksum_vector = proto_tree_add_subtree_format(checksum, tvb, offset, 8,\r\nett_negoex_checksum_vector, NULL, "Checksum Vector: %u at %u",\r\nchecksum_vector_count,\r\nchecksum_vector_offset);\r\nproto_tree_add_item(checksum_vector, hf_negoex_checksum_vector_offset, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(checksum_vector, hf_negoex_checksum_vector_count, tvb,\r\noffset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(checksum_vector, hf_negoex_checksum_vector_pad, tvb,\r\noffset, 2, ENC_NA);\r\nproto_tree_add_item(checksum_vector, hf_negoex_checksum, tvb,\r\nchecksum_vector_offset, checksum_vector_count, ENC_NA);\r\n}\r\nstatic void\r\ndissect_negoex_exchange_message(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree,\r\nguint32 start_off)\r\n{\r\nguint32 offset;\r\nguint32 exchange_vector_offset;\r\nguint32 exchange_vector_count;\r\nproto_tree *exchange_vector;\r\noffset = start_off;\r\nproto_tree_add_item(tree, hf_negoex_authscheme, tvb, offset, 16, ENC_LITTLE_ENDIAN);\r\noffset += 16;\r\nexchange_vector_offset = tvb_get_letohl(tvb, offset);\r\nexchange_vector_count = tvb_get_letohs(tvb, offset + 4);\r\nexchange_vector = proto_tree_add_subtree_format(tree, tvb, offset, 8,\r\nett_negoex_exchange, NULL, "Exchange: %u bytes at %u",\r\nexchange_vector_count, exchange_vector_offset);\r\nproto_tree_add_item(exchange_vector, hf_negoex_exchange_vector_offset, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(exchange_vector, hf_negoex_exchange_vector_count, tvb,\r\noffset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(exchange_vector, hf_negoex_exchange_vector_pad, tvb,\r\noffset, 2, ENC_NA);\r\nproto_tree_add_item(exchange_vector, hf_negoex_exchange, tvb,\r\nexchange_vector_offset, exchange_vector_count, ENC_NA);\r\n}\r\nstatic void\r\ndissect_negoex_nego_message(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree,\r\nguint32 start_off)\r\n{\r\nvolatile guint32 offset;\r\nguint32 authscheme_vector_offset;\r\nguint16 authscheme_vector_count;\r\nguint32 extension_vector_offset;\r\nguint32 extension_vector_count;\r\nproto_tree *authscheme_vector;\r\nproto_tree *extension_vector;\r\nguint32 i;\r\noffset = start_off;\r\nTRY {\r\nproto_tree_add_item(tree, hf_negoex_random, tvb, offset, 32, ENC_ASCII);\r\noffset += 32;\r\nproto_tree_add_item(tree, hf_negoex_proto_version, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nauthscheme_vector_offset = tvb_get_letohl(tvb, offset);\r\nauthscheme_vector_count = tvb_get_letohs(tvb, offset + 4);\r\nauthscheme_vector = proto_tree_add_subtree_format(tree, tvb, offset, 8,\r\nett_negoex_authscheme_vector, NULL, "AuthSchemes: %u at %u",\r\nauthscheme_vector_count, authscheme_vector_offset);\r\nproto_tree_add_item(authscheme_vector, hf_negoex_authscheme_vector_offset,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(authscheme_vector, hf_negoex_authscheme_vector_count,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(authscheme_vector, hf_negoex_authscheme_vector_pad,\r\ntvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nfor (i = 0; i < authscheme_vector_count; i++) {\r\nproto_tree_add_item(authscheme_vector, hf_negoex_authscheme, tvb,\r\nauthscheme_vector_offset + i * 16, 16, ENC_LITTLE_ENDIAN);\r\n}\r\nextension_vector_offset = tvb_get_letohl(tvb, offset);\r\nextension_vector_count = tvb_get_letohs(tvb, offset + 4);\r\nextension_vector = proto_tree_add_subtree_format(tree, tvb, offset, 8,\r\nett_negoex_extension_vector, NULL, "Extensions: %u at %u",\r\nextension_vector_count, extension_vector_count);\r\nproto_tree_add_item(extension_vector, hf_negoex_extension_vector_offset,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(extension_vector, hf_negoex_extension_vector_count,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(extension_vector, hf_negoex_extension_vector_pad,\r\ntvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nfor (i = 0; i < extension_vector_count; i++) {\r\nguint32 byte_vector_offset, byte_vector_count;\r\nproto_tree *bv_tree;\r\nbyte_vector_offset = tvb_get_letohl(tvb, offset);\r\nbyte_vector_count = tvb_get_letohs(tvb, offset + 4);\r\nbv_tree = proto_tree_add_subtree_format(extension_vector, tvb,\r\nextension_vector_offset + i * 8, 8,\r\nett_negoex_byte_vector, NULL, "Extension: %u bytes at %u",\r\nbyte_vector_count, byte_vector_offset);\r\nproto_tree_add_item(bv_tree, hf_negoex_extension, tvb,\r\nbyte_vector_offset, byte_vector_count, ENC_NA);\r\n}\r\n} ENDTRY;\r\n}\r\nstatic int\r\ndissect_negoex(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nvolatile guint32 offset;\r\nproto_tree * volatile negoex_tree;\r\nproto_item *tf;\r\nvolatile gboolean done;\r\nguint32 payload_len;\r\nguint32 message_len;\r\nguint32 message_type;\r\nguint32 header_len;\r\noffset = 0;\r\nnegoex_tree = NULL;\r\ntf = NULL;\r\ndone = FALSE;\r\npayload_len = tvb_reported_length(tvb);\r\nif (tree) {\r\ntf = proto_tree_add_item(tree, proto_negoex, tvb, offset, -1, ENC_NA);\r\nnegoex_tree = proto_item_add_subtree(tf, ett_negoex);\r\n}\r\nwhile (offset < payload_len && !done) {\r\nproto_tree *negoex_msg_tree;\r\nproto_tree *negoex_hdr_tree;\r\nproto_item *msg;\r\ntvbuff_t *msg_tvb;\r\nguint32 start_offset;\r\nstart_offset = offset;\r\nTRY {\r\nmessage_type = tvb_get_letohl(tvb, offset + 8);\r\nnegoex_msg_tree = proto_tree_add_subtree_format(negoex_tree, tvb, offset, -1,\r\nett_negoex_msg, &msg, "NEGOEX %s",\r\nval_to_str_const(message_type,\r\nnegoex_message_types,\r\n"Unknown NEGOEX message type"));\r\nnegoex_hdr_tree = proto_tree_add_subtree(negoex_msg_tree, tvb, offset, 40, ett_negoex_hdr, NULL, "Header");\r\nproto_tree_add_item(negoex_hdr_tree, hf_negoex_sig,\r\ntvb, offset, 8, ENC_ASCII | ENC_NA);\r\noffset += 8;\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, ", ", "%s",\r\nval_to_str_const(message_type,\r\nnegoex_message_types,\r\n"Unknown NEGOEX message type"));\r\nproto_tree_add_uint(negoex_hdr_tree, hf_negoex_message_type,\r\ntvb, offset, 4, message_type);\r\nif (message_type > MESSAGE_TYPE_MAX_MSG) {\r\noffset = payload_len;\r\ngoto bad_message;\r\n} else {\r\noffset += 4;\r\n}\r\nproto_tree_add_item(negoex_hdr_tree, hf_negoex_sequence_num,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nheader_len = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(negoex_hdr_tree, hf_negoex_header_len,\r\ntvb, offset, 4, header_len);\r\noffset += 4;\r\nmessage_len = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(negoex_hdr_tree, hf_negoex_message_len,\r\ntvb, offset, 4, message_len);\r\noffset += 4;\r\nproto_item_set_len(msg, message_len);\r\nproto_tree_add_item(negoex_hdr_tree, hf_negoex_conversation_id,\r\ntvb, offset, 16, ENC_LITTLE_ENDIAN);\r\noffset += 16;\r\nmsg_tvb = tvb_new_subset(tvb,\r\nstart_offset,\r\nMIN(message_len, tvb_captured_length(tvb)),\r\nmessage_len);\r\nswitch (message_type) {\r\ncase MESSAGE_TYPE_INITIATOR_NEGO:\r\ncase MESSAGE_TYPE_ACCEPTOR_NEGO:\r\ndissect_negoex_nego_message(msg_tvb,\r\npinfo,\r\nnegoex_msg_tree,\r\noffset - start_offset);\r\nbreak;\r\ncase MESSAGE_TYPE_INITIATOR_META_DATA:\r\ncase MESSAGE_TYPE_ACCEPTOR_META_DATA:\r\ncase MESSAGE_TYPE_CHALLENGE:\r\ncase MESSAGE_TYPE_AP_REQUEST:\r\ndissect_negoex_exchange_message(msg_tvb,\r\npinfo,\r\nnegoex_msg_tree,\r\noffset - start_offset);\r\nbreak;\r\ncase MESSAGE_TYPE_VERIFY:\r\ndissect_negoex_verify_message(msg_tvb,\r\npinfo,\r\nnegoex_msg_tree,\r\noffset - start_offset);\r\nbreak;\r\ncase MESSAGE_TYPE_ALERT:\r\ndissect_negoex_alert_message(msg_tvb,\r\npinfo,\r\nnegoex_msg_tree,\r\noffset - start_offset);\r\nbreak;\r\ndefault:\r\nproto_tree_add_bytes_format(negoex_msg_tree, hf_negoex_data, tvb, offset, message_len - 40, NULL,\r\n"The rest of the message");\r\n}\r\noffset = start_offset + message_len;\r\nbad_message:\r\n;\r\n} CATCH_NONFATAL_ERRORS {\r\ndone = TRUE;\r\nshow_exception(tvb, pinfo, tree, EXCEPT_CODE, GET_MESSAGE);\r\n} ENDTRY;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_negoex(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_negoex_sig,\r\n{ "Signature", "negoex.message.sig", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_message_type,\r\n{ "MessageType", "negoex.message.type", FT_UINT32, BASE_HEX,\r\nVALS(negoex_message_types), 0x00, NULL, HFILL }},\r\n{ &hf_negoex_sequence_num,\r\n{ "SequencNum", "negoex.message.seq_num", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_header_len,\r\n{ "cbHeaderLength", "negoex.header.len", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_message_len,\r\n{ "cbMessageLength", "negoex.message.len", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_conversation_id,\r\n{ "ConversationID", "negoex.message.conv_id", FT_GUID, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_random,\r\n{ "Random", "negoex.message.random", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, "Random data", HFILL }},\r\n{ &hf_negoex_proto_version,\r\n{ "ProtocolVersion", "negoex.proto_version", FT_UINT64, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_authscheme,\r\n{ "AuthScheme", "negoex.auth_scheme", FT_GUID, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_authscheme_vector_offset,\r\n{ "AuthSchemeArrayOffset", "negoex.auth_scheme_array_offset", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_authscheme_vector_count,\r\n{ "AuthSchemeCount", "negoex.auth_scheme_array_count", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_authscheme_vector_pad,\r\n{ "AuthSchemePad", "negoex.auth_scheme_array_pad", FT_BYTES,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_extension,\r\n{ "Extension", "negoex.extension", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, "Extension data", HFILL }},\r\n{ &hf_negoex_extension_vector_offset,\r\n{ "ExtensionArrayOffset", "negoex.extension_array_offset", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_extension_vector_count,\r\n{ "ExtensionCount", "negoex.extension_array_count", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_extension_vector_pad,\r\n{ "ExtensionPad", "negoex.extension_pad", FT_BYTES,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_negoex_exchange_vector_offset,\r\n{ "ExchangeOffset", "negoex.exchange_vec_offset", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_exchange_vector_count,\r\n{ "ExchangeByteCount", "negoex.exchange_vec_byte_count", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_exchange_vector_pad,\r\n{ "ExchangePad", "negoex.exchange_vec_pad", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_exchange,\r\n{ "Exchange Bytes", "negoex.exchange", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_checksum_scheme,\r\n{ "ChecksumScheme", "negoex.checksum_scheme", FT_UINT32, BASE_DEC,\r\nVALS(checksum_schemes), 0x0, NULL, HFILL}},\r\n{ &hf_negoex_checksum_vector_offset,\r\n{ "ChecksumOffset", "negoex.checksum_vec_offset", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_checksum_vector_count,\r\n{ "ChecksumCount", "negoex.checksum_vec_count", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_checksum_vector_pad,\r\n{ "ChecksumPad", "negoex.checksum_pad", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_checksum_type,\r\n{ "ChecksumType", "negoex.checksum_type", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_checksum,\r\n{ "Checksum", "negoex.checksum", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_errorcode,\r\n{ "ErrorCode", "negoex.errorcode", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_negoex_data,\r\n{ "Data", "negoex.data", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_negoex,\r\n&ett_negoex_msg,\r\n&ett_negoex_hdr,\r\n&ett_negoex_authscheme_vector,\r\n&ett_negoex_extension_vector,\r\n&ett_negoex_exchange,\r\n&ett_negoex_checksum,\r\n&ett_negoex_checksum_vector,\r\n&ett_negoex_byte_vector,\r\n};\r\nproto_negoex = proto_register_protocol (\r\n"SPNEGO Extended Negotiation Security Mechanism",\r\n"NEGOEX",\r\n"negoex"\r\n);\r\nproto_register_field_array(proto_negoex, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("negoex", dissect_negoex, proto_negoex);\r\n}\r\nvoid\r\nproto_reg_handoff_negoex(void)\r\n{\r\ndissector_handle_t negoex_handle;\r\nnegoex_handle = find_dissector("negoex");\r\ngssapi_init_oid("1.3.6.1.4.1.311.2.2.30", proto_negoex, ett_negoex,\r\nnegoex_handle, NULL,\r\n"NEGOEX - SPNEGO Extended Negotiation Security Mechanism");\r\n}

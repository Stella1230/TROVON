static int\r\ndissect_newmail(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *newmail_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "NEWMAIL");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Microsoft Exchange new mail notification");\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_newmail, tvb, 0, -1, ENC_NA);\r\nnewmail_tree = proto_item_add_subtree(ti, ett_newmail);\r\nproto_tree_add_item(newmail_tree, hf_newmail_payload, tvb, 0, 8, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_newmail(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_newmail_payload,\r\n{ "Notification payload", "newmail.notification_payload",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Payload requested by client in the MAPI register push notification packet", HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_newmail,\r\n};\r\nmodule_t *newmail_module;\r\nproto_newmail = proto_register_protocol("Microsoft Exchange New Mail Notification",\r\n"NEWMAIL", "newmail");\r\nproto_register_field_array(proto_newmail, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("newmail", dissect_newmail, proto_newmail);\r\nnewmail_module = prefs_register_protocol(proto_newmail,\r\nproto_reg_handoff_newmail);\r\nprefs_register_uint_preference(newmail_module,\r\n"default_port",\r\n"Default UDP port (optional)",\r\n"Always dissect this port's traffic as newmail notifications."\r\n" Additional ports will be dynamically registered as they"\r\n" are seen in MAPI register push notification packets.",\r\n10, &preference_default_port);\r\n}\r\nvoid\r\nproto_reg_handoff_newmail(void)\r\n{\r\nstatic gboolean inited = FALSE;\r\nstatic dissector_handle_t newmail_handle;\r\nstatic guint preference_default_port_last;\r\nif(!inited) {\r\nnewmail_handle = find_dissector("newmail");\r\ndissector_add_for_decode_as("udp.port", newmail_handle);\r\ninited = TRUE;\r\n} else {\r\nif (preference_default_port_last != 0) {\r\ndissector_delete_uint("udp.port", preference_default_port_last, newmail_handle);\r\n}\r\n}\r\nif(preference_default_port != 0) {\r\ndissector_add_uint("udp.port", preference_default_port, newmail_handle);\r\n}\r\npreference_default_port_last = preference_default_port;\r\n}

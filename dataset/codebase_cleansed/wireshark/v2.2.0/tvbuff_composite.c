static void\r\ncomposite_free(tvbuff_t *tvb)\r\n{\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\ntvb_comp_t *composite = &composite_tvb->composite;\r\ng_slist_free(composite->tvbs);\r\ng_free(composite->start_offsets);\r\ng_free(composite->end_offsets);\r\nif (tvb->real_data) {\r\ng_free((gpointer)tvb->real_data);\r\n}\r\n}\r\nstatic guint\r\ncomposite_offset(const tvbuff_t *tvb, const guint counter)\r\n{\r\nconst struct tvb_composite *composite_tvb = (const struct tvb_composite *) tvb;\r\nconst tvbuff_t *member = (const tvbuff_t *)composite_tvb->composite.tvbs->data;\r\nreturn tvb_offset_from_real_beginning_counter(member, counter);\r\n}\r\nstatic const guint8*\r\ncomposite_get_ptr(tvbuff_t *tvb, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\nguint i, num_members;\r\ntvb_comp_t *composite;\r\ntvbuff_t *member_tvb = NULL;\r\nguint member_offset;\r\nGSList *slist;\r\ncomposite = &composite_tvb->composite;\r\nnum_members = g_slist_length(composite->tvbs);\r\nfor (i = 0; i < num_members; i++) {\r\nif (abs_offset <= composite->end_offsets[i]) {\r\nslist = g_slist_nth(composite->tvbs, i);\r\nmember_tvb = (tvbuff_t *)slist->data;\r\nbreak;\r\n}\r\n}\r\nif (!member_tvb) {\r\nDISSECTOR_ASSERT(abs_offset == tvb->length && abs_length == 0);\r\nreturn "";\r\n}\r\nmember_offset = abs_offset - composite->start_offsets[i];\r\nif (tvb_bytes_exist(member_tvb, member_offset, abs_length)) {\r\nDISSECTOR_ASSERT(!tvb->real_data);\r\nreturn tvb_get_ptr(member_tvb, member_offset, abs_length);\r\n}\r\nelse {\r\nvoid *real_data = g_malloc(abs_length);\r\ntvb_memcpy(tvb, real_data, 0, abs_length);\r\ntvb->real_data = (const guint8 *)real_data;\r\nreturn tvb->real_data + abs_offset;\r\n}\r\nDISSECTOR_ASSERT_NOT_REACHED();\r\n}\r\nstatic void *\r\ncomposite_memcpy(tvbuff_t *tvb, void* _target, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\nguint8 *target = (guint8 *) _target;\r\nguint i, num_members;\r\ntvb_comp_t *composite;\r\ntvbuff_t *member_tvb = NULL;\r\nguint member_offset, member_length;\r\nGSList *slist;\r\ncomposite = &composite_tvb->composite;\r\nnum_members = g_slist_length(composite->tvbs);\r\nfor (i = 0; i < num_members; i++) {\r\nif (abs_offset <= composite->end_offsets[i]) {\r\nslist = g_slist_nth(composite->tvbs, i);\r\nmember_tvb = (tvbuff_t *)slist->data;\r\nbreak;\r\n}\r\n}\r\nif (!member_tvb) {\r\nDISSECTOR_ASSERT(abs_offset == tvb->length && abs_length == 0);\r\nreturn target;\r\n}\r\nmember_offset = abs_offset - composite->start_offsets[i];\r\nif (tvb_bytes_exist(member_tvb, member_offset, abs_length)) {\r\nDISSECTOR_ASSERT(!tvb->real_data);\r\nreturn tvb_memcpy(member_tvb, target, member_offset, abs_length);\r\n}\r\nelse {\r\nmember_length = tvb_captured_length_remaining(member_tvb, member_offset);\r\nDISSECTOR_ASSERT(member_length > 0);\r\ntvb_memcpy(member_tvb, target, member_offset, member_length);\r\nabs_offset += member_length;\r\nabs_length -= member_length;\r\nif (abs_length > 0) {\r\ncomposite_memcpy(tvb, target + member_length, abs_offset, abs_length);\r\n}\r\nreturn target;\r\n}\r\nDISSECTOR_ASSERT_NOT_REACHED();\r\n}\r\ntvbuff_t *\r\ntvb_new_composite(void)\r\n{\r\ntvbuff_t *tvb = tvb_new(&tvb_composite_ops);\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\ntvb_comp_t *composite = &composite_tvb->composite;\r\ncomposite->tvbs = NULL;\r\ncomposite->start_offsets = NULL;\r\ncomposite->end_offsets = NULL;\r\nreturn tvb;\r\n}\r\nvoid\r\ntvb_composite_append(tvbuff_t *tvb, tvbuff_t *member)\r\n{\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\ntvb_comp_t *composite;\r\nDISSECTOR_ASSERT(tvb && !tvb->initialized);\r\nDISSECTOR_ASSERT(tvb->ops == &tvb_composite_ops);\r\nDISSECTOR_ASSERT(member->length);\r\ncomposite = &composite_tvb->composite;\r\ncomposite->tvbs = g_slist_append(composite->tvbs, member);\r\n}\r\nvoid\r\ntvb_composite_prepend(tvbuff_t *tvb, tvbuff_t *member)\r\n{\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\ntvb_comp_t *composite;\r\nDISSECTOR_ASSERT(tvb && !tvb->initialized);\r\nDISSECTOR_ASSERT(tvb->ops == &tvb_composite_ops);\r\nDISSECTOR_ASSERT(member->length);\r\ncomposite = &composite_tvb->composite;\r\ncomposite->tvbs = g_slist_prepend(composite->tvbs, member);\r\n}\r\nvoid\r\ntvb_composite_finalize(tvbuff_t *tvb)\r\n{\r\nstruct tvb_composite *composite_tvb = (struct tvb_composite *) tvb;\r\nGSList *slist;\r\nguint num_members;\r\ntvbuff_t *member_tvb;\r\ntvb_comp_t *composite;\r\nint i = 0;\r\nDISSECTOR_ASSERT(tvb && !tvb->initialized);\r\nDISSECTOR_ASSERT(tvb->ops == &tvb_composite_ops);\r\nDISSECTOR_ASSERT(tvb->length == 0);\r\nDISSECTOR_ASSERT(tvb->reported_length == 0);\r\ncomposite = &composite_tvb->composite;\r\nnum_members = g_slist_length(composite->tvbs);\r\nDISSECTOR_ASSERT(num_members);\r\ncomposite->start_offsets = g_new(guint, num_members);\r\ncomposite->end_offsets = g_new(guint, num_members);\r\nfor (slist = composite->tvbs; slist != NULL; slist = slist->next) {\r\nDISSECTOR_ASSERT((guint) i < num_members);\r\nmember_tvb = (tvbuff_t *)slist->data;\r\ncomposite->start_offsets[i] = tvb->length;\r\ntvb->length += member_tvb->length;\r\ntvb->reported_length += member_tvb->reported_length;\r\ncomposite->end_offsets[i] = tvb->length - 1;\r\ni++;\r\n}\r\nDISSECTOR_ASSERT(composite->tvbs);\r\ntvb_add_to_chain((tvbuff_t *)composite->tvbs->data, tvb);\r\ntvb->initialized = TRUE;\r\ntvb->ds_tvb = tvb;\r\n}

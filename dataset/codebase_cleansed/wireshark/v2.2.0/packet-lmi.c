static void\r\ndissect_lmi_report_type(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_uint(tree, hf_lmi_rcd_type, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\n}\r\nstatic void\r\ndissect_lmi_link_int(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_uint(tree, hf_lmi_send_seq, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\n++offset;\r\nproto_tree_add_uint(tree, hf_lmi_recv_seq, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\n}\r\nstatic void\r\ndissect_lmi_pvc_status(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_uint(tree, hf_lmi_dlci_high, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\n++offset;\r\nproto_tree_add_uint(tree, hf_lmi_dlci_low, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\n++offset;\r\nproto_tree_add_uint(tree, hf_lmi_new, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\nproto_tree_add_uint(tree, hf_lmi_act, tvb, offset, 1, tvb_get_guint8( tvb, offset));\r\n}\r\nstatic int\r\ndissect_lmi(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *lmi_tree, *lmi_subtree;\r\nproto_item *ti;\r\nint offset = 2, len;\r\nguint8 msg_type;\r\nguint8 ele_id;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LMI");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_lmi, tvb, 0, 3, ENC_NA);\r\nlmi_tree = proto_item_add_subtree(ti, ett_lmi_ele);\r\nproto_tree_add_item(lmi_tree, hf_lmi_call_ref, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nmsg_type = tvb_get_guint8( tvb, 1);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(msg_type, msg_type_str, "Unknown message type (0x%02x)"));\r\nproto_tree_add_uint(lmi_tree, hf_lmi_msg_type, tvb, 1, 1, msg_type);\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nele_id = tvb_get_guint8( tvb, offset);\r\nlen = tvb_get_guint8( tvb, offset + 1);\r\nlmi_subtree = proto_tree_add_subtree_format(lmi_tree, tvb, offset, len + 2,\r\nett_lmi_ele, NULL, "Information Element: %s",\r\nval_to_str(ele_id, element_type_str, "Unknown (%u)"));\r\nproto_tree_add_uint(lmi_subtree, hf_lmi_inf_ele, tvb, offset, 1,\r\nele_id);\r\n++offset;\r\nproto_tree_add_uint(lmi_subtree, hf_lmi_inf_len, tvb, offset, 1, len);\r\n++offset;\r\nif (( ele_id == 1) || (ele_id == 51))\r\ndissect_lmi_report_type( tvb, offset, lmi_subtree);\r\nelse if (( ele_id == 3) || (ele_id == 53))\r\ndissect_lmi_link_int( tvb, offset, lmi_subtree);\r\nelse if (( ele_id == 7) || (ele_id == 57))\r\ndissect_lmi_pvc_status( tvb, offset, lmi_subtree);\r\noffset += len;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_lmi(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_lmi_call_ref,\r\n{ "Call reference", "lmi.cmd", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_lmi_msg_type,\r\n{ "Message Type", "lmi.msg_type", FT_UINT8, BASE_HEX, VALS(msg_type_str), 0,\r\nNULL, HFILL }},\r\n{ &hf_lmi_inf_ele,\r\n{ "Type", "lmi.inf_ele_type", FT_UINT8, BASE_DEC, VALS(element_type_str), 0,\r\n"Information Element Type", HFILL }},\r\n{ &hf_lmi_inf_len,\r\n{ "Length", "lmi.inf_ele_len", FT_UINT8, BASE_DEC, NULL, 0,\r\n"Information Element Length", HFILL }},\r\n{ &hf_lmi_rcd_type,\r\n{ "Record Type", "lmi.ele_rcd_type", FT_UINT8, BASE_DEC, VALS(record_type_str), 0,\r\nNULL, HFILL }},\r\n{ &hf_lmi_send_seq,\r\n{ "Send Seq", "lmi.send_seq", FT_UINT8, BASE_DEC, NULL, 0,\r\n"Send Sequence", HFILL }},\r\n{ &hf_lmi_recv_seq,\r\n{ "Recv Seq", "lmi.recv_seq", FT_UINT8, BASE_DEC, NULL, 0,\r\n"Receive Sequence", HFILL }},\r\n{ &hf_lmi_dlci_high,\r\n{ "DLCI High", "lmi.dlci_hi", FT_UINT8, BASE_DEC, NULL, 0x3f,\r\n"DLCI High bits", HFILL }},\r\n{ &hf_lmi_dlci_low,\r\n{ "DLCI Low", "lmi.dlci_low", FT_UINT8, BASE_DEC, NULL, 0x78,\r\n"DLCI Low bits", HFILL }},\r\n{ &hf_lmi_new,\r\n{ "DLCI New", "lmi.dlci_new", FT_UINT8, BASE_DEC, VALS(pvc_status_new_str), 0x08,\r\n"DLCI New Flag", HFILL }},\r\n{ &hf_lmi_act,\r\n{ "DLCI Active","lmi.dlci_act", FT_UINT8, BASE_DEC, VALS(pvc_status_act_str), 0x02,\r\n"DLCI Active Flag", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_lmi,\r\n&ett_lmi_ele,\r\n};\r\nproto_lmi = proto_register_protocol ("Local Management Interface", "LMI", "lmi");\r\nproto_register_field_array (proto_lmi, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_lmi(void)\r\n{\r\ndissector_handle_t lmi_handle;\r\nlmi_handle = create_dissector_handle(dissect_lmi, proto_lmi);\r\ndissector_add_uint("fr.nlpid", NLPID_LMI, lmi_handle);\r\n}

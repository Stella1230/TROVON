static int dissect_bjnp (tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *bjnp_tree;\r\nproto_item *ti;\r\ngint offset = 0;\r\nguint32 payload_len;\r\nguint8 dev_type, cmd_code;\r\ngchar *info;\r\nif(!g_ascii_isprint(tvb_get_guint8(tvb, 0)))\r\nreturn 0;\r\ncol_set_str (pinfo->cinfo, COL_PROTOCOL, PSNAME);\r\ncol_clear (pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item (tree, proto_bjnp, tvb, offset, -1, ENC_NA);\r\nbjnp_tree = proto_item_add_subtree (ti, ett_bjnp);\r\nproto_tree_add_item (bjnp_tree, hf_bjnp_id, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\noffset += 4;\r\ndev_type = tvb_get_guint8 (tvb, offset);\r\nproto_tree_add_item (bjnp_tree, hf_dev_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ncmd_code = tvb_get_guint8 (tvb, offset);\r\nproto_tree_add_item (bjnp_tree, hf_cmd_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ninfo = wmem_strdup_printf(wmem_packet_scope(), "%s: %s",\r\nval_to_str (dev_type, dev_type_vals, "Unknown type (%d)"),\r\nval_to_str (cmd_code, cmd_code_vals, "Unknown code (%d)"));\r\nproto_item_append_text (ti, ", %s", info);\r\ncol_add_str (pinfo->cinfo, COL_INFO, info);\r\nproto_tree_add_item (bjnp_tree, hf_seq_no, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item (bjnp_tree, hf_session_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\npayload_len = tvb_get_ntohl (tvb, offset);\r\nproto_tree_add_item (bjnp_tree, hf_payload_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (payload_len > 0) {\r\nproto_tree_add_item (bjnp_tree, hf_payload, tvb, offset, payload_len, ENC_NA);\r\noffset += payload_len;\r\n}\r\nreturn offset;\r\n}\r\nvoid proto_register_bjnp (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_bjnp_id,\r\n{ "Id", "bjnp.id", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL } },\r\n{ &hf_dev_type,\r\n{ "Type", "bjnp.type", FT_UINT8, BASE_DEC,\r\nVALS(dev_type_vals), 0x0, NULL, HFILL } },\r\n{ &hf_cmd_code,\r\n{ "Code", "bjnp.code", FT_UINT8, BASE_DEC,\r\nVALS(cmd_code_vals), 0x0, NULL, HFILL } },\r\n{ &hf_seq_no,\r\n{ "Sequence Number", "bjnp.seq_no", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL } },\r\n{ &hf_session_id,\r\n{ "Session Id", "bjnp.session_id", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL } },\r\n{ &hf_payload_len,\r\n{ "Payload Length", "bjnp.payload_len", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL } },\r\n{ &hf_payload,\r\n{ "Payload", "bjnp.payload", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL } },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_bjnp\r\n};\r\nproto_bjnp = proto_register_protocol (PNAME, PSNAME, PFNAME);\r\nbjnp_handle = register_dissector (PFNAME, dissect_bjnp, proto_bjnp);\r\nproto_register_field_array (proto_bjnp, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\n}\r\nvoid proto_reg_handoff_bjnp (void)\r\n{\r\ndissector_add_uint ("udp.port", BJNP_PORT1, bjnp_handle);\r\ndissector_add_uint ("udp.port", BJNP_PORT2, bjnp_handle);\r\ndissector_add_uint ("udp.port", BJNP_PORT3, bjnp_handle);\r\ndissector_add_uint ("udp.port", BJNP_PORT4, bjnp_handle);\r\n}

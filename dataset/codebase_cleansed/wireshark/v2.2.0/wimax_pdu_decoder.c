static int dissect_wimax_pdu_decoder(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset;\r\nguint mac_ht, mac_ec;\r\nguint first_byte, length;\r\nguint mac_hcs, mac_hcs_calculated;\r\nproto_item *pdu_item = NULL;\r\nproto_tree *pdu_tree = NULL;\r\n#ifndef STATIC_DATA\r\nwimax_mac_gen_crc32_table();\r\nwimax_mac_gen_crc8_table();\r\n#endif\r\nfor(offset = 0; offset < tvb_reported_length(tvb); )\r\n{\r\nif (offset == 0)\r\n{\r\nfirst_gmh = TRUE;\r\n}\r\nelse\r\n{\r\nfirst_gmh = FALSE;\r\n}\r\nlength = tvb_reported_length_remaining(tvb, offset);\r\nfirst_byte = tvb_get_guint8(tvb, offset);\r\nif(first_byte == WIMAX_PDU_PADDING_MASK)\r\n{\r\npdu_item = proto_tree_add_protocol_format(tree, proto_wimax_pdu_decoder, tvb, offset, length, "Padding (%u bytes)", length);\r\npdu_tree = proto_item_add_subtree(pdu_item, ett_wimax_pdu_decoder);\r\nproto_tree_add_item(pdu_tree, hf_wimax_value_bytes, tvb, offset, length, ENC_NA);\r\nbreak;\r\n}\r\nelse if((first_byte & WIMAX_MAP_TYPE_MASK) == WIMAX_HARQ_MAP_MSG_IND)\r\n{\r\nlength = ((tvb_get_ntohs(tvb, offset) & WIMAX_HARQ_MAP_MSG_LENGTH_MASK1) >> 2);\r\nif (length == 0)\r\n{\r\nlength = 3;\r\n}\r\ncall_dissector(wimax_harq_map_handle, tvb_new_subset_length(tvb,offset,length), pinfo, tree);\r\noffset += length;\r\ncontinue;\r\n}\r\nelse if((first_byte & WIMAX_MAP_TYPE_MASK) == WIMAX_COMPRESSED_DL_MAP_IND)\r\n{\r\nif(is_down_link(pinfo))\r\n{\r\nif ((first_byte & REDUCED_PRIVATE_MAP_MASK) == REDUCED_PRIVATE_MAP_MASK)\r\n{\r\nlength = wimax_decode_dlmap_reduced_aas(tvb, pinfo, tree);\r\n}\r\nelse\r\n{\r\nlength = wimax_decode_dlmapc(tvb, pinfo, tree);\r\n}\r\noffset += length;\r\ncontinue;\r\n}\r\n}\r\nelse if((first_byte & WIMAX_INVALID_PDU_MASK) == WIMAX_INVALID_PDU_MASK)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "Invalid PDU");\r\npdu_item = proto_tree_add_protocol_format(tree, proto_wimax_pdu_decoder, tvb, offset, length, "Invalid PDU (%u bytes)", length);\r\npdu_tree = proto_item_add_subtree(pdu_item, ett_wimax_pdu_decoder);\r\nproto_tree_add_item(pdu_tree, hf_wimax_value_bytes, tvb, offset, length, ENC_NA);\r\nbreak;\r\n}\r\nmac_hcs_calculated = wimax_mac_calc_crc8(tvb_get_ptr(tvb, offset, WIMAX_MAC_HEADER_INFO_FIELDS), WIMAX_MAC_HEADER_INFO_FIELDS);\r\nmac_hcs = tvb_get_guint8(tvb, offset + WIMAX_MAC_HEADER_SIZE - 1);\r\nif(mac_hcs != mac_hcs_calculated)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "MAC Header CRC error");\r\npdu_item = proto_tree_add_protocol_format(tree, proto_wimax_pdu_decoder, tvb, offset, WIMAX_MAC_HEADER_SIZE, "MAC Header CRC error %X (in header) and %X (calculated)", mac_hcs, mac_hcs_calculated);\r\npdu_tree = proto_item_add_subtree(pdu_item, ett_wimax_pdu_decoder);\r\nproto_tree_add_item(pdu_tree, hf_wimax_value_bytes, tvb, offset, length, ENC_NA);\r\nbreak;\r\n}\r\nmac_ht = ((first_byte & WIMAX_MAC_HEADER_HT_FIELD)?1:0);\r\nmac_ec = ((first_byte & WIMAX_MAC_HEADER_EC_FIELD)?1:0);\r\nif(!mac_ht)\r\n{\r\nlength = (tvb_get_guint8(tvb, offset+1) & WIMAX_MAC_HEADER_LENGTH_MSB_MASK);\r\nlength = ((length<<8) | tvb_get_guint8(tvb, offset+2));\r\n}\r\nelse\r\n{\r\nlength = WIMAX_MAC_HEADER_SIZE;\r\n}\r\npdu_item = proto_tree_add_protocol_format(tree, proto_wimax_pdu_decoder, tvb, offset, length, "PDU (%u bytes)", length);\r\npdu_tree = proto_item_add_subtree(pdu_item, ett_wimax_pdu_decoder);\r\nif (length == 0) {\r\noffset += 6;\r\ncontinue;\r\n}\r\nif(mac_ht)\r\n{\r\nif(mac_ec)\r\n{\r\nproto_item_append_text(pdu_item, " - Mac Type II Header: ");\r\ncall_dissector(mac_header_type2_handle, tvb_new_subset_length(tvb,offset,length), pinfo, pdu_tree);\r\n}\r\nelse\r\n{\r\nproto_item_append_text(pdu_item, " - Mac Type I Header: ");\r\ncall_dissector(mac_header_type1_handle, tvb_new_subset_length(tvb,offset,length), pinfo, pdu_tree);\r\n}\r\n}\r\nelse\r\n{\r\ncall_dissector(mac_generic_decoder_handle, tvb_new_subset_length(tvb,offset,length), pinfo, pdu_tree);\r\n}\r\noffset += length;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_wimax_pdu(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_wimax_value_bytes,\r\n{\r\n"Values", "wmx.pdu.value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_wimax_pdu_decoder,\r\n};\r\nproto_wimax_pdu_decoder = proto_wimax;\r\nregister_dissector("wimax_pdu_burst_handler", dissect_wimax_pdu_decoder, -1);\r\nproto_register_field_array(proto_wimax_pdu_decoder, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_wimax_pdu(void)\r\n{\r\nmac_generic_decoder_handle = find_dissector("mac_header_generic_handler");\r\nmac_header_type1_handle = find_dissector("mac_header_type_1_handler");\r\nmac_header_type2_handle = find_dissector("mac_header_type_2_handler");\r\nwimax_harq_map_handle = find_dissector("wimax_harq_map_handler");\r\n}

static void\r\nrlogin_state_machine(rlogin_hash_entry_t *hash_info, tvbuff_t *tvb, packet_info *pinfo)\r\n{\r\nguint length;\r\ngint stringlen;\r\nif (pinfo->fd->flags.visited)\r\n{\r\nreturn;\r\n}\r\nif (pinfo->destport != RLOGIN_PORT)\r\n{\r\nreturn;\r\n}\r\nif (hash_info->state == DONE)\r\n{\r\nreturn;\r\n}\r\nlength = tvb_captured_length(tvb);\r\nif (length == 0)\r\n{\r\nreturn;\r\n}\r\nif (hash_info->state == NONE)\r\n{\r\nif (tvb_get_guint8(tvb, 0) != '\0')\r\n{\r\nhash_info->state = DONE;\r\nreturn;\r\n}\r\nelse\r\n{\r\nif (length <= 1)\r\n{\r\nhash_info->state = USER_INFO_WAIT;\r\n}\r\nelse\r\n{\r\nhash_info->state = DONE;\r\nhash_info->info_framenum = pinfo->num;\r\n}\r\n}\r\n}\r\nelse\r\nif (hash_info->state == USER_INFO_WAIT)\r\n{\r\nhash_info->state = DONE;\r\nhash_info->info_framenum = pinfo->num;\r\nstringlen = tvb_strnlen(tvb, 0, NAME_LEN);\r\nif (stringlen == -1)\r\nstringlen = NAME_LEN - 1;\r\nelse if (stringlen > NAME_LEN - 1)\r\nstringlen = NAME_LEN - 1;\r\ntvb_memcpy(tvb, (guint8 *)hash_info->user_name, 0, stringlen);\r\nhash_info->user_name[stringlen] = '\0';\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", (User information)");\r\n}\r\n}\r\nstatic void rlogin_display(rlogin_hash_entry_t *hash_info,\r\ntvbuff_t *tvb,\r\npacket_info *pinfo,\r\nproto_tree *tree,\r\nstruct tcpinfo *tcpinfo)\r\n{\r\nint offset = 0;\r\nproto_tree *rlogin_tree, *user_info_tree, *window_tree;\r\nproto_item *ti;\r\nguint length;\r\nint str_len;\r\ngint ti_offset;\r\nproto_item *user_info_item, *window_info_item;\r\nti = proto_tree_add_item(tree, proto_rlogin, tvb, 0, -1, ENC_NA);\r\nrlogin_tree = proto_item_add_subtree(ti, ett_rlogin);\r\nlength = tvb_captured_length(tvb);\r\nif (length == 0)\r\n{\r\nreturn;\r\n}\r\nif (tcpinfo && IS_TH_URG(tcpinfo->flags) &&\r\nlength >= tcpinfo->urgent_pointer)\r\n{\r\nint urgent_offset = tcpinfo->urgent_pointer - 1;\r\nguint8 control_byte;\r\nif (urgent_offset > offset)\r\n{\r\nproto_tree_add_item(rlogin_tree, hf_data, tvb, offset, urgent_offset, ENC_ASCII|ENC_NA);\r\n}\r\nproto_tree_add_item(rlogin_tree, hf_control_message, tvb,\r\nurgent_offset, 1, ENC_BIG_ENDIAN);\r\ncontrol_byte = tvb_get_guint8(tvb, urgent_offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n" (%s)", val_to_str_const(control_byte, control_message_vals, "Unknown"));\r\noffset = urgent_offset + 1;\r\n}\r\nelse\r\nif (tvb_get_guint8(tvb, offset) == '\0')\r\n{\r\nif (pinfo->srcport == RLOGIN_PORT)\r\n{\r\nproto_tree_add_item(rlogin_tree, hf_startup_info_received_flag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(rlogin_tree, hf_client_startup_flag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\n++offset;\r\n}\r\nif (!tvb_offset_exists(tvb, offset))\r\n{\r\nreturn;\r\n}\r\nif (hash_info->info_framenum == pinfo->num)\r\n{\r\ngint info_len;\r\ngint slash_offset;\r\ninfo_len = tvb_captured_length_remaining(tvb, offset);\r\nif (info_len <= 0)\r\nreturn;\r\nuser_info_item = proto_tree_add_string_format(rlogin_tree, hf_user_info, tvb,\r\noffset, info_len, FALSE,\r\n"User info (%s)",\r\ntvb_format_text(tvb, offset, info_len));\r\nuser_info_tree = proto_item_add_subtree(user_info_item,\r\nett_rlogin_user_info);\r\nstr_len = tvb_strsize(tvb, offset);\r\nproto_tree_add_item(user_info_tree, hf_user_info_client_user_name,\r\ntvb, offset, str_len, ENC_ASCII|ENC_NA);\r\noffset += str_len;\r\nstr_len = tvb_strsize(tvb, offset);\r\nproto_tree_add_item(user_info_tree, hf_user_info_server_user_name,\r\ntvb, offset, str_len, ENC_ASCII|ENC_NA);\r\noffset += str_len;\r\nslash_offset = tvb_find_guint8(tvb, offset, -1, '/');\r\nif (slash_offset != -1)\r\n{\r\nproto_tree_add_item(user_info_tree, hf_user_info_terminal_type,\r\ntvb, offset, slash_offset-offset, ENC_ASCII|ENC_NA);\r\noffset = slash_offset + 1;\r\nstr_len = tvb_strsize(tvb, offset);\r\nproto_tree_add_uint(user_info_tree, hf_user_info_terminal_speed,\r\ntvb, offset, str_len,\r\natoi(tvb_format_text(tvb, offset, str_len)));\r\noffset += str_len;\r\n}\r\n}\r\nif (!tvb_offset_exists(tvb, offset))\r\n{\r\nreturn;\r\n}\r\nti_offset = tvb_find_guint8(tvb, offset, -1, 0xff);\r\nif (ti_offset != -1 &&\r\ntvb_bytes_exist(tvb, ti_offset + 1, 1) &&\r\ntvb_get_guint8(tvb, ti_offset + 1) == 0xff)\r\n{\r\nguint16 rows, columns;\r\nif (ti_offset > offset)\r\n{\r\nproto_tree_add_item(rlogin_tree, hf_data, tvb,\r\noffset, ti_offset - offset, ENC_ASCII|ENC_NA);\r\n}\r\nwindow_info_item =\r\nproto_tree_add_item(rlogin_tree, hf_window_info, tvb, offset, 12, ENC_NA);\r\nwindow_tree = proto_item_add_subtree(window_info_item, ett_rlogin_window);\r\nproto_tree_add_item(window_tree, hf_magic_cookie, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(window_tree, hf_window_info_ss, tvb, offset, 2, ENC_ASCII|ENC_NA);\r\noffset += 2;\r\nrows = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(window_tree, hf_window_info_rows, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ncolumns = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(window_tree, hf_window_info_cols, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(window_tree, hf_window_info_x_pixels, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(window_tree, hf_window_info_y_pixels, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " (rows=%u, cols=%u)",\r\nrows, columns);\r\n}\r\nif (tvb_offset_exists(tvb, offset))\r\n{\r\nproto_tree_add_item(rlogin_tree, hf_data, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\nstatic int\r\ndissect_rlogin(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nstruct tcpinfo *tcpinfo = (struct tcpinfo *)data;\r\nconversation_t *conversation;\r\nrlogin_hash_entry_t *hash_info;\r\nguint length;\r\ngint ti_offset;\r\nconversation = find_or_create_conversation(pinfo);\r\nhash_info = (rlogin_hash_entry_t *)conversation_get_proto_data(conversation, proto_rlogin);\r\nif (!hash_info)\r\n{\r\nhash_info = wmem_new(wmem_file_scope(), rlogin_hash_entry_t);\r\nhash_info->state = NONE;\r\nhash_info->info_framenum = 0;\r\nhash_info->user_name[0] = '\0';\r\nconversation_add_proto_data(conversation, proto_rlogin, hash_info);\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Rlogin");\r\nif (hash_info->user_name[0])\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"User name: %s, ", hash_info->user_name);\r\n}\r\nelse\r\n{\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n}\r\nlength = tvb_reported_length(tvb);\r\nif (length != 0)\r\n{\r\nif (tvb_get_guint8(tvb, 0) == '\0')\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\n(pinfo->destport == RLOGIN_PORT) ?\r\n"Start Handshake" :\r\n"Startup info received");\r\n}\r\nelse\r\nif (tcpinfo && IS_TH_URG(tcpinfo->flags) && length >= tcpinfo->urgent_pointer)\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Control Message");\r\n}\r\nelse\r\n{\r\nti_offset = tvb_find_guint8(tvb, 0, -1, 0xff);\r\nif (ti_offset != -1 &&\r\ntvb_bytes_exist(tvb, ti_offset + 1, 1) &&\r\ntvb_get_guint8(tvb, ti_offset + 1) == 0xff)\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Terminal Info");\r\n}\r\nelse\r\n{\r\nint bytes_to_copy = tvb_captured_length(tvb);\r\nif (bytes_to_copy > 128)\r\n{\r\nbytes_to_copy = 128;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n"Data: %s",\r\ntvb_format_text(tvb, 0, bytes_to_copy));\r\n}\r\n}\r\n}\r\nrlogin_state_machine(hash_info, tvb, pinfo);\r\nrlogin_display(hash_info, tvb, pinfo, tree, tcpinfo);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_rlogin(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_rlogin,\r\n&ett_rlogin_window,\r\n&ett_rlogin_window_rows,\r\n&ett_rlogin_window_cols,\r\n&ett_rlogin_window_x_pixels,\r\n&ett_rlogin_window_y_pixels,\r\n&ett_rlogin_user_info\r\n};\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_user_info,\r\n{ "User Info", "rlogin.user_info", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_client_startup_flag,\r\n{ "Client startup flag", "rlogin.client_startup_flag", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_startup_info_received_flag,\r\n{ "Startup info received flag", "rlogin.startup_info_received_flag", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_user_info_client_user_name,\r\n{ "Client-user-name", "rlogin.client_user_name", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_user_info_server_user_name,\r\n{ "Server-user-name", "rlogin.server_user_name", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_user_info_terminal_type,\r\n{ "Terminal-type", "rlogin.terminal_type", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_user_info_terminal_speed,\r\n{ "Terminal-speed", "rlogin.terminal_speed", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_control_message,\r\n{ "Control message", "rlogin.control_message", FT_UINT8, BASE_HEX,\r\nVALS(control_message_vals), 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_magic_cookie,\r\n{ "Magic Cookie", "rlogin.magic_cookie", FT_UINT16, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_window_info,\r\n{ "Window Info", "rlogin.window_size", FT_NONE, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_window_info_ss,\r\n{ "Window size marker", "rlogin.window_size.ss", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_window_info_rows,\r\n{ "Rows", "rlogin.window_size.rows", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_window_info_cols,\r\n{ "Columns", "rlogin.window_size.cols", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_window_info_x_pixels,\r\n{ "X Pixels", "rlogin.window_size.x_pixels", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_window_info_y_pixels,\r\n{ "Y Pixels", "rlogin.window_size.y_pixels", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_data,\r\n{ "Data", "rlogin.data", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n}\r\n};\r\nproto_rlogin = proto_register_protocol("Rlogin Protocol", "Rlogin", "rlogin");\r\nproto_register_field_array(proto_rlogin, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_rlogin(void)\r\n{\r\ndissector_handle_t rlogin_handle = create_dissector_handle(dissect_rlogin,proto_rlogin);\r\ndissector_add_uint("tcp.port", RLOGIN_PORT, rlogin_handle);\r\n}

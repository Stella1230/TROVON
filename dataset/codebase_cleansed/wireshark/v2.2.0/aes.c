static gint rijndaelKeySetupEnc(\r\nguint32 rk[],\r\nconst guint8 cipherKey[],\r\ngint keyBits)\r\n{\r\ngint i = 0;\r\nguint32 temp;\r\nif (!(keyBits == 128 || keyBits == 192 || keyBits == 256))\r\nreturn -1;\r\nrk[0] = GETU32(cipherKey );\r\nrk[1] = GETU32(cipherKey + 4);\r\nrk[2] = GETU32(cipherKey + 8);\r\nrk[3] = GETU32(cipherKey + 12);\r\nif (keyBits == 128) {\r\nfor (;;) {\r\ntemp = rk[3];\r\nrk[4] = rk[0] ^\r\n(Te4[(temp >> 16) & 0xff] & 0xff000000) ^\r\n(Te4[(temp >> 8) & 0xff] & 0x00ff0000) ^\r\n(Te4[(temp ) & 0xff] & 0x0000ff00) ^\r\n(Te4[(temp >> 24) ] & 0x000000ff) ^\r\nrcon[i];\r\nrk[5] = rk[1] ^ rk[4];\r\nrk[6] = rk[2] ^ rk[5];\r\nrk[7] = rk[3] ^ rk[6];\r\nif (++i == 10) {\r\nreturn 10;\r\n}\r\nrk += 4;\r\n}\r\n}\r\nrk[4] = GETU32(cipherKey + 16);\r\nrk[5] = GETU32(cipherKey + 20);\r\nif (keyBits == 192) {\r\nfor (;;) {\r\ntemp = rk[ 5];\r\nrk[ 6] = rk[ 0] ^\r\n(Te4[(temp >> 16) & 0xff] & 0xff000000) ^\r\n(Te4[(temp >> 8) & 0xff] & 0x00ff0000) ^\r\n(Te4[(temp ) & 0xff] & 0x0000ff00) ^\r\n(Te4[(temp >> 24) ] & 0x000000ff) ^\r\nrcon[i];\r\nrk[ 7] = rk[ 1] ^ rk[ 6];\r\nrk[ 8] = rk[ 2] ^ rk[ 7];\r\nrk[ 9] = rk[ 3] ^ rk[ 8];\r\nif (++i == 8) {\r\nreturn 12;\r\n}\r\nrk[10] = rk[ 4] ^ rk[ 9];\r\nrk[11] = rk[ 5] ^ rk[10];\r\nrk += 6;\r\n}\r\n}\r\nrk[6] = GETU32(cipherKey + 24);\r\nrk[7] = GETU32(cipherKey + 28);\r\nif (keyBits == 256) {\r\nfor (;;) {\r\ntemp = rk[ 7];\r\nrk[ 8] = rk[ 0] ^\r\n(Te4[(temp >> 16) & 0xff] & 0xff000000) ^\r\n(Te4[(temp >> 8) & 0xff] & 0x00ff0000) ^\r\n(Te4[(temp ) & 0xff] & 0x0000ff00) ^\r\n(Te4[(temp >> 24) ] & 0x000000ff) ^\r\nrcon[i];\r\nrk[ 9] = rk[ 1] ^ rk[ 8];\r\nrk[10] = rk[ 2] ^ rk[ 9];\r\nrk[11] = rk[ 3] ^ rk[10];\r\nif (++i == 7) {\r\nreturn 14;\r\n}\r\ntemp = rk[11];\r\nrk[12] = rk[ 4] ^\r\n(Te4[(temp >> 24) ] & 0xff000000) ^\r\n(Te4[(temp >> 16) & 0xff] & 0x00ff0000) ^\r\n(Te4[(temp >> 8) & 0xff] & 0x0000ff00) ^\r\n(Te4[(temp ) & 0xff] & 0x000000ff);\r\nrk[13] = rk[ 5] ^ rk[12];\r\nrk[14] = rk[ 6] ^ rk[13];\r\nrk[15] = rk[ 7] ^ rk[14];\r\nrk += 8;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic gint rijndaelKeySetupDec(\r\nguint32 rk[],\r\nconst guint8 cipherKey[],\r\ngint keyBits)\r\n{\r\ngint Nr, i, j;\r\nguint32 temp;\r\nNr = rijndaelKeySetupEnc(rk, cipherKey, keyBits);\r\nfor (i = 0, j = 4*Nr; i < j; i += 4, j -= 4) {\r\ntemp = rk[i ]; rk[i ] = rk[j ]; rk[j ] = temp;\r\ntemp = rk[i + 1]; rk[i + 1] = rk[j + 1]; rk[j + 1] = temp;\r\ntemp = rk[i + 2]; rk[i + 2] = rk[j + 2]; rk[j + 2] = temp;\r\ntemp = rk[i + 3]; rk[i + 3] = rk[j + 3]; rk[j + 3] = temp;\r\n}\r\nfor (i = 1; i < Nr; i++) {\r\nrk += 4;\r\nrk[0] =\r\nTd0[Te4[(rk[0] >> 24) ] & 0xff] ^\r\nTd1[Te4[(rk[0] >> 16) & 0xff] & 0xff] ^\r\nTd2[Te4[(rk[0] >> 8) & 0xff] & 0xff] ^\r\nTd3[Te4[(rk[0] ) & 0xff] & 0xff];\r\nrk[1] =\r\nTd0[Te4[(rk[1] >> 24) ] & 0xff] ^\r\nTd1[Te4[(rk[1] >> 16) & 0xff] & 0xff] ^\r\nTd2[Te4[(rk[1] >> 8) & 0xff] & 0xff] ^\r\nTd3[Te4[(rk[1] ) & 0xff] & 0xff];\r\nrk[2] =\r\nTd0[Te4[(rk[2] >> 24) ] & 0xff] ^\r\nTd1[Te4[(rk[2] >> 16) & 0xff] & 0xff] ^\r\nTd2[Te4[(rk[2] >> 8) & 0xff] & 0xff] ^\r\nTd3[Te4[(rk[2] ) & 0xff] & 0xff];\r\nrk[3] =\r\nTd0[Te4[(rk[3] >> 24) ] & 0xff] ^\r\nTd1[Te4[(rk[3] >> 16) & 0xff] & 0xff] ^\r\nTd2[Te4[(rk[3] >> 8) & 0xff] & 0xff] ^\r\nTd3[Te4[(rk[3] ) & 0xff] & 0xff];\r\n}\r\nreturn Nr;\r\n}\r\nvoid rijndael_set_key(\r\nrijndael_ctx *ctx,\r\nconst guchar *key,\r\ngint bits)\r\n{\r\nctx->Nr = rijndaelKeySetupEnc(ctx->ek, key, bits);\r\nrijndaelKeySetupDec(ctx->dk, key, bits);\r\n}\r\nstatic void rijndaelEncrypt(\r\nconst guint32 rk[],\r\ngint Nr,\r\nconst guint8 pt[16],\r\nguint8 ct[16])\r\n{\r\nguint32 s0, s1, s2, s3, t0, t1, t2, t3;\r\n#ifndef FULL_UNROLL\r\ngint r;\r\n#endif\r\ns0 = GETU32(pt ) ^ rk[0];\r\ns1 = GETU32(pt + 4) ^ rk[1];\r\ns2 = GETU32(pt + 8) ^ rk[2];\r\ns3 = GETU32(pt + 12) ^ rk[3];\r\n#ifdef FULL_UNROLL\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[ 4];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[ 5];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[ 6];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[ 7];\r\ns0 = Te0[t0 >> 24] ^ Te1[(t1 >> 16) & 0xff] ^ Te2[(t2 >> 8) & 0xff] ^ Te3[t3 & 0xff] ^ rk[ 8];\r\ns1 = Te0[t1 >> 24] ^ Te1[(t2 >> 16) & 0xff] ^ Te2[(t3 >> 8) & 0xff] ^ Te3[t0 & 0xff] ^ rk[ 9];\r\ns2 = Te0[t2 >> 24] ^ Te1[(t3 >> 16) & 0xff] ^ Te2[(t0 >> 8) & 0xff] ^ Te3[t1 & 0xff] ^ rk[10];\r\ns3 = Te0[t3 >> 24] ^ Te1[(t0 >> 16) & 0xff] ^ Te2[(t1 >> 8) & 0xff] ^ Te3[t2 & 0xff] ^ rk[11];\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[12];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[13];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[14];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[15];\r\ns0 = Te0[t0 >> 24] ^ Te1[(t1 >> 16) & 0xff] ^ Te2[(t2 >> 8) & 0xff] ^ Te3[t3 & 0xff] ^ rk[16];\r\ns1 = Te0[t1 >> 24] ^ Te1[(t2 >> 16) & 0xff] ^ Te2[(t3 >> 8) & 0xff] ^ Te3[t0 & 0xff] ^ rk[17];\r\ns2 = Te0[t2 >> 24] ^ Te1[(t3 >> 16) & 0xff] ^ Te2[(t0 >> 8) & 0xff] ^ Te3[t1 & 0xff] ^ rk[18];\r\ns3 = Te0[t3 >> 24] ^ Te1[(t0 >> 16) & 0xff] ^ Te2[(t1 >> 8) & 0xff] ^ Te3[t2 & 0xff] ^ rk[19];\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[20];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[21];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[22];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[23];\r\ns0 = Te0[t0 >> 24] ^ Te1[(t1 >> 16) & 0xff] ^ Te2[(t2 >> 8) & 0xff] ^ Te3[t3 & 0xff] ^ rk[24];\r\ns1 = Te0[t1 >> 24] ^ Te1[(t2 >> 16) & 0xff] ^ Te2[(t3 >> 8) & 0xff] ^ Te3[t0 & 0xff] ^ rk[25];\r\ns2 = Te0[t2 >> 24] ^ Te1[(t3 >> 16) & 0xff] ^ Te2[(t0 >> 8) & 0xff] ^ Te3[t1 & 0xff] ^ rk[26];\r\ns3 = Te0[t3 >> 24] ^ Te1[(t0 >> 16) & 0xff] ^ Te2[(t1 >> 8) & 0xff] ^ Te3[t2 & 0xff] ^ rk[27];\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[28];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[29];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[30];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[31];\r\ns0 = Te0[t0 >> 24] ^ Te1[(t1 >> 16) & 0xff] ^ Te2[(t2 >> 8) & 0xff] ^ Te3[t3 & 0xff] ^ rk[32];\r\ns1 = Te0[t1 >> 24] ^ Te1[(t2 >> 16) & 0xff] ^ Te2[(t3 >> 8) & 0xff] ^ Te3[t0 & 0xff] ^ rk[33];\r\ns2 = Te0[t2 >> 24] ^ Te1[(t3 >> 16) & 0xff] ^ Te2[(t0 >> 8) & 0xff] ^ Te3[t1 & 0xff] ^ rk[34];\r\ns3 = Te0[t3 >> 24] ^ Te1[(t0 >> 16) & 0xff] ^ Te2[(t1 >> 8) & 0xff] ^ Te3[t2 & 0xff] ^ rk[35];\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[36];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[37];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[38];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[39];\r\nif (Nr > 10) {\r\ns0 = Te0[t0 >> 24] ^ Te1[(t1 >> 16) & 0xff] ^ Te2[(t2 >> 8) & 0xff] ^ Te3[t3 & 0xff] ^ rk[40];\r\ns1 = Te0[t1 >> 24] ^ Te1[(t2 >> 16) & 0xff] ^ Te2[(t3 >> 8) & 0xff] ^ Te3[t0 & 0xff] ^ rk[41];\r\ns2 = Te0[t2 >> 24] ^ Te1[(t3 >> 16) & 0xff] ^ Te2[(t0 >> 8) & 0xff] ^ Te3[t1 & 0xff] ^ rk[42];\r\ns3 = Te0[t3 >> 24] ^ Te1[(t0 >> 16) & 0xff] ^ Te2[(t1 >> 8) & 0xff] ^ Te3[t2 & 0xff] ^ rk[43];\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[44];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[45];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[46];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[47];\r\nif (Nr > 12) {\r\ns0 = Te0[t0 >> 24] ^ Te1[(t1 >> 16) & 0xff] ^ Te2[(t2 >> 8) & 0xff] ^ Te3[t3 & 0xff] ^ rk[48];\r\ns1 = Te0[t1 >> 24] ^ Te1[(t2 >> 16) & 0xff] ^ Te2[(t3 >> 8) & 0xff] ^ Te3[t0 & 0xff] ^ rk[49];\r\ns2 = Te0[t2 >> 24] ^ Te1[(t3 >> 16) & 0xff] ^ Te2[(t0 >> 8) & 0xff] ^ Te3[t1 & 0xff] ^ rk[50];\r\ns3 = Te0[t3 >> 24] ^ Te1[(t0 >> 16) & 0xff] ^ Te2[(t1 >> 8) & 0xff] ^ Te3[t2 & 0xff] ^ rk[51];\r\nt0 = Te0[s0 >> 24] ^ Te1[(s1 >> 16) & 0xff] ^ Te2[(s2 >> 8) & 0xff] ^ Te3[s3 & 0xff] ^ rk[52];\r\nt1 = Te0[s1 >> 24] ^ Te1[(s2 >> 16) & 0xff] ^ Te2[(s3 >> 8) & 0xff] ^ Te3[s0 & 0xff] ^ rk[53];\r\nt2 = Te0[s2 >> 24] ^ Te1[(s3 >> 16) & 0xff] ^ Te2[(s0 >> 8) & 0xff] ^ Te3[s1 & 0xff] ^ rk[54];\r\nt3 = Te0[s3 >> 24] ^ Te1[(s0 >> 16) & 0xff] ^ Te2[(s1 >> 8) & 0xff] ^ Te3[s2 & 0xff] ^ rk[55];\r\n}\r\n}\r\nrk += Nr << 2;\r\n#else\r\nr = Nr >> 1;\r\nfor (;;) {\r\nt0 =\r\nTe0[(s0 >> 24) ] ^\r\nTe1[(s1 >> 16) & 0xff] ^\r\nTe2[(s2 >> 8) & 0xff] ^\r\nTe3[(s3 ) & 0xff] ^\r\nrk[4];\r\nt1 =\r\nTe0[(s1 >> 24) ] ^\r\nTe1[(s2 >> 16) & 0xff] ^\r\nTe2[(s3 >> 8) & 0xff] ^\r\nTe3[(s0 ) & 0xff] ^\r\nrk[5];\r\nt2 =\r\nTe0[(s2 >> 24) ] ^\r\nTe1[(s3 >> 16) & 0xff] ^\r\nTe2[(s0 >> 8) & 0xff] ^\r\nTe3[(s1 ) & 0xff] ^\r\nrk[6];\r\nt3 =\r\nTe0[(s3 >> 24) ] ^\r\nTe1[(s0 >> 16) & 0xff] ^\r\nTe2[(s1 >> 8) & 0xff] ^\r\nTe3[(s2 ) & 0xff] ^\r\nrk[7];\r\nrk += 8;\r\nif (--r == 0) {\r\nbreak;\r\n}\r\ns0 =\r\nTe0[(t0 >> 24) ] ^\r\nTe1[(t1 >> 16) & 0xff] ^\r\nTe2[(t2 >> 8) & 0xff] ^\r\nTe3[(t3 ) & 0xff] ^\r\nrk[0];\r\ns1 =\r\nTe0[(t1 >> 24) ] ^\r\nTe1[(t2 >> 16) & 0xff] ^\r\nTe2[(t3 >> 8) & 0xff] ^\r\nTe3[(t0 ) & 0xff] ^\r\nrk[1];\r\ns2 =\r\nTe0[(t2 >> 24) ] ^\r\nTe1[(t3 >> 16) & 0xff] ^\r\nTe2[(t0 >> 8) & 0xff] ^\r\nTe3[(t1 ) & 0xff] ^\r\nrk[2];\r\ns3 =\r\nTe0[(t3 >> 24) ] ^\r\nTe1[(t0 >> 16) & 0xff] ^\r\nTe2[(t1 >> 8) & 0xff] ^\r\nTe3[(t2 ) & 0xff] ^\r\nrk[3];\r\n}\r\n#endif\r\ns0 =\r\n(Te4[(t0 >> 24) ] & 0xff000000) ^\r\n(Te4[(t1 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Te4[(t2 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Te4[(t3 ) & 0xff] & 0x000000ff) ^\r\nrk[0];\r\nPUTU32(ct , s0);\r\ns1 =\r\n(Te4[(t1 >> 24) ] & 0xff000000) ^\r\n(Te4[(t2 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Te4[(t3 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Te4[(t0 ) & 0xff] & 0x000000ff) ^\r\nrk[1];\r\nPUTU32(ct + 4, s1);\r\ns2 =\r\n(Te4[(t2 >> 24) ] & 0xff000000) ^\r\n(Te4[(t3 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Te4[(t0 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Te4[(t1 ) & 0xff] & 0x000000ff) ^\r\nrk[2];\r\nPUTU32(ct + 8, s2);\r\ns3 =\r\n(Te4[(t3 >> 24) ] & 0xff000000) ^\r\n(Te4[(t0 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Te4[(t1 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Te4[(t2 ) & 0xff] & 0x000000ff) ^\r\nrk[3];\r\nPUTU32(ct + 12, s3);\r\n}\r\nvoid rijndael_encrypt(\r\nconst rijndael_ctx *ctx,\r\nconst guchar *src,\r\nguchar *dst)\r\n{\r\nrijndaelEncrypt(ctx->ek, ctx->Nr, src, dst);\r\n}\r\nstatic void rijndaelDecrypt(const guint32 rk[], gint Nr, const guint8 ct[16], guint8 pt[16]) {\r\nguint32 s0, s1, s2, s3, t0, t1, t2, t3;\r\n#ifndef FULL_UNROLL\r\ngint r;\r\n#endif\r\ns0 = GETU32(ct ) ^ rk[0];\r\ns1 = GETU32(ct + 4) ^ rk[1];\r\ns2 = GETU32(ct + 8) ^ rk[2];\r\ns3 = GETU32(ct + 12) ^ rk[3];\r\n#ifdef FULL_UNROLL\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[ 4];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[ 5];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[ 6];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[ 7];\r\ns0 = Td0[t0 >> 24] ^ Td1[(t3 >> 16) & 0xff] ^ Td2[(t2 >> 8) & 0xff] ^ Td3[t1 & 0xff] ^ rk[ 8];\r\ns1 = Td0[t1 >> 24] ^ Td1[(t0 >> 16) & 0xff] ^ Td2[(t3 >> 8) & 0xff] ^ Td3[t2 & 0xff] ^ rk[ 9];\r\ns2 = Td0[t2 >> 24] ^ Td1[(t1 >> 16) & 0xff] ^ Td2[(t0 >> 8) & 0xff] ^ Td3[t3 & 0xff] ^ rk[10];\r\ns3 = Td0[t3 >> 24] ^ Td1[(t2 >> 16) & 0xff] ^ Td2[(t1 >> 8) & 0xff] ^ Td3[t0 & 0xff] ^ rk[11];\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[12];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[13];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[14];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[15];\r\ns0 = Td0[t0 >> 24] ^ Td1[(t3 >> 16) & 0xff] ^ Td2[(t2 >> 8) & 0xff] ^ Td3[t1 & 0xff] ^ rk[16];\r\ns1 = Td0[t1 >> 24] ^ Td1[(t0 >> 16) & 0xff] ^ Td2[(t3 >> 8) & 0xff] ^ Td3[t2 & 0xff] ^ rk[17];\r\ns2 = Td0[t2 >> 24] ^ Td1[(t1 >> 16) & 0xff] ^ Td2[(t0 >> 8) & 0xff] ^ Td3[t3 & 0xff] ^ rk[18];\r\ns3 = Td0[t3 >> 24] ^ Td1[(t2 >> 16) & 0xff] ^ Td2[(t1 >> 8) & 0xff] ^ Td3[t0 & 0xff] ^ rk[19];\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[20];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[21];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[22];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[23];\r\ns0 = Td0[t0 >> 24] ^ Td1[(t3 >> 16) & 0xff] ^ Td2[(t2 >> 8) & 0xff] ^ Td3[t1 & 0xff] ^ rk[24];\r\ns1 = Td0[t1 >> 24] ^ Td1[(t0 >> 16) & 0xff] ^ Td2[(t3 >> 8) & 0xff] ^ Td3[t2 & 0xff] ^ rk[25];\r\ns2 = Td0[t2 >> 24] ^ Td1[(t1 >> 16) & 0xff] ^ Td2[(t0 >> 8) & 0xff] ^ Td3[t3 & 0xff] ^ rk[26];\r\ns3 = Td0[t3 >> 24] ^ Td1[(t2 >> 16) & 0xff] ^ Td2[(t1 >> 8) & 0xff] ^ Td3[t0 & 0xff] ^ rk[27];\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[28];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[29];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[30];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[31];\r\ns0 = Td0[t0 >> 24] ^ Td1[(t3 >> 16) & 0xff] ^ Td2[(t2 >> 8) & 0xff] ^ Td3[t1 & 0xff] ^ rk[32];\r\ns1 = Td0[t1 >> 24] ^ Td1[(t0 >> 16) & 0xff] ^ Td2[(t3 >> 8) & 0xff] ^ Td3[t2 & 0xff] ^ rk[33];\r\ns2 = Td0[t2 >> 24] ^ Td1[(t1 >> 16) & 0xff] ^ Td2[(t0 >> 8) & 0xff] ^ Td3[t3 & 0xff] ^ rk[34];\r\ns3 = Td0[t3 >> 24] ^ Td1[(t2 >> 16) & 0xff] ^ Td2[(t1 >> 8) & 0xff] ^ Td3[t0 & 0xff] ^ rk[35];\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[36];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[37];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[38];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[39];\r\nif (Nr > 10) {\r\ns0 = Td0[t0 >> 24] ^ Td1[(t3 >> 16) & 0xff] ^ Td2[(t2 >> 8) & 0xff] ^ Td3[t1 & 0xff] ^ rk[40];\r\ns1 = Td0[t1 >> 24] ^ Td1[(t0 >> 16) & 0xff] ^ Td2[(t3 >> 8) & 0xff] ^ Td3[t2 & 0xff] ^ rk[41];\r\ns2 = Td0[t2 >> 24] ^ Td1[(t1 >> 16) & 0xff] ^ Td2[(t0 >> 8) & 0xff] ^ Td3[t3 & 0xff] ^ rk[42];\r\ns3 = Td0[t3 >> 24] ^ Td1[(t2 >> 16) & 0xff] ^ Td2[(t1 >> 8) & 0xff] ^ Td3[t0 & 0xff] ^ rk[43];\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[44];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[45];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[46];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[47];\r\nif (Nr > 12) {\r\ns0 = Td0[t0 >> 24] ^ Td1[(t3 >> 16) & 0xff] ^ Td2[(t2 >> 8) & 0xff] ^ Td3[t1 & 0xff] ^ rk[48];\r\ns1 = Td0[t1 >> 24] ^ Td1[(t0 >> 16) & 0xff] ^ Td2[(t3 >> 8) & 0xff] ^ Td3[t2 & 0xff] ^ rk[49];\r\ns2 = Td0[t2 >> 24] ^ Td1[(t1 >> 16) & 0xff] ^ Td2[(t0 >> 8) & 0xff] ^ Td3[t3 & 0xff] ^ rk[50];\r\ns3 = Td0[t3 >> 24] ^ Td1[(t2 >> 16) & 0xff] ^ Td2[(t1 >> 8) & 0xff] ^ Td3[t0 & 0xff] ^ rk[51];\r\nt0 = Td0[s0 >> 24] ^ Td1[(s3 >> 16) & 0xff] ^ Td2[(s2 >> 8) & 0xff] ^ Td3[s1 & 0xff] ^ rk[52];\r\nt1 = Td0[s1 >> 24] ^ Td1[(s0 >> 16) & 0xff] ^ Td2[(s3 >> 8) & 0xff] ^ Td3[s2 & 0xff] ^ rk[53];\r\nt2 = Td0[s2 >> 24] ^ Td1[(s1 >> 16) & 0xff] ^ Td2[(s0 >> 8) & 0xff] ^ Td3[s3 & 0xff] ^ rk[54];\r\nt3 = Td0[s3 >> 24] ^ Td1[(s2 >> 16) & 0xff] ^ Td2[(s1 >> 8) & 0xff] ^ Td3[s0 & 0xff] ^ rk[55];\r\n}\r\n}\r\nrk += Nr << 2;\r\n#else\r\nr = Nr >> 1;\r\nfor (;;) {\r\nt0 =\r\nTd0[(s0 >> 24) ] ^\r\nTd1[(s3 >> 16) & 0xff] ^\r\nTd2[(s2 >> 8) & 0xff] ^\r\nTd3[(s1 ) & 0xff] ^\r\nrk[4];\r\nt1 =\r\nTd0[(s1 >> 24) ] ^\r\nTd1[(s0 >> 16) & 0xff] ^\r\nTd2[(s3 >> 8) & 0xff] ^\r\nTd3[(s2 ) & 0xff] ^\r\nrk[5];\r\nt2 =\r\nTd0[(s2 >> 24) ] ^\r\nTd1[(s1 >> 16) & 0xff] ^\r\nTd2[(s0 >> 8) & 0xff] ^\r\nTd3[(s3 ) & 0xff] ^\r\nrk[6];\r\nt3 =\r\nTd0[(s3 >> 24) ] ^\r\nTd1[(s2 >> 16) & 0xff] ^\r\nTd2[(s1 >> 8) & 0xff] ^\r\nTd3[(s0 ) & 0xff] ^\r\nrk[7];\r\nrk += 8;\r\nif (--r == 0) {\r\nbreak;\r\n}\r\ns0 =\r\nTd0[(t0 >> 24) ] ^\r\nTd1[(t3 >> 16) & 0xff] ^\r\nTd2[(t2 >> 8) & 0xff] ^\r\nTd3[(t1 ) & 0xff] ^\r\nrk[0];\r\ns1 =\r\nTd0[(t1 >> 24) ] ^\r\nTd1[(t0 >> 16) & 0xff] ^\r\nTd2[(t3 >> 8) & 0xff] ^\r\nTd3[(t2 ) & 0xff] ^\r\nrk[1];\r\ns2 =\r\nTd0[(t2 >> 24) ] ^\r\nTd1[(t1 >> 16) & 0xff] ^\r\nTd2[(t0 >> 8) & 0xff] ^\r\nTd3[(t3 ) & 0xff] ^\r\nrk[2];\r\ns3 =\r\nTd0[(t3 >> 24) ] ^\r\nTd1[(t2 >> 16) & 0xff] ^\r\nTd2[(t1 >> 8) & 0xff] ^\r\nTd3[(t0 ) & 0xff] ^\r\nrk[3];\r\n}\r\n#endif\r\ns0 =\r\n(Td4[(t0 >> 24) ] & 0xff000000) ^\r\n(Td4[(t3 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Td4[(t2 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Td4[(t1 ) & 0xff] & 0x000000ff) ^\r\nrk[0];\r\nPUTU32(pt , s0);\r\ns1 =\r\n(Td4[(t1 >> 24) ] & 0xff000000) ^\r\n(Td4[(t0 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Td4[(t3 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Td4[(t2 ) & 0xff] & 0x000000ff) ^\r\nrk[1];\r\nPUTU32(pt + 4, s1);\r\ns2 =\r\n(Td4[(t2 >> 24) ] & 0xff000000) ^\r\n(Td4[(t1 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Td4[(t0 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Td4[(t3 ) & 0xff] & 0x000000ff) ^\r\nrk[2];\r\nPUTU32(pt + 8, s2);\r\ns3 =\r\n(Td4[(t3 >> 24) ] & 0xff000000) ^\r\n(Td4[(t2 >> 16) & 0xff] & 0x00ff0000) ^\r\n(Td4[(t1 >> 8) & 0xff] & 0x0000ff00) ^\r\n(Td4[(t0 ) & 0xff] & 0x000000ff) ^\r\nrk[3];\r\nPUTU32(pt + 12, s3);\r\n}\r\nvoid rijndael_decrypt(\r\nconst rijndael_ctx *ctx,\r\nconst guchar *src,\r\nguchar *dst)\r\n{\r\nrijndaelDecrypt(ctx->dk, ctx->Nr, src, dst);\r\n}\r\nvoid aes_cmac_encrypt_starts(aes_cmac_ctx *ctx, const guint8 *key, guint key_len)\r\n{\r\nif (ctx == NULL) {\r\nreturn;\r\n}\r\nif (key == NULL) {\r\nctx->key_len = 0;\r\nreturn;\r\n}\r\nctx->key_len = key_len;\r\nmemset(ctx->state, 0, key_len);\r\nctx->input_used = 0;\r\nctx->aes.Nr = rijndaelKeySetupEnc(ctx->aes.ek, key, key_len * 8);\r\n}\r\nvoid aes_cmac_encrypt_update(aes_cmac_ctx *ctx, const guint8 *input, guint length)\r\n{\r\nguint left ;\r\nif (ctx == NULL || input == NULL || ctx->key_len == 0) {\r\nreturn;\r\n}\r\nleft = ctx->key_len - ctx->input_used;\r\nif (length <= left) {\r\nmemcpy(&ctx->input[ctx->input_used], input, length);\r\nctx->input_used += length;\r\nreturn;\r\n}\r\nif (ctx->input_used > 0) {\r\nmemcpy(&ctx->input[ctx->input_used], input, left);\r\ninput += left;\r\nlength -= left;\r\nXOR_BLOCK(ctx->state, ctx->input, ctx->key_len);\r\nrijndael_encrypt(&(ctx->aes), ctx->state, ctx->state);\r\n}\r\nwhile (length > ctx->key_len) {\r\nXOR_BLOCK(ctx->state, input, ctx->key_len);\r\nrijndael_encrypt(&(ctx->aes), ctx->state, ctx->state);\r\ninput += ctx->key_len;\r\nlength -= ctx->key_len;\r\n}\r\nif (length > 0) {\r\nmemcpy(ctx->input, input, length);\r\nctx->input_used = length;\r\n}\r\n}\r\nstatic void sub_key_shift(guint8* sub_key, guint key_len)\r\n{\r\nguint8 carry = (sub_key[0] & 0x80);\r\nguint i;\r\nfor (i = 0; i < key_len - 1; i++)\r\nsub_key[i] = (sub_key[i] << 1) | (sub_key[i + 1] >> 7);\r\nsub_key[key_len - 1] <<= 1;\r\nif (carry)\r\nsub_key[key_len - 1] ^= 0x87;\r\n}\r\nvoid aes_cmac_encrypt_finish(aes_cmac_ctx *ctx, guint8 *output)\r\n{\r\nguint8 sub_key[RIJNDAEL_MAXKB];\r\nmemset(sub_key, 0, ctx->key_len);\r\nrijndael_encrypt(&(ctx->aes), sub_key, sub_key);\r\nsub_key_shift(sub_key, ctx->key_len);\r\nif (ctx->input_used == ctx->key_len) {\r\nXOR_BLOCK(sub_key, ctx->input, ctx->key_len);\r\n} else {\r\nsub_key_shift(sub_key, ctx->key_len);\r\nXOR_BLOCK(sub_key, ctx->input, ctx->input_used);\r\nsub_key[ctx->input_used] ^= 0x80;\r\n}\r\nXOR_BLOCK(ctx->state, sub_key, ctx->key_len);\r\nrijndael_encrypt(&(ctx->aes), ctx->state, output);\r\n}

static int\r\ndissect_krb4_string(packet_info *pinfo _U_, int hf_index, proto_tree *tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_tree_add_item(tree, hf_index, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\nwhile(tvb_get_guint8(tvb, offset)!=0){\r\noffset++;\r\n}\r\noffset++;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_krb4_kdc_request(packet_info *pinfo, proto_tree *tree, tvbuff_t *tvb, int offset, gboolean little_endian, int version)\r\n{\r\nnstime_t time_sec;\r\nguint8 lifetime;\r\nif(version==TRANSARC_SPECIAL_VERSION){\r\nproto_tree_add_item(tree, hf_krb4_unknown_transarc_blob, tvb, offset, 8, ENC_NA);\r\noffset+=8;\r\n}\r\noffset=dissect_krb4_string(pinfo, hf_krb4_name, tree, tvb, offset);\r\noffset=dissect_krb4_string(pinfo, hf_krb4_instance, tree, tvb, offset);\r\noffset=dissect_krb4_string(pinfo, hf_krb4_realm, tree, tvb, offset);\r\ntime_sec.secs=little_endian?tvb_get_letohl(tvb, offset):tvb_get_ntohl(tvb, offset);\r\ntime_sec.nsecs=0;\r\nproto_tree_add_time(tree, hf_krb4_time_sec, tvb, offset, 4, &time_sec);\r\noffset+=4;\r\nlifetime=tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(tree, hf_krb4_lifetime, tvb, offset, 1, lifetime, "%d (%d minutes)", lifetime, lifetime*5);\r\noffset++;\r\noffset=dissect_krb4_string(pinfo, hf_krb4_s_name, tree, tvb, offset);\r\noffset=dissect_krb4_string(pinfo, hf_krb4_s_instance, tree, tvb, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_krb4_kdc_reply(packet_info *pinfo, proto_tree *tree, tvbuff_t *tvb, int offset, gboolean little_endian)\r\n{\r\nnstime_t time_sec;\r\nguint32 length;\r\noffset=dissect_krb4_string(pinfo, hf_krb4_name, tree, tvb, offset);\r\noffset=dissect_krb4_string(pinfo, hf_krb4_instance, tree, tvb, offset);\r\noffset=dissect_krb4_string(pinfo, hf_krb4_realm, tree, tvb, offset);\r\ntime_sec.secs=little_endian?tvb_get_letohl(tvb, offset):tvb_get_ntohl(tvb, offset);\r\ntime_sec.nsecs=0;\r\nproto_tree_add_time(tree, hf_krb4_time_sec, tvb, offset, 4, &time_sec);\r\noffset+=4;\r\noffset++;\r\ntime_sec.secs=little_endian?tvb_get_letohl(tvb, offset):tvb_get_ntohl(tvb, offset);\r\ntime_sec.nsecs=0;\r\nproto_tree_add_time(tree, hf_krb4_exp_date, tvb, offset, 4, &time_sec);\r\noffset+=4;\r\nproto_tree_add_item(tree, hf_krb4_kvno, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nlength=little_endian?tvb_get_letohs(tvb, offset):tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_uint_format_value(tree, hf_krb4_length, tvb, offset, 2, length, "%d", length);\r\noffset+=2;\r\nproto_tree_add_item(tree, hf_krb4_encrypted_blob, tvb, offset, length, ENC_NA);\r\noffset+=length;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_krb4_appl_request(packet_info *pinfo, proto_tree *tree, tvbuff_t *tvb, int offset, gboolean little_endian)\r\n{\r\nguint8 tlen, rlen;\r\nnstime_t time_sec;\r\nguint8 lifetime;\r\nproto_tree_add_item(tree, hf_krb4_kvno, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\noffset=dissect_krb4_string(pinfo, hf_krb4_realm, tree, tvb, offset);\r\ntlen=tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_krb4_ticket_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nrlen=tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_krb4_request_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_krb4_ticket_blob, tvb, offset, tlen, ENC_NA);\r\noffset+=tlen;\r\nproto_tree_add_item(tree, hf_krb4_request_blob, tvb, offset, rlen, ENC_NA);\r\noffset+=rlen;\r\ntime_sec.secs=little_endian?tvb_get_letohl(tvb, offset):tvb_get_ntohl(tvb, offset);\r\ntime_sec.nsecs=0;\r\nproto_tree_add_time(tree, hf_krb4_req_date, tvb, offset, 4, &time_sec);\r\noffset+=4;\r\nlifetime=tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(tree, hf_krb4_lifetime, tvb, offset, 1, lifetime, "%d (%d minutes)", lifetime, lifetime*5);\r\noffset++;\r\noffset=dissect_krb4_string(pinfo, hf_krb4_s_name, tree, tvb, offset);\r\noffset=dissect_krb4_string(pinfo, hf_krb4_s_instance, tree, tvb, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_krb4_auth_msg_type(packet_info *pinfo, proto_tree *parent_tree, tvbuff_t *tvb, int offset, int version)\r\n{\r\nproto_tree *tree;\r\nproto_item *item;\r\nguint8 auth_msg_type;\r\nauth_msg_type=tvb_get_guint8(tvb, offset);\r\nitem = proto_tree_add_item(parent_tree, hf_krb4_auth_msg_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ntree = proto_item_add_subtree(item, ett_krb4_auth_msg_type);\r\nproto_tree_add_item(tree, hf_krb4_m_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s%s",\r\n(version==TRANSARC_SPECIAL_VERSION)?"TRANSARC-":"",\r\nval_to_str(auth_msg_type>>1, m_type_vals, "Unknown (0x%04x)"));\r\nproto_item_append_text(item, " %s%s",\r\n(version==TRANSARC_SPECIAL_VERSION)?"TRANSARC-":"",\r\nval_to_str(auth_msg_type>>1, m_type_vals, "Unknown (0x%04x)"));\r\nproto_tree_add_item(tree, hf_krb4_byte_order, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(item, " (%s)", val_to_str(auth_msg_type&0x01, byte_order_vals, "Unknown (0x%04x)"));\r\noffset++;\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ndissect_krb4(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, void *data _U_)\r\n{\r\nproto_tree *tree;\r\nproto_item *item;\r\nguint8 version, opcode;\r\nint offset = 0;\r\nversion=tvb_get_guint8(tvb, offset);\r\nif((version!=4)&&(version!=TRANSARC_SPECIAL_VERSION)){\r\nreturn FALSE;\r\n}\r\nopcode=tvb_get_guint8(tvb, offset+1);\r\nswitch(opcode>>1){\r\ncase AUTH_MSG_KDC_REQUEST:\r\ncase AUTH_MSG_KDC_REPLY:\r\ncase AUTH_MSG_APPL_REQUEST:\r\ncase AUTH_MSG_APPL_REQUEST_MUTUAL:\r\ncase AUTH_MSG_ERR_REPLY:\r\ncase AUTH_MSG_PRIVATE:\r\ncase AUTH_MSG_SAFE:\r\ncase AUTH_MSG_APPL_ERR:\r\ncase AUTH_MSG_DIE:\r\nbreak;\r\ndefault:\r\nreturn FALSE;\r\n}\r\nitem = proto_tree_add_item(parent_tree, proto_krb4, tvb, offset, -1, ENC_NA);\r\ntree = proto_item_add_subtree(item, ett_krb4);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "KRB4");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nproto_tree_add_item(tree, hf_krb4_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\noffset = dissect_krb4_auth_msg_type(pinfo, tree, tvb, offset, version);\r\nswitch(opcode>>1){\r\ncase AUTH_MSG_KDC_REQUEST:\r\ndissect_krb4_kdc_request(pinfo, tree, tvb, offset, opcode&0x01, version);\r\nbreak;\r\ncase AUTH_MSG_KDC_REPLY:\r\ndissect_krb4_kdc_reply(pinfo, tree, tvb, offset, opcode&0x01);\r\nbreak;\r\ncase AUTH_MSG_APPL_REQUEST:\r\ndissect_krb4_appl_request(pinfo, tree, tvb, offset, opcode&0x01);\r\nbreak;\r\ncase AUTH_MSG_APPL_REQUEST_MUTUAL:\r\ncase AUTH_MSG_ERR_REPLY:\r\ncase AUTH_MSG_PRIVATE:\r\ncase AUTH_MSG_SAFE:\r\ncase AUTH_MSG_APPL_ERR:\r\ncase AUTH_MSG_DIE:\r\nbreak;\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_krb4(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_krb4_version,\r\n{ "Version", "krb4.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Kerberos(v4) version number", HFILL }},\r\n{ &hf_krb4_auth_msg_type,\r\n{ "Msg Type", "krb4.auth_msg_type",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\n"Message Type/Byte Order", HFILL }},\r\n{ &hf_krb4_m_type,\r\n{ "M Type", "krb4.m_type",\r\nFT_UINT8, BASE_HEX, VALS(m_type_vals), 0xfe,\r\n"Message Type", HFILL }},\r\n{ &hf_krb4_byte_order,\r\n{ "Byte Order", "krb4.byte_order",\r\nFT_UINT8, BASE_HEX, VALS(byte_order_vals), 0x01,\r\nNULL, HFILL }},\r\n{ &hf_krb4_name,\r\n{ "Name", "krb4.name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_instance,\r\n{ "Instance", "krb4.instance",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_realm,\r\n{ "Realm", "krb4.realm",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_time_sec,\r\n{ "Time Sec", "krb4.time_sec",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_exp_date,\r\n{ "Exp Date", "krb4.exp_date",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_req_date,\r\n{ "Req Date", "krb4.req_date",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_lifetime,\r\n{ "Lifetime", "krb4.lifetime",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\n"Lifetime (in 5 min units)", HFILL }},\r\n{ &hf_krb4_s_name,\r\n{ "Service Name", "krb4.s_name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_s_instance,\r\n{ "Service Instance", "krb4.s_instance",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_kvno,\r\n{ "Kvno", "krb4.kvno",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\n"Key Version No", HFILL }},\r\n{ &hf_krb4_length,\r\n{ "Length", "krb4.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\n"Length of encrypted blob", HFILL }},\r\n{ &hf_krb4_ticket_length,\r\n{ "Ticket Length", "krb4.ticket.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\n"Length of ticket", HFILL }},\r\n{ &hf_krb4_request_length,\r\n{ "Request Length", "krb4.request.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\n"Length of request", HFILL }},\r\n{ &hf_krb4_ticket_blob,\r\n{ "Ticket Blob", "krb4.ticket.blob",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_request_blob,\r\n{ "Request Blob", "krb4.request.blob",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_encrypted_blob,\r\n{ "Encrypted Blob", "krb4.encrypted_blob",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_krb4_unknown_transarc_blob,\r\n{ "Unknown Transarc Blob", "krb4.unknown_transarc_blob",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\n"Unknown blob only present in Transarc packets", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_krb4,\r\n&ett_krb4_auth_msg_type,\r\n};\r\nproto_krb4 = proto_register_protocol("Kerberos v4",\r\n"KRB4", "krb4");\r\nregister_dissector("krb4", dissect_krb4, proto_krb4);\r\nproto_register_field_array(proto_krb4, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_krb4(void)\r\n{\r\ndissector_handle_t krb4_handle;\r\nkrb4_handle = find_dissector("krb4");\r\ndissector_add_uint("udp.port", UDP_PORT_KRB4, krb4_handle);\r\n}

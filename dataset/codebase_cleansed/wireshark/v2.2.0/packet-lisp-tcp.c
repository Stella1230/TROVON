static int\r\ndissect_lisp_tcp_membership_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *message_tree,\r\nguint offset, guint16 type, guint16 data_len, proto_item *tim)\r\n{\r\nguint32 iid, sid, rid;\r\nguint8 err;\r\nguint64 siteid;\r\nguint16 afi;\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_eid_afi, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ndata_len -= 2;\r\niid = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_iid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndata_len -= 4;\r\nproto_item_append_text(tim, ", IID: %u", iid);\r\nswitch (type) {\r\ncase MEMBERSHIP_BASE + 1:\r\ncase MEMBERSHIP_BASE + 2:\r\nsid = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_sid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndata_len -= 4;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Sub ID: %u", sid);\r\nproto_item_append_text(tim, ", Sub ID: %u", sid);\r\nif (type == MEMBERSHIP_BASE + 2) {\r\nerr = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_err, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ndata_len -= 1;\r\nproto_item_append_text(tim, ", Error code: %s",\r\nval_to_str(err, lisp_tcp_membership_subscribe_errors, "Unknown error code (%u)"));\r\n}\r\nbreak;\r\ncase MEMBERSHIP_BASE + 4:\r\ncase MEMBERSHIP_BASE + 5:\r\nsiteid = tvb_get_ntoh64(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_site_id, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\ndata_len -= 8;\r\nproto_item_append_text(tim, ", Site-ID: %"G_GINT64_MODIFIER"u", siteid);\r\nafi = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_rloc_afi, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ndata_len -= 2;\r\nswitch (afi) {\r\ncase AFNUM_INET:\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_rloc_ipv4, tvb, offset, INET_ADDRLEN, ENC_NA);\r\nproto_item_append_text(tim, ", RLOC: %s", tvb_ip_to_str(tvb, offset));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%u] %s", iid, tvb_ip_to_str(tvb, offset));\r\noffset += INET_ADDRLEN;\r\ndata_len -= INET_ADDRLEN;\r\nbreak;\r\ncase AFNUM_INET6:\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_rloc_ipv6, tvb, offset, INET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(tim, ", RLOC: %s", tvb_ip6_to_str(tvb, offset));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%u] %s", iid, tvb_ip6_to_str(tvb, offset));\r\noffset += INET6_ADDRLEN;\r\ndata_len -= INET6_ADDRLEN;\r\nbreak;\r\n}\r\nbreak;\r\ncase MEMBERSHIP_BASE + 7:\r\ncase MEMBERSHIP_BASE + 8:\r\nrid = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_rid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndata_len -= 4;\r\nproto_item_append_text(tim, ", Req ID: %u", rid);\r\nbreak;\r\n}\r\nif (data_len) {\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_data, tvb, offset, data_len, ENC_NA);\r\noffset += data_len;\r\nexpert_add_info_format(pinfo, message_tree, &ei_lisp_tcp_undecoded, "Work-in-progress");\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_lisp_tcp_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nguint offset = 0;\r\nguint16 type, len, data_len;\r\nguint32 id, marker;\r\nproto_item *tim, *til, *tiem;\r\nproto_tree *message_tree;\r\ntim = proto_tree_add_item(tree, proto_lisp_tcp, tvb, offset, -1, ENC_NA);\r\nmessage_tree = proto_item_add_subtree(tim, ett_lisp_tcp);\r\ntype = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nlen = tvb_get_ntohs(tvb, offset);\r\ntil = proto_tree_add_item(message_tree, hf_lisp_tcp_message_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (len < 8) {\r\nexpert_add_info_format(pinfo, til, &ei_lisp_tcp_invalid_length,\r\n"Invalid message length (%u < 8)", len);\r\n} else if (len > 8) {\r\nid = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, "; ", "Msg: %u, %s", id, val_to_str(type, lisp_tcp_typevals,\r\n"Unknown type (%u)"));\r\nproto_item_append_text(tim, ", Msg: %u, %s", id, val_to_str(type, lisp_tcp_typevals,\r\n"Unknown type (%u)"));\r\nproto_item_set_len(tim, len);\r\ndata_len = len - 12;\r\nif (type >= MEMBERSHIP_BASE && type <= MEMBERSHIP_BASE + 8) {\r\noffset = dissect_lisp_tcp_membership_message(tvb, pinfo, message_tree, offset, type, data_len, tim);\r\n} else {\r\nproto_tree_add_item(message_tree, hf_lisp_tcp_message_data, tvb, offset, data_len, ENC_NA);\r\noffset += data_len;\r\n}\r\n}\r\nmarker = tvb_get_ntohl(tvb, offset);\r\ntiem = proto_tree_add_item(message_tree, hf_lisp_tcp_message_end_marker, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (marker != LISP_MSG_END_MARKER) {\r\nexpert_add_info_format(pinfo, tiem, &ei_lisp_tcp_invalid_marker,\r\n"Invalid message end marker (0x%08x)", marker);\r\n} else {\r\nproto_item_append_text(tiem, " (correct)");\r\n}\r\nreturn offset;\r\n}\r\nstatic guint\r\nget_lisp_tcp_message_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint16 mlen;\r\nmlen = tvb_get_ntohs(tvb, offset + 2);\r\nreturn mlen;\r\n}\r\nstatic int\r\ndissect_lisp_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LISP");\r\ntcp_dissect_pdus(tvb, pinfo, tree, lisp_tcp_desegment, LISP_MSG_HEADER_LEN,\r\nget_lisp_tcp_message_len, dissect_lisp_tcp_message, data);\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_lisp_tcp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_lisp_tcp_message_type,\r\n{ "Type", "lisp-tcp.message.type",\r\nFT_UINT16, BASE_DEC, VALS(lisp_tcp_typevals), 0x0, "TLV Message Type", HFILL }},\r\n{ &hf_lisp_tcp_message_length,\r\n{ "Length", "lisp-tcp.message.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, "TLV Message Length", HFILL }},\r\n{ &hf_lisp_tcp_message_id,\r\n{ "Message ID", "lisp-tcp.message.id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_data,\r\n{ "Message Data", "lisp-tcp.message.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_eid_afi,\r\n{ "EID AFI", "lisp-tcp.message.eid.afi",\r\nFT_UINT16, BASE_DEC, VALS(afn_vals), 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_iid,\r\n{ "Instance ID", "lisp-tcp.message.iid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_sid,\r\n{ "Subscribe Message ID", "lisp-tcp.message.sid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_err,\r\n{ "Error code", "lisp-tcp.message.err",\r\nFT_UINT8, BASE_DEC, VALS(lisp_tcp_membership_subscribe_errors), 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_site_id,\r\n{ "Site-ID", "lisp-tcp.message.site_id",\r\nFT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_rloc_afi,\r\n{ "RLOC AFI", "lisp-tcp.message.rloc.afi",\r\nFT_UINT16, BASE_DEC, VALS(afn_vals), 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_rloc_ipv4,\r\n{ "RLOC", "lisp-tcp.message.rloc.ipv4",\r\nFT_IPv4, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_rloc_ipv6,\r\n{ "RLOC", "lisp-tcp.message.rloc.ipv6",\r\nFT_IPv6, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_rid,\r\n{ "Request Message ID", "lisp-tcp.message.rid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_lisp_tcp_message_end_marker,\r\n{ "Message End Marker", "lisp-tcp.message.end_marker",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_lisp_tcp\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_lisp_tcp_undecoded, { "lisp-tcp.undecoded", PI_UNDECODED, PI_WARN, "Not dissected yet (report to wireshark.org)", EXPFILL }},\r\n{ &ei_lisp_tcp_invalid_length, { "lisp-tcp.invalid_marker", PI_PROTOCOL, PI_ERROR, "Invalid message length", EXPFILL }},\r\n{ &ei_lisp_tcp_invalid_marker, { "lisp-tcp.invalid_marker", PI_PROTOCOL, PI_ERROR, "Invalid message end marker", EXPFILL }},\r\n};\r\nexpert_module_t* expert_lisp_tcp;\r\nproto_lisp_tcp = proto_register_protocol("Locator/ID Separation Protocol (Reliable Transport)",\r\n"LISP Reliable Transport", "lisp-tcp");\r\nproto_register_field_array(proto_lisp_tcp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_lisp_tcp = expert_register_protocol(proto_lisp_tcp);\r\nexpert_register_field_array(expert_lisp_tcp, ei, array_length(ei));\r\nlisp_tcp_handle = register_dissector("lisp-tcp", dissect_lisp_tcp, proto_lisp_tcp);\r\n}\r\nvoid\r\nproto_reg_handoff_lisp_tcp(void)\r\n{\r\ndissector_add_uint("tcp.port", LISP_CONTROL_PORT, lisp_tcp_handle);\r\n}

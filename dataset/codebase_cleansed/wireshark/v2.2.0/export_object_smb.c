static void\r\ninsert_chunk(active_file *file, export_object_entry_t *entry, const smb_eo_t *eo_info)\r\n{\r\ngint nfreechunks = g_slist_length(file->free_chunk_list);\r\ngint i;\r\nfree_chunk *current_free_chunk;\r\nfree_chunk *new_free_chunk;\r\nguint64 chunk_offset = eo_info->smb_file_offset;\r\nguint64 chunk_length = eo_info->payload_len;\r\nguint64 chunk_end_offset = chunk_offset + chunk_length-1;\r\nguint64 calculated_size = chunk_offset + chunk_length;\r\ngpointer dest_memory_addr;\r\nif ((file->data_gathered == 0) && (nfreechunks == 0)) {\r\nnew_free_chunk = (free_chunk *)g_malloc(sizeof(free_chunk));\r\nnew_free_chunk->start_offset = 0;\r\nnew_free_chunk->end_offset = MAX(file->file_length, chunk_end_offset+1) - 1;\r\nfile->free_chunk_list = NULL;\r\nfile->free_chunk_list = g_slist_append(file->free_chunk_list, new_free_chunk);\r\nnfreechunks += 1;\r\n} else {\r\nif (chunk_end_offset > file->file_length-1) {\r\nnew_free_chunk = (free_chunk *)g_malloc(sizeof(free_chunk));\r\nnew_free_chunk->start_offset = file->file_length;\r\nnew_free_chunk->end_offset = chunk_end_offset;\r\nfile->free_chunk_list = g_slist_append(file->free_chunk_list, new_free_chunk);\r\nnfreechunks += 1;\r\n}\r\n}\r\nfile->file_length = MAX(file->file_length, chunk_end_offset+1);\r\nfor (i=0; i<nfreechunks; i++) {\r\ncurrent_free_chunk = (free_chunk *)g_slist_nth_data(file->free_chunk_list, i);\r\nif (chunk_end_offset<current_free_chunk->start_offset) {\r\ncontinue;\r\n}\r\nif (chunk_offset<=current_free_chunk->start_offset && chunk_end_offset>=current_free_chunk->start_offset && chunk_end_offset<current_free_chunk->end_offset) {\r\nfile->data_gathered += chunk_end_offset-current_free_chunk->start_offset+1;\r\ncurrent_free_chunk->start_offset=chunk_end_offset+1;\r\ncontinue;\r\n}\r\nif (chunk_offset<=current_free_chunk->start_offset && chunk_end_offset>=current_free_chunk->end_offset) {\r\nfile->data_gathered += current_free_chunk->end_offset-current_free_chunk->start_offset+1;\r\nfile->free_chunk_list = g_slist_remove(file->free_chunk_list, current_free_chunk);\r\nnfreechunks -= 1;\r\nif (nfreechunks == 0) {\r\ng_slist_free(file->free_chunk_list);\r\nfile->free_chunk_list = NULL;\r\nbreak;\r\n}\r\ni--;\r\ncontinue;\r\n}\r\nif (chunk_offset>current_free_chunk->start_offset && chunk_end_offset<current_free_chunk->end_offset) {\r\nnew_free_chunk = (free_chunk *)g_malloc(sizeof(free_chunk));\r\nnew_free_chunk->start_offset = chunk_end_offset + 1;\r\nnew_free_chunk->end_offset = current_free_chunk->end_offset;\r\ncurrent_free_chunk->end_offset = chunk_offset-1;\r\nfile->free_chunk_list = g_slist_insert(file->free_chunk_list, new_free_chunk, i + 1);\r\nfile->data_gathered += chunk_length;\r\ncontinue;\r\n}\r\nif (chunk_offset>current_free_chunk->start_offset && chunk_offset<=current_free_chunk->end_offset && chunk_end_offset>=current_free_chunk->end_offset) {\r\nfile->data_gathered += current_free_chunk->end_offset-chunk_offset+1;\r\ncurrent_free_chunk->end_offset = chunk_offset-1;\r\ncontinue;\r\n}\r\nif (chunk_offset>current_free_chunk->end_offset) {\r\ncontinue;\r\n}\r\n}\r\nif (!entry->payload_data) {\r\nif (calculated_size > G_MAXSIZE) {\r\nentry->payload_data = NULL;\r\n} else {\r\nentry->payload_data = (guint8 *)g_try_malloc((gsize)calculated_size);\r\nentry->payload_len = calculated_size;\r\n}\r\nif (!entry->payload_data) {\r\nfile->is_out_of_memory = TRUE;\r\n}\r\n} else {\r\nif (calculated_size > (guint64) entry->payload_len &&\r\n!file->is_out_of_memory) {\r\nif (calculated_size > G_MAXSIZE) {\r\ndest_memory_addr = NULL;\r\n} else {\r\ndest_memory_addr = g_try_realloc(\r\nentry->payload_data,\r\n(gsize)calculated_size);\r\n}\r\nif (!dest_memory_addr) {\r\nfile->is_out_of_memory = TRUE;\r\ng_free(entry->payload_data);\r\nentry->payload_data = NULL;\r\nentry->payload_len = 0;\r\n} else {\r\nentry->payload_data = (guint8 *)dest_memory_addr;\r\nentry->payload_len = calculated_size;\r\n}\r\n}\r\n}\r\nif (!file->is_out_of_memory) {\r\ndest_memory_addr = entry->payload_data + chunk_offset;\r\nmemmove(dest_memory_addr, eo_info->payload_data, eo_info->payload_len);\r\n}\r\n}\r\nstatic int\r\nfind_incoming_file(GSList *GSL_active_files_p, active_file *incoming_file)\r\n{\r\nint i, row, last;\r\nactive_file *in_list_file;\r\nrow = -1;\r\nlast = g_slist_length(GSL_active_files_p) - 1;\r\nfor (i=last; i>=0; i--) {\r\nin_list_file = (active_file *)g_slist_nth_data(GSL_active_files_p, i);\r\nif (in_list_file->tid == incoming_file->tid &&\r\nin_list_file->fid == incoming_file->fid) {\r\nrow = i;\r\nbreak;\r\n}\r\n}\r\nreturn row;\r\n}\r\ngboolean\r\neo_smb_packet(void *tapdata, packet_info *pinfo, epan_dissect_t *edt _U_, const void *data)\r\n{\r\nexport_object_list_t *object_list = (export_object_list_t *)tapdata;\r\nconst smb_eo_t *eo_info = (const smb_eo_t *)data;\r\nexport_object_entry_t *entry;\r\nexport_object_entry_t *current_entry;\r\nactive_file incoming_file;\r\ngint active_row;\r\nactive_file *new_file;\r\nactive_file *current_file;\r\nguint8 contains;\r\ngboolean is_supported_filetype;\r\ngfloat percent;\r\ngchar *aux_smb_fid_type_string;\r\nif (eo_info->smbversion==1) {\r\nis_supported_filetype = (eo_info->fid_type == SMB_FID_TYPE_FILE);\r\naux_smb_fid_type_string=g_strdup(try_val_to_str(eo_info->fid_type, smb_fid_types));\r\nswitch(eo_info->cmd) {\r\ncase SMB_COM_READ_ANDX:\r\ncase SMB_COM_READ:\r\ncontains = SMB_EO_CONTAINS_READS;\r\nbreak;\r\ncase SMB_COM_WRITE_ANDX:\r\ncase SMB_COM_WRITE:\r\ncontains = SMB_EO_CONTAINS_WRITES;\r\nbreak;\r\ndefault:\r\ncontains = SMB_EO_CONTAINS_NOTHING;\r\nbreak;\r\n}\r\n} else {\r\nis_supported_filetype = (eo_info->fid_type == SMB2_FID_TYPE_FILE );\r\naux_smb_fid_type_string=g_strdup(try_val_to_str(eo_info->fid_type, smb2_fid_types));\r\nswitch(eo_info->cmd) {\r\ncase SMB2_COM_READ:\r\ncontains = SMB_EO_CONTAINS_READS;\r\nbreak;\r\ncase SMB2_COM_WRITE:\r\ncontains = SMB_EO_CONTAINS_WRITES;\r\nbreak;\r\ndefault:\r\ncontains = SMB_EO_CONTAINS_NOTHING;\r\nbreak;\r\n}\r\n}\r\nincoming_file.tid = eo_info->tid;\r\nincoming_file.uid = eo_info->uid;\r\nincoming_file.fid = eo_info->fid;\r\nactive_row = find_incoming_file(GSL_active_files, &incoming_file);\r\nif (active_row == -1) {\r\nentry = (export_object_entry_t *)g_malloc(sizeof(export_object_entry_t));\r\nentry->payload_data = NULL;\r\nentry->payload_len = 0;\r\nnew_file = (active_file *)g_malloc(sizeof(active_file));\r\nnew_file->tid = incoming_file.tid;\r\nnew_file->uid = incoming_file.uid;\r\nnew_file->fid = incoming_file.fid;\r\nnew_file->file_length = eo_info->end_of_file;\r\nnew_file->flag_contains = contains;\r\nnew_file->free_chunk_list = NULL;\r\nnew_file->data_gathered = 0;\r\nnew_file->is_out_of_memory = FALSE;\r\nentry->pkt_num = pinfo->num;\r\nentry->hostname=g_filename_display_name(g_strcanon(eo_info->hostname,LEGAL_FILENAME_CHARS,'?'));\r\nentry->filename=g_filename_display_name(g_strcanon(eo_info->filename,LEGAL_FILENAME_CHARS,'?'));\r\nif (is_supported_filetype) {\r\ninsert_chunk(new_file, entry, eo_info);\r\n}\r\nif (new_file->is_out_of_memory) {\r\nentry->content_type =\r\ng_strdup_printf("%s (%"G_GUINT64_FORMAT"?/%"G_GUINT64_FORMAT") %s [mem!!]",\r\naux_smb_fid_type_string,\r\nnew_file->data_gathered,\r\nnew_file->file_length,\r\ntry_val_to_str(contains, smb_eo_contains_string));\r\n} else {\r\nif (new_file->file_length > 0) {\r\npercent = (gfloat) (100*new_file->data_gathered/new_file->file_length);\r\n} else {\r\npercent = 0.0f;\r\n}\r\nentry->content_type =\r\ng_strdup_printf("%s (%"G_GUINT64_FORMAT"/%"G_GUINT64_FORMAT") %s [%5.2f%%]",\r\naux_smb_fid_type_string,\r\nnew_file->data_gathered,\r\nnew_file->file_length,\r\ntry_val_to_str(contains, smb_eo_contains_string),\r\npercent);\r\n}\r\nobject_list_add_entry(object_list, entry);\r\nGSL_active_files = g_slist_append(GSL_active_files, new_file);\r\n}\r\nelse if (is_supported_filetype) {\r\ncurrent_file = (active_file *)g_slist_nth_data(GSL_active_files, active_row);\r\ncurrent_file->flag_contains = current_file->flag_contains|contains;\r\ncurrent_entry = object_list_get_entry(object_list, active_row);\r\ninsert_chunk(current_file, current_entry, eo_info);\r\nif (current_file->is_out_of_memory) {\r\ncurrent_entry->content_type =\r\ng_strdup_printf("%s (%"G_GUINT64_FORMAT"?/%"G_GUINT64_FORMAT") %s [mem!!]",\r\naux_smb_fid_type_string,\r\ncurrent_file->data_gathered,\r\ncurrent_file->file_length,\r\ntry_val_to_str(current_file->flag_contains, smb_eo_contains_string));\r\n} else {\r\npercent = (gfloat) (100*current_file->data_gathered/current_file->file_length);\r\ncurrent_entry->content_type =\r\ng_strdup_printf("%s (%"G_GUINT64_FORMAT"/%"G_GUINT64_FORMAT") %s [%5.2f%%]",\r\naux_smb_fid_type_string,\r\ncurrent_file->data_gathered,\r\ncurrent_file->file_length,\r\ntry_val_to_str(current_file->flag_contains, smb_eo_contains_string),\r\npercent);\r\n}\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\neo_smb_cleanup(void)\r\n{\r\nint i, last;\r\nactive_file *in_list_file;\r\nlast = g_slist_length(GSL_active_files);\r\nif (GSL_active_files) {\r\nfor (i=last-1; i>=0; i--) {\r\nin_list_file = (active_file *)g_slist_nth_data(GSL_active_files, i);\r\nif (in_list_file->free_chunk_list) {\r\ng_slist_free(in_list_file->free_chunk_list);\r\nin_list_file->free_chunk_list = NULL;\r\n}\r\ng_free(in_list_file);\r\n}\r\ng_slist_free(GSL_active_files);\r\nGSL_active_files = NULL;\r\n}\r\n}

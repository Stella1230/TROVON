void\r\ninit_process_policies(void)\r\n{\r\nHMODULE kernel32Handle;\r\ntypedef BOOL (WINAPI *SetProcessDEPPolicyHandler)(DWORD);\r\nSetProcessDEPPolicyHandler PSetProcessDEPPolicy;\r\n#ifndef PROCESS_DEP_ENABLE\r\n#define PROCESS_DEP_ENABLE 1\r\n#endif\r\nkernel32Handle = GetModuleHandle(_T("kernel32.dll"));\r\nif (kernel32Handle != NULL) {\r\nPSetProcessDEPPolicy = (SetProcessDEPPolicyHandler) GetProcAddress(kernel32Handle, "SetProcessDEPPolicy");\r\nif (PSetProcessDEPPolicy) {\r\nPSetProcessDEPPolicy(PROCESS_DEP_ENABLE);\r\n}\r\n}\r\n}\r\ngboolean\r\nstarted_with_special_privs(void)\r\n{\r\nreturn FALSE;\r\n}\r\ngboolean\r\nrunning_with_special_privs(void)\r\n{\r\nreturn FALSE;\r\n}\r\nvoid\r\nrelinquish_special_privs_perm(void)\r\n{\r\n}\r\ngchar *\r\nget_cur_username(void) {\r\ngchar *username;\r\nusername = g_strdup("UNKNOWN");\r\nreturn username;\r\n}\r\ngchar *\r\nget_cur_groupname(void) {\r\ngchar *groupname;\r\ngroupname = g_strdup("UNKNOWN");\r\nreturn groupname;\r\n}\r\nvoid\r\ninit_process_policies(void)\r\n{\r\nruid = getuid();\r\neuid = geteuid();\r\nrgid = getgid();\r\negid = getegid();\r\ninit_process_policies_called = TRUE;\r\n}\r\ngboolean\r\nstarted_with_special_privs(void)\r\n{\r\ng_assert(init_process_policies_called);\r\n#ifdef HAVE_ISSETUGID\r\nreturn issetugid();\r\n#else\r\nreturn (ruid != euid || rgid != egid || ruid == 0 || rgid == 0);\r\n#endif\r\n}\r\ngboolean\r\nrunning_with_special_privs(void)\r\n{\r\n#ifdef HAVE_SETRESUID\r\nuid_t ru, eu, su;\r\n#endif\r\n#ifdef HAVE_SETRESGID\r\ngid_t rg, eg, sg;\r\n#endif\r\n#ifdef HAVE_SETRESUID\r\ngetresuid(&ru, &eu, &su);\r\nif (ru == 0 || eu == 0 || su == 0)\r\nreturn TRUE;\r\n#else\r\nif (getuid() == 0 || geteuid() == 0)\r\nreturn TRUE;\r\n#endif\r\n#ifdef HAVE_SETRESGID\r\ngetresgid(&rg, &eg, &sg);\r\nif (rg == 0 || eg == 0 || sg == 0)\r\nreturn TRUE;\r\n#else\r\nif (getgid() == 0 || getegid() == 0)\r\nreturn TRUE;\r\n#endif\r\nreturn FALSE;\r\n}\r\nstatic void\r\nsetxid_fail(const gchar *str)\r\n{\r\ng_error("Attempt to relinguish privileges failed [%s()] - aborting: %s\n",\r\nstr, g_strerror(errno));\r\n}\r\nvoid\r\nrelinquish_special_privs_perm(void)\r\n{\r\nif (started_with_special_privs()) {\r\n#ifdef HAVE_SETRESGID\r\nif (setresgid(rgid, rgid, rgid) == -1) {setxid_fail("setresgid");}\r\n#else\r\nif (setgid(rgid) == -1) {setxid_fail("setgid"); }\r\nif (setegid(rgid) == -1) {setxid_fail("setegid");}\r\n#endif\r\n#ifdef HAVE_SETRESUID\r\nif (setresuid(ruid, ruid, ruid) == -1) {setxid_fail("setresuid");}\r\n#else\r\nif (setuid(ruid) == -1) {setxid_fail("setuid"); }\r\nif (seteuid(ruid) == -1) {setxid_fail("seteuid");}\r\n#endif\r\n}\r\n}\r\ngchar *\r\nget_cur_username(void) {\r\ngchar *username;\r\nstruct passwd *pw = getpwuid(getuid());\r\nif (pw) {\r\nusername = g_strdup(pw->pw_name);\r\n} else {\r\nusername = g_strdup("UNKNOWN");\r\n}\r\nendpwent();\r\nreturn username;\r\n}\r\ngchar *\r\nget_cur_groupname(void) {\r\ngchar *groupname;\r\nstruct group *gr = getgrgid(getgid());\r\nif (gr) {\r\ngroupname = g_strdup(gr->gr_name);\r\n} else {\r\ngroupname = g_strdup("UNKNOWN");\r\n}\r\nendgrent();\r\nreturn groupname;\r\n}

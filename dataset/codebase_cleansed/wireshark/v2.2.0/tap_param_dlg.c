void\r\nregister_param_stat(tap_param_dlg *info, const char *name,\r\nregister_stat_group_t group)\r\n{\r\ngchar *action_name;\r\ngchar *full_name;\r\nconst gchar *stock_id = NULL;\r\nstat_tap_ui ui_info;\r\nsize_t i;\r\nfull_name = g_strdup_printf("%s...", name);\r\naction_name = g_strdup(name);\r\nfor (i = 0; i < strlen(action_name); i++) {\r\nif (action_name[i] == '/') {\r\naction_name[i] = '#';\r\n}\r\n}\r\nui_info.group = group;\r\nui_info.title = full_name;\r\nui_info.cli_string = info->init_string;\r\nui_info.tap_init_cb = info->tap_init_cb;\r\nui_info.nparams = info->nparams;\r\nui_info.params = info->params;\r\nregister_stat_tap_ui(&ui_info, NULL);\r\nswitch (group) {\r\ncase REGISTER_ANALYZE_GROUP_UNSORTED:\r\ncase REGISTER_ANALYZE_GROUP_CONVERSATION_FILTER:\r\ncase REGISTER_STAT_GROUP_UNSORTED:\r\ncase REGISTER_STAT_GROUP_GENERIC:\r\nbreak;\r\ncase REGISTER_STAT_GROUP_CONVERSATION_LIST:\r\nstock_id = WIRESHARK_STOCK_CONVERSATIONS;\r\nbreak;\r\ncase REGISTER_STAT_GROUP_ENDPOINT_LIST:\r\nstock_id = WIRESHARK_STOCK_ENDPOINTS;\r\nbreak;\r\ncase REGISTER_STAT_GROUP_RESPONSE_TIME:\r\nstock_id = WIRESHARK_STOCK_TIME;\r\nbreak;\r\ncase REGISTER_STAT_GROUP_TELEPHONY:\r\ncase REGISTER_STAT_GROUP_TELEPHONY_ANSI:\r\ncase REGISTER_STAT_GROUP_TELEPHONY_GSM:\r\ncase REGISTER_STAT_GROUP_TELEPHONY_LTE:\r\ncase REGISTER_STAT_GROUP_TELEPHONY_MTP3:\r\ncase REGISTER_STAT_GROUP_TELEPHONY_SCTP:\r\nbreak;\r\ncase REGISTER_TOOLS_GROUP_UNSORTED:\r\nbreak;\r\n}\r\nregister_menu_bar_menu_items(\r\nstat_group_name(group),\r\naction_name,\r\nstock_id,\r\nfull_name,\r\nNULL,\r\nNULL,\r\ntap_param_dlg_cb,\r\ninfo,\r\nTRUE,\r\nNULL,\r\nNULL);\r\n}\r\nvoid tap_param_dlg_update (void)\r\n{\r\ntap_param_dlg_list_item *dialog = start_dlg_list;\r\nchar *display_name;\r\nchar *title;\r\nwhile(dialog != NULL) {\r\nif(dialog->dlg) {\r\ndisplay_name = cf_get_display_name(&cfile);\r\ntitle = g_strdup_printf("Wireshark: %s: %s", dialog->cont.win_title , display_name);\r\ng_free(display_name);\r\ngtk_window_set_title(GTK_WINDOW(dialog->dlg), title);\r\ng_free(title);\r\n}\r\ndialog = dialog->next;\r\n}\r\n}\r\nstatic void\r\ndlg_destroy_cb(GtkWidget *item _U_, gpointer dialog_data)\r\n{\r\ntap_param_dlg_list_item *dlg_data = (tap_param_dlg_list_item *) dialog_data;\r\ndlg_data->dlg = NULL;\r\n}\r\nstatic void\r\ntap_param_dlg_start_button_clicked(GtkWidget *item _U_, gpointer dialog_data)\r\n{\r\nGString *params;\r\nsize_t i;\r\ngdouble d;\r\ngint j;\r\ntap_param_dlg_list_item *dlg_data = (tap_param_dlg_list_item *) dialog_data;\r\nparams = g_string_new(dlg_data->cont.init_string);\r\nfor(i=0;i<dlg_data->cont.nparams;i++) {\r\ng_string_append_c(params, ',');\r\nswitch (dlg_data->cont.params[i].type) {\r\ncase PARAM_ENUM:\r\nj = gtk_combo_box_get_active(GTK_COMBO_BOX(dlg_data->param_items[i]));\r\ng_string_append_printf(params,"%d",\r\ndlg_data->cont.params[i].enum_vals[j].value);\r\nbreak;\r\ncase PARAM_UINT:\r\nd = gtk_spin_button_get_value(GTK_SPIN_BUTTON(dlg_data->param_items[i]));\r\ng_string_append_printf(params,"%u",(guint)d);\r\nbreak;\r\ncase PARAM_STRING:\r\ncase PARAM_UUID:\r\ncase PARAM_FILTER:\r\ng_string_append(params,\r\ngtk_entry_get_text(GTK_ENTRY(dlg_data->param_items[i])));\r\nbreak;\r\n}\r\n}\r\n(dlg_data->cont.tap_init_cb)(params->str, dlg_data->cont.user_data);\r\ng_string_free(params, TRUE);\r\n}\r\nvoid\r\ntap_param_dlg_cb(GtkAction *action _U_, gpointer data)\r\n{\r\nconst char *filter;\r\nchar *display_name;\r\nchar *title;\r\nGtkWidget *dlg_box;\r\nGtkWidget *item_box, *item, *label, *filter_bt;\r\nGtkWidget *bbox, *start_button, *cancel_button;\r\nsize_t i, j;\r\nchar *label_with_colon;\r\ntap_param_dlg *dlg_data = (tap_param_dlg *) data;\r\nif(dlg_data==NULL)\r\nreturn;\r\nif(dlg_data->index==-1) {\r\nif(start_dlg_list==NULL) {\r\nstart_dlg_list = (tap_param_dlg_list_item *) g_malloc(sizeof (tap_param_dlg_list_item));\r\nend_dlg_list = start_dlg_list;\r\nend_dlg_list->cont.index = 0;\r\n} else {\r\nend_dlg_list->next = (tap_param_dlg_list_item *) g_malloc(sizeof (tap_param_dlg_list_item));\r\nend_dlg_list->next->cont.index = end_dlg_list->cont.index + 1;\r\nend_dlg_list = end_dlg_list->next;\r\n}\r\nend_dlg_list->dlg = NULL;\r\nend_dlg_list->param_items = (GtkWidget **)g_malloc(dlg_data->nparams * sizeof (GtkWidget *));\r\nend_dlg_list->cont.win_title = dlg_data->win_title;\r\nend_dlg_list->cont.init_string = dlg_data->init_string;\r\nend_dlg_list->cont.tap_init_cb = dlg_data->tap_init_cb;\r\nend_dlg_list->cont.nparams = dlg_data->nparams;\r\nend_dlg_list->cont.params = dlg_data->params;\r\nend_dlg_list->cont.user_data = dlg_data->user_data;\r\nend_dlg_list->args.title = g_strdup_printf("%s Filter", dlg_data->win_title);\r\nend_dlg_list->args.wants_apply_button = TRUE;\r\nend_dlg_list->args.activate_on_ok = FALSE;\r\nend_dlg_list->args.modal_and_transient = FALSE;\r\nend_dlg_list->next = NULL;\r\ndlg_data->index = end_dlg_list->cont.index;\r\ncurrent_dlg = end_dlg_list;\r\n} else {\r\ncurrent_dlg = start_dlg_list;\r\nwhile(dlg_data->index != current_dlg->cont.index)\r\n{\r\nif(current_dlg->next == NULL) {\r\nreturn;\r\n}\r\ncurrent_dlg = current_dlg->next;\r\n}\r\n}\r\nif(current_dlg->dlg){\r\ngdk_window_raise(gtk_widget_get_window(current_dlg->dlg));\r\nreturn;\r\n}\r\nif (current_dlg->cont.nparams == 0)\r\n{\r\ntap_param_dlg_start_button_clicked(NULL, current_dlg);\r\nreturn;\r\n}\r\ndisplay_name = cf_get_display_name(&cfile);\r\ntitle = g_strdup_printf("Wireshark: %s: %s", current_dlg->cont.win_title , display_name);\r\ng_free(display_name);\r\ncurrent_dlg->dlg=dlg_window_new_with_geom(title, current_dlg->cont.win_title, GTK_WIN_POS_CENTER_ON_PARENT);\r\ngtk_window_set_default_size(GTK_WINDOW(current_dlg->dlg), 300, -1);\r\ng_free(title);\r\ndlg_box=ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 10, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(dlg_box), 10);\r\ngtk_container_add(GTK_CONTAINER(current_dlg->dlg), dlg_box);\r\ngtk_widget_show(dlg_box);\r\nfor(i=0;i<current_dlg->cont.nparams;i++) {\r\nitem_box=ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\nswitch (current_dlg->cont.params[i].type) {\r\ncase PARAM_UINT:\r\nlabel_with_colon=g_strdup_printf("%s:", current_dlg->cont.params[i].title);\r\nlabel=gtk_label_new(label_with_colon);\r\ng_free(label_with_colon);\r\ngtk_box_pack_start(GTK_BOX(item_box), label, FALSE, TRUE, 0);\r\ngtk_widget_show(label);\r\nitem=gtk_spin_button_new_with_range(0, G_MAXUINT, 1);\r\ngtk_spin_button_set_numeric(GTK_SPIN_BUTTON(item), TRUE);\r\nbreak;\r\ncase PARAM_STRING:\r\nlabel_with_colon=g_strdup_printf("%s:", current_dlg->cont.params[i].title);\r\nlabel=gtk_label_new(label_with_colon);\r\ng_free(label_with_colon);\r\ngtk_box_pack_start(GTK_BOX(item_box), label, FALSE, TRUE, 0);\r\ngtk_widget_show(label);\r\nitem=gtk_entry_new();\r\nbreak;\r\ncase PARAM_ENUM:\r\nlabel_with_colon=g_strdup_printf("%s:", current_dlg->cont.params[i].title);\r\nlabel=gtk_label_new(label_with_colon);\r\ng_free(label_with_colon);\r\ngtk_box_pack_start(GTK_BOX(item_box), label, FALSE, TRUE, 0);\r\ngtk_widget_show(label);\r\nitem=gtk_combo_box_text_new();\r\nfor (j = 0; current_dlg->cont.params[i].enum_vals[j].name != NULL;\r\nj++)\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(item),\r\ncurrent_dlg->cont.params[i].enum_vals[j].description);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(item), 0);\r\nbreak;\r\ncase PARAM_FILTER:\r\nfilter_bt=ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked", G_CALLBACK(display_filter_construct_cb), &(current_dlg->args));\r\ngtk_box_pack_start(GTK_BOX(item_box), filter_bt, FALSE, TRUE, 0);\r\ngtk_widget_show(filter_bt);\r\nitem=gtk_entry_new();\r\ng_signal_connect(item, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(item_box), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(item, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(current_dlg->dlg, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, item);\r\nfilter=gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\nif(filter){\r\ngtk_entry_set_text(GTK_ENTRY(item), filter);\r\n} else {\r\ncolorize_filter_te_as_empty(item);\r\n}\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\nitem=NULL;\r\nbreak;\r\n}\r\ngtk_box_pack_start(GTK_BOX(item_box), item, TRUE, TRUE, 0);\r\ncurrent_dlg->param_items[i]=item;\r\ngtk_widget_show(item);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), item_box, TRUE, TRUE, 0);\r\ngtk_widget_show(item_box);\r\n}\r\nbbox = dlg_button_row_new(WIRESHARK_STOCK_CREATE_STAT, GTK_STOCK_CANCEL, NULL);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nstart_button = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CREATE_STAT);\r\ng_signal_connect(start_button, "clicked",\r\nG_CALLBACK(tap_param_dlg_start_button_clicked), current_dlg);\r\ncancel_button = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button(current_dlg->dlg, cancel_button, window_cancel_button_cb);\r\nfor(i=0;i<current_dlg->cont.nparams;i++){\r\nswitch (current_dlg->cont.params[i].type) {\r\ncase PARAM_UINT:\r\ncase PARAM_ENUM:\r\nbreak;\r\ncase PARAM_STRING:\r\ncase PARAM_FILTER:\r\ncase PARAM_UUID:\r\ndlg_set_activate(current_dlg->param_items[i], start_button);\r\nbreak;\r\n}\r\n}\r\nif(current_dlg->cont.nparams>0){\r\ngtk_widget_grab_focus(current_dlg->param_items[0]);\r\n}\r\ngtk_widget_grab_default(start_button );\r\ng_signal_connect(current_dlg->dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(current_dlg->dlg, "destroy", G_CALLBACK(dlg_destroy_cb), current_dlg);\r\ngtk_widget_show_all(current_dlg->dlg);\r\nwindow_present(current_dlg->dlg);\r\n}

static int\r\ndissect_yami_parameter(tvbuff_t *tvb, proto_tree *tree, int offset, proto_item *par_ti)\r\n{\r\nconst int orig_offset = offset;\r\nproto_tree *yami_param;\r\nproto_item *ti;\r\nchar *name;\r\nint name_offset;\r\nguint32 name_len;\r\nguint32 type;\r\nti = proto_tree_add_item(tree, &hfi_yami_param, tvb, offset, 0, ENC_NA);\r\nyami_param = proto_item_add_subtree(ti, ett_yami_param);\r\nname_offset = offset;\r\nname_len = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nname = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, name_len, ENC_ASCII | ENC_NA);\r\nproto_item_append_text(ti, ": %s", name);\r\nproto_item_append_text(par_ti, "%s, ", name);\r\noffset += (name_len + 3) & ~3;\r\nproto_tree_add_string(yami_param, &hfi_yami_param_name, tvb, name_offset, offset - name_offset, name);\r\ntype = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_type, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nswitch (type) {\r\ncase YAMI_TYPE_BOOLEAN:\r\n{\r\nguint32 val = tvb_get_letohl(tvb, offset);\r\nproto_item_append_text(ti, ", Type: boolean, Value: %s", val ? "True" : "False");\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_bool, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nbreak;\r\n}\r\ncase YAMI_TYPE_INTEGER:\r\n{\r\ngint32 val = tvb_get_letohl(tvb, offset);\r\nproto_item_append_text(ti, ", Type: integer, Value: %d", val);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_int, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nbreak;\r\n}\r\ncase YAMI_TYPE_LONGLONG:\r\n{\r\ngint64 val = tvb_get_letoh64(tvb, offset);\r\nproto_item_append_text(ti, ", Type: long, Value: %" G_GINT64_MODIFIER "d", val);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_long, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nbreak;\r\n}\r\ncase YAMI_TYPE_DOUBLE:\r\n{\r\ngdouble val = tvb_get_letohieee_double(tvb, offset);\r\nproto_item_append_text(ti, ", Type: double, Value: %g", val);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_double, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nbreak;\r\n}\r\ncase YAMI_TYPE_STRING:\r\n{\r\nconst int val_offset = offset;\r\nguint32 val_len;\r\nchar *val;\r\nval_len = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nval = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, val_len, ENC_ASCII | ENC_NA);\r\nproto_item_append_text(ti, ", Type: string, Value: \"%s\"", val);\r\noffset += (val_len + 3) & ~3;\r\nproto_tree_add_string(yami_param, &hfi_yami_param_value_str, tvb, val_offset, offset - val_offset, val);\r\nbreak;\r\n}\r\ncase YAMI_TYPE_BINARY:\r\n{\r\nconst int val_offset = offset;\r\nguint32 val_len;\r\nconst guint8 *val;\r\nchar *repr;\r\nval_len = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nval = tvb_get_ptr(tvb, offset, val_len);\r\nrepr = bytes_to_str(wmem_packet_scope(), val, val_len);\r\nproto_item_append_text(ti, ", Type: binary, Value: %s", repr);\r\noffset += (val_len + 3) & ~3;\r\nproto_tree_add_bytes_format_value(yami_param, hfi_yami_param_value_bin.id, tvb, val_offset, offset - val_offset, val, "%s", repr);\r\nbreak;\r\n}\r\ncase YAMI_TYPE_BOOLEAN_ARRAY:\r\n{\r\nguint32 count;\r\nguint i;\r\nint j;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_items_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: boolean[], %u items: {", count);\r\nfor (i = 0; i < count/32; i++) {\r\nguint32 val = tvb_get_letohl(tvb, offset);\r\nfor (j = 0; j < 32; j++) {\r\nint r = !!(val & (1 << j));\r\nproto_item_append_text(ti, "%s, ", r ? "T" : "F");\r\nproto_tree_add_boolean(yami_param, &hfi_yami_param_value_bool, tvb, offset+(j/8), 1, r);\r\n}\r\noffset += 4;\r\n}\r\nif (count % 32) {\r\nguint32 val = tvb_get_letohl(tvb, offset);\r\nint tmp = count % 32;\r\nfor (j = 0; j < tmp; j++) {\r\nint r = !!(val & (1 << j));\r\nproto_item_append_text(ti, "%s, ", r ? "T" : "F");\r\nproto_tree_add_boolean(yami_param, &hfi_yami_param_value_bool, tvb, offset+(j/8), 1, r);\r\n}\r\noffset += 4;\r\n}\r\nproto_item_append_text(ti, "}");\r\nbreak;\r\n}\r\ncase YAMI_TYPE_INTEGER_ARRAY:\r\n{\r\nguint32 count;\r\nguint i;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_items_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: integer[], %u items: {", count);\r\nfor (i = 0; i < count; i++) {\r\ngint32 val = tvb_get_letohl(tvb, offset);\r\nproto_item_append_text(ti, "%d, ", val);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_int, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\nproto_item_append_text(ti, "}");\r\nbreak;\r\n}\r\ncase YAMI_TYPE_LONGLONG_ARRAY:\r\n{\r\nguint32 count;\r\nguint i;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_items_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: long long[], %u items: {", count);\r\nfor (i = 0; i < count; i++) {\r\ngint64 val = tvb_get_letoh64(tvb, offset);\r\nproto_item_append_text(ti, "%" G_GINT64_MODIFIER "d, ", val);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_long, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nproto_item_append_text(ti, "}");\r\nbreak;\r\n}\r\ncase YAMI_TYPE_DOUBLE_ARRAY:\r\n{\r\nguint32 count;\r\nguint i;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_items_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: double[], %u items: {", count);\r\nfor (i = 0; i < count; i++) {\r\ngdouble val = tvb_get_letohieee_double(tvb, offset);\r\nproto_item_append_text(ti, "%g, ", val);\r\nproto_tree_add_item(yami_param, &hfi_yami_param_value_double, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nproto_item_append_text(ti, "}");\r\nbreak;\r\n}\r\ncase YAMI_TYPE_STRING_ARRAY:\r\n{\r\nguint32 count;\r\nguint i;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_items_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: string[], %u items: {", count);\r\nfor (i = 0; i < count; i++) {\r\nconst int val_offset = offset;\r\nguint32 val_len;\r\nchar *val;\r\nval_len = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nval = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, val_len, ENC_ASCII | ENC_NA);\r\nproto_item_append_text(ti, "\"%s\", ", val);\r\nproto_tree_add_string(yami_param, &hfi_yami_param_value_str, tvb, val_offset, offset - val_offset, val);\r\noffset += (val_len + 3) & ~3;\r\n}\r\nproto_item_append_text(ti, "}");\r\nbreak;\r\n}\r\ncase YAMI_TYPE_BINARY_ARRAY:\r\n{\r\nguint32 count;\r\nguint i;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_items_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: binary[], %u items: {", count);\r\nfor (i = 0; i < count; i++) {\r\nconst int val_offset = offset;\r\nguint32 val_len;\r\nconst guint8 *val;\r\nchar *repr;\r\nval_len = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nval = tvb_get_ptr(tvb, offset, val_len);\r\nrepr = bytes_to_str(wmem_packet_scope(), val, val_len);\r\nproto_item_append_text(ti, "%s, ", repr);\r\noffset += (val_len + 3) & ~3;\r\nproto_tree_add_bytes_format_value(yami_param, hfi_yami_param_value_bin.id, tvb, val_offset, offset - val_offset, val, "%s", repr);\r\n}\r\nproto_item_append_text(ti, "}");\r\nbreak;\r\n}\r\ncase YAMI_TYPE_NESTED:\r\n{\r\nguint32 count;\r\nguint i;\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_param, &hfi_yami_params_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", Type: nested, %u parameters: ", count);\r\nfor (i = 0; i < count; i++) {\r\noffset = dissect_yami_parameter(tvb, yami_param, offset, ti);\r\nif (offset == -1)\r\nreturn -1;\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nproto_item_append_text(ti, ", Type: unknown (%d)!", type);\r\nreturn -1;\r\n}\r\nproto_item_set_len(ti, offset - orig_offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_yami_data(tvbuff_t *tvb, gboolean data, proto_tree *tree, int offset)\r\n{\r\nconst int orig_offset = offset;\r\nproto_tree *yami_data_tree;\r\nproto_item *ti;\r\nguint32 count;\r\nguint i;\r\nti = proto_tree_add_item(tree, (data) ? &hfi_yami_message_data : &hfi_yami_message_hdr, tvb, offset, 0, ENC_NA);\r\nyami_data_tree = proto_item_add_subtree(ti, (data) ? ett_yami_msg_data : ett_yami_msg_hdr);\r\ncount = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_data_tree, &hfi_yami_params_count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, ", %u parameters: ", count);\r\nfor (i = 0; i < count; i++) {\r\noffset = dissect_yami_parameter(tvb, yami_data_tree, offset, ti);\r\nif (offset == -1)\r\nreturn -1;\r\n}\r\nproto_item_set_len(ti, offset - orig_offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_yami_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *yami_tree;\r\nproto_item *ti;\r\ngint frame_number;\r\ngint message_header_size;\r\ngint frame_payload_size;\r\ngint frame_size;\r\nint offset;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "YAMI");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, hfi_yami, tvb, 0, -1, ENC_NA);\r\nyami_tree = proto_item_add_subtree(ti, ett_yami);\r\noffset = 0;\r\nproto_tree_add_item(yami_tree, &hfi_yami_message_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nframe_number = tvb_get_letohl(tvb, offset);\r\nti = proto_tree_add_item(yami_tree, &hfi_yami_frame_number, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nif(frame_number < 0)\r\nproto_item_append_text(ti, "%s", " (last frame)");\r\noffset += 4;\r\nmessage_header_size = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(yami_tree, &hfi_yami_message_header_size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nif (message_header_size < 4) {\r\n}\r\noffset += 4;\r\nframe_payload_size = tvb_get_letohl(tvb, offset);\r\nti = proto_tree_add_item(yami_tree, &hfi_yami_frame_payload_size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nframe_size = frame_payload_size + 16;\r\nproto_item_append_text(ti, ", (YAMI Frame Size: %d)", frame_size);\r\noffset += 4;\r\nif (frame_number == 1 || frame_number == -1) {\r\nif (message_header_size <= frame_payload_size) {\r\nconst int orig_offset = offset;\r\noffset = dissect_yami_data(tvb, FALSE, yami_tree, offset);\r\nif (offset != orig_offset + message_header_size) {\r\noffset = orig_offset + message_header_size;\r\n}\r\ndissect_yami_data(tvb, TRUE, yami_tree, offset);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_yami_message_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint32 len = tvb_get_letohl(tvb, offset + 12);\r\nreturn len + FRAME_HEADER_LEN;\r\n}\r\nstatic int\r\ndissect_yami(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, yami_desegment, FRAME_HEADER_LEN, get_yami_message_len, dissect_yami_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_yami(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_yami_message_id,\r\n&hfi_yami_frame_number,\r\n&hfi_yami_message_header_size,\r\n&hfi_yami_frame_payload_size,\r\n&hfi_yami_message_hdr,\r\n&hfi_yami_message_data,\r\n&hfi_yami_param,\r\n&hfi_yami_param_name,\r\n&hfi_yami_param_type,\r\n&hfi_yami_param_value_bool,\r\n&hfi_yami_param_value_int,\r\n&hfi_yami_param_value_long,\r\n&hfi_yami_param_value_double,\r\n&hfi_yami_param_value_str,\r\n&hfi_yami_param_value_bin,\r\n&hfi_yami_params_count,\r\n&hfi_yami_items_count,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_yami,\r\n&ett_yami_msg_hdr,\r\n&ett_yami_msg_data,\r\n&ett_yami_param\r\n};\r\nmodule_t *yami_module;\r\nint proto_yami;\r\nproto_yami = proto_register_protocol("YAMI Protocol", "YAMI", "yami");\r\nhfi_yami = proto_registrar_get_nth(proto_yami);\r\nproto_register_fields(proto_yami, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nyami_module = prefs_register_protocol(proto_yami, proto_reg_handoff_yami);\r\nprefs_register_uint_preference(yami_module, "tcp.port", "YAMI TCP Port", "The TCP port on which YAMI messages will be read(3000)", 10, &global_yami_config_tcp_port);\r\nprefs_register_uint_preference(yami_module, "udp.port", "YAMI UDP Port", "The UDP port on which YAMI messages will be read(5000)", 10, &global_yami_config_udp_port);\r\nprefs_register_bool_preference(yami_module, "desegment",\r\n"Reassemble YAMI messages spanning multiple TCP segments",\r\n"Whether the YAMI dissector should reassemble messages spanning multiple TCP segments."\r\n"To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&yami_desegment);\r\nyami_handle = create_dissector_handle(dissect_yami, proto_yami);\r\n}\r\nvoid\r\nproto_reg_handoff_yami(void)\r\n{\r\nstatic int yami_prefs_initialized = FALSE;\r\nstatic guint yami_tcp_port, yami_udp_port;\r\nif(yami_prefs_initialized == FALSE){\r\nyami_prefs_initialized = TRUE;\r\nyami_tcp_port = global_yami_config_tcp_port;\r\nyami_udp_port = global_yami_config_udp_port;\r\n}else{\r\ndissector_delete_uint("tcp.port", yami_tcp_port, yami_handle);\r\ndissector_delete_uint("udp.port", yami_udp_port, yami_handle);\r\n}\r\nyami_tcp_port = global_yami_config_tcp_port;\r\nyami_udp_port = global_yami_config_udp_port;\r\ndissector_add_uint("tcp.port", yami_tcp_port, yami_handle);\r\ndissector_add_uint("udp.port", yami_udp_port, yami_handle);\r\n}

void\r\ndfilter_fail(dfwork_t *dfw, const char *format, ...)\r\n{\r\nva_list args;\r\nif (dfw->error_message != NULL)\r\nreturn;\r\nva_start(args, format);\r\ndfw->error_message = g_strdup_vprintf(format, args);\r\nva_end(args);\r\n}\r\nvoid\r\ndfilter_init(void)\r\n{\r\nif (ParserObj) {\r\ng_message("I expected ParserObj to be NULL\n");\r\nDfilterFree(ParserObj, g_free);\r\n}\r\nParserObj = DfilterAlloc(g_malloc);\r\n#ifdef DFTRACE\r\nDfilterTrace(stdout, "lemon> ");\r\n#endif\r\nsttype_init();\r\ndfilter_macro_init();\r\n}\r\nvoid\r\ndfilter_cleanup(void)\r\n{\r\nif (ParserObj) {\r\nDfilterFree(ParserObj, g_free);\r\n}\r\nsttype_cleanup();\r\n}\r\nstatic dfilter_t*\r\ndfilter_new(void)\r\n{\r\ndfilter_t *df;\r\ndf = g_new0(dfilter_t, 1);\r\ndf->insns = NULL;\r\ndf->deprecated = NULL;\r\nreturn df;\r\n}\r\nstatic void\r\nfree_insns(GPtrArray *insns)\r\n{\r\nunsigned int i;\r\ndfvm_insn_t *insn;\r\nfor (i = 0; i < insns->len; i++) {\r\ninsn = (dfvm_insn_t *)g_ptr_array_index(insns, i);\r\ndfvm_insn_free(insn);\r\n}\r\ng_ptr_array_free(insns, TRUE);\r\n}\r\nvoid\r\ndfilter_free(dfilter_t *df)\r\n{\r\nguint i;\r\nif (!df)\r\nreturn;\r\nif (df->insns) {\r\nfree_insns(df->insns);\r\n}\r\nif (df->consts) {\r\nfree_insns(df->consts);\r\n}\r\ng_free(df->interesting_fields);\r\nfor (i = 0; i < df->max_registers; i++) {\r\nif (df->registers[i]) {\r\ng_list_free(df->registers[i]);\r\n}\r\n}\r\nif (df->deprecated) {\r\nfor (i = 0; i < df->deprecated->len; ++i) {\r\ngchar *depr = (gchar *)g_ptr_array_index(df->deprecated, i);\r\ng_free(depr);\r\n}\r\ng_ptr_array_free(df->deprecated, TRUE);\r\n}\r\ng_free(df->registers);\r\ng_free(df->attempted_load);\r\ng_free(df);\r\n}\r\nstatic dfwork_t*\r\ndfwork_new(void)\r\n{\r\ndfwork_t *dfw;\r\ndfw = g_new0(dfwork_t, 1);\r\ndfw->first_constant = -1;\r\nreturn dfw;\r\n}\r\nstatic void\r\ndfwork_free(dfwork_t *dfw)\r\n{\r\nif (dfw->st_root) {\r\nstnode_free(dfw->st_root);\r\n}\r\nif (dfw->loaded_fields) {\r\ng_hash_table_destroy(dfw->loaded_fields);\r\n}\r\nif (dfw->interesting_fields) {\r\ng_hash_table_destroy(dfw->interesting_fields);\r\n}\r\nif (dfw->insns) {\r\nfree_insns(dfw->insns);\r\n}\r\nif (dfw->consts) {\r\nfree_insns(dfw->consts);\r\n}\r\ng_free(dfw);\r\n}\r\ngboolean\r\ndfilter_compile(const gchar *text, dfilter_t **dfp, gchar **err_msg)\r\n{\r\ngchar *expanded_text;\r\nint token;\r\ndfilter_t *dfilter;\r\ndfwork_t *dfw;\r\ndf_scanner_state_t state;\r\nyyscan_t scanner;\r\nYY_BUFFER_STATE in_buffer;\r\ngboolean failure = FALSE;\r\nconst char *depr_test;\r\nguint i;\r\nGPtrArray *deprecated;\r\ng_assert(dfp);\r\nif (!text) {\r\n*dfp = NULL;\r\nif (err_msg != NULL)\r\n*err_msg = g_strdup("BUG: NULL text pointer passed to dfilter_compile()");\r\nreturn FALSE;\r\n}\r\nif ( !( expanded_text = dfilter_macro_apply(text, err_msg) ) ) {\r\nreturn FALSE;\r\n}\r\nif (df_lex_init(&scanner) != 0) {\r\n*dfp = NULL;\r\nif (err_msg != NULL)\r\n*err_msg = g_strdup_printf("Can't initialize scanner: %s",\r\ng_strerror(errno));\r\nreturn FALSE;\r\n}\r\nin_buffer = df__scan_string(expanded_text, scanner);\r\ndfw = dfwork_new();\r\nstate.dfw = dfw;\r\nstate.quoted_string = NULL;\r\ndf_set_extra(&state, scanner);\r\ndeprecated = g_ptr_array_new();\r\nwhile (1) {\r\ndf_lval = stnode_new(STTYPE_UNINITIALIZED, NULL);\r\ntoken = df_lex(scanner);\r\nif (token == SCAN_FAILED) {\r\nfailure = TRUE;\r\nbreak;\r\n}\r\nif (token == 0) {\r\nbreak;\r\n}\r\ndepr_test = stnode_deprecated(df_lval);\r\nif (depr_test) {\r\nfor (i = 0; i < deprecated->len; i++) {\r\nif (g_ascii_strcasecmp(depr_test, (const gchar *)g_ptr_array_index(deprecated, i)) == 0) {\r\ndepr_test = NULL;\r\n}\r\n}\r\n}\r\nif (depr_test) {\r\ng_ptr_array_add(deprecated, g_strdup(depr_test));\r\n}\r\nDfilter(ParserObj, token, df_lval, dfw);\r\ndf_lval = NULL;\r\nif (dfw->syntax_error) {\r\nfailure = TRUE;\r\nbreak;\r\n}\r\n}\r\nif (df_lval) {\r\nstnode_free(df_lval);\r\ndf_lval = NULL;\r\n}\r\nDfilter(ParserObj, 0, NULL, dfw);\r\nif (dfw->syntax_error)\r\nfailure = TRUE;\r\nif (state.quoted_string != NULL)\r\ng_string_free(state.quoted_string, TRUE);\r\ndf__delete_buffer(in_buffer, scanner);\r\ndf_lex_destroy(scanner);\r\nif (failure)\r\ngoto FAILURE;\r\nif (dfw->st_root == NULL) {\r\n*dfp = NULL;\r\nfor (i = 0; i < deprecated->len; ++i) {\r\ngchar* depr = (gchar*)g_ptr_array_index(deprecated,i);\r\ng_free(depr);\r\n}\r\ng_ptr_array_free(deprecated, TRUE);\r\n}\r\nelse {\r\nif (!dfw_semcheck(dfw, deprecated)) {\r\ngoto FAILURE;\r\n}\r\ndfw_gencode(dfw);\r\ndfilter = dfilter_new();\r\ndfilter->insns = dfw->insns;\r\ndfilter->consts = dfw->consts;\r\ndfw->insns = NULL;\r\ndfw->consts = NULL;\r\ndfilter->interesting_fields = dfw_interesting_fields(dfw,\r\n&dfilter->num_interesting_fields);\r\ndfilter->num_registers = dfw->first_constant;\r\ndfilter->max_registers = dfw->next_register;\r\ndfilter->registers = g_new0(GList*, dfilter->max_registers);\r\ndfilter->attempted_load = g_new0(gboolean, dfilter->max_registers);\r\ndfvm_init_const(dfilter);\r\ndfilter->deprecated = deprecated;\r\n*dfp = dfilter;\r\n}\r\nglobal_dfw = NULL;\r\ndfwork_free(dfw);\r\nwmem_free(NULL, expanded_text);\r\nreturn TRUE;\r\nFAILURE:\r\nif (dfw) {\r\nif (err_msg != NULL)\r\n*err_msg = dfw->error_message;\r\nelse\r\ng_free(dfw->error_message);\r\nglobal_dfw = NULL;\r\ndfwork_free(dfw);\r\n}\r\nfor (i = 0; i < deprecated->len; ++i) {\r\ngchar* depr = (gchar*)g_ptr_array_index(deprecated,i);\r\ng_free(depr);\r\n}\r\ng_ptr_array_free(deprecated, TRUE);\r\nif (err_msg != NULL) {\r\nif (*err_msg == NULL)\r\n*err_msg = g_strdup_printf("Unable to parse filter string \"%s\".", expanded_text);\r\n}\r\n*dfp = NULL;\r\nreturn FALSE;\r\n}\r\ngboolean\r\ndfilter_apply(dfilter_t *df, proto_tree *tree)\r\n{\r\nreturn dfvm_apply(df, tree);\r\n}\r\ngboolean\r\ndfilter_apply_edt(dfilter_t *df, epan_dissect_t* edt)\r\n{\r\nreturn dfvm_apply(df, edt->tree);\r\n}\r\nvoid\r\ndfilter_prime_proto_tree(const dfilter_t *df, proto_tree *tree)\r\n{\r\nint i;\r\nfor (i = 0; i < df->num_interesting_fields; i++) {\r\nproto_tree_prime_hfid(tree, df->interesting_fields[i]);\r\n}\r\n}\r\ngboolean\r\ndfilter_has_interesting_fields(const dfilter_t *df)\r\n{\r\nreturn (df->num_interesting_fields > 0);\r\n}\r\nGPtrArray *\r\ndfilter_deprecated_tokens(dfilter_t *df) {\r\nif (df->deprecated && df->deprecated->len > 0) {\r\nreturn df->deprecated;\r\n}\r\nreturn NULL;\r\n}\r\nvoid\r\ndfilter_dump(dfilter_t *df)\r\n{\r\nguint i;\r\nconst gchar *sep = "";\r\ndfvm_dump(stdout, df);\r\nif (df->deprecated && df->deprecated->len) {\r\nprintf("\nDeprecated tokens: ");\r\nfor (i = 0; i < df->deprecated->len; i++) {\r\nprintf("%s\"%s\"", sep, (char *) g_ptr_array_index(df->deprecated, i));\r\nsep = ", ";\r\n}\r\nprintf("\n");\r\n}\r\n}

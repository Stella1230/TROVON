static int\r\ndissect_mifare(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *item;\r\nproto_tree *mifare_tree;\r\nguint8 cmd;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MiFare");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nitem = proto_tree_add_item(tree, proto_mifare, tvb, 0, -1, ENC_NA);\r\nmifare_tree = proto_item_add_subtree(item, ett_mifare);\r\nproto_tree_add_item(mifare_tree, hf_mifare_command, tvb, 0, 1, ENC_BIG_ENDIAN);\r\ncmd = tvb_get_guint8(tvb, 0);\r\nswitch (cmd) {\r\ncase AUTH_A:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_key_a, tvb, 2, 6, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_uid, tvb, 8, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Authenticate with Key A");\r\nbreak;\r\ncase AUTH_B:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_key_b, tvb, 2, 6, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_uid, tvb, 8, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Authenticate with Key B");\r\nbreak;\r\ncase READ:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Read");\r\nbreak;\r\ncase WRITE:\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Write");\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_payload, tvb, 2, -1, ENC_NA);\r\nbreak;\r\ncase TRANSFER:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Transfer");\r\nbreak;\r\ncase DECREMENT:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_operand, tvb, 2, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Decrement");\r\nbreak;\r\ncase INCREMENT:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_operand, tvb, 2, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Increment");\r\nbreak;\r\ncase RESTORE:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_operand, tvb, 2, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Restore");\r\nbreak;\r\ndefault:\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Unknown");\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_mifare(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_mifare_command,\r\n{ "Command", "mifare.cmd", FT_UINT8, BASE_HEX,\r\nVALS(hf_mifare_commands), 0x0, NULL, HFILL }},\r\n{&hf_mifare_block_address,\r\n{ "Block Address", "mifare.block.addr", FT_UINT8, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_key_a,\r\n{ "Key A", "mifare.key.a", FT_UINT64, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_key_b,\r\n{ "Key B", "mifare.key.b", FT_UINT64, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_uid,\r\n{ "UID", "mifare.uid", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_operand,\r\n{ "Operand", "mifare.operand", FT_INT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_payload,\r\n{ "Payload", "mifare.payload", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mifare\r\n};\r\nproto_mifare = proto_register_protocol("NXP MiFare", "MiFare", "mifare");\r\nproto_register_field_array(proto_mifare, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("mifare", dissect_mifare, proto_mifare);\r\n}

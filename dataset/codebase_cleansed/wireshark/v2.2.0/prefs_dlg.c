static guint\r\npref_exists(pref_t *pref _U_, gpointer user_data _U_)\r\n{\r\nreturn 1;\r\n}\r\nstatic guint\r\npref_show(pref_t *pref, gpointer user_data)\r\n{\r\nGtkWidget *main_grid = (GtkWidget *)user_data;\r\nmodule_t *module = (module_t *)g_object_get_data(G_OBJECT(main_grid), E_GRID_MODULE_KEY);\r\nconst char *title;\r\nconst char *type_name = prefs_pref_type_name(pref);\r\nchar *label_string;\r\nsize_t label_len;\r\nchar uint_str[10+1];\r\nchar *tooltip_txt;\r\ntitle = pref->title;\r\nlabel_len = strlen(title) + 2;\r\nlabel_string = (char *)g_malloc(label_len);\r\ng_strlcpy(label_string, title, label_len);\r\ntooltip_txt = pref->description? g_strdup_printf("%s\n\nName: %s.%s\nType: %s",\r\npref->description,\r\nmodule->name,\r\npref->name,\r\ntype_name ? type_name : "Unknown"\r\n): NULL;\r\nif (pref->type != PREF_STATIC_TEXT)\r\ng_strlcat(label_string, ":", label_len);\r\npref_stash(pref, NULL);\r\nswitch (pref->type) {\r\ncase PREF_UINT:\r\nswitch (pref->info.base) {\r\ncase 10:\r\ng_snprintf(uint_str, sizeof(uint_str), "%u", pref->stashed_val.uint);\r\nbreak;\r\ncase 8:\r\ng_snprintf(uint_str, sizeof(uint_str), "%o", pref->stashed_val.uint);\r\nbreak;\r\ncase 16:\r\ng_snprintf(uint_str, sizeof(uint_str), "%x", pref->stashed_val.uint);\r\nbreak;\r\n}\r\npref->control = create_preference_entry(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\nuint_str);\r\nbreak;\r\ncase PREF_BOOL:\r\npref->control = create_preference_check_button(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\npref->stashed_val.boolval);\r\nbreak;\r\ncase PREF_ENUM:\r\nif (pref->info.enum_info.radio_buttons) {\r\npref->control = create_preference_radio_buttons(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\npref->info.enum_info.enumvals,\r\npref->stashed_val.enumval);\r\n} else {\r\npref->control = create_preference_option_menu(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\npref->info.enum_info.enumvals,\r\npref->stashed_val.enumval);\r\n}\r\nbreak;\r\ncase PREF_STRING:\r\npref->control = create_preference_entry(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\npref->stashed_val.string);\r\nbreak;\r\ncase PREF_FILENAME:\r\npref->control = create_preference_path_entry(main_grid, pref->ordinal,\r\nlabel_string,\r\ntooltip_txt,\r\npref->stashed_val.string, FALSE);\r\nbreak;\r\ncase PREF_DIRNAME:\r\npref->control = create_preference_path_entry(main_grid, pref->ordinal,\r\nlabel_string,\r\ntooltip_txt,\r\npref->stashed_val.string, TRUE);\r\nbreak;\r\ncase PREF_RANGE:\r\n{\r\nchar *range_str_p;\r\nrange_str_p = range_convert_range(NULL, *pref->varp.range);\r\npref->control = create_preference_entry(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\nrange_str_p);\r\nwmem_free(NULL, range_str_p);\r\nbreak;\r\n}\r\ncase PREF_STATIC_TEXT:\r\n{\r\npref->control = create_preference_static_text(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt);\r\nbreak;\r\n}\r\ncase PREF_UAT:\r\n{\r\nif (pref->gui == GUI_ALL || pref->gui == GUI_GTK)\r\npref->control = create_preference_uat(main_grid, pref->ordinal,\r\nlabel_string, tooltip_txt,\r\npref->varp.uat);\r\nbreak;\r\n}\r\ncase PREF_COLOR:\r\ncase PREF_CUSTOM:\r\ncase PREF_OBSOLETE:\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\ng_free(tooltip_txt);\r\ng_free(label_string);\r\nreturn 0;\r\n}\r\nstatic prefs_tree_iter\r\nprefs_tree_page_add(const gchar *title, gint page_nr,\r\ngpointer store, prefs_tree_iter *parent_iter)\r\n{\r\nprefs_tree_iter iter;\r\ngtk_tree_store_append((GtkTreeStore *)store, &iter, parent_iter);\r\ngtk_tree_store_set((GtkTreeStore *)store, &iter, 0, title, 1, page_nr, -1);\r\nreturn iter;\r\n}\r\nstatic GtkWidget *\r\nprefs_nb_page_add(GtkWidget *notebook, const gchar *title _U_, GtkWidget *page, const char *page_key)\r\n{\r\nGtkWidget *sw;\r\nGtkWidget *frame;\r\nsw = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(sw), GTK_POLICY_NEVER, GTK_POLICY_AUTOMATIC);\r\ngtk_widget_show(sw);\r\nframe = gtk_frame_new(NULL);\r\ngtk_frame_set_shadow_type(GTK_FRAME(frame), GTK_SHADOW_NONE);\r\ngtk_container_set_border_width(GTK_CONTAINER(frame), DLG_OUTER_MARGIN);\r\n#if ! GTK_CHECK_VERSION(3,8,0)\r\ngtk_scrolled_window_add_with_viewport(GTK_SCROLLED_WINDOW(sw), frame);\r\n#else\r\ngtk_container_add(GTK_CONTAINER(sw), frame);\r\n#endif\r\ngtk_widget_show(frame);\r\nif (page) {\r\ngtk_container_add(GTK_CONTAINER(frame), page);\r\ng_object_set_data(G_OBJECT(prefs_w), page_key, page);\r\n}\r\ngtk_notebook_append_page (GTK_NOTEBOOK(notebook), sw, NULL);\r\nreturn sw;\r\n}\r\nstatic guint\r\nmodule_prefs_show(module_t *module, gpointer user_data)\r\n{\r\nstruct ct_struct *cts = (struct ct_struct *)user_data;\r\nstruct ct_struct child_cts;\r\nGtkWidget *main_vb, *main_grid, *frame, *main_sw;\r\ngchar label_str[MAX_TREE_NODE_NAME_LEN];\r\nGtkTreeStore *model;\r\nGtkTreeIter iter;\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nif (!prefs_module_has_submodules(module)) {\r\nif (prefs_pref_foreach(module, pref_exists, NULL) == 0) {\r\nreturn 0;\r\n}\r\n}\r\ng_strlcpy(label_str, module->title, MAX_TREE_NODE_NAME_LEN);\r\nmodel = GTK_TREE_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(cts->tree)));\r\nif (module->parent == NULL)\r\ngtk_tree_store_append(model, &iter, NULL);\r\nelse\r\ngtk_tree_store_append(model, &iter, &cts->iter);\r\nif (prefs_module_has_submodules(module)) {\r\ngtk_tree_store_set(model, &iter, 0, label_str, 1, -1, -1);\r\nchild_cts = *cts;\r\nchild_cts.iter = iter;\r\nprefs_modules_foreach_submodules(module, module_prefs_show, &child_cts);\r\ncts->page = child_cts.page;\r\n}\r\nmain_sw = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(main_sw), GTK_POLICY_NEVER, GTK_POLICY_AUTOMATIC);\r\nframe = gtk_frame_new(NULL);\r\ngtk_frame_set_shadow_type(GTK_FRAME(frame), GTK_SHADOW_NONE);\r\ngtk_container_set_border_width(GTK_CONTAINER(frame), DLG_OUTER_MARGIN);\r\n#if ! GTK_CHECK_VERSION(3,8,0)\r\ngtk_scrolled_window_add_with_viewport(GTK_SCROLLED_WINDOW(main_sw), frame);\r\n#else\r\ngtk_container_add(GTK_CONTAINER(main_sw), frame);\r\n#endif\r\ng_object_set_data(G_OBJECT(main_sw), E_PAGESW_FRAME_KEY, frame);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(frame), main_vb);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_set_vexpand(GTK_WIDGET(main_grid), FALSE);\r\n#endif\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 15);\r\ng_object_set_data(G_OBJECT(main_grid), E_GRID_MODULE_KEY, module);\r\nprefs_pref_foreach(module, pref_show, main_grid);\r\ng_object_set_data(G_OBJECT(main_grid), E_GRID_MODULE_KEY, NULL);\r\ng_object_set_data(G_OBJECT(frame), E_PAGE_MODULE_KEY, module);\r\ngtk_notebook_append_page(GTK_NOTEBOOK(cts->notebook), main_sw, NULL);\r\ngtk_tree_store_set(model, &iter, 0, label_str, 1, cts->page, -1);\r\ng_object_set_data(G_OBJECT(frame), E_PAGE_ITER_KEY, gtk_tree_iter_copy(&iter));\r\ncts->page++;\r\ngtk_widget_show_all(main_sw);\r\nreturn 0;\r\n}\r\nvoid\r\nprefs_cb(GtkWidget *w, gpointer dummy)\r\n{\r\nprefs_page_cb (w, dummy, PREFS_PAGE_USER_INTERFACE);\r\n}\r\nvoid\r\nprefs_page_cb(GtkWidget *w _U_, gpointer dummy _U_, PREFS_PAGE_E prefs_page)\r\n{\r\nGtkWidget *top_hb, *bbox, *prefs_nb, *ct_sb,\r\n*ok_bt, *apply_bt, *save_bt, *cancel_bt, *help_bt;\r\ngchar label_str[MAX_TREE_NODE_NAME_LEN];\r\nstruct ct_struct cts;\r\nGtkTreeStore *store;\r\nGtkTreeSelection *selection;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\ngint col_offset;\r\nprefs_tree_iter gui_iter, layout_iter, columns_iter, capture_iter;\r\ngint layout_page, columns_page;\r\ngint capture_page = 0;\r\nif (prefs_w != NULL) {\r\nreactivate_window(prefs_w);\r\nreturn;\r\n}\r\nprefs_w = dlg_conf_window_new("Wireshark: Preferences");\r\ngtk_window_set_default_size(GTK_WINDOW(prefs_w), 400, 650);\r\ncts.main_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(cts.main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(prefs_w), cts.main_vb);\r\ngtk_widget_show(cts.main_vb);\r\ntop_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10, FALSE);\r\ngtk_box_pack_start(GTK_BOX(cts.main_vb), top_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(top_hb);\r\nct_sb = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(ct_sb),\r\nGTK_SHADOW_IN);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(ct_sb),\r\nGTK_POLICY_NEVER, GTK_POLICY_AUTOMATIC);\r\ngtk_box_pack_start(GTK_BOX(top_hb), ct_sb, TRUE, TRUE, 0);\r\ngtk_widget_show(ct_sb);\r\ng_object_set_data(G_OBJECT(prefs_w), E_PREFSW_SCROLLW_KEY, ct_sb);\r\nstore = gtk_tree_store_new(2, G_TYPE_STRING, G_TYPE_INT);\r\ncts.tree = tree_view_new(GTK_TREE_MODEL(store));\r\ncts.iter.stamp = 0;\r\ng_object_set_data(G_OBJECT(prefs_w), E_PREFSW_TREE_KEY, cts.tree);\r\ngtk_tree_view_set_headers_visible(GTK_TREE_VIEW(cts.tree), FALSE);\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(cts.tree));\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_SINGLE);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncol_offset = gtk_tree_view_insert_column_with_attributes(GTK_TREE_VIEW(cts.tree),\r\n-1, "Name", renderer,\r\n"text", 0, NULL);\r\ncolumn = gtk_tree_view_get_column(GTK_TREE_VIEW(cts.tree),\r\ncol_offset - 1);\r\ngtk_tree_view_column_set_sizing(GTK_TREE_VIEW_COLUMN(column),\r\nGTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ng_signal_connect(selection, "changed", G_CALLBACK(prefs_tree_select_cb), NULL);\r\ngtk_container_add(GTK_CONTAINER(ct_sb), cts.tree);\r\ngtk_widget_show(cts.tree);\r\nprefs_nb = gtk_notebook_new();\r\ng_object_set_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY, prefs_nb);\r\ngtk_notebook_set_show_tabs(GTK_NOTEBOOK(prefs_nb), FALSE);\r\ngtk_notebook_set_show_border(GTK_NOTEBOOK(prefs_nb), FALSE);\r\ngtk_box_pack_start(GTK_BOX(top_hb), prefs_nb, TRUE, TRUE, 0);\r\ngtk_widget_show(prefs_nb);\r\ncts.page = 0;\r\ng_strlcpy(label_str, "User Interface", MAX_TREE_NODE_NAME_LEN);\r\nprefs_nb_page_add(prefs_nb, label_str, gui_prefs_show(), E_GUI_PAGE_KEY);\r\ngui_iter = prefs_tree_page_add(label_str, cts.page, store, NULL);\r\ncts.page++;\r\ng_strlcpy(label_str, "Layout", MAX_TREE_NODE_NAME_LEN);\r\nprefs_nb_page_add(prefs_nb, label_str, layout_prefs_show(), E_GUI_LAYOUT_PAGE_KEY);\r\nlayout_iter = prefs_tree_page_add(label_str, cts.page, store, &gui_iter);\r\nlayout_page = cts.page++;\r\ng_strlcpy(label_str, "Columns", MAX_TREE_NODE_NAME_LEN);\r\nprefs_nb_page_add(prefs_nb, label_str, column_prefs_show(prefs_w), E_GUI_COLUMN_PAGE_KEY);\r\ncolumns_iter = prefs_tree_page_add(label_str, cts.page, store, &gui_iter);\r\ncolumns_page = cts.page++;\r\ng_strlcpy(label_str, "Font and Colors", MAX_TREE_NODE_NAME_LEN);\r\nprefs_nb_page_add(prefs_nb, label_str, font_color_prefs_show(), E_GUI_FONT_COLORS_PAGE_KEY);\r\nprefs_tree_page_add(label_str, cts.page, store, &gui_iter);\r\ncts.page++;\r\ngtk_tree_selection_select_iter(selection, &gui_iter);\r\ngtk_tree_view_expand_all(GTK_TREE_VIEW(cts.tree));\r\n#ifdef HAVE_LIBPCAP\r\n#ifdef _WIN32\r\nif (has_wpcap) {\r\n#endif\r\ng_strlcpy(label_str, "Capture", MAX_TREE_NODE_NAME_LEN);\r\nprefs_nb_page_add(prefs_nb, label_str, capture_prefs_show(), E_CAPTURE_PAGE_KEY);\r\ncapture_iter = prefs_tree_page_add(label_str, cts.page, store, NULL);\r\ncapture_page = cts.page++;\r\n#ifdef _WIN32\r\n}\r\n#endif\r\n#endif\r\ng_strlcpy(label_str, "Filter Expressions", MAX_TREE_NODE_NAME_LEN);\r\nprefs_nb_page_add(prefs_nb, label_str, filter_expressions_prefs_show(),\r\nE_FILTER_EXPRESSIONS_PAGE_KEY);\r\nprefs_tree_page_add(label_str, cts.page, store, NULL);\r\ncts.page++;\r\ncts.notebook = prefs_nb;\r\ncts.store = store;\r\nprefs_modules_foreach_submodules(NULL, module_prefs_show, &cts);\r\nbbox = dlg_button_row_new(GTK_STOCK_HELP, GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_SAVE, GTK_STOCK_CANCEL, NULL);\r\ngtk_box_pack_start(GTK_BOX(cts.main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(prefs_main_ok_cb), prefs_w);\r\napply_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_APPLY);\r\ng_signal_connect(apply_bt, "clicked", G_CALLBACK(prefs_main_apply_cb), prefs_w);\r\nsave_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_SAVE);\r\ng_signal_connect(save_bt, "clicked", G_CALLBACK(prefs_main_save_cb), prefs_w);\r\ng_object_set_data(G_OBJECT(prefs_w), E_PREFSW_SAVE_BT_KEY, save_bt);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(prefs_main_cancel_cb), prefs_w);\r\nwindow_set_cancel_button(prefs_w, cancel_bt, NULL);\r\ngtk_widget_grab_default(ok_bt);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_PREFERENCES_DIALOG);\r\ng_signal_connect(prefs_w, "delete_event", G_CALLBACK(prefs_main_delete_event_cb), NULL);\r\ng_signal_connect(prefs_w, "destroy", G_CALLBACK(prefs_main_destroy_cb), prefs_w);\r\ngtk_widget_show(prefs_w);\r\nif (!prefs.gui_use_pref_save) {\r\ngtk_widget_hide(save_bt);\r\n}\r\nwindow_present(prefs_w);\r\nswitch (prefs_page) {\r\ncase PREFS_PAGE_LAYOUT:\r\ngtk_tree_selection_select_iter(selection, &layout_iter);\r\ngtk_notebook_set_current_page((GtkNotebook *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY), layout_page);\r\nbreak;\r\ncase PREFS_PAGE_COLUMNS:\r\ngtk_tree_selection_select_iter(selection, &columns_iter);\r\ngtk_notebook_set_current_page((GtkNotebook *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY), columns_page);\r\nbreak;\r\ncase PREFS_PAGE_CAPTURE:\r\nif (capture_page) {\r\ngtk_tree_selection_select_iter(selection, &capture_iter);\r\ngtk_notebook_set_current_page((GtkNotebook *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY), capture_page);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ng_object_unref(G_OBJECT(store));\r\n}\r\nstatic void\r\nset_option_label(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text)\r\n{\r\nGtkWidget *label;\r\nGtkWidget *event_box;\r\nlabel = gtk_label_new(label_text);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\ngtk_widget_show(label);\r\nevent_box = gtk_event_box_new();\r\ngtk_event_box_set_visible_window (GTK_EVENT_BOX(event_box), FALSE);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), event_box, 0, grid_position, 1, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(event_box, tooltip_text);\r\ngtk_container_add(GTK_CONTAINER(event_box), label);\r\ngtk_widget_show(event_box);\r\n}\r\nGtkWidget *\r\ncreate_preference_check_button(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text, gboolean active)\r\n{\r\nGtkWidget *check_box;\r\nset_option_label(main_grid, grid_position, label_text, tooltip_text);\r\ncheck_box = gtk_check_button_new();\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(check_box), active);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), check_box, 1, grid_position, 1, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(check_box, tooltip_text);\r\nreturn check_box;\r\n}\r\nGtkWidget *\r\ncreate_preference_radio_buttons(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text,\r\nconst enum_val_t *enumvals, gint current_val)\r\n{\r\nGtkWidget *radio_button_hbox, *button = NULL;\r\nGSList *rb_group;\r\nint idx;\r\nconst enum_val_t *enum_valp;\r\nGtkWidget *event_box;\r\nset_option_label(main_grid, grid_position, label_text, tooltip_text);\r\nradio_button_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\nrb_group = NULL;\r\nfor (enum_valp = enumvals, idx = 0; enum_valp->name != NULL;\r\nenum_valp++, idx++) {\r\nbutton = gtk_radio_button_new_with_label(rb_group,\r\nenum_valp->description);\r\ngtk_widget_show(button);\r\nrb_group = gtk_radio_button_get_group(GTK_RADIO_BUTTON(button));\r\ngtk_box_pack_start(GTK_BOX(radio_button_hbox), button, FALSE,\r\nFALSE, 10);\r\nif (enum_valp->value == current_val) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(button),\r\nTRUE);\r\n}\r\n}\r\ngtk_widget_show(radio_button_hbox);\r\nevent_box = gtk_event_box_new();\r\ngtk_event_box_set_visible_window (GTK_EVENT_BOX(event_box), FALSE);\r\ngtk_container_add(GTK_CONTAINER(event_box), radio_button_hbox);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), event_box, 1, grid_position, 1, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(event_box, tooltip_text);\r\ngtk_widget_show(event_box);\r\nreturn button;\r\n}\r\nstatic gint\r\nlabel_to_enum_val(GtkWidget *label, const enum_val_t *enumvals)\r\n{\r\nconst gchar *label_string;\r\nint i;\r\nlabel_string = gtk_label_get_text(GTK_LABEL(label));\r\nfor (i = 0; enumvals[i].name != NULL; i++) {\r\nif (g_ascii_strcasecmp(label_string, enumvals[i].description) == 0) {\r\nreturn enumvals[i].value;\r\n}\r\n}\r\ng_assert_not_reached();\r\nreturn -1;\r\n}\r\ngint\r\nfetch_preference_radio_buttons_val(GtkWidget *button,\r\nconst enum_val_t *enumvals)\r\n{\r\nGSList *rb_group;\r\nGSList *rb_entry;\r\nrb_group = gtk_radio_button_get_group(GTK_RADIO_BUTTON(button));\r\nbutton = NULL;\r\nfor (rb_entry = rb_group; rb_entry != NULL;\r\nrb_entry = g_slist_next(rb_entry)) {\r\nbutton = (GtkWidget *)rb_entry->data;\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(button)))\r\nbreak;\r\n}\r\nreturn label_to_enum_val(gtk_bin_get_child(GTK_BIN(button)), enumvals);\r\n}\r\nGtkWidget *\r\ncreate_preference_option_menu(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text,\r\nconst enum_val_t *enumvals, gint current_val)\r\n{\r\nGtkWidget *menu_box, *combo_box;\r\nint menu_idx, idx;\r\nconst enum_val_t *enum_valp;\r\nGtkWidget *event_box;\r\nset_option_label(main_grid, grid_position, label_text, tooltip_text);\r\ncombo_box = gtk_combo_box_text_new();\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(combo_box, tooltip_text);\r\nmenu_idx = 0;\r\nfor (enum_valp = enumvals, idx = 0; enum_valp->name != NULL;\r\nenum_valp++, idx++) {\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT (combo_box), enum_valp->description);\r\nif (enum_valp->value == current_val)\r\nmenu_idx = idx;\r\n}\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(combo_box), menu_idx);\r\nmenu_box = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start(GTK_BOX(menu_box), combo_box, FALSE, FALSE, 0);\r\nevent_box = gtk_event_box_new();\r\ngtk_event_box_set_visible_window (GTK_EVENT_BOX(event_box), FALSE);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), event_box, 1, grid_position, 1, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(event_box, tooltip_text);\r\ngtk_container_add(GTK_CONTAINER(event_box), menu_box);\r\nreturn combo_box;\r\n}\r\ngint\r\nfetch_preference_option_menu_val(GtkWidget *combo_box, const enum_val_t *enumvals)\r\n{\r\nint i;\r\ni = gtk_combo_box_get_active (GTK_COMBO_BOX(combo_box));\r\nreturn enumvals[i].value;\r\n}\r\nGtkWidget *\r\ncreate_preference_entry(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text, char *value)\r\n{\r\nGtkWidget *entry;\r\nset_option_label(main_grid, grid_position, label_text, tooltip_text);\r\nentry = gtk_entry_new();\r\nif (value != NULL)\r\ngtk_entry_set_text(GTK_ENTRY(entry), value);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), entry, 1, grid_position, 1, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(entry, tooltip_text);\r\ngtk_widget_show(entry);\r\nreturn entry;\r\n}\r\nstatic void\r\npreference_filename_entry_cb(GtkWidget *button, GtkWidget *filename_te)\r\n{\r\nfile_selection_browse(button, filename_te, "Wireshark: File preference",\r\nFILE_SELECTION_READ_BROWSE);\r\n}\r\nstatic void\r\npreference_dirname_entry_cb(GtkWidget *button, GtkWidget *filename_te)\r\n{\r\nfile_selection_browse(button, filename_te, "Wireshark: Directory preference",\r\nFILE_SELECTION_CREATE_FOLDER);\r\n}\r\nstatic GtkWidget *\r\ncreate_preference_path_entry(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text, char *value, gboolean dir_only)\r\n{\r\nGtkWidget *entry;\r\nGtkWidget *button, *file_bt_hb;\r\nset_option_label(main_grid, grid_position, label_text, tooltip_text);\r\nfile_bt_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), file_bt_hb, 1, grid_position, 1, 1);\r\ngtk_widget_show(file_bt_hb);\r\nbutton = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_BROWSE);\r\ngtk_box_pack_end(GTK_BOX(file_bt_hb), button, FALSE, FALSE, 0);\r\ngtk_widget_show(button);\r\nentry = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(file_bt_hb), entry, TRUE, TRUE, 0);\r\nif (value != NULL)\r\ngtk_entry_set_text(GTK_ENTRY(entry), value);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(entry, tooltip_text);\r\ngtk_widget_show(entry);\r\nif (dir_only) {\r\ng_signal_connect(button, "clicked", G_CALLBACK(preference_dirname_entry_cb), entry);\r\n} else {\r\ng_signal_connect(button, "clicked", G_CALLBACK(preference_filename_entry_cb), entry);\r\n}\r\nreturn entry;\r\n}\r\nGtkWidget *\r\ncreate_preference_static_text(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text)\r\n{\r\nGtkWidget *label;\r\nif (label_text != NULL)\r\nlabel = gtk_label_new(label_text);\r\nelse\r\nlabel = gtk_label_new("");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, grid_position, 2, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(label, tooltip_text);\r\ngtk_widget_show(label);\r\nreturn label;\r\n}\r\nGtkWidget *\r\ncreate_preference_uat(GtkWidget *main_grid, int grid_position,\r\nconst gchar *label_text, const gchar *tooltip_text, void* uat)\r\n{\r\nGtkWidget *button;\r\nset_option_label(main_grid, grid_position, label_text, tooltip_text);\r\nbutton = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_EDIT);\r\ng_signal_connect(button, "clicked", G_CALLBACK(uat_window_cb), uat);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), button, 1, grid_position, 1, 1);\r\nif (tooltip_text != NULL)\r\ngtk_widget_set_tooltip_text(button, tooltip_text);\r\ngtk_widget_show(button);\r\nreturn button;\r\n}\r\nstatic guint\r\npref_check(pref_t *pref, gpointer user_data)\r\n{\r\nconst char *str_val;\r\nchar *p;\r\npref_t **badpref = (pref_t **)user_data;\r\nswitch (pref->type) {\r\ncase PREF_UINT:\r\nstr_val = gtk_entry_get_text(GTK_ENTRY(pref->control));\r\nerrno = 0;\r\nif (strtoul(str_val, &p, pref->info.base)){}\r\nif (p == str_val || *p != '\0' || errno != 0) {\r\n*badpref = pref;\r\nreturn PREFS_SET_SYNTAX_ERR;\r\n}\r\nbreak;\r\ncase PREF_BOOL:\r\nbreak;\r\ncase PREF_ENUM:\r\nbreak;\r\ncase PREF_STRING:\r\ncase PREF_FILENAME:\r\ncase PREF_DIRNAME:\r\nbreak;\r\ncase PREF_RANGE:\r\nstr_val = gtk_entry_get_text(GTK_ENTRY(pref->control));\r\nif (strlen(str_val) != 0) {\r\nrange_t *newrange;\r\nif (range_convert_str(&newrange, str_val, pref->info.max_value) != CVT_NO_ERROR) {\r\n*badpref = pref;\r\nreturn PREFS_SET_SYNTAX_ERR;\r\n}\r\ng_free(newrange);\r\n}\r\nbreak;\r\ncase PREF_STATIC_TEXT:\r\ncase PREF_UAT:\r\nbreak;\r\ncase PREF_COLOR:\r\ncase PREF_CUSTOM:\r\ncase PREF_OBSOLETE:\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic guint\r\nmodule_prefs_check(module_t *module, gpointer user_data)\r\n{\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nreturn prefs_pref_foreach(module, pref_check, user_data);\r\n}\r\nstatic guint\r\npref_fetch(pref_t *pref, gpointer user_data)\r\n{\r\nconst char *str_val;\r\nchar *p;\r\nguint uval;\r\ngboolean bval;\r\ngint enumval;\r\ngboolean *pref_changed_p = (gboolean *)user_data;\r\nswitch (pref->type) {\r\ncase PREF_UINT:\r\nstr_val = gtk_entry_get_text(GTK_ENTRY(pref->control));\r\nuval = (guint)strtoul(str_val, &p, pref->info.base);\r\n#if 0\r\nif (p == value || *p != '\0')\r\nreturn PREFS_SET_SYNTAX_ERR;\r\n#endif\r\nif (*pref->varp.uint != uval) {\r\n*pref_changed_p = TRUE;\r\n*pref->varp.uint = uval;\r\n}\r\nbreak;\r\ncase PREF_BOOL:\r\nbval = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(pref->control));\r\nif (*pref->varp.boolp != bval) {\r\n*pref_changed_p = TRUE;\r\n*pref->varp.boolp = bval;\r\n}\r\nbreak;\r\ncase PREF_ENUM:\r\nif (pref->info.enum_info.radio_buttons) {\r\nenumval = fetch_preference_radio_buttons_val((GtkWidget *)pref->control,\r\npref->info.enum_info.enumvals);\r\n} else {\r\nenumval = fetch_preference_option_menu_val((GtkWidget *)pref->control,\r\npref->info.enum_info.enumvals);\r\n}\r\nif (*pref->varp.enump != enumval) {\r\n*pref_changed_p = TRUE;\r\n*pref->varp.enump = enumval;\r\n}\r\nbreak;\r\ncase PREF_STRING:\r\ncase PREF_FILENAME:\r\ncase PREF_DIRNAME:\r\nstr_val = gtk_entry_get_text(GTK_ENTRY(pref->control));\r\nprefs_set_string_like_value(pref, str_val, pref_changed_p);\r\nbreak;\r\ncase PREF_RANGE:\r\nstr_val = gtk_entry_get_text(GTK_ENTRY(pref->control));\r\nif (!prefs_set_range_value(pref, str_val, pref_changed_p))\r\n#if 0\r\nreturn PREFS_SET_SYNTAX_ERR;\r\n#else\r\nreturn 0;\r\n#endif\r\nbreak;\r\ncase PREF_STATIC_TEXT:\r\ncase PREF_UAT:\r\nbreak;\r\ncase PREF_COLOR:\r\ncase PREF_CUSTOM:\r\ncase PREF_OBSOLETE:\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic guint\r\nmodule_prefs_fetch(module_t *module, gpointer user_data)\r\n{\r\ngboolean *must_redissect_p = (gboolean *)user_data;\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nmodule->prefs_changed = FALSE;\r\nprefs_pref_foreach(module, pref_fetch, &module->prefs_changed);\r\nif (module->prefs_changed)\r\n*must_redissect_p = TRUE;\r\nreturn 0;\r\n}\r\nstatic void\r\nprefs_airpcap_update(void)\r\n{\r\nGtkWidget *decryption_cm;\r\ngint cur_active;\r\ngboolean wireshark_decryption_was_enabled = FALSE;\r\ngboolean airpcap_decryption_was_enabled = FALSE;\r\ngboolean wireshark_decryption_is_now_enabled = FALSE;\r\ndecryption_cm = GTK_WIDGET(g_object_get_data(G_OBJECT(wireless_tb),AIRPCAP_TOOLBAR_DECRYPTION_KEY));\r\nif (decryption_cm == NULL) {\r\nreturn;\r\n}\r\ncur_active = gtk_combo_box_get_active(GTK_COMBO_BOX(decryption_cm));\r\nif (cur_active < 0) {\r\nreturn;\r\n}\r\nswitch(cur_active) {\r\ncase 1:\r\nwireshark_decryption_was_enabled = TRUE;\r\nairpcap_decryption_was_enabled = FALSE;\r\nbreak;\r\ncase 2:\r\nwireshark_decryption_was_enabled = FALSE;\r\nairpcap_decryption_was_enabled = TRUE;\r\nbreak;\r\ndefault:\r\nwireshark_decryption_was_enabled = FALSE;\r\nairpcap_decryption_was_enabled = FALSE;\r\nbreak;\r\n}\r\nwireshark_decryption_is_now_enabled = wireshark_decryption_on();\r\nif (wireshark_decryption_is_now_enabled && airpcap_decryption_was_enabled)\r\n{\r\nset_airpcap_decryption(FALSE);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(decryption_cm), 1);\r\n}\r\nif (wireshark_decryption_is_now_enabled && !airpcap_decryption_was_enabled)\r\n{\r\nset_airpcap_decryption(FALSE);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(decryption_cm), 1);\r\n}\r\nelse if (!wireshark_decryption_is_now_enabled && wireshark_decryption_was_enabled)\r\n{\r\nif (airpcap_decryption_was_enabled)\r\n{\r\nset_airpcap_decryption(TRUE);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(decryption_cm), 2);\r\n}\r\nelse\r\n{\r\nset_airpcap_decryption(FALSE);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(decryption_cm), 0);\r\n}\r\n}\r\n}\r\nstatic guint\r\nmodule_prefs_clean_stash(module_t *module, gpointer user_data _U_)\r\n{\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nprefs_pref_foreach(module, pref_clean_stash, NULL);\r\nreturn 0;\r\n}\r\nstatic gboolean\r\nprefs_main_fetch_all(GtkWidget *dlg, gboolean *must_redissect)\r\n{\r\npref_t *badpref;\r\nswitch (prefs_modules_foreach(module_prefs_check, (gpointer)&badpref)) {\r\ncase PREFS_SET_SYNTAX_ERR:\r\nswitch (badpref->type) {\r\ncase PREF_UINT:\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"The value for \"%s\" isn't a valid number.",\r\nbadpref->title);\r\nreturn FALSE;\r\ncase PREF_RANGE:\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"The value for \"%s\" isn't a valid range.",\r\nbadpref->title);\r\nreturn FALSE;\r\ndefault:\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\n}\r\ngui_prefs_fetch((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_PAGE_KEY));\r\nlayout_prefs_fetch((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_LAYOUT_PAGE_KEY));\r\ncolumn_prefs_fetch((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_COLUMN_PAGE_KEY));\r\nfont_color_prefs_fetch((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_FONT_COLORS_PAGE_KEY));\r\n#ifdef HAVE_LIBPCAP\r\n#ifdef _WIN32\r\nif (has_wpcap) {\r\n#endif\r\ncapture_prefs_fetch((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_CAPTURE_PAGE_KEY));\r\n#ifdef _WIN32\r\n}\r\n#endif\r\n#endif\r\nfilter_expressions_prefs_fetch((GtkWidget *)g_object_get_data(G_OBJECT(dlg),\r\nE_FILTER_EXPRESSIONS_PAGE_KEY));\r\nprefs_modules_foreach(module_prefs_fetch, must_redissect);\r\nreturn TRUE;\r\n}\r\nstatic void\r\nprefs_main_apply_all(GtkWidget *dlg, gboolean redissect)\r\n{\r\nGtkWidget *save_bt;\r\nprefs_apply_all();\r\ngui_prefs_apply((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_PAGE_KEY));\r\nlayout_prefs_apply((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_LAYOUT_PAGE_KEY));\r\ncolumn_prefs_apply((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_COLUMN_PAGE_KEY));\r\nfont_color_prefs_apply((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_FONT_COLORS_PAGE_KEY), redissect);\r\n#ifdef HAVE_LIBPCAP\r\n#ifdef _WIN32\r\nif (has_wpcap) {\r\n#endif\r\ncapture_prefs_apply((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_CAPTURE_PAGE_KEY));\r\n#ifdef _WIN32\r\n}\r\n#endif\r\n#endif\r\nsave_bt = (GtkWidget *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_SAVE_BT_KEY);\r\nif (prefs.gui_use_pref_save) {\r\ngtk_widget_show(save_bt);\r\n} else {\r\ngtk_widget_hide(save_bt);\r\n}\r\n}\r\nstatic void\r\nprefs_main_destroy_all(GtkWidget *dlg)\r\n{\r\nint page_num;\r\nGtkWidget *frame;\r\nfor (page_num = 0;\r\n(frame = gtk_notebook_get_nth_page((GtkNotebook *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY), page_num)) != NULL;\r\npage_num++) {\r\nif (g_object_get_data(G_OBJECT(frame), E_PAGE_ITER_KEY))\r\ngtk_tree_iter_free((GtkTreeIter *)g_object_get_data(G_OBJECT(frame), E_PAGE_ITER_KEY));\r\n}\r\ngui_prefs_destroy((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_PAGE_KEY));\r\nlayout_prefs_destroy((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_LAYOUT_PAGE_KEY));\r\ncolumn_prefs_destroy((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_COLUMN_PAGE_KEY));\r\nfont_color_prefs_destroy((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_GUI_FONT_COLORS_PAGE_KEY));\r\n#ifdef HAVE_LIBPCAP\r\n#ifdef _WIN32\r\nif (has_wpcap) {\r\n#endif\r\ncapture_prefs_destroy((GtkWidget *)g_object_get_data(G_OBJECT(dlg), E_CAPTURE_PAGE_KEY));\r\n#ifdef _WIN32\r\n}\r\n#endif\r\n#endif\r\nprefs_modules_foreach(module_prefs_clean_stash, NULL);\r\n}\r\nstatic guint\r\nmodule_prefs_copy(module_t *module, gpointer user_data _U_)\r\n{\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nprefs_pref_foreach(module, pref_stash, NULL);\r\nreturn 0;\r\n}\r\nstatic void prefs_copy(void) {\r\nprefs_modules_foreach(module_prefs_copy, NULL);\r\n}\r\nstatic void\r\noverwrite_existing_prefs_cb(gpointer dialog _U_, gint btn, gpointer parent_w _U_)\r\n{\r\nswitch (btn) {\r\ncase(ESD_BTN_SAVE):\r\nprefs_main_write();\r\nprefs.unknown_prefs = FALSE;\r\nbreak;\r\ncase(ESD_BTN_DONT_SAVE):\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\n}\r\nstatic void\r\nprefs_main_save(gpointer parent_w)\r\n{\r\nif (prefs.unknown_prefs) {\r\ngpointer dialog;\r\nconst gchar *msg =\r\n"Obsolete or unrecognized preferences have been detected and will be "\r\n"discarded when saving this profile. If you would like to preserve "\r\n"these preferences for a different Wireshark version, click "\r\n"'Continue without Saving' and save this profile under a different name.";\r\nif (prefs.saved_at_version) {\r\ndialog = simple_dialog(ESD_TYPE_CONFIRMATION, ESD_BTNS_SAVE_DONTSAVE,\r\n"These preferences were last saved at version \"%s\".\n%s",\r\nprefs.saved_at_version, msg);\r\n} else {\r\ndialog = simple_dialog(ESD_TYPE_CONFIRMATION, ESD_BTNS_SAVE_DONTSAVE,\r\n"%s", msg);\r\n}\r\nsimple_dialog_set_cb(dialog, overwrite_existing_prefs_cb, parent_w);\r\n} else {\r\nprefs_main_write();\r\n}\r\n}\r\nstatic void\r\nprefs_main_ok_cb(GtkWidget *ok_bt _U_, gpointer parent_w)\r\n{\r\ngboolean must_redissect = FALSE;\r\nif (!prefs_main_fetch_all((GtkWidget *)parent_w, &must_redissect))\r\nreturn;\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_save(parent_w);\r\n}\r\n#ifdef HAVE_AIRPCAP\r\nairpcap_load_decryption_keys(g_airpcap_if_list);\r\n#endif\r\nprefs_main_apply_all((GtkWidget *)parent_w, must_redissect);\r\nprefs_to_capture_opts();\r\n#ifdef HAVE_AIRPCAP\r\nprefs_airpcap_update();\r\n#endif\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nif (must_redissect) {\r\nredissect_packets();\r\nredissect_all_packet_windows();\r\n}\r\n}\r\nstatic void\r\nprefs_main_apply_cb(GtkWidget *apply_bt _U_, gpointer parent_w)\r\n{\r\ngboolean must_redissect = FALSE;\r\nif (!prefs_main_fetch_all((GtkWidget *)parent_w, &must_redissect))\r\nreturn;\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_save(parent_w);\r\nprefs_copy();\r\n}\r\nprefs_main_apply_all((GtkWidget *)parent_w, must_redissect);\r\nprefs_to_capture_opts();\r\n#ifdef HAVE_AIRPCAP\r\nprefs_airpcap_update();\r\n#endif\r\nif (must_redissect) {\r\nredissect_packets();\r\nredissect_all_packet_windows();\r\n}\r\n}\r\nstatic void\r\nprefs_main_save_cb(GtkWidget *save_bt _U_, gpointer parent_w)\r\n{\r\ngboolean must_redissect = FALSE;\r\nif (!prefs_main_fetch_all((GtkWidget *)parent_w, &must_redissect))\r\nreturn;\r\nprefs_main_save(parent_w);\r\nprefs_copy();\r\nprefs_main_apply_all((GtkWidget *)parent_w, must_redissect);\r\nprefs_to_capture_opts();\r\nif (must_redissect) {\r\nredissect_packets();\r\nredissect_all_packet_windows();\r\n}\r\n}\r\nstatic guint\r\nmodule_prefs_revert(module_t *module, gpointer user_data)\r\n{\r\ngboolean *must_redissect_p = (gboolean *)user_data;\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nmodule->prefs_changed = FALSE;\r\nprefs_pref_foreach(module, pref_unstash, &module->prefs_changed);\r\nif (module->prefs_changed)\r\n*must_redissect_p = TRUE;\r\nreturn 0;\r\n}\r\nstatic void\r\nprefs_main_cancel_cb(GtkWidget *cancel_bt _U_, gpointer parent_w)\r\n{\r\ngboolean must_redissect = FALSE;\r\ncfile.columns_changed = FALSE;\r\nprefs_modules_foreach(module_prefs_revert, &must_redissect);\r\nprefs_main_apply_all((GtkWidget *)parent_w, must_redissect);\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nif (must_redissect) {\r\nredissect_packets();\r\nredissect_all_packet_windows();\r\n}\r\n}\r\nstatic gboolean\r\nprefs_main_delete_event_cb(GtkWidget *prefs_w_lcl, GdkEvent *event _U_,\r\ngpointer user_data _U_)\r\n{\r\nprefs_main_cancel_cb(NULL, prefs_w_lcl);\r\nreturn FALSE;\r\n}\r\nstatic void\r\nprefs_main_destroy_cb(GtkWidget *win _U_, gpointer parent_w)\r\n{\r\nprefs_main_destroy_all((GtkWidget *)parent_w);\r\nprefs_w = NULL;\r\n}\r\nstatic guint\r\nmodule_search_properties(module_t *module, gpointer user_data)\r\n{\r\nstruct properties_data *p = (struct properties_data *)user_data;\r\nif (!module->use_gui) {\r\nreturn 0;\r\n}\r\nif (strcmp(module->title, p->title) == 0) {\r\np->module = module;\r\nreturn 1;\r\n}\r\nif (prefs_module_has_submodules(module))\r\nreturn prefs_modules_foreach_submodules(module, module_search_properties, p);\r\nreturn 0;\r\n}\r\nstatic void\r\ntree_expand_row(GtkTreeModel *model, GtkTreeView *tree_view, GtkTreeIter *iter)\r\n{\r\nGtkTreeIter parent;\r\nGtkTreePath *path;\r\nif (gtk_tree_model_iter_parent(model, &parent, iter))\r\ntree_expand_row(model, tree_view, &parent);\r\npath = gtk_tree_model_get_path(model, iter);\r\ngtk_tree_view_expand_row(tree_view, path, FALSE);\r\ngtk_tree_path_free(path);\r\n}\r\nstatic void\r\ntree_select_node(GtkWidget *tree, prefs_tree_iter *iter)\r\n{\r\nGtkTreeIter local_iter = *iter;\r\nGtkTreeView *tree_view = GTK_TREE_VIEW(tree);\r\nGtkTreeModel *model;\r\nGtkTreePath *first_path;\r\nmodel = gtk_tree_view_get_model(tree_view);\r\nfirst_path = gtk_tree_model_get_path(model, &local_iter);\r\ntree_expand_row(model, tree_view, &local_iter);\r\ngtk_tree_selection_select_path(gtk_tree_view_get_selection(tree_view),\r\nfirst_path);\r\ngtk_tree_view_scroll_to_cell(tree_view, first_path, NULL, TRUE, 0.5f, 0.0f);\r\ngtk_tree_path_free(first_path);\r\n}\r\nvoid\r\nproperties_cb(GtkWidget *w, gpointer dummy)\r\n{\r\nheader_field_info *hfinfo;\r\nconst gchar *title = NULL;\r\nstruct properties_data p;\r\nint page_num;\r\nGtkWidget *sw;\r\nGtkWidget *frame;\r\nmodule_t *page_module;\r\nif (cfile.finfo_selected == NULL) {\r\nconst gchar *abbrev;\r\nif (cfile.edt && cfile.edt->tree) {\r\nGPtrArray *ga;\r\nfield_info *v;\r\nguint i;\r\nga = proto_all_finfos(cfile.edt->tree);\r\nfor (i = ga->len - 1; i > 0 ; i -= 1) {\r\nv = (field_info *)g_ptr_array_index (ga, i);\r\nhfinfo = v->hfinfo;\r\nif (!g_str_has_prefix(hfinfo->abbrev, "text") &&\r\n!g_str_has_prefix(hfinfo->abbrev, "_ws.expert") &&\r\n!g_str_has_prefix(hfinfo->abbrev, "_ws.malformed")) {\r\nif (hfinfo->parent == -1) {\r\nabbrev = hfinfo->abbrev;\r\n} else {\r\nabbrev = proto_registrar_get_abbrev(hfinfo->parent);\r\n}\r\ntitle = prefs_get_title_by_name(abbrev);\r\nbreak;\r\n}\r\n}\r\n}\r\n} else {\r\nhfinfo = cfile.finfo_selected->hfinfo;\r\nif (hfinfo->parent == -1)\r\ntitle = prefs_get_title_by_name(hfinfo->abbrev);\r\nelse\r\ntitle = prefs_get_title_by_name(proto_registrar_get_abbrev(hfinfo->parent));\r\n}\r\nif (!title)\r\nreturn;\r\np.title = title;\r\np.module = NULL;\r\nprefs_modules_foreach_submodules(protocols_module, module_search_properties,\r\n&p);\r\nif (p.module == NULL) {\r\nreturn;\r\n}\r\nif (prefs_w != NULL) {\r\nreactivate_window(prefs_w);\r\n} else {\r\nprefs_cb(w, dummy);\r\n}\r\nfor (page_num = 0;\r\n(sw = gtk_notebook_get_nth_page((GtkNotebook *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY), page_num)) != NULL;\r\npage_num++) {\r\nframe = (GtkWidget *)g_object_get_data(G_OBJECT(sw), E_PAGESW_FRAME_KEY);\r\nif (frame) {\r\npage_module = (module_t *)g_object_get_data(G_OBJECT(frame), E_PAGE_MODULE_KEY);\r\nif (page_module != NULL) {\r\nif (page_module == p.module) {\r\ntree_select_node(\r\n(GtkWidget *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_TREE_KEY),\r\n(GtkTreeIter *)g_object_get_data(G_OBJECT(frame), E_PAGE_ITER_KEY));\r\nreturn;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nprefs_tree_select_cb(GtkTreeSelection *sel, gpointer dummy _U_)\r\n{\r\ngint page;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter))\r\n{\r\ngtk_tree_model_get(model, &iter, 1, &page, -1);\r\nif (page >= 0)\r\ngtk_notebook_set_current_page((GtkNotebook *)g_object_get_data(G_OBJECT(prefs_w), E_PREFSW_NOTEBOOK_KEY), page);\r\n}\r\n}

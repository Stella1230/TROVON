int\r\ninet_pton(int af, const char *src, void *dst)\r\n{\r\nswitch (af) {\r\n#ifdef AF_INET\r\ncase AF_INET:\r\nreturn (inet_pton4(src, dst));\r\n#endif\r\n#ifdef AF_INET6\r\ncase AF_INET6:\r\nreturn (inet_pton6(src, dst));\r\n#endif\r\ndefault:\r\nerrno = EAFNOSUPPORT;\r\nreturn (-1);\r\n}\r\n}\r\nstatic int\r\ninet_pton4(const char *src, u_char *dst)\r\n{\r\nstatic const char digits[] = "0123456789";\r\nint saw_digit, octets, ch;\r\nu_char tmp[NS_INADDRSZ], *tp;\r\nsaw_digit = 0;\r\noctets = 0;\r\n*(tp = tmp) = 0;\r\nwhile ((ch = *src++) != '\0') {\r\nconst char *pch;\r\nif ((pch = strchr(digits, ch)) != NULL) {\r\nsize_t new = *tp * 10 + (pch - digits);\r\nif (new > 255)\r\nreturn (0);\r\n*tp = (u_char) new;\r\nif (! saw_digit) {\r\nif (++octets > 4)\r\nreturn (0);\r\nsaw_digit = 1;\r\n}\r\n} else if (ch == '.' && saw_digit) {\r\nif (octets == 4)\r\nreturn (0);\r\n*++tp = 0;\r\nsaw_digit = 0;\r\n} else\r\nreturn (0);\r\n}\r\nif (octets < 4)\r\nreturn (0);\r\nmemcpy(dst, tmp, NS_INADDRSZ);\r\nreturn (1);\r\n}\r\nstatic int\r\ninet_pton6(const char *src, u_char *dst)\r\n{\r\nstatic const char xdigits_l[] = "0123456789abcdef",\r\nxdigits_u[] = "0123456789ABCDEF";\r\nu_char tmp[NS_IN6ADDRSZ], *tp, *endp, *colonp;\r\nconst char *xdigits, *curtok;\r\nint ch, saw_xdigit;\r\nu_int val;\r\nmemset((tp = tmp), '\0', NS_IN6ADDRSZ);\r\nendp = tp + NS_IN6ADDRSZ;\r\ncolonp = NULL;\r\nif (*src == ':')\r\nif (*++src != ':')\r\nreturn (0);\r\ncurtok = src;\r\nsaw_xdigit = 0;\r\nval = 0;\r\nwhile ((ch = *src++) != '\0') {\r\nconst char *pch;\r\nif ((pch = strchr((xdigits = xdigits_l), ch)) == NULL)\r\npch = strchr((xdigits = xdigits_u), ch);\r\nif (pch != NULL) {\r\nval <<= 4;\r\nval |= (pch - xdigits);\r\nif (val > 0xffff)\r\nreturn (0);\r\nsaw_xdigit = 1;\r\ncontinue;\r\n}\r\nif (ch == ':') {\r\ncurtok = src;\r\nif (!saw_xdigit) {\r\nif (colonp)\r\nreturn (0);\r\ncolonp = tp;\r\ncontinue;\r\n} else if (*src == '\0') {\r\nreturn (0);\r\n}\r\nif (tp + NS_INT16SZ > endp)\r\nreturn (0);\r\n*tp++ = (u_char) (val >> 8) & 0xff;\r\n*tp++ = (u_char) val & 0xff;\r\nsaw_xdigit = 0;\r\nval = 0;\r\ncontinue;\r\n}\r\nif (ch == '.' && ((tp + NS_INADDRSZ) <= endp) &&\r\ninet_pton4(curtok, tp) > 0) {\r\ntp += NS_INADDRSZ;\r\nsaw_xdigit = 0;\r\nbreak;\r\n}\r\nreturn (0);\r\n}\r\nif (saw_xdigit) {\r\nif (tp + NS_INT16SZ > endp)\r\nreturn (0);\r\n*tp++ = (u_char) (val >> 8) & 0xff;\r\n*tp++ = (u_char) val & 0xff;\r\n}\r\nif (colonp != NULL) {\r\nconst int n = (int) (tp - colonp);\r\nint i;\r\nif (tp == endp)\r\nreturn (0);\r\nfor (i = 1; i <= n; i++) {\r\nendp[- i] = colonp[n - i];\r\ncolonp[n - i] = 0;\r\n}\r\ntp = endp;\r\n}\r\nif (tp != endp)\r\nreturn (0);\r\nmemcpy(dst, tmp, NS_IN6ADDRSZ);\r\nreturn (1);\r\n}

static void\r\ndissect_nasdaq_soup_packet(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, proto_tree *tree, int offset, int linelen)\r\n{\r\nguint8 nasdaq_soup_type;\r\ntvbuff_t *new_tvb = NULL;\r\nnasdaq_soup_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_nasdaq_soup_packet_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nswitch (nasdaq_soup_type) {\r\ncase '+':\r\nproto_tree_add_item(tree, hf_nasdaq_soup_text, tvb, offset, linelen -1, ENC_ASCII|ENC_NA);\r\noffset += linelen -1;\r\nbreak;\r\ncase 'A':\r\nproto_tree_add_item(tree, hf_nasdaq_soup_session, tvb, offset, 10, ENC_ASCII|ENC_NA);\r\noffset += 10;\r\nproto_tree_add_item(tree, hf_nasdaq_soup_seq_number, tvb, offset, 10, ENC_ASCII|ENC_NA);\r\noffset += 10;\r\nbreak;\r\ncase 'J':\r\nproto_tree_add_item(tree, hf_nasdaq_soup_reject_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase 'U':\r\ncase 'S':\r\nif (linelen > 1 && nasdaq_itch_handle) {\r\nnew_tvb = tvb_new_subset_length(tvb, offset,linelen -1);\r\n} else {\r\nproto_tree_add_item(tree, hf_nasdaq_soup_message, tvb, offset, linelen -1, ENC_ASCII|ENC_NA);\r\n}\r\noffset += linelen -1;\r\nbreak;\r\ncase 'L':\r\nproto_tree_add_item(tree, hf_nasdaq_soup_username, tvb, offset, 6, ENC_ASCII|ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(tree, hf_nasdaq_soup_password, tvb, offset, 10, ENC_ASCII|ENC_NA);\r\noffset += 10;\r\nproto_tree_add_item(tree, hf_nasdaq_soup_session, tvb, offset, 10, ENC_ASCII|ENC_NA);\r\noffset += 10;\r\nproto_tree_add_item(tree, hf_nasdaq_soup_seq_number, tvb, offset, 10, ENC_ASCII|ENC_NA);\r\noffset += 10;\r\nbreak;\r\ncase 'H':\r\ncase 'O':\r\ncase 'R':\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(tree, hf_nasdaq_soup_message, tvb, offset, linelen -1, ENC_ASCII|ENC_NA);\r\noffset += linelen -1;\r\nbreak;\r\n}\r\nproto_tree_add_item(tree, hf_nasdaq_soup_packet_eol, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\nif (new_tvb) {\r\ncall_dissector(nasdaq_itch_handle, new_tvb, pinfo, parent_tree);\r\n}\r\nreturn;\r\n}\r\nstatic int\r\ndissect_nasdaq_soup(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *nasdaq_soup_tree = NULL;\r\nguint8 nasdaq_soup_type;\r\nint linelen;\r\ngint next_offset;\r\nint offset = 0;\r\ngint counter = 0;\r\nwhile (tvb_offset_exists(tvb, offset)) {\r\nlinelen = tvb_find_line_end(tvb, offset, -1, &next_offset, nasdaq_soup_desegment && pinfo->can_desegment);\r\nif (linelen == -1) {\r\npinfo->desegment_offset = offset;\r\npinfo->desegment_len = DESEGMENT_ONE_MORE_SEGMENT;\r\nreturn tvb_captured_length(tvb);\r\n}\r\nnasdaq_soup_type = tvb_get_guint8(tvb, offset);\r\nif (counter == 0) {\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Nasdaq-SOUP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n}\r\nif (counter) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, "; ");\r\ncol_set_fence(pinfo->cinfo, COL_INFO);\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str(nasdaq_soup_type, message_types_val, "Unknown packet type (0x%02x)"));\r\ncounter++;\r\nti = proto_tree_add_item(tree, proto_nasdaq_soup, tvb, offset, linelen +1, ENC_NA);\r\nnasdaq_soup_tree = proto_item_add_subtree(ti, ett_nasdaq_soup);\r\ndissect_nasdaq_soup_packet(tvb, pinfo, tree, nasdaq_soup_tree, offset, linelen);\r\noffset = next_offset;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void nasdaq_soup_prefs(void)\r\n{\r\ndissector_delete_uint_range("tcp.port", nasdaq_soup_tcp_range, nasdaq_soup_handle);\r\ng_free(nasdaq_soup_tcp_range);\r\nnasdaq_soup_tcp_range = range_copy(global_nasdaq_soup_tcp_range);\r\ndissector_add_uint_range("tcp.port", nasdaq_soup_tcp_range, nasdaq_soup_handle);\r\n}\r\nvoid\r\nproto_register_nasdaq_soup(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_nasdaq_soup_packet_type,\r\n{ "Packet Type", "nasdaq-soup.packet_type",\r\nFT_UINT8, BASE_DEC, VALS(message_types_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_reject_code,\r\n{ "Login Reject Code", "nasdaq-soup.reject_code",\r\nFT_UINT8, BASE_DEC, VALS(reject_code_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_message,\r\n{ "Message", "nasdaq-soup.message",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_text,\r\n{ "Debug Text", "nasdaq-soup.text",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_username,\r\n{ "User Name", "nasdaq-soup.username",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_password,\r\n{ "Password", "nasdaq-soup.password",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_session,\r\n{ "Session", "nasdaq-soup.session",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Session ID", HFILL }},\r\n{ &hf_nasdaq_soup_seq_number,\r\n{ "Sequence number", "nasdaq-soup.seq_number",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_soup_packet_eol,\r\n{ "End Of Packet", "nasdaq-soup.packet_eol",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_nasdaq_soup\r\n};\r\nmodule_t *nasdaq_soup_module;\r\nproto_nasdaq_soup = proto_register_protocol("Nasdaq-SoupTCP version 2.0","NASDAQ-SOUP", "nasdaq_soup");\r\nproto_register_field_array(proto_nasdaq_soup, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nnasdaq_soup_module = prefs_register_protocol(proto_nasdaq_soup, nasdaq_soup_prefs);\r\nprefs_register_bool_preference(nasdaq_soup_module, "desegment",\r\n"Reassemble Nasdaq-SoupTCP messages spanning multiple TCP segments",\r\n"Whether the Nasdaq-SoupTCP dissector should reassemble messages spanning multiple TCP segments.",\r\n&nasdaq_soup_desegment);\r\nprefs_register_range_preference(nasdaq_soup_module, "tcp.port", "TCP Ports", "TCP Ports range", &global_nasdaq_soup_tcp_range, 65535);\r\nnasdaq_soup_tcp_range = range_empty();\r\n}\r\nvoid\r\nproto_reg_handoff_nasdaq_soup(void)\r\n{\r\nnasdaq_soup_handle = create_dissector_handle(dissect_nasdaq_soup, proto_nasdaq_soup);\r\nnasdaq_itch_handle = find_dissector_add_dependency("nasdaq-itch", proto_nasdaq_soup);\r\ndissector_add_for_decode_as("tcp.port", nasdaq_soup_handle);\r\n}

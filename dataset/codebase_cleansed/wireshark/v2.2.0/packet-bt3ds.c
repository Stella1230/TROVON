static gint\r\ndissect_bt3ds(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *main_item;\r\nproto_tree *main_tree;\r\nproto_item *sub_item;\r\ngint offset = 0;\r\nguint8 value;\r\nmain_item = proto_tree_add_item(tree, proto_bt3ds, tvb, offset, -1, ENC_NA);\r\nmain_tree = proto_item_add_subtree(main_item, ett_bt3ds);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "3DS");\r\nswitch (pinfo->p2p_dir) {\r\ncase P2P_DIR_SENT:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Sent ");\r\nbreak;\r\ncase P2P_DIR_RECV:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "UnknownDirection ");\r\nbreak;\r\n}\r\nsub_item = proto_tree_add_item(main_tree, hf_message_opcode, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nvalue = tvb_get_guint8(tvb, offset);\r\nif (value > 0)\r\nexpert_add_info(pinfo, sub_item, &ei_message_opcode_reserved);\r\noffset += 1;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", val_to_str_const(value, message_opcode_vals, "Unknown"));\r\nsub_item = proto_tree_add_item(main_tree, hf_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_user_request_for_battery_level_display, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_association_notification, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nvalue = tvb_get_guint8(tvb, offset) >> 2;\r\nif (value != 0)\r\nexpert_add_info(pinfo, sub_item, &ei_reserved);\r\noffset += 1;\r\nsub_item = proto_tree_add_item(main_tree, hf_battery_level, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nvalue = tvb_get_guint8(tvb, offset);\r\nif (value >= 101 && value <= 254)\r\nexpert_add_info(pinfo, sub_item, &ei_battery_level_reserved);\r\nelse if (value == 255)\r\nproto_item_append_text(sub_item, "Battery Level Reporting Not Supported");\r\noffset += 1;\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(main_tree, pinfo, &ei_unexpected_data, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_bt3ds(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t *expert_bt3ds;\r\nstatic ei_register_info ei[] = {\r\n{ &ei_message_opcode_reserved, { "bt3ds.expert.message_opcode.reserved", PI_PROTOCOL, PI_NOTE, "Value is reserved", EXPFILL }},\r\n{ &ei_reserved, { "bt3ds.expert.reserved", PI_PROTOCOL, PI_NOTE, "Value is reserved", EXPFILL }},\r\n{ &ei_battery_level_reserved, { "bt3ds.expert.battery_level.reserved", PI_PROTOCOL, PI_NOTE, "Value is reserved", EXPFILL }},\r\n{ &ei_unexpected_data, { "bt3ds.expert.unexpected_data", PI_PROTOCOL, PI_WARN, "Unexpected data", EXPFILL }}\r\n};\r\nstatic hf_register_info hf[] = {\r\n{ &hf_message_opcode,\r\n{ "Message Opcode", "bt3ds.message_opcode",\r\nFT_UINT8, BASE_HEX, VALS(message_opcode_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_association_notification,\r\n{ "Association Notification", "bt3ds.association_notification",\r\nFT_BOOLEAN, 8, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_user_request_for_battery_level_display,\r\n{ "User Request for Battery Level Display", "bt3ds.user_request_for_battery_level_display",\r\nFT_BOOLEAN, 8, NULL, 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_reserved,\r\n{ "Reserved", "bt3ds.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0xFC,\r\nNULL, HFILL }\r\n},\r\n{ &hf_battery_level,\r\n{ "Battery Level", "bt3ds.battery_level",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\n"0-100% of current charge level of battery", HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_bt3ds\r\n};\r\nproto_bt3ds = proto_register_protocol("Bluetooth 3DS Profile", "BT 3DS", "bt3ds");\r\nb3ds_handle = register_dissector("bt3ds", dissect_bt3ds, proto_bt3ds);\r\nproto_register_field_array(proto_bt3ds, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_bt3ds = expert_register_protocol(proto_bt3ds);\r\nexpert_register_field_array(expert_bt3ds, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_bt3ds, NULL);\r\nprefs_register_static_text_preference(module, "3ds.version",\r\n"Bluetooth Profile 3DS version: 1.0",\r\n"Version of profile supported by this dissector.");\r\n}\r\nvoid\r\nproto_reg_handoff_bt3ds(void)\r\n{\r\ndissector_add_string("bluetooth.uuid", "1137", b3ds_handle);\r\ndissector_add_string("bluetooth.uuid", "1138", b3ds_handle);\r\ndissector_add_string("bluetooth.uuid", "1139", b3ds_handle);\r\ndissector_add_uint("btl2cap.psm", BTL2CAP_PSM_3DS, b3ds_handle);\r\ndissector_add_for_decode_as("btl2cap.cid", b3ds_handle);\r\n}

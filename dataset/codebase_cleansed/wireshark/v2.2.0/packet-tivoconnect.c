static int\r\ndissect_tivoconnect(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gboolean is_tcp)\r\n{\r\ngchar * string;\r\ngint length;\r\nconst gchar * proto_name;\r\ngchar * packet_identity = NULL;\r\ngchar * packet_machine = NULL;\r\nif ( tvb_strncaseeql(tvb, 0, "tivoconnect", 11) != 0) {\r\nreturn 0;\r\n}\r\nlength = tvb_captured_length(tvb);\r\nstring = (gchar*)tvb_get_string_enc(wmem_packet_scope(), tvb, 0, length, ENC_ASCII);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "TiVoConnect");\r\nproto_name = is_tcp ? "Discovery Connection" : "Discovery Beacon";\r\ncol_set_str(pinfo->cinfo, COL_INFO, proto_name);\r\n{\r\nproto_item *ti;\r\nproto_tree *tivoconnect_tree;\r\nguint offset = 0;\r\ngchar * field;\r\nti = proto_tree_add_item(tree, proto_tivoconnect, tvb, 0, -1, ENC_NA);\r\ntivoconnect_tree = proto_item_add_subtree(ti, ett_tivoconnect);\r\nfor ( field = strtok(string, "\n");\r\nfield;\r\noffset += length, field = strtok(NULL, "\n") ) {\r\ngchar * value;\r\ngint fieldlen;\r\nlength = (int)strlen(field) + 1;\r\nif ( !(value = strchr(field, '=')) ) {\r\ncontinue;\r\n}\r\n*value++ = '\0';\r\nfieldlen = (int)strlen(field) + 1;\r\nif ( g_ascii_strcasecmp(field, "tivoconnect") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_flavor, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\n}\r\nelse if ( g_ascii_strcasecmp(field, "method") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_method, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\n}\r\nelse if ( g_ascii_strcasecmp(field, "platform") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_platform, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\n}\r\nelse if ( g_ascii_strcasecmp(field, "machine") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_machine, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\npacket_machine = value;\r\n}\r\nelse if ( g_ascii_strcasecmp(field, "identity") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_identity, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\npacket_identity = value;\r\n}\r\nelse if ( g_ascii_strcasecmp(field, "services") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_services, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\n}\r\nelse if ( g_ascii_strcasecmp(field, "swversion") == 0 ) {\r\nproto_tree_add_item(tivoconnect_tree,\r\nhf_tivoconnect_version, tvb, offset+fieldlen,\r\nlength-fieldlen-1, ENC_ASCII|ENC_NA);\r\n}\r\nelse {\r\n}\r\n}\r\nif (packet_machine) {\r\nproto_item_append_text(ti, ", %s", packet_machine);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s %s",\r\nproto_name, packet_machine);\r\n}\r\nif (packet_identity) {\r\nproto_item_append_text(ti,\r\npacket_machine ? " (%s)" : ", ID:%s",\r\npacket_identity);\r\nif (packet_machine) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s %s (%s)",\r\nproto_name, packet_machine, packet_identity);\r\n}\r\nelse {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ID:%s",\r\nproto_name, packet_identity);\r\n}\r\n}\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic int\r\ndissect_tivoconnect_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_tivoconnect(tvb, pinfo, tree, TRUE);\r\n}\r\nstatic int\r\ndissect_tivoconnect_udp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_tivoconnect(tvb, pinfo, tree, FALSE);\r\n}\r\nvoid\r\nproto_register_tivoconnect(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_tivoconnect_flavor,\r\n{ "Flavor", "tivoconnect.flavor",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"Protocol Flavor supported by the originator", HFILL }},\r\n{ &hf_tivoconnect_method,\r\n{ "Method", "tivoconnect.method",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"Packet was delivered via UDP(broadcast) or TCP(connected)", HFILL }},\r\n{ &hf_tivoconnect_platform,\r\n{ "Platform", "tivoconnect.platform",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"System platform, either tcd(TiVo) or pc(Computer)", HFILL }},\r\n{ &hf_tivoconnect_machine,\r\n{ "Machine", "tivoconnect.machine",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"Human-readable system name", HFILL }},\r\n{ &hf_tivoconnect_identity,\r\n{ "Identity", "tivoconnect.identity",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"Unique serial number for the system", HFILL }},\r\n{ &hf_tivoconnect_services,\r\n{ "Services", "tivoconnect.services",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"List of available services on the system", HFILL }},\r\n{ &hf_tivoconnect_version,\r\n{ "Version", "tivoconnect.version",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\n"System software version", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_tivoconnect,\r\n};\r\nproto_tivoconnect = proto_register_protocol("TiVoConnect Discovery Protocol",\r\n"TiVoConnect", "tivoconnect");\r\nproto_register_field_array(proto_tivoconnect, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_tivoconnect(void)\r\n{\r\ndissector_handle_t tivoconnect_tcp_handle, tivoconnect_udp_handle;\r\ntivoconnect_tcp_handle = create_dissector_handle(dissect_tivoconnect_tcp, proto_tivoconnect);\r\ntivoconnect_udp_handle = create_dissector_handle(dissect_tivoconnect_udp, proto_tivoconnect);\r\ndissector_add_uint("udp.port", 2190, tivoconnect_udp_handle);\r\ndissector_add_uint("tcp.port", 2190, tivoconnect_tcp_handle);\r\n}

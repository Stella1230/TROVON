char *\r\nget_args_as_string(int argc, char **argv, int optindex)\r\n{\r\nint len;\r\nint i;\r\nchar *argstring;\r\nlen = 0;\r\nfor (i = optindex; i < argc; i++) {\r\nlen += (int) strlen(argv[i]);\r\nlen++;\r\n}\r\nargstring = (char *)g_malloc(len);\r\nargstring[0] = '\0';\r\ni = optindex;\r\nfor (;;) {\r\ng_strlcat(argstring, argv[i], len);\r\ni++;\r\nif (i == argc)\r\nbreak;\r\ng_strlcat(argstring, " ", len);\r\n}\r\nreturn argstring;\r\n}\r\nvoid\r\ncompute_timestamp_diff(gint *diffsec, gint *diffusec,\r\nguint32 sec1, guint32 usec1, guint32 sec2, guint32 usec2)\r\n{\r\nif (sec1 == sec2) {\r\n*diffsec = sec1 - sec2;\r\n*diffusec = usec1 - usec2;\r\n} else if (sec1 <= sec2) {\r\n*diffsec = sec1 - sec2;\r\nif (usec2 >= usec1) {\r\n*diffusec = usec1 - usec2;\r\n} else {\r\n*diffusec = (usec1 - 1000000) - usec2;\r\n(*diffsec)++;\r\n}\r\n} else {\r\n*diffsec = sec1 - sec2;\r\nif (usec2 <= usec1) {\r\n*diffusec = usec1 - usec2;\r\n} else {\r\n*diffusec = (usec1 + 1000000) - usec2;\r\n(*diffsec)--;\r\n}\r\n}\r\n}\r\nstatic char *sanitize_filter_ip(char *hostname) {\r\ngchar *end;\r\ngchar *ret;\r\nret = g_strdup(hostname);\r\nif (!ret)\r\nreturn NULL;\r\nend = strchr(ret, '%');\r\nif (end)\r\n*end = '\0';\r\nreturn ret;\r\n}\r\nconst gchar *get_conn_cfilter(void) {\r\nstatic GString *filter_str = NULL;\r\ngchar *env, **tokens;\r\nchar *lastp, *lastc, *p;\r\nchar *pprotocol = NULL;\r\nchar *phostname = NULL;\r\nsize_t hostlen;\r\nchar *remip, *locip;\r\nif (filter_str == NULL) {\r\nfilter_str = g_string_new("");\r\n}\r\nif ((env = getenv("SSH_CONNECTION")) != NULL) {\r\ntokens = g_strsplit(env, " ", 4);\r\nif (g_strv_length(tokens) == 4) {\r\nremip = sanitize_filter_ip(tokens[0]);\r\nlocip = sanitize_filter_ip(tokens[2]);\r\ng_string_printf(filter_str, "not (tcp port %s and host %s "\r\n"and tcp port %s and host %s)", tokens[1], remip,\r\ntokens[3], locip);\r\ng_free(remip);\r\ng_free(locip);\r\n}\r\ng_strfreev(tokens);\r\n} else if ((env = getenv("SSH_CLIENT")) != NULL) {\r\ntokens = g_strsplit(env, " ", 3);\r\nif (g_strv_length(tokens) == 3) {\r\nremip = sanitize_filter_ip(tokens[2]);\r\ng_string_printf(filter_str, "not (tcp port %s and host %s "\r\n"and tcp port %s)", tokens[1], tokens[0], remip);\r\ng_free(remip);\r\n}\r\ng_strfreev(tokens);\r\n} else if ((env = getenv("REMOTEHOST")) != NULL) {\r\nif (g_ascii_strcasecmp(env, "localhost") == 0 ||\r\nstrcmp(env, "127.0.0.1") == 0 ||\r\nstrcmp(env, "") == 0) {\r\nreturn "";\r\n}\r\nremip = sanitize_filter_ip(env);\r\ng_string_printf(filter_str, "not host %s", remip);\r\ng_free(remip);\r\n} else if ((env = getenv("DISPLAY")) != NULL) {\r\np = env;\r\nfor (lastp = p; *p != '\0' && *p != ':' && *p != '/'; p++)\r\n;\r\nif (*p == '\0')\r\nreturn "";\r\nif (p != lastp && *p != ':') {\r\npprotocol = p;\r\nif (p - lastp != 3 || g_ascii_strncasecmp(lastp, "tcp", 3) != 0)\r\nreturn "";\r\np++;\r\n} else\r\np = env;\r\nlastp = p;\r\nlastc = NULL;\r\nfor (; *p != '\0'; p++)\r\nif (*p == ':')\r\nlastc = p;\r\nif (lastc == NULL)\r\nreturn "";\r\nif ((lastp != lastc) && (*(lastc - 1) == ':')\r\n&& (((lastc - 1) == lastp) || (*(lastc - 2) != ':'))) {\r\nreturn "";\r\n} else\r\nhostlen = lastc - lastp;\r\nif (hostlen == 0)\r\nreturn "";\r\nphostname = (char *)g_malloc(hostlen + 1);\r\nmemcpy(phostname, lastp, hostlen);\r\nphostname[hostlen] = '\0';\r\nif (pprotocol == NULL) {\r\nif (g_ascii_strcasecmp(phostname, "localhost") == 0 ||\r\nstrcmp(phostname, "127.0.0.1") == 0) {\r\ng_free(phostname);\r\nreturn "";\r\n}\r\nif (strcmp(phostname, "unix") == 0) {\r\ng_free(phostname);\r\nreturn "";\r\n}\r\nif (phostname[0] == '/') {\r\ng_free(phostname);\r\nreturn "";\r\n}\r\n}\r\ng_string_printf(filter_str, "not host %s", phostname);\r\ng_free(phostname);\r\n#ifdef _WIN32\r\n} else if (GetSystemMetrics(SM_REMOTESESSION)) {\r\ng_string_printf(filter_str, "not port 3389");\r\n#endif\r\n} else {\r\nreturn "";\r\n}\r\nreturn filter_str->str;\r\n}\r\ngboolean display_is_remote(void)\r\n{\r\nstatic gboolean remote_display_checked;\r\nstatic gboolean is_remote;\r\nif (!remote_display_checked) {\r\nis_remote = (strlen(get_conn_cfilter()) > 0);\r\n}\r\nreturn is_remote;\r\n}

static void\r\ndissect_mtp3mg_unknown_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 message_length;\r\nmessage_length = tvb_captured_length(tvb);\r\nproto_tree_add_expert_format(tree, pinfo, &ei_mtp3mg_unknown_message, tvb, 0, message_length,\r\n"Unknown message (%u byte%s)", message_length,\r\nplurality(message_length, "", "s"));\r\n}\r\nstatic void\r\ndissect_mtp3mg_chm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, chm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase CHM_H1_COO:\r\ncase CHM_H1_COA:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_coo_ansi_slc, tvb, 0,\r\nANSI_COO_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_coo_ansi_fsn, tvb, 0,\r\nANSI_COO_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else {\r\nproto_tree_add_item(tree, hf_mtp3mg_coo_itu_fsn, tvb, 0,\r\nITU_COO_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase CHM_H1_XCO:\r\ncase CHM_H1_XCA:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_xco_ansi_slc, tvb, 0,\r\nANSI_XCO_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_xco_ansi_fsn, tvb, 0,\r\nANSI_XCO_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else {\r\nproto_tree_add_item(tree, hf_mtp3mg_xco_itu_fsn, tvb, 0,\r\nITU_XCO_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase CHM_H1_CBD:\r\ncase CHM_H1_CBA:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_cbd_ansi_slc, tvb, 0,\r\nANSI_CBD_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_cbd_ansi_cbc, tvb, 0,\r\nANSI_CBD_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else if (mtp3_standard == JAPAN_STANDARD) {\r\nproto_tree_add_item(tree, hf_mtp3mg_cbd_japan_cbc, tvb, 0,\r\nITU_CBD_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else {\r\nproto_tree_add_item(tree, hf_mtp3mg_cbd_itu_cbc, tvb, 0,\r\nITU_CBD_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_ecm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, ecm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase ECM_H1_ECO:\r\ncase ECM_H1_ECA:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_eco_ansi_slc, tvb, 0,\r\nANSI_ECO_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_fcm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\nproto_item *apc_item;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, fcm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase FCM_H1_RCT:\r\nbreak;\r\ncase FCM_H1_TFC:\r\nif (mtp3_standard == ITU_STANDARD)\r\n{\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_itu_apc, tvb, 0,\r\nITU_PC_LENGTH, ENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, 0) & ITU_PC_MASK;\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\nproto_tree_add_item(tree, hf_mtp3mg_tfc_itu_status, tvb, 0,\r\nITU_TFC_STATUS_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else if (mtp3_standard == JAPAN_STANDARD) {\r\nproto_tree_add_item(tree, hf_mtp3mg_tfc_japan_spare, tvb,\r\nJAPAN_TFC_SPARE_OFFSET,\r\nJAPAN_TFC_SPARE_LENGTH, ENC_LITTLE_ENDIAN);\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_japan_apc, tvb,\r\nJAPAN_TFC_APC_OFFSET,\r\nJAPAN_PC_LENGTH, ENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, JAPAN_TFC_APC_OFFSET);\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\nproto_tree_add_item(tree, hf_mtp3mg_tfc_japan_status, tvb,\r\nJAPAN_TFC_STATUS_OFFSET,\r\nJAPAN_TFC_STATUS_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_tfc_japan_status_spare, tvb,\r\nJAPAN_TFC_STATUS_OFFSET,\r\nJAPAN_TFC_STATUS_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else {\r\nint hf_apc_string;\r\nif (mtp3_standard == ANSI_STANDARD) {\r\nhf_apc_string = hf_mtp3mg_ansi_apc;\r\n} else {\r\nhf_apc_string = hf_mtp3mg_chinese_apc;\r\n}\r\ndissect_mtp3_3byte_pc(tvb, 0, tree, ett_mtp3mg_fcm_apc,\r\nhf_apc_string, hf_mtp3mg_apc_network,\r\nhf_mtp3mg_apc_cluster,\r\nhf_mtp3mg_apc_member, 0, 0);\r\nproto_tree_add_item(tree, hf_mtp3mg_tfc_ansi_status, tvb,\r\nANSI_TFC_STATUS_OFFSET, ANSI_TFC_STATUS_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_tfm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\nproto_item *apc_item;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, tfm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase TFM_H1_TFP:\r\ncase TFM_H1_TCP:\r\ncase TFM_H1_TFR:\r\ncase TFM_H1_TCR:\r\ncase TFM_H1_TFA:\r\ncase TFM_H1_TCA:\r\nif (mtp3_standard == ANSI_STANDARD) {\r\ndissect_mtp3_3byte_pc(tvb, 0, tree, ett_mtp3mg_tfm_apc,\r\nhf_mtp3mg_ansi_apc,\r\nhf_mtp3mg_apc_network,\r\nhf_mtp3mg_apc_cluster,\r\nhf_mtp3mg_apc_member, 0, 0);\r\n} else if (mtp3_standard == JAPAN_STANDARD) {\r\nguint8 count, i;\r\nguint32 offset;\r\nif (h1 == TFM_H1_TCP || h1 == TFM_H1_TCR || h1 == TFM_H1_TCA\r\n|| h1 == TFM_H1_TFR)\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\nproto_tree_add_item(tree, hf_mtp3mg_tfm_japan_count, tvb,\r\nJAPAN_TFM_COUNT_OFFSET,\r\nJAPAN_TFM_COUNT_LENGTH, ENC_LITTLE_ENDIAN);\r\ncount = tvb_get_guint8(tvb, JAPAN_TFM_COUNT_OFFSET);\r\noffset = JAPAN_TFM_COUNT_LENGTH;\r\nfor (i = 0; i < count; i++)\r\n{\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_japan_apc, tvb,\r\noffset, JAPAN_PC_LENGTH, ENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, offset);\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\noffset += JAPAN_PC_LENGTH;\r\nproto_tree_add_item(tree, hf_mtp3mg_tfm_japan_spare, tvb,\r\noffset, JAPAN_PC_LENGTH, ENC_LITTLE_ENDIAN);\r\noffset += JAPAN_PC_LENGTH;\r\n}\r\n} else {\r\nif (h1 == TFM_H1_TCP || h1 == TFM_H1_TCR || h1 == TFM_H1_TCA)\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\nelse if (mtp3_standard == ITU_STANDARD)\r\n{\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_itu_apc,\r\ntvb, 0, ITU_PC_LENGTH, ENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, 0) & ITU_PC_MASK;\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\n}\r\nelse if (mtp3_standard == CHINESE_ITU_STANDARD)\r\ndissect_mtp3_3byte_pc(tvb, 0, tree, ett_mtp3mg_tfm_apc,\r\nhf_mtp3mg_chinese_apc,\r\nhf_mtp3mg_apc_network,\r\nhf_mtp3mg_apc_cluster,\r\nhf_mtp3mg_apc_member, 0, 0);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_rsm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\nproto_item *apc_item;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, rsm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase RSM_H1_RST:\r\ncase RSM_H1_RSR:\r\ncase RSM_H1_RCP:\r\ncase RSM_H1_RCR:\r\nif (mtp3_standard == ANSI_STANDARD) {\r\ndissect_mtp3_3byte_pc(tvb, 0, tree, ett_mtp3mg_rsm_apc,\r\nhf_mtp3mg_ansi_apc,\r\nhf_mtp3mg_apc_network,\r\nhf_mtp3mg_apc_cluster,\r\nhf_mtp3mg_apc_member, 0, 0);\r\n} else if (mtp3_standard == JAPAN_STANDARD) {\r\nif (h1 == RSM_H1_RST) {\r\nguint32 offset;\r\nguint8 count, i;\r\nproto_tree_add_item(tree, hf_mtp3mg_rsm_japan_count, tvb,\r\nJAPAN_TFM_COUNT_OFFSET,\r\nJAPAN_TFM_COUNT_LENGTH, ENC_LITTLE_ENDIAN);\r\ncount = tvb_get_guint8(tvb, JAPAN_TFM_COUNT_OFFSET);\r\noffset = JAPAN_TFM_COUNT_LENGTH;\r\nfor (i = 0; i < count; i++) {\r\napc_item = proto_tree_add_item(tree,\r\nhf_mtp3mg_japan_apc,\r\ntvb, offset,\r\nJAPAN_PC_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, 0);\r\nproto_item_append_text(apc_item, " (%s)",\r\nmtp3_pc_to_str(apc));\r\n}\r\noffset += JAPAN_PC_LENGTH;\r\nproto_tree_add_item(tree, hf_mtp3mg_rsm_japan_spare, tvb,\r\noffset, JAPAN_PC_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\noffset += JAPAN_PC_LENGTH;\r\n}\r\n} else\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n} else {\r\nif (h1 == RSM_H1_RST || h1 == RSM_H1_RSR) {\r\nif (mtp3_standard == ITU_STANDARD) {\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_itu_apc,\r\ntvb, 0, ITU_PC_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, 0) & ITU_PC_MASK;\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\n}\r\nelse\r\ndissect_mtp3_3byte_pc(tvb, 0, tree, ett_mtp3mg_rsm_apc,\r\nhf_mtp3mg_chinese_apc,\r\nhf_mtp3mg_apc_network,\r\nhf_mtp3mg_apc_cluster,\r\nhf_mtp3mg_apc_member, 0, 0);\r\n} else\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_mim(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, mim_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase MIM_H1_LIN:\r\ncase MIM_H1_LUN:\r\ncase MIM_H1_LIA:\r\ncase MIM_H1_LUA:\r\ncase MIM_H1_LID:\r\ncase MIM_H1_LFU:\r\ncase MIM_H1_LLT:\r\ncase MIM_H1_LRT:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_mim_ansi_slc, tvb, 0,\r\nANSI_MIM_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_trm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, trm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase TRM_H1_TRA:\r\nbreak;\r\ncase TRM_H1_TRW:\r\nif (mtp3_standard != ANSI_STANDARD)\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_dlm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, dlm_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase DLM_H1_DLC:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_dlc_ansi_slc, tvb, 0,\r\nANSI_DLC_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_dlc_ansi_link, tvb, 0,\r\nANSI_DLC_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else {\r\nproto_tree_add_item(tree, hf_mtp3mg_dlc_itu_link, tvb, 0,\r\nITU_DLC_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase DLM_H1_CSS:\r\ncase DLM_H1_CNS:\r\ncase DLM_H1_CNP:\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_ufc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\nproto_item *apc_item;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, ufc_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase UFC_H1_UPU:\r\nif (mtp3_standard == ANSI_STANDARD\r\n|| mtp3_standard == CHINESE_ITU_STANDARD) {\r\nint hf_apc;\r\nif (mtp3_standard == ANSI_STANDARD)\r\nhf_apc = hf_mtp3mg_ansi_apc;\r\nelse\r\nhf_apc = hf_mtp3mg_chinese_apc;\r\ndissect_mtp3_3byte_pc(tvb, 0, tree, ett_mtp3mg_upu_apc, hf_apc,\r\nhf_mtp3mg_apc_network,\r\nhf_mtp3mg_apc_cluster,\r\nhf_mtp3mg_apc_member, 0, 0);\r\nproto_tree_add_item(tree, hf_mtp3mg_upu_user, tvb,\r\nANSI_UPU_USER_OFFSET, UPU_USER_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_upu_cause, tvb,\r\nANSI_UPU_USER_OFFSET, UPU_USER_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else if (mtp3_standard == ITU_STANDARD) {\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_itu_apc, tvb, 0,\r\nITU_PC_LENGTH, ENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, 0) & ITU_PC_MASK;\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\nproto_tree_add_item(tree, hf_mtp3mg_upu_user, tvb,\r\nITU_UPU_USER_OFFSET, UPU_USER_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_upu_cause, tvb,\r\nITU_UPU_USER_OFFSET, UPU_USER_LENGTH, ENC_LITTLE_ENDIAN);\r\n} else {\r\napc_item = proto_tree_add_item(tree, hf_mtp3mg_japan_apc, tvb,\r\n0, JAPAN_PC_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\nif (mtp3_pc_structured()) {\r\nguint32 apc;\r\napc = tvb_get_letohs(tvb, 0);\r\nproto_item_append_text(apc_item, " (%s)", mtp3_pc_to_str(apc));\r\n}\r\nproto_tree_add_item(tree, hf_mtp3mg_upu_user, tvb,\r\nITU_UPU_USER_OFFSET, UPU_USER_LENGTH, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_mtp3mg_upu_cause, tvb,\r\nITU_UPU_USER_OFFSET, UPU_USER_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_mtp3mg_test(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 h1)\r\n{\r\nguint8 length;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h1, test_h1_message_type_acro_values, "Unknown"));\r\nswitch (h1)\r\n{\r\ncase TEST_H1_SLTM:\r\ncase TEST_H1_SLTA:\r\nif (mtp3_standard == ANSI_STANDARD)\r\n{\r\nproto_tree_add_item(tree, hf_mtp3mg_test_ansi_slc, tvb, 0,\r\nTEST_LENGTH, ENC_LITTLE_ENDIAN);\r\n}\r\nproto_tree_add_item(tree, hf_mtp3mg_test_length, tvb, 0, TEST_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\nlength = tvb_get_guint8(tvb, 0) >> TEST_LENGTH_SHIFT;\r\nproto_tree_add_item(tree, hf_mtp3mg_test_pattern, tvb, TEST_PATTERN_OFFSET, length, ENC_NA);\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, tree);\r\n}\r\n}\r\nstatic int\r\ndissect_mtp3mg(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 h0, h1;\r\ntvbuff_t *payload_tvb;\r\nproto_item *mtp3mg_item;\r\nproto_tree *mtp3mg_tree;\r\nswitch(mtp3_standard) {\r\ncase ITU_STANDARD:\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MTP3MG (Int. ITU)");\r\nbreak;\r\ncase ANSI_STANDARD:\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MTP3MG (ANSI)");\r\nbreak;\r\ncase CHINESE_ITU_STANDARD:\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MTP3MG (Chin. ITU)");\r\nbreak;\r\ncase JAPAN_STANDARD:\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MTP3MG (Japan)");\r\nbreak;\r\n};\r\nmtp3mg_item = proto_tree_add_item(tree, proto_mtp3mg, tvb, 0, -1, ENC_NA);\r\nmtp3mg_tree = proto_item_add_subtree(mtp3mg_item, ett_mtp3mg);\r\nif(pinfo->match_uint == MTP_SI_MTN ||\r\npinfo->match_uint == MTP_SI_MTNS)\r\n{\r\nif (mtp3_standard == JAPAN_STANDARD)\r\n{\r\nguint8 h0h1;\r\nguint16 test_pattern;\r\nproto_item *pattern_item;\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_japan_spare, tvb, 0,\r\nJAPAN_SPARE_LENGTH, ENC_LITTLE_ENDIAN);\r\nh0h1 = tvb_get_guint8(tvb, JAPAN_H0H1_OFFSET);\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_japan_test, tvb,\r\nJAPAN_SPARE_LENGTH, H0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ",\r\nval_to_str_const(h0h1, japan_test_message_type_acro_values, "Unknown"));\r\nswitch (h0h1)\r\n{\r\ncase JAPAN_TEST_SRT:\r\ncase JAPAN_TEST_SRA:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_japan_test_spare,\r\ntvb, JAPAN_TEST_SPARE_OFFSET,\r\nJAPAN_TEST_SPARE_LENGTH, ENC_LITTLE_ENDIAN);\r\ntest_pattern = tvb_get_letohs(tvb, JAPAN_TEST_PATTERN_OFFSET);\r\npattern_item = proto_tree_add_item(mtp3mg_tree,\r\nhf_mtp3mg_japan_test_pattern,\r\ntvb,\r\nJAPAN_TEST_PATTERN_OFFSET,\r\nJAPAN_TEST_PATTERN_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\nproto_item_append_text(pattern_item, " (%s)",\r\ntest_pattern == JAPAN_TEST_PATTERN\r\n? "correct" : "incorrect");\r\nbreak;\r\ndefault:\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\n}\r\n} else {\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3test_h0, tvb, 0, H0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\nh0 = tvb_get_guint8(tvb, 0) & H0_MASK;\r\nh1 = (tvb_get_guint8(tvb, 0) & H1_MASK) >> H1_SHIFT;\r\npayload_tvb = tvb_new_subset_remaining(tvb, H0H1_LENGTH);\r\nswitch (h0)\r\n{\r\ncase TEST_H0_SLT:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_test_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_test(payload_tvb, pinfo, mtp3mg_tree, h1);\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Unknown ");\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\n}\r\n}\r\n} else {\r\nif (mtp3_standard == JAPAN_STANDARD)\r\n{\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_japan_spare, tvb, 0,\r\nJAPAN_SPARE_LENGTH, ENC_LITTLE_ENDIAN);\r\ntvb = tvb_new_subset_remaining(tvb, JAPAN_SPARE_LENGTH);\r\n}\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_h0, tvb, 0, H0H1_LENGTH,\r\nENC_LITTLE_ENDIAN);\r\nh0 = tvb_get_guint8(tvb, 0) & H0_MASK;\r\nh1 = (tvb_get_guint8(tvb, 0) & H1_MASK) >> H1_SHIFT;\r\npayload_tvb = tvb_new_subset_remaining(tvb, H0H1_LENGTH);\r\nswitch (h0)\r\n{\r\ncase H0_CHM:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_chm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_chm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\nbreak;\r\ncase H0_ECM:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_ecm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_ecm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\nbreak;\r\ncase H0_FCM:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_fcm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_fcm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\nbreak;\r\ncase H0_TFM:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_tfm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_tfm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\nbreak;\r\ncase H0_RSM:\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_rsm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_rsm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\nbreak;\r\ncase H0_MIM:\r\nif (mtp3_standard != JAPAN_STANDARD)\r\n{\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_mim_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_mim(payload_tvb, pinfo, mtp3mg_tree, h1);\r\n} else\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\nbreak;\r\ncase H0_TRM:\r\nif (mtp3_standard != JAPAN_STANDARD)\r\n{\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_trm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_trm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\n} else\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\nbreak;\r\ncase H0_DLM:\r\nif (mtp3_standard != JAPAN_STANDARD)\r\n{\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_dlm_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_dlm(payload_tvb, pinfo, mtp3mg_tree, h1);\r\n} else\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\nbreak;\r\ncase H0_UFC:\r\nif (mtp3_standard != JAPAN_STANDARD)\r\n{\r\nproto_tree_add_item(mtp3mg_tree, hf_mtp3mg_ufc_h1, tvb, 0,\r\nH0H1_LENGTH, ENC_LITTLE_ENDIAN);\r\ndissect_mtp3mg_ufc(payload_tvb, pinfo, mtp3mg_tree, h1);\r\n} else\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Unknown ");\r\ndissect_mtp3mg_unknown_message(tvb, pinfo, mtp3mg_tree);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_mtp3mg(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_mtp3mg_h0,\r\n{ "H0 (Message Group)", "mtp3mg.h0",\r\nFT_UINT8, BASE_HEX, VALS(h0_message_type_values), H0_MASK,\r\n"Message group identifier", HFILL }},\r\n{ &hf_mtp3mg_chm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(chm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_ecm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(ecm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_fcm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(fcm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_tfm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(tfm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_rsm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(rsm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_mim_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(mim_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_trm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(trm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_dlm_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(dlm_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_ufc_h1,\r\n{ "H1 (Message)", "mtp3mg.h1",\r\nFT_UINT8, BASE_HEX, VALS(ufc_h1_message_type_values), H1_MASK,\r\n"Message type", HFILL }},\r\n{ &hf_mtp3mg_coo_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_COO_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_coo_ansi_fsn,\r\n{ "Forward Sequence Number", "mtp3mg.fsn",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_COO_FSN_MASK,\r\n"Forward Sequence Number of last accepted message", HFILL }},\r\n{ &hf_mtp3mg_coo_itu_fsn,\r\n{ "Forward Sequence Number", "mtp3mg.fsn",\r\nFT_UINT8, BASE_DEC, NULL, ITU_COO_FSN_MASK,\r\n"Forward Sequence Number of last accepted message", HFILL }},\r\n{ &hf_mtp3mg_xco_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT32, BASE_DEC, NULL, ANSI_XCO_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_xco_ansi_fsn,\r\n{ "Forward Sequence Number", "mtp3mg.fsn",\r\nFT_UINT32, BASE_DEC, NULL, ANSI_XCO_FSN_MASK,\r\n"Forward Sequence Number of last accepted message", HFILL }},\r\n{ &hf_mtp3mg_xco_itu_fsn,\r\n{ "Forward Sequence Number", "mtp3mg.fsn",\r\nFT_UINT24, BASE_DEC, NULL, 0x0,\r\n"Forward Sequence Number of last accepted message", HFILL }},\r\n{ &hf_mtp3mg_cbd_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT16, BASE_DEC, NULL, ANSI_CBD_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_cbd_ansi_cbc,\r\n{ "Change Back Code", "mtp3mg.cbc",\r\nFT_UINT16, BASE_DEC, NULL, ANSI_CBD_CBC_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_cbd_itu_cbc,\r\n{ "Change Back Code", "mtp3mg.cbc",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_cbd_japan_cbc,\r\n{ "Change Back Code", "mtp3mg.cbc",\r\nFT_UINT8, BASE_DEC, NULL, JAPAN_CBD_CBC_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_eco_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_ECO_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_ansi_apc,\r\n{ "Affected Point Code", "mtp3mg.ansi_apc",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_apc_member,\r\n{ "Affected Point Code member", "mtp3mg.apc.member",\r\nFT_UINT24, BASE_DEC, NULL, ANSI_MEMBER_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_apc_cluster,\r\n{ "Affected Point Code cluster", "mtp3mg.apc.cluster",\r\nFT_UINT24, BASE_DEC, NULL, ANSI_CLUSTER_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_apc_network,\r\n{ "Affected Point Code network", "mtp3mg.apc.network",\r\nFT_UINT24, BASE_DEC, NULL, ANSI_NETWORK_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfc_ansi_status,\r\n{ "Status", "mtp3mg.status",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_TFC_STATUS_MASK,\r\n"Congestion status", HFILL }},\r\n{ &hf_mtp3mg_itu_apc,\r\n{ "Affected Point Code (ITU)", "mtp3mg.apc",\r\nFT_UINT16, BASE_DEC, NULL, ITU_PC_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfc_itu_status,\r\n{ "Status", "mtp3mg.status",\r\nFT_UINT8, BASE_DEC, NULL, ITU_TFC_STATUS_MASK,\r\n"Congestion status", HFILL }},\r\n{ &hf_mtp3mg_chinese_apc,\r\n{ "Affected Point Code", "mtp3mg.chinese_apc",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfc_japan_spare,\r\n{ "TFC spare (Japan)", "mtp3mg.japan_spare",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_japan_apc,\r\n{ "Affected Point Code", "mtp3mg.japan_apc",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfc_japan_status,\r\n{ "Status", "mtp3mg.japan_status",\r\nFT_UINT8, BASE_DEC, NULL, JAPAN_TFC_STATUS_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfc_japan_status_spare,\r\n{ "Spare (Japan)", "mtp3mg.japan_spare",\r\nFT_UINT8, BASE_HEX, NULL, JAPAN_TFC_STATUS_SPARE_MASK,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfm_japan_count,\r\n{ "Count of Affected Point Codes (Japan)", "mtp3mg.japan_count",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_tfm_japan_spare,\r\n{ "Spare (Japan)", "mtp3mg.japan_spare",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_rsm_japan_count,\r\n{ "Count of Affected Point Codes (Japan)", "mtp3mg.japan_count",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_rsm_japan_spare,\r\n{ "Spare (Japan)", "mtp3mg.japan_spare",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_mim_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_MIM_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_dlc_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_DLC_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_dlc_ansi_link,\r\n{ "Link", "mtp3mg.link",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_DLC_LINK_MASK,\r\n"CIC of BIC used to carry data", HFILL }},\r\n{ &hf_mtp3mg_dlc_itu_link,\r\n{ "Link", "mtp3mg.link",\r\nFT_UINT8, BASE_DEC, NULL, ITU_DLC_LINK_MASK,\r\n"CIC of BIC used to carry data", HFILL }},\r\n{ &hf_mtp3mg_upu_user,\r\n{ "User", "mtp3mg.user",\r\nFT_UINT8, BASE_HEX, VALS(service_indicator_code_vals), UPU_USER_MASK,\r\n"Unavailable user part", HFILL }},\r\n{ &hf_mtp3mg_upu_cause,\r\n{ "Cause", "mtp3mg.cause",\r\nFT_UINT8, BASE_HEX, VALS(upu_cause_values), UPU_CAUSE_MASK,\r\n"Cause of user unavailability", HFILL }},\r\n{ &hf_mtp3test_h0,\r\n{ "H0 (Message Group)", "mtp3mg.test.h0",\r\nFT_UINT8, BASE_HEX, VALS(test_h0_message_type_values), H0_MASK,\r\n"Message group identifier", HFILL }},\r\n{ &hf_mtp3mg_test_h1,\r\n{ "H1 (Message)", "mtp3mg.test.h1",\r\nFT_UINT8, BASE_HEX, VALS(test_h1_message_type_values), H1_MASK,\r\n"SLT message type", HFILL }},\r\n{ &hf_mtp3mg_test_length,\r\n{ "Test length", "mtp3mg.test.length",\r\nFT_UINT8, BASE_DEC, NULL, H1_MASK,\r\n"Signalling link test pattern length", HFILL }},\r\n{ &hf_mtp3mg_japan_test,\r\n{ "Japan test message", "mtp3mg.test",\r\nFT_UINT8, BASE_HEX, VALS(japan_test_message_type_values), 0x0,\r\n"Japan test message type", HFILL }},\r\n{ &hf_mtp3mg_japan_test_spare,\r\n{ "Japan test message spare", "mtp3mg.test.spare",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_japan_test_pattern,\r\n{ "Japan test message pattern", "mtp3mg.test.pattern",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_japan_spare,\r\n{ "Japan management spare", "mtp3mg.spare",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_mtp3mg_test_ansi_slc,\r\n{ "Signalling Link Code", "mtp3mg.slc",\r\nFT_UINT8, BASE_DEC, NULL, ANSI_TEST_SLC_MASK,\r\n"SLC of affected link", HFILL }},\r\n{ &hf_mtp3mg_test_pattern,\r\n{ "Test pattern", "mtp3mg.test_pattern",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mtp3mg,\r\n&ett_mtp3mg_fcm_apc,\r\n&ett_mtp3mg_tfm_apc,\r\n&ett_mtp3mg_rsm_apc,\r\n&ett_mtp3mg_upu_apc\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_mtp3mg_unknown_message, { "mtp3mg.unknown_message", PI_PROTOCOL, PI_WARN, "Unknown message", EXPFILL }},\r\n};\r\nexpert_module_t* expert_mtp3mg;\r\nproto_mtp3mg = proto_register_protocol("Message Transfer Part Level 3 Management",\r\n"MTP3MG", "mtp3mg");\r\nregister_dissector("mtp3mg", dissect_mtp3mg, proto_mtp3mg);\r\nproto_register_field_array(proto_mtp3mg, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_mtp3mg = expert_register_protocol(proto_mtp3mg);\r\nexpert_register_field_array(expert_mtp3mg, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_mtp3mg(void)\r\n{\r\ndissector_handle_t mtp3mg_handle;\r\nmtp3mg_handle = find_dissector("mtp3mg");\r\ndissector_add_uint("mtp3.service_indicator", MTP_SI_SNM, mtp3mg_handle);\r\ndissector_add_uint("mtp3.service_indicator", MTP_SI_MTN, mtp3mg_handle);\r\ndissector_add_uint("mtp3.service_indicator", MTP_SI_MTNS, mtp3mg_handle);\r\n}

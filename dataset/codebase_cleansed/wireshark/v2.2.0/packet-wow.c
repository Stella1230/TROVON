static guint\r\nget_wow_pdu_len(packet_info *pinfo, tvbuff_t *tvb, int offset, void *data _U_)\r\n{\r\ngint8 size_field_offset = -1;\r\nguint8 cmd;\r\nguint16 pkt_len;\r\ncmd = tvb_get_guint8(tvb, offset);\r\nif(WOW_SERVER_TO_CLIENT && cmd == REALM_LIST)\r\nsize_field_offset = 1;\r\nif(WOW_CLIENT_TO_SERVER && cmd == AUTH_LOGON_CHALLENGE)\r\nsize_field_offset = 2;\r\npkt_len = tvb_get_letohs(tvb, size_field_offset);\r\nreturn pkt_len + size_field_offset + 2;\r\n}\r\nstatic int\r\ndissect_wow_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *wow_tree, *wow_realms_tree;\r\ngchar *string, *realm_name;\r\nguint8 cmd, srp_i_len, srp_g_len, srp_n_len;\r\nguint16 num_realms;\r\nguint32 offset = 0;\r\ngint len, ii;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WOW");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncmd = tvb_get_guint8(tvb, offset);\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_const(cmd, cmd_vs,\r\n"Unrecognized packet type"));\r\nif(tree) {\r\nti = proto_tree_add_item(tree, proto_wow, tvb, 0, -1, ENC_NA);\r\nwow_tree = proto_item_add_subtree(ti, ett_wow);\r\nproto_tree_add_item(wow_tree, hf_wow_command, tvb, offset, 1,\r\nENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nswitch(cmd) {\r\ncase AUTH_LOGON_CHALLENGE :\r\nif(WOW_CLIENT_TO_SERVER) {\r\nproto_tree_add_item(wow_tree, hf_wow_error, tvb,\r\noffset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_pkt_size,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nstring = g_strreverse(tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 4, ENC_ASCII));\r\nproto_tree_add_string(wow_tree, hf_wow_gamename,\r\ntvb, offset, 4, string);\r\noffset += 4;\r\nproto_tree_add_item(wow_tree, hf_wow_version1,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_version2,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_version3,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_build, tvb,\r\noffset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nstring = g_strreverse(tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 4, ENC_ASCII));\r\nproto_tree_add_string(wow_tree, hf_wow_platform,\r\ntvb, offset, 4, string);\r\noffset += 4;\r\nstring = g_strreverse(tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 4, ENC_ASCII));\r\nproto_tree_add_string(wow_tree, hf_wow_os, tvb,\r\noffset, 4, string);\r\noffset += 4;\r\nstring = g_strreverse(tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 4, ENC_ASCII));\r\nproto_tree_add_string(wow_tree, hf_wow_country,\r\ntvb, offset, 4, string);\r\noffset += 4;\r\nproto_tree_add_item(wow_tree,\r\nhf_wow_timezone_bias,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(wow_tree, hf_wow_ip, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(wow_tree,\r\nhf_wow_srp_i_len,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nsrp_i_len = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree,\r\nhf_wow_srp_i, tvb,\r\noffset, srp_i_len,\r\nENC_ASCII|ENC_NA);\r\n} else if(WOW_SERVER_TO_CLIENT) {\r\nproto_tree_add_item(wow_tree, hf_wow_error, tvb,\r\noffset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_b, tvb,\r\noffset, 32, ENC_NA);\r\noffset += 32;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_g_len,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nsrp_g_len = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_g, tvb,\r\noffset, srp_g_len, ENC_NA);\r\noffset += srp_g_len;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_n_len,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nsrp_n_len = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_n, tvb,\r\noffset, srp_n_len, ENC_NA);\r\noffset += srp_n_len;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_s, tvb,\r\noffset, 32, ENC_NA);\r\n}\r\nbreak;\r\ncase AUTH_LOGON_PROOF :\r\nif(WOW_CLIENT_TO_SERVER) {\r\nproto_tree_add_item(wow_tree, hf_wow_srp_a, tvb,\r\noffset, 32, ENC_NA);\r\noffset += 32;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_m1,\r\ntvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nproto_tree_add_item(wow_tree, hf_wow_crc_hash,\r\ntvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nproto_tree_add_item(wow_tree, hf_wow_num_keys,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n} else if(WOW_SERVER_TO_CLIENT) {\r\nproto_tree_add_item(wow_tree, hf_wow_error, tvb,\r\noffset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_tree, hf_wow_srp_m2,\r\ntvb, offset, 20, ENC_NA);\r\n}\r\nbreak;\r\ncase REALM_LIST :\r\nif(WOW_CLIENT_TO_SERVER) {\r\n} else if(WOW_SERVER_TO_CLIENT) {\r\nproto_tree_add_item(wow_tree, hf_wow_pkt_size,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\noffset += 4;\r\nproto_tree_add_item(wow_tree, hf_wow_num_realms,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nnum_realms = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\nfor(ii = 0; ii < num_realms; ii++) {\r\nrealm_name = tvb_get_stringz_enc(wmem_packet_scope(), tvb,\r\noffset + 3,\r\n&len, ENC_ASCII);\r\nwow_realms_tree = proto_tree_add_subtree(wow_tree, tvb,\r\noffset, 0,\r\nett_wow_realms, NULL,\r\nrealm_name);\r\nproto_tree_add_item(wow_realms_tree, hf_wow_realm_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_realms_tree, hf_wow_realm_status, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_realms_tree, hf_wow_realm_color, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_string(wow_realms_tree, hf_wow_realm_name, tvb, offset, len, realm_name);\r\noffset += len;\r\nstring = tvb_get_stringz_enc(wmem_packet_scope(), tvb, offset,\r\n&len, ENC_ASCII);\r\nproto_tree_add_string(wow_realms_tree, hf_wow_realm_socket, tvb, offset, len, string);\r\noffset += len;\r\nproto_tree_add_item(wow_realms_tree, hf_wow_realm_population_level, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(wow_realms_tree, hf_wow_realm_num_characters, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wow_realms_tree, hf_wow_realm_timezone, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_wow(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\ngint8 size_field_offset = -1;\r\nguint8 cmd;\r\ncmd = tvb_get_guint8(tvb, 0);\r\nif(WOW_SERVER_TO_CLIENT && cmd == REALM_LIST)\r\nsize_field_offset = 1;\r\nif(WOW_CLIENT_TO_SERVER && cmd == AUTH_LOGON_CHALLENGE)\r\nsize_field_offset = 2;\r\nif(size_field_offset > -1) {\r\ntcp_dissect_pdus(tvb, pinfo, tree, wow_preference_desegment,\r\nsize_field_offset+2, get_wow_pdu_len,\r\ndissect_wow_pdu, data);\r\n} else {\r\ndissect_wow_pdu(tvb, pinfo, tree, data);\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_wow(void)\r\n{\r\nmodule_t *wow_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_wow_command,\r\n{ "Command", "wow.cmd",\r\nFT_UINT8, BASE_HEX, VALS(cmd_vs), 0,\r\n"Type of packet", HFILL }\r\n},\r\n{ &hf_wow_error,\r\n{ "Error", "wow.error",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_pkt_size,\r\n{ "Packet size", "wow.pkt_size",\r\nFT_UINT16, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_gamename,\r\n{ "Game name", "wow.gamename",\r\nFT_STRING, BASE_NONE, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_version1,\r\n{ "Version 1", "wow.version1",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_version2,\r\n{ "Version 2", "wow.version2",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_version3,\r\n{ "Version 3", "wow.version3",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_build,\r\n{ "Build", "wow.build",\r\nFT_UINT16, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_platform,\r\n{ "Platform", "wow.platform",\r\nFT_STRING, BASE_NONE, 0, 0,\r\n"CPU architecture of client system", HFILL }\r\n},\r\n{ &hf_wow_os,\r\n{ "Operating system", "wow.os",\r\nFT_STRING, BASE_NONE, 0, 0,\r\n"Operating system of client system", HFILL }\r\n},\r\n{ &hf_wow_country,\r\n{ "Country", "wow.country",\r\nFT_STRING, BASE_NONE, 0, 0,\r\n"Language and country of client system", HFILL }\r\n},\r\n{ &hf_wow_timezone_bias,\r\n{ "Timezone bias", "wow.timezone_bias",\r\nFT_UINT32, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_ip,\r\n{ "IP address", "wow.ip",\r\nFT_IPv4, BASE_NONE, 0, 0,\r\n"Client's actual IP address", HFILL }\r\n},\r\n{ &hf_wow_srp_i_len,\r\n{ "SRP I length", "wow.srp.i_len",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\n"Secure Remote Password protocol 'I' value length", HFILL }\r\n},\r\n{ &hf_wow_srp_i,\r\n{ "SRP I", "wow.srp.i",\r\nFT_STRING, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'I' value (username)", HFILL }\r\n},\r\n{ &hf_wow_srp_b,\r\n{ "SRP B", "wow.srp.b",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'B' value (one of the public ephemeral values)", HFILL }\r\n},\r\n{ &hf_wow_srp_g_len,\r\n{ "SRP g length", "wow.srp.g_len",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\n"Secure Remote Password protocol 'g' value length",\r\nHFILL }\r\n},\r\n{ &hf_wow_srp_g,\r\n{ "SRP g", "wow.srp.g",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'g' value", HFILL }\r\n},\r\n{ &hf_wow_srp_n_len,\r\n{ "SRP N length", "wow.srp.n_len",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\n"Secure Remote Password protocol 'N' value length",\r\nHFILL }\r\n},\r\n{ &hf_wow_srp_n,\r\n{ "SRP N", "wow.srp.n",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'N' value (a large safe prime)", HFILL }\r\n},\r\n{ &hf_wow_srp_s,\r\n{ "SRP s", "wow.srp.s",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 's' (user's salt) value",\r\nHFILL }\r\n},\r\n{ &hf_wow_srp_a,\r\n{ "SRP A", "wow.srp.a",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'A' value (one of the public ephemeral values)", HFILL }\r\n},\r\n{ &hf_wow_srp_m1,\r\n{ "SRP M1", "wow.srp.m1",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'M1' value", HFILL }\r\n},\r\n{ &hf_wow_crc_hash,\r\n{ "CRC hash", "wow.crc_hash",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_num_keys,\r\n{ "Number of keys", "wow.num_keys",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_srp_m2,\r\n{ "SRP M2", "wow.srp.m2",\r\nFT_BYTES, BASE_NONE, 0, 0,\r\n"Secure Remote Password protocol 'M2' value", HFILL }\r\n},\r\n{ &hf_wow_num_realms,\r\n{ "Number of realms", "wow.num_realms",\r\nFT_UINT16, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_realm_type,\r\n{ "Type", "wow.realm_type",\r\nFT_UINT8, BASE_DEC, VALS(realm_type_vs), 0,\r\n"Also known as realm icon", HFILL }\r\n},\r\n{ &hf_wow_realm_status,\r\n{ "Status", "wow.realm_status",\r\nFT_UINT8, BASE_DEC, VALS(realm_status_vs), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_realm_color,\r\n{ "Color", "wow.realm_color",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_realm_name,\r\n{ "Name", "wow.realm_name",\r\nFT_STRINGZ, BASE_NONE, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_realm_socket,\r\n{ "Server socket", "wow.realm_socket",\r\nFT_STRINGZ, BASE_NONE, 0, 0,\r\n"IP address and port to connect to on the server to reach this realm", HFILL }\r\n},\r\n{ &hf_wow_realm_population_level,\r\n{ "Population level", "wow.realm_population_level",\r\nFT_FLOAT, BASE_NONE, 0, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_wow_realm_num_characters,\r\n{ "Number of characters", "wow.realm_num_characters",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\n"Number of characters the user has in this realm", HFILL }\r\n},\r\n{ &hf_wow_realm_timezone,\r\n{ "Timezone", "wow.realm_timezone",\r\nFT_UINT8, BASE_DEC, 0, 0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_wow,\r\n&ett_wow_realms\r\n};\r\nproto_wow = proto_register_protocol("World of Warcraft",\r\n"WOW", "wow");\r\nproto_register_field_array(proto_wow, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nwow_module = prefs_register_protocol(proto_wow, NULL);\r\nprefs_register_bool_preference(wow_module, "desegment", "Reassemble wow messages spanning multiple TCP segments.", "Whether the wow dissector should reassemble messages spanning multiple TCP segments. To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.", &wow_preference_desegment);\r\n}\r\nvoid\r\nproto_reg_handoff_wow(void)\r\n{\r\ndissector_handle_t wow_handle;\r\nwow_handle = create_dissector_handle(dissect_wow, proto_wow);\r\ndissector_add_uint("tcp.port", WOW_PORT, wow_handle);\r\n}

static int\r\ndissect_rmp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *rmp_tree = NULL;\r\nproto_item *ti = NULL;\r\nguint8 type, len;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "RMP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntype = tvb_get_guint8(tvb, 0);\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_const(type, rmp_type_vals, "Unknown Type"));\r\nti = proto_tree_add_item(tree, proto_rmp, tvb, 0, -1, ENC_NA);\r\nrmp_tree = proto_item_add_subtree(ti, ett_rmp);\r\nproto_tree_add_uint(rmp_tree, hf_rmp_type, tvb, 0, 1, type);\r\nswitch (type) {\r\ncase RMP_BOOT_REQ:\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_retcode, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_seqnum, tvb, 2, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_sessionid, tvb, 6, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_version, tvb, 8, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_machtype, tvb, 10, 20, ENC_ASCII|ENC_NA);\r\nif(!tvb_offset_exists(tvb, 30))\r\nreturn 30;\r\nlen = tvb_get_guint8(tvb, 30);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_filename, tvb, 30, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\nif(tvb_offset_exists(tvb, len+31))\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, len+31),\r\npinfo, tree);\r\nbreak;\r\ncase RMP_BOOT_REPL:\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_retcode, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_seqnum, tvb, 2, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_sessionid, tvb, 6, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_version, tvb, 8, 2, ENC_BIG_ENDIAN);\r\nlen = tvb_get_guint8(tvb, 10);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_filename, tvb, 10, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\nif(tvb_offset_exists(tvb, len+11))\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, len+11),\r\npinfo, tree);\r\nbreak;\r\ncase RMP_READ_REQ:\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_retcode, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_offset, tvb, 2, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_sessionid, tvb, 6, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_size, tvb, 8, 2, ENC_BIG_ENDIAN);\r\nif(tvb_offset_exists(tvb, 10))\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, 10),\r\npinfo, tree);\r\nbreak;\r\ncase RMP_READ_REPL:\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_retcode, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_offset, tvb, 2, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_sessionid, tvb, 6, 2, ENC_BIG_ENDIAN);\r\ncall_data_dissector(tvb_new_subset_remaining(tvb,\r\n8), pinfo, rmp_tree);\r\nbreak;\r\ncase RMP_BOOT_DONE:\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_retcode, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_reserved, tvb, 2, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rmp_tree,\r\nhf_rmp_sessionid, tvb, 6, 2, ENC_BIG_ENDIAN);\r\nif(tvb_offset_exists(tvb, 8))\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, 6),\r\npinfo, tree);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, 1), pinfo, tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_rmp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_rmp_type,\r\n{ "Type", "rmp.type", FT_UINT8, BASE_HEX,\r\nVALS(rmp_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_rmp_retcode,\r\n{ "Returncode", "rmp.retcode", FT_UINT8, BASE_HEX,\r\nVALS(rmp_error_vals), 0x0, NULL, HFILL }},\r\n{ &hf_rmp_seqnum,\r\n{ "Sequence Number", "rmp.seqnum", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_sessionid,\r\n{ "Session ID", "rmp.sessionid", FT_UINT16, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_version,\r\n{ "Version", "rmp.version", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_machtype,\r\n{ "Machine Type", "rmp.machtype", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_filename,\r\n{ "Filename", "rmp.filename", FT_UINT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_offset,\r\n{ "Offset", "rmp.offset", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_size,\r\n{ "Size", "rmp.size", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_rmp_reserved,\r\n{ "Reserved", "rmp.reserved", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_rmp,\r\n};\r\nproto_rmp = proto_register_protocol(\r\n"HP Remote Maintenance Protocol", "RMP", "rmp");\r\nproto_register_field_array(proto_rmp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("rmp", dissect_rmp, proto_rmp);\r\n}\r\nvoid\r\nproto_reg_handoff_rmp(void)\r\n{\r\ndissector_handle_t rmp_handle;\r\nrmp_handle = find_dissector("rmp");\r\ndissector_add_uint("hpext.dxsap", HPEXT_DXSAP, rmp_handle);\r\ndissector_add_uint("hpext.dxsap", HPEXT_SXSAP, rmp_handle);\r\n}

static void\r\nmodify_time_perform(frame_data *fd, int neg, nstime_t *offset, int settozero)\r\n{\r\nif (settozero == SHIFT_SETTOZERO) {\r\nnstime_subtract(&(fd->abs_ts), &(fd->shift_offset));\r\nnstime_set_zero(&(fd->shift_offset));\r\n}\r\nif (neg == SHIFT_POS) {\r\nnstime_add(&(fd->abs_ts), offset);\r\nnstime_add(&(fd->shift_offset), offset);\r\n} else if (neg == SHIFT_NEG) {\r\nnstime_subtract(&(fd->abs_ts), offset);\r\nnstime_subtract(&(fd->shift_offset), offset);\r\n} else {\r\nfprintf(stderr, "Modify_time_perform: neg = %d?\n", neg);\r\n}\r\n}\r\nstatic void\r\ncalcNT3(nstime_t *OT1, nstime_t *OT3, nstime_t *NT1, nstime_t *NT3,\r\nnstime_t *deltaOT, nstime_t *deltaNT)\r\n{\r\nlong double fnt, fot, f, secs, nsecs;\r\nfnt = (long double)deltaNT->secs + (deltaNT->nsecs / 1000000000.0L);\r\nfot = (long double)deltaOT->secs + (deltaOT->nsecs / 1000000000.0L);\r\nf = fnt / fot;\r\nnstime_copy(NT3, OT3);\r\nnstime_subtract(NT3, OT1);\r\nsecs = f * (long double)NT3->secs;\r\nnsecs = f * (long double)NT3->nsecs;\r\nnsecs += (secs - floorl(secs)) * 1000000000.0L;\r\nwhile (nsecs > 1000000000L) {\r\nsecs += 1;\r\nnsecs -= 1000000000L;\r\n}\r\nwhile (nsecs < 0) {\r\nsecs -= 1;\r\nnsecs += 1000000000L;\r\n}\r\nNT3->secs = (time_t)secs;\r\nNT3->nsecs = (int)nsecs;\r\nnstime_add(NT3, NT1);\r\n}\r\nconst gchar *\r\ntime_string_parse(const gchar *time_text, int *year, int *month, int *day, gboolean *negative, int *hour, int *minute, long double *second) {\r\nconst gchar *pts = time_text;\r\nif (!time_text || !hour || !minute || !second)\r\nreturn "Unable to convert time.";\r\nwhile (g_ascii_isspace(pts[0]))\r\n++pts;\r\nif (year && month && day) {\r\nif (pts[0] == '\0')\r\nreturn "Time is empty.";\r\nif (sscanf(pts, "%d-%d-%d %d:%d:%Lf", year, month, day, hour, minute, second) == 6) {\r\nCHECK_YEARS(year);\r\nCHECK_MONTHS(month);\r\nCHECK_DAYS(day);\r\nCHECK_HOURS(hour);\r\nCHECK_MINUTE(minute);\r\nCHECK_SECOND(second);\r\n} else if (sscanf(pts, "%d:%d:%Lf", hour, minute, second) == 3) {\r\n*year = *month = *day = 0;\r\nCHECK_HOUR(hour);\r\nCHECK_MINUTE(minute);\r\nCHECK_SECOND(second);\r\n} else {\r\nreturn "Could not parse the time. Expected [YYYY-MM-DD] "\r\n"hh:mm:ss[.dec].";\r\n}\r\n} else {\r\nif (!negative)\r\nreturn "Unable to convert time.";\r\n*negative = FALSE;\r\nif (pts[0] == '-') {\r\n*negative = TRUE;\r\npts++;\r\n}\r\nif (pts[0] == '\0')\r\nreturn "Time is empty.";\r\nif (sscanf(pts, "%d:%d:%Lf", hour, minute, second) == 3) {\r\nCHECK_HOUR(hour);\r\nCHECK_MINUTE(minute);\r\nCHECK_SECOND(second);\r\n} else if (sscanf(pts, "%d:%Lf", minute, second) == 2) {\r\nCHECK_MINUTE(minute);\r\nCHECK_SECOND(second);\r\n*hour = 0;\r\n} else if (sscanf(pts, "%Lf", second) == 1) {\r\nCHECK_SECOND(second);\r\n*hour = *minute = 0;\r\n} else {\r\nreturn "Could not parse the time: Expected [[hh:]mm:]ss.[dec].";\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic const gchar *\r\ntime_string_to_nstime(const gchar *time_text, nstime_t *packettime, nstime_t *nstime)\r\n{\r\nint h, m, Y, M, D;\r\nlong double f;\r\nstruct tm tm, *tmptm;\r\ntime_t tt;\r\nconst gchar *err_str;\r\nif ((err_str = time_string_parse(time_text, &Y, &M, &D, NULL, &h, &m, &f)) != NULL)\r\nreturn err_str;\r\ntmptm = localtime(&(packettime->secs));\r\nif (tmptm) {\r\ntm = *tmptm;\r\n} else {\r\nmemset (&tm, 0, sizeof (tm));\r\n}\r\nif (Y != 0) {\r\ntm.tm_year = Y - 1900;\r\ntm.tm_mon = M - 1;\r\ntm.tm_mday = D;\r\n}\r\ntm.tm_hour = h;\r\ntm.tm_min = m;\r\ntm.tm_sec = (int)floorl(f);\r\ntt = mktime(&tm);\r\nif (tt == -1) {\r\nreturn "Mktime went wrong. Is the time valid?";\r\n}\r\nnstime->secs = tt;\r\nf -= tm.tm_sec;\r\nnstime->nsecs = (int)(f * 1000000000);\r\nreturn NULL;\r\n}\r\nconst gchar *\r\ntime_shift_all(capture_file *cf, const gchar *offset_text)\r\n{\r\nnstime_t offset;\r\nlong double offset_float = 0;\r\nguint32 i;\r\nframe_data *fd;\r\ngboolean neg;\r\nint h, m;\r\nlong double f;\r\nconst gchar *err_str;\r\nif (!cf || !offset_text)\r\nreturn "Nothing to work with.";\r\nif ((err_str = time_string_parse(offset_text, NULL, NULL, NULL, &neg, &h, &m, &f)) != NULL)\r\nreturn err_str;\r\noffset_float = h * 3600 + m * 60 + f;\r\nif (offset_float == 0)\r\nreturn "Offset is zero.";\r\nnstime_set_zero(&offset);\r\noffset.secs = (time_t)floorl(offset_float);\r\noffset_float -= offset.secs;\r\noffset.nsecs = (int)(offset_float * 1000000000);\r\nif (!frame_data_sequence_find(cf->frames, 1))\r\nreturn "No frames found.";\r\nfor (i = 1; i <= cf->count; i++) {\r\nif ((fd = frame_data_sequence_find(cf->frames, i)) == NULL)\r\ncontinue;\r\nmodify_time_perform(fd, neg ? SHIFT_NEG : SHIFT_POS, &offset, SHIFT_KEEPOFFSET);\r\n}\r\npacket_list_queue_draw();\r\nreturn NULL;\r\n}\r\nconst gchar *\r\ntime_shift_settime(capture_file *cf, guint packet_num, const gchar *time_text)\r\n{\r\nnstime_t set_time, diff_time, packet_time;\r\nframe_data *fd, *packetfd;\r\nguint32 i;\r\nconst gchar *err_str;\r\nif (!cf || !time_text)\r\nreturn "Nothing to work with.";\r\nif (packet_num < 1 || packet_num > cf->count)\r\nreturn "Packet out of range.";\r\nif ((packetfd = frame_data_sequence_find(cf->frames, packet_num)) == NULL)\r\nreturn "No packets found.";\r\nnstime_delta(&packet_time, &(packetfd->abs_ts), &(packetfd->shift_offset));\r\nif ((err_str = time_string_to_nstime(time_text, &packet_time, &set_time)) != NULL)\r\nreturn err_str;\r\nnstime_delta(&diff_time, &set_time, &packet_time);\r\nif (!frame_data_sequence_find(cf->frames, 1))\r\nreturn "No frames found.";\r\nfor (i = 1; i <= cf->count; i++) {\r\nif ((fd = frame_data_sequence_find(cf->frames, i)) == NULL)\r\ncontinue;\r\nmodify_time_perform(fd, SHIFT_POS, &diff_time, SHIFT_SETTOZERO);\r\n}\r\npacket_list_queue_draw();\r\nreturn NULL;\r\n}\r\nconst gchar *\r\ntime_shift_adjtime(capture_file *cf, guint packet1_num, const gchar *time1_text, guint packet2_num, const gchar *time2_text)\r\n{\r\nnstime_t nt1, nt2, ot1, ot2, nt3;\r\nnstime_t dnt, dot, d3t;\r\nframe_data *fd, *packet1fd, *packet2fd;\r\nguint32 i;\r\nconst gchar *err_str;\r\nif (!cf || !time1_text || !time2_text)\r\nreturn "Nothing to work with.";\r\nif (packet1_num < 1 || packet1_num > cf->count || packet2_num < 1 || packet2_num > cf->count)\r\nreturn "Packet out of range.";\r\nif ((packet1fd = frame_data_sequence_find(cf->frames, packet1_num)) == NULL)\r\nreturn "No frames found.";\r\nnstime_copy(&ot1, &(packet1fd->abs_ts));\r\nnstime_subtract(&ot1, &(packet1fd->shift_offset));\r\nif ((err_str = time_string_to_nstime(time1_text, &ot1, &nt1)) != NULL)\r\nreturn err_str;\r\nif ((packet2fd = frame_data_sequence_find(cf->frames, packet2_num)) == NULL)\r\nreturn "No frames found.";\r\nnstime_copy(&ot2, &(packet2fd->abs_ts));\r\nnstime_subtract(&ot2, &(packet2fd->shift_offset));\r\nif ((err_str = time_string_to_nstime(time2_text, &ot2, &nt2)) != NULL)\r\nreturn err_str;\r\nnstime_copy(&dot, &ot2);\r\nnstime_subtract(&dot, &ot1);\r\nnstime_copy(&dnt, &nt2);\r\nnstime_subtract(&dnt, &nt1);\r\nif (!frame_data_sequence_find(cf->frames, 1))\r\nreturn "No frames found.";\r\nfor (i = 1; i <= cf->count; i++) {\r\nif ((fd = frame_data_sequence_find(cf->frames, i)) == NULL)\r\ncontinue;\r\nnstime_subtract(&(fd->abs_ts), &(fd->shift_offset));\r\nnstime_set_zero(&(fd->shift_offset));\r\ncalcNT3(&ot1, &(fd->abs_ts), &nt1, &nt3, &dot, &dnt);\r\nnstime_copy(&d3t, &nt3);\r\nnstime_subtract(&d3t, &(fd->abs_ts));\r\nmodify_time_perform(fd, SHIFT_POS, &d3t, SHIFT_SETTOZERO);\r\n}\r\npacket_list_queue_draw();\r\nreturn NULL;\r\n}\r\nconst gchar *\r\ntime_shift_undo(capture_file *cf)\r\n{\r\nguint32 i;\r\nframe_data *fd;\r\nnstime_t nulltime;\r\nif (!cf)\r\nreturn "Nothing to work with.";\r\nnulltime.secs = nulltime.nsecs = 0;\r\nif (!frame_data_sequence_find(cf->frames, 1))\r\nreturn "No frames found.";\r\nfor (i = 1; i <= cf->count; i++) {\r\nif ((fd = frame_data_sequence_find(cf->frames, i)) == NULL)\r\ncontinue;\r\nmodify_time_perform(fd, SHIFT_NEG, &nulltime, SHIFT_SETTOZERO);\r\n}\r\npacket_list_queue_draw();\r\nreturn NULL;\r\n}

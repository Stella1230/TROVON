static const gchar*\r\nget_register_name_from_address(guint64 addr, gboolean* is_custom_register, u3v_conv_info_t * u3v_conv_info)\r\n{\r\nconst gchar* address_string = NULL;\r\nguint32 offset_address;\r\nif (is_custom_register != NULL) {\r\n*is_custom_register = FALSE;\r\n}\r\nif ( addr < 0x10000 ) {\r\noffset_address = (guint32)addr;\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_abrm);\r\n}\r\nif ( u3v_conv_info && u3v_conv_info->sbrm_addr != 0 && (addr >= u3v_conv_info->sbrm_addr)) {\r\noffset_address = (guint32)( addr - u3v_conv_info->sbrm_addr);\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_sbrm);\r\n}\r\nif ( u3v_conv_info && u3v_conv_info->sirm_addr != 0 && (addr >= u3v_conv_info->sirm_addr)) {\r\noffset_address = (guint32)( addr - u3v_conv_info->sirm_addr);\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_sirm);\r\n}\r\nif ( u3v_conv_info && u3v_conv_info->eirm_addr != 0 && (addr >= u3v_conv_info->eirm_addr)) {\r\noffset_address = (guint32)( addr - u3v_conv_info->eirm_addr);\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_eirm);\r\n}\r\nif (!address_string) {\r\naddress_string = wmem_strdup_printf(wmem_packet_scope(), "[Addr:0x%016" G_GINT64_MODIFIER "X]", addr);\r\nif (is_custom_register != NULL) {\r\n*is_custom_register = TRUE;\r\n}\r\n}\r\nreturn address_string;\r\n}\r\nstatic int\r\nis_known_bootstrap_register(guint64 addr, u3v_conv_info_t * u3v_conv_info)\r\n{\r\nconst gchar* address_string = NULL;\r\nguint32 offset_address;\r\nif ( addr < 0x10000 ) {\r\noffset_address = (guint32)addr;\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_abrm);\r\n}\r\nif ( u3v_conv_info->sbrm_addr != 0 && (addr >= u3v_conv_info->sbrm_addr)) {\r\noffset_address = (guint32)( addr - u3v_conv_info->sbrm_addr);\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_sbrm);\r\n}\r\nif ( u3v_conv_info->sirm_addr != 0 && (addr >= u3v_conv_info->sirm_addr)) {\r\noffset_address = (guint32)( addr - u3v_conv_info->sirm_addr);\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_sirm);\r\n}\r\nif ( u3v_conv_info->eirm_addr != 0 && (addr >= u3v_conv_info->eirm_addr)) {\r\noffset_address = (guint32)( addr - u3v_conv_info->eirm_addr);\r\naddress_string = try_val_to_str(offset_address, bootstrap_register_names_eirm);\r\n}\r\nreturn address_string != NULL;\r\n}\r\nstatic void\r\ndissect_u3v_register_bases(guint64 addr, tvbuff_t *tvb, gint offset, u3v_conv_info_t * u3v_conv_info)\r\n{\r\nif ( addr < 0x10000 ) {\r\nswitch (addr) {\r\ncase U3V_ABRM_SBRM_ADDRESS:\r\nu3v_conv_info->sbrm_addr = tvb_get_letoh64(tvb, offset);\r\nbreak;\r\ncase U3V_ABRM_MANIFEST_TABLE_ADDRESS:\r\nu3v_conv_info->manifest_addr = tvb_get_letoh64(tvb, offset);\r\nbreak;\r\n}\r\n}\r\nif ( u3v_conv_info->sbrm_addr != 0 && (addr >= u3v_conv_info->sbrm_addr)) {\r\naddr -= u3v_conv_info->sbrm_addr;\r\nswitch(addr) {\r\ncase U3V_SBRM_SIRM_ADDRESS:\r\nu3v_conv_info->sirm_addr = tvb_get_letoh64(tvb, offset);\r\nbreak;\r\ncase U3V_SBRM_EIRM_ADDRESS:\r\nu3v_conv_info->eirm_addr = tvb_get_letoh64(tvb, offset);\r\nbreak;\r\ncase U3V_SBRM_IIDC2_ADDRESS:\r\nu3v_conv_info->iidc2_addr = tvb_get_letoh64(tvb, offset);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int\r\ndissect_u3v_register(guint64 addr, proto_tree *branch, tvbuff_t *tvb, gint offset, gint length, u3v_conv_info_t * u3v_conv_info)\r\n{\r\ngint isABRM = FALSE, isSBRM = FALSE, isSIRM = FALSE,isEIRM = FALSE;\r\nif ( addr < 0x10000 ) {\r\nisABRM = TRUE;\r\nswitch (addr) {\r\ncase U3V_ABRM_GENCP_VERSION:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_GenCP_Version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_MANUFACTURER_NAME:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Manufacturer_Name, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_MODEL_NAME:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Model_Name, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_FAMILY_NAME:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Family_Name, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_DEVICE_VERSION:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Device_Version, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_MANUFACTURER_INFO:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Manufacturer_Info, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_SERIAL_NUMBER:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Serial_Number, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_USER_DEFINED_NAME:\r\nif ( length <= 64 ) {\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_User_Defined_Name, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase U3V_ABRM_DEVICE_CAPABILITY:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Device_Capability, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_MAXIMUM_DEVICE_RESPONSE_TIME:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Maximum_Device_Response_Time, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_MANIFEST_TABLE_ADDRESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Manifest_Table_Address, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_SBRM_ADDRESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SBRM_Address, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_DEVICE_CONFIGURATION:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Device_Configuration, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_HEARTBEAT_TIMEOUT:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Heartbeat_Timeout, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_MESSAGE_CHANNEL_CHANNEL_ID:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Message_Channel_channel_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_TIMESTAMP:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Timestamp, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_TIMESTAMP_LATCH:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Timestamp_Latch, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_TIMESTAMP_INCREMENT:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Timestamp_Increment, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_ACCESS_PRIVILEGE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Access_Privilege, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_PROTOCOL_ENDIANESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Protocol_Endianess, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_ABRM_IMPLEMENTATION_ENDIANESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Implementation_Endianess, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ndefault:\r\nisABRM = FALSE;\r\nbreak;\r\n}\r\n}\r\nif ( u3v_conv_info->sbrm_addr != 0 && (addr >= u3v_conv_info->sbrm_addr)) {\r\nguint64 map_offset = addr - u3v_conv_info->sbrm_addr;\r\nisSBRM = TRUE;\r\nswitch(map_offset) {\r\ncase U3V_SBRM_U3V_VERSION:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_U3V_Version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_U3VCP_CAPABILITY_REGISTER:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_U3VCP_Capability_Register, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_U3VCP_CONFIGURATION_REGISTER:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_U3VCP_Configuration_Register, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_MAXIMUM_COMMAND_TRANSFER_LENGTH:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Maximum_Command_Transfer_Length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_MAXIMUM_ACKNOWLEDGE_TRANSFER_LENGTH:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Maximum_Acknowledge_Transfer_Length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_NUMBER_OF_STREAM_CHANNELS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Number_of_Stream_Channels, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_SIRM_ADDRESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SIRM_Address, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_SIRM_LENGTH:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SIRM_Length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_EIRM_ADDRESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_EIRM_Address, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_EIRM_LENGTH:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_EIRM_Length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_IIDC2_ADDRESS:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_IIDC2_Address, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SBRM_CURRENT_SPEED:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Current_Speed, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ndefault:\r\nisSBRM = FALSE;\r\nbreak;\r\n}\r\n}\r\nif ( u3v_conv_info->sirm_addr != 0 && (addr >= u3v_conv_info->sirm_addr)) {\r\nguint64 map_offset = addr - u3v_conv_info->sirm_addr;\r\nisSIRM = TRUE;\r\nswitch(map_offset) {\r\ncase U3V_SIRM_SI_INFO:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Info, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_CONTROL:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Control, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_REQUIRED_PAYLOAD_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Required_Payload_Size, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_REQUIRED_LEADER_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Required_Leader_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_REQUIRED_TRAILER_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Required_Trailer_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_MAXIMUM_LEADER_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Maximum_Leader_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_PAYLOAD_TRANSFER_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Payload_Transfer_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_PAYLOAD_TRANSFER_COUNT:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Payload_Transfer_Count, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_PAYLOAD_FINAL_TRANSFER1_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Payload_Final_Transfer1_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_PAYLOAD_FINAL_TRANSFER2_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Payload_Final_Transfer2_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_SIRM_SI_MAXIMUM_TRAILER_SIZE:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_SI_Maximum_Trailer_Size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ndefault:\r\nisSIRM = FALSE;\r\nbreak;\r\n}\r\n}\r\nif ( u3v_conv_info->eirm_addr != 0 && (addr >= u3v_conv_info->eirm_addr)) {\r\nguint64 map_offset = addr -u3v_conv_info->eirm_addr;\r\nisEIRM=TRUE;\r\nswitch(map_offset) {\r\ncase U3V_EIRM_EI_CONTROL:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_EI_Control, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_EIRM_MAXIMUM_EVENT_TRANSFER_LENGTH:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Maximum_Event_Transfer_Length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase U3V_EIRM_EVENT_TEST_CONTROL:\r\nproto_tree_add_item(branch, hf_u3v_bootstrap_Event_Test_Control, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ndefault:\r\nisEIRM = FALSE;\r\nbreak;\r\n}\r\n}\r\nif(isABRM || isSBRM || isSIRM || isEIRM ) {\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\ndissect_u3v_read_mem_cmd(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, gint startoffset, gint length, u3v_conv_info_t *u3v_conv_info, gencp_transaction_t * gencp_trans)\r\n{\r\nguint64 addr = 0;\r\nconst gchar* address_string = NULL;\r\ngboolean is_custom_register = FALSE;\r\nguint16 count = 0;\r\ngint offset = startoffset;\r\nproto_item *item = NULL;\r\naddr = tvb_get_letoh64(tvb, offset);\r\ngencp_trans->address = addr;\r\naddress_string = get_register_name_from_address(addr, &is_custom_register, u3v_conv_info);\r\ncount = tvb_get_letohs(tvb, offset + 10);\r\ngencp_trans->count = count;\r\nif ( 0xffffffff00000000 & addr ) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " (0x%016" G_GINT64_MODIFIER "X (%d) bytes) %s", addr, count, address_string);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " (0x%08X (%d) bytes)", (guint32)addr, count);\r\n}\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_scd_readmem_cmd, tvb, offset, length, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_payload_cmd);\r\nif (is_known_bootstrap_register(addr, u3v_conv_info)) {\r\nitem = proto_tree_add_uint64(u3v_telegram_tree, hf_u3v_address, tvb, offset, 8, addr);\r\nproto_item_append_text(item, " %s", address_string);\r\n} else {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_custom_memory_addr, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 8;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_count, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void\r\ndissect_u3v_write_mem_cmd(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, gint startoffset, gint length, u3v_conv_info_t *u3v_conv_info, gencp_transaction_t *gencp_trans)\r\n{\r\nconst gchar* address_string = NULL;\r\ngboolean is_custom_register = FALSE;\r\nguint64 addr = 0;\r\nguint byte_count = 0;\r\nproto_item *item = NULL;\r\nguint offset = startoffset + 8;\r\naddr = tvb_get_letoh64(tvb, startoffset);\r\nbyte_count = length - 8;\r\naddress_string = get_register_name_from_address(addr, &is_custom_register, u3v_conv_info);\r\ngencp_trans->address = addr;\r\ngencp_trans->count = byte_count;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s: %d bytes", address_string, byte_count);\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_scd_writemem_cmd, tvb, startoffset, length, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_payload_cmd);\r\nif (is_known_bootstrap_register(addr, u3v_conv_info)) {\r\nitem = proto_tree_add_uint64(u3v_telegram_tree, hf_u3v_address, tvb, startoffset, 8, addr);\r\nproto_item_append_text(item, " %s", address_string);\r\ndissect_u3v_register(addr, u3v_telegram_tree, tvb, offset, byte_count, u3v_conv_info);\r\n} else {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_custom_memory_addr, tvb, startoffset, 8, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_custom_memory_data, tvb, startoffset + 8, byte_count, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_u3v_event_cmd(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, gint startoffset, gint length)\r\n{\r\ngint32 eventid;\r\ngint offset = startoffset;\r\nproto_item *item = NULL;\r\neventid = tvb_get_letohs(tvb, offset + 2);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "[ID: 0x%04X]", eventid);\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_scd_event_cmd, tvb, offset, length, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_payload_cmd);\r\noffset += 2;\r\nif ((eventid >= 0x0000) && (eventid <= 0x8000)) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_eventcmd_id, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n} else if ((eventid >= 0x8001) && (eventid <= 0x8FFF)) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_eventcmd_error_id, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n} else if ((eventid >= 0x9000) && (eventid <= 0xFFFF)) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_eventcmd_device_specific_id, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_eventcmd_timestamp, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nif (length > offset ) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_eventcmd_data, tvb, offset, length - 12, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_u3v_read_mem_ack(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, gint startoffset, gint length, u3v_conv_info_t *u3v_conv_info, gencp_transaction_t * gencp_trans)\r\n{\r\nguint64 addr = 0;\r\nconst gchar *address_string = NULL;\r\ngboolean is_custom_register = FALSE;\r\ngboolean have_address = (0 != gencp_trans->cmd_frame);\r\nproto_item *item = NULL;\r\nguint offset = startoffset;\r\nguint byte_count = (length);\r\naddr = gencp_trans->address;\r\ndissect_u3v_register_bases(addr, tvb, startoffset, u3v_conv_info);\r\nif (have_address) {\r\naddress_string = get_register_name_from_address(addr, &is_custom_register, u3v_conv_info);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s", address_string);\r\n}\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_scd_ack_readmem_ack, tvb, startoffset, length, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_payload_cmd);\r\nif (have_address) {\r\nitem = proto_tree_add_uint64(u3v_telegram_tree, hf_u3v_address, tvb, 0,0 , addr);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nif (is_known_bootstrap_register(addr, u3v_conv_info)) {\r\ndissect_u3v_register(addr, u3v_telegram_tree, tvb, offset, byte_count, u3v_conv_info);\r\n} else {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_custom_memory_data, tvb, startoffset, length, ENC_NA);\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_u3v_write_mem_ack(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, gint startoffset, gint length, u3v_conv_info_t *u3v_conv_info , gencp_transaction_t * gencp_trans)\r\n{\r\nguint64 addr = 0;\r\ngint offset = startoffset;\r\nconst gchar *address_string = NULL;\r\ngboolean is_custom_register = FALSE;\r\ngboolean have_address = (0 != gencp_trans->cmd_frame);\r\nproto_item *item = NULL;\r\naddr = gencp_trans->address;\r\nif (have_address) {\r\naddress_string = get_register_name_from_address(addr, &is_custom_register, u3v_conv_info);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s", address_string);\r\n}\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_scd_writemem_ack, tvb, startoffset, length, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_payload_cmd);\r\nif (have_address) {\r\nitem = proto_tree_add_uint64(u3v_telegram_tree, hf_u3v_address, tvb, 0,0 , addr);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\nif ( length == 4 ) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_count, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\nstatic void\r\ndissect_u3v_pending_ack(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo _U_, gint startoffset, gint length, u3v_conv_info_t *u3v_conv_info _U_, gencp_transaction_t *gencp_trans _U_)\r\n{\r\nproto_item *item = NULL;\r\nguint offset = startoffset;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %d ms", tvb_get_letohs(tvb, startoffset+2));\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_ccd_pending_ack, tvb, startoffset, length, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_payload_cmd);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_time_to_completion, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void\r\ndissect_u3v_stream_leader(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, usb_conv_info_t *usb_conv_info _U_)\r\n{\r\nguint32 offset = 0;\r\nguint32 payload_type = 0;\r\nguint64 block_id = 0;\r\nproto_item *item = NULL;\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_leader, tvb, 0, -1, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_stream_leader);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_prefix, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_leader_size, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nblock_id = tvb_get_letoh64(tvb, offset);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_block_id, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\npayload_type = tvb_get_letohs(tvb, offset);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_payload_type, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Stream Leader [ Block ID: %" G_GINT64_MODIFIER "u , Type %s]",\r\nblock_id,\r\nval_to_str(payload_type, payload_type_names, "Unknown Payload Type"));\r\nif (payload_type == U3V_STREAM_PAYLOAD_IMAGE ||\r\npayload_type == U3V_STREAM_PAYLOAD_IMAGE_EXT_CHUNK ||\r\npayload_type == U3V_STREAM_PAYLOAD_CHUNK) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_timestamp, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nif (payload_type == U3V_STREAM_PAYLOAD_IMAGE ||\r\npayload_type == U3V_STREAM_PAYLOAD_IMAGE_EXT_CHUNK ) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_pixel_format, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_size_x, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_size_y, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_offset_x, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_offset_y, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_padding_x, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_reserved, tvb, offset, 2, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_u3v_stream_trailer(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, usb_conv_info_t *usb_conv_info _U_)\r\n{\r\ngint offset = 0;\r\nguint64 block_id;\r\nproto_item *item = NULL;\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_trailer, tvb, 0, -1, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_stream_trailer);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_prefix, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_trailer_size, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nblock_id = tvb_get_letoh64(tvb, offset);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_block_id, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_status, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_valid_payload_size, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Stream Trailer [ Block ID: %" G_GINT64_MODIFIER "u]", block_id);\r\nif (tvb_captured_length_remaining(tvb,offset) >=4 ) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_size_y, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\nif (tvb_captured_length_remaining(tvb,offset) >=4 ) {\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_chunk_layout_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\nstatic void\r\ndissect_u3v_stream_payload(proto_tree *u3v_telegram_tree, tvbuff_t *tvb, packet_info *pinfo, usb_conv_info_t *usb_conv_info _U_)\r\n{\r\nproto_item *item = NULL;\r\nitem = proto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_payload, tvb, 0, -1, ENC_NA);\r\nu3v_telegram_tree = proto_item_add_subtree(item, ett_u3v_stream_payload);\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_stream_data, tvb, 0, -1, ENC_NA);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Stream Payload");\r\n}\r\nstatic int\r\ndissect_u3v(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ngint offset = 0;\r\nproto_tree *u3v_tree = NULL, *ccd_tree_flag, *u3v_telegram_tree = NULL, *ccd_tree = NULL;\r\ngint data_length = 0;\r\ngint req_id = 0;\r\ngint command_id = -1;\r\ngint status = 0;\r\nguint prefix = 0;\r\nproto_item *ti = NULL;\r\nproto_item *item = NULL;\r\nconst char *command_string;\r\nusb_conv_info_t *usb_conv_info;\r\ngint stream_detected = FALSE;\r\ngint control_detected = FALSE;\r\nu3v_conv_info_t *u3v_conv_info = NULL;\r\ngencp_transaction_t *gencp_trans = NULL;\r\nusb_conv_info = (usb_conv_info_t *)data;\r\nu3v_conv_info = (u3v_conv_info_t *)usb_conv_info->class_data;\r\nif (!u3v_conv_info) {\r\nu3v_conv_info = wmem_new0(wmem_file_scope(), u3v_conv_info_t);\r\nusb_conv_info->class_data = u3v_conv_info;\r\nusb_conv_info->class_data_type = USB_CONV_U3V;\r\n} else if (usb_conv_info->class_data_type != USB_CONV_U3V) {\r\nreturn 0;\r\n}\r\nprefix = tvb_get_letohl(tvb, 0);\r\nif ((tvb_reported_length(tvb) >= 4) && ( ( U3V_CONTROL_PREFIX == prefix ) || ( U3V_EVENT_PREFIX == prefix ) ) ) {\r\ncontrol_detected = TRUE;\r\n}\r\nif (((tvb_reported_length(tvb) >= 4) && (( U3V_STREAM_LEADER_PREFIX == prefix ) || ( U3V_STREAM_TRAILER_PREFIX == prefix )))\r\n|| (usb_conv_info->endpoint == u3v_conv_info->ep_stream)) {\r\nstream_detected = TRUE;\r\n}\r\nif ( control_detected || stream_detected){\r\nif ( usb_conv_info->interfaceClass == IF_CLASS_UNKNOWN &&\r\nusb_conv_info->interfaceSubclass == IF_SUBCLASS_UNKNOWN){\r\nusb_conv_info->interfaceClass = IF_CLASS_MISCELLANEOUS;\r\nusb_conv_info->interfaceSubclass = IF_SUBCLASS_MISC_U3V;\r\n}\r\n}\r\nif ( control_detected ) {\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "U3V");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_u3v, tvb, offset, -1, ENC_NA);\r\nu3v_tree = proto_item_add_subtree(ti, ett_u3v);\r\nprefix = tvb_get_letohl(tvb, offset);\r\ncommand_id = tvb_get_letohs(tvb, offset+6);\r\nif ((prefix == U3V_CONTROL_PREFIX || prefix == U3V_EVENT_PREFIX) && ((command_id % 2) == 0)) {\r\ncommand_string = val_to_str(command_id,command_names,"Unknown Command (0x%x)");\r\nitem = proto_tree_add_item(u3v_tree, hf_u3v_ccd_cmd, tvb, offset, 8, ENC_NA);\r\nproto_item_append_text(item, ": %s", command_string);\r\nccd_tree = proto_item_add_subtree(item, ett_u3v_cmd);\r\nproto_tree_add_item(ccd_tree, hf_u3v_gencp_prefix, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nitem = proto_tree_add_item(ccd_tree, hf_u3v_flag, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nccd_tree_flag = proto_item_add_subtree(item, ett_u3v_flags);\r\nproto_tree_add_item(ccd_tree_flag, hf_u3v_acknowledge_required_flag, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "> %s ", command_string);\r\n} else if (prefix == U3V_CONTROL_PREFIX && ((command_id % 2) == 1)) {\r\ncommand_string = val_to_str(command_id,command_names,"Unknown Acknowledge (0x%x)");\r\nitem = proto_tree_add_item(u3v_tree, hf_u3v_ccd_ack, tvb, offset, 8, ENC_NA);\r\nproto_item_append_text(item, ": %s", command_string);\r\nccd_tree = proto_item_add_subtree(item, ett_u3v_ack);\r\nproto_tree_add_item(ccd_tree, hf_u3v_gencp_prefix, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ccd_tree, hf_u3v_status, tvb, offset, 2,ENC_LITTLE_ENDIAN);\r\nstatus = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "< %s %s",\r\ncommand_string,\r\nval_to_str(status, status_names_short, "Unknown status (0x%04X)"));\r\n} else {\r\nreturn 0;\r\n}\r\nproto_tree_add_item(ccd_tree, hf_u3v_command_id, tvb, offset, 2,ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ccd_tree, hf_u3v_length, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\ndata_length = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(ccd_tree, hf_u3v_request_id, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nreq_id = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\nu3v_telegram_tree = proto_item_add_subtree(u3v_tree, ett_u3v);\r\nif (!PINFO_FD_VISITED(pinfo)) {\r\nif ((command_id % 2) == 0) {\r\ngencp_trans = wmem_new(wmem_file_scope(), gencp_transaction_t);\r\ngencp_trans->cmd_frame = pinfo->fd->num;\r\ngencp_trans->ack_frame = 0;\r\ngencp_trans->cmd_time = pinfo->fd->abs_ts;\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_u3v, req_id, gencp_trans);\r\nu3v_conv_info->trans_info = gencp_trans;\r\n} else {\r\ngencp_trans = u3v_conv_info->trans_info;\r\nif (gencp_trans) {\r\ngencp_trans->ack_frame = pinfo->fd->num;\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_u3v, req_id, gencp_trans);\r\n}\r\n}\r\n} else {\r\ngencp_trans = (gencp_transaction_t*)p_get_proto_data(wmem_file_scope(),pinfo, proto_u3v, req_id);\r\n}\r\nif (!gencp_trans) {\r\ngencp_trans = wmem_new(wmem_packet_scope(), gencp_transaction_t);\r\ngencp_trans->cmd_frame = 0;\r\ngencp_trans->ack_frame = 0;\r\ngencp_trans->cmd_time = pinfo->fd->abs_ts;\r\n}\r\nswitch (command_id) {\r\ncase U3V_READMEM_CMD:\r\ndissect_u3v_read_mem_cmd(u3v_telegram_tree, tvb, pinfo, offset, data_length,u3v_conv_info,gencp_trans);\r\nbreak;\r\ncase U3V_WRITEMEM_CMD:\r\ndissect_u3v_write_mem_cmd(u3v_telegram_tree, tvb, pinfo, offset, data_length,u3v_conv_info,gencp_trans);\r\nbreak;\r\ncase U3V_EVENT_CMD:\r\ndissect_u3v_event_cmd(u3v_telegram_tree, tvb, pinfo, offset, data_length);\r\nbreak;\r\ncase U3V_READMEM_ACK:\r\nif ( U3V_STATUS_GENCP_SUCCESS == status ) {\r\ndissect_u3v_read_mem_ack(u3v_telegram_tree, tvb, pinfo, offset, data_length,u3v_conv_info,gencp_trans);\r\n}\r\nbreak;\r\ncase U3V_WRITEMEM_ACK:\r\ndissect_u3v_write_mem_ack(u3v_telegram_tree, tvb, pinfo, offset, data_length, u3v_conv_info,gencp_trans);\r\nbreak;\r\ncase U3V_PENDING_ACK:\r\ndissect_u3v_pending_ack(u3v_telegram_tree, tvb, pinfo, offset, data_length, u3v_conv_info,gencp_trans);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(u3v_telegram_tree, hf_u3v_payloaddata, tvb, offset, data_length, ENC_NA);\r\nbreak;\r\n}\r\nreturn data_length + 12;\r\n} else if ( stream_detected ) {\r\nu3v_conv_info = (u3v_conv_info_t *)usb_conv_info->class_data;\r\nu3v_conv_info->ep_stream = usb_conv_info->endpoint;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "U3V");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_u3v, tvb, offset, -1, ENC_NA);\r\nu3v_tree = proto_item_add_subtree(ti, ett_u3v);\r\nif(tvb_captured_length(tvb) >=4) {\r\nprefix = tvb_get_letohl(tvb, offset);\r\nswitch (prefix) {\r\ncase U3V_STREAM_LEADER_PREFIX:\r\ndissect_u3v_stream_leader(u3v_tree, tvb, pinfo, usb_conv_info);\r\nbreak;\r\ncase U3V_STREAM_TRAILER_PREFIX:\r\ndissect_u3v_stream_trailer(u3v_tree, tvb, pinfo, usb_conv_info);\r\nbreak;\r\ndefault:\r\ndissect_u3v_stream_payload(u3v_tree, tvb, pinfo, usb_conv_info);\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nreturn 0;\r\n}\r\nstatic gboolean\r\ndissect_u3v_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nguint32 prefix;\r\nusb_conv_info_t *usb_conv_info;\r\nif (tvb_reported_length(tvb) < 4)\r\nreturn FALSE;\r\nprefix = tvb_get_letohl(tvb, 0);\r\nusb_conv_info = (usb_conv_info_t *)data;\r\nif (!usb_conv_info)\r\nreturn FALSE;\r\nif ((U3V_STREAM_LEADER_PREFIX == prefix) || (U3V_STREAM_TRAILER_PREFIX == prefix) ||\r\n(U3V_CONTROL_PREFIX == prefix) || (U3V_EVENT_PREFIX == prefix) ||\r\n((usb_conv_info->interfaceClass == IF_CLASS_MISCELLANEOUS &&\r\nusb_conv_info->interfaceSubclass == IF_SUBCLASS_MISC_U3V))) {\r\ndissect_u3v(tvb, pinfo, tree, data);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gint\r\ndissect_u3v_descriptors(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nguint8 type;\r\ngint offset = 0;\r\nproto_item * ti;\r\nproto_tree * sub_tree;\r\nguint32 version;\r\nif (tvb_reported_length(tvb) < 2) {\r\nreturn 0;\r\n}\r\ntype = tvb_get_guint8(tvb, 1);\r\nif (type != DESCRIPTOR_TYPE_U3V_INTERFACE) {\r\nreturn 0;\r\n}\r\nti = proto_tree_add_item(tree, hf_u3v_device_info_descriptor, tvb, offset, -1, ENC_NA);\r\ntree = proto_item_add_subtree(ti, ett_u3v_device_info_descriptor);\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_bLength, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nti = proto_tree_add_item(tree, hf_u3v_device_info_descriptor_bDescriptorType, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_item_append_text(ti, " (U3V INTERFACE)");\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_bDescriptorSubtype, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nif (!tvb_bytes_exist(tvb, offset, 4)) {\r\nreturn offset;\r\n}\r\nversion = tvb_get_letohl(tvb, offset);\r\nti = proto_tree_add_item(tree, hf_u3v_device_info_descriptor_bGenCPVersion, tvb, offset, 4, ENC_NA);\r\nproto_item_append_text(ti, ": %u.%u", version >> 16, version & 0xFFFF);\r\nsub_tree = proto_item_add_subtree(ti, ett_u3v_device_info_descriptor_gencp_version);\r\nproto_tree_add_item(sub_tree, hf_u3v_device_info_descriptor_bGenCPVersion_minor, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_u3v_device_info_descriptor_bGenCPVersion_major, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nif (!tvb_bytes_exist(tvb, offset, 4)) {\r\nreturn offset;\r\n}\r\nversion = tvb_get_letohl(tvb, offset);\r\nti = proto_tree_add_item(tree, hf_u3v_device_info_descriptor_bU3VVersion, tvb, offset, 4, ENC_NA);\r\nproto_item_append_text(ti, ": %u.%u", version >> 16, version & 0xFFFF);\r\nsub_tree = proto_item_add_subtree(ti, ett_u3v_device_info_descriptor_u3v_version);\r\nproto_tree_add_item(sub_tree, hf_u3v_device_info_descriptor_bU3VVersion_minor, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_u3v_device_info_descriptor_bU3VVersion_major, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iDeviceGUID, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iVendorName, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iModelName, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iFamilyName, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iDeviceVersion, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iManufacturerInfo, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iSerialNumber, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_u3v_device_info_descriptor_iUserDefinedName, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_bitmask(tree, tvb, offset, hf_u3v_device_info_descriptor_bmSpeedSupport,\r\nett_u3v_device_info_descriptor_speed_support, speed_support_fields, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_u3v(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_u3v,\r\n&ett_u3v_cmd,\r\n&ett_u3v_flags,\r\n&ett_u3v_ack,\r\n&ett_u3v_payload_cmd,\r\n&ett_u3v_payload_ack,\r\n&ett_u3v_payload_ack_subtree,\r\n&ett_u3v_payload_cmd_subtree,\r\n&ett_u3v_bootstrap_fields,\r\n&ett_u3v_stream_leader,\r\n&ett_u3v_stream_trailer,\r\n&ett_u3v_stream_payload,\r\n&ett_u3v_device_info_descriptor,\r\n&ett_u3v_device_info_descriptor_speed_support,\r\n&ett_u3v_device_info_descriptor_gencp_version,\r\n&ett_u3v_device_info_descriptor_u3v_version,\r\n};\r\nproto_u3v = proto_register_protocol("USB 3 Vision", "U3V", "u3v");\r\nproto_register_field_array(proto_u3v, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("u3v", dissect_u3v, proto_u3v);\r\n}\r\nvoid\r\nproto_reg_handoff_u3v(void)\r\n{\r\ndissector_handle_t u3v_handle = NULL;\r\ndissector_handle_t u3v_descr_handle = NULL;\r\nu3v_handle = find_dissector("u3v");\r\ndissector_add_uint("usb.bulk", IF_CLASS_MISCELLANEOUS, u3v_handle);\r\nheur_dissector_add("usb.bulk", dissect_u3v_heur, "USB3Vision Protocol", "u3v", proto_u3v,HEURISTIC_ENABLE);\r\nu3v_descr_handle = create_dissector_handle(dissect_u3v_descriptors, proto_u3v);\r\ndissector_add_uint("usb.descriptor", IF_CLASS_MISCELLANEOUS, u3v_descr_handle);\r\n}

static int\r\ndissect_netmon_802_11(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nstruct ieee_802_11_phdr *phdr = (struct ieee_802_11_phdr *)data;\r\nproto_tree *wlan_tree = NULL, *opmode_tree;\r\nproto_item *ti;\r\ntvbuff_t *next_tvb;\r\nint offset;\r\nguint8 version;\r\nguint16 length;\r\nguint32 phy_type;\r\nguint32 flags;\r\nguint32 channel;\r\ngint calc_channel;\r\ngint32 rssi;\r\nguint8 rate;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WLAN");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\noffset = 0;\r\nversion = tvb_get_guint8(tvb, offset);\r\nlength = tvb_get_letohs(tvb, offset+1);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "NetMon WLAN Capture v%u, Length %u",\r\nversion, length);\r\nif (version != 2) {\r\ngoto skip;\r\n}\r\nif (length < MIN_HEADER_LEN) {\r\ngoto skip;\r\n}\r\nti = proto_tree_add_item(tree, proto_netmon_802_11, tvb, 0, length,\r\nENC_NA);\r\nwlan_tree = proto_item_add_subtree(ti, ett_netmon_802_11);\r\nproto_tree_add_item(wlan_tree, hf_netmon_802_11_version, tvb, offset, 1,\r\nENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(wlan_tree, hf_netmon_802_11_length, tvb, offset, 2,\r\nENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nti = proto_tree_add_item(wlan_tree, hf_netmon_802_11_op_mode, tvb, offset,\r\n4, ENC_LITTLE_ENDIAN);\r\nopmode_tree = proto_item_add_subtree(ti, ett_netmon_802_11_op_mode);\r\nproto_tree_add_item(opmode_tree, hf_netmon_802_11_op_mode_sta, tvb, offset,\r\n4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(opmode_tree, hf_netmon_802_11_op_mode_ap, tvb, offset,\r\n4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(opmode_tree, hf_netmon_802_11_op_mode_sta_ext, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(opmode_tree, hf_netmon_802_11_op_mode_mon, tvb, offset,\r\n4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nflags = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nif (flags != 0xffffffff) {\r\nphy_type = tvb_get_letohl(tvb, offset);\r\nmemset(&phdr->phy_info, 0, sizeof(phdr->phy_info));\r\nswitch (phy_type) {\r\ncase PHY_TYPE_UNKNOWN:\r\nphdr->phy = PHDR_802_11_PHY_UNKNOWN;\r\nbreak;\r\ncase PHY_TYPE_FHSS:\r\nphdr->phy = PHDR_802_11_PHY_11_FHSS;\r\nbreak;\r\ncase PHY_TYPE_IR_BASEBAND:\r\nphdr->phy = PHDR_802_11_PHY_11_IR;\r\nbreak;\r\ncase PHY_TYPE_DSSS:\r\nphdr->phy = PHDR_802_11_PHY_11_DSSS;\r\nbreak;\r\ncase PHY_TYPE_HR_DSSS:\r\nphdr->phy = PHDR_802_11_PHY_11B;\r\nbreak;\r\ncase PHY_TYPE_OFDM:\r\nphdr->phy = PHDR_802_11_PHY_11A;\r\nbreak;\r\ncase PHY_TYPE_ERP:\r\nphdr->phy = PHDR_802_11_PHY_11G;\r\nbreak;\r\ncase PHY_TYPE_HT:\r\nphdr->phy = PHDR_802_11_PHY_11N;\r\nbreak;\r\ncase PHY_TYPE_VHT:\r\nphdr->phy = PHDR_802_11_PHY_11AC;\r\nbreak;\r\ndefault:\r\nphdr->phy = PHDR_802_11_PHY_UNKNOWN;\r\nbreak;\r\n}\r\nproto_tree_add_item(wlan_tree, hf_netmon_802_11_phy_type, tvb, offset, 4,\r\nENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nchannel = tvb_get_letohl(tvb, offset);\r\nif (channel < 1000) {\r\nif (channel == 0) {\r\nproto_tree_add_uint_format_value(wlan_tree, hf_netmon_802_11_channel,\r\ntvb, offset, 4, channel,\r\n"Unknown");\r\n} else {\r\nguint frequency;\r\nphdr->has_channel = TRUE;\r\nphdr->channel = channel;\r\nproto_tree_add_uint(wlan_tree, hf_netmon_802_11_channel,\r\ntvb, offset, 4, channel);\r\nswitch (phdr->phy) {\r\ncase PHDR_802_11_PHY_11B:\r\ncase PHDR_802_11_PHY_11G:\r\nfrequency = ieee80211_chan_to_mhz(channel, TRUE);\r\nbreak;\r\ncase PHDR_802_11_PHY_11A:\r\nfrequency = ieee80211_chan_to_mhz(channel, FALSE);\r\nbreak;\r\ndefault:\r\nfrequency = 0;\r\nbreak;\r\n}\r\nif (frequency != 0) {\r\nphdr->has_frequency = TRUE;\r\nphdr->frequency = frequency;\r\n}\r\n}\r\n} else {\r\nphdr->has_frequency = TRUE;\r\nphdr->frequency = channel;\r\nproto_tree_add_uint_format_value(wlan_tree, hf_netmon_802_11_frequency,\r\ntvb, offset, 4, channel,\r\n"%u Mhz", channel);\r\ncalc_channel = ieee80211_mhz_to_chan(channel);\r\nif (calc_channel != -1) {\r\nphdr->has_channel = TRUE;\r\nphdr->channel = calc_channel;\r\n}\r\n}\r\noffset += 4;\r\nrssi = tvb_get_letohl(tvb, offset);\r\nif (rssi == 0) {\r\nproto_tree_add_int_format_value(wlan_tree, hf_netmon_802_11_rssi,\r\ntvb, offset, 4, rssi,\r\n"Unknown");\r\n} else {\r\nphdr->has_signal_dbm = TRUE;\r\nphdr->signal_dbm = rssi;\r\nproto_tree_add_int_format_value(wlan_tree, hf_netmon_802_11_rssi,\r\ntvb, offset, 4, rssi,\r\n"%d dBm", rssi);\r\n}\r\noffset += 4;\r\nrate = tvb_get_guint8(tvb, offset);\r\nif (rate == 0) {\r\nproto_tree_add_uint_format_value(wlan_tree, hf_netmon_802_11_datarate,\r\ntvb, offset, 1, rate,\r\n"Unknown");\r\n} else {\r\nphdr->has_data_rate = TRUE;\r\nphdr->data_rate = rate;\r\nproto_tree_add_uint_format_value(wlan_tree, hf_netmon_802_11_datarate,\r\ntvb, offset, 1, rate,\r\n"%f Mb/s", rate*.5);\r\n}\r\noffset += 1;\r\n} else\r\noffset += 13;\r\nphdr->has_tsf_timestamp = TRUE;\r\nphdr->tsf_timestamp = tvb_get_letoh64(tvb, offset);\r\nproto_tree_add_item(wlan_tree, hf_netmon_802_11_timestamp, tvb, offset, 8,\r\nENC_LITTLE_ENDIAN);\r\nskip:\r\noffset = length;\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_dissector_with_data(ieee80211_radio_handle, next_tvb, pinfo, tree, phdr);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_netmon_802_11(void)\r\n{\r\nstatic const value_string phy_type[] = {\r\n{ PHY_TYPE_UNKNOWN, "Unknown" },\r\n{ PHY_TYPE_FHSS, "802.11 FHSS" },\r\n{ PHY_TYPE_DSSS, "802.11 DSSS" },\r\n{ PHY_TYPE_IR_BASEBAND, "802.11 IR" },\r\n{ PHY_TYPE_OFDM, "802.11a" },\r\n{ PHY_TYPE_HR_DSSS, "802.11b" },\r\n{ PHY_TYPE_ERP, "802.11g" },\r\n{ PHY_TYPE_HT, "802.11n" },\r\n{ PHY_TYPE_VHT, "802.11ac" },\r\n{ 0, NULL },\r\n};\r\nstatic hf_register_info hf[] = {\r\n{ &hf_netmon_802_11_version, { "Header revision", "netmon_802_11.version", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_length, { "Header length", "netmon_802_11.length", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_op_mode, { "Operation mode", "netmon_802_11.op_mode", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_op_mode_sta, { "Station mode", "netmon_802_11.op_mode.sta", FT_UINT32,\r\nBASE_HEX, NULL, OP_MODE_STA, NULL, HFILL } },\r\n{ &hf_netmon_802_11_op_mode_ap, { "AP mode", "netmon_802_11.op_mode.ap", FT_UINT32,\r\nBASE_HEX, NULL, OP_MODE_AP, NULL, HFILL } },\r\n{ &hf_netmon_802_11_op_mode_sta_ext, { "Extensible station mode", "netmon_802_11.op_mode.sta_ext", FT_UINT32,\r\nBASE_HEX, NULL, OP_MODE_STA_EXT, NULL, HFILL } },\r\n{ &hf_netmon_802_11_op_mode_mon, { "Monitor mode", "netmon_802_11.op_mode.on", FT_UINT32,\r\nBASE_HEX, NULL, OP_MODE_MON, NULL, HFILL } },\r\n#if 0\r\n{ &hf_netmon_802_11_flags, { "Flags", "netmon_802_11.flags", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL } },\r\n#endif\r\n{ &hf_netmon_802_11_phy_type, { "PHY type", "netmon_802_11.phy_type", FT_UINT32,\r\nBASE_DEC, VALS(phy_type), 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_channel, { "Channel", "netmon_802_11.channel", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_frequency, { "Center frequency", "netmon_802_11.frequency", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_rssi, { "RSSI", "netmon_802_11.rssi", FT_INT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_datarate, { "Data rate", "netmon_802_11.datarate", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_netmon_802_11_timestamp, { "Timestamp", "netmon_802_11.timestamp", FT_UINT64,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_netmon_802_11,\r\n&ett_netmon_802_11_op_mode\r\n};\r\nproto_netmon_802_11 = proto_register_protocol("NetMon 802.11 capture header",\r\n"NetMon 802.11",\r\n"netmon_802_11");\r\nproto_register_field_array(proto_netmon_802_11, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_netmon_802_11(void)\r\n{\r\ndissector_handle_t netmon_802_11_handle;\r\nieee80211_radio_handle = find_dissector_add_dependency("wlan_radio", proto_netmon_802_11);\r\nnetmon_802_11_handle = create_dissector_handle(dissect_netmon_802_11,\r\nproto_netmon_802_11);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_IEEE_802_11_NETMON, netmon_802_11_handle);\r\n}

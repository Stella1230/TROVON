static void\r\nstarteam_init(void)\r\n{\r\niPreviousFrameNumber = -1;\r\n}\r\nstatic int\r\ndissect_starteam(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ngint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "StarTeam");\r\nif(iPreviousFrameNumber != (gint) pinfo->num){\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n} else {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " | ");\r\n}\r\niPreviousFrameNumber = pinfo->num;\r\nif(tvb_captured_length(tvb) >= 16){\r\nguint32 iCommand = 0;\r\ngboolean bRequest = FALSE;\r\nif(tvb_get_ntohl(tvb, offset + 0) == STARTEAM_MAGIC){\r\nbRequest = FALSE;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Reply: %d bytes", tvb_reported_length(tvb));\r\n} else if(tvb_captured_length_remaining(tvb, offset) >= 28 && tvb_get_ntohl(tvb, offset + 20) == STARTEAM_MAGIC){\r\nbRequest = TRUE;\r\nif(tvb_captured_length_remaining(tvb, offset) >= 66){\r\niCommand = tvb_get_letohl(tvb, offset + 62);\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_ext(iCommand, &starteam_opcode_vals_ext, "Unknown (0x%02x)"));\r\n}\r\nif(tree){\r\nproto_tree *starteam_tree;\r\nproto_tree *starteamroot_tree;\r\nproto_item *ti;\r\nti = proto_tree_add_item(tree, proto_starteam, tvb, offset, -1, ENC_NA);\r\nif (bRequest) proto_item_append_text(ti, " (%s)",\r\nval_to_str_ext(iCommand, &starteam_opcode_vals_ext, "Unknown (0x%02x)"));\r\nstarteamroot_tree = proto_item_add_subtree(ti, ett_starteam);\r\nif(bRequest){\r\nif(tvb_reported_length_remaining(tvb, offset) >= 20){\r\nstarteam_tree = proto_tree_add_subtree(starteamroot_tree, tvb, offset, 20, ett_starteam_mdh, NULL, STARTEAM_TEXT_MDH);\r\nproto_tree_add_item(starteam_tree, hf_starteam_mdh_session_tag, tvb, offset + 0, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_mdh_ctimestamp, tvb, offset + 4, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_mdh_flags, tvb, offset + 8, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_mdh_keyid, tvb, offset + 12, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_mdh_reserved, tvb, offset + 16, 4, ENC_LITTLE_ENDIAN);\r\noffset += 20;\r\n}\r\n}\r\nif(tvb_reported_length_remaining(tvb, offset) >= 16){\r\nstarteam_tree = proto_tree_add_subtree(starteamroot_tree, tvb, offset, 16, ett_starteam_ph, NULL, STARTEAM_TEXT_PH);\r\nproto_tree_add_item(starteam_tree, hf_starteam_ph_signature, tvb, offset + 0, 4, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(starteam_tree, hf_starteam_ph_packet_size, tvb, offset + 4, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_ph_data_size, tvb, offset + 8, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_ph_data_flags, tvb, offset + 12, 4, ENC_LITTLE_ENDIAN);\r\noffset += 16;\r\nif(bRequest){\r\nif(tvb_reported_length_remaining(tvb, offset) >= 38){\r\nstarteam_tree = proto_tree_add_subtree(starteamroot_tree, tvb, offset, 38, ett_starteam_id, NULL, STARTEAM_TEXT_ID);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_revision_level, tvb, offset + 0, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_client, tvb, offset + 2, 16, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_connect, tvb, offset + 18, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_component, tvb, offset + 22, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_command, tvb, offset + 26, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_command_time, tvb, offset + 30, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(starteam_tree, hf_starteam_id_command_userid, tvb, offset + 34, 4, ENC_LITTLE_ENDIAN);\r\noffset += 38;\r\n}\r\n}\r\nif(tvb_reported_length_remaining(tvb, offset) > 0){\r\nstarteam_tree = proto_tree_add_subtree(starteamroot_tree, tvb, offset, -1, ett_starteam_data, NULL, STARTEAM_TEXT_DATA);\r\nproto_tree_add_item(starteam_tree, hf_starteam_data_data, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_starteam_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint32 iPDULength = 0;\r\nif(tvb_captured_length_remaining(tvb, offset) >= 8 && tvb_get_ntohl(tvb, offset + 0) == STARTEAM_MAGIC){\r\niPDULength = tvb_get_letohl(tvb, offset + 4) + 16;\r\n} else if(tvb_captured_length_remaining(tvb, offset) >= 28 && tvb_get_ntohl(tvb, offset + 20) == STARTEAM_MAGIC){\r\niPDULength = tvb_get_letohl(tvb, offset + 24) + 36;\r\n}\r\nreturn iPDULength;\r\n}\r\nstatic int\r\ndissect_starteam_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, starteam_desegment, 8, get_starteam_pdu_len, dissect_starteam, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_starteam_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nif(tvb_captured_length(tvb) >= 32){\r\ngint iOffsetLengths = -1;\r\nif(tvb_get_ntohl(tvb, 0) == STARTEAM_MAGIC){\r\niOffsetLengths = 4;\r\n} else if(tvb_get_ntohl(tvb, 20) == STARTEAM_MAGIC){\r\niOffsetLengths = 24;\r\n}\r\nif(iOffsetLengths != -1){\r\nguint32 iLengthPacket;\r\nguint32 iLengthData;\r\niLengthPacket = tvb_get_letohl(tvb, iOffsetLengths);\r\niLengthData = tvb_get_letohl(tvb, iOffsetLengths + 4);\r\nif(iLengthPacket == iLengthData){\r\nconversation_t *conversation = NULL;\r\nconversation = find_or_create_conversation(pinfo);\r\nconversation_set_dissector(conversation, starteam_tcp_handle);\r\ndissect_starteam(tvb, pinfo, tree, data);\r\nreturn TRUE;\r\n}\r\n}\r\n}\r\nreturn FALSE;\r\n}\r\nvoid\r\nproto_register_starteam(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_starteam_mdh_session_tag,\r\n{ "Session tag", "starteam.mdh.stag", FT_UINT32, BASE_DEC, NULL, 0x0, "MDH session tag", HFILL }},\r\n{ &hf_starteam_mdh_ctimestamp,\r\n{ "Client timestamp", "starteam.mdh.ctimestamp", FT_UINT32, BASE_DEC, NULL, 0x0, "MDH client timestamp", HFILL }},\r\n{ &hf_starteam_mdh_flags,\r\n{ "Flags", "starteam.mdh.flags", FT_UINT32, BASE_HEX, NULL, 0x0, "MDH flags", HFILL }},\r\n{ &hf_starteam_mdh_keyid,\r\n{ "Key ID", "starteam.mdh.keyid", FT_UINT32, BASE_HEX, NULL, 0x0, "MDH key ID", HFILL }},\r\n{ &hf_starteam_mdh_reserved,\r\n{ "Reserved", "starteam.mdh.reserved", FT_UINT32, BASE_HEX, NULL, 0x0, "MDH reserved", HFILL }},\r\n{ &hf_starteam_ph_signature,\r\n{ "Signature", "starteam.ph.signature", FT_STRINGZ, BASE_NONE, NULL, 0x0, "PH signature", HFILL }},\r\n{ &hf_starteam_ph_packet_size,\r\n{ "Packet size", "starteam.ph.psize", FT_UINT32, BASE_DEC, NULL, 0x0, "PH packet size", HFILL }},\r\n{ &hf_starteam_ph_data_size,\r\n{ "Data size", "starteam.ph.dsize", FT_UINT32, BASE_DEC, NULL, 0x0, "PH data size", HFILL }},\r\n{ &hf_starteam_ph_data_flags,\r\n{ "Flags", "starteam.ph.flags", FT_UINT32, BASE_HEX, NULL, 0x0, "PH flags", HFILL }},\r\n{ &hf_starteam_id_revision_level,\r\n{ "Revision level", "starteam.id.level", FT_UINT16, BASE_DEC, NULL, 0x0, "ID revision level", HFILL }},\r\n{ &hf_starteam_id_client,\r\n{ "Client ID", "starteam.id.client", FT_STRINGZ, BASE_NONE, NULL, 0x0, "ID client ID", HFILL }},\r\n{ &hf_starteam_id_connect,\r\n{ "Connect ID", "starteam.id.connect", FT_UINT32, BASE_HEX, NULL, 0x0, "ID connect ID", HFILL }},\r\n{ &hf_starteam_id_component,\r\n{ "Component ID", "starteam.id.component", FT_UINT32, BASE_DEC, NULL, 0x0, "ID component ID", HFILL }},\r\n{ &hf_starteam_id_command,\r\n{ "Command ID", "starteam.id.command", FT_UINT32, BASE_DEC|BASE_EXT_STRING, &starteam_opcode_vals_ext, 0x0, "ID command ID", HFILL }},\r\n{ &hf_starteam_id_command_time,\r\n{ "Command time", "starteam.id.commandtime", FT_UINT32, BASE_HEX, NULL, 0x0, "ID command time", HFILL }},\r\n{ &hf_starteam_id_command_userid,\r\n{ "Command user ID", "starteam.id.commanduserid", FT_UINT32, BASE_HEX, NULL, 0x0, "ID command user ID", HFILL }},\r\n{ &hf_starteam_data_data,\r\n{ "Data", "starteam.data", FT_STRINGZ, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_starteam,\r\n&ett_starteam_mdh,\r\n&ett_starteam_ph,\r\n&ett_starteam_id,\r\n&ett_starteam_data\r\n};\r\nmodule_t *starteam_module;\r\nproto_starteam = proto_register_protocol("StarTeam", "StarTeam", "starteam");\r\nproto_register_field_array(proto_starteam, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nstarteam_module = prefs_register_protocol(proto_starteam, NULL);\r\nprefs_register_bool_preference(starteam_module, "desegment",\r\n"Reassemble StarTeam messages spanning multiple TCP segments",\r\n"Whether the StarTeam dissector should reassemble messages spanning multiple TCP segments."\r\n" To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&starteam_desegment);\r\nregister_init_routine(&starteam_init);\r\n}\r\nvoid\r\nproto_reg_handoff_starteam(void)\r\n{\r\nheur_dissector_add("tcp", dissect_starteam_heur, "StarTeam over TCP", "starteam_tcp", proto_starteam, HEURISTIC_ENABLE);\r\nstarteam_tcp_handle = create_dissector_handle(dissect_starteam_tcp, proto_starteam);\r\n}

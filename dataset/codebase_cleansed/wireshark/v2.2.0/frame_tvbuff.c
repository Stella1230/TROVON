static gboolean\r\nframe_read(struct tvb_frame *frame_tvb, struct wtap_pkthdr *phdr, Buffer *buf)\r\n{\r\nint err;\r\ngchar *err_info;\r\nif (cfile.wth != frame_tvb->wth)\r\nreturn FALSE;\r\nif (!wtap_seek_read(frame_tvb->wth, frame_tvb->file_off, phdr, buf, &err, &err_info)) {\r\nswitch (err) {\r\ncase WTAP_ERR_BAD_FILE:\r\ng_free(err_info);\r\nbreak;\r\n}\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic void\r\nframe_cache(struct tvb_frame *frame_tvb)\r\n{\r\nstruct wtap_pkthdr phdr;\r\nwtap_phdr_init(&phdr);\r\nif (frame_tvb->buf == NULL) {\r\nframe_tvb->buf = (struct Buffer *) g_malloc(sizeof(struct Buffer));\r\nws_buffer_init(frame_tvb->buf, frame_tvb->tvb.length + frame_tvb->offset);\r\nif (!frame_read(frame_tvb, &phdr, frame_tvb->buf))\r\n{ }\r\n}\r\nframe_tvb->tvb.real_data = ws_buffer_start_ptr(frame_tvb->buf) + frame_tvb->offset;\r\nwtap_phdr_cleanup(&phdr);\r\n}\r\nstatic void\r\nframe_free(tvbuff_t *tvb)\r\n{\r\nstruct tvb_frame *frame_tvb = (struct tvb_frame *) tvb;\r\nif (frame_tvb->buf) {\r\nws_buffer_free(frame_tvb->buf);\r\ng_free(frame_tvb->buf);\r\n}\r\n}\r\nstatic const guint8 *\r\nframe_get_ptr(tvbuff_t *tvb, guint abs_offset, guint abs_length _U_)\r\n{\r\nstruct tvb_frame *frame_tvb = (struct tvb_frame *) tvb;\r\nframe_cache(frame_tvb);\r\nreturn tvb->real_data + abs_offset;\r\n}\r\nstatic void *\r\nframe_memcpy(tvbuff_t *tvb, void *target, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_frame *frame_tvb = (struct tvb_frame *) tvb;\r\nframe_cache(frame_tvb);\r\nreturn memcpy(target, tvb->real_data + abs_offset, abs_length);\r\n}\r\nstatic gint\r\nframe_find_guint8(tvbuff_t *tvb, guint abs_offset, guint limit, guint8 needle)\r\n{\r\nstruct tvb_frame *frame_tvb = (struct tvb_frame *) tvb;\r\nconst guint8 *result;\r\nframe_cache(frame_tvb);\r\nresult = (const guint8 *)memchr(tvb->real_data + abs_offset, needle, limit);\r\nif (result)\r\nreturn (gint) (result - tvb->real_data);\r\nelse\r\nreturn -1;\r\n}\r\nstatic gint\r\nframe_pbrk_guint8(tvbuff_t *tvb, guint abs_offset, guint limit, const ws_mempbrk_pattern* pattern, guchar *found_needle)\r\n{\r\nstruct tvb_frame *frame_tvb = (struct tvb_frame *) tvb;\r\nframe_cache(frame_tvb);\r\nreturn tvb_ws_mempbrk_pattern_guint8(tvb, abs_offset, limit, pattern, found_needle);\r\n}\r\nstatic guint\r\nframe_offset(const tvbuff_t *tvb _U_, const guint counter)\r\n{\r\nreturn counter;\r\n}\r\ntvbuff_t *\r\nframe_tvbuff_new(const frame_data *fd, const guint8 *buf)\r\n{\r\nstruct tvb_frame *frame_tvb;\r\ntvbuff_t *tvb;\r\ntvb = tvb_new(&tvb_frame_ops);\r\ntvb->real_data = buf;\r\ntvb->length = fd->cap_len;\r\ntvb->reported_length = fd->pkt_len > G_MAXINT ? G_MAXINT : fd->pkt_len;\r\ntvb->initialized = TRUE;\r\ntvb->ds_tvb = tvb;\r\nframe_tvb = (struct tvb_frame *) tvb;\r\nif (cfile.wth && cfile.wth->random_fh\r\n#ifdef WANT_PACKET_EDITOR\r\n&& fd->file_off != -1\r\n#endif\r\n) {\r\nframe_tvb->wth = cfile.wth;\r\nframe_tvb->file_off = fd->file_off;\r\nframe_tvb->offset = 0;\r\n} else\r\nframe_tvb->wth = NULL;\r\nframe_tvb->buf = NULL;\r\nreturn tvb;\r\n}\r\ntvbuff_t *\r\nframe_tvbuff_new_buffer(const frame_data *fd, Buffer *buf)\r\n{\r\nreturn frame_tvbuff_new(fd, ws_buffer_start_ptr(buf));\r\n}\r\nstatic tvbuff_t *\r\nframe_clone(tvbuff_t *tvb, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_frame *frame_tvb = (struct tvb_frame *) tvb;\r\ntvbuff_t *cloned_tvb;\r\nstruct tvb_frame *cloned_frame_tvb;\r\nif (!frame_tvb->wth)\r\nreturn NULL;\r\nabs_offset += frame_tvb->offset;\r\ncloned_tvb = tvb_new(&tvb_frame_ops);\r\ncloned_tvb->real_data = NULL;\r\ncloned_tvb->length = abs_length;\r\ncloned_tvb->reported_length = abs_length;\r\ncloned_tvb->initialized = TRUE;\r\ncloned_tvb->ds_tvb = cloned_tvb;\r\ncloned_frame_tvb = (struct tvb_frame *) cloned_tvb;\r\ncloned_frame_tvb->wth = frame_tvb->wth;\r\ncloned_frame_tvb->file_off = frame_tvb->file_off;\r\ncloned_frame_tvb->offset = abs_offset;\r\ncloned_frame_tvb->buf = NULL;\r\nreturn cloned_tvb;\r\n}\r\ntvbuff_t *\r\nfile_tvbuff_new(const frame_data *fd, const guint8 *buf)\r\n{\r\nstruct tvb_frame *frame_tvb;\r\ntvbuff_t *tvb;\r\ntvb = tvb_new(&tvb_frame_ops);\r\ntvb->real_data = buf;\r\ntvb->length = fd->cap_len;\r\ntvb->reported_length = fd->pkt_len > G_MAXINT ? G_MAXINT : fd->pkt_len;\r\ntvb->initialized = TRUE;\r\ntvb->ds_tvb = tvb;\r\nframe_tvb = (struct tvb_frame *) tvb;\r\nif (cfile.wth && cfile.wth->random_fh\r\n#ifdef WANT_PACKET_EDITOR\r\n&& fd->file_off != -1\r\n#endif\r\n) {\r\nframe_tvb->wth = cfile.wth;\r\nframe_tvb->file_off = fd->file_off;\r\nframe_tvb->offset = 0;\r\n} else\r\nframe_tvb->wth = NULL;\r\nframe_tvb->buf = NULL;\r\nreturn tvb;\r\n}\r\ntvbuff_t *\r\nfile_tvbuff_new_buffer(const frame_data *fd, Buffer *buf)\r\n{\r\nreturn frame_tvbuff_new(fd, ws_buffer_start_ptr(buf));\r\n}

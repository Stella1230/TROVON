static int dissect_pw_hdlc_nocw_fr( tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree, void* data _U_ )\r\n{\r\nreturn call_dissector( fr_handle, tvb, pinfo, tree );\r\n}\r\nstatic int dissect_pw_hdlc_nocw_hdlc_ppp( tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree, void* data _U_ )\r\n{\r\nif (tvb_reported_length_remaining(tvb, 0) < 2)\r\n{\r\nreturn 0;\r\n}\r\nif (tree)\r\n{\r\nproto_tree *tr;\r\nproto_item *item;\r\nproto_item *item_address;\r\nproto_item *item_control;\r\nguint8 addr;\r\nguint8 control;\r\naddr = tvb_get_guint8(tvb, 0);\r\ncontrol = tvb_get_guint8(tvb, 1);\r\nitem = proto_tree_add_item( tree, proto_pw_hdlc_nocw_hdlc_ppp, tvb, 0, 2, ENC_NA );\r\ntr = proto_item_add_subtree( item, ett_pw_hdlc );\r\nitem_address = proto_tree_add_item( tr, hf_pw_hdlc_address_field, tvb, 0, 1, ENC_BIG_ENDIAN );\r\nitem_control = proto_tree_add_item( tr, hf_pw_hdlc_control_field, tvb, 1, 1, ENC_BIG_ENDIAN );\r\ntr = proto_item_add_subtree( item_address, ett_pw_hdlc );\r\nif ( 0x3F == (( addr & 0xFC ) >> 2 ))\r\nproto_tree_add_uint_format_value( tr, hf_pw_hdlc_address, tvb, 0, 1, 0xFC, "0x%x (All stations)", 0x3F );\r\nelse\r\nproto_tree_add_uint( tr, hf_pw_hdlc_address, tvb, 0, 1, ( addr & 0xFC ) >> 2 );\r\nproto_tree_add_uint( tr, hf_pw_hdlc_cr_bit, tvb, 0, 1, ( addr & 2 ) >> 1 );\r\ntr = proto_item_add_subtree( item_control, ett_pw_hdlc );\r\nif ( control & 1 )\r\n{\r\nif ( control & 2 )\r\n{\r\nproto_tree_add_uint_format( tr, hf_pw_hdlc_frame, tvb, 1, 1, control, "U frame" );\r\nproto_tree_add_uint( tr, hf_pw_hdlc_pf_bit, tvb, 1, 1, ( control & 0x10 ) >> 4 );\r\nproto_tree_add_uint( tr, hf_pw_hdlc_modifier, tvb, 1, 1, (control & 0xEC) >> 2);\r\n}\r\nelse\r\n{\r\nproto_tree_add_uint_format( tr, hf_pw_hdlc_frame, tvb, 1, 1, control, "S frame" );\r\n}\r\n}\r\nelse\r\n{\r\nproto_tree_add_uint_format( tr, hf_pw_hdlc_frame, tvb, 1, 1, control, "I frame" );\r\n}\r\n}\r\ncall_dissector( ppp_handle, tvb_new_subset_remaining(tvb, 2), pinfo, tree );\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_pw_hdlc(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n#if 0\r\n{\r\n&hf_pw_hdlc,\r\n{\r\n"PW HDLC", "pw_hdlc", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n#endif\r\n{\r\n&hf_pw_hdlc_address_field,\r\n{\r\n"Address field", "pw_hdlc.address_field",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_pw_hdlc_address,\r\n{\r\n"Address", "pw_hdlc.address",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_pw_hdlc_cr_bit,\r\n{\r\n"C/R bit", "pw_hdlc.cr_bit",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_pw_hdlc_control_field,\r\n{\r\n"Control field", "pw_hdlc.control_field",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_pw_hdlc_pf_bit,\r\n{\r\n"Poll/Final bit", "pw_hdlc.pf_bit",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_pw_hdlc_modifier,\r\n{\r\n"Modifier", "pw_hdlc.modifier",\r\nFT_UINT8, BASE_HEX, VALS(pw_hdlc_modifier_vals), 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_pw_hdlc_frame,\r\n{\r\n"Frame type", "pw_hdlc.frame",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_pw_hdlc\r\n};\r\nproto_pw_hdlc_nocw_fr = proto_register_protocol("HDLC PW, FR port mode (no CW)",\r\n"HDLC PW, FR port mode (no CW)",\r\n"pw_hdlc_nocw_fr" );\r\nproto_pw_hdlc_nocw_hdlc_ppp = proto_register_protocol("HDLC-like framing for PPP",\r\n"HDLC PW with PPP payload (no CW)",\r\n"pw_hdlc_nocw_hdlc_ppp" );\r\nproto_register_field_array(proto_pw_hdlc_nocw_fr, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_pw_hdlc(void)\r\n{\r\ndissector_handle_t pw_fr_handle, pw_ppp_handle;\r\npw_fr_handle = create_dissector_handle( dissect_pw_hdlc_nocw_fr, proto_pw_hdlc_nocw_fr );\r\ndissector_add_for_decode_as( "mpls.label", pw_fr_handle );\r\npw_ppp_handle = create_dissector_handle( dissect_pw_hdlc_nocw_hdlc_ppp, proto_pw_hdlc_nocw_hdlc_ppp );\r\ndissector_add_for_decode_as( "mpls.label", pw_ppp_handle );\r\nppp_handle = find_dissector_add_dependency( "ppp", proto_pw_hdlc_nocw_hdlc_ppp );\r\nfr_handle = find_dissector_add_dependency( "fr", proto_pw_hdlc_nocw_fr );\r\n}

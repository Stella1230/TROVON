static void\r\ndissect_applemidi_common( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint16 command ) {\r\nproto_item *ti;\r\nguint16 seq_num;\r\nguint8 count;\r\nguint8 *name;\r\ngint offset = 0;\r\ngint len;\r\ngint string_size;\r\nproto_tree *applemidi_tree;\r\nproto_tree *applemidi_tree_seq_num;\r\ncol_set_str( pinfo->cinfo, COL_PROTOCOL, APPLEMIDI_DISSECTOR_SHORTNAME );\r\ncol_add_fstr( pinfo->cinfo, COL_INFO, "%s", val_to_str( command, applemidi_commands, applemidi_unknown_command ) );\r\nti = proto_tree_add_item( tree, proto_applemidi, tvb, 0, -1, ENC_NA );\r\napplemidi_tree = proto_item_add_subtree( ti, ett_applemidi );\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_signature, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset += 2;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_command, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset += 2;\r\nif ( ( APPLEMIDI_COMMAND_INVITATION == command ) ||\r\n( APPLEMIDI_COMMAND_INVITATION_REJECTED == command ) ||\r\n( APLLEMIDI_COMMAND_INVITATION_ACCEPTED == command ) ||\r\n( APPLEMIDI_COMMAND_ENDSESSION == command ) ) {\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_protocol_version, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_token, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_ssrc, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\nlen = tvb_reported_length(tvb) - offset;\r\nif ( len > 0 ) {\r\nname = tvb_get_string_enc( wmem_packet_scope(), tvb, offset, len, ENC_UTF_8|ENC_NA );\r\nstring_size = (gint)( strlen( name ) + 1 );\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_name, tvb, offset, string_size, ENC_UTF_8|ENC_NA );\r\ncol_append_fstr( pinfo->cinfo, COL_INFO, ": peer = \"%s\"", name );\r\noffset += string_size;\r\n}\r\n} else if ( APPLEMIDI_COMMAND_SYNCHRONIZATION == command ) {\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_ssrc, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\ncount = tvb_get_guint8( tvb, offset );\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_count, tvb, offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr( pinfo->cinfo, COL_INFO, ": count = %u", count );\r\noffset += 1;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_padding, tvb, offset, 3, ENC_BIG_ENDIAN );\r\noffset += 3;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_timestamp1, tvb, offset, 8, ENC_BIG_ENDIAN );\r\noffset += 8;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_timestamp2, tvb, offset, 8, ENC_BIG_ENDIAN );\r\noffset += 8;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_timestamp3, tvb, offset, 8, ENC_BIG_ENDIAN );\r\noffset += 8;\r\n} else if ( APPLEMIDI_COMMAND_RECEIVER_FEEDBACK == command ) {\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_ssrc, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\nti = proto_tree_add_item( applemidi_tree, hf_applemidi_sequence_num, tvb, offset, 4, ENC_BIG_ENDIAN );\r\napplemidi_tree_seq_num = proto_item_add_subtree( ti, ett_applemidi_seq_num );\r\nseq_num = tvb_get_ntohs( tvb, offset );\r\nproto_tree_add_uint( applemidi_tree_seq_num, hf_applemidi_rtp_sequence_num, tvb, offset, 2, seq_num );\r\noffset += 4;\r\ncol_append_fstr( pinfo->cinfo, COL_INFO, ": seq = %u", seq_num );\r\n} else if ( APPLEMIDI_COMMAND_BITRATE_RECEIVE_LIMIT == command ) {\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_ssrc, tvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_rtp_bitrate_limit,\r\ntvb, offset, 4, ENC_BIG_ENDIAN );\r\noffset += 4;\r\n}\r\nlen = tvb_reported_length_remaining( tvb, offset );\r\nif ( len > 0 ) {\r\nproto_tree_add_item( applemidi_tree, hf_applemidi_unknown_data, tvb, offset, len, ENC_NA );\r\n}\r\n}\r\nstatic gboolean\r\ntest_applemidi(tvbuff_t *tvb, guint16 *command_p, gboolean conversation_established ) {\r\n*command_p = 0xffff;\r\nif ( APPLEMIDI_PROTOCOL_SIGNATURE != tvb_get_ntohs( tvb, 0 ) )\r\nreturn FALSE;\r\n*command_p = tvb_get_ntohs( tvb, 2 );\r\nif ( conversation_established ) {\r\nreturn TRUE;\r\n}\r\nif ( ( APPLEMIDI_COMMAND_INVITATION == *command_p ) ||\r\n( APPLEMIDI_COMMAND_INVITATION_REJECTED == *command_p ) ||\r\n( APLLEMIDI_COMMAND_INVITATION_ACCEPTED == *command_p ) ||\r\n( APPLEMIDI_COMMAND_ENDSESSION == *command_p ) ||\r\n( APPLEMIDI_COMMAND_SYNCHRONIZATION == *command_p ) ||\r\n( APPLEMIDI_COMMAND_RECEIVER_FEEDBACK == *command_p ) ||\r\n( APPLEMIDI_COMMAND_BITRATE_RECEIVE_LIMIT == *command_p ) )\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\nstatic int\r\ndissect_applemidi( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_ ) {\r\nguint16 command;\r\nif ( test_applemidi( tvb, &command, TRUE ) )\r\ndissect_applemidi_common( tvb, pinfo, tree, command );\r\nelse\r\ncall_dissector( rtp_handle, tvb, pinfo, tree );\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_applemidi_heur( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_ ) {\r\nguint16 command;\r\nconversation_t *p_conv;\r\nrtp_dyn_payload_t *rtp_dyn_payload;\r\nif ( tvb_captured_length( tvb ) < 4)\r\nreturn FALSE;\r\nif ( !test_applemidi( tvb, &command, FALSE ) ) {\r\nreturn FALSE;\r\n}\r\nrtp_dyn_payload = rtp_dyn_payload_new();\r\nrtp_dyn_payload_insert(rtp_dyn_payload, 97, "rtp-midi", 10000);\r\nrtp_add_address( pinfo, &pinfo->src, pinfo->srcport, 0, APPLEMIDI_DISSECTOR_SHORTNAME,\r\npinfo->num, FALSE, rtp_dyn_payload);\r\np_conv = find_or_create_conversation(pinfo);\r\nconversation_set_dissector( p_conv, applemidi_handle );\r\ndissect_applemidi_common( tvb, pinfo, tree, command );\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_applemidi( void )\r\n{\r\nstatic hf_register_info hf[] = {\r\n{\r\n&hf_applemidi_signature,\r\n{\r\n"Signature",\r\n"applemidi.signature",\r\nFT_UINT16,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_command,\r\n{\r\n"Command",\r\n"applemidi.command",\r\nFT_UINT16,\r\nBASE_HEX,\r\nVALS( applemidi_commands ),\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_protocol_version,\r\n{\r\n"Protocol Version",\r\n"applemidi.protocol_version",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_token,\r\n{\r\n"Initiator Token",\r\n"applemidi.initiator_token",\r\nFT_UINT32,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_ssrc,\r\n{\r\n"Sender SSRC",\r\n"applemidi.sender_ssrc",\r\nFT_UINT32,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_name,\r\n{\r\n"Name",\r\n"applemidi.name",\r\nFT_STRING,\r\nBASE_NONE,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_count,\r\n{\r\n"Count",\r\n"applemidi.count",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_padding,\r\n{\r\n"Padding",\r\n"applemidi.padding",\r\nFT_UINT24,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_timestamp1,\r\n{\r\n"Timestamp 1",\r\n"applemidi.timestamp1",\r\nFT_UINT64,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_timestamp2,\r\n{\r\n"Timestamp 2",\r\n"applemidi.timestamp2",\r\nFT_UINT64,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_timestamp3,\r\n{\r\n"Timestamp 3",\r\n"applemidi.timestamp3",\r\nFT_UINT64,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_sequence_num,\r\n{\r\n"Sequence Number",\r\n"applemidi.sequence_number",\r\nFT_UINT32,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_rtp_sequence_num,\r\n{\r\n"RTP Sequence Number",\r\n"applemidi.rtp_sequence_number",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_rtp_bitrate_limit,\r\n{\r\n"Bitrate limit",\r\n"applemidi.bitrate_limit",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_applemidi_unknown_data,\r\n{\r\n"Unknown Data",\r\n"applemidi.unknown_data",\r\nFT_BYTES,\r\nBASE_NONE,\r\nNULL,\r\n0x00,\r\nNULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_applemidi,\r\n&ett_applemidi_seq_num\r\n};\r\nproto_applemidi = proto_register_protocol( APPLEMIDI_DISSECTOR_NAME,\r\nAPPLEMIDI_DISSECTOR_SHORTNAME,\r\nAPPLEMIDI_DISSECTOR_ABBREVIATION );\r\nproto_register_field_array( proto_applemidi, hf, array_length( hf ) );\r\nproto_register_subtree_array( ett, array_length( ett ) );\r\n}\r\nvoid\r\nproto_reg_handoff_applemidi( void ) {\r\napplemidi_handle = create_dissector_handle( dissect_applemidi, proto_applemidi );\r\nrtp_handle = find_dissector_add_dependency( "rtp", proto_applemidi );\r\nheur_dissector_add( "udp", dissect_applemidi_heur, "Apple MIDI over UDP", "applemidi_udp", proto_applemidi, HEURISTIC_ENABLE );\r\n}

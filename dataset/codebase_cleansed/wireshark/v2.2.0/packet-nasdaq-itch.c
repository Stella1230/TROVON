static int\r\norder_ref_number(tvbuff_t *tvb, packet_info *pinfo, proto_tree *nasdaq_itch_tree, int offset)\r\n{\r\nconst char *str_value = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 9, ENC_ASCII);\r\nguint32 value = (guint32)strtoul(str_value, NULL, 10);\r\nproto_tree_add_uint(nasdaq_itch_tree, hf_nasdaq_itch_order_reference, tvb, offset, 9, value);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%u ", value);\r\nreturn offset + 9;\r\n}\r\nstatic int\r\ntime_stamp(tvbuff_t *tvb, proto_tree *nasdaq_itch_tree, int id, int offset, int size)\r\n{\r\nif (nasdaq_itch_tree) {\r\nguint32 ms, val;\r\nconst char *display = "";\r\nconst char *str_value = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, size, ENC_ASCII);\r\nms = val = (guint32)strtoul(str_value, NULL, 10);\r\nswitch (size) {\r\ncase 3:\r\ndisplay = wmem_strdup_printf(wmem_packet_scope(), " %03u" , val);\r\nbreak;\r\ncase 5:\r\nms = val *1000;\r\ncase 8:\r\ndisplay = wmem_strdup_printf(wmem_packet_scope(), " %u (%02u:%02u:%02u.%03u)", val,\r\nms/3600000, (ms % 3600000)/60000, (ms % 60000)/1000, ms %1000);\r\nbreak;\r\n}\r\nproto_tree_add_uint_format_value(nasdaq_itch_tree, id, tvb, offset, size, val, "%s", display);\r\n}\r\nreturn offset + size;\r\n}\r\nstatic int\r\nnumber_of_shares(tvbuff_t *tvb, packet_info *pinfo, proto_tree *nasdaq_itch_tree, int id, int offset, int big)\r\n{\r\ngint size = (big) ? 10 : 6;\r\nconst char *str_value = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, size, ENC_ASCII);\r\nguint32 value = (guint32)strtoul(str_value, NULL, 10);\r\nproto_tree_add_uint(nasdaq_itch_tree, id, tvb, offset, size, value);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "qty %u ", value);\r\nreturn offset + size;\r\n}\r\nstatic int\r\nprice(tvbuff_t *tvb, packet_info *pinfo, proto_tree *nasdaq_itch_tree, int id, int offset, int big)\r\n{\r\ngint size = (big) ? 19 : 10;\r\nconst char *str_value = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, size, ENC_ASCII);\r\ngdouble value = guint64_to_gdouble(g_ascii_strtoull(str_value, NULL, 10))/((big)?1000000.0:10000.0);\r\nproto_tree_add_double(nasdaq_itch_tree, id, tvb, offset, size, value);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "price %g ", value);\r\nreturn offset + size;\r\n}\r\nstatic int\r\nstock(tvbuff_t *tvb, packet_info *pinfo, proto_tree *nasdaq_itch_tree, int offset)\r\n{\r\nchar *stock_p = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, 6, ENC_ASCII);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_stock, tvb, offset, 6, ENC_ASCII|ENC_NA);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "<%s> ", stock_p);\r\nreturn offset + 6;\r\n}\r\nstatic int\r\norder(tvbuff_t *tvb, packet_info *pinfo, proto_tree *nasdaq_itch_tree, int offset, int big)\r\n{\r\nguint8 value;\r\noffset = order_ref_number(tvb, pinfo, nasdaq_itch_tree, offset);\r\nvalue = tvb_get_guint8(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%c ", value);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_buy_sell, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\noffset += 1;\r\noffset = number_of_shares(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_shares, offset, big);\r\noffset = stock(tvb, pinfo, nasdaq_itch_tree, offset);\r\noffset = price(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_price, offset, big);\r\nreturn offset;\r\n}\r\nstatic int\r\nexecuted(tvbuff_t *tvb, packet_info *pinfo, proto_tree *nasdaq_itch_tree, int offset, int big)\r\n{\r\noffset = order_ref_number(tvb, pinfo, nasdaq_itch_tree, offset);\r\noffset = number_of_shares(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_executed, offset, big);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_match, tvb, offset, 9, ENC_ASCII|ENC_NA);\r\noffset += 9;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_nasdaq_itch(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *nasdaq_itch_tree = NULL;\r\nguint8 nasdaq_itch_type;\r\nint offset = 0;\r\nint version = 3;\r\nint big = 0;\r\nconst gchar *rep;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Nasdaq-ITCH");\r\nnasdaq_itch_type = tvb_get_guint8(tvb, offset);\r\nif (nasdaq_itch_type >= '0' && nasdaq_itch_type <= '9') {\r\nversion = 2;\r\nnasdaq_itch_type = tvb_get_guint8(tvb, offset +8);\r\n}\r\nif ((!nasdaq_itch_chi_x || version == 3) && strchr(chix_msg, nasdaq_itch_type)) {\r\nnasdaq_itch_type = 0;\r\n}\r\nrep = val_to_str(nasdaq_itch_type, message_types_val, "Unknown packet type (0x%02x) ");\r\ncol_add_str(pinfo->cinfo, COL_INFO, rep);\r\nif (tree) {\r\nproto_item *item;\r\nti = proto_tree_add_protocol_format(tree, proto_nasdaq_itch, tvb, offset, -1, "Nasdaq TotalView-ITCH %s, %s",\r\nversion == 2?"2.0":"3.0", rep);\r\nnasdaq_itch_tree = proto_item_add_subtree(ti, ett_nasdaq_itch);\r\nitem = proto_tree_add_uint(nasdaq_itch_tree, hf_nasdaq_itch_version, tvb, 0, 0, version);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\nif (version == 2) {\r\noffset = time_stamp (tvb, nasdaq_itch_tree, hf_nasdaq_itch_millisecond, offset, 8);\r\n}\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_message_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nif (version == 3) {\r\nswitch (nasdaq_itch_type) {\r\ncase 'T':\r\ntime_stamp (tvb, nasdaq_itch_tree, hf_nasdaq_itch_second, offset, 5);\r\nreturn tvb_captured_length(tvb);\r\ncase 'M':\r\ntime_stamp (tvb, nasdaq_itch_tree, hf_nasdaq_itch_millisecond, offset, 3);\r\nreturn tvb_captured_length(tvb);\r\n}\r\n}\r\nswitch (nasdaq_itch_type) {\r\ncase 'S':\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_system_event, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 'R':\r\noffset = stock(tvb, pinfo, nasdaq_itch_tree, offset);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_market_category, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_financial_status, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_round_lot_size, tvb, offset, 6, ENC_ASCII|ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_round_lots_only, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 'H':\r\noffset = stock(tvb, pinfo, nasdaq_itch_tree, offset);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_trading_state, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_reserved, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_reason, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 'a' :\r\nbig = 1;\r\ncase 'A':\r\noffset = order(tvb, pinfo, nasdaq_itch_tree, offset, big);\r\nif (version == 2) {\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_printable, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase 'F':\r\noffset = order(tvb, pinfo, nasdaq_itch_tree, offset, big);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_attribution, tvb, offset, 4, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 'e' :\r\nbig = 1;\r\ncase 'E' :\r\nexecuted(tvb, pinfo, nasdaq_itch_tree, offset, big);\r\nbreak;\r\ncase 'C' :\r\noffset = executed(tvb, pinfo, nasdaq_itch_tree, offset, big);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_printable, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\noffset += 1;\r\nprice(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_execution_price, offset, big);\r\nbreak;\r\ncase 'x' :\r\nbig = 1;\r\ncase 'X' :\r\noffset = order_ref_number(tvb, pinfo, nasdaq_itch_tree, offset);\r\nnumber_of_shares(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_canceled, offset, big);\r\nbreak;\r\ncase 'D' :\r\norder_ref_number(tvb, pinfo, nasdaq_itch_tree, offset);\r\nbreak;\r\ncase 'p' :\r\nbig = 1;\r\ncase 'P' :\r\noffset = order(tvb, pinfo, nasdaq_itch_tree, offset, big);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_match, tvb, offset, 9, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 'Q' :\r\noffset = number_of_shares(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_shares, offset, big);\r\noffset = stock(tvb, pinfo, nasdaq_itch_tree, offset);\r\noffset = price(tvb, pinfo, nasdaq_itch_tree, hf_nasdaq_itch_price, offset, big);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_match, tvb, offset, 9, ENC_ASCII|ENC_NA);\r\noffset += 9;\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_cross, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 'B' :\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_match, tvb, offset, 9, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 'I':\r\noffset = stock(tvb, pinfo, nasdaq_itch_tree, offset);\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_cross, tvb, offset, 1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(nasdaq_itch_tree, hf_nasdaq_itch_message, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_nasdaq_itch(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_nasdaq_itch_version,\r\n{ "Version", "nasdaq-itch.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_message_type,\r\n{ "Message Type", "nasdaq-itch.message_type",\r\nFT_UINT8, BASE_DEC, VALS(message_types_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_second,\r\n{ "Second", "nasdaq-itch.second",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_millisecond,\r\n{ "Millisecond", "nasdaq-itch.millisecond",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_system_event,\r\n{ "System Event", "nasdaq-itch.system_event",\r\nFT_UINT8, BASE_DEC, VALS(system_event_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_market_category,\r\n{ "Market Category", "nasdaq-itch.market_category",\r\nFT_UINT8, BASE_DEC, VALS(market_category_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_financial_status,\r\n{ "Financial Status Indicator", "nasdaq-itch.financial_status",\r\nFT_UINT8, BASE_DEC, VALS(financial_status_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_stock,\r\n{ "Stock", "nasdaq-itch.stock",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_round_lot_size,\r\n{ "Round Lot Size", "nasdaq-itch.round_lot_size",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_round_lots_only,\r\n{ "Round Lots Only", "nasdaq-itch.round_lots_only",\r\nFT_UINT8, BASE_DEC, VALS(round_lots_only_val), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_trading_state,\r\n{ "Trading State", "nasdaq-itch.trading_state",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_reserved,\r\n{ "Reserved", "nasdaq-itch.reserved",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_reason,\r\n{ "Reason", "nasdaq-itch.reason",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_order_reference,\r\n{ "Order Reference", "nasdaq-itch.order_reference",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Order reference number", HFILL }},\r\n{ &hf_nasdaq_itch_buy_sell,\r\n{ "Buy/Sell", "nasdaq-itch.buy_sell",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Buy/Sell indicator", HFILL }},\r\n{ &hf_nasdaq_itch_shares,\r\n{ "Shares", "nasdaq-itch.shares",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Number of shares", HFILL }},\r\n{ &hf_nasdaq_itch_price,\r\n{ "Price", "nasdaq-itch.price",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_attribution,\r\n{ "Attribution", "nasdaq-itch.attribution",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Market participant identifier", HFILL }},\r\n{ &hf_nasdaq_itch_executed,\r\n{ "Executed Shares", "nasdaq-itch.executed",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Number of shares executed", HFILL }},\r\n{ &hf_nasdaq_itch_match,\r\n{ "Matched", "nasdaq-itch.match",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Match number", HFILL }},\r\n{ &hf_nasdaq_itch_printable,\r\n{ "Printable", "nasdaq-itch.printable",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_execution_price,\r\n{ "Execution Price", "nasdaq-itch.execution_price",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_nasdaq_itch_canceled,\r\n{ "Canceled Shares", "nasdaq-itch.canceled",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Number of shares to be removed", HFILL }},\r\n{ &hf_nasdaq_itch_cross,\r\n{ "Cross Type", "nasdaq-itch.cross",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"Cross trade type", HFILL }},\r\n{ &hf_nasdaq_itch_message,\r\n{ "Message", "nasdaq-itch.message",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_nasdaq_itch\r\n};\r\nmodule_t *nasdaq_itch_module;\r\nproto_nasdaq_itch = proto_register_protocol("Nasdaq TotalView-ITCH", "NASDAQ-ITCH", "nasdaq_itch");\r\nproto_register_field_array(proto_nasdaq_itch, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nnasdaq_itch_module = prefs_register_protocol(proto_nasdaq_itch, NULL);\r\nprefs_register_bool_preference(nasdaq_itch_module, "chi_x", "Decode Chi X extensions",\r\n"Whether the Nasdaq ITCH dissector should decode Chi X extensions.",\r\n&nasdaq_itch_chi_x);\r\nnasdaq_itch_handle = register_dissector("nasdaq-itch", dissect_nasdaq_itch, proto_nasdaq_itch);\r\n}\r\nvoid\r\nproto_reg_handoff_nasdaq_itch(void)\r\n{\r\ndissector_add_for_decode_as("moldudp64.payload", nasdaq_itch_handle );\r\n}

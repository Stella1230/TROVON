static int\r\ndissect_netfilter_queue(tvbuff_t *tvb _U_, netlink_netfilter_info_t *info, proto_tree *tree, int offset)\r\n{\r\nenum ws_nfqnl_msg_types type = (enum ws_nfqnl_msg_types) (info->data->type & 0xff);\r\nproto_tree_add_uint(tree, &hfi_netlink_netfilter_queue_type, NULL, 0, 0, info->data->type);\r\nswitch (type) {\r\ndefault:\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_netfilter_ulog(tvbuff_t *tvb, netlink_netfilter_info_t *info, proto_tree *tree, int offset)\r\n{\r\nenum ws_nfulnl_msg_types type = (enum ws_nfulnl_msg_types) (info->data->type & 0xff);\r\nproto_tree_add_uint(tree, &hfi_netlink_netfilter_ulog_type, NULL, 0, 0, info->data->type);\r\nswitch (type) {\r\ncase WS_NFULNL_MSG_PACKET:\r\ncall_dissector(nflog_handle, tvb, info->pinfo, tree);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_netlink_netfilter(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *_data)\r\n{\r\nstruct packet_netlink_data *data = NULL;\r\nnetlink_netfilter_info_t info;\r\nint offset;\r\nif (_data) {\r\nif (((struct packet_netlink_data *) _data)->magic == PACKET_NETLINK_MAGIC)\r\ndata = (struct packet_netlink_data *) _data;\r\n}\r\nDISSECTOR_ASSERT(data);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Netlink netfilter");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item_set_text(tree, "Linux netlink netfilter message");\r\nproto_tree_add_uint(tree, &hfi_netlink_netfilter_subsys, NULL, 0, 0, data->type);\r\n}\r\ninfo.encoding = data->encoding;\r\ninfo.pinfo = pinfo;\r\ninfo.data = data;\r\noffset = 0;\r\nswitch (data->type >> 8) {\r\ncase WS_NFNL_SUBSYS_QUEUE:\r\noffset = dissect_netfilter_queue(tvb, &info, tree, offset);\r\nbreak;\r\ncase WS_NFNL_SUBSYS_ULOG:\r\noffset = dissect_netfilter_ulog(tvb, &info, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_netlink_netfilter(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_netlink_netfilter_subsys,\r\n&hfi_netlink_netfilter_queue_type,\r\n&hfi_netlink_netfilter_ulog_type,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_netlink_netfilter,\r\n};\r\nint proto_netlink_netfilter;\r\nproto_netlink_netfilter = proto_register_protocol("Linux netlink netfilter protocol", "netfilter", "netlink-netfilter" );\r\nhfi_netlink_netfilter = proto_registrar_get_nth(proto_netlink_netfilter);\r\nproto_register_fields(proto_netlink_netfilter, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nnetlink_netfilter = create_dissector_handle(dissect_netlink_netfilter, proto_netlink_netfilter);\r\n}\r\nvoid\r\nproto_reg_handoff_netlink_netfilter(void)\r\n{\r\ndissector_add_uint("netlink.protocol", WS_NETLINK_NETFILTER, netlink_netfilter);\r\nnflog_handle = find_dissector_add_dependency("nflog", hfi_netlink_netfilter->id);\r\n}

static int\r\nget_sdh_level(tvbuff_t *tvb, packet_info *pinfo)\r\n{\r\nguint64 *hdr = NULL;\r\nif(sdh_data_rate != -1) return sdh_data_rate;\r\nhdr = erf_get_ehdr(pinfo, EXT_HDR_TYPE_RAW_LINK, NULL);\r\nif (hdr != NULL){\r\nswitch((*hdr & 0xff00) >> 8){\r\ncase 1:\r\nreturn 1;\r\ncase 2:\r\nreturn 4;\r\ncase 3:\r\nreturn 16;\r\ndefault:\r\n;\r\n}\r\n}\r\nswitch(tvb_reported_length(tvb)){\r\ncase 2430:\r\nreturn 1;\r\ncase 9720:\r\nreturn 4;\r\ncase 19440:\r\nreturn 8;\r\ncase 38880:\r\nreturn 16;\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\ndissect_sdh(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SDH");\r\ncol_clear(pinfo->cinfo,COL_INFO);\r\nif (tree) {\r\nproto_tree *sdh_tree;\r\nproto_item *sdh_item;\r\nint level = get_sdh_level(tvb, pinfo);\r\nguint8 h1;\r\nguint8 h2;\r\nguint16 au;\r\nint auoffset;\r\nsdh_item = proto_tree_add_protocol_format(tree, proto_sdh, tvb, 0, -1, "SDH");\r\nsdh_tree = proto_item_add_subtree(sdh_item, ett_sdh);\r\nh1 = tvb_get_guint8(tvb, 0*level+(3*level*COLUMNS));\r\nh2 = tvb_get_guint8(tvb, 3*level+(3*level*COLUMNS));\r\nau = (h2 | ((0x03 & h1) << 8));\r\nproto_tree_add_item(sdh_tree, hf_sdh_a1, tvb, 0*level, 3*level, ENC_NA);\r\nproto_tree_add_item(sdh_tree, hf_sdh_a2, tvb, 3*level, 3*level, ENC_NA);\r\nproto_tree_add_item(sdh_tree, hf_sdh_j0, tvb, 6*level, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_b1, tvb, 0*level+(1*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_e1, tvb, 3*level+(1*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_f1, tvb, 6*level+(1*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d1, tvb, 0*level+(2*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d2, tvb, 3*level+(2*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d3, tvb, 6*level+(2*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_h1, tvb, 0*level+(3*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_h2, tvb, 3*level+(3*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(sdh_tree, hf_sdh_au, tvb, 0*level+(3*level*COLUMNS), 3*level+1, au);\r\nproto_tree_add_item(sdh_tree, hf_sdh_b2, tvb, 0*level+(4*level*COLUMNS), 3*level, ENC_NA);\r\nproto_tree_add_item(sdh_tree, hf_sdh_k1, tvb, 3*level+(4*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_k2, tvb, 6*level+(4*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d4, tvb, 0*level+(5*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d5, tvb, 3*level+(5*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d6, tvb, 6*level+(5*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d7, tvb, 0*level+(6*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d8, tvb, 3*level+(6*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d9, tvb, 6*level+(6*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d10, tvb, 0*level+(7*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d11, tvb, 3*level+(7*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_d12, tvb, 6*level+(7*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_s1, tvb, 0*level+(8*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_m1, tvb, 3*level+2+(8*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sdh_tree, hf_sdh_e2, tvb, 6*level+(8*level*COLUMNS), 1, ENC_BIG_ENDIAN);\r\nauoffset = (((9 + 3*COLUMNS) + au*3 + 9*(au/87) ) * level) % (COLUMNS*9*level);\r\nproto_tree_add_item(sdh_tree, hf_sdh_j1, tvb, auoffset, 1, ENC_BIG_ENDIAN);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_sdh(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sdh_a1,\r\n{ "A1", "sdh.a1", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_a2,\r\n{ "A2", "sdh.a2", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_j0,\r\n{ "J0", "sdh.j0", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_b1,\r\n{ "B1", "sdh.b1", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_e1,\r\n{ "E1", "sdh.e1", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_f1,\r\n{ "F1", "sdh.f1", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d1,\r\n{ "D1", "sdh.d1", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d2,\r\n{ "D2", "sdh.d2", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d3,\r\n{ "D3", "sdh.d3", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_au,\r\n{ "AU", "sdh.au", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_b2,\r\n{ "B2", "sdh.b2", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_k1,\r\n{ "K1", "sdh.k1", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_k2,\r\n{ "K2", "sdh.k2", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d4,\r\n{ "D4", "sdh.d4", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d5,\r\n{ "D5", "sdh.d5", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d6,\r\n{ "D6", "sdh.d6", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d7,\r\n{ "D7", "sdh.d7", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d8,\r\n{ "D8", "sdh.d8", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d9,\r\n{ "D9", "sdh.d9", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d10,\r\n{ "D10", "sdh.d10", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d11,\r\n{ "D11", "sdh.d11", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_d12,\r\n{ "D12", "sdh.d12", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_s1,\r\n{ "S1", "sdh.s1", FT_UINT8, BASE_HEX, VALS(sdh_s1_vals), 0x0, NULL, HFILL }},\r\n{ &hf_sdh_m1,\r\n{ "M1", "sdh.m1", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_e2,\r\n{ "E2", "sdh.e2", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_j1,\r\n{ "J1", "sdh.j1", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_h1,\r\n{ "H1", "sdh.h1", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_sdh_h2,\r\n{ "H2", "sdh.h2", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_sdh,\r\n};\r\nmodule_t *sdh_module;\r\nproto_sdh = proto_register_protocol("SDH/SONET Protocol", "SDH", "sdh");\r\nproto_register_field_array(proto_sdh, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nsdh_module = prefs_register_protocol(proto_sdh, NULL);\r\nprefs_register_enum_preference(sdh_module, "data.rate",\r\n"Data rate",\r\n"Data rate",\r\n&sdh_data_rate, data_rates, ENC_BIG_ENDIAN);\r\nregister_dissector("sdh", dissect_sdh, proto_sdh);\r\n}\r\nvoid\r\nproto_reg_handoff_sdh(void)\r\n{\r\ndissector_handle_t sdh_handle;\r\nsdh_handle = find_dissector("sdh");\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_SDH, sdh_handle);\r\n}

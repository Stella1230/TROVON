static int\r\ndissect_mpeg_pmt(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nguint offset = 0, length = 0;\r\nguint prog_info_len, es_info_len;\r\nguint16 pid;\r\nproto_item *ti;\r\nproto_tree *mpeg_pmt_tree;\r\nproto_tree *mpeg_pmt_stream_tree;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Program Map Table (PMT)");\r\nti = proto_tree_add_item(tree, proto_mpeg_pmt, tvb, offset, -1, ENC_NA);\r\nmpeg_pmt_tree = proto_item_add_subtree(ti, ett_mpeg_pmt);\r\noffset += packet_mpeg_sect_header(tvb, offset, mpeg_pmt_tree, &length, NULL);\r\nlength -= 4;\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_program_number, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_reserved1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_version_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_current_next_indicator, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_last_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_reserved2, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_pcr_pid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nprog_info_len = tvb_get_ntohs(tvb, offset) & MPEG_PMT_PROGRAM_INFO_LENGTH_MASK;\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_reserved3, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpeg_pmt_tree, hf_mpeg_pmt_program_info_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += proto_mpeg_descriptor_loop_dissect(tvb, offset, prog_info_len, mpeg_pmt_tree);\r\nwhile (offset < length) {\r\npid = tvb_get_ntohs(tvb, offset + 1) & MPEG_PMT_STREAM_ELEMENTARY_PID_MASK;\r\nes_info_len = tvb_get_ntohs(tvb, offset + 3) & MPEG_PMT_STREAM_ES_INFO_LENGTH_MASK;\r\nmpeg_pmt_stream_tree = proto_tree_add_subtree_format(mpeg_pmt_tree, tvb, offset, 5 + es_info_len,\r\nett_mpeg_pmt_stream, NULL, "Stream PID=0x%04hx", pid);\r\nproto_tree_add_item(mpeg_pmt_stream_tree, hf_mpeg_pmt_stream_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(mpeg_pmt_stream_tree, hf_mpeg_pmt_stream_reserved1, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpeg_pmt_stream_tree, hf_mpeg_pmt_stream_elementary_pid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(mpeg_pmt_stream_tree, hf_mpeg_pmt_stream_reserved2, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpeg_pmt_stream_tree, hf_mpeg_pmt_stream_es_info_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += proto_mpeg_descriptor_loop_dissect(tvb, offset, es_info_len, mpeg_pmt_stream_tree);\r\n}\r\noffset += packet_mpeg_sect_crc(tvb, pinfo, mpeg_pmt_tree, 0, offset);\r\nproto_item_set_len(ti, offset);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_mpeg_pmt(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_mpeg_pmt_program_number, {\r\n"Program Number", "mpeg_pmt.pg_num",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_reserved1, {\r\n"Reserved", "mpeg_pmt.reserved1",\r\nFT_UINT8, BASE_HEX, NULL, MPEG_PMT_RESERVED1_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_version_number, {\r\n"Version Number", "mpeg_pmt.version",\r\nFT_UINT8, BASE_HEX, NULL, MPEG_PMT_VERSION_NUMBER_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_current_next_indicator, {\r\n"Current/Next Indicator", "mpeg_pmt.cur_next_ind",\r\nFT_UINT8, BASE_HEX, VALS(mpeg_pmt_cur_next_vals), MPEG_PMT_CURRENT_NEXT_INDICATOR_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_section_number, {\r\n"Section Number", "mpeg_pmt.sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_last_section_number, {\r\n"Last Section Number", "mpeg_pmt.last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_reserved2, {\r\n"Reserved", "mpeg_pmt.reserved2",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_RESERVED2_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_pcr_pid, {\r\n"PCR PID", "mpeg_pmt.pcr_pid",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_PCR_PID_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_reserved3, {\r\n"Reserved", "mpeg_pmt.reserved3",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_RESERVED3_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_program_info_length, {\r\n"Program Info Length", "mpeg_pmt.prog_info_len",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_PROGRAM_INFO_LENGTH_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_stream_type, {\r\n"Stream type", "mpeg_pmt.stream.type",\r\nFT_UINT8, BASE_HEX | BASE_EXT_STRING, &mpeg_pmt_stream_type_vals_ext, 0, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_stream_reserved1, {\r\n"Reserved", "mpeg_pmt.stream.reserved1",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_STREAM_RESERVED1_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_stream_elementary_pid, {\r\n"Elementary PID", "mpeg_pmt.stream.elementary_pid",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_STREAM_ELEMENTARY_PID_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_stream_reserved2, {\r\n"Reserved", "mpeg_pmt.stream.reserved2",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_STREAM_RESERVED2_MASK, NULL, HFILL\r\n} },\r\n{ &hf_mpeg_pmt_stream_es_info_length, {\r\n"ES Info Length", "mpeg_pmt.stream.es_info_len",\r\nFT_UINT16, BASE_HEX, NULL, MPEG_PMT_STREAM_ES_INFO_LENGTH_MASK, NULL, HFILL\r\n} },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mpeg_pmt,\r\n&ett_mpeg_pmt_stream,\r\n};\r\nproto_mpeg_pmt = proto_register_protocol("MPEG2 Program Map Table", "MPEG PMT", "mpeg_pmt");\r\nproto_register_field_array(proto_mpeg_pmt, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("mpeg_pmt", dissect_mpeg_pmt, proto_mpeg_pmt);\r\n}\r\nvoid\r\nproto_reg_handoff_mpeg_pmt(void)\r\n{\r\ndissector_handle_t mpeg_pmt_handle;\r\nmpeg_pmt_handle = find_dissector("mpeg_pmt");\r\ndissector_add_uint("mpeg_sect.tid", MPEG_PMT_TID, mpeg_pmt_handle);\r\n}

int child_debug(int level, const char* fmt, ...) {\r\nva_list ap;\r\nchar str[DBG_BUF_LEN];\r\nif (debug_lvl<level) return 1;\r\nva_start(ap, fmt);\r\nvsnprintf(str,DBG_BUF_LEN,fmt,ap);\r\nva_end(ap);\r\nfprintf(debug_fp, "child[%d-%d]: reqh_id=%d debug_lvl=%d message='%s'\n",\r\nchild.chld_id, child.pid, child.reqh_id, level, str);\r\nreturn 1;\r\n}\r\nstatic char* param_get_dbg_level(char** err _U_) {\r\nreturn g_strdup_printf("%d",debug_lvl);\r\n}\r\nstatic echld_bool_t param_set_dbg_level(char* val , char** err ) {\r\nchar* p;\r\nint lvl = (int)strtol(val, &p, 10);\r\nif (p<=val) {\r\n*err = g_strdup("not an integer");\r\nreturn FALSE;\r\n} else if (lvl < 0 || lvl > 5) {\r\n*err = g_strdup_printf("invalid level=%d (min=0 max=5)",lvl);\r\nreturn FALSE;\r\n}\r\ndebug_lvl = lvl;\r\nDCOM();\r\nreturn TRUE;\r\n}\r\nstatic long dbg_resp(GByteArray* em, echld_msg_type_t t) {\r\nlong st = echld_write_frame(child.fds.pipe_to_parent, em, child.chld_id, t, child.reqh_id, NULL);\r\nchild_debug(1, "SND fd=%d ch=%d ty='%s' rh=%d msg='%s'",\r\nchild.fds.pipe_to_parent, child.chld_id, TY(t), child.reqh_id, (st>0?"ok":g_strerror(errno)) );\r\nreturn st;\r\n}\r\nstatic void sig_term(int sig _U_) {\r\nCHILD_DBG((3,"Terminated, Closing"));\r\nexit(0);\r\n}\r\nextern void echld_child_initialize(echld_chld_id_t chld_id, int pipe_from_parent, int pipe_to_parent, int reqh_id, echld_epan_stuff_t* es) {\r\nstuff = es;\r\nclose_sleep_time.tv_sec = CHILD_CLOSE_SLEEP_TIME / 1000000;\r\nclose_sleep_time.tv_usec = CHILD_CLOSE_SLEEP_TIME % 1000000;\r\nchild.chld_id = chld_id;\r\nchild.state = IDLE;\r\nchild.pid = getpid();\r\nchild.dispatcher_pid = getppid();\r\nchild.reqh_id = reqh_id;\r\nechld_init_reader( &(child.parent), pipe_from_parent,4096);\r\nchild.fds.pipe_to_parent = pipe_to_parent;\r\nchild.fds.pipe_from_dumpcap = -1;\r\nchild.fds.pipe_to_dumpcap = -1;\r\nchild.fds.file_being_read = -1;\r\ngettimeofday(&child.started,NULL);\r\nchild.now.tv_sec = child.started.tv_sec;\r\nchild.now.tv_usec = child.started.tv_usec;\r\nechld_get_all_codecs(&(child.enc), &(child.dec), NULL, NULL);\r\nCHILD_DBG_INIT();\r\nCHILD_DBG((5,"Child Initialized ch=%d from=%d to=%d rq=%d",chld_id, pipe_from_parent, pipe_to_parent, reqh_id));\r\nsignal(SIGALRM,SIG_DFL);\r\nsignal(SIGTERM,sig_term);\r\nsignal(SIGPIPE,SIG_DFL);\r\nsignal(SIGINT,SIG_DFL);\r\nsignal(SIGABRT,SIG_DFL);\r\nsignal(SIGHUP,SIG_DFL);\r\n}\r\nvoid child_err(int e, unsigned reqh_id, const char* fmt, ...) {\r\nsize_t len= 1024;\r\ngchar err_str[len];\r\nva_list ap;\r\nstatic GByteArray* ba;\r\nva_start(ap, fmt);\r\ng_vsnprintf(err_str,len,fmt,ap);\r\nva_end(ap);\r\nCHILD_DBG((0,"error='%s'",err_str));\r\nba = child.enc->error(e, err_str);\r\nechld_write_frame(child.fds.pipe_to_parent, ba, child.chld_id, ECHLD_ERROR, reqh_id, NULL);\r\ng_byte_array_free(ba,TRUE);\r\n}\r\nstatic char* param_get_cwd(char** err ) {\r\nchar* pwd = getcwd(NULL, 128);\r\nif (!pwd) {\r\n*err = g_strdup(g_strerror(errno));\r\n}\r\nreturn pwd;\r\n}\r\nstatic echld_bool_t param_set_cwd(char* val , char** err ) {\r\nif (chdir(val) != 0) {\r\n*err = g_strdup_printf("cannot chdir reas='%s'",g_strerror(errno));\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic char* param_get_packet_count(char** err) {\r\nif (child.state != CAPTURING && child.state != READING) {\r\n*err = g_strdup("Must be reading or in-capture for packet_count");\r\nreturn NULL;\r\n}\r\nreturn g_strdup_printf("%d",packet_count);\r\n}\r\nstatic echld_bool_t param_set_dfilter(char* val , char** err) {\r\ndfilter_t *dfn = NULL;\r\nif (child.state != IDLE && child.state != DONE ) {\r\n*err = g_strdup("Only while idle or done");\r\nreturn FALSE;\r\n} else {\r\nif ( dfilter_compile(val, &dfn, err) ) {\r\nif (child.dfilter) g_free(child.dfilter);\r\nif (child.df) dfilter_free(child.df);\r\nchild.df = dfn;\r\nchild.dfilter = g_strdup(val);\r\nreturn TRUE;\r\n} else {\r\nreturn FALSE;\r\n}\r\n}\r\n}\r\nstatic char* param_get_dfilter(char** err _U_) { return g_strdup(child.dfilter ? child.dfilter : ""); }\r\nstatic echld_bool_t param_set_profile(char* val , char** err ) {\r\nif (child.state != IDLE) {\r\n*err = g_strdup_printf("Cannot set Profile \"%s\", too late.", val);\r\nreturn FALSE;\r\n}\r\nif (profile_exists (val, FALSE)) {\r\nset_profile_name (val);\r\nif (param_profile) g_free(param_profile);\r\nparam_profile = g_strdup(val);\r\nreturn TRUE;\r\n} else {\r\n*err = g_strdup_printf("Configuration Profile \"%s\" does not exist", val);\r\nreturn FALSE;\r\n}\r\n}\r\nstatic char* param_get_profile(char** err _U_) { return g_strdup(param_profile ? param_profile : ""); }\r\nstatic char* param_get_file_list(char** err) {\r\nGError* gerror = NULL;\r\nGDir* dir = g_dir_open(".", 0, &gerror);\r\nGString* str = g_string_new("{ what='file_list', files=[");\r\nconst char* file;\r\nif (gerror) {\r\n*err = g_strdup_printf("Failed to open curr dir reason='%s'",gerror->message);\r\nreturn NULL;\r\n}\r\nwhile(( file = g_dir_read_name(dir) )) {\r\ng_string_append_printf(str,"{filename='%s'},\n",file);\r\n}\r\ng_dir_close(dir);\r\ng_string_truncate(str, str->len-2);\r\ng_string_append(str, "]}");\r\nreturn g_string_free(str,FALSE);\r\n}\r\nstatic echld_bool_t param_set_out_file_type(char* val, char** err) {\r\nint oft = wtap_short_string_to_file_type_subtype(val);\r\nif (oft < 0) {\r\n*err = g_strdup_printf("\"%s\" isn't a valid capture file type", val);\r\nreturn FALSE;\r\n} else {\r\nout_file_type = oft;\r\nreturn TRUE;\r\n}\r\n}\r\nstatic char* param_get_out_file_type(char** err _U_) {\r\nreturn g_strdup_printf("%s(%d): %s",\r\nwtap_file_type_subtype_short_string(out_file_type),\r\nout_file_type, wtap_file_type_subtype_string(out_file_type));\r\n}\r\nstatic echld_bool_t param_set_add_hosts_file(char* val, char** err) {\r\nif (add_hosts_file(val)) {\r\nreturn TRUE;\r\n} else {\r\n*err = g_strdup_printf("Can't read host entries from \"%s\"",val);\r\nreturn FALSE;\r\n}\r\n}\r\nstatic char* param_get_params(char** err _U_) {\r\nreturn paramset_get_params_list(child_params,PARAM_LIST_FMT);\r\n}\r\nstatic void child_open_file(char* filename) {\r\nCHILD_DBG((2,"CMD open file filename='%s'",filename));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"open file not implemented yet!");\r\nchild.state = READING;\r\n}\r\nstatic void child_open_interface(char* intf, char* pars) {\r\nCHILD_DBG((2,"CMD open interface intf='%s', params='%s'",intf,pars));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"open interface not implemented yet!");\r\nchild.state = READY;\r\n}\r\nstatic void child_start_capture(void) {\r\nCHILD_DBG((2,"CMD start capture"));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"start capture not implemented yet!");\r\nchild.state = CAPTURING;\r\n}\r\nstatic void child_stop_capure(void) {\r\nCHILD_DBG((2,"CMD stop capture"));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"stop capture not implemented yet!");\r\nchild.state = DONE;\r\n}\r\nstatic void child_get_summary(char* range) {\r\nCHILD_DBG((2,"CMD get summary range='%s'",range));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"get_summary not implemented yet!");\r\n}\r\nstatic void child_get_tree(char* range) {\r\nCHILD_DBG((2,"CMD get tree range='%s'",range));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"get_tree not implemented yet!");\r\n}\r\nstatic void child_get_buffer(char* name) {\r\nCHILD_DBG((2,"CMD get buffer name='%s'",name));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"get_buffer not implemented yet!");\r\n}\r\nstatic void child_add_note(int framenum, char* note) {\r\nCHILD_DBG((2,"CMD add note framenum=%d note='%s'",framenum,note));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"add_note not implemented yet!");\r\n}\r\nstatic void child_apply_filter(char* filter) {\r\nCHILD_DBG((2,"CMD apply filter filter='%s'",filter));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"apply_filter not implemented yet!");\r\n}\r\nstatic void child_save_file(char* filename, char* pars) {\r\nCHILD_DBG((2,"CMD save file filename='%s' params='%s'",filename,pars));\r\nchild_err(ECHLD_ERR_UNIMPLEMENTED,child.reqh_id,"save_file not implemented yet!");\r\n}\r\nstatic long child_receive(guint8* b, size_t len, echld_chld_id_t chld_id, echld_msg_type_t type, echld_reqh_id_t reqh_id, void* data _U_) {\r\nGByteArray ba;\r\nGByteArray* gba;\r\nchar* err = NULL;\r\nchild.reqh_id = reqh_id;\r\nCHILD_DBG((2,"RCVD type='%s' len='%d'",TY(type),len));\r\n#if 0\r\ngettimeofday(&(child.now), NULL);\r\n#endif\r\nif (child.chld_id != chld_id) {\r\nchild_err(ECHLD_ERR_WRONG_MSG,reqh_id,\r\n"chld_id: own:%d given:%d msg_type='%s'",child.chld_id,chld_id,TY(type));\r\nreturn 0;\r\n}\r\nba.data = b;\r\nba.len = (guint)len;\r\nswitch(type) {\r\ncase ECHLD_NEW_CHILD: {\r\nchild.state = CREATING;\r\nif ( !paramset_apply_em(child_params,(enc_msg_t*)&ba, &err) ) {\r\nchild_err(ECHLD_ERR_CRASHED_CHILD,reqh_id,\r\n"Initial Paramset Error '%s'",err);\r\n} else {\r\nchild.state = IDLE;\r\nCHILD_RESP(NULL,ECHLD_HELLO);\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_PING:\r\nCHILD_DBG((1,"PONG"));\r\nCHILD_RESP(&ba,ECHLD_PONG);\r\nbreak;\r\ncase ECHLD_SET_PARAM:{\r\nchar* param;\r\nchar* value;\r\nif ( child.dec->set_param && child.dec->set_param(b,len,&param,&value) ) {\r\nif (! paramset_apply_set (child_params, param, value, &err) ) {\r\nchild_err(ECHLD_CANNOT_SET_PARAM,reqh_id,"%s",err);\r\ng_free(err);\r\nreturn 0;\r\n}\r\ngba = child.enc->param(param,value);\r\nCHILD_RESP(gba,ECHLD_PARAM);\r\ng_byte_array_free(gba,TRUE);\r\nCHILD_DBG((1,"Set Param: param='%s' value='%s'",param,value));\r\nbreak;\r\n} else {\r\ngoto misencoded;\r\n}\r\n}\r\ncase ECHLD_GET_PARAM: {\r\nchar* param;\r\nif ( child.dec->get_param && child.dec->get_param(b,len,&param) ) {\r\nchar* val;\r\nif (! (val = paramset_apply_get (child_params, param, &err)) ) {\r\nchild_err(ECHLD_CANNOT_GET_PARAM,reqh_id,"%s",err);\r\ng_free(err);\r\nreturn 0;\r\n}\r\ngba = child.enc->param(param,val);\r\nCHILD_RESP(gba,ECHLD_PARAM);\r\ng_byte_array_free(gba,TRUE);\r\nCHILD_DBG((2,"Get Param: param='%s' value='%s'",param,val));\r\nbreak;\r\n} else {\r\ngoto misencoded;\r\n}\r\n}\r\ncase ECHLD_CLOSE_CHILD:\r\nCHILD_RESP(NULL,ECHLD_CLOSING);\r\nCHILD_DBG((3,"Closing"));\r\nselect(0,NULL,NULL,NULL,&close_sleep_time);\r\nCHILD_DBG((1,"Bye"));\r\nexit(0);\r\nbreak;\r\ncase ECHLD_OPEN_FILE: {\r\nchar* filename;\r\nif (child.state != IDLE) goto wrong_state;\r\nif ( child.dec->open_file(b,len,&filename) ) {\r\nchild_open_file(filename);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode open_file");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_OPEN_INTERFACE: {\r\nchar* intf;\r\nchar* pars;\r\nif (child.state != IDLE) goto wrong_state;\r\nif ( child.dec->open_interface(b,len,&intf,&pars) ) {\r\nchild_open_interface(intf,pars);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id, "cannot decode open_interface");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_START_CAPTURE:{\r\nif (child.state != READY) goto wrong_state;\r\nchild_start_capture();\r\nbreak;\r\n}\r\ncase ECHLD_STOP_CAPTURE: {\r\nif (child.state != CAPTURING) goto wrong_state;\r\nchild_stop_capure();\r\nbreak;\r\n}\r\ncase ECHLD_GET_SUM: {\r\nchar* range;\r\nif (child.state != CAPTURING && child.state != READING && child.state != DONE) goto wrong_state;\r\nif ( child.dec->get_sum(b,len,&range) ) {\r\nchild_get_summary(range);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode get_summary");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_GET_TREE:{\r\nchar* range;\r\nif (child.state != CAPTURING && child.state != READING && child.state != DONE) goto wrong_state;\r\nif ( child.dec->get_tree(b,len,&range) ) {\r\nchild_get_tree(range);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode get_tree");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_GET_BUFFER:{\r\nchar* name;\r\nif (child.state != CAPTURING && child.state != READING && child.state != DONE) goto wrong_state;\r\nif ( child.dec->get_buffer(b,len,&name) ) {\r\nchild_get_buffer(name);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode get_buffer");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_ADD_NOTE: {\r\nint framenum;\r\nchar* note;\r\nif (child.state != CAPTURING && child.state != READING && child.state != DONE) goto wrong_state;\r\nif ( child.dec->add_note(b,len,&framenum,&note) ) {\r\nchild_add_note(framenum,note);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode get_buffer");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_APPLY_FILTER: {\r\nchar* filter;\r\nif (child.state != DONE) goto wrong_state;\r\nif ( child.dec->apply_filter(b,len,&filter) ) {\r\nchild_apply_filter(filter);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode apply_filter");\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_SAVE_FILE: {\r\nchar* filename;\r\nchar* pars;\r\nif (child.state != DONE) goto wrong_state;\r\nif ( child.dec->save_file(b,len,&filename,&pars) ) {\r\nchild_save_file(filename,pars);\r\n} else {\r\nchild_err(ECHLD_DECODE_ERROR,reqh_id,"cannot decode save_file");\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nchild_err(ECHLD_ERR_WRONG_MSG,reqh_id,"wrong message: chld_id=%d msg_type='%s'",chld_id,TY(type));\r\nbreak;\r\n}\r\nreturn 0;\r\nmisencoded:\r\nchild_err(ECHLD_ERR_WRONG_MSG,reqh_id,"misencoded msg msg_type='%s'",TY(type));\r\nreturn 0;\r\nwrong_state:\r\nchild_err(ECHLD_ERR_WRONG_MSG,reqh_id,"unexpected message: received in wrong state='%s', msg_type='%s'",ST(child.state),TY(type));\r\nreturn 0;\r\n}\r\nstatic int child_dumpcap_read(void) {\r\nCHILD_DBG((2,"child_dumpcap_read"));\r\nreturn FALSE;\r\n}\r\nstatic void child_file_read(void) {\r\n}\r\nint echld_child_loop(void) {\r\nint disp_from = child.parent.fd;\r\nint disp_to = child.fds.pipe_to_parent;\r\n#ifdef DEBUG_CHILD\r\nint step = 0;\r\n#endif\r\nCHILD_DBG((0,"entering child_loop()"));\r\ndo {\r\nfd_set rfds;\r\nfd_set wfds;\r\nfd_set efds;\r\nstruct timeval timeout;\r\nint nfds;\r\ngboolean captured = FALSE;\r\nFD_ZERO(&rfds);\r\nFD_ZERO(&wfds);\r\nFD_ZERO(&efds);\r\nFD_SET(disp_from,&rfds);\r\nFD_SET(disp_from,&efds);\r\nFD_SET(disp_to,&efds);\r\nif (child.fds.pipe_from_dumpcap > 0) {\r\nFD_SET(child.fds.pipe_from_dumpcap,&rfds);\r\n}\r\n#ifdef DEBUG_CHILD\r\nif (step <= 20) CHILD_DBG((4,"child_loop: select()ing step=%d",step++));\r\n#endif\r\ntimeout.tv_sec = 0;\r\ntimeout.tv_usec = 999999;\r\nnfds = select(FD_SETSIZE, &rfds, &wfds, &efds, &timeout);\r\n#ifdef DEBUG_CHILD\r\nif (step <= 20) CHILD_DBG((4,"child_loop: select()ed nfds=%d",nfds));\r\n#endif\r\nif ( FD_ISSET(disp_from,&efds) ) {\r\nCHILD_DBG((0,"Broken Parent Pipe 'From' step=%d",step));\r\nbreak;\r\n}\r\nif ( FD_ISSET(disp_to,&efds) ) {\r\nCHILD_DBG((0,"Broken Parent Pipe 'To' step=%d",step));\r\nbreak;\r\n}\r\nif (child.fds.pipe_from_dumpcap > 0 && FD_ISSET(child.fds.pipe_from_dumpcap,&efds) ) {\r\nCHILD_DBG((0,"Broken Dumpcap Pipe step=%d",step));\r\nbreak;\r\n}\r\nif (FD_ISSET(disp_from, &rfds)) {\r\nlong st = echld_read_frame(&(child.parent), child_receive, &child);\r\n#ifdef DEBUG_CHILD\r\nstep = 0;\r\n#endif\r\nif (st < 0) {\r\nCHILD_DBG((0,"Read Frame Failed step=%d",step));\r\nreturn (int)st;\r\n}\r\n}\r\nif (child.fds.pipe_from_dumpcap > 0 && FD_ISSET(child.fds.pipe_from_dumpcap,&rfds) ) {\r\n#ifdef DEBUG_CHILD\r\nstep = 0;\r\n#endif\r\ncaptured = child_dumpcap_read();\r\n}\r\nif ( child.state == READING || captured ) {\r\nchild_file_read();\r\n}\r\n} while(1);\r\nCHILD_RESP(NULL,ECHLD_CLOSING);\r\nCHILD_DBG((3,"Closing"));\r\nreturn 222;\r\n}

static void\r\ndissect_mmrp_common1(proto_tree *msg_tree, tvbuff_t *tvb, int msg_offset)\r\n{\r\nproto_tree_add_item(msg_tree, hf_mmrp_attribute_type, tvb,\r\nMMRP_ATTRIBUTE_TYPE_OFFSET + msg_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(msg_tree, hf_mmrp_attribute_length, tvb,\r\nMMRP_ATTRIBUTE_LENGTH_OFFSET + msg_offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_mmrp_common2(proto_tree *vect_attr_tree, tvbuff_t *tvb, int msg_offset)\r\n{\r\nproto_tree_add_bitmask(vect_attr_tree, tvb, MMRP_VECTOR_HEADER_OFFSET + msg_offset,\r\nhf_mmrp_vector_header, ett_vector_header, vector_header_fields, ENC_BIG_ENDIAN);\r\n}\r\nstatic guint\r\ndissect_mmrp_three_packed_event(proto_tree *vect_attr_tree, tvbuff_t *tvb, guint offset, guint16 number_of_values)\r\n{\r\nguint counter;\r\nfor ( counter = 0; counter < number_of_values; ) {\r\nguint8 value;\r\nguint8 three_packed_event[3];\r\nvalue = tvb_get_guint8(tvb, offset);\r\nthree_packed_event[0] = value / 36;\r\nvalue -= 36 * three_packed_event[0];\r\nthree_packed_event[1] = value / 6;\r\nvalue -= 6 * three_packed_event[1];\r\nthree_packed_event[2] = value;\r\nproto_tree_add_uint(vect_attr_tree, hf_mmrp_three_packed_event, tvb, offset, sizeof(guint8),\r\nthree_packed_event[0]);\r\ncounter++;\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_mmrp_three_packed_event, tvb, offset, sizeof(guint8),\r\nthree_packed_event[1]);\r\ncounter++;\r\n}\r\nif ( counter < number_of_values ) {\r\nproto_tree_add_uint(vect_attr_tree, hf_mmrp_three_packed_event, tvb, offset, sizeof(guint8),\r\nthree_packed_event[2]);\r\ncounter++;\r\n}\r\noffset++;\r\n}\r\nreturn( offset );\r\n}\r\nstatic int\r\ndissect_mmrp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\nproto_item *ti, *msg_ti, *attr_list_ti, *vect_attr_ti;\r\nproto_tree *mmrp_tree, *msg_tree, *attr_list_tree, *vect_attr_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MRP-MMRP");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Multiple Mac Registration Protocol");\r\nif (tree) {\r\nguint8 attribute_type;\r\nguint8 attribute_length;\r\nguint16 number_of_values;\r\nguint offset = 0;\r\nint vect_attr_len;\r\nint msg_offset;\r\nint vect_offset;\r\nti = proto_tree_add_item(tree, proto_mmrp, tvb, 0, -1, ENC_NA);\r\nmmrp_tree = proto_item_add_subtree(ti, ett_mmrp);\r\nproto_tree_add_item(mmrp_tree, hf_mmrp_proto_id, tvb, MMRP_PROTOCOL_VERSION_OFFSET, 1, ENC_BIG_ENDIAN);\r\nmsg_offset = 0;\r\nwhile (tvb_get_ntohs(tvb, MMRP_ATTRIBUTE_TYPE_OFFSET + msg_offset) != MMRP_END_MARK) {\r\nattribute_type = tvb_get_guint8(tvb, MMRP_ATTRIBUTE_TYPE_OFFSET + msg_offset);\r\nattribute_length = tvb_get_guint8(tvb, MMRP_ATTRIBUTE_LENGTH_OFFSET + msg_offset);\r\nmsg_ti = proto_tree_add_item(mmrp_tree, hf_mmrp_message, tvb,\r\nMMRP_MESSAGE_GROUP_OFFSET + msg_offset,\r\n-1, ENC_NA);\r\nmsg_tree = proto_item_add_subtree(msg_ti, ett_msg);\r\nproto_item_append_text(msg_tree, ": %s (%d)",\r\nval_to_str_const(attribute_type, attribute_type_vals, "<Unknown>"),\r\nattribute_type);\r\ndissect_mmrp_common1(msg_tree, tvb, msg_offset);\r\nattr_list_ti = proto_tree_add_item(msg_tree, hf_mmrp_attribute_list, tvb,\r\nMMRP_ATTRIBUTE_LIST_GROUP_OFFSET + msg_offset,\r\n-1, ENC_NA);\r\nattr_list_tree = proto_item_add_subtree(attr_list_ti, ett_attr_list);\r\nvect_offset = 0;\r\nwhile (tvb_get_ntohs(tvb, MMRP_VECTOR_HEADER_OFFSET + msg_offset + vect_offset) != MMRP_END_MARK) {\r\nnumber_of_values = tvb_get_ntohs(tvb, MMRP_NUMBER_OF_VALUES_OFFSET + msg_offset + vect_offset)\r\n& MMRP_NUMBER_OF_VALUES_MASK;\r\nvect_attr_len = 2 + attribute_length + (number_of_values + 2)/3;\r\nvect_attr_ti = proto_tree_add_item(attr_list_tree, hf_mmrp_vector_attribute, tvb,\r\nMMRP_VECTOR_ATTRIBUTE_GROUP_OFFSET + msg_offset + vect_offset,\r\nvect_attr_len, ENC_NA);\r\nvect_attr_tree = proto_item_add_subtree(vect_attr_ti, ett_vect_attr);\r\ndissect_mmrp_common2(vect_attr_tree, tvb, msg_offset + vect_offset);\r\nif (attribute_type == MMRP_ATTRIBUTE_TYPE_MAC) {\r\nproto_tree_add_item(vect_attr_tree, hf_mmrp_first_value, tvb,\r\nMMRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset,\r\nattribute_length, ENC_NA);\r\noffset = dissect_mmrp_three_packed_event(vect_attr_tree, tvb,\r\nMMRP_MAC_THREE_PACKED_OFFSET + msg_offset + vect_offset,\r\nnumber_of_values);\r\n}\r\nelse if (attribute_type == MMRP_ATTRIBUTE_TYPE_SERVICE) {\r\nproto_tree_add_item(vect_attr_tree, hf_mmrp_first_value, tvb,\r\nMMRP_FIRST_VALUE_GROUP_OFFSET + msg_offset + vect_offset,\r\nattribute_length, ENC_NA);\r\noffset = dissect_mmrp_three_packed_event(vect_attr_tree, tvb,\r\nMMRP_MAC_THREE_PACKED_OFFSET + msg_offset + vect_offset,\r\nnumber_of_values);\r\n}\r\nvect_offset += vect_attr_len;\r\n}\r\nproto_tree_add_item(attr_list_tree, hf_mmrp_end_mark, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_item_set_len(attr_list_ti, vect_offset);\r\nmsg_offset += vect_offset + 2;\r\nproto_item_set_len(msg_ti, vect_offset + 2);\r\n}\r\nproto_tree_add_item(mmrp_tree, hf_mmrp_end_mark, tvb, offset+2, 2, ENC_BIG_ENDIAN);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_mrp_mmrp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_mmrp_proto_id,\r\n{ "Protocol Version", "mrp-mmrp.protocol_version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_message,\r\n{ "Message", "mrp-mmrp.message",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_attribute_type,\r\n{ "Attribute Type", "mrp-mmrp.attribute_type",\r\nFT_UINT8, BASE_DEC, VALS(attribute_type_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_attribute_length,\r\n{ "Attribute Length", "mrp-mmrp.attribute_length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_attribute_list,\r\n{ "Attribute List", "mrp-mmrp.attribute_list",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_vector_attribute,\r\n{ "Vector Attribute", "mrp-mmrp.vector_attribute",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_vector_header,\r\n{ "Vector Header", "mrp-mmrp.vector_header",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_leave_all_event,\r\n{ "Leave All Event", "mrp-mmrp.leave_all_event",\r\nFT_UINT16, BASE_DEC, VALS(leave_all_vals), MMRP_LEAVE_ALL_EVENT_MASK, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_number_of_values,\r\n{ "Number of Values", "mrp-mmrp.number_of_values",\r\nFT_UINT16, BASE_DEC, NULL, MMRP_NUMBER_OF_VALUES_MASK, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_first_value,\r\n{ "First Value", "mrp-mmrp.first_value",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_three_packed_event,\r\n{ "Attribute Event", "mrp-mmrp.three_packed_event",\r\nFT_UINT8, BASE_DEC, VALS(three_packed_vals), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_mmrp_end_mark,\r\n{ "End Mark", "mrp-mmrp.end_mark",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mmrp,\r\n&ett_msg,\r\n&ett_attr_list,\r\n&ett_vect_attr,\r\n&ett_vector_header,\r\n&ett_first_value\r\n};\r\nproto_mmrp = proto_register_protocol("Multiple Mac Registration Protocol",\r\n"MRP-MMRP", "mrp-mmrp");\r\nproto_register_field_array(proto_mmrp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_mrp_mmrp(void)\r\n{\r\ndissector_handle_t mmrp_handle;\r\nmmrp_handle = create_dissector_handle(dissect_mmrp, proto_mmrp);\r\ndissector_add_uint("ethertype", ETHERTYPE_MMRP, mmrp_handle);\r\n}

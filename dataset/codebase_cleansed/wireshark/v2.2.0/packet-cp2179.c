static tvbuff_t *\r\nclean_telnet_iac(packet_info *pinfo, tvbuff_t *tvb, int offset, int len)\r\n{\r\ntvbuff_t *telnet_tvb;\r\nguint8 *buf;\r\nconst guint8 *spos;\r\nguint8 *dpos;\r\nint skip_byte, len_remaining;\r\nspos=tvb_get_ptr(tvb, offset, len);\r\nbuf = (guint8 *)wmem_alloc(pinfo->pool, len);\r\ndpos = buf;\r\nskip_byte = 0;\r\nlen_remaining = len;\r\nwhile(len_remaining > 0){\r\nif (len_remaining > 1) {\r\nif((spos[0]==0xff) && (spos[1]==0xff)){\r\nskip_byte++;\r\nlen_remaining -= 2;\r\n*(dpos++) = 0xff;\r\nspos += 2;\r\ncontinue;\r\n}\r\n}\r\n*(dpos++) = *(spos++);\r\nlen_remaining--;\r\n}\r\ntelnet_tvb = tvb_new_child_real_data(tvb, buf, len-skip_byte, len-skip_byte);\r\nadd_new_data_source(pinfo, telnet_tvb, "Processed Telnet Data");\r\nreturn telnet_tvb;\r\n}\r\nstatic int\r\ndissect_request_frame(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, int offset, guint16 packet_type )\r\n{\r\nproto_tree *cp2179_proto_tree = NULL;\r\nproto_tree *cp2179_addr_tree = NULL;\r\nproto_tree *cp2179_fc_tree = NULL;\r\nproto_item *cp2179_proto_item = NULL;\r\nguint8 req_command_code = 0;\r\nguint8 function_code = 0;\r\nguint16 address_word = -1;\r\nguint16 requestnumberofcharacters = 0;\r\ncp2179_proto_item = proto_tree_add_item(tree, proto_cp2179, tvb, 0, -1, ENC_NA);\r\ncp2179_proto_tree = proto_item_add_subtree(cp2179_proto_item, ett_cp2179_header);\r\naddress_word = tvb_get_letohs(tvb, offset);\r\ncp2179_addr_tree = proto_tree_add_subtree_format(cp2179_proto_tree, tvb, offset, 2, ett_cp2179_addr, NULL,\r\n"RTU Address: %d, Master Address: %d", (address_word & 0x7FF), ((address_word & 0xF800) >> 11) );\r\nproto_tree_add_item(cp2179_addr_tree, hf_cp2179_rtu_address, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp2179_addr_tree, hf_cp2179_master_address, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nfunction_code = tvb_get_guint8(tvb, offset) & 0x3f;\r\ncp2179_fc_tree = proto_tree_add_subtree_format(cp2179_proto_tree, tvb, offset, 1, ett_cp2179_fc, NULL,\r\n"Function Code: %s (0x%02x)", val_to_str_const(function_code, FunctionCodenames, "Unknown Function Code"), function_code);\r\nproto_tree_add_item(cp2179_fc_tree, hf_cp2179_function_code, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp2179_fc_tree, hf_cp2179_reserved, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nswitch(packet_type)\r\n{\r\ncase INIT_RTU_REQUEST:\r\ncase RESET_ACC_REQUEST:\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_command_code_fc20 , tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ncase BASIC_SCAN_QUERY_PACKET:\r\ncase SCAN_INCLUSIVE_16_ANALOG_REQUEST:\r\nreq_command_code = tvb_get_guint8(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [ %s ]", val_to_str_ext_const(req_command_code, &cp2179_CommandCodeNames_ext, "Unknown Command Code"));\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_command_code, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_command_code, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nbreak;\r\n}\r\noffset += 1;\r\nrequestnumberofcharacters = tvb_get_letohs(tvb, 4);\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_number_characters, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nif ( requestnumberofcharacters > 0 ){\r\nswitch (packet_type)\r\n{\r\ncase SBO_SELECT_REQUEST:\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_sbo_request_point, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase RESET_ACC_REQUEST:\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_resetacc_request_point, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase SPECIAL_CALC_REQUEST_RANGE:\r\ndo{\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_speccalc_request_point, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\ncase SCAN_INCLUSIVE_16_ANALOG_REQUEST:\r\ndo{\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_scaninc_startreq_point, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_scaninc_stopreq_point, tvb, offset+1, 1, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\n}\r\n}\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_crc, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic int\r\ndissect_bs_response_frame(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo, int offset, guint16 packet_type)\r\n{\r\nproto_item *bs_response_item = NULL;\r\nproto_item *cp2179_proto_item = NULL;\r\nproto_item *cp2179_subdata_item = NULL;\r\nproto_tree *cp2179_proto_tree = NULL;\r\nproto_tree *cp2179_addr_tree = NULL;\r\nproto_tree *cp2179_fc_tree = NULL;\r\nproto_tree *cp2179_data_tree = NULL;\r\ncp2179_conversation *conv;\r\nguint32 req_frame_num;\r\nguint16 req_address_word;\r\nguint8 req_command_code;\r\ngboolean request_found = FALSE;\r\nbs_request_frame *request_data;\r\ngint analogtestvalue = 0;\r\ngint analog16_num = 0;\r\ngint point_num = 0;\r\nguint function_code;\r\nguint simplestatusseq = 0x30;\r\nguint16 address_word = 0;\r\nguint16 numberofcharacters = -1;\r\ngfloat specialcalvalue = 0;\r\ncp2179_proto_item = proto_tree_add_item(tree, proto_cp2179, tvb, 0, -1, ENC_NA);\r\ncp2179_proto_tree = proto_item_add_subtree(cp2179_proto_item, ett_cp2179_header);\r\naddress_word = tvb_get_letohs(tvb, offset);\r\ncp2179_addr_tree = proto_tree_add_subtree_format(cp2179_proto_tree, tvb, offset, 2, ett_cp2179_addr, NULL,\r\n"RTU Address: %d, Master Address: %d", (address_word & 0x7FF), ((address_word & 0xF800) >> 11) );\r\nproto_tree_add_item(cp2179_addr_tree, hf_cp2179_rtu_address, tvb, 0, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp2179_addr_tree, hf_cp2179_master_address, tvb, 0, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nfunction_code = tvb_get_guint8(tvb, offset) & 0x3f;\r\ncp2179_fc_tree = proto_tree_add_subtree_format(cp2179_proto_tree, tvb, offset, 1, ett_cp2179_fc, NULL,\r\n"Function Code: %s (0x%02x)", val_to_str_const(function_code, FunctionCodenames, "Unknown Function Code"), function_code);\r\nproto_tree_add_item(cp2179_fc_tree, hf_cp2179_function_code, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp2179_fc_tree, hf_cp2179_nop_flag, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp2179_fc_tree, hf_cp2179_rst_flag, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_status_byte, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_port_status_byte, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nnumberofcharacters = tvb_get_letohs(tvb, 5);\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_number_characters, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nconv = (cp2179_conversation *)p_get_proto_data(wmem_file_scope(), pinfo, proto_cp2179, 0);\r\nif (conv) {\r\nwmem_list_frame_t *frame = wmem_list_head(conv->bs_request_frame_data);\r\nwhile (frame && !request_found) {\r\nrequest_data = (bs_request_frame *)wmem_list_frame_data(frame);\r\nreq_frame_num = request_data->fnum;\r\nreq_command_code = request_data->commmand_code;\r\nreq_address_word = request_data->address_word;\r\nif ((pinfo->num > req_frame_num) && (req_address_word == address_word)) {\r\nbs_response_item = proto_tree_add_uint(cp2179_proto_tree, hf_cp2179_request_frame, tvb, 0, 0, req_frame_num);\r\nPROTO_ITEM_SET_GENERATED(bs_response_item);\r\nrequest_found = TRUE;\r\n}\r\nframe = wmem_list_frame_next(frame);\r\n}\r\nif (request_found)\r\n{\r\nswitch (packet_type)\r\n{\r\ncase SBO_SELECT_RESPONSE:\r\ncase SBO_OPERATE_RESPONSE:\r\ncase RESET_ACC_RESPONSE:\r\ncase INIT_RTU_RESPONSE:\r\nif ( numberofcharacters > 0 ){\r\nif ( packet_type == SBO_SELECT_RESPONSE ){\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_sbo_request_point, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\n}\r\nif ( packet_type == RESET_ACC_RESPONSE ){\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_resetacc_request_point, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\n}\r\n}\r\nbreak;\r\ncase SPECIAL_CALC_RESPONSE:\r\ncp2179_data_tree = proto_tree_add_subtree(cp2179_proto_tree, tvb, offset, numberofcharacters, ett_cp2179_data, NULL, "CP2179 Data Field");\r\nif (req_command_code == SPECIAL_CALC_ALL ){\r\ndo{\r\nspecialcalvalue = tvb_get_letohieee_float(tvb, offset );\r\nproto_tree_add_float_format(cp2179_data_tree, hf_cp2179_specialcalc, tvb, offset, 4, specialcalvalue,\r\n"Special Calculation %u : %f", point_num, specialcalvalue);\r\npoint_num += 1;\r\noffset += 4;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\n}\r\nelse if (req_command_code == SPECIAL_CALC_RANGE ){\r\ndo{\r\nspecialcalvalue = tvb_get_letohieee_float(tvb, offset );\r\nproto_tree_add_float_format(cp2179_data_tree, hf_cp2179_specialcalc, tvb, offset, 4, specialcalvalue,\r\n"Special Calculation %u : %f", request_data->requested_points[point_num], specialcalvalue);\r\npoint_num += 1;\r\noffset += 4;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\n}\r\nbreak;\r\ncase SCAN_INCLUSIVE_16_ANALOG_RESPONSE:\r\ncp2179_data_tree = proto_tree_add_subtree(cp2179_proto_tree, tvb, offset, numberofcharacters, ett_cp2179_data, NULL, "CP2179 Data Field");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [ %s ]", val_to_str_ext_const(req_command_code, &cp2179_CommandCodeNames_ext, "Unknown Command Code"));\r\ndo{\r\nanalogtestvalue = (gint16)tvb_get_letohs(tvb, offset);\r\nproto_tree_add_uint_format(cp2179_data_tree, hf_cp2179_analog_16bit, tvb, offset, 2, request_data->requested_points[point_num],\r\n"Analog (16 bit) %u : %i", request_data->requested_points[point_num], analogtestvalue);\r\npoint_num += 1;\r\noffset += 2;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\ncase BASIC_SCAN_RESPONSE_PACKET:\r\n{\r\ncp2179_data_tree = proto_tree_add_subtree(cp2179_proto_tree, tvb, offset, numberofcharacters, ett_cp2179_data, NULL, "CP2179 Data Field");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [ %s ]", val_to_str_ext_const(req_command_code, &cp2179_CommandCodeNames_ext, "Unknown Command Code"));\r\nswitch (req_command_code)\r\n{\r\ncase ACCUMULATOR_16_BIT:\r\ndo{\r\nanalogtestvalue = tvb_get_letohs(tvb, offset);\r\nproto_tree_add_uint_format(cp2179_data_tree, hf_cp2179_accumulator, tvb, offset, 2, analog16_num,\r\n"Accumulator %u : %u", analog16_num, analogtestvalue);\r\nanalog16_num += 1;\r\noffset += 2;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\ncase ANALOG_16_BIT:\r\ndo{\r\nanalogtestvalue =(gint16)tvb_get_letohs(tvb, offset);\r\nproto_tree_add_uint_format(cp2179_data_tree, hf_cp2179_analog_16bit, tvb, offset, 2, analog16_num,\r\n"Analog (16 bit) %u : %i", analog16_num, analogtestvalue);\r\nanalog16_num += 1;\r\noffset += 2;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\ncase SIMPLE_STATUS_DATA:\r\ndo{\r\ncp2179_subdata_item = proto_tree_add_bitmask(cp2179_data_tree, tvb, offset, hf_cp2179_simplestatusbit,\r\nett_cp2179_subdata, cp2179_simplestatus_bits, ENC_LITTLE_ENDIAN);\r\nproto_item_set_text(cp2179_subdata_item, "Simple Status Point 0x%x", simplestatusseq);\r\nsimplestatusseq += 1;\r\noffset += 2;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\ncase TWO_BIT_STATUS:\r\ndo{\r\ncp2179_subdata_item = proto_tree_add_bitmask(cp2179_data_tree, tvb, offset, hf_cp2179_2bitstatus,\r\nett_cp2179_subdata, cp2179_2bitstatus_bits, ENC_LITTLE_ENDIAN);\r\nproto_item_set_text(cp2179_subdata_item, "2 Bit Status Point 0x%x", simplestatusseq);\r\nsimplestatusseq += 1;\r\noffset += 2;\r\n}while(tvb_reported_length_remaining(tvb, offset) > 2);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\n}\r\nproto_tree_add_item(cp2179_proto_tree, hf_cp2179_crc, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\nif (!request_found) {\r\nproto_item_append_text(bs_response_item, ", No Request found");\r\nreturn 0;\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic bs_request_frame* copy_bs_request_frame(tvbuff_t *tvb )\r\n{\r\nguint offset = 0;\r\nguint8 idx=0 ;\r\nbs_request_frame *frame;\r\nguint16 num_objects=0;\r\nframe = wmem_new(wmem_file_scope(), bs_request_frame);\r\nframe->address_word = tvb_get_letohs(tvb, offset); offset +=2;\r\nframe->function_code = tvb_get_guint8(tvb, offset); offset +=1;\r\nframe->commmand_code = tvb_get_guint8(tvb, offset); offset +=1;\r\nframe->numberofcharacters = tvb_get_letohs(tvb, offset);offset +=2;\r\nif (frame->function_code == SCAN_INCLUSIVE) {\r\nguint8 startpt, endpt;\r\nstartpt = tvb_get_guint8(tvb, offset);\r\nendpt = tvb_get_guint8(tvb, offset+1);\r\nnum_objects = (endpt - startpt) + 1;\r\nframe->requested_points = (guint8 *)wmem_alloc(wmem_file_scope(), num_objects * sizeof(guint8));\r\nfor (idx = 0; idx < num_objects; idx++) {\r\nframe->requested_points[idx] = startpt;\r\nstartpt++;\r\n}\r\n}\r\nelse {\r\nnum_objects = frame->numberofcharacters;\r\nframe->requested_points = (guint8 *)wmem_alloc(wmem_file_scope(), num_objects * sizeof(guint8));\r\nfor (idx = 0; idx < num_objects; idx++) {\r\nframe->requested_points[idx] = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\n}\r\n}\r\nreturn frame;\r\n}\r\nstatic int\r\nclassify_packet_type(tvbuff_t *tvb)\r\n{\r\nint packet_type = -1;\r\nguint8 function_code;\r\nguint8 command_code;\r\nguint16 requestnumberofcharacters = 0;\r\nguint16 responsenumberofcharacters = 0;\r\nguint16 packet_length = 0;\r\npacket_length = tvb_reported_length(tvb);\r\nfunction_code = tvb_get_guint8(tvb, 2);\r\ncommand_code = tvb_get_guint8(tvb, 3);\r\nrequestnumberofcharacters = tvb_get_letohs(tvb, 4);\r\nresponsenumberofcharacters = tvb_get_letohs(tvb, 5);\r\nfunction_code = function_code & 0x3f ;\r\nswitch (function_code ){\r\ncase BASIC_SCAN:\r\nif ( (requestnumberofcharacters == 0) && (packet_length == BASIC_SCAN_REQ_LEN) ) {\r\npacket_type = BASIC_SCAN_QUERY_PACKET ;\r\n}\r\nelse if ( (responsenumberofcharacters > 0) && (packet_length > BASIC_SCAN_REQ_LEN) ) {\r\npacket_type = BASIC_SCAN_RESPONSE_PACKET;\r\n}\r\nbreak;\r\ncase SUPERVISORY_CONTROL:\r\nif ( (requestnumberofcharacters == 1) && (packet_length == SBO_SELECT_REQ_LEN) ) {\r\npacket_type = SBO_SELECT_REQUEST;\r\n}\r\nelse if ( (responsenumberofcharacters == 1) && (packet_length == SBO_SELECT_REPLY_LEN) ) {\r\npacket_type = SBO_SELECT_RESPONSE;\r\n}\r\nelse if (requestnumberofcharacters == 0) {\r\nif ( (packet_length == SBO_OPERATE_REQ_LEN) && (command_code == SBO_OPERATE) ) {\r\npacket_type = SBO_OPERATE_REQUEST;\r\n}\r\n}\r\nelse if (responsenumberofcharacters == 0) {\r\nif (packet_length == SBO_OPERATE_REPLY_LEN) {\r\npacket_type = SBO_OPERATE_RESPONSE;\r\n}\r\n}\r\nbreak;\r\ncase SCAN_FOR_SPECIAL_CALC:\r\nif ( (requestnumberofcharacters == 0) && (command_code == SPECIAL_CALC_ALL ) ) {\r\npacket_type = SPECIAL_CALC_REQUEST_ALL;\r\n}\r\nelse if ( (requestnumberofcharacters > 0) && (command_code == SPECIAL_CALC_RANGE ) ) {\r\npacket_type = SPECIAL_CALC_REQUEST_RANGE;\r\n}\r\nelse if ( (responsenumberofcharacters > 0) && (packet_length == (responsenumberofcharacters + 9) ) ) {\r\npacket_type = SPECIAL_CALC_RESPONSE;\r\n}\r\nbreak;\r\ncase SCAN_INCLUSIVE:\r\nif ( (responsenumberofcharacters > 0) ) {\r\npacket_type = SCAN_INCLUSIVE_16_ANALOG_RESPONSE;\r\n}\r\nif( (command_code == ANALOG_16_BIT) && (requestnumberofcharacters == 2) ) {\r\npacket_type = SCAN_INCLUSIVE_16_ANALOG_REQUEST;\r\n}\r\nbreak;\r\ncase RTU_CONFIG:\r\nif (responsenumberofcharacters == 0) {\r\npacket_type = INIT_RTU_RESPONSE;\r\n}\r\nif ( (requestnumberofcharacters == 0) && (command_code == INIT_RTU_CONFIGURATION) ) {\r\npacket_type = INIT_RTU_REQUEST;\r\n}\r\nif (responsenumberofcharacters == 1) {\r\npacket_type = RESET_ACC_RESPONSE;\r\n}\r\nif ( (requestnumberofcharacters == 1) && (command_code == RESET_ACCUMULATOR) ) {\r\npacket_type = RESET_ACC_REQUEST;\r\n}\r\nbreak;\r\ndefault :\r\npacket_type = -99;\r\nbreak;\r\n}\r\nreturn packet_type;\r\n}\r\nstatic int\r\ndissect_cp2179_pdu(tvbuff_t *cp2179_tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\ngint16 packet_type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "CP2179");\r\ncol_clear(pinfo->cinfo,COL_INFO);\r\npacket_type = classify_packet_type(cp2179_tvb);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", val_to_str_ext_const(packet_type, &cp2179_packettype_vals_ext, "Unknown Packet Type"));\r\nif (!pinfo->fd->flags.visited){\r\nconversation_t *conversation = NULL;\r\ncp2179_conversation *bs_conv_data = NULL;\r\nconversation = find_or_create_conversation(pinfo);\r\nbs_conv_data = (cp2179_conversation *)conversation_get_proto_data(conversation, proto_cp2179);\r\nif (bs_conv_data == NULL){\r\nbs_conv_data = wmem_new(wmem_file_scope(), cp2179_conversation);\r\nbs_conv_data->bs_request_frame_data = wmem_list_new(wmem_file_scope());\r\nconversation_add_proto_data(conversation, proto_cp2179, (void *)bs_conv_data);\r\n}\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_cp2179, 0, bs_conv_data);\r\nif ((packet_type == BASIC_SCAN_QUERY_PACKET) || (packet_type == SBO_SELECT_REQUEST)\r\n||(packet_type == SPECIAL_CALC_REQUEST_ALL)||(packet_type == SBO_OPERATE_REQUEST)\r\n||(packet_type == SPECIAL_CALC_REQUEST_RANGE)||(packet_type == INIT_RTU_REQUEST)\r\n||(packet_type == RESET_ACC_REQUEST)||(packet_type == SCAN_INCLUSIVE_16_ANALOG_REQUEST)) {\r\nbs_request_frame *frame_ptr = NULL;\r\nframe_ptr = copy_bs_request_frame(cp2179_tvb);\r\nframe_ptr->fnum = pinfo->num;\r\nwmem_list_prepend(bs_conv_data->bs_request_frame_data, frame_ptr);\r\n}\r\n}\r\nif (tvb_reported_length_remaining(cp2179_tvb, offset) > 0){\r\nswitch (packet_type){\r\ncase BASIC_SCAN_QUERY_PACKET:\r\ncase SBO_SELECT_REQUEST:\r\ncase SBO_OPERATE_REQUEST:\r\ncase SPECIAL_CALC_REQUEST_ALL:\r\ncase SPECIAL_CALC_REQUEST_RANGE:\r\ncase SCAN_INCLUSIVE_16_ANALOG_REQUEST:\r\ncase RESET_ACC_REQUEST:\r\ncase INIT_RTU_REQUEST:\r\ndissect_request_frame(cp2179_tvb, tree, pinfo, offset, packet_type);\r\nbreak;\r\ncase BASIC_SCAN_RESPONSE_PACKET:\r\ncase SBO_SELECT_RESPONSE:\r\ncase SBO_OPERATE_RESPONSE:\r\ncase SPECIAL_CALC_RESPONSE:\r\ncase SCAN_INCLUSIVE_16_ANALOG_RESPONSE:\r\ncase INIT_RTU_RESPONSE:\r\ncase RESET_ACC_RESPONSE:\r\ndissect_bs_response_frame(cp2179_tvb, tree, pinfo, offset, packet_type);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn tvb_reported_length(cp2179_tvb);\r\n}\r\nstatic int\r\ndissect_cp2179(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\ntvbuff_t *cp2179_tvb;\r\ngint length = tvb_reported_length(tvb);\r\nif(length < CP2179_MIN_LENGTH){\r\nreturn 0;\r\n}\r\nif((pinfo->srcport) && cp2179_telnet_clean){\r\ncp2179_tvb = clean_telnet_iac(pinfo, tvb, 0, length);\r\n}\r\nelse{\r\ncp2179_tvb = tvb_new_subset_length( tvb, 0, length);\r\n}\r\ndissect_cp2179_pdu(cp2179_tvb, pinfo, tree, data);\r\nreturn length;\r\n}\r\nvoid\r\nproto_register_cp2179(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_cp2179_request_frame,\r\n{ "Request Frame", "cp2179.request_frame",\r\nFT_FRAMENUM, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_rtu_address,\r\n{ "RTU Address", "cp2179.RTUAddress",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x7FF,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_master_address,\r\n{ "Master Address", "cp2179.MasterAddress",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0xF800,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_function_code,\r\n{ "Function Code", "cp2179.functioncode",\r\nFT_UINT8, BASE_HEX,\r\nVALS(FunctionCodenames), 0x3F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_nop_flag,\r\n{ "NOP Flag", "cp2179.nop_flag",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_rst_flag,\r\n{ "RST Flag", "cp2179.rst_flag",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_reserved,\r\n{ "Reserved Bits", "cp2179.Reserved",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0xC0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_command_code,\r\n{ "Command Code", "cp2179.commandcode",\r\nFT_UINT8, BASE_HEX,\r\nVALS(cp2179_CommandCodeNames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_command_code_fc20,\r\n{ "Command Code (FC 0x20)", "cp2179.commandcodeinitrtu",\r\nFT_UINT8, BASE_HEX,\r\nVALS(cp2179_FC20_CommandCodeNames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_status_byte,\r\n{ "RTU Status", "cp2179.rtustatus",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_port_status_byte,\r\n{ "Port Status", "cp2179.portstatus",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_sbo_request_point,\r\n{ "SBO Request Point", "cp2179.sbo_requestpoint",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_resetacc_request_point,\r\n{ "Reset Accumulator Request Point", "cp2179.resetacc_requestpoint",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_speccalc_request_point,\r\n{ "Special Calc Request Point", "cp2179.speccalc_requestpoint",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_scaninc_startreq_point,\r\n{ "Start Request Point", "cp2179.scaninc_startreq_point",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_scaninc_stopreq_point,\r\n{ "Stop Request Point", "cp2179.scaninc_stopreq_point",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_number_characters,\r\n{ "Number of Characters", "cp2179.numberofcharacters",\r\nFT_UINT16, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_crc,\r\n{ "CRC", "cp2179.crc",\r\nFT_UINT16, BASE_HEX,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_cp2179_data_field,\r\n{ "Data Field", "cp2179.datafield",\r\nFT_UINT8, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_cp2179_accumulator,\r\n{ "Accumulator", "cp2179.accumulator",\r\nFT_UINT16, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_specialcalc,\r\n{ "Special Calc", "cp2179.specialcalc",\r\nFT_FLOAT, BASE_NONE,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_analog_16bit,\r\n{ "Analog 16-bit", "cp2179.analogdata",\r\nFT_UINT16, BASE_DEC,\r\n0x0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit,\r\n{ "Simple Status Bit", "cp2179.simplestatusbit",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit0,\r\n{ "Simple Status bit 0", "cp2179.simplestatusbit0",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0001,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit1,\r\n{ "Simple Status bit 1", "cp2179.simplestatusbit1",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0002,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit2,\r\n{ "Simple Status bit 2", "cp2179.simplestatusbit2",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0004,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit3,\r\n{ "Simple Status bit 3", "cp2179.simplestatusbit3",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0008,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit4,\r\n{ "Simple Status bit 4", "cp2179.simplestatusbit4",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0010,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit5,\r\n{ "Simple Status bit 5", "cp2179.simplestatusbit5",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0020,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit6,\r\n{ "Simple Status bit 6", "cp2179.simplestatusbit6",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0040,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit7,\r\n{ "Simple Status bit 7", "cp2179.simplestatusbit7",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0080,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit8,\r\n{ "Simple Status bit 8", "cp2179.simplestatusbit8",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0100,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit9,\r\n{ "Simple Status bit 9", "cp2179.simplestatusbit9",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0200,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit10,\r\n{ "Simple Status bit 10", "cp2179.simplestatusbit10",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0400,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit11,\r\n{ "Simple Status bit 11", "cp2179.simplestatusbit11",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0800,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit12,\r\n{ "Simple Status bit 12", "cp2179.simplestatusbit12",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x1000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit13,\r\n{ "Simple Status bit 13", "cp2179.simplestatusbit13",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x2000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit14,\r\n{ "Simple Status bit 14", "cp2179.simplestatusbit14",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x4000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_simplestatusbit15,\r\n{ "Simple Status bit 15", "cp2179.simplestatusbit15",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x8000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatus,\r\n{ "2 Bit Status", "cp2179.twobitstatus",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg0,\r\n{ "2 Bit Status Change 0", "cp2179.twobitstatuschg0",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0001,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg1,\r\n{ "2 Bit Status Change 1", "cp2179.twobitstatuschg1",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0002,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg2,\r\n{ "2 Bit Status Change 2", "cp2179.twobitstatuschg2",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0004,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg3,\r\n{ "2 Bit Status Change 3", "cp2179.twobitstatuschg3",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0008,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg4,\r\n{ "2 Bit Status Change 4", "cp2179.twobitstatuschg4",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0010,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg5,\r\n{ "2 Bit Status Change 5", "cp2179.twobitstatuschg5",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0020,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg6,\r\n{ "2 Bit Status Change 6", "cp2179.twobitstatuschg6",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0040,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatuschg7,\r\n{ "2 Bit Status Change 7", "cp2179.twobitstatuschg7",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0080,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus0,\r\n{ "2 Bit Status bit 0", "cp2179.twobitstatusbit0",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0100,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus1,\r\n{ "2 Bit Status bit 1", "cp2179.twobitstatusbit1",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0200,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus2,\r\n{ "2 Bit Status bit 2", "cp2179.twobitstatusbit2",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0400,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus3,\r\n{ "2 Bit Status bit 3", "cp2179.twobitstatusbit3",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x0800,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus4,\r\n{ "2 Bit Status bit 4", "cp2179.twobitstatusbit4",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x1000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus5,\r\n{ "2 Bit Status bit 5", "cp2179.twobitstatusbit5",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x2000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus6,\r\n{ "2 Bit Status bit 6", "cp2179.twobitstatusbit6",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x4000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cp2179_2bitstatusstatus7,\r\n{ "2 Bit Status bit 7", "cp2179.twobitstatusbit7",\r\nFT_BOOLEAN, 16,\r\nNULL, 0x8000,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_cp2179,\r\n&ett_cp2179_header,\r\n&ett_cp2179_addr,\r\n&ett_cp2179_fc,\r\n&ett_cp2179_data,\r\n&ett_cp2179_subdata\r\n};\r\nmodule_t *cp2179_module;\r\nproto_cp2179 = proto_register_protocol ("CP2179 Protocol", "CP2179", "cp2179");\r\ncp2179_handle = register_dissector("cp2179", dissect_cp2179, proto_cp2179);\r\nproto_register_field_array(proto_cp2179, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\ncp2179_module = prefs_register_protocol(proto_cp2179, proto_reg_handoff_cp2179);\r\nprefs_register_uint_preference(cp2179_module, "tcp.port", "CP 2179 Protocol Port",\r\n"Set the TCP port for CP 2179 Protocol packets (if other"\r\n" than the default of 0)",\r\n10, &global_cp2179_tcp_port);\r\nprefs_register_bool_preference(cp2179_module, "telnetclean",\r\n"Enable Automatic pre-processing of Telnet-encapsulated data to remove extra 0xFF (IAC) bytes",\r\n"Whether the SEL Protocol dissector should automatically pre-process Telnet data to remove IAC bytes",\r\n&cp2179_telnet_clean);\r\n}\r\nvoid\r\nproto_reg_handoff_cp2179(void)\r\n{\r\nstatic int cp2179_prefs_initialized = FALSE;\r\nstatic unsigned int cp2179_port;\r\nif (!cp2179_prefs_initialized){\r\ncp2179_prefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("tcp.port", cp2179_port, cp2179_handle);\r\n}\r\ncp2179_port = global_cp2179_tcp_port;\r\ndissector_add_uint("tcp.port", cp2179_port, cp2179_handle);\r\ndissector_add_for_decode_as("rtacser.data", cp2179_handle);\r\n}

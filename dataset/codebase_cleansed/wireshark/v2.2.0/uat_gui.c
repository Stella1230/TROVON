static void set_buttons(uat_t *uat, gint row) {\r\nif (!uat->rep) return;\r\nif (row > 0) {\r\ngtk_widget_set_sensitive (uat->rep->bt_up, TRUE);\r\n} else {\r\ngtk_widget_set_sensitive (uat->rep->bt_up, FALSE);\r\n}\r\nif (row < (gint)(uat->raw_data->len - 1) && row >= 0) {\r\ngtk_widget_set_sensitive (uat->rep->bt_down, TRUE);\r\n} else {\r\ngtk_widget_set_sensitive (uat->rep->bt_down, FALSE);\r\n}\r\ngtk_widget_set_sensitive (uat->rep->bt_new, TRUE);\r\ngtk_widget_set_sensitive (uat->rep->bt_clear, TRUE);\r\nif (row < 0) {\r\ngtk_widget_set_sensitive (uat->rep->bt_edit, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_copy, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_delete, FALSE);\r\n} else {\r\ngtk_widget_set_sensitive (uat->rep->bt_edit, TRUE);\r\ngtk_widget_set_sensitive (uat->rep->bt_copy, TRUE);\r\ngtk_widget_set_sensitive (uat->rep->bt_delete, TRUE);\r\n}\r\nif (uat->changed) {\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, uat_window_delete_event_cb, uat);\r\ng_signal_connect(uat->rep->window, "delete_event", G_CALLBACK(unsaved_dialog), uat);\r\ng_signal_connect(uat->rep->window, "destroy", G_CALLBACK(unsaved_dialog), uat);\r\n} else {\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, unsaved_dialog, uat);\r\ng_signal_connect(GTK_WINDOW(uat->rep->window), "delete_event", G_CALLBACK(uat_window_delete_event_cb), uat);\r\ng_signal_connect(GTK_WINDOW(uat->rep->window), "destroy", G_CALLBACK(uat_window_delete_event_cb), uat);\r\n}\r\n}\r\nstatic void limit_buttons(uat_t *uat) {\r\nif (!uat->rep) return;\r\ngtk_widget_set_sensitive (uat->rep->bt_up, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_down, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_new, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_edit, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_copy, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_delete, FALSE);\r\ngtk_widget_set_sensitive (uat->rep->bt_clear, FALSE);\r\n}\r\nstatic char *fld_tostr(void *rec, uat_field_t *f) {\r\nguint len;\r\nchar *ptr;\r\nchar *out;\r\nf->cb.tostr(rec, &ptr, &len, f->cbdata.tostr, f->fld_data);\r\nswitch(f->mode) {\r\ncase PT_TXTMOD_NONE:\r\ncase PT_TXTMOD_STRING:\r\ncase PT_TXTMOD_ENUM:\r\ncase PT_TXTMOD_FILENAME:\r\ncase PT_TXTMOD_DIRECTORYNAME:\r\nout = g_strndup(ptr, len);\r\nbreak;\r\ncase PT_TXTMOD_HEXBYTES: {\r\nGString *s = g_string_sized_new( len*2 + 1 );\r\nguint i;\r\nfor (i=0; i<len;i++) g_string_append_printf(s, "%.2X", ((const guint8*)ptr)[i]);\r\nout = g_strdup(s->str);\r\ng_string_free(s, TRUE);\r\nbreak;\r\n}\r\ndefault:\r\ng_assert_not_reached();\r\nout = NULL;\r\nbreak;\r\n}\r\ng_free(ptr);\r\nreturn out;\r\n}\r\nstatic void append_row(uat_t *uat, guint idx) {\r\nvoid *rec = UAT_INDEX_PTR(uat, idx);\r\nuat_field_t *f = uat->fields;\r\nguint colnum;\r\nGtkTreeIter iter;\r\ngchar* tmp_str;\r\nif (! uat->rep) return;\r\ngtk_list_store_insert_before(uat->rep->list_store, &iter, NULL);\r\nfor ( colnum = 0; colnum < uat->ncols; colnum++ ) {\r\ntmp_str = fld_tostr(rec, &(f[colnum]));\r\ngtk_list_store_set(uat->rep->list_store, &iter, colnum, tmp_str, -1);\r\ng_free(tmp_str);\r\n}\r\n}\r\nstatic void reset_row(uat_t *uat, guint idx) {\r\nvoid *rec = UAT_INDEX_PTR(uat, idx);\r\nuat_field_t *f = uat->fields;\r\nguint colnum;\r\nGtkTreePath *path;\r\nGtkTreeIter iter;\r\ngchar* tmp_str;\r\nif (! uat->rep) return;\r\npath = gtk_tree_path_new_from_indices(idx, -1);\r\nif (!path || !gtk_tree_model_get_iter(GTK_TREE_MODEL(uat->rep->list_store), &iter, path)) {\r\nreturn;\r\n}\r\nfor ( colnum = 0; colnum < uat->ncols; colnum++ ) {\r\ntmp_str = fld_tostr(rec, &(f[colnum]));\r\ngtk_list_store_set(uat->rep->list_store, &iter, colnum, tmp_str, -1);\r\ng_free(tmp_str);\r\n}\r\n}\r\nstatic guint8 *unhexbytes(const char *si, guint len, guint *len_p, char** err) {\r\nguint8 *buf;\r\nguint8 *p;\r\nconst guint8 *s = (const guint8 *)si;\r\nguint i;\r\nif (len % 2) {\r\n*err = g_strdup_printf("Uneven number of chars hex string %u \n'%s'", len, si);\r\nreturn NULL;\r\n}\r\nbuf = (guint8 *)g_malloc(len/2+1);\r\np = buf;\r\nfor (i = 0; i<len ; i += 2) {\r\nguint8 lo = s[i+1];\r\nguint8 hi = s[i];\r\nif (hi >= '0' && hi <= '9') {\r\nhi -= '0';\r\n} else if (hi >= 'a' && hi <= 'f') {\r\nhi -= 'a';\r\nhi += 0xa;\r\n} else if (hi >= 'A' && hi <= 'F') {\r\nhi -= 'A';\r\nhi += 0xa;\r\n} else {\r\ngoto on_error;\r\n}\r\nif (lo >= '0' && lo <= '9') {\r\nlo -= '0';\r\n} else if (lo >= 'a' && lo <= 'f') {\r\nlo -= 'a';\r\nlo += 0xa;\r\n} else if (lo >= 'A' && lo <= 'F') {\r\nlo -= 'A';\r\nlo += 0xa;\r\n} else {\r\ngoto on_error;\r\n}\r\n*(p++) = (hi*0x10) + lo;\r\n}\r\nlen /= 2;\r\nif (len_p) *len_p = len;\r\nbuf[len] = '\0';\r\n*err = NULL;\r\nreturn buf;\r\non_error:\r\n*err = g_strdup("Error parsing hex string");\r\nreturn NULL;\r\n}\r\nstatic gboolean uat_dlg_cb(GtkWidget *win _U_, gpointer user_data) {\r\nstruct _uat_dlg_data *dd = (struct _uat_dlg_data *)user_data;\r\nguint ncols = dd->uat->ncols;\r\nuat_field_t *f = dd->uat->fields;\r\nchar *err = NULL, *tmp_err = NULL;\r\nguint colnum;\r\nfor ( colnum = 0; colnum < ncols; colnum++ ) {\r\nvoid *e = g_ptr_array_index(dd->entries, colnum);\r\nconst char *text = NULL;\r\nchar *text_free = NULL;\r\nguint len = 0;\r\nswitch(f[colnum].mode) {\r\ncase PT_TXTMOD_FILENAME:\r\ncase PT_TXTMOD_DIRECTORYNAME:\r\ntext = text_free = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(e));\r\nif (text) {\r\nlen = (unsigned) strlen(text);\r\n} else {\r\ntext = "";\r\nlen = 0;\r\n}\r\nbreak;\r\ncase PT_TXTMOD_STRING:\r\ntext = gtk_entry_get_text(GTK_ENTRY(e));\r\nlen = (unsigned) strlen(text);\r\nbreak;\r\ncase PT_TXTMOD_HEXBYTES: {\r\ntext = gtk_entry_get_text(GTK_ENTRY(e));\r\ntext_free = unhexbytes(text, (guint) strlen(text), &len, &err);\r\ntext = (const char *)text_free;\r\nif (err) {\r\ntmp_err = err;\r\nerr = g_strdup_printf("error in field '%s': %s", f[colnum].title, tmp_err);\r\ng_free(tmp_err);\r\ngoto on_failure;\r\n}\r\nbreak;\r\n}\r\ncase PT_TXTMOD_ENUM: {\r\ngint idx = *(int*)e;\r\ntext = (idx >= 0) ? ((const value_string *)(f[colnum].fld_data))[idx].strptr : "";\r\nlen = (unsigned) strlen(text);\r\nbreak;\r\n}\r\ncase PT_TXTMOD_NONE: break;\r\ndefault:\r\ng_assert_not_reached();\r\nreturn FALSE;\r\n}\r\nif (f[colnum].cb.chk) {\r\nif (! f[colnum].cb.chk(dd->rec, text, len, f[colnum].cbdata.chk, f[colnum].fld_data, &err)) {\r\ntmp_err = err;\r\nerr = g_strdup_printf("error in column '%s': %s", f[colnum].title, tmp_err);\r\ng_free(tmp_err);\r\ngoto on_failure;\r\n}\r\n}\r\nf[colnum].cb.set(dd->rec, text, len, f[colnum].cbdata.set, f[colnum].fld_data);\r\ng_free(text_free);\r\n}\r\nif (dd->uat->update_cb) {\r\nif (!dd->uat->update_cb(dd->rec, &err)) {\r\ntmp_err = err;\r\nerr = g_strdup_printf("error updating record: %s", tmp_err);\r\ng_free(tmp_err);\r\ngoto on_failure;\r\n}\r\n}\r\nif (dd->is_new) {\r\nvoid *rec_tmp = dd->rec;\r\ndd->rec = uat_add_record(dd->uat, dd->rec, TRUE);\r\nif (dd->uat->free_cb) {\r\ndd->uat->free_cb(rec_tmp);\r\n}\r\ng_free(rec_tmp);\r\n} else {\r\nuat_update_record(dd->uat, dd->rec, TRUE);\r\n}\r\ndd->uat->changed = TRUE;\r\nset_buttons(dd->uat, dd->uat->rep ? dd->uat->rep->selected : -1);\r\nif (dd->is_new) {\r\nappend_row(dd->uat, dd->uat->raw_data->len - 1 );\r\n} else {\r\nreset_row(dd->uat, dd->row);\r\n}\r\ng_ptr_array_free(dd->entries, TRUE);\r\nwindow_destroy(GTK_WIDGET(dd->win));\r\nif (dd->uat->rep)\r\nwindow_present(GTK_WIDGET(dd->uat->rep->window));\r\nwhile (dd->tobe_freed->len) g_free( g_ptr_array_remove_index_fast(dd->tobe_freed, dd->tobe_freed->len - 1 ) );\r\ng_free(dd);\r\nreturn TRUE;\r\non_failure:\r\nreport_failure("%s", err);\r\ng_free(err);\r\nreturn FALSE;\r\n}\r\nstatic gboolean uat_cancel_dlg_cb(GtkWidget *win _U_, gpointer user_data) {\r\nstruct _uat_dlg_data *dd = (struct _uat_dlg_data *)user_data;\r\nif (dd->uat->rep)\r\nwindow_present(GTK_WIDGET(dd->uat->rep->window));\r\nset_buttons(dd->uat, dd->uat->rep ? dd->uat->rep->selected : -1);\r\nif (dd->is_new) g_free(dd->rec);\r\ng_ptr_array_free(dd->entries, TRUE);\r\nwindow_destroy(GTK_WIDGET(dd->win));\r\nwhile (dd->tobe_freed->len) g_free( g_ptr_array_remove_index_fast(dd->tobe_freed, dd->tobe_freed->len - 1 ) );\r\ng_free(dd);\r\nreturn TRUE;\r\n}\r\nstatic void fld_combo_box_changed_cb(GtkComboBox *combo_box, gpointer user_data) {\r\nint *valptr = (int *)user_data;\r\n*valptr = gtk_combo_box_get_active(combo_box);\r\n}\r\nstatic void uat_edit_dialog(uat_t *uat, gint row, gboolean copy) {\r\nGtkWidget *win, *main_grid, *main_vb, *bbox, *bt_cancel, *bt_ok;\r\nstruct _uat_dlg_data *dd = (struct _uat_dlg_data *)g_malloc(sizeof(struct _uat_dlg_data));\r\nuat_field_t *f = uat->fields;\r\nguint colnum;\r\ngchar *tmp_str;\r\nlimit_buttons(uat);\r\ndd->entries = g_ptr_array_new();\r\ntmp_str = g_strdup_printf("%s: %s", uat->name, (row == -1 ? "New" : "Edit"));\r\ndd->win = dlg_conf_window_new(tmp_str);\r\ng_free(tmp_str);\r\ndd->uat = uat;\r\nif (copy && row >= 0) {\r\ndd->rec = g_malloc0(uat->record_size);\r\nif (uat->copy_cb) {\r\nuat->copy_cb (dd->rec, UAT_INDEX_PTR(uat, row), uat->record_size);\r\n}\r\ndd->is_new = TRUE;\r\n} else if (row >= 0) {\r\ndd->rec = UAT_INDEX_PTR(uat, row);\r\ndd->is_new = FALSE;\r\n} else {\r\ndd->rec = g_malloc0(uat->record_size);\r\ndd->is_new = TRUE;\r\n}\r\ndd->row = row;\r\ndd->tobe_freed = g_ptr_array_new();\r\nwin = dd->win;\r\ngtk_window_set_resizable(GTK_WINDOW(win), FALSE);\r\ngtk_window_resize(GTK_WINDOW(win), 400, 30*(uat->ncols+2));\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_add(GTK_CONTAINER(win), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 5);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 10);\r\nbbox = dlg_button_row_new(GTK_STOCK_CANCEL, GTK_STOCK_OK, NULL);\r\ngtk_box_pack_end(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\nbt_ok = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(bt_ok, "clicked", G_CALLBACK(uat_dlg_cb), dd);\r\nbt_cancel = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(bt_cancel, "clicked", G_CALLBACK(uat_cancel_dlg_cb), dd);\r\nwindow_set_cancel_button(win, bt_cancel, NULL);\r\nfor ( colnum = 0; colnum < uat->ncols; colnum++ ) {\r\nGtkWidget *entry, *label, *event_box;\r\nchar *text = fld_tostr(dd->rec, &(f[colnum]));\r\nchar *label_text;\r\ngchar *fc_filename;\r\nevent_box = gtk_event_box_new();\r\nlabel_text = g_strdup_printf("%s:", f[colnum].title);\r\nlabel = gtk_label_new(label_text);\r\nif (f[colnum].desc != NULL)\r\ngtk_widget_set_tooltip_text(event_box, f[colnum].desc);\r\ng_free(label_text);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), event_box, 0, colnum, 1, 1);\r\ngtk_container_add(GTK_CONTAINER(event_box), label);\r\nswitch(f[colnum].mode) {\r\ncase PT_TXTMOD_FILENAME:\r\ncase PT_TXTMOD_DIRECTORYNAME:\r\nentry = gtk_file_chooser_button_new(f[colnum].desc,\r\n(f[colnum].mode == PT_TXTMOD_FILENAME) ? GTK_FILE_CHOOSER_ACTION_OPEN : GTK_FILE_CHOOSER_ACTION_SELECT_FOLDER);\r\nif (! dd->is_new || copy) {\r\ngtk_file_chooser_set_filename(GTK_FILE_CHOOSER(entry), text);\r\n}\r\nfc_filename = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(entry));\r\nif (!fc_filename) {\r\ngtk_file_chooser_set_filename(GTK_FILE_CHOOSER(entry), get_datafile_dir());\r\n}\r\ng_free(fc_filename);\r\ng_ptr_array_add(dd->entries, entry);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), entry, 1, colnum, 1, 1);\r\nbreak;\r\ncase PT_TXTMOD_NONE:\r\ncase PT_TXTMOD_STRING:\r\ncase PT_TXTMOD_HEXBYTES:\r\nentry = gtk_entry_new();\r\nif (! dd->is_new || copy) {\r\ngtk_entry_set_text(GTK_ENTRY(entry), text);\r\n}\r\ng_ptr_array_add(dd->entries, entry);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), entry, 1, colnum, 1, 1);\r\nif (f[colnum].mode != PT_TXTMOD_NONE)\r\ndlg_set_activate(entry, bt_ok);\r\nelse\r\ngtk_editable_set_editable(GTK_EDITABLE(entry), FALSE);\r\nbreak;\r\ncase PT_TXTMOD_ENUM: {\r\nGtkWidget *combo_box;\r\nint idx;\r\nconst value_string *enum_vals = (const value_string *)f[colnum].fld_data;\r\nint *valptr = (int *)g_malloc(sizeof(int));\r\ncombo_box = gtk_combo_box_text_new();\r\n*valptr = -1;\r\nfor (idx = 0; enum_vals[idx].strptr != NULL; idx++) {\r\nconst char *str = enum_vals[idx].strptr;\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(combo_box), str);\r\nif ( g_str_equal(str, text) ) {\r\n*valptr = idx;\r\n}\r\n}\r\ng_ptr_array_add(dd->entries, valptr);\r\ng_ptr_array_add(dd->tobe_freed, valptr);\r\nif (*valptr != -1)\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(combo_box), *valptr);\r\ng_signal_connect(combo_box, "changed", G_CALLBACK(fld_combo_box_changed_cb), valptr);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), combo_box, 1, colnum, 1, 1);\r\nbreak;\r\n}\r\ndefault:\r\ng_assert_not_reached();\r\nreturn;\r\n}\r\ng_free(text);\r\n}\r\ngtk_widget_grab_default(bt_ok);\r\ngtk_widget_show_all(win);\r\n}\r\nstatic void uat_del_cb(GtkButton *button _U_, gpointer u) {\r\nstruct _uat_del *ud = (struct _uat_del *)u;\r\nGtkTreeIter iter;\r\nGtkTreePath *path;\r\nuat_remove_record_idx(ud->uat, ud->idx);\r\nif (ud->uat->rep) {\r\npath = gtk_tree_path_new_from_indices(ud->idx, -1);\r\nif (path && gtk_tree_model_get_iter(GTK_TREE_MODEL(ud->uat->rep->list_store), &iter, path)) {\r\ngtk_list_store_remove(ud->uat->rep->list_store, &iter);\r\n}\r\n}\r\nud->uat->changed = TRUE;\r\nset_buttons(ud->uat, -1);\r\nwindow_destroy(GTK_WIDGET(ud->win));\r\nif (ud->uat->rep)\r\nwindow_present(GTK_WIDGET(ud->uat->rep->window));\r\ng_free(ud);\r\n}\r\nstatic void uat_cancel_del_cb(GtkButton *button _U_, gpointer u) {\r\nstruct _uat_del *ud = (struct _uat_del *)u;\r\nwindow_destroy(GTK_WIDGET(ud->win));\r\nset_buttons(ud->uat, ud->uat->rep ? ud->uat->rep->selected : -1);\r\nif (ud->uat->rep)\r\nwindow_present(GTK_WIDGET(ud->uat->rep->window));\r\ng_free(ud);\r\n}\r\nstatic void uat_del_dlg(uat_t *uat, int idx) {\r\nGtkWidget *win, *main_grid, *main_vb, *bbox, *bt_cancel, *bt_ok;\r\nuat_field_t *f = uat->fields;\r\nguint colnum;\r\nvoid *rec = UAT_INDEX_PTR(uat, idx);\r\ngchar *tmp_str;\r\nstruct _uat_del *ud = (struct _uat_del *)g_malloc(sizeof(struct _uat_del));\r\nlimit_buttons(uat);\r\nud->uat = uat;\r\nud->idx = idx;\r\ntmp_str = g_strdup_printf("%s: Confirm Delete", uat->name);\r\nud->win = win = dlg_conf_window_new(tmp_str);\r\ng_free(tmp_str);\r\ngtk_window_set_resizable(GTK_WINDOW(win), FALSE);\r\ngtk_window_resize(GTK_WINDOW(win), 400, 25*(uat->ncols+2));\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_add(GTK_CONTAINER(win), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 15);\r\nfor ( colnum = 0; colnum < uat->ncols; colnum++ ) {\r\nGtkWidget *label;\r\nchar *text = fld_tostr(rec, &(f[colnum]));\r\ntmp_str = g_strdup_printf("%s:", f[colnum].title);\r\nlabel = gtk_label_new(tmp_str);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, colnum, 1, 1);\r\ng_free(tmp_str);\r\nlabel = gtk_label_new(text);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 1, colnum, 1, 1);\r\ng_free(text);\r\n}\r\nbbox = dlg_button_row_new(GTK_STOCK_CANCEL, GTK_STOCK_DELETE, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\nbt_ok = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_DELETE);\r\ng_signal_connect(bt_ok, "clicked", G_CALLBACK(uat_del_cb), ud);\r\nbt_cancel = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(bt_cancel, "clicked", G_CALLBACK(uat_cancel_del_cb), ud);\r\nwindow_set_cancel_button( win, bt_cancel, NULL);\r\ngtk_widget_show_all(win);\r\n}\r\nstatic void uat_new_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\nif (! uat->rep) return;\r\nuat_edit_dialog(uat, -1, FALSE);\r\n}\r\nstatic void uat_edit_cb(GtkWidget *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\nif (! uat->rep) return;\r\nuat_edit_dialog(uat, uat->rep->selected, FALSE);\r\n}\r\nstatic void uat_copy_cb(GtkWidget *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\nif (! uat->rep) return;\r\nuat_edit_dialog(uat, uat->rep->selected, TRUE);\r\n}\r\nstatic void uat_double_click_cb(GtkWidget *tv, GtkTreePath *path _U_, GtkTreeViewColumn *column _U_, gpointer u) {\r\nuat_edit_cb(tv, u);\r\n}\r\nstatic void uat_delete_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\nif (! uat->rep) return;\r\nuat_del_dlg(uat, uat->rep->selected);\r\n}\r\nstatic gboolean uat_window_delete_event_cb(GtkWindow *w _U_, GdkEvent *e _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\nif (uat->rep) {\r\nvoid *rep = uat->rep;\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, uat_window_delete_event_cb, uat);\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, unsaved_dialog, uat);\r\ngtk_widget_destroy(uat->rep->window);\r\nuat->rep = NULL;\r\ng_free(rep);\r\n}\r\nreturn TRUE;\r\n}\r\nstatic void uat_up_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngint row = uat->rep->selected;\r\ng_assert(row > 0);\r\nuat_swap(uat, row, row-1);\r\ntree_view_list_store_move_selection(uat->rep->list, TRUE);\r\nuat->changed = TRUE;\r\nrow -= 1;\r\nuat->rep->selected = row;\r\nset_buttons(uat, row);\r\n}\r\nstatic void uat_down_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngint row = uat->rep->selected;\r\ng_assert(row >= 0 && (guint) row < uat->raw_data->len - 1);\r\nuat_swap(uat, row, row+1);\r\ntree_view_list_store_move_selection(uat->rep->list, FALSE);\r\nuat->changed = TRUE;\r\nrow += 1;\r\nuat->rep->selected = row;\r\nset_buttons(uat, row);\r\n}\r\nstatic void uat_apply_changes(uat_t *uat) {\r\nif (uat->flags & UAT_AFFECTS_FIELDS) {\r\nmain_fields_changed ();\r\n} else {\r\nif (uat->flags & UAT_AFFECTS_DISSECTION) {\r\nif (cfile.state != FILE_CLOSED) {\r\nredissect_packets ();\r\nredissect_all_packet_windows ();\r\n}\r\n}\r\n}\r\n}\r\nstatic void uat_cancel_cb(GtkWidget *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngchar *err = NULL;\r\nif (uat->changed) {\r\nuat_clear(uat);\r\nif (!uat_load(uat, &err)) {\r\nreport_failure("Error while loading %s: %s", uat->name, err);\r\ng_free(err);\r\n}\r\nuat_apply_changes (uat);\r\n}\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, uat_window_delete_event_cb, uat);\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, unsaved_dialog, uat);\r\ngtk_widget_destroy(uat->rep->window);\r\ng_free(uat->rep);\r\nuat->rep = NULL;\r\n}\r\nstatic void uat_apply_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\nif (uat->changed) {\r\nif (uat->post_update_cb) uat->post_update_cb();\r\nuat_apply_changes (uat);\r\n}\r\n}\r\nstatic void uat_ok_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngchar *err = NULL;\r\nif (uat->changed) {\r\nif (!uat_save(uat, &err)) {\r\nreport_failure("Error while saving %s: %s", uat->name, err);\r\ng_free(err);\r\n}\r\nif (uat->post_update_cb) uat->post_update_cb();\r\nuat_apply_changes (uat);\r\n}\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, uat_window_delete_event_cb, uat);\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, unsaved_dialog, uat);\r\ngtk_widget_destroy(uat->rep->window);\r\ng_free(uat->rep);\r\nuat->rep = NULL;\r\n}\r\nstatic void uat_clear_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngtk_list_store_clear(uat->rep->list_store);\r\nuat_clear(uat);\r\nuat->changed = TRUE;\r\n}\r\nstatic void uat_refresh_cb(GtkButton *button _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngchar *err = NULL;\r\nguint i;\r\ngboolean success;\r\nuat_clear_cb(button, u);\r\nuat->from_global = TRUE;\r\nsuccess = uat_load(uat, &err);\r\nuat->from_global = FALSE;\r\nuat->changed = TRUE;\r\nif (!success) {\r\nreport_failure("Error while loading %s: %s", uat->name, err);\r\ng_free(err);\r\n}\r\nfor (i = 0 ; i < uat->raw_data->len; i++) {\r\nappend_row(uat, i);\r\n}\r\n}\r\nstatic void remember_selected_row(GtkWidget *w _U_, gpointer u) {\r\nuat_t *uat = (uat_t *)u;\r\ngint row;\r\nrow = tree_view_list_store_get_selected_row(uat->rep->list);\r\nuat->rep->selected = row;\r\ngtk_widget_set_sensitive (uat->rep->bt_edit, TRUE);\r\ngtk_widget_set_sensitive (uat->rep->bt_copy, uat->copy_cb ? TRUE : FALSE);\r\ngtk_widget_set_sensitive(uat->rep->bt_delete, TRUE);\r\nset_buttons(uat, row);\r\n}\r\nstatic void uat_yessave_cb(GtkWindow *w _U_, void *u) {\r\nuat_t *uat = (uat_t *)u;\r\ngchar *err = NULL;\r\nwindow_delete_event_cb(uat->rep->unsaved_window, NULL, NULL);\r\nif (!uat_save(uat, &err)) {\r\nreport_failure("Error while saving %s: %s", uat->name, err);\r\ng_free(err);\r\n}\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, uat_window_delete_event_cb, uat);\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, unsaved_dialog, uat);\r\nwindow_destroy(uat->rep->window);\r\ng_free(uat->rep);\r\nuat->rep = NULL;\r\n}\r\nstatic void uat_nosave_cb(GtkWindow *w _U_, void *u) {\r\nuat_t *uat = (uat_t *)u;\r\nwindow_delete_event_cb(uat->rep->unsaved_window, NULL, NULL);\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, uat_window_delete_event_cb, uat);\r\ng_signal_handlers_disconnect_by_func(uat->rep->window, unsaved_dialog, uat);\r\nwindow_destroy(uat->rep->window);\r\ng_free(uat->rep);\r\nuat->rep = NULL;\r\n}\r\nstatic gboolean unsaved_dialog(GtkWindow *w _U_, GdkEvent *e _U_, gpointer u) {\r\nGtkWidget *win, *vbox, *label, *bbox;\r\nGtkWidget *yes_bt, *no_bt;\r\ngchar *message;\r\nuat_t *uat = (uat_t *)u;\r\nif (uat->rep->unsaved_window) {\r\nwindow_present(uat->rep->unsaved_window);\r\nreturn TRUE;\r\n}\r\nuat->rep->unsaved_window = win = dlg_conf_window_new("Discard Changes?");\r\ngtk_window_set_default_size(GTK_WINDOW(win), 360, 140);\r\ngtk_window_set_position(GTK_WINDOW(win), GTK_WIN_POS_CENTER_ON_PARENT);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 12, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(vbox), 6);\r\ngtk_container_add(GTK_CONTAINER(win), vbox);\r\nmessage = g_strdup_printf("Changes to '%s' are not being saved!\n"\r\n"Do you want to save '%s'?", uat->name, uat->name);\r\nlabel = gtk_label_new(message);\r\ng_free(message);\r\nbbox = dlg_button_row_new(GTK_STOCK_YES, GTK_STOCK_NO, NULL);\r\nyes_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_YES);\r\nno_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_NO);\r\ng_signal_connect(no_bt, "clicked", G_CALLBACK(uat_nosave_cb), uat);\r\ng_signal_connect(yes_bt, "clicked", G_CALLBACK(uat_yessave_cb), uat);\r\ngtk_box_pack_start(GTK_BOX(vbox), label, FALSE, FALSE, 0);\r\ngtk_box_pack_end(GTK_BOX(vbox), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show_all(win);\r\nwindow_present(win);\r\nreturn TRUE;\r\n}\r\nstatic void uat_help_cb(GtkWidget *w _U_, gpointer u) {\r\ngchar *help_page, *url;\r\nhelp_page = g_strdup_printf("%s.html", ((uat_t*)u)->help);\r\nurl = user_guide_url(help_page);\r\nif (url) {\r\nbrowser_open_url(url);\r\n}\r\ng_free(help_page);\r\ng_free(url);\r\n}\r\nstatic GtkWidget *uat_window(void *u) {\r\nuat_t *uat = (uat_t *)u;\r\nuat_field_t *f = uat->fields;\r\nuat_rep_t *rep;\r\nguint i;\r\nguint colnum;\r\nGType *col_types;\r\nGtkWidget *hbox, *vbox, *move_hbox, *edit_hbox, *refresh_hbox;\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeSelection *selection;\r\ngchar *global_fname;\r\ngboolean global_file_exists;\r\nif (uat->rep) {\r\nwindow_present(uat->rep->window);\r\nreturn uat->rep->window;\r\n} else {\r\nuat->rep = rep = (uat_rep_t *)g_malloc0(sizeof(uat_rep_t));\r\n}\r\nglobal_fname = get_datafile_path(uat->filename);\r\nglobal_file_exists = file_exists(global_fname);\r\ng_free (global_fname);\r\nrep->window = dlg_conf_window_new(uat->name);\r\ngtk_window_set_default_size(GTK_WINDOW(rep->window), 720, 512);\r\ngtk_window_set_position(GTK_WINDOW(rep->window), GTK_WIN_POS_CENTER_ON_PARENT);\r\ngtk_container_set_border_width(GTK_CONTAINER(rep->window), 6);\r\nrep->vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 12, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(rep->vbox), 6);\r\ngtk_container_add(GTK_CONTAINER(rep->window), rep->vbox);\r\nhbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 12, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(hbox), 6);\r\ngtk_box_pack_start(GTK_BOX(rep->vbox), hbox, TRUE, TRUE, 0);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 12, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(vbox), 6);\r\ngtk_box_pack_start(GTK_BOX(hbox), vbox, FALSE, FALSE, 0);\r\nrep->scrolledwindow = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(rep->scrolledwindow), GTK_SHADOW_IN);\r\ncol_types = (GType *)g_malloc(sizeof(GType) *uat->ncols);\r\nfor ( colnum = 0; colnum < uat->ncols; colnum++ ) {\r\ncol_types[colnum] = G_TYPE_STRING;\r\n}\r\nrep->list_store = gtk_list_store_newv(uat->ncols, col_types);\r\ng_free(col_types);\r\nrep->list = GTK_TREE_VIEW(tree_view_new(GTK_TREE_MODEL(rep->list_store)));\r\ngtk_container_add(GTK_CONTAINER(rep->scrolledwindow), GTK_WIDGET(rep->list));\r\ngtk_box_pack_start(GTK_BOX(hbox), rep->scrolledwindow, TRUE, TRUE, 0);\r\nselection = gtk_tree_view_get_selection(rep->list);\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_SINGLE);\r\nrep->selected = -1;\r\nfor ( colnum = 0; colnum < uat->ncols; colnum++ ) {\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes(f[colnum].title,\r\nrenderer, "text", colnum, NULL);\r\ngtk_tree_view_column_set_resizable (column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column (rep->list, column);\r\nif (f[colnum].desc != NULL)\r\ngtk_widget_set_tooltip_text(gtk_tree_view_column_get_button(column), f[colnum].desc);\r\n}\r\nfor ( i = 0 ; i < uat->raw_data->len; i++ ) {\r\nappend_row(uat, i);\r\n}\r\nif (uat->help) {\r\nGtkWidget *help_btn;\r\nrep->bbox = dlg_button_row_new(GTK_STOCK_HELP, GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_CANCEL, NULL);\r\nhelp_btn = (GtkWidget *)g_object_get_data(G_OBJECT(rep->bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_btn, "clicked", G_CALLBACK(uat_help_cb), uat);\r\n} else {\r\nrep->bbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_CANCEL, NULL);\r\n}\r\nmove_hbox = gtk_button_box_new(GTK_ORIENTATION_VERTICAL);\r\ngtk_box_pack_start(GTK_BOX(vbox), move_hbox, TRUE, FALSE, 0);\r\nedit_hbox = gtk_button_box_new(GTK_ORIENTATION_VERTICAL);\r\ngtk_box_pack_start(GTK_BOX(vbox), edit_hbox, TRUE, FALSE, 0);\r\nrefresh_hbox = gtk_button_box_new(GTK_ORIENTATION_VERTICAL);\r\ngtk_box_pack_end(GTK_BOX(vbox), refresh_hbox, TRUE, FALSE, 0);\r\nrep->bt_up = ws_gtk_button_new_from_stock(GTK_STOCK_GO_UP);\r\ngtk_widget_set_tooltip_text(rep->bt_up, "Move selected entry up");\r\nrep->bt_down = ws_gtk_button_new_from_stock(GTK_STOCK_GO_DOWN);\r\ngtk_widget_set_tooltip_text(rep->bt_down, "Move selected entry down");\r\ngtk_box_pack_start(GTK_BOX(move_hbox), rep->bt_up, TRUE, FALSE, 5);\r\ngtk_box_pack_start(GTK_BOX(move_hbox), rep->bt_down, TRUE, FALSE, 5);\r\nrep->bt_new = ws_gtk_button_new_from_stock(GTK_STOCK_NEW);\r\ngtk_widget_set_tooltip_text(rep->bt_new, "Create a new entry");\r\nrep->bt_edit = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_EDIT);\r\ngtk_widget_set_tooltip_text(rep->bt_edit, "Edit selected entry");\r\nrep->bt_copy = ws_gtk_button_new_from_stock(GTK_STOCK_COPY);\r\ngtk_widget_set_tooltip_text(rep->bt_copy, "Copy selected entry");\r\nrep->bt_delete = ws_gtk_button_new_from_stock(GTK_STOCK_DELETE);\r\ngtk_widget_set_tooltip_text(rep->bt_delete, "Delete selected entry");\r\ngtk_box_pack_end(GTK_BOX(edit_hbox), rep->bt_new, TRUE, FALSE, 5);\r\ngtk_box_pack_end(GTK_BOX(edit_hbox), rep->bt_edit, TRUE, FALSE, 5);\r\ngtk_box_pack_end(GTK_BOX(edit_hbox), rep->bt_copy, TRUE, FALSE, 5);\r\ngtk_box_pack_end(GTK_BOX(edit_hbox), rep->bt_delete, TRUE, FALSE, 5);\r\nrep->bt_refresh = ws_gtk_button_new_from_stock(GTK_STOCK_REFRESH);\r\ngtk_widget_set_tooltip_text(rep->bt_refresh, "Refresh from system defaults");\r\nrep->bt_clear = ws_gtk_button_new_from_stock(GTK_STOCK_CLEAR);\r\ngtk_widget_set_tooltip_text(rep->bt_clear, "Delete all entries");\r\ngtk_box_pack_end(GTK_BOX(refresh_hbox), rep->bt_refresh, TRUE, FALSE, 5);\r\ngtk_box_pack_end(GTK_BOX(refresh_hbox), rep->bt_clear, TRUE, FALSE, 5);\r\nrep->bt_apply = (GtkWidget *)g_object_get_data(G_OBJECT(rep->bbox), GTK_STOCK_APPLY);\r\nrep->bt_cancel = (GtkWidget *)g_object_get_data(G_OBJECT(rep->bbox), GTK_STOCK_CANCEL);\r\nrep->bt_ok = (GtkWidget *)g_object_get_data(G_OBJECT(rep->bbox), GTK_STOCK_OK);\r\ngtk_box_pack_end(GTK_BOX(rep->vbox), rep->bbox, FALSE, FALSE, 0);\r\ngtk_widget_set_sensitive (rep->bt_up, FALSE);\r\ngtk_widget_set_sensitive (rep->bt_down, FALSE);\r\ngtk_widget_set_sensitive (rep->bt_edit, FALSE);\r\ngtk_widget_set_sensitive (rep->bt_copy, FALSE);\r\ngtk_widget_set_sensitive (rep->bt_delete, FALSE);\r\ngtk_widget_set_sensitive (rep->bt_refresh, global_file_exists);\r\ng_signal_connect(rep->list, "row-activated", G_CALLBACK(uat_double_click_cb), uat);\r\ng_signal_connect(selection, "changed", G_CALLBACK(remember_selected_row), uat);\r\ng_signal_connect(rep->bt_new, "clicked", G_CALLBACK(uat_new_cb), uat);\r\ng_signal_connect(rep->bt_edit, "clicked", G_CALLBACK(uat_edit_cb), uat);\r\ng_signal_connect(rep->bt_copy, "clicked", G_CALLBACK(uat_copy_cb), uat);\r\ng_signal_connect(rep->bt_delete, "clicked", G_CALLBACK(uat_delete_cb), uat);\r\ng_signal_connect(rep->bt_refresh, "clicked", G_CALLBACK(uat_refresh_cb), uat);\r\ng_signal_connect(rep->bt_clear, "clicked", G_CALLBACK(uat_clear_cb), uat);\r\ng_signal_connect(rep->bt_up, "clicked", G_CALLBACK(uat_up_cb), uat);\r\ng_signal_connect(rep->bt_down, "clicked", G_CALLBACK(uat_down_cb), uat);\r\ng_signal_connect(rep->bt_apply, "clicked", G_CALLBACK(uat_apply_cb), uat);\r\ng_signal_connect(rep->bt_cancel, "clicked", G_CALLBACK(uat_cancel_cb), uat);\r\ng_signal_connect(rep->bt_ok, "clicked", G_CALLBACK(uat_ok_cb), uat);\r\nwindow_set_cancel_button(rep->window, rep->bt_cancel, NULL);\r\nif (uat->changed) {\r\ng_signal_connect(GTK_WINDOW(rep->window), "delete_event", G_CALLBACK(unsaved_dialog), uat);\r\ng_signal_connect(GTK_WINDOW(rep->window), "destroy", G_CALLBACK(unsaved_dialog), uat);\r\n} else {\r\ng_signal_connect(GTK_WINDOW(rep->window), "delete_event", G_CALLBACK(uat_window_delete_event_cb), uat);\r\ng_signal_connect(GTK_WINDOW(rep->window), "destroy", G_CALLBACK(uat_window_delete_event_cb), uat);\r\n}\r\ngtk_widget_grab_focus(GTK_WIDGET(rep->list));\r\ngtk_widget_show_all(rep->window);\r\nwindow_present(rep->window);\r\nreturn rep->window;\r\n}\r\nvoid uat_window_cb(GtkWidget *u _U_, void *uat) {\r\nuat_window(uat);\r\n}

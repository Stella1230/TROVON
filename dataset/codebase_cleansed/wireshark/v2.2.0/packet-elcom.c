static gint\r\ndissect_lower_address(proto_item *ti_arg, gint ett_arg,\r\ntvbuff_t *tvb, gint arg_offset,\r\nint hf_endian, int hf_ip, int hf_port, int hf_suff)\r\n{\r\ngint offset = arg_offset;\r\nguint8 len1, len2;\r\nguint8 *suffix;\r\nproto_tree *tree;\r\nproto_item *ti;\r\ntree = proto_item_add_subtree(ti_arg, ett_arg);\r\nlen1 = tvb_get_guint8(tvb, offset);\r\nif (tvb_captured_length_remaining(tvb, offset+len1+1) <= 0)\r\nreturn offset;\r\nlen2 = tvb_get_guint8(tvb, offset+len1+1);\r\nif (tvb_reported_length_remaining(tvb, offset+len1+len2+2) <= 0)\r\nreturn offset;\r\nif ((len1 != LOWADR_LEN) || (len2 != SUFFIX_LEN)) {\r\nproto_item_append_text(tree, " Invalid structure");\r\nreturn offset;\r\n}\r\nif (0x82 != tvb_get_guint8(tvb, offset+1)) {\r\nproto_item_append_text(tree, " Not IPV4 address");\r\nreturn offset;\r\n}\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_endian, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += 8;\r\nsuffix = tvb_get_string_enc(wmem_packet_scope(), tvb, offset+1, len2, ENC_ASCII);\r\nti = proto_tree_add_item(tree, hf_suff, tvb, offset, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\noffset += len2+1;\r\nif (!(suffix[0] == 'A' || suffix[0] == 'B')) {\r\nproto_item_append_text(ti, " (invalid)");\r\nreturn offset;\r\n}\r\nproto_item_append_text(ti, " (%s)", val_to_str_const(suffix[1], suffix_vals, "<<-- WHAT?") );\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_userdata(proto_item *ti_arg, gint ett_arg, tvbuff_t *tvb, gint arg_offset)\r\n{\r\ngint offset = arg_offset;\r\nguint8 flen, lenbytes;\r\nguint8 year, month, day, hour, min, sec;\r\nguint16 msec;\r\nproto_tree *tree;\r\nproto_item *ti;\r\ntree = proto_item_add_subtree(ti_arg, ett_arg);\r\nflen = tvb_get_guint8(tvb, offset);\r\nlenbytes = 1;\r\nif (flen == 0) {\r\nflen = tvb_get_guint8(tvb, offset+1);\r\nlenbytes = 2;\r\n}\r\nif (flen == 0 || flen > 79)\r\nreturn offset;\r\nti = proto_tree_add_item(tree, hf_elcom_userdata_length, tvb, offset, lenbytes, ENC_BIG_ENDIAN);\r\noffset += lenbytes;\r\nif (lenbytes == 2) {\r\nproto_item_append_text(ti, " (2 bytes, should be 1 byte)");\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_userdata_pduid, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_userdata_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_userdata_result, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nti = proto_tree_add_item(tree, hf_elcom_userdata_restmark, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, " <-- '0' = no restart etc.");\r\noffset +=1;\r\nif (tvb_reported_length_remaining(tvb, offset+8) <= 0)\r\nreturn offset;\r\nyear = tvb_get_guint8(tvb, offset);\r\nmonth = tvb_get_guint8(tvb, offset+1);\r\nday = tvb_get_guint8(tvb, offset+2);\r\nhour = tvb_get_guint8(tvb, offset+3);\r\nmin = tvb_get_guint8(tvb, offset+4);\r\nsec = tvb_get_guint8(tvb, offset+5);\r\nmsec = tvb_get_ntohs(tvb, offset+6);\r\nproto_tree_add_none_format(tree, hf_elcom_userdata_cf, tvb, offset, 8,\r\n"Control Field: %4d-%02d-%02d %02d:%02d:%02d.%d",\r\nyear+1900, month, day, hour, min, sec, msec);\r\noffset += 12;\r\nif (tvb_reported_length_remaining(tvb, offset+12) > 0) {\r\nproto_item_append_text(ti, " Security info: ");\r\n}\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_item_append_text(ti, elcom_show_hex ? " %02x" : " %03o",\r\ntvb_get_guint8(tvb, offset));\r\noffset++;\r\n}\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_datarequest(proto_item *ti_arg, gint ett_arg, tvbuff_t *tvb, gint arg_offset)\r\n{\r\ngint offset = arg_offset;\r\nguint8 gtype, oidlen;\r\nproto_tree *tree;\r\nproto_item *ti;\r\ntree = proto_item_add_subtree(ti_arg, ett_arg);\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\ngtype = tvb_get_guint8(tvb, offset);\r\nti = proto_tree_add_item(tree, hf_elcom_datarequest_grouptype,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (gtype) {\r\ncase TC_REQ:\r\nbreak;\r\ncase TC_RSP:\r\nproto_tree_add_item(tree, hf_elcom_datarequest_result,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ndefault:\r\nproto_item_append_text(ti, " <<--- meaning WHAT?");\r\nreturn offset;\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_datarequest_groupnumber, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_datarequest_grouppriority, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_datarequest_groupsize, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_datarequest_groupindex1, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_datarequest_groupindex2, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nwhile (1) {\r\noidlen = tvb_get_guint8(tvb, offset);\r\nif (oidlen == 0)\r\nbreak;\r\nif (tvb_reported_length_remaining(tvb, offset+oidlen+1) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_datarequest_oid, tvb, offset, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\noffset += oidlen+1;\r\n}\r\noffset += 1;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nproto_tree_add_item(tree, hf_elcom_strangeleftover, tvb, offset, -1, ENC_NA);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_elcom(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ngboolean is_request, length_ok;\r\nproto_tree *elcom_tree;\r\nproto_item *ti, *hidden_item;\r\ngint offset = 0;\r\nguint elcom_len;\r\nguint8 elcom_msg_type;\r\nguint8 *suffix;\r\nif (tvb_captured_length(tvb) < 3)\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ELCOM");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nis_request = (pinfo->match_uint == pinfo->destport);\r\nelcom_len = tvb_get_ntohs(tvb, 0);\r\nlength_ok = (tvb_reported_length(tvb) == (elcom_len+2));\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s Len=%d%s",\r\nis_request ? "Request" : "Response",\r\nelcom_len,\r\nlength_ok ? "" : " (incorrect)");\r\nelcom_msg_type = tvb_get_guint8(tvb, 2);\r\nswitch (elcom_msg_type) {\r\ncase P_CONRQ:\r\ncase P_CONRS:\r\nif (tvb_captured_length_remaining(tvb, 3+TOTAL_LEN+TOTAL_LEN+3) < 0) return 2;\r\nif (tvb_get_guint8(tvb, 3) != LOWADR_LEN) return 2;\r\nif (tvb_get_guint8(tvb, 3+1+LOWADR_LEN) != SUFFIX_LEN) return 2;\r\nif (tvb_get_guint8(tvb, 3+TOTAL_LEN) != LOWADR_LEN) return 2;\r\nif (tvb_get_guint8(tvb, 3+1+TOTAL_LEN+LOWADR_LEN) != SUFFIX_LEN) return 2;\r\nsuffix = tvb_get_string_enc(wmem_packet_scope(), tvb, 3+2+LOWADR_LEN, 2, ENC_ASCII);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %s Connect", suffix);\r\nbreak;\r\ncase P_RELRQ:\r\ncase P_RELRS:\r\ncol_append_str(pinfo->cinfo, COL_INFO, " Release");\r\nbreak;\r\ncase P_DATRQ:\r\ncol_append_str(pinfo->cinfo, COL_INFO, " Data");\r\nbreak;\r\n}\r\nswitch (elcom_msg_type) {\r\ncase P_CONRQ:\r\ncase P_RELRQ:\r\ncol_append_str(pinfo->cinfo, COL_INFO, " Request");\r\nbreak;\r\ncase P_CONRS:\r\ncase P_RELRS:\r\ncol_append_str(pinfo->cinfo, COL_INFO, " Response");\r\nbreak;\r\n}\r\nif (!tree)\r\nreturn tvb_captured_length(tvb);\r\nti = proto_tree_add_item(tree, proto_elcom, tvb, offset, -1, ENC_NA);\r\nelcom_tree = proto_item_add_subtree(ti, ett_elcom);\r\nhidden_item = proto_tree_add_boolean(elcom_tree,\r\nis_request ? hf_elcom_request : hf_elcom_response,\r\ntvb, 0, 0, TRUE);\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\noffset = 0;\r\nti = proto_tree_add_item(elcom_tree, hf_elcom_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = +2;\r\nif (! length_ok) {\r\nproto_item_append_text(ti, " (incorrect)");\r\n}\r\nelcom_msg_type = tvb_get_guint8(tvb, offset);\r\nti = proto_tree_add_item(elcom_tree, hf_elcom_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(elcom_tree, " ( %s)", val_to_str(elcom_msg_type, type_vals, "Unknown %d"));\r\noffset++;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nswitch (elcom_msg_type) {\r\ncase P_CONRQ:\r\ncase P_CONRS:\r\nti = proto_tree_add_item(elcom_tree, hf_elcom_initiator, tvb, offset, TOTAL_LEN, ENC_NA);\r\noffset = dissect_lower_address(ti, ett_elcom_initiator, tvb, offset,\r\nhf_elcom_initiator_endian,\r\nhf_elcom_initiator_ip,\r\nhf_elcom_initiator_port,\r\nhf_elcom_initiator_suff);\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nti = proto_tree_add_item(elcom_tree, hf_elcom_responder, tvb, offset, TOTAL_LEN, ENC_NA);\r\noffset = dissect_lower_address(ti, ett_elcom_responder, tvb, offset,\r\nhf_elcom_responder_endian,\r\nhf_elcom_responder_ip,\r\nhf_elcom_responder_port,\r\nhf_elcom_responder_suff);\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nti = proto_tree_add_item(elcom_tree, hf_elcom_userdata, tvb, offset, -1, ENC_NA);\r\noffset = dissect_userdata(ti, ett_elcom_userdata, tvb, offset);\r\nbreak;\r\ncase P_RELRQ:\r\nproto_tree_add_item(elcom_tree, hf_elcom_release_reason, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase P_RELRS:\r\nproto_tree_add_item(elcom_tree, hf_elcom_release_result, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase P_DATRQ:\r\nti = proto_tree_add_item(elcom_tree, hf_elcom_datarequest, tvb, offset, -1, ENC_NA);\r\noffset = dissect_datarequest(ti, ett_elcom_datarequest, tvb, offset);\r\nbreak;\r\ndefault:\r\nproto_item_append_text(ti, " <<--- meaning WHAT??");\r\nbreak;\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) > 0)\r\n{\r\nproto_tree_add_item(elcom_tree, hf_elcom_strangeleftover, tvb, offset, -1, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_elcom(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_elcom_response,\r\n{ "Response", "elcom.response",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_request,\r\n{ "Request", "elcom.request",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_length,\r\n{ "Length", "elcom.length",\r\nFT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_type,\r\n{ "Type", "elcom.type",\r\nFT_UINT8, BASE_HEX, VALS(type_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_initiator,\r\n{ "Initiator", "elcom.initiator",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_initiator_endian,\r\n{ "Endian", "elcom.initiator.endian",\r\nFT_UINT16, BASE_HEX, VALS(endian_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_initiator_ip,\r\n{ "IP", "elcom.initiator.ip",\r\nFT_IPv4, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_initiator_port,\r\n{ "Port", "elcom.initiator.port",\r\nFT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_initiator_suff,\r\n{ "Suffix", "elcom.initiator.suffix",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_responder,\r\n{ "Responder", "elcom.responder",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_responder_endian,\r\n{ "Endian", "elcom.responder.endian",\r\nFT_UINT16, BASE_HEX, VALS(endian_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_responder_ip,\r\n{ "IP", "elcom.responder.ip",\r\nFT_IPv4, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_responder_port,\r\n{ "Port", "elcom.responder.port",\r\nFT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_responder_suff,\r\n{ "Suffix", "elcom.responder.suffix",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata,\r\n{ "User Data", "elcom.userdata",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata_length,\r\n{ "Length", "elcom.userdata.length",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata_pduid,\r\n{ "PDU-ID", "elcom.userdata.pduid",\r\nFT_UINT8, BASE_DEC, VALS(userdata_pduid_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata_version,\r\n{ "Version", "elcom.userdata.version",\r\nFT_UINT8, BASE_DEC, VALS(userdata_version_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata_result,\r\n{ "Result", "elcom.userdata.result",\r\nFT_UINT8, BASE_DEC, VALS(userdata_result_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata_restmark,\r\n{ "Restart marking", "elcom.userdata.response.restartcode",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_userdata_cf,\r\n{ "Control Field", "elcom.userdata.response.controlfield",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_release_reason,\r\n{ "Reason", "elcom.release.reason",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_release_result,\r\n{ "Result", "elcom.release.result",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest,\r\n{ "Data Request", "elcom.datarequest",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_grouptype,\r\n{ "Group Type", "elcom.datarequest.grouptype",\r\nFT_UINT8, BASE_DEC, VALS(datarequest_grouptype_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_result,\r\n{ "Result", "elcom.datarequest.result",\r\nFT_UINT8, BASE_DEC, VALS(datarequest_result_vals), 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_groupnumber,\r\n{ "Group Number", "elcom.datarequest.groupnumber",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_grouppriority,\r\n{ "Group Priority", "elcom.datarequest.grouppriority",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_groupsize,\r\n{ "Group Size", "elcom.datarequest.groupsize",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_groupindex1,\r\n{ "Group Index1", "elcom.datarequest.groupindex1",\r\nFT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_groupindex2,\r\n{ "Group Index2", "elcom.datarequest.groupindex2",\r\nFT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_datarequest_oid,\r\n{ "Obkect Name", "elcom.datarequest.oid",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_elcom_strangeleftover,\r\n{ "Strange Leftover", "elcom.leftover",\r\nFT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_elcom,\r\n&ett_elcom_initiator,\r\n&ett_elcom_responder,\r\n&ett_elcom_userdata,\r\n&ett_elcom_datarequest\r\n};\r\nproto_elcom = proto_register_protocol (\r\n"ELCOM Communication Protocol",\r\n"ELCOM",\r\n"elcom"\r\n);\r\nproto_register_field_array(proto_elcom, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_elcom(void)\r\n{\r\ndissector_handle_t elcom_handle;\r\nelcom_handle = create_dissector_handle(dissect_elcom, proto_elcom);\r\ndissector_add_uint("tcp.port", TCP_PORT_ELCOM, elcom_handle);\r\n}

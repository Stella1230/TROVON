void fec_decode_ext_fti(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, guint8 encoding_id)\r\n{\r\nguint64 transfer_length;\r\nfec_packet_data_t *fec_data;\r\nguint8 instance_id = 0;\r\nproto_item *ti;\r\nif (encoding_id == 6){\r\ntransfer_length = tvb_get_ntoh40(tvb, offset+2);\r\n}\r\nelse {\r\ntransfer_length = tvb_get_ntoh48(tvb, offset+2);\r\n}\r\nif (encoding_id >= 128)\r\n{\r\ninstance_id = (guint8) tvb_get_ntohs(tvb, offset+8);\r\nfec_data = wmem_new0(wmem_file_scope(), fec_packet_data_t);\r\nfec_data->instance_id = instance_id;\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_rmt_fec, 0, fec_data);\r\n}\r\nif (encoding_id == 6){\r\nproto_tree_add_uint64(tree, hf_fti_transfer_length, tvb, offset+2, 5, transfer_length);\r\n}\r\nelse {\r\nproto_tree_add_uint64(tree, hf_fti_transfer_length, tvb, offset+2, 6, transfer_length);\r\nti = proto_tree_add_item(tree, hf_instance_id, tvb, offset+8, 2, ENC_BIG_ENDIAN);\r\nif ((encoding_id < 128) && (encoding_id != 0)) {\r\nexpert_add_info(pinfo, ti, &ei_fec_encoding_id);\r\n}\r\n}\r\nswitch (encoding_id)\r\n{\r\ncase 1:\r\nproto_tree_add_item(tree, hf_fti_encoding_symbol_length, tvb, offset+10, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_num_blocks, tvb, offset+12, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_num_subblocks, tvb, offset+14, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_alignment, tvb, offset+15, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(tree, hf_fti_encoding_symbol_length, tvb, offset+8, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_num_blocks, tvb, offset+10, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_num_subblocks, tvb, offset+11, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_alignment, tvb, offset+13, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 0:\r\ncase 2:\r\ncase 128:\r\ncase 130:\r\nproto_tree_add_item(tree, hf_fti_encoding_symbol_length, tvb, offset+10, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_max_source_block_length, tvb, offset+12, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 129:\r\nproto_tree_add_item(tree, hf_fti_encoding_symbol_length, tvb, offset+10, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_max_source_block_length, tvb, offset+12, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_max_number_encoding_symbols, tvb, offset+14, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 132:\r\nproto_tree_add_item(tree, hf_fti_encoding_symbol_length, tvb, offset+10, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_max_source_block_length, tvb, offset+12, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fti_max_number_encoding_symbols, tvb, offset+16, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_fec(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nproto_item *ti;\r\nproto_tree *fec_tree;\r\nguint offset = 0;\r\nfec_data_exchange_t *fec = (fec_data_exchange_t*)data;\r\nguint8 encoding_id = 0;\r\nfec_packet_data_t *packet_data = (fec_packet_data_t*)p_get_proto_data(wmem_file_scope(), pinfo, proto_rmt_fec, 0);\r\nif (fec != NULL)\r\n{\r\nencoding_id = fec->encoding_id;\r\n}\r\nti = proto_tree_add_item(tree, proto_rmt_fec, tvb, offset, -1, ENC_NA);\r\nfec_tree = proto_item_add_subtree(ti, ett_main);\r\nproto_tree_add_uint(fec_tree, hf_encoding_id, tvb, offset, 0, encoding_id);\r\nif (encoding_id >= 128 && (packet_data != NULL))\r\nproto_tree_add_uint(fec_tree, hf_instance_id, tvb, offset, 0, packet_data->instance_id);\r\nswitch (encoding_id)\r\n{\r\ncase 0:\r\ncase 1:\r\ncase 130:\r\nproto_tree_add_item(fec_tree, hf_sbn, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fec_tree, hf_esi, tvb, offset+2, 2, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "SBN: %u", tvb_get_ntohs(tvb, offset));\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "ESI: 0x%X", tvb_get_ntohs(tvb, offset+2));\r\noffset += 4;\r\nbreak;\r\ncase 2:\r\ncase 128:\r\ncase 132:\r\nproto_tree_add_item(fec_tree, hf_sbn, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fec_tree, hf_esi, tvb, offset+4, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "SBN: %u", tvb_get_ntohl(tvb, offset));\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "ESI: 0x%X", tvb_get_ntohl(tvb, offset+4));\r\noffset += 8;\r\nbreak;\r\ncase 3:\r\ncase 4:\r\nproto_tree_add_item(fec_tree, hf_sbn_with_mask, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fec_tree, hf_esi_with_mask, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "SBN: %u", tvb_get_ntohl(tvb, offset) >> 20);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "ESI: 0x%X", tvb_get_ntohl(tvb, offset) & 0xfffff);\r\noffset += 4;\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(fec_tree, hf_sbn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fec_tree, hf_esi, tvb, offset+1, 3, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "SBN: %u", tvb_get_guint8(tvb, offset));\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "ESI: 0x%X", tvb_get_ntoh24(tvb, offset+1));\r\noffset += 4;\r\nbreak;\r\ncase 129:\r\nproto_tree_add_item(fec_tree, hf_sbn, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fec_tree, hf_sbl, tvb, offset+4, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fec_tree, hf_esi, tvb, offset+6, 2, ENC_BIG_ENDIAN);\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "SBN: %u", tvb_get_ntohl(tvb, offset));\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "ESI: 0x%X", tvb_get_ntohs(tvb, offset+6));\r\noffset += 8;\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nvoid proto_register_rmt_fec(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_encoding_id,\r\n{ "FEC Encoding ID", "rmt-fec.encoding_id",\r\nFT_UINT8, BASE_DEC, VALS(string_fec_encoding_id), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_instance_id,\r\n{ "FEC Instance ID", "rmt-fec.instance_id",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbn,\r\n{ "Source Block Number", "rmt-fec.sbn",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbn_with_mask,\r\n{ "Source Block Number", "rmt-fec.sbn",\r\nFT_UINT32, BASE_DEC, NULL, 0xFFF00000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbl,\r\n{ "Source Block Length", "rmt-fec.sbl",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_esi,\r\n{ "Encoding Symbol ID", "rmt-fec.esi",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_esi_with_mask,\r\n{ "Encoding Symbol ID", "rmt-fec.esi",\r\nFT_UINT32, BASE_HEX, NULL, 0x000FFFFF,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_transfer_length,\r\n{ "Transfer Length", "rmt-fec.fti.transfer_length",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_encoding_symbol_length,\r\n{ "Encoding Symbol Length", "rmt-fec.fti.encoding_symbol_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_max_source_block_length,\r\n{ "Maximum Source Block Length", "rmt-fec.fti.max_source_block_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_max_number_encoding_symbols,\r\n{ "Maximum Number of Encoding Symbols", "rmt-fec.fti.max_number_encoding_symbols",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_num_blocks,\r\n{ "Number of Source Blocks", "rmt-fec.fti.num_blocks",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_num_subblocks,\r\n{ "Number of Sub-Blocks", "rmt-fec.fti.num_subblocks",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fti_alignment,\r\n{ "Symbol Alignment", "rmt-fec.fti.alignment",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_main,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_fec_encoding_id, { "rmt-fec.encoding_id.not0", PI_PROTOCOL, PI_WARN, "FEC Encoding ID < 128, should be zero", EXPFILL }},\r\n};\r\nexpert_module_t* expert_rmt_fec;\r\nproto_rmt_fec = proto_register_protocol("Forward Error Correction (FEC)", "RMT-FEC", "rmt-fec");\r\nregister_dissector("rmt-fec", dissect_fec, proto_rmt_fec);\r\nproto_register_field_array(proto_rmt_fec, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_rmt_fec = expert_register_protocol(proto_rmt_fec);\r\nexpert_register_field_array(expert_rmt_fec, ei, array_length(ei));\r\n}

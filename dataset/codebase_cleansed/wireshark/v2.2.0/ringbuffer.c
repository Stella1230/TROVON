static int ringbuf_open_file(rb_file *rfile, int *err)\r\n{\r\nchar filenum[5+1];\r\nchar timestr[14+1];\r\ntime_t current_time;\r\nif (rfile->name != NULL) {\r\nif (rb_data.unlimited == FALSE) {\r\nws_unlink(rfile->name);\r\n}\r\ng_free(rfile->name);\r\n}\r\n#ifdef _WIN32\r\n_tzset();\r\n#endif\r\ncurrent_time = time(NULL);\r\ng_snprintf(filenum, sizeof(filenum), "%05u", (rb_data.curr_file_num + 1) % RINGBUFFER_MAX_NUM_FILES);\r\nstrftime(timestr, sizeof(timestr), "%Y%m%d%H%M%S", localtime(&current_time));\r\nrfile->name = g_strconcat(rb_data.fprefix, "_", filenum, "_", timestr,\r\nrb_data.fsuffix, NULL);\r\nif (rfile->name == NULL) {\r\nif (err != NULL)\r\n*err = ENOMEM;\r\nreturn -1;\r\n}\r\nrb_data.fd = ws_open(rfile->name, O_RDWR|O_BINARY|O_TRUNC|O_CREAT,\r\nrb_data.group_read_access ? 0640 : 0600);\r\nif (rb_data.fd == -1 && err != NULL) {\r\n*err = errno;\r\n}\r\nreturn rb_data.fd;\r\n}\r\nint\r\nringbuf_init(const char *capfile_name, guint num_files, gboolean group_read_access)\r\n{\r\nunsigned int i;\r\nchar *pfx, *last_pathsep;\r\ngchar *save_file;\r\nrb_data.files = NULL;\r\nrb_data.curr_file_num = 0;\r\nrb_data.fprefix = NULL;\r\nrb_data.fsuffix = NULL;\r\nrb_data.unlimited = FALSE;\r\nrb_data.fd = -1;\r\nrb_data.pdh = NULL;\r\nrb_data.group_read_access = group_read_access;\r\nif (num_files <= RINGBUFFER_MAX_NUM_FILES) {\r\nrb_data.num_files = num_files;\r\n} else {\r\nrb_data.num_files = RINGBUFFER_MAX_NUM_FILES;\r\n}\r\nif (capfile_name == NULL) {\r\nreturn -1;\r\n}\r\nsave_file = g_strdup(capfile_name);\r\nlast_pathsep = strrchr(save_file, G_DIR_SEPARATOR);\r\npfx = strrchr(save_file,'.');\r\nif (pfx != NULL && (last_pathsep == NULL || pfx > last_pathsep)) {\r\npfx[0] = '\0';\r\nrb_data.fprefix = g_strdup(save_file);\r\npfx[0] = '.';\r\nrb_data.fsuffix = g_strdup(pfx);\r\n} else {\r\nrb_data.fprefix = g_strdup(save_file);\r\nrb_data.fsuffix = NULL;\r\n}\r\ng_free(save_file);\r\nsave_file = NULL;\r\nif (num_files == RINGBUFFER_UNLIMITED_FILES) {\r\nrb_data.unlimited = TRUE;\r\nrb_data.num_files = 1;\r\n}\r\nrb_data.files = (rb_file *)g_malloc(rb_data.num_files * sizeof(rb_file));\r\nif (rb_data.files == NULL) {\r\nreturn -1;\r\n}\r\nfor (i=0; i < rb_data.num_files; i++) {\r\nrb_data.files[i].name = NULL;\r\n}\r\nif (ringbuf_open_file(&rb_data.files[0], NULL) == -1) {\r\nringbuf_error_cleanup();\r\nreturn -1;\r\n}\r\nreturn rb_data.fd;\r\n}\r\nconst gchar *ringbuf_current_filename(void)\r\n{\r\nreturn rb_data.files[rb_data.curr_file_num % rb_data.num_files].name;\r\n}\r\nFILE *\r\nringbuf_init_libpcap_fdopen(int *err)\r\n{\r\nrb_data.pdh = ws_fdopen(rb_data.fd, "wb");\r\nif (rb_data.pdh == NULL) {\r\nif (err != NULL) {\r\n*err = errno;\r\n}\r\n}\r\nreturn rb_data.pdh;\r\n}\r\ngboolean\r\nringbuf_switch_file(FILE **pdh, gchar **save_file, int *save_file_fd, int *err)\r\n{\r\nint next_file_index;\r\nrb_file *next_rfile = NULL;\r\nif (fclose(rb_data.pdh) == EOF) {\r\nif (err != NULL) {\r\n*err = errno;\r\n}\r\nws_close(rb_data.fd);\r\nrb_data.pdh = NULL;\r\nrb_data.fd = -1;\r\nreturn FALSE;\r\n}\r\nrb_data.pdh = NULL;\r\nrb_data.fd = -1;\r\nrb_data.curr_file_num++ ;\r\nnext_file_index = (rb_data.curr_file_num) % rb_data.num_files;\r\nnext_rfile = &rb_data.files[next_file_index];\r\nif (ringbuf_open_file(next_rfile, err) == -1) {\r\nreturn FALSE;\r\n}\r\nif (ringbuf_init_libpcap_fdopen(err) == NULL) {\r\nreturn FALSE;\r\n}\r\n*save_file = next_rfile->name;\r\n*save_file_fd = rb_data.fd;\r\n(*pdh) = rb_data.pdh;\r\nreturn TRUE;\r\n}\r\ngboolean\r\nringbuf_libpcap_dump_close(gchar **save_file, int *err)\r\n{\r\ngboolean ret_val = TRUE;\r\nif (rb_data.pdh != NULL) {\r\nif (fclose(rb_data.pdh) == EOF) {\r\nif (err != NULL) {\r\n*err = errno;\r\n}\r\nws_close(rb_data.fd);\r\nret_val = FALSE;\r\n}\r\nrb_data.pdh = NULL;\r\nrb_data.fd = -1;\r\n}\r\n*save_file = rb_data.files[rb_data.curr_file_num % rb_data.num_files].name;\r\nreturn ret_val;\r\n}\r\nvoid\r\nringbuf_free(void)\r\n{\r\nunsigned int i;\r\nif (rb_data.files != NULL) {\r\nfor (i=0; i < rb_data.num_files; i++) {\r\nif (rb_data.files[i].name != NULL) {\r\ng_free(rb_data.files[i].name);\r\nrb_data.files[i].name = NULL;\r\n}\r\n}\r\ng_free(rb_data.files);\r\nrb_data.files = NULL;\r\n}\r\nif (rb_data.fprefix != NULL) {\r\ng_free(rb_data.fprefix);\r\nrb_data.fprefix = NULL;\r\n}\r\nif (rb_data.fsuffix != NULL) {\r\ng_free(rb_data.fsuffix);\r\nrb_data.fsuffix = NULL;\r\n}\r\n}\r\nvoid\r\nringbuf_error_cleanup(void)\r\n{\r\nunsigned int i;\r\nif (rb_data.pdh != NULL) {\r\nif (fclose(rb_data.pdh) == 0) {\r\nrb_data.fd = -1;\r\n}\r\nrb_data.pdh = NULL;\r\n}\r\nif (rb_data.fd != -1) {\r\nws_close(rb_data.fd);\r\nrb_data.fd = -1;\r\n}\r\nif (rb_data.files != NULL) {\r\nfor (i=0; i < rb_data.num_files; i++) {\r\nif (rb_data.files[i].name != NULL) {\r\nws_unlink(rb_data.files[i].name);\r\n}\r\n}\r\n}\r\nringbuf_free();\r\n}

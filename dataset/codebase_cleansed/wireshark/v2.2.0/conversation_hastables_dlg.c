static guint\r\nconversation_hash_exact(gconstpointer v)\r\n{\r\nconst conversation_key *key = (const conversation_key *)v;\r\nguint hash_val;\r\nint i;\r\nconst guint8 *add_address_to_hash_data;\r\nhash_val = 0;\r\n#if 0\r\nhash_val = add_address_to_hash(hash_val, &key->addr1);\r\nhash_val += key->port1;\r\nhash_val = add_address_to_hash(hash_val, &key->addr2);\r\nhash_val += key->port2;\r\nreturn hash_val;\r\n#endif\r\nfor ( i = 0; i < key->addr1.len; i++ ) {\r\nadd_address_to_hash_data = (const guint8 *)((&key->addr1)->data);\r\nhash_val += add_address_to_hash_data[i];\r\nhash_val += ( hash_val << 10 );\r\nhash_val ^= ( hash_val >> 6 );\r\n}\r\nfor ( i = 0; i < 4; i++ ) {\r\nadd_address_to_hash_data = (const guint8 *)(&key->port1);\r\nhash_val += add_address_to_hash_data[i];\r\nhash_val += ( hash_val << 10 );\r\nhash_val ^= ( hash_val >> 6 );\r\n}\r\nfor ( i = 0; i < key->addr2.len; i++ ) {\r\nadd_address_to_hash_data = (const guint8 *)((&key->addr2)->data);\r\nhash_val += add_address_to_hash_data[i];\r\nhash_val += ( hash_val << 10 );\r\nhash_val ^= ( hash_val >> 6 );\r\n}\r\nfor ( i = 0; i < 4; i++ ) {\r\nadd_address_to_hash_data = (const guint8 *)(&key->port2);\r\nhash_val += add_address_to_hash_data[i];\r\nhash_val += ( hash_val << 10 );\r\nhash_val ^= ( hash_val >> 6 );\r\n}\r\nhash_val += ( hash_val << 3 );\r\nhash_val ^= ( hash_val >> 11 );\r\nhash_val += ( hash_val << 15 );\r\nreturn hash_val;\r\n}\r\nstatic guint\r\nconversation_hash_exact_old(gconstpointer v)\r\n{\r\nconst conversation_key *key = (const conversation_key *)v;\r\nguint hash_val;\r\nhash_val = 0;\r\nhash_val = add_address_to_hash(hash_val, &key->addr1);\r\nhash_val += key->port1;\r\nhash_val = add_address_to_hash(hash_val, &key->addr2);\r\nhash_val += key->port2;\r\nreturn hash_val;\r\n}\r\nstatic void\r\nconversation_hashtable_exact_to_texbuff(gpointer key, gpointer value _U_, gpointer user_data)\r\n{\r\ngchar string_buff[CONV_STR_BUF_MAX];\r\nGtkTextBuffer *buffer = (GtkTextBuffer*)user_data;\r\nconversation_key *conv_key = (conversation_key*)key;\r\ng_snprintf(string_buff, CONV_STR_BUF_MAX, "Key:0x%x old key:0x%x\n",conversation_hash_exact(conv_key),conversation_hash_exact_old(conv_key));\r\ngtk_text_buffer_insert_at_cursor (buffer, string_buff, -1);\r\n}\r\nstatic void\r\nconversation_info_to_texbuff(GtkTextBuffer *buffer)\r\n{\r\ngchar string_buff[CONV_STR_BUF_MAX];\r\nGHashTable *conversation_hashtable_exact;\r\nGHashTable *conversation_hashtable_no_addr2;\r\nGHashTable *conversation_hashtable_no_port2;\r\nGHashTable *conversation_hashtable_no_addr2_or_port2;\r\ng_snprintf(string_buff, CONV_STR_BUF_MAX, "Conversation hastables info:\n");\r\ngtk_text_buffer_insert_at_cursor (buffer, string_buff, -1);\r\nconversation_hashtable_exact = get_conversation_hashtable_exact();\r\nif(conversation_hashtable_exact){\r\ng_snprintf(string_buff, CONV_STR_BUF_MAX, "conversation_hashtable_exact %i entries\n#\n",\r\ng_hash_table_size(conversation_hashtable_exact));\r\ngtk_text_buffer_insert_at_cursor (buffer, string_buff, -1);\r\ng_hash_table_foreach( conversation_hashtable_exact, conversation_hashtable_exact_to_texbuff, buffer);\r\n}\r\nconversation_hashtable_no_addr2 = get_conversation_hashtable_no_addr2();\r\nif(conversation_hashtable_no_addr2){\r\ng_snprintf(string_buff, CONV_STR_BUF_MAX, "conversation_hashtable_no_addr2 %i entries\n#\n",\r\ng_hash_table_size(conversation_hashtable_no_addr2));\r\ngtk_text_buffer_insert_at_cursor (buffer, string_buff, -1);\r\n}\r\nconversation_hashtable_no_port2 = get_conversation_hashtable_no_port2();\r\nif(conversation_hashtable_no_port2){\r\ng_snprintf(string_buff, CONV_STR_BUF_MAX, "conversation_hashtable_no_port2 %i entries\n#\n",\r\ng_hash_table_size(conversation_hashtable_no_port2));\r\ngtk_text_buffer_insert_at_cursor (buffer, string_buff, -1);\r\n}\r\nconversation_hashtable_no_addr2_or_port2 = get_conversation_hashtable_no_addr2_or_port2();\r\nif(conversation_hashtable_no_addr2_or_port2){\r\ng_snprintf(string_buff, CONV_STR_BUF_MAX, "conversation_hashtable_no_addr2_or_port2 %i entries\n#\n",\r\ng_hash_table_size(conversation_hashtable_no_addr2_or_port2));\r\ngtk_text_buffer_insert_at_cursor (buffer, string_buff, -1);\r\n}\r\n}\r\nvoid\r\nconversation_hastables_dlg (GtkAction *action _U_, gpointer data _U_)\r\n{\r\nGtkWidget *vbox;\r\nGtkWidget *view;\r\nGtkWidget *scroll;\r\nGtkWidget *bbox;\r\nGtkWidget *ok_bt, *cancel_bt, *help_bt;\r\nGtkTextBuffer *buffer;\r\nconversation_hastables_dlg_w = dlg_window_new ("Conversation hastables");\r\ngtk_widget_set_size_request (conversation_hastables_dlg_w, 750, 350);\r\ngtk_window_set_resizable (GTK_WINDOW (conversation_hastables_dlg_w), TRUE);\r\ngtk_container_set_border_width (GTK_CONTAINER (conversation_hastables_dlg_w), DLG_OUTER_MARGIN);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_UNRELATED_SPACING, FALSE);\r\ngtk_container_add (GTK_CONTAINER (conversation_hastables_dlg_w), vbox);\r\ngtk_widget_show (vbox);\r\nview = gtk_text_view_new ();\r\ngtk_text_view_set_wrap_mode(GTK_TEXT_VIEW(view), GTK_WRAP_WORD);\r\nbuffer = gtk_text_view_get_buffer (GTK_TEXT_VIEW (view));\r\n#if GTK_CHECK_VERSION(3, 0, 0)\r\ngtk_widget_override_font(view, user_font_get_regular());\r\n#else\r\ngtk_widget_modify_font(view, user_font_get_regular());\r\n#endif\r\ngtk_widget_show (view);\r\nscroll = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(scroll),\r\nGTK_POLICY_NEVER, GTK_POLICY_AUTOMATIC);\r\ngtk_container_add(GTK_CONTAINER(scroll), view);\r\ngtk_widget_show(scroll);\r\ngtk_box_pack_start(GTK_BOX (vbox), scroll, TRUE, TRUE, 0);\r\nconversation_info_to_texbuff(buffer);\r\nbbox = dlg_button_row_new (GTK_STOCK_OK, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_end (GTK_BOX(vbox), bbox, FALSE, FALSE, 0);\r\nok_bt = (GtkWidget *)g_object_get_data (G_OBJECT(bbox), GTK_STOCK_OK);\r\ngtk_widget_set_sensitive (ok_bt, TRUE);\r\ncancel_bt = (GtkWidget *)g_object_get_data (G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button (conversation_hastables_dlg_w, cancel_bt, window_cancel_button_cb);\r\nhelp_bt = (GtkWidget *)g_object_get_data (G_OBJECT(bbox), GTK_STOCK_HELP);\r\n#if 0\r\ng_signal_connect (help_bt, "clicked",NULL, NULL);\r\n#endif\r\ngtk_widget_set_sensitive (help_bt, FALSE);\r\ngtk_widget_grab_default (ok_bt);\r\ngtk_widget_show (conversation_hastables_dlg_w);\r\n}

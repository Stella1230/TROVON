static gint\r\ninsert_sorted_by_name(gconstpointer aparam, gconstpointer bparam)\r\n{\r\nconst register_follow_t *a = (const register_follow_t *)aparam;\r\nconst register_follow_t *b = (const register_follow_t *)bparam;\r\nreturn g_ascii_strcasecmp(proto_get_protocol_short_name(find_protocol_by_id(a->proto_id)), proto_get_protocol_short_name(find_protocol_by_id(b->proto_id)));\r\n}\r\nvoid register_follow_stream(const int proto_id, const char* tap_listener,\r\nfollow_conv_filter_func conv_filter, follow_index_filter_func index_filter, follow_address_filter_func address_filter,\r\nfollow_port_to_display_func port_to_display, follow_tap_func tap_handler)\r\n{\r\nregister_follow_t *follower;\r\nDISSECTOR_ASSERT(tap_listener);\r\nDISSECTOR_ASSERT(conv_filter);\r\nDISSECTOR_ASSERT(index_filter);\r\nDISSECTOR_ASSERT(address_filter);\r\nDISSECTOR_ASSERT(port_to_display);\r\nDISSECTOR_ASSERT(tap_handler);\r\nfollower = g_new(register_follow_t,1);\r\nfollower->proto_id = proto_id;\r\nfollower->tap_listen_str = tap_listener;\r\nfollower->conv_filter = conv_filter;\r\nfollower->index_filter = index_filter;\r\nfollower->address_filter = address_filter;\r\nfollower->port_to_display = port_to_display;\r\nfollower->tap_handler = tap_handler;\r\nregistered_followers = g_slist_insert_sorted(registered_followers, follower, insert_sorted_by_name);\r\n}\r\nint get_follow_proto_id(register_follow_t* follower)\r\n{\r\nif (follower == NULL)\r\nreturn -1;\r\nreturn follower->proto_id;\r\n}\r\nconst char* get_follow_tap_string(register_follow_t* follower)\r\n{\r\nif (follower == NULL)\r\nreturn "";\r\nreturn follower->tap_listen_str;\r\n}\r\nfollow_conv_filter_func get_follow_conv_func(register_follow_t* follower)\r\n{\r\nreturn follower->conv_filter;\r\n}\r\nfollow_index_filter_func get_follow_index_func(register_follow_t* follower)\r\n{\r\nreturn follower->index_filter;\r\n}\r\nfollow_address_filter_func get_follow_address_func(register_follow_t* follower)\r\n{\r\nreturn follower->address_filter;\r\n}\r\nfollow_port_to_display_func get_follow_port_to_display(register_follow_t* follower)\r\n{\r\nreturn follower->port_to_display;\r\n}\r\nfollow_tap_func get_follow_tap_handler(register_follow_t* follower)\r\n{\r\nreturn follower->tap_handler;\r\n}\r\nregister_follow_t* get_follow_by_name(const char* proto_short_name)\r\n{\r\nguint i, size = g_slist_length(registered_followers);\r\nregister_follow_t *follower;\r\nGSList *slist;\r\nfor (i = 0; i < size; i++) {\r\nslist = g_slist_nth(registered_followers, i);\r\nfollower = (register_follow_t*)slist->data;\r\nif (strcmp(proto_short_name, proto_get_protocol_short_name(find_protocol_by_id(follower->proto_id))) == 0)\r\nreturn follower;\r\n}\r\nreturn NULL;\r\n}\r\nvoid follow_iterate_followers(GFunc func, gpointer user_data)\r\n{\r\ng_slist_foreach(registered_followers, func, user_data);\r\n}\r\ngchar* follow_get_stat_tap_string(register_follow_t* follower)\r\n{\r\nGString *cmd_str = g_string_new("follow,");\r\ng_string_append(cmd_str, proto_get_protocol_filter_name(follower->proto_id));\r\nreturn g_string_free(cmd_str, FALSE);\r\n}\r\nvoid\r\nfollow_reset_stream(follow_info_t* info)\r\n{\r\ninfo->bytes_written[0] = info->bytes_written[1] = 0;\r\ninfo->client_port = 0;\r\ninfo->server_port = 0;\r\ninfo->client_ip.type = FT_NONE;\r\ninfo->client_ip.len = 0;\r\ninfo->server_ip.type = FT_NONE;\r\ninfo->server_ip.len = 0;\r\n}\r\ngboolean\r\nfollow_tvb_tap_listener(void *tapdata, packet_info *pinfo,\r\nepan_dissect_t *edt _U_, const void *data)\r\n{\r\nfollow_record_t *follow_record;\r\nfollow_info_t *follow_info = (follow_info_t *)tapdata;\r\ntvbuff_t *next_tvb = (tvbuff_t *)data;\r\nfollow_record = g_new(follow_record_t,1);\r\nfollow_record->data = g_byte_array_sized_new(tvb_captured_length(next_tvb));\r\nfollow_record->data = g_byte_array_append(follow_record->data,\r\ntvb_get_ptr(next_tvb, 0, -1),\r\ntvb_captured_length(next_tvb));\r\nfollow_record->packet_num = pinfo->fd->num;\r\nif (follow_info->client_port == 0) {\r\nfollow_info->client_port = pinfo->srcport;\r\ncopy_address(&follow_info->client_ip, &pinfo->src);\r\nfollow_info->server_port = pinfo->destport;\r\ncopy_address(&follow_info->server_ip, &pinfo->dst);\r\n}\r\nif (addresses_equal(&follow_info->client_ip, &pinfo->src) && follow_info->client_port == pinfo->srcport)\r\nfollow_record->is_server = FALSE;\r\nelse\r\nfollow_record->is_server = TRUE;\r\nfollow_info->bytes_written[follow_record->is_server] += follow_record->data->len;\r\nfollow_info->payload = g_list_append(follow_info->payload, follow_record);\r\nreturn FALSE;\r\n}

static void\r\nncpstat_init(struct register_srt* srt _U_, GArray* srt_array, srt_gui_init_cb gui_callback, void* gui_data)\r\n{\r\ninit_srt_table("NCP", "Groups", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.group", gui_callback, gui_data, NULL);\r\ninit_srt_table("NDS Verbs", "NDS", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.ndsverb", gui_callback, gui_data, NULL);\r\ninit_srt_table("NCP Functions without Subfunctions", "Functions", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func", gui_callback, gui_data, NULL);\r\ninit_srt_table("Secret Store Verbs", "SSS", srt_array, NCP_NUM_PROCEDURES, NULL, "sss.subverb", gui_callback, gui_data, NULL);\r\ninit_srt_table("NMAS Verbs", "NMAS", srt_array, NCP_NUM_PROCEDURES, NULL, "nmas.subverb", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 17", "17", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==17 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 21", "21", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==21 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 22", "22", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==22 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 23", "23", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==23 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 32", "32", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==32 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 34", "34", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==34 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 35", "35", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==35 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 36", "36", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==36 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 86", "86", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==86 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 87", "87", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==87 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 89 (Extended NCP's with UTF8 Support)", "89", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==89 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 90", "90", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==90 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 92 (Secret Store Services)", "92", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==92 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 94 (Novell Modular Authentication Services)", "94", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==94 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 104", "104", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==104 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 111", "111", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==111 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 114", "114", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==114 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 123", "123", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==123 && ncp.subfunc", gui_callback, gui_data, NULL);\r\ninit_srt_table("Subfunctions for NCP 131", "131", srt_array, NCP_NUM_PROCEDURES, NULL, "ncp.func==131 && ncp.subfunc", gui_callback, gui_data, NULL);\r\n}\r\nstatic int\r\nncpstat_packet(void *pss, packet_info *pinfo, epan_dissect_t *edt _U_, const void *prv)\r\n{\r\nguint i = 0;\r\nsrt_stat_table *ncp_srt_table;\r\nsrt_data_t *data = (srt_data_t *)pss;\r\nconst ncp_req_hash_value *request_val=(const ncp_req_hash_value *)prv;\r\ngchar* tmp_str;\r\nif(!request_val || request_val->ncp_rec==0){\r\nreturn 0;\r\n}\r\ntmp_str = val_to_str_wmem(NULL, request_val->ncp_rec->group, ncp_group_vals, "Unknown(%u)");\r\ni = NCP_NCP_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, request_val->ncp_rec->group, tmp_str);\r\nwmem_free(NULL, tmp_str);\r\nadd_srt_table_data(ncp_srt_table, request_val->ncp_rec->group, &request_val->req_frame_time, pinfo);\r\nif (request_val->ncp_rec->subfunc==0) {\r\ni = NCP_FUNC_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, request_val->ncp_rec->func, request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, request_val->ncp_rec->func, &request_val->req_frame_time, pinfo);\r\n}\r\nif(request_val->ncp_rec->subfunc!=0){\r\nif (request_val->ncp_rec->func==17) {\r\ni = NCP_SUB17_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==21) {\r\ni = NCP_SUB21_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==22) {\r\ni = NCP_SUB22_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==23) {\r\ni = NCP_SUB23_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==32) {\r\ni = NCP_SUB32_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==34) {\r\ni = NCP_SUB34_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==35) {\r\ni = NCP_SUB35_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==36) {\r\ni = NCP_SUB36_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==86) {\r\ni = NCP_SUB86_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==87) {\r\ni = NCP_SUB87_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==89) {\r\ni = NCP_SUB89_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==90) {\r\ni = NCP_SUB90_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==92) {\r\ni = NCP_SUB92_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==94) {\r\ni = NCP_SUB94_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==104) {\r\ni = NCP_SUB104_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==111) {\r\ni = NCP_SUB111_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==114) {\r\ni = NCP_SUB114_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==123) {\r\ni = NCP_SUB123_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\nif (request_val->ncp_rec->func==131) {\r\ni = NCP_SUB131_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->ncp_rec->subfunc), request_val->ncp_rec->name);\r\nadd_srt_table_data(ncp_srt_table, (request_val->ncp_rec->subfunc), &request_val->req_frame_time, pinfo);\r\n}\r\n}\r\nif (request_val->ncp_rec->func==0x68) {\r\ntmp_str = val_to_str_wmem(NULL, request_val->nds_request_verb, ncp_nds_verb_vals, "Unknown(%u)");\r\ni = NCP_NDS_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->nds_request_verb), tmp_str);\r\nadd_srt_table_data(ncp_srt_table, (request_val->nds_request_verb), &request_val->req_frame_time, pinfo);\r\nwmem_free(NULL, tmp_str);\r\n}\r\nif (request_val->ncp_rec->func==0x5c) {\r\ntmp_str = val_to_str_wmem(NULL, request_val->req_nds_flags, sss_verb_enum, "Unknown(%u)");\r\ni = NCP_SSS_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->req_nds_flags), tmp_str);\r\nadd_srt_table_data(ncp_srt_table, (request_val->req_nds_flags), &request_val->req_frame_time, pinfo);\r\nwmem_free(NULL, tmp_str);\r\n}\r\nif (request_val->ncp_rec->func==0x5e) {\r\ntmp_str = val_to_str_wmem(NULL, request_val->req_nds_flags, nmas_subverb_enum, "Unknown(%u)");\r\ni = NCP_NMAS_SRT_TABLE_INDEX;\r\nncp_srt_table = g_array_index(data->srt_array, srt_stat_table*, i);\r\ninit_srt_table_row(ncp_srt_table, (request_val->req_nds_flags), tmp_str);\r\nadd_srt_table_data(ncp_srt_table, (request_val->req_nds_flags), &request_val->req_frame_time, pinfo);\r\nwmem_free(NULL, tmp_str);\r\n}\r\nreturn 1;\r\n}\r\nstatic gint\r\nmncp_equal(gconstpointer v, gconstpointer v2)\r\n{\r\nconst mncp_rhash_key *val1 = (const mncp_rhash_key*)v;\r\nconst mncp_rhash_key *val2 = (const mncp_rhash_key*)v2;\r\nif (val1->conversation == val2->conversation && val1->nwconnection == val2->nwconnection && val1->nwtask == val2->nwtask) {\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic guint\r\nmncp_hash(gconstpointer v)\r\n{\r\nconst mncp_rhash_key *mncp_key = (const mncp_rhash_key*)v;\r\nreturn GPOINTER_TO_UINT(mncp_key->conversation)+mncp_key->nwconnection+mncp_key->nwtask;\r\n}\r\nstatic void\r\nmncp_init_protocol(void)\r\n{\r\nmncp_rhash = g_hash_table_new(mncp_hash, mncp_equal);\r\n}\r\nstatic void\r\nmncp_cleanup_protocol(void)\r\n{\r\ng_hash_table_destroy(mncp_rhash);\r\n}\r\nstatic mncp_rhash_value*\r\nmncp_hash_insert(conversation_t *conversation, guint32 nwconnection, guint8 nwtask, packet_info *pinfo)\r\n{\r\nmncp_rhash_key *key;\r\nmncp_rhash_value *value;\r\nkey = wmem_new(wmem_file_scope(), mncp_rhash_key);\r\nkey->conversation = conversation;\r\nkey->nwconnection = nwconnection;\r\nkey->nwtask = nwtask;\r\nvalue = wmem_new(wmem_file_scope(), mncp_rhash_value);\r\ng_hash_table_insert(mncp_rhash, key, value);\r\nif (ncp_echo_conn && nwconnection != 65535) {\r\nexpert_add_info_format(pinfo, NULL, &ei_ncp_new_server_session, "Detected New Server Session. Connection %d, Task %d", nwconnection, nwtask);\r\nvalue->session_start_packet_num = pinfo->num;\r\n}\r\nreturn value;\r\n}\r\nstatic mncp_rhash_value*\r\nmncp_hash_lookup(conversation_t *conversation, guint32 nwconnection, guint8 nwtask)\r\n{\r\nmncp_rhash_key key;\r\nkey.conversation = conversation;\r\nkey.nwconnection = nwconnection;\r\nkey.nwtask = nwtask;\r\nreturn (mncp_rhash_value *)g_hash_table_lookup(mncp_rhash, &key);\r\n}\r\nstatic const char* ncp_conv_get_filter_type(conv_item_t* conv _U_, conv_filter_type_e filter)\r\n{\r\nif ((filter == CONV_FT_SRC_PORT) || (filter == CONV_FT_DST_PORT) || (filter == CONV_FT_ANY_PORT))\r\nreturn "ncp.connection";\r\nreturn CONV_FILTER_INVALID;\r\n}\r\nstatic int\r\nncp_conversation_packet(void *pct, packet_info *pinfo, epan_dissect_t *edt _U_, const void *vip)\r\n{\r\nconv_hash_t *hash = (conv_hash_t*) pct;\r\nconst struct ncp_common_header *ncph=(const struct ncp_common_header *)vip;\r\nguint32 connection;\r\nconnection = (ncph->conn_high * 256)+ncph->conn_low;\r\nif (connection < 65535) {\r\nadd_conversation_table_data(hash, &pinfo->src, &pinfo->dst, connection, connection, 1, pinfo->fd->pkt_len, &pinfo->rel_ts, &pinfo->abs_ts, &ncp_ct_dissector_info, PT_NCP);\r\n}\r\nreturn 1;\r\n}\r\nstatic const char* ncp_host_get_filter_type(hostlist_talker_t* host _U_, conv_filter_type_e filter)\r\n{\r\nreturn ncp_conv_get_filter_type(NULL, filter);\r\n}\r\nstatic int\r\nncp_hostlist_packet(void *pit, packet_info *pinfo, epan_dissect_t *edt _U_, const void *vip _U_)\r\n{\r\nconv_hash_t *hash = (conv_hash_t*) pit;\r\nadd_hostlist_table_data(hash, &pinfo->src, 0, TRUE, 1, pinfo->fd->pkt_len, &ncp_host_dissector_info, PT_NCP);\r\nadd_hostlist_table_data(hash, &pinfo->dst, 0, FALSE, 1, pinfo->fd->pkt_len, &ncp_host_dissector_info, PT_NCP);\r\nreturn 1;\r\n}\r\nstatic void\r\ndissect_ncp_common(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\ngboolean is_tcp)\r\n{\r\nproto_tree *ncp_tree = NULL;\r\nproto_item *ti;\r\nstruct ncp_ip_header ncpiph;\r\nstruct ncp_ip_rqhdr ncpiphrq;\r\nguint16 ncp_burst_seqno, ncp_ack_seqno;\r\nguint16 flags = 0;\r\nproto_tree *flags_tree = NULL;\r\nint hdr_offset = 0;\r\nint commhdr = 0;\r\nint offset = 0;\r\ngint length_remaining;\r\ntvbuff_t *next_tvb;\r\nguint32 testvar = 0, ncp_burst_command, burst_len, burst_off, burst_file;\r\nguint8 subfunction;\r\nguint32 nw_connection = 0, data_offset;\r\nguint16 data_len = 0;\r\nguint16 missing_fraglist_count = 0;\r\nmncp_rhash_value *request_value = NULL;\r\nconversation_t *conversation;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "NCP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nncp_hdr = &header;\r\nti = proto_tree_add_item(tree, proto_ncp, tvb, 0, -1, ENC_NA);\r\nncp_tree = proto_item_add_subtree(ti, ett_ncp);\r\nif (is_tcp) {\r\nif (tvb_get_ntohl(tvb, hdr_offset) != NCPIP_RQST && tvb_get_ntohl(tvb, hdr_offset) != NCPIP_RPLY)\r\ncommhdr += 1;\r\nncpiph.signature = tvb_get_ntohl(tvb, commhdr);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_ip_sig, tvb, commhdr, 4, ncpiph.signature);\r\nncpiph.length = (0x7fffffff & tvb_get_ntohl(tvb, commhdr+4));\r\nproto_tree_add_uint(ncp_tree, hf_ncp_ip_length, tvb, commhdr+4, 4, ncpiph.length);\r\ncommhdr += 8;\r\nif (ncpiph.signature == NCPIP_RQST) {\r\nncpiphrq.version = tvb_get_ntohl(tvb, commhdr);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_ip_ver, tvb, commhdr, 4, ncpiphrq.version);\r\ncommhdr += 4;\r\nncpiphrq.rplybufsize = tvb_get_ntohl(tvb, commhdr);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_ip_rplybufsize, tvb, commhdr, 4, ncpiphrq.rplybufsize);\r\ncommhdr += 4;\r\n}\r\nif (try_val_to_str(tvb_get_ntohs(tvb, commhdr), ncp_type_vals)==NULL) {\r\nif (try_val_to_str(tvb_get_ntohs(tvb, commhdr+8), ncp_type_vals)!=NULL) {\r\nproto_tree_add_item(ncp_tree, hf_ncp_ip_packetsig, tvb, commhdr, 8, ENC_NA);\r\ncommhdr += 8;\r\n}\r\n}\r\n} else {\r\nmemset(&ncpiph, 0, sizeof(ncpiph));\r\n}\r\nheader.type = tvb_get_ntohs(tvb, commhdr);\r\nheader.sequence = tvb_get_guint8(tvb, commhdr+2);\r\nheader.conn_low = tvb_get_guint8(tvb, commhdr+3);\r\nheader.task = tvb_get_guint8(tvb, commhdr+4);\r\nheader.conn_high = tvb_get_guint8(tvb, commhdr+5);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_type, tvb, commhdr, 2, header.type);\r\nnw_connection = (header.conn_high*256)+header.conn_low;\r\nconversation = find_conversation(pinfo->num, &pinfo->src, &pinfo->dst,\r\nPT_NCP, (guint32) pinfo->srcport, (guint32) pinfo->destport,\r\n0);\r\nif ((ncpiph.length & 0x80000000) || ncpiph.signature == NCPIP_RPLY) {\r\nif (!pinfo->fd->flags.visited) {\r\nif (conversation != NULL) {\r\nrequest_value = mncp_hash_lookup(conversation, nw_connection, header.task);\r\nif (request_value == NULL) {\r\nmncp_hash_insert(conversation, nw_connection, header.task, pinfo);\r\n}\r\n} else {\r\nconversation = conversation_new(pinfo->num, &pinfo->src,\r\n&pinfo->dst, PT_NCP, (guint32) pinfo->srcport, (guint32) pinfo->destport, 0);\r\nmncp_hash_insert(conversation, nw_connection, header.task, pinfo);\r\n}\r\nif (ncpiph.signature == NCPIP_RPLY) {\r\n}\r\n} else {\r\nrequest_value = mncp_hash_lookup(conversation, nw_connection, header.task);\r\nif (request_value) {\r\nif ((request_value->session_start_packet_num == pinfo->num) && ncp_echo_conn) {\r\nexpert_add_info_format(pinfo, NULL, &ei_ncp_new_server_session, "Detected New Server Session. Connection %d, Task %d", nw_connection, header.task);\r\n}\r\n}\r\n}\r\n} else {\r\nif (!pinfo->fd->flags.visited) {\r\nif (conversation != NULL) {\r\nrequest_value = mncp_hash_lookup(conversation, nw_connection, header.task);\r\nif (request_value == NULL) {\r\nmncp_hash_insert(conversation, nw_connection, header.task, pinfo);\r\n}\r\n} else {\r\nconversation = conversation_new(pinfo->num, &pinfo->src,\r\n&pinfo->dst, PT_NCP, (guint32) pinfo->srcport, (guint32) pinfo->destport, 0);\r\nmncp_hash_insert(conversation, nw_connection, header.task, pinfo);\r\n}\r\n} else {\r\nrequest_value = mncp_hash_lookup(conversation, nw_connection, header.task);\r\nif (request_value) {\r\nif ((request_value->session_start_packet_num == pinfo->num) && ncp_echo_conn) {\r\nexpert_add_info_format(pinfo, NULL, &ei_ncp_new_server_session, "Detected New Server Session. Connection %d, Task %d", nw_connection, header.task);\r\n}\r\n}\r\n}\r\n}\r\ntap_queue_packet(ncp_tap.hdr, pinfo, ncp_hdr);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(header.type, ncp_type_vals, "Unknown type (0x%04x)"));\r\nswitch (header.type) {\r\ncase NCP_BROADCAST_SLOT:\r\nproto_tree_add_uint(ncp_tree, hf_ncp_seq, tvb, commhdr + 2, 1, header.sequence);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_connection,tvb, commhdr + 3, 3, nw_connection);\r\nproto_tree_add_item(ncp_tree, hf_ncp_task, tvb, commhdr + 4, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_oplock_flag, tvb, commhdr + 9, 1, tvb_get_guint8(tvb, commhdr+9));\r\nproto_tree_add_item(ncp_tree, hf_ncp_oplock_handle, tvb, commhdr + 10, 4, ENC_BIG_ENDIAN);\r\nif ((tvb_get_guint8(tvb, commhdr+9)==0x24) && ncp_echo_file) {\r\nexpert_add_info_format(pinfo, NULL, &ei_ncp_oplock_handle, "Server requesting station to clear oplock on handle - %08x", tvb_get_ntohl(tvb, commhdr+10));\r\n}\r\nbreak;\r\ncase NCP_LIP_ECHO:\r\nproto_tree_add_item(ncp_tree, hf_lip_echo, tvb, commhdr, 13, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase NCP_BURST_MODE_XFER:\r\nflags = tvb_get_guint8(tvb, commhdr + 2);\r\nti = proto_tree_add_uint(ncp_tree, hf_ncp_system_flags,\r\ntvb, commhdr + 2, 1, flags);\r\nflags_tree = proto_item_add_subtree(ti, ett_ncp_system_flags);\r\nproto_tree_add_item(flags_tree, hf_ncp_system_flags_abt,\r\ntvb, commhdr + 2, 1, ENC_BIG_ENDIAN);\r\nif (flags & ABT) {\r\nproto_item_append_text(ti, " ABT");\r\n}\r\nflags&=(~( ABT ));\r\nproto_tree_add_item(flags_tree, hf_ncp_system_flags_bsy,\r\ntvb, commhdr + 2, 1, ENC_BIG_ENDIAN);\r\nif (flags & BSY) {\r\nproto_item_append_text(ti, " BSY");\r\n}\r\nflags&=(~( BSY ));\r\nproto_tree_add_item(flags_tree, hf_ncp_system_flags_eob,\r\ntvb, commhdr + 2, 1, ENC_BIG_ENDIAN);\r\nif (flags & EOB) {\r\nproto_item_append_text(ti, " EOB");\r\n}\r\nflags&=(~( EOB ));\r\nproto_tree_add_item(flags_tree, hf_ncp_system_flags_lst,\r\ntvb, commhdr + 2, 1, ENC_BIG_ENDIAN);\r\nif (flags & LST) {\r\nproto_item_append_text(ti, " LST");\r\n}\r\nflags&=(~( LST ));\r\nproto_tree_add_item(flags_tree, hf_ncp_system_flags_sys,\r\ntvb, commhdr + 2, 1, ENC_BIG_ENDIAN);\r\nif (flags & SYS) {\r\nproto_item_append_text(ti, " SYS");\r\n}\r\nflags&=(~( SYS ));\r\nproto_tree_add_item(ncp_tree, hf_ncp_stream_type,\r\ntvb, commhdr + 3, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_src_connection,\r\ntvb, commhdr + 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_dst_connection,\r\ntvb, commhdr + 8, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_packet_seqno,\r\ntvb, commhdr + 12, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_delay_time,\r\ntvb, commhdr + 16, 4, ENC_BIG_ENDIAN);\r\nncp_burst_seqno = tvb_get_ntohs(tvb, commhdr+20);\r\nproto_tree_add_item(ncp_tree, hf_ncp_burst_seqno,\r\ntvb, commhdr + 20, 2, ENC_BIG_ENDIAN);\r\nncp_ack_seqno = tvb_get_ntohs(tvb, commhdr+22);\r\nproto_tree_add_item(ncp_tree, hf_ncp_ack_seqno,\r\ntvb, commhdr + 22, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_burst_len,\r\ntvb, commhdr + 24, 4, ENC_BIG_ENDIAN);\r\ndata_offset = tvb_get_ntohl(tvb, commhdr + 28);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_data_offset,\r\ntvb, commhdr + 28, 4, data_offset);\r\ndata_len = tvb_get_ntohs(tvb, commhdr + 32);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_data_bytes,\r\ntvb, commhdr + 32, 2, data_len);\r\nmissing_fraglist_count = tvb_get_ntohs(tvb, commhdr + 34);\r\nproto_tree_add_item(ncp_tree, hf_ncp_missing_fraglist_count,\r\ntvb, commhdr + 34, 2, ENC_BIG_ENDIAN);\r\noffset = commhdr + 36;\r\nif (!(flags & SYS) && ncp_burst_seqno == ncp_ack_seqno &&\r\ndata_offset == 0) {\r\nif (data_len < 4)\r\nreturn;\r\nncp_burst_command = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(ncp_tree, hf_ncp_burst_command,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndata_len -= 4;\r\nif (data_len < 4)\r\nreturn;\r\nburst_file = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(ncp_tree, hf_ncp_burst_file_handle,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndata_len -= 4;\r\nif (data_len < 8)\r\nreturn;\r\nproto_tree_add_item(ncp_tree, hf_ncp_burst_reserved,\r\ntvb, offset, 8, ENC_NA);\r\noffset += 8;\r\ndata_len -= 8;\r\nif (data_len < 4)\r\nreturn;\r\nburst_off = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_burst_offset,\r\ntvb, offset, 4, burst_off);\r\noffset += 4;\r\ndata_len -= 4;\r\nif (data_len < 4)\r\nreturn;\r\nburst_len = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_burst_len,\r\ntvb, offset, 4, burst_len);\r\noffset += 4;\r\ndata_len -= 4;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"%s %d bytes starting at offset %d in file 0x%08x",\r\nval_to_str(ncp_burst_command,\r\nburst_command, "Unknown (0x%08x)"),\r\nburst_len, burst_off, burst_file);\r\nbreak;\r\n} else {\r\nif (tvb_get_guint8(tvb, commhdr + 2) & 0x10) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "End of Burst");\r\n}\r\n}\r\nbreak;\r\ncase NCP_ALLOCATE_SLOT:\r\nlength_remaining = tvb_reported_length_remaining(tvb, commhdr + 4);\r\nif (length_remaining > 4) {\r\ntestvar = tvb_get_ntohl(tvb, commhdr+4);\r\nif (testvar == 0x4c495020) {\r\nproto_tree_add_item(ncp_tree, hf_lip_echo, tvb, commhdr+4, 13, ENC_ASCII|ENC_NA);\r\nbreak;\r\n}\r\n}\r\ncase NCP_POSITIVE_ACK:\r\ncase NCP_SERVICE_REQUEST:\r\ncase NCP_SERVICE_REPLY:\r\ncase NCP_WATCHDOG:\r\ncase NCP_DEALLOCATE_SLOT:\r\ndefault:\r\nproto_tree_add_uint(ncp_tree, hf_ncp_seq, tvb, commhdr + 2, 1, header.sequence);\r\nproto_tree_add_uint(ncp_tree, hf_ncp_connection,tvb, commhdr + 3, 3, nw_connection);\r\nproto_tree_add_item(ncp_tree, hf_ncp_task, tvb, commhdr + 4, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\nswitch (header.type) {\r\ncase NCP_ALLOCATE_SLOT:\r\nlength_remaining = tvb_reported_length_remaining(tvb, commhdr + 4);\r\nif (length_remaining > 4) {\r\ntestvar = tvb_get_ntohl(tvb, commhdr+4);\r\nif (testvar == 0x4c495020) {\r\nproto_tree_add_item(ncp_tree, hf_lip_echo, tvb, commhdr, -1, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\nnext_tvb = tvb_new_subset_remaining(tvb, commhdr);\r\ndissect_ncp_request(next_tvb, pinfo, nw_connection,\r\nheader.sequence, header.type, ncp_tree);\r\nbreak;\r\ncase NCP_DEALLOCATE_SLOT:\r\nnext_tvb = tvb_new_subset_remaining(tvb, commhdr);\r\ndissect_ncp_request(next_tvb, pinfo, nw_connection,\r\nheader.sequence, header.type, ncp_tree);\r\nbreak;\r\ncase NCP_SERVICE_REQUEST:\r\ncase NCP_BROADCAST_SLOT:\r\nnext_tvb = tvb_new_subset_remaining(tvb, commhdr);\r\nif (tvb_get_guint8(tvb, commhdr+6) == 0x68) {\r\nsubfunction = tvb_get_guint8(tvb, commhdr+7);\r\nswitch (subfunction) {\r\ncase 0x02:\r\ndissect_nds_request(next_tvb, pinfo,\r\nnw_connection, header.sequence,\r\nheader.type, ncp_tree);\r\nbreak;\r\ncase 0x01:\r\ndissect_ping_req(next_tvb, pinfo,\r\nnw_connection, header.sequence,\r\nheader.type, ncp_tree);\r\nbreak;\r\ndefault:\r\ndissect_ncp_request(next_tvb, pinfo,\r\nnw_connection, header.sequence,\r\nheader.type, ncp_tree);\r\nbreak;\r\n}\r\n} else {\r\ndissect_ncp_request(next_tvb, pinfo, nw_connection,\r\nheader.sequence, header.type, ncp_tree);\r\n}\r\nbreak;\r\ncase NCP_SERVICE_REPLY:\r\nnext_tvb = tvb_new_subset_remaining(tvb, commhdr);\r\nnds_defrag(next_tvb, pinfo, nw_connection, header.sequence,\r\nheader.type, ncp_tree, &ncp_tap);\r\nbreak;\r\ncase NCP_POSITIVE_ACK:\r\nnext_tvb = tvb_new_subset_remaining(tvb, commhdr);\r\ndissect_ncp_reply(next_tvb, pinfo, nw_connection,\r\nheader.sequence, header.type, ncp_tree, &ncp_tap);\r\nbreak;\r\ncase NCP_WATCHDOG:\r\nproto_tree_add_item(ncp_tree, hf_ncp_completion_code,\r\ntvb, commhdr + 6, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_connection_status,\r\ntvb, commhdr + 7, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_slot,\r\ntvb, commhdr + 8, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ncp_tree, hf_ncp_control_code,\r\ntvb, commhdr + 9, 1, ENC_LITTLE_ENDIAN);\r\nif (tvb_offset_exists(tvb, commhdr + 10)) {\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, commhdr + 10),\r\npinfo, ncp_tree);\r\n}\r\nbreak;\r\ncase NCP_BURST_MODE_XFER:\r\nif (flags & SYS) {\r\nwhile (missing_fraglist_count != 0) {\r\nproto_tree_add_item(ncp_tree, hf_ncp_missing_data_offset,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ncp_tree, hf_ncp_missing_data_count,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nmissing_fraglist_count--;\r\n}\r\n} else {\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\nif (length_remaining > data_len)\r\nlength_remaining = data_len;\r\nif (data_len != 0) {\r\ncall_data_dissector(tvb_new_subset(tvb, offset,\r\nlength_remaining, data_len),\r\npinfo, ncp_tree);\r\n}\r\n}\r\nbreak;\r\ncase NCP_LIP_ECHO:\r\nproto_tree_add_item(ncp_tree, hf_lip_echo, tvb, commhdr, -1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ndefault:\r\nproto_tree_add_expert_format(ncp_tree, pinfo, &ei_ncp_type, tvb, commhdr + 6, -1,\r\n"%s packets not supported yet",\r\nval_to_str(header.type, ncp_type_vals,\r\n"Unknown type (0x%04x)"));\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_ncp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ndissect_ncp_common(tvb, pinfo, tree, FALSE);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_ncp_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset, void *data _U_)\r\n{\r\nguint32 signature;\r\nsignature = tvb_get_ntohl(tvb, offset);\r\nif (signature != NCPIP_RQST && signature != NCPIP_RPLY)\r\nreturn tvb_captured_length_remaining(tvb, offset);\r\nreturn tvb_get_ntohl(tvb, offset + 4) & 0x7fffffff;\r\n}\r\nstatic int\r\ndissect_ncp_tcp_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ndissect_ncp_common(tvb, pinfo, tree, TRUE);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_ncp_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, ncp_desegment, 8, get_ncp_pdu_len,\r\ndissect_ncp_tcp_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ncp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ncp_ip_sig,\r\n{ "NCP over IP signature", "ncp.ip.signature",\r\nFT_UINT32, BASE_HEX, VALS(ncp_ip_signature), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_ip_length,\r\n{ "NCP over IP length", "ncp.ip.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_ip_ver,\r\n{ "NCP over IP Version", "ncp.ip.version",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_ip_rplybufsize,\r\n{ "NCP over IP Reply Buffer Size", "ncp.ip.replybufsize",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_ip_packetsig,\r\n{ "NCP over IP Packet Signature", "ncp.ip.packetsig",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_type,\r\n{ "Type", "ncp.type",\r\nFT_UINT16, BASE_HEX, VALS(ncp_type_vals), 0x0,\r\n"NCP message type", HFILL }},\r\n{ &hf_ncp_seq,\r\n{ "Sequence Number", "ncp.seq",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_connection,\r\n{ "Connection Number", "ncp.connection",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_task,\r\n{ "Task Number", "ncp.task",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_oplock_flag,\r\n{ "Broadcast Message Flag", "ncp.msg_flag",\r\nFT_UINT8, BASE_HEX, VALS(ncp_oplock_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_oplock_handle,\r\n{ "File Handle", "ncp.oplock_handle",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_stream_type,\r\n{ "Stream Type", "ncp.stream_type",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\n"Type of burst", HFILL }},\r\n{ &hf_ncp_system_flags,\r\n{ "System Flags", "ncp.system_flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_system_flags_abt,\r\n{ "ABT", "ncp.system_flags.abt",\r\nFT_BOOLEAN, 8, NULL, ABT,\r\n"Is this an abort request?", HFILL }},\r\n{ &hf_ncp_system_flags_eob,\r\n{ "EOB", "ncp.system_flags.eob",\r\nFT_BOOLEAN, 8, NULL, EOB,\r\n"Is this the last packet of the burst?", HFILL }},\r\n{ &hf_ncp_system_flags_sys,\r\n{ "SYS", "ncp.system_flags.sys",\r\nFT_BOOLEAN, 8, NULL, SYS,\r\n"Is this a system packet?", HFILL }},\r\n{ &hf_ncp_system_flags_bsy,\r\n{ "BSY", "ncp.system_flags.bsy",\r\nFT_BOOLEAN, 8, NULL, BSY,\r\n"Is the server busy?", HFILL }},\r\n{ &hf_ncp_system_flags_lst,\r\n{ "LST", "ncp.system_flags.lst",\r\nFT_BOOLEAN, 8, NULL, LST,\r\n"Return Fragment List?", HFILL }},\r\n{ &hf_ncp_src_connection,\r\n{ "Source Connection ID", "ncp.src_connection",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"The workstation's connection identification number", HFILL }},\r\n{ &hf_ncp_dst_connection,\r\n{ "Destination Connection ID", "ncp.dst_connection",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"The server's connection identification number", HFILL }},\r\n{ &hf_ncp_packet_seqno,\r\n{ "Packet Sequence Number", "ncp.packet_seqno",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Sequence number of this packet in a burst", HFILL }},\r\n{ &hf_ncp_delay_time,\r\n{ "Delay Time", "ncp.delay_time",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Delay time between consecutive packet sends (100 us increments)", HFILL }},\r\n{ &hf_ncp_burst_seqno,\r\n{ "Burst Sequence Number", "ncp.burst_seqno",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Sequence number of this packet in the burst", HFILL }},\r\n{ &hf_ncp_ack_seqno,\r\n{ "ACK Sequence Number", "ncp.ack_seqno",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Next expected burst sequence number", HFILL }},\r\n{ &hf_ncp_burst_len,\r\n{ "Burst Length", "ncp.burst_len",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Total length of data in this burst", HFILL }},\r\n{ &hf_ncp_burst_offset,\r\n{ "Burst Offset", "ncp.burst_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Offset of data in the burst", HFILL }},\r\n{ &hf_ncp_data_offset,\r\n{ "Data Offset", "ncp.data_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Offset of this packet", HFILL }},\r\n{ &hf_ncp_data_bytes,\r\n{ "Data Bytes", "ncp.data_bytes",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Number of data bytes in this packet", HFILL }},\r\n{ &hf_ncp_missing_fraglist_count,\r\n{ "Missing Fragment List Count", "ncp.missing_fraglist_count",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Number of missing fragments reported", HFILL }},\r\n{ &hf_ncp_missing_data_offset,\r\n{ "Missing Data Offset", "ncp.missing_data_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Offset of beginning of missing data", HFILL }},\r\n{ &hf_ncp_missing_data_count,\r\n{ "Missing Data Count", "ncp.missing_data_count",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Number of bytes of missing data", HFILL }},\r\n{ &hf_ncp_completion_code,\r\n{ "Completion Code", "ncp.completion_code",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_connection_status,\r\n{ "Connection Status", "ncp.connection_status",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_slot,\r\n{ "Slot", "ncp.slot",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_control_code,\r\n{ "Control Code", "ncp.control_code",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n#if 0\r\n{ &hf_ncp_fragment_handle,\r\n{ "Fragment Handle", "ncp.fragger_hndl",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n#endif\r\n{ &hf_lip_echo,\r\n{ "Large Internet Packet Echo", "ncp.lip_echo",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ncp_burst_command,\r\n{ "Burst Command", "ncp.burst_command",\r\nFT_UINT32, BASE_HEX, VALS(burst_command), 0x0,\r\n"Packet Burst Command", HFILL }},\r\n{ &hf_ncp_burst_file_handle,\r\n{ "Burst File Handle", "ncp.burst_file_handle",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"Packet Burst File Handle", HFILL }},\r\n{ &hf_ncp_burst_reserved,\r\n{ "Reserved", "ncp.burst_reserved",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ncp,\r\n&ett_ncp_system_flags,\r\n&ett_nds,\r\n&ett_nds_segments,\r\n&ett_nds_segment\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ncp_new_server_session, { "ncp.new_server_session", PI_RESPONSE_CODE, PI_CHAT, "Detected New Server Session", EXPFILL }},\r\n{ &ei_ncp_oplock_handle, { "ncp.oplock_handle.clear", PI_RESPONSE_CODE, PI_CHAT, "Server requesting station to clear oplock", EXPFILL }},\r\n{ &ei_ncp_type, { "ncp.type.unsupported", PI_UNDECODED, PI_NOTE, "Packet type not supported yet", EXPFILL }},\r\n};\r\nmodule_t *ncp_module;\r\nexpert_module_t* expert_ncp;\r\nproto_ncp = proto_register_protocol("NetWare Core Protocol", "NCP", "ncp");\r\nproto_register_field_array(proto_ncp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_ncp = expert_register_protocol(proto_ncp);\r\nexpert_register_field_array(expert_ncp, ei, array_length(ei));\r\nncp_module = prefs_register_protocol(proto_ncp, NULL);\r\nprefs_register_obsolete_preference(ncp_module, "initial_hash_size");\r\nprefs_register_bool_preference(ncp_module, "desegment",\r\n"Reassemble NCP-over-TCP messages spanning multiple TCP segments",\r\n"Whether the NCP dissector should reassemble messages spanning multiple TCP segments."\r\n" To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&ncp_desegment);\r\nprefs_register_bool_preference(ncp_module, "defragment_nds",\r\n"Reassemble fragmented NDS messages spanning multiple reply packets",\r\n"Whether the NCP dissector should defragment NDS messages spanning multiple reply packets.",\r\n&nds_defragment);\r\nprefs_register_bool_preference(ncp_module, "newstyle",\r\n"Dissect New Netware Information Structure",\r\n"Dissect the NetWare Information Structure as NetWare 5.x or higher or as older NetWare 3.x.",\r\n&ncp_newstyle);\r\nprefs_register_bool_preference(ncp_module, "eid_2_expert",\r\n"Expert: EID to Name lookups?",\r\n"Whether the NCP dissector should echo the NDS Entry ID to name resolves to the expert table.",\r\n&nds_echo_eid);\r\nprefs_register_bool_preference(ncp_module, "connection_2_expert",\r\n"Expert: NCP Connections?",\r\n"Whether the NCP dissector should echo NCP connection information to the expert table.",\r\n&ncp_echo_conn);\r\nprefs_register_bool_preference(ncp_module, "error_2_expert",\r\n"Expert: NCP Errors?",\r\n"Whether the NCP dissector should echo protocol errors to the expert table.",\r\n&ncp_echo_err);\r\nprefs_register_bool_preference(ncp_module, "server_2_expert",\r\n"Expert: Server Information?",\r\n"Whether the NCP dissector should echo server information to the expert table.",\r\n&ncp_echo_server);\r\nprefs_register_bool_preference(ncp_module, "file_2_expert",\r\n"Expert: File Information?",\r\n"Whether the NCP dissector should echo file open/close/oplock information to the expert table.",\r\n&ncp_echo_file);\r\nregister_init_routine(&mncp_init_protocol);\r\nregister_cleanup_routine(&mncp_cleanup_protocol);\r\nncp_tap.stat=register_tap("ncp_srt");\r\nncp_tap.hdr=register_tap("ncp");\r\nregister_conversation_table(proto_ncp, FALSE, ncp_conversation_packet, ncp_hostlist_packet);\r\nregister_srt_table(proto_ncp, "ncp_srt", 24, ncpstat_packet, ncpstat_init, NULL);\r\n}\r\nvoid\r\nproto_reg_handoff_ncp(void)\r\n{\r\ndissector_handle_t ncp_handle;\r\ndissector_handle_t ncp_tcp_handle;\r\nncp_handle = create_dissector_handle(dissect_ncp, proto_ncp);\r\nncp_tcp_handle = create_dissector_handle(dissect_ncp_tcp, proto_ncp);\r\ndissector_add_uint("tcp.port", TCP_PORT_NCP, ncp_tcp_handle);\r\ndissector_add_uint("udp.port", UDP_PORT_NCP, ncp_handle);\r\ndissector_add_uint("ipx.packet_type", IPX_PACKET_TYPE_NCP, ncp_handle);\r\ndissector_add_uint("ipx.socket", IPX_SOCKET_NCP, ncp_handle);\r\n}

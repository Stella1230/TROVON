static void\r\nhttp_init_hash(httpstat_t *sp)\r\n{\r\nint i;\r\nsp->hash_responses = g_hash_table_new(g_int_hash, g_int_equal);\r\nfor (i=0; vals_status_code[i].strptr; i++ )\r\n{\r\ngint *key = g_new (gint, 1);\r\nhttp_response_code_t *sc = g_new (http_response_code_t, 1);\r\n*key = vals_status_code[i].value;\r\nsc->packets = 0;\r\nsc->response_code = *key;\r\nsc->name = vals_status_code[i].strptr;\r\nsc->sp = sp;\r\ng_hash_table_insert(sc->sp->hash_responses, key, sc);\r\n}\r\nsp->hash_requests = g_hash_table_new(g_str_hash, g_str_equal);\r\n}\r\nstatic void\r\nhttp_draw_hash_requests(gchar *key _U_ , http_request_methode_t *data, gchar *format)\r\n{\r\nif (data->packets == 0)\r\nreturn;\r\nprintf(format, data->response, data->packets);\r\n}\r\nstatic void\r\nhttp_draw_hash_responses(gint * key _U_ , http_response_code_t *data, char *format)\r\n{\r\nif (data == NULL) {\r\ng_warning("No data available, key=%d\n", *key);\r\nexit(EXIT_FAILURE);\r\n}\r\nif (data->packets == 0)\r\nreturn;\r\nprintf(format, data->response_code, data->name, data->packets );\r\n}\r\nstatic void\r\nhttp_reset_hash_responses(gchar *key _U_ , http_response_code_t *data, gpointer ptr _U_ )\r\n{\r\ndata->packets = 0;\r\n}\r\nstatic void\r\nhttp_reset_hash_requests(gchar *key _U_ , http_request_methode_t *data, gpointer ptr _U_ )\r\n{\r\ndata->packets = 0;\r\n}\r\nstatic void\r\nhttpstat_reset(void *psp )\r\n{\r\nhttpstat_t *sp = (httpstat_t *)psp;\r\ng_hash_table_foreach(sp->hash_responses, (GHFunc)http_reset_hash_responses, NULL);\r\ng_hash_table_foreach(sp->hash_requests, (GHFunc)http_reset_hash_requests, NULL);\r\n}\r\nstatic int\r\nhttpstat_packet(void *psp , packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *pri)\r\n{\r\nconst http_info_value_t *value = (const http_info_value_t *)pri;\r\nhttpstat_t *sp = (httpstat_t *) psp;\r\nif (value->response_code != 0) {\r\nguint *key = g_new(guint, 1);\r\nhttp_response_code_t *sc;\r\n*key = value->response_code;\r\nsc = (http_response_code_t *)g_hash_table_lookup(\r\nsp->hash_responses,\r\nkey);\r\nif (sc == NULL) {\r\nint i = value->response_code;\r\nif ((i < 100) || (i >= 600)) {\r\nreturn 0;\r\n}\r\nelse if (i < 200) {\r\n*key = 199;\r\n}\r\nelse if (i < 300) {\r\n*key = 299;\r\n}\r\nelse if (i < 400) {\r\n*key = 399;\r\n}\r\nelse if (i < 500) {\r\n*key = 499;\r\n}\r\nelse{\r\n*key = 599;\r\n}\r\nsc = (http_response_code_t *)g_hash_table_lookup(\r\nsp->hash_responses,\r\nkey);\r\nif (sc == NULL)\r\nreturn 0;\r\n}\r\nsc->packets++;\r\n}\r\nelse if (value->request_method) {\r\nhttp_request_methode_t *sc;\r\nsc = (http_request_methode_t *)g_hash_table_lookup(\r\nsp->hash_requests,\r\nvalue->request_method);\r\nif (sc == NULL) {\r\nsc = g_new(http_request_methode_t, 1);\r\nsc->response = g_strdup(value->request_method );\r\nsc->packets = 1;\r\nsc->sp = sp;\r\ng_hash_table_insert(sp->hash_requests, sc->response, sc);\r\n} else {\r\nsc->packets++;\r\n}\r\n} else {\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nhttpstat_draw(void *psp )\r\n{\r\nhttpstat_t *sp = (httpstat_t *)psp;\r\nprintf("\n");\r\nprintf("===================================================================\n");\r\nif (! sp->filter[0])\r\nprintf("HTTP Statistics\n");\r\nelse\r\nprintf("HTTP Statistics with filter %s\n", sp->filter);\r\nprintf("* HTTP Status Codes in reply packets\n");\r\ng_hash_table_foreach(sp->hash_responses, (GHFunc)http_draw_hash_responses,\r\n(gpointer)" HTTP %3d %s\n");\r\nprintf("* List of HTTP Request methods\n");\r\ng_hash_table_foreach(sp->hash_requests, (GHFunc)http_draw_hash_requests,\r\n(gpointer)" %9s %d \n");\r\nprintf("===================================================================\n");\r\n}\r\nstatic void\r\nhttpstat_init(const char *opt_arg, void *userdata _U_)\r\n{\r\nhttpstat_t *sp;\r\nconst char *filter = NULL;\r\nGString *error_string;\r\nif (!strncmp (opt_arg, "http,stat,", 10)) {\r\nfilter = opt_arg+10;\r\n} else {\r\nfilter = NULL;\r\n}\r\nsp = g_new(httpstat_t, 1);\r\nif (filter) {\r\nsp->filter = g_strdup(filter);\r\n} else {\r\nsp->filter = NULL;\r\n}\r\nerror_string = register_tap_listener(\r\n"http",\r\nsp,\r\nfilter,\r\n0,\r\nhttpstat_reset,\r\nhttpstat_packet,\r\nhttpstat_draw);\r\nif (error_string) {\r\ng_free(sp->filter);\r\ng_free(sp);\r\nfprintf (stderr, "tshark: Couldn't register http,stat tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\nhttp_init_hash(sp);\r\n}\r\nvoid\r\nregister_tap_listener_httpstat(void)\r\n{\r\nregister_stat_tap_ui(&httpstat_ui, NULL);\r\n}

static inline void\r\nwmem_block_fast_new_block(wmem_block_fast_allocator_t *allocator)\r\n{\r\nwmem_block_fast_hdr_t *block;\r\nblock = (wmem_block_fast_hdr_t *)wmem_alloc(NULL, WMEM_BLOCK_SIZE);\r\nblock->pos = WMEM_BLOCK_HEADER_SIZE;\r\nblock->next = allocator->block_list;\r\nallocator->block_list = block;\r\n}\r\nstatic void *\r\nwmem_block_fast_alloc(void *private_data, const size_t size)\r\n{\r\nwmem_block_fast_allocator_t *allocator = (wmem_block_fast_allocator_t*) private_data;\r\nwmem_block_fast_chunk_t *chunk;\r\ngint32 real_size;\r\nif (size > WMEM_BLOCK_MAX_ALLOC_SIZE) {\r\nwmem_block_fast_jumbo_t *block;\r\nblock = (wmem_block_fast_jumbo_t *)wmem_alloc(NULL,\r\nsize + WMEM_JUMBO_HEADER_SIZE + WMEM_CHUNK_HEADER_SIZE);\r\nblock->next = allocator->jumbo_list;\r\nblock->prev = NULL;\r\nallocator->jumbo_list = block;\r\nchunk = ((wmem_block_fast_chunk_t*)((guint8*)(block) + WMEM_JUMBO_HEADER_SIZE));\r\nchunk->len = JUMBO_MAGIC;\r\nreturn WMEM_CHUNK_TO_DATA(chunk);\r\n}\r\nreal_size = (gint32)(WMEM_ALIGN_SIZE(size) + WMEM_CHUNK_HEADER_SIZE);\r\nif (!allocator->block_list ||\r\n(WMEM_BLOCK_SIZE - allocator->block_list->pos) < real_size) {\r\nwmem_block_fast_new_block(allocator);\r\n}\r\nchunk = (wmem_block_fast_chunk_t *) ((guint8 *) allocator->block_list + allocator->block_list->pos);\r\nchunk->len = (guint32) size;\r\nallocator->block_list->pos += real_size;\r\nreturn WMEM_CHUNK_TO_DATA(chunk);\r\n}\r\nstatic void\r\nwmem_block_fast_free(void *private_data _U_, void *ptr _U_)\r\n{\r\n}\r\nstatic void *\r\nwmem_block_fast_realloc(void *private_data, void *ptr, const size_t size)\r\n{\r\nwmem_block_fast_chunk_t *chunk;\r\nchunk = WMEM_DATA_TO_CHUNK(ptr);\r\nif (chunk->len == JUMBO_MAGIC) {\r\nwmem_block_fast_jumbo_t *block;\r\nblock = ((wmem_block_fast_jumbo_t*)((guint8*)(chunk) - WMEM_JUMBO_HEADER_SIZE));\r\nblock = (wmem_block_fast_jumbo_t*)wmem_realloc(NULL, block,\r\nsize + WMEM_JUMBO_HEADER_SIZE + WMEM_CHUNK_HEADER_SIZE);\r\nif (block->prev) {\r\nblock->prev->next = block;\r\n}\r\nelse {\r\nwmem_block_fast_allocator_t *allocator = (wmem_block_fast_allocator_t*) private_data;\r\nallocator->jumbo_list = block;\r\n}\r\nif (block->next) {\r\nblock->next->prev = block;\r\n}\r\nreturn ((void*)((guint8*)(block) + WMEM_JUMBO_HEADER_SIZE + WMEM_CHUNK_HEADER_SIZE));\r\n}\r\nelse if (chunk->len < size) {\r\nvoid *newptr;\r\nnewptr = wmem_block_fast_alloc(private_data, size);\r\nmemcpy(newptr, ptr, chunk->len);\r\nreturn newptr;\r\n}\r\nreturn ptr;\r\n}\r\nstatic void\r\nwmem_block_fast_free_all(void *private_data)\r\n{\r\nwmem_block_fast_allocator_t *allocator = (wmem_block_fast_allocator_t*) private_data;\r\nwmem_block_fast_hdr_t *cur, *nxt;\r\nwmem_block_fast_jumbo_t *cur_jum, *nxt_jum;\r\ncur = allocator->block_list;\r\nif (cur) {\r\ncur->pos = WMEM_BLOCK_HEADER_SIZE;\r\nnxt = cur->next;\r\ncur->next = NULL;\r\ncur = nxt;\r\n}\r\nwhile (cur) {\r\nnxt = cur->next;\r\nwmem_free(NULL, cur);\r\ncur = nxt;\r\n}\r\ncur_jum = allocator->jumbo_list;\r\nwhile (cur_jum) {\r\nnxt_jum = cur_jum->next;\r\nwmem_free(NULL, cur_jum);\r\ncur_jum = nxt_jum;\r\n}\r\nallocator->jumbo_list = NULL;\r\n}\r\nstatic void\r\nwmem_block_fast_gc(void *private_data _U_)\r\n{\r\n}\r\nstatic void\r\nwmem_block_fast_allocator_cleanup(void *private_data)\r\n{\r\nwmem_block_fast_allocator_t *allocator = (wmem_block_fast_allocator_t*) private_data;\r\nwmem_free(NULL, allocator->block_list);\r\nwmem_free(NULL, private_data);\r\n}\r\nvoid\r\nwmem_block_fast_allocator_init(wmem_allocator_t *allocator)\r\n{\r\nwmem_block_fast_allocator_t *block_allocator;\r\nblock_allocator = wmem_new(NULL, wmem_block_fast_allocator_t);\r\nallocator->walloc = &wmem_block_fast_alloc;\r\nallocator->wrealloc = &wmem_block_fast_realloc;\r\nallocator->wfree = &wmem_block_fast_free;\r\nallocator->free_all = &wmem_block_fast_free_all;\r\nallocator->gc = &wmem_block_fast_gc;\r\nallocator->cleanup = &wmem_block_fast_allocator_cleanup;\r\nallocator->private_data = (void*) block_allocator;\r\nblock_allocator->block_list = NULL;\r\nblock_allocator->jumbo_list = NULL;\r\n}

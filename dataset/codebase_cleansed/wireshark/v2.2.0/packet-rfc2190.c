static int\r\ndissect_rfc2190( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_ )\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *rfc2190_tree = NULL;\r\nint offset = 0;\r\nunsigned int rfc2190_version = 0;\r\ntvbuff_t *next_tvb;\r\nint hdr_len = 0;\r\nrfc2190_version = (tvb_get_guint8( tvb, offset ) & 0xc0 ) >> 6;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "H.263 ");\r\nif( rfc2190_version == 0x00) {\r\ncol_append_str( pinfo->cinfo, COL_INFO, "MODE A ");\r\nhdr_len = 4;\r\n}\r\nelse if( rfc2190_version == 0x02) {\r\ncol_append_str( pinfo->cinfo, COL_INFO, "MODE B ");\r\nhdr_len = 8;\r\n}\r\nelse if( rfc2190_version == 0x03) {\r\ncol_append_str( pinfo->cinfo, COL_INFO, "MODE C ");\r\nhdr_len = 12;\r\n}\r\nif ( tree ) {\r\nti = proto_tree_add_item( tree, proto_rfc2190, tvb, offset, hdr_len, ENC_NA );\r\nrfc2190_tree = proto_item_add_subtree( ti, ett_rfc2190 );\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_ftype, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_pbframes, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_sbit, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_ebit, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset++;\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_srcformat, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nif(rfc2190_version == 0x00) {\r\nproto_tree_add_bits_item(rfc2190_tree, hf_rfc2190_picture_coding_type, tvb, (offset<<3)+3, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_bits_item(rfc2190_tree, hf_rfc2190_unrestricted_motion_vector, tvb, (offset<<3)+4, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_bits_item(rfc2190_tree, hf_rfc2190_syntax_based_arithmetic, tvb, (offset<<3)+5, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_bits_item(rfc2190_tree, hf_rfc2190_advanced_prediction, tvb, (offset<<3)+6, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_r, tvb, offset, 2, ( ( tvb_get_guint8( tvb, offset ) & 0x1 ) << 3 ) + ( ( tvb_get_guint8( tvb, offset + 1 ) & 0xe0 ) >> 5 ) );\r\noffset++;\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_dbq, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_trb, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset++;\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_tr, tvb, offset, 1, ENC_NA );\r\noffset++;\r\n} else {\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_quant, tvb, offset, 1, ENC_NA);\r\noffset++;\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_gobn, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_mba, tvb, offset, 2, ( ( tvb_get_guint8( tvb, offset ) & 0x7 ) << 6 ) + ( ( tvb_get_guint8( tvb, offset + 1 ) & 0xfc ) >> 2 ) );\r\noffset++;\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_r, tvb, offset, 1, ( tvb_get_guint8( tvb, offset ) & 0x3 ) );\r\noffset++;\r\nproto_tree_add_boolean( rfc2190_tree, hf_rfc2190_picture_coding_type, tvb, offset, 1, tvb_get_guint8( tvb, offset ) & 0x80 );\r\nproto_tree_add_boolean( rfc2190_tree, hf_rfc2190_unrestricted_motion_vector, tvb, offset, 1, tvb_get_guint8( tvb, offset ) & 0x40 );\r\nproto_tree_add_boolean( rfc2190_tree, hf_rfc2190_syntax_based_arithmetic, tvb, offset, 1, tvb_get_guint8( tvb, offset ) & 0x20 );\r\nproto_tree_add_boolean( rfc2190_tree, hf_rfc2190_advanced_prediction, tvb, offset, 1, tvb_get_guint8( tvb, offset ) & 0x10 );\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_hmv1, tvb, offset, 2,( ( tvb_get_guint8( tvb, offset ) & 0xf ) << 3 ) + ( ( tvb_get_guint8( tvb, offset+1 ) & 0xe0 ) >> 5) );\r\noffset++;\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_vmv1, tvb, offset, 2,( ( tvb_get_guint8( tvb, offset ) & 0x1f ) << 2 ) + ( ( tvb_get_guint8( tvb, offset+1 ) & 0xc0 ) >> 6) );\r\noffset++;\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_hmv2, tvb, offset, 2,( ( tvb_get_guint8( tvb, offset ) & 0x3f ) << 1 ) + ( ( tvb_get_guint8( tvb, offset+1 ) & 0xf0 ) >> 7) );\r\noffset++;\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_vmv2, tvb, offset, 1, ENC_NA);\r\noffset++;\r\nif(rfc2190_version == 0x03) {\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_rr, tvb, offset, 3, ( tvb_get_guint8( tvb, offset ) << 11 ) + ( tvb_get_guint8( tvb, offset + 1 ) << 3 ) + ( ( tvb_get_guint8( tvb, offset + 2 ) & 0xe0 ) >> 5 ) );\r\noffset+=2;\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_dbq, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( rfc2190_tree, hf_rfc2190_trb, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset++;\r\nproto_tree_add_uint( rfc2190_tree, hf_rfc2190_tr, tvb, offset, 1, tvb_get_guint8( tvb, offset ) );\r\noffset++;\r\n}\r\n}\r\n} else {\r\nswitch(rfc2190_version) {\r\ncase 0x00:\r\noffset += 4;\r\nbreak;\r\ncase 0x01:\r\noffset += 8;\r\nbreak;\r\ncase 0x02:\r\noffset += 12;\r\nbreak;\r\n}\r\n}\r\nnext_tvb = tvb_new_subset_remaining( tvb, offset);\r\ncall_dissector(h263_handle,next_tvb,pinfo,tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_reg_handoff_rfc2190(void)\r\n{\r\ndissector_handle_t rfc2190_handle;\r\nrfc2190_handle = find_dissector("rfc2190");\r\ndissector_add_uint("rtp.pt", PT_H263, rfc2190_handle);\r\ndissector_add_uint("iax2.codec", AST_FORMAT_H263, rfc2190_handle);\r\nh263_handle = find_dissector_add_dependency("h263data", proto_rfc2190);\r\n}\r\nvoid\r\nproto_register_rfc2190(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{\r\n&hf_rfc2190_ftype,\r\n{\r\n"F",\r\n"rfc2190.ftype",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x80,\r\n"Indicates the mode of the payload header (MODE A or B/C)", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_pbframes,\r\n{\r\n"p/b frame",\r\n"rfc2190.pbframes",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x40,\r\n"Optional PB-frames mode as defined by H.263 (MODE C)", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_sbit,\r\n{\r\n"Start bit position",\r\n"rfc2190.sbit",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x38,\r\n"Start bit position specifies number of most significant bits that shall be ignored in the first data byte.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_ebit,\r\n{\r\n"End bit position",\r\n"rfc2190.ebit",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x7,\r\n"End bit position specifies number of least significant bits that shall be ignored in the last data byte.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_srcformat,\r\n{\r\n"SRC format",\r\n"rfc2190.srcformat",\r\nFT_UINT8,\r\nBASE_DEC,\r\nVALS(h263_srcformat_vals),\r\n0xe0,\r\n"Source format specifies the resolution of the current picture.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_picture_coding_type,\r\n{\r\n"Inter-coded frame",\r\n"rfc2190.picture_coding_type",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x0,\r\n"Picture coding type, intra-coded (false) or inter-coded (true)", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_unrestricted_motion_vector,\r\n{\r\n"Motion vector",\r\n"rfc2190.unrestricted_motion_vector",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x0,\r\n"Unrestricted Motion Vector option for current picture", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_syntax_based_arithmetic,\r\n{\r\n"Syntax-based arithmetic coding",\r\n"rfc2190.syntax_based_arithmetic",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x0,\r\n"Syntax-based Arithmetic Coding option for current picture", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_advanced_prediction,\r\n{\r\n"Advanced prediction option",\r\n"rfc2190.advanced_prediction",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x0,\r\n"Advanced Prediction option for current picture", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_dbq,\r\n{\r\n"Differential quantization parameter",\r\n"rfc2190.dbq",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x18,\r\n"Differential quantization parameter used to calculate quantizer for the B frame based on quantizer for the P frame, when PB-frames option is used.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_trb,\r\n{\r\n"Temporal Reference for B frames",\r\n"rfc2190.trb",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x07,\r\n"Temporal Reference for the B frame as defined by H.263", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_tr,\r\n{\r\n"Temporal Reference for P frames",\r\n"rfc2190.tr",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Temporal Reference for the P frame as defined by H.263", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_quant,\r\n{\r\n"Quantizer",\r\n"rfc2190.quant",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x1F,\r\n"Quantization value for the first MB coded at the starting of the packet.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_gobn,\r\n{\r\n"GOB Number",\r\n"rfc2190.gobn",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0xF8,\r\n"GOB number in effect at the start of the packet.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_mba,\r\n{\r\n"Macroblock address",\r\n"rfc2190.mba",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"The address within the GOB of the first MB in the packet, counting from zero in scan order.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_hmv1,\r\n{\r\n"Horizontal motion vector 1",\r\n"rfc2190.hmv1",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Horizontal motion vector predictor for the first MB in this packet", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_vmv1,\r\n{\r\n"Vertical motion vector 1",\r\n"rfc2190.vmv1",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Vertical motion vector predictor for the first MB in this packet", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_hmv2,\r\n{\r\n"Horizontal motion vector 2",\r\n"rfc2190.hmv2",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Horizontal motion vector predictor for block number 3 in the first MB in this packet when four motion vectors are used with the advanced prediction option.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_vmv2,\r\n{\r\n"Vertical motion vector 2",\r\n"rfc2190.vmv2",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x7F,\r\n"Vertical motion vector predictor for block number 3 in the first MB in this packet when four motion vectors are used with the advanced prediction option.", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_r,\r\n{\r\n"Reserved field",\r\n"rfc2190.r",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Reserved field that should contain zeroes", HFILL\r\n}\r\n},\r\n{\r\n&hf_rfc2190_rr,\r\n{\r\n"Reserved field 2",\r\n"rfc2190.rr",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Reserved field that should contain zeroes", HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_rfc2190,\r\n};\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_rfc2190 = proto_register_protocol("H.263 RTP Payload header (RFC2190)",\r\n"RFC2190", "rfc2190");\r\nproto_register_field_array(proto_rfc2190, hf, array_length(hf));\r\nregister_dissector("rfc2190", dissect_rfc2190, proto_rfc2190);\r\n}

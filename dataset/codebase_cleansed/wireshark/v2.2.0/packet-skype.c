static int\r\ndissect_skype_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *ti;\r\nproto_tree *skype_tree = NULL;\r\nguint32 offset = 0;\r\nguint32 packet_length;\r\nguint8 packet_type;\r\npacket_type = 255;\r\npacket_length = tvb_captured_length(tvb);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PROTO_SHORT_NAME);\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str(packet_type,\r\nskype_type_vals, "Type 0x%1x"));\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_skype, tvb, offset, -1,\r\nENC_NA);\r\nskype_tree = proto_item_add_subtree(ti, ett_skype);\r\nswitch (packet_type) {\r\ndefault:\r\nproto_tree_add_item(skype_tree, hf_skype_unknown_packet, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_skype_udp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *ti;\r\nproto_tree *skype_tree = NULL;\r\nguint32 offset = 0;\r\nguint32 packet_length;\r\nguint8 packet_type, packet_unk;\r\nconversation_t *conversation = NULL;\r\nskype_udp_conv_info_t *skype_udp_info;\r\nconversation = find_or_create_conversation(pinfo);\r\nskype_udp_info = (skype_udp_conv_info_t *)conversation_get_proto_data(conversation, proto_skype);\r\nif (!skype_udp_info) {\r\nskype_udp_info = wmem_new(wmem_file_scope(), skype_udp_conv_info_t);\r\nskype_udp_info->global_src_ip = 0;\r\nskype_udp_info->global_dst_ip = 0;\r\nconversation_add_proto_data(conversation, proto_skype,\r\nskype_udp_info);\r\n}\r\npacket_type = tvb_get_guint8(tvb, 2) & SKYPE_SOM_TYPE_MASK;\r\npacket_unk = (tvb_get_guint8(tvb, 2) & SKYPE_SOM_UNK_MASK) >> 4;\r\npacket_length = tvb_captured_length(tvb);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PROTO_SHORT_NAME);\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str(packet_type,\r\nskype_type_vals, "Type 0x%1x"));\r\nif (packet_unk) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Unk: %1x", packet_unk);\r\n}\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_skype, tvb, offset, -1,\r\nENC_NA);\r\nskype_tree = proto_item_add_subtree(ti, ett_skype);\r\nproto_tree_add_item(skype_tree, hf_skype_som_id, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(skype_tree, hf_skype_som_unk, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(skype_tree, hf_skype_som_type, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (packet_type) {\r\ncase SKYPE_TYPE_UNKNOWN_0:\r\nproto_tree_add_item(skype_tree, hf_skype_unknown_0_unk1, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\ncase SKYPE_TYPE_PAYLOAD:\r\nproto_tree_add_item(skype_tree, hf_skype_payload_iv, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_payload_crc, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_payload_enc_data, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\ncase SKYPE_TYPE_FFR:\r\nproto_tree_add_item(skype_tree, hf_skype_ffr_num, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(skype_tree, hf_skype_ffr_unk1, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_ffr_iv, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_ffr_crc, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_ffr_enc_data, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\ncase SKYPE_TYPE_NAT_INFO:\r\nproto_tree_add_item(skype_tree, hf_skype_natinfo_srcip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nskype_udp_info->global_src_ip = tvb_get_ipv4(tvb, offset);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_natinfo_dstip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nskype_udp_info->global_dst_ip = tvb_get_ipv4(tvb, offset);\r\noffset += 4;\r\nbreak;\r\ncase SKYPE_TYPE_NAT_REPEAT:\r\nproto_tree_add_item(skype_tree, hf_skype_natrequest_srcip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nskype_udp_info->global_src_ip = tvb_get_ipv4(tvb, offset);\r\noffset += 4;\r\nproto_tree_add_item(skype_tree, hf_skype_natrequest_dstip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nskype_udp_info->global_dst_ip = tvb_get_ipv4(tvb, offset);\r\noffset += 4;\r\nbreak;\r\ncase SKYPE_TYPE_AUDIO:\r\nproto_tree_add_item(skype_tree, hf_skype_audio_unk1, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\ncase SKYPE_TYPE_UNKNOWN_F:\r\nproto_tree_add_item(skype_tree, hf_skype_unknown_f_unk1, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(skype_tree, hf_skype_unknown_packet, tvb, offset, -1,\r\nENC_NA);\r\noffset = packet_length;\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ntest_skype_udp(tvbuff_t *tvb)\r\n{\r\nguint length = tvb_captured_length(tvb);\r\nguint8 type = tvb_get_guint8(tvb, 2) & 0xF;\r\nif ( length >= 3 &&\r\n( type == 0 ||\r\ntype == 2 ||\r\ntype == 3 ||\r\ntype == 5 ||\r\ntype == 7 ||\r\ntype == 0xd ||\r\ntype == 0xf\r\n)\r\n) {\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ndissect_skype_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif (pinfo->ptype == PT_UDP) {\r\nif ( !test_skype_udp(tvb) ) {\r\nreturn FALSE;\r\n}\r\ndissect_skype_udp(tvb, pinfo, tree);\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_skype_static(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif (pinfo->ptype == PT_UDP) {\r\nreturn dissect_skype_udp(tvb, pinfo, tree);\r\n} else if (pinfo->ptype == PT_TCP) {\r\nreturn dissect_skype_tcp(tvb, pinfo, tree);\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nproto_register_skype(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_skype_som_id,\r\n{ "ID", "skype.som.id", FT_UINT16, BASE_HEX, NULL,\r\n0x0, "Message ID", HFILL }},\r\n{ &hf_skype_som_unk,\r\n{ "Unknown", "skype.som.unk", FT_UINT8, BASE_HEX, NULL,\r\nSKYPE_SOM_UNK_MASK, NULL, HFILL }},\r\n{ &hf_skype_som_type,\r\n{ "Type", "skype.som.type", FT_UINT8, BASE_HEX, VALS(skype_type_vals),\r\nSKYPE_SOM_TYPE_MASK, "Message type", HFILL }},\r\n{ &hf_skype_unknown_0_unk1,\r\n{ "Unknown1", "skype.unknown_0.unk1", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_payload_iv,\r\n{ "IV", "skype.payload.iv", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_payload_crc,\r\n{ "CRC", "skype.payload.crc", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_payload_enc_data,\r\n{ "Enc Data", "skype.payload.encdata", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_ffr_num,\r\n{ "Num", "skype.ffr.num", FT_UINT8, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_ffr_unk1,\r\n{ "Unk1", "skype.ffr.unk1", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_ffr_iv,\r\n{ "IV", "skype.ffr.iv", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_ffr_crc,\r\n{ "CRC", "skype.ffr.crc", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_ffr_enc_data,\r\n{ "Enc Data", "skype.ffr.encdata", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_natinfo_srcip,\r\n{ "Src IP", "skype.natinfo.srcip", FT_IPv4, BASE_NONE, NULL,\r\n0x0, "Global source IP", HFILL }},\r\n{ &hf_skype_natinfo_dstip,\r\n{ "Dst IP", "skype.natinfo.dstip", FT_UINT32, BASE_HEX, NULL,\r\n0x0, "Global destination IP", HFILL }},\r\n{ &hf_skype_natrequest_srcip,\r\n{ "Src IP", "skype.natrequest.srcip", FT_IPv4, BASE_NONE, NULL,\r\n0x0, "Global source IP", HFILL }},\r\n{ &hf_skype_natrequest_dstip,\r\n{ "Dst IP", "skype.natrequest.dstip", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_audio_unk1,\r\n{ "Unknown1", "skype.audio.unk1", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_unknown_f_unk1,\r\n{ "Unknown1", "skype.unknown_f.unk1", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_skype_unknown_packet,\r\n{ "Unknown Packet", "skype.unknown_packet", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_skype,\r\n};\r\nproto_skype = proto_register_protocol(PROTO_LONG_NAME, PROTO_SHORT_NAME, "skype");\r\nproto_register_field_array(proto_skype, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_skype(void)\r\n{\r\ndissector_handle_t skype_handle;\r\nskype_handle = create_dissector_handle(dissect_skype_static, proto_skype);\r\ndissector_add_for_decode_as("tcp.port", skype_handle);\r\ndissector_add_for_decode_as("udp.port", skype_handle);\r\nheur_dissector_add("tcp", dissect_skype_heur, "Skype over TCP", "skype_tcp", proto_skype, HEURISTIC_DISABLE);\r\nheur_dissector_add("udp", dissect_skype_heur, "Skype over UDP", "skype_udp", proto_skype, HEURISTIC_DISABLE);\r\n}

static void *\r\nwmem_simple_alloc(void *private_data, const size_t size)\r\n{\r\nwmem_simple_allocator_t *allocator;\r\nallocator = (wmem_simple_allocator_t*) private_data;\r\nif G_UNLIKELY(allocator->count == allocator->size) {\r\nallocator->size *= 2;\r\nallocator->ptrs = (void**)wmem_realloc(NULL, allocator->ptrs,\r\nsizeof(void*) * allocator->size);\r\n}\r\nreturn allocator->ptrs[allocator->count++] = wmem_alloc(NULL, size);\r\n}\r\nstatic void\r\nwmem_simple_free(void *private_data, void *ptr)\r\n{\r\nint i;\r\nwmem_simple_allocator_t *allocator;\r\nallocator = (wmem_simple_allocator_t*) private_data;\r\nwmem_free(NULL, ptr);\r\nallocator->count--;\r\nfor (i=allocator->count; i>=0; i--) {\r\nif (ptr == allocator->ptrs[i]) {\r\nif (i < allocator->count) {\r\nallocator->ptrs[i] = allocator->ptrs[allocator->count];\r\n}\r\nreturn;\r\n}\r\n}\r\ng_assert_not_reached();\r\n}\r\nstatic void *\r\nwmem_simple_realloc(void *private_data, void *ptr, const size_t size)\r\n{\r\nint i;\r\nwmem_simple_allocator_t *allocator;\r\nallocator = (wmem_simple_allocator_t*) private_data;\r\nfor (i=allocator->count-1; i>=0; i--) {\r\nif (ptr == allocator->ptrs[i]) {\r\nreturn allocator->ptrs[i] = wmem_realloc(NULL, allocator->ptrs[i], size);\r\n}\r\n}\r\ng_assert_not_reached();\r\nreturn NULL;\r\n}\r\nstatic void\r\nwmem_simple_free_all(void *private_data)\r\n{\r\nwmem_simple_allocator_t *allocator;\r\nint i;\r\nallocator = (wmem_simple_allocator_t*) private_data;\r\nfor (i = 0; i<allocator->count; i++) {\r\nwmem_free(NULL, allocator->ptrs[i]);\r\n}\r\nallocator->count = 0;\r\n}\r\nstatic void\r\nwmem_simple_gc(void *private_data _U_)\r\n{\r\n}\r\nstatic void\r\nwmem_simple_allocator_cleanup(void *private_data)\r\n{\r\nwmem_simple_allocator_t *allocator;\r\nallocator = (wmem_simple_allocator_t*) private_data;\r\nwmem_free(NULL, allocator->ptrs);\r\nwmem_free(NULL, allocator);\r\n}\r\nvoid\r\nwmem_simple_allocator_init(wmem_allocator_t *allocator)\r\n{\r\nwmem_simple_allocator_t *simple_allocator;\r\nsimple_allocator = wmem_new(NULL, wmem_simple_allocator_t);\r\nallocator->walloc = &wmem_simple_alloc;\r\nallocator->wrealloc = &wmem_simple_realloc;\r\nallocator->wfree = &wmem_simple_free;\r\nallocator->free_all = &wmem_simple_free_all;\r\nallocator->gc = &wmem_simple_gc;\r\nallocator->cleanup = &wmem_simple_allocator_cleanup;\r\nallocator->private_data = (void*) simple_allocator;\r\nsimple_allocator->count = 0;\r\nsimple_allocator->size = DEFAULT_ALLOCS;\r\nsimple_allocator->ptrs = wmem_alloc_array(NULL, void*, DEFAULT_ALLOCS);\r\n}

static void\r\nadd_hid_to_strbuf(tvbuff_t *tvb, wmem_strbuf_t *hid_buf, guint8 offset)\r\n{\r\nint i;\r\nfor (i = 0; i < NWP_XID_LEN / NWP_XID_CHUNK_LEN; i++) {\r\nwmem_strbuf_append_printf(hid_buf, "%08x",\r\ntvb_get_ntohl(tvb, offset));\r\noffset += NWP_XID_CHUNK_LEN;\r\n}\r\n}\r\nstatic void\r\ndissect_nwp_ann(tvbuff_t *tvb, proto_tree *nwp_tree, guint8 hid_count,\r\nguint8 ha_len)\r\n{\r\nproto_tree *hid_tree = NULL;\r\nproto_item *ti = NULL;\r\nwmem_strbuf_t *buf;\r\nguint i;\r\nguint8 offset;\r\nproto_tree_add_item(nwp_tree, hf_nwp_ann_haddr, tvb, NWPH_HWAD,\r\nha_len, ENC_NA);\r\nti = proto_tree_add_item(nwp_tree, hf_nwp_ann_hids, tvb,\r\nNWPH_HWAD + ha_len, hid_count * NWP_XID_LEN, ENC_NA);\r\nhid_tree = proto_item_add_subtree(ti, ett_nwp_ann_hid_tree);\r\nbuf = wmem_strbuf_sized_new(wmem_packet_scope(),\r\nNWP_HID_STR_LEN, NWP_HID_STR_LEN);\r\noffset = NWPH_HWAD + ha_len;\r\nfor (i = 0; i < hid_count; i++) {\r\nconst gchar *hid_str;\r\nwmem_strbuf_append(buf, "hid-");\r\nadd_hid_to_strbuf(tvb, buf, offset);\r\nhid_str = wmem_strbuf_get_str(buf);\r\nproto_tree_add_string_format(hid_tree, hf_nwp_ann_hid, tvb,\r\noffset, NWP_XID_LEN, hid_str, "%s", hid_str);\r\nwmem_strbuf_truncate(buf, 0);\r\noffset += NWP_XID_LEN;\r\n}\r\n}\r\nstatic void\r\ndissect_nwp_nl(tvbuff_t *tvb, proto_tree *nwp_tree, guint8 hid_count,\r\nguint8 ha_len)\r\n{\r\nproto_tree *neigh_list_tree = NULL;\r\nproto_tree *neigh_tree = NULL;\r\nproto_item *pi = NULL;\r\nguint i;\r\nguint8 offset = NWPH_NLST;\r\nwmem_strbuf_t *hid_buf = wmem_strbuf_sized_new(wmem_packet_scope(),\r\nNWP_HID_STR_LEN, NWP_HID_STR_LEN);\r\npi = proto_tree_add_item(nwp_tree, hf_nwp_neigh_list,\r\ntvb, NWPH_NLST, -1, ENC_NA);\r\nneigh_list_tree = proto_item_add_subtree(pi, ett_nwp_neigh_list_tree);\r\nfor (i = 0; i < hid_count; i++) {\r\nconst gchar *hid_str;\r\nguint j;\r\nguint8 ha_count = tvb_get_guint8(tvb, offset + NWP_XID_LEN);\r\npi = proto_tree_add_none_format(neigh_list_tree, hf_nwp_neigh,\r\ntvb, offset, NWP_XID_LEN + 1 + ha_len * ha_count,\r\n"Neighbor %d", i + 1);\r\nneigh_tree = proto_item_add_subtree(pi, ett_nwp_neigh_tree);\r\nwmem_strbuf_append(hid_buf, "hid-");\r\nadd_hid_to_strbuf(tvb, hid_buf, offset);\r\nhid_str = wmem_strbuf_get_str(hid_buf);\r\nproto_tree_add_string(neigh_tree, hf_nwp_neigh_hid, tvb,\r\noffset, NWP_XID_LEN, hid_str);\r\nwmem_strbuf_truncate(hid_buf, 0);\r\noffset += NWP_XID_LEN;\r\nproto_tree_add_item(neigh_tree, hf_nwp_neigh_num, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nfor (j = 0; j < ha_count; j++)\r\nproto_tree_add_item(neigh_tree, hf_nwp_neigh_haddr,\r\ntvb, offset + (j * ha_len), ha_len, ENC_NA);\r\noffset += ha_len * ha_count;\r\n}\r\n}\r\nstatic gint\r\ndissect_nwp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_tree *nwp_tree = NULL;\r\nproto_item *ti = NULL;\r\nproto_item *type_ti = NULL;\r\nconst gchar *type_str;\r\nguint8 type, hid_count, ha_len;\r\nif (tvb_reported_length(tvb) < NWPH_MIN_LEN)\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "NWP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntype = tvb_get_guint8(tvb, NWPH_TYPE);\r\ntype_str = val_to_str(type, nwp_type_vals,\r\n"Unknown NWP packet type (0x%02x)");\r\ncol_add_str(pinfo->cinfo, COL_INFO, type_str);\r\nti = proto_tree_add_item(tree, proto_nwp, tvb, 0, -1, ENC_NA);\r\nnwp_tree = proto_item_add_subtree(ti, ett_nwp_tree);\r\nproto_tree_add_item(nwp_tree, hf_nwp_version, tvb,\r\nNWPH_VERS, 1, ENC_BIG_ENDIAN);\r\ntype_ti = proto_tree_add_item(nwp_tree, hf_nwp_type, tvb,\r\nNWPH_TYPE, 1, ENC_BIG_ENDIAN);\r\nif (!try_val_to_str(type, nwp_type_vals))\r\nexpert_add_info_format(pinfo, type_ti, &ei_nwp_bad_type,\r\n"%s", type_str);\r\nhid_count = tvb_get_guint8(tvb, NWPH_HIDC);\r\nproto_tree_add_item(nwp_tree, hf_nwp_hid_count, tvb,\r\nNWPH_HIDC, 1, ENC_BIG_ENDIAN);\r\nha_len = tvb_get_guint8(tvb, NWPH_HLEN);\r\nproto_tree_add_item(nwp_tree, hf_nwp_haddr_len, tvb,\r\nNWPH_HLEN, 1, ENC_BIG_ENDIAN);\r\nswitch (type) {\r\ncase NWP_TYPE_ANNOUNCEMENT:\r\ndissect_nwp_ann(tvb, nwp_tree, hid_count, ha_len);\r\nbreak;\r\ncase NWP_TYPE_NEIGH_LIST:\r\ndissect_nwp_nl(tvb, nwp_tree, hid_count, ha_len);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_nwp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_nwp_version,\r\n{ "Version", "nwp.version", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_type,\r\n{ "Type", "nwp.type", FT_UINT8,\r\nBASE_HEX, VALS(nwp_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_nwp_hid_count,\r\n{ "HID Count", "nwp.hid_count", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_haddr_len,\r\n{ "Hardware Address Length", "nwp.haddr_len", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_ann_haddr,\r\n{ "Hardware Address", "nwp.ann_haddr", FT_BYTES,\r\nSEP_COLON, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_ann_hids,\r\n{ "HIDs", "nwp.ann_hids", FT_NONE,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_ann_hid,\r\n{ "HID", "nwp.ann_hid", FT_STRING,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_neigh_list,\r\n{ "Neighbor List", "nwp.neigh_list", FT_NONE,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_neigh,\r\n{ "Neighbor", "nwp.neigh", FT_NONE,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_neigh_hid,\r\n{ "HID", "nwp.neigh_hid", FT_STRING,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_neigh_num,\r\n{ "Number of Devices", "nwp.neigh_num", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_nwp_neigh_haddr,\r\n{ "Hardware Address", "nwp.neigh_haddr", FT_BYTES,\r\nSEP_COLON, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_nwp_tree,\r\n&ett_nwp_ann_hid_tree,\r\n&ett_nwp_neigh_list_tree,\r\n&ett_nwp_neigh_tree\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_nwp_bad_type,\r\n{ "nwp.bad_type", PI_MALFORMED, PI_ERROR,\r\n"Invalid type", EXPFILL }}\r\n};\r\nexpert_module_t *expert_nwp;\r\nproto_nwp = proto_register_protocol(\r\n"Neighborhood Watch Protocol",\r\n"NWP",\r\n"nwp");\r\nnwp_handle = register_dissector("nwp", dissect_nwp, proto_nwp);\r\nproto_register_field_array(proto_nwp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_nwp = expert_register_protocol(proto_nwp);\r\nexpert_register_field_array(expert_nwp, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_nwp(void)\r\n{\r\ndissector_add_uint("ethertype", ETHERTYPE_NWP, nwp_handle);\r\n}

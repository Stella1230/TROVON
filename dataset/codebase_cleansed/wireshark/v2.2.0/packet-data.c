static int\r\ndissect_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ngint bytes;\r\nif (tree) {\r\nbytes = tvb_captured_length(tvb);\r\nif (bytes > 0) {\r\ntvbuff_t *data_tvb;\r\nproto_item *ti;\r\nproto_tree *data_tree;\r\nif (new_pane) {\r\nguint8 *real_data = (guint8 *)tvb_memdup(pinfo->pool, tvb, 0, bytes);\r\ndata_tvb = tvb_new_child_real_data(tvb,real_data,bytes,bytes);\r\nadd_new_data_source(pinfo, data_tvb, "Not dissected data bytes");\r\n} else {\r\ndata_tvb = tvb;\r\n}\r\nti = proto_tree_add_protocol_format(tree, proto_data, tvb,\r\n0,\r\nbytes, "Data (%d byte%s)", bytes,\r\nplurality(bytes, "", "s"));\r\ndata_tree = proto_item_add_subtree(ti, ett_data);\r\nproto_tree_add_item(data_tree, &hfi_data_data, data_tvb, 0, bytes, ENC_NA);\r\nif (show_as_text) {\r\nproto_tree_add_item(data_tree, &hfi_data_text, data_tvb, 0, bytes, ENC_ASCII|ENC_NA);\r\n}\r\nif(generate_md5_hash) {\r\nconst guint8 *cp;\r\nmd5_state_t md_ctx;\r\nmd5_byte_t digest[16];\r\nconst gchar *digest_string;\r\ncp = tvb_get_ptr(tvb, 0, bytes);\r\nmd5_init(&md_ctx);\r\nmd5_append(&md_ctx, cp, bytes);\r\nmd5_finish(&md_ctx, digest);\r\ndigest_string = bytestring_to_str(wmem_packet_scope(), digest, 16, '\0');\r\nti = proto_tree_add_string(data_tree, &hfi_data_md5_hash, tvb, 0, 0, digest_string);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n}\r\nti = proto_tree_add_int(data_tree, &hfi_data_len, data_tvb, 0, 0, bytes);\r\nPROTO_ITEM_SET_GENERATED (ti);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_data(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_data_data,\r\n&hfi_data_text,\r\n&hfi_data_md5_hash,\r\n&hfi_data_len,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_data\r\n};\r\nmodule_t *module_data;\r\nproto_data = proto_register_protocol (\r\n"Data",\r\n"Data",\r\n"data"\r\n);\r\nregister_dissector("data", dissect_data, proto_data);\r\nproto_register_fields(proto_data, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nmodule_data = prefs_register_protocol( proto_data, NULL);\r\nprefs_register_bool_preference(module_data,\r\n"datapref.newpane",\r\n"Show not dissected data on new Packet Bytes pane",\r\n"Show not dissected data on new Packet Bytes pane",\r\n&new_pane);\r\nprefs_register_bool_preference(module_data,\r\n"show_as_text",\r\n"Show data as text",\r\n"Show data as text in the Packet Details pane",\r\n&show_as_text);\r\nprefs_register_bool_preference(module_data,\r\n"md5_hash",\r\n"Generate MD5 hash",\r\n"Whether or not MD5 hashes should be generated and shown for each payload.",\r\n&generate_md5_hash);\r\nproto_set_cant_toggle(proto_data);\r\n}

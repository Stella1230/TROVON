static int dissect_batadv_plugin(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 version;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nversion = tvb_get_guint8(tvb, 1);\r\nif (version < 15)\r\ndissect_batadv_v5(tvb, pinfo, tree);\r\nelse\r\ndissect_batadv_v15(tvb, pinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void dissect_batadv_v5(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 type;\r\ntype = tvb_get_guint8(tvb, 0);\r\nswitch (type) {\r\ncase BATADV_PACKET_V5:\r\ndissect_batadv_batman(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_ICMP_V5:\r\ndissect_batadv_icmp(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_V5:\r\ndissect_batadv_unicast(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_FRAG_V12:\r\ndissect_batadv_unicast_frag(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_BCAST_V5:\r\ndissect_batadv_bcast(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_VIS_V5:\r\ndissect_batadv_vis(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_TT_QUERY_V14:\r\ndissect_batadv_tt_query(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_ROAM_ADV_V14:\r\ndissect_batadv_roam_adv(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_4ADDR_V14:\r\ndissect_batadv_unicast_4addr(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\n{\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_???");\r\nlength_remaining = tvb_reported_length_remaining(tvb, 0);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, 0);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void dissect_batadv_v15(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nguint8 type;\r\ntype = tvb_get_guint8(tvb, 0);\r\nswitch (type) {\r\ncase BATADV_IV_OGM_V15:\r\ndissect_batadv_iv_ogm(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_BCAST_V15:\r\ndissect_batadv_bcast(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_CODED_V15:\r\ndissect_batadv_coded(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_V15:\r\ndissect_batadv_unicast(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_FRAG_V15:\r\ndissect_batadv_unicast_frag(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_4ADDR_V15:\r\ndissect_batadv_unicast_4addr(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_ICMP_V15:\r\ndissect_batadv_icmp(tvb, pinfo, tree);\r\nbreak;\r\ncase BATADV_UNICAST_TVLV_V15:\r\ndissect_batadv_unicast_tvlv(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\n{\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_???");\r\nlength_remaining = tvb_captured_length_remaining(tvb, 0);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, 0);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void dissect_batadv_batman(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\nint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_BATMAN");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 5:\r\ncase 6:\r\nwhile (offset != -1 && tvb_reported_length_remaining(tvb, offset) >= BATMAN_PACKET_V5_SIZE) {\r\noffset = dissect_batadv_batman_v5(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ncase 7:\r\ncase 8:\r\nwhile (offset != -1 && tvb_reported_length_remaining(tvb, offset) >= BATMAN_PACKET_V7_SIZE) {\r\noffset = dissect_batadv_batman_v7(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ncase 9:\r\nwhile (offset != -1 && tvb_reported_length_remaining(tvb, offset) >= BATMAN_PACKET_V9_SIZE) {\r\noffset = dissect_batadv_batman_v9(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ncase 11:\r\ncase 13:\r\nwhile (offset != -1 && tvb_reported_length_remaining(tvb, offset) >= BATMAN_PACKET_V11_SIZE) {\r\noffset = dissect_batadv_batman_v11(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ncase 10:\r\ncase 12:\r\nwhile (offset != -1 && tvb_reported_length_remaining(tvb, offset) >= BATMAN_PACKET_V10_SIZE) {\r\noffset = dissect_batadv_batman_v10(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ncase 14:\r\nwhile (offset != -1 && tvb_reported_length_remaining(tvb, offset) >= BATMAN_PACKET_V14_SIZE) {\r\noffset = dissect_batadv_batman_v14(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_gwflags(tvbuff_t *tvb, guint8 gwflags, int offset, proto_item *tgw)\r\n{\r\nproto_tree *gwflags_tree;\r\nguint8 s = (gwflags & 0x80) >> 7;\r\nguint8 downbits = (gwflags & 0x78) >> 3;\r\nguint8 upbits = (gwflags & 0x07);\r\nguint down, up;\r\nif (gwflags == 0) {\r\ndown = 0;\r\nup = 0;\r\n} else {\r\ndown = 32 * (s + 2) * (1 << downbits);\r\nup = ((upbits + 1) * down) / 8;\r\n}\r\ngwflags_tree = proto_item_add_subtree(tgw, ett_batadv_batman_gwflags);\r\nproto_tree_add_uint_format_value(gwflags_tree, hf_batadv_batman_gwflags_dl_speed, tvb, offset, 1, down, "%dkbit", down);\r\nproto_tree_add_uint_format_value(gwflags_tree, hf_batadv_batman_gwflags_ul_speed, tvb, offset, 1, up, "%dkbit", up);\r\n}\r\nstatic int dissect_batadv_batman_v5(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *tgw;\r\nproto_tree *batadv_batman_tree = NULL;\r\nguint8 type;\r\nstruct batman_packet_v5 *batman_packeth;\r\ngint i;\r\ntvbuff_t *next_tvb;\r\nbatman_packeth = (struct batman_packet_v5 *)wmem_alloc(wmem_packet_scope(), sizeof(struct batman_packet_v5));\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nbatman_packeth->version = tvb_get_guint8(tvb, offset+1);\r\nif (batman_packeth->version == 0 || type != BATADV_PACKET_V5) {\r\nreturn -1;\r\n}\r\nbatman_packeth->flags = tvb_get_guint8(tvb, offset+2);\r\nbatman_packeth->ttl = tvb_get_guint8(tvb, offset+3);\r\nbatman_packeth->gwflags = tvb_get_guint8(tvb, offset+4);\r\nbatman_packeth->tq = tvb_get_guint8(tvb, offset+5);\r\nbatman_packeth->seqno = tvb_get_ntohs(tvb, offset+6);\r\nset_address_tvb(&batman_packeth->orig, AT_ETHER, 6, tvb, offset+8);\r\ncopy_address_shallow(&pinfo->dl_src, &batman_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &batman_packeth->orig);\r\nset_address_tvb(&batman_packeth->prev_sender, AT_ETHER, 6, tvb, offset+14);\r\nbatman_packeth->num_tt = tvb_get_guint8(tvb, offset+20);\r\nbatman_packeth->pad = tvb_get_guint8(tvb, offset+21);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", batman_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, offset, BATMAN_PACKET_V5_SIZE,\r\n"B.A.T.M.A.N., Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &batman_packeth->orig));\r\nbatadv_batman_tree = proto_item_add_subtree(ti, ett_batadv_batman);\r\n}\r\nproto_tree_add_uint_format(batadv_batman_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_PACKET_V5,\r\n"Packet Type: %s (%u)", "BATADV_PACKET", BATADV_PACKET_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_batman_tree, tvb, offset, hf_batadv_batman_flags,\r\nett_batadv_batman_flags, batman_v5_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ntgw = proto_tree_add_item(batadv_batman_tree, hf_batadv_batman_gwflags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndissect_batadv_gwflags(tvb, batman_packeth->gwflags, offset, tgw);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_prev_sender, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_num_tt, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, batman_packeth);\r\nfor (i = 0; i < batman_packeth->num_tt; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, 6);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tt(next_tvb, pinfo, batadv_batman_tree);\r\noffset += 6;\r\n}\r\nreturn offset;\r\n}\r\nstatic int dissect_batadv_batman_v7(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *batadv_batman_tree = NULL;\r\nguint8 type;\r\nstruct batman_packet_v7 *batman_packeth;\r\ngint i;\r\ntvbuff_t *next_tvb;\r\nbatman_packeth = (struct batman_packet_v7 *)wmem_alloc(wmem_packet_scope(), sizeof(struct batman_packet_v7));\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nbatman_packeth->version = tvb_get_guint8(tvb, offset+1);\r\nif (batman_packeth->version == 0 || type != BATADV_PACKET_V5) {\r\nreturn -1;\r\n}\r\nbatman_packeth->flags = tvb_get_guint8(tvb, offset+2);\r\nbatman_packeth->tq = tvb_get_guint8(tvb, offset+3);\r\nbatman_packeth->seqno = tvb_get_ntohs(tvb, offset+4);\r\nset_address_tvb(&batman_packeth->orig, AT_ETHER, 6, tvb, offset+6);\r\ncopy_address_shallow(&pinfo->dl_src, &batman_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &batman_packeth->orig);\r\nset_address_tvb(&batman_packeth->prev_sender, AT_ETHER, 6, tvb, offset+12);\r\nbatman_packeth->ttl = tvb_get_guint8(tvb, offset+18);\r\nbatman_packeth->num_tt = tvb_get_guint8(tvb, offset+19);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", batman_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, offset, BATMAN_PACKET_V7_SIZE,\r\n"B.A.T.M.A.N., Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &batman_packeth->orig));\r\nbatadv_batman_tree = proto_item_add_subtree(ti, ett_batadv_batman);\r\n}\r\nproto_tree_add_uint_format(batadv_batman_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_PACKET_V5,\r\n"Packet Type: %s (%u)", "BATADV_PACKET", BATADV_PACKET_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_batman_tree, tvb, offset, hf_batadv_batman_flags,\r\nett_batadv_batman_flags, batman_v5_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_prev_sender, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_num_tt, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, batman_packeth);\r\nfor (i = 0; i < batman_packeth->num_tt; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, 6);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tt(next_tvb, pinfo, batadv_batman_tree);\r\noffset += 6;\r\n}\r\nreturn offset;\r\n}\r\nstatic int dissect_batadv_batman_v9(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *tgw;\r\nproto_tree *batadv_batman_tree = NULL;\r\nguint8 type;\r\nstruct batman_packet_v9 *batman_packeth;\r\ngint i;\r\ntvbuff_t *next_tvb;\r\nbatman_packeth = (struct batman_packet_v9 *)wmem_alloc(wmem_packet_scope(), sizeof(struct batman_packet_v9));\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nbatman_packeth->version = tvb_get_guint8(tvb, offset+1);\r\nif (batman_packeth->version == 0 || type != BATADV_PACKET_V5) {\r\nreturn -1;\r\n}\r\nbatman_packeth->flags = tvb_get_guint8(tvb, offset+2);\r\nbatman_packeth->tq = tvb_get_guint8(tvb, offset+3);\r\nbatman_packeth->seqno = tvb_get_ntohs(tvb, offset+4);\r\nset_address_tvb(&batman_packeth->orig, AT_ETHER, 6, tvb, offset+6);\r\ncopy_address_shallow(&pinfo->dl_src, &batman_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &batman_packeth->orig);\r\nset_address_tvb(&batman_packeth->prev_sender, AT_ETHER, 6, tvb, offset+12);\r\nbatman_packeth->ttl = tvb_get_guint8(tvb, offset+18);\r\nbatman_packeth->num_tt = tvb_get_guint8(tvb, offset+19);\r\nbatman_packeth->gwflags = tvb_get_guint8(tvb, offset+20);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", batman_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, offset, BATMAN_PACKET_V9_SIZE,\r\n"B.A.T.M.A.N., Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &batman_packeth->orig));\r\nbatadv_batman_tree = proto_item_add_subtree(ti, ett_batadv_batman);\r\n}\r\nproto_tree_add_uint_format(batadv_batman_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_PACKET_V5,\r\n"Packet Type: %s (%u)", "BATADV_PACKET", BATADV_PACKET_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_batman_tree, tvb, offset, hf_batadv_batman_flags,\r\nett_batadv_batman_flags, batman_v9_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_prev_sender, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_num_tt, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ntgw = proto_tree_add_item(batadv_batman_tree, hf_batadv_batman_gwflags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndissect_batadv_gwflags(tvb, batman_packeth->gwflags, offset, tgw);\r\noffset += 1;\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, batman_packeth);\r\nfor (i = 0; i < batman_packeth->num_tt; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, 6);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tt(next_tvb, pinfo, batadv_batman_tree);\r\noffset += 6;\r\n}\r\nreturn offset;\r\n}\r\nstatic int dissect_batadv_batman_v10(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *tgw;\r\nproto_tree *batadv_batman_tree = NULL;\r\nguint8 type;\r\nstruct batman_packet_v10 *batman_packeth;\r\ngint i;\r\ntvbuff_t *next_tvb;\r\nbatman_packeth = (struct batman_packet_v10 *)wmem_alloc(wmem_packet_scope(), sizeof(struct batman_packet_v10));\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nbatman_packeth->version = tvb_get_guint8(tvb, offset+1);\r\nif (batman_packeth->version == 0 || type != BATADV_PACKET_V5) {\r\nreturn -1;\r\n}\r\nbatman_packeth->flags = tvb_get_guint8(tvb, offset+2);\r\nbatman_packeth->tq = tvb_get_guint8(tvb, offset+3);\r\nbatman_packeth->seqno = tvb_get_ntohl(tvb, offset+4);\r\nset_address_tvb(&batman_packeth->orig, AT_ETHER, 6, tvb, offset+8);\r\ncopy_address_shallow(&pinfo->dl_src, &batman_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &batman_packeth->orig);\r\nset_address_tvb(&batman_packeth->prev_sender, AT_ETHER, 6, tvb, offset+14);\r\nbatman_packeth->ttl = tvb_get_guint8(tvb, offset+20);\r\nbatman_packeth->num_tt = tvb_get_guint8(tvb, offset+21);\r\nbatman_packeth->gwflags = tvb_get_guint8(tvb, offset+22);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", batman_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, offset, BATMAN_PACKET_V10_SIZE,\r\n"B.A.T.M.A.N., Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &batman_packeth->orig));\r\nbatadv_batman_tree = proto_item_add_subtree(ti, ett_batadv_batman);\r\n}\r\nproto_tree_add_uint_format(batadv_batman_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_PACKET_V5,\r\n"Packet Type: %s (%u)", "BATADV_PACKET", BATADV_PACKET_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_batman_tree, tvb, offset, hf_batadv_batman_flags,\r\nett_batadv_batman_flags, batman_v9_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_prev_sender, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_num_tt, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ntgw = proto_tree_add_item(batadv_batman_tree, hf_batadv_batman_gwflags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndissect_batadv_gwflags(tvb, batman_packeth->gwflags, offset, tgw);\r\noffset += 1;\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, batman_packeth);\r\nfor (i = 0; i < batman_packeth->num_tt; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, 6);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tt(next_tvb, pinfo, batadv_batman_tree);\r\noffset += 6;\r\n}\r\nreturn offset;\r\n}\r\nstatic int dissect_batadv_batman_v11(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *batadv_batman_tree = NULL;\r\nguint8 type;\r\nstruct batman_packet_v11 *batman_packeth;\r\ngint i;\r\ntvbuff_t *next_tvb;\r\nbatman_packeth = (struct batman_packet_v11 *)wmem_alloc(wmem_packet_scope(), sizeof(struct batman_packet_v11));\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nbatman_packeth->version = tvb_get_guint8(tvb, offset+1);\r\nif (batman_packeth->version == 0 || type != BATADV_PACKET_V5) {\r\nreturn -1;\r\n}\r\nbatman_packeth->flags = tvb_get_guint8(tvb, offset+2);\r\nbatman_packeth->tq = tvb_get_guint8(tvb, offset+3);\r\nbatman_packeth->seqno = tvb_get_ntohl(tvb, offset+4);\r\nset_address_tvb(&batman_packeth->orig, AT_ETHER, 6, tvb, offset+8);\r\ncopy_address_shallow(&pinfo->dl_src, &batman_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &batman_packeth->orig);\r\nset_address_tvb(&batman_packeth->prev_sender, AT_ETHER, 6, tvb, offset+14);\r\nbatman_packeth->ttl = tvb_get_guint8(tvb, offset+20);\r\nbatman_packeth->num_tt = tvb_get_guint8(tvb, offset+21);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", batman_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, offset, BATMAN_PACKET_V11_SIZE,\r\n"B.A.T.M.A.N., Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &batman_packeth->orig));\r\nbatadv_batman_tree = proto_item_add_subtree(ti, ett_batadv_batman);\r\n}\r\nproto_tree_add_uint_format(batadv_batman_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_PACKET_V5,\r\n"Packet Type: %s (%u)", "BATADV_PACKET", BATADV_PACKET_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_batman_tree, tvb, offset, hf_batadv_batman_flags,\r\nett_batadv_batman_flags, batman_v9_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_prev_sender, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_num_tt, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, batman_packeth);\r\nfor (i = 0; i < batman_packeth->num_tt; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, 6);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tt(next_tvb, pinfo, batadv_batman_tree);\r\noffset += 6;\r\n}\r\nreturn offset;\r\n}\r\nstatic int dissect_batadv_batman_v14(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *tgw;\r\nproto_tree *batadv_batman_tree = NULL;\r\nguint8 type;\r\nstruct batman_packet_v14 *batman_packeth;\r\ngint i;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nbatman_packeth = (struct batman_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct batman_packet_v14));\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nbatman_packeth->version = tvb_get_guint8(tvb, offset+1);\r\nif (batman_packeth->version == 0 || type != BATADV_PACKET_V5) {\r\nreturn -1;\r\n}\r\nbatman_packeth->ttl = tvb_get_guint8(tvb, offset+2);\r\nbatman_packeth->flags = tvb_get_guint8(tvb, offset+3);\r\nbatman_packeth->seqno = tvb_get_ntohl(tvb, offset+4);\r\nset_address_tvb(&batman_packeth->orig, AT_ETHER, 6, tvb, offset+8);\r\ncopy_address_shallow(&pinfo->dl_src, &batman_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &batman_packeth->orig);\r\nset_address_tvb(&batman_packeth->prev_sender, AT_ETHER, 6, tvb, offset+14);\r\nbatman_packeth->gw_flags = tvb_get_guint8(tvb, offset+20);\r\nbatman_packeth->tq = tvb_get_guint8(tvb, offset+21);\r\nbatman_packeth->tt_num_changes = tvb_get_guint8(tvb, offset+22);\r\nbatman_packeth->ttvn = tvb_get_guint8(tvb, offset+23);\r\nbatman_packeth->tt_crc = tvb_get_ntohs(tvb, offset+24);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", batman_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, offset, BATMAN_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N., Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &batman_packeth->orig));\r\nbatadv_batman_tree = proto_item_add_subtree(ti, ett_batadv_batman);\r\n}\r\nproto_tree_add_uint_format(batadv_batman_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_PACKET_V5,\r\n"Packet Type: %s (%u)", "BATADV_PACKET", BATADV_PACKET_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_batman_tree, tvb, offset, hf_batadv_batman_flags,\r\nett_batadv_batman_flags, batman_v14_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_prev_sender, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntgw = proto_tree_add_item(batadv_batman_tree, hf_batadv_batman_gwflags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndissect_batadv_gwflags(tvb, batman_packeth->gw_flags, offset, tgw);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tt_num_changes, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_ttvn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_batman_tree, hf_batadv_batman_tt_crc, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, batman_packeth);\r\nfor (i = 0; i < batman_packeth->tt_num_changes; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, TT_ENTRY_V14_SIZE);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_tt_entry_v14(next_tvb, pinfo, batadv_batman_tree);\r\noffset += TT_ENTRY_V14_SIZE;\r\n}\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nreturn offset;\r\n}\r\nstatic void dissect_batadv_iv_ogm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\nint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_IV_OGM");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 15:\r\nwhile (offset != -1 &&\r\ntvb_captured_length_remaining(tvb, offset) >= IV_OGM_PACKET_V15_SIZE) {\r\noffset = dissect_batadv_iv_ogm_v15(tvb, offset, pinfo, tree);\r\n}\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic int dissect_batadv_iv_ogm_v15(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *batadv_iv_ogm_tree = NULL;\r\nguint8 type, version;\r\nstruct iv_ogm_packet_v15 *iv_ogm_packeth;\r\ntvbuff_t *next_tvb;\r\nstatic const int * flags[] = {\r\n&hf_batadv_iv_ogm_flags_directlink,\r\n&hf_batadv_iv_ogm_flags_primaries_first_hop,\r\n&hf_batadv_iv_ogm_flags_not_best_next_hop,\r\nNULL\r\n};\r\ntype = tvb_get_guint8(tvb, offset+0);\r\nversion = tvb_get_guint8(tvb, offset+1);\r\nif (version == 0 || type != BATADV_IV_OGM_V15)\r\nreturn -1;\r\niv_ogm_packeth = (struct iv_ogm_packet_v15 *)wmem_alloc(wmem_packet_scope(),\r\nsizeof(struct iv_ogm_packet_v15));\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", iv_ogm_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, offset,\r\nIV_OGM_PACKET_V15_SIZE + iv_ogm_packeth->tvlv_len,\r\n"B.A.T.M.A.N. IV OGM, Orig: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, offset + 8));\r\nbatadv_iv_ogm_tree = proto_item_add_subtree(ti, ett_batadv_iv_ogm);\r\n}\r\niv_ogm_packeth->packet_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(batadv_iv_ogm_tree,\r\nhf_batadv_packet_type,\r\ntvb, offset, 1, BATADV_IV_OGM_V15,\r\n"%s (%u)", "BATADV_IV_OGM",\r\nBATADV_IV_OGM_V15);\r\noffset += 1;\r\niv_ogm_packeth->version = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_version, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\niv_ogm_packeth->ttl = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_ttl, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\niv_ogm_packeth->flags = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_bitmask(batadv_iv_ogm_tree, tvb, offset,\r\nhf_batadv_iv_ogm_flags, ett_batadv_iv_ogm_flags,\r\nflags, ENC_NA);\r\noffset += 1;\r\niv_ogm_packeth->seqno = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_seqno, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nset_address_tvb(&iv_ogm_packeth->orig, AT_ETHER, 6, tvb, offset);\r\nset_address_tvb(&pinfo->dl_src, AT_ETHER, 6, tvb, offset);\r\nset_address_tvb(&pinfo->src, AT_ETHER, 6, tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_orig, tvb,\r\noffset, 6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&iv_ogm_packeth->prev_sender, AT_ETHER, 6, tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_prev_sender, tvb,\r\noffset, 6, ENC_NA);\r\noffset += 6;\r\niv_ogm_packeth->reserved = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\niv_ogm_packeth->tq = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_tq, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\niv_ogm_packeth->tvlv_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(batadv_iv_ogm_tree, hf_batadv_iv_ogm_tvlv_len, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, iv_ogm_packeth);\r\nif (iv_ogm_packeth->tvlv_len > 0) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset,\r\niv_ogm_packeth->tvlv_len);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tvlv_v15(next_tvb, pinfo, batadv_iv_ogm_tree);\r\noffset += iv_ogm_packeth->tvlv_len;\r\n}\r\nreturn offset;\r\n}\r\nstatic void dissect_batadv_tt(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *batadv_batman_tt_tree;\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, 6,\r\n"B.A.T.M.A.N. TT: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 0));\r\nbatadv_batman_tt_tree = proto_item_add_subtree(ti, ett_batadv_batman_tt);\r\nproto_tree_add_item(batadv_batman_tt_tree, hf_batadv_batman_tt, tvb, 0, 6, ENC_NA);\r\n}\r\nstatic void dissect_batadv_bcast(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_BCAST");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 6:\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ndissect_batadv_bcast_v6(tvb, pinfo, tree);\r\nbreak;\r\ncase 10:\r\ncase 11:\r\ncase 12:\r\ncase 13:\r\ndissect_batadv_bcast_v10(tvb, pinfo, tree);\r\nbreak;\r\ncase 14:\r\ncase 15:\r\ndissect_batadv_bcast_v14(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_bcast_v6(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct bcast_packet_v6 *bcast_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_bcast_tree = NULL;\r\nbcast_packeth = (struct bcast_packet_v6 *)wmem_alloc(wmem_packet_scope(), sizeof(struct bcast_packet_v6));\r\nbcast_packeth->version = tvb_get_guint8(tvb, 1);\r\nset_address_tvb(&bcast_packeth->orig, AT_ETHER, 6, tvb, 2);\r\ncopy_address_shallow(&pinfo->dl_src, &bcast_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &bcast_packeth->orig);\r\nbcast_packeth->seqno = tvb_get_ntohs(tvb, 8);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", bcast_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, BCAST_PACKET_V6_SIZE,\r\n"B.A.T.M.A.N. Bcast, Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &bcast_packeth->orig));\r\nbatadv_bcast_tree = proto_item_add_subtree(ti, ett_batadv_bcast);\r\n}\r\nproto_tree_add_uint_format(batadv_bcast_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_BCAST_V5,\r\n"Packet Type: %s (%u)", "BATADV_BCAST", BATADV_BCAST_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, bcast_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_bcast_v10(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct bcast_packet_v10 *bcast_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_bcast_tree = NULL;\r\nbcast_packeth = (struct bcast_packet_v10 *)wmem_alloc(wmem_packet_scope(), sizeof(struct bcast_packet_v10));\r\nbcast_packeth->version = tvb_get_guint8(tvb, 1);\r\nset_address_tvb(&bcast_packeth->orig, AT_ETHER, 6, tvb, 2);\r\ncopy_address_shallow(&pinfo->dl_src, &bcast_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &bcast_packeth->orig);\r\nbcast_packeth->ttl = tvb_get_guint8(tvb, 8);\r\nbcast_packeth->seqno = tvb_get_ntohl(tvb, 9);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", bcast_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, BCAST_PACKET_V10_SIZE,\r\n"B.A.T.M.A.N. Bcast, Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &bcast_packeth->orig));\r\nbatadv_bcast_tree = proto_item_add_subtree(ti, ett_batadv_bcast);\r\n}\r\nproto_tree_add_uint_format(batadv_bcast_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_BCAST_V5,\r\n"Packet Type: %s (%u)", "BATADV_BCAST", BATADV_BCAST_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ntap_queue_packet(batadv_tap, pinfo, bcast_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_bcast_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct bcast_packet_v14 *bcast_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_bcast_tree = NULL;\r\nbcast_packeth = (struct bcast_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct bcast_packet_v14));\r\nbcast_packeth->packet_type = tvb_get_guint8(tvb, 0);\r\nbcast_packeth->version = tvb_get_guint8(tvb, 1);\r\nbcast_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nbcast_packeth->reserved = tvb_get_guint8(tvb, 3);\r\nbcast_packeth->seqno = tvb_get_ntohl(tvb, 4);\r\nset_address_tvb(&bcast_packeth->orig, AT_ETHER, 6, tvb, 8);\r\ncopy_address_shallow(&pinfo->dl_src, &bcast_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &bcast_packeth->orig);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq=%u", bcast_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, BCAST_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. Bcast, Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &bcast_packeth->orig));\r\nbatadv_bcast_tree = proto_item_add_subtree(ti, ett_batadv_bcast);\r\n}\r\nproto_tree_add_uint_format_value(batadv_bcast_tree,\r\nhf_batadv_packet_type, tvb, offset, 1,\r\nbcast_packeth->packet_type,\r\n"%s (%u)", "BATADV_BCAST",\r\nbcast_packeth->packet_type);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(batadv_bcast_tree, hf_batadv_bcast_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntap_queue_packet(batadv_tap, pinfo, bcast_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_icmp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_ICMP");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 6:\r\ndissect_batadv_icmp_v6(tvb, pinfo, tree);\r\nbreak;\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ncase 10:\r\ncase 11:\r\ncase 12:\r\ncase 13:\r\ndissect_batadv_icmp_v7(tvb, pinfo, tree);\r\nbreak;\r\ncase 14:\r\ndissect_batadv_icmp_v14(tvb, pinfo, tree);\r\nbreak;\r\ncase 15:\r\ndissect_batadv_icmp_v15(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_icmp_v6(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct icmp_packet_v6 *icmp_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_icmp_tree = NULL;\r\nicmp_packeth = (struct icmp_packet_v6 *)wmem_alloc(wmem_packet_scope(), sizeof(struct icmp_packet_v6));\r\nicmp_packeth->version = tvb_get_guint8(tvb, 1);\r\nicmp_packeth->msg_type = tvb_get_guint8(tvb, 2);\r\nset_address_tvb(&icmp_packeth->dst, AT_ETHER, 6, tvb, 3);\r\nset_address_tvb(&icmp_packeth->orig, AT_ETHER, 6, tvb, 9);\r\ncopy_address_shallow(&pinfo->dl_src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->dl_dst, &icmp_packeth->dst);\r\ncopy_address_shallow(&pinfo->dst, &icmp_packeth->dst);\r\nicmp_packeth->ttl = tvb_get_guint8(tvb, 15);\r\nicmp_packeth->uid = tvb_get_guint8(tvb, 16);\r\nicmp_packeth->seqno = tvb_get_ntohs(tvb, 17);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(icmp_packeth->msg_type, icmp_packettypenames, "Unknown (0x%02x)"),\r\nicmp_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, ICMP_PACKET_V6_SIZE,\r\n"B.A.T.M.A.N. ICMP, Orig: %s, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &icmp_packeth->orig),\r\naddress_with_resolution_to_str(wmem_packet_scope(), &icmp_packeth->dst));\r\nbatadv_icmp_tree = proto_item_add_subtree(ti, ett_batadv_icmp);\r\n}\r\nproto_tree_add_uint_format(batadv_icmp_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_ICMP_V5,\r\n"Packet Type: %s (%u)", "BATADV_ICMP", BATADV_ICMP_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_msg_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_uid, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, icmp_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void\r\ndissect_batadv_icmp_rr(proto_tree *batadv_icmp_tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_tree *field_tree;\r\nint ptr, i;\r\nptr = tvb_get_guint8(tvb, offset);\r\nif (ptr < 1 || ptr > BAT_RR_LEN)\r\nreturn;\r\nfield_tree = proto_tree_add_subtree(batadv_icmp_tree, tvb, offset, 1+ 6 * BAT_RR_LEN,\r\nett_batadv_icmp_rr, NULL, "ICMP RR");\r\nproto_tree_add_item(field_tree, hf_batadv_icmp_rr_pointer, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nptr--;\r\noffset++;\r\nfor (i = 0; i < BAT_RR_LEN; i++) {\r\nproto_tree_add_ether_format(field_tree, hf_batadv_icmp_rr_ether, tvb, offset, 6, tvb_get_ptr(tvb, offset, 6),\r\n"%s%s", (i > ptr) ? "-" : tvb_ether_to_str(tvb, offset),\r\n(i == ptr) ? " <- (current)" : "");\r\noffset += 6;\r\n}\r\n}\r\nstatic void\r\ndissect_batadv_icmp_rr_v15(proto_tree *batadv_icmp_tree, tvbuff_t *tvb,\r\nint offset, int ptr)\r\n{\r\nproto_tree *field_tree;\r\nint i;\r\nfield_tree = proto_tree_add_subtree(batadv_icmp_tree, tvb, offset,\r\n6 * BAT_RR_LEN,\r\nett_batadv_icmp_rr, NULL,\r\n"ICMP RR");\r\nptr--;\r\nfor (i = 0; i < BAT_RR_LEN; i++) {\r\nproto_tree_add_ether_format(field_tree, hf_batadv_icmp_rr_ether,\r\ntvb, offset, 6,\r\ntvb_get_ptr(tvb, offset, 6),\r\n"%s%s",\r\n(i > ptr) ? "-" : tvb_ether_to_str(tvb, offset),\r\n(i == ptr) ? " <- (current)" : "");\r\noffset += 6;\r\n}\r\n}\r\nstatic void dissect_batadv_icmp_v7(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct icmp_packet_v7 *icmp_packeth;\r\nproto_item *ti;\r\nproto_tree *batadv_icmp_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nicmp_packeth = (struct icmp_packet_v7 *)wmem_alloc(wmem_packet_scope(), sizeof(struct icmp_packet_v7));\r\nicmp_packeth->version = tvb_get_guint8(tvb, 1);\r\nicmp_packeth->msg_type = tvb_get_guint8(tvb, 2);\r\nicmp_packeth->ttl = tvb_get_guint8(tvb, 3);\r\nset_address_tvb(&icmp_packeth->dst, AT_ETHER, 6, tvb, 4);\r\nset_address_tvb(&icmp_packeth->orig, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->dl_src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->dl_dst, &icmp_packeth->dst);\r\ncopy_address_shallow(&pinfo->dst, &icmp_packeth->dst);\r\nicmp_packeth->seqno = tvb_get_ntohs(tvb, 16);\r\nicmp_packeth->uid = tvb_get_guint8(tvb, 17);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(icmp_packeth->msg_type, icmp_packettypenames, "Unknown (0x%02x)"),\r\nicmp_packeth->seqno);\r\nif (tree) {\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, ICMP_PACKET_V7_SIZE,\r\n"B.A.T.M.A.N. ICMP, Orig: %s, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &icmp_packeth->orig),\r\naddress_with_resolution_to_str(wmem_packet_scope(), &icmp_packeth->dst));\r\nbatadv_icmp_tree = proto_item_add_subtree(ti, ett_batadv_icmp);\r\n}\r\nproto_tree_add_uint_format(batadv_icmp_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_ICMP_V5,\r\n"Packet Type: %s (%u)", "BATADV_ICMP", BATADV_ICMP_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_msg_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_uid, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining >= 1 + BAT_RR_LEN * 6) {\r\ndissect_batadv_icmp_rr(batadv_icmp_tree, tvb, offset);\r\noffset += 1 + BAT_RR_LEN * 6;\r\n}\r\ntap_queue_packet(batadv_tap, pinfo, icmp_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_icmp_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct icmp_packet_v14 *icmp_packeth;\r\nproto_item *ti;\r\nproto_tree *batadv_icmp_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nicmp_packeth = (struct icmp_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct icmp_packet_v14));\r\nicmp_packeth->version = tvb_get_guint8(tvb, 1);\r\nicmp_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nicmp_packeth->msg_type = tvb_get_guint8(tvb, 3);\r\nset_address_tvb(&icmp_packeth->dst, AT_ETHER, 6, tvb, 4);\r\nset_address_tvb(&icmp_packeth->orig, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->dl_src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->dl_dst, &icmp_packeth->dst);\r\ncopy_address_shallow(&pinfo->dst, &icmp_packeth->dst);\r\nicmp_packeth->seqno = tvb_get_ntohs(tvb, 16);\r\nicmp_packeth->uid = tvb_get_guint8(tvb, 17);\r\nicmp_packeth->reserved = tvb_get_guint8(tvb, 18);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(icmp_packeth->msg_type, icmp_packettypenames, "Unknown (0x%02x)"),\r\nicmp_packeth->seqno);\r\nif (tree) {\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, ICMP_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. ICMP, Orig: %s, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &icmp_packeth->orig),\r\naddress_with_resolution_to_str(wmem_packet_scope(), &icmp_packeth->dst));\r\nbatadv_icmp_tree = proto_item_add_subtree(ti, ett_batadv_icmp);\r\n}\r\nproto_tree_add_uint_format(batadv_icmp_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_ICMP_V5,\r\n"Packet Type: %s (%u)", "BATADV_ICMP", BATADV_ICMP_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_msg_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_uid, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining >= 1 + BAT_RR_LEN * 6) {\r\ndissect_batadv_icmp_rr(batadv_icmp_tree, tvb, offset);\r\noffset += 1 + BAT_RR_LEN * 6;\r\n}\r\ntap_queue_packet(batadv_tap, pinfo, icmp_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset(tvb, offset, length_remaining, -1);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_icmp_v15(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nstruct icmp_packet_v15 *icmp_packeth;\r\nproto_item *ti;\r\nproto_tree *batadv_icmp_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nicmp_packeth = (struct icmp_packet_v15 *)wmem_alloc(wmem_packet_scope(),\r\nsizeof(struct icmp_packet_v15));\r\nicmp_packeth->msg_type = tvb_get_guint8(tvb, offset + 4);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(icmp_packeth->msg_type, icmp_packettypenames,\r\n"Unknown (0x%02x)"),\r\nicmp_packeth->seqno);\r\nif (tree) {\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, 0, ICMP_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. ICMP, Orig: %s, Dst: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 10),\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 4));\r\nbatadv_icmp_tree = proto_item_add_subtree(ti, ett_batadv_icmp);\r\n}\r\nicmp_packeth->packet_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(batadv_icmp_tree,\r\nhf_batadv_packet_type, tvb,\r\noffset, 1, icmp_packeth->packet_type,\r\n"%s (%u)", "BATADV_ICMP",\r\nicmp_packeth->packet_type);\r\noffset += 1;\r\nicmp_packeth->version = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_version, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nicmp_packeth->ttl = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_ttl, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nicmp_packeth->msg_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_msg_type, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nset_address_tvb(&icmp_packeth->dst, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_dst, &icmp_packeth->dst);\r\ncopy_address_shallow(&pinfo->dst, &icmp_packeth->dst);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_dst, tvb, offset,\r\n6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&icmp_packeth->orig, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_src, &icmp_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &icmp_packeth->orig);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_orig, tvb, offset,\r\n6, ENC_NA);\r\noffset += 6;\r\nicmp_packeth->uid = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_uid, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nicmp_packeth->rr_ptr = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_rr_pointer, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nicmp_packeth->seqno = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(batadv_icmp_tree, hf_batadv_icmp_seqno, tvb, offset,\r\n2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\nif (length_remaining >= BAT_RR_LEN * 6) {\r\ndissect_batadv_icmp_rr_v15(batadv_icmp_tree, tvb, offset,\r\nicmp_packeth->rr_ptr);\r\noffset += BAT_RR_LEN * 6;\r\n}\r\ntap_queue_packet(batadv_tap, pinfo, icmp_packeth);\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset(tvb, offset, length_remaining, -1);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_unicast(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_UNICAST");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 6:\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ncase 10:\r\ncase 11:\r\ncase 12:\r\ncase 13:\r\ndissect_batadv_unicast_v6(tvb, pinfo, tree);\r\nbreak;\r\ncase 14:\r\ncase 15:\r\ndissect_batadv_unicast_v14(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_v6(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct unicast_packet_v6 *unicast_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_unicast_tree = NULL;\r\nunicast_packeth = (struct unicast_packet_v6 *)wmem_alloc(wmem_packet_scope(), sizeof(struct unicast_packet_v6));\r\nunicast_packeth->version = tvb_get_guint8(tvb, 1);\r\nset_address_tvb(&unicast_packeth->dest, AT_ETHER, 6, tvb, 2);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_packeth->dest);\r\nunicast_packeth->ttl = tvb_get_guint8(tvb, 8);\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, UNICAST_PACKET_V6_SIZE,\r\n"B.A.T.M.A.N. Unicast, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &unicast_packeth->dest));\r\nbatadv_unicast_tree = proto_item_add_subtree(ti, ett_batadv_unicast);\r\n}\r\nproto_tree_add_uint_format(batadv_unicast_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_UNICAST_V5,\r\n"Packet Type: %s (%u)", "BATADV_UNICAST", BATADV_UNICAST_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct unicast_packet_v14 *unicast_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_unicast_tree = NULL;\r\nunicast_packeth = (struct unicast_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct unicast_packet_v14));\r\nunicast_packeth->packet_type = tvb_get_guint8(tvb, 0);\r\nunicast_packeth->version = tvb_get_guint8(tvb, 1);\r\nunicast_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nunicast_packeth->ttvn = tvb_get_guint8(tvb, 3);\r\nset_address_tvb(&unicast_packeth->dest, AT_ETHER, 6, tvb, 4);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_packeth->dest);\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, UNICAST_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. Unicast, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &unicast_packeth->dest));\r\nbatadv_unicast_tree = proto_item_add_subtree(ti, ett_batadv_unicast);\r\n}\r\nproto_tree_add_uint_format_value(batadv_unicast_tree,\r\nhf_batadv_packet_type, tvb, offset, 1,\r\nunicast_packeth->packet_type,\r\n"%s (%u)",\r\n"BATADV_UNICAST",\r\nunicast_packeth->packet_type);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_ttvn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_tree, hf_batadv_unicast_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_4addr(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_UNICAST_4ADDR");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 14:\r\ncase 15:\r\ndissect_batadv_unicast_4addr_v14(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_4addr_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct unicast_4addr_packet_v14 *unicast_4addr_packeth;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nproto_tree *batadv_unicast_4addr_tree = NULL;\r\nunicast_4addr_packeth = (struct unicast_4addr_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct unicast_4addr_packet_v14));\r\nunicast_4addr_packeth->packet_type = tvb_get_guint8(tvb, 0);\r\nunicast_4addr_packeth->version = tvb_get_guint8(tvb, 1);\r\nunicast_4addr_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nunicast_4addr_packeth->ttvn = tvb_get_guint8(tvb, 3);\r\nset_address_tvb(&unicast_4addr_packeth->dest, AT_ETHER, 6, tvb, 4);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_4addr_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_4addr_packeth->dest);\r\nset_address_tvb(&unicast_4addr_packeth->src, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->dl_src, &unicast_4addr_packeth->src);\r\ncopy_address_shallow(&pinfo->src, &unicast_4addr_packeth->src);\r\nunicast_4addr_packeth->subtype = tvb_get_guint8(tvb, 16);\r\nunicast_4addr_packeth->reserved = tvb_get_guint8(tvb, 17);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s",\r\nval_to_str(unicast_4addr_packeth->subtype, unicast_4addr_typenames, "Unknown (0x%02x)"));\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, UNICAST_4ADDR_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. Unicast 4Addr, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &unicast_4addr_packeth->dest));\r\nbatadv_unicast_4addr_tree = proto_item_add_subtree(ti, ett_batadv_unicast_4addr);\r\n}\r\nproto_tree_add_uint_format_value(batadv_unicast_4addr_tree,\r\nhf_batadv_packet_type, tvb, offset, 1,\r\nunicast_4addr_packeth->packet_type,\r\n"%s (%u)", "BATADV_UNICAST_4ADDR",\r\nunicast_4addr_packeth->packet_type);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_4addr_tree, hf_batadv_unicast_4addr_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_4addr_tree, hf_batadv_unicast_4addr_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_4addr_tree, hf_batadv_unicast_4addr_ttvn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_4addr_tree, hf_batadv_unicast_4addr_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_unicast_4addr_tree, hf_batadv_unicast_4addr_src, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_unicast_4addr_tree, hf_batadv_unicast_4addr_subtype, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_4addr_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_frag(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_UNICAST_FRAG");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 12:\r\ncase 13:\r\ndissect_batadv_unicast_frag_v12(tvb, pinfo, tree);\r\nbreak;\r\ncase 14:\r\ndissect_batadv_unicast_frag_v14(tvb, pinfo, tree);\r\nbreak;\r\ncase 15:\r\ndissect_batadv_unicast_frag_v15(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_frag_v12(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct unicast_frag_packet_v12 *unicast_frag_packeth;\r\ngboolean save_fragmented;\r\nfragment_head *frag_msg = NULL;\r\nproto_tree *batadv_unicast_frag_tree = NULL;\r\ntvbuff_t *new_tvb;\r\nint offset = 0;\r\nint head = 0;\r\ngint length_remaining;\r\nunicast_frag_packeth = (struct unicast_frag_packet_v12 *)wmem_alloc(wmem_packet_scope(), sizeof(struct unicast_frag_packet_v12));\r\nunicast_frag_packeth->version = tvb_get_guint8(tvb, 1);\r\nset_address_tvb(&unicast_frag_packeth->dest, AT_ETHER, 6, tvb, 2);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_frag_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_frag_packeth->dest);\r\nunicast_frag_packeth->ttl = tvb_get_guint8(tvb, 8);\r\nunicast_frag_packeth->flags = tvb_get_guint8(tvb, 9);\r\nset_address_tvb(&unicast_frag_packeth->orig, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->dl_src, &unicast_frag_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &unicast_frag_packeth->orig);\r\nunicast_frag_packeth->seqno = tvb_get_ntohs(tvb, 16);\r\nsave_fragmented = pinfo->fragmented;\r\npinfo->fragmented = TRUE;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, UNICAST_FRAG_PACKET_V12_SIZE,\r\n"B.A.T.M.A.N. Unicast Fragment, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &unicast_frag_packeth->dest));\r\nbatadv_unicast_frag_tree = proto_item_add_subtree(ti, ett_batadv_unicast_frag);\r\n}\r\nproto_tree_add_uint_format(batadv_unicast_frag_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_UNICAST_FRAG_V12,\r\n"Packet Type: %s (%u)", "BATADV_UNICAST_FRAG", BATADV_UNICAST_FRAG_V12);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_unicast_frag_tree, tvb, offset, hf_batadv_unicast_frag_flags,\r\nett_batadv_batman_flags, unicast_frag_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_frag_packeth);\r\nhead = (unicast_frag_packeth->flags & 0x1);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining < 0)\r\nlength_remaining = 0;\r\nfrag_msg = fragment_add_seq_check(&msg_reassembly_table,\r\ntvb, offset,\r\npinfo, unicast_frag_packeth->seqno + head, NULL,\r\n1 - head,\r\nlength_remaining,\r\nhead);\r\nnew_tvb = process_reassembled_data(tvb, offset, pinfo,\r\n"Reassembled Message", frag_msg, &msg_frag_items,\r\nNULL, batadv_unicast_frag_tree);\r\nif (new_tvb) {\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, new_tvb);\r\n}\r\ncall_dissector(eth_handle, new_tvb, pinfo, tree);\r\n}\r\npinfo->fragmented = save_fragmented;\r\n}\r\nstatic void dissect_batadv_unicast_frag_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct unicast_frag_packet_v14 *unicast_frag_packeth;\r\ngboolean save_fragmented;\r\nfragment_head *frag_msg = NULL;\r\nproto_tree *batadv_unicast_frag_tree = NULL;\r\ntvbuff_t *new_tvb;\r\nint offset = 0;\r\nint head = 0;\r\ngint length_remaining;\r\nunicast_frag_packeth = (struct unicast_frag_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct unicast_frag_packet_v14));\r\nunicast_frag_packeth->version = tvb_get_guint8(tvb, 1);\r\nunicast_frag_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nunicast_frag_packeth->ttvn = tvb_get_guint8(tvb, 3);\r\nset_address_tvb(&unicast_frag_packeth->dest, AT_ETHER, 6, tvb, 4);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_frag_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_frag_packeth->dest);\r\nunicast_frag_packeth->flags = tvb_get_guint8(tvb, 10);\r\nunicast_frag_packeth->align = tvb_get_guint8(tvb, 11);\r\nset_address_tvb(&unicast_frag_packeth->orig, AT_ETHER, 6, tvb, 12);\r\ncopy_address_shallow(&pinfo->dl_src, &unicast_frag_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &unicast_frag_packeth->orig);\r\nunicast_frag_packeth->seqno = tvb_get_ntohs(tvb, 18);\r\nsave_fragmented = pinfo->fragmented;\r\npinfo->fragmented = TRUE;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, UNICAST_FRAG_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. Unicast Fragment, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &unicast_frag_packeth->dest));\r\nbatadv_unicast_frag_tree = proto_item_add_subtree(ti, ett_batadv_unicast_frag);\r\n}\r\nproto_tree_add_uint_format(batadv_unicast_frag_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_UNICAST_FRAG_V12,\r\n"Packet Type: %s (%u)", "BATADV_UNICAST", BATADV_UNICAST_FRAG_V12);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_ttvn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_bitmask(batadv_unicast_frag_tree, tvb, offset, hf_batadv_unicast_frag_flags,\r\nett_batadv_batman_flags, unicast_frag_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_seqno, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_frag_packeth);\r\nhead = (unicast_frag_packeth->flags & 0x1);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining < 0)\r\nlength_remaining = 0;\r\nfrag_msg = fragment_add_seq_check(&msg_reassembly_table,\r\ntvb, offset,\r\npinfo, unicast_frag_packeth->seqno + head, NULL,\r\n1 - head,\r\nlength_remaining,\r\nhead);\r\nnew_tvb = process_reassembled_data(tvb, offset, pinfo,\r\n"Reassembled Message", frag_msg, &msg_frag_items,\r\nNULL, batadv_unicast_frag_tree);\r\nif (new_tvb) {\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, new_tvb);\r\n}\r\ncall_dissector(eth_handle, new_tvb, pinfo, tree);\r\n}\r\npinfo->fragmented = save_fragmented;\r\n}\r\nstatic void dissect_batadv_unicast_frag_v15(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nstruct unicast_frag_packet_v15 *unicast_frag_packeth;\r\ngboolean save_fragmented;\r\nfragment_head *frag_msg = NULL;\r\nproto_tree *batadv_unicast_frag_tree = NULL;\r\ntvbuff_t *new_tvb;\r\nint offset = 0;\r\nint frag_no = 0;\r\ngint length_remaining;\r\nunicast_frag_packeth = (struct unicast_frag_packet_v15 *)wmem_alloc(wmem_packet_scope(),\r\nsizeof(struct unicast_frag_packet_v15));\r\nsave_fragmented = pinfo->fragmented;\r\npinfo->fragmented = TRUE;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, 0,\r\nUNICAST_FRAG_PACKET_V15_SIZE,\r\n"B.A.T.M.A.N. Unicast Fragment, Dst: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 4));\r\nbatadv_unicast_frag_tree = proto_item_add_subtree(ti,\r\nett_batadv_unicast_frag);\r\n}\r\nunicast_frag_packeth->packet_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(batadv_unicast_frag_tree,\r\nhf_batadv_packet_type, tvb, offset, 1,\r\nunicast_frag_packeth->packet_type,\r\n"%s (%u)", "BATADV_UNICAST",\r\nunicast_frag_packeth->packet_type);\r\noffset += 1;\r\nunicast_frag_packeth->version = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_frag_tree,\r\nhf_batadv_unicast_frag_version, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nunicast_frag_packeth->ttl = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_frag_tree,\r\nhf_batadv_unicast_frag_ttl, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nunicast_frag_packeth->no = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_no,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nset_address_tvb(&unicast_frag_packeth->dest, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_frag_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_frag_packeth->dest);\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_dst,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&unicast_frag_packeth->orig, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_src, &unicast_frag_packeth->orig);\r\ncopy_address_shallow(&pinfo->src, &unicast_frag_packeth->orig);\r\nproto_tree_add_item(batadv_unicast_frag_tree, hf_batadv_unicast_frag_orig,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nunicast_frag_packeth->seqno = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_frag_tree,\r\nhf_batadv_unicast_frag_seqno, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nunicast_frag_packeth->total_size = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_frag_tree,\r\nhf_batadv_unicast_frag_total_size, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_frag_packeth);\r\nfrag_no = unicast_frag_packeth->no >> 4;\r\nif (frag_no > 1)\r\nreturn;\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\nif (length_remaining < 0)\r\nlength_remaining = 0;\r\nfrag_msg = fragment_add_seq_check(&msg_reassembly_table,\r\ntvb, offset, pinfo,\r\nunicast_frag_packeth->seqno, NULL,\r\n1 - frag_no, length_remaining, TRUE);\r\nfragment_set_tot_len(&msg_reassembly_table, pinfo,\r\nunicast_frag_packeth->seqno, NULL, 1);\r\nnew_tvb = process_reassembled_data(tvb, offset, pinfo,\r\n"Reassembled Message", frag_msg, &msg_frag_items,\r\nNULL, batadv_unicast_frag_tree);\r\nif (new_tvb) {\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, new_tvb);\r\n}\r\ncall_dissector(batman_handle, new_tvb, pinfo, tree);\r\n}\r\npinfo->fragmented = save_fragmented;\r\n}\r\nstatic void dissect_batadv_vis(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_VIS");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 6:\r\ncase 7:\r\ncase 8:\r\ncase 9:\r\ndissect_batadv_vis_v6(tvb, pinfo, tree);\r\nbreak;\r\ncase 10:\r\ncase 11:\r\ncase 12:\r\ncase 13:\r\ndissect_batadv_vis_v10(tvb, pinfo, tree);\r\nbreak;\r\ncase 14:\r\ndissect_batadv_vis_v14(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_vis_v6(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct vis_packet_v6 *vis_packeth;\r\nproto_tree *batadv_vis_tree = NULL;\r\ntvbuff_t *next_tvb;\r\nguint entry_size;\r\ngint length_remaining;\r\nint offset = 0, i;\r\nvis_packeth = (struct vis_packet_v6 *)wmem_alloc(wmem_packet_scope(), sizeof(struct vis_packet_v6));\r\nvis_packeth->version = tvb_get_guint8(tvb, 1);\r\nvis_packeth->vis_type = tvb_get_guint8(tvb, 2);\r\nvis_packeth->seqno = tvb_get_guint8(tvb, 3);\r\nvis_packeth->entries = tvb_get_guint8(tvb, 4);\r\nvis_packeth->ttl = tvb_get_guint8(tvb, 5);\r\nset_address_tvb(&vis_packeth->vis_orig, AT_ETHER, 6, tvb, 6);\r\ncopy_address_shallow(&pinfo->src, &vis_packeth->vis_orig);\r\nset_address_tvb(&vis_packeth->target_orig, AT_ETHER, 6, tvb, 12);\r\ncopy_address_shallow(&pinfo->dl_dst, &vis_packeth->target_orig);\r\ncopy_address_shallow(&pinfo->dst, &vis_packeth->target_orig);\r\nset_address_tvb(&vis_packeth->sender_orig, AT_ETHER, 6, tvb, 18);\r\ncopy_address_shallow(&pinfo->dl_src, &vis_packeth->sender_orig);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(vis_packeth->vis_type, vis_packettypenames, "Unknown (0x%02x)"),\r\nvis_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, VIS_PACKET_V6_SIZE,\r\n"B.A.T.M.A.N. Vis, Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &vis_packeth->vis_orig));\r\nbatadv_vis_tree = proto_item_add_subtree(ti, ett_batadv_vis);\r\n}\r\nproto_tree_add_uint_format(batadv_vis_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_VIS_V5,\r\n"Packet Type: %s (%u)", "BATADV_VIS", BATADV_VIS_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_seqno, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_entries, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_vis_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_target_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_sender_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntap_queue_packet(batadv_tap, pinfo, vis_packeth);\r\nswitch (vis_packeth->version) {\r\ncase 6:\r\ncase 7:\r\nentry_size = VIS_ENTRY_V6_SIZE;\r\nbreak;\r\ndefault:\r\ncase 8:\r\ncase 9:\r\nentry_size = VIS_ENTRY_V8_SIZE;\r\nbreak;\r\n}\r\nfor (i = 0; i < vis_packeth->entries; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, entry_size);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\nif (batadv_vis_tree != NULL) {\r\nswitch (vis_packeth->version) {\r\ncase 6:\r\ncase 7:\r\ndissect_vis_entry_v6(next_tvb, pinfo, batadv_vis_tree);\r\nbreak;\r\ndefault:\r\ncase 8:\r\ncase 9:\r\ndissect_vis_entry_v8(next_tvb, pinfo, batadv_vis_tree);\r\nbreak;\r\n}\r\n}\r\noffset += entry_size;\r\n}\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_vis_v10(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct vis_packet_v10 *vis_packeth;\r\nproto_tree *batadv_vis_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0, i;\r\nvis_packeth = (struct vis_packet_v10 *)wmem_alloc(wmem_packet_scope(), sizeof(struct vis_packet_v10));\r\nvis_packeth->version = tvb_get_guint8(tvb, 1);\r\nvis_packeth->vis_type = tvb_get_guint8(tvb, 2);\r\nvis_packeth->entries = tvb_get_guint8(tvb, 3);\r\nvis_packeth->seqno = tvb_get_ntohl(tvb, 4);\r\nvis_packeth->ttl = tvb_get_guint8(tvb, 8);\r\nset_address_tvb(&vis_packeth->vis_orig, AT_ETHER, 6, tvb, 9);\r\ncopy_address_shallow(&pinfo->src, &vis_packeth->vis_orig);\r\nset_address_tvb(&vis_packeth->target_orig, AT_ETHER, 6, tvb, 15);\r\ncopy_address_shallow(&pinfo->dl_dst, &vis_packeth->target_orig);\r\ncopy_address_shallow(&pinfo->dst, &vis_packeth->target_orig);\r\nset_address_tvb(&vis_packeth->sender_orig, AT_ETHER, 6, tvb, 21);\r\ncopy_address_shallow(&pinfo->dl_src, &vis_packeth->sender_orig);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(vis_packeth->vis_type, vis_packettypenames, "Unknown (0x%02x)"),\r\nvis_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, VIS_PACKET_V10_SIZE,\r\n"B.A.T.M.A.N. Vis, Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &vis_packeth->vis_orig));\r\nbatadv_vis_tree = proto_item_add_subtree(ti, ett_batadv_vis);\r\n}\r\nproto_tree_add_uint_format(batadv_vis_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_VIS_V5,\r\n"Packet Type: %s (%u)", "BATADV_VIS", BATADV_VIS_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_entries, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_vis_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_target_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_sender_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntap_queue_packet(batadv_tap, pinfo, vis_packeth);\r\nfor (i = 0; i < vis_packeth->entries; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, VIS_ENTRY_V8_SIZE);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_vis_entry_v8(next_tvb, pinfo, batadv_vis_tree);\r\noffset += VIS_ENTRY_V8_SIZE;\r\n}\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_vis_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct vis_packet_v14 *vis_packeth;\r\nproto_tree *batadv_vis_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0, i;\r\nvis_packeth = (struct vis_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct vis_packet_v14));\r\nvis_packeth->version = tvb_get_guint8(tvb, 1);\r\nvis_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nvis_packeth->vis_type = tvb_get_guint8(tvb, 3);\r\nvis_packeth->seqno = tvb_get_ntohl(tvb, 4);\r\nvis_packeth->entries = tvb_get_guint8(tvb, 8);\r\nvis_packeth->reserved = tvb_get_guint8(tvb, 9);\r\nset_address_tvb(&vis_packeth->vis_orig, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->src, &vis_packeth->vis_orig);\r\nset_address_tvb(&vis_packeth->target_orig, AT_ETHER, 6, tvb, 16);\r\ncopy_address_shallow(&pinfo->dl_dst, &vis_packeth->target_orig);\r\ncopy_address_shallow(&pinfo->dst, &vis_packeth->target_orig);\r\nset_address_tvb(&vis_packeth->sender_orig, AT_ETHER, 6, tvb, 22);\r\ncopy_address_shallow(&pinfo->dl_src, &vis_packeth->sender_orig);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "[%s] Seq=%u",\r\nval_to_str(vis_packeth->vis_type, vis_packettypenames, "Unknown (0x%02x)"),\r\nvis_packeth->seqno);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, VIS_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. Vis, Orig: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &vis_packeth->vis_orig));\r\nbatadv_vis_tree = proto_item_add_subtree(ti, ett_batadv_vis);\r\n}\r\nproto_tree_add_uint_format(batadv_vis_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_VIS_V5,\r\n"Packet Type: %s (%u)", "BATADV_VIS", BATADV_VIS_V5);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_seqno32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_entries, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_vis_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_target_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_vis_tree, hf_batadv_vis_sender_orig, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntap_queue_packet(batadv_tap, pinfo, vis_packeth);\r\nfor (i = 0; i < vis_packeth->entries; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, VIS_ENTRY_V8_SIZE);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_vis_entry_v8(next_tvb, pinfo, batadv_vis_tree);\r\noffset += VIS_ENTRY_V8_SIZE;\r\n}\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_vis_entry_v6(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *batadv_vis_entry_tree;\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, VIS_ENTRY_V6_SIZE,\r\n"VIS Entry: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 0));\r\nbatadv_vis_entry_tree = proto_item_add_subtree(ti, ett_batadv_vis_entry);\r\nproto_tree_add_item(batadv_vis_entry_tree, hf_batadv_vis_entry_dst, tvb, 0, 6, ENC_NA);\r\nproto_tree_add_item(batadv_vis_entry_tree, hf_batadv_vis_entry_quality, tvb, 6, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void dissect_vis_entry_v8(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *batadv_vis_entry_tree;\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, VIS_ENTRY_V8_SIZE,\r\n"VIS Entry: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 6));\r\nbatadv_vis_entry_tree = proto_item_add_subtree(ti, ett_batadv_vis_entry);\r\nproto_tree_add_item(batadv_vis_entry_tree, hf_batadv_vis_entry_src, tvb, 0, 6, ENC_NA);\r\nproto_tree_add_item(batadv_vis_entry_tree, hf_batadv_vis_entry_dst, tvb, 6, 6, ENC_NA);\r\nproto_tree_add_item(batadv_vis_entry_tree, hf_batadv_vis_entry_quality, tvb, 12, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void dissect_batadv_tt_query(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_TT_QUERY");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 14:\r\ndissect_batadv_tt_query_v14(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_tt_query_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct tt_query_packet_v14 *tt_query_packeth;\r\nproto_tree *batadv_tt_query_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0, i;\r\nint tt_type;\r\ntt_query_packeth = (struct tt_query_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct tt_query_packet_v14));\r\ntt_query_packeth->version = tvb_get_guint8(tvb, 1);\r\ntt_query_packeth->ttl = tvb_get_guint8(tvb, 2);\r\ntt_query_packeth->flags = tvb_get_guint8(tvb, 3);\r\nset_address_tvb(&tt_query_packeth->dst, AT_ETHER, 6, tvb, 4);\r\ncopy_address_shallow(&pinfo->dl_dst, &tt_query_packeth->dst);\r\ncopy_address_shallow(&pinfo->dst, &tt_query_packeth->dst);\r\nset_address_tvb(&tt_query_packeth->src, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->dl_src, &tt_query_packeth->src);\r\ncopy_address_shallow(&pinfo->src, &tt_query_packeth->src);\r\ntt_query_packeth->ttvn = tvb_get_guint8(tvb, 16);\r\ntt_query_packeth->tt_data = tvb_get_ntohs(tvb, 17);\r\ntt_type = TT_TYPE_MASK & tt_query_packeth->flags;\r\nswitch (tt_type) {\r\ncase TT_REQUEST:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Request=%u", tt_query_packeth->ttvn);\r\nbreak;\r\ncase TT_RESPONSE:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Response=%u", tt_query_packeth->ttvn);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Type %u", tt_type);\r\nbreak;\r\n}\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, TT_QUERY_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. TT Query, Dst: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &tt_query_packeth->dst));\r\nbatadv_tt_query_tree = proto_item_add_subtree(ti, ett_batadv_tt_query);\r\n}\r\nproto_tree_add_uint_format(batadv_tt_query_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_TT_QUERY_V14,\r\n"Packet Type: %s (%u)", "BATADV_TT_QUERY", BATADV_TT_QUERY_V14);\r\noffset += 1;\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_bitmask(batadv_tt_query_tree, tvb, offset, hf_batadv_tt_query_flags,\r\nett_batadv_tt_query_flags, tt_query_flags, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_src, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_ttvn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (tt_type) {\r\ncase TT_REQUEST:\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_tt_crc, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase TT_RESPONSE:\r\nproto_tree_add_item(batadv_tt_query_tree, hf_batadv_tt_query_entries, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, tt_query_packeth);\r\nif (tt_type == TT_RESPONSE) {\r\nfor (i = 0; i < tt_query_packeth->tt_data; i++) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, TT_ENTRY_V14_SIZE);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_tt_entry_v14(next_tvb, pinfo, batadv_tt_query_tree);\r\noffset += TT_ENTRY_V14_SIZE;\r\n}\r\n}\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_tt_entry_v14(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *batadv_tt_entry_tree;\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, TT_ENTRY_V14_SIZE,\r\n"TT Entry: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 1));\r\nbatadv_tt_entry_tree = proto_item_add_subtree(ti, ett_batadv_tt_entry);\r\nproto_tree_add_bitmask(batadv_tt_entry_tree, tvb, 0, hf_batadv_tt_entry_flags,\r\nett_batadv_tt_entry_flags, tt_entry_flags, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(batadv_tt_entry_tree, hf_batadv_tt_entry, tvb, 1, 6, ENC_NA);\r\n}\r\nstatic void dissect_batadv_roam_adv(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_ROAM_ADV");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 14:\r\ndissect_batadv_roam_adv_v14(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_roam_adv_v14(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nstruct roam_adv_packet_v14 *roam_adv_packeth;\r\nproto_tree *batadv_roam_adv_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\nroam_adv_packeth = (struct roam_adv_packet_v14 *)wmem_alloc(wmem_packet_scope(), sizeof(struct roam_adv_packet_v14));\r\nroam_adv_packeth->version = tvb_get_guint8(tvb, 1);\r\nroam_adv_packeth->ttl = tvb_get_guint8(tvb, 2);\r\nset_address_tvb(&roam_adv_packeth->dst, AT_ETHER, 6, tvb, 4);\r\ncopy_address_shallow(&pinfo->dl_dst, &roam_adv_packeth->dst);\r\ncopy_address_shallow(&pinfo->dst, &roam_adv_packeth->dst);\r\nset_address_tvb(&roam_adv_packeth->src, AT_ETHER, 6, tvb, 10);\r\ncopy_address_shallow(&pinfo->dl_src, &roam_adv_packeth->src);\r\ncopy_address_shallow(&pinfo->src, &roam_adv_packeth->src);\r\nset_address_tvb(&roam_adv_packeth->client, AT_ETHER, 6, tvb, 16);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Client %s", address_with_resolution_to_str(wmem_packet_scope(), &roam_adv_packeth->client));\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin, tvb, 0, ROAM_ADV_PACKET_V14_SIZE,\r\n"B.A.T.M.A.N. Roam: %s",\r\naddress_with_resolution_to_str(wmem_packet_scope(), &roam_adv_packeth->client));\r\nbatadv_roam_adv_tree = proto_item_add_subtree(ti, ett_batadv_roam_adv);\r\n}\r\nproto_tree_add_uint_format(batadv_roam_adv_tree, hf_batadv_packet_type, tvb, offset, 1, BATADV_ROAM_ADV_V14,\r\n"Packet Type: %s (%u)", "BATADV_ROAM_ADV", BATADV_ROAM_ADV_V14);\r\noffset += 1;\r\nproto_tree_add_item(batadv_roam_adv_tree, hf_batadv_roam_adv_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(batadv_roam_adv_tree, hf_batadv_roam_adv_ttl, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nproto_tree_add_item(batadv_roam_adv_tree, hf_batadv_roam_adv_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_roam_adv_tree, hf_batadv_roam_adv_src, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(batadv_roam_adv_tree, hf_batadv_roam_adv_client, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ntap_queue_packet(batadv_tap, pinfo, roam_adv_packeth);\r\nlength_remaining = tvb_reported_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_coded(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_CODED");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 15:\r\ndissect_batadv_coded_v15(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d", version);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_coded_v15(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nstruct coded_packet_v15 *coded_packeth;\r\nproto_tree *batadv_coded_tree = NULL;\r\ntvbuff_t *next_tvb;\r\ngint length_remaining;\r\nint offset = 0;\r\ncoded_packeth = (struct coded_packet_v15 *)wmem_alloc(wmem_packet_scope(),\r\nsizeof(struct coded_packet_v15));\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, 0,\r\nCODED_PACKET_V15_SIZE,\r\n"B.A.T.M.A.N. Coded");\r\nbatadv_coded_tree = proto_item_add_subtree(ti, ett_batadv_coded);\r\n}\r\ncoded_packeth->packet_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(batadv_coded_tree,\r\nhf_batadv_packet_type,\r\ntvb, offset, 1,\r\ncoded_packeth->packet_type,\r\n"%s (%u)", "BATADV_CODED",\r\ncoded_packeth->packet_type);\r\noffset += 1;\r\ncoded_packeth->version = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_version, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncoded_packeth->ttl = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_ttl, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncoded_packeth->first_ttvn = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_first_ttvn, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nset_address_tvb(&coded_packeth->first_source, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_src, &coded_packeth->first_source);\r\ncopy_address_shallow(&pinfo->src, &coded_packeth->first_source);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_first_source,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&coded_packeth->first_orig_dest, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_dst, &coded_packeth->first_orig_dest);\r\ncopy_address_shallow(&pinfo->dst, &coded_packeth->first_orig_dest);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_first_orig_dest,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ncoded_packeth->first_crc = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_first_crc, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ncoded_packeth->second_ttl = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_second_ttl, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncoded_packeth->second_ttvn = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_second_ttvn, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nset_address_tvb(&coded_packeth->second_dest, AT_ETHER, 6, tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_second_dest,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&coded_packeth->second_source, AT_ETHER, 6, tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_second_source,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&coded_packeth->second_orig_dest, AT_ETHER, 6, tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_second_orig_dest,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\ncoded_packeth->second_crc = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_second_crc, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ncoded_packeth->coded_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(batadv_coded_tree, hf_batadv_coded_coded_len, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, coded_packeth);\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\nif (length_remaining > 0) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_tvlv(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 version;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BATADV_UNICAST_TVLV");\r\nversion = tvb_get_guint8(tvb, 1);\r\nswitch (version) {\r\ncase 15:\r\ndissect_batadv_unicast_tvlv_v15(tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsupported Version %d",\r\nversion);\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_batadv_unicast_tvlv_v15(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nstruct unicast_tvlv_packet_v15 *unicast_tvlv_packeth;\r\ntvbuff_t *next_tvb;\r\nint offset = 0;\r\nproto_tree *batadv_unicast_tvlv_tree = NULL;\r\nunicast_tvlv_packeth = (struct unicast_tvlv_packet_v15 *)wmem_alloc(wmem_packet_scope(),\r\nsizeof(struct unicast_tvlv_packet_v15));\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti;\r\nunicast_tvlv_packeth->tvlv_len = tvb_get_ntohs(tvb, 16);\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, 0,\r\nUNICAST_TVLV_PACKET_V15_SIZE + unicast_tvlv_packeth->tvlv_len,\r\n"B.A.T.M.A.N. Unicast TVLV, Src: %s Dst: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 10),\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, 4));\r\nbatadv_unicast_tvlv_tree = proto_item_add_subtree(ti, ett_batadv_unicast_tvlv);\r\n}\r\nunicast_tvlv_packeth->packet_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(batadv_unicast_tvlv_tree,\r\nhf_batadv_packet_type, tvb, offset, 1,\r\nunicast_tvlv_packeth->packet_type,\r\n"%s (%u)", "BATADV_UNICAST_TVLV",\r\nunicast_tvlv_packeth->packet_type);\r\noffset += 1;\r\nunicast_tvlv_packeth->version = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_tvlv_tree,\r\nhf_batadv_unicast_tvlv_version, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nunicast_tvlv_packeth->ttl = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_tvlv_tree,\r\nhf_batadv_unicast_tvlv_ttl, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nset_address_tvb(&unicast_tvlv_packeth->dest, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_dst, &unicast_tvlv_packeth->dest);\r\ncopy_address_shallow(&pinfo->dst, &unicast_tvlv_packeth->dest);\r\nproto_tree_add_item(batadv_unicast_tvlv_tree, hf_batadv_unicast_tvlv_dst,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nset_address_tvb(&unicast_tvlv_packeth->src, AT_ETHER, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dl_src, &unicast_tvlv_packeth->src);\r\ncopy_address_shallow(&pinfo->src, &unicast_tvlv_packeth->src);\r\nproto_tree_add_item(batadv_unicast_tvlv_tree, hf_batadv_unicast_tvlv_src,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nunicast_tvlv_packeth->tvlv_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(batadv_unicast_tvlv_tree,\r\nhf_batadv_unicast_tvlv_len, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += 2;\r\ntap_queue_packet(batadv_tap, pinfo, unicast_tvlv_packeth);\r\nif (unicast_tvlv_packeth->tvlv_len > 0) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset,\r\nunicast_tvlv_packeth->tvlv_len);\r\nif (have_tap_listener(batadv_follow_tap)) {\r\ntap_queue_packet(batadv_follow_tap, pinfo, next_tvb);\r\n}\r\ndissect_batadv_tvlv_v15(next_tvb, pinfo,\r\nbatadv_unicast_tvlv_tree);\r\n}\r\n}\r\nstatic void dissect_batadv_tvlv_v15(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nguint8 type, version;\r\nguint16 length;\r\nint offset = 0;\r\ntvbuff_t *next_tvb;\r\nproto_tree *batadv_tvlv_tree = NULL;\r\nwhile (offset != -1 && tvb_captured_length_remaining(tvb, offset) >= 4) {\r\ntype = tvb_get_guint8(tvb, offset + 0);\r\nversion = tvb_get_guint8(tvb, offset + 1);\r\nlength = tvb_get_ntohs(tvb, offset + 2) + 4;\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree,\r\nproto_batadv_plugin,\r\nnext_tvb, 0, length,\r\n"TVLV, %s",\r\nval_to_str(type,\r\ntvlv_v15_typenames,\r\n"Unknown (0x%02x)"));\r\nbatadv_tvlv_tree = proto_item_add_subtree(ti, ett_batadv_tvlv);\r\n}\r\ndissect_batadv_tvlv_v15_header(next_tvb, pinfo,\r\nbatadv_tvlv_tree, type);\r\nswitch (type) {\r\ncase BATADV_TVLV_V15_GW:\r\ndissect_batadv_tvlv_v15_gw(next_tvb, pinfo,\r\nbatadv_tvlv_tree, 4,\r\nversion);\r\nbreak;\r\ncase BATADV_TVLV_V15_DAT:\r\ndissect_batadv_tvlv_v15_dat(next_tvb, pinfo,\r\nbatadv_tvlv_tree, 4,\r\nversion);\r\nbreak;\r\ncase BATADV_TVLV_V15_NC:\r\ndissect_batadv_tvlv_v15_nc(next_tvb, pinfo,\r\nbatadv_tvlv_tree, 4,\r\nversion);\r\nbreak;\r\ncase BATADV_TVLV_V15_TT:\r\ndissect_batadv_tvlv_v15_tt(next_tvb, pinfo,\r\nbatadv_tvlv_tree, 4,\r\nversion);\r\nbreak;\r\ncase BATADV_TVLV_V15_ROAM:\r\ndissect_batadv_tvlv_v15_roam(next_tvb, pinfo,\r\nbatadv_tvlv_tree, 4,\r\nversion);\r\nbreak;\r\ncase BATADV_TVLV_V15_MCAST:\r\ndissect_batadv_tvlv_v15_mcast(next_tvb, pinfo,\r\nbatadv_tvlv_tree, 4,\r\nversion);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(next_tvb, pinfo,\r\nbatadv_tvlv_tree);\r\nbreak;\r\n}\r\noffset += length;\r\n}\r\n}\r\nstatic void dissect_batadv_tvlv_v15_header(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree, guint8 type)\r\n{\r\nint offset = 0;\r\nproto_tree_add_uint_format_value(tree, hf_batadv_tvlv_type, tvb, offset,\r\n1, type, "%s",\r\nval_to_str(type, tvlv_v15_typenames,\r\n"Unknown (0x%02x)"));\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_batadv_tvlv_version, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_batadv_tvlv_len, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\n}\r\nstatic void dissect_batadv_tvlv_v15_dat(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, int offset,\r\nguint8 version)\r\n{\r\nif (version != 0x01) {\r\nproto_tree_add_expert_format(\r\ntree, pinfo, &ei_batadv_tvlv_unknown_version, tvb,\r\noffset, 0, "Unknown version (0x%02x)", version);\r\nreturn;\r\n}\r\n}\r\nstatic void dissect_batadv_tvlv_v15_nc(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, int offset,\r\nguint8 version)\r\n{\r\nif (version != 0x01) {\r\nproto_tree_add_expert_format(\r\ntree, pinfo, &ei_batadv_tvlv_unknown_version, tvb,\r\noffset, 0, "Unknown version (0x%02x)", version);\r\nreturn;\r\n}\r\n}\r\nstatic void dissect_batadv_tvlv_v15_mcast(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, int offset,\r\nguint8 version)\r\n{\r\nstatic const int * flags[] = {\r\n&hf_batadv_tvlv_mcast_flags_unsnoopables,\r\n&hf_batadv_tvlv_mcast_flags_ipv4,\r\n&hf_batadv_tvlv_mcast_flags_ipv6,\r\nNULL\r\n};\r\nif (version != 0x01) {\r\nproto_tree_add_expert_format(\r\ntree, pinfo, &ei_batadv_tvlv_unknown_version, tvb,\r\noffset, 0, "Unknown version (0x%02x)", version);\r\nreturn;\r\n}\r\nproto_tree_add_bitmask(tree, tvb, offset, hf_batadv_iv_ogm_flags,\r\nett_batadv_tvlv_mcast_flags, flags, ENC_NA);\r\n}\r\nstatic void dissect_batadv_tvlv_v15_gw(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, int offset,\r\nguint8 version)\r\n{\r\nguint32 down, up;\r\nif (version != 0x01) {\r\nproto_tree_add_expert_format(\r\ntree, pinfo, &ei_batadv_tvlv_unknown_version, tvb,\r\noffset, 0, "Unknown version (0x%02x)", version);\r\nreturn;\r\n}\r\ndown = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format_value(tree, hf_batadv_tvlv_gw_download,\r\ntvb, offset, 4, down, "%u.%uMbit",\r\ndown / 10, down % 10);\r\noffset += 4;\r\nup = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint_format_value(tree, hf_batadv_tvlv_gw_upload, tvb,\r\noffset, 4, up, "%u.%uMbit",\r\nup / 10, up % 10);\r\n}\r\nstatic void dissect_batadv_tvlv_v15_roam(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, int offset,\r\nguint8 version)\r\n{\r\nstatic const int * flags[] = {\r\n&hf_batadv_tvlv_vid_vlan,\r\n&hf_batadv_tvlv_vid_tagged,\r\nNULL\r\n};\r\nif (version != 0x01) {\r\nproto_tree_add_expert_format(\r\ntree, pinfo, &ei_batadv_tvlv_unknown_version, tvb,\r\noffset, 0, "Unknown version (0x%02x)", version);\r\nreturn;\r\n}\r\nproto_tree_add_item(tree, hf_batadv_tvlv_roam_addr, tvb, offset, 6,\r\nENC_NA);\r\noffset += 6;\r\nproto_tree_add_bitmask(tree, tvb, offset, hf_batadv_tvlv_roam_vid,\r\nett_batadv_tvlv_vid, flags, ENC_NA);\r\n}\r\nstatic void dissect_batadv_tvlv_v15_tt(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, int offset,\r\nguint8 version)\r\n{\r\nguint16 num_vlan;\r\nint i;\r\ngint length_remaining;\r\nstatic const int * flags[] = {\r\n&hf_batadv_tvlv_tt_flags_type,\r\n&hf_batadv_tvlv_tt_flags_full_table,\r\nNULL\r\n};\r\nif (version != 0x01) {\r\nproto_tree_add_expert_format(\r\ntree, pinfo, &ei_batadv_tvlv_unknown_version, tvb,\r\noffset, 0, "Unknown version (0x%02x)", version);\r\nreturn;\r\n}\r\nproto_tree_add_bitmask(tree, tvb, offset, hf_batadv_tvlv_tt_flags,\r\nett_batadv_tvlv_tt_flags, flags, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_batadv_tvlv_tt_ttvn, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nnum_vlan = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_batadv_tvlv_tt_num_vlan, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nfor (i = 0; i < num_vlan; i++)\r\noffset = dissect_batadv_tvlv_v15_tt_vlan(tvb, pinfo, tree,\r\noffset);\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\nwhile (length_remaining > 0) {\r\noffset = dissect_batadv_tvlv_v15_tt_change(tvb, pinfo, tree,\r\noffset);\r\nlength_remaining = tvb_captured_length_remaining(tvb, offset);\r\n}\r\n}\r\nstatic int dissect_batadv_tvlv_v15_tt_vlan(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree, int offset)\r\n{\r\nproto_tree *vlan_tree = NULL;\r\nguint16 vid;\r\nstatic const int * flags[] = {\r\n&hf_batadv_tvlv_vid_vlan,\r\n&hf_batadv_tvlv_vid_tagged,\r\nNULL\r\n};\r\nvid = tvb_get_ntohs(tvb, offset + 4);\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, offset, 8,\r\n"VLAN, %04x", vid);\r\nvlan_tree = proto_item_add_subtree(ti, ett_batadv_tvlv_tt_vlan);\r\n}\r\nproto_tree_add_item(vlan_tree, hf_batadv_tvlv_tt_vlan_crc, tvb, offset,\r\n4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_bitmask(vlan_tree, tvb, offset,\r\nhf_batadv_tvlv_tt_vlan_vid,\r\nett_batadv_tvlv_vid, flags, ENC_NA);\r\noffset += 2;\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic int dissect_batadv_tvlv_v15_tt_change(tvbuff_t *tvb,\r\npacket_info *pinfo _U_,\r\nproto_tree *tree, int offset)\r\n{\r\nproto_tree *change_tree = NULL;\r\nstatic const int * flags[] = {\r\n&hf_batadv_tvlv_tt_change_flags_del,\r\n&hf_batadv_tvlv_tt_change_flags_roam,\r\n&hf_batadv_tvlv_tt_change_flags_wifi,\r\n&hf_batadv_tvlv_tt_change_flags_isolate,\r\nNULL\r\n};\r\nstatic const int * flags_vlan[] = {\r\n&hf_batadv_tvlv_vid_vlan,\r\n&hf_batadv_tvlv_vid_tagged,\r\nNULL\r\n};\r\nif (tree) {\r\nproto_item *ti;\r\nti = proto_tree_add_protocol_format(tree, proto_batadv_plugin,\r\ntvb, offset, 12,\r\n"Entry, %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, offset + 4));\r\nchange_tree = proto_item_add_subtree(ti, ett_batadv_tvlv_tt_change);\r\n}\r\nproto_tree_add_bitmask(change_tree, tvb, offset,\r\nhf_batadv_tvlv_tt_change_flags,\r\nett_batadv_batman_flags, flags, ENC_NA);\r\noffset += 1;\r\noffset += 3;\r\nproto_tree_add_item(change_tree, hf_batadv_tvlv_tt_change_addr, tvb,\r\noffset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_bitmask(change_tree, tvb, offset,\r\nhf_batadv_tvlv_tt_change_vid,\r\nett_batadv_tvlv_vid, flags_vlan, ENC_NA);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic void batadv_init_routine(void)\r\n{\r\nreassembly_table_init(&msg_reassembly_table,\r\n&addresses_reassembly_table_functions);\r\n}\r\nstatic void batadv_cleanup_routine(void)\r\n{\r\nreassembly_table_destroy(&msg_reassembly_table);\r\n}\r\nvoid proto_register_batadv(void)\r\n{\r\nmodule_t *batadv_module;\r\nexpert_module_t* expert_batadv;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_batadv_packet_type,\r\n{ "Packet Type", "batadv.batman.packet_type",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_version,\r\n{ "Version", "batadv.batman.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_flags,\r\n{ "Flags", "batadv.batman.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_ttl,\r\n{ "Time to Live", "batadv.batman.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_gwflags,\r\n{ "Gateway Flags", "batadv.batman.gwflags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_gwflags_dl_speed,\r\n{ "Download Speed", "batadv.batman.gwflags.dl_speed",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_gwflags_ul_speed,\r\n{ "Upload Speed", "batadv.batman.gwflags.ul_speed",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_tq,\r\n{ "Transmission Quality", "batadv.batman.tq",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_seqno,\r\n{ "Sequence number", "batadv.batman.seq",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_seqno32,\r\n{ "Sequence number", "batadv.batman.seq",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_orig,\r\n{ "Originator", "batadv.batman.orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_prev_sender,\r\n{ "Received from", "batadv.batman.prev_sender",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_num_tt,\r\n{ "Number of TTs", "batadv.batman.num_tt",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_tt_num_changes,\r\n{ "Number of TT Changes", "batadv.batman.tt_num_changes",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_ttvn,\r\n{ "TT Version", "batadv.batman.ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_tt_crc,\r\n{ "CRC of TT", "batadv.batman.tt_crc",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_flags_directlink,\r\n{ "DirectLink", "batadv.batman.flags.directlink",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_flags_vis_server,\r\n{ "VIS_SERVER", "batadv.batman.flags.vis_server",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_flags_primaries_first_hop,\r\n{ "PRIMARIES_FIRST_HOP", "batadv.batman.flags.primaries_first_hop",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_flags_not_best_next_hop,\r\n{ "NOT_BEST_NEXT_HOP", "batadv.batman.flags.not_best_next_hop",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x8,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_version,\r\n{ "Version", "batadv.iv_ogm.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_ttl,\r\n{ "Time to Live", "batadv.iv_ogm.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_flags,\r\n{ "Flags", "batadv.iv_ogm.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_seqno,\r\n{ "Sequence number", "batadv.iv_ogm.seq",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_orig,\r\n{ "Originator", "batadv.iv_ogm.orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_prev_sender,\r\n{ "Received from", "batadv.iv_ogm.prev_sender",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_tq,\r\n{ "Transmission Quality", "batadv.iv_ogm.tq",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_tvlv_len,\r\n{ "Length of TVLV", "batadv.iv_ogm.tvlv_len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_flags_not_best_next_hop,\r\n{ "NOT_BEST_NEXT_HOP", "batadv.iv_ogm.flags.not_best_next_hop",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x1,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_flags_primaries_first_hop,\r\n{ "PRIMARIES_FIRST_HOP", "batadv.iv_ogm.flags.primaries_first_hop",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x2,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_iv_ogm_flags_directlink,\r\n{ "DirectLink", "batadv.iv_ogm.flags.directlink",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x4,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_batman_tt,\r\n{ "Translation Table", "batadv.batman.tt",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_bcast_version,\r\n{ "Version", "batadv.bcast.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_bcast_orig,\r\n{ "Originator", "batadv.bcast.orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_bcast_seqno,\r\n{ "Sequence number", "batadv.bcast.seq",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_bcast_seqno32,\r\n{ "Sequence number", "batadv.bcast.seq",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_bcast_ttl,\r\n{ "Time to Live", "batadv.bcast.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_icmp_version,\r\n{ "Version", "batadv.icmp.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_icmp_msg_type,\r\n{ "Message Type", "batadv.icmp.msg_type",\r\nFT_UINT8, BASE_DEC, VALS(icmp_packettypenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_icmp_dst,\r\n{ "Destination", "batadv.icmp.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_icmp_orig,\r\n{ "Originator", "batadv.icmp.orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_icmp_ttl,\r\n{ "Time to Live", "batadv.icmp.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_icmp_uid,\r\n{ "UID", "batadv.icmp.uid",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_icmp_seqno,\r\n{ "Sequence number", "batadv.icmp.seq",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_icmp_rr_pointer,\r\n{ "Pointer", "batadv.icmp.rr_pointer",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_icmp_rr_ether,\r\n{ "RR MAC", "batadv.icmp.rr_ether",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_unicast_version,\r\n{ "Version", "batadv.unicast.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_dst,\r\n{ "Destination", "batadv.unicast.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_ttl,\r\n{ "Time to Live", "batadv.unicast.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_ttvn,\r\n{ "TT Version", "batadv.unicast.ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_4addr_version,\r\n{ "Version", "batadv.unicast_4addr.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_4addr_dst,\r\n{ "Destination", "batadv.unicast_4addr.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_4addr_ttl,\r\n{ "Time to Live", "batadv.unicast_4addr.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_4addr_ttvn,\r\n{ "TT Version", "batadv.unicast_4addr.ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_4addr_src,\r\n{ "Source", "batadv.unicast_4addr.src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_4addr_subtype,\r\n{ "Subtype", "batadv.unicast_4addr.subtype",\r\nFT_UINT8, BASE_DEC, VALS (unicast_4addr_typenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_version,\r\n{ "Version", "batadv.unicast_frag.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_dst,\r\n{ "Destination", "batadv.unicast_frag.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_ttl,\r\n{ "Time to Live", "batadv.unicast_frag.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_ttvn,\r\n{ "TT Version", "batadv.unicast_frag.ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_flags,\r\n{ "Flags", "batadv.unicast_frag.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_flags_head,\r\n{ "Head", "batadv.unicast_frag.flags.head",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_flags_largetail,\r\n{ "Largetail", "batadv.unicast_frag.flags.largetail",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_orig,\r\n{ "Originator", "batadv.unicast_frag.orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_seqno,\r\n{ "Sequence number", "batadv.unicast_frag.seq",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_no,\r\n{ "Fragment number", "batadv.unicast_frag.no",\r\nFT_UINT8, BASE_DEC, NULL, 0xF0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_frag_total_size,\r\n{ "Complete Size", "batadv.unicast_frag.total_size",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_tvlv_version,\r\n{ "Version", "batadv.unicast_tvlv.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_tvlv_ttl,\r\n{ "Time to Live", "batadv.unicast_tvlv.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_tvlv_dst,\r\n{ "Destination", "batadv.unicast_tvlv.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_tvlv_src,\r\n{ "Destination", "batadv.unicast_tvlv.src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_unicast_tvlv_len,\r\n{ "Length of TVLV", "batadv.unicast_tvlv.len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_version,\r\n{ "Version", "batadv.vis.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_type,\r\n{ "Type", "batadv.vis.type",\r\nFT_UINT8, BASE_DEC, VALS(vis_packettypenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_seqno,\r\n{ "Sequence number", "batadv.vis.seq",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_vis_seqno32,\r\n{ "Sequence number", "batadv.vis.seq",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_vis_entries,\r\n{ "Entries", "batadv.vis.entries",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Number of entries", HFILL}\r\n},\r\n{ &hf_batadv_vis_ttl,\r\n{ "Time to Live", "batadv.vis.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_vis_vis_orig,\r\n{ "Originator", "batadv.vis.vis_orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_target_orig,\r\n{ "Target Originator", "batadv.vis.target_orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_sender_orig,\r\n{ "Forwarding Originator", "batadv.vis.sender_orig",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_entry_src,\r\n{ "Source", "batadv.vis.src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_entry_dst,\r\n{ "Destination", "batadv.vis.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_vis_entry_quality,\r\n{ "Quality", "batadv.vis.quality",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_version,\r\n{ "Version", "batadv.tt_query.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_ttl,\r\n{ "Time to Live", "batadv.tt_query.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_tt_query_flags,\r\n{ "Flags", "batadv.tt_query.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_flags_type,\r\n{ "Query Type", "batadv.tt_query.flags.type",\r\nFT_UINT8, BASE_HEX, VALS (tt_query_type_v14), TT_TYPE_MASK,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_flags_full_table,\r\n{ "Full Table", "batadv.tt_query.flags.full_table",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), TT_FULL_TABLE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_dst,\r\n{ "Destination", "batadv.tt_query.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_src,\r\n{ "Source", "batadv.tt_query.src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_ttvn,\r\n{ "TT Version", "batadv.tt_query.ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_tt_crc,\r\n{ "CRC of TT", "batadv.tt_query.tt_crc",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_query_entries,\r\n{ "Entries", "batadv.tt_query.entries",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Number of entries", HFILL }\r\n},\r\n{ &hf_batadv_roam_adv_version,\r\n{ "Version", "batadv.roam_adv.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_roam_adv_ttl,\r\n{ "Time to Live", "batadv.roam_adv.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_roam_adv_src,\r\n{ "Source", "batadv.roam_adv.src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_roam_adv_dst,\r\n{ "Destination", "batadv.roam_adv.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_roam_adv_client,\r\n{ "Client", "batadv.roam_adv.client",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_version,\r\n{ "Version", "batadv.coded.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_ttl,\r\n{ "Time to Live", "batadv.coded.ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_coded_first_ttvn,\r\n{ "TT Version (First)", "batadv.coded.first_ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_coded_first_source,\r\n{ "Source (First)", "batadv.coded.first_src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_first_orig_dest,\r\n{ "Original Destination (First)", "batadv.coded.first_orig_dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_first_crc,\r\n{ "CRC (First)", "batadv.coded.first_crc",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_second_ttl,\r\n{ "Time to Live (Second)", "batadv.coded.second_ttl",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_coded_second_ttvn,\r\n{ "TT Version (Second)", "batadv.coded.second_ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{ &hf_batadv_coded_second_dest,\r\n{ "Destination (Second)", "batadv.coded.second_dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_second_source,\r\n{ "Source (Second)", "batadv.coded.second_src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_second_orig_dest,\r\n{ "Original Destination (Second)", "batadv.coded.second_orig_dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_second_crc,\r\n{ "CRC (Second)", "batadv.coded.second_crc",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_coded_coded_len,\r\n{ "Length", "batadv.coded.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragments,\r\n{"Message fragments", "batadv.unicast_frag.fragments",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_entry,\r\n{ "Entry", "batadv.tt_entry.entry",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_entry_flags,\r\n{ "Flags", "batadv.tt_entry.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_entry_flags_change_del,\r\n{ "Delete", "batadv.tt_entry.flags.change_del",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), TT_CHANGE_DEL,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tt_entry_flags_client_roam,\r\n{ "Client Roam", "batadv.tt_entry.flags.client_roam",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), TT_CLIENT_ROAM,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment,\r\n{"Message fragment", "batadv.unicast_frag.fragment",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment_overlap,\r\n{"Message fragment overlap", "batadv.unicast_frag.fragment.overlap",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment_overlap_conflicts,\r\n{"Message fragment overlapping with conflicting data",\r\n"batadv.unicast_frag.fragment.overlap.conflicts",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment_multiple_tails,\r\n{"Message has multiple tail fragments",\r\n"batadv.unicast_frag.fragment.multiple_tails",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment_too_long_fragment,\r\n{"Message fragment too long", "batadv.unicast_frag.fragment.too_long_fragment",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment_error,\r\n{"Message defragmentation error", "batadv.unicast_frag.fragment.error",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_fragment_count,\r\n{"Message fragment count", "batadv.unicast_frag.fragment.count",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_reassembled_in,\r\n{"Reassembled in", "batadv.msg.reassembled.in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msg_reassembled_length,\r\n{"Reassembled length", "batadv.msg.reassembled.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_type,\r\n{ "Type", "batadv.tvlv.length",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_version,\r\n{ "Version", "batadv.tvlv.length",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_len,\r\n{ "Length", "batadv.tvlv.len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_mcast_flags_unsnoopables,\r\n{ "Unsnoopables", "batadv.tvlv.mcast.flags.unsnoopables",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x1,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_mcast_flags_ipv4,\r\n{ "IPv4", "batadv.tvlv.mcast.flags.ipv4",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x2,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_mcast_flags_ipv6,\r\n{ "IPv6", "batadv.tvlv.mcast.flags.ipv6",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x4,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_gw_download,\r\n{ "Download Speed", "batadv.tvlv.gw.dl_speed",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_gw_upload,\r\n{ "Upload Speed", "batadv.tvlv.gw.ul_speed",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_roam_addr,\r\n{ "Address", "batadv.batman.addr",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_roam_vid,\r\n{ "VID", "batadv.tvlv.roam.vid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_vid_vlan,\r\n{ "VLAN ID", "batadv.tvlv.vid_vlan",\r\nFT_UINT16, BASE_DEC, NULL, 0x7fff,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_vid_tagged,\r\n{ "VLAN Tagged", "batadv.tvlv.vid_tagged",\r\nFT_UINT16, BASE_DEC, NULL, 0x8000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_flags,\r\n{ "Flags", "batadv.tvlv.tt.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_flags_type,\r\n{ "Query Type", "batadv.tvlv.tt.flags.type",\r\nFT_UINT8, BASE_HEX, VALS(tvlv_tt_typenames),\r\nBATADV_TVLVL_TT_TYPE_MASK,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_flags_full_table,\r\n{ "Full Table", "batadv.tvlv.tt.flags.full_table",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset),\r\nBATADV_TVLVL_TT_FULL_TABLE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_ttvn,\r\n{ "TT Version", "batadv.tvlv.tt.ttvn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_num_vlan,\r\n{ "VLAN Entries", "batadv.tvlv.tt.num_vlan",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_vlan_crc,\r\n{ "CRC", "batadv.tvlv.tt.vlan.crc",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_vlan_vid,\r\n{ "VID", "batadv.tvlv.tt.vlan.vid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_flags,\r\n{ "Flags", "batadv.tvlv.tt.change.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_flags_del,\r\n{ "Delete", "batadv.tvlv.tt.change.flags.del",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset),\r\nBATADV_TVLVL_TT_CHANGE_DEL,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_flags_roam,\r\n{ "Client Roam", "batadv.tvlv.tt.change.flags.roam",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset),\r\nBATADV_TVLVL_TT_CHANGE_ROAM,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_flags_wifi,\r\n{ "Wifi Client", "batadv.tvlv.tt.change.flags.wifi",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset),\r\nBATADV_TVLVL_TT_CHANGE_WIFI,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_flags_isolate,\r\n{ "Isolate", "batadv.tvlv.tt.change.flags.isolate",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset),\r\nBATADV_TVLVL_TT_CHANGE_ISOLATE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_addr,\r\n{ "Address", "batadv.tvlv.tt.change.addr",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_batadv_tvlv_tt_change_vid,\r\n{ "VID", "batadv.tvlv.tt.change.vid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_batadv_batman,\r\n&ett_batadv_batman_flags,\r\n&ett_batadv_batman_tt,\r\n&ett_batadv_batman_gwflags,\r\n&ett_batadv_iv_ogm,\r\n&ett_batadv_iv_ogm_flags,\r\n&ett_batadv_bcast,\r\n&ett_batadv_icmp,\r\n&ett_batadv_icmp_rr,\r\n&ett_batadv_unicast,\r\n&ett_batadv_unicast_4addr,\r\n&ett_batadv_unicast_frag,\r\n&ett_batadv_unicast_tvlv,\r\n&ett_batadv_vis,\r\n&ett_batadv_vis_entry,\r\n&ett_batadv_tt_query,\r\n&ett_batadv_tt_query_flags,\r\n&ett_batadv_tt_entry,\r\n&ett_batadv_tt_entry_flags,\r\n&ett_batadv_roam_adv,\r\n&ett_batadv_coded,\r\n&ett_batadv_tvlv,\r\n&ett_batadv_tvlv_vid,\r\n&ett_batadv_tvlv_mcast_flags,\r\n&ett_batadv_tvlv_tt_flags,\r\n&ett_batadv_tvlv_tt_vlan,\r\n&ett_batadv_tvlv_tt_change,\r\n&ett_msg_fragment,\r\n&ett_msg_fragments\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_batadv_tvlv_unknown_version, { "batadv.error.tvlv_version_unknown", PI_UNDECODED, PI_ERROR, "BATADV Error: unknown TVLV version", EXPFILL }},\r\n};\r\nproto_batadv_plugin = proto_register_protocol(\r\n"B.A.T.M.A.N. Advanced Protocol",\r\n"BATADV",\r\n"batadv"\r\n);\r\nregister_dissector("batadv",dissect_batadv_plugin,proto_batadv_plugin);\r\nbatadv_module = prefs_register_protocol(proto_batadv_plugin,\r\nproto_reg_handoff_batadv);\r\nprefs_register_uint_preference(batadv_module, "batmanadv.ethertype",\r\n"Ethertype",\r\n"Ethertype used to indicate B.A.T.M.A.N. packet.",\r\n16, &batadv_ethertype);\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_register_field_array(proto_batadv_plugin, hf, array_length(hf));\r\nexpert_batadv = expert_register_protocol(proto_batadv_plugin);\r\nexpert_register_field_array(expert_batadv, ei, array_length(ei));\r\nregister_init_routine(&batadv_init_routine);\r\nregister_cleanup_routine(&batadv_cleanup_routine);\r\n}\r\nvoid proto_reg_handoff_batadv(void)\r\n{\r\nstatic gboolean inited = FALSE;\r\nstatic unsigned int old_batadv_ethertype;\r\nif (!inited) {\r\nbatman_handle = create_dissector_handle(dissect_batadv_plugin, proto_batadv_plugin);\r\neth_handle = find_dissector_add_dependency("eth_withoutfcs", proto_batadv_plugin);\r\nbatadv_tap = register_tap("batman");\r\nbatadv_follow_tap = register_tap("batman_follow");\r\ninited = TRUE;\r\n} else {\r\ndissector_delete_uint("ethertype", old_batadv_ethertype, batman_handle);\r\n}\r\nold_batadv_ethertype = batadv_ethertype;\r\ndissector_add_uint("ethertype", batadv_ethertype, batman_handle);\r\n}

static int\r\ndissect_peekremote_extflags(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *extflags_tree;\r\nproto_item *ti_extflags;\r\nti_extflags = proto_tree_add_item(tree, &hfi_peekremote_extflags, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nextflags_tree = proto_item_add_subtree(ti_extflags, ett_peekremote_extflags);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_20mhz_lower, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_20mhz_upper, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_40mhz, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_half_gi, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_full_gi, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_ampdu, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_amsdu, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_11ac, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_future_use, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(extflags_tree, &hfi_peekremote_extflags_reserved, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nreturn 4;\r\n}\r\nstatic int\r\ndissect_peekremote_flags(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *flags_tree;\r\nproto_item *ti_flags;\r\nti_flags = proto_tree_add_item(tree, &hfi_peekremote_flags, tvb, offset, 1, ENC_NA);\r\nflags_tree = proto_item_add_subtree(ti_flags, ett_peekremote_flags);\r\nproto_tree_add_item(flags_tree, &hfi_peekremote_flags_control_frame, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(flags_tree, &hfi_peekremote_flags_crc_error, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(flags_tree, &hfi_peekremote_flags_frame_error, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(flags_tree, &hfi_peekremote_flags_reserved, tvb, offset, 1, ENC_NA);\r\nreturn 1;\r\n}\r\nstatic int\r\ndissect_peekremote_status(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *status_tree;\r\nproto_item *ti_status;\r\nti_status = proto_tree_add_item(tree, &hfi_peekremote_status, tvb, offset, 1, ENC_NA);\r\nstatus_tree = proto_item_add_subtree(ti_status, ett_peekremote_status);\r\nproto_tree_add_item(status_tree, &hfi_peekremote_status_protected, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(status_tree, &hfi_peekremote_status_with_decrypt_error, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(status_tree, &hfi_peekremote_status_with_short_preamble, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(status_tree, &hfi_peekremote_status_reserved, tvb, offset, 1, ENC_NA);\r\nreturn 1;\r\n}\r\nstatic gboolean\r\ndissect_peekremote_new(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *u _U_)\r\n{\r\nstatic const guint8 magic[4] = { 0x00, 0xFF, 0xAB, 0xCD };\r\nint offset = 0;\r\nproto_tree *peekremote_tree = NULL;\r\nproto_item *ti = NULL;\r\nproto_item *ti_header_version, *ti_header_size;\r\nguint8 header_version;\r\nguint header_size;\r\nstruct ieee_802_11_phdr phdr;\r\nguint32 extflags;\r\nguint16 frequency;\r\nguint16 mcs_index;\r\ntvbuff_t *next_tvb;\r\nif (tvb_memeql(tvb, 0, magic, 4) == -1) {\r\nreturn FALSE;\r\n}\r\nmemset(&phdr, 0, sizeof(phdr));\r\nphdr.fcs_len = 4;\r\nphdr.decrypted = FALSE;\r\nphdr.datapad = FALSE;\r\nphdr.phy = PHDR_802_11_PHY_UNKNOWN;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PEEKREMOTE");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, hfi_peekremote, tvb, 0, -1, ENC_NA);\r\npeekremote_tree = proto_item_add_subtree(ti, ett_peekremote);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_magic_number, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nheader_version = tvb_get_guint8(tvb, offset);\r\nti_header_version = proto_tree_add_uint(peekremote_tree, &hfi_peekremote_header_version, tvb, offset, 1, header_version);\r\noffset += 1;\r\nheader_size = tvb_get_ntohl(tvb, offset);\r\nti_header_size = proto_tree_add_uint(peekremote_tree, &hfi_peekremote_header_size, tvb, offset, 4, header_size);\r\noffset += 4;\r\nswitch (header_version) {\r\ncase 2:\r\nif (header_size != 55) {\r\nexpert_add_info(pinfo, ti_header_size, &ei_peekremote_invalid_header_size);\r\nif (header_size > 9)\r\noffset += (header_size - 9);\r\n} else {\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_type, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nmcs_index = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_mcs_index, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nphdr.has_channel = TRUE;\r\nphdr.channel = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_channel, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nfrequency = tvb_get_ntohl(tvb, offset);\r\nif (frequency != 0) {\r\nphdr.has_frequency = TRUE;\r\nphdr.frequency = frequency;\r\n}\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_frequency, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_band, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset +=4;\r\nextflags = tvb_get_ntohl(tvb, offset);\r\nif (extflags & EXT_FLAG_802_11ac) {\r\nguint i;\r\nphdr.phy = PHDR_802_11_PHY_11AC;\r\nfor (i = 0; i < 4; i++) {\r\nphdr.phy_info.info_11ac.nss[i] = 0;\r\n}\r\n} else {\r\nphdr.phy = PHDR_802_11_PHY_11N;\r\nphdr.phy_info.info_11n.has_mcs_index = TRUE;\r\nphdr.phy_info.info_11n.mcs_index = mcs_index;\r\n}\r\noffset += dissect_peekremote_extflags(tvb, pinfo, peekremote_tree, offset);\r\nphdr.has_signal_percent = TRUE;\r\nphdr.signal_percent = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_percent, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nphdr.has_noise_percent = TRUE;\r\nphdr.noise_percent = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_percent, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nphdr.has_signal_dbm = TRUE;\r\nphdr.signal_dbm = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nphdr.has_noise_dbm = TRUE;\r\nphdr.noise_dbm = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_1_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_2_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_3_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_4_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_1_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_2_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_3_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_4_dbm, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_packetlength, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_slicelength, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += dissect_peekremote_flags(tvb, pinfo, peekremote_tree, offset);\r\noffset += dissect_peekremote_status(tvb, pinfo, peekremote_tree, offset);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_timestamp, tvb, offset, 8, ENC_BIG_ENDIAN);\r\nphdr.has_tsf_timestamp = TRUE;\r\nphdr.tsf_timestamp = tvb_get_ntoh64(tvb, offset);\r\noffset += 8;\r\n}\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, ti_header_version, &ei_peekremote_unknown_header_version);\r\nif (header_size > 9)\r\noffset += (header_size - 9);\r\nbreak;\r\n}\r\nproto_item_set_end(ti, tvb, offset);\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_dissector_with_data(wlan_radio_handle, next_tvb, pinfo, tree, &phdr);\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_peekremote_legacy(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\ntvbuff_t *next_tvb;\r\nproto_tree *peekremote_tree = NULL;\r\nproto_item *ti = NULL;\r\nstruct ieee_802_11_phdr phdr;\r\nguint8 signal_percent;\r\nmemset(&phdr, 0, sizeof(phdr));\r\nif (dissect_peekremote_new(tvb, pinfo, tree, data)) {\r\nreturn tvb_reported_length(tvb);\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PEEKREMOTE");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, hfi_peekremote, tvb, 0, -1, ENC_NA);\r\npeekremote_tree = proto_item_add_subtree(ti, ett_peekremote);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_dbm, tvb, 0, 1, ENC_NA);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_dbm, tvb, 1, 1, ENC_NA);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_packetlength, tvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_slicelength, tvb, 4, 2, ENC_BIG_ENDIAN);\r\ndissect_peekremote_flags(tvb, pinfo, peekremote_tree, 6);\r\ndissect_peekremote_status(tvb, pinfo, peekremote_tree, 7);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_timestamp, tvb, 8, 8, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_speed, tvb, 16, 1, ENC_NA);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_channel, tvb, 17, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_signal_percent, tvb, 18, 1, ENC_NA);\r\nproto_tree_add_item(peekremote_tree, &hfi_peekremote_noise_percent, tvb, 19, 1, ENC_NA);\r\n}\r\nsignal_percent = tvb_get_guint8(tvb, 18);\r\nproto_item_set_end(ti, tvb, 20);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 20);\r\nif (GPOINTER_TO_INT(data) == IS_ARUBA && signal_percent == 100) {\r\nphdr.fcs_len = 0;\r\n} else {\r\nphdr.fcs_len = 4;\r\n}\r\nphdr.decrypted = FALSE;\r\nphdr.phy = PHDR_802_11_PHY_UNKNOWN;\r\nphdr.has_channel = TRUE;\r\nphdr.channel = tvb_get_guint8(tvb, 17);\r\nphdr.has_data_rate = TRUE;\r\nphdr.data_rate = tvb_get_guint8(tvb, 16);\r\nphdr.has_signal_percent = TRUE;\r\nphdr.signal_percent = tvb_get_guint8(tvb, 18);\r\nphdr.has_noise_percent = TRUE;\r\nphdr.noise_percent = tvb_get_guint8(tvb, 18);\r\nphdr.has_signal_dbm = TRUE;\r\nphdr.signal_dbm = tvb_get_guint8(tvb, 0);\r\nphdr.has_noise_dbm = TRUE;\r\nphdr.noise_dbm = tvb_get_guint8(tvb, 1);\r\nphdr.has_tsf_timestamp = TRUE;\r\nphdr.tsf_timestamp = tvb_get_ntoh64(tvb, 8);\r\nreturn 20 + call_dissector_with_data(wlan_radio_handle, next_tvb, pinfo, tree, &phdr);\r\n}\r\nvoid\r\nproto_register_peekremote(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_peekremote_signal_dbm,\r\n&hfi_peekremote_noise_dbm,\r\n&hfi_peekremote_packetlength,\r\n&hfi_peekremote_slicelength,\r\n&hfi_peekremote_flags,\r\n&hfi_peekremote_flags_control_frame,\r\n&hfi_peekremote_flags_crc_error,\r\n&hfi_peekremote_flags_frame_error,\r\n&hfi_peekremote_flags_reserved,\r\n&hfi_peekremote_status,\r\n&hfi_peekremote_status_protected,\r\n&hfi_peekremote_status_with_decrypt_error,\r\n&hfi_peekremote_status_with_short_preamble,\r\n&hfi_peekremote_status_reserved,\r\n&hfi_peekremote_timestamp,\r\n&hfi_peekremote_speed,\r\n&hfi_peekremote_channel,\r\n&hfi_peekremote_magic_number,\r\n&hfi_peekremote_header_version,\r\n&hfi_peekremote_header_size,\r\n&hfi_peekremote_type,\r\n&hfi_peekremote_mcs_index,\r\n&hfi_peekremote_signal_percent,\r\n&hfi_peekremote_noise_percent,\r\n&hfi_peekremote_frequency,\r\n&hfi_peekremote_band,\r\n&hfi_peekremote_extflags,\r\n&hfi_peekremote_extflags_20mhz_lower,\r\n&hfi_peekremote_extflags_20mhz_upper,\r\n&hfi_peekremote_extflags_40mhz,\r\n&hfi_peekremote_extflags_half_gi,\r\n&hfi_peekremote_extflags_full_gi,\r\n&hfi_peekremote_extflags_ampdu,\r\n&hfi_peekremote_extflags_amsdu,\r\n&hfi_peekremote_extflags_11ac,\r\n&hfi_peekremote_extflags_future_use,\r\n&hfi_peekremote_extflags_reserved,\r\n&hfi_peekremote_signal_1_dbm,\r\n&hfi_peekremote_signal_2_dbm,\r\n&hfi_peekremote_signal_3_dbm,\r\n&hfi_peekremote_signal_4_dbm,\r\n&hfi_peekremote_noise_1_dbm,\r\n&hfi_peekremote_noise_2_dbm,\r\n&hfi_peekremote_noise_3_dbm,\r\n&hfi_peekremote_noise_4_dbm,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_peekremote,\r\n&ett_peekremote_flags,\r\n&ett_peekremote_status,\r\n&ett_peekremote_extflags\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_peekremote_unknown_header_version, { "peekremote.unknown_header_version", PI_UNDECODED, PI_ERROR, "Unknown header version", EXPFILL }},\r\n{ &ei_peekremote_invalid_header_size, { "peekremote.invalid_header_size", PI_UNDECODED, PI_ERROR, "Invalid header size for that header version", EXPFILL }},\r\n};\r\nexpert_module_t *expert_peekremote;\r\nproto_peekremote = proto_register_protocol(\r\n"AiroPeek/OmniPeek encapsulated IEEE 802.11", "PEEKREMOTE", "peekremote");\r\nhfi_peekremote = proto_registrar_get_nth(proto_peekremote);\r\nproto_register_fields(proto_peekremote, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_peekremote = expert_register_protocol(proto_peekremote);\r\nexpert_register_field_array(expert_peekremote, ei, array_length(ei));\r\npeekremote_handle = register_dissector("peekremote", dissect_peekremote_legacy, proto_peekremote);\r\n}\r\nvoid\r\nproto_reg_handoff_peekremote(void)\r\n{\r\nwlan_radio_handle = find_dissector_add_dependency("wlan_radio", proto_peekremote);\r\ndissector_add_uint("udp.port", 5000, peekremote_handle);\r\nheur_dissector_add("udp", dissect_peekremote_new, "OmniPeek Remote over UDP", "peekremote_udp", proto_peekremote, HEURISTIC_ENABLE);\r\n}

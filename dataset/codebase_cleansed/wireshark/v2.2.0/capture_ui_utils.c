static char *\r\ncapture_dev_get_if_property(const gchar *pref, const gchar *if_name)\r\n{\r\ngchar **if_tokens;\r\ngchar *property = NULL;\r\nint i;\r\nif (if_name == NULL || strlen(if_name) < 1) {\r\nreturn NULL;\r\n}\r\nif (pref == NULL || strlen(pref) < 1) {\r\nreturn NULL;\r\n}\r\nif_tokens = g_strsplit(pref, ",", -1);\r\nfor (i = 0; if_tokens[i] != NULL; i++) {\r\ngchar *opening_parenp, *closing_parenp;\r\nopening_parenp = strchr(if_tokens[i], '(');\r\nif (opening_parenp == NULL) {\r\nbreak;\r\n}\r\nclosing_parenp = strrchr(if_tokens[i], ')');\r\nif (closing_parenp == NULL || closing_parenp <= opening_parenp) {\r\nbreak;\r\n}\r\n*opening_parenp = '\0';\r\n*closing_parenp = '\0';\r\nif (strcmp(if_tokens[i], if_name) == 0) {\r\nif (strlen(opening_parenp + 1) > 0) {\r\nproperty = g_strdup(opening_parenp + 1);\r\n}\r\nbreak;\r\n}\r\n}\r\ng_strfreev(if_tokens);\r\nreturn property;\r\n}\r\nstatic gint\r\ncapture_dev_get_if_int_property(const gchar *pref, const gchar *if_name)\r\n{\r\ngchar *property_string, *next;\r\nlong property;\r\nproperty_string = capture_dev_get_if_property(pref, if_name);\r\nif (property_string == NULL) {\r\nreturn -1;\r\n}\r\nproperty = strtol(property_string, &next, 10);\r\nif (next == property_string || *next != '\0' || property < 0) {\r\ng_free(property_string);\r\nreturn -1;\r\n}\r\nif (property > G_MAXINT) {\r\ng_free(property_string);\r\nreturn -1;\r\n}\r\ng_free(property_string);\r\nreturn (gint)property;\r\n}\r\nchar *\r\ncapture_dev_user_descr_find(const gchar *if_name)\r\n{\r\nreturn capture_dev_get_if_property(prefs.capture_devices_descr, if_name);\r\n}\r\ngint\r\ncapture_dev_user_linktype_find(const gchar *if_name)\r\n{\r\nreturn capture_dev_get_if_int_property(prefs.capture_devices_linktypes, if_name);\r\n}\r\ngint\r\ncapture_dev_user_buffersize_find(const gchar *if_name)\r\n{\r\nreturn capture_dev_get_if_int_property(prefs.capture_devices_buffersize, if_name);\r\n}\r\ngboolean\r\ncapture_dev_user_snaplen_find(const gchar *if_name, gboolean *hassnap, int *snaplen)\r\n{\r\ngboolean found = FALSE;\r\ngchar **if_tokens;\r\nint i;\r\nif (if_name == NULL || strlen(if_name) < 1) {\r\nreturn FALSE;\r\n}\r\nif ((prefs.capture_devices_snaplen == NULL) ||\r\n(*prefs.capture_devices_snaplen == '\0')) {\r\nreturn FALSE;\r\n}\r\nif_tokens = g_strsplit(prefs.capture_devices_snaplen, ",", -1);\r\nfor (i = 0; if_tokens[i] != NULL; i++) {\r\ngchar *colonp, *next;\r\nlong value;\r\ncolonp = strrchr(if_tokens[i], ':');\r\nif (colonp == NULL) {\r\nbreak;\r\n}\r\n*colonp = '\0';\r\nif (strcmp(if_tokens[i], if_name) == 0) {\r\nif (*(colonp + 1) == '0') {\r\nfound = TRUE;\r\n*hassnap = FALSE;\r\n*snaplen = WTAP_MAX_PACKET_SIZE;\r\n} else if (*(colonp + 1) == '1') {\r\nif (*(colonp + 2) != '(') {\r\nbreak;\r\n}\r\nvalue = strtol(colonp + 3, &next, 10);\r\nif (next == colonp + 3 || *next != ')' || value < 0) {\r\nbreak;\r\n}\r\nif (value > G_MAXINT) {\r\nbreak;\r\n}\r\nfound = TRUE;\r\n*hassnap = TRUE;\r\n*snaplen = (gint)value;\r\n} else {\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\ng_strfreev(if_tokens);\r\nreturn found;\r\n}\r\ngboolean\r\ncapture_dev_user_pmode_find(const gchar *if_name, gboolean *pmode)\r\n{\r\nint value;\r\nvalue = capture_dev_get_if_int_property(prefs.capture_devices_pmode, if_name);\r\nif (value == -1) {\r\nreturn FALSE;\r\n}\r\n*pmode = (value != 0);\r\nreturn TRUE;\r\n}\r\ngchar*\r\ncapture_dev_user_cfilter_find(const gchar *if_name)\r\n{\r\nreturn capture_dev_get_if_property(prefs.capture_devices_filter, if_name);\r\n}\r\nchar *\r\nget_interface_descriptive_name(const char *if_name)\r\n{\r\nchar *descr;\r\nGList *if_list;\r\nGList *if_entry;\r\nif_info_t *if_info;\r\nint err;\r\ndescr = capture_dev_user_descr_find(if_name);\r\nif (descr == NULL) {\r\nif (strcmp(if_name, "-") == 0) {\r\ndescr = g_strdup(ex_opt_get_nth("stdin_descr", 0));\r\nif (!descr) {\r\ndescr = g_strdup("Standard input");\r\n}\r\n} else {\r\ndescr = NULL;\r\nif_list = capture_interface_list(&err, NULL, NULL);\r\nif (if_list != NULL) {\r\nif_entry = if_list;\r\ndo {\r\nif_info = (if_info_t *)if_entry->data;\r\nif (strcmp(if_info->name, if_name) == 0) {\r\nif (if_info->friendly_name != NULL) {\r\ndescr = g_strdup(if_info->friendly_name);\r\n} else if (if_info->vendor_description != NULL) {\r\ndescr = g_strdup(if_info->vendor_description);\r\n}\r\nbreak;\r\n}\r\n} while ((if_entry = g_list_next(if_entry)) != NULL);\r\n}\r\nfree_interface_list(if_list);\r\nif (descr == NULL) {\r\ndescr = g_strdup(if_name);\r\n}\r\n}\r\n}\r\nreturn descr;\r\n}\r\nGList *\r\nbuild_capture_combo_list(GList *if_list, gboolean do_hide)\r\n{\r\nGList *combo_list;\r\nGList *if_entry;\r\nif_info_t *if_info;\r\nchar *if_string;\r\ngchar *descr;\r\ncombo_list = NULL;\r\nif (if_list != NULL) {\r\nfor (if_entry = if_list; if_entry != NULL;\r\nif_entry = g_list_next(if_entry)) {\r\nif_info = (if_info_t *)if_entry->data;\r\nif (!prefs_is_capture_device_hidden(if_info->name) || !do_hide) {\r\ndescr = capture_dev_user_descr_find(if_info->name);\r\nif (descr != NULL) {\r\nif_string = g_strdup_printf("%s: %s", descr, if_info->name);\r\ng_free(descr);\r\n} else {\r\nif (if_info->vendor_description != NULL) {\r\nif_string = g_strdup_printf("%s: %s",\r\nif_info->vendor_description,\r\nif_info->name);\r\n} else {\r\nif_string = g_strdup(if_info->name);\r\n}\r\n}\r\ncombo_list = g_list_append(combo_list, if_string);\r\n}\r\n}\r\n}\r\nreturn combo_list;\r\n}\r\nstatic void\r\nfree_if_string(gpointer data, gpointer user_data _U_)\r\n{\r\ng_free(data);\r\n}\r\nvoid\r\nfree_capture_combo_list(GList *combo_list)\r\n{\r\nif (combo_list != NULL) {\r\ng_list_foreach(combo_list, free_if_string, NULL);\r\ng_list_free(combo_list);\r\n}\r\n}\r\nconst char *\r\nget_if_name(const char *if_text)\r\n{\r\nconst char *if_name;\r\n#ifdef _WIN32\r\nif_name = if_text + strlen(if_text);\r\nfor (;;) {\r\nif (if_name == if_text) {\r\nbreak;\r\n}\r\nif_name--;\r\nif (*if_name == ':') {\r\nif ((strncmp(if_name, "://", 3) != 0) && !g_ascii_isdigit(if_name[1])) {\r\nif_name++;\r\nwhile (*if_name == ' ')\r\nif_name++;\r\nbreak;\r\n}\r\n}\r\n}\r\n#else\r\nif_name = strrchr(if_text, ' ');\r\nif (if_name == NULL) {\r\nif_name = if_text;\r\n} else {\r\nif_name++;\r\n}\r\n#endif\r\nreturn if_name;\r\n}\r\nconst char *\r\nget_iface_description_for_interface(capture_options *capture_opts, guint i)\r\n{\r\ninterface_options interface_opts;\r\nif (i < capture_opts->ifaces->len) {\r\ninterface_opts = g_array_index(capture_opts->ifaces, interface_options, i);\r\nif (!interface_opts.descr && interface_opts.name) {\r\ninterface_opts.descr = get_interface_descriptive_name(interface_opts.name);\r\ncapture_opts->ifaces = g_array_remove_index(capture_opts->ifaces, i);\r\ng_array_insert_val(capture_opts->ifaces, i, interface_opts);\r\n}\r\nreturn (interface_opts.descr);\r\n} else {\r\nreturn (NULL);\r\n}\r\n}\r\nvoid\r\nset_active_dlt(interface_t *device, int global_default_dlt)\r\n{\r\nGList *list;\r\ngboolean found_active_dlt;\r\nlink_row *link;\r\nif ((device->active_dlt = capture_dev_user_linktype_find(device->name)) == -1) {\r\ndevice->active_dlt = global_default_dlt;\r\n}\r\nfound_active_dlt = FALSE;\r\nfor (list = device->links; list != NULL; list = g_list_next(list)) {\r\nlink = (link_row *)(list->data);\r\nif (link->dlt != -1 && link->dlt == device->active_dlt) {\r\nfound_active_dlt = TRUE;\r\nbreak;\r\n}\r\n}\r\nif (!found_active_dlt) {\r\ndevice->active_dlt = -1;\r\n}\r\nif (device->active_dlt == -1) {\r\nfor (list = device->links; list != NULL; list = g_list_next(list)) {\r\nlink = (link_row *)(list->data);\r\nif (link->dlt != -1) {\r\ndevice->active_dlt = link->dlt;\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\ngchar *\r\nget_iface_display_name(const gchar *description, const if_info_t *if_info)\r\n{\r\nif (description && description[0]) {\r\n#ifdef _WIN32\r\ngchar *if_string = if_info->friendly_name ? if_info->friendly_name : if_info->name;\r\nreturn g_strdup_printf("%s: %s", description, if_string);\r\n#else\r\nreturn g_strdup_printf("%s: %s", description, if_info->name);\r\n#endif\r\n}\r\nif (if_info->friendly_name) {\r\n#ifdef _WIN32\r\nreturn g_strdup_printf("%s", if_info->friendly_name);\r\n#else\r\nreturn g_strdup_printf("%s: %s", if_info->friendly_name, if_info->name);\r\n#endif\r\n}\r\nif (if_info->vendor_description) {\r\nreturn g_strdup_printf("%s: %s", if_info->vendor_description, if_info->name);\r\n}\r\nreturn g_strdup(if_info->name);\r\n}

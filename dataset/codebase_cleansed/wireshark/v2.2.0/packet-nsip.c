static void\r\nget_value_length(nsip_ie_t *ie, build_info_t *bi) {\r\nconst guint8 MASK_LENGTH_INDICATOR = 0x80;\r\nconst guint8 MASK_ONE_BYTE_LENGTH = 0x7f;\r\nguint8 length_len;\r\nguint16 length;\r\nlength = tvb_get_guint8(bi->tvb, bi->offset);\r\nlength_len = 1;\r\nif (length & MASK_LENGTH_INDICATOR) {\r\nlength &= MASK_ONE_BYTE_LENGTH;\r\n}\r\nelse {\r\nlength_len++;\r\nlength <<= 8;\r\nlength |= tvb_get_guint8(bi->tvb, bi->offset+1);\r\n}\r\nie->value_length = length;\r\nie->total_length += length_len + length;\r\nbi->offset += length_len;\r\n}\r\nstatic int\r\ncheck_correct_iei(nsip_ie_t *ie, build_info_t *bi) {\r\nguint8 fetched_iei = tvb_get_guint8(bi->tvb, bi->offset);\r\n#if NSIP_DEBUG\r\nif (fetched_iei != ie->iei) {\r\nproto_tree_add_debug(bi->nsip_tree, bi->tvb, bi->offset, 1,\r\n"Tried IEI %s (%#02x), found IEI %s (%#02x)",\r\nval_to_str_const(ie->iei, tab_nsip_ieis, "Unknown"),\r\nie->iei,\r\nval_to_str_const(fetched_iei, tab_nsip_ieis, "Unknown"),\r\nfetched_iei);\r\n}\r\n#endif\r\nreturn (fetched_iei == ie->iei);\r\n}\r\nstatic void\r\ndecode_iei_cause(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint8 cause;\r\ncause = tvb_get_guint8(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_cause,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\ncause);\r\ncol_append_sep_fstr(bi->pinfo->cinfo, COL_INFO, NSIP_SEP,\r\n"Cause: %s",\r\nval_to_str(cause, tab_nsip_cause_values, "Unknown (0x%02x)"));\r\nproto_item_append_text(bi->ti, ", Cause: %s",\r\nval_to_str(cause, tab_nsip_cause_values, "Unknown (0x%02x)"));\r\nbi->offset += ie->value_length;\r\n}\r\nstatic void\r\ndecode_iei_ns_vci(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint16 ns_vci;\r\nns_vci = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_ns_vci,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\nns_vci);\r\ncol_append_sep_fstr(bi->pinfo->cinfo, COL_INFO, NSIP_SEP,\r\n"NS VCI: %#04x", ns_vci);\r\nproto_item_append_text(bi->ti, ", NS VCI: %#04x", ns_vci);\r\nbi->offset += ie->value_length;\r\n}\r\nstatic void\r\ndecode_iei_ns_pdu(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\ntvbuff_t * next_tvb;\r\nproto_tree_add_bytes_format(bi->nsip_tree, hf_nsip_ns_pdu, bi->tvb, ie_start_offset,\r\nie->total_length, NULL,\r\n"NS PDU (%u bytes)", ie->value_length);\r\nnext_tvb = tvb_new_subset(bi->tvb, bi->offset, ie->value_length, -1);\r\nif (nsip_handle) {\r\ngboolean was_recursive;\r\nwas_recursive = nsip_is_recursive;\r\nnsip_is_recursive = TRUE;\r\ncall_dissector(nsip_handle, next_tvb, bi->pinfo, bi->nsip_tree);\r\nnsip_is_recursive = was_recursive;\r\n}\r\nbi->offset += ie->value_length;\r\n}\r\nstatic void\r\ndecode_iei_nsei(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint16 nsei = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_nsei, bi->tvb,\r\nie_start_offset, ie->total_length, nsei);\r\nbi->offset += ie->value_length;\r\ncol_append_sep_fstr(bi->pinfo->cinfo, COL_INFO, NSIP_SEP,\r\n"NSEI %u", nsei);\r\nproto_item_append_text(bi->ti, ", NSEI %u", nsei);\r\n}\r\nstatic void\r\ndecode_iei_bvci(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint16 bvci = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_bvci, bi->tvb,\r\nie_start_offset, ie->total_length, bvci);\r\nbi->offset += ie->value_length;\r\ncol_append_sep_fstr(bi->pinfo->cinfo, COL_INFO, NSIP_SEP,\r\n"BVCI %u", bvci);\r\nproto_item_append_text(bi->ti, ", BVCI %u", bvci);\r\n}\r\nstatic proto_item *\r\ndecode_ip_element(nsip_ip_element_info_t *element, build_info_t *bi, proto_tree * element_tree) {\r\nguint16 udp_port;\r\nproto_item *tf;\r\nproto_tree *field_tree;\r\nfield_tree = proto_tree_add_subtree(element_tree, bi->tvb, bi->offset,\r\nelement->total_length, ett_nsip_ip_element, &tf, "IP Element");\r\nif (bi->nsip_tree) {\r\nswitch (element->version) {\r\ncase NSIP_IP_VERSION_4:\r\nproto_tree_add_item(field_tree, hf_nsip_ip_address_ipv4,\r\nbi->tvb, bi->offset, element->address_length,\r\nENC_BIG_ENDIAN);\r\nproto_item_append_text(tf, ": IP address: %s",\r\ntvb_ip_to_str(bi->tvb, bi->offset));\r\nbreak;\r\ncase NSIP_IP_VERSION_6:\r\nproto_tree_add_item(field_tree, hf_nsip_ip_address_ipv6, bi->tvb,\r\nbi->offset, element->address_length,\r\nENC_NA);\r\nproto_item_append_text(tf, ": IP address: %s",\r\ntvb_ip6_to_str(bi->tvb, bi->offset));\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nbi->offset += element->address_length;\r\nif (bi->nsip_tree) {\r\nudp_port = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_item(field_tree, hf_nsip_ip_element_udp_port,\r\nbi->tvb, bi->offset, 2, ENC_BIG_ENDIAN);\r\nproto_item_append_text(tf, ", UDP Port: %u", udp_port);\r\n}\r\nbi->offset += 2;\r\nif (bi->nsip_tree) {\r\nproto_tree_add_item(field_tree, hf_nsip_ip_element_signalling_weight,\r\nbi->tvb, bi->offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nbi->offset++;\r\nif (bi->nsip_tree) {\r\nproto_tree_add_item(field_tree, hf_nsip_ip_element_data_weight,\r\nbi->tvb, bi->offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nbi->offset++;\r\nreturn tf;\r\n}\r\nstatic proto_item *\r\ndecode_ip_elements(nsip_ip_element_info_t *element, nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nint i;\r\nint num_elements = ie->value_length / element->total_length;\r\nproto_item *tf;\r\nproto_tree *field_tree;\r\nfield_tree = proto_tree_add_subtree_format(bi->nsip_tree, bi->tvb, ie_start_offset,\r\nie->total_length, ett_nsip_ip_element_list, &tf,\r\n"List of IP%u Elements (%u Elements)",\r\nelement->version, num_elements);\r\nfor (i = 0; i < num_elements; i++) {\r\ndecode_ip_element(element, bi, field_tree);\r\n}\r\nreturn tf;\r\n}\r\nstatic void\r\ndecode_iei_max_num_ns_vc(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint16 num_ns_vc;\r\nif (bi->nsip_tree) {\r\nnum_ns_vc = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_max_num_ns_vc,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\nnum_ns_vc);\r\n}\r\nbi->offset += 2;\r\n}\r\nstatic void\r\ndecode_iei_num_ip4_endpoints(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint16 num_endpoints;\r\nif (bi->nsip_tree) {\r\nnum_endpoints = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_num_ip4_endpoints,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\nnum_endpoints);\r\n}\r\nbi->offset += 2;\r\n}\r\nstatic void\r\ndecode_iei_num_ip6_endpoints(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint16 num_endpoints;\r\nif (bi->nsip_tree) {\r\nnum_endpoints = tvb_get_ntohs(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_num_ip6_endpoints,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\nnum_endpoints);\r\n}\r\nbi->offset += 2;\r\n}\r\nstatic void\r\ndecode_iei_reset_flag(nsip_ie_t *ie _U_, build_info_t *bi, int ie_start_offset _U_) {\r\nguint8 flag;\r\nstatic const int * reset_flags[] = {\r\n&hf_nsip_reset_flag_bit,\r\n&hf_nsip_reset_flag_spare,\r\nNULL\r\n};\r\nflag = tvb_get_guint8(bi->tvb, bi->offset);\r\nproto_tree_add_bitmask(bi->nsip_tree, bi->tvb, bi->offset, hf_nsip_reset_flag,\r\nett_nsip_reset_flag, reset_flags, ENC_NA);\r\nif (flag & NSIP_MASK_RESET_FLAG) {\r\ncol_append_sep_fstr(bi->pinfo->cinfo, COL_INFO, NSIP_SEP, "Reset");\r\n}\r\nbi->offset += 1;\r\n}\r\nstatic void\r\ndecode_iei_ip_address(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint8 addr_type;\r\nguint32 ip4_addr;\r\nstruct e_in6_addr ip6_addr;\r\naddr_type = tvb_get_guint8(bi->tvb, bi->offset);\r\nproto_tree_add_item(bi->nsip_tree, hf_nsip_ip_address_type,\r\nbi->tvb, bi->offset, 1, ENC_BIG_ENDIAN);\r\nswitch (addr_type) {\r\ncase NSIP_IP_ADDRESS_TYPE_IPV4:\r\nie->total_length = 2 + ipv4_element.address_length;\r\nip4_addr = tvb_get_ipv4(bi->tvb, bi->offset+1);\r\nproto_tree_add_ipv4(bi->nsip_tree, hf_nsip_ip_address_ipv4,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\nip4_addr);\r\nbreak;\r\ncase NSIP_IP_ADDRESS_TYPE_IPV6:\r\nie->total_length = 2 + ipv6_element.address_length;\r\ntvb_get_ipv6(bi->tvb, bi->offset+1, &ip6_addr);\r\nproto_tree_add_ipv6(bi->nsip_tree, hf_nsip_ip_address_ipv4,\r\nbi->tvb, ie_start_offset, ie->total_length,\r\n&ip6_addr);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nbi->offset += ie->value_length;\r\n}\r\nstatic void\r\ndecode_iei_transaction_id(nsip_ie_t *ie, build_info_t *bi, int ie_start_offset) {\r\nguint8 id;\r\nid = tvb_get_guint8(bi->tvb, bi->offset);\r\nproto_tree_add_uint(bi->nsip_tree, hf_nsip_transaction_id,\r\nbi->tvb, ie_start_offset, ie->total_length, id);\r\ncol_append_sep_fstr(bi->pinfo->cinfo, COL_INFO, NSIP_SEP,\r\n"Transaction Id: %d", id);\r\nbi->offset += 1;\r\n}\r\nstatic void\r\ndecode_iei_end_flag(nsip_ie_t *ie _U_, build_info_t *bi, int ie_start_offset) {\r\nstatic const int * end_flags[] = {\r\n&hf_nsip_end_flag_bit,\r\n&hf_nsip_end_flag_spare,\r\nNULL\r\n};\r\nproto_tree_add_bitmask(bi->nsip_tree, bi->tvb, ie_start_offset, hf_nsip_end_flag,\r\nett_nsip_end_flag, end_flags, ENC_NA);\r\nbi->offset += 1;\r\n}\r\nstatic void\r\ndecode_iei_control_bits(nsip_ie_t *ie _U_, build_info_t *bi, int ie_start_offset) {\r\nguint8 control_bits;\r\nstatic const int * flags[] = {\r\n&hf_nsip_control_bits_r,\r\n&hf_nsip_control_bits_c,\r\n&hf_nsip_control_bits_spare,\r\nNULL\r\n};\r\ncontrol_bits = tvb_get_guint8(bi->tvb, bi->offset);\r\nproto_tree_add_bitmask(bi->nsip_tree, bi->tvb, ie_start_offset, hf_nsip_control_bits,\r\nett_nsip_control_bits, flags, ENC_NA);\r\nbi->offset++;\r\nif (control_bits & NSIP_MASK_CONTROL_BITS_R) {\r\ncol_append_sep_str(bi->pinfo->cinfo, COL_INFO, NSIP_SEP, "Req CF");\r\nproto_item_append_text(bi->ti, ", Request Change Flow");\r\n}\r\nif (control_bits & NSIP_MASK_CONTROL_BITS_C) {\r\ncol_append_sep_str(bi->pinfo->cinfo, COL_INFO, NSIP_SEP, "Conf CF");\r\nproto_item_append_text(bi->ti, ", Confirm Change Flow");\r\n}\r\n}\r\nstatic void\r\ndecode_ie(nsip_ie_t *ie, build_info_t *bi) {\r\nint org_offset = bi->offset;\r\nif (tvb_captured_length_remaining(bi->tvb, bi->offset) < 1) {\r\nreturn;\r\n}\r\nswitch (ie->format) {\r\ncase NSIP_IE_FORMAT_TLV:\r\nif (!check_correct_iei(ie, bi)) {\r\nreturn;\r\n}\r\nbi->offset++;\r\nie->total_length = 1;\r\nget_value_length(ie, bi);\r\nbreak;\r\ncase NSIP_IE_FORMAT_TV:\r\nif (!check_correct_iei(ie, bi)) {\r\nreturn;\r\n}\r\nbi->offset++;\r\nie->value_length = ie->total_length - 1;\r\nbreak;\r\ncase NSIP_IE_FORMAT_V:\r\nie->value_length = ie->total_length;\r\ndefault:\r\n;\r\n}\r\nswitch (ie->iei) {\r\ncase NSIP_IE_CAUSE:\r\ndecode_iei_cause(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_NS_VCI:\r\ndecode_iei_ns_vci(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_NS_PDU:\r\ndecode_iei_ns_pdu(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_NSEI:\r\ndecode_iei_nsei(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_BVCI:\r\ndecode_iei_bvci(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_IP4_ELEMENTS:\r\ndecode_ip_elements(&ipv4_element, ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_IP6_ELEMENTS:\r\ndecode_ip_elements(&ipv6_element, ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_MAX_NUM_NS_VC:\r\ndecode_iei_max_num_ns_vc(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_NUM_IP4_ENDPOINTS:\r\ndecode_iei_num_ip4_endpoints(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_NUM_IP6_ENDPOINTS:\r\ndecode_iei_num_ip6_endpoints(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_RESET_FLAG:\r\ndecode_iei_reset_flag(ie, bi, org_offset);\r\nbreak;\r\ncase NSIP_IE_IP_ADDRESS:\r\ndecode_iei_ip_address(ie, bi, org_offset);\r\nbreak;\r\ndefault:\r\n;\r\n}\r\n}\r\nstatic void\r\ndecode_pdu_general(nsip_ie_t *ies, int num_ies, build_info_t *bi) {\r\nint i;\r\nfor (i = 0; i < num_ies; i++) {\r\ndecode_ie(&ies[i], bi);\r\n}\r\n}\r\nstatic void\r\ndecode_pdu_ns_unitdata(build_info_t *bi) {\r\ntvbuff_t *next_tvb;\r\nnsip_ie_t ies[] = {\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 1 },\r\n{ NSIP_IE_BVCI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 2 },\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 0 },\r\n};\r\ngint sdu_length;\r\ndecode_iei_control_bits(ies, bi, bi->offset);\r\ndecode_pdu_general(&ies[1], 1, bi);\r\nnext_tvb = tvb_new_subset_remaining(bi->tvb, bi->offset);\r\nif (bssgp_handle) {\r\ncall_dissector(bssgp_handle, next_tvb, bi->pinfo, bi->parent_tree);\r\n}\r\nelse {\r\nsdu_length = tvb_captured_length_remaining(bi->tvb, bi->offset);\r\nproto_tree_add_bytes_format(bi->nsip_tree, hf_nsip_ns_sdu, bi->tvb, bi->offset, sdu_length,\r\nNULL, "NS SDU (%u bytes)", sdu_length);\r\n}\r\n}\r\nstatic void\r\ndecode_pdu_ns_reset(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_CAUSE, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 3 },\r\n{ NSIP_IE_NS_VCI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n};\r\ndecode_pdu_general(ies, 3, bi);\r\n}\r\nstatic void\r\ndecode_pdu_ns_reset_ack(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NS_VCI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n};\r\ndecode_pdu_general(ies, 2, bi);\r\n}\r\nstatic void\r\ndecode_pdu_ns_block(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_CAUSE, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 3 },\r\n{ NSIP_IE_NS_VCI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n};\r\ndecode_pdu_general(ies, 2, bi);\r\n}\r\nstatic void\r\ndecode_pdu_ns_block_ack(build_info_t *bi) {\r\nnsip_ie_t ies[] = { { NSIP_IE_NS_VCI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV,\r\n0, 1 }, };\r\ndecode_pdu_general(ies, 1, bi);\r\n}\r\nstatic void\r\ndecode_pdu_ns_status(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_CAUSE, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 3 },\r\n{ NSIP_IE_NS_VCI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_NS_PDU, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_BVCI, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_IP4_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_IP6_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n};\r\ndecode_pdu_general(ies, 6, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_ack(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 1 },\r\n{ NSIP_IE_CAUSE, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 3 },\r\n{ NSIP_IE_IP_ADDRESS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TV, 0, 0 },\r\n{ NSIP_IE_IP4_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_IP6_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n};\r\ndecode_pdu_general(ies, 1, bi);\r\ndecode_iei_transaction_id(&ies[1], bi, bi->offset);\r\ndecode_pdu_general(&ies[2], 4, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_add(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 1 },\r\n{ NSIP_IE_IP4_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_IP6_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n};\r\ndecode_pdu_general(ies, 1, bi);\r\ndecode_iei_transaction_id(&ies[1], bi, bi->offset);\r\ndecode_pdu_general(&ies[2], 2, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_changeweight(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 1 },\r\n{ NSIP_IE_IP4_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_IP6_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n};\r\ndecode_pdu_general(ies, 1, bi);\r\ndecode_iei_transaction_id(&ies[1], bi, bi->offset);\r\ndecode_pdu_general(&ies[2], 2, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_config(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 1 },\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_IP4_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_IP6_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n};\r\ndecode_iei_end_flag(ies, bi, bi->offset);\r\ndecode_pdu_general(&ies[1], 3, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_config_ack(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_CAUSE, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 3 },\r\n};\r\ndecode_pdu_general(ies, 2, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_delete(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4},\r\n{ 0, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_V, 0, 1 },\r\n{ NSIP_IE_IP_ADDRESS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TV, 0, 0 },\r\n{ NSIP_IE_IP4_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n{ NSIP_IE_IP6_ELEMENTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 0 },\r\n};\r\ndecode_pdu_general(ies, 1, bi);\r\ndecode_iei_transaction_id(&ies[1], bi, bi->offset);\r\ndecode_pdu_general(&ies[2], 3, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_size(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_RESET_FLAG, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TV, 0, 2 },\r\n{ NSIP_IE_MAX_NUM_NS_VC, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TV, 0, 3 },\r\n{ NSIP_IE_NUM_IP4_ENDPOINTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TV,\r\n0, 3 },\r\n{ NSIP_IE_NUM_IP6_ENDPOINTS, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TV,\r\n0, 3 },\r\n};\r\ndecode_pdu_general(ies, 5, bi);\r\n}\r\nstatic void\r\ndecode_pdu_sns_size_ack(build_info_t *bi) {\r\nnsip_ie_t ies[] = {\r\n{ NSIP_IE_NSEI, NSIP_IE_PRESENCE_M, NSIP_IE_FORMAT_TLV, 0, 4 },\r\n{ NSIP_IE_CAUSE, NSIP_IE_PRESENCE_C, NSIP_IE_FORMAT_TLV, 0, 3 },\r\n};\r\ndecode_pdu_general(ies, 2, bi);\r\n}\r\nstatic void\r\ndecode_pdu(guint8 pdu_type, build_info_t *bi) {\r\nswitch (pdu_type) {\r\ncase NSIP_PDU_NS_UNITDATA:\r\ndecode_pdu_ns_unitdata(bi);\r\nbreak;\r\ncase NSIP_PDU_NS_RESET:\r\ndecode_pdu_ns_reset(bi);\r\nbreak;\r\ncase NSIP_PDU_NS_RESET_ACK:\r\ndecode_pdu_ns_reset_ack(bi);\r\nbreak;\r\ncase NSIP_PDU_NS_BLOCK:\r\ndecode_pdu_ns_block(bi);\r\nbreak;\r\ncase NSIP_PDU_NS_BLOCK_ACK:\r\ndecode_pdu_ns_block_ack(bi);\r\nbreak;\r\ncase NSIP_PDU_NS_STATUS:\r\ndecode_pdu_ns_status(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_ACK:\r\ndecode_pdu_sns_ack(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_ADD:\r\ndecode_pdu_sns_add(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_CHANGEWEIGHT:\r\ndecode_pdu_sns_changeweight(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_CONFIG:\r\ndecode_pdu_sns_config(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_CONFIG_ACK:\r\ndecode_pdu_sns_config_ack(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_DELETE:\r\ndecode_pdu_sns_delete(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_SIZE:\r\ndecode_pdu_sns_size(bi);\r\nbreak;\r\ncase NSIP_PDU_SNS_SIZE_ACK:\r\ndecode_pdu_sns_size_ack(bi);\r\nbreak;\r\ncase NSIP_PDU_NS_ALIVE:\r\ncase NSIP_PDU_NS_ALIVE_ACK:\r\ncase NSIP_PDU_NS_UNBLOCK:\r\ncase NSIP_PDU_NS_UNBLOCK_ACK:\r\ndefault: ;\r\n}\r\n}\r\nstatic int\r\ndissect_nsip(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\nguint8 pdu_type;\r\nbuild_info_t bi = { NULL, 0, NULL, NULL, NULL, NULL };\r\nproto_tree *nsip_tree;\r\nbi.tvb = tvb;\r\nbi.pinfo = pinfo;\r\nbi.parent_tree = tree;\r\nif (!nsip_is_recursive) {\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "GPRS-NS");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n}\r\npdu_type = tvb_get_guint8(tvb, 0);\r\nbi.offset++;\r\nif (tree) {\r\nbi.ti = proto_tree_add_item(tree, proto_nsip, tvb, 0, -1,\r\nENC_NA);\r\nnsip_tree = proto_item_add_subtree(bi.ti, ett_nsip);\r\nproto_tree_add_item(nsip_tree, hf_nsip_pdu_type, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(bi.ti, ", PDU type: %s",\r\nval_to_str_const(pdu_type, tab_nsip_pdu_types, "Unknown"));\r\nbi.nsip_tree = nsip_tree;\r\n}\r\nif (!nsip_is_recursive) {\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_const(pdu_type, tab_nsip_pdu_types, "Unknown PDU type"));\r\n} else {\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NSIP_SEP, "%s",\r\nval_to_str_const(pdu_type, tab_nsip_pdu_types, "Unknown PDU type"));\r\n}\r\ndecode_pdu(pdu_type, &bi);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_nsip(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_nsip_cause,\r\n{ "Cause", "nsip.cause",\r\nFT_UINT8, BASE_OCT, VALS(tab_nsip_cause_values), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ns_vci,\r\n{ "NS-VCI", "nsip.ns_vci",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\n"Network Service Virtual Link Identifier", HFILL }\r\n},\r\n{ &hf_nsip_pdu_type,\r\n{ "PDU type", "nsip.pdu_type",\r\nFT_UINT8, BASE_OCT, VALS(tab_nsip_pdu_types), 0x0,\r\n"PDU type information element", HFILL }\r\n},\r\n{ &hf_nsip_bvci,\r\n{ "BVCI", "nsip.bvci",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"BSSGP Virtual Connection Identifier", HFILL }\r\n},\r\n{ &hf_nsip_nsei,\r\n{ "NSEI", "nsip.nsei",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Network Service Entity Identifier", HFILL }\r\n},\r\n#if 0\r\n{ &hf_nsip_ip4_elements,\r\n{ "IP4 elements", "nsip.ip4_elements",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\n"List of IP4 elements", HFILL }\r\n},\r\n#endif\r\n#if 0\r\n{ &hf_nsip_ip6_elements,\r\n{ "IP6 elements", "nsip.ip6_elements",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\n"List of IP6 elements", HFILL }\r\n},\r\n#endif\r\n{ &hf_nsip_max_num_ns_vc,\r\n{ "Maximum number of NS-VCs", "nsip.max_num_ns_vc",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_num_ip4_endpoints,\r\n{ "Number of IP4 endpoints", "nsip.num_ip4_endpoints",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_num_ip6_endpoints,\r\n{ "Number of IP6 endpoints", "nsip.num_ip6_endpoints",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_reset_flag,\r\n{ "Reset flag", "nsip.reset_flag",\r\nFT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_reset_flag_bit,\r\n{ "Reset flag", "nsip.reset_flag.flag",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), NSIP_MASK_RESET_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_reset_flag_spare,\r\n{ "Reset flag spare bits", "nsip.reset_flag.spare",\r\nFT_UINT8, BASE_HEX, NULL, NSIP_MASK_RESET_FLAG_SPARE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ip_address_type,\r\n{ "IP Address Type", "nsip.ip_address_type",\r\nFT_UINT8, BASE_DEC, VALS(ip_address_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ip_address_ipv4,\r\n{ "IP Address", "nsip.ipv4_address",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ip_address_ipv6,\r\n{ "IP Address", "nsip.ipv6_address",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_end_flag,\r\n{ "End flag", "nsip.end_flag",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_end_flag_bit,\r\n{ "End flag", "nsip.end_flag.flag",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), NSIP_MASK_END_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_end_flag_spare,\r\n{ "End flag spare bits", "nsip.end_flag.spare",\r\nFT_UINT8, BASE_HEX, NULL, NSIP_MASK_END_FLAG_SPARE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_control_bits,\r\n{ "NS SDU Control bits", "nsip.control_bits",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_control_bits_r,\r\n{ "Request change flow", "nsip.control_bits.r",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), NSIP_MASK_CONTROL_BITS_R,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_control_bits_c,\r\n{ "Confirm change flow", "nsip.control_bits.c",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), NSIP_MASK_CONTROL_BITS_C,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_control_bits_spare,\r\n{ "Spare bits", "nsip.control_bits.spare",\r\nFT_UINT8, BASE_HEX, NULL, NSIP_MASK_CONTROL_BITS_SPARE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_transaction_id,\r\n{ "Transaction ID", "nsip.transaction_id",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_nsip_ip_element_ip_address_ipv4,\r\n{ "IP Address", "nsip.ip_element.ipv4_address",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n#if 0\r\n{ &hf_nsip_ip_element_ip_address_ipv6,\r\n{ "IP Address", "nsip.ip_element.ipv6_address",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_nsip_ip_element_udp_port,\r\n{ "UDP Port", "nsip.ip_element.udp_port",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ip_element_signalling_weight,\r\n{ "Signalling Weight", "nsip.ip_element.signalling_weight",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ip_element_data_weight,\r\n{ "Data Weight", "nsip.ip_element.data_weight",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ns_pdu,\r\n{ "NS PDU", "nsip.ns_pdu",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nsip_ns_sdu,\r\n{ "NS SDU", "nsip.ns_sdu",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_nsip,\r\n&ett_nsip_control_bits,\r\n&ett_nsip_reset_flag,\r\n&ett_nsip_end_flag,\r\n&ett_nsip_ip_element,\r\n&ett_nsip_ip_element_list,\r\n};\r\nmodule_t *nsip_module;\r\nproto_nsip = proto_register_protocol("GPRS Network Service",\r\n"GPRS-NS", "gprs-ns");\r\nproto_register_field_array(proto_nsip, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("gprs_ns", dissect_nsip, proto_nsip);\r\nrange_convert_str(&global_nsip_udp_port_range, DEFAULT_NSIP_PORT_RANGE, MAX_UDP_PORT);\r\nnsip_module = prefs_register_protocol(proto_nsip, proto_reg_handoff_nsip);\r\nprefs_register_obsolete_preference(nsip_module, "udp.port1");\r\nprefs_register_obsolete_preference(nsip_module, "udp.port2");\r\nprefs_register_range_preference(nsip_module, "udp.ports", "GPRS-NS UDP ports",\r\n"UDP ports to be decoded as GPRS-NS (default: "\r\nDEFAULT_NSIP_PORT_RANGE ")",\r\n&global_nsip_udp_port_range, MAX_UDP_PORT);\r\n}\r\nvoid\r\nproto_reg_handoff_nsip(void) {\r\nstatic gboolean nsip_prefs_initialized = FALSE;\r\nstatic range_t *nsip_udp_port_range;\r\nif (!nsip_prefs_initialized) {\r\nnsip_handle = find_dissector_add_dependency("gprs_ns", proto_nsip);\r\nbssgp_handle = find_dissector_add_dependency("bssgp", proto_nsip);\r\nnsip_prefs_initialized = TRUE;\r\n} else {\r\ndissector_delete_uint_range("udp.port", nsip_udp_port_range, nsip_handle);\r\ng_free(nsip_udp_port_range);\r\n}\r\nnsip_udp_port_range = range_copy(global_nsip_udp_port_range);\r\ndissector_add_uint_range("udp.port", nsip_udp_port_range, nsip_handle);\r\ndissector_add_uint("atm.aal5.type", TRAF_GPRS_NS, nsip_handle);\r\n}

static int\r\ndissect_e100(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ntvbuff_t *next_tvb = NULL;\r\nif (tvb_captured_length(tvb) >= e100_encap_len &&\r\ntvb_get_guint8(tvb, e100_header_ver.offset) == 1 &&\r\ntvb_get_ntohl(tvb, e100_bytes_cap.offset) == tvb_reported_length(tvb)-e100_encap_len)\r\n{\r\nguint32 bytes_captured;\r\nguint32 bytes_original;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "e100");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "E100 Encapsulated Packet");\r\nif (tree)\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *e100_tree = NULL;\r\nti = proto_tree_add_item(tree, proto_e100, tvb, 0, e100_encap_len, ENC_NA);\r\ne100_tree = proto_item_add_subtree(ti, ett_e100);\r\nproto_tree_add_item(e100_tree, hf_e100_header, tvb,\r\ne100_header_ver.offset, e100_header_ver.len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(e100_tree, hf_e100_port, tvb,\r\ne100_port_recv.offset, e100_port_recv.len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(e100_tree, hf_e100_seq, tvb,\r\ne100_seq.offset, e100_seq.len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(e100_tree, hf_e100_ip, tvb,\r\ne100_ip.offset, e100_ip.len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(e100_tree, hf_e100_mon_pkt_id, tvb,\r\ne100_mon_pkt_id.offset, e100_mon_pkt_id.len, ENC_BIG_ENDIAN);\r\n{\r\nnstime_t ts;\r\nts.secs = tvb_get_ntohl(tvb, e100_ts.offset);\r\nts.nsecs = tvb_get_ntohl(tvb, e100_ts.offset+4)*1000;\r\nproto_tree_add_time(e100_tree, hf_e100_pkt_ts, tvb,\r\ne100_ts.offset, e100_ts.len, &ts);\r\n}\r\nproto_tree_add_item(e100_tree, hf_e100_bytes_cap, tvb,\r\ne100_bytes_cap.offset, e100_bytes_cap.len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(e100_tree, hf_e100_bytes_orig, tvb,\r\ne100_bytes_orig.offset, e100_bytes_orig.len, ENC_BIG_ENDIAN);\r\n}\r\nbytes_captured = tvb_get_ntohl(tvb, e100_bytes_cap.offset);\r\nbytes_original = tvb_get_ntohl(tvb, e100_bytes_orig.offset);\r\nnext_tvb = tvb_new_subset(tvb, e100_encap_len, bytes_captured, bytes_original);\r\ncall_dissector(eth_handle, next_tvb, pinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nelse\r\n{\r\nreturn 0;\r\n}\r\n}\r\nvoid\r\nproto_register_e100(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_e100_header,\r\n{ "Header Version",\r\n"e100.version",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_port,\r\n{ "E100 Port Received",\r\n"e100.port_recv",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_seq,\r\n{ "Sequence Number",\r\n"e100.seq_num",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_ip,\r\n{ "E100 IP Address",\r\n"e100.ip",\r\nFT_IPv4,\r\nBASE_NONE,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_mon_pkt_id,\r\n{ "Monitor Packet ID",\r\n"e100.mon_pkt_id",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_pkt_ts,\r\n{ "Packet Capture Timestamp",\r\n"e100.pkt_ts",\r\nFT_ABSOLUTE_TIME,\r\nABSOLUTE_TIME_LOCAL,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_bytes_cap,\r\n{ "Bytes Captured",\r\n"e100.bytes_cap",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_e100_bytes_orig,\r\n{ "Bytes in Original Packet",\r\n"e100.bytes_orig",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n}\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_e100\r\n};\r\nproto_e100 = proto_register_protocol("E100 Encapsulation", "E100", "e100");\r\nproto_register_field_array(proto_e100, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_e100(void)\r\n{\r\nheur_dissector_add("udp", dissect_e100, "E100 over UDP", "e100_udp", proto_e100, HEURISTIC_ENABLE);\r\neth_handle = find_dissector_add_dependency("eth_withoutfcs", proto_e100);\r\n}

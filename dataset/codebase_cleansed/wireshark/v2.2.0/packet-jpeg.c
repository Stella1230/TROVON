static int\r\ndissect_jpeg( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_ )\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *jpeg_tree = NULL;\r\nproto_tree *main_hdr_tree = NULL;\r\nproto_tree *restart_hdr_tree = NULL;\r\nproto_tree *qtable_hdr_tree = NULL;\r\nguint32 fragment_offset = 0;\r\nguint16 len = 0;\r\nguint8 type = 0;\r\nguint8 q = 0;\r\ngint h = 0;\r\ngint w = 0;\r\nunsigned int offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "JPEG");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "JPEG message");\r\nif ( tree ) {\r\nti = proto_tree_add_item( tree, hfi_jpeg, tvb, offset, -1, ENC_NA );\r\njpeg_tree = proto_item_add_subtree( ti, ett_jpeg );\r\nti = proto_tree_add_item(jpeg_tree, &hfi_rtp_jpeg_main_hdr, tvb, offset, 8, ENC_NA);\r\nmain_hdr_tree = proto_item_add_subtree(ti, ett_jpeg);\r\nproto_tree_add_item(main_hdr_tree, &hfi_rtp_jpeg_main_hdr_ts, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_hdr_tree, &hfi_rtp_jpeg_main_hdr_offs, tvb, offset, 3, ENC_BIG_ENDIAN);\r\nfragment_offset = tvb_get_ntoh24(tvb, offset);\r\noffset += 3;\r\nproto_tree_add_item(main_hdr_tree, &hfi_rtp_jpeg_main_hdr_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ntype = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(main_hdr_tree, &hfi_rtp_jpeg_main_hdr_q, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nq = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nw = tvb_get_guint8(tvb, offset) * 8;\r\nproto_tree_add_uint(main_hdr_tree, &hfi_rtp_jpeg_main_hdr_width, tvb, offset, 1, w);\r\noffset += 1;\r\nh = tvb_get_guint8(tvb, offset) * 8;\r\nproto_tree_add_uint(main_hdr_tree, &hfi_rtp_jpeg_main_hdr_height, tvb, offset, 1, h);\r\noffset += 1;\r\nif (type >= 64 && type <= 127) {\r\nti = proto_tree_add_item(jpeg_tree, &hfi_rtp_jpeg_restart_hdr, tvb, offset, 4, ENC_NA);\r\nrestart_hdr_tree = proto_item_add_subtree(ti, ett_jpeg);\r\nproto_tree_add_item(restart_hdr_tree, &hfi_rtp_jpeg_restart_hdr_interval, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(restart_hdr_tree, &hfi_rtp_jpeg_restart_hdr_f, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(restart_hdr_tree, &hfi_rtp_jpeg_restart_hdr_l, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(restart_hdr_tree, &hfi_rtp_jpeg_restart_hdr_count, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nif (q >= 128 && fragment_offset == 0) {\r\nti = proto_tree_add_item(jpeg_tree, &hfi_rtp_jpeg_qtable_hdr, tvb, offset, -1, ENC_NA);\r\nqtable_hdr_tree = proto_item_add_subtree(ti, ett_jpeg);\r\nproto_tree_add_item(qtable_hdr_tree, &hfi_rtp_jpeg_qtable_hdr_mbz, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(qtable_hdr_tree, &hfi_rtp_jpeg_qtable_hdr_prec, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(qtable_hdr_tree, &hfi_rtp_jpeg_qtable_hdr_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlen = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nif (len > 0) {\r\nproto_tree_add_item(qtable_hdr_tree, &hfi_rtp_jpeg_qtable_hdr_data, tvb, offset, len, ENC_NA);\r\noffset += len;\r\n}\r\nproto_item_set_len(ti, len + 4);\r\n}\r\nproto_tree_add_item( jpeg_tree, &hfi_rtp_jpeg_payload, tvb, offset, -1, ENC_NA );\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_jpeg(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] =\r\n{\r\n&hfi_rtp_jpeg_main_hdr,\r\n&hfi_rtp_jpeg_main_hdr_ts,\r\n&hfi_rtp_jpeg_main_hdr_offs,\r\n&hfi_rtp_jpeg_main_hdr_type,\r\n&hfi_rtp_jpeg_main_hdr_q,\r\n&hfi_rtp_jpeg_main_hdr_width,\r\n&hfi_rtp_jpeg_main_hdr_height,\r\n&hfi_rtp_jpeg_restart_hdr,\r\n&hfi_rtp_jpeg_restart_hdr_interval,\r\n&hfi_rtp_jpeg_restart_hdr_f,\r\n&hfi_rtp_jpeg_restart_hdr_l,\r\n&hfi_rtp_jpeg_restart_hdr_count,\r\n&hfi_rtp_jpeg_qtable_hdr,\r\n&hfi_rtp_jpeg_qtable_hdr_mbz,\r\n&hfi_rtp_jpeg_qtable_hdr_prec,\r\n&hfi_rtp_jpeg_qtable_hdr_length,\r\n&hfi_rtp_jpeg_qtable_hdr_data,\r\n&hfi_rtp_jpeg_payload,\r\n};\r\n#endif\r\nstatic gint *ett[] =\r\n{\r\n&ett_jpeg,\r\n};\r\nint proto_jpeg;\r\nproto_jpeg = proto_register_protocol("RFC 2435 JPEG","JPEG","jpeg");\r\nhfi_jpeg = proto_registrar_get_nth(proto_jpeg);\r\nproto_register_fields(proto_jpeg, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\njpeg_handle = create_dissector_handle(dissect_jpeg, proto_jpeg);\r\nregister_ber_oid_dissector_handle("0.9.2342.19200300.100.1.60", jpeg_handle, proto_jpeg, "jpegPhoto");\r\n}\r\nvoid\r\nproto_reg_handoff_jpeg(void)\r\n{\r\ndissector_add_uint("rtp.pt", PT_JPEG, jpeg_handle);\r\n}

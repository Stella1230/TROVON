static guint get_mqtt_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint64 msg_len;\r\nguint len_offset;\r\nlen_offset = dissect_uleb128(tvb, (offset + MQTT_HDR_SIZE_BEFORE_LEN), &msg_len);\r\nreturn (guint)(GET_MQTT_PDU_LEN(msg_len, len_offset));\r\n}\r\nstatic int dissect_mqtt(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 mqtt_fixed_hdr;\r\nguint8 mqtt_msg_type;\r\nint offset = 0;\r\nmqtt_fixed_hdr = tvb_get_guint8(tvb, offset);\r\nmqtt_msg_type = mqtt_fixed_hdr >> 4;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MQTT");\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, ", ", val_to_str_ext(mqtt_msg_type, &mqtt_msgtype_vals_ext, "Unknown (0x%02x)"));\r\nif(tree)\r\n{\r\nproto_item *ti;\r\nproto_item *ti_mqtt;\r\nproto_tree *mqtt_tree;\r\nproto_tree *mqtt_msg_tree;\r\nproto_tree *mqtt_flag_tree;\r\nguint8 mqtt_con_flags;\r\nguint64 msg_len = 0;\r\ngint mqtt_msg_len = 0;\r\nguint16 mqtt_str_len;\r\nguint16 mqtt_len_offset;\r\nti = proto_tree_add_item(tree, proto_mqtt, tvb, 0, -1, ENC_NA);\r\nmqtt_tree = proto_item_add_subtree(ti, ett_mqtt_hdr);\r\nmqtt_len_offset = dissect_uleb128(tvb, (offset + MQTT_HDR_SIZE_BEFORE_LEN), &msg_len);\r\nmqtt_msg_len = (gint) msg_len;\r\nmqtt_msg_tree = proto_tree_add_subtree(mqtt_tree, tvb, offset, mqtt_msg_len, ett_mqtt_msg, NULL,\r\nval_to_str_ext(mqtt_msg_type, &mqtt_msgtype_vals_ext, "Unknown (0x%02x)"));\r\nti_mqtt = proto_tree_add_uint_format_value(mqtt_msg_tree, hf_mqtt_hdrflags, tvb, offset, 1, mqtt_fixed_hdr, "0x%02x (%s)",\r\nmqtt_fixed_hdr, val_to_str_ext(mqtt_msg_type, &mqtt_msgtype_vals_ext, "Unknown (0x%02x)") );\r\nmqtt_flag_tree = proto_item_add_subtree(ti_mqtt, ett_mqtt_hdr_flags);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_msg_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_dup_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_qos_level, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_retain, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_uint64(mqtt_msg_tree, hf_mqtt_msg_len, tvb, offset, mqtt_len_offset, msg_len);\r\noffset +=mqtt_len_offset;\r\nswitch(mqtt_msg_type)\r\n{\r\ncase MQTT_CONNECT:\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_proto_name, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_proto_ver, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nmqtt_con_flags = tvb_get_guint8(tvb, offset);\r\nti_mqtt = proto_tree_add_item(mqtt_msg_tree, hf_mqtt_conflags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nmqtt_flag_tree = proto_item_add_subtree(ti_mqtt, ett_mqtt_con_flags);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_user, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_passwd, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_will_retain, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_will_qos, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_will_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_clean_sess, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mqtt_flag_tree, hf_mqtt_conflag_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_keep_alive, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_client_id, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\nif(mqtt_con_flags & MQTT_CONMASK_WILLFLAG)\r\n{\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset +=2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_will_topic, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\n}\r\nif(mqtt_con_flags & MQTT_CONMASK_WILLFLAG)\r\n{\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_will_msg, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\n}\r\nif((mqtt_con_flags & MQTT_CONMASK_USER) && (tvb_reported_length_remaining(tvb, offset) > 0) )\r\n{\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_username, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\n}\r\nif((mqtt_con_flags & MQTT_CONMASK_PASSWD) && (tvb_reported_length_remaining(tvb, offset) > 0))\r\n{\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_passwd, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\n}\r\nbreak;\r\ncase MQTT_CONNACK:\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_conack, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MQTT_PUBLISH:\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nmqtt_msg_len -= 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_topic, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\nmqtt_msg_len -= mqtt_str_len;\r\nif(mqtt_fixed_hdr & MQTT_MASK_QOS)\r\n{\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_msgid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nmqtt_msg_len -=2;\r\n}\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_pubmsg, tvb, offset, mqtt_msg_len, ENC_UTF_8|ENC_NA);\r\nbreak;\r\ncase MQTT_SUBSCRIBE:\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_msgid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nfor( mqtt_msg_len -=2;mqtt_msg_len >0;)\r\n{\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nmqtt_msg_len -= 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_topic, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\nmqtt_msg_len -= mqtt_str_len;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_subqos, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nmqtt_msg_len -= 1;\r\n}\r\nbreak;\r\ncase MQTT_UNSUBSCRIBE:\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_msgid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nfor( mqtt_msg_len -=2;mqtt_msg_len >0;)\r\n{\r\nmqtt_str_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nmqtt_msg_len -= 2;\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_topic, tvb, offset, mqtt_str_len, ENC_UTF_8|ENC_NA);\r\noffset += mqtt_str_len;\r\nmqtt_msg_len -= mqtt_str_len;\r\n}\r\nbreak;\r\ncase MQTT_SUBACK:\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_msgid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nfor( mqtt_msg_len -=2; mqtt_msg_len > 0 ;mqtt_msg_len--)\r\n{\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_subqos, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\n}\r\nbreak;\r\ncase MQTT_PUBACK:\r\ncase MQTT_PUBREC:\r\ncase MQTT_PUBREL:\r\ncase MQTT_PUBCOMP:\r\ncase MQTT_UNSUBACK:\r\nproto_tree_add_item(mqtt_msg_tree, hf_mqtt_msgid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MQTT_PINGREQ:\r\ncase MQTT_PINGRESP:\r\ncase MQTT_DISCONNECT:\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int dissect_mqtt_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntcp_dissect_pdus(tvb, pinfo, tree,\r\nreassemble_mqtt_over_tcp,\r\n2,\r\nget_mqtt_pdu_len,\r\ndissect_mqtt, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_mqtt(void)\r\n{\r\nstatic hf_register_info hf_mqtt[] = {\r\n{ &hf_mqtt_msg_len,\r\n{ "Msg Len", "mqtt.len",\r\nFT_UINT64, BASE_DEC, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_hdrflags,\r\n{ "Header Flags", "mqtt.hdrflags",\r\nFT_UINT8, BASE_HEX, NULL, 0xFF,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_msg_type,\r\n{ "Message Type", "mqtt.msgtype",\r\nFT_UINT8, BASE_DEC | BASE_EXT_STRING, &mqtt_msgtype_vals_ext, MQTT_MASK_MSG_TYPE,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_dup_flag,\r\n{ "DUP Flag", "mqtt.dupflag",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_MASK_DUP_FLAG,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_qos_level,\r\n{ "QOS Level", "mqtt.qos",\r\nFT_UINT8, BASE_DEC, VALS(mqtt_qos_vals), MQTT_MASK_QOS,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_retain,\r\n{ "Retain", "mqtt.retain",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_MASK_RETAIN,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conack,\r\n{ "Connection Ack", "mqtt.conack.val",\r\nFT_UINT16, BASE_DEC, VALS(mqtt_conack_vals), MQTT_MASK_CONACK,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_msgid,\r\n{ "Message Identifier", "mqtt.msgid",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_subqos,\r\n{ "Granted Qos", "mqtt.suback.id",\r\nFT_UINT8, BASE_DEC, VALS(mqtt_qos_vals), MQTT_MASK_SUBQOS,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_topic,\r\n{ "Topic", "mqtt.topic",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_will_topic,\r\n{ "Will Topic", "mqtt.willtopic",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_will_msg,\r\n{ "Will Message", "mqtt.willmsg",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_username,\r\n{ "User Name", "mqtt.username",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_passwd,\r\n{ "Password", "mqtt.passwd",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_pubmsg,\r\n{ "Message", "mqtt.msg",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_proto_name,\r\n{ "Protocol Name", "mqtt.protoname",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_client_id,\r\n{ "Client ID", "mqtt.clientid",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_proto_ver,\r\n{ "Version", "mqtt.ver",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflags,\r\n{ "Connect Flags", "mqtt.conflags",\r\nFT_UINT8, BASE_HEX, NULL, 0xFF,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_user,\r\n{ "User Name Flag", "mqtt.conflag.uname",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_CONMASK_USER,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_passwd,\r\n{ "Password Flag", "mqtt.conflag.passwd",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_CONMASK_PASSWD,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_will_retain,\r\n{ "Will Retain", "mqtt.conflag.retain",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_CONMASK_RETAIN,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_will_qos,\r\n{ "QOS Level", "mqtt.conflag.qos",\r\nFT_UINT8, BASE_DEC, VALS(mqtt_qos_vals), MQTT_CONMASK_QOS,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_will_flag,\r\n{ "Will Flag", "mqtt.conflag.willflag",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_CONMASK_WILLFLAG,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_clean_sess,\r\n{ "Clean Session Flag", "mqtt.conflag.cleansess",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_CONMASK_CLEANSESS,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_conflag_reserved,\r\n{ "(Reserved)", "mqtt.conflag.reserved",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), MQTT_CONMASK_RESERVED,\r\nNULL, HFILL }},\r\n{ &hf_mqtt_keep_alive,\r\n{ "Keep Alive", "mqtt.kalive",\r\nFT_UINT16, BASE_DEC, NULL, 0,\r\nNULL, HFILL }}\r\n};\r\nstatic gint* ett_mqtt[] = {\r\n&ett_mqtt_hdr,\r\n&ett_mqtt_msg,\r\n&ett_mqtt_hdr_flags,\r\n&ett_mqtt_con_flags\r\n};\r\nproto_mqtt = proto_register_protocol("MQ Telemetry Transport Protocol", "MQTT", "mqtt");\r\nmqtt_handle = register_dissector("mqtt", dissect_mqtt_data, proto_mqtt);\r\nproto_register_field_array(proto_mqtt, hf_mqtt, array_length(hf_mqtt));\r\nproto_register_subtree_array(ett_mqtt, array_length(ett_mqtt));\r\n}\r\nvoid proto_reg_handoff_mqtt(void)\r\n{\r\ndissector_add_uint("tcp.port", MQTT_DEFAULT_PORT, mqtt_handle);\r\nssl_dissector_add(MQTT_SSL_DEFAULT_PORT, mqtt_handle);\r\n}

static void\r\npdu_attrs_tree(proto_tree* tree, packet_info *pinfo, tvbuff_t *tvb, mate_pdu* pdu)\r\n{\r\nAVPN* c;\r\nproto_tree *avpl_t;\r\nint* hfi_p;\r\navpl_t = proto_tree_add_subtree_format(tree,tvb,0,0,pdu->cfg->ett_attr,NULL,"%s Attributes",pdu->cfg->name);\r\nfor ( c = pdu->avpl->null.next; c->avp; c = c->next) {\r\nhfi_p = (int *)g_hash_table_lookup(pdu->cfg->my_hfids,(char*)c->avp->n);\r\nif (hfi_p) {\r\nproto_tree_add_string(avpl_t,*hfi_p,tvb,0,0,c->avp->v);\r\n} else {\r\nproto_tree_add_expert_format(avpl_t,pinfo,&ei_mate_undefined_attribute,tvb,0,0,"Undefined attribute: %s=%s",c->avp->n, c->avp->v);\r\n}\r\n}\r\n}\r\nstatic void\r\ngop_attrs_tree(proto_tree* tree, packet_info *pinfo, tvbuff_t *tvb, mate_gop* gop)\r\n{\r\nAVPN* c;\r\nproto_tree *avpl_t;\r\nint* hfi_p;\r\navpl_t = proto_tree_add_subtree_format(tree,tvb,0,0,gop->cfg->ett_attr,NULL,"%s Attributes",gop->cfg->name);\r\nfor ( c = gop->avpl->null.next; c->avp; c = c->next) {\r\nhfi_p = (int *)g_hash_table_lookup(gop->cfg->my_hfids,(char*)c->avp->n);\r\nif (hfi_p) {\r\nproto_tree_add_string(avpl_t,*hfi_p,tvb,0,0,c->avp->v);\r\n} else {\r\nproto_tree_add_expert_format(avpl_t,pinfo,&ei_mate_undefined_attribute,tvb,0,0,"Undefined attribute: %s=%s",c->avp->n, c->avp->v);\r\n}\r\n}\r\n}\r\nstatic void\r\ngog_attrs_tree(proto_tree* tree, packet_info *pinfo, tvbuff_t *tvb, mate_gog* gog)\r\n{\r\nAVPN* c;\r\nproto_tree *avpl_t;\r\nint* hfi_p;\r\navpl_t = proto_tree_add_subtree_format(tree,tvb,0,0,gog->cfg->ett_attr,NULL,"%s Attributes",gog->cfg->name);\r\nfor ( c = gog->avpl->null.next; c->avp; c = c->next) {\r\nhfi_p = (int *)g_hash_table_lookup(gog->cfg->my_hfids,(char*)c->avp->n);\r\nif (hfi_p) {\r\nproto_tree_add_string(avpl_t,*hfi_p,tvb,0,0,c->avp->v);\r\n} else {\r\nproto_tree_add_expert_format(avpl_t,pinfo,&ei_mate_undefined_attribute,tvb,0,0,"Undefined attribute: %s=%s",c->avp->n, c->avp->v);\r\n}\r\n}\r\n}\r\nstatic void\r\nmate_gog_tree(proto_tree* tree, packet_info *pinfo, tvbuff_t *tvb, mate_gog* gog, mate_gop* gop)\r\n{\r\nproto_item *gog_item;\r\nproto_tree *gog_tree;\r\nproto_tree *gog_time_tree;\r\nproto_item *gog_gops_item;\r\nproto_tree *gog_gops_tree;\r\nmate_gop* gog_gops;\r\nproto_item *gog_gop_item;\r\nproto_tree *gog_gop_tree;\r\nmate_pdu* pdu;\r\ngog_item = proto_tree_add_uint(tree,gog->cfg->hfid,tvb,0,0,gog->id);\r\ngog_tree = proto_item_add_subtree(gog_item,gog->cfg->ett);\r\ngog_attrs_tree(gog_tree,pinfo,tvb,gog);\r\nif (gog->cfg->show_times) {\r\ngog_time_tree = proto_tree_add_subtree_format(gog_tree,tvb,0,0,gog->cfg->ett_times,NULL,"%s Times",gog->cfg->name);\r\nproto_tree_add_float(gog_time_tree, gog->cfg->hfid_start_time, tvb, 0, 0, gog->start_time);\r\nproto_tree_add_float(gog_time_tree, gog->cfg->hfid_last_time, tvb, 0, 0, gog->last_time - gog->start_time);\r\n}\r\ngog_gops_item = proto_tree_add_uint(gog_tree, gog->cfg->hfid_gog_num_of_gops, tvb, 0, 0, gog->num_of_gops);\r\ngog_gops_tree = proto_item_add_subtree(gog_gops_item, gog->cfg->ett_children);\r\nfor (gog_gops = gog->gops; gog_gops; gog_gops = gog_gops->next) {\r\nif (gop != gog_gops) {\r\nif (gog->cfg->gop_tree_mode == GOP_FULL_TREE) {\r\nmate_gop_tree(gog_gops_tree, pinfo, tvb, gog_gops);\r\n} else {\r\ngog_gop_item = proto_tree_add_uint(gog_gops_tree,gog_gops->cfg->hfid,tvb,0,0,gog_gops->id);\r\nif (gog->cfg->gop_tree_mode == GOP_BASIC_TREE) {\r\ngog_gop_tree = proto_item_add_subtree(gog_gop_item, gog->cfg->ett_gog_gop);\r\nproto_tree_add_float(gog_gop_tree, hf_mate_started_at, tvb,0,0,gog_gops->start_time);\r\nproto_tree_add_float_format(gog_gop_tree, hf_mate_duration, tvb,0,0, gog_gops->last_time - gog_gops->start_time,\r\n"%s Duration: %f", gog_gops->cfg->name, gog_gops->last_time - gog_gops->start_time);\r\nif (gog_gops->released)\r\nproto_tree_add_float_format(gog_gop_tree, hf_mate_released_time, tvb,0,0, gog_gops->release_time - gog_gops->start_time,\r\n"%s has been released, Time: %f", gog_gops->cfg->name, gog_gops->release_time - gog_gops->start_time);\r\nproto_tree_add_uint(gog_gop_tree, hf_mate_number_of_pdus, tvb,0,0, gog_gops->num_of_pdus);\r\nif (gop->pdus && gop->cfg->pdu_tree_mode != GOP_NO_TREE) {\r\nproto_tree_add_uint(gog_gop_tree,gog->cfg->hfid_gog_gopstart,tvb,0,0,gog_gops->pdus->frame);\r\nfor (pdu = gog_gops->pdus->next ; pdu; pdu = pdu->next) {\r\nif (pdu->is_stop) {\r\nproto_tree_add_uint(gog_gop_tree,gog->cfg->hfid_gog_gopstop,tvb,0,0,pdu->frame);\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\nproto_tree_add_uint_format(gog_gops_tree,gop->cfg->hfid,tvb,0,0,gop->id,"current %s Gop: %d",gop->cfg->name,gop->id);\r\n}\r\n}\r\n}\r\nstatic void\r\nmate_gop_tree(proto_tree* tree, packet_info *pinfo, tvbuff_t *tvb, mate_gop* gop)\r\n{\r\nproto_item *gop_item;\r\nproto_tree *gop_time_tree;\r\nproto_tree *gop_tree;\r\nproto_item *gop_pdu_item;\r\nproto_tree *gop_pdu_tree;\r\nmate_pdu* gop_pdus;\r\nfloat rel_time;\r\nfloat pdu_rel_time;\r\nconst gchar* pdu_str;\r\nconst gchar* type_str;\r\nguint32 pdu_item;\r\ngop_item = proto_tree_add_uint(tree,gop->cfg->hfid,tvb,0,0,gop->id);\r\ngop_tree = proto_item_add_subtree(gop_item, gop->cfg->ett);\r\nif (gop->gop_key) proto_tree_add_string(gop_tree,hf_mate_gop_key,tvb,0,0,gop->gop_key);\r\ngop_attrs_tree(gop_tree,pinfo,tvb,gop);\r\nif (gop->cfg->show_times) {\r\ngop_time_tree = proto_tree_add_subtree_format(gop_tree,tvb,0,0,gop->cfg->ett_times,NULL,"%s Times",gop->cfg->name);\r\nproto_tree_add_float(gop_time_tree, gop->cfg->hfid_start_time, tvb, 0, 0, gop->start_time);\r\nif (gop->released) {\r\nproto_tree_add_float(gop_time_tree, gop->cfg->hfid_stop_time, tvb, 0, 0, gop->release_time - gop->start_time);\r\nproto_tree_add_float(gop_time_tree, gop->cfg->hfid_last_time, tvb, 0, 0, gop->last_time - gop->start_time);\r\n} else {\r\nproto_tree_add_float(gop_time_tree, gop->cfg->hfid_last_time, tvb, 0, 0, gop->last_time - gop->start_time);\r\n}\r\n}\r\ngop_pdu_item = proto_tree_add_uint(gop_tree, gop->cfg->hfid_gop_num_pdus, tvb, 0, 0,gop->num_of_pdus);\r\nif (gop->cfg->pdu_tree_mode != GOP_NO_TREE) {\r\ngop_pdu_tree = proto_item_add_subtree(gop_pdu_item, gop->cfg->ett_children);\r\nrel_time = gop->start_time;\r\ntype_str = (gop->cfg->pdu_tree_mode == GOP_FRAME_TREE ) ? "in frame:" : "id:";\r\nfor (gop_pdus = gop->pdus; gop_pdus; gop_pdus = gop_pdus->next) {\r\npdu_item = (gop->cfg->pdu_tree_mode == GOP_FRAME_TREE ) ? gop_pdus->frame : gop_pdus->id;\r\nif (gop_pdus->is_start) {\r\npdu_str = "Start ";\r\n} else if (gop_pdus->is_stop) {\r\npdu_str = "Stop ";\r\n} else if (gop_pdus->after_release) {\r\npdu_str = "After stop ";\r\n} else {\r\npdu_str = "";\r\n}\r\npdu_rel_time = gop_pdus->time_in_gop != 0.0 ? gop_pdus->time_in_gop - rel_time : (float) 0.0;\r\nproto_tree_add_uint_format(gop_pdu_tree,gop->cfg->hfid_gop_pdu,tvb,0,0,pdu_item,\r\n"%sPDU: %s %i (%f : %f)",pdu_str, type_str,\r\npdu_item, gop_pdus->time_in_gop,\r\npdu_rel_time);\r\nrel_time = gop_pdus->time_in_gop;\r\n}\r\n}\r\n}\r\nstatic void\r\nmate_pdu_tree(mate_pdu *pdu, packet_info *pinfo, tvbuff_t *tvb, proto_tree* tree)\r\n{\r\nproto_item *pdu_item;\r\nproto_tree *pdu_tree;\r\nif ( ! pdu ) return;\r\nif (pdu->gop && pdu->gop->gog) {\r\nproto_item_append_text(mate_i," %s:%d->%s:%d->%s:%d",\r\npdu->cfg->name,pdu->id,\r\npdu->gop->cfg->name,pdu->gop->id,\r\npdu->gop->gog->cfg->name,pdu->gop->gog->id);\r\n} else if (pdu->gop) {\r\nproto_item_append_text(mate_i," %s:%d->%s:%d",\r\npdu->cfg->name,pdu->id,\r\npdu->gop->cfg->name,pdu->gop->id);\r\n} else {\r\nproto_item_append_text(mate_i," %s:%d",pdu->cfg->name,pdu->id);\r\n}\r\npdu_item = proto_tree_add_uint(tree,pdu->cfg->hfid,tvb,0,0,pdu->id);\r\npdu_tree = proto_item_add_subtree(pdu_item, pdu->cfg->ett);\r\nproto_tree_add_float(pdu_tree,pdu->cfg->hfid_pdu_rel_time, tvb, 0, 0, pdu->rel_time);\r\nif (pdu->gop) {\r\nproto_tree_add_float(pdu_tree,pdu->cfg->hfid_pdu_time_in_gop, tvb, 0, 0, pdu->time_in_gop);\r\nmate_gop_tree(tree,pinfo,tvb,pdu->gop);\r\nif (pdu->gop->gog)\r\nmate_gog_tree(tree,pinfo,tvb,pdu->gop->gog,pdu->gop);\r\n}\r\nif (pdu->avpl) {\r\npdu_attrs_tree(pdu_tree,pinfo,tvb,pdu);\r\n}\r\n}\r\nstatic int\r\nmate_tree(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nmate_pdu* pdus;\r\nproto_tree *mate_t;\r\nif ( ! mc || ! tree )\r\nreturn tvb_captured_length(tvb);\r\nmate_analyze_frame(pinfo,tree);\r\nif (( pdus = mate_get_pdus(pinfo->num) )) {\r\nfor ( ; pdus; pdus = pdus->next_in_frame) {\r\nmate_i = proto_tree_add_protocol_format(tree,mc->hfid_mate,tvb,0,0,"MATE");\r\nmate_t = proto_item_add_subtree(mate_i, mc->ett_root);\r\nmate_pdu_tree(pdus,pinfo,tvb,mate_t);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\nmate_packet(void *prs _U_, packet_info* tree _U_, epan_dissect_t *edt _U_, const void *dummy _U_)\r\n{\r\nreturn 0;\r\n}\r\nextern\r\nvoid\r\nproto_reg_handoff_mate(void)\r\n{\r\nGString* tap_error = NULL;\r\nif ( *pref_mate_config_filename != '\0' ) {\r\nif (current_mate_config_filename) {\r\nreport_failure("MATE cannot reconfigure itself.\n"\r\n"For changes to be applied you have to restart Wireshark\n");\r\nreturn;\r\n}\r\nif (!mc) {\r\nmc = mate_make_config(pref_mate_config_filename,proto_mate);\r\nif (mc) {\r\nproto_register_field_array(proto_mate, (hf_register_info*)(void *)mc->hfrs->data, mc->hfrs->len );\r\nproto_register_subtree_array((gint**)(void*)mc->ett->data, mc->ett->len);\r\nregister_init_routine(initialize_mate_runtime);\r\ntap_error = register_tap_listener("frame", &mate_tap_data,\r\n(char*) mc->tap_filter,\r\n0,\r\n(tap_reset_cb) NULL,\r\nmate_packet,\r\n(tap_draw_cb) NULL);\r\nif ( tap_error ) {\r\ng_warning("mate: couldn't (re)register tap: %s",tap_error->str);\r\ng_string_free(tap_error, TRUE);\r\nmate_tap_data = 0;\r\nreturn;\r\n}\r\ninitialize_mate_runtime();\r\n}\r\ncurrent_mate_config_filename = pref_mate_config_filename;\r\n}\r\n}\r\n}\r\nextern\r\nvoid\r\nproto_register_mate(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_mate_started_at, { "Started at", "mate.started_at", FT_FLOAT, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_mate_duration, { "Duration", "mate.duration", FT_FLOAT, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_mate_released_time, { "Release time", "mate.released_time", FT_FLOAT, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_mate_number_of_pdus, { "Number of Pdus", "mate.number_of_pdus", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_mate_gop_key, { "GOP Key", "mate.gop_key", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_mate_undefined_attribute, { "mate.undefined_attribute", PI_PROTOCOL, PI_ERROR, "Undefined attribute", EXPFILL }},\r\n};\r\nexpert_module_t* expert_mate;\r\nmodule_t *mate_module;\r\ndissector_handle_t mate_handle;\r\nproto_mate = proto_register_protocol("Meta Analysis Tracing Engine", "MATE", "mate");\r\nproto_register_field_array(proto_mate, hf, array_length(hf));\r\nexpert_mate = expert_register_protocol(proto_mate);\r\nexpert_register_field_array(expert_mate, ei, array_length(ei));\r\nmate_handle = register_dissector("mate",mate_tree,proto_mate);\r\nmate_module = prefs_register_protocol(proto_mate, proto_reg_handoff_mate);\r\nprefs_register_filename_preference(mate_module, "config",\r\n"Configuration Filename",\r\n"The name of the file containing the mate module's configuration",\r\n&pref_mate_config_filename);\r\nregister_postdissector(mate_handle);\r\n}

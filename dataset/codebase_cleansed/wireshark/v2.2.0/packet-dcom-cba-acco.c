static gboolean\r\ncba_filter_valid(packet_info *pinfo)\r\n{\r\nvoid* profinet_type = p_get_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0);\r\nreturn ((profinet_type != NULL) && (GPOINTER_TO_UINT(profinet_type) < 10));\r\n}\r\nstatic gchar*\r\ncba_build_filter(packet_info *pinfo)\r\n{\r\ngboolean is_tcp = proto_is_frame_protocol(pinfo->layers, "tcp");\r\nvoid* profinet_type = p_get_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0);\r\nif ((pinfo->net_src.type == AT_IPv4) && (pinfo->net_dst.type == AT_IPv4) && is_tcp) {\r\nswitch(GPOINTER_TO_UINT(profinet_type)) {\r\ncase 1:\r\nreturn g_strdup_printf("(ip.src eq %s and ip.dst eq %s and cba.acco.dcom == 1) || (ip.src eq %s and ip.dst eq %s and cba.acco.dcom == 0)",\r\naddress_to_str(pinfo->pool, &pinfo->net_dst),\r\naddress_to_str(pinfo->pool, &pinfo->net_src),\r\naddress_to_str(pinfo->pool, &pinfo->net_src),\r\naddress_to_str(pinfo->pool, &pinfo->net_dst));\r\ncase 2:\r\nreturn g_strdup_printf("(ip.src eq %s and ip.dst eq %s and cba.acco.dcom == 1) || (ip.src eq %s and ip.dst eq %s and cba.acco.dcom == 0)",\r\naddress_to_str(pinfo->pool, &pinfo->net_src),\r\naddress_to_str(pinfo->pool, &pinfo->net_dst),\r\naddress_to_str(pinfo->pool, &pinfo->net_dst),\r\naddress_to_str(pinfo->pool, &pinfo->net_src));\r\ncase 3:\r\nreturn g_strdup_printf("(ip.src eq %s and ip.dst eq %s and cba.acco.srt == 1) || (ip.src eq %s and ip.dst eq %s and cba.acco.srt == 0)",\r\naddress_to_str(pinfo->pool, &pinfo->net_dst),\r\naddress_to_str(pinfo->pool, &pinfo->net_src),\r\naddress_to_str(pinfo->pool, &pinfo->net_src),\r\naddress_to_str(pinfo->pool, &pinfo->net_dst));\r\ncase 4:\r\nreturn g_strdup_printf("(ip.src eq %s and ip.dst eq %s and cba.acco.srt == 1) || (ip.src eq %s and ip.dst eq %s and cba.acco.srt == 0)",\r\naddress_to_str(pinfo->pool, &pinfo->net_src),\r\naddress_to_str(pinfo->pool, &pinfo->net_dst),\r\naddress_to_str(pinfo->pool, &pinfo->net_dst),\r\naddress_to_str(pinfo->pool, &pinfo->net_src));\r\ndefault:\r\nreturn NULL;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\ncba_pdev_t *\r\ncba_pdev_find(packet_info *pinfo, const address *addr, e_guid_t *ipid)\r\n{\r\ncba_pdev_t *pdev;\r\ndcom_interface_t *interf;\r\ninterf = dcom_interface_find(pinfo, addr, ipid);\r\nif (interf != NULL) {\r\npdev = (cba_pdev_t *)interf->parent->private_data;\r\nif (pdev == NULL) {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_pdev_find, "pdev_find: no pdev for IP:%s IPID:%s",\r\naddress_to_str(wmem_packet_scope(), addr), guids_resolve_guid_to_str(ipid));\r\n}\r\n} else {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_pdev_find_unknown_interface, "pdev_find: unknown interface of IP:%s IPID:%s",\r\naddress_to_str(wmem_packet_scope(), addr), guids_resolve_guid_to_str(ipid));\r\npdev = NULL;\r\n}\r\nreturn pdev;\r\n}\r\ncba_pdev_t *\r\ncba_pdev_add(packet_info *pinfo, const address *addr)\r\n{\r\nGList *cba_iter;\r\ncba_pdev_t *pdev;\r\nfor(cba_iter = cba_pdevs; cba_iter != NULL; cba_iter = g_list_next(cba_iter)) {\r\npdev = (cba_pdev_t *)cba_iter->data;\r\nif (memcmp(pdev->ip, addr->data, 4) == 0) {\r\nreturn pdev;\r\n}\r\n}\r\npdev = (cba_pdev_t *)wmem_alloc(wmem_file_scope(), sizeof(cba_pdev_t));\r\nmemcpy( (void *) (pdev->ip), addr->data, 4);\r\npdev->first_packet = pinfo->num;\r\npdev->ldevs = NULL;\r\npdev->object = NULL;\r\ncba_pdevs = g_list_append(cba_pdevs, pdev);\r\nreturn pdev;\r\n}\r\nvoid\r\ncba_pdev_link(packet_info *pinfo _U_, cba_pdev_t *pdev, dcom_interface_t *pdev_interf)\r\n{\r\npdev->object = pdev_interf->parent;\r\npdev_interf->private_data = pdev;\r\nif (pdev_interf->parent) {\r\npdev_interf->parent->private_data = pdev;\r\n}\r\n}\r\nvoid\r\ncba_ldev_link(packet_info *pinfo _U_, cba_ldev_t *ldev, dcom_interface_t *ldev_interf)\r\n{\r\nldev->ldev_object = ldev_interf->parent;\r\nldev_interf->private_data = ldev;\r\nif (ldev_interf->parent) {\r\nldev_interf->parent->private_data = ldev;\r\n}\r\n}\r\nvoid\r\ncba_ldev_link_acco(packet_info *pinfo _U_, cba_ldev_t *ldev, dcom_interface_t *acco_interf)\r\n{\r\nldev->acco_object = acco_interf->parent;\r\nacco_interf->private_data = ldev;\r\nif (acco_interf->parent) {\r\nacco_interf->parent->private_data = ldev;\r\n}\r\n}\r\ncba_ldev_t *\r\ncba_ldev_add(packet_info *pinfo, cba_pdev_t *pdev, const char *name)\r\n{\r\nGList *cba_iter;\r\ncba_ldev_t *ldev;\r\nfor(cba_iter = pdev->ldevs; cba_iter != NULL; cba_iter = g_list_next(cba_iter)) {\r\nldev = (cba_ldev_t *)cba_iter->data;\r\nif (strcmp(ldev->name, name) == 0) {\r\nreturn ldev;\r\n}\r\n}\r\nldev = (cba_ldev_t *)wmem_alloc(wmem_file_scope(), sizeof(cba_ldev_t));\r\nldev->name = wmem_strdup(wmem_file_scope(), name);\r\nldev->first_packet = pinfo->num;\r\nldev->ldev_object = NULL;\r\nldev->acco_object = NULL;\r\nldev->parent = pdev;\r\nldev->provframes = NULL;\r\nldev->consframes = NULL;\r\nldev->provconns = NULL;\r\nldev->consconns = NULL;\r\npdev->ldevs = g_list_append(pdev->ldevs, ldev);\r\nreturn ldev;\r\n}\r\ncba_ldev_t *\r\ncba_ldev_find(packet_info *pinfo, const address *addr, e_guid_t *ipid) {\r\ndcom_interface_t *interf;\r\ncba_ldev_t *ldev;\r\ninterf = dcom_interface_find(pinfo, addr, ipid);\r\nif (interf != NULL) {\r\nldev = (cba_ldev_t *)interf->private_data;\r\nif (ldev == NULL) {\r\nldev = (cba_ldev_t *)interf->parent->private_data;\r\n}\r\nif (ldev == NULL) {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_ldev_unknown, "Unknown LDev of %s",\r\naddress_to_str(wmem_packet_scope(), addr));\r\n}\r\n} else {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_ipid_unknown, "Unknown IPID of %s",\r\naddress_to_str(wmem_packet_scope(), addr));\r\nldev = NULL;\r\n}\r\nreturn ldev;\r\n}\r\nstatic cba_ldev_t *\r\ncba_acco_add(packet_info *pinfo, const char *acco)\r\n{\r\nchar *ip_str;\r\nchar *delim;\r\nguint32 ip;\r\ncba_pdev_t *pdev;\r\ncba_ldev_t *ldev;\r\naddress addr;\r\nip_str = g_strdup(acco);\r\ndelim = strchr(ip_str, '!');\r\nif (delim == NULL) {\r\ng_free(ip_str);\r\nreturn NULL;\r\n}\r\n*delim = 0;\r\nif (!get_host_ipaddr(ip_str, &ip)) {\r\ng_free(ip_str);\r\nreturn NULL;\r\n}\r\nset_address(&addr, AT_IPv4, 4, &ip);\r\npdev = cba_pdev_add(pinfo, &addr);\r\ndelim++;\r\nldev = cba_ldev_add(pinfo, pdev, delim);\r\ng_free(ip_str);\r\nreturn ldev;\r\n}\r\nstatic gboolean\r\ncba_packet_in_range(packet_info *pinfo, guint packet_connect, guint packet_disconnect, guint packet_disconnectme)\r\n{\r\nif (packet_connect == 0) {\r\ng_warning("cba_packet_in_range#%u: packet_connect not set?", pinfo->num);\r\n}\r\nif (packet_connect == 0 || pinfo->num < packet_connect) {\r\nreturn FALSE;\r\n}\r\nif (packet_disconnect != 0 && pinfo->num > packet_disconnect) {\r\nreturn FALSE;\r\n}\r\nif (packet_disconnectme != 0 && pinfo->num > packet_disconnectme) {\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic void\r\ncba_frame_info(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, cba_frame_t *frame)\r\n{\r\nif (tree) {\r\nproto_item *item;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_tree = proto_tree_add_subtree_format(tree, tvb, 0, 0, ett_cba_frame_info, &sub_item,\r\n"Cons:\"%s\" CCRID:0x%x Prov:\"%s\" PCRID:0x%x QoS:%s/%ums Len:%u",\r\nframe->consparent ? frame->consparent->name : "", frame->conscrid,\r\nframe->provparent ? frame->provparent->name : "", frame->provcrid,\r\nval_to_str(frame->qostype, cba_qos_type_short_vals, "%u"),\r\nframe->qosvalue, frame->length);\r\nPROTO_ITEM_SET_GENERATED(sub_item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_conn_qos_type, tvb, 0, 0, frame->qostype);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_conn_qos_value, tvb, 0, 0, frame->qosvalue);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_serversrt_cr_id, tvb, 0, 0, frame->conscrid);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_prov_crid, tvb, 0, 0, frame->provcrid);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_serversrt_cr_length, tvb, 0, 0, frame->length);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nif (frame->consparent != NULL) {\r\nitem = proto_tree_add_string(sub_tree, hf_cba_acco_conn_consumer, tvb, 0, 0, frame->consparent->name);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\nif (frame->provparent != NULL) {\r\nitem = proto_tree_add_string(sub_tree, hf_cba_acco_conn_provider, tvb, 0, 0, frame->provparent->name);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_connectcr_in,\r\ntvb, 0, 0, frame->packet_connect);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_data_first_in,\r\ntvb, 0, 0, frame->packet_first);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_data_last_in,\r\ntvb, 0, 0, frame->packet_last);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_disconnectcr_in,\r\ntvb, 0, 0, frame->packet_disconnect);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_disconnectme_in,\r\ntvb, 0, 0, frame->packet_disconnectme);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\n}\r\nstatic cba_frame_t *\r\ncba_frame_connect(packet_info *pinfo, cba_ldev_t *cons_ldev, cba_ldev_t *prov_ldev,\r\nguint16 qostype, guint16 qosvalue, const guint8 *consmac, guint16 conscrid, guint16 length)\r\n{\r\nGList *cba_iter;\r\ncba_frame_t *frame;\r\nfor(cba_iter = cons_ldev->consframes; cba_iter != NULL; cba_iter = g_list_next(cba_iter)) {\r\nframe = (cba_frame_t *)cba_iter->data;\r\nif ( frame->conscrid == conscrid &&\r\nmemcmp(frame->consmac, consmac, 6) == 0 &&\r\ncba_packet_in_range(pinfo, frame->packet_connect, frame->packet_disconnect, frame->packet_disconnectme)) {\r\nreturn frame;\r\n}\r\n}\r\nframe = (cba_frame_t *)wmem_alloc(wmem_file_scope(), sizeof(cba_frame_t));\r\nframe->consparent = cons_ldev;\r\nframe->provparent = prov_ldev;\r\nframe->packet_connect = pinfo->num;\r\nframe->packet_disconnect = 0;\r\nframe->packet_disconnectme = 0;\r\nframe->packet_first = 0;\r\nframe->packet_last = 0;\r\nframe->length = length;\r\nmemcpy( (guint8 *) (frame->consmac), consmac, sizeof(frame->consmac));\r\nframe->conscrid = conscrid;\r\nframe->qostype = qostype;\r\nframe->qosvalue = qosvalue;\r\nframe->offset = 4;\r\nframe->conns = NULL;\r\nframe->provcrid = 0;\r\nframe->conncrret = -1;\r\ncons_ldev->consframes = g_list_append(cons_ldev->consframes, frame);\r\nprov_ldev->provframes = g_list_append(prov_ldev->provframes, frame);\r\nreturn frame;\r\n}\r\nstatic void\r\ncba_frame_disconnect(packet_info *pinfo, cba_frame_t *frame)\r\n{\r\nif (frame->packet_disconnect == 0) {\r\nframe->packet_disconnect = pinfo->num;\r\n}\r\nif (frame->packet_disconnect != pinfo->num) {\r\ng_warning("cba_frame_disconnect#%u: frame already disconnected in #%u",\r\npinfo->num, frame->packet_disconnect);\r\n}\r\n}\r\nstatic void\r\ncba_frame_disconnectme(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, cba_ldev_t *cons_ldev, cba_ldev_t *prov_ldev)\r\n{\r\nGList *frames;\r\ncba_frame_t *frame;\r\nfor(frames = cons_ldev->consframes; frames != NULL; frames = g_list_next(frames)) {\r\nframe = (cba_frame_t *)frames->data;\r\nif ( frame->provparent == prov_ldev &&\r\ncba_packet_in_range(pinfo, frame->packet_connect, frame->packet_disconnect, frame->packet_disconnectme)) {\r\ncba_frame_info(tvb, pinfo, tree, frame);\r\nif (frame->packet_disconnectme == 0) {\r\nframe->packet_disconnectme = pinfo->num;\r\n}\r\nif (frame->packet_disconnectme != pinfo->num) {\r\ng_warning("cba_frame_disconnectme#%u: frame already disconnectme'd in #%u",\r\npinfo->num, frame->packet_disconnectme);\r\n}\r\n}\r\n}\r\n}\r\nstatic cba_frame_t *\r\ncba_frame_find_by_cons(packet_info *pinfo, const guint8 *consmac, guint16 conscrid)\r\n{\r\nGList *pdevs;\r\nGList *ldevs;\r\nGList *frames;\r\ncba_pdev_t *pdev;\r\ncba_ldev_t *ldev;\r\ncba_frame_t *frame;\r\nfor(pdevs = cba_pdevs; pdevs != NULL; pdevs = g_list_next(pdevs)) {\r\npdev = (cba_pdev_t *)pdevs->data;\r\nfor(ldevs = pdev->ldevs; ldevs != NULL; ldevs = g_list_next(ldevs)) {\r\nldev = (cba_ldev_t *)ldevs->data;\r\nfor(frames = ldev->consframes; frames != NULL; frames = g_list_next(frames)) {\r\nframe = (cba_frame_t *)frames->data;\r\nif ( frame->conscrid == conscrid &&\r\nmemcmp(frame->consmac, consmac, 6) == 0 &&\r\ncba_packet_in_range(pinfo, frame->packet_connect, frame->packet_disconnect, frame->packet_disconnectme)) {\r\nreturn frame;\r\n}\r\n}\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic cba_frame_t *\r\ncba_frame_find_by_provcrid(packet_info *pinfo, cba_ldev_t *prov_ldev, guint32 provcrid)\r\n{\r\nGList *frames;\r\ncba_frame_t *frame;\r\nif (prov_ldev == NULL) {\r\nreturn NULL;\r\n}\r\nfor(frames = prov_ldev->provframes; frames != NULL; frames = g_list_next(frames)) {\r\nframe = (cba_frame_t *)frames->data;\r\nif ( frame->provcrid == provcrid &&\r\ncba_packet_in_range(pinfo, frame->packet_connect, frame->packet_disconnect, frame->packet_disconnectme)) {\r\nreturn frame;\r\n}\r\n}\r\nexpert_add_info(pinfo, NULL, &ei_cba_acco_prov_crid);\r\nreturn NULL;\r\n}\r\nstatic void\r\ncba_frame_incoming_data(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, cba_frame_t *frame)\r\n{\r\nif (frame->packet_first == 0) {\r\nframe->packet_first = pinfo->num;\r\n}\r\nif ( pinfo->num > frame->packet_last &&\r\ncba_packet_in_range(pinfo, frame->packet_connect, frame->packet_disconnect, frame->packet_disconnectme)) {\r\nframe->packet_last = pinfo->num;\r\n}\r\n}\r\nstatic void\r\ncba_connection_info(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, cba_connection_t *conn)\r\n{\r\nif (tree) {\r\nproto_item *item;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nif (conn->qostype != 0x30) {\r\nsub_tree = proto_tree_add_subtree_format(tree, tvb, 0, 0, ett_cba_conn_info, &sub_item,\r\n"ProvItem:\"%s\" PID:0x%x CID:0x%x QoS:%s/%ums",\r\nconn->provitem, conn->provid, conn->consid,\r\nval_to_str(conn->qostype, cba_qos_type_short_vals, "%u"), conn->qosvalue);\r\n} else {\r\nsub_tree = proto_tree_add_subtree_format(tree, tvb, 0, 0, ett_cba_conn_info, &sub_item,\r\n"ProvItem:\"%s\" PID:0x%x CID:0x%x Len:%u",\r\nconn->provitem, conn->provid, conn->consid, conn->length);\r\n}\r\nPROTO_ITEM_SET_GENERATED(sub_item);\r\nitem = proto_tree_add_string(sub_tree, hf_cba_acco_conn_provider_item, tvb, 0, 0 , conn->provitem);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_conn_prov_id, tvb, 0, 0 , conn->provid);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_conn_cons_id, tvb, 0, 0 , conn->consid);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_serversrt_record_length, tvb, 0, 0 , conn->length);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nif (conn->qostype != 0x30) {\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_conn_qos_type,\r\ntvb, 0, 0, conn->qostype);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_acco_conn_qos_value,\r\ntvb, 0, 0, conn->qosvalue);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_connect_in,\r\ntvb, 0, 0, conn->packet_connect);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_data_first_in,\r\ntvb, 0, 0, conn->packet_first);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_data_last_in,\r\ntvb, 0, 0, conn->packet_last);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_disconnect_in,\r\ntvb, 0, 0, conn->packet_disconnect);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nitem = proto_tree_add_uint(sub_tree, hf_cba_disconnectme_in,\r\ntvb, 0, 0, conn->packet_disconnectme);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\n}\r\n}\r\nstatic cba_connection_t *\r\ncba_connection_connect(packet_info *pinfo, cba_ldev_t *cons_ldev, cba_ldev_t *prov_ldev, cba_frame_t *cons_frame,\r\nguint16 qostype, guint16 qosvalue, const char *provitem, guint32 consid, guint16 length,\r\nguint16 *typedesc, guint16 typedesclen)\r\n{\r\nGList *cba_iter;\r\ncba_connection_t *conn;\r\nif (cons_frame != NULL) {\r\nfor(cba_iter = cons_frame->conns; cba_iter != NULL; cba_iter = g_list_next(cba_iter)) {\r\nconn = (cba_connection_t *)cba_iter->data;\r\nif (conn->consid == consid) {\r\nreturn conn;\r\n}\r\n}\r\n} else {\r\nfor(cba_iter = cons_ldev->consconns; cba_iter != NULL; cba_iter = g_list_next(cba_iter)) {\r\nconn = (cba_connection_t *)cba_iter->data;\r\nif ( conn->consid == consid &&\r\ncba_packet_in_range(pinfo, conn->packet_connect, conn->packet_disconnect, conn->packet_disconnectme)) {\r\nreturn conn;\r\n}\r\n}\r\n}\r\nconn = (cba_connection_t *)wmem_alloc(wmem_file_scope(), sizeof(cba_connection_t));\r\nconn->consparentacco = cons_ldev;\r\nconn->provparentacco = prov_ldev;\r\nconn->parentframe = cons_frame;\r\nconn->packet_connect = pinfo->num;\r\nconn->packet_disconnect = 0;\r\nconn->packet_disconnectme = 0;\r\nconn->packet_first = 0;\r\nconn->packet_last = 0;\r\nconn->consid = consid;\r\nconn->provitem = wmem_strdup(wmem_file_scope(), provitem);\r\nconn->typedesclen = typedesclen;\r\nconn->typedesc = typedesc;\r\nconn->qostype = qostype;\r\nconn->qosvalue = qosvalue;\r\nconn->length = length;\r\nconn->provid = 0;\r\nconn->connret = -1;\r\nif (cons_frame != NULL) {\r\nconn->frame_offset = cons_frame->offset;\r\nconn->length = length;\r\ncons_frame->offset += length;\r\ncons_frame->conns = g_list_append(cons_frame->conns, conn);\r\n} else {\r\nconn->frame_offset = 0;\r\ncons_ldev->consconns = g_list_append(cons_ldev->consconns, conn);\r\nprov_ldev->provconns = g_list_append(prov_ldev->provconns, conn);\r\n}\r\nreturn conn;\r\n}\r\nstatic void\r\ncba_connection_disconnect(packet_info *pinfo, cba_connection_t *conn)\r\n{\r\nif (conn->packet_disconnect == 0) {\r\nconn->packet_disconnect = pinfo->num;\r\n}\r\nif (conn->packet_disconnect != pinfo->num) {\r\ng_warning("connection_disconnect#%u: already disconnected",\r\nconn->packet_disconnect);\r\n}\r\n}\r\nstatic void\r\ncba_connection_disconnectme(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, cba_ldev_t *cons_ldev, cba_ldev_t *prov_ldev)\r\n{\r\nGList *conns;\r\ncba_connection_t *conn;\r\nfor(conns = cons_ldev->consconns; conns != NULL; conns = g_list_next(conns)) {\r\nconn = (cba_connection_t *)conns->data;\r\nif ( conn->provparentacco == prov_ldev &&\r\ncba_packet_in_range(pinfo, conn->packet_connect, conn->packet_disconnect, conn->packet_disconnectme)) {\r\ncba_connection_info(tvb, pinfo, tree, conn);\r\nif (conn->packet_disconnectme == 0) {\r\nconn->packet_disconnectme = pinfo->num;\r\n}\r\nif (conn->packet_disconnectme != pinfo->num) {\r\ng_warning("connection_disconnectme#%u: already disconnectme'd",\r\nconn->packet_disconnectme);\r\n}\r\n}\r\n}\r\n}\r\nstatic cba_connection_t *\r\ncba_connection_find_by_provid(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, cba_ldev_t *prov_ldev, guint32 provid)\r\n{\r\nGList *cba_iter;\r\ncba_connection_t *conn;\r\nfor(cba_iter = prov_ldev->provconns; cba_iter != NULL; cba_iter = g_list_next(cba_iter)) {\r\nconn = (cba_connection_t *)cba_iter->data;\r\nif ( conn->provid == provid &&\r\ncba_packet_in_range(pinfo, conn->packet_connect, conn->packet_disconnect, conn->packet_disconnectme)) {\r\nreturn conn;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic void\r\ncba_connection_incoming_data(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, cba_connection_t *conn)\r\n{\r\nif (conn->packet_first == 0) {\r\nconn->packet_first = pinfo->num;\r\n}\r\nif ( pinfo->num > conn->packet_last &&\r\ncba_packet_in_range(pinfo, conn->packet_connect, conn->packet_disconnect, conn->packet_disconnectme)) {\r\nconn->packet_last = pinfo->num;\r\n}\r\n}\r\nstatic int\r\ndissect_HResultArray_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32Idx;\r\nguint32 u32Tmp;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult, u32Idx);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32ArraySize,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_SetActivation_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32Idx;\r\nguint32 u32Tmp;\r\nproto_item *item;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult, u32Idx);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32ArraySize,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_Disconnect_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32Idx;\r\nguint32 u32Tmp;\r\nproto_item *item;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult, u32Idx);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32ArraySize,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_SetActivation_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32Idx;\r\nguint32 u32Tmp;\r\nproto_item *item;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult, u32Idx);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32ArraySize,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_Connect_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8State;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32VariableOffset;\r\nguint32 u32SubStart;\r\nguint32 u32Pointer;\r\nguint16 u16VarType;\r\nguint32 u32ConsID;\r\ngchar szItem[1000] = { 0 };\r\nguint32 u32MaxItemLen = sizeof(szItem);\r\ngchar szCons[1000] = { 0 };\r\nguint32 u32MaxConsLen = sizeof(szCons);\r\nguint32 u32Idx;\r\nproto_item *item;\r\ndcom_interface_t *cons_interf;\r\ncba_ldev_t *cons_ldev;\r\ncba_ldev_t *prov_ldev;\r\ncba_connection_t *conn;\r\nserver_connect_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szCons, u32MaxConsLen);\r\ncons_ldev = cba_acco_add(pinfo, szCons);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_PMInterfacePointer(tvb, offset, pinfo, tree, di, drep, 0, &cons_interf);\r\nif (cons_interf == NULL) {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_conn_consumer,\r\n"Server_Connect: consumer interface invalid");\r\n}\r\nif (cons_interf != NULL && cons_ldev != NULL) {\r\ncba_ldev_link_acco(pinfo, cons_ldev, cons_interf);\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\ncall = (server_connect_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_connect_call_t) + u32ArraySize * sizeof(cba_connection_t *));\r\ncall->conn_count = 0;\r\ncall->frame = NULL;\r\ncall->conns = (cba_connection_t **) (call+1);\r\ndi->call_data->private_data = call;\r\n} else{\r\ncall = NULL;\r\n}\r\nu32VariableOffset = offset + u32ArraySize*16;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectin, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectin);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szItem, u32MaxItemLen);\r\n}\r\noffset = dissect_dcom_VARTYPE(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u16VarType);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_epsilon);\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\nconn = cba_connection_connect(pinfo, cons_ldev, prov_ldev, NULL,\r\nu16QoSType, u16QoSValue, szItem, u32ConsID, 0,\r\n(guint16 *)wmem_memdup(wmem_file_scope(), &u16VarType, 2), 1);\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\n} else {\r\nconn = NULL;\r\n}\r\nif (call != NULL) {\r\ncall->conn_count++;\r\ncall->conns[u32Idx-1] = conn;\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ConsID=0x%x, ProvItem=\"%s\", VarType=%s",\r\nu32Idx, u32ConsID, szItem,\r\nval_to_str(u16VarType, dcom_variant_type_vals, "Unknown (0x%04x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Consumer=\"%s\" Cnt=%u", szCons, u32Count);\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer2_Connect2_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8State;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32VariableOffset;\r\nguint32 u32SubStart;\r\nguint32 u32Pointer;\r\nguint16 u16VarType;\r\nguint32 u32ConsID;\r\ngchar szItem[1000] = { 0 };\r\nguint32 u32MaxItemLen = sizeof(szItem);\r\ngchar szCons[1000] = { 0 };\r\nguint32 u32MaxConsLen = sizeof(szCons);\r\nguint32 u32Idx;\r\nguint16 u16TypeDescLen;\r\nguint32 u32ArraySize2;\r\nguint32 u32Idx2;\r\nguint16 u16VarType2 = -1;\r\nproto_item *item;\r\ndcom_interface_t *cons_interf;\r\ncba_ldev_t *prov_ldev;\r\ncba_ldev_t *cons_ldev;\r\ncba_connection_t *conn;\r\nguint16 typedesclen = 0;\r\nguint16 *typedesc = NULL;\r\nserver_connect_call_t *call = NULL;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szCons, u32MaxConsLen);\r\ncons_ldev = cba_acco_add(pinfo, szCons);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep, &u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_MInterfacePointer(tvb, offset, pinfo, tree, di, drep, 0, &cons_interf);\r\nif (cons_interf == NULL) {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_conn_consumer,\r\n"Server2_Connect2: consumer interface invalid");\r\n}\r\n} else {\r\ncons_interf = NULL;\r\n}\r\nif (cons_interf != NULL && cons_ldev != NULL) {\r\ncba_ldev_link_acco(pinfo, cons_ldev, cons_interf);\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\ncall = (server_connect_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_connect_call_t) + u32ArraySize * sizeof(cba_connection_t *));\r\ncall->conn_count = 0;\r\ncall->frame = NULL;\r\ncall->conns = (cba_connection_t **) (call+1);\r\ndi->call_data->private_data = call;\r\n} else{\r\ncall = NULL;\r\n}\r\nu32VariableOffset = offset + u32ArraySize*20;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectin, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectin);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szItem, u32MaxItemLen);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_type_desc_len, &u16TypeDescLen);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_dcerpc_array_size(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\n&u32ArraySize2);\r\nif (u32ArraySize2 < 1000) {\r\ntypedesc = (guint16 *)wmem_alloc0(wmem_file_scope(), u32ArraySize2 * 2);\r\ntypedesclen = u32ArraySize2;\r\n} else {\r\ntypedesc = NULL;\r\ntypedesclen = 0;\r\n}\r\nu32Idx2 = 1;\r\nwhile (u32ArraySize2--) {\r\nu32VariableOffset = dissect_dcom_VARTYPE(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\n&u16VarType);\r\nif (typedesc != NULL && u32Idx2 <= typedesclen) {\r\ntypedesc[u32Idx2-1] = u16VarType;\r\n}\r\nif (u32Idx2 == 1) {\r\nu16VarType2 = u16VarType;\r\n}\r\nu32Idx2++;\r\n}\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_epsilon);\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\nconn = cba_connection_connect(pinfo, cons_ldev, prov_ldev, NULL,\r\nu16QoSType, u16QoSValue, szItem, u32ConsID, 0,\r\ntypedesc, typedesclen);\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\n} else {\r\nconn = NULL;\r\n}\r\nif (call != NULL) {\r\ncall->conn_count++;\r\ncall->conns[u32Idx-1] = conn;\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ConsID=0x%x, ProvItem=\"%s\", TypeDesc=%s",\r\nu32Idx, u32ConsID, szItem,\r\nval_to_str(u16VarType2, dcom_variant_type_vals, "Unknown (0x%04x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Consumer=\"%s\" Cnt=%u", szCons, u32Count);\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_Connect_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint8 u8FirstConnect;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32HResult;\r\nguint32 u32Idx = 1;\r\nguint32 u32ProvID;\r\nguint32 u32SubStart;\r\nproto_item *item;\r\ncba_connection_t *conn;\r\nserver_connect_call_t *call = (server_connect_call_t *)di->call_data->private_data;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nif (call == NULL) {\r\nexpert_add_info(pinfo, NULL, &ei_cba_acco_no_request_info);\r\n}\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_server_first_connect, &u8FirstConnect);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nwhile(u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectout, tvb, offset, 8, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nif (call && u32Idx <= call->conn_count) {\r\nconn = call->conns[u32Idx-1];\r\nconn->provid = u32ProvID;\r\nconn->connret = u32HResult;\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ProvID=0x%x %s",\r\nu32Idx, u32ProvID,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\nwhile(call && u32Idx <= call->conn_count) {\r\nconn = call->conns[u32Idx-1];\r\nconn->provid = 0;\r\nconn->connret = u32HResult;\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s Cnt=%u -> %s",\r\n(u8FirstConnect) ? "First" : "NotFirst",\r\nu32Idx-1,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_Disconnect_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvID;\r\nproto_item *item;\r\ncba_ldev_t *prov_ldev;\r\ncba_connection_t *conn;\r\nserver_connect_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nif (prov_ldev != NULL) {\r\ncall = (server_connect_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_connect_call_t) + u32ArraySize * sizeof(cba_connection_t *));\r\ncall->conn_count = 0;\r\ncall->frame = NULL;\r\ncall->conns = (cba_connection_t **) (call+1);\r\ndi->call_data->private_data = call;\r\n} else{\r\ncall = NULL;\r\n}\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID, u32Idx);\r\nif (call != NULL) {\r\nconn = cba_connection_find_by_provid(tvb, pinfo, tree, prov_ldev, u32ProvID);\r\ncall->conn_count++;\r\ncall->conns[u32Idx-1] = conn;\r\n}\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_Disconnect_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32Idx;\r\nguint32 u32Tmp;\r\nproto_item *item;\r\ncba_connection_t *conn;\r\nserver_connect_call_t *call = (server_connect_call_t *)di->call_data->private_data;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nif (call == NULL) {\r\nexpert_add_info(pinfo, NULL, &ei_cba_acco_no_request_info);\r\n}\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult, u32Idx);\r\nif (call && u32Idx <= call->conn_count) {\r\nconn = call->conns[u32Idx-1];\r\nif (conn != NULL) {\r\ncba_connection_disconnect(pinfo, conn);\r\n}\r\n}\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32ArraySize,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_Disconnect_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvID;\r\nproto_item *item;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID, u32Idx);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_DisconnectMe_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nproto_item *item;\r\ncba_ldev_t *prov_ldev;\r\ncba_ldev_t *cons_ldev;\r\nserver_disconnectme_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szStr, u32MaxStr);\r\ncons_ldev = cba_acco_add(pinfo, szStr);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\ncall = (server_disconnectme_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_disconnectme_call_t));\r\ncall->cons = cons_ldev;\r\ncall->prov = prov_ldev;\r\ndi->call_data->private_data = call;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Consumer=\"%s\"", szStr);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_DisconnectMe_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item;\r\nserver_disconnectme_call_t *call;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncall = (server_disconnectme_call_t *)di->call_data->private_data;\r\nif (call) {\r\ncba_connection_disconnectme(tvb, pinfo, tree, call->cons, call->prov);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_DisconnectMe_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nproto_item *item;\r\ncba_ldev_t *prov_ldev;\r\ncba_ldev_t *cons_ldev;\r\nserver_disconnectme_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szStr, u32MaxStr);\r\ncons_ldev = cba_acco_add(pinfo, szStr);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\ncall = (server_disconnectme_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_disconnectme_call_t));\r\ncall->cons = cons_ldev;\r\ncall->prov = prov_ldev;\r\ndi->call_data->private_data = call;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Consumer=\"%s\"", szStr);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_DisconnectMe_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item;\r\nserver_disconnectme_call_t *call;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncall = (server_disconnectme_call_t *)di->call_data->private_data;\r\nif (call) {\r\ncba_frame_disconnectme(tvb, pinfo, tree, call->cons, call->prov);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_Ping_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_SetActivation_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint8 u8State;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvID;\r\nproto_item *item;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID, u32Idx);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_SetActivation_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint8 u8State;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvID;\r\nproto_item *item;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID, u32Idx);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer_Ping_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nproto_item *item;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szStr, u32MaxStr);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Consumer=\"%s\"", szStr);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_ConnectCR_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ngchar szCons[1000] = { 0 };\r\nguint32 u32MaxConsLen = sizeof(szCons);\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8ConsMac[6];\r\nguint16 u16CRID = 0;\r\nguint16 u16CRLength = 0;\r\nguint32 u32Flags;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nproto_item *item;\r\nproto_tree *flags_tree;\r\nguint32 u32SubStart;\r\ndcom_interface_t *cons_interf;\r\ncba_ldev_t *prov_ldev;\r\ncba_ldev_t *cons_ldev;\r\ncba_frame_t *frame;\r\nserver_frame_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szCons, u32MaxConsLen);\r\ncons_ldev = cba_acco_add(pinfo, szCons);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_PMInterfacePointer(tvb, offset, pinfo, tree, di, drep, 0, &cons_interf);\r\nif (cons_interf == NULL) {\r\nexpert_add_info_format(pinfo, NULL, &ei_cba_acco_conn_consumer,\r\n"ServerSRT_ConnectCR: consumer interface invalid");\r\n}\r\nif (cons_interf != NULL && cons_ldev != NULL) {\r\ncba_ldev_link_acco(pinfo, cons_ldev, cons_interf);\r\n}\r\ntvb_memcpy(tvb, u8ConsMac, offset, 6);\r\nproto_tree_add_ether(tree, hf_cba_acco_serversrt_cons_mac, tvb,\r\noffset, 6, u8ConsMac);\r\noffset += 6;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, NULL , di, drep,\r\n0 , &u32Flags);\r\noffset -= 4;\r\nitem = proto_tree_add_uint_format_value(tree, hf_cba_acco_serversrt_cr_flags,\r\ntvb, offset, 4, u32Flags,\r\n"0x%02x (%s, %s)", u32Flags,\r\n(u32Flags & 0x2) ? "Reconfigure" : "not Reconfigure",\r\n(u32Flags & 0x1) ? "Timestamped" : "not Timestamped");\r\nflags_tree = proto_item_add_subtree(item, ett_cba_acco_serversrt_cr_flags);\r\nproto_tree_add_boolean(flags_tree, hf_cba_acco_serversrt_cr_flags_reconfigure, tvb, offset, 4, u32Flags);\r\nproto_tree_add_boolean(flags_tree, hf_cba_acco_serversrt_cr_flags_timestamped, tvb, offset, 4, u32Flags);\r\noffset += 4;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif (prov_ldev != NULL && cons_ldev != NULL && u32ArraySize < 100) {\r\ncall = (server_frame_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_frame_call_t) + u32ArraySize * sizeof(cba_frame_t *));\r\ncall->frame_count = 0;\r\ncall->frames = (cba_frame_t **) (call+1);\r\ndi->call_data->private_data = call;\r\n} else {\r\ncall = NULL;\r\n}\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectincr, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectincr);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_serversrt_cr_id, &u16CRID);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_serversrt_cr_length, &u16CRLength);\r\nif (prov_ldev != NULL && cons_ldev != NULL) {\r\nframe = cba_frame_connect(pinfo, cons_ldev, prov_ldev, u16QoSType, u16QoSValue, u8ConsMac, u16CRID, u16CRLength);\r\ncba_frame_info(tvb, pinfo, sub_tree, frame);\r\n} else {\r\nframe = NULL;\r\n}\r\nif (call != NULL) {\r\ncall->frame_count++;\r\ncall->frames[u32Idx-1] = frame;\r\n}\r\nproto_item_append_text(sub_item, "[%u]: CRID=0x%x, CRLength=%u",\r\nu32Idx, u16CRID, u16CRLength);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %sConsCRID=0x%x Len=%u QoS=%u",\r\n(u32Flags & 0x2) ? "Reco " : "", u16CRID, u16CRLength, u16QoSValue);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_ConnectCR_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint8 u8FirstConnect;\r\nguint8 u8ProvMac[6];\r\nguint32 u32ProvCRID = 0;\r\nguint32 u32HResult;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx = 1;\r\nguint32 u32Pointer;\r\nguint32 u32SubStart;\r\nproto_item *item;\r\ncba_frame_t *frame;\r\nserver_frame_call_t *call = (server_frame_call_t *)di->call_data->private_data;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nif (call == NULL) {\r\nexpert_add_info(pinfo, NULL, &ei_cba_acco_no_request_info);\r\n}\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_server_first_connect, &u8FirstConnect);\r\ntvb_memcpy(tvb, u8ProvMac, offset, 6);\r\nproto_tree_add_ether(tree, hf_cba_acco_serversrt_prov_mac, tvb,\r\noffset, 6, u8ProvMac);\r\noffset += 6;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectoutcr, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectoutcr);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_prov_crid, &u32ProvCRID);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult);\r\nif (call && u32Idx <= call->frame_count) {\r\nframe = call->frames[u32Idx-1];\r\nframe->provcrid = u32ProvCRID;\r\nframe->conncrret = u32HResult;\r\ncba_frame_info(tvb, pinfo, sub_tree, frame);\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ProvCRID=0x%x, %s",\r\nu32Idx, u32ProvCRID,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\nwhile(call && u32Idx <= call->frame_count) {\r\nframe = call->frames[u32Idx-1];\r\nframe->provcrid = 0;\r\nframe->conncrret = u32HResult;\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s PCRID=0x%x -> %s",\r\n(u8FirstConnect) ? "FirstCR" : "NotFirstCR",\r\nu32ProvCRID,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_DisconnectCR_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvCRID = 0;\r\nproto_item *item;\r\ncba_ldev_t *prov_ldev;\r\ncba_frame_t *frame;\r\nserver_frame_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif (prov_ldev != NULL) {\r\ncall = (server_frame_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_frame_call_t) + u32ArraySize * sizeof(cba_frame_t *));\r\ncall->frame_count = 0;\r\ncall->frames = (cba_frame_t **) (call+1);\r\ndi->call_data->private_data = call;\r\n} else{\r\ncall = NULL;\r\n}\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_prov_crid, &u32ProvCRID, u32Idx);\r\nif (call != NULL) {\r\nframe = cba_frame_find_by_provcrid(pinfo, prov_ldev, u32ProvCRID);\r\ncall->frame_count++;\r\ncall->frames[u32Idx-1] = frame;\r\n}\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": PCRID=0x%x",\r\nu32ProvCRID);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_DisconnectCR_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32Idx;\r\nguint32 u32Tmp;\r\ncba_frame_t *frame;\r\nproto_item *item;\r\nserver_frame_call_t *call = (server_frame_call_t *)di->call_data->private_data;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult, u32Idx);\r\nif (call && u32Idx <= call->frame_count) {\r\nframe = call->frames[u32Idx-1];\r\nif (frame != NULL) {\r\ncba_frame_disconnect(pinfo, frame);\r\n}\r\n}\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_Connect_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32ProvCRID;\r\nguint8 u8State;\r\nguint8 u8LastConnect;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32VariableOffset;\r\nguint32 u32Idx;\r\nguint32 u32SubStart;\r\nguint32 u32Pointer;\r\ngchar szProvItem[1000] = { 0 };\r\nguint32 u32MaxProvItemLen = sizeof(szProvItem);\r\nguint16 u16TypeDescLen;\r\nguint32 u32ArraySize2;\r\nguint32 u32Idx2;\r\nguint16 u16VarType2 = -1;\r\nguint16 u16VarType;\r\nguint32 u32ConsID;\r\nguint16 u16RecordLength;\r\nproto_item *item;\r\ncba_ldev_t *prov_ldev;\r\ncba_frame_t *frame = NULL;\r\nguint16 typedesclen = 0;\r\nguint16 *typedesc = NULL;\r\ncba_connection_t *conn;\r\nserver_connect_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nprov_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_prov_crid, &u32ProvCRID);\r\nframe = cba_frame_find_by_provcrid(pinfo, prov_ldev, u32ProvCRID);\r\nif (frame != NULL) {\r\ncba_frame_info(tvb, pinfo, tree, frame);\r\n}\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_serversrt_last_connect, &u8LastConnect);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif (frame != NULL) {\r\ncall = (server_connect_call_t *)wmem_alloc(wmem_file_scope(), sizeof(server_connect_call_t) + u32ArraySize * sizeof(cba_connection_t *));\r\ncall->conn_count = 0;\r\ncall->frame = frame;\r\ncall->conns = (cba_connection_t **) (call+1);\r\ndi->call_data->private_data = call;\r\n} else{\r\ncall = NULL;\r\n}\r\nu32VariableOffset = offset + u32ArraySize*20;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectin, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectin);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szProvItem, u32MaxProvItemLen);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_type_desc_len, &u16TypeDescLen);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_dcerpc_array_size(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\n&u32ArraySize2);\r\ntypedesc = (guint16 *)wmem_alloc0(wmem_file_scope(), u32ArraySize2 * 2);\r\ntypedesclen = u32ArraySize2;\r\nu32Idx2 = 1;\r\nwhile (u32ArraySize2--) {\r\nu32VariableOffset = dissect_dcom_VARTYPE(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\n&u16VarType);\r\nif (u32Idx2 <= typedesclen) {\r\ntypedesc[u32Idx2-1] = u16VarType;\r\n}\r\nif (u32Idx2 == 1) {\r\nu16VarType2 = u16VarType;\r\n}\r\nu32Idx2++;\r\n}\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_serversrt_record_length, &u16RecordLength);\r\nif (frame != NULL) {\r\nconn = cba_connection_connect(pinfo, frame->consparent, frame->provparent, frame,\r\nframe->qostype, frame->qosvalue, szProvItem, u32ConsID, u16RecordLength,\r\ntypedesc, typedesclen);\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\n} else {\r\nconn = NULL;\r\n}\r\nif (call != NULL) {\r\ncall->conn_count++;\r\ncall->conns[u32Idx-1] = conn;\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ConsID=0x%x, ProvItem=\"%s\", TypeDesc=%s",\r\nu32Idx, u32ConsID, szProvItem,\r\nval_to_str(u16VarType2, dcom_variant_type_vals, "Unknown (0x%04x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s Cnt=%u PCRID=0x%x",\r\n(u8LastConnect) ? "LastOfCR" : "",\r\nu32Idx-1,\r\nu32ProvCRID);\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServerSRT_Connect_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx = 1;\r\nguint32 u32SubStart;\r\nguint32 u32ProvID;\r\nguint32 u32HResult;\r\nproto_item *item;\r\nserver_connect_call_t *call = (server_connect_call_t *)di->call_data->private_data;\r\ncba_connection_t *conn;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nif (call == NULL) {\r\nexpert_add_info(pinfo, NULL, &ei_cba_acco_no_request_info);\r\n}\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (call && call->frame != NULL) {\r\ncba_frame_info(tvb, pinfo, tree, call->frame);\r\n}\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nwhile(u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_connectout, tvb, offset, 8, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_connectout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nif (call && u32Idx <= call->conn_count) {\r\nconn = call->conns[u32Idx-1];\r\nconn->provid = u32ProvID;\r\nconn->connret = u32HResult;\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ProvID=0x%x %s",\r\nu32Idx, u32ProvID,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\nwhile(call && u32Idx <= call->conn_count) {\r\nconn = call->conns[u32Idx-1];\r\nconn->provid = 0;\r\nconn->connret = u32HResult;\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32Idx-1,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_Server_GetProvIDs_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvID;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nif (u32Count) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u ProvID=", u32Count);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo,\r\ntree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID, u32Idx);\r\nif (u32Idx == 1) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "0x%x", u32ProvID);\r\n} else if (u32Idx < 10) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ",0x%x", u32ProvID);\r\n} else if (u32Idx == 10) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ",...");\r\n}\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_Server_GetProvConnections_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ProvID;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_prov_id, &u32ProvID, u32Idx);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_Server_GetProvConnections_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32TmpCount;\r\nguint32 u32Pointer;\r\nguint32 u32VariableOffset;\r\nguint32 u32Idx;\r\nguint32 u32SubStart;\r\ngchar szCons[1000] = { 0 };\r\nguint32 u32MaxConsLen = sizeof(szCons);\r\ngchar szProvItem[1000] = { 0 };\r\nguint32 u32MaxProvItemLen = sizeof(szProvItem);\r\nguint32 u32ConsID;\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8State;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nu32VariableOffset = offset;\r\nif (u32Pointer) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nu32VariableOffset = offset + u32Count*28;\r\nu32TmpCount = u32Count;\r\nu32Idx = 1;\r\nwhile (u32TmpCount--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_getprovconnout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_getprovconnout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_consumer, szCons, u32MaxConsLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szProvItem, u32MaxProvItemLen);\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_epsilon);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: %s",\r\nu32Idx,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\nu32VariableOffset = dissect_dcom_HRESULT(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_CBA_Connection_Data(tvbuff_t *tvb,\r\npacket_info *pinfo, proto_tree *tree, cba_ldev_t *cons_ldev, cba_frame_t *frame)\r\n{\r\nguint8 u8Version;\r\nguint8 u8Flags;\r\nguint16 u16CountFix;\r\nguint16 u16Count;\r\nguint32 u32ItemIdx;\r\nguint32 u32HoleIdx;\r\nproto_item *conn_data_item = NULL;\r\nproto_tree *conn_data_tree = NULL;\r\nguint16 u16Len;\r\nguint32 u32ID;\r\nguint8 u8QC;\r\nguint16 u16DataLen;\r\nguint16 u16HdrLen;\r\nint offset = 0;\r\nint offset_hole;\r\ngboolean qc_reported = FALSE;\r\nint qc_good = 0;\r\nint qc_uncertain = 0;\r\nint qc_bad = 0;\r\nGList *conns;\r\nint item_offset;\r\ncba_connection_t *conn;\r\nif (tree) {\r\nconn_data_item = proto_tree_add_item(tree, hf_cba_acco_cb_conn_data, tvb, offset, 0, ENC_NA);\r\nconn_data_tree = proto_item_add_subtree(conn_data_item, ett_ICBAAccoCallback_Buffer);\r\n}\r\nu8Version = tvb_get_guint8 (tvb, offset);\r\nif (conn_data_tree) {\r\nproto_tree_add_item(conn_data_tree, hf_cba_acco_cb_version, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 1;\r\nu8Flags = tvb_get_guint8 (tvb, offset);\r\nif (conn_data_tree) {\r\nproto_tree_add_item(conn_data_tree, hf_cba_acco_cb_flags, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 1;\r\nu16Count = tvb_get_letohs (tvb, offset);\r\nif (conn_data_tree) {\r\nproto_tree_add_item(conn_data_tree, hf_cba_acco_cb_count, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 2;\r\nu16CountFix = u16Count;\r\nif (frame) {\r\ncba_frame_info(tvb, pinfo, conn_data_tree, frame);\r\n} else {\r\nif (cons_ldev && cons_ldev->name) {\r\nproto_item *item;\r\nitem = proto_tree_add_string(conn_data_tree, hf_cba_acco_conn_consumer, tvb, offset, 0, cons_ldev->name);\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\n}\r\n#if 0\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Cnt=%u", u16Count);\r\n#endif\r\nif ((u8Version != CBA_MRSH_VERSION_DCOM) &&\r\n(u8Version != CBA_MRSH_VERSION_SRT_WITH_CONSID) &&\r\n(u8Version != CBA_MRSH_VERSION_SRT_WITHOUT_CONSID))\r\n{\r\nreturn offset;\r\n}\r\nif (u8Flags != 0) {\r\nreturn offset;\r\n}\r\nu32ItemIdx = 1;\r\nu32HoleIdx = 1;\r\nwhile (u16Count--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nproto_item *item;\r\nu16Len = tvb_get_letohs (tvb, offset);\r\nif (u16Len == 0 &&\r\n(u8Version == CBA_MRSH_VERSION_SRT_WITH_CONSID ||\r\nu8Version == CBA_MRSH_VERSION_SRT_WITHOUT_CONSID))\r\n{\r\nu32HoleIdx++;\r\noffset_hole = offset;\r\nwhile (u16Len == 0) {\r\noffset++;\r\nu16Len = tvb_get_letohs(tvb, offset);\r\nif (u16Len > 0x300) {\r\nu16Len = 0;\r\n}\r\n}\r\nproto_tree_add_none_format(conn_data_tree, hf_cba_acco_cb_item_hole, tvb,\r\noffset_hole, offset - offset_hole,\r\n"Hole(--): -------------, offset=%2u, length=%2u",\r\noffset_hole, offset - offset_hole);\r\n}\r\nsub_item = proto_tree_add_item(conn_data_tree, hf_cba_acco_cb_item, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_ICBAAccoCallback_Item);\r\nitem_offset = offset;\r\nif (sub_tree) {\r\nproto_tree_add_item(sub_tree, hf_cba_acco_cb_item_length, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 2;\r\nu16HdrLen = 2;\r\nif (u8Version == CBA_MRSH_VERSION_DCOM ||\r\nu8Version == CBA_MRSH_VERSION_SRT_WITH_CONSID)\r\n{\r\nu32ID = tvb_get_letohl (tvb, offset);\r\nif (sub_tree) {\r\nproto_tree_add_item(sub_tree, hf_cba_acco_conn_cons_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 4;\r\nu16HdrLen += 4;\r\n} else {\r\nu32ID = 0;\r\n}\r\nu8QC = tvb_get_guint8 (tvb, offset);\r\nitem = NULL;\r\nif (sub_tree) {\r\nitem = proto_tree_add_item(sub_tree, hf_cba_acco_qc, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\noffset += 1;\r\nu16HdrLen += 1;\r\nif ( u8QC != 0x80 &&\r\nu8QC != 0x1C &&\r\nqc_reported == 0) {\r\nexpert_add_info_format(pinfo, item, &ei_cba_acco_qc, "%s QC: %s",\r\nu8Version == CBA_MRSH_VERSION_DCOM ? "DCOM" : "SRT",\r\nval_to_str(u8QC, cba_acco_qc_vals, "Unknown (0x%02x)"));\r\nqc_reported = 0;\r\n}\r\nswitch(u8QC >> 6) {\r\ncase(00):\r\nqc_bad++;\r\nbreak;\r\ncase(01):\r\nqc_uncertain++;\r\nbreak;\r\ndefault:\r\nqc_good++;\r\n}\r\nu16DataLen = u16Len - u16HdrLen;\r\nif (u8Version == CBA_MRSH_VERSION_DCOM ||\r\nu8Version == CBA_MRSH_VERSION_SRT_WITH_CONSID)\r\n{\r\nproto_item_append_text(sub_item,\r\n"[%2u]: ConsID=0x%08x, offset=%2u, length=%2u (user-length=%2u), QC=%s (0x%02x)",\r\nu32ItemIdx, u32ID, offset - u16HdrLen, u16Len, u16DataLen,\r\nval_to_str(u8QC, cba_acco_qc_vals, "Unknown (0x%02x)"), u8QC );\r\n} else {\r\nproto_item_append_text(sub_item,\r\n"[%2u]: ConsID=-, offset=%2u, length=%2u (user-length=%2u), QC=%s (0x%02x)",\r\nu32ItemIdx, offset - u16HdrLen, u16Len, u16DataLen,\r\nval_to_str(u8QC, cba_acco_qc_vals, "Unknown (0x%02x)"), u8QC );\r\n}\r\nproto_item_set_len(sub_item, u16Len);\r\nproto_tree_add_item(sub_tree, hf_cba_acco_cb_item_data, tvb, offset, u16DataLen, ENC_NA);\r\noffset += u16DataLen;\r\nif (frame != NULL ) {\r\ncba_frame_incoming_data(tvb, pinfo, sub_tree, frame);\r\nfor(conns = frame->conns; conns != NULL; conns = g_list_next(conns)) {\r\nconn = (cba_connection_t *)conns->data;\r\nif (conn->frame_offset == item_offset) {\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\nbreak;\r\n}\r\n}\r\n} else {\r\nif (cons_ldev != NULL) {\r\nfor(conns = cons_ldev->consconns; conns != NULL; conns = g_list_next(conns)) {\r\nconn = (cba_connection_t *)conns->data;\r\nif (conn->consid == u32ID) {\r\ncba_connection_info(tvb, pinfo, sub_tree, conn);\r\ncba_connection_incoming_data(tvb, pinfo, sub_tree, conn);\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nu32ItemIdx++;\r\n}\r\nif (u8Version == 1) {\r\nproto_item_append_text(conn_data_item,\r\n": Version=0x%x (DCOM), Flags=0x%x, Count=%u",\r\nu8Version, u8Flags, u16CountFix);\r\n} else {\r\nproto_item_append_text(conn_data_item,\r\n": Version=0x%x (SRT), Flags=0x%x, Count=%u, Items=%u, Holes=%u",\r\nu8Version, u8Flags, u16CountFix, u32ItemIdx-1, u32HoleIdx-1);\r\n}\r\nproto_item_set_len(conn_data_item, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", QC (G:%u,U:%u,B:%u)",\r\nqc_good, qc_uncertain, qc_bad);\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ndissect_CBA_Connection_Data_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data)\r\n{\r\nguint8 u8Version;\r\nguint8 u8Flags;\r\nguint16 u16FrameID = GPOINTER_TO_UINT(data);\r\ncba_frame_t *frame;\r\nif (u16FrameID < 0x8000 || u16FrameID >= 0xfb00) {\r\nreturn FALSE;\r\n}\r\nu8Version = tvb_get_guint8 (tvb, 0);\r\nu8Flags = tvb_get_guint8 (tvb, 1);\r\nif (u8Version != 0x11 || u8Flags != 0x00) {\r\nreturn FALSE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PN-CBA");\r\nframe = cba_frame_find_by_cons(pinfo, (const guint8 *)pinfo->dl_dst.data, u16FrameID);\r\ndissect_CBA_Connection_Data(tvb, pinfo, tree, frame ? frame->consparent : NULL, frame);\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_ICBAAccoCallback_OnDataChanged_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Length;\r\nguint32 u32ArraySize;\r\ntvbuff_t *next_tvb;\r\nproto_item *item;\r\ncba_ldev_t *cons_ldev;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\ncons_ldev = cba_ldev_find(pinfo, &pinfo->net_dst, &di->call_data->object_uuid);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_cb_length, &u32Length);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\noffset += dissect_CBA_Connection_Data(next_tvb, pinfo, tree, cons_ldev, NULL );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoCallback_OnDataChanged_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoCallback_Gnip_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nproto_item *item;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(3));\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoCallback_Gnip_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_srt_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(4));\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer2_GetConnectionData_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nproto_item *item;\r\ncba_ldev_t *cons_ldev;\r\ncba_ldev_t **call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, TRUE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(2));\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_consumer, szStr, u32MaxStr);\r\ncons_ldev = cba_acco_add(pinfo, szStr);\r\nif (cons_ldev != NULL) {\r\ncall = (cba_ldev_t **)wmem_alloc(wmem_file_scope(), sizeof(cba_ldev_t *));\r\n*call = cons_ldev;\r\ndi->call_data->private_data = call;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Consumer=\"%s\"", szStr);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoServer2_GetConnectionData_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Length;\r\nguint32 u32ArraySize;\r\ntvbuff_t *next_tvb;\r\nguint32 u32Pointer;\r\nguint32 u32HResult;\r\nproto_item *item;\r\ncba_ldev_t **call = (cba_ldev_t **)di->call_data->private_data;\r\ncba_ldev_t *cons_ldev = (call!=NULL) ? *call : NULL;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\nif (cons_ldev == NULL) {\r\nexpert_add_info(pinfo, NULL, &ei_cba_acco_no_request_info);\r\n}\r\nitem = proto_tree_add_boolean (tree, hf_cba_acco_dcom_call, tvb, offset, 0, FALSE);\r\nPROTO_ITEM_SET_GENERATED(item);\r\np_add_proto_data(pinfo->pool, pinfo, proto_ICBAAccoMgt, 0, GUINT_TO_POINTER(1));\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_cb_length, &u32Length);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\noffset += dissect_CBA_Connection_Data(next_tvb, pinfo, tree, (call != NULL) ? *call : NULL, NULL );\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_AddConnections_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ngchar szConsumer[1000] = { 0 };\r\nguint32 u32MaxConsLen = sizeof(szConsumer);\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8State;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Pointer;\r\nguint16 u16Persistence;\r\ngchar szConsItem[1000] = { 0 };\r\nguint32 u32MaxConsItemLen = sizeof(szConsItem);\r\ngchar szProvItem[1000] = { 0 };\r\nguint32 u32MaxProvItemLen = sizeof(szProvItem);\r\nguint32 u32VariableOffset;\r\nguint32 u32SubStart;\r\nguint32 u32Idx;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_provider, szConsumer, u32MaxConsLen);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 20;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_addconnectionin, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_addconnectionin);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szProvItem, u32MaxProvItemLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_consumer_item, szConsItem, u32MaxConsItemLen);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_persist, &u16Persistence);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_substitute);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_epsilon);\r\n}\r\nproto_item_append_text(sub_item, "[%u]: ConsItem=\"%s\" ProvItem=\"%s\" %s Pers=%u",\r\nu32Idx, szConsItem, szProvItem,\r\nval_to_str(u16Persistence, cba_persist_vals, "Unknown (0x%02x)"), u16Persistence);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Prov=\"%s\" State=%s Cnt=%u",\r\nszConsumer,\r\nval_to_str(u8State, cba_acco_conn_state_vals, "Unknown (0x%02x)"),\r\nu32Count);\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_AddConnections_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32ConsID;\r\nguint16 u16ConnVersion;\r\nguint32 u32HResult = 0;\r\nguint32 u32Count = 0;\r\nguint32 u32Idx;\r\nguint32 u32SubStart;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Count = u32ArraySize;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_addconnectionout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_addconnectionout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_version, &u16ConnVersion);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: ConsID=0x%x Version=%u %s",\r\nu32Idx, u32ConsID, u16ConnVersion,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_RemoveConnections_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ConsID;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID, u32Idx);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_SetActivationState_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint8 u8State;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ConsID;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID, u32Idx);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_GetInfo_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Max;\r\nguint32 u32CurCnt;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_info_max, &u32Max);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_info_curr, &u32CurCnt);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u/%u -> %s",\r\nu32CurCnt, u32Max,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_GetIDs_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize;\r\nguint32 u32ConsID;\r\nguint8 u8State;\r\nguint16 u16Version;\r\nguint32 u32HResult;\r\nguint32 u32Idx;\r\nguint32 u32SubStart;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nif (u32Count) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u ConsID=", u32Count);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_getidout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_getidout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID);\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_version, &u16Version);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: ConsID=0x%x State=%s Version=%u %s",\r\nu32Idx, u32ConsID,\r\nval_to_str(u8State, cba_acco_conn_state_vals, "Unknown (0x%02x)"),\r\nu16Version,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nif (u32Idx == 1) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "0x%x", u32ConsID);\r\n} else if (u32Idx < 10) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ",0x%x", u32ConsID);\r\n} else if (u32Idx == 10) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ",...");\r\n}\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt2_GetConsIDs_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\nguint32 u32ConsID;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nif (u32Count) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u ConsID=", u32Count);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo,\r\ntree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID, u32Idx);\r\nif (u32Idx == 1) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "0x%x", u32ConsID);\r\n} else if (u32Idx < 10) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ",0x%x", u32ConsID);\r\n} else if (u32Idx == 10) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ",...");\r\n}\r\nu32Idx++;\r\n}\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt2_GetConsConnections_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32TmpCount;\r\nguint32 u32Pointer;\r\nguint32 u32HResult;\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8State;\r\nguint16 u16Persistence;\r\nguint32 u32SubStart;\r\nguint32 u32Idx;\r\nguint32 u32VariableOffset;\r\ngchar szProv[1000] = { 0 };\r\nguint32 u32MaxProvLen = sizeof(szProv);\r\ngchar szProvItem[1000] = { 0 };\r\nguint32 u32MaxProvItemLen = sizeof(szProvItem);\r\ngchar szConsItem[1000] = { 0 };\r\nguint32 u32MaxConsItemLen = sizeof(szConsItem);\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nu32VariableOffset = offset;\r\nif (u32Pointer) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nu32VariableOffset = offset + u32Count*32;\r\nu32TmpCount = u32Count;\r\nu32Idx = 1;\r\nwhile (u32TmpCount--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_getconsconnout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_getconnectionout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider, szProv, u32MaxProvLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szProvItem, u32MaxProvItemLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_consumer_item, szConsItem, u32MaxConsItemLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_substitute);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_epsilon);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_persist, &u16Persistence);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: %s",\r\nu32Idx,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\nu32VariableOffset = dissect_dcom_HRESULT(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt2_DiagConsConnections_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32TmpCount;\r\nguint32 u32Pointer;\r\nguint32 u32HResult;\r\nguint8 u8State;\r\nguint16 u16Persistence;\r\nguint16 u16ConnVersion;\r\nguint32 u32SubStart;\r\nguint32 u32Idx;\r\nguint32 u32VariableOffset;\r\nguint32 u32ConnErrorState;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nu32VariableOffset = offset;\r\nif (u32Pointer) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nu32VariableOffset = offset + u32Count*16;\r\nu32TmpCount = u32Count;\r\nu32Idx = 1;\r\nwhile (u32TmpCount--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nproto_item *state_item;\r\nsub_item = proto_tree_add_item(tree, hf_cba_diagconsconnout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_getconnectionout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_persist, &u16Persistence);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_version, &u16ConnVersion);\r\n#if 0\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_error_state, &u32ConnErrorState);\r\n#endif\r\noffset = dissect_dcom_HRESULT_item(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32ConnErrorState, hf_cba_acco_conn_error_state, &state_item);\r\nproto_item_set_text(state_item, "ConnErrorState: %s (0x%x)",\r\nval_to_str(u32ConnErrorState, dcom_hresult_vals, "Unknown (0x%08x)"),\r\nu32ConnErrorState);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: %s",\r\nu32Idx,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\nu32VariableOffset = dissect_dcom_HRESULT(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_GetConnections_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32ConsID;\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\nguint32 u32Idx;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Idx = 1;\r\nwhile (u32ArraySize--){\r\noffset = dissect_dcom_indexed_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_cons_id, &u32ConsID, u32Idx);\r\nu32Idx++;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_GetConnections_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32TmpCount;\r\nguint32 u32Pointer;\r\nguint32 u32HResult;\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\nguint8 u8State;\r\nguint16 u16Persistence;\r\nguint16 u16ConnVersion;\r\nguint32 u32SubStart;\r\nguint32 u32Idx;\r\nguint32 u32VariableOffset;\r\ngchar szProv[1000] = { 0 };\r\nguint32 u32MaxProvLen = sizeof(szProv);\r\ngchar szProvItem[1000] = { 0 };\r\nguint32 u32MaxProvItemLen = sizeof(szProvItem);\r\ngchar szConsItem[1000] = { 0 };\r\nguint32 u32MaxConsItemLen = sizeof(szConsItem);\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nu32VariableOffset = offset;\r\nif (u32Pointer) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\nu32VariableOffset = offset + u32Count*36;\r\nu32TmpCount = u32Count;\r\nu32Idx = 1;\r\nwhile (u32TmpCount--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_getconnectionout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_getconnectionout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider, szProv, u32MaxProvLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_provider_item, szProvItem, u32MaxProvItemLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_consumer_item, szConsItem, u32MaxConsItemLen);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_substitute);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_epsilon);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_BOOLEAN(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_state, &u8State);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_persist, &u16Persistence);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_conn_version, &u16ConnVersion);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: %s",\r\nu32Idx,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\nu32VariableOffset = dissect_dcom_HRESULT(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_ReviseQoS_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16QoSType;\r\nguint16 u16QoSValue;\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_rtauto, szStr, u32MaxStr);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_type, &u16QoSType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": RTAuto=\"%s\" QoSType=%s QoSValue=%u",\r\nszStr,\r\nval_to_str(u16QoSType, cba_qos_type_vals, "Unknown (0x%04x)"),\r\nu16QoSValue);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_ReviseQoS_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16QoSValue;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_conn_qos_value, &u16QoSValue);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u -> %s",\r\nu16QoSValue,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_get_PingFactor_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16PF;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_ping_factor, &u16PF);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u -> %s",\r\nu16PF,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_put_PingFactor_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16PF;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_ping_factor, &u16PF);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u", u16PF);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_get_CDBCookie_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Cookie;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_cdb_cookie, &u32Cookie);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": CDBCookie=0x%x -> %s",\r\nu32Cookie,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_GetDiagnosis_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Request;\r\nguint32 u32InLength;\r\nguint32 u32ArraySize;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_diag_req, &u32Request);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_diag_in_length, &u32InLength);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif (u32ArraySize != 0) {\r\nproto_tree_add_item(tree, hf_cba_acco_diag_data, tvb, offset, u32InLength, ENC_NA);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s: %u bytes",\r\nval_to_str(u32Request, cba_acco_diag_req_vals, "Unknown request (0x%08x)"),\r\nu32InLength);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoMgt_GetDiagnosis_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32OutLength;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_diag_out_length, &u32OutLength);\r\nif (u32OutLength != 0) {\r\nproto_tree_add_item(tree, hf_cba_acco_diag_data, tvb, offset, u32OutLength, ENC_NA);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u bytes",\r\nu32OutLength);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoSync_ReadItems_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize;\r\nguint32 u32VariableOffset;\r\nguint32 u32Idx;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize*4;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_indexed_LPWSTR(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\nhf_cba_acco_item, szStr, u32MaxStr, u32Idx);\r\n}\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoSync_ReadItems_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Pointer;\r\nguint16 u16QC;\r\nguint32 u32ArraySize = 0;\r\nguint32 u32HResult;\r\nguint32 u32Idx;\r\nguint32 u32SubStart;\r\nguint32 u32VariableOffset;\r\nguint32 u32Tmp;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nu32VariableOffset = offset;\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 20;\r\nu32Idx = 1;\r\nu32Tmp = u32ArraySize;\r\nwhile(u32Tmp--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_readitemout, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_readitemout);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep, hf_cba_acco_data);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_qc, &u16QC);\r\noffset = dissect_dcom_FILETIME(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_time_stamp, NULL);\r\noffset = dissect_dcom_indexed_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult, u32Idx);\r\nproto_item_append_text(sub_item, "[%u]: QC=%s (0x%02x) %s",\r\nu32Idx,\r\nval_to_str(u16QC, cba_acco_qc_vals, "Unknown"),\r\nu16QC,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\n}\r\nu32VariableOffset = dissect_dcom_HRESULT(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u -> %s",\r\nu32ArraySize,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoSync_WriteItems_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nguint32 u32Pointer;\r\nguint32 u32VariableOffset;\r\nguint32 u32SubStart;\r\nguint32 u32Idx;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 8;\r\nu32Idx = 1;\r\nwhile(u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_writeitemin, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_writeitemin);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_item, szStr, u32MaxStr);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_data);\r\n}\r\nproto_item_append_text(sub_item, "[%u]: Item=\"%s\"", u32Idx, szStr);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn u32VariableOffset;\r\n}\r\nstatic int\r\ndissect_ICBAAccoSync_WriteItemsQCD_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Count;\r\nguint32 u32ArraySize;\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nguint32 u32Pointer;\r\nguint32 u32VariableOffset;\r\nguint32 u32SubStart;\r\nguint32 u32Idx;\r\nguint16 u16QC;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_cba_acco_count, &u32Count);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 20;\r\nu32Idx = 1;\r\nwhile(u32ArraySize--) {\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, hf_cba_writeitemin, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cba_writeitemin);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_item, szStr, u32MaxStr);\r\n}\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_data);\r\n}\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_qc, &u16QC);\r\noffset = dissect_dcom_FILETIME(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_cba_acco_time_stamp, NULL);\r\nproto_item_append_text(sub_item, "[%u]: Item=\"%s\" QC=%s (0x%02x)",\r\nu32Idx, szStr,\r\nval_to_str(u16QC, cba_acco_qc_vals, "Unknown"), u16QC);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nu32Idx++;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": Cnt=%u", u32Count);\r\nreturn u32VariableOffset;\r\n}\r\nvoid\r\nproto_register_dcom_cba_acco (void)\r\n{\r\nstatic gint *ett3[3];\r\nstatic gint *ett4[4];\r\nstatic gint *ett5[5];\r\nstatic hf_register_info hf_cba_acco_array[] = {\r\n{ &hf_cba_acco_opnum,\r\n{ "Operation", "cba.acco.opnum",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_ping_factor,\r\n{ "PingFactor", "cba.acco.ping_factor",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_count,\r\n{ "Count", "cba.acco.count",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_info_max,\r\n{ "Max", "cba.acco.info_max",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_info_curr,\r\n{ "Current", "cba.acco.info_curr",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_rtauto,\r\n{ "RTAuto", "cba.acco.rtauto",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_item,\r\n{ "Item", "cba.acco.item",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_data,\r\n{ "Data", "cba.acco.data",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_qc,\r\n{ "QualityCode", "cba.acco.qc",\r\nFT_UINT8, BASE_HEX, VALS(cba_acco_qc_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_time_stamp,\r\n{ "TimeStamp", "cba.acco.time_stamp",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_readitemout,\r\n{ "ReadItemOut", "cba.acco.readitemout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_writeitemin,\r\n{ "WriteItemIn", "cba.acco.writeitemin",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cdb_cookie,\r\n{ "CDBCookie", "cba.acco.cdb_cookie",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_error_state,\r\n{ "ConnErrorState", "cba.acco.conn_error_state",\r\nFT_UINT32, BASE_HEX, NULL , 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_diag_req,\r\n{ "Request", "cba.acco.diag_req",\r\nFT_UINT32, BASE_HEX, VALS(cba_acco_diag_req_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_diag_in_length,\r\n{ "InLength", "cba.acco.diag_in_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_diag_out_length,\r\n{ "OutLength", "cba.acco.diag_out_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_diag_data,\r\n{ "Data", "cba.acco.diag_data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_dcom_call,\r\n{ "DcomRuntime", "cba.acco.dcom",\r\nFT_BOOLEAN, BASE_NONE, TFS(&cba_acco_call_flags), 0x0,\r\n"This is a DCOM runtime context", HFILL }\r\n},\r\n{ &hf_cba_acco_srt_call,\r\n{ "SrtRuntime", "cba.acco.srt",\r\nFT_BOOLEAN, BASE_NONE, TFS(&cba_acco_call_flags), 0x0,\r\n"This is an SRT runtime context", HFILL }\r\n}\r\n};\r\nstatic hf_register_info hf_cba_acco_server[] = {\r\n#if 0\r\n{ &hf_cba_acco_server_pICBAAccoCallback,\r\n{ "pICBAAccoCallback", "cba.acco.server_pICBAAccoCallback",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_cba_acco_server_first_connect,\r\n{ "FirstConnect", "cba.acco.server_first_connect",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_getprovconnout,\r\n{ "GETPROVCONNOUT", "cba.acco.getprovconnout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_prov_mac,\r\n{ "ProviderMAC", "cba.acco.serversrt_prov_mac",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_cons_mac,\r\n{ "ConsumerMAC", "cba.acco.serversrt_cons_mac",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_cr_id,\r\n{ "ConsumerCRID", "cba.acco.serversrt_cr_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_cr_length,\r\n{ "CRLength", "cba.acco.serversrt_cr_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_cr_flags,\r\n{ "Flags", "cba.acco.serversrt_cr_flags",\r\nFT_UINT32, BASE_HEX, 0, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_cr_flags_timestamped,\r\n{ "Timestamped", "cba.acco.serversrt_cr_flags_timestamped",\r\nFT_BOOLEAN, 32, TFS (&acco_flags_set_truth), 0x1,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_cr_flags_reconfigure,\r\n{ "Reconfigure", "cba.acco.serversrt_cr_flags_reconfigure",\r\nFT_BOOLEAN, 32, TFS (&acco_flags_set_truth), 0x2,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_type_desc_len,\r\n{ "TypeDescLen", "cba.acco.type_desc_len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_serversrt_record_length,\r\n{ "RecordLength", "cba.acco.serversrt_record_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_cba_acco_serversrt_action,\r\n{ "Action", "cba.acco.serversrt_action",\r\nFT_UINT32, BASE_DEC, VALS(cba_acco_serversrt_action_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_cba_acco_serversrt_last_connect,\r\n{ "LastConnect", "cba.acco.serversrt_last_connect",\r\nFT_UINT8, BASE_DEC, VALS(cba_acco_serversrt_last_connect_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic hf_register_info hf_cba_connectcr_array[] = {\r\n{ &hf_cba_acco_prov_crid,\r\n{ "ProviderCRID", "cba.acco.prov_crid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic hf_register_info hf_cba_connect_array[] = {\r\n{ &hf_cba_addconnectionin,\r\n{ "ADDCONNECTIONIN", "cba.acco.addconnectionin",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_addconnectionout,\r\n{ "ADDCONNECTIONOUT", "cba.acco.addconnectionout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_getidout,\r\n{ "GETIDOUT", "cba.acco.getidout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_getconnectionout,\r\n{ "GETCONNECTIONOUT", "cba.acco.getconnectionout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_getconsconnout,\r\n{ "GETCONSCONNOUT", "cba.acco.getconsconnout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_diagconsconnout,\r\n{ "DIAGCONSCONNOUT", "cba.acco.diagconsconnout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_connectincr,\r\n{ "CONNECTINCR", "cba.acco.connectincr",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_connectoutcr,\r\n{ "CONNECTOUTCR", "cba.acco.connectoutcr",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_connectin,\r\n{ "CONNECTIN", "cba.acco.connectin",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_connectout,\r\n{ "CONNECTOUT", "cba.acco.connectout",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_prov_id,\r\n{ "ProviderID", "cba.acco.conn_prov_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_cons_id,\r\n{ "ConsumerID", "cba.acco.conn_cons_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_version,\r\n{ "ConnVersion", "cba.acco.conn_version",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_consumer,\r\n{ "Consumer", "cba.acco.conn_consumer",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_qos_type,\r\n{ "QoSType", "cba.acco.conn_qos_type",\r\nFT_UINT16, BASE_HEX, VALS(cba_qos_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_qos_value,\r\n{ "QoSValue", "cba.acco.conn_qos_value",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_state,\r\n{ "State", "cba.acco.conn_state",\r\nFT_UINT8, BASE_HEX, VALS(cba_acco_conn_state_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_provider,\r\n{ "Provider", "cba.acco.conn_provider",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_provider_item,\r\n{ "ProviderItem", "cba.acco.conn_provider_item",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_consumer_item,\r\n{ "ConsumerItem", "cba.acco.conn_consumer_item",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_persist,\r\n{ "Persistence", "cba.acco.conn_persist",\r\nFT_UINT16, BASE_HEX, VALS(cba_persist_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_epsilon,\r\n{ "Epsilon", "cba.acco.conn_epsilon",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_conn_substitute,\r\n{ "Substitute", "cba.acco.conn_substitute",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic hf_register_info hf_cba_acco_cb[] = {\r\n{ &hf_cba_acco_cb_length,\r\n{ "Length", "cba.acco.cb_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_version,\r\n{ "Version", "cba.acco.cb_version",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_flags,\r\n{ "Flags", "cba.acco.cb_flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_count,\r\n{ "Count", "cba.acco.cb_count",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_conn_data,\r\n{ "CBA Connection data", "cba.acco.cb_conn_data",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_item,\r\n{ "Item", "cba.acco.cb_item",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_item_hole,\r\n{ "Hole", "cba.acco.cb_item_hole",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_item_length,\r\n{ "Length", "cba.acco.cb_item_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_acco_cb_item_data,\r\n{ "Data(Hex)", "cba.acco.cb_item_data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cba_connect_in,\r\n{ "Connect in frame", "cba.connect_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"This connection Connect was in the packet with this number", HFILL }\r\n},\r\n{ &hf_cba_disconnect_in,\r\n{ "Disconnect in frame", "cba.disconnect_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"This connection Disconnect was in the packet with this number", HFILL }\r\n},\r\n{ &hf_cba_connectcr_in,\r\n{ "ConnectCR in frame", "cba.connect_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"This frame ConnectCR was in the packet with this number", HFILL }\r\n},\r\n{ &hf_cba_disconnectcr_in,\r\n{ "DisconnectCR in frame", "cba.disconnect_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"This frame DisconnectCR was in the packet with this number", HFILL }\r\n},\r\n{ &hf_cba_disconnectme_in,\r\n{ "DisconnectMe in frame", "cba.disconnectme_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"This connection/frame DisconnectMe was in the packet with this number", HFILL }\r\n},\r\n{ &hf_cba_data_first_in,\r\n{ "First data in frame", "cba.data_first_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"The first data of this connection/frame in the packet with this number", HFILL }\r\n},\r\n{ &hf_cba_data_last_in,\r\n{ "Last data in frame", "cba.data_last_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"The last data of this connection/frame in the packet with this number", HFILL }\r\n},\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_cba_acco_pdev_find, { "cba.acco.pdev_find.fail", PI_UNDECODED, PI_NOTE, "pdev_find: no pdev for IP", EXPFILL }},\r\n{ &ei_cba_acco_pdev_find_unknown_interface, { "cba.acco.pdev_find.unknown_interface", PI_UNDECODED, PI_NOTE, "pdev_find: unknown interface", EXPFILL }},\r\n{ &ei_cba_acco_ldev_unknown, { "cba.acco.ldev.unknown", PI_UNDECODED, PI_NOTE, "Unknown LDev", EXPFILL }},\r\n{ &ei_cba_acco_ipid_unknown, { "cba.acco.ipid.unknown", PI_UNDECODED, PI_NOTE, "Unknown IPID", EXPFILL }},\r\n{ &ei_cba_acco_prov_crid, { "cba.acco.prov_crid.unknown", PI_UNDECODED, PI_NOTE, "Unknown provider frame ProvCRID", EXPFILL }},\r\n{ &ei_cba_acco_conn_consumer, { "cba.acco.conn_consumer.invalid", PI_UNDECODED, PI_NOTE, "Consumer interface invalid", EXPFILL }},\r\n{ &ei_cba_acco_no_request_info, { "cba.acco.no_request_info", PI_UNDECODED, PI_NOTE, "No request info, response data ignored", EXPFILL }},\r\n{ &ei_cba_acco_qc, { "cba.acco.qc.expert", PI_RESPONSE_CODE, PI_CHAT, "expert QC", EXPFILL }},\r\n};\r\nexpert_module_t* expert_cba_acco;\r\nett5[0] = &ett_ICBAAccoMgt;\r\nett5[1] = &ett_cba_addconnectionin;\r\nett5[2] = &ett_cba_addconnectionout;\r\nett5[3] = &ett_cba_getidout;\r\nett5[4] = &ett_cba_getconnectionout;\r\nproto_ICBAAccoMgt = proto_register_protocol ("ICBAAccoMgt", "ICBAAccoMgt", "cba_acco_mgt");\r\nproto_register_field_array(proto_ICBAAccoMgt, hf_cba_acco_array, array_length(hf_cba_acco_array));\r\nproto_register_field_array(proto_ICBAAccoMgt, hf_cba_connect_array, array_length(hf_cba_connect_array));\r\nproto_register_field_array(proto_ICBAAccoMgt, hf_cba_connectcr_array, array_length(hf_cba_connectcr_array));\r\nproto_register_subtree_array (ett5, array_length (ett5));\r\nexpert_cba_acco = expert_register_protocol(proto_ICBAAccoMgt);\r\nexpert_register_field_array(expert_cba_acco, ei, array_length(ei));\r\nproto_ICBAAccoMgt2 = proto_register_protocol ("ICBAAccoMgt2", "ICBAAccoMgt2", "cba_acco_mgt2");\r\nett3[0] = &ett_ICBAAccoCallback;\r\nett3[1] = &ett_ICBAAccoCallback_Item;\r\nett3[2] = &ett_ICBAAccoCallback_Buffer;\r\nproto_ICBAAccoCallback = proto_register_protocol ("ICBAAccoCallback", "ICBAAccoCB", "cba_acco_cb");\r\nproto_register_field_array(proto_ICBAAccoCallback, hf_cba_acco_cb, array_length(hf_cba_acco_cb));\r\nproto_register_subtree_array (ett3, array_length (ett3));\r\nproto_ICBAAccoCallback2 = proto_register_protocol ("ICBAAccoCallback2", "ICBAAccoCB2", "cba_acco_cb2");\r\nett4[0] = &ett_ICBAAccoServer;\r\nett4[1] = &ett_cba_connectin;\r\nett4[2] = &ett_cba_connectout;\r\nett4[3] = &ett_cba_getprovconnout;\r\nproto_ICBAAccoServer = proto_register_protocol ("ICBAAccoServer", "ICBAAccoServ", "cba_acco_server");\r\nproto_register_field_array(proto_ICBAAccoServer, hf_cba_acco_server, array_length(hf_cba_acco_server));\r\nproto_register_subtree_array (ett4, array_length (ett4));\r\nproto_ICBAAccoServer2 = proto_register_protocol ("ICBAAccoServer2", "ICBAAccoServ2", "cba_acco_server2");\r\nett4[0] = &ett_ICBAAccoServerSRT;\r\nett4[1] = &ett_cba_acco_serversrt_cr_flags;\r\nett4[2] = &ett_cba_connectincr;\r\nett4[3] = &ett_cba_connectoutcr;\r\nproto_ICBAAccoServerSRT = proto_register_protocol ("ICBAAccoServerSRT", "ICBAAccoServSRT", "cba_acco_server_srt");\r\nproto_register_subtree_array (ett4, array_length (ett4));\r\nett5[0] = &ett_ICBAAccoSync;\r\nett5[1] = &ett_cba_readitemout;\r\nett5[2] = &ett_cba_writeitemin;\r\nett5[3] = &ett_cba_frame_info;\r\nett5[4] = &ett_cba_conn_info;\r\nproto_ICBAAccoSync = proto_register_protocol ("ICBAAccoSync", "ICBAAccoSync", "cba_acco_sync");\r\nproto_register_subtree_array (ett5, array_length (ett5));\r\nregister_conversation_filter("cba", "PN-CBA", cba_filter_valid, cba_build_filter);\r\n}\r\nvoid\r\nproto_reg_handoff_dcom_cba_acco (void)\r\n{\r\ndcerpc_init_uuid(proto_ICBAAccoMgt, ett_ICBAAccoMgt,\r\n&uuid_ICBAAccoMgt, ver_ICBAAccoMgt, ICBAAccoMgt_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoMgt2, ett_ICBAAccoMgt,\r\n&uuid_ICBAAccoMgt2, ver_ICBAAccoMgt2, ICBAAccoMgt_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoCallback, ett_ICBAAccoCallback,\r\n&uuid_ICBAAccoCallback, ver_ICBAAccoCallback, ICBAAccoCallback_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoCallback2, ett_ICBAAccoCallback,\r\n&uuid_ICBAAccoCallback2, ver_ICBAAccoCallback2, ICBAAccoCallback_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoServer, ett_ICBAAccoServer,\r\n&uuid_ICBAAccoServer, ver_ICBAAccoServer, ICBAAccoServer_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoServer2, ett_ICBAAccoServer,\r\n&uuid_ICBAAccoServer2, ver_ICBAAccoServer2, ICBAAccoServer_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoServerSRT, ett_ICBAAccoServerSRT,\r\n&uuid_ICBAAccoServerSRT, ver_ICBAAccoServerSRT, ICBAAccoServerSRT_dissectors, hf_cba_acco_opnum);\r\ndcerpc_init_uuid(proto_ICBAAccoSync, ett_ICBAAccoSync,\r\n&uuid_ICBAAccoSync, ver_ICBAAccoSync, ICBAAccoSync_dissectors, hf_cba_acco_opnum);\r\nheur_dissector_add("pn_rt", dissect_CBA_Connection_Data_heur, "PROFINET CBA IO", "pn_cba_pn_rt", proto_ICBAAccoServer, HEURISTIC_ENABLE);\r\n}

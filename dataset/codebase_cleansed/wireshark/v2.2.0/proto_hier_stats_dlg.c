static void\r\nproto_hier_select_filter_cb(GtkWidget *widget _U_, gpointer callback_data _U_, guint callback_action)\r\n{\r\ngchar *str = NULL;\r\ngchar *strtmp = NULL;\r\nconst char *filter = NULL;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkTreePath *path;\r\nsel = gtk_tree_view_get_selection (GTK_TREE_VIEW(tree));\r\nif (!gtk_tree_selection_get_selected(sel, &model, &iter))\r\nreturn;\r\npath = gtk_tree_model_get_path(model,&iter);\r\ngtk_tree_model_get (model, &iter, FILTER_NAME, &filter, -1);\r\nif (filter && strlen(filter) > 0) {\r\nstr = g_strdup(filter);\r\n} else {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "Could not acquire information to build a filter!\nTry expanding or choosing another item.");\r\nreturn;\r\n}\r\nwhile (gtk_tree_path_up(path) && gtk_tree_path_get_depth(path) > 0)\r\n{\r\nstrtmp = g_strdup(str);\r\ng_free(str);\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_tree_model_get(model, &iter, FILTER_NAME, &filter, -1);\r\nif (filter && strlen(filter) > 0) {\r\nstr = g_strdup_printf("%s and %s", strtmp, filter);\r\n} else {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "Could not acquire information to build a filter!\nTry expanding or choosing another item.");\r\ng_free(strtmp);\r\nreturn;\r\n}\r\ng_free(strtmp);\r\n}\r\napply_selected_filter (callback_action, str);\r\ngtk_tree_path_free(path);\r\ng_free (str);\r\n}\r\nstatic void\r\napply_as_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_MATCH(ACTYPE_SELECTED, 0));\r\n}\r\nstatic void\r\napply_as_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_MATCH(ACTYPE_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\napply_as_and_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_MATCH(ACTYPE_AND_SELECTED, 0));\r\n}\r\nstatic void\r\napply_as_or_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_MATCH(ACTYPE_OR_SELECTED, 0));\r\n}\r\nstatic void\r\napply_as_and_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_MATCH(ACTYPE_AND_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\napply_as_or_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_MATCH(ACTYPE_OR_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\nprep_as_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_PREPARE(ACTYPE_SELECTED, 0));\r\n}\r\nstatic void\r\nprep_as_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_PREPARE(ACTYPE_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\nprep_as_and_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_PREPARE(ACTYPE_AND_SELECTED, 0));\r\n}\r\nstatic void\r\nprep_as_or_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_PREPARE(ACTYPE_OR_SELECTED, 0));\r\n}\r\nstatic void\r\nprep_as_and_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_PREPARE(ACTYPE_AND_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\nprep_as_or_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_PREPARE(ACTYPE_OR_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\nfind_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_FIND_FRAME(ACTYPE_SELECTED, 0));\r\n}\r\nstatic void\r\nfind_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_FIND_FRAME(ACTYPE_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\nfind_prev_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_FIND_PREVIOUS(ACTYPE_SELECTED, 0));\r\n}\r\nstatic void\r\nfind_prev_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_FIND_PREVIOUS(ACTYPE_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\nfind_next_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_FIND_NEXT(ACTYPE_SELECTED, 0));\r\n}\r\nstatic void\r\nfind_next_not_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_FIND_NEXT(ACTYPE_NOT_SELECTED, 0));\r\n}\r\nstatic void\r\ncolor_selected_cb(GtkWidget *widget, gpointer user_data)\r\n{\r\nproto_hier_select_filter_cb( widget , user_data, CALLBACK_COLORIZE(ACTYPE_SELECTED, 0));\r\n}\r\nstatic void\r\nfill_in_tree_node(GNode *node, gpointer data)\r\n{\r\nph_stats_node_t *stats = (ph_stats_node_t *)node->data;\r\ndraw_info_t *di = (draw_info_t *)data;\r\nph_stats_t *ps = di->ps;\r\ndraw_info_t child_di;\r\ndouble seconds;\r\ngchar *text[NUM_STAT_COLUMNS];\r\nfloat percent_packets, percent_bytes;\r\nGtkTreeView *tree_view = di->tree_view;\r\nGtkTreeIter *iter = di->iter;\r\nGtkTreeStore *store;\r\nGtkTreeIter new_iter;\r\nseconds = ps->last_time - ps->first_time;\r\npercent_packets = (float) PCT(stats->num_pkts_total, ps->tot_packets);\r\npercent_bytes = (float) PCT(stats->num_bytes_total, ps->tot_bytes);\r\ntext[PROTOCOL_COLUMN] = (gchar *) (stats->hfinfo->name);\r\ntext[PRCT_PKTS_COLUMN] = g_strdup_printf("%.2f %%", percent_packets);\r\ntext[PKTS_COLUMN] = g_strdup_printf("%u", stats->num_pkts_total);\r\ntext[PRCT_BYTES_COLUMN] = g_strdup_printf("%.2f %%", percent_bytes);\r\ntext[BYTES_COLUMN] = g_strdup_printf("%u", stats->num_bytes_total);\r\nif (seconds > 0.0) {\r\ntext[BANDWIDTH_COLUMN] = g_strdup_printf("%.3f",\r\nBANDWIDTH(stats->num_bytes_total, seconds));\r\n} else {\r\ntext[BANDWIDTH_COLUMN] = g_strdup("n.c.");\r\n}\r\ntext[END_PKTS_COLUMN] = g_strdup_printf("%u", stats->num_pkts_last);\r\ntext[END_BYTES_COLUMN] = g_strdup_printf("%u", stats->num_bytes_last);\r\nif (seconds > 0.0) {\r\ntext[END_BANDWIDTH_COLUMN] = g_strdup_printf("%.3f",\r\nBANDWIDTH(stats->num_bytes_last, seconds));\r\n} else {\r\ntext[END_BANDWIDTH_COLUMN] = g_strdup("n.c.");\r\n}\r\nstore = GTK_TREE_STORE(gtk_tree_view_get_model(tree_view));\r\ngtk_tree_store_append(store, &new_iter, iter);\r\ngtk_tree_store_set(store, &new_iter,\r\nPROTOCOL_COLUMN, text[PROTOCOL_COLUMN],\r\nPRCT_PKTS_COLUMN, text[PRCT_PKTS_COLUMN],\r\nPKTS_COLUMN, text[PKTS_COLUMN],\r\nPRCT_BYTES_COLUMN, text[PRCT_BYTES_COLUMN],\r\nBYTES_COLUMN, text[BYTES_COLUMN],\r\nBANDWIDTH_COLUMN, text[BANDWIDTH_COLUMN],\r\nEND_PKTS_COLUMN, text[END_PKTS_COLUMN],\r\nEND_BYTES_COLUMN, text[END_BYTES_COLUMN],\r\nEND_BANDWIDTH_COLUMN, text[END_BANDWIDTH_COLUMN],\r\nFILTER_NAME, stats->hfinfo->abbrev,\r\nPRCT_PKTS_VALUE_COLUMN, percent_packets,\r\nPRCT_BYTES_VALUE_COLUMN, percent_bytes,\r\n-1);\r\ng_free(text[PRCT_PKTS_COLUMN]);\r\ng_free(text[PKTS_COLUMN]);\r\ng_free(text[PRCT_BYTES_COLUMN]);\r\ng_free(text[BYTES_COLUMN]);\r\nif (seconds > 0.0) g_free(text[BANDWIDTH_COLUMN]);\r\ng_free(text[END_PKTS_COLUMN]);\r\ng_free(text[END_BYTES_COLUMN]);\r\nif (seconds > 0.0) g_free(text[END_BANDWIDTH_COLUMN]);\r\nchild_di.tree_view = tree_view;\r\nchild_di.iter = &new_iter;\r\nchild_di.ps = ps;\r\ng_node_children_foreach(node, G_TRAVERSE_ALL,\r\nfill_in_tree_node, &child_di);\r\n}\r\nstatic void\r\nfill_in_tree(GtkWidget *tree_lcl, ph_stats_t *ps)\r\n{\r\ndraw_info_t di;\r\ndi.tree_view = GTK_TREE_VIEW(tree_lcl);\r\ndi.iter = NULL;\r\ndi.ps = ps;\r\ng_node_children_foreach(ps->stats_tree, G_TRAVERSE_ALL,\r\nfill_in_tree_node, &di);\r\n}\r\nstatic gboolean\r\nproto_hier_show_popup_menu_cb(GtkWidget *widget _U_, GdkEvent *event, GtkWidget *popup_menu_object)\r\n{\r\nGdkEventButton *bevent = (GdkEventButton *)event;\r\nif (event->type==GDK_BUTTON_PRESS && bevent->button==3) {\r\ngtk_menu_popup(GTK_MENU(popup_menu_object), NULL, NULL, NULL, NULL, bevent->button, bevent->time);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\nproto_hier_create_popup_menu(void)\r\n{\r\nGtkUIManager *ui_manager;\r\nGtkActionGroup *action_group;\r\nGError *error = NULL;\r\nGtkWidget *popup_menu_object;\r\naction_group = gtk_action_group_new ("ProtoHierStatsTFilterPopupActionGroup");\r\ngtk_action_group_add_actions (action_group,\r\n(GtkActionEntry *)proto_hier_stats_popup_entries,\r\nG_N_ELEMENTS(proto_hier_stats_popup_entries),\r\nNULL);\r\nui_manager = gtk_ui_manager_new ();\r\ngtk_ui_manager_insert_action_group (ui_manager,\r\naction_group,\r\n0);\r\ngtk_ui_manager_add_ui_from_string (ui_manager,ui_desc_proto_hier_stats_filter_popup, -1, &error);\r\nif (error != NULL)\r\n{\r\nfprintf (stderr, "Warning: building proto hier ststs filter popup failed: %s\n",\r\nerror->message);\r\ng_error_free (error);\r\nerror = NULL;\r\n}\r\npopup_menu_object = gtk_ui_manager_get_widget(ui_manager, "/ProtoHierStatsFilterPopup");\r\ng_signal_connect(tree, "button_press_event", G_CALLBACK(proto_hier_show_popup_menu_cb), popup_menu_object);\r\n}\r\nstatic void\r\ncreate_tree(GtkWidget *container, ph_stats_t *ps)\r\n{\r\nGtkWidget *sw;\r\nGtkTreeView *tree_view;\r\nGtkTreeStore *store;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nsw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(sw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(container), sw, TRUE, TRUE, 0);\r\nstore = gtk_tree_store_new(NUM_STAT_COLUMNS, G_TYPE_STRING, G_TYPE_STRING,\r\nG_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING,\r\nG_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING,\r\nG_TYPE_STRING, G_TYPE_POINTER, G_TYPE_FLOAT,\r\nG_TYPE_FLOAT);\r\ntree = tree_view_new(GTK_TREE_MODEL(store));\r\ng_object_unref(G_OBJECT(store));\r\ntree_view = GTK_TREE_VIEW(tree);\r\ngtk_tree_view_set_headers_visible(tree_view, TRUE);\r\ngtk_tree_view_set_headers_clickable(tree_view, FALSE);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Protocol", renderer,\r\n"text", PROTOCOL_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_progress_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("% Packets", renderer,\r\n"text", PRCT_PKTS_COLUMN,\r\n"value", PRCT_PKTS_VALUE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_expand(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Packets", renderer,\r\n"text", PKTS_COLUMN,\r\nNULL);\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_progress_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("% Bytes", renderer,\r\n"text", PRCT_BYTES_COLUMN,\r\n"value", PRCT_BYTES_VALUE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_expand(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Bytes", renderer,\r\n"text", BYTES_COLUMN,\r\nNULL);\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Mbit/s", renderer,\r\n"text", BANDWIDTH_COLUMN,\r\nNULL);\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("End Packets", renderer,\r\n"text", END_PKTS_COLUMN,\r\nNULL);\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("End Bytes", renderer,\r\n"text", END_BYTES_COLUMN,\r\nNULL);\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("End Mbit/s", renderer,\r\n"text", END_BANDWIDTH_COLUMN,\r\nNULL);\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(tree_view, column);\r\nfill_in_tree(tree, ps);\r\ngtk_tree_view_expand_all(tree_view);\r\nproto_hier_create_popup_menu ();\r\ngtk_container_add(GTK_CONTAINER(sw), tree);\r\n}\r\nvoid\r\nproto_hier_stats_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nph_stats_t *ps;\r\nGtkWidget *dlg, *close_bt, *help_bt, *vbox, *bbox;\r\nGtkWidget *label;\r\nchar title[256];\r\nconst char *current_filter;\r\nps = ph_stats_new(&cfile);\r\nif (ps == NULL) {\r\nreturn;\r\n}\r\ndlg = window_new(GTK_WINDOW_TOPLEVEL, "Wireshark: Protocol Hierarchy Statistics");\r\ngtk_window_set_default_size(GTK_WINDOW(dlg), DEF_DLG_WIDTH, MAX_DLG_HEIGHT);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(dlg), vbox);\r\ncurrent_filter=gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\nif (current_filter && strlen(current_filter) != 0) {\r\ng_snprintf(title, sizeof(title), "Display filter: %s", current_filter);\r\n} else {\r\ng_strlcpy(title, "Display filter: none", sizeof(title));\r\n}\r\nlabel = gtk_label_new(title);\r\ngtk_box_pack_start(GTK_BOX(vbox), label, FALSE, FALSE, 0);\r\ncreate_tree(vbox, ps);\r\nph_stats_free(ps);\r\nbbox = dlg_button_row_new(GTK_STOCK_CLOSE, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_end(GTK_BOX(vbox), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(dlg, close_bt, window_cancel_button_cb);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_STATS_PROTO_HIERARCHY_DIALOG);\r\ng_signal_connect(dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ngtk_widget_show_all(dlg);\r\nwindow_present(dlg);\r\n}

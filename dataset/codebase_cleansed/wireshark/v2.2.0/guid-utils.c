static int\r\nResolveWin32UUID(e_guid_t if_id, char *uuid_name, int uuid_name_max_len)\r\n{\r\nTCHAR *reg_uuid_name;\r\nHKEY hKey = NULL;\r\nDWORD uuid_max_size = MAX_PATH;\r\nTCHAR *reg_uuid_str;\r\nreg_uuid_name=wmem_alloc(wmem_packet_scope(), (MAX_PATH*sizeof(TCHAR))+1);\r\nreg_uuid_str=wmem_alloc(wmem_packet_scope(), (MAX_PATH*sizeof(TCHAR))+1);\r\nif(uuid_name_max_len < 2){\r\nreturn 0;\r\n}\r\nreg_uuid_name[0] = '\0';\r\nStringCchPrintf(reg_uuid_str, MAX_PATH, _T("SOFTWARE\\Classes\\Interface\\{%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x}"),\r\nif_id.data1, if_id.data2, if_id.data3,\r\nif_id.data4[0], if_id.data4[1],\r\nif_id.data4[2], if_id.data4[3],\r\nif_id.data4[4], if_id.data4[5],\r\nif_id.data4[6], if_id.data4[7]);\r\nif (RegOpenKeyEx(HKEY_LOCAL_MACHINE, reg_uuid_str, 0, KEY_QUERY_VALUE, &hKey) == ERROR_SUCCESS) {\r\nif (RegQueryValueEx(hKey, NULL, NULL, NULL, (LPBYTE)reg_uuid_name, &uuid_max_size) == ERROR_SUCCESS && uuid_max_size <= MAX_PATH) {\r\ng_snprintf(uuid_name, uuid_name_max_len, "%s", utf_16to8(reg_uuid_name));\r\nRegCloseKey(hKey);\r\nreturn (int) strlen(uuid_name);\r\n}\r\nRegCloseKey(hKey);\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nguids_add_guid(const e_guid_t *guid, const gchar *name)\r\n{\r\nwmem_tree_key_t guidkey[2];\r\nguint32 g[4];\r\ng[0]=guid->data1;\r\ng[1]=guid->data2;\r\ng[1]<<=16;\r\ng[1]|=guid->data3;\r\ng[2]=guid->data4[0];\r\ng[2]<<=8;\r\ng[2]|=guid->data4[1];\r\ng[2]<<=8;\r\ng[2]|=guid->data4[2];\r\ng[2]<<=8;\r\ng[2]|=guid->data4[3];\r\ng[3]=guid->data4[4];\r\ng[3]<<=8;\r\ng[3]|=guid->data4[5];\r\ng[3]<<=8;\r\ng[3]|=guid->data4[6];\r\ng[3]<<=8;\r\ng[3]|=guid->data4[7];\r\nguidkey[0].key=g;\r\nguidkey[0].length=4;\r\nguidkey[1].length=0;\r\nwmem_tree_insert32_array(guid_to_name_tree, &guidkey[0], (gchar *) name);\r\n}\r\nconst gchar *\r\nguids_get_guid_name(const e_guid_t *guid)\r\n{\r\nwmem_tree_key_t guidkey[2];\r\nguint32 g[4];\r\nchar *name;\r\n#ifdef _WIN32\r\nstatic char *uuid_name;\r\n#endif\r\ng[0]=guid->data1;\r\ng[1]=guid->data2;\r\ng[1]<<=16;\r\ng[1]|=guid->data3;\r\ng[2]=guid->data4[0];\r\ng[2]<<=8;\r\ng[2]|=guid->data4[1];\r\ng[2]<<=8;\r\ng[2]|=guid->data4[2];\r\ng[2]<<=8;\r\ng[2]|=guid->data4[3];\r\ng[3]=guid->data4[4];\r\ng[3]<<=8;\r\ng[3]|=guid->data4[5];\r\ng[3]<<=8;\r\ng[3]|=guid->data4[6];\r\ng[3]<<=8;\r\ng[3]|=guid->data4[7];\r\nguidkey[0].key=g;\r\nguidkey[0].length=4;\r\nguidkey[1].length=0;\r\nif((name = (char *)wmem_tree_lookup32_array(guid_to_name_tree, &guidkey[0]))){\r\nreturn name;\r\n}\r\n#ifdef _WIN32\r\nuuid_name=wmem_alloc(wmem_packet_scope(), 128);\r\nif(ResolveWin32UUID(*guid, uuid_name, 128)) {\r\nreturn uuid_name;\r\n}\r\n#endif\r\nreturn NULL;\r\n}\r\nvoid\r\nguids_init(void)\r\n{\r\nguid_to_name_tree=wmem_tree_new(wmem_epan_scope());\r\n}\r\nconst gchar *\r\nguids_resolve_guid_to_str(const e_guid_t *guid)\r\n{\r\nconst gchar *name;\r\nname=guids_get_guid_name(guid);\r\nif(name){\r\nreturn name;\r\n}\r\nreturn wmem_strdup_printf(wmem_packet_scope(), "%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x",\r\nguid->data1, guid->data2, guid->data3,\r\nguid->data4[0], guid->data4[1],\r\nguid->data4[2], guid->data4[3],\r\nguid->data4[4], guid->data4[5],\r\nguid->data4[6], guid->data4[7]);\r\n}\r\nint guid_cmp(const e_guid_t *g1, const e_guid_t *g2)\r\n{\r\nif (g1->data1 != g2->data1) {\r\nreturn (g1->data1 < g2->data1) ? -1 : 1;\r\n}\r\nif (g1->data2 != g2->data2) {\r\nreturn (g1->data2 < g2->data2) ? -1 : 1;\r\n}\r\nif (g1->data3 != g2->data3) {\r\nreturn (g1->data3 < g2->data3) ? -1 : 1;\r\n}\r\nreturn memcmp(&g1->data4[0], &g2->data4[0], 8);\r\n}

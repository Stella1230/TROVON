static void\r\ndissect_aodv_ext(tvbuff_t * tvb, packet_info *pinfo, int offset, proto_tree * tree)\r\n{\r\nproto_tree *ext_tree;\r\nproto_item *len_item;\r\nguint8 type, len;\r\nagain:\r\nif ((int) tvb_reported_length(tvb) <= offset)\r\nreturn;\r\ntype = tvb_get_guint8(tvb, offset);\r\nlen = tvb_get_guint8(tvb, offset + 1);\r\next_tree = proto_tree_add_subtree(tree, tvb, offset, 2 + len, ett_aodv_extensions, NULL, "Extensions");\r\nproto_tree_add_item(ext_tree, hf_aodv_ext_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nlen_item = proto_tree_add_uint_format_value(ext_tree, hf_aodv_ext_length, tvb, offset + 1, 1,\r\nlen, "%u bytes", len);\r\nif (len == 0) {\r\nexpert_add_info(pinfo, len_item, &ei_aodv_ext_length);\r\nreturn;\r\n}\r\noffset += 2;\r\nswitch (type) {\r\ncase AODV_EXT_INT:\r\nproto_tree_add_uint(ext_tree, hf_aodv_ext_interval,\r\ntvb, offset, 4, tvb_get_ntohl(tvb, offset));\r\nbreak;\r\ncase AODV_EXT_NTP:\r\nproto_tree_add_item(ext_tree, hf_aodv_ext_timestamp,\r\ntvb, offset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\noffset += len;\r\ngoto again;\r\n}\r\nstatic void\r\ndissect_aodv_rreq(tvbuff_t *tvb, packet_info *pinfo, proto_tree *aodv_tree,\r\nproto_item *ti, gboolean is_ipv6)\r\n{\r\nint offset = 1;\r\nproto_item *tj;\r\nguint8 flags;\r\nguint8 hop_count;\r\nguint32 rreq_id;\r\nconst gchar *dest_addr_v4;\r\nconst gchar *dest_addr_v6;\r\nguint32 dest_seqno;\r\nconst gchar *orig_addr_v4;\r\nconst gchar *orig_addr_v6;\r\nguint32 orig_seqno;\r\nint extlen;\r\nstatic const int * aodv_flags[] = {\r\n&hf_aodv_flags_rreq_join,\r\n&hf_aodv_flags_rreq_repair,\r\n&hf_aodv_flags_rreq_gratuitous,\r\n&hf_aodv_flags_rreq_destinationonly,\r\n&hf_aodv_flags_rreq_unknown,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\ntj = proto_tree_add_bitmask(aodv_tree, tvb, offset, hf_aodv_flags,\r\nett_aodv_flags, aodv_flags, ENC_NA);\r\nif (flags & RREQ_JOIN)\r\nproto_item_append_text(tj, " J");\r\nif (flags & RREQ_REP)\r\nproto_item_append_text(tj, " R");\r\nif (flags & RREQ_GRATRREP)\r\nproto_item_append_text(tj, " G");\r\nif (flags & RREQ_DESTONLY)\r\nproto_item_append_text(tj, " D");\r\nif (flags & RREQ_UNKNSEQ)\r\nproto_item_append_text(tj, " U");\r\noffset += 2;\r\nhop_count = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_hopcount, tvb, offset, 1,\r\nhop_count);\r\noffset += 1;\r\nrreq_id = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_rreq_id, tvb, offset, 4,\r\nrreq_id);\r\noffset += 4;\r\nif (is_ipv6) {\r\ndest_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_dest_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Dest IP: %s", dest_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", D: %s", dest_addr_v6);\r\noffset += INET6_ADDRLEN;\r\n} else {\r\ndest_addr_v4 = tvb_ip_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_dest_ip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Dest IP: %s", dest_addr_v4);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", D: %s", dest_addr_v4);\r\noffset += 4;\r\n}\r\ndest_seqno = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_dest_seqno, tvb, offset, 4,\r\ndest_seqno);\r\noffset += 4;\r\nif (is_ipv6) {\r\norig_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_orig_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Orig IP: %s", orig_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", O: %s", orig_addr_v6);\r\noffset += INET6_ADDRLEN;\r\n} else {\r\norig_addr_v4 = tvb_ip_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_orig_ip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Orig IP: %s", orig_addr_v4);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", O: %s", orig_addr_v4);\r\noffset += 4;\r\n}\r\norig_seqno = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_orig_seqno, tvb, offset, 4,\r\norig_seqno);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Id=%u Hcnt=%u DSN=%u OSN=%u",\r\nrreq_id,\r\nhop_count,\r\ndest_seqno,\r\norig_seqno);\r\noffset += 4;\r\nextlen = tvb_reported_length_remaining(tvb, offset);\r\nif (extlen > 0)\r\ndissect_aodv_ext(tvb, pinfo, offset, aodv_tree);\r\n}\r\nstatic void\r\ndissect_aodv_rrep(tvbuff_t *tvb, packet_info *pinfo, proto_tree *aodv_tree,\r\nproto_item *ti, gboolean is_ipv6)\r\n{\r\nint offset = 1;\r\nproto_item *tj;\r\nguint8 flags;\r\nguint8 prefix_sz;\r\nguint8 hop_count;\r\nconst gchar *dest_addr_v4;\r\nconst gchar *dest_addr_v6;\r\nguint32 dest_seqno;\r\nconst gchar *orig_addr_v4;\r\nconst gchar *orig_addr_v6;\r\nguint32 lifetime;\r\nint extlen;\r\nstatic const int * aodv_flags[] = {\r\n&hf_aodv_flags_rrep_repair,\r\n&hf_aodv_flags_rrep_ack,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\ntj = proto_tree_add_bitmask(aodv_tree, tvb, offset, hf_aodv_flags,\r\nett_aodv_flags, aodv_flags, ENC_NA);\r\nif (flags & RREP_REP)\r\nproto_item_append_text(tj, " R");\r\nif (flags & RREP_ACK_REQ)\r\nproto_item_append_text(tj, " A");\r\noffset += 1;\r\nprefix_sz = tvb_get_guint8(tvb, offset) & 0x1F;\r\nif (aodv_tree)\r\nproto_tree_add_uint(aodv_tree, hf_aodv_prefix_sz, tvb, offset, 1,\r\nprefix_sz);\r\noffset += 1;\r\nhop_count = tvb_get_guint8(tvb, offset);\r\nif (aodv_tree)\r\nproto_tree_add_uint(aodv_tree, hf_aodv_hopcount, tvb, offset, 1,\r\nhop_count);\r\noffset += 1;\r\nif (is_ipv6) {\r\ndest_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_dest_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Dest IP: %s", dest_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", D: %s", dest_addr_v6);\r\noffset += INET6_ADDRLEN;\r\n} else {\r\ndest_addr_v4 = tvb_ip_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_dest_ip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Dest IP: %s", dest_addr_v4);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", D: %s", dest_addr_v4);\r\noffset += 4;\r\n}\r\ndest_seqno = tvb_get_ntohl(tvb, offset);\r\nif (aodv_tree)\r\nproto_tree_add_uint(aodv_tree, hf_aodv_dest_seqno, tvb, offset, 4,\r\ndest_seqno);\r\noffset += 4;\r\nif (is_ipv6) {\r\norig_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_orig_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Orig IP: %s", orig_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", O: %s", orig_addr_v6);\r\noffset += INET6_ADDRLEN;\r\n} else {\r\norig_addr_v4 = tvb_ip_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_orig_ip, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Orig IP: %s", orig_addr_v4);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", O: %s", orig_addr_v4);\r\noffset += 4;\r\n}\r\nlifetime = tvb_get_ntohl(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_uint(aodv_tree, hf_aodv_lifetime, tvb, offset, 4,\r\nlifetime);\r\nproto_item_append_text(ti, ", Lifetime=%u", lifetime);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Hcnt=%u DSN=%u Lifetime=%u",\r\nhop_count,\r\ndest_seqno,\r\nlifetime);\r\noffset += 4;\r\nextlen = tvb_reported_length_remaining(tvb, offset);\r\nif (extlen > 0)\r\ndissect_aodv_ext(tvb, pinfo, offset, aodv_tree);\r\n}\r\nstatic void\r\ndissect_aodv_rerr(tvbuff_t *tvb, packet_info *pinfo, proto_tree *aodv_tree,\r\ngboolean is_ipv6)\r\n{\r\nint offset = 1;\r\nproto_item *tj;\r\nproto_tree *aodv_unreach_dest_tree;\r\nguint8 flags;\r\nguint8 dest_count;\r\nint i;\r\nstatic const int * aodv_flags[] = {\r\n&hf_aodv_flags_rerr_nodelete,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\ntj = proto_tree_add_bitmask(aodv_tree, tvb, offset, hf_aodv_flags,\r\nett_aodv_flags, aodv_flags, ENC_NA);\r\nif (flags & RERR_NODEL)\r\nproto_item_append_text(tj, " N");\r\noffset += 2;\r\ndest_count = tvb_get_guint8(tvb, offset);\r\nif (aodv_tree)\r\nproto_tree_add_uint(aodv_tree, hf_aodv_destcount, tvb, offset, 1,\r\ndest_count);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Dest Count=%u",\r\ndest_count);\r\noffset += 1;\r\nif (is_ipv6) {\r\naodv_unreach_dest_tree = proto_tree_add_subtree(aodv_tree, tvb, offset,\r\n(INET6_ADDRLEN + 4)*dest_count, ett_aodv_unreach_dest, NULL,\r\n"Unreachable Destinations");\r\nfor (i = 0; i < dest_count; i++) {\r\nproto_tree_add_item(aodv_unreach_dest_tree,\r\nhf_aodv_unreach_dest_ipv6,\r\ntvb, offset, INET6_ADDRLEN, ENC_NA);\r\noffset += INET6_ADDRLEN;\r\nproto_tree_add_item(aodv_unreach_dest_tree, hf_aodv_dest_seqno,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\n} else {\r\naodv_unreach_dest_tree = proto_tree_add_subtree(aodv_tree, tvb, offset, (4 + 4)*dest_count,\r\nett_aodv_unreach_dest, NULL, "Unreachable Destinations");\r\nfor (i = 0; i < dest_count; i++) {\r\nproto_tree_add_item(aodv_unreach_dest_tree, hf_aodv_unreach_dest_ip,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(aodv_unreach_dest_tree, hf_aodv_dest_seqno,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_aodv_draft_01_v6_rreq(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *aodv_tree, proto_item *ti)\r\n{\r\nint offset = 1;\r\nproto_item *tj;\r\nguint8 flags;\r\nguint8 hop_count;\r\nguint32 rreq_id;\r\nguint32 dest_seqno;\r\nguint32 orig_seqno;\r\nconst gchar *dest_addr_v6;\r\nconst gchar *orig_addr_v6;\r\nint extlen;\r\nstatic const int * aodv_flags[] = {\r\n&hf_aodv_flags_rreq_join,\r\n&hf_aodv_flags_rreq_repair,\r\n&hf_aodv_flags_rreq_gratuitous,\r\n&hf_aodv_flags_rreq_destinationonly,\r\n&hf_aodv_flags_rreq_unknown,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\ntj = proto_tree_add_bitmask(aodv_tree, tvb, offset, hf_aodv_flags,\r\nett_aodv_flags, aodv_flags, ENC_NA);\r\nif (flags & RREQ_JOIN)\r\nproto_item_append_text(tj, " J");\r\nif (flags & RREQ_REP)\r\nproto_item_append_text(tj, " R");\r\nif (flags & RREQ_GRATRREP)\r\nproto_item_append_text(tj, " G");\r\nif (flags & RREQ_DESTONLY)\r\nproto_item_append_text(tj, " D");\r\nif (flags & RREQ_UNKNSEQ)\r\nproto_item_append_text(tj, " U");\r\noffset += 2;\r\nhop_count = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_hopcount, tvb, offset, 1,\r\nhop_count);\r\noffset += 1;\r\nrreq_id = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_rreq_id, tvb, offset, 4,\r\nrreq_id);\r\noffset += 4;\r\ndest_seqno = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_dest_seqno, tvb, offset, 4,\r\ndest_seqno);\r\noffset += 4;\r\norig_seqno = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_orig_seqno, tvb, offset, 4,\r\norig_seqno);\r\noffset += 4;\r\ndest_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_dest_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Dest IP: %s", dest_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", D: %s", dest_addr_v6);\r\noffset += INET6_ADDRLEN;\r\norig_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_orig_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Orig IP: %s", orig_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n", O: %s Id=%u Hcnt=%u DSN=%u OSN=%u",\r\norig_addr_v6,\r\nrreq_id,\r\nhop_count,\r\ndest_seqno,\r\norig_seqno);\r\noffset += INET6_ADDRLEN;\r\nextlen = tvb_reported_length_remaining(tvb, offset);\r\nif (extlen > 0)\r\ndissect_aodv_ext(tvb, pinfo, offset, aodv_tree);\r\n}\r\nstatic void\r\ndissect_aodv_draft_01_v6_rrep(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *aodv_tree, proto_item *ti)\r\n{\r\nint offset = 1;\r\nproto_item *tj;\r\nguint8 flags;\r\nguint8 prefix_sz;\r\nguint8 hop_count;\r\nguint32 dest_seqno;\r\nconst gchar *dest_addr_v6;\r\nconst gchar *orig_addr_v6;\r\nguint32 lifetime;\r\nint extlen;\r\nstatic const int * aodv_flags[] = {\r\n&hf_aodv_flags_rrep_repair,\r\n&hf_aodv_flags_rrep_ack,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\ntj = proto_tree_add_bitmask(aodv_tree, tvb, offset, hf_aodv_flags,\r\nett_aodv_flags, aodv_flags, ENC_NA);\r\nif (flags & RREP_REP)\r\nproto_item_append_text(tj, " R");\r\nif (flags & RREP_ACK_REQ)\r\nproto_item_append_text(tj, " A");\r\noffset += 1;\r\nprefix_sz = tvb_get_guint8(tvb, offset) & 0x7F;\r\nproto_tree_add_uint(aodv_tree, hf_aodv_prefix_sz, tvb, offset, 1,\r\nprefix_sz);\r\noffset += 1;\r\nhop_count = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_hopcount, tvb, offset, 1,\r\nhop_count);\r\noffset += 1;\r\ndest_seqno = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_dest_seqno, tvb, offset, 4,\r\ndest_seqno);\r\noffset += 4;\r\ndest_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_dest_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Dest IP: %s", dest_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", D: %s", dest_addr_v6);\r\noffset += INET6_ADDRLEN;\r\norig_addr_v6 = tvb_ip6_to_str(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_item(aodv_tree, hf_aodv_orig_ipv6, tvb, offset,\r\nINET6_ADDRLEN, ENC_NA);\r\nproto_item_append_text(ti, ", Orig IP: %s", orig_addr_v6);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", O: %s", orig_addr_v6);\r\noffset += INET6_ADDRLEN;\r\nlifetime = tvb_get_ntohl(tvb, offset);\r\nif (aodv_tree) {\r\nproto_tree_add_uint(aodv_tree, hf_aodv_lifetime, tvb, offset, 4,\r\nlifetime);\r\nproto_item_append_text(ti, ", Lifetime=%u", lifetime);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Hcnt=%u DSN=%u Lifetime=%u",\r\nhop_count,\r\ndest_seqno,\r\nlifetime);\r\noffset += 4;\r\nextlen = tvb_reported_length_remaining(tvb, offset);\r\nif (extlen > 0)\r\ndissect_aodv_ext(tvb, pinfo, offset, aodv_tree);\r\n}\r\nstatic void\r\ndissect_aodv_draft_01_v6_rerr(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *aodv_tree)\r\n{\r\nint offset = 1;\r\nproto_item *tj;\r\nproto_tree *aodv_unreach_dest_tree;\r\nguint8 flags;\r\nguint8 dest_count;\r\nint i;\r\nstatic const int * aodv_flags[] = {\r\n&hf_aodv_flags_rerr_nodelete,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\ntj = proto_tree_add_bitmask(aodv_tree, tvb, offset, hf_aodv_flags,\r\nett_aodv_flags, aodv_flags, ENC_NA);\r\nif (flags & RERR_NODEL)\r\nproto_item_append_text(tj, " N");\r\noffset += 2;\r\ndest_count = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(aodv_tree, hf_aodv_destcount, tvb, offset, 1,\r\ndest_count);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Dest Count=%u",\r\ndest_count);\r\noffset += 1;\r\naodv_unreach_dest_tree = proto_tree_add_subtree(aodv_tree, tvb, offset,\r\n(4 + INET6_ADDRLEN)*dest_count,\r\nett_aodv_unreach_dest, NULL,\r\n"Unreachable Destinations");\r\nfor (i = 0; i < dest_count; i++) {\r\nproto_tree_add_item(aodv_unreach_dest_tree, hf_aodv_dest_seqno,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(aodv_unreach_dest_tree,\r\nhf_aodv_unreach_dest_ipv6,\r\ntvb, offset, INET6_ADDRLEN, ENC_NA);\r\noffset += INET6_ADDRLEN;\r\n}\r\n}\r\nstatic int\r\ndissect_aodv(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti, *type_item;\r\nproto_tree *aodv_tree;\r\ngboolean is_ipv6;\r\nguint8 type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AODV");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nis_ipv6 = (pinfo->src.type == AT_IPv6);\r\ntype = tvb_get_guint8(tvb, 0);\r\nif (try_val_to_str(type, type_vals) == NULL) {\r\nreturn 0;\r\n}\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(type, type_vals,\r\n"Unknown AODV Packet Type (%u)"));\r\nti = proto_tree_add_protocol_format(tree, proto_aodv, tvb, 0, -1,\r\n"Ad hoc On-demand Distance Vector Routing Protocol, %s",\r\nval_to_str(type, type_vals, "Unknown AODV Packet Type (%u)"));\r\naodv_tree = proto_item_add_subtree(ti, ett_aodv);\r\ntype_item = proto_tree_add_uint(aodv_tree, hf_aodv_type, tvb, 0, 1, type);\r\nswitch (type) {\r\ncase RREQ:\r\ndissect_aodv_rreq(tvb, pinfo, aodv_tree, ti, is_ipv6);\r\nbreak;\r\ncase RREP:\r\ndissect_aodv_rrep(tvb, pinfo, aodv_tree, ti, is_ipv6);\r\nbreak;\r\ncase RERR:\r\ndissect_aodv_rerr(tvb, pinfo, aodv_tree, is_ipv6);\r\nbreak;\r\ncase RREP_ACK:\r\nbreak;\r\ncase DRAFT_01_V6_RREQ:\r\ndissect_aodv_draft_01_v6_rreq(tvb, pinfo, aodv_tree, ti);\r\nbreak;\r\ncase DRAFT_01_V6_RREP:\r\ndissect_aodv_draft_01_v6_rrep(tvb, pinfo, aodv_tree, ti);\r\nbreak;\r\ncase DRAFT_01_V6_RERR:\r\ndissect_aodv_draft_01_v6_rerr(tvb, pinfo, aodv_tree);\r\nbreak;\r\ncase DRAFT_01_V6_RREP_ACK:\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, type_item, &ei_aodv_type);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_aodv(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_aodv_type,\r\n{ "Type", "aodv.type",\r\nFT_UINT8, BASE_DEC, VALS(type_vals), 0x0,\r\n"AODV packet type", HFILL }\r\n},\r\n{ &hf_aodv_flags,\r\n{ "Flags", "aodv.flags",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rreq_join,\r\n{ "RREQ Join", "aodv.flags.rreq_join",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREQ_JOIN,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rreq_repair,\r\n{ "RREQ Repair", "aodv.flags.rreq_repair",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREQ_REP,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rreq_gratuitous,\r\n{ "RREQ Gratuitous RREP", "aodv.flags.rreq_gratuitous",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREQ_GRATRREP,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rreq_destinationonly,\r\n{ "RREQ Destination only", "aodv.flags.rreq_destinationonly",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREQ_DESTONLY,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rreq_unknown,\r\n{ "RREQ Unknown Sequence Number", "aodv.flags.rreq_unknown",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREQ_UNKNSEQ,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rrep_repair,\r\n{ "RREP Repair", "aodv.flags.rrep_repair",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREP_REP,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rrep_ack,\r\n{ "RREP Acknowledgement", "aodv.flags.rrep_ack",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RREP_ACK_REQ,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_flags_rerr_nodelete,\r\n{ "RERR No Delete", "aodv.flags.rerr_nodelete",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), RERR_NODEL,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_prefix_sz,\r\n{ "Prefix Size", "aodv.prefix_sz",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_hopcount,\r\n{ "Hop Count", "aodv.hopcount",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_rreq_id,\r\n{ "RREQ Id", "aodv.rreq_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_dest_ip,\r\n{ "Destination IP", "aodv.dest_ip",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"Destination IP Address", HFILL }\r\n},\r\n{ &hf_aodv_dest_ipv6,\r\n{ "Destination IPv6", "aodv.dest_ipv6",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\n"Destination IPv6 Address", HFILL}\r\n},\r\n{ &hf_aodv_dest_seqno,\r\n{ "Destination Sequence Number", "aodv.dest_seqno",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_orig_ip,\r\n{ "Originator IP", "aodv.orig_ip",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"Originator IP Address", HFILL }\r\n},\r\n{ &hf_aodv_orig_ipv6,\r\n{ "Originator IPv6", "aodv.orig_ipv6",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\n"Originator IPv6 Address", HFILL}\r\n},\r\n{ &hf_aodv_orig_seqno,\r\n{ "Originator Sequence Number", "aodv.orig_seqno",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_lifetime,\r\n{ "Lifetime", "aodv.lifetime",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_aodv_destcount,\r\n{ "Destination Count", "aodv.destcount",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Unreachable Destinations Count", HFILL }\r\n},\r\n{ &hf_aodv_unreach_dest_ip,\r\n{ "Unreachable Destination IP", "aodv.unreach_dest_ip",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"Unreachable Destination IP Address", HFILL }\r\n},\r\n{ &hf_aodv_unreach_dest_ipv6,\r\n{ "Unreachable Destination IPv6", "aodv.unreach_dest_ipv6",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\n"Unreachable Destination IPv6 Address", HFILL}\r\n},\r\n#if 0\r\n{ &hf_aodv_unreach_dest_seqno,\r\n{ "Unreachable Destination Sequence Number", "aodv.unreach_dest_seqno",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_aodv_ext_type,\r\n{ "Extension Type", "aodv.ext_type",\r\nFT_UINT8, BASE_DEC, VALS(exttype_vals), 0x0,\r\n"Extension Format Type", HFILL}\r\n},\r\n{ &hf_aodv_ext_length,\r\n{ "Extension Length", "aodv.ext_length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Extension Data Length", HFILL}\r\n},\r\n{ &hf_aodv_ext_interval,\r\n{ "Hello Interval", "aodv.hello_interval",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Hello Interval Extension", HFILL}\r\n},\r\n{ &hf_aodv_ext_timestamp,\r\n{ "Timestamp", "aodv.timestamp",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\n"Timestamp Extension", HFILL}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_aodv,\r\n&ett_aodv_flags,\r\n&ett_aodv_unreach_dest,\r\n&ett_aodv_extensions,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_aodv_ext_length, { "aodv.ext_length.invalid", PI_MALFORMED, PI_ERROR, "Invalid option length", EXPFILL }},\r\n{ &ei_aodv_type, { "aodv.ext_type.unknown", PI_PROTOCOL, PI_WARN, "Unknown AODV Packet Type", EXPFILL }},\r\n};\r\nexpert_module_t* expert_aodv;\r\nproto_aodv = proto_register_protocol("Ad hoc On-demand Distance Vector Routing Protocol", "AODV", "aodv");\r\nproto_register_field_array(proto_aodv, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_aodv = expert_register_protocol(proto_aodv);\r\nexpert_register_field_array(expert_aodv, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_aodv(void)\r\n{\r\ndissector_handle_t aodv_handle;\r\naodv_handle = create_dissector_handle(dissect_aodv,\r\nproto_aodv);\r\ndissector_add_uint("udp.port", UDP_PORT_AODV, aodv_handle);\r\n}

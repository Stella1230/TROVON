static void cf_opa_dw_to_b(gchar *buf, guint32 value)\r\n{\r\ng_snprintf(buf, ITEM_LABEL_LENGTH, "%u DWORDS (%u Bytes)", value, value * 4);\r\n}\r\nstatic void parse_opa_9B_Header(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset, guint8 *lnh_val)\r\n{\r\nproto_item *L2_9B_header_item;\r\nproto_tree *L2_9B_header_tree;\r\nvoid *src_addr, *dst_addr;\r\ngint local_offset = *offset;\r\ncol_prepend_fstr(pinfo->cinfo, COL_INFO, "9B: ");\r\nL2_9B_header_item = proto_tree_add_item(tree, hf_opa_9B, tvb, local_offset, 8, ENC_NA);\r\nL2_9B_header_tree = proto_item_add_subtree(L2_9B_header_item, ett_9b);\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_service_channel, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_link_version, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_service_level, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_reserved2, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_lnh, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\n*lnh_val = tvb_get_guint8(tvb, local_offset);\r\n*lnh_val &= 0x03;\r\nlocal_offset += 1;\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_dlid, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\ndst_addr = wmem_alloc(pinfo->pool, sizeof(guint16));\r\n*((guint16 *)dst_addr) = tvb_get_ntohs(tvb, local_offset);\r\nset_address(&pinfo->dst, AT_IB, sizeof(guint16), dst_addr);\r\nlocal_offset += 2;\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_reserved3, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_packet_length, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nlocal_offset += 2;\r\nproto_tree_add_item(L2_9B_header_tree, hf_opa_9B_slid, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nsrc_addr = wmem_alloc(pinfo->pool, sizeof(guint16));\r\n*((guint16 *)src_addr) = tvb_get_ntohs(tvb, local_offset);\r\nset_address(&pinfo->src, AT_IB, sizeof(guint16), src_addr);\r\nlocal_offset += 2;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_opa_grh(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset, guint8 *nextHdr)\r\n{\r\nproto_item *global_route_header_item;\r\nproto_tree *global_route_header_tree;\r\ngint local_offset = *offset;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "GRH: ");\r\nglobal_route_header_item = proto_tree_add_item(tree, hf_opa_grh, tvb, local_offset, 40, ENC_NA);\r\nglobal_route_header_tree = proto_item_add_subtree(global_route_header_item, ett_grh);\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_ip_version, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_traffic_class, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_flow_label, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_payload_length, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nlocal_offset += 2;\r\n*nextHdr = tvb_get_guint8(tvb, local_offset);\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_next_header, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_hop_limit, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_source_gid, tvb, local_offset, 16, ENC_NA);\r\nset_address_tvb(&pinfo->src, AT_IB, 16, tvb, local_offset);\r\nlocal_offset += 16;\r\nproto_tree_add_item(global_route_header_tree, hf_opa_grh_destination_gid, tvb, local_offset, 16, ENC_NA);\r\nset_address_tvb(&pinfo->dst, AT_IB, 16, tvb, local_offset);\r\nlocal_offset += 16;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_opa_bth(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset, guint8 *opCode)\r\n{\r\nproto_item *base_transport_header_item;\r\nproto_tree *base_transport_header_tree;\r\ngint local_offset = *offset;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "BTH: ");\r\nbase_transport_header_item = proto_tree_add_item(tree, hf_opa_bth, tvb, local_offset, 12, ENC_NA);\r\nbase_transport_header_tree = proto_item_add_subtree(base_transport_header_item, ett_bth);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_opcode, tvb, local_offset, 1, ENC_LITTLE_ENDIAN);\r\n*opCode = tvb_get_guint8(tvb, local_offset);\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str((guint32)(*opCode), vals_opa_bth_opcode, "Unknown OpCode (0x%0x)"));\r\nlocal_offset += 1;\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_solicited_event, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_migreq, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_pad_count, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_transport_header_version, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_partition_key, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nlocal_offset += 2;\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_fcn, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_bcn, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_Reserved8a, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_destination_qp, tvb, local_offset, 3, ENC_BIG_ENDIAN);\r\npinfo->destport = tvb_get_ntoh24(tvb, local_offset); local_offset += 3;\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_acknowledge_request, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(base_transport_header_tree, hf_opa_bth_packet_sequence_number, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\n*offset = local_offset;\r\n}\r\nstatic gboolean contains(guint32 OpCode, guint32 *Codes, gint32 length)\r\n{\r\ngint32 i;\r\nfor (i = 0; i < length; i++) {\r\nif ((OpCode ^ Codes[i]) == 0)\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gint32 find_next_header_sequence(guint32 OpCode)\r\n{\r\nif (contains(OpCode, &opCode_PAYLD[0], (gint32)array_length(opCode_PAYLD)))\r\nreturn PAYLD;\r\nif (contains(OpCode, &opCode_IMMDT_PAYLD[0], (gint32)array_length(opCode_IMMDT_PAYLD)))\r\nreturn IMMDT_PAYLD;\r\nif (contains(OpCode, &opCode_RDETH_DETH_PAYLD[0], (gint32)array_length(opCode_RDETH_DETH_PAYLD)))\r\nreturn RDETH_DETH_PAYLD;\r\nif (contains(OpCode, &opCode_RETH_PAYLD[0], (gint32)array_length(opCode_RETH_PAYLD)))\r\nreturn RETH_PAYLD;\r\nif (contains(OpCode, &opCode_RDETH_AETH_PAYLD[0], (gint32)array_length(opCode_RDETH_AETH_PAYLD)))\r\nreturn RDETH_AETH_PAYLD;\r\nif (contains(OpCode, &opCode_AETH_PAYLD[0], (gint32)array_length(opCode_AETH_PAYLD)))\r\nreturn AETH_PAYLD;\r\nif (contains(OpCode, &opCode_RDETH_DETH_IMMDT_PAYLD[0], (gint32)array_length(opCode_RDETH_DETH_IMMDT_PAYLD)))\r\nreturn RDETH_DETH_IMMDT_PAYLD;\r\nif (contains(OpCode, &opCode_RETH_IMMDT_PAYLD[0], (gint32)array_length(opCode_RETH_IMMDT_PAYLD)))\r\nreturn RETH_IMMDT_PAYLD;\r\nif (contains(OpCode, &opCode_RDETH_DETH_RETH_PAYLD[0], (gint32)array_length(opCode_RDETH_DETH_RETH_PAYLD)))\r\nreturn RDETH_DETH_RETH_PAYLD;\r\nif (contains(OpCode, &opCode_ATOMICETH[0], (gint32)array_length(opCode_ATOMICETH)))\r\nreturn ATOMICETH;\r\nif (contains(OpCode, &opCode_IETH_PAYLD[0], (gint32)array_length(opCode_IETH_PAYLD)))\r\nreturn IETH_PAYLD;\r\nif (contains(OpCode, &opCode_RDETH_DETH_ATOMICETH[0], (gint32)array_length(opCode_RDETH_DETH_ATOMICETH)))\r\nreturn RDETH_DETH_ATOMICETH;\r\nif (contains(OpCode, &opCode_PSM[0], (gint32)array_length(opCode_PSM)))\r\nreturn KDETH_PSM;\r\nif ((OpCode ^ RC_ACKNOWLEDGE) == 0)\r\nreturn AETH;\r\nif ((OpCode ^ RC_RDMA_READ_REQUEST) == 0)\r\nreturn RETH;\r\nif ((OpCode ^ RC_ATOMIC_ACKNOWLEDGE) == 0)\r\nreturn AETH_ATOMICACKETH;\r\nif ((OpCode ^ RD_RDMA_READ_RESPONSE_MIDDLE) == 0)\r\nreturn RDETH_PAYLD;\r\nif ((OpCode ^ RD_ACKNOWLEDGE) == 0)\r\nreturn RDETH_AETH;\r\nif ((OpCode ^ RD_ATOMIC_ACKNOWLEDGE) == 0)\r\nreturn RDETH_AETH_ATOMICACKETH;\r\nif ((OpCode ^ RD_RDMA_WRITE_ONLY_IMM) == 0)\r\nreturn RDETH_DETH_RETH_IMMDT_PAYLD;\r\nif ((OpCode ^ RD_RDMA_READ_REQUEST) == 0)\r\nreturn RDETH_DETH_RETH;\r\nif ((OpCode ^ RD_RESYNC) == 0)\r\nreturn RDETH_DETH;\r\nif ((OpCode ^ UD_SEND_ONLY) == 0)\r\nreturn DETH_PAYLD;\r\nif ((OpCode ^ UD_SEND_ONLY_IMM) == 0)\r\nreturn DETH_IMMDT_PAYLD;\r\nreturn -1;\r\n}\r\nstatic void parse_RDETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *RDETH_header_item;\r\nproto_tree *RDETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "RDETH: ");\r\nRDETH_header_item = proto_tree_add_item(tree, hf_opa_RDETH, tvb, local_offset, 4, ENC_NA);\r\nRDETH_header_tree = proto_item_add_subtree(RDETH_header_item, ett_rdeth);\r\nproto_tree_add_item(RDETH_header_tree, hf_opa_RDETH_reserved8, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(RDETH_header_tree, hf_opa_RDETH_ee_context, tvb, local_offset, 3, ENC_BIG_ENDIAN);\r\nlocal_offset += 3;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_DETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *DETH_header_item;\r\nproto_tree *DETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "DETH: ");\r\nDETH_header_item = proto_tree_add_item(tree, hf_opa_DETH, tvb, local_offset, 8, ENC_NA);\r\nDETH_header_tree = proto_item_add_subtree(DETH_header_item, ett_deth);\r\nproto_tree_add_item(DETH_header_tree, hf_opa_DETH_queue_key, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(DETH_header_tree, hf_opa_DETH_reserved8, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(DETH_header_tree, hf_opa_DETH_source_qp, tvb, local_offset, 3, ENC_BIG_ENDIAN);\r\npinfo->srcport = tvb_get_ntoh24(tvb, local_offset); local_offset += 3;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_RETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *RETH_header_item;\r\nproto_tree *RETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "RETH: ");\r\nRETH_header_item = proto_tree_add_item(tree, hf_opa_RETH, tvb, local_offset, 16, ENC_NA);\r\nRETH_header_tree = proto_item_add_subtree(RETH_header_item, ett_reth);\r\nproto_tree_add_item(RETH_header_tree, hf_opa_RETH_virtual_address, tvb, local_offset, 8, ENC_BIG_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(RETH_header_tree, hf_opa_RETH_remote_key, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(RETH_header_tree, hf_opa_RETH_dma_length, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_ATOMICETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *ATOMICETH_header_item;\r\nproto_tree *ATOMICETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "AtomicETH: ");\r\nATOMICETH_header_item = proto_tree_add_item(tree, hf_opa_AtomicETH, tvb, local_offset, 28, ENC_NA);\r\nATOMICETH_header_tree = proto_item_add_subtree(ATOMICETH_header_item, ett_atomiceth);\r\nproto_tree_add_item(ATOMICETH_header_tree, hf_opa_AtomicETH_virtual_address, tvb, local_offset, 8, ENC_BIG_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(ATOMICETH_header_tree, hf_opa_AtomicETH_remote_key, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(ATOMICETH_header_tree, hf_opa_AtomicETH_swap_or_add_data, tvb, local_offset, 8, ENC_BIG_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(ATOMICETH_header_tree, hf_opa_AtomicETH_compare_data, tvb, local_offset, 8, ENC_BIG_ENDIAN);\r\nlocal_offset += 8;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_AETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *AETH_header_item;\r\nproto_tree *AETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "AETH: ");\r\nAETH_header_item = proto_tree_add_item(tree, hf_opa_AETH, tvb, local_offset, 4, ENC_NA);\r\nAETH_header_tree = proto_item_add_subtree(AETH_header_item, ett_aeth);\r\nproto_tree_add_item(AETH_header_tree, hf_opa_AETH_syndrome, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nlocal_offset += 1;\r\nproto_tree_add_item(AETH_header_tree, hf_opa_AETH_message_sequence_number, tvb, local_offset, 3, ENC_BIG_ENDIAN);\r\nlocal_offset += 3;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_ATOMICACKETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *ATOMICACKETH_header_item;\r\nproto_tree *ATOMICACKETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "AtomicACKETH: ");\r\nATOMICACKETH_header_item = proto_tree_add_item(tree, hf_opa_AtomicAckETH, tvb, local_offset, 8, ENC_NA);\r\nATOMICACKETH_header_tree = proto_item_add_subtree(ATOMICACKETH_header_item, ett_atomicacketh);\r\nproto_tree_add_item(ATOMICACKETH_header_tree, hf_opa_AtomicAckETH_original_remote_data, tvb, local_offset, 8, ENC_BIG_ENDIAN);\r\nlocal_offset += 8;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_IMMDT(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *IMMDT_header_item;\r\nproto_tree *IMMDT_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "IMMDT: ");\r\nIMMDT_header_item = proto_tree_add_item(tree, hf_opa_IMMDT, tvb, local_offset, 4, ENC_NA);\r\nIMMDT_header_tree = proto_item_add_subtree(IMMDT_header_item, ett_immdt);\r\nproto_tree_add_item(IMMDT_header_tree, hf_opa_IMMDT_data, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_IETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *IETH_header_item;\r\nproto_tree *IETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "IETH: ");\r\nIETH_header_item = proto_tree_add_item(tree, hf_opa_IETH, tvb, local_offset, 4, ENC_NA);\r\nIETH_header_tree = proto_item_add_subtree(IETH_header_item, ett_ieth);\r\nproto_tree_add_item(IETH_header_tree, hf_opa_IETH_r_key, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nlocal_offset += 4;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_KDETH(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *KDETH_header_item;\r\nproto_tree *KDETH_header_tree;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "KDETH: ");\r\nKDETH_header_item = proto_tree_add_item(tree, hf_opa_KDETH, tvb, local_offset, 8, ENC_NA);\r\nKDETH_header_tree = proto_item_add_subtree(KDETH_header_item, ett_kdeth);\r\nproto_tree_add_bitmask_list(KDETH_header_tree, tvb, local_offset, 4, _opa_KDETH_word1, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_bitmask_list(KDETH_header_tree, tvb, local_offset, 4, _opa_KDETH_word2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\n*offset = local_offset;\r\n}\r\nstatic void parse_PSM(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset, gint opCode)\r\n{\r\ngint local_offset = *offset;\r\nproto_item *PSM_header_item;\r\nproto_tree *PSM_header_tree;\r\nguint32 payLength;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "PSM: ");\r\nPSM_header_item = proto_tree_add_item(tree, hf_opa_psm, tvb, local_offset, 28, ENC_NA);\r\nPSM_header_tree = proto_item_add_subtree(PSM_header_item, ett_psm);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_a, tvb, local_offset + 3, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_ackpsn, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_flags, tvb, local_offset + 3, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_commidx, tvb, local_offset, 3, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_flowid, tvb, local_offset + 3, 1, ENC_LITTLE_ENDIAN);\r\nswitch (opCode) {\r\ncase PSM_TINY:\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msglen, tvb, local_offset + 2, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgseq, tvb, local_offset, 2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_tag, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgdata, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_SHORT:\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgseq, tvb, local_offset, 2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_tag, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msglen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\npayLength = tvb_get_letohl(tvb, local_offset);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_payload, tvb, local_offset, payLength, ENC_NA);\r\nlocal_offset += payLength;\r\nbreak;\r\ncase PSM_MEDIUM:\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgseq, tvb, local_offset, 2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_tag, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msglen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_paylen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nbreak;\r\ncase PSM_MEDIUM_DATA:\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgseq, tvb, local_offset, 2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_offset, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_paylen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nbreak;\r\ncase PSM_LONG_RTS:\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgseq, tvb, local_offset, 2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_tag, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msglen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sreqidx, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nbreak;\r\ncase PSM_LONG_CTS:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sreqidx, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rreqidx, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msglen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_LONG_DATA:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rreqidx, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_offset, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_paylen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_TIDS_GRANT:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sreqidx, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_short_msglen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_paylen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_TIDS_GRANT_ACK:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_TIDS_RELEASE:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_TIDS_RELEASE_CONFIRM:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_EXPTID_UNALIGNED:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_EXPTID:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_ACK:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_NAK:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_psn, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_ERR_CHK:\r\ncase PSM_ERR_CHK_BAD:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_hostipv4, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_hostpid, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 12;\r\nbreak;\r\ncase PSM_ERR_CHK_GEN:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_rdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_sdescid, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\ncase PSM_FLOW_CCA_BECN:\r\nbreak;\r\ncase PSM_CONNECT_REQUEST:\r\ncase PSM_CONNECT_REPLY:\r\ncase PSM_DISCONNECT_REQUEST:\r\ncase PSM_DISCONNECT_REPLY:\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_paylen, tvb, local_offset, 4, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 16;\r\nbreak;\r\ncase PSM_AM_REQUEST_NOREPLY:\r\ncase PSM_AM_REQUEST:\r\ncase PSM_AM_REPLY:\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_dlen, tvb, local_offset + 3, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_nargs, tvb, local_offset + 3, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_hidx, tvb, local_offset + 2, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_msgseq, tvb, local_offset, 2, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 4;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_arg, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nproto_tree_add_item(PSM_header_tree, hf_opa_psm_arg, tvb, local_offset, 8, ENC_LITTLE_ENDIAN);\r\nlocal_offset += 8;\r\nbreak;\r\n}\r\n*offset = local_offset;\r\n}\r\nstatic void parse_IPvSix(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\ncall_dissector(ipv6_handle, tvb_new_subset_remaining(tvb, *offset), pinfo, tree);\r\n*offset = tvb_reported_length(tvb);\r\n}\r\nstatic int dissect_opa_9b(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *opa_packet;\r\ntvbuff_t *opa_tvb;\r\ntvbuff_t *infiniband_tvb;\r\ngint offset = 0;\r\ngint ib_offset = 0;\r\ngint captured_length, reported_length;\r\nguint8 lnh_val = 0;\r\ngboolean bthFollows = FALSE;\r\ngboolean parsePayload = FALSE;\r\ngint32 nextHeaderSequence = -1;\r\nguint8 nextHdr = 0, opCode = 0;\r\nguint8 baseVersion = 0;\r\nlnh_val = tvb_get_guint8(tvb, ib_offset + 1) & 0x3;\r\nif (lnh_val == 3) {\r\nnextHdr = tvb_get_guint8(tvb, ib_offset + 6);\r\nib_offset += 40;\r\n}\r\nif (lnh_val == 2 || nextHdr == 0x1B) {\r\nopCode = tvb_get_guint8(tvb, ib_offset + 8);\r\nif (opCode == 0x64) {\r\nbaseVersion = tvb_get_guint8(tvb, ib_offset + 28);\r\nif (baseVersion == 0x01) {\r\ninfiniband_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_dissector(infiniband_handle, infiniband_tvb, pinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\n}\r\n}\r\ntree = proto_tree_get_parent_tree(tree);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Omni-Path");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\npinfo->srcport = pinfo->destport = 0xffffffff;\r\nopa_packet = proto_tree_add_item(tree, proto_opa_9b, tvb, offset, -1, ENC_NA);\r\ntree = proto_item_add_subtree(opa_packet, ett_all_headers);\r\nparse_opa_9B_Header(tvb, pinfo, tree, &offset, &lnh_val);\r\nswitch (lnh_val) {\r\ncase 3:\r\nparse_opa_grh(tvb, pinfo, tree, &offset, &nextHdr);\r\nif (nextHdr != 0x1B) {\r\nbreak;\r\n}\r\ncase 2:\r\nparse_opa_bth(tvb, pinfo, tree, &offset, &opCode);\r\nbthFollows = TRUE;\r\nbreak;\r\ncase 1:\r\nset_address(&pinfo->dst, AT_STRINGZ, (int)strlen("IPv6 over OPA Packet") + 1,\r\nwmem_strdup(pinfo->pool, "IPv6 over OPA Packet"));\r\nparse_IPvSix(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase 0:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (bthFollows) {\r\nnextHeaderSequence = find_next_header_sequence((guint32)opCode);\r\nswitch (nextHeaderSequence) {\r\ncase RDETH_DETH_PAYLD:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RDETH_DETH_RETH_PAYLD:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparse_RETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RDETH_DETH_IMMDT_PAYLD:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparse_IMMDT(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RDETH_DETH_RETH_IMMDT_PAYLD:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparse_RETH(tvb, pinfo, tree, &offset);\r\nparse_IMMDT(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RDETH_DETH_RETH:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparse_RETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase RDETH_AETH_PAYLD:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_AETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RDETH_PAYLD:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RDETH_AETH:\r\nparse_AETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase RDETH_AETH_ATOMICACKETH:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_AETH(tvb, pinfo, tree, &offset);\r\nparse_ATOMICACKETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase RDETH_DETH_ATOMICETH:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparse_ATOMICETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase RDETH_DETH:\r\nparse_RDETH(tvb, pinfo, tree, &offset);\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase DETH_PAYLD:\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase PAYLD:\r\nparsePayload = TRUE;\r\nbreak;\r\ncase IMMDT_PAYLD:\r\nparse_IMMDT(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RETH_PAYLD:\r\nparse_RETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase RETH:\r\nparse_RETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase AETH_PAYLD:\r\nparse_AETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase AETH:\r\nparse_AETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase AETH_ATOMICACKETH:\r\nparse_AETH(tvb, pinfo, tree, &offset);\r\nparse_ATOMICACKETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase ATOMICETH:\r\nparse_ATOMICETH(tvb, pinfo, tree, &offset);\r\nbreak;\r\ncase IETH_PAYLD:\r\nparse_IETH(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase DETH_IMMDT_PAYLD:\r\nparse_DETH(tvb, pinfo, tree, &offset);\r\nparse_IMMDT(tvb, pinfo, tree, &offset);\r\nparsePayload = TRUE;\r\nbreak;\r\ncase KDETH_PSM:\r\nparse_KDETH(tvb, pinfo, tree, &offset);\r\nparse_PSM(tvb, pinfo, tree, &offset, opCode);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (parsePayload) {\r\ncaptured_length = tvb_captured_length_remaining(tvb, offset);\r\nreported_length = tvb_reported_length_remaining(tvb, offset);\r\nif (reported_length >= 4)\r\nreported_length -= 4;\r\nif (captured_length > reported_length)\r\ncaptured_length = reported_length;\r\nif (captured_length > 0) {\r\nopa_tvb = tvb_new_subset(tvb, offset, captured_length, reported_length);\r\ncall_dissector(opa_mad_handle, opa_tvb, pinfo, tree);\r\noffset += captured_length;\r\n}\r\n}\r\n}\r\nreported_length = tvb_reported_length_remaining(tvb, offset);\r\nif (reported_length != 4) {\r\noffset += reported_length - 4;\r\n}\r\nproto_tree_add_item(tree, hf_opa_9b_ICRC, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nvoid proto_register_opa_9b(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_opa_9B, {\r\n"Omni-Path 9B Header", "opa.9b",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_service_channel, {\r\n"Service Channel", "opa.9b.sc",\r\nFT_UINT8, BASE_DEC, NULL, 0xF0, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_link_version, {\r\n"Link Version", "opa.9b.linkversion",\r\nFT_UINT8, BASE_DEC, NULL, 0x0F, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_service_level, {\r\n"Service Level", "opa.9b.sl",\r\nFT_UINT8, BASE_DEC, NULL, 0xF0, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_reserved2, {\r\n"Reserved (2 bits)", "opa.9b.reserved2",\r\nFT_UINT8, BASE_HEX, NULL, 0x0C, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_lnh, {\r\n"Link Next Header", "opa.9b.lnh",\r\nFT_UINT8, BASE_DEC, VALS(vals_opa_9b_lnh), 0x03, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_dlid, {\r\n"Dest LID", "opa.9b.dlid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_reserved3, {\r\n"Reserved (4 bits)", "opa.9b.reserved3",\r\nFT_UINT16, BASE_HEX, NULL, 0xF000, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_packet_length, {\r\n"Packet Length", "opa.length",\r\nFT_UINT16, BASE_CUSTOM, CF_FUNC(cf_opa_dw_to_b), 0x0FFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_9B_slid, {\r\n"Source LID", "opa.9b.slid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_9b_ICRC, {\r\n"Invariant CRC", "opa.9b.icrc",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh, {\r\n"GRH - Global Route Header", "opa.grh",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_ip_version, {\r\n"IP Version", "opa.grh.ipver",\r\nFT_UINT8, BASE_DEC, VALS(vals_opa_9b_grh_ipver), 0xF0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_traffic_class, {\r\n"Traffic Class", "opa.grh.tclass",\r\nFT_UINT16, BASE_DEC, NULL, 0x0FF0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_flow_label, {\r\n"Flow Label", "opa.grh.flowlabel",\r\nFT_UINT32, BASE_DEC, NULL, 0x000FFFFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_payload_length, {\r\n"Payload Length", "opa.grh.paylen",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_next_header, {\r\n"Next Header", "opa.grh.nxthdr",\r\nFT_UINT8, BASE_DEC, VALS(vals_opa_9b_grh_next_hdr), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_hop_limit, {\r\n"Hop Limit", "opa.grh.hoplmt",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_source_gid, {\r\n"Source GID", "opa.grh.sgid",\r\nFT_IPv6, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_grh_destination_gid, {\r\n"Destination GID", "opa.grh.dgid",\r\nFT_IPv6, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth, {\r\n"BTH - Base Transport Header", "opa.bth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_opcode, {\r\n"Opcode", "opa.bth.opcode",\r\nFT_UINT8, BASE_HEX, VALS(vals_opa_bth_opcode), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_solicited_event, {\r\n"Solicited Event", "opa.bth.se",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x80, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_migreq, {\r\n"MigReq", "opa.bth.m",\r\nFT_BOOLEAN, 8, TFS(&tfs_opa_bth_migrated_notmigrated), 0x40, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_pad_count, {\r\n"Pad Count", "opa.bth.padcnt",\r\nFT_UINT8, BASE_DEC, NULL, 0x30, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_transport_header_version, {\r\n"Header Version", "opa.bth.tver",\r\nFT_UINT8, BASE_DEC, NULL, 0x0F, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_partition_key, {\r\n"Partition Key", "opa.bth.p_key",\r\nFT_UINT16, BASE_HEX_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_fcn, {\r\n"FCN", "opa.bth.fcn",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x80, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_bcn, {\r\n"BCN", "opa.bth.bcn",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x40, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_Reserved8a, {\r\n"Reserved (6 bits)", "opa.bth.reserved8a",\r\nFT_UINT8, BASE_HEX, NULL, 0x3F, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_destination_qp, {\r\n"Destination Queue Pair", "opa.bth.destqp",\r\nFT_UINT24, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_acknowledge_request, {\r\n"Acknowledge Request", "opa.bth.a",\r\nFT_BOOLEAN, 8, TFS(&tfs_set_notset), 0x80, NULL, HFILL }\r\n},\r\n{ &hf_opa_bth_packet_sequence_number, {\r\n"Packet Sequence Number", "opa.bth.psn",\r\nFT_UINT32, BASE_DEC, NULL, 0x7FFFFFFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_RDETH, {\r\n"RDETH - Reliable Datagram Extended Transport Header", "opa.rdeth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_RDETH_reserved8, {\r\n"Reserved (8 bits)", "opa.rdeth.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_RDETH_ee_context, {\r\n"EE Context", "opa.rdeth.eecnxt",\r\nFT_UINT24, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_DETH, {\r\n"DETH - Datagram Extended Transport Header", "opa.deth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_DETH_queue_key, {\r\n"Queue Key", "opa.deth.q_key",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_DETH_reserved8, {\r\n"Reserved (8 bits)", "opa.deth.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_DETH_source_qp, {\r\n"Source Queue Pair", "opa.deth.srcqp",\r\nFT_UINT24, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_RETH, {\r\n"RETH - RDMA Extended Transport Header", "opa.reth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_RETH_virtual_address, {\r\n"Virtual Address", "opa.reth.va",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_RETH_remote_key, {\r\n"Remote Key", "opa.reth.r_key",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_RETH_dma_length, {\r\n"DMA Length", "opa.reth.dmalen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicETH, {\r\n"AtomicETH - Atomic Extended Transport Header", "opa.atomiceth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicETH_virtual_address, {\r\n"Virtual Address", "opa.atomiceth.va",\r\nFT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicETH_remote_key, {\r\n"Remote Key", "opa.atomiceth.r_key",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicETH_swap_or_add_data, {\r\n"Swap (Or Add) Data", "opa.atomiceth.swapdt",\r\nFT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicETH_compare_data, {\r\n"Compare Data", "opa.atomiceth.cmpdt",\r\nFT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AETH, {\r\n"AETH - ACK Extended Transport Header", "opa.aeth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AETH_syndrome, {\r\n"Syndrome", "opa.aeth.syndrome",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AETH_message_sequence_number, {\r\n"Message Sequence Number", "opa.aeth.msn",\r\nFT_UINT24, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicAckETH, {\r\n"AtomicAckETH - Atomic ACK Extended Transport Header", "opa.atomicacketh",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_AtomicAckETH_original_remote_data, {\r\n"Original Remote Data", "opa.atomicacketh.origremdt",\r\nFT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_IMMDT, {\r\n"IMMDT - Immediate Extended Transport Header", "opa.immdt",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_IMMDT_data, {\r\n"Immediate Data", "opa.immdt.data",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_IETH, {\r\n"IETH - Invalidate Extended Transport Header", "opa.ieth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_IETH_r_key, {\r\n"RKey", "opa.ieth.r_key",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH, {\r\n"KDETH - Key Datagram Extended Transport Header", "opa.kdeth",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_kver, {\r\n"KDETH Version Field", "opa.kdeth.kver",\r\nFT_UINT32, BASE_HEX, NULL, 0xC0000000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_sh, {\r\n"SuppressHeader", "opa.kdeth.sh",\r\nFT_BOOLEAN, 32, NULL, 0x20000000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_intr, {\r\n"InterruptBit", "opa.kdeth.intr",\r\nFT_BOOLEAN, 32, NULL, 0x10000000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_tidctrl, {\r\n"TokenIDCtrl", "opa.kdeth.tidctrl",\r\nFT_UINT32, BASE_HEX, NULL, 0x0C000000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_tid, {\r\n"TokenID", "opa.kdeth.tid",\r\nFT_UINT32, BASE_HEX, NULL, 0x03FF0000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_offset_mode, {\r\n"Offset Mode", "opa.kdeth.offsetmode",\r\nFT_BOOLEAN, 32, TFS(&tfs_opa_kdeth_offset_32_64), 0x00008000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_offset, {\r\n"Offset", "opa.kdeth.offset",\r\nFT_UINT32, BASE_HEX, NULL, 0x00007FFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_hcrc, {\r\n"HCRC", "opa.kdeth.hcrc",\r\nFT_UINT32, BASE_HEX, NULL, 0xFFFF0000, NULL, HFILL }\r\n},\r\n{ &hf_opa_KDETH_j_key, {\r\n"J_Key", "opa.kdeth.j_key",\r\nFT_UINT32, BASE_HEX, NULL, 0x0000FFFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm, {\r\n"PSM Header", "opa.psm",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_a, {\r\n"ACKFlag", "opa.psm.a",\r\nFT_UINT8, BASE_HEX, NULL, 0x80, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_ackpsn, {\r\n"ACKPSN", "opa.psm.ackpsn",\r\nFT_UINT32, BASE_DEC, NULL, 0x7FFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_flags, {\r\n"Flags", "opa.psm.flags",\r\nFT_UINT8, BASE_DEC, NULL, 0xFC, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_commidx, {\r\n"CommIdx", "opa.psm.commidx",\r\nFT_UINT32, BASE_HEX, NULL, 0x3FFF, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_flowid, {\r\n"FlowId", "opa.psm.flowid",\r\nFT_UINT8, BASE_HEX, NULL, 0x80, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_msglen, {\r\n"MsgLen", "opa.psm.msglen",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_msgseq, {\r\n"MsqSeq", "opa.psm.msgseq",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_tag, {\r\n"Tag", "opa.psm.tag",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_msgdata, {\r\n"MsqData", "opa.psm.msgdata",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_short_msglen, {\r\n"MsgLen", "opa.psm.short.msglen",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_paylen, {\r\n"PayLen", "opa.psm.paylen",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_offset, {\r\n"Offset", "opa.psm.offset",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_sreqidx, {\r\n"SreqIdx", "opa.psm.sreqidx",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_rreqidx, {\r\n"RreqIdx", "opa.psm.rreqidx",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_rdescid, {\r\n"RdescId", "opa.psm.rdescid",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_sdescid, {\r\n"SdescId", "opa.psm.sdescid",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_psn, {\r\n"PSN", "opa.psm.psn",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_hostipv4, {\r\n"HostIPv4Addr", "opa.psm.hostipv4",\r\nFT_IPv4, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_hostpid, {\r\n"HostPid", "opa.psm.hostpid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_dlen, {\r\n"Datalength", "opa.psm.dlen",\r\nFT_UINT8, BASE_DEC, NULL, 0x38, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_nargs, {\r\n"NumberArgs", "opa.psm.nargs",\r\nFT_UINT32, BASE_DEC, NULL, 0x07, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_hidx, {\r\n"HandlerIndex", "opa.psm.hidx",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_arg, {\r\n"Argument", "opa.psm.arg",\r\nFT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_opa_psm_payload, {\r\n"Payload", "opa.psm.payload",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_all_headers,\r\n&ett_9b,\r\n&ett_grh,\r\n&ett_bth,\r\n&ett_rdeth,\r\n&ett_deth,\r\n&ett_reth,\r\n&ett_atomiceth,\r\n&ett_aeth,\r\n&ett_atomicacketh,\r\n&ett_immdt,\r\n&ett_ieth,\r\n&ett_kdeth,\r\n&ett_psm\r\n};\r\nproto_opa_9b = proto_register_protocol("Intel Omni-Path", "OPA", "opa");\r\nopa_9b_handle = register_dissector("opa", dissect_opa_9b, proto_opa_9b);\r\nproto_register_field_array(proto_opa_9b, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_opa_9b(void)\r\n{\r\nipv6_handle = find_dissector("ipv6");\r\nopa_mad_handle = find_dissector("opa.mad");\r\ninfiniband_handle = find_dissector("infiniband");\r\ndissector_add_uint("erf.types.type", ERF_TYPE_OPA_9B, opa_9b_handle);\r\n}

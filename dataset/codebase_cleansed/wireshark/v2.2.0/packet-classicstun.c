static int\r\ndissect_classicstun(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_item *ta;\r\nproto_tree *classicstun_tree;\r\nproto_tree *att_type_tree;\r\nproto_tree *att_tree;\r\nguint16 msg_type;\r\nguint16 msg_length;\r\nconst char *msg_type_str;\r\nguint16 att_type;\r\nguint16 att_length;\r\nguint16 offset;\r\nguint len;\r\nguint i;\r\nconversation_t *conversation;\r\nclassicstun_conv_info_t *classicstun_info;\r\nclassicstun_transaction_t *classicstun_trans;\r\nwmem_tree_key_t transaction_id_key[2];\r\nguint32 transaction_id[4];\r\nlen = tvb_captured_length(tvb);\r\nif (len < CLASSICSTUN_HDR_LEN)\r\nreturn 0;\r\nmsg_type = tvb_get_ntohs(tvb, 0);\r\nif (msg_type & 0xC000 || tvb_get_ntohl(tvb, 4) == 0x2112a442\r\n|| tvb_get_ntohl(tvb, 4) == 0x7f5a9bc7)\r\nreturn 0;\r\nmsg_type_str = try_val_to_str(msg_type, messages);\r\nif (msg_type_str == NULL)\r\nreturn 0;\r\nmsg_length = tvb_get_ntohs(tvb, 2);\r\nif (len != CLASSICSTUN_HDR_LEN+msg_length)\r\nreturn 0;\r\ntransaction_id[0] = tvb_get_ntohl(tvb, 4);\r\ntransaction_id[1] = tvb_get_ntohl(tvb, 8);\r\ntransaction_id[2] = tvb_get_ntohl(tvb, 12);\r\ntransaction_id[3] = tvb_get_ntohl(tvb, 16);\r\ntransaction_id_key[0].length = 4;\r\ntransaction_id_key[0].key = transaction_id;\r\ntransaction_id_key[1].length = 0;\r\ntransaction_id_key[1].key = NULL;\r\nconversation = find_or_create_conversation(pinfo);\r\nclassicstun_info = (classicstun_conv_info_t *)conversation_get_proto_data(conversation, proto_classicstun);\r\nif (!classicstun_info) {\r\nclassicstun_info = wmem_new(wmem_file_scope(), classicstun_conv_info_t);\r\nclassicstun_info->pdus=wmem_tree_new(wmem_file_scope());\r\nconversation_add_proto_data(conversation, proto_classicstun, classicstun_info);\r\n}\r\nif(!pinfo->fd->flags.visited){\r\nif (((msg_type & CLASS_MASK) >> 4) == REQUEST) {\r\nclassicstun_trans=wmem_new(wmem_file_scope(), classicstun_transaction_t);\r\nclassicstun_trans->req_frame=pinfo->num;\r\nclassicstun_trans->rep_frame=0;\r\nclassicstun_trans->req_time=pinfo->abs_ts;\r\nwmem_tree_insert32_array(classicstun_info->pdus, transaction_id_key,\r\n(void *)classicstun_trans);\r\n} else {\r\nclassicstun_trans=(classicstun_transaction_t *)wmem_tree_lookup32_array(classicstun_info->pdus,\r\ntransaction_id_key);\r\nif(classicstun_trans){\r\nclassicstun_trans->rep_frame=pinfo->num;\r\n}\r\n}\r\n} else {\r\nclassicstun_trans=(classicstun_transaction_t *)wmem_tree_lookup32_array(classicstun_info->pdus, transaction_id_key);\r\n}\r\nif(!classicstun_trans){\r\nclassicstun_trans=wmem_new(wmem_packet_scope(), classicstun_transaction_t);\r\nclassicstun_trans->req_frame=0;\r\nclassicstun_trans->rep_frame=0;\r\nclassicstun_trans->req_time=pinfo->abs_ts;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "CLASSIC-STUN");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Message: %s",\r\nmsg_type_str);\r\nif (tree) {\r\nguint transaction_id_first_word;\r\nti = proto_tree_add_item(tree, proto_classicstun, tvb, 0, -1, ENC_NA);\r\nclassicstun_tree = proto_item_add_subtree(ti, ett_classicstun);\r\nif (((msg_type & CLASS_MASK) >> 4) == REQUEST) {\r\nif (classicstun_trans->rep_frame) {\r\nproto_item *it;\r\nit=proto_tree_add_uint(classicstun_tree, hf_classicstun_response_in,\r\ntvb, 0, 0,\r\nclassicstun_trans->rep_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\n}\r\nelse if ((((msg_type & CLASS_MASK) >> 4) == RESPONSE) ||\r\n(((msg_type & CLASS_MASK) >> 4) == ERROR_RESPONSE)) {\r\nif(classicstun_trans->req_frame){\r\nproto_item *it;\r\nnstime_t ns;\r\nit=proto_tree_add_uint(classicstun_tree, hf_classicstun_response_to, tvb, 0, 0, classicstun_trans->req_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\nnstime_delta(&ns, &pinfo->abs_ts, &classicstun_trans->req_time);\r\nit=proto_tree_add_time(classicstun_tree, hf_classicstun_time, tvb, 0, 0, &ns);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\n}\r\nproto_tree_add_uint(classicstun_tree, hf_classicstun_type, tvb, 0, 2, msg_type);\r\nproto_tree_add_uint(classicstun_tree, hf_classicstun_length, tvb, 2, 2, msg_length);\r\nproto_tree_add_item(classicstun_tree, hf_classicstun_id, tvb, 4, 16, ENC_NA);\r\ntransaction_id_first_word = tvb_get_ntohl(tvb, 4);\r\nif (msg_length > 0) {\r\nta = proto_tree_add_item(classicstun_tree, hf_classicstun_att, tvb, CLASSICSTUN_HDR_LEN, msg_length, ENC_NA);\r\natt_type_tree = proto_item_add_subtree(ta, ett_classicstun_att_type);\r\noffset = CLASSICSTUN_HDR_LEN;\r\nwhile( msg_length > 0) {\r\natt_type = tvb_get_ntohs(tvb, offset);\r\natt_length = tvb_get_ntohs(tvb, offset+2);\r\natt_tree = proto_tree_add_subtree_format(att_type_tree, tvb, offset,\r\nATTR_HDR_LEN+att_length, ett_classicstun_att, NULL,\r\n"Attribute: %s",\r\nval_to_str(att_type, attributes, "Unknown (0x%04x)"));\r\nproto_tree_add_uint(att_tree, classicstun_att_type, tvb,\r\noffset, 2, att_type);\r\noffset += 2;\r\nif (ATTR_HDR_LEN+att_length > msg_length) {\r\nproto_tree_add_uint_format_value(att_tree,\r\nclassicstun_att_length, tvb, offset, 2,\r\natt_length,\r\n"%u (bogus, goes past the end of the message)",\r\natt_length);\r\nbreak;\r\n}\r\nproto_tree_add_uint(att_tree, classicstun_att_length, tvb,\r\noffset, 2, att_length);\r\noffset += 2;\r\nswitch( att_type ){\r\ncase MAPPED_ADDRESS:\r\ncase RESPONSE_ADDRESS:\r\ncase SOURCE_ADDRESS:\r\ncase CHANGED_ADDRESS:\r\ncase REFLECTED_FROM:\r\ncase ALTERNATE_SERVER:\r\ncase DESTINATION_ADDRESS:\r\ncase REMOTE_ADDRESS:\r\nif (att_length < 2)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_family, tvb, offset+1, 1, ENC_BIG_ENDIAN);\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_port, tvb, offset+2, 2, ENC_BIG_ENDIAN);\r\nswitch( tvb_get_guint8(tvb, offset+1) ){\r\ncase 1:\r\nif (att_length < 8)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_ipv4, tvb, offset+4, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 2:\r\nif (att_length < 20)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_ipv6, tvb, offset+4, 16, ENC_NA);\r\nbreak;\r\n}\r\nbreak;\r\ncase CHANGE_REQUEST:\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_change_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(att_tree, classicstun_att_change_port, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase USERNAME:\r\ncase PASSWORD:\r\ncase MESSAGE_INTEGRITY:\r\ncase NONCE:\r\ncase REALM:\r\nif (att_length < 1)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_value, tvb, offset, att_length, ENC_NA);\r\nbreak;\r\ncase ERROR_CODE:\r\nif (att_length < 3)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_error_class, tvb, offset+2, 1, ENC_BIG_ENDIAN);\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_error_number, tvb, offset+3, 1, ENC_BIG_ENDIAN);\r\nif (att_length < 5)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_error_reason, tvb, offset+4, (att_length-4), ENC_UTF_8|ENC_NA);\r\nbreak;\r\ncase LIFETIME:\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_lifetime, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MAGIC_COOKIE:\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_magic_cookie, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase BANDWIDTH:\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_bandwidth, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DATA:\r\nproto_tree_add_item(att_tree, classicstun_att_data, tvb, offset, att_length, ENC_NA);\r\nbreak;\r\ncase UNKNOWN_ATTRIBUTES:\r\nfor (i = 0; i < att_length; i += 4) {\r\nproto_tree_add_item(att_tree, classicstun_att_unknown, tvb, offset+i, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(att_tree, classicstun_att_unknown, tvb, offset+i+2, 2, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\ncase SERVER:\r\nproto_tree_add_item(att_tree, classicstun_att_server_string, tvb, offset, att_length, ENC_UTF_8|ENC_NA);\r\nbreak;\r\ncase XOR_MAPPED_ADDRESS:\r\nif (att_length < 2)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_family, tvb, offset+1, 1, ENC_BIG_ENDIAN);\r\nif (att_length < 4)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_xor_port, tvb, offset+2, 2, ENC_BIG_ENDIAN);\r\nti = proto_tree_add_uint(att_tree, classicstun_att_port, tvb, offset+2, 2,\r\ntvb_get_ntohs(tvb, offset+2) ^\r\n(transaction_id_first_word >> 16));\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nswitch( tvb_get_guint8(tvb, offset+1) ){\r\ncase 1:\r\nif (att_length < 8)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_xor_ipv4, tvb, offset+4, 4, ENC_BIG_ENDIAN);\r\nti = proto_tree_add_ipv4(att_tree, classicstun_att_ipv4, tvb, offset+4, 4,\r\ntvb_get_ipv4(tvb, offset+4) ^ g_htonl(transaction_id_first_word));\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nbreak;\r\ncase 2:\r\nif (att_length < 20)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_xor_ipv6, tvb, offset+4, 16, ENC_NA);\r\nbreak;\r\n}\r\nbreak;\r\ncase REQUESTED_ADDRESS_TYPE:\r\nif (att_length < 2)\r\nbreak;\r\nproto_tree_add_item(att_tree, classicstun_att_family, tvb, offset+1, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CONNECTION_REQUEST_BINDING:\r\nproto_tree_add_item(att_tree, classicstun_att_connection_request_binding, tvb, offset, att_length, ENC_UTF_8|ENC_NA);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\noffset += att_length;\r\nmsg_length -= ATTR_HDR_LEN+att_length;\r\n}\r\n}\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_classicstun_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif (dissect_classicstun(tvb, pinfo, tree, NULL) == 0)\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_classicstun(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_classicstun_type,\r\n{ "Message Type", "classicstun.type", FT_UINT16,\r\nBASE_HEX, VALS(messages), 0x0, NULL, HFILL }\r\n},\r\n{ &hf_classicstun_length,\r\n{ "Message Length", "classicstun.length", FT_UINT16,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_classicstun_id,\r\n{ "Message Transaction ID", "classicstun.id", FT_BYTES,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_classicstun_att,\r\n{ "Attributes", "classicstun.att", FT_NONE,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &hf_classicstun_response_in,\r\n{ "Response In", "classicstun.response_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"The response to this CLASSICSTUN query is in this frame", HFILL }},\r\n{ &hf_classicstun_response_to,\r\n{ "Request In", "classicstun.response_to",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"This is a response to the CLASSICSTUN Request in this frame", HFILL }},\r\n{ &hf_classicstun_time,\r\n{ "Time", "classicstun.time",\r\nFT_RELATIVE_TIME, BASE_NONE, NULL, 0x0,\r\n"The time between the Request and the Response", HFILL }},\r\n{ &classicstun_att_type,\r\n{ "Attribute Type", "classicstun.att.type", FT_UINT16,\r\nBASE_HEX, VALS(attributes), 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_length,\r\n{ "Attribute Length", "classicstun.att.length", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_value,\r\n{ "Value", "classicstun.att.value", FT_BYTES,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_family,\r\n{ "Protocol Family", "classicstun.att.family", FT_UINT16,\r\nBASE_HEX, VALS(attributes_family), 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_ipv4,\r\n{ "IP", "classicstun.att.ipv4", FT_IPv4,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_ipv6,\r\n{ "IP", "classicstun.att.ipv6", FT_IPv6,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_port,\r\n{ "Port", "classicstun.att.port", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_change_ip,\r\n{ "Change IP","classicstun.att.change.ip", FT_BOOLEAN,\r\n16, TFS(&tfs_set_notset), 0x0004, NULL, HFILL}\r\n},\r\n{ &classicstun_att_change_port,\r\n{ "Change Port","classicstun.att.change.port", FT_BOOLEAN,\r\n16, TFS(&tfs_set_notset), 0x0002, NULL, HFILL}\r\n},\r\n{ &classicstun_att_unknown,\r\n{ "Unknown Attribute","classicstun.att.unknown", FT_UINT16,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &classicstun_att_error_class,\r\n{ "Error Class","classicstun.att.error.class", FT_UINT8,\r\nBASE_DEC, NULL, 0x07, NULL, HFILL}\r\n},\r\n{ &classicstun_att_error_number,\r\n{ "Error Code","classicstun.att.error", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &classicstun_att_error_reason,\r\n{ "Error Reason Phase","classicstun.att.error.reason", FT_STRING,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &classicstun_att_xor_ipv4,\r\n{ "IP (XOR-d)", "classicstun.att.ipv4-xord", FT_IPv4,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_xor_ipv6,\r\n{ "IP (XOR-d)", "classicstun.att.ipv6-xord", FT_IPv6,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_xor_port,\r\n{ "Port (XOR-d)", "classicstun.att.port-xord", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_server_string,\r\n{ "Server version","classicstun.att.server", FT_STRING,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &classicstun_att_lifetime,\r\n{ "Lifetime", "classicstun.att.lifetime", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_magic_cookie,\r\n{ "Magic Cookie", "classicstun.att.magic.cookie", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_bandwidth,\r\n{ "Bandwidth", "classicstun.att.bandwidth", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_data,\r\n{ "Data", "classicstun.att.data", FT_BYTES,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n{ &classicstun_att_connection_request_binding,\r\n{ "Connection Request Binding", "classicstun.att.connection_request_binding", FT_STRING,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_classicstun,\r\n&ett_classicstun_att_type,\r\n&ett_classicstun_att,\r\n};\r\nproto_classicstun = proto_register_protocol("Simple Traversal of UDP Through NAT",\r\n"CLASSICSTUN", "classicstun");\r\nproto_register_field_array(proto_classicstun, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("classicstun", dissect_classicstun, proto_classicstun);\r\nregister_dissector("classicstun-heur", dissect_classicstun_heur, proto_classicstun);\r\n}\r\nvoid\r\nproto_reg_handoff_classicstun(void)\r\n{\r\n#if 0\r\ndissector_handle_t classicstun_handle;\r\nclassicstun_handle = find_dissector("classicstun");\r\ndissector_add_uint("tcp.port", TCP_PORT_STUN, classicstun_handle);\r\ndissector_add_uint("udp.port", UDP_PORT_STUN, classicstun_handle);\r\n#endif\r\nheur_dissector_add("udp", dissect_classicstun_heur, "Classic STUN over UDP", "classicstun_udp", proto_classicstun, HEURISTIC_ENABLE);\r\nheur_dissector_add("tcp", dissect_classicstun_heur, "Classic STUN over TCP", "classicstun_tcp", proto_classicstun, HEURISTIC_ENABLE);\r\n}

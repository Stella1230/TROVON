static int dissect_kdp(tvbuff_t *tvb,\r\npacket_info *pinfo,\r\nproto_tree *tree, void* data _U_) {\r\nproto_item *ti;\r\nproto_tree *kdp_tree;\r\nguint body_len;\r\nguint8 version;\r\nguint8 header_len = 0;\r\nguint8 packet_flags = 0;\r\nguint8 packet_errors = 0;\r\nguint32 sequence_number = G_MAXUINT32;\r\nguint32 ack_number = G_MAXUINT32;\r\nguint32 src_flowid = G_MAXUINT32;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "KDP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_kdp, tvb, 0, -1, ENC_NA);\r\nkdp_tree = proto_item_add_subtree(ti, ett_kdp);\r\nversion = tvb_get_guint8(tvb, 0);\r\nif (version != 2) {\r\nproto_tree_add_item(kdp_tree, hf_kdp_version, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(kdp_tree, hf_kdp_xml_body, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\n} else {\r\nproto_tree *flags_tree;\r\nheader_len = tvb_get_guint8(tvb, 1) * 4;\r\nbody_len = tvb_reported_length(tvb);\r\nif (header_len > body_len) {\r\nbody_len = 0;\r\n} else {\r\nbody_len = body_len - header_len;\r\n}\r\npacket_flags = tvb_get_guint8(tvb, 2);\r\npacket_errors = tvb_get_guint8(tvb, 3);\r\nproto_tree_add_item(kdp_tree, hf_kdp_version, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(kdp_tree, hf_kdp_headerlen, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nti = proto_tree_add_item(kdp_tree, hf_kdp_flags, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nflags_tree = proto_item_add_subtree(ti, ett_kdp_flags);\r\nproto_tree_add_item(flags_tree, hf_kdp_drop_flag, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_kdp_syn_flag, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_kdp_ack_flag, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_kdp_rst_flag, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_kdp_bcst_flag, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_kdp_dup_flag, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(kdp_tree, hf_kdp_errors, tvb, 3, 1, ENC_BIG_ENDIAN);\r\nif (header_len > 4) {\r\nint offset;\r\noffset = 4;\r\nif (packet_flags & KDP_ACK_FLAG) {\r\nproto_tree_add_item(kdp_tree, hf_kdp_destflowid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset = offset + 4;\r\n}\r\nif (packet_flags & (KDP_SYN_FLAG | KDP_BCST_FLAG)) {\r\nproto_tree_add_item(kdp_tree, hf_kdp_srcflowid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nsrc_flowid = tvb_get_ntohl(tvb, offset);\r\noffset = offset + 4;\r\n}\r\nproto_tree_add_item(kdp_tree, hf_kdp_sequence, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nsequence_number = tvb_get_ntohl(tvb, offset);\r\noffset = offset + 4;\r\nif (packet_flags & KDP_ACK_FLAG) {\r\nproto_tree_add_item(kdp_tree, hf_kdp_ack, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nack_number = tvb_get_ntohl(tvb, offset);\r\noffset = offset + 4;\r\n}\r\nif (packet_flags & KDP_SYN_FLAG) {\r\nproto_tree_add_item(kdp_tree, hf_kdp_maxsegmentsize, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset = offset + 4;\r\n}\r\nwhile (offset < ((body_len > 0) ? header_len - 4 : header_len)) {\r\nguint8 option_number;\r\nguint8 option_len = 0;\r\noption_number = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(kdp_tree, hf_kdp_optionnumber, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset = offset + 1;\r\nif (option_number > 0) {\r\noption_len = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(kdp_tree, hf_kdp_optionlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset = offset + 1;\r\n}\r\nswitch (option_number) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option1, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option2, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option3, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option4, tvb, offset, 0, ENC_NA);\r\nbreak;\r\ncase 5:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option5, tvb, offset, 0, ENC_NA);\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option6, tvb, offset, option_len - 2, ENC_NA);\r\noffset = offset + option_len - 2;\r\nbreak;\r\ncase 7:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option7, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nbreak;\r\ncase 8:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option8, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nbreak;\r\ncase 9:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option9, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(kdp_tree, hf_kdp_option_unknown, tvb, offset, option_len - 2, ENC_NA);\r\noffset = offset + option_len - 2;\r\nbreak;\r\n}\r\n}\r\nif (body_len > 0) {\r\nproto_tree_add_item(kdp_tree, hf_kdp_fragment, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(kdp_tree, hf_kdp_fragtotal, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(kdp_tree, hf_kdp_body, tvb, offset, -1, ENC_NA);\r\n}\r\n}\r\n}\r\nif (version != 2) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "SDDP message");\r\n} else {\r\nchar ack_string[BUFFER_SIZE];\r\nchar seq_num_string[BUFFER_SIZE];\r\nchar src_flowid_string[BUFFER_SIZE];\r\nif (packet_flags & KDP_ACK_FLAG) {\r\ng_snprintf(ack_string, sizeof(ack_string), "ACK=%x ", ack_number);\r\n} else {\r\nack_string[0] = '\0';\r\n}\r\nif (header_len > 4) {\r\ng_snprintf(seq_num_string, sizeof(seq_num_string), "SEQ=%x ", sequence_number);\r\n} else {\r\nseq_num_string[0] = '\0';\r\n}\r\nif (packet_flags & (KDP_SYN_FLAG | KDP_BCST_FLAG)) {\r\ng_snprintf(src_flowid_string, sizeof(src_flowid_string), "SRC_FLOWID=%x ", src_flowid);\r\n} else {\r\nsrc_flowid_string[0] = '\0';\r\n}\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s%s%s%s%s%s%s%serrors=%d",\r\n((packet_flags & KDP_DROP_FLAG) ? "DROP " : ""),\r\n((packet_flags & KDP_SYN_FLAG) ? "SYN " : ""),\r\n((packet_flags & KDP_RST_FLAG) ? "RST " : ""),\r\n((packet_flags & KDP_BCST_FLAG) ? "BCST " : ""),\r\n((packet_flags & KDP_DUP_FLAG) ? "DUP " : ""),\r\nack_string,\r\nseq_num_string,\r\nsrc_flowid_string,\r\npacket_errors);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_kdp(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_kdp_version,\r\n{"KDP version", "kdp.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_headerlen,\r\n{"KDP header len", "kdp.headerlen",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_flags,\r\n{"KDP flags", "kdp.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_drop_flag,\r\n{"KDP DROP Flag", "kdp.flags.drop",\r\nFT_BOOLEAN, 8, NULL, KDP_DROP_FLAG, NULL, HFILL}\r\n},\r\n{ &hf_kdp_syn_flag,\r\n{"KDP SYN Flag", "kdp.flags.syn",\r\nFT_BOOLEAN, 8, NULL, KDP_SYN_FLAG, NULL, HFILL}\r\n},\r\n{ &hf_kdp_ack_flag,\r\n{"KDP ACK Flag", "kdp.flags.ack",\r\nFT_BOOLEAN, 8, NULL, KDP_ACK_FLAG, NULL, HFILL}\r\n},\r\n{ &hf_kdp_rst_flag,\r\n{"KDP RST Flag", "kdp.flags.rst",\r\nFT_BOOLEAN, 8, NULL, KDP_RST_FLAG, NULL, HFILL}\r\n},\r\n{ &hf_kdp_bcst_flag,\r\n{"KDP BCST Flag", "kdp.flags.bcst",\r\nFT_BOOLEAN, 8, NULL, KDP_BCST_FLAG, NULL, HFILL}\r\n},\r\n{ &hf_kdp_dup_flag,\r\n{"KDP DUP Flag", "kdp.flags.dup",\r\nFT_BOOLEAN, 8, NULL, KDP_DUP_FLAG, NULL, HFILL}\r\n},\r\n{ &hf_kdp_errors,\r\n{"KDP errors", "kdp.errors",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_destflowid,\r\n{ "DestFlowID", "kdp.destflowid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_srcflowid,\r\n{ "SrcFlowID", "kdp.srcflowid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_sequence,\r\n{ "Sequence", "kdp.sequence",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_ack,\r\n{ "Ack", "kdp.ack",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_maxsegmentsize,\r\n{ "MaxSegmentSize", "kdp.maxsegmentsize",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_optionnumber,\r\n{ "Option Number", "kdp.optionnumber",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_optionlen,\r\n{ "Option Len", "kdp.option",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option1,\r\n{ "Option1 - Max Window", "kdp.option1",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option2,\r\n{ "Option2 - TCP Fraction", "kdp.option2",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option3,\r\n{ "Option3 - KDP Version", "kdp.option3",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option4,\r\n{ "Option4 - Enable Reliable", "kdp.option4",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option5,\r\n{ "Option5 - Disable Reliable", "kdp.option5",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option6,\r\n{ "Option6 - SACK", "kdp.option6",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option7,\r\n{ "Option7 - COS", "kdp.option7",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option8,\r\n{ "Option8 - BWMIN", "kdp.option8",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option9,\r\n{ "Option9 - INT", "kdp.option9",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_option_unknown,\r\n{ "Unknown option", "kdp.option_unknown",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_fragment,\r\n{ "Fragment", "kdp.fragment",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_fragtotal,\r\n{ "FragTotal", "kdp.fragtotal",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_body,\r\n{ "Encrypted Body", "kdp.body",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_kdp_xml_body,\r\n{ "XML Body", "kdp.xml_body",\r\nFT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_kdp, &ett_kdp_flags\r\n};\r\nproto_kdp = proto_register_protocol("Kontiki Delivery Protocol",\r\n"KDP",\r\n"kdp");\r\nproto_register_field_array(proto_kdp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_kdp(void) {\r\ndissector_handle_t kdp_handle;\r\nkdp_handle = create_dissector_handle(dissect_kdp, proto_kdp);\r\ndissector_add_uint("udp.port", KDP_PORT, kdp_handle);\r\n}

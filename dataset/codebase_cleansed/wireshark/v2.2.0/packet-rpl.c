static void\r\ndissect_rpl_container(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint16 len, type, sublen, subtyp;\r\nproto_tree *rpl_container_tree;\r\nguint16 offset;\r\ngint ett_type;\r\ngint length, reported_length;\r\nlen = tvb_get_ntohs(tvb, 0);\r\nproto_tree_add_item(tree, hf_rpl_len, tvb, 0, 2, ENC_BIG_ENDIAN);\r\ntype = tvb_get_ntohs(tvb, 2);\r\nproto_tree_add_item(tree, hf_rpl_type, tvb, 2, 2, ENC_BIG_ENDIAN);\r\noffset = 4;\r\nswitch (type) {\r\ncase 1:\r\ncase 2:\r\ncase 4:\r\ncase 8:\r\ncase 0x10:\r\ncase 0x20:\r\nwhile (len >= offset+4) {\r\nsublen = tvb_get_ntohs(tvb, offset);\r\nsubtyp = tvb_get_ntohs(tvb, offset+2);\r\nett_type = ett_rpl_unkn;\r\nif(subtyp == 0x0004) ett_type = ett_rpl_0004;\r\nif(subtyp == 0x0008) ett_type = ett_rpl_0008;\r\nif(subtyp == 0x4003) ett_type = ett_rpl_4003;\r\nif(subtyp == 0x4006) ett_type = ett_rpl_4006;\r\nif(subtyp == 0x4007) ett_type = ett_rpl_4007;\r\nif(subtyp == 0x4009) ett_type = ett_rpl_4009;\r\nif(subtyp == 0x400a) ett_type = ett_rpl_400a;\r\nif(subtyp == 0x400b) ett_type = ett_rpl_400b;\r\nif(subtyp == 0x400c) ett_type = ett_rpl_400c;\r\nif(subtyp == 0x4011) ett_type = ett_rpl_4011;\r\nif(subtyp == 0x4018) ett_type = ett_rpl_4018;\r\nif(subtyp == 0xc005) ett_type = ett_rpl_c005;\r\nif(subtyp == 0xc014) ett_type = ett_rpl_c014;\r\nrpl_container_tree = proto_tree_add_subtree(tree, tvb,\r\noffset, sublen, ett_type, NULL,\r\nval_to_str_const(subtyp,\r\nrpl_type_vals,\r\n"Unknown Type"));\r\nlength = tvb_captured_length_remaining(tvb, offset);\r\nif (length > sublen)\r\nlength = sublen;\r\nreported_length = tvb_reported_length_remaining(tvb, offset);\r\nif (reported_length > sublen)\r\nreported_length = sublen;\r\nif ( length > 0) {\r\ndissect_rpl_container(tvb_new_subset(tvb,\r\noffset, length, reported_length),\r\npinfo, rpl_container_tree);\r\noffset += reported_length;\r\n} else {\r\noffset += reported_length;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase 0x4003:\r\nproto_tree_add_item(tree, hf_rpl_corrval,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase 0x4006:\r\nproto_tree_add_item(tree, hf_rpl_lmac,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nbreak;\r\ncase 0x4007:\r\nproto_tree_add_item(tree, hf_rpl_sap,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset ++;\r\nbreak;\r\ncase 0x4009:\r\nproto_tree_add_item(tree, hf_rpl_maxframe,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x400a:\r\nproto_tree_add_item(tree, hf_rpl_connclass,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x400b:\r\nproto_tree_add_item(tree, hf_rpl_respval,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset ++;\r\nbreak;\r\ncase 0x400c:\r\nproto_tree_add_item(tree, hf_rpl_smac,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nbreak;\r\ncase 0x4011:\r\nproto_tree_add_item(tree, hf_rpl_sequence,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase 0x4018:\r\nproto_tree_add_item(tree, hf_rpl_data,\r\ntvb, offset, len-4, ENC_NA);\r\noffset += len - 4;\r\nbreak;\r\ncase 0xc005:\r\nproto_tree_add_item(tree, hf_rpl_config,\r\ntvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nproto_tree_add_item(tree, hf_rpl_equipment,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_rpl_memsize,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_rpl_bsmversion,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_rpl_ec,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(tree, hf_rpl_adapterid,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_rpl_shortname,\r\ntvb, offset, 10, ENC_NA);\r\noffset += 10;\r\nbreak;\r\ncase 0xc014:\r\nproto_tree_add_item(tree, hf_rpl_laddress,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_rpl_xaddress,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_rpl_flags,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset ++;\r\nbreak;\r\ndefault:\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, 4), pinfo,\r\ntree);\r\nbreak;\r\n}\r\nif (tvb_reported_length(tvb) > offset)\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset), pinfo, tree);\r\n}\r\nstatic int\r\ndissect_rpl(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint16 rpl_len, rpl_type;\r\nproto_item *ti;\r\nproto_tree *rpl_tree;\r\ntvbuff_t *next_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "RPL");\r\nrpl_len = tvb_get_ntohs(tvb, 0);\r\nrpl_type = tvb_get_ntohs(tvb, 2);\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_const(rpl_type, rpl_type_vals, "Unknown Type"));\r\nti = proto_tree_add_item(tree, proto_rpl, tvb, 0,\r\nrpl_len, ENC_NA);\r\nrpl_tree = proto_item_add_subtree(ti, ett_rpl);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 0);\r\nset_actual_length(next_tvb, rpl_len);\r\ndissect_rpl_container(next_tvb, pinfo, rpl_tree);\r\nif (tvb_reported_length(tvb) > rpl_len)\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, rpl_len), pinfo,\r\ntree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_rpl(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_rpl_type,\r\n{ "Type", "rpl.type",\r\nFT_UINT16, BASE_DEC, VALS(rpl_type_vals), 0x0,\r\n"RPL Packet Type", HFILL }},\r\n{ &hf_rpl_len,\r\n{ "Length", "rpl.len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"RPL Packet Length", HFILL }},\r\n{ &hf_rpl_corrval,\r\n{ "Correlator Value", "rpl.corrval",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"RPL Correlator Value", HFILL }},\r\n{ &hf_rpl_respval,\r\n{ "Response Code", "rpl.respval",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"RPL Response Code", HFILL }},\r\n{ &hf_rpl_maxframe,\r\n{ "Maximum Frame Size", "rpl.maxframe",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"RPL Maximum Frame Size", HFILL }},\r\n{ &hf_rpl_connclass,\r\n{ "Connection Class", "rpl.connclass",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\n"RPL Connection Class", HFILL }},\r\n{ &hf_rpl_lmac,\r\n{ "Loader MAC Address", "rpl.lmac",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\n"RPL Loader MAC Address", HFILL }},\r\n{ &hf_rpl_smac,\r\n{ "Set MAC Address", "rpl.smac",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\n"RPL Set MAC Address", HFILL }},\r\n{ &hf_rpl_sap,\r\n{ "SAP", "rpl.sap",\r\nFT_UINT8, BASE_HEX, VALS(sap_vals), 0x0,\r\n"RPL SAP", HFILL }},\r\n{ &hf_rpl_equipment,\r\n{ "Equipment", "rpl.equipment",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\n"RPL Equipment - AX from INT 11h", HFILL }},\r\n{ &hf_rpl_memsize,\r\n{ "Memory Size", "rpl.memsize",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"RPL Memory Size - AX from INT 12h MINUS 32k MINUS the Boot ROM Size", HFILL }},\r\n{ &hf_rpl_bsmversion,\r\n{ "BSM Version", "rpl.bsmversion",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\n"RPL Version of BSM.obj", HFILL }},\r\n{ &hf_rpl_adapterid,\r\n{ "Adapter ID", "rpl.adapterid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\n"RPL Adapter ID", HFILL }},\r\n{ &hf_rpl_shortname,\r\n{ "Short Name", "rpl.shortname",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"RPL BSM Short Name", HFILL }},\r\n{ &hf_rpl_laddress,\r\n{ "Locate Address", "rpl.laddress",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"RPL Locate Address", HFILL }},\r\n{ &hf_rpl_xaddress,\r\n{ "XFER Address", "rpl.xaddress",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"RPL Transfer Control Address", HFILL }},\r\n{ &hf_rpl_sequence,\r\n{ "Sequence Number", "rpl.sequence",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"RPL Sequence Number", HFILL }},\r\n{ &hf_rpl_config,\r\n{ "Configuration", "rpl.config",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"RPL Configuration", HFILL }},\r\n{ &hf_rpl_flags,\r\n{ "Flags", "rpl.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\n"RPL Bit Significant Option Flags", HFILL }},\r\n{ &hf_rpl_data,\r\n{ "Data", "rpl.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"RPL Binary File Data", HFILL }},\r\n{ &hf_rpl_ec,\r\n{ "EC", "rpl.ec",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"RPL EC", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_rpl,\r\n&ett_rpl_0004,\r\n&ett_rpl_0008,\r\n&ett_rpl_4003,\r\n&ett_rpl_4006,\r\n&ett_rpl_4007,\r\n&ett_rpl_4009,\r\n&ett_rpl_400a,\r\n&ett_rpl_400b,\r\n&ett_rpl_400c,\r\n&ett_rpl_4011,\r\n&ett_rpl_4018,\r\n&ett_rpl_c005,\r\n&ett_rpl_c014,\r\n&ett_rpl_unkn\r\n};\r\nproto_rpl = proto_register_protocol("Remote Program Load",\r\n"RPL", "rpl");\r\nproto_register_field_array(proto_rpl, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("rpl", dissect_rpl, proto_rpl);\r\n}\r\nvoid\r\nproto_reg_handoff_rpl(void)\r\n{\r\ndissector_handle_t rpl_handle;\r\nrpl_handle = find_dissector("rpl");\r\ndissector_add_uint("llc.dsap", SAP_RPL, rpl_handle);\r\n}

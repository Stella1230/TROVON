static int\r\ndissect_finger(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_item *ti, *expert_ti;\r\nproto_tree *finger_tree;\r\nconversation_t *conversation;\r\nfinger_transaction_t *finger_trans;\r\ngboolean is_query;\r\nguint len;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "FINGER");\r\nif (pinfo->destport == FINGER_PORT) {\r\nis_query = TRUE;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Query");\r\n} else {\r\nis_query = FALSE;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Response");\r\n}\r\nconversation = find_or_create_conversation(pinfo);\r\nfinger_trans = (finger_transaction_t *)conversation_get_proto_data(conversation, proto_finger);\r\nif (finger_trans == NULL) {\r\nfinger_trans = wmem_new0(wmem_file_scope(), finger_transaction_t);\r\nconversation_add_proto_data(conversation, proto_finger, finger_trans);\r\n}\r\nlen = tvb_reported_length(tvb);\r\nif (!PINFO_FD_VISITED(pinfo)) {\r\nif (pinfo->can_desegment) {\r\nif (is_query) {\r\nif ((len < 2) || (tvb_memeql(tvb, len - 2, "\r\n", 2))) {\r\npinfo->desegment_len = DESEGMENT_ONE_MORE_SEGMENT;\r\npinfo->desegment_offset = 0;\r\nreturn -1;\r\n} else {\r\nfinger_trans->req_frame = pinfo->num;\r\nfinger_trans->req_time = pinfo->abs_ts;\r\n}\r\n} else {\r\npinfo->desegment_len = DESEGMENT_UNTIL_FIN;\r\npinfo->desegment_offset = 0;\r\nreturn -1;\r\n}\r\n}\r\n} else if (is_query && (finger_trans->req_frame == 0)) {\r\nfinger_trans->req_frame = pinfo->num;\r\nfinger_trans->req_time = pinfo->abs_ts;\r\n}\r\nif (!is_query && (finger_trans->rep_frame == 0)) {\r\nfinger_trans->rep_frame = pinfo->num;\r\n}\r\nti = proto_tree_add_protocol_format(tree, proto_finger, tvb, 0, -1,\r\n"FINGER: %s", is_query ? "Query" : "Response");\r\nfinger_tree = proto_item_add_subtree(ti, ett_finger);\r\nif (is_query) {\r\nexpert_ti = proto_tree_add_item(finger_tree, hf_finger_query, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\nif ((len < 2) || (tvb_memeql(tvb, len - 2, "\r\n", 2))) {\r\nexpert_add_info(pinfo, expert_ti, &ei_finger_nocrlf);\r\n}\r\nif (tree && finger_trans->rep_frame) {\r\nti = proto_tree_add_uint(finger_tree, hf_finger_response_in,\r\ntvb, 0, 0, finger_trans->rep_frame);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n}\r\n} else if (tree && finger_trans->rep_frame) {\r\nproto_tree_add_item(finger_tree, hf_finger_response, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\nif (finger_trans->req_frame) {\r\nnstime_t ns;\r\nti = proto_tree_add_uint(finger_tree, hf_finger_response_to,\r\ntvb, 0, 0, finger_trans->req_frame);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nif (pinfo->num == finger_trans->rep_frame) {\r\nnstime_delta(&ns, &pinfo->abs_ts, &finger_trans->req_time);\r\nti = proto_tree_add_time(finger_tree, hf_finger_response_time, tvb, 0, 0, &ns);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_finger(void)\r\n{\r\nexpert_module_t *expert_finger;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_finger_query,\r\n{ "Query", "finger.query", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_finger_response,\r\n{ "Response", "finger.response", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_finger_response_in,\r\n{ "Response In", "finger.response_in", FT_FRAMENUM, BASE_NONE, NULL,\r\n0x0, "The response to this FINGER query is in this frame",\r\nHFILL }\r\n},\r\n{ &hf_finger_response_to,\r\n{ "Request In", "finger.response_to", FT_FRAMENUM, BASE_NONE, NULL,\r\n0x0, "This is a response to the FINGER query in this frame",\r\nHFILL }\r\n},\r\n{ &hf_finger_response_time,\r\n{ "Response Time", "finger.response_time", FT_RELATIVE_TIME,\r\nBASE_NONE, NULL, 0x0,\r\n"The time between the Query and the Response", HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_finger\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_finger_nocrlf,\r\n{ "finger.nocrlf", PI_MALFORMED, PI_WARN, "Missing <CR><LF>", EXPFILL}\r\n}\r\n};\r\nproto_finger = proto_register_protocol("finger", "FINGER", "finger");\r\nproto_register_field_array(proto_finger, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_finger = expert_register_protocol(proto_finger);\r\nexpert_register_field_array(expert_finger, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_finger(void)\r\n{\r\nstatic dissector_handle_t finger_handle;\r\nfinger_handle = create_dissector_handle(dissect_finger, proto_finger);\r\ndissector_add_uint("tcp.port", FINGER_PORT, finger_handle);\r\n}

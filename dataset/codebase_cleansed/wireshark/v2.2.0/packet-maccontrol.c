static int\r\ndissect_macctrl(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti, *opcode_item;\r\nproto_tree *macctrl_tree = NULL;\r\nproto_tree *pause_times_tree = NULL;\r\nguint16 opcode;\r\nguint16 pause_time;\r\nint i;\r\ngint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MAC CTRL");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nopcode = tvb_get_ntohs(tvb, 0);\r\nti = proto_tree_add_item(tree, proto_macctrl, tvb, 0, 46, ENC_NA);\r\nmacctrl_tree = proto_item_add_subtree(ti, ett_macctrl);\r\nopcode_item = proto_tree_add_uint(macctrl_tree, hf_macctrl_opcode, tvb, offset, 2, opcode);\r\noffset += 2;\r\nif ((opcode >= MACCTRL_GATE) && (opcode <= MACCTRL_REGISTER_ACK)) {\r\nproto_tree_add_item(macctrl_tree, hf_macctrl_timestamp, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str(opcode, opcode_vals, "Unknown"));\r\nswitch (opcode) {\r\ncase MACCTRL_PAUSE:\r\nif (!addresses_equal(&pinfo->dst, &macctrl_dst_address)) {\r\nexpert_add_info(pinfo, opcode_item, &ei_macctrl_dst_address);\r\n}\r\npause_time = tvb_get_ntohs(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": pause_time: %u quanta",\r\npause_time);\r\nproto_tree_add_uint(macctrl_tree, hf_macctrl_pause_time, tvb, offset, 2,\r\npause_time);\r\nbreak;\r\ncase MACCTRL_GATE:\r\nbreak;\r\ncase MACCTRL_REPORT:\r\nbreak;\r\ncase MACCTRL_REGISTER_REQ:\r\nproto_tree_add_item(macctrl_tree, hf_reg_flags, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(macctrl_tree, hf_reg_req_grants, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MACCTRL_REGISTER:\r\nproto_tree_add_item(macctrl_tree, hf_reg_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(macctrl_tree, hf_reg_flags, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(macctrl_tree, hf_reg_time, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(macctrl_tree, hf_reg_grants, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MACCTRL_REGISTER_ACK:\r\nproto_tree_add_item(macctrl_tree, hf_reg_flags, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(macctrl_tree, hf_reg_ack_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(macctrl_tree, hf_reg_ack_time, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MACCTRL_CLASS_BASED_FLOW_CNTRL_PAUSE:\r\nif (!addresses_equal(&pinfo->dst, &macctrl_dst_address)) {\r\nexpert_add_info(pinfo, opcode_item, &ei_macctrl_dst_address);\r\n}\r\nti = proto_tree_add_bitmask(macctrl_tree, tvb, offset, hf_macctrl_cbfc_enbv,\r\nett_macctrl_cbfc_enbv, macctrl_cbfc_enbv_list, ENC_BIG_ENDIAN);\r\nif (tvb_get_guint8(tvb, offset) != 0) {\r\nexpert_add_info(pinfo, ti, &ei_macctrl_cbfc_enbv);\r\n}\r\noffset += 2;\r\npause_times_tree = proto_tree_add_subtree(macctrl_tree, tvb, offset, 8*2, ett_macctrl_cbfc_pause_times, NULL, "CBFC Class Pause Times");\r\nfor (i=0; i<8; i++) {\r\nproto_tree_add_item(pause_times_tree, *macctrl_cbfc_pause_times_list[i], tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, opcode_item, &ei_macctrl_opcode);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_macctrl(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_macctrl_opcode,\r\n{ "Opcode", "macc.opcode", FT_UINT16, BASE_HEX,\r\nVALS(opcode_vals), 0x0, "MAC Control Opcode", HFILL}},\r\n{ &hf_macctrl_timestamp,\r\n{ "Timestamp", "macc.timestamp", FT_UINT32, BASE_DEC,\r\nNULL, 0x0, "MAC Control Timestamp", HFILL }},\r\n{ &hf_macctrl_pause_time,\r\n{ "pause_time", "macc.pause_time", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, "MAC control PAUSE frame pause_time", HFILL }},\r\n{ &hf_macctrl_cbfc_enbv,\r\n{ "CBFC Class Enable Vector", "macc.cbfc.enbv", FT_UINT16, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c0,\r\n{ "C0", "macc.cbfc.enbv.c0", FT_BOOLEAN, 16,\r\nNULL, 0x01, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c1,\r\n{ "C1", "macc.cbfc.enbv.c1", FT_BOOLEAN, 16,\r\nNULL, 0x02, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c2,\r\n{ "C2", "macc.cbfc.enbv.c2", FT_BOOLEAN, 16,\r\nNULL, 0x04, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c3,\r\n{ "C3", "macc.cbfc.enbv.c3", FT_BOOLEAN, 16,\r\nNULL, 0x08, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c4,\r\n{ "C4", "macc.cbfc.enbv.c4", FT_BOOLEAN, 16,\r\nNULL, 0x10, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c5,\r\n{ "C5", "macc.cbfc.enbv.c5", FT_BOOLEAN, 16,\r\nNULL, 0x20, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c6,\r\n{ "C6", "macc.cbfc.enbv.c6", FT_BOOLEAN, 16,\r\nNULL, 0x40, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_enbv_c7,\r\n{ "C7", "macc.cbfc.enbv.c7", FT_BOOLEAN, 16,\r\nNULL, 0x80, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c0,\r\n{ "C0", "macc.cbfc.pause_time.c0", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c1,\r\n{ "C1", "macc.cbfc.pause_time.c1", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c2,\r\n{ "C2", "macc.cbfc.pause_time.c2", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c3,\r\n{ "C3", "macc.cbfc.pause_time.c3", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c4,\r\n{ "C4", "macc.cbfc.pause_time.c4", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c5,\r\n{ "C5", "macc.cbfc.pause_time.c5", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c6,\r\n{ "C6", "macc.cbfc.pause_time.c6", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_macctrl_cbfc_pause_time_c7,\r\n{ "C7", "macc.cbfc.pause_time.c7", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_reg_flags,\r\n{ "Flags", "macc.reg.flags", FT_UINT8, BASE_HEX,\r\nVALS(reg_flags_vals), 0x00, NULL, HFILL }},\r\n{ &hf_reg_req_grants,\r\n{ "Pending Grants", "macc.regreq.grants", FT_UINT8, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_reg_grants,\r\n{ "Echoed Pending Grants", "macc.reg.grants", FT_UINT8, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_reg_port,\r\n{ "Assigned Port (LLID)", "macc.reg.assignedport", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_reg_ack_port,\r\n{ "Echoed Assigned Port (LLID)", "macc.regack.assignedport", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_reg_time,\r\n{ "Sync Time", "macc.reg.synctime", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }},\r\n{ &hf_reg_ack_time,\r\n{ "Echoed Sync Time", "macc.regack.synctime", FT_UINT16, BASE_DEC,\r\nNULL, 0x00, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_macctrl,\r\n&ett_macctrl_cbfc_enbv,\r\n&ett_macctrl_cbfc_pause_times\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_macctrl_opcode, { "macc.opcode.unknown", PI_PROTOCOL, PI_WARN, "Unknown opcode", EXPFILL }},\r\n{ &ei_macctrl_cbfc_enbv, { "macc.cbfc.enbv.not_zero", PI_PROTOCOL, PI_WARN, "8 MSbs of ENBV must be 0", EXPFILL }},\r\n{ &ei_macctrl_dst_address, { "macc.dst_address_invalid", PI_PROTOCOL, PI_WARN, "Destination address must be 01-80-C2-00-00-01", EXPFILL }},\r\n};\r\nexpert_module_t* expert_macctrl;\r\nproto_macctrl = proto_register_protocol("MAC Control", "MACC", "macc");\r\nproto_register_field_array(proto_macctrl, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_macctrl = expert_register_protocol(proto_macctrl);\r\nexpert_register_field_array(expert_macctrl, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_macctrl(void)\r\n{\r\ndissector_handle_t macctrl_handle;\r\nmacctrl_handle = create_dissector_handle(dissect_macctrl, proto_macctrl);\r\ndissector_add_uint("ethertype", ETHERTYPE_MAC_CONTROL, macctrl_handle);\r\n}

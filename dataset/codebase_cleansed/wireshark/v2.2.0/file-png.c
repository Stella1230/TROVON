static void\r\ndissect_png_ihdr(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, &hfi_png_ihdr_width, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_ihdr_height, tvb, 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_ihdr_bitdepth, tvb, 8, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_ihdr_colour_type, tvb, 9, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_ihdr_compression_method, tvb, 10, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_ihdr_filter_method, tvb, 11, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_ihdr_interlace_method, tvb, 12, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_png_srgb(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, &hfi_png_srgb_intent,\r\ntvb, 0, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_png_text(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\ngint offset=0, nul_offset;\r\nnul_offset = tvb_find_guint8(tvb, offset, tvb_captured_length_remaining(tvb, offset), 0);\r\nif (nul_offset<=0) {\r\nreturn;\r\n}\r\nproto_tree_add_item(tree, &hfi_png_text_keyword, tvb, offset, nul_offset, ENC_ISO_8859_1|ENC_NA);\r\noffset = nul_offset+1;\r\nproto_tree_add_item(tree, &hfi_png_text_string, tvb, offset, tvb_captured_length_remaining(tvb, offset), ENC_ISO_8859_1|ENC_NA);\r\n}\r\nstatic void\r\ndissect_png_time(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, &hfi_png_time_year, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_time_month, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_time_day, tvb, 3, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_time_hour, tvb, 4, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_time_minute, tvb, 5, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_time_second, tvb, 6, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_png_phys(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, &hfi_png_phys_horiz, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_phys_vert, tvb, 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_phys_unit, tvb, 8, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_png_bkgd(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nswitch(tvb_reported_length(tvb)){\r\ncase 1:\r\nproto_tree_add_item(tree, &hfi_png_bkgd_palette_index, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(tree, &hfi_png_bkgd_greyscale, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(tree, &hfi_png_bkgd_red, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_bkgd_green, tvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, &hfi_png_bkgd_blue, tvb, 4, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\ndissect_png_chrm(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nfloat wx, wy, rx, ry, gx, gy, bx, by;\r\ngint offset = 0;\r\nwx = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_white_x,\r\ntvb, offset, 4, wx, "%f", wx);\r\noffset += 4;\r\nwy = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_white_y,\r\ntvb, offset, 4, wy, "%f", wy);\r\noffset += 4;\r\nrx = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_red_x,\r\ntvb, offset, 4, rx, "%f", rx);\r\noffset += 4;\r\nry = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_red_y,\r\ntvb, offset, 4, ry, "%f", ry);\r\noffset += 4;\r\ngx = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_green_x,\r\ntvb, offset, 4, gx, "%f", gx);\r\noffset += 4;\r\ngy = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_green_y,\r\ntvb, offset, 4, gy, "%f", gy);\r\noffset += 4;\r\nbx = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_blue_x,\r\ntvb, offset, 4, bx, "%f", bx);\r\noffset += 4;\r\nby = tvb_get_ntohl(tvb, offset) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_chrm_blue_y,\r\ntvb, offset, 4, by, "%f", by);\r\n}\r\nstatic void\r\ndissect_png_gama(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nfloat gamma;\r\ngamma = tvb_get_ntohl(tvb, 0) / 100000.0f;\r\nproto_tree_add_float_format_value(tree, &hfi_png_gama_gamma,\r\ntvb, 0, 4, gamma, "%f", gamma);\r\n}\r\nstatic gint\r\ndissect_png(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, void *data _U_)\r\n{\r\nproto_tree *tree;\r\nproto_item *ti;\r\ngint offset=0;\r\nstatic const guint8 magic[8] = { 137, 80, 78, 71, 13, 10, 26, 10 };\r\nif (tvb_captured_length(tvb) < 20)\r\nreturn 0;\r\nif (tvb_memeql(tvb, 0, magic, sizeof(magic)) != 0)\r\nreturn 0;\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (PNG)");\r\nti=proto_tree_add_item(parent_tree, hfi_png, tvb, offset, -1, ENC_NA);\r\ntree=proto_item_add_subtree(ti, ett_png);\r\nproto_tree_add_item(tree, &hfi_png_signature, tvb, offset, 8, ENC_NA);\r\noffset+=8;\r\nwhile(tvb_reported_length_remaining(tvb, offset) > 0){\r\nguint32 len_field;\r\nproto_item *len_it;\r\nproto_tree *chunk_tree;\r\nguint32 type;\r\nguint8 *type_str;\r\ntvbuff_t *chunk_tvb;\r\nlen_field = tvb_get_ntohl(tvb, offset);\r\ntype = tvb_get_ntohl(tvb, offset+4);\r\ntype_str = tvb_get_string_enc(wmem_packet_scope(),\r\ntvb, offset+4, 4, ENC_ASCII|ENC_NA);\r\nchunk_tree = proto_tree_add_subtree_format(tree, tvb, offset, 4+4+len_field+4, ett_png_chunk, NULL,\r\n"%s (%s)", val_to_str_const(type, chunk_types, "unknown"), type_str);\r\nlen_it = proto_tree_add_item(chunk_tree, &hfi_png_chunk_len,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (len_field > G_MAXINT) {\r\nexpert_add_info(pinfo, len_it, &ei_png_chunk_too_large);\r\nreturn offset;\r\n}\r\nproto_tree_add_item(chunk_tree, &hfi_png_chunk_type_str,\r\ntvb, offset, 4, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(chunk_tree, &hfi_png_chunk_flag_anc, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(chunk_tree, &hfi_png_chunk_flag_priv, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(chunk_tree, &hfi_png_chunk_flag_stc, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nchunk_tvb=tvb_new_subset_length(tvb, offset, len_field);\r\nswitch (type) {\r\ncase CHUNK_TYPE_IHDR:\r\ndissect_png_ihdr(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_bKGD:\r\ndissect_png_bkgd(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_cHRM:\r\ndissect_png_chrm(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_gAMA:\r\ndissect_png_gama(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_pHYs:\r\ndissect_png_phys(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_sRGB:\r\ndissect_png_srgb(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_tEXt:\r\ndissect_png_text(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ncase CHUNK_TYPE_tIME:\r\ndissect_png_time(chunk_tvb, pinfo, chunk_tree);\r\nbreak;\r\ndefault:\r\nif (len_field>0) {\r\nproto_tree_add_item(chunk_tree, &hfi_png_chunk_data,\r\ntvb, offset, len_field, ENC_NA);\r\n}\r\nbreak;\r\n}\r\noffset += len_field;\r\nproto_tree_add_item(chunk_tree, &hfi_png_chunk_crc, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_png(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] =\r\n{\r\n&hfi_png_signature,\r\n&hfi_png_chunk_type_str,\r\n&hfi_png_chunk_data,\r\n&hfi_png_chunk_len,\r\n&hfi_png_chunk_crc,\r\n&hfi_png_chunk_flag_anc,\r\n&hfi_png_chunk_flag_priv,\r\n&hfi_png_chunk_flag_stc,\r\n&hfi_png_ihdr_width,\r\n&hfi_png_ihdr_height,\r\n&hfi_png_ihdr_bitdepth,\r\n&hfi_png_ihdr_colour_type,\r\n&hfi_png_ihdr_compression_method,\r\n&hfi_png_ihdr_filter_method,\r\n&hfi_png_ihdr_interlace_method,\r\n&hfi_png_srgb_intent,\r\n&hfi_png_text_keyword,\r\n&hfi_png_text_string,\r\n&hfi_png_time_year,\r\n&hfi_png_time_month,\r\n&hfi_png_time_day,\r\n&hfi_png_time_hour,\r\n&hfi_png_time_minute,\r\n&hfi_png_time_second,\r\n&hfi_png_phys_horiz,\r\n&hfi_png_phys_vert,\r\n&hfi_png_phys_unit,\r\n&hfi_png_bkgd_palette_index,\r\n&hfi_png_bkgd_greyscale,\r\n&hfi_png_bkgd_red,\r\n&hfi_png_bkgd_green,\r\n&hfi_png_bkgd_blue,\r\n&hfi_png_chrm_white_x,\r\n&hfi_png_chrm_white_y,\r\n&hfi_png_chrm_red_x,\r\n&hfi_png_chrm_red_y,\r\n&hfi_png_chrm_green_x,\r\n&hfi_png_chrm_green_y,\r\n&hfi_png_chrm_blue_x,\r\n&hfi_png_chrm_blue_y,\r\n&hfi_png_gama_gamma\r\n};\r\n#endif\r\nstatic gint *ett[] =\r\n{\r\n&ett_png,\r\n&ett_png_chunk,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_png_chunk_too_large,\r\n{ "png.chunk_too_large", PI_PROTOCOL, PI_WARN,\r\n"chunk size too large, dissection of this chunk is not supported", EXPFILL }}\r\n};\r\nexpert_module_t *expert_png;\r\nint proto_png;\r\nproto_png = proto_register_protocol("Portable Network Graphics","PNG","png");\r\nhfi_png = proto_registrar_get_nth(proto_png);\r\nproto_register_fields(proto_png, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_png = expert_register_protocol(proto_png);\r\nexpert_register_field_array(expert_png, ei, array_length(ei));\r\npng_handle = register_dissector("png", dissect_png, proto_png);\r\n}\r\nstatic gboolean dissect_png_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_png(tvb, pinfo, tree, NULL) > 0;\r\n}\r\nvoid\r\nproto_reg_handoff_png(void)\r\n{\r\ndissector_add_string("media_type", "image/png", png_handle);\r\nheur_dissector_add("http", dissect_png_heur, "PNG file in HTTP", "png_http", hfi_png->id, HEURISTIC_ENABLE);\r\nheur_dissector_add("wtap_file", dissect_png_heur, "PNG file in HTTP", "png_wtap", hfi_png->id, HEURISTIC_ENABLE);\r\n}

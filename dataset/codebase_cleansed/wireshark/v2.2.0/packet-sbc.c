static gint\r\ndissect_sbc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nproto_item *ti;\r\nproto_tree *sbc_tree;\r\nproto_item *pitem;\r\nproto_tree *rtree;\r\ngint offset = 0;\r\nguint8 number_of_frames;\r\nguint8 syncword;\r\nguint8 byte;\r\nguint8 blocks;\r\nguint8 channels;\r\nguint8 subbands;\r\nguint8 bitpool;\r\nguint frequency;\r\nguint8 sbc_blocks;\r\ngint sbc_channels;\r\nguint8 sbc_subbands;\r\ngint val;\r\ngint counter = 1;\r\ngint frame_length;\r\ngint expected_speed_data;\r\ngdouble frame_duration;\r\ngdouble cumulative_frame_duration = 0;\r\nbta2dp_codec_info_t *info;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SBC");\r\ninfo = (bta2dp_codec_info_t *) data;\r\nti = proto_tree_add_item(tree, proto_sbc, tvb, offset, -1, ENC_NA);\r\nsbc_tree = proto_item_add_subtree(ti, ett_sbc);\r\nproto_tree_add_item(sbc_tree, hf_sbc_fragmented, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sbc_tree, hf_sbc_starting_packet, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sbc_tree, hf_sbc_last_packet, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sbc_tree, hf_sbc_rfa, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sbc_tree, hf_sbc_number_of_frames, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nnumber_of_frames = tvb_get_guint8(tvb, offset) & 0x0F;\r\noffset += 1;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nbyte = tvb_get_guint8(tvb, offset + 1);\r\nfrequency = (byte & 0xC0) >> 6;\r\nblocks = (byte & 0x30) >> 4;\r\nchannels = (byte & 0x0C)>> 2;\r\nsubbands = byte & 0x01;\r\nbitpool = tvb_get_guint8(tvb, offset + 2);\r\nif (channels == CHANNELS_MONO)\r\nsbc_channels = 1;\r\nelse\r\nsbc_channels = 2;\r\nswitch (frequency) {\r\ncase FREQUENCY_16000:\r\nfrequency = 16000;\r\nbreak;\r\ncase FREQUENCY_32000:\r\nfrequency = 32000;\r\nbreak;\r\ncase FREQUENCY_44100:\r\nfrequency = 44100;\r\nbreak;\r\ncase FREQUENCY_48000:\r\nfrequency = 48000;\r\nbreak;\r\ndefault:\r\nfrequency = 0;\r\n}\r\nsbc_subbands = 4 * (subbands + 1);\r\nsbc_blocks = 4 * (blocks + 1);\r\nframe_length = (4 * sbc_subbands * sbc_channels) / 8;\r\nif (sbc_channels == 1)\r\nval = sbc_blocks * sbc_channels * bitpool;\r\nelse\r\nval = (((channels == CHANNELS_JOINT_STEREO) ? 1 : 0) * sbc_subbands + sbc_blocks * bitpool);\r\nframe_length += val / 8;\r\nif (val % 8)\r\nframe_length += 1;\r\nexpected_speed_data = (frame_length * frequency) / (sbc_subbands * sbc_blocks);\r\nrtree = proto_tree_add_subtree_format(sbc_tree, tvb, offset, 4 + frame_length,\r\nett_sbc_list, NULL, "Frame: %3u/%3u", counter, number_of_frames);\r\npitem = proto_tree_add_item(rtree, hf_sbc_syncword, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nsyncword = tvb_get_guint8(tvb, offset);\r\nif (syncword != 0x9C) {\r\nexpert_add_info(pinfo, pitem, &ei_sbc_syncword);\r\n}\r\noffset += 1;\r\nproto_tree_add_item(rtree, hf_sbc_sampling_frequency, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rtree, hf_sbc_blocks, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rtree, hf_sbc_channel_mode, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rtree, hf_sbc_allocation_method, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rtree, hf_sbc_subbands, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(rtree, hf_sbc_bitpool, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(rtree, hf_sbc_crc_check, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(rtree, hf_sbc_data, tvb, offset, frame_length, ENC_NA);\r\noffset += frame_length;\r\npitem = proto_tree_add_uint(rtree, hf_sbc_expected_data_speed, tvb, offset, 0, expected_speed_data / 1024);\r\nproto_item_append_text(pitem, " KiB/s");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\nframe_duration = (((double) frame_length / (double) expected_speed_data) * 1000.0);\r\ncumulative_frame_duration += frame_duration;\r\npitem = proto_tree_add_double(rtree, hf_sbc_frame_duration, tvb, offset, 0, frame_duration);\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\ncounter += 1;\r\n}\r\npitem = proto_tree_add_double(sbc_tree, hf_sbc_cumulative_frame_duration, tvb, offset, 0, cumulative_frame_duration);\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\nif (info && info->configuration && info->configuration_length > 0) {\r\n}\r\nif (info && info->previous_media_packet_info && info->current_media_packet_info) {\r\nnstime_t delta;\r\nnstime_delta(&delta, &pinfo->abs_ts, &info->previous_media_packet_info->abs_ts);\r\npitem = proto_tree_add_double(sbc_tree, hf_sbc_delta_time, tvb, offset, 0, nstime_to_msec(&delta));\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\npitem = proto_tree_add_double(sbc_tree, hf_sbc_avrcp_song_position, tvb, offset, 0, info->previous_media_packet_info->avrcp_song_position);\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\nnstime_delta(&delta, &pinfo->abs_ts, &info->previous_media_packet_info->first_abs_ts);\r\npitem = proto_tree_add_double(sbc_tree, hf_sbc_delta_time_from_the_beginning, tvb, offset, 0, nstime_to_msec(&delta));\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\nif (!pinfo->fd->flags.visited) {\r\ninfo->current_media_packet_info->cumulative_frame_duration += cumulative_frame_duration;\r\ninfo->current_media_packet_info->avrcp_song_position += cumulative_frame_duration;\r\n}\r\npitem = proto_tree_add_double(sbc_tree, hf_sbc_cumulative_duration, tvb, offset, 0, info->previous_media_packet_info->cumulative_frame_duration);\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\npitem = proto_tree_add_double(sbc_tree, hf_sbc_diff, tvb, offset, 0, info->previous_media_packet_info->cumulative_frame_duration - nstime_to_msec(&delta));\r\nproto_item_append_text(pitem, " ms");\r\nPROTO_ITEM_SET_GENERATED(pitem);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Frames=%u", number_of_frames);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_sbc(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t* expert_sbc;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sbc_fragmented,\r\n{ "Fragmented", "sbc.fragmented",\r\nFT_BOOLEAN, 8, NULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_starting_packet,\r\n{ "Starting Packet", "sbc.starting_packet",\r\nFT_BOOLEAN, 8, NULL, 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_last_packet,\r\n{ "Last Packet", "sbc.last_packet",\r\nFT_BOOLEAN, 8, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_rfa,\r\n{ "RFA", "sbc.rfa",\r\nFT_BOOLEAN, 8, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_number_of_frames,\r\n{ "Number of Frames", "sbc.number_of_frames",\r\nFT_UINT8, BASE_DEC, NULL, 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_syncword,\r\n{ "Sync Word", "sbc.syncword",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_sampling_frequency,\r\n{ "Sampling Frequency", "sbc.sampling_frequency",\r\nFT_UINT8, BASE_HEX, VALS(sampling_frequency_vals), 0xC0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_blocks,\r\n{ "Blocks", "sbc.blocks",\r\nFT_UINT8, BASE_HEX, VALS(blocks_vals), 0x30,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_channel_mode,\r\n{ "Channel Mode", "sbc.channel_mode",\r\nFT_UINT8, BASE_HEX, VALS(channel_mode_vals), 0x0C,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_allocation_method,\r\n{ "Allocation Method", "sbc.allocation_method",\r\nFT_UINT8, BASE_HEX, VALS(allocation_method_vals), 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_subbands,\r\n{ "Subbands", "sbc.subbands",\r\nFT_UINT8, BASE_HEX, VALS(subbands_vals), 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_bitpool,\r\n{ "Bitpool", "sbc.bitpool",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_crc_check,\r\n{ "CRC Check", "sbc.crc_check",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_expected_data_speed,\r\n{ "Expected data speed", "sbc.expected_speed_data",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_frame_duration,\r\n{ "Frame Duration", "sbc.frame_duration",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_cumulative_frame_duration,\r\n{ "Cumulative Frame Duration", "sbc.cumulative_frame_duration",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_delta_time,\r\n{ "Delta time", "sbc.delta_time",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_delta_time_from_the_beginning,\r\n{ "Delta time from the beginning", "sbc.delta_time_from_the_beginning",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_cumulative_duration,\r\n{ "Cumulative Music Duration", "sbc.cumulative_music_duration",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_avrcp_song_position,\r\n{ "AVRCP Song Position", "sbc.avrcp_song_position",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_diff,\r\n{ "Diff", "sbc.diff",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sbc_data,\r\n{ "Frame Data", "sbc.data",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_sbc,\r\n&ett_sbc_list,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_sbc_syncword, { "sbc.syncword.unexpected", PI_PROTOCOL, PI_WARN, "Unexpected syncword", EXPFILL }},\r\n};\r\nproto_sbc = proto_register_protocol("Bluetooth SBC Codec", "SBC", "sbc");\r\nproto_register_field_array(proto_sbc, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_sbc = expert_register_protocol(proto_sbc);\r\nexpert_register_field_array(expert_sbc, ei, array_length(ei));\r\nregister_dissector("sbc", dissect_sbc, proto_sbc);\r\nmodule = prefs_register_protocol(proto_sbc, NULL);\r\nprefs_register_static_text_preference(module, "a2dp.version",\r\n"Bluetooth Audio Codec SBC version based on A2DP 1.3",\r\n"Version of codec supported by this dissector.");\r\n}

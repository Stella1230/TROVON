void *codec_g7231_init(void) {\r\nstruct g7231_context *ctx = 0;\r\nctx = (struct g7231_context*)g_malloc0(sizeof(struct g7231_context));\r\nctx->handle = -1;\r\nreturn ctx;\r\n}\r\nvoid codec_g7231_release(void *context) {\r\nstruct g7231_context *ctx = (struct g7231_context*)context;\r\nif (!ctx) return;\r\nEasyG7231_release_decoder(ctx->handle);\r\ng_free(ctx);\r\n}\r\nint codec_g7231_decode(void *context, const void *input, int inputSizeBytes, void *output, int *outputSizeBytes) {\r\nstruct g7231_context *ctx = (struct g7231_context*)context;\r\nconst unsigned char *bitstream = (const unsigned char*)input;\r\nshort *speech = (short*)output;\r\nint decodedBytes = 0;\r\nif (!ctx) return 0;\r\nif ( ctx->handle == -1) {\r\nif ( bitstream[0] & 0x03 ) {\r\nctx->handle=EasyG7231_init_decoder(FALSE);\r\nctx->l_g7231_frame_compressed = L_G7231_FRAME_COMPRESSED_53;\r\n} else {\r\nctx->handle=EasyG7231_init_decoder(TRUE);\r\nctx->l_g7231_frame_compressed = L_G7231_FRAME_COMPRESSED_63;\r\n}\r\n}\r\nif ((inputSizeBytes % ctx->l_g7231_frame_compressed) != 0)\r\nreturn 0;\r\nif (!output)\r\nreturn (inputSizeBytes / ctx->l_g7231_frame_compressed) * L_G7231_FRAME * sizeof(short);\r\nwhile ((inputSizeBytes >= ctx->l_g7231_frame_compressed) &&\r\n((*outputSizeBytes - decodedBytes) >= L_G7231_FRAME * sizeof(short))) {\r\nif (EasyG7231_decoder(ctx->handle, (unsigned char*)bitstream, ctx->speach_buffer)) {\r\nmemcpy(speech, ctx->speach_buffer, L_G7231_FRAME * sizeof(short));\r\nspeech += L_G7231_FRAME;\r\ndecodedBytes += L_G7231_FRAME * sizeof(short);\r\n}\r\nbitstream += ctx->l_g7231_frame_compressed;\r\ninputSizeBytes -= ctx->l_g7231_frame_compressed;\r\n}\r\nreturn decodedBytes;\r\n}

static int\r\ndissect_winsrepl_start(tvbuff_t *winsrepl_tvb, _U_ packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nproto_tree *start_tree;\r\nstart_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_start, NULL, "WREPL_START_ASSOCIATION");\r\nproto_tree_add_item(start_tree, hf_winsrepl_assoc_ctx, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\nproto_tree_add_item(start_tree, hf_winsrepl_start_minor_version, winsrepl_tvb, winsrepl_offset, 2, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 2;\r\nproto_tree_add_item(start_tree, hf_winsrepl_start_major_version, winsrepl_tvb, winsrepl_offset, 2, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 2;\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_stop(tvbuff_t *winsrepl_tvb, _U_ packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nguint32 reason;\r\nproto_item *stop_item;\r\nproto_tree *stop_tree;\r\nstop_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_stop, &stop_item, "WREPL_STOP_ASSOCIATION");\r\nreason = tvb_get_ntohl(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_uint(stop_tree, hf_winsrepl_stop_reason, winsrepl_tvb, winsrepl_offset, 4, reason);\r\nwinsrepl_offset += 4;\r\nproto_item_append_text(stop_item, ", Reason: 0x%08X", reason);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_table_query(tvbuff_t *winsrepl_tvb _U_, packet_info *pinfo _U_,\r\nint winsrepl_offset, proto_tree *winsrepl_tree _U_)\r\n{\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_wins_owner(tvbuff_t *winsrepl_tvb, _U_ packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree,\r\nproto_tree *sub_tree, guint32 idx)\r\n{\r\nproto_tree *owner_tree = NULL;\r\nif (sub_tree) {\r\nowner_tree = proto_tree_add_subtree_format(sub_tree, winsrepl_tvb, winsrepl_offset, 24,\r\nett_winsrepl_owner, NULL, "WINS Owner [%u]", idx);\r\n} else if (winsrepl_tree) {\r\nowner_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, 24,\r\nett_winsrepl_owner, NULL, "WINS Owner");\r\n}\r\nproto_tree_add_item(owner_tree, hf_winsrepl_owner_address, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\nproto_tree_add_item(owner_tree, hf_winsrepl_owner_max_version, winsrepl_tvb, winsrepl_offset, 8, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 8;\r\nproto_tree_add_item(owner_tree, hf_winsrepl_owner_min_version, winsrepl_tvb, winsrepl_offset, 8, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 8;\r\nproto_tree_add_item(owner_tree, hf_winsrepl_owner_type, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_table_reply(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nproto_tree *table_tree;\r\nguint32 partner_count;\r\nguint32 i;\r\ntable_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_table_reply, NULL, "WREPL_REPL_TABLE_REPLY");\r\npartner_count = tvb_get_ntohl(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_uint(table_tree, hf_winsrepl_table_partner_count, winsrepl_tvb, winsrepl_offset, 4, partner_count);\r\nwinsrepl_offset += 4;\r\nfor (i=0; i < partner_count; i++) {\r\nwinsrepl_offset = dissect_winsrepl_wins_owner(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, table_tree,\r\ntable_tree, i);\r\n}\r\nproto_tree_add_item(table_tree, hf_winsrepl_table_initiator, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_send_request(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nwinsrepl_offset = dissect_winsrepl_wins_owner(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, winsrepl_tree,\r\nNULL, 0);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_wins_ip(tvbuff_t *winsrepl_tvb, _U_ packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree,\r\nguint32 *addr, proto_tree *sub_tree, guint32 idx)\r\n{\r\nproto_item *ip_item = NULL;\r\nproto_tree *ip_tree = NULL;\r\nif (sub_tree) {\r\nip_tree = proto_tree_add_subtree_format(sub_tree, winsrepl_tvb, winsrepl_offset, 8,\r\nett_winsrepl_ip, &ip_item, "WINS IP [%u]", idx);\r\n} else if (winsrepl_tree) {\r\nip_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, 8,\r\nett_winsrepl_ip, &ip_item, "WINS IP");\r\n}\r\nproto_tree_add_item(ip_tree, hf_winsrepl_ip_owner, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\n*addr = tvb_get_ipv4(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_ipv4(ip_tree, hf_winsrepl_ip_ip, winsrepl_tvb, winsrepl_offset, 4, *addr);\r\nproto_item_append_text(ip_item, ": %s", tvb_ip_to_str(winsrepl_tvb, winsrepl_offset));\r\nwinsrepl_offset += 4;\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_wins_address_list(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree,\r\nproto_item *parent_item)\r\n{\r\nproto_item *addr_list_item;\r\nproto_tree *addr_list_tree;\r\nint old_offset = winsrepl_offset;\r\nguint32 num_ips;\r\nguint32 ip;\r\nguint32 i;\r\naddress addr;\r\ngchar* addr_str;\r\naddr_list_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_addr_list, &addr_list_item, "WINS Address List");\r\nnum_ips = tvb_get_letohl(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_uint(addr_list_tree, hf_winsrepl_addr_list_num_ips, winsrepl_tvb, winsrepl_offset, 4, num_ips);\r\nwinsrepl_offset += 4;\r\nfor (i=0; i < num_ips; i++) {\r\nwinsrepl_offset = dissect_winsrepl_wins_ip(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, addr_list_tree,\r\n&ip, addr_list_tree, i);\r\nset_address(&addr, AT_IPv4, 4, &ip);\r\naddr_str = address_to_str(wmem_packet_scope(), &addr);\r\nif (i == 0) {\r\nproto_item_append_text(parent_item, ": %s", addr_str);\r\nproto_item_append_text(addr_list_item, ": %s", addr_str);\r\n} else {\r\nproto_item_append_text(parent_item, ", %s", addr_str);\r\nproto_item_append_text(addr_list_item, ", %s", addr_str);\r\n}\r\n}\r\nproto_item_set_len(addr_list_item, winsrepl_offset - old_offset);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_wins_name(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree,\r\nproto_tree *sub_tree, guint32 idx)\r\n{\r\nproto_item *name_item = NULL, *ti;\r\nproto_tree *name_tree = NULL;\r\nint old_offset = winsrepl_offset;\r\ntvbuff_t *name_tvb = NULL;\r\nguint32 name_len;\r\nchar name_str[(NETBIOS_NAME_LEN - 1)*4 + 1];\r\nint name_type;\r\nguint32 flags;\r\nstatic const int * name_flags[] = {\r\n&hf_winsrepl_name_flags_rectype,\r\n&hf_winsrepl_name_flags_recstate,\r\n&hf_winsrepl_name_flags_local,\r\n&hf_winsrepl_name_flags_hosttype,\r\n&hf_winsrepl_name_flags_static,\r\nNULL\r\n};\r\nif (sub_tree) {\r\nname_tree = proto_tree_add_subtree_format(sub_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_name, &name_item, "WINS Name [%u]", idx);\r\n} else if (winsrepl_tree) {\r\nname_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_name, &name_item, "WINS Name");\r\n}\r\nname_len = tvb_get_ntohl(winsrepl_tvb, winsrepl_offset);\r\nti = proto_tree_add_uint(name_tree, hf_winsrepl_name_len, winsrepl_tvb, winsrepl_offset, 4, name_len);\r\nwinsrepl_offset += 4;\r\nif (name_len == 0) {\r\nexpert_add_info(pinfo, ti, &ei_winsrepl_name_len);\r\nreturn winsrepl_offset;\r\n}\r\nname_tvb = tvb_new_subset_length(winsrepl_tvb, winsrepl_offset, name_len);\r\nnetbios_add_name("Name", name_tvb, 0, name_tree);\r\nname_type = get_netbios_name(name_tvb, 0, name_str, (NETBIOS_NAME_LEN - 1)*4 + 1);\r\nproto_item_append_text(name_item, ": %s<%02x>", name_str, name_type);\r\nwinsrepl_offset += name_len;\r\nwinsrepl_offset += 4 - (winsrepl_offset & (4-1));\r\nflags = tvb_get_ntohl(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_bitmask(name_tree, winsrepl_tvb, winsrepl_offset, hf_winsrepl_name_flags, ett_winsrepl_flags, name_flags, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\nproto_tree_add_item(name_tree, hf_winsrepl_name_group_flag, winsrepl_tvb, winsrepl_offset, 4, ENC_LITTLE_ENDIAN);\r\nwinsrepl_offset += 4;\r\nproto_tree_add_item(name_tree, hf_winsrepl_name_version_id, winsrepl_tvb, winsrepl_offset, 8, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 8;\r\nswitch (flags & WREPL_NAME_TYPE_MASK) {\r\ncase WREPL_NAME_TYPE_UNIQUE:\r\ncase WREPL_NAME_TYPE_NORMAL_GROUP:\r\nproto_tree_add_item(name_tree, hf_winsrepl_ip_ip, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nproto_item_append_text(name_item, ": %s", tvb_ip_to_str(winsrepl_tvb, winsrepl_offset));\r\nwinsrepl_offset += 4;\r\nbreak;\r\ncase WREPL_NAME_TYPE_SPECIAL_GROUP:\r\ncase WREPL_NAME_TYPE_MULTIHOMED:\r\nwinsrepl_offset = dissect_winsrepl_wins_address_list(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, name_tree,\r\nname_item);\r\nbreak;\r\n}\r\nproto_tree_add_item(name_tree, hf_winsrepl_name_unknown, winsrepl_tvb, winsrepl_offset, 4, ENC_BIG_ENDIAN);\r\nwinsrepl_offset += 4;\r\nproto_item_set_len(name_item, winsrepl_offset - old_offset);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_send_reply(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nproto_tree *rep_tree;\r\nguint32 num_names;\r\nguint32 i;\r\nrep_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_send_reply, NULL, "WREPL_REPL_SEND_REPLY");\r\nnum_names = tvb_get_ntohl(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_uint(rep_tree, hf_winsrepl_reply_num_names, winsrepl_tvb, winsrepl_offset, 4, num_names);\r\nwinsrepl_offset += 4;\r\nfor (i=0; i < num_names; i++) {\r\nwinsrepl_offset = dissect_winsrepl_wins_name(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, rep_tree,\r\nrep_tree, i);\r\n}\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_update(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nwinsrepl_offset = dissect_winsrepl_table_reply(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, winsrepl_tree);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_update2(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nwinsrepl_offset = dissect_winsrepl_table_reply(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, winsrepl_tree);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_inform(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nwinsrepl_offset = dissect_winsrepl_table_reply(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, winsrepl_tree);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_inform2(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_tree *winsrepl_tree)\r\n{\r\nwinsrepl_offset = dissect_winsrepl_table_reply(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, winsrepl_tree);\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_replication(tvbuff_t *winsrepl_tvb, packet_info *pinfo,\r\nint winsrepl_offset, proto_item *winsrepl_item, proto_tree *winsrepl_tree)\r\n{\r\nproto_item *repl_item;\r\nproto_tree *repl_tree;\r\nenum wrepl_replication_cmd command;\r\nrepl_tree = proto_tree_add_subtree(winsrepl_tree, winsrepl_tvb, winsrepl_offset, -1,\r\nett_winsrepl_replication, &repl_item, "WREPL_REPLICATION");\r\ncommand = (enum wrepl_replication_cmd)tvb_get_ntohl(winsrepl_tvb, winsrepl_offset);\r\nproto_tree_add_uint(repl_tree, hf_winsrepl_replication_command, winsrepl_tvb, winsrepl_offset, 4, command);\r\nwinsrepl_offset += 4;\r\nswitch (command) {\r\ncase WREPL_REPL_TABLE_QUERY:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_TABLE_QUERY");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_TABLE_QUERY");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_TABLE_QUERY");\r\nwinsrepl_offset = dissect_winsrepl_table_query(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_TABLE_REPLY:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_TABLE_REPLY");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_TABLE_REPLY");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_TABLE_REPLY");\r\nwinsrepl_offset = dissect_winsrepl_table_reply(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_SEND_REQUEST:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_SEND_REQUEST");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_SEND_REQUEST");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_SEND_REQUEST");\r\nwinsrepl_offset = dissect_winsrepl_send_request(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_SEND_REPLY:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_SEND_REPLY");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_SEND_REPLY");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_SEND_REPLY");\r\nwinsrepl_offset = dissect_winsrepl_send_reply(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_UPDATE:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_UPDATE");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_UPDATE");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_UPDATE");\r\nwinsrepl_offset = dissect_winsrepl_update(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_UPDATE2:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_UPDATE2");\r\nproto_item_append_text(winsrepl_item, ",WREPL_REPL_UPDATE2");\r\nproto_item_append_text(repl_item, ",WREPL_REPL_UPDATE2");\r\nwinsrepl_offset = dissect_winsrepl_update2(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_INFORM:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_INFORM");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_INFORM");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_INFORM");\r\nwinsrepl_offset = dissect_winsrepl_inform(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\ncase WREPL_REPL_INFORM2:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_REPL_INFORM2");\r\nproto_item_append_text(winsrepl_item, ", WREPL_REPL_INFORM2");\r\nproto_item_append_text(repl_item, ", WREPL_REPL_INFORM2");\r\nwinsrepl_offset = dissect_winsrepl_inform2(winsrepl_tvb, pinfo,\r\nwinsrepl_offset, repl_tree);\r\nbreak;\r\n}\r\nreturn winsrepl_offset;\r\n}\r\nstatic int\r\ndissect_winsrepl_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item *winsrepl_item;\r\nproto_tree *winsrepl_tree;\r\nenum wrepl_mess_type mess_type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WINS-Replication");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nwinsrepl_item = proto_tree_add_item(parent_tree, proto_winsrepl, tvb, offset, -1, ENC_NA);\r\nwinsrepl_tree = proto_item_add_subtree(winsrepl_item, ett_winsrepl);\r\nproto_tree_add_item(winsrepl_tree, hf_winsrepl_size, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(winsrepl_tree, hf_winsrepl_opcode, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(winsrepl_tree, hf_winsrepl_assoc_ctx, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nmess_type = (enum wrepl_mess_type)tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(winsrepl_tree, hf_winsrepl_mess_type, tvb, offset, 4, mess_type);\r\noffset += 4;\r\nswitch (mess_type) {\r\ncase WREPL_START_ASSOCIATION:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_START_ASSOCIATION");\r\nproto_item_append_text(winsrepl_item, ", WREPL_START_ASSOCIATION");\r\ndissect_winsrepl_start(tvb, pinfo,\r\noffset, winsrepl_tree);\r\nbreak;\r\ncase WREPL_START_ASSOCIATION_REPLY:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_START_ASSOCIATION_REPLY");\r\nproto_item_append_text(winsrepl_item, ", WREPL_START_ASSOCIATION_REPLY");\r\ndissect_winsrepl_start(tvb, pinfo,\r\noffset, winsrepl_tree);\r\nbreak;\r\ncase WREPL_STOP_ASSOCIATION:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WREPL_STOP_ASSOCIATION");\r\nproto_item_append_text(winsrepl_item, ", WREPL_STOP_ASSOCIATION");\r\ndissect_winsrepl_stop(tvb, pinfo,\r\noffset, winsrepl_tree);\r\nbreak;\r\ncase WREPL_REPLICATION:\r\ndissect_winsrepl_replication(tvb, pinfo,\r\noffset, winsrepl_item, winsrepl_tree);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_winsrepl_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint pdu_len;\r\npdu_len=tvb_get_ntohl(tvb, offset);\r\nreturn pdu_len+4;\r\n}\r\nstatic int\r\ndissect_winsrepl(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, parent_tree, winsrepl_reassemble, 4, get_winsrepl_pdu_len, dissect_winsrepl_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_winsrepl(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_winsrepl_size, {\r\n"Packet Size", "winsrepl.size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Packet Size", HFILL }},\r\n{ &hf_winsrepl_opcode, {\r\n"Opcode", "winsrepl.opcode",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"WINS Replication Opcode", HFILL }},\r\n{ &hf_winsrepl_assoc_ctx, {\r\n"Assoc_Ctx", "winsrepl.assoc_ctx",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"WINS Replication Assoc_Ctx", HFILL }},\r\n{ &hf_winsrepl_mess_type, {\r\n"Message_Type", "winsrepl.message_type",\r\nFT_UINT32, BASE_DEC, VALS(message_type_vals), 0x0,\r\n"WINS Replication Message_Type", HFILL }},\r\n{ &hf_winsrepl_start_minor_version, {\r\n"Minor Version", "winsrepl.minor_version",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Minor Version", HFILL }},\r\n{ &hf_winsrepl_start_major_version, {\r\n"Major Version", "winsrepl.major_version",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Major Version", HFILL }},\r\n{ &hf_winsrepl_stop_reason, {\r\n"Reason", "winsrepl.reason",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"WINS Replication Reason", HFILL }},\r\n{ &hf_winsrepl_replication_command, {\r\n"Replication Command", "winsrepl.repl_cmd",\r\nFT_UINT32, BASE_HEX, VALS(replication_cmd_vals), 0x0,\r\n"WINS Replication Command", HFILL }},\r\n{ &hf_winsrepl_owner_address, {\r\n"Owner Address", "winsrepl.owner_address",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"WINS Replication Owner Address", HFILL }},\r\n{ &hf_winsrepl_owner_max_version, {\r\n"Max Version", "winsrepl.max_version",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Max Version", HFILL }},\r\n{ &hf_winsrepl_owner_min_version, {\r\n"Min Version", "winsrepl.min_version",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Min Version", HFILL }},\r\n{ &hf_winsrepl_owner_type, {\r\n"Owner Type", "winsrepl.owner_type",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Owner Type", HFILL }},\r\n{ &hf_winsrepl_table_partner_count, {\r\n"Partner Count", "winsrepl.partner_count",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Partner Count", HFILL }},\r\n{ &hf_winsrepl_table_initiator, {\r\n"Initiator", "winsrepl.initiator",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"WINS Replication Initiator", HFILL }},\r\n{ &hf_winsrepl_ip_owner, {\r\n"IP Owner", "winsrepl.ip_owner",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"WINS Replication IP Owner", HFILL }},\r\n{ &hf_winsrepl_ip_ip, {\r\n"IP Address", "winsrepl.ip_address",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"WINS Replication IP Address", HFILL }},\r\n{ &hf_winsrepl_addr_list_num_ips, {\r\n"Num IPs", "winsrepl.num_ips",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Num IPs", HFILL }},\r\n{ &hf_winsrepl_name_len, {\r\n"Name Len", "winsrepl.name_len",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Name Len", HFILL }},\r\n{ &hf_winsrepl_name_flags, {\r\n"Name Flags", "winsrepl.name_flags",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"WINS Replication Name Flags", HFILL }},\r\n{ &hf_winsrepl_name_flags_rectype, {\r\n"Record Type", "winsrepl.name_flags.rectype",\r\nFT_UINT32, BASE_HEX, VALS(rectype_vals), 0x00000003,\r\n"WINS Replication Name Flags Record Type", HFILL }},\r\n{ &hf_winsrepl_name_flags_recstate, {\r\n"Record State", "winsrepl.name_flags.recstate",\r\nFT_UINT32, BASE_HEX, VALS(recstate_vals), 0x0000000C,\r\n"WINS Replication Name Flags Record State", HFILL }},\r\n{ &hf_winsrepl_name_flags_local, {\r\n"Local", "winsrepl.name_flags.local",\r\nFT_BOOLEAN, 32, NULL, 0x00000010,\r\n"WINS Replication Name Flags Local Flag", HFILL }},\r\n{ &hf_winsrepl_name_flags_hosttype, {\r\n"Host Type", "winsrepl.name_flags.hosttype",\r\nFT_UINT32, BASE_HEX, VALS(hosttype_vals), 0x00000060,\r\n"WINS Replication Name Flags Host Type", HFILL }},\r\n{ &hf_winsrepl_name_flags_static, {\r\n"Static", "winsrepl.name_flags.static",\r\nFT_BOOLEAN, 32, NULL, 0x00000080,\r\n"WINS Replication Name Flags Static Flag", HFILL }},\r\n{ &hf_winsrepl_name_group_flag, {\r\n"Name Group Flag", "winsrepl.name_group_flag",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"WINS Replication Name Group Flag", HFILL }},\r\n{ &hf_winsrepl_name_version_id, {\r\n"Name Version Id", "winsrepl.name_version_id",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Name Version Id", HFILL }},\r\n{ &hf_winsrepl_name_unknown, {\r\n"Unknown IP", "winsrepl.unknown",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"WINS Replication Unknown IP", HFILL }},\r\n{ &hf_winsrepl_reply_num_names, {\r\n"Num Names", "winsrepl.num_names",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"WINS Replication Num Names", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_winsrepl,\r\n&ett_winsrepl_start,\r\n&ett_winsrepl_stop,\r\n&ett_winsrepl_replication,\r\n&ett_winsrepl_owner,\r\n&ett_winsrepl_table_reply,\r\n&ett_winsrepl_ip,\r\n&ett_winsrepl_addr_list,\r\n&ett_winsrepl_name,\r\n&ett_winsrepl_send_reply,\r\n&ett_winsrepl_flags,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_winsrepl_name_len, { "winsrepl.name_len.invalid", PI_MALFORMED, PI_ERROR, "Bad name length", EXPFILL }},\r\n};\r\nmodule_t *winsrepl_module;\r\nexpert_module_t* expert_winsrepl;\r\nproto_winsrepl = proto_register_protocol("WINS (Windows Internet Name Service) Replication",\r\n"WINS-Replication", "winsrepl");\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_register_field_array(proto_winsrepl, hf, array_length(hf));\r\nexpert_winsrepl = expert_register_protocol(proto_winsrepl);\r\nexpert_register_field_array(expert_winsrepl, ei, array_length(ei));\r\nwinsrepl_module = prefs_register_protocol(proto_winsrepl, NULL);\r\nprefs_register_bool_preference(winsrepl_module, "reassemble",\r\n"Reassemble WINS-Replication messages spanning multiple TCP segments",\r\n"Whether the WINS-Replication dissector should reassemble messages spanning multiple TCP segments."\r\n" To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&winsrepl_reassemble);\r\n}\r\nvoid\r\nproto_reg_handoff_winsrepl(void)\r\n{\r\ndissector_handle_t winsrepl_handle;\r\nwinsrepl_handle = create_dissector_handle(dissect_winsrepl, proto_winsrepl);\r\ndissector_add_uint("tcp.port", glb_winsrepl_tcp_port, winsrepl_handle);\r\n}

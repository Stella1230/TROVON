static int\r\nrpcprogs_packet(void *dummy1 _U_, packet_info *pinfo, epan_dissect_t *edt _U_, const void *pri)\r\n{\r\nconst rpc_call_info_value *ri = (const rpc_call_info_value *)pri;\r\nnstime_t delta;\r\nrpc_program_t *rp = NULL;\r\nif (!prog_list) {\r\nrp = g_new(rpc_program_t, 1);\r\nrp->next = NULL;\r\nrp->program = ri->prog;\r\nrp->version = ri->vers;\r\nrp->num = 0;\r\nrp->min.secs = 0;\r\nrp->min.nsecs = 0;\r\nrp->max.secs = 0;\r\nrp->max.nsecs = 0;\r\nrp->tot.secs = 0;\r\nrp->tot.nsecs = 0;\r\nprog_list = rp;\r\n} else if ((ri->prog == prog_list->program)\r\n&& (ri->vers == prog_list->version)) {\r\nrp = prog_list;\r\n} else if ( (ri->prog < prog_list->program)\r\n|| ((ri->prog == prog_list->program) && (ri->vers < prog_list->version))) {\r\nrp = g_new(rpc_program_t, 1);\r\nrp->next = prog_list;\r\nrp->program = ri->prog;\r\nrp->version = ri->vers;\r\nrp->num = 0;\r\nrp->min.secs = 0;\r\nrp->min.nsecs = 0;\r\nrp->max.secs = 0;\r\nrp->max.nsecs = 0;\r\nrp->tot.secs = 0;\r\nrp->tot.nsecs = 0;\r\nprog_list = rp;\r\n} else {\r\nfor (rp=prog_list; rp; rp=rp->next) {\r\nif ((rp->next)\r\n&& (rp->next->program == ri->prog)\r\n&& (rp->next->version == ri->vers)) {\r\nrp = rp->next;\r\nbreak;\r\n}\r\nif ((!rp->next)\r\n|| (rp->next->program > ri->prog)\r\n|| ( (rp->next->program == ri->prog)\r\n&& (rp->next->version > ri->vers))) {\r\nrpc_program_t *trp;\r\ntrp = g_new(rpc_program_t, 1);\r\ntrp->next = rp->next;\r\ntrp->program = ri->prog;\r\ntrp->version = ri->vers;\r\ntrp->num = 0;\r\ntrp->min.secs = 0;\r\ntrp->min.nsecs = 0;\r\ntrp->max.secs = 0;\r\ntrp->max.nsecs = 0;\r\ntrp->tot.secs = 0;\r\ntrp->tot.nsecs = 0;\r\nrp->next = trp;\r\nrp = trp;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (ri->request || !rp) {\r\nreturn 0;\r\n}\r\nnstime_delta(&delta, &pinfo->abs_ts, &ri->req_time);\r\nif ((rp->max.secs == 0)\r\n&& (rp->max.nsecs == 0) ) {\r\nrp->max.secs = delta.secs;\r\nrp->max.nsecs = delta.nsecs;\r\n}\r\nif ((rp->min.secs == 0)\r\n&& (rp->min.nsecs == 0) ) {\r\nrp->min.secs = delta.secs;\r\nrp->min.nsecs = delta.nsecs;\r\n}\r\nif ( (delta.secs < rp->min.secs)\r\n|| ( (delta.secs == rp->min.secs)\r\n&& (delta.nsecs < rp->min.nsecs) ) ) {\r\nrp->min.secs = delta.secs;\r\nrp->min.nsecs = delta.nsecs;\r\n}\r\nif ( (delta.secs > rp->max.secs)\r\n|| ( (delta.secs == rp->max.secs)\r\n&& (delta.nsecs > rp->max.nsecs) ) ) {\r\nrp->max.secs = delta.secs;\r\nrp->max.nsecs = delta.nsecs;\r\n}\r\nrp->tot.secs += delta.secs;\r\nrp->tot.nsecs += delta.nsecs;\r\nif (rp->tot.nsecs > NANOSECS_PER_SEC) {\r\nrp->tot.nsecs -= NANOSECS_PER_SEC;\r\nrp->tot.secs++;\r\n}\r\nrp->num++;\r\nreturn 1;\r\n}\r\nstatic void\r\nrpcprogs_draw(void *dummy _U_)\r\n{\r\nguint64 td;\r\nrpc_program_t *rp;\r\nchar str[64];\r\nprintf("\n");\r\nprintf("==========================================================\n");\r\nprintf("ONC-RPC Program Statistics:\n");\r\nprintf("Program Version Calls Min SRT Max SRT Avg SRT\n");\r\nfor (rp = prog_list;rp;rp = rp->next) {\r\nif (rp->num == 0) {\r\ncontinue;\r\n}\r\ntd = ((guint64)(rp->tot.secs)) * NANOSECS_PER_SEC + rp->tot.nsecs;\r\ntd = ((td / rp->num) + 500) / 1000;\r\ng_snprintf(str, sizeof(str), "%s(%d)", rpc_prog_name(rp->program), rp->program);\r\nprintf("%-15s %2u %6d %3d.%06d %3d.%06d %3" G_GINT64_MODIFIER "u.%06" G_GINT64_MODIFIER "u\n",\r\nstr,\r\nrp->version,\r\nrp->num,\r\n(int)(rp->min.secs), (rp->min.nsecs+500)/1000,\r\n(int)(rp->max.secs), (rp->max.nsecs+500)/1000,\r\ntd/MICROSECS_PER_SEC, td%MICROSECS_PER_SEC\r\n);\r\n}\r\nprintf("===================================================================\n");\r\n}\r\nstatic void\r\nrpcprogs_init(const char *opt_arg _U_, void *userdata _U_)\r\n{\r\nGString *error_string;\r\nif (already_enabled) {\r\nreturn;\r\n}\r\nalready_enabled = 1;\r\nerror_string = register_tap_listener("rpc", NULL, NULL, 0, NULL, rpcprogs_packet, rpcprogs_draw);\r\nif (error_string) {\r\nfprintf(stderr, "tshark: Couldn't register rpc,programs tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_rpcprogs(void)\r\n{\r\nregister_stat_tap_ui(&rpcprogs_ui, NULL);\r\n}

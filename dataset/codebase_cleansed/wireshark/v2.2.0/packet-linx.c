static int\r\ndissect_linx(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint32 dword;\r\nint offset = 0;\r\nint nexthdr;\r\nint thishdr;\r\nint size;\r\nint pkgsize;\r\nint payloadsize;\r\nint version;\r\nint conntype;\r\nproto_tree *multicore_header_tree;\r\nproto_tree *main_header_tree;\r\nproto_tree *conn_header_tree;\r\nproto_tree *ack_header_tree;\r\nproto_tree *udata_header_tree;\r\nproto_tree *nack_header_tree;\r\nproto_tree *frag_header_tree;\r\nproto_tree *rlnh_header_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LINX");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *linx_tree = NULL;\r\nproto_item *ver_item, *msg_item;\r\nti = proto_tree_add_item(tree, proto_linx, tvb, 0, -1, ENC_NA);\r\nlinx_tree = proto_item_add_subtree(ti, ett_linx);\r\ndword = tvb_get_ntohl(tvb, offset);\r\nnexthdr = (dword >> 28) & 0xf;\r\nif (nexthdr == ETHCM_MAIN)\r\n{\r\nmulticore_header_tree = proto_tree_add_subtree(linx_tree, tvb, 0, 4, ett_linx_multicore, NULL, "Multicore Header");\r\nproto_tree_add_item(multicore_header_tree, hf_linx_nexthdr, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(multicore_header_tree, hf_linx_multicore_reserved, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(multicore_header_tree, hf_linx_multicore_dcoreid, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(multicore_header_tree, hf_linx_multicore_scoreid, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(multicore_header_tree, hf_linx_multicore_reserved1, tvb, 0, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndword = tvb_get_ntohl(tvb, offset);\r\n}\r\nversion = (dword >> 25) & 0x7;\r\nnexthdr = (dword >> 28) & 0xf;\r\npkgsize = dword & 0x3fff;\r\nmain_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, 4, ett_linx_main, NULL, "Main Header");\r\nproto_tree_add_item(main_header_tree, hf_linx_nexthdr , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nver_item = proto_tree_add_item(main_header_tree, hf_linx_main_version , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_header_tree, hf_linx_main_reserved , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_header_tree, hf_linx_main_connection, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_header_tree, hf_linx_main_bundle , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_header_tree, hf_linx_main_pkgsize , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (version < 2 || version > 3) {\r\nexpert_add_info(pinfo, ver_item, &ei_linx_version);\r\n}\r\nwhile (nexthdr != ETHCM_NONE) {\r\ndword = tvb_get_ntohl(tvb, offset);\r\nthishdr = nexthdr;\r\nnexthdr = (dword >>28) & 0xf;\r\nconntype = (dword >>24) & 0xf;\r\nif ((thishdr != ETHCM_NONE) && (thishdr != ETHCM_MAIN)) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s ", val_to_str_const(thishdr, linx_short_header_names, "unknown"));\r\nif(thishdr == ETHCM_CONN)\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s ", val_to_str_const(conntype, linx_conn_cmd, "unknown"));\r\n}\r\nswitch (thishdr) {\r\ncase ETHCM_CONN:\r\nsize = (dword >>21) & 0x7;\r\nconn_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, (4+2*size), ett_linx_main, NULL, "Connection Header");\r\nproto_tree_add_item(conn_header_tree, hf_linx_nexthdr , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_cmd , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_size , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_winsize , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_reserved, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_publcid , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (size == 6) {\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_dstmac, tvb, offset, 6, ENC_NA);\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_srcmac, tvb, offset + 6, 6, ENC_NA);\r\n}\r\noffset += (2*size);\r\nif(version > 2) {\r\nproto_tree_add_item(conn_header_tree, hf_linx_conn_feat_neg_str, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\noffset += tvb_strnlen(tvb, offset, -1);\r\n}\r\nbreak;\r\ncase ETHCM_NACK:\r\nnack_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, 4, ett_linx_main, NULL, "NACK Header");\r\nproto_tree_add_item(nack_header_tree, hf_linx_nexthdr , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nack_header_tree, hf_linx_nack_reserv1, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nack_header_tree, hf_linx_nack_count , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nack_header_tree, hf_linx_nack_reserv2, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(nack_header_tree, hf_linx_nack_seqno , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase ETHCM_UDATA:\r\nudata_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, 12, ett_linx_main, NULL, "Udata Header");\r\nproto_tree_add_item(udata_header_tree, hf_linx_nexthdr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_reserved , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_morefrags, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_fragno , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif(version == 2) {\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_signo , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_dstaddr16, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_srcaddr16, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ndword = tvb_get_ntohl(tvb, offset);\r\n} else {\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_dstaddr32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ndword = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nproto_tree_add_item(udata_header_tree, hf_linx_udata_srcaddr32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nif(dword == 0 && tvb_get_ntohl(tvb, offset) == 0) {\r\ndword = 0;\r\n} else {\r\ndword = 1;\r\n}\r\n}\r\noffset += 4;\r\nif (dword == 0) {\r\ndword = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "rlnh:%s ", val_to_str_const(dword, linx_short_rlnh_names, "unknown"));\r\nrlnh_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, 4, ett_linx_main, NULL, "RLNH");\r\nif(version == 1) {\r\nmsg_item = proto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_msg_type32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n} else {\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_msg_reserved, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nmsg_item = proto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_msg_type8, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nswitch (dword) {\r\ncase RLNH_LINK_ADDR:\r\nbreak;\r\ncase RLNH_QUERY_NAME:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_name, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\noffset += tvb_strnlen(tvb, offset, -1);\r\nbreak;\r\ncase RLNH_PUBLISH:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_name, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\noffset += tvb_strnlen(tvb, offset, -1);\r\nbreak;\r\ncase RLNH_UNPUBLISH:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase RLNH_UNPUBLISH_ACK:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase RLNH_INIT:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_version, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nrlnh_version = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nbreak;\r\ncase RLNH_INIT_REPLY:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_status, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif(rlnh_version > 1) {\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_feat_neg_str, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\noffset += tvb_strnlen(tvb, offset, -1);\r\n}\r\nbreak;\r\ncase RLNH_PUBLISH_PEER:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_rlnh_peer_linkaddr, tvb, offset, -1, ENC_BIG_ENDIAN);\r\noffset += tvb_strnlen(tvb, offset, -1);\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, msg_item, &ei_linx_rlnh_msg);\r\nbreak;\r\n}\r\n} else {\r\npayloadsize = pkgsize-offset;\r\nif (payloadsize) {\r\nproto_tree_add_item(linx_tree, hf_linx_udata_payload, tvb, offset, payloadsize, ENC_NA);\r\n}\r\n}\r\nbreak;\r\ncase ETHCM_ACK:\r\nack_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, 4, ett_linx_main, NULL, "Ack Header");\r\nproto_tree_add_item(ack_header_tree, hf_linx_nexthdr , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ack_header_tree, hf_linx_ack_request , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ack_header_tree, hf_linx_ack_reserved, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ack_header_tree, hf_linx_ack_ackno , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ack_header_tree, hf_linx_ack_seqno , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase ETHCM_FRAG:\r\nfrag_header_tree = proto_tree_add_subtree(linx_tree, tvb, offset, 4, ett_linx_main, NULL, "Fragmentation Header");\r\nproto_tree_add_item(frag_header_tree, hf_linx_nexthdr , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(frag_header_tree, hf_linx_frag_reserved , tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(frag_header_tree, hf_linx_frag_morefrags, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(frag_header_tree, hf_linx_frag_fragno , tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ndefault:\r\nproto_tree_add_expert_format(linx_tree, pinfo, &ei_linx_header, tvb, offset, 4, "ERROR: Header \"%u\" not recognized", thishdr);\r\nnexthdr = ETHCM_NONE;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_linx(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_linx_nexthdr,\r\n{ "Next Header", "linx.nexthdr", FT_UINT32, BASE_DEC, VALS(linx_long_header_names), 0xf0000000, NULL, HFILL },\r\n},\r\n{ &hf_linx_multicore_scoreid,\r\n{ "Source coreid", "linx.scoreid", FT_UINT32, BASE_DEC, VALS(linx_coreid), 0x0000ff00, "Multicore source core id", HFILL },\r\n},\r\n{ &hf_linx_multicore_dcoreid,\r\n{ "Destination coreid", "linx.dcoreid", FT_UINT32, BASE_DEC, VALS(linx_coreid), 0x00ff0000, "Multicore destination core id", HFILL},\r\n},\r\n{ &hf_linx_multicore_reserved,\r\n{ "Reserved", "linx.reserved8", FT_UINT32, BASE_DEC, NULL, 0x0f000000, "Multicore Hdr Reserved", HFILL},\r\n},\r\n{ &hf_linx_multicore_reserved1,\r\n{ "Reserved", "linx.reserved9", FT_UINT32, BASE_DEC, NULL, 0x000000ff, "Multicore Hdr Reserved", HFILL},\r\n},\r\n{ &hf_linx_main_version,\r\n{ "Version", "linx.version", FT_UINT32, BASE_DEC, NULL, 0x0e000000, "LINX Version", HFILL },\r\n},\r\n{ &hf_linx_main_reserved,\r\n{ "Reserved", "linx.reserved1", FT_UINT32, BASE_DEC, NULL, 0x01800000, "Main Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_main_connection,\r\n{ "Connection", "linx.connection", FT_UINT32, BASE_DEC, NULL, 0x007f8000, NULL, HFILL },\r\n},\r\n{ &hf_linx_main_bundle,\r\n{ "Bundle", "linx.bundle", FT_UINT32, BASE_DEC, VALS(linx_boolean), 0x00004000, NULL, HFILL },\r\n},\r\n{ &hf_linx_main_pkgsize,\r\n{ "Package Size", "linx.pcksize", FT_UINT32, BASE_DEC, NULL, 0x00003fff, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_reserved,\r\n{ "Reserved", "linx.reserved5", FT_UINT32, BASE_DEC, NULL, 0x0fff0000, "Udata Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_udata_morefrags,\r\n{ "More Fragments", "linx.morefra", FT_UINT32, BASE_DEC, VALS(linx_boolean), 0x00008000, "More fragments follow", HFILL },\r\n},\r\n{ &hf_linx_udata_fragno,\r\n{ "Fragment Number", "linx.fragno", FT_UINT32, BASE_DEC, VALS(linx_nofragment), 0x00007fff, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_signo,\r\n{ "Signal Number", "linx.signo", FT_UINT32, BASE_DEC, NULL, 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_dstaddr16,\r\n{ "Receiver Address", "linx.dstaddr", FT_UINT32, BASE_DEC, NULL, 0xffff0000, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_dstaddr32,\r\n{ "Receiver Address", "linx.dstaddr32", FT_UINT32, BASE_DEC, NULL, 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_srcaddr16,\r\n{ "Sender Address", "linx.srcaddr", FT_UINT32, BASE_DEC, NULL, 0x0000ffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_srcaddr32,\r\n{ "Sender Address", "linx.srcaddr32", FT_UINT32, BASE_DEC, NULL, 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_udata_payload,\r\n{ "Payload", "linx.payload", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_linx_ack_request,\r\n{ "ACK-request", "linx.ackreq", FT_UINT32, BASE_DEC, VALS(linx_boolean), 0x08000000, NULL, HFILL },\r\n},\r\n{ &hf_linx_ack_reserved,\r\n{ "Reserved", "linx.reserved7", FT_UINT32, BASE_DEC, NULL, 0x07000000, "ACK Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_ack_ackno,\r\n{ "ACK Number", "linx.ackno", FT_UINT32, BASE_DEC, NULL, 0x00fff000, NULL, HFILL },\r\n},\r\n{ &hf_linx_ack_seqno,\r\n{ "Sequence Number", "linx.seqno", FT_UINT32, BASE_DEC, NULL, 0x00000fff, NULL, HFILL },\r\n},\r\n{ &hf_linx_conn_cmd,\r\n{ "Command", "linx.cmd", FT_UINT32, BASE_DEC, VALS(linx_conn_cmd), 0x0f000000, NULL, HFILL },\r\n},\r\n{ &hf_linx_conn_size,\r\n{ "Size", "linx.size", FT_UINT32, BASE_DEC, NULL, 0x00e00000, NULL, HFILL },\r\n},\r\n{ &hf_linx_conn_winsize,\r\n{ "WinSize", "linx.winsize", FT_UINT32, BASE_DEC, NULL, 0x001e0000, "Window Size", HFILL },\r\n},\r\n{ &hf_linx_conn_reserved,\r\n{ "Reserved", "linx.reserved3", FT_UINT32, BASE_DEC, NULL, 0x0001ff00, "Conn Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_conn_publcid,\r\n{ "Publish Conn ID", "linx.publcid", FT_UINT32, BASE_DEC, NULL, 0x000000ff, NULL, HFILL },\r\n},\r\n{ &hf_linx_conn_srcmac,\r\n{ "Source", "linx.srcmaddr_ether", FT_ETHER, BASE_NONE, NULL, 0x0, "Source Media Address (ethernet)", HFILL },\r\n},\r\n{ &hf_linx_conn_dstmac,\r\n{ "Destination", "linx.destmaddr_ether", FT_ETHER, BASE_NONE, NULL, 0x0, "Destination Media Address (ethernet)", HFILL },\r\n},\r\n{ &hf_linx_conn_feat_neg_str,\r\n{ "Feature Negotiation String", "linx.feat_neg_str", FT_STRINGZ, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_linx_frag_reserved,\r\n{ "Reserved", "linx.reserved6", FT_UINT32, BASE_DEC, NULL, 0x0fff0000, "Frag Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_frag_morefrags,\r\n{ "More Fragments", "linx.morefr2", FT_UINT32, BASE_DEC, VALS(linx_boolean), 0x00008000, NULL, HFILL },\r\n},\r\n{ &hf_linx_frag_fragno,\r\n{ "Fragment Number", "linx.fragno2", FT_UINT32, BASE_DEC, NULL, 0x00007fff, NULL, HFILL },\r\n},\r\n{ &hf_linx_nack_reserv1,\r\n{ "Reserved", "linx.nack_reserv", FT_UINT32, BASE_DEC, NULL, 0x0f000000, "Nack Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_nack_count,\r\n{ "Count", "linx.nack_count", FT_UINT32, BASE_DEC, NULL, 0x00ff0000, NULL, HFILL },\r\n},\r\n{ &hf_linx_nack_reserv2,\r\n{ "Reserved", "linx.nack_reserv", FT_UINT32, BASE_DEC, NULL, 0x0000f000, "Nack Hdr Reserved", HFILL },\r\n},\r\n{ &hf_linx_nack_seqno,\r\n{ "Sequence Number", "linx.nack_seqno", FT_UINT32, BASE_DEC, NULL, 0x00000fff, NULL, HFILL },\r\n},\r\n{ &hf_linx_rlnh_msg_type32,\r\n{ "RLNH msg type", "linx.rlnh_msg_type", FT_UINT32, BASE_DEC, VALS(linx_long_rlnh_names), 0xffffffff, "RLNH message type", HFILL },\r\n},\r\n{ &hf_linx_rlnh_msg_type8,\r\n{ "RLNH msg type", "linx.rlnh_msg_type8", FT_UINT32, BASE_DEC, VALS(linx_long_rlnh_names), 0x000000ff, "RLNH message type", HFILL },\r\n},\r\n{ &hf_linx_rlnh_msg_reserved,\r\n{ "RLNH msg reserved", "linx.rlnh_msg_reserved", FT_UINT32, BASE_DEC, NULL, 0xffffff00, "RLNH message reserved", HFILL },\r\n},\r\n#if 0\r\n{ &hf_linx_rlnh_linkaddr,\r\n{ "RLNH linkaddr", "linx.rlnh_linkaddr", FT_UINT32, BASE_DEC, NULL, 0xffffffff, "RLNH linkaddress", HFILL },\r\n},\r\n#endif\r\n{ &hf_linx_rlnh_src_linkaddr,\r\n{ "RLNH src linkaddr", "linx.rlnh_src_linkaddr", FT_UINT32, BASE_DEC, NULL, 0xffffffff, "RLNH source linkaddress", HFILL },\r\n},\r\n{ &hf_linx_rlnh_peer_linkaddr,\r\n{ "RLNH peer linkaddr", "linx.rlnh_peer_linkaddr", FT_UINT32, BASE_DEC, NULL, 0xffffffff, "RLNH peer linkaddress", HFILL },\r\n},\r\n{ &hf_linx_rlnh_version,\r\n{ "RLNH version", "linx.rlnh_version", FT_UINT32, BASE_DEC, NULL, 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_rlnh_status,\r\n{ "RLNH reply", "linx.rlnh_status", FT_UINT32, BASE_DEC, VALS(linx_rlnh_reply), 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_rlnh_name,\r\n{ "RLNH name", "linx.rlnh_name", FT_STRINGZ, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_linx_rlnh_feat_neg_str,\r\n{ "RLNH Feature Negotiation String", "linx.rlnh_feat_neg_str", FT_STRINGZ, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_linx,\r\n&ett_linx_multicore,\r\n&ett_linx_main,\r\n&ett_linx_error,\r\n&ett_linx_udata,\r\n&ett_linx_ack\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_linx_version, { "linx.version.unknown", PI_PROTOCOL, PI_WARN, "Version not yet supported and might be dissected incorrectly!", EXPFILL }},\r\n{ &ei_linx_rlnh_msg, { "linx.rlnh_msg.unknown", PI_PROTOCOL, PI_WARN, "Message type not recognized", EXPFILL }},\r\n{ &ei_linx_header, { "linx.header_not_recognized", PI_PROTOCOL, PI_WARN, "Header not recognized", EXPFILL }},\r\n};\r\nexpert_module_t* expert_linx;\r\nproto_linx = proto_register_protocol (\r\n"ENEA LINX",\r\n"LINX",\r\n"linx"\r\n);\r\nproto_register_field_array(proto_linx, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_linx = expert_register_protocol(proto_linx);\r\nexpert_register_field_array(expert_linx, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_linx(void)\r\n{\r\ndissector_handle_t linx_handle;\r\nlinx_handle = create_dissector_handle(dissect_linx, proto_linx);\r\ndissector_add_uint("ethertype", ETHERTYPE_LINX, linx_handle);\r\n}\r\nstatic int\r\ndissect_linx_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint32 dword;\r\nint offset = 0;\r\nproto_item *ti, *ver_item, *msg_item;\r\nproto_tree *linx_tcp_tree;\r\nproto_tree *tcp_header_tree;\r\nproto_tree *rlnh_header_tree;\r\nint payloadsize;\r\nint version;\r\nint size;\r\nint type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LINX/TCP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ndword = tvb_get_ntohl(tvb, 0);\r\nversion = (dword >> 16) & 0xFF;\r\ntype = (dword >> 24) & 0xFF;\r\nsize = 16;\r\nif (type == 0x55) {\r\ndword = tvb_get_ntohl(tvb, 12);\r\nsize += (dword & 0xFFFFFFFF);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "tcpcm:%s ", val_to_str_const(type, linx_short_tcp_names, "unknown"));\r\nti = proto_tree_add_item(tree, proto_linx_tcp, tvb, 0, -1, ENC_NA);\r\nlinx_tcp_tree = proto_item_add_subtree(ti, ett_linx_tcp);\r\ntcp_header_tree = proto_tree_add_subtree(linx_tcp_tree, tvb, 0, 16, ett_linx_tcp, NULL, "TCP CM Header");\r\nproto_tree_add_item(tcp_header_tree, hf_linx_tcp_type, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nver_item = proto_tree_add_item(tcp_header_tree, hf_linx_tcp_version, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tcp_header_tree, hf_linx_tcp_oob, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tcp_header_tree, hf_linx_tcp_src, tvb, 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tcp_header_tree, hf_linx_tcp_dst, tvb, 8, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tcp_header_tree, hf_linx_tcp_size, tvb, 12, 4, ENC_BIG_ENDIAN);\r\nif (version != 3) {\r\nexpert_add_info(pinfo, ver_item, &ei_linx_tcp_version);\r\n}\r\noffset += 16;\r\nif (type == 0x55) {\r\ndword = tvb_get_ntohl(tvb, 8);\r\nif (dword == 0) {\r\ndword = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "rlnh:%s ", val_to_str_const(dword, linx_short_rlnh_names, "unknown"));\r\nrlnh_header_tree = proto_tree_add_subtree(linx_tcp_tree, tvb, offset, 4, ett_linx_tcp, NULL, "RLNH");\r\nif(version == 1) {\r\nmsg_item = proto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_msg_type32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n} else {\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_msg_reserved, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nmsg_item = proto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_msg_type8, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nswitch (dword) {\r\ncase RLNH_LINK_ADDR:\r\nbreak;\r\ncase RLNH_QUERY_NAME:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_name, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase RLNH_PUBLISH:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_name, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase RLNH_UNPUBLISH:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase RLNH_UNPUBLISH_ACK:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase RLNH_INIT:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_version, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nrlnh_version = tvb_get_ntohl(tvb, offset);\r\nbreak;\r\ncase RLNH_INIT_REPLY:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_status, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif(rlnh_version > 1) {\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_feat_neg_str, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ncase RLNH_PUBLISH_PEER:\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_src_linkaddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(rlnh_header_tree, hf_linx_tcp_rlnh_peer_linkaddr, tvb, offset, -1, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, msg_item, &ei_linx_tcp_rlnh_msg);\r\nbreak;\r\n}\r\n} else {\r\npayloadsize = size-offset;\r\nif (payloadsize) {\r\nproto_tree_add_item(linx_tcp_tree, hf_linx_tcp_payload, tvb, offset, payloadsize, ENC_NA);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_linx_tcp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n#if 0\r\n{ &hf_linx_tcp_reserved,\r\n{ "Reserved", "linxtcp.reserved", FT_UINT32, BASE_DEC, NULL, 0x00007FFF, "TCP CM reserved", HFILL },\r\n},\r\n#endif\r\n{ &hf_linx_tcp_oob,\r\n{ "Out-of-band", "linxtcp.oob", FT_UINT32, BASE_DEC, NULL, 0x00008000, "TCP CM oob", HFILL },\r\n},\r\n{ &hf_linx_tcp_version,\r\n{ "Version", "linxtcp.version", FT_UINT32, BASE_DEC, NULL, 0x00FF0000, "TCP CM version", HFILL },\r\n},\r\n{ &hf_linx_tcp_type,\r\n{ "Type", "linxtcp.type", FT_UINT32, BASE_HEX, VALS(linx_long_tcp_names), 0xFF000000, "TCP CM type", HFILL },\r\n},\r\n{ &hf_linx_tcp_src,\r\n{ "Source", "linxtcp.src", FT_UINT32, BASE_DEC, NULL, 0xFFFFFFFF, "TCP CM source", HFILL },\r\n},\r\n{ &hf_linx_tcp_dst,\r\n{ "Destination", "linxtcp.dst", FT_UINT32, BASE_DEC, NULL, 0xFFFFFFFF, "TCP CM destination", HFILL },\r\n},\r\n{ &hf_linx_tcp_size,\r\n{ "Size", "linxtcp.size", FT_UINT32, BASE_DEC, NULL, 0xFFFFFFFF, "TCP CM size", HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_msg_type32,\r\n{ "RLNH msg type", "linxtcp.rlnh_msg_type", FT_UINT32, BASE_DEC, VALS(linx_long_rlnh_names), 0xffffffff, "RLNH message type", HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_msg_type8,\r\n{ "RLNH msg type", "linxtcp.rlnh_msg_type8", FT_UINT32, BASE_DEC, VALS(linx_long_rlnh_names), 0x000000ff, "RLNH message type", HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_msg_reserved,\r\n{ "RLNH msg reserved", "linxtcp.rlnh_msg_reserved", FT_UINT32, BASE_DEC, NULL, 0xffffff00, "RLNH message reserved", HFILL },\r\n},\r\n#if 0\r\n{ &hf_linx_tcp_rlnh_linkaddr,\r\n{ "RLNH linkaddr", "linxtcp.rlnh_linkaddr", FT_UINT32, BASE_DEC, NULL, 0xffffffff, "RLNH linkaddress", HFILL },\r\n},\r\n#endif\r\n{ &hf_linx_tcp_rlnh_src_linkaddr,\r\n{ "RLNH src linkaddr", "linxtcp.rlnh_src_linkaddr", FT_UINT32, BASE_DEC, NULL, 0xffffffff, "RLNH source linkaddress", HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_peer_linkaddr,\r\n{ "RLNH peer linkaddr", "linxtcp.rlnh_peer_linkaddr", FT_UINT32,\r\nBASE_DEC, NULL, 0xffffffff, "RLNH peer linkaddress", HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_version,\r\n{ "RLNH version", "linxtcp.rlnh_version", FT_UINT32, BASE_DEC, NULL, 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_status,\r\n{ "RLNH reply", "linxtcp.rlnh_status", FT_UINT32, BASE_DEC, VALS(linx_rlnh_reply), 0xffffffff, NULL, HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_name,\r\n{ "RLNH name", "linxtcp.rlnh_name", FT_STRINGZ, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_linx_tcp_rlnh_feat_neg_str,\r\n{ "RLNH Feature Negotiation String", "linxtcp.rlnh_feat_neg_str", FT_STRINGZ, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_linx_tcp_payload,\r\n{ "Payload", "linxtcp.payload", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL },\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_linx_tcp,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_linx_tcp_version, { "linxtcp.version.unknown", PI_PROTOCOL, PI_WARN, "Version not yet supported and might be dissected incorrectly!", EXPFILL }},\r\n{ &ei_linx_tcp_rlnh_msg, { "linxtcp.rlnh_msg.unknown", PI_PROTOCOL, PI_WARN, "Message type not recognized", EXPFILL }},\r\n};\r\nexpert_module_t* expert_linx_tcp;\r\nmodule_t *linx_tcp_module;\r\nproto_linx_tcp = proto_register_protocol("ENEA LINX over TCP", "LINX/TCP", "linxtcp");\r\nproto_register_field_array(proto_linx_tcp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_linx_tcp = expert_register_protocol(proto_linx_tcp);\r\nexpert_register_field_array(expert_linx_tcp, ei, array_length(ei));\r\nlinx_tcp_module = prefs_register_protocol(proto_linx_tcp, proto_reg_handoff_linx_tcp);\r\nprefs_register_uint_preference(linx_tcp_module, "tcp.port",\r\n"ENEA LINX over TCP Port",\r\n"TCP port used by ENEA LINX, usually 19790",\r\n10, &linx_tcp_port);\r\n}\r\nvoid\r\nproto_reg_handoff_linx_tcp(void)\r\n{\r\nstatic dissector_handle_t linx_tcp_handle;\r\nstatic gboolean linx_tcp_prefs_initialized = FALSE;\r\nstatic guint saved_linx_tcp_port;\r\nif (!linx_tcp_prefs_initialized) {\r\nlinx_tcp_handle = create_dissector_handle(dissect_linx_tcp, proto_linx_tcp);\r\ndissector_add_uint("tcp.port", linx_tcp_port, linx_tcp_handle);\r\nlinx_tcp_prefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("tcp.port", saved_linx_tcp_port, linx_tcp_handle);\r\n}\r\nsaved_linx_tcp_port = linx_tcp_port;\r\nif (linx_tcp_port != 0) {\r\ndissector_add_uint("udp.port", linx_tcp_port, linx_tcp_handle);\r\n}\r\n}

static gboolean\r\ncapture_ap1394(const guchar *pd, int offset, int len, capture_packet_info_t *cpinfo, const union wtap_pseudo_header *pseudo_header)\r\n{\r\nguint16 etype;\r\nif (!BYTES_ARE_IN_FRAME(offset, len, 18)) {\r\nreturn FALSE;\r\n}\r\noffset += 16;\r\netype = pntoh16(&pd[offset]);\r\noffset += 2;\r\nreturn try_capture_dissector("ethertype", etype, pd, offset, len, cpinfo, pseudo_header);\r\n}\r\nstatic int\r\ndissect_ap1394(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *fh_tree = NULL;\r\nguint16 etype;\r\ntvbuff_t *next_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "IP/IEEE1394");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nset_address_tvb(&pinfo->dl_src, AT_EUI64, 8, tvb, 8);\r\ncopy_address_shallow(&pinfo->src, &pinfo->dl_src);\r\nset_address_tvb(&pinfo->dl_dst, AT_EUI64, 8, tvb, 0);\r\ncopy_address_shallow(&pinfo->dst, &pinfo->dl_dst);\r\nif (tree) {\r\nti = proto_tree_add_protocol_format(tree, proto_ap1394, tvb, 0, 18,\r\n"Apple IP-over-IEEE 1394, Src: %s, Dst: %s",\r\naddress_to_str(wmem_packet_scope(), &pinfo->src), address_to_str(wmem_packet_scope(), &pinfo->dst));\r\nfh_tree = proto_item_add_subtree(ti, ett_ap1394);\r\nproto_tree_add_item(fh_tree, hf_ap1394_dst, tvb, 0, 8, ENC_NA);\r\nproto_tree_add_item(fh_tree, hf_ap1394_src, tvb, 8, 8, ENC_NA);\r\n}\r\netype = tvb_get_ntohs(tvb, 16);\r\nproto_tree_add_uint(fh_tree, hf_ap1394_type, tvb, 16, 2, etype);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 18);\r\nif (!dissector_try_uint(ethertype_subdissector_table, etype, next_tvb,\r\npinfo, tree))\r\n{\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ap1394(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ap1394_dst,\r\n{ "Destination", "ap1394.dst", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, "Destination address", HFILL }},\r\n{ &hf_ap1394_src,\r\n{ "Source", "ap1394.src", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, "Source address", HFILL }},\r\n{ &hf_ap1394_type,\r\n{ "Type", "ap1394.type", FT_UINT16, BASE_HEX,\r\nVALS(etype_vals), 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ap1394,\r\n};\r\nproto_ap1394 = proto_register_protocol("Apple IP-over-IEEE 1394", "IP/IEEE1394", "ap1394");\r\nproto_register_field_array(proto_ap1394, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_ap1394(void)\r\n{\r\ndissector_handle_t ap1394_handle;\r\nethertype_subdissector_table = find_dissector_table("ethertype");\r\nap1394_handle = create_dissector_handle(dissect_ap1394, proto_ap1394);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_APPLE_IP_OVER_IEEE1394, ap1394_handle);\r\nregister_capture_dissector("wtap_encap", WTAP_ENCAP_APPLE_IP_OVER_IEEE1394, capture_ap1394, proto_ap1394);\r\n}

void\r\nfind_frame_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nGtkWidget *main_vb, *main_find_hb, *main_options_hb,\r\n*find_type_frame, *find_type_vb,\r\n*find_type_hb, *find_type_lb, *hex_rb, *string_rb, *filter_rb,\r\n*filter_hb, *filter_bt,\r\n*direction_frame, *direction_vb,\r\n*up_rb, *down_rb,\r\n*data_frame, *data_vb,\r\n*packet_data_rb, *decode_data_rb, *summary_data_rb,\r\n*string_opt_frame, *string_opt_vb,\r\n*case_cb, *combo_lb, *combo_cb,\r\n*bbox, *ok_bt, *cancel_bt, *help_bt;\r\nstatic construct_args_t args = {\r\n"Wireshark: Search Filter",\r\nFALSE,\r\nTRUE,\r\nFALSE\r\n};\r\nif (find_frame_w != NULL) {\r\nreactivate_window(find_frame_w);\r\nreturn;\r\n}\r\nfind_frame_w = dlg_window_new("Wireshark: Find Packet");\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(find_frame_w), main_vb);\r\ngtk_widget_show(main_vb);\r\nmain_find_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (main_vb), main_find_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(main_find_hb);\r\nfind_type_frame = gtk_frame_new("Find");\r\ngtk_box_pack_start(GTK_BOX(main_find_hb), find_type_frame, TRUE, TRUE, 0);\r\ngtk_widget_show(find_type_frame);\r\nfind_type_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(find_type_vb), 3);\r\ngtk_container_add(GTK_CONTAINER(find_type_frame), find_type_vb);\r\ngtk_widget_show(find_type_vb);\r\nfind_type_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (find_type_vb), find_type_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(find_type_hb);\r\nfind_type_lb = gtk_label_new("By:");\r\ngtk_box_pack_start(GTK_BOX(find_type_hb), find_type_lb, FALSE, FALSE, 0);\r\ngtk_widget_show(find_type_lb);\r\nfilter_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "_Display filter");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(filter_rb), !cfile.hex && !cfile.string);\r\ngtk_box_pack_start(GTK_BOX(find_type_hb), filter_rb, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(filter_rb, "Search for data by display filter syntax.\ne.g. ip.addr==10.1.1.1");\r\ngtk_widget_show(filter_rb);\r\nhex_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(filter_rb), "_Hex value");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(hex_rb), cfile.hex);\r\ngtk_box_pack_start(GTK_BOX(find_type_hb), hex_rb, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(hex_rb, "Search for data by hex string.\ne.g. fffffda5");\r\ngtk_widget_show(hex_rb);\r\nstring_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(filter_rb), "_String");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(string_rb), cfile.string);\r\ngtk_box_pack_start(GTK_BOX(find_type_hb), string_rb, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(string_rb, "Search for data by string value.\ne.g. My String");\r\ngtk_widget_show(string_rb);\r\nfilter_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX(find_type_vb), filter_hb, FALSE, FALSE, 0);\r\ngtk_widget_show(filter_hb);\r\nfilter_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked", G_CALLBACK(display_filter_construct_cb), &args);\r\ng_signal_connect(filter_bt, "destroy", G_CALLBACK(filter_button_destroy_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_BUTTON_KEY, filter_bt);\r\ngtk_box_pack_start(GTK_BOX(filter_hb), filter_bt, FALSE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(filter_bt, "Click on the filter button to select a display filter,\nor enter your search criteria into the text box");\r\ngtk_widget_show(filter_bt);\r\nfilter_text_box = gtk_entry_new();\r\nif (cfile.sfilter) gtk_entry_set_text(GTK_ENTRY(filter_text_box), cfile.sfilter);\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, filter_text_box);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FILT_TE_PTR_KEY, filter_text_box);\r\ngtk_box_pack_start(GTK_BOX(filter_hb), filter_text_box, TRUE, TRUE, 0);\r\ng_signal_connect(filter_text_box, "changed", G_CALLBACK(find_filter_te_syntax_check_cb), find_frame_w);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\nte_presskey_handler_id = g_signal_connect(filter_text_box, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\nwin_presskey_handler_id = g_signal_connect(find_frame_w, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ngtk_widget_show(filter_text_box);\r\nmain_options_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (main_vb), main_options_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(main_options_hb);\r\ndata_frame = gtk_frame_new("Search In");\r\ngtk_box_pack_start(GTK_BOX(main_options_hb), data_frame, TRUE, TRUE, 0);\r\ngtk_widget_show(data_frame);\r\ndata_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(data_vb), 3);\r\ngtk_container_add(GTK_CONTAINER(data_frame), data_vb);\r\ngtk_widget_show(data_vb);\r\nsummary_data_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "Packet list");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(summary_data_rb), summary_data);\r\ngtk_box_pack_start(GTK_BOX(data_vb), summary_data_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(summary_data_rb, "Search for string in the Info column of the packet summary (summary pane)");\r\ngtk_widget_show(summary_data_rb);\r\ndecode_data_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(summary_data_rb), "Packet details");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(decode_data_rb), decode_data);\r\ngtk_box_pack_start(GTK_BOX(data_vb), decode_data_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(decode_data_rb, "Search for string among the decoded packet display labels (tree view pane)");\r\ngtk_widget_show(decode_data_rb);\r\npacket_data_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(summary_data_rb), "Packet bytes");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(packet_data_rb), packet_data);\r\ngtk_box_pack_start(GTK_BOX(data_vb), packet_data_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(packet_data_rb, "Search for string in the ASCII-converted packet data (hex view pane)");\r\ngtk_widget_show(packet_data_rb);\r\nstring_opt_frame = gtk_frame_new("String Options");\r\ngtk_box_pack_start(GTK_BOX(main_options_hb), string_opt_frame, TRUE, TRUE, 0);\r\ngtk_widget_show(string_opt_frame);\r\nstring_opt_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(string_opt_frame), string_opt_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(string_opt_vb), 3);\r\ngtk_widget_show(string_opt_vb);\r\ncase_cb = gtk_check_button_new_with_mnemonic("Case sensitive");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(case_cb), !case_type);\r\ngtk_box_pack_start(GTK_BOX (string_opt_vb), case_cb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(case_cb, "Search by mixed upper/lower case?");\r\ngtk_widget_show(case_cb);\r\ncombo_lb = gtk_label_new("Character width:");\r\ngtk_box_pack_start(GTK_BOX (string_opt_vb), combo_lb, TRUE, TRUE, 0);\r\ngtk_misc_set_alignment(GTK_MISC(combo_lb), 0.0f, 0.5f);\r\ngtk_widget_show(combo_lb);\r\ncombo_cb = gtk_combo_box_text_new();\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(combo_cb), "Narrow & wide");\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(combo_cb), "Narrow (UTF-8 / ASCII)");\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(combo_cb), "Wide (UTF-16)");\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(combo_cb),0);\r\ngtk_box_pack_start(GTK_BOX (string_opt_vb), combo_cb, TRUE, TRUE, 0);\r\ngtk_widget_show(combo_cb);\r\ndirection_frame = gtk_frame_new("Direction");\r\ngtk_box_pack_start(GTK_BOX(main_options_hb), direction_frame, FALSE, FALSE, 0);\r\ngtk_widget_show(direction_frame);\r\ndirection_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(direction_vb), 3);\r\ngtk_container_add(GTK_CONTAINER(direction_frame), direction_vb);\r\ngtk_widget_show(direction_vb);\r\nup_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "_Up");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(up_rb), cfile.dir == SD_BACKWARD);\r\ngtk_box_pack_start(GTK_BOX(direction_vb), up_rb, FALSE, FALSE, 0);\r\ngtk_widget_show(up_rb);\r\ndown_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(up_rb), "_Down");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(down_rb), cfile.dir == SD_FORWARD);\r\ngtk_box_pack_start(GTK_BOX(direction_vb), down_rb, FALSE, FALSE, 0);\r\ngtk_widget_show(down_rb);\r\nbbox = dlg_button_row_new(GTK_STOCK_FIND, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_FIND);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(find_frame_ok_cb), find_frame_w);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(find_frame_close_cb), find_frame_w);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_FIND_DIALOG);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_FILT_KEY, filter_text_box);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_BACKWARD_KEY, up_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_FILTERDATA_KEY, filter_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_HEXDATA_KEY, hex_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_STRINGDATA_KEY, string_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_STRINGTYPE_LABEL_KEY, combo_lb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FIND_STRINGTYPE_KEY, combo_cb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_CASE_SEARCH_KEY, case_cb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_SOURCE_DATA_KEY, packet_data_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_SOURCE_DECODE_KEY, decode_data_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_SOURCE_SUMMARY_KEY, summary_data_rb);\r\ng_object_set_data(G_OBJECT(find_frame_w), E_FILT_TE_BUTTON_KEY, filter_bt);\r\ng_signal_connect(hex_rb, "clicked", G_CALLBACK(hex_selected_cb), find_frame_w);\r\ng_signal_connect(string_rb, "clicked", G_CALLBACK(string_selected_cb), find_frame_w);\r\ng_signal_connect(filter_rb, "clicked", G_CALLBACK(filter_selected_cb), find_frame_w);\r\nstring_selected_cb(NULL, find_frame_w);\r\nfilter_selected_cb(NULL, find_frame_w);\r\nwindow_set_cancel_button(find_frame_w, cancel_bt, window_cancel_button_cb);\r\ngtk_widget_grab_default(ok_bt);\r\ndlg_set_activate(filter_text_box, ok_bt);\r\ngtk_widget_grab_focus(filter_text_box);\r\ng_signal_connect(find_frame_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(find_frame_w, "destroy", G_CALLBACK(find_frame_destroy_cb), NULL);\r\ngtk_widget_show(find_frame_w);\r\nwindow_present(find_frame_w);\r\n}\r\nvoid\r\nfind_frame_with_filter(char *filter)\r\n{\r\nfind_frame_cb(NULL, NULL);\r\ngtk_entry_set_text(GTK_ENTRY(filter_text_box), filter);\r\n}\r\nstatic void\r\nfind_filter_te_syntax_check_cb(GtkWidget *w, gpointer parent_w)\r\n{\r\nconst gchar *strval;\r\nGtkWidget *hex_rb, *string_rb;\r\nguint8 *bytes = NULL;\r\nsize_t nbytes;\r\nhex_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_HEXDATA_KEY);\r\nstring_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_STRINGDATA_KEY);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON (hex_rb))) {\r\nstrval = gtk_entry_get_text(GTK_ENTRY(w));\r\nif (strval == NULL) {\r\ncolorize_filter_te_as_invalid(w);\r\n} else {\r\nbytes = convert_string_to_hex(strval, &nbytes);\r\nif (bytes == NULL)\r\ncolorize_filter_te_as_invalid(w);\r\nelse {\r\ng_free(bytes);\r\ncolorize_filter_te_as_valid(w);\r\n}\r\n}\r\n} else if (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON (string_rb))) {\r\nstrval = gtk_entry_get_text(GTK_ENTRY(w));\r\nif (strval == NULL) {\r\ncolorize_filter_te_as_invalid(w);\r\n} else {\r\nif (strcmp(strval, "") == 0)\r\ncolorize_filter_te_as_invalid(w);\r\nelse\r\ncolorize_filter_te_as_valid(w);\r\n}\r\n} else {\r\nfilter_te_syntax_check_cb(w, NULL);\r\n}\r\n}\r\nstatic void\r\nhex_selected_cb(GtkWidget *button_rb _U_, gpointer parent_w)\r\n{\r\nGtkWidget *filter_tb, *hex_rb, *filter_entry;\r\nfilter_tb = (GtkWidget *) g_object_get_data(G_OBJECT(parent_w), E_FILT_TE_PTR_KEY);\r\nhex_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_HEXDATA_KEY);\r\nfilter_entry = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),E_FIND_FILT_KEY);\r\ngtk_widget_grab_focus(filter_entry);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(hex_rb)) && g_signal_handler_is_connected(filter_tb, te_presskey_handler_id)) {\r\ng_signal_handler_disconnect(filter_tb, te_presskey_handler_id);\r\ng_signal_handler_disconnect(parent_w, win_presskey_handler_id);\r\n}\r\nfind_filter_te_syntax_check_cb(filter_tb, parent_w);\r\nreturn;\r\n}\r\nstatic void\r\nstring_selected_cb(GtkWidget *button_rb _U_, gpointer parent_w)\r\n{\r\nGtkWidget *string_rb, *packet_data_rb, *decode_data_rb, *summary_data_rb,\r\n*data_combo_lb, *data_combo_cb, *data_case_cb, *filter_tb, *filter_entry;\r\nstring_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_STRINGDATA_KEY);\r\npacket_data_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_SOURCE_DATA_KEY);\r\ndecode_data_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_SOURCE_DECODE_KEY);\r\nsummary_data_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_SOURCE_SUMMARY_KEY);\r\ndata_combo_lb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_STRINGTYPE_LABEL_KEY);\r\ndata_combo_cb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_STRINGTYPE_KEY);\r\ndata_case_cb = (GtkWidget *) g_object_get_data(G_OBJECT(parent_w), E_CASE_SEARCH_KEY);\r\nfilter_tb = (GtkWidget *) g_object_get_data(G_OBJECT(parent_w), E_FILT_TE_PTR_KEY);\r\nfilter_entry = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),E_FIND_FILT_KEY);\r\ngtk_widget_grab_focus(filter_entry);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(string_rb))) {\r\ngtk_widget_set_sensitive(GTK_WIDGET(packet_data_rb), TRUE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(decode_data_rb), TRUE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(summary_data_rb), TRUE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(data_combo_lb), TRUE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(data_combo_cb), TRUE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(data_case_cb), TRUE);\r\nif(g_signal_handler_is_connected(filter_tb, te_presskey_handler_id)) {\r\ng_signal_handler_disconnect(filter_tb, te_presskey_handler_id);\r\ng_signal_handler_disconnect(parent_w, win_presskey_handler_id);\r\n}\r\n} else {\r\ngtk_widget_set_sensitive(GTK_WIDGET(packet_data_rb), FALSE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(decode_data_rb), FALSE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(summary_data_rb), FALSE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(data_combo_lb), FALSE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(data_combo_cb), FALSE);\r\ngtk_widget_set_sensitive(GTK_WIDGET(data_case_cb), FALSE);\r\n}\r\nfind_filter_te_syntax_check_cb(filter_tb, parent_w);\r\nreturn;\r\n}\r\nstatic void\r\nfilter_selected_cb(GtkWidget *button_rb _U_, gpointer parent_w)\r\n{\r\nGtkWidget *filter_bt, *filter_rb, *filter_te, *filter_entry;\r\nfilter_bt = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FILT_TE_BUTTON_KEY);\r\nfilter_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_FILTERDATA_KEY);\r\nfilter_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FILT_TE_PTR_KEY);\r\nfilter_entry = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),E_FIND_FILT_KEY);\r\ngtk_widget_grab_focus(filter_entry);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(filter_rb)))\r\n{\r\ngtk_widget_set_sensitive(GTK_WIDGET(filter_bt), TRUE);\r\nif(!g_signal_handler_is_connected(filter_te, te_presskey_handler_id)) {\r\nte_presskey_handler_id = g_signal_connect(filter_te, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\nwin_presskey_handler_id = g_signal_connect(parent_w, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\n}\r\n}\r\nelse\r\n{\r\ngtk_widget_set_sensitive(GTK_WIDGET(filter_bt), FALSE);\r\n}\r\nreturn;\r\n}\r\nstatic void\r\nfind_frame_ok_cb(GtkWidget *ok_bt _U_, gpointer parent_w)\r\n{\r\nGtkWidget *filter_te, *up_rb, *hex_rb, *string_rb, *combo_cb,\r\n*case_cb, *packet_data_rb, *decode_data_rb, *summary_data_rb;\r\nconst gchar *filter_text;\r\nsearch_charset_t scs_type = SCS_NARROW_AND_WIDE;\r\nguint8 *bytes = NULL;\r\nsize_t nbytes = 0;\r\nchar *string = NULL;\r\ndfilter_t *sfcode = NULL;\r\ngboolean found_packet=FALSE;\r\ngboolean hex_search;\r\ngboolean string_search;\r\nint string_type;\r\nfilter_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_FILT_KEY);\r\nup_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_BACKWARD_KEY);\r\nhex_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_HEXDATA_KEY);\r\nstring_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_STRINGDATA_KEY);\r\ncombo_cb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_FIND_STRINGTYPE_KEY);\r\ncase_cb = (GtkWidget *) g_object_get_data(G_OBJECT(parent_w), E_CASE_SEARCH_KEY);\r\npacket_data_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_SOURCE_DATA_KEY);\r\ndecode_data_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_SOURCE_DECODE_KEY);\r\nsummary_data_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_SOURCE_SUMMARY_KEY);\r\nfilter_text = gtk_entry_get_text(GTK_ENTRY(filter_te));\r\nstring_type = gtk_combo_box_get_active (GTK_COMBO_BOX(combo_cb));\r\ncase_type = !gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(case_cb));\r\npacket_data = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(packet_data_rb));\r\ndecode_data = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(decode_data_rb));\r\nsummary_data = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(summary_data_rb));\r\nhex_search = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON (hex_rb));\r\nstring_search = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON (string_rb));\r\nif (hex_search) {\r\nbytes = convert_string_to_hex(filter_text, &nbytes);\r\nif (bytes == NULL) {\r\nstatusbar_push_temporary_msg("That's not a valid hex string.");\r\nreturn;\r\n}\r\n} else if (string_search) {\r\nif (strcmp(filter_text, "") == 0) {\r\nstatusbar_push_temporary_msg("You didn't specify any text for which to search.");\r\nreturn;\r\n}\r\nif (string_type == SCS_NARROW_AND_WIDE)\r\nscs_type = SCS_NARROW_AND_WIDE;\r\nelse if (string_type == SCS_NARROW)\r\nscs_type = SCS_NARROW;\r\nelse if (string_type == SCS_WIDE)\r\nscs_type = SCS_WIDE;\r\nelse {\r\nstatusbar_push_temporary_msg("You didn't choose a valid character set.");\r\nreturn;\r\n}\r\nstring = convert_string_case(filter_text, case_type);\r\n} else {\r\ngchar *err_msg;\r\nif (!dfilter_compile(filter_text, &sfcode, &err_msg)) {\r\nbad_dfilter_alert_box(GTK_WIDGET(parent_w), filter_text, err_msg);\r\ng_free(err_msg);\r\nreturn;\r\n}\r\nif (sfcode == NULL) {\r\nstatusbar_push_temporary_msg("That filter doesn't test anything.");\r\nreturn;\r\n}\r\n}\r\ng_free(cfile.sfilter);\r\ncfile.sfilter = g_strdup(filter_text);\r\ncfile.dir = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON (up_rb)) ? SD_BACKWARD : SD_FORWARD;\r\ncfile.hex = hex_search;\r\ncfile.string = string_search;\r\ncfile.scs_type = scs_type;\r\ncfile.case_type = case_type;\r\ncfile.regex = NULL;\r\ncfile.packet_data = packet_data;\r\ncfile.decode_data = decode_data;\r\ncfile.summary_data = summary_data;\r\nif (cfile.hex) {\r\nfound_packet = cf_find_packet_data(&cfile, bytes, nbytes, cfile.dir);\r\ng_free(bytes);\r\nif (!found_packet) {\r\nstatusbar_push_temporary_msg("No packet contained those bytes.");\r\nreturn;\r\n}\r\n} else if (cfile.string) {\r\nif (cfile.summary_data) {\r\nfound_packet = cf_find_packet_summary_line(&cfile, string, cfile.dir);\r\ng_free(string);\r\nif (!found_packet) {\r\nstatusbar_push_temporary_msg("No packet contained that string in its Info column.");\r\nreturn;\r\n}\r\n} else if (cfile.decode_data) {\r\nfound_packet = cf_find_packet_protocol_tree(&cfile, string, cfile.dir);\r\ng_free(string);\r\nif (!found_packet) {\r\nstatusbar_push_temporary_msg("No packet contained that string in its dissected display.");\r\nreturn;\r\n}\r\n} else if (cfile.packet_data && string) {\r\nfound_packet = cf_find_packet_data(&cfile, string, strlen(string), cfile.dir);\r\ng_free(string);\r\nif (!found_packet) {\r\nstatusbar_push_temporary_msg("No packet contained that string in its ASCII-converted data.");\r\nreturn;\r\n}\r\n}\r\n} else {\r\nfound_packet = cf_find_packet_dfilter(&cfile, sfcode, cfile.dir);\r\ndfilter_free(sfcode);\r\nif (!found_packet) {\r\nstatusbar_push_temporary_msg("No packet matched that filter.");\r\ng_free(bytes);\r\nreturn;\r\n}\r\n}\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\nfind_frame_close_cb(GtkWidget *close_bt _U_, gpointer parent_w)\r\n{\r\ngtk_grab_remove(GTK_WIDGET(parent_w));\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\nfind_frame_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\nfind_frame_w = NULL;\r\n}\r\nstatic void\r\nfind_previous_next(GtkWidget *w, gpointer d, search_direction dir)\r\n{\r\nguint8 *bytes;\r\nsize_t nbytes;\r\nchar *string;\r\ndfilter_t *sfcode;\r\nif (cfile.sfilter) {\r\ncfile.dir = dir;\r\nif (cfile.hex) {\r\nbytes = convert_string_to_hex(cfile.sfilter, &nbytes);\r\nif (bytes == NULL) {\r\nreturn;\r\n}\r\ncf_find_packet_data(&cfile, bytes, nbytes, dir);\r\ng_free(bytes);\r\n} else if (cfile.string) {\r\nstring = convert_string_case(cfile.sfilter, cfile.case_type);\r\nif (cfile.decode_data) {\r\ncf_find_packet_protocol_tree(&cfile, string, dir);\r\n} else if (cfile.summary_data) {\r\ncf_find_packet_summary_line(&cfile, string, dir);\r\n} else {\r\ncf_find_packet_data(&cfile, string, strlen(string), dir);\r\n}\r\ng_free(string);\r\n} else {\r\nif (!dfilter_compile(cfile.sfilter, &sfcode, NULL)) {\r\nreturn;\r\n}\r\nif (sfcode == NULL) {\r\nreturn;\r\n}\r\ncf_find_packet_dfilter(&cfile, sfcode, dir);\r\ndfilter_free(sfcode);\r\n}\r\n} else\r\nfind_frame_cb(w, d);\r\n}\r\nvoid\r\nfind_next_cb(GtkWidget *w , gpointer d)\r\n{\r\nfind_previous_next(w, d, SD_FORWARD);\r\n}\r\nvoid\r\nfind_previous_cb(GtkWidget *w , gpointer d)\r\n{\r\nfind_previous_next(w, d, SD_BACKWARD);\r\n}

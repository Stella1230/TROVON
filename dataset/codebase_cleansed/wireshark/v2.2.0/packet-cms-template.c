static void\r\ncms_verify_msg_digest(proto_item *pi, tvbuff_t *content, const char *alg, tvbuff_t *tvb, int offset)\r\n{\r\nsha1_context sha1_ctx;\r\nmd5_state_t md5_ctx;\r\nint i= 0, buffer_size = 0;\r\nif(strcmp(alg, HASH_SHA1) == 0) {\r\nsha1_starts(&sha1_ctx);\r\nsha1_update(&sha1_ctx, tvb_get_ptr(content, 0, tvb_captured_length(content)),\r\ntvb_captured_length(content));\r\nsha1_finish(&sha1_ctx, digest_buf);\r\nbuffer_size = SHA1_DIGEST_LEN;\r\n} else if(strcmp(alg, HASH_MD5) == 0) {\r\nmd5_init(&md5_ctx);\r\nmd5_append(&md5_ctx, tvb_get_ptr(content, 0, tvb_captured_length(content)),\r\ntvb_captured_length(content));\r\nmd5_finish(&md5_ctx, digest_buf);\r\nbuffer_size = MD5_BUFFER_SIZE;\r\n}\r\nif(buffer_size) {\r\nif(tvb_bytes_exist(tvb, offset, buffer_size) &&\r\n(tvb_memeql(tvb, offset, digest_buf, buffer_size) != 0)) {\r\nproto_item_append_text(pi, " [incorrect, should be ");\r\nfor(i = 0; i < buffer_size; i++)\r\nproto_item_append_text(pi, "%02X", digest_buf[i]);\r\nproto_item_append_text(pi, "]");\r\n}\r\nelse\r\nproto_item_append_text(pi, " [correct]");\r\n} else {\r\nproto_item_append_text(pi, " [unable to verify]");\r\n}\r\n}\r\nvoid proto_register_cms(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_cms_ci_contentType,\r\n{ "contentType", "cms.contentInfo.contentType",\r\nFT_OID, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n#include "packet-cms-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n#include "packet-cms-ettarr.c"\r\n};\r\nproto_cms = proto_register_protocol(PNAME, PSNAME, PFNAME);\r\nproto_register_field_array(proto_cms, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_ber_syntax_dissector("ContentInfo", proto_cms, dissect_ContentInfo_PDU);\r\nregister_ber_syntax_dissector("SignedData", proto_cms, dissect_SignedData_PDU);\r\nregister_ber_oid_syntax(".p7s", NULL, "ContentInfo");\r\nregister_ber_oid_syntax(".p7m", NULL, "ContentInfo");\r\nregister_ber_oid_syntax(".p7c", NULL, "ContentInfo");\r\n}\r\nvoid proto_reg_handoff_cms(void) {\r\ndissector_handle_t content_info_handle;\r\n#include "packet-cms-dis-tab.c"\r\noid_add_from_string("id-data","1.2.840.113549.1.7.1");\r\noid_add_from_string("id-alg-des-ede3-cbc","1.2.840.113549.3.7");\r\noid_add_from_string("id-alg-des-cbc","1.3.14.3.2.7");\r\ncontent_info_handle = create_dissector_handle (dissect_ContentInfo_PDU, proto_cms);\r\ndissector_add_string("media_type", "application/pkcs7-mime", content_info_handle);\r\ndissector_add_string("media_type", "application/pkcs7-signature", content_info_handle);\r\n}

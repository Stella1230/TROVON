static int\r\ndissect_cups(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *cups_tree = NULL;\r\nproto_tree *ptype_subtree = NULL;\r\nproto_item *ti = NULL;\r\ngint offset = 0;\r\ngint next_offset;\r\nguint len;\r\nconst guint8 *str;\r\ncups_ptype_t ptype;\r\nunsigned int state;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PROTO_TAG_CUPS);\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_cups, tvb, offset, -1, ENC_NA);\r\ncups_tree = proto_item_add_subtree(ti, ett_cups);\r\nptype = get_hex_uint(tvb, offset, &next_offset);\r\nlen = next_offset - offset;\r\nif (len != 0) {\r\nti = proto_tree_add_uint(cups_tree, hf_cups_ptype, tvb, offset, len, ptype);\r\nptype_subtree = proto_item_add_subtree(ti, ett_cups_ptype);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_default, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_implicit, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_variable, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_large, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_medium, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_small, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_sort, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_bind, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_cover, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_punch, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_collate, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_copies, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_staple, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_duplex, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_color, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_bw, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_remote, tvb, offset, len, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptype_subtree, hf_cups_ptype_class, tvb, offset, len, ENC_BIG_ENDIAN);\r\n}\r\noffset = next_offset;\r\nif (!skip_space(tvb, offset, &next_offset))\r\nreturn offset;\r\noffset = next_offset;\r\nstate = get_hex_uint(tvb, offset, &next_offset);\r\nlen = next_offset - offset;\r\nif (len != 0) {\r\nproto_tree_add_uint(cups_tree, hf_cups_state, tvb, offset, len, state);\r\n}\r\noffset = next_offset;\r\nif (!skip_space(tvb, offset, &next_offset))\r\nreturn offset;\r\noffset = next_offset;\r\nstr = get_unquoted_string(tvb, offset, &next_offset, &len);\r\nif (str == NULL)\r\nreturn offset;\r\nproto_tree_add_string(cups_tree, hf_cups_uri, tvb, offset, len, str);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%.*s (%s)",\r\n(guint16) len, str, val_to_str(state, cups_state_values, "0x%x"));\r\noffset = next_offset;\r\nif (!cups_tree)\r\nreturn offset;\r\nif (!skip_space(tvb, offset, &next_offset))\r\nreturn offset;\r\noffset = next_offset;\r\nstr = get_quoted_string(tvb, offset, &next_offset, &len);\r\nif (str == NULL)\r\nreturn offset;\r\nproto_tree_add_string(cups_tree, hf_cups_location, tvb, offset+1, len, str);\r\noffset = next_offset;\r\nif (!skip_space(tvb, offset, &next_offset))\r\nreturn offset;\r\noffset = next_offset;\r\nstr = get_quoted_string(tvb, offset, &next_offset, &len);\r\nif (str == NULL)\r\nreturn offset;\r\nproto_tree_add_string(cups_tree, hf_cups_information, tvb, offset+1, len, str);\r\noffset = next_offset;\r\nif (!skip_space(tvb, offset, &next_offset))\r\nreturn offset;\r\noffset = next_offset;\r\nstr = get_quoted_string(tvb, offset, &next_offset, &len);\r\nif (str == NULL)\r\nreturn offset;\r\nproto_tree_add_string(cups_tree, hf_cups_make_model, tvb, offset+1, len, str);\r\nreturn next_offset;\r\n}\r\nstatic guint\r\nget_hex_uint(tvbuff_t *tvb, gint offset, gint *next_offset)\r\n{\r\nint c;\r\nguint u = 0;\r\nwhile (g_ascii_isxdigit(c = tvb_get_guint8(tvb, offset))) {\r\nu = 16*u + ws_xton(c);\r\noffset++;\r\n}\r\n*next_offset = offset;\r\nreturn u;\r\n}\r\nstatic gboolean\r\nskip_space(tvbuff_t *tvb, gint offset, gint *next_offset)\r\n{\r\nint c;\r\nwhile ((c = tvb_get_guint8(tvb, offset)) == ' ')\r\noffset++;\r\nif (c == '\r' || c == '\n')\r\nreturn FALSE;\r\n*next_offset = offset;\r\nreturn TRUE;\r\n}\r\nstatic const guint8*\r\nget_quoted_string(tvbuff_t *tvb, gint offset, gint *next_offset, guint *len)\r\n{\r\nint c;\r\nconst guint8* s = NULL;\r\nguint l = 0;\r\ngint o;\r\nc = tvb_get_guint8(tvb, offset);\r\nif (c == '"') {\r\no = tvb_find_guint8(tvb, offset+1, -1, '"');\r\nif (o != -1) {\r\noffset++;\r\nl = o - offset;\r\ns = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, l, ENC_ASCII);\r\noffset = o + 1;\r\n}\r\n}\r\n*next_offset = offset;\r\n*len = l;\r\nreturn s;\r\n}\r\nstatic const guint8*\r\nget_unquoted_string(tvbuff_t *tvb, gint offset, gint *next_offset, guint *len)\r\n{\r\nconst guint8* s = NULL;\r\nguint l = 0;\r\ngint o;\r\no = tvb_ws_mempbrk_pattern_guint8(tvb, offset, -1, &pbrk_whitespace, NULL);\r\nif (o != -1) {\r\nl = o - offset;\r\ns = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, l, ENC_ASCII);\r\noffset = o;\r\n}\r\n*next_offset = offset;\r\n*len = l;\r\nreturn s;\r\n}\r\nvoid\r\nproto_register_cups(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_cups_ptype,\r\n{ "Type", "cups.ptype", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_cups_ptype_default,\r\n{ "Default printer on network", "cups.ptype.default", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_DEFAULT, NULL, HFILL }},\r\n{ &hf_cups_ptype_implicit,\r\n{ "Class", "cups.ptype.implicit", FT_BOOLEAN, 32,\r\nTFS(&tfs_implicit_explicit), CUPS_PRINTER_IMPLICIT, NULL, HFILL }},\r\n{ &hf_cups_ptype_variable,\r\n{ "Can print variable sizes", "cups.ptype.variable", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_VARIABLE, NULL, HFILL }},\r\n{ &hf_cups_ptype_large,\r\n{ "Can print up to 36x48 inches", "cups.ptype.large", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_LARGE, NULL, HFILL }},\r\n{ &hf_cups_ptype_medium,\r\n{ "Can print up to 18x24 inches", "cups.ptype.medium", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_MEDIUM, NULL, HFILL }},\r\n{ &hf_cups_ptype_small,\r\n{ "Can print up to 9x14 inches", "cups.ptype.small", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_SMALL, NULL, HFILL }},\r\n{ &hf_cups_ptype_sort,\r\n{ "Can sort", "cups.ptype.sort", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_SORT, NULL, HFILL }},\r\n{ &hf_cups_ptype_bind,\r\n{ "Can bind", "cups.ptype.bind", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_BIND, NULL, HFILL }},\r\n{ &hf_cups_ptype_cover,\r\n{ "Can cover", "cups.ptype.cover", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_COVER, NULL, HFILL }},\r\n{ &hf_cups_ptype_punch,\r\n{ "Can punch holes", "cups.ptype.punch", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_PUNCH, NULL, HFILL }},\r\n{ &hf_cups_ptype_collate,\r\n{ "Can do fast collating", "cups.ptype.collate", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_COLLATE, NULL, HFILL }},\r\n{ &hf_cups_ptype_copies,\r\n{ "Can do fast copies", "cups.ptype.copies", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_COPIES, NULL, HFILL }},\r\n{ &hf_cups_ptype_staple,\r\n{ "Can staple", "cups.ptype.staple", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_STAPLE, NULL, HFILL }},\r\n{ &hf_cups_ptype_duplex,\r\n{ "Can duplex", "cups.ptype.duplex", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_DUPLEX, NULL, HFILL }},\r\n{ &hf_cups_ptype_color,\r\n{ "Can print color", "cups.ptype.color", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_COLOR, NULL, HFILL }},\r\n{ &hf_cups_ptype_bw,\r\n{ "Can print black", "cups.ptype.bw", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_BW, NULL, HFILL }},\r\n{ &hf_cups_ptype_remote,\r\n{ "Remote", "cups.ptype.remote", FT_BOOLEAN, 32,\r\nTFS(&tfs_yes_no), CUPS_PRINTER_REMOTE, NULL, HFILL }},\r\n{ &hf_cups_ptype_class,\r\n{ "Class", "cups.ptype.class", FT_BOOLEAN, 32,\r\nTFS(&tfs_printer_class), CUPS_PRINTER_CLASS, NULL, HFILL }},\r\n{ &hf_cups_state,\r\n{ "State", "cups.state", FT_UINT8, BASE_HEX,\r\nVALS(cups_state_values), 0x0, NULL, HFILL }},\r\n{ &hf_cups_uri,\r\n{ "URI", "cups.uri", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_cups_location,\r\n{ "Location", "cups.location", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_cups_information,\r\n{ "Information", "cups.information", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_cups_make_model,\r\n{ "Make and model", "cups.make_model", FT_STRING, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_cups,\r\n&ett_cups_ptype\r\n};\r\nproto_cups = proto_register_protocol(\r\n"Common Unix Printing System (CUPS) Browsing Protocol",\r\n"CUPS", "cups");\r\nproto_register_field_array(proto_cups, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nws_mempbrk_compile(&pbrk_whitespace, " \t\r\n");\r\n}\r\nvoid\r\nproto_reg_handoff_cups(void)\r\n{\r\ndissector_handle_t cups_handle;\r\ncups_handle = create_dissector_handle(dissect_cups, proto_cups);\r\ndissector_add_uint("udp.port", UDP_PORT_CUPS, cups_handle);\r\n}

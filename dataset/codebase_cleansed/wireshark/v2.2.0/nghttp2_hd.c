static int memeq(const void *s1, const void *s2, size_t n) {\r\nreturn memcmp(s1, s2, n) == 0;\r\n}\r\nstatic int32_t lookup_token(const uint8_t *name, size_t namelen) {\r\nswitch (namelen) {\r\ncase 2:\r\nswitch (name[1]) {\r\ncase 'e':\r\nif (lstreq("t", name, 1)) {\r\nreturn NGHTTP2_TOKEN_TE;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 3:\r\nswitch (name[2]) {\r\ncase 'a':\r\nif (lstreq("vi", name, 2)) {\r\nreturn NGHTTP2_TOKEN_VIA;\r\n}\r\nbreak;\r\ncase 'e':\r\nif (lstreq("ag", name, 2)) {\r\nreturn NGHTTP2_TOKEN_AGE;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 4:\r\nswitch (name[3]) {\r\ncase 'e':\r\nif (lstreq("dat", name, 3)) {\r\nreturn NGHTTP2_TOKEN_DATE;\r\n}\r\nbreak;\r\ncase 'g':\r\nif (lstreq("eta", name, 3)) {\r\nreturn NGHTTP2_TOKEN_ETAG;\r\n}\r\nbreak;\r\ncase 'k':\r\nif (lstreq("lin", name, 3)) {\r\nreturn NGHTTP2_TOKEN_LINK;\r\n}\r\nbreak;\r\ncase 'm':\r\nif (lstreq("fro", name, 3)) {\r\nreturn NGHTTP2_TOKEN_FROM;\r\n}\r\nbreak;\r\ncase 't':\r\nif (lstreq("hos", name, 3)) {\r\nreturn NGHTTP2_TOKEN_HOST;\r\n}\r\nbreak;\r\ncase 'y':\r\nif (lstreq("var", name, 3)) {\r\nreturn NGHTTP2_TOKEN_VARY;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 5:\r\nswitch (name[4]) {\r\ncase 'e':\r\nif (lstreq("rang", name, 4)) {\r\nreturn NGHTTP2_TOKEN_RANGE;\r\n}\r\nbreak;\r\ncase 'h':\r\nif (lstreq(":pat", name, 4)) {\r\nreturn NGHTTP2_TOKEN__PATH;\r\n}\r\nif (lstreq(":pat", name, 4)) {\r\nreturn NGHTTP2_TOKEN__PATH;\r\n}\r\nbreak;\r\ncase 'w':\r\nif (lstreq("allo", name, 4)) {\r\nreturn NGHTTP2_TOKEN_ALLOW;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 6:\r\nswitch (name[5]) {\r\ncase 'e':\r\nif (lstreq("cooki", name, 5)) {\r\nreturn NGHTTP2_TOKEN_COOKIE;\r\n}\r\nbreak;\r\ncase 'r':\r\nif (lstreq("serve", name, 5)) {\r\nreturn NGHTTP2_TOKEN_SERVER;\r\n}\r\nbreak;\r\ncase 't':\r\nif (lstreq("accep", name, 5)) {\r\nreturn NGHTTP2_TOKEN_ACCEPT;\r\n}\r\nif (lstreq("expec", name, 5)) {\r\nreturn NGHTTP2_TOKEN_EXPECT;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 7:\r\nswitch (name[6]) {\r\ncase 'd':\r\nif (lstreq(":metho", name, 6)) {\r\nreturn NGHTTP2_TOKEN__METHOD;\r\n}\r\nif (lstreq(":metho", name, 6)) {\r\nreturn NGHTTP2_TOKEN__METHOD;\r\n}\r\nbreak;\r\ncase 'e':\r\nif (lstreq(":schem", name, 6)) {\r\nreturn NGHTTP2_TOKEN__SCHEME;\r\n}\r\nif (lstreq(":schem", name, 6)) {\r\nreturn NGHTTP2_TOKEN__SCHEME;\r\n}\r\nif (lstreq("upgrad", name, 6)) {\r\nreturn NGHTTP2_TOKEN_UPGRADE;\r\n}\r\nbreak;\r\ncase 'h':\r\nif (lstreq("refres", name, 6)) {\r\nreturn NGHTTP2_TOKEN_REFRESH;\r\n}\r\nbreak;\r\ncase 'r':\r\nif (lstreq("refere", name, 6)) {\r\nreturn NGHTTP2_TOKEN_REFERER;\r\n}\r\nbreak;\r\ncase 's':\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq(":statu", name, 6)) {\r\nreturn NGHTTP2_TOKEN__STATUS;\r\n}\r\nif (lstreq("expire", name, 6)) {\r\nreturn NGHTTP2_TOKEN_EXPIRES;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 8:\r\nswitch (name[7]) {\r\ncase 'e':\r\nif (lstreq("if-rang", name, 7)) {\r\nreturn NGHTTP2_TOKEN_IF_RANGE;\r\n}\r\nbreak;\r\ncase 'h':\r\nif (lstreq("if-matc", name, 7)) {\r\nreturn NGHTTP2_TOKEN_IF_MATCH;\r\n}\r\nbreak;\r\ncase 'n':\r\nif (lstreq("locatio", name, 7)) {\r\nreturn NGHTTP2_TOKEN_LOCATION;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 10:\r\nswitch (name[9]) {\r\ncase 'e':\r\nif (lstreq("keep-aliv", name, 9)) {\r\nreturn NGHTTP2_TOKEN_KEEP_ALIVE;\r\n}\r\nif (lstreq("set-cooki", name, 9)) {\r\nreturn NGHTTP2_TOKEN_SET_COOKIE;\r\n}\r\nbreak;\r\ncase 'n':\r\nif (lstreq("connectio", name, 9)) {\r\nreturn NGHTTP2_TOKEN_CONNECTION;\r\n}\r\nbreak;\r\ncase 't':\r\nif (lstreq("user-agen", name, 9)) {\r\nreturn NGHTTP2_TOKEN_USER_AGENT;\r\n}\r\nbreak;\r\ncase 'y':\r\nif (lstreq(":authorit", name, 9)) {\r\nreturn NGHTTP2_TOKEN__AUTHORITY;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 11:\r\nswitch (name[10]) {\r\ncase 'r':\r\nif (lstreq("retry-afte", name, 10)) {\r\nreturn NGHTTP2_TOKEN_RETRY_AFTER;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 12:\r\nswitch (name[11]) {\r\ncase 'e':\r\nif (lstreq("content-typ", name, 11)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_TYPE;\r\n}\r\nbreak;\r\ncase 's':\r\nif (lstreq("max-forward", name, 11)) {\r\nreturn NGHTTP2_TOKEN_MAX_FORWARDS;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 13:\r\nswitch (name[12]) {\r\ncase 'd':\r\nif (lstreq("last-modifie", name, 12)) {\r\nreturn NGHTTP2_TOKEN_LAST_MODIFIED;\r\n}\r\nbreak;\r\ncase 'e':\r\nif (lstreq("content-rang", name, 12)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_RANGE;\r\n}\r\nbreak;\r\ncase 'h':\r\nif (lstreq("if-none-matc", name, 12)) {\r\nreturn NGHTTP2_TOKEN_IF_NONE_MATCH;\r\n}\r\nbreak;\r\ncase 'l':\r\nif (lstreq("cache-contro", name, 12)) {\r\nreturn NGHTTP2_TOKEN_CACHE_CONTROL;\r\n}\r\nbreak;\r\ncase 'n':\r\nif (lstreq("authorizatio", name, 12)) {\r\nreturn NGHTTP2_TOKEN_AUTHORIZATION;\r\n}\r\nbreak;\r\ncase 's':\r\nif (lstreq("accept-range", name, 12)) {\r\nreturn NGHTTP2_TOKEN_ACCEPT_RANGES;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 14:\r\nswitch (name[13]) {\r\ncase 'h':\r\nif (lstreq("content-lengt", name, 13)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_LENGTH;\r\n}\r\nbreak;\r\ncase 't':\r\nif (lstreq("accept-charse", name, 13)) {\r\nreturn NGHTTP2_TOKEN_ACCEPT_CHARSET;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 15:\r\nswitch (name[14]) {\r\ncase 'e':\r\nif (lstreq("accept-languag", name, 14)) {\r\nreturn NGHTTP2_TOKEN_ACCEPT_LANGUAGE;\r\n}\r\nbreak;\r\ncase 'g':\r\nif (lstreq("accept-encodin", name, 14)) {\r\nreturn NGHTTP2_TOKEN_ACCEPT_ENCODING;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 16:\r\nswitch (name[15]) {\r\ncase 'e':\r\nif (lstreq("content-languag", name, 15)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_LANGUAGE;\r\n}\r\nif (lstreq("www-authenticat", name, 15)) {\r\nreturn NGHTTP2_TOKEN_WWW_AUTHENTICATE;\r\n}\r\nbreak;\r\ncase 'g':\r\nif (lstreq("content-encodin", name, 15)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_ENCODING;\r\n}\r\nbreak;\r\ncase 'n':\r\nif (lstreq("content-locatio", name, 15)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_LOCATION;\r\n}\r\nif (lstreq("proxy-connectio", name, 15)) {\r\nreturn NGHTTP2_TOKEN_PROXY_CONNECTION;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 17:\r\nswitch (name[16]) {\r\ncase 'e':\r\nif (lstreq("if-modified-sinc", name, 16)) {\r\nreturn NGHTTP2_TOKEN_IF_MODIFIED_SINCE;\r\n}\r\nbreak;\r\ncase 'g':\r\nif (lstreq("transfer-encodin", name, 16)) {\r\nreturn NGHTTP2_TOKEN_TRANSFER_ENCODING;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 18:\r\nswitch (name[17]) {\r\ncase 'e':\r\nif (lstreq("proxy-authenticat", name, 17)) {\r\nreturn NGHTTP2_TOKEN_PROXY_AUTHENTICATE;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 19:\r\nswitch (name[18]) {\r\ncase 'e':\r\nif (lstreq("if-unmodified-sinc", name, 18)) {\r\nreturn NGHTTP2_TOKEN_IF_UNMODIFIED_SINCE;\r\n}\r\nbreak;\r\ncase 'n':\r\nif (lstreq("content-dispositio", name, 18)) {\r\nreturn NGHTTP2_TOKEN_CONTENT_DISPOSITION;\r\n}\r\nif (lstreq("proxy-authorizatio", name, 18)) {\r\nreturn NGHTTP2_TOKEN_PROXY_AUTHORIZATION;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 25:\r\nswitch (name[24]) {\r\ncase 'y':\r\nif (lstreq("strict-transport-securit", name, 24)) {\r\nreturn NGHTTP2_TOKEN_STRICT_TRANSPORT_SECURITY;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase 27:\r\nswitch (name[26]) {\r\ncase 'n':\r\nif (lstreq("access-control-allow-origi", name, 26)) {\r\nreturn NGHTTP2_TOKEN_ACCESS_CONTROL_ALLOW_ORIGIN;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nreturn -1;\r\n}\r\nvoid nghttp2_hd_entry_init(nghttp2_hd_entry *ent, nghttp2_hd_nv *nv) {\r\nent->nv = *nv;\r\nent->cnv.name = nv->name->base;\r\nent->cnv.namelen = nv->name->len;\r\nent->cnv.value = nv->value->base;\r\nent->cnv.valuelen = nv->value->len;\r\nent->cnv.flags = nv->flags;\r\nent->next = NULL;\r\nent->hash = 0;\r\nnghttp2_rcbuf_incref(ent->nv.name);\r\nnghttp2_rcbuf_incref(ent->nv.value);\r\n}\r\nvoid nghttp2_hd_entry_free(nghttp2_hd_entry *ent) {\r\nnghttp2_rcbuf_decref(ent->nv.value);\r\nnghttp2_rcbuf_decref(ent->nv.name);\r\n}\r\nstatic int name_eq(const nghttp2_hd_nv *a, const nghttp2_nv *b) {\r\nreturn a->name->len == b->namelen &&\r\nmemeq(a->name->base, b->name, b->namelen);\r\n}\r\nstatic int value_eq(const nghttp2_hd_nv *a, const nghttp2_nv *b) {\r\nreturn a->value->len == b->valuelen &&\r\nmemeq(a->value->base, b->value, b->valuelen);\r\n}\r\nstatic uint32_t name_hash(const nghttp2_nv *nv) {\r\nuint32_t h = 2166136261u;\r\nsize_t i;\r\nfor (i = 0; i < nv->namelen; ++i) {\r\nh ^= nv->name[i];\r\nh += (h << 1) + (h << 4) + (h << 7) + (h << 8) + (h << 24);\r\n}\r\nreturn h;\r\n}\r\nstatic void hd_map_init(nghttp2_hd_map *map) {\r\nmemset(map, 0, sizeof(nghttp2_hd_map));\r\n}\r\nstatic void hd_map_insert(nghttp2_hd_map *map, nghttp2_hd_entry *ent) {\r\nnghttp2_hd_entry **bucket;\r\nbucket = &map->table[ent->hash & (HD_MAP_SIZE - 1)];\r\nif (*bucket == NULL) {\r\n*bucket = ent;\r\nreturn;\r\n}\r\nent->next = *bucket;\r\n*bucket = ent;\r\n}\r\nstatic nghttp2_hd_entry *hd_map_find(nghttp2_hd_map *map, int *exact_match,\r\nconst nghttp2_nv *nv, int32_t token,\r\nuint32_t hash) {\r\nnghttp2_hd_entry *p;\r\nnghttp2_hd_entry *res = NULL;\r\n*exact_match = 0;\r\nfor (p = map->table[hash & (HD_MAP_SIZE - 1)]; p; p = p->next) {\r\nif (token != p->nv.token ||\r\n(token == -1 && (hash != p->hash || !name_eq(&p->nv, nv)))) {\r\ncontinue;\r\n}\r\nif (!res) {\r\nres = p;\r\n}\r\nif (value_eq(&p->nv, nv)) {\r\nres = p;\r\n*exact_match = 1;\r\nbreak;\r\n}\r\n}\r\nreturn res;\r\n}\r\nstatic void hd_map_remove(nghttp2_hd_map *map, nghttp2_hd_entry *ent) {\r\nnghttp2_hd_entry **dst;\r\ndst = &map->table[ent->hash & (HD_MAP_SIZE - 1)];\r\nfor (; *dst; dst = &(*dst)->next) {\r\nif (*dst != ent) {\r\ncontinue;\r\n}\r\n*dst = ent->next;\r\nent->next = NULL;\r\nreturn;\r\n}\r\n}\r\nstatic int hd_ringbuf_init(nghttp2_hd_ringbuf *ringbuf, size_t bufsize,\r\nnghttp2_mem *mem) {\r\nsize_t size;\r\nfor (size = 1; size < bufsize; size <<= 1)\r\n;\r\nringbuf->buffer = (nghttp2_hd_entry **)nghttp2_mem_malloc(mem, sizeof(nghttp2_hd_entry *) * size);\r\nif (ringbuf->buffer == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nringbuf->mask = size - 1;\r\nringbuf->first = 0;\r\nringbuf->len = 0;\r\nreturn 0;\r\n}\r\nstatic nghttp2_hd_entry *hd_ringbuf_get(nghttp2_hd_ringbuf *ringbuf,\r\nsize_t idx) {\r\nassert(idx < ringbuf->len);\r\nreturn ringbuf->buffer[(ringbuf->first + idx) & ringbuf->mask];\r\n}\r\nstatic int hd_ringbuf_reserve(nghttp2_hd_ringbuf *ringbuf, size_t bufsize,\r\nnghttp2_mem *mem) {\r\nsize_t i;\r\nsize_t size;\r\nnghttp2_hd_entry **buffer;\r\nif (ringbuf->mask + 1 >= bufsize) {\r\nreturn 0;\r\n}\r\nfor (size = 1; size < bufsize; size <<= 1)\r\n;\r\nbuffer = (nghttp2_hd_entry **)nghttp2_mem_malloc(mem, sizeof(nghttp2_hd_entry *) * size);\r\nif (buffer == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nfor (i = 0; i < ringbuf->len; ++i) {\r\nbuffer[i] = hd_ringbuf_get(ringbuf, i);\r\n}\r\nnghttp2_mem_free(mem, ringbuf->buffer);\r\nringbuf->buffer = buffer;\r\nringbuf->mask = size - 1;\r\nringbuf->first = 0;\r\nreturn 0;\r\n}\r\nstatic void hd_ringbuf_free(nghttp2_hd_ringbuf *ringbuf, nghttp2_mem *mem) {\r\nsize_t i;\r\nif (ringbuf == NULL) {\r\nreturn;\r\n}\r\nfor (i = 0; i < ringbuf->len; ++i) {\r\nnghttp2_hd_entry *ent = hd_ringbuf_get(ringbuf, i);\r\nnghttp2_hd_entry_free(ent);\r\nnghttp2_mem_free(mem, ent);\r\n}\r\nnghttp2_mem_free(mem, ringbuf->buffer);\r\n}\r\nstatic int hd_ringbuf_push_front(nghttp2_hd_ringbuf *ringbuf,\r\nnghttp2_hd_entry *ent, nghttp2_mem *mem) {\r\nint rv;\r\nrv = hd_ringbuf_reserve(ringbuf, ringbuf->len + 1, mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nringbuf->buffer[--ringbuf->first & ringbuf->mask] = ent;\r\n++ringbuf->len;\r\nreturn 0;\r\n}\r\nstatic void hd_ringbuf_pop_back(nghttp2_hd_ringbuf *ringbuf) {\r\nassert(ringbuf->len > 0);\r\n--ringbuf->len;\r\n}\r\nstatic int hd_context_init(nghttp2_hd_context *context, nghttp2_mem *mem) {\r\nint rv;\r\ncontext->mem = mem;\r\ncontext->bad = 0;\r\ncontext->hd_table_bufsize_max = NGHTTP2_HD_DEFAULT_MAX_BUFFER_SIZE;\r\nrv = hd_ringbuf_init(&context->hd_table, context->hd_table_bufsize_max /\r\nNGHTTP2_HD_ENTRY_OVERHEAD,\r\nmem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\ncontext->hd_table_bufsize = 0;\r\ncontext->next_seq = 0;\r\nreturn 0;\r\n}\r\nstatic void hd_context_free(nghttp2_hd_context *context) {\r\nhd_ringbuf_free(&context->hd_table, context->mem);\r\n}\r\nint nghttp2_hd_deflate_init(nghttp2_hd_deflater *deflater, nghttp2_mem *mem) {\r\nreturn nghttp2_hd_deflate_init2(\r\ndeflater, NGHTTP2_HD_DEFAULT_MAX_DEFLATE_BUFFER_SIZE, mem);\r\n}\r\nint nghttp2_hd_deflate_init2(nghttp2_hd_deflater *deflater,\r\nsize_t deflate_hd_table_bufsize_max,\r\nnghttp2_mem *mem) {\r\nint rv;\r\nrv = hd_context_init(&deflater->ctx, mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nhd_map_init(&deflater->map);\r\nif (deflate_hd_table_bufsize_max < NGHTTP2_HD_DEFAULT_MAX_BUFFER_SIZE) {\r\ndeflater->notify_table_size_change = 1;\r\ndeflater->ctx.hd_table_bufsize_max = deflate_hd_table_bufsize_max;\r\n} else {\r\ndeflater->notify_table_size_change = 0;\r\n}\r\ndeflater->deflate_hd_table_bufsize_max = deflate_hd_table_bufsize_max;\r\ndeflater->min_hd_table_bufsize_max = UINT32_MAX;\r\nreturn 0;\r\n}\r\nint nghttp2_hd_inflate_init(nghttp2_hd_inflater *inflater, nghttp2_mem *mem) {\r\nint rv;\r\nrv = hd_context_init(&inflater->ctx, mem);\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\ninflater->settings_hd_table_bufsize_max = NGHTTP2_HD_DEFAULT_MAX_BUFFER_SIZE;\r\ninflater->min_hd_table_bufsize_max = UINT32_MAX;\r\ninflater->nv_name_keep = NULL;\r\ninflater->nv_value_keep = NULL;\r\ninflater->opcode = NGHTTP2_HD_OPCODE_NONE;\r\ninflater->state = NGHTTP2_HD_STATE_INFLATE_START;\r\nnghttp2_buf_init(&inflater->namebuf);\r\nnghttp2_buf_init(&inflater->valuebuf);\r\ninflater->namercbuf = NULL;\r\ninflater->valuercbuf = NULL;\r\ninflater->huffman_encoded = 0;\r\ninflater->index = 0;\r\ninflater->left = 0;\r\ninflater->shift = 0;\r\ninflater->index_required = 0;\r\ninflater->no_index = 0;\r\nreturn 0;\r\nfail:\r\nreturn rv;\r\n}\r\nstatic void hd_inflate_keep_free(nghttp2_hd_inflater *inflater) {\r\nnghttp2_rcbuf_decref(inflater->nv_value_keep);\r\nnghttp2_rcbuf_decref(inflater->nv_name_keep);\r\ninflater->nv_value_keep = NULL;\r\ninflater->nv_name_keep = NULL;\r\n}\r\nvoid nghttp2_hd_deflate_free(nghttp2_hd_deflater *deflater) {\r\nhd_context_free(&deflater->ctx);\r\n}\r\nvoid nghttp2_hd_inflate_free(nghttp2_hd_inflater *inflater) {\r\nhd_inflate_keep_free(inflater);\r\nnghttp2_rcbuf_decref(inflater->valuercbuf);\r\nnghttp2_rcbuf_decref(inflater->namercbuf);\r\nhd_context_free(&inflater->ctx);\r\n}\r\nstatic size_t entry_room(size_t namelen, size_t valuelen) {\r\nreturn NGHTTP2_HD_ENTRY_OVERHEAD + namelen + valuelen;\r\n}\r\nstatic int emit_header(nghttp2_hd_nv *nv_out, nghttp2_hd_nv *nv) {\r\nDEBUGF(fprintf(stderr, "inflatehd: header emission: %s: %s\n", nv->name->base,\r\nnv->value->base));\r\n*nv_out = *nv;\r\nreturn 0;\r\n}\r\nstatic size_t count_encoded_length(size_t n, size_t prefix) {\r\nsize_t k = (size_t)((1 << prefix) - 1);\r\nsize_t len = 0;\r\nif (n < k) {\r\nreturn 1;\r\n}\r\nn -= k;\r\n++len;\r\nfor (; n >= 128; n >>= 7, ++len)\r\n;\r\nreturn len + 1;\r\n}\r\nstatic size_t encode_length(uint8_t *buf, size_t n, size_t prefix) {\r\nsize_t k = (size_t)((1 << prefix) - 1);\r\nuint8_t *begin = buf;\r\n*buf = (uint8_t)(*buf & ~k);\r\nif (n < k) {\r\n*buf = (uint8_t)(*buf | n);\r\nreturn 1;\r\n}\r\n*buf = (uint8_t)(*buf | k);\r\n++buf;\r\nn -= k;\r\nfor (; n >= 128; n >>= 7) {\r\n*buf++ = (uint8_t)((1 << 7) | (n & 0x7f));\r\n}\r\n*buf++ = (uint8_t)n;\r\nreturn (size_t)(buf - begin);\r\n}\r\nstatic ssize_t decode_length(uint32_t *res, size_t *shift_ptr, int *final,\r\nuint32_t initial, size_t shift, const uint8_t *in,\r\nconst uint8_t *last, size_t prefix) {\r\nuint32_t k = (uint8_t)((1 << prefix) - 1);\r\nuint32_t n = initial;\r\nconst uint8_t *start = in;\r\n*shift_ptr = 0;\r\n*final = 0;\r\nif (n == 0) {\r\nif ((*in & k) != k) {\r\n*res = (*in) & k;\r\n*final = 1;\r\nreturn 1;\r\n}\r\nn = k;\r\nif (++in == last) {\r\n*res = n;\r\nreturn (ssize_t)(in - start);\r\n}\r\n}\r\nfor (; in != last; ++in, shift += 7) {\r\nuint32_t add = *in & 0x7f;\r\nif ((UINT32_MAX >> shift) < add) {\r\nDEBUGF(fprintf(stderr, "inflate: integer overflow on shift\n"));\r\nreturn -1;\r\n}\r\nadd <<= shift;\r\nif (UINT32_MAX - add < n) {\r\nDEBUGF(fprintf(stderr, "inflate: integer overflow on addition\n"));\r\nreturn -1;\r\n}\r\nn += add;\r\nif ((*in & (1 << 7)) == 0) {\r\nbreak;\r\n}\r\n}\r\n*shift_ptr = shift;\r\nif (in == last) {\r\n*res = n;\r\nreturn (ssize_t)(in - start);\r\n}\r\n*res = n;\r\n*final = 1;\r\nreturn (ssize_t)(in + 1 - start);\r\n}\r\nstatic int emit_table_size(nghttp2_bufs *bufs, size_t table_size) {\r\nint rv;\r\nuint8_t *bufp;\r\nsize_t blocklen;\r\nuint8_t sb[16];\r\nDEBUGF(fprintf(stderr, "deflatehd: emit table_size=%zu\n", table_size));\r\nblocklen = count_encoded_length(table_size, 5);\r\nif (sizeof(sb) < blocklen) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nbufp = sb;\r\n*bufp = 0x20u;\r\nencode_length(bufp, table_size, 5);\r\nrv = nghttp2_bufs_add(bufs, sb, blocklen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nstatic int emit_indexed_block(nghttp2_bufs *bufs, size_t idx) {\r\nint rv;\r\nsize_t blocklen;\r\nuint8_t sb[16];\r\nuint8_t *bufp;\r\nblocklen = count_encoded_length(idx + 1, 7);\r\nDEBUGF(fprintf(stderr, "deflatehd: emit indexed index=%zu, %zu bytes\n", idx,\r\nblocklen));\r\nif (sizeof(sb) < blocklen) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nbufp = sb;\r\n*bufp = 0x80u;\r\nencode_length(bufp, idx + 1, 7);\r\nrv = nghttp2_bufs_add(bufs, sb, blocklen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nstatic int emit_string(nghttp2_bufs *bufs, const uint8_t *str, size_t len) {\r\nint rv;\r\nuint8_t sb[16];\r\nuint8_t *bufp;\r\nsize_t blocklen;\r\nsize_t enclen;\r\nint huffman = 0;\r\nenclen = nghttp2_hd_huff_encode_count(str, len);\r\nif (enclen < len) {\r\nhuffman = 1;\r\n} else {\r\nenclen = len;\r\n}\r\nblocklen = count_encoded_length(enclen, 7);\r\nDEBUGF(fprintf(stderr, "deflatehd: emit string str="));\r\nDEBUGF(fwrite(str, len, 1, stderr));\r\nDEBUGF(fprintf(stderr, ", length=%zu, huffman=%d, encoded_length=%zu\n", len,\r\nhuffman, enclen));\r\nif (sizeof(sb) < blocklen) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nbufp = sb;\r\n*bufp = huffman ? 1 << 7 : 0;\r\nencode_length(bufp, enclen, 7);\r\nrv = nghttp2_bufs_add(bufs, sb, blocklen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nif (huffman) {\r\nrv = nghttp2_hd_huff_encode(bufs, str, len);\r\n} else {\r\nassert(enclen == len);\r\nrv = nghttp2_bufs_add(bufs, str, len);\r\n}\r\nreturn rv;\r\n}\r\nstatic uint8_t pack_first_byte(int indexing_mode) {\r\nswitch (indexing_mode) {\r\ncase NGHTTP2_HD_WITH_INDEXING:\r\nreturn 0x40u;\r\ncase NGHTTP2_HD_WITHOUT_INDEXING:\r\nreturn 0;\r\ncase NGHTTP2_HD_NEVER_INDEXING:\r\nreturn 0x10u;\r\ndefault:\r\nassert(0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int emit_indname_block(nghttp2_bufs *bufs, size_t idx,\r\nconst nghttp2_nv *nv, int indexing_mode) {\r\nint rv;\r\nuint8_t *bufp;\r\nsize_t blocklen;\r\nuint8_t sb[16];\r\nsize_t prefixlen;\r\nif (indexing_mode == NGHTTP2_HD_WITH_INDEXING) {\r\nprefixlen = 6;\r\n} else {\r\nprefixlen = 4;\r\n}\r\nDEBUGF(fprintf(stderr, "deflatehd: emit indname index=%zu, valuelen=%zu, "\r\n"indexing_mode=%d\n",\r\nidx, nv->valuelen, indexing_mode));\r\nblocklen = count_encoded_length(idx + 1, prefixlen);\r\nif (sizeof(sb) < blocklen) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nbufp = sb;\r\n*bufp = pack_first_byte(indexing_mode);\r\nencode_length(bufp, idx + 1, prefixlen);\r\nrv = nghttp2_bufs_add(bufs, sb, blocklen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nrv = emit_string(bufs, nv->value, nv->valuelen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nstatic int emit_newname_block(nghttp2_bufs *bufs, const nghttp2_nv *nv,\r\nint indexing_mode) {\r\nint rv;\r\nDEBUGF(fprintf(stderr, "deflatehd: emit newname namelen=%zu, valuelen=%zu, "\r\n"indexing_mode=%d\n",\r\nnv->namelen, nv->valuelen, indexing_mode));\r\nrv = nghttp2_bufs_addb(bufs, pack_first_byte(indexing_mode));\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nrv = emit_string(bufs, nv->name, nv->namelen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nrv = emit_string(bufs, nv->value, nv->valuelen);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nstatic int add_hd_table_incremental(nghttp2_hd_context *context,\r\nnghttp2_hd_nv *nv, nghttp2_hd_map *map,\r\nuint32_t hash) {\r\nint rv;\r\nnghttp2_hd_entry *new_ent;\r\nsize_t room;\r\nnghttp2_mem *mem;\r\nmem = context->mem;\r\nroom = entry_room(nv->name->len, nv->value->len);\r\nwhile (context->hd_table_bufsize + room > context->hd_table_bufsize_max &&\r\ncontext->hd_table.len > 0) {\r\nsize_t idx = context->hd_table.len - 1;\r\nnghttp2_hd_entry *ent = hd_ringbuf_get(&context->hd_table, idx);\r\ncontext->hd_table_bufsize -=\r\nentry_room(ent->nv.name->len, ent->nv.value->len);\r\nDEBUGF(fprintf(stderr, "hpack: remove item from header table: %s: %s\n",\r\n(char *)ent->nv.name->base, (char *)ent->nv.value->base));\r\nhd_ringbuf_pop_back(&context->hd_table);\r\nif (map) {\r\nhd_map_remove(map, ent);\r\n}\r\nnghttp2_hd_entry_free(ent);\r\nnghttp2_mem_free(mem, ent);\r\n}\r\nif (room > context->hd_table_bufsize_max) {\r\nreturn 0;\r\n}\r\nnew_ent = (nghttp2_hd_entry *)nghttp2_mem_malloc(mem, sizeof(nghttp2_hd_entry));\r\nif (new_ent == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nnghttp2_hd_entry_init(new_ent, nv);\r\nrv = hd_ringbuf_push_front(&context->hd_table, new_ent, mem);\r\nif (rv != 0) {\r\nnghttp2_hd_entry_free(new_ent);\r\nnghttp2_mem_free(mem, new_ent);\r\nreturn rv;\r\n}\r\nnew_ent->seq = context->next_seq++;\r\nnew_ent->hash = hash;\r\nif (map) {\r\nhd_map_insert(map, new_ent);\r\n}\r\ncontext->hd_table_bufsize += room;\r\nreturn 0;\r\n}\r\nstatic search_result search_static_table(const nghttp2_nv *nv, int32_t token,\r\nint indexing_mode) {\r\nsearch_result res = {token, 0};\r\nint i;\r\nnghttp2_hd_static_entry *ent;\r\nif (indexing_mode == NGHTTP2_HD_NEVER_INDEXING) {\r\nreturn res;\r\n}\r\nfor (i = token;\r\ni <= NGHTTP2_TOKEN_WWW_AUTHENTICATE && static_table[i].token == token;\r\n++i) {\r\nent = &static_table[i];\r\nif (ent->value.len == nv->valuelen &&\r\nmemcmp(ent->value.base, nv->value, nv->valuelen) == 0) {\r\nres.index = i;\r\nres.name_value_match = 1;\r\nreturn res;\r\n}\r\n}\r\nreturn res;\r\n}\r\nstatic search_result search_hd_table(nghttp2_hd_context *context,\r\nconst nghttp2_nv *nv, int32_t token,\r\nint indexing_mode, nghttp2_hd_map *map,\r\nuint32_t hash) {\r\nsearch_result res = {-1, 0};\r\nnghttp2_hd_entry *ent;\r\nint exact_match;\r\nif (token >= 0 && token <= NGHTTP2_TOKEN_WWW_AUTHENTICATE) {\r\nres = search_static_table(nv, token, indexing_mode);\r\nif (res.name_value_match) {\r\nreturn res;\r\n}\r\n}\r\nexact_match = 0;\r\nent = hd_map_find(map, &exact_match, nv, token, hash);\r\nif (ent == NULL) {\r\nreturn res;\r\n}\r\nif (res.index != -1 && !exact_match) {\r\nreturn res;\r\n}\r\nres.index =\r\n(ssize_t)(context->next_seq - 1 - ent->seq + NGHTTP2_STATIC_TABLE_LENGTH);\r\nif (exact_match) {\r\nres.name_value_match = 1;\r\n}\r\nreturn res;\r\n}\r\nstatic void hd_context_shrink_table_size(nghttp2_hd_context *context,\r\nnghttp2_hd_map *map) {\r\nnghttp2_mem *mem;\r\nmem = context->mem;\r\nwhile (context->hd_table_bufsize > context->hd_table_bufsize_max &&\r\ncontext->hd_table.len > 0) {\r\nsize_t idx = context->hd_table.len - 1;\r\nnghttp2_hd_entry *ent = hd_ringbuf_get(&context->hd_table, idx);\r\ncontext->hd_table_bufsize -=\r\nentry_room(ent->nv.name->len, ent->nv.value->len);\r\nhd_ringbuf_pop_back(&context->hd_table);\r\nif (map) {\r\nhd_map_remove(map, ent);\r\n}\r\nnghttp2_hd_entry_free(ent);\r\nnghttp2_mem_free(mem, ent);\r\n}\r\n}\r\nint nghttp2_hd_deflate_change_table_size(nghttp2_hd_deflater *deflater,\r\nsize_t settings_hd_table_bufsize_max) {\r\nsize_t next_bufsize = nghttp2_min(settings_hd_table_bufsize_max,\r\ndeflater->deflate_hd_table_bufsize_max);\r\ndeflater->ctx.hd_table_bufsize_max = next_bufsize;\r\ndeflater->min_hd_table_bufsize_max =\r\nnghttp2_min(deflater->min_hd_table_bufsize_max, next_bufsize);\r\ndeflater->notify_table_size_change = 1;\r\nhd_context_shrink_table_size(&deflater->ctx, &deflater->map);\r\nreturn 0;\r\n}\r\nint nghttp2_hd_inflate_change_table_size(nghttp2_hd_inflater *inflater,\r\nsize_t settings_hd_table_bufsize_max) {\r\nswitch (inflater->state) {\r\ncase NGHTTP2_HD_STATE_EXPECT_TABLE_SIZE:\r\ncase NGHTTP2_HD_STATE_INFLATE_START:\r\nbreak;\r\ndefault:\r\nreturn NGHTTP2_ERR_INVALID_STATE;\r\n}\r\nif (inflater->ctx.hd_table_bufsize_max > settings_hd_table_bufsize_max) {\r\ninflater->state = NGHTTP2_HD_STATE_EXPECT_TABLE_SIZE;\r\ninflater->min_hd_table_bufsize_max = settings_hd_table_bufsize_max;\r\n}\r\ninflater->settings_hd_table_bufsize_max = settings_hd_table_bufsize_max;\r\ninflater->ctx.hd_table_bufsize_max = settings_hd_table_bufsize_max;\r\nhd_context_shrink_table_size(&inflater->ctx, NULL);\r\nreturn 0;\r\n}\r\nstatic size_t get_max_index(nghttp2_hd_context *context) {\r\nreturn context->hd_table.len + NGHTTP2_STATIC_TABLE_LENGTH - 1;\r\n}\r\nnghttp2_hd_nv nghttp2_hd_table_get(nghttp2_hd_context *context, size_t idx) {\r\nassert(INDEX_RANGE_VALID(context, idx));\r\nif (idx >= NGHTTP2_STATIC_TABLE_LENGTH) {\r\nreturn hd_ringbuf_get(&context->hd_table, idx - NGHTTP2_STATIC_TABLE_LENGTH)\r\n->nv;\r\n} else {\r\nnghttp2_hd_static_entry *ent = &static_table[idx];\r\nnghttp2_hd_nv nv = {&ent->name, &ent->value, ent->token,\r\nNGHTTP2_NV_FLAG_NONE};\r\nreturn nv;\r\n}\r\n}\r\nstatic const nghttp2_nv *nghttp2_hd_table_get2(nghttp2_hd_context *context,\r\nsize_t idx) {\r\nassert(INDEX_RANGE_VALID(context, idx));\r\nif (idx >= NGHTTP2_STATIC_TABLE_LENGTH) {\r\nreturn &hd_ringbuf_get(&context->hd_table,\r\nidx - NGHTTP2_STATIC_TABLE_LENGTH)->cnv;\r\n}\r\nreturn &static_table[idx].cnv;\r\n}\r\nstatic int hd_deflate_decide_indexing(nghttp2_hd_deflater *deflater,\r\nconst nghttp2_nv *nv, int32_t token) {\r\nif (token == NGHTTP2_TOKEN__PATH || token == NGHTTP2_TOKEN_AGE ||\r\ntoken == NGHTTP2_TOKEN_CONTENT_LENGTH || token == NGHTTP2_TOKEN_ETAG ||\r\ntoken == NGHTTP2_TOKEN_IF_MODIFIED_SINCE ||\r\ntoken == NGHTTP2_TOKEN_IF_NONE_MATCH || token == NGHTTP2_TOKEN_LOCATION ||\r\ntoken == NGHTTP2_TOKEN_SET_COOKIE ||\r\nentry_room(nv->namelen, nv->valuelen) >\r\ndeflater->ctx.hd_table_bufsize_max * 3 / 4) {\r\nreturn NGHTTP2_HD_WITHOUT_INDEXING;\r\n}\r\nreturn NGHTTP2_HD_WITH_INDEXING;\r\n}\r\nstatic int deflate_nv(nghttp2_hd_deflater *deflater, nghttp2_bufs *bufs,\r\nconst nghttp2_nv *nv) {\r\nint rv;\r\nsearch_result res;\r\nssize_t idx;\r\nint indexing_mode;\r\nint32_t token;\r\nnghttp2_mem *mem;\r\nuint32_t hash = 0;\r\nDEBUGF(fprintf(stderr, "deflatehd: deflating %.*s: %.*s\n", (int)nv->namelen,\r\nnv->name, (int)nv->valuelen, nv->value));\r\nmem = deflater->ctx.mem;\r\ntoken = lookup_token(nv->name, nv->namelen);\r\nif (token == -1) {\r\nhash = name_hash(nv);\r\n} else if (token <= NGHTTP2_TOKEN_WWW_AUTHENTICATE) {\r\nhash = static_table[token].hash;\r\n}\r\nindexing_mode =\r\ntoken == NGHTTP2_TOKEN_AUTHORIZATION ||\r\n(token == NGHTTP2_TOKEN_COOKIE && nv->valuelen < 20) ||\r\n(nv->flags & NGHTTP2_NV_FLAG_NO_INDEX)\r\n? NGHTTP2_HD_NEVER_INDEXING\r\n: hd_deflate_decide_indexing(deflater, nv, token);\r\nres = search_hd_table(&deflater->ctx, nv, token, indexing_mode,\r\n&deflater->map, hash);\r\nidx = res.index;\r\nif (res.name_value_match) {\r\nDEBUGF(fprintf(stderr, "deflatehd: name/value match index=%zd\n", idx));\r\nrv = emit_indexed_block(bufs, (size_t)idx);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nif (res.index != -1) {\r\nDEBUGF(fprintf(stderr, "deflatehd: name match index=%zd\n", res.index));\r\n}\r\nif (indexing_mode == NGHTTP2_HD_WITH_INDEXING) {\r\nnghttp2_hd_nv hd_nv;\r\nif (idx != -1 && idx < (ssize_t)NGHTTP2_STATIC_TABLE_LENGTH) {\r\nhd_nv.name = nghttp2_hd_table_get(&deflater->ctx, (size_t)idx).name;\r\nnghttp2_rcbuf_incref(hd_nv.name);\r\n} else {\r\nrv = nghttp2_rcbuf_new2(&hd_nv.name, nv->name, nv->namelen, mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n}\r\nrv = nghttp2_rcbuf_new2(&hd_nv.value, nv->value, nv->valuelen, mem);\r\nif (rv != 0) {\r\nnghttp2_rcbuf_decref(hd_nv.name);\r\nreturn rv;\r\n}\r\nhd_nv.token = token;\r\nhd_nv.flags = NGHTTP2_NV_FLAG_NONE;\r\nrv = add_hd_table_incremental(&deflater->ctx, &hd_nv, &deflater->map, hash);\r\nnghttp2_rcbuf_decref(hd_nv.value);\r\nnghttp2_rcbuf_decref(hd_nv.name);\r\nif (rv != 0) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\n}\r\nif (idx == -1) {\r\nrv = emit_newname_block(bufs, nv, indexing_mode);\r\n} else {\r\nrv = emit_indname_block(bufs, (size_t)idx, nv, indexing_mode);\r\n}\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nint nghttp2_hd_deflate_hd_bufs(nghttp2_hd_deflater *deflater,\r\nnghttp2_bufs *bufs, const nghttp2_nv *nv,\r\nsize_t nvlen) {\r\nsize_t i;\r\nint rv = 0;\r\nif (deflater->ctx.bad) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nif (deflater->notify_table_size_change) {\r\nsize_t min_hd_table_bufsize_max;\r\nmin_hd_table_bufsize_max = deflater->min_hd_table_bufsize_max;\r\ndeflater->notify_table_size_change = 0;\r\ndeflater->min_hd_table_bufsize_max = UINT32_MAX;\r\nif (deflater->ctx.hd_table_bufsize_max > min_hd_table_bufsize_max) {\r\nrv = emit_table_size(bufs, min_hd_table_bufsize_max);\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\n}\r\nrv = emit_table_size(bufs, deflater->ctx.hd_table_bufsize_max);\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\n}\r\nfor (i = 0; i < nvlen; ++i) {\r\nrv = deflate_nv(deflater, bufs, &nv[i]);\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\n}\r\nDEBUGF(\r\nfprintf(stderr, "deflatehd: all input name/value pairs were deflated\n"));\r\nreturn 0;\r\nfail:\r\nDEBUGF(fprintf(stderr, "deflatehd: error return %d\n", rv));\r\ndeflater->ctx.bad = 1;\r\nreturn rv;\r\n}\r\nssize_t nghttp2_hd_deflate_hd(nghttp2_hd_deflater *deflater, uint8_t *buf,\r\nsize_t buflen, const nghttp2_nv *nv,\r\nsize_t nvlen) {\r\nnghttp2_bufs bufs;\r\nint rv;\r\nnghttp2_mem *mem;\r\nmem = deflater->ctx.mem;\r\nrv = nghttp2_bufs_wrap_init(&bufs, buf, buflen, mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nrv = nghttp2_hd_deflate_hd_bufs(deflater, &bufs, nv, nvlen);\r\nbuflen = nghttp2_bufs_len(&bufs);\r\nnghttp2_bufs_wrap_free(&bufs);\r\nif (rv == NGHTTP2_ERR_BUFFER_ERROR) {\r\nreturn NGHTTP2_ERR_INSUFF_BUFSIZE;\r\n}\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn (ssize_t)buflen;\r\n}\r\nsize_t nghttp2_hd_deflate_bound(nghttp2_hd_deflater *deflater _U_,\r\nconst nghttp2_nv *nva, size_t nvlen) {\r\nsize_t n = 0;\r\nsize_t i;\r\nn += 12;\r\nn += 6 * 2 * nvlen;\r\nfor (i = 0; i < nvlen; ++i) {\r\nn += nva[i].namelen + nva[i].valuelen;\r\n}\r\nreturn n;\r\n}\r\nint nghttp2_hd_deflate_new(nghttp2_hd_deflater **deflater_ptr,\r\nsize_t deflate_hd_table_bufsize_max) {\r\nreturn nghttp2_hd_deflate_new2(deflater_ptr, deflate_hd_table_bufsize_max,\r\nNULL);\r\n}\r\nint nghttp2_hd_deflate_new2(nghttp2_hd_deflater **deflater_ptr,\r\nsize_t deflate_hd_table_bufsize_max,\r\nnghttp2_mem *mem) {\r\nint rv;\r\nnghttp2_hd_deflater *deflater;\r\nif (mem == NULL) {\r\nmem = nghttp2_mem_default();\r\n}\r\ndeflater = (nghttp2_hd_deflater *)nghttp2_mem_malloc(mem, sizeof(nghttp2_hd_deflater));\r\nif (deflater == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nrv = nghttp2_hd_deflate_init2(deflater, deflate_hd_table_bufsize_max, mem);\r\nif (rv != 0) {\r\nnghttp2_mem_free(mem, deflater);\r\nreturn rv;\r\n}\r\n*deflater_ptr = deflater;\r\nreturn 0;\r\n}\r\nvoid nghttp2_hd_deflate_del(nghttp2_hd_deflater *deflater) {\r\nnghttp2_mem *mem;\r\nmem = deflater->ctx.mem;\r\nnghttp2_hd_deflate_free(deflater);\r\nnghttp2_mem_free(mem, deflater);\r\n}\r\nstatic void hd_inflate_set_huffman_encoded(nghttp2_hd_inflater *inflater,\r\nconst uint8_t *in) {\r\ninflater->huffman_encoded = (*in & (1 << 7)) != 0;\r\n}\r\nstatic ssize_t hd_inflate_read_len(nghttp2_hd_inflater *inflater, int *rfin,\r\nconst uint8_t *in, const uint8_t *last,\r\nsize_t prefix, size_t maxlen) {\r\nssize_t rv;\r\nuint32_t out;\r\n*rfin = 0;\r\nrv = decode_length(&out, &inflater->shift, rfin, (uint32_t)inflater->left,\r\ninflater->shift, in, last, prefix);\r\nif (rv == -1) {\r\nDEBUGF(fprintf(stderr, "inflatehd: integer decoding failed\n"));\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nif (out > maxlen) {\r\nDEBUGF(fprintf(\r\nstderr, "inflatehd: integer exceeded the maximum value %zu\n", maxlen));\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\ninflater->left = out;\r\nDEBUGF(fprintf(stderr, "inflatehd: decoded integer is %u\n", out));\r\nreturn rv;\r\n}\r\nstatic ssize_t hd_inflate_read_huff(nghttp2_hd_inflater *inflater,\r\nnghttp2_buf *buf, const uint8_t *in,\r\nconst uint8_t *last) {\r\nssize_t readlen;\r\nint final = 0;\r\nif ((size_t)(last - in) >= inflater->left) {\r\nlast = in + inflater->left;\r\nfinal = 1;\r\n}\r\nreadlen = nghttp2_hd_huff_decode(&inflater->huff_decode_ctx, buf, in,\r\n(size_t)(last - in), final);\r\nif (readlen < 0) {\r\nDEBUGF(fprintf(stderr, "inflatehd: huffman decoding failed\n"));\r\nreturn readlen;\r\n}\r\ninflater->left -= (size_t)readlen;\r\nreturn readlen;\r\n}\r\nstatic ssize_t hd_inflate_read(nghttp2_hd_inflater *inflater, nghttp2_buf *buf,\r\nconst uint8_t *in, const uint8_t *last) {\r\nsize_t len = nghttp2_min((size_t)(last - in), inflater->left);\r\nbuf->last = nghttp2_cpymem(buf->last, in, len);\r\ninflater->left -= len;\r\nreturn (ssize_t)len;\r\n}\r\nstatic int hd_inflate_commit_indexed(nghttp2_hd_inflater *inflater,\r\nnghttp2_hd_nv *nv_out) {\r\nnghttp2_hd_nv nv = nghttp2_hd_table_get(&inflater->ctx, inflater->index);\r\nemit_header(nv_out, &nv);\r\nreturn 0;\r\n}\r\nstatic int hd_inflate_commit_newname(nghttp2_hd_inflater *inflater,\r\nnghttp2_hd_nv *nv_out) {\r\nnghttp2_hd_nv nv;\r\nint rv;\r\nif (inflater->no_index) {\r\nnv.flags = NGHTTP2_NV_FLAG_NO_INDEX;\r\n} else {\r\nnv.flags = NGHTTP2_NV_FLAG_NONE;\r\n}\r\nnv.name = inflater->namercbuf;\r\nnv.value = inflater->valuercbuf;\r\nnv.token = lookup_token(inflater->namercbuf->base, inflater->namercbuf->len);\r\nif (inflater->index_required) {\r\nrv = add_hd_table_incremental(&inflater->ctx, &nv, NULL, 0);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n}\r\nemit_header(nv_out, &nv);\r\ninflater->nv_name_keep = nv.name;\r\ninflater->nv_value_keep = nv.value;\r\ninflater->namercbuf = NULL;\r\ninflater->valuercbuf = NULL;\r\nreturn 0;\r\n}\r\nstatic int hd_inflate_commit_indname(nghttp2_hd_inflater *inflater,\r\nnghttp2_hd_nv *nv_out) {\r\nnghttp2_hd_nv nv;\r\nint rv;\r\nnv = nghttp2_hd_table_get(&inflater->ctx, inflater->index);\r\nif (inflater->no_index) {\r\nnv.flags = NGHTTP2_NV_FLAG_NO_INDEX;\r\n} else {\r\nnv.flags = NGHTTP2_NV_FLAG_NONE;\r\n}\r\nnghttp2_rcbuf_incref(nv.name);\r\nnv.value = inflater->valuercbuf;\r\nif (inflater->index_required) {\r\nrv = add_hd_table_incremental(&inflater->ctx, &nv, NULL, 0);\r\nif (rv != 0) {\r\nnghttp2_rcbuf_decref(nv.name);\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\n}\r\nemit_header(nv_out, &nv);\r\ninflater->nv_name_keep = nv.name;\r\ninflater->nv_value_keep = nv.value;\r\ninflater->valuercbuf = NULL;\r\nreturn 0;\r\n}\r\nssize_t nghttp2_hd_inflate_hd(nghttp2_hd_inflater *inflater, nghttp2_nv *nv_out,\r\nint *inflate_flags, uint8_t *in, size_t inlen,\r\nint in_final) {\r\nreturn nghttp2_hd_inflate_hd2(inflater, nv_out, inflate_flags, in, inlen,\r\nin_final);\r\n}\r\nssize_t nghttp2_hd_inflate_hd2(nghttp2_hd_inflater *inflater,\r\nnghttp2_nv *nv_out, int *inflate_flags,\r\nconst uint8_t *in, size_t inlen, int in_final) {\r\nssize_t rv;\r\nnghttp2_hd_nv hd_nv;\r\nrv = nghttp2_hd_inflate_hd_nv(inflater, &hd_nv, inflate_flags, in, inlen,\r\nin_final);\r\nif (rv < 0) {\r\nreturn rv;\r\n}\r\nif (*inflate_flags & NGHTTP2_HD_INFLATE_EMIT) {\r\nnv_out->name = hd_nv.name->base;\r\nnv_out->namelen = hd_nv.name->len;\r\nnv_out->value = hd_nv.value->base;\r\nnv_out->valuelen = hd_nv.value->len;\r\nnv_out->flags = hd_nv.flags;\r\n}\r\nreturn rv;\r\n}\r\nssize_t nghttp2_hd_inflate_hd_nv(nghttp2_hd_inflater *inflater,\r\nnghttp2_hd_nv *nv_out, int *inflate_flags,\r\nconst uint8_t *in, size_t inlen,\r\nint in_final) {\r\nssize_t rv = 0;\r\nconst uint8_t *first = in;\r\nconst uint8_t *last = in + inlen;\r\nint rfin = 0;\r\nint busy = 0;\r\nnghttp2_mem *mem;\r\nmem = inflater->ctx.mem;\r\nif (inflater->ctx.bad) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nDEBUGF(fprintf(stderr, "inflatehd: start state=%d\n", inflater->state));\r\nhd_inflate_keep_free(inflater);\r\n*inflate_flags = NGHTTP2_HD_INFLATE_NONE;\r\nfor (; in != last || busy;) {\r\nbusy = 0;\r\nswitch (inflater->state) {\r\ncase NGHTTP2_HD_STATE_EXPECT_TABLE_SIZE:\r\nif ((*in & 0xe0u) != 0x20u) {\r\nDEBUGF(fprintf(stderr, "inflatehd: header table size change was "\r\n"expected, but saw 0x%02x as first byte",\r\n*in));\r\nrv = NGHTTP2_ERR_HEADER_COMP;\r\ngoto fail;\r\n}\r\ncase NGHTTP2_HD_STATE_INFLATE_START:\r\ncase NGHTTP2_HD_STATE_OPCODE:\r\nif ((*in & 0xe0u) == 0x20u) {\r\nDEBUGF(fprintf(stderr, "inflatehd: header table size change\n"));\r\nif (inflater->state == NGHTTP2_HD_STATE_OPCODE) {\r\nDEBUGF(fprintf(stderr, "inflatehd: header table size change must "\r\n"appear at the head of header block\n"));\r\nrv = NGHTTP2_ERR_HEADER_COMP;\r\ngoto fail;\r\n}\r\ninflater->opcode = NGHTTP2_HD_OPCODE_INDEXED;\r\ninflater->state = NGHTTP2_HD_STATE_READ_TABLE_SIZE;\r\n} else if (*in & 0x80u) {\r\nDEBUGF(fprintf(stderr, "inflatehd: indexed repr\n"));\r\ninflater->opcode = NGHTTP2_HD_OPCODE_INDEXED;\r\ninflater->state = NGHTTP2_HD_STATE_READ_INDEX;\r\n} else {\r\nif (*in == 0x40u || *in == 0 || *in == 0x10u) {\r\nDEBUGF(\r\nfprintf(stderr, "inflatehd: literal header repr - new name\n"));\r\ninflater->opcode = NGHTTP2_HD_OPCODE_NEWNAME;\r\ninflater->state = NGHTTP2_HD_STATE_NEWNAME_CHECK_NAMELEN;\r\n} else {\r\nDEBUGF(fprintf(stderr,\r\n"inflatehd: literal header repr - indexed name\n"));\r\ninflater->opcode = NGHTTP2_HD_OPCODE_INDNAME;\r\ninflater->state = NGHTTP2_HD_STATE_READ_INDEX;\r\n}\r\ninflater->index_required = (*in & 0x40) != 0;\r\ninflater->no_index = (*in & 0xf0u) == 0x10u;\r\nDEBUGF(fprintf(stderr, "inflatehd: indexing required=%d, no_index=%d\n",\r\ninflater->index_required, inflater->no_index));\r\nif (inflater->opcode == NGHTTP2_HD_OPCODE_NEWNAME) {\r\n++in;\r\n}\r\n}\r\ninflater->left = 0;\r\ninflater->shift = 0;\r\nbreak;\r\ncase NGHTTP2_HD_STATE_READ_TABLE_SIZE:\r\nrfin = 0;\r\nrv = hd_inflate_read_len(\r\ninflater, &rfin, in, last, 5,\r\nnghttp2_min(inflater->min_hd_table_bufsize_max,\r\ninflater->settings_hd_table_bufsize_max));\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nif (!rfin) {\r\ngoto almost_ok;\r\n}\r\nDEBUGF(fprintf(stderr, "inflatehd: table_size=%zu\n", inflater->left));\r\ninflater->min_hd_table_bufsize_max = UINT32_MAX;\r\ninflater->ctx.hd_table_bufsize_max = inflater->left;\r\nhd_context_shrink_table_size(&inflater->ctx, NULL);\r\ninflater->state = NGHTTP2_HD_STATE_INFLATE_START;\r\nbreak;\r\ncase NGHTTP2_HD_STATE_READ_INDEX: {\r\nsize_t prefixlen;\r\nif (inflater->opcode == NGHTTP2_HD_OPCODE_INDEXED) {\r\nprefixlen = 7;\r\n} else if (inflater->index_required) {\r\nprefixlen = 6;\r\n} else {\r\nprefixlen = 4;\r\n}\r\nrfin = 0;\r\nrv = hd_inflate_read_len(inflater, &rfin, in, last, prefixlen,\r\nget_max_index(&inflater->ctx) + 1);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nif (!rfin) {\r\ngoto almost_ok;\r\n}\r\nif (inflater->left == 0) {\r\nrv = NGHTTP2_ERR_HEADER_COMP;\r\ngoto fail;\r\n}\r\nDEBUGF(fprintf(stderr, "inflatehd: index=%zu\n", inflater->left));\r\nif (inflater->opcode == NGHTTP2_HD_OPCODE_INDEXED) {\r\ninflater->index = inflater->left;\r\n--inflater->index;\r\nrv = hd_inflate_commit_indexed(inflater, nv_out);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\ninflater->state = NGHTTP2_HD_STATE_OPCODE;\r\nif (rv == 0) {\r\n*inflate_flags |= NGHTTP2_HD_INFLATE_EMIT;\r\nreturn (ssize_t)(in - first);\r\n}\r\n} else {\r\ninflater->index = inflater->left;\r\n--inflater->index;\r\ninflater->state = NGHTTP2_HD_STATE_CHECK_VALUELEN;\r\n}\r\nbreak;\r\n}\r\ncase NGHTTP2_HD_STATE_NEWNAME_CHECK_NAMELEN:\r\nhd_inflate_set_huffman_encoded(inflater, in);\r\ninflater->state = NGHTTP2_HD_STATE_NEWNAME_READ_NAMELEN;\r\ninflater->left = 0;\r\ninflater->shift = 0;\r\nDEBUGF(fprintf(stderr, "inflatehd: huffman encoded=%d\n",\r\ninflater->huffman_encoded != 0));\r\ncase NGHTTP2_HD_STATE_NEWNAME_READ_NAMELEN:\r\nrfin = 0;\r\nrv = hd_inflate_read_len(inflater, &rfin, in, last, 7, NGHTTP2_HD_MAX_NV);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nif (!rfin) {\r\nDEBUGF(fprintf(stderr,\r\n"inflatehd: integer not fully decoded. current=%zu\n",\r\ninflater->left));\r\ngoto almost_ok;\r\n}\r\nif (inflater->huffman_encoded) {\r\nnghttp2_hd_huff_decode_context_init(&inflater->huff_decode_ctx);\r\ninflater->state = NGHTTP2_HD_STATE_NEWNAME_READ_NAMEHUFF;\r\nrv = nghttp2_rcbuf_new(&inflater->namercbuf, inflater->left * 2 + 1,\r\nmem);\r\n} else {\r\ninflater->state = NGHTTP2_HD_STATE_NEWNAME_READ_NAME;\r\nrv = nghttp2_rcbuf_new(&inflater->namercbuf, inflater->left + 1, mem);\r\n}\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\nnghttp2_buf_wrap_init(&inflater->namebuf, inflater->namercbuf->base,\r\ninflater->namercbuf->len);\r\nbreak;\r\ncase NGHTTP2_HD_STATE_NEWNAME_READ_NAMEHUFF:\r\nrv = hd_inflate_read_huff(inflater, &inflater->namebuf, in, last);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nDEBUGF(fprintf(stderr, "inflatehd: %zd bytes read\n", rv));\r\nif (inflater->left) {\r\nDEBUGF(fprintf(stderr, "inflatehd: still %zu bytes to go\n",\r\ninflater->left));\r\ngoto almost_ok;\r\n}\r\n*inflater->namebuf.last = '\0';\r\ninflater->namercbuf->len = nghttp2_buf_len(&inflater->namebuf);\r\ninflater->state = NGHTTP2_HD_STATE_CHECK_VALUELEN;\r\nbreak;\r\ncase NGHTTP2_HD_STATE_NEWNAME_READ_NAME:\r\nrv = hd_inflate_read(inflater, &inflater->namebuf, in, last);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nDEBUGF(fprintf(stderr, "inflatehd: %zd bytes read\n", rv));\r\nif (inflater->left) {\r\nDEBUGF(fprintf(stderr, "inflatehd: still %zu bytes to go\n",\r\ninflater->left));\r\ngoto almost_ok;\r\n}\r\n*inflater->namebuf.last = '\0';\r\ninflater->namercbuf->len = nghttp2_buf_len(&inflater->namebuf);\r\ninflater->state = NGHTTP2_HD_STATE_CHECK_VALUELEN;\r\nbreak;\r\ncase NGHTTP2_HD_STATE_CHECK_VALUELEN:\r\nhd_inflate_set_huffman_encoded(inflater, in);\r\ninflater->state = NGHTTP2_HD_STATE_READ_VALUELEN;\r\ninflater->left = 0;\r\ninflater->shift = 0;\r\nDEBUGF(fprintf(stderr, "inflatehd: huffman encoded=%d\n",\r\ninflater->huffman_encoded != 0));\r\ncase NGHTTP2_HD_STATE_READ_VALUELEN:\r\nrfin = 0;\r\nrv = hd_inflate_read_len(inflater, &rfin, in, last, 7, NGHTTP2_HD_MAX_NV);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nif (!rfin) {\r\ngoto almost_ok;\r\n}\r\nDEBUGF(fprintf(stderr, "inflatehd: valuelen=%zu\n", inflater->left));\r\nif (inflater->huffman_encoded) {\r\nnghttp2_hd_huff_decode_context_init(&inflater->huff_decode_ctx);\r\ninflater->state = NGHTTP2_HD_STATE_READ_VALUEHUFF;\r\nrv = nghttp2_rcbuf_new(&inflater->valuercbuf, inflater->left * 2 + 1,\r\nmem);\r\n} else {\r\ninflater->state = NGHTTP2_HD_STATE_READ_VALUE;\r\nrv = nghttp2_rcbuf_new(&inflater->valuercbuf, inflater->left + 1, mem);\r\n}\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\nnghttp2_buf_wrap_init(&inflater->valuebuf, inflater->valuercbuf->base,\r\ninflater->valuercbuf->len);\r\nbusy = 1;\r\nbreak;\r\ncase NGHTTP2_HD_STATE_READ_VALUEHUFF:\r\nrv = hd_inflate_read_huff(inflater, &inflater->valuebuf, in, last);\r\nif (rv < 0) {\r\ngoto fail;\r\n}\r\nin += rv;\r\nDEBUGF(fprintf(stderr, "inflatehd: %zd bytes read\n", rv));\r\nif (inflater->left) {\r\nDEBUGF(fprintf(stderr, "inflatehd: still %zu bytes to go\n",\r\ninflater->left));\r\ngoto almost_ok;\r\n}\r\n*inflater->valuebuf.last = '\0';\r\ninflater->valuercbuf->len = nghttp2_buf_len(&inflater->valuebuf);\r\nif (inflater->opcode == NGHTTP2_HD_OPCODE_NEWNAME) {\r\nrv = hd_inflate_commit_newname(inflater, nv_out);\r\n} else {\r\nrv = hd_inflate_commit_indname(inflater, nv_out);\r\n}\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\ninflater->state = NGHTTP2_HD_STATE_OPCODE;\r\n*inflate_flags |= NGHTTP2_HD_INFLATE_EMIT;\r\nreturn (ssize_t)(in - first);\r\ncase NGHTTP2_HD_STATE_READ_VALUE:\r\nrv = hd_inflate_read(inflater, &inflater->valuebuf, in, last);\r\nif (rv < 0) {\r\nDEBUGF(fprintf(stderr, "inflatehd: value read failure %zd: %s\n", rv,\r\nnghttp2_strerror((int)rv)));\r\ngoto fail;\r\n}\r\nin += rv;\r\nDEBUGF(fprintf(stderr, "inflatehd: %zd bytes read\n", rv));\r\nif (inflater->left) {\r\nDEBUGF(fprintf(stderr, "inflatehd: still %zu bytes to go\n",\r\ninflater->left));\r\ngoto almost_ok;\r\n}\r\n*inflater->valuebuf.last = '\0';\r\ninflater->valuercbuf->len = nghttp2_buf_len(&inflater->valuebuf);\r\nif (inflater->opcode == NGHTTP2_HD_OPCODE_NEWNAME) {\r\nrv = hd_inflate_commit_newname(inflater, nv_out);\r\n} else {\r\nrv = hd_inflate_commit_indname(inflater, nv_out);\r\n}\r\nif (rv != 0) {\r\ngoto fail;\r\n}\r\ninflater->state = NGHTTP2_HD_STATE_OPCODE;\r\n*inflate_flags |= NGHTTP2_HD_INFLATE_EMIT;\r\nreturn (ssize_t)(in - first);\r\n}\r\n}\r\nassert(in == last);\r\nDEBUGF(fprintf(stderr, "inflatehd: all input bytes were processed\n"));\r\nif (in_final) {\r\nDEBUGF(fprintf(stderr, "inflatehd: in_final set\n"));\r\nif (inflater->state != NGHTTP2_HD_STATE_OPCODE &&\r\ninflater->state != NGHTTP2_HD_STATE_INFLATE_START) {\r\nDEBUGF(fprintf(stderr, "inflatehd: unacceptable state=%d\n",\r\ninflater->state));\r\nrv = NGHTTP2_ERR_HEADER_COMP;\r\ngoto fail;\r\n}\r\n*inflate_flags |= NGHTTP2_HD_INFLATE_FINAL;\r\n}\r\nreturn (ssize_t)(in - first);\r\nalmost_ok:\r\nif (in_final) {\r\nDEBUGF(fprintf(stderr, "inflatehd: input ended prematurely\n"));\r\nrv = NGHTTP2_ERR_HEADER_COMP;\r\ngoto fail;\r\n}\r\nreturn (ssize_t)(in - first);\r\nfail:\r\nDEBUGF(fprintf(stderr, "inflatehd: error return %zd\n", rv));\r\ninflater->ctx.bad = 1;\r\nreturn rv;\r\n}\r\nint nghttp2_hd_inflate_end_headers(nghttp2_hd_inflater *inflater) {\r\nhd_inflate_keep_free(inflater);\r\ninflater->state = NGHTTP2_HD_STATE_INFLATE_START;\r\nreturn 0;\r\n}\r\nint nghttp2_hd_inflate_new(nghttp2_hd_inflater **inflater_ptr) {\r\nreturn nghttp2_hd_inflate_new2(inflater_ptr, NULL);\r\n}\r\nint nghttp2_hd_inflate_new2(nghttp2_hd_inflater **inflater_ptr,\r\nnghttp2_mem *mem) {\r\nint rv;\r\nnghttp2_hd_inflater *inflater;\r\nif (mem == NULL) {\r\nmem = nghttp2_mem_default();\r\n}\r\ninflater = (nghttp2_hd_inflater *)nghttp2_mem_malloc(mem, sizeof(nghttp2_hd_inflater));\r\nif (inflater == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nrv = nghttp2_hd_inflate_init(inflater, mem);\r\nif (rv != 0) {\r\nnghttp2_mem_free(mem, inflater);\r\nreturn rv;\r\n}\r\n*inflater_ptr = inflater;\r\nreturn 0;\r\n}\r\nvoid nghttp2_hd_inflate_del(nghttp2_hd_inflater *inflater) {\r\nnghttp2_mem *mem;\r\nmem = inflater->ctx.mem;\r\nnghttp2_hd_inflate_free(inflater);\r\nnghttp2_mem_free(mem, inflater);\r\n}\r\nint nghttp2_hd_emit_indname_block(nghttp2_bufs *bufs, size_t idx,\r\nnghttp2_nv *nv, int indexing_mode) {\r\nreturn emit_indname_block(bufs, idx, nv, indexing_mode);\r\n}\r\nint nghttp2_hd_emit_newname_block(nghttp2_bufs *bufs, nghttp2_nv *nv,\r\nint indexing_mode) {\r\nreturn emit_newname_block(bufs, nv, indexing_mode);\r\n}\r\nint nghttp2_hd_emit_table_size(nghttp2_bufs *bufs, size_t table_size) {\r\nreturn emit_table_size(bufs, table_size);\r\n}\r\nssize_t nghttp2_hd_decode_length(uint32_t *res, size_t *shift_ptr, int *final,\r\nuint32_t initial, size_t shift, uint8_t *in,\r\nuint8_t *last, size_t prefix) {\r\nreturn decode_length(res, shift_ptr, final, initial, shift, in, last, prefix);\r\n}\r\nstatic size_t hd_get_num_table_entries(nghttp2_hd_context *context) {\r\nreturn context->hd_table.len + NGHTTP2_STATIC_TABLE_LENGTH;\r\n}\r\nstatic const nghttp2_nv *hd_get_table_entry(nghttp2_hd_context *context,\r\nsize_t idx) {\r\nif (idx == 0) {\r\nreturn NULL;\r\n}\r\n--idx;\r\nif (!INDEX_RANGE_VALID(context, idx)) {\r\nreturn NULL;\r\n}\r\nreturn nghttp2_hd_table_get2(context, idx);\r\n}\r\nsize_t nghttp2_hd_deflate_get_num_table_entries(nghttp2_hd_deflater *deflater) {\r\nreturn hd_get_num_table_entries(&deflater->ctx);\r\n}\r\nconst nghttp2_nv *\r\nnghttp2_hd_deflate_get_table_entry(nghttp2_hd_deflater *deflater, size_t idx) {\r\nreturn hd_get_table_entry(&deflater->ctx, idx);\r\n}\r\nsize_t\r\nnghttp2_hd_deflate_get_dynamic_table_size(nghttp2_hd_deflater *deflater) {\r\nreturn deflater->ctx.hd_table_bufsize;\r\n}\r\nsize_t\r\nnghttp2_hd_deflate_get_max_dynamic_table_size(nghttp2_hd_deflater *deflater) {\r\nreturn deflater->ctx.hd_table_bufsize_max;\r\n}\r\nsize_t nghttp2_hd_inflate_get_num_table_entries(nghttp2_hd_inflater *inflater) {\r\nreturn hd_get_num_table_entries(&inflater->ctx);\r\n}\r\nconst nghttp2_nv *\r\nnghttp2_hd_inflate_get_table_entry(nghttp2_hd_inflater *inflater, size_t idx) {\r\nreturn hd_get_table_entry(&inflater->ctx, idx);\r\n}\r\nsize_t\r\nnghttp2_hd_inflate_get_dynamic_table_size(nghttp2_hd_inflater *inflater) {\r\nreturn inflater->ctx.hd_table_bufsize;\r\n}\r\nsize_t\r\nnghttp2_hd_inflate_get_max_dynamic_table_size(nghttp2_hd_inflater *inflater) {\r\nreturn inflater->ctx.hd_table_bufsize_max;\r\n}

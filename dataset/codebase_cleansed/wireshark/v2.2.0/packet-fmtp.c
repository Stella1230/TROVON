static int\r\ndissect_fmtp_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 packet_type;\r\nguint16 packet_len;\r\ntvbuff_t *next_tvb;\r\nproto_item *ti = NULL;\r\nproto_tree *fmtp_tree = NULL;\r\npacket_type = tvb_get_guint8(tvb, 4);\r\npacket_len = tvb_get_ntohs(tvb, 2);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "FMTP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_fmtp, tvb, 0, -1, ENC_NA);\r\nproto_item_append_text(ti, ", %s",\r\nval_to_str(packet_type, packet_type_names, "Unknown (0x%02x)"));\r\nswitch (packet_type) {\r\ncase FMTP_TYP_IDENTIFICATION:\r\nproto_item_append_text(ti, " (%s)",\r\ntvb_get_string_enc(wmem_packet_scope(), tvb, FMTP_HEADER_LEN, packet_len-FMTP_HEADER_LEN, ENC_ASCII));\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s (%s)",\r\nval_to_str(packet_type, packet_type_names, "Unknown (0x%02x)"),\r\ntvb_get_string_enc(wmem_packet_scope(), tvb, FMTP_HEADER_LEN, packet_len-FMTP_HEADER_LEN, ENC_ASCII));\r\nbreak;\r\ncase FMTP_TYP_SYSTEM:\r\nproto_item_append_text(ti, " (%s)",\r\ntvb_get_string_enc(wmem_packet_scope(), tvb, FMTP_HEADER_LEN, packet_len-FMTP_HEADER_LEN, ENC_ASCII));\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s (%s)",\r\nval_to_str(packet_type, packet_type_names, "Unknown (0x%02x)"),\r\nval_to_str(tvb_get_ntohs(tvb, FMTP_HEADER_LEN), system_message_names, "Unknown (0x%02x)"));\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s",\r\nval_to_str(packet_type, packet_type_names, "Unknown (0x%02x)"));\r\nbreak;\r\n}\r\nif (tree) {\r\nfmtp_tree = proto_item_add_subtree(ti, ett_fmtp);\r\nproto_tree_add_item(fmtp_tree, hf_fmtp_pdu_version, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fmtp_tree, hf_fmtp_pdu_reserved, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fmtp_tree, hf_fmtp_pdu_length, tvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fmtp_tree, hf_fmtp_pdu_type, tvb, 4, 1, ENC_BIG_ENDIAN);\r\nnext_tvb = tvb_new_subset_remaining(tvb, FMTP_HEADER_LEN);\r\ncall_data_dissector(next_tvb, pinfo, fmtp_tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_fmtp_message_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset, void *data _U_)\r\n{\r\nreturn (guint)tvb_get_ntohs(tvb, offset+2);\r\n}\r\nstatic gboolean\r\ndissect_fmtp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nguint16 length;\r\nif (tvb_captured_length(tvb) < 5)\r\nreturn FALSE;\r\nif (tvb_get_guint8(tvb, 0) != 0x02) return (FALSE);\r\nif (tvb_get_guint8(tvb, 1) != 0x00) return (FALSE);\r\nlength = tvb_get_ntohs(tvb, 2);\r\nif ((length > FMTP_MAX_LEN) || (length < FMTP_HEADER_LEN)) return (FALSE);\r\nif ((tvb_get_guint8(tvb, 4) < 0x01) || (tvb_get_guint8(tvb, 4) > 0x04))\r\nreturn (FALSE);\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, FMTP_HEADER_LEN,\r\nget_fmtp_message_len, dissect_fmtp_message, data);\r\nreturn (TRUE);\r\n}\r\nvoid\r\nproto_register_fmtp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_fmtp_pdu_version,\r\n{ "Version", "fmtp.version",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fmtp_pdu_reserved,\r\n{ "Reserved", "fmtp.reserved",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fmtp_pdu_length,\r\n{ "Length", "fmtp.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fmtp_pdu_type,\r\n{ "Type", "fmtp.type",\r\nFT_UINT8, BASE_DEC,\r\nVALS(packet_type_names), 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_fmtp\r\n};\r\nproto_fmtp = proto_register_protocol(\r\n"Flight Message Transfer Protocol (FMTP)",\r\n"FMTP",\r\n"fmtp");\r\nproto_register_field_array(proto_fmtp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_fmtp(void)\r\n{\r\nheur_dissector_add("tcp", dissect_fmtp, "FMTP over TCP", "fmtp_tcp", proto_fmtp, HEURISTIC_ENABLE);\r\n}

static void\r\niousers_draw(void *arg)\r\n{\r\nconv_hash_t *hash = (conv_hash_t*)arg;\r\nio_users_t *iu = (io_users_t *)hash->user_data;\r\nconv_item_t *iui;\r\nguint64 last_frames, max_frames;\r\nstruct tm * tm_time;\r\nguint i;\r\ngboolean display_ports = (!strncmp(iu->type, "TCP", 3) || !strncmp(iu->type, "UDP", 3) || !strncmp(iu->type, "SCTP", 4)) ? TRUE : FALSE;\r\nprintf("================================================================================\n");\r\nprintf("%s Conversations\n", iu->type);\r\nprintf("Filter:%s\n", iu->filter ? iu->filter : "<No Filter>");\r\nswitch (timestamp_get_type()) {\r\ncase TS_ABSOLUTE:\r\ncase TS_UTC:\r\nprintf("%s | <- | | -> | | Total | Absolute Time | Duration |\n",\r\ndisplay_ports ? " " : "");\r\nprintf("%s | Frames Bytes | | Frames Bytes | | Frames Bytes | Start | |\n",\r\ndisplay_ports ? " " : "");\r\nbreak;\r\ncase TS_ABSOLUTE_WITH_YMD:\r\ncase TS_ABSOLUTE_WITH_YDOY:\r\ncase TS_UTC_WITH_YMD:\r\ncase TS_UTC_WITH_YDOY:\r\nprintf("%s | <- | | -> | | Total | Absolute Date | Duration |\n",\r\ndisplay_ports ? " " : "");\r\nprintf("%s | Frames Bytes | | Frames Bytes | | Frames Bytes | Start | |\n",\r\ndisplay_ports ? " " : "");\r\nbreak;\r\ncase TS_RELATIVE:\r\ncase TS_NOT_SET:\r\ndefault:\r\nprintf("%s | <- | | -> | | Total | Relative | Duration |\n",\r\ndisplay_ports ? " " : "");\r\nprintf("%s | Frames Bytes | | Frames Bytes | | Frames Bytes | Start | |\n",\r\ndisplay_ports ? " " : "");\r\nbreak;\r\n}\r\nmax_frames = UINT_MAX;\r\ndo {\r\nlast_frames = 0;\r\nfor (i=0; (iu->hash.conv_array && i < iu->hash.conv_array->len); i++) {\r\nguint64 tot_frames;\r\niui = &g_array_index(iu->hash.conv_array, conv_item_t, i);\r\ntot_frames = iui->rx_frames + iui->tx_frames;\r\nif ((tot_frames > last_frames) && (tot_frames < max_frames)) {\r\nlast_frames = tot_frames;\r\n}\r\n}\r\nfor (i=0; (iu->hash.conv_array && i < iu->hash.conv_array->len); i++) {\r\nguint64 tot_frames;\r\nchar *src_addr, *dst_addr;\r\niui = &g_array_index(iu->hash.conv_array, conv_item_t, i);\r\ntot_frames = iui->rx_frames + iui->tx_frames;\r\nif (tot_frames == last_frames) {\r\nsrc_addr = get_conversation_address(NULL, &iui->src_address, TRUE);\r\ndst_addr = get_conversation_address(NULL, &iui->dst_address, TRUE);\r\nif (display_ports) {\r\nchar *src, *dst, *src_port, *dst_port;\r\nsrc_port = get_conversation_port(NULL, iui->src_port, iui->ptype, TRUE);\r\ndst_port = get_conversation_port(NULL, iui->dst_port, iui->ptype, TRUE);\r\nsrc = wmem_strconcat(NULL, src_addr, ":", src_port, NULL);\r\ndst = wmem_strconcat(NULL, dst_addr, ":", dst_port, NULL);\r\nprintf("%-26s <-> %-26s %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER\r\n"u %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u %6"\r\nG_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u ",\r\nsrc, dst,\r\niui->rx_frames, iui->rx_bytes,\r\niui->tx_frames, iui->tx_bytes,\r\niui->tx_frames+iui->rx_frames,\r\niui->tx_bytes+iui->rx_bytes\r\n);\r\nwmem_free(NULL, src_port);\r\nwmem_free(NULL, dst_port);\r\nwmem_free(NULL, src);\r\nwmem_free(NULL, dst);\r\n} else {\r\nprintf("%-20s <-> %-20s %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER\r\n"u %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u %6"\r\nG_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u ",\r\nsrc_addr, dst_addr,\r\niui->rx_frames, iui->rx_bytes,\r\niui->tx_frames, iui->tx_bytes,\r\niui->tx_frames+iui->rx_frames,\r\niui->tx_bytes+iui->rx_bytes\r\n);\r\n}\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\nswitch (timestamp_get_type()) {\r\ncase TS_ABSOLUTE:\r\ntm_time = localtime(&iui->start_abs_time.secs);\r\nprintf("%02d:%02d:%02d %12.4f\n",\r\ntm_time->tm_hour,\r\ntm_time->tm_min,\r\ntm_time->tm_sec,\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time));\r\nbreak;\r\ncase TS_ABSOLUTE_WITH_YMD:\r\ntm_time = localtime(&iui->start_abs_time.secs);\r\nprintf("%04d-%02d-%02d %02d:%02d:%02d %12.4f\n",\r\ntm_time->tm_year + 1900,\r\ntm_time->tm_mon + 1,\r\ntm_time->tm_mday,\r\ntm_time->tm_hour,\r\ntm_time->tm_min,\r\ntm_time->tm_sec,\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time));\r\nbreak;\r\ncase TS_ABSOLUTE_WITH_YDOY:\r\ntm_time = localtime(&iui->start_abs_time.secs);\r\nprintf("%04d/%03d %02d:%02d:%02d %12.4f\n",\r\ntm_time->tm_year + 1900,\r\ntm_time->tm_yday + 1,\r\ntm_time->tm_hour,\r\ntm_time->tm_min,\r\ntm_time->tm_sec,\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time));\r\nbreak;\r\ncase TS_UTC:\r\ntm_time = gmtime(&iui->start_abs_time.secs);\r\nprintf("%02d:%02d:%02d %12.4f\n",\r\ntm_time->tm_hour,\r\ntm_time->tm_min,\r\ntm_time->tm_sec,\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time));\r\nbreak;\r\ncase TS_UTC_WITH_YMD:\r\ntm_time = gmtime(&iui->start_abs_time.secs);\r\nprintf("%04d-%02d-%02d %02d:%02d:%02d %12.4f\n",\r\ntm_time->tm_year + 1900,\r\ntm_time->tm_mon + 1,\r\ntm_time->tm_mday,\r\ntm_time->tm_hour,\r\ntm_time->tm_min,\r\ntm_time->tm_sec,\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time));\r\nbreak;\r\ncase TS_UTC_WITH_YDOY:\r\ntm_time = gmtime(&iui->start_abs_time.secs);\r\nprintf("%04d/%03d %02d:%02d:%02d %12.4f\n",\r\ntm_time->tm_year + 1900,\r\ntm_time->tm_yday + 1,\r\ntm_time->tm_hour,\r\ntm_time->tm_min,\r\ntm_time->tm_sec,\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time));\r\nbreak;\r\ncase TS_RELATIVE:\r\ncase TS_NOT_SET:\r\ndefault:\r\nprintf("%14.9f %12.4f\n",\r\nnstime_to_sec(&iui->start_time),\r\nnstime_to_sec(&iui->stop_time) - nstime_to_sec(&iui->start_time)\r\n);\r\nbreak;\r\n}\r\n}\r\n}\r\nmax_frames = last_frames;\r\n} while (last_frames);\r\nprintf("================================================================================\n");\r\n}\r\nvoid init_iousers(struct register_ct *ct, const char *filter)\r\n{\r\nio_users_t *iu;\r\nGString *error_string;\r\niu = g_new0(io_users_t, 1);\r\niu->type = proto_get_protocol_short_name(find_protocol_by_id(get_conversation_proto_id(ct)));\r\niu->filter = g_strdup(filter);\r\niu->hash.user_data = iu;\r\nerror_string = register_tap_listener(proto_get_protocol_filter_name(get_conversation_proto_id(ct)), &iu->hash, filter, 0, NULL, get_conversation_packet_func(ct), iousers_draw);\r\nif (error_string) {\r\ng_free(iu);\r\nfprintf(stderr, "tshark: Couldn't register conversations tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}

ssh_session create_ssh_connection(const char* hostname, const unsigned int port, const char* username,\r\nconst char* password, const char* sshkey_path, const char* sshkey_passphrase, char** err_info)\r\n{\r\nssh_session sshs;\r\nsshs = ssh_new();\r\nif (sshs == NULL) {\r\n*err_info = g_strdup("Can't create ssh session");\r\nreturn NULL;\r\n}\r\nif (!hostname) {\r\n*err_info = g_strdup("Hostname needed");\r\ngoto failure;\r\n}\r\nif (ssh_options_set(sshs, SSH_OPTIONS_HOST, hostname)) {\r\n*err_info = g_strdup_printf("Can't set the hostname: %s", hostname);\r\ngoto failure;\r\n}\r\nif (port != 0) {\r\nif (ssh_options_set(sshs, SSH_OPTIONS_PORT, &port)) {\r\n*err_info = g_strdup_printf("Can't set the port: %d", port);\r\ngoto failure;\r\n}\r\n}\r\nif (!username)\r\nusername = g_get_user_name();\r\nif (ssh_options_set(sshs, SSH_OPTIONS_USER, username)) {\r\n*err_info = g_strdup_printf("Can't set the username: %s", username);\r\ngoto failure;\r\n}\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "Opening ssh connection to %s@%s:%u", username, hostname, port);\r\nif (ssh_connect(sshs) != SSH_OK) {\r\n*err_info = g_strdup_printf("Error connecting to %s@%s:%u (%s)", username, hostname, port,\r\nssh_get_error(sshs));\r\ngoto failure;\r\n}\r\n#ifdef HAVE_LIBSSH_USERAUTH_AGENT\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, ("Connecting using ssh-agent...");\r\nif (ssh_userauth_agent(sshs, NULL) == SSH_AUTH_SUCCESS) {\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "done");\r\nreturn sshs;\r\n}\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, ("failed");\r\n#endif\r\nif (sshkey_path) {\r\nssh_key pkey = ssh_key_new();\r\nint ret;\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "Connecting using public key in %s...", sshkey_path);\r\nret = ssh_pki_import_privkey_file(sshkey_path, sshkey_passphrase, NULL, NULL, &pkey);\r\nif (ret == SSH_OK) {\r\nif (ssh_userauth_publickey(sshs, NULL, pkey) == SSH_AUTH_SUCCESS) {\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "done");\r\nssh_key_free(pkey);\r\nreturn sshs;\r\n}\r\n}\r\nssh_key_free(pkey);\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "failed (%s)", ssh_get_error(sshs));\r\n}\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "Connecting using standard public key...");\r\nif (ssh_userauth_publickey_auto(sshs, NULL, NULL) == SSH_AUTH_SUCCESS) {\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "done");\r\nreturn sshs;\r\n}\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "failed");\r\nif (password) {\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "Connecting using password...");\r\nif (ssh_userauth_password(sshs, username, password) == SSH_AUTH_SUCCESS) {\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "done");\r\nreturn sshs;\r\n}\r\ng_log(LOG_DOMAIN_CAPTURE_CHILD, G_LOG_LEVEL_INFO, "failed");\r\n}\r\n*err_info = g_strdup_printf("Can't find a valid authentication. Disconnecting.");\r\nssh_disconnect(sshs);\r\nfailure:\r\nssh_free(sshs);\r\nreturn NULL;\r\n}\r\nint ssh_channel_printf(ssh_channel channel, const char* fmt, ...)\r\n{\r\ngchar* buf;\r\nva_list arg;\r\nint ret = EXIT_SUCCESS;\r\nva_start(arg, fmt);\r\nbuf = g_strdup_vprintf(fmt, arg);\r\nif (ssh_channel_write(channel, buf, (guint32)strlen(buf)) == SSH_ERROR)\r\nret = EXIT_FAILURE;\r\nva_end(arg);\r\ng_free(buf);\r\nreturn ret;\r\n}\r\nvoid ssh_cleanup(ssh_session* sshs, ssh_channel* channel)\r\n{\r\nif (*channel) {\r\nssh_channel_send_eof(*channel);\r\nssh_channel_close(*channel);\r\nssh_channel_free(*channel);\r\n*channel = NULL;\r\n}\r\nif (*sshs) {\r\nssh_disconnect(*sshs);\r\nssh_free(*sshs);\r\n*sshs = NULL;\r\n}\r\n}

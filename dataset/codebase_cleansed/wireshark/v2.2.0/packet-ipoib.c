static int\r\ndissect_ipoib(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *fh_tree;\r\nproto_tree *fh_subtree;\r\nproto_item *ti;\r\ntvbuff_t *next_tvb;\r\nguint16 type;\r\nint grh_size = 0;\r\nif (pinfo->phdr->pkt_encap == WTAP_ENCAP_IP_OVER_IB_PCAP)\r\ngrh_size = 40;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "IPoIB");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "IP over Infiniband");\r\nif (tree) {\r\nti = proto_tree_add_item (tree, proto_ipoib, tvb, 0, grh_size + 4, ENC_NA);\r\nfh_tree = proto_item_add_subtree(ti, ett_raw);\r\nif (pinfo->phdr->pkt_encap == WTAP_ENCAP_IP_OVER_IB_PCAP) {\r\nif (tvb_get_ntohs(tvb, 0) == 0) {\r\nti = proto_tree_add_item (fh_tree, hf_daddr, tvb, 20, 20, ENC_NA);\r\nfh_subtree = proto_item_add_subtree(ti, ett_hdr);\r\nproto_tree_add_item(fh_subtree, hf_daddr_qpn, tvb, 21, 3, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fh_subtree, hf_dgid, tvb, 24, 16, ENC_NA);\r\n} else {\r\nti = proto_tree_add_item (fh_tree, hf_grh, tvb, 0, 40, ENC_NA);\r\nfh_subtree = proto_item_add_subtree(ti, ett_hdr);\r\nproto_tree_add_item(fh_subtree, hf_grh_ip_version, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fh_subtree, hf_grh_traffic_class, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fh_subtree, hf_grh_flow_label,tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fh_subtree, hf_grh_sqpn, tvb, 5, 3, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fh_subtree, hf_grh_sgid, tvb, 8, 16, ENC_NA);\r\nproto_tree_add_item(fh_subtree, hf_dgid, tvb, 24, 16, ENC_NA);\r\n}\r\n}\r\nproto_tree_add_item(fh_tree, hf_type, tvb, grh_size + 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fh_tree, hf_reserved, tvb, grh_size + 2, 2, ENC_BIG_ENDIAN);\r\n}\r\nnext_tvb = tvb_new_subset_remaining(tvb, grh_size + 4);\r\ntype = tvb_get_ntohs(tvb, grh_size + 0);\r\nswitch (type) {\r\ncase ETHERTYPE_IP:\r\ncall_dissector(ip_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase ETHERTYPE_IPv6:\r\ncall_dissector(ipv6_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase ETHERTYPE_ARP:\r\ncase ETHERTYPE_REVARP:\r\ncall_dissector(arp_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ipoib(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_daddr,\r\n{ "Destination address", "ipoib.daddr",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_daddr_qpn,\r\n{ "Destination QPN", "ipoib.daddr.qpn",\r\nFT_UINT24, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_dgid,\r\n{ "Destination GID", "ipoib.dgid",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_grh,\r\n{ "Global Route Header", "ipoib.grh",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_grh_ip_version, {\r\n"IP Version", "ipoib.grh.ipver",\r\nFT_UINT8, BASE_DEC, NULL, 0xF0,\r\nNULL, HFILL}},\r\n{ &hf_grh_traffic_class, {\r\n"Traffic Class", "ipoib.grh.tclass",\r\nFT_UINT16, BASE_DEC, NULL, 0x0FF0,\r\nNULL, HFILL}},\r\n{ &hf_grh_flow_label, {\r\n"Flow Label", "ipoib.grh.flowlabel",\r\nFT_UINT32, BASE_DEC, NULL, 0x000FFFFF,\r\nNULL, HFILL}},\r\n{ &hf_grh_sqpn,\r\n{ "Source QPN", "ipoib.grh.sqpn",\r\nFT_UINT24, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_grh_sgid,\r\n{ "Source GID", "ipoib.grh.sgid",\r\nFT_IPv6, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_type,\r\n{ "Type", "ipoib.type",\r\nFT_UINT16, BASE_HEX, VALS(etype_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_reserved,\r\n{ "Reserved", "ipoib.reserved",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_raw,\r\n&ett_hdr\r\n};\r\nproto_ipoib = proto_register_protocol("IP over Infiniband", "IPoIB", "ipoib");\r\nproto_register_field_array(proto_ipoib, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_ipoib(void)\r\n{\r\ndissector_handle_t ipoib_handle;\r\narp_handle = find_dissector_add_dependency("arp", proto_ipoib);\r\nip_handle = find_dissector_add_dependency("ip", proto_ipoib);\r\nipv6_handle = find_dissector_add_dependency("ipv6", proto_ipoib);\r\nipoib_handle = create_dissector_handle(dissect_ipoib, proto_ipoib);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_IP_OVER_IB_SNOOP, ipoib_handle);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_IP_OVER_IB_PCAP, ipoib_handle);\r\n}

static guint get_optommp_message_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint len = OPTO_FRAME_HEADER_LEN;\r\nguint8 tcode = 0;\r\ntcode = tvb_get_guint8(tvb, offset + 3) >> 4;\r\nif( tcode == OPTOMMP_WRITE_QUADLET_REQUEST ||\r\ntcode == OPTOMMP_WRITE_BLOCK_REQUEST ||\r\ntcode == OPTOMMP_READ_BLOCK_REQUEST ||\r\ntcode == OPTOMMP_READ_QUADLET_RESPONSE ||\r\ntcode == OPTOMMP_READ_BLOCK_RESPONSE )\r\n{\r\nlen = 16;\r\n}\r\nelse if( tcode == OPTOMMP_WRITE_RESPONSE ||\r\ntcode == OPTOMMP_READ_QUADLET_REQUEST )\r\n{\r\nlen = 12;\r\n}\r\nif( (tcode == OPTOMMP_WRITE_BLOCK_REQUEST ||\r\ntcode == OPTOMMP_READ_BLOCK_RESPONSE) &&\r\ntvb_reported_length_remaining(tvb, offset) >= 14 )\r\n{\r\nlen += (guint) tvb_get_ntohs(tvb, offset + 12);\r\n}\r\nreturn len;\r\n}\r\nstatic gint dissect_optommp_reassemble_tcp(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void *data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, OPTO_FRAME_HEADER_LEN,\r\nget_optommp_message_len, dissect_optommp, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gint dissect_optommp_reassemble_udp(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void *data)\r\n{\r\ndissect_optommp(tvb, pinfo, tree, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gint dissect_optommp(tvbuff_t *tvb, packet_info *pinfo, proto_tree\r\n*tree, void *data _U_)\r\n{\r\nguint8 tcode = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "OptoMMP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif( tvb_reported_length(tvb) >= OPTOMMP_MIN_LENGTH)\r\n{\r\ntcode = tvb_get_guint8(tvb, 3) >> 4;\r\nif( optommp_has_destination_offset(tcode) != 0 &&\r\ntvb_reported_length(tvb) >= 12)\r\n{\r\nguint64 destination_offset = 0;\r\ndestination_offset = tvb_get_ntoh48(tvb, 6);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n" type: %s, dest_off: 0x%012" G_GINT64_MODIFIER "x",\r\nval_to_str(tcode, optommp_tcode_names, "Unknown (0x%02x)"),\r\ndestination_offset);\r\n}\r\nelse\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, " type: %s",\r\nval_to_str(tcode, optommp_tcode_names, "Unknown (0x%02x)"));\r\n}\r\n}\r\nif( tree )\r\n{\r\nproto_item *root_ti = NULL;\r\nproto_item *ti = NULL;\r\nproto_tree *optommp_tree = NULL;\r\nguint offset = 0;\r\nroot_ti = proto_tree_add_item(tree, proto_optommp, tvb, 0, -1,\r\nENC_NA);\r\nif( tvb_reported_length(tvb) >= OPTOMMP_MIN_LENGTH)\r\n{\r\ntcode = tvb_get_guint8(tvb, 3) >> 4;\r\nproto_item_append_text(root_ti, ", type: %s", val_to_str(tcode,\r\noptommp_tcode_names, "Unknown (0x%02x)"));\r\nif( optommp_has_destination_offset(tcode) != 0 )\r\n{\r\nguint64 destination_offset = 0;\r\ndestination_offset = tvb_get_ntoh48(tvb, 6);\r\nproto_item_append_text(root_ti,\r\n", dest_off: 0x%012" G_GINT64_MODIFIER "x",\r\ndestination_offset);\r\n}\r\noptommp_tree = proto_item_add_subtree(root_ti, ett_optommp);\r\ndissect_optommp_dest_id(optommp_tree, tvb, &offset);\r\nti = proto_tree_add_item(optommp_tree, hf_optommp_tl, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\n++offset;\r\nproto_tree_add_item(optommp_tree, hf_optommp_tcode, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\ntcode = tvb_get_guint8(tvb, offset) >> 4;\r\n++offset;\r\nswitch( tcode )\r\n{\r\ncase 0:\r\ndissect_optommp_write_quadlet_request(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\ncase 1:\r\ndissect_optommp_write_block_request(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\ncase 2:\r\ndissect_optommp_write_response(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\ncase 4:\r\ndissect_optommp_read_quadlet_request(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\ncase 5:\r\ndissect_optommp_read_block_request(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\ncase 6:\r\ndissect_optommp_read_quadlet_response(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\ncase 7:\r\ndissect_optommp_read_block_response(&ti, optommp_tree, tvb,\r\n&offset);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void dissect_optommp_dest_id(proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset)\r\n{\r\nproto_tree *dest_id_tree = NULL;\r\nguint16 dest_id = 0;\r\ndest_id = tvb_get_ntohs(tvb, *poffset);\r\nif( (dest_id & 0x8000) == 0x8000 )\r\n{\r\ndest_id_tree = proto_tree_add_subtree(tree, tvb, *poffset,\r\n2, ett_dest_id, NULL, "destination_ID");\r\nproto_tree_add_item(dest_id_tree, hf_optommp_dest_id,\r\ntvb, *poffset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dest_id_tree, hf_optommp_boot_id,\r\ntvb, *poffset, 2, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(tree, hf_optommp_nodest_id,\r\ntvb, *poffset, 2, ENC_BIG_ENDIAN);\r\n}\r\n*poffset += 2;\r\n}\r\nstatic void dissect_optommp_write_quadlet_request(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_destination_offset_6(ti, tree, tvb, poffset);\r\ndissect_optommp_quadlet_data(ti, tree, tvb, poffset);\r\n}\r\nstatic void dissect_optommp_write_block_request(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\nguint16 data_length = 0;\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_destination_offset_6(ti, tree, tvb, poffset);\r\ndata_length = dissect_optommp_data_length(ti, tree, tvb, poffset);\r\n*poffset += 2;\r\ndissect_optommp_data_block(ti, tree, tvb, poffset, data_length);\r\n}\r\nstatic void dissect_optommp_write_response(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_rcode(ti, tree, tvb, poffset);\r\n}\r\nstatic void dissect_optommp_read_quadlet_request(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_destination_offset_6(ti, tree, tvb, poffset);\r\n}\r\nstatic void dissect_optommp_read_block_request(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_destination_offset_6(ti, tree, tvb, poffset);\r\ndissect_optommp_data_length(ti, tree, tvb, poffset);\r\n}\r\nstatic void dissect_optommp_read_quadlet_response(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_rcode(ti, tree, tvb, poffset);\r\n*poffset += 5;\r\ndissect_optommp_quadlet_data(ti, tree, tvb, poffset);\r\n}\r\nstatic void dissect_optommp_read_block_response(proto_item **ti, proto_tree\r\n*tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\nguint16 data_length = 0;\r\ndissect_optommp_source_ID(ti, tree, tvb, poffset);\r\ndissect_optommp_rcode(ti, tree, tvb, poffset);\r\n*poffset += 5;\r\ndata_length = dissect_optommp_data_length(ti, tree, tvb, poffset);\r\n*poffset += 2;\r\ndissect_optommp_data_block(ti, tree, tvb, poffset, data_length);\r\n}\r\nstatic void dissect_optommp_source_ID(proto_item **ti, proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset)\r\n{\r\nif( tvb_reported_length(tvb) >= *poffset + 2 )\r\n{\r\n*ti = proto_tree_add_item(tree, hf_optommp_source_ID, tvb, *poffset,\r\n2, ENC_BIG_ENDIAN);\r\n}\r\n*poffset += 2;\r\n}\r\nstatic void dissect_optommp_destination_offset_6(proto_item **ti,\r\nproto_tree *tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\nif( tvb_reported_length(tvb) >= *poffset + 6 )\r\n{\r\n*poffset += 2;\r\n*ti = proto_tree_add_item(tree, hf_optommp_dest_offset, tvb,\r\n*poffset, 4, ENC_BIG_ENDIAN);\r\n}\r\n*poffset += 4;\r\n}\r\nstatic void dissect_optommp_quadlet_data(proto_item **ti, proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset)\r\n{\r\nif( tvb_reported_length(tvb) >= *poffset + 4 )\r\n{\r\n*ti = proto_tree_add_item(tree, hf_optommp_quadlet_data, tvb,\r\n*poffset, 4, ENC_BIG_ENDIAN);\r\n}\r\n*poffset += 4;\r\n}\r\nstatic guint16 dissect_optommp_data_length(proto_item **ti, proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset)\r\n{\r\nguint16 data_length = 0;\r\nif( tvb_reported_length(tvb) >= *poffset + 2 )\r\n{\r\ndata_length = tvb_get_ntohs(tvb, *poffset);\r\n*ti = proto_tree_add_item(tree, hf_optommp_data_length, tvb,\r\n*poffset, 2, ENC_BIG_ENDIAN);\r\n}\r\n*poffset += 2;\r\nreturn data_length;\r\n}\r\nstatic void dissect_optommp_rcode(proto_item **ti, proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset)\r\n{\r\nif( tvb_reported_length(tvb) >= *poffset + 1 )\r\n{\r\n*ti = proto_tree_add_item(tree, hf_optommp_rcode, tvb, *poffset,\r\n1, ENC_BIG_ENDIAN);\r\n}\r\n++(*poffset);\r\n}\r\nstatic void dissect_optommp_data_block(proto_item **ti, proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset, guint16 data_length)\r\n{\r\nproto_tree *data_block_tree_b = NULL;\r\nproto_tree *data_block_tree_q = NULL;\r\nguint i = 0;\r\nguint quadlet_offset = 0;\r\nguint byte_offset = 0;\r\nquadlet_offset = *poffset;\r\nbyte_offset = *poffset;\r\ndata_block_tree_q = proto_tree_add_subtree(tree, tvb, *poffset,\r\ndata_length, ett_data_block_q, ti, "data_block (as quadlets)");\r\nfor( i = 0; i < (guint16) (data_length / 4); ++i )\r\n{\r\ndissect_optommp_data_block_quadlet(ti, data_block_tree_q, tvb,\r\n&quadlet_offset);\r\n}\r\ndata_block_tree_b = proto_tree_add_subtree(tree, tvb, *poffset,\r\ndata_length, ett_data_block_b, ti, "data_block (as bytes)");\r\nfor( i = 0; i < data_length; ++i )\r\n{\r\ndissect_optommp_data_block_byte(ti, data_block_tree_b, tvb,\r\n&byte_offset);\r\n}\r\n}\r\nstatic void dissect_optommp_data_block_byte(proto_item **ti, proto_tree *tree,\r\ntvbuff_t *tvb, guint *poffset)\r\n{\r\nif( tvb_reported_length(tvb) >= *poffset + 1 )\r\n{\r\nGByteArray *unused_ret_val = NULL;\r\nunused_ret_val = g_byte_array_new();\r\n*ti = proto_tree_add_bytes_item(tree, hf_optommp_data_block_byte, tvb,\r\n*poffset, 1, 0x0, unused_ret_val, NULL, NULL);\r\ng_byte_array_free(unused_ret_val, TRUE);\r\n}\r\n++(*poffset);\r\n}\r\nstatic void dissect_optommp_data_block_quadlet(proto_item **ti, proto_tree\r\n*tree, tvbuff_t *tvb, guint *poffset)\r\n{\r\nif( tvb_reported_length(tvb) >= *poffset + 4 )\r\n{\r\n*ti = proto_tree_add_item(tree, hf_optommp_data_block_quadlet,\r\ntvb, *poffset, 4, ENC_NA);\r\n}\r\n*poffset += 4;\r\n}\r\nstatic gint optommp_has_destination_offset(guint8 tcode)\r\n{\r\nif( tcode == 0 || tcode == 1 || tcode == 4 || tcode == 5 )\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid proto_register_optommp(void)\r\n{\r\nmodule_t *optommp_module;\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_optommp_nodest_id,\r\n{ "destination_ID", "optommp.destination_ID",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x8000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_dest_id,\r\n{ "destination_ID", "optommp.destination_ID",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_boot_id,\r\n{ "boot_ID", "optommp.boot_ID",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x7FFF,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_tl,\r\n{ "tl", "optommp.tl",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0xFC,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_tcode,\r\n{ "tcode", "optommp.tcode",\r\nFT_UINT8, BASE_HEX,\r\nVALS(optommp_tcode_names), 0xF0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_source_ID,\r\n{ "source_ID", "optommp.source_id",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_rcode,\r\n{ "rcode", "optommp.rcode",\r\nFT_UINT8, BASE_HEX,\r\nVALS(optommp_rcode_meanings), 0xF0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_quadlet_data,\r\n{ "quadlet_data", "optommp.quadlet_data",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_data_length,\r\n{ "data_length", "optommp.data_length",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_dest_offset,\r\n{ "destination_offset", "optommp.destination_offset",\r\nFT_UINT32, BASE_HEX | BASE_RANGE_STRING,\r\nRVALS(optommp_mm_areas), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_data_block_byte,\r\n{ "data_block_byte", "optommp.data_block_byte",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_optommp_data_block_quadlet,\r\n{ "data_block_quadlet", "optommp.data_block_quadlet",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_optommp,\r\n&ett_dest_id,\r\n&ett_data_block_q,\r\n&ett_data_block_b\r\n};\r\nproto_optommp = proto_register_protocol(\r\n"OptoMMP",\r\n"OptoMMP",\r\n"optommp");\r\nproto_register_field_array(proto_optommp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\noptommp_module = prefs_register_protocol(proto_optommp,\r\nproto_reg_handoff_optommp);\r\nprefs_register_uint_preference(optommp_module, "tcp.port",\r\n"OptoMMP TCP or UDP Port", " OptoMMP TCP or UDP port if other than the default",\r\n10, &gOPTOMMP_PORT_PREF);\r\n}\r\nvoid proto_reg_handoff_optommp(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic gint currentPort;\r\nif( !initialized )\r\n{\r\noptommp_tcp_handle = create_dissector_handle(\r\ndissect_optommp_reassemble_tcp, proto_optommp);\r\noptommp_udp_handle = create_dissector_handle(\r\ndissect_optommp_reassemble_udp, proto_optommp);\r\ninitialized = TRUE;\r\n}\r\nelse\r\n{\r\ndissector_delete_uint("tcp.port", currentPort, optommp_tcp_handle);\r\ndissector_delete_uint("udp.port", currentPort, optommp_udp_handle);\r\n}\r\ncurrentPort = gOPTOMMP_PORT_PREF;\r\ndissector_add_uint("tcp.port", currentPort, optommp_tcp_handle);\r\ndissector_add_uint("udp.port", currentPort, optommp_udp_handle);\r\n}

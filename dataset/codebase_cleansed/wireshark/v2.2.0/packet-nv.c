static void NvSummaryFormater(tvbuff_t *tvb, gint offset, char *szText, int nMax)\r\n{\r\nguint32 nvOffset = offset;\r\ng_snprintf ( szText, nMax, "Network Vars from %d.%d.%d.%d.%d.%d - %d Var(s)",\r\ntvb_get_guint8(tvb, nvOffset),\r\ntvb_get_guint8(tvb, nvOffset+1),\r\ntvb_get_guint8(tvb, nvOffset+2),\r\ntvb_get_guint8(tvb, nvOffset+3),\r\ntvb_get_guint8(tvb, nvOffset+4),\r\ntvb_get_guint8(tvb, nvOffset+5),\r\ntvb_get_letohs(tvb, nvOffset+6));\r\n}\r\nstatic void NvPublisherFormater(tvbuff_t *tvb, gint offset, char *szText, int nMax)\r\n{\r\nguint32 nvOffset = offset;\r\ng_snprintf ( szText, nMax, "Publisher %d.%d.%d.%d.%d.%d",\r\ntvb_get_guint8(tvb, nvOffset),\r\ntvb_get_guint8(tvb, nvOffset+1),\r\ntvb_get_guint8(tvb, nvOffset+2),\r\ntvb_get_guint8(tvb, nvOffset+3),\r\ntvb_get_guint8(tvb, nvOffset+4),\r\ntvb_get_guint8(tvb, nvOffset+5));\r\n}\r\nstatic void NvVarHeaderFormater(tvbuff_t *tvb, gint offset, char *szText, int nMax)\r\n{\r\ng_snprintf ( szText, nMax, "Variable - Id = %d, Length = %d",\r\ntvb_get_letohs(tvb, offset),\r\ntvb_get_letohs(tvb, offset+4));\r\n}\r\nstatic int dissect_nv(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *nv_tree, *nv_header_tree, *nv_var_tree,*nv_varheader_tree;\r\ngint offset = 0;\r\nchar szText[200];\r\nint nMax = (int)sizeof(szText)-1;\r\ngint i;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "TC-NV");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nNvSummaryFormater(tvb, offset, szText, nMax);\r\ncol_append_str(pinfo->cinfo, COL_INFO, szText);\r\nif (tree)\r\n{\r\nguint16 nv_count;\r\nti = proto_tree_add_item(tree, proto_nv, tvb, 0, -1, ENC_NA);\r\nnv_tree = proto_item_add_subtree(ti, ett_nv);\r\nproto_item_append_text(ti,": %s",szText);\r\nti = proto_tree_add_item(nv_tree, hf_nv_header, tvb, offset, NvParserHDR_Len, ENC_NA);\r\nnv_header_tree = proto_item_add_subtree(ti, ett_nv_header);\r\nti= proto_tree_add_item(nv_header_tree, hf_nv_publisher, tvb, offset, (int)sizeof(guint8)*6, ENC_NA);\r\nNvPublisherFormater(tvb, offset, szText, nMax);\r\nproto_item_set_text(ti, "%s", szText);\r\noffset+=((int)sizeof(guint8)*6);\r\nproto_tree_add_item(nv_header_tree, hf_nv_count, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nnv_count = tvb_get_letohs(tvb, offset);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(nv_header_tree, hf_nv_cycleindex, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset = NvParserHDR_Len;\r\nfor ( i=0; i < nv_count; i++ )\r\n{\r\nguint16 var_length = tvb_get_letohs(tvb, offset+4);\r\nti = proto_tree_add_item(nv_tree, hf_nv_variable, tvb, offset, ETYPE_88A4_NV_DATA_HEADER_Len+var_length, ENC_NA);\r\nNvVarHeaderFormater(tvb, offset, szText, nMax);\r\nproto_item_set_text(ti, "%s", szText);\r\nnv_var_tree = proto_item_add_subtree(ti, ett_nv_var);\r\nti = proto_tree_add_item(nv_var_tree, hf_nv_varheader, tvb, offset, ETYPE_88A4_NV_DATA_HEADER_Len, ENC_NA);\r\nnv_varheader_tree = proto_item_add_subtree(ti, ett_nv_varheader);\r\nproto_tree_add_item(nv_varheader_tree, hf_nv_id, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(nv_varheader_tree, hf_nv_hash, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(nv_varheader_tree, hf_nv_length, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(nv_varheader_tree, hf_nv_quality, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(nv_var_tree, hf_nv_data, tvb, offset, var_length, ENC_NA);\r\noffset+=var_length;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_nv(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n#if 0\r\n{ &hf_nv_summary, { "Summary of the Nv Packet", "tc_nv.summary",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_nv_header, { "Header", "tc_nv.header",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_publisher, { "Publisher", "tc_nv.publisher",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_count, { "Count", "tc_nv.count",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_cycleindex, { "CycleIndex", "tc_nv.cycleindex",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_variable, { "Variable", "tc_nv.variable",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_varheader, { "VarHeader", "tc_nv.varheader",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_id, { "Id", "tc_nv.id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_hash, { "Hash", "tc_nv.hash",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_length, { "Length", "tc_nv.length",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_quality, { "Quality", "tc_nv.quality",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_nv_data, { "Data", "tc_nv.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_nv,\r\n&ett_nv_header,\r\n&ett_nv_var,\r\n&ett_nv_varheader\r\n};\r\nproto_nv = proto_register_protocol("TwinCAT NV",\r\n"TC-NV","tc_nv");\r\nproto_register_field_array(proto_nv,hf,array_length(hf));\r\nproto_register_subtree_array(ett,array_length(ett));\r\n}\r\nvoid proto_reg_handoff_nv(void)\r\n{\r\ndissector_handle_t nv_handle;\r\nnv_handle = create_dissector_handle(dissect_nv, proto_nv);\r\ndissector_add_uint("ecatf.type", 4, nv_handle);\r\n}

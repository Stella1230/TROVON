static gint\r\nget_utp_version(tvbuff_t *tvb) {\r\nguint8 v0_flags, v0_ext;\r\nguint8 v1_ver_type, v1_ext;\r\nguint len;\r\nlen = tvb_captured_length(tvb);\r\nif (len < V1_FIXED_HDR_SIZE) {\r\nreturn -1;\r\n}\r\nv1_ver_type = tvb_get_guint8(tvb, 0);\r\nv1_ext = tvb_get_guint8(tvb, 1);\r\nif (((v1_ver_type & 0x0f) == 1) && ((v1_ver_type>>4) < ST_NUM_STATES) &&\r\n(v1_ext < EXT_NUM_EXT)) {\r\nreturn 1;\r\n}\r\nif (len < V0_FIXED_HDR_SIZE) {\r\nreturn -1;\r\n}\r\nv0_flags = tvb_get_guint8(tvb, 18);\r\nv0_ext = tvb_get_guint8(tvb, 17);\r\nif ((v0_flags < ST_NUM_STATES) || (v0_ext < EXT_NUM_EXT)) {\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nstatic int\r\ndissect_utp_header_v0(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, guint8 *extension_type)\r\n{\r\nproto_tree_add_item(tree, hf_bt_utp_connection_id_v0, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_timestamp_sec, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_timestamp_us, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_timestamp_diff_us, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_wnd_size_v0, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_bt_utp_next_extension_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n*extension_type = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_bt_utp_flags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Type: %s", val_to_str(tvb_get_guint8(tvb, offset), bt_utp_type_vals, "Unknown %d"));\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_bt_utp_seq_nr, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_bt_utp_ack_nr, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_utp_header_v1(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset, guint8 *extension_type)\r\n{\r\nproto_tree_add_item(tree, hf_bt_utp_ver, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_bt_utp_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Type: %s", val_to_str((tvb_get_guint8(tvb, offset) >> 4), bt_utp_type_vals, "Unknown %d"));\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_bt_utp_next_extension_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n*extension_type = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_bt_utp_connection_id_v1, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_bt_utp_timestamp_us, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_timestamp_diff_us, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_wnd_size_v1, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bt_utp_seq_nr, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_bt_utp_ack_nr, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_utp_extension(tvbuff_t *tvb, packet_info _U_*pinfo, proto_tree *tree, int offset, guint8 *extension_type)\r\n{\r\nproto_item *ti;\r\nproto_tree *ext_tree;\r\nguint8 extension_length;\r\nwhile(*extension_type != EXT_NO_EXTENSION && offset < (int)tvb_reported_length(tvb))\r\n{\r\nswitch(*extension_type){\r\ncase EXT_SELECTION_ACKS:\r\n{\r\nti = proto_tree_add_item(tree, hf_bt_utp_extension, tvb, offset, -1, ENC_NA);\r\next_tree = proto_item_add_subtree(ti, ett_bt_utp_extension);\r\nproto_tree_add_item(ext_tree, hf_bt_utp_next_extension_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n*extension_type = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(ext_tree, hf_bt_utp_extension_len, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nextension_length = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(ti, " Selection ACKs, Len=%d", extension_length);\r\noffset += 1;\r\nproto_tree_add_item(ext_tree, hf_bt_utp_extension_bitmask, tvb, offset, extension_length, ENC_NA);\r\noffset += extension_length;\r\nproto_item_set_len(ti, 1 + 1 + extension_length);\r\nbreak;\r\n}\r\ncase EXT_EXTENSION_BITS:\r\n{\r\nti = proto_tree_add_item(tree, hf_bt_utp_extension, tvb, offset, -1, ENC_NA);\r\next_tree = proto_item_add_subtree(ti, ett_bt_utp_extension);\r\nproto_tree_add_item(ext_tree, hf_bt_utp_next_extension_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n*extension_type = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(ext_tree, hf_bt_utp_extension_len, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nextension_length = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(ti, " Extension Bits, Len=%d", extension_length);\r\noffset += 1;\r\nproto_tree_add_item(ext_tree, hf_bt_utp_extension_bitmask, tvb, offset, extension_length, ENC_NA);\r\noffset += extension_length;\r\nproto_item_set_len(ti, 1 + 1 + extension_length);\r\nbreak;\r\n}\r\ndefault:\r\nti = proto_tree_add_item(tree, hf_bt_utp_extension, tvb, offset, -1, ENC_NA);\r\next_tree = proto_item_add_subtree(ti, ett_bt_utp_extension);\r\nproto_tree_add_item(ext_tree, hf_bt_utp_next_extension_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n*extension_type = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(ext_tree, hf_bt_utp_extension_len, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nextension_length = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(ti, " Unknown, Len=%d", extension_length);\r\noffset += 1;\r\nproto_tree_add_item(ext_tree, hf_bt_utp_extension_unknown, tvb, offset, extension_length, ENC_NA);\r\noffset += extension_length;\r\nproto_item_set_len(ti, 1 + 1 + extension_length);\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_bt_utp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ngint version;\r\nversion = get_utp_version(tvb);\r\nif (version >= 0)\r\n{\r\nconversation_t *conversation;\r\nguint len_tvb;\r\nproto_tree *sub_tree = NULL;\r\nproto_item *ti;\r\ngint offset = 0;\r\nguint8 extension_type;\r\nconversation = find_or_create_conversation(pinfo);\r\nconversation_set_dissector(conversation, bt_utp_handle);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BT-uTP");\r\ncol_set_str( pinfo->cinfo, COL_INFO, "uTorrent Transport Protocol" );\r\nlen_tvb = tvb_reported_length(tvb);\r\nti = proto_tree_add_protocol_format(tree, proto_bt_utp, tvb, 0, -1,\r\n"uTorrent Transport Protocol V%d (%d bytes)",\r\nversion, len_tvb);\r\nsub_tree = proto_item_add_subtree(ti, ett_bt_utp);\r\nif (version == 0) {\r\noffset = dissect_utp_header_v0(tvb, pinfo, sub_tree, offset, &extension_type);\r\n} else {\r\noffset = dissect_utp_header_v1(tvb, pinfo, sub_tree, offset, &extension_type);\r\n}\r\noffset = dissect_utp_extension(tvb, pinfo, sub_tree, offset, &extension_type);\r\nlen_tvb = tvb_captured_length_remaining(tvb, offset);\r\nif(len_tvb > 0)\r\nproto_tree_add_item(sub_tree, hf_bt_utp_data, tvb, offset, len_tvb, ENC_NA);\r\nreturn offset+len_tvb;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nproto_register_bt_utp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_bt_utp_ver,\r\n{ "Version", "bt-utp.ver",\r\nFT_UINT8, BASE_DEC, NULL, 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_flags,\r\n{ "Flags", "bt-utp.flags",\r\nFT_UINT8, BASE_DEC, VALS(bt_utp_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_type,\r\n{ "Type", "bt-utp.type",\r\nFT_UINT8, BASE_DEC, VALS(bt_utp_type_vals), 0xF0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_extension,\r\n{ "Extension", "bt-utp.extension",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_next_extension_type,\r\n{ "Next Extension Type", "bt-utp.next_extension_type",\r\nFT_UINT8, BASE_DEC, VALS(bt_utp_extension_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_extension_len,\r\n{ "Extension Length", "bt-utp.extension_len",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_extension_bitmask,\r\n{ "Extension Bitmask", "bt-utp.extension_bitmask",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_extension_unknown,\r\n{ "Extension Unknown", "bt-utp.extension_unknown",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_connection_id_v0,\r\n{ "Connection ID", "bt-utp.connection_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_connection_id_v1,\r\n{ "Connection ID", "bt-utp.connection_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_timestamp_sec,\r\n{ "Timestamp seconds", "bt-utp.timestamp_sec",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_timestamp_us,\r\n{ "Timestamp Microseconds", "bt-utp.timestamp_us",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_timestamp_diff_us,\r\n{ "Timestamp Difference Microseconds", "bt-utp.timestamp_diff_us",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_wnd_size_v0,\r\n{ "Windows Size", "bt-utp.wnd_size",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_wnd_size_v1,\r\n{ "Windows Size", "bt-utp.wnd_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_seq_nr,\r\n{ "Sequence number", "bt-utp.seq_nr",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_ack_nr,\r\n{ "ACK number", "bt-utp.ack_nr",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bt_utp_data,\r\n{ "Data", "bt-utp.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = { &ett_bt_utp, &ett_bt_utp_extension };\r\nmodule_t *bt_utp_module;\r\nproto_bt_utp = proto_register_protocol (\r\n"uTorrent Transport Protocol",\r\n"BT-uTP",\r\n"bt-utp"\r\n);\r\nbt_utp_module = prefs_register_protocol(proto_bt_utp, proto_reg_handoff_bt_utp);\r\nprefs_register_obsolete_preference(bt_utp_module, "enable");\r\nproto_register_field_array(proto_bt_utp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_bt_utp(void)\r\n{\r\nstatic gboolean prefs_initialized = FALSE;\r\nif (!prefs_initialized) {\r\nheur_dissector_add("udp", dissect_bt_utp, "BitTorrent UTP over UDP", "bt_utp_udp", proto_bt_utp, HEURISTIC_DISABLE);\r\nbt_utp_handle = create_dissector_handle(dissect_bt_utp, proto_bt_utp);\r\ndissector_add_for_decode_as("udp.port", bt_utp_handle);\r\nprefs_initialized = TRUE;\r\n}\r\n}

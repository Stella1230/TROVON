static int\r\ndissect_omapi(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *omapi_tree;\r\nptvcursor_t *cursor;\r\nguint32 authlength;\r\nguint32 msglength;\r\nguint32 objlength;\r\nif (tvb_reported_length_remaining(tvb, 0) < 8)\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "OMAPI");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_omapi, tvb, 0, -1, ENC_NA);\r\nomapi_tree = proto_item_add_subtree(ti, ett_omapi);\r\ncursor = ptvcursor_new(omapi_tree, tvb, 0);\r\nif (tvb_reported_length_remaining(tvb, 0) < 24)\r\n{\r\nptvcursor_add(cursor, hf_omapi_version, 4, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_hlength, 4, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Status message");\r\nproto_item_append_text(ti, ", Status message");\r\nptvcursor_free(cursor);\r\nreturn 8;\r\n}\r\nelse if ( !(tvb_get_ntohl(tvb, 8) || tvb_get_ntohl(tvb, 12)) )\r\n{\r\nptvcursor_add(cursor, hf_omapi_version, 4, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_hlength, 4, ENC_BIG_ENDIAN);\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Status message");\r\nproto_item_append_text(ti, ", Status message");\r\n}\r\nptvcursor_add(cursor, hf_omapi_auth_id, 4, ENC_BIG_ENDIAN);\r\nauthlength = tvb_get_ntohl(tvb, ptvcursor_current_offset(cursor));\r\nptvcursor_add(cursor, hf_omapi_auth_len, 4, ENC_BIG_ENDIAN);\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL,\r\nval_to_str(tvb_get_ntohl(tvb, ptvcursor_current_offset(cursor)), omapi_opcode_vals, "Unknown opcode (0x%04x)"));\r\nproto_item_append_text(ti, ", Opcode: %s",\r\nval_to_str(tvb_get_ntohl(tvb, ptvcursor_current_offset(cursor)), omapi_opcode_vals, "Unknown opcode (0x%04x)"));\r\nptvcursor_add(cursor, hf_omapi_opcode, 4, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_handle, 4, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_id, 4, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_rid, 4, ENC_BIG_ENDIAN);\r\nmsglength = tvb_get_ntohs(tvb, ptvcursor_current_offset(cursor));\r\nwhile (msglength)\r\n{\r\nptvcursor_add(cursor, hf_omapi_msg_name_len, 2, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_msg_name, msglength, ENC_ASCII|ENC_NA);\r\nmsglength = tvb_get_ntohl(tvb, ptvcursor_current_offset(cursor));\r\nptvcursor_add(cursor, hf_omapi_msg_value_len, 4, ENC_BIG_ENDIAN);\r\nif (msglength == 0)\r\n{\r\nproto_tree_add_item(omapi_tree, hf_omapi_empty_string, tvb, 0, 0, ENC_NA);\r\n}\r\nelse if (msglength == (guint32)~0)\r\n{\r\nproto_tree_add_item(omapi_tree, hf_omapi_no_value, tvb, 0, 0, ENC_NA);\r\n}\r\nelse\r\n{\r\nptvcursor_add(cursor, hf_omapi_msg_value, msglength, ENC_ASCII|ENC_NA);\r\n}\r\nmsglength = tvb_get_ntohs(tvb, ptvcursor_current_offset(cursor));\r\n}\r\nptvcursor_add(cursor, hf_omapi_message_end_tag, 2, ENC_NA);\r\nobjlength = tvb_get_ntohs(tvb, ptvcursor_current_offset(cursor));\r\nwhile (objlength)\r\n{\r\nptvcursor_add(cursor, hf_omapi_obj_name_len, 2, ENC_BIG_ENDIAN);\r\nptvcursor_add(cursor, hf_omapi_obj_name, objlength, ENC_ASCII|ENC_NA);\r\nobjlength = tvb_get_ntohl(tvb, ptvcursor_current_offset(cursor));\r\nptvcursor_add(cursor, hf_omapi_obj_value_len, 4, ENC_BIG_ENDIAN);\r\nif (objlength == 0)\r\n{\r\nproto_tree_add_item(omapi_tree, hf_omapi_empty_string, tvb, 0, 0, ENC_NA);\r\n}\r\nelse if (objlength == (guint32)~0)\r\n{\r\nproto_tree_add_item(omapi_tree, hf_omapi_no_value, tvb, 0, 0, ENC_NA);\r\n}\r\nelse\r\n{\r\nptvcursor_add(cursor, hf_omapi_obj_value, objlength, ENC_NA);\r\n}\r\nobjlength = tvb_get_ntohs(tvb, ptvcursor_current_offset(cursor));\r\n}\r\nptvcursor_add(cursor, hf_omapi_object_end_tag, 2, ENC_NA);\r\nif (authlength > 0) {\r\nptvcursor_add(cursor, hf_omapi_signature, authlength, ENC_NA);\r\n}\r\nptvcursor_free(cursor);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_omapi(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_omapi_version,\r\n{ "Version", "omapi.version",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_hlength,\r\n{ "Header length", "omapi.hlength",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_auth_id,\r\n{ "Authentication ID", "omapi.authid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_auth_len,\r\n{ "Authentication length", "omapi.authlength",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_opcode,\r\n{ "Opcode", "omapi.opcode",\r\nFT_UINT32, BASE_DEC, VALS(omapi_opcode_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_handle,\r\n{ "Handle", "omapi.handle",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_id,\r\n{ "ID", "omapi.id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_rid,\r\n{ "Response ID", "omapi.rid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_msg_name_len,\r\n{ "Message name length", "omapi.msg_name_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_msg_name,\r\n{ "Message name", "omapi.msg_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_msg_value_len,\r\n{ "Message value length", "omapi.msg_value_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_msg_value,\r\n{ "Message value", "omapi.msg_value",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_obj_name_len,\r\n{ "Object name length", "omapi.obj_name_length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_obj_name,\r\n{ "Object name", "omapi.obj_name",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_obj_value_len,\r\n{ "Object value length", "omapi.object_value_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_obj_value,\r\n{ "Object value", "omapi.obj_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_signature,\r\n{ "Signature", "omapi.signature",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_omapi_empty_string, { "Empty string", "omapi.empty_string", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_omapi_no_value, { "No value", "omapi.no_value", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_omapi_message_end_tag, { "Message end tag", "omapi.message_end_tag", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_omapi_object_end_tag, { "Object end tag", "omapi.object_end_tag", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_omapi\r\n};\r\nproto_omapi = proto_register_protocol("ISC Object Management API", "OMAPI", "omapi");\r\nproto_register_field_array(proto_omapi, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_omapi(void)\r\n{\r\ndissector_handle_t omapi_handle;\r\nomapi_handle = create_dissector_handle(dissect_omapi, proto_omapi);\r\ndissector_add_uint("tcp.port", OMAPI_PORT, omapi_handle);\r\n}

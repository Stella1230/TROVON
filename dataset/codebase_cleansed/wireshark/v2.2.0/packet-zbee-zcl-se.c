static void\r\ndissect_zcl_msg_attr_data(proto_tree *tree, tvbuff_t *tvb, guint *offset, guint16 attr_id, guint data_type)\r\n{\r\nswitch (attr_id) {\r\ncase ZBEE_ZCL_ATTR_ID_SE_ATTR_REPORT_STATUS:\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_attr_reporting_status, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nbreak;\r\ndefault:\r\ndissect_zcl_attr_data(tvb, tree, offset, data_type);\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_zbee_zcl_msg(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nproto_tree *payload_tree;\r\nzbee_zcl_packet *zcl;\r\nguint offset = 0;\r\nguint8 cmd_id;\r\ngint rem_len;\r\nif (data == NULL)\r\nreturn 0;\r\nzcl = (zbee_zcl_packet *)data;\r\ncmd_id = zcl->cmd_id;\r\nif (zcl->direction == ZBEE_ZCL_FCF_TO_SERVER) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq: %u",\r\nval_to_str_const(cmd_id, zbee_zcl_msg_srv_rx_cmd_names, "Unknown Command"),\r\nzcl->tran_seqno);\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_srv_rx_cmd_id, tvb, offset, 1, cmd_id);\r\nrem_len = tvb_reported_length_remaining(tvb, ++offset);\r\nif (rem_len > 0) {\r\npayload_tree = proto_tree_add_subtree(tree, tvb, offset, rem_len, ett_zbee_zcl_msg, NULL, "Payload");\r\nswitch (cmd_id) {\r\ncase ZBEE_ZCL_CMD_ID_MSG_GET_LAST_MSG:\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_MSG_MSG_CONFIRM:\r\ndissect_zcl_msg_confirm(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_MSG_GET_MESSAGE_CANCEL:\r\ndissect_zcl_msg_get_cancel(tvb, payload_tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nelse {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq: %u",\r\nval_to_str_const(cmd_id, zbee_zcl_msg_srv_tx_cmd_names, "Unknown Command"),\r\nzcl->tran_seqno);\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_srv_tx_cmd_id, tvb, offset, 1, cmd_id);\r\nrem_len = tvb_reported_length_remaining(tvb, ++offset);\r\nif (rem_len > 0) {\r\npayload_tree = proto_tree_add_subtree(tree, tvb, offset, rem_len, ett_zbee_zcl_msg, NULL, "Payload");\r\nswitch (cmd_id) {\r\ncase ZBEE_ZCL_CMD_ID_MSG_DISPLAY_MSG:\r\ndissect_zcl_msg_display(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_MSG_CANCEL_MSG:\r\ndissect_zcl_msg_cancel(tvb, pinfo, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_MSG_DISPLAY_PROTECTED_MSG:\r\ndissect_zcl_msg_display(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_MSG_CANCEL_ALL_MSG:\r\ndissect_zcl_msg_cancel_all(tvb, payload_tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\ndissect_zcl_msg_display(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nguint msg_len;\r\nguint8 *msg_data;\r\nstatic const int * message_ctrl_flags[] = {\r\n&hf_zbee_zcl_msg_ctrl_tx,\r\n&hf_zbee_zcl_msg_ctrl_importance,\r\n&hf_zbee_zcl_msg_ctrl_enh_confirm,\r\n&hf_zbee_zcl_msg_ctrl_reserved,\r\n&hf_zbee_zcl_msg_ctrl_confirm,\r\nNULL\r\n};\r\nstatic const int * message_ext_ctrl_flags[] = {\r\n&hf_zbee_zcl_msg_ext_ctrl_status,\r\nNULL\r\n};\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_message_id, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n*offset += 4;\r\nproto_tree_add_bitmask(tree, tvb, *offset, hf_zbee_zcl_msg_ctrl, ett_zbee_zcl_msg_message_control, message_ctrl_flags, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_start_time, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n*offset += 4;\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_duration, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nmsg_len = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_message_length, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nmsg_data = tvb_get_string_enc(wmem_packet_scope(), tvb, *offset, msg_len, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_string(tree, hf_zbee_zcl_msg_message, tvb, *offset, msg_len, msg_data);\r\n*offset += msg_len;\r\nif (tvb_reported_length_remaining(tvb, *offset) > 0) {\r\nproto_tree_add_bitmask(tree, tvb, *offset, hf_zbee_zcl_msg_ext_ctrl, ett_zbee_zcl_msg_ext_message_control, message_ext_ctrl_flags, ENC_NA);\r\n*offset += 1;\r\n}\r\n}\r\nstatic void\r\ndissect_zcl_msg_cancel(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint *offset)\r\n{\r\ngint8 msg_ctrl;\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_message_id, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n*offset += 4;\r\nmsg_ctrl = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_ctrl, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nif (msg_ctrl != 0x00) {\r\nexpert_add_info(pinfo, tree, &ei_zbee_zcl_msg_msg_ctrl_depreciated);\r\n}\r\n}\r\nstatic void\r\ndissect_zcl_msg_cancel_all(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nnstime_t impl_time;\r\nimpl_time.secs = tvb_get_letohl(tvb, *offset) + ZBEE_ZCL_NSTIME_UTC_OFFSET;\r\nimpl_time.nsecs = 0;\r\nproto_tree_add_time(tree, hf_zbee_zcl_msg_implementation_time, tvb, *offset, 4, &impl_time);\r\n*offset += 4;\r\n}\r\nstatic void\r\ndissect_zcl_msg_get_cancel(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nnstime_t impl_time;\r\nimpl_time.secs = tvb_get_letohl(tvb, *offset) + ZBEE_ZCL_NSTIME_UTC_OFFSET;\r\nimpl_time.nsecs = 0;\r\nproto_tree_add_time(tree, hf_zbee_zcl_msg_earliest_time, tvb, *offset, 4, &impl_time);\r\n*offset += 4;\r\n}\r\nstatic void\r\ndissect_zcl_msg_confirm(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nguint msg_len;\r\nguint8 *msg_data;\r\nnstime_t confirm_time;\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_message_id, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n*offset += 4;\r\nconfirm_time.secs = tvb_get_letohl(tvb, *offset) + ZBEE_ZCL_NSTIME_UTC_OFFSET;\r\nconfirm_time.nsecs = 0;\r\nproto_tree_add_time(tree, hf_zbee_zcl_msg_confirm_time, tvb, *offset, 4, &confirm_time);\r\n*offset += 4;\r\nif ( tvb_reported_length_remaining(tvb, *offset) <= 0 ) return;\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_confirm_ctrl, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nif ( tvb_reported_length_remaining(tvb, *offset) <= 0 ) return;\r\nmsg_len = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_msg_confirm_response_length, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nif (msg_len > 0) {\r\nmsg_data = tvb_get_string_enc(wmem_packet_scope(), tvb, *offset, msg_len, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_string(tree, hf_zbee_zcl_msg_confirm_response, tvb, *offset, msg_len, msg_data);\r\n*offset += msg_len;\r\n}\r\n}\r\nstatic void\r\ndecode_zcl_msg_duration(gchar *s, guint16 value)\r\n{\r\nif (value == 0xffff)\r\ng_snprintf(s, ITEM_LABEL_LENGTH, "Until changed");\r\nelse\r\ng_snprintf(s, ITEM_LABEL_LENGTH, "%d minutes", value);\r\nreturn;\r\n}\r\nstatic void\r\ndecode_zcl_msg_start_time(gchar *s, guint32 value)\r\n{\r\nif (value == ZBEE_ZCL_MSG_START_TIME_NOW)\r\ng_snprintf(s, ITEM_LABEL_LENGTH, "Now");\r\nelse {\r\ngchar *start_time;\r\nvalue += ZBEE_ZCL_NSTIME_UTC_OFFSET;\r\nstart_time = abs_time_secs_to_str (NULL, value, ABSOLUTE_TIME_LOCAL, TRUE);\r\ng_snprintf(s, ITEM_LABEL_LENGTH, "%s", start_time);\r\nwmem_free(NULL, start_time);\r\n}\r\n}\r\nvoid\r\nproto_register_zbee_zcl_msg(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_zbee_zcl_msg_attr_id,\r\n{ "Attribute", "zbee_zcl_se.msg.attr_id", FT_UINT16, BASE_HEX, VALS(zbee_zcl_msg_attr_names),\r\n0x0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_attr_reporting_status,\r\n{ "Attribute Reporting Status", "zbee_zcl_se.msg.attr.attr_reporting_status",\r\nFT_UINT8, BASE_HEX, VALS(zbee_zcl_se_reporting_status_names), 0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_srv_tx_cmd_id,\r\n{ "Command", "zbee_zcl_se.msg.cmd.srv_tx.id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_msg_srv_tx_cmd_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_srv_rx_cmd_id,\r\n{ "Command", "zbee_zcl_se.msg.cmd.srv_rx.id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_msg_srv_rx_cmd_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_message_id,\r\n{ "Message ID", "zbee_zcl_se.msg.message.id", FT_UINT32, BASE_HEX, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ctrl,\r\n{ "Message Control", "zbee_zcl_se.msg.message.ctrl", FT_UINT8, BASE_HEX, NULL,\r\n0x0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ctrl_tx,\r\n{ "Transmission", "zbee_zcl_se.msg.message.ctrl.tx", FT_UINT8, BASE_HEX, VALS(zbee_zcl_msg_ctrl_tx_names),\r\nZBEE_ZCL_MSG_CTRL_TX_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ctrl_importance,\r\n{ "Importance", "zbee_zcl_se.msg.message.ctrl.importance", FT_UINT8, BASE_HEX, VALS(zbee_zcl_msg_ctrl_importance_names),\r\nZBEE_ZCL_MSG_CTRL_IMPORTANCE_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ctrl_enh_confirm,\r\n{ "Confirmation", "zbee_zcl_se.msg.message.ctrl.enhconfirm", FT_BOOLEAN, 8, TFS(&tfs_required_not_required),\r\nZBEE_ZCL_MSG_CTRL_ENHANCED_CONFIRM_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ctrl_reserved,\r\n{ "Reserved", "zbee_zcl_se.msg.message.ctrl.reserved", FT_UINT8, BASE_HEX, NULL,\r\nZBEE_ZCL_MSG_CTRL_RESERVED_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ctrl_confirm,\r\n{ "Confirmation", "zbee_zcl_se.msg.message.ctrl.confirm", FT_BOOLEAN, 8, TFS(&tfs_required_not_required),\r\nZBEE_ZCL_MSG_CTRL_CONFIRM_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ext_ctrl,\r\n{ "Extended Message Control", "zbee_zcl_se.msg.message.ext.ctrl", FT_UINT8, BASE_HEX, NULL,\r\n0x0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_ext_ctrl_status,\r\n{ "Message Confirmation Status", "zbee_zcl_se.msg.message.ext.ctrl.status", FT_BOOLEAN, 8, TFS(&tfs_confirmed_unconfirmed),\r\nZBEE_ZCL_MSG_EXT_CTRL_STATUS_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_start_time,\r\n{ "Start Time", "zbee_zcl_se.msg.message.start_time", FT_UINT32, BASE_CUSTOM, CF_FUNC(decode_zcl_msg_start_time),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_duration,\r\n{ "Duration", "zbee_zcl_se.msg.message.duration", FT_UINT16, BASE_CUSTOM, CF_FUNC(decode_zcl_msg_duration),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_message_length,\r\n{ "Message Length", "zbee_zcl_se.msg.message.length", FT_UINT8, BASE_DEC, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_message,\r\n{ "Message", "zbee_zcl_se.msg.message", FT_STRING, BASE_NONE, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_confirm_time,\r\n{ "Confirmation Time", "zbee_zcl_se.msg.message.confirm_time", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL,\r\n0x0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_confirm_ctrl,\r\n{ "Confirmation Control", "zbee_zcl_se.msg.message.confirm.ctrl", FT_BOOLEAN, 8, TFS(&tfs_no_yes),\r\nZBEE_ZCL_MSG_CONFIRM_CTRL_MASK, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_confirm_response_length,\r\n{ "Response Length", "zbee_zcl_se.msg.message.length", FT_UINT8, BASE_DEC, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_confirm_response,\r\n{ "Response", "zbee_zcl_se.msg.message", FT_STRING, BASE_NONE, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_implementation_time,\r\n{ "Implementation Time", "zbee_zcl_se.msg.impl_time", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_UTC, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_msg_earliest_time,\r\n{ "Earliest Implementation Time", "zbee_zcl_se.msg.earliest_impl_time", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_UTC, NULL,\r\n0, NULL, HFILL } },\r\n};\r\ngint *ett[] = {\r\n&ett_zbee_zcl_msg,\r\n&ett_zbee_zcl_msg_message_control,\r\n&ett_zbee_zcl_msg_ext_message_control,\r\n};\r\nexpert_module_t* expert_zbee_zcl_msg;\r\nstatic ei_register_info ei[] = {\r\n{ &ei_zbee_zcl_msg_msg_ctrl_depreciated, { "zbee_zcl_se.msg.msg_ctrl.depreciated", PI_PROTOCOL, PI_WARN, "Message Control depreciated in this message, should be 0x00", EXPFILL }},\r\n};\r\nproto_zbee_zcl_msg = proto_register_protocol("ZigBee ZCL Messaging", "ZCL Messaging", ZBEE_PROTOABBREV_ZCL_MSG);\r\nproto_register_field_array(proto_zbee_zcl_msg, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_zbee_zcl_msg = expert_register_protocol(proto_zbee_zcl_msg);\r\nexpert_register_field_array(expert_zbee_zcl_msg, ei, array_length(ei));\r\nregister_dissector(ZBEE_PROTOABBREV_ZCL_MSG, dissect_zbee_zcl_msg, proto_zbee_zcl_msg);\r\n}\r\nvoid\r\nproto_reg_handoff_zbee_zcl_msg(void)\r\n{\r\ndissector_handle_t msg_handle;\r\nmsg_handle = find_dissector(ZBEE_PROTOABBREV_ZCL_MSG);\r\ndissector_add_uint("zbee.zcl.cluster", ZBEE_ZCL_CID_MESSAGE, msg_handle);\r\nzbee_zcl_init_cluster( proto_zbee_zcl_msg,\r\nett_zbee_zcl_msg,\r\nZBEE_ZCL_CID_MESSAGE,\r\nhf_zbee_zcl_msg_attr_id,\r\nhf_zbee_zcl_msg_srv_rx_cmd_id,\r\nhf_zbee_zcl_msg_srv_tx_cmd_id,\r\n(zbee_zcl_fn_attr_data)dissect_zcl_msg_attr_data\r\n);\r\n}\r\nstatic void\r\ndissect_zcl_tun_attr_data(proto_tree *tree, tvbuff_t *tvb, guint *offset, guint16 attr_id, guint data_type)\r\n{\r\nswitch (attr_id) {\r\ncase ZBEE_ZCL_ATTR_ID_TUN_CLOSE_TIMEOUT:\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_attr_close_timeout, tvb, *offset, 2, ENC_NA);\r\n*offset += 2;\r\nbreak;\r\ncase ZBEE_ZCL_ATTR_ID_SE_ATTR_REPORT_STATUS:\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_attr_reporting_status, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nbreak;\r\ndefault:\r\ndissect_zcl_attr_data(tvb, tree, offset, data_type);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\ndissect_zcl_tun_request_tunnel(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_protocol_id, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_manufacturer_code, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_flow_control_support, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_max_in_size, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic void\r\ndissect_zcl_tun_close_tunnel(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic void\r\ndissect_zcl_tun_transfer_data(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\ngint length;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nlength = tvb_reported_length_remaining(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_transfer_data, tvb, *offset, length, ENC_NA);\r\n*offset += length;\r\n}\r\nstatic void\r\ndissect_zcl_tun_transfer_data_error(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_transfer_data_status, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\n}\r\nstatic void\r\ndissect_zcl_tun_ack_transfer_data(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_num_octets_left, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic void\r\ndissect_zcl_tun_ready_data(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_num_octets_left, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic void\r\ndissect_zcl_tun_get_supported(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_protocol_offset, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic void\r\ndissect_zcl_tun_request_tunnel_rsp(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_transfer_status, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_max_in_size, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic void\r\ndissect_zcl_tun_get_supported_rsp(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nguint16 mfg_code;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_protocol_list_complete, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_protocol_count, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nwhile (tvb_reported_length_remaining(tvb, *offset) > 0) {\r\nmfg_code = tvb_get_letohs(tvb, *offset);\r\nif (mfg_code == 0xFFFF) {\r\nproto_tree_add_string(tree, hf_zbee_zcl_tun_manufacturer_code, tvb, *offset, 2, "Standard Protocol (Mfg Code 0xFFFF)");\r\n}\r\nelse {\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_manufacturer_code, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n}\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_protocol_id, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\n}\r\n}\r\nstatic void\r\ndissect_zcl_tun_closure_notify(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_tunnel_id, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic int\r\ndissect_zbee_zcl_tun(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nproto_tree *payload_tree;\r\nzbee_zcl_packet *zcl;\r\nguint offset = 0;\r\nguint8 cmd_id;\r\ngint rem_len;\r\nif (data == NULL)\r\nreturn 0;\r\nzcl = (zbee_zcl_packet *)data;\r\ncmd_id = zcl->cmd_id;\r\nif (zcl->direction == ZBEE_ZCL_FCF_TO_SERVER) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq: %u",\r\nval_to_str_const(cmd_id, zbee_zcl_tun_srv_rx_cmd_names, "Unknown Command"),\r\nzcl->tran_seqno);\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_srv_rx_cmd_id, tvb, offset, 1, cmd_id);\r\nrem_len = tvb_reported_length_remaining(tvb, ++offset);\r\nif (rem_len > 0) {\r\npayload_tree = proto_tree_add_subtree(tree, tvb, offset, rem_len, ett_zbee_zcl_tun, NULL, "Payload");\r\nswitch (cmd_id) {\r\ncase ZBEE_ZCL_CMD_ID_TUN_REQUEST_TUNNEL:\r\ndissect_zcl_tun_request_tunnel(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_CLOSE_TUNNEL:\r\ndissect_zcl_tun_close_tunnel(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_TRANSFER_DATA:\r\ndissect_zcl_tun_transfer_data(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_TRANSFER_DATA_ERROR:\r\ndissect_zcl_tun_transfer_data_error(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_ACK_TRANSFER_DATA:\r\ndissect_zcl_tun_ack_transfer_data(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_READY_DATA:\r\ndissect_zcl_tun_ready_data(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_GET_SUPPORTED_PROTOCOLS:\r\ndissect_zcl_tun_get_supported(tvb, payload_tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nelse {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq: %u",\r\nval_to_str_const(cmd_id, zbee_zcl_tun_srv_tx_cmd_names, "Unknown Command"),\r\nzcl->tran_seqno);\r\nproto_tree_add_item(tree, hf_zbee_zcl_tun_srv_tx_cmd_id, tvb, offset, 1, cmd_id);\r\nrem_len = tvb_reported_length_remaining(tvb, ++offset);\r\nif (rem_len > 0) {\r\npayload_tree = proto_tree_add_subtree(tree, tvb, offset, rem_len, ett_zbee_zcl_tun, NULL, "Payload");\r\nswitch (cmd_id) {\r\ncase ZBEE_ZCL_CMD_ID_TUN_REQUEST_TUNNEL_RSP:\r\ndissect_zcl_tun_request_tunnel_rsp(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_TRANSFER_DATA_TX:\r\ndissect_zcl_tun_transfer_data(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_TRANSFER_DATA_ERROR_TX:\r\ndissect_zcl_tun_transfer_data_error(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_ACK_TRANSFER_DATA_TX:\r\ndissect_zcl_tun_ack_transfer_data(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_READY_DATA_TX:\r\ndissect_zcl_tun_ready_data(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_GET_SUPPORTED_PROTOCOLS_RSP:\r\ndissect_zcl_tun_get_supported_rsp(tvb, payload_tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_TUN_CLOSURE_NOTIFY:\r\ndissect_zcl_tun_closure_notify(tvb, payload_tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_zbee_zcl_tun(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_zbee_zcl_tun_attr_id,\r\n{ "Attribute", "zbee_zcl_se.tun.attr_id", FT_UINT16, BASE_HEX, VALS(zbee_zcl_tun_attr_names),\r\n0x0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_attr_reporting_status,\r\n{ "Attribute Reporting Status", "zbee_zcl_se.tun.attr.attr_reporting_status",\r\nFT_UINT8, BASE_HEX, VALS(zbee_zcl_se_reporting_status_names), 0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_attr_close_timeout,\r\n{ "Close Tunnel Timeout", "zbee_zcl_se.tun.attr.close_tunnel", FT_UINT16, BASE_DEC, NULL,\r\n0x0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_srv_tx_cmd_id,\r\n{ "Command", "zbee_zcl_se.tun.cmd.srv_tx.id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_tun_srv_tx_cmd_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_srv_rx_cmd_id,\r\n{ "Command", "zbee_zcl_se.tun.cmd.srv_rx.id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_tun_srv_rx_cmd_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_protocol_id,\r\n{ "Protocol ID", "zbee_zcl_se.tun.protocol_id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_tun_protocol_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_manufacturer_code,\r\n{ "Manufacturer Code", "zbee_zcl_se.tun.manufacturer_code", FT_UINT16, BASE_HEX, VALS(zbee_mfr_code_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_flow_control_support,\r\n{ "Flow Control Supported", "zbee_zcl_se.tun.flow_control_supported", FT_BOOLEAN, 8, TFS(&tfs_true_false),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_max_in_size,\r\n{ "Max Incoming Transfer Size", "zbee_zcl_se.tun.max_in_transfer_size", FT_UINT16, BASE_HEX, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_tunnel_id,\r\n{ "Tunnel Id", "zbee_zcl_se.tun.tunnel_id", FT_UINT16, BASE_HEX, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_num_octets_left,\r\n{ "Num Octets Left", "zbee_zcl_se.tun.octets_left", FT_UINT16, BASE_HEX, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_protocol_offset,\r\n{ "Protocol Offset", "zbee_zcl_se.tun.protocol_offset", FT_UINT8, BASE_HEX, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_transfer_status,\r\n{ "Transfer Status", "zbee_zcl_se.tun.transfer_status", FT_UINT8, BASE_HEX, VALS(zbee_zcl_tun_status_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_transfer_data,\r\n{ "Transfer Data", "zbee_zcl_se.tun.transfer_data", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_transfer_data_status,\r\n{ "Transfer Data Status", "zbee_zcl_se.tun.transfer_data_status", FT_UINT8, BASE_HEX, VALS(zbee_zcl_tun_trans_data_status_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_protocol_count,\r\n{ "Protocol Count", "zbee_zcl_se.tun.protocol_count", FT_UINT8, BASE_HEX, NULL,\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_tun_protocol_list_complete,\r\n{ "List Complete", "zbee_zcl_se.tun.protocol_list_complete", FT_BOOLEAN, 8, TFS(&tfs_true_false),\r\n0x00, NULL, HFILL } },\r\n};\r\ngint *ett[] = {\r\n&ett_zbee_zcl_tun,\r\n};\r\nproto_zbee_zcl_tun = proto_register_protocol("ZigBee ZCL Tunneling", "ZCL Tunneling", ZBEE_PROTOABBREV_ZCL_TUN);\r\nproto_register_field_array(proto_zbee_zcl_tun, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector(ZBEE_PROTOABBREV_ZCL_TUN, dissect_zbee_zcl_tun, proto_zbee_zcl_tun);\r\n}\r\nvoid\r\nproto_reg_handoff_zbee_zcl_tun(void)\r\n{\r\ndissector_handle_t msg_handle;\r\nipv4_handle = find_dissector("ipv4");\r\nipv6_handle = find_dissector("ipv6");\r\nmsg_handle = find_dissector(ZBEE_PROTOABBREV_ZCL_TUN);\r\ndissector_add_uint("zbee.zcl.cluster", ZBEE_ZCL_CID_TUNNELING, msg_handle);\r\nzbee_zcl_init_cluster( proto_zbee_zcl_tun,\r\nett_zbee_zcl_tun,\r\nZBEE_ZCL_CID_TUNNELING,\r\nhf_zbee_zcl_tun_attr_id,\r\nhf_zbee_zcl_tun_srv_rx_cmd_id,\r\nhf_zbee_zcl_tun_srv_tx_cmd_id,\r\n(zbee_zcl_fn_attr_data)dissect_zcl_tun_attr_data\r\n);\r\n}\r\nstatic void\r\ndissect_zcl_ke_suite1_certificate(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_reconstr, tvb, *offset, 22, ENC_NA);\r\n*offset += 22;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_subject, tvb, *offset, 8, ENC_NA);\r\n*offset += 8;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_issuer, tvb, *offset, 8, ENC_NA);\r\n*offset += 8;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_profile_attr, tvb, *offset, 10, ENC_NA);\r\n*offset += 10;\r\n}\r\nstatic void\r\ndissect_zcl_ke_suite2_certificate(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nnstime_t valid_from_time;\r\nnstime_t valid_to_time;\r\nguint32 valid_to;\r\nguint8 key_usage;\r\nproto_tree *usage_tree;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_type, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_serialno, tvb, *offset, 8, ENC_NA);\r\n*offset += 8;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_curve, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_hash, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_issuer, tvb, *offset, 8, ENC_NA);\r\n*offset += 8;\r\nvalid_from_time.secs = (time_t)tvb_get_ntoh40(tvb, *offset);\r\nvalid_from_time.nsecs = 0;\r\nproto_tree_add_time(tree, hf_zbee_zcl_ke_cert_valid_from, tvb, *offset, 5, &valid_from_time);\r\n*offset += 5;\r\nvalid_to = tvb_get_ntohl(tvb, *offset);\r\nif (valid_to == 0xFFFFFFFF) {\r\nproto_tree_add_time_format(tree, hf_zbee_zcl_ke_cert_valid_to, tvb, *offset, 4, &valid_to_time, "Valid To: does not expire (0xFFFFFFFF)");\r\n}\r\nelse {\r\nvalid_to_time.secs = valid_from_time.secs + valid_to;\r\nvalid_to_time.nsecs = 0;\r\nproto_tree_add_time(tree, hf_zbee_zcl_ke_cert_valid_to, tvb, *offset, 4, &valid_to_time);\r\n}\r\n*offset += 4;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_subject, tvb, *offset, 8, ENC_NA);\r\n*offset += 8;\r\nkey_usage = tvb_get_guint8(tvb, *offset);\r\nusage_tree = proto_tree_add_subtree_format(tree, tvb, *offset, 1, ett_zbee_zcl_ke_key_usage, NULL, "Key Usage (0x%02x)", key_usage);\r\nproto_tree_add_item(usage_tree, hf_zbee_zcl_ke_cert_key_usage_agreement, tvb, *offset, 1, ENC_NA);\r\nproto_tree_add_item(usage_tree, hf_zbee_zcl_ke_cert_key_usage_signature, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_cert_reconstr, tvb, *offset, 37, ENC_NA);\r\n*offset += 37;\r\n}\r\nstatic void\r\ndissect_zcl_ke_initiate(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\ngint rem_len;\r\nproto_tree *subtree;\r\nguint16 suite;\r\nsuite = tvb_get_letohs(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_suite, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_ephemeral_time, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_confirm_time, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nrem_len = tvb_reported_length_remaining(tvb, *offset);\r\nsubtree = proto_tree_add_subtree(tree, tvb, *offset, rem_len, ett_zbee_zcl_ke_cert, NULL, "Implicit Certificate");\r\nswitch (suite) {\r\ncase ZBEE_ZCL_KE_SUITE_1:\r\ndissect_zcl_ke_suite1_certificate(tvb, subtree, offset);\r\nbreak;\r\ncase ZBEE_ZCL_KE_SUITE_2:\r\ndissect_zcl_ke_suite2_certificate(tvb, subtree, offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_zcl_ke_ephemeral_qeu(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\ngint length;\r\nlength = tvb_reported_length_remaining(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_ephemeral_qeu, tvb, *offset, length, ENC_NA);\r\n*offset += length;\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_zcl_ke_ephemeral_qev(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\ngint length;\r\nlength = tvb_reported_length_remaining(tvb, *offset);\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_ephemeral_qev, tvb, *offset, length, ENC_NA);\r\n*offset += length;\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_zcl_ke_confirm_macu(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_macu, tvb, *offset, ZBEE_SEC_CONST_BLOCKSIZE, ENC_NA);\r\n*offset += ZBEE_SEC_CONST_BLOCKSIZE;\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_zcl_ke_confirm_macv(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_macv, tvb, *offset, ZBEE_SEC_CONST_BLOCKSIZE, ENC_NA);\r\n*offset += ZBEE_SEC_CONST_BLOCKSIZE;\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\ndissect_zcl_ke_terminate(tvbuff_t *tvb, proto_tree *tree, guint *offset)\r\n{\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_status, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_wait_time, tvb, *offset, 1, ENC_NA);\r\n*offset += 1;\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_suite, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n*offset += 2;\r\n}\r\nstatic int\r\ndissect_zbee_zcl_ke(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nzbee_zcl_packet *zcl;\r\nguint offset = 0;\r\nguint8 cmd_id;\r\ngint rem_len;\r\nif (data == NULL)\r\nreturn 0;\r\nzcl = (zbee_zcl_packet *)data;\r\ncmd_id = zcl->cmd_id;\r\nif (zcl->direction == ZBEE_ZCL_FCF_TO_SERVER) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq: %u",\r\nval_to_str_const(cmd_id, zbee_zcl_ke_srv_cmd_names, "Unknown Command"),\r\nzcl->tran_seqno);\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_srv_rx_cmd_id, tvb, offset, 1, cmd_id);\r\nrem_len = tvb_reported_length_remaining(tvb, offset);\r\noffset += 1;\r\nif (rem_len > 0) {\r\nswitch (cmd_id) {\r\ncase ZBEE_ZCL_CMD_ID_KE_INITIATE:\r\ndissect_zcl_ke_initiate(tvb, tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_KE_EPHEMERAL:\r\nreturn dissect_zcl_ke_ephemeral_qeu(tvb, tree, &offset);\r\ncase ZBEE_ZCL_CMD_ID_KE_CONFIRM:\r\nreturn dissect_zcl_ke_confirm_macu(tvb, tree, &offset);\r\ncase ZBEE_ZCL_CMD_ID_KE_TERMINATE:\r\ndissect_zcl_ke_terminate(tvb, tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nelse {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq: %u",\r\nval_to_str_const(cmd_id, zbee_zcl_ke_srv_cmd_names, "Unknown Command"),\r\nzcl->tran_seqno);\r\nproto_tree_add_item(tree, hf_zbee_zcl_ke_srv_tx_cmd_id, tvb, offset, 1, cmd_id);\r\nrem_len = tvb_reported_length_remaining(tvb, ++offset);\r\nif (rem_len > 0) {\r\nswitch (cmd_id) {\r\ncase ZBEE_ZCL_CMD_ID_KE_INITIATE:\r\ndissect_zcl_ke_initiate(tvb, tree, &offset);\r\nbreak;\r\ncase ZBEE_ZCL_CMD_ID_KE_EPHEMERAL:\r\nreturn dissect_zcl_ke_ephemeral_qev(tvb, tree, &offset);\r\ncase ZBEE_ZCL_CMD_ID_KE_CONFIRM:\r\nreturn dissect_zcl_ke_confirm_macv(tvb, tree, &offset);\r\ncase ZBEE_ZCL_CMD_ID_KE_TERMINATE:\r\ndissect_zcl_ke_terminate(tvb, tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_zbee_zcl_ke(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_zbee_zcl_ke_attr_id,\r\n{ "Attribute", "zbee_zcl_se.ke.attr_id", FT_UINT16, BASE_HEX, VALS(zbee_zcl_ke_attr_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_srv_tx_cmd_id,\r\n{ "Command", "zbee_zcl_se.ke.cmd.srv_tx.id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_ke_srv_cmd_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_srv_rx_cmd_id,\r\n{ "Command", "zbee_zcl_se.ke.cmd.srv_rx.id", FT_UINT8, BASE_HEX, VALS(zbee_zcl_ke_srv_cmd_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_suite,\r\n{ "Key Establishment Suite", "zbee_zcl_se.ke.attr.suite", FT_UINT16, BASE_HEX, VALS(zbee_zcl_ke_suite_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_ephemeral_time,\r\n{ "Ephemeral Data Generate Time", "zbee_zcl_se.ke.init.ephemeral.time", FT_UINT8, BASE_DEC, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_confirm_time,\r\n{ "Confirm Key Generate Time", "zbee_zcl_se.ke.init.confirm.time", FT_UINT8, BASE_DEC, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_status,\r\n{ "Status", "zbee_zcl_se.ke.terminate.status", FT_UINT8, BASE_HEX, VALS(zbee_zcl_ke_status_names),\r\n0x00, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_wait_time,\r\n{ "Wait Time", "zbee_zcl_se.ke.terminate.wait.time", FT_UINT8, BASE_DEC, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_reconstr,\r\n{ "Public Key", "zbee_zcl_se.ke.cert.reconst", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_subject,\r\n{ "Subject", "zbee_zcl_se.ke.cert.subject", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_issuer,\r\n{ "Issuer", "zbee_zcl_se.ke.cert.issuer", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_profile_attr,\r\n{ "Profile Attribute Data", "zbee_zcl_se.ke.cert.profile", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_type,\r\n{ "Type", "zbee_zcl_se.ke.cert.type", FT_UINT8, BASE_HEX, VALS(zbee_zcl_ke_type_names),\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_serialno,\r\n{ "Serial No", "zbee_zcl_se.ke.cert.serialno", FT_UINT64, BASE_HEX, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_curve,\r\n{ "Curve", "zbee_zcl_se.ke.cert.curve", FT_UINT8, BASE_HEX, VALS(zbee_zcl_ke_curve_names),\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_hash,\r\n{ "Hash", "zbee_zcl_se.ke.cert.hash", FT_UINT8, BASE_HEX, VALS(zbee_zcl_ke_hash_names),\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_valid_from,\r\n{ "Valid From", "zbee_zcl_se.ke.cert.valid.from", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_UTC, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_valid_to,\r\n{ "Valid To", "zbee_zcl_se.ke.cert.valid.to", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_UTC, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_cert_key_usage_agreement,\r\n{ "Key Agreement", "zbee_zcl_se.ke.cert.key.usage.agreement", FT_BOOLEAN, 8, TFS(&tfs_enabled_disabled),\r\nZBEE_ZCL_KE_USAGE_KEY_AGREEMENT, NULL, HFILL }},\r\n{ &hf_zbee_zcl_ke_cert_key_usage_signature,\r\n{ "Digital Signature", "zbee_zcl_se.ke.cert.key.usage.signature", FT_BOOLEAN, 8, TFS(&tfs_enabled_disabled),\r\nZBEE_ZCL_KE_USAGE_DIGITAL_SIGNATURE, NULL, HFILL }},\r\n{ &hf_zbee_zcl_ke_ephemeral_qeu,\r\n{ "Ephemeral Data (QEU)", "zbee_zcl_se.ke.qeu", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_ephemeral_qev,\r\n{ "Ephemeral Data (QEV)", "zbee_zcl_se.ke.qev", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_macu,\r\n{ "Message Authentication Code (MACU)", "zbee_zcl_se.ke.macu", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n{ &hf_zbee_zcl_ke_macv,\r\n{ "Message Authentication Code (MACV)", "zbee_zcl_se.ke.macv", FT_BYTES, BASE_NONE, NULL,\r\n0, NULL, HFILL } },\r\n};\r\ngint *ett[] = {\r\n&ett_zbee_zcl_ke,\r\n&ett_zbee_zcl_ke_cert,\r\n&ett_zbee_zcl_ke_key_usage,\r\n};\r\nproto_zbee_zcl_ke = proto_register_protocol("ZigBee ZCL Key Establishment", "ZCL Key Establishment", ZBEE_PROTOABBREV_ZCL_KE);\r\nproto_register_field_array(proto_zbee_zcl_ke, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector(ZBEE_PROTOABBREV_ZCL_KE, dissect_zbee_zcl_ke, proto_zbee_zcl_ke);\r\n}\r\nvoid\r\nproto_reg_handoff_zbee_zcl_ke(void)\r\n{\r\ndissector_handle_t ke_handle;\r\nke_handle = find_dissector(ZBEE_PROTOABBREV_ZCL_KE);\r\ndissector_add_uint("zbee.zcl.cluster", ZBEE_ZCL_CID_KE, ke_handle);\r\nzbee_zcl_init_cluster( proto_zbee_zcl_ke,\r\nett_zbee_zcl_ke,\r\nZBEE_ZCL_CID_KE,\r\nhf_zbee_zcl_ke_attr_id,\r\nhf_zbee_zcl_ke_srv_rx_cmd_id,\r\nhf_zbee_zcl_ke_srv_tx_cmd_id,\r\nNULL\r\n);\r\n}

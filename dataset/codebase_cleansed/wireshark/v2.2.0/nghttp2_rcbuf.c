int nghttp2_rcbuf_new(nghttp2_rcbuf **rcbuf_ptr, size_t size,\r\nnghttp2_mem *mem) {\r\nuint8_t *p;\r\np = (uint8_t *)nghttp2_mem_malloc(mem, sizeof(nghttp2_rcbuf) + size);\r\nif (p == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\n*rcbuf_ptr = (nghttp2_rcbuf *)(void *)p;\r\n(*rcbuf_ptr)->mem_user_data = mem->mem_user_data;\r\n(*rcbuf_ptr)->free = mem->free;\r\n(*rcbuf_ptr)->base = p + sizeof(nghttp2_rcbuf);\r\n(*rcbuf_ptr)->len = size;\r\n(*rcbuf_ptr)->ref = 1;\r\nreturn 0;\r\n}\r\nint nghttp2_rcbuf_new2(nghttp2_rcbuf **rcbuf_ptr, const uint8_t *src,\r\nsize_t srclen, nghttp2_mem *mem) {\r\nint rv;\r\nrv = nghttp2_rcbuf_new(rcbuf_ptr, srclen + 1, mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nmemcpy((*rcbuf_ptr)->base, src, srclen);\r\n(*rcbuf_ptr)->len = srclen;\r\n(*rcbuf_ptr)->base[srclen] = '\0';\r\nreturn 0;\r\n}\r\nvoid nghttp2_rcbuf_del(nghttp2_rcbuf *rcbuf) {\r\nnghttp2_mem_free2(rcbuf->free, rcbuf, rcbuf->mem_user_data);\r\n}\r\nvoid nghttp2_rcbuf_incref(nghttp2_rcbuf *rcbuf) {\r\nif (rcbuf->ref == -1) {\r\nreturn;\r\n}\r\n++rcbuf->ref;\r\n}\r\nvoid nghttp2_rcbuf_decref(nghttp2_rcbuf *rcbuf) {\r\nif (rcbuf == NULL || rcbuf->ref == -1) {\r\nreturn;\r\n}\r\nassert(rcbuf->ref > 0);\r\nif (--rcbuf->ref == 0) {\r\nnghttp2_rcbuf_del(rcbuf);\r\n}\r\n}\r\nnghttp2_vec nghttp2_rcbuf_get_buf(nghttp2_rcbuf *rcbuf) {\r\nnghttp2_vec res = {rcbuf->base, rcbuf->len};\r\nreturn res;\r\n}

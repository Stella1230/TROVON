static gboolean is_valid_id(guint16 version_id)\r\n{\r\n#define VERSION_21 0x3231\r\n#define VERSION_30 0x3330\r\nif ((version_id != VERSION_21) &&\r\n(version_id != VERSION_30))\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nstatic gboolean stanag4607_read_file(wtap *wth, FILE_T fh, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nstanag4607_t *stanag4607 = (stanag4607_t *)wth->priv;\r\nguint32 millisecs, secs, nsecs;\r\ngint64 offset = 0;\r\nguint8 stanag_pkt_hdr[37];\r\nguint32 packet_size;\r\n*err = 0;\r\nif (!wtap_read_bytes_or_eof(fh, stanag_pkt_hdr, sizeof stanag_pkt_hdr, err, err_info))\r\nreturn FALSE;\r\noffset += sizeof stanag_pkt_hdr;\r\nif (!is_valid_id(pntoh16(&stanag_pkt_hdr[0]))) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("Bad version number");\r\nreturn FALSE;\r\n}\r\nphdr->rec_type = REC_TYPE_PACKET;\r\npacket_size = pntoh32(&stanag_pkt_hdr[2]);\r\nif (packet_size > WTAP_MAX_PACKET_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("stanag4607: File has %" G_GUINT32_FORMAT "d-byte packet, "\r\n"bigger than maximum of %u", packet_size, WTAP_MAX_PACKET_SIZE);\r\nreturn FALSE;\r\n}\r\nphdr->caplen = packet_size;\r\nphdr->len = packet_size;\r\nphdr->presence_flags = WTAP_HAS_TS;\r\nphdr->ts.secs = stanag4607->base_secs;\r\nphdr->ts.nsecs = 0;\r\nmillisecs = 0;\r\n#define MISSION_SEGMENT 1\r\n#define DWELL_SEGMENT 2\r\n#define JOB_DEFINITION_SEGMENT 5\r\n#define PLATFORM_LOCATION_SEGMENT 13\r\nif (MISSION_SEGMENT == stanag_pkt_hdr[32]) {\r\nguint8 mseg[39];\r\nstruct tm tm;\r\nif (!wtap_read_bytes(fh, &mseg, sizeof mseg, err, err_info))\r\nreturn FALSE;\r\noffset += sizeof mseg;\r\ntm.tm_year = pntoh16(&mseg[35]) - 1900;\r\ntm.tm_mon = mseg[37] - 1;\r\ntm.tm_mday = mseg[38];\r\ntm.tm_hour = 0;\r\ntm.tm_min = 0;\r\ntm.tm_sec = 0;\r\ntm.tm_isdst = -1;\r\nstanag4607->base_secs = mktime(&tm);\r\nphdr->ts.secs = stanag4607->base_secs;\r\n}\r\nelse if (PLATFORM_LOCATION_SEGMENT == stanag_pkt_hdr[32]) {\r\nif (!wtap_read_bytes(fh, &millisecs, sizeof millisecs, err, err_info))\r\nreturn FALSE;\r\noffset += sizeof millisecs;\r\nmillisecs = g_ntohl(millisecs);\r\n}\r\nelse if (DWELL_SEGMENT == stanag_pkt_hdr[32]) {\r\nguint8 dseg[19];\r\nif (!wtap_read_bytes(fh, &dseg, sizeof dseg, err, err_info))\r\nreturn FALSE;\r\noffset += sizeof dseg;\r\nmillisecs = pntoh32(&dseg[15]);\r\n}\r\nif (0 != millisecs) {\r\nsecs = millisecs/1000;\r\nnsecs = (millisecs - 1000 * secs) * 1000000;\r\nphdr->ts.secs = stanag4607->base_secs + secs;\r\nphdr->ts.nsecs = nsecs;\r\n}\r\nif (file_seek(fh, - offset, SEEK_CUR, err) == -1)\r\nreturn FALSE;\r\nreturn wtap_read_packet_bytes(fh, buf, packet_size, err, err_info);\r\n}\r\nstatic gboolean stanag4607_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\ngint64 offset;\r\n*err = 0;\r\noffset = file_tell(wth->fh);\r\n*data_offset = offset;\r\nreturn stanag4607_read_file(wth, wth->fh, &wth->phdr, wth->frame_buffer, err, err_info);\r\n}\r\nstatic gboolean stanag4607_seek_read(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nreturn stanag4607_read_file(wth, wth->random_fh, phdr, buf, err, err_info);\r\n}\r\nwtap_open_return_val stanag4607_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nguint16 version_id;\r\nstanag4607_t *stanag4607;\r\nif (!wtap_read_bytes(wth->fh, &version_id, sizeof version_id, err, err_info))\r\nreturn (*err != WTAP_ERR_SHORT_READ) ? WTAP_OPEN_ERROR : WTAP_OPEN_NOT_MINE;\r\nif (!is_valid_id(GUINT16_TO_BE(version_id)))\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (file_seek(wth->fh, 0, SEEK_SET, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_STANAG_4607;\r\nwth->file_encap = WTAP_ENCAP_STANAG_4607;\r\nwth->snapshot_length = 0;\r\nstanag4607 = (stanag4607_t *)g_malloc(sizeof(stanag4607_t));\r\nwth->priv = (void *)stanag4607;\r\nstanag4607->base_secs = 0;\r\nwth->subtype_read = stanag4607_read;\r\nwth->subtype_seek_read = stanag4607_seek_read;\r\nwth->file_tsprec = WTAP_TSPREC_MSEC;\r\nreturn WTAP_OPEN_MINE;\r\n}

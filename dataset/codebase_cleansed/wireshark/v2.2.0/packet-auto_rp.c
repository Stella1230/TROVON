static int dissect_auto_rp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 ver_type, rp_count;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Auto-RP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nver_type = tvb_get_guint8(tvb, 0);\r\nrp_count = tvb_get_guint8(tvb, 1);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s (v%s) for %u RP%s",\r\nval_to_str_const(lo_nibble(ver_type), auto_rp_type_vals, "Unknown"),\r\nval_to_str_const(hi_nibble(ver_type), auto_rp_ver_vals, "Unknown"),\r\nrp_count, plurality(rp_count, "", "s"));\r\nif (tree) {\r\nproto_item *ti;\r\nproto_tree *auto_rp_tree, *ver_type_tree;\r\nint i, offset;\r\nguint16 holdtime;\r\noffset = 0;\r\nti = proto_tree_add_item(tree, proto_auto_rp, tvb, offset, -1, ENC_NA);\r\nauto_rp_tree = proto_item_add_subtree(ti, ett_auto_rp);\r\nver_type_tree = proto_tree_add_subtree_format(auto_rp_tree, tvb, offset, 1,\r\nett_auto_rp_ver_type, NULL, "Version: %s, Packet type: %s",\r\nval_to_str_const(hi_nibble(ver_type), auto_rp_ver_vals, "Unknown"),\r\nval_to_str_const(lo_nibble(ver_type), auto_rp_type_vals, "Unknown"));\r\nproto_tree_add_uint(ver_type_tree, hf_auto_rp_version, tvb, offset, 1, ver_type);\r\nproto_tree_add_uint(ver_type_tree, hf_auto_rp_type, tvb, offset, 1, ver_type);\r\noffset++;\r\nproto_tree_add_uint(auto_rp_tree, hf_auto_rp_count, tvb, offset, 1, rp_count);\r\noffset++;\r\nholdtime = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_uint_format_value(auto_rp_tree, hf_auto_rp_holdtime, tvb, offset, 2, holdtime,\r\n"%u second%s", holdtime, plurality(holdtime, "", "s"));\r\noffset+=2;\r\nproto_tree_add_item(auto_rp_tree, hf_auto_rp_reserved, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nfor (i = 0; i < rp_count; i++)\r\noffset = do_auto_rp_map(tvb, offset, auto_rp_tree);\r\nif (tvb_reported_length_remaining(tvb, offset) > 0)\r\nproto_tree_add_item(tree, hf_auto_rp_trailing_junk, tvb, offset, -1, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int do_auto_rp_map(tvbuff_t *tvb, int offset, proto_tree *auto_rp_tree)\r\n{\r\nproto_tree *map_tree;\r\nguint8 group_count;\r\nint i;\r\ngroup_count = tvb_get_guint8(tvb, offset + 5);\r\nmap_tree = proto_tree_add_subtree_format(auto_rp_tree, tvb, offset, 6 + group_count * 6,\r\nett_auto_rp_map, NULL,\r\n"RP %s: %u group%s", tvb_ip_to_str(tvb, offset),\r\ngroup_count, plurality(group_count, "", "s"));\r\nproto_tree_add_item(map_tree, hf_auto_rp_rp_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(map_tree, hf_auto_rp_pim_ver, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_uint(map_tree, hf_auto_rp_group_num, tvb, offset, 1, group_count);\r\noffset++;\r\nfor (i = 0; i < group_count; i++) {\r\nproto_tree *grp_tree;\r\nguint8 sign, mask_len;\r\nsign = tvb_get_guint8(tvb, offset);\r\nmask_len = tvb_get_guint8(tvb, offset + 1);\r\ngrp_tree = proto_tree_add_subtree_format(map_tree, tvb, offset, 6,\r\nett_auto_rp_group, NULL, "Group %s/%u (%s)",\r\ntvb_ip_to_str(tvb, offset + 2), mask_len,\r\nval_to_str_const(sign&AUTO_RP_SIGN_MASK, auto_rp_mask_sign_vals, ""));\r\nproto_tree_add_uint(grp_tree, hf_auto_rp_prefix_sgn, tvb, offset, 1, sign);\r\noffset++;\r\nproto_tree_add_uint(grp_tree, hf_auto_rp_mask_len, tvb, offset, 1, mask_len);\r\noffset++;\r\nproto_tree_add_item(grp_tree, hf_auto_rp_group_prefix, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nreturn offset;\r\n}\r\nvoid proto_register_auto_rp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_auto_rp_version,\r\n{"Protocol version", "auto_rp.version",\r\nFT_UINT8, BASE_DEC, VALS(auto_rp_ver_vals), AUTO_RP_VERSION_MASK,\r\n"Auto-RP protocol version", HFILL }},\r\n{ &hf_auto_rp_type,\r\n{"Packet type", "auto_rp.type",\r\nFT_UINT8, BASE_DEC, VALS(auto_rp_type_vals), AUTO_RP_TYPE_MASK,\r\n"Auto-RP packet type", HFILL }},\r\n{ &hf_auto_rp_count,\r\n{"RP count", "auto_rp.rp_count",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\n"The number of RP addresses contained in this message", HFILL }},\r\n{ &hf_auto_rp_group_num,\r\n{"Number of groups this RP maps to", "auto_rp.group_num",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_auto_rp_holdtime,\r\n{"Holdtime", "auto_rp.holdtime",\r\nFT_UINT16, BASE_DEC, NULL, 0,\r\n"The amount of time in seconds this announcement is valid", HFILL }},\r\n{ &hf_auto_rp_pim_ver,\r\n{"Version", "auto_rp.pim_ver",\r\nFT_UINT8, BASE_DEC, VALS(auto_rp_pim_ver_vals), AUTO_RP_PIM_VER_MASK,\r\n"RP's highest PIM version", HFILL }},\r\n{ &hf_auto_rp_rp_addr,\r\n{"RP address", "auto_rp.rp_addr",\r\nFT_IPv4, BASE_NONE, NULL, 0,\r\n"The unicast IP address of the RP", HFILL }},\r\n{ &hf_auto_rp_prefix_sgn,\r\n{"Sign", "auto_rp.prefix_sign",\r\nFT_UINT8, BASE_DEC, VALS(auto_rp_mask_sign_vals), AUTO_RP_SIGN_MASK,\r\n"Group prefix sign", HFILL }},\r\n{ &hf_auto_rp_mask_len,\r\n{"Mask length", "auto_rp.mask_len",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Length of group prefix", HFILL }},\r\n{ &hf_auto_rp_group_prefix,\r\n{"Prefix", "auto_rp.group_prefix",\r\nFT_IPv4, BASE_NONE, NULL, 0,\r\n"Group prefix", HFILL }},\r\n{ &hf_auto_rp_reserved,\r\n{"Reserved", "auto_rp.reserved",\r\nFT_UINT32, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_auto_rp_trailing_junk,\r\n{"Trailing junk", "auto_rp.trailing_junk",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_auto_rp,\r\n&ett_auto_rp_ver_type,\r\n&ett_auto_rp_map,\r\n&ett_auto_rp_group\r\n};\r\nproto_auto_rp = proto_register_protocol("Cisco Auto-RP",\r\n"Auto-RP", "auto_rp");\r\nproto_register_field_array(proto_auto_rp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nreturn;\r\n}\r\nvoid\r\nproto_reg_handoff_auto_rp(void)\r\n{\r\ndissector_handle_t auto_rp_handle;\r\nauto_rp_handle = create_dissector_handle(dissect_auto_rp,\r\nproto_auto_rp);\r\ndissector_add_uint("udp.port", UDP_PORT_PIM_RP_DISC, auto_rp_handle);\r\n}

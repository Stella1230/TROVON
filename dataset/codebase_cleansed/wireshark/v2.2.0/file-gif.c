static gint\r\ndissect_gif(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *gif_tree;\r\nproto_tree *subtree;\r\nguint offset = 0, len = 0;\r\nguint8 peek;\r\ngboolean color_map_present;\r\nguint8 color_resolution;\r\nguint8 image_bpp;\r\nguint tvb_len = tvb_reported_length(tvb);\r\nchar *str;\r\nguint8 version = 0;\r\nif (tvb_len < 20)\r\nreturn 0;\r\nstr = tvb_get_string_enc(wmem_packet_scope(), tvb, 0, 6, ENC_ASCII|ENC_NA);\r\nif (strcmp(str, "GIF87a") == 0) {\r\nversion = GIF_87a;\r\n} else if (strcmp(str, "GIF89a") == 0) {\r\nversion = GIF_89a;\r\n} else {\r\nreturn 0;\r\n}\r\nDISSECTOR_ASSERT(version);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " (%s)", str);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, hfi_gif, tvb, 0, -1, ENC_NA);\r\nproto_item_append_text(ti, ", Version: %s", str);\r\ngif_tree = proto_item_add_subtree(ti, ett_gif);\r\nproto_tree_add_item(gif_tree, &hfi_version, tvb, 0, 6, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(gif_tree, &hfi_screen_width, tvb, 6, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(gif_tree, &hfi_screen_height, tvb, 8, 2, ENC_LITTLE_ENDIAN);\r\npeek = tvb_get_guint8(tvb, 10);\r\ncolor_map_present = peek & 0x80;\r\ncolor_resolution = 1 + ((peek & 0x60) >> 4);\r\nimage_bpp = 1 + (peek & 0x07);\r\nsubtree = proto_tree_add_subtree(gif_tree, tvb, 10, 1, ett_global_flags, &ti,\r\n"Global settings:");\r\nif (color_map_present)\r\nproto_item_append_text(ti, " (Global color table present)");\r\nproto_item_append_text(ti,\r\n" (%u bit%s per color) (%u bit%s per pixel)",\r\ncolor_resolution, plurality(color_resolution, "", "s"),\r\nimage_bpp, plurality(image_bpp, "", "s"));\r\nproto_tree_add_item(subtree, &hfi_global_color_map_present,\r\ntvb, 10, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree, &hfi_global_color_resolution,\r\ntvb, 10, 1, ENC_LITTLE_ENDIAN);\r\nif (version == GIF_89a) {\r\nproto_tree_add_item(subtree, &hfi_global_color_map_ordered,\r\ntvb, 10, 1, ENC_LITTLE_ENDIAN);\r\n}\r\nproto_tree_add_item(subtree, &hfi_global_image_bpp,\r\ntvb, 10, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(gif_tree, &hfi_background_color,\r\ntvb, 11, 1, ENC_LITTLE_ENDIAN);\r\nif (version == GIF_89a) {\r\npeek = tvb_get_guint8(tvb, 12);\r\nif (peek) {\r\nproto_tree_add_uint_format(gif_tree, hfi_pixel_aspect_ratio.id,\r\ntvb, 12, 1, peek,\r\n"%u, yields an aspect ratio of (15 + %u) / 64 = %.2f",\r\npeek, peek, (float)(15 + peek) / 64.0);\r\n}\r\n}\r\nif (color_map_present) {\r\nlen = 3 * (1 << image_bpp);\r\nproto_tree_add_item(gif_tree, &hfi_global_color_map,\r\ntvb, 13, len, ENC_NA);\r\n} else {\r\nlen = 0;\r\n}\r\noffset = 13 + len;\r\nwhile (offset < tvb_len) {\r\npeek = tvb_get_guint8(tvb, offset);\r\nif (peek == 0x21) {\r\nguint32 item_len = 2;\r\nti = proto_tree_add_item(gif_tree, &hfi_extension,\r\ntvb, offset, 1, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_extension);\r\noffset++;\r\nproto_tree_add_item(subtree, &hfi_extension_label,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\npeek = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(ti, ": %s",\r\nval_to_str(peek, vals_extensions,\r\n"<Warning: Unknown extension 0x%02X>"));\r\noffset++;\r\ndo {\r\nlen = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_bytes_format(subtree, hfi_data_block.id, tvb,\r\noffset+1, len, NULL,\r\n"Data block (length = %u)", len);\r\noffset += (1 + len);\r\nitem_len += (1 + len);\r\n} while (len > 0);\r\nproto_item_set_len(ti, item_len);\r\n} else if (peek == 0x2C) {\r\nproto_tree *subtree2;\r\nproto_item *ti2;\r\nguint32 item_len = 11;\r\nti = proto_tree_add_item(gif_tree, &hfi_image,\r\ntvb, offset, 1, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_image);\r\noffset++;\r\nproto_tree_add_item(subtree, &hfi_image_left,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN); offset += 2;\r\nproto_tree_add_item(subtree, &hfi_image_top,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN); offset += 2;\r\nproto_tree_add_item(subtree, &hfi_image_width,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN); offset += 2;\r\nproto_tree_add_item(subtree, &hfi_image_height,\r\ntvb, offset, 2, ENC_LITTLE_ENDIAN); offset += 2;\r\npeek = tvb_get_guint8(tvb, offset);\r\ncolor_map_present = peek & 0x80;\r\ncolor_resolution = 1 + ((peek & 0x60) >> 4);\r\nimage_bpp = 1 + (peek & 0x07);\r\nsubtree2 = proto_tree_add_subtree(subtree, tvb, offset, 1, ett_local_flags, &ti2,\r\n"Local settings:");\r\nif (color_map_present)\r\nproto_item_append_text(ti2, " (Local color table present)");\r\nproto_item_append_text(ti2,\r\n" (%u bit%s per color) (%u bit%s per pixel)",\r\ncolor_resolution, plurality(color_resolution, "", "s"),\r\nimage_bpp, plurality(image_bpp, "", "s"));\r\nproto_tree_add_item(subtree2, &hfi_local_color_map_present,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree2, &hfi_local_color_resolution,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nif (version == GIF_89a) {\r\nproto_tree_add_item(subtree2, &hfi_local_color_map_ordered,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\nproto_tree_add_item(subtree2, &hfi_global_image_bpp,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nif (color_map_present) {\r\nlen = 3 * (1 << image_bpp);\r\nproto_tree_add_item(subtree, &hfi_local_color_map,\r\ntvb, offset, len, ENC_NA);\r\n} else {\r\nlen = 0;\r\n}\r\noffset += len;\r\nitem_len += len;\r\nproto_tree_add_item(subtree, &hfi_image_code_size,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\ndo {\r\nlen = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_bytes_format(subtree, hfi_data_block.id, tvb,\r\noffset + 1, len, NULL,\r\n"Data block (length = %u)", len);\r\noffset += 1 + len;\r\nitem_len += (1 + len);\r\n} while (len > 0);\r\nproto_item_set_len(ti, item_len);\r\n} else {\r\nproto_tree_add_item(gif_tree, &hfi_trailer,\r\ntvb, offset, 1, ENC_NA);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ndissect_gif_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_gif(tvb, pinfo, tree, NULL) > 0;\r\n}\r\nvoid\r\nproto_register_gif(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_version,\r\n&hfi_screen_width,\r\n&hfi_screen_height,\r\n&hfi_global_color_map_present,\r\n&hfi_global_color_resolution,\r\n&hfi_global_color_map_ordered,\r\n&hfi_global_image_bpp,\r\n&hfi_background_color,\r\n&hfi_pixel_aspect_ratio,\r\n&hfi_global_color_map,\r\n&hfi_local_color_map_present,\r\n&hfi_local_color_resolution,\r\n&hfi_local_color_map_ordered,\r\n&hfi_local_color_map,\r\n&hfi_extension,\r\n&hfi_extension_label,\r\n&hfi_image,\r\n&hfi_image_left,\r\n&hfi_image_top,\r\n&hfi_image_width,\r\n&hfi_image_height,\r\n&hfi_image_code_size,\r\n&hfi_trailer,\r\n&hfi_data_block\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_gif,\r\n&ett_global_flags,\r\n&ett_local_flags,\r\n&ett_extension,\r\n&ett_image,\r\n};\r\nint proto_gif;\r\nproto_gif = proto_register_protocol(\r\n"Compuserve GIF",\r\n"GIF image",\r\nIMG_GIF\r\n);\r\nhfi_gif = proto_registrar_get_nth(proto_gif);\r\nproto_register_fields(proto_gif, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\ngif_handle = register_dissector(IMG_GIF, dissect_gif, proto_gif);\r\n}\r\nvoid\r\nproto_reg_handoff_gif(void)\r\n{\r\ndissector_add_string("media_type", "image/gif", gif_handle);\r\nheur_dissector_add("http", dissect_gif_heur, "GIF file in HTTP", "gif_http", hfi_gif->id, HEURISTIC_ENABLE);\r\nheur_dissector_add("wtap_file", dissect_gif_heur, "GIF file", "gif_wtap", hfi_gif->id, HEURISTIC_ENABLE);\r\n}

static int\r\ndissect_octet_string(tvbuff_t *tvb, proto_tree *tree, int offset, guint8 flags)\r\n{\r\nguint32 n_oct, p_noct;\r\nNORLEL(flags, n_oct, tvb, offset);\r\np_noct = PADDING(n_oct);\r\nproto_tree_add_uint(tree, hf_ostring_len, tvb, offset, 4, n_oct);\r\nproto_tree_add_item(tree, hf_ostring, tvb, offset + 4, n_oct, ENC_ASCII|ENC_NA);\r\nreturn p_noct + 4;\r\n}\r\nstatic int\r\nconvert_oid_to_str(guint32 *oid, int len, char* str, int slen, char prefix)\r\n{\r\nint i, tlen = 0;\r\nif(!oid) return 0;\r\nif(!str) return 0;\r\nif(!len) return 0;\r\nif(!slen) return 0;\r\nif(slen < len) return 0;\r\nif(prefix) {\r\ntlen += g_snprintf(str, slen, ".1.3.6.1.%d", prefix);\r\n}\r\nfor(i=0; i < len && tlen < slen; i++) {\r\ntlen += g_snprintf(str+tlen, slen-tlen, ".%d", oid[i]);\r\n}\r\nreturn tlen;\r\n}\r\nstatic int\r\ndissect_object_id(tvbuff_t *tvb, proto_tree *tree, int offset, guint8 flags, enum OID_USAGE oid_usage)\r\n{\r\nguint8 n_subid;\r\nguint8 prefix;\r\nguint8 include;\r\nproto_tree* subtree;\r\nguint32 oid[2048];\r\nchar str_oid[2048];\r\nint i;\r\nmemset(oid, '\0', sizeof(oid));\r\nmemset(str_oid, '\0', sizeof(str_oid));\r\nn_subid = tvb_get_guint8(tvb, offset);\r\nprefix = tvb_get_guint8(tvb, offset + 1);\r\ninclude = tvb_get_guint8(tvb, offset + 2);\r\ntvb_get_guint8(tvb, offset + 3);\r\nfor(i=0; i<n_subid; i++) {\r\nNORLEL(flags, oid[i], tvb, (offset+4) + (i*4));\r\n}\r\nif(!convert_oid_to_str(&oid[0], n_subid, &str_oid[0], 2048, prefix))\r\ng_snprintf(&str_oid[0], 2048, "(null)");\r\nif(tree) {\r\nconst char *range = "";\r\nconst char *inclusion = (include) ? " (Inclusive)" : " (Exclusive)";\r\nswitch (oid_usage) {\r\ncase OID_START_RANGE: range = "(Range Start) "; break;\r\ncase OID_END_RANGE: range = " (Range End) "; break;\r\ndefault: inclusion = ""; break;\r\n}\r\nsubtree = proto_tree_add_subtree_format(tree, tvb, offset, 4 + (n_subid * 4) ,\r\nett_obj_ident, NULL, "Object Identifier: %s%s%s", range, str_oid, inclusion);\r\n} else\r\nreturn offset;\r\nproto_tree_add_uint(subtree, hf_oid_sub, tvb, offset, 1, n_subid);\r\nproto_tree_add_uint(subtree, hf_oid_prefix, tvb, offset + 1, 1, prefix);\r\nproto_tree_add_boolean(subtree, hf_oid_include, tvb, offset + 2, 1, include);\r\nproto_tree_add_string(subtree, hf_oid_str, tvb, offset + 4, (n_subid * 4), str_oid);\r\nreturn 4 + (n_subid * 4);\r\n}\r\nstatic int\r\ndissect_search_range(tvbuff_t *tvb, proto_tree *tree, int start_offset, guint8 flags, guint8 pdu_type)\r\n{\r\nint offset = start_offset;\r\noffset += dissect_object_id(tvb, tree, offset, flags, (pdu_type == AGENTX_GET_PDU) ? OID_EXACT : OID_START_RANGE);\r\noffset += dissect_object_id(tvb, tree, offset, flags, (pdu_type == AGENTX_GET_PDU) ? OID_EXACT : OID_END_RANGE);\r\nreturn (offset - start_offset);\r\n}\r\nstatic int\r\ndissect_val64(tvbuff_t *tvb, proto_tree *tree, int offset, guint8 flags)\r\n{\r\nguint encoding = (flags & NETWORK_BYTE_ORDER) ? ENC_BIG_ENDIAN : ENC_LITTLE_ENDIAN;\r\nproto_tree_add_item(tree, hf_val64, tvb, offset, 8, encoding);\r\nreturn 8;\r\n}\r\nstatic int\r\ndissect_val32(tvbuff_t *tvb, proto_tree *tree, int offset, guint8 flags)\r\n{\r\nguint encoding = (flags & NETWORK_BYTE_ORDER) ? ENC_BIG_ENDIAN : ENC_LITTLE_ENDIAN;\r\nproto_tree_add_item(tree, hf_val32, tvb, offset, 4, encoding);\r\nreturn 4;\r\n}\r\nstatic int\r\ndissect_varbind(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nguint16 vtag;\r\nint tlen;\r\nproto_tree* subtree;\r\nNORLES(flags, vtag, tvb, offset);\r\nif(tree) {\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_valrep, NULL, "Value Representation");\r\n} else return len;\r\nproto_tree_add_uint(subtree, hf_vtag, tvb, offset, 2, vtag);\r\ntlen = dissect_object_id(tvb, subtree, offset + 4, flags, OID_EXACT);\r\nswitch(vtag)\r\n{\r\ncase VB_OID:\r\ntlen += dissect_object_id(tvb, subtree, offset + tlen + 4, flags, OID_EXACT);\r\nbreak;\r\ncase VB_OPAQUE:\r\ncase VB_OSTR:\r\ncase VB_IPADDR:\r\ntlen += dissect_octet_string(tvb, subtree, offset + tlen + 4, flags);\r\nbreak;\r\ncase VB_TIMETICK:\r\ncase VB_COUNTER32:\r\ncase VB_INT:\r\ncase VB_GAUGE32:\r\ntlen += dissect_val32(tvb, subtree, offset + tlen + 4, flags);\r\nbreak;\r\ncase VB_COUNTER64:\r\ntlen += dissect_val64(tvb, subtree, offset + tlen + 4, flags);\r\nbreak;\r\ncase VB_NULL:\r\ncase VB_NOSUCHOBJ:\r\ncase VB_NOSUCHINST:\r\ncase VB_ENDOFMIB:\r\nbreak;\r\n}\r\nreturn tlen + 4;\r\n}\r\nstatic void\r\ndissect_response_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nguint encoding = (flags & NETWORK_BYTE_ORDER) ? ENC_BIG_ENDIAN : ENC_LITTLE_ENDIAN;\r\nguint32 r_uptime;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_response, NULL, "Response-PDU");\r\nNORLEL(flags, r_uptime, tvb, offset);\r\nproto_tree_add_uint_format(subtree, hf_resp_uptime, tvb, offset, 4, r_uptime,\r\n"sysUptime: %s", signed_time_msecs_to_str(wmem_packet_scope(), r_uptime));\r\nproto_tree_add_item(subtree, hf_resp_error, tvb, offset + 4, 2, encoding);\r\nproto_tree_add_item(subtree, hf_resp_index, tvb, offset + 6, 2, encoding);\r\noffset += 8;\r\nlen += PDU_HDR_LEN;\r\nwhile(len > offset) {\r\noffset += dissect_varbind(tvb, subtree, offset, len, flags);\r\n}\r\n}\r\nstatic void\r\ndissect_getnext_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_getnext, NULL, "GetNext-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nlen += PDU_HDR_LEN;\r\nwhile(len > offset) {\r\noffset += dissect_search_range(tvb, subtree, offset, flags, 0);\r\n}\r\n}\r\nstatic void\r\ndissect_get_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_get, NULL, "Get-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nlen += PDU_HDR_LEN;\r\nwhile(len > offset) {\r\noffset += dissect_search_range(tvb, subtree, offset, flags, AGENTX_GET_PDU);\r\n}\r\n}\r\nstatic void\r\ndissect_getbulk_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nguint encoding = (flags & NETWORK_BYTE_ORDER) ? ENC_BIG_ENDIAN : ENC_LITTLE_ENDIAN;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_getbulk, NULL, "GetBulk-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nproto_tree_add_item(subtree, hf_gbulk_nrepeat, tvb, offset, 2, encoding);\r\nproto_tree_add_item(subtree, hf_gbulk_mrepeat, tvb, offset + 2, 2, encoding);\r\noffset+=4;\r\nwhile(len >= offset) {\r\noffset += dissect_search_range(tvb, subtree, offset, flags, 0);\r\n}\r\n}\r\nstatic int\r\ndissect_open_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nguint8 timeout;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_open, NULL, "Open-PDU");\r\ntimeout = tvb_get_guint8(tvb, offset);\r\ntvb_get_ntoh24(tvb, offset + 1);\r\nproto_tree_add_uint(subtree, hf_open_timeout, tvb, offset, 1, timeout);\r\noffset+=4;\r\noffset += dissect_object_id(tvb, subtree, offset, flags, OID_EXACT);\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_close_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_close, NULL, "Close-PDU");\r\nproto_tree_add_item(subtree, hf_close_reason, tvb, offset, 1, ENC_NA);\r\ntvb_get_ntoh24(tvb, offset + 1);\r\noffset+=4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_register_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nguint encoding = (flags & NETWORK_BYTE_ORDER) ? ENC_BIG_ENDIAN : ENC_LITTLE_ENDIAN;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_register, NULL, "Register-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nproto_tree_add_item(subtree, hf_reg_timeout, tvb, offset, 1, encoding);\r\nproto_tree_add_item(subtree, hf_reg_prio, tvb, offset+1, 1, encoding);\r\nproto_tree_add_item(subtree, hf_reg_rsid, tvb, offset+2, 1, encoding);\r\noffset+=4;\r\noffset += dissect_object_id(tvb, subtree, offset, flags, OID_EXACT);\r\nlen += PDU_HDR_LEN;\r\nif(len > offset) {\r\nproto_tree_add_item(subtree, hf_reg_ubound, tvb, offset, 4, encoding);\r\noffset += 4;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_unregister_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nguint encoding = (flags & NETWORK_BYTE_ORDER) ? ENC_BIG_ENDIAN : ENC_LITTLE_ENDIAN;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_unregister, NULL, "Unregister-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nproto_tree_add_item(subtree, hf_unreg_timeout, tvb, offset, 1, encoding);\r\nproto_tree_add_item(subtree, hf_unreg_prio, tvb, offset+1, 1, encoding);\r\nproto_tree_add_item(subtree, hf_unreg_rsid, tvb, offset+2, 1, encoding);\r\noffset+=4;\r\noffset += dissect_object_id(tvb, subtree, offset, flags, OID_EXACT);\r\nlen += PDU_HDR_LEN;\r\nif(len > offset) {\r\nproto_tree_add_item(subtree, hf_unreg_ubound, tvb, offset, 4, encoding);\r\noffset += 4;\r\n}\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_testset_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_testset, NULL, "Testset-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nwhile(len > offset) {\r\noffset += dissect_varbind(tvb, subtree, offset, len, flags);\r\n}\r\n}\r\nstatic void\r\ndissect_notify_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_notify, NULL, "Notify-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nwhile(len > offset) {\r\noffset += dissect_varbind(tvb, subtree, offset, len, flags);\r\n}\r\n}\r\nstatic int\r\ndissect_ping_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_ping, NULL, "Ping-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_idx_alloc_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_idxalloc, NULL, "IndexAllocate-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nwhile(len > offset) {\r\noffset += dissect_varbind(tvb, subtree, offset, len, flags);\r\n}\r\n}\r\nstatic void\r\ndissect_idx_dealloc_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_idxdalloc, NULL, "IndexDeallocate-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\nwhile(len > offset) {\r\noffset += dissect_varbind(tvb, subtree, offset, len, flags);\r\n}\r\n}\r\nstatic int\r\ndissect_add_caps_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_addcap, NULL, "AddAgentCaps-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\noffset += dissect_object_id(tvb, subtree, offset, flags, OID_EXACT);\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_rem_caps_pdu(tvbuff_t *tvb, proto_tree *tree, int offset, int len, guint8 flags)\r\n{\r\nproto_tree* subtree;\r\nsubtree = proto_tree_add_subtree(tree, tvb, offset, len, ett_remcap, NULL, "RemoveAgentCaps-PDU");\r\nif(flags & NON_DEFAULT_CONTEXT) {\r\noffset += dissect_octet_string(tvb, subtree, offset, flags);\r\n}\r\noffset += dissect_object_id(tvb, subtree, offset, flags, OID_EXACT);\r\nreturn offset;\r\n}\r\nstatic guint\r\nget_agentx_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset, void *data _U_)\r\n{\r\nguint8 flags;\r\nguint32 plen;\r\nflags = tvb_get_guint8(tvb, offset + 2);\r\nNORLEL(flags, plen, tvb, offset + 16);\r\nif (plen > 0xFFFFFF)\r\nplen = 0xFFFFFF;\r\nreturn plen + 20;\r\n}\r\nstatic int\r\ndissect_agentx_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_tree* agentx_tree, *pdu_hdr_tree;\r\nproto_item *t_item;\r\nguint8 version;\r\nguint8 type;\r\nguint8 flags;\r\nguint32 session_id;\r\nguint32 trans_id;\r\nguint32 packet_id;\r\nguint32 payload_len;\r\nstatic const int * pdu_flags[] = {\r\n&hf_flags_register,\r\n&hf_flags_newindex,\r\n&hf_flags_anyindex,\r\n&hf_flags_context,\r\n&hf_flags_byteorder,\r\nNULL\r\n};\r\nversion = tvb_get_guint8(tvb, 0); offset+=1;\r\ntype = tvb_get_guint8(tvb, 1); offset+=1;\r\nflags = tvb_get_guint8(tvb, 2); offset+=1;\r\noffset+=1;\r\nNORLEL(flags, session_id, tvb, 4); offset+=4;\r\nNORLEL(flags, trans_id, tvb, 8); offset+=4;\r\nNORLEL(flags, packet_id, tvb, 12); offset+=4;\r\nNORLEL(flags, payload_len, tvb, 16); offset+=4;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AgentX");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s: sid=%d, tid=%d, packid=%d, plen=%d",\r\nval_to_str_ext_const(type, &type_values_ext, "unknown"),\r\nsession_id, trans_id, packet_id, payload_len);\r\nif(!tree)\r\nreturn tvb_captured_length(tvb);\r\nt_item = proto_tree_add_protocol_format(tree, proto_agentx, tvb, 0, -1,\r\n"Agent Extensibility (AgentX) Protocol: %s, sid=%d, tid=%d, packid=%d, plen=%d",\r\nval_to_str_ext_const(type, &type_values_ext, "unknown"),\r\nsession_id, trans_id, packet_id, payload_len);\r\nagentx_tree = proto_item_add_subtree(t_item, ett_agentx);\r\npdu_hdr_tree = proto_tree_add_subtree_format(agentx_tree, tvb, 0, PDU_HDR_LEN,\r\nett_pdu_hdr, NULL, "PDU Header: Type[%u], len=%d, sid=%d, tid=%d, packid=%d",\r\n(char)type, payload_len, session_id, trans_id, packet_id);\r\nproto_tree_add_uint(pdu_hdr_tree, hf_version, tvb, 0, 1, version);\r\nproto_tree_add_uint(pdu_hdr_tree, hf_type, tvb, 1, 1, type);\r\nproto_tree_add_bitmask(pdu_hdr_tree, tvb, 2, hf_flags, ett_flags, pdu_flags, ENC_NA);\r\nproto_tree_add_uint(pdu_hdr_tree, hf_session_id, tvb, 4, 4, session_id);\r\nproto_tree_add_uint(pdu_hdr_tree, hf_trans_id, tvb, 8, 4, trans_id);\r\nproto_tree_add_uint(pdu_hdr_tree, hf_packet_id, tvb, 12, 4, packet_id);\r\nproto_tree_add_uint(pdu_hdr_tree, hf_payload_len, tvb, 16, 4, payload_len);\r\nswitch(type) {\r\ncase AGENTX_OPEN_PDU:\r\ndissect_open_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_CLOSE_PDU:\r\ndissect_close_pdu(tvb, agentx_tree, offset, payload_len);\r\nbreak;\r\ncase AGENTX_REGISTER_PDU:\r\ndissect_register_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_UNREGISTER_PDU:\r\ndissect_unregister_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_GET_PDU:\r\ndissect_get_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_GETNEXT_PDU:\r\ndissect_getnext_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_GETBULK_PDU:\r\ndissect_getbulk_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_TESTSET_PDU:\r\ndissect_testset_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_COMMITSET_PDU:\r\ncase AGENTX_UNDOSET_PDU:\r\ncase AGENTX_CLEANUPSET_PDU:\r\nbreak;\r\ncase AGENTX_NOTIFY_PDU:\r\ndissect_notify_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_PING_PDU:\r\ndissect_ping_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_INDEX_ALLOC_PDU:\r\ndissect_idx_alloc_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_INDEX_DEALLOC_PDU:\r\ndissect_idx_dealloc_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_ADD_AGENT_CAPS_PDU:\r\ndissect_add_caps_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_REM_AGENT_CAPS_PDU:\r\ndissect_rem_caps_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\ncase AGENTX_RESPONSE_PDU:\r\ndissect_response_pdu(tvb, agentx_tree, offset, payload_len, flags);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_agentx(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, 20, get_agentx_pdu_len,\r\ndissect_agentx_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_agentx(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_version,\r\n{ "Version", "agentx.version", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"header version", HFILL }},\r\n{ &hf_type,\r\n{ "Type", "agentx.type", FT_UINT8, BASE_DEC | BASE_EXT_STRING, &type_values_ext, 0x0,\r\n"header type", HFILL }},\r\n{ &hf_flags,\r\n{ "Flags", "agentx.flags", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"header type", HFILL }},\r\n{ &hf_flags_register,\r\n{ "Register", "agentx.flags.register", FT_BOOLEAN, 8, TFS(&tfs_yes_no),\r\nINSTANCE_REGISTRATION, "Instance Registration", HFILL }},\r\n{ &hf_flags_newindex,\r\n{ "New Index", "agentx.flags.newindex", FT_BOOLEAN, 8, TFS(&tfs_yes_no),\r\nNEW_INDEX, "New Index Requested", HFILL }},\r\n{ &hf_flags_anyindex,\r\n{ "Any Index", "agentx.flags.anyindex", FT_BOOLEAN, 8, TFS(&tfs_yes_no),\r\nANY_INDEX, "Any Index Requested", HFILL }},\r\n{ &hf_flags_context,\r\n{ "Non-default Context", "agentx.flags.context", FT_BOOLEAN, 8, TFS(&tfs_agentx_context),\r\nNON_DEFAULT_CONTEXT, NULL, HFILL }},\r\n{ &hf_flags_byteorder,\r\n{ "Byte Order", "agentx.flags.byteorder", FT_BOOLEAN, 8, TFS(&tfs_agentx_byteorder),\r\nNETWORK_BYTE_ORDER, NULL, HFILL }},\r\n{ &hf_session_id,\r\n{ "sessionID", "agentx.session_id", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Session ID", HFILL }},\r\n{ &hf_trans_id,\r\n{ "TransactionID", "agentx.transaction_id", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Transaction ID", HFILL }},\r\n{ &hf_packet_id,\r\n{ "PacketID", "agentx.packet_id", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Packet ID", HFILL }},\r\n{ &hf_payload_len,\r\n{ "Payload length", "agentx.payload_len", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ostring,\r\n{ "Octet String", "agentx.ostring", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ostring_len,\r\n{ "OString len", "agentx.ostring_len", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Octet String Length", HFILL }},\r\n{ &hf_oid_sub,\r\n{ "Number subids", "agentx.n_subid", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_oid_prefix,\r\n{ "OID prefix", "agentx.oid_prefix", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_oid_include,\r\n{ "OID include", "agentx.oid_include", FT_BOOLEAN, 8, TFS(&tfs_yes_no),\r\nOID_IS_INCLUSIVE, NULL, HFILL }},\r\n{ &hf_oid_str,\r\n{ "OID", "agentx.oid", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_resp_uptime,\r\n{ "sysUpTime", "agentx.r.uptime", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_resp_error,\r\n{ "Resp. error", "agentx.r.error", FT_UINT16, BASE_DEC | BASE_EXT_STRING, &resp_errors_ext, 0x0,\r\n"response error", HFILL }},\r\n{ &hf_resp_index,\r\n{ "Resp. index", "agentx.r.index", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"response index", HFILL }},\r\n{ &hf_vtag,\r\n{ "Variable type", "agentx.v.tag", FT_UINT16, BASE_DEC | BASE_EXT_STRING, &vtag_values_ext, 0x0,\r\n"vtag", HFILL }},\r\n{ &hf_val32,\r\n{ "Value(32)", "agentx.v.val32", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"val32", HFILL }},\r\n{ &hf_val64,\r\n{ "Value(64)", "agentx.v.val64", FT_UINT64, BASE_DEC, NULL, 0x0,\r\n"val64", HFILL }},\r\n{ &hf_open_timeout,\r\n{ "Timeout", "agentx.o.timeout", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"open timeout", HFILL }},\r\n{ &hf_close_reason,\r\n{ "Reason", "agentx.c.reason", FT_UINT8, BASE_DEC, VALS(close_reasons), 0x0,\r\n"close reason", HFILL }},\r\n{ &hf_reg_timeout,\r\n{ "Timeout", "agentx.r.timeout", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Register timeout", HFILL }},\r\n{ &hf_reg_prio,\r\n{ "Priority", "agentx.r.priority", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Register Priority", HFILL }},\r\n{ &hf_reg_rsid,\r\n{ "Range_subid", "agentx.r.range_subid", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Register range_subid", HFILL }},\r\n{ &hf_reg_ubound,\r\n{ "Upper bound", "agentx.r.upper_bound", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Register upper bound", HFILL }},\r\n{ &hf_unreg_timeout,\r\n{ "Timeout", "agentx.u.timeout", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Unregister timeout", HFILL }},\r\n{ &hf_unreg_prio,\r\n{ "Priority", "agentx.u.priority", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Unregister Priority", HFILL }},\r\n{ &hf_unreg_rsid,\r\n{ "Range_subid", "agentx.u.range_subid", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Unregister range_subid", HFILL }},\r\n{ &hf_unreg_ubound,\r\n{ "Upper bound", "agentx.u.upper_bound", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Register upper bound", HFILL }},\r\n{ &hf_gbulk_nrepeat,\r\n{ "Repeaters", "agentx.gb.nrepeat", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"getBulk Num. repeaters", HFILL }},\r\n{ &hf_gbulk_mrepeat,\r\n{ "Max Repetition", "agentx.gb.mrepeat", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"getBulk Max repetition", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_agentx,\r\n&ett_pdu_hdr,\r\n&ett_get,\r\n&ett_getnext,\r\n&ett_search_range,\r\n&ett_obj_ident,\r\n&ett_response,\r\n&ett_valrep,\r\n&ett_open,\r\n&ett_close,\r\n&ett_register,\r\n&ett_unregister,\r\n&ett_getbulk,\r\n&ett_testset,\r\n&ett_commitset,\r\n&ett_undoset,\r\n&ett_cleanupset,\r\n&ett_notify,\r\n&ett_ping,\r\n&ett_idxalloc,\r\n&ett_idxdalloc,\r\n&ett_addcap,\r\n&ett_remcap,\r\n&ett_flags,\r\n};\r\nmodule_t *agentx_module;\r\nproto_agentx = proto_register_protocol("AgentX",\r\n"AgentX", "agentx");\r\nproto_register_field_array(proto_agentx, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nagentx_module = prefs_register_protocol(proto_agentx, proto_reg_handoff_agentx);\r\nprefs_register_uint_preference(agentx_module, "tcp.agentx_port",\r\n"AgentX listener TCP Port",\r\n"Set the TCP port for AgentX"\r\n"(if other than the default of 705)",\r\n10, &global_agentx_tcp_port);\r\n}\r\nvoid\r\nproto_reg_handoff_agentx(void)\r\n{\r\nstatic gboolean agentx_prefs_initialized = FALSE;\r\nstatic dissector_handle_t agentx_handle;\r\nstatic guint agentx_tcp_port;\r\nif(!agentx_prefs_initialized) {\r\nagentx_handle = create_dissector_handle(dissect_agentx, proto_agentx);\r\nagentx_prefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("tcp.port", agentx_tcp_port, agentx_handle);\r\n}\r\nagentx_tcp_port = global_agentx_tcp_port;\r\ndissector_add_uint("tcp.port", agentx_tcp_port, agentx_handle);\r\n}

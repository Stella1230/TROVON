static const char* connection_type(char con_type[]) {\r\nif (strlen(con_type) != 1) return "Unknown";\r\nif (con_type[0] == 'D') return "Distributed Search";\r\nif (con_type[0] == 'P') return "Peer Connection";\r\nif (con_type[0] == 'F') return "File Transfer";\r\nreturn "Unknown";\r\n}\r\nstatic gboolean check_slsk_format(tvbuff_t *tvb, int offset, const char format[]){\r\nswitch ( format[0] ) {\r\ncase 'i':\r\nif (tvb_captured_length_remaining(tvb, offset) < 4) return FALSE;\r\noffset += 4;\r\nbreak;\r\ncase 'b':\r\nif (tvb_captured_length_remaining(tvb, offset) < 1) return FALSE;\r\noffset += 1;\r\nbreak;\r\ncase 's':\r\nif (tvb_captured_length_remaining(tvb, offset) < 4) return FALSE;\r\nif (tvb_captured_length_remaining(tvb, offset) < (int)tvb_get_letohl(tvb, offset)+4) return FALSE;\r\noffset += tvb_get_letohl(tvb, offset)+4;\r\nbreak;\r\ncase '*':\r\nreturn TRUE;\r\ndefault:\r\nreturn FALSE;\r\n}\r\nif (format[1] == '\0' ) {\r\nif (tvb_captured_length_remaining(tvb, offset) > 0)\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nreturn check_slsk_format(tvb, offset, &format[1]);\r\n}\r\nstatic const char* get_message_type(tvbuff_t *tvb) {\r\nint msg_code = tvb_get_letohl(tvb, 4);\r\nconst gchar *message_type = try_val_to_str(msg_code, slsk_tcp_msgs);\r\nif (message_type == NULL) {\r\nif (check_slsk_format(tvb, 4, "bisis"))\r\nmessage_type = "Distributed Search";\r\nelse if (check_slsk_format(tvb, 4, "bssi"))\r\nmessage_type = "Peer Init";\r\nelse if (check_slsk_format(tvb, 4, "bi"))\r\nmessage_type = "Pierce Fw";\r\nelse\r\nmessage_type = "Unknown";\r\n}\r\nreturn message_type;\r\n}\r\nstatic guint get_slsk_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint32 msg_len;\r\nmsg_len = tvb_get_letohl(tvb, offset);\r\nmsg_len += 4;\r\nreturn msg_len;\r\n}\r\nstatic int dissect_slsk_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti, *ti_len=NULL;\r\nproto_tree *slsk_tree;\r\nint offset, i, j;\r\nguint32 msg_len, msg_code;\r\nconst gchar *message_type;\r\nguint8 *str;\r\nint comprlen = 0;\r\nint uncomprlen = 0;\r\nint uncompr_tvb_offset = 0;\r\nint i2 = 0;\r\nint j2 = 0;\r\nint i3 = 0;\r\nint j3 = 0;\r\noffset = 0;\r\nmsg_len = tvb_get_letohl(tvb, offset);\r\nmsg_code = tvb_get_letohl(tvb, offset+4);\r\nmessage_type = get_message_type(tvb);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "slsk");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "SoulSeek Message");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s", message_type);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_slsk, tvb, 0, -1, ENC_NA);\r\nslsk_tree = proto_item_add_subtree(ti, ett_slsk);\r\nti_len = proto_tree_add_uint(slsk_tree, hf_slsk_message_length, tvb, offset, 4, msg_len);\r\noffset += 4;\r\nswitch (msg_code) {\r\ncase 1:\r\nif (check_slsk_format(tvb, offset, "issi")) {\r\nmessage_type = "Login";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_password, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_version, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ibs") || check_slsk_format(tvb, offset, "ibsi")) {\r\nmessage_type = "Login Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format_value(slsk_tree, hf_slsk_login_successful, tvb, offset, 1, tvb_get_guint8(tvb, offset),\r\n"%s (Byte: %d)", val_to_str_const(tvb_get_guint8(tvb, offset), slsk_yes_no, "Unknown"), tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_login_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nif (i == 1){\r\nproto_tree_add_ipv4(slsk_tree, hf_slsk_client_ip, tvb, offset, 4, tvb_get_ntohl(tvb, offset));\r\noffset += 4;\r\n}\r\n}\r\nbreak;\r\ncase 2:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Set Wait Port";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_port, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 3:\r\nif (check_slsk_format(tvb, offset, "isii")) {\r\nmessage_type = "Get Peer Address Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_ipv4(slsk_tree, hf_slsk_ip, tvb, offset, 4, tvb_get_ntohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_port, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Get Peer Address";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 4:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Get Shared File List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 5:\r\nif (check_slsk_format(tvb, offset, "isb")) {\r\nmessage_type = "User Exists Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format_value(slsk_tree, hf_slsk_user_exists, tvb, offset, 1, tvb_get_guint8(tvb, offset),\r\n"%s (Byte: %d)", val_to_str_const(tvb_get_guint8(tvb, offset), slsk_yes_no, "Unknown"), tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "User Exists Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "i*")) {\r\nmessage_type = "Shared File List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ncomprlen = tvb_captured_length_remaining(tvb, offset);\r\nif (slsk_decompress == TRUE){\r\ntvbuff_t *uncompr_tvb = tvb_child_uncompress(tvb, tvb, offset, comprlen);\r\nif (uncompr_tvb == NULL) {\r\nproto_tree_add_expert(slsk_tree, pinfo, &ei_slsk_zlib_decompression_failed, tvb, offset, -1);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\n} else {\r\nproto_item *ti2 = proto_tree_add_item(slsk_tree, hf_slsk_compr_packet, tvb, offset, -1, ENC_NA);\r\nproto_tree *slsk_compr_packet_tree = proto_item_add_subtree(ti2, ett_slsk_compr_packet);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"( compressed packet length: %d)", comprlen);\r\nuncomprlen = tvb_reported_length_remaining(uncompr_tvb, 0);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"(uncompressed packet length: %d)", uncomprlen);\r\nadd_new_data_source(pinfo, uncompr_tvb,\r\n"Uncompressed SoulSeek data");\r\nuncompr_tvb_offset = 0;\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "i*")) {\r\ni=0;\r\nj = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb, uncompr_tvb_offset, 4, j,\r\n"Number of directories: %u", j);\r\nuncompr_tvb_offset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "si*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length, uncompr_tvb,\r\nuncompr_tvb_offset, 4, len,\r\n"Directory #%d String Length: %u", i+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_directory_name, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"Directory #%d Name: %s", i+1, str);\r\nuncompr_tvb_offset += 4+len;\r\ni2=0;\r\nj2 = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, j2,\r\n"Directory #%d Number of files: %u", i+1, j2);\r\nuncompr_tvb_offset += 4;\r\nwhile (i2<j2){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "bsiisi*")) {\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_byte, uncompr_tvb,\r\nuncompr_tvb_offset, 1, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Code: %d", i+1, i2+1, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 1;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length,\r\nuncompr_tvb, uncompr_tvb_offset, 4, len,\r\n"Dir #%d File #%d String Length: %u", i+1, i2+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_filename, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"Dir #%d File #%d Filename: %s", i+1, i2+1, str);\r\nuncompr_tvb_offset += 4+len;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4,\r\ntvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Size1: %u", i+1, i2+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4,\r\ntvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Size2: %d", i+1, i2+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length,\r\nuncompr_tvb, uncompr_tvb_offset, 4, len,\r\n"Dir #%d File #%d String Length: %u", i+1, i2+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_filename_ext, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"Dir #%d File #%d ext: %s", i+1, i2+1, str);\r\nuncompr_tvb_offset += 4+len;\r\ni3=0;\r\nj3 = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4,\r\ntvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Number of attributes: %d", i+1, i2+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nwhile (i3<j3){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "ii*")) {\r\nproto_tree_add_uint_format(slsk_compr_packet_tree,\r\nhf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4,\r\ntvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Attr #%d type: %s (Code: %d)", i+1, i2+1, i3+1, val_to_str_const(tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset), slsk_attr_type, "Unknown"), tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree,\r\nhf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4,\r\ntvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Attr #%d value: %d", i+1, i2+1, i3+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\ni3++;\r\n}\r\n}\r\n}\r\ni2++;\r\n}\r\n}\r\ni++;\r\n}\r\n}\r\n}\r\n}else {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"[zlib compressed packet]");\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 0, 0,\r\n"( compressed packet length: %d)", comprlen);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\n}\r\n}\r\nbreak;\r\ncase 7:\r\nif (check_slsk_format(tvb, offset, "isi")) {\r\nmessage_type = "Get User Status Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_status_code, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Status: %s (Code: %d)", val_to_str_const(tvb_get_letohl(tvb, offset), slsk_status_codes, "Unknown"), tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Get User Status";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 9:\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nmessage_type = "File Search Result";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ncomprlen = tvb_captured_length_remaining(tvb, offset);\r\nif (slsk_decompress == TRUE){\r\ntvbuff_t *uncompr_tvb = tvb_child_uncompress(tvb, tvb, offset, comprlen);\r\nif (uncompr_tvb == NULL) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, tvb_captured_length_remaining(tvb, offset), 0,\r\n"[zlib compressed packet]");\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, 0, 0, 0,\r\n"(uncompression failed !)");\r\n} else {\r\nproto_item *ti2 = proto_tree_add_item(slsk_tree, hf_slsk_compr_packet, tvb, offset, -1, ENC_NA);\r\nproto_tree *slsk_compr_packet_tree = proto_item_add_subtree(ti2, ett_slsk_compr_packet);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"( compressed packet length: %d)", comprlen);\r\nuncomprlen = tvb_captured_length_remaining(uncompr_tvb, 0);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"(uncompressed packet length: %d)", uncomprlen);\r\nadd_new_data_source(pinfo, uncompr_tvb,\r\n"Uncompressed SoulSeek data");\r\nuncompr_tvb_offset = 0;\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "sii*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint(slsk_compr_packet_tree, hf_slsk_string_length, uncompr_tvb, uncompr_tvb_offset, 4, len);\r\nproto_tree_add_item(slsk_compr_packet_tree, hf_slsk_username, uncompr_tvb, uncompr_tvb_offset+4, len, ENC_ASCII|ENC_NA);\r\nuncompr_tvb_offset += 4+len;\r\nproto_tree_add_item(slsk_compr_packet_tree, hf_slsk_token, uncompr_tvb, uncompr_tvb_offset, 4, ENC_LITTLE_ENDIAN);\r\nuncompr_tvb_offset += 4;\r\ni=0; j = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb, uncompr_tvb_offset, 4, j,\r\n"Number of files: %d", j);\r\nuncompr_tvb_offset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "bsiisi*")) {\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_byte, uncompr_tvb, 0, 0, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset),\r\n"File #%d Code: %d", i+1, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 1;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length, uncompr_tvb,\r\nuncompr_tvb_offset, 4, len,\r\n"File #%d String Length: %u", i+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_filename, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"File #%d Filename: %s", i+1, str);\r\nuncompr_tvb_offset += 4+len;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"File #%d Size1: %d", i+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"File #%d Size2: %d", i+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length, uncompr_tvb,\r\nuncompr_tvb_offset, 4, len,\r\n"File #%d String Length: %d", i+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_filename_ext, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"File #%d ext: %s", i+1, str);\r\nuncompr_tvb_offset += 4+len;\r\ni2=0;\r\nj2 = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, j,\r\n"File #%d Number of attributes: %d", i+1, j);\r\nuncompr_tvb_offset += 4;\r\nwhile (i2<j2){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "ii*")) {\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"File #%d Attr #%d type: %s (Code: %d)", i+1, i2+1, val_to_str_const(tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset), slsk_attr_type, "Unknown"), tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"File #%d Attr #%d value: %d", i+1, i2+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\n}\r\ni2++;\r\n}\r\n}\r\ni++;\r\n}\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_byte, uncompr_tvb, uncompr_tvb_offset, 1, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset),\r\n"Free upload slots: %s (Byte: %d)", val_to_str_const(tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset), slsk_yes_no, "Unknown"), tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 1;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb, uncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Upload speed: %d", tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb, uncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"In Queue: %d", tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\n}\r\n}\r\n}else {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"[zlib compressed packet]");\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"( compressed packet length: %d)", comprlen);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\n}\r\n}\r\nbreak;\r\ncase 13:\r\nif (check_slsk_format(tvb, offset, "isss")) {\r\nmessage_type = "Say ChatRoom";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_chat_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "iss")) {\r\nmessage_type = "Say ChatRoom";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_chat_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 14:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Join/Add Room";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isi*")) {\r\nmessage_type = "Join Room User List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_users_in_room, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_user, tvb, offset+4, len, str, "User #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_users_in_room, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_status_code, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Status of User #%d: %s (Code: %d)", i+1, val_to_str_const(tvb_get_letohl(tvb, offset), slsk_status_codes, "Unknown"), tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_users_in_room, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "iiiii*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Average Speed of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Downloadnum of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Something of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Files of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Folders of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Slotsfull Records: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Slots full of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase 15:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Leave Room";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "User Info Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 16:\r\nif (check_slsk_format(tvb, offset, "issiiiiiii")) {\r\nmessage_type = "User Joined Room";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_total_uploads, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_average_speed, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_download_number, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_files, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_directories, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_slotsfull, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isbiib") || check_slsk_format(tvb, offset, "isbsiib")) {\r\nmessage_type = "User Info Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_user_description, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_picture_exists, tvb, offset, 1, tvb_get_guint8(tvb, offset),\r\n"Picture exists: %s (Byte: %d)", val_to_str_const(tvb_get_guint8(tvb, offset), slsk_yes_no, "Unknown"), tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\nif ( tvb_get_guint8(tvb, offset -1 ) == 1 ) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Picture Size: %d", tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_picture, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nproto_tree_add_uint(slsk_tree, hf_slsk_total_uploads, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_queued_uploads, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_slots_available, tvb, offset, 1, tvb_get_guint8(tvb, offset),\r\n"Upload Slots available: %s (Byte: %d)", val_to_str_const(tvb_get_guint8(tvb, offset), slsk_yes_no, "Unknown"), tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\n}\r\nbreak;\r\ncase 17:\r\nif (check_slsk_format(tvb, offset, "iss")) {\r\nmessage_type = "User Left Room";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 18:\r\nif (check_slsk_format(tvb, offset, "iiss")) {\r\nguint32 len;\r\nmessage_type = "Connect To Peer";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_item(slsk_tree, hf_slsk_token, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len);\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, len, ENC_ASCII|ENC_NA);\r\noffset += 4+len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len);\r\nstr = tvb_get_string_enc(wmem_packet_scope(), tvb, offset+4, len, ENC_ASCII);\r\nproto_tree_add_string_format_value(slsk_tree, hf_slsk_connection_type, tvb, offset+4, len, str,\r\n"%s (Char: %s)", connection_type(str),\r\nformat_text(str, len));\r\noffset += 4+len;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "issiii")) {\r\nguint32 len;\r\nmessage_type = "Connect To Peer";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len);\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, len, ENC_ASCII|ENC_NA);\r\noffset += 4+len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len);\r\nstr = tvb_get_string_enc(wmem_packet_scope(), tvb, offset+4, len, ENC_ASCII);\r\nproto_tree_add_string_format_value(slsk_tree, hf_slsk_connection_type, tvb, offset+4, len, str,\r\n"%s (Char: %s)", connection_type(str),\r\nformat_text(str, len));\r\noffset += 4+len;\r\nproto_tree_add_item(slsk_tree, hf_slsk_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(slsk_tree, hf_slsk_port, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(slsk_tree, hf_slsk_token, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 22:\r\nif (check_slsk_format(tvb, offset, "iss")) {\r\nmessage_type = "Message User Send";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_chat_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "iiiss")) {\r\nmessage_type = "Message User Receive";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_chat_message_id, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_timestamp, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_chat_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 23:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Message User Receive Ack";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_chat_message_id, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 26:\r\nif (check_slsk_format(tvb, offset, "iis")) {\r\nmessage_type = "File Search";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_search_text, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 28:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Set Status";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_status_code, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Status: %s (Code: %d)", val_to_str_const(tvb_get_letohl(tvb, offset), slsk_status_codes, "Unknown"), tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 32:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Ping";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 34:\r\nif (check_slsk_format(tvb, offset, "isi")) {\r\nmessage_type = "Update Upload Speed";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_average_speed, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 35:\r\nif (check_slsk_format(tvb, offset, "iii")) {\r\nmessage_type = "Shared Files & Folders ";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_folder_count, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_file_count, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 36:\r\nif (check_slsk_format(tvb, offset, "isiiiii")) {\r\nmessage_type = "Get User Stats Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_average_speed, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_download_number, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_files, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_directories, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Get User Stats";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "iis")) {\r\nmessage_type = "Folder Contents Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_directory, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 37:\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nmessage_type = "Folder Contents Response";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ncomprlen = tvb_captured_length_remaining(tvb, offset);\r\nif (slsk_decompress == TRUE){\r\ntvbuff_t *uncompr_tvb = tvb_child_uncompress(tvb, tvb, offset, comprlen);\r\nif (uncompr_tvb == NULL) {\r\nproto_tree_add_expert(slsk_tree, pinfo, &ei_slsk_zlib_decompression_failed, tvb, offset, -1);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\n} else {\r\nproto_item *ti2 = proto_tree_add_item(slsk_tree, hf_slsk_compr_packet, tvb, offset, -1, ENC_NA);\r\nproto_tree *slsk_compr_packet_tree = proto_item_add_subtree(ti2, ett_slsk_compr_packet);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"[compressed packet length: %d]", comprlen);\r\nuncomprlen = tvb_captured_length_remaining(uncompr_tvb, 0);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"[uncompressed packet length: %d]", uncomprlen);\r\nadd_new_data_source(pinfo, uncompr_tvb,\r\n"Uncompressed SoulSeek data");\r\nuncompr_tvb_offset = 0;\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "isi*")) {\r\nguint32 len;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Token: %d", tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length,\r\nuncompr_tvb, uncompr_tvb_offset, 4, len,\r\n"Directory Name String Length: %u", len);\r\nproto_tree_add_item(slsk_compr_packet_tree, hf_slsk_directory_name, uncompr_tvb, uncompr_tvb_offset+4, len, ENC_ASCII|ENC_NA);\r\nuncompr_tvb_offset += 4+len;\r\ni=0; j = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, j,\r\n"Number of directories: %d", j);\r\nuncompr_tvb_offset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "si*")) {\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length,\r\nuncompr_tvb, uncompr_tvb_offset, 4, len,\r\n"Directory #%d Name String Length: %u", i+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_directory_name, uncompr_tvb, uncompr_tvb_offset+4, len,\r\nstr, "Directory #%d Name: %s", i+1, str);\r\nuncompr_tvb_offset += 4+len;\r\ni2 = 0;\r\nj2 = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, j2,\r\n"Directory #%d Number of files: %d", i+1, j2);\r\nuncompr_tvb_offset += 4;\r\nwhile (i2<j2){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "bsiisi*")) {\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_byte,\r\nuncompr_tvb, uncompr_tvb_offset, 1, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Code: %d", i+1, i2+1, tvb_get_guint8(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 1;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length,\r\nuncompr_tvb, uncompr_tvb_offset, 4, len,\r\n"Dir #%d File #%d String Length: %d", i+1, i2+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_filename, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"Dir #%d File #%d Filename: %s", i+1, i2+1, str);\r\nuncompr_tvb_offset += 4+len;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Size1: %d", i+1, i2+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer,\r\nuncompr_tvb, uncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Size2: %d", i+1, i2+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nlen = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_string_length,\r\nuncompr_tvb, uncompr_tvb_offset, 4, len,\r\n"Dir #%d File #%d String Length: %d", i+1, i2+1, len);\r\nstr = tvb_format_text(uncompr_tvb, uncompr_tvb_offset+4, len);\r\nproto_tree_add_string_format(slsk_compr_packet_tree, hf_slsk_filename_ext, uncompr_tvb, uncompr_tvb_offset+4, len, str,\r\n"Dir #%d File #%d ext: %s", i+1, i2+1, str);\r\nuncompr_tvb_offset += 4+len;\r\ni3 = 0;\r\nj3 = tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset);\r\nproto_tree_add_uint_format(slsk_compr_packet_tree, hf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, j3,\r\n"Dir #%d File #%d Number of attributes: %d", i+1, i2+1, j3);\r\nuncompr_tvb_offset += 4;\r\nwhile (i3<j3){\r\nif (check_slsk_format(uncompr_tvb, uncompr_tvb_offset, "ii*")) {\r\nproto_tree_add_uint_format(slsk_compr_packet_tree,\r\nhf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Attr #%d type: %s (Code: %d)", i+1, i2+1, i3+1, val_to_str_const(tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset), slsk_attr_type, "Unknown"), tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\nproto_tree_add_uint_format(slsk_compr_packet_tree,\r\nhf_slsk_integer, uncompr_tvb,\r\nuncompr_tvb_offset, 4, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset),\r\n"Dir #%d File #%d Attr #%d value: %d", i+1, i2+1, i3+1, tvb_get_letohl(uncompr_tvb, uncompr_tvb_offset));\r\nuncompr_tvb_offset += 4;\r\n}\r\ni3++;\r\n}\r\n}\r\ni2++;\r\n}\r\n}\r\ni++;\r\n}\r\n}\r\n}\r\n}else {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"[zlib compressed packet]");\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, -1, 0,\r\n"( compressed packet length: %d)", comprlen);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\n}\r\n}\r\nbreak;\r\ncase 40:\r\nif (check_slsk_format(tvb, offset, "isi")) {\r\nmessage_type = "Queued Downloads";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_slotsfull, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "iiis") || check_slsk_format(tvb, offset, "iiisii")) {\r\nmessage_type = "Transfer Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_transfer_direction, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Transfer Direction: %s (Code: %d)", val_to_str_const(tvb_get_letohl(tvb, offset), slsk_transfer_direction, "Unknown"), tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nif (i == 1){\r\nproto_tree_add_uint(slsk_tree, hf_slsk_size, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\n}\r\nbreak;\r\ncase 41:\r\nif (check_slsk_format(tvb, offset, "iibs") || check_slsk_format(tvb, offset, "iibii") || check_slsk_format(tvb, offset, "iib")) {\r\nmessage_type = "Transfer Response";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\ni = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_allowed, tvb, offset, 1, tvb_get_guint8(tvb, offset),\r\n"Download allowed: %s (Byte: %d)", val_to_str_const(tvb_get_guint8(tvb, offset), slsk_yes_no, "Unknown"), tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\nif ( i == 1 ) {\r\nif ( tvb_reported_length_remaining(tvb, offset) == 8 ) {\r\nproto_tree_add_uint(slsk_tree, hf_slsk_size, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\n} else {\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_string, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\n}\r\nbreak;\r\ncase 42:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Placehold Upload";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 43:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Queue Upload";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 44:\r\nif (check_slsk_format(tvb, offset, "isi")) {\r\nmessage_type = "Place In Queue";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_place_in_queue, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 46:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Upload Failed";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 50:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Make Own Recommendation";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_recommendation, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isi")) {\r\nmessage_type = "Remove Own Recommendation";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_recommendation, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_ranking, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "iss")) {\r\nmessage_type = "Queue Failed";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_string, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 51:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Add Things I like / Place In Queue Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 52:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Remove Things I like";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 54:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Get Recommendations";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii*")) {\r\nmessage_type = "Get Recommendations Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Recommendations: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "si*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_recommendation, tvb, offset+4, len, str,\r\n"Recommendation #%d: %s", i+1, str);\r\noffset += 4+len;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_ranking, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Ranking #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 55:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Type 55";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 56:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Get Global Rankings";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii*")) {\r\nmessage_type = "Get Global Rankings Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Recommendations: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "si*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_recommendation, tvb, offset+4, len, str,\r\n"Recommendation #%d: %s", i+1, str);\r\noffset += 4+len;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_ranking, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Ranking #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 57:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Get User Recommendations";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isi*")) {\r\nmessage_type = "Get User Recommendations Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Recommendations: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_recommendation, tvb, offset+4, len, str,\r\n"Recommendation #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 58:\r\nif (check_slsk_format(tvb, offset, "isi*")) {\r\nmessage_type = "Admin Command";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_string, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_number_of_users, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Strings: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_string, tvb, offset+4, len, str,\r\n"String #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 60:\r\nif (check_slsk_format(tvb, offset, "isii")) {\r\nmessage_type = "Place In Line Response";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_place_in_queue, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 62:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Room Added";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 63:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Room Removed";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 64:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Room List Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii*")) {\r\nmessage_type = "Room List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_number_of_rooms, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_room, tvb, offset+4, len, str,\r\n"Room #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_number_of_rooms, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Users in Room #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase 65:\r\nif (check_slsk_format(tvb, offset, "isissiii")) {\r\nmessage_type = "Exact File Search";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_directory, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 16, 0,\r\n"(+12 0 bytes)");\r\noffset += 12;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "iissiiib")) {\r\nmessage_type = "Exact File Search";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_filename, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_directory, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 13, 0,\r\n"(+13 0 bytes)");\r\noffset += 13;\r\n}\r\nbreak;\r\ncase 66:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Admin Message";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_chat_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 67:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Global User List Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isi*")) {\r\nmessage_type = "Global User List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_room, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_users_in_room, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_user, tvb, offset+4, len, str, "User #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_users_in_room, tvb, offset, 4, j);\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_status_code, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Status of User #%d: %s (Code: %d)", i+1, val_to_str_const(tvb_get_letohl(tvb, offset), slsk_status_codes, "Unknown"), tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_users_in_room, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "iiiii*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Average Speed of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Downloadnum of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Something of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Files of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Folders of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Slotsfull Records: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "i*")) {\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Slots full of User #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\n}\r\nbreak;\r\ncase 68:\r\nif (check_slsk_format(tvb, offset, "isiiiis")) {\r\nmessage_type = "Tunneled Message";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_code, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_ipv4(slsk_tree, hf_slsk_ip, tvb, offset, 4, tvb_get_ntohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_port, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_chat_message, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 69:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Privileged User List Request";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii*")) {\r\nmessage_type = "Privileged User List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_number_of_users, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Privileged Users: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_user, tvb, offset+4, len, str,\r\n"User #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 71:\r\nif (check_slsk_format(tvb, offset, "ib")) {\r\nmessage_type = "Get Parent List";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_byte, tvb, offset, 1, tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\n}\r\nbreak;\r\ncase 73:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Type 73";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 83:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Parent Min Speed";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_parent_min_speed, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 84:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Parent Speed Connection Ratio";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_parent_speed_connection_ratio, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 86:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Parent Inactivity Before Disconnect";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_seconds_parent_inactivity_before_disconnect, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 87:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Server Inactivity Before Disconnect";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_seconds_server_inactivity_before_disconnect, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 88:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Nodes In Cache Before Disconnect";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_nodes_in_cache_before_disconnect, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 90:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Seconds Before Ping Children";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_seconds_before_ping_children, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 91:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Add To Privileged";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 92:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Check Privileges";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Check Privileges Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_number_of_days, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 93:\r\nif (check_slsk_format(tvb, offset, "ibisis")) {\r\nmessage_type = "Embedded Message";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nif ( tvb_get_guint8(tvb, offset) == 3 ){\r\nmessage_type = "Distributed Search";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 1, msg_code,\r\n"Embedded Message Type: %s (Byte: %d)", message_type, 3);\r\noffset += 1;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_search_text, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\n}\r\nbreak;\r\ncase 100:\r\nif (check_slsk_format(tvb, offset, "ib")) {\r\nmessage_type = "Become Parent";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_byte, tvb, offset, 1, tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\n}\r\nbreak;\r\ncase 102:\r\nif (check_slsk_format(tvb, offset, "ii*")) {\r\nmessage_type = "Random Parent Addresses";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_number_of_users, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Parent Addresses: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "sii*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_user, tvb, offset+4, len, str,\r\n"User #%d: %s", i+1, str);\r\noffset += 4+len;\r\nproto_tree_add_item(slsk_tree, hf_slsk_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_port, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Port Number #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 103:\r\nif (check_slsk_format(tvb, offset, "iis")) {\r\nmessage_type = "Send Wishlist Entry";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_search_text, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nbreak;\r\ncase 104:\r\nif (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Type 104";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 110:\r\nif (check_slsk_format(tvb, offset, "i")) {\r\nmessage_type = "Get Similar Users";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii*")) {\r\nmessage_type = "Get Similar Users Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(slsk_tree, hf_slsk_number_of_users, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "si*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_user, tvb, offset+4, len, str,\r\n"User #%d: %s", i+1, str);\r\noffset += 4+len;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Same Recommendations #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 111:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Get Recommendations for Item";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_recommendation, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isi*")) {\r\nmessage_type = "Get Recommendations for Item Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_recommendation, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Recommendations: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "si*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_recommendation, tvb, offset+4, len, str,\r\n"Recommendation #%d: %s", i+1, str);\r\noffset += 4+len;\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_ranking, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Ranking #%d: %d", i+1, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 112:\r\nif (check_slsk_format(tvb, offset, "is")) {\r\nmessage_type = "Get Similar Users for Item";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_recommendation, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "isi*")) {\r\nmessage_type = "Get Similar Users for Item Reply";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_item(slsk_tree, hf_slsk_string_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(slsk_tree, hf_slsk_recommendation, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\ni=0; j = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset),\r\n"Number of Recommendations: %d", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nwhile (i<j){\r\nif (check_slsk_format(tvb, offset, "s*")) {\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len,\r\n"String #%d Length: %d", i+1, len);\r\nstr = tvb_format_text(tvb, offset+4, len);\r\nproto_tree_add_string_format(slsk_tree, hf_slsk_username, tvb, offset+4, len, str,\r\n"Username #%d: %s", i+1, str);\r\noffset += 4+len;\r\n}\r\ni++;\r\n}\r\n}\r\nbreak;\r\ncase 1001:\r\nif (check_slsk_format(tvb, offset, "iis")) {\r\nmessage_type = "Can't Connect To Peer";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\nelse if (check_slsk_format(tvb, offset, "ii")) {\r\nmessage_type = "Can't Connect To Peer";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\nbreak;\r\ndefault:\r\nif (check_slsk_format(tvb, offset, "bisis")) {\r\nif ( tvb_get_guint8(tvb, offset) == 3 ){\r\nmessage_type = "Distributed Search";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 1, msg_code,\r\n"Message Type: %s (Byte: %d)", message_type, 3);\r\noffset += 1;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_integer, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\nproto_tree_add_item(slsk_tree, hf_slsk_search_text, tvb, offset+4, tvb_get_letohl(tvb, offset), ENC_ASCII|ENC_NA);\r\noffset += 4+tvb_get_letohl(tvb, offset);\r\n}\r\n}\r\nelse if (check_slsk_format(tvb, offset, "bssi")) {\r\nif ( tvb_get_guint8(tvb, offset) == 1 ){\r\nguint32 len;\r\nmessage_type = "Peer Init";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 1, msg_code,\r\n"Message Type: %s (Byte: %d)", message_type, 1);\r\noffset += 1;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len);\r\nproto_tree_add_item(slsk_tree, hf_slsk_username, tvb, offset+4, len, ENC_ASCII|ENC_NA);\r\noffset += 4+len;\r\nlen = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(slsk_tree, hf_slsk_string_length, tvb, offset, 4, len);\r\nstr = tvb_get_string_enc(wmem_packet_scope(), tvb, offset+4, len, ENC_ASCII);\r\nproto_tree_add_string_format_value(slsk_tree, hf_slsk_connection_type, tvb, offset+4, len, str,\r\n"%s (Char: %s)", connection_type(str),\r\nformat_text(str, len));\r\noffset += 4+len;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\n}\r\nelse if (check_slsk_format(tvb, offset, "bi")) {\r\nif ( tvb_get_guint8(tvb, offset) == 0 ){\r\nmessage_type = "Pierce Fw";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 1, msg_code,\r\n"Message Type: %s (Byte: %d)", message_type, 0);\r\noffset += 1;\r\nproto_tree_add_uint(slsk_tree, hf_slsk_token, tvb, offset, 4, tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\n}\r\n}\r\nelse {\r\nmessage_type = "Unknown";\r\nproto_tree_add_uint_format(slsk_tree, hf_slsk_message_code, tvb, offset, 4, msg_code,\r\n"Message Type: %s (Code: %02d)", message_type, msg_code);\r\noffset += 4;\r\n}\r\nbreak;\r\n}\r\n}\r\nif(offset < (int)msg_len){\r\nexpert_add_info(pinfo, ti_len, &ei_slsk_unknown_data);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int dissect_slsk(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, slsk_desegment, 4, get_slsk_pdu_len, dissect_slsk_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_slsk(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_slsk_integer,\r\n{ "Integer", "slsk.integer",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_string,\r\n{ "String", "slsk.string",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_byte,\r\n{ "Byte", "slsk.byte",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_message_length,\r\n{ "Message Length", "slsk.message.length",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_message_code,\r\n{ "Message Code", "slsk.message.code",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_client_ip,\r\n{ "Client IP", "slsk.client.ip",\r\nFT_IPv4, BASE_NONE, NULL, 0, "Client IP Address", HFILL } },\r\n#if 0\r\n{ &hf_slsk_server_ip,\r\n{ "SoulSeek Server IP", "slsk.server.ip",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n#endif\r\n{ &hf_slsk_string_length,\r\n{ "String Length", "slsk.string.length",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_directory_name,\r\n{ "Directory name", "slsk.directory_name",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_username,\r\n{ "Username", "slsk.username",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_password,\r\n{ "Password", "slsk.password",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_version,\r\n{ "Version", "slsk.version",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_login_successful,\r\n{ "Login successful", "slsk.login.successful",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_login_message,\r\n{ "Login Message", "slsk.login.message",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_port,\r\n{ "Port Number", "slsk.port.number",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_ip,\r\n{ "IP Address", "slsk.ip.address",\r\nFT_IPv4, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_user_exists,\r\n{ "User exists", "slsk.user.exists",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_status_code,\r\n{ "Status Code", "slsk.status.code",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_room,\r\n{ "Room", "slsk.room",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_chat_message,\r\n{ "Chat Message", "slsk.chat.message",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_users_in_room,\r\n{ "Users in Room", "slsk.room.users",\r\nFT_UINT32, BASE_DEC, NULL, 0, "Number of Users in Room", HFILL } },\r\n{ &hf_slsk_token,\r\n{ "Token", "slsk.token",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_connection_type,\r\n{ "Connection Type", "slsk.connection.type",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_chat_message_id,\r\n{ "Chat Message ID", "slsk.chat.message.id",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_timestamp,\r\n{ "Timestamp", "slsk.timestamp",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_search_text,\r\n{ "Search Text", "slsk.search.text",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_folder_count,\r\n{ "Folder Count", "slsk.folder.count",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_file_count,\r\n{ "File Count", "slsk.file.count",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_average_speed,\r\n{ "Average Speed", "slsk.average.speed",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_download_number,\r\n{ "Download Number", "slsk.download.number",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_files,\r\n{ "Files", "slsk.files",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_directories,\r\n{ "Directories", "slsk.directories",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_slotsfull,\r\n{ "Slots full", "slsk.slots.full",\r\nFT_UINT32, BASE_DEC, NULL, 0, "Upload Slots Full", HFILL } },\r\n{ &hf_slsk_place_in_queue,\r\n{ "Place in Queue", "slsk.queue.place",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_number_of_rooms,\r\n{ "Number of Rooms", "slsk.room.count",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_filename,\r\n{ "Filename", "slsk.filename",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_filename_ext,\r\n{ "Filename ext", "slsk.filename_ext",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_directory,\r\n{ "Directory", "slsk.directory",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_size,\r\n{ "Size", "slsk.size",\r\nFT_UINT32, BASE_DEC, NULL, 0, "File Size", HFILL } },\r\n#if 0\r\n{ &hf_slsk_checksum,\r\n{ "Checksum", "slsk.checksum",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n#endif\r\n{ &hf_slsk_code,\r\n{ "Code", "slsk.code",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_number_of_users,\r\n{ "Number of Users", "slsk.user.count",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_number_of_days,\r\n{ "Number of Days", "slsk.day.count",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_transfer_direction,\r\n{ "Transfer Direction", "slsk.transfer.direction",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_user_description,\r\n{ "User Description", "slsk.user.description",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_picture_exists,\r\n{ "Picture exists", "slsk.user.picture.exists",\r\nFT_UINT8, BASE_DEC, NULL, 0, "User has a picture", HFILL } },\r\n{ &hf_slsk_picture,\r\n{ "Picture", "slsk.user.picture",\r\nFT_STRING, BASE_NONE, NULL, 0, "User Picture", HFILL } },\r\n#if 0\r\n{ &hf_slsk_user_uploads,\r\n{ "User uploads", "slsk.uploads.user",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n#endif\r\n{ &hf_slsk_total_uploads,\r\n{ "Total uploads allowed", "slsk.uploads.total",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_queued_uploads,\r\n{ "Queued uploads", "slsk.uploads.queued",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_slots_available,\r\n{ "Upload Slots available", "slsk.uploads.available",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_allowed,\r\n{ "Download allowed", "slsk.user.allowed",\r\nFT_UINT8, BASE_DEC, NULL, 0, "allowed", HFILL } },\r\n{ &hf_slsk_compr_packet,\r\n{ "[zlib compressed packet]", "slsk.compr.packet",\r\nFT_NONE, BASE_NONE, NULL, 0, "zlib compressed packet", HFILL } },\r\n{ &hf_slsk_parent_min_speed,\r\n{ "Parent Min Speed", "slsk.parent.min.speed",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_parent_speed_connection_ratio,\r\n{ "Parent Speed Connection Ratio", "slsk.parent.speed.connection.ratio",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_seconds_parent_inactivity_before_disconnect,\r\n{ "Seconds Parent Inactivity Before Disconnect", "slsk.seconds.parent.inactivity.before.disconnect",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_seconds_server_inactivity_before_disconnect,\r\n{ "Seconds Server Inactivity Before Disconnect", "slsk.seconds.server.inactivity.before.disconnect",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_nodes_in_cache_before_disconnect,\r\n{ "Nodes In Cache Before Disconnect", "slsk.nodes.in.cache.before.disconnect",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_seconds_before_ping_children,\r\n{ "Seconds Before Ping Children", "slsk.seconds.before.ping.children",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_recommendation,\r\n{ "Recommendation", "slsk.recommendation",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_user,\r\n{ "User", "slsk.user",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_slsk_ranking,\r\n{ "Ranking", "slsk.ranking",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_slsk,\r\n&ett_slsk_compr_packet,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_slsk_unknown_data, { "slsk.unknown_data", PI_UNDECODED, PI_WARN, "Unknown Data (not interpreted)", EXPFILL }},\r\n{ &ei_slsk_zlib_decompression_failed, { "slsk.zlib_decompression_failed", PI_PROTOCOL, PI_WARN, "zlib compressed packet failed to decompress", EXPFILL }},\r\n};\r\nmodule_t *slsk_module;\r\nexpert_module_t* expert_slsk;\r\nproto_slsk = proto_register_protocol("SoulSeek Protocol", "SoulSeek", "slsk");\r\nproto_register_field_array(proto_slsk, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_slsk = expert_register_protocol(proto_slsk);\r\nexpert_register_field_array(expert_slsk, ei, array_length(ei));\r\nslsk_module = prefs_register_protocol(proto_slsk, NULL);\r\nprefs_register_bool_preference(slsk_module, "desegment",\r\n"Reassemble SoulSeek messages spanning multiple TCP segments",\r\n"Whether the SoulSeek dissector should reassemble messages spanning multiple TCP segments."\r\n" To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&slsk_desegment);\r\n#ifdef HAVE_ZLIB\r\nprefs_register_bool_preference(slsk_module, "decompress",\r\n"Decompress zlib compressed packets inside SoulSeek messages",\r\n"Whether the SoulSeek dissector should decompress all zlib compressed packets inside messages",\r\n&slsk_decompress);\r\n#endif\r\n}\r\nvoid\r\nproto_reg_handoff_slsk(void)\r\n{\r\ndissector_handle_t slsk_handle;\r\nslsk_handle = create_dissector_handle(dissect_slsk, proto_slsk);\r\ndissector_add_uint("tcp.port", TCP_PORT_SLSK_1, slsk_handle);\r\ndissector_add_uint("tcp.port", TCP_PORT_SLSK_2, slsk_handle);\r\ndissector_add_uint("tcp.port", TCP_PORT_SLSK_3, slsk_handle);\r\n}

void nghttp2_put_uint16be(uint8_t *buf, uint16_t n) {\r\nuint16_t x = g_htons(n);\r\nmemcpy(buf, &x, sizeof(uint16_t));\r\n}\r\nvoid nghttp2_put_uint32be(uint8_t *buf, uint32_t n) {\r\nuint32_t x = g_htonl(n);\r\nmemcpy(buf, &x, sizeof(uint32_t));\r\n}\r\nuint16_t nghttp2_get_uint16(const uint8_t *data) {\r\nuint16_t n;\r\nmemcpy(&n, data, sizeof(uint16_t));\r\nreturn g_ntohs(n);\r\n}\r\nuint32_t nghttp2_get_uint32(const uint8_t *data) {\r\nuint32_t n;\r\nmemcpy(&n, data, sizeof(uint32_t));\r\nreturn g_ntohl(n);\r\n}\r\nvoid nghttp2_downcase(uint8_t *s, size_t len) {\r\nsize_t i;\r\nfor (i = 0; i < len; ++i) {\r\ns[i] = DOWNCASE_TBL[s[i]];\r\n}\r\n}\r\nint nghttp2_adjust_local_window_size(int32_t *local_window_size_ptr,\r\nint32_t *recv_window_size_ptr,\r\nint32_t *recv_reduction_ptr,\r\nint32_t *delta_ptr) {\r\nif (*delta_ptr > 0) {\r\nint32_t recv_reduction_delta;\r\nint32_t delta;\r\nint32_t new_recv_window_size =\r\nnghttp2_max(0, *recv_window_size_ptr) - *delta_ptr;\r\nif (new_recv_window_size >= 0) {\r\n*recv_window_size_ptr = new_recv_window_size;\r\nreturn 0;\r\n}\r\ndelta = -new_recv_window_size;\r\nif (*local_window_size_ptr > NGHTTP2_MAX_WINDOW_SIZE - delta) {\r\nreturn NGHTTP2_ERR_FLOW_CONTROL;\r\n}\r\n*local_window_size_ptr += delta;\r\nrecv_reduction_delta = nghttp2_min(*recv_reduction_ptr, delta);\r\n*recv_reduction_ptr -= recv_reduction_delta;\r\nif (*recv_window_size_ptr < 0) {\r\n*recv_window_size_ptr += recv_reduction_delta;\r\n} else {\r\n*recv_window_size_ptr = recv_reduction_delta;\r\n}\r\n*delta_ptr -= recv_reduction_delta;\r\nreturn 0;\r\n}\r\nif (*local_window_size_ptr + *delta_ptr < 0 ||\r\n*recv_window_size_ptr < INT32_MIN - *delta_ptr ||\r\n*recv_reduction_ptr > INT32_MAX + *delta_ptr) {\r\nreturn NGHTTP2_ERR_FLOW_CONTROL;\r\n}\r\n*local_window_size_ptr += *delta_ptr;\r\n*recv_window_size_ptr += *delta_ptr;\r\n*recv_reduction_ptr -= *delta_ptr;\r\n*delta_ptr = 0;\r\nreturn 0;\r\n}\r\nint nghttp2_should_send_window_update(int32_t local_window_size,\r\nint32_t recv_window_size) {\r\nreturn recv_window_size > 0 && recv_window_size >= local_window_size / 2;\r\n}\r\nconst char *nghttp2_strerror(int error_code) {\r\nswitch (error_code) {\r\ncase 0:\r\nreturn "Success";\r\ncase NGHTTP2_ERR_INVALID_ARGUMENT:\r\nreturn "Invalid argument";\r\ncase NGHTTP2_ERR_BUFFER_ERROR:\r\nreturn "Out of buffer space";\r\ncase NGHTTP2_ERR_UNSUPPORTED_VERSION:\r\nreturn "Unsupported SPDY version";\r\ncase NGHTTP2_ERR_WOULDBLOCK:\r\nreturn "Operation would block";\r\ncase NGHTTP2_ERR_PROTO:\r\nreturn "Protocol error";\r\ncase NGHTTP2_ERR_INVALID_FRAME:\r\nreturn "Invalid frame octets";\r\ncase NGHTTP2_ERR_EOF:\r\nreturn "EOF";\r\ncase NGHTTP2_ERR_DEFERRED:\r\nreturn "Data transfer deferred";\r\ncase NGHTTP2_ERR_STREAM_ID_NOT_AVAILABLE:\r\nreturn "No more Stream ID available";\r\ncase NGHTTP2_ERR_STREAM_CLOSED:\r\nreturn "Stream was already closed or invalid";\r\ncase NGHTTP2_ERR_STREAM_CLOSING:\r\nreturn "Stream is closing";\r\ncase NGHTTP2_ERR_STREAM_SHUT_WR:\r\nreturn "The transmission is not allowed for this stream";\r\ncase NGHTTP2_ERR_INVALID_STREAM_ID:\r\nreturn "Stream ID is invalid";\r\ncase NGHTTP2_ERR_INVALID_STREAM_STATE:\r\nreturn "Invalid stream state";\r\ncase NGHTTP2_ERR_DEFERRED_DATA_EXIST:\r\nreturn "Another DATA frame has already been deferred";\r\ncase NGHTTP2_ERR_START_STREAM_NOT_ALLOWED:\r\nreturn "request HEADERS is not allowed";\r\ncase NGHTTP2_ERR_GOAWAY_ALREADY_SENT:\r\nreturn "GOAWAY has already been sent";\r\ncase NGHTTP2_ERR_INVALID_HEADER_BLOCK:\r\nreturn "Invalid header block";\r\ncase NGHTTP2_ERR_INVALID_STATE:\r\nreturn "Invalid state";\r\ncase NGHTTP2_ERR_TEMPORAL_CALLBACK_FAILURE:\r\nreturn "The user callback function failed due to the temporal error";\r\ncase NGHTTP2_ERR_FRAME_SIZE_ERROR:\r\nreturn "The length of the frame is invalid";\r\ncase NGHTTP2_ERR_HEADER_COMP:\r\nreturn "Header compression/decompression error";\r\ncase NGHTTP2_ERR_FLOW_CONTROL:\r\nreturn "Flow control error";\r\ncase NGHTTP2_ERR_INSUFF_BUFSIZE:\r\nreturn "Insufficient buffer size given to function";\r\ncase NGHTTP2_ERR_PAUSE:\r\nreturn "Callback was paused by the application";\r\ncase NGHTTP2_ERR_TOO_MANY_INFLIGHT_SETTINGS:\r\nreturn "Too many inflight SETTINGS";\r\ncase NGHTTP2_ERR_PUSH_DISABLED:\r\nreturn "Server push is disabled by peer";\r\ncase NGHTTP2_ERR_DATA_EXIST:\r\nreturn "DATA or HEADERS frame has already been submitted for the stream";\r\ncase NGHTTP2_ERR_SESSION_CLOSING:\r\nreturn "The current session is closing";\r\ncase NGHTTP2_ERR_HTTP_HEADER:\r\nreturn "Invalid HTTP header field was received";\r\ncase NGHTTP2_ERR_HTTP_MESSAGING:\r\nreturn "Violation in HTTP messaging rule";\r\ncase NGHTTP2_ERR_REFUSED_STREAM:\r\nreturn "Stream was refused";\r\ncase NGHTTP2_ERR_INTERNAL:\r\nreturn "Internal error";\r\ncase NGHTTP2_ERR_CANCEL:\r\nreturn "Cancel";\r\ncase NGHTTP2_ERR_NOMEM:\r\nreturn "Out of memory";\r\ncase NGHTTP2_ERR_CALLBACK_FAILURE:\r\nreturn "The user callback function failed";\r\ncase NGHTTP2_ERR_BAD_CLIENT_MAGIC:\r\nreturn "Received bad client magic byte string";\r\ncase NGHTTP2_ERR_FLOODED:\r\nreturn "Flooding was detected in this HTTP/2 session, and it must be "\r\n"closed";\r\ndefault:\r\nreturn "Unknown error code";\r\n}\r\n}\r\nint nghttp2_check_header_name(const uint8_t *name, size_t len) {\r\nconst uint8_t *last;\r\nif (len == 0) {\r\nreturn 0;\r\n}\r\nif (*name == ':') {\r\nif (len == 1) {\r\nreturn 0;\r\n}\r\n++name;\r\n--len;\r\n}\r\nfor (last = name + len; name != last; ++name) {\r\nif (!VALID_HD_NAME_CHARS[*name]) {\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nint nghttp2_check_header_value(const uint8_t *value, size_t len) {\r\nconst uint8_t *last;\r\nfor (last = value + len; value != last; ++value) {\r\nif (!VALID_HD_VALUE_CHARS[*value]) {\r\nreturn 0;\r\n}\r\n}\r\nreturn 1;\r\n}\r\nuint8_t *nghttp2_cpymem(uint8_t *dest, const void *src, size_t len) {\r\nmemcpy(dest, src, len);\r\nreturn dest + len;\r\n}\r\nconst char *nghttp2_http2_strerror(uint32_t error_code) {\r\nswitch (error_code) {\r\ncase NGHTTP2_NO_ERROR:\r\nreturn "NO_ERROR";\r\ncase NGHTTP2_PROTOCOL_ERROR:\r\nreturn "PROTOCOL_ERROR";\r\ncase NGHTTP2_INTERNAL_ERROR:\r\nreturn "INTERNAL_ERROR";\r\ncase NGHTTP2_FLOW_CONTROL_ERROR:\r\nreturn "FLOW_CONTROL_ERROR";\r\ncase NGHTTP2_SETTINGS_TIMEOUT:\r\nreturn "SETTINGS_TIMEOUT";\r\ncase NGHTTP2_STREAM_CLOSED:\r\nreturn "STREAM_CLOSED";\r\ncase NGHTTP2_FRAME_SIZE_ERROR:\r\nreturn "FRAME_SIZE_ERROR";\r\ncase NGHTTP2_REFUSED_STREAM:\r\nreturn "REFUSED_STREAM";\r\ncase NGHTTP2_CANCEL:\r\nreturn "CANCEL";\r\ncase NGHTTP2_COMPRESSION_ERROR:\r\nreturn "COMPRESSION_ERROR";\r\ncase NGHTTP2_CONNECT_ERROR:\r\nreturn "CONNECT_ERROR";\r\ncase NGHTTP2_ENHANCE_YOUR_CALM:\r\nreturn "ENHANCE_YOUR_CALM";\r\ncase NGHTTP2_INADEQUATE_SECURITY:\r\nreturn "INADEQUATE_SECURITY";\r\ncase NGHTTP2_HTTP_1_1_REQUIRED:\r\nreturn "HTTP_1_1_REQUIRED";\r\ndefault:\r\nreturn "unknown";\r\n}\r\n}

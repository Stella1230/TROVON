static int\r\ndissect_userlog(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *userlog_header, *userlog_tree;\r\nproto_tree *userlog_log;\r\ngint offset = 0;\r\nguint log_count = 1;\r\nguint log_type, log_max;\r\nif (tvb_reported_length(tvb) < USERLOG_MIN_LENGTH)\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "UserLog");\r\ncol_clear(pinfo->cinfo,COL_INFO);\r\nti = proto_tree_add_item(tree, proto_userlog, tvb, 0, -1, ENC_NA);\r\nuserlog_tree = proto_item_add_subtree(ti, ett_userlog);\r\nuserlog_header = proto_tree_add_subtree(userlog_tree, tvb, 0, 16, ett_userlog_header, NULL, "UserLog Header");\r\nproto_tree_add_item(userlog_header, hf_userlog_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item_ret_uint(userlog_header, hf_userlog_logtype, tvb, offset, 1, ENC_BIG_ENDIAN, &log_type);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "LogType = %s", val_to_str(log_type, logtype, "Unknown (0x%02x)"));\r\noffset += 1;\r\nproto_tree_add_item_ret_uint(userlog_header, hf_userlog_count, tvb, offset, 2, ENC_BIG_ENDIAN, &log_max);\r\nproto_item_append_text(ti, ", Log Count = %d", log_max);\r\noffset += 2;\r\nproto_tree_add_item(userlog_header, hf_userlog_timestamp, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_header, hf_userlog_header_reserved, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nif (userlog_tree) {\r\nwhile ( log_count <= log_max)\r\n{\r\nuserlog_log = proto_tree_add_subtree_format(userlog_tree, tvb, offset, 64, ett_userlog_log, NULL, "UserLog No.%d", log_count);\r\nproto_tree_add_item(userlog_log, hf_userlog_proto, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(userlog_log, hf_userlog_Operator, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(userlog_log, hf_userlog_IPVerion, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(userlog_log, hf_userlog_IPToS, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(userlog_log, hf_userlog_SourceIP, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_SrcNatIP, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_DestIP, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_DestNatIP, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_SrcPort, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(userlog_log, hf_userlog_SrcNatPort, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(userlog_log, hf_userlog_DestPort, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(userlog_log, hf_userlog_DestNatPort, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(userlog_log, hf_userlog_StartTime, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_EndTime, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_InTotalPkg, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_InTotalByte, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_OutTotalPkg, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_OutTotalByte, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_Reserved1, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_Reserved2, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(userlog_log, hf_userlog_Reserved3, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nlog_count++;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_userlog(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_userlog_version,\r\n{ "Version", "userlog.version",\r\nFT_UINT8, BASE_DEC,\r\nVALS(version), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_logtype,\r\n{ "LogType", "userlog.logtype",\r\nFT_UINT8, BASE_DEC,\r\nVALS(logtype), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_count,\r\n{ "LogCount", "userlog.count",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_timestamp,\r\n{ "TimeStamp", "userlog.timestamp",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_header_reserved,\r\n{ "Reserved", "userlog.header_reserved",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_proto,\r\n{ "Protocol", "userlog.proto",\r\nFT_UINT8, BASE_DEC|BASE_EXT_STRING,\r\n&ipproto_val_ext, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_Operator,\r\n{ "Operator", "userlog.Operator",\r\nFT_UINT8, BASE_DEC,\r\nVALS(Operator), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_IPVerion,\r\n{ "IP Version", "userlog.IPVersion",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_IPToS,\r\n{ "IP ToS", "userlog.IPToS",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_SourceIP,\r\n{ "Source-IP", "userlog.SourceIP",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_SrcNatIP,\r\n{ "Source-NAT-IP", "userlog.Source-NAT-IP",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_DestIP,\r\n{ "Destination-IP", "userlog.Destination-IP",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_DestNatIP,\r\n{ "Destination-NAT-IP", "userlog.Destination-NAT-IP",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_SrcPort,\r\n{ "Source-Port", "userlog.Source-Port",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_SrcNatPort,\r\n{ "Source-NAT-Port", "userlog.Source-NAT-Port",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_DestPort,\r\n{ "Destination-Port", "userlog.Destination-Port",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_DestNatPort,\r\n{ "Destination-NAT-Port", "userlog.Destination-NAT-Port",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_StartTime,\r\n{ "StartTime", "userlog.StartTime",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_EndTime,\r\n{ "EndTime", "userlog.EndTime",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_InTotalPkg,\r\n{ "InTotalPkg", "userlog.InTotalPkg",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_InTotalByte,\r\n{ "InTotalByte", "userlog.InTotalByte",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_OutTotalPkg,\r\n{ "OutTotalPkg", "userlog.OutTotalPkg",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_OutTotalByte,\r\n{ "OutTotalByte", "userlog.OutTotalByte",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_Reserved1,\r\n{ "Reserved1", "userlog.Reserved1",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_Reserved2,\r\n{ "Reserved2", "userlog.Reserved2",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_userlog_Reserved3,\r\n{ "Reserved3", "userlog.Reserved3",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_userlog,\r\n&ett_userlog_header,\r\n&ett_userlog_log\r\n};\r\nproto_userlog = proto_register_protocol("UserLog Protocol", "UserLog", "userlog");\r\nproto_register_field_array(proto_userlog, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_userlog(void)\r\n{\r\ndissector_handle_t userlog_handle;\r\nuserlog_handle = create_dissector_handle(dissect_userlog, proto_userlog);\r\ndissector_add_for_decode_as("udp.port", userlog_handle);\r\n}

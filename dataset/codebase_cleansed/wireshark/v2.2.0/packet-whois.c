static int\r\ndissect_whois(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_item *ti, *expert_ti;\r\nproto_tree *whois_tree;\r\nconversation_t *conversation;\r\nwhois_transaction_t *whois_trans;\r\ngboolean is_query;\r\nguint len;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WHOIS");\r\nif (pinfo->destport == WHOIS_PORT) {\r\nis_query = TRUE;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Query");\r\n} else {\r\nis_query = FALSE;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Answer");\r\n}\r\nconversation = find_or_create_conversation(pinfo);\r\nwhois_trans = (whois_transaction_t *)conversation_get_proto_data(conversation, proto_whois);\r\nif (whois_trans == NULL) {\r\nwhois_trans = wmem_new0(wmem_file_scope(), whois_transaction_t);\r\nconversation_add_proto_data(conversation, proto_whois, whois_trans);\r\n}\r\nlen = tvb_reported_length(tvb);\r\nif (!PINFO_FD_VISITED(pinfo)) {\r\nif (pinfo->can_desegment) {\r\nif (is_query) {\r\nif ((len < 2) || (tvb_memeql(tvb, len - 2, "\r\n", 2))) {\r\npinfo->desegment_len = DESEGMENT_ONE_MORE_SEGMENT;\r\npinfo->desegment_offset = 0;\r\nreturn -1;\r\n} else {\r\nwhois_trans->req_frame = pinfo->num;\r\nwhois_trans->req_time = pinfo->abs_ts;\r\n}\r\n} else {\r\npinfo->desegment_len = DESEGMENT_UNTIL_FIN;\r\npinfo->desegment_offset = 0;\r\nreturn -1;\r\n}\r\n}\r\n} else if (is_query && (whois_trans->req_frame == 0)) {\r\nwhois_trans->req_frame = pinfo->num;\r\nwhois_trans->req_time = pinfo->abs_ts;\r\n}\r\nif (!is_query && (whois_trans->rep_frame == 0)) {\r\nwhois_trans->rep_frame = pinfo->num;\r\n}\r\nti = proto_tree_add_protocol_format(tree, proto_whois, tvb, 0, -1,\r\n"WHOIS: %s", is_query ? "Query" : "Answer");\r\nwhois_tree = proto_item_add_subtree(ti, ett_whois);\r\nif (is_query) {\r\nexpert_ti = proto_tree_add_item(whois_tree, hf_whois_query, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\nif ((len < 2) || (tvb_memeql(tvb, len - 2, "\r\n", 2))) {\r\nexpert_add_info(pinfo, expert_ti, &ei_whois_nocrlf);\r\n}\r\nif (tree && whois_trans->rep_frame) {\r\nti = proto_tree_add_uint(whois_tree, hf_whois_answer_in,\r\ntvb, 0, 0, whois_trans->rep_frame);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n}\r\n} else if (tree && whois_trans->rep_frame) {\r\nproto_tree_add_item(whois_tree, hf_whois_answer, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\nif (whois_trans->req_frame) {\r\nnstime_t ns;\r\nti = proto_tree_add_uint(whois_tree, hf_whois_answer_to,\r\ntvb, 0, 0, whois_trans->req_frame);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nif (pinfo->num == whois_trans->rep_frame) {\r\nnstime_delta(&ns, &pinfo->abs_ts, &whois_trans->req_time);\r\nti = proto_tree_add_time(whois_tree, hf_whois_response_time, tvb, 0, 0, &ns);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_whois(void)\r\n{\r\nexpert_module_t *expert_whois;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_whois_query,\r\n{ "Query", "whois.query", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_whois_answer,\r\n{ "Answer", "whois.answer", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_whois_answer_in,\r\n{ "Answer In", "whois.answer_in", FT_FRAMENUM, BASE_NONE, NULL,\r\n0x0, "The answer to this WHOIS query is in this frame",\r\nHFILL }\r\n},\r\n{ &hf_whois_answer_to,\r\n{ "Query In", "whois.answer_to", FT_FRAMENUM, BASE_NONE, NULL,\r\n0x0, "This is the answer to the WHOIS query in this frame",\r\nHFILL }\r\n},\r\n{ &hf_whois_response_time,\r\n{ "Response Time", "whois.response_time", FT_RELATIVE_TIME,\r\nBASE_NONE, NULL, 0x0,\r\n"The time between the Query and the Answer", HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_whois\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_whois_nocrlf,\r\n{ "whois.nocrlf", PI_MALFORMED, PI_WARN, "Missing <CR><LF>", EXPFILL}\r\n}\r\n};\r\nproto_whois = proto_register_protocol("whois", "WHOIS", "whois");\r\nproto_register_field_array(proto_whois, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_whois = expert_register_protocol(proto_whois);\r\nexpert_register_field_array(expert_whois, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_whois(void)\r\n{\r\nstatic dissector_handle_t whois_handle;\r\nwhois_handle = create_dissector_handle(dissect_whois, proto_whois);\r\ndissector_add_uint("tcp.port", WHOIS_PORT, whois_handle);\r\n}

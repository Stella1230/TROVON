gboolean\r\ndissect_mailslot_smb(tvbuff_t *mshdr_tvb, tvbuff_t *setup_tvb,\r\ntvbuff_t *tvb, const char *mailslot, packet_info *pinfo,\r\nproto_tree *parent_tree, smb_info_t* smb_info)\r\n{\r\nsmb_transact_info_t *tri;\r\nint trans_subcmd;\r\nproto_tree *tree = NULL;\r\nproto_item *item = NULL;\r\nguint16 opcode;\r\nint offset = 0;\r\nint len;\r\nif (!proto_is_protocol_enabled(find_protocol_by_id(proto_smb_msp))) {\r\nreturn FALSE;\r\n}\r\npinfo->current_proto = "SMB Mailslot";\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SMB Mailslot");\r\nif ((tvb==NULL) || (tvb_reported_length(tvb)==0)) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Interim reply");\r\nreturn TRUE;\r\n}\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (smb_info->sip != NULL && smb_info->sip->extra_info_type == SMB_EI_TRI)\r\ntri = (smb_transact_info_t *)smb_info->sip->extra_info;\r\nelse\r\ntri = NULL;\r\ntrans_subcmd=MAILSLOT_UNKNOWN;\r\nif(smb_info->request){\r\nif(strncmp(mailslot,"BROWSE",6) == 0){\r\ntrans_subcmd=MAILSLOT_BROWSE;\r\n} else if(strncmp(mailslot,"LANMAN",6) == 0){\r\ntrans_subcmd=MAILSLOT_LANMAN;\r\n} else if(strncmp(mailslot,"NET",3) == 0){\r\ntrans_subcmd=MAILSLOT_NET;\r\n} else if(strncmp(mailslot,"TEMP\\NETLOGON",13) == 0){\r\ntrans_subcmd=MAILSLOT_TEMP_NETLOGON;\r\n} else if(strncmp(mailslot,"MSSP",4) == 0){\r\ntrans_subcmd=MAILSLOT_MSSP;\r\n}\r\nif (!pinfo->fd->flags.visited) {\r\nif (tri != NULL)\r\ntri->trans_subcmd = trans_subcmd;\r\n}\r\n} else {\r\nif(!tri){\r\nreturn FALSE;\r\n} else {\r\ntrans_subcmd = tri->trans_subcmd;\r\n}\r\n}\r\nif(mshdr_tvb && setup_tvb){\r\nif (parent_tree) {\r\nitem = proto_tree_add_item(parent_tree, proto_smb_msp,\r\nmshdr_tvb, 0, -1, ENC_NA);\r\ntree = proto_item_add_subtree(item, ett_smb_msp);\r\n}\r\nopcode = tvb_get_letohs(setup_tvb, offset);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(opcode, opcode_vals, "Unknown opcode: 0x%04x"));\r\nproto_tree_add_uint(tree, hf_opcode, setup_tvb, offset, 2,\r\nopcode);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_priority, setup_tvb, offset, 2,\r\nENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_class, setup_tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_size, mshdr_tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nlen = tvb_strsize(mshdr_tvb, offset);\r\nproto_tree_add_item(tree, hf_name, mshdr_tvb, offset, len, ENC_ASCII|ENC_NA);\r\noffset += len;\r\nproto_item_set_len(item, offset);\r\n}\r\nswitch(trans_subcmd){\r\ncase MAILSLOT_BROWSE:\r\ncall_dissector(mailslot_browse_handle, tvb, pinfo,\r\nparent_tree);\r\nbreak;\r\ncase MAILSLOT_LANMAN:\r\ncall_dissector(mailslot_lanman_handle, tvb, pinfo,\r\nparent_tree);\r\nbreak;\r\ncase MAILSLOT_NET:\r\ncase MAILSLOT_TEMP_NETLOGON:\r\ncase MAILSLOT_MSSP:\r\ncall_dissector(netlogon_handle, tvb, pinfo,\r\nparent_tree);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(tvb, pinfo, parent_tree);\r\nbreak;\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_smb_mailslot(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_opcode,\r\n{ "Opcode", "mailslot.opcode", FT_UINT16, BASE_DEC,\r\nVALS(opcode_vals), 0, "MAILSLOT OpCode", HFILL }},\r\n{ &hf_priority,\r\n{ "Priority", "mailslot.priority", FT_UINT16, BASE_DEC,\r\nNULL, 0, "MAILSLOT Priority of transaction", HFILL }},\r\n{ &hf_class,\r\n{ "Class", "mailslot.class", FT_UINT16, BASE_DEC,\r\nVALS(class_vals), 0, "MAILSLOT Class of transaction", HFILL }},\r\n{ &hf_size,\r\n{ "Size", "mailslot.size", FT_UINT16, BASE_DEC,\r\nNULL, 0, "MAILSLOT Total size of mail data", HFILL }},\r\n{ &hf_name,\r\n{ "Mailslot Name", "mailslot.name", FT_STRING, BASE_NONE,\r\nNULL, 0, "MAILSLOT Name of mailslot", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_smb_msp\r\n};\r\nproto_smb_msp = proto_register_protocol(\r\n"SMB MailSlot Protocol", "SMB Mailslot", "mailslot");\r\nproto_register_field_array(proto_smb_msp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_smb_mailslot(void)\r\n{\r\nmailslot_browse_handle = find_dissector_add_dependency("mailslot_browse", proto_smb_msp);\r\nmailslot_lanman_handle = find_dissector_add_dependency("mailslot_lanman", proto_smb_msp);\r\nnetlogon_handle = find_dissector_add_dependency("smb_netlogon", proto_smb_msp);\r\n}

static int\r\ndissect_vssmonitoring(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *ti = NULL;\r\nproto_tree *vssmonitoring_tree = NULL;\r\nguint offset = 0;\r\nguint trailer_len;\r\nnstime_t vssmonitoring_time;\r\nguint8 vssmonitoring_clksrc = 0;\r\nguint16 vssmonitoring_srcport = 0;\r\nstruct tm *tmp;\r\ntrailer_len = tvb_reported_length(tvb);\r\nif ( trailer_len > 14 )\r\nreturn 0;\r\nif ( (trailer_len & 3) == 3 )\r\nreturn 0;\r\nif ( (trailer_len & 3) == 0 && trailer_len < 8 )\r\nreturn 0;\r\nif ( trailer_len >= 8 ) {\r\nvssmonitoring_time.secs = tvb_get_ntohl(tvb, offset);\r\nvssmonitoring_time.nsecs = tvb_get_ntohl(tvb, offset + 4);\r\nvssmonitoring_clksrc = (guint8)(((guint32)vssmonitoring_time.nsecs) >> CLKSRC_SHIFT);\r\nvssmonitoring_time.nsecs &= VSS_NS_MASK;\r\nif (vssmonitoring_time.secs == 0)\r\nreturn 0;\r\nif (vssmonitoring_time.secs > 3600) {\r\nif ( vssmonitoring_time.secs > pinfo->abs_ts.secs ) {\r\nif ( vssmonitoring_time.secs - pinfo->abs_ts.secs > 2592000 )\r\nreturn 0;\r\n} else {\r\nif ( pinfo->abs_ts.secs - vssmonitoring_time.secs > 2592000 )\r\nreturn 0;\r\n}\r\n}\r\nif ( vssmonitoring_time.nsecs >= 1000000000 )\r\nreturn 0;\r\n}\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_vssmonitoring,\r\ntvb, 0, (trailer_len & 0xb), ENC_NA);\r\nvssmonitoring_tree = proto_item_add_subtree(ti, ett_vssmonitoring);\r\n}\r\nif ( trailer_len >= 8 ) {\r\nif (tree) {\r\nproto_tree_add_time(vssmonitoring_tree, hf_vssmonitoring_time, tvb, offset, 8, &vssmonitoring_time);\r\nproto_tree_add_uint(vssmonitoring_tree, hf_vssmonitoring_clksrc, tvb, offset + 4, 1, vssmonitoring_clksrc);\r\ntmp = localtime(&vssmonitoring_time.secs);\r\nif (tmp)\r\nproto_item_append_text(ti, ", Timestamp: %02d:%02d:%02d.%09ld",\r\ntmp->tm_hour, tmp->tm_min, tmp->tm_sec,(long)vssmonitoring_time.nsecs);\r\nelse\r\nproto_item_append_text(ti, ", Timestamp: <Not representable>");\r\n}\r\noffset += 8;\r\n}\r\nif ( trailer_len & 3) {\r\nif ( trailer_len & 1) {\r\nvssmonitoring_srcport = (guint16)tvb_get_guint8(tvb, offset);\r\nif (tree)\r\nproto_tree_add_item(vssmonitoring_tree, hf_vssmonitoring_srcport, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\n} else if ( trailer_len & 2) {\r\nvssmonitoring_srcport = tvb_get_ntohs(tvb, offset);\r\nif (tree)\r\nproto_tree_add_item(vssmonitoring_tree, hf_vssmonitoring_srcport, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nif (tree)\r\nproto_item_append_text(ti, ", Source Port: %d", vssmonitoring_srcport);\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_vssmonitoring(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_vssmonitoring_time, {\r\n"Time Stamp", "vssmonitoring.time",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\n"VSS-Monitoring Time Stamp", HFILL }},\r\n{ &hf_vssmonitoring_clksrc, {\r\n"Clock Source", "vssmonitoring.clksrc",\r\nFT_UINT8, BASE_DEC, VALS(clksrc_vals), 0x0,\r\n"VSS-Monitoring Clock Source", HFILL }},\r\n{ &hf_vssmonitoring_srcport, {\r\n"Src Port", "vssmonitoring.srcport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"VSS-Monitoring Source Port", HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_vssmonitoring\r\n};\r\nmodule_t *vssmonitoring_module;\r\nproto_vssmonitoring = proto_register_protocol("VSS-Monitoring ethernet trailer", "VSS-Monitoring", "vssmonitoring");\r\nproto_register_field_array(proto_vssmonitoring, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nvssmonitoring_module = prefs_register_protocol(proto_vssmonitoring, NULL);\r\nprefs_register_obsolete_preference(vssmonitoring_module, "use_heuristics");\r\n}\r\nvoid\r\nproto_reg_handoff_vssmonitoring(void)\r\n{\r\nheur_dissector_add("eth.trailer", dissect_vssmonitoring, "VSS-Monitoring ethernet trailer", "vssmonitoring_eth", proto_vssmonitoring, HEURISTIC_ENABLE);\r\n}

static int dissect_aim_tlv_value_icq(proto_item *ti, guint16 subtype _U_, tvbuff_t *tvb, packet_info *pinfo)\r\n{\r\nint offset = 0;\r\nint i;\r\nproto_item *subtype_item;\r\nguint16 req_type, req_subtype;\r\nproto_tree *t = proto_item_add_subtree(ti, ett_aim_icq_tlv);\r\nproto_tree_add_item(t, hf_icq_tlv_data_chunk_size, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(t, hf_icq_tlv_request_owner_uid, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(t, hf_icq_tlv_request_type, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nreq_type = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\nproto_tree_add_item(t, hf_icq_tlv_request_seq_num, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nswitch (req_type) {\r\ncase ICQ_CLI_OFFLINE_MESSAGE_REQ: return offset;\r\ncase ICQ_CLI_DELETE_OFFLINE_MSGS: return offset;\r\ncase ICQ_SRV_OFFLINE_MSGS:\r\nbreak;\r\ncase ICQ_SRV_END_OF_OFFLINE_MSGS:\r\nproto_tree_add_item(t, hf_icq_dropped_msg_flag, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nreturn offset+1;\r\ncase ICQ_CLI_META_INFO_REQ:\r\ncase ICQ_SRV_META_INFO_REPL:\r\nreq_subtype = tvb_get_letohs(tvb, offset);\r\nsubtype_item = proto_tree_add_item(t, hf_icq_meta_subtype, tvb, offset, 2, ENC_LITTLE_ENDIAN); offset+=2;\r\nfor (i = 0; icq_calls[i].name; i++) {\r\nif (icq_calls[i].subtype == req_subtype) break;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_INFO, icq_calls[i].name?icq_calls[i].name:"Unknown ICQ Meta Call");\r\nproto_item_append_text(subtype_item, " (%s)", icq_calls[i].name?icq_calls[i].name:"Unknown");\r\nif (icq_calls[i].dissector)\r\nreturn icq_calls[i].dissector(tvb_new_subset_remaining(tvb, offset), pinfo, t);\r\ndefault:\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int dissect_aim_icq_tlv(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nreturn dissect_aim_tlv(tvb, pinfo, 0, tree, icq_tlv);\r\n}\r\nvoid\r\nproto_register_aim_icq(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_icq_tlv_data_chunk_size,\r\n{ "Data chunk size", "aim_icq.chunk_size", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_icq_tlv_request_owner_uid,\r\n{ "Owner UID", "aim_icq.owner_uid", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL},\r\n},\r\n{ &hf_icq_tlv_request_type,\r\n{"Request Type", "aim_icq.request_type", FT_UINT16, BASE_DEC, VALS(aim_icq_data_types), 0x0, NULL, HFILL},\r\n},\r\n{ &hf_icq_tlv_request_seq_num,\r\n{"Request Sequence Number", "aim_icq.request_seq_number", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL},\r\n},\r\n{ &hf_icq_dropped_msg_flag,\r\n{"Dropped messages flag", "aim_icq.offline_msgs.dropped_flag", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL },\r\n},\r\n{ &hf_icq_meta_subtype,\r\n{"Meta Request Subtype", "aim_icq.subtype", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL },\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_aim_icq,\r\n&ett_aim_icq_tlv\r\n};\r\nproto_aim_icq = proto_register_protocol("AIM ICQ", "AIM ICQ", "aim_icq");\r\nproto_register_field_array(proto_aim_icq, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_aim_icq(void)\r\n{\r\naim_init_family(proto_aim_icq, ett_aim_icq, FAMILY_ICQ, aim_fnac_family_icq);\r\n}

int main(int argc, char **argv) {\r\nuint16_t table[0x100];\r\niconv_t conv;\r\nconst char *charset;\r\nint i, j;\r\nint ascii_based = 1;\r\nint iso_based = 1;\r\nif (argc != 2) {\r\nprintf("usage: %s <charset>\n", argv[0]);\r\nreturn 1;\r\n}\r\ncharset = argv[1];\r\nconv = iconv_open("UCS-2", charset);\r\nif (conv == (iconv_t) -1) {\r\nperror("iconv_open");\r\nreturn 2;\r\n}\r\niconv_close(conv);\r\nfor (i = 0x00; i < 0x100; i++) {\r\nunsigned char in[1], out[2];\r\nsize_t inlen = 1, outlen = 2;\r\nchar *inbuf = (char *) in;\r\nchar *outbuf = (char *) out;\r\nsize_t ret;\r\nin[0] = i;\r\nconv = iconv_open("UCS-2BE", charset);\r\nif (conv == (iconv_t) -1) {\r\nperror("iconv_open");\r\nreturn 2;\r\n}\r\nret = iconv(conv, &inbuf, &inlen, &outbuf, &outlen);\r\nif (ret == (size_t) -1 && errno == EILSEQ) {\r\ntable[i] = UNREPL;\r\niconv_close(conv);\r\ncontinue;\r\n}\r\nif (ret == (size_t) -1) {\r\nperror("iconv");\r\niconv_close(conv);\r\nreturn 4;\r\n}\r\niconv_close(conv);\r\nif (ret != 0 || inlen != 0 || outlen != 0) {\r\nfprintf(stderr, "%d: smth went wrong: %zu %zu %zu\n", i, ret, inlen, outlen);\r\nreturn 3;\r\n}\r\nif (i < 0x80 && (out[0] != 0 || out[1] != i))\r\nascii_based = 0;\r\nif (i < 0xA0 && (out[0] != 0 || out[1] != i))\r\niso_based = 0;\r\ntable[i] = (out[0] << 8) | out[1];\r\n}\r\niso_based = 0;\r\nprintf("/* generated by %s %s */\n", argv[0], charset);\r\nif (iso_based)\r\ni = 0xA0;\r\nelse if (ascii_based)\r\ni = 0x80;\r\nelse\r\ni = 0;\r\nprintf("const gunichar2 charset_table_%s[0x%x] = {\n", charset, 0x100 - i);\r\nwhile (i < 0x100) {\r\nint start = i;\r\nprintf(" ");\r\nfor (j = 0; j < 8; j++, i++) {\r\nif (table[i] == UNREPL)\r\nprintf("UNREPL, ");\r\nelse\r\nprintf("0x%.4x, ", table[i]);\r\n}\r\nif ((start & 0xf) == 0)\r\nprintf(" /* 0x%.2X - */", start);\r\nelse\r\nprintf(" /* - 0x%.2X */", i - 1);\r\nprintf("\n");\r\n}\r\nprintf("};\n");\r\nreturn 0;\r\n}

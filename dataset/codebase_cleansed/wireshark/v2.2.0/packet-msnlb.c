static void\r\nversion_base_custom(gchar *result, guint32 version)\r\n{\r\ng_snprintf(result, ITEM_LABEL_LENGTH, "%d.%d", (version >> 8) & 0xFF, (version & 0xFF));\r\n}\r\nstatic int\r\ndissect_msnlb(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *msnlb_tree = NULL, *msnlb_subtree;\r\nguint16 offset = 0;\r\nguint32 signature;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MS NLB");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "MS NLB heartbeat");\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_msnlb, tvb, 0, -1, ENC_NA);\r\nmsnlb_tree = proto_item_add_subtree(ti, ett_msnlb);\r\n}\r\nproto_tree_add_item(msnlb_tree, hf_msnlb_signature, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nsignature = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nproto_tree_add_item(msnlb_tree, hf_msnlb_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(msnlb_tree, hf_msnlb_uniquehostid, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(msnlb_tree, hf_msnlb_clusterip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(msnlb_tree, hf_msnlb_dedicatedip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nti = proto_tree_add_item(msnlb_tree, hf_msnlb_signature_data, tvb, offset, -1, ENC_NA);\r\nproto_item_append_text(ti, " - %s", val_to_str(signature, nlb_signature_vals, "Unknown (%u)"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - %s", val_to_str(signature, nlb_signature_vals, "Unknown (%u)"));\r\nmsnlb_subtree = proto_item_add_subtree(ti, ett_msnlb_signature);\r\nswitch(signature){\r\ncase NLB_CLUSTER_MEMBERSHIP_HB:{\r\nguint32 i;\r\nproto_tree *teamingcfg_tree, *subtree;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_myhostid, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_defaulthostid, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_convergencestate, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_numberofportrules, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_uniquehostcode, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_packetshandled, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_teamingcfg, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nteamingcfg_tree = proto_item_add_subtree(ti, ett_msnlb_teamingcfg);\r\nproto_tree_add_item(teamingcfg_tree, hf_msnlb_teamingcfg_reserved, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(teamingcfg_tree, hf_msnlb_teamingcfg_xorclusterip, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(teamingcfg_tree, hf_msnlb_teamingcfg_numberofparticipants, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(teamingcfg_tree, hf_msnlb_teamingcfg_hashing, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(teamingcfg_tree, hf_msnlb_teamingcfg_master, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(teamingcfg_tree, hf_msnlb_teamingcfg_active, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(msnlb_subtree, hf_msnlb_reserved, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_portruleconfiguration, tvb, offset, 4*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_portruleconfiguration);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_portruleconfiguration_data, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_currentmap, tvb, offset, 8*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_currentmap);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_currentmap_data, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_newmap, tvb, offset, 8*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_newmap);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_newmap_data, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_idlemap, tvb, offset, 8*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_idlemap);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_idlemap_data, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_readymap, tvb, offset, 8*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_readymap);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_readymap_data, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\n}\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_loadweights, tvb, offset, 4*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_loadweights);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_loadweights_data, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_reserved2, tvb, offset, 4*33, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_msnlb_reserved);\r\nfor(i = 1; i <= 33; i++){\r\nproto_tree_add_item(subtree, hf_msnlb_reserved2_data, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\n}\r\nbreak;\r\ncase NLB_EXTENDED_HB:{\r\nguint8 hb_type;\r\nproto_tree *hb_tree;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nti = proto_tree_add_item(msnlb_subtree, hf_msnlb_extended_hb, tvb, offset, -1, ENC_NA);\r\nhb_tree = proto_item_add_subtree(ti, ett_msnlb_extended_hb);\r\nproto_tree_add_item(hb_tree, hf_msnlb_extended_hb_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nhb_type = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(ti, " - %s", val_to_str(hb_type, nlb_extended_hb_type_vals, "Unknown (%u)"));\r\noffset += 1;\r\nswitch(hb_type){\r\ncase 1:{\r\nchar *fqdn = NULL;\r\nproto_tree_add_item(hb_tree, hf_msnlb_length, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(hb_tree, hf_msnlb_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(hb_tree, hf_msnlb_reserved, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\noffset = display_unicode_string(tvb, hb_tree, offset, hf_msnlb_host_name, &fqdn);\r\noffset += 6;\r\nproto_item_append_text(ti, ": %s", fqdn);\r\n}\r\nbreak;\r\ncase 2:{\r\nguint16 address_family;\r\nproto_tree_add_item(hb_tree, hf_msnlb_length, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(hb_tree, hf_msnlb_reserved, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(hb_tree, hf_msnlb_reserved, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\nproto_tree_add_item(hb_tree, hf_msnlb_address_family, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\naddress_family = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\nswitch(address_family){\r\ncase 0x2:\r\nproto_tree_add_item(hb_tree, hf_msnlb_host_ipv4, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ": %s", tvb_ip_to_str(tvb, offset));\r\noffset += 4;\r\nbreak;\r\ncase 0x17:\r\nproto_tree_add_item(hb_tree, hf_msnlb_host_ipv6, tvb, offset, 16, ENC_NA);\r\nproto_item_append_text(ti, ": %s", tvb_ip6_to_str(tvb, offset));\r\noffset += 16;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(hb_tree, hf_msnlb_host_unknown, tvb, offset, -1, ENC_NA);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\nbreak;\r\n}\r\nproto_tree_add_item(hb_tree, hf_msnlb_padding, tvb, offset, -1, ENC_NA);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(hb_tree, hf_msnlb_extended_hb_unknown, tvb, offset, -1, ENC_NA);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\nbreak;\r\n}\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_msnlb(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_msnlb_signature,\r\n{ "Signature", "msnlb.signature",\r\nFT_UINT32, BASE_HEX,\r\nVALS(nlb_signature_vals), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_version,\r\n{ "Version", "msnlb.version",\r\nFT_UINT32, BASE_CUSTOM,\r\nCF_FUNC(version_base_custom), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_uniquehostid,\r\n{ "Unique Host ID", "msnlb.unique_host_id",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_clusterip,\r\n{ "Cluster IP", "msnlb.cluster_ip",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_dedicatedip,\r\n{ "Host IP", "msnlb.host_ip",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_signature_data,\r\n{ "Signature Data", "msnlb.signature_data",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_myhostid,\r\n{ "My Host id", "msnlb.my_host_ip",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_defaulthostid,\r\n{ "Default Host id", "msnlb.default_host_ip",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_convergencestate,\r\n{ "Convergence State", "msnlb.convergence_state",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_numberofportrules,\r\n{ "Number of Port Rules", "msnlb.number_of_port_rules",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_uniquehostcode,\r\n{ "Unique Host Code", "msnlb.unique_host_code",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_packetshandled,\r\n{ "Packets Handled", "msnlb.packets_handled",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg,\r\n{ "Teaming Configuration", "msnlb.teamincfg",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg_reserved,\r\n{ "Reserved", "msnlb.teamincfg.reserved",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0xFF000000,\r\n"Must be zero", HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg_xorclusterip,\r\n{ "XOR of the least significant 16 bits of each participant's cluster IP address", "msnlb.teamingcfg.xorclusterip",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x00FFFF00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg_numberofparticipants,\r\n{ "Number of Participants", "msnlb.teamingcfg.number_of_participants",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x000000F8,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg_hashing,\r\n{ "Hashing", "msnlb.teamingcfg.hashing",\r\nFT_BOOLEAN, 32,\r\nTFS(&tfs_reverse_normal), 0x00000004,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg_master,\r\n{ "Master", "msnlb.teamingcfg.master",\r\nFT_BOOLEAN, 32,\r\nNULL, 0x00000002,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_teamingcfg_active,\r\n{ "Active", "msnlb.teamingcfg.active",\r\nFT_BOOLEAN, 32,\r\nNULL, 0x00000001,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_reserved,\r\n{ "Reserved", "msnlb.reserved",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_portruleconfiguration,\r\n{ "Port Rule Configuration", "msnlb.portruleconfiguration",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_portruleconfiguration_data,\r\n{ "Port Rule Configuration Data", "msnlb.portruleconfiguration.data",\r\nFT_UINT32, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_currentmap,\r\n{ "Current Map", "msnlb.currentmap",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_currentmap_data,\r\n{ "Current Map Data", "msnlb.currentmap.data",\r\nFT_UINT64, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_newmap,\r\n{ "New Map", "msnlb.newmap",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_newmap_data,\r\n{ "New Map Data", "msnlb.newmap.data",\r\nFT_UINT64, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_idlemap,\r\n{ "Idle Map", "msnlb.idlemap",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_idlemap_data,\r\n{ "Idle Map Data", "msnlb.idlemap.data",\r\nFT_UINT64, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_readymap,\r\n{ "Ready Map", "msnlb.readymap",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_readymap_data,\r\n{ "Ready Map Data", "msnlb.readymap.data",\r\nFT_UINT64, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_loadweights,\r\n{ "Load Weights", "msnlb.loadweights",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_loadweights_data,\r\n{ "Load Weights Data", "msnlb.loadweights.data",\r\nFT_UINT32, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_reserved2,\r\n{ "Reserved", "msnlb.reserved2",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_reserved2_data,\r\n{ "Reserved Data", "msnlb.reserved2.data",\r\nFT_UINT32, BASE_DEC_HEX,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_extended_hb,\r\n{ "Extended HB", "msnlb.extended_hb",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_extended_hb_type,\r\n{ "Type", "msnlb.extended_hb.type",\r\nFT_UINT8, BASE_DEC,\r\nVALS(nlb_extended_hb_type_vals), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_length,\r\n{ "Length", "msnlb.length",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_address_family,\r\n{ "Address Family", "msnlb.address_family",\r\nFT_UINT8, BASE_HEX_DEC,\r\nVALS(nlb_address_family_vals), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_host_name,\r\n{ "Host name", "msnlb.host_name",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_host_ipv4,\r\n{ "Host IPv4", "msnlb.host_ipv4",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_host_ipv6,\r\n{ "Host IPv6", "msnlb.host_ipv6",\r\nFT_IPv6, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_host_unknown,\r\n{ "Host Unknown", "msnlb.host_unknown",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_padding,\r\n{ "Padding", "msnlb.padding",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_msnlb_extended_hb_unknown,\r\n{ "Unknown HB Data", "msnlb.extended_hb.unknown",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_msnlb,\r\n&ett_msnlb_signature,\r\n&ett_msnlb_teamingcfg,\r\n&ett_msnlb_portruleconfiguration,\r\n&ett_msnlb_currentmap,\r\n&ett_msnlb_newmap,\r\n&ett_msnlb_idlemap,\r\n&ett_msnlb_readymap,\r\n&ett_msnlb_loadweights,\r\n&ett_msnlb_reserved,\r\n&ett_msnlb_extended_hb\r\n};\r\nproto_msnlb = proto_register_protocol("MS Network Load Balancing", "MS NLB", "msnlb");\r\nproto_register_field_array(proto_msnlb, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_msnlb(void)\r\n{\r\ndissector_handle_t msnlb_handle;\r\nmsnlb_handle = create_dissector_handle(dissect_msnlb, proto_msnlb);\r\ndissector_add_uint("ethertype", ETHERTYPE_MS_NLB_HEARTBEAT, msnlb_handle);\r\n}

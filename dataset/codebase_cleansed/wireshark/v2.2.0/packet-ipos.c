static int\r\ndissect_ipos(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *ipos_tree = NULL;\r\ntvbuff_t *next_tvb;\r\nint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "IPOS");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_ipos, tvb, 0, -1, ENC_NA);\r\nipos_tree = proto_item_add_subtree(ti, ett_ipos);\r\nproto_tree_add_item(ipos_tree, hf_ipos_protocol, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ipos_tree, hf_ipos_priority, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(ipos_tree, hf_ipos_ppe, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(ipos_tree, hf_ipos_slot, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nif (redback_handle) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_dissector(redback_handle, next_tvb, pinfo, tree);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_ipos(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ipos_protocol,\r\n{ "Protocol", "ipos.proto", FT_UINT8, BASE_DEC, VALS(prototypenames), 0xF0,\r\nNULL, HFILL }},\r\n{ &hf_ipos_priority,\r\n{ "Priority", "ipos.priority", FT_UINT8, BASE_DEC, NULL, 0x0F,\r\nNULL, HFILL }},\r\n{ &hf_ipos_ppe,\r\n{ "Packet Processing Engine", "ipos.ppe", FT_UINT8, BASE_HEX, VALS(ppetypenames), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_ipos_slot,\r\n{ "Destination (source) Slot", "ipos.slot", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ipos\r\n};\r\n#if 0\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ipos_protocol,\r\n{ "ipos.protocol.unknown", PI_PROTOCOL, PI_WARN,\r\n"Unknown Protocol Data", EXPFILL }}\r\n};\r\nexpert_module_t* expert_ipos;\r\n#endif\r\nproto_ipos = proto_register_protocol("IPOS Kernel Packet Protocol", "IPOS", "ipos");\r\nproto_register_field_array(proto_ipos, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n#if 0\r\nexpert_ipos = expert_register_protocol(proto_ipos);\r\nexpert_register_field_array(expert_ipos, ei, array_length(ei));\r\n#endif\r\nregister_dissector("ipos", dissect_ipos, proto_ipos);\r\n}\r\nvoid\r\nproto_reg_handoff_ipos(void)\r\n{\r\nipos_handle = find_dissector("ipos");\r\nredback_handle = find_dissector_add_dependency("redback", proto_ipos);\r\ndissector_add_uint("sll.ltype", LINUX_SLL_P_IPOS_NETIPC, ipos_handle);\r\ndissector_add_uint("sll.ltype", LINUX_SLL_P_IPOS_RBN, ipos_handle);\r\ndissector_add_uint("sll.ltype", LINUX_SLL_P_IPOS_NETLINK, ipos_handle);\r\ndissector_add_uint("sll.ltype", LINUX_SLL_P_IPOS_XCRP, ipos_handle);\r\ndissector_add_uint("sll.ltype", LINUX_SLL_P_IPOS_ISIS, ipos_handle);\r\ndissector_add_uint("sll.ltype", LINUX_SLL_P_IPOS_PAKIO, ipos_handle);\r\n}

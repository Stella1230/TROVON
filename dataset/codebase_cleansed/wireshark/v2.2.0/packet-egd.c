static int dissect_egd(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "EGD");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Data Msg: ExchangeID=0x%08X, RequestID=%05u",\r\ntvb_get_letohl(tvb, 8), tvb_get_letohs(tvb, 2));\r\nif (tree)\r\n{\r\nproto_item *ti = NULL;\r\nproto_item *notime = NULL;\r\nproto_tree *egd_tree = NULL;\r\ntvbuff_t *next_tvb = NULL;\r\ngint offset, data_length;\r\nguint32 sectime;\r\nnstime_t egd_time;\r\nmemset(&egd_time, 0, sizeof(nstime_t));\r\noffset = 0;\r\nti = proto_tree_add_item(tree, proto_egd, tvb, 0, -1, ENC_NA);\r\negd_tree = proto_item_add_subtree(ti, ett_egd);\r\nproto_tree_add_item(egd_tree, hf_egd_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(egd_tree, hf_egd_ver, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(egd_tree, hf_egd_rid, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(egd_tree, hf_egd_pid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(egd_tree, hf_egd_exid, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nsectime = tvb_get_letohl(tvb, offset);\r\nif (0 == sectime)\r\n{\r\nnotime = proto_tree_add_item(egd_tree, hf_egd_notime, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nproto_item_append_text(notime, "--No TimeStamp");\r\n}\r\nelse\r\n{\r\negd_time.secs = tvb_get_letohl(tvb, offset);\r\negd_time.nsecs = tvb_get_letohl(tvb, offset+4);\r\nproto_tree_add_time(egd_tree, hf_egd_time, tvb, offset, 8, &egd_time);\r\n}\r\noffset += 8;\r\nproto_tree_add_item(egd_tree, hf_egd_stat, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(egd_tree, hf_egd_csig, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(egd_tree, hf_egd_resv, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\ndata_length = tvb_reported_length_remaining(tvb, offset);\r\nif (data_length > 0)\r\n{\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_data_dissector(next_tvb, pinfo, egd_tree);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_egd(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_egd_ver,\r\n{ "Version", "egd.ver",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_type,\r\n{ "Type", "egd.type",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_rid,\r\n{ "RequestID", "egd.rid",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_pid,\r\n{ "ProducerID", "egd.pid",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_exid,\r\n{ "ExchangeID", "egd.exid",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_time,\r\n{ "Timestamp", "egd.time",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_notime,\r\n{ "Timestamp", "egd.notime",\r\nFT_UINT64, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_stat,\r\n{ "Status", "egd.stat",\r\nFT_UINT32, BASE_DEC,\r\nVALS(egd_stat_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_csig,\r\n{ "ConfigSignature", "egd.csig",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_egd_resv,\r\n{ "Reserved", "egd.rsrv",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_egd,\r\n&ett_status_item\r\n};\r\nproto_egd = proto_register_protocol (\r\n"Ethernet Global Data",\r\n"EGD",\r\n"egd"\r\n);\r\nproto_register_field_array(proto_egd, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_egd(void)\r\n{\r\ndissector_handle_t egd_handle;\r\negd_handle = create_dissector_handle(dissect_egd, proto_egd);\r\ndissector_add_uint("udp.port", EGD_PORT, egd_handle);\r\n}

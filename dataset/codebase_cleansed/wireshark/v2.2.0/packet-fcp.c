static void\r\ndissect_task_mgmt_flags(packet_info *pinfo, proto_tree *parent_tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_item *item;\r\nstatic const int * mgmt_flags[] = {\r\n&hf_fcp_mgmt_flags_obsolete,\r\n&hf_fcp_mgmt_flags_clear_aca,\r\n&hf_fcp_mgmt_flags_target_reset,\r\n&hf_fcp_mgmt_flags_lu_reset,\r\n&hf_fcp_mgmt_flags_rsvd,\r\n&hf_fcp_mgmt_flags_clear_task_set,\r\n&hf_fcp_mgmt_flags_abort_task_set,\r\nNULL\r\n};\r\nguint8 flags;\r\nflags = tvb_get_guint8(tvb, offset);\r\nitem = proto_tree_add_bitmask_with_flags(parent_tree, tvb, offset, hf_fcp_taskmgmt,\r\nett_fcp_taskmgmt, mgmt_flags, ENC_NA, BMT_NO_FALSE|BMT_NO_TFS);\r\nif (!flags)\r\nproto_item_append_text(item, " (No values set)");\r\nif (flags & 0x80) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP OBSOLETE] ");\r\n}\r\nif (flags & 0x40) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP CLEAR_ACA] ");\r\n}\r\nif (flags & 0x20) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP TARGET_RESET] ");\r\n}\r\nif (flags & 0x10) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP LU_RESET] ");\r\n}\r\nif (flags & 0x08) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP RSVD] ");\r\n}\r\nif (flags & 0x04) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP CLEAR_TASK_SET] ");\r\n}\r\nif (flags & 0x02) {\r\ncol_prepend_fence_fstr(pinfo->cinfo, COL_INFO, "[FCP ABORT_TASK_SET] ");\r\n}\r\n}\r\nstatic void\r\ndissect_rsp_flags(proto_tree *parent_tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_item *item;\r\nguint8 flags;\r\nstatic const int * resid_present_flags[] = {\r\n&hf_fcp_rsp_flags_bidi,\r\n&hf_fcp_rsp_flags_bidi_rru,\r\n&hf_fcp_rsp_flags_bidi_rro,\r\n&hf_fcp_rsp_flags_conf_req,\r\n&hf_fcp_rsp_flags_resid_under,\r\n&hf_fcp_rsp_flags_resid_over,\r\n&hf_fcp_rsp_flags_sns_vld,\r\n&hf_fcp_rsp_flags_res_vld,\r\nNULL\r\n};\r\nstatic const int * no_resid_flags[] = {\r\n&hf_fcp_rsp_flags_bidi,\r\n&hf_fcp_rsp_flags_conf_req,\r\n&hf_fcp_rsp_flags_resid_under,\r\n&hf_fcp_rsp_flags_resid_over,\r\n&hf_fcp_rsp_flags_sns_vld,\r\n&hf_fcp_rsp_flags_res_vld,\r\nNULL\r\n};\r\nflags = tvb_get_guint8(tvb, offset);\r\nif (flags & 0x80) {\r\nitem = proto_tree_add_bitmask_with_flags(parent_tree, tvb, offset, hf_fcp_rspflags,\r\nett_fcp_rsp_flags, resid_present_flags, ENC_NA, BMT_NO_FALSE|BMT_NO_TFS);\r\n} else {\r\nitem = proto_tree_add_bitmask_with_flags(parent_tree, tvb, offset, hf_fcp_rspflags,\r\nett_fcp_rsp_flags, no_resid_flags, ENC_NA, BMT_NO_FALSE|BMT_NO_TFS);\r\n}\r\nif (!flags)\r\nproto_item_append_text(item, " (No values set)");\r\n}\r\nstatic void\r\ndissect_fcp_cmnd(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, proto_tree *tree, conversation_t *conversation, fc_hdr *fchdr, fcp_conv_data_t *fcp_conv_data)\r\n{\r\nint offset = 0;\r\nint add_len = 0;\r\nguint8 flags, rwflags, lun0;\r\nguint16 lun = 0xffff;\r\ntvbuff_t *cdb_tvb;\r\nint tvb_len;\r\nfcp_request_data_t *request_data = NULL;\r\nitl_nexus_t itl;\r\nfcp_proto_data_t *proto_data;\r\nflags = tvb_get_guint8(tvb, offset+10);\r\nif (flags) {\r\nadd_len = tvb_get_guint8(tvb, offset+11) & 0x7C;\r\nadd_len = add_len >> 2;\r\n}\r\nlun0 = tvb_get_guint8(tvb, offset);\r\nif (lun0) {\r\nproto_tree_add_item(tree, hf_fcp_multilun, tvb, offset, 8, ENC_NA);\r\nlun = tvb_get_guint8(tvb, offset) & 0x3f;\r\nlun <<= 8;\r\nlun |= tvb_get_guint8(tvb, offset+1);\r\n} else {\r\nproto_tree_add_item(tree, hf_fcp_singlelun, tvb, offset+1,\r\n1, ENC_BIG_ENDIAN);\r\nlun = tvb_get_guint8(tvb, offset+1);\r\n}\r\nif (!pinfo->fd->flags.visited) {\r\nproto_data = wmem_new(wmem_file_scope(), fcp_proto_data_t);\r\nproto_data->lun = lun;\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_fcp, 0, proto_data);\r\n}\r\nrequest_data = (fcp_request_data_t*)wmem_map_lookup(fcp_conv_data->luns, GUINT_TO_POINTER((guint)lun));\r\nif (!request_data) {\r\nrequest_data = wmem_new(wmem_file_scope(), fcp_request_data_t);\r\nrequest_data->request_frame = pinfo->num;\r\nrequest_data->response_frame = 0;\r\nrequest_data->request_time = pinfo->abs_ts;\r\nrequest_data->itlq = wmem_new(wmem_file_scope(), itlq_nexus_t);\r\nrequest_data->itlq->first_exchange_frame=0;\r\nrequest_data->itlq->last_exchange_frame=0;\r\nrequest_data->itlq->lun=lun;\r\nrequest_data->itlq->scsi_opcode=0xffff;\r\nrequest_data->itlq->task_flags=0;\r\nrequest_data->itlq->data_length=0;\r\nrequest_data->itlq->bidir_data_length=0;\r\nrequest_data->itlq->fc_time=pinfo->abs_ts;\r\nrequest_data->itlq->flags=0;\r\nrequest_data->itlq->alloc_len=0;\r\nrequest_data->itlq->extra_data=NULL;\r\nwmem_map_insert(fcp_conv_data->luns, GUINT_TO_POINTER((guint)lun), request_data);\r\n}\r\nif(!pinfo->fd->flags.visited){\r\nif(fchdr->fctl&FC_FCTL_EXCHANGE_FIRST){\r\nrequest_data->itlq->first_exchange_frame=pinfo->num;\r\nrequest_data->itlq->fc_time = pinfo->abs_ts;\r\n}\r\nif(fchdr->fctl&FC_FCTL_EXCHANGE_LAST){\r\nrequest_data->itlq->last_exchange_frame=pinfo->num;\r\n}\r\n}\r\nif (request_data->itlq)\r\nrequest_data->itlq->lun = lun;\r\nfchdr->lun = lun;\r\nproto_tree_add_item(tree, hf_fcp_crn, tvb, offset+8, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fcp_taskattr, tvb, offset+9, 1, ENC_BIG_ENDIAN);\r\ndissect_task_mgmt_flags(pinfo, tree, tvb, offset+10);\r\nproto_tree_add_item(tree, hf_fcp_addlcdblen, tvb, offset+11, 1, ENC_BIG_ENDIAN);\r\nrwflags = tvb_get_guint8(tvb, offset+11);\r\nif (request_data->itlq) {\r\nif (rwflags & 0x02) {\r\nrequest_data->itlq->task_flags |= SCSI_DATA_READ;\r\n}\r\nif (rwflags & 0x01) {\r\nrequest_data->itlq->task_flags |= SCSI_DATA_WRITE;\r\n}\r\n}\r\nproto_tree_add_item(tree, hf_fcp_rddata, tvb, offset+11, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fcp_wrdata, tvb, offset+11, 1, ENC_BIG_ENDIAN);\r\ntvb_len = tvb_captured_length_remaining(tvb, offset+12);\r\nif (tvb_len > (16 + add_len))\r\ntvb_len = 16 + add_len;\r\nitl.cmdset = 0xff;\r\nitl.conversation = conversation;\r\ncdb_tvb = tvb_new_subset_length(tvb, offset+12, tvb_len);\r\ndissect_scsi_cdb(cdb_tvb, pinfo, parent_tree, SCSI_DEV_UNKNOWN, request_data->itlq, &itl);\r\nproto_tree_add_item(tree, hf_fcp_dl, tvb, offset+12+16+add_len,\r\n4, ENC_BIG_ENDIAN);\r\nif (request_data->itlq) {\r\nrequest_data->itlq->data_length = tvb_get_ntohl(tvb, offset+12+16+add_len);\r\n}\r\nif ( ((rwflags & 0x03) == 0x03)\r\n&& tvb_reported_length_remaining(tvb, offset+12+16+add_len+4) >= 4) {\r\nproto_tree_add_item(tree, hf_fcp_bidir_dl, tvb, offset+12+16+add_len+4,\r\n4, ENC_BIG_ENDIAN);\r\nif (request_data->itlq) {\r\nrequest_data->itlq->bidir_data_length = tvb_get_ntohl(tvb, offset+12+16+add_len+4);\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_fcp_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, conversation_t *conversation, itlq_nexus_t *itlq, guint32 relative_offset)\r\n{\r\nitl_nexus_t itl;\r\nitlq_nexus_t empty_itlq;\r\nitl.cmdset = 0xff;\r\nitl.conversation = conversation;\r\nif (itlq == NULL)\r\n{\r\nmemset(&empty_itlq, 0, sizeof(empty_itlq));\r\nempty_itlq.lun=0xffff;\r\nempty_itlq.scsi_opcode=0xffff;\r\nitlq = &empty_itlq;\r\n}\r\ndissect_scsi_payload(tvb, pinfo, parent_tree, FALSE, itlq, &itl, relative_offset);\r\n}\r\nstatic int\r\ndissect_fcp_rspinfo(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\noffset += 3;\r\nproto_tree_add_item(tree, hf_fcp_rspcode, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_fcp_rsp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, proto_tree *tree, conversation_t *conversation, fc_hdr *fchdr, fcp_request_data_t *request_data)\r\n{\r\nguint32 offset = 0;\r\ngint32 snslen = 0;\r\ngint32 rsplen = 0;\r\nguint8 flags;\r\nguint8 status;\r\nitl_nexus_t itl;\r\nitlq_nexus_t empty_itlq;\r\nstatus = tvb_get_guint8(tvb, offset+11);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ":%s",\r\nval_to_str(status, scsi_status_val, "0x%x"));\r\nif (request_data != NULL) {\r\nrequest_data->response_frame = pinfo->num;\r\nif(!pinfo->fd->flags.visited){\r\nif(fchdr->fctl&FC_FCTL_EXCHANGE_FIRST){\r\nrequest_data->itlq->first_exchange_frame=pinfo->num;\r\nrequest_data->itlq->fc_time = pinfo->abs_ts;\r\n}\r\nif(fchdr->fctl&FC_FCTL_EXCHANGE_LAST){\r\nrequest_data->itlq->last_exchange_frame=pinfo->num;\r\n}\r\n}\r\n} else {\r\nmemset(&empty_itlq, 0, sizeof(empty_itlq));\r\nempty_itlq.lun=0xffff;\r\nempty_itlq.scsi_opcode=0xffff;\r\n}\r\noffset += 8;\r\nproto_tree_add_item(tree, hf_fcp_retry_delay_timer, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nflags = tvb_get_guint8(tvb, offset);\r\ndissect_rsp_flags(tree, tvb, offset);\r\noffset += 1;\r\nitl.cmdset = 0xff;\r\nitl.conversation = conversation;\r\nproto_tree_add_item(tree, hf_fcp_scsistatus, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndissect_scsi_rsp(tvb, pinfo, parent_tree, (request_data != NULL) ? request_data->itlq : &empty_itlq, &itl, tvb_get_guint8(tvb, offset));\r\noffset += 1;\r\nif (flags & 0x0e) {\r\nproto_tree_add_item(tree, hf_fcp_resid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\noffset += 4;\r\nif (flags & 0x2) {\r\nsnslen = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(tree, hf_fcp_snslen, tvb, offset, 4,\r\nsnslen);\r\n}\r\noffset += 4;\r\nif (flags & 0x1) {\r\nrsplen = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_uint(tree, hf_fcp_rsplen, tvb, offset, 4,\r\nrsplen);\r\n}\r\noffset += 4;\r\nif (rsplen) {\r\ntvbuff_t *rspinfo_tvb;\r\nrspinfo_tvb = tvb_new_subset(tvb, offset, MIN(rsplen, tvb_captured_length_remaining(tvb, offset)), rsplen);\r\ndissect_fcp_rspinfo(rspinfo_tvb, tree, 0);\r\noffset += rsplen;\r\n}\r\nif (snslen) {\r\ntvbuff_t *sns_tvb;\r\nsns_tvb = tvb_new_subset(tvb, offset, MIN(snslen, tvb_captured_length_remaining(tvb, offset)), snslen);\r\ndissect_scsi_snsinfo(sns_tvb, pinfo, parent_tree, 0,\r\nsnslen,\r\n(request_data != NULL) ? request_data->itlq : &empty_itlq, &itl);\r\noffset += snslen;\r\n}\r\nif (flags & 0x80) {\r\nif (flags & 0x60) {\r\nproto_tree_add_item(tree, hf_fcp_bidir_resid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_fcp_xfer_rdy(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nint offset = 0;\r\nproto_tree_add_item(tree, hf_fcp_data_ro, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fcp_burstlen, tvb, offset+4, 4, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_fcp_srr(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, fc_hdr *fchdr)\r\n{\r\nguint8 r_ctl;\r\nr_ctl = fchdr->r_ctl & 0xf;\r\nif (r_ctl == FCP_IU_UNSOL_CTL) {\r\nproto_tree_add_item(tree, hf_fcp_srr_ox_id, tvb, 4, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fcp_srr_rx_id, tvb, 6, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fcp_data_ro, tvb, 8, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_fcp_r_ctl, tvb, 12, 1, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_fcp_els(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, fc_hdr *fchdr)\r\n{\r\nguint8 op;\r\nop = tvb_get_guint8(tvb, 0);\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str_ext(op, &fc_els_proto_val_ext, "0x%x"));\r\nproto_tree_add_item(tree, hf_fcp_els_op, tvb, 0, 1, ENC_NA);\r\nswitch (op) {\r\ncase FC_ELS_SRR:\r\ndissect_fcp_srr(tvb, pinfo, tree, fchdr);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_fcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *fcp_tree = NULL;\r\nfc_hdr *fchdr;\r\nguint8 r_ctl;\r\nconversation_t *fc_conv;\r\nfcp_conv_data_t *fcp_conv_data = NULL;\r\nfcp_request_data_t *request_data = NULL;\r\ngboolean els;\r\nfcp_proto_data_t *proto_data;\r\nif (data == NULL)\r\nreturn 0;\r\nfchdr = (fc_hdr *)data;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "FCP");\r\nr_ctl = fchdr->r_ctl;\r\nels = (r_ctl & 0xf0) == FC_RCTL_LINK_DATA;\r\nr_ctl &= 0xF;\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(r_ctl, els ? fcp_els_iu_val : fcp_iu_val,\r\n"0x%x"));\r\nti = proto_tree_add_protocol_format(tree, proto_fcp, tvb, 0, -1,\r\n"FCP: %s",\r\nval_to_str(r_ctl,\r\nels ? fcp_els_iu_val :\r\nfcp_iu_val, "Unknown 0x%02x"));\r\nfcp_tree = proto_item_add_subtree(ti, ett_fcp);\r\nfc_conv = find_conversation(pinfo->num, &pinfo->src, &pinfo->dst,\r\npinfo->ptype, pinfo->srcport,\r\npinfo->destport, 0);\r\nif (fc_conv != NULL) {\r\nfcp_conv_data = (fcp_conv_data_t *)conversation_get_proto_data(fc_conv, proto_fcp);\r\n}\r\nif (!fcp_conv_data) {\r\nfcp_conv_data = wmem_new(wmem_file_scope(), fcp_conv_data_t);\r\nfcp_conv_data->luns = wmem_map_new(wmem_file_scope(), g_direct_hash, g_direct_equal);\r\nconversation_add_proto_data(fc_conv, proto_fcp, fcp_conv_data);\r\n}\r\nif (!pinfo->fd->flags.visited) {\r\nproto_data = wmem_new(wmem_file_scope(), fcp_proto_data_t);\r\nproto_data->lun = fchdr->lun;\r\np_add_proto_data(wmem_file_scope(), pinfo, proto_fcp, 0, proto_data);\r\n} else {\r\nproto_data = (fcp_proto_data_t *)p_get_proto_data(wmem_file_scope(), pinfo, proto_fcp, 0);\r\n}\r\nif ((r_ctl != FCP_IU_CMD) && (r_ctl != FCP_IU_UNSOL_CTL)) {\r\nrequest_data = (fcp_request_data_t *)wmem_map_lookup(fcp_conv_data->luns, GUINT_TO_POINTER((guint)(proto_data->lun)));\r\n}\r\nif ((r_ctl != FCP_IU_CMD) && (r_ctl != FCP_IU_UNSOL_CTL) &&\r\n(request_data != NULL) && (request_data->itlq->first_exchange_frame)) {\r\nproto_item *it;\r\nit = proto_tree_add_uint(fcp_tree, hf_fcp_singlelun, tvb, 0, 0, proto_data->lun);\r\nPROTO_ITEM_SET_GENERATED(it);\r\nif (request_data != NULL) {\r\nit = proto_tree_add_uint(fcp_tree, hf_fcp_request_in, tvb, 0, 0, request_data->request_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\nif (r_ctl == FCP_IU_RSP) {\r\nnstime_t delta_ts;\r\nnstime_delta(&delta_ts, &pinfo->abs_ts, &request_data->request_time);\r\nit = proto_tree_add_time(ti, hf_fcp_time, tvb, 0, 0, &delta_ts);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\n}\r\n}\r\nif ((r_ctl != FCP_IU_RSP) && (r_ctl != FCP_IU_SOL_CTL) &&\r\n(request_data != NULL) && (request_data->response_frame)) {\r\nproto_item *it;\r\nit = proto_tree_add_uint(fcp_tree, hf_fcp_response_in, tvb, 0, 0, request_data->response_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nif (els) {\r\ndissect_fcp_els(tvb, pinfo, fcp_tree, fchdr);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nswitch (r_ctl) {\r\ncase FCP_IU_DATA:\r\ndissect_fcp_data(tvb, pinfo, tree, fc_conv, (request_data != NULL) ? request_data->itlq : NULL, fchdr->relative_offset);\r\nbreak;\r\ncase FCP_IU_CONFIRM:\r\nbreak;\r\ncase FCP_IU_XFER_RDY:\r\ndissect_fcp_xfer_rdy(tvb, fcp_tree);\r\nbreak;\r\ncase FCP_IU_CMD:\r\ndissect_fcp_cmnd(tvb, pinfo, tree, fcp_tree, fc_conv, fchdr, fcp_conv_data);\r\nbreak;\r\ncase FCP_IU_RSP:\r\ndissect_fcp_rsp(tvb, pinfo, tree, fcp_tree, fc_conv, fchdr, request_data);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(tvb, pinfo, tree);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_fcp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_fcp_multilun,\r\n{"Multi-Level LUN", "fcp.multilun",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_singlelun,\r\n{"LUN", "fcp.lun",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_crn,\r\n{"Command Ref Num", "fcp.crn",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_taskattr,\r\n{"Task Attribute", "fcp.taskattr",\r\nFT_UINT8, BASE_HEX, VALS(fcp_task_attr_val), 0x7,\r\nNULL, HFILL}},\r\n{ &hf_fcp_taskmgmt,\r\n{"Task Management Flags", "fcp.taskmgmt",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_addlcdblen,\r\n{"Additional CDB Length", "fcp.addlcdblen",\r\nFT_UINT8, BASE_DEC, NULL, 0xFC,\r\nNULL, HFILL}},\r\n{ &hf_fcp_rddata,\r\n{"RDDATA", "fcp.rddata",\r\nFT_BOOLEAN, 8, NULL, 0x02,\r\nNULL, HFILL}},\r\n{ &hf_fcp_wrdata,\r\n{"WRDATA", "fcp.wrdata",\r\nFT_BOOLEAN, 8, NULL, 0x01,\r\nNULL, HFILL}},\r\n{ &hf_fcp_dl,\r\n{"FCP_DL", "fcp.dl",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_bidir_dl,\r\n{"FCP_BIDIRECTIONAL_READ_DL", "fcp.bidir_dl",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_data_ro,\r\n{"FCP_DATA_RO", "fcp.data_ro",\r\nFT_UINT32, BASE_DEC, VALS(fcp_iu_val), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_r_ctl,\r\n{"R_CTL", "fcp.r_ctl",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_burstlen,\r\n{"Burst Length", "fcp.burstlen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_retry_delay_timer,\r\n{"Retry Delay Timer", "fcp.rsp.retry_delay_timer",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_rspflags,\r\n{"FCP_RSP Flags", "fcp.rspflags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_resid,\r\n{"FCP_RESID", "fcp.resid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_bidir_resid,\r\n{"Bidirectional Read Resid", "fcp.bidir_resid",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_snslen,\r\n{"FCP_SNS_LEN", "fcp.snslen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_rsplen,\r\n{"FCP_RSP_LEN", "fcp.rsplen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_rspcode,\r\n{"RSP_CODE", "fcp.rspcode",\r\nFT_UINT8, BASE_HEX, VALS(fcp_rsp_code_val), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_scsistatus,\r\n{"SCSI Status", "fcp.status",\r\nFT_UINT8, BASE_HEX, VALS(scsi_status_val), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_mgmt_flags_obsolete,\r\n{ "Obsolete", "fcp.mgmt.flags.obsolete",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_obsolete_tfs), 0x80,\r\nNULL, HFILL }},\r\n{ &hf_fcp_mgmt_flags_clear_aca,\r\n{ "Clear ACA", "fcp.mgmt.flags.clear_aca",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_clear_aca_tfs), 0x40,\r\nNULL, HFILL }},\r\n{ &hf_fcp_mgmt_flags_target_reset,\r\n{ "Target Reset", "fcp.mgmt.flags.target_reset",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_target_reset_tfs), 0x20,\r\nNULL, HFILL }},\r\n{ &hf_fcp_mgmt_flags_lu_reset,\r\n{ "LU Reset", "fcp.mgmt.flags.lu_reset",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_lu_reset_tfs), 0x10,\r\nNULL, HFILL }},\r\n{ &hf_fcp_mgmt_flags_rsvd,\r\n{ "Rsvd", "fcp.mgmt.flags.rsvd",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_rsvd_tfs), 0x08,\r\nNULL, HFILL }},\r\n{ &hf_fcp_mgmt_flags_clear_task_set,\r\n{ "Clear Task Set", "fcp.mgmt.flags.clear_task_set",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_clear_task_set_tfs), 0x04,\r\nNULL, HFILL }},\r\n{ &hf_fcp_mgmt_flags_abort_task_set,\r\n{ "Abort Task Set", "fcp.mgmt.flags.abort_task_set",\r\nFT_BOOLEAN, 8, TFS(&fcp_mgmt_flags_abort_task_set_tfs), 0x02,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_bidi,\r\n{ "Bidi Rsp", "fcp.rsp.flags.bidi",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_bidi_tfs), 0x80,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_bidi_rru,\r\n{ "Bidi Read Resid Under", "fcp.rsp.flags.bidi_rru",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_bidi_rru_tfs), 0x40,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_bidi_rro,\r\n{ "Bidi Read Resid Over", "fcp.rsp.flags.bidi_rro",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_bidi_rro_tfs), 0x20,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_conf_req,\r\n{ "Conf Req", "fcp.rsp.flags.conf_req",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_conf_req_tfs), 0x10,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_resid_under,\r\n{ "Resid Under", "fcp.rsp.flags.resid_under",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_resid_under_tfs), 0x08,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_resid_over,\r\n{ "Resid Over", "fcp.rsp.flags.resid_over",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_resid_over_tfs), 0x04,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_sns_vld,\r\n{ "SNS Vld", "fcp.rsp.flags.sns_vld",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_sns_vld_tfs), 0x02,\r\nNULL, HFILL }},\r\n{ &hf_fcp_rsp_flags_res_vld,\r\n{ "RES Vld", "fcp.rsp.flags.res_vld",\r\nFT_BOOLEAN, 8, TFS(&fcp_rsp_flags_res_vld_tfs), 0x01,\r\nNULL, HFILL }},\r\n{ &hf_fcp_request_in,\r\n{ "Request In", "fcp.request_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"The frame number for the request", HFILL }},\r\n{ &hf_fcp_response_in,\r\n{ "Response In", "fcp.response_in",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0,\r\n"The frame number of the response", HFILL }},\r\n{ &hf_fcp_time,\r\n{ "Time from FCP_CMND", "fcp.time",\r\nFT_RELATIVE_TIME, BASE_NONE, NULL, 0,\r\n"Time since the FCP_CMND frame", HFILL }},\r\n{ &hf_fcp_els_op,\r\n{"Opcode", "fcp.els.op",\r\nFT_UINT8, BASE_HEX|BASE_EXT_STRING, &fc_els_proto_val_ext, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_srr_ox_id,\r\n{"OX_ID", "fcp.els.srr.ox_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcp_srr_rx_id,\r\n{"RX_ID", "fcp.els.srr.rx_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_fcp,\r\n&ett_fcp_taskmgmt,\r\n&ett_fcp_rsp_flags,\r\n};\r\nproto_fcp = proto_register_protocol("Fibre Channel Protocol for SCSI",\r\n"FCP", "fcp");\r\nproto_register_field_array(proto_fcp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_fcp(void)\r\n{\r\ndissector_handle_t fcp_handle;\r\nfcp_handle = create_dissector_handle(dissect_fcp, proto_fcp);\r\ndissector_add_uint("fc.ftype", FC_FTYPE_SCSI, fcp_handle);\r\n}

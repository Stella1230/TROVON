static void\r\nriemann_verify_wire_format(guint64 field_number, const char *field_name, int expected, int actual,\r\npacket_info *pinfo, proto_item *pi)\r\n{\r\nif (expected != actual) {\r\nconst char *wire_name;\r\nswitch (expected) {\r\ncase RIEMANN_WIRE_INTEGER:\r\nwire_name = "integer";\r\nbreak;\r\ncase RIEMANN_WIRE_BYTES:\r\nwire_name = "bytes/string";\r\nbreak;\r\ncase RIEMANN_WIRE_FLOAT:\r\nwire_name = "float";\r\nbreak;\r\ncase RIEMANN_WIRE_DOUBLE:\r\nwire_name = "double";\r\nbreak;\r\ndefault:\r\nwire_name = "unknown (check packet-riemann.c)";\r\nbreak;\r\n}\r\nexpert_add_info_format(pinfo, pi, &ef_error_unknown_wire_tag,\r\n"Expected %s (%d) field to be an %s (%d), but it is %d",\r\nfield_name, (int)field_number, wire_name, expected, actual);\r\n}\r\n}\r\nstatic guint64\r\nriemann_get_guint64(tvbuff_t *tvb, guint offset, guint *len)\r\n{\r\nguint64 num = 0;\r\nguint shift = 0;\r\n*len = 0;\r\nwhile (1) {\r\nguint8 b;\r\nif (shift >= 64) {\r\nreturn 0;\r\n}\r\nb = tvb_get_guint8(tvb, offset++);\r\nnum |= ((guint64)(b & 0x7f) << shift);\r\nshift += 7;\r\n(*len)++;\r\nif ((b & 0x80) == 0) {\r\nreturn num;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic guint8 *\r\nriemann_get_string(tvbuff_t *tvb, gint offset)\r\n{\r\nguint64 size;\r\nguint len = 0;\r\nsize = riemann_get_guint64(tvb, offset, &len);\r\noffset += len;\r\nreturn tvb_get_string_enc(wmem_packet_scope(), tvb, offset, (gint)size, ENC_ASCII);\r\n}\r\nstatic guint\r\nriemann_dissect_int64(proto_tree *riemann_tree, tvbuff_t *tvb, guint offset, int hf_index)\r\n{\r\nguint64 num;\r\nguint len = 0;\r\nnum = riemann_get_guint64(tvb, offset, &len);\r\nproto_tree_add_int64(riemann_tree, hf_index, tvb, offset, len, num);\r\nreturn len;\r\n}\r\nstatic guint\r\nriemann_dissect_sint64(proto_tree *riemann_tree, tvbuff_t *tvb, guint offset, int hf_index)\r\n{\r\nguint64 num;\r\ngint64 snum;\r\nguint len = 0;\r\nnum = riemann_get_guint64(tvb, offset, &len);\r\nif (num & 1) {\r\nsnum = -((gint64)(num >> 1)) - 1;\r\n} else {\r\nsnum = (gint64)(num >> 1);\r\n}\r\nproto_tree_add_int64(riemann_tree, hf_index, tvb, offset, len, snum);\r\nreturn len;\r\n}\r\nstatic guint\r\nriemann_dissect_string(proto_tree *riemann_tree, tvbuff_t *tvb, guint offset, int hf_index)\r\n{\r\nguint64 size;\r\nguint len = 0, orig_offset = offset;\r\nsize = riemann_get_guint64(tvb, offset, &len);\r\noffset += len;\r\nproto_tree_add_item(riemann_tree, hf_index, tvb, offset, (gint)size, ENC_ASCII);\r\noffset += (gint)size;\r\nreturn offset - orig_offset;\r\n}\r\nstatic guint\r\nriemann_dissect_attribute(packet_info *pinfo, proto_tree *riemann_tree,\r\ntvbuff_t *tvb, guint offset)\r\n{\r\nguint64 tag, fn;\r\ngint64 size;\r\nguint8 wire;\r\nguint len = 0;\r\nguint orig_offset = offset;\r\nproto_item *pi;\r\nproto_tree *attribute_tree;\r\nsize = (gint64)riemann_get_guint64(tvb, offset, &len);\r\npi = proto_tree_add_item(riemann_tree, hf_riemann_attribute, tvb, (gint)offset, (gint)(size + len), ENC_NA);\r\nattribute_tree = proto_item_add_subtree(pi, ett_attribute);\r\noffset += len;\r\nwhile (size > 0) {\r\ntag = riemann_get_guint64(tvb, offset, &len);\r\nfn = tag >> 3;\r\nwire = tag & 0x7;\r\noffset += len;\r\nsize -= len;\r\nswitch (fn) {\r\ncase RIEMANN_FN_ATTRIBUTE_KEY:\r\nVERIFY_WIRE_FORMAT("Attribute.key", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(attribute_tree, tvb, offset, hf_riemann_attribute_key);\r\nbreak;\r\ncase RIEMANN_FN_ATTRIBUTE_VALUE:\r\nVERIFY_WIRE_FORMAT("Attribute.value", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(attribute_tree, tvb, offset, hf_riemann_attribute_value);\r\nbreak;\r\ndefault:\r\nlen = 0;\r\nUNKNOWN_FIELD_NUMBER_FOR("Attribute");\r\n}\r\noffset += len;\r\nsize -= len;\r\n}\r\nVERIFY_SIZE_FOR("Attribute");\r\nreturn offset - orig_offset;\r\n}\r\nstatic guint\r\nriemann_dissect_query(packet_info *pinfo, proto_tree *riemann_tree,\r\ntvbuff_t *tvb, guint offset)\r\n{\r\nguint64 tag, fn;\r\ngint64 size;\r\nguint8 wire;\r\nguint orig_offset = offset, len = 0;\r\nproto_item *pi;\r\nproto_tree *query_tree;\r\nsize = (gint64)riemann_get_guint64(tvb, offset, &len);\r\npi = proto_tree_add_item(riemann_tree, hf_riemann_query, tvb, (gint)offset, (gint)(size + len), ENC_NA);\r\nquery_tree = proto_item_add_subtree(pi, ett_query);\r\noffset += len;\r\nwhile (size > 0) {\r\ntag = riemann_get_guint64(tvb, offset, &len);\r\nfn = tag >> 3;\r\nwire = tag & 0x7;\r\noffset += len;\r\nsize -= len;\r\nswitch (fn) {\r\ncase RIEMANN_FN_QUERY_STRING:\r\nVERIFY_WIRE_FORMAT("Query.string", RIEMANN_WIRE_BYTES);\r\ncol_append_str(pinfo->cinfo, COL_INFO, riemann_get_string(tvb, offset));\r\nlen = riemann_dissect_string(query_tree, tvb, offset, hf_riemann_query_string);\r\nbreak;\r\ndefault:\r\nlen = 0;\r\nUNKNOWN_FIELD_NUMBER_FOR("Query");\r\n}\r\noffset += len;\r\nsize -= len;\r\n}\r\nVERIFY_SIZE_FOR("Query");\r\nreturn offset - orig_offset;\r\n}\r\nstatic guint\r\nriemann_dissect_event(packet_info *pinfo, proto_tree *riemann_tree,\r\ntvbuff_t *tvb, guint offset)\r\n{\r\nguint orig_offset = offset, len = 0;\r\nguint64 tag, fn;\r\ngint64 size;\r\nguint8 wire;\r\nproto_item *pi;\r\nproto_tree *event_tree;\r\ngboolean need_comma = FALSE;\r\nsize = riemann_get_guint64(tvb, offset, &len);\r\npi = proto_tree_add_item(riemann_tree, hf_riemann_event, tvb, (gint)offset, (gint)(size + len), ENC_NA);\r\nevent_tree = proto_item_add_subtree(pi, ett_event);\r\noffset += len;\r\nwhile (size > 0) {\r\nconst char *comma = need_comma ? ", " : "";\r\ntag = riemann_get_guint64(tvb, offset, &len);\r\nfn = tag >> 3;\r\nwire = tag & 0x7;\r\noffset += len;\r\nsize -= len;\r\nswitch (fn) {\r\ncase RIEMANN_FN_EVENT_TIME:\r\nVERIFY_WIRE_FORMAT("Event.time", RIEMANN_WIRE_INTEGER);\r\nlen = riemann_dissect_int64(event_tree, tvb, offset, hf_riemann_event_time);\r\nbreak;\r\ncase RIEMANN_FN_EVENT_STATE:\r\nVERIFY_WIRE_FORMAT("Event.state", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(event_tree, tvb, offset, hf_riemann_event_state);\r\nbreak;\r\ncase RIEMANN_FN_EVENT_SERVICE:\r\nVERIFY_WIRE_FORMAT("Event.service", RIEMANN_WIRE_BYTES);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s%s", comma, riemann_get_string(tvb, offset));\r\nlen = riemann_dissect_string(event_tree, tvb, offset, hf_riemann_event_service);\r\nneed_comma = TRUE;\r\nbreak;\r\ncase RIEMANN_FN_EVENT_HOST:\r\nVERIFY_WIRE_FORMAT("Event.host", RIEMANN_WIRE_BYTES);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s%s", comma, riemann_get_string(tvb, offset));\r\nlen = riemann_dissect_string(event_tree, tvb, offset, hf_riemann_event_host);\r\nneed_comma = TRUE;\r\nbreak;\r\ncase RIEMANN_FN_EVENT_DESCRIPTION:\r\nVERIFY_WIRE_FORMAT("Event.description", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(event_tree, tvb, offset, hf_riemann_event_description);\r\nbreak;\r\ncase RIEMANN_FN_EVENT_TAGS:\r\nVERIFY_WIRE_FORMAT("Event.tags", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(event_tree, tvb, offset, hf_riemann_event_tag);\r\nbreak;\r\ncase RIEMANN_FN_EVENT_TTL:\r\nVERIFY_WIRE_FORMAT("Event.ttl", RIEMANN_WIRE_FLOAT);\r\nproto_tree_add_item(event_tree, hf_riemann_event_ttl, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nlen = 4;\r\nbreak;\r\ncase RIEMANN_FN_EVENT_ATTRIBUTES:\r\nVERIFY_WIRE_FORMAT("Event.attributes", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_attribute(pinfo, event_tree, tvb, offset);\r\nbreak;\r\ncase RIEMANN_FN_EVENT_METRIC_SINT64:\r\nVERIFY_WIRE_FORMAT("Event.metric_sint64", RIEMANN_WIRE_INTEGER);\r\nlen = riemann_dissect_sint64(event_tree, tvb, offset, hf_riemann_event_metric_sint64);\r\nbreak;\r\ncase RIEMANN_FN_EVENT_METRIC_D:\r\nVERIFY_WIRE_FORMAT("Event.metric_d", RIEMANN_WIRE_DOUBLE);\r\nproto_tree_add_item(event_tree, hf_riemann_event_metric_d, tvb, offset, 8, ENC_LITTLE_ENDIAN);\r\nlen = 8;\r\nbreak;\r\ncase RIEMANN_FN_EVENT_METRIC_F:\r\nVERIFY_WIRE_FORMAT("Event.metric_f", RIEMANN_WIRE_FLOAT);\r\nproto_tree_add_item(event_tree, hf_riemann_event_metric_f, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nlen = 4;\r\nbreak;\r\ndefault:\r\nlen = 0;\r\nUNKNOWN_FIELD_NUMBER_FOR("Event");\r\n}\r\noffset += len;\r\nsize -= len;\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, "; ");\r\nVERIFY_SIZE_FOR("Event");\r\nreturn offset - orig_offset;\r\n}\r\nstatic guint\r\nriemann_dissect_state(packet_info *pinfo, proto_tree *riemann_tree,\r\ntvbuff_t *tvb, guint offset)\r\n{\r\nguint orig_offset = offset, len = 0;\r\nguint64 tag, fn;\r\ngint64 size;\r\nguint8 wire;\r\nproto_item *pi;\r\nproto_tree *state_tree;\r\ngboolean need_comma = FALSE;\r\nsize = riemann_get_guint64(tvb, offset, &len);\r\npi = proto_tree_add_item(riemann_tree, hf_riemann_state, tvb, offset, (gint)(size + len), ENC_NA);\r\nstate_tree = proto_item_add_subtree(pi, ett_state);\r\noffset += len;\r\nwhile (size > 0) {\r\nconst char *comma = need_comma ? ", " : "";\r\ntag = riemann_get_guint64(tvb, offset, &len);\r\nfn = tag >> 3;\r\nwire = tag & 0x7;\r\noffset += len;\r\nsize -= len;\r\nswitch (fn) {\r\ncase RIEMANN_FN_STATE_TIME:\r\nVERIFY_WIRE_FORMAT("State.time", RIEMANN_WIRE_INTEGER);\r\nlen = riemann_dissect_int64(state_tree, tvb, offset, hf_riemann_state_time);\r\nbreak;\r\ncase RIEMANN_FN_STATE_SERVICE:\r\nVERIFY_WIRE_FORMAT("State.service", RIEMANN_WIRE_BYTES);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s%s", comma, riemann_get_string(tvb, offset));\r\nlen = riemann_dissect_string(state_tree, tvb, offset, hf_riemann_state_service);\r\nneed_comma = TRUE;\r\nbreak;\r\ncase RIEMANN_FN_STATE_HOST:\r\nVERIFY_WIRE_FORMAT("State.host", RIEMANN_WIRE_BYTES);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s%s", comma, riemann_get_string(tvb, offset));\r\nlen = riemann_dissect_string(state_tree, tvb, offset, hf_riemann_state_host);\r\nneed_comma = TRUE;\r\nbreak;\r\ncase RIEMANN_FN_STATE_DESCRIPTION:\r\nVERIFY_WIRE_FORMAT("State.description", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(state_tree, tvb, offset, hf_riemann_state_description);\r\nbreak;\r\ncase RIEMANN_FN_STATE_TAGS:\r\nVERIFY_WIRE_FORMAT("State.tags", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(state_tree, tvb, offset, hf_riemann_state_tag);\r\nbreak;\r\ncase RIEMANN_FN_STATE_TTL:\r\nVERIFY_WIRE_FORMAT("State.ttl", RIEMANN_WIRE_FLOAT);\r\nproto_tree_add_item(state_tree, hf_riemann_state_ttl, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nlen = 4;\r\nbreak;\r\ncase RIEMANN_FN_STATE_STATE:\r\nVERIFY_WIRE_FORMAT("State.state", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(state_tree, tvb, offset, hf_riemann_state_state);\r\nbreak;\r\ncase RIEMANN_FN_STATE_ONCE:\r\nVERIFY_WIRE_FORMAT("State.once", RIEMANN_WIRE_INTEGER);\r\nproto_tree_add_item(state_tree, hf_riemann_state_once, tvb, offset, 1, ENC_NA);\r\nlen = 1;\r\nbreak;\r\ndefault:\r\nlen = 0;\r\nUNKNOWN_FIELD_NUMBER_FOR("State");\r\n}\r\noffset += len;\r\nsize -= len;\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, "; ");\r\nVERIFY_SIZE_FOR("State");\r\nreturn offset - orig_offset;\r\n}\r\nstatic guint\r\nriemann_dissect_msg(packet_info *pinfo, proto_item *pi, proto_tree *riemann_tree,\r\ntvbuff_t *tvb, guint offset)\r\n{\r\nguint64 tag, fn;\r\ngint64 size = (gint64)tvb_reported_length_remaining(tvb, offset);\r\nguint8 wire;\r\nguint len, orig_offset = offset;\r\ngboolean cinfo_set = FALSE;\r\nwhile (size > 0) {\r\ntag = riemann_get_guint64(tvb, offset, &len);\r\nfn = tag >> 3;\r\nwire = tag & 0x7;\r\noffset += len;\r\nsize -= len;\r\nswitch (fn) {\r\ncase RIEMANN_FN_MSG_OK:\r\nVERIFY_WIRE_FORMAT("Msg.ok", RIEMANN_WIRE_INTEGER);\r\nproto_tree_add_item(riemann_tree, hf_riemann_msg_ok, tvb, offset, 1, ENC_NA);\r\nlen = 1;\r\nbreak;\r\ncase RIEMANN_FN_MSG_ERROR:\r\nVERIFY_WIRE_FORMAT("Msg.error", RIEMANN_WIRE_BYTES);\r\nlen = riemann_dissect_string(riemann_tree, tvb, offset, hf_riemann_msg_error);\r\nbreak;\r\ncase RIEMANN_FN_MSG_QUERY:\r\nVERIFY_WIRE_FORMAT("Msg.query", RIEMANN_WIRE_BYTES);\r\nif (!cinfo_set) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Query: ");\r\ncinfo_set = TRUE;\r\n}\r\nlen = riemann_dissect_query(pinfo, riemann_tree, tvb, offset);\r\nbreak;\r\ncase RIEMANN_FN_MSG_EVENTS:\r\nVERIFY_WIRE_FORMAT("Msg.events", RIEMANN_WIRE_BYTES);\r\nif (!cinfo_set) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Event: ");\r\ncinfo_set = TRUE;\r\n}\r\nlen = riemann_dissect_event(pinfo, riemann_tree, tvb, offset);\r\nbreak;\r\ncase RIEMANN_FN_MSG_STATES:\r\nVERIFY_WIRE_FORMAT("Msg.states", RIEMANN_WIRE_BYTES);\r\nif (!cinfo_set) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "State: ");\r\ncinfo_set = TRUE;\r\n}\r\nlen = riemann_dissect_state(pinfo, riemann_tree, tvb, offset);\r\nbreak;\r\ndefault:\r\nlen = 0;\r\nUNKNOWN_FIELD_NUMBER_FOR("Msg");\r\n}\r\noffset += len;\r\nsize -= len;\r\n}\r\nVERIFY_SIZE_FOR("Msg");\r\nreturn offset - orig_offset;\r\n}\r\nstatic gboolean\r\nis_riemann(tvbuff_t *tvb, guint offset)\r\n{\r\nguint32 reported_length = tvb_reported_length_remaining(tvb, offset);\r\nguint32 captured_length = tvb_captured_length_remaining(tvb, offset);\r\nguint64 tag, field_number, wire_format;\r\nguint len;\r\nif ((reported_length < RIEMANN_MIN_LENGTH) ||\r\n(captured_length < RIEMANN_MIN_NEEDED_FOR_HEURISTICS)) {\r\nreturn FALSE;\r\n}\r\ntag = riemann_get_guint64(tvb, offset, &len);\r\nfield_number = tag >> 3;\r\nwire_format = tag & 0x7;\r\nif ((field_number == RIEMANN_FN_MSG_OK && wire_format == RIEMANN_WIRE_INTEGER) ||\r\n(field_number == RIEMANN_FN_MSG_ERROR && wire_format == RIEMANN_WIRE_BYTES) ||\r\n(field_number == RIEMANN_FN_MSG_QUERY && wire_format == RIEMANN_WIRE_BYTES) ||\r\n(field_number == RIEMANN_FN_MSG_EVENTS && wire_format == RIEMANN_WIRE_BYTES) ||\r\n(field_number == RIEMANN_FN_MSG_STATES && wire_format == RIEMANN_WIRE_BYTES)) {\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic int\r\ndissect_riemann(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint offset)\r\n{\r\nproto_item *pi;\r\nproto_tree *riemann_tree;\r\nif (!is_riemann(tvb, offset))\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "riemann");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\npi = proto_tree_add_item(tree, proto_riemann, tvb, offset, -1, ENC_NA);\r\nriemann_tree = proto_item_add_subtree(pi, ett_riemann);\r\nreturn riemann_dissect_msg(pinfo, pi, riemann_tree, tvb, offset);\r\n}\r\nstatic int\r\ndissect_riemann_udp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_riemann(tvb, pinfo, tree, 0);\r\n}\r\nstatic int\r\ndissect_riemann_tcp_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_riemann(tvb, pinfo, tree, 4);\r\n}\r\nstatic guint\r\nget_riemann_tcp_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nreturn (tvb_get_ntohl(tvb, offset) + 4);\r\n}\r\nstatic int\r\ndissect_riemann_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, 4, get_riemann_tcp_pdu_len, dissect_riemann_tcp_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_riemann(void)\r\n{\r\nmodule_t *riemann_module;\r\nexpert_module_t *riemann_expert_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_riemann_msg_ok,\r\n{ "ok", "riemann.msg.ok",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_msg_error,\r\n{ "error", "riemann.msg.error",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_attribute,\r\n{ "attribute", "riemann.attribute",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_attribute_key,\r\n{ "key", "riemann.attribute.key",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_attribute_value,\r\n{ "value", "riemann.attribute.value",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_query,\r\n{ "query", "riemann.query",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_query_string,\r\n{ "string", "riemann.query.string",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event,\r\n{ "event", "riemann.event",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_state,\r\n{ "state", "riemann.event.state",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_service,\r\n{ "service", "riemann.event.service",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_host,\r\n{ "host", "riemann.event.host",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_description,\r\n{ "description", "riemann.event.description",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_tag,\r\n{ "tag", "riemann.event.tag",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_time,\r\n{ "time", "riemann.event.time",\r\nFT_INT64, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_ttl,\r\n{ "ttl", "riemann.event.ttl",\r\nFT_FLOAT, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_metric_d,\r\n{ "metric_d", "riemann.event.metric_d",\r\nFT_DOUBLE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_metric_f,\r\n{ "metric_f", "riemann.event.metric_f",\r\nFT_FLOAT, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_event_metric_sint64,\r\n{ "metric_sint64", "riemann.event.metric_sint64",\r\nFT_INT64, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state,\r\n{ "state", "riemann.state",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_service,\r\n{ "service", "riemann.state.service",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_host,\r\n{ "host", "riemann.state.host",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_description,\r\n{ "description", "riemann.state.description",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_tag,\r\n{ "tag", "riemann.state.tag",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_time,\r\n{ "time", "riemann.state.time",\r\nFT_INT64, BASE_DEC, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_ttl,\r\n{ "ttl", "riemann.state.ttl",\r\nFT_FLOAT, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_state,\r\n{ "state", "riemann.state.state",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }\r\n},\r\n{ &hf_riemann_state_once,\r\n{ "once", "riemann.state.once",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0, NULL, HFILL }\r\n}\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ef_error_unknown_wire_tag,\r\n{ "riemann.unknown_wire_tag", PI_MALFORMED, PI_ERROR,\r\nNULL, EXPFILL }},\r\n{ &ef_error_unknown_field_number,\r\n{ "riemann.unknown_field_number", PI_MALFORMED, PI_ERROR,\r\nNULL, EXPFILL }},\r\n{ &ef_error_insufficient_data,\r\n{ "riemann.insufficient_data", PI_MALFORMED, PI_ERROR,\r\nNULL, EXPFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_riemann,\r\n&ett_query,\r\n&ett_event,\r\n&ett_attribute,\r\n&ett_state\r\n};\r\nproto_riemann = proto_register_protocol("Riemann", "Riemann", "riemann");\r\nriemann_expert_module = expert_register_protocol(proto_riemann);\r\nexpert_register_field_array(riemann_expert_module, ei, array_length(ei));\r\nproto_register_field_array(proto_riemann, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nriemann_module = prefs_register_protocol(proto_riemann, proto_reg_handoff_riemann);\r\nprefs_register_uint_preference(riemann_module, "udp.port", "Riemann UDP Port",\r\n" riemann UDP port if other than the default",\r\n10, &udp_port_pref);\r\nprefs_register_uint_preference(riemann_module, "tcp.port", "Riemann TCP Port",\r\n" riemann TCP port if other than the default",\r\n10, &tcp_port_pref);\r\n}\r\nvoid\r\nproto_reg_handoff_riemann(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic dissector_handle_t riemann_udp_handle, riemann_tcp_handle;\r\nstatic int current_udp_port, current_tcp_port;\r\nif (!initialized) {\r\nriemann_udp_handle = create_dissector_handle(dissect_riemann_udp, proto_riemann);\r\nriemann_tcp_handle = create_dissector_handle(dissect_riemann_tcp, proto_riemann);\r\ninitialized = TRUE;\r\n} else {\r\ndissector_delete_uint("udp.port", current_udp_port, riemann_udp_handle);\r\ndissector_delete_uint("tcp.port", current_tcp_port, riemann_tcp_handle);\r\n}\r\ncurrent_udp_port = udp_port_pref;\r\ndissector_add_uint("udp.port", current_udp_port, riemann_udp_handle);\r\ncurrent_tcp_port = tcp_port_pref;\r\ndissector_add_uint("tcp.port", current_tcp_port, riemann_tcp_handle);\r\n}

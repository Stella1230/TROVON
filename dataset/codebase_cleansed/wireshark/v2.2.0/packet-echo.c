static int dissect_echo(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\ngboolean request = FALSE;\r\nif (pinfo->destport == ECHO_PORT) {\r\nrequest = TRUE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ECHO");\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\n(request) ? "Request" : "Response");\r\nif (tree) {\r\nproto_tree *echo_tree;\r\nproto_item *ti, *hidden_item;\r\nti = proto_tree_add_item(tree, proto_echo, tvb, offset, -1, ENC_NA);\r\necho_tree = proto_item_add_subtree(ti, ett_echo);\r\nif (request) {\r\nhidden_item = proto_tree_add_boolean(echo_tree, hf_echo_request, tvb, 0, 0, 1);\r\n} else {\r\nhidden_item = proto_tree_add_boolean(echo_tree, hf_echo_response, tvb, 0, 0, 1);\r\n}\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\nproto_tree_add_item(echo_tree, hf_echo_data, tvb, offset, -1, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_echo(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_echo_data,\r\n{ "Echo data", "echo.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_echo_request,\r\n{ "Echo request", "echo.request",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"Echo data", HFILL }},\r\n{ &hf_echo_response,\r\n{ "Echo response","echo.response",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\n"Echo data", HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_echo\r\n};\r\nproto_echo = proto_register_protocol("Echo", "ECHO", "echo");\r\nproto_register_field_array(proto_echo, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_echo(void)\r\n{\r\ndissector_handle_t echo_handle;\r\necho_handle = create_dissector_handle(dissect_echo, proto_echo);\r\ndissector_add_uint("udp.port", ECHO_PORT, echo_handle);\r\ndissector_add_uint("tcp.port", ECHO_PORT, echo_handle);\r\n}

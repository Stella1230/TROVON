static int wme_getpsidlen (guint8 *psid)\r\n{\r\nint length = 0;\r\nif ((psid[0] & 0xF0) == 0xF0) {\r\nlength = 255;\r\n} else if ( (psid[0] & 0xF0) == 0xE0) {\r\nlength = 4;\r\n} else if ( (psid[0] & 0xE0) == 0xC0) {\r\nlength = 3;\r\n} else if ( (psid[0] & 0xC0) == 0x80) {\r\nlength = 2;\r\n} else if ((psid[0] & 0x80) == 0x00) {\r\nlength = 1;\r\n}\r\nreturn length;\r\n}\r\nstatic int\r\ndissect_wsmp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *wsmp_tree, *wsmdata_tree;\r\ntvbuff_t *wsmdata_tvb;\r\nguint16 wsmlength, offset;\r\nguint32 psidLen, psid, supLen;\r\nguint8 elemenId, elemenLen, msb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WSMP");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "WAVE Short Message Protocol IEEE P1609.3");\r\nti = proto_tree_add_item(tree, proto_wsmp, tvb, 0, -1, ENC_NA);\r\nwsmp_tree = proto_item_add_subtree(ti, ett_wsmp);\r\noffset = 0;\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\npsid = tvb_get_guint8(tvb, offset);\r\npsidLen = (guint32)wme_getpsidlen((guint8*)&psid);\r\nif (psidLen == 2)\r\npsid = tvb_get_ntohs(tvb, offset);\r\nelse if (psidLen == 3)\r\npsid = tvb_get_ntoh24(tvb, offset);\r\nelse if (psidLen == 4)\r\npsid = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_psid, tvb, offset, psidLen, ENC_BIG_ENDIAN);\r\noffset += psidLen;\r\nelemenId = tvb_get_guint8(tvb, offset);\r\nwhile ((elemenId != WSMP) && (elemenId != WSMP_S) && (elemenId != WSMP_I))\r\n{\r\noffset++;\r\nif (elemenId == CHANNUM)\r\n{\r\nelemenLen = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_channel, tvb, offset, elemenLen, ENC_BIG_ENDIAN);\r\noffset += elemenLen;\r\n}\r\nelse if (elemenId == DATARATE)\r\n{\r\nelemenLen = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_rate, tvb, offset, elemenLen, ENC_BIG_ENDIAN);\r\noffset += elemenLen;\r\n}\r\nelse if (elemenId == TRANSMITPW)\r\n{\r\nelemenLen = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_txpower, tvb, offset, elemenLen, ENC_BIG_ENDIAN);\r\noffset += elemenLen;\r\n}\r\nelemenId = tvb_get_guint8(tvb, offset);\r\n}\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_WAVEid, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwsmlength = tvb_get_letohs( tvb, offset);\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_wsmlength, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (elemenId == WSMP_S)\r\n{\r\nmsb = 1;\r\nsupLen = 0;\r\nwhile (msb)\r\n{\r\nmsb = tvb_get_guint8(tvb, offset + supLen);\r\nmsb = msb & 0x80;\r\nsupLen++;\r\n}\r\nproto_tree_add_item(wsmp_tree,\r\nhf_wsmp_WSMP_S_data, tvb, offset, supLen, ENC_BIG_ENDIAN);\r\nwsmlength -= supLen;\r\noffset += supLen;\r\n}\r\nwsmdata_tree = proto_tree_add_subtree(wsmp_tree, tvb, offset, wsmlength,\r\nett_wsmdata, NULL, "Wave Short Message");\r\nwsmdata_tvb = tvb_new_subset(tvb, offset, -1, wsmlength);\r\nif (psid == 0xbff0)\r\n{\r\ncall_data_dissector(wsmdata_tvb, pinfo, wsmdata_tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_wsmp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_wsmp_version,\r\n{ "Version", "wsmp.version", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_psid,\r\n{ "PSID", "wsmp.psid", FT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_channel,\r\n{ "Channel", "wsmp.channel", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_rate,\r\n{ "Data Rate", "wsmp.rate", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_txpower,\r\n{ "Transmit Power", "wsmp.txpower", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_WAVEid,\r\n{ "WAVE element id", "wsmp.WAVEid", FT_UINT8, BASE_DEC, VALS(wsmp_elemenid_names), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_wsmlength,\r\n{ "WSM Length", "wsmp.wsmlength", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_wsmp_WSMP_S_data,\r\n{ "WAVE Supplement Data", "wsmp.supplement", FT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_wsmp,\r\n&ett_wsmdata,\r\n};\r\nproto_wsmp = proto_register_protocol("Wave Short Message Protocol(IEEE P1609.3)",\r\n"WSMP", "wsmp");\r\nproto_register_field_array(proto_wsmp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_wsmp(void)\r\n{\r\ndissector_handle_t wsmp_handle;\r\nwsmp_handle = create_dissector_handle(dissect_wsmp, proto_wsmp);\r\ndissector_add_uint("ethertype", ETHERTYPE_WSMP, wsmp_handle);\r\n}

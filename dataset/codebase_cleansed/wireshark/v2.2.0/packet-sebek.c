static int\r\ndissect_sebek(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *sebek_tree;\r\nproto_item *ti;\r\nint offset = 0;\r\nnstime_t ts;\r\nint sebek_ver = 0;\r\nint sebek_type = 0;\r\nint cmd_len = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SEBEK");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "SEBEK - ");\r\nif (tvb_captured_length(tvb)<6)\r\nsebek_ver = 0;\r\nelse\r\nsebek_ver = tvb_get_ntohs(tvb, 4);\r\nswitch (sebek_ver) {\r\ncase 2: col_append_fstr(pinfo->cinfo, COL_INFO, " pid(%d)", tvb_get_ntohl(tvb, 20));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " uid(%d)", tvb_get_ntohl(tvb, 24));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " fd(%d)", tvb_get_ntohl(tvb, 28));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " cmd: %s", tvb_format_text(tvb, 32, 12));\r\nbreak;\r\ncase 3: col_append_fstr(pinfo->cinfo, COL_INFO, " pid(%d)", tvb_get_ntohl(tvb, 24));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " uid(%d)", tvb_get_ntohl(tvb, 28));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " fd(%d)", tvb_get_ntohl(tvb, 32));\r\ncmd_len = tvb_strnlen(tvb, 40, 12);\r\nif (cmd_len<0)\r\ncmd_len = 0;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " cmd: %s", tvb_format_text(tvb, 40, cmd_len));\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_sebek, tvb, 0, -1, ENC_NA);\r\nsebek_tree = proto_item_add_subtree(ti, ett_sebek);\r\nif (tvb_captured_length(tvb)<6)\r\nsebek_ver = 0;\r\nelse\r\nsebek_ver = tvb_get_ntohs(tvb, 4);\r\nswitch (sebek_ver) {\r\ncase 2: proto_tree_add_item(sebek_tree, hf_sebek_magic, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sebek_tree, hf_sebek_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sebek_tree, hf_sebek_counter, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset+4);\r\nproto_tree_add_time(sebek_tree, hf_sebek_time, tvb, offset, 8, &ts);\r\noffset += 8;\r\nproto_tree_add_item(sebek_tree, hf_sebek_pid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_uid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_fd, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_cmd, tvb, offset, 12, ENC_ASCII|ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(sebek_tree, hf_sebek_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_data, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 3: proto_tree_add_item(sebek_tree, hf_sebek_magic, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nsebek_type=tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(sebek_tree, hf_sebek_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sebek_tree, hf_sebek_counter, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset+4);\r\nproto_tree_add_time(sebek_tree, hf_sebek_time, tvb, offset, 8, &ts);\r\noffset += 8;\r\nproto_tree_add_item(sebek_tree, hf_sebek_ppid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_pid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_uid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_fd, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_inode, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_cmd, tvb, offset, 12, ENC_ASCII|ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(sebek_tree, hf_sebek_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (sebek_type == 2) {\r\nproto_tree_add_item(sebek_tree, hf_sebek_socket_dst_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_socket_dst_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sebek_tree, hf_sebek_socket_src_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sebek_tree, hf_sebek_socket_src_port, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sebek_tree, hf_sebek_socket_call, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sebek_tree, hf_sebek_socket_proto, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\n} else {\r\nproto_tree_add_item(sebek_tree, hf_sebek_data, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_sebek(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sebek_magic, {\r\n"Magic", "sebek.magic", FT_UINT32, BASE_HEX,\r\nNULL, 0, "Magic Number", HFILL }},\r\n{ &hf_sebek_version, {\r\n"Version", "sebek.version", FT_UINT16, BASE_DEC,\r\nNULL, 0, "Version Number", HFILL }},\r\n{ &hf_sebek_type, {\r\n"Type", "sebek.type", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_counter, {\r\n"Counter", "sebek.counter", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_time, {\r\n"Time", "sebek.time.sec", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_pid, {\r\n"Process ID", "sebek.pid", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_uid, {\r\n"User ID", "sebek.uid", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_fd, {\r\n"File Descriptor", "sebek.fd", FT_UINT32, BASE_DEC,\r\nNULL, 0, "File Descriptor Number", HFILL }},\r\n{ &hf_sebek_cmd, {\r\n"Command Name", "sebek.cmd", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_len, {\r\n"Data Length", "sebek.len", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_ppid, {\r\n"Parent Process ID", "sebek.ppid", FT_UINT32, BASE_DEC,\r\nNULL, 0, "Process ID", HFILL }},\r\n{ &hf_sebek_inode, {\r\n"Inode ID", "sebek.inode", FT_UINT32, BASE_DEC,\r\nNULL, 0, "Process ID", HFILL }},\r\n{ &hf_sebek_data, {\r\n"Data", "sebek.data", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_sebek_socket_src_ip, {\r\n"Socket.local_ip", "sebek.socket.src_ip", FT_IPv4, BASE_NONE,\r\nNULL, 0, "Socket.src_ip", HFILL }},\r\n{ &hf_sebek_socket_src_port, {\r\n"Socket.local_port", "sebek.socket.src_port", FT_UINT16, BASE_DEC,\r\nNULL, 0, "Socket.src_port", HFILL }},\r\n{ &hf_sebek_socket_dst_ip, {\r\n"Socket.remote_ip", "sebek.socket.dst_ip", FT_IPv4, BASE_NONE,\r\nNULL, 0, "Socket.dst_ip", HFILL }},\r\n{ &hf_sebek_socket_dst_port, {\r\n"Socket.remote_port", "sebek.socket.dst_port", FT_UINT16, BASE_DEC,\r\nNULL, 0, "Socket.dst_port", HFILL }},\r\n{ &hf_sebek_socket_call, {\r\n"Socket.Call_id", "sebek.socket.call", FT_UINT16, BASE_DEC,\r\nNULL, 0, "Socket.call", HFILL }},\r\n{ &hf_sebek_socket_proto, {\r\n"Socket.ip_proto", "sebek.socket.ip_proto", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_sebek\r\n};\r\nproto_sebek = proto_register_protocol("SEBEK - Kernel Data Capture", "SEBEK", "sebek");\r\nproto_register_field_array(proto_sebek, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_sebek(void)\r\n{\r\ndissector_handle_t sebek_handle;\r\nsebek_handle = create_dissector_handle(dissect_sebek, proto_sebek);\r\ndissector_add_uint("udp.port", UDP_PORT_SEBEK, sebek_handle);\r\n}

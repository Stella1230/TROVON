int\r\ndissect_h263_group_of_blocks_layer( tvbuff_t *tvb, proto_tree *tree, gint offset, gboolean is_rfc4626)\r\n{\r\nunsigned int offset_in_bits = offset << 3;\r\nif(is_rfc4626){\r\nproto_tree_add_bits_item(tree, hf_h263_gbsc, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\n}else{\r\nproto_tree_add_bits_item(tree, hf_h263_gbsc, tvb, offset_in_bits, 17, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +17;\r\n}\r\nproto_tree_add_bits_item(tree, hf_h263_GN, tvb, offset_in_bits, 5, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +5;\r\nreturn offset_in_bits>>3;\r\n}\r\nint\r\ndissect_h263_picture_layer( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint offset, gint length _U_, gboolean is_rfc4626)\r\n{\r\nproto_tree *h263_opptype_tree = NULL;\r\nproto_item *opptype_item = NULL;\r\nunsigned int offset_in_bits = offset << 3;\r\nunsigned int saved_bit_offset;\r\nguint64 source_format;\r\nguint64 ufep;\r\nguint64 picture_coding_type;\r\nguint64 PB_frames_mode = 0;\r\nguint64 custom_pcf = 0;\r\nguint64 picture_type_code =0;\r\nguint64 cpm;\r\nguint64 pei;\r\nif(is_rfc4626){\r\nproto_tree_add_bits_item(tree, hf_h263_psc, tvb, offset_in_bits, 6, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +6;\r\n}else{\r\nproto_tree_add_bits_item(tree, hf_h263_psc, tvb, offset_in_bits, 22, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +22;\r\n}\r\nproto_tree_add_bits_item(tree, hf_h263_TR, tvb, offset_in_bits, 8, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +8;\r\noffset_in_bits = offset_in_bits +2;\r\nproto_tree_add_bits_item( tree, hf_h263_split_screen_indicator, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( tree, hf_h263_document_camera_indicator, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( tree, hf_h263_full_picture_freeze_release, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nproto_tree_add_bits_ret_val( tree, hf_h263_source_format, tvb, offset_in_bits, 3 ,&source_format, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +3;\r\nif (source_format != H263_PLUSPTYPE){\r\nproto_tree_add_bits_ret_val( tree, hf_h263_payload_picture_coding_type, tvb, offset_in_bits, 1, &picture_coding_type, ENC_BIG_ENDIAN);\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str((guint32)picture_coding_type, picture_coding_type_vals, "Unknown (%u)"));\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( tree, hf_h263_opt_unres_motion_vector_mode, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( tree, hf_h263_syntax_based_arithmetic_coding_mode, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( tree, hf_h263_optional_advanced_prediction_mode, tvb, offset_in_bits, 1, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nproto_tree_add_bits_ret_val( tree, hf_h263_PB_frames_mode, tvb, offset_in_bits, 1, &PB_frames_mode, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\n}else{\r\nproto_tree_add_bits_ret_val( tree, hf_h263_UFEP, tvb, offset_in_bits, 3, &ufep, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +3;\r\nif(ufep==1){\r\nopptype_item = proto_tree_add_bits_item( tree, hf_h263_opptype, tvb, offset_in_bits, 18, ENC_BIG_ENDIAN);\r\nh263_opptype_tree = proto_item_add_subtree( opptype_item, ett_h263_optype );\r\nproto_tree_add_bits_item( h263_opptype_tree, hf_h263_ext_source_format, tvb, offset_in_bits, 3, ENC_BIG_ENDIAN);\r\noffset_in_bits+=3;\r\nproto_tree_add_bits_ret_val( h263_opptype_tree, hf_h263_custom_pcf, tvb, offset_in_bits, 1, &custom_pcf, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nsaved_bit_offset=offset_in_bits;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( h263_opptype_tree, hf_h263_not_dissected, tvb, saved_bit_offset, offset_in_bits-saved_bit_offset, ENC_BIG_ENDIAN);\r\n}\r\nproto_tree_add_bits_ret_val( tree, hf_h263_picture_type_code, tvb, offset_in_bits, 3, &picture_type_code, ENC_BIG_ENDIAN);\r\noffset_in_bits+=3;\r\nsaved_bit_offset=offset_in_bits;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\noffset_in_bits++;\r\nproto_tree_add_bits_item( tree, hf_h263_not_dissected, tvb, saved_bit_offset, offset_in_bits-saved_bit_offset, ENC_BIG_ENDIAN);\r\nproto_tree_add_bits_ret_val( tree, hf_h263_cpm, tvb, offset_in_bits, 1, &cpm, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nif(cpm==1){\r\nproto_tree_add_bits_item( tree, hf_h263_psbi, tvb, offset_in_bits, 2, ENC_BIG_ENDIAN);\r\noffset_in_bits+=2;\r\n}\r\nreturn offset_in_bits>>3;\r\n}\r\nproto_tree_add_bits_item( tree, hf_h263_pquant, tvb, offset_in_bits, 5, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +5;\r\nif (source_format != H263_PLUSPTYPE){\r\nproto_tree_add_bits_ret_val( tree, hf_h263_cpm, tvb, offset_in_bits, 1, &cpm, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nif(cpm==1){\r\nproto_tree_add_bits_item( tree, hf_h263_psbi, tvb, offset_in_bits, 2, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +2;\r\n}\r\n}\r\nif((PB_frames_mode == 1)||(picture_type_code == 2 )){\r\nif(custom_pcf == 0){\r\nproto_tree_add_bits_item( tree, hf_h263_trb, tvb, offset_in_bits, 3, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +3;\r\n}else{\r\nproto_tree_add_bits_item( tree, hf_h263_trb, tvb, offset_in_bits, 5, ENC_BIG_ENDIAN);\r\noffset_in_bits = offset_in_bits +5;\r\n}\r\n}\r\nif((PB_frames_mode == 1)||(picture_type_code == 2 )){\r\noffset_in_bits = offset_in_bits +2;\r\n}\r\nproto_tree_add_bits_ret_val( tree, hf_h263_pei, tvb, offset_in_bits, 1, &pei, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\nwhile(pei==1)\r\n{\r\nproto_tree_add_bits_item( tree, hf_h263_psupp, tvb, offset_in_bits, 8, ENC_BIG_ENDIAN);\r\noffset_in_bits+=8;\r\nproto_tree_add_bits_ret_val( tree, hf_h263_pei, tvb, offset_in_bits, 1, &pei, ENC_BIG_ENDIAN);\r\noffset_in_bits++;\r\n}\r\nreturn offset_in_bits>>3;\r\n}\r\nstatic int dissect_h263_data( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* dissector_data _U_ )\r\n{\r\nguint offset = 0;\r\nproto_item *h263_payload_item = NULL;\r\nproto_tree *h263_payload_tree = NULL;\r\nguint32 data;\r\nguint8 startcode;\r\nint length;\r\ncol_append_str( pinfo->cinfo, COL_INFO, "H263 payload ");\r\nh263_payload_item = proto_tree_add_item( tree, proto_h263_data, tvb, offset, -1, ENC_NA );\r\nh263_payload_tree = proto_item_add_subtree( h263_payload_item, ett_h263_payload );\r\nlength = tvb_reported_length_remaining(tvb,0);\r\nif(length<4){\r\nif( tree )\r\nproto_tree_add_item( h263_payload_tree, hf_h263_data, tvb, offset, -1, ENC_NA );\r\nreturn tvb_captured_length(tvb);\r\n}\r\ndata = tvb_get_ntohl(tvb, offset);\r\nif (( data & 0xffff8000) == 0x00008000 ) {\r\nstartcode = tvb_get_guint8(tvb,offset+2)&0xfe;\r\nif (startcode & 0x80){\r\nswitch(startcode){\r\ncase 0xf8:\r\nbreak;\r\ncase 0x80:\r\ncase 0x82:\r\ncol_append_str( pinfo->cinfo, COL_INFO, "(PSC) ");\r\noffset = dissect_h263_picture_layer( tvb, pinfo, h263_payload_tree, offset, -1, ENC_NA);\r\nbreak;\r\ncase 0xfc:\r\ncase 0xfe:\r\ndefault:\r\ncol_append_str( pinfo->cinfo, COL_INFO, "(GBSC) ");\r\noffset = dissect_h263_group_of_blocks_layer( tvb, h263_payload_tree, offset,FALSE);\r\nbreak;\r\n}\r\n}else{\r\n}\r\n}\r\nif( tree )\r\nproto_tree_add_item( h263_payload_tree, hf_h263_data, tvb, offset, -1, ENC_NA );\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_h263_data(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_h263_psc,\r\n{\r\n"H.263 Picture start Code",\r\n"h263.psc",\r\nFT_UINT32,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\n"Picture start Code, PSC", HFILL\r\n}\r\n},\r\n{ &hf_h263_gbsc,\r\n{\r\n"H.263 Group of Block Start Code",\r\n"h263.gbsc",\r\nFT_UINT32,\r\nBASE_HEX,\r\nNULL,\r\n0x0,\r\n"Group of Block Start Code", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_TR,\r\n{\r\n"H.263 Temporal Reference",\r\n"h263.tr2",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Temporal Reference, TR", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_trb,\r\n{\r\n"Temporal Reference for B frames",\r\n"h263.trb",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Temporal Reference for the B frame as defined by H.263", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_split_screen_indicator,\r\n{\r\n"H.263 Split screen indicator",\r\n"h263.split_screen_indicator",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&on_off_flg),\r\n0x0,\r\n"Split screen indicator", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_document_camera_indicator,\r\n{\r\n"H.263 Document camera indicator",\r\n"h263.document_camera_indicator",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&on_off_flg),\r\n0x0,\r\n"Document camera indicator", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_full_picture_freeze_release,\r\n{\r\n"H.263 Full Picture Freeze Release",\r\n"h263.split_screen_indicator",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&on_off_flg),\r\n0x0,\r\n"Full Picture Freeze Release", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_source_format,\r\n{\r\n"H.263 Source Format",\r\n"h263.source_format",\r\nFT_UINT8,\r\nBASE_HEX,\r\nVALS(h263_srcformat_vals),\r\n0x0,\r\n"Source Format", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_ext_source_format,\r\n{\r\n"H.263 Source Format",\r\n"h263.ext_source_format",\r\nFT_UINT8,\r\nBASE_HEX,\r\nVALS(ext_srcformat_vals),\r\n0x0,\r\n"Source Format", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_UFEP,\r\n{\r\n"H.263 Update Full Extended PTYPE",\r\n"h263.ufep",\r\nFT_UINT16,\r\nBASE_DEC,\r\nVALS(h263_ufep_vals),\r\n0x0,\r\n"Update Full Extended PTYPE", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_opptype,\r\n{\r\n"H.263 Optional Part of PLUSPTYPE",\r\n"h263.opptype",\r\nFT_UINT24,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Optional Part of PLUSPTYPE", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_payload_picture_coding_type,\r\n{\r\n"H.263 Picture Coding Type",\r\n"h263.picture_coding_type",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&picture_coding_type_flg),\r\n0x0,\r\n"Picture Coding Type", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_opt_unres_motion_vector_mode,\r\n{\r\n"H.263 Optional Unrestricted Motion Vector mode",\r\n"h263.opt_unres_motion_vector_mode",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&on_off_flg),\r\n0x0,\r\n"Optional Unrestricted Motion Vector mode", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_syntax_based_arithmetic_coding_mode,\r\n{\r\n"H.263 Optional Syntax-based Arithmetic Coding mode",\r\n"h263.syntax_based_arithmetic_coding_mode",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&on_off_flg),\r\n0x0,\r\n"Optional Syntax-based Arithmetic Coding mode", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_optional_advanced_prediction_mode,\r\n{\r\n"H.263 Optional Advanced Prediction mode",\r\n"h263.optional_advanced_prediction_mode",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&on_off_flg),\r\n0x0,\r\n"Optional Advanced Prediction mode", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_PB_frames_mode,\r\n{\r\n"H.263 Optional PB-frames mode",\r\n"h263.PB_frames_mode",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&PB_frames_mode_flg),\r\n0x0,\r\n"Optional PB-frames mode", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_GN,\r\n{\r\n"H.263 Group Number",\r\n"h263.gn",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Group Number, GN", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_pquant,\r\n{\r\n"H.263 Quantizer Information (PQUANT)",\r\n"h263.pquant",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Quantizer Information (PQUANT)", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_cpm,\r\n{\r\n"H.263 Continuous Presence Multipoint and Video Multiplex (CPM)",\r\n"h263.cpm",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&cpm_flg),\r\n0x0,\r\n"Continuous Presence Multipoint and Video Multiplex (CPM)", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_psbi,\r\n{\r\n"H.263 Picture Sub-Bitstream Indicator (PSBI)",\r\n"h263.psbi",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Picture Sub-Bitstream Indicator (PSBI)", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_picture_type_code,\r\n{\r\n"H.263 Picture Type Code",\r\n"h263.psi",\r\nFT_UINT32,\r\nBASE_DEC,\r\nVALS(picture_type_code_vals),\r\n0x0,\r\n"Picture Type Code", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_custom_pcf,\r\n{\r\n"H.263 Custom PCF",\r\n"h263.custom_pcf",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nTFS(&custom_pcf_flg),\r\n0x0,\r\n"Custom PCF", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_pei,\r\n{\r\n"H.263 Extra Insertion Information (PEI)",\r\n"h263.pei",\r\nFT_BOOLEAN,\r\nBASE_NONE,\r\nNULL,\r\n0x0,\r\n"Extra Insertion Information (PEI)", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_psupp,\r\n{\r\n"H.263 Supplemental Enhancement Information (PSUPP)",\r\n"h263.psupp",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"Supplemental Enhancement Information (PSUPP)", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_data,\r\n{\r\n"H.263 stream",\r\n"h263.stream",\r\nFT_BYTES,\r\nBASE_NONE,\r\nNULL,\r\n0x0,\r\n"The H.263 stream including its Picture, GOB or Macro block start code.", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263_not_dissected,\r\n{\r\n"H.263 Bits currently not dissected",\r\n"h263.not_dis",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\n"These bits are not dissected(yet), displayed for clarity", HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_h263_payload,\r\n&ett_h263_optype,\r\n};\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_h263_data = proto_register_protocol("ITU-T Recommendation H.263",\r\n"H.263", "h263");\r\nproto_register_field_array(proto_h263_data, hf, array_length(hf));\r\nregister_dissector("h263data", dissect_h263_data, proto_h263_data);\r\n}

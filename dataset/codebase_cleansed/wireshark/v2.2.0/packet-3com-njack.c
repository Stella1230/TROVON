static int\r\ndissect_portsettings(tvbuff_t *tvb, proto_tree *port_tree, guint32 offset)\r\n{\r\nproto_tree_add_item(port_tree, hf_njack_tlv_data,\r\ntvb, offset, 8, ENC_NA);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_tlvs(tvbuff_t *tvb, proto_tree *njack_tree, guint32 offset)\r\n{\r\nguint8 tlv_type;\r\nguint8 tlv_length;\r\nproto_item *tlv_tree;\r\nfor (;;) {\r\ntlv_type = tvb_get_guint8(tvb, offset);\r\nif (tlv_type == NJACK_CMD_ENDOFPACKET) {\r\nproto_tree_add_item(njack_tree, hf_njack_tlv_type,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\n}\r\nif (tlv_type == NJACK_CMD_GETALLPARMAMS) {\r\nproto_tree_add_item(njack_tree, hf_njack_tlv_type,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncontinue;\r\n}\r\ntlv_length = tvb_get_guint8(tvb, offset + 1);\r\ntlv_tree = proto_tree_add_subtree_format(njack_tree, tvb,\r\noffset, tlv_length + 2, ett_njack_tlv_header, NULL,\r\n"T %02x, L %02x: %s",\r\ntlv_type,\r\ntlv_length,\r\nval_to_str_ext_const(tlv_type, &njack_cmd_vals_ext, "Unknown"));\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_type,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_length,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (tlv_type) {\r\ncase NJACK_CMD_STARTOFPARAMS:\r\nbreak;\r\ncase NJACK_CMD_COUNTERMODE:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_countermode,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_QUEUEING:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_scheduling,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_ADDTAGSCHEME:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_addtagscheme,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_REMOVETAG:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_portingressmode,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_MAXFRAMESIZE:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_maxframesize,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_ENABLESNMPWRITE:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_snmpwrite,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_POWERFORWARDING:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_powerforwarding,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_DHCPCONTROL:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_dhcpcontrol,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_CMD_MACADDRESS:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_devicemac,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nbreak;\r\ncase NJACK_CMD_VERSION:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_version,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase NJACK_CMD_IPADDRESS:\r\ncase NJACK_CMD_NETWORK:\r\ncase NJACK_CMD_MASK:\r\ncase NJACK_CMD_IPGATEWAY:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_typeip,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase NJACK_CMD_GROUP:\r\ncase NJACK_CMD_LOCATION:\r\ncase NJACK_CMD_PASSWORD:\r\ncase NJACK_CMD_ROCOMMUNITY:\r\ncase NJACK_CMD_RWCOMMUNITY:\r\ncase 0x25:\r\ncase NJACK_CMD_PRODUCTNAME:\r\ncase NJACK_CMD_SERIALNO:\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_typestring,\r\ntvb, offset, tlv_length, ENC_ASCII|ENC_NA);\r\noffset += tlv_length;\r\nbreak;\r\ncase NJACK_CMD_PORT1:\r\ncase NJACK_CMD_PORT2:\r\ncase NJACK_CMD_PORT3:\r\ncase NJACK_CMD_PORT4:\r\nif (tlv_length == 8) {\r\ndissect_portsettings(tvb, tlv_tree, offset);\r\n}\r\noffset += tlv_length;\r\nbreak;\r\ndefault:\r\nif (tlv_length != 0) {\r\nproto_tree_add_item(tlv_tree, hf_njack_tlv_data,\r\ntvb, offset, tlv_length, ENC_NA);\r\noffset += tlv_length;\r\n}\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_njack(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *njack_tree;\r\nguint32 offset = 0;\r\nguint8 packet_type;\r\nguint8 setresult;\r\ngint remaining;\r\npacket_type = tvb_get_guint8(tvb, 5);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PROTO_SHORT_NAME);\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str(packet_type, njack_type_vals, "Type 0x%02x"));\r\nti = proto_tree_add_item(tree, proto_njack, tvb, offset, -1,\r\nENC_NA);\r\nnjack_tree = proto_item_add_subtree(ti, ett_njack);\r\nproto_tree_add_item(njack_tree, hf_njack_magic, tvb, offset, 5,\r\nENC_ASCII|ENC_NA);\r\noffset += 5;\r\nproto_tree_add_item(njack_tree, hf_njack_type, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (packet_type) {\r\ncase NJACK_TYPE_SET:\r\nproto_tree_add_item(njack_tree, hf_njack_set_length, tvb, offset,\r\n2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(njack_tree, hf_njack_set_salt, tvb, offset,\r\n4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(njack_tree, hf_njack_set_authdata, tvb, offset,\r\n16, ENC_NA);\r\noffset += 16;\r\noffset = dissect_tlvs(tvb, njack_tree, offset);\r\nbreak;\r\ncase NJACK_TYPE_SETRESULT:\r\nsetresult = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(njack_tree, hf_njack_setresult, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s",\r\nval_to_str(setresult, njack_setresult_vals, "[0x%02x]"));\r\nbreak;\r\ncase NJACK_TYPE_GET:\r\noffset = dissect_tlvs(tvb, njack_tree, offset);\r\nbreak;\r\ncase NJACK_TYPE_QUERYRESP:\r\ncase NJACK_TYPE_GETRESP:\r\noffset = dissect_tlvs(tvb, njack_tree, offset);\r\nproto_tree_add_item(njack_tree, hf_njack_getresp_unknown1, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase NJACK_TYPE_DHCPINFO:\r\ndefault:\r\nremaining = tvb_reported_length_remaining(tvb, offset);\r\nif (remaining > 0) {\r\nproto_tree_add_item(njack_tree, hf_njack_tlv_data,\r\ntvb, offset, remaining, ENC_NA);\r\noffset += remaining;\r\n}\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ntest_njack(tvbuff_t *tvb)\r\n{\r\nif ( (tvb_captured_length(tvb) < 6) ||\r\n(tvb_strncaseeql(tvb, 0, "NJ200", 5) != 0) ) {\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\ndissect_njack_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif ( !test_njack(tvb) ) {\r\nreturn FALSE;\r\n}\r\ndissect_njack(tvb, pinfo, tree, NULL);\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_njack_static(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif ( !test_njack(tvb) ) {\r\nreturn 0;\r\n}\r\nreturn dissect_njack(tvb, pinfo, tree, NULL);\r\n}\r\nvoid\r\nproto_register_njack(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_njack_magic,\r\n{ "Magic", "njack.magic", FT_STRING, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_type,\r\n{ "Type", "njack.type", FT_UINT8, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_type,\r\n{ "TlvType", "njack.tlv.type", FT_UINT8, BASE_HEX | BASE_EXT_STRING, &njack_cmd_vals_ext,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_length,\r\n{ "TlvLength", "njack.tlv.length", FT_UINT8, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_data,\r\n{ "TlvData", "njack.tlv.data", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_version,\r\n{ "TlvFwVersion", "njack.tlv.version", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_snmpwrite,\r\n{ "TlvTypeSnmpwrite", "njack.tlv.snmpwrite", FT_UINT8, BASE_DEC, VALS(njack_snmpwrite),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_dhcpcontrol,\r\n{ "TlvTypeDhcpControl", "njack.tlv.dhcpcontrol", FT_UINT8, BASE_DEC, VALS(njack_dhcpcontrol),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_devicemac,\r\n{ "TlvTypeDeviceMAC", "njack.tlv.devicemac", FT_ETHER, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_typeip,\r\n{ "TlvTypeIP", "njack.tlv.typeip", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_typestring,\r\n{ "TlvTypeString", "njack.tlv.typestring", FT_STRING, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_scheduling,\r\n{ "TlvTypeScheduling", "njack.tlv.scheduling", FT_UINT8, BASE_DEC, VALS(njack_scheduling),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_addtagscheme,\r\n{ "TlvAddTagScheme", "njack.tlv.addtagscheme", FT_UINT8, BASE_DEC, VALS(njack_addtagscheme),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_portingressmode,\r\n{ "TlvTypePortingressmode", "njack.tlv.portingressmode", FT_UINT8, BASE_DEC, VALS(njack_portingressmode),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_maxframesize,\r\n{ "TlvTypeMaxframesize", "njack.tlv.maxframesize", FT_UINT8, BASE_DEC, VALS(njack_maxframesize),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_countermode,\r\n{ "TlvTypeCountermode", "njack.tlv.countermode", FT_UINT8, BASE_DEC, VALS(njack_countermode),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_tlv_powerforwarding,\r\n{ "TlvTypePowerforwarding", "njack.tlv.powerforwarding", FT_UINT8, BASE_DEC, VALS(njack_powerforwarding),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_set_length,\r\n{ "SetLength", "njack.set.length", FT_UINT16, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_set_salt,\r\n{ "Salt", "njack.set.salt", FT_UINT32, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_set_authdata,\r\n{ "Authdata", "njack.tlv.authdata", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_setresult,\r\n{ "SetResult", "njack.setresult", FT_UINT8, BASE_HEX, VALS(njack_setresult_vals),\r\n0x0, NULL, HFILL }},\r\n{ &hf_njack_getresp_unknown1,\r\n{ "Unknown1", "njack.getresp.unknown1", FT_UINT8, BASE_HEX, NULL,\r\n0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_njack,\r\n&ett_njack_tlv_header,\r\n};\r\nproto_njack = proto_register_protocol(PROTO_LONG_NAME, PROTO_SHORT_NAME, "njack");\r\nproto_register_field_array(proto_njack, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_njack(void)\r\n{\r\ndissector_handle_t njack_handle;\r\nnjack_handle = create_dissector_handle(dissect_njack_static, proto_njack);\r\ndissector_add_uint("udp.port", PORT_NJACK_PC, njack_handle);\r\ndissector_add_uint("udp.port", PORT_NJACK_SWITCH, njack_handle);\r\nheur_dissector_add("udp", dissect_njack_heur, "NJACK over UDP", "njack_udp", proto_njack, HEURISTIC_ENABLE);\r\nheur_dissector_add("tcp", dissect_njack_heur, "NJACK over TCP", "njack_tcp", proto_njack, HEURISTIC_DISABLE);\r\n}

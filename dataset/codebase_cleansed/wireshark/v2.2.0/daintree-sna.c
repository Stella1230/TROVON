wtap_open_return_val daintree_sna_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nchar readLine[DAINTREE_MAX_LINE_SIZE];\r\nif (file_gets(readLine, DAINTREE_MAX_LINE_SIZE, wth->fh)==NULL) {\r\n*err = file_error(wth->fh, err_info);\r\nif (*err != 0 && *err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (memcmp(readLine, daintree_magic_text, DAINTREE_MAGIC_TEXT_SIZE) != 0)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (file_gets(readLine, DAINTREE_MAX_LINE_SIZE, wth->fh)==NULL) {\r\n*err = file_error(wth->fh, err_info);\r\nif (*err != 0 && *err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (readLine[0] != COMMENT_LINE)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nwth->subtype_read = daintree_sna_read;\r\nwth->subtype_seek_read = daintree_sna_seek_read;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_DAINTREE_SNA;\r\nwth->file_encap = WTAP_ENCAP_IEEE802_15_4_NOFCS;\r\nwth->file_tsprec = WTAP_TSPREC_USEC;\r\nwth->snapshot_length = 0;\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic gboolean\r\ndaintree_sna_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\n*data_offset = file_tell(wth->fh);\r\nreturn daintree_sna_read_packet(wth->fh, &wth->phdr,\r\nwth->frame_buffer, err, err_info);\r\n}\r\nstatic gboolean\r\ndaintree_sna_seek_read(wtap *wth, gint64 seek_off, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nif(file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nreturn daintree_sna_read_packet(wth->random_fh, phdr, buf, err,\r\nerr_info);\r\n}\r\nstatic gboolean\r\ndaintree_sna_read_packet(FILE_T fh, struct wtap_pkthdr *phdr, Buffer *buf,\r\nint *err, gchar **err_info)\r\n{\r\nguint64 seconds;\r\nint useconds;\r\nchar readLine[DAINTREE_MAX_LINE_SIZE];\r\nchar readData[READDATA_BUF_SIZE];\r\nguchar *str = (guchar *)readData;\r\nguint bytes;\r\nguint8 *p;\r\ndo {\r\nif (file_gets(readLine, DAINTREE_MAX_LINE_SIZE, fh) == NULL) {\r\n*err = file_error(fh, err_info);\r\nreturn FALSE;\r\n}\r\n} while (readLine[0] == COMMENT_LINE);\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = WTAP_HAS_TS|WTAP_HAS_CAP_LEN;\r\nif (sscanf(readLine, "%*s %18" G_GINT64_MODIFIER "u.%9d %9u %" READDATA_MAX_FIELD_SIZE "s",\r\n&seconds, &useconds, &phdr->len, readData) != 4) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("daintree_sna: invalid read record");\r\nreturn FALSE;\r\n}\r\nif (phdr->len <= FCS_LENGTH) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("daintree_sna: packet length <= %u bytes, no frame data present",\r\nFCS_LENGTH);\r\nreturn FALSE;\r\n}\r\nphdr->len -= FCS_LENGTH;\r\nphdr->ts.secs = (time_t) seconds;\r\nphdr->ts.nsecs = useconds * 1000;\r\np = str;\r\nbytes = 0;\r\nwhile(*str) {\r\nif (!g_ascii_isxdigit(*str)) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("daintree_sna: non-hex digit in hex data");\r\nreturn FALSE;\r\n}\r\nif(g_ascii_isdigit(*str)) {\r\n*p = (*str - '0') << 4;\r\n} else {\r\n*p = ((g_ascii_tolower(*str) - 'a') + 10) << 4;\r\n}\r\nstr++;\r\nif (!g_ascii_isxdigit(*str)) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup("daintree_sna: non-hex digit in hex data");\r\nreturn FALSE;\r\n}\r\nif(g_ascii_isdigit(*str)) {\r\n*p += *str - '0';\r\n} else {\r\n*p += (g_ascii_tolower(*str) - 'a') + 10;\r\n}\r\nstr++;\r\np++;\r\nbytes++;\r\n}\r\nif (bytes <= FCS_LENGTH) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("daintree_sna: Only %u bytes of packet data",\r\nbytes);\r\nreturn FALSE;\r\n}\r\nbytes -= FCS_LENGTH;\r\nif (bytes > phdr->len) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("daintree_sna: capture length (%u) > packet length (%u)",\r\nbytes, phdr->len);\r\nreturn FALSE;\r\n}\r\nphdr->caplen = bytes;\r\nws_buffer_assure_space(buf, bytes);\r\nmemcpy(ws_buffer_start_ptr(buf), readData, bytes);\r\nreturn TRUE;\r\n}

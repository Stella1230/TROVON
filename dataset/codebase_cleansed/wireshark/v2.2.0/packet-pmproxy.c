static int is_ascii(const guchar *data, gint size)\r\n{\r\nconst unsigned char *str = data;\r\nconst unsigned char *end = str + size;\r\nfor (; str != end; str++) {\r\nif (*str & 0x80)\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int looks_like_proxy_exchange(tvbuff_t *tvb) {\r\ngint packet_length;\r\nconst guchar *packet_data;\r\npacket_length = tvb_ensure_captured_length_remaining(tvb, PMPROXY_START_OF_PACKET);\r\npacket_data = tvb_get_ptr(tvb, PMPROXY_START_OF_PACKET, packet_length);\r\nreturn is_ascii(packet_data, packet_length) && packet_data[packet_length-1] == '\n';\r\n}\r\nstatic int dissect_proxy_to_host(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree) {\r\nint offset = 0;\r\ngint next_offset;\r\ngint proxy_to_length;\r\ngchar *pmproxy_host_and_port_string;\r\ngchar **host_and_port;\r\ngchar *host;\r\ngchar *port;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Proxy");\r\nproxy_to_length = tvb_find_line_end(tvb, offset, tvb_ensure_captured_length_remaining(tvb, offset), &next_offset, FALSE);\r\nif(proxy_to_length != -1) {\r\npmproxy_host_and_port_string = (gchar *) tvb_get_string_enc(wmem_packet_scope(), tvb, offset, proxy_to_length, ENC_ASCII);\r\nhost_and_port = wmem_strsplit(wmem_packet_scope(), pmproxy_host_and_port_string, " ", -1);\r\nif(host_and_port != NULL) {\r\nhost = host_and_port[0];\r\nif (host) {\r\nproto_tree_add_string(tree, hf_pmproxy_host, tvb, offset, (guint32)strlen(host), host);\r\noffset += (int)strlen(host) + PMPROXY_HOST_AND_PORT_DELIMETER_LENGTH;\r\nport = host_and_port[1];\r\nif (port) {\r\nproto_tree_add_string(tree, hf_pmproxy_port, tvb, offset, (guint32)strlen(port), port);\r\n}\r\n} else {\r\nport = NULL;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Host=%s, Port=%s", host ? host : "", port ? port : "");\r\n}\r\n}\r\nreturn proxy_to_length;\r\n}\r\nstatic int is_banner_exchange_for(const gchar *type, tvbuff_t *tvb) {\r\ngchar *pmproxy_exchange_string;\r\nif(tvb_ensure_captured_length_remaining(tvb, PMPROXY_START_OF_PACKET) != PMPROXY_CLIENT_SERVER_VERSION_LENGTH) {\r\nreturn 0;\r\n}\r\npmproxy_exchange_string = (gchar *) tvb_get_string_enc(wmem_packet_scope(), tvb, PMPROXY_START_OF_PACKET,\r\nPMPROXY_CLIENT_SERVER_VERSION_LENGTH, ENC_ASCII);\r\nreturn g_strcmp0(pmproxy_exchange_string, g_strdup_printf("pmproxy-%s 1\n", type)) == 0;\r\n}\r\nstatic int is_server_exchange(tvbuff_t *tvb) {\r\nreturn is_banner_exchange_for("server", tvb);\r\n}\r\nstatic int is_client_exchange(tvbuff_t *tvb) {\r\nreturn is_banner_exchange_for("client", tvb);\r\n}\r\nstatic int dissect_server_exchange(tvbuff_t *tvb, packet_info *pinfo, proto_tree *pmproxy_tree) {\r\nint offset = PMPROXY_START_OF_PACKET;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Server exchange");\r\nproto_tree_add_item(pmproxy_tree, hf_pmproxy_server_version, tvb, offset, PMPROXY_CLIENT_SERVER_VERSION_LENGTH, ENC_ASCII|ENC_NA);\r\noffset += PMPROXY_CLIENT_SERVER_VERSION_LENGTH;\r\nreturn offset;\r\n}\r\nstatic int dissect_client_exchange(tvbuff_t *tvb, packet_info *pinfo, proto_tree *pmproxy_tree) {\r\nint offset = PMPROXY_START_OF_PACKET;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Client exchange");\r\nproto_tree_add_item(pmproxy_tree, hf_pmproxy_client_version, tvb, offset, PMPROXY_CLIENT_SERVER_VERSION_LENGTH, ENC_ASCII|ENC_NA);\r\noffset += PMPROXY_CLIENT_SERVER_VERSION_LENGTH;\r\nreturn offset;\r\n}\r\nstatic void mark_pmproxy_exchange_complete(packet_info *pinfo) {\r\nconversation_t *conversation;\r\npmproxy_conversation_info_t *pmproxy_conversation;\r\nconversation = find_or_create_conversation(pinfo);\r\npmproxy_conversation = (pmproxy_conversation_info_t *)conversation_get_proto_data(conversation, proto_pmproxy);\r\nif(pmproxy_conversation == NULL) {\r\npmproxy_conversation = wmem_new(wmem_file_scope(), pmproxy_conversation_info_t);\r\n}\r\npmproxy_conversation->last_proxy_frame = pinfo->num;\r\nconversation_add_proto_data(conversation, proto_pmproxy, pmproxy_conversation);\r\n}\r\nstatic int is_pmproxy_exchange_complete(packet_info *pinfo) {\r\nconversation_t *conversation;\r\npmproxy_conversation_info_t *pmproxy_conversation;\r\nconversation = find_or_create_conversation(pinfo);\r\npmproxy_conversation = (pmproxy_conversation_info_t *)conversation_get_proto_data(conversation, proto_pmproxy);\r\nif(pmproxy_conversation == NULL) {\r\nreturn FALSE;\r\n}\r\nreturn pinfo->num >= pmproxy_conversation->last_proxy_frame;\r\n}\r\nstatic int dissect_through_pcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree) {\r\npinfo->can_desegment = pinfo->saved_can_desegment;\r\nreturn call_dissector(pcp_handle, tvb, pinfo, tree);\r\n}\r\nstatic int dissect_pmproxy_exchange(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree) {\r\nproto_item *root_pmproxy_item;\r\nproto_tree *pmproxy_tree;\r\nroot_pmproxy_item = proto_tree_add_item(tree, proto_pmproxy, tvb, 0, -1, ENC_NA);\r\npmproxy_tree = proto_item_add_subtree(root_pmproxy_item, ett_pmproxy);\r\nif (is_server_exchange(tvb)) {\r\nreturn dissect_server_exchange(tvb, pinfo, pmproxy_tree);\r\n} else if (is_client_exchange(tvb)) {\r\nreturn dissect_client_exchange(tvb, pinfo, pmproxy_tree);\r\n} else if (looks_like_proxy_exchange(tvb)) {\r\nreturn dissect_proxy_to_host(tvb, pinfo, pmproxy_tree);\r\n} else {\r\nmark_pmproxy_exchange_complete(pinfo);\r\n}\r\nreturn tvb_reported_length_remaining(tvb, 0);\r\n}\r\nstatic int dissect_pmproxy(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PMPROXY");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif(is_pmproxy_exchange_complete(pinfo)) {\r\nreturn dissect_through_pcp(tvb, pinfo, tree);\r\n}\r\nelse {\r\nreturn dissect_pmproxy_exchange(tvb, pinfo, tree);\r\n}\r\n}\r\nvoid proto_register_pmproxy(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_pmproxy_host,\r\n{ "Host", "pmproxy.host",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_pmproxy_port,\r\n{ "Port", "pmproxy.port",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_pmproxy_client_version,\r\n{ "Client Version", "pmproxy.client_version",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_pmproxy_server_version,\r\n{ "Server Version", "pmproxy.server_version",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_pmproxy,\r\n};\r\nproto_pmproxy = proto_register_protocol("Performance Co-Pilot Proxy", "PMPROXY", "pmproxy");\r\nproto_register_field_array(proto_pmproxy, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_pmproxy(void) {\r\npmproxy_handle = create_dissector_handle(dissect_pmproxy, proto_pmproxy);\r\npcp_handle = find_dissector_add_dependency("pcp", proto_pmproxy);\r\ndissector_add_uint("tcp.port", PMPROXY_PORT, pmproxy_handle);\r\n}

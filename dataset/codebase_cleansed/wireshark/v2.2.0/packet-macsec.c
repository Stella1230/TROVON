static int dissect_macsec(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_) {\r\nunsigned sectag_length, data_length, icv_length = 16;\r\nunsigned sectag_offset = 0, data_offset, icv_offset;\r\nguint8 tci_an_field;\r\nproto_item *macsec_item, *tci_item;\r\nproto_tree *macsec_tree, *tci_tree;\r\ntvbuff_t *next_tvb;\r\ntci_an_field = tvb_get_guint8(tvb, 0);\r\nif ((tci_an_field & TCI_V_MASK) != 0) {\r\nreturn 0;\r\n}\r\nif (tci_an_field & TCI_SC_MASK) {\r\nsectag_length = 14;\r\n} else {\r\nsectag_length = 6;\r\n}\r\nif (tvb_captured_length(tvb) <= (sectag_length + icv_length)) {\r\nreturn 0;\r\n}\r\ndata_offset = sectag_length;\r\ndata_length = tvb_captured_length(tvb) - sectag_length - icv_length;\r\nicv_offset = data_length + data_offset;\r\nnext_tvb = tvb_new_subset_length(tvb, data_offset, data_length);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MACSEC");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "MACsec frame");\r\nif (tree) {\r\nmacsec_item = proto_tree_add_item(tree,\r\nproto_macsec, tvb, 0, sectag_length, ENC_NA);\r\nmacsec_tree = proto_item_add_subtree(macsec_item, ett_macsec);\r\ntci_item = proto_tree_add_uint_format(macsec_tree, hf_macsec_TCI, tvb,\r\nsectag_offset, 1, tci_an_field,\r\n"TCI=0x%02x: V=%d, ES=%d, SC=%d, SCB=%d, E=%d, C=%d, AN=%d",\r\ntci_an_field,\r\n((TCI_V_MASK & tci_an_field) ? 1:0),\r\n((TCI_ES_MASK & tci_an_field) ? 1:0),\r\n((TCI_SC_MASK & tci_an_field) ? 1:0),\r\n((TCI_SCB_MASK & tci_an_field) ? 1:0),\r\n((TCI_E_MASK & tci_an_field) ? 1:0),\r\n((TCI_C_MASK & tci_an_field) ? 1:0),\r\n(TCI_AN_MASK & tci_an_field));\r\ntci_tree = proto_item_add_subtree(tci_item, ett_macsec_tci);\r\nproto_tree_add_item(tci_tree, hf_macsec_TCI_V, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tci_tree, hf_macsec_TCI_ES, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tci_tree, hf_macsec_TCI_SC, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tci_tree, hf_macsec_TCI_SCB, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tci_tree, hf_macsec_TCI_E, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tci_tree, hf_macsec_TCI_C, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tci_tree, hf_macsec_AN, tvb, sectag_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(macsec_tree, hf_macsec_SL, tvb, sectag_offset + 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(macsec_tree, hf_macsec_PN, tvb, sectag_offset + 2, 4, ENC_BIG_ENDIAN);\r\nif (sectag_length == 14) {\r\nproto_tree_add_item(macsec_tree, hf_macsec_SCI_System_identifier,\r\ntvb, sectag_offset + 6, 6, ENC_NA);\r\nproto_tree_add_item(macsec_tree, hf_macsec_SCI_port_number, tvb,\r\nsectag_offset + 12, 2, ENC_BIG_ENDIAN);\r\n}\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\nproto_tree_add_item(macsec_tree, hf_macsec_ICV, tvb, icv_offset,\r\nicv_length, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_macsec(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_macsec_TCI, { "TAG Control Information", "macsec.TCI",FT_UINT8,\r\nBASE_HEX, NULL, 0xfc, NULL, HFILL} },\r\n{ &hf_macsec_TCI_V, { "VER", "macsec.TCI.V", FT_UINT8, BASE_HEX,\r\nNULL, 0x80, NULL, HFILL} },\r\n{ &hf_macsec_TCI_ES, { "ES", "macsec.TCI.ES", FT_UINT8, BASE_HEX, NULL,\r\n0x40, NULL, HFILL} },\r\n{ &hf_macsec_TCI_SC, { "SC", "macsec.TCI.SC", FT_UINT8, BASE_HEX, NULL,\r\n0x20, NULL, HFILL} },\r\n{ &hf_macsec_TCI_SCB, { "SCB", "macsec.TCI.SCB", FT_UINT8, BASE_HEX,\r\nNULL, 0x10, NULL, HFILL} },\r\n{ &hf_macsec_TCI_E, { "E", "macsec.TCI.E", FT_UINT8, BASE_HEX, NULL,\r\n0x08, NULL, HFILL} },\r\n{ &hf_macsec_TCI_C, { "C", "macsec.TCI.C", FT_UINT8, BASE_HEX, NULL,\r\n0x04, NULL, HFILL} },\r\n{ &hf_macsec_AN, { "AN", "macsec.AN", FT_UINT8,\r\nBASE_HEX, NULL, 0x03, NULL, HFILL} },\r\n{ &hf_macsec_SL, { "Short length", "macsec.SL", FT_UINT8, BASE_DEC,\r\nNULL, 0xFF, NULL, HFILL} },\r\n{ &hf_macsec_PN, { "Packet number", "macsec.PN", FT_UINT32, BASE_DEC,\r\nNULL, 0xFFFFFFFF, NULL, HFILL} },\r\n{ &hf_macsec_SCI_System_identifier,\r\n{ "System Identifier", "macsec.SCI.SytemIdentifier",\r\nFT_ETHER, BASE_NONE, NULL, 0x00, NULL, HFILL} },\r\n{ &hf_macsec_SCI_port_number,\r\n{ "Port number", "macsec.SCI.port_number",\r\nFT_UINT16, BASE_DEC, NULL, 0xFFFF, NULL, HFILL} },\r\n{ &hf_macsec_ICV, { "ICV", "macsec.ICV",\r\nFT_BYTES, BASE_NONE, NULL, 0x00, NULL, HFILL} }\r\n};\r\nstatic gint *ett[] = {\r\n&ett_macsec,\r\n&ett_macsec_tci\r\n};\r\nproto_macsec = proto_register_protocol("802.1AE Secure tag", "macsec", "macsec");\r\nproto_register_field_array(proto_macsec, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_macsec(void)\r\n{\r\ndissector_handle_t macsec_handle;\r\nmacsec_handle = create_dissector_handle(dissect_macsec, proto_macsec);\r\ndissector_add_uint("ethertype", ETHERTYPE_MACSEC, macsec_handle);\r\n}

static struct gadu_gadu_conv_data *\r\ngadu_gadu_create_conversation(packet_info *pinfo, guint32 uin)\r\n{\r\nconversation_t *conv;\r\nstruct gadu_gadu_conv_data *gg_conv;\r\nconv = find_or_create_conversation(pinfo);\r\ngg_conv = (struct gadu_gadu_conv_data *)conversation_get_proto_data(conv, hfi_gadu_gadu->id);\r\nif (!gg_conv) {\r\ngg_conv = wmem_new(wmem_file_scope(), struct gadu_gadu_conv_data);\r\ngg_conv->uin = uin;\r\nconversation_add_proto_data(conv, hfi_gadu_gadu->id, gg_conv);\r\n}\r\nreturn gg_conv;\r\n}\r\nstatic struct gadu_gadu_conv_data *\r\ngadu_gadu_get_conversation_data(packet_info *pinfo)\r\n{\r\nconversation_t *conv;\r\nconv = find_conversation(pinfo->num, &pinfo->src, &pinfo->dst, pinfo->ptype, pinfo->srcport, pinfo->destport, 0);\r\nif (conv)\r\nreturn (struct gadu_gadu_conv_data *)conversation_get_proto_data(conv, hfi_gadu_gadu->id);\r\nreturn NULL;\r\n}\r\nstatic gboolean\r\ngadu_gadu_status_has_descr(int status)\r\n{\r\nreturn\r\n(status == GG_STATUS_NOT_AVAIL_DESCR) ||\r\n(status == GG_STATUS_FFC_DESCR) ||\r\n(status == GG_STATUS_AVAIL_DESCR) ||\r\n(status == GG_STATUS_BUSY_DESCR) ||\r\n(status == GG_STATUS_DND_DESCR) ||\r\n(status == GG_STATUS_INVISIBLE_DESCR);\r\n}\r\nstatic int\r\ngadu_gadu_strsize(tvbuff_t *tvb, const gint abs_offset)\r\n{\r\nint nul_offset;\r\nnul_offset = tvb_find_guint8(tvb, abs_offset, -1, 0);\r\nif (nul_offset == -1)\r\nnul_offset = tvb_captured_length(tvb) - 1;\r\nreturn (nul_offset - abs_offset) + 1;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_stringz_cp1250(tvbuff_t *tvb, header_field_info *hfi, proto_tree *tree, const int offset)\r\n{\r\nint len = gadu_gadu_strsize(tvb, offset);\r\nproto_tree_add_item(tree, hfi, tvb, offset, len, ENC_WINDOWS_1250 | ENC_NA);\r\nreturn offset + len;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_uint32_string_utf8(tvbuff_t *tvb, header_field_info *hfi, proto_tree *tree, int offset)\r\n{\r\nconst int org_offset = offset;\r\nguint32 len;\r\nlen = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\noffset += len;\r\nproto_tree_add_item(tree, hfi, tvb, org_offset, offset - org_offset, ENC_UTF_8 | ENC_NA);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_disconnecting(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Disconnecting");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_disconnect_ack(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Disconnect acknowledge (< 10.0)");\r\nreturn offset;\r\n}\r\nstatic void *\r\n_tvb_memcpy_reverse(tvbuff_t *tvb, void *target, gint offset, size_t length)\r\n{\r\nguint8 *t = (guint8 *) target;\r\nwhile (length > 0) {\r\nlength--;\r\nt[length] = tvb_get_guint8(tvb, offset);\r\noffset++;\r\n}\r\nreturn target;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login_protocol(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nproto_item *ti;\r\nguint32 protocol;\r\nprotocol = tvb_get_letohl(tvb, offset) & 0xff;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_protocol, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nti = proto_tree_add_string(tree, &hfi_gadu_gadu_login_version, tvb, offset, 4, val_to_str(protocol, gadu_gadu_version_vals, "Unknown (0x%x)"));\r\nPROTO_ITEM_SET_GENERATED(ti);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nproto_item *ti;\r\nguint32 uin;\r\nguint8 hash[4];\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login request (< 6.0)");\r\nuin = tvb_get_letohl(tvb, offset);\r\ngadu_gadu_create_conversation(pinfo, uin);\r\nproto_tree_add_uint(tree, &hfi_gadu_gadu_login_uin, tvb, offset, 4, uin);\r\noffset += 4;\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_login_hash_type, tvb, 0, 0, GG_LOGIN_HASH_GG32);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n_tvb_memcpy_reverse(tvb, hash, offset, 4);\r\nproto_tree_add_bytes_format_value(tree, hfi_gadu_gadu_login_hash.id, tvb, offset, 4, hash, "0x%.8x", tvb_get_letohl(tvb, offset));\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_login_protocol(tvb, tree, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_local_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_local_port, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login_hash(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nguint8 hash_type;\r\nguint8 hash[4];\r\nint i;\r\nhash_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_hash_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nswitch (hash_type) {\r\ncase GG_LOGIN_HASH_GG32:\r\n_tvb_memcpy_reverse(tvb, hash, offset, 4);\r\nproto_tree_add_bytes_format_value(tree, hfi_gadu_gadu_login_hash.id, tvb, offset, 4, hash, "0x%.8x", tvb_get_letohl(tvb, offset));\r\nfor (i = 4; i < 64; i++) {\r\nif (tvb_get_guint8(tvb, offset+i)) {\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset + 4, 64-4, ENC_NA);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase GG_LOGIN_HASH_SHA1:\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_hash, tvb, offset, 20, ENC_NA);\r\nfor (i = 20; i < 64; i++) {\r\nif (tvb_get_guint8(tvb, offset+i)) {\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset + 20, 64-20, ENC_NA);\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 64, ENC_NA);\r\nbreak;\r\n}\r\noffset += 64;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login70(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 uin;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login request (7.0)");\r\nuin = tvb_get_letohl(tvb, offset) & ~(GG_ERA_OMNIX_MASK | GG_HAS_AUDIO_MASK);\r\ngadu_gadu_create_conversation(pinfo, uin);\r\nproto_tree_add_uint(tree, &hfi_gadu_gadu_login_uin, tvb, offset, 4, uin);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_login_hash(tvb, tree, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_login_protocol(tvb, tree, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_local_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_local_port, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 uin;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login request (8.0)");\r\nuin = tvb_get_letohl(tvb, offset);\r\ngadu_gadu_create_conversation(pinfo, uin);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login80_lang, tvb, offset, 2, ENC_ASCII | ENC_NA);\r\noffset += 2;\r\noffset = dissect_gadu_gadu_login_hash(tvb, tree, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_login_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login_ok(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login success (< 8.0)");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login_failed(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login fail (< 8.0)");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login_ok80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login success (8.0)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_login80_failed(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Login fail (8.0)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_user_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 users_num;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Contact details");\r\noffset += 4;\r\nusers_num = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nwhile (users_num--) {\r\nguint32 attr_num;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userdata_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nattr_num = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nwhile (attr_num--) {\r\nguint32 name_size, val_size;\r\nchar *name, *val;\r\nname_size = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nname = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, name_size, ENC_ASCII | ENC_NA);\r\nproto_tree_add_string(tree, &hfi_gadu_gadu_userdata_attr_name, tvb, offset - 4, 4 + name_size, name);\r\noffset += name_size;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userdata_attr_type, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nval_size = tvb_get_letohl(tvb, offset);\r\noffset += 4;\r\nval = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, val_size, ENC_ASCII | ENC_NA);\r\nproto_tree_add_string(tree, &hfi_gadu_gadu_userdata_attr_value, tvb, offset - 4, 4 + val_size, val);\r\noffset += val_size;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_typing_notify(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Typing notify");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_typing_notify_type, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_typing_notify_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_msg_attr(tvbuff_t *tvb _U_, proto_tree *tree _U_, int offset)\r\n{\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_recv_msg(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nstruct gadu_gadu_conv_data *conv;\r\nproto_item *ti;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Receive message (< 8.0)");\r\nif ((conv = gadu_gadu_get_conversation_data(pinfo))) {\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_recipient, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_uin, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\n}\r\nti = proto_tree_add_item(tree, &hfi_gadu_gadu_msg_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_sender, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_time, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_class, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_stringz_cp1250(tvb, &hfi_gadu_gadu_msg_text, tree, offset);\r\noffset = dissect_gadu_gadu_msg_attr(tvb, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_send_msg(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nstruct gadu_gadu_conv_data *conv;\r\nproto_item *ti;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Send message (< 8.0)");\r\nti = proto_tree_add_item(tree, &hfi_gadu_gadu_msg_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_recipient, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nif ((conv = gadu_gadu_get_conversation_data(pinfo))) {\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_sender, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_uin, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\n}\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nti = proto_tree_add_time(tree, &hfi_gadu_gadu_msg_time, tvb, 0, 0, &(pinfo->abs_ts));\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_class, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_stringz_cp1250(tvb, &hfi_gadu_gadu_msg_text, tree, offset);\r\noffset = dissect_gadu_gadu_msg_attr(tvb, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_recv_msg80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nstruct gadu_gadu_conv_data *conv;\r\nproto_item *ti;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Receive message (8.0)");\r\nif ((conv = gadu_gadu_get_conversation_data(pinfo))) {\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_recipient, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_uin, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\n}\r\nti = proto_tree_add_item(tree, &hfi_gadu_gadu_msg_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_sender, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_time, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_class, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg80_offset_plain, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg80_offset_attr, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_send_msg80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nstruct gadu_gadu_conv_data *conv;\r\nproto_item *ti;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Send message (8.0)");\r\nti = proto_tree_add_item(tree, &hfi_gadu_gadu_msg_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_recipient, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nif ((conv = gadu_gadu_get_conversation_data(pinfo))) {\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_sender, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_msg_uin, tvb, 0, 0, conv->uin);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\n}\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nti = proto_tree_add_time(tree, &hfi_gadu_gadu_msg_time, tvb, 0, 0, &(pinfo->abs_ts));\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_class, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg80_offset_plain, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg80_offset_attr, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_send_msg_ack(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Message acknowledge (server)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_ack_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_ack_recipient, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_ack_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_recv_msg_ack(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Message acknowledge (client)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_msg_ack_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_status60(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 uin;\r\nguint8 status;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Receive status (6.0)");\r\nuin = tvb_get_letohl(tvb, offset) & ~(GG_ERA_OMNIX_MASK | GG_HAS_AUDIO_MASK);\r\nproto_tree_add_uint(tree, &hfi_gadu_gadu_status_uin, tvb, offset, 4, uin);\r\noffset += 4;\r\nstatus = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_status, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_port, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_version, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_img_size, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nif (gadu_gadu_status_has_descr(status))\r\noffset = dissect_gadu_gadu_stringz_cp1250(tvb, &hfi_gadu_gadu_status_descr, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_status77(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 uin;\r\nguint8 status;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Receive status (7.7)");\r\nuin = tvb_get_letohl(tvb, offset) & ~(GG_ERA_OMNIX_MASK | GG_HAS_AUDIO_MASK);\r\nproto_tree_add_uint(tree, &hfi_gadu_gadu_status_uin, tvb, offset, 4, uin);\r\noffset += 4;\r\nstatus = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_status, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_port, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_version, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_img_size, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\nif (gadu_gadu_status_has_descr(status))\r\noffset = dissect_gadu_gadu_stringz_cp1250(tvb, &hfi_gadu_gadu_status_descr, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_status80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Receive status (8.0)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_ip, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_port, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_status_img_size, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_uint32_string_utf8(tvb, &hfi_gadu_gadu_status_descr, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_notify_reply80(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Receive status list (8.0)");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_new_status(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint32 status;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "New status (< 8.0)");\r\nstatus = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_new_status_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nif (gadu_gadu_status_has_descr(status & 0xff))\r\noffset = dissect_gadu_gadu_stringz_cp1250(tvb, &hfi_gadu_gadu_status_descr, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_new_status80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "New status (8.0)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_new_status_status, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 4, ENC_NA);\r\noffset += 4;\r\noffset = dissect_gadu_gadu_uint32_string_utf8(tvb, &hfi_gadu_gadu_new_status_desc, tree, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_list_empty(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list (empty)");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_add_notify(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list add");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_contact_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_contact_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_notify105_common(tvbuff_t *tvb, proto_tree *tree, int offset, char **puin)\r\n{\r\nguint16 uin_len;\r\nchar *uin;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nuin_len = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nuin = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, uin_len, ENC_ASCII | ENC_NA);\r\nproto_tree_add_string(tree, &hfi_gadu_gadu_contact_uin_str, tvb, offset - 1, 1 + uin_len, uin);\r\noffset += uin_len;\r\nif (puin)\r\n*puin = uin;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_contact_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_add_notify105(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list add (10.5)");\r\nreturn dissect_gadu_gadu_notify105_common(tvb, tree, offset, NULL);\r\n}\r\nstatic int\r\ndissect_gadu_gadu_remove_notify(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list remove");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_contact_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_contact_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_remove_notify105(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list remove (10.5)");\r\nreturn dissect_gadu_gadu_notify105_common(tvb, tree, offset, NULL);\r\n}\r\nstatic int\r\ndissect_gadu_gadu_notify_common(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, int offset)\r\n{\r\nproto_tree *contact_tree;\r\nwhile (tvb_reported_length_remaining(tvb, offset) >= 4+1) {\r\nguint32 uin = tvb_get_letohl(tvb, offset);\r\ncontact_tree = proto_tree_add_subtree_format(tree, tvb, offset, 5,\r\nett_gadu_gadu_contact, NULL, "Contact: %u", uin);\r\nproto_tree_add_item(contact_tree, &hfi_gadu_gadu_contact_uin, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(contact_tree, &hfi_gadu_gadu_contact_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_notify_first(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list");\r\nreturn dissect_gadu_gadu_notify_common(tvb, pinfo, tree, offset);\r\n}\r\nstatic int\r\ndissect_gadu_gadu_notify_last(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list (last)");\r\nreturn dissect_gadu_gadu_notify_common(tvb, pinfo, tree, offset);\r\n}\r\nstatic int\r\ndissect_gadu_gadu_notify105(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Notify list (10.5)");\r\nwhile (tvb_reported_length_remaining(tvb, offset) >= 2) {\r\nconst int org_offset = offset;\r\nproto_tree *contact_tree;\r\nproto_item *ti;\r\nchar *uin;\r\ncontact_tree = proto_tree_add_subtree(tree, tvb, offset, 0, ett_gadu_gadu_contact, &ti, "Contact: ");\r\noffset = dissect_gadu_gadu_notify105_common(tvb, contact_tree, offset, &uin);\r\nproto_item_append_text(ti, "%s", uin);\r\nproto_item_set_len(ti, offset - org_offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_ping(tvbuff_t *tvb _U_, packet_info *pinfo, proto_tree *tree _U_, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Ping");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_welcome(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Welcome");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_welcome_seed, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_userlist_xml_compressed(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nint remain = tvb_reported_length_remaining(tvb, offset);\r\ntvbuff_t *uncomp_tvb;\r\nif (remain <= 0)\r\nreturn offset;\r\nif ((uncomp_tvb = tvb_child_uncompress(tvb, tvb, offset, remain))) {\r\nproto_tree_add_bytes_format_value(tree, hfi_gadu_gadu_userlist.id, tvb, offset, remain, NULL, "[Decompression succeeded]");\r\nadd_new_data_source(pinfo, uncomp_tvb, "Uncompressed userlist");\r\ncall_dissector_only(xml_handle, uncomp_tvb, pinfo, tree, NULL);\r\n} else\r\nproto_tree_add_bytes_format_value(tree, hfi_gadu_gadu_userlist.id, tvb, offset, remain, NULL, "[Error: Decompression failed] (or no zlib)");\r\noffset += remain;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_userlist_request80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint8 type;\r\nproto_item *ti;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Userlist request (8.0)");\r\ntype = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_request_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nti = proto_tree_add_uint(tree, &hfi_gadu_gadu_userlist_format, tvb, 0, 0, GG_USERLIST100_FORMAT_TYPE_GG100);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nswitch (type) {\r\ncase GG_USERLIST_PUT:\r\noffset = dissect_gadu_gadu_userlist_xml_compressed(tvb, pinfo, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_userlist_request100(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint8 type, format;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Userlist request (10.0)");\r\ntype = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_request_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nformat = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_format, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nswitch (type) {\r\ncase GG_USERLIST_PUT:\r\nif (format == GG_USERLIST100_FORMAT_TYPE_GG100)\r\noffset = dissect_gadu_gadu_userlist_xml_compressed(tvb, pinfo, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_userlist_reply80(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint8 type;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Userlist reply (8.0)");\r\ntype = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_reply_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nswitch (type) {\r\ncase GG_USERLIST_GET_REPLY:\r\noffset = dissect_gadu_gadu_userlist_xml_compressed(tvb, pinfo, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_userlist_reply100(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nguint8 type, format;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Userlist reply (10.0)");\r\ntype = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_reply_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nformat = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_format, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_data, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nswitch (type) {\r\ncase GG_USERLIST_GET_REPLY:\r\nif (format == GG_USERLIST100_FORMAT_TYPE_GG100)\r\noffset = dissect_gadu_gadu_userlist_xml_compressed(tvb, pinfo, tree, offset);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_userlist_version100(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Userlist version (10.0)");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_userlist_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_dcc7_id_request(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Direct connection id request");\r\nproto_tree_add_item(tree, &hfi_dcc_type, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_dcc7_id_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Direct connection id reply");\r\nproto_tree_add_item(tree, &hfi_dcc_type, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_dcc_id, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_dcc7_new(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Direct connection new");\r\nproto_tree_add_item(tree, &hfi_dcc_id, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nproto_tree_add_item(tree, &hfi_dcc_uin_from, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_dcc_uin_to, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_dcc_type, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_dcc_filename, tvb, offset, 255, ENC_ASCII | ENC_NA);\r\noffset += 255;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_dcc7_id_abort(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Direct connection abort");\r\nproto_tree_add_item(tree, &hfi_dcc_id, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nproto_tree_add_item(tree, &hfi_dcc_uin_from, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, &hfi_dcc_uin_to, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_pubdir50_request(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nint pos;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Public directory request");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_pubdir_request_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_pubdir_request_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nwhile ((pos = tvb_find_guint8(tvb, offset, -1, '\0')) > 0) {\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_pubdir_request_str, tvb, offset, (pos - offset) + 1, ENC_NA | ENC_WINDOWS_1250);\r\noffset = pos + 1;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_pubdir50_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\nint pos;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Public directory reply");\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_pubdir_reply_type, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_pubdir_reply_seq, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nwhile ((pos = tvb_find_guint8(tvb, offset, -1, '\0')) > 0) {\r\nproto_tree_add_item(tree, &hfi_gadu_gadu_pubdir_reply_str, tvb, offset, (pos - offset) + 1, ENC_NA | ENC_WINDOWS_1250);\r\noffset = pos + 1;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_xml_action(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int offset)\r\n{\r\ntvbuff_t *xml_tvb;\r\nint ret;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "XML action message");\r\nxml_tvb = tvb_new_subset_remaining(tvb, offset);\r\nret = call_dissector_only(xml_handle, xml_tvb, pinfo, tree, NULL);\r\nreturn offset + ret;\r\n}\r\nstatic int\r\ndissect_gadu_gadu_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *gadu_gadu_tree = NULL;\r\nint offset = 0;\r\nguint32 pkt_type;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *ti = proto_tree_add_item(tree, hfi_gadu_gadu, tvb, 0, -1, ENC_NA);\r\ngadu_gadu_tree = proto_item_add_subtree(ti, ett_gadu_gadu);\r\n}\r\npkt_type = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_item(gadu_gadu_tree, (pinfo->p2p_dir == P2P_DIR_RECV) ? &hfi_gadu_gadu_header_type_recv : &hfi_gadu_gadu_header_type_send, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(gadu_gadu_tree, &hfi_gadu_gadu_header_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nif (pinfo->p2p_dir == P2P_DIR_RECV) {\r\nswitch (pkt_type) {\r\ncase GG_DISCONNECTING:\r\noffset = dissect_gadu_gadu_disconnecting(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_DISCONNECT_ACK:\r\noffset = dissect_gadu_gadu_disconnect_ack(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LOGIN_OK:\r\noffset = dissect_gadu_gadu_login_ok(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LOGIN_OK80:\r\noffset = dissect_gadu_gadu_login_ok80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LOGIN_FAILED:\r\noffset = dissect_gadu_gadu_login_failed(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LOGIN80_FAILED:\r\noffset = dissect_gadu_gadu_login80_failed(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_USER_DATA:\r\noffset = dissect_gadu_gadu_user_data(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_TYPING_NOTIFY:\r\noffset = dissect_gadu_gadu_typing_notify(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_RECV_MSG:\r\noffset = dissect_gadu_gadu_recv_msg(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_RECV_MSG80:\r\noffset = dissect_gadu_gadu_recv_msg80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_SEND_MSG_ACK:\r\noffset = dissect_gadu_gadu_send_msg_ack(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_STATUS60:\r\noffset = dissect_gadu_gadu_status60(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_STATUS77:\r\noffset = dissect_gadu_gadu_status77(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_STATUS80:\r\noffset = dissect_gadu_gadu_status80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_NOTIFY_REPLY80:\r\noffset = dissect_gadu_gadu_notify_reply80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_DCC7_ID_REPLY:\r\noffset = dissect_gadu_gadu_dcc7_id_reply(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_WELCOME:\r\noffset = dissect_gadu_gadu_welcome(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_USERLIST_REPLY80:\r\noffset = dissect_gadu_gadu_userlist_reply80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_USERLIST100_REPLY:\r\noffset = dissect_gadu_gadu_userlist_reply100(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_USERLIST100_VERSION:\r\noffset = dissect_gadu_gadu_userlist_version100(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_PUBDIR50_REPLY:\r\noffset = dissect_gadu_gadu_pubdir50_reply(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_XML_ACTION:\r\noffset = dissect_gadu_gadu_xml_action(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_STATUS:\r\ncase GG_PONG:\r\ncase GG_PING:\r\ncase GG_NOTIFY_REPLY:\r\ncase GG_USERLIST_REPLY:\r\ncase GG_NOTIFY_REPLY60:\r\ncase GG_NEED_EMAIL:\r\ncase GG_LOGIN_HASH_TYPE_INVALID:\r\ncase GG_NOTIFY_REPLY77:\r\ncase GG_DCC7_INFO:\r\ncase GG_DCC7_NEW:\r\ncase GG_DCC7_ACCEPT:\r\ncase GG_DCC7_REJECT:\r\ncase GG_DCC7_ID_ABORTED:\r\ncase GG_XML_EVENT:\r\ncase GG_STATUS80BETA:\r\ncase GG_NOTIFY_REPLY80BETA:\r\ncase GG_OWN_MESSAGE:\r\ncase GG_OWN_RESOURCE_INFO:\r\ndefault:\r\n{\r\nconst char *pkt_name = try_val_to_str(pkt_type, gadu_gadu_packets_type_recv);\r\nif (pkt_name)\r\ncol_set_str(pinfo->cinfo, COL_INFO, pkt_name);\r\nelse\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unknown recv packet: %.2x", pkt_type);\r\nbreak;\r\n}\r\n}\r\n} else {\r\nswitch (pkt_type) {\r\ncase GG_LOGIN:\r\noffset = dissect_gadu_gadu_login(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LOGIN70:\r\noffset = dissect_gadu_gadu_login70(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LOGIN80:\r\noffset = dissect_gadu_gadu_login80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_LIST_EMPTY:\r\noffset = dissect_gadu_gadu_list_empty(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_NOTIFY_FIRST:\r\noffset = dissect_gadu_gadu_notify_first(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_NOTIFY_LAST:\r\noffset = dissect_gadu_gadu_notify_last(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_NOTIFY105:\r\noffset = dissect_gadu_gadu_notify105(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_ADD_NOTIFY:\r\noffset = dissect_gadu_gadu_add_notify(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_ADD_NOTIFY105:\r\noffset = dissect_gadu_gadu_add_notify105(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_REMOVE_NOTIFY:\r\noffset = dissect_gadu_gadu_remove_notify(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_REMOVE_NOTIFY105:\r\noffset = dissect_gadu_gadu_remove_notify105(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_PING:\r\noffset = dissect_gadu_gadu_ping(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_TYPING_NOTIFY:\r\noffset = dissect_gadu_gadu_typing_notify(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_SEND_MSG:\r\noffset = dissect_gadu_gadu_send_msg(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_SEND_MSG80:\r\noffset = dissect_gadu_gadu_send_msg80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_RECV_MSG_ACK:\r\noffset = dissect_gadu_gadu_recv_msg_ack(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_NEW_STATUS:\r\noffset = dissect_gadu_gadu_new_status(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_NEW_STATUS80:\r\noffset = dissect_gadu_gadu_new_status80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_DCC7_ID_REQUEST:\r\noffset = dissect_gadu_gadu_dcc7_id_request(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_DCC7_NEW:\r\noffset = dissect_gadu_gadu_dcc7_new(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_DCC7_ID_ABORT:\r\noffset = dissect_gadu_gadu_dcc7_id_abort(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_USERLIST_REQUEST80:\r\noffset = dissect_gadu_gadu_userlist_request80(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_USERLIST100_REQUEST:\r\noffset = dissect_gadu_gadu_userlist_request100(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_PUBDIR50_REQUEST:\r\noffset = dissect_gadu_gadu_pubdir50_request(tvb, pinfo, gadu_gadu_tree, offset);\r\nbreak;\r\ncase GG_PONG:\r\ncase GG_LOGIN_EXT:\r\ncase GG_LOGIN60:\r\ncase GG_USERLIST_REQUEST:\r\ncase GG_DCC7_INFO:\r\ncase GG_DCC7_ACCEPT:\r\ncase GG_DCC7_REJECT:\r\ncase GG_DCC7_ID_DUNNO1:\r\ncase GG_NEW_STATUS80BETA:\r\ncase GG_LOGIN80BETA:\r\ncase GG_OWN_DISCONNECT:\r\ncase GG_NEW_STATUS105:\r\ncase GG_LOGIN105:\r\ndefault:\r\n{\r\nconst char *pkt_name = try_val_to_str(pkt_type, gadu_gadu_packets_type_send);\r\nif (pkt_name)\r\ncol_set_str(pinfo->cinfo, COL_INFO, pkt_name);\r\nelse\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unknown send packet: %.2x", pkt_type);\r\nbreak;\r\n}\r\n}\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_item(gadu_gadu_tree, &hfi_gadu_gadu_data, tvb, offset, -1, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_gadu_gadu_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint32 len = tvb_get_letohl(tvb, offset + 4);\r\nreturn len + 8;\r\n}\r\nstatic int\r\ndissect_gadu_gadu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nif (pinfo->srcport == pinfo->match_uint && pinfo->destport != pinfo->match_uint)\r\npinfo->p2p_dir = P2P_DIR_RECV;\r\nelse if (pinfo->srcport != pinfo->match_uint && pinfo->destport == pinfo->match_uint)\r\npinfo->p2p_dir = P2P_DIR_SENT;\r\nelse\r\nreturn 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Gadu-Gadu");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntcp_dissect_pdus(tvb, pinfo, tree, gadu_gadu_desegment, 8, get_gadu_gadu_pdu_len, dissect_gadu_gadu_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_gadu_gadu(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_gadu_gadu_header_type_recv,\r\n&hfi_gadu_gadu_header_type_send,\r\n&hfi_gadu_gadu_header_length,\r\n&hfi_gadu_gadu_login_uin,\r\n&hfi_gadu_gadu_login_hash_type,\r\n&hfi_gadu_gadu_login_hash,\r\n&hfi_gadu_gadu_login_status,\r\n&hfi_gadu_gadu_login_protocol,\r\n&hfi_gadu_gadu_login_version,\r\n&hfi_gadu_gadu_login_local_ip,\r\n&hfi_gadu_gadu_login_local_port,\r\n&hfi_gadu_gadu_login80_lang,\r\n&hfi_gadu_gadu_userdata_uin,\r\n&hfi_gadu_gadu_userdata_attr_name,\r\n&hfi_gadu_gadu_userdata_attr_type,\r\n&hfi_gadu_gadu_userdata_attr_value,\r\n&hfi_gadu_gadu_typing_notify_type,\r\n&hfi_gadu_gadu_typing_notify_uin,\r\n&hfi_gadu_gadu_msg_uin,\r\n&hfi_gadu_gadu_msg_sender,\r\n&hfi_gadu_gadu_msg_recipient,\r\n&hfi_gadu_gadu_msg_seq,\r\n&hfi_gadu_gadu_msg_time,\r\n&hfi_gadu_gadu_msg_class,\r\n&hfi_gadu_gadu_msg_text,\r\n&hfi_gadu_gadu_msg80_offset_plain,\r\n&hfi_gadu_gadu_msg80_offset_attr,\r\n&hfi_gadu_gadu_msg_ack_status,\r\n&hfi_gadu_gadu_msg_ack_recipient,\r\n&hfi_gadu_gadu_msg_ack_seq,\r\n&hfi_gadu_gadu_status_uin,\r\n&hfi_gadu_gadu_status_status,\r\n&hfi_gadu_gadu_status_ip,\r\n&hfi_gadu_gadu_status_port,\r\n&hfi_gadu_gadu_status_version,\r\n&hfi_gadu_gadu_status_img_size,\r\n&hfi_gadu_gadu_status_descr,\r\n&hfi_dcc_type,\r\n&hfi_dcc_id,\r\n&hfi_dcc_uin_to,\r\n&hfi_dcc_uin_from,\r\n&hfi_dcc_filename,\r\n&hfi_gadu_gadu_new_status_status,\r\n&hfi_gadu_gadu_new_status_desc,\r\n&hfi_gadu_gadu_userlist_request_type,\r\n&hfi_gadu_gadu_userlist_version,\r\n&hfi_gadu_gadu_userlist_format,\r\n&hfi_gadu_gadu_userlist_reply_type,\r\n&hfi_gadu_gadu_userlist,\r\n&hfi_gadu_gadu_pubdir_request_type,\r\n&hfi_gadu_gadu_pubdir_request_seq,\r\n&hfi_gadu_gadu_pubdir_request_str,\r\n&hfi_gadu_gadu_pubdir_reply_type,\r\n&hfi_gadu_gadu_pubdir_reply_seq,\r\n&hfi_gadu_gadu_pubdir_reply_str,\r\n&hfi_gadu_gadu_contact_uin,\r\n&hfi_gadu_gadu_contact_uin_str,\r\n&hfi_gadu_gadu_contact_type,\r\n&hfi_gadu_gadu_welcome_seed,\r\n&hfi_gadu_gadu_data,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_gadu_gadu,\r\n&ett_gadu_gadu_contact\r\n};\r\nmodule_t *gadu_gadu_module;\r\nint proto_gadu_gadu;\r\nproto_gadu_gadu = proto_register_protocol("Gadu-Gadu Protocol", "Gadu-Gadu", "gadu-gadu");\r\nhfi_gadu_gadu = proto_registrar_get_nth(proto_gadu_gadu);\r\ngadu_gadu_module = prefs_register_protocol(proto_gadu_gadu, NULL);\r\nprefs_register_bool_preference(gadu_gadu_module, "desegment",\r\n"Reassemble Gadu-Gadu messages spanning multiple TCP segments",\r\n"Whether the Gadu-Gadu dissector should reassemble messages spanning multiple TCP segments."\r\n"To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&gadu_gadu_desegment);\r\nproto_register_fields(proto_gadu_gadu, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\ngadu_gadu_handle = create_dissector_handle(dissect_gadu_gadu, proto_gadu_gadu);\r\n}\r\nvoid\r\nproto_reg_handoff_gadu_gadu(void)\r\n{\r\ndissector_add_uint("tcp.port", TCP_PORT_GADU_GADU, gadu_gadu_handle);\r\nxml_handle = find_dissector_add_dependency("xml", hfi_gadu_gadu->id);\r\n}

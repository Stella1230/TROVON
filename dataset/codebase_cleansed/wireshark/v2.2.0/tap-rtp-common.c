static gint rtp_stream_info_cmp(gconstpointer aa, gconstpointer bb)\r\n{\r\nconst struct _rtp_stream_info* a = (const struct _rtp_stream_info*)aa;\r\nconst struct _rtp_stream_info* b = (const struct _rtp_stream_info*)bb;\r\nif (a==b)\r\nreturn 0;\r\nif (a==NULL || b==NULL)\r\nreturn 1;\r\nif (addresses_equal(&(a->src_addr), &(b->src_addr))\r\n&& (a->src_port == b->src_port)\r\n&& addresses_equal(&(a->dest_addr), &(b->dest_addr))\r\n&& (a->dest_port == b->dest_port)\r\n&& (a->ssrc == b->ssrc))\r\nreturn 0;\r\nelse\r\nreturn 1;\r\n}\r\nvoid rtpstream_reset(rtpstream_tapinfo_t *tapinfo)\r\n{\r\nGList* list;\r\nif (tapinfo->mode == TAP_ANALYSE) {\r\nlist = g_list_first(tapinfo->strinfo_list);\r\nwhile (list)\r\n{\r\ng_free(list->data);\r\nlist = g_list_next(list);\r\n}\r\ng_list_free(tapinfo->strinfo_list);\r\ntapinfo->strinfo_list = NULL;\r\ntapinfo->nstreams = 0;\r\ntapinfo->npackets = 0;\r\n}\r\nreturn;\r\n}\r\nvoid rtpstream_reset_cb(void *arg)\r\n{\r\nrtpstream_tapinfo_t *ti =(rtpstream_tapinfo_t *)arg;\r\nif (ti->tap_reset) {\r\nti->tap_reset(ti);\r\n}\r\nrtpstream_reset(ti);\r\n}\r\nvoid rtp_write_header(rtp_stream_info_t *strinfo, FILE *file)\r\n{\r\nguint32 start_sec;\r\nguint32 start_usec;\r\nguint32 source;\r\nsize_t sourcelen;\r\nguint16 port;\r\nguint16 padding;\r\nchar* addr_str = address_to_display(NULL, &(strinfo->dest_addr));\r\nfprintf(file, "#!rtpplay%s %s/%u\n", RTPFILE_VERSION,\r\naddr_str,\r\nstrinfo->dest_port);\r\nwmem_free(NULL, addr_str);\r\nstart_sec = g_htonl(strinfo->start_fd->abs_ts.secs);\r\nstart_usec = g_htonl(strinfo->start_fd->abs_ts.nsecs / 1000000);\r\nmemset(&source, 0, sizeof source);\r\nsourcelen = strinfo->src_addr.len;\r\nif (sourcelen > sizeof source)\r\nsourcelen = sizeof source;\r\nmemcpy(&source, strinfo->src_addr.data, sourcelen);\r\nport = g_htons(strinfo->src_port);\r\npadding = 0;\r\nif (fwrite(&start_sec, 4, 1, file) == 0)\r\nreturn;\r\nif (fwrite(&start_usec, 4, 1, file) == 0)\r\nreturn;\r\nif (fwrite(&source, 4, 1, file) == 0)\r\nreturn;\r\nif (fwrite(&port, 2, 1, file) == 0)\r\nreturn;\r\nif (fwrite(&padding, 2, 1, file) == 0)\r\nreturn;\r\n}\r\nstatic void rtp_write_sample(rtpdump_info_t* rtpdump_info, FILE* file)\r\n{\r\nguint16 length;\r\nguint16 plen;\r\nguint32 offset;\r\nlength = g_htons(rtpdump_info->num_samples + 8);\r\nplen = g_htons(rtpdump_info->num_samples);\r\noffset = g_htonl(rtpdump_info->rec_time);\r\nif (fwrite(&length, 2, 1, file) == 0)\r\nreturn;\r\nif (fwrite(&plen, 2, 1, file) == 0)\r\nreturn;\r\nif (fwrite(&offset, 4, 1, file) == 0)\r\nreturn;\r\nif (fwrite(rtpdump_info->samples, rtpdump_info->num_samples, 1, file) == 0)\r\nreturn;\r\n}\r\nint rtpstream_packet(void *arg, packet_info *pinfo, epan_dissect_t *edt _U_, const void *arg2)\r\n{\r\nrtpstream_tapinfo_t *tapinfo = (rtpstream_tapinfo_t *)arg;\r\nconst struct _rtp_info *rtpinfo = (const struct _rtp_info *)arg2;\r\nrtp_stream_info_t new_stream_info;\r\nrtp_stream_info_t *stream_info = NULL;\r\nGList* list;\r\nrtpdump_info_t rtpdump_info;\r\nstruct _rtp_conversation_info *p_conv_data = NULL;\r\nmemset(&new_stream_info, 0, sizeof(rtp_stream_info_t));\r\ncopy_address(&(new_stream_info.src_addr), &(pinfo->src));\r\nnew_stream_info.src_port = pinfo->srcport;\r\ncopy_address(&(new_stream_info.dest_addr), &(pinfo->dst));\r\nnew_stream_info.dest_port = pinfo->destport;\r\nnew_stream_info.ssrc = rtpinfo->info_sync_src;\r\nnew_stream_info.payload_type = rtpinfo->info_payload_type;\r\nnew_stream_info.payload_type_name = g_strdup(rtpinfo->info_payload_type_str);\r\nif (tapinfo->mode == TAP_ANALYSE) {\r\nlist = g_list_first(tapinfo->strinfo_list);\r\nwhile (list)\r\n{\r\nif (rtp_stream_info_cmp(&new_stream_info, (rtp_stream_info_t*)(list->data))==0)\r\n{\r\nstream_info = (rtp_stream_info_t*)(list->data);\r\nbreak;\r\n}\r\nlist = g_list_next(list);\r\n}\r\nif (!stream_info) {\r\nnew_stream_info.start_fd = pinfo->fd;\r\nnew_stream_info.start_rel_time = pinfo->rel_ts;\r\nnew_stream_info.rtp_stats.first_packet = TRUE;\r\nnew_stream_info.rtp_stats.reg_pt = PT_UNDEFINED;\r\np_conv_data = (struct _rtp_conversation_info *)p_get_proto_data(wmem_file_scope(), pinfo, proto_get_id_by_filter_name("rtp"), 0);\r\nif (p_conv_data)\r\nnew_stream_info.setup_frame_number = p_conv_data->frame_number;\r\nelse\r\nnew_stream_info.setup_frame_number = 0xFFFFFFFF;\r\nstream_info = g_new(rtp_stream_info_t,1);\r\n*stream_info = new_stream_info;\r\ntapinfo->strinfo_list = g_list_append(tapinfo->strinfo_list, stream_info);\r\n}\r\nrtp_packet_analyse(&(stream_info->rtp_stats), pinfo, rtpinfo);\r\nif (stream_info->rtp_stats.flags & STAT_FLAG_WRONG_TIMESTAMP\r\n|| stream_info->rtp_stats.flags & STAT_FLAG_WRONG_SEQ)\r\nstream_info->problem = TRUE;\r\n++(stream_info->packet_count);\r\nstream_info->stop_rel_time = pinfo->rel_ts;\r\n++(tapinfo->npackets);\r\nreturn 1;\r\n}\r\nelse if (tapinfo->mode == TAP_SAVE) {\r\nif (rtp_stream_info_cmp(&new_stream_info, tapinfo->filter_stream_fwd)==0) {\r\nrtpdump_info.rec_time = nstime_to_msec(&pinfo->abs_ts) -\r\nnstime_to_msec(&tapinfo->filter_stream_fwd->start_fd->abs_ts);\r\nrtpdump_info.num_samples = rtpinfo->info_data_len;\r\nrtpdump_info.samples = rtpinfo->info_data;\r\nrtp_write_sample(&rtpdump_info, tapinfo->save_file);\r\n}\r\n}\r\nelse if (tapinfo->mode == TAP_MARK && tapinfo->tap_mark_packet) {\r\nif (rtp_stream_info_cmp(&new_stream_info, tapinfo->filter_stream_fwd)==0\r\n|| rtp_stream_info_cmp(&new_stream_info, tapinfo->filter_stream_rev)==0)\r\n{\r\ntapinfo->tap_mark_packet(tapinfo, pinfo->fd);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic guint32\r\nget_clock_rate(guint32 key)\r\n{\r\nsize_t i;\r\nfor (i = 0; i < NUM_CLOCK_VALUES; i++) {\r\nif (clock_map[i].key == key)\r\nreturn clock_map[i].value;\r\n}\r\nreturn 0;\r\n}\r\nstatic guint32\r\nget_dyn_pt_clock_rate(const gchar *payload_type_str)\r\n{\r\nint i;\r\nfor (i = NUM_DYN_CLOCK_VALUES - 1; i > -1 ; i--) {\r\nif (g_ascii_strncasecmp(mimetype_and_clock_map[i].pt_mime_name_str,payload_type_str,(strlen(mimetype_and_clock_map[i].pt_mime_name_str))) == 0)\r\nreturn mimetype_and_clock_map[i].value;\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nrtp_packet_analyse(tap_rtp_stat_t *statinfo,\r\npacket_info *pinfo,\r\nconst struct _rtp_info *rtpinfo)\r\n{\r\ndouble current_time;\r\ndouble current_jitter;\r\ndouble current_diff = 0;\r\ndouble nominaltime;\r\ndouble arrivaltime;\r\ndouble expected_time;\r\ndouble absskew;\r\nguint32 clock_rate;\r\ncurrent_time = nstime_to_msec(&pinfo->rel_ts);\r\nif (statinfo->first_packet) {\r\nif( pinfo->dl_src.type == AT_ETHER){\r\ncopy_address(&(statinfo->first_packet_mac_addr), &(pinfo->dl_src));\r\n}\r\nstatinfo->start_seq_nr = rtpinfo->info_seq_num;\r\nstatinfo->stop_seq_nr = rtpinfo->info_seq_num;\r\nstatinfo->seq_num = rtpinfo->info_seq_num;\r\nstatinfo->start_time = current_time;\r\nstatinfo->timestamp = rtpinfo->info_timestamp;\r\nstatinfo->first_timestamp = rtpinfo->info_timestamp;\r\nstatinfo->time = current_time;\r\nstatinfo->lastnominaltime = 0;\r\nstatinfo->pt = rtpinfo->info_payload_type;\r\nstatinfo->reg_pt = rtpinfo->info_payload_type;\r\nstatinfo->bw_history[statinfo->bw_index].bytes = rtpinfo->info_data_len + 28;\r\nstatinfo->bw_history[statinfo->bw_index].time = current_time;\r\nstatinfo->bw_index++;\r\nstatinfo->total_bytes += rtpinfo->info_data_len + 28;\r\nstatinfo->bandwidth = (double)(statinfo->total_bytes*8)/1000;\r\nstatinfo->delta = 0;\r\nstatinfo->jitter = 0;\r\nstatinfo->diff = 0;\r\nstatinfo->total_nr++;\r\nstatinfo->flags |= STAT_FLAG_FIRST;\r\nif (rtpinfo->info_marker_set) {\r\nstatinfo->flags |= STAT_FLAG_MARKER;\r\n}\r\nstatinfo->first_packet = FALSE;\r\nreturn;\r\n}\r\nstatinfo->flags = 0;\r\nif( pinfo->dl_src.type == AT_ETHER){\r\nif(!addresses_equal(&(statinfo->first_packet_mac_addr), &(pinfo->dl_src))){\r\nstatinfo->flags |= STAT_FLAG_DUP_PKT;\r\nstatinfo->delta = current_time-(statinfo->time);\r\nreturn;\r\n}\r\n}\r\nif ((rtpinfo->info_seq_num < statinfo->start_seq_nr) && (statinfo->under == FALSE)){\r\nstatinfo->cycles++;\r\nstatinfo->under = TRUE;\r\n}\r\nelse if ((rtpinfo->info_seq_num == 0) && (statinfo->stop_seq_nr == 65535) &&\r\n(statinfo->under == FALSE)){\r\nstatinfo->cycles++;\r\nstatinfo->under = TRUE;\r\n}\r\nelse if ((rtpinfo->info_seq_num > statinfo->start_seq_nr) && (statinfo->under != FALSE)) {\r\nstatinfo->under = FALSE;\r\n}\r\nif ( (statinfo->seq_num+1 == rtpinfo->info_seq_num) || (statinfo->flags & STAT_FLAG_FIRST) )\r\nstatinfo->seq_num = rtpinfo->info_seq_num;\r\nelse if ( (statinfo->seq_num == 65535) && (rtpinfo->info_seq_num == 0) )\r\nstatinfo->seq_num = rtpinfo->info_seq_num;\r\nelse if (statinfo->seq_num+1 < rtpinfo->info_seq_num || statinfo->seq_num - rtpinfo->info_seq_num > 0xFF00) {\r\nstatinfo->seq_num = rtpinfo->info_seq_num;\r\nstatinfo->sequence++;\r\nstatinfo->flags |= STAT_FLAG_WRONG_SEQ;\r\n}\r\nelse if (statinfo->seq_num+1 > rtpinfo->info_seq_num) {\r\nstatinfo->sequence++;\r\nstatinfo->flags |= STAT_FLAG_WRONG_SEQ;\r\n}\r\nif (rtpinfo->info_payload_type == PT_CN\r\n|| rtpinfo->info_payload_type == PT_CN_OLD)\r\nstatinfo->flags |= STAT_FLAG_PT_CN;\r\nif (statinfo->pt == PT_CN\r\n|| statinfo->pt == PT_CN_OLD)\r\nstatinfo->flags |= STAT_FLAG_FOLLOW_PT_CN;\r\nif (rtpinfo->info_payload_type != statinfo->pt)\r\nstatinfo->flags |= STAT_FLAG_PT_CHANGE;\r\nstatinfo->pt = rtpinfo->info_payload_type;\r\nif (statinfo->pt < 96 ){\r\nclock_rate = get_clock_rate(statinfo->pt);\r\n}else{\r\nif ( rtpinfo->info_payload_type_str != NULL ){\r\nif (g_ascii_strncasecmp("telephone-event",rtpinfo->info_payload_type_str,(strlen("telephone-event")))==0){\r\nclock_rate = 0;\r\nstatinfo->flags |= STAT_FLAG_PT_T_EVENT;\r\n}else{\r\nif(rtpinfo->info_payload_rate !=0){\r\nclock_rate = rtpinfo->info_payload_rate;\r\n}else{\r\nclock_rate = get_dyn_pt_clock_rate(rtpinfo->info_payload_type_str);\r\n}\r\n}\r\n}else{\r\nclock_rate = 0;\r\n}\r\n}\r\narrivaltime = current_time - statinfo->start_time;\r\nif (statinfo->first_timestamp > rtpinfo->info_timestamp){\r\nnominaltime = (double)(rtpinfo->info_timestamp + 0xffffffff - statinfo->first_timestamp + 1);\r\n}else{\r\nnominaltime = (double)(rtpinfo->info_timestamp - statinfo->first_timestamp);\r\n}\r\nif (clock_rate != 0) {\r\nstatinfo->clock_rate = clock_rate;\r\nnominaltime = nominaltime /(clock_rate/1000);\r\nif (!statinfo->first_packet) {\r\nexpected_time = statinfo->time + (nominaltime - statinfo->lastnominaltime);\r\ncurrent_diff = fabs(current_time - expected_time);\r\ncurrent_jitter = (15 * statinfo->jitter + current_diff) / 16;\r\nstatinfo->delta = current_time-(statinfo->time);\r\nstatinfo->jitter = current_jitter;\r\nstatinfo->diff = current_diff;\r\n}\r\nstatinfo->lastnominaltime = nominaltime;\r\nstatinfo->skew = nominaltime - arrivaltime;\r\nabsskew = fabs(statinfo->skew);\r\nif(absskew > fabs(statinfo->max_skew)){\r\nstatinfo->max_skew = statinfo->skew;\r\n}\r\n#if 0\r\nif (numPackets > 0 && (!hardPayloadType || !alternatePayloadType)) {\r\ndouble dt;\r\ndt = nominaltime - statinfo->lastnominaltime;\r\nsumdt += 1.0 * dt;\r\nnumdt += (dt != 0 ? 1 : 0);\r\nmindt = (dt < mindt ? dt : mindt);\r\nmaxdt = (dt > maxdt ? dt : maxdt);\r\n}\r\n#endif\r\nstatinfo->sumt += 1.0 * current_time;\r\nstatinfo->sumTS += 1.0 * nominaltime;\r\nstatinfo->sumt2 += 1.0 * current_time * current_time;\r\nstatinfo->sumtTS += 1.0 * current_time * nominaltime;\r\n}\r\nstatinfo->bw_history[statinfo->bw_index].bytes = rtpinfo->info_data_len + 28;\r\nstatinfo->bw_history[statinfo->bw_index].time = current_time;\r\nwhile ((statinfo->bw_history[statinfo->bw_start_index].time+1000)<current_time){\r\nstatinfo->total_bytes -= statinfo->bw_history[statinfo->bw_start_index].bytes;\r\nstatinfo->bw_start_index++;\r\nif (statinfo->bw_start_index == BUFF_BW) statinfo->bw_start_index=0;\r\n};\r\nstatinfo->total_bytes += rtpinfo->info_data_len + 28;\r\nstatinfo->bandwidth = (double)(statinfo->total_bytes*8)/1000;\r\nstatinfo->bw_index++;\r\nif (statinfo->bw_index == BUFF_BW) statinfo->bw_index = 0;\r\nif (rtpinfo->info_marker_set) {\r\nstatinfo->delta_timestamp = rtpinfo->info_timestamp - statinfo->timestamp;\r\nif (rtpinfo->info_timestamp > statinfo->timestamp){\r\nstatinfo->flags |= STAT_FLAG_MARKER;\r\n}\r\nelse{\r\nstatinfo->flags |= STAT_FLAG_WRONG_TIMESTAMP;\r\n}\r\n}\r\nif (!(statinfo->flags & STAT_FLAG_FIRST)\r\n&& !(statinfo->flags & STAT_FLAG_MARKER)\r\n&& !(statinfo->flags & STAT_FLAG_PT_CN)\r\n&& !(statinfo->flags & STAT_FLAG_WRONG_TIMESTAMP)\r\n&& !(statinfo->flags & STAT_FLAG_FOLLOW_PT_CN)) {\r\nif (statinfo->delta > statinfo->max_delta) {\r\nstatinfo->max_delta = statinfo->delta;\r\nstatinfo->max_nr = pinfo->num;\r\n}\r\nif (clock_rate != 0) {\r\nif (statinfo->jitter > statinfo->max_jitter) {\r\nstatinfo->max_jitter = statinfo->jitter;\r\n}\r\nstatinfo->mean_jitter = (statinfo->mean_jitter*statinfo->total_nr + current_diff) / (statinfo->total_nr+1);\r\n}\r\n}\r\nif (!(statinfo->flags & STAT_FLAG_FIRST)\r\n&& !(statinfo->flags & STAT_FLAG_PT_CN)) {\r\nif ((statinfo->pt != statinfo->reg_pt)\r\n&& (statinfo->reg_pt != PT_UNDEFINED)) {\r\nstatinfo->flags |= STAT_FLAG_REG_PT_CHANGE;\r\n}\r\n}\r\nif (!(statinfo->flags & STAT_FLAG_PT_CN)) {\r\nstatinfo->reg_pt = statinfo->pt;\r\n}\r\nstatinfo->time = current_time;\r\nstatinfo->timestamp = rtpinfo->info_timestamp;\r\nstatinfo->stop_seq_nr = rtpinfo->info_seq_num;\r\nstatinfo->total_nr++;\r\nreturn;\r\n}

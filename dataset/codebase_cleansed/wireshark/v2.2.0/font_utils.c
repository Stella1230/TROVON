PangoFontDescription *user_font_get_regular(void)\r\n{\r\nreturn m_r_font;\r\n}\r\nstatic void\r\nset_fonts(PangoFontDescription *regular)\r\n{\r\ng_assert(m_r_font);\r\nm_r_font = regular;\r\n}\r\nvoid\r\nview_zoom_in_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\ngint save_gui_zoom_level;\r\nsave_gui_zoom_level = recent.gui_zoom_level;\r\nrecent.gui_zoom_level++;\r\nswitch (user_font_apply()) {\r\ncase FA_SUCCESS:\r\nbreak;\r\ncase FA_ZOOMED_TOO_FAR:\r\nrecent.gui_zoom_level = save_gui_zoom_level;\r\nbreak;\r\ncase FA_FONT_NOT_AVAILABLE:\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Your current font isn't available in the next larger size.\n");\r\nrecent.gui_zoom_level = save_gui_zoom_level;\r\nbreak;\r\n}\r\n}\r\nvoid\r\nview_zoom_out_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\ngint save_gui_zoom_level;\r\nsave_gui_zoom_level = recent.gui_zoom_level;\r\nrecent.gui_zoom_level--;\r\nswitch (user_font_apply()) {\r\ncase FA_SUCCESS:\r\nbreak;\r\ncase FA_ZOOMED_TOO_FAR:\r\nrecent.gui_zoom_level = save_gui_zoom_level;\r\nbreak;\r\ncase FA_FONT_NOT_AVAILABLE:\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Your current font isn't available in the next smaller size.\n");\r\nrecent.gui_zoom_level = save_gui_zoom_level;\r\nbreak;\r\n}\r\n}\r\nvoid\r\nview_zoom_100_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\ngint save_gui_zoom_level;\r\nsave_gui_zoom_level = recent.gui_zoom_level;\r\nrecent.gui_zoom_level = 0;\r\nswitch (user_font_apply()) {\r\ncase FA_SUCCESS:\r\nbreak;\r\ncase FA_ZOOMED_TOO_FAR:\r\nrecent.gui_zoom_level = save_gui_zoom_level;\r\nbreak;\r\ncase FA_FONT_NOT_AVAILABLE:\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Your current font couldn't be reloaded at the size you selected.\n");\r\nrecent.gui_zoom_level = save_gui_zoom_level;\r\nbreak;\r\n}\r\n}\r\ngboolean\r\nuser_font_test(gchar *font_name)\r\n{\r\nPangoFontDescription *new_r_font;\r\nnew_r_font = pango_font_description_from_string(font_name);\r\nif (new_r_font == NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"The font you selected can't be loaded.");\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic char *\r\nfont_zoom(char *gui_font_name)\r\n{\r\nchar *new_font_name;\r\nchar *font_name_dup;\r\nchar *font_name_p;\r\nlong font_point_size_l;\r\nif (recent.gui_zoom_level == 0) {\r\nreturn g_strdup(gui_font_name);\r\n}\r\nfont_name_dup = g_strdup(gui_font_name);\r\nfont_name_p = strrchr(font_name_dup, ' ');\r\n*font_name_p = '\0';\r\nfont_name_p++;\r\nfont_point_size_l = strtol(font_name_p, NULL, 10);\r\nfont_point_size_l += recent.gui_zoom_level;\r\nif (font_point_size_l <= 0)\r\nreturn NULL;\r\nnew_font_name = g_strdup_printf("%s %ld", font_name_dup, font_point_size_l);\r\ng_free(font_name_dup);\r\nreturn new_font_name;\r\n}\r\nfa_ret_t\r\nuser_font_apply(void) {\r\nchar *gui_font_name;\r\nPangoFontDescription *new_r_font;\r\nPangoFontDescription *old_r_font = NULL;\r\ngui_font_name = font_zoom(prefs.gui_gtk2_font_name);\r\nif (gui_font_name == NULL)\r\nreturn FA_ZOOMED_TOO_FAR;\r\nnew_r_font = pango_font_description_from_string(gui_font_name);\r\nif (new_r_font == NULL) {\r\ng_free(gui_font_name);\r\nreturn FA_FONT_NOT_AVAILABLE;\r\n}\r\npacket_list_set_font(new_r_font);\r\nset_ptree_font_all(new_r_font);\r\nold_r_font = m_r_font;\r\nset_fonts(new_r_font);\r\nredraw_packet_bytes_all();\r\nfollow_stream_redraw_all();\r\nif (old_r_font != NULL)\r\npango_font_description_free(old_r_font);\r\ng_free(gui_font_name);\r\nreturn FA_SUCCESS;\r\n}\r\nstatic void\r\nset_app_font_gtk2(const char *fontname)\r\n{\r\nGtkSettings *settings;\r\nif (fontname != NULL && *fontname == 0) return;\r\nsettings = gtk_settings_get_default();\r\nif (fontname == NULL) {\r\ng_object_set(G_OBJECT(settings), "gtk-font-name", appfontname, NULL);\r\n} else {\r\nGtkWidget *w;\r\nPangoFontDescription *pfd;\r\nPangoContext *pc;\r\nPangoFont *pfont;\r\nw = gtk_label_new(NULL);\r\npfd = pango_font_description_from_string(fontname);\r\npc = gtk_widget_get_pango_context(w);\r\npfont = pango_context_load_font(pc, pfd);\r\nif (pfont != NULL) {\r\ng_strlcpy(appfontname, fontname, 128);\r\nappfontname[127] = '\0';\r\ng_object_set(G_OBJECT(settings), "gtk-font-name", appfontname, NULL);\r\n}\r\ngtk_widget_destroy(w);\r\npango_font_description_free(pfd);\r\n}\r\n}\r\nstatic char *default_windows_menu_fontspec_gtk2(void)\r\n{\r\ngchar *fontspec = NULL;\r\nNONCLIENTMETRICS ncm;\r\nmemset(&ncm, 0, sizeof ncm);\r\nncm.cbSize = sizeof ncm;\r\nif (SystemParametersInfo(SPI_GETNONCLIENTMETRICS, ncm.cbSize, &ncm, 0)) {\r\nHDC screen = GetDC(0);\r\ndouble y_scale = 72.0 / GetDeviceCaps(screen, LOGPIXELSY);\r\nint point_size = (int) (ncm.lfMenuFont.lfHeight * y_scale);\r\nif (point_size < 0) point_size = -point_size;\r\nfontspec = g_strdup_printf("%s %d", ncm.lfMenuFont.lfFaceName,\r\npoint_size);\r\nReleaseDC(0, screen);\r\n}\r\nreturn fontspec;\r\n}\r\nstatic void try_to_get_windows_font_gtk2(void)\r\n{\r\ngchar *fontspec;\r\nfontspec = default_windows_menu_fontspec_gtk2();\r\nif (fontspec != NULL) {\r\nint match;\r\nPangoFontDescription *pfd;\r\nPangoFont *pfont;\r\nPangoContext *pc;\r\nGtkWidget *w;\r\npfd = pango_font_description_from_string(fontspec);\r\nw = gtk_label_new(NULL);\r\npc = gtk_widget_get_pango_context(w);\r\npfont = pango_context_load_font(pc, pfd);\r\nmatch = (pfont != NULL);\r\npango_font_description_free(pfd);\r\ng_object_unref(G_OBJECT(pc));\r\ngtk_widget_destroy(w);\r\nif (match) set_app_font_gtk2(fontspec);\r\ng_free(fontspec);\r\n}\r\n}\r\nvoid font_init(void)\r\n{\r\n#ifdef _WIN32\r\ntry_to_get_windows_font_gtk2();\r\n#endif\r\nm_r_font = pango_font_description_from_string(prefs.gui_gtk2_font_name);\r\nif (m_r_font == NULL) {\r\nfprintf(stderr, "wireshark: Warning: font %s not found - defaulting to Monospace 9\n",\r\nprefs.gui_gtk2_font_name);\r\nif ((m_r_font = pango_font_description_from_string("Monospace 9")) == NULL)\r\n{\r\nfprintf(stderr, "wireshark: Error: font Monospace 9 not found\n");\r\nexit(1);\r\n}\r\ng_free(prefs.gui_gtk2_font_name);\r\nprefs.gui_gtk2_font_name = g_strdup("Monospace 9");\r\n}\r\nset_fonts(m_r_font);\r\n}

static int\r\ndissect_rtp_events( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_ )\r\n{\r\nproto_item *ti;\r\nproto_tree *rtp_events_tree;\r\nunsigned int offset = 0;\r\nstruct _rtp_conversation_info *p_conv_data;\r\nguint8 rtp_evt;\r\nguint8 octet;\r\nstatic const int * events[] = {\r\n&hf_rtp_events_end,\r\n&hf_rtp_events_reserved,\r\n&hf_rtp_events_volume,\r\nNULL\r\n};\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "RTP EVENT");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nrtp_evt = tvb_get_guint8(tvb, offset );\r\nrtp_event_info.info_rtp_evt = rtp_evt;\r\np_conv_data = (struct _rtp_conversation_info *)p_get_proto_data(wmem_file_scope(), pinfo, proto_get_id_by_filter_name("rtp"), 0);\r\nif (p_conv_data)\r\nrtp_event_info.info_setup_frame_num = p_conv_data->frame_number;\r\nelse\r\nrtp_event_info.info_setup_frame_num = 0;\r\ncol_add_fstr( pinfo->cinfo, COL_INFO,\r\n"Payload type=RTP Event, %s",\r\nval_to_str_ext( rtp_evt, &rtp_event_type_values_ext, "Unknown (%u)" ));\r\nti = proto_tree_add_item( tree, proto_rtp_events, tvb, offset, -1, ENC_NA );\r\nrtp_events_tree = proto_item_add_subtree( ti, ett_rtp_events );\r\nproto_tree_add_uint ( rtp_events_tree, hf_rtp_events_event, tvb, offset, 1, rtp_evt);\r\noffset++;\r\noctet = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_bitmask_list(rtp_events_tree, tvb, offset, 1, events, ENC_NA);\r\noffset++;\r\nrtp_event_info.info_duration = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item ( rtp_events_tree, hf_rtp_events_duration, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (octet & 0x80)\r\n{\r\nrtp_event_info.info_end = TRUE;\r\n} else\r\n{\r\nrtp_event_info.info_end = FALSE;\r\n}\r\nif ((octet & 0x80))\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (end)");\r\n}\r\ntap_queue_packet(rtp_event_tap, pinfo, &rtp_event_info);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_rtp_events(void)\r\n{\r\nmodule_t *rtp_events_module;\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_rtp_events_event,\r\n{\r\n"Event ID",\r\n"rtpevent.event_id",\r\nFT_UINT8,\r\nBASE_DEC | BASE_EXT_STRING,\r\n&rtp_event_type_values_ext,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_rtp_events_end,\r\n{\r\n"End of Event",\r\n"rtpevent.end_of_event",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x80,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_rtp_events_reserved,\r\n{\r\n"Reserved",\r\n"rtpevent.reserved",\r\nFT_BOOLEAN,\r\n8,\r\nNULL,\r\n0x40,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_rtp_events_volume,\r\n{\r\n"Volume",\r\n"rtpevent.volume",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x3F,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_rtp_events_duration,\r\n{\r\n"Event Duration",\r\n"rtpevent.duration",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_rtp_events,\r\n};\r\nproto_rtp_events = proto_register_protocol("RFC 2833 RTP Event", "RTP Event", "rtpevent");\r\nproto_register_field_array(proto_rtp_events, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nrtp_events_module = prefs_register_protocol (proto_rtp_events, proto_reg_handoff_rtp_events);\r\nprefs_register_uint_preference (rtp_events_module,\r\n"event_payload_type_value", "Payload Type for RFC2833 RTP Events",\r\n"This is the value of the Payload Type field"\r\n" that specifies RTP Events", 10,\r\n&rtp_event_payload_type_value);\r\nprefs_register_uint_preference (rtp_events_module,\r\n"cisco_nse_payload_type_value", "Payload Type for Cisco Named Signaling Events",\r\n"This is the value of the Payload Type field"\r\n" that specifies Cisco Named Signaling Events", 10,\r\n&cisco_nse_pt_value);\r\nregister_dissector("rtpevent", dissect_rtp_events, proto_rtp_events);\r\nrtp_event_tap = register_tap("rtpevent");\r\n}\r\nvoid\r\nproto_reg_handoff_rtp_events(void)\r\n{\r\nstatic dissector_handle_t rtp_events_handle;\r\nstatic guint saved_payload_type_value;\r\nstatic guint saved_cisco_nse_pt_value;\r\nstatic gboolean rtp_events_prefs_initialized = FALSE;\r\nif (!rtp_events_prefs_initialized) {\r\nrtp_events_handle = find_dissector("rtpevent");\r\ndissector_add_string("rtp_dyn_payload_type", "telephone-event", rtp_events_handle);\r\ndissector_add_string("rtp_dyn_payload_type", "X-NSE", rtp_events_handle);\r\nrtp_events_prefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("rtp.pt", saved_payload_type_value, rtp_events_handle);\r\ndissector_delete_uint("rtp.pt", saved_cisco_nse_pt_value, rtp_events_handle);\r\n}\r\nsaved_payload_type_value = rtp_event_payload_type_value;\r\nsaved_cisco_nse_pt_value = cisco_nse_pt_value;\r\nif(saved_payload_type_value != 0){\r\ndissector_add_uint("rtp.pt", saved_payload_type_value, rtp_events_handle);\r\ndissector_add_uint("rtp.pt", saved_cisco_nse_pt_value, rtp_events_handle);\r\n}\r\n}

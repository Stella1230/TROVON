static int\r\ndissect_PNMRRT_Common(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint8 length _U_)\r\n{\r\nguint16 sequence_id;\r\ne_guid_t uuid;\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_mrrt_sequence_id, &sequence_id);\r\noffset = dissect_pn_uuid(tvb, offset, pinfo, tree, hf_pn_mrrt_domain_uuid, &uuid);\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Common");\r\nproto_item_append_text(item, "Common");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNMRRT_Test(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint8 length _U_)\r\n{\r\nguint8 mac[6];\r\noffset = dissect_pn_mac(tvb, offset, pinfo, tree, hf_pn_mrrt_sa, mac);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Test");\r\nproto_item_append_text(item, "Test");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNMRRT_PDU(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint16 version;\r\nguint8 type;\r\nguint8 length;\r\ngint i = 0;\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_mrrt_version, &version);\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_mrrt_type, &type);\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_mrrt_length, &length);\r\nif (i != 0) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", ");\r\nproto_item_append_text(item, ", ");\r\n}\r\ni++;\r\nswitch(type) {\r\ncase 0x00:\r\ncol_append_str(pinfo->cinfo, COL_INFO, "End");\r\nproto_item_append_text(item, "End");\r\nreturn offset;\r\nbreak;\r\ncase 0x01:\r\noffset = dissect_PNMRRT_Common(tvb, offset, pinfo, tree, item, length);\r\nbreak;\r\ncase 0x02:\r\noffset = dissect_PNMRRT_Test(tvb, offset, pinfo, tree, item, length);\r\nbreak;\r\ndefault:\r\noffset = dissect_pn_undecoded(tvb, offset, pinfo, tree, length);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Unknown TLVType 0x%x", type);\r\nproto_item_append_text(item, "Unknown TLVType 0x%x", type);\r\nbreak;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ndissect_PNMRRT_Data_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data)\r\n{\r\nguint16 u16FrameID = GPOINTER_TO_UINT(data);\r\nproto_item *item;\r\nproto_tree *mrrt_tree;\r\nint offset = 0;\r\nguint32 u32SubStart;\r\nif (u16FrameID != 0xFF60) {\r\nreturn FALSE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PN-MRRT");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nitem = proto_tree_add_protocol_format(tree, proto_pn_mrrt, tvb, 0, 0, "PROFINET MRRT, ");\r\nmrrt_tree = proto_item_add_subtree(item, ett_pn_mrrt);\r\nu32SubStart = offset;\r\noffset = dissect_PNMRRT_PDU(tvb, offset, pinfo, mrrt_tree, item);\r\nproto_item_set_len(item, offset - u32SubStart);\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_pn_mrrt (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_pn_mrrt_type,\r\n{ "Type", "pn_mrrt.type",\r\nFT_UINT8, BASE_HEX, VALS(pn_mrrt_block_type_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_mrrt_length,\r\n{ "Length", "pn_mrrt.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_mrrt_version,\r\n{ "Version", "pn_mrrt.version",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_mrrt_sequence_id,\r\n{ "SequenceID", "pn_mrrt.sequence_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\n"Unique sequence number to each outstanding service request", HFILL }},\r\n{ &hf_pn_mrrt_sa,\r\n{ "SA", "pn_mrrt.sa",\r\nFT_ETHER, BASE_NONE, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_mrrt_domain_uuid,\r\n{ "DomainUUID", "pn_mrrt.domain_uuid",\r\nFT_GUID, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_pn_mrrt\r\n};\r\nproto_pn_mrrt = proto_register_protocol ("PROFINET MRRT", "PN-MRRT", "pn_mrrt");\r\nproto_register_field_array (proto_pn_mrrt, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\n}\r\nvoid\r\nproto_reg_handoff_pn_mrrt (void)\r\n{\r\nheur_dissector_add("pn_rt", dissect_PNMRRT_Data_heur, "PROFINET MRRT IO", "pn_mrrt_pn_rt", proto_pn_mrrt, HEURISTIC_ENABLE);\r\n}

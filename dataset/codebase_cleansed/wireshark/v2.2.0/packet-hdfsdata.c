static int\r\ndecode_vint_size (gint8 value) {\r\nif (value >= -112) {\r\nreturn 1;\r\n} else if (value < -120) {\r\nreturn -119 - value;\r\n}\r\nreturn -111 - value;\r\n}\r\nstatic guint\r\ndissect_variable_length_long (tvbuff_t *tvb, proto_tree *hdfsdata_tree, int* offset)\r\n{\r\nint byte_count = 1;\r\nint idx = 0;\r\nguint i = 0;\r\ngint8 first_byte = tvb_get_guint8(tvb, *offset);\r\nguint size = 0;\r\nint len = decode_vint_size(first_byte);\r\nif (len == 1) {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_clientlen, tvb, *offset, byte_count, ENC_BIG_ENDIAN);\r\n*offset = (*offset) + byte_count;\r\nreturn first_byte;\r\n}\r\nfor (idx = 0; idx < len-1; idx++) {\r\nchar b = tvb_get_guint8(tvb, *offset + byte_count);\r\nbyte_count++;\r\ni = i << 8;\r\ni = i | (b & 0xFF);\r\n}\r\nsize = ((first_byte < -120 || (first_byte >= -112 && first_byte < 0)) ? (i ^ 0xFFFFFFFF) : i);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_clientlen, tvb, *offset, byte_count, ENC_BIG_ENDIAN);\r\n*offset = (*offset) + byte_count;\r\nreturn size;\r\n}\r\nstatic void\r\ndissect_variable_int_string(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int *offset)\r\n{\r\nint len = dissect_variable_length_long (tvb, hdfsdata_tree, offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_clientid, tvb, *offset, len, ENC_ASCII|ENC_NA);\r\n*offset += len;\r\n}\r\nstatic void\r\ndissect_access_tokens(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int *offset)\r\n{\r\nint len = 0;\r\nlen = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenlen, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenid, tvb, *offset, len, ENC_ASCII|ENC_NA);\r\n*offset += len;\r\nlen = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenlen, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenpassword, tvb, *offset, len, ENC_ASCII|ENC_NA);\r\n*offset += len;\r\nlen = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenlen, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokentype, tvb, *offset, len, ENC_ASCII|ENC_NA);\r\n*offset += len;\r\nlen = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenlen, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_tokenservice, tvb, *offset, len, ENC_ASCII|ENC_NA);\r\n*offset += len;\r\n}\r\nstatic void\r\ndissect_read_response(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int offset)\r\n{\r\nint len = 0;\r\nguint32 chunksize;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_datalength, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_inblockoffset, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_seqnum, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_last, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_datalen, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nchunksize = tvb_get_ntohl(tvb, CHUNKSIZE_START);\r\nif (chunksize == 0)\r\nreturn;\r\nif (tvb_get_guint8(tvb, 2) == CRC) {\r\nlen = (int)(CRC_SIZE * tvb_get_ntohl(tvb, offset - 4) *\r\ntvb_get_ntohl(tvb, offset - 8) / chunksize);\r\n}\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_crc32, tvb, offset, len, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_read_response_start(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int offset) {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_status, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_checksumtype, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_chunksize, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_chunkoffset, tvb, offset, 8, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_read_request(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int *offset)\r\n{\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_startoffset, tvb, *offset, 8, ENC_BIG_ENDIAN);\r\n*offset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_blocklen, tvb, *offset, 8, ENC_BIG_ENDIAN);\r\n*offset += 8;\r\n}\r\nstatic void\r\ndissect_write_request(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int *offset)\r\n{\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_pipelinenum, tvb, *offset, 4, ENC_BIG_ENDIAN);\r\n*offset += 4;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_recovery, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\n}\r\nstatic void\r\ndissect_write_request_end(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int *offset)\r\n{\r\nint i = 0;\r\nint len = 0;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_sourcenode, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nlen = tvb_get_ntohl(tvb, *offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_currentpipeline, tvb, *offset, 4, ENC_BIG_ENDIAN);\r\n*offset += 4;\r\nfor (i = 0; i < len; i++) {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_node, tvb, *offset, 4, ENC_BIG_ENDIAN);\r\n*offset += 4;\r\n}\r\n}\r\nstatic int\r\ndissect_header(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int* offset){\r\nint command = 0;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_version, tvb, *offset, 2, ENC_BIG_ENDIAN);\r\n*offset += 2;\r\ncommand = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_cmd, tvb, *offset, 1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_blockid, tvb, *offset, 8, ENC_BIG_ENDIAN);\r\n*offset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_timestamp, tvb, *offset, 8, ENC_BIG_ENDIAN);\r\n*offset += 8;\r\nreturn command;\r\n}\r\nstatic void\r\ndissect_write_response(tvbuff_t *tvb, proto_tree *hdfsdata_tree, int offset)\r\n{\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_packetsize, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_startoffset, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_seqnum, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_last, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_chunklength, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_crc64, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_rest, tvb, offset, (tvb_reported_length(tvb)) - offset, ENC_ASCII|ENC_NA);\r\n}\r\nstatic guint\r\nget_hdfsdata_message_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset, void *data _U_)\r\n{\r\nif (tvb_reported_length(tvb) <= 4 || tvb_reported_length(tvb) == END_PACKET_LEN\r\n|| tvb_get_ntohl(tvb, 0) == tvb_reported_length(tvb) - WRITE_RESP_HEAD_LEN\r\n|| (tvb_reported_length(tvb) >= MIN_READ_REQ && tvb_get_guint8(tvb, 2) == READ_OP)\r\n|| (tvb_reported_length(tvb) >= MIN_WRITE_REQ && tvb_get_guint8(tvb, 2) == WRITE_OP)) {\r\nreturn tvb_reported_length(tvb);\r\n}\r\nreturn tvb_get_ntohl(tvb, offset + FIRST_READ_FRAGMENT_LEN) +\r\nFIRST_READ_FRAGMENT_LEN + SECOND_READ_FRAGMENT_LEN - LAST_READ_FRAGMENT_LEN;\r\n}\r\nstatic int\r\ndissect_hdfsdata_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "HDFSDATA");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "HDFS Data");\r\nif (tree) {\r\nproto_item *ti = NULL;\r\nproto_tree *hdfsdata_tree = NULL;\r\nti = proto_tree_add_item(tree, proto_hdfsdata, tvb, offset, -1, ENC_NA);\r\nhdfsdata_tree = proto_item_add_subtree(ti, ett_hdfsdata);\r\nif ((tvb_reported_length(tvb)) == PIPELINE_LEN) {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_pipelinestatus, tvb, offset, PIPELINE_LEN, ENC_BIG_ENDIAN);\r\n} else if ((tvb_reported_length(tvb)) == STATUS_LEN) {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_status, tvb, offset, STATUS_LEN, ENC_BIG_ENDIAN);\r\n} else if ((tvb_reported_length(tvb)) == FINISH_REQ_LEN) {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_end, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n} else if (tvb_reported_length(tvb) >= READ_RESP_HEAD_LEN && tvb_reported_length(tvb) ==\r\ntvb_get_ntohl(tvb, FIRST_READ_FRAGMENT_LEN) +\r\nFIRST_READ_FRAGMENT_LEN + SECOND_READ_FRAGMENT_LEN - LAST_READ_FRAGMENT_LEN){\r\ndissect_read_response_start(tvb, hdfsdata_tree, offset);\r\noffset += FIRST_READ_FRAGMENT_LEN;\r\ndissect_read_response(tvb, hdfsdata_tree, offset);\r\noffset+= SECOND_READ_FRAGMENT_LEN;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_rest, tvb, offset, (tvb_reported_length(tvb)) - offset, ENC_ASCII|ENC_NA);\r\n} else {\r\nguint8 op = tvb_get_guint8(tvb, 2);\r\nif ((tvb_reported_length(tvb)) >= MIN_READ_REQ && op == READ_OP) {\r\ndissect_header(tvb, hdfsdata_tree, &offset);\r\ndissect_read_request(tvb, hdfsdata_tree, &offset);\r\ndissect_variable_int_string(tvb, hdfsdata_tree, &offset);\r\ndissect_access_tokens(tvb, hdfsdata_tree, &offset);\r\n} else if ((tvb_reported_length(tvb)) >= MIN_WRITE_REQ && op == WRITE_OP) {\r\ndissect_header(tvb, hdfsdata_tree, &offset);\r\ndissect_write_request(tvb, hdfsdata_tree, &offset);\r\ndissect_variable_int_string(tvb, hdfsdata_tree, &offset);\r\ndissect_write_request_end(tvb, hdfsdata_tree, &offset);\r\ndissect_access_tokens(tvb, hdfsdata_tree, &offset);\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_checksumtype, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_chunksize, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n} else if (tvb_reported_length(tvb) >= 4 && tvb_get_ntohl(tvb, 0) ==\r\ntvb_reported_length(tvb) - WRITE_RESP_HEAD_LEN) {\r\ndissect_write_response(tvb, hdfsdata_tree, offset);\r\n} else {\r\nproto_tree_add_item(hdfsdata_tree, hf_hdfsdata_rest, tvb, offset, (tvb_reported_length(tvb)), ENC_ASCII|ENC_NA);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_hdfsdata(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nint frame_header_len = 0;\r\ngboolean need_reassemble = FALSE;\r\nguint8 op = 0;\r\ngboolean only_packet = tvb_reported_length(tvb) == 1 || (tvb_reported_length(tvb) == 2 &&\r\ntvb_get_ntohs(tvb, 0) == STATUS_SUCCESS);\r\nif (tvb_reported_length(tvb) >= 3)\r\nop = tvb_get_guint8(tvb, 2);\r\nif (!only_packet && tvb_reported_length(tvb) != 4 && !(tvb_reported_length(tvb) >= MIN_READ_REQ && op == READ_OP) &&\r\n!(tvb_reported_length(tvb) >= MIN_WRITE_REQ && op == WRITE_OP) && !(tvb_reported_length(tvb) == END_PACKET_LEN &&\r\n!tvb_get_ntohl(tvb, 0) && !tvb_get_ntohl(tvb, 4))) {\r\nneed_reassemble = TRUE;\r\n}\r\nif (only_packet || tvb_reported_length(tvb) == END_PACKET_LEN) {\r\nframe_header_len = tvb_reported_length(tvb);\r\n} else if (tvb_reported_length(tvb) == FIRST_READ_FRAGMENT_LEN ||(tvb_reported_length(tvb) >= MIN_READ_REQ &&\r\nop == READ_OP && !((tvb_reported_length(tvb)) == 2 && !tvb_get_ntohs(tvb, 0)))) {\r\nframe_header_len = READ_RESP_HEAD_LEN;\r\n} else if (tvb_reported_length(tvb) >= MIN_WRITE_REQ && op == WRITE_OP) {\r\nframe_header_len = WRITE_REQ_HEAD_LEN;\r\n}\r\ntcp_dissect_pdus(tvb, pinfo, tree, need_reassemble, frame_header_len, get_hdfsdata_message_len, dissect_hdfsdata_message, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_hdfsdata(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_hdfsdata_version,\r\n{ "HDFSDATA protocol version", "hdfsdata.version",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_cmd,\r\n{ "HDFSDATA command", "hdfsdata.cmd",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_blockid,\r\n{ "HDFSDATA block id", "hdfsdata.blockid",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_timestamp,\r\n{ "HDFSDATA timestamp", "hdfsdata.timestamp",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_startoffset,\r\n{ "HDFSDATA start offset" , "hdfsdata.startoffset",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_blocklen,\r\n{ "HDFSDATA block length", "hdfsdata.blocklen",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_pipelinenum,\r\n{ "HDFSDATA number in pipeline", "hdfsdata.pipelinenum",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_recovery,\r\n{ "HDFSDATA recovery boolean", "hdfsdata.recovery",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_sourcenode,\r\n{ "HDFSDATA source node", "hdfsdata.sourcenode",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_currentpipeline,\r\n{ "HDFSDATA current number of nodes in the pipeline", "hdfsdata.currentpipline",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_node,\r\n{ "HDFSDATA node object", "hdfsdata.node",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_clientlen,\r\n{ "HDFSDATA client id length", "hdfsdata.clientlen",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_clientid,\r\n{ "HDFSDATA client id", "hdfsdata.clientid",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_end,\r\n{ "HDFSDATA end data request", "hdfsdata.end",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_tokenlen,\r\n{ "HDFSDATA access token length", "hdfsdata.tokenlen",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_tokenid,\r\n{ "HDFSDATA access token ID", "hdfsdata.tokenid",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_tokenpassword,\r\n{ "HDFSDATA access token password", "hdfsdata.tokenpassword",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_tokentype,\r\n{ "HDFSDATA access token type", "hdfsdata.tokentype",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_tokenservice,\r\n{ "HDFSDATA access token service", "hdfsdata.tokenservice",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_status,\r\n{ "HDFSDATA status code", "hdfsdata.status",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_checksumtype,\r\n{ "HDFSDATA checksum type", "hdfsdata.checksumtype",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_chunksize,\r\n{ "HDFSDATA chunk size", "hdfsdata.chunksize",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_chunkoffset,\r\n{ "HDFSDATA chunk offset", "hdfsdata.chunkoffset",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_datalength,\r\n{ "HDFSDATA length of data", "hdfsdata.datalength",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_inblockoffset,\r\n{ "HDFSDATA in block offset", "hdfsdata.inblockoffset",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_seqnum,\r\n{ "HDFSDATA sequence number", "hdfsdata.seqnum",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_last,\r\n{ "HDFSDATA last packet in block", "hdfsdata.last",\r\nFT_INT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_datalen,\r\n{ "HDFSDATA length of data", "hdfsdata.datalen",\r\nFT_INT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_crc32,\r\n{ "HDFSDATA crc32 checksum", "hdfsdata.crc32",\r\nFT_INT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_rest,\r\n{ "HDFSDATA data", "hdfsdata.rest",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_packetsize,\r\n{ "HDFSDATA packet size", "hdfsdata.packetsize",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_chunklength,\r\n{ "HDFSDATA chunk length", "hdfsdata.chunklength",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_crc64,\r\n{ "HDFSDATA crc64 checksum", "hdfsdata.crc64",\r\nFT_INT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hdfsdata_pipelinestatus,\r\n{ "HDFSDATA pipeline status", "hdfsdata.pipelinestatus",\r\nFT_INT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_hdfsdata\r\n};\r\nmodule_t *hdfsdata_module;\r\nproto_hdfsdata = proto_register_protocol (\r\n"HDFSDATA Protocol",\r\n"HDFSDATA",\r\n"hdfsdata"\r\n);\r\nproto_register_field_array(proto_hdfsdata, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nhdfsdata_module = prefs_register_protocol(proto_hdfsdata, proto_reg_handoff_hdfsdata);\r\nprefs_register_uint_preference(hdfsdata_module,\r\n"tcp.port",\r\n"TCP port for HDFSDATA",\r\n"Set the TCP port for HDFSDATA",\r\n10,\r\n&tcp_port);\r\nhdfsdata_handle = register_dissector("hdfsdata", dissect_hdfsdata, proto_hdfsdata);\r\n}\r\nvoid\r\nproto_reg_handoff_hdfsdata(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic guint saved_tcp_port;\r\nif (!initialized) {\r\ndissector_add_for_decode_as("tcp.port", hdfsdata_handle);\r\ninitialized = TRUE;\r\n} else if (saved_tcp_port != 0) {\r\ndissector_delete_uint("tcp.port", saved_tcp_port, hdfsdata_handle);\r\n}\r\nif (tcp_port != 0) {\r\ndissector_add_uint("tcp.port", tcp_port, hdfsdata_handle);\r\n}\r\nsaved_tcp_port = tcp_port;\r\n}

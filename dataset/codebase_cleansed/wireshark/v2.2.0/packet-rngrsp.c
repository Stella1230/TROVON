static int\r\ndissect_rngrsp (tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree, void* data _U_)\r\n{\r\nproto_item *it;\r\nproto_tree *rngrsp_tree;\r\nproto_item *rngrsptlv_item;\r\nproto_tree *rngrsptlv_tree;\r\nguint8 tlvtype, tlvlen;\r\nint pos;\r\ngint length;\r\nguint8 upchid;\r\nguint16 sid;\r\nsid = tvb_get_ntohs (tvb, 0);\r\nupchid = tvb_get_guint8 (tvb, 2);\r\nif (upchid > 0)\r\ncol_add_fstr (pinfo->cinfo, COL_INFO,\r\n"Ranging Response: SID = %u, Upstream Channel = %u (U%u)",\r\nsid, upchid, upchid - 1);\r\nelse\r\ncol_add_fstr (pinfo->cinfo, COL_INFO,\r\n"Ranging Response: SID = %u, Telephony Return", sid);\r\nit = proto_tree_add_protocol_format (tree, proto_docsis_rngrsp, tvb, 0, -1,\r\n"Ranging Response");\r\nrngrsp_tree = proto_item_add_subtree (it, ett_docsis_rngrsp);\r\nproto_tree_add_item (rngrsp_tree, hf_docsis_rngrsp_sid, tvb, 0, 2,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item (rngrsp_tree, hf_docsis_rngrsp_upstream_chid, tvb,\r\n2, 1, ENC_BIG_ENDIAN);\r\nlength = tvb_reported_length (tvb);\r\npos = 3;\r\nwhile (pos < length)\r\n{\r\ntlvtype = tvb_get_guint8 (tvb, pos);\r\nrngrsptlv_tree = proto_tree_add_subtree(rngrsp_tree, tvb, pos, -1,\r\nett_docsis_rngrsptlv, &rngrsptlv_item,\r\nval_to_str(tlvtype, rngrsp_tlv_vals,\r\n"Unknown TLV (%u)"));\r\nproto_tree_add_uint (rngrsptlv_tree, hf_docsis_rngrsp_type,\r\ntvb, pos, 1, tlvtype);\r\npos++;\r\ntlvlen = tvb_get_guint8 (tvb, pos);\r\nproto_tree_add_uint (rngrsptlv_tree, hf_docsis_rngrsp_length,\r\ntvb, pos, 1, tlvlen);\r\npos++;\r\nproto_item_set_len(rngrsptlv_item, tlvlen + 2);\r\nswitch (tlvtype)\r\n{\r\ncase RNGRSP_TIMING:\r\nif (tlvlen == 4)\r\n{\r\nproto_tree_add_item (rngrsptlv_tree,\r\nhf_docsis_rngrsp_timing_adj, tvb, pos,\r\ntlvlen, ENC_BIG_ENDIAN);\r\n}\r\npos = pos + tlvlen;\r\nbreak;\r\ncase RNGRSP_PWR_LEVEL_ADJ:\r\nif (tlvlen == 1)\r\n{\r\nproto_tree_add_item (rngrsptlv_tree, hf_docsis_rngrsp_power_adj,\r\ntvb, pos, tlvlen, ENC_NA);\r\n}\r\npos = pos + tlvlen;\r\nbreak;\r\ncase RNGRSP_OFFSET_FREQ_ADJ:\r\nif (tlvlen == 2)\r\n{\r\nproto_tree_add_item (rngrsptlv_tree, hf_docsis_rngrsp_freq_adj,\r\ntvb, pos, tlvlen, ENC_BIG_ENDIAN);\r\n}\r\npos = pos + tlvlen;\r\nbreak;\r\ncase RNGRSP_TRANSMIT_EQ_ADJ:\r\nproto_tree_add_item (rngrsptlv_tree, hf_docsis_rngrsp_xmit_eq_adj,\r\ntvb, pos, tlvlen, ENC_NA);\r\npos = pos + tlvlen;\r\nbreak;\r\ncase RNGRSP_RANGING_STATUS:\r\nif (tlvlen == 1)\r\nproto_tree_add_item (rngrsptlv_tree,\r\nhf_docsis_rngrsp_ranging_status, tvb,\r\npos, tlvlen, ENC_BIG_ENDIAN);\r\npos = pos + tlvlen;\r\nbreak;\r\ncase RNGRSP_DOWN_FREQ_OVER:\r\nif (tlvlen == 4)\r\nproto_tree_add_item (rngrsptlv_tree,\r\nhf_docsis_rngrsp_down_freq_over, tvb,\r\npos, tlvlen, ENC_BIG_ENDIAN);\r\npos = pos + tlvlen;\r\nbreak;\r\ncase RNGRSP_UP_CHID_OVER:\r\nif (tlvlen == 1)\r\nproto_tree_add_item (rngrsptlv_tree,\r\nhf_docsis_rngrsp_upstream_ch_over, tvb,\r\npos, tlvlen, ENC_BIG_ENDIAN);\r\npos = pos + tlvlen;\r\nbreak;\r\ndefault:\r\npos = pos + tlvlen;\r\n}\r\n}\r\nreturn length;\r\n}\r\nvoid\r\nproto_register_docsis_rngrsp (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_docsis_rngrsp_type,\r\n{"Type", "docsis_rngrsp.type",\r\nFT_UINT8, BASE_DEC, VALS(rngrsp_tlv_vals), 0x0,\r\n"TLV Type", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_length,\r\n{"Length", "docsis_rngrsp.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"TLV Length", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_sid,\r\n{"Service Identifier", "docsis_rngrsp.sid",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_docsis_rngrsp_upstream_chid,\r\n{"Upstream Channel ID", "docsis_rngrsp.upchid",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_docsis_rngrsp_timing_adj,\r\n{"Timing Adjust (6.25us/64)", "docsis_rngrsp.timingadj",\r\nFT_INT32, BASE_DEC, NULL, 0x0,\r\n"Timing Adjust", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_power_adj,\r\n{"Power Level Adjust (0.25dB units)", "docsis_rngrsp.poweradj",\r\nFT_INT8, BASE_DEC, NULL, 0x0,\r\n"Power Level Adjust", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_freq_adj,\r\n{"Offset Freq Adjust (Hz)", "docsis_rngrsp.freqadj",\r\nFT_INT16, BASE_DEC, NULL, 0x0,\r\n"Frequency Adjust", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_xmit_eq_adj,\r\n{"Transmit Equalisation Adjust", "docsis_rngrsp.xmit_eq_adj",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Timing Equalisation Adjust", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_ranging_status,\r\n{"Ranging Status", "docsis_rngrsp.rng_stat",\r\nFT_UINT8, BASE_DEC, VALS (rng_stat_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_docsis_rngrsp_down_freq_over,\r\n{"Downstream Frequency Override (Hz)", "docsis_rngrsp.freq_over",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Downstream Frequency Override", HFILL}\r\n},\r\n{&hf_docsis_rngrsp_upstream_ch_over,\r\n{"Upstream Channel ID Override", "docsis_rngrsp.chid_override",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_docsis_rngrsp,\r\n&ett_docsis_rngrsptlv,\r\n};\r\nproto_docsis_rngrsp = proto_register_protocol ("DOCSIS Ranging Response",\r\n"DOCSIS RNG-RSP",\r\n"docsis_rngrsp");\r\nproto_register_field_array (proto_docsis_rngrsp, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\nregister_dissector ("docsis_rngrsp", dissect_rngrsp, proto_docsis_rngrsp);\r\n}\r\nvoid\r\nproto_reg_handoff_docsis_rngrsp (void)\r\n{\r\ndissector_handle_t docsis_rngrsp_handle;\r\ndocsis_rngrsp_handle = find_dissector ("docsis_rngrsp");\r\ndissector_add_uint ("docsis_mgmt", 0x05, docsis_rngrsp_handle);\r\n}

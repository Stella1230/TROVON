gint\r\ndissect_ascii_uint32(proto_tree *tree, gint hf_hex_ascii, gint ett_hex_ascii,\r\ngint hf_value, tvbuff_t *tvb, gint offset, guint32 *value)\r\n{\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint8 hex_ascii[5];\r\nDISSECTOR_ASSERT(value);\r\ntvb_memcpy(tvb, hex_ascii, offset, 4);\r\nhex_ascii[4]='\0';\r\nsub_item = proto_tree_add_item(tree, hf_hex_ascii, tvb, offset, 4, ENC_NA | ENC_ASCII);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_hex_ascii);\r\n*value = (guint32) g_ascii_strtoull(hex_ascii, NULL, 16);\r\nproto_tree_add_uint(sub_tree, hf_value, tvb, offset, 4, *value);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_adb_service(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nproto_item *main_item;\r\nproto_tree *main_tree;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\ngint offset = 0;\r\nadb_service_data_t *adb_service_data = (adb_service_data_t *) data;\r\nconst guint8 *service;\r\nwmem_tree_key_t key[5];\r\nwmem_tree_t *subtree;\r\nguint32 i_key;\r\nmain_item = proto_tree_add_item(tree, proto_adb_service, tvb, offset, -1, ENC_NA);\r\nmain_tree = proto_item_add_subtree(main_item, ett_adb_service);\r\nDISSECTOR_ASSERT(adb_service_data);\r\nservice = adb_service_data->service;\r\nsub_item = proto_tree_add_string(main_tree, hf_service, tvb, offset, 0, service);\r\nPROTO_ITEM_SET_GENERATED(sub_item);\r\nif (g_strcmp0(service, "host:version") == 0) {\r\nguint32 version;\r\nguint32 data_length;\r\ncontinuation_data_t *continuation_data;\r\nDISSECTOR_ASSERT_HINT(adb_service_data->session_key_length + 1 <= sizeof(key) / sizeof(key[0]), "Tree session key is too small");\r\nfor (i_key = 0; i_key < adb_service_data->session_key_length; i_key += 1) {\r\nkey[i_key].length = 1;\r\nkey[i_key].key = &adb_service_data->session_key[i_key];\r\n}\r\nkey[i_key].length = 0;\r\nkey[i_key].key = NULL;\r\nsubtree = (wmem_tree_t *) wmem_tree_lookup32_array(continuation_infos, key);\r\ncontinuation_data = (subtree) ? (continuation_data_t *) wmem_tree_lookup32_le(subtree, pinfo->num) : NULL;\r\nif (continuation_data && continuation_data->completed_in_frame < pinfo->num)\r\ncontinuation_data = NULL;\r\nif (!continuation_data || (continuation_data && continuation_data->length_in_frame == pinfo->num))\r\noffset = dissect_ascii_uint32(main_tree, hf_hex_ascii_length, ett_length, hf_length, tvb, offset, &data_length);\r\nif (!pinfo->fd->flags.visited && !continuation_data && tvb_reported_length_remaining(tvb, offset) < 4) {\r\nkey[i_key].length = 1;\r\nkey[i_key++].key = &pinfo->num;\r\nkey[i_key].length = 0;\r\nkey[i_key].key = NULL;\r\ncontinuation_data = wmem_new(wmem_file_scope(), continuation_data_t);\r\ncontinuation_data->length_in_frame = pinfo->num;\r\ncontinuation_data->completed_in_frame = G_MAXUINT32;\r\ncontinuation_data->length = data_length;\r\nwmem_tree_insert32_array(continuation_infos, key, continuation_data);\r\ncontinuation_data = NULL;\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) >= 4 ||\r\n(continuation_data && continuation_data->completed_in_frame == pinfo->num)) {\r\nif (!pinfo->fd->flags.visited && continuation_data) {\r\ncontinuation_data->completed_in_frame = pinfo->num;\r\n}\r\noffset = dissect_ascii_uint32(main_tree, hf_hex_ascii_version, ett_version, hf_version, tvb, offset, &version);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Version=%u", version);\r\n}\r\n} else if (g_strcmp0(service, "host:devices") == 0 ||\r\ng_strcmp0(service, "host:devices-l") == 0 ||\r\ng_strcmp0(service, "host:track-devices") == 0) {\r\nguint32 data_length;\r\noffset = dissect_ascii_uint32(main_tree, hf_hex_ascii_length, ett_length, hf_length, tvb, offset, &data_length);\r\nsub_item = proto_tree_add_item(main_tree, hf_devices, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\nif ((gint64) data_length < tvb_reported_length_remaining(tvb, offset)) {\r\nexpert_add_info(pinfo, sub_item, &ei_incomplete_message);\r\n}\r\n} else if (g_strcmp0(service, "host:get-state") == 0 ||\r\ng_strcmp0(service, "host:get-serialno") == 0 ||\r\ng_strcmp0(service, "host:get-devpath") == 0 ||\r\ng_str_has_prefix(service, "connect:") ||\r\ng_str_has_prefix(service, "disconnect:")) {\r\nguint32 data_length;\r\noffset = dissect_ascii_uint32(main_tree, hf_hex_ascii_length, ett_length, hf_length, tvb, offset, &data_length);\r\nsub_item = proto_tree_add_item(main_tree, hf_result, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\nif ((gint64) data_length < tvb_reported_length_remaining(tvb, offset)) {\r\nexpert_add_info(pinfo, sub_item, &ei_incomplete_message);\r\n}\r\n} else if (g_str_has_prefix(service, "framebuffer:")) {\r\nframebuffer_data_t *framebuffer_data = NULL;\r\nDISSECTOR_ASSERT_HINT(adb_service_data->session_key_length + 1 <= sizeof(key) / sizeof(key[0]), "Tree session key is too small");\r\nfor (i_key = 0; i_key < adb_service_data->session_key_length; i_key += 1) {\r\nkey[i_key].length = 1;\r\nkey[i_key].key = &adb_service_data->session_key[i_key];\r\n}\r\nkey[i_key].length = 0;\r\nkey[i_key].key = NULL;\r\nsubtree = (wmem_tree_t *) wmem_tree_lookup32_array(framebuffer_infos, key);\r\nframebuffer_data = (subtree) ? (framebuffer_data_t *) wmem_tree_lookup32_le(subtree, pinfo->num) : NULL;\r\nif (framebuffer_data && framebuffer_data->completed_in_frame < pinfo->num)\r\nframebuffer_data = NULL;\r\nif (!pinfo->fd->flags.visited && !framebuffer_data) {\r\nkey[i_key].length = 1;\r\nkey[i_key++].key = &pinfo->num;\r\nkey[i_key].length = 0;\r\nkey[i_key].key = NULL;\r\nframebuffer_data = wmem_new(wmem_file_scope(), framebuffer_data_t);\r\nframebuffer_data->data_in = pinfo->num;\r\nframebuffer_data->current_size = 0;\r\nframebuffer_data->completed_in_frame = G_MAXUINT32;\r\nframebuffer_data->size = tvb_get_letohl(tvb, offset + 4 * 2);\r\nframebuffer_data->red_offset = tvb_get_letohl(tvb, offset + 4 * 5);\r\nframebuffer_data->red_length = tvb_get_letohl(tvb, offset + 4 * 6);\r\nframebuffer_data->green_offset = tvb_get_letohl(tvb, offset + 4 * 7);\r\nframebuffer_data->green_length = tvb_get_letohl(tvb, offset + 4 * 8);\r\nframebuffer_data->blue_offset = tvb_get_letohl(tvb, offset + 4 * 9);\r\nframebuffer_data->blue_length = tvb_get_letohl(tvb, offset + 4 * 10);\r\nframebuffer_data->alpha_offset = tvb_get_letohl(tvb, offset + 4 * 11);\r\nframebuffer_data->alpha_length = tvb_get_letohl(tvb, offset + 4 * 12);\r\nwmem_tree_insert32_array(framebuffer_infos, key, framebuffer_data);\r\n}\r\nif (framebuffer_data && framebuffer_data->data_in == pinfo->num) {\r\nproto_tree_add_item(main_tree, hf_framebuffer_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_depth, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_width, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_height, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_red_offset, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_red_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_blue_offset, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_blue_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_green_offset, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_green_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_alpha_offset, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(main_tree, hf_framebuffer_alpha_length, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nsub_item = proto_tree_add_item(main_tree, hf_data, tvb, offset, -1, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_data);\r\nif (!pinfo->fd->flags.visited && framebuffer_data) {\r\nframebuffer_data->current_size += tvb_captured_length_remaining(tvb, offset);\r\nif (framebuffer_data->current_size >= framebuffer_data->size)\r\nframebuffer_data->completed_in_frame = pinfo->num;\r\n}\r\nif (pref_dissect_more_detail_framebuffer) {\r\nproto_item *pixel_item;\r\nproto_tree *pixel_tree;\r\nif (framebuffer_data &&\r\nframebuffer_data->red_length == 5 &&\r\nframebuffer_data->green_length == 6 &&\r\nframebuffer_data->blue_length == 5 &&\r\nframebuffer_data->red_offset == 11 &&\r\nframebuffer_data->green_offset == 5 &&\r\nframebuffer_data->blue_offset == 0) {\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nif (tvb_reported_length_remaining(tvb, offset) < 2) {\r\nproto_tree_add_item(main_tree, hf_fragment, tvb, offset, -1, ENC_NA);\r\noffset += 1;\r\n}\r\npixel_item = proto_tree_add_item(sub_tree, hf_framebuffer_pixel, tvb, offset, 2, ENC_NA);\r\npixel_tree = proto_item_add_subtree(pixel_item, ett_pixel);\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_blue_5, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_green_6, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_red_5, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\n}\r\n} else if (framebuffer_data &&\r\nframebuffer_data->red_length == 8 &&\r\nframebuffer_data->green_length == 8 &&\r\nframebuffer_data->blue_length == 8 &&\r\n(framebuffer_data->alpha_length == 0 ||\r\nframebuffer_data->alpha_length == 8)) {\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nif (tvb_reported_length_remaining(tvb, offset) < 3 || (tvb_reported_length_remaining(tvb, offset) < 4 && framebuffer_data->alpha_offset > 0)) {\r\nproto_tree_add_item(main_tree, hf_fragment, tvb, offset, -1, ENC_NA);\r\noffset = tvb_captured_length(tvb);\r\nbreak;\r\n}\r\npixel_item = proto_tree_add_item(sub_tree, hf_framebuffer_pixel, tvb, offset, 3, ENC_NA);\r\npixel_tree = proto_item_add_subtree(pixel_item, ett_pixel);\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_red, tvb, offset + framebuffer_data->red_offset / 8, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_green, tvb, offset + framebuffer_data->green_offset / 8, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_blue, tvb, offset + framebuffer_data->blue_offset / 8, 1, ENC_LITTLE_ENDIAN);\r\nif (framebuffer_data->alpha_offset > 0) {\r\nif (framebuffer_data->alpha_length == 0)\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_unused, tvb, offset + framebuffer_data->alpha_offset / 8, 1, ENC_LITTLE_ENDIAN);\r\nelse\r\nproto_tree_add_item(pixel_tree, hf_framebuffer_alpha, tvb, offset + framebuffer_data->alpha_offset / 8, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_item_set_len(pixel_item, 4);\r\n}\r\noffset += 3;\r\n}\r\n} else {\r\noffset = tvb_captured_length(tvb);\r\n}\r\n} else {\r\noffset = tvb_captured_length(tvb);\r\n}\r\n}\r\n} else if (g_strcmp0(service, "track-jdwp") == 0) {\r\nguint32 data_length;\r\noffset = dissect_ascii_uint32(main_tree, hf_hex_ascii_length, ett_length, hf_length, tvb, offset, &data_length);\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nsub_item = proto_tree_add_item(main_tree, hf_pids, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\nif ((gint64) data_length < tvb_reported_length_remaining(tvb, offset)) {\r\nexpert_add_info(pinfo, sub_item, &ei_incomplete_message);\r\n}\r\n}\r\noffset = tvb_captured_length(tvb);\r\n} else if ((g_strcmp0(service, "shell:export ANDROID_LOG_TAGS=\"\" ; exec logcat -B") == 0) ||\r\n(g_strcmp0(service, "shell:logcat -B") == 0)) {\r\ntvbuff_t *next_tvb;\r\ntvbuff_t *new_tvb;\r\nguint8 *buffer = NULL;\r\ngint size = 0;\r\ngint i_offset = offset;\r\ngint old_offset;\r\ngint i_char = 0;\r\nguint8 c1;\r\nguint8 c2 = '\0';\r\nguint16 payload_length;\r\nguint16 try_header_size;\r\ngint logcat_length = 0;\r\nfragment_t *fragment;\r\nDISSECTOR_ASSERT_HINT(adb_service_data->session_key_length + 1 <= sizeof(key) / sizeof(key[0]), "Tree session key is too small");\r\nfor (i_key = 0; i_key < adb_service_data->session_key_length; i_key += 1) {\r\nkey[i_key].length = 1;\r\nkey[i_key].key = &adb_service_data->session_key[i_key];\r\n}\r\nkey[i_key].length = 0;\r\nkey[i_key].key = NULL;\r\nsubtree = (wmem_tree_t *) wmem_tree_lookup32_array(fragments, key);\r\nfragment = (subtree) ? (fragment_t *) wmem_tree_lookup32_le(subtree, pinfo->num - 1) : NULL;\r\nif (fragment) {\r\nif (!pinfo->fd->flags.visited && fragment->reassembled_in_frame == -1)\r\nfragment->reassembled_in_frame = pinfo->num;\r\nif (fragment->reassembled_in_frame == pinfo->num) {\r\nsize += fragment->length;\r\ni_char += fragment->length;\r\n}\r\n}\r\nsize += tvb_reported_length_remaining(tvb, i_offset);\r\nif (size > 0) {\r\nbuffer = (guint8 *) wmem_alloc(pinfo->pool, size);\r\nif (fragment && i_char > 0)\r\nmemcpy(buffer, fragment->data, i_char);\r\nif (i_char >= 1 && buffer[i_char - 1] == '\r' && tvb_get_guint8(tvb, i_offset) == '\n') {\r\nbuffer[i_char - 1] = '\n';\r\ni_offset += 1;\r\n}\r\nc1 = tvb_get_guint8(tvb, i_offset);\r\ni_offset += 1;\r\nold_offset = i_offset;\r\nwhile (tvb_reported_length_remaining(tvb, i_offset) > 0) {\r\nc2 = tvb_get_guint8(tvb, i_offset);\r\nif (c1 == '\r' && c2 == '\n') {\r\nbuffer[i_char] = c2;\r\nif (tvb_reported_length_remaining(tvb, i_offset) > 1) {\r\nc1 = tvb_get_guint8(tvb, i_offset + 1);\r\ni_offset += 2;\r\ni_char += 1;\r\n} else {\r\ni_offset += 1;\r\n}\r\ncontinue;\r\n}\r\nbuffer[i_char] = c1;\r\nc1 = c2;\r\ni_char += 1;\r\ni_offset += 1;\r\n}\r\nif (tvb_reported_length_remaining(tvb, old_offset) == 0) {\r\nbuffer[i_char] = c1;\r\ni_char += 1;\r\n} else if (tvb_reported_length_remaining(tvb, old_offset) > 0) {\r\nbuffer[i_char] = c2;\r\ni_char += 1;\r\n}\r\nnext_tvb = tvb_new_child_real_data(tvb, buffer, i_char, i_char);\r\nadd_new_data_source(pinfo, next_tvb, "Logcat");\r\ni_offset = 0;\r\nwhile (tvb_reported_length_remaining(next_tvb, i_offset) > 0) {\r\nif (tvb_reported_length_remaining(next_tvb, i_offset) >= 4) {\r\npayload_length = tvb_get_letohs(next_tvb, i_offset);\r\ntry_header_size = tvb_get_letohs(next_tvb, i_offset + 2);\r\nif (try_header_size != 24)\r\nlogcat_length = payload_length + 20;\r\nelse\r\nlogcat_length = payload_length + 24;\r\n}\r\nif (tvb_reported_length_remaining(next_tvb, i_offset) >= 4 && tvb_reported_length_remaining(next_tvb, i_offset) >= logcat_length) {\r\nnew_tvb = tvb_new_subset_length(next_tvb, i_offset, logcat_length);\r\ncall_dissector(logcat_handle, new_tvb, pinfo, main_tree);\r\ni_offset += logcat_length;\r\n} else {\r\nif (!pinfo->fd->flags.visited) {\r\nDISSECTOR_ASSERT_HINT(adb_service_data->session_key_length + 2 <= sizeof(key) / sizeof(key[0]), "Tree session key is too small");\r\nfor (i_key = 0; i_key < adb_service_data->session_key_length; i_key += 1) {\r\nkey[i_key].length = 1;\r\nkey[i_key].key = &adb_service_data->session_key[i_key];\r\n}\r\nkey[i_key].length = 1;\r\nkey[i_key++].key = &pinfo->num;\r\nkey[i_key].length = 0;\r\nkey[i_key].key = NULL;\r\nfragment = wmem_new(wmem_file_scope(), fragment_t);\r\nfragment->length = tvb_captured_length_remaining(next_tvb, i_offset);\r\nfragment->data = (guint8 *) wmem_alloc(wmem_file_scope(), fragment->length);\r\ntvb_memcpy(next_tvb, fragment->data, i_offset, fragment->length);\r\nfragment->reassembled_in_frame = -1;\r\nwmem_tree_insert32_array(fragments, key, fragment);\r\n}\r\nproto_tree_add_item(main_tree, hf_fragment, next_tvb, i_offset, -1, ENC_NA);\r\ni_offset = tvb_captured_length(next_tvb);\r\n}\r\n}\r\n}\r\noffset = tvb_captured_length(tvb);\r\n} else if (g_str_has_prefix(service, "shell:")) {\r\nif (adb_service_data->direction == P2P_DIR_SENT) {\r\nproto_tree_add_item(main_tree, hf_stdin, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Stdin=<%s>", tvb_format_text_wsp(tvb, offset, tvb_captured_length_remaining(tvb, offset)));\r\n} else {\r\nproto_tree_add_item(main_tree, hf_stdout, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Stdout=<%s>", tvb_format_text_wsp(tvb, offset, tvb_captured_length_remaining(tvb, offset)));\r\n}\r\noffset = tvb_captured_length(tvb);\r\n} else if (g_str_has_prefix(service, "jdwp:")) {\r\nproto_tree_add_item(main_tree, hf_data, tvb, offset, -1, ENC_NA);\r\noffset = tvb_captured_length(tvb);\r\n} else if (g_str_has_prefix(service, "sync:")) {\r\nproto_tree_add_item(main_tree, hf_data, tvb, offset, -1, ENC_NA);\r\noffset = tvb_captured_length(tvb);\r\n} else if (g_strcmp0(service, "host:list-forward") == 0 ||\r\ng_str_has_prefix(service, "root:") ||\r\ng_str_has_prefix(service, "remount:") ||\r\ng_str_has_prefix(service, "tcpip:") ||\r\ng_str_has_prefix(service, "usb:")) {\r\nif (tvb_reported_length_remaining(tvb, offset)) {\r\nproto_tree_add_item(main_tree, hf_result, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Result=<%s>", tvb_format_text_wsp(tvb, offset, tvb_captured_length_remaining(tvb, offset)));\r\noffset = tvb_captured_length(tvb);\r\n}\r\n} else {\r\nproto_tree_add_item(main_tree, hf_data, tvb, offset, -1, ENC_NA);\r\noffset = tvb_captured_length(tvb);\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_adb_service(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t *expert_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_service,\r\n{ "Service", "adb_service.service",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fragment,\r\n{ "Fragment", "adb_service.fragment",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_data,\r\n{ "Data", "adb_service.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hex_ascii_length,\r\n{ "Hex ASCII String Length", "adb_service.hex_ascii_length",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_length,\r\n{ "Length", "adb_service.length",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_version,\r\n{ "Version", "adb_service.framebuffer.version",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hex_ascii_version,\r\n{ "Hex ASCII String Version", "adb_service.hex_ascii_version",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_version,\r\n{ "Version", "adb_service.version",\r\nFT_UINT32, BASE_DEC_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_depth,\r\n{ "Depth", "adb_service.framebuffer.depth",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_size,\r\n{ "Size", "adb_service.framebuffer.size",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_width,\r\n{ "Width", "adb_service.framebuffer.width",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_height,\r\n{ "Height", "adb_service.framebuffer.height",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_red_offset,\r\n{ "Red Offset", "adb_service.framebuffer.red_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_red_length,\r\n{ "Red Length", "adb_service.framebuffer.red_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_blue_offset,\r\n{ "Blue Offset", "adb_service.framebuffer.blue_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_blue_length,\r\n{ "Blue Length", "adb_service.framebuffer.blue_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_green_offset,\r\n{ "Green Offset", "adb_service.framebuffer.green_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_green_length,\r\n{ "Green Length", "adb_service.framebuffer.green_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_alpha_offset,\r\n{ "Alpha Offset", "adb_service.framebuffer.alpha_offset",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_alpha_length,\r\n{ "Alpha Length", "adb_service.framebuffer.alpha_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_pixel,\r\n{ "Pixel", "adb_service.framebuffer.pixel",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_blue_5,\r\n{ "Blue", "adb_service.framebuffer.pixel.blue",\r\nFT_UINT16, BASE_DEC, NULL, 0xF800,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_green_6,\r\n{ "Green", "adb_service.framebuffer.pixel.green",\r\nFT_UINT16, BASE_DEC, NULL, 0x07E0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_red_5,\r\n{ "Red", "adb_service.framebuffer.pixel.red",\r\nFT_UINT16, BASE_DEC, NULL, 0x001F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_blue,\r\n{ "Blue", "adb_service.framebuffer.pixel.blue",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_green,\r\n{ "Green", "adb_service.framebuffer.pixel.green",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_red,\r\n{ "Red", "adb_service.framebuffer.pixel.red",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_alpha,\r\n{ "Alpha", "adb_service.framebuffer.pixel.alpha",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_framebuffer_unused,\r\n{ "Unused", "adb_service.framebuffer.pixel.unused",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_devices,\r\n{ "Devices", "adb_service.devices",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_stdin,\r\n{ "Stdin", "adb_service.stdin",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_stdout,\r\n{ "Stdout", "adb_service.stdout",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_result,\r\n{ "Result", "adb_service.result",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_pids,\r\n{ "PIDs", "adb_service.pids",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_id,\r\n{ "Id", "adb_service.sync.id",\r\nFT_STRING, STR_ASCII, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_length,\r\n{ "Length", "adb_service.sync.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_mode,\r\n{ "Mode", "adb_service.sync.mode",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_size,\r\n{ "Size", "adb_service.sync.size",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_time,\r\n{ "Last Modification Time", "adb_service.sync.time",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_unused,\r\n{ "Unused", "adb_service.sync.unused",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sync_data,\r\n{ "Sync Data", "adb_service.sync.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_adb_service,\r\n&ett_length,\r\n&ett_version,\r\n&ett_pixel,\r\n&ett_data\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_incomplete_message, { "adb_service.expert.incomplete_message", PI_PROTOCOL, PI_WARN, "Incomplete message", EXPFILL }},\r\n};\r\nfragments = wmem_tree_new_autoreset(wmem_epan_scope(), wmem_file_scope());\r\nframebuffer_infos = wmem_tree_new_autoreset(wmem_epan_scope(), wmem_file_scope());\r\ncontinuation_infos = wmem_tree_new_autoreset(wmem_epan_scope(), wmem_file_scope());\r\nproto_adb_service = proto_register_protocol("Android Debug Bridge Service", "ADB Service", "adb_service");\r\nadb_service_handle = register_dissector("adb_service", dissect_adb_service, proto_adb_service);\r\nproto_register_field_array(proto_adb_service, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_module = expert_register_protocol(proto_adb_service);\r\nexpert_register_field_array(expert_module, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_adb_service, NULL);\r\nprefs_register_static_text_preference(module, "version",\r\n"ADB Service protocol version is compatible prior to: adb 1.0.31",\r\n"Version of protocol supported by this dissector.");\r\nprefs_register_bool_preference(module, "framebuffer_more_details",\r\n"Dissect more detail for framebuffer service",\r\n"Dissect more detail for framebuffer service",\r\n&pref_dissect_more_detail_framebuffer);\r\n}\r\nvoid\r\nproto_reg_handoff_adb_service(void)\r\n{\r\nlogcat_handle = find_dissector_add_dependency("logcat", proto_adb_service);\r\n}

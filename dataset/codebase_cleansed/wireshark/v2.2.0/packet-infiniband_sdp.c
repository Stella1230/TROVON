static int\r\ndissect_ib_sdp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nint local_offset = 0;\r\nproto_item *SDP_header_item = NULL;\r\nproto_tree *SDP_header_tree = NULL;\r\nproto_item *SDP_BSDH_header_item = NULL;\r\nproto_tree *SDP_BSDH_header_tree = NULL;\r\nproto_item *SDP_EH_header_item = NULL;\r\nproto_tree *SDP_EH_header_tree = NULL;\r\nguint8 mid;\r\nconversation_t *conv;\r\nconversation_infiniband_data *convo_data = NULL;\r\ndissector_handle_t infiniband_handle;\r\nif (tvb_captured_length(tvb) < 16)\r\nreturn 0;\r\nif (gPREF_MAN_EN) {\r\nif ( (addresses_equal(&pinfo->src, &manual_addr[0]) &&\r\naddresses_equal(&pinfo->dst, &manual_addr[1]) &&\r\n(pinfo->srcport == 0xffffffff || pinfo->srcport == gPREF_QP[0]) &&\r\n(pinfo->destport == 0xffffffff || pinfo->destport == gPREF_QP[1])) ||\r\n(addresses_equal(&pinfo->src, &manual_addr[1]) &&\r\naddresses_equal(&pinfo->dst, &manual_addr[0]) &&\r\n(pinfo->srcport == 0xffffffff || pinfo->srcport == gPREF_QP[1]) &&\r\n(pinfo->destport == 0xffffffff || pinfo->destport == gPREF_QP[0])) )\r\ngoto manual_override;\r\n}\r\nconv = find_conversation(pinfo->num, &pinfo->src, &pinfo->dst,\r\nPT_IBQP, pinfo->srcport, pinfo->destport, 0);\r\nif (!conv) {\r\nconv = find_conversation(pinfo->num, &pinfo->dst, &pinfo->dst,\r\nPT_IBQP, pinfo->destport, pinfo->destport, NO_ADDR_B|NO_PORT_B);\r\nif (!conv)\r\nreturn 0;\r\n}\r\nif (proto_infiniband < 0) {\r\ninfiniband_handle = find_dissector("infiniband");\r\nif (!infiniband_handle)\r\nreturn 0;\r\nproto_infiniband = dissector_handle_get_protocol_index(infiniband_handle);\r\n}\r\nconvo_data = (conversation_infiniband_data *)conversation_get_proto_data(conv, proto_infiniband);\r\nif (!convo_data)\r\nreturn 0;\r\nif (!(convo_data->service_id & SERVICE_ID_MASK))\r\nreturn 0;\r\nmanual_override:\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SDP");\r\nSDP_header_item = proto_tree_add_item(tree, proto_ib_sdp, tvb, local_offset, -1, ENC_NA);\r\nSDP_header_tree = proto_item_add_subtree(SDP_header_item, ett_ib_sdp);\r\nSDP_BSDH_header_item = proto_tree_add_item(SDP_header_tree, hf_ib_sdp_bsdh, tvb, local_offset, 16, ENC_NA);\r\nSDP_BSDH_header_tree = proto_item_add_subtree(SDP_BSDH_header_item, ett_ib_sdp_bsdh);\r\nmid = tvb_get_guint8(tvb, local_offset);\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_mid, tvb, local_offset, 1, ENC_BIG_ENDIAN); local_offset += 1;\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_flags, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_flags_oobpres, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_flags_oob_pend, tvb, local_offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_flags_reqpipe, tvb, local_offset, 4, ENC_BIG_ENDIAN); local_offset += 1;\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_bufs, tvb, local_offset, 2, ENC_BIG_ENDIAN); local_offset += 2;\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_len, tvb, local_offset, 4, ENC_BIG_ENDIAN); local_offset += 4;\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_mseq, tvb, local_offset, 4, ENC_BIG_ENDIAN); local_offset += 4;\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_mseqack, tvb, local_offset, 4, ENC_BIG_ENDIAN); local_offset += 4;\r\nswitch (mid) {\r\ncase Hello:\r\nSDP_EH_header_item = proto_tree_add_item(SDP_header_tree, hf_ib_sdp_hh, tvb, local_offset, 48, ENC_NA);\r\nSDP_EH_header_tree = proto_item_add_subtree(SDP_EH_header_item, ett_ib_sdp_hh);\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_majv, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_minv, tvb, local_offset, 1, ENC_BIG_ENDIAN); local_offset += 1;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_ipv, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_cap, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_cap_invalidate, tvb, local_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_cap_extmaxadverts, tvb, local_offset, 1, ENC_BIG_ENDIAN); local_offset += 1;\r\nlocal_offset += 1;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_maxadverts, tvb, local_offset, 1, ENC_BIG_ENDIAN); local_offset += 1;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_desremrcvsz, tvb, local_offset, 4, ENC_BIG_ENDIAN); local_offset += 4;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_localrcvsz, tvb, local_offset, 4, ENC_BIG_ENDIAN); local_offset += 4;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_localport, tvb, local_offset, 2, ENC_BIG_ENDIAN); local_offset += 2;\r\nlocal_offset += 2;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_src_ip, tvb, local_offset, 16, ENC_NA); local_offset += 16;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_dst_ip, tvb, local_offset, 16, ENC_NA); local_offset += 16;\r\nlocal_offset += 2;\r\nproto_tree_add_item(SDP_EH_header_tree, hf_ib_sdp_extmaxadverts, tvb, local_offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase HelloAck:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_hah, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase DisConn:\r\nbreak;\r\ncase AbortConn:\r\nbreak;\r\ncase SendSm:\r\nbreak;\r\ncase RdmaWrCompl:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_rwch, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase RdmaRdCompl:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_rrch, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase ModeChange:\r\nproto_tree_add_item(SDP_BSDH_header_tree, hf_ib_sdp_mch, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase SrcAvailCancel:\r\nbreak;\r\ncase SinkAvailCancel:\r\nbreak;\r\ncase SinkCancelAck:\r\nbreak;\r\ncase ChRcvBuf:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_crbh, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase ChRcvBufAck:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_crbah, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase SuspComm:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_suspch, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase SuspCommAck:\r\nbreak;\r\ncase SinkAvail:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_sinkah, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase SrcAvail:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_srcah, tvb, local_offset, 48, ENC_NA);\r\nbreak;\r\ncase Data:\r\nproto_tree_add_item(SDP_header_tree, hf_ib_sdp_data, tvb, local_offset, -1, ENC_NA);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "(SDP %s)",\r\nrval_to_str(mid, mid_meanings, "Unknown"));\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ib_sdp(void)\r\n{\r\nmodule_t *ib_sdp_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ib_sdp_bsdh, {\r\n"BSDH", "infiniband_sdp.bsdh",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{ &hf_ib_sdp_mid, {\r\n"MID", "infiniband_sdp.bsdh.mid",\r\nFT_UINT8, BASE_HEX|BASE_RANGE_STRING, RVALS(mid_meanings), 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_flags, {\r\n"Flags", "infiniband_sdp.bsdh.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_flags_oobpres, {\r\n"OOB_PRES", "infiniband_sdp.bsdh.oobpres",\r\nFT_UINT8, BASE_HEX, NULL, 0x1, "Out-Of-Band Data is present", HFILL}\r\n},\r\n{&hf_ib_sdp_flags_oob_pend, {\r\n"OOB_PEND", "infiniband_sdp.bsdh.oobpend",\r\nFT_UINT8, BASE_HEX, NULL, 0x2, "Out-Of-Band Data is pending", HFILL}\r\n},\r\n{&hf_ib_sdp_flags_reqpipe, {\r\n"REQ_PIPE", "infiniband_sdp.bsdh.reqpipe",\r\nFT_UINT8, BASE_HEX, NULL, 0x4, "Request change to Pipelined Mode", HFILL}\r\n},\r\n{&hf_ib_sdp_bufs, {\r\n"Buffers", "infiniband_sdp.bsdh.bufs",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_len, {\r\n"Length", "infiniband_sdp.bsdh.len",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_mseq, {\r\n"MSeq", "infiniband_sdp.bsdh.mseq",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, "Message Sequence Number", HFILL}\r\n},\r\n{&hf_ib_sdp_mseqack, {\r\n"MSeqAck", "infiniband_sdp.bsdh.mseqack",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, "Message Sequence Number Acknowledgement", HFILL}\r\n},\r\n{&hf_ib_sdp_hh, {\r\n"Hello Header", "infiniband_sdp.hh",\r\nFT_NONE, BASE_NONE, NULL, 0x00, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_majv, {\r\n"Major Protocol Version Number", "infiniband_sdp.hh.majv",\r\nFT_UINT8, BASE_HEX, NULL, 0xf0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_minv, {\r\n"Minor Protocol Version Number", "infiniband_sdp.hh.minv",\r\nFT_UINT8, BASE_HEX, NULL, 0x0f, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_ipv,\r\n{"IP version", "infiniband_sdp.hh.ipv",\r\nFT_UINT8, BASE_HEX, NULL, 0xf0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_cap, {\r\n"Capabilities", "infiniband_sdp.hh.cap",\r\nFT_UINT8, BASE_HEX, NULL, 0x0f, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_cap_invalidate, {\r\n"INVALIDATE_CAP", "infiniband_sdp.hh.cap_invalidate",\r\nFT_UINT8, BASE_HEX, NULL, 0x1, "Supports incoming Send w/Invalidate opcode", HFILL}\r\n},\r\n{&hf_ib_sdp_cap_extmaxadverts, {\r\n"EXTENDED_MAXADVERTS", "infiniband_sdp.hh.cap_extmaxadverts",\r\nFT_UINT8, BASE_HEX, NULL, 0x2, "Extended MaxAdverts is used", HFILL}\r\n},\r\n{&hf_ib_sdp_maxadverts, {\r\n"Maximum Advertisements", "infiniband_sdp.hh.maxadverts",\r\nFT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_desremrcvsz, {\r\n"DesRemRcvSz", "infiniband_sdp.hh.desremrcvsz",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, "Desired Remote Receive Size", HFILL}\r\n},\r\n{&hf_ib_sdp_localrcvsz,\r\n{"LocalRcvSz", "infiniband_sdp.hh.localrcvsz",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, "Local Receive Size", HFILL}\r\n},\r\n{&hf_ib_sdp_localport, {\r\n"Local Port", "infiniband_sdp.hh.localport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_src_ip, {\r\n"Source IP", "infiniband_sdp.hh.src_ip",\r\nFT_IPv6, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_dst_ip, {\r\n"Destination IP", "infiniband_sdp.hh.dst_ip",\r\nFT_IPv6, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_extmaxadverts, {\r\n"Extended MaxAdverts", "infiniband_sdp.hh.extmaxadverts",\r\nFT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_hah, {\r\n"HelloAck Header", "infiniband_sdp.hah",\r\nFT_NONE, BASE_NONE, NULL, 0x00, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_rwch, {\r\n"RdmaWrCompl Header", "infiniband_sdp.rwch",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "RDMA Write Complete", HFILL}\r\n},\r\n{&hf_ib_sdp_rrch, {\r\n"RdmaRdCompl Header", "infiniband_sdp.rrch",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "RDMA Read Complete", HFILL}\r\n},\r\n{&hf_ib_sdp_mch, {\r\n"ModeChange Header", "infiniband_sdp.mch",\r\nFT_NONE, BASE_NONE, NULL, 0x00, NULL, HFILL}\r\n},\r\n{&hf_ib_sdp_crbh, {\r\n"ChRcvBuf Header", "infiniband_sdp.crbh",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "Change Receive private Buffer size", HFILL}\r\n},\r\n{&hf_ib_sdp_crbah, {\r\n"ChRcvBufAck Header", "infiniband_sdp.crbah",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "Change Receive private Buffer size Acknowledgement", HFILL}\r\n},\r\n{&hf_ib_sdp_suspch, {\r\n"SuspComm Header", "infiniband_sdp.suspch",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "Suspend Communication", HFILL}\r\n},\r\n{&hf_ib_sdp_sinkah, {\r\n"SinkAvail Header", "infiniband_sdp.sinkah",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "Data Sink Available", HFILL}\r\n},\r\n{&hf_ib_sdp_srcah, {\r\n"SrcAvail Header", "infiniband_sdp.srcah",\r\nFT_NONE, BASE_NONE, NULL, 0x00, "Data Source Available", HFILL}\r\n},\r\n{&hf_ib_sdp_data, {\r\n"Data", "infiniband_sdp.Data",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL}\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ib_sdp,\r\n&ett_ib_sdp_bsdh,\r\n&ett_ib_sdp_hh,\r\n};\r\nproto_ib_sdp = proto_register_protocol("Infiniband Sockets Direct Protocol", "Infiniband SDP", "infiniband_sdp");\r\nregister_dissector("infiniband_sdp", dissect_ib_sdp, proto_ib_sdp);\r\nproto_register_field_array(proto_ib_sdp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nib_sdp_module = prefs_register_protocol(proto_ib_sdp, proto_reg_handoff_ib_sdp);\r\nprefs_register_bool_preference(ib_sdp_module, "manual_en", "Enable manual settings",\r\n"Check to treat all traffic between the configured source/destination as SDP",\r\n&gPREF_MAN_EN);\r\nprefs_register_static_text_preference(ib_sdp_module, "addr_a", "Address A",\r\n"Side A of the manually-configured connection");\r\nprefs_register_enum_preference(ib_sdp_module, "addr_a_type", "Address Type",\r\n"Type of address specified", &gPREF_TYPE[0], pref_address_types, FALSE);\r\nprefs_register_string_preference(ib_sdp_module, "addr_a_id", "ID",\r\n"LID/GID of address A", &gPREF_ID[0]);\r\nprefs_register_uint_preference(ib_sdp_module, "addr_a_qp", "QP Number",\r\n"QP Number for address A", 10, &gPREF_QP[0]);\r\nprefs_register_static_text_preference(ib_sdp_module, "addr_b", "Address B",\r\n"Side B of the manually-configured connection");\r\nprefs_register_enum_preference(ib_sdp_module, "addr_b_type", "Address Type",\r\n"Type of address specified", &gPREF_TYPE[1], pref_address_types, FALSE);\r\nprefs_register_string_preference(ib_sdp_module, "addr_b_id", "ID",\r\n"LID/GID of address B", &gPREF_ID[1]);\r\nprefs_register_uint_preference(ib_sdp_module, "addr_b_qp", "QP Number",\r\n"QP Number for address B", 10, &gPREF_QP[1]);\r\n}\r\nvoid\r\nproto_reg_handoff_ib_sdp(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nif (!initialized) {\r\nheur_dissector_add("infiniband.payload", dissect_ib_sdp, "Infiniband SDP", "sdp_infiniband", proto_ib_sdp, HEURISTIC_ENABLE);\r\nheur_dissector_add("infiniband.mad.cm.private", dissect_ib_sdp, "Infiniband SDP in PrivateData of CM packets", "sdp_ib_private", proto_ib_sdp, HEURISTIC_ENABLE);\r\nmanual_addr_data[0] = wmem_alloc(wmem_epan_scope(), GID_SIZE);\r\nmanual_addr_data[1] = wmem_alloc(wmem_epan_scope(), GID_SIZE);\r\ninitialized = TRUE;\r\n}\r\nif (gPREF_MAN_EN) {\r\ngboolean error_occured = FALSE;\r\nchar *not_parsed;\r\nint i;\r\nfor (i = 0; i < 2; i++) {\r\nif (gPREF_ID[i][0] == '\0') {\r\nerror_occured = TRUE;\r\n} else if (gPREF_TYPE[i] == 0) {\r\nerrno = 0;\r\n*((guint16*)manual_addr_data[i]) = (guint16)strtoul(gPREF_ID[i], &not_parsed, 0);\r\nif (errno || *not_parsed != '\0') {\r\nerror_occured = TRUE;\r\n} else {\r\nset_address(&manual_addr[i], AT_IB, sizeof(guint16), manual_addr_data[i]);\r\n}\r\n} else {\r\nif (!str_to_ip6(gPREF_ID[i], manual_addr_data[i])) {\r\nerror_occured = TRUE;\r\n} else {\r\nset_address(&manual_addr[i], AT_IB, GID_SIZE, manual_addr_data[i]);\r\n}\r\n}\r\nif (error_occured) {\r\ngPREF_MAN_EN = FALSE;\r\nbreak;\r\n}\r\n}\r\n}\r\n}

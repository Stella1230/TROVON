static int\r\ndissect_atn_cpdlc(\r\ntvbuff_t *tvb,\r\npacket_info *pinfo,\r\nproto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_tree *atn_cpdlc_tree = NULL;\r\natn_conversation_t *atn_cv = NULL;\r\nif((pinfo->clnp_dstref) && (!pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(\r\n&pinfo->dst,\r\npinfo->clnp_dstref,\r\n&pinfo->src );\r\n}\r\nif((!pinfo->clnp_dstref) && (pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(\r\n&pinfo->src,\r\npinfo->clnp_srcref,\r\n&pinfo->dst );\r\n}\r\nif((pinfo->clnp_dstref) && (pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(\r\n&pinfo->src,\r\npinfo->clnp_srcref,\r\n&pinfo->dst );\r\n}\r\nif(!atn_cv){\r\nreturn 0; }\r\natn_cpdlc_tree = proto_tree_add_subtree(\r\ntree, tvb, 0, -1, ett_atn_cpdlc, NULL,\r\nATN_CPDLC_PROTO );\r\nswitch(atn_cv->ae_qualifier){\r\ncase pmcpdlc:\r\nif( check_heur_msg_type(pinfo) == um ) {\r\ndissect_ProtectedGroundPDUs_PDU(\r\ntvb,\r\npinfo,\r\natn_cpdlc_tree, NULL);\r\n}else {\r\ndissect_ProtectedAircraftPDUs_PDU(\r\ntvb,\r\npinfo,\r\natn_cpdlc_tree, NULL);\r\n}\r\nbreak;\r\ncase cpdlc:\r\nif( check_heur_msg_type(pinfo) == um ) {\r\ndissect_GroundPDUs_PDU(\r\ntvb,\r\npinfo,\r\natn_cpdlc_tree, NULL);\r\n}else {\r\ndissect_AircraftPDUs_PDU(\r\ntvb,\r\npinfo,\r\natn_cpdlc_tree, NULL);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn tvb_reported_length_remaining(tvb, 0);\r\n}\r\nstatic gboolean\r\ndissect_atn_cpdlc_heur(\r\ntvbuff_t *tvb,\r\npacket_info *pinfo,\r\nproto_tree *tree,\r\nvoid *data _U_)\r\n{\r\natn_conversation_t *volatile atn_cv = NULL;\r\nvolatile gboolean is_atn_cpdlc = FALSE;\r\nvolatile gboolean is_pm = FALSE;\r\nint type;\r\ntype = check_heur_msg_type(pinfo);\r\nswitch(type){\r\ncase um:\r\nTRY {\r\ndissect_ProtectedGroundPDUs_PDU(tvb, pinfo, NULL, NULL);\r\nis_atn_cpdlc = TRUE;\r\nis_pm = TRUE;}\r\nCATCH_ALL{\r\nis_atn_cpdlc = FALSE;\r\nis_pm = FALSE;}\r\nENDTRY;\r\nif (is_atn_cpdlc) {\r\nbreak;\r\n}\r\nTRY {\r\ndissect_GroundPDUs_PDU(tvb, pinfo, NULL, NULL);\r\nis_pm = FALSE;\r\nis_atn_cpdlc = TRUE;}\r\nCATCH_ALL{\r\nis_atn_cpdlc = FALSE;\r\nis_pm = FALSE;}\r\nENDTRY;\r\nbreak;\r\ncase dm:\r\nTRY {\r\ndissect_ProtectedAircraftPDUs_PDU(tvb, pinfo, NULL, NULL);\r\nis_atn_cpdlc = TRUE;\r\nis_pm = TRUE;}\r\nCATCH_ALL {\r\nis_atn_cpdlc = FALSE;\r\nis_pm = FALSE; }\r\nENDTRY;\r\nif (is_atn_cpdlc) {\r\nbreak;\r\n}\r\nTRY{\r\ndissect_AircraftPDUs_PDU(tvb, pinfo, NULL, NULL);\r\nis_atn_cpdlc = TRUE;\r\nis_pm = FALSE;}\r\nCATCH_ALL{\r\nis_atn_cpdlc = FALSE;\r\nis_pm = FALSE;}\r\nENDTRY;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif(is_atn_cpdlc){\r\nif((pinfo->clnp_dstref) && (!pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(&pinfo->dst,\r\npinfo->clnp_dstref,\r\n&pinfo->src );\r\n}\r\nif((!pinfo->clnp_dstref) && (pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(&pinfo->src,\r\npinfo->clnp_srcref,\r\n&pinfo->dst );\r\n}\r\nif((pinfo->clnp_dstref) && (pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(&pinfo->src,\r\npinfo->clnp_srcref,\r\n&pinfo->dst );\r\n}\r\nif(atn_cv){\r\nif(is_pm == TRUE) {\r\natn_cv->ae_qualifier = pmcpdlc; }\r\nelse {\r\natn_cv->ae_qualifier = cpdlc; }\r\ndissect_atn_cpdlc(tvb, pinfo, tree, NULL);\r\n}\r\n}else {\r\nis_atn_cpdlc = FALSE;\r\n}\r\nreturn is_atn_cpdlc;\r\n}\r\nvoid proto_register_atn_cpdlc (void)\r\n{\r\nstatic hf_register_info hf_atn_cpdlc[] = {\r\n#include "packet-atn-cpdlc-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n#include "packet-atn-cpdlc-ettarr.c"\r\n&ett_atn_cpdlc\r\n};\r\nproto_atn_cpdlc = proto_register_protocol(\r\nATN_CPDLC_PROTO ,\r\n"ATN-CPDLC",\r\n"atn-cpdlc");\r\nproto_register_field_array(\r\nproto_atn_cpdlc,\r\nhf_atn_cpdlc,\r\narray_length(hf_atn_cpdlc));\r\nproto_register_subtree_array(\r\nett,\r\narray_length(ett));\r\nregister_dissector(\r\n"atn-cpdlc",\r\ndissect_atn_cpdlc,\r\nproto_atn_cpdlc);\r\n}\r\nvoid proto_reg_handoff_atn_cpdlc(void)\r\n{\r\nheur_dissector_add(\r\n"atn-ulcs",\r\ndissect_atn_cpdlc_heur,\r\n"ATN-CPDLC over ATN-ULCS",\r\n"atn-cpdlc-ulcs",\r\nproto_atn_cpdlc, HEURISTIC_ENABLE);\r\n}

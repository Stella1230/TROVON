void dcom_interface_dump(void) {\r\ndcom_machine_t *machine;\r\ndcom_object_t *object;\r\ndcom_interface_t *interf;\r\nGList *machines;\r\nGList *objects;\r\nGList *interfaces;\r\nfor(machines = dcom_machines; machines != NULL; machines = g_list_next(machines)) {\r\nmachine = (dcom_machine_t *)machines->data;\r\nfor(objects = machine->objects; objects != NULL; objects = g_list_next(objects)) {\r\nobject = (dcom_object_t *)objects->data;\r\nfor(interfaces = object->interfaces; interfaces != NULL; interfaces = g_list_next(interfaces)) {\r\ninterf = (dcom_interface_t *)interfaces->data;\r\n}\r\n}\r\n}\r\n}\r\ndcom_interface_t *dcom_interface_find(packet_info *pinfo _U_, const address *addr _U_, e_guid_t *ipid)\r\n{\r\ndcom_interface_t *interf;\r\nGList *interfaces;\r\nif(memcmp(ipid, &uuid_null, sizeof(uuid_null)) == 0)\r\n{\r\nreturn NULL;\r\n}\r\nfor(interfaces = dcom_interfaces; interfaces != NULL; interfaces = g_list_next(interfaces)) {\r\ninterf = (dcom_interface_t *)interfaces->data;\r\nif(memcmp(&interf->ipid, ipid, sizeof(e_guid_t)) == 0) {\r\nreturn interf;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\ndcom_interface_t *dcom_interface_new(packet_info *pinfo, const address *addr, e_guid_t *iid, guint64 oxid, guint64 oid, e_guid_t *ipid)\r\n{\r\nGList *dcom_iter;\r\ndcom_machine_t *machine;\r\ndcom_object_t *object;\r\ndcom_interface_t *interf;\r\nif( memcmp(iid, &uuid_null, sizeof(uuid_null)) == 0 ||\r\nmemcmp(ipid, &uuid_null, sizeof(uuid_null)) == 0)\r\n{\r\nreturn NULL;\r\n}\r\nif(oxid == 0 || oid == 0) {\r\ninterf = wmem_new(wmem_file_scope(), dcom_interface_t);\r\ninterf->parent = NULL;\r\ninterf->private_data = NULL;\r\ninterf->first_packet = pinfo->num;\r\ninterf->iid = *iid;\r\ninterf->ipid = *ipid;\r\ndcom_interfaces = g_list_append(dcom_interfaces, interf);\r\nreturn interf;\r\n}\r\ndcom_iter = dcom_machines;\r\nwhile(dcom_iter != NULL) {\r\nmachine = (dcom_machine_t *)dcom_iter->data;\r\nif(cmp_address(&machine->ip, addr) == 0) {\r\nbreak;\r\n}\r\ndcom_iter = g_list_next(dcom_iter);\r\n}\r\nif(dcom_iter == NULL) {\r\nmachine = g_new(dcom_machine_t,1);\r\ncopy_address(&machine->ip, addr);\r\nmachine->objects = NULL;\r\nmachine->first_packet = pinfo->num;\r\ndcom_machines = g_list_append(dcom_machines, machine);\r\n}\r\ndcom_iter = machine->objects;\r\nwhile(dcom_iter != NULL) {\r\nobject = (dcom_object_t *)dcom_iter->data;\r\nif(object->oid == oid) {\r\nbreak;\r\n}\r\ndcom_iter = g_list_next(dcom_iter);\r\n}\r\nif(dcom_iter == NULL) {\r\nobject = g_new(dcom_object_t,1);\r\nobject->parent = machine;\r\nobject->interfaces = NULL;\r\nobject->private_data = NULL;\r\nobject->first_packet = pinfo->num;\r\nobject->oid = oid;\r\nobject->oxid = oxid;\r\nmachine->objects = g_list_append(machine->objects, object);\r\n}\r\ndcom_iter = object->interfaces;\r\nwhile(dcom_iter != NULL) {\r\ninterf = (dcom_interface_t *)dcom_iter->data;\r\nif(memcmp(&interf->ipid, ipid, sizeof(e_guid_t)) == 0) {\r\nbreak;\r\n}\r\ndcom_iter = g_list_next(dcom_iter);\r\n}\r\nif(dcom_iter == NULL) {\r\ninterf = g_new(dcom_interface_t,1);\r\ninterf->parent = object;\r\ninterf->private_data = NULL;\r\ninterf->first_packet = pinfo->num;\r\ninterf->iid = *iid;\r\ninterf->ipid = *ipid;\r\nobject->interfaces = g_list_append(object->interfaces, interf);\r\ndcom_interfaces = g_list_append(dcom_interfaces, interf);\r\n}\r\nreturn interf;\r\n}\r\nstatic int\r\ndissect_dcom_extent(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32ArraySize;\r\nguint32 u32ArraySize2;\r\nguint32 u32Pointer;\r\nguint32 u32VariableOffset;\r\nguint32 u32Idx;\r\nguint32 u32SubStart;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32ArrayCount;\r\nguint32 u32ArrayRes;\r\nguint32 u32ExtentSize;\r\ne_guid_t uuidExtend;\r\nconst char *uuid_name;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep, &u32Pointer);\r\nif (u32Pointer == 0) {\r\nreturn offset;\r\n}\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_extent_array_count, &u32ArrayCount);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_extent_array_res, &u32ArrayRes);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep, &u32Pointer);\r\nif (u32Pointer == 0) {\r\nreturn offset;\r\n}\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize*4;\r\nu32Idx = 1;\r\nwhile (u32ArraySize--) {\r\nsub_item = proto_tree_add_item(tree, hf_dcom_extent, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_extent);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nif(u32Pointer != 0) {\r\nu32VariableOffset = dissect_dcom_DWORD(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_dcom_extent_size, &u32ExtentSize);\r\ndissect_dcom_UUID(tvb, u32VariableOffset, pinfo, NULL, di, drep,\r\nhf_dcom_extent_id, &uuidExtend);\r\nif((uuid_name = guids_get_uuid_name(&uuidExtend)) != NULL) {\r\nproto_tree_add_guid_format_value(sub_tree, hf_dcom_extent_id, tvb,\r\noffset, sizeof(e_guid_t), (e_guid_t *) &uuidExtend,\r\n"%s (%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x)",\r\nuuid_name,\r\nuuidExtend.data1, uuidExtend.data2, uuidExtend.data3,\r\nuuidExtend.data4[0], uuidExtend.data4[1],\r\nuuidExtend.data4[2], uuidExtend.data4[3],\r\nuuidExtend.data4[4], uuidExtend.data4[5],\r\nuuidExtend.data4[6], uuidExtend.data4[7]);\r\nu32VariableOffset += 16;\r\n} else {\r\nu32VariableOffset = dissect_dcom_UUID(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_dcom_extent_id, &uuidExtend);\r\n}\r\nu32VariableOffset = dissect_dcom_dcerpc_array_size(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\n&u32ArraySize2);\r\nu32VariableOffset = dissect_dcom_nospec_data(tvb, u32VariableOffset, pinfo, sub_tree, drep, u32ArraySize2);\r\nif(uuid_name != NULL) {\r\nproto_item_append_text(sub_item, "[%u]: %s, Bytes=%u",\r\nu32Idx, uuid_name, u32ArraySize2);\r\n} else {\r\nproto_item_append_text(sub_item, "[%u]: Bytes=%u",\r\nu32Idx, u32ArraySize2);\r\n}\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\n} else {\r\nproto_item_append_text(sub_item, "[%u]: NULL", u32Idx);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\n}\r\nu32Idx++;\r\n}\r\nreturn u32VariableOffset;\r\n}\r\nint\r\ndissect_dcom_this(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint16 u16VersionMajor;\r\nguint16 u16VersionMinor;\r\nguint32 u32Flags;\r\nguint32 u32Res;\r\ne_guid_t uuidCausality;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nproto_item *pi;\r\nsub_item = proto_tree_add_protocol_format(tree, proto_dcom, tvb, offset, 0,\r\n"DCOM, ORPCThis");\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_this);\r\noffset = dissect_dcom_COMVERSION(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u16VersionMajor, &u16VersionMinor);\r\nu32SubStart = offset - 4;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_this_flags, &u32Flags);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_this_res, &u32Res);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_this_cid, &uuidCausality);\r\noffset = dissect_dcom_extent(tvb, offset, pinfo, sub_tree, di, drep);\r\nproto_item_append_text(sub_item, ", V%u.%u, Causality ID: %s",\r\nu16VersionMajor, u16VersionMinor, guids_resolve_guid_to_str(&uuidCausality));\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nif(memcmp(&di->call_data->object_uuid, &uuid_null, sizeof(uuid_null)) != 0) {\r\npi = proto_tree_add_guid_format(tree, hf_dcom_ipid, tvb, offset, 0,\r\n(e_guid_t *) &di->call_data->object_uuid,\r\n"Object UUID/IPID: %s", guids_resolve_guid_to_str(&di->call_data->object_uuid));\r\nPROTO_ITEM_SET_GENERATED(pi);\r\n}\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_that(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep) {\r\nguint32 u32Flags;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nproto_item *pi;\r\nsub_item = proto_tree_add_protocol_format(tree, proto_dcom, tvb, offset, 0,\r\n"DCOM, ORPCThat");\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_that);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_that_flags, &u32Flags);\r\nu32SubStart = offset - 4;\r\noffset = dissect_dcom_extent(tvb, offset, pinfo, sub_tree, di, drep);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nif(memcmp(&di->call_data->object_uuid, &uuid_null, sizeof(uuid_null)) != 0) {\r\npi = proto_tree_add_guid_format(tree, hf_dcom_ipid, tvb, offset, 0,\r\n(e_guid_t *) &di->call_data->object_uuid,\r\n"Object UUID/IPID: %s", guids_resolve_guid_to_str(&di->call_data->object_uuid));\r\nPROTO_ITEM_SET_GENERATED(pi);\r\n}\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_simple_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_simple_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_dcerpc_array_size(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, guint32 *pu32ArraySize)\r\n{\r\nif (!dcom_prefs_display_unmarshalling_details) {\r\ntree = NULL;\r\n}\r\noffset = dissect_ndr_uint32(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_array_size, pu32ArraySize);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_dcerpc_pointer(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, guint32 *pu32Pointer)\r\n{\r\nif (!dcom_prefs_display_unmarshalling_details) {\r\ntree = NULL;\r\n}\r\noffset = dissect_ndr_uint32(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_pointer_val, pu32Pointer);\r\nreturn offset;\r\n}\r\nextern int\r\ndissect_dcom_tobedone_data(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, guint8 *drep _U_, int length)\r\n{\r\nproto_item *item;\r\nitem = proto_tree_add_item(tree, hf_dcom_tobedone, tvb, offset, length, ENC_NA);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nexpert_add_info(pinfo, item, &ei_dcom_dissetion_incomplete);\r\noffset += length;\r\nreturn offset;\r\n}\r\nextern int\r\ndissect_dcom_nospec_data(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, guint8 *drep _U_, int length)\r\n{\r\nproto_item *item;\r\nitem = proto_tree_add_item(tree, hf_dcom_nospec, tvb, offset, length, ENC_NA);\r\nPROTO_ITEM_SET_GENERATED(item);\r\nexpert_add_info(pinfo, item, &ei_dcom_no_spec);\r\noffset += length;\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_indexed_WORD(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nint hfindex, guint16 * pu16WORD, int field_index)\r\n{\r\nguint16 u16WORD;\r\ndissect_dcom_WORD(tvb, offset, pinfo, NULL , di, drep,\r\nhfindex, &u16WORD);\r\nif (tree) {\r\nproto_tree_add_uint_format(tree, hfindex, tvb, offset, 2, u16WORD,\r\n"%s[%u]: 0x%04x",\r\nproto_registrar_get_name(hfindex),\r\nfield_index, u16WORD);\r\n}\r\noffset += 2;\r\nif (pu16WORD)\r\n*pu16WORD = u16WORD;\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_indexed_DWORD(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nint hfindex, guint32 * pu32DWORD, int field_index)\r\n{\r\nguint32 u32DWORD;\r\ndissect_dcom_DWORD(tvb, offset, pinfo, NULL , di, drep,\r\nhfindex, &u32DWORD);\r\nif (tree) {\r\nproto_tree_add_uint_format(tree, hfindex, tvb, offset, 4, u32DWORD,\r\n"%s[%u]: 0x%08x",\r\nproto_registrar_get_name(hfindex),\r\nfield_index, u32DWORD);\r\n}\r\noffset += 4;\r\nif (pu32DWORD)\r\n*pu32DWORD = u32DWORD;\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_HRESULT_item(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nguint32 * pu32HResult, int field_index, proto_item **item)\r\n{\r\nguint32 u32HResult;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, NULL , di, drep,\r\nfield_index, &u32HResult);\r\nif (tree) {\r\n*item = proto_tree_add_item (tree, field_index, tvb, offset-4, 4, DREP_ENC_INTEGER(drep));\r\n}\r\nif (pu32HResult)\r\n*pu32HResult = u32HResult;\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_HRESULT(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nguint32 * pu32HResult)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item = NULL;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, NULL , di, drep,\r\nhf_dcom_hresult, &u32HResult);\r\nif (tree) {\r\nitem = proto_tree_add_item (tree, hf_dcom_hresult, tvb, offset-4, 4, DREP_ENC_INTEGER(drep));\r\n}\r\nif(u32HResult & 0x80000000) {\r\nexpert_add_info_format(pinfo, item, &ei_dcom_hresult_expert, "Hresult: %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%x)"));\r\n}\r\nif (pu32HResult)\r\n*pu32HResult = u32HResult;\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_indexed_HRESULT(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nguint32 * pu32HResult, int field_index)\r\n{\r\nguint32 u32HResult;\r\nproto_item *item = NULL;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, NULL , di, drep,\r\nhf_dcom_hresult, &u32HResult);\r\nif (tree) {\r\nitem = proto_tree_add_uint_format(tree, hf_dcom_hresult, tvb, offset-4, 4, u32HResult,\r\n"HResult[%u]: %s (0x%08x)", field_index,\r\nval_to_str_const(u32HResult, dcom_hresult_vals, "Unknown"),\r\nu32HResult);\r\n}\r\nif(u32HResult & 0x80000000) {\r\nexpert_add_info_format(pinfo, item, &ei_dcom_hresult_expert, "Hresult: %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%x)"));\r\n}\r\nif (pu32HResult)\r\n*pu32HResult = u32HResult;\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_COMVERSION(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nguint16 * pu16VersionMajor, guint16 * pu16VersionMinor)\r\n{\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_version_major, pu16VersionMajor);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_version_minor, pu16VersionMinor);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_SAFEARRAY(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex _U_, sa_callback_t sacb)\r\n{\r\nguint32 u32Dims;\r\nguint16 u16Dims;\r\nguint16 u16Features;\r\nguint32 u32ElementSize;\r\nguint32 u32VarType;\r\nguint32 u32Elements;\r\nguint32 u32Pointer;\r\nguint32 u32BoundElements;\r\nguint32 u32LowBound;\r\ngchar cData[100];\r\nguint32 u32ArraySize;\r\nguint32 u32VariableOffset;\r\nguint32 u32Data;\r\nguint16 u16Data;\r\nguint8 u8Data;\r\nguint16 u16Locks;\r\nguint16 u16VarType;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nguint32 u32TmpOffset;\r\nstatic const int * features[] = {\r\n&hf_dcom_sa_features_variant,\r\n&hf_dcom_sa_features_dispatch,\r\n&hf_dcom_sa_features_unknown,\r\n&hf_dcom_sa_features_bstr,\r\n&hf_dcom_sa_features_have_vartype,\r\n&hf_dcom_sa_features_have_iid,\r\n&hf_dcom_sa_features_record,\r\n&hf_dcom_sa_features_fixedsize,\r\n&hf_dcom_sa_features_embedded,\r\n&hf_dcom_sa_features_static,\r\n&hf_dcom_sa_features_auto,\r\nNULL\r\n};\r\nsub_item = proto_tree_add_item(tree, hf_dcom_safearray, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_safearray);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_dims32, &u32Dims);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_dims16, &u16Dims);\r\nu32TmpOffset = dissect_dcom_WORD(tvb, offset, pinfo, NULL, di, drep, -1, &u16Features);\r\nproto_tree_add_bitmask_value_with_flags(sub_tree, tvb, offset, hf_dcom_sa_features,\r\nett_dcom_sa_features, features, u16Features, BMT_NO_APPEND);\r\noffset = u32TmpOffset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_element_size, &u32ElementSize);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_locks, &u16Locks);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_vartype16, &u16VarType);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_vartype32, &u32VarType);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_elements, &u32Elements);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nu32BoundElements = 0;\r\nwhile(u32Dims--) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_bound_elements, &u32BoundElements);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_sa_low_bound, &u32LowBound);\r\n}\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, sub_tree, di, drep, &u32ArraySize);\r\ntvb_ensure_bytes_exist(tvb, offset, u32ArraySize * u32ElementSize);\r\nu32VariableOffset = offset + u32ArraySize * u32ElementSize;\r\nif(sacb) {\r\nsacb(tvb, offset, pinfo, tree, di, drep, u32VarType, u32ArraySize);\r\n}\r\nwhile(u32ArraySize--) {\r\nswitch(u32VarType) {\r\ncase(WIRESHARK_VT_ERROR):\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I1):\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i1, &u8Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I2):\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i2, &u16Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I4):\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i4, &u32Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I8):\r\noffset = dissect_dcom_I8(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i8, NULL);\r\nu32VariableOffset = offset;\r\nbreak;\r\ncase(WIRESHARK_VT_BSTR):\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_BSTR(tvb, u32VariableOffset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_bstr, cData, sizeof(cData) );\r\n}\r\nbreak;\r\ndefault:\r\nu32VariableOffset = dissect_dcom_tobedone_data(tvb, u32VariableOffset, pinfo, sub_tree, drep,\r\n10000);\r\n}\r\n}\r\nproto_item_append_text(sub_item, ": Elements: %u/%u VarType: %s",\r\nu32Elements, u32BoundElements,\r\nval_to_str(u32VarType, dcom_variant_type_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, u32VariableOffset - u32SubStart);\r\nreturn u32VariableOffset;\r\n}\r\nint\r\ndissect_dcom_VARTYPE(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nguint16 *pu16VarType)\r\n{\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_variant_type, pu16VarType);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_VARIANT(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex)\r\n{\r\nguint32 u32Size;\r\nguint32 u32RPCRes;\r\nguint16 u16Res;\r\nguint32 u32SubStart;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint16 u16VarType;\r\nguint32 u32VarType;\r\nguint8 u8Data;\r\nguint16 u16Data;\r\nguint32 u32Data;\r\nguint64 u64Data;\r\ngint64 cyData;\r\ngchar cData[500];\r\nguint32 u32Pointer;\r\ngfloat f32Data;\r\ngdouble f64Data;\r\nif (offset % 8) {\r\noffset += 8 - (offset % 8);\r\n}\r\nsub_item = proto_tree_add_item(tree, hfindex, tvb, offset, 0, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_variant);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_variant_size, &u32Size);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_variant_rpc_res, &u32RPCRes);\r\noffset = dissect_dcom_VARTYPE(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u16VarType);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_variant_wres, &u16Res);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_variant_wres, &u16Res);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_variant_wres, &u16Res);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_variant_type32, &u32VarType);\r\nif (u32VarType & WIRESHARK_VT_BYREF) {\r\nu32VarType &=~WIRESHARK_VT_BYREF;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\n}\r\nswitch (u32VarType) {\r\ncase(WIRESHARK_VT_EMPTY):\r\nbreak;\r\ncase(WIRESHARK_VT_BOOL):\r\noffset = dissect_dcom_VARIANT_BOOL(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_bool, &u16Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I1):\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i1, &u8Data);\r\nbreak;\r\ncase(WIRESHARK_VT_UI1):\r\noffset = dissect_dcom_BYTE(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_ui1, &u8Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I2):\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i2, &u16Data);\r\nbreak;\r\ncase(WIRESHARK_VT_UI2):\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_ui2, &u16Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I4):\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i4, &u32Data);\r\nbreak;\r\ncase(WIRESHARK_VT_I8):\r\noffset = dissect_dcom_I8(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_i8, &u64Data);\r\nbreak;\r\ncase(WIRESHARK_VT_CY):\r\noffset = dissect_dcom_I8(tvb, offset, pinfo, NULL, di, drep,\r\n0, &cyData);\r\nproto_tree_add_int64_format(sub_tree, hf_dcom_vt_cy, tvb, offset - 8,\r\n8, cyData, "%s: %" G_GINT64_FORMAT ".%.04" G_GINT64_FORMAT,\r\nproto_registrar_get_name(hf_dcom_vt_cy),\r\ncyData / 10000, ABS(cyData % 10000));\r\nbreak;\r\ncase(WIRESHARK_VT_UI4):\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_ui4, &u32Data);\r\nbreak;\r\ncase(WIRESHARK_VT_UI8):\r\noffset = dissect_dcom_I8(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_ui8, &u64Data);\r\nbreak;\r\ncase(WIRESHARK_VT_R4):\r\noffset = dissect_dcom_FLOAT(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_r4, &f32Data);\r\nbreak;\r\ncase(WIRESHARK_VT_R8):\r\noffset = dissect_dcom_DOUBLE(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_r8, &f64Data);\r\nbreak;\r\ncase(WIRESHARK_VT_DATE):\r\noffset = dissect_dcom_DATE(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_date, &f64Data);\r\nbreak;\r\ncase(WIRESHARK_VT_BSTR):\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_BSTR(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_bstr, cData, sizeof(cData) );\r\n}\r\nbreak;\r\ncase(WIRESHARK_VT_DISPATCH):\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_MInterfacePointer(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_dispatch, NULL);\r\n}\r\nbreak;\r\ncase(WIRESHARK_VT_ARRAY):\r\noffset = dissect_dcom_SAFEARRAY(tvb, offset, pinfo, sub_tree, di, drep,\r\n0, NULL);\r\nbreak;\r\ncase(WIRESHARK_VT_ERROR):\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n0);\r\nbreak;\r\ncase(WIRESHARK_VT_VARIANT):\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_VARIANT(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_vt_byref );\r\n}\r\nbreak;\r\ncase(WIRESHARK_VT_UNKNOWN):\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep, &u32Pointer);\r\nbreak;\r\ndefault:\r\noffset = dissect_dcom_tobedone_data(tvb, offset, pinfo, sub_tree, drep,\r\n10000);\r\n}\r\nproto_item_append_text(sub_item, ": %s",\r\nval_to_str(u16VarType, dcom_variant_type_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_UUID(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nint hfindex, e_guid_t *pdata)\r\n{\r\nconst gchar *uuid_name;\r\nheader_field_info *hfi;\r\ne_guid_t uuid;\r\noffset = dissect_ndr_uuid_t(tvb, offset, pinfo, NULL, di, drep,\r\nhfindex, &uuid);\r\nhfi = proto_registrar_get_nth(hfindex);\r\nuuid_name = guids_get_uuid_name(&uuid);\r\nif(uuid_name) {\r\nproto_tree_add_guid_format(tree, hfindex, tvb, offset-16, 16, (e_guid_t *) &uuid,\r\n"%s: %s (%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x)",\r\nhfi->name, uuid_name,\r\nuuid.data1, uuid.data2, uuid.data3,\r\nuuid.data4[0], uuid.data4[1],\r\nuuid.data4[2], uuid.data4[3],\r\nuuid.data4[4], uuid.data4[5],\r\nuuid.data4[6], uuid.data4[7]);\r\n} else {\r\nproto_tree_add_guid_format(tree, hfindex, tvb, offset-16, 16, (e_guid_t *) &uuid,\r\n"%s: %08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x",\r\nhfi->name,\r\nuuid.data1, uuid.data2, uuid.data3,\r\nuuid.data4[0], uuid.data4[1],\r\nuuid.data4[2], uuid.data4[3],\r\nuuid.data4[4], uuid.data4[5],\r\nuuid.data4[6], uuid.data4[7]);\r\n}\r\nif(pdata != NULL) {\r\n*pdata = uuid;\r\n}\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_append_UUID(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep,\r\nint hfindex, int field_index, e_guid_t *uuid)\r\n{\r\nconst gchar *uuid_name;\r\nproto_item *pi;\r\nheader_field_info *hfi;\r\noffset = dissect_ndr_uuid_t(tvb, offset, pinfo, NULL, di, drep,\r\nhfindex, uuid);\r\nuuid_name = guids_get_uuid_name(uuid);\r\nhfi = proto_registrar_get_nth(hfindex);\r\npi = proto_tree_add_guid_format(tree, hfindex, tvb, offset-16, 16, (e_guid_t *) uuid, "%s", hfi->name);\r\nif (field_index != -1) {\r\nproto_item_append_text(pi, "[%u]: ", field_index);\r\n} else {\r\nproto_item_append_text(pi, ": ");\r\n}\r\nif(uuid_name) {\r\nproto_item_append_text(pi, "%s (", uuid_name);\r\n}\r\nproto_item_append_text(pi, "%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x",\r\nuuid->data1, uuid->data2, uuid->data3,\r\nuuid->data4[0], uuid->data4[1],\r\nuuid->data4[2], uuid->data4[3],\r\nuuid->data4[4], uuid->data4[5],\r\nuuid->data4[6], uuid->data4[7]);\r\nif(uuid_name) {\r\nproto_item_append_text(pi, ")");\r\n}\r\nif (field_index != -1) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %s[%u]=%s",\r\nhfi->name, field_index, (uuid_name) ? uuid_name : "???");\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %s=%s",\r\nhfi->name, (uuid_name) ? uuid_name : "???");\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndcom_tvb_get_nwstringz0(tvbuff_t *tvb, gint offset, guint32 inLength, gchar *pszStr, guint32 outLength, gboolean *isPrintable)\r\n{\r\nguint32 u32Idx;\r\nguint32 u32IdxA;\r\nguint32 u32IdxW;\r\nguint32 inLengthWithoutNullDelimiter = 0;\r\nguint8 u8Tmp1;\r\nguint8 u8Tmp2;\r\n*isPrintable = TRUE;\r\ninLengthWithoutNullDelimiter = inLength == 0 ? 0 : inLength -1;\r\nDISSECTOR_ASSERT(outLength >= 1);\r\nfor(u32Idx = 0; u32Idx < inLengthWithoutNullDelimiter; u32Idx+=2) {\r\nu8Tmp1 = tvb_get_guint8(tvb, offset+u32Idx);\r\nu8Tmp2 = tvb_get_guint8(tvb, offset+u32Idx+1);\r\nif (u8Tmp1 == 0 && u8Tmp2 == 0) {\r\nu32Idx+=2;\r\nbreak;\r\n}\r\nif(!(g_ascii_isprint(u8Tmp1) || u8Tmp1 == 10 || u8Tmp1 == 13)|| u8Tmp2 != 0) {\r\n*isPrintable = FALSE;\r\n}\r\n}\r\nif(*isPrintable == TRUE) {\r\nfor(u32IdxA = 0, u32IdxW = 0;\r\nu32IdxW < u32Idx && u32IdxA < outLength-2;\r\nu32IdxW+=2, u32IdxA++) {\r\npszStr[u32IdxA] = tvb_get_guint8(tvb, offset+u32IdxW);\r\n}\r\n} else {\r\nfor(u32IdxA = 0, u32IdxW = 0;\r\nu32IdxW < u32Idx && u32IdxA < outLength-2;\r\nu32IdxW++, u32IdxA+=2) {\r\ng_snprintf(&pszStr[u32IdxA], 3, "%02X", tvb_get_guint8(tvb, offset+u32IdxW));\r\n}\r\n}\r\nDISSECTOR_ASSERT(u32IdxA < outLength);\r\npszStr[u32IdxA] = 0;\r\nreturn offset + u32Idx;\r\n}\r\nint\r\ndissect_dcom_indexed_LPWSTR(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex,\r\ngchar *pszStr, guint32 u32MaxStr, int field_index)\r\n{\r\nguint32 u32MaxCount;\r\nguint32 u32Offset;\r\nguint32 u32ArraySize;\r\nguint32 u32StrStart;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\ngboolean isPrintable;\r\nif (offset % 4) {\r\noffset += 4 - (offset % 4);\r\n}\r\nsub_item = proto_tree_add_string(tree, hfindex, tvb, offset, 0, "");\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_lpwstr);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_max_count, &u32MaxCount);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_offset, &u32Offset);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32ArraySize);\r\nu32StrStart = offset;\r\noffset = dcom_tvb_get_nwstringz0(tvb, offset, u32ArraySize*2, pszStr, u32MaxStr, &isPrintable);\r\nproto_tree_add_string(sub_tree, hfindex, tvb, u32StrStart, offset - u32StrStart, pszStr);\r\nif (field_index != -1) {\r\nproto_item_set_text(sub_item, "%s[%u]: %s%s%s",\r\nproto_registrar_get_name(hfindex),\r\nfield_index,\r\nisPrintable ? "\"" : "", pszStr, isPrintable ? "\"" : "");\r\n} else {\r\nproto_item_append_text(sub_item, "%s%s%s",\r\nisPrintable ? "\"" : "", pszStr, isPrintable ? "\"" : "");\r\n}\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_LPWSTR(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex,\r\ngchar *pszStr, guint32 u32MaxStr)\r\n{\r\nreturn dissect_dcom_indexed_LPWSTR(tvb, offset, pinfo, tree, di, drep,\r\nhfindex, pszStr, u32MaxStr, -1);\r\n}\r\nint\r\ndissect_dcom_BSTR(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex,\r\ngchar *pszStr, guint32 u32MaxStr)\r\n{\r\nguint32 u32MaxCount;\r\nguint32 u32ArraySize;\r\ngint strStart, subStart, realOffset;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32ByteLength;\r\ngboolean isPrintable;\r\nif (offset % 4) {\r\noffset += 4 - (offset % 4);\r\n}\r\nsub_item = proto_tree_add_string(tree, hfindex, tvb, offset, 0, "");\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_lpwstr);\r\nsubStart = offset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_max_count, &u32MaxCount);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_byte_length, &u32ByteLength);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32ArraySize);\r\nif ((guint32)offset + u32ArraySize*2 > G_MAXINT)\r\nreturn offset;\r\nrealOffset = offset + u32ArraySize*2;\r\nstrStart = offset;\r\noffset = dcom_tvb_get_nwstringz0(tvb, offset, u32ArraySize*2, pszStr, u32MaxStr, &isPrintable);\r\nproto_tree_add_string(sub_tree, hfindex, tvb, strStart, offset - strStart, pszStr);\r\nproto_item_append_text(sub_item, "%s%s%s",\r\nisPrintable ? "\"" : "", pszStr, isPrintable ? "\"" : "");\r\nif (realOffset <= subStart) {\r\nreturn offset;\r\n}\r\nproto_item_set_len(sub_item, realOffset - subStart);\r\nreturn realOffset;\r\n}\r\nint\r\ndissect_dcom_DUALSTRINGARRAY(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex, gchar *ip)\r\n{\r\nguint16 u16NumEntries;\r\nguint16 u16SecurityOffset;\r\ngchar szStr[1000];\r\nguint32 u32MaxStr = sizeof(szStr);\r\nguint32 u32Start;\r\nguint16 u16TowerId;\r\nguint16 u16SecurityAuthnSvc;\r\nguint16 u16SecurityAuthzSvc;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nguint32 u32StringBindings = 0;\r\nguint32 u32SecurityBindings = 0;\r\nproto_item *subsub_item;\r\nproto_tree *subsub_tree;\r\nguint32 u32SubSubStart;\r\ngboolean isPrintable;\r\nguint32 first_ip = 0;\r\nguint32 curr_ip = 0;\r\nstruct in_addr ipaddr;\r\nproto_item *pi;\r\nsub_item = proto_tree_add_item(tree, hfindex, tvb, offset, 0, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_dualstringarray);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_dualstringarray_num_entries, &u16NumEntries);\r\nu32SubStart = offset - 2;\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_dualstringarray_security_offset, &u16SecurityOffset);\r\nwhile ( tvb_get_ntohs(tvb, offset) ) {\r\nu32StringBindings++;\r\nsubsub_item = proto_tree_add_item(sub_tree, hf_dcom_dualstringarray_string, tvb, offset, 0, ENC_NA);\r\nsubsub_tree = proto_item_add_subtree(subsub_item, ett_dcom_dualstringarray_binding);\r\nu32SubSubStart = offset;\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, subsub_tree, di, drep,\r\nhf_dcom_dualstringarray_string_tower_id, &u16TowerId);\r\nu32Start = offset;\r\noffset = dcom_tvb_get_nwstringz0(tvb, offset, u32MaxStr, szStr, u32MaxStr, &isPrintable);\r\npi = proto_tree_add_string(subsub_tree, hf_dcom_dualstringarray_string_network_addr,\r\ntvb, u32Start, offset - u32Start, szStr);\r\nif (inet_aton(szStr, &ipaddr)) {\r\nif(get_host_ipaddr(szStr, &curr_ip)) {\r\nif(first_ip == 0) {\r\nif(ip != NULL) {\r\nmemcpy(ip, &curr_ip, sizeof(curr_ip));\r\n}\r\nfirst_ip = curr_ip;\r\n} else {\r\nif(first_ip != curr_ip) {\r\naddress first_ip_addr, curr_ip_addr;\r\nset_address(&first_ip_addr, AT_IPv4, 4, &first_ip);\r\nset_address(&curr_ip_addr, AT_IPv4, 4, &curr_ip);\r\nexpert_add_info_format(pinfo, pi, &ei_dcom_dualstringarray_mult_ip,\r\n"DUALSTRINGARRAY: multiple IP's %s %s",\r\naddress_to_str(wmem_packet_scope(), &first_ip_addr), address_to_str(wmem_packet_scope(), &curr_ip_addr));\r\n}\r\n}\r\n}\r\n}\r\nproto_item_append_text(subsub_item, "[%u]: TowerId=%s, NetworkAddr=\"%s\"",\r\nu32StringBindings,\r\nval_to_str(u16TowerId, dcom_protseq_vals, "Unknown (0x%04x"),\r\nszStr);\r\nproto_item_set_len(subsub_item, offset - u32SubSubStart);\r\n}\r\noffset += 2;\r\nwhile ( tvb_get_ntohs(tvb, offset) ) {\r\nu32SecurityBindings++;\r\nsubsub_item = proto_tree_add_item(sub_tree, hf_dcom_dualstringarray_security, tvb, offset, 0, ENC_NA);\r\nsubsub_tree = proto_item_add_subtree(subsub_item, ett_dcom_dualstringarray_binding);\r\nu32SubSubStart = offset;\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, subsub_tree, di, drep,\r\nhf_dcom_dualstringarray_security_authn_svc,\r\n&u16SecurityAuthnSvc);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, subsub_tree, di, drep,\r\nhf_dcom_dualstringarray_security_authz_svc,\r\n&u16SecurityAuthzSvc);\r\nu32Start = offset;\r\noffset = dcom_tvb_get_nwstringz0(tvb, offset, u32MaxStr, szStr, u32MaxStr, &isPrintable);\r\nproto_tree_add_string(subsub_tree, hf_dcom_dualstringarray_security_princ_name,\r\ntvb, u32Start, offset - u32Start, szStr);\r\nproto_item_append_text(subsub_item, "[%u]: AuthnSvc=0x%04x, AuthzSvc=0x%04x, PrincName=\"%s\"",\r\nu32SecurityBindings, u16SecurityAuthnSvc, u16SecurityAuthzSvc, szStr);\r\nproto_item_set_len(subsub_item, offset - u32SubSubStart);\r\n}\r\noffset += 2;\r\nproto_item_append_text(sub_item, ": STRINGBINDINGs=%u, SECURITYBINDINGs=%u",\r\nu32StringBindings, u32SecurityBindings);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_STDOBJREF(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex _U_,\r\nguint64 *oxid, guint64 *oid, e_guid_t *ipid)\r\n{\r\nguint32 u32Flags;\r\nguint32 u32PublicRefs;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nsub_item = proto_tree_add_item(tree, hf_dcom_stdobjref, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_stdobjref);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_stdobjref_flags, &u32Flags);\r\nu32SubStart = offset - 4;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_stdobjref_public_refs, &u32PublicRefs);\r\noffset = dissect_dcom_ID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_oxid, oxid);\r\noffset = dissect_dcom_ID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_oid, oid);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_ipid, ipid);\r\nproto_item_append_text(sub_item, ": PublicRefs=%u IPID=%s",\r\nu32PublicRefs, guids_resolve_guid_to_str(ipid));\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndcom_register_rountine(dcom_dissect_fn_t routine, e_guid_t* uuid)\r\n{\r\ndcom_marshaler_t *marshaler;\r\nif (dcom_get_rountine_by_uuid(uuid))\r\nreturn -1;\r\nmarshaler = wmem_new(wmem_file_scope(), dcom_marshaler_t);\r\nif (!marshaler) {\r\nreturn -1;\r\n}\r\nmarshaler->parent = NULL;\r\nmarshaler->private_data = NULL;\r\nmarshaler->uuid = *uuid;\r\nmarshaler->routine = routine;\r\ndcom_marshalers = g_list_append(dcom_marshalers, marshaler);\r\nreturn 0;\r\n}\r\ndcom_dissect_fn_t\r\ndcom_get_rountine_by_uuid(const e_guid_t* uuid)\r\n{\r\ndcom_marshaler_t *marsh;\r\nGList *marshalers;\r\nif(memcmp(uuid, &uuid_null, sizeof(uuid_null)) == 0) {\r\nreturn NULL;\r\n}\r\nfor(marshalers = dcom_marshalers; marshalers!= NULL;\r\nmarshalers = g_list_next(marshalers)) {\r\nmarsh = (dcom_marshaler_t *)marshalers->data;\r\nif(memcmp(&marsh->uuid, uuid, sizeof(e_guid_t)) == 0) {\r\nreturn marsh->routine;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic int\r\ndissect_dcom_CUSTOBJREF(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex,\r\ne_guid_t *clsid, e_guid_t *iid)\r\n{\r\nguint32 u32CBExtension;\r\nguint32 u32Size;\r\nguint32 u32SubStart;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\ndcom_dissect_fn_t routine = NULL;\r\nhfindex = hf_dcom_custobjref;\r\nsub_item = proto_tree_add_item(tree, hfindex, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_custobjref);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_clsid, clsid);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_objref_cbextension, &u32CBExtension);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_objref_size, &u32Size);\r\nroutine = dcom_get_rountine_by_uuid(iid);\r\nif (routine){\r\noffset = routine(tvb, offset, pinfo, sub_tree, di, drep, 0);\r\n}\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_OBJREF(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex, dcom_interface_t **interf)\r\n{\r\nguint32 u32Signature;\r\nguint32 u32Flags;\r\ne_guid_t iid;\r\ne_guid_t clsid;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nguint64 oxid = 0;\r\nguint64 oid = 0;\r\ne_guid_t ipid;\r\ndcom_interface_t *dcom_if = NULL;\r\ngchar ip[4];\r\nmemset(&ipid, 0, sizeof(ipid));\r\nmemset(ip, 0, sizeof(ip));\r\nsub_item = proto_tree_add_item(tree, hf_dcom_objref, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_objref);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_objref_signature, &u32Signature);\r\nu32SubStart = offset - 4;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_objref_flags, &u32Flags);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_iid, &iid);\r\nswitch(u32Flags) {\r\ncase(0x1):\r\noffset = dissect_dcom_STDOBJREF(tvb, offset, pinfo, sub_tree, di, drep, hfindex,\r\n&oxid, &oid, &ipid);\r\noffset = dissect_dcom_DUALSTRINGARRAY(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_objref_resolver_address, ip);\r\nbreak;\r\ncase(0x2):\r\noffset = dissect_dcom_STDOBJREF(tvb, offset, pinfo, sub_tree, di, drep, hfindex,\r\n&oxid, &oid, &iid);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_clsid, &clsid);\r\noffset = dissect_dcom_DUALSTRINGARRAY(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_objref_resolver_address, ip);\r\nbreak;\r\ncase(0x4):\r\noffset = dissect_dcom_CUSTOBJREF(tvb, offset, pinfo, sub_tree, di, drep, hfindex,\r\n&clsid, &iid);\r\nbreak;\r\n}\r\nif(u32Flags == 0x1 || u32Flags == 0x2) {\r\nif(pinfo->net_src.type == AT_IPv4) {\r\naddress addr;\r\nset_address(&addr, AT_IPv4, 4, ip);\r\ndcom_if = dcom_interface_new(pinfo,\r\n&addr,\r\n&iid, oxid, oid, &ipid);\r\n}\r\n}\r\nif(interf != NULL) {\r\n*interf = dcom_if;\r\n}\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_MInterfacePointer(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex, dcom_interface_t **interf)\r\n{\r\nguint32 u32CntData;\r\nguint32 u32ArraySize;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\nif (!hfindex) {\r\nhfindex = hf_dcom_interface_pointer;\r\n}\r\nsub_item = proto_tree_add_item(tree, hfindex, tvb, offset, 0, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_dcom_interface_pointer);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, sub_tree, di, drep, &u32ArraySize);\r\nu32SubStart = offset - 4;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_ip_cnt_data, &u32CntData);\r\noffset = dissect_dcom_OBJREF(tvb, offset, pinfo, sub_tree, di, drep, hfindex, interf);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nint\r\ndissect_dcom_PMInterfacePointer(tvbuff_t *tvb, gint offset, packet_info *pinfo,\r\nproto_tree *tree, dcerpc_info *di, guint8 *drep, int hfindex, dcom_interface_t **interf)\r\n{\r\nguint32 u32Pointer;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep, &u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_MInterfacePointer(tvb, offset, pinfo, tree, di, drep, hfindex, interf);\r\n} else {\r\nif(interf != NULL) {\r\n*interf = NULL;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic void dcom_cleanup(void) {\r\nif (dcom_machines != NULL) {\r\nGList *machines;\r\nfor(machines = dcom_machines; machines != NULL; machines = g_list_next(machines)) {\r\ndcom_machine_t *machine = (dcom_machine_t *)machines->data;\r\nif (machine->objects != NULL) {\r\nGList *objects;\r\nfor(objects = machine->objects; objects != NULL; objects = g_list_next(objects)) {\r\ndcom_object_t *object = (dcom_object_t *)objects->data;\r\nif (object->interfaces != NULL) {\r\nGList *interface;\r\nfor(interface = object->interfaces; interface != NULL; interface = g_list_next(interface)) {\r\ng_free(interface->data);\r\ninterface->data = NULL;\r\n}\r\ng_list_free(object->interfaces);\r\nobject->interfaces = NULL;\r\n}\r\ng_free(objects->data);\r\nobjects->data = NULL;\r\n}\r\ng_list_free(machine->objects);\r\nfree_address(&machine->ip);\r\nmachine->objects = NULL;\r\n}\r\ng_free(machines->data);\r\nmachines->data = NULL;\r\n}\r\ng_list_free(dcom_machines);\r\ndcom_machines = NULL;\r\n}\r\nif (dcom_interfaces != NULL) {\r\ng_list_free(dcom_interfaces);\r\ndcom_interfaces = NULL;\r\n}\r\n}\r\nvoid\r\nproto_register_dcom (void)\r\n{\r\nstatic hf_register_info hf_dcom_this_array[] = {\r\n#if 0\r\n{ &hf_dcom_this_version_major,\r\n{ "VersionMajor", "dcom.this.version_major", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n#endif\r\n#if 0\r\n{ &hf_dcom_this_version_minor,\r\n{ "VersionMinor", "dcom.this.version_minor", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n#endif\r\n{ &hf_dcom_this_flags,\r\n{ "Flags", "dcom.this.flags", FT_UINT32, BASE_HEX, VALS(dcom_thisthat_flag_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_this_res,\r\n{ "Reserved", "dcom.this.res", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_this_cid,\r\n{ "Causality ID", "dcom.this.uuid", FT_GUID, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_that_array[] = {\r\n{ &hf_dcom_that_flags,\r\n{ "Flags", "dcom.that.flags", FT_UINT32, BASE_HEX, VALS(dcom_thisthat_flag_vals), 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_extent_array[] = {\r\n{ &hf_dcom_extent,\r\n{ "Extension", "dcom.extent", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_extent_array_count,\r\n{ "Extension Count", "dcom.extent.array_count", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_extent_array_res,\r\n{ "Reserved", "dcom.extent.array_res", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_extent_size,\r\n{ "Extension Size", "dcom.extent.size", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_extent_id,\r\n{ "Extension Id", "dcom.extent.id", FT_GUID, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_array[] = {\r\n{ &hf_dcom_version_major,\r\n{ "VersionMajor", "dcom.version_major", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_version_minor,\r\n{ "VersionMinor", "dcom.version_minor", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_hresult,\r\n{ "HResult", "dcom.hresult", FT_UINT32, BASE_HEX, VALS(dcom_hresult_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_max_count,\r\n{ "MaxCount", "dcom.max_count", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_offset,\r\n{ "Offset", "dcom.offset", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_byte_length,\r\n{ "ByteLength", "dcom.byte_length", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n#if 0\r\n{ &hf_dcom_actual_count,\r\n{ "ActualCount", "dcom.actual_count", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n#endif\r\n{ &hf_dcom_tobedone,\r\n{ "To Be Done", "dcom.tobedone", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_nospec,\r\n{ "No Specification Available", "dcom.nospec", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n#if 0\r\n{ &hf_dcom_variant,\r\n{ "Variant", "dcom.variant", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n#endif\r\n{ &hf_dcom_variant_type,\r\n{ "VarType", "dcom.variant_type", FT_UINT16, BASE_HEX, VALS(dcom_variant_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_variant_type32,\r\n{ "VarType32", "dcom.variant_type32", FT_UINT32, BASE_HEX, VALS(dcom_variant_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_variant_size,\r\n{ "Size", "dcom.variant_size", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_variant_rpc_res,\r\n{ "RPC-Reserved", "dcom.variant_rpc_res", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_variant_wres,\r\n{ "Reserved", "dcom.variant_wres", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_array_size,\r\n{ "(ArraySize)", "dcom.array_size", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_pointer_val,\r\n{ "(PointerVal)", "dcom.pointer_val", FT_UINT32, BASE_HEX, VALS(dcom_dcerpc_pointer_vals), 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_interface_pointer_array[] = {\r\n{ &hf_dcom_interface_pointer,\r\n{ "InterfacePointer", "dcom.ifp", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_ip_cnt_data,\r\n{ "CntData", "dcom.ip_cnt_data", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_objref_array[] = {\r\n{ &hf_dcom_objref,\r\n{ "OBJREF", "dcom.objref", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_objref_signature,\r\n{ "Signature", "dcom.objref.signature", FT_UINT32, BASE_HEX, VALS(dcom_objref_signature_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_objref_flags,\r\n{ "Flags", "dcom.objref.flags", FT_UINT32, BASE_HEX, VALS(dcom_objref_flag_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_iid,\r\n{ "IID", "dcom.iid", FT_GUID, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_clsid,\r\n{ "CLSID", "dcom.clsid", FT_GUID, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_objref_resolver_address,\r\n{ "ResolverAddress", "dcom.objref.resolver_address", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_objref_cbextension,\r\n{ "CBExtension", "dcom.objref.cbextension", FT_UINT32, BASE_DEC, NULL, 0x0, "Size of extension data", HFILL }},\r\n{ &hf_dcom_objref_size,\r\n{ "Size", "dcom.objref.size", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_stdobjref_array[] = {\r\n{ &hf_dcom_stdobjref,\r\n{ "STDOBJREF", "dcom.stdobjref", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_stdobjref_flags,\r\n{ "Flags", "dcom.stdobjref.flags", FT_UINT32, BASE_HEX, VALS(dcom_stdobjref_flag_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_stdobjref_public_refs,\r\n{ "PublicRefs", "dcom.stdobjref.public_refs", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_oxid,\r\n{ "OXID", "dcom.oxid", FT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_oid,\r\n{ "OID", "dcom.oid", FT_UINT64, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_ipid,\r\n{ "IPID", "dcom.ipid", FT_GUID, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_custobjref_array[] = {\r\n{ &hf_dcom_custobjref,\r\n{ "CUSTOMOBJREF", "dcom.custobjref", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic hf_register_info hf_dcom_dualstringarray_array[] = {\r\n{ &hf_dcom_dualstringarray_num_entries,\r\n{ "NumEntries", "dcom.dualstringarray.num_entries", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_security_offset,\r\n{ "SecurityOffset", "dcom.dualstringarray.security_offset", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_string,\r\n{ "StringBinding", "dcom.dualstringarray.string", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_string_tower_id,\r\n{ "TowerId", "dcom.dualstringarray.tower_id", FT_UINT16, BASE_HEX, VALS(dcom_protseq_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_string_network_addr,\r\n{ "NetworkAddr", "dcom.dualstringarray.network_addr", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_security,\r\n{ "SecurityBinding", "dcom.dualstringarray.security", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_security_authn_svc,\r\n{ "AuthnSvc", "dcom.dualstringarray.security_authn_svc", FT_UINT16, BASE_HEX, VALS(dcom_dualstringarray_authn), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_security_authz_svc,\r\n{ "AuthzSvc", "dcom.dualstringarray.security_authz_svc", FT_UINT16, BASE_HEX, VALS(dcom_dualstringarray_authz), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_dualstringarray_security_princ_name,\r\n{ "PrincName", "dcom.dualstringarray.security_princ_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_vt_array[] = {\r\n{ &hf_dcom_vt_bool,\r\n{ "VT_BOOL", "dcom.vt.bool", FT_UINT16, BASE_HEX, VALS(dcom_vt_bool_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_i1,\r\n{ "VT_I1", "dcom.vt.i1", FT_INT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_i2,\r\n{ "VT_I2", "dcom.vt.i2", FT_INT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_i4,\r\n{ "VT_I4", "dcom.vt.i4", FT_INT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_i8,\r\n{ "VT_I8", "dcom.vt.i8", FT_INT64, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_cy,\r\n{ "VT_CY", "dcom.vt.cy", FT_INT64, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_ui1,\r\n{ "VT_UI1", "dcom.vt.ui1", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_ui2,\r\n{ "VT_UI2", "dcom.vt.ui2", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_ui4,\r\n{ "VT_UI4", "dcom.vt.ui4", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_ui8,\r\n{ "VT_UI8", "dcom.vt.ui8", FT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_r4,\r\n{ "VT_R4", "dcom.vt.r4", FT_FLOAT, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_r8,\r\n{ "VT_R8", "dcom.vt.r8", FT_DOUBLE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_date,\r\n{ "VT_DATE", "dcom.vt.date", FT_DOUBLE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_bstr,\r\n{ "VT_BSTR", "dcom.vt.bstr", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_byref,\r\n{ "BYREF", "dcom.vt.byref", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_vt_dispatch,\r\n{ "VT_DISPATCH", "dcom.vt.dispatch", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic hf_register_info hf_dcom_sa_array[] = {\r\n{ &hf_dcom_safearray,\r\n{ "SAFEARRAY", "dcom.sa", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_dims32,\r\n{ "Dims32", "dcom.sa.dims32", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_dims16,\r\n{ "Dims16", "dcom.sa.dims16", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_features,\r\n{ "Features", "dcom.sa.features", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_element_size,\r\n{ "ElementSize", "dcom.sa.element_size", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_locks,\r\n{ "Locks", "dcom.sa.locks", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_vartype32,\r\n{ "VarType32", "dcom.sa.vartype", FT_UINT32, BASE_DEC, VALS(dcom_variant_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_vartype16,\r\n{ "VarType16", "dcom.sa.vartype", FT_UINT16, BASE_DEC, VALS(dcom_variant_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_elements,\r\n{ "Elements", "dcom.sa.elements", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_bound_elements,\r\n{ "BoundElements", "dcom.sa.bound_elements", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_low_bound,\r\n{ "LowBound", "dcom.sa.low_bound", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_auto,\r\n{ "AUTO", "dcom.sa.features_auto", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_AUTO, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_static,\r\n{ "STATIC", "dcom.sa.features_static", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_STATIC, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_embedded,\r\n{ "EMBEDDED", "dcom.sa.features_embedded", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_EMBEDDED, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_fixedsize,\r\n{ "FIXEDSIZE", "dcom.sa.features_fixedsize", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_FIXEDSIZE, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_record,\r\n{ "RECORD", "dcom.sa.features_record", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_RECORD, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_have_iid,\r\n{ "HAVEIID", "dcom.sa.features_have_iid", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_HAVEIID, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_have_vartype,\r\n{ "HAVEVARTYPE", "dcom.sa.features_have_vartype", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_HAVEVARTYPE, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_bstr,\r\n{ "BSTR", "dcom.sa.features_bstr", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_BSTR, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_unknown,\r\n{ "UNKNOWN", "dcom.sa.features_unknown", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_UNKNOWN, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_dispatch,\r\n{ "DISPATCH", "dcom.sa.features_dispatch", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_DISPATCH, NULL, HFILL }},\r\n{ &hf_dcom_sa_features_variant,\r\n{ "VARIANT", "dcom.sa.features_variant", FT_BOOLEAN, 16, TFS (&tfs_set_notset), WIRESHARK_FADF_VARIANT, NULL, HFILL }}\r\n};\r\nstatic gint *ett_dcom[] = {\r\n&ett_dcom_this,\r\n&ett_dcom_that,\r\n&ett_dcom_extent,\r\n&ett_dcom_lpwstr,\r\n&ett_dcom_interface_pointer,\r\n&ett_dcom_objref,\r\n&ett_dcom_stdobjref,\r\n&ett_dcom_custobjref,\r\n&ett_dcom_dualstringarray,\r\n&ett_dcom_dualstringarray_binding,\r\n&ett_dcom_variant,\r\n&ett_dcom_safearray,\r\n&ett_dcom_sa_features,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_dcom_dissetion_incomplete, { "dcom.dissetion_incomplete", PI_UNDECODED, PI_WARN, "Dissection incomplete", EXPFILL }},\r\n{ &ei_dcom_no_spec, { "dcom.no_spec", PI_UNDECODED, PI_NOTE, "No specification available, dissection not possible", EXPFILL }},\r\n{ &ei_dcom_hresult_expert, { "dcom.hresult.expert", PI_RESPONSE_CODE, PI_NOTE, "Hresult", EXPFILL }},\r\n{ &ei_dcom_dualstringarray_mult_ip, { "dcom.dualstringarray.mult_ip", PI_UNDECODED, PI_NOTE, "DUALSTRINGARRAY Multiple IP", EXPFILL }},\r\n};\r\nmodule_t *dcom_module;\r\nexpert_module_t* expert_dcom;\r\nproto_dcom = proto_register_protocol ("DCOM", "DCOM", "dcom");\r\nproto_register_field_array(proto_dcom, hf_dcom_this_array, array_length(hf_dcom_this_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_that_array, array_length(hf_dcom_that_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_extent_array, array_length(hf_dcom_extent_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_array, array_length(hf_dcom_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_objref_array, array_length(hf_dcom_objref_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_stdobjref_array, array_length(hf_dcom_stdobjref_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_custobjref_array, array_length(hf_dcom_custobjref_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_dualstringarray_array, array_length(hf_dcom_dualstringarray_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_interface_pointer_array, array_length(hf_dcom_interface_pointer_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_vt_array, array_length(hf_dcom_vt_array));\r\nproto_register_field_array(proto_dcom, hf_dcom_sa_array, array_length(hf_dcom_sa_array));\r\nproto_register_subtree_array (ett_dcom, array_length (ett_dcom));\r\nexpert_dcom = expert_register_protocol(proto_dcom);\r\nexpert_register_field_array(expert_dcom, ei, array_length(ei));\r\ndcom_module = prefs_register_protocol(proto_dcom, NULL);\r\nprefs_register_bool_preference(dcom_module, "display_unmarshalling_details",\r\n"Display DCOM unmarshalling details",\r\n"Display some DCOM unmarshalled fields "\r\n"usually hidden",\r\n&dcom_prefs_display_unmarshalling_details);\r\nregister_cleanup_routine(dcom_cleanup);\r\n}\r\nvoid\r\nproto_reg_handoff_dcom (void)\r\n{\r\nguids_add_uuid(&uuid_debug_ext, "Debug Information Body Extension");\r\nguids_add_uuid(&uuid_ext_error_ext, "Extended Error Info Body Extension");\r\nguids_add_uuid(&ipid_rem_unknown, "IRemUnknown");\r\nguids_add_uuid(&iid_unknown, "IUnknown");\r\nguids_add_uuid(&uuid_null, "NULL");\r\nguids_add_uuid(&iid_class_factory, "IClassFactory");\r\n}

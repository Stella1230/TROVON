static int\r\ndissect_x29(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nint offset = 0;\r\nproto_tree *x29_tree;\r\nproto_item *ti;\r\ngboolean *q_bit_set;\r\nguint8 msg_code;\r\nguint8 error_type;\r\nguint8 type_ref;\r\ngint next_offset;\r\nint linelen;\r\nif (data == NULL)\r\nreturn 0;\r\nq_bit_set = (gboolean *)data;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "X.29");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_x29, tvb, offset, -1, ENC_NA);\r\nx29_tree = proto_item_add_subtree(ti, ett_x29);\r\nif (*q_bit_set) {\r\nmsg_code = tvb_get_guint8(tvb, offset);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s PAD message",\r\nval_to_str(msg_code, message_code_vals,\r\n"Unknown (0x%02x)"));\r\nproto_tree_add_uint(x29_tree, hf_msg_code, tvb,\r\noffset, 1, msg_code);\r\noffset++;\r\nswitch (msg_code) {\r\ncase SET_MSG:\r\ncase READ_MSG:\r\ncase SET_AND_READ_MSG:\r\ncase PARAMETER_IND_MSG:\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_item(x29_tree, hf_x29_parameter, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(x29_tree, hf_x29_value, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\n}\r\nbreak;\r\ncase INV_TO_CLEAR_MSG:\r\nbreak;\r\ncase ERROR_MSG:\r\nerror_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(x29_tree, hf_error_type, tvb,\r\noffset, 1, error_type);\r\noffset++;\r\nif (error_type != 0) {\r\nproto_tree_add_item(x29_tree, hf_inv_msg_code,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\ncase BREAK_IND_MSG:\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\ntype_ref = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(x29_tree, hf_x29_type_reference, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nswitch (type_ref) {\r\ncase 0x01:\r\nproto_tree_add_item(x29_tree, hf_x29_type_of_aspect, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase 0x08:\r\nproto_tree_add_item(x29_tree, hf_x29_break_value, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(x29_tree, hf_x29_type_reference_value, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase RESELECTION_MSG:\r\nproto_tree_add_item(x29_tree, hf_x29_reselection_message_data, tvb, offset, -1, ENC_NA);\r\nbreak;\r\ncase RESEL_WITH_TOA_NPI_MSG:\r\nproto_tree_add_item(x29_tree, hf_x29_reselection_message_data, tvb, offset, -1, ENC_NA);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(x29_tree, hf_x29_pad_message_data, tvb, offset, -1, ENC_NA);\r\nbreak;\r\n}\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Data ...");\r\nif (tree) {\r\nwhile (tvb_offset_exists(tvb, offset)) {\r\ntvb_find_line_end(tvb, offset, -1,\r\n&next_offset, FALSE);\r\nlinelen = next_offset - offset;\r\nproto_tree_add_item(x29_tree, hf_x29_data, tvb, offset, linelen, ENC_NA|ENC_ASCII);\r\noffset = next_offset;\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_x29(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_msg_code,\r\n{ "Message code", "x29.msg_code", FT_UINT8, BASE_HEX,\r\nVALS(message_code_vals), 0x0, "X.29 PAD message code",\r\nHFILL }},\r\n{ &hf_error_type,\r\n{ "Error type", "x29.error_type", FT_UINT8, BASE_HEX,\r\nVALS(error_type_vals), 0x0, "X.29 error PAD message error type",\r\nHFILL }},\r\n{ &hf_inv_msg_code,\r\n{ "Invalid message code", "x29.inv_msg_code", FT_UINT8, BASE_HEX,\r\nVALS(message_code_vals), 0x0, "X.29 Error PAD message invalid message code",\r\nHFILL }},\r\n{ &hf_x29_type_reference, { "Type reference", "x29.type_reference", FT_UINT8, BASE_DEC, VALS(reference_type_vals), 0x0, NULL, HFILL }},\r\n{ &hf_x29_type_of_aspect, { "Type of aspect", "x29.type_of_aspect", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_break_value, { "Break value", "x29.break_value", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_type_reference_value, { "Type value", "x29.type_reference.value", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_reselection_message_data, { "Reselection message data", "x29.reselection_message_data", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_pad_message_data, { "PAD message data", "x29.pad_message_data", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_data, { "Data", "x29.data", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_parameter, { "Parameter", "x29.parameter", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_x29_value, { "Value", "x29.value", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_x29,\r\n};\r\nproto_x29 = proto_register_protocol("X.29", "X.29", "x29");\r\nproto_register_field_array(proto_x29, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_x29(void)\r\n{\r\ndissector_handle_t x29_handle;\r\nx29_handle = create_dissector_handle(dissect_x29, proto_x29);\r\ndissector_add_uint("x.25.spi", NLPID_SPI_X_29, x29_handle);\r\n}

static void\r\ndissect_sender_array(proto_tree *clique_rm_tree, int hf_header, gint ett_header,\r\nint hf_header_sender, tvbuff_t *tvb, int offset)\r\n{\r\nguint i, count;\r\nint len;\r\nproto_item *ti;\r\nproto_tree *tree;\r\ncount = tvb_get_guint8(tvb, offset);\r\nlen = 1 + 4 * count;\r\nti = proto_tree_add_item(clique_rm_tree, hf_header, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_set_len(ti, len);\r\ntree = proto_item_add_subtree(ti, ett_header);\r\noffset++;\r\nfor (i = 0; i < count; i++, offset += 4)\r\nproto_tree_add_item(tree, hf_header_sender, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_data_packet(proto_tree *clique_rm_tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_tree *tree;\r\ntree = proto_tree_add_subtree(clique_rm_tree, tvb, offset, -1, ett_clique_rm_data, NULL, "Data");\r\nproto_tree_add_item(tree, hf_clique_rm_data_flags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_clique_rm_data_stream_id, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_clique_rm_data_size, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_clique_rm_data_data, tvb, offset, -1, ENC_NA);\r\n}\r\nstatic int\r\ndissect_depends(proto_tree *clique_rm_tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_item *ti;\r\nproto_tree *tree, *depend_tree;\r\nguint ii, count;\r\nint len;\r\ncount = tvb_get_guint8(tvb, offset);\r\nlen = 1 + count * 8;\r\nti = proto_tree_add_item(clique_rm_tree,\r\nhf_clique_rm_depends, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_set_len(ti, len);\r\noffset += 1;\r\ntree = proto_item_add_subtree(ti, ett_clique_rm_depends);\r\nfor (ii = 0; ii < count; ii++)\r\n{\r\ndepend_tree = proto_tree_add_subtree_format(tree, tvb, offset, 8,\r\nett_clique_rm_depends_item, NULL, "Depend item %d", ii+1);\r\nproto_tree_add_item(depend_tree, hf_clique_rm_depend_sender,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(depend_tree, hf_clique_rm_depend_packet_id,\r\ntvb, offset+4, 4, ENC_BIG_ENDIAN);\r\noffset += 8;\r\n}\r\nreturn len;\r\n}\r\nstatic void\r\ndissect_reliable_packet(proto_tree *clique_rm_tree, guint8 type, tvbuff_t *tvb, int offset)\r\n{\r\nif (!clique_rm_tree)\r\nreturn;\r\nproto_tree_add_item(clique_rm_tree, hf_clique_rm_packet_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += dissect_depends(clique_rm_tree, tvb, offset);\r\nswitch (type)\r\n{\r\ncase PACKET_TYPE_DATA:\r\ndissect_data_packet(clique_rm_tree, tvb, offset);\r\nbreak;\r\ncase PACKET_TYPE_NO_DATA:\r\nbreak;\r\ncase PACKET_TYPE_FAILURE:\r\ndissect_sender_array(clique_rm_tree, hf_clique_rm_failures,\r\nett_clique_rm_failures, hf_clique_rm_failures_senders, tvb, offset);\r\nbreak;\r\ncase PACKET_TYPE_ATTEMPT_JOIN:\r\ndissect_sender_array(clique_rm_tree, hf_clique_rm_attempt_join,\r\nett_clique_rm_attempt_join, hf_clique_rm_attempt_join_senders, tvb, offset);\r\nbreak;\r\ncase PACKET_TYPE_JOIN:\r\ndissect_sender_array(clique_rm_tree, hf_clique_rm_join_failures,\r\nett_clique_rm_join_failures, hf_clique_rm_join_failures_senders, tvb, offset);\r\nbreak;\r\ncase PACKET_TYPE_BYE:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void\r\ndissect_unreliable_packet(proto_tree *clique_rm_tree, guint8 type, tvbuff_t *tvb, int offset)\r\n{\r\nguint len;\r\nif (!clique_rm_tree)\r\nreturn;\r\nswitch (type)\r\n{\r\ncase PACKET_TYPE_WHOIS_REQUEST:\r\nproto_tree_add_item(clique_rm_tree,\r\nhf_clique_rm_whois_request_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase PACKET_TYPE_WHOIS_REPLY:\r\nlen = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(clique_rm_tree,\r\nhf_clique_rm_whois_reply_name_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(clique_rm_tree,\r\nhf_clique_rm_whois_reply_name, tvb, offset, len, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase PACKET_TYPE_REPAIR_REQUEST:\r\nproto_tree_add_item(clique_rm_tree,\r\nhf_clique_rm_repair_request_sender_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(clique_rm_tree,\r\nhf_clique_rm_repair_request_packet_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase PACKET_TYPE_SESSION:\r\ndissect_depends(clique_rm_tree, tvb, offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic gboolean\r\ndissect_clique_rm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *clique_rm_tree;\r\nguint8 version;\r\nguint8 type;\r\nint offset = 0;\r\nguint64 qword;\r\nif (tvb_captured_length(tvb) < 12)\r\nreturn FALSE;\r\nqword = tvb_get_ntoh48(tvb,0);\r\nif(qword != G_GUINT64_CONSTANT (0x436c69717565))\r\nreturn FALSE;\r\noffset += 6;\r\nversion = tvb_get_guint8(tvb, offset);\r\nif (version != 1)\r\nreturn FALSE;\r\noffset++;\r\ntype = tvb_get_guint8(tvb, offset);\r\noffset++;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Clique-rm");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s",\r\nval_to_str(type, packet_type_vals, "Unknown (0x%02x)"));\r\noffset = 6;\r\nti = proto_tree_add_item(tree, proto_clique_rm, tvb, 0, -1, ENC_NA);\r\nclique_rm_tree = proto_item_add_subtree(ti, ett_clique_rm);\r\nproto_tree_add_item(clique_rm_tree, hf_clique_rm_version, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(clique_rm_tree, hf_clique_rm_type, tvb, offset, 1,\r\nENC_BIG_ENDIAN);\r\noffset++;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", sender: 0x%x",\r\ntvb_get_ntohl(tvb, offset));\r\nproto_tree_add_item(clique_rm_tree, hf_clique_rm_sender, tvb, offset,\r\n4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (IS_RELIABLE(type)) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", id: 0x%x",\r\ntvb_get_ntohl(tvb, offset));\r\ndissect_reliable_packet(clique_rm_tree, type, tvb, offset);\r\n} else {\r\ndissect_unreliable_packet(clique_rm_tree, type, tvb, offset);\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_clique_rm(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_clique_rm_version,\r\n{ "Version", "clique_rm.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_type,\r\n{ "Type", "clique_rm.type",\r\nFT_UINT8, BASE_HEX, VALS(packet_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_sender,\r\n{ "Sender", "clique_rm.sender",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_packet_id,\r\n{ "Packet id", "clique_rm.packet_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_depends,\r\n{ "Depends", "clique_rm.depends",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_depend_sender,\r\n{ "Sender", "clique_rm.depends.sender",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_depend_packet_id,\r\n{ "Packet id", "clique_rm.depends.packet_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_failures,\r\n{ "Failures", "clique_rm.failures",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_failures_senders,\r\n{ "Sender", "clique_rm.failures.sender",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_attempt_join,\r\n{ "New attempt join senders", "clique_rm.attempt_join",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_attempt_join_senders,\r\n{ "Sender", "clique_rm.attempt_join.sender",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_join_failures,\r\n{ "Join failures", "clique_rm.join_failures",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_join_failures_senders,\r\n{ "Sender", "clique_rm.join_failures.sender",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_data_flags,\r\n{ "Data flags", "clique_rm.data.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_data_size,\r\n{ "Data total size", "clique_rm.data.size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_data_stream_id,\r\n{ "Data stream id", "clique_rm.data.stream_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_data_data,\r\n{ "Raw data", "clique_rm.data.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_whois_request_id,\r\n{ "Whois request id", "clique_rm.whois_request.id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_whois_reply_name_length,\r\n{ "Whois reply name length", "clique_rm.whois_reply.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_whois_reply_name,\r\n{ "Whois reply name", "clique_rm.whois_reply.name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_repair_request_sender_id,\r\n{ "Repair request for sender",\r\n"clique_rm.repair_request.sender_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_clique_rm_repair_request_packet_id,\r\n{ "Repair request for packet",\r\n"clique_rm.repair_request.packet_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_clique_rm,\r\n&ett_clique_rm_depends,\r\n&ett_clique_rm_depends_item,\r\n&ett_clique_rm_data,\r\n&ett_clique_rm_failures,\r\n&ett_clique_rm_join_failures,\r\n&ett_clique_rm_attempt_join,\r\n&ett_clique_rm_join,\r\n};\r\nproto_clique_rm = proto_register_protocol(\r\n"Clique Reliable Multicast Protocol", "Clique-rm", "clique-rm");\r\nproto_register_field_array(proto_clique_rm, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_clique_rm(void)\r\n{\r\nheur_dissector_add("udp", dissect_clique_rm, "Clique RM over UDP", "clique_rm_udp", proto_clique_rm, HEURISTIC_ENABLE);\r\n}

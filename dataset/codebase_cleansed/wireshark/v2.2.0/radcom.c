wtap_open_return_val radcom_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nguint8 r_magic[8], t_magic[11], search_encap[7];\r\nstruct frame_date start_date;\r\n#if 0\r\nguint32 sec;\r\nstruct tm tm;\r\n#endif\r\nif (!wtap_read_bytes(wth->fh, r_magic, 8, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nr_magic[1] = 0xD2;\r\nr_magic[2] = 0x00;\r\nif (memcmp(r_magic, radcom_magic, 8) != 0) {\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (!wtap_read_bytes(wth->fh, t_magic, 11, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nwhile (memcmp(t_magic, active_time_magic, 11) != 0)\r\n{\r\nif (file_seek(wth->fh, -10, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nif (!wtap_read_bytes(wth->fh, t_magic, 11, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\n}\r\nif (file_seek(wth->fh, -43, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nif (!wtap_read_bytes(wth->fh, &start_date, sizeof(struct frame_date),\r\nerr, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (file_seek(wth->fh, sizeof(struct frame_date), SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nfor (;;) {\r\nif (!wtap_read_bytes(wth->fh, search_encap, 4,\r\nerr, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (memcmp(encap_magic, search_encap, 4) == 0)\r\nbreak;\r\nif (file_seek(wth->fh, -3, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nif (file_seek(wth->fh, 12, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nif (!wtap_read_bytes(wth->fh, search_encap, 4, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_RADCOM;\r\nwth->subtype_read = radcom_read;\r\nwth->subtype_seek_read = radcom_seek_read;\r\nwth->snapshot_length = 0;\r\nwth->file_tsprec = WTAP_TSPREC_USEC;\r\n#if 0\r\ntm.tm_year = pletoh16(&start_date.year)-1900;\r\ntm.tm_mon = start_date.month-1;\r\ntm.tm_mday = start_date.day;\r\nsec = pletoh32(&start_date.sec);\r\ntm.tm_hour = sec/3600;\r\ntm.tm_min = (sec%3600)/60;\r\ntm.tm_sec = sec%60;\r\ntm.tm_isdst = -1;\r\n#endif\r\nif (memcmp(search_encap, "LAPB", 4) == 0)\r\nwth->file_encap = WTAP_ENCAP_LAPB;\r\nelse if (memcmp(search_encap, "Ethe", 4) == 0)\r\nwth->file_encap = WTAP_ENCAP_ETHERNET;\r\nelse if (memcmp(search_encap, "ATM/", 4) == 0)\r\nwth->file_encap = WTAP_ENCAP_ATM_RFC1483;\r\nelse {\r\n*err = WTAP_ERR_UNSUPPORTED;\r\n*err_info = g_strdup_printf("radcom: network type \"%.4s\" unknown", search_encap);\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\n#if 0\r\nif (!wtap_read_bytes(wth->fh, &next_date, sizeof(struct frame_date),\r\nerr, err_info))\r\nreturn WTAP_OPEN_ERROR;\r\nwhile (memcmp(&start_date, &next_date, 4)) {\r\nif (file_seek(wth->fh, 1-sizeof(struct frame_date), SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nif (!wtap_read_bytes(wth->fh, &next_date, sizeof(struct frame_date),\r\nerr, err_info))\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\n#endif\r\nif (wth->file_encap == WTAP_ENCAP_ETHERNET) {\r\nif (file_seek(wth->fh, 294, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\n} else if (wth->file_encap == WTAP_ENCAP_LAPB) {\r\nif (file_seek(wth->fh, 297, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\n} else if (wth->file_encap == WTAP_ENCAP_ATM_RFC1483) {\r\nif (file_seek(wth->fh, 504, SEEK_CUR, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic gboolean radcom_read(wtap *wth, int *err, gchar **err_info,\r\ngint64 *data_offset)\r\n{\r\nchar fcs[2];\r\n*data_offset = file_tell(wth->fh);\r\nif (!radcom_read_rec(wth, wth->fh, &wth->phdr, wth->frame_buffer,\r\nerr, err_info)) {\r\nreturn FALSE;\r\n}\r\nif (wth->file_encap == WTAP_ENCAP_LAPB) {\r\nif (!wtap_read_bytes(wth->fh, &fcs, sizeof fcs, err, err_info))\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nradcom_seek_read(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf,\r\nint *err, gchar **err_info)\r\n{\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nif (!radcom_read_rec(wth, wth->random_fh, phdr, buf, err,\r\nerr_info)) {\r\nif (*err == 0) {\r\n*err = WTAP_ERR_SHORT_READ;\r\n}\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nradcom_read_rec(wtap *wth, FILE_T fh, struct wtap_pkthdr *phdr, Buffer *buf,\r\nint *err, gchar **err_info)\r\n{\r\nstruct radcomrec_hdr hdr;\r\nguint16 data_length, real_length, length;\r\nguint32 sec;\r\nstruct tm tm;\r\nguint8 atmhdr[8];\r\nif (!wtap_read_bytes_or_eof(fh, &hdr, sizeof hdr, err, err_info))\r\nreturn FALSE;\r\ndata_length = pletoh16(&hdr.data_length);\r\nif (data_length == 0) {\r\n*err = 0;\r\nreturn FALSE;\r\n}\r\nlength = pletoh16(&hdr.length);\r\nreal_length = pletoh16(&hdr.real_length);\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = WTAP_HAS_TS|WTAP_HAS_CAP_LEN;\r\ntm.tm_year = pletoh16(&hdr.date.year)-1900;\r\ntm.tm_mon = (hdr.date.month&0x0f)-1;\r\ntm.tm_mday = hdr.date.day;\r\nsec = pletoh32(&hdr.date.sec);\r\ntm.tm_hour = sec/3600;\r\ntm.tm_min = (sec%3600)/60;\r\ntm.tm_sec = sec%60;\r\ntm.tm_isdst = -1;\r\nphdr->ts.secs = mktime(&tm);\r\nphdr->ts.nsecs = pletoh32(&hdr.date.usec) * 1000;\r\nswitch (wth->file_encap) {\r\ncase WTAP_ENCAP_ETHERNET:\r\nphdr->pseudo_header.eth.fcs_len = -1;\r\nbreak;\r\ncase WTAP_ENCAP_LAPB:\r\nphdr->pseudo_header.x25.flags = (hdr.dce & 0x1) ?\r\n0x00 : FROM_DCE;\r\nlength -= 2;\r\nreal_length -= 2;\r\nbreak;\r\ncase WTAP_ENCAP_ATM_RFC1483:\r\nif (!wtap_read_bytes(fh, atmhdr, sizeof atmhdr, err,\r\nerr_info))\r\nreturn FALSE;\r\nlength -= 8;\r\nreal_length -= 8;\r\nbreak;\r\n}\r\nphdr->len = real_length;\r\nphdr->caplen = length;\r\nif (!wtap_read_packet_bytes(fh, buf, length, err, err_info))\r\nreturn FALSE;\r\nreturn TRUE;\r\n}

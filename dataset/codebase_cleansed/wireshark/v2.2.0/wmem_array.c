wmem_array_t *\r\nwmem_array_sized_new(wmem_allocator_t *allocator, gsize elem_size,\r\nguint alloc_count)\r\n{\r\nwmem_array_t *array;\r\narray = wmem_new(allocator, wmem_array_t);\r\narray->allocator = allocator;\r\narray->elem_size = elem_size;\r\narray->elem_count = 0;\r\narray->alloc_count = alloc_count ? alloc_count : 1;\r\narray->null_terminated = FALSE;\r\narray->buf = (guint8 *)wmem_alloc(array->allocator,\r\narray->elem_size * array->alloc_count);\r\nreturn array;\r\n}\r\nwmem_array_t *\r\nwmem_array_new(wmem_allocator_t *allocator, const gsize elem_size)\r\n{\r\nwmem_array_t *array;\r\narray = wmem_array_sized_new(allocator, elem_size, 1);\r\nreturn array;\r\n}\r\nstatic void\r\nwmem_array_grow(wmem_array_t *array, const guint to_add)\r\n{\r\nguint new_alloc_count, new_count;\r\nnew_alloc_count = array->alloc_count;\r\nnew_count = array->elem_count + to_add;\r\nwhile (new_alloc_count < new_count) {\r\nnew_alloc_count *= 2;\r\n}\r\nif (new_alloc_count == array->alloc_count) {\r\nreturn;\r\n}\r\narray->buf = (guint8 *)wmem_realloc(array->allocator, array->buf,\r\nnew_alloc_count * array->elem_size);\r\narray->alloc_count = new_alloc_count;\r\n}\r\nstatic void\r\nwmem_array_write_null_terminator(wmem_array_t *array)\r\n{\r\nif (array->null_terminated) {\r\nwmem_array_grow(array, 1);\r\nmemset(&array->buf[array->elem_count * array->elem_size], 0x0, array->elem_size);\r\n}\r\n}\r\nvoid\r\nwmem_array_set_null_terminator(wmem_array_t *array)\r\n{\r\narray->null_terminated = TRUE;\r\nwmem_array_write_null_terminator(array);\r\n}\r\nvoid\r\nwmem_array_bzero(wmem_array_t *array)\r\n{\r\nmemset(array->buf, 0x0, array->elem_size * array->elem_count);\r\n}\r\nvoid\r\nwmem_array_append(wmem_array_t *array, const void *in, guint count)\r\n{\r\nwmem_array_grow(array, count);\r\nmemcpy(&array->buf[array->elem_count * array->elem_size], in,\r\ncount * array->elem_size);\r\narray->elem_count += count;\r\nwmem_array_write_null_terminator(array);\r\n}\r\nvoid *\r\nwmem_array_index(wmem_array_t *array, guint array_index)\r\n{\r\ng_assert(array_index < array->elem_count);\r\nreturn &array->buf[array_index * array->elem_size];\r\n}\r\nvoid\r\nwmem_array_sort(wmem_array_t *array, int (*compar)(const void*,const void*))\r\n{\r\nqsort(array->buf, array->elem_count, array->elem_size, compar);\r\n}\r\nvoid *\r\nwmem_array_get_raw(wmem_array_t *array)\r\n{\r\nreturn array->buf;\r\n}\r\nguint\r\nwmem_array_get_count(wmem_array_t *array)\r\n{\r\nreturn array->elem_count;\r\n}

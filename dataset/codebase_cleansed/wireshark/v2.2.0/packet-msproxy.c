static int msproxy_sub_dissector( tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_) {\r\nguint32 *ptr;\r\nredirect_entry_t *redirect_info;\r\nconversation_t *conversation;\r\nproto_tree *msp_tree;\r\nproto_item *ti;\r\nconversation = find_conversation( pinfo->num, &pinfo->src, &pinfo->dst,\r\npinfo->ptype, pinfo->srcport, pinfo->destport, 0);\r\nDISSECTOR_ASSERT( conversation);\r\nredirect_info = (redirect_entry_t *)conversation_get_proto_data(conversation,\r\nproto_msproxy);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MS Proxy");\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\n(( redirect_info->proto == PT_TCP) ? "TCP stream" :\r\n"UDP packets"));\r\nif ( tree) {\r\nti = proto_tree_add_item( tree, proto_msproxy, tvb, 0, 0,\r\nENC_NA );\r\nmsp_tree = proto_item_add_subtree(ti, ett_msproxy);\r\nproto_tree_add_uint( msp_tree, hf_msproxy_dstport, tvb, 0, 0,\r\nredirect_info->remote_port);\r\nproto_tree_add_ipv4( msp_tree, hf_msproxy_dstaddr, tvb, 0, 0,\r\nredirect_info->remote_addr);\r\n}\r\nif ( pinfo->srcport == redirect_info->clnt_port)\r\nptr = &pinfo->destport;\r\nelse\r\nptr = &pinfo->srcport;\r\n*ptr = redirect_info->remote_port;\r\nif ( redirect_info->proto == PT_TCP)\r\ndecode_tcp_ports( tvb, 0, pinfo, tree, pinfo->srcport,\r\npinfo->destport, NULL, NULL);\r\nelse\r\ndecode_udp_ports( tvb, 0, pinfo, tree, pinfo->srcport,\r\npinfo->destport, -1);\r\n*ptr = redirect_info->server_int_port;\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void add_msproxy_conversation( packet_info *pinfo,\r\nhash_entry_t *hash_info){\r\nconversation_t *conversation;\r\nredirect_entry_t *new_conv_info;\r\nif (pinfo->fd->flags.visited) {\r\nreturn;\r\n}\r\nconversation = find_conversation( pinfo->num, &pinfo->src,\r\n&pinfo->dst, (port_type)hash_info->proto, hash_info->server_int_port,\r\nhash_info->clnt_port, 0);\r\nif ( !conversation) {\r\nconversation = conversation_new( pinfo->num, &pinfo->src, &pinfo->dst,\r\n(port_type)hash_info->proto, hash_info->server_int_port,\r\nhash_info->clnt_port, 0);\r\n}\r\nconversation_set_dissector(conversation, msproxy_sub_handle);\r\nnew_conv_info = wmem_new(wmem_file_scope(), redirect_entry_t);\r\nnew_conv_info->remote_addr = hash_info->dst_addr;\r\nnew_conv_info->clnt_port = hash_info->clnt_port;\r\nnew_conv_info->remote_port = hash_info->dst_port;\r\nnew_conv_info->server_int_port = hash_info->server_int_port;\r\nnew_conv_info->proto = hash_info->proto;\r\nconversation_add_proto_data(conversation, proto_msproxy,\r\nnew_conv_info);\r\n}\r\nstatic int display_application_name(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\nint length;\r\nlength = tvb_strnlen( tvb, offset, 255);\r\nproto_tree_add_item(tree, hf_msproxy_application, tvb, offset, length, ENC_ASCII|ENC_NA);\r\nreturn length;\r\n}\r\nstatic const char *get_msproxy_cmd_name( int cmd, int direction) {\r\nswitch (cmd){\r\ncase MSPROXY_HELLO_2:\r\ncase MSPROXY_HELLO: return "Hello";\r\ncase MSPROXY_USERINFO:\r\nif ( direction == FROM_SERVER)\r\nreturn "Hello Acknowledge";\r\nelse\r\nreturn "User Info";\r\ncase MSPROXY_USERINFO_ACK: return "User Info Acknowledge";\r\ncase MSPROXY_AUTH: return "Authentication";\r\ncase MSPROXY_AUTH_1_ACK: return "Authentication Acknowledge";\r\ncase MSPROXY_AUTH_2: return "Authentication 2";\r\ncase MSPROXY_AUTH_2_ACK: return "Authentication 2 Acknowledge";\r\ncase MSPROXY_RESOLVE: return "Resolve";\r\ncase MSPROXY_RESOLVE_ACK: return "Resolve Acknowledge";\r\ncase MSPROXY_BIND: return "Bind";\r\ncase MSPROXY_TCP_BIND: return "TCP Bind";\r\ncase MSPROXY_TCP_BIND_ACK: return "TCP Bind Acknowledge";\r\ncase MSPROXY_LISTEN: return "Listen";\r\ncase MSPROXY_BINDINFO: return "Bind Info";\r\ncase MSPROXY_BINDINFO_ACK: return "Bind Info Acknowledge";\r\ncase MSPROXY_CONNECT: return "Connect";\r\ncase MSPROXY_CONNECT_ACK: return "Connect Acknowledge";\r\ncase MSPROXY_UDPASSOCIATE: return "UDP Associate";\r\ncase MSPROXY_UDP_BIND_REQ: return "UDP Bind";\r\ncase MSPROXY_UDPASSOCIATE_ACK: return "Bind or Associate Acknowledge";\r\ncase MSPROXY_CONNECTED: return "Connected";\r\ncase MSPROXY_SESSIONEND: return "Session End";\r\ndefault: return "Unknown";\r\n}\r\n}\r\nstatic void dissect_user_info_2(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\nint length;\r\nif ( tree) {\r\nlength = tvb_strnlen( tvb, offset, 255);\r\nif (length == -1)\r\nreturn;\r\nproto_tree_add_item(tree, hf_msproxy_user_name, tvb, offset, length + 1, ENC_ASCII|ENC_NA);\r\noffset += length + 2;\r\nlength = tvb_strnlen( tvb, offset, 255);\r\nif (length == -1)\r\nreturn;\r\nproto_tree_add_item(tree, hf_msproxy_application_name, tvb, offset, length + 1, ENC_ASCII|ENC_NA);\r\noffset += length + 1;\r\nlength = tvb_strnlen( tvb, offset, 255);\r\nif (length == -1)\r\nreturn;\r\nproto_tree_add_item(tree, hf_msproxy_client_computer_name, tvb, offset, length + 1, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\nstatic void dissect_msproxy_request_1(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\noffset += 182;\r\ndissect_user_info_2( tvb, offset, tree);\r\n}\r\nstatic void dissect_bind(tvbuff_t *tvb, int offset,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\noffset += 18;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_bindaddr, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 4;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_bindport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 6;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_clntport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nconv_info->clnt_port = tvb_get_ntohs( tvb, offset);\r\noffset += 6;\r\nif ( tree){\r\nproto_tree_add_item( tree, hf_msproxy_boundport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 82;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\n}\r\nstatic int dissect_auth(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\noffset += 134;\r\nif ( tree) {\r\nproto_tree_add_item( tree, hf_msproxy_ntlmssp_signature, tvb, offset, 7, ENC_NA|ENC_ASCII);\r\n}\r\noffset += 7;\r\nreturn offset;\r\n}\r\nstatic void dissect_tcp_bind(tvbuff_t *tvb, int offset,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\nconv_info->proto = PT_TCP;\r\nif ( tree) {\r\noffset += 6;\r\nproto_tree_add_item( tree, hf_msproxy_bind_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 16;\r\nproto_tree_add_item( tree, hf_msproxy_boundport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 96;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\n}\r\nstatic void dissect_request_connect(tvbuff_t *tvb, int offset,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\nconv_info->proto = PT_TCP;\r\noffset += 20;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_dstport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\nconv_info->dst_port = tvb_get_ntohs( tvb, offset);\r\noffset += 2;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_dstaddr, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\nconv_info->dst_addr = tvb_get_ipv4( tvb, offset);\r\noffset += 12;\r\nconv_info->clnt_port = tvb_get_ntohs( tvb, offset);\r\nif ( tree){\r\nproto_tree_add_uint( tree, hf_msproxy_clntport, tvb, offset, 2,\r\nconv_info->clnt_port);\r\noffset += 84;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\n}\r\nstatic void dissect_bind_info_ack(tvbuff_t *tvb, int offset, proto_tree *tree) {\r\nif ( tree){\r\noffset += 6;\r\nproto_tree_add_item( tree, hf_msproxy_bind_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 14;\r\nproto_tree_add_item( tree, hf_msproxy_dstport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_dstaddr, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 12;\r\nproto_tree_add_item( tree, hf_msproxy_server_int_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_addr, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 78;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\n}\r\nstatic void dissect_request_resolve(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\nproto_tree *name_tree;\r\nint length = tvb_get_guint8( tvb, offset);\r\nif ( tree){\r\nname_tree = proto_tree_add_subtree_format(tree, tvb, offset, length + 1,\r\nett_msproxy_name, NULL, "Host Name: %.*s", length,\r\ntvb_get_string_enc( wmem_packet_scope(), tvb, offset + 18, length, ENC_ASCII));\r\nproto_tree_add_item(name_tree, hf_msproxy_req_resolve_length, tvb, offset, 1, ENC_NA);\r\n++offset;\r\noffset += 17;\r\nproto_tree_add_item(name_tree, hf_msproxy_host_name, tvb, offset, length, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\nstatic void dissect_udp_bind(tvbuff_t *tvb, int offset,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\nconv_info->proto = PT_UDP;\r\noffset += 8;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_bind_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 12;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_dstport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\noffset += 2;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_dstaddr, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 96;\r\nif ( tree)\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\nstatic void dissect_udp_assoc(tvbuff_t *tvb, int offset,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\noffset += 28;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_clntport, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\nconv_info->clnt_port = tvb_get_ntohs( tvb, offset);\r\noffset += 90;\r\nif ( tree)\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\nstatic void dissect_msproxy_request(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\nint offset = 0;\r\nint cmd;\r\nproto_item* cmd_item;\r\nproto_tree_add_item( tree, hf_msproxy_client_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_server_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_server_ack, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_seq_num, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item( tree, hf_msproxy_rwsp_signature, tvb, offset, 4, ENC_NA|ENC_ASCII);\r\noffset += 12;\r\ncmd = tvb_get_ntohs( tvb, offset);\r\ncmd_item = proto_tree_add_uint_format_value( tree, hf_msproxy_cmd, tvb, offset, 2,\r\ncmd, "%s (0x%02x)",\r\nget_msproxy_cmd_name( cmd, FROM_CLIENT),\r\ncmd);\r\noffset += 2;\r\nswitch (cmd){\r\ncase MSPROXY_AUTH:\r\ndissect_auth( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_BIND:\r\ndissect_bind( tvb, offset, tree, conv_info);\r\nbreak;\r\ncase MSPROXY_UDP_BIND_REQ:\r\ndissect_udp_bind( tvb, offset, tree, conv_info);\r\nbreak;\r\ncase MSPROXY_AUTH_2:\r\ncase MSPROXY_TCP_BIND:\r\ndissect_tcp_bind( tvb, offset, tree, conv_info);\r\nbreak;\r\ncase MSPROXY_RESOLVE:\r\ndissect_request_resolve( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_CONNECT:\r\ncase MSPROXY_LISTEN:\r\ndissect_request_connect( tvb, offset, tree,\r\nconv_info);\r\nbreak;\r\ncase MSPROXY_BINDINFO_ACK:\r\ndissect_bind_info_ack( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_HELLO:\r\ncase MSPROXY_HELLO_2:\r\ndissect_msproxy_request_1( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_UDPASSOCIATE:\r\ndissect_udp_assoc( tvb, offset, tree, conv_info);\r\nbreak;\r\ndefault:\r\nexpert_add_info_format(pinfo, cmd_item, &ei_msproxy_unhandled,\r\n"Unhandled request command (report this, please)");\r\n}\r\n}\r\nstatic int dissect_hello_ack(tvbuff_t *tvb, int offset, proto_tree *tree) {\r\noffset += 60;\r\nproto_tree_add_item( tree, hf_msproxy_serverport, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_serveraddr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int dissect_user_info_ack(tvbuff_t *tvb _U_, int offset,\r\nproto_tree *tree _U_) {\r\noffset += 18;\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic void dissect_udpassociate_ack(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\noffset += 6;\r\nif ( tree) {\r\nproto_tree_add_item( tree, hf_msproxy_bind_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 14;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_addr, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 96;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\n}\r\nstatic void dissect_auth_1_ack(tvbuff_t *tvb, int offset,\r\nproto_tree *tree) {\r\noffset += 134;\r\nif ( tree) {\r\nproto_tree_add_item( tree, hf_msproxy_ntlmssp_signature, tvb, offset, 7, ENC_NA|ENC_ASCII);\r\noffset += 48;\r\nproto_tree_add_item(tree, hf_msproxy_nt_domain, tvb, offset, 255, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\nstatic int dissect_msproxy_response_4( tvbuff_t *tvb _U_, int offset,\r\nproto_tree *tree _U_) {\r\noffset += 134;\r\nreturn offset;\r\n}\r\nstatic void dissect_connect_ack( tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\noffset += 20;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_server_int_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\nconv_info->proto = PT_TCP;\r\nconv_info->server_int_port = tvb_get_ntohs( tvb, offset);\r\noffset += 2;\r\nif ( tree){\r\nproto_tree_add_item( tree, hf_msproxy_server_int_addr, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 14;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_addr, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 80;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\nadd_msproxy_conversation( pinfo, conv_info);\r\n}\r\nstatic void dissect_tcp_bind_ack( tvbuff_t *tvb, int offset, proto_tree *tree) {\r\nif ( tree) {\r\noffset += 6;\r\nproto_tree_add_item( tree, hf_msproxy_bind_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 16;\r\nproto_tree_add_item( tree, hf_msproxy_server_int_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 6;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_addr, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 88;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\n}\r\nstatic void dissect_bind_info( tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\noffset += 6;\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_bind_id, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 14;\r\nconv_info->dst_port = tvb_get_ntohs( tvb, offset);\r\nif ( tree)\r\nproto_tree_add_uint( tree, hf_msproxy_dstport, tvb, offset, 2,\r\nconv_info->dst_port);\r\noffset += 2;\r\nconv_info->dst_addr = tvb_get_ipv4( tvb, offset);\r\nif ( tree)\r\nproto_tree_add_item( tree, hf_msproxy_dstaddr, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\noffset += 12;\r\nconv_info->server_int_port = tvb_get_ntohs( tvb, offset);\r\nif ( tree)\r\nproto_tree_add_uint( tree, hf_msproxy_server_int_port, tvb,\r\noffset, 2, conv_info->server_int_port);\r\noffset += 4;\r\nif ( tree) {\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_port, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item( tree, hf_msproxy_server_ext_addr, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 78;\r\ndisplay_application_name( tvb, offset, tree);\r\n}\r\nadd_msproxy_conversation( pinfo, conv_info);\r\n}\r\nstatic void dissect_resolve(tvbuff_t *tvb, int offset, proto_tree *tree) {\r\nif ( tree) {\r\nint addr_offset;\r\naddr_offset = tvb_get_guint8( tvb, offset);\r\nproto_tree_add_item(tree, hf_msproxy_address_offset, tvb, offset, 1, ENC_NA);\r\n++offset;\r\noffset += 13;\r\noffset += addr_offset;\r\nproto_tree_add_item( tree, hf_msproxy_resolvaddr, tvb, offset, 4,\r\nENC_BIG_ENDIAN);\r\n}\r\n}\r\nstatic void dissect_msproxy_response(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, hash_entry_t *conv_info) {\r\nint offset = 0;\r\nint cmd;\r\nproto_item* ti;\r\nif ( tree) {\r\nproto_tree_add_item( tree, hf_msproxy_client_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_server_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_client_ack, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item( tree, hf_msproxy_seq_num, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item( tree, hf_msproxy_rwsp_signature, tvb, offset, 4, ENC_NA|ENC_ASCII);\r\noffset += 12;\r\n}\r\nelse\r\noffset += 36;\r\ncmd = tvb_get_ntohs( tvb, offset);\r\nti = proto_tree_add_uint_format_value( tree, hf_msproxy_cmd, tvb, offset, 2,\r\ncmd, "0x%02x (%s)", cmd,\r\nget_msproxy_cmd_name( cmd, FROM_SERVER));\r\noffset += 2;\r\nswitch (cmd) {\r\ncase MSPROXY_HELLO_ACK:\r\ndissect_hello_ack( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_USERINFO_ACK:\r\ndissect_user_info_ack( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_AUTH_1_ACK:\r\ndissect_auth_1_ack( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_UDPASSOCIATE_ACK:\r\ndissect_udpassociate_ack( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_AUTH_2_ACK:\r\ncase MSPROXY_AUTH_2_ACK2:\r\ndissect_msproxy_response_4( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_TCP_BIND_ACK:\r\ndissect_tcp_bind_ack( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_CONNECT_ACK:\r\ndissect_connect_ack( tvb, offset, pinfo, tree,\r\nconv_info);\r\nbreak;\r\ncase MSPROXY_BINDINFO:\r\ndissect_bind_info( tvb, offset, pinfo, tree, conv_info);\r\nbreak;\r\ncase MSPROXY_RESOLVE_ACK:\r\ndissect_resolve( tvb, offset, tree);\r\nbreak;\r\ncase MSPROXY_CONNECT_AUTHFAILED:\r\ncase MSPROXY_BIND_AUTHFAILED:\r\nexpert_add_info(pinfo, ti, &ei_msproxy_unknown);\r\nbreak;\r\ndefault:\r\nif ((((cmd >> 8) == MSPROXY_CONNREFUSED) ||\r\n((cmd >> 12) == MSPROXY_CONNREFUSED)))\r\nexpert_add_info(pinfo, ti, &ei_msproxy_unknown);\r\nelse\r\nexpert_add_info(pinfo, ti, &ei_msproxy_unhandled);\r\n}\r\n}\r\nstatic int dissect_msproxy(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\nproto_tree *msproxy_tree;\r\nproto_item *ti;\r\nunsigned int cmd;\r\nhash_entry_t *hash_info;\r\nconversation_t *conversation;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MSproxy");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nconversation = find_or_create_conversation(pinfo);\r\nhash_info = (hash_entry_t *)conversation_get_proto_data(conversation, proto_msproxy);\r\nif ( !hash_info) {\r\nhash_info = wmem_new(wmem_file_scope(), hash_entry_t);\r\nconversation_add_proto_data(conversation, proto_msproxy,\r\nhash_info);\r\n}\r\ncmd = tvb_get_ntohs( tvb, 36);\r\nif ( pinfo->srcport == UDP_PORT_MSPROXY)\r\ncol_add_fstr( pinfo->cinfo, COL_INFO, "Server message: %s",\r\nget_msproxy_cmd_name( cmd, FROM_SERVER));\r\nelse\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Client message: %s",\r\nget_msproxy_cmd_name( cmd, FROM_CLIENT));\r\nti = proto_tree_add_item( tree, proto_msproxy, tvb, 0, -1, ENC_NA );\r\nmsproxy_tree = proto_item_add_subtree(ti, ett_msproxy);\r\nif ( pinfo->srcport == UDP_PORT_MSPROXY)\r\ndissect_msproxy_response( tvb, pinfo, msproxy_tree, hash_info);\r\nelse\r\ndissect_msproxy_request( tvb, pinfo, msproxy_tree, hash_info);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_msproxy( void){\r\nstatic gint *ett[] = {\r\n&ett_msproxy,\r\n&ett_msproxy_name\r\n};\r\nstatic hf_register_info hf[] = {\r\n{ &hf_msproxy_cmd,\r\n{ "Command", "msproxy.command", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_dstaddr,\r\n{ "Destination Address", "msproxy.dstaddr", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{ &hf_msproxy_srcport,\r\n{ "Source Port", "msproxy.srcport", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n#endif\r\n{ &hf_msproxy_dstport,\r\n{ "Destination Port", "msproxy.dstport", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_clntport,\r\n{ "Client Port", "msproxy.clntport", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_server_ext_addr,\r\n{ "Server External Address", "msproxy.server_ext_addr", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_server_ext_port,\r\n{ "Server External Port", "msproxy.server_ext_port", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_server_int_addr,\r\n{ "Server Internal Address", "msproxy.server_int_addr", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_server_int_port,\r\n{ "Server Internal Port", "msproxy.server_int_port", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_serverport,\r\n{ "Server Port", "msproxy.serverport", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_bindport,\r\n{ "Bind Port", "msproxy.bindport", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_boundport,\r\n{ "Bound Port", "msproxy.boundport", FT_UINT16,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_serveraddr,\r\n{ "Server Address", "msproxy.serveraddr", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_bindaddr,\r\n{ "Destination", "msproxy.bindaddr", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_bind_id,\r\n{ "Bound Port Id", "msproxy.bindid", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_resolvaddr,\r\n{ "Address", "msproxy.resolvaddr", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_client_id,\r\n{ "Client Id", "msproxy.client_id", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_version,\r\n{ "Version", "msproxy.version", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_server_id,\r\n{ "Server id", "msproxy.server_id", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_server_ack,\r\n{ "Server ack", "msproxy.server_ack", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_client_ack,\r\n{ "Client ack", "msproxy.client_ack", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_seq_num,\r\n{ "Sequence Number", "msproxy.seq_num", FT_UINT8,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_rwsp_signature,\r\n{ "RWSP signature", "msproxy.rwsp_signature", FT_STRING, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_ntlmssp_signature,\r\n{ "NTLMSSP signature", "msproxy.ntlmssp_signature", FT_STRING, BASE_NONE, NULL,\r\n0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_msproxy_application, { "Application", "msproxy.application", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_user_name, { "User name", "msproxy.user_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_application_name, { "Application name", "msproxy.application_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_client_computer_name, { "Client computer name", "msproxy.client_computer_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_req_resolve_length, { "Length", "msproxy.req_resolve.length", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_host_name, { "Host Name", "msproxy.host_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_nt_domain, { "NT domain", "msproxy.nt_domain", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_msproxy_address_offset, { "Address offset", "msproxy.address_offset", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_msproxy_unknown,\r\n{ "msproxy.unknown", PI_UNDECODED, PI_WARN, "No know information (help wanted)", EXPFILL }},\r\n{ &ei_msproxy_unhandled,\r\n{ "msproxy.command.unhandled", PI_UNDECODED, PI_WARN, "Unhandled response command (report this, please)", EXPFILL }},\r\n};\r\nexpert_module_t* expert_msproxy;\r\nproto_msproxy = proto_register_protocol( "MS Proxy Protocol", "MS Proxy", "msproxy");\r\nproto_register_field_array(proto_msproxy, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_msproxy = expert_register_protocol(proto_msproxy);\r\nexpert_register_field_array(expert_msproxy, ei, array_length(ei));\r\nmsproxy_sub_handle = create_dissector_handle(msproxy_sub_dissector,\r\nproto_msproxy);\r\n}\r\nvoid\r\nproto_reg_handoff_msproxy(void) {\r\ndissector_handle_t msproxy_handle;\r\nmsproxy_handle = create_dissector_handle(dissect_msproxy,\r\nproto_msproxy);\r\ndissector_add_uint("udp.port", UDP_PORT_MSPROXY, msproxy_handle);\r\n}

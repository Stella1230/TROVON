static void dissect_tpncp_data(gint data_id, tvbuff_t *tvb, proto_tree *ltree,\r\ngint *offset, tpncp_data_field_info *data_fields_info) {\r\nproto_item *pi = NULL;\r\ngint32 g_int;\r\ngint16 g_short;\r\nguint16 g_ushort;\r\ngint8 g_char;\r\nguint8 g_uchar;\r\ngint g_str_len, counter, bitshift, bitmask;\r\ntpncp_data_field_info *current_tpncp_data_field_info = NULL;\r\ncurrent_tpncp_data_field_info = &data_fields_info[data_id];\r\nwhile (current_tpncp_data_field_info) {\r\nswitch(current_tpncp_data_field_info->tpncp_data_field_size) {\r\ncase 1: case 2: case 3: case 4:\r\ncase 5: case 6: case 7: case 8:\r\nif ((g_str_len = current_tpncp_data_field_info->tpncp_data_field_array_dim)) {\r\ng_str_len = MIN(g_str_len, tvb_reported_length_remaining(tvb, *offset));\r\nproto_tree_add_item(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, g_str_len, ENC_NA|ENC_ASCII);\r\n(*offset) += g_str_len;\r\n}\r\nelse {\r\ng_uchar = tvb_get_guint8(tvb, *offset);\r\nif (current_tpncp_data_field_info->tpncp_data_field_size != 8) {\r\nfor (counter = 0, bitmask = 0x0, bitshift = bitindex;\r\ncounter < current_tpncp_data_field_info->tpncp_data_field_size;\r\ncounter++)\r\nbitmask |= bits[bitindex++];\r\ng_uchar &= bitmask;\r\ng_uchar >>= bitshift;\r\n}\r\nif (current_tpncp_data_field_info->tpncp_data_field_sign || current_tpncp_data_field_info->tpncp_data_field_size != 8) {\r\nproto_tree_add_uint(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, 1, g_uchar);\r\n}\r\nelse {\r\ng_char = (gint8)g_uchar;\r\nproto_tree_add_int(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, 1, g_char);\r\n}\r\nif ((bitindex == 0) || (bitindex == 8)) {\r\n(*offset)++;\r\nbitindex = 0;\r\n}\r\n}\r\nbreak;\r\ncase 16:\r\nif (current_tpncp_data_field_info->tpncp_data_field_sign) {\r\ng_ushort = tvb_get_ntohs(tvb, *offset);\r\nproto_tree_add_uint(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, 2, g_ushort);\r\n}\r\nelse {\r\ng_short = tvb_get_ntohs(tvb, *offset);\r\nproto_tree_add_int(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, 2, g_short);\r\n}\r\n(*offset) += 2;\r\nbreak;\r\ncase 32:\r\ng_int = tvb_get_ntohl(tvb, *offset);\r\nif (current_tpncp_data_field_info->tpncp_data_field_sign) {\r\npi = proto_tree_add_uint(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, 4, g_int);\r\n}\r\nelse {\r\npi = proto_tree_add_int(ltree, current_tpncp_data_field_info->tpncp_data_field_descr,\r\ntvb, *offset, 4, g_int);\r\n}\r\nif (current_tpncp_data_field_info->tpncp_data_field_is_ip_addr) {\r\nproto_item_append_text(pi, " (%s)", tvb_ip_to_str(tvb, *offset));\r\n}\r\n(*offset) += 4;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ncurrent_tpncp_data_field_info = current_tpncp_data_field_info->p_next;\r\nif (tvb_reported_length_remaining(tvb, *offset) <= 0) {\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void dissect_tpncp_event(gint event_id, tvbuff_t *tvb,\r\nproto_tree *tree, gint *offset) {\r\nswitch (event_id) {\r\ndefault:\r\ndissect_tpncp_data(event_id, tvb, tree, offset, tpncp_events_info_db);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_tpncp_command(gint command_id, tvbuff_t *tvb,\r\nproto_tree *tree, gint *offset) {\r\nswitch (command_id) {\r\ndefault:\r\ndissect_tpncp_data(command_id, tvb, tree, offset, tpncp_commands_info_db);\r\nbreak;\r\n}\r\n}\r\nstatic int dissect_tpncp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\nproto_item *item = NULL;\r\nproto_tree *tpncp_tree = NULL, *event_tree, *command_tree;\r\ngint offset = 0;\r\nguint32 id, cid = 0;\r\nguint16 seq_number, len, ver, reserved;\r\nver = tvb_get_ntohs(tvb, 0);\r\nlen = tvb_get_ntohs(tvb, 2);\r\nseq_number = tvb_get_ntohs(tvb, 4);\r\nreserved = tvb_get_ntohs(tvb, 6);\r\nid = tvb_get_ntohl(tvb, 8);\r\nif (pinfo->srcport == UDP_PORT_TPNCP_TRUNKPACK)\r\ncid = tvb_get_ntohl(tvb, 12 );\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "TPNCP");\r\nif (pinfo->srcport == UDP_PORT_TPNCP_TRUNKPACK) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"EvID=%s(%d), SeqNo=%d, ChID=%d, Len=%d, Ver=%d",\r\nval_to_str_const(id, tpncp_events_id_vals, "Unknown"),\r\nid, seq_number, cid, len, ver);\r\n} else {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"CmdID=%s(%d), SeqNo=%d, Len=%d, Ver=%d",\r\nval_to_str_const(id, tpncp_commands_id_vals, "Unknown"),\r\nid, seq_number, len, ver);\r\n}\r\nif (tree) {\r\nitem = proto_tree_add_item(tree, proto_tpncp, tvb, 0, -1, ENC_NA);\r\ntpncp_tree = proto_item_add_subtree(item, ett_tpncp);\r\nproto_tree_add_uint(tpncp_tree, hf_tpncp_version, tvb, 0, 2, ver);\r\nproto_tree_add_uint(tpncp_tree, hf_tpncp_length, tvb, 2, 2, len);\r\nproto_tree_add_uint(tpncp_tree, hf_tpncp_seq_number, tvb, 4, 2, seq_number);\r\nproto_tree_add_uint(tpncp_tree, hf_tpncp_reserved, tvb, 6, 2, reserved);\r\nif (pinfo->srcport == UDP_PORT_TPNCP_TRUNKPACK) {\r\nif (try_val_to_str(id, tpncp_events_id_vals)) {\r\nproto_tree_add_uint(tpncp_tree, hf_tpncp_event_id, tvb, 8, 4, id);\r\nproto_tree_add_int(tpncp_tree, hf_tpncp_cid, tvb, 12, 4, cid);\r\noffset += 16;\r\nif (tpncp_events_info_db[id].tpncp_data_field_size) {\r\nevent_tree = proto_tree_add_subtree_format(tree, tvb, offset, -1, ett_tpncp_body, NULL, "TPNCP Event: %s (%d)",\r\nval_to_str_const(id, tpncp_events_id_vals, "Unknown"), id);\r\ndissect_tpncp_event(id, tvb, event_tree, &offset);\r\n}\r\n}\r\n}\r\nelse {\r\nif (try_val_to_str(id, tpncp_commands_id_vals)) {\r\nproto_tree_add_uint(tpncp_tree, hf_tpncp_command_id, tvb, 8, 4, id);\r\noffset += 12;\r\nif (tpncp_commands_info_db[id].tpncp_data_field_size) {\r\ncommand_tree = proto_tree_add_subtree_format(tree, tvb, offset, -1, ett_tpncp_body, NULL, "TPNCP Command: %s (%d)",\r\nval_to_str_const(id, tpncp_commands_id_vals, "Unknown"), id);\r\ndissect_tpncp_command(id, tvb, command_tree, &offset);\r\n}\r\n}\r\n}\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic guint get_tpncp_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint16 plen;\r\nplen = tvb_get_ntohs(tvb, offset + 2);\r\nplen += 4;\r\nreturn plen;\r\n}\r\nstatic int dissect_tpncp_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data) {\r\nif (pinfo->can_desegment)\r\ntcp_dissect_pdus(tvb, pinfo, tree, tpncp_desegment, 4, get_tpncp_pdu_len, dissect_tpncp, data);\r\nelse\r\ndissect_tpncp(tvb, pinfo, tree, data);\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic gint fill_tpncp_id_vals(value_string string[], FILE *file) {\r\ngint i = 0, tpncp_id = 0;\r\ngchar *tpncp_name, *line_in_file;\r\nline_in_file = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\nline_in_file[0] = 0;\r\ntpncp_name = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\ntpncp_name[0] = 0;\r\nwhile (fgets(line_in_file, MAX_TPNCP_DB_ENTRY_LEN, file) != NULL) {\r\nif (!strncmp(line_in_file, "#####", 5)) {\r\nbreak;\r\n}\r\nif (sscanf(line_in_file, "%255s %d", tpncp_name, &tpncp_id) == 2) {\r\nstring[i].strptr = g_strdup(tpncp_name);\r\nstring[i].value = tpncp_id;\r\nif (i < (MAX_TPNCP_DB_SIZE-1)) {\r\ni++;\r\n}\r\nelse {\r\nbreak;\r\n}\r\n}\r\n}\r\ng_free(line_in_file);\r\ng_free(tpncp_name);\r\nreturn 0;\r\n}\r\nstatic gint fill_enums_id_vals(FILE *file) {\r\ngint i = 0, enum_id = 0, enum_val = 0;\r\ngboolean first_entry = TRUE;\r\ngchar *line_in_file = NULL, *enum_name = NULL,\r\n*enum_type = NULL, *enum_str = NULL;\r\nline_in_file = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\nline_in_file[0] = 0;\r\nenum_name = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\nenum_name[0] = 0;\r\nenum_type = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\nenum_type[0] = 0;\r\nenum_str = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\nenum_str[0] = 0;\r\nwhile (fgets(line_in_file, MAX_TPNCP_DB_ENTRY_LEN, file) != NULL) {\r\nif (!strncmp(line_in_file, "#####", 5)) {\r\nbreak;\r\n}\r\nif (sscanf(line_in_file, "%255s %255s %d", enum_name, enum_str, &enum_id) == 3) {\r\nif (strcmp(enum_type, enum_name)) {\r\nif (!first_entry) {\r\ntpncp_enums_id_vals[enum_val][i].strptr = NULL;\r\ntpncp_enums_id_vals[enum_val][i].value = 0;\r\nif (enum_val < (MAX_ENUMS_NUM-1)) {\r\nenum_val++; i = 0;\r\n}\r\nelse {\r\nbreak;\r\n}\r\n}\r\nelse\r\nfirst_entry = FALSE;\r\ntpncp_enums_name_vals[enum_val] = g_strdup(enum_name);\r\ng_strlcpy(enum_type, enum_name, MAX_TPNCP_DB_ENTRY_LEN);\r\n}\r\ntpncp_enums_id_vals[enum_val][i].strptr = g_strdup(enum_str);\r\ntpncp_enums_id_vals[enum_val][i].value = enum_id;\r\nif (i < (MAX_ENUM_ENTRIES-1)) {\r\ni++;\r\n}\r\nelse {\r\nbreak;\r\n}\r\n}\r\n}\r\nif (enum_val + 1 >= MAX_ENUMS_NUM) {\r\ng_free(tpncp_enums_name_vals[enum_val]);\r\ntpncp_enums_name_vals[enum_val] = NULL;\r\n}\r\nelse {\r\ntpncp_enums_name_vals[enum_val+1] = NULL;\r\n}\r\ng_free(line_in_file);\r\ng_free(enum_name);\r\ng_free(enum_type);\r\ng_free(enum_str);\r\nreturn 0;\r\n}\r\nstatic gint get_enum_name_val(gchar *enum_name) {\r\ngint enum_val = 0;\r\nwhile (tpncp_enums_name_vals[enum_val]) {\r\nif (!strcmp(enum_name, tpncp_enums_name_vals[enum_val]))\r\nreturn enum_val;\r\nenum_val++;\r\n}\r\nreturn -1;\r\n}\r\nstatic gint init_tpncp_data_fields_info(tpncp_data_field_info *data_fields_info, FILE *file) {\r\nstatic gboolean was_registered = FALSE;\r\ngchar *tpncp_db_entry = NULL, *tpncp_data_field_name = NULL, *tmp = NULL;\r\ngint enum_val, data_id, current_data_id = -1,\r\ntpncp_data_field_sign, tpncp_data_field_size,\r\ntpncp_data_field_array_dim, tpncp_data_field_is_ip_addr;\r\nguint idx;\r\ntpncp_data_field_info *current_tpncp_data_field_info = NULL;\r\nhf_register_info hf_entr;\r\nstatic hf_register_info hf_tpncp[] = {\r\n{\r\n&hf_tpncp_version,\r\n{\r\n"Version",\r\n"tpncp.version",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_tpncp_length,\r\n{\r\n"Length",\r\n"tpncp.length",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_tpncp_seq_number,\r\n{\r\n"Sequence number",\r\n"tpncp.seq_number",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{\r\n&hf_tpncp_old_event_seq_number,\r\n{\r\n"Sequence number",\r\n"tpncp.old_event_seq_number",\r\nFT_UINT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#endif\r\n{\r\n&hf_tpncp_reserved,\r\n{\r\n"Reserved",\r\n"tpncp.reserved",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_tpncp_command_id,\r\n{\r\n"Command ID",\r\n"tpncp.command_id",\r\nFT_UINT32,\r\nBASE_DEC,\r\nVALS(tpncp_commands_id_vals),\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{\r\n&hf_tpncp_old_command_id,\r\n{\r\n"Command ID",\r\n"tpncp.old_command_id",\r\nFT_UINT16,\r\nBASE_DEC,\r\nVALS(tpncp_commands_id_vals),\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#endif\r\n{\r\n&hf_tpncp_event_id,\r\n{\r\n"Event ID",\r\n"tpncp.event_id",\r\nFT_UINT32,\r\nBASE_DEC,\r\nVALS(tpncp_events_id_vals),\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_tpncp_cid,\r\n{\r\n"Channel ID",\r\n"tpncp.channel_id",\r\nFT_INT32,\r\nBASE_DEC,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n}\r\n};\r\nhf_entr.hfinfo.type = FT_NONE;\r\nhf_entr.hfinfo.strings = NULL;\r\nhf_entr.hfinfo.bitmask = 0x0;\r\nhf_entr.hfinfo.blurb = NULL;\r\nHFILL_INIT(hf_entr);\r\nif (!was_registered) {\r\nhf_allocated = hf_size+(int)array_length(hf_tpncp)-1;\r\nif ((hf = (hf_register_info *)g_realloc(hf, hf_allocated * sizeof(hf_register_info))) == NULL) {\r\nreturn (-1);\r\n}\r\nfor (idx = 0; idx < array_length(hf_tpncp); idx++) {\r\nmemcpy(hf + (hf_size - 1), hf_tpncp + idx, sizeof(hf_register_info));\r\nhf_size++;\r\n}\r\nwas_registered = TRUE;\r\n}\r\nelse\r\nhf_size++;\r\ntpncp_db_entry = (gchar *)g_malloc(MAX_TPNCP_DB_ENTRY_LEN);\r\ntpncp_db_entry[0] = 0;\r\nwhile (fgets(tpncp_db_entry, MAX_TPNCP_DB_ENTRY_LEN, file) != NULL) {\r\nif (!strncmp(tpncp_db_entry, "#####", 5)) {\r\nhf_size--;\r\nbreak;\r\n}\r\nhf_entr.hfinfo.display = BASE_DEC;\r\nif ((tmp = strtok(tpncp_db_entry, " ")) == NULL)\r\ncontinue;\r\ndata_id = atoi(tmp);\r\nif ((tpncp_data_field_name = strtok(NULL, " ")) == NULL)\r\ncontinue;\r\nif ((tmp = strtok(NULL, " ")) == NULL)\r\ncontinue;\r\ntpncp_data_field_sign = atoi(tmp);\r\nif ((tmp = strtok(NULL, " ")) == NULL)\r\ncontinue;\r\ntpncp_data_field_size = atoi(tmp);\r\nif ((tmp = strtok(NULL, " ")) == NULL)\r\ncontinue;\r\ntpncp_data_field_array_dim = atoi(tmp);\r\nif ((tmp = strtok(NULL, " ")) == NULL)\r\ncontinue;\r\ntpncp_data_field_is_ip_addr = atoi(tmp);\r\nif ((tmp = strtok(NULL, "\n")) == NULL)\r\ncontinue;\r\nif (current_data_id != data_id) {\r\ncurrent_tpncp_data_field_info = &data_fields_info[data_id];\r\ncurrent_data_id = data_id;\r\n}\r\nelse {\r\nif ((current_tpncp_data_field_info->p_next =\r\n(tpncp_data_field_info *)g_malloc0(sizeof(tpncp_data_field_info)))\r\n== NULL) {\r\ng_free(tpncp_db_entry);\r\nreturn (-1);\r\n}\r\ncurrent_tpncp_data_field_info = current_tpncp_data_field_info->p_next;\r\n}\r\nif (strcmp(tmp, "primitive")) {\r\nenum_val = get_enum_name_val(tmp);\r\nif (enum_val == -1) {\r\nhf_entr.hfinfo.strings = NULL;\r\n}\r\nelse {\r\nhf_entr.hfinfo.strings = VALS(tpncp_enums_id_vals[enum_val]);\r\n}\r\n}\r\nelse {\r\nhf_entr.hfinfo.strings = NULL;\r\n}\r\ncurrent_tpncp_data_field_info->tpncp_data_field_descr = -1;\r\nhf_entr.p_id = &current_tpncp_data_field_info->tpncp_data_field_descr;\r\ncurrent_tpncp_data_field_info->tpncp_data_field_name = g_strdup_printf("tpncp.%s", tpncp_data_field_name);\r\nhf_entr.hfinfo.name = current_tpncp_data_field_info->tpncp_data_field_name;\r\nhf_entr.hfinfo.abbrev = current_tpncp_data_field_info->tpncp_data_field_name;\r\nswitch (tpncp_data_field_size) {\r\ncase 1: case 2: case 3: case 4:\r\ncase 5: case 6: case 7: case 8:\r\nif (tpncp_data_field_array_dim) {\r\nhf_entr.hfinfo.type = FT_STRING;\r\nhf_entr.hfinfo.display = BASE_NONE;\r\n}\r\nelse\r\nhf_entr.hfinfo.type = (tpncp_data_field_sign)?FT_UINT8:FT_INT8;\r\nbreak;\r\ncase 16:\r\nhf_entr.hfinfo.type = (tpncp_data_field_sign)?FT_UINT16:FT_INT16;\r\nbreak;\r\ncase 32:\r\nhf_entr.hfinfo.type = (tpncp_data_field_sign)?FT_UINT32:FT_INT32;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (hf_size > hf_allocated) {\r\nhf_allocated += 1024;\r\nif ((hf = (hf_register_info *)g_realloc(hf, hf_allocated * sizeof(hf_register_info))) == NULL) {\r\ng_free(tpncp_db_entry);\r\nreturn (-1);\r\n}\r\n}\r\nmemcpy(hf + hf_size - 1, &hf_entr, sizeof(hf_register_info));\r\nhf_size++;\r\ncurrent_tpncp_data_field_info->tpncp_data_field_sign = tpncp_data_field_sign;\r\ncurrent_tpncp_data_field_info->tpncp_data_field_size = tpncp_data_field_size;\r\ncurrent_tpncp_data_field_info->tpncp_data_field_array_dim = tpncp_data_field_array_dim;\r\ncurrent_tpncp_data_field_info->tpncp_data_field_is_ip_addr = tpncp_data_field_is_ip_addr;\r\n}\r\ng_free(tpncp_db_entry);\r\nreturn 0;\r\n}\r\nstatic gint init_tpncp_db(void) {\r\ngchar *tpncp_dat_file_path;\r\ngint ret;\r\nFILE *file;\r\ntpncp_dat_file_path = g_strdup_printf("%s" G_DIR_SEPARATOR_S"tpncp" G_DIR_SEPARATOR_S "tpncp.dat", get_datafile_dir());\r\nif ((file = ws_fopen(tpncp_dat_file_path, "r")) == NULL) {\r\ng_free(tpncp_dat_file_path);\r\nreturn (-1);\r\n}\r\ng_free(tpncp_dat_file_path);\r\nret = fill_tpncp_id_vals(tpncp_events_id_vals, file);\r\nif (ret != 0)\r\ngoto done;\r\nret = fill_tpncp_id_vals(tpncp_commands_id_vals, file);\r\nif (ret != 0)\r\ngoto done;\r\nret = fill_enums_id_vals(file);\r\nif (ret != 0)\r\ngoto done;\r\nret = init_tpncp_data_fields_info(tpncp_events_info_db, file);\r\nif (ret != 0)\r\ngoto done;\r\nret = init_tpncp_data_fields_info(tpncp_commands_info_db, file);\r\ndone:\r\nfclose(file);\r\nreturn ret;\r\n}\r\nvoid proto_reg_handoff_tpncp(void) {\r\nstatic gint tpncp_prefs_initialized = FALSE;\r\nstatic dissector_handle_t tpncp_tcp_handle;\r\nif (proto_tpncp == -1)\r\nreturn;\r\nif (!tpncp_prefs_initialized) {\r\ntpncp_tcp_handle = create_dissector_handle(dissect_tpncp_tcp, proto_tpncp);\r\ntpncp_prefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("tcp.port", trunkpack_tcp_port, tpncp_tcp_handle);\r\ndissector_delete_uint("udp.port", trunkpack_udp_port, tpncp_handle);\r\ndissector_delete_uint("tcp.port", host_tcp_port, tpncp_tcp_handle);\r\ndissector_delete_uint("udp.port", host_udp_port, tpncp_handle);\r\n}\r\nif(global_tpncp_load_db){\r\ntrunkpack_tcp_port = global_tpncp_trunkpack_tcp_port;\r\ntrunkpack_udp_port = global_tpncp_trunkpack_udp_port;\r\nhost_tcp_port = global_tpncp_host_tcp_port;\r\nhost_udp_port = global_tpncp_host_udp_port;\r\ndissector_add_uint("tcp.port", global_tpncp_trunkpack_tcp_port, tpncp_tcp_handle);\r\ndissector_add_uint("udp.port", global_tpncp_trunkpack_udp_port, tpncp_handle);\r\n}\r\n}\r\nvoid proto_register_tpncp(void) {\r\ngint idx;\r\nmodule_t *tpncp_module;\r\nstatic gint *ett[] = {\r\n&ett_tpncp,\r\n&ett_tpncp_body\r\n};\r\nproto_tpncp = proto_register_protocol("AudioCodes TPNCP (TrunkPack Network Control Protocol)",\r\n"TPNCP", "tpncp");\r\nif(global_tpncp_load_db){\r\nif (init_tpncp_db() == -1) {\r\nreport_failure("tpncp: Could not load tpncp.dat file, tpncp dissector will not work");\r\nreturn;\r\n}\r\nTRY {\r\nfor(idx = 0; idx < hf_size; idx++) {\r\nproto_register_field_array(proto_tpncp, &hf[idx], 1);\r\n}\r\n}\r\nCATCH_ALL {\r\nreport_failure("Corrupt tpncp.dat file, tpncp dissector will not work.");\r\n}\r\nENDTRY;\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\ntpncp_handle = register_dissector("tpncp", dissect_tpncp, proto_tpncp);\r\ntpncp_module = prefs_register_protocol(proto_tpncp, proto_reg_handoff_tpncp);\r\nprefs_register_bool_preference(tpncp_module, "load_db",\r\n"Whether to load DB or not; if DB not loaded dissector is passive",\r\n"Whether to load the Database or not; not loading the DB"\r\n" disables the protocol; Wireshark has to be restarted for the"\r\n" setting to take effect.",\r\n&global_tpncp_load_db);\r\nprefs_register_uint_preference(tpncp_module, "tcp.trunkpack_port",\r\n"TPNCP \"well-known\" TrunkPack TCP Port",\r\n"", 10, &global_tpncp_trunkpack_tcp_port);\r\nprefs_register_uint_preference(tpncp_module, "udp.trunkpack_port",\r\n"TPNCP \"well-known\" TrunkPack UDP Port",\r\n"", 10, &global_tpncp_trunkpack_udp_port);\r\n}

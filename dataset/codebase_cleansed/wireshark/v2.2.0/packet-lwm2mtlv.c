static void\r\naddTlvHeaderElements(tvbuff_t *tvb, proto_tree *tlv_tree, lwm2mElement_t *element)\r\n{\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_type_type, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_type_length_of_identifier, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_type_length_of_length, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nif ( element->length_of_length == 0 ) {\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_type_length, tvb, 0, 1, ENC_BIG_ENDIAN);\r\n} else {\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_type_ignored, tvb, 0, 1, ENC_BIG_ENDIAN);\r\n}\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_identifier, tvb, 1, element->length_of_identifier, ENC_BIG_ENDIAN);\r\nif ( element->length_of_length > 0 ) {\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_length, tvb, 1+element->length_of_identifier, element->length_of_length, ENC_BIG_ENDIAN);\r\n}\r\n}\r\nstatic void\r\naddTlvHeaderTree(tvbuff_t *tvb, proto_tree *tlv_tree, lwm2mElement_t *element)\r\n{\r\nproto_item *item = NULL;\r\nproto_tree *header_tree = NULL;\r\nguint valueOffset = 1 + element->length_of_identifier + element->length_of_length;\r\nitem = proto_tree_add_item(tlv_tree, hf_lwm2mtlv_header, tvb, 0, valueOffset, ENC_NA);\r\nheader_tree = proto_item_add_subtree(item, ett_lwm2mtlv_header);\r\naddTlvHeaderElements(tvb, header_tree, element);\r\n}\r\nstatic proto_tree*\r\naddElementTree(tvbuff_t *tvb, proto_tree *tlv_tree, lwm2mElement_t *element)\r\n{\r\nguint valueOffset = 1 + element->length_of_identifier + element->length_of_length;\r\nguint8 *str;\r\nswitch ( element->type )\r\n{\r\ncase OBJECT_INSTANCE:\r\nreturn proto_tree_add_subtree_format(tlv_tree, tvb, 0, element->totalLength, ett_lwm2mtlv_objectInstance, NULL,\r\n"Object Instance %02u (%u Bytes)", element->identifier, element->length_of_value);\r\ncase RESOURCE_INSTANCE:\r\nstr = tvb_get_string_enc(wmem_packet_scope(), tvb, valueOffset, element->length_of_value, ENC_ASCII);\r\nreturn proto_tree_add_subtree_format(tlv_tree, tvb, 0, element->totalLength, ett_lwm2mtlv_resourceInstance, NULL,\r\n"%02u: %s", element->identifier, str);\r\ncase RESOURCE_ARRAY:\r\nreturn proto_tree_add_subtree_format(tlv_tree, tvb, 0, element->totalLength, ett_lwm2mtlv_resourceArray, NULL,\r\n"%02u: (Array of %u Bytes)", element->identifier, element->length_of_value);\r\ncase RESOURCE:\r\nstr = tvb_get_string_enc(wmem_packet_scope(), tvb, valueOffset, element->length_of_value, ENC_ASCII);\r\nreturn proto_tree_add_subtree_format(tlv_tree, tvb, 0, element->totalLength, ett_lwm2mtlv_resource, NULL,\r\n"%02u: %s", element->identifier, str);\r\n}\r\nreturn NULL;\r\n}\r\nstatic void\r\naddValueInterpretations(tvbuff_t *tvb, proto_tree *tlv_tree, lwm2mElement_t *element)\r\n{\r\nguint valueOffset;\r\nif ( element->length_of_value == 0 ) return;\r\nvalueOffset = 1 + element->length_of_identifier + element->length_of_length;\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_string, tvb, valueOffset, element->length_of_value, ENC_ASCII|ENC_NA);\r\nswitch(element->length_of_value)\r\n{\r\ncase 0x01:\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_integer, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_boolean, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 0x02:\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_integer, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 0x04:\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_integer, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_float, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_timestamp, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 0x08:\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_integer, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_double, tvb, valueOffset, element->length_of_value, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value_timestamp, tvb, valueOffset+4, element->length_of_value-4, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\naddValueTree(tvbuff_t *tvb, proto_tree *tlv_tree, lwm2mElement_t *element)\r\n{\r\nguint valueOffset = 1 + element->length_of_identifier + element->length_of_length;\r\nif ( element->type == RESOURCE || element->type == RESOURCE_INSTANCE ) {\r\nproto_tree_add_item(tlv_tree, hf_lwm2mtlv_value, tvb, valueOffset, element->length_of_value, ENC_NA);\r\naddValueInterpretations(tvb, tlv_tree, element);\r\n} else {\r\ntvbuff_t* sub = tvb_new_subset_length(tvb, valueOffset, element->length_of_value);\r\nparseArrayOfElements(sub, tlv_tree);\r\n}\r\n}\r\nstatic void\r\naddTlvElement(tvbuff_t *tvb, proto_tree *tlv_tree, lwm2mElement_t *element)\r\n{\r\nproto_tree *element_tree = NULL;\r\nelement_tree = addElementTree(tvb, tlv_tree, element);\r\naddTlvHeaderTree(tvb, element_tree, element);\r\naddValueTree(tvb, element_tree, element);\r\n}\r\nstatic guint64\r\ndecodeVariableInt(tvbuff_t *tvb, const gint offset, const guint length)\r\n{\r\nswitch(length)\r\n{\r\ncase 1:\r\nreturn tvb_get_guint8(tvb, offset);\r\ncase 2:\r\nreturn tvb_get_letohs(tvb, offset);\r\ncase 3:\r\nreturn tvb_get_letoh24(tvb, offset);\r\ncase 4:\r\nreturn tvb_get_letohl(tvb, offset);\r\ncase 5:\r\nreturn tvb_get_letoh40(tvb, offset);\r\ncase 6:\r\nreturn tvb_get_letoh48(tvb, offset);\r\ncase 7:\r\nreturn tvb_get_letoh56(tvb, offset);\r\ncase 8:\r\nreturn tvb_get_letoh64(tvb, offset);\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic guint parseTLVHeader(tvbuff_t *tvb, lwm2mElement_t *element)\r\n{\r\nguint type_field = tvb_get_guint8(tvb, 0);\r\nelement->type = (( type_field >> 6 ) & 0x03 );\r\nelement->length_of_identifier = (( type_field >> 5 ) & 0x01 ) + 1;\r\nelement->length_of_length = (( type_field >> 3 ) & 0x03 );\r\nelement->length_of_value = (( type_field >> 0 ) & 0x07 );\r\nelement->identifier = (guint) decodeVariableInt(tvb, 1, element->length_of_identifier);\r\nif ( element->length_of_length > 0 ) {\r\nelement->length_of_value = (guint) decodeVariableInt(tvb, 1 + element->length_of_identifier, element->length_of_length);\r\n}\r\nelement->totalLength = 1 + element->length_of_identifier + element->length_of_length + element->length_of_value;\r\nreturn element->totalLength;\r\n}\r\nstatic void parseArrayOfElements(tvbuff_t *tvb, proto_tree *tlv_tree)\r\n{\r\nguint length;\r\nguint offset = 0;\r\nguint elementLength = 0;\r\nlwm2mElement_t element;\r\nlength = tvb_reported_length(tvb);\r\nwhile ( length > 0 ) {\r\ntvbuff_t* sub = tvb_new_subset_length(tvb, offset, length);\r\nelementLength = parseTLVHeader(sub, &element);\r\naddTlvElement(sub, tlv_tree, &element);\r\nlength -= elementLength;\r\noffset += elementLength;\r\nif ( elementLength == 0 )\r\n{\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic int\r\ndissect_lwm2mtlv(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree* lwm2mtlv_tree;\r\nproto_item* lwm2mtlv_item;\r\nif (tree) {\r\nlwm2mtlv_item = proto_tree_add_item(tree, proto_lwm2mtlv, tvb, 0, -1, ENC_NA);\r\nlwm2mtlv_tree = proto_item_add_subtree(lwm2mtlv_item, ett_lwm2mtlv);\r\nparseArrayOfElements(tvb, lwm2mtlv_tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_lwm2mtlv(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_lwm2mtlv_header,\r\n{ "TLV header", "lwm2mtlv.header",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_type_type,\r\n{ "Type of Identifier", "lwm2mtlv.type.type",\r\nFT_UINT8, BASE_DEC, VALS(identifiers), 0xC0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_type_length_of_identifier,\r\n{ "Length of Identifier", "lwm2mtlv.type.loi",\r\nFT_UINT8, BASE_DEC, VALS(length_identifier), 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_type_length_of_length,\r\n{ "Length of Length", "lwm2mtlv.type.lol",\r\nFT_UINT8, BASE_DEC, VALS(length_type), 0x18,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_type_length,\r\n{ "Length", "lwm2mtlv.type.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x07,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_type_ignored,\r\n{ "Ignored", "lwm2mtlv.type.ignored",\r\nFT_UINT8, BASE_DEC, NULL, 0x07,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_identifier,\r\n{ "Identifier", "lwm2mtlv.identifier",\r\nFT_UINT16, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_length,\r\n{ "Length", "lwm2mtlv.length",\r\nFT_UINT32, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value,\r\n{ "Value", "lwm2mtlv.value",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value_string,\r\n{ "As String", "lwm2mtlv.value.string",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value_integer,\r\n{ "As Integer", "lwm2mtlv.value.integer",\r\nFT_INT64, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value_float,\r\n{ "As Float", "lwm2mtlv.value.float",\r\nFT_FLOAT, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value_double,\r\n{ "As Double", "lwm2mtlv.value.double",\r\nFT_DOUBLE, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value_boolean,\r\n{ "As Boolean", "lwm2mtlv.value.boolean",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_lwm2mtlv_value_timestamp,\r\n{ "As Timestamp", "lwm2mtlv.value.timestamp",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint* ett[] = {\r\n&ett_lwm2mtlv,\r\n&ett_lwm2mtlv_header,\r\n&ett_lwm2mtlv_resource,\r\n&ett_lwm2mtlv_resourceInstance,\r\n&ett_lwm2mtlv_resourceArray,\r\n&ett_lwm2mtlv_objectInstance\r\n};\r\nproto_lwm2mtlv = proto_register_protocol (\r\n"Lightweight M2M TLV",\r\n"LwM2M-TLV",\r\n"lwm2mtlv"\r\n);\r\nproto_register_field_array(proto_lwm2mtlv, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("lwm2mtlv", dissect_lwm2mtlv, proto_lwm2mtlv);\r\n}\r\nvoid\r\nproto_reg_handoff_lwm2mtlv(void)\r\n{\r\nstatic dissector_handle_t lwm2mtlv_handle;\r\nlwm2mtlv_handle = create_dissector_handle(dissect_lwm2mtlv, proto_lwm2mtlv);\r\ndissector_add_string("media_type", "application/vnd.oma.lwm2m+tlv", lwm2mtlv_handle);\r\n}

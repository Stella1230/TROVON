static void\r\nmcpe_dissect_detail_0xA0(tvbuff_t *tvb, proto_tree *raknet_tree, gint offset)\r\n{\r\ngboolean single_packet;\r\ngint item_size;\r\nitem_size = 2;\r\nproto_tree_add_item(raknet_tree, hf_mcpe_0xC0_unknown, tvb, offset,\r\nitem_size, ENC_BIG_ENDIAN);\r\noffset += item_size;\r\nsingle_packet = (tvb_get_guint8(tvb, offset) != 0);\r\nitem_size = 1;\r\nproto_tree_add_item(raknet_tree, hf_mcpe_0xC0_single_packet, tvb, offset,\r\nitem_size, ENC_BIG_ENDIAN);\r\noffset += item_size;\r\nitem_size = 3;\r\nproto_tree_add_item(raknet_tree, hf_mcpe_general_packet_number, tvb, offset,\r\nitem_size, ENC_BIG_ENDIAN);\r\noffset += item_size;\r\nif (!single_packet) {\r\nitem_size = 3;\r\nproto_tree_add_item(raknet_tree, hf_mcpe_general_packet_number, tvb,\r\noffset, item_size, ENC_BIG_ENDIAN);\r\n}\r\n}\r\nstatic void\r\nmcpe_dissect_detail_payload_0x00(tvbuff_t *tvb, proto_tree *mcpe_tree,\r\ngint *offset)\r\n{\r\ngint item_size;\r\nitem_size = 2;\r\nproto_tree_add_item(mcpe_tree, hf_mcpe_general_packet_payload_length, tvb,\r\n*offset, item_size, ENC_BIG_ENDIAN);\r\n*offset += item_size;\r\n}\r\nstatic void\r\nmcpe_dissect_detail_payload_0x40(tvbuff_t *tvb, proto_tree *mcpe_tree,\r\ngint *offset)\r\n{\r\ngint item_size;\r\nitem_size = 2;\r\nproto_tree_add_item(mcpe_tree, hf_mcpe_general_packet_payload_length, tvb,\r\n*offset, item_size, ENC_BIG_ENDIAN);\r\n*offset += item_size;\r\nitem_size = 3;\r\nproto_tree_add_item(mcpe_tree, hf_mcpe_general_packet_payload_count, tvb,\r\n*offset, item_size, ENC_BIG_ENDIAN);\r\n*offset += item_size;\r\n}\r\nstatic void\r\nmcpe_dissect_detail_payload(tvbuff_t *tvb, proto_tree *mcpe_tree, gint offset)\r\n{\r\ngint payload_encoding;\r\ngint item_size;\r\nitem_size = 3;\r\nproto_tree_add_item(mcpe_tree, hf_mcpe_general_packet_number, tvb, offset,\r\nitem_size, ENC_BIG_ENDIAN);\r\noffset += item_size;\r\npayload_encoding = tvb_get_guint8(tvb, offset);\r\nitem_size = 1;\r\nproto_tree_add_item(mcpe_tree, hf_mcpe_payload_encoding, tvb, offset,\r\nitem_size, ENC_BIG_ENDIAN);\r\noffset += item_size;\r\nswitch (payload_encoding) {\r\ncase 0x00:\r\nmcpe_dissect_detail_payload_0x00(tvb, mcpe_tree, &offset);\r\nbreak;\r\ncase 0x40:\r\ncase 0x50:\r\ncase 0x60:\r\nmcpe_dissect_detail_payload_0x40(tvb, mcpe_tree, &offset);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nitem_size = -1;\r\nproto_tree_add_item(mcpe_tree, hf_mcpe_general_packet_payload, tvb, offset,\r\nitem_size, ENC_NA);\r\n}\r\nstatic proto_tree *\r\nmcpe_info(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint *offset)\r\n{\r\nconst char *packet_desc;\r\nguint8 packet_id;\r\nproto_tree *sub_tree;\r\nproto_item *ti;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MCPE");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_mcpe, tvb, 0, -1, ENC_NA);\r\nsub_tree = proto_item_add_subtree(ti, ett_mcpe);\r\npacket_id = tvb_get_guint8(tvb, *offset);\r\nproto_tree_add_item(sub_tree, hf_mcpe_packet_id, tvb, *offset,\r\n1, ENC_BIG_ENDIAN);\r\n*offset += 1;\r\nswitch (packet_id) {\r\ncase 0xA0:\r\npacket_desc = " (NACK)";\r\nbreak;\r\ncase 0xC0:\r\npacket_desc = " (ACK)";\r\nbreak;\r\ndefault:\r\npacket_desc = "";\r\nbreak;\r\n}\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Type %#x%s", packet_id, packet_desc);\r\nproto_item_append_text(ti, ", Packet id %#x", packet_id);\r\nreturn sub_tree;\r\n}\r\nstatic int\r\nmcpe_dissect(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_tree *sub_tree;\r\ngint offset;\r\noffset = 0;\r\nsub_tree = mcpe_info(tvb, pinfo, tree, &offset);\r\nif (sub_tree != NULL) {\r\nmcpe_dissect_detail_payload(tvb, sub_tree, offset);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic int\r\nmcpe_dissect_0xA0(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_tree *sub_tree;\r\ngint offset;\r\noffset = 0;\r\nsub_tree = mcpe_info(tvb, pinfo, tree, &offset);\r\nif (sub_tree != NULL) {\r\nmcpe_dissect_detail_0xA0(tvb, sub_tree, offset);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic int\r\nmcpe_dissect_0xC0(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nproto_tree *sub_tree;\r\ngint offset;\r\noffset = 0;\r\nsub_tree = mcpe_info(tvb, pinfo, tree, &offset);\r\nif (sub_tree != NULL) {\r\nmcpe_dissect_detail_0xA0(tvb, sub_tree, offset);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_mcpe(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_mcpe_packet_id,\r\n{ "MCPE Packet ID", "mcpe.type",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_payload_encoding,\r\n{ "MCPE Payload encoding", "mcpe.payload_encoding",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_general_packet_number,\r\n{ "MCPE Packet number", "mcpe.packet_number",\r\nFT_UINT24, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_general_packet_payload,\r\n{ "MCPE Packet Payload", "mcpe.packet_payload",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_general_packet_payload_length,\r\n{ "MCPE Payload length in *bits*", "mcpe.payload_length_bits",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_general_packet_payload_count,\r\n{ "MCPE Packet payload count", "mcpe.payload_count",\r\nFT_UINT24, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_0xC0_unknown,\r\n{ "MCPE Unknown field", "mcpe.unknown",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_mcpe_0xC0_single_packet,\r\n{ "MCPE single packet (boolean)", "mcpe.single_packet",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mcpe,\r\n};\r\nmodule_t *mcpe_module;\r\nproto_mcpe = proto_register_protocol (\r\n"Minecraft Pocket Edition",\r\n"MCPE",\r\n"mcpe"\r\n);\r\nproto_register_field_array(proto_mcpe, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nmcpe_module = prefs_register_protocol(proto_mcpe,\r\nproto_reg_handoff_mcpe);\r\nprefs_register_uint_preference(mcpe_module, "udp.port",\r\n"MCPE Server UDP Port",\r\n"Set the UDP port for the MCPE Server",\r\n10, &mcpe_udp_port_requested);\r\n}\r\nvoid\r\nproto_reg_handoff_mcpe(void)\r\n{\r\nstatic dissector_handle_t raknet_dissector = NULL;\r\nstatic guint last_server_port;\r\nstatic gboolean init_done = FALSE;\r\nif (init_done) {\r\ndissector_delete_uint("udp.port", last_server_port, raknet_dissector);\r\n} else {\r\ndissector_handle_t mcpe_gen_handle;\r\ninit_done = TRUE;\r\nraknet_dissector = find_dissector("raknet");\r\nmcpe_gen_handle = create_dissector_handle(mcpe_dissect, proto_mcpe);\r\ndissector_add_uint("raknet.packet_id", 0x80, mcpe_gen_handle);\r\ndissector_add_uint("raknet.packet_id", 0x84, mcpe_gen_handle);\r\ndissector_add_uint("raknet.packet_id", 0x88, mcpe_gen_handle);\r\ndissector_add_uint("raknet.packet_id", 0x8C, mcpe_gen_handle);\r\ndissector_add_uint("raknet.packet_id", 0xA0,\r\ncreate_dissector_handle(mcpe_dissect_0xA0,\r\nproto_mcpe));\r\ndissector_add_uint("raknet.packet_id", 0xC0,\r\ncreate_dissector_handle(mcpe_dissect_0xC0,\r\nproto_mcpe));\r\n}\r\nlast_server_port = mcpe_udp_port_requested;\r\ndissector_add_uint("udp.port", mcpe_udp_port_requested, raknet_dissector);\r\n}

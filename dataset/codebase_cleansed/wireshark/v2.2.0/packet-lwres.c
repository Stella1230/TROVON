static void dissect_getnamebyaddr_request(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint32 flags,family;\r\nguint addrlen, slen;\r\nconst char* addrs;\r\nproto_tree* nba_request_tree;\r\nflags = tvb_get_ntohl(tvb, LWRES_LWPACKET_LENGTH);\r\nfamily = tvb_get_ntohl(tvb, LWRES_LWPACKET_LENGTH + 4);\r\naddrlen = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH + 8);\r\naddrs = tvb_ip_to_str(tvb, LWRES_LWPACKET_LENGTH + 10);\r\nslen = (int)strlen(addrs);\r\nif (lwres_tree == NULL)\r\nreturn;\r\nnba_request_tree = proto_tree_add_subtree(lwres_tree,tvb,LWRES_LWPACKET_LENGTH,LWRES_LWPACKET_LENGTH+14,\r\nett_nba_request,NULL,"getnamebyaddr parameters");\r\nproto_tree_add_uint(nba_request_tree, hf_adn_flags, tvb,\r\nLWRES_LWPACKET_LENGTH, 4, flags);\r\nproto_tree_add_uint(nba_request_tree, hf_adn_family, tvb,\r\nLWRES_LWPACKET_LENGTH + 4, 4, family);\r\nproto_tree_add_uint(nba_request_tree, hf_adn_addr_len, tvb,\r\nLWRES_LWPACKET_LENGTH + 8, 2, addrlen);\r\nproto_tree_add_string(nba_request_tree, hf_adn_addr_addr, tvb,\r\nLWRES_LWPACKET_LENGTH + 10, slen, addrs);\r\n}\r\nstatic void dissect_getnamebyaddr_response(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint32 i, offset;\r\nguint16 naliases,realnamelen,aliaslen;\r\ngchar *aliasname;\r\nproto_tree* nba_resp_tree;\r\nproto_tree* alias_tree;\r\nif(lwres_tree == NULL)\r\nreturn;\r\nnba_resp_tree = proto_tree_add_subtree(lwres_tree, tvb, LWRES_LWPACKET_LENGTH, 10, ett_nba_resp, NULL, "getnamebyaddr records");\r\nnaliases = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH + 4);\r\nrealnamelen = tvb_get_ntohs(tvb,LWRES_LWPACKET_LENGTH + 4 + 2);\r\nproto_tree_add_item(nba_resp_tree,\r\nhf_adn_flags,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH,\r\n4,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(nba_resp_tree,\r\nhf_adn_naliases,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH + 4,\r\n2,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(nba_resp_tree,\r\nhf_adn_namelen,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH + 6,\r\n2,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(nba_resp_tree,\r\nhf_adn_realname,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH + 8,\r\nrealnamelen,\r\nENC_ASCII|ENC_NA);\r\noffset=LWRES_LWPACKET_LENGTH + 8 + realnamelen;\r\nif(naliases)\r\n{\r\nfor(i=0; i<naliases; i++)\r\n{\r\naliaslen = tvb_get_ntohs(tvb, offset);\r\naliasname = tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 2, aliaslen, ENC_ASCII);\r\nalias_tree = proto_tree_add_subtree_format(nba_resp_tree, tvb, offset, 2 + aliaslen,\r\nett_adn_alias, NULL, "Alias %s",aliasname);\r\nproto_tree_add_item(alias_tree,\r\nhf_adn_namelen,\r\ntvb,\r\noffset,\r\n2,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(alias_tree,\r\nhf_adn_aliasname,\r\ntvb,\r\noffset + 2,\r\naliaslen,\r\nENC_ASCII|ENC_NA);\r\noffset+=(2 + aliaslen + 1);\r\n}\r\n}\r\n}\r\nstatic void dissect_getaddrsbyname_request(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint16 namelen;\r\nproto_tree* adn_request_tree;\r\nnamelen = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH + 8);\r\nif(lwres_tree == NULL)\r\nreturn;\r\nadn_request_tree = proto_tree_add_subtree(lwres_tree,tvb,\r\nLWRES_LWPACKET_LENGTH,10+namelen+1,\r\nett_adn_request, NULL,\r\n"getaddrbyname parameters");\r\nproto_tree_add_item(adn_request_tree,\r\nhf_adn_flags,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+0,\r\nsizeof(guint32),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_request_tree,\r\nhf_adn_addrtype,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+4,\r\nsizeof(guint32),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_request_tree,\r\nhf_adn_namelen,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+8,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_request_tree,\r\nhf_adn_name,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+10,\r\nnamelen,\r\nENC_ASCII|ENC_NA);\r\n}\r\nstatic void dissect_getaddrsbyname_response(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint32 family ,i, offset;\r\nguint16 naliases, naddrs, realnamelen, length, aliaslen;\r\nconst gchar* addrs;\r\nguint slen;\r\ngchar *aliasname;\r\nproto_tree *adn_resp_tree;\r\nproto_tree *alias_tree;\r\nproto_tree *addr_tree;\r\nif(lwres_tree == NULL)\r\nreturn;\r\nadn_resp_tree = proto_tree_add_subtree(lwres_tree, tvb, LWRES_LWPACKET_LENGTH, 10,\r\nett_adn_resp, NULL, "getaddrbyname records");\r\nnaliases = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH + 4);\r\nnaddrs = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH + 6);\r\nrealnamelen = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH + 8);\r\nproto_tree_add_item(adn_resp_tree, hf_adn_flags, tvb,\r\nLWRES_LWPACKET_LENGTH, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_resp_tree, hf_adn_naliases, tvb,\r\nLWRES_LWPACKET_LENGTH + 4, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_resp_tree, hf_adn_naddrs, tvb,\r\nLWRES_LWPACKET_LENGTH + 6, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_resp_tree, hf_adn_namelen, tvb,\r\nLWRES_LWPACKET_LENGTH + 8, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(adn_resp_tree, hf_adn_realname, tvb,\r\nLWRES_LWPACKET_LENGTH + 10, realnamelen, ENC_ASCII|ENC_NA);\r\noffset = LWRES_LWPACKET_LENGTH + 10 + realnamelen + 1;\r\nif(naliases)\r\n{\r\nfor(i=0; i<naliases; i++)\r\n{\r\naliaslen = tvb_get_ntohs(tvb, offset);\r\naliasname = tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 2, aliaslen, ENC_ASCII);\r\nalias_tree = proto_tree_add_subtree_format(adn_resp_tree, tvb, offset, 2 + aliaslen,\r\nett_adn_alias, NULL, "Alias %s",aliasname);\r\nproto_tree_add_uint(alias_tree, hf_adn_namelen, tvb,\r\noffset, 2, aliaslen);\r\nproto_tree_add_item(alias_tree, hf_adn_aliasname, tvb,\r\noffset + 2, aliaslen, ENC_ASCII|ENC_NA);\r\noffset+=(2 + aliaslen + 1);\r\n}\r\n}\r\nif(naddrs)\r\n{\r\nfor(i=0; i < naddrs; i++)\r\n{\r\nfamily = tvb_get_ntohl(tvb, offset);\r\nlength = tvb_get_ntohs(tvb, offset + 4);\r\naddrs = tvb_ip_to_str(tvb, offset + 6);\r\nslen = (int)strlen(addrs);\r\naddr_tree = proto_tree_add_subtree_format(adn_resp_tree,tvb, offset, 4+2+4, ett_adn_addr, NULL, "Address %s", addrs);\r\nproto_tree_add_uint(addr_tree, hf_adn_family, tvb,\r\noffset, 4, family);\r\nproto_tree_add_uint(addr_tree, hf_adn_addr_len, tvb,\r\noffset + 4, 2, length);\r\nproto_tree_add_string(addr_tree, hf_adn_addr_addr, tvb,\r\noffset + 6, slen, addrs);\r\noffset+= 4 + 2 + 4;\r\n}\r\n}\r\n}\r\nstatic void dissect_a_records(tvbuff_t* tvb, proto_tree* tree,guint32 nrec,int offset)\r\n{\r\nguint32 i, curr;\r\nconst gchar* addrs;\r\nproto_tree* a_rec_tree;\r\nproto_tree* addr_tree;\r\nif(tree == NULL)\r\nreturn;\r\na_rec_tree = proto_tree_add_subtree(tree,tvb,offset,\r\n(int)((sizeof(guint32) + sizeof(guint16)) * nrec),\r\nett_a_rec, NULL, "A records");\r\nfor(i=0; i<nrec; i++)\r\n{\r\ncurr = offset + (int)((sizeof(guint32)+sizeof(guint16)) * i);\r\naddrs = tvb_ip_to_str(tvb, curr+2);\r\naddr_tree = proto_tree_add_subtree_format(a_rec_tree, tvb, curr,\r\n6, ett_a_rec_addr, NULL, "Address %s", addrs);\r\nproto_tree_add_item(addr_tree, hf_a_rec_len, tvb, curr,\r\nsizeof(guint16), ENC_BIG_ENDIAN);\r\nproto_tree_add_item(addr_tree, hf_a_record, tvb, curr + 2, 4, ENC_BIG_ENDIAN);\r\n}\r\n}\r\nstatic void dissect_srv_records(tvbuff_t* tvb, proto_tree* tree,guint32 nrec,int offset)\r\n{\r\nguint32 i, curr;\r\nguint16 priority, weight, port, dlen;\r\nconst guchar *dname;\r\nproto_item* srv_rec_tree, *rec_tree;\r\nif(tree == NULL)\r\nreturn;\r\nsrv_rec_tree = proto_tree_add_subtree_format(tree, tvb, offset, offset, ett_srv_rec, NULL, "SRV records (%d)", nrec);\r\ncurr = offset;\r\nfor(i=0; i < nrec; i++)\r\n{\r\npriority = tvb_get_ntohs(tvb, curr + 2);\r\nweight = tvb_get_ntohs(tvb, curr + 4);\r\nport = tvb_get_ntohs(tvb, curr + 6);\r\ndlen = get_dns_name(tvb, curr + 8, 0, curr + 8, &dname);\r\nrec_tree = proto_tree_add_subtree_format(srv_rec_tree, tvb, curr, 6,\r\nett_srv_rec_item, NULL,\r\n"SRV record:pri=%d,w=%d,port=%d,dname=%s",\r\npriority, weight, port, dname);\r\nproto_tree_add_uint(rec_tree,\r\nhf_srv_prio,\r\ntvb,\r\ncurr + 2,\r\n2,\r\npriority);\r\nproto_tree_add_uint(rec_tree,\r\nhf_srv_weight,\r\ntvb,\r\ncurr + 4,\r\n2,\r\nweight);\r\nproto_tree_add_uint(rec_tree,\r\nhf_srv_port,\r\ntvb,\r\ncurr + 6,\r\n2,\r\nport);\r\nproto_tree_add_string(rec_tree,\r\nhf_srv_dname,\r\ntvb,\r\ncurr + 8,\r\ndlen,\r\ndname);\r\ncurr+=(int)((sizeof(short)*4) + dlen);\r\n}\r\n}\r\nstatic void dissect_mx_records(tvbuff_t* tvb, proto_tree* tree, guint32 nrec, int offset)\r\n{\r\nguint i, curr;\r\nguint priority, dlen;\r\nconst guchar *dname;\r\nproto_tree* mx_rec_tree, *rec_tree;\r\nif(tree == NULL)\r\nreturn;\r\nmx_rec_tree = proto_tree_add_subtree_format(tree, tvb, offset, offset, ett_mx_rec, NULL, "MX records (%d)", nrec);\r\ncurr = offset;\r\nfor(i=0; i < nrec; i++)\r\n{\r\npriority = tvb_get_ntohs(tvb, curr + 2);\r\ndlen = get_dns_name(tvb, curr + 4, 0, curr + 4, &dname);\r\nrec_tree = proto_tree_add_subtree_format(mx_rec_tree, tvb, curr,6,ett_mx_rec_item,NULL,\r\n"MX record: pri=%d,dname=%s", priority,dname);\r\nproto_tree_add_item(rec_tree,\r\nhf_srv_prio,\r\ntvb,\r\ncurr + 2,\r\n2,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_string(rec_tree,\r\nhf_srv_dname,\r\ntvb,\r\ncurr + 4,\r\ndlen,\r\ndname);\r\ncurr+=(int)((sizeof(short)*2) + dlen);\r\n}\r\n}\r\nstatic void dissect_ns_records(tvbuff_t* tvb, proto_tree* tree, guint32 nrec, int offset)\r\n{\r\nguint i, curr;\r\nguint dlen;\r\nconst guchar *dname;\r\nproto_tree* ns_rec_tree, *rec_tree;\r\nif(tree == NULL)\r\nreturn;\r\nns_rec_tree = proto_tree_add_subtree_format(tree, tvb, offset, offset, ett_ns_rec, NULL, "NS record (%d)", nrec);\r\ncurr=offset;\r\nfor(i=0;i<nrec;i++)\r\n{\r\ndlen = get_dns_name(tvb, curr + 2, 0, curr + 2, &dname);\r\nrec_tree = proto_tree_add_subtree_format(ns_rec_tree, tvb, curr,4, ett_ns_rec_item, NULL, "NS record: dname=%s",dname);\r\nproto_tree_add_string(rec_tree,\r\nhf_ns_dname,\r\ntvb,\r\ncurr + 2,\r\ndlen,\r\ndname);\r\ncurr+=(int)(sizeof(short) + dlen);\r\n}\r\n}\r\nstatic void dissect_rdata_request(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint16 namelen;\r\nproto_tree* rdata_request_tree;\r\nnamelen = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH+8);\r\nif(lwres_tree == NULL)\r\nreturn;\r\nrdata_request_tree =\r\nproto_tree_add_subtree(lwres_tree,tvb,LWRES_LWPACKET_LENGTH,10+namelen+1,ett_rdata_req,NULL,"RDATA request parameters");\r\nproto_tree_add_item(rdata_request_tree,\r\nhf_rflags,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+0,\r\nsizeof(guint32),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_request_tree,\r\nhf_rdclass,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+4,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_request_tree,\r\nhf_rdtype,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+6,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_request_tree,\r\nhf_namelen,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+8,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_request_tree,\r\nhf_req_name,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+10,\r\nnamelen,\r\nENC_ASCII|ENC_NA);\r\n}\r\nstatic void dissect_rdata_response(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint offset;\r\nguint rdtype, nrdatas, realnamelen;\r\nproto_tree* rdata_resp_tree;\r\nrdtype = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH+6);\r\nnrdatas = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH+12);\r\nrealnamelen = tvb_get_ntohs(tvb,LWRES_LWPACKET_LENGTH+16);\r\noffset = LWRES_LWPACKET_LENGTH + 18 + realnamelen + 1;\r\nif(lwres_tree == NULL)\r\nreturn;\r\nrdata_resp_tree = proto_tree_add_subtree(lwres_tree,tvb,LWRES_LWPACKET_LENGTH, 18+realnamelen+1,ett_rdata_resp,NULL,"RDATA response");\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_rflags,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+0,\r\nsizeof(guint32),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_rdclass,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+4,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_rdtype,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+6,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_ttl,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+8,\r\nsizeof(guint32),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_nrdatas,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+12,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_nsigs,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+14,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_realnamelen,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+16,\r\nsizeof(guint16),\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(rdata_resp_tree,\r\nhf_realname,\r\ntvb,\r\nLWRES_LWPACKET_LENGTH+18,\r\nrealnamelen,\r\nENC_ASCII|ENC_NA);\r\nswitch(rdtype)\r\n{\r\ncase T_A:\r\ndissect_a_records(tvb,rdata_resp_tree,nrdatas,offset);\r\nbreak;\r\ncase T_SRV:\r\ndissect_srv_records(tvb,rdata_resp_tree,nrdatas, offset);\r\nbreak;\r\ncase T_MX:\r\ndissect_mx_records(tvb,rdata_resp_tree,nrdatas, offset);\r\nbreak;\r\ncase T_NS:\r\ndissect_ns_records(tvb,rdata_resp_tree,nrdatas, offset);\r\nbreak;\r\n}\r\n}\r\nstatic void dissect_noop(tvbuff_t* tvb, proto_tree* lwres_tree)\r\n{\r\nguint16 datalen;\r\nproto_tree* noop_tree;\r\ndatalen = tvb_get_ntohs(tvb, LWRES_LWPACKET_LENGTH);\r\nif(lwres_tree == NULL)\r\nreturn;\r\nnoop_tree = proto_tree_add_subtree(lwres_tree, tvb, LWRES_LWPACKET_LENGTH, 10, ett_noop, NULL, "Noop record");\r\nproto_tree_add_uint(noop_tree, hf_length, tvb,\r\nLWRES_LWPACKET_LENGTH, sizeof(guint16), datalen);\r\ntvb_ensure_bytes_exist(tvb, LWRES_LWPACKET_LENGTH, datalen);\r\n}\r\nstatic void dissect_getaddrsbyname(tvbuff_t* tvb, proto_tree* lwres_tree, int type)\r\n{\r\nif(type == 1)\r\ndissect_getaddrsbyname_request(tvb, lwres_tree);\r\nelse\r\ndissect_getaddrsbyname_response(tvb, lwres_tree);\r\n}\r\nstatic void dissect_getnamebyaddr(tvbuff_t* tvb, proto_tree* lwres_tree, int type)\r\n{\r\nif(type == 1)\r\ndissect_getnamebyaddr_request(tvb, lwres_tree);\r\nelse\r\ndissect_getnamebyaddr_response(tvb, lwres_tree);\r\n}\r\nstatic void dissect_getrdatabyname(tvbuff_t* tvb, proto_tree* lwres_tree, int type)\r\n{\r\nif(type == 1)\r\ndissect_rdata_request(tvb, lwres_tree);\r\nelse\r\ndissect_rdata_response(tvb, lwres_tree);\r\n}\r\nstatic int\r\ndissect_lwres(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint16 version, flags, authtype, authlength ;\r\nguint32 length, opcode, result, recvlength, serial;\r\nguint32 message_type;\r\nproto_item* lwres_item;\r\nproto_tree* lwres_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "lw_res");\r\nlength = tvb_get_ntohl(tvb, LW_LENGTH_OFFSET);\r\nversion = tvb_get_ntohs(tvb, LW_VERSION_OFFSET);\r\nflags = tvb_get_ntohs(tvb, LW_PKTFLASG_OFFSET);\r\nserial = tvb_get_ntohl(tvb, LW_SERIAL_OFFSET);\r\nopcode = tvb_get_ntohl(tvb,LW_OPCODE_OFFSET);\r\nresult = tvb_get_ntohl(tvb, LW_RESULT_OFFSET);\r\nrecvlength = tvb_get_ntohl(tvb, LW_RECVLEN_OFFSET);\r\nauthtype = tvb_get_ntohs(tvb, LW_AUTHTYPE_OFFSET);\r\nauthlength = tvb_get_ntohs(tvb, LW_AUTHLEN_OFFSET);\r\nmessage_type = (flags & LWRES_LWPACKETFLAG_RESPONSE) ? 2 : 1;\r\nif(flags & LWRES_LWPACKETFLAG_RESPONSE)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"%s, opcode=%s, serial=0x%x, result=%s",\r\nval_to_str_const((guint32)message_type,message_types_values,"unknown"),\r\nval_to_str_const(opcode, opcode_values, "unknown"),\r\nserial,\r\nval_to_str_const(result,result_values,"unknown"));\r\n}\r\nelse\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"%s, opcode=%s, serial=0x%x",\r\nval_to_str_const((guint32)message_type,message_types_values,"unknown"),\r\nval_to_str_const(opcode, opcode_values, "unknown"),\r\nserial);\r\n}\r\nif(tree == NULL)\r\nreturn tvb_captured_length(tvb);\r\nlwres_item = proto_tree_add_item(tree,proto_lwres, tvb,0, -1, ENC_NA);\r\nlwres_tree = proto_item_add_subtree(lwres_item, ett_lwres);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_length,\r\ntvb,\r\nLW_LENGTH_OFFSET,\r\nsizeof(guint32),\r\nlength);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_version,\r\ntvb,\r\nLW_VERSION_OFFSET,\r\nsizeof(guint16),\r\nversion);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_flags,\r\ntvb,\r\nLW_PKTFLASG_OFFSET,\r\nsizeof(guint16),\r\nflags);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_serial,\r\ntvb,\r\nLW_SERIAL_OFFSET,\r\nsizeof(guint32),\r\nserial);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_opcode,\r\ntvb,\r\nLW_OPCODE_OFFSET,\r\nsizeof(guint32),\r\nopcode);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_result,\r\ntvb,\r\nLW_RESULT_OFFSET,\r\nsizeof(guint32),\r\nresult);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_recvlen,\r\ntvb,\r\nLW_RECVLEN_OFFSET,\r\nsizeof(guint32),\r\nrecvlength);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_authtype,\r\ntvb,\r\nLW_AUTHTYPE_OFFSET,\r\nsizeof(guint16),\r\nauthtype);\r\nproto_tree_add_uint(lwres_tree,\r\nhf_authlen,\r\ntvb,\r\nLW_AUTHLEN_OFFSET,\r\nsizeof(guint16),\r\nauthlength);\r\nif(!result)\r\n{\r\nswitch(opcode)\r\n{\r\ncase LWRES_OPCODE_NOOP:\r\ndissect_noop(tvb, lwres_tree);\r\nbreak;\r\ncase LWRES_OPCODE_GETADDRSBYNAME:\r\ndissect_getaddrsbyname(tvb, lwres_tree, message_type);\r\nbreak;\r\ncase LWRES_OPCODE_GETNAMEBYADDR:\r\ndissect_getnamebyaddr(tvb, lwres_tree, message_type);\r\nbreak;\r\ncase LWRES_OPCODE_GETRDATABYNAME:\r\ndissect_getrdatabyname(tvb, lwres_tree, message_type);\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_lwres(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_length,\r\n{ "Length", "lwres.length", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lwres length", HFILL }},\r\n{ &hf_version,\r\n{ "Version", "lwres.version", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres version", HFILL }},\r\n{ &hf_flags,\r\n{ "Packet Flags", "lwres.flags", FT_UINT16, BASE_HEX, NULL, 0x0,\r\n"lwres flags", HFILL }},\r\n{ &hf_serial,\r\n{ "Serial", "lwres.serial", FT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lwres serial", HFILL }},\r\n{ &hf_opcode,\r\n{ "Operation code", "lwres.opcode", FT_UINT32, BASE_DEC, VALS(opcode_values), 0x0,\r\n"lwres opcode", HFILL }},\r\n{ &hf_result,\r\n{ "Result", "lwres.result", FT_UINT32, BASE_DEC, VALS(result_values), 0x0,\r\n"lwres result", HFILL }},\r\n{ &hf_recvlen,\r\n{ "Received length", "lwres.recvlen", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lwres recvlen", HFILL }},\r\n{ &hf_authtype,\r\n{ "Auth. type", "lwres.authtype", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres authtype", HFILL }},\r\n{ &hf_authlen,\r\n{ "Auth. length", "lwres.authlen", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres authlen", HFILL }},\r\n{ &hf_rflags,\r\n{ "Flags", "lwres.rflags", FT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lwres rflags", HFILL }},\r\n{ &hf_rdclass,\r\n{ "Class", "lwres.class", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres class", HFILL }},\r\n{ &hf_rdtype,\r\n{ "Type", "lwres.type", FT_UINT16, BASE_DEC, VALS(t_types), 0x0,\r\n"lwres type", HFILL }},\r\n{ &hf_namelen,\r\n{ "Name length", "lwres.namelen", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres namelen", HFILL }},\r\n{ &hf_req_name,\r\n{ "Domain name", "lwres.reqdname", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"lwres reqdname", HFILL }},\r\n{ &hf_ttl,\r\n{ "Time To Live", "lwres.ttl", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lwres ttl", HFILL }},\r\n{ &hf_nrdatas,\r\n{ "Number of rdata records", "lwres.nrdatas", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres nrdatas", HFILL }},\r\n{ &hf_nsigs,\r\n{ "Number of signature records", "lwres.nsigs", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres nsigs", HFILL }},\r\n{ &hf_realnamelen,\r\n{ "Real name length", "lwres.realnamelen", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres realnamelen", HFILL }},\r\n{ &hf_realname,\r\n{ "Real doname name", "lwres.realname", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"lwres realname", HFILL }},\r\n{ &hf_a_record,\r\n{ "IPv4 Address", "lwres.arecord", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lwres arecord", HFILL }},\r\n{ &hf_a_rec_len,\r\n{ "Length", "lwres.areclen", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres areclen", HFILL }},\r\n{ &hf_srv_prio,\r\n{ "Priority", "lwres.srv.priority", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres srv prio", HFILL }},\r\n{ &hf_srv_weight,\r\n{ "Weight", "lwres.srv.weight", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres srv weight", HFILL }},\r\n{ &hf_srv_port,\r\n{ "Port" , "lwres.srv.port", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres srv port", HFILL }},\r\n{ &hf_srv_dname,\r\n{ "DNAME" , "lwres.srv.dname", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_adn_flags,\r\n{ "Flags", "lwres.adn.flags", FT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lwres adn flags", HFILL }},\r\n{ &hf_adn_addrtype,\r\n{ "Address type", "lwres.adn.addrtype", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lwres adn addrtype", HFILL }},\r\n{ &hf_adn_namelen,\r\n{ "Name length", "lwres.adn.namelen", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres adn namelen", HFILL }},\r\n{ &hf_adn_name,\r\n{ "Name", "lwres.adn.name", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"lwres adn name", HFILL }},\r\n{ &hf_adn_naliases,\r\n{ "Number of aliases", "lwres.adn.naliases", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres adn naliases", HFILL }},\r\n{ &hf_adn_naddrs,\r\n{ "Number of addresses", "lwres.adn.naddrs", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres adn naddrs", HFILL }},\r\n{ &hf_adn_realname,\r\n{ "Real name", "lwres.adn.realname", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"lwres adn realname", HFILL }},\r\n{ &hf_adn_aliasname,\r\n{ "Alias name", "lwres.adn.aliasname", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"lwres adn aliasname", HFILL }},\r\n{ &hf_adn_family,\r\n{ "Address family", "lwres.adn.addr.family", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lwres adn addr family", HFILL }},\r\n{ &hf_adn_addr_len,\r\n{ "Address length", "lwres.adn.addr.length", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"lwres adn addr length", HFILL }},\r\n{ &hf_adn_addr_addr,\r\n{ "IP Address", "lwres.adn.addr.addr", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"lwres adn addr addr", HFILL }},\r\n{ &hf_ns_dname,\r\n{ "Name" , "lwres.ns.dname", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_lwres,\r\n&ett_rdata_req,\r\n&ett_rdata_resp,\r\n&ett_a_rec,\r\n&ett_a_rec_addr,\r\n&ett_srv_rec,\r\n&ett_srv_rec_item,\r\n&ett_adn_request,\r\n&ett_adn_resp,\r\n&ett_adn_alias,\r\n&ett_adn_addr,\r\n&ett_nba_request,\r\n&ett_nba_resp,\r\n&ett_mx_rec,\r\n&ett_mx_rec_item,\r\n&ett_ns_rec,\r\n&ett_ns_rec_item,\r\n&ett_noop,\r\n};\r\nmodule_t *lwres_module;\r\nproto_lwres = proto_register_protocol("Light Weight DNS RESolver (BIND9)",\r\n"LWRES", "lwres");\r\nproto_register_field_array(proto_lwres, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nlwres_module = prefs_register_protocol(proto_lwres, proto_reg_handoff_lwres);\r\nprefs_register_uint_preference(lwres_module, "udp.lwres_port",\r\n"lwres listener UDP Port",\r\n"Set the UDP port for lwres daemon"\r\n"(if other than the default of 921)",\r\n10, &global_lwres_port);\r\n}\r\nvoid\r\nproto_reg_handoff_lwres(void)\r\n{\r\nstatic gboolean lwres_prefs_initialized = FALSE;\r\nstatic dissector_handle_t lwres_handle;\r\nstatic guint lwres_port;\r\nif(!lwres_prefs_initialized) {\r\nlwres_handle = create_dissector_handle(dissect_lwres, proto_lwres);\r\nlwres_prefs_initialized = TRUE;\r\n}\r\nelse {\r\ndissector_delete_uint("udp.port", lwres_port, lwres_handle);\r\n}\r\ndissector_add_uint("udp.port", global_lwres_port, lwres_handle);\r\nlwres_port = global_lwres_port;\r\n}

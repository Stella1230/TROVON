UCHAR *\r\nAES_unwrap(UCHAR *kek, UINT16 key_len, UCHAR *cipher_text, UINT16 cipher_len)\r\n{\r\nUCHAR *output;\r\nUCHAR a[8], b[16];\r\nUCHAR *r;\r\ngint16 i, j, n;\r\nrijndael_ctx ctx;\r\nif (kek == NULL || cipher_len < 16 || cipher_text == NULL) {\r\nreturn NULL;\r\n}\r\noutput = (guint8 *) g_malloc0(cipher_len);\r\nn = (cipher_len/8)-1;\r\nmemcpy(a, cipher_text, 8);\r\nr = output;\r\nmemcpy(r, cipher_text+8, cipher_len - 8);\r\nfor (j=5; j >= 0; --j){\r\nr = output + (n - 1) * 8;\r\nfor (i = n; i >= 1; --i){\r\nUINT16 t = (n*j) + i;\r\nmemcpy(b, a, 8);\r\nb[7] ^= t;\r\nmemcpy(b+8, r, 8);\r\nrijndael_set_key(&ctx, kek, key_len*8 );\r\nrijndael_decrypt(&ctx, b, b);\r\nmemcpy(a,b,8);\r\nmemcpy(r, b+8, 8);\r\nr -= 8;\r\n}\r\n}\r\nreturn output;\r\n}

static int\r\ndissect_dec_bpdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 bpdu_type;\r\nproto_tree *bpdu_tree;\r\nproto_item *ti;\r\nstatic const int * bpdu_flags[] = {\r\n&hf_dec_bpdu_flags_short_timers,\r\n&hf_dec_bpdu_flags_tcack,\r\n&hf_dec_bpdu_flags_tc,\r\nNULL\r\n};\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "DEC_STP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nbpdu_type = tvb_get_guint8(tvb, BPDU_TYPE);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(bpdu_type, bpdu_type_vals,\r\n"Unknown BPDU type (%u)"));\r\nset_actual_length(tvb, DEC_BPDU_SIZE);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_dec_bpdu, tvb, 0, DEC_BPDU_SIZE,\r\nENC_NA);\r\nbpdu_tree = proto_item_add_subtree(ti, ett_dec_bpdu);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_proto_id, tvb,\r\nBPDU_DEC_CODE, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(bpdu_tree, hf_dec_bpdu_type, tvb,\r\nBPDU_TYPE, 1, bpdu_type);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_version_id, tvb,\r\nBPDU_VERSION, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_bitmask_with_flags(bpdu_tree, tvb, BPDU_FLAGS, hf_dec_bpdu_flags, ett_dec_bpdu_flags, bpdu_flags, ENC_NA, BMT_NO_FALSE|BMT_NO_TFS);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_root_pri, tvb,\r\nBPDU_ROOT_PRI, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_root_mac, tvb,\r\nBPDU_ROOT_MAC, 6, ENC_NA);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_root_cost, tvb,\r\nBPDU_ROOT_PATH_COST, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_bridge_pri, tvb,\r\nBPDU_BRIDGE_PRI, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_bridge_mac, tvb,\r\nBPDU_BRIDGE_MAC, 6, ENC_NA);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_port_id, tvb,\r\nBPDU_PORT_IDENTIFIER, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_msg_age, tvb,\r\nBPDU_MESSAGE_AGE, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_hello_time, tvb,\r\nBPDU_HELLO_TIME, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_max_age, tvb,\r\nBPDU_MAX_AGE, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bpdu_tree, hf_dec_bpdu_forward_delay, tvb,\r\nBPDU_FORWARD_DELAY, 1, ENC_BIG_ENDIAN);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_dec_bpdu(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dec_bpdu_proto_id,\r\n{ "Protocol Identifier", "dec_stp.protocol",\r\nFT_UINT8, BASE_HEX, VALS(protocol_id_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_type,\r\n{ "BPDU Type", "dec_stp.type",\r\nFT_UINT8, BASE_DEC, VALS(bpdu_type_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_version_id,\r\n{ "BPDU Version", "dec_stp.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_flags,\r\n{ "BPDU flags", "dec_stp.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_flags_short_timers,\r\n{ "Use short timers", "dec_stp.flags.short_timers",\r\nFT_BOOLEAN, 8, TFS(&tfs_yes_no), BPDU_FLAGS_SHORT_TIMERS,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_flags_tcack,\r\n{ "Topology Change Acknowledgment", "dec_stp.flags.tcack",\r\nFT_BOOLEAN, 8, TFS(&tfs_yes_no), BPDU_FLAGS_TCACK,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_flags_tc,\r\n{ "Topology Change", "dec_stp.flags.tc",\r\nFT_BOOLEAN, 8, TFS(&tfs_yes_no), BPDU_FLAGS_TC,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_root_pri,\r\n{ "Root Priority", "dec_stp.root.pri",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_root_mac,\r\n{ "Root MAC", "dec_stp.root.mac",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_root_cost,\r\n{ "Root Path Cost", "dec_stp.root.cost",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_bridge_pri,\r\n{ "Bridge Priority", "dec_stp.bridge.pri",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_bridge_mac,\r\n{ "Bridge MAC", "dec_stp.bridge.mac",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_port_id,\r\n{ "Port identifier", "dec_stp.port",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_msg_age,\r\n{ "Message Age", "dec_stp.msg_age",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_hello_time,\r\n{ "Hello Time", "dec_stp.hello",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_max_age,\r\n{ "Max Age", "dec_stp.max_age",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dec_bpdu_forward_delay,\r\n{ "Forward Delay", "dec_stp.forward",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dec_bpdu,\r\n&ett_dec_bpdu_flags,\r\n};\r\nproto_dec_bpdu = proto_register_protocol("DEC Spanning Tree Protocol",\r\n"DEC_STP", "dec_stp");\r\nproto_register_field_array(proto_dec_bpdu, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_dec_bpdu(void)\r\n{\r\ndissector_handle_t dec_bpdu_handle;\r\ndec_bpdu_handle = create_dissector_handle(dissect_dec_bpdu,\r\nproto_dec_bpdu);\r\ndissector_add_uint("ethertype", ETHERTYPE_DEC_LB, dec_bpdu_handle);\r\ndissector_add_uint("chdlc.protocol", ETHERTYPE_DEC_LB, dec_bpdu_handle);\r\ndissector_add_uint("ppp.protocol", PPP_DEC_LB, dec_bpdu_handle);\r\n}

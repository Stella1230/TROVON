static gboolean\r\nis_client(packet_info *pinfo) {\r\nif (value_is_in_range(gopher_tcp_range, pinfo->destport)) {\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nfind_dir_tokens(tvbuff_t *tvb, gint name_start, gint *sel_start, gint *host_start, gint *port_start, gint *line_len, gint *next_offset) {\r\ngint remain;\r\nif (tvb_captured_length_remaining(tvb, name_start) < MIN_DIR_LINE_LEN)\r\nreturn FALSE;\r\nif (! (sel_start && host_start && port_start && line_len && next_offset) )\r\nreturn FALSE;\r\n*line_len = tvb_find_line_end(tvb, name_start, MAX_DIR_LINE_LEN, next_offset, FALSE);\r\nif (*line_len < MIN_DIR_LINE_LEN)\r\nreturn FALSE;\r\nremain = *line_len;\r\n*sel_start = tvb_find_guint8(tvb, name_start, remain, '\t') + 1;\r\nif (*sel_start < name_start + 1)\r\nreturn FALSE;\r\nremain -= *sel_start - name_start;\r\n*host_start = tvb_find_guint8(tvb, *sel_start, remain, '\t') + 1;\r\nif (*host_start < *sel_start + 1)\r\nreturn FALSE;\r\nremain -= *host_start - *sel_start;\r\n*port_start = tvb_find_guint8(tvb, *host_start, remain, '\t') + 1;\r\nif (*port_start < *host_start + 1)\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_gopher(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_) {\r\nproto_item *ti;\r\nproto_tree *gopher_tree, *dir_tree = NULL;\r\ngboolean client = is_client(pinfo);\r\ngint line_len;\r\nconst gchar *request = "[Invalid request]";\r\ngboolean is_dir = FALSE;\r\ngint offset = 0, next_offset;\r\ngint sel_start, host_start, port_start;\r\ngchar *name;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Gopher");\r\nif (client) {\r\nline_len = tvb_find_line_end(tvb, 0, -1, NULL, FALSE);\r\nif (line_len == 0) {\r\nrequest = "[Directory list]";\r\n} else if (line_len > 0) {\r\nrequest = tvb_get_string_enc(wmem_packet_scope(), tvb, 0, line_len, ENC_ASCII);\r\n}\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Request: %s", request);\r\n} else {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Response");\r\n}\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_gopher, tvb, 0, -1, ENC_NA);\r\ngopher_tree = proto_item_add_subtree(ti, ett_gopher);\r\nif (client) {\r\nproto_item_append_text(ti, " request: %s", request);\r\nproto_tree_add_string(gopher_tree, hf_gopher_request, tvb,\r\n0, -1, request);\r\n} else {\r\nproto_item_append_text(ti, " response: ");\r\nwhile (find_dir_tokens(tvb, offset + 1, &sel_start, &host_start, &port_start, &line_len, &next_offset)) {\r\nif (!is_dir) {\r\nproto_item_append_text(ti, "[Directory list]");\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": [Directory list]");\r\n}\r\nname = tvb_get_string_enc(wmem_packet_scope(), tvb, offset + 1, sel_start - offset - 2, ENC_ASCII);\r\nti = proto_tree_add_string(gopher_tree, hf_gopher_dir_item, tvb,\r\noffset, line_len + 1, name);\r\ndir_tree = proto_item_add_subtree(ti, ett_dir_item);\r\nproto_tree_add_item(dir_tree, hf_gopher_di_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dir_tree, hf_gopher_di_name, tvb, offset + 1,\r\nsel_start - offset - 2, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(dir_tree, hf_gopher_di_selector, tvb, sel_start,\r\nhost_start - sel_start - 1, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(dir_tree, hf_gopher_di_host, tvb, host_start,\r\nport_start - host_start - 1, ENC_ASCII|ENC_NA);\r\nproto_tree_add_item(dir_tree, hf_gopher_di_port, tvb, port_start,\r\nline_len - (port_start - offset - 1), ENC_ASCII|ENC_NA);\r\nis_dir = TRUE;\r\noffset = next_offset;\r\n}\r\nif (!is_dir) {\r\nproto_item_append_text(ti, "[Unknown]");\r\nproto_tree_add_item(gopher_tree, hf_gopher_unknown, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\nrange_delete_gopher_tcp_callback(guint32 port) {\r\ndissector_delete_uint("tcp.port", port, gopher_handle);\r\n}\r\nstatic void\r\nrange_add_gopher_tcp_callback(guint32 port) {\r\ndissector_add_uint("tcp.port", port, gopher_handle);\r\n}\r\nstatic void\r\ngopher_prefs_apply(void) {\r\nrange_foreach(gopher_tcp_range, range_delete_gopher_tcp_callback);\r\ng_free(gopher_tcp_range);\r\ngopher_tcp_range = range_copy(global_gopher_tcp_range);\r\nrange_foreach(gopher_tcp_range, range_add_gopher_tcp_callback);\r\n}\r\nvoid\r\nproto_register_gopher(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_gopher_request,\r\n{ "Gopher client request", "gopher.request",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_dir_item,\r\n{ "Directory item", "gopher.directory",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_di_type,\r\n{ "Type", "gopher.directory.type",\r\nFT_UINT8, BASE_HEX, VALS(item_types), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_di_name,\r\n{ "Name", "gopher.directory.name",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_di_selector,\r\n{ "Selector", "gopher.directory.selector",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_di_host,\r\n{ "Host", "gopher.directory.host",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_di_port,\r\n{ "Port", "gopher.directory.port",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gopher_unknown,\r\n{ "Unknown Gopher transaction data", "gopher.unknown",\r\nFT_STRING, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n}\r\n};\r\nmodule_t *gopher_module;\r\nstatic gint *ett[] = {\r\n&ett_gopher,\r\n&ett_dir_item\r\n};\r\nproto_gopher = proto_register_protocol("Gopher",\r\n"Gopher", "gopher");\r\nproto_register_field_array(proto_gopher, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\ngopher_module = prefs_register_protocol(proto_gopher, gopher_prefs_apply);\r\nrange_convert_str(&global_gopher_tcp_range, TCP_DEFAULT_RANGE, 65535);\r\ngopher_tcp_range = range_empty();\r\nprefs_register_range_preference(gopher_module, "tcp.port", "TCP Ports",\r\n"TCP Ports range",\r\n&global_gopher_tcp_range, 65535);\r\n}\r\nvoid\r\nproto_reg_handoff_gopher(void)\r\n{\r\ngopher_handle = create_dissector_handle(dissect_gopher, proto_gopher);\r\ngopher_prefs_apply();\r\n}

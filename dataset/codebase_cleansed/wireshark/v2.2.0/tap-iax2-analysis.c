void\r\niax2_packet_analyse(tap_iax2_stat_t *statinfo,\r\npacket_info *pinfo,\r\nconst struct _iax2_info_t *iax2info)\r\n{\r\ndouble current_time;\r\ndouble current_jitter;\r\ndouble current_diff;\r\nstatinfo->flags = 0;\r\nif (iax2info->ftype == AST_FRAME_VOICE) {\r\nif (iax2info->csub != statinfo->pt)\r\nstatinfo->flags |= STAT_FLAG_PT_CHANGE;\r\nstatinfo->pt = iax2info->csub;\r\n}\r\ncurrent_time = nstime_to_sec(&pinfo->rel_ts);\r\ncurrent_diff = fabs (current_time - statinfo->time - (((double)iax2info->timestamp - (double)statinfo->timestamp)/1000));\r\ncurrent_jitter = statinfo->jitter + ( current_diff - statinfo->jitter)/16;\r\nstatinfo->delta = current_time - (statinfo->time);\r\nstatinfo->jitter = current_jitter;\r\nstatinfo->diff = current_diff;\r\nstatinfo->bw_history[statinfo->bw_index].bytes = iax2info->payload_len + 24;\r\nstatinfo->bw_history[statinfo->bw_index].time = current_time;\r\nwhile ((statinfo->bw_history[statinfo->bw_start_index].time+1) < current_time) {\r\nstatinfo->total_bytes -= statinfo->bw_history[statinfo->bw_start_index].bytes;\r\nstatinfo->bw_start_index++;\r\nif (statinfo->bw_start_index == BUFF_BW) statinfo->bw_start_index = 0;\r\n};\r\nstatinfo->total_bytes += iax2info->payload_len + 24;\r\nstatinfo->bandwidth = (double)(statinfo->total_bytes*8)/1000;\r\nstatinfo->bw_index++;\r\nif (statinfo->bw_index == BUFF_BW) statinfo->bw_index = 0;\r\nif (statinfo->first_packet) {\r\nstatinfo->start_seq_nr = 0;\r\nstatinfo->start_time = current_time;\r\nstatinfo->delta = 0;\r\nstatinfo->jitter = 0;\r\nstatinfo->diff = 0;\r\nstatinfo->flags |= STAT_FLAG_FIRST;\r\nstatinfo->first_packet = FALSE;\r\n}\r\nif (!(statinfo->flags & STAT_FLAG_FIRST)\r\n&& !(statinfo->flags & STAT_FLAG_MARKER)\r\n&& !(statinfo->flags & STAT_FLAG_PT_CN)\r\n&& !(statinfo->flags & STAT_FLAG_WRONG_TIMESTAMP)\r\n&& !(statinfo->flags & STAT_FLAG_FOLLOW_PT_CN)) {\r\nif (statinfo->delta > statinfo->max_delta) {\r\nstatinfo->max_delta = statinfo->delta;\r\nstatinfo->max_nr = pinfo->num;\r\n}\r\nif (statinfo->jitter > statinfo->max_jitter) {\r\nstatinfo->max_jitter = statinfo->jitter;\r\n}\r\nstatinfo->mean_jitter = (statinfo->mean_jitter*statinfo->total_nr + current_diff) / (statinfo->total_nr+1);\r\n}\r\nif (!(statinfo->flags & STAT_FLAG_FIRST)\r\n&& !(statinfo->flags & STAT_FLAG_PT_CN)) {\r\nif ((statinfo->pt != statinfo->reg_pt)\r\n&& (statinfo->reg_pt != PT_UNDEFINED)) {\r\nstatinfo->flags |= STAT_FLAG_REG_PT_CHANGE;\r\n}\r\n}\r\nif (!(statinfo->flags & STAT_FLAG_PT_CN)) {\r\nstatinfo->reg_pt = statinfo->pt;\r\n}\r\nstatinfo->time = current_time;\r\nstatinfo->timestamp = iax2info->timestamp;\r\nstatinfo->stop_seq_nr = 0;\r\nstatinfo->total_nr++;\r\nreturn;\r\n}

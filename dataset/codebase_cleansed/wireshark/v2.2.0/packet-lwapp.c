static void\r\ndissect_control(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree)\r\n{\r\nCNTL_Header header;\r\nproto_tree *control_tree;\r\ntvbuff_t *next_tvb;\r\nproto_item *ti;\r\ngint offset=0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LWAPP");\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\n"CNTL ");\r\ntvb_memcpy(tvb, (guint8*) &header, offset, sizeof(header));\r\nheader.length = g_ntohs(header.length);\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_ext(header.type, &control_msg_vals_ext, "Bad Type: 0x%02x"));\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_lwapp_control, tvb, offset,\r\n-1, ENC_NA);\r\ncontrol_tree = proto_item_add_subtree(ti, ett_lwapp_control);\r\nproto_tree_add_uint(control_tree, hf_lwapp_control_type,\r\ntvb, offset, 1, header.type);\r\noffset++;\r\nproto_tree_add_uint(control_tree, hf_lwapp_control_seq_no,\r\ntvb, offset, 1, header.seqNo);\r\noffset++;\r\nproto_tree_add_uint(control_tree, hf_lwapp_control_length,\r\ntvb, offset, 2, header.length);\r\noffset += 2;\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\nstatic int\r\ndissect_lwapp_l3(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *lwapp_tree;\r\ngint offset = 0;\r\ntvbuff_t *next_client;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LWAPP-L3");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "802.3 Packets over Layer 3");\r\nti = proto_tree_add_item(tree, proto_lwapp_l3, tvb, offset,\r\n-1, ENC_NA);\r\nlwapp_tree = proto_item_add_subtree(ti, ett_lwapp_l3);\r\nnext_client = tvb_new_subset_remaining(tvb, 0);\r\ncall_dissector(eth_withoutfcs_handle, next_client, pinfo, lwapp_tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_lwapp(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nLWAPP_Header header;\r\nguint8 slotId;\r\nguint8 version;\r\nproto_tree *lwapp_tree;\r\ntvbuff_t *next_client;\r\nguint8 dest_mac[6];\r\nguint8 have_destmac=0;\r\nstatic const int * flags[] = {\r\n&hf_lwapp_flags_type,\r\n&hf_lwapp_flags_fragment,\r\n&hf_lwapp_flags_fragment_type,\r\nNULL\r\n};\r\nproto_item *ti;\r\ngint offset=0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LWAPP");\r\ncol_set_str(pinfo->cinfo, COL_INFO,\r\n"LWAPP IP or Layer 2");\r\nif (pinfo->destport == 12223 ) {\r\ntvb_memcpy(tvb, dest_mac, offset, 6);\r\nhave_destmac = 1;\r\ntvb_memcpy(tvb, (guint8*) &header, offset + 6, sizeof(header));\r\n} else {\r\ntvb_memcpy(tvb, (guint8*) &header, offset, sizeof(header));\r\n}\r\nheader.length = g_ntohs(header.length);\r\nversion = (header.flags & 0xc0) >> 6;\r\nslotId = (header.flags & 0x38) >> 3;\r\nif ((header.flags & LWAPP_FLAGS_T) != 0)\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\n" Control Packet");\r\nelse\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\n" 802.11 Packet");\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_lwapp, tvb, offset, -1, ENC_NA);\r\nlwapp_tree = proto_item_add_subtree(ti, ett_lwapp);\r\nif (have_destmac) {\r\nproto_tree_add_ether(lwapp_tree, hf_lwapp_control_mac, tvb, offset,\r\n6, dest_mac);\r\noffset += 6;\r\n}\r\nproto_tree_add_uint(lwapp_tree, hf_lwapp_version,\r\ntvb, offset, 1, version);\r\nproto_tree_add_uint(lwapp_tree, hf_lwapp_slotid,\r\ntvb, offset, 1, slotId);\r\nproto_tree_add_bitmask(lwapp_tree, tvb, offset, hf_lwapp_flags, ett_lwapp_flags, flags, ENC_NA);\r\noffset++;\r\nproto_tree_add_uint(lwapp_tree, hf_lwapp_fragment_id,\r\ntvb, offset, 1, header.fragmentId);\r\noffset++;\r\nproto_tree_add_uint(lwapp_tree, hf_lwapp_length,\r\ntvb, offset, 2, header.length);\r\noffset += 2;\r\nproto_tree_add_uint(lwapp_tree, hf_lwapp_rssi,\r\ntvb, offset, 1, header.rssi);\r\noffset++;\r\nproto_tree_add_uint(lwapp_tree, hf_lwapp_snr,\r\ntvb, offset, 1, header.snr);\r\noffset++;\r\n}\r\nnext_client = tvb_new_subset_remaining(tvb, (have_destmac?6:0) + (int)sizeof(LWAPP_Header));\r\nif ((header.flags & LWAPP_FLAGS_T) == 0) {\r\ncall_dissector(swap_frame_control ? wlan_bsfc_handle : wlan_handle,\r\nnext_client, pinfo, tree);\r\n} else {\r\ndissect_control(next_client, pinfo, tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_lwapp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_lwapp_version,\r\n{ "Version", "lwapp.version", FT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_lwapp_slotid,\r\n{ "slotId","lwapp.slotId", FT_UINT24, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_lwapp_flags,\r\n{ "Flags", "lwapp.flags", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_lwapp_flags_type,\r\n{ "Type", "lwapp.flags.type", FT_BOOLEAN, 8,\r\nTFS(&lwapp_flags_type), LWAPP_FLAGS_T, NULL, HFILL }},\r\n{ &hf_lwapp_flags_fragment,\r\n{ "Fragment", "lwapp.flags.fragment", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), LWAPP_FLAGS_F,\r\nNULL, HFILL }},\r\n{ &hf_lwapp_flags_fragment_type,\r\n{ "Fragment Type", "lwapp.flags.fragmentType", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), LWAPP_FLAGS_FT,\r\nNULL, HFILL }},\r\n{ &hf_lwapp_fragment_id,\r\n{ "Fragment Id","lwapp.fragmentId", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_lwapp_length,\r\n{ "Length","lwapp.Length", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_lwapp_rssi,\r\n{ "RSSI","lwapp.rssi", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_lwapp_snr,\r\n{ "SNR","lwapp.snr", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n#if 0\r\n{ &hf_lwapp_control,\r\n{ "Control Data (not dissected yet)","lwapp.control", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n#endif\r\n{ &hf_lwapp_control_mac,\r\n{ "AP Identity", "lwapp.apid", FT_ETHER, BASE_NONE, NULL, 0x0,\r\n"Access Point Identity", HFILL }},\r\n{ &hf_lwapp_control_type,\r\n{ "Control Type", "lwapp.control.type", FT_UINT8, BASE_DEC|BASE_EXT_STRING, &control_msg_vals_ext, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_lwapp_control_seq_no,\r\n{ "Control Sequence Number", "lwapp.control.seqno", FT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }},\r\n{ &hf_lwapp_control_length,\r\n{ "Control Length","lwapp.control.length", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_lwapp_l3,\r\n&ett_lwapp,\r\n&ett_lwapp_control,\r\n&ett_lwapp_flags\r\n};\r\nmodule_t *lwapp_module;\r\nproto_lwapp = proto_register_protocol ("LWAPP Encapsulated Packet",\r\n"LWAPP", "lwapp");\r\nproto_lwapp_l3 = proto_register_protocol ("LWAPP Layer 3 Packet",\r\n"LWAPP-L3", "lwapp-l3");\r\nproto_lwapp_control = proto_register_protocol ("LWAPP Control Message",\r\n"LWAPP-CNTL", "lwapp-cntl");\r\nproto_register_field_array(proto_lwapp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nlwapp_module = prefs_register_protocol(proto_lwapp, NULL);\r\nprefs_register_bool_preference(lwapp_module,"swap_fc","Swap Frame Control",\r\n"Swap frame control bytes (needed for some APs",\r\n&swap_frame_control);\r\n}\r\nvoid\r\nproto_reg_handoff_lwapp(void)\r\n{\r\ndissector_handle_t lwapp_l3_handle;\r\ndissector_handle_t lwapp_handle;\r\neth_withoutfcs_handle = find_dissector_add_dependency("eth_withoutfcs", proto_lwapp);\r\nwlan_handle = find_dissector_add_dependency("wlan_withoutfcs", proto_lwapp);\r\nwlan_bsfc_handle = find_dissector_add_dependency("wlan_bsfc", proto_lwapp);\r\nlwapp_l3_handle = create_dissector_handle(dissect_lwapp_l3, proto_lwapp_l3);\r\nlwapp_handle = create_dissector_handle(dissect_lwapp, proto_lwapp);\r\ndissector_add_uint("udp.port", 12220, lwapp_l3_handle);\r\ndissector_add_uint("udp.port", 12222, lwapp_handle);\r\ndissector_add_uint("udp.port", 12223, lwapp_handle);\r\ndissector_add_uint("ethertype", 0x88bb, lwapp_handle);\r\ndissector_add_uint("ethertype", 0xbbbb, lwapp_handle);\r\n}

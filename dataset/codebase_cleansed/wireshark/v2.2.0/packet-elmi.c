static gint\r\ndissect_elmi_sub_info_elem(\r\ntvbuff_t *tvb, gint offset, proto_tree *tree)\r\n{\r\ngint offset_start;\r\nguint8 sub_tag, len;\r\nproto_item *tree_pi;\r\nproto_tree *sub_info_elem_tree = tree;\r\noffset_start = offset;\r\nsub_tag = tvb_get_guint8(tvb, offset);\r\nlen = tvb_get_guint8(tvb, offset + 1);\r\nsub_info_elem_tree = proto_tree_add_subtree_format(\r\ntree, tvb, offset, len + 2, ett_elmi_sub_info_elem, &tree_pi,\r\n"Sub-information element: %s", val_to_str_const(sub_tag, elmi_sub_info_elem_tag, "unknown"));\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_info_elem, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_info_elem_len, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nswitch (sub_tag) {\r\ncase SUB_TAG_UNI_ID:\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_uni_id, tvb, offset, len, ENC_ASCII|ENC_NA);\r\noffset += len;\r\nbreak;\r\ncase SUB_TAG_EVC_PRM:\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_evc_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase SUB_TAG_EVC_ID:\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_evc_id, tvb, offset, len, ENC_ASCII|ENC_NA);\r\noffset += len;\r\nbreak;\r\ncase SUB_TAG_EVC_MAP:\r\nwhile(offset < (offset_start + len + 2)) {\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_ce_vlan_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nbreak;\r\ncase SUB_TAG_BW_PRO:\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_info_color_mode_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_info_coupling_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_info_per_cos_bit, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_cir_magnitude, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_cir_multiplier, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_cbs_magnitude, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_cbs_multiplier, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_eir_magnitude, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_eir_multiplier, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_ebs_magnitude, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_ebs_multiplier, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_0, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_3, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_4, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_5, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_6, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_info_elem_tree, hf_elmi_sub_user_prio_7, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset ++;\r\nbreak;\r\ndefault:\r\noffset += len;\r\nbreak;\r\n}\r\nproto_item_set_len(tree_pi, offset-offset_start);\r\nreturn offset-offset_start;\r\n}\r\nstatic gint\r\ndissect_elmi_info_elem(\r\ntvbuff_t *tvb, gint offset, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\ngint offset_start;\r\nguint8 tag, len, ret;\r\nproto_item *tree_pi;\r\nproto_tree *info_elem_tree;\r\noffset_start = offset;\r\ntag = tvb_get_guint8(tvb, offset);\r\nif (tag==0)\r\nreturn -1;\r\ninfo_elem_tree = proto_tree_add_subtree_format(\r\ntree, tvb, offset, -1, ett_elmi_info_elem, &tree_pi,\r\n"Information element: %s", val_to_str_const(tag, elmi_info_elem_tag, "unknown"));\r\nproto_tree_add_item(info_elem_tree, hf_elmi_info_elem,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nlen = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(info_elem_tree, hf_elmi_info_elem_len,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nswitch (tag) {\r\ncase TAG_REPORT_TYPE:\r\nproto_tree_add_item(info_elem_tree, hf_elmi_report_type,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase TAG_SEQ_NUM:\r\nproto_tree_add_item(info_elem_tree, hf_elmi_snd_seq_num,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(info_elem_tree, hf_elmi_rcv_seq_num,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase TAG_DATA_INST:\r\nproto_tree_add_item(info_elem_tree, hf_elmi_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(info_elem_tree, hf_elmi_dat_inst,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nbreak;\r\ncase TAG_UNI_STATUS:\r\nproto_tree_add_item(info_elem_tree, hf_elmi_uni_status, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwhile(offset < (offset_start + len + 2)) {\r\nret = dissect_elmi_sub_info_elem(tvb, offset, info_elem_tree);\r\nif (ret<=0)\r\nbreak;\r\noffset += ret;\r\n}\r\nbreak;\r\ncase TAG_EVC_STATUS:\r\nproto_tree_add_item(info_elem_tree, hf_elmi_evc_refid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nproto_tree_add_item(info_elem_tree, hf_elmi_evc_status, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwhile(offset < (offset_start + len + 2)) {\r\nret = dissect_elmi_sub_info_elem(tvb, offset, info_elem_tree);\r\nif (ret<=0)\r\nbreak;\r\noffset += ret;\r\n}\r\nbreak;\r\ncase TAG_VLAN_EVC:\r\nproto_tree_add_item(info_elem_tree, hf_elmi_evc_refid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nproto_tree_add_item(info_elem_tree, hf_last_ie, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(info_elem_tree, hf_map_seq, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(info_elem_tree, hf_priority, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(info_elem_tree, hf_default_evc, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwhile(offset < (offset_start + len + 2)) {\r\nret = dissect_elmi_sub_info_elem(tvb, offset, info_elem_tree);\r\nif (ret<=0)\r\nbreak;\r\noffset += ret;\r\n}\r\nbreak;\r\ndefault:\r\noffset += len;\r\nbreak;\r\n}\r\nproto_item_set_len(tree_pi, offset-offset_start);\r\nreturn offset-offset_start;\r\n}\r\nstatic int\r\ndissect_elmi(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *pi;\r\nproto_tree *elmi_tree;\r\ngint offset=0;\r\nguint8 msg_type;\r\ngint ret;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "E-LMI");\r\npi = proto_tree_add_protocol_format(tree, proto_elmi,\r\ntvb, 0, tvb_captured_length(tvb),\r\n"Ethernet Local Management Interface (E-LMI)");\r\nelmi_tree = proto_item_add_subtree(pi, ett_elmi);\r\nproto_tree_add_item(elmi_tree, hf_elmi_ver, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nmsg_type = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(elmi_tree, hf_elmi_msg_type,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s",\r\nval_to_str(msg_type, elmi_msg_type, "unknown (0x%x)"));\r\noffset++;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nret = dissect_elmi_info_elem(tvb, offset, pinfo, elmi_tree);\r\nif (ret<=0)\r\nbreak;\r\noffset += ret;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_elmi(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_elmi_ver,\r\n{ "Version", "elmi.version", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_msg_type,\r\n{ "Message type", "elmi.message_type", FT_UINT8, BASE_HEX,\r\nVALS(elmi_msg_type), 0, NULL, HFILL } },\r\n{ &hf_elmi_info_elem,\r\n{ "Tag", "elmi.info_element.tag", FT_UINT8, BASE_HEX,\r\nVALS(elmi_info_elem_tag), 0, NULL, HFILL } },\r\n{ &hf_elmi_info_elem_len,\r\n{ "Length", "elmi.info_element.length", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_report_type,\r\n{ "Report type", "elmi.report_type", FT_UINT8, BASE_DEC,\r\nVALS(elmi_report_type), 0, NULL, HFILL } },\r\n{ &hf_elmi_snd_seq_num,\r\n{ "Send sequence number", "elmi.snd_seq_num", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_rcv_seq_num,\r\n{ "Receive sequence number", "elmi.rcv_seq_num", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_dat_inst,\r\n{ "Data instance", "elmi.data_instance", FT_UINT32, BASE_HEX,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_reserved,\r\n{ "Reserved", "elmi.reserved", FT_UINT8, BASE_HEX,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_uni_status,\r\n{ "CE-VLAN ID/EVC Map Type", "elmi.map_type", FT_UINT8, BASE_HEX,\r\nVALS(elmi_vlan_id_evc_map_type), 0, NULL, HFILL } },\r\n{ &hf_elmi_evc_refid,\r\n{ "EVC Reference Id", "elmi.evc.refid", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_evc_status,\r\n{ "EVC Status Type", "elmi.evc.status", FT_UINT8, BASE_HEX,\r\nVALS(elmi_evc_status_type), 0x7, NULL, HFILL } },\r\n{ &hf_last_ie,\r\n{ "Last Information Element", "elmi.map.last_ie", FT_BOOLEAN, 8,\r\nTFS(&tfs_yes_no), 0x40, NULL, HFILL } },\r\n{ &hf_map_seq,\r\n{ "CE-VLAN ID/EVC Map Sequence", "elmi.map.seq", FT_UINT8, BASE_DEC,\r\nNULL, 0x3F, NULL, HFILL } },\r\n{ &hf_priority,\r\n{ "Priority Tagged", "elmi.map.priority", FT_BOOLEAN, 8,\r\nTFS(&tfs_yes_no), 0x2, NULL, HFILL } },\r\n{ &hf_default_evc,\r\n{ "Default EVC", "elmi.map.evc", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), 0x1, NULL, HFILL } },\r\n{ &hf_elmi_sub_info_elem,\r\n{ "Sub-Info Element :" , "elmi.sub_info.tag", FT_UINT8, BASE_HEX,\r\nVALS(elmi_sub_info_elem_tag), 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_info_elem_len,\r\n{ "Sub-Info Length", "elmi.sub_info.len", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_uni_id,\r\n{ "UNI Identifier", "elmi.sub_info.uni_id", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_evc_type,\r\n{ "EVC Type", "elmi.sub_info.evc_type", FT_UINT8, BASE_DEC,\r\nVALS(elmi_evc_type), 0x7, NULL, HFILL } },\r\n{ &hf_elmi_evc_id,\r\n{ "EVC Identifier", "elmi.sub_info.evc_id", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_ce_vlan_id,\r\n{ "CE-VLAN ID", "elmi.sub_info.vlan_id", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_info_color_mode_flag,\r\n{ "Color Mode Flag", "elmi.sub_info.color_mode_flag", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), 0x4, NULL, HFILL } },\r\n{ &hf_elmi_sub_info_coupling_flag,\r\n{ "Coupling Flag", "elmi.sub_info.coupling_flag", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), 0x2, NULL, HFILL } },\r\n{ &hf_elmi_sub_info_per_cos_bit,\r\n{ "Per CoS bit values", "elmi.sub_info.per_cos_bit", FT_BOOLEAN, 8,\r\nTFS(&tfs_used_notused), 0x1, NULL, HFILL } },\r\n{ &hf_elmi_sub_cir_magnitude,\r\n{ "CIR Magnitude", "elmi.sub_info.cir_mag", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_cir_multiplier,\r\n{ "CIR Multiplier", "elmi.sub_info.cir_mult", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_cbs_magnitude,\r\n{ "CBS Magnitude", "elmi.sub_info.cbs_mag", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_cbs_multiplier,\r\n{ "CBS Multiplier", "elmi.sub_info.cbs_mult", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_eir_magnitude,\r\n{ "EIR Magnitude", "elmi.sub_info.eir_mag", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_eir_multiplier,\r\n{ "EIR Multiplier", "elmi.sub_info.eir_mult", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_ebs_magnitude,\r\n{ "EBS Magnitude", "elmi.sub_info.ebs_mag", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_ebs_multiplier,\r\n{ "EBS Multiplier", "elmi.sub_info.ebs_mult", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_0,\r\n{ "User Priority 0", "elmi.sub_info.bw_prio0", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x1, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_1,\r\n{ "User Priority 1", "elmi.sub_info.bw_prio1", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x2, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_2,\r\n{ "User Priority 2", "elmi.sub_info.bw_prio2", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x4, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_3,\r\n{ "User Priority 3", "elmi.sub_info.bw_prio3", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x8, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_4,\r\n{ "User Priority 4", "elmi.sub_info.bw_prio4", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x10, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_5,\r\n{ "User Priority 5", "elmi.sub_info.bw_prio5", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x20, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_6,\r\n{ "User Priority 6", "elmi.sub_info.bw_prio6", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x40, NULL, HFILL } },\r\n{ &hf_elmi_sub_user_prio_7,\r\n{ "User Priority 7", "elmi.sub_info.bw_prio7", FT_BOOLEAN, 8,\r\nTFS(&tfs_applicable_not_applicable), 0x80, NULL, HFILL } },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_elmi,\r\n&ett_elmi_info_elem,\r\n&ett_elmi_sub_info_elem\r\n};\r\nproto_elmi = proto_register_protocol(\r\n"Ethernet Local Management Interface", "E-LMI", "elmi");\r\nproto_register_field_array(proto_elmi, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_elmi(void)\r\n{\r\ndissector_handle_t elmi_handle;\r\nelmi_handle = create_dissector_handle(dissect_elmi, proto_elmi);\r\ndissector_add_uint("ethertype", ETHERTYPE_ELMI, elmi_handle);\r\n}

static int dissect_ccsrl(tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree, void* data _U_)\r\n{\r\nproto_item *ccsrl_item;\r\nproto_tree *ccsrl_tree=NULL;\r\nguint8 lastseg = tvb_get_guint8(tvb,0);\r\ntvbuff_t *next_tvb;\r\nif (tree) {\r\nccsrl_item = proto_tree_add_item (tree, proto_ccsrl, tvb, 0, -1, ENC_NA);\r\nccsrl_tree = proto_item_add_subtree (ccsrl_item, ett_ccsrl);\r\nproto_tree_add_uint(ccsrl_tree,hf_ccsrl_ls,tvb,0,1,lastseg);\r\n}\r\nnext_tvb = tvb_new_subset_remaining(tvb, 1);\r\ncall_dissector( h245dg_handle, next_tvb, pinfo, ccsrl_tree );\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void dissect_srp_command(tvbuff_t * tvb, packet_info * pinfo, proto_tree * srp_tree)\r\n{\r\ntvbuff_t *next_tvb;\r\nguint payload_len;\r\nif( srp_tree )\r\nproto_tree_add_item(srp_tree,hf_srp_seqno,tvb,1,1,ENC_BIG_ENDIAN);\r\npayload_len = tvb_reported_length_remaining(tvb,4);\r\nnext_tvb = tvb_new_subset_length(tvb, 2, payload_len);\r\ncall_dissector(ccsrl_handle, next_tvb, pinfo, srp_tree );\r\n}\r\nstatic int dissect_srp (tvbuff_t * tvb, packet_info * pinfo, proto_tree * tree, void* data _U_)\r\n{\r\nproto_item *srp_item = NULL;\r\nproto_tree *srp_tree = NULL;\r\nproto_item *hidden_item;\r\nguint8 header = tvb_get_guint8(tvb,0);\r\nif (tree) {\r\nsrp_item = proto_tree_add_item (tree, proto_srp, tvb, 0, -1, ENC_NA);\r\nsrp_tree = proto_item_add_subtree (srp_item, ett_srp);\r\nproto_tree_add_uint(srp_tree,hf_srp_header,tvb,0,1,header);\r\n}\r\nswitch( header ) {\r\ncase SRP_SRP_COMMAND:\r\ndissect_srp_command(tvb,pinfo,srp_tree);\r\nbreak;\r\ncase SRP_SRP_RESPONSE:\r\nbreak;\r\ncase SRP_NSRP_RESPONSE:\r\nif( srp_tree )\r\nproto_tree_add_item(srp_tree,hf_srp_seqno,tvb,1,1,ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif( srp_tree ) {\r\nguint16 crc, calc_crc;\r\nguint crc_offset = tvb_reported_length(tvb)-2;\r\ncrc = tvb_get_letohs(tvb,-2);\r\ncalc_crc = crc16_ccitt_tvb(tvb,crc_offset);\r\nif( crc == calc_crc ) {\r\nproto_tree_add_uint_format_value(srp_tree, hf_srp_crc, tvb,\r\ncrc_offset, 2, crc,\r\n"0x%04x (correct)", crc);\r\n} else {\r\nhidden_item = proto_tree_add_boolean(srp_tree, hf_srp_crc_bad, tvb,\r\ncrc_offset, 2, TRUE);\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\nproto_tree_add_uint_format_value(srp_tree, hf_srp_crc, tvb,\r\ncrc_offset, 2, crc,\r\n"0x%04x (incorrect, should be 0x%04x)",\r\ncrc,\r\ncalc_crc);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_ccsrl (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ccsrl_ls,\r\n{ "Last Segment","ccsrl.ls",FT_UINT8, BASE_HEX, VALS(ccsrl_ls_vals), 0x0,\r\n"Last segment indicator", HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ccsrl,\r\n};\r\nproto_ccsrl = proto_register_protocol ("H.324/CCSRL", "CCSRL", "ccsrl");\r\nproto_register_field_array (proto_ccsrl, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\nregister_dissector("ccsrl", dissect_ccsrl, proto_ccsrl);\r\n}\r\nvoid proto_register_srp (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_srp_header,\r\n{ "Header", "srp.header", FT_UINT8, BASE_DEC, VALS(srp_frame_types), 0x0,\r\n"SRP header octet", HFILL }},\r\n{&hf_srp_seqno,\r\n{ "Sequence Number", "srp.seqno", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{&hf_srp_crc,\r\n{ "CRC", "srp.crc", FT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_srp_crc_bad,\r\n{ "Bad CRC","srp.crc_bad", FT_BOOLEAN, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_srp,\r\n};\r\nproto_srp = proto_register_protocol ("H.324/SRP", "SRP", "srp");\r\nproto_register_field_array (proto_srp, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\nregister_dissector("srp", dissect_srp, proto_srp);\r\n}\r\nvoid proto_reg_handoff_srp(void) {\r\nccsrl_handle = find_dissector_add_dependency("ccsrl", proto_srp);\r\nh245dg_handle = find_dissector_add_dependency("h245dg", proto_srp);\r\n}

static const isdn_sup_op_t *get_op(gint32 opcode) {\r\nint i;\r\nfor (i = array_length(isdn_sup_op_tab) - 1; i >= 0; i--)\r\nif (isdn_sup_op_tab[i].opcode == opcode)\r\nreturn &isdn_sup_op_tab[i];\r\nreturn NULL;\r\n}\r\nstatic const isdn_sup_err_t *get_err(gint32 errcode) {\r\nint i;\r\nfor (i = array_length(isdn_sup_err_tab) - 1; i >= 0; i--)\r\nif (isdn_sup_err_tab[i].errcode == errcode)\r\nreturn &isdn_sup_err_tab[i];\r\nreturn NULL;\r\n}\r\nstatic int\r\ndissect_isdn_sup_arg(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data) {\r\nint offset = 0;\r\nrose_ctx_t *rctx;\r\ngint32 opcode = 0;\r\nconst gchar *p;\r\nconst isdn_sup_op_t *op_ptr;\r\nproto_item *ti;\r\nproto_tree *isdn_sup_tree;\r\nif (data == NULL)\r\nreturn 0;\r\nrctx = get_rose_ctx(data);\r\nDISSECTOR_ASSERT(rctx);\r\nif (rctx->d.pdu != 1)\r\nreturn offset;\r\nif (rctx->d.code == 0) {\r\nopcode = rctx->d.code_local;\r\n} else {\r\nreturn offset;\r\n}\r\nop_ptr = get_op(opcode);\r\nif (!op_ptr)\r\nreturn offset;\r\nti = proto_tree_add_item(tree, proto_isdn_sup, tvb, offset, -1, ENC_NA);\r\nisdn_sup_tree = proto_item_add_subtree(ti, ett_isdn_sup);\r\nproto_tree_add_uint(isdn_sup_tree, hf_isdn_sup_operation, tvb, 0, 0, opcode);\r\np = try_val_to_str(opcode, VALS(isdn_sup_str_operation));\r\nif (p) {\r\nproto_item_append_text(ti, ": %s", p);\r\nproto_item_append_text(rctx->d.code_item, " - %s", p);\r\nif (rctx->apdu_depth >= 0)\r\nproto_item_append_text(proto_item_get_parent_nth(proto_tree_get_parent(tree), rctx->apdu_depth), " %s", p);\r\n}\r\nif (op_ptr->arg_pdu)\r\noffset = op_ptr->arg_pdu(tvb, pinfo, isdn_sup_tree, NULL);\r\nelse\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(tree, pinfo, &ei_isdn_sup_unsupported_error_type, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_isdn_sup_res(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data) {\r\ngint offset = 0;\r\nrose_ctx_t *rctx;\r\ngint32 opcode = 0;\r\nconst gchar *p;\r\nconst isdn_sup_op_t *op_ptr;\r\nproto_item *ti;\r\nproto_tree *isdn_sup_tree;\r\nif (data == NULL)\r\nreturn 0;\r\nrctx = get_rose_ctx(data);\r\nDISSECTOR_ASSERT(rctx);\r\nif (rctx->d.pdu != 2)\r\nreturn offset;\r\nif (rctx->d.code != 0)\r\nreturn offset;\r\nopcode = rctx->d.code_local;\r\nop_ptr = get_op(opcode);\r\nif (!op_ptr)\r\nreturn offset;\r\nti = proto_tree_add_item(tree, proto_isdn_sup, tvb, offset, -1, ENC_NA);\r\nisdn_sup_tree = proto_item_add_subtree(ti, ett_isdn_sup);\r\nproto_tree_add_uint(isdn_sup_tree, hf_isdn_sup_operation, tvb, 0, 0, opcode);\r\np = try_val_to_str(opcode, VALS(isdn_sup_str_operation));\r\nif (p) {\r\nproto_item_append_text(ti, ": %s", p);\r\nproto_item_append_text(rctx->d.code_item, " - %s", p);\r\nif (rctx->apdu_depth >= 0)\r\nproto_item_append_text(proto_item_get_parent_nth(proto_tree_get_parent(tree), rctx->apdu_depth), " %s", p);\r\n}\r\nif (op_ptr->res_pdu)\r\noffset = op_ptr->res_pdu(tvb, pinfo, isdn_sup_tree, NULL);\r\nelse\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(tree, pinfo, &ei_isdn_sup_unsupported_result_type, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_isdn_sup_err(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data) {\r\nint offset = 0;\r\nrose_ctx_t *rctx;\r\ngint32 errcode;\r\nconst isdn_sup_err_t *err_ptr;\r\nconst gchar *p;\r\nproto_item *ti;\r\nproto_tree *isdn_sup_tree;\r\nif (data == NULL)\r\nreturn 0;\r\nrctx = get_rose_ctx(data);\r\nDISSECTOR_ASSERT(rctx);\r\nif (rctx->d.pdu != 3)\r\nreturn offset;\r\nif (rctx->d.code != 0)\r\nreturn offset;\r\nerrcode = rctx->d.code_local;\r\nerr_ptr = get_err(errcode);\r\nif (!err_ptr)\r\nreturn offset;\r\nti = proto_tree_add_item(tree, proto_isdn_sup, tvb, offset, -1, ENC_NA);\r\nisdn_sup_tree = proto_item_add_subtree(ti, ett_isdn_sup);\r\nproto_tree_add_uint(isdn_sup_tree, hf_isdn_sup_error, tvb, 0, 0, errcode);\r\np = try_val_to_str(errcode, VALS(isdn_sup_str_error));\r\nif (p) {\r\nproto_item_append_text(ti, ": %s", p);\r\nproto_item_append_text(rctx->d.code_item, " - %s", p);\r\nif (rctx->apdu_depth >= 0)\r\nproto_item_append_text(proto_item_get_parent_nth(proto_tree_get_parent(tree), rctx->apdu_depth), " %s", p);\r\n}\r\nif (err_ptr->err_pdu)\r\noffset = err_ptr->err_pdu(tvb, pinfo, isdn_sup_tree, NULL);\r\nelse\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(tree, pinfo, &ei_isdn_sup_unsupported_error_type, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nvoid proto_reg_handoff_isdn_sup(void) {\r\nint i;\r\n#if 0\r\ndissector_handle_t q931_handle;\r\n#endif\r\ndissector_handle_t isdn_sup_arg_handle;\r\ndissector_handle_t isdn_sup_res_handle;\r\ndissector_handle_t isdn_sup_err_handle;\r\n#if 0\r\nq931_handle = find_dissector("q931");\r\n#endif\r\nisdn_sup_arg_handle = create_dissector_handle(dissect_isdn_sup_arg, proto_isdn_sup);\r\nisdn_sup_res_handle = create_dissector_handle(dissect_isdn_sup_res, proto_isdn_sup);\r\nfor (i=0; i<(int)array_length(isdn_sup_op_tab); i++) {\r\ndissector_add_uint("q932.ros.etsi.local.arg", isdn_sup_op_tab[i].opcode, isdn_sup_arg_handle);\r\ndissector_add_uint("q932.ros.etsi.local.res", isdn_sup_op_tab[i].opcode, isdn_sup_res_handle);\r\n}\r\nfor (i=0; i<(int)array_length(isdn_sup_global_op_tab); i++) {\r\nif(isdn_sup_global_op_tab->arg_pdu)\r\ndissector_add_string("q932.ros.global.arg", isdn_sup_global_op_tab[i].oid, create_dissector_handle(isdn_sup_global_op_tab[i].arg_pdu, proto_isdn_sup));\r\nif(isdn_sup_global_op_tab->res_pdu)\r\ndissector_add_string("q932.ros.global.res", isdn_sup_global_op_tab[i].oid, create_dissector_handle(isdn_sup_global_op_tab[i].res_pdu, proto_isdn_sup));\r\n}\r\nisdn_sup_err_handle = create_dissector_handle(dissect_isdn_sup_err, proto_isdn_sup);\r\nfor (i=0; i<(int)array_length(isdn_sup_err_tab); i++) {\r\ndissector_add_uint("q932.ros.etsi.local.err", isdn_sup_err_tab[i].errcode, isdn_sup_err_handle);\r\n}\r\n}\r\nvoid proto_register_isdn_sup(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_isdn_sup,\r\n{ "isdn_sup", "isdn_sup.1",\r\nFT_INT32, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_isdn_sup_operation,\r\n{ "Operation", "isdn_sup.operation",\r\nFT_UINT8, BASE_DEC, VALS(isdn_sup_str_operation), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_isdn_sup_error,\r\n{ "Error", "isdn_sup.error",\r\nFT_UINT8, BASE_DEC, VALS(isdn_sup_str_error), 0x0,\r\nNULL, HFILL }\r\n},\r\n#include "packet-isdn-sup-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n&ett_isdn_sup,\r\n#include "packet-isdn-sup-ettarr.c"\r\n};\r\nstatic ei_register_info ei[] = {\r\n#if 0\r\n{ &ei_isdn_sup_unsupported_arg_type, { "isdn_sup.unsupported.arg_type", PI_UNDECODED, PI_WARN, "UNSUPPORTED ARGUMENT TYPE (ETSI sup)", EXPFILL }},\r\n#endif\r\n{ &ei_isdn_sup_unsupported_result_type, { "isdn_sup.unsupported.result_type", PI_UNDECODED, PI_WARN, "UNSUPPORTED RESULT TYPE (ETSI sup)", EXPFILL }},\r\n{ &ei_isdn_sup_unsupported_error_type, { "isdn_sup.unsupported.error_type", PI_UNDECODED, PI_WARN, "UNSUPPORTED ERROR TYPE (ETSI sup)", EXPFILL }},\r\n};\r\nexpert_module_t* expert_isdn_sup;\r\nproto_isdn_sup = proto_register_protocol(PNAME, PSNAME, PFNAME);\r\nproto_register_field_array(proto_isdn_sup, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_isdn_sup = expert_register_protocol(proto_isdn_sup);\r\nexpert_register_field_array(expert_isdn_sup, ei, array_length(ei));\r\n}

void\r\nregister_show_exception(void)\r\n{\r\nstatic ei_register_info ei[] = {\r\n{ &ei_malformed_dissector_bug, { "_ws.malformed.dissector_bug", PI_MALFORMED, PI_ERROR, "Dissector bug", EXPFILL }},\r\n{ &ei_malformed_reassembly, { "_ws.malformed.reassembly", PI_MALFORMED, PI_ERROR, "Reassembly error", EXPFILL }},\r\n{ &ei_malformed, { "_ws.malformed.expert", PI_MALFORMED, PI_ERROR, "Malformed Packet (Exception occurred)", EXPFILL }},\r\n};\r\nexpert_module_t* expert_malformed;\r\nproto_short = proto_register_protocol("Short Frame", "Short frame", "_ws.short");\r\nproto_malformed = proto_register_protocol("Malformed Packet",\r\n"Malformed packet", "_ws.malformed");\r\nproto_unreassembled = proto_register_protocol(\r\n"Unreassembled Fragmented Packet",\r\n"Unreassembled fragmented packet", "_ws.unreassembled");\r\nexpert_malformed = expert_register_protocol(proto_malformed);\r\nexpert_register_field_array(expert_malformed, ei, array_length(ei));\r\nproto_set_cant_toggle(proto_short);\r\nproto_set_cant_toggle(proto_malformed);\r\nproto_set_cant_toggle(proto_unreassembled);\r\n}\r\nvoid\r\nshow_exception(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nunsigned long exception, const char *exception_message)\r\n{\r\nstatic const char dissector_error_nomsg[] =\r\n"Dissector writer didn't bother saying what the error was";\r\nproto_item *item;\r\nif (exception == ReportedBoundsError && pinfo->fragmented)\r\nexception = FragmentBoundsError;\r\nswitch (exception) {\r\ncase ScsiBoundsError:\r\ncol_append_str(pinfo->cinfo, COL_INFO, "[SCSI transfer limited due to allocation_length too small]");\r\nproto_tree_add_protocol_format(tree, proto_short, tvb, 0, 0,\r\n"SCSI transfer limited due to allocation_length too small: %s truncated]", pinfo->current_proto);\r\nbreak;\r\ncase BoundsError:\r\n{\r\ngboolean display_info = TRUE;\r\nmodule_t * frame_module = prefs_find_module("frame");\r\nif (frame_module != NULL)\r\n{\r\npref_t *display_pref = prefs_find_preference(frame_module, "disable_packet_size_limited_in_summary");\r\nif (display_pref)\r\n{\r\nif (*display_pref->varp.boolp)\r\ndisplay_info = FALSE;\r\n}\r\n}\r\nif (display_info)\r\ncol_append_str(pinfo->cinfo, COL_INFO, "[Packet size limited during capture]");\r\nproto_tree_add_protocol_format(tree, proto_short, tvb, 0, 0,\r\n"[Packet size limited during capture: %s truncated]", pinfo->current_proto);\r\n}\r\nbreak;\r\ncase FragmentBoundsError:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "[Unreassembled Packet%s]", pinfo->noreassembly_reason);\r\nproto_tree_add_protocol_format(tree, proto_unreassembled,\r\ntvb, 0, 0, "[Unreassembled Packet%s: %s]",\r\npinfo->noreassembly_reason, pinfo->current_proto);\r\nbreak;\r\ncase ReportedBoundsError:\r\nshow_reported_bounds_error(tvb, pinfo, tree);\r\nbreak;\r\ncase DissectorError:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n"[Dissector bug, protocol %s: %s]",\r\npinfo->current_proto,\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\nitem = proto_tree_add_protocol_format(tree, proto_malformed, tvb, 0, 0,\r\n"[Dissector bug, protocol %s: %s]",\r\npinfo->current_proto,\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\ng_warning("Dissector bug, protocol %s, in packet %u: %s",\r\npinfo->current_proto, pinfo->num,\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\nexpert_add_info_format(pinfo, item, &ei_malformed_dissector_bug, "%s",\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\nbreak;\r\ncase ReassemblyError:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n"[Reassembly error, protocol %s: %s]",\r\npinfo->current_proto,\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\nitem = proto_tree_add_protocol_format(tree, proto_malformed, tvb, 0, 0,\r\n"[Reassembly error, protocol %s: %s]",\r\npinfo->current_proto,\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\nexpert_add_info_format(pinfo, item, &ei_malformed_reassembly, "%s",\r\nexception_message == NULL ?\r\ndissector_error_nomsg : exception_message);\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\n}\r\nvoid\r\nshow_reported_bounds_error(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *item;\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\n"[Malformed Packet]");\r\nitem = proto_tree_add_protocol_format(tree, proto_malformed,\r\ntvb, 0, 0, "[Malformed Packet: %s]", pinfo->current_proto);\r\nexpert_add_info(pinfo, item, &ei_malformed);\r\n}

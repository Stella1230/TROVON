GtkWidget*\r\ncapture_prefs_show(void)\r\n{\r\nGtkWidget *main_grid;\r\nGtkWidget *if_cbxe, *if_lb, *promisc_cb, *pcap_ng_cb, *sync_cb, *auto_scroll_cb, *show_info_cb;\r\nGtkWidget *ifopts_lb, *ifopts_bt, *colopts_lb, *colopts_bt;\r\nGList *if_list, *combo_list;\r\nint err;\r\nint row = 0;\r\nconst gchar *tooltips_text;\r\ncapture_window = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 7, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(capture_window), 5);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(capture_window), main_grid, FALSE, FALSE, 0);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_set_vexpand(GTK_WIDGET(main_grid), FALSE);\r\n#endif\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 15);\r\ngtk_widget_show(main_grid);\r\nif_lb = gtk_label_new("Default interface:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_lb);\r\nif_cbxe = gtk_combo_box_text_new_with_entry();\r\nif_list = capture_interface_list(&err, NULL, main_window_update);\r\ncombo_list = build_capture_combo_list(if_list, FALSE);\r\nfree_interface_list(if_list);\r\nif (combo_list != NULL) {\r\nGList *combo_entry;\r\nfor (combo_entry = combo_list; combo_entry != NULL; combo_entry = g_list_next(combo_entry)) {\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(if_cbxe), (const gchar *)combo_entry->data);\r\n}\r\n}\r\nif (prefs.capture_device) {\r\ngtk_entry_set_text(GTK_ENTRY(gtk_bin_get_child(GTK_BIN(if_cbxe))),\r\nprefs.capture_device);\r\n}\r\nelse if (combo_list != NULL) {\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(if_cbxe), 0);\r\n}\r\nfree_capture_combo_list(combo_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_cbxe, 1, row, 1, 1);\r\ntooltips_text = "The default interface to be captured from.";\r\ngtk_widget_set_tooltip_text(if_lb, tooltips_text);\r\ngtk_widget_set_tooltip_text(gtk_bin_get_child(GTK_BIN(if_cbxe)), tooltips_text);\r\ngtk_widget_show(if_cbxe);\r\ng_object_set_data(G_OBJECT(capture_window), DEVICE_KEY, if_cbxe);\r\nrow++;\r\nifopts_lb = gtk_label_new("Interfaces:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), ifopts_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(ifopts_lb), 1.0f, 0.5f);\r\ngtk_widget_show(ifopts_lb);\r\nifopts_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_EDIT);\r\ntooltips_text = "Open a dialog box to set various interface options.";\r\ngtk_widget_set_tooltip_text(ifopts_lb, tooltips_text);\r\ngtk_widget_set_tooltip_text(ifopts_bt, tooltips_text);\r\ng_signal_connect(ifopts_bt, "clicked", G_CALLBACK(ifopts_edit_cb), NULL);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), ifopts_bt, 1, row, 1, 1);\r\nrow++;\r\npromisc_cb = create_preference_check_button(main_grid, row++,\r\n"Capture packets in promiscuous mode on all network cards:",\r\n"To set this mode on a per interface basis, select the interface first."\r\n"Usually a network card will only capture the traffic sent to its own network address. "\r\n"If you want to capture all traffic that the network card can \"see\", mark this option. "\r\n"See the FAQ for some more details of capturing packets from a switched network. ",\r\nprefs.capture_prom_mode);\r\ng_signal_connect(promisc_cb, "toggled", G_CALLBACK(prom_mode_cb), NULL);\r\ng_object_set_data(G_OBJECT(capture_window), PROM_MODE_KEY, promisc_cb);\r\npcap_ng_cb = create_preference_check_button(main_grid, row++,\r\n"Capture packets in pcap-ng format:",\r\n"Capture packets in the next-generation capture file format.",\r\nprefs.capture_pcap_ng);\r\ng_object_set_data(G_OBJECT(capture_window), PCAP_NG_KEY, pcap_ng_cb);\r\nsync_cb = create_preference_check_button(main_grid, row++,\r\n"Update list of packets in real time:",\r\n"Update the list of packets while capture is in progress. "\r\n"This can result in dropped packets on high-speed networks.",\r\nprefs.capture_real_time);\r\ng_object_set_data(G_OBJECT(capture_window), CAPTURE_REAL_TIME_KEY, sync_cb);\r\nauto_scroll_cb = create_preference_check_button(main_grid, row++,\r\n"Automatic scrolling in live capture:",\r\n"Keep the packet list scrolled to the bottom while capturing.",\r\nprefs.capture_auto_scroll);\r\ng_object_set_data(G_OBJECT(capture_window), AUTO_SCROLL_KEY, auto_scroll_cb);\r\nshow_info_cb = create_preference_check_button(main_grid, row++,\r\n"Hide capture info dialog:",\r\n"Hide the capture info dialog while capturing. ",\r\n!prefs.capture_show_info);\r\ng_object_set_data(G_OBJECT(capture_window), SHOW_INFO_KEY, show_info_cb);\r\ncolopts_lb = gtk_label_new("Columns:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), colopts_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(colopts_lb), 1.0f, 0.5f);\r\ngtk_widget_show(colopts_lb);\r\ncolopts_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_EDIT);\r\ntooltips_text = "Open a dialog box to change the visible columns.";\r\ngtk_widget_set_tooltip_text(colopts_lb, tooltips_text);\r\ngtk_widget_set_tooltip_text(colopts_bt, tooltips_text);\r\ng_signal_connect(colopts_bt, "clicked", G_CALLBACK(colopts_edit_cb), NULL);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), colopts_bt, 1, row, 1, 1);\r\nrow++;\r\ngtk_widget_show_all(capture_window);\r\nreturn(capture_window);\r\n}\r\nvoid\r\ncapture_prefs_fetch(GtkWidget *w)\r\n{\r\nGtkWidget *if_cbxe, *promisc_cb, *pcap_ng_cb, *sync_cb, *auto_scroll_cb, *show_info_cb;\r\ngchar *if_text;\r\nif_cbxe = (GtkWidget *)g_object_get_data(G_OBJECT(w), DEVICE_KEY);\r\npromisc_cb = (GtkWidget *)g_object_get_data(G_OBJECT(w), PROM_MODE_KEY);\r\npcap_ng_cb = (GtkWidget *)g_object_get_data(G_OBJECT(w), PCAP_NG_KEY);\r\nsync_cb = (GtkWidget *)g_object_get_data(G_OBJECT(w), CAPTURE_REAL_TIME_KEY);\r\nauto_scroll_cb = (GtkWidget *)g_object_get_data(G_OBJECT(w), AUTO_SCROLL_KEY);\r\nshow_info_cb = (GtkWidget *)g_object_get_data(G_OBJECT(w), SHOW_INFO_KEY);\r\nif (prefs.capture_device != NULL) {\r\ng_free(prefs.capture_device);\r\nprefs.capture_device = NULL;\r\n}\r\nif_text = g_strdup(gtk_entry_get_text(GTK_ENTRY(gtk_bin_get_child(GTK_BIN(if_cbxe)))));\r\ng_strstrip(if_text);\r\nif (*if_text == '\0') {\r\ng_free(if_text);\r\nif_text = NULL;\r\n}\r\nif (if_text == NULL)\r\nif_text = g_strdup("");\r\nprefs.capture_device = if_text;\r\nprefs.capture_prom_mode = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(promisc_cb));\r\nprefs.capture_pcap_ng = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(pcap_ng_cb));\r\nprefs.capture_real_time = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(sync_cb));\r\nprefs.capture_auto_scroll = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(auto_scroll_cb));\r\nprefs.capture_show_info = !(gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(show_info_cb)));\r\n}\r\nvoid\r\ncapture_prefs_apply(GtkWidget *w _U_)\r\n{\r\n}\r\nvoid\r\ncapture_prefs_destroy(GtkWidget *w)\r\n{\r\nGtkWidget *caller = gtk_widget_get_toplevel(w);\r\nGtkWidget *dlg;\r\ndlg = (GtkWidget *)g_object_get_data(G_OBJECT(caller), IFOPTS_DIALOG_PTR_KEY);\r\nif (dlg != NULL) {\r\nwindow_destroy(dlg);\r\n}\r\ndlg = (GtkWidget *)g_object_get_data(G_OBJECT(caller), COLOPTS_DIALOG_PTR_KEY);\r\nif (dlg != NULL) {\r\nwindow_destroy(dlg);\r\n}\r\n}\r\nstatic void\r\ncolopts_edit_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *colopts_edit_dlg, *main_hb, *main_grid,\r\n*ed_opts_fr, *main_vb,\r\n*bbox, *ok_bt, *cancel_bt, *help_bt, *column_lb,\r\n*col_link_lb,\r\n#ifdef HAVE_PCAP_CREATE\r\n*col_monitor_lb,\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\n*col_buf_lb,\r\n#endif\r\n*col_filter_lb, *col_pmode_lb,\r\n*col_snap_lb;\r\nint row = 0;\r\nGtkWidget *caller = gtk_widget_get_toplevel(w);\r\ncolopts_edit_dlg = (GtkWidget *)g_object_get_data(G_OBJECT(caller), COLOPTS_DIALOG_PTR_KEY);\r\nif (colopts_edit_dlg != NULL) {\r\nreactivate_window(colopts_edit_dlg);\r\nreturn;\r\n}\r\ncolopts_edit_dlg = dlg_conf_window_new("Wireshark: Preferences: Capture Options Columns");\r\ngtk_window_set_default_size(GTK_WINDOW(colopts_edit_dlg), 300, 200);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(colopts_edit_dlg), main_vb);\r\ngtk_widget_show(main_vb);\r\ned_opts_fr = gtk_frame_new("Columns");\r\ngtk_box_pack_start(GTK_BOX(main_vb), ed_opts_fr, FALSE, FALSE, 0);\r\ngtk_widget_show(ed_opts_fr);\r\nmain_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5, TRUE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_hb), 3);\r\ngtk_container_add(GTK_CONTAINER(ed_opts_fr), main_hb);\r\ngtk_widget_show(main_hb);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_hb), main_grid, TRUE, FALSE, 10);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 10);\r\ngtk_widget_show(main_grid);\r\ncolumn_lb = gtk_label_new("Select the columns to be displayed");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), column_lb, 0, row, 2, 1);\r\ngtk_misc_set_alignment(GTK_MISC(column_lb), 0, 0.5f);\r\ngtk_widget_show(column_lb);\r\nrow++;\r\ncol_link_cb = gtk_check_button_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_link_cb, 0, row, 1, 1);\r\nif (!prefs.capture_columns || prefs_capture_options_dialog_column_is_visible("LINK"))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_link_cb), TRUE);\r\nelse\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_link_cb), FALSE);\r\ngtk_widget_show(col_link_cb);\r\ncol_link_lb = gtk_label_new("Link layer header");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_link_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(col_link_lb), 0, 0.5f);\r\ngtk_widget_show(col_link_lb);\r\nrow++;\r\ncol_pmode_cb = gtk_check_button_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_pmode_cb, 0, row, 1, 1);\r\nif (!prefs.capture_columns || prefs_capture_options_dialog_column_is_visible("PMODE"))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_pmode_cb), TRUE);\r\nelse\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_pmode_cb), FALSE);\r\ngtk_widget_show(col_pmode_cb);\r\ncol_pmode_lb = gtk_label_new("Promiscuous Mode");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_pmode_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(col_pmode_lb), 0, 0.5f);\r\ngtk_widget_show(col_pmode_lb);\r\nrow++;\r\ncol_snap_cb = gtk_check_button_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_snap_cb, 0, row, 1, 1);\r\nif (!prefs.capture_columns || prefs_capture_options_dialog_column_is_visible("SNAPLEN"))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_snap_cb), TRUE);\r\nelse\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_snap_cb), FALSE);\r\ngtk_widget_show(col_snap_cb);\r\ncol_snap_lb = gtk_label_new("Snap length in Bytes");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_snap_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(col_snap_lb), 0, 0.5f);\r\ngtk_widget_show(col_snap_lb);\r\nrow++;\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\ncol_buf_cb = gtk_check_button_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_buf_cb, 0, row, 1, 1);\r\nif (!prefs.capture_columns || prefs_capture_options_dialog_column_is_visible("BUFFER"))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_buf_cb), TRUE);\r\nelse\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_buf_cb), FALSE);\r\ngtk_widget_show(col_buf_cb);\r\ncol_buf_lb = gtk_label_new("Buffer in Megabytes");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_buf_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(col_buf_lb), 0, 0.5f);\r\ngtk_widget_show(col_buf_lb);\r\nrow++;\r\n#endif\r\n#ifdef HAVE_PCAP_CREATE\r\ncol_monitor_lb = gtk_label_new("Monitor mode");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_monitor_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(col_monitor_lb), 0, 0.5f);\r\ngtk_widget_show(col_monitor_lb);\r\ncol_monitor_cb = gtk_check_button_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_monitor_cb, 0, row, 1, 1);\r\nif (!prefs.capture_columns || prefs_capture_options_dialog_column_is_visible("MONITOR"))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_monitor_cb), TRUE);\r\nelse\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_monitor_cb), FALSE);\r\ngtk_widget_show(col_monitor_cb);\r\nrow++;\r\n#endif\r\ncol_filter_lb = gtk_label_new("Capture filter");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_filter_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(col_filter_lb), 0, 0.5f);\r\ngtk_widget_show(col_filter_lb);\r\ncol_filter_cb = gtk_check_button_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), col_filter_cb, 0, row, 1, 1);\r\nif (!prefs.capture_columns || prefs_capture_options_dialog_column_is_visible("FILTER"))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_filter_cb), TRUE);\r\nelse\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(col_filter_cb), FALSE);\r\ngtk_widget_show(col_filter_cb);\r\nrow++;\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ngtk_widget_set_tooltip_text(ok_bt, "Save changes and exit dialog");\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(colopts_edit_ok_cb), colopts_edit_dlg);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ngtk_widget_set_tooltip_text(cancel_bt, "Cancel and exit dialog");\r\nwindow_set_cancel_button(colopts_edit_dlg, cancel_bt, window_cancel_button_cb);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb),\r\n(gpointer)HELP_CAPTURE_INTERFACE_OPTIONS_DIALOG);\r\ngtk_widget_set_tooltip_text (help_bt, "Show topic specific help");\r\ngtk_widget_grab_default(ok_bt);\r\ng_signal_connect(colopts_edit_dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(colopts_edit_dlg, "destroy", G_CALLBACK(colopts_edit_destroy_cb), NULL);\r\ng_object_set_data(G_OBJECT(colopts_edit_dlg), COLOPTS_CALLER_PTR_KEY, caller);\r\ng_object_set_data(G_OBJECT(caller), COLOPTS_DIALOG_PTR_KEY, colopts_edit_dlg);\r\ngtk_widget_show(colopts_edit_dlg);\r\nwindow_present(colopts_edit_dlg);\r\n}\r\nstatic void\r\nifopts_edit_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *ifopts_edit_dlg, *cur_scr_win, *main_hb, *main_grid,\r\n*cur_opts_fr, *ed_opts_fr, *main_vb,\r\n*if_descr_lb,\r\n*if_hide_lb,\r\n*bbox, *ok_bt, *cancel_bt, *help_bt;\r\nGtkListStore *list_store;\r\nGtkWidget *list;\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeView *list_view;\r\nGtkTreeSelection *selection;\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nGtkAdjustment *buffer_size_adj;\r\n#endif\r\nGtkAdjustment *snaplen_adj;\r\nint row = 0;\r\nGtkWidget *caller = gtk_widget_get_toplevel(w);\r\nifopts_edit_dlg = (GtkWidget *)g_object_get_data(G_OBJECT(caller), IFOPTS_DIALOG_PTR_KEY);\r\nif (ifopts_edit_dlg != NULL) {\r\nreactivate_window(ifopts_edit_dlg);\r\nreturn;\r\n}\r\nifopts_edit_dlg = dlg_conf_window_new("Wireshark: Preferences: Interface Options");\r\ngtk_window_set_default_size(GTK_WINDOW(ifopts_edit_dlg), 1000, 500);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(ifopts_edit_dlg), main_vb);\r\ngtk_widget_show(main_vb);\r\ncur_opts_fr = gtk_frame_new("Interfaces");\r\ngtk_box_pack_start(GTK_BOX(main_vb), cur_opts_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(cur_opts_fr);\r\ncur_scr_win = scrolled_window_new(NULL, NULL);\r\ngtk_container_set_border_width(GTK_CONTAINER(cur_scr_win), 3);\r\ngtk_container_add(GTK_CONTAINER(cur_opts_fr), cur_scr_win);\r\ngtk_widget_show(cur_scr_win);\r\nlist_store = gtk_list_store_new(N_COLUMN,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\n#ifdef HAVE_PCAP_CREATE\r\nG_TYPE_BOOLEAN,\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nG_TYPE_INT,\r\n#endif\r\nG_TYPE_BOOLEAN,\r\nG_TYPE_INT,\r\nG_TYPE_BOOLEAN,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_BOOLEAN,\r\nG_TYPE_INT);\r\nlist = gtk_tree_view_new_with_model (GTK_TREE_MODEL (list_store));\r\nlist_view = GTK_TREE_VIEW(list);\r\ng_object_unref (G_OBJECT (list_store));\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Device", renderer,\r\n"text", DEVICE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\n#ifdef _WIN32\r\ngtk_tree_view_column_set_min_width(column, 230);\r\n#else\r\ngtk_tree_view_column_set_min_width(column, 70);\r\n#endif\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Description", renderer,\r\n"text", DESC_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 260);\r\ngtk_tree_view_append_column (list_view, column);\r\n#ifdef HAVE_PCAP_CREATE\r\nrenderer = gtk_cell_renderer_toggle_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Default to monitor mode", renderer,\r\n"active", DEF_MONITOR_MODE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, FALSE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_append_column (list_view, column);\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nrenderer = gtk_cell_renderer_spin_new ();\r\nbuffer_size_adj = (GtkAdjustment *) gtk_adjustment_new(DEFAULT_CAPTURE_BUFFER_SIZE, 1, 65535, 1.0, 10.0, 0.0);\r\ng_object_set(G_OBJECT(renderer), "adjustment", buffer_size_adj, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Default buffer size (MiB)", renderer,\r\n"text", BUF_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_append_column (list_view, column);\r\n#endif\r\nrenderer = gtk_cell_renderer_toggle_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Has snap length mode", renderer,\r\n"active", HASSNAP_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, FALSE);\r\nrenderer = gtk_cell_renderer_spin_new ();\r\nsnaplen_adj = (GtkAdjustment *) gtk_adjustment_new(WTAP_MAX_PACKET_SIZE, 1, WTAP_MAX_PACKET_SIZE, 1.0, 10.0, 0.0);\r\ng_object_set(G_OBJECT(renderer), "adjustment", snaplen_adj, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Default snap length", renderer,\r\n"text", SNAPLEN_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, FALSE);\r\nrenderer = gtk_cell_renderer_toggle_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Default to promiscuous mode", renderer,\r\n"active", PMODE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, FALSE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Default link-layer", renderer,\r\n"text", DEF_LINK_LAYER_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 230);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Comment", renderer,\r\n"text", COMMENT_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_toggle_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Hide?", renderer,\r\n"active", HIDE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, FALSE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_append_column (list_view, column);\r\n#if 0\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("DLT", renderer,\r\n"text", DLT_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 40);\r\ngtk_tree_view_append_column (list_view, column);\r\n#endif\r\nselection = gtk_tree_view_get_selection(list_view);\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_SINGLE);\r\ncur_list = list;\r\ngtk_container_add(GTK_CONTAINER(cur_scr_win), cur_list);\r\nif_selection = selection;\r\ng_signal_connect (G_OBJECT (selection), "changed",\r\nG_CALLBACK (ifopts_edit_ifsel_cb),\r\nNULL);\r\ngtk_widget_show(cur_list);\r\nifopts_if_liststore_add();\r\ned_opts_fr = gtk_frame_new("Properties");\r\ngtk_box_pack_start(GTK_BOX(main_vb), ed_opts_fr, FALSE, FALSE, 0);\r\ngtk_widget_show(ed_opts_fr);\r\nmain_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5, TRUE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_hb), 3);\r\ngtk_container_add(GTK_CONTAINER(ed_opts_fr), main_hb);\r\ngtk_widget_show(main_hb);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_hb), main_grid, TRUE, FALSE, 10);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 10);\r\ngtk_widget_show(main_grid);\r\nif_dev_lb = gtk_label_new("Device:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_dev_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_dev_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_dev_lb);\r\nif_dev_lb = gtk_label_new("");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_dev_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_dev_lb), 0.0f, 0.5f);\r\ngtk_widget_show(if_dev_lb);\r\nrow++;\r\nif_name_lb = gtk_label_new("Description:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_name_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_name_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_name_lb);\r\nif_name_lb = gtk_label_new("");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_name_lb, 1, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_name_lb), 0.0f, 0.5f);\r\ngtk_widget_show(if_name_lb);\r\nrow++;\r\n#ifdef HAVE_PCAP_CREATE\r\nif_monitor_lb = gtk_label_new("Monitor mode:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_monitor_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_monitor_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_monitor_lb);\r\nif_monitor_cb = gtk_check_button_new();\r\ng_signal_connect(if_monitor_cb, "toggled", G_CALLBACK(ifopts_edit_monitor_changed_cb),\r\ncur_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_monitor_cb, 1, row, 1, 1);\r\ngtk_widget_show(if_monitor_cb);\r\nrow++;\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nif_buffersize_lb = gtk_label_new("Default buffer size (MiB):");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_buffersize_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_buffersize_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_buffersize_lb);\r\nbuffer_size_adj = (GtkAdjustment *) gtk_adjustment_new(DEFAULT_CAPTURE_BUFFER_SIZE, 1, 65535, 1.0, 10.0, 0.0);\r\nif_buffersize_cb = gtk_spin_button_new (buffer_size_adj, 0, 0);\r\ng_signal_connect(if_buffersize_cb, "value-changed", G_CALLBACK(ifopts_edit_buffersize_changed_cb),\r\ncur_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_buffersize_cb, 1, row, 1, 1);\r\ngtk_widget_show(if_buffersize_cb);\r\nrow++;\r\n#endif\r\nif_snaplen_lb = gtk_label_new("Limit each packet to:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_snaplen_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_snaplen_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_snaplen_lb);\r\nif_snaplen_tg = gtk_check_button_new();\r\ng_signal_connect(if_snaplen_tg, "toggled", G_CALLBACK(ifopts_edit_hassnap_changed_cb),\r\ncur_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_snaplen_tg, 2, row, 1, 1);\r\ngtk_widget_show(if_snaplen_tg);\r\nsnaplen_adj = (GtkAdjustment *) gtk_adjustment_new(65535, 1, 65535, 1.0, 10.0, 0.0);\r\nif_snaplen_cb = gtk_spin_button_new (snaplen_adj, 0, 0);\r\ng_signal_connect(if_snaplen_cb, "value-changed", G_CALLBACK(ifopts_edit_snaplen_changed_cb),\r\ncur_list);\r\ngtk_spin_button_set_numeric(GTK_SPIN_BUTTON (if_snaplen_cb), TRUE);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_snaplen_cb, 1, row, 1, 1);\r\ngtk_widget_show(if_snaplen_cb);\r\nrow++;\r\nif_pmode_lb = gtk_label_new("Promiscuous mode:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_pmode_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_pmode_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_pmode_lb);\r\nif_pmode_cb = gtk_check_button_new();\r\ng_signal_connect(if_pmode_cb, "toggled", G_CALLBACK(ifopts_edit_pmode_changed_cb),\r\ncur_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_pmode_cb, 1, row, 1, 1);\r\ngtk_widget_show(if_pmode_cb);\r\nrow++;\r\nif_linktype_lb = gtk_label_new("Default link-layer header type:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_linktype_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_linktype_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_linktype_lb);\r\nif_linktype_cb = gtk_combo_box_text_new();\r\nnum_linktypes = 0;\r\ninterfaces_info_nochange = FALSE;\r\ng_signal_connect(if_linktype_cb, "changed", G_CALLBACK(ifopts_edit_linktype_changed_cb),\r\ncur_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_linktype_cb, 1, row, 1, 1);\r\ngtk_widget_show(if_linktype_cb);\r\nrow++;\r\nif_descr_lb = gtk_label_new("Comment:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_descr_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_descr_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_descr_lb);\r\nif_descr_te = gtk_entry_new();\r\ng_signal_connect(if_descr_te, "changed", G_CALLBACK(ifopts_edit_descr_changed_cb),\r\ncur_list);\r\ngtk_entry_set_max_length(GTK_ENTRY(if_descr_te), IFOPTS_MAX_DESCR_LEN);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_descr_te, 1, row, 1, 1);\r\ngtk_widget_show(if_descr_te);\r\nrow++;\r\nif_hide_lb = gtk_label_new("Hide interface?:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_hide_lb, 0, row, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_hide_lb), 1.0f, 0.5f);\r\ngtk_widget_show(if_hide_lb);\r\nif_hide_cb = gtk_check_button_new();\r\ng_signal_connect(if_hide_cb, "toggled", G_CALLBACK(ifopts_edit_hide_changed_cb),\r\ncur_list);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_hide_cb, 1, row, 1, 1);\r\ngtk_widget_show(if_hide_cb);\r\nif_default_if_lb = gtk_label_new("(Default interface cannot be hidden)");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), if_default_if_lb, 1, row, 2, 1);\r\ngtk_misc_set_alignment(GTK_MISC(if_default_if_lb), 0.15f, 0.5f);\r\nrow++;\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ngtk_widget_set_tooltip_text(ok_bt, "Save changes and exit dialog");\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(ifopts_edit_ok_cb), ifopts_edit_dlg);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ngtk_widget_set_tooltip_text(cancel_bt, "Cancel and exit dialog");\r\nwindow_set_cancel_button(ifopts_edit_dlg, cancel_bt, window_cancel_button_cb);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb),\r\n(gpointer)HELP_CAPTURE_INTERFACE_OPTIONS_DIALOG);\r\ngtk_widget_set_tooltip_text (help_bt, "Show topic specific help");\r\ngtk_widget_grab_default(ok_bt);\r\ng_signal_connect(ifopts_edit_dlg, "delete_event", G_CALLBACK(window_delete_event_cb),\r\nNULL);\r\ng_signal_connect(ifopts_edit_dlg, "destroy", G_CALLBACK(ifopts_edit_destroy_cb), NULL);\r\ng_object_set_data(G_OBJECT(ifopts_edit_dlg), IFOPTS_CALLER_PTR_KEY, caller);\r\ng_object_set_data(G_OBJECT(caller), IFOPTS_DIALOG_PTR_KEY, ifopts_edit_dlg);\r\ngtk_widget_show(ifopts_edit_dlg);\r\nwindow_present(ifopts_edit_dlg);\r\n}\r\nstatic void\r\ncolopts_edit_ok_cb(GtkWidget *w _U_, gpointer parent_w)\r\n{\r\ng_list_free(prefs.capture_columns);\r\nprefs.capture_columns = NULL;\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("INTERFACE"));\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(col_link_cb))) {\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("LINK"));\r\n}\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(col_pmode_cb))) {\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("PMODE"));\r\n}\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(col_snap_cb))) {\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("SNAPLEN"));\r\n}\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(col_buf_cb))) {\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("BUFFER"));\r\n}\r\n#endif\r\n#if defined (HAVE_PCAP_CREATE)\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(col_monitor_cb))) {\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("MONITOR"));\r\n}\r\n#endif\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(col_filter_cb))) {\r\nprefs.capture_columns = g_list_append(prefs.capture_columns, g_strdup("FILTER"));\r\n}\r\ngtk_grab_remove(GTK_WIDGET(parent_w));\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nif (capture_dlg_window_present()) {\r\nupdate_visible_tree_view_columns();\r\nupdate_visible_columns_menu ();\r\n}\r\n}\r\nstatic void\r\nifopts_edit_ok_cb(GtkWidget *w _U_, gpointer parent_w)\r\n{\r\nif (if_selection){\r\n#ifdef HAVE_PCAP_CREATE\r\nifopts_write_new_monitor_mode();\r\n#endif\r\nifopts_write_new_linklayer();\r\nifopts_write_new_descr();\r\nifopts_write_new_hide();\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nifopts_write_new_buffersize();\r\n#endif\r\nifopts_write_new_snaplen();\r\nifopts_write_new_pmode();\r\n}\r\nrefresh_local_interface_lists();\r\ngtk_grab_remove(GTK_WIDGET(parent_w));\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\ncolopts_edit_destroy_cb(GtkWidget *win, gpointer data _U_)\r\n{\r\nGtkWidget *caller;\r\ncaller = (GtkWidget *)g_object_get_data(G_OBJECT(win), COLOPTS_CALLER_PTR_KEY);\r\nif (caller != NULL) {\r\ng_object_set_data(G_OBJECT(caller), COLOPTS_DIALOG_PTR_KEY, NULL);\r\n}\r\n}\r\nstatic void\r\nifopts_edit_destroy_cb(GtkWidget *win, gpointer data _U_)\r\n{\r\nGtkWidget *caller;\r\ncaller = (GtkWidget *)g_object_get_data(G_OBJECT(win), IFOPTS_CALLER_PTR_KEY);\r\nif (caller != NULL) {\r\ng_object_set_data(G_OBJECT(caller), IFOPTS_DIALOG_PTR_KEY, NULL);\r\n}\r\n}\r\nstatic gint\r\nifopts_description_to_val (const char *if_name, gboolean monitor_mode, const char *descr)\r\n{\r\nif_capabilities_t *caps;\r\nint dlt = -1;\r\ncaps = capture_get_if_capabilities(if_name, monitor_mode, NULL, NULL, main_window_update);\r\nif (caps != NULL) {\r\nif (caps->data_link_types != NULL) {\r\nGList *lt_entry;\r\nfor (lt_entry = g_list_next(caps->data_link_types);\r\nlt_entry != NULL;\r\nlt_entry = g_list_next(lt_entry)) {\r\ndata_link_info_t *dli_p = (data_link_info_t *)lt_entry->data;\r\nif (dli_p->description) {\r\nif (strcmp(dli_p->description, descr) == 0) {\r\ndlt = dli_p->dlt;\r\nbreak;\r\n}\r\n} else {\r\nif (strcmp(dli_p->name, descr) == 0) {\r\ndlt = dli_p->dlt;\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\nfree_if_capabilities(caps);\r\n}\r\nreturn dlt;\r\n}\r\nstatic void\r\nifopts_edit_ifsel_cb(GtkTreeSelection *selection _U_,\r\ngpointer data _U_)\r\n{\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngchar *desc, *comment, *text;\r\ngchar *if_name, *linktype;\r\n#ifdef HAVE_PCAP_CREATE\r\ngboolean monitor_mode;\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\ngint buffersize;\r\n#endif\r\ngint snaplen;\r\ngboolean hide, hide_enabled = TRUE, hassnap = FALSE, pmode;\r\ngboolean pmode_pref;\r\nif_capabilities_t *caps;\r\ngint selected = 0;\r\nif (!gtk_tree_selection_get_selected (if_selection, &model, &iter)){\r\nreturn;\r\n}\r\ngtk_tree_model_get(model, &iter,\r\nDEVICE_COLUMN, &if_name,\r\nDESC_COLUMN, &desc,\r\n#ifdef HAVE_PCAP_CREATE\r\nDEF_MONITOR_MODE_COLUMN, &monitor_mode,\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nBUF_COLUMN, &buffersize,\r\n#endif\r\nHASSNAP_COLUMN, &hassnap,\r\nSNAPLEN_COLUMN, &snaplen,\r\nPMODE_COLUMN, &pmode,\r\nDEF_LINK_LAYER_COLUMN, &linktype,\r\nCOMMENT_COLUMN, &comment,\r\nHIDE_COLUMN, &hide,\r\n-1);\r\ngtk_label_set_text(GTK_LABEL(if_dev_lb), if_name);\r\ngtk_label_set_text(GTK_LABEL(if_name_lb), desc);\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\ngtk_spin_button_set_value(GTK_SPIN_BUTTON (if_buffersize_cb), buffersize);\r\n#endif\r\ngtk_spin_button_set_value(GTK_SPIN_BUTTON (if_snaplen_cb), snaplen);\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_snaplen_tg), hassnap);\r\ngtk_widget_set_sensitive(GTK_WIDGET(if_snaplen_cb), hassnap);\r\nif (prefs.capture_prom_mode) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_pmode_cb), TRUE);\r\n} else if (capture_dev_user_pmode_find(if_name, &pmode_pref)) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_pmode_cb), pmode_pref);\r\n} else {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_pmode_cb), FALSE);\r\n}\r\ninterfaces_info_nochange = TRUE;\r\nwhile (num_linktypes > 0) {\r\nnum_linktypes--;\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(if_linktype_cb), num_linktypes);\r\n}\r\n#ifdef HAVE_PCAP_CREATE\r\ncaps = capture_get_if_capabilities(if_name, monitor_mode, NULL, NULL, main_window_update);\r\n#else\r\ncaps = capture_get_if_capabilities(if_name, FALSE, NULL, NULL, main_window_update);\r\n#endif\r\nif (caps != NULL) {\r\n#ifdef HAVE_PCAP_CREATE\r\ngtk_widget_set_sensitive(if_monitor_lb, caps->can_set_rfmon);\r\ngtk_widget_set_sensitive(if_monitor_cb, caps->can_set_rfmon);\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_monitor_cb), monitor_mode);\r\n#endif\r\nif (caps->data_link_types != NULL) {\r\nGList *lt_entry;\r\nfor (lt_entry = caps->data_link_types; lt_entry != NULL;\r\nlt_entry = g_list_next(lt_entry)) {\r\ndata_link_info_t *dli_p = (data_link_info_t *)lt_entry->data;\r\ntext = (dli_p->description != NULL) ? dli_p->description : dli_p->name;\r\nif (strcmp(linktype, text) == 0) {\r\nselected = num_linktypes;\r\n}\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(if_linktype_cb), text);\r\nnum_linktypes++;\r\n}\r\ngtk_widget_set_sensitive(if_linktype_lb, num_linktypes >= 2);\r\ngtk_widget_set_sensitive(if_linktype_cb, num_linktypes >= 2);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(if_linktype_cb), selected);\r\n}\r\nfree_if_capabilities(caps);\r\n}\r\n#ifdef HAVE_PCAP_CREATE\r\nelse {\r\ngtk_widget_set_sensitive(if_monitor_lb, FALSE);\r\ngtk_widget_set_sensitive(if_monitor_cb, FALSE);\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_monitor_cb), FALSE);\r\n}\r\n#endif\r\ngtk_entry_set_text(GTK_ENTRY(if_descr_te), comment);\r\nif ((prefs.capture_device != NULL) && (*prefs.capture_device != '\0')) {\r\nguint i;\r\ninterface_t device;\r\nfor (i = 0; i < global_capture_opts.all_ifaces->len; i++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, i);\r\nif ((strcmp(device.display_name, prefs.capture_device) == 0) &&\r\n(strcmp(device.name, if_name) == 0)) {\r\nhide_enabled = FALSE;\r\nbreak;\r\n}\r\n}\r\n}\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(if_hide_cb), hide);\r\ngtk_widget_set_sensitive(if_hide_cb, hide_enabled);\r\nif (hide_enabled) {\r\ngtk_widget_hide(if_default_if_lb);\r\n} else {\r\ngtk_widget_show(if_default_if_lb);\r\n}\r\ninterfaces_info_nochange = FALSE;\r\ng_free(if_name);\r\ng_free(desc);\r\ng_free(linktype);\r\ng_free(comment);\r\n}\r\nstatic void\r\nifopts_edit_monitor_changed_cb(GtkToggleButton *tbt, gpointer udata)\r\n{\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\ngchar *if_name, *text;\r\ngboolean monitor_mode;\r\nif_capabilities_t *caps;\r\nif (interfaces_info_nochange)\r\nreturn;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\ngtk_tree_model_get(list_model, &list_iter,\r\nDEVICE_COLUMN, &if_name,\r\n-1);\r\ninterfaces_info_nochange = TRUE;\r\nwhile (num_linktypes > 0) {\r\nnum_linktypes--;\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(if_linktype_cb), num_linktypes);\r\n}\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\n#ifdef HAVE_PCAP_CREATE\r\nmonitor_mode = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(tbt));\r\ngtk_list_store_set (list_store, &list_iter,\r\nDEF_MONITOR_MODE_COLUMN, monitor_mode,\r\n-1);\r\ncaps = capture_get_if_capabilities(if_name, monitor_mode, NULL, NULL, main_window_update);\r\n#else\r\ncaps = capture_get_if_capabilities(if_name, FALSE, NULL, NULL);\r\n#endif\r\nif (caps != NULL) {\r\n#ifdef HAVE_PCAP_CREATE\r\ngtk_widget_set_sensitive(if_monitor_lb, caps->can_set_rfmon);\r\ngtk_widget_set_sensitive(if_monitor_cb, caps->can_set_rfmon);\r\n#endif\r\nif (caps->data_link_types != NULL) {\r\nGList *lt_entry;\r\nfor (lt_entry = caps->data_link_types; lt_entry != NULL;\r\nlt_entry = g_list_next(lt_entry)) {\r\ndata_link_info_t *dli_p = (data_link_info_t *)lt_entry->data;\r\ntext = (dli_p->description != NULL) ? dli_p->description : dli_p->name;\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(if_linktype_cb), text);\r\nnum_linktypes++;\r\n}\r\ngtk_widget_set_sensitive(if_linktype_lb, num_linktypes >= 2);\r\ngtk_widget_set_sensitive(if_linktype_cb, num_linktypes >= 2);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(if_linktype_cb), 0);\r\n}\r\nfree_if_capabilities(caps);\r\n}\r\n#ifdef HAVE_PCAP_CREATE\r\nelse {\r\ngtk_widget_set_sensitive(if_monitor_lb, FALSE);\r\ngtk_widget_set_sensitive(if_monitor_cb, FALSE);\r\n}\r\n#endif\r\ninterfaces_info_nochange = FALSE;\r\ng_signal_emit_by_name(if_linktype_cb, "changed");\r\ng_free(if_name);\r\n}\r\nstatic void\r\nifopts_edit_linktype_changed_cb(GtkComboBox *cb, gpointer udata)\r\n{\r\ngchar *ifnm, *text;\r\n#ifdef HAVE_PCAP_CREATE\r\ngboolean monitor_mode;\r\n#endif\r\ngint linktype;\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (interfaces_info_nochange)\r\nreturn;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\ngtk_tree_model_get(list_model, &list_iter,\r\nDEVICE_COLUMN, &ifnm,\r\n#ifdef HAVE_PCAP_CREATE\r\nDEF_MONITOR_MODE_COLUMN, &monitor_mode,\r\n#endif\r\n-1);\r\ntext = gtk_combo_box_text_get_active_text (GTK_COMBO_BOX_TEXT(cb));\r\nif (text) {\r\n#ifdef HAVE_PCAP_CREATE\r\nlinktype = ifopts_description_to_val(ifnm, monitor_mode, text);\r\n#else\r\nlinktype = ifopts_description_to_val(ifnm, FALSE, text);\r\n#endif\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\ngtk_list_store_set (list_store, &list_iter,\r\nDEF_LINK_LAYER_COLUMN, text,\r\nDLT_COLUMN, linktype,\r\n-1);\r\ng_free(text);\r\n}\r\n}\r\nstatic void\r\nifopts_edit_buffersize_changed_cb(GtkSpinButton *sb, gpointer udata)\r\n{\r\ngint buffersize;\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\nbuffersize = gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(sb));\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\ngtk_list_store_set (list_store, &list_iter,\r\nBUF_COLUMN, buffersize,\r\n-1);\r\n}\r\nstatic void\r\nifopts_edit_snaplen_changed_cb(GtkSpinButton *sb _U_, gpointer udata _U_)\r\n{\r\ngint snaplen;\r\ngboolean hassnap;\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\nsnaplen = gtk_spin_button_get_value_as_int(GTK_SPIN_BUTTON(sb));\r\nif (snaplen != WTAP_MAX_PACKET_SIZE) {\r\nhassnap = TRUE;\r\n} else {\r\nhassnap = FALSE;\r\n}\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\ngtk_list_store_set (list_store, &list_iter,\r\nSNAPLEN_COLUMN, snaplen,\r\nHASSNAP_COLUMN, hassnap,\r\n-1);\r\n}\r\nstatic void\r\nifopts_edit_hassnap_changed_cb(GtkToggleButton *tbt, gpointer udata)\r\n{\r\ngboolean hassnap;\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\nhassnap = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(tbt));\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\ngtk_list_store_set (list_store, &list_iter,\r\nHASSNAP_COLUMN, hassnap,\r\n-1);\r\ngtk_widget_set_sensitive(GTK_WIDGET(if_snaplen_cb), hassnap);\r\n}\r\nstatic void\r\nifopts_edit_pmode_changed_cb(GtkToggleButton *tbt, gpointer udata)\r\n{\r\ngboolean pmode;\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\npmode = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(tbt));\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\ngtk_list_store_set (list_store, &list_iter,\r\nPMODE_COLUMN, pmode,\r\n-1);\r\n}\r\nstatic void\r\nifopts_edit_descr_changed_cb(GtkEditable *ed, gpointer udata)\r\n{\r\ngchar *text;\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (interfaces_info_nochange)\r\nreturn;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\ntext = gtk_editable_get_chars(GTK_EDITABLE(ed), 0, -1);\r\ng_strdelimit(text, "(),", ' ');\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\ngtk_list_store_set (list_store, &list_iter,\r\nCOMMENT_COLUMN, text,\r\n-1);\r\ng_free(text);\r\n}\r\nstatic void\r\nifopts_edit_hide_changed_cb(GtkToggleButton *tbt, gpointer udata)\r\n{\r\nGtkTreeModel *list_model;\r\nGtkTreeIter list_iter;\r\nGtkListStore *list_store;\r\nif (interfaces_info_nochange)\r\nreturn;\r\nif (if_selection == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected (if_selection, &list_model, &list_iter)){\r\nreturn;\r\n}\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (udata)));\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(tbt)) == TRUE)\r\ngtk_list_store_set (list_store, &list_iter,\r\nHIDE_COLUMN, TRUE,\r\n-1);\r\nelse\r\ngtk_list_store_set (list_store, &list_iter,\r\nHIDE_COLUMN, FALSE,\r\n-1);\r\n}\r\nstatic void\r\nifopts_options_add(GtkListStore *list_store, if_info_t *if_info)\r\n{\r\ngchar *p;\r\ngchar *ifnm;\r\ngchar *desc;\r\ngchar *pr_descr;\r\ngchar *text[] = { NULL, NULL, NULL, NULL };\r\nif_capabilities_t *caps;\r\n#ifdef HAVE_PCAP_CREATE\r\ngboolean monitor_mode;\r\n#endif\r\ngint linktype;\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\ngint buffersize;\r\n#endif\r\ngint snaplen;\r\ngboolean hide, hassnap = TRUE, pmode;\r\nGtkTreeIter iter;\r\ntext[0] = g_strdup(if_info->name);\r\nif (if_info->vendor_description != NULL)\r\ntext[1] = g_strdup(if_info->vendor_description);\r\nelse\r\ntext[1] = g_strdup("");\r\n#ifdef HAVE_PCAP_CREATE\r\nmonitor_mode = prefs_capture_device_monitor_mode(if_info->name);\r\ncaps = capture_get_if_capabilities(if_info->name, monitor_mode, NULL, NULL, main_window_update);\r\n#else\r\ncaps = capture_get_if_capabilities(if_info->name, FALSE, NULL, NULL, main_window_update);\r\n#endif\r\nlinktype = capture_dev_user_linktype_find(if_info->name);\r\nif (caps != NULL) {\r\nif (caps->data_link_types != NULL) {\r\nGList *lt_entry;\r\nfor (lt_entry = caps->data_link_types; lt_entry != NULL;\r\nlt_entry = g_list_next(lt_entry)) {\r\ndata_link_info_t *dli_p = (data_link_info_t *)lt_entry->data;\r\nif (linktype == -1 || linktype == dli_p->dlt) {\r\nif (dli_p->description) {\r\ntext[2] = g_strdup(dli_p->description);\r\n} else {\r\ntext[2] = g_strdup(dli_p->name);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nfree_if_capabilities(caps);\r\n}\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nbuffersize = capture_dev_user_buffersize_find(if_info->name);\r\nif (buffersize == -1) {\r\nbuffersize = DEFAULT_CAPTURE_BUFFER_SIZE;\r\n}\r\n#endif\r\nif (!capture_dev_user_snaplen_find(if_info->name, &hassnap, &snaplen)) {\r\nsnaplen = WTAP_MAX_PACKET_SIZE;\r\nhassnap = FALSE;\r\n}\r\nif (prefs.capture_prom_mode) {\r\npmode = TRUE;\r\n} else {\r\nif (!capture_dev_user_pmode_find(if_info->name, &pmode)) {\r\npmode = FALSE;\r\n}\r\n}\r\nif (text[2] == NULL)\r\ntext[2] = g_strdup("");\r\nif ((prefs.capture_devices_descr != NULL) &&\r\n(*prefs.capture_devices_descr != '\0')) {\r\npr_descr = g_strdup(prefs.capture_devices_descr);\r\nif ((ifnm = strstr(pr_descr, if_info->name)) != NULL) {\r\np = ifnm;\r\nwhile (*p != '\0') {\r\nif (*p == '(') {\r\np++;\r\nif ((*p == '\0') || (*p == ',') || (*p == '(') || (*p == ')'))\r\nbreak;\r\ndesc = p;\r\np++;\r\nwhile (*p != '\0') {\r\nif ((*p == ',') || (*p == '('))\r\nbreak;\r\nelse if (*p == ')') {\r\n*p = '\0';\r\ntext[3] = g_strdup(desc);\r\nbreak;\r\n}\r\np++;\r\n}\r\nbreak;\r\n} else\r\np++;\r\n}\r\n}\r\ng_free(pr_descr);\r\n}\r\nif (text[3] == NULL)\r\ntext[3] = g_strdup("");\r\nhide = prefs_is_capture_device_hidden(if_info->name);\r\ngtk_list_store_insert_with_values( list_store , &iter, G_MAXINT,\r\nDEVICE_COLUMN, text[0],\r\nDESC_COLUMN, text[1],\r\n#ifdef HAVE_PCAP_CREATE\r\nDEF_MONITOR_MODE_COLUMN, monitor_mode,\r\n#endif\r\n#ifdef CAN_SET_CAPTURE_BUFFER_SIZE\r\nBUF_COLUMN, buffersize,\r\n#endif\r\nHASSNAP_COLUMN, hassnap,\r\nSNAPLEN_COLUMN, snaplen,\r\nPMODE_COLUMN, pmode,\r\nDEF_LINK_LAYER_COLUMN, text[2],\r\nCOMMENT_COLUMN, text[3],\r\nHIDE_COLUMN, hide,\r\nDLT_COLUMN, linktype,\r\n-1);\r\nifopts_options_free(text);\r\n}\r\nstatic void\r\nifopts_options_free(gchar *text[])\r\n{\r\ngint i;\r\nfor (i=0; i < IFOPTS_LIST_TEXT_COLS; i++) {\r\nif (text[i] != NULL) {\r\ng_free(text[i]);\r\ntext[i] = NULL;\r\n}\r\n}\r\n}\r\nstatic void\r\nifopts_if_liststore_add(void)\r\n{\r\nGList *if_list, *ifl_p;\r\nint err;\r\ngchar *err_str;\r\nif_list = capture_interface_list(&err, &err_str, main_window_update);\r\nif (if_list == NULL) {\r\nif (err != 0) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", err_str);\r\n}\r\ng_free(err_str);\r\nreturn;\r\n}\r\nfor (ifl_p = if_list; ifl_p != NULL; ifl_p = g_list_next(ifl_p)) {\r\nif ((ifl_p->data) == NULL)\r\ncontinue;\r\nifopts_options_add(GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (cur_list))),\r\n(if_info_t *)ifl_p->data);\r\n}\r\nfree_interface_list(if_list);\r\n}\r\nstatic void\r\nifopts_write_new_monitor_mode(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngboolean more_items = TRUE;\r\ngint first_if = TRUE;\r\ngchar *ifnm;\r\ngboolean monitor_mode;\r\ngchar *new_monitor_mode;\r\nnew_monitor_mode = (gchar*)g_malloc0(MAX_VAL_LEN);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nDEF_MONITOR_MODE_COLUMN, &monitor_mode,\r\n-1);\r\nif (!monitor_mode){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE)\r\ng_strlcat (new_monitor_mode, ",", MAX_VAL_LEN);\r\ng_strlcat (new_monitor_mode, ifnm, MAX_VAL_LEN);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_monitor_mode);\r\nprefs.capture_devices_monitor_mode = new_monitor_mode;\r\n}\r\n}\r\nstatic void\r\nifopts_write_new_linklayer(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngboolean more_items = TRUE, first_if = TRUE;\r\ngchar *ifnm;\r\ngint linktype;\r\ngchar *tmp_linklayer;\r\ngchar *new_linklayer;\r\nnew_linklayer = (gchar *)g_malloc0(MAX_VAL_LEN);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nDLT_COLUMN, &linktype,\r\n-1);\r\nif (linktype == -1){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE) {\r\ng_strlcat (new_linklayer, ",", MAX_VAL_LEN);\r\n}\r\ntmp_linklayer = g_strdup_printf("%s(%d)", ifnm, linktype);\r\ng_strlcat(new_linklayer, tmp_linklayer, MAX_VAL_LEN);\r\ng_free(tmp_linklayer);\r\ng_free(ifnm);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_linktypes);\r\nprefs.capture_devices_linktypes = new_linklayer;\r\n}\r\n}\r\nstatic void\r\nifopts_write_new_buffersize(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngboolean more_items = TRUE, first_if = TRUE;\r\ngchar *ifnm;\r\ngint buffersize;\r\ngchar *tmp_buffersize;\r\ngchar *new_buffersize;\r\nnew_buffersize = (gchar *)g_malloc0(MAX_VAL_LEN);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nBUF_COLUMN, &buffersize,\r\n-1);\r\nif (buffersize == -1){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE) {\r\ng_strlcat (new_buffersize, ",", MAX_VAL_LEN);\r\n}\r\ntmp_buffersize = g_strdup_printf("%s(%d)", ifnm, buffersize);\r\ng_strlcat(new_buffersize, tmp_buffersize, MAX_VAL_LEN);\r\ng_free(tmp_buffersize);\r\ng_free(ifnm);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_buffersize);\r\nprefs.capture_devices_buffersize = new_buffersize;\r\n}\r\n}\r\nstatic void\r\nifopts_write_new_snaplen(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngboolean more_items = TRUE, first_if = TRUE;\r\ngchar *ifnm;\r\ngint snaplen;\r\ngboolean hassnap;\r\ngchar *tmp_snaplen;\r\ngchar *new_snaplen;\r\nnew_snaplen = (gchar *)g_malloc0(MAX_VAL_LEN);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nSNAPLEN_COLUMN, &snaplen,\r\nHASSNAP_COLUMN, &hassnap,\r\n-1);\r\nif (snaplen == -1){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE) {\r\ng_strlcat (new_snaplen, ",", MAX_VAL_LEN);\r\n}\r\ntmp_snaplen = g_strdup_printf("%s:%d(%d)", ifnm, hassnap, (hassnap?snaplen:WTAP_MAX_PACKET_SIZE));\r\ng_strlcat(new_snaplen, tmp_snaplen, MAX_VAL_LEN);\r\ng_free(tmp_snaplen);\r\ng_free(ifnm);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_snaplen);\r\nprefs.capture_devices_snaplen = new_snaplen;\r\n}\r\n}\r\nstatic void\r\nifopts_write_new_pmode(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\nGtkWidget *promisc_cb;\r\ngboolean more_items = TRUE, first_if = TRUE;\r\ngchar *ifnm;\r\ngboolean pmode, off = FALSE;\r\ngchar *tmp_pmode;\r\ngchar *new_pmode;\r\nnew_pmode = (gchar *)g_malloc0(MAX_VAL_LEN);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nPMODE_COLUMN, &pmode,\r\n-1);\r\nif (pmode == -1){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE) {\r\ng_strlcat (new_pmode, ",", MAX_VAL_LEN);\r\n}\r\nif (!pmode) {\r\noff = TRUE;\r\n}\r\ntmp_pmode = g_strdup_printf("%s(%d)", ifnm, pmode);\r\ng_strlcat(new_pmode, tmp_pmode, MAX_VAL_LEN);\r\ng_free(tmp_pmode);\r\ng_free(ifnm);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_pmode);\r\nprefs.capture_devices_pmode = new_pmode;\r\nif (off) {\r\nprefs.capture_prom_mode = FALSE;\r\n} else {\r\nprefs.capture_prom_mode = TRUE;\r\n}\r\npromisc_cb = (GtkWidget *)g_object_get_data(G_OBJECT(capture_window), PROM_MODE_KEY);\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(promisc_cb), prefs.capture_prom_mode);\r\n}\r\n}\r\nstatic void\r\nifopts_write_new_descr(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngboolean more_items = TRUE;\r\ngboolean first_if = TRUE;\r\ngchar *ifnm;\r\ngchar *desc;\r\ngchar *tmp_descr;\r\ngchar *new_descr;\r\nnew_descr = (gchar *)g_malloc0(MAX_VAL_LEN);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nCOMMENT_COLUMN, &desc,\r\n-1);\r\nif (strlen(desc) == 0){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE) {\r\ng_strlcat (new_descr, ",", MAX_VAL_LEN);\r\n}\r\ntmp_descr = g_strdup_printf("%s(%s)", ifnm, desc);\r\ng_strlcat(new_descr, tmp_descr, MAX_VAL_LEN);\r\ng_free(tmp_descr);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_descr);\r\nprefs.capture_devices_descr = new_descr;\r\n}\r\n}\r\nstatic void\r\nifopts_write_new_hide(void)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\ngboolean more_items = TRUE;\r\ngint first_if = TRUE;\r\ngchar *ifnm;\r\ngboolean hide;\r\ngchar *new_hide;\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cur_list));\r\nstore = GTK_LIST_STORE(model);\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\nnew_hide = (gchar *)g_malloc0(MAX_VAL_LEN);\r\nwhile (more_items) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter,\r\nDEVICE_COLUMN, &ifnm,\r\nHIDE_COLUMN, &hide,\r\n-1);\r\nif (!hide){\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\ncontinue;\r\n}\r\nif (first_if != TRUE)\r\ng_strlcat (new_hide, ",", MAX_VAL_LEN);\r\ng_strlcat (new_hide, ifnm, MAX_VAL_LEN);\r\nfirst_if = FALSE;\r\nmore_items = gtk_tree_model_iter_next (model,&iter);\r\n}\r\ng_free(prefs.capture_devices_hide);\r\nprefs.capture_devices_hide = new_hide;\r\nhide_interface(g_strdup(new_hide));\r\n}\r\n}\r\nstatic void\r\nprom_mode_cb(GtkToggleButton *tbt, gpointer udata _U_) {\r\nprefs.capture_prom_mode = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(tbt));\r\n}

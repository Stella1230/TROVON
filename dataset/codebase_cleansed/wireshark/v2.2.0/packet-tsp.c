static int\r\ndissect_tsp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *tsp_tree;\r\nproto_item *tsp_item;\r\nguint8 tsp_type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "TSP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntsp_type = tvb_get_guint8(tvb, 0);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(tsp_type, names_tsp_type, "Unknown message type (%u)"));\r\ntsp_item = proto_tree_add_item(tree, proto_tsp,\r\ntvb, 0, -1, ENC_NA);\r\ntsp_tree = proto_item_add_subtree(tsp_item, ett_tsp);\r\nif (tsp_tree) {\r\nproto_tree_add_uint(tsp_tree, hf_tsp_type,\r\ntvb, 0, 1, tsp_type);\r\nproto_tree_add_item(tsp_tree, hf_tsp_vers,\r\ntvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tsp_tree, hf_tsp_seq,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\n}\r\nswitch (tsp_type) {\r\ncase TSP_LOOP:\r\nif (tsp_tree)\r\nproto_tree_add_item(tsp_tree, hf_tsp_hopcnt,\r\ntvb, 4, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase TSP_SETTIME:\r\ncase TSP_ADJTIME:\r\ncase TSP_SETDATE:\r\ncase TSP_SETDATEREQ:\r\nif (tsp_tree) {\r\nproto_tree_add_item(tsp_tree, hf_tsp_time_sec,\r\ntvb, 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tsp_tree, hf_tsp_time_usec,\r\ntvb, 8, 4, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\n}\r\nif (tsp_tree) {\r\nproto_tree_add_item(tsp_tree, hf_tsp_name, tvb, 12,\r\n-1, ENC_ASCII|ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_reg_handoff_tsp(void)\r\n{\r\ndissector_handle_t tsp_handle;\r\ntsp_handle = create_dissector_handle(dissect_tsp, proto_tsp);\r\ndissector_add_uint("udp.port", UDP_PORT_TIMED, tsp_handle);\r\n}\r\nvoid\r\nproto_register_tsp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_tsp_type,\r\n{ "Type", "tsp.type",\r\nFT_UINT8, BASE_DEC, VALS(names_tsp_type), 0x0,\r\n"Packet Type", HFILL }},\r\n{ &hf_tsp_vers,\r\n{ "Version", "tsp.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Protocol Version Number", HFILL }},\r\n{ &hf_tsp_seq,\r\n{ "Sequence", "tsp.sequence",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Sequence Number", HFILL }},\r\n{ &hf_tsp_hopcnt,\r\n{ "Hop Count", "tsp.hopcnt",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_tsp_time_sec,\r\n{ "Seconds", "tsp.sec",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_tsp_time_usec,\r\n{ "Microseconds", "tsp.usec",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_tsp_name,\r\n{ "Machine Name", "tsp.name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Sender Machine Name", HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_tsp\r\n};\r\nproto_tsp = proto_register_protocol("Time Synchronization Protocol",\r\n"TSP", "tsp");\r\nproto_register_field_array(proto_tsp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}

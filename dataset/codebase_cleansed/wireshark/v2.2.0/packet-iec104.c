static void get_CP56Time(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nguint16 ms;\r\nguint8 value;\r\nguint8 su;\r\nstruct tm tm;\r\nnstime_t datetime;\r\nproto_item* ti;\r\nproto_tree* cp56time_tree;\r\nms = tvb_get_letohs(tvb, *offset);\r\ntm.tm_sec = ms / 1000;\r\ndatetime.nsecs = (ms % 1000) * 1000000;\r\n(*offset) += 2;\r\nvalue = tvb_get_guint8(tvb, *offset);\r\ntm.tm_min = value & 0x3F;\r\n(*offset)++;\r\nvalue = tvb_get_guint8(tvb, *offset);\r\ntm.tm_hour = value & 0x1F;\r\nsu = value & 0x80;\r\n(*offset)++;\r\nvalue = tvb_get_guint8(tvb, *offset);\r\ntm.tm_mday = value & 0x1F;\r\n(*offset)++;\r\nvalue = tvb_get_guint8(tvb, *offset);\r\ntm.tm_mon = (value & 0x0F) - 1;\r\n(*offset)++;\r\nvalue = tvb_get_guint8(tvb, *offset);\r\ntm.tm_year = value & 0x7F;\r\nif (tm.tm_year < 70)\r\ntm.tm_year += 100;\r\n(*offset)++;\r\nif (su)\r\ntm.tm_isdst = 1;\r\nelse\r\ntm.tm_isdst = -1;\r\ndatetime.secs = mktime(&tm);\r\n(*offset) -= 7;\r\nti = proto_tree_add_time(iec104_header_tree, hf_cp56time, tvb, *offset, 7, &datetime);\r\ncp56time_tree = proto_item_add_subtree(ti, ett_cp56time);\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_ms, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n(*offset) += 2;\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_min, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_iv, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset) ++;\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_hour, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_su, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset) ++;\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_day, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_dow, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset) ++;\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_month, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset) ++;\r\nproto_tree_add_item(cp56time_tree, hf_cp56time_year, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset) ++;\r\n}\r\nstatic proto_item* get_InfoObjectAddress(guint32 *asdu_info_obj_addr, tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\n*asdu_info_obj_addr = tvb_get_letoh24(tvb, *offset);\r\nti = proto_tree_add_item(iec104_header_tree, hf_ioa, tvb, *offset, 3, ENC_LITTLE_ENDIAN);\r\n(*offset) += 3;\r\nreturn ti;\r\n}\r\nstatic guint8 get_TypeIdLength(guint8 TypeId)\r\n{\r\nguint8 ret = 0;\r\nconst td_asdu_length *item;\r\nitem = asdu_length;\r\nwhile (item->value)\r\n{\r\nif (item->value == TypeId)\r\n{\r\nret = item->length;\r\nbreak;\r\n}\r\nitem++;\r\n}\r\nreturn ret;\r\n}\r\nstatic void get_SIQ(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* siq_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_siq, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nsiq_tree = proto_item_add_subtree(ti, ett_siq);\r\nproto_tree_add_item(siq_tree, hf_siq_spi, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(siq_tree, hf_siq_bl, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(siq_tree, hf_siq_sb, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(siq_tree, hf_siq_nt, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(siq_tree, hf_siq_iv, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_DIQ(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* diq_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_diq, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\ndiq_tree = proto_item_add_subtree(ti, ett_diq);\r\nproto_tree_add_item(diq_tree, hf_diq_dpi, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(diq_tree, hf_diq_bl, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(diq_tree, hf_diq_sb, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(diq_tree, hf_diq_nt, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(diq_tree, hf_diq_iv, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_QDS(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* qds_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_qds, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nqds_tree = proto_item_add_subtree(ti, ett_qds);\r\nproto_tree_add_item(qds_tree, hf_qds_ov, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(qds_tree, hf_qds_bl, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(qds_tree, hf_qds_sb, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(qds_tree, hf_qds_nt, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(qds_tree, hf_qds_iv, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_VTI(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* vti_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_vti, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nvti_tree = proto_item_add_subtree(ti, ett_vti);\r\nproto_tree_add_item(vti_tree, hf_vti_v, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(vti_tree, hf_vti_t, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_NVA(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\ngint16 value;\r\nfloat fvalue;\r\nvalue = (gint16)tvb_get_letohs(tvb, *offset);\r\nfvalue = (float)value / 32768;\r\nproto_tree_add_float_format_value(iec104_header_tree, hf_asdu_normval, tvb, *offset, 2, fvalue, "%." G_STRINGIFY(FLT_DIG) "g (%d)", fvalue, value);\r\n(*offset) += 2;\r\n}\r\nstatic void get_NVAspt(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\ngint16 value;\r\nfloat fvalue;\r\nvalue = (gint16)tvb_get_letohs(tvb, *offset);\r\nfvalue = (float)value / 32768;\r\nproto_tree_add_float_format_value(iec104_header_tree, hf_asdu_normval, tvb, *offset, 2, fvalue, "%." G_STRINGIFY(FLT_DIG) "g (%d)", fvalue, value);\r\n(*offset) += 2;\r\n}\r\nstatic void get_SVA(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_item(iec104_header_tree, hf_asdu_scalval, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n(*offset) += 2;\r\n}\r\nstatic void get_SVAspt(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_item(iec104_header_tree, hf_asdu_scalval, tvb, *offset, 2, ENC_LITTLE_ENDIAN);\r\n(*offset) += 2;\r\n}\r\nstatic void get_FLT(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_item(iec104_header_tree, hf_asdu_float, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n(*offset) += 4;\r\n}\r\nstatic void get_FLTspt(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_item(iec104_header_tree, hf_asdu_float, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n(*offset) += 4;\r\n}\r\nstatic void get_BSI(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_bits_item(iec104_header_tree, hf_asdu_bitstring, tvb, *offset*8, 32, ENC_BIG_ENDIAN);\r\n(*offset) += 4;\r\n}\r\nstatic void get_BSIspt(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_bits_item(iec104_header_tree, hf_asdu_bitstring, tvb, *offset*8, 32, ENC_BIG_ENDIAN);\r\n(*offset) += 4;\r\n}\r\nstatic void get_BCR(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_item(iec104_header_tree, hf_bcr_count, tvb, *offset, 4, ENC_LITTLE_ENDIAN);\r\n*offset += 4;\r\nproto_tree_add_item(iec104_header_tree, hf_bcr_sq, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(iec104_header_tree, hf_bcr_cy, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(iec104_header_tree, hf_bcr_ca, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(iec104_header_tree, hf_bcr_iv, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n*offset += 1;\r\n}\r\nstatic void get_QOS(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* qos_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_qos, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nqos_tree = proto_item_add_subtree(ti, ett_qos);\r\nproto_tree_add_item(qos_tree, hf_qos_ql, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(qos_tree, hf_qos_se, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_SCO(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* sco_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_sco, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nsco_tree = proto_item_add_subtree(ti, ett_sco);\r\nproto_tree_add_item(sco_tree, hf_sco_on, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(sco_tree, hf_sco_qu, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(sco_tree, hf_sco_se, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_DCO(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* dco_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_dco, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\ndco_tree = proto_item_add_subtree(ti, ett_dco);\r\nproto_tree_add_item(dco_tree, hf_dco_on, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(dco_tree, hf_dco_qu, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(dco_tree, hf_dco_se, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_RCO(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* rco_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_rco, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nrco_tree = proto_item_add_subtree(ti, ett_rco);\r\nproto_tree_add_item(rco_tree, hf_rco_up, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(rco_tree, hf_rco_qu, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(rco_tree, hf_rco_se, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_COI(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_item* ti;\r\nproto_tree* coi_tree;\r\nti = proto_tree_add_item(iec104_header_tree, hf_coi, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\ncoi_tree = proto_item_add_subtree(ti, ett_rco);\r\nproto_tree_add_item(coi_tree, hf_coi_r, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(coi_tree, hf_coi_i, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic void get_QOI(tvbuff_t *tvb, guint8 *offset, proto_tree *iec104_header_tree)\r\n{\r\nproto_tree_add_item(iec104_header_tree, hf_qoi, tvb, *offset, 1, ENC_LITTLE_ENDIAN);\r\n(*offset)++;\r\n}\r\nstatic guint get_iec104apdu_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint8 Val;\r\nguint32 Off;\r\nfor (Off = 0; Off <= tvb_reported_length(tvb) - 2; Off++) {\r\nVal = tvb_get_guint8(tvb, offset + Off);\r\nif (Val == APCI_START) {\r\nreturn (guint)(Off + tvb_get_guint8(tvb, offset + Off + 1) + 2);\r\n}\r\n}\r\nreturn (guint)(tvb_reported_length(tvb));\r\n}\r\nstatic int dissect_iec104asdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint Len = tvb_reported_length(tvb);\r\nguint8 Bytex;\r\nconst char *cause_str;\r\nsize_t Ind;\r\nstruct asduheader asduh;\r\nproto_item *it104;\r\nproto_tree *it104tree;\r\nwmem_strbuf_t * res;\r\nguint8 offset = 0;\r\nguint8 i;\r\nguint32 asdu_info_obj_addr = 0;\r\nproto_item * itSignal = NULL;\r\nproto_tree * trSignal;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "104asdu");\r\nit104 = proto_tree_add_item(tree, proto_iec104asdu, tvb, 0, -1, ENC_NA);\r\nit104tree = proto_item_add_subtree(it104, ett_asdu);\r\nres = wmem_strbuf_new_label(wmem_packet_scope());\r\nasduh.TypeId = tvb_get_guint8(tvb, 0);\r\nproto_tree_add_item(it104tree, hf_typeid, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nasduh.DataLength = get_TypeIdLength(asduh.TypeId);\r\nBytex = tvb_get_guint8(tvb, 1);\r\nasduh.SQ = Bytex & F_SQ;\r\nasduh.NumIx = Bytex & 0x7F;\r\nproto_tree_add_item(it104tree, hf_sq, tvb, 1, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(it104tree, hf_numix, tvb, 1, 1, ENC_LITTLE_ENDIAN);\r\nasduh.TNCause = tvb_get_guint8(tvb, 2);\r\nproto_tree_add_item(it104tree, hf_causetx, tvb, 2, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(it104tree, hf_nega, tvb, 2, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(it104tree, hf_test, tvb, 2, 1, ENC_LITTLE_ENDIAN);\r\nasduh.OA = tvb_get_guint8(tvb, 3);\r\nproto_tree_add_item(it104tree, hf_oa, tvb, 3, 1, ENC_LITTLE_ENDIAN);\r\nasduh.Addr = tvb_get_letohs(tvb, 4);\r\nproto_tree_add_item(it104tree, hf_addr, tvb, 4, 2, ENC_LITTLE_ENDIAN);\r\nasduh.IOA = tvb_get_letoh24(tvb, 6);\r\ncause_str = val_to_str(asduh.TNCause & F_CAUSE, causetx_types, " <CauseTx=%u>");\r\nwmem_strbuf_append_printf(res, "ASDU=%u %s %s", asduh.Addr, val_to_str(asduh.TypeId, asdu_types, "<TypeId=%u>"), cause_str);\r\nif (asduh.TNCause & F_NEGA)\r\nwmem_strbuf_append(res, "_NEGA");\r\nif (asduh.TNCause & F_TEST)\r\nwmem_strbuf_append(res, "_TEST");\r\nif ((asduh.TNCause & (F_TEST | F_NEGA)) == 0) {\r\nfor (Ind=strlen(cause_str); Ind< 7; Ind++)\r\nwmem_strbuf_append(res, " ");\r\n}\r\nif (asduh.NumIx > 1) {\r\nwmem_strbuf_append_printf(res, " IOA[%d]=%d", asduh.NumIx, asduh.IOA);\r\nif (asduh.SQ == F_SQ)\r\nwmem_strbuf_append_printf(res, "-%d", asduh.IOA + asduh.NumIx - 1);\r\nelse\r\nwmem_strbuf_append(res, ",...");\r\n} else {\r\nwmem_strbuf_append_printf(res, " IOA=%d", asduh.IOA);\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, wmem_strbuf_get_str(res));\r\ncol_set_fence(pinfo->cinfo, COL_INFO);\r\nproto_item_append_text(it104, ": %s '%s'", wmem_strbuf_get_str(res),\r\nLen >= ASDU_HEAD_LEN ? val_to_str_const(asduh.TypeId, asdu_lngtypes, "<Unknown TypeId>") : "");\r\noffset = 6;\r\nswitch (asduh.TypeId) {\r\ncase M_SP_NA_1:\r\ncase M_DP_NA_1:\r\ncase M_ST_NA_1:\r\ncase M_BO_NA_1:\r\ncase M_SP_TB_1:\r\ncase M_DP_TB_1:\r\ncase M_ST_TB_1:\r\ncase M_BO_TB_1:\r\ncase M_ME_NA_1:\r\ncase M_ME_NB_1:\r\ncase M_ME_NC_1:\r\ncase M_ME_ND_1:\r\ncase M_ME_TD_1:\r\ncase M_ME_TE_1:\r\ncase M_ME_TF_1:\r\ncase M_IT_NA_1:\r\ncase M_IT_TB_1:\r\ncase C_SC_NA_1:\r\ncase C_DC_NA_1:\r\ncase C_RC_NA_1:\r\ncase C_SE_NA_1:\r\ncase C_SE_NB_1:\r\ncase C_SE_NC_1:\r\ncase C_BO_NA_1:\r\ncase C_SC_TA_1:\r\ncase C_DC_TA_1:\r\ncase C_RC_TA_1:\r\ncase C_SE_TA_1:\r\ncase C_SE_TB_1:\r\ncase C_SE_TC_1:\r\ncase C_BO_TA_1:\r\ncase M_EI_NA_1:\r\ncase C_IC_NA_1:\r\ncase C_CS_NA_1:\r\nfor(i = 0; i < asduh.NumIx; i++)\r\n{\r\nif (i == 0 || !asduh.SQ)\r\ntrSignal = proto_tree_add_subtree(it104tree, tvb, offset, asduh.DataLength + 3,\r\nett_asdu_objects, &itSignal, "IOA:s");\r\nelse\r\ntrSignal = proto_tree_add_subtree(it104tree, tvb, offset, asduh.DataLength,\r\nett_asdu_objects, &itSignal, "IOA:s");\r\nif (i == 0)\r\n{\r\nif(Len < (guint)(offset + 3)) {\r\nexpert_add_info(pinfo, itSignal, &ei_iec104_short_asdu);\r\nreturn offset;\r\n}\r\nget_InfoObjectAddress(&asdu_info_obj_addr, tvb, &offset, trSignal);\r\n} else {\r\nif (asduh.SQ)\r\n{\r\nproto_item *ti;\r\nasdu_info_obj_addr++;\r\nti = proto_tree_add_uint(trSignal, hf_ioa, tvb, 0, 0, asdu_info_obj_addr);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\n} else {\r\nif(Len < (guint)(offset + 3)) {\r\nexpert_add_info(pinfo, itSignal, &ei_iec104_short_asdu);\r\nreturn offset;\r\n}\r\nget_InfoObjectAddress(&asdu_info_obj_addr, tvb, &offset, trSignal);\r\n}\r\n}\r\nproto_item_set_text(itSignal, "IOA: %d", asdu_info_obj_addr);\r\nif(Len < (guint)(offset + asduh.DataLength)) {\r\nexpert_add_info(pinfo, itSignal, &ei_iec104_short_asdu);\r\nreturn offset;\r\n}\r\nswitch (asduh.TypeId) {\r\ncase M_SP_NA_1:\r\nget_SIQ(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_DP_NA_1:\r\nget_DIQ(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ST_NA_1:\r\nget_VTI(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_BO_NA_1:\r\nget_BSI(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_NA_1:\r\nget_NVA(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_NB_1:\r\nget_SVA(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_NC_1:\r\nget_FLT(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_IT_NA_1:\r\nget_BCR(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_ND_1:\r\nget_NVA(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_SP_TB_1:\r\nget_SIQ(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_DP_TB_1:\r\nget_DIQ(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ST_TB_1:\r\nget_VTI(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_BO_TB_1:\r\nget_BSI(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_TD_1:\r\nget_NVA(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_TE_1:\r\nget_SVA(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_ME_TF_1:\r\nget_FLT(tvb, &offset, trSignal);\r\nget_QDS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_IT_TB_1:\r\nget_BCR(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SC_NA_1:\r\nget_SCO(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_DC_NA_1:\r\nget_DCO(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_RC_NA_1:\r\nget_RCO(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SE_NA_1:\r\nget_NVAspt(tvb, &offset, trSignal);\r\nget_QOS(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SE_NB_1:\r\nget_SVAspt(tvb, &offset, trSignal);\r\nget_QOS(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SE_NC_1:\r\nget_FLTspt(tvb, &offset, trSignal);\r\nget_QOS(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_BO_NA_1:\r\nget_BSIspt(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SC_TA_1:\r\nget_SCO(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_DC_TA_1:\r\nget_DCO(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_RC_TA_1:\r\nget_RCO(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SE_TA_1:\r\nget_NVAspt(tvb, &offset, trSignal);\r\nget_QOS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SE_TB_1:\r\nget_SVAspt(tvb, &offset, trSignal);\r\nget_QOS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_SE_TC_1:\r\nget_FLTspt(tvb, &offset, trSignal);\r\nget_QOS(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_BO_TA_1:\r\nget_BSIspt(tvb, &offset, trSignal);\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ncase M_EI_NA_1:\r\nget_COI(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_IC_NA_1:\r\nget_QOI(tvb, &offset, trSignal);\r\nbreak;\r\ncase C_CS_NA_1:\r\nget_CP56Time(tvb, &offset, trSignal);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(it104tree, hf_ioa, tvb, offset, 3, ENC_LITTLE_ENDIAN);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int dissect_iec104apci(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint TcpLen = tvb_reported_length(tvb);\r\nguint8 Start, len, type, temp8;\r\nguint16 apci_txid, apci_rxid;\r\nguint Off;\r\nproto_item *it104, *ti;\r\nproto_tree *it104tree;\r\nwmem_strbuf_t * res;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "104apci");\r\nit104 = proto_tree_add_item(tree, proto_iec104apci, tvb, 0, -1, ENC_NA);\r\nit104tree = proto_item_add_subtree(it104, ett_apci);\r\nres = wmem_strbuf_new_label(wmem_packet_scope());\r\nStart = 0;\r\nfor (Off = 0; Off <= TcpLen - 2; Off++) {\r\nStart = tvb_get_guint8(tvb, Off);\r\nif (Start == APCI_START) {\r\nif (Off > 0)\r\n{\r\nproto_tree_add_item(it104tree, hf_apcidata, tvb, 0, Off, ENC_NA);\r\nwmem_strbuf_append_printf(res, "<ERR prefix %u bytes> ", Off);\r\n}\r\nproto_item_set_len(it104, Off + APCI_LEN);\r\nproto_tree_add_uint_format(it104tree, hf_start, tvb, Off, 1, Start, "START");\r\nti = proto_tree_add_item(it104tree, hf_apdulen, tvb, Off + 1, 1, ENC_LITTLE_ENDIAN);\r\nlen = tvb_get_guint8(tvb, Off + 1);\r\nif (len < APDU_MIN_LEN) {\r\nexpert_add_info_format(pinfo, ti, &ei_iec104_apdu_min_len, "APDU less than %d bytes", APDU_MIN_LEN);\r\nwmem_strbuf_append_printf(res, "<ERR ApduLen=%u bytes> ", len);\r\nreturn tvb_captured_length(tvb);\r\n}\r\ntemp8 = tvb_get_guint8(tvb, Off + 2);\r\nif ((temp8 & 0x01) == 0)\r\ntype = 0;\r\nelse\r\ntype = temp8 & 0x03;\r\nif (type == I_TYPE)\r\nproto_tree_add_bits_item(it104tree, hf_apcitype, tvb, (Off + 2) * 8 + 7, 1, ENC_LITTLE_ENDIAN);\r\nelse\r\nproto_tree_add_bits_item(it104tree, hf_apcitype, tvb, (Off + 2) * 8 + 6, 2, ENC_LITTLE_ENDIAN);\r\nif (len <= APDU_MAX_LEN) {\r\nwmem_strbuf_append_printf(res, "%s %s ",\r\n(pinfo->srcport == iec104_port ? "->" : "<-"),\r\nval_to_str_const(type, apci_types, "<ERR>"));\r\n}\r\nelse {\r\nwmem_strbuf_append_printf(res, "<ERR ApduLen=%u bytes> ", len);\r\n}\r\nswitch(type) {\r\ncase I_TYPE:\r\napci_txid = tvb_get_letohs(tvb, Off + 2) >> 1;\r\napci_rxid = tvb_get_letohs(tvb, Off + 4) >> 1;\r\nwmem_strbuf_append_printf(res, "(%d,%d) ", apci_txid, apci_rxid);\r\nproto_tree_add_uint(it104tree, hf_apcitx, tvb, Off+2, 2, apci_txid);\r\nproto_tree_add_uint(it104tree, hf_apcirx, tvb, Off+4, 2, apci_rxid);\r\nbreak;\r\ncase S_TYPE:\r\napci_rxid = tvb_get_letohs(tvb, Off + 4) >> 1;\r\nwmem_strbuf_append_printf(res, "(%d) ", apci_rxid);\r\nproto_tree_add_uint(it104tree, hf_apcirx, tvb, Off+4, 2, apci_rxid);\r\nbreak;\r\ncase U_TYPE:\r\nwmem_strbuf_append_printf(res, "(%s) ", val_to_str_const((temp8 >> 2) & 0x3F, u_types, "<ERR>"));\r\nproto_tree_add_item(it104tree, hf_apciutype, tvb, Off + 2, 1, ENC_LITTLE_ENDIAN);\r\nbreak;\r\n}\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, " | ", wmem_strbuf_get_str(res));\r\ncol_set_fence(pinfo->cinfo, COL_INFO);\r\nproto_item_append_text(it104, ": %s", wmem_strbuf_get_str(res));\r\nif (type == I_TYPE)\r\ncall_dissector(iec104asdu_handle, tvb_new_subset(tvb, Off + APCI_LEN, -1, len - APCI_DATA_LEN), pinfo, tree);\r\nbreak;\r\n}\r\n}\r\nif (Start != APCI_START) {\r\nproto_tree_add_item(it104tree, hf_apcidata, tvb, 0, Off, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int dissect_iec104reas(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, APCI_LEN,\r\nget_iec104apdu_len, dissect_iec104apci, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_iec104apci(void)\r\n{\r\nstatic hf_register_info hf_ap[] = {\r\n{ &hf_apdulen,\r\n{ "ApduLen", "104apci.apdulen", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"APDU Len", HFILL }},\r\n{ &hf_apcitype,\r\n{ "Type", "104apci.type", FT_UINT8, BASE_HEX, VALS(apci_types), 0x00,\r\n"APCI type", HFILL }},\r\n{ &hf_apciutype,\r\n{ "UType", "104apci.utype", FT_UINT8, BASE_HEX, VALS(u_types), 0xFC,\r\n"Apci U type", HFILL }},\r\n{ &hf_apcitx,\r\n{ "Tx", "104apci.tx", FT_UINT16, BASE_DEC, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_apcirx,\r\n{ "Rx", "104apci.rx", FT_UINT16, BASE_DEC, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_apcidata,\r\n{ "Data", "104apci.data", FT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett_ap[] = {\r\n&ett_apci,\r\n};\r\nmodule_t *iec104_module;\r\nproto_iec104apci = proto_register_protocol(\r\n"IEC 60870-5-104-Apci",\r\n"104apci",\r\n"104apci"\r\n);\r\nproto_register_field_array(proto_iec104apci, hf_ap, array_length(hf_ap));\r\nproto_register_subtree_array(ett_ap, array_length(ett_ap));\r\niec104_module = prefs_register_protocol(proto_iec104apci, proto_reg_handoff_iec104);\r\nprefs_register_uint_preference(iec104_module, "tcp.port",\r\n"IEC104 TCP port used by source",\r\n"TCP port used by source of IEC104, usually 2404",\r\n10, &iec104_port);\r\n}\r\nvoid\r\nproto_register_iec104asdu(void)\r\n{\r\nstatic hf_register_info hf_as[] = {\r\n{ &hf_addr,\r\n{ "Addr", "104asdu.addr", FT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Common Address of Asdu", HFILL }},\r\n{ &hf_oa,\r\n{ "OA", "104asdu.oa", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Originator Address", HFILL }},\r\n{ &hf_typeid,\r\n{ "TypeId", "104asdu.typeid", FT_UINT8, BASE_DEC, VALS(asdu_types), 0x0,\r\n"Asdu Type Id", HFILL }},\r\n{ &hf_causetx,\r\n{ "CauseTx", "104asdu.causetx", FT_UINT8, BASE_DEC, VALS(causetx_types), F_CAUSE,\r\n"Cause of Transmision", HFILL }},\r\n{ &hf_nega,\r\n{ "Negative", "104asdu.nega", FT_BOOLEAN, 8, NULL, F_NEGA,\r\nNULL, HFILL }},\r\n{ &hf_test,\r\n{ "Test", "104asdu.test", FT_BOOLEAN, 8, NULL, F_TEST,\r\nNULL, HFILL }},\r\n{ &hf_ioa,\r\n{ "IOA", "104asdu.ioa", FT_UINT24, BASE_DEC, NULL, 0x0,\r\n"Information Object Address", HFILL }},\r\n{ &hf_numix,\r\n{ "NumIx", "104asdu.numix", FT_UINT8, BASE_DEC, NULL, 0x7F,\r\n"Number of Information Objects/Elements", HFILL }},\r\n{ &hf_sq,\r\n{ "SQ", "104asdu.sq", FT_BOOLEAN, 8, NULL, F_SQ,\r\n"Sequence", HFILL }},\r\n{ &hf_cp56time,\r\n{ "CP56Time", "104asdu.cp56time", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_cp56time_ms,\r\n{ "MS", "104asdu.cp56time.ms", FT_UINT16, BASE_DEC, NULL, 0xFFFF,\r\n"CP56Time milliseconds", HFILL }},\r\n{ &hf_cp56time_min,\r\n{ "Min", "104asdu.cp56time.min", FT_UINT8, BASE_DEC, NULL, 0x3F,\r\n"CP56Time minutes", HFILL }},\r\n{ &hf_cp56time_iv,\r\n{ "IV", "104asdu.cp56time.iv", FT_BOOLEAN, 8, TFS(&tfs_invalid_valid), 0x80,\r\n"CP56Time invalid", HFILL }},\r\n{ &hf_cp56time_hour,\r\n{ "Hour", "104asdu.cp56time.hour", FT_UINT8, BASE_DEC, NULL, 0x1F,\r\n"CP56Time hours", HFILL }},\r\n{ &hf_cp56time_su,\r\n{ "SU", "104asdu.cp56time.su", FT_BOOLEAN, 8, TFS(&tfs_local_dst), 0x80,\r\n"CP56Time summer time", HFILL }},\r\n{ &hf_cp56time_day,\r\n{ "Day", "104asdu.cp56time.day", FT_UINT8, BASE_DEC, NULL, 0x1F,\r\n"CP56Time day", HFILL }},\r\n{ &hf_cp56time_dow,\r\n{ "DOW", "104asdu.cp56time.dow", FT_UINT8, BASE_DEC, NULL, 0xE0,\r\n"CP56Time day of week", HFILL }},\r\n{ &hf_cp56time_month,\r\n{ "Month", "104asdu.cp56time.month", FT_UINT8, BASE_DEC, NULL, 0x0F,\r\n"CP56Time month", HFILL }},\r\n{ &hf_cp56time_year,\r\n{ "Year", "104asdu.cp56time.year", FT_UINT8, BASE_DEC, NULL, 0x7F,\r\n"CP56Time year", HFILL }},\r\n{ &hf_siq,\r\n{ "SIQ", "104asdu.siq", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_siq_spi,\r\n{ "SPI", "104asdu.siq.spi", FT_BOOLEAN, 8, TFS(&tfs_on_off), 0x01,\r\n"SIQ SPI", HFILL }},\r\n{ &hf_siq_bl,\r\n{ "BL", "104asdu.siq.bl", FT_BOOLEAN, 8, TFS(&tfs_blocked_not_blocked), 0x10,\r\n"SIQ BL", HFILL }},\r\n{ &hf_siq_sb,\r\n{ "SB", "104asdu.siq.sb", FT_BOOLEAN, 8, TFS(&tfs_substituted_not_substituted), 0x20,\r\n"SIQ SB", HFILL }},\r\n{ &hf_siq_nt,\r\n{ "NT", "104asdu.siq.nt", FT_BOOLEAN, 8, TFS(&tfs_not_topical_topical), 0x40,\r\n"SIQ NT", HFILL }},\r\n{ &hf_siq_iv,\r\n{ "IV", "104asdu.siq.iv", FT_BOOLEAN, 8, TFS(&tfs_invalid_valid), 0x80,\r\n"SIQ IV", HFILL }},\r\n{ &hf_diq,\r\n{ "DIQ", "104asdu.diq", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_diq_dpi,\r\n{ "DPI", "104asdu.diq.dpi", FT_UINT8, BASE_DEC, VALS(diq_types), 0x03,\r\n"DIQ DPI", HFILL }},\r\n{ &hf_diq_bl,\r\n{ "BL", "104asdu.diq.bl", FT_BOOLEAN, 8, TFS(&tfs_blocked_not_blocked), 0x10,\r\n"DIQ BL", HFILL }},\r\n{ &hf_diq_sb,\r\n{ "SB", "104asdu.diq.sb", FT_BOOLEAN, 8, TFS(&tfs_substituted_not_substituted), 0x20,\r\n"DIQ SB", HFILL }},\r\n{ &hf_diq_nt,\r\n{ "NT", "104asdu.diq.nt", FT_BOOLEAN, 8, TFS(&tfs_not_topical_topical), 0x40,\r\n"DIQ NT", HFILL }},\r\n{ &hf_diq_iv,\r\n{ "IV", "104asdu.diq.iv", FT_BOOLEAN, 8, TFS(&tfs_invalid_valid), 0x80,\r\n"DIQ IV", HFILL }},\r\n{ &hf_qds,\r\n{ "QDS", "104asdu.qds", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_qds_ov,\r\n{ "OV", "104asdu.qds.ov", FT_BOOLEAN, 8, TFS(&tfs_overflow_no_overflow), 0x01,\r\n"QDS OV", HFILL }},\r\n{ &hf_qds_bl,\r\n{ "BL", "104asdu.qds.bl", FT_BOOLEAN, 8, TFS(&tfs_blocked_not_blocked), 0x10,\r\n"QDS BL", HFILL }},\r\n{ &hf_qds_sb,\r\n{ "SB", "104asdu.qds.sb", FT_BOOLEAN, 8, TFS(&tfs_substituted_not_substituted), 0x20,\r\n"QDS SB", HFILL }},\r\n{ &hf_qds_nt,\r\n{ "NT", "104asdu.qds.nt", FT_BOOLEAN, 8, TFS(&tfs_not_topical_topical), 0x40,\r\n"QDS NT", HFILL }},\r\n{ &hf_qds_iv,\r\n{ "IV", "104asdu.qds.iv", FT_BOOLEAN, 8, TFS(&tfs_invalid_valid), 0x80,\r\n"QDS IV", HFILL }},\r\n{ &hf_vti,\r\n{ "VTI", "104asdu.vti", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_vti_v,\r\n{ "Value", "104asdu.vti.v", FT_INT8, BASE_DEC, NULL, 0x7F,\r\n"VTI Value", HFILL }},\r\n{ &hf_vti_t,\r\n{ "T", "104asdu.vti.t", FT_BOOLEAN, 8, TFS(&tfs_transient_not_transient), 0x80,\r\n"VTI T", HFILL }},\r\n{ &hf_qos,\r\n{ "QOS", "104asdu.qos", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_qos_ql,\r\n{ "QL", "104asdu.qos.ql", FT_UINT8, BASE_DEC, NULL, 0x7F,\r\n"QOS QL", HFILL }},\r\n{ &hf_qos_se,\r\n{ "S/E", "104asdu.qos.se", FT_BOOLEAN, 8, TFS(&tfs_select_execute), 0x80,\r\n"QOS S/E", HFILL }},\r\n{ &hf_sco,\r\n{ "SCO", "104asdu.sco", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_sco_on,\r\n{ "ON/OFF", "104asdu.sco.on", FT_BOOLEAN, 8, TFS(&tfs_on_off), 0x01,\r\n"SCO SCS", HFILL }},\r\n{ &hf_sco_qu,\r\n{ "QU", "104asdu.sco.qu", FT_UINT8, BASE_DEC, VALS(qos_qu_types), 0x7C,\r\n"SCO QU", HFILL }},\r\n{ &hf_sco_se,\r\n{ "S/E", "104asdu.sco.se", FT_BOOLEAN, 8, TFS(&tfs_select_execute), 0x80,\r\n"SCO S/E", HFILL }},\r\n{ &hf_dco,\r\n{ "DCO", "104asdu.dco", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_dco_on,\r\n{ "ON/OFF", "104asdu.dco.on", FT_UINT8, BASE_DEC, VALS(dco_on_types), 0x03,\r\n"DCO DCS", HFILL }},\r\n{ &hf_dco_qu,\r\n{ "QU", "104asdu.dco.qu", FT_UINT8, BASE_DEC, VALS(qos_qu_types), 0x7C,\r\n"DCO QU", HFILL }},\r\n{ &hf_dco_se,\r\n{ "S/E", "104asdu.dco.se", FT_BOOLEAN, 8, TFS(&tfs_select_execute), 0x80,\r\n"DCO S/E", HFILL }},\r\n{ &hf_rco,\r\n{ "RCO", "104asdu.rco", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_rco_up,\r\n{ "UP/DOWN", "104asdu.rco.up", FT_UINT8, BASE_DEC, VALS(rco_up_types), 0x03,\r\n"RCO RCS", HFILL }},\r\n{ &hf_rco_qu,\r\n{ "QU", "104asdu.rco.qu", FT_UINT8, BASE_DEC, VALS(qos_qu_types), 0x7C,\r\n"RCO QU", HFILL }},\r\n{ &hf_rco_se,\r\n{ "S/E", "104asdu.rco.se", FT_BOOLEAN, 8, TFS(&tfs_select_execute), 0x80,\r\n"RCO S/E", HFILL }},\r\n{ &hf_coi,\r\n{ "COI", "104asdu.coi", FT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }},\r\n{ &hf_coi_r,\r\n{ "R", "104asdu.coi_r", FT_UINT8, BASE_DEC, VALS(coi_r_types), 0x7F,\r\n"COI R", HFILL }},\r\n{ &hf_coi_i,\r\n{ "I", "104asdu.coi_i", FT_BOOLEAN, 8, TFS(&tfs_coi_i), 0x80,\r\n"COI I", HFILL }},\r\n{ &hf_qoi,\r\n{ "QOI", "104asdu.qoi", FT_UINT8, BASE_DEC, VALS(qoi_r_types), 0,\r\nNULL, HFILL }},\r\n{ &hf_bcr_count,\r\n{ "Binary Counter", "104asdu.bcr.count", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_bcr_sq,\r\n{ "SQ", "104asdu.bcr.sq", FT_UINT8, BASE_DEC, NULL, 0x1F,\r\n"Sequence Number", HFILL }},\r\n{ &hf_bcr_cy,\r\n{ "CY", "104asdu.bcr.cy", FT_BOOLEAN, 8, TFS(&tfs_overflow_no_overflow), 0x20,\r\n"Counter Overflow", HFILL }},\r\n{ &hf_bcr_ca,\r\n{ "CA", "104asdu.bcr.ca", FT_BOOLEAN, 8, TFS(&tfs_adjusted_not_adjusted), 0x40,\r\n"Counter Adjusted", HFILL }},\r\n{ &hf_bcr_iv,\r\n{ "IV", "104asdu.bcr.iv", FT_BOOLEAN, 8, TFS(&tfs_invalid_valid), 0x80,\r\n"Counter Validity", HFILL }},\r\n{ &hf_start,\r\n{ "START", "104asdu.start", FT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_asdu_bitstring,\r\n{ "Value", "104asdu.bitstring", FT_UINT32, BASE_HEX, NULL, 0x0,\r\n"BSI value", HFILL }},\r\n{ &hf_asdu_float,\r\n{ "Value", "104asdu.float", FT_FLOAT, BASE_NONE, NULL, 0x0,\r\n"Float value", HFILL }},\r\n{ &hf_asdu_normval,\r\n{ "Value", "104asdu.normval", FT_FLOAT, BASE_NONE, NULL, 0x0,\r\n"Normalised value", HFILL }},\r\n{ &hf_asdu_scalval,\r\n{ "Value", "104asdu.scalval", FT_INT16, BASE_DEC, NULL, 0x0,\r\n"Scaled value", HFILL }},\r\n};\r\nstatic gint *ett_as[] = {\r\n&ett_asdu,\r\n&ett_asdu_objects,\r\n&ett_siq,\r\n&ett_diq,\r\n&ett_qds,\r\n&ett_qos,\r\n&ett_vti,\r\n&ett_sco,\r\n&ett_dco,\r\n&ett_rco,\r\n&ett_cp56time\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_iec104_short_asdu, { "iec104.short_asdu", PI_MALFORMED, PI_ERROR, "<ERR Short Asdu>", EXPFILL }},\r\n{ &ei_iec104_apdu_min_len, { "iec104.apdu_min_len", PI_MALFORMED, PI_ERROR, "APDU less than bytes", EXPFILL }},\r\n};\r\nexpert_module_t* expert_iec104;\r\nproto_iec104asdu = proto_register_protocol(\r\n"IEC 60870-5-104-Asdu",\r\n"104asdu",\r\n"104asdu"\r\n);\r\nproto_register_field_array(proto_iec104asdu, hf_as, array_length(hf_as));\r\nproto_register_subtree_array(ett_as, array_length(ett_as));\r\nexpert_iec104 = expert_register_protocol(proto_iec104asdu);\r\nexpert_register_field_array(expert_iec104, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_iec104(void)\r\n{\r\nstatic dissector_handle_t iec104apci_handle;\r\nstatic gboolean iec104_prefs_initialized = FALSE;\r\nstatic guint saved_iec104_port;\r\nif (!iec104_prefs_initialized) {\r\niec104apci_handle = create_dissector_handle(dissect_iec104reas, proto_iec104apci);\r\niec104asdu_handle = create_dissector_handle(dissect_iec104asdu, proto_iec104asdu);\r\ndissector_add_uint("tcp.port", iec104_port, iec104apci_handle);\r\n} else {\r\ndissector_delete_uint("tcp.port", saved_iec104_port, iec104apci_handle);\r\n}\r\nsaved_iec104_port = iec104_port;\r\nif (iec104_port != 0) {\r\ndissector_add_uint("tcp.port", iec104_port, iec104apci_handle);\r\n}\r\n}

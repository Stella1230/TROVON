wtap_open_return_val commview_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\ncommview_header_t cv_hdr;\r\nif(!commview_read_header(&cv_hdr, wth->fh, err, err_info)) {\r\nif (*err != 0 && *err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif(cv_hdr.version != 0 ||\r\ncv_hdr.year < 1970 || cv_hdr.year >= 2038 ||\r\ncv_hdr.month < 1 || cv_hdr.month > 12 ||\r\ncv_hdr.day < 1 || cv_hdr.day > 31 ||\r\ncv_hdr.hours > 23 ||\r\ncv_hdr.minutes > 59 ||\r\ncv_hdr.seconds > 60 ||\r\ncv_hdr.signal_level_percent > 100 ||\r\n(cv_hdr.flags & FLAGS_RESERVED) != 0 ||\r\n((cv_hdr.flags & FLAGS_MEDIUM) != MEDIUM_ETHERNET &&\r\n(cv_hdr.flags & FLAGS_MEDIUM) != MEDIUM_WIFI &&\r\n(cv_hdr.flags & FLAGS_MEDIUM) != MEDIUM_TOKEN_RING))\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (file_seek(wth->fh, 0, SEEK_SET, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nwth->subtype_read = commview_read;\r\nwth->subtype_seek_read = commview_seek_read;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_COMMVIEW;\r\nwth->file_encap = WTAP_ENCAP_PER_PACKET;\r\nwth->file_tsprec = WTAP_TSPREC_USEC;\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic int\r\ncommview_read_packet(FILE_T fh, struct wtap_pkthdr *phdr, Buffer *buf,\r\nint *err, gchar **err_info)\r\n{\r\ncommview_header_t cv_hdr;\r\nstruct tm tm;\r\nguint frequency;\r\nif(!commview_read_header(&cv_hdr, fh, err, err_info))\r\nreturn FALSE;\r\nswitch(cv_hdr.flags & FLAGS_MEDIUM) {\r\ncase MEDIUM_ETHERNET :\r\nphdr->pkt_encap = WTAP_ENCAP_ETHERNET;\r\nphdr->pseudo_header.eth.fcs_len = -1;\r\nbreak;\r\ncase MEDIUM_WIFI :\r\nphdr->pkt_encap = WTAP_ENCAP_IEEE_802_11_WITH_RADIO;\r\nmemset(&phdr->pseudo_header.ieee_802_11, 0, sizeof(phdr->pseudo_header.ieee_802_11));\r\nphdr->pseudo_header.ieee_802_11.fcs_len = -1;\r\nphdr->pseudo_header.ieee_802_11.decrypted = FALSE;\r\nphdr->pseudo_header.ieee_802_11.datapad = FALSE;\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_UNKNOWN;\r\nswitch (cv_hdr.band) {\r\ncase BAND_11A:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11A;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11a.has_turbo_type = TRUE;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11a.turbo_type =\r\nPHDR_802_11A_TURBO_TYPE_NORMAL;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, FALSE);\r\nbreak;\r\ncase BAND_11B:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11B;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, TRUE);\r\nbreak;\r\ncase BAND_11G:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11G;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11g.has_mode = TRUE;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11g.mode =\r\nPHDR_802_11G_MODE_NORMAL;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, TRUE);\r\nbreak;\r\ncase BAND_11A_TURBO:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11A;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11a.has_turbo_type = TRUE;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11a.turbo_type =\r\nPHDR_802_11A_TURBO_TYPE_TURBO;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, FALSE);\r\nbreak;\r\ncase BAND_SUPERG:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11G;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11g.has_mode = TRUE;\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11g.mode =\r\nPHDR_802_11G_MODE_SUPER_G;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, TRUE);\r\nbreak;\r\ncase BAND_11N_5GHZ:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11N;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, FALSE);\r\nbreak;\r\ncase BAND_11N_2_4GHZ:\r\nphdr->pseudo_header.ieee_802_11.phy = PHDR_802_11_PHY_11N;\r\nfrequency = ieee80211_chan_to_mhz(cv_hdr.channel, TRUE);\r\nbreak;\r\ncase BAND_PUBLIC_SAFETY:\r\nfrequency = 0;\r\nbreak;\r\ndefault:\r\nfrequency = 0;\r\nbreak;\r\n}\r\nif (frequency != 0) {\r\nphdr->pseudo_header.ieee_802_11.has_frequency = TRUE;\r\nphdr->pseudo_header.ieee_802_11.frequency = frequency;\r\n}\r\nphdr->pseudo_header.ieee_802_11.has_channel = TRUE;\r\nphdr->pseudo_header.ieee_802_11.channel = cv_hdr.channel;\r\nphdr->pseudo_header.ieee_802_11.has_data_rate = TRUE;\r\nphdr->pseudo_header.ieee_802_11.data_rate =\r\ncv_hdr.rate | (cv_hdr.direction << 8);\r\nphdr->pseudo_header.ieee_802_11.has_signal_percent = TRUE;\r\nphdr->pseudo_header.ieee_802_11.signal_percent = cv_hdr.signal_level_percent;\r\nif (cv_hdr.signal_level_dbm != 0) {\r\nphdr->pseudo_header.ieee_802_11.signal_dbm = -cv_hdr.signal_level_dbm;\r\nphdr->pseudo_header.ieee_802_11.has_signal_dbm = TRUE;\r\n}\r\nif (cv_hdr.noise_level != 0) {\r\nphdr->pseudo_header.ieee_802_11.noise_dbm = -cv_hdr.noise_level;\r\nphdr->pseudo_header.ieee_802_11.has_noise_dbm = TRUE;\r\n}\r\nbreak;\r\ncase MEDIUM_TOKEN_RING :\r\nphdr->pkt_encap = WTAP_ENCAP_TOKEN_RING;\r\nbreak;\r\ndefault :\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("commview: unsupported encap: %u",\r\ncv_hdr.flags & FLAGS_MEDIUM);\r\nreturn FALSE;\r\n}\r\ntm.tm_year = cv_hdr.year - 1900;\r\ntm.tm_mon = cv_hdr.month - 1;\r\ntm.tm_mday = cv_hdr.day;\r\ntm.tm_hour = cv_hdr.hours;\r\ntm.tm_min = cv_hdr.minutes;\r\ntm.tm_sec = cv_hdr.seconds;\r\ntm.tm_isdst = -1;\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = WTAP_HAS_TS;\r\nphdr->len = cv_hdr.data_len;\r\nphdr->caplen = cv_hdr.data_len;\r\nphdr->ts.secs = mktime(&tm);\r\nphdr->ts.nsecs = cv_hdr.usecs * 1000;\r\nreturn wtap_read_packet_bytes(fh, buf, phdr->caplen, err, err_info);\r\n}\r\nstatic gboolean\r\ncommview_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\n*data_offset = file_tell(wth->fh);\r\nreturn commview_read_packet(wth->fh, &wth->phdr, wth->frame_buffer, err,\r\nerr_info);\r\n}\r\nstatic gboolean\r\ncommview_seek_read(wtap *wth, gint64 seek_off, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nif(file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nreturn commview_read_packet(wth->random_fh, phdr, buf, err, err_info);\r\n}\r\nstatic gboolean\r\ncommview_read_header(commview_header_t *cv_hdr, FILE_T fh, int *err,\r\ngchar **err_info)\r\n{\r\nif (!wtap_read_bytes_or_eof(fh, &cv_hdr->data_len, 2, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->source_data_len, 2, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->version, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->year, 2, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->month, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->day, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->hours, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->minutes, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->seconds, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->usecs, 4, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->flags, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->signal_level_percent, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->rate, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->band, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->channel, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->direction, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->signal_level_dbm, 1, err, err_info))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(fh, &cv_hdr->noise_level, 1, err, err_info))\r\nreturn FALSE;\r\ncv_hdr->data_len = GUINT16_FROM_LE(cv_hdr->data_len);\r\ncv_hdr->source_data_len = GUINT16_FROM_LE(cv_hdr->source_data_len);\r\ncv_hdr->year = GUINT16_FROM_LE(cv_hdr->year);\r\ncv_hdr->usecs = GUINT32_FROM_LE(cv_hdr->usecs);\r\nreturn TRUE;\r\n}\r\nint commview_dump_can_write_encap(int encap)\r\n{\r\nswitch (encap) {\r\ncase WTAP_ENCAP_ETHERNET :\r\ncase WTAP_ENCAP_IEEE_802_11 :\r\ncase WTAP_ENCAP_IEEE_802_11_WITH_RADIO :\r\ncase WTAP_ENCAP_TOKEN_RING :\r\ncase WTAP_ENCAP_PER_PACKET :\r\nreturn 0;\r\ndefault:\r\nreturn WTAP_ERR_UNWRITABLE_ENCAP;\r\n}\r\n}\r\ngboolean commview_dump_open(wtap_dumper *wdh, int *err _U_)\r\n{\r\nwdh->subtype_write = commview_dump;\r\nwdh->bytes_dumped = 0;\r\nreturn TRUE;\r\n}\r\nstatic gboolean commview_dump(wtap_dumper *wdh,\r\nconst struct wtap_pkthdr *phdr,\r\nconst guint8 *pd, int *err, gchar **err_info _U_)\r\n{\r\ncommview_header_t cv_hdr;\r\nstruct tm *tm;\r\nif (phdr->rec_type != REC_TYPE_PACKET) {\r\n*err = WTAP_ERR_UNWRITABLE_REC_TYPE;\r\nreturn FALSE;\r\n}\r\nif (phdr->caplen > 65535) {\r\n*err = WTAP_ERR_PACKET_TOO_LARGE;\r\nreturn FALSE;\r\n}\r\nmemset(&cv_hdr, 0, sizeof(cv_hdr));\r\ncv_hdr.data_len = GUINT16_TO_LE((guint16)phdr->caplen);\r\ncv_hdr.source_data_len = GUINT16_TO_LE((guint16)phdr->caplen);\r\ncv_hdr.version = 0;\r\ntm = localtime(&phdr->ts.secs);\r\ncv_hdr.year = tm->tm_year + 1900;\r\ncv_hdr.month = tm->tm_mon + 1;\r\ncv_hdr.day = tm->tm_mday;\r\ncv_hdr.hours = tm->tm_hour;\r\ncv_hdr.minutes = tm->tm_min;\r\ncv_hdr.seconds = tm->tm_sec;\r\ncv_hdr.usecs = GUINT32_TO_LE(phdr->ts.nsecs / 1000);\r\nswitch(phdr->pkt_encap) {\r\ncase WTAP_ENCAP_ETHERNET :\r\ncv_hdr.flags |= MEDIUM_ETHERNET;\r\nbreak;\r\ncase WTAP_ENCAP_IEEE_802_11 :\r\ncv_hdr.flags |= MEDIUM_WIFI;\r\nbreak;\r\ncase WTAP_ENCAP_IEEE_802_11_WITH_RADIO :\r\ncv_hdr.flags |= MEDIUM_WIFI;\r\nswitch (phdr->pseudo_header.ieee_802_11.phy) {\r\ncase PHDR_802_11_PHY_11A:\r\nif (!phdr->pseudo_header.ieee_802_11.phy_info.info_11a.has_turbo_type ||\r\nphdr->pseudo_header.ieee_802_11.phy_info.info_11a.turbo_type == PHDR_802_11A_TURBO_TYPE_NORMAL)\r\ncv_hdr.band = BAND_11A;\r\nelse\r\ncv_hdr.band = BAND_11A_TURBO;\r\nbreak;\r\ncase PHDR_802_11_PHY_11B:\r\ncv_hdr.band = BAND_11B;\r\nbreak;\r\ncase PHDR_802_11_PHY_11G:\r\nif (!phdr->pseudo_header.ieee_802_11.phy_info.info_11g.has_mode)\r\ncv_hdr.band = BAND_11G;\r\nelse {\r\nswitch (phdr->pseudo_header.ieee_802_11.phy_info.info_11g.mode) {\r\ncase PHDR_802_11G_MODE_NORMAL:\r\ncv_hdr.band = BAND_11G;\r\nbreak;\r\ncase PHDR_802_11G_MODE_SUPER_G:\r\ncv_hdr.band = BAND_SUPERG;\r\nbreak;\r\ndefault:\r\ncv_hdr.band = BAND_11G;\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase PHDR_802_11_PHY_11N:\r\nif (phdr->pseudo_header.ieee_802_11.has_frequency) {\r\nif (phdr->pseudo_header.ieee_802_11.frequency > 2484) {\r\ncv_hdr.band = BAND_11N_5GHZ;\r\n} else {\r\ncv_hdr.band = BAND_11N_2_4GHZ;\r\n}\r\n} else {\r\ncv_hdr.band = 0;\r\n}\r\nbreak;\r\ndefault:\r\ncv_hdr.band = 0;\r\nbreak;\r\n}\r\ncv_hdr.channel =\r\nphdr->pseudo_header.ieee_802_11.has_channel ?\r\nphdr->pseudo_header.ieee_802_11.channel :\r\n0;\r\ncv_hdr.rate =\r\nphdr->pseudo_header.ieee_802_11.has_data_rate ?\r\n(guint8)(phdr->pseudo_header.ieee_802_11.data_rate & 0xFF) :\r\n0;\r\ncv_hdr.direction =\r\nphdr->pseudo_header.ieee_802_11.has_data_rate ?\r\n(guint8)((phdr->pseudo_header.ieee_802_11.data_rate >> 8) & 0xFF) :\r\n0;\r\ncv_hdr.signal_level_percent =\r\nphdr->pseudo_header.ieee_802_11.has_signal_percent ?\r\nphdr->pseudo_header.ieee_802_11.signal_percent :\r\n0;\r\ncv_hdr.signal_level_dbm =\r\nphdr->pseudo_header.ieee_802_11.has_signal_dbm ?\r\n-phdr->pseudo_header.ieee_802_11.signal_dbm :\r\n0;\r\ncv_hdr.noise_level =\r\nphdr->pseudo_header.ieee_802_11.has_noise_dbm ?\r\n-phdr->pseudo_header.ieee_802_11.noise_dbm :\r\n0;\r\nbreak;\r\ncase WTAP_ENCAP_TOKEN_RING :\r\ncv_hdr.flags |= MEDIUM_TOKEN_RING;\r\nbreak;\r\ndefault :\r\n*err = WTAP_ERR_UNWRITABLE_ENCAP;\r\nreturn FALSE;\r\n}\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.data_len, 2, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.source_data_len, 2, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.version, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.year, 2, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.month, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.day, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.hours, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.minutes, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.seconds, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.usecs, 4, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.flags, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.signal_level_percent, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.rate, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.band, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.channel, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.direction, 1, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.signal_level_dbm, 2, err))\r\nreturn FALSE;\r\nif (!wtap_dump_file_write(wdh, &cv_hdr.noise_level, 2, err))\r\nreturn FALSE;\r\nwdh->bytes_dumped += COMMVIEW_HEADER_SIZE;\r\nif (!wtap_dump_file_write(wdh, pd, phdr->caplen, err))\r\nreturn FALSE;\r\nwdh->bytes_dumped += phdr->caplen;\r\nreturn TRUE;\r\n}

static int\r\ndissect_gmr1_dtap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint32 len, offset;\r\ngmr1_msg_func_t msg_func;\r\nconst gchar *msg_str;\r\ngint ett_tree;\r\nint hf_idx;\r\nproto_item *dtap_item = NULL;\r\nproto_tree *dtap_tree = NULL;\r\nguint32 oct[2];\r\nguint8 pd;\r\nlen = tvb_captured_length(tvb);\r\noffset = 0;\r\noct[0] = tvb_get_guint8(tvb, offset++);\r\nif ((oct[0] & GMR1_PD_EXT_MSK) == GMR1_PD_EXT_VAL)\r\npd = oct[0] & 0xff;\r\nelse\r\npd = oct[0] & 0x0f;\r\nif (pd != GMR1_PD_RR) {\r\ncall_dissector(gsm_dtap_handle, tvb, pinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (DTAP) ");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "(%s) ",\r\nval_to_str(pd, gmr1_pd_short_vals, "Unknown (%u)"));\r\noct[1] = tvb_get_guint8(tvb, offset);\r\ngmr1_get_msg_params((gmr1_pd_e)pd, oct[1], &msg_str, &ett_tree, &hf_idx, &msg_func);\r\nif (msg_str == NULL)\r\n{\r\ndtap_item = proto_tree_add_protocol_format(\r\ntree, proto_gmr1_dtap, tvb, 0, len,\r\n"GMR-1 DTAP - Message Type (0x%02x)", oct[1]);\r\ndtap_tree = proto_item_add_subtree(dtap_item, ett_gmr1_dtap);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Message Type (0x%02x) ", oct[1]);\r\n}\r\nelse\r\n{\r\ndtap_item = proto_tree_add_protocol_format(\r\ntree, proto_gmr1_dtap, tvb, 0, -1,\r\n"GMR-1 DTAP - %s", msg_str);\r\ndtap_tree = proto_item_add_subtree(dtap_item, ett_gmr1_dtap);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s ", msg_str);\r\n}\r\noffset = 0;\r\nproto_tree_add_uint(\r\ndtap_tree, hf_gmr1_dtap_protocol_discriminator, tvb, 1, 1, pd);\r\noffset++;\r\nproto_tree_add_uint_format(\r\ndtap_tree, hf_idx, tvb, offset, 1, oct[1],\r\n"Message Type: %s", msg_str ? msg_str : "(Unknown)"\r\n);\r\noffset++;\r\nif (msg_func) {\r\n(*msg_func)(tvb, dtap_tree, pinfo, offset, len - offset);\r\n} else {\r\nproto_tree_add_item(dtap_tree, hf_gmr1_dtap_message_elements, tvb, offset, len - offset, ENC_NA);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_gmr1_dtap(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_gmr1_dtap_protocol_discriminator,\r\n{ "Protocol Discriminator", "gmr1.dtap.protocol_discriminator",\r\nFT_UINT8, BASE_DEC, VALS(gmr1_pd_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_gmr1_dtap_message_elements,\r\n{ "Message elements", "gmr1.dtap.message_elements",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_gmr1_dtap,\r\n&ett_gmr1_pd,\r\n};\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_gmr1_dtap = proto_register_protocol("GEO-Mobile Radio (1) DTAP", "GMR-1 DTAP", "gmr1.dtap");\r\nproto_register_field_array(proto_gmr1_dtap, hf, array_length(hf));\r\nregister_dissector("gmr1_dtap", dissect_gmr1_dtap, proto_gmr1_dtap);\r\n}\r\nvoid\r\nproto_reg_handoff_gmr1_dtap(void)\r\n{\r\ndissector_handle_t dtap_handle;\r\ndtap_handle = find_dissector("gmr1_dtap");\r\ndissector_add_uint("lapsat.sapi", 0 , dtap_handle);\r\ndissector_add_uint("lapsat.sapi", 3 , dtap_handle);\r\ngsm_dtap_handle = find_dissector_add_dependency("gsm_a_dtap", proto_gmr1_dtap);\r\n}

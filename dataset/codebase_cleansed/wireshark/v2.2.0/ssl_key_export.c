int\r\nssl_session_key_count(void)\r\n{\r\nreturn g_hash_table_size(ssl_session_hash) +\r\ng_hash_table_size(ssl_crandom_hash);\r\n}\r\nstatic void\r\nssl_export_sessions_func(gpointer key, gpointer value, gpointer user_data)\r\n{\r\nguint i;\r\nStringInfo *sslid = (StringInfo *)key;\r\nStringInfo *master_secret = (StringInfo *)value;\r\nGString *keylist = (GString *)user_data;\r\ng_string_append(keylist, "RSA Session-ID:");\r\nfor (i = 0; i < sslid->data_len; i++) {\r\ng_string_append_printf(keylist, "%.2x", sslid->data[i]);\r\n}\r\ng_string_append(keylist, " Master-Key:");\r\nfor (i = 0; i < master_secret->data_len; i++) {\r\ng_string_append_printf(keylist, "%.2x", master_secret->data[i]);\r\n}\r\ng_string_append_c(keylist, '\n');\r\n}\r\nstatic void\r\nssl_export_client_randoms_func(gpointer key, gpointer value, gpointer user_data)\r\n{\r\nguint i;\r\nStringInfo *client_random = (StringInfo *)key;\r\nStringInfo *master_secret = (StringInfo *)value;\r\nGString *keylist = (GString *)user_data;\r\ng_string_append(keylist, "CLIENT_RANDOM ");\r\nfor (i = 0; i < client_random->data_len; i++) {\r\ng_string_append_printf(keylist, "%.2x", client_random->data[i]);\r\n}\r\ng_string_append_c(keylist, ' ');\r\nfor (i = 0; i < master_secret->data_len; i++) {\r\ng_string_append_printf(keylist, "%.2x", master_secret->data[i]);\r\n}\r\ng_string_append_c(keylist, '\n');\r\n}\r\ngchar*\r\nssl_export_sessions(void)\r\n{\r\ngsize len = 189 * g_hash_table_size(ssl_session_hash) +\r\n177 * g_hash_table_size(ssl_crandom_hash);\r\nGString *keylist = g_string_sized_new(len);\r\ng_hash_table_foreach(ssl_session_hash, ssl_export_sessions_func, (gpointer)keylist);\r\ng_hash_table_foreach(ssl_crandom_hash, ssl_export_client_randoms_func, (gpointer)keylist);\r\nreturn g_string_free(keylist, FALSE);\r\n}

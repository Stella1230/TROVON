static int\r\ndissect_udpencap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ntvbuff_t *next_tvb;\r\nproto_tree *udpencap_tree;\r\nproto_item *ti;\r\nguint32 spi;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "UDPENCAP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_udpencap, tvb, 0, -1, ENC_NA);\r\nudpencap_tree = proto_item_add_subtree(ti, ett_udpencap);\r\nif ((tvb_captured_length(tvb) == 1) && (tvb_get_guint8(tvb, 0) == 0xff)) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "NAT-keepalive");\r\nproto_tree_add_item(udpencap_tree, hf_nat_keepalive, tvb, 0, 1, ENC_NA);\r\n} else {\r\nspi = tvb_get_ntohl(tvb, 0);\r\nif (spi == 0) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "ISAKMP");\r\nproto_tree_add_item(udpencap_tree, hf_non_esp_marker, tvb, 0, 4, ENC_NA);\r\nproto_item_set_len(ti, 4);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 4);\r\ncall_dissector(isakmp_handle, next_tvb, pinfo, tree);\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "ESP");\r\nproto_item_set_len(ti, 0);\r\ncall_dissector(esp_handle, tvb, pinfo, tree);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_udpencap(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_nat_keepalive, { "NAT-keepalive packet", "udpencap.nat_keepalive",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_non_esp_marker, { "Non-ESP Marker", "udpencap.non_esp_marker",\r\nFT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_udpencap,\r\n};\r\nproto_udpencap = proto_register_protocol(\r\n"UDP Encapsulation of IPsec Packets", "UDPENCAP", "udpencap");\r\nproto_register_field_array(proto_udpencap, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_udpencap(void)\r\n{\r\ndissector_handle_t udpencap_handle;\r\nesp_handle = find_dissector_add_dependency("esp", proto_udpencap);\r\nisakmp_handle = find_dissector_add_dependency("isakmp", proto_udpencap);\r\nudpencap_handle = create_dissector_handle(dissect_udpencap, proto_udpencap);\r\ndissector_add_uint("udp.port", 4500, udpencap_handle);\r\n}

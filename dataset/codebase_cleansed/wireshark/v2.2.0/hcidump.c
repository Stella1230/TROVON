static gboolean hcidump_read_packet(FILE_T fh, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nstruct dump_hdr dh;\r\nint packet_size;\r\nif (!wtap_read_bytes_or_eof(fh, &dh, DUMP_HDR_SIZE, err, err_info))\r\nreturn FALSE;\r\npacket_size = GUINT16_FROM_LE(dh.len);\r\nif (packet_size > WTAP_MAX_PACKET_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("hcidump: File has %u-byte packet, bigger than maximum of %u",\r\npacket_size, WTAP_MAX_PACKET_SIZE);\r\nreturn FALSE;\r\n}\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = WTAP_HAS_TS;\r\nphdr->ts.secs = GUINT32_FROM_LE(dh.ts_sec);\r\nphdr->ts.nsecs = GUINT32_FROM_LE(dh.ts_usec) * 1000;\r\nphdr->caplen = packet_size;\r\nphdr->len = packet_size;\r\nphdr->pseudo_header.p2p.sent = (dh.in ? FALSE : TRUE);\r\nreturn wtap_read_packet_bytes(fh, buf, packet_size, err, err_info);\r\n}\r\nstatic gboolean hcidump_read(wtap *wth, int *err, gchar **err_info,\r\ngint64 *data_offset)\r\n{\r\n*data_offset = file_tell(wth->fh);\r\nreturn hcidump_read_packet(wth->fh, &wth->phdr, wth->frame_buffer,\r\nerr, err_info);\r\n}\r\nstatic gboolean hcidump_seek_read(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf, int *err, gchar **err_info)\r\n{\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nreturn hcidump_read_packet(wth->random_fh, phdr, buf, err, err_info);\r\n}\r\nwtap_open_return_val hcidump_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nstruct dump_hdr dh;\r\nguint8 type;\r\nif (!wtap_read_bytes(wth->fh, &dh, DUMP_HDR_SIZE, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif ((dh.in != 0 && dh.in != 1) || dh.pad != 0\r\n|| GUINT16_FROM_LE(dh.len) < 1)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (!wtap_read_bytes(wth->fh, &type, 1, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (type < 1 || type > 4)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (file_seek(wth->fh, 0, SEEK_SET, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_HCIDUMP;\r\nwth->file_encap = WTAP_ENCAP_BLUETOOTH_H4_WITH_PHDR;\r\nwth->snapshot_length = 0;\r\nwth->subtype_read = hcidump_read;\r\nwth->subtype_seek_read = hcidump_seek_read;\r\nwth->file_tsprec = WTAP_TSPREC_USEC;\r\nreturn WTAP_OPEN_MINE;\r\n}

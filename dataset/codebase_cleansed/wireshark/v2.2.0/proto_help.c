void proto_help_menu_modify(GtkTreeSelection *selection _U_, capture_file *cf _U_) {}\r\nvoid proto_help_menu_init(GtkWidget *widget _U_) {}\r\nvoid proto_help_init(void) {}\r\nvoid proto_help_init(void)\r\n{\r\ngchar *search_dir[PH_CONF_DIRS];\r\nconst gchar *ini_name;\r\ngchar *ini_path;\r\nGDir *conf_dir;\r\nint i;\r\nsearch_dir[0] = g_strdup_printf("%s" G_DIR_SEPARATOR_S PH_CONFFILE_SUBDIR, get_datafile_dir());\r\nsearch_dir[1] = get_persconffile_path(PH_CONFFILE_SUBDIR, FALSE, FALSE);\r\n#ifdef PH_DEBUG_LOG\r\ng_log_set_handler(NULL, G_LOG_LEVEL_MASK | G_LOG_FLAG_FATAL | G_LOG_FLAG_RECURSION, ph_logging_handler, NULL);\r\n#endif\r\nif (g_ph_key_files)\r\nreturn;\r\ng_ph_key_files = g_ptr_array_new();\r\n#ifdef PH_DEBUG_LOG\r\nph_log_path = g_strdup_printf("%s" G_DIR_SEPARATOR_S "%s", g_get_tmp_dir(), PH_FILE_LOG);\r\n#endif\r\nfor (i = 0; i < PH_CONF_DIRS; i++) {\r\ng_log(NULL, G_LOG_LEVEL_INFO, "Looking for protocol help files in '%s'", search_dir[i]);\r\nconf_dir = g_dir_open(search_dir[i], 0, NULL);\r\nif (!conf_dir) {\r\ncontinue;\r\n}\r\nwhile ((ini_name = g_dir_read_name(conf_dir)) != NULL) {\r\nif (! g_str_has_suffix(ini_name, PH_INI_SUFFIX)) {\r\ncontinue;\r\n}\r\ng_log(NULL, G_LOG_LEVEL_INFO, "-- Found '%s'", ini_name);\r\nini_path = g_strdup_printf("%s" G_DIR_SEPARATOR_S "%s", search_dir[i], ini_name);\r\nph_ini_load_file(ini_path);\r\ng_free(ini_path);\r\n}\r\ng_dir_close(conf_dir);\r\n}\r\n}\r\nvoid proto_help_menu_init(GtkWidget *widget)\r\n{\r\ng_ph_menu_factory = gtk_item_factory_from_widget(widget);\r\nph_menu_reset();\r\n}\r\nstatic void ph_menu_reset(void)\r\n{\r\nGtkWidget *menu_item = NULL;\r\nGList *menu_entries = NULL;\r\nGList *menu_entry = NULL;\r\nif(!g_ph_menu_factory) return;\r\nmenu_item = gtk_item_factory_get_widget(g_ph_menu_factory, PH_MENU_TOP);\r\nmenu_entries = gtk_container_get_children(GTK_CONTAINER(menu_item));\r\nfor(menu_entry = g_list_first(menu_entries); menu_entry != NULL; menu_entry = g_list_next(menu_entry))\r\n{\r\ngtk_container_remove(GTK_CONTAINER(menu_item), menu_entry->data);\r\n}\r\nmenu_item = gtk_item_factory_get_item(g_ph_menu_factory, PH_MENU_TOP);\r\ngtk_widget_set_sensitive(menu_item, FALSE);\r\n}\r\nstatic void\r\nurl_destroy_cb(GtkWidget *w _U_, gpointer url) {\r\ng_free(url);\r\n}\r\nvoid proto_help_menu_modify(GtkTreeSelection *selection, capture_file *cf)\r\n{\r\ngchar *description;\r\nconst gchar *proto_abbrev, *proto_name;\r\ngchar *value;\r\ngchar **keys;\r\nGHashTable *table;\r\nguint i = 0, cur_kf;\r\nGtkWidget *menu_item = NULL;\r\nGtkItemFactoryEntry *menu_entry = NULL;\r\nproto_help_key_file* phkf;\r\ngchar *loc;\r\ngboolean add_separator = FALSE;\r\ngboolean found = FALSE;\r\nif(!g_ph_menu_factory) return;\r\nph_menu_reset();\r\nproto_abbrev = ph_capture_get_protocol_abbrev(selection, cf);\r\nif(!proto_abbrev) return;\r\nproto_name = ph_capture_get_protocol_name(selection, cf);\r\nif(!proto_name) return;\r\ndescription = ph_capture_get_description(cf);\r\nfor (cur_kf = 0; cur_kf < g_ph_key_files->len; cur_kf++) {\r\nphkf = (proto_help_key_file *) g_ptr_array_index(g_ph_key_files, cur_kf);\r\ng_assert(phkf);\r\nvalue = ph_ini_get_path(phkf->keyfile, proto_abbrev, PH_INI_KEY_OVERVIEW);\r\nif(!value)\r\n{\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Overview page of the protocol '%s' is not defined", proto_abbrev);\r\ncontinue;\r\n}\r\nloc = string_replace(phkf->loc_template, PH_PATH_SEARCH_STR, value);\r\ng_free(value);\r\nif (!loc || !strlen(loc)) continue;\r\nif (add_separator) {\r\nmenu_entry = g_malloc0(sizeof(GtkItemFactoryEntry));\r\nmenu_entry->path = g_strdup_printf("%s/<separator>", PH_MENU_TOP);\r\nmenu_entry->item_type = "<Separator>";\r\ngtk_item_factory_create_item(g_ph_menu_factory, menu_entry, NULL, 2);\r\n}\r\nadd_separator = TRUE;\r\nmenu_entry = g_malloc0(sizeof(GtkItemFactoryEntry));\r\nmenu_entry->path = g_strdup_printf("%s/%s %s Overview", PH_MENU_TOP, phkf->source, proto_name);\r\nmenu_entry->callback = ph_menu_onclick;\r\ngtk_item_factory_create_item(g_ph_menu_factory, menu_entry, loc, 2);\r\nmenu_item = gtk_item_factory_get_widget(g_ph_menu_factory, menu_entry->path);\r\ng_assert(menu_item);\r\ng_signal_connect(menu_item, "destroy", G_CALLBACK(url_destroy_cb), loc);\r\nfound = TRUE;\r\nif(description)\r\n{\r\nkeys = ph_ini_get_keywords(phkf->keyfile, proto_abbrev);\r\ntable = g_hash_table_new_full(g_str_hash, g_str_equal, g_free, NULL);\r\nfor(i = 0; keys[i] != NULL; i++)\r\n{\r\nif(!strcmp(keys[i], PH_INI_KEY_OVERVIEW)) continue;\r\nif(!ph_parse_string(description, keys[i])) continue;\r\nif(g_hash_table_lookup(table, g_ascii_strup(keys[i], -1)) != NULL) continue;\r\nvalue = ph_ini_get_path(phkf->keyfile, proto_abbrev, keys[i]);\r\nif(!value || !strlen(value)) continue;\r\nloc = string_replace(phkf->loc_template, PH_PATH_SEARCH_STR, value);\r\ng_free(value);\r\nif (!loc || !strlen(loc)) continue;\r\ng_hash_table_insert(table, g_ascii_strup(keys[i], -1), GINT_TO_POINTER(1));\r\nmenu_entry = g_malloc0(sizeof(GtkItemFactoryEntry));\r\nmenu_entry->path = g_strdup_printf("%s/%s", PH_MENU_TOP, keys[i]);\r\nmenu_entry->callback = ph_menu_onclick;\r\ngtk_item_factory_create_item(g_ph_menu_factory, menu_entry, loc, 2);\r\nmenu_item = gtk_item_factory_get_widget(g_ph_menu_factory, menu_entry->path);\r\ng_assert(menu_item);\r\ng_signal_connect(menu_item, "destroy", G_CALLBACK(url_destroy_cb), loc);\r\n}\r\ng_hash_table_destroy(table);\r\n}\r\n}\r\ng_free(description);\r\nmenu_item = gtk_item_factory_get_item(g_ph_menu_factory, PH_MENU_TOP);\r\ngtk_widget_set_sensitive(menu_item, found);\r\n}\r\nstatic void ph_menu_onclick(GtkWidget *widget _U_, gpointer data, guint action _U_)\r\n{\r\ngchar *loc = (gchar *) data;\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Sending '%s' to the browser.", loc);\r\nif (! loc) {\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Protocol help ended up with a NULL URL.");\r\nreturn;\r\n}\r\nif (! browser_open_url(loc)) {\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Couldn't get protocol help for %s", loc);\r\n}\r\n}\r\nstatic int\r\nph_capture_get_protocol_id(GtkTreeSelection *selection, capture_file *cf)\r\n{\r\nGtkTreeModel *model = NULL;\r\nGtkTreeIter iter;\r\nGtkTreeIter parent;\r\nfield_info *finfo = NULL;\r\nint proto_id = 0;\r\nif(!cf->finfo_selected) return 0;\r\nproto_id = cf->finfo_selected->hfinfo->id;\r\nif(!proto_id)\r\n{\r\nif(!gtk_tree_selection_get_selected(GTK_TREE_SELECTION(selection), &model, &iter)) return 0;\r\nwhile(gtk_tree_model_iter_parent(model, &parent, &iter))\r\n{\r\ngtk_tree_model_get(model, &parent, 1, &finfo, -1);\r\niter = parent;\r\nif(finfo->hfinfo->id > 0)\r\n{\r\nproto_id = finfo->hfinfo->id;\r\nbreak;\r\n}\r\n}\r\n}\r\nwhile(proto_id && !proto_registrar_is_protocol(proto_id))\r\n{\r\nproto_id = proto_registrar_get_parent(proto_id);\r\n}\r\nreturn proto_id;\r\n}\r\nstatic const gchar*\r\nph_capture_get_protocol_name(GtkTreeSelection *selection, capture_file *cf)\r\n{\r\nint proto_id = ph_capture_get_protocol_id(selection, cf);\r\nreturn (!proto_id) ? NULL : proto_get_protocol_short_name(find_protocol_by_id(proto_id));\r\n}\r\nstatic const gchar*\r\nph_capture_get_protocol_abbrev(GtkTreeSelection *selection, capture_file *cf)\r\n{\r\nint proto_id = ph_capture_get_protocol_id(selection, cf);\r\nreturn (!proto_id) ? NULL : proto_registrar_get_abbrev(proto_id);\r\n}\r\nstatic gchar* ph_capture_get_description(capture_file *cf)\r\n{\r\ngchar *buffer = NULL;\r\nif(cf->finfo_selected->rep &&\r\nstrlen(cf->finfo_selected->rep->representation) > 0)\r\n{\r\nbuffer = g_strdup(cf->finfo_selected->rep->representation);\r\n}\r\nelse\r\n{\r\nbuffer = g_malloc(ITEM_LABEL_LENGTH);\r\nproto_item_fill_label(cf->finfo_selected, buffer);\r\n}\r\nreturn buffer;\r\n}\r\nstatic proto_help_key_file *\r\nph_ini_load_file(const gchar *filename)\r\n{\r\nGKeyFile *kf;\r\nGError *error = NULL;\r\nproto_help_key_file *phkf = NULL;\r\ngchar *old_template, *loc_template;\r\ngchar **loc_data, *loc_repl, *loc_search;\r\ngsize i, len;\r\nif(!g_file_test(filename, G_FILE_TEST_EXISTS))\r\n{\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Configuration file %s does not exists", filename);\r\nreturn NULL;\r\n}\r\nkf = g_key_file_new();\r\nif(!g_key_file_load_from_file(kf, filename, G_KEY_FILE_NONE, &error))\r\n{\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Configuration file '%s' could not be loaded (%s)", filename, error->message);\r\ng_error_free(error);\r\ng_key_file_free(kf);\r\nreturn NULL;\r\n}\r\nloc_template = ph_ini_get_value(kf, PH_INI_GROUP_DATABASE, PH_INI_DB_KEY_LOCATION_TEMPLATE, NULL);\r\nif (!loc_template) {\r\ng_key_file_free(kf);\r\nreturn NULL;\r\n}\r\nloc_data = g_key_file_get_keys(kf, PH_INI_GROUP_LOCATION_DATA, &len, NULL);\r\nif (loc_data) {\r\nfor (i = 0; i < len; i++) {\r\nloc_repl = ph_ini_get_value(kf, PH_INI_GROUP_LOCATION_DATA, loc_data[i], NULL);\r\nold_template = loc_template;\r\nloc_search = g_strdup_printf("${%s}", loc_data[i]);\r\nloc_template = string_replace(loc_template, loc_search, loc_repl);\r\ng_free(loc_repl);\r\ng_free(loc_search);\r\ng_free(old_template);\r\n}\r\n}\r\nif (!strstr(loc_template, PH_PATH_SEARCH_STR)) {\r\nold_template = loc_template;\r\nloc_template = g_strdup_printf("%s" PH_PATH_SEARCH_STR, old_template);\r\ng_free(old_template);\r\n}\r\nphkf = g_malloc(sizeof(proto_help_key_file));\r\nphkf->keyfile = kf;\r\nphkf->source = ph_ini_get_value(kf, PH_INI_GROUP_DATABASE, PH_INI_DB_KEY_SOURCE, "(Unknown source)");\r\nphkf->loc_template = loc_template;\r\ng_ptr_array_add(g_ph_key_files, phkf);\r\nreturn phkf;\r\n}\r\nstatic gchar*\r\nph_ini_get_value(GKeyFile *keyfile, const gchar *group, const gchar *key, gchar *alt)\r\n{\r\ngchar *value = NULL;\r\nif (keyfile) {\r\nvalue = g_key_file_get_string(keyfile, group, key, NULL);\r\n}\r\nif (!value) {\r\nvalue = g_strdup(alt);\r\n}\r\nreturn value;\r\n}\r\nstatic gchar*\r\nph_ini_get_path(GKeyFile *keyfile, const gchar *protocol, const gchar *keyword)\r\n{\r\nGError *error = NULL;\r\ngchar *map;\r\ngchar *value;\r\nif(!keyfile || !protocol || !keyword) return NULL;\r\nmap = g_key_file_get_string(keyfile, PH_INI_GROUP_MAP, protocol, &error);\r\nif(!map)\r\n{\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Protocol '%s' is not defined (%s)", protocol, error->message);\r\ng_error_free(error);\r\nreturn NULL;\r\n}\r\nvalue = g_key_file_get_string(keyfile, map, keyword, NULL);\r\ng_free(map);\r\nreturn value;\r\n}\r\nstatic gchar**\r\nph_ini_get_keywords(GKeyFile *keyfile, const gchar *protocol)\r\n{\r\nGError *error = NULL;\r\ngchar *map;\r\ngchar **keys;\r\ngsize length = 0;\r\nif(!keyfile) return NULL;\r\nmap = g_key_file_get_string(keyfile, PH_INI_GROUP_MAP, protocol, &error);\r\nif(!map)\r\n{\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Protocol '%s' is not defined (%s)", protocol, error->message);\r\ng_error_free(error);\r\nreturn NULL;\r\n}\r\nerror = NULL;\r\nkeys = g_key_file_get_keys(keyfile, map, &length, &error);\r\ng_free(map);\r\nif(!keys)\r\n{\r\ng_log(NULL, G_LOG_LEVEL_DEBUG, "Display titles are not defined (%s)", protocol);\r\ng_error_free(error);\r\n}\r\nreturn keys;\r\n}\r\nstatic guint ph_parse_string(const gchar *description, const gchar *value)\r\n{\r\nGRegex *regex = NULL;\r\nGMatchInfo *match_info = NULL;\r\ngchar *pattern = NULL;\r\nguint result = 0;\r\npattern = g_strdup_printf("(?<![0-9a-zA-Z_])%s(?![0-9a-zA-Z_])", value);\r\nregex = g_regex_new(pattern, 0, 0, NULL);\r\ng_regex_match(regex, description, 0, &match_info);\r\nif(g_match_info_matches(match_info)) result = 1;\r\ng_match_info_free(match_info);\r\ng_regex_unref(regex);\r\nreturn result;\r\n}\r\nstatic void ph_logging_handler(const gchar *domain _U_, GLogLevelFlags level, const gchar *message, gpointer data _U_)\r\n{\r\ngchar *log = NULL;\r\ngchar *type = NULL;\r\nFILE *file = NULL;\r\nstruct tm *timestamp = NULL;\r\ntime_t now;\r\ntime(&now);\r\ntimestamp = localtime(&now);\r\nswitch(level & G_LOG_LEVEL_MASK)\r\n{\r\ncase G_LOG_LEVEL_ERROR:\r\ntype = "ERR";\r\nbreak;\r\ncase G_LOG_LEVEL_DEBUG:\r\ntype = "WARNING";\r\nbreak;\r\ncase G_LOG_LEVEL_INFO:\r\ntype = "INFO";\r\nbreak;\r\ndefault:\r\ntype = "OTHER";\r\n}\r\nfile = ws_fopen(ph_log_path, "a+");\r\nif(file)\r\n{\r\nlog = g_strdup_printf("[%04u-%02u-%02u %02u:%02u:%02u %s] %s\n", timestamp->tm_year + 1900, timestamp->tm_mon + 1, timestamp->tm_mday, timestamp->tm_hour, timestamp->tm_min, timestamp->tm_sec, type, message);\r\nfputs(log, file);\r\nfclose(file);\r\n}\r\n}

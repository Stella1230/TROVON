int\r\ndissect_IDispatch_GetTypeInfoCount_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32TInfo;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_tinfo, &u32TInfo);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nint\r\ndissect_IDispatch_GetTypeInfo_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32TInfo;\r\nguint32 u32Lcid;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_tinfo, &u32TInfo);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_lcid, &u32Lcid);\r\nreturn offset;\r\n}\r\nint\r\ndissect_IDispatch_GetTypeInfo_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32HResult;\r\nguint32 u32Pointer;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_MInterfacePointer(tvb, offset, pinfo, tree, di, drep, hf_dispatch_itinfo, NULL );\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nint\r\ndissect_IDispatch_GetIDsOfNames_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ne_guid_t riid;\r\nguint32 u32Lcid;\r\ngchar szName[1000] = { 0 };\r\nguint32 u32Names;\r\nguint32 u32ArraySize;\r\nguint32 u32Pointer;\r\nguint32 u32Tmp;\r\nguint32 u32VariableOffset;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_riid, &riid);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 4;\r\nu32Tmp = u32ArraySize;\r\nwhile(u32Tmp--) {\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_LPWSTR(tvb, u32VariableOffset, pinfo, tree, di, drep,\r\nhf_dispatch_name, szName, sizeof(szName));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " \"%s\"", szName);\r\n}\r\n}\r\noffset = u32VariableOffset;\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_names, &u32Names);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_lcid, &u32Lcid);\r\nreturn offset;\r\n}\r\nint\r\ndissect_IDispatch_GetIDsOfNames_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32DispId;\r\nguint32 u32ArraySize;\r\nguint32 u32Tmp;\r\nguint32 u32HResult;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32Tmp = u32ArraySize;\r\nwhile (u32Tmp--) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_id, &u32DispId);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " ID=0x%x", u32DispId);\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nint\r\ndissect_IDispatch_Invoke_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32DispIdMember;\r\ne_guid_t riid;\r\nguint32 u32Lcid;\r\nguint32 u32Flags;\r\nguint32 u32Args;\r\nguint32 u32NamedArgs;\r\nguint32 u32Pointer;\r\nguint32 u32Pointer2;\r\nguint32 u32ArraySize;\r\nguint32 u32VariableOffset;\r\nguint32 u32VarRef;\r\nguint32 u32VarRefIdx;\r\nguint32 u32TmpOffset;\r\nguint32 u32SubStart;\r\nproto_item *dispparams_item;\r\nproto_tree *dispparams_tree;\r\nstatic const int * flags[] = {\r\n&hf_dispatch_flags_propputref,\r\n&hf_dispatch_flags_propput,\r\n&hf_dispatch_flags_propget,\r\n&hf_dispatch_flags_method,\r\nNULL\r\n};\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_id, &u32DispIdMember);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " ID=0x%x", u32DispIdMember);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_riid, &riid);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_lcid, &u32Lcid);\r\nu32TmpOffset = dissect_dcom_DWORD(tvb, offset, pinfo, NULL, di, drep, -1, &u32Flags);\r\nproto_tree_add_bitmask_value(tree, tvb, offset, hf_dispatch_flags,\r\nett_dispatch_flags, flags, u32Flags);\r\nif (u32Flags & DISPATCH_FLAGS_METHOD) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " Method");\r\n}\r\nif (u32Flags & DISPATCH_FLAGS_PROPGET) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " PropertyGet");\r\n}\r\nif (u32Flags & DISPATCH_FLAGS_PROPPUT) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " PropertyPut");\r\n}\r\nif (u32Flags & DISPATCH_FLAGS_PROPPUTREF) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " PropertyPutRef");\r\n}\r\noffset = u32TmpOffset;\r\ndispparams_item = proto_tree_add_item(tree, hf_dispatch_dispparams, tvb, offset, 0, ENC_NA);\r\ndispparams_tree = proto_item_add_subtree (dispparams_item, ett_dispatch_params);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, dispparams_tree, di, drep,\r\n&u32Pointer);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, dispparams_tree, di, drep,\r\n&u32Pointer2);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, dispparams_tree, di, drep,\r\nhf_dispatch_args, &u32Args);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, dispparams_tree, di, drep,\r\nhf_dispatch_named_args, &u32NamedArgs);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, dispparams_tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 4;\r\nwhile(u32ArraySize--) {\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, dispparams_tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, dispparams_tree, di, drep, hf_dispatch_arg);\r\n}\r\n}\r\noffset = u32VariableOffset;\r\n}\r\nif (u32Pointer2) {\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, dispparams_tree, di, drep,\r\n&u32ArraySize);\r\nwhile(u32ArraySize--) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, dispparams_tree, di, drep,\r\nhf_dispatch_id, &u32DispIdMember);\r\n}\r\n}\r\nproto_item_append_text(dispparams_item, ", Args: %u NamedArgs: %u", u32Args, u32NamedArgs);\r\nproto_item_set_len(dispparams_item, offset - u32SubStart);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_varref, &u32VarRef);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nwhile(u32ArraySize--) {\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_varrefidx, &u32VarRefIdx);\r\n}\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VariableOffset = offset + u32ArraySize * 4;\r\nwhile(u32ArraySize--) {\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, tree, di, drep, hf_dispatch_varrefarg);\r\n}\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,\r\n" Args=%u NamedArgs=%u VarRef=%u", u32Args, u32NamedArgs, u32VarRef);\r\nreturn u32VariableOffset;\r\n}\r\nint\r\ndissect_IDispatch_Invoke_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Pointer;\r\nguint32 u32Pointer2;\r\nguint32 u32Pointer3;\r\nguint32 u32VariableOffset;\r\nguint32 u32ArraySize;\r\nguint32 u32SubStart;\r\nguint16 u16Code;\r\nguint16 u16Reserved;\r\nguint32 u32HelpContext;\r\nguint32 u32Reserved;\r\nguint32 u32DeferredFillIn;\r\nguint32 u32ArgErr;\r\nguint32 u32HResult;\r\nguint32 u32SCode;\r\nguint32 u32VarRef;\r\ngchar szName[1000] = { 0 };\r\nproto_item *excepinfo_item;\r\nproto_tree *excepinfo_tree;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_VARIANT(tvb, offset, pinfo, tree, di, drep, hf_dispatch_varresult);\r\n}\r\nexcepinfo_item = proto_tree_add_item(tree, hf_dispatch_excepinfo, tvb, offset, 0, ENC_NA);\r\nexcepinfo_tree = proto_item_add_subtree (excepinfo_item, ett_dispatch_excepinfo);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_code, &u16Code);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_reserved16, &u16Reserved);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\n&u32Pointer);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\n&u32Pointer2);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\n&u32Pointer3);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_help_context, &u32HelpContext);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_reserved32, &u32Reserved);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_deferred_fill_in, &u32DeferredFillIn);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_scode, &u32SCode);\r\nif (u32Pointer) {\r\noffset = dissect_dcom_BSTR(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_source, szName, sizeof(szName));\r\n}\r\nif (u32Pointer2) {\r\noffset = dissect_dcom_BSTR(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_description, szName, sizeof(szName));\r\n}\r\nif (u32Pointer3) {\r\noffset = dissect_dcom_BSTR(tvb, offset, pinfo, excepinfo_tree, di, drep,\r\nhf_dispatch_help_file, szName, sizeof(szName));\r\n}\r\nproto_item_append_text(excepinfo_item, ", SCode: %s",\r\nval_to_str(u32SCode, dcom_hresult_vals, "Unknown (0x%08x)"));\r\nproto_item_set_len(excepinfo_item, offset - u32SubStart);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_dispatch_arg_err, &u32ArgErr);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32VarRef = u32ArraySize;\r\nu32VariableOffset = offset + u32ArraySize * 4;\r\nwhile(u32ArraySize--) {\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\nif (u32Pointer) {\r\nu32VariableOffset = dissect_dcom_VARIANT(tvb, u32VariableOffset, pinfo, tree, di, drep, hf_dispatch_varrefarg);\r\n}\r\n}\r\noffset = u32VariableOffset;\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " SCode=%s VarRef=%u -> %s",\r\nval_to_str(u32SCode, dcom_hresult_vals, "Unknown (0x%08x)"),\r\nu32VarRef,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_dcom_dispatch(void)\r\n{\r\nstatic hf_register_info hf_dispatch_array[] = {\r\n{ &hf_dispatch_opnum,\r\n{ "Operation", "dispatch.opnum", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_riid,\r\n{ "RIID", "dispatch.riid", FT_GUID, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_name,\r\n{ "Name", "dispatch.name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_names,\r\n{ "Names", "dispatch.names", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_lcid,\r\n{ "LCID", "dispatch.lcid", FT_UINT32, BASE_HEX, VALS(dcom_lcid_vals), 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_id,\r\n{ "DispID", "dispatch.id", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_flags,\r\n{ "Flags", "dispatch.flags", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_arg,\r\n{ "Argument", "dispatch.arg", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_args,\r\n{ "Args", "dispatch.args", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_named_args,\r\n{ "NamedArgs", "dispatch.named_args", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_varref,\r\n{ "VarRef", "dispatch.varref", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_varrefidx,\r\n{ "VarRefIdx", "dispatch.varrefidx", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_varrefarg,\r\n{ "VarRef", "dispatch.varrefarg", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_varresult,\r\n{ "VarResult", "dispatch.varresult", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_flags_method,\r\n{ "Method", "dispatch.flags_method", FT_BOOLEAN, 32, TFS (&tfs_set_notset), DISPATCH_FLAGS_METHOD, NULL, HFILL }},\r\n{ &hf_dispatch_flags_propget,\r\n{ "PropertyGet", "dispatch.flags_propget", FT_BOOLEAN, 32, TFS (&tfs_set_notset), DISPATCH_FLAGS_PROPGET, NULL, HFILL }},\r\n{ &hf_dispatch_flags_propput,\r\n{ "PropertyPut", "dispatch.flags_propput", FT_BOOLEAN, 32, TFS (&tfs_set_notset), DISPATCH_FLAGS_PROPPUT, NULL, HFILL }},\r\n{ &hf_dispatch_flags_propputref,\r\n{ "PropertyPutRef", "dispatch.flags_propputref", FT_BOOLEAN, 32, TFS (&tfs_set_notset), DISPATCH_FLAGS_PROPPUTREF, NULL, HFILL }},\r\n{ &hf_dispatch_code,\r\n{ "Code", "dispatch.code", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_reserved16,\r\n{ "Reserved", "dispatch.reserved16", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_source,\r\n{ "Source", "dispatch.source", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_description,\r\n{ "Description", "dispatch.description", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_help_file,\r\n{ "HelpFile", "dispatch.help_file", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_help_context,\r\n{ "HelpContext", "dispatch.help_context", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_reserved32,\r\n{ "Reserved", "dispatch.reserved32", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_deferred_fill_in,\r\n{ "DeferredFillIn", "dispatch.deferred_fill_in", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_arg_err,\r\n{ "ArgErr", "dispatch.arg_err", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_tinfo,\r\n{ "TInfo", "dispatch.tinfo", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_itinfo,\r\n{ "TInfo", "dispatch.itinfo", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_dispparams,\r\n{ "DispParams", "dispatch.dispparams", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_excepinfo,\r\n{ "ExcepInfo", "dispatch.excepinfo", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_dispatch_scode,\r\n{ "SCode", "dispatch.scode", FT_UINT32, BASE_HEX, VALS(dcom_hresult_vals), 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dispatch,\r\n&ett_dispatch_flags,\r\n&ett_dispatch_params,\r\n&ett_dispatch_excepinfo\r\n};\r\nproto_dispatch = proto_register_protocol ("DCOM IDispatch", "IDispatch", "dispatch");\r\nproto_register_field_array (proto_dispatch, hf_dispatch_array, array_length (hf_dispatch_array));\r\nproto_register_subtree_array (ett, array_length (ett));\r\n}\r\nvoid\r\nproto_reg_handoff_dcom_dispatch(void)\r\n{\r\ndcerpc_init_uuid(proto_dispatch, ett_dispatch,\r\n&uuid_dispatch, ver_dispatch,\r\ndispatch_dissectors, hf_dispatch_opnum);\r\n}

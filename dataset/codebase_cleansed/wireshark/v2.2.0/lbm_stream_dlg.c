static gchar * lbmc_stream_dlg_format_endpoint(wmem_allocator_t *allocator, const lbm_uim_stream_endpoint_t * endpoint)\r\n{\r\ngchar * buf = NULL;\r\nchar* addr_str;\r\nif (endpoint->type == lbm_uim_instance_stream)\r\n{\r\nbuf = bytes_to_str(allocator, endpoint->stream_info.ctxinst.ctxinst, sizeof(endpoint->stream_info.ctxinst.ctxinst));\r\n}\r\nelse\r\n{\r\naddr_str = (char*)address_to_str(NULL, &(endpoint->stream_info.dest.addr));\r\nbuf = wmem_strdup_printf(allocator,\r\n"%" G_GUINT32_FORMAT ":%s:%" G_GUINT16_FORMAT,\r\nendpoint->stream_info.dest.domain,\r\naddr_str,\r\nendpoint->stream_info.dest.port);\r\nwmem_free(NULL, addr_str);\r\n}\r\nreturn (buf);\r\n}\r\nstatic void lbmc_stream_dlg_stream_entry_destroy_cb(gpointer data)\r\n{\r\nlbmc_stream_dlg_stream_entry_t * stream = (lbmc_stream_dlg_stream_entry_t *)data;\r\nif (stream->substreams != NULL)\r\n{\r\ng_sequence_free(stream->substreams);\r\nstream->substreams = NULL;\r\n}\r\ng_free(data);\r\n}\r\nstatic void lbmc_stream_dlg_substream_entry_destroy_cb(gpointer data)\r\n{\r\ng_free(data);\r\n}\r\nstatic void lbmc_stream_dlg_reset_stream_table(lbmc_stream_dlg_info_t * info)\r\n{\r\nif (info->stream_table != NULL)\r\n{\r\ng_sequence_free(info->stream_table);\r\ninfo->stream_table = NULL;\r\n}\r\ninfo->stream_table = g_sequence_new(lbmc_stream_dlg_stream_entry_destroy_cb);\r\n}\r\nstatic void lbmc_stream_dlg_window_destroy_event_cb(GtkWindow * window _U_, gpointer user_data)\r\n{\r\nlbmc_stream_dlg_info_t * info = (lbmc_stream_dlg_info_t *)user_data;\r\nremove_tap_listener(info);\r\nif (info->stream_table != NULL)\r\n{\r\ng_sequence_free(info->stream_table);\r\ninfo->stream_table = NULL;\r\n}\r\nglobal_stream_dialog_info = NULL;\r\ng_free(info);\r\n}\r\nstatic GtkTreeModel * lbmc_stream_dlg_create_model(void)\r\n{\r\nGtkTreeStore * store = NULL;\r\nstore = gtk_tree_store_new(9, G_TYPE_STRING, G_TYPE_STRING, G_TYPE_STRING, G_TYPE_UINT, G_TYPE_UINT, G_TYPE_UINT, G_TYPE_UINT, G_TYPE_UINT64, G_TYPE_UINT);\r\nreturn (GTK_TREE_MODEL(store));\r\n}\r\nstatic void lbmc_stream_dlg_stream_cell_data_function(GtkTreeViewColumn * column _U_, GtkCellRenderer * renderer, GtkTreeModel * model, GtkTreeIter * iter, gpointer user_data _U_)\r\n{\r\nchar stream_buf[64];\r\nguint64 channel;\r\nguint substream_id;\r\ngtk_tree_model_get(model, iter,\r\nLBMC_STREAM_DLG_STORE_CHANNEL_COLUMN, &channel,\r\nLBMC_STREAM_DLG_STORE_SUBSTREAM_COLUMN, &substream_id,\r\n-1);\r\nif (substream_id == 0)\r\n{\r\ng_snprintf(stream_buf, (gulong)sizeof(stream_buf), "%" G_GUINT64_FORMAT, channel);\r\ng_object_set(renderer, "xalign", 0.0, NULL);\r\n}\r\nelse\r\n{\r\ng_snprintf(stream_buf, (gulong)sizeof(stream_buf), "%" G_GUINT64_FORMAT ".%u", channel, substream_id);\r\ng_object_set(renderer, "xalign", 1.0, NULL);\r\n}\r\ng_object_set(renderer, "text", stream_buf, NULL);\r\n}\r\nstatic void lbmc_stream_dlg_string_cell_data_function(GtkTreeViewColumn * column _U_, GtkCellRenderer * renderer, GtkTreeModel * model, GtkTreeIter * iter, gpointer user_data)\r\n{\r\ngchar * value = NULL;\r\ngint data_column;\r\ndata_column = GPOINTER_TO_INT(user_data);\r\ngtk_tree_model_get(model, iter, data_column, &value, -1);\r\ng_object_set(renderer, "text", value, NULL);\r\ng_object_set(renderer, "xalign", 0.0, NULL);\r\n}\r\nstatic void lbmc_stream_dlg_guint_cell_data_function(GtkTreeViewColumn * column _U_, GtkCellRenderer * renderer, GtkTreeModel * model, GtkTreeIter * iter, gpointer user_data)\r\n{\r\nguint uint_value;\r\ngint data_column;\r\nchar value[64];\r\ndata_column = GPOINTER_TO_INT(user_data);\r\ngtk_tree_model_get(model, iter, data_column, &uint_value, -1);\r\ng_snprintf(value, (gulong)sizeof(value), "%u", uint_value);\r\ng_object_set(renderer, "text", value, NULL);\r\ng_object_set(renderer, "xalign", 1.0, NULL);\r\n}\r\nstatic gint lbmc_stream_dlg_guint_sort_func(GtkTreeModel * model, GtkTreeIter * a, GtkTreeIter * b, gpointer user_data)\r\n{\r\nguint32 val_a;\r\nguint32 val_b;\r\ngint data_column;\r\ndata_column = GPOINTER_TO_INT(user_data);\r\ngtk_tree_model_get(model, a, data_column, &val_a, -1);\r\ngtk_tree_model_get(model, b, data_column, &val_b, -1);\r\nif (val_a == val_b)\r\n{\r\nreturn (0);\r\n}\r\nelse if (val_a < val_b)\r\n{\r\nreturn (-1);\r\n}\r\nelse\r\n{\r\nreturn (1);\r\n}\r\n}\r\nstatic gint lbmc_stream_dlg_stream_sort_func(GtkTreeModel * model, GtkTreeIter * a, GtkTreeIter * b, gpointer user_data _U_)\r\n{\r\nguint stream_a;\r\nguint substream_a;\r\nguint stream_b;\r\nguint substream_b;\r\ngtk_tree_model_get(model, a,\r\nLBMC_STREAM_DLG_STORE_CHANNEL_COLUMN, &stream_a,\r\nLBMC_STREAM_DLG_STORE_SUBSTREAM_COLUMN, &substream_a,\r\n-1);\r\ngtk_tree_model_get(model, b,\r\nLBMC_STREAM_DLG_STORE_CHANNEL_COLUMN, &stream_b,\r\nLBMC_STREAM_DLG_STORE_SUBSTREAM_COLUMN, &substream_b,\r\n-1);\r\nif (stream_a == stream_b)\r\n{\r\nif (substream_a == substream_b)\r\n{\r\nreturn (0);\r\n}\r\nelse if (substream_a < substream_b)\r\n{\r\nreturn (-1);\r\n}\r\nelse\r\n{\r\nreturn (1);\r\n}\r\n}\r\nelse if (stream_a < stream_b)\r\n{\r\nreturn (-1);\r\n}\r\nelse\r\n{\r\nreturn (1);\r\n}\r\n}\r\nstatic gint lbmc_stream_dlg_string_sort_func(GtkTreeModel * model, GtkTreeIter * a, GtkTreeIter * b, gpointer user_data)\r\n{\r\nconst gchar * str_a = NULL;\r\nconst gchar * str_b = NULL;\r\ngint ret = 0;\r\ngint data_column = GPOINTER_TO_INT(user_data);\r\ngtk_tree_model_get(model, a, data_column, &str_a, -1);\r\ngtk_tree_model_get(model, b, data_column, &str_b, -1);\r\nif (str_a == str_b)\r\n{\r\nreturn 0;\r\n}\r\nelse if (str_a == NULL || str_b == NULL)\r\n{\r\nret = (str_a == NULL) ? -1 : 1;\r\n}\r\nelse\r\n{\r\nret = g_ascii_strcasecmp(str_a, str_b);\r\n}\r\nreturn (ret);\r\n}\r\nstatic GtkWidget * lbmc_stream_dlg_create_view_and_model(lbmc_stream_dlg_info_t * info)\r\n{\r\nGtkWidget * view = NULL;\r\nGtkTreeViewColumn * column;\r\nGtkCellRenderer * renderer;\r\nGtkTreeSortable * sortable;\r\ninfo->model = lbmc_stream_dlg_create_model();\r\nview = gtk_tree_view_new();\r\nsortable = GTK_TREE_SORTABLE(GTK_TREE_STORE(info->model));\r\n#if GTK_CHECK_VERSION(2,6,0)\r\ngtk_tree_view_set_fixed_height_mode(GTK_TREE_VIEW(view), TRUE);\r\n#endif\r\ngtk_tree_view_set_headers_clickable(GTK_TREE_VIEW(view), FALSE);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Stream", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_STREAM_DISPLAY_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_stream_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_STREAM_DISPLAY_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_STREAM_DISPLAY_COLUMN, lbmc_stream_dlg_stream_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_STREAM_DISPLAY_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 80);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Endpoint A", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_ENDPOINTA_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_string_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_ENDPOINTA_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_ENDPOINTA_COLUMN, lbmc_stream_dlg_string_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_ENDPOINTA_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 140);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Endpoint B", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_ENDPOINTB_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_string_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_ENDPOINTB_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_ENDPOINTB_COLUMN, lbmc_stream_dlg_string_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_ENDPOINTB_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 140);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Messages", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_MESSAGES_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_guint_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_MESSAGES_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_MESSAGES_COLUMN, lbmc_stream_dlg_guint_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_MESSAGES_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Bytes", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_BYTES_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_guint_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_BYTES_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_BYTES_COLUMN, lbmc_stream_dlg_guint_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_BYTES_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 80);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("First frame", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_guint_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN, lbmc_stream_dlg_guint_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(renderer, "ypad", 0, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Last frame", renderer, NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, LBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_cell_data_func(column, renderer, lbmc_stream_dlg_guint_cell_data_function, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN), NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, LBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN, lbmc_stream_dlg_guint_sort_func, GINT_TO_POINTER(LBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN), NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(view), column);\r\ngtk_tree_view_set_model(GTK_TREE_VIEW(view), info->model);\r\ng_object_unref(info->model);\r\nreturn (view);\r\n}\r\nstatic lbmc_stream_dlg_info_t * lbmc_stream_dlg_window_create(void)\r\n{\r\nGtkWidget * vbox = NULL;\r\nGtkWidget * view = NULL;\r\nGtkWidget * button_row = NULL;\r\nGtkWidget * close_button = NULL;\r\nGtkWidget * scrolled_window = NULL;\r\nlbmc_stream_dlg_info_t * info = NULL;\r\ninfo = (lbmc_stream_dlg_info_t *)g_malloc(sizeof(lbmc_stream_dlg_info_t));\r\ninfo->dialog = NULL;\r\ninfo->model = NULL;\r\ninfo->stream_table = NULL;\r\nlbmc_stream_dlg_reset_stream_table(info);\r\ninfo->dialog = dlg_window_new("29West LBMC Streams");\r\ng_signal_connect(info->dialog, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(info->dialog, "destroy", G_CALLBACK(lbmc_stream_dlg_window_destroy_event_cb), (gpointer)info);\r\ngtk_window_set_default_size(GTK_WINDOW(info->dialog), 800, 400);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(info->dialog), vbox);\r\ngtk_container_set_border_width(GTK_CONTAINER(vbox), 12);\r\nview = lbmc_stream_dlg_create_view_and_model(info);\r\ng_object_set_data((GObject *)info->dialog, global_stream_view_data, (gpointer)view);\r\nscrolled_window = scrolled_window_new(NULL, NULL);\r\ngtk_container_add(GTK_CONTAINER(scrolled_window), view);\r\ngtk_box_pack_start(GTK_BOX(vbox), scrolled_window, TRUE, TRUE, 0);\r\nbutton_row = dlg_button_row_new(GTK_STOCK_CLOSE, NULL);\r\ngtk_box_pack_end(GTK_BOX(vbox), button_row, FALSE, FALSE, 0);\r\nclose_button = (GtkWidget *)g_object_get_data(G_OBJECT(button_row), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(info->dialog, close_button, window_cancel_button_cb);\r\ngtk_widget_show_all(info->dialog);\r\nreturn (info);\r\n}\r\nstatic void lbmc_stream_dlg_tap_reset(void * tap_data)\r\n{\r\nlbmc_stream_dlg_info_t * info = (lbmc_stream_dlg_info_t *)tap_data;\r\ngtk_tree_store_clear(GTK_TREE_STORE(info->model));\r\nlbmc_stream_dlg_reset_stream_table(info);\r\n}\r\nstatic gint lbmc_stream_dlg_stream_compare_cb(gconstpointer lhs, gconstpointer rhs, gpointer user_data _U_)\r\n{\r\nconst lbmc_stream_dlg_stream_entry_t * stream1 = (const lbmc_stream_dlg_stream_entry_t *)lhs;\r\nconst lbmc_stream_dlg_stream_entry_t * stream2 = (const lbmc_stream_dlg_stream_entry_t *)rhs;\r\nif (stream1->channel == stream2->channel)\r\n{\r\nreturn (0);\r\n}\r\nelse if (stream1->channel < stream2->channel)\r\n{\r\nreturn (-1);\r\n}\r\nreturn (1);\r\n}\r\nstatic gint lbmc_stream_dlg_substream_compare_cb(gconstpointer lhs, gconstpointer rhs, gpointer user_data _U_)\r\n{\r\nconst lbmc_stream_dlg_substream_entry_t * substream1 = (const lbmc_stream_dlg_substream_entry_t *)lhs;\r\nconst lbmc_stream_dlg_substream_entry_t * substream2 = (const lbmc_stream_dlg_substream_entry_t *)rhs;\r\nif (substream1->substream_id == substream2->substream_id)\r\n{\r\nreturn (0);\r\n}\r\nelse if (substream1->substream_id < substream2->substream_id)\r\n{\r\nreturn (-1);\r\n}\r\nreturn (1);\r\n}\r\nstatic gboolean lbmc_stream_dlg_tap_packet(void * tap_data, packet_info * pinfo, epan_dissect_t * edt _U_, const void * stream_info)\r\n{\r\nconst lbm_uim_stream_tap_info_t * tapinfo = (const lbm_uim_stream_tap_info_t *)stream_info;\r\nlbmc_stream_dlg_info_t * info = (lbmc_stream_dlg_info_t *)tap_data;\r\nGtkTreeIter stream_iter;\r\nGtkTreeIter stream_insert_before_iter;\r\nlbmc_stream_dlg_stream_entry_t * stream = NULL;\r\nGSequenceIter * stream_entry_it;\r\nlbmc_stream_dlg_stream_entry_t stream_key;\r\ngboolean add_stream = FALSE;\r\ngboolean add_stream_before = FALSE;\r\nGtkTreeIter substream_iter;\r\nGtkTreeIter substream_insert_before_iter;\r\nlbmc_stream_dlg_substream_entry_t * substream = NULL;\r\nGSequenceIter * substream_entry_it;\r\nlbmc_stream_dlg_substream_entry_t substream_key;\r\ngboolean add_substream = FALSE;\r\ngboolean add_substream_before = FALSE;\r\nGtkTreePath * stream_path = NULL;\r\nGtkTreePath * substream_path = NULL;\r\nmemset((void *)&stream_key, 0, sizeof(lbmc_stream_dlg_stream_entry_t));\r\nstream_key.channel = tapinfo->channel;\r\nstream_entry_it = g_sequence_search(info->stream_table, (gpointer)&stream_key, lbmc_stream_dlg_stream_compare_cb, NULL);\r\nif (g_sequence_iter_is_begin(stream_entry_it))\r\n{\r\nadd_stream = TRUE;\r\nif (g_sequence_iter_is_end(stream_entry_it))\r\n{\r\n}\r\nelse\r\n{\r\nstream = (lbmc_stream_dlg_stream_entry_t *)g_sequence_get(stream_entry_it);\r\nadd_stream_before = TRUE;\r\nstream_insert_before_iter = stream->iter;\r\n}\r\n}\r\nelse\r\n{\r\nGSequenceIter * save_stream_entry_it = stream_entry_it;\r\nstream_entry_it = g_sequence_iter_prev(stream_entry_it);\r\nstream = (lbmc_stream_dlg_stream_entry_t *)g_sequence_get(stream_entry_it);\r\nif (stream->channel != tapinfo->channel)\r\n{\r\nadd_stream = TRUE;\r\nif (g_sequence_iter_is_end(save_stream_entry_it))\r\n{\r\n}\r\nelse\r\n{\r\nstream = (lbmc_stream_dlg_stream_entry_t *)g_sequence_get(stream_entry_it);\r\nadd_stream_before = TRUE;\r\nstream_insert_before_iter = stream->iter;\r\n}\r\n}\r\n}\r\nif (add_stream)\r\n{\r\nchar valbuf[256];\r\nstream = (lbmc_stream_dlg_stream_entry_t *)g_malloc(sizeof(lbmc_stream_dlg_stream_entry_t));\r\nstream->channel = tapinfo->channel;\r\nstream->endpoint_a = lbmc_stream_dlg_format_endpoint(wmem_file_scope(), &(tapinfo->endpoint_a));\r\nstream->endpoint_b = lbmc_stream_dlg_format_endpoint(wmem_file_scope(), &(tapinfo->endpoint_b));\r\nstream->first_frame = (guint32)(~0);\r\nstream->last_frame = 0;\r\nstream->messages = 0;\r\nstream->bytes = 0;\r\nstream->substreams = g_sequence_new(lbmc_stream_dlg_substream_entry_destroy_cb);\r\n(void) g_sequence_insert_sorted(info->stream_table, (void *)stream, lbmc_stream_dlg_stream_compare_cb, NULL);\r\nif (add_stream_before)\r\n{\r\ngtk_tree_store_insert_before(GTK_TREE_STORE(info->model), &stream_iter, NULL, &stream_insert_before_iter);\r\n}\r\nelse\r\n{\r\ngtk_tree_store_append(GTK_TREE_STORE(info->model), &stream_iter, NULL);\r\n}\r\nstream->iter = stream_iter;\r\ng_snprintf(valbuf, (gulong)sizeof(valbuf), "%" G_GUINT64_FORMAT, stream->channel);\r\ngtk_tree_store_set(GTK_TREE_STORE(info->model), &(stream->iter),\r\nLBMC_STREAM_DLG_STORE_STREAM_DISPLAY_COLUMN, valbuf,\r\nLBMC_STREAM_DLG_STORE_ENDPOINTA_COLUMN, stream->endpoint_a,\r\nLBMC_STREAM_DLG_STORE_ENDPOINTB_COLUMN, stream->endpoint_b,\r\nLBMC_STREAM_DLG_STORE_MESSAGES_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_BYTES_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_CHANNEL_COLUMN, (guint64)stream->channel,\r\nLBMC_STREAM_DLG_STORE_SUBSTREAM_COLUMN, (guint)0,\r\n-1);\r\n}\r\nstream_iter = stream->iter;\r\nif (stream->first_frame > pinfo->num)\r\n{\r\nstream->first_frame = pinfo->num;\r\n}\r\nif (stream->last_frame < pinfo->num)\r\n{\r\nstream->last_frame = pinfo->num;\r\n}\r\nstream->bytes += tapinfo->bytes;\r\nstream->messages++;\r\ngtk_tree_store_set(GTK_TREE_STORE(info->model), &stream_iter,\r\nLBMC_STREAM_DLG_STORE_MESSAGES_COLUMN, (guint)stream->messages,\r\nLBMC_STREAM_DLG_STORE_BYTES_COLUMN, (guint)stream->bytes,\r\nLBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN, (guint)stream->first_frame,\r\nLBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN, (guint)stream->last_frame,\r\n-1);\r\nmemset((void *)&substream_key, 0, sizeof(lbmc_stream_dlg_substream_entry_t));\r\nsubstream_key.substream_id = tapinfo->substream_id;\r\nsubstream_entry_it = g_sequence_search(stream->substreams, (gpointer)&substream_key, lbmc_stream_dlg_substream_compare_cb, NULL);\r\nif (g_sequence_iter_is_begin(substream_entry_it))\r\n{\r\nadd_substream = TRUE;\r\nif (g_sequence_iter_is_end(substream_entry_it))\r\n{\r\n}\r\nelse\r\n{\r\nsubstream = (lbmc_stream_dlg_substream_entry_t *)g_sequence_get(substream_entry_it);\r\nadd_substream_before = TRUE;\r\nsubstream_insert_before_iter = substream->iter;\r\n}\r\n}\r\nelse\r\n{\r\nGSequenceIter * save_substream_entry_it = substream_entry_it;\r\nsubstream_entry_it = g_sequence_iter_prev(substream_entry_it);\r\nsubstream = (lbmc_stream_dlg_substream_entry_t *)g_sequence_get(substream_entry_it);\r\nif (substream->substream_id != tapinfo->substream_id)\r\n{\r\nadd_substream = TRUE;\r\nif (g_sequence_iter_is_end(save_substream_entry_it))\r\n{\r\n}\r\nelse\r\n{\r\nsubstream = (lbmc_stream_dlg_substream_entry_t *)g_sequence_get(substream_entry_it);\r\nadd_substream_before = TRUE;\r\nsubstream_insert_before_iter = substream->iter;\r\n}\r\n}\r\n}\r\nif (add_substream)\r\n{\r\nchar valbuf[256];\r\nsubstream = (lbmc_stream_dlg_substream_entry_t *)g_malloc(sizeof(lbmc_stream_dlg_substream_entry_t));\r\nsubstream->substream_id = tapinfo->substream_id;\r\nsubstream->endpoint_a = wmem_strdup_printf(wmem_file_scope(), "%s:%" G_GUINT16_FORMAT, address_to_str(pinfo->pool, &(pinfo->src)), (guint16)pinfo->srcport);\r\nsubstream->endpoint_b = wmem_strdup_printf(wmem_file_scope(), "%s:%" G_GUINT16_FORMAT, address_to_str(pinfo->pool, &(pinfo->dst)), (guint16)pinfo->destport);\r\nsubstream->first_frame = (guint32)(~0);\r\nsubstream->last_frame = 0;\r\nsubstream->messages = 0;\r\nsubstream->bytes = 0;\r\nsubstream->parent = stream;\r\n(void) g_sequence_insert_sorted(stream->substreams, (void *)substream, lbmc_stream_dlg_substream_compare_cb, NULL);\r\nif (add_substream_before)\r\n{\r\ngtk_tree_store_insert_before(GTK_TREE_STORE(info->model), &substream_iter, &stream_iter, &substream_insert_before_iter);\r\n}\r\nelse\r\n{\r\ngtk_tree_store_append(GTK_TREE_STORE(info->model), &substream_iter, &stream_iter);\r\n}\r\nsubstream->iter = substream_iter;\r\ng_snprintf(valbuf, (gulong)sizeof(valbuf), "%" G_GUINT64_FORMAT ":%" G_GUINT32_FORMAT, stream->channel, substream->substream_id);\r\ngtk_tree_store_set(GTK_TREE_STORE(info->model), &(substream->iter),\r\nLBMC_STREAM_DLG_STORE_STREAM_DISPLAY_COLUMN, valbuf,\r\nLBMC_STREAM_DLG_STORE_ENDPOINTA_COLUMN, substream->endpoint_a,\r\nLBMC_STREAM_DLG_STORE_ENDPOINTB_COLUMN, substream->endpoint_b,\r\nLBMC_STREAM_DLG_STORE_MESSAGES_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_BYTES_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN, (guint)0,\r\nLBMC_STREAM_DLG_STORE_CHANNEL_COLUMN, (guint)stream->channel,\r\nLBMC_STREAM_DLG_STORE_SUBSTREAM_COLUMN, (guint)substream->substream_id,\r\n-1);\r\n}\r\nsubstream_iter = substream->iter;\r\nif (substream->first_frame > pinfo->num)\r\n{\r\nsubstream->first_frame = pinfo->num;\r\n}\r\nif (substream->last_frame < pinfo->num)\r\n{\r\nsubstream->last_frame = pinfo->num;\r\n}\r\nsubstream->bytes += tapinfo->bytes;\r\nsubstream->messages++;\r\ngtk_tree_store_set(GTK_TREE_STORE(info->model), &substream_iter,\r\nLBMC_STREAM_DLG_STORE_MESSAGES_COLUMN, (guint)substream->messages,\r\nLBMC_STREAM_DLG_STORE_BYTES_COLUMN, (guint)substream->bytes,\r\nLBMC_STREAM_DLG_STORE_FIRST_FRAME_COLUMN, (guint)substream->first_frame,\r\nLBMC_STREAM_DLG_STORE_LAST_FRAME_COLUMN, (guint)substream->last_frame,\r\n-1);\r\nsubstream_path = gtk_tree_model_get_path(info->model, &(substream->iter));\r\ngtk_tree_model_row_changed(info->model, substream_path, &(substream->iter));\r\ngtk_tree_path_free(substream_path);\r\nsubstream_path = NULL;\r\nstream_path = gtk_tree_model_get_path(info->model, &(stream->iter));\r\ngtk_tree_model_row_changed(info->model, stream_path, &(stream->iter));\r\ngtk_tree_path_free(stream_path);\r\nstream_path = NULL;\r\nreturn (TRUE);\r\n}\r\nstatic void lbmc_stream_dlg_tap_draw(void * tap_data _U_)\r\n{\r\n}\r\nvoid lbmc_stream_dlg_stream_menu_cb(gpointer arg _U_)\r\n{\r\nGString * err_msg;\r\nif (global_stream_dialog_info != NULL)\r\n{\r\ngtk_widget_show(global_stream_dialog_info->dialog);\r\nreturn;\r\n}\r\nglobal_stream_dialog_info = lbmc_stream_dlg_window_create();\r\nerr_msg = register_tap_listener("lbm_stream",\r\n(void *)global_stream_dialog_info,\r\nNULL,\r\nTL_REQUIRES_COLUMNS,\r\nlbmc_stream_dlg_tap_reset,\r\nlbmc_stream_dlg_tap_packet,\r\nlbmc_stream_dlg_tap_draw);\r\nif (err_msg != NULL)\r\n{\r\nfprintf(stderr, "register_tap_listener: %s\n", err_msg->str);\r\ng_string_free(err_msg, TRUE);\r\n}\r\ncf_retap_packets(&cfile);\r\n}

static void NetIdFormater(tvbuff_t *tvb, guint offset, char *szText, gint nMax)\r\n{\r\ng_snprintf ( szText, nMax, "%d.%d.%d.%d.%d.%d", tvb_get_guint8(tvb, offset),\r\ntvb_get_guint8(tvb, offset+1),\r\ntvb_get_guint8(tvb, offset+2),\r\ntvb_get_guint8(tvb, offset+3),\r\ntvb_get_guint8(tvb, offset+4),\r\ntvb_get_guint8(tvb, offset+5)\r\n);\r\n}\r\nstatic gint dissect_ams_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint offset)\r\n{\r\nproto_item *ti, *anItem;\r\nproto_tree *ams_tree = NULL, *ams_adstree, *ams_statetree;\r\nguint ams_length = tvb_reported_length(tvb);\r\nguint16 stateflags = 0;\r\nguint16 cmdId = 0;\r\nguint32 cbdata = 0;\r\nchar szText[200];\r\nint nMax = sizeof(szText)-1;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AMS");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif( ams_length < AmsHead_Len )\r\nreturn offset;\r\nif (tree)\r\n{\r\nti = proto_tree_add_item(tree, proto_ams, tvb, 0, -1, ENC_NA);\r\nams_tree = proto_item_add_subtree(ti, ett_ams);\r\nNetIdFormater(tvb, offset, szText, nMax);\r\nproto_tree_add_string(ams_tree, hf_ams_targetnetid, tvb, offset, AmsNetId_Len, szText);\r\noffset += AmsNetId_Len;\r\nproto_tree_add_item(ams_tree, hf_ams_targetport, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset += (int)sizeof(guint16);\r\nNetIdFormater(tvb, offset, szText, nMax);\r\nproto_tree_add_string(ams_tree, hf_ams_sendernetid, tvb, offset, AmsNetId_Len, szText);\r\noffset += AmsNetId_Len;\r\nproto_tree_add_item(ams_tree, hf_ams_senderport, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset += (int)sizeof(guint16);\r\nproto_tree_add_item(ams_tree, hf_ams_cmdid, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\ncmdId = tvb_get_letohs(tvb, offset);\r\noffset+=(int)sizeof(guint16);\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_stateflags, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nams_statetree = proto_item_add_subtree(anItem, ett_ams_stateflags);\r\nproto_tree_add_item(ams_statetree, hf_ams_stateresponse,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_statenoreturn,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_stateadscmd,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_statesyscmd,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_statehighprio,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_statetimestampadded,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_stateudp,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_stateinitcmd,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_statetree, hf_ams_statebroadcast,tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\nstateflags = tvb_get_letohs(tvb, offset);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(ams_tree, hf_ams_cbdata, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\ncbdata = tvb_get_letohl(tvb,offset);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_tree, hf_ams_errorcode, tvb, offset, (int)sizeof(guint32),ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_tree, hf_ams_invokeid, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\n}\r\nelse\r\n{\r\noffset+=AmsHead_Len;\r\n}\r\nif ( (stateflags & AMSCMDSF_ADSCMD) != 0 )\r\n{\r\nif ( (stateflags & AMSCMDSF_RESPONSE) == 0 )\r\n{\r\nswitch ( cmdId )\r\n{\r\ncase ADSSRVID_READ:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreadrequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadReq_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreadrequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexgroup, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexoffset, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_WRITE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Write Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adswriterequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsWriteReq_Len - (int)sizeof(guint16) )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adswriterequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexgroup, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexoffset, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdata, tvb, offset, ams_length-offset, ENC_NA);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_READWRITE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read Write Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreadwriterequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadWriteReq_Len - (int)sizeof(guint16))\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreadwriterequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexgroup, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexoffset, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscbreadlength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscbwritelength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdata, tvb, offset, ams_length-offset, ENC_NA);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_READSTATE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read State Request");\r\nif( tree && cbdata !=0 )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreadstaterequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadStateReq_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreadstaterequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsinvokeid, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_WRITECTRL:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Write Control Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adswritectrlrequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsWriteControlReq_Len - (int)sizeof(guint16) )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adswritectrlrequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsstate, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdevicestate, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdata, tvb, offset, ams_length-offset, ENC_NA);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_READDEVICEINFO:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read Device Info Request");\r\nif( tree && cbdata !=0 )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreaddinforequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadDeviceInfoReq_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreaddinforequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_ADDDEVICENOTE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Add Device Notification Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsadddnrequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsAddDeviceNotificationReq_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsadddnrequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexgroup, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsindexoffset, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adstransmode, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsmaxdelay, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscycletime, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_DELDEVICENOTE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Delete Device Notification Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsdeldnrequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsDelDeviceNotificationReq_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsdeldnrequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsnotificationhandle, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_DEVICENOTE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Device Notification Request");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsdnrequest, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsDeviceNotificationReq_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsdnrequest);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsnoteblocksstamps, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\n}\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\nelse\r\n{\r\nswitch ( cmdId )\r\n{\r\ncase ADSSRVID_READ:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreadresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadRes_Len - (int)sizeof(guint16) )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreadresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdata, tvb, offset, ams_length-offset, ENC_NA);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_WRITE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Write Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adswriteresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsWriteRes_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adswriteresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_READWRITE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read Write Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreadwriteresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadWriteRes_Len - (int)sizeof(guint16) )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreadwriteresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adscblength, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdata, tvb, offset, ams_length-offset, ENC_NA);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_READSTATE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read State Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreadstateresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadStateRes_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreadstateresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsstate, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdevicestate, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_WRITECTRL:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Write Control Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adswritectrlresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsWriteControlRes_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adswritectrlresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_READDEVICEINFO:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Read Device Info Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsreaddinforesponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsReadDeviceInfoRes_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsreaddinforesponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsversionversion, tvb, offset++, (int)sizeof(guint8), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsversionrevision, tvb, offset++, (int)sizeof(guint8), ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsversionbuild, tvb, offset, (int)sizeof(guint16), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint16);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsdevicename, tvb, offset, ams_length-offset, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_ADDDEVICENOTE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Device Notification Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsadddnresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsAddDeviceNotificationRes_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsadddnresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\noffset+=(int)sizeof(guint32);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsnotificationhandle, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase ADSSRVID_DELDEVICENOTE:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "ADS Delete Device Notification Response");\r\nif( tree )\r\n{\r\nanItem = proto_tree_add_item(ams_tree, hf_ams_adsdeldnresponse, tvb, offset, ams_length-offset, ENC_NA);\r\nif( ams_length-offset >= TAdsDelDeviceNotificationRes_Len )\r\n{\r\nams_adstree = proto_item_add_subtree(anItem, ett_ams_adsdeldnresponse);\r\nproto_tree_add_item(ams_adstree, hf_ams_adsresult, tvb, offset, (int)sizeof(guint32), ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif ( (stateflags & AMSCMDSF_RESPONSE) == 0 )\r\ncol_append_str(pinfo->cinfo, COL_INFO, "AMS Request");\r\nelse\r\ncol_append_str(pinfo->cinfo, COL_INFO, "AMS Response");\r\nif( tree && ams_length-offset > 0 )\r\nproto_tree_add_item(ams_tree, hf_ams_data, tvb, offset, ams_length-offset, ENC_NA);\r\n}\r\nreturn offset;\r\n}\r\nstatic gint dissect_ams(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_ams_pdu(tvb, pinfo, tree, 0);\r\n}\r\nstatic gint dissect_amstcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif( TcpAdsParserHDR_Len > tvb_reported_length(tvb))\r\nreturn 0;\r\nreturn dissect_ams_pdu(tvb, pinfo, tree, TcpAdsParserHDR_Len);\r\n}\r\nvoid proto_register_ams(void)\r\n{\r\nstatic const true_false_string flags_set_truth =\r\n{\r\n"Set",\r\n"Not set"\r\n};\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_ams_sendernetid,\r\n{ "AMS Sender Net Id", "ams.sendernetid",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_senderport,\r\n{ "AMS Sender port", "ams.senderport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_targetnetid,\r\n{ "AMS Target Net Id", "ams.targetnetid",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_targetport,\r\n{ "AMS Target port", "ams.targetport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_cmdid,\r\n{ "CmdId", "ams.cmdid",\r\nFT_UINT16, BASE_DEC, VALS(AMS_CommandId_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_stateflags,\r\n{ "StateFlags", "ams.stateflags",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_stateresponse,\r\n{ "RESPONSE", "ams.state_response",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_RESPONSE,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_statenoreturn,\r\n{ "NO RETURN", "ams.state_noreturn",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_NORETURN,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_stateadscmd,\r\n{ "ADS COMMAND", "ams.state_adscmd",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_ADSCMD,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_statesyscmd,\r\n{ "SYSTEM COMMAND", "ams.state_syscmd",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_SYSCMD,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_statehighprio,\r\n{ "HIGH PRIORITY COMMAND", "ams.state_highprio",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_HIGHPRIO,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_statetimestampadded,\r\n{ "TIMESTAMP ADDED", "ams.state_timestampadded",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_TIMESTAMPADDED,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_stateudp,\r\n{ "UDP COMMAND", "ams.state_udp",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_UDP,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_stateinitcmd,\r\n{ "INIT COMMAND", "ams.state_initcmd",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_INITCMD,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_statebroadcast,\r\n{ "BROADCAST", "ams.state_broadcast",\r\nFT_BOOLEAN, 16, TFS(&flags_set_truth), AMSCMDSF_BROADCAST,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_cbdata,\r\n{ "cbData", "ams.cbdata",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_errorcode,\r\n{ "ErrorCode", "ams.errorcode",\r\nFT_UINT32, BASE_HEX, VALS(ErrorCode), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_invokeid,\r\n{ "InvokeId", "ams.invokeid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsdata,\r\n{ "Data", "ams.ads_data",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_data,\r\n{ "Data", "ams.data",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsindexgroup,\r\n{ "IndexGroup", "ams.ads_indexgroup",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsindexoffset,\r\n{ "IndexOffset", "ams.ads_indexoffset",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adscblength,\r\n{ "CbLength", "ams.ads_cblength",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreadrequest,\r\n{ "ADS Read Request", "ams.ads_read_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreadresponse,\r\n{ "ADS Read Response", "ams.ads_read_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsinvokeid,\r\n{ "InvokeId", "ams.ads_invokeid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsresult,\r\n{ "Result", "ams.adsresult",\r\nFT_UINT32, BASE_HEX, VALS(AdsErrorMode), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adswriterequest,\r\n{ "ADS Write Request", "ams.ads_write_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adswriteresponse,\r\n{ "ADS Write Response", "ams.ads_write_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreadwriterequest,\r\n{ "ADS ReadWrite Request", "ams.ads_readwrite_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreadwriteresponse,\r\n{ "ADS ReadWrite Response", "ams.ads_readwrite_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adscbreadlength,\r\n{ "CBReadLength", "ams.ads_cbreadlength",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adscbwritelength,\r\n{ "CBWriteLength", "ams.ads_cbwritelength",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsstate,\r\n{ "AdsState", "ams.ads_state",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsdevicestate,\r\n{ "DeviceState", "ams.ads_devicestate",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsnotificationhandle,\r\n{ "NotificationHandle", "ams.ads_notificationhandle",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreadstaterequest,\r\n{ "ADS Read State Request", "ams.ads_readstate_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreadstateresponse,\r\n{ "ADS Read State Response", "ams.ads_readstate_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adswritectrlrequest,\r\n{ "ADS Write Ctrl Request", "ams.ads_writectrl_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adswritectrlresponse,\r\n{ "ADS Write Ctrl Response", "ams.ads_writectrl_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreaddinforequest,\r\n{ "ADS Read Device Info Request", "ams.ads_readdinfo_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsreaddinforesponse,\r\n{ "ADS Read Device Info Response", "ams.ads_readdinfo_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsadddnrequest,\r\n{ "ADS Add Device Notification Request", "ams.ads_adddn_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsadddnresponse,\r\n{ "ADS Add Device Notification Response", "ams.ads_adddn_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsdeldnrequest,\r\n{ "ADS Delete Device Notification Request", "ams.ads_deldn_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsdeldnresponse,\r\n{ "ADS Delete Device Notification Response", "ams.ads_deldn_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsdnrequest,\r\n{ "ADS Device Notification Request", "ams.ads_dn_req",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_ams_adsdnresponse,\r\n{ "ADS Device Notification Response", "ams.ads_dn_res",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsnoteattrib,\r\n{ "InvokeId", "ams.ads_noteattrib",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsnoteblocks,\r\n{ "InvokeId", "ams.ads_noteblocks",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsversion,\r\n{ "ADS Version", "ams.ads_version",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_ams_adsdevicename,\r\n{ "Device Name","ams.ads_devicename",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsversionversion,\r\n{ "ADS Major Version", "ams.ads_versionversion",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsversionrevision,\r\n{ "ADS Minor Version", "ams.ads_versionrevision",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsversionbuild,\r\n{ "ADS Version Build", "ams.ads_versionbuild",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsnoteblocksstamps,\r\n{ "Count of Stamps", "ams.ads_noteblocksstamps",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_ams_adsnoteblocksstamp,\r\n{ "Notification Stamp", "ams.ads_noteblocksstamp",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adstimestamp,\r\n{ "Time Stamp", "ams.ads_timestamp",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adssamplecnt,\r\n{ "Count of Stamps", "ams.ads_samplecnt",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsnoteblockssample,\r\n{ "Notification Sample", "ams.ads_noteblockssample",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_ams_adstransmode,\r\n{ "Trans Mode", "ams.ads_transmode",\r\nFT_UINT32, BASE_DEC, VALS(TransMode), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adsmaxdelay,\r\n{ "Max Delay", "ams.ads_maxdelay",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adscycletime,\r\n{ "Cycle Time", "ams.ads_cycletime",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_ams_adscmpmax,\r\n{ "Cmp Mad", "ams.ads_cmpmax",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ams_adscmpmin,\r\n{ "Cmp Min", "ams.ads_cmpmin",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n#endif\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_ams,\r\n&ett_ams_stateflags,\r\n&ett_ams_adsreadrequest,\r\n&ett_ams_adsreadresponse,\r\n&ett_ams_adswriterequest,\r\n&ett_ams_adswriteresponse,\r\n&ett_ams_adsreadwriterequest,\r\n&ett_ams_adsreadwriteresponse,\r\n&ett_ams_adsreadstaterequest,\r\n&ett_ams_adsreadstateresponse,\r\n&ett_ams_adswritectrlrequest,\r\n&ett_ams_adswritectrlresponse,\r\n&ett_ams_adsreaddinforequest,\r\n&ett_ams_adsreaddinforesponse,\r\n&ett_ams_adsadddnrequest,\r\n&ett_ams_adsadddnresponse,\r\n&ett_ams_adsdeldnrequest,\r\n&ett_ams_adsdeldnresponse,\r\n&ett_ams_adsdnrequest\r\n};\r\nproto_ams = proto_register_protocol("AMS", "AMS", "ams");\r\nproto_register_field_array(proto_ams, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("ams", dissect_ams, proto_ams);\r\n}\r\nvoid proto_reg_handoff_ams(void)\r\n{\r\ndissector_handle_t ams_handle, amstcp_handle;\r\nams_handle = find_dissector("ams");\r\namstcp_handle = create_dissector_handle( dissect_amstcp, proto_ams );\r\ndissector_add_uint("tcp.port", 0xbf02, amstcp_handle);\r\ndissector_add_uint("ecatf.type", 2, ams_handle);\r\n}

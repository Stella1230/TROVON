static int dissect_simpdu(tvbuff_t *tvb, proto_tree *tree, guint16 offset, guint8 lenIndicator)\r\n{\r\ngint bytesProcessed;\r\nguint8 paramCode;\r\nproto_item *simpduItem;\r\nproto_tree *simpduVarTree;\r\nproto_tree *simpduVarTree1;\r\nbytesProcessed = 0;\r\nproto_tree_add_item(tree, hf_pdc_credit, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nbytesProcessed += 1;\r\nproto_tree_add_item(tree, hf_pdc_simpdu_state, tvb, offset + bytesProcessed , 1, ENC_BIG_ENDIAN);\r\nbytesProcessed += 1;\r\nproto_tree_add_item(tree, hf_pdc_yr_admu_nr, tvb, offset + bytesProcessed , 4, ENC_BIG_ENDIAN);\r\nbytesProcessed += 4;\r\nif (lenIndicator > 7)\r\n{\r\nsimpduItem = proto_tree_add_item (tree, hf_pdc_simpdu_var, tvb, offset + bytesProcessed, lenIndicator - 7, ENC_NA);\r\nsimpduVarTree = proto_item_add_subtree (simpduItem, ett_pdc_simpdu_var);\r\nwhile ((offset + bytesProcessed) < ( lenIndicator + 1 ))\r\n{\r\nparamCode = tvb_get_guint8(tvb, offset + bytesProcessed);\r\nsimpduItem = proto_tree_add_item (simpduVarTree, hf_pdc_simpdu_param, tvb, offset + bytesProcessed, 1, ENC_BIG_ENDIAN);\r\nsimpduVarTree1 = proto_item_add_subtree (simpduItem, ett_pdc_simpdu_var);\r\nbytesProcessed += 1;\r\nswitch (paramCode)\r\n{\r\ncase PARAM_CODE_VERSION:\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_len, tvb, offset + bytesProcessed, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_version, tvb, offset + bytesProcessed + 1, 1, ENC_BIG_ENDIAN);\r\nbytesProcessed += 2;\r\nbreak;\r\ncase PARAM_CODE_REFERENCES:\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_len, tvb, offset + bytesProcessed, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_REFSRC, tvb, offset + bytesProcessed + 1, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_REFDEST, tvb, offset + bytesProcessed + 3, 2, ENC_BIG_ENDIAN);\r\nbytesProcessed += 5;\r\nbreak;\r\ncase PARAM_CODE_TRANSPORT:\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_len, tvb, offset + bytesProcessed, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(simpduVarTree1, hf_pdc_simpdu_var_TSEL, tvb, offset + bytesProcessed + 1, 2, ENC_BIG_ENDIAN);\r\nbytesProcessed += 3;\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn (bytesProcessed);\r\n}\r\nstatic int dissect_rsmpdu(void)\r\n{\r\nreturn (0);\r\n}\r\nstatic int dissect_drmpdu(tvbuff_t *tvb, proto_tree *tree, guint16 offset)\r\n{\r\nproto_tree_add_item(tree, hf_pdc_drmpdu_abort, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_pdc_drmpdu_mode, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_pdc_drmpdu_init, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_pdc_drmpdu_reason, tvb, offset + 1, 1, ENC_BIG_ENDIAN);\r\nreturn (2);\r\n}\r\nstatic int dissect_admpdu(tvbuff_t *tvb, proto_tree *parent_tree, proto_tree *tree, guint16 offset, packet_info *pinfo)\r\n{\r\nguint16 userDataLen;\r\nguint16 returnLen;\r\ntvbuff_t *asterixTVB;\r\nproto_tree_add_item(tree, hf_pdc_admpdu_admpdunr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_pdc_admpdu_size, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nuserDataLen = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nreturnLen = userDataLen + 6;\r\nasterixTVB = tvb_new_subset_length(tvb, offset, userDataLen);\r\nif (asterix_handle != NULL)\r\ncall_dissector(asterix_handle, asterixTVB, pinfo, parent_tree);\r\nreturn (returnLen);\r\n}\r\nstatic int dissect_admpdu(tvbuff_t *tvb, proto_tree *parent_tree _U_, proto_tree *tree, guint16 offset, packet_info *pinfo _U_)\r\n{\r\nproto_tree_add_item(tree, hf_pdc_admpdu_admpdunr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nreturn (2);\r\n}\r\nstatic int dissect_dtmpdu(tvbuff_t *tvb, proto_tree *parent_tree, proto_tree *tree, guint16 offset, packet_info *pinfo)\r\n{\r\nguint16 userDataLen;\r\nguint16 returnLen;\r\ntvbuff_t *asterixTVB;\r\nproto_tree_add_item(tree, hf_pdc_dtmpdu_user_size, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nuserDataLen = tvb_get_ntohs(tvb, 2);\r\nreturnLen = userDataLen + 2;\r\nasterixTVB = tvb_new_subset_length(tvb, offset + 2, userDataLen);\r\nif (asterix_handle != NULL)\r\ncall_dissector(asterix_handle, asterixTVB, pinfo, parent_tree);\r\nreturn (returnLen);\r\n}\r\nstatic int dissect_dtmpdu(tvbuff_t *tvb _U_, proto_tree *parent_tree _U_, proto_tree *tree _U_, guint16 offset _U_, packet_info *pinfo _U_)\r\n{\r\nreturn (2);\r\n}\r\nstatic int dissect_edmpdu(tvbuff_t *tvb, proto_tree *parent_tree, proto_tree *tree, guint16 offset, packet_info *pinfo)\r\n{\r\nguint16 userDataLen;\r\nguint16 returnLen;\r\ntvbuff_t *asterixTVB;\r\nproto_tree_add_item(tree, hf_pdc_dtmpdu_user_size, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nuserDataLen = tvb_get_ntohs(tvb, 2);\r\nreturnLen = userDataLen + 2;\r\nasterixTVB = tvb_new_subset_length(tvb, offset + 2, userDataLen);\r\nif (asterix_handle != NULL)\r\ncall_dissector(asterix_handle, asterixTVB, pinfo, parent_tree);\r\nreturn (returnLen);\r\n}\r\nstatic int dissect_edmpdu(tvbuff_t *tvb _U_, proto_tree *parent_tree _U_, proto_tree *tree _U_, guint16 offset _U_, packet_info *pinfo _U_)\r\n{\r\nreturn 2;\r\n}\r\nstatic int dissect_akmpdu(tvbuff_t *tvb, proto_tree *tree, guint16 offset)\r\n{\r\nproto_tree_add_item(tree, hf_pdc_akmpdu_mns, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_pdc_akmpdu_cdt, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_pdc_yr_admu_nr, tvb, offset + 2, 4, ENC_BIG_ENDIAN);\r\nreturn (6);\r\n}\r\nstatic int dissect_pdc_packet(tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo)\r\n{\r\nguint i = 0;\r\nguint8 len_indicator;\r\nguint8 mpduCode;\r\nguint16 length;\r\nproto_item *pdcPacketItem;\r\nproto_tree *pdcPacketTree;\r\nlength = 0;\r\nlen_indicator = tvb_get_guint8 (tvb, i);\r\nmpduCode = tvb_get_guint8 (tvb, i + 1);\r\nlength += 2;\r\npdcPacketItem = proto_tree_add_item (tree, proto_pdc, tvb, i, len_indicator + 1, ENC_NA);\r\npdcPacketTree = proto_item_add_subtree (pdcPacketItem, ett_pdc);\r\nproto_tree_add_item(pdcPacketTree, hf_pdc_len, tvb, i, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(pdcPacketTree, hf_pdc_mpdu_code, tvb, i + 1, 1, ENC_BIG_ENDIAN);\r\nswitch (mpduCode)\r\n{\r\ncase SIMPDU:\r\nlength += dissect_simpdu(tvb, pdcPacketTree, length, len_indicator);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "SIMPDU");\r\nbreak;\r\ncase RSMPDU:\r\nlength += dissect_rsmpdu();\r\ncol_set_str(pinfo->cinfo, COL_INFO, "RSMPDU");\r\nbreak;\r\ncase DRMPDU:\r\nlength += dissect_drmpdu(tvb, pdcPacketTree, length);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "DRMPDU");\r\nbreak;\r\ncase DTMPDU:\r\nlength += dissect_dtmpdu(tvb, tree, pdcPacketTree, length, pinfo);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "DTMPDU");\r\nbreak;\r\ncase ADMPDU:\r\nlength += dissect_admpdu(tvb, tree, pdcPacketTree, length, pinfo);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "ADMPDU");\r\nbreak;\r\ncase EDMPDU:\r\nlength += dissect_edmpdu(tvb, tree, pdcPacketTree, length, pinfo);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "EDMPDU");\r\nbreak;\r\ncase AKMPDU:\r\nlength += dissect_akmpdu(tvb, pdcPacketTree, length);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "AKMPDU");\r\nbreak;\r\ndefault:\r\nbreak;\r\n};\r\nreturn (length);\r\n}\r\nstatic int dissect_pdc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PDC_PROCOTOL );\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ndissect_pdc_packet(tvb, tree, pinfo);\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic guint get_pdc_message_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint size;\r\nguint extra;\r\nguint8 mpdu_type;\r\nmpdu_type = tvb_get_guint8(tvb, offset+1);\r\nswitch (mpdu_type)\r\n{\r\ncase SIMPDU:\r\nsize = tvb_get_guint8(tvb, offset);\r\nextra = 1;\r\nbreak;\r\ncase RSMPDU:\r\nsize = tvb_get_guint8(tvb, offset);\r\nextra = 1;\r\nbreak;\r\ncase DRMPDU:\r\nsize = tvb_get_guint8(tvb, offset);\r\nextra = 1;\r\nbreak;\r\ncase DTMPDU:\r\nsize = tvb_get_ntohs(tvb, offset+2);\r\nextra = 4;\r\nbreak;\r\ncase ADMPDU:\r\nsize = tvb_get_ntohs(tvb, offset+6);\r\nextra = 8;\r\nbreak;\r\ncase EDMPDU:\r\nsize = tvb_get_guint8(tvb, offset);\r\nextra = 1;\r\nbreak;\r\ncase AKMPDU:\r\nsize = tvb_get_guint8(tvb, offset)+1;\r\nextra = 0;\r\nbreak;\r\ndefault:\r\nsize = 0;\r\nextra = 0;\r\n}\r\nreturn size + extra;\r\n}\r\nstatic int tcp_dissect_pdc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint8 mpdu_type;\r\nguint8 minimum_bytes;\r\nmpdu_type = tvb_get_guint8(tvb,1);\r\nswitch (mpdu_type)\r\n{\r\ncase SIMPDU:\r\nminimum_bytes = 2;\r\nbreak;\r\ncase RSMPDU:\r\nminimum_bytes = 2;\r\nbreak;\r\ncase DRMPDU:\r\nminimum_bytes = 2;\r\nbreak;\r\ncase DTMPDU:\r\nminimum_bytes = 4;\r\nbreak;\r\ncase ADMPDU:\r\nminimum_bytes = 8;\r\nbreak;\r\ncase EDMPDU:\r\nminimum_bytes = 2;\r\nbreak;\r\ncase AKMPDU:\r\nminimum_bytes = 2;\r\nbreak;\r\ndefault:\r\nminimum_bytes = 2;\r\nbreak;\r\n}\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, minimum_bytes, get_pdc_message_len, dissect_pdc, NULL);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_pdc(void)\r\n{\r\nmodule_t *pdc_pref_module;\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_pdc_len,\r\n{ "Length Indicator", "pdc.li",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_pdc_mpdu_code,\r\n{ "MPDU code", "pdc.mpducode",\r\nFT_UINT8, BASE_DEC, VALS(valstr_mpdus), 0x0, NULL, HFILL }},\r\n{ &hf_pdc_credit,\r\n{ "Credit", "pdc.cdt",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_pdc_yr_admu_nr,\r\n{ "YR-ADMU-NR", "pdc.yradmunr",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL , HFILL }},\r\n{ &hf_pdc_simpdu_state,\r\n{ "State", "pdc.state",\r\nFT_UINT8, BASE_DEC, VALS(valstr_simpdu_state), 0x0, NULL, HFILL }},\r\n{ &hf_pdc_akmpdu_mns,\r\n{ "MNS", "pdc.akmpdu.mns",\r\nFT_UINT16, BASE_DEC, NULL, 0x8000, NULL, HFILL }},\r\n{ &hf_pdc_akmpdu_cdt,\r\n{ "CDT", "pdc.akmpdu.cdt",\r\nFT_UINT16, BASE_DEC, NULL, 0x07FF, NULL, HFILL }},\r\n{ &hf_pdc_simpdu_var,\r\n{ "Variable Part", "pdc.simpdu.variable",\r\nFT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_pdc_simpdu_param,\r\n{ "Parameter", "pdc.simpdu.param",\r\nFT_UINT8, BASE_DEC, VALS(valstr_simpdu_param), 0x0, NULL, HFILL }},\r\n{ &hf_pdc_simpdu_var_len,\r\n{ "Length", "pdc.simpdu.variable.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_pdc_simpdu_var_version,\r\n{ "PDC Version Number", "pdc.simpdu.variable.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_pdc_simpdu_var_REFSRC,\r\n{ "Reference Source", "pdc.simpdu.variable.refsrc",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,NULL, HFILL }},\r\n{ &hf_pdc_simpdu_var_REFDEST,\r\n{ "Reference Destination", "pdc.simpdu.variable.refdst",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,NULL, HFILL }},\r\n{ &hf_pdc_simpdu_var_TSEL,\r\n{ "Transport Selector", "pdc.simpdu.tsel",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_pdc_drmpdu_abort,\r\n{ "Abort", "pdc.drmpdu.abort",\r\nFT_UINT8, BASE_DEC, VALS(valstr_drmpdu_abort), 0x80, NULL, HFILL }},\r\n{ &hf_pdc_drmpdu_reason,\r\n{ "Reason", "pdc.drmpdu.reason",\r\nFT_UINT8, BASE_DEC, VALS(valstr_drmpdu_reason), 0x0, NULL, HFILL }},\r\n{ &hf_pdc_drmpdu_mode,\r\n{ "Mode", "pdc.drmpdu.mode",\r\nFT_UINT8, BASE_DEC, VALS(valstr_drmpdu_mode), 0x70, NULL, HFILL }},\r\n{ &hf_pdc_drmpdu_init,\r\n{ "Reason", "pdc.drmpdu.init",\r\nFT_UINT8, BASE_DEC, VALS(valstr_drmpdu_initatior), 0x0F, NULL, HFILL }},\r\n{ &hf_pdc_dtmpdu_user_size,\r\n{ "User Data Length", "pdc.dtmpdu.usersize",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL , HFILL }},\r\n{ &hf_pdc_admpdu_admpdunr,\r\n{ "AD-MPDU-NR", "pdc.admpdu.admpdunr",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL , HFILL }},\r\n{ &hf_pdc_admpdu_size,\r\n{ "User Data Size", "pdc.admpdu.usersize",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL , HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_pdc,\r\n&ett_pdc_simpdu_var\r\n};\r\nproto_pdc = proto_register_protocol (\r\n"PDC Protocol",\r\n"PDC",\r\n"pdc"\r\n);\r\nproto_register_field_array(proto_pdc, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\npdc_pref_module = prefs_register_protocol(proto_pdc, proto_reg_handoff_pdc);\r\nprefs_register_uint_preference(pdc_pref_module, "tcp.port", "PDC Port", "PDC Port if other then the default", 10, &gPREF_PORT_NUM_TCP);\r\n}\r\nvoid proto_reg_handoff_pdc(void)\r\n{\r\nstatic dissector_handle_t pdc_tcp_handle;\r\nstatic int pdc_tcp_port;\r\nstatic gboolean initialized = FALSE;\r\nif (! initialized)\r\n{\r\nasterix_handle = find_dissector_add_dependency("asterix", proto_pdc);\r\npdc_tcp_handle = create_dissector_handle(tcp_dissect_pdc, proto_pdc);\r\ndissector_add_for_decode_as("tcp.port", pdc_tcp_handle);\r\ninitialized = TRUE;\r\n}\r\nelse\r\n{\r\nif (pdc_tcp_port != 0)\r\ndissector_delete_uint("tcp.port", pdc_tcp_port, pdc_tcp_handle);\r\n}\r\npdc_tcp_port = gPREF_PORT_NUM_TCP;\r\nif (pdc_tcp_port != 0)\r\ndissector_add_uint("tcp.port", pdc_tcp_port, pdc_tcp_handle);\r\n}

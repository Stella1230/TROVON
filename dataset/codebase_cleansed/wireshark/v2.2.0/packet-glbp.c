static int\r\ndissect_glbp_hello(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tlv_tree)\r\n{\r\nguint8 addrtype;\r\nguint8 addrlen;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_unknown10, tvb, offset, 1, ENC_NA);\r\noffset ++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_vgstate, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset ++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_unknown11, tvb, offset, 1, ENC_NA);\r\noffset ++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_priority, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_unknown12, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_helloint, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_holdint, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_redirect, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_timeout, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_unknown13, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_addrtype, tvb, offset, 1, ENC_BIG_ENDIAN);\r\naddrtype = tvb_get_guint8( tvb, offset);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_addrlen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\naddrlen = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nswitch (addrtype) {\r\ncase 1:\r\nif (addrlen != 4) {\r\nexpert_add_info_format(pinfo, NULL, &ei_glbp_ipv4_wrong_length,\r\n"Wrong IPv4 address length: %u", addrlen);\r\nreturn offset + addrlen;\r\n}\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_virtualipv4, tvb, offset, addrlen, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 2:\r\nif (addrlen != 16) {\r\nexpert_add_info_format(pinfo, NULL, &ei_glbp_ipv6_wrong_length,\r\n"Wrong IPv6 address length: %u", addrlen);\r\nreturn offset + addrlen;\r\n}\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_virtualipv6, tvb, offset, addrlen, ENC_NA);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(tlv_tree, hf_glbp_hello_virtualunk, tvb, offset, addrlen, ENC_NA);\r\nbreak;\r\n}\r\noffset += addrlen;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s",\r\nval_to_str(addrtype, glbp_addr_type_vals, "%d"));\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_glbp_reqresp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo _U_, proto_tree *tlv_tree)\r\n{\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_forwarder, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_vfstate, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_unknown21, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_priority, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_weight, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_unknown22, tvb, offset, 7, ENC_NA);\r\noffset += 7;\r\nproto_tree_add_item(tlv_tree, hf_glbp_reqresp_virtualmac, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_glbp_auth(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo _U_, proto_tree *tlv_tree)\r\n{\r\nguint8 authtype;\r\nguint8 authlength;\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_authtype, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nauthtype = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_authlength, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nauthlength = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nswitch(authtype) {\r\ncase 1:\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_plainpass, tvb, offset, authlength, ENC_ASCII|ENC_NA);\r\noffset += authlength;\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_md5hash, tvb, offset, authlength, ENC_NA);\r\noffset += authlength;\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_md5chainindex, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_md5chainhash, tvb, offset+4, authlength-4, ENC_NA);\r\noffset += authlength;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(tlv_tree, hf_glbp_auth_authunknown, tvb, offset, authlength, ENC_NA);\r\noffset += authlength;\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_glbp_unknown(tvbuff_t *tvb, int offset, guint32 length,\r\npacket_info *pinfo _U_, proto_tree *tlv_tree)\r\n{\r\nproto_tree_add_item(tlv_tree, hf_glbp_unknown_data, tvb, offset, length, ENC_NA);\r\noffset += length;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_glbp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *glbp_tree;\r\nproto_tree *tlv_tree;\r\nproto_item *ti;\r\nguint8 type;\r\nint offset = 0;\r\nint lastoffset;\r\nguint8 length;\r\nguint16 group;\r\ngroup = tvb_get_ntohs(tvb, 2);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "GLBP");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "G: %d", group);\r\nti = proto_tree_add_item(tree, proto_glbp, tvb, 0, -1, ENC_NA);\r\nglbp_tree = proto_item_add_subtree(ti, ett_glbp);\r\nproto_tree_add_item(glbp_tree, hf_glbp_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(glbp_tree, hf_glbp_unknown1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(glbp_tree, hf_glbp_group, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(glbp_tree, hf_glbp_unknown2, tvb, offset, 2, ENC_NA);\r\noffset += 2;\r\nproto_tree_add_item(glbp_tree, hf_glbp_ownerid, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\ntype = tvb_get_guint8(tvb, offset);\r\nlength = tvb_get_guint8(tvb, offset+1);\r\nif (length < 2) {\r\nexpert_add_info_format(pinfo, NULL, &ei_glbp_tlv_length_too_small,\r\n"Length %u too small", length);\r\nreturn offset;\r\n}\r\nlength -= 2;\r\nti = proto_tree_add_item(glbp_tree, hf_glbp_tlv, tvb, offset, length+2, ENC_BIG_ENDIAN);\r\ntlv_tree = proto_item_add_subtree(ti, ett_glbp_tlv);\r\nproto_item_append_text(ti, " l=%d, t=%s", length+2,\r\nval_to_str(type, glbp_type_vals, "%d"));\r\nproto_tree_add_item(tlv_tree, hf_glbp_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tlv_tree, hf_glbp_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s",\r\nval_to_str(type, glbp_type_vals, "%d"));\r\nlastoffset = offset;\r\nswitch(type) {\r\ncase 1:\r\noffset = dissect_glbp_hello(tvb, offset, pinfo, tlv_tree);\r\nbreak;\r\ncase 2:\r\noffset = dissect_glbp_reqresp(tvb, offset, pinfo, tlv_tree);\r\nbreak;\r\ncase 3:\r\noffset = dissect_glbp_auth(tvb, offset, pinfo, tlv_tree);\r\nbreak;\r\ndefault:\r\noffset = dissect_glbp_unknown(tvb, offset, length, pinfo, tlv_tree);\r\nbreak;\r\n}\r\nif (lastoffset >= offset) {\r\nexpert_add_info(pinfo, NULL, &ei_glbp_tlv_invalid_bytes_used);\r\nreturn lastoffset;\r\n}\r\nif (lastoffset + length > offset)\r\noffset = lastoffset + length;\r\n}\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ntest_glbp(tvbuff_t *tvb, packet_info *pinfo)\r\n{\r\nguint32 unknown1;\r\nif ( tvb_captured_length(tvb) < 2)\r\nreturn FALSE;\r\nunknown1 = tvb_get_guint8(tvb, 1);\r\nif (tvb_get_guint8(tvb, 0) != 1\r\n|| unknown1 > 4\r\n|| pinfo->srcport != pinfo->destport\r\n#if 0\r\n|| unknown1 == 0 && pinfo->net_dst != ipv4:224.0.0.102\r\n&& pinfo->net_dst != ipv6:...\r\n|| unknown1 == 0 && pinfo->dl_src != ether:c2-00-7c-b8-00-00\r\n#endif\r\n) {\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int\r\ndissect_glbp_static(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif ( !test_glbp(tvb, pinfo) ) {\r\nreturn 0;\r\n}\r\nreturn dissect_glbp(tvb, pinfo, tree);\r\n}\r\nvoid\r\nproto_register_glbp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_glbp_version,\r\n{ "Version?", "glbp.version", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_unknown1,\r\n{ "Unknown1", "glbp.unknown1", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_group,\r\n{ "Group", "glbp.group", FT_UINT16, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_unknown2,\r\n{ "Unknown2", "glbp.unknown2", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_ownerid,\r\n{ "Owner ID", "glbp.ownerid", FT_ETHER, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_tlv,\r\n{ "TLV", "glbp.tlv", FT_PROTOCOL, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_type,\r\n{ "Type", "glbp.type", FT_UINT8, BASE_DEC, VALS(glbp_type_vals),\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_length,\r\n{ "Length", "glbp.length", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_unknown10,\r\n{ "Unknown1-0", "glbp.hello.unknown10", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_vgstate,\r\n{ "VG state?", "glbp.hello.vgstate", FT_UINT8, BASE_DEC, VALS(glbp_vgstate_vals),\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_unknown11,\r\n{ "Unknown1-1", "glbp.hello.unknown11", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_priority,\r\n{ "Priority", "glbp.hello.priority", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_unknown12,\r\n{ "Unknown1-2", "glbp.hello.unknown12", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_helloint,\r\n{ "Helloint", "glbp.hello.helloint", FT_UINT32, BASE_DEC, NULL,\r\n0x0, "Hello interval [msec]", HFILL }},\r\n{ &hf_glbp_hello_holdint,\r\n{ "Holdint", "glbp.hello.holdint", FT_UINT32, BASE_DEC, NULL,\r\n0x0, "Hold interval [msec]", HFILL }},\r\n{ &hf_glbp_hello_redirect,\r\n{ "Redirect", "glbp.hello.redirect", FT_UINT16, BASE_DEC, NULL,\r\n0x0, "Redirect interval [sec]", HFILL }},\r\n{ &hf_glbp_hello_timeout,\r\n{ "Timeout", "glbp.hello.timeout", FT_UINT16, BASE_DEC, NULL,\r\n0x0, "Forwarder timeout interval [sec]", HFILL }},\r\n{ &hf_glbp_hello_unknown13,\r\n{ "Unknown1-3", "glbp.hello.unknown13", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_addrtype,\r\n{ "Address type", "glbp.hello.addrtype", FT_UINT8, BASE_DEC, VALS(glbp_addr_type_vals),\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_addrlen,\r\n{ "Address length", "glbp.hello.addrlen", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_virtualipv4,\r\n{ "Virtual IPv4", "glbp.hello.virtualipv4", FT_IPv4, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_virtualipv6,\r\n{ "Virtual IPv6", "glbp.hello.virtualipv6", FT_IPv6, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_hello_virtualunk,\r\n{ "Virtual Unknown", "glbp.hello.virtualunk", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_forwarder,\r\n{ "Forwarder?", "glbp.reqresp.forwarder", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_vfstate,\r\n{ "VF state?", "glbp.reqresp.vfstate", FT_UINT8, BASE_DEC, VALS(glbp_vfstate_vals),\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_unknown21,\r\n{ "Unknown2-1", "glbp.reqresp.unknown21", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_priority,\r\n{ "Priority", "glbp.reqresp.priority", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_weight,\r\n{ "Weight", "glbp.reqresp.weight", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_unknown22,\r\n{ "Unknown2-2", "glbp.reqresp.unknown22", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_reqresp_virtualmac,\r\n{ "Virtualmac", "glbp.reqresp.virtualmac", FT_ETHER, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_authtype,\r\n{ "Authtype", "glbp.auth.authtype", FT_UINT8, BASE_DEC, VALS(glbp_auth_type_vals),\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_authlength,\r\n{ "Authlength", "glbp.auth.authlength", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_plainpass,\r\n{ "Plain pass", "glbp.auth.plainpass", FT_STRING, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_md5hash,\r\n{ "MD5-string hash", "glbp.auth.md5hash", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_md5chainindex,\r\n{ "MD5-chain index", "glbp.auth.md5chainindex", FT_UINT32, BASE_DEC, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_md5chainhash,\r\n{ "MD5-chain hash", "glbp.auth.md5chainhash", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_auth_authunknown,\r\n{ "Unknown auth value", "glbp.auth.authunknown", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n{ &hf_glbp_unknown_data,\r\n{ "Unknown TLV data", "glbp.unknown.data", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_glbp,\r\n&ett_glbp_tlv,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_glbp_ipv4_wrong_length,\r\n{ "glbp.ipv4_wrong_length", PI_MALFORMED, PI_ERROR,\r\n"Wrong IPv4 address length: %u",\r\nEXPFILL }},\r\n{ &ei_glbp_ipv6_wrong_length,\r\n{ "glbp.ipv6_wrong_length", PI_MALFORMED, PI_ERROR,\r\n"Wrong IPv6 address length: %u",\r\nEXPFILL }},\r\n{ &ei_glbp_tlv_length_too_small,\r\n{ "glbp.tlv_length_too_small", PI_MALFORMED, PI_ERROR,\r\n"Length %u too small",\r\nEXPFILL }},\r\n{ &ei_glbp_tlv_invalid_bytes_used,\r\n{ "glbp.tlv_invalid_bytes_used", PI_MALFORMED, PI_ERROR,\r\n"Zero or negative length",\r\nEXPFILL }},\r\n};\r\nexpert_module_t* expert_glbp;\r\nproto_glbp = proto_register_protocol(\r\n"Gateway Load Balancing Protocol", "GLBP", "glbp");\r\nproto_register_field_array(proto_glbp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_glbp = expert_register_protocol(proto_glbp);\r\nexpert_register_field_array(expert_glbp, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_glbp(void)\r\n{\r\ndissector_handle_t glbp_handle;\r\nglbp_handle = create_dissector_handle(dissect_glbp_static, proto_glbp);\r\ndissector_add_uint("udp.port", 3222, glbp_handle);\r\n}

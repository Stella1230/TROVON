static int\r\ndissect_who(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_tree *who_tree;\r\nproto_item *who_ti;\r\nguint8 *server_name;\r\ndouble loadav_5 = 0.0, loadav_10 = 0.0, loadav_15 = 0.0;\r\nnstime_t ts;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WHO");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nts.nsecs = 0;\r\nwho_ti = proto_tree_add_item(tree, proto_who, tvb, offset, -1, ENC_NA);\r\nwho_tree = proto_item_add_subtree(who_ti, ett_who);\r\nproto_tree_add_item(who_tree, hf_who_vers, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(who_tree, hf_who_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 2;\r\nif (tree) {\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_time(who_tree, hf_who_sendtime, tvb, offset, 4,\r\n&ts);\r\n}\r\noffset += 4;\r\nif (tree) {\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_time(who_tree, hf_who_recvtime, tvb, offset, 4,\r\n&ts);\r\n}\r\noffset += 4;\r\nserver_name = tvb_get_stringzpad(wmem_packet_scope(), tvb, offset, 32, ENC_ASCII|ENC_NA);\r\nproto_tree_add_string(who_tree, hf_who_hostname, tvb, offset, 32, server_name);\r\noffset += 32;\r\nloadav_5 = tvb_get_ntohl(tvb, offset) / 100.0;\r\nproto_tree_add_double(who_tree, hf_who_loadav_5, tvb, offset,\r\n4, loadav_5);\r\noffset += 4;\r\nloadav_10 = tvb_get_ntohl(tvb, offset) / 100.0;\r\nproto_tree_add_double(who_tree, hf_who_loadav_10, tvb, offset,\r\n4, loadav_10);\r\noffset += 4;\r\nloadav_15 = tvb_get_ntohl(tvb, offset) / 100.0;\r\nproto_tree_add_double(who_tree, hf_who_loadav_15, tvb, offset,\r\n4, loadav_15);\r\noffset += 4;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s: %.02f %.02f %.02f",\r\nserver_name, loadav_5, loadav_10, loadav_15);\r\nif (tree) {\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_time(who_tree, hf_who_boottime, tvb, offset, 4,\r\n&ts);\r\noffset += 4;\r\ndissect_whoent(tvb, offset, who_tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\ndissect_whoent(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree *whoent_tree = NULL;\r\nproto_item *whoent_ti = NULL;\r\nint line_offset = offset;\r\nguint8 *out_line;\r\nguint8 *out_name;\r\nnstime_t ts;\r\nint whoent_num = 0;\r\nguint32 idle_secs;\r\nts.nsecs = 0;\r\nwhile (tvb_reported_length_remaining(tvb, line_offset) > 0\r\n&& whoent_num < MAX_NUM_WHOENTS) {\r\nwhoent_ti = proto_tree_add_item(tree, hf_who_whoent, tvb,\r\nline_offset, SIZE_OF_WHOENT, ENC_NA);\r\nwhoent_tree = proto_item_add_subtree(whoent_ti, ett_whoent);\r\nout_line = tvb_get_stringzpad(wmem_packet_scope(), tvb, line_offset, 8, ENC_ASCII|ENC_NA);\r\nproto_tree_add_string(whoent_tree, hf_who_tty, tvb, line_offset,\r\n8, out_line);\r\nline_offset += 8;\r\nout_name = tvb_get_stringzpad(wmem_packet_scope(), tvb, line_offset, 8, ENC_ASCII|ENC_NA);\r\nproto_tree_add_string(whoent_tree, hf_who_uid, tvb, line_offset,\r\n8, out_name);\r\nline_offset += 8;\r\nts.secs = tvb_get_ntohl(tvb, line_offset);\r\nproto_tree_add_time(whoent_tree, hf_who_timeon, tvb,\r\nline_offset, 4, &ts);\r\nline_offset += 4;\r\nidle_secs = tvb_get_ntohl(tvb, line_offset);\r\nproto_tree_add_uint_format(whoent_tree, hf_who_idle, tvb,\r\nline_offset, 4, idle_secs, "Idle: %s",\r\nsigned_time_secs_to_str(wmem_packet_scope(), idle_secs));\r\nline_offset += 4;\r\nwhoent_num++;\r\n}\r\n}\r\nvoid\r\nproto_register_who(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_who_vers,\r\n{ "Version", "who.vers", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_type,\r\n{ "Type", "who.type", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_sendtime,\r\n{ "Send Time", "who.sendtime", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_recvtime,\r\n{ "Receive Time", "who.recvtime", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_hostname,\r\n{ "Hostname", "who.hostname", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_loadav_5,\r\n{ "Load Average Over Past 5 Minutes", "who.loadav_5", FT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_loadav_10,\r\n{ "Load Average Over Past 10 Minutes", "who.loadav_10", FT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_loadav_15,\r\n{ "Load Average Over Past 15 Minutes", "who.loadav_15", FT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_boottime,\r\n{ "Boot Time", "who.boottime", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_whoent,\r\n{ "Who utmp Entry", "who.entry", FT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_tty,\r\n{ "TTY Name", "who.tty", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_uid,\r\n{ "User ID", "who.uid", FT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_timeon,\r\n{ "Time On", "who.timeon", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_who_idle,\r\n{ "Time Idle", "who.idle", FT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_who,\r\n&ett_whoent,\r\n};\r\nproto_who = proto_register_protocol("Who", "WHO", "who");\r\nproto_register_field_array(proto_who, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_who(void)\r\n{\r\ndissector_handle_t who_handle;\r\nwho_handle = create_dissector_handle(dissect_who, proto_who);\r\ndissector_add_uint("udp.port", UDP_PORT_WHO, who_handle);\r\n}

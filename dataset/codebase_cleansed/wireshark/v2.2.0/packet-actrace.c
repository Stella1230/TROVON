static int dissect_actrace(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *actrace_tree;\r\nproto_item *ti;\r\nint actrace_protocol;\r\nactrace_tree = NULL;\r\nactrace_protocol = is_actrace(tvb, 0);\r\nif (actrace_protocol != NOT_ACTRACE)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AC_TRACE");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree)\r\n{\r\nti = proto_tree_add_item(tree,proto_actrace,tvb,0,-1, ENC_NA);\r\nactrace_tree = proto_item_add_subtree(ti, ett_actrace);\r\n}\r\nswitch (actrace_protocol)\r\n{\r\ncase ACTRACE_CAS:\r\ndissect_actrace_cas(tvb, pinfo, actrace_tree);\r\nbreak;\r\ncase ACTRACE_ISDN:\r\ndissect_actrace_isdn(tvb, pinfo, tree, actrace_tree);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nreturn 0;\r\n}\r\nstatic void dissect_actrace_cas(tvbuff_t *tvb, packet_info *pinfo, proto_tree *actrace_tree)\r\n{\r\ngint32 value, function, trunk, bchannel, source, event, curr_state, next_state;\r\ngint32 par0, par1, par2;\r\nconst gchar *frame_label = NULL;\r\nint direction = 0;\r\nint offset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AC_CAS");\r\nvalue = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_time, tvb, offset, 4, value);\r\noffset += 4;\r\nsource = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_source, tvb, offset, 4, source);\r\noffset += 4;\r\ncurr_state = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_current_state, tvb, offset, 4, curr_state);\r\noffset += 4;\r\nevent = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_event, tvb, offset, 4, event);\r\noffset += 4;\r\nnext_state = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_next_state, tvb, offset, 4, next_state);\r\noffset += 4;\r\nfunction = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_function, tvb, offset, 4, function);\r\noffset += 4;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s|%d|%s|%d|%s|",\r\nval_to_str_const(source, actrace_cas_source_vals_short, "ukn"),\r\ncurr_state,\r\nval_to_str_ext(event, &actrace_cas_event_vals_ext, "%d"),\r\nnext_state,\r\nval_to_str_ext(function, &actrace_cas_function_vals_ext, "%d"));\r\npar0 = tvb_get_ntohl(tvb, offset);\r\nswitch (function)\r\n{\r\ncase SEND_EVENT:\r\nproto_tree_add_int_format_value(actrace_tree, hf_actrace_cas_par0, tvb, offset, 4,\r\npar0, "%s", val_to_str_ext(par0, &actrace_cas_pstn_event_vals_ext, "Unknown (%d)"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s|",\r\nval_to_str_ext(par0, &actrace_cas_pstn_event_vals_ext, "%d"));\r\nbreak;\r\ncase CHANGE_COLLECT_TYPE:\r\nproto_tree_add_int_format_value(actrace_tree, hf_actrace_cas_par0, tvb, offset, 4,\r\npar0, "%s", val_to_str(par0, actrace_cas_collect_type_vals, "Unknown (%d)"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s|",\r\nval_to_str(par0, actrace_cas_collect_type_vals, "%d"));\r\nbreak;\r\ncase SEND_MF:\r\ncase SEND_DEST_NUM:\r\nproto_tree_add_int_format_value(actrace_tree, hf_actrace_cas_par0, tvb, offset, 4,\r\npar0, "%s", val_to_str(par0, actrace_cas_send_type_vals, "Unknown (%d)"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s|",\r\nval_to_str(par0, actrace_cas_send_type_vals, "%d"));\r\nbreak;\r\ndefault:\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_par0, tvb, offset, 4, par0);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%d|", par0);\r\n}\r\noffset += 4;\r\npar1 = tvb_get_ntohl(tvb, offset);\r\nif (function == SEND_EVENT) {\r\nproto_tree_add_int_format_value(actrace_tree, hf_actrace_cas_par1, tvb, offset, 4,\r\npar1, "%s", val_to_str_ext(par1, &actrace_cas_cause_vals_ext, "Unknown (%d)"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s|",\r\nval_to_str_ext(par1, &actrace_cas_cause_vals_ext, "%d"));\r\n} else {\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_par1, tvb, offset, 4, par1);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%d|", par1);\r\n}\r\noffset += 4;\r\npar2 = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_par2, tvb, offset, 4, par2);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%d|", par2);\r\noffset += 4;\r\ntrunk = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_trunk, tvb, offset, 4, trunk);\r\noffset += 4;\r\nbchannel = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_bchannel, tvb, offset, 4, bchannel);\r\noffset += 4;\r\ncol_prepend_fstr(pinfo->cinfo, COL_INFO, "t%db%d|", trunk, bchannel);\r\nvalue = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_cas_connection_id, tvb, offset, 4, value);\r\nif (source == ACTRACE_CAS_SOURCE_DSP) {\r\ndirection = 1;\r\nif ( (event >= ACTRACE_CAS_EV_11) && (event <= ACTRACE_CAS_EV_00 ) ) {\r\nframe_label = wmem_strdup_printf(wmem_packet_scope(), "AB: %s", val_to_str_const(event, actrace_cas_event_ab_vals, "ERROR") );\r\n} else if ( (event >= 32) && (event <= 46 ) ) {\r\nframe_label = wmem_strdup_printf(wmem_packet_scope(), "MF: %s", val_to_str_ext_const(event, &actrace_cas_mf_vals_ext, "ERROR") );\r\n} else if ( (event == ACTRACE_CAS_EV_DTMF ) || (event == ACTRACE_CAS_EV_FIRST_DIGIT ) ) {\r\nframe_label = wmem_strdup_printf(wmem_packet_scope(), "DTMF: %u", par0 );\r\n}\r\n} else if (source == ACTRACE_CAS_SOURCE_TABLE) {\r\ndirection = 0;\r\nif (function == SEND_MF) {\r\nif (par0 == SEND_TYPE_SPECIFIC ) {\r\nframe_label = wmem_strdup_printf(wmem_packet_scope(), "MF: %u", par1);\r\n} else if (par0 == SEND_TYPE_ADDRESS ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "MF: DNIS digit");\r\n} else if (par0 == SEND_TYPE_ANI ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "MF: ANI digit");\r\n} else if (par0 == SEND_TYPE_SOURCE_CATEGORY ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "MF: src_category");\r\n} else if (par0 == SEND_TYPE_TRANSFER_CAPABILITY ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "MF: trf_capability");\r\n} else if (par0 == SEND_TYPE_INTER_EXCHANGE_SWITCH ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "MF: inter_exch_sw");\r\n}\r\n} else if (function == SEND_CAS) {\r\nframe_label = wmem_strdup_printf(wmem_packet_scope(), "AB: %s", val_to_str_const(ACTRACE_CAS_EV_00-par0, actrace_cas_event_ab_vals, "ERROR"));\r\n} else if (function == SEND_DEST_NUM) {\r\nif (par0 == SEND_TYPE_ADDRESS ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "DTMF/MF: sending DNIS");\r\n} else if (par0 == SEND_TYPE_ANI ) {\r\nframe_label = wmem_strdup(wmem_packet_scope(), "DTMF/MF: sending ANI");\r\n}\r\n}\r\n}\r\nif (frame_label != NULL) {\r\nactrace_pi = wmem_new(wmem_packet_scope(), actrace_info_t);\r\nactrace_pi->type = ACTRACE_CAS;\r\nactrace_pi->direction = direction;\r\nactrace_pi->trunk = trunk;\r\nactrace_pi->cas_bchannel = bchannel;\r\nactrace_pi->cas_frame_label = frame_label;\r\ntap_queue_packet(actrace_tap, pinfo, actrace_pi);\r\n}\r\n}\r\nstatic void dissect_actrace_isdn(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nproto_tree *actrace_tree)\r\n{\r\ngint len;\r\ngint32 value, trunk;\r\ntvbuff_t *next_tvb;\r\nint offset = 0;\r\nlen = tvb_get_ntohs(tvb, 44);\r\nvalue = tvb_get_ntohl(tvb, offset+4);\r\nproto_tree_add_int(actrace_tree, hf_actrace_isdn_direction, tvb, offset+4, 4, value);\r\noffset += 8;\r\ntrunk = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_int(actrace_tree, hf_actrace_isdn_trunk, tvb, offset, 2, trunk);\r\noffset = 44;\r\nproto_tree_add_int(actrace_tree, hf_actrace_isdn_length, tvb, offset, 2, len);\r\nif (len > 4) {\r\nactrace_pi = wmem_new(wmem_packet_scope(), actrace_info_t);\r\nactrace_pi->type = ACTRACE_ISDN;\r\nactrace_pi->direction = (value==PSTN_TO_BLADE?1:0);\r\nactrace_pi->trunk = trunk;\r\ntap_queue_packet(actrace_tap, pinfo, actrace_pi);\r\n}\r\noffset += 2 ;\r\nnext_tvb = tvb_new_subset_length(tvb, offset, len);\r\ncall_dissector(lapd_handle, next_tvb, pinfo, tree);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AC_ISDN");\r\ncol_prepend_fstr(pinfo->cinfo, COL_INFO, "Trunk:%d Blade %s PSTN "\r\n, trunk, value==PSTN_TO_BLADE?"<--":"-->");\r\n}\r\nstatic int is_actrace(tvbuff_t *tvb, gint offset)\r\n{\r\ngint tvb_len;\r\ngint32 source, isdn_header;\r\ntvb_len = tvb_reported_length(tvb);\r\nsource = tvb_get_ntohl(tvb, offset+4);\r\nif ( (tvb_len == 48) && ((source > -1) && (source <3)) )\r\nreturn ACTRACE_CAS;\r\nisdn_header = tvb_get_ntohl(tvb, offset+4);\r\nif ( (tvb_len >= 50) && ( (isdn_header == PSTN_TO_BLADE) || (isdn_header == BLADE_TO_PSTN)) )\r\nreturn ACTRACE_ISDN;\r\nreturn NOT_ACTRACE;\r\n}\r\nvoid proto_register_actrace(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_actrace_cas_time,\r\n{ "Time", "actrace.cas.time", FT_INT32, BASE_DEC, NULL, 0x0,\r\n"Capture Time", HFILL }},\r\n{ &hf_actrace_cas_source,\r\n{ "Source", "actrace.cas.source", FT_INT32, BASE_DEC, VALS(actrace_cas_source_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_current_state,\r\n{ "Current State", "actrace.cas.curr_state", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_event,\r\n{ "Event", "actrace.cas.event", FT_INT32, BASE_DEC|BASE_EXT_STRING, &actrace_cas_event_vals_ext, 0x0,\r\n"New Event", HFILL }},\r\n{ &hf_actrace_cas_next_state,\r\n{ "Next State", "actrace.cas.next_state", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_function,\r\n{ "Function", "actrace.cas.function", FT_INT32, BASE_DEC|BASE_EXT_STRING, &actrace_cas_function_vals_ext, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_par0,\r\n{ "Parameter 0", "actrace.cas.par0", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_par1,\r\n{ "Parameter 1", "actrace.cas.par1", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_par2,\r\n{ "Parameter 2", "actrace.cas.par2", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_trunk,\r\n{ "Trunk Number", "actrace.cas.trunk", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_bchannel,\r\n{ "BChannel", "actrace.cas.bchannel", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_cas_connection_id,\r\n{ "Connection ID", "actrace.cas.conn_id", FT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_isdn_trunk,\r\n{ "Trunk Number", "actrace.isdn.trunk", FT_INT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_isdn_direction,\r\n{ "Direction", "actrace.isdn.dir", FT_INT32, BASE_DEC, VALS(actrace_isdn_direction_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_actrace_isdn_length,\r\n{ "Length", "actrace.isdn.length", FT_INT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_actrace,\r\n};\r\nmodule_t *actrace_module;\r\nproto_actrace = proto_register_protocol("AudioCodes Trunk Trace", "ACtrace", "actrace");\r\nproto_register_field_array(proto_actrace, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nactrace_module = prefs_register_protocol(proto_actrace, proto_reg_handoff_actrace);\r\nprefs_register_uint_preference(actrace_module, "udp_port",\r\n"AudioCodes Trunk Trace UDP port",\r\n"Set the UDP port for AudioCodes Trunk Traces."\r\n"Use http://x.x.x.x/TrunkTraces to enable the traces in the Blade",\r\n10, &global_actrace_udp_port);\r\nprefs_register_obsolete_preference(actrace_module, "display_dissect_tree");\r\nactrace_tap = register_tap("actrace");\r\n}\r\nvoid proto_reg_handoff_actrace(void)\r\n{\r\nstatic gboolean actrace_prefs_initialized = FALSE;\r\nstatic dissector_handle_t actrace_handle;\r\nstatic guint actrace_udp_port;\r\nif (!actrace_prefs_initialized)\r\n{\r\nactrace_handle = create_dissector_handle(dissect_actrace, proto_actrace);\r\nlapd_handle = find_dissector_add_dependency("lapd", proto_actrace);\r\nactrace_prefs_initialized = TRUE;\r\n}\r\nelse\r\n{\r\ndissector_delete_uint("udp.port", actrace_udp_port, actrace_handle);\r\n}\r\nactrace_udp_port = global_actrace_udp_port;\r\ndissector_add_uint("udp.port", global_actrace_udp_port, actrace_handle);\r\n}

static int\r\ndissect_h263P( tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_ )\r\n{\r\nproto_item *ti = NULL;\r\nproto_item *data_item = NULL;\r\nproto_item *extra_hdr_item = NULL;\r\nproto_tree *h263P_tree = NULL;\r\nproto_tree *h263P_extr_hdr_tree = NULL;\r\nproto_tree *h263P_data_tree = NULL;\r\nunsigned int offset = 0;\r\nguint16 data16, plen;\r\nguint8 startcode;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "H.263 RFC4629 ");\r\nif ( tree ) {\r\nti = proto_tree_add_item( tree, proto_h263P, tvb, offset, -1, ENC_NA );\r\nh263P_tree = proto_item_add_subtree( ti, ett_h263P );\r\ndata16 = tvb_get_ntohs(tvb,offset);\r\nproto_tree_add_item( h263P_tree, hf_h263P_rr, tvb, offset, 2, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( h263P_tree, hf_h263P_pbit, tvb, offset, 2, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( h263P_tree, hf_h263P_vbit, tvb, offset, 2, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( h263P_tree, hf_h263P_plen, tvb, offset, 2, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( h263P_tree, hf_h263P_pebit, tvb, offset, 2, ENC_BIG_ENDIAN );\r\noffset = offset +2;\r\nif ((data16&0x0200)==0x0200){\r\nproto_tree_add_item( h263P_tree, hf_h263P_tid, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( h263P_tree, hf_h263P_trun, tvb, offset, 1, ENC_BIG_ENDIAN );\r\nproto_tree_add_item( h263P_tree, hf_h263P_s, tvb, offset, 1, ENC_BIG_ENDIAN );\r\noffset++;\r\n}\r\nplen = (data16 & 0x01f8) >> 3;\r\nif (plen != 0){\r\nextra_hdr_item = proto_tree_add_item( h263P_tree, hf_h263P_extra_hdr, tvb, offset, plen, ENC_NA );\r\nh263P_extr_hdr_tree = proto_item_add_subtree( extra_hdr_item, ett_h263P_extra_hdr );\r\ndissect_h263_picture_layer( tvb, pinfo, h263P_extr_hdr_tree, offset, plen, TRUE);\r\noffset += plen;\r\n}\r\nif ((data16&0x0400)!=0){\r\ndata_item = proto_tree_add_item( h263P_tree, hf_h263P_payload, tvb, offset, -1, ENC_NA );\r\nh263P_data_tree = proto_item_add_subtree( data_item, ett_h263P_data );\r\nstartcode = tvb_get_guint8(tvb,offset)&0xfe;\r\nif (startcode & 0x80){\r\nswitch(startcode){\r\ncase 0xf8:\r\nbreak;\r\ncase 0x80:\r\ncase 0x82:\r\ncol_append_str( pinfo->cinfo, COL_INFO, "(PSC) ");\r\ndissect_h263_picture_layer( tvb, pinfo, h263P_data_tree, offset, -1, TRUE);\r\nbreak;\r\ncase 0xfc:\r\ncase 0xfe:\r\ndefault:\r\ncol_append_str( pinfo->cinfo, COL_INFO, "(GBSC) ");\r\ndissect_h263_group_of_blocks_layer( tvb, h263P_data_tree, offset,TRUE);\r\nbreak;\r\n}\r\n}else{\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nproto_tree_add_item( h263P_tree, hf_h263P_payload, tvb, offset, -1, ENC_NA );\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_reg_handoff_h263P(void)\r\n{\r\nstatic dissector_handle_t h263P_handle;\r\nstatic guint dynamic_payload_type;\r\nstatic gboolean h263P_prefs_initialized = FALSE;\r\nif (!h263P_prefs_initialized) {\r\nh263P_handle = find_dissector("h263P");\r\ndissector_add_string("rtp_dyn_payload_type","H263-1998", h263P_handle);\r\ndissector_add_string("rtp_dyn_payload_type","H263-2000", h263P_handle);\r\nh263P_prefs_initialized = TRUE;\r\n}\r\nelse {\r\nif ( dynamic_payload_type > 95 )\r\ndissector_delete_uint("rtp.pt", dynamic_payload_type, h263P_handle);\r\n}\r\ndynamic_payload_type = temp_dynamic_payload_type;\r\nif ( dynamic_payload_type > 95 ){\r\ndissector_add_uint("rtp.pt", dynamic_payload_type, h263P_handle);\r\n}\r\n}\r\nvoid\r\nproto_register_h263P(void)\r\n{\r\nmodule_t *h263P_module;\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_h263P_payload,\r\n{\r\n"H.263 RFC4629 payload",\r\n"h263p.payload",\r\nFT_NONE,\r\nBASE_NONE,\r\nNULL,\r\n0x0,\r\n"The actual H.263 RFC4629 data", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_rr,\r\n{\r\n"Reserved",\r\n"h263p.rr",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0xf800,\r\n"Reserved SHALL be zero", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_pbit,\r\n{\r\n"P",\r\n"h263p.p",\r\nFT_BOOLEAN,\r\n16,\r\nNULL,\r\n0x0400,\r\n"Indicates (GOB/Slice) start or (EOS or EOSBS)", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_vbit,\r\n{\r\n"V",\r\n"h263p.v",\r\nFT_BOOLEAN,\r\n16,\r\nNULL,\r\n0x0200,\r\n"presence of Video Redundancy Coding (VRC) field", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_plen,\r\n{\r\n"PLEN",\r\n"h263p.plen",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x01f8,\r\n"Length, in bytes, of the extra picture header", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_pebit,\r\n{\r\n"PEBIT",\r\n"h263p.pebit",\r\nFT_UINT16,\r\nBASE_DEC,\r\nNULL,\r\n0x0003,\r\n"number of bits that shall be ignored in the last byte of the picture header", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_tid,\r\n{\r\n"Thread ID",\r\n"h263p.tid",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0xe0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_trun,\r\n{\r\n"Trun",\r\n"h263p.trun",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x1e,\r\n"Monotonically increasing (modulo 16) 4-bit number counting the packet number within each thread", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_s,\r\n{\r\n"S",\r\n"h263p.s",\r\nFT_UINT8,\r\nBASE_DEC,\r\nNULL,\r\n0x01,\r\n"Indicates that the packet content is for a sync frame", HFILL\r\n}\r\n},\r\n{\r\n&hf_h263P_extra_hdr,\r\n{\r\n"Extra picture header",\r\n"h263p.extra_hdr",\r\nFT_BYTES,\r\nBASE_NONE,\r\nNULL,\r\n0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{\r\n&hf_h263P_PSC,\r\n{\r\n"H.263 PSC",\r\n"h263p.PSC",\r\nFT_UINT16,\r\nBASE_HEX,\r\nNULL,\r\n0xfc00,\r\n"Picture Start Code(PSC)", HFILL\r\n}\r\n},\r\n#endif\r\n#if 0\r\n{\r\n&hf_h263P_TR,\r\n{\r\n"H.263 Temporal Reference",\r\n"h263p.tr",\r\nFT_UINT16,\r\nBASE_HEX,\r\nNULL,\r\n0x03fc,\r\n"Temporal Reference, TR", HFILL\r\n}\r\n},\r\n#endif\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_h263P,\r\n&ett_h263P_extra_hdr,\r\n&ett_h263P_payload,\r\n&ett_h263P_data,\r\n};\r\nproto_h263P = proto_register_protocol("ITU-T Recommendation H.263 RTP Payload header (RFC4629)",\r\n"H263P", "h263p");\r\nproto_register_field_array(proto_h263P, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nh263P_module = prefs_register_protocol(proto_h263P, proto_reg_handoff_h263P);\r\nprefs_register_uint_preference(h263P_module,\r\n"dynamic.payload.type",\r\n"H263-1998 and H263-2000 dynamic payload type",\r\n"The dynamic payload type which will be interpreted as H264"\r\n"; The value must be greater than 95",\r\n10,\r\n&temp_dynamic_payload_type);\r\nregister_dissector("h263P", dissect_h263P, proto_h263P);\r\n}

static void\r\ndecode_messagepara(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, hislipinfo *data)\r\n{\r\nproto_item * item = NULL;\r\nproto_tree *msgpara_tree;\r\nitem = proto_tree_add_item(tree, hf_hislip_messageparameter, tvb, data->offset, 4, ENC_NA);\r\nmsgpara_tree = proto_item_add_subtree(item, ett_hislip_msgpara);\r\nswitch (data->messagetype)\r\n{\r\ncase HISLIP_INITIALIZE:\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_clientproto, tvb, data->offset, 2, ENC_BIG_ENDIAN );\r\ndata->offset += 2;\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_vendorID, tvb, data->offset, 2, ENC_BIG_ENDIAN );\r\ndata->offset += 2;\r\nbreak;\r\ncase HISLIP_INITIALIZERESPONSE:\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_serverproto, tvb, data->offset, 2, ENC_BIG_ENDIAN );\r\ndata->offset += 2;\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_sessionid, tvb, data->offset, 2, ENC_BIG_ENDIAN );\r\ndata->offset += 2;\r\nbreak;\r\ncase HISLIP_ASYNCLOCK:\r\nif (data->controlcode)\r\n{\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_timeout, tvb, data->offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_messageid, tvb, data->offset, 4, ENC_BIG_ENDIAN);\r\n}\r\ndata->offset += 4;\r\nbreak;\r\ncase HISLIP_ASYNCLOCKINFORESPONSE:\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_clients, tvb, data->offset, 4, ENC_BIG_ENDIAN );\r\ndata->offset += 4;\r\nbreak;\r\ncase HISLIP_ASYNCINITIALIZE:\r\ndata->offset += 2;\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_sessionid, tvb, data->offset, 2, ENC_BIG_ENDIAN);\r\ndata->offset += 2;\r\nbreak;\r\ncase HISLIP_ASYNCINITIALIZERESPONSE:\r\ndata->offset += 2;\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_vendorID, tvb, data->offset, 2, ENC_BIG_ENDIAN );\r\ndata->offset += 2;\r\nbreak;\r\ncase HISLIP_DATA:\r\ncase HISLIP_DATAEND:\r\ncase HISLIP_TRIGGER:\r\ncase HISLIP_INTERRUPTED:\r\ncase HISLIP_ASYNCINTERRUPTED:\r\ncase HISLIP_ASYNCSTATUSQUERY:\r\ncase HISLIP_ASYNCREMOTELOCALCONTROL:\r\nproto_tree_add_item(msgpara_tree, hf_hislip_msgpara_messageid, tvb, data->offset, 4, ENC_BIG_ENDIAN );\r\nproto_item_append_text(data->hislip_item, ", MessageId: 0x%0x", data->messageparameter);\r\ndata->offset += 4;\r\nbreak;\r\ndefault:\r\nif (data->messageparameter != 0)\r\n{\r\nproto_tree_add_expert(msgpara_tree, pinfo, &ei_msg_not_null, tvb, data->offset, 4);\r\n}\r\ndata->offset += 4;\r\n}\r\n}\r\nstatic void\r\ndecode_controlcode(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, hislipinfo *data, guint8 oldcontrolvalue)\r\n{\r\nproto_item * item = NULL;\r\nswitch (data->messagetype )\r\n{\r\ncase HISLIP_DATA:\r\ncase HISLIP_DATAEND:\r\ncase HISLIP_TRIGGER:\r\ncase HISLIP_ASYNCSTATUSQUERY:\r\nproto_tree_add_item(tree, hf_hislip_controlcode_rmt, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\nbreak;\r\ncase HISLIP_INITIALIZERESPONSE:\r\nproto_tree_add_item(tree, hf_hislip_controlcode_overlap, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", val_to_str(data->controlcode, overlap, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", val_to_str(data->controlcode, overlap, "Unknown"));\r\nbreak;\r\ncase HISLIP_ASYNCLOCK:\r\nitem = proto_tree_add_item(tree, hf_hislip_controlcode_asynclock_code, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s", val_to_str(data->controlcode, asynclock_code, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", val_to_str(data->controlcode, asynclock_code, "Unknown"));\r\nif (data->controlcode != 1)\r\n{\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "]");\r\nbreak;\r\n}\r\nif (data->payloadlength == 0)\r\n{\r\nproto_item_append_text(item, "[Exclusive]");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Exclusive]");\r\nproto_item_append_text(data->hislip_item, " (Exclusive)");\r\n}\r\nelse\r\n{\r\nproto_item_append_text(item, "[Shared]");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Shared]");\r\nproto_item_append_text(data->hislip_item, " (Shared)");\r\n}\r\nbreak;\r\ncase HISLIP_FATALERROR:\r\nproto_tree_add_item(tree, hf_hislip_fatalerrcode, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", rval_to_str(data->controlcode, fatalerrortype, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", rval_to_str(data->controlcode, fatalerrortype, "Unknown"));\r\nbreak;\r\ncase HISLIP_ERROR:\r\nproto_tree_add_item(tree, hf_hislip_nonfatalerrorcode, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", rval_to_str(data->controlcode, nonfatalerrortype, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", rval_to_str(data->controlcode, nonfatalerrortype, "Unknown"));\r\nbreak;\r\ncase HISLIP_ASYNCLOCK_RESPONSE:\r\nif (oldcontrolvalue == 1)\r\n{\r\nproto_tree_add_item(tree, hf_hislip_controlcode_asynclockresponse_code_request, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", val_to_str(data->controlcode, asynclockresponse_code_request, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", val_to_str(data->controlcode, asynclockresponse_code_request, "Unknown"));\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(tree, hf_hislip_controlcode_asynclockresponse_code_release, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", val_to_str(data->controlcode, asynclockresponse_code_release, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", val_to_str(data->controlcode, asynclockresponse_code_release, "Unknown"));\r\n}\r\nbreak;\r\ncase HISLIP_ASYNCLOCKINFORESPONSE:\r\nproto_tree_add_item(tree, hf_hislip_controlcode_asynclockinforesponse_code, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", val_to_str(data->controlcode, asynclockinforesponse_code, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", val_to_str(data->controlcode, asynclockinforesponse_code, "Unknown"));\r\nbreak;\r\ncase HISLIP_ASYNCREMOTELOCALCONTROL:\r\nitem = proto_tree_add_item(tree, hf_hislip_controlcode_asyncremotelocalcontrol_code, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\nproto_item_append_text(item, " %s", val_to_str(data->controlcode, remotetype, "Unknown"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", val_to_str(data->controlcode, asyncremotelocalcontrol_code, "Unknown"));\r\nproto_item_append_text(data->hislip_item, ", %s", val_to_str(data->controlcode, asyncremotelocalcontrol_code, "Unknown"));\r\nbreak;\r\ncase HISLIP_ASYNCSTATUSRESPONSE:\r\ncase HISLIP_ASYNCSERVICEREQUEST:\r\nproto_tree_add_item(tree, hf_hislip_controlcode_stb, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " STB (0x%x)", data->controlcode);\r\nproto_item_append_text(data->hislip_item, ", STB (0x%x)", data->controlcode);\r\nbreak;\r\ncase HISLIP_ASYNCDEVICECLEARACKNOWLEDGE:\r\ncase HISLIP_DEVICECLEARCOMPLETE:\r\ncase HISLIP_DEVICECLEARACKNOWLEDGE:\r\nproto_tree_add_item(tree, hf_hislip_controlcode_feature_negotiation, tvb, data->offset, 1, ENC_BIG_ENDIAN );\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " [%s]", val_to_str(data->controlcode&0x01, feature_negotiation, "Unknown"));\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(tree, hf_hislip_controlcode, tvb, data->offset, 1, ENC_BIG_ENDIAN);\r\n}\r\ndata->offset++;\r\n}\r\nstatic void\r\ndecode_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, hislipinfo *data)\r\n{\r\nproto_item * item = NULL;\r\nif (data->payloadlength != 0)\r\n{\r\nguint64 datalength;\r\ngdouble max_message_size;\r\nswitch (data->messagetype)\r\n{\r\ncase HISLIP_DATA:\r\ncase HISLIP_DATAEND:\r\ncase HISLIP_INITIALIZE:\r\ndatalength = MAX_DATA_SHOW_SIZE;\r\nif (data->payloadlength <= datalength)\r\ndatalength = data->payloadlength;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %s", tvb_format_text(tvb, data->offset, (guint32)datalength));\r\nproto_tree_add_item(tree, hf_hislip_data, tvb, data->offset, -1, ENC_UTF_8 |ENC_NA);\r\nbreak;\r\ncase HISLIP_ASYNCMAXIMUMMESSAGESIZE:\r\ncase HISLIP_ASYNCMAXIMUMMESSAGESIZERESPONSE:\r\nmax_message_size = (gdouble)tvb_get_ntoh64(tvb, data->offset);\r\nmax_message_size = max_message_size/1048576.0;\r\nitem = proto_tree_add_item(tree, hf_hislip_maxmessagesize, tvb, data->offset, 8, ENC_BIG_ENDIAN);\r\nproto_item_append_text(item, " bytes (%.2f Mbytes)", max_message_size);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Max Message Size: %.2f Mbytes", max_message_size);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(tree, hf_hislip_data, tvb, data->offset, -1, ENC_UTF_8 | ENC_NA);\r\n}\r\n}\r\ndata->offset += (guint32)data->payloadlength;\r\n}\r\nstatic guint32\r\nsearch_for_retransmission(wmem_tree_t *pdus, hislipinfo *data, guint32 fnum )\r\n{\r\nhislip_transaction_t *hislip_trans;\r\nhislip_trans = (hislip_transaction_t *)wmem_tree_lookup32_le(pdus, fnum-1);\r\nif (hislip_trans)\r\n{\r\nif (hislip_trans->messagetype == data->messagetype && hislip_trans->rep_frame == 0)\r\nreturn hislip_trans->req_frame;\r\n}\r\nreturn 0;\r\n}\r\nstatic guint8\r\nis_connection_syn_or_asyn(guint8 messagetype)\r\n{\r\nif (messagetype >= HISLIP_ASYNCINTERRUPTED)\r\n{\r\nreturn HISLIP_ASYNCINITIALIZE;\r\n}\r\nelse\r\n{\r\nswitch (messagetype)\r\n{\r\ncase HISLIP_ASYNCLOCK:\r\ncase HISLIP_ASYNCLOCK_RESPONSE:\r\ncase HISLIP_ASYNCREMOTELOCALCONTROL:\r\ncase HISLIP_ASYNCREMOTELOCALRESPONSE:\r\nreturn HISLIP_ASYNCINITIALIZE;\r\ndefault:\r\nreturn HISLIP_INITIALIZE;\r\n}\r\n}\r\n}\r\nstatic gint\r\ndissect_hislip_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nconversation_t *conversation;\r\nhislip_conv_info_t *hislip_info;\r\nhislip_transaction_t *hislip_trans;\r\nproto_tree *hislip_tree;\r\nproto_item *it = NULL;\r\nhislipinfo hislip_data;\r\nguint8 oldcontrolvalue = 0;\r\nguint32 frame_number;\r\nhislip_tree = NULL;\r\nconversation = NULL;\r\nhislip_info = NULL;\r\nmemset(&hislip_data, 0, sizeof(hislip_data));\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PROTO_TAG_HiSLIP);\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nhislip_data.messagetype = tvb_get_guint8(tvb, hislip_data.offset+2);\r\nhislip_data.controlcode = tvb_get_guint8(tvb, hislip_data.offset+3);\r\nhislip_data.messageparameter = tvb_get_ntohl(tvb, hislip_data.offset+4);\r\nhislip_data.payloadlength = tvb_get_ntoh64(tvb, hislip_data.offset+8);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", rval_to_str(hislip_data.messagetype, messagetypestring, "Unknown"));\r\nif (tree)\r\n{\r\nhislip_data.hislip_item = proto_tree_add_item(tree, proto_hislip, tvb, 0, -1, ENC_NA);\r\nhislip_tree = proto_item_add_subtree(hislip_data.hislip_item, ett_hislip);\r\n}\r\nif (tvb_get_ntohs(tvb, 0) != 0x4853)\r\n{\r\nexpert_add_info(pinfo, hislip_data.hislip_item, &ei_wrong_prologue);\r\n}\r\nconversation = find_or_create_conversation(pinfo);\r\nhislip_info = (hislip_conv_info_t *)conversation_get_proto_data(conversation, proto_hislip);\r\nif (!hislip_info)\r\n{\r\nhislip_info = (hislip_conv_info_t *)wmem_alloc(wmem_file_scope(), (sizeof(hislip_conv_info_t)));\r\nhislip_info->connectiontype = is_connection_syn_or_asyn(hislip_data.messagetype);\r\nhislip_info->pdus = wmem_tree_new(wmem_file_scope());\r\nconversation_add_proto_data(conversation, proto_hislip, (void *)hislip_info);\r\n}\r\nif(hislip_info->connectiontype == HISLIP_INITIALIZE)\r\n{\r\nproto_item_append_text(hislip_data.hislip_item, " (Synchron)");\r\nit = proto_tree_add_item(hislip_tree, hf_hislip_syn, tvb, 0, 0, ENC_NA);\r\n}\r\nelse\r\n{\r\nproto_item_append_text(hislip_data.hislip_item," (Asynchron)");\r\nit = proto_tree_add_item(hislip_tree, hf_hislip_asyn, tvb, 0, 0, ENC_NA);\r\n}\r\nPROTO_ITEM_SET_GENERATED(it);\r\nswitch(hislip_data.messagetype)\r\n{\r\ncase HISLIP_ASYNCLOCK:\r\ncase HISLIP_ASYNCINITIALIZE:\r\ncase HISLIP_ASYNCMAXIMUMMESSAGESIZE:\r\ncase HISLIP_INITIALIZE:\r\ncase HISLIP_ASYNCSTATUSQUERY:\r\ncase HISLIP_ASYNCLOCKINFO:\r\nif(!PINFO_FD_VISITED(pinfo))\r\n{\r\nhislip_trans = (hislip_transaction_t *)wmem_alloc(wmem_file_scope(), sizeof(hislip_transaction_t));\r\nhislip_trans->req_frame = pinfo->num;\r\nhislip_trans->rep_frame = 0;\r\nhislip_trans->messagetype = hislip_data.messagetype;\r\nhislip_trans->controltype = hislip_data.controlcode;\r\nwmem_tree_insert32(hislip_info->pdus, pinfo->num , (void *)hislip_trans);\r\n}\r\nelse\r\n{\r\nhislip_trans = (hislip_transaction_t *)wmem_tree_lookup32(hislip_info->pdus, pinfo->num);\r\n}\r\nif(hislip_trans && hislip_trans->rep_frame != 0)\r\n{\r\nit = proto_tree_add_uint(hislip_tree, hf_hislip_response, tvb, 0, 0, hislip_trans->rep_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nif((frame_number = search_for_retransmission(hislip_info->pdus, &hislip_data , pinfo->num))!=0)\r\n{\r\nit = proto_tree_add_uint( hislip_tree, hf_hislip_retransmission, tvb, 0, 0, frame_number);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nbreak;\r\ncase HISLIP_ASYNCLOCK_RESPONSE:\r\ncase HISLIP_ASYNCINITIALIZERESPONSE:\r\ncase HISLIP_ASYNCMAXIMUMMESSAGESIZERESPONSE:\r\ncase HISLIP_INITIALIZERESPONSE:\r\ncase HISLIP_ASYNCSTATUSRESPONSE:\r\ncase HISLIP_ASYNCLOCKINFORESPONSE:\r\nhislip_trans = (hislip_transaction_t *) wmem_tree_lookup32_le( hislip_info->pdus, pinfo->num);\r\nif (hislip_trans)\r\n{\r\nhislip_trans->rep_frame = pinfo->num;\r\noldcontrolvalue = hislip_trans->controltype;\r\nit = proto_tree_add_uint( hislip_tree, hf_hislip_request,tvb, 0, 0, hislip_trans->req_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nbreak;\r\ndefault:\r\n;\r\n}\r\nhislip_data.offset += 2;\r\nproto_tree_add_item(hislip_tree, hf_hislip_messagetype, tvb, hislip_data.offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(hislip_data.hislip_item, ", %s", rval_to_str(hislip_data.messagetype, messagetypestring, "Unknown"));\r\nhislip_data.offset += 1;\r\ndecode_controlcode(tvb, pinfo, hislip_tree, &hislip_data, oldcontrolvalue );\r\ndecode_messagepara(tvb, pinfo, hislip_tree, &hislip_data);\r\nproto_tree_add_item(hislip_tree, hf_hislip_payloadlength, tvb, hislip_data.offset, 8, ENC_BIG_ENDIAN);\r\nhislip_data.offset += 8;\r\ndecode_data(tvb, pinfo, hislip_tree, &hislip_data );\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic guint\r\nget_hislip_message_len(packet_info *pinfo _U_, tvbuff_t *tvb,\r\nint offset, void *data _U_)\r\n{\r\nguint64 length;\r\nlength = tvb_get_ntoh64(tvb, offset+8);\r\nlength += FRAME_HEADER_LEN;\r\nreturn (guint32)length;\r\n}\r\nstatic gint\r\ndissect_hislip(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, FRAME_HEADER_LEN,\r\nget_hislip_message_len, dissect_hislip_message, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_hislip_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif (tvb_captured_length(tvb) < FRAME_HEADER_LEN)\r\nreturn FALSE;\r\nif (tvb_get_ntohs(tvb, 0) != 0x4853)\r\nreturn FALSE;\r\ndissect_hislip(tvb, pinfo, tree, data);\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_hislip(void)\r\n{\r\nexpert_module_t* expert_hislip;\r\nmodule_t * hislip_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_hislip_messagetype,\r\n{ "Message Type", "hislip.messagetype", FT_UINT8, BASE_HEX|BASE_RANGE_STRING, RVALS(messagetypestring), 0x0,\r\n"HiSLIP Message Type", HFILL }},\r\n{ &hf_hislip_controlcode,\r\n{ "Control Code", "hislip.controltype", FT_UINT8, BASE_DEC, NULL, 0x0,\r\n"HiSLIP Control Code", HFILL }},\r\n{ &hf_hislip_controlcode_rmt,\r\n{ "Control Code", "hislip.controltype.rmt", FT_UINT8, BASE_HEX, VALS(rmt), 0x0,\r\n"HiSLIP RMT", HFILL }},\r\n{ &hf_hislip_controlcode_overlap,\r\n{ "Control Code", "hislip.controltype.overlap", FT_UINT8, BASE_HEX, VALS(overlap), 0x0,\r\n"HiSLIP overlap", HFILL }},\r\n{ &hf_hislip_controlcode_asynclockinforesponse_code,\r\n{ "Control Code", "hislip.controltype.asynclockinforesponse", FT_UINT8, BASE_HEX, VALS(asynclockinforesponse_code), 0x0,\r\n"HiSLIP asynclockinforesponse", HFILL }},\r\n{ &hf_hislip_controlcode_asynclockresponse_code_release,\r\n{ "Control Code", "hislip.controltype.asynclockresponse", FT_UINT8, BASE_HEX, VALS(asynclockresponse_code_release), 0x0,\r\n"HiSLIP asynclockresponse code", HFILL }},\r\n{ &hf_hislip_controlcode_asynclockresponse_code_request,\r\n{ "Control Code", "hislip.controltype.asynclockresponse", FT_UINT8, BASE_HEX, VALS(asynclockresponse_code_request), 0x0,\r\n"HiSLIP asynclockresponse code", HFILL }},\r\n{ &hf_hislip_controlcode_asyncremotelocalcontrol_code,\r\n{ "Control Code", "hislip.controltype.asyncremotelocalcontrol", FT_UINT8, BASE_HEX, VALS(asyncremotelocalcontrol_code), 0x0,\r\n"HiSLIP asyncremotelocalcontrol", HFILL }},\r\n{ &hf_hislip_controlcode_feature_negotiation,\r\n{ "Control Code", "hislip.controltype.featurenegotiation", FT_UINT8, BASE_HEX, VALS(feature_negotiation), 0x0,\r\n"HiSLIP feature", HFILL }},\r\n{ &hf_hislip_controlcode_asynclock_code,\r\n{ "Control Code", "hislip.controltype.asynclockcode", FT_UINT8, BASE_HEX, VALS(asynclock_code), 0x0,\r\n"HiSLIP asynclock code", HFILL }},\r\n{ &hf_hislip_controlcode_stb,\r\n{ "STB", "hislip.controltype.stb", FT_UINT8, BASE_HEX, NULL, 0x0,\r\n"HiSLIP Status Byte", HFILL }},\r\n{ &hf_hislip_payloadlength,\r\n{ "Payload Length", "hislip.payloadlength", FT_UINT64, BASE_DEC, NULL, 0x0,\r\n"HiSLIP Payload Length", HFILL }},\r\n{ &hf_hislip_messageparameter,\r\n{ "Message Parameter", "hislip.msgpara", FT_NONE, BASE_NONE, NULL, 0x0,\r\n"HiSLIP Message Parameter", HFILL }},\r\n{ &hf_hislip_msgpara_messageid,\r\n{ "MessageID", "hislip.msgpara.messageid", FT_UINT32, BASE_HEX, NULL, 0x0,\r\n"HiSLIP MessageID", HFILL }},\r\n{ &hf_hislip_msgpara_sessionid,\r\n{ "SessionID", "hislip.msgpara.sessionid", FT_UINT16, BASE_HEX, NULL, 0x0,\r\n"HiSLIP SessionID", HFILL }},\r\n{ &hf_hislip_msgpara_serverproto,\r\n{ "Server version", "hislip.msgpara.servproto", FT_UINT16, BASE_HEX, NULL, 0x0,\r\n"HiSLIP Server Protocol version", HFILL }},\r\n{ &hf_hislip_msgpara_vendorID,\r\n{ "VendorID", "hislip.msgpara.vendorID", FT_UINT16, BASE_HEX|BASE_EXT_STRING, &vendorID_ext, 0x0,\r\n"HiSLIP VendorID", HFILL }},\r\n{ &hf_hislip_msgpara_clientproto,\r\n{ "Client version", "hislip.msgpara.clientproto", FT_UINT16, BASE_HEX, NULL, 0x0,\r\n"HiSLIP Client protocol version", HFILL }},\r\n{ &hf_hislip_msgpara_clients,\r\n{ "HiSLIP clients holding locks", "hislip.msgpara.clients", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"HiSLIP clients holding locks on the server", HFILL }},\r\n{ &hf_hislip_msgpara_timeout,\r\n{ "Timeout[ms]", "hislip.msgpara.timeout", FT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Time out from a AsyncLock message", HFILL }},\r\n{ &hf_hislip_data,\r\n{ "Data", "hislip.data", FT_STRING, BASE_NONE, NULL, 0x0,\r\n"HiSLIP Payload", HFILL }},\r\n{ &hf_hislip_request,\r\n{ "Request", "hislip.response", FT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"This is a response to the HiSLIP request in this frame", HFILL }},\r\n{ &hf_hislip_response,\r\n{ "Response", "hislip.request", FT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"A Request in this frame", HFILL }},\r\n{ &hf_hislip_syn,\r\n{ "Synchronous Channel", "hislip.syn", FT_NONE, BASE_NONE, NULL, 0x0,\r\n"This is the HiSLIP Synchronous Channel", HFILL }},\r\n{ &hf_hislip_asyn,\r\n{ "Asynchronous Channel", "hislip.asyn", FT_NONE, BASE_NONE, NULL, 0x0,\r\n"This is the HiSLIP ASynchronous Channel", HFILL }},\r\n{ &hf_hislip_fatalerrcode,\r\n{ "Fatalerror Code", "hislip.fatalerrcode", FT_UINT8, BASE_HEX|BASE_RANGE_STRING, RVALS(fatalerrortype), 0x0,\r\n"HiSLIP Fatalerror Code", HFILL }},\r\n{ &hf_hislip_retransmission,\r\n{ "Retransmission from", "hislip.retrans", FT_FRAMENUM, BASE_NONE, NULL, 0x0,\r\n"HiSLIP Retransmission", HFILL }},\r\n{ &hf_hislip_nonfatalerrorcode,\r\n{ "Nonfatalerror Code", "hislip.nonfatalerrorcode", FT_UINT8, BASE_HEX|BASE_RANGE_STRING, RVALS(nonfatalerrortype), 0x0,\r\n"HiSLIP Nonfatalerror Code", HFILL }},\r\n{ &hf_hislip_maxmessagesize,\r\n{ "Max Message Size", "hislip.maxmsgsize", FT_UINT64, BASE_DEC, NULL, 0x0,\r\n"HiSLIP Maximum Message Size", HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_hislip,\r\n&ett_hislip_msgpara\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_wrong_prologue, { "hislip.wrongprologue", PI_UNDECODED, PI_WARN, "Frame hasn't 'HS' as Prologue", EXPFILL }},\r\n{ &ei_msg_not_null, { "hislip.msgnotnull", PI_PROTOCOL, PI_WARN, "Message Parameter isn't 0", EXPFILL }}\r\n};\r\nproto_hislip = proto_register_protocol("High-Speed LAN Instrument Protocol", "HiSLIP", "hislip");\r\nexpert_hislip = expert_register_protocol(proto_hislip);\r\nexpert_register_field_array(expert_hislip, ei, array_length(ei));\r\nproto_register_field_array(proto_hislip, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nhislip_module = prefs_register_protocol(proto_hislip, proto_reg_handoff_hislip);\r\nprefs_register_uint_preference(hislip_module,\r\n"tcp.port",\r\n"TCP port for HiSLIP",\r\n"Set the TCP port for HiSLIP traffic if other than the default",\r\n10,\r\n&global_hislip_port);\r\nprefs_register_obsolete_preference(hislip_module, "enable_heuristic");\r\n}\r\nvoid\r\nproto_reg_handoff_hislip(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic int currentPort;\r\nif (!initialized)\r\n{\r\nhislip_handle = create_dissector_handle(dissect_hislip, proto_hislip);\r\nheur_dissector_add("tcp", dissect_hislip_heur, "HiSLIP over TCP", "hislip_tcp", proto_hislip, HEURISTIC_DISABLE);\r\ninitialized = TRUE;\r\n}\r\nelse\r\n{\r\ndissector_delete_uint("tcp.port", currentPort, hislip_handle);\r\n}\r\ncurrentPort = global_hislip_port;\r\ndissector_add_uint("tcp.port", currentPort, hislip_handle);\r\n}

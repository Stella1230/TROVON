static int\r\ndissect_oipf_ciplus(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\ngint msg_len;\r\nproto_tree *oipf_ciplus_tree;\r\nguint offset = 0;\r\nguint8 i, send_datatype_nbr;\r\nguint16 dat_len;\r\nmsg_len = tvb_reported_length(tvb);\r\nif (msg_len < 8)\r\nreturn 0;\r\noipf_ciplus_tree = proto_tree_add_subtree(tree, tvb, 0, msg_len, ett_oipf_ciplus, NULL, "Open IPTV Forum CSPG-CI+");\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_cmd_id,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_ca_sys_id,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_trx_id,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nsend_datatype_nbr = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_send_datatype_nbr,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nfor (i=0; i<send_datatype_nbr; i++) {\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_dat_id,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ndat_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_dat_len,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(oipf_ciplus_tree, hf_oipf_ciplus_data,\r\ntvb, offset, dat_len, ENC_NA);\r\noffset += dat_len;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_oipf(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_oipf_ciplus\r\n};\r\nstatic hf_register_info hf[] = {\r\n{ &hf_oipf_ciplus_cmd_id,\r\n{ "Command ID", "oipf.ciplus.cmd_id", FT_UINT8, BASE_HEX,\r\nVALS(oipf_ciplus_cmd_id), 0, NULL, HFILL } },\r\n{ &hf_oipf_ciplus_ca_sys_id,\r\n{ "CA system ID", "oipf.ciplus.ca_system_id", FT_UINT16, BASE_HEX,\r\nNULL, 0, NULL, HFILL } },\r\n{ &hf_oipf_ciplus_trx_id,\r\n{ "Transaction ID", "oipf.ciplus.transaction_id",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_oipf_ciplus_send_datatype_nbr,\r\n{ "Number of data items", "oipf.ciplus.num_items", FT_UINT8,\r\nBASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_oipf_ciplus_dat_id,\r\n{ "Datatype ID", "oipf.ciplus.datatype_id", FT_UINT8, BASE_HEX,\r\nVALS(oipf_ciplus_dat_id), 0, NULL, HFILL } },\r\n{ &hf_oipf_ciplus_dat_len,\r\n{ "Datatype length", "oipf.ciplus.datatype_len", FT_UINT16,\r\nBASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_oipf_ciplus_data,\r\n{ "Data", "oipf.ciplus.data", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL } }\r\n};\r\nproto_oipf_ciplus = proto_register_protocol(\r\n"Open IPTV Forum CSPG-CI+", "OIPF CI+", "oipf.ciplus");\r\nproto_register_field_array(proto_oipf_ciplus, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_oipf(void)\r\n{\r\ndissector_handle_t oipf_ciplus_handle;\r\noipf_ciplus_handle =\r\ncreate_dissector_handle(dissect_oipf_ciplus, proto_oipf_ciplus);\r\ndissector_add_string("dvb-ci.sas.app_id_str",\r\nsas_app_id_str_oipf, oipf_ciplus_handle);\r\n}

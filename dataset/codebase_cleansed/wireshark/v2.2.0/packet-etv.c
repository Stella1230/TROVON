static void\r\ndissect_etv_common(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, int proto,\r\nint hf_filter_info, int hf_reserved,\r\nexpert_field* ei_section_syntax_indicator, expert_field* ei_reserved,\r\nexpert_field* ei_section_length, expert_field* ei_filter_info)\r\n{\r\ntvbuff_t *sub_tvb;\r\nguint offset = 0;\r\nproto_item *ti;\r\nproto_item *pi;\r\nproto_tree *etv_tree;\r\nproto_item *items[PACKET_MPEG_SECT_PI__SIZE];\r\ngboolean ssi;\r\nguint reserved;\r\nguint8 reserved2;\r\nguint16 filter_info;\r\nguint sect_len;\r\nti = proto_tree_add_item(tree, proto, tvb, offset, -1, ENC_NA);\r\netv_tree = proto_item_add_subtree(ti, ett_etv);\r\noffset += packet_mpeg_sect_header_extra(tvb, offset, etv_tree, &sect_len,\r\n&reserved, &ssi, items);\r\nif (FALSE != ssi) {\r\nproto_item *msg_error;\r\nmsg_error = items[PACKET_MPEG_SECT_PI__SSI];\r\nPROTO_ITEM_SET_GENERATED(msg_error);\r\nexpert_add_info(pinfo, msg_error, ei_section_syntax_indicator);\r\n}\r\nif (4 != reserved) {\r\nproto_item *msg_error;\r\nmsg_error = items[PACKET_MPEG_SECT_PI__RESERVED];\r\nPROTO_ITEM_SET_GENERATED(msg_error);\r\nexpert_add_info(pinfo, msg_error, ei_reserved);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Length: %u", sect_len);\r\nproto_item_append_text(ti, " Length=%u", sect_len);\r\nif (1021 < sect_len) {\r\nproto_item *msg_error;\r\nmsg_error = items[PACKET_MPEG_SECT_PI__LENGTH];\r\nPROTO_ITEM_SET_GENERATED(msg_error);\r\nexpert_add_info(pinfo, msg_error, ei_section_length);\r\n}\r\nfilter_info = tvb_get_ntohs(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Filter: 0x%x", filter_info);\r\nproto_item_append_text(ti, " Filter=0x%x", filter_info);\r\npi = proto_tree_add_item(etv_tree, hf_filter_info, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif ((proto_etv_dii == proto) && (0xFBFB != filter_info)) {\r\nexpert_add_info_format(pinfo, pi, ei_filter_info,\r\n"Invalid filter_info value (must be 0xFBFB)");\r\n} else if ((proto_etv_ddb == proto) &&\r\n((filter_info < 1) || (0xfbef < filter_info)))\r\n{\r\nexpert_add_info_format(pinfo, pi, ei_filter_info,\r\n"Invalid filter_info value (must be [0x0001-0xFBEF] inclusive)");\r\n}\r\noffset += 2;\r\nreserved2 = tvb_get_guint8(tvb, offset);\r\npi = proto_tree_add_item(etv_tree, hf_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (0 != reserved2) {\r\nexpert_add_info_format(pinfo, pi, ei_reserved,\r\n"Invalid reserved2 bits (should all be 0)");\r\n}\r\noffset += 1;\r\nsub_tvb = tvb_new_subset_length(tvb, offset, sect_len-7);\r\ncall_dissector(dsmcc_handle, sub_tvb, pinfo, tree);\r\nsect_len += 3 - 4;\r\npacket_mpeg_sect_crc(tvb, pinfo, etv_tree, 0, sect_len);\r\n}\r\nstatic int\r\ndissect_etv_ddb(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ETV-DDB");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "ETV DDB");\r\ndissect_etv_common(tvb, pinfo, tree, proto_etv_ddb, hf_etv_ddb_filter_info,\r\nhf_etv_ddb_reserved, &ei_etv_ddb_invalid_section_syntax_indicator,\r\n&ei_etv_ddb_invalid_reserved_bits, &ei_etv_ddb_invalid_section_length,\r\n&ei_etv_ddb_filter_info);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_etv_dii(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ETV-DII");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "ETV DII");\r\ndissect_etv_common(tvb, pinfo, tree, proto_etv_dii, hf_etv_dii_filter_info,\r\nhf_etv_dii_reserved, &ei_etv_dii_invalid_section_syntax_indicator,\r\n&ei_etv_dii_invalid_reserved_bits, &ei_etv_dii_invalid_section_length,\r\n&ei_etv_dii_filter_info);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_etv(void)\r\n{\r\nstatic hf_register_info hf_ddb[] = {\r\n{ &hf_etv_ddb_filter_info, {\r\n"Filter Info", "etv-ddb.filter_info",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_etv_ddb_reserved, {\r\n"Reserved", "etv-ddb.reserved",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} }\r\n};\r\nstatic hf_register_info hf_dii[] = {\r\n{ &hf_etv_dii_filter_info, {\r\n"Filter Info", "etv-dii.filter_info",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_etv_dii_reserved, {\r\n"Reserved", "etv-dii.reserved",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} }\r\n};\r\nstatic gint *ett[] = {\r\n&ett_etv,\r\n&ett_etv_payload\r\n};\r\nstatic ei_register_info ei_ddb[] = {\r\n{ &ei_etv_ddb_invalid_section_syntax_indicator, { "etv-ddb.invalid_section_syntax_indicator", PI_MALFORMED, PI_ERROR, "Invalid section_syntax_indicator (should be 0)", EXPFILL }},\r\n{ &ei_etv_ddb_invalid_reserved_bits, { "etv-ddb.invalid_reserved_bits", PI_MALFORMED, PI_ERROR, "Invalid reserved bits", EXPFILL }},\r\n{ &ei_etv_ddb_invalid_section_length, { "etv-ddb.invalid_section_length", PI_MALFORMED, PI_ERROR, "Invalid section_length (must not exceed 1021)", EXPFILL }},\r\n{ &ei_etv_ddb_filter_info, { "etv-ddb.filter_info.invalid", PI_MALFORMED, PI_ERROR, "Invalid filter info", EXPFILL }},\r\n};\r\nstatic ei_register_info ei_dii[] = {\r\n{ &ei_etv_dii_invalid_section_syntax_indicator, { "etv-dii.invalid_section_syntax_indicator", PI_MALFORMED, PI_ERROR, "Invalid section_syntax_indicator (should be 0)", EXPFILL }},\r\n{ &ei_etv_dii_invalid_reserved_bits, { "etv-dii.invalid_reserved_bits", PI_MALFORMED, PI_ERROR, "Invalid reserved bits", EXPFILL }},\r\n{ &ei_etv_dii_invalid_section_length, { "etv-dii.invalid_section_length", PI_MALFORMED, PI_ERROR, "Invalid section_length (must not exceed 1021)", EXPFILL }},\r\n{ &ei_etv_dii_filter_info, { "etv-dii.filter_info.invalid", PI_MALFORMED, PI_ERROR, "Invalid filter info", EXPFILL }},\r\n};\r\nexpert_module_t* expert_etv_dii;\r\nexpert_module_t* expert_etv_ddb;\r\nproto_etv_dii = proto_register_protocol("ETV-AM DII Section", "ETV-AM DII", "etv-dii");\r\nproto_etv_ddb = proto_register_protocol("ETV-AM DDB Section", "ETV-AM DDB", "etv-ddb");\r\nproto_register_field_array(proto_etv_dii, hf_dii, array_length(hf_dii));\r\nproto_register_field_array(proto_etv_ddb, hf_ddb, array_length(hf_ddb));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_etv_dii = expert_register_protocol(proto_etv_dii);\r\nexpert_register_field_array(expert_etv_dii, ei_dii, array_length(ei_dii));\r\nexpert_etv_ddb = expert_register_protocol(proto_etv_ddb);\r\nexpert_register_field_array(expert_etv_ddb, ei_ddb, array_length(ei_ddb));\r\n}\r\nvoid\r\nproto_reg_handoff_etv(void)\r\n{\r\ndissector_handle_t etv_dii_handle;\r\ndissector_handle_t etv_ddb_handle;\r\netv_dii_handle = create_dissector_handle(dissect_etv_dii, proto_etv_dii);\r\netv_ddb_handle = create_dissector_handle(dissect_etv_ddb, proto_etv_ddb);\r\ndissector_add_uint("mpeg_sect.tid", ETV_TID_DII_SECTION, etv_dii_handle);\r\ndissector_add_uint("mpeg_sect.tid", ETV_TID_DDB_SECTION, etv_ddb_handle);\r\ndsmcc_handle = find_dissector_add_dependency("mp2t-dsmcc", proto_etv_dii);\r\nfind_dissector_add_dependency("mp2t-dsmcc", proto_etv_ddb);\r\n}

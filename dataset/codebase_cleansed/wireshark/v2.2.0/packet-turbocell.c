static int\r\ndissect_turbocell(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti, *name_item;\r\nproto_tree *turbocell_tree = NULL, *network_tree;\r\ntvbuff_t *next_tvb;\r\nint i=0;\r\nguint8 packet_type;\r\nguint8 * str_name;\r\nguint str_len;\r\ngint remaining_length;\r\npacket_type = tvb_get_guint8(tvb, 0);\r\nif (!(packet_type & 0x0F)){\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Turbocell Packet (Beacon)");\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Turbocell");\r\n} else if ( packet_type == TURBOCELL_TYPE_MANAGEMENT ) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Turbocell Packet (Management)");\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Turbocell");\r\n} else if ( packet_type == TURBOCELL_TYPE_DATA ) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Turbocell Packet (Data)");\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Turbocell");\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Turbocell Packet (Unknown)");\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Turbocell");\r\n}\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_turbocell, tvb, 0, 20, ENC_NA);\r\nturbocell_tree = proto_item_add_subtree(ti, ett_turbocell);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_type, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_satmode, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_nwid, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nif (tvb_get_bits64(tvb, 64,48,ENC_BIG_ENDIAN) != G_GINT64_CONSTANT(0x000001fe23dc45ba)){\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_counter, tvb, 0x02, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_dst, tvb, 0x04, 6, ENC_NA);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_timestamp, tvb, 0x0A, 3, ENC_BIG_ENDIAN);\r\n} else {\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_timestamp, tvb, 0x02, 3, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_counter, tvb, 0x05, 3, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_dst, tvb, 0x08, 6, ENC_NA);\r\n}\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_unknown, tvb, 0x0E, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(turbocell_tree, hf_turbocell_ip, tvb, 0x10, 4, ENC_BIG_ENDIAN);\r\n}\r\nremaining_length=tvb_reported_length_remaining(tvb, 0x14);\r\nif (remaining_length > 6) {\r\nif (tvb_get_guint8(tvb, 0x14)>=0x20){\r\nname_item = proto_tree_add_item(turbocell_tree, hf_turbocell_name, tvb, 0x14, 30, ENC_ASCII|ENC_NA);\r\nnetwork_tree = proto_item_add_subtree(name_item, ett_network);\r\nstr_name=tvb_get_stringz_enc(wmem_packet_scope(), tvb, 0x14, &str_len, ENC_ASCII);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Network=\"%s\"",format_text(str_name, str_len-1));\r\nwhile(tvb_get_guint8(tvb, 0x34 + 8*i)==0x00 && (tvb_reported_length_remaining(tvb,0x34 + 8*i) > 6) && (i<32)) {\r\nproto_tree_add_item(network_tree, hf_turbocell_station, tvb, 0x34+8*i, 6, ENC_NA);\r\ni++;\r\n}\r\nnext_tvb = tvb_new_subset_remaining(tvb, 0x34 + 8*i);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n} else {\r\ntvbuff_t *msdu_tvb = NULL;\r\nguint32 msdu_offset = 0x04;\r\nguint16 j = 1;\r\nguint16 msdu_length;\r\nproto_item *parent_item;\r\nproto_tree *mpdu_tree;\r\nproto_tree *subframe_tree;\r\nnext_tvb = tvb_new_subset(tvb, 0x14, -1, tvb_get_ntohs(tvb, 0x14));\r\nparent_item = proto_tree_add_protocol_format(tree, proto_aggregate, next_tvb, 0,\r\ntvb_reported_length_remaining(next_tvb, 0), "Turbocell Aggregate Frames");\r\nmpdu_tree = proto_item_add_subtree(parent_item, ett_msdu_aggregation_parent_tree);\r\nproto_tree_add_item(mpdu_tree, hf_turbocell_aggregate_len, next_tvb, 0x00, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mpdu_tree, hf_turbocell_aggregate_unknown1, next_tvb, 0x02, 2, ENC_BIG_ENDIAN);\r\nremaining_length=tvb_reported_length_remaining(next_tvb, msdu_offset);\r\ndo {\r\nmsdu_length = (tvb_get_letohs(next_tvb, msdu_offset) & 0x0FFF);\r\nif (msdu_length==0) break;\r\nparent_item = proto_tree_add_uint_format(mpdu_tree, hf_turbocell_aggregate_msdu_header_text,\r\nnext_tvb,msdu_offset, msdu_length + 0x02,j, "A-MSDU Subframe #%u", j);\r\nsubframe_tree = proto_item_add_subtree(parent_item, ett_msdu_aggregation_subframe_tree);\r\nj++;\r\nproto_tree_add_item(subframe_tree, hf_turbocell_aggregate_msdu_len, next_tvb, msdu_offset, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subframe_tree, hf_turbocell_aggregate_unknown2, next_tvb, msdu_offset+1, 1, ENC_BIG_ENDIAN);\r\nmsdu_offset += 0x02;\r\nremaining_length -= 0x02;\r\nmsdu_tvb = tvb_new_subset(next_tvb, msdu_offset, (msdu_length>remaining_length)?remaining_length:msdu_length, msdu_length);\r\ncall_dissector(eth_handle, msdu_tvb, pinfo, subframe_tree);\r\nmsdu_offset += msdu_length;\r\nremaining_length -= msdu_length;\r\n} while (remaining_length > 6);\r\nif (remaining_length > 2) {\r\nnext_tvb = tvb_new_subset_remaining(next_tvb, msdu_offset);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_turbocell(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_turbocell_type,\r\n{ "Packet Type", "turbocell.type",\r\nFT_UINT8, BASE_HEX, VALS(turbocell_type_values), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_turbocell_satmode,\r\n{ "Satellite Mode", "turbocell.satmode",\r\nFT_UINT8, BASE_HEX, VALS(turbocell_satmode_values), 0xF0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_turbocell_nwid,\r\n{ "Network ID", "turbocell.nwid",\r\nFT_UINT8, BASE_DEC, NULL, 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_turbocell_counter,\r\n{ "Counter", "turbocell.counter",\r\nFT_UINT24, BASE_DEC_HEX, NULL, 0,\r\n"Increments every frame (per station)", HFILL }\r\n},\r\n{ &hf_turbocell_dst,\r\n{ "Destination", "turbocell.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0,\r\n"Seems to be the destination", HFILL }\r\n},\r\n{ &hf_turbocell_ip,\r\n{ "IP", "turbocell.ip",\r\nFT_IPv4, BASE_NONE, NULL, 0,\r\n"IP address of base station ?", HFILL }\r\n},\r\n{ &hf_turbocell_unknown,\r\n{ "Unknown", "turbocell.unknown",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\n"Always 0000", HFILL }\r\n},\r\n{ &hf_turbocell_timestamp,\r\n{ "Timestamp (in 10 ms)", "turbocell.timestamp",\r\nFT_UINT24, BASE_DEC_HEX, NULL, 0,\r\n"Timestamp per station (since connection?)", HFILL }\r\n},\r\n{ &hf_turbocell_name,\r\n{ "Network Name", "turbocell.name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_turbocell_station,\r\n{ "Station", "turbocell.station",\r\nFT_ETHER, BASE_NONE, NULL, 0,\r\n"connected stations / satellites ?", HFILL },\r\n}\r\n};\r\nstatic hf_register_info aggregate_fields[] = {\r\n{ &hf_turbocell_aggregate_msdu_header_text,\r\n{"MAC Service Data Unit (MSDU)", "turbocell_aggregate.msduheader",\r\nFT_UINT16, BASE_DEC, 0, 0x0000, NULL, HFILL }\r\n},\r\n{ &hf_turbocell_aggregate_msdu_len,\r\n{"MSDU length", "turbocell_aggregate.msdulen",\r\nFT_UINT16, BASE_DEC_HEX, 0, 0x0FFF, NULL, HFILL }\r\n},\r\n{ &hf_turbocell_aggregate_len,\r\n{ "Total Length", "turbocell_aggregate.len",\r\nFT_UINT16, BASE_DEC_HEX, NULL, 0,\r\n"Total reported length", HFILL }\r\n},\r\n{ &hf_turbocell_aggregate_unknown1,\r\n{ "Unknown", "turbocell_aggregate.unknown1",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\n"Always 0x7856", HFILL }\r\n},\r\n{ &hf_turbocell_aggregate_unknown2,\r\n{ "Unknown", "turbocell_aggregate.unknown2",\r\nFT_UINT8, BASE_HEX, NULL, 0xF0,\r\n"have the values 0x4,0xC or 0x8", HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_turbocell,\r\n&ett_network,\r\n&ett_msdu_aggregation_parent_tree,\r\n&ett_msdu_aggregation_subframe_tree\r\n};\r\nproto_turbocell = proto_register_protocol("Turbocell Header", "Turbocell", "turbocell");\r\nproto_aggregate = proto_register_protocol("Turbocell Aggregate Data",\r\n"Turbocell Aggregate Data", "turbocell_aggregate");\r\nproto_register_field_array(proto_aggregate, aggregate_fields, array_length(aggregate_fields));\r\nregister_dissector("turbocell", dissect_turbocell, proto_turbocell);\r\nproto_register_field_array(proto_turbocell, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_turbocell(void)\r\n{\r\neth_handle = find_dissector_add_dependency("eth_withoutfcs", proto_turbocell);\r\n}

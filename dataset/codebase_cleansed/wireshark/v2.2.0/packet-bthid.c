static gint\r\ndissect_hid_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\ngint offset, guint report_type)\r\n{\r\nunsigned int protocol_code;\r\nproto_tree_add_item(tree, hf_bthid_protocol_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nprotocol_code = tvb_get_guint8(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - %s", val_to_str_const(protocol_code, protocol_code_vals, "unknown type"));\r\noffset += 1;\r\nswitch (protocol_code) {\r\ncase 0x01:\r\nif (report_type == 0x02) {\r\noffset += call_dissector_with_data(usb_hid_boot_keyboard_output_report_handle, tvb_new_subset_remaining(tvb, offset), pinfo, tree, NULL);\r\nbreak;\r\n} else if (report_type != 0x01) {\r\nbreak;\r\n}\r\noffset += call_dissector_with_data(usb_hid_boot_keyboard_input_report_handle, tvb_new_subset_remaining(tvb, offset), pinfo, tree, NULL);\r\nbreak;\r\ncase 0x02:\r\noffset += call_dissector_with_data(usb_hid_boot_mouse_input_report_handle, tvb_new_subset_remaining(tvb, offset), pinfo, tree, NULL);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_bthid(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *bthid_tree;\r\ngint offset = 0;\r\nguint transaction_type;\r\nguint parameter;\r\nguint protocol;\r\nguint idle_rate;\r\nguint8 control_operation;\r\nproto_item *pitem;\r\nti = proto_tree_add_item(tree, proto_bthid, tvb, offset, -1, ENC_NA);\r\nbthid_tree = proto_item_add_subtree(ti, ett_bthid);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "HID");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nswitch (pinfo->p2p_dir) {\r\ncase P2P_DIR_SENT:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Sent ");\r\nbreak;\r\ncase P2P_DIR_RECV:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "UnknownDirection ");\r\nbreak;\r\n}\r\npitem = proto_tree_add_item(bthid_tree, hf_bthid_transaction_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ntransaction_type = tvb_get_guint8(tvb, offset);\r\nparameter = transaction_type & 0x0F;\r\ntransaction_type = transaction_type >> 4;\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str_const(transaction_type, transaction_type_vals, "Unknown TransactionType"));\r\nswitch(transaction_type) {\r\ncase 0x00:\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_result_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Result Code: %s", val_to_str_const(parameter, result_code_vals, "reserved"));\r\nbreak;\r\ncase 0x01:\r\npitem = proto_tree_add_item(bthid_tree, hf_bthid_parameter_control_operation, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncontrol_operation = tvb_get_guint8(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Control Operation: %s", val_to_str_const(parameter, control_operation_vals, "reserved"));\r\nif (control_operation < 3 && show_deprecated)\r\nexpert_add_info(pinfo, pitem, &ei_bthid_parameter_control_operation_deprecated);\r\noffset += 1;\r\nbreak;\r\ncase 0x04:\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_size, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_reserved_2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_report_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Size: %s, Report Type: %s",\r\nval_to_str_const(parameter >> 3 , size_vals, "reserved"),\r\nval_to_str_const(parameter & 0x03, report_type_vals, "reserved"));\r\nif (((parameter >> 3) && tvb_reported_length_remaining(tvb, offset) >= 3) ||\r\n(!(parameter >> 3) && tvb_reported_length_remaining(tvb, offset) >= 1)) {\r\nproto_tree_add_item(bthid_tree, hf_bthid_report_id, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\n}\r\nif (parameter >> 3) {\r\nproto_tree_add_item(bthid_tree, hf_bthid_buffer_size, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\n}\r\nbreak;\r\ncase 0x05:\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_reserved_32, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_report_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Report Type: %s",\r\nval_to_str_const(parameter & 0x03, report_type_vals, "reserved"));\r\nproto_tree_add_item(bthid_tree, hf_bthid_data, tvb, offset, -1, ENC_NA);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\nbreak;\r\ncase 0x06:\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(bthid_tree, hf_bthid_protocol, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nprotocol = tvb_get_guint8(tvb, offset) & 0x01;\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Protocol: %s",\r\nval_to_str_const(protocol, protocol_vals, "reserved"));\r\nbreak;\r\ncase 0x07:\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_reserved_31, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bthid_tree, hf_bthid_protocol, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Protocol: %s",\r\nval_to_str_const(parameter & 0x01, protocol_vals, "reserved"));\r\nbreak;\r\ncase 0x08:\r\ncase 0x09:\r\nif (show_deprecated)\r\nexpert_add_info(pinfo, pitem, &ei_bthid_transaction_type_deprecated);\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\npitem = proto_tree_add_item(bthid_tree, hf_bthid_idle_rate, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nidle_rate = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(pitem, " (%u.%03u ms)", idle_rate * 4 / 1000, idle_rate * 4 % 1000);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Idle Rate: %u.%03u ms", idle_rate*4/1000, idle_rate*4%1000);\r\noffset += 1;\r\nbreak;\r\ncase 0x0B:\r\nif (show_deprecated)\r\nexpert_add_info(pinfo, pitem, &ei_bthid_transaction_type_deprecated);\r\ncase 0x0A:\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_reserved_32, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(bthid_tree, hf_bthid_parameter_report_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - %s", val_to_str_const(parameter, report_type_vals, "reserved"));\r\noffset = dissect_hid_data(tvb, pinfo, bthid_tree, offset, parameter & 0x03);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_bthid(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t* expert_bthid;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_bthid_transaction_type,\r\n{ "Transaction Type", "bthid.transaction_type",\r\nFT_UINT8, BASE_HEX, VALS(transaction_type_vals), 0xF0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_reserved,\r\n{ "Parameter reserved", "bthid.parameter.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_reserved_32,\r\n{ "Parameter reserved", "bthid.parameter.reserved_32",\r\nFT_UINT8, BASE_HEX, NULL, 0x0C,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_reserved_31,\r\n{ "Parameter reserved", "bthid.parameter.reserved_31",\r\nFT_UINT8, BASE_HEX, NULL, 0x0E,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_reserved_2,\r\n{ "Parameter reserved", "bthid.parameter.reserved_2",\r\nFT_UINT8, BASE_HEX, NULL, 0x04,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_report_type,\r\n{ "Report Type", "bthid.parameter.report_type",\r\nFT_UINT8, BASE_HEX, VALS(report_type_vals), 0x03,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_size,\r\n{ "Size", "bthid.parameter.size",\r\nFT_UINT8, BASE_HEX, VALS(size_vals), 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_result_code,\r\n{ "Result Code", "bthid.result_code",\r\nFT_UINT8, BASE_HEX, VALS(result_code_vals), 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_parameter_control_operation,\r\n{ "Control Operation", "bthid.control_operation",\r\nFT_UINT8, BASE_HEX, VALS(control_operation_vals), 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_protocol,\r\n{ "Protocol", "bthid.protocol",\r\nFT_UINT8, BASE_HEX, VALS(protocol_vals), 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_idle_rate,\r\n{ "Idle Rate", "bthid.idle_rate",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_report_id,\r\n{ "Report Id", "bthid.report_id",\r\nFT_UINT8, BASE_HEX, VALS(protocol_code_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_buffer_size,\r\n{ "Buffer Size", "bthid.buffer_size",\r\nFT_UINT16, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_protocol_code,\r\n{ "Protocol Code", "bthid.data.protocol_code",\r\nFT_UINT8, BASE_HEX, VALS(protocol_code_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthid_data,\r\n{ "Data", "bthid.data",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_bthid\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_bthid_parameter_control_operation_deprecated, { "bthid.control_operation.deprecated", PI_PROTOCOL, PI_WARN, "This value of Control Operation is deprecated by HID 1.1", EXPFILL }},\r\n{ &ei_bthid_transaction_type_deprecated, { "bthid.transaction_type.deprecated", PI_PROTOCOL, PI_WARN, "This Transaction Type is deprecated by HID 1.1", EXPFILL }},\r\n};\r\nproto_bthid = proto_register_protocol("Bluetooth HID Profile", "BT HID", "bthid");\r\nbthid_handle = register_dissector("bthid", dissect_bthid, proto_bthid);\r\nproto_register_field_array(proto_bthid, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_bthid = expert_register_protocol(proto_bthid);\r\nexpert_register_field_array(expert_bthid, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_bthid, NULL);\r\nprefs_register_static_text_preference(module, "hid.version",\r\n"Bluetooth Profile HID version: 1.1",\r\n"Version of profile supported by this dissector.");\r\nprefs_register_bool_preference(module, "hid.deprecated",\r\n"Show what is deprecated in HID 1.1",\r\n"Show what is deprecated in HID 1.1", &show_deprecated);\r\n}\r\nvoid\r\nproto_reg_handoff_bthid(void)\r\n{\r\nusb_hid_boot_keyboard_input_report_handle = find_dissector_add_dependency("usbhid.boot_report.keyboard.input", proto_bthid);\r\nusb_hid_boot_keyboard_output_report_handle = find_dissector_add_dependency("usbhid.boot_report.keyboard.output", proto_bthid);\r\nusb_hid_boot_mouse_input_report_handle = find_dissector_add_dependency("usbhid.boot_report.mouse.input", proto_bthid);\r\ndissector_add_string("bluetooth.uuid", "11", bthid_handle);\r\ndissector_add_string("bluetooth.uuid", "1124", bthid_handle);\r\ndissector_add_uint("btl2cap.psm", BTL2CAP_PSM_HID_CTRL, bthid_handle);\r\ndissector_add_uint("btl2cap.psm", BTL2CAP_PSM_HID_INTR, bthid_handle);\r\ndissector_add_for_decode_as("btl2cap.cid", bthid_handle);\r\n}

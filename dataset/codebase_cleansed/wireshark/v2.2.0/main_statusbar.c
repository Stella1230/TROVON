static gboolean\r\nhigher_priority_status_level(int level)\r\n{\r\nint i;\r\nfor (i = level + 1; i < NUM_STATUS_LEVELS; i++) {\r\nif (status_levels[i])\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\nstatusbar_push_file_msg(const gchar *msg_format, ...)\r\n{\r\nva_list ap;\r\ngchar *msg;\r\nif (higher_priority_status_level(STATUS_LEVEL_FILE))\r\nreturn;\r\nstatus_levels[STATUS_LEVEL_FILE]++;\r\nva_start(ap, msg_format);\r\nmsg = g_strdup_vprintf(msg_format, ap);\r\nva_end(ap);\r\ngtk_statusbar_push(GTK_STATUSBAR(info_bar), file_ctx, msg);\r\ng_free(msg);\r\n}\r\nstatic void\r\nstatusbar_pop_file_msg(void)\r\n{\r\nif (status_levels[STATUS_LEVEL_FILE] > 0) {\r\nstatus_levels[STATUS_LEVEL_FILE]--;\r\n}\r\ngtk_statusbar_pop(GTK_STATUSBAR(info_bar), file_ctx);\r\n}\r\nvoid\r\nstatusbar_push_field_msg(const gchar *msg_format, ...)\r\n{\r\nva_list ap;\r\ngchar *msg;\r\nif (higher_priority_status_level(STATUS_LEVEL_HELP))\r\nreturn;\r\nstatus_levels[STATUS_LEVEL_HELP]++;\r\nva_start(ap, msg_format);\r\nmsg = g_strdup_vprintf(msg_format, ap);\r\nva_end(ap);\r\ngtk_statusbar_push(GTK_STATUSBAR(info_bar), help_ctx, msg);\r\ng_free(msg);\r\n}\r\nvoid\r\nstatusbar_pop_field_msg(void)\r\n{\r\nif (status_levels[STATUS_LEVEL_HELP] > 0) {\r\nstatus_levels[STATUS_LEVEL_HELP]--;\r\n}\r\ngtk_statusbar_pop(GTK_STATUSBAR(info_bar), help_ctx);\r\n}\r\nvoid\r\nstatusbar_push_filter_msg(const gchar *msg_format, ...)\r\n{\r\nva_list ap;\r\ngchar *msg;\r\nif (higher_priority_status_level(STATUS_LEVEL_FILTER))\r\nreturn;\r\nstatus_levels[STATUS_LEVEL_FILTER]++;\r\nva_start(ap, msg_format);\r\nmsg = g_strdup_vprintf(msg_format, ap);\r\nva_end(ap);\r\ngtk_statusbar_push(GTK_STATUSBAR(info_bar), filter_ctx, msg);\r\ng_free(msg);\r\n}\r\nvoid\r\nstatusbar_pop_filter_msg(void)\r\n{\r\nif (status_levels[STATUS_LEVEL_FILTER] > 0) {\r\nstatus_levels[STATUS_LEVEL_FILTER]--;\r\n}\r\ngtk_statusbar_pop(GTK_STATUSBAR(info_bar), filter_ctx);\r\n}\r\nstatic gboolean\r\nstatusbar_remove_temporary_msg(gpointer data)\r\n{\r\nguint msg_id = GPOINTER_TO_UINT(data);\r\ngtk_statusbar_remove(GTK_STATUSBAR(info_bar), main_ctx, msg_id);\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nstatusbar_flash_temporary_msg(gpointer data _U_)\r\n{\r\ngboolean retval = TRUE;\r\nif (flash_time > 0) {\r\nflash_highlight = !flash_highlight;\r\n} else {\r\nflash_highlight = FALSE;\r\nretval = FALSE;\r\n}\r\nif (flash_highlight) {\r\ngtk_drag_highlight(info_bar);\r\n} else {\r\ngtk_drag_unhighlight(info_bar);\r\n}\r\nflash_time -= TEMPORARY_FLASH_INTERVAL;\r\nreturn retval;\r\n}\r\nvoid\r\nstatusbar_push_temporary_msg(const gchar *msg_format, ...)\r\n{\r\nva_list ap;\r\ngchar *msg;\r\nguint msg_id;\r\nva_start(ap, msg_format);\r\nmsg = g_strdup_vprintf(msg_format, ap);\r\nva_end(ap);\r\nmsg_id = gtk_statusbar_push(GTK_STATUSBAR(info_bar), main_ctx, msg);\r\ng_free(msg);\r\nflash_time = TEMPORARY_FLASH_TIMEOUT - 1;\r\ng_timeout_add(TEMPORARY_FLASH_INTERVAL, statusbar_flash_temporary_msg, NULL);\r\ng_timeout_add(TEMPORARY_MSG_TIMEOUT, statusbar_remove_temporary_msg, GUINT_TO_POINTER(msg_id));\r\n}\r\nGtkWidget *\r\nstatusbar_new(void)\r\n{\r\nGtkWidget *status_hbox;\r\nstatus_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(status_hbox), 0);\r\nstatus_expert_new();\r\nstatus_capture_comment_new();\r\ninfo_bar_new();\r\npackets_bar_new();\r\nprofile_bar_new();\r\nstatus_pane_left = gtk_paned_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_widget_show(status_pane_left);\r\nstatus_pane_right = gtk_paned_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_widget_show(status_pane_right);\r\nreturn status_hbox;\r\n}\r\nvoid\r\nstatusbar_load_window_geometry(void)\r\n{\r\nif (recent.has_gui_geometry_status_pane && recent.gui_geometry_status_pane_left)\r\ngtk_paned_set_position(GTK_PANED(status_pane_left), recent.gui_geometry_status_pane_left);\r\nif (recent.has_gui_geometry_status_pane && recent.gui_geometry_status_pane_right)\r\ngtk_paned_set_position(GTK_PANED(status_pane_right), recent.gui_geometry_status_pane_right);\r\n}\r\nvoid\r\nstatusbar_save_window_geometry(void)\r\n{\r\nrecent.gui_geometry_status_pane_left = gtk_paned_get_position(GTK_PANED(status_pane_left));\r\nrecent.gui_geometry_status_pane_right = gtk_paned_get_position(GTK_PANED(status_pane_right));\r\n}\r\nstatic void\r\nforeach_remove_a_child(GtkWidget *widget, gpointer data) {\r\ngtk_container_remove(GTK_CONTAINER(data), widget);\r\n}\r\nvoid\r\nstatusbar_widgets_emptying(GtkWidget *statusbar)\r\n{\r\ng_object_ref(G_OBJECT(info_bar));\r\ng_object_ref(G_OBJECT(info_bar_event));\r\ng_object_ref(G_OBJECT(packets_bar));\r\ng_object_ref(G_OBJECT(profile_bar));\r\ng_object_ref(G_OBJECT(profile_bar_event));\r\ng_object_ref(G_OBJECT(status_pane_left));\r\ng_object_ref(G_OBJECT(status_pane_right));\r\ng_object_ref(G_OBJECT(expert_info_error));\r\ng_object_ref(G_OBJECT(expert_info_warn));\r\ng_object_ref(G_OBJECT(expert_info_note));\r\ng_object_ref(G_OBJECT(expert_info_chat));\r\ng_object_ref(G_OBJECT(expert_info_comment));\r\ng_object_ref(G_OBJECT(expert_info_none));\r\ng_object_ref(G_OBJECT(expert_info_placeholder));\r\ng_object_ref(G_OBJECT(capture_comment));\r\ng_object_ref(G_OBJECT(capture_comment_none));\r\ng_object_ref(G_OBJECT(capture_comment_placeholder));\r\ngtk_container_foreach(GTK_CONTAINER(statusbar), foreach_remove_a_child, statusbar);\r\ngtk_container_foreach(GTK_CONTAINER(status_pane_left), foreach_remove_a_child, status_pane_left);\r\ngtk_container_foreach(GTK_CONTAINER(status_pane_right), foreach_remove_a_child, status_pane_right);\r\n}\r\nvoid\r\nstatusbar_widgets_pack(GtkWidget *statusbar)\r\n{\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_error, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_warn, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_note, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_chat, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_comment, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_none, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), expert_info_placeholder, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), capture_comment, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), capture_comment_none, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), capture_comment_placeholder, FALSE, FALSE, 2);\r\ngtk_box_pack_start(GTK_BOX(statusbar), status_pane_left, TRUE, TRUE, 0);\r\ngtk_paned_pack1(GTK_PANED(status_pane_left), info_bar_event, FALSE, FALSE);\r\ngtk_paned_pack2(GTK_PANED(status_pane_left), status_pane_right, TRUE, FALSE);\r\ngtk_paned_pack1(GTK_PANED(status_pane_right), packets_bar, TRUE, FALSE);\r\ngtk_paned_pack2(GTK_PANED(status_pane_right), profile_bar_event, FALSE, FALSE);\r\n}\r\nvoid\r\nstatusbar_widgets_show_or_hide(GtkWidget *statusbar)\r\n{\r\nif ((recent.filter_toolbar_show && prefs.filter_toolbar_show_in_statusbar) ||\r\nrecent.statusbar_show) {\r\ngtk_widget_show(statusbar);\r\n} else {\r\ngtk_widget_hide(statusbar);\r\n}\r\nif (recent.statusbar_show) {\r\ngtk_widget_show(status_pane_left);\r\n} else {\r\ngtk_widget_hide(status_pane_left);\r\n}\r\n}\r\nstatic void\r\ninfo_bar_new(void)\r\n{\r\ninfo_bar_event = gtk_event_box_new();\r\ninfo_bar = gtk_statusbar_new();\r\ngtk_container_add(GTK_CONTAINER(info_bar_event), info_bar);\r\nmain_ctx = gtk_statusbar_get_context_id(GTK_STATUSBAR(info_bar), "main");\r\nfile_ctx = gtk_statusbar_get_context_id(GTK_STATUSBAR(info_bar), "file");\r\nhelp_ctx = gtk_statusbar_get_context_id(GTK_STATUSBAR(info_bar), "help");\r\nfilter_ctx = gtk_statusbar_get_context_id(GTK_STATUSBAR(info_bar), "filter");\r\n#if !GTK_CHECK_VERSION(3,0,0)\r\ngtk_statusbar_set_has_resize_grip(GTK_STATUSBAR(info_bar), FALSE);\r\n#endif\r\ngtk_statusbar_push(GTK_STATUSBAR(info_bar), main_ctx, DEF_READY_MESSAGE);\r\nmemset(status_levels, 0, sizeof(status_levels));\r\ngtk_widget_show(info_bar);\r\ngtk_widget_show(info_bar_event);\r\n}\r\nstatic void\r\npackets_bar_new(void)\r\n{\r\npackets_bar = gtk_statusbar_new();\r\npackets_ctx = gtk_statusbar_get_context_id(GTK_STATUSBAR(packets_bar), "packets");\r\npackets_bar_update();\r\n#if !GTK_CHECK_VERSION(3,0,0)\r\ngtk_statusbar_set_has_resize_grip(GTK_STATUSBAR(packets_bar), FALSE);\r\n#endif\r\ngtk_widget_show(packets_bar);\r\n}\r\nstatic void\r\nprofile_bar_new(void)\r\n{\r\nprofile_bar_event = gtk_event_box_new();\r\nprofile_bar = gtk_statusbar_new();\r\ngtk_container_add(GTK_CONTAINER(profile_bar_event), profile_bar);\r\ng_signal_connect(profile_bar_event, "button_press_event", G_CALLBACK(profile_show_popup_cb), NULL);\r\ng_signal_connect(profile_bar_event, "button_press_event", G_CALLBACK(popup_menu_handler),\r\ng_object_get_data(G_OBJECT(popup_menu_object), PM_STATUSBAR_PROFILES_KEY));\r\nprofile_ctx = gtk_statusbar_get_context_id(GTK_STATUSBAR(profile_bar), "profile");\r\ngtk_widget_set_tooltip_text(profile_bar_event, "Click to change configuration profile");\r\nprofile_bar_update();\r\n#if !GTK_CHECK_VERSION(3,0,0)\r\ngtk_statusbar_set_has_resize_grip(GTK_STATUSBAR(profile_bar), FALSE);\r\n#endif\r\ngtk_widget_show(profile_bar);\r\ngtk_widget_show(profile_bar_event);\r\n}\r\nvoid\r\npackets_bar_update(void)\r\n{\r\nif(packets_bar) {\r\nif(packets_str) {\r\ngtk_statusbar_pop(GTK_STATUSBAR(packets_bar), packets_ctx);\r\n} else {\r\npackets_str = g_string_new ("");\r\n}\r\nif(cfile.count) {\r\ng_string_printf(packets_str, " Packets: %u " UTF8_MIDDLE_DOT\r\n" Displayed: %u (%.1f%%) ",\r\ncfile.count,\r\ncfile.displayed_count,\r\n(100.0 * cfile.displayed_count)/cfile.count);\r\nif(cfile.marked_count) {\r\ng_string_append_printf(packets_str, " " UTF8_MIDDLE_DOT " Marked: %u (%.1f%%)",\r\ncfile.marked_count, (100.0 * cfile.marked_count)/cfile.count);\r\n}\r\nif(cfile.drops_known) {\r\ng_string_append_printf(packets_str, " " UTF8_MIDDLE_DOT " Dropped: %u (%.1f%%)",\r\ncfile.drops, (100.0 * cfile.drops)/cfile.count);\r\n}\r\nif(cfile.ignored_count) {\r\ng_string_append_printf(packets_str, " " UTF8_MIDDLE_DOT " Ignored: %u (%.1f%%)",\r\ncfile.ignored_count, (100.0 * cfile.ignored_count)/cfile.count);\r\n}\r\nif(!cfile.is_tempfile){\r\ngulong computed_elapsed = cf_get_computed_elapsed(&cfile);\r\ng_string_append_printf(packets_str, " " UTF8_MIDDLE_DOT " Load time: %lu:%02lu.%03lu",\r\ncomputed_elapsed/60000,\r\ncomputed_elapsed%60000/1000,\r\ncomputed_elapsed%1000);\r\n}\r\n} else {\r\ng_string_printf(packets_str, " No Packets");\r\n}\r\ngtk_statusbar_push(GTK_STATUSBAR(packets_bar), packets_ctx, packets_str->str);\r\n}\r\n}\r\nvoid\r\nprofile_bar_update(void)\r\n{\r\nif (profile_bar) {\r\nif(profile_str) {\r\ng_free(profile_str);\r\ngtk_statusbar_pop(GTK_STATUSBAR(profile_bar), profile_ctx);\r\n}\r\nprofile_str = g_strdup_printf (" Profile: %s", get_profile_name ());\r\ngtk_statusbar_push(GTK_STATUSBAR(profile_bar), profile_ctx, profile_str);\r\nset_menus_for_profiles(is_default_profile());\r\n}\r\n}\r\nstatic gboolean\r\nexpert_comp_dlg_event_cb(GtkWidget *w _U_, GdkEventButton *event _U_, gpointer user_data _U_)\r\n{\r\nexpert_comp_dlg_launch();\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nedit_capture_comment_dlg_event_cb(GtkWidget *w _U_, GdkEventButton *event _U_, gpointer user_data _U_)\r\n{\r\nedit_capture_comment_dlg_launch(NULL, NULL);\r\nreturn TRUE;\r\n}\r\nstatic void\r\nstatus_expert_new(void)\r\n{\r\nGtkWidget *expert_image;\r\nexpert_image = PIXBUF_TO_WIDGET(expert_error_pb_data, "/org/wireshark/image/toolbar/14x14/x-expert-error.png");\r\ngtk_widget_set_tooltip_text(expert_image, "ERROR is the highest expert info level");\r\ngtk_widget_show(expert_image);\r\nexpert_info_error = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_error), expert_image);\r\ng_signal_connect(expert_info_error, "button_press_event", G_CALLBACK(expert_comp_dlg_event_cb), NULL);\r\nexpert_image = PIXBUF_TO_WIDGET(expert_warn_pb_data, "/org/wireshark/image/toolbar/14x14/x-expert-warn.png");\r\ngtk_widget_set_tooltip_text(expert_image, "WARNING is the highest expert info level");\r\ngtk_widget_show(expert_image);\r\nexpert_info_warn = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_warn), expert_image);\r\ng_signal_connect(expert_info_warn, "button_press_event", G_CALLBACK(expert_comp_dlg_event_cb), NULL);\r\nexpert_image = PIXBUF_TO_WIDGET(expert_note_pb_data, "/org/wireshark/image/toolbar/14x14/x-expert-note.png");\r\ngtk_widget_set_tooltip_text(expert_image, "NOTE is the highest expert info level");\r\ngtk_widget_show(expert_image);\r\nexpert_info_note = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_note), expert_image);\r\ng_signal_connect(expert_info_note, "button_press_event", G_CALLBACK(expert_comp_dlg_event_cb), NULL);\r\nexpert_image = PIXBUF_TO_WIDGET(expert_chat_pb_data, "/org/wireshark/image/toolbar/14x14/x-expert-chat.png");\r\ngtk_widget_set_tooltip_text(expert_image, "CHAT is the highest expert info level");\r\ngtk_widget_show(expert_image);\r\nexpert_info_chat = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_chat), expert_image);\r\ng_signal_connect(expert_info_chat, "button_press_event", G_CALLBACK(expert_comp_dlg_event_cb), NULL);\r\nexpert_image = ws_gtk_image_new_from_stock(GTK_STOCK_YES, GTK_ICON_SIZE_MENU);\r\ngtk_widget_set_tooltip_text(expert_image, "COMMENT is the highest expert info level");\r\ngtk_widget_show(expert_image);\r\nexpert_info_comment = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_comment), expert_image);\r\ng_signal_connect(expert_info_comment, "button_press_event", G_CALLBACK(expert_comp_dlg_event_cb), NULL);\r\nexpert_image = PIXBUF_TO_WIDGET(expert_none_pb_data, "/org/wireshark/image/toolbar/14x14/x-expert-none.png");\r\ngtk_widget_set_tooltip_text(expert_image, "No expert info");\r\ngtk_widget_show(expert_image);\r\nexpert_info_none = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_none), expert_image);\r\ng_signal_connect(expert_info_none, "button_press_event", G_CALLBACK(expert_comp_dlg_event_cb), NULL);\r\nexpert_image = PIXBUF_TO_WIDGET(expert_none_pb_data, "/org/wireshark/image/toolbar/14x14/x-expert-none.png");\r\ngtk_widget_show(expert_image);\r\nexpert_info_placeholder = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(expert_info_placeholder), expert_image);\r\ngtk_widget_set_sensitive(expert_info_placeholder, FALSE);\r\ngtk_widget_show(expert_info_placeholder);\r\n}\r\nstatic void\r\nstatus_expert_hide(gboolean show_placeholder)\r\n{\r\ngtk_widget_hide(expert_info_error);\r\ngtk_widget_hide(expert_info_warn);\r\ngtk_widget_hide(expert_info_note);\r\ngtk_widget_hide(expert_info_chat);\r\ngtk_widget_hide(expert_info_comment);\r\ngtk_widget_hide(expert_info_none);\r\nif (show_placeholder)\r\ngtk_widget_show(expert_info_placeholder);\r\nelse\r\ngtk_widget_hide(expert_info_placeholder);\r\n}\r\nvoid\r\nstatus_expert_update(void)\r\n{\r\nstatus_expert_hide(FALSE);\r\nswitch(expert_get_highest_severity()) {\r\ncase(PI_ERROR):\r\ngtk_widget_show(expert_info_error);\r\nbreak;\r\ncase(PI_WARN):\r\ngtk_widget_show(expert_info_warn);\r\nbreak;\r\ncase(PI_NOTE):\r\ngtk_widget_show(expert_info_note);\r\nbreak;\r\ncase(PI_CHAT):\r\ngtk_widget_show(expert_info_chat);\r\nbreak;\r\ncase(PI_COMMENT):\r\ngtk_widget_show(expert_info_comment);\r\nbreak;\r\ndefault:\r\ngtk_widget_show(expert_info_none);\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nstatus_capture_comment_new(void)\r\n{\r\nGtkWidget *comment_image;\r\ncomment_image = PIXBUF_TO_WIDGET(capture_comment_update_pb_data, "/org/wireshark/image/capture_comment_update.png");\r\ngtk_widget_set_tooltip_text(comment_image, "Read or edit the comment for this capture file");\r\ngtk_widget_show(comment_image);\r\ncapture_comment = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(capture_comment), comment_image);\r\ng_signal_connect(capture_comment, "button_press_event", G_CALLBACK(edit_capture_comment_dlg_event_cb), NULL);\r\ncomment_image = PIXBUF_TO_WIDGET(capture_comment_add_pb_data, "/org/wireshark/image/capture_comment_add.png");\r\ngtk_widget_set_tooltip_text(comment_image, "Add a comment to this capture file");\r\ngtk_widget_show(comment_image);\r\ncapture_comment_none = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(capture_comment_none), comment_image);\r\ng_signal_connect(capture_comment_none, "button_press_event", G_CALLBACK(edit_capture_comment_dlg_event_cb), NULL);\r\ncomment_image = PIXBUF_TO_WIDGET(capture_comment_add_pb_data, "/org/wireshark/image/capture_comment_add.png");\r\ngtk_widget_show(comment_image);\r\ncapture_comment_placeholder = gtk_event_box_new();\r\ngtk_container_add(GTK_CONTAINER(capture_comment_placeholder), comment_image);\r\ngtk_widget_set_sensitive(capture_comment_placeholder, FALSE);\r\ngtk_widget_show(capture_comment_placeholder);\r\n}\r\nstatic void\r\nstatus_capture_comment_hide(gboolean show_placeholder)\r\n{\r\nedit_capture_comment_dlg_hide();\r\ngtk_widget_hide(capture_comment);\r\ngtk_widget_hide(capture_comment_none);\r\nif (show_placeholder)\r\ngtk_widget_show(capture_comment_placeholder);\r\nelse\r\ngtk_widget_hide(capture_comment_placeholder);\r\n}\r\nvoid\r\nstatus_capture_comment_update(void)\r\n{\r\nconst gchar *comment_str;\r\nstatus_capture_comment_hide(FALSE);\r\ncomment_str = cf_read_shb_comment(&cfile);\r\nif(comment_str!=NULL && *comment_str!=0x0){\r\ngtk_widget_show(capture_comment);\r\n}else{\r\ngtk_widget_show(capture_comment_none);\r\n}\r\n}\r\nstatic void\r\nstatusbar_set_filename(const char *file_name, gint64 file_length, nstime_t *file_elapsed_time)\r\n{\r\ngchar *size_str;\r\nstatus_expert_update();\r\nsize_str = format_size(file_length, (format_size_flags_e)(format_size_unit_bytes|format_size_prefix_si));\r\nstatusbar_push_file_msg(" File: \"%s\" %s %02lu:%02lu:%02lu",\r\n(file_name) ? file_name : "", size_str,\r\n(long)file_elapsed_time->secs/3600,\r\n(long)file_elapsed_time->secs%3600/60,\r\n(long)file_elapsed_time->secs%60);\r\ng_free(size_str);\r\n}\r\nstatic void\r\nstatusbar_cf_file_closing_cb(capture_file *cf _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\nstatus_expert_hide(FALSE);\r\ngtk_widget_show(expert_info_none);\r\n}\r\nstatic void\r\nstatusbar_cf_file_closed_cb(capture_file *cf _U_)\r\n{\r\npackets_bar_update();\r\nstatus_capture_comment_hide(TRUE);\r\nstatus_expert_hide(TRUE);\r\n}\r\nstatic void\r\nstatusbar_cf_file_read_started_cb(capture_file *cf, const char *action)\r\n{\r\ngchar *name_ptr;\r\nstatusbar_pop_file_msg();\r\nname_ptr = g_filename_display_basename(cf->filename);\r\nstatusbar_push_file_msg(" %s: %s", action, name_ptr);\r\ng_free(name_ptr);\r\n}\r\nstatic void\r\nstatusbar_cf_file_read_finished_cb(capture_file *cf)\r\n{\r\nstatusbar_pop_file_msg();\r\nstatusbar_set_filename(cf->filename, cf->f_datalen, &(cf->elapsed_time));\r\nstatus_capture_comment_update();\r\n}\r\nstatic void\r\nstatusbar_capture_prepared_cb(capture_session *cap_session _U_)\r\n{\r\nstatic const gchar msg[] = " Waiting for capture input data ...";\r\nstatusbar_push_file_msg(msg);\r\n}\r\nstatic GString *\r\nstatusbar_get_interface_names(capture_options *capture_opts)\r\n{\r\nGString *interface_names;\r\ninterface_names = get_iface_list_string(capture_opts, 0);\r\nif (strlen (interface_names->str) > 0) {\r\ng_string_append(interface_names, ":");\r\n}\r\ng_string_append(interface_names, " ");\r\nreturn (interface_names);\r\n}\r\nstatic void\r\nstatusbar_capture_update_started_cb(capture_session *cap_session)\r\n{\r\ncapture_options *capture_opts = cap_session->capture_opts;\r\nGString *interface_names;\r\nstatusbar_pop_file_msg();\r\ninterface_names = statusbar_get_interface_names(capture_opts);\r\nstatusbar_push_file_msg("%s<live capture in progress> to file: %s",\r\ninterface_names->str,\r\n(capture_opts->save_file) ? capture_opts->save_file : "");\r\ng_string_free(interface_names, TRUE);\r\nstatus_capture_comment_update();\r\n}\r\nstatic void\r\nstatusbar_capture_update_continue_cb(capture_session *cap_session)\r\n{\r\nGString *interface_names;\r\ncapture_options *capture_opts = cap_session->capture_opts;\r\ncapture_file *cf = (capture_file *)cap_session->cf;\r\nstatus_expert_update();\r\nstatusbar_pop_file_msg();\r\ninterface_names = statusbar_get_interface_names(capture_opts);\r\nif (cf->f_datalen/1024/1024 > 10) {\r\nstatusbar_push_file_msg("%s<live capture in progress> File: %s %" G_GINT64_MODIFIER "d MB",\r\ninterface_names->str,\r\ncapture_opts->save_file,\r\ncf->f_datalen/1024/1024);\r\n} else if (cf->f_datalen/1024 > 10) {\r\nstatusbar_push_file_msg("%s<live capture in progress> File: %s %" G_GINT64_MODIFIER "d KB",\r\ninterface_names->str,\r\ncapture_opts->save_file,\r\ncf->f_datalen/1024);\r\n} else {\r\nstatusbar_push_file_msg("%s<live capture in progress> File: %s %" G_GINT64_MODIFIER "d Bytes",\r\ninterface_names->str,\r\ncapture_opts->save_file,\r\ncf->f_datalen);\r\n}\r\ng_string_free(interface_names, TRUE);\r\n}\r\nstatic void\r\nstatusbar_capture_update_finished_cb(capture_session *cap_session)\r\n{\r\ncapture_file *cf = (capture_file *)cap_session->cf;\r\nstatusbar_pop_file_msg();\r\nstatusbar_set_filename(cf->filename, cf->f_datalen, &(cf->elapsed_time));\r\npackets_bar_update();\r\n}\r\nstatic void\r\nstatusbar_capture_fixed_started_cb(capture_session *cap_session)\r\n{\r\ncapture_options *capture_opts = cap_session->capture_opts;\r\nGString *interface_names;\r\nstatusbar_pop_file_msg();\r\ninterface_names = statusbar_get_interface_names(capture_opts);\r\nstatusbar_push_file_msg("%s<live capture in progress> to file: %s",\r\ninterface_names->str,\r\n(capture_opts->save_file) ? capture_opts->save_file : "");\r\ngtk_statusbar_push(GTK_STATUSBAR(packets_bar), packets_ctx, " Packets: 0");\r\ng_string_free(interface_names, TRUE);\r\n}\r\nstatic void\r\nstatusbar_capture_fixed_continue_cb(capture_session *cap_session)\r\n{\r\ngchar *capture_msg;\r\ngtk_statusbar_pop(GTK_STATUSBAR(packets_bar), packets_ctx);\r\ncapture_msg = g_strdup_printf(" Packets: %u", cap_session->count);\r\ngtk_statusbar_push(GTK_STATUSBAR(packets_bar), packets_ctx, capture_msg);\r\ng_free(capture_msg);\r\n}\r\nstatic void\r\nstatusbar_capture_fixed_finished_cb(capture_session *cap_session _U_)\r\n{\r\n#if 0\r\ncapture_file *cf = (capture_file *)cap_session->cf;\r\n#endif\r\nstatusbar_pop_file_msg();\r\ngtk_statusbar_pop(GTK_STATUSBAR(packets_bar), packets_ctx);\r\n}\r\nstatic void\r\nstatusbar_capture_failed_cb(capture_session *cap_session _U_)\r\n{\r\n#if 0\r\ncapture_file *cf = (capture_file *)cap_session->cf;\r\n#endif\r\nstatusbar_pop_file_msg();\r\ngtk_statusbar_pop(GTK_STATUSBAR(packets_bar), packets_ctx);\r\n}\r\nstatic void\r\nstatusbar_cf_field_unselected_cb(capture_file *cf _U_)\r\n{\r\nstatusbar_pop_field_msg();\r\n}\r\nstatic void\r\nstatusbar_cf_file_save_started_cb(gchar *filename)\r\n{\r\nstatusbar_pop_file_msg();\r\nstatusbar_push_file_msg(" Saving: %s...", g_filename_display_basename(filename));\r\n}\r\nstatic void\r\nstatusbar_cf_file_save_finished_cb(gpointer data _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\n}\r\nstatic void\r\nstatusbar_cf_file_save_failed_cb(gpointer data _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\n}\r\nstatic void\r\nstatusbar_cf_file_save_stopped_cb(gpointer data _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\n}\r\nstatic void\r\nstatusbar_cf_file_export_specified_packets_started_cb(gchar *filename)\r\n{\r\nstatusbar_pop_file_msg();\r\nstatusbar_push_file_msg(" Exporting to: %s...", g_filename_display_basename(filename));\r\n}\r\nstatic void\r\nstatusbar_cf_file_export_specified_packets_finished_cb(gpointer data _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\n}\r\nstatic void\r\nstatusbar_cf_file_export_specified_packets_failed_cb(gpointer data _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\n}\r\nstatic void\r\nstatusbar_cf_file_export_specified_packets_stopped_cb(gpointer data _U_)\r\n{\r\nstatusbar_pop_file_msg();\r\n}\r\nvoid\r\nstatusbar_cf_callback(gint event, gpointer data, gpointer user_data _U_)\r\n{\r\nswitch(event) {\r\ncase(cf_cb_file_opened):\r\nbreak;\r\ncase(cf_cb_file_closing):\r\nstatusbar_cf_file_closing_cb((capture_file *)data);\r\nbreak;\r\ncase(cf_cb_file_closed):\r\nstatusbar_cf_file_closed_cb((capture_file *)data);\r\nbreak;\r\ncase(cf_cb_file_read_started):\r\nstatusbar_cf_file_read_started_cb((capture_file *)data, "Loading");\r\nbreak;\r\ncase(cf_cb_file_read_finished):\r\nstatusbar_cf_file_read_finished_cb((capture_file *)data);\r\nbreak;\r\ncase(cf_cb_file_reload_started):\r\nstatusbar_cf_file_read_started_cb((capture_file *)data, "Reloading");\r\nbreak;\r\ncase(cf_cb_file_reload_finished):\r\nstatusbar_cf_file_read_finished_cb((capture_file *)data);\r\nbreak;\r\ncase(cf_cb_file_rescan_started):\r\nstatusbar_cf_file_read_started_cb((capture_file *)data, "Rescanning");\r\nbreak;\r\ncase(cf_cb_file_rescan_finished):\r\nstatusbar_cf_file_read_finished_cb((capture_file *)data);\r\nbreak;\r\ncase(cf_cb_file_retap_started):\r\nbreak;\r\ncase(cf_cb_file_retap_finished):\r\nbreak;\r\ncase(cf_cb_file_fast_save_finished):\r\nbreak;\r\ncase(cf_cb_packet_selected):\r\nbreak;\r\ncase(cf_cb_packet_unselected):\r\nbreak;\r\ncase(cf_cb_field_unselected):\r\nstatusbar_cf_field_unselected_cb((capture_file *)data);\r\nbreak;\r\ncase(cf_cb_file_save_started):\r\nstatusbar_cf_file_save_started_cb((gchar *)data);\r\nbreak;\r\ncase(cf_cb_file_save_finished):\r\nstatusbar_cf_file_save_finished_cb(data);\r\nbreak;\r\ncase(cf_cb_file_save_failed):\r\nstatusbar_cf_file_save_failed_cb(data);\r\nbreak;\r\ncase(cf_cb_file_save_stopped):\r\nstatusbar_cf_file_save_stopped_cb(data);\r\nbreak;\r\ncase(cf_cb_file_export_specified_packets_started):\r\nstatusbar_cf_file_export_specified_packets_started_cb((gchar *)data);\r\nbreak;\r\ncase(cf_cb_file_export_specified_packets_finished):\r\nstatusbar_cf_file_export_specified_packets_finished_cb(data);\r\nbreak;\r\ncase(cf_cb_file_export_specified_packets_failed):\r\nstatusbar_cf_file_export_specified_packets_failed_cb(data);\r\nbreak;\r\ncase(cf_cb_file_export_specified_packets_stopped):\r\nstatusbar_cf_file_export_specified_packets_stopped_cb(data);\r\nbreak;\r\ndefault:\r\ng_warning("statusbar_cf_callback: event %u unknown", event);\r\ng_assert_not_reached();\r\n}\r\n}\r\nvoid\r\nstatusbar_capture_callback(gint event, capture_session *cap_session,\r\ngpointer user_data _U_)\r\n{\r\nswitch(event) {\r\ncase(capture_cb_capture_prepared):\r\nstatusbar_capture_prepared_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_update_started):\r\nstatusbar_capture_update_started_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_update_continue):\r\nstatusbar_capture_update_continue_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_update_finished):\r\nstatusbar_capture_update_finished_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_fixed_started):\r\nstatusbar_capture_fixed_started_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_fixed_continue):\r\nstatusbar_capture_fixed_continue_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_fixed_finished):\r\nstatusbar_capture_fixed_finished_cb(cap_session);\r\nbreak;\r\ncase(capture_cb_capture_stopping):\r\nbreak;\r\ncase(capture_cb_capture_failed):\r\nstatusbar_capture_failed_cb(cap_session);\r\nbreak;\r\ndefault:\r\ng_warning("statusbar_capture_callback: event %u unknown", event);\r\ng_assert_not_reached();\r\n}\r\n}

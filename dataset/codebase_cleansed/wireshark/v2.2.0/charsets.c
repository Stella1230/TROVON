guint8 *\r\nget_ascii_string(wmem_allocator_t *scope, const guint8 *ptr, gint length)\r\n{\r\nwmem_strbuf_t *str;\r\nstr = wmem_strbuf_sized_new(scope, length+1, 0);\r\nwhile (length > 0) {\r\nguint8 ch = *ptr;\r\nif (ch < 0x80)\r\nwmem_strbuf_append_c(str, ch);\r\nelse\r\nwmem_strbuf_append_unichar(str, UNREPL);\r\nptr++;\r\nlength--;\r\n}\r\nreturn (guint8 *) wmem_strbuf_finalize(str);\r\n}\r\nguint8 *\r\nget_8859_1_string(wmem_allocator_t *scope, const guint8 *ptr, gint length)\r\n{\r\nwmem_strbuf_t *str;\r\nstr = wmem_strbuf_sized_new(scope, length+1, 0);\r\nwhile (length > 0) {\r\nguint8 ch = *ptr;\r\nif (ch < 0x80)\r\nwmem_strbuf_append_c(str, ch);\r\nelse {\r\nwmem_strbuf_append_unichar(str, ch);\r\n}\r\nptr++;\r\nlength--;\r\n}\r\nreturn (guint8 *) wmem_strbuf_finalize(str);\r\n}\r\nguint8 *\r\nget_unichar2_string(wmem_allocator_t *scope, const guint8 *ptr, gint length, const gunichar2 table[0x80])\r\n{\r\nwmem_strbuf_t *str;\r\nstr = wmem_strbuf_sized_new(scope, length+1, 0);\r\nwhile (length > 0) {\r\nguint8 ch = *ptr;\r\nif (ch < 0x80)\r\nwmem_strbuf_append_c(str, ch);\r\nelse\r\nwmem_strbuf_append_unichar(str, table[ch-0x80]);\r\nptr++;\r\nlength--;\r\n}\r\nreturn (guint8 *) wmem_strbuf_finalize(str);\r\n}\r\nguint8 *\r\nget_ucs_2_string(wmem_allocator_t *scope, const guint8 *ptr, gint length, const guint encoding)\r\n{\r\ngunichar2 uchar;\r\ngint i;\r\nwmem_strbuf_t *strbuf;\r\nstrbuf = wmem_strbuf_sized_new(scope, length+1, 0);\r\nfor(i = 0; i + 1 < length; i += 2) {\r\nif (encoding == ENC_BIG_ENDIAN){\r\nuchar = pntoh16(ptr + i);\r\n}else{\r\nuchar = pletoh16(ptr + i);\r\n}\r\nwmem_strbuf_append_unichar(strbuf, uchar);\r\n}\r\nreturn (guint8 *) wmem_strbuf_finalize(strbuf);\r\n}\r\nguint8 *\r\nget_utf_16_string(wmem_allocator_t *scope, const guint8 *ptr, gint length, const guint encoding)\r\n{\r\nwmem_strbuf_t *strbuf;\r\ngunichar2 uchar2, lead_surrogate;\r\ngunichar uchar;\r\ngint i;\r\nstrbuf = wmem_strbuf_sized_new(scope, length+1, 0);\r\nfor(i = 0; i + 1 < length; i += 2) {\r\nif (encoding == ENC_BIG_ENDIAN)\r\nuchar2 = pntoh16(ptr + i);\r\nelse\r\nuchar2 = pletoh16(ptr + i);\r\nif (IS_LEAD_SURROGATE(uchar2)) {\r\ni += 2;\r\nif (i + 1 >= length) {\r\nbreak;\r\n}\r\nlead_surrogate = uchar2;\r\nif (encoding == ENC_BIG_ENDIAN)\r\nuchar2 = pntoh16(ptr + i);\r\nelse\r\nuchar2 = pletoh16(ptr + i);\r\nif (IS_TRAIL_SURROGATE(uchar2)) {\r\nuchar = SURROGATE_VALUE(lead_surrogate, uchar2);\r\nwmem_strbuf_append_unichar(strbuf, uchar);\r\n} else {\r\n;\r\n}\r\n} else {\r\nif (IS_TRAIL_SURROGATE(uchar2)) {\r\n;\r\n} else {\r\nwmem_strbuf_append_unichar(strbuf, uchar2);\r\n}\r\n}\r\n}\r\nreturn (guint8 *) wmem_strbuf_finalize(strbuf);\r\n}\r\nguint8 *\r\nget_ucs_4_string(wmem_allocator_t *scope, const guint8 *ptr, gint length, const guint encoding)\r\n{\r\ngunichar uchar;\r\ngint i;\r\nwmem_strbuf_t *strbuf;\r\nstrbuf = wmem_strbuf_sized_new(scope, length+1, 0);\r\nfor(i = 0; i + 3 < length; i += 4) {\r\nif (encoding == ENC_BIG_ENDIAN)\r\nuchar = pntoh32(ptr + i);\r\nelse\r\nuchar = pletoh32(ptr + i);\r\nwmem_strbuf_append_unichar(strbuf, uchar);\r\n}\r\nreturn (gchar *)wmem_strbuf_finalize(strbuf);\r\n}\r\nstatic gunichar\r\nGSM_to_UNICHAR(guint8 c)\r\n{\r\nif (c < G_N_ELEMENTS(gsm_default_alphabet))\r\nreturn gsm_default_alphabet[c];\r\nreturn UNREPL;\r\n}\r\nstatic gunichar\r\nGSMext_to_UNICHAR(guint8 c)\r\n{\r\nswitch (c)\r\n{\r\ncase 0x0a: return 0x0c;\r\ncase 0x14: return '^';\r\ncase 0x28: return '{';\r\ncase 0x29: return '}';\r\ncase 0x2f: return '\\';\r\ncase 0x3c: return '[';\r\ncase 0x3d: return '~';\r\ncase 0x3e: return ']';\r\ncase 0x40: return '|';\r\ncase 0x65: return 0x20ac;\r\n}\r\nreturn UNREPL;\r\n}\r\nstatic gboolean\r\nchar_is_escape(unsigned char value)\r\n{\r\nreturn (value == GN_CHAR_ESCAPE);\r\n}\r\nstatic gboolean\r\nhandle_ts_23_038_char(wmem_strbuf_t *strbuf, guint8 code_point,\r\ngboolean saw_escape)\r\n{\r\ngunichar uchar;\r\nif (char_is_escape(code_point)) {\r\nsaw_escape = TRUE;\r\n} else {\r\nif (saw_escape) {\r\nsaw_escape = FALSE;\r\nuchar = GSMext_to_UNICHAR(code_point);\r\n} else {\r\nuchar = GSM_to_UNICHAR(code_point);\r\n}\r\nwmem_strbuf_append_unichar(strbuf, uchar);\r\n}\r\nreturn saw_escape;\r\n}\r\nguint8 *\r\nget_ts_23_038_7bits_string(wmem_allocator_t *scope, const guint8 *ptr,\r\nconst gint bit_offset, gint no_of_chars)\r\n{\r\nwmem_strbuf_t *strbuf;\r\ngint char_count;\r\nguint8 in_byte, out_byte, rest = 0x00;\r\nconst guint8 *start_ptr = ptr;\r\ngboolean saw_escape = FALSE;\r\nint bits;\r\nstrbuf = wmem_strbuf_sized_new(scope, no_of_chars+1, 0);\r\nbits = bit_offset & 0x07;\r\nif (!bits) {\r\nbits = 7;\r\n}\r\nfor(char_count = 0; char_count < no_of_chars; ptr++) {\r\nin_byte = *ptr;\r\nout_byte = ((in_byte & GN_BYTE_MASK) << (7 - bits)) | rest;\r\nrest = in_byte >> bits;\r\nif ((start_ptr != ptr) || (bits == 7)) {\r\nsaw_escape = handle_ts_23_038_char(strbuf, out_byte,\r\nsaw_escape);\r\nchar_count++;\r\n}\r\nif ((bits == 1) && (char_count < no_of_chars)) {\r\nsaw_escape = handle_ts_23_038_char(strbuf, rest,\r\nsaw_escape);\r\nchar_count++;\r\nbits = 7;\r\nrest = 0x00;\r\n} else {\r\nbits--;\r\n}\r\n}\r\nif (saw_escape) {\r\nwmem_strbuf_append_unichar(strbuf, UNREPL);\r\n}\r\nreturn (guint8 *)wmem_strbuf_finalize(strbuf);\r\n}\r\nguint8 *\r\nget_ascii_7bits_string(wmem_allocator_t *scope, const guint8 *ptr,\r\nconst gint bit_offset, gint no_of_chars)\r\n{\r\nwmem_strbuf_t *strbuf;\r\ngint char_count;\r\nguint8 in_byte, out_byte, rest = 0x00;\r\nconst guint8 *start_ptr = ptr;\r\nint bits;\r\nbits = bit_offset & 0x07;\r\nif (!bits) {\r\nbits = 7;\r\n}\r\nstrbuf = wmem_strbuf_sized_new(scope, no_of_chars+1, 0);\r\nfor(char_count = 0; char_count < no_of_chars; ptr++) {\r\nin_byte = *ptr;\r\nout_byte = (in_byte >> (8 - bits)) | rest;\r\nrest = (in_byte << (bits - 1)) & 0x7f;\r\nif ((start_ptr != ptr) || (bits == 7)) {\r\nwmem_strbuf_append_c(strbuf, out_byte);\r\nchar_count++;\r\n}\r\nif ((bits == 1) && (char_count < no_of_chars)) {\r\nwmem_strbuf_append_c(strbuf, rest);\r\nchar_count++;\r\nbits = 7;\r\nrest = 0x00;\r\n} else {\r\nbits--;\r\n}\r\n}\r\nreturn (guint8 *)wmem_strbuf_finalize(strbuf);\r\n}\r\nvoid\r\nEBCDIC_to_ASCII(guint8 *buf, guint bytes)\r\n{\r\nguint i;\r\nguint8 *bufptr;\r\nbufptr = buf;\r\nfor (i = 0; i < bytes; i++, bufptr++) {\r\n*bufptr = EBCDIC_translate_ASCII[*bufptr];\r\n}\r\n}\r\nguint8\r\nEBCDIC_to_ASCII1(guint8 c)\r\n{\r\nreturn EBCDIC_translate_ASCII[c];\r\n}\r\nguint8 *\r\nget_ebcdic_string(wmem_allocator_t *scope, const guint8 *ptr, gint length)\r\n{\r\nwmem_strbuf_t *str;\r\nstr = wmem_strbuf_sized_new(scope, length+1, 0);\r\nwhile (length > 0) {\r\nguint8 ch = *ptr;\r\nwmem_strbuf_append_unichar(str, EBCDIC_translate_ASCII[ch]);\r\nptr++;\r\nlength--;\r\n}\r\nreturn (guint8 *) wmem_strbuf_finalize(str);\r\n}

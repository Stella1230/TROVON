static guint\r\ndissect_etv_bif_platform_ids(tvbuff_t *tvb, proto_tree *tree, guint offset)\r\n{\r\nproto_tree *platform_tree;\r\nplatform_tree = proto_tree_add_subtree(tree, tvb, offset, 15, ett_eiss_platform_id, NULL, "Platform Id");\r\nproto_tree_add_item(platform_tree, hf_pdtHWManufacturer, tvb, offset, 3, ENC_BIG_ENDIAN);\r\noffset += 3;\r\nproto_tree_add_item(platform_tree, hf_pdtHWModel, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(platform_tree, hf_pdtHWVersionMajor, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(platform_tree, hf_pdtHWVersionMinor, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(platform_tree, hf_pdtSWManufacturer, tvb, offset, 3, ENC_BIG_ENDIAN);\r\noffset += 3;\r\nproto_tree_add_item(platform_tree, hf_pdtSWModel, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(platform_tree, hf_pdtSWVersionMajor, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(platform_tree, hf_pdtSWVersionMinor, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(platform_tree, hf_pdtProfile, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nreturn 15;\r\n}\r\nstatic guint\r\ndissect_eiss_descriptors(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint offset)\r\n{\r\nproto_tree *sub_tree;\r\nguint tag;\r\ntag = tvb_get_guint8(tvb, offset);\r\nif (0xe0 == tag) {\r\nguint total_length;\r\ntotal_length = tvb_get_guint8(tvb, offset+1);\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, (2+total_length),\r\nett_eiss_desc, NULL, "ETV Application Information Descriptor");\r\nproto_tree_add_item(sub_tree, hf_eiss_descriptor_tag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_descriptor_length, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_app_control_code, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_app_version_major, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_app_version_minor, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_max_proto_version_major,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_max_proto_version_minor,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_test_flag, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_reserved, tvb, offset,\r\n3, ENC_BIG_ENDIAN);\r\noffset += 3;\r\nproto_tree_add_item(sub_tree, hf_eiss_aid_priority, tvb, offset,\r\n1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_irl_type, tvb, offset, 2,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_eiss_irl_length, tvb, offset,\r\n2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_eiss_irl_string, tvb, offset, 2,\r\nENC_ASCII|ENC_BIG_ENDIAN);\r\nreturn (2+total_length);\r\n} else if (0xe1 == tag) {\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, 6,\r\nett_eiss_desc, NULL, "ETV Media Time Descriptor");\r\nproto_tree_add_item(sub_tree, hf_eiss_descriptor_tag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_descriptor_length, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_mtd_time_value, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\nreturn 6;\r\n} else if (0xe2 == tag) {\r\nguint tmp;\r\ntvbuff_t *payload;\r\ntmp = tvb_get_ntohs(tvb, offset+1);\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, (3+tmp),\r\nett_eiss_desc, NULL, "ETV Stream Event Descriptor");\r\nproto_tree_add_item(sub_tree, hf_eiss_descriptor_tag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_eiss_sed_reserved, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_eiss_sed_descriptor_length, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_eiss_sed_time_value, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\npayload = tvb_new_subset_length(tvb, offset, tmp-4);\r\ncall_data_dissector(payload, pinfo, sub_tree);\r\nreturn (3+tmp);\r\n} else {\r\nproto_tree_add_expert(tree, pinfo, &ei_eiss_unknown_descriptor, tvb, offset, -1);\r\nreturn 1000;\r\n}\r\n}\r\nstatic int\r\ndissect_eiss(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0, packet_length, sect_len;\r\nproto_item *ti;\r\nproto_item *pi;\r\nproto_tree *eiss_tree;\r\nproto_item *items[PACKET_MPEG_SECT_PI__SIZE];\r\ngboolean ssi;\r\nguint reserved;\r\nguint8 reserved2;\r\nguint8 sect_num, last_sect_num;\r\nguint16 eiss_application_type;\r\nguint8 platform_id_length;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "EISS");\r\nti = proto_tree_add_item(tree, proto_eiss, tvb, offset, -1, ENC_NA);\r\neiss_tree = proto_item_add_subtree(ti, ett_eiss);\r\noffset += packet_mpeg_sect_header_extra(tvb, offset, eiss_tree, &sect_len,\r\n&reserved, &ssi, items);\r\npacket_length = sect_len + 3 - 4;\r\nif (FALSE != ssi) {\r\nproto_item *msg_error;\r\nmsg_error = items[PACKET_MPEG_SECT_PI__SSI];\r\nPROTO_ITEM_SET_GENERATED(msg_error);\r\nexpert_add_info(pinfo, msg_error, &ei_eiss_invalid_section_syntax_indicator);\r\n}\r\nif (0 != reserved) {\r\nproto_item *msg_error;\r\nmsg_error = items[PACKET_MPEG_SECT_PI__RESERVED];\r\nPROTO_ITEM_SET_GENERATED(msg_error);\r\nexpert_add_info_format(pinfo, msg_error, &ei_eiss_invalid_reserved_bits, "Invalid reserved1 bits (should all be 0)");\r\n}\r\nif (1021 < sect_len) {\r\nproto_item *msg_error;\r\nmsg_error = items[PACKET_MPEG_SECT_PI__LENGTH];\r\nPROTO_ITEM_SET_GENERATED(msg_error);\r\nexpert_add_info(pinfo, msg_error, &ei_eiss_invalid_section_length);\r\n}\r\nreserved2 = tvb_get_guint8(tvb, offset);\r\npi = proto_tree_add_item(eiss_tree, hf_eiss_reserved2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (0 != reserved2) {\r\nexpert_add_info_format(pinfo, pi, &ei_eiss_invalid_reserved_bits, "Invalid reserved2 bits (should all be 0)");\r\n}\r\noffset++;\r\nsect_num = tvb_get_guint8(tvb, offset);\r\nlast_sect_num = tvb_get_guint8(tvb, offset + 1);\r\npi = proto_tree_add_item(eiss_tree, hf_eiss_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (last_sect_num < sect_num) {\r\nexpert_add_info(pinfo, pi, &ei_eiss_section_number);\r\n}\r\noffset++;\r\nproto_tree_add_item(eiss_tree, hf_eiss_last_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(eiss_tree, hf_eiss_protocol_version_major, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(eiss_tree, hf_eiss_protocol_version_minor, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\neiss_application_type = tvb_get_ntohs(tvb, offset);\r\npi = proto_tree_add_item(eiss_tree, hf_eiss_application_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (8 != eiss_application_type) {\r\nexpert_add_info(pinfo, pi, &ei_eiss_application_type);\r\n}\r\noffset += 2;\r\nproto_tree_add_item(eiss_tree, hf_eiss_organisation_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(eiss_tree, hf_eiss_application_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nplatform_id_length = tvb_get_guint8(tvb, offset);\r\npi = proto_tree_add_item(eiss_tree, hf_eiss_platform_id_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (0 != platform_id_length % 15) {\r\nexpert_add_info(pinfo, pi, &ei_eiss_platform_id_length);\r\n}\r\noffset++;\r\nwhile (0 < platform_id_length) {\r\nguint tmp;\r\ntmp = dissect_etv_bif_platform_ids(tvb, eiss_tree, offset);\r\noffset += tmp;\r\nif (platform_id_length < tmp) {\r\nplatform_id_length = 0;\r\n} else {\r\nplatform_id_length -= tmp;\r\n}\r\n}\r\nif (0 < packet_length) {\r\nproto_tree *eiss_desc_tree;\r\neiss_desc_tree = proto_tree_add_subtree(eiss_tree, tvb, offset,\r\npacket_length-offset, ett_eiss_desc, NULL, "EISS Descriptor(s)");\r\nwhile (offset < packet_length) {\r\noffset += dissect_eiss_descriptors(tvb, pinfo,\r\neiss_desc_tree, offset);\r\n}\r\n}\r\npacket_mpeg_sect_crc(tvb, pinfo, eiss_tree, 0, sect_len - 1);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_eiss(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_eiss_reserved2, {\r\n"Reserved", "eiss.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_section_number, {\r\n"Section Number", "eiss.sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_last_section_number, {\r\n"Last Section Number", "eiss.last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_protocol_version_major, {\r\n"Major Version Number", "eiss.version_major",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_protocol_version_minor, {\r\n"Minor Version Number", "eiss.version_minor",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_application_type, {\r\n"Application Type", "eiss.app_type",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_organisation_id, {\r\n"Organisation Id", "eiss.org_id",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_application_id, {\r\n"Application Id", "eiss.app_id",\r\nFT_UINT16, BASE_HEX|BASE_RANGE_STRING, RVALS(application_id_values), 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_platform_id_length, {\r\n"Platform Id Length", "eiss.platform_id_length",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtHWManufacturer, {\r\n"Platform Hardware Manufacturer", "eiss.plat_hw_man",\r\nFT_UINT24, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtHWModel, {\r\n"Platform Hardware Model", "eiss.plat_hw_model",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtHWVersionMajor, {\r\n"Platform Hardware Major Version", "eiss.plat_hw_major",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtHWVersionMinor, {\r\n"Platform Hardware Minor Version", "eiss.plat_hw_minor",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtSWManufacturer, {\r\n"Platform Software Manufacturer", "eiss.plat_sw_man",\r\nFT_UINT24, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtSWModel, {\r\n"Platform Software Model", "eiss.plat_sw_model",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtSWVersionMajor, {\r\n"Platform Software Major Version", "eiss.plat_sw_major",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtSWVersionMinor, {\r\n"Platform Software Minor Version", "eiss.plat_sw_minor",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_pdtProfile, {\r\n"Platform Profile", "eiss.plat_profile",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_descriptor_tag, {\r\n"EISS Descriptor Tag", "eiss.desc.tag",\r\nFT_UINT8, BASE_HEX, VALS(eiss_descriptor_values), 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_descriptor_length, {\r\n"Descriptor Length", "eiss.desc.length",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_app_control_code, {\r\n"Application Control Code", "eiss.aid.app_control_code",\r\nFT_UINT8, BASE_HEX|BASE_RANGE_STRING, RVALS(aid_control_code_values), 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_app_version_major, {\r\n"Application Version Major", "eiss.aid.app_version_major",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_app_version_minor, {\r\n"Application Version Minor", "eiss.aid.app_version_minor",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_max_proto_version_major, {\r\n"Max Protocol Version Major", "eiss.aid.max_proto_version_major",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_max_proto_version_minor, {\r\n"Max Protocol Version Minor", "eiss.aid.max_proto_version_minor",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_test_flag, {\r\n"Application Test Flag", "eiss.aid.test_flag",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_reserved, {\r\n"Reserved", "eiss.aid.reserved",\r\nFT_UINT24, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_aid_priority, {\r\n"Application Priority", "eiss.aid.priority",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_irl_type, {\r\n"Initial Resource Locator Type", "eiss.aid.irl.type",\r\nFT_UINT16, BASE_HEX, NULL, 0xfc00, NULL, HFILL\r\n} },\r\n{ &hf_eiss_irl_length, {\r\n"Initial Resource Locator Length", "eiss.aid.irl.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x03ff, NULL, HFILL\r\n} },\r\n{ &hf_eiss_irl_string, {\r\n"Initial Resource Locator String", "eiss.aid.irl.string",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_mtd_time_value, {\r\n"Time Value (ms)", "eiss.mtd.time_value",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_eiss_sed_reserved, {\r\n"Reserved", "eiss.sed.reserved",\r\nFT_UINT16, BASE_DEC, NULL, 0xf000, NULL, HFILL\r\n} },\r\n{ &hf_eiss_sed_descriptor_length, {\r\n"Descriptor Length", "eiss.desc.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0fff, NULL, HFILL\r\n} },\r\n{ &hf_eiss_sed_time_value, {\r\n"Time Value (ms)", "eiss.sed.time_value",\r\nFT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL\r\n} }\r\n};\r\nstatic gint *ett[] = {\r\n&ett_eiss,\r\n&ett_eiss_platform_id,\r\n&ett_eiss_desc,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_eiss_unknown_descriptor, { "eiss.unknown_descriptor", PI_MALFORMED, PI_ERROR, "Unknown Descriptor", EXPFILL }},\r\n{ &ei_eiss_invalid_section_syntax_indicator, { "eiss.invalid_section_syntax_indicator", PI_MALFORMED, PI_ERROR, "Invalid section_syntax_indicator (should be 0)", EXPFILL }},\r\n{ &ei_eiss_invalid_reserved_bits, { "eiss.invalid_reserved_bits", PI_MALFORMED, PI_ERROR, "Invalid reserved bits", EXPFILL }},\r\n{ &ei_eiss_invalid_section_length, { "eiss.invalid_section_length", PI_MALFORMED, PI_ERROR, "Invalid section_length (must not exceed 1021)", EXPFILL }},\r\n{ &ei_eiss_section_number, { "eiss.sect_num.invalid", PI_MALFORMED, PI_ERROR, "Invalid section_number (must be <= last_section_number)", EXPFILL }},\r\n{ &ei_eiss_application_type, { "eiss.app_type.invalid", PI_MALFORMED, PI_ERROR, "Invalid application_type (must be 0x0008)", EXPFILL }},\r\n{ &ei_eiss_platform_id_length, { "eiss.platform_id_length.invalid", PI_MALFORMED, PI_ERROR, "Invalid platform_id_length (must be a multiple of sizeof(etv_bif_platform_ids) == 15)", EXPFILL }},\r\n};\r\nexpert_module_t* expert_eiss;\r\nproto_eiss = proto_register_protocol("ETV-AM EISS Section", "ETV-AM EISS", "eiss");\r\nproto_register_field_array(proto_eiss, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_eiss = expert_register_protocol(proto_eiss);\r\nexpert_register_field_array(expert_eiss, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_eiss(void)\r\n{\r\ndissector_handle_t eiss_handle;\r\neiss_handle = create_dissector_handle(dissect_eiss, proto_eiss);\r\ndissector_add_uint("mpeg_sect.tid", EISS_SECTION_TID, eiss_handle);\r\n}

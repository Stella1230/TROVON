static void\r\ndissect_npmp_acknowledge_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nADD_FIELD_UINT(message_tree, acknowledge_flowid);\r\nADD_FIELD_UINT(message_tree, acknowledge_measurementid);\r\nADD_FIELD_UINT(message_tree, acknowledge_streamid);\r\nADD_FIELD_UINT(message_tree, acknowledge_status);\r\n}\r\nstatic void\r\ndissect_npmp_add_flow_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nguint32 retranstrials;\r\nproto_item* onoffitem;\r\nproto_tree* onofftree;\r\nguint16 onoffevents;\r\nguint32 onoffvalue;\r\nunsigned int i;\r\nADD_FIELD_UINT(message_tree, addflow_flowid);\r\nADD_FIELD_UINT(message_tree, addflow_measurementid);\r\nADD_FIELD_UINT(message_tree, addflow_streamid);\r\nADD_FIELD_UINT(message_tree, addflow_protocol);\r\nADD_FIELD_UINT(message_tree, addflow_flags);\r\nADD_FIELD_STRING(message_tree, addflow_description);\r\nproto_tree_add_double_format_value(message_tree, hf_addflow_ordered, message_tvb, offset_addflow_ordered, length_addflow_ordered,\r\n100.0 * tvb_get_ntohl(message_tvb, offset_addflow_ordered) / (double)0xffffffff, "%1.3f%%",\r\n100.0 * tvb_get_ntohl(message_tvb, offset_addflow_ordered) / (double)0xffffffff);\r\nproto_tree_add_double_format_value(message_tree, hf_addflow_reliable, message_tvb, offset_addflow_reliable, length_addflow_reliable,\r\n100.0 * tvb_get_ntohl(message_tvb, offset_addflow_reliable) / (double)0xffffffff, "%1.3f%%",\r\n100.0 * tvb_get_ntohl(message_tvb, offset_addflow_reliable) / (double)0xffffffff);\r\nretranstrials = tvb_get_ntohl(message_tvb, offset_addflow_retranstrials);\r\nproto_tree_add_uint_format_value(message_tree, hf_addflow_retranstrials, message_tvb, offset_addflow_retranstrials, length_addflow_retranstrials,\r\nretranstrials, (retranstrials & (1U << 31)) ? "%u ms" : "%u trials",\r\nretranstrials &~ (1U << 31));\r\nADD_FIELD_UINT(message_tree, addflow_frameraterng);\r\nADD_FIELD_UINT(message_tree, addflow_framerate1);\r\nADD_FIELD_UINT(message_tree, addflow_framerate2);\r\nADD_FIELD_UINT(message_tree, addflow_framerate3);\r\nADD_FIELD_UINT(message_tree, addflow_framerate4);\r\nADD_FIELD_UINT(message_tree, addflow_framesizerng);\r\nADD_FIELD_UINT(message_tree, addflow_framesize1);\r\nADD_FIELD_UINT(message_tree, addflow_framesize2);\r\nADD_FIELD_UINT(message_tree, addflow_framesize3);\r\nADD_FIELD_UINT(message_tree, addflow_framesize4);\r\nADD_FIELD_UINT(message_tree, addflow_rcvbuffersize);\r\nADD_FIELD_UINT(message_tree, addflow_sndbuffersize);\r\nADD_FIELD_UINT(message_tree, addflow_maxmsgsize);\r\nADD_FIELD_UINT(message_tree, addflow_cmt);\r\nADD_FIELD_UINT(message_tree, addflow_ccid);\r\nonoffitem = ADD_FIELD_UINT(message_tree, addflow_onoffevents);\r\nonoffevents = tvb_get_ntohs(message_tvb, offset_addflow_onoffevents);\r\nif (onoffevents > 0) {\r\nonofftree = proto_item_add_subtree(onoffitem, ett_onoffarray);\r\nfor(i = 0;i < onoffevents;i++) {\r\nonoffvalue = tvb_get_ntohl(message_tvb, offset_addflow_onoffeventarray + (int)(sizeof(guint32) * i));\r\nproto_tree_add_uint_format(onofftree, hf_addflow_onoffeventarray, message_tvb,\r\noffset_addflow_onoffeventarray + (int)(sizeof(guint32) * i), (int)sizeof(guint32),\r\nonoffvalue, "%1.3f s: set to %s", onoffvalue / 1000.0, (i & 1) ? "OFF" : "ON");\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_npmp_remove_flow_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nADD_FIELD_UINT(message_tree, removeflow_flowid);\r\nADD_FIELD_UINT(message_tree, removeflow_measurementid);\r\nADD_FIELD_UINT(message_tree, removeflow_streamid);\r\n}\r\nstatic void\r\ndissect_npmp_identify_flow_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nADD_FIELD_UINT(message_tree, identifyflow_magicnumber);\r\nADD_FIELD_UINT(message_tree, identifyflow_flowid);\r\nADD_FIELD_UINT(message_tree, identifyflow_measurementid);\r\nADD_FIELD_UINT(message_tree, identifyflow_streamid);\r\n}\r\nstatic void\r\ndissect_npmp_data_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nconst guint16 message_length = tvb_get_ntohs(message_tvb, offset_message_length);\r\nADD_FIELD_UINT(message_tree, data_flowid);\r\nADD_FIELD_UINT(message_tree, data_measurementid);\r\nADD_FIELD_UINT(message_tree, data_streamid);\r\nADD_FIELD_UINT(message_tree, data_padding);\r\nADD_FIELD_UINT(message_tree, data_frameid);\r\nADD_FIELD_UINT(message_tree, data_packetseqnumber);\r\nADD_FIELD_UINT(message_tree, data_byteseqnumber);\r\nADD_FIELD_UINT(message_tree, data_timestamp);\r\nif (message_length > offset_data_payload) {\r\nproto_tree_add_item(message_tree, hf_data_payload, message_tvb, offset_data_payload, message_length - offset_data_payload, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_npmp_start_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nADD_FIELD_UINT(message_tree, start_measurementid);\r\n}\r\nstatic void\r\ndissect_npmp_stop_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nADD_FIELD_UINT(message_tree, stop_measurementid);\r\n}\r\nstatic void\r\ndissect_npmp_results_message(tvbuff_t *message_tvb, proto_tree *message_tree)\r\n{\r\nconst guint16 message_length = tvb_get_guint8(message_tvb, offset_message_length);\r\nif (message_length > offset_results_data) {\r\nproto_tree_add_item(message_tree, hf_results_data, message_tvb, offset_results_data, message_length - offset_results_data, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_npmp_message(tvbuff_t *message_tvb, packet_info *pinfo, proto_tree *npmp_tree)\r\n{\r\nguint8 type;\r\ntype = tvb_get_guint8(message_tvb, offset_message_type);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s ", val_to_str_const(type, message_type_values, "Unknown NetPerfMeterProtocol type"));\r\nADD_FIELD_UINT(npmp_tree, message_type);\r\nADD_FIELD_UINT(npmp_tree, message_flags);\r\nADD_FIELD_UINT(npmp_tree, message_length);\r\nswitch (type) {\r\ncase NETPERFMETER_ACKNOWLEDGE:\r\ndissect_npmp_acknowledge_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_ADD_FLOW:\r\ndissect_npmp_add_flow_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_REMOVE_FLOW:\r\ndissect_npmp_remove_flow_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_IDENTIFY_FLOW:\r\ndissect_npmp_identify_flow_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_DATA:\r\ndissect_npmp_data_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_START:\r\ndissect_npmp_start_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_STOP:\r\ndissect_npmp_stop_message(message_tvb, npmp_tree);\r\nbreak;\r\ncase NETPERFMETER_RESULTS:\r\ndissect_npmp_results_message(message_tvb, npmp_tree);\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_npmp(tvbuff_t *message_tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *npmp_item;\r\nproto_tree *npmp_tree;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "NetPerfMeterProtocol");\r\nif (tree) {\r\nnpmp_item = proto_tree_add_item(tree, proto_npmp, message_tvb, 0, -1, ENC_NA);\r\nnpmp_tree = proto_item_add_subtree(npmp_item, ett_npmp);\r\n} else {\r\nnpmp_tree = NULL;\r\n};\r\ndissect_npmp_message(message_tvb, pinfo, npmp_tree);\r\nreturn(TRUE);\r\n}\r\nvoid\r\nproto_register_npmp(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_npmp,\r\n&ett_onoffarray\r\n};\r\nproto_npmp = proto_register_protocol("NetPerfMeter Protocol", "NetPerfMeterProtocol", "npmp");\r\nproto_register_field_array(proto_npmp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_npmp(void)\r\n{\r\ndissector_handle_t npmp_handle;\r\nnpmp_handle = create_dissector_handle(dissect_npmp, proto_npmp);\r\ndissector_add_uint("sctp.ppi", PPID_NETPERFMETER_CONTROL_LEGACY, npmp_handle);\r\ndissector_add_uint("sctp.ppi", PPID_NETPERFMETER_DATA_LEGACY, npmp_handle);\r\ndissector_add_uint("sctp.ppi", NPMP_CTRL_PAYLOAD_PROTOCOL_ID, npmp_handle);\r\ndissector_add_uint("sctp.ppi", NPMP_DATA_PAYLOAD_PROTOCOL_ID, npmp_handle);\r\n}

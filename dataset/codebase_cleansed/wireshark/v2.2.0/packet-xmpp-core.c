void\r\nxmpp_init_parsers(void)\r\n{\r\ntvbparse_wanted_t *want_name;\r\ntvbparse_wanted_t *want_stream_end;\r\nwant_name = tvbparse_chars(2,1,0,"abcdefghijklmnopqrstuvwxyz.-_ABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789",NULL,NULL,NULL);\r\nwant_stream_end_with_ns = tvbparse_set_seq(3, NULL, NULL, NULL,\r\nwant_name,\r\ntvbparse_char(4, ":", NULL, NULL, NULL),\r\nwant_name,\r\nNULL);\r\nwant_stream_end = tvbparse_set_oneof(5, NULL, NULL, NULL,\r\nwant_stream_end_with_ns,\r\nwant_name,\r\nNULL);\r\nwant_ignore = tvbparse_chars(1,1,0," \t\r\n",NULL,NULL,NULL);\r\nwant_stream_end_tag = tvbparse_set_seq(6, NULL, NULL, NULL,\r\ntvbparse_string(-1,"</",NULL,NULL,NULL),\r\nwant_stream_end,\r\ntvbparse_char(-1,">",NULL,NULL,NULL),\r\nNULL);\r\n}\r\nvoid\r\nxmpp_iq(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *xmpp_iq_item;\r\nproto_tree *xmpp_iq_tree;\r\nxmpp_attr_t *attr_id, *attr_type;\r\nxmpp_attr_info attrs_info[] = {\r\n{"xmlns", &hf_xmpp_xmlns, FALSE, FALSE, NULL, NULL},\r\n{"id", &hf_xmpp_id, TRUE, TRUE, NULL, NULL},\r\n{"type", &hf_xmpp_type, TRUE, TRUE, NULL, NULL},\r\n{"from", &hf_xmpp_from, FALSE, TRUE, NULL, NULL},\r\n{"to", &hf_xmpp_to, FALSE, TRUE, NULL, NULL},\r\n{"xml:lang", NULL, FALSE, FALSE, NULL, NULL}\r\n};\r\nconversation_t *conversation;\r\nxmpp_conv_info_t *xmpp_info;\r\nxmpp_transaction_t *reqresp_trans;\r\nxmpp_elem_info elems_info [] = {\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","http://jabber.org/protocol/disco#items"), xmpp_disco_items_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns", "jabber:iq:roster"), xmpp_roster_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns", "http://jabber.org/protocol/disco#info"), xmpp_disco_info_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns", "http://jabber.org/protocol/bytestreams"), xmpp_bytestreams_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns", "http://jabber.org/protocol/muc#owner"), xmpp_muc_owner_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns", "http://jabber.org/protocol/muc#admin"), xmpp_muc_admin_query, ONE},\r\n{NAME, "bind", xmpp_iq_bind, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("session", "xmlns", "urn:ietf:params:xml:ns:xmpp-session"), xmpp_session, ONE},\r\n{NAME, "vCard", xmpp_vcard, ONE},\r\n{NAME, "jingle", xmpp_jingle, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("services", "xmlns", "http://jabber.org/protocol/jinglenodes"), xmpp_jinglenodes_services, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("channel", "xmlns", "http://jabber.org/protocol/jinglenodes#channel"), xmpp_jinglenodes_channel, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("open", "xmlns", "http://jabber.org/protocol/ibb"), xmpp_ibb_open, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("close", "xmlns", "http://jabber.org/protocol/ibb"), xmpp_ibb_close, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("data", "xmlns", "http://jabber.org/protocol/ibb"), xmpp_ibb_data, ONE},\r\n{NAME, "si", xmpp_si, ONE},\r\n{NAME, "error", xmpp_error, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("session", "xmlns", "http://www.google.com/session"), xmpp_gtalk_session, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","google:jingleinfo"), xmpp_gtalk_jingleinfo_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("usersetting", "xmlns","google:setting"), xmpp_gtalk_usersetting, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","jabber:iq:last"), xmpp_last_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","jabber:iq:version"), xmpp_version_query, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","google:mail:notify"), xmpp_gtalk_mail_query, ONE},\r\n{NAME, "mailbox", xmpp_gtalk_mail_mailbox, ONE},\r\n{NAME, "new-mail", xmpp_gtalk_mail_new_mail, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","google:shared-status"), xmpp_gtalk_status_query, ONE},\r\n{NAME, "conference-info", xmpp_conference_info, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("ping", "xmlns","urn:xmpp:ping"), xmpp_ping, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("inputevt", "xmlns","http://jitsi.org/protocol/inputevt"), xmpp_jitsi_inputevt, ONE},\r\n};\r\nattr_id = xmpp_get_attr(packet, "id");\r\nattr_type = xmpp_get_attr(packet, "type");\r\nconversation = find_or_create_conversation(pinfo);\r\nxmpp_info = (xmpp_conv_info_t *)conversation_get_proto_data(conversation, proto_xmpp);\r\nxmpp_iq_item = proto_tree_add_item(tree, hf_xmpp_iq, tvb, packet->offset, packet->length, ENC_LITTLE_ENDIAN);\r\nxmpp_iq_tree = proto_item_add_subtree(xmpp_iq_item,ett_xmpp_iq);\r\nxmpp_display_attrs(xmpp_iq_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "IQ(%s) ", attr_type?attr_type->value:"");\r\nxmpp_display_elems(xmpp_iq_tree, packet, pinfo, tvb, elems_info, array_length(elems_info));\r\nif(xmpp_info && attr_id)\r\n{\r\ngchar *jingle_sid, *ibb_sid, *gtalk_sid;\r\njingle_sid = (gchar *)wmem_tree_lookup_string(xmpp_info->jingle_sessions, attr_id->value, WMEM_TREE_STRING_NOCASE);\r\nif (jingle_sid) {\r\nproto_item *it = proto_tree_add_string(tree, hf_xmpp_jingle_session, tvb, 0, 0, jingle_sid);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nibb_sid = (gchar *)wmem_tree_lookup_string(xmpp_info->ibb_sessions, attr_id->value, WMEM_TREE_STRING_NOCASE);\r\nif (ibb_sid) {\r\nproto_item *it = proto_tree_add_string(tree, hf_xmpp_ibb, tvb, 0, 0, ibb_sid);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\ngtalk_sid = (gchar *)wmem_tree_lookup_string(xmpp_info->gtalk_sessions, attr_id->value, WMEM_TREE_STRING_NOCASE);\r\nif (gtalk_sid) {\r\nproto_item *it = proto_tree_add_string(tree, hf_xmpp_gtalk, tvb, 0, 0, gtalk_sid);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nreqresp_trans = (xmpp_transaction_t *)wmem_tree_lookup_string(xmpp_info->req_resp, attr_id->value, WMEM_TREE_STRING_NOCASE);\r\nif (reqresp_trans) {\r\nif (reqresp_trans->req_frame == pinfo->num) {\r\nif (reqresp_trans->resp_frame) {\r\nproto_item *it = proto_tree_add_uint(tree, hf_xmpp_response_in, tvb, 0, 0, reqresp_trans->resp_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n} else\r\n{\r\nexpert_add_info(pinfo, xmpp_iq_item, &ei_xmpp_packet_without_response);\r\n}\r\n} else {\r\nif (reqresp_trans->req_frame) {\r\nproto_item *it = proto_tree_add_uint(tree, hf_xmpp_response_to, tvb, 0, 0, reqresp_trans->req_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n} else\r\n{\r\nexpert_add_info(pinfo, xmpp_iq_item, &ei_xmpp_packet_without_response);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nxmpp_error(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *element)\r\n{\r\nproto_item *error_item;\r\nproto_tree *error_tree;\r\nxmpp_element_t *text_element, *cond_element;\r\nxmpp_attr_info attrs_info[] = {\r\n{"type", &hf_xmpp_error_type, TRUE, TRUE, NULL, NULL},\r\n{"code", &hf_xmpp_error_code, FALSE, TRUE, NULL, NULL},\r\n{"condition", &hf_xmpp_error_condition, TRUE, TRUE, NULL, NULL}\r\n};\r\ngchar *error_info;\r\nxmpp_attr_t *fake_condition = NULL;\r\nerror_info = wmem_strdup(wmem_packet_scope(), "Stanza error");\r\nerror_item = proto_tree_add_item(tree, hf_xmpp_error, tvb, element->offset, element->length, ENC_BIG_ENDIAN);\r\nerror_tree = proto_item_add_subtree(error_item, ett_xmpp_query_item);\r\ncond_element = xmpp_steal_element_by_attr(element, "xmlns", "urn:ietf:params:xml:ns:xmpp-stanzas");\r\nif(cond_element)\r\n{\r\nfake_condition = xmpp_ep_init_attr_t(cond_element->name, cond_element->offset, cond_element->length);\r\ng_hash_table_insert(element->attrs, (gpointer)"condition", fake_condition);\r\nerror_info = wmem_strdup_printf(wmem_packet_scope(), "%s: %s;", error_info, cond_element->name);\r\n}\r\nxmpp_display_attrs(error_tree, element, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nwhile((text_element = xmpp_steal_element_by_name(element, "text")) != NULL)\r\n{\r\nxmpp_error_text(error_tree, tvb, text_element);\r\nerror_info = wmem_strdup_printf(wmem_packet_scope(), "%s Text: %s", error_info, text_element->data?text_element->data->value:"");\r\n}\r\nexpert_add_info_format(pinfo, error_item, &ei_xmpp_response, "%s", error_info);\r\nxmpp_unknown(error_tree, tvb, pinfo, element);\r\n}\r\nstatic void\r\nxmpp_error_text(proto_tree *tree, tvbuff_t *tvb, xmpp_element_t *element)\r\n{\r\nproto_tree_add_string(tree, hf_xmpp_error_text, tvb, element->offset, element->length, element->data?element->data->value:"");\r\n}\r\nvoid\r\nxmpp_presence(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *presence_item;\r\nproto_tree *presence_tree;\r\nstatic const gchar *type_enums[] = {"error", "probe", "subscribe", "subscribed",\r\n"unavailable", "unsubscribe", "unsubscribed"};\r\nxmpp_array_t *type_array = xmpp_ep_init_array_t(type_enums, array_length(type_enums));\r\nstatic const gchar *show_enums[] = {"away", "chat", "dnd", "xa"};\r\nxmpp_array_t *show_array = xmpp_ep_init_array_t(show_enums, array_length(show_enums));\r\nxmpp_attr_info attrs_info[] = {\r\n{"from", &hf_xmpp_from, FALSE, FALSE, NULL, NULL},\r\n{"id", &hf_xmpp_id, FALSE, TRUE, NULL, NULL},\r\n{"to", &hf_xmpp_to, FALSE, FALSE, NULL, NULL},\r\n{"type", &hf_xmpp_type, FALSE, TRUE, xmpp_val_enum_list, type_array},\r\n{"xml:lang", NULL, FALSE, FALSE, NULL,NULL},\r\n{"show", &hf_xmpp_presence_show, FALSE, TRUE, xmpp_val_enum_list, show_array},\r\n{"priority", NULL, FALSE, FALSE, NULL, NULL}\r\n};\r\nxmpp_elem_info elems_info[] = {\r\n{NAME, "status", xmpp_presence_status, MANY},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("c","xmlns","http://jabber.org/protocol/caps"), xmpp_presence_caps, ONE},\r\n{NAME, "delay", xmpp_delay, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns", "jabber:x:delay"), xmpp_delay, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns", "vcard-temp:x:update"), xmpp_vcard_x_update, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns","http://jabber.org/protocol/muc"), xmpp_muc_x, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns","http://jabber.org/protocol/muc#user"), xmpp_muc_user_x, ONE},\r\n{NAME, "error", xmpp_error, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("query", "xmlns","jabber:iq:last"), xmpp_last_query, ONE}\r\n};\r\nxmpp_element_t *show, *priority;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "PRESENCE ");\r\npresence_item = proto_tree_add_item(tree, hf_xmpp_presence, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\npresence_tree = proto_item_add_subtree(presence_item, ett_xmpp_presence);\r\nif((show = xmpp_steal_element_by_name(packet, "show"))!=NULL)\r\n{\r\nxmpp_attr_t *fake_show = xmpp_ep_init_attr_t(show->data?show->data->value:"",show->offset, show->length);\r\ng_hash_table_insert(packet->attrs, (gpointer)"show", fake_show);\r\n}\r\nif((priority = xmpp_steal_element_by_name(packet, "priority"))!=NULL)\r\n{\r\nxmpp_attr_t *fake_priority = xmpp_ep_init_attr_t(priority->data?priority->data->value:"",priority->offset, priority->length);\r\ng_hash_table_insert(packet->attrs, (gpointer)"priority", fake_priority);\r\n}\r\nxmpp_display_attrs(presence_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_display_elems(presence_tree, packet, pinfo, tvb, elems_info, array_length(elems_info));\r\n}\r\nstatic void\r\nxmpp_presence_status(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *element)\r\n{\r\nproto_item *status_item;\r\nproto_tree *status_tree;\r\nxmpp_attr_info attrs_info[] = {\r\n{"xml:lang", NULL, FALSE, TRUE, NULL, NULL},\r\n{"value", NULL, TRUE, TRUE, NULL, NULL}\r\n};\r\nxmpp_attr_t *fake_value;\r\nstatus_item = proto_tree_add_item(tree, hf_xmpp_presence_status, tvb, element->offset, element->length, ENC_BIG_ENDIAN);\r\nstatus_tree = proto_item_add_subtree(status_item, ett_xmpp_presence_status);\r\nif(element->data)\r\nfake_value = xmpp_ep_init_attr_t(element->data->value, element->offset, element->length);\r\nelse\r\nfake_value = xmpp_ep_init_attr_t("(empty)", element->offset, element->length);\r\ng_hash_table_insert(element->attrs, (gpointer)"value", fake_value);\r\nxmpp_display_attrs(status_tree, element, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_unknown(status_tree, tvb, pinfo, element);\r\n}\r\nvoid\r\nxmpp_message(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *message_item;\r\nproto_tree *message_tree;\r\nstatic const gchar *type_enums[] = {"chat", "error", "groupchat", "headline", "normal"};\r\nxmpp_array_t *type_array = xmpp_ep_init_array_t(type_enums, array_length(type_enums));\r\nxmpp_attr_info attrs_info[] = {\r\n{"from", &hf_xmpp_from, FALSE, FALSE, NULL, NULL},\r\n{"id", &hf_xmpp_id, FALSE, TRUE, NULL, NULL},\r\n{"to", &hf_xmpp_to, FALSE, FALSE, NULL, NULL},\r\n{"type", &hf_xmpp_type, FALSE, TRUE, xmpp_val_enum_list, type_array},\r\n{"xml:lang", NULL, FALSE, FALSE, NULL,NULL},\r\n{"chatstate", &hf_xmpp_message_chatstate, FALSE, TRUE, NULL, NULL}\r\n};\r\nxmpp_elem_info elems_info [] = {\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("data", "xmlns", "http://jabber.org/protocol/ibb"), xmpp_ibb_data, ONE},\r\n{NAME, "thread", xmpp_message_thread, ONE},\r\n{NAME, "body", xmpp_message_body, MANY},\r\n{NAME, "subject", xmpp_message_subject, MANY},\r\n{NAME, "delay", xmpp_delay, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns","jabber:x:event"), xmpp_x_event, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns","http://jabber.org/protocol/muc#user"), xmpp_muc_user_x, ONE},\r\n{NAME_AND_ATTR, xmpp_name_attr_struct("x","xmlns","google:nosave"), xmpp_gtalk_nosave_x, ONE},\r\n{NAME, "error", xmpp_error, ONE}\r\n};\r\nxmpp_element_t *chatstate;\r\nxmpp_attr_t *id;\r\nconversation_t *conversation;\r\nxmpp_conv_info_t *xmpp_info;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "MESSAGE ");\r\nid = xmpp_get_attr(packet, "id");\r\nconversation = find_or_create_conversation(pinfo);\r\nxmpp_info = (xmpp_conv_info_t *)conversation_get_proto_data(conversation, proto_xmpp);\r\nmessage_item = proto_tree_add_item(tree, hf_xmpp_message, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\nmessage_tree = proto_item_add_subtree(message_item, ett_xmpp_message);\r\nif((chatstate = xmpp_steal_element_by_attr(packet, "xmlns", "http://jabber.org/protocol/chatstates"))!=NULL)\r\n{\r\nxmpp_attr_t *fake_chatstate_attr = xmpp_ep_init_attr_t(chatstate->name, chatstate->offset, chatstate->length);\r\ng_hash_table_insert(packet->attrs, (gpointer)"chatstate", fake_chatstate_attr);\r\n}\r\nxmpp_display_attrs(message_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_display_elems(message_tree, packet, pinfo, tvb, elems_info, array_length(elems_info));\r\nif(xmpp_info && id)\r\n{\r\ngchar *ibb_sid;\r\nibb_sid = (gchar *)wmem_tree_lookup_string(xmpp_info->ibb_sessions, id->value, WMEM_TREE_STRING_NOCASE);\r\nif (ibb_sid) {\r\nproto_item *it = proto_tree_add_string(tree, hf_xmpp_ibb, tvb, 0, 0, ibb_sid);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\n}\r\n}\r\nstatic void\r\nxmpp_message_body(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *element)\r\n{\r\nproto_item *body_item;\r\nproto_tree *body_tree;\r\nxmpp_attr_info attrs_info[] = {\r\n{"xml:lang", NULL, FALSE, TRUE, NULL, NULL},\r\n{"value", NULL, TRUE, TRUE, NULL, NULL}\r\n};\r\nxmpp_attr_t *fake_data_attr;\r\nbody_item = proto_tree_add_item(tree, hf_xmpp_message_body, tvb, element->offset, element->length, ENC_BIG_ENDIAN);\r\nbody_tree = proto_item_add_subtree(body_item, ett_xmpp_message_body);\r\nfake_data_attr = xmpp_ep_init_attr_t(element->data?element->data->value:"", element->offset, element->length);\r\ng_hash_table_insert(element->attrs, (gpointer)"value", fake_data_attr);\r\nxmpp_display_attrs(body_tree, element, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_unknown(body_tree, tvb, pinfo, element);\r\n}\r\nstatic void\r\nxmpp_message_subject(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *element) {\r\nproto_item *subject_item;\r\nproto_tree *subject_tree;\r\nxmpp_attr_info attrs_info[] = {\r\n{"xml:lang", NULL, FALSE, TRUE, NULL, NULL},\r\n{"value", NULL, TRUE, FALSE, NULL, NULL}\r\n};\r\nxmpp_attr_t *fake_data_attr;\r\nsubject_item = proto_tree_add_item(tree, hf_xmpp_message_subject, tvb, element->offset, element->length, ENC_BIG_ENDIAN);\r\nsubject_tree = proto_item_add_subtree(subject_item, ett_xmpp_message_subject);\r\nfake_data_attr = xmpp_ep_init_attr_t(element->data?element->data->value:"", element->offset, element->length);\r\ng_hash_table_insert(element->attrs, (gpointer)"value", fake_data_attr);\r\nxmpp_display_attrs(subject_tree, element, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_unknown(subject_tree, tvb, pinfo, element);\r\n}\r\nstatic void\r\nxmpp_message_thread(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *element)\r\n{\r\nproto_item *thread_item;\r\nproto_tree *thread_tree;\r\nxmpp_attr_info attrs_info[] = {\r\n{"parent", &hf_xmpp_message_thread_parent, FALSE, TRUE, NULL, NULL},\r\n{"value", NULL, TRUE, TRUE, NULL, NULL}\r\n};\r\nxmpp_attr_t *fake_value;\r\nthread_item = proto_tree_add_item(tree, hf_xmpp_message_thread, tvb, element->offset, element->length, ENC_BIG_ENDIAN);\r\nthread_tree = proto_item_add_subtree(thread_item, ett_xmpp_message_thread);\r\nfake_value = xmpp_ep_init_attr_t(element->data?element->data->value:"", element->offset, element->length);\r\ng_hash_table_insert(element->attrs, (gpointer)"value", fake_value);\r\nxmpp_display_attrs(thread_tree, element, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_unknown(thread_tree, tvb, pinfo, element);\r\n}\r\nvoid\r\nxmpp_auth(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *auth_item;\r\nproto_tree *auth_tree;\r\nxmpp_attr_info_ext attrs_info[]={\r\n{"urn:ietf:params:xml:ns:xmpp-sasl", {"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL}},\r\n{"urn:ietf:params:xml:ns:xmpp-sasl", {"mechanism", NULL, TRUE, TRUE, NULL, NULL}},\r\n{"http://www.google.com/talk/protocol/auth", {"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL}},\r\n{"http://www.google.com/talk/protocol/auth", {"client-uses-full-bind-result", NULL, TRUE, TRUE, NULL, NULL}},\r\n};\r\ncol_set_str(pinfo->cinfo, COL_INFO, "AUTH");\r\nauth_item = proto_tree_add_item(tree, hf_xmpp_auth, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\nauth_tree = proto_item_add_subtree(auth_item, ett_xmpp_auth);\r\nxmpp_display_attrs_ext(auth_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_cdata(auth_tree, tvb, packet, -1);\r\nxmpp_unknown(auth_tree, tvb, pinfo, packet);\r\n}\r\nvoid\r\nxmpp_challenge_response_success(proto_tree *tree, tvbuff_t *tvb,\r\npacket_info *pinfo, xmpp_element_t *packet, expert_field* ei, gint ett, const char *col_info)\r\n{\r\nproto_item *item;\r\nproto_tree *subtree;\r\nxmpp_attr_info attrs_info[] = {\r\n{"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL}\r\n};\r\ncol_set_str(pinfo->cinfo, COL_INFO, col_info);\r\nitem = proto_tree_add_expert(tree, pinfo, ei, tvb, packet->offset, packet->length);\r\nsubtree = proto_item_add_subtree(item, ett);\r\nxmpp_display_attrs(subtree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_cdata(subtree, tvb, packet, -1);\r\nxmpp_unknown(subtree, tvb, pinfo, packet);\r\n}\r\nvoid\r\nxmpp_failure(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *fail_item;\r\nproto_tree *fail_tree;\r\nxmpp_attr_info attrs_info[] = {\r\n{"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL},\r\n{"condition", NULL, FALSE, TRUE, NULL, NULL}\r\n};\r\nstatic const gchar *fail_names[] = {"aborted","account-disabled", "credentials-expired",\r\n"encryption-required", "incorrect-encoding", "invalid-authzid", "invalid-mechanism",\r\n"malformed-request", "mechanism-too-weak", "not-authorized", "temporary-auth-failure",\r\n"transition-needed"\r\n};\r\nxmpp_element_t *fail_condition, *text;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "FAILURE ");\r\nfail_item = proto_tree_add_item(tree, hf_xmpp_failure, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\nfail_tree = proto_item_add_subtree(fail_item, ett_xmpp_failure);\r\nif((fail_condition = xmpp_steal_element_by_names(packet, fail_names, array_length(fail_names)))!=NULL)\r\n{\r\nxmpp_attr_t *fake_cond = xmpp_ep_init_attr_t(fail_condition->name, fail_condition->offset, fail_condition->length);\r\ng_hash_table_insert(packet->attrs, (gpointer)"condition", fake_cond);\r\n}\r\nif((text = xmpp_steal_element_by_name(packet, "text"))!=NULL)\r\n{\r\nxmpp_failure_text(fail_tree, tvb, text);\r\n}\r\nxmpp_display_attrs(fail_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_unknown(fail_tree, tvb, pinfo, packet);\r\n}\r\nstatic void\r\nxmpp_failure_text(proto_tree *tree, tvbuff_t *tvb, xmpp_element_t *element)\r\n{\r\nxmpp_attr_t *lang = xmpp_get_attr(element,"xml:lang");\r\nproto_tree_add_string_format(tree, hf_xmpp_failure_text, tvb, element->offset, element->length,\r\nelement->data?element->data->value:"", "TEXT%s: %s",\r\nlang?wmem_strdup_printf(wmem_packet_scope(), "(%s)",lang->value):"",\r\nelement->data?element->data->value:"");\r\n}\r\nvoid\r\nxmpp_xml_header(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo _U_, xmpp_element_t *packet)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "XML ");\r\nproto_tree_add_string(tree, hf_xmpp_xml_header_version, tvb, packet->offset, packet->length, "1.0");\r\n}\r\nvoid\r\nxmpp_stream(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *stream_item;\r\nproto_tree *stream_tree;\r\nxmpp_attr_info_ext attrs_info [] = {\r\n{"http://etherx.jabber.org/streams",{"xmlns", &hf_xmpp_xmlns, FALSE, TRUE, NULL, NULL}},\r\n{"http://etherx.jabber.org/streams",{"version", NULL, FALSE, TRUE, NULL, NULL}},\r\n{"http://etherx.jabber.org/streams",{"from", NULL, FALSE, TRUE, NULL, NULL}},\r\n{"http://etherx.jabber.org/streams",{"to", NULL, FALSE, TRUE, NULL, NULL}},\r\n{"http://etherx.jabber.org/streams",{"id", NULL, FALSE, TRUE, NULL, NULL}},\r\n{"http://etherx.jabber.org/streams",{"xml:lang", NULL, FALSE, TRUE, NULL, NULL}},\r\n{"jabber:client",{"xmlns", &hf_xmpp_xmlns, FALSE, TRUE, NULL, NULL}},\r\n};\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "STREAM ");\r\nstream_item = proto_tree_add_item(tree, hf_xmpp_stream, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\nstream_tree = proto_item_add_subtree(stream_item, ett_xmpp_stream);\r\nxmpp_display_attrs_ext(stream_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_display_elems(stream_tree, packet, pinfo, tvb, NULL, 0);\r\n}\r\ngboolean\r\nxmpp_stream_close(proto_tree *tree, tvbuff_t *tvb, packet_info* pinfo)\r\n{\r\ntvbparse_t *tt;\r\ntvbparse_elem_t *elem;\r\ntt = tvbparse_init(tvb,0,-1,NULL,want_ignore);\r\nif((elem = tvbparse_get(tt,want_stream_end_tag))!=NULL)\r\n{\r\nproto_tree_add_item(tree, hf_xmpp_stream_end, tvb, elem->offset, elem->len, ENC_NA);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "STREAM END");\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nvoid\r\nxmpp_features(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_item *features_item;\r\nproto_tree *features_tree;\r\nxmpp_elem_info elems_info [] = {\r\n{NAME, "mechanisms", xmpp_features_mechanisms, MANY}\r\n};\r\nfeatures_item = proto_tree_add_item(tree, hf_xmpp_features, tvb, packet->offset, packet->length,\r\nENC_BIG_ENDIAN);\r\nfeatures_tree = proto_item_add_subtree(features_item, ett_xmpp_features);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "FEATURES ");\r\nxmpp_display_attrs(features_tree, packet, pinfo, tvb, NULL, 0);\r\nxmpp_display_elems(features_tree, packet, pinfo, tvb, elems_info, array_length(elems_info));\r\n}\r\nstatic void\r\nxmpp_features_mechanisms(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, xmpp_element_t *packet)\r\n{\r\nproto_tree *mechanisms_tree;\r\nxmpp_attr_info attrs_info [] = {\r\n{"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL}\r\n};\r\nxmpp_elem_info elems_info [] = {\r\n{NAME, "mechanism", xmpp_simple_cdata_elem, MANY},\r\n};\r\nmechanisms_tree = proto_tree_add_subtree(tree, tvb, packet->offset, packet->length, ett_xmpp_features_mechanisms, NULL, "MECHANISMS");\r\nxmpp_display_attrs(mechanisms_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_display_elems(mechanisms_tree, packet, pinfo, tvb, elems_info, array_length(elems_info));\r\n}\r\nvoid\r\nxmpp_starttls(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo,\r\nxmpp_element_t *packet, xmpp_conv_info_t *xmpp_info)\r\n{\r\nproto_item *tls_item;\r\nproto_tree *tls_tree;\r\nxmpp_attr_info attrs_info [] = {\r\n{"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL},\r\n};\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "STARTTLS ");\r\ntls_item = proto_tree_add_item(tree, hf_xmpp_starttls, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\ntls_tree = proto_item_add_subtree(tls_item, ett_xmpp_starttls);\r\nif (xmpp_info->ssl_start && xmpp_info->ssl_start != pinfo->num) {\r\nexpert_add_info_format(pinfo, tls_item, &ei_xmpp_starttls_already_in_frame, "Already saw STARTTLS in frame %u", xmpp_info->ssl_start);\r\n}\r\nelse {\r\nxmpp_info->ssl_start = pinfo->num;\r\n}\r\nxmpp_display_attrs(tls_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_display_elems(tls_tree, packet, pinfo, tvb, NULL, 0);\r\n}\r\nvoid\r\nxmpp_proceed(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo,\r\nxmpp_element_t *packet, xmpp_conv_info_t *xmpp_info)\r\n{\r\nproto_item *proceed_item;\r\nproto_tree *proceed_tree;\r\nguint32 ssl_proceed;\r\nxmpp_attr_info attrs_info [] = {\r\n{"xmlns", &hf_xmpp_xmlns, TRUE, TRUE, NULL, NULL},\r\n};\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "PROCEED ");\r\nproceed_item = proto_tree_add_item(tree, hf_xmpp_proceed, tvb, packet->offset, packet->length, ENC_BIG_ENDIAN);\r\nproceed_tree = proto_item_add_subtree(proceed_item, ett_xmpp_proceed);\r\nif (!xmpp_info->ssl_start) {\r\nexpert_add_info(pinfo, proceed_item, &ei_xmpp_starttls_missing);\r\n}\r\nssl_proceed =\r\nssl_starttls_ack(find_dissector("ssl"), pinfo, find_dissector("xmpp"));\r\nif (ssl_proceed > 0 && ssl_proceed != pinfo->num) {\r\nexpert_add_info_format(pinfo, proceed_item, &ei_xmpp_proceed_already_in_frame,\r\n"Already saw PROCEED in frame %u", ssl_proceed);\r\n}\r\nxmpp_display_attrs(proceed_tree, packet, pinfo, tvb, attrs_info, array_length(attrs_info));\r\nxmpp_display_elems(proceed_tree, packet, pinfo, tvb, NULL, 0);\r\n}

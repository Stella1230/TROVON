static proto_item*\r\ndissect_osd_user_object_id(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_item *item;\r\nitem = proto_tree_add_item(tree, hf_scsi_osd_user_object_id, tvb, offset, 8, ENC_NA);\r\nreturn item;\r\n}\r\nstatic void\r\ngeneric_attribute_dissector(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree,\r\nscsi_osd_lun_info_t *lun_info _U_, const attribute_page_numbers_t *att)\r\n{\r\nproto_tree_add_item(tree, *att->hf_index, tvb, 0, att->expected_length, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\npartition_id_attribute_dissector(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nscsi_osd_lun_info_t *lun_info, const attribute_page_numbers_t *att)\r\n{\r\ndissect_osd_partition_id(pinfo, tvb, 0, tree, *att->hf_index, lun_info, FALSE, FALSE);\r\n}\r\nstatic void\r\ndissect_osd2_isolation(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd2_isolation, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd2_list_attr(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd2_list_attr, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nconst attribute_page_numbers_t *\r\nosd_lookup_attribute(guint32 page, guint32 number)\r\n{\r\nconst attribute_pages_t *ap;\r\nconst attribute_page_numbers_t *apn;\r\napn = NULL;\r\nfor (ap=attribute_pages;ap->attributes;ap++) {\r\nif (ap->page == page) {\r\napn = ap->attributes;\r\nbreak;\r\n}\r\n}\r\nif (!apn) return NULL;\r\nfor (;apn->name;apn++) {\r\nif (apn->number == number) {\r\nbreak;\r\n}\r\n}\r\nif (!apn->name) return NULL;\r\nreturn apn;\r\n}\r\nstatic guint32\r\ndissect_osd_attribute_list_entry(packet_info *pinfo, tvbuff_t *tvb,\r\nproto_tree *tree, proto_item *item,\r\nguint32 offset, scsi_osd_lun_info_t *lun_info,\r\ngboolean osd2)\r\n{\r\nguint16 attribute_length;\r\nguint32 page, number;\r\nconst attribute_page_numbers_t *apn;\r\npage = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_scsi_osd_attributes_page, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nnumber = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_scsi_osd_attribute_number, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nif (osd2) {\r\noffset += 6;\r\n}\r\nattribute_length = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_scsi_osd_attribute_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_item_append_text(item, " 0x%08x (%s)", page, val_to_str_ext_const(page, &attributes_page_vals_ext, "Unknown"));\r\nproto_item_append_text(item, " 0x%08x", number);\r\napn= osd_lookup_attribute(page, number);\r\nif (!apn) {\r\nexpert_add_info(pinfo, item, &ei_osd_attr_unknown);\r\nproto_item_append_text(item, " (Unknown)");\r\n} else {\r\nproto_item_append_text(item, " (%s)", apn->name);\r\nif (attribute_length) {\r\nif (attribute_length != apn->expected_length) {\r\nproto_tree_add_expert_format(tree, pinfo, &ei_osd_attr_length_invalid,\r\ntvb, 0, attribute_length, "%s", apn->name);\r\n} else {\r\ntvbuff_t *next_tvb = tvb_new_subset_length(tvb, offset, attribute_length);\r\napn->dissector(next_tvb, pinfo, tree, lun_info, apn);\r\n}\r\n}\r\n}\r\noffset += attribute_length;\r\nif (osd2 && (attribute_length&7)) {\r\noffset += 8-(attribute_length&7);\r\n}\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_attributes_list(packet_info *pinfo, tvbuff_t *tvb, int offset,\r\nproto_tree *tree, scsi_osd_lun_info_t *lun_info,\r\ngboolean osd2)\r\n{\r\nguint8 type;\r\nguint32 length;\r\nguint32 page, number;\r\nint start_offset = offset;\r\nproto_item *item, *list_type_item;\r\nconst attribute_page_numbers_t *apn;\r\ntype = tvb_get_guint8(tvb, offset)&0x0f;\r\nlist_type_item = proto_tree_add_item(tree, hf_scsi_osd_attributes_list_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += (osd2?3:1);\r\nif (osd2) {\r\nlength = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_scsi_osd2_attributes_list_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n} else {\r\nlength = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_scsi_osd_attributes_list_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nif (!osd2 && type == 1) {\r\nlength = tvb_reported_length_remaining(tvb, offset);\r\n}\r\nlength += (osd2?8:4);\r\nwhile ( (guint32)(offset-start_offset)<length ) {\r\nproto_item *ti;\r\nproto_tree *tt;\r\nguint32 attribute_entry_length;\r\nswitch (type) {\r\ncase 0x01:\r\nattribute_entry_length = 8;\r\nbreak;\r\ncase 0x0f:\r\nattribute_entry_length = 18+tvb_get_ntohs(tvb, offset+16);\r\nbreak;\r\ncase 0x09:\r\nif (osd2) {\r\nattribute_entry_length = 16+tvb_get_ntohs(tvb, offset+14);\r\n} else {\r\nattribute_entry_length = 10+tvb_get_ntohs(tvb, offset+8);\r\n}\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, list_type_item, &ei_osd_unknown_attributes_list_type);\r\nreturn;\r\n}\r\nif ((guint32)(offset-start_offset)+attribute_entry_length>length) break;\r\ntt = proto_tree_add_subtree(tree, tvb, offset, attribute_entry_length, ett_osd_attribute, &ti, "Attribute:");\r\nswitch (type) {\r\ncase 0x01:\r\npage = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tt, hf_scsi_osd_attributes_page, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nnumber = tvb_get_ntohl(tvb, offset);\r\nitem = proto_tree_add_item(tt, hf_scsi_osd_attribute_number, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(ti, " 0x%08x (%s)", page, val_to_str_ext_const(page, &attributes_page_vals_ext, "Unknown"));\r\nproto_item_append_text(ti, " 0x%08x", number);\r\napn = osd_lookup_attribute(page, number);\r\nif (!apn) {\r\nproto_item_append_text(ti, " (Unknown)");\r\nproto_item_append_text(item, " (Unknown)");\r\n} else {\r\nproto_item_append_text(ti, " (%s)", apn->name);\r\nproto_item_append_text(item, " (%s)", apn->name);\r\n}\r\nbreak;\r\ncase 0x0f:\r\ndissect_osd_user_object_id(tvb, offset, tt);\r\noffset += 8;\r\ncase 0x09:\r\noffset = dissect_osd_attribute_list_entry(pinfo, tvb, tt, ti, offset, lun_info, osd2);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_osd_option(tvbuff_t *tvb, int offset, proto_tree *parent_tree)\r\n{\r\nproto_tree *tree;\r\nproto_item *it;\r\nguint8 option;\r\noption = tvb_get_guint8(tvb, offset);\r\nit = proto_tree_add_item(parent_tree, hf_scsi_osd_option, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ntree = proto_item_add_subtree(it, ett_osd_option);\r\nproto_tree_add_item(tree, hf_scsi_osd_option_dpo, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (option&0x10) {\r\nproto_item_append_text(tree, " DPO");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_option_fua, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (option&0x08) {\r\nproto_item_append_text(tree, " FUA");\r\n}\r\n}\r\nstatic void\r\ndissect_osd_getsetattrib(tvbuff_t *tvb, int offset, proto_tree *tree, scsi_task_data_t *cdata)\r\n{\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nscsi_osd_extra_data_t *extra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\nextra_data->gsatype = (tvb_get_guint8(tvb, offset)>>4)&0x03;\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_getsetattrib, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd_timestamps_control(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_timestamps_control, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd_formatted_capacity(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_formatted_capacity, tvb, offset, 8, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd_offset(packet_info *pinfo, tvbuff_t *tvb, int offset,\r\nproto_tree *tree, int field, guint32 *raw_value_ptr,\r\ngboolean osd2)\r\n{\r\nguint32 value = *raw_value_ptr;\r\nif (value != 0xFFFFFFFF) {\r\nif (!osd2) {\r\nvalue = (value & 0x0fffffff) << ((value>>28) & 0x0f);\r\nvalue <<= 8;\r\n} else {\r\nint exponent = (value>>28);\r\nguint32 mantissa = (value&0x0FFFFFFF);\r\nif (exponent&0x8) {\r\nexponent = -(((~exponent)&7)+1);\r\nif (exponent <=- 6 && mantissa != 0xFFFFFFF) {\r\nproto_item *item;\r\nitem = proto_tree_add_item(tree, field, tvb, offset, 4, value);\r\nexpert_add_info(pinfo, item, &ei_osd2_invalid_offset);\r\n*raw_value_ptr = 0xFFFFFFFF;\r\nreturn;\r\n}\r\n}\r\nvalue = mantissa << (exponent+8);\r\n}\r\n}\r\nproto_tree_add_uint(tree, field, tvb, offset, 4, value);\r\n*raw_value_ptr = value;\r\n}\r\nstatic int\r\ndissect_osd_attribute_parameters(packet_info *pinfo, tvbuff_t *tvb, int offset, proto_tree *parent_tree, scsi_task_data_t *cdata)\r\n{\r\nguint8 gsatype = 0;\r\nproto_tree *tree;\r\nscsi_osd_extra_data_t *extra_data = NULL;\r\ngboolean osd2;\r\ntree = proto_tree_add_subtree(parent_tree, tvb, offset, 28,\r\nett_osd_attribute_parameters, NULL, "Attribute Parameters");\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nextra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\ngsatype = extra_data->gsatype;\r\nosd2 = extra_data->osd2;\r\n} else {\r\nreturn offset;\r\n}\r\nswitch (gsatype) {\r\ncase 1:\r\nif (osd2) {\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attributes_page, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attribute_number, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attribute_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd2_set_attribute_value, tvb, offset, 18, ENC_NA);\r\noffset += 18;\r\n}\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(tree, hf_scsi_osd_get_attributes_page, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_get_attributes_allocation_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_retrieved_attributes_offset, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attributes_page, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attribute_number, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attribute_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attributes_offset, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(tree, hf_scsi_osd_get_attributes_list_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nextra_data->u.al.get_list_length = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nextra_data->u.al.get_list_offset = tvb_get_ntohl(tvb, offset);\r\ndissect_osd_offset(pinfo, tvb, offset, tree, hf_scsi_osd_get_attributes_list_offset,\r\n&extra_data->u.al.get_list_offset, osd2);\r\nif (extra_data->u.al.get_list_offset == 0xFFFFFFFF) {\r\nextra_data->u.al.get_list_length = 0;\r\n}\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_get_attributes_allocation_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nextra_data->u.al.get_list_allocation_length = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nextra_data->u.al.retrieved_list_offset = tvb_get_ntohl(tvb, offset);\r\ndissect_osd_offset(pinfo, tvb, offset, tree, hf_scsi_osd_retrieved_attributes_offset,\r\n&extra_data->u.al.retrieved_list_offset, osd2);\r\nif (extra_data->u.al.retrieved_list_offset == 0xFFFFFFFF) {\r\nextra_data->u.al.get_list_allocation_length = 0;\r\n}\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_set_attributes_list_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nextra_data->u.al.set_list_length = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nextra_data->u.al.set_list_offset = tvb_get_ntohl(tvb, offset);\r\ndissect_osd_offset(pinfo, tvb, offset, tree, hf_scsi_osd_set_attributes_list_offset,\r\n&extra_data->u.al.set_list_offset, osd2);\r\nif (extra_data->u.al.set_list_offset == 0xFFFFFFFF) {\r\nextra_data->u.al.set_list_length = 0;\r\n}\r\noffset += 4;\r\noffset += 4;\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_attribute_data_out(packet_info *pinfo, tvbuff_t *tvb, int offset _U_,\r\nproto_tree *tree, scsi_task_data_t *cdata,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nguint8 gsatype = 0;\r\nproto_tree *subtree;\r\nscsi_osd_extra_data_t *extra_data = NULL;\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nextra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\ngsatype = extra_data->gsatype;\r\n} else {\r\nreturn;\r\n}\r\nswitch (gsatype) {\r\ncase 2:\r\nbreak;\r\ncase 3:\r\nif (extra_data->u.al.get_list_length) {\r\nsubtree = proto_tree_add_subtree(tree, tvb, extra_data->u.al.get_list_offset, extra_data->u.al.get_list_length,\r\nett_osd_get_attributes, NULL, "Get Attributes Segment");\r\ndissect_osd_attributes_list(pinfo, tvb, extra_data->u.al.get_list_offset, subtree, lun_info, extra_data->osd2);\r\n}\r\nif (extra_data->u.al.set_list_length) {\r\nsubtree = proto_tree_add_subtree(tree, tvb, extra_data->u.al.set_list_offset, extra_data->u.al.set_list_length,\r\nett_osd_get_attributes, NULL, "Set Attributes Segment");\r\ndissect_osd_attributes_list(pinfo, tvb, extra_data->u.al.set_list_offset, subtree, lun_info, extra_data->osd2);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void\r\ndissect_osd_attribute_data_in(packet_info *pinfo, tvbuff_t *tvb, int offset _U_, proto_tree *tree, scsi_task_data_t *cdata, scsi_osd_lun_info_t *lun_info)\r\n{\r\nguint8 gsatype = 0;\r\nscsi_osd_extra_data_t *extra_data = NULL;\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nextra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\ngsatype = extra_data->gsatype;\r\n} else {\r\nreturn;\r\n}\r\nswitch (gsatype) {\r\ncase 2:\r\nbreak;\r\ncase 3:\r\nif (extra_data->u.al.get_list_allocation_length) {\r\ndissect_osd_attributes_list(pinfo, tvb, extra_data->u.al.retrieved_list_offset, tree, lun_info, extra_data->osd2);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void\r\ndissect_osd2_cdb_continuation_length(packet_info *pinfo, tvbuff_t *tvb,\r\nguint32 offset, proto_tree *tree,\r\nscsi_task_data_t *cdata)\r\n{\r\nscsi_osd_extra_data_t *extra_data;\r\nguint32 continuation_length;\r\nproto_item *item;\r\ncontinuation_length = tvb_get_ntohl(tvb, offset);\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_cdb_continuation_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nextra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\nextra_data->continuation_length = continuation_length;\r\n}\r\nif (continuation_length>0 && continuation_length<40) {\r\nexpert_add_info(pinfo, item, &ei_osd2_cdb_continuation_length_invalid);\r\n}\r\n}\r\nstatic void dissect_osd2_query_list_descriptor(packet_info *pinfo, tvbuff_t *tvb, guint32 offset, proto_tree *tree, guint32 length) {\r\nguint32 end = offset+length;\r\nproto_tree_add_item(tree, hf_scsi_osd2_query_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 3;\r\nwhile (offset<end) {\r\nguint32 page, number;\r\nguint32 min_value_length, max_value_length;\r\nguint32 min_value_offset, max_value_offset;\r\nproto_item *item;\r\nconst attribute_page_numbers_t *apn;\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_scsi_osd2_query_entry_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\npage = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_scsi_osd2_query_attributes_page, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nnumber = tvb_get_ntohl(tvb, offset);\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_query_attribute_number, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\napn = osd_lookup_attribute(page, number);\r\nif (!apn) {\r\nexpert_add_info(pinfo, item, &ei_osd_attr_unknown);\r\nproto_item_append_text(item, " (Unknown)");\r\n} else {\r\nproto_item_append_text(item, " (%s)", apn->name);\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd2_query_minimum_attribute_value_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nmin_value_length = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nmax_value_offset = offset;\r\noffset += min_value_length;\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_query_maximum_attribute_value_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nmax_value_length = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nmin_value_offset = offset;\r\noffset += max_value_length;\r\nif (max_value_length == min_value_length) {\r\nunsigned int i;\r\nfor (i=0; i<max_value_length; i++) {\r\nif (tvb_get_guint8(tvb, max_value_offset+i) != tvb_get_guint8(tvb, min_value_offset+i)) return;\r\n}\r\nexpert_add_info(pinfo, item, &ei_osd2_query_values_equal);\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_osd2_cdb_continuation(packet_info *pinfo, tvbuff_t *tvb, guint32 offset,\r\nproto_tree *tree, scsi_task_data_t *cdata)\r\n{\r\nscsi_osd_extra_data_t *extra_data = NULL;\r\nproto_item *item;\r\nguint8 format;\r\nguint16 sa;\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nextra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\n}\r\nif (!extra_data || extra_data->continuation_length<40) return;\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_cdb_continuation_format, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nformat = tvb_get_guint8(tvb, offset);\r\nif (format != 0x01) {\r\nexpert_add_info(pinfo, item, &ei_osd2_cdb_continuation_format_unknown);\r\nreturn;\r\n}\r\noffset += 1;\r\noffset += 1;\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_continued_service_action, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nsa = tvb_get_ntohs(tvb, offset);\r\nif (sa != extra_data->svcaction) {\r\nexpert_add_info(pinfo, item, &ei_osd2_continued_service_action_mismatch);\r\n}\r\noffset += 2;\r\noffset += 36;\r\nwhile (offset<extra_data->continuation_length) {\r\nguint16 type;\r\nguint32 length, padlen;\r\nproto_item *item_type, *item_length;\r\nitem_type= proto_tree_add_item(tree, hf_scsi_osd2_cdb_continuation_descriptor_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ntype = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_scsi_osd2_cdb_continuation_descriptor_pad_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\npadlen = tvb_get_guint8(tvb, offset)&7;\r\noffset += 1;\r\nitem_length = proto_tree_add_item(tree, hf_scsi_osd2_cdb_continuation_descriptor_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nswitch (type) {\r\ncase 0x0000: break;\r\ncase 0x0001: break;\r\ncase 0x0002: dissect_osd2_query_list_descriptor(pinfo, tvb, offset, tree, length);\r\ncase 0x0100: break;\r\ncase 0x0101: break;\r\ncase 0xFFEE: break;\r\ndefault: expert_add_info(pinfo, item_type, &ei_osd2_cdb_continuation_descriptor_type_unknown);\r\n}\r\nif ((length+padlen)%8) {\r\nexpert_add_info(pinfo, item_length, &ei_osd2_cdb_continuation_descriptor_length_invalid);\r\nreturn;\r\n}\r\nif (offset + length + padlen > offset) {\r\noffset += length+padlen;\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_osd_permissions(tvbuff_t *tvb, int offset, proto_tree *parent_tree)\r\n{\r\nproto_tree *tree = NULL;\r\nproto_item *it = NULL;\r\nguint16 permissions;\r\npermissions = tvb_get_ntohs(tvb, offset);\r\nif (parent_tree) {\r\nit = proto_tree_add_item(parent_tree, hf_scsi_osd_permissions, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ntree = proto_item_add_subtree(it, ett_osd_permission_bitmask);\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_read, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x8000) {\r\nproto_item_append_text(tree, " READ");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_write, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x4000) {\r\nproto_item_append_text(tree, " WRITE");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_get_attr, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x2000) {\r\nproto_item_append_text(tree, " GET_ATTR");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_set_attr, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x1000) {\r\nproto_item_append_text(tree, " SET_ATTR");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_create, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0800) {\r\nproto_item_append_text(tree, " CREATE");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_remove, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0400) {\r\nproto_item_append_text(tree, " REMOVE");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_obj_mgmt, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0200) {\r\nproto_item_append_text(tree, " OBJ_MGMT");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_append, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0100) {\r\nproto_item_append_text(tree, " APPEND");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_dev_mgmt, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0080) {\r\nproto_item_append_text(tree, " DEV_MGMT");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_global, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0040) {\r\nproto_item_append_text(tree, " GLOBAL");\r\n}\r\nproto_tree_add_item(tree, hf_scsi_osd_permissions_pol_sec, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nif (permissions&0x0020) {\r\nproto_item_append_text(tree, " POL/SEC");\r\n}\r\n}\r\nstatic void\r\ndissect_osd_capability(tvbuff_t *tvb, int offset, proto_tree *parent_tree)\r\n{\r\nproto_tree *tree;\r\nguint8 format;\r\ntree = proto_tree_add_subtree(parent_tree, tvb, offset, 80,\r\nett_osd_capability, NULL, "Capability");\r\nproto_tree_add_item(tree, hf_scsi_osd_capability_format, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nformat = tvb_get_guint8(tvb, offset)&0x0F;\r\noffset += 1;\r\nif (format != 1) return;\r\nproto_tree_add_item(tree, hf_scsi_osd_key_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_scsi_osd_icva, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_scsi_osd_security_method, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_scsi_osd_capability_expiration_time, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(tree, hf_scsi_osd_audit, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nproto_tree_add_item(tree, hf_scsi_osd_capability_discriminator, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(tree, hf_scsi_osd_object_created_time, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(tree, hf_scsi_osd_object_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ndissect_osd_permissions(tvb, offset, tree);\r\noffset += 5;\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_scsi_osd_object_descriptor_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_scsi_osd_object_descriptor, tvb, offset, 24, ENC_NA);\r\nreturn;\r\n}\r\nstatic int\r\ndissect_osd_security_parameters(tvbuff_t *tvb, int offset, proto_tree *parent_tree)\r\n{\r\nproto_tree *tree;\r\ntree = proto_tree_add_subtree(parent_tree, tvb, offset, 40,\r\nett_osd_security_parameters, NULL, "Security Parameters");\r\nproto_tree_add_item(tree, hf_scsi_osd_ricv, tvb, offset, 20, ENC_NA);\r\noffset += 20;\r\nproto_tree_add_item(tree, hf_scsi_osd_request_nonce, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(tree, hf_scsi_osd_diicvo, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_scsi_osd_doicvo, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_format_osd(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info _U_)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 23;\r\ndissect_osd_formatted_capacity(tvb, offset, tree);\r\noffset += 8;\r\noffset += 8;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic proto_item*\r\ndissect_osd_partition_id(packet_info *pinfo, tvbuff_t *tvb, int offset,\r\nproto_tree *tree, int hf_index,\r\nscsi_osd_lun_info_t *lun_info, gboolean is_created,\r\ngboolean is_removed)\r\n{\r\nproto_item *item = NULL;\r\nguint32 partition_id[2];\r\nitem = proto_tree_add_item(tree, hf_index, tvb, offset, 8, ENC_BIG_ENDIAN);\r\npartition_id[0] = tvb_get_ntohl(tvb, offset);\r\npartition_id[1] = tvb_get_ntohl(tvb, offset+4);\r\nif (!partition_id[0] && !partition_id[1]) {\r\nproto_item_append_text(item, " (ROOT partition)");\r\n} else {\r\npartition_info_t *part_info;\r\nwmem_tree_key_t pikey[2];\r\nproto_tree *partition_tree = NULL;\r\npikey[0].length = 2;\r\npikey[0].key = partition_id;\r\npikey[1].length = 0;\r\npart_info = (partition_info_t *)wmem_tree_lookup32_array(lun_info->partitions, &pikey[0]);\r\nif (!part_info) {\r\npart_info = wmem_new(wmem_file_scope(), partition_info_t);\r\npart_info->created_in = 0;\r\npart_info->removed_in = 0;\r\npikey[0].length = 2;\r\npikey[0].key = partition_id;\r\npikey[1].length = 0;\r\nwmem_tree_insert32_array(lun_info->partitions, &pikey[0], part_info);\r\n}\r\nif (is_created) {\r\npart_info->created_in = pinfo->num;\r\n}\r\nif (is_removed) {\r\npart_info->removed_in = pinfo->num;\r\n}\r\nif (item) {\r\npartition_tree = proto_item_add_subtree(item, ett_osd_partition);\r\n}\r\nif (part_info->created_in) {\r\nproto_item *tmp_item;\r\ntmp_item = proto_tree_add_uint(partition_tree, hf_scsi_osd_partition_created_in, tvb, 0, 0, part_info->created_in);\r\nPROTO_ITEM_SET_GENERATED(tmp_item);\r\n}\r\nif (part_info->removed_in) {\r\nproto_item *tmp_item;\r\ntmp_item = proto_tree_add_uint(partition_tree, hf_scsi_osd_partition_removed_in, tvb, 0, 0, part_info->removed_in);\r\nPROTO_ITEM_SET_GENERATED(tmp_item);\r\n}\r\n}\r\nreturn item;\r\n}\r\nstatic void\r\ndissect_osd_create_partition(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\ngboolean osd2 = ((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->svcaction&0x80;\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = osd2;\r\nif (isreq && iscdb) {\r\nif (osd2) dissect_osd2_isolation(tvb, offset, tree);\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_requested_partition_id, lun_info, TRUE, FALSE);\r\noffset += 8;\r\noffset += 24;\r\nif (osd2) {\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\n} else {\r\n}\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += osd2?104:80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += osd2?52:40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd2_cdb_continuation(pinfo, tvb, offset, tree, cdata);\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic int\r\ndissect_osd_sortorder(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_sortorder, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_osd_list_identifier(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_list_identifier, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_allocation_length(tvbuff_t *tvb, int offset, proto_tree *tree, scsi_task_data_t *cdata)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_allocation_length, tvb, offset, 8, ENC_BIG_ENDIAN);\r\nif (cdata) {\r\nguint64 alloc_len = tvb_get_ntoh64(tvb, offset);\r\nif (alloc_len>G_GINT64_CONSTANT(0xFFFFFFFF)) {\r\nalloc_len = G_GINT64_CONSTANT(0xFFFFFFFF);\r\n}\r\ncdata->itlq->alloc_len = (guint32)alloc_len;\r\n}\r\n}\r\nstatic int\r\ndissect_osd_initial_object_id(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_initial_object_id, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_osd_additional_length(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_additional_length, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_osd_continuation_object_id(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_continuation_object_id, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic proto_item*\r\ndissect_osd_collection_object_id(tvbuff_t *tvb, int offset, proto_tree *tree, const int hfindex)\r\n{\r\nproto_item *item;\r\nitem = proto_tree_add_item(tree, hfindex, tvb, offset, 8, ENC_NA);\r\nreturn item;\r\n}\r\nstatic void\r\ndissect_osd_list(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nguint svcaction = ((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->svcaction;\r\ngboolean list_collection = (svcaction == 0x8817) || (svcaction == 0x8897);\r\ngboolean osd2 = svcaction&0x80;\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = osd2;\r\nif (isreq && iscdb) {\r\nif (osd2) dissect_osd2_isolation(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\nif (!list_collection) dissect_osd_sortorder(tvb, offset, tree);\r\nif (osd2) dissect_osd2_list_attr(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\nif (list_collection) {\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_collection_object_id);\r\n} else {\r\n}\r\noffset += 8;\r\nif (osd2) {\r\ndissect_osd_allocation_length(tvb, offset, tree, cdata);\r\noffset += 8;\r\ndissect_osd_initial_object_id(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_list_identifier(tvb, offset, tree);\r\noffset += 4;\r\n} else {\r\ndissect_osd_list_identifier(tvb, offset, tree);\r\noffset += 4;\r\ndissect_osd_allocation_length(tvb, offset, tree, cdata);\r\noffset += 8;\r\ndissect_osd_initial_object_id(tvb, offset, tree);\r\noffset += 8;\r\n}\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += osd2?104:80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += osd2?52:40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\nguint64 additional_length;\r\nguint64 allocation_length;\r\nguint64 remaining_length;\r\ngboolean is_root_or_coltn;\r\nguint8 format = 0;\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\nallocation_length = cdata->itlq->alloc_len;\r\nremaining_length = tvb_captured_length_remaining(tvb, offset);\r\nif (remaining_length<allocation_length) allocation_length = remaining_length;\r\nif (allocation_length<24) return;\r\nadditional_length = tvb_get_ntoh64(tvb, offset);\r\nif (allocation_length<additional_length) additional_length = allocation_length;\r\ndissect_osd_additional_length(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_continuation_object_id(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_list_identifier(tvb, offset, tree);\r\noffset += 4;\r\noffset += 3;\r\nproto_tree_add_item(tree, hf_scsi_osd_list_flags_lstchg, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (osd2) {\r\nproto_item *item;\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_object_descriptor_format, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nformat = tvb_get_guint8(tvb, offset)>>2;\r\nif (format == 0x01 || format == 0x02) {\r\nis_root_or_coltn = TRUE;\r\nif (list_collection) format = 0;\r\n} else if (format == 0x11 || format == 0x12) {\r\nis_root_or_coltn = TRUE;\r\nif (!list_collection) format = 0;\r\n} else if (format == 0x21 || format == 0x22) {\r\nis_root_or_coltn = FALSE;\r\n} else format = 0;\r\nif (!format) {\r\nexpert_add_info(pinfo, item, &ei_osd2_invalid_object_descriptor_format);\r\nreturn;\r\n}\r\n} else {\r\nif (list_collection) {\r\nproto_tree_add_item(tree, hf_scsi_osd_list_collection_flags_coltn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n} else {\r\nproto_tree_add_item(tree, hf_scsi_osd_list_flags_root, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nis_root_or_coltn = tvb_get_guint8(tvb, offset)&0x01;\r\n}\r\noffset += 1;\r\nwhile (additional_length > (offset-8)) {\r\nproto_item *ti;\r\nif (is_root_or_coltn) {\r\nif (list_collection) {\r\nti = dissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_collection_object_id);\r\n} else {\r\nti = dissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\n}\r\n} else {\r\nti = dissect_osd_user_object_id(tvb, offset, tree);\r\n}\r\noffset += 8;\r\nif (osd2 && (format&0x02)) {\r\nguint32 attr_list_end;\r\nproto_tree *subtree;\r\nif (offset+8>additional_length) break;\r\nsubtree = proto_item_add_subtree(ti, ett_osd_multi_object);\r\nproto_tree_add_item(subtree, hf_scsi_osd_object_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 5;\r\nattr_list_end = offset+2+tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nif (attr_list_end>additional_length+8) break;\r\nwhile (offset+16<attr_list_end) {\r\nguint32 attribute_length = tvb_get_ntohs(tvb, offset+14);\r\nproto_item *att_item;\r\nproto_tree *att_tree = proto_tree_add_subtree(subtree, tvb, offset, 16+attribute_length, ett_osd_attribute, &att_item, "Attribute:");\r\noffset = dissect_osd_attribute_list_entry(pinfo, tvb, att_tree, att_item, offset, lun_info, TRUE);\r\n}\r\noffset = attr_list_end;\r\n}\r\n}\r\n}\r\n}\r\nstatic int\r\ndissect_osd_requested_user_object_id(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_requested_user_object_id, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_osd_number_of_user_objects(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_number_of_user_objects, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_create(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_requested_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 4;\r\ndissect_osd_number_of_user_objects(tvb, offset, tree);\r\noffset += 2;\r\noffset += 14;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_remove_partition(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\ngboolean osd2 = ((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->svcaction&0x80;\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = osd2;\r\nif (isreq && iscdb) {\r\nif (osd2) dissect_osd2_isolation(tvb, offset, tree);\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\nif (osd2) proto_tree_add_item(tree, hf_scsi_osd2_remove_scope, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, TRUE);\r\noffset += 8;\r\noffset += 24;\r\nif (osd2) {\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\n} else {\r\n}\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += osd2?104:80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += osd2?52:40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd2_cdb_continuation(pinfo, tvb, offset, tree, cdata);\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_key_to_set(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_key_to_set, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd_set_key_version(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_set_key_version, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd_key_identifier(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_key_identifier, tvb, offset, 7, ENC_NA);\r\n}\r\nstatic void\r\ndissect_osd_seed(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_seed, tvb, offset, 20, ENC_NA);\r\n}\r\nstatic void\r\ndissect_osd_set_key(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\ndissect_osd_key_to_set(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_set_key_version(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_key_identifier(tvb, offset, tree);\r\noffset += 7;\r\ndissect_osd_seed(tvb, offset, tree);\r\noffset += 20;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_remove(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 20;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_collection_fcr(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_collection_fcr, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_osd_remove_collection(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\ngboolean osd2 = ((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->svcaction&0x80;\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = osd2;\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\ndissect_osd_collection_fcr(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_collection_object_id);\r\noffset += 8;\r\noffset += 16;\r\nif (osd2) {\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\n} else {\r\n}\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += osd2?104:80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += osd2?52:40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd2_cdb_continuation(pinfo, tvb, offset, tree, cdata);\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic int\r\ndissect_osd_length(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_length, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_osd_starting_byte_address(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_starting_byte_address, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_write(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 4;\r\ndissect_osd_length(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_starting_byte_address(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_create_collection(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\ndissect_osd_collection_fcr(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_requested_collection_object_id);\r\noffset += 8;\r\noffset += 20;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic int\r\ndissect_osd_flush_scope(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_flush_scope, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_flush(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_flush_scope(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 20;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic int\r\ndissect_osd_flush_collection_scope(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_flush_collection_scope, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_flush_collection(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_flush_collection_scope(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\ndissect_osd_collection_fcr(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_collection_object_id);\r\noffset += 8;\r\noffset += 20;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_append(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 4;\r\ndissect_osd_length(tvb, offset, tree);\r\noffset += 8;\r\noffset += 8;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_create_and_write(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_requested_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 4;\r\ndissect_osd_length(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_starting_byte_address(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic int\r\ndissect_osd_flush_osd_scope(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_flush_osd_scope, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_flush_osd(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info _U_)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_flush_osd_scope(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 39;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic int\r\ndissect_osd_flush_partition_scope(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_scsi_osd_flush_partition_scope, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_osd_flush_partition(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_flush_partition_scope(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\noffset += 28;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_get_attributes(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\ngboolean osd2 = ((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->svcaction&0x80;\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = osd2;\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 16;\r\nif (osd2) {\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\n} else {\r\n}\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += osd2?104:80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += osd2?52:40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_read(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 4;\r\ndissect_osd_length(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_starting_byte_address(tvb, offset, tree);\r\noffset += 8;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd_set_attributes(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\ngboolean osd2 = ((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->svcaction&0x80;\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = osd2;\r\nif (isreq && iscdb) {\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\noffset += 16;\r\nif (osd2) {\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\n} else {\r\n}\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += osd2?104:80;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += osd2?52:40;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd2_create_user_tracking_collection(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = TRUE;\r\nif (isreq && iscdb) {\r\ndissect_osd2_isolation(tvb, offset, tree);\r\ndissect_osd_option(tvb, offset, tree);\r\noffset += 1;\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_requested_collection_object_id);\r\noffset += 8;\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd2_source_collection_object_id);\r\noffset += 8;\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 104;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 52;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd2_cdb_continuation(pinfo, tvb, offset, tree, cdata);\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\n}\r\nstatic void\r\ndissect_osd2_query(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len _U_, scsi_task_data_t *cdata _U_,\r\nscsi_osd_conv_info_t *conv_info _U_,\r\nscsi_osd_lun_info_t *lun_info)\r\n{\r\n((scsi_osd_extra_data_t *)cdata->itlq->extra_data)->osd2 = TRUE;\r\nif (isreq && iscdb) {\r\ndissect_osd2_isolation(tvb, offset, tree);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_scsi_osd2_immed_tr, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndissect_osd_getsetattrib(tvb, offset, tree, cdata);\r\noffset += 1;\r\ndissect_osd_timestamps_control(tvb, offset, tree);\r\noffset += 1;\r\noffset += 3;\r\ndissect_osd_partition_id(pinfo, tvb, offset, tree, hf_scsi_osd_partition_id, lun_info, FALSE, FALSE);\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd_collection_object_id);\r\noffset += 8;\r\ndissect_osd_allocation_length(tvb, offset, tree, cdata);\r\noffset += 8;\r\ndissect_osd_collection_object_id(tvb, offset, tree, hf_scsi_osd2_matches_collection_object_id);\r\noffset += 8;\r\ndissect_osd2_cdb_continuation_length(pinfo, tvb, offset, tree, cdata);\r\noffset += 4;\r\ndissect_osd_attribute_parameters(pinfo, tvb, offset, tree, cdata);\r\noffset += 28;\r\ndissect_osd_capability(tvb, offset, tree);\r\noffset += 104;\r\ndissect_osd_security_parameters(tvb, offset, tree);\r\noffset += 52;\r\n}\r\nif (isreq && !iscdb) {\r\ndissect_osd2_cdb_continuation(pinfo, tvb, offset, tree, cdata);\r\ndissect_osd_attribute_data_out(pinfo, tvb, offset, tree, cdata, lun_info);\r\n}\r\nif (!isreq && !iscdb) {\r\nguint64 additional_length;\r\nguint64 allocation_length;\r\nguint64 remaining_length;\r\nguint8 format;\r\nproto_item *item;\r\ndissect_osd_attribute_data_in(pinfo, tvb, offset, tree, cdata, lun_info);\r\nallocation_length = cdata->itlq->alloc_len;\r\nremaining_length = tvb_captured_length_remaining(tvb, offset);\r\nif (remaining_length<allocation_length) allocation_length = remaining_length;\r\nif (allocation_length<12) return;\r\nadditional_length = tvb_get_ntoh64(tvb, offset);\r\nif ((guint32)(allocation_length-8)<additional_length) additional_length = (guint32)(allocation_length-8);\r\ndissect_osd_additional_length(tvb, offset, tree);\r\noffset += 8;\r\noffset += 3;\r\nitem = proto_tree_add_item(tree, hf_scsi_osd2_object_descriptor_format, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nformat = tvb_get_guint8(tvb, offset)>>2;\r\noffset += 1;\r\nif (format != 0x21) {\r\nexpert_add_info(pinfo, item, &ei_osd2_invalid_object_descriptor_format);\r\nreturn;\r\n}\r\nwhile (additional_length > (offset-4)) {\r\ndissect_osd_user_object_id(tvb, offset, tree);\r\noffset += 8;\r\n}\r\n}\r\n}\r\nstatic scsi_osd_dissector_t\r\nfind_svcaction_dissector(guint16 svcaction)\r\n{\r\nconst scsi_osd_svcaction_t *sa = scsi_osd_svcaction;\r\nwhile (sa && sa->dissector) {\r\nif (sa->svcaction == svcaction) {\r\nreturn sa->dissector;\r\n}\r\nsa++;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void\r\ndissect_osd_opcode(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint offset, gboolean isreq, gboolean iscdb,\r\nguint payload_len, scsi_task_data_t *cdata)\r\n{\r\nguint16 svcaction = 0;\r\nscsi_osd_dissector_t dissector;\r\nscsi_osd_conv_info_t *conv_info;\r\nscsi_osd_lun_info_t *lun_info;\r\nif (!tree) {\r\nreturn;\r\n}\r\nif (!cdata || !cdata->itl || !cdata->itl->conversation || !cdata->itlq) {\r\nreturn;\r\n}\r\nconv_info = (scsi_osd_conv_info_t *)conversation_get_proto_data(cdata->itl->conversation, proto_scsi_osd);\r\nif (!conv_info) {\r\nconv_info = wmem_new(wmem_file_scope(), scsi_osd_conv_info_t);\r\nconv_info->luns = wmem_tree_new(wmem_file_scope());\r\nconversation_add_proto_data(cdata->itl->conversation, proto_scsi_osd, conv_info);\r\n}\r\nlun_info = (scsi_osd_lun_info_t *)wmem_tree_lookup32(conv_info->luns, cdata->itlq->lun);\r\nif (!lun_info) {\r\nlun_info = wmem_new(wmem_file_scope(), scsi_osd_lun_info_t);\r\nlun_info->partitions = wmem_tree_new(wmem_file_scope());\r\nwmem_tree_insert32(conv_info->luns, cdata->itlq->lun, (void *)lun_info);\r\n}\r\nif (isreq && iscdb) {\r\nproto_tree_add_item (tree, hf_scsi_control, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 5;\r\nproto_tree_add_item (tree, hf_scsi_osd_add_cdblen, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nsvcaction = tvb_get_ntohs(tvb, offset);\r\nif (cdata && cdata->itlq) {\r\nif ((!pinfo->fd->flags.visited) || (!cdata->itlq->extra_data)) {\r\nscsi_osd_extra_data_t *extra_data;\r\nextra_data = wmem_new0(wmem_file_scope(), scsi_osd_extra_data_t);\r\nextra_data->svcaction = svcaction;\r\ncdata->itlq->extra_data = extra_data;\r\n}\r\n}\r\nproto_tree_add_item (tree, hf_scsi_osd_svcaction, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_ext_const(svcaction, &scsi_osd_svcaction_vals_ext, "Unknown OSD Service Action"));\r\ndissector = find_svcaction_dissector(svcaction);\r\nif (dissector) {\r\n(*dissector)(tvb, pinfo, tree, offset, isreq, iscdb, payload_len, cdata, conv_info, lun_info);\r\n}\r\nreturn;\r\n}\r\nif (cdata && cdata->itlq && cdata->itlq->extra_data) {\r\nscsi_osd_extra_data_t *extra_data = (scsi_osd_extra_data_t *)cdata->itlq->extra_data;\r\nsvcaction = extra_data->svcaction;\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\nval_to_str_ext_const(svcaction, &scsi_osd_svcaction_vals_ext, "Unknown OSD Service Action"));\r\nif (svcaction) {\r\nproto_item *it;\r\nit = proto_tree_add_uint_format_value(tree, hf_scsi_osd_svcaction, tvb, 0, 0, svcaction, "0x%04x", svcaction);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\ndissector = find_svcaction_dissector(svcaction);\r\nif (dissector) {\r\n(*dissector)(tvb, pinfo, tree, offset, isreq, iscdb, payload_len, cdata, conv_info, lun_info);\r\n}\r\n}\r\nvoid\r\nproto_register_scsi_osd(void)\r\n{\r\nexpert_module_t *expert_scsi_osd;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_scsi_osd_opcode,\r\n{"OSD Opcode", "scsi_osd.opcode", FT_UINT8, BASE_HEX | BASE_EXT_STRING,\r\n&scsi_osd_vals_ext, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_add_cdblen,\r\n{"Additional CDB Length", "scsi_osd.addcdblen", FT_UINT8, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_svcaction,\r\n{"Service Action", "scsi_osd.svcaction", FT_UINT16, BASE_HEX | BASE_EXT_STRING,\r\n&scsi_osd_svcaction_vals_ext, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_option,\r\n{"Options Byte", "scsi_osd.option", FT_UINT8, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_option_dpo,\r\n{"DPO", "scsi_osd.option.dpo", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), 0x10, NULL, HFILL}},\r\n{ &hf_scsi_osd_option_fua,\r\n{"FUA", "scsi_osd.option.fua", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), 0x08, NULL, HFILL}},\r\n{ &hf_scsi_osd_getsetattrib,\r\n{"GET/SET CDBFMT", "scsi_osd.getset", FT_UINT8, BASE_HEX,\r\nVALS(scsi_osd_getsetattrib_vals), 0x30, NULL, HFILL}},\r\n{ &hf_scsi_osd_timestamps_control,\r\n{"Timestamps Control", "scsi_osd.timestamps_control", FT_UINT8, BASE_HEX,\r\nVALS(scsi_osd_timestamps_control_vals), 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_formatted_capacity,\r\n{"Formatted Capacity", "scsi_osd.formatted_capacity", FT_UINT64, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_get_attributes_page,\r\n{"Get Attributes Page", "scsi_osd.get_attributes_page", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_get_attributes_list_length,\r\n{"Get Attributes List Length", "scsi_osd.get_attributes_list_length", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_get_attributes_list_offset,\r\n{"Get Attributes List Offset", "scsi_osd.get_attributes_list_offset", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_attributes_list_length,\r\n{"Set Attributes List Length", "scsi_osd.set_attributes_list_length", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_attributes_list_offset,\r\n{"Set Attributes List Offset", "scsi_osd.set_attributes_list_offset", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_get_attributes_allocation_length,\r\n{"Get Attributes Allocation Length", "scsi_osd.get_attributes_allocation_length", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_retrieved_attributes_offset,\r\n{"Retrieved Attributes Offset", "scsi_osd.retrieved_attributes_offset", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_attributes_page,\r\n{"Set Attributes Page", "scsi_osd.set_attributes_page", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_attribute_length,\r\n{"Set Attribute Length", "scsi_osd.set_attribute_length", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_attribute_number,\r\n{"Set Attribute Number", "scsi_osd.set_attribute_number", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_attributes_offset,\r\n{"Set Attributes Offset", "scsi_osd.set_attributes_offset", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL}},\r\n{ &hf_scsi_osd_capability_format,\r\n{"Capability Format", "scsi_osd.capability_format", FT_UINT8, BASE_HEX,\r\nVALS(scsi_osd_capability_format_vals), 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd_key_version,\r\n{"Key Version", "scsi_osd.key_version", FT_UINT8, BASE_HEX,\r\nNULL, 0xf0, NULL, HFILL}},\r\n{ &hf_scsi_osd_icva,\r\n{"Integrity Check Value Algorithm", "scsi_osd.icva", FT_UINT8, BASE_HEX,\r\nNULL, 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd_security_method,\r\n{"Security Method", "scsi_osd.security_method", FT_UINT8, BASE_HEX,\r\nNULL, 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd_capability_expiration_time,\r\n{"Capability Expiration Time", "scsi_osd.capability_expiration_time", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_audit,\r\n{"Audit", "scsi_osd.audit", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_capability_discriminator,\r\n{"Capability Discriminator", "scsi_osd.capability_descriminator", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_object_created_time,\r\n{"Object Created Time", "scsi_osd.object_created_time", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_object_type,\r\n{"Object Type", "scsi_osd.object_type", FT_UINT8, BASE_HEX,\r\nVALS(scsi_osd_object_type_vals), 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions,\r\n{"Permissions", "scsi_osd.permissions", FT_UINT16, BASE_HEX,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_read,\r\n{"READ", "scsi_osd.permissions.read", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x8000, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_write,\r\n{"WRITE", "scsi_osd.permissions.write", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x4000, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_get_attr,\r\n{"GET_ATTR", "scsi_osd.permissions.get_attr", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x2000, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_set_attr,\r\n{"SET_ATTR", "scsi_osd.permissions.set_attr", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x1000, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_create,\r\n{"CREATE", "scsi_osd.permissions.create", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0800, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_remove,\r\n{"REMOVE", "scsi_osd.permissions.remove", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0400, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_obj_mgmt,\r\n{"OBJ_MGMT", "scsi_osd.permissions.obj_mgmt", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0200, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_append,\r\n{"APPEND", "scsi_osd.permissions.append", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0100, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_dev_mgmt,\r\n{"DEV_MGMT", "scsi_osd.permissions.dev_mgmt", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0080, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_global,\r\n{"GLOBAL", "scsi_osd.permissions.global", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0040, NULL, HFILL}},\r\n{ &hf_scsi_osd_permissions_pol_sec,\r\n{"POL/SEC", "scsi_osd.permissions.pol_sec", FT_BOOLEAN, 16,\r\nTFS(&tfs_set_notset), 0x0020, NULL, HFILL}},\r\n{ &hf_scsi_osd_object_descriptor_type,\r\n{"Object Descriptor Type", "scsi_osd.object_descriptor_type", FT_UINT8, BASE_HEX,\r\nVALS(scsi_osd_object_descriptor_type_vals), 0xf0, NULL, HFILL}},\r\n{ &hf_scsi_osd_object_descriptor,\r\n{"Object Descriptor", "scsi_osd.object_descriptor", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_ricv,\r\n{"Request Integrity Check value", "scsi_osd.ricv", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_request_nonce,\r\n{"Request Nonce", "scsi_osd.request_nonce", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_diicvo,\r\n{"Data-In Integrity Check Value Offset", "scsi_osd.diicvo", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_doicvo,\r\n{"Data-Out Integrity Check Value Offset", "scsi_osd.doicvo", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_requested_partition_id,\r\n{"Requested Partition Id", "scsi_osd.requested_partition_id", FT_UINT64, BASE_HEX,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_sortorder,\r\n{"Sort Order", "scsi_osd.sort_order", FT_UINT8, BASE_DEC,\r\nVALS(scsi_osd_sort_order_vals), 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd_partition_id,\r\n{"Partition Id", "scsi_osd.partition_id", FT_UINT64, BASE_HEX,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_list_identifier,\r\n{"List Identifier", "scsi_osd.list_identifier", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_allocation_length,\r\n{"Allocation Length", "scsi_osd.allocation_length", FT_UINT64, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_length,\r\n{"Length", "scsi_osd.length", FT_UINT64, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_starting_byte_address,\r\n{"Starting Byte Address", "scsi_osd.starting_byte_address", FT_UINT64, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_initial_object_id,\r\n{"Initial Object Id", "scsi_osd.initial_object_id", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_additional_length,\r\n{"Additional Length", "scsi_osd.additional_length", FT_UINT64, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_continuation_object_id,\r\n{"Continuation Object Id", "scsi_osd.continuation_object_id", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_user_object_id,\r\n{"User Object Id", "scsi_osd.user_object_id", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_list_flags_lstchg,\r\n{"LSTCHG", "scsi_osd.list.lstchg", FT_BOOLEAN, 8,\r\nTFS(&list_lstchg_tfs), 0x02, NULL, HFILL}},\r\n{ &hf_scsi_osd_list_flags_root,\r\n{"ROOT", "scsi_osd.list.root", FT_BOOLEAN, 8,\r\nTFS(&list_root_tfs), 0x01, NULL, HFILL}},\r\n{ &hf_scsi_osd_list_collection_flags_coltn,\r\n{"COLTN", "scsi_osd.list_collection.coltn", FT_BOOLEAN, 8,\r\nTFS(&list_coltn_tfs), 0x01, NULL, HFILL}},\r\n{ &hf_scsi_osd_requested_user_object_id,\r\n{"Requested User Object Id", "scsi_osd.requested_user_object_id", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_number_of_user_objects,\r\n{"Number Of User Objects", "scsi_osd.number_of_user_objects", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_key_to_set,\r\n{"Key to Set", "scsi_osd.key_to_set", FT_UINT8, BASE_DEC,\r\nVALS(key_to_set_vals), 0x03, NULL, HFILL}},\r\n{ &hf_scsi_osd_set_key_version,\r\n{"Key Version", "scsi_osd.set_key_version", FT_UINT8, BASE_DEC,\r\nNULL, 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd_key_identifier,\r\n{"Key Identifier", "scsi_osd.key_identifier", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_seed,\r\n{"Seed", "scsi_osd.seed", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_collection_fcr,\r\n{"FCR", "scsi_osd.collection.fcr", FT_BOOLEAN, 8,\r\nTFS(&tfs_set_notset), 0x01, NULL, HFILL}},\r\n{ &hf_scsi_osd_collection_object_id,\r\n{"Collection Object Id", "scsi_osd.collection_object_id", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_requested_collection_object_id,\r\n{"Requested Collection Object Id", "scsi_osd.requested_collection_object_id", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_partition_created_in,\r\n{ "Created In", "scsi_osd.partition.created_in", FT_FRAMENUM, BASE_NONE,\r\nNULL, 0x0, "The frame this partition was created", HFILL }},\r\n{ &hf_scsi_osd_partition_removed_in,\r\n{ "Removed In", "scsi_osd.partition.removed_in", FT_FRAMENUM, BASE_NONE,\r\nNULL, 0x0, "The frame this partition was removed", HFILL }},\r\n{ &hf_scsi_osd_flush_scope,\r\n{"Flush Scope", "scsi_osd.flush.scope", FT_UINT8, BASE_DEC,\r\nVALS(flush_scope_vals), 0x03, NULL, HFILL}},\r\n{ &hf_scsi_osd_flush_collection_scope,\r\n{"Flush Collection Scope", "scsi_osd.flush_collection.scope", FT_UINT8, BASE_DEC,\r\nVALS(flush_collection_scope_vals), 0x03, NULL, HFILL}},\r\n{ &hf_scsi_osd_flush_partition_scope,\r\n{"Flush Partition Scope", "scsi_osd.flush_partition.scope", FT_UINT8, BASE_DEC,\r\nVALS(flush_partition_scope_vals), 0x03, NULL, HFILL}},\r\n{ &hf_scsi_osd_flush_osd_scope,\r\n{"Flush OSD Scope", "scsi_osd.flush_osd.scope", FT_UINT8, BASE_DEC,\r\nVALS(flush_osd_scope_vals), 0x03, NULL, HFILL}},\r\n{ &hf_scsi_osd_attributes_list_type,\r\n{"Attributes List Type", "scsi_osd.attributes_list.type", FT_UINT8, BASE_HEX,\r\nVALS(attributes_list_type_vals), 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd_attributes_list_length,\r\n{"Attributes List Length", "scsi_osd.attributes_list.length", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attributes_page,\r\n{"Attributes Page", "scsi_osd.attributes.page", FT_UINT32, BASE_HEX | BASE_EXT_STRING,\r\n&attributes_page_vals_ext, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attribute_number,\r\n{"Attribute Number", "scsi_osd.attribute.number", FT_UINT32, BASE_HEX,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attribute_length,\r\n{"Attribute Length", "scsi_osd.attribute.length", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_attributes_list_length,\r\n{"Attributes List Length", "scsi_osd2.attributes_list.length", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attrval_user_object_logical_length,\r\n{"User Object Logical Length", "scsi_osd.user_object.logical_length", FT_UINT64, BASE_DEC,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attrval_object_type,\r\n{"Object Type", "scsi_osd.attr.object_type", FT_UINT8, BASE_HEX, VALS(scsi_osd_object_type_vals), 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attrval_partition_id,\r\n{"Partition ID", "scsi_osd.attr.partition_id", FT_UINT64, BASE_HEX,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd_attrval_object_id,\r\n{"Object ID", "scsi_osd.attr.object_id", FT_UINT64, BASE_HEX,\r\nNULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_set_attribute_value,\r\n{"Set Attributes Value", "scsi_osd.set_attribute_value", FT_BYTES, BASE_NONE, 0, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_isolation,\r\n{"Isolation", "scsi_osd2.isolation", FT_UINT8, BASE_HEX, VALS(scsi_osd2_isolation_val), 0x0F, NULL, HFILL}},\r\n{ &hf_scsi_osd2_list_attr,\r\n{"LIST ATTR flag", "scsi_osd2.list_attr", FT_BOOLEAN, 8, 0, 0x40, NULL, HFILL}},\r\n{ &hf_scsi_osd2_object_descriptor_format,\r\n{"Object Descriptor Format", "scsi_osd2.object_descriptor_format", FT_UINT8, BASE_HEX, VALS(scsi_osd2_object_descriptor_format_val), 0xFC, NULL, HFILL}},\r\n{ &hf_scsi_osd2_immed_tr,\r\n{"Immed TR", "scsi_osd2.immed_tr", FT_UINT8, BASE_DEC, 0, 0x80, NULL, HFILL}},\r\n{ &hf_scsi_osd2_remove_scope,\r\n{"Remove scope", "scsi_osd2.remove_scope", FT_UINT8, BASE_HEX, VALS(scsi_osd2_remove_scope), 0x07, NULL, HFILL}},\r\n{ &hf_scsi_osd2_source_collection_object_id,\r\n{"Source Collection Object ID", "scsi_osd2.source_collection_object_id", FT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_matches_collection_object_id,\r\n{"Matches Collection Object ID", "scsi_osd2.matches_collection_object_id", FT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_cdb_continuation_length,\r\n{"CDB Continuation Length", "scsi_osd2.cdb_continuation.length", FT_UINT32, BASE_DEC, 0, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_cdb_continuation_format,\r\n{"CDB Continuation Format", "scsi_osd2.cdb_continuation.format", FT_UINT8, BASE_HEX, VALS(scsi_osd2_cdb_continuation_format_val), 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_continued_service_action,\r\n{"Continued Service Action", "scsi_osd2.cdb_continuation.sa", FT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_cdb_continuation_descriptor_type,\r\n{"Descriptor Type", "scsi_osd2.cdb_continuation.desc.type", FT_UINT16, BASE_HEX, VALS(scsi_osd2_cdb_continuation_descriptor_type_val), 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_cdb_continuation_descriptor_pad_length,\r\n{"Descriptor Pad Length", "scsi_osd2.cdb_continuation.desc.padlen", FT_UINT8, BASE_DEC, NULL, 0x7, NULL, HFILL}},\r\n{ &hf_scsi_osd2_cdb_continuation_descriptor_length,\r\n{"Descriptor Length", "scsi_osd2.cdb_continuation.desc.length", FT_UINT32, BASE_DEC, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_query_type,\r\n{"Query Type", "scsi_osd2.query.type", FT_UINT8, BASE_HEX, VALS(scsi_osd2_query_type_vals), 0x0f, NULL, HFILL}},\r\n{ &hf_scsi_osd2_query_entry_length,\r\n{"Entry Length", "scsi_osd2.query.entry.length", FT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_query_attributes_page,\r\n{"Attributes Page", "scsi_osd2.query.entry.page", FT_UINT32, BASE_HEX | BASE_EXT_STRING, &attributes_page_vals_ext, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_query_attribute_number,\r\n{"Attribute Number", "scsi_osd2.query.entry.number", FT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_query_minimum_attribute_value_length,\r\n{"Minimum Attribute Value Length", "scsi_osd2.query.entry.min_length", FT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL}},\r\n{ &hf_scsi_osd2_query_maximum_attribute_value_length,\r\n{"Maximum Attribute Value Length", "scsi_osd2.query.entry.max_length", FT_UINT16, BASE_DEC, NULL, 0, NULL, HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_osd_option,\r\n&ett_osd_partition,\r\n&ett_osd_attribute_parameters,\r\n&ett_osd_capability,\r\n&ett_osd_permission_bitmask,\r\n&ett_osd_security_parameters,\r\n&ett_osd_get_attributes,\r\n&ett_osd_set_attributes,\r\n&ett_osd_multi_object,\r\n&ett_osd_attribute,\r\n&ett_osd2_query_criteria_entry,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_osd_attr_unknown, { "scsi_osd.attr_unknown", PI_UNDECODED, PI_NOTE, "Unknown attribute, cannot decode attribute value", EXPFILL }},\r\n{ &ei_osd2_invalid_offset, { "scsi_osd2.invalid_offset", PI_UNDECODED, PI_ERROR, "Invalid offset exponent", EXPFILL }},\r\n{ &ei_osd2_invalid_object_descriptor_format, { "scsi_osd2.object_descriptor_format.invalid", PI_UNDECODED, PI_ERROR, "Invalid list format", EXPFILL }},\r\n{ &ei_osd_unknown_attributes_list_type, { "scsi_osd.attributes_list.type.invalid", PI_UNDECODED, PI_ERROR, "Unknown attribute list type", EXPFILL }},\r\n{ &ei_osd2_cdb_continuation_format_unknown, { "scsi_osd2.cdb_continuation.format.unknown", PI_UNDECODED, PI_ERROR, "Unknown CDB Continuation Format", EXPFILL }},\r\n{ &ei_osd2_continued_service_action_mismatch, { "scsi_osd2.cdb_continuation.sa.mismatch", PI_PROTOCOL, PI_WARN, "CONTINUED SERVICE ACTION and SERVICE ACTION do not match", EXPFILL }},\r\n{ &ei_osd2_cdb_continuation_descriptor_type_unknown, { "scsi_osd2.cdb_continuation.desc.type.unknown", PI_UNDECODED, PI_WARN, "Unknown descriptor type", EXPFILL }},\r\n{ &ei_osd2_cdb_continuation_descriptor_length_invalid, { "scsi_osd2.cdb_continuation.desc.length.invalid", PI_PROTOCOL, PI_ERROR, "Invalid descriptor length (not a multiple of 8)", EXPFILL }},\r\n{ &ei_osd2_cdb_continuation_length_invalid, { "scsi_osd2.cdb_continuation.length.invalid", PI_PROTOCOL, PI_ERROR, "Invalid CDB continuation length", EXPFILL }},\r\n{ &ei_osd_attr_length_invalid, { "scsi_osd.attribute_length.invalid", PI_PROTOCOL, PI_ERROR, "Invalid Attribute Length", EXPFILL }},\r\n{ &ei_osd2_query_values_equal, { "scsi_osd2.query.entry.equal", PI_PROTOCOL, PI_NOTE, "The minimum and maximum values are equal", EXPFILL }},\r\n};\r\nproto_scsi_osd = proto_register_protocol("SCSI_OSD", "SCSI_OSD", "scsi_osd");\r\nproto_register_field_array(proto_scsi_osd, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_scsi_osd = expert_register_protocol(proto_scsi_osd);\r\nexpert_register_field_array(expert_scsi_osd, ei, array_length(ei));\r\n}

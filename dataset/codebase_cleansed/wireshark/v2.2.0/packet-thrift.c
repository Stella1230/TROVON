static int\r\ndissect_thrift_utf7(tvbuff_t* tvb, packet_info* pinfo _U_, proto_tree* tree, int offset, int length _U_)\r\n{\r\nguint32 str_len;\r\nproto_tree_add_item_ret_uint(tree, hf_thrift_str_len, tvb, offset, 4, ENC_BIG_ENDIAN, &str_len);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_thrift_utf7str, tvb, offset, str_len, ENC_ASCII | ENC_NA);\r\noffset = offset + str_len;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_thrift_list(tvbuff_t* tvb, packet_info* pinfo _U_, proto_tree* tree, int offset, int length)\r\n{\r\nproto_tree *sub_tree;\r\nproto_item *ti;\r\nguint32 type;\r\nint start_offset = offset, i;\r\nguint32 list_len;\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, -1, ett_thrift, &ti, "List");\r\nproto_tree_add_item_ret_uint(sub_tree, hf_thrift_type, tvb, offset, 1, ENC_BIG_ENDIAN, &type);\r\noffset++;\r\nproto_tree_add_item_ret_uint(sub_tree, hf_thrift_num_list_item, tvb, offset, 4, ENC_BIG_ENDIAN, &list_len);\r\noffset += 4;\r\nfor (i = 0; i < (int)list_len; ++i) {\r\noffset = dissect_thrift_type(tvb, pinfo, sub_tree, type, offset, length);\r\n}\r\nlist_len = offset - start_offset;\r\nproto_item_set_len(ti, list_len);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_thrift_struct(tvbuff_t* tvb, packet_info* pinfo _U_, proto_tree* tree, int offset, int length)\r\n{\r\nproto_tree *sub_tree;\r\nproto_item *ti;\r\nguint8 type;\r\nint start_offset = offset, struct_len;\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, -1, ett_thrift, &ti, "Struct");\r\nif (offset >= length) {\r\nreturn length;\r\n}\r\nwhile (offset < length) {\r\ntype = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(sub_tree, hf_thrift_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (type == 0){\r\nstruct_len = offset - start_offset;\r\nproto_item_set_len(ti, struct_len);\r\nbreak;\r\n}\r\nproto_tree_add_item(sub_tree, hf_thrift_fid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset = dissect_thrift_type(tvb, pinfo, sub_tree, type, offset, length);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_thrift_map(tvbuff_t* tvb, packet_info* pinfo _U_, proto_tree* tree, int offset, int length)\r\n{\r\nproto_tree *sub_tree;\r\nproto_item *ti;\r\nguint32 ktype;\r\nguint32 vtype;\r\nguint32 map_len;\r\nint start_offset = offset, i;\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, -1, ett_thrift, &ti, "Map");\r\nproto_tree_add_item_ret_uint(sub_tree, hf_thrift_type, tvb, offset, 1, ENC_BIG_ENDIAN, &ktype);\r\noffset++;\r\nproto_tree_add_item_ret_uint(sub_tree, hf_thrift_type, tvb, offset, 1, ENC_BIG_ENDIAN, &vtype);\r\noffset++;\r\nproto_tree_add_item_ret_uint(sub_tree, hf_thrift_num_map_item, tvb, offset, 4, ENC_BIG_ENDIAN, &map_len);\r\noffset += 4;\r\nfor (i = 0; i < (int)map_len; ++i) {\r\noffset = dissect_thrift_type(tvb, pinfo, sub_tree, ktype, offset, length);\r\noffset = dissect_thrift_type(tvb, pinfo, sub_tree, vtype, offset, length);\r\n}\r\nmap_len = offset - start_offset;\r\nproto_item_set_len(ti, map_len);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_thrift_type(tvbuff_t* tvb, packet_info* pinfo _U_, proto_tree* tree, int type, int offset, int length)\r\n{\r\nswitch (type){\r\ncase 2:\r\nproto_tree_add_item(tree, hf_thrift_bool, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(tree, hf_thrift_byte, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(tree, hf_thrift_double, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(tree, hf_thrift_i16, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 8:\r\nproto_tree_add_item(tree, hf_thrift_i32, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase 9:\r\nproto_tree_add_item(tree, hf_thrift_u64, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nbreak;\r\ncase 10:\r\nproto_tree_add_item(tree, hf_thrift_i64, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\nbreak;\r\ncase 11:\r\noffset = dissect_thrift_utf7(tvb, pinfo, tree, offset, length);\r\nbreak;\r\ncase 12:\r\noffset = dissect_thrift_struct(tvb, pinfo, tree, offset, length);\r\nbreak;\r\ncase 13:\r\noffset = dissect_thrift_map(tvb, pinfo, tree, offset, length);\r\nbreak;\r\ncase 15:\r\noffset = dissect_thrift_list(tvb, pinfo, tree, offset, length);\r\nbreak;\r\ndefault:\r\nreturn length;\r\n}\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_thrift_common(tvbuff_t* tvb, packet_info* pinfo, proto_tree* tree)\r\n{\r\nproto_tree *sub_tree;\r\nint offset = 0;\r\nguint32 str_len;\r\nguint8 mtype;\r\nguint16 version;\r\nguint32 seq_id;\r\nguint8 *method_str;\r\nint length = tvb_reported_length(tvb);\r\nguint8 type;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "THRIFT");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nversion = tvb_get_ntohs(tvb, 0);\r\nmtype = tvb_get_guint8(tvb, 3);\r\nstr_len = tvb_get_ntohl(tvb, 4);\r\nseq_id = tvb_get_ntohl(tvb, str_len + 8);\r\nmethod_str = tvb_get_string_enc(wmem_packet_scope(), tvb, 8, str_len, ENC_UTF_8);\r\nproto_tree_add_item(tree, proto_thrift, tvb, 0, -1, ENC_NA);\r\nsub_tree = proto_tree_add_subtree_format(tree, tvb, 0, -1, ett_thrift, NULL, "%s[ version:0x%x, seqid:%d, method:%s]",\r\nval_to_str(mtype, thrift_mtype_vals, "%d"),\r\nversion,\r\nseq_id,\r\nmethod_str);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s %s", val_to_str(mtype, thrift_mtype_vals, "%d"), method_str);\r\nif (tree){\r\nproto_tree_add_item(sub_tree, hf_thrift_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_thrift_mtype, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(sub_tree, hf_thrift_str_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sub_tree, hf_thrift_method, tvb, offset, str_len, ENC_ASCII | ENC_NA);\r\noffset = offset + str_len;\r\nproto_tree_add_item(sub_tree, hf_thrift_seq_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nelse{\r\noffset = 12 + str_len;\r\n}\r\nsub_tree = proto_tree_add_subtree(tree, tvb, offset, -1, ett_thrift, NULL, "Data");\r\nif (tree){\r\nwhile (offset < length){\r\ntype = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(sub_tree, hf_thrift_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (type == 0){\r\nreturn;\r\n}\r\noffset++;\r\nproto_tree_add_item(sub_tree, hf_thrift_fid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset = dissect_thrift_type(tvb, pinfo, sub_tree, type, offset, length);\r\n}\r\n}\r\n}\r\nstatic gboolean\r\ndissect_thrift_heur(tvbuff_t* tvb, packet_info* pinfo, proto_tree* tree, void *data _U_) {\r\nint offset = 0;\r\nguint32 header;\r\ngint tframe_length;\r\nint length = tvb_captured_length(tvb);\r\nint str_length;\r\nguchar c;\r\nif (length < 9){\r\nreturn FALSE;\r\n}\r\nheader = tvb_get_ntohl(tvb, offset);\r\nif ((header & THRIFT_VERSION_MASK) != THRIFT_VERSION_1) {\r\ntframe_length = header;\r\noffset += 4;\r\nheader = tvb_get_ntohl(tvb, offset);\r\nif (tframe_length > (length - 4)) {\r\nreturn FALSE;\r\n}\r\nelse if ((header & THRIFT_VERSION_MASK) != THRIFT_VERSION_1) {\r\nreturn FALSE;\r\n}\r\nelse {\r\ntvb = tvb_new_subset_remaining(tvb, 4);\r\noffset -= 4;\r\nlength -= 4;\r\n}\r\n}\r\noffset += 4;\r\nstr_length = tvb_get_ntohl(tvb, offset);\r\nif ((str_length < 1) ||(length < str_length + 8)){\r\nreturn FALSE;\r\n}\r\noffset += 4;\r\nif (length < offset + str_length){\r\nreturn FALSE;\r\n}\r\nwhile (offset < (str_length + 8)){\r\nc = tvb_get_guint8(tvb, offset);\r\nif (!g_ascii_isprint(c)){\r\nreturn FALSE;\r\n}\r\noffset++;\r\n}\r\ndissect_thrift_common(tvb, pinfo, tree);\r\nreturn TRUE;\r\n}\r\nvoid proto_register_thrift(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_thrift_version,\r\n{ "Version", "thrift.version",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_mtype,\r\n{ "Message type", "thrift.mtype",\r\nFT_UINT8, BASE_DEC, VALS(thrift_mtype_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_str_len,\r\n{ "Length", "thrift.str_len",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_method,\r\n{ "Method", "thrift.method",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_seq_id,\r\n{ "Sequence Id", "thrift.seq_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_type,\r\n{ "Type", "thrift.type",\r\nFT_UINT8, BASE_DEC, VALS(thrift_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_fid,\r\n{ "Field Id", "thrift.fid",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_i16,\r\n{ "Integer16", "thrift.i16",\r\nFT_INT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_i32,\r\n{ "Integer32", "thrift.i32",\r\nFT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_utf7str,\r\n{ "UTF7 String", "thrift.utf7str",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_num_list_item,\r\n{ "Number of List Items", "thrift.num_list_item",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_num_map_item,\r\n{ "Number of Map Items", "thrift.num_map_item",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_bool,\r\n{ "Boolean", "thrift.bool",\r\nFT_UINT8, BASE_DEC, VALS(thrift_bool_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_byte,\r\n{ "Byte", "thrift.byte",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_i64,\r\n{ "Integer64", "thrift.i64",\r\nFT_INT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_u64,\r\n{ "Integer64", "thrift.u64",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_thrift_double,\r\n{ "Double", "thrift.double",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint* ett[] = {\r\n&ett_thrift,\r\n};\r\nproto_thrift = proto_register_protocol("Thrift Protocol", "Thrift", "thrift");\r\nproto_register_field_array(proto_thrift, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_thrift(void) {\r\nheur_dissector_add("tcp", dissect_thrift_heur, "Thrift over TCP", "thrift_tcp", proto_thrift, HEURISTIC_ENABLE);\r\n}

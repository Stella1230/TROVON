static gboolean\r\ncapture_vlan(const guchar *pd, int offset, int len, capture_packet_info_t *cpinfo, const union wtap_pseudo_header *pseudo_header _U_ ) {\r\nguint16 encap_proto;\r\nif ( !BYTES_ARE_IN_FRAME(offset,len,5) )\r\nreturn FALSE;\r\nencap_proto = pntoh16( &pd[offset+2] );\r\nif ( encap_proto <= IEEE_802_3_MAX_LEN) {\r\nif ( pd[offset+4] == 0xff && pd[offset+5] == 0xff ) {\r\nreturn capture_ipx(pd,offset+4,len, cpinfo, pseudo_header);\r\n} else {\r\nreturn capture_llc(pd,offset+4,len, cpinfo, pseudo_header);\r\n}\r\n}\r\nreturn try_capture_dissector("ethertype", encap_proto, pd, offset+4, len, cpinfo, pseudo_header);\r\n}\r\nstatic void\r\ncolumns_set_vlan(column_info *cinfo, guint16 tci)\r\n{\r\nstatic const char fast_str[][2] = { "0", "1", "2", "3", "4", "5", "6", "7" };\r\nchar id_str[16];\r\nguint32_to_str_buf(tci & 0xFFF, id_str, sizeof(id_str));\r\ncol_add_lstr(cinfo, COL_INFO,\r\n"PRI: ", fast_str[(tci >> 13) & 7], " "\r\n"CFI: ", fast_str[(tci >> 12) & 1], " "\r\n"ID: ", id_str,\r\nCOL_ADD_LSTR_TERMINATOR);\r\ncol_add_str(cinfo, COL_8021Q_VLAN_ID, id_str);\r\n}\r\nstatic int\r\ndissect_vlan(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nguint16 tci, vlan_id;\r\nguint16 encap_proto;\r\ngboolean is_802_2;\r\nproto_tree *vlan_tree;\r\nproto_item *item;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "VLAN");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ntci = tvb_get_ntohs( tvb, 0 );\r\nvlan_id = tci & 0xFFF;\r\nif (pinfo->vlan_id == 0) {\r\npinfo->vlan_id = vlan_id;\r\n}\r\ncolumns_set_vlan(pinfo->cinfo, tci);\r\nvlan_tree = NULL;\r\nif (tree) {\r\nti = proto_tree_add_item(tree, hfi_vlan, tvb, 0, 4, ENC_NA);\r\nif (vlan_summary_in_tree) {\r\nproto_item_append_text(ti, ", PRI: %u, CFI: %u, ID: %u",\r\n(tci >> 13), ((tci >> 12) & 1), vlan_id);\r\n}\r\nvlan_tree = proto_item_add_subtree(ti, ett_vlan);\r\nproto_tree_add_item(vlan_tree, &hfi_vlan_priority, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(vlan_tree, &hfi_vlan_cfi, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(vlan_tree, &hfi_vlan_id, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nif (gbl_resolv_flags.vlan_name) {\r\nitem = proto_tree_add_string(vlan_tree, &hfi_vlan_id_name, tvb, 0, 2,\r\nget_vlan_name(wmem_packet_scope(), vlan_id));\r\nPROTO_ITEM_SET_GENERATED(item);\r\n}\r\n}\r\nencap_proto = tvb_get_ntohs(tvb, 2);\r\nif (encap_proto <= IEEE_802_3_MAX_LEN) {\r\nis_802_2 = TRUE;\r\nif (tvb_captured_length_remaining(tvb, 4) >= 2) {\r\nif (tvb_get_ntohs(tvb, 4) == 0xffff) {\r\nis_802_2 = FALSE;\r\n}\r\n}\r\ndissect_802_3(encap_proto, is_802_2, tvb, 4, pinfo, tree, vlan_tree,\r\nhfi_vlan_len.id, hfi_vlan_trailer.id, &ei_vlan_len, 0);\r\n} else {\r\nethertype_data_t ethertype_data;\r\nethertype_data.etype = encap_proto;\r\nethertype_data.offset_after_ethertype = 4;\r\nethertype_data.fh_tree = vlan_tree;\r\nethertype_data.etype_id = hfi_vlan_etype.id;\r\nethertype_data.trailer_id = hfi_vlan_trailer.id;\r\nethertype_data.fcs_len = 0;\r\ncall_dissector_with_data(ethertype_handle, tvb, pinfo, tree, &ethertype_data);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_vlan(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_vlan_priority,\r\n&hfi_vlan_cfi,\r\n&hfi_vlan_id,\r\n&hfi_vlan_id_name,\r\n&hfi_vlan_etype,\r\n&hfi_vlan_len,\r\n&hfi_vlan_trailer,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_vlan\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_vlan_len, { "vlan.len.past_end", PI_MALFORMED, PI_ERROR, "Length field value goes past the end of the payload", EXPFILL }},\r\n};\r\nmodule_t *vlan_module;\r\nexpert_module_t* expert_vlan;\r\nint proto_vlan;\r\nproto_vlan = proto_register_protocol("802.1Q Virtual LAN", "VLAN", "vlan");\r\nhfi_vlan = proto_registrar_get_nth(proto_vlan);\r\nproto_register_fields(proto_vlan, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_vlan = expert_register_protocol(proto_vlan);\r\nexpert_register_field_array(expert_vlan, ei, array_length(ei));\r\nvlan_module = prefs_register_protocol(proto_vlan, proto_reg_handoff_vlan);\r\nprefs_register_bool_preference(vlan_module, "summary_in_tree",\r\n"Show vlan summary in protocol tree",\r\n"Whether the vlan summary line should be shown in the protocol tree",\r\n&vlan_summary_in_tree);\r\nprefs_register_uint_preference(vlan_module, "qinq_ethertype",\r\n"802.1QinQ Ethertype (in hex)",\r\n"The (hexadecimal) Ethertype used to indicate 802.1QinQ VLAN in VLAN tunneling.",\r\n16, &q_in_q_ethertype);\r\nvlan_handle = create_dissector_handle(dissect_vlan, proto_vlan);\r\n}\r\nvoid\r\nproto_reg_handoff_vlan(void)\r\n{\r\nstatic gboolean prefs_initialized = FALSE;\r\nstatic unsigned int old_q_in_q_ethertype;\r\nif (!prefs_initialized)\r\n{\r\ndissector_add_uint("ethertype", ETHERTYPE_VLAN, vlan_handle);\r\nregister_capture_dissector("ethertype", ETHERTYPE_VLAN, capture_vlan, hfi_vlan->id);\r\nprefs_initialized = TRUE;\r\n}\r\nelse\r\n{\r\ndissector_delete_uint("ethertype", old_q_in_q_ethertype, vlan_handle);\r\n}\r\nold_q_in_q_ethertype = q_in_q_ethertype;\r\nethertype_handle = find_dissector_add_dependency("ethertype", hfi_vlan->id);\r\ndissector_add_uint("ethertype", q_in_q_ethertype, vlan_handle);\r\n}

int\r\nget_xdlc_control(const guchar *pd, int offset, gboolean is_extended)\r\n{\r\nguint16 control;\r\nswitch (pd[offset] & 0x03) {\r\ncase XDLC_S:\r\ndefault:\r\nif (is_extended)\r\ncontrol = pletoh16(&pd[offset]);\r\nelse\r\ncontrol = pd[offset];\r\nbreak;\r\ncase XDLC_U:\r\ncontrol = pd[offset];\r\nbreak;\r\n}\r\nreturn control;\r\n}\r\ngboolean\r\ncheck_xdlc_control(tvbuff_t *tvb, int offset,\r\nconst value_string *u_modifier_short_vals_cmd,\r\nconst value_string *u_modifier_short_vals_resp, gboolean is_response,\r\ngboolean is_extended _U_)\r\n{\r\nguint16 control;\r\nif (!tvb_bytes_exist(tvb, offset, 1))\r\nreturn FALSE;\r\nswitch (tvb_get_guint8(tvb, offset) & 0x03) {\r\ncase XDLC_S:\r\nreturn TRUE;\r\ncase XDLC_U:\r\nif (u_modifier_short_vals_cmd == NULL)\r\nu_modifier_short_vals_cmd = modifier_short_vals_cmd;\r\nif (u_modifier_short_vals_resp == NULL)\r\nu_modifier_short_vals_resp = modifier_short_vals_resp;\r\ncontrol = tvb_get_guint8(tvb, offset);\r\nif (is_response) {\r\nif (try_val_to_str(control & XDLC_U_MODIFIER_MASK,\r\nu_modifier_short_vals_resp) == NULL)\r\nreturn FALSE;\r\n} else {\r\nif (try_val_to_str(control & XDLC_U_MODIFIER_MASK,\r\nu_modifier_short_vals_cmd) == NULL)\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\ndefault:\r\nreturn TRUE;\r\n}\r\n}\r\nint\r\ndissect_xdlc_control(tvbuff_t *tvb, int offset, packet_info *pinfo,\r\nproto_tree *xdlc_tree, int hf_xdlc_control, gint ett_xdlc_control,\r\nconst xdlc_cf_items *cf_items_nonext, const xdlc_cf_items *cf_items_ext,\r\nconst value_string *u_modifier_short_vals_cmd,\r\nconst value_string *u_modifier_short_vals_resp, gboolean is_response,\r\ngboolean is_extended, gboolean append_info)\r\n{\r\nguint16 control;\r\nint control_len;\r\nconst xdlc_cf_items *cf_items;\r\nconst char *control_format;\r\nguint16 poll_final;\r\nchar *info;\r\nproto_tree *tc, *control_tree;\r\nconst gchar *frame_type = NULL;\r\nconst gchar *modifier;\r\ninfo=(char *)wmem_alloc(wmem_packet_scope(), 80);\r\nswitch (tvb_get_guint8(tvb, offset) & 0x03) {\r\ncase XDLC_S:\r\nif (is_extended) {\r\ncontrol = tvb_get_letohs(tvb, offset);\r\ncontrol_len = 2;\r\ncf_items = cf_items_ext;\r\ncontrol_format = "Control field: %s (0x%04X)";\r\n} else {\r\ncontrol = tvb_get_guint8(tvb, offset);\r\ncontrol_len = 1;\r\ncf_items = cf_items_nonext;\r\ncontrol_format = "Control field: %s (0x%02X)";\r\n}\r\nswitch (control & XDLC_S_FTYPE_MASK) {\r\ncase XDLC_RR:\r\nframe_type = "RR";\r\nbreak;\r\ncase XDLC_RNR:\r\nframe_type = "RNR";\r\nbreak;\r\ncase XDLC_REJ:\r\nframe_type = "REJ";\r\nbreak;\r\ncase XDLC_SREJ:\r\nframe_type = "SREJ";\r\nbreak;\r\n}\r\nif (is_extended) {\r\npoll_final = (control & XDLC_P_F_EXT);\r\ng_snprintf(info, 80, "S%s, func=%s, N(R)=%u",\r\n(poll_final ?\r\n(is_response ? " F" : " P") :\r\n""),\r\nframe_type,\r\n(control & XDLC_N_R_EXT_MASK) >> XDLC_N_R_EXT_SHIFT);\r\n} else {\r\npoll_final = (control & XDLC_P_F);\r\ng_snprintf(info, 80, "S%s, func=%s, N(R)=%u",\r\n(poll_final ?\r\n(is_response ? " F" : " P") :\r\n""),\r\nframe_type,\r\n(control & XDLC_N_R_MASK) >> XDLC_N_R_SHIFT);\r\n}\r\nif (append_info) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", ");\r\ncol_append_str(pinfo->cinfo, COL_INFO, info);\r\n} else {\r\ncol_add_str(pinfo->cinfo, COL_INFO, info);\r\n}\r\nif (xdlc_tree) {\r\ntc = proto_tree_add_uint_format(xdlc_tree, hf_xdlc_control, tvb,\r\noffset, control_len, control, control_format, info, control);\r\ncontrol_tree = proto_item_add_subtree(tc, ett_xdlc_control);\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_n_r,\r\ntvb, offset, control_len, control);\r\nif (poll_final) {\r\nproto_tree_add_boolean(control_tree,\r\n(is_response ? *cf_items->hf_xdlc_f :\r\n*cf_items->hf_xdlc_p),\r\ntvb, offset, control_len, control);\r\n}\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_s_ftype,\r\ntvb, offset, control_len, control);\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_ftype_s_u,\r\ntvb, offset, control_len, control);\r\n}\r\nbreak;\r\ncase XDLC_U:\r\nif (u_modifier_short_vals_cmd == NULL)\r\nu_modifier_short_vals_cmd = modifier_short_vals_cmd;\r\nif (u_modifier_short_vals_resp == NULL)\r\nu_modifier_short_vals_resp = modifier_short_vals_resp;\r\ncontrol = tvb_get_guint8(tvb, offset);\r\ncontrol_len = 1;\r\ncf_items = cf_items_nonext;\r\ncontrol_format = "Control field: %s (0x%02X)";\r\nif (is_response) {\r\nmodifier = val_to_str(control & XDLC_U_MODIFIER_MASK,\r\nu_modifier_short_vals_resp, "Unknown");\r\n} else {\r\nmodifier = val_to_str(control & XDLC_U_MODIFIER_MASK,\r\nu_modifier_short_vals_cmd, "Unknown");\r\n}\r\npoll_final = (control & XDLC_P_F);\r\ng_snprintf(info, 80, "U%s, func=%s",\r\n(poll_final ?\r\n(is_response ? " F" : " P") :\r\n""),\r\nmodifier);\r\nif (append_info) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", ");\r\ncol_append_str(pinfo->cinfo, COL_INFO, info);\r\n} else {\r\ncol_add_str(pinfo->cinfo, COL_INFO, info);\r\n}\r\nif (xdlc_tree) {\r\ntc = proto_tree_add_uint_format(xdlc_tree, hf_xdlc_control, tvb,\r\noffset, control_len, control, control_format, info, control);\r\ncontrol_tree = proto_item_add_subtree(tc, ett_xdlc_control);\r\nif (poll_final) {\r\nproto_tree_add_boolean(control_tree,\r\n(is_response ? *cf_items->hf_xdlc_f:\r\n*cf_items->hf_xdlc_p),\r\ntvb, offset, control_len, control);\r\n}\r\nproto_tree_add_uint(control_tree,\r\n(is_response ? *cf_items->hf_xdlc_u_modifier_resp :\r\n*cf_items->hf_xdlc_u_modifier_cmd),\r\ntvb, offset, control_len, control);\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_ftype_s_u,\r\ntvb, offset, control_len, control);\r\n}\r\nbreak;\r\ndefault:\r\nif (is_extended) {\r\ncontrol = tvb_get_letohs(tvb, offset);\r\ncontrol_len = 2;\r\ncf_items = cf_items_ext;\r\ncontrol_format = "Control field: %s (0x%04X)";\r\npoll_final = (control & XDLC_P_F_EXT);\r\ng_snprintf(info, 80, "I%s, N(R)=%u, N(S)=%u",\r\n((control & XDLC_P_F_EXT) ? " P" : ""),\r\n(control & XDLC_N_R_EXT_MASK) >> XDLC_N_R_EXT_SHIFT,\r\n(control & XDLC_N_S_EXT_MASK) >> XDLC_N_S_EXT_SHIFT);\r\n} else {\r\ncontrol = tvb_get_guint8(tvb, offset);\r\ncontrol_len = 1;\r\ncf_items = cf_items_nonext;\r\ncontrol_format = "Control field: %s (0x%02X)";\r\npoll_final = (control & XDLC_P_F);\r\ng_snprintf(info, 80, "I%s, N(R)=%u, N(S)=%u",\r\n((control & XDLC_P_F) ? " P" : ""),\r\n(control & XDLC_N_R_MASK) >> XDLC_N_R_SHIFT,\r\n(control & XDLC_N_S_MASK) >> XDLC_N_S_SHIFT);\r\n}\r\nif (append_info) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", ");\r\ncol_append_str(pinfo->cinfo, COL_INFO, info);\r\n} else {\r\ncol_add_str(pinfo->cinfo, COL_INFO, info);\r\n}\r\nif (xdlc_tree) {\r\ntc = proto_tree_add_uint_format(xdlc_tree, hf_xdlc_control, tvb,\r\noffset, control_len, control, control_format, info, control);\r\ncontrol_tree = proto_item_add_subtree(tc, ett_xdlc_control);\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_n_r,\r\ntvb, offset, control_len, control);\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_n_s,\r\ntvb, offset, control_len, control);\r\nif (poll_final) {\r\nproto_tree_add_boolean(control_tree, *cf_items->hf_xdlc_p,\r\ntvb, offset, control_len, control);\r\n}\r\nproto_tree_add_uint(control_tree, *cf_items->hf_xdlc_ftype_i,\r\ntvb, offset, control_len, control);\r\n}\r\nbreak;\r\n}\r\nreturn control;\r\n}

static int\r\ndissect_dtpt_wstring(tvbuff_t *tvb, guint offset, proto_tree *tree, int hfindex)\r\n{\r\nguint32 wstring_length;\r\nguint32 wstring_size;\r\nchar *wstring_data = NULL;\r\nguint32 wstring_padding = 0;\r\nwstring_length = tvb_get_letohl(tvb, offset);\r\nwstring_data = tvb_get_string_enc(wmem_packet_scope(), tvb, offset+4, wstring_length, ENC_UTF_16|ENC_LITTLE_ENDIAN);\r\nwstring_size = wstring_length;\r\nif (wstring_size%4) {\r\nwstring_padding = (4-wstring_size%4);\r\nwstring_size += wstring_padding;\r\n}\r\nif (tree) {\r\nproto_item *dtpt_wstring_item;\r\nproto_tree *dtpt_wstring_tree;\r\ndtpt_wstring_item = proto_tree_add_string(tree, hfindex,\r\ntvb, offset+0, 4+wstring_size, wstring_data);\r\ndtpt_wstring_tree = proto_item_add_subtree(dtpt_wstring_item, ett_dtpt_wstring);\r\nif (dtpt_wstring_tree) {\r\nproto_tree_add_uint(dtpt_wstring_tree, hf_dtpt_wstring_length,\r\ntvb, offset+0, 4, wstring_length);\r\nif (wstring_length)\r\nproto_tree_add_string(dtpt_wstring_tree, hf_dtpt_wstring_data,\r\ntvb, offset+4, wstring_length, wstring_data);\r\nif (wstring_padding)\r\nproto_tree_add_item(dtpt_wstring_tree, hf_dtpt_padding, tvb,\r\noffset+4+wstring_length,wstring_padding, ENC_NA);\r\n}\r\n}\r\noffset += 4+wstring_size;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dtpt_guid(tvbuff_t *tvb, guint offset, proto_tree *tree, int hfindex)\r\n{\r\nguint32 guid_length;\r\nguid_length = tvb_get_letohl(tvb, offset);\r\nif (tree) {\r\ne_guid_t guid;\r\nproto_item *dtpt_guid_item = NULL;\r\nproto_tree *dtpt_guid_tree = NULL;\r\nconst gchar *guid_name = NULL;\r\nif (guid_length) {\r\ntvb_get_guid(tvb, offset+4, &guid, ENC_LITTLE_ENDIAN);\r\n}\r\nelse {\r\nmemset(&guid, 0, sizeof(guid));\r\n}\r\ndtpt_guid_item = proto_tree_add_guid(tree, hfindex, tvb, offset, 4 + guid_length, &guid);\r\nif (dtpt_guid_item) {\r\nguid_name = guids_get_guid_name(&guid);\r\nif (guid_name != NULL)\r\nproto_item_set_text(dtpt_guid_item, "%s: %s (%s)",\r\nproto_registrar_get_name(hfindex), guid_name, guid_to_str(wmem_packet_scope(), &guid));\r\ndtpt_guid_tree = proto_item_add_subtree(dtpt_guid_item, ett_dtpt_guid);\r\n}\r\nif (dtpt_guid_tree) {\r\nproto_item *dtpt_guid_data_item = NULL;\r\nproto_tree_add_uint(dtpt_guid_tree, hf_dtpt_guid_length,\r\ntvb, offset, 4, guid_length);\r\nif (guid_length) {\r\ndtpt_guid_data_item = proto_tree_add_guid(dtpt_guid_tree, hf_dtpt_guid_data,\r\ntvb, offset+4, guid_length, &guid);\r\nif (guid_name != NULL && dtpt_guid_data_item != NULL) {\r\nproto_item_set_text(dtpt_guid_data_item, "%s: %s (%s)",\r\nproto_registrar_get_name(hf_dtpt_guid_data),\r\nguid_name, guid_to_str(wmem_packet_scope(), &guid));\r\n}\r\n}\r\n}\r\n}\r\noffset+=4;\r\noffset+=guid_length;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dtpt_sockaddr(tvbuff_t *tvb, guint offset, proto_tree *tree, int hfindex, int sockaddr_type)\r\n{\r\nguint32 sockaddr_length = 0;\r\nproto_item *sockaddr_item = NULL;\r\nproto_tree *sockaddr_tree = NULL;\r\nguint32 sockaddr_len1 = 0;\r\nguint32 sockaddr_len2 = 0;\r\nswitch (sockaddr_type) {\r\ncase SOCKADDR_WITH_LEN:\r\nsockaddr_len1=4;\r\nsockaddr_len2=16;\r\nbreak;\r\ncase SOCKADDR_CONNECT:\r\nsockaddr_len1=0;\r\nsockaddr_len2=30;\r\nbreak;\r\n}\r\nif (sockaddr_type == SOCKADDR_WITH_LEN)\r\nsockaddr_length = tvb_get_letohl(tvb, offset + 0);\r\nif (tree) {\r\nsockaddr_tree = proto_tree_add_subtree(tree, tvb, offset, sockaddr_len1+sockaddr_len2,\r\nett_dtpt_sockaddr, NULL, proto_registrar_get_name(hfindex));\r\nif (sockaddr_type == SOCKADDR_WITH_LEN)\r\nproto_tree_add_uint(sockaddr_tree, hf_dtpt_sockaddr_length,\r\ntvb, offset+0, 4, sockaddr_length);\r\n}\r\noffset += sockaddr_len1;\r\nif (sockaddr_tree) {\r\nswitch (sockaddr_type) {\r\ncase SOCKADDR_WITH_LEN: {\r\nguint16 family;\r\nfamily = tvb_get_letohs(tvb, offset);\r\nproto_tree_add_uint(sockaddr_tree, hf_dtpt_sockaddr_family,\r\ntvb, offset, 2, family);\r\nswitch (family) {\r\ncase WINSOCK_AF_INET: {\r\nguint16 port;\r\nport = tvb_get_ntohs(tvb,offset+2);\r\nproto_tree_add_uint(sockaddr_tree, hf_dtpt_sockaddr_port,\r\ntvb, offset+2,2,port);\r\nproto_tree_add_item(sockaddr_tree, hf_dtpt_sockaddr_address,\r\ntvb, offset+4,4,ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sockaddr_tree, hf_dtpt_padding, tvb, offset+8, 8, ENC_NA);\r\nproto_item_append_text(sockaddr_item, ": %s:%d", tvb_ip_to_str(tvb,offset+4), port);\r\n}\r\nbreak;\r\n}\r\n}\r\nbreak;\r\ncase SOCKADDR_CONNECT: {\r\nguint32 family;\r\nfamily = tvb_get_letohl(tvb, offset+0);\r\nproto_tree_add_uint(sockaddr_tree, hf_dtpt_sockaddr_family,\r\ntvb, offset+0, 4, family);\r\nswitch (family) {\r\ncase WINSOCK_AF_INET: {\r\nguint16 port;\r\nproto_tree_add_item(sockaddr_tree, hf_dtpt_padding, tvb, offset+4, 4, ENC_NA);\r\nport = tvb_get_ntohs(tvb,offset+8);\r\nproto_tree_add_uint(sockaddr_tree, hf_dtpt_sockaddr_port,\r\ntvb, offset+8,2,port);\r\nproto_tree_add_item(sockaddr_tree, hf_dtpt_sockaddr_address,\r\ntvb, offset+10,4,ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sockaddr_tree, hf_dtpt_padding, tvb, offset+14, 16, ENC_NA);\r\nproto_item_append_text(sockaddr_item, ": %s:%d", tvb_ip_to_str(tvb,offset+10), port);\r\n}\r\nbreak;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\noffset += sockaddr_len2;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dtpt_conversation(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nguint offset = 0;\r\noffset = dissect_dtpt(tvb, pinfo, tree, NULL);\r\nif (offset == 0) {\r\noffset = dissect_dtpt_data(tvb, pinfo, tree);\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset), pinfo, tree);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nstatic int\r\ndissect_dtpt_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *dtpt_item;\r\nproto_tree *dtpt_tree;\r\nproto_tree *dtpt_queryset_tree;\r\nguint offset = 0;\r\nguint32 queryset_rawsize;\r\nguint32 queryset_size;\r\nguint32 num_protocols;\r\nguint32 protocols_length = 0;\r\nguint32 addrs_start;\r\nguint32 num_addrs;\r\nguint32 addrs_length1 = 0;\r\nproto_item *dtpt_addrs_item = NULL;\r\nproto_tree *dtpt_addrs_tree = NULL;\r\nguint32 blob_rawsize = 0;\r\nguint32 blob_size = 0;\r\nguint32 blob_data_length = 0;\r\nqueryset_rawsize = tvb_get_letohl(tvb, offset + 0);\r\nif (queryset_rawsize != 60) return 0;\r\nqueryset_size = tvb_get_letohl(tvb, offset + 4);\r\nif (queryset_size != 60) return 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "DTPT");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "QuerySet");\r\ndtpt_item = proto_tree_add_item(tree, proto_dtpt, tvb, 0, -1, ENC_NA);\r\ndtpt_tree = proto_item_add_subtree(dtpt_item, ett_dtpt);\r\nif (dtpt_tree) {\r\nproto_tree_add_uint(dtpt_tree, hf_dtpt_queryset_rawsize,\r\ntvb, 0, 4, queryset_rawsize);\r\ndtpt_queryset_tree = proto_tree_add_subtree(dtpt_tree, tvb, 4, 60,\r\nett_dtpt_queryset, NULL, "QuerySet raw");\r\nif (dtpt_queryset_tree) {\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_size,\r\ntvb, offset+4+0, 4, queryset_size);\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_service_instance_name_pointer,\r\ntvb, offset+4+4, 4, tvb_get_letohl(tvb, offset+4+ 4));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_service_class_id_pointer,\r\ntvb, offset+4+8, 4, tvb_get_letohl(tvb, offset+4+ 8));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_version,\r\ntvb, offset+4+12, 4, tvb_get_letohl(tvb, offset+4+12));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_comment_pointer,\r\ntvb, offset+4+16, 4, tvb_get_letohl(tvb, offset+4+16));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_namespace,\r\ntvb, offset+4+20, 4, tvb_get_letohl(tvb, offset+4+20));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_provider_id_pointer,\r\ntvb, offset+4+24, 4, tvb_get_letohl(tvb, offset+4+24));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_context_pointer,\r\ntvb, offset+4+28, 4, tvb_get_letohl(tvb, offset+4+28));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_protocols_number,\r\ntvb, offset+4+32, 4, tvb_get_letohl(tvb, offset+4+32));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_protocols_pointer,\r\ntvb, offset+4+36, 4, tvb_get_letohl(tvb, offset+4+36));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_query_string_pointer,\r\ntvb, offset+4+40, 4, tvb_get_letohl(tvb, offset+4+40));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_cs_addrs_number,\r\ntvb, offset+4+44, 4, tvb_get_letohl(tvb, offset+4+44));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_cs_addrs_pointer,\r\ntvb, offset+4+48, 4, tvb_get_letohl(tvb, offset+4+48));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_output_flags,\r\ntvb, offset+4+52, 4, tvb_get_letohl(tvb, offset+4+52));\r\nproto_tree_add_uint(dtpt_queryset_tree, hf_dtpt_queryset_blob_pointer,\r\ntvb, offset+4+56, 4, tvb_get_letohl(tvb, offset+4+56));\r\n}\r\n}\r\noffset += 4;\r\noffset += 60;\r\noffset = dissect_dtpt_wstring(tvb, offset, dtpt_tree, hf_dtpt_service_instance_name);\r\noffset = dissect_dtpt_guid (tvb, offset, dtpt_tree, hf_dtpt_service_class_id );\r\noffset = dissect_dtpt_wstring(tvb, offset, dtpt_tree, hf_dtpt_comment );\r\noffset = dissect_dtpt_guid (tvb, offset, dtpt_tree, hf_dtpt_ns_provider_id );\r\noffset = dissect_dtpt_wstring(tvb, offset, dtpt_tree, hf_dtpt_context );\r\nnum_protocols = tvb_get_letohl(tvb, offset);\r\nif (num_protocols>0) {\r\nprotocols_length = tvb_get_letohl(tvb, offset+4);\r\n}\r\nif (dtpt_tree) {\r\nproto_tree *dtpt_protocols_tree = NULL;\r\nguint32 i;\r\ndtpt_protocols_tree = proto_tree_add_subtree_format(dtpt_tree,\r\ntvb, offset, 4+(num_protocols>0?4:0)+num_protocols*8,\r\nett_dtpt_protocols, NULL, "Protocols: %d", num_protocols);\r\nif (dtpt_protocols_tree) {\r\nproto_tree_add_uint(dtpt_protocols_tree, hf_dtpt_protocols_number,\r\ntvb, offset, 4, num_protocols);\r\nif (num_protocols>0)\r\nproto_tree_add_uint(dtpt_protocols_tree, hf_dtpt_protocols_length,\r\ntvb, offset+4, 4, protocols_length);\r\nfor (i=0;i<num_protocols;i++) {\r\nproto_tree *dtpt_protocol_tree = NULL;\r\ndtpt_protocol_tree = proto_tree_add_subtree_format(dtpt_protocols_tree,\r\ntvb, offset+4+4+i*8, 8, ett_dtpt_protocol, NULL, "Protocol[%d]", i+1);\r\nif (dtpt_protocol_tree) {\r\nproto_tree_add_uint(dtpt_protocol_tree, hf_dtpt_protocol_family,\r\ntvb, offset+4+4+i*8, 4, tvb_get_letohl(tvb, offset+4+4+i*8));\r\nproto_tree_add_uint(dtpt_protocol_tree, hf_dtpt_protocol_protocol,\r\ntvb, offset+4+4+i*8+4, 4, tvb_get_letohl(tvb, offset+4+4+i*8+4));\r\n}\r\n}\r\n}\r\n}\r\noffset += 4 + (num_protocols>0?4:0) + num_protocols*8;\r\noffset = dissect_dtpt_wstring(tvb, offset, dtpt_tree, hf_dtpt_query_string);\r\naddrs_start = offset;\r\nnum_addrs = tvb_get_letohl(tvb, offset);\r\nif (num_addrs>0) {\r\naddrs_length1 = tvb_get_letohl(tvb, offset+4);\r\n}\r\nif (dtpt_tree) {\r\ndtpt_addrs_tree = proto_tree_add_subtree(dtpt_tree,\r\ntvb, offset, -1, ett_dtpt_cs_addrs, &dtpt_addrs_item, "Addresses");\r\nif (dtpt_addrs_tree) {\r\nproto_tree_add_uint(dtpt_addrs_tree, hf_dtpt_cs_addrs_number,\r\ntvb, offset, 4, num_addrs);\r\nif (num_addrs>0)\r\nproto_tree_add_uint(dtpt_addrs_tree, hf_dtpt_cs_addrs_length1,\r\ntvb, offset+4, 4, addrs_length1);\r\n}\r\n}\r\noffset += 4 + (num_addrs>0?4:0);\r\nif (num_addrs>0) {\r\nguint32 i;\r\nguint32 offset2;\r\noffset2 = offset + 24*num_addrs;\r\nfor (i=0;i<num_addrs;i++,offset+=24) {\r\nproto_tree *dtpt_addr1_tree = NULL;\r\nproto_item *dtpt_addr2_item = NULL;\r\nproto_tree *dtpt_addr2_tree = NULL;\r\nguint32 offset2_start;\r\nif (dtpt_addrs_tree) {\r\ndtpt_addr1_tree = proto_tree_add_subtree_format(dtpt_addrs_tree,\r\ntvb, offset, 24, ett_dtpt_cs_addr1, NULL, "Address[%u] Part 1", i+1);\r\nif (dtpt_addr1_tree) {\r\nproto_tree_add_uint(dtpt_addr1_tree, hf_dtpt_cs_addr_local_pointer,\r\ntvb, offset+ 0, 4, tvb_get_letohl(tvb, offset+ 0));\r\nproto_tree_add_uint(dtpt_addr1_tree, hf_dtpt_cs_addr_local_length,\r\ntvb, offset+ 4, 4, tvb_get_letohl(tvb, offset+ 4));\r\nproto_tree_add_uint(dtpt_addr1_tree, hf_dtpt_cs_addr_remote_pointer,\r\ntvb, offset+ 8, 4, tvb_get_letohl(tvb, offset+ 8));\r\nproto_tree_add_uint(dtpt_addr1_tree, hf_dtpt_cs_addr_remote_length,\r\ntvb, offset+12, 4, tvb_get_letohl(tvb, offset+12));\r\nproto_tree_add_uint(dtpt_addr1_tree, hf_dtpt_cs_addr_socket_type,\r\ntvb, offset+16, 4, tvb_get_letohl(tvb, offset+16));\r\nproto_tree_add_uint(dtpt_addr1_tree, hf_dtpt_cs_addr_protocol,\r\ntvb, offset+20, 4, tvb_get_letohl(tvb, offset+20));\r\n}\r\ndtpt_addr2_tree = proto_tree_add_subtree_format(dtpt_addrs_tree,\r\ntvb, offset2, -1, ett_dtpt_cs_addr2, &dtpt_addr2_item, "Address[%u] Part 2", i+1);\r\n}\r\noffset2_start = offset2;\r\noffset2 = dissect_dtpt_sockaddr(tvb, offset2, dtpt_addr2_tree, hf_dtpt_cs_addr_local, SOCKADDR_WITH_LEN);\r\noffset2 = dissect_dtpt_sockaddr(tvb, offset2, dtpt_addr2_tree, hf_dtpt_cs_addr_remote, SOCKADDR_WITH_LEN);\r\nproto_item_set_len(dtpt_addr2_item,\r\noffset2 - offset2_start);\r\n}\r\noffset = offset2;\r\n}\r\nproto_item_set_len(dtpt_addrs_item, offset - addrs_start);\r\nproto_item_set_len(dtpt_item, offset);\r\nblob_rawsize = tvb_get_letohl(tvb, offset);\r\nif (blob_rawsize>=4) {\r\nblob_size = tvb_get_letohl(tvb,offset+4+0);\r\n}\r\nif (dtpt_tree) {\r\nproto_tree *dtpt_blobraw_tree;\r\nproto_tree_add_uint(dtpt_tree, hf_dtpt_blob_rawsize,\r\ntvb, offset+0, 4, blob_rawsize);\r\nif (blob_rawsize>0) {\r\ndtpt_blobraw_tree = proto_tree_add_subtree(dtpt_tree,\r\ntvb, offset+4, blob_rawsize, ett_dtpt_blobraw, NULL, "Blob raw");\r\nif (dtpt_blobraw_tree) {\r\nproto_tree_add_uint(dtpt_blobraw_tree, hf_dtpt_blob_size,\r\ntvb, offset+4+0, 4, blob_size);\r\nproto_tree_add_uint(dtpt_blobraw_tree, hf_dtpt_blob_data_pointer,\r\ntvb, offset+4+4, 4, tvb_get_letohl(tvb,offset+4+4));\r\n}\r\n}\r\n}\r\noffset += 4+blob_rawsize;\r\nproto_item_set_len(dtpt_item, offset);\r\nif (blob_size>0) {\r\nproto_tree *dtpt_blob_tree;\r\nblob_data_length = tvb_get_letohl(tvb,offset);\r\nif (dtpt_tree) {\r\ndtpt_blob_tree = proto_tree_add_subtree(dtpt_tree,\r\ntvb, offset, 4+blob_data_length, ett_dtpt_blob, NULL, "Blob");\r\nif (dtpt_blob_tree) {\r\nproto_tree_add_uint(dtpt_blob_tree, hf_dtpt_blob_data_length,\r\ntvb, offset+0, 4, blob_data_length);\r\nproto_tree_add_item(dtpt_blob_tree, hf_dtpt_blob_data,\r\ntvb, offset+4, blob_data_length, ENC_NA);\r\n}\r\n}\r\noffset += 4+blob_data_length;\r\nif (dtpt_item)\r\nproto_item_set_len(dtpt_item, offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_dtpt(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *dtpt_tree;\r\nproto_item *dtpt_item;\r\nguint8 version;\r\nguint8 message_type;\r\nguint32 payload_size;\r\nversion = tvb_get_guint8(tvb, 0);\r\nif (version != 1) return 0;\r\nmessage_type = tvb_get_guint8(tvb, 1);\r\nswitch (message_type) {\r\ncase LookupBeginRequest:\r\ncase LookupBeginResponse:\r\ncase LookupNextRequest:\r\ncase LookupNextResponse:\r\ncase LookupEndRequest:\r\nif (tvb_reported_length(tvb) != 20) return 0;\r\nbreak;\r\ncase ConnectRequest:\r\ncase ConnectResponseOK:\r\ncase ConnectResponseERR:\r\nif (tvb_reported_length(tvb) != 36) return 0;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "DTPT");\r\ncol_add_str(pinfo->cinfo, COL_INFO, val_to_str(message_type, names_message_type, "Unknown (%d)"));\r\nif (message_type == LookupBeginRequest) {\r\nconversation_t *c;\r\nc = find_or_create_conversation(pinfo);\r\nconversation_set_dissector(c, dtpt_conversation_handle);\r\n}\r\ndtpt_item = proto_tree_add_item(tree, proto_dtpt, tvb, 0, -1, ENC_NA);\r\ndtpt_tree = proto_item_add_subtree(dtpt_item, ett_dtpt);\r\nif (dtpt_tree) {\r\nproto_tree_add_uint(dtpt_tree, hf_dtpt_version,\r\ntvb, 0, 1, version);\r\nproto_tree_add_uint(dtpt_tree, hf_dtpt_message_type,\r\ntvb, 1, 1, message_type);\r\nswitch (message_type) {\r\ncase LookupBeginRequest: {\r\nstatic const int * flags[] = {\r\n&hf_dtpt_flags_res_service,\r\n&hf_dtpt_flags_flushprevious,\r\n&hf_dtpt_flags_flushcache,\r\n&hf_dtpt_flags_return_query_string,\r\n&hf_dtpt_flags_return_aliases,\r\n&hf_dtpt_flags_return_blob,\r\n&hf_dtpt_flags_return_addr,\r\n&hf_dtpt_flags_return_comment,\r\n&hf_dtpt_flags_return_version,\r\n&hf_dtpt_flags_return_type,\r\n&hf_dtpt_flags_return_name,\r\n&hf_dtpt_flags_nearest,\r\n&hf_dtpt_flags_nocontainers,\r\n&hf_dtpt_flags_containers,\r\n&hf_dtpt_flags_deep,\r\nNULL\r\n};\r\nproto_tree_add_bitmask(dtpt_tree, tvb, 12, hf_dtpt_flags, ett_dtpt_flags, flags, ENC_LITTLE_ENDIAN);\r\npayload_size = tvb_get_letohl(tvb, 16);\r\nproto_tree_add_uint(dtpt_tree, hf_dtpt_payload_size,\r\ntvb, 16, 4, payload_size);\r\n}\r\nbreak;\r\ncase LookupBeginResponse: {\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_handle,\r\ntvb, 4, 8, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_error,\r\ntvb, 12, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase LookupNextRequest: {\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_handle,\r\ntvb, 4, 8, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_buffer_size,\r\ntvb, 16, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase LookupNextResponse: {\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_error,\r\ntvb, 12, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_data_size,\r\ntvb, 16, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase LookupEndRequest: {\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_handle,\r\ntvb, 4, 8, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase ConnectRequest: {\r\ndissect_dtpt_sockaddr(tvb, 2, dtpt_tree, hf_dtpt_connect_addr, SOCKADDR_CONNECT);\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_error,\r\ntvb, 32, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase ConnectResponseOK: {\r\ndissect_dtpt_sockaddr(tvb, 2, dtpt_tree, hf_dtpt_connect_addr, SOCKADDR_CONNECT);\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_error,\r\ntvb, 32, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\ncase ConnectResponseERR: {\r\ndissect_dtpt_sockaddr(tvb, 2, dtpt_tree, hf_dtpt_connect_addr, SOCKADDR_CONNECT);\r\nproto_tree_add_item(dtpt_tree, hf_dtpt_error,\r\ntvb, 32, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_dtpt(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dtpt_version,\r\n{ "Version", "dtpt.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Protocol Version", HFILL }},\r\n{ &hf_dtpt_message_type,\r\n{ "Message Type", "dtpt.message_type",\r\nFT_UINT8, BASE_DEC, VALS(names_message_type), 0x0,\r\n"Packet Message Type", HFILL }},\r\n{ &hf_dtpt_flags,\r\n{ "ControlFlags", "dtpt.flags",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"ControlFlags as documented for WSALookupServiceBegin", HFILL }},\r\n{ &hf_dtpt_flags_deep,\r\n{ "DEEP", "dtpt.flags.deep",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_DEEP,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_containers,\r\n{ "CONTAINERS", "dtpt.flags.containers",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_CONTAINERS,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_nocontainers,\r\n{ "NOCONTAINERS", "dtpt.flags.nocontainers",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_NOCONTAINERS,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_nearest,\r\n{ "NEAREST", "dtpt.flags.nearest",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_NEAREST,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_name,\r\n{ "RETURN_NAME", "dtpt.flags.return_name",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_NAME,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_type,\r\n{ "RETURN_TYPE", "dtpt.flags.return_type",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_TYPE,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_version,\r\n{ "RETURN_VERSION", "dtpt.flags.return_version",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_VERSION,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_comment,\r\n{ "RETURN_COMMENT", "dtpt.flags.return_comment",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_COMMENT,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_addr,\r\n{ "RETURN_ADDR", "dtpt.flags.return_addr",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_ADDR,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_blob,\r\n{ "RETURN_BLOB", "dtpt.flags.return_blob",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_BLOB,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_aliases,\r\n{ "RETURN_ALIASES", "dtpt.flags.return_aliases",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_ALIASES,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_return_query_string,\r\n{ "RETURN_QUERY_STRING", "dtpt.flags.return_query_string",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RETURN_QUERY_STRING,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_flushcache,\r\n{ "FLUSHCACHE", "dtpt.flags.flushcache",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_FLUSHCACHE,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_flushprevious,\r\n{ "FLUSHPREVIOUS", "dtpt.flags.flushprevious",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_FLUSHPREVIOUS,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_flags_res_service,\r\n{ "RES_SERVICE", "dtpt.flags.res_service",\r\nFT_BOOLEAN, 32, TFS(&tfs_set_notset), LUP_RES_SERVICE,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_payload_size,\r\n{ "Payload Size", "dtpt.payload_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Payload Size of the following packet containing a serialized WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_handle,\r\n{ "Handle", "dtpt.handle",\r\nFT_UINT64, BASE_HEX, NULL, 0x0,\r\n"Lookup handle", HFILL }},\r\n{ &hf_dtpt_error,\r\n{ "Last Error", "dtpt.error",\r\nFT_UINT32, BASE_DEC, VALS(names_error), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_buffer_size,\r\n{ "Buffer Size", "dtpt.buffer_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_data_size,\r\n{ "Data Size", "dtpt.data_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_queryset_rawsize,\r\n{ "QuerySet Size", "dtpt.queryset_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Size of the binary WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_size,\r\n{ "dwSize", "dtpt.queryset.dwSize",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"dwSize field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_service_instance_name_pointer,\r\n{ "lpszServiceInstanceName", "dtpt.queryset.lpszServiceInstanceName",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpszServiceInstanceName field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_service_class_id_pointer,\r\n{ "lpServiceClassId", "dtpt.queryset.lpServiceClassId",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpServiceClassId in the WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_version,\r\n{ "lpVersion", "dtpt.queryset.lpVersion",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"lpVersion in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_comment_pointer,\r\n{ "lpszComment", "dtpt.lpszComment",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpszComment field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_namespace,\r\n{ "dwNameSpace", "dtpt.queryset.dwNameSpace",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"dwNameSpace field in WSAQUERYSE", HFILL }},\r\n{ &hf_dtpt_queryset_provider_id_pointer,\r\n{ "lpNSProviderId", "dtpt.queryset.lpNSProviderId",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpNSProviderId field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_context_pointer,\r\n{ "lpszContext", "dtpt.queryset.lpszContext",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpszContext field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_protocols_number,\r\n{ "dwNumberOfProtocols", "dtpt.queryset.dwNumberOfProtocols",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"dwNumberOfProtocols field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_protocols_pointer,\r\n{ "lpafpProtocols", "dtpt.queryset.lpafpProtocols",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpafpProtocols field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_query_string_pointer,\r\n{ "lpszQueryString", "dtpt.queryset.lpszQueryString",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpszQueryString field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_cs_addrs_number,\r\n{ "dwNumberOfCsAddrs", "dtpt.queryset.dwNumberOfCsAddrs",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"dwNumberOfCsAddrs field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_cs_addrs_pointer,\r\n{ "lpcsaBuffer", "dtpt.queryset.lpcsaBuffer",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpcsaBuffer field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_output_flags,\r\n{ "dwOutputFlags", "dtpt.queryset.dwOutputFlags",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"dwOutputFlags field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_queryset_blob_pointer,\r\n{ "lpBlob", "dtpt.queryset.lpBlob",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"lpBlob field in WSAQUERYSET", HFILL }},\r\n{ &hf_dtpt_wstring_length,\r\n{ "Length", "dtpt.wstring.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"String Length", HFILL }},\r\n{ &hf_dtpt_wstring_data,\r\n{ "Data", "dtpt.wstring.data",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\n"String Data", HFILL }},\r\n{ &hf_dtpt_guid_length,\r\n{ "Length", "dtpt.guid.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"GUID Length", HFILL }},\r\n{ &hf_dtpt_guid_data,\r\n{ "Data", "dtpt.guid.data",\r\nFT_GUID, BASE_NONE, NULL, 0x0,\r\n"GUID Data", HFILL }},\r\n{ &hf_dtpt_service_instance_name,\r\n{ "Service Instance Name", "dtpt.service_instance_name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_service_class_id,\r\n{ "Service Class ID", "dtpt.service_class_id",\r\nFT_GUID, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_comment,\r\n{ "Comment", "dtpt.comment",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_ns_provider_id,\r\n{ "NS Provider ID", "dtpt.ns_provider_id",\r\nFT_GUID, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_context,\r\n{ "Context", "dtpt.context",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_protocols_number,\r\n{ "Number of Protocols", "dtpt.protocols.number",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_protocols_length,\r\n{ "Length of Protocols", "dtpt.protocols.length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_protocol_family,\r\n{ "Family", "dtpt.protocol.family",\r\nFT_UINT32, BASE_DEC, VALS(names_family), 0x0,\r\n"Protocol Family", HFILL }},\r\n{ &hf_dtpt_protocol_protocol,\r\n{ "Protocol", "dtpt.protocol.protocol",\r\nFT_UINT32, BASE_DEC, VALS(names_protocol), 0x0,\r\n"Protocol Protocol", HFILL }},\r\n{ &hf_dtpt_query_string,\r\n{ "Query String", "dtpt.query_string",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addrs_number,\r\n{ "Number of CS Addresses", "dtpt.cs_addrs.number",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addrs_length1,\r\n{ "Length of CS Addresses Part 1", "dtpt.cs_addrs.length1",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addr_socket_type,\r\n{ "Socket Type", "dtpt.cs_addrs.socket_type",\r\nFT_UINT32, BASE_DEC, VALS(names_socket_type), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addr_protocol,\r\n{ "Protocol", "dtpt.cs_addrs.protocol",\r\nFT_UINT32, BASE_DEC, VALS(names_protocol), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addr_local_pointer,\r\n{ "Local Address Pointer", "dtpt.cs_addr.local_pointer",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addr_local_length,\r\n{ "Local Address Length", "dtpt.cs_addr.local_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Local Address Pointer", HFILL }},\r\n{ &hf_dtpt_cs_addr_local,\r\n{ "Local Address", "dtpt.cs_addr.local",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addr_remote_pointer,\r\n{ "Remote Address Pointer", "dtpt.cs_addr.remote_pointer",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_cs_addr_remote_length,\r\n{ "Remote Address Length", "dtpt.cs_addr.remote_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Remote Address Pointer", HFILL }},\r\n{ &hf_dtpt_cs_addr_remote,\r\n{ "Remote Address", "dtpt.cs_addr.remote",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_dtpt_sockaddr_length,\r\n{ "Length", "dtpt.sockaddr.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Socket Address Length", HFILL }},\r\n{ &hf_dtpt_sockaddr_family,\r\n{ "Family", "dtpt.sockaddr.family",\r\nFT_UINT16, BASE_DEC, VALS(names_family), 0x0,\r\n"Socket Address Family", HFILL }},\r\n{ &hf_dtpt_sockaddr_port,\r\n{ "Port", "dtpt.sockaddr.port",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Socket Address Port", HFILL }},\r\n{ &hf_dtpt_sockaddr_address,\r\n{ "Address", "dtpt.sockaddr.address",\r\nFT_IPv4, BASE_NONE, NULL, 0x0,\r\n"Socket Address Address", HFILL }},\r\n{ &hf_dtpt_blob_rawsize,\r\n{ "Blob Size", "dtpt.blob_size",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Size of the binary BLOB", HFILL }},\r\n{ &hf_dtpt_blob_size,\r\n{ "cbSize", "dtpt.blob.cbSize",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"cbSize field in BLOB", HFILL }},\r\n{ &hf_dtpt_blob_data_pointer,\r\n{ "pBlobData", "dtpt.blob.pBlobData",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"pBlobData field in BLOB", HFILL }},\r\n{ &hf_dtpt_blob_data_length,\r\n{ "Length", "dtpt.blob.data_length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Length of the Blob Data Block", HFILL }},\r\n{ &hf_dtpt_blob_data,\r\n{ "Data", "dtpt.blob.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\n"Blob Data Block", HFILL }},\r\n{ &hf_dtpt_connect_addr,\r\n{ "Address", "dtpt.connect_addr",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Connect to Address", HFILL }},\r\n{ &hf_dtpt_padding,\r\n{ "Padding", "dtpt.padding",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dtpt,\r\n&ett_dtpt_flags,\r\n&ett_dtpt_queryset,\r\n&ett_dtpt_wstring,\r\n&ett_dtpt_guid,\r\n&ett_dtpt_protocols,\r\n&ett_dtpt_protocol,\r\n&ett_dtpt_cs_addrs,\r\n&ett_dtpt_cs_addr1,\r\n&ett_dtpt_cs_addr2,\r\n&ett_dtpt_sockaddr,\r\n&ett_dtpt_blobraw,\r\n&ett_dtpt_blob,\r\n};\r\nmodule_t *dtpt_module;\r\ne_guid_t guid_svcid_inet_hostaddrbyname = {0x0002A803, 0x0000, 0x0000, {0xC0,0,0,0,0,0,0,0x46}};\r\ne_guid_t guid_svcid_inet_hostaddrbyinetstring = {0x0002A801, 0x0000, 0x0000, {0xC0,0,0,0,0,0,0,0x46}};\r\nguids_add_guid(&guid_svcid_inet_hostaddrbyname, "SVCID_INET_HOSTADDRBYNAME");\r\nguids_add_guid(&guid_svcid_inet_hostaddrbyinetstring, "SVCID_INET_HOSTADDRBYINETSTRING");\r\nproto_dtpt = proto_register_protocol("DeskTop PassThrough Protocol",\r\n"DTPT", "dtpt");\r\nproto_register_field_array(proto_dtpt, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\ndtpt_module = prefs_register_protocol(proto_dtpt,\r\nproto_reg_handoff_dtpt);\r\nprefs_register_uint_preference(dtpt_module, "tcp.port",\r\n"DTPT Server TCP Port",\r\n"Set the TDP port for the DTPT Server",\r\n10, &gbl_dtptServerPort);\r\n}\r\nvoid\r\nproto_reg_handoff_dtpt(void)\r\n{\r\nstatic dissector_handle_t dtpt_handle;\r\nstatic gboolean Initialized=FALSE;\r\nstatic int ServerPort;\r\nif (!Initialized) {\r\ndtpt_handle = create_dissector_handle(dissect_dtpt, proto_dtpt);\r\ndtpt_conversation_handle = create_dissector_handle(dissect_dtpt_conversation, proto_dtpt);\r\nInitialized=TRUE;\r\n} else {\r\ndissector_delete_uint("tcp.port", ServerPort, dtpt_handle);\r\n}\r\nServerPort=gbl_dtptServerPort;\r\ndissector_add_uint("tcp.port", gbl_dtptServerPort, dtpt_handle);\r\n}

const char *\r\nfind_sid_name(const char *sid)\r\n{\r\nreturn (const char *)g_hash_table_lookup(sid_name_table, sid);\r\n}\r\nstatic void\r\nadd_sid_name_mapping(const char *sid, const char *name)\r\n{\r\nif (find_sid_name(sid)) {\r\nreturn;\r\n}\r\ng_hash_table_insert(sid_name_table, g_strdup(sid), g_strdup(name));\r\n}\r\nstatic int\r\nsamr_query_dispinfo(void *dummy _U_, packet_info *pinfo, epan_dissect_t *edt, const void *pri)\r\n{\r\nconst dcerpc_info *ri=(const dcerpc_info *)pri;\r\nvoid *old_ctx=NULL;\r\nchar *pol_name;\r\nchar *sid;\r\nint sid_len;\r\nint num_rids;\r\nint num_names;\r\nGPtrArray *gp;\r\nGPtrArray *gp_rids;\r\nGPtrArray *gp_names;\r\nfield_info *fi;\r\nfield_info *fi_rid;\r\nfield_info *fi_name;\r\nchar sid_name_str[256];\r\nint info_level;\r\ngp=proto_get_finfo_ptr_array(edt->tree, hf_samr_level);\r\nif(!gp || gp->len!=1){\r\nreturn 0;\r\n}\r\nfi=(field_info *)gp->pdata[0];\r\ninfo_level=fi->value.value.sinteger;\r\nif(info_level!=1){\r\nreturn 0;\r\n}\r\nif(!ri){\r\nreturn 0;\r\n}\r\nif(!ri->call_data){\r\nreturn 0;\r\n}\r\nif(ri->ptype == PDU_REQ){\r\ngp=proto_get_finfo_ptr_array(edt->tree, hf_samr_hnd);\r\nif(!gp || gp->len!=1){\r\nreturn 0;\r\n}\r\nfi=(field_info *)gp->pdata[0];\r\nold_ctx=g_hash_table_lookup(ctx_handle_table, GINT_TO_POINTER(pinfo->num));\r\nif(old_ctx){\r\ng_hash_table_remove(ctx_handle_table, GINT_TO_POINTER(pinfo->num));\r\n}\r\nif(!old_ctx){\r\nold_ctx=wmem_memdup(wmem_file_scope(), fi->value.value.bytes->data, 20);\r\n}\r\ng_hash_table_insert(ctx_handle_table, GINT_TO_POINTER(pinfo->num), old_ctx);\r\nreturn 0;\r\n}\r\nif(!ri->call_data->req_frame){\r\nreturn 0;\r\n}\r\nold_ctx=g_hash_table_lookup(ctx_handle_table, GINT_TO_POINTER(ri->call_data->req_frame));\r\nif(!old_ctx){\r\nreturn 0;\r\n}\r\nif (!dcerpc_fetch_polhnd_data((e_ctx_hnd *)old_ctx, &pol_name, NULL, NULL, NULL, ri->call_data->req_frame)) {\r\nreturn 0;\r\n}\r\nif (!pol_name)\r\nreturn 0;\r\nsid=strstr(pol_name,"S-1-5");\r\nif(!sid){\r\nreturn 0;\r\n}\r\nfor(sid_len=4;1;sid_len++){\r\nif((sid[sid_len]>='0') && (sid[sid_len]<='9')){\r\ncontinue;\r\n}\r\nif(sid[sid_len]=='-'){\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\ngp_rids=proto_get_finfo_ptr_array(edt->tree, hf_samr_rid);\r\nif(!gp_rids || gp_rids->len<1){\r\nreturn 0;\r\n}\r\nnum_rids=gp_rids->len;\r\ngp_names=proto_get_finfo_ptr_array(edt->tree, hf_samr_acct_name);\r\nif(!gp_names || gp_names->len<1){\r\nreturn 0;\r\n}\r\nnum_names=gp_names->len;\r\nif(num_rids>num_names){\r\nnum_rids=num_names;\r\n}\r\nfor(;num_rids;num_rids--){\r\nint len=sid_len;\r\nif (len > 247)\r\nlen = 247;\r\nfi_rid=(field_info *)gp_rids->pdata[num_rids-1];\r\nfi_name=(field_info *)gp_names->pdata[num_rids-1];\r\ng_strlcpy(sid_name_str, sid, 256);\r\nsid_name_str[len++]='-';\r\ng_snprintf(sid_name_str+len, 256-len, "%d",fi_rid->value.value.sinteger);\r\nadd_sid_name_mapping(sid_name_str, fi_name->value.value.string);\r\n}\r\nreturn 1;\r\n}\r\nstatic int\r\nlsa_policy_information(void *dummy _U_, packet_info *pinfo _U_, epan_dissect_t *edt, const void *pri _U_)\r\n{\r\nGPtrArray *gp;\r\nfield_info *fi;\r\nchar *domain;\r\nchar *sid;\r\nint info_level;\r\ngp=proto_get_finfo_ptr_array(edt->tree, hf_lsa_info_level);\r\nif(!gp || gp->len!=1){\r\nreturn 0;\r\n}\r\nfi=(field_info *)gp->pdata[0];\r\ninfo_level=fi->value.value.sinteger;\r\nswitch(info_level){\r\ncase 3:\r\ncase 5:\r\ncase 12:\r\ngp=proto_get_finfo_ptr_array(edt->tree, hf_lsa_domain);\r\nif(!gp || gp->len!=1){\r\nreturn 0;\r\n}\r\nfi=(field_info *)gp->pdata[0];\r\ndomain=fi->value.value.string;\r\ngp=proto_get_finfo_ptr_array(edt->tree, hf_nt_domain_sid);\r\nif(!gp || gp->len!=1){\r\nreturn 0;\r\n}\r\nfi=(field_info *)gp->pdata[0];\r\nsid=fi->value.value.string;\r\nadd_sid_name_mapping(sid, domain);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic gint\r\nctx_handle_equal(gconstpointer k1, gconstpointer k2)\r\n{\r\nint sn1 = GPOINTER_TO_INT(k1);\r\nint sn2 = GPOINTER_TO_INT(k2);\r\nreturn sn1==sn2;\r\n}\r\nstatic guint\r\nctx_handle_hash(gconstpointer k)\r\n{\r\nint sn = GPOINTER_TO_INT(k);\r\nreturn sn;\r\n}\r\nstatic void\r\nsid_snooping_init(void)\r\n{\r\nGString *error_string;\r\nif(lsa_policy_information_tap_installed){\r\nremove_tap_listener(&lsa_policy_information_tap_installed);\r\nlsa_policy_information_tap_installed=FALSE;\r\n}\r\nif(samr_query_dispinfo_tap_installed){\r\nremove_tap_listener(&samr_query_dispinfo_tap_installed);\r\nsamr_query_dispinfo_tap_installed=FALSE;\r\n}\r\nsid_name_table = g_hash_table_new_full(g_str_hash, g_str_equal,\r\ng_free, g_free);\r\nctx_handle_table = g_hash_table_new(ctx_handle_hash, ctx_handle_equal);\r\nsid_name_snooping=FALSE;\r\nif(!sid_name_snooping){\r\nreturn;\r\n}\r\n#if 0\r\nhf_lsa = proto_get_id_by_filter_name("lsa");\r\nhf_lsa_opnum = proto_registrar_get_id_byname("lsa.opnum");\r\n#endif\r\nhf_nt_domain_sid = proto_registrar_get_id_byname("nt.domain_sid");\r\nhf_lsa_domain = proto_registrar_get_id_byname("lsa.domain");\r\nhf_lsa_info_level = proto_registrar_get_id_byname("lsa.info.level");\r\nhf_samr_hnd = proto_registrar_get_id_byname("samr.handle");\r\nhf_samr_rid = proto_registrar_get_id_byname("samr.rid");\r\nhf_samr_acct_name = proto_registrar_get_id_byname("samr.acct_name");\r\nhf_samr_level = proto_registrar_get_id_byname("samr.level");\r\nerror_string=register_tap_listener("dcerpc",\r\n&lsa_policy_information_tap_installed,\r\n"lsa.policy_information and ( lsa.info.level or lsa.domain or nt.domain_sid )",\r\nTL_REQUIRES_PROTO_TREE, NULL, lsa_policy_information, NULL);\r\nif(error_string){\r\nreport_failure( "Couldn't register proto_reg_handoff_smb_sidsnooping()/lsa_policy_information tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nreturn;\r\n}\r\nlsa_policy_information_tap_installed=TRUE;\r\nerror_string=register_tap_listener("dcerpc",\r\n&samr_query_dispinfo_tap_installed,\r\n"samr and samr.opnum==40 and ( samr.handle or samr.rid or samr.acct_name or samr.level )",\r\nTL_REQUIRES_PROTO_TREE, NULL, samr_query_dispinfo, NULL);\r\nif(error_string){\r\nreport_failure( "Couldn't register proto_reg_handoff_smb_sidsnooping()/samr_query_dispinfo tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nreturn;\r\n}\r\nsamr_query_dispinfo_tap_installed=TRUE;\r\n}\r\nstatic void\r\nsid_snooping_cleanup(void)\r\n{\r\ng_hash_table_destroy(sid_name_table);\r\ng_hash_table_destroy(ctx_handle_table);\r\n}\r\nvoid\r\nproto_register_smb_sidsnooping(void)\r\n{\r\nregister_init_routine(sid_snooping_init);\r\nregister_cleanup_routine(sid_snooping_cleanup);\r\n}

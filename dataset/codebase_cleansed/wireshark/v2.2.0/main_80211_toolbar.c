static void tb80211_set_info(const char *errstr)\r\n{\r\ngtk_label_set_markup(GTK_LABEL(tb80211_info_label), errstr);\r\n}\r\nstatic\r\nvoid add_channel_type(const char *type, int oldtype, int indx )\r\n{\r\ngtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(tb80211_chan_type_box), type);\r\nif (oldtype != -1 && oldtype == ws80211_str_to_chan_type(type)) {\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(tb80211_chan_type_box), indx);\r\ntb80211_current_type = oldtype;\r\n}\r\n}\r\nstatic\r\nvoid tb80211_update_chan_type(void)\r\n{\r\nstatic unsigned int tb80211_type_cnt;\r\nunsigned int i;\r\nint oldtype = -1;\r\nfor (i = 0; i < tb80211_type_cnt; i++) {\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(tb80211_chan_type_box), 0);\r\n}\r\nif (!tb80211_current_iface) {\r\nreturn;\r\n}\r\noldtype = tb80211_current_type;\r\ntb80211_current_type = -1;\r\ni = 0;\r\nadd_channel_type(CHAN_NO_HT, oldtype, i++);\r\nif (tb80211_current_iface->channel_types & (1 << WS80211_CHAN_HT20)) {\r\nadd_channel_type(CHAN_HT20, oldtype, i++);\r\n}\r\nif (tb80211_current_iface->channel_types & (1 << WS80211_CHAN_HT40MINUS)) {\r\nadd_channel_type(CHAN_HT40MINUS, oldtype, i++);\r\n}\r\nif (tb80211_current_iface->channel_types & (1 << WS80211_CHAN_HT40PLUS)) {\r\nadd_channel_type(CHAN_HT40PLUS, oldtype, i++);\r\n}\r\ntb80211_type_cnt = i;\r\n}\r\nstatic\r\nvoid tb80211_update_freq(void)\r\n{\r\nstatic unsigned int tb80211_freq_cnt;\r\nunsigned int i;\r\ngchar *str;\r\ngint32 oldfreq = 0;\r\nfor (i = 0; i < tb80211_freq_cnt; i++) {\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(tb80211_freq_list_box), 0);\r\n}\r\noldfreq = tb80211_current_freq;\r\ntb80211_current_freq = -1;\r\nif (!tb80211_current_iface)\r\nreturn;\r\ntb80211_freq_cnt = tb80211_current_iface->frequencies->len;\r\nfor (i = 0; i < tb80211_freq_cnt; i++) {\r\nint freq;\r\nfreq = g_array_index(tb80211_current_iface->frequencies, int, i);\r\nstr = g_strdup_printf("%d MHz (%d)", freq, ieee80211_mhz_to_chan(freq));\r\ngtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(tb80211_freq_list_box), str);\r\ng_free(str);\r\nif (freq == oldfreq) {\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(tb80211_freq_list_box), i);\r\ntb80211_current_freq = oldfreq;\r\n}\r\n}\r\n}\r\nstatic\r\nvoid tb80211_update_freq_and_type(void)\r\n{\r\ntb80211_dont_set_chan = TRUE;\r\ntb80211_update_freq();\r\ntb80211_update_chan_type();\r\ntb80211_dont_set_chan = FALSE;\r\n}\r\nstatic\r\nint get_selected_channel_type(void)\r\n{\r\nint ret;\r\ngchar *s = gtk_combo_box_text_get_active_text(GTK_COMBO_BOX_TEXT(tb80211_chan_type_box));\r\nret = ws80211_str_to_chan_type(s);\r\ng_free(s);\r\nreturn ret;\r\n}\r\nstatic int\r\ntb80211_do_set_channel(char *iface, int freq, int type)\r\n{\r\ngchar *freq_s;\r\nconst gchar *type_s;\r\ngchar *data, *primary_msg, *secondary_msg;\r\nint ret;\r\nfreq_s = g_strdup_printf("%d", freq);\r\ntype_s = ws80211_chan_type_to_str(type);\r\nret = sync_interface_set_80211_chan(iface, freq_s, type_s, "-1", "-1",\r\n&data, &primary_msg, &secondary_msg, main_window_update);\r\nif (ret && primary_msg) {\r\nreturn atoi(primary_msg);\r\n}\r\ng_free(data);\r\ng_free(primary_msg);\r\ng_free(secondary_msg);\r\ng_free(freq_s);\r\nreturn ret;\r\n}\r\nstatic void\r\ntb80211_set_channel(void)\r\n{\r\ngchar *info = NULL;\r\nint err, selected_chan, new_type, new_freq;\r\nGtkComboBox *freq_combo = GTK_COMBO_BOX(tb80211_freq_list_box);\r\nGtkComboBox *type_combo = GTK_COMBO_BOX(tb80211_chan_type_box);\r\nselected_chan = gtk_combo_box_get_active(freq_combo);\r\nif (selected_chan < 0)\r\nreturn;\r\nnew_freq = g_array_index(tb80211_current_iface->frequencies, int, selected_chan);\r\nnew_type = get_selected_channel_type();\r\nerr = tb80211_do_set_channel(tb80211_current_iface->ifname, new_freq, new_type);\r\nif (err) {\r\ninfo = g_strdup_printf("<b>Failed to set channel: %s</b>", g_strerror(abs(err)));\r\nerr = tb80211_do_set_channel(tb80211_current_iface->ifname, tb80211_current_freq, tb80211_current_type);\r\nif (err) {\r\ngtk_combo_box_set_active(freq_combo, -1);\r\ngtk_combo_box_set_active(type_combo, -1);\r\ntb80211_current_freq = -1;\r\ntb80211_current_type = -1;\r\n}\r\nelse {\r\ntb80211_update_freq_and_type();\r\n}\r\n}\r\nelse {\r\ninfo = g_strdup_printf("%s Switched to %d MHz (%d)", tb80211_current_iface->ifname, new_freq, ieee80211_mhz_to_chan(new_freq));\r\ntb80211_current_freq = new_freq;\r\ntb80211_current_type = new_type;\r\n}\r\ntb80211_set_info(info);\r\ng_free(info);\r\n}\r\nstatic void\r\ntb80211_set_chan_cb(GtkWidget *widget _U_, gpointer data _U_)\r\n{\r\nif (!tb80211_current_iface || tb80211_dont_set_chan)\r\nreturn;\r\ntb80211_set_channel();\r\n}\r\nstatic void\r\ntb80211_iface_changed_cb(GtkWidget *widget, gpointer data _U_)\r\n{\r\nunsigned int i;\r\nint ret;\r\nstruct ws80211_interface *iface;\r\nstruct ws80211_iface_info iface_info;\r\ngchar *active;\r\nif (tb80211_dont_set_iface)\r\nreturn;\r\nactive = gtk_combo_box_text_get_active_text(GTK_COMBO_BOX_TEXT(widget));\r\nif (!active || tb80211_dont_set_chan)\r\ngoto out_free;\r\nfor (i = 0; i < tb80211_interfaces->len; i++) {\r\niface = g_array_index(tb80211_interfaces, struct ws80211_interface *, i);\r\nif (strcmp(active, iface->ifname) == 0) {\r\ntb80211_current_iface = iface;\r\nbreak;\r\n}\r\n}\r\ntb80211_current_freq = -1;\r\ntb80211_current_type = -1;\r\nif (tb80211_current_iface) {\r\nret = ws80211_get_iface_info(tb80211_current_iface->ifname, &iface_info);\r\nif (!ret) {\r\ntb80211_current_freq = iface_info.current_freq;\r\ntb80211_current_type = iface_info.current_chan_type;\r\n}\r\n}\r\ntb80211_update_freq_and_type();\r\nout_free:\r\ng_free(active);\r\n}\r\nvoid\r\ntb80211_refresh_interfaces(void)\r\n{\r\nstruct ws80211_interface *iface;\r\nunsigned int i;\r\ngboolean same = FALSE;\r\ngchar *selected_iface = NULL, *info;\r\nif (!tb80211_tb)\r\nreturn;\r\nif (tb80211_interfaces) {\r\nselected_iface = gtk_combo_box_text_get_active_text(GTK_COMBO_BOX_TEXT(tb80211_iface_list_box));\r\nfor (i = 0; i < tb80211_interfaces->len; i++)\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(tb80211_iface_list_box), 0);\r\nws80211_free_interfaces(tb80211_interfaces);\r\ntb80211_interfaces = NULL;\r\ntb80211_current_iface = NULL;\r\n}\r\ntb80211_interfaces = ws80211_find_interfaces();\r\nif (!tb80211_interfaces) {\r\ngoto out_free;\r\n}\r\ntb80211_dont_set_iface = TRUE;\r\nfor (i = 0; i < tb80211_interfaces->len; i++) {\r\niface = g_array_index(tb80211_interfaces, struct ws80211_interface *, i);\r\ngtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(tb80211_iface_list_box), iface->ifname);\r\nif (selected_iface && strcmp(selected_iface, iface->ifname) == 0) {\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(tb80211_iface_list_box), i);\r\ntb80211_current_iface = iface;\r\nsame = TRUE;\r\n}\r\n}\r\ntb80211_dont_set_iface = FALSE;\r\nif (!same) {\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(tb80211_iface_list_box), -1);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(tb80211_freq_list_box), -1);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(tb80211_chan_type_box), -1);\r\n}\r\ninfo = g_strdup_printf("%d monitor interfaces found", tb80211_interfaces->len);\r\ntb80211_set_info(info);\r\ng_free(info);\r\nout_free:\r\ng_free(selected_iface);\r\n}\r\nstatic void\r\ntb80211_add_label(const gchar *text, GtkWidget *tb)\r\n{\r\nGtkWidget *label;\r\nGtkToolItem *label_ti;\r\nlabel_ti = gtk_tool_item_new();\r\ngtk_widget_show(GTK_WIDGET (label_ti));\r\nlabel = gtk_label_new(text);\r\ngtk_widget_show(GTK_WIDGET (label));\r\ngtk_container_add(GTK_CONTAINER(label_ti), label);\r\ngtk_toolbar_insert(GTK_TOOLBAR(tb), label_ti, -1);\r\n}\r\nGtkWidget *\r\nws80211_toolbar_new(void)\r\n{\r\nGtkToolItem *ti;\r\nint ret;\r\ntb80211_tb = gtk_toolbar_new();\r\ngtk_orientable_set_orientation(GTK_ORIENTABLE(tb80211_tb),\r\nGTK_ORIENTATION_HORIZONTAL);\r\ngtk_widget_show(tb80211_tb);\r\ntb80211_add_label(" Interface: ", tb80211_tb);\r\nti = gtk_tool_item_new();\r\ngtk_widget_show(GTK_WIDGET (ti));\r\ntb80211_iface_list_box = gtk_combo_box_text_new();\r\ng_signal_connect(tb80211_iface_list_box, "changed", G_CALLBACK(tb80211_iface_changed_cb), NULL);\r\ngtk_container_add(GTK_CONTAINER(ti), tb80211_iface_list_box);\r\ngtk_widget_show(GTK_WIDGET (tb80211_iface_list_box));\r\ngtk_toolbar_insert(GTK_TOOLBAR(tb80211_tb), ti, -1);\r\ntb80211_add_label(" Frequency: ", tb80211_tb);\r\nti = gtk_tool_item_new();\r\ngtk_widget_show(GTK_WIDGET (ti));\r\ntb80211_freq_list_box = gtk_combo_box_text_new();\r\n#ifdef HAVE_LIBPCAP\r\ng_signal_connect(tb80211_freq_list_box, "changed", G_CALLBACK(tb80211_set_chan_cb), NULL);\r\n#else\r\ngtk_widget_set_sensitive(GTK_WIDGET(tb80211_freq_list_box), FALSE);\r\n#endif\r\ngtk_container_add(GTK_CONTAINER(ti), tb80211_freq_list_box);\r\ngtk_widget_show(GTK_WIDGET (tb80211_freq_list_box));\r\ngtk_toolbar_insert(GTK_TOOLBAR(tb80211_tb), ti, -1);\r\nti = gtk_tool_item_new();\r\ngtk_widget_show(GTK_WIDGET (ti));\r\ntb80211_chan_type_box = gtk_combo_box_text_new();\r\n#ifdef HAVE_LIBPCAP\r\ng_signal_connect(tb80211_chan_type_box, "changed", G_CALLBACK(tb80211_set_chan_cb), NULL);\r\n#else\r\ngtk_widget_set_sensitive(GTK_WIDGET(tb80211_freq_list_box), FALSE);\r\n#endif\r\ngtk_container_add(GTK_CONTAINER(ti), tb80211_chan_type_box);\r\ngtk_widget_show(GTK_WIDGET (tb80211_chan_type_box));\r\ngtk_toolbar_insert(GTK_TOOLBAR(tb80211_tb), ti, -1);\r\nti = gtk_separator_tool_item_new();\r\ngtk_widget_show(GTK_WIDGET (ti));\r\ngtk_toolbar_insert(GTK_TOOLBAR(tb80211_tb), ti, -1);\r\nti = gtk_tool_item_new();\r\ngtk_widget_show(GTK_WIDGET (ti));\r\ntb80211_info_label = gtk_label_new("");\r\ngtk_container_add(GTK_CONTAINER(ti), tb80211_info_label);\r\ngtk_widget_show(GTK_WIDGET (tb80211_info_label));\r\ngtk_toolbar_insert(GTK_TOOLBAR(tb80211_tb), ti, -1);\r\ntoolbar_redraw_all();\r\nret = ws80211_init();\r\nif(ret) {\r\ntb80211_set_info("<b>Failed to initialize ws80211</b>");\r\n} else {\r\ntb80211_refresh_interfaces();\r\n}\r\nreturn tb80211_tb;\r\n}

static void\r\nm2m_defragment_init(void)\r\n{\r\nreassembly_table_init(&pdu_reassembly_table,\r\n&addresses_reassembly_table_functions);\r\n}\r\nstatic void\r\nm2m_defragment_cleanup(void)\r\n{\r\nreassembly_table_destroy(&pdu_reassembly_table);\r\n}\r\nstatic int dissect_m2m(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti = NULL;\r\nproto_item *m2m_item = NULL;\r\nproto_tree *m2m_tree = NULL;\r\nproto_tree *tlv_tree = NULL;\r\ngint burst_number = 0;\r\ngint length, offset = 0;\r\ngint tlv_count;\r\ngint tlv_type, tlv_len, tlv_offset, tlv_value;\r\ngint tlv_frag_type = 0;\r\ngint tlv_frag_number = 0;\r\ntlv_info_t m2m_tlv_info;\r\ngint hf;\r\nguint encoding;\r\nguint frame_number;\r\nint expected_len;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WiMax");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n{\r\nm2m_item = proto_tree_add_item(tree, proto_m2m, tvb, 0, -1, ENC_NA);\r\nm2m_tree = proto_item_add_subtree(m2m_item, ett_m2m);\r\nlength = tvb_reported_length(tvb);\r\nproto_item_append_text(m2m_item, " (%u bytes)", length);\r\nproto_tree_add_item(m2m_tree, hf_m2m_sequence_number, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(m2m_tree, hf_m2m_tlv_count, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ntlv_count = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nwhile ( tlv_count > 0)\r\n{\r\ninit_tlv_info(&m2m_tlv_info, tvb, offset);\r\ntlv_type = get_tlv_type(&m2m_tlv_info);\r\ntlv_len = get_tlv_length(&m2m_tlv_info);\r\nif(tlv_type == -1 || tlv_len > 64000 || tlv_len < 1)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, ", ", "M2M TLV error");\r\nproto_tree_add_item(m2m_tree, hf_wimax_invalid_tlv, tvb, offset, (length - offset), ENC_NA);\r\nbreak;\r\n}\r\ntlv_offset = get_tlv_value_offset(&m2m_tlv_info);\r\nti = proto_tree_add_protocol_format(m2m_tree, proto_m2m, tvb, offset, (tlv_len + tlv_offset), "%s", val_to_str(tlv_type, tlv_name, "Unknown TLV"));\r\ntlv_tree = proto_item_add_subtree(ti, ett_m2m_tlv);\r\noffset += tlv_offset;\r\nexpected_len = 0;\r\nhf = 0;\r\nencoding = ENC_NA;\r\nswitch (tlv_type)\r\n{\r\ncase TLV_PROTO_VER:\r\ntlv_value = tvb_get_guint8( tvb, offset );\r\nproto_item_append_text(ti, ": %d", tlv_value);\r\nhf = hf_m2m_value_protocol_vers_uint8;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 1;\r\nbreak;\r\ncase TLV_BURST_NUM:\r\nburst_number = tvb_get_guint8( tvb, offset );\r\nproto_item_append_text(ti, ": %d", burst_number);\r\nhf = hf_m2m_value_burst_num_uint8;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 1;\r\nbreak;\r\ncase TLV_FRAG_TYPE:\r\ntlv_frag_type = tvb_get_guint8( tvb, offset );\r\nproto_item_append_text(ti, ": %s", val_to_str(tlv_frag_type, tlv_frag_type_name, "Unknown"));\r\nhf = hf_m2m_value_frag_type_uint8;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 1;\r\nbreak;\r\ncase TLV_FRAG_NUM:\r\ntlv_frag_number = tvb_get_guint8( tvb, offset );\r\nproto_item_append_text(ti, ": %d", tlv_frag_number);\r\nhf = hf_m2m_value_frag_num_uint8;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 1;\r\nbreak;\r\ncase TLV_PDU_BURST:\r\nproto_item_append_text(ti, " (%u bytes)", tlv_len);\r\npdu_burst_decoder(tree, tvb, offset, tlv_len, pinfo, burst_number, tlv_frag_type, tlv_frag_number);\r\nhf = hf_m2m_value_pdu_burst;\r\nencoding = ENC_NA;\r\nbreak;\r\ncase TLV_FAST_FB:\r\nproto_item_append_text(ti, " (%u bytes)", tlv_len);\r\nfast_feedback_burst_decoder(tree, tvb, offset, tlv_len, pinfo);\r\nhf = hf_m2m_value_fast_fb;\r\nencoding = ENC_NA;\r\nbreak;\r\ncase TLV_FRAME_NUM:\r\nframe_number = tvb_get_ntoh24( tvb, offset );\r\nproto_tree_add_item(tlv_tree, hf_m2m_frame_number, tvb, offset, 3, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ": %d", frame_number);\r\nbreak;\r\ncase TLV_FCH_BURST:\r\ntlv_value = tvb_get_ntoh24( tvb, offset );\r\nproto_item_append_text(ti, ": 0x%X", tlv_value);\r\nfch_burst_decoder(tree, tvb, offset, tlv_len, pinfo);\r\nhf = hf_m2m_value_fch_burst_uint24;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 3;\r\nbreak;\r\ncase TLV_CDMA_CODE:\r\ntlv_value = tvb_get_ntoh24( tvb, offset );\r\nproto_item_append_text(ti, ": 0x%X", tlv_value);\r\ncdma_code_decoder(tree, tvb, offset, tlv_len, pinfo);\r\nhf = hf_m2m_value_cdma_code_uint24;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 3;\r\nbreak;\r\ncase TLV_CRC16_STATUS:\r\ntlv_value = tvb_get_guint8( tvb, offset );\r\nproto_item_append_text(ti, ": %s", val_to_str(tlv_value, tlv_crc16_status, "Unknown"));\r\nhf = hf_m2m_value_crc16_status_uint8;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 1;\r\nbreak;\r\ncase TLV_BURST_POWER:\r\ntlv_value = tvb_get_ntohs( tvb, offset );\r\nproto_item_append_text(ti, ": %d", tlv_value);\r\nhf = hf_m2m_value_burst_power_uint16;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 2;\r\nbreak;\r\ncase TLV_BURST_CINR:\r\ntlv_value = tvb_get_ntohs( tvb, offset );\r\nproto_item_append_text(ti, ": 0x%X", tlv_value);\r\nhf = hf_m2m_value_burst_cinr_uint16;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 2;\r\nbreak;\r\ncase TLV_PREAMBLE:\r\ntlv_value = tvb_get_ntohs( tvb, offset );\r\nproto_item_append_text(ti, ": 0x%X", tlv_value);\r\nhf = hf_m2m_value_preamble_uint16;\r\nencoding = ENC_BIG_ENDIAN;\r\nexpected_len = 2;\r\nbreak;\r\ncase TLV_HARQ_ACK_BURST:\r\nproto_item_append_text(ti, " (%u bytes)", tlv_len);\r\nharq_ack_bursts_decoder(tree, tvb, offset, tlv_len, pinfo);\r\nhf = hf_m2m_value_harq_ack_burst_bytes;\r\nencoding = ENC_NA;\r\nbreak;\r\ncase TLV_PHY_ATTRIBUTES:\r\nproto_item_append_text(ti, " (%u bytes)", tlv_len);\r\nphysical_attributes_decoder(tree, tvb, offset, tlv_len, pinfo);\r\nhf = hf_m2m_phy_attributes;\r\nencoding = ENC_NA;\r\nbreak;\r\ncase TLV_EXTENDED_TLV:\r\nproto_item_append_text(ti, " (%u bytes)", tlv_len);\r\nextended_tlv_decoder(pinfo);\r\nbreak;\r\ndefault:\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, ", ", "Unknown TLV Type");\r\nbreak;\r\n}\r\nif (hf) {\r\nif (offset - tlv_offset == expected_len) {\r\nproto_tree_add_tlv(&m2m_tlv_info, tvb, offset - tlv_offset, pinfo, tlv_tree, hf, encoding);\r\n} else {\r\nexpert_add_info_format(pinfo, NULL, &ei_m2m_unexpected_length, "Expected length %d, got %d.", expected_len, offset - tlv_offset);\r\n}\r\n}\r\noffset += tlv_len;\r\ntlv_count--;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void fch_burst_decoder(proto_tree *tree, tvbuff_t *tvb, gint offset, gint length, packet_info *pinfo)\r\n{\r\nif(wimax_fch_burst_handle)\r\n{\r\ncall_dissector(wimax_fch_burst_handle, tvb_new_subset_length(tvb, offset, length), pinfo, tree);\r\n}\r\nelse\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "FCH Burst: DL Frame Prefix");\r\n}\r\n}\r\nstatic void cdma_code_decoder(proto_tree *tree, tvbuff_t *tvb, gint offset, gint length, packet_info *pinfo)\r\n{\r\nif(wimax_cdma_code_burst_handle)\r\n{\r\ncall_dissector(wimax_cdma_code_burst_handle, tvb_new_subset_length(tvb, offset, length), pinfo, tree);\r\n}\r\nelse\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "CDMA Code Attribute");\r\n}\r\n}\r\nstatic void pdu_burst_decoder(proto_tree *tree, tvbuff_t *tvb, gint offset, gint length, packet_info *pinfo, gint burst_number, gint frag_type, gint frag_number)\r\n{\r\nfragment_head *pdu_frag;\r\ntvbuff_t *pdu_tvb = NULL;\r\nswitch (frag_type)\r\n{\r\ncase TLV_FIRST_FRAG:\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "First TLV Fragment (%d)", frag_number);\r\nbreak;\r\ncase TLV_LAST_FRAG:\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Last TLV Fragment (%d)", frag_number);\r\nbreak;\r\ncase TLV_MIDDLE_FRAG:\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Middle TLV Fragment %d", frag_number);\r\nbreak;\r\n}\r\nif(frag_type == TLV_NO_FRAG)\r\n{\r\npdu_tvb = tvb_new_subset_length(tvb, offset, length);\r\n}\r\nelse\r\n{\r\npdu_frag = fragment_add_seq(&pdu_reassembly_table, tvb, offset, pinfo, burst_number, NULL, frag_number - 1, length, ((frag_type==TLV_LAST_FRAG)?0:1), 0);\r\nif(pdu_frag && frag_type == TLV_LAST_FRAG)\r\n{\r\npdu_tvb = tvb_new_chain(tvb, pdu_frag->tvb_data);\r\nadd_new_data_source(pinfo, pdu_tvb, "Reassembled WiMax PDU Frame");\r\n}\r\nelse\r\n{\r\npdu_tvb = NULL;\r\nif(frag_type == TLV_LAST_FRAG)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, ", ", "Incomplete PDU frame");\r\n}\r\n}\r\n}\r\nif(pdu_tvb)\r\n{\r\nif(wimax_pdu_burst_handle)\r\n{\r\ncall_dissector(wimax_pdu_burst_handle, pdu_tvb, pinfo, tree);\r\n}\r\nelse\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "PDU Burst");\r\n}\r\n}\r\n}\r\nstatic void fast_feedback_burst_decoder(proto_tree *tree, tvbuff_t *tvb, gint offset, gint length, packet_info *pinfo)\r\n{\r\nif(wimax_ffb_burst_handle)\r\n{\r\ncall_dissector(wimax_ffb_burst_handle, tvb_new_subset_length(tvb, offset, length), pinfo, tree);\r\n}\r\nelse\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Fast Feedback Burst");\r\n}\r\n}\r\nstatic void harq_ack_bursts_decoder(proto_tree *tree, tvbuff_t *tvb, gint offset, gint length, packet_info *pinfo)\r\n{\r\nif(wimax_hack_burst_handle)\r\n{\r\ncall_dissector(wimax_hack_burst_handle, tvb_new_subset_length(tvb, offset, length), pinfo, tree);\r\n}\r\nelse\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "HARQ ACK Bursts");\r\n}\r\n}\r\nstatic void physical_attributes_decoder(proto_tree *tree, tvbuff_t *tvb, gint offset, gint length, packet_info *pinfo)\r\n{\r\nif(wimax_phy_attributes_burst_handle)\r\n{\r\ncall_dissector(wimax_phy_attributes_burst_handle, tvb_new_subset_length(tvb, offset, length), pinfo, tree);\r\n}\r\nelse\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "PHY-attr");\r\n}\r\n}\r\nstatic void extended_tlv_decoder(packet_info *pinfo)\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Extended TLV");\r\n}\r\nvoid proto_tree_add_tlv(tlv_info_t *self, tvbuff_t *tvb, guint offset, packet_info *pinfo, proto_tree *tree, gint hf, guint encoding)\r\n{\r\nguint tlv_offset;\r\ngint tlv_type, tlv_len;\r\nif(!self->valid)\r\n{\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, NULL, "Invalid TLV");\r\nreturn;\r\n}\r\ntlv_offset = offset;\r\nproto_tree_add_item(tree, hf_m2m_type, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\ntlv_offset++;\r\nif( self->length_type )\r\n{\r\nproto_tree_add_item(tree, hf_m2m_len_size, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\ntlv_offset++;\r\nif(self->size_of_length)\r\nproto_tree_add_item(tree, hf_m2m_len, tvb, tlv_offset, self->size_of_length, ENC_BIG_ENDIAN);\r\nelse\r\nreturn;\r\n}\r\nelse\r\nproto_tree_add_item(tree, hf_m2m_len, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\ntlv_type = get_tlv_type(self);\r\nif ( tlv_type == TLV_FRAME_NUM )\r\n{\r\nreturn;\r\n}\r\ntlv_len = get_tlv_length(self);\r\nproto_tree_add_item(tree, hf, tvb, (offset + self->value_offset), tlv_len, encoding);\r\n}\r\nvoid proto_register_m2m(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_m2m_sequence_number,\r\n{\r\n"Packet Sequence Number", "m2m.seq_number",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_frame_number,\r\n{\r\n"Value", "m2m.frame_number",\r\nFT_UINT24, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_tlv_count,\r\n{\r\n"Number of TLVs in the packet", "m2m.tlv_count",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n}\r\n};\r\nstatic hf_register_info hf_tlv[] =\r\n{\r\n{\r\n&hf_m2m_type,\r\n{\r\n"Type", "m2m.tlv_type",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_len,\r\n{\r\n"Length", "m2m.tlv_len",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_len_size,\r\n{\r\n"Length Size", "m2m.tlv_len_size",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{\r\n&hf_m2m_value_bytes,\r\n{\r\n"Value (hex)", "m2m.multibyte_tlv_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n#endif\r\n{\r\n&hf_m2m_value_protocol_vers_uint8,\r\n{\r\n"Value", "m2m.protocol_vers_tlv_value",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_burst_num_uint8,\r\n{\r\n"Value", "m2m.burst_num_tlv_value",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_frag_type_uint8,\r\n{\r\n"Value", "m2m.frag_type_tlv_value",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_frag_num_uint8,\r\n{\r\n"Value", "m2m.frag_num_tlv_value",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_pdu_burst,\r\n{\r\n"Value (hex)", "m2m.pdu_burst_tlv_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_fast_fb,\r\n{\r\n"Value (hex)", "m2m.fast_fb_tlv_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_fch_burst_uint24,\r\n{\r\n"Value", "m2m.fch_burst_tlv_value",\r\nFT_UINT24, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_cdma_code_uint24,\r\n{\r\n"Value", "m2m.cdma_code_tlv_value",\r\nFT_UINT24, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_crc16_status_uint8,\r\n{\r\n"Value", "m2m.crc16_status_tlv_value",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_burst_power_uint16,\r\n{\r\n"Value", "m2m.burst_power_tlv_value",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_burst_cinr_uint16,\r\n{\r\n"Value", "m2m.burst_cinr_tlv_value",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_preamble_uint16,\r\n{\r\n"Value", "m2m.preamble_tlv_value",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_value_harq_ack_burst_bytes,\r\n{\r\n"Value (hex)", "m2m.harq_ack_burst_tlv_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_m2m_phy_attributes,\r\n{\r\n"Value (hex)", "m2m.phy_attributes",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_wimax_invalid_tlv,\r\n{\r\n"Invalid TLV (hex)", "m2m.invalid_tlv",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n}\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_m2m,\r\n&ett_m2m_tlv,\r\n&ett_m2m_fch,\r\n&ett_m2m_cdma,\r\n&ett_m2m_ffb,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_m2m_unexpected_length, { "m2m.unexpected_length", PI_MALFORMED, PI_ERROR, "Unexpected length", EXPFILL }},\r\n};\r\nexpert_module_t* expert_m2m;\r\nproto_m2m = proto_register_protocol (\r\n"WiMax Mac to Mac Packet",\r\n"M2M (m2m)",\r\n"m2m"\r\n);\r\nproto_register_field_array(proto_m2m, hf, array_length(hf));\r\nproto_register_field_array(proto_m2m, hf_tlv, array_length(hf_tlv));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_m2m = expert_register_protocol(proto_m2m);\r\nexpert_register_field_array(expert_m2m, ei, array_length(ei));\r\nregister_init_routine(m2m_defragment_init);\r\nregister_cleanup_routine(m2m_defragment_cleanup);\r\n}\r\nvoid proto_reg_handoff_m2m(void)\r\n{\r\ndissector_handle_t m2m_handle;\r\nm2m_handle = create_dissector_handle(dissect_m2m, proto_m2m);\r\ndissector_add_uint("ethertype", ETHERTYPE_WMX_M2M, m2m_handle);\r\nwimax_cdma_code_burst_handle = find_dissector("wimax_cdma_code_burst_handler");\r\nwimax_fch_burst_handle = find_dissector("wimax_fch_burst_handler");\r\nwimax_ffb_burst_handle = find_dissector("wimax_ffb_burst_handler");\r\nwimax_hack_burst_handle = find_dissector("wimax_hack_burst_handler");\r\nwimax_pdu_burst_handle = find_dissector("wimax_pdu_burst_handler");\r\nwimax_phy_attributes_burst_handle = find_dissector("wimax_phy_attributes_burst_handler");\r\n}

static GtkWidget *\r\ncreate_list(void)\r\n{\r\nGtkListStore *list_store;\r\nGtkWidget *list;\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeSortable *sortable;\r\nGtkTreeView *list_view;\r\nGtkTreeSelection *selection;\r\nlist_store = gtk_list_store_new(N_COLUMN,\r\nG_TYPE_STRING,\r\nG_TYPE_INT,\r\nG_TYPE_STRING,\r\nG_TYPE_INT,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING);\r\nlist = gtk_tree_view_new_with_model (GTK_TREE_MODEL (list_store));\r\nlist_view = GTK_TREE_VIEW(list);\r\nsortable = GTK_TREE_SORTABLE(list_store);\r\ngtk_tree_view_set_fixed_height_mode(list_view, TRUE);\r\ngtk_tree_sortable_set_sort_column_id(sortable, SI_COLUMN, GTK_SORT_ASCENDING);\r\ngtk_tree_view_set_headers_clickable(list_view, FALSE);\r\ng_object_unref (G_OBJECT (list_store));\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("SI", renderer,\r\n"text", SI_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, SI_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 110);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Num MSUs", renderer,\r\n"text", NUM_MSUS_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, NUM_MSUS_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("MSUs/sec", renderer,\r\n"text", NUM_MSUS_SEC_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, NUM_MSUS_SEC_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Num Bytes", renderer,\r\n"text", NUM_BYTES_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, NUM_BYTES_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Bytes/MSU", renderer,\r\n"text", NUM_BYTES_MSU_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, NUM_BYTES_MSU_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column (list_view, column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Bytes/sec", renderer,\r\n"text", NUM_BYTES_SEC_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, NUM_BYTES_SEC_COLUMN);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_append_column (list_view, column);\r\ngtk_tree_view_set_rules_hint(GTK_TREE_VIEW(list_view), TRUE);\r\ngtk_tree_view_set_headers_clickable(GTK_TREE_VIEW(list_view), TRUE);\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(list));\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_SINGLE);\r\nreturn list;\r\n}\r\nstatic void\r\nadd_string_to_box(gchar *str, GtkWidget *box)\r\n{\r\nGtkWidget *lb;\r\nlb = gtk_label_new(str);\r\ngtk_misc_set_alignment(GTK_MISC(lb), 0.0f, 0.5f);\r\ngtk_box_pack_start(GTK_BOX(box), lb,FALSE,FALSE, 0);\r\ngtk_widget_show(lb);\r\n}\r\nstatic void\r\nmtp3_sum_draw(\r\nGtkWidget *table,\r\ndouble seconds,\r\nint *tot_num_msus_p,\r\ndouble *tot_num_bytes_p)\r\n{\r\nchar *entries[N_COLUMN];\r\nint i, j;\r\nint num_msus;\r\nint num_bytes;\r\nGtkListStore *list_store;\r\nGtkTreeIter iter;\r\n*tot_num_msus_p = 0;\r\n*tot_num_bytes_p = 0;\r\nlist_store = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW (table)));\r\nfor (i=0; i < MTP3_NUM_SI_CODE; i++)\r\n{\r\nj = 0;\r\nnum_msus = 0;\r\nnum_bytes = 0;\r\nwhile (j < mtp3_num_used)\r\n{\r\nnum_msus += mtp3_stat[j].mtp3_si_code[i].num_msus;\r\nnum_bytes += mtp3_stat[j].mtp3_si_code[i].size;\r\nj++;\r\n}\r\n*tot_num_msus_p += num_msus;\r\n*tot_num_bytes_p += num_bytes;\r\nentries[2] = (seconds) ? g_strdup_printf("%.2f", (double)num_msus/seconds) : g_strdup("N/A");\r\nentries[4] = (num_msus) ? g_strdup_printf("%.2f", (double)num_bytes/num_msus) : g_strdup("N/A");\r\nentries[5] = (seconds) ? g_strdup_printf("%.2f", (double)num_bytes/seconds) : g_strdup("N/A");\r\ngtk_list_store_insert_with_values( list_store , &iter, G_MAXINT,\r\nSI_COLUMN, mtp3_service_indicator_code_short_vals[i].strptr,\r\nNUM_MSUS_COLUMN, num_msus,\r\nNUM_MSUS_SEC_COLUMN, entries[2],\r\nNUM_BYTES_COLUMN, num_bytes,\r\nNUM_BYTES_MSU_COLUMN, entries[4],\r\nNUM_BYTES_SEC_COLUMN, entries[5],\r\n-1);\r\ng_free(entries[2]);\r\ng_free(entries[4]);\r\ng_free(entries[5]);\r\n}\r\n}\r\nvoid\r\nmtp3_sum_gtk_sum_cb(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nsummary_tally summary;\r\nGtkWidget *sum_open_w;\r\nGtkWidget *main_vb, *file_fr, *data_fr, *file_box;\r\nGtkWidget *data_box, *bbox, *close_bt;\r\nGtkWidget *tot_fr, *tot_box;\r\nGtkWidget *table, *table_fr;\r\ngchar string_buff[SUM_STR_MAX];\r\nconst char *file_type;\r\ndouble seconds;\r\nint tot_num_msus;\r\ndouble tot_num_bytes;\r\nif (cfile.state == FILE_CLOSED) {\r\nreturn;\r\n}\r\nsummary_fill_in(&cfile, &summary);\r\nseconds = summary.stop_time - summary.start_time;\r\nsum_open_w = dlg_window_new("MTP3 Statistics: Summary");\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(sum_open_w), TRUE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(sum_open_w), main_vb);\r\ngtk_widget_show(main_vb);\r\nfile_fr = gtk_frame_new("File");\r\ngtk_box_pack_start(GTK_BOX(main_vb), file_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(file_fr);\r\nfile_box = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(file_fr), file_box);\r\ngtk_widget_show(file_box);\r\ng_snprintf(string_buff, SUM_STR_MAX, "Name: %s", ((summary.filename) ? summary.filename : "None"));\r\nadd_string_to_box(string_buff, file_box);\r\ng_snprintf(string_buff, SUM_STR_MAX, "Length: %" G_GINT64_MODIFIER "d", summary.file_length);\r\nadd_string_to_box(string_buff, file_box);\r\nfile_type = wtap_file_type_subtype_string(summary.file_type);\r\ng_snprintf(string_buff, SUM_STR_MAX, "Format: %s", (file_type ? file_type : "N/A"));\r\nadd_string_to_box(string_buff, file_box);\r\nif (summary.has_snap) {\r\ng_snprintf(string_buff, SUM_STR_MAX, "Snapshot length: %u", summary.snap);\r\nadd_string_to_box(string_buff, file_box);\r\n}\r\ndata_fr = gtk_frame_new("Data");\r\ngtk_box_pack_start(GTK_BOX(main_vb), data_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(data_fr);\r\ndata_box = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(data_fr), data_box);\r\ngtk_widget_show(data_box);\r\nif (summary.packet_count_ts == summary.packet_count &&\r\nsummary.packet_count_ts >= 2) {\r\ng_snprintf(string_buff, SUM_STR_MAX, "Elapsed time: %.3f seconds", summary.elapsed_time);\r\nadd_string_to_box(string_buff, data_box);\r\ng_snprintf(string_buff, SUM_STR_MAX, "Between first and last packet: %.3f seconds", seconds);\r\nadd_string_to_box(string_buff, data_box);\r\n}\r\ng_snprintf(string_buff, SUM_STR_MAX, "Packet count: %i", summary.packet_count);\r\nadd_string_to_box(string_buff, data_box);\r\ntable_fr = gtk_frame_new("Service Indicator (SI) Totals");\r\ngtk_box_pack_start(GTK_BOX(main_vb), table_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(table_fr);\r\ntable = create_list();\r\ngtk_container_add(GTK_CONTAINER(table_fr), table);\r\ngtk_widget_show(table);\r\nmtp3_sum_draw(table, seconds, &tot_num_msus, &tot_num_bytes);\r\ntot_fr = gtk_frame_new("Totals");\r\ngtk_box_pack_start(GTK_BOX(main_vb), tot_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(tot_fr);\r\ntot_box = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(tot_fr), tot_box);\r\ngtk_widget_show(tot_box);\r\ng_snprintf(string_buff, SUM_STR_MAX, "Total MSUs: %u", tot_num_msus);\r\nadd_string_to_box(string_buff, tot_box);\r\nif (summary.packet_count_ts == summary.packet_count &&\r\nsummary.packet_count_ts >= 2) {\r\nif (seconds) {\r\ng_snprintf(string_buff, SUM_STR_MAX, "MSUs/second: %.2f", tot_num_msus/seconds);\r\n}\r\nelse {\r\ng_snprintf(string_buff, SUM_STR_MAX, "MSUs/second: N/A");\r\n}\r\nadd_string_to_box(string_buff, tot_box);\r\n}\r\ng_snprintf(string_buff, SUM_STR_MAX, "Total Bytes: %.0f", tot_num_bytes);\r\nadd_string_to_box(string_buff, tot_box);\r\nif (tot_num_msus) {\r\ng_snprintf(string_buff, SUM_STR_MAX, "Average Bytes/MSU: %.2f", tot_num_bytes/tot_num_msus);\r\n}\r\nelse {\r\ng_snprintf(string_buff, SUM_STR_MAX, "Average Bytes/MSU: N/A");\r\n}\r\nadd_string_to_box(string_buff, tot_box);\r\nif (summary.packet_count_ts == summary.packet_count &&\r\nsummary.packet_count_ts >= 2) {\r\nif (seconds) {\r\ng_snprintf(string_buff, SUM_STR_MAX, "Bytes/second: %.2f", tot_num_bytes/seconds);\r\n}\r\nelse {\r\ng_snprintf(string_buff, SUM_STR_MAX, "Bytes/second: N/A");\r\n}\r\nadd_string_to_box(string_buff, tot_box);\r\n}\r\nbbox = dlg_button_row_new(GTK_STOCK_CLOSE, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(sum_open_w, close_bt, window_cancel_button_cb);\r\ng_signal_connect(sum_open_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ngtk_widget_show_all(sum_open_w);\r\nwindow_present(sum_open_w);\r\n}\r\nstatic void\r\nmtp3_summary_reset(\r\nvoid *tapdata)\r\n{\r\nmtp3_stat_t (*stat_p)[MTP3_MAX_NUM_OPC_DPC] = (mtp3_stat_t(*)[MTP3_MAX_NUM_OPC_DPC])tapdata;\r\nmtp3_num_used = 0;\r\nmemset(stat_p, 0, MTP3_MAX_NUM_OPC_DPC * sizeof(mtp3_stat_t));\r\n}\r\nstatic gboolean\r\nmtp3_summary_packet(\r\nvoid *tapdata,\r\npacket_info *pinfo _U_,\r\nepan_dissect_t *edt _U_,\r\nconst void *data)\r\n{\r\nmtp3_stat_t (*stat_p)[MTP3_MAX_NUM_OPC_DPC] = (mtp3_stat_t(*)[MTP3_MAX_NUM_OPC_DPC])tapdata;\r\nconst mtp3_tap_rec_t *data_p = (const mtp3_tap_rec_t *)data;\r\nint i;\r\nif (data_p->mtp3_si_code >= MTP3_NUM_SI_CODE)\r\n{\r\nreturn(FALSE);\r\n}\r\ni = 0;\r\nwhile (i < mtp3_num_used)\r\n{\r\nif (memcmp(&data_p->addr_opc, &(*stat_p)[i].addr_opc, sizeof(mtp3_addr_pc_t)) == 0)\r\n{\r\nif (memcmp(&data_p->addr_dpc, &(*stat_p)[i].addr_dpc, sizeof(mtp3_addr_pc_t)) == 0)\r\n{\r\nbreak;\r\n}\r\n}\r\ni++;\r\n}\r\nif (i == mtp3_num_used)\r\n{\r\nif (mtp3_num_used == MTP3_MAX_NUM_OPC_DPC)\r\n{\r\nreturn(FALSE);\r\n}\r\nmtp3_num_used++;\r\n}\r\n(*stat_p)[i].addr_opc = data_p->addr_opc;\r\n(*stat_p)[i].addr_dpc = data_p->addr_dpc;\r\n(*stat_p)[i].mtp3_si_code[data_p->mtp3_si_code].num_msus++;\r\n(*stat_p)[i].mtp3_si_code[data_p->mtp3_si_code].size += data_p->size;\r\nreturn(TRUE);\r\n}\r\nvoid\r\nregister_tap_listener_gtk_mtp3_summary(void)\r\n{\r\nGString *err_p;\r\nmemset((void *) &mtp3_stat, 0, sizeof(mtp3_stat));\r\nerr_p =\r\nregister_tap_listener("mtp3", &mtp3_stat, NULL, 0,\r\nmtp3_summary_reset,\r\nmtp3_summary_packet,\r\nNULL);\r\nif (err_p != NULL)\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK, "%s", err_p->str);\r\ng_string_free(err_p, TRUE);\r\nexit(1);\r\n}\r\n}

static void\r\ndissect_quake_CCREQ_CONNECT\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\ngint offset = 0;\r\ngint item_len;\r\nproto_tree_add_item_ret_length(tree, hf_quake_CCREQ_CONNECT_game,\r\ntvb, offset, -1, ENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\nproto_tree_add_item(tree, hf_quake_CCREQ_CONNECT_version,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void\r\ndissect_quake_CCREQ_SERVER_INFO\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\ngint offset = 0;\r\ngint item_len;\r\nproto_tree_add_item_ret_length(tree, hf_quake_CCREQ_SERVER_INFO_game,\r\ntvb, offset, -1, ENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\nproto_tree_add_item(tree, hf_quake_CCREQ_SERVER_INFO_version,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void\r\ndissect_quake_CCREQ_PLAYER_INFO\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_quake_CCREQ_PLAYER_INFO_player,\r\ntvb, 0, 1, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void\r\ndissect_quake_CCREQ_RULE_INFO\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_quake_CCREQ_RULE_INFO_lastrule,\r\ntvb, 0, -1, ENC_ASCII|ENC_NA);\r\n}\r\nstatic void\r\ndissect_quake_CCREP_ACCEPT\r\n(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint32 port;\r\nconversation_t *c;\r\nport = tvb_get_letohl(tvb, 0);\r\nc = find_or_create_conversation(pinfo);\r\nconversation_set_dissector(c, quake_handle);\r\nproto_tree_add_uint(tree, hf_quake_CCREP_ACCEPT_port,\r\ntvb, 0, 4, port);\r\n}\r\nstatic void\r\ndissect_quake_CCREP_REJECT\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, hf_quake_CCREP_REJECT_reason,\r\ntvb, 0, -1, ENC_ASCII|ENC_NA);\r\n}\r\nstatic void\r\ndissect_quake_CCREP_SERVER_INFO\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\ngint offset = 0;\r\ngint item_len;\r\nproto_tree_add_item_ret_length(tree,\r\nhf_quake_CCREP_SERVER_INFO_address, tvb, offset, -1,\r\nENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\nproto_tree_add_item_ret_length(tree,\r\nhf_quake_CCREP_SERVER_INFO_server, tvb, offset, -1,\r\nENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\nproto_tree_add_item_ret_length(tree,\r\nhf_quake_CCREP_SERVER_INFO_map, tvb, offset, -1,\r\nENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\nproto_tree_add_item(tree, hf_quake_CCREP_SERVER_INFO_num_player,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_quake_CCREP_SERVER_INFO_max_player,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_quake_CCREQ_SERVER_INFO_version,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void\r\ndissect_quake_CCREP_PLAYER_INFO\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\ngint offset = 0;\r\nguint32 colors;\r\nguint32 color_shirt;\r\nguint32 color_pants;\r\nproto_item *colors_item;\r\nproto_tree *colors_tree;\r\ngint item_len;\r\nproto_tree_add_item(tree, hf_quake_CCREQ_PLAYER_INFO_player,\r\ntvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item_ret_length(tree, hf_quake_CCREP_PLAYER_INFO_name,\r\ntvb, offset, -1, ENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\ncolors = tvb_get_letohl(tvb, offset + 0);\r\ncolor_shirt = (colors >> 4) & 0x0f;\r\ncolor_pants = (colors ) & 0x0f;\r\ncolors_item = proto_tree_add_uint(tree,\r\nhf_quake_CCREP_PLAYER_INFO_colors,\r\ntvb, offset, 4, colors);\r\ncolors_tree = proto_item_add_subtree(colors_item,\r\nett_quake_control_colors);\r\nproto_tree_add_uint(colors_tree,\r\nhf_quake_CCREP_PLAYER_INFO_colors_shirt,\r\ntvb, offset, 1, color_shirt);\r\nproto_tree_add_uint(colors_tree,\r\nhf_quake_CCREP_PLAYER_INFO_colors_pants,\r\ntvb, offset, 1, color_pants);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_quake_CCREP_PLAYER_INFO_frags,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_quake_CCREP_PLAYER_INFO_connect_time,\r\ntvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_quake_CCREP_PLAYER_INFO_address,\r\ntvb, offset, -1, ENC_ASCII|ENC_NA);\r\n}\r\nstatic void\r\ndissect_quake_CCREP_RULE_INFO\r\n(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\ngint offset = 0;\r\ngint item_len;\r\nif (tvb_reported_length(tvb) == 0) return;\r\nproto_tree_add_item_ret_length(tree, hf_quake_CCREP_RULE_INFO_rule,\r\ntvb, offset, -1, ENC_ASCII|ENC_NA, &item_len);\r\noffset += item_len;\r\nproto_tree_add_item(tree, hf_quake_CCREP_RULE_INFO_value,\r\ntvb, offset, -1, ENC_ASCII|ENC_NA);\r\n}\r\nstatic void\r\ndissect_quake_control(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 command;\r\nint direction;\r\nproto_tree *control_tree;\r\ntvbuff_t *next_tvb;\r\ncommand = tvb_get_guint8(tvb, 0);\r\ndirection = (command & 0x80) ? CCREP : CCREQ;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s %s",\r\nval_to_str(command,names_control_command, "%u"),\r\nval_to_str(direction,names_control_direction,"%u"));\r\ncontrol_tree = proto_tree_add_subtree_format(tree, tvb,\r\n0, -1, ett_quake_control, NULL, "Control %s: %s",\r\nval_to_str(direction, names_control_direction, "%u"),\r\nval_to_str(command, names_control_command, "%u"));\r\nproto_tree_add_uint(control_tree, hf_quake_control_command,\r\ntvb, 0, 1, command);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 1);\r\nswitch (command) {\r\ncase CCREQ_CONNECT:\r\ndissect_quake_CCREQ_CONNECT\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREQ_SERVER_INFO:\r\ndissect_quake_CCREQ_SERVER_INFO\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREQ_PLAYER_INFO:\r\ndissect_quake_CCREQ_PLAYER_INFO\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREQ_RULE_INFO:\r\ndissect_quake_CCREQ_RULE_INFO\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREP_ACCEPT:\r\ndissect_quake_CCREP_ACCEPT\r\n(next_tvb, pinfo, control_tree);\r\nbreak;\r\ncase CCREP_REJECT:\r\ndissect_quake_CCREP_REJECT\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREP_SERVER_INFO:\r\ndissect_quake_CCREP_SERVER_INFO\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREP_PLAYER_INFO:\r\ndissect_quake_CCREP_PLAYER_INFO\r\n(next_tvb, control_tree);\r\nbreak;\r\ncase CCREP_RULE_INFO:\r\ndissect_quake_CCREP_RULE_INFO\r\n(next_tvb, control_tree);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(next_tvb, pinfo, control_tree);\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_quake(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *quake_tree;\r\nproto_item *quake_item;\r\nguint16 flags;\r\nproto_item *flags_item;\r\nproto_tree *flags_tree;\r\nguint32 sequence = 0;\r\ntvbuff_t *next_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "QUAKE");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nflags = tvb_get_ntohs(tvb, 2);\r\nquake_item = proto_tree_add_item(tree, proto_quake, tvb, 0, -1, ENC_NA);\r\nquake_tree = proto_item_add_subtree(quake_item, ett_quake);\r\nflags_item = proto_tree_add_item(quake_tree, hf_quake_header_flags,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nflags_tree = proto_item_add_subtree(flags_item, ett_quake_flags);\r\nproto_tree_add_item(flags_tree, hf_quake_header_flags_data,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_quake_header_flags_ack,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_quake_header_flags_no_ack,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_quake_header_flags_endmsg,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_quake_header_flags_unreliable,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(flags_tree, hf_quake_header_flags_control,\r\ntvb, 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(quake_tree, hf_quake_header_length, tvb, 0, 2, ENC_BIG_ENDIAN);\r\nif (flags == NETFLAG_CTL) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, 4);\r\ndissect_quake_control(next_tvb, pinfo, quake_tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nsequence = tvb_get_ntohl(tvb, 4);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "seq 0x%x", sequence);\r\nproto_tree_add_uint(quake_tree, hf_quake_header_sequence,\r\ntvb, 4, 4, sequence);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 8);\r\ncall_data_dissector(next_tvb, pinfo, quake_tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_quake(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_quake_header_flags,\r\n{ "Flags", "quake.header.flags",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_flags_data,\r\n{ "Data", "quake.header.flags.data",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), NETFLAG_DATA,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_flags_ack,\r\n{ "Acknowledgment", "quake.header.flags.ack",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), NETFLAG_ACK,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_flags_no_ack,\r\n{ "No Acknowledgment", "quake.header.flags.no_ack",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), NETFLAG_NAK,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_flags_endmsg,\r\n{ "End Of Message", "quake.header.flags.endmsg",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), NETFLAG_EOM,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_flags_unreliable,\r\n{ "Unreliable", "quake.header.flags.unreliable",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), NETFLAG_UNRELIABLE,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_flags_control,\r\n{ "Control", "quake.header.flags.control",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), NETFLAG_CTL,\r\nNULL, HFILL }},\r\n{ &hf_quake_header_length,\r\n{ "Length", "quake.header.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"full data length", HFILL }},\r\n{ &hf_quake_header_sequence,\r\n{ "Sequence", "quake.header.sequence",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"Sequence Number", HFILL }},\r\n{ &hf_quake_control_command,\r\n{ "Command", "quake.control.command",\r\nFT_UINT8, BASE_HEX, VALS(names_control_command), 0x0,\r\n"Control Command", HFILL }},\r\n{ &hf_quake_CCREQ_CONNECT_game,\r\n{ "Game", "quake.control.connect.game",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Game Name", HFILL }},\r\n{ &hf_quake_CCREQ_CONNECT_version,\r\n{ "Version", "quake.control.connect.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Game Protocol Version Number", HFILL }},\r\n{ &hf_quake_CCREQ_SERVER_INFO_game,\r\n{ "Game", "quake.control.server_info.game",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Game Name", HFILL }},\r\n{ &hf_quake_CCREQ_SERVER_INFO_version,\r\n{ "Version", "quake.control.server_info.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Game Protocol Version Number", HFILL }},\r\n{ &hf_quake_CCREQ_PLAYER_INFO_player,\r\n{ "Player", "quake.control.player_info.player",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_quake_CCREQ_RULE_INFO_lastrule,\r\n{ "Last Rule", "quake.control.rule_info.lastrule",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Last Rule Name", HFILL }},\r\n{ &hf_quake_CCREP_ACCEPT_port,\r\n{ "Port", "quake.control.accept.port",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Game Data Port", HFILL }},\r\n{ &hf_quake_CCREP_REJECT_reason,\r\n{ "Reason", "quake.control.reject.reason",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Reject Reason", HFILL }},\r\n{ &hf_quake_CCREP_SERVER_INFO_address,\r\n{ "Address", "quake.control.server_info.address",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Server Address", HFILL }},\r\n{ &hf_quake_CCREP_SERVER_INFO_server,\r\n{ "Server", "quake.control.server_info.server",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Server Name", HFILL }},\r\n{ &hf_quake_CCREP_SERVER_INFO_map,\r\n{ "Map", "quake.control.server_info.map",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Map Name", HFILL }},\r\n{ &hf_quake_CCREP_SERVER_INFO_num_player,\r\n{ "Number of Players", "quake.control.server_info.num_player",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Current Number of Players", HFILL }},\r\n{ &hf_quake_CCREP_SERVER_INFO_max_player,\r\n{ "Maximal Number of Players", "quake.control.server_info.max_player",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_name,\r\n{ "Name", "quake.control.player_info.name",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Player Name", HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_colors,\r\n{ "Colors", "quake.control.player_info.colors",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"Player Colors", HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_colors_shirt,\r\n{ "Shirt", "quake.control.player_info.colors.shirt",\r\nFT_UINT8, BASE_DEC, VALS(names_colors), 0x0,\r\n"Shirt Color", HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_colors_pants,\r\n{ "Pants", "quake.control.player_info.colors.pants",\r\nFT_UINT8, BASE_DEC, VALS(names_colors), 0x0,\r\n"Pants Color", HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_frags,\r\n{ "Frags", "quake.control.player_info.frags",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Player Frags", HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_connect_time,\r\n{ "Connect Time", "quake.control.player_info.connect_time",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"Player Connect Time", HFILL }},\r\n{ &hf_quake_CCREP_PLAYER_INFO_address,\r\n{ "Address", "quake.control.player_info.address",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Player Address", HFILL }},\r\n{ &hf_quake_CCREP_RULE_INFO_rule,\r\n{ "Rule", "quake.control.rule_info.rule",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Rule Name", HFILL }},\r\n{ &hf_quake_CCREP_RULE_INFO_value,\r\n{ "Value", "quake.control.rule_info.value",\r\nFT_STRINGZ, BASE_NONE, NULL, 0x0,\r\n"Rule Value", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_quake,\r\n&ett_quake_control,\r\n&ett_quake_control_colors,\r\n&ett_quake_flags,\r\n};\r\nmodule_t *quake_module;\r\nproto_quake = proto_register_protocol("Quake Network Protocol",\r\n"QUAKE", "quake");\r\nproto_register_field_array(proto_quake, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nquake_module = prefs_register_protocol(proto_quake,\r\nproto_reg_handoff_quake);\r\nprefs_register_uint_preference(quake_module, "udp.port",\r\n"Quake Server UDP Port",\r\n"Set the UDP port for the Quake Server",\r\n10, &gbl_quakeServerPort);\r\n}\r\nvoid\r\nproto_reg_handoff_quake(void)\r\n{\r\nstatic gboolean Initialized=FALSE;\r\nstatic guint ServerPort;\r\nif (!Initialized) {\r\nquake_handle = create_dissector_handle(dissect_quake, proto_quake);\r\nInitialized=TRUE;\r\n} else {\r\ndissector_delete_uint("udp.port", ServerPort, quake_handle);\r\n}\r\nServerPort=gbl_quakeServerPort;\r\ndissector_add_uint("udp.port", gbl_quakeServerPort, quake_handle);\r\n}

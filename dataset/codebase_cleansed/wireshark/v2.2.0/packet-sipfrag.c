static int dissect_sipfrag(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *sipfrag_tree;\r\nproto_item *ti;\r\ngint offset = 0;\r\ngint next_offset;\r\nint linelen;\r\nchar *string;\r\ngint lines = 0;\r\ncol_append_str(pinfo->cinfo, COL_PROTOCOL, "/sipfrag");\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", with Sipfrag");\r\nti = proto_tree_add_item(tree, proto_sipfrag, tvb, offset, -1, ENC_NA);\r\nsipfrag_tree = proto_item_add_subtree(ti, ett_sipfrag);\r\nwhile (tvb_offset_exists(tvb, offset))\r\n{\r\nlinelen = tvb_find_line_end_unquoted(tvb, offset, -1, &next_offset);\r\nstring = (char*)tvb_get_string_enc(wmem_packet_scope(), tvb, offset, linelen, ENC_ASCII);\r\nproto_tree_add_string_format(sipfrag_tree, hf_sipfrag_line,\r\ntvb, offset,\r\nlinelen, string,\r\n"%s", string);\r\nlines++;\r\nif (lines == 1) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "(%s", string);\r\n}\r\noffset = next_offset;\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, (lines > 1) ? "...)" : ")");\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_sipfrag(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_sipfrag_line,\r\n{ "Line",\r\n"sipfrag.line",FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_sipfrag\r\n};\r\nproto_sipfrag = proto_register_protocol("Sipfrag", "SIPFRAG", "sipfrag");\r\nproto_register_field_array(proto_sipfrag, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("sipfrag", dissect_sipfrag, proto_sipfrag);\r\n}\r\nvoid proto_reg_handoff_sipfrag(void)\r\n{\r\ndissector_handle_t sipfrag_handle = find_dissector("sipfrag");\r\ndissector_add_string("media_type", "message/sipfrag", sipfrag_handle);\r\n}

static int\r\ndissect_hyperscsi(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint hs_hdr1, hs_hdr2, hs_hdr3;\r\nguint8 hs_res;\r\nguint16 hs_tagno;\r\nguint16 hs_fragno;\r\ngint offset = 0;\r\nproto_tree *hs_hdr_tree, *hs_pdu_tree;\r\nproto_tree *hs_tree;\r\nproto_item *ti;\r\nguint8 hs_cmd, hs_ver;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "HyperSCSI");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_hyperscsi, tvb, offset, -1, ENC_NA);\r\nhs_tree = proto_item_add_subtree(ti, ett_hyperscsi);\r\nhs_hdr1 = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nhs_hdr2 = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nhs_hdr3 = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nhs_res = hs_hdr1 >> 4;\r\nhs_tagno = ((hs_hdr1 & 0x0F) << 5 ) | (hs_hdr2 >> 3);\r\nhs_fragno = ((hs_hdr2 &0X03) << 8 ) | hs_hdr3;\r\nif (tree) {\r\nhs_hdr_tree = proto_tree_add_subtree(hs_tree, tvb, 0, 3, ett_hs_hdr, NULL, "HyperSCSI Header");\r\nproto_tree_add_uint(hs_hdr_tree, hf_hs_res, tvb, 0, 1, hs_res);\r\nproto_tree_add_uint(hs_hdr_tree, hf_hs_tagno, tvb, 0, 2, hs_tagno);\r\nproto_tree_add_item(hs_hdr_tree, hf_hs_lastfrag, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(hs_hdr_tree, hf_hs_fragno, tvb, 1, 2, hs_fragno);\r\n}\r\nhs_ver = tvb_get_guint8(tvb, offset++);\r\nhs_cmd = tvb_get_guint8(tvb, offset);\r\nhs_cmd &= OPCODE_MASK;\r\ncol_append_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(hs_cmd, hscsi_opcodes, "Unknown HyperSCSI Request or Response (%u)"));\r\nif (tree) {\r\nhs_pdu_tree = proto_tree_add_subtree(hs_tree, tvb, 3, -1, ett_hs_pdu, NULL, "HyperSCSI PDU");\r\nproto_tree_add_uint(hs_pdu_tree, hf_hs_ver, tvb, 3, 1, hs_ver);\r\nproto_tree_add_uint(hs_pdu_tree, hf_hs_cmd, tvb, 4, 1, hs_cmd);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_hyperscsi(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_hs_res,\r\n{ "Reserved", "hyperscsi.reserved", FT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_hs_tagno,\r\n{ "Tag No", "hyperscsi.tagno", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_hs_lastfrag,\r\n{ "Last Fragment", "hyperscsi.lastfrag", FT_BOOLEAN, 8, TFS(&tfs_lastfrag), 0x04, NULL, HFILL}},\r\n{ &hf_hs_fragno,\r\n{ "Fragment No", "hyperscsi.fragno", FT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_hs_ver,\r\n{ "HyperSCSI Version", "hyperscsi.version", FT_UINT8, BASE_DEC, NULL,\r\n0x0, NULL, HFILL}},\r\n{ &hf_hs_cmd,\r\n{ "HyperSCSI Command", "hyperscsi.cmd", FT_UINT8, BASE_DEC, VALS(hscsi_opcodes), 0x0,\r\nNULL, HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_hyperscsi,\r\n&ett_hs_hdr,\r\n&ett_hs_pdu,\r\n};\r\nproto_hyperscsi = proto_register_protocol("HyperSCSI", "HyperSCSI", "hyperscsi");\r\nproto_register_field_array(proto_hyperscsi, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("hyperscsi", dissect_hyperscsi, proto_hyperscsi);\r\n}\r\nvoid\r\nproto_reg_handoff_hyperscsi(void)\r\n{\r\ndissector_handle_t hs_handle;\r\nhs_handle = find_dissector("hyperscsi");\r\ndissector_add_uint("ethertype", ETHERTYPE_HYPERSCSI, hs_handle);\r\n}

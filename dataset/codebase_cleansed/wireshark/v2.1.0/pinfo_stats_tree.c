static void *uat_plen_record_copy_cb(void *n, const void *o, size_t siz _U_) {\r\nconst uat_plen_record_t *r = (const uat_plen_record_t *)o;\r\nuat_plen_record_t *rn = (uat_plen_record_t *)n;\r\nif (r->packet_range)\r\nrn->packet_range = range_copy(r->packet_range);\r\nreturn n;\r\n}\r\nstatic gboolean\r\nuat_plen_record_update_cb(void *r, char **err)\r\n{\r\nuat_plen_record_t *rec = (uat_plen_record_t*)r;\r\nif (rec->packet_range->nranges < 1) {\r\n*err = g_strdup("Invalid range string");\r\nreturn FALSE;\r\n}\r\n*err = NULL;\r\nreturn TRUE;\r\n}\r\nstatic void uat_plen_record_free_cb(void*r) {\r\nuat_plen_record_t *record = (uat_plen_record_t*)r;\r\nif (record->packet_range)\r\ng_free(record->packet_range);\r\n}\r\nstatic void uat_plen_record_post_update_cb(void) {\r\nguint i, num_default;\r\nuat_plen_record_t rec;\r\nif (num_plen_uat == 0) {\r\nnum_default = sizeof(default_range)/sizeof(range_t);\r\nfor (i = 0; i < num_default; i++)\r\n{\r\nrec.packet_range = &default_range[i];\r\nuat_add_record(plen_uat, &rec, TRUE);\r\n}\r\n}\r\n}\r\nstatic void ipv4_hosts_stats_tree_init(stats_tree *st) {\r\nst_node_ipv4 = stats_tree_create_node(st, st_str_ipv4, 0, TRUE);\r\n}\r\nstatic void ipv6_hosts_stats_tree_init(stats_tree *st) {\r\nst_node_ipv6 = stats_tree_create_node(st, st_str_ipv6, 0, TRUE);\r\n}\r\nstatic int ip_hosts_stats_tree_packet(stats_tree *st, packet_info *pinfo, int st_node, const gchar *st_str) {\r\ntick_stat_node(st, st_str, 0, FALSE);\r\ntick_stat_node(st, address_to_str(pinfo->pool, &pinfo->net_src), st_node, FALSE);\r\ntick_stat_node(st, address_to_str(pinfo->pool, &pinfo->net_dst), st_node, FALSE);\r\nreturn 1;\r\n}\r\nstatic int ipv4_hosts_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nreturn ip_hosts_stats_tree_packet(st, pinfo, st_node_ipv4, st_str_ipv4);\r\n}\r\nstatic int ipv6_hosts_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nreturn ip_hosts_stats_tree_packet(st, pinfo, st_node_ipv6, st_str_ipv6);\r\n}\r\nstatic void ip_srcdst_stats_tree_init(stats_tree *st,\r\nconst gchar *st_str_src, int *st_node_src_ptr,\r\nconst gchar *st_str_dst, int *st_node_dst_ptr) {\r\n*st_node_src_ptr = stats_tree_create_node(st, st_str_src, 0, TRUE);\r\nstat_node_set_flags(st, st_str_src, 0, FALSE, ST_FLG_SORT_TOP);\r\n*st_node_dst_ptr = stats_tree_create_node(st, st_str_dst, 0, TRUE);\r\nstat_node_set_flags(st, st_str_dst, 0, FALSE, ST_FLG_DEF_NOEXPAND);\r\n}\r\nstatic void ipv4_srcdst_stats_tree_init(stats_tree *st) {\r\nip_srcdst_stats_tree_init(st, st_str_ipv4_src, &st_node_ipv4_src, st_str_ipv4_dst, &st_node_ipv4_dst);\r\n}\r\nstatic void ipv6_srcdst_stats_tree_init(stats_tree *st) {\r\nip_srcdst_stats_tree_init(st, st_str_ipv6_src, &st_node_ipv6_src, st_str_ipv6_dst, &st_node_ipv6_dst);\r\n}\r\nstatic int ip_srcdst_stats_tree_packet(stats_tree *st, packet_info *pinfo,\r\nint st_node_src, const gchar *st_str_src,\r\nint st_node_dst, const gchar *st_str_dst) {\r\ntick_stat_node(st, st_str_src, 0, FALSE);\r\ntick_stat_node(st, address_to_str(pinfo->pool, &pinfo->net_src), st_node_src, FALSE);\r\ntick_stat_node(st, st_str_dst, 0, FALSE);\r\ntick_stat_node(st, address_to_str(pinfo->pool, &pinfo->net_dst), st_node_dst, FALSE);\r\nreturn 1;\r\n}\r\nstatic int ipv4_srcdst_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nreturn ip_srcdst_stats_tree_packet(st, pinfo, st_node_ipv4_src, st_str_ipv4_src, st_node_ipv4_dst, st_str_ipv4_dst);\r\n}\r\nstatic int ipv6_srcdst_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nreturn ip_srcdst_stats_tree_packet(st, pinfo, st_node_ipv6_src, st_str_ipv6_src, st_node_ipv6_dst, st_str_ipv6_dst);\r\n}\r\nstatic void ipv4_ptype_stats_tree_init(stats_tree *st) {\r\nst_node_ipv4_ptype = stats_tree_create_pivot(st, st_str_ipv4_ptype, 0);\r\n}\r\nstatic void ipv6_ptype_stats_tree_init(stats_tree *st) {\r\nst_node_ipv6_ptype = stats_tree_create_pivot(st, st_str_ipv6_ptype, 0);\r\n}\r\nstatic int ipv4_ptype_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nstats_tree_tick_pivot(st, st_node_ipv4_ptype, port_type_to_str(pinfo->ptype));\r\nreturn 1;\r\n}\r\nstatic int ipv6_ptype_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nstats_tree_tick_pivot(st, st_node_ipv6_ptype, port_type_to_str(pinfo->ptype));\r\nreturn 1;\r\n}\r\nstatic void ipv4_dsts_stats_tree_init(stats_tree *st) {\r\nst_node_ipv4_dsts = stats_tree_create_node(st, st_str_ipv4_dsts, 0, TRUE);\r\n}\r\nstatic void ipv6_dsts_stats_tree_init(stats_tree *st) {\r\nst_node_ipv6_dsts = stats_tree_create_node(st, st_str_ipv6_dsts, 0, TRUE);\r\n}\r\nstatic int dsts_stats_tree_packet(stats_tree *st, packet_info *pinfo, int st_node, const gchar *st_str) {\r\nstatic gchar str[128];\r\nint ip_dst_node;\r\nint protocol_node;\r\ntick_stat_node(st, st_str, 0, FALSE);\r\nip_dst_node = tick_stat_node(st, address_to_str(pinfo->pool, &pinfo->net_dst), st_node, TRUE);\r\nprotocol_node = tick_stat_node(st, port_type_to_str(pinfo->ptype), ip_dst_node, TRUE);\r\ng_snprintf(str, sizeof(str) - 1, "%u", pinfo->destport);\r\ntick_stat_node(st, str, protocol_node, TRUE);\r\nreturn 1;\r\n}\r\nstatic int ipv4_dsts_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nreturn dsts_stats_tree_packet(st, pinfo, st_node_ipv4_dsts, st_str_ipv4_dsts);\r\n}\r\nstatic int ipv6_dsts_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\nreturn dsts_stats_tree_packet(st, pinfo, st_node_ipv6_dsts, st_str_ipv6_dsts);\r\n}\r\nstatic void plen_stats_tree_init(stats_tree *st) {\r\nguint i;\r\nchar **str_range_array = (char **)wmem_alloc(NULL, num_plen_uat*sizeof(char*));\r\nfor (i = 0; i < num_plen_uat - 1; i++) {\r\nstr_range_array[i] = range_convert_range(NULL, uat_plen_records[i].packet_range);\r\n}\r\nstr_range_array[num_plen_uat - 1] = g_strdup_printf("%u and greater",\r\nuat_plen_records[num_plen_uat - 1].packet_range->ranges[0].low);\r\nst_node_plen = stats_tree_create_range_node_string(st, st_str_plen, 0, num_plen_uat, str_range_array);\r\nfor (i = 0; i < num_plen_uat; i++) {\r\nwmem_free(NULL, str_range_array[i]);\r\n}\r\n}\r\nstatic int plen_stats_tree_packet(stats_tree *st, packet_info *pinfo, epan_dissect_t *edt _U_, const void *p _U_) {\r\ntick_stat_node(st, st_str_plen, 0, FALSE);\r\nstats_tree_tick_range(st, st_str_plen, 0, pinfo->fd->pkt_len);\r\nreturn 1;\r\n}\r\nvoid register_pinfo_stat_trees(void) {\r\nmodule_t *stat_module;\r\nstatic uat_field_t plen_uat_flds[] = {\r\nUAT_FLD_RANGE(uat_plen_records, packet_range, "Packet Range", 0xFFFFFFFF, "Range of packet sizes to count"),\r\nUAT_END_FIELDS\r\n};\r\nstats_tree_register_plugin("ip", "ip_hosts", st_str_ipv4, 0, ipv4_hosts_stats_tree_packet, ipv4_hosts_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ip", "ip_srcdst", st_str_ipv4_srcdst, 0, ipv4_srcdst_stats_tree_packet, ipv4_srcdst_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ip", "ptype", st_str_ipv4_ptype, 0, ipv4_ptype_stats_tree_packet, ipv4_ptype_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ip", "dests", st_str_ipv4_dsts, 0, ipv4_dsts_stats_tree_packet, ipv4_dsts_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ipv6", "ipv6_hosts", st_str_ipv6, 0, ipv6_hosts_stats_tree_packet, ipv6_hosts_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ipv6", "ipv6_srcdst", st_str_ipv6_srcdst, 0, ipv6_srcdst_stats_tree_packet, ipv6_srcdst_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ipv6", "ipv6_ptype", st_str_ipv6_ptype, 0, ipv6_ptype_stats_tree_packet, ipv6_ptype_stats_tree_init, NULL );\r\nstats_tree_register_plugin("ipv6", "ipv6_dests", st_str_ipv6_dsts, 0, ipv6_dsts_stats_tree_packet, ipv6_dsts_stats_tree_init, NULL );\r\nstats_tree_register_with_group("frame", "plen", st_str_plen, 0, plen_stats_tree_packet, plen_stats_tree_init, NULL, REGISTER_STAT_GROUP_GENERIC);\r\nstat_module = prefs_register_stat("stat_tree", "Stats Tree", "Stats Tree", NULL);\r\nplen_uat = uat_new("Packet Lengths",\r\nsizeof(uat_plen_record_t),\r\n"packet_lengths",\r\nTRUE,\r\n&uat_plen_records,\r\n&num_plen_uat,\r\n0,\r\nNULL,\r\nuat_plen_record_copy_cb,\r\nuat_plen_record_update_cb,\r\nuat_plen_record_free_cb,\r\nuat_plen_record_post_update_cb,\r\nplen_uat_flds);\r\nprefs_register_uat_preference(stat_module, "packet_lengths",\r\n"Packet Lengths", "Delineated packet sizes to count", plen_uat);\r\n}

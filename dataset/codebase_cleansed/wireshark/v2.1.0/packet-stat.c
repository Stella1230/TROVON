static int\r\nmy_id_len(tvbuff_t *tvb, int offset)\r\n{\r\nint len;\r\nlen = tvb_get_ntohl(tvb, offset);\r\nif(len&0x03)\r\nlen = (len&0xfc)+4;\r\nlen += 16;\r\nreturn len;\r\n}\r\nstatic int\r\nmon_id_len(tvbuff_t *tvb, int offset)\r\n{\r\nint len;\r\nlen = tvb_get_ntohl(tvb, offset);\r\nif(len&0x03){\r\nlen = (len&0xfc)+4;\r\n}\r\nlen += 4;\r\nreturn len+my_id_len(tvb,offset+len);\r\n}\r\nstatic int\r\ndissect_stat_stat(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_rpc_string(tvb,tree,hfi_stat_mon_name.id,0,NULL);\r\n}\r\nstatic int\r\ndissect_stat_stat_res(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\ngint32 res;\r\nint offset = 0;\r\nsub_item = proto_tree_add_item(tree, &hfi_stat_stat_res, tvb,\r\noffset, -1, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_stat_stat_res);\r\nres = tvb_get_ntohl(tvb, offset);\r\noffset = dissect_rpc_uint32(tvb,sub_tree,hfi_stat_stat_res_res.id,offset);\r\nif (res==STAT_SUCC) {\r\noffset = dissect_rpc_uint32(tvb,sub_tree,hfi_stat_stat_res_state.id,offset);\r\n} else {\r\noffset += 4;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_stat_my_id(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nsub_item = proto_tree_add_item(tree, &hfi_stat_my_id, tvb,\r\noffset, my_id_len(tvb,offset), ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_stat_my_id);\r\noffset = dissect_rpc_string(tvb,sub_tree,hfi_stat_my_id_hostname.id,offset,NULL);\r\noffset = dissect_rpc_uint32(tvb,sub_tree,hfi_stat_my_id_prog.id,offset);\r\noffset = dissect_rpc_uint32(tvb,sub_tree,hfi_stat_my_id_vers.id,offset);\r\noffset = dissect_rpc_uint32(tvb,sub_tree,hfi_stat_my_id_proc.id,offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_stat_mon_id(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nint offset = 0;\r\nsub_item = proto_tree_add_item(tree, &hfi_stat_mon, tvb,\r\noffset, mon_id_len(tvb,offset), ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_stat_mon);\r\noffset = dissect_rpc_string(tvb,sub_tree,hfi_stat_mon_id_name.id,offset,NULL);\r\noffset = dissect_stat_my_id(tvb,offset,sub_tree);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_stat_priv(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nproto_tree_add_item(tree, &hfi_stat_priv, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_stat_mon(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nint offset = dissect_stat_mon_id(tvb,pinfo,tree,data);\r\noffset = dissect_stat_priv(tvb,offset,tree);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_stat_state(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_rpc_uint32(tvb,tree,hfi_stat_state.id,0);\r\n}\r\nstatic int\r\ndissect_stat_notify(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nint offset = 0;\r\nint start_offset = offset;\r\nsub_item = proto_tree_add_item(tree, &hfi_stat_stat_chge, tvb,\r\noffset, -1, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_stat_stat_chge);\r\noffset = dissect_rpc_string(tvb,sub_tree,hfi_stat_mon_id_name.id,offset,NULL);\r\noffset = dissect_rpc_uint32(tvb,tree,hfi_stat_state.id,offset);\r\nif(sub_item)\r\nproto_item_set_len(sub_item, offset - start_offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_stat_umon_all(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_stat_my_id(tvb,0,tree);\r\n}\r\nvoid\r\nproto_register_stat(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_stat_procedure_v1,\r\n&hfi_stat_mon_name,\r\n&hfi_stat_stat_res,\r\n&hfi_stat_stat_res_res,\r\n&hfi_stat_stat_res_state,\r\n&hfi_stat_mon,\r\n&hfi_stat_mon_id_name,\r\n&hfi_stat_my_id,\r\n&hfi_stat_my_id_hostname,\r\n&hfi_stat_my_id_prog,\r\n&hfi_stat_my_id_vers,\r\n&hfi_stat_my_id_proc,\r\n&hfi_stat_priv,\r\n&hfi_stat_state,\r\n&hfi_stat_stat_chge,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_stat,\r\n&ett_stat_stat_res,\r\n&ett_stat_mon,\r\n&ett_stat_my_id,\r\n&ett_stat_stat_chge,\r\n};\r\nint proto_stat;\r\nproto_stat = proto_register_protocol("Network Status Monitor Protocol", "STAT", "stat");\r\nhfi_stat = proto_registrar_get_nth(proto_stat);\r\nproto_register_fields(proto_stat, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_stat(void)\r\n{\r\nrpc_init_prog(hfi_stat->id, STAT_PROGRAM, ett_stat,\r\nG_N_ELEMENTS(stat_vers_info), stat_vers_info);\r\n}

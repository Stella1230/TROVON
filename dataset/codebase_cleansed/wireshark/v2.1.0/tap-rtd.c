static void\r\nrtd_draw(void *arg)\r\n{\r\nrtd_data_t* rtd_data = (rtd_data_t*)arg;\r\nrtd_t* rtd = (rtd_t*)rtd_data->user_data;\r\ngchar* tmp_str;\r\nguint i, j;\r\nprintf("\n");\r\nprintf("=====================================================================================================\n");\r\nprintf("%s Response Time Delay (RTD) Statistics:\n", rtd->type);\r\nprintf("Filter for statistics: %s\n", rtd->filter ? rtd->filter : "");\r\nif (rtd_data->stat_table.num_rtds == 1)\r\n{\r\nprintf("Duplicate requests: %u\n", rtd_data->stat_table.time_stats[0].req_dup_num);\r\nprintf("Duplicate responses: %u\n", rtd_data->stat_table.time_stats[0].rsp_dup_num);\r\nprintf("Open requests: %u\n", rtd_data->stat_table.time_stats[0].open_req_num);\r\nprintf("Discarded responses: %u\n", rtd_data->stat_table.time_stats[0].disc_rsp_num);\r\nprintf("Type | Messages | Min RTD | Max RTD | Avg RTD | Min in Frame | Max in Frame |\n");\r\nfor (i=0; i<rtd_data->stat_table.time_stats[0].num_timestat; i++) {\r\nif (rtd_data->stat_table.time_stats[0].rtd[i].num) {\r\ntmp_str = val_to_str_wmem(NULL, i, rtd->vs_type, "Other (%d)");\r\nprintf("%s | %7u | %8.2f msec | %8.2f msec | %8.2f msec | %10u | %10u |\n",\r\ntmp_str, rtd_data->stat_table.time_stats[0].rtd[i].num,\r\nnstime_to_msec(&(rtd_data->stat_table.time_stats[0].rtd[i].min)), nstime_to_msec(&(rtd_data->stat_table.time_stats[0].rtd[i].max)),\r\nget_average(&(rtd_data->stat_table.time_stats[0].rtd[i].tot), rtd_data->stat_table.time_stats[0].rtd[i].num),\r\nrtd_data->stat_table.time_stats[0].rtd[i].min_num, rtd_data->stat_table.time_stats[0].rtd[i].max_num\r\n);\r\nwmem_free(NULL, tmp_str);\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nprintf("Type | Messages | Min RTD | Max RTD | Avg RTD | Min in Frame | Max in Frame | Open Requests | Discarded responses | Duplicate requests | Duplicate responses\n");\r\nfor (i=0; i<rtd_data->stat_table.num_rtds; i++) {\r\nfor (j=0; j<rtd_data->stat_table.time_stats[i].num_timestat; j++) {\r\nif (rtd_data->stat_table.time_stats[i].rtd[j].num) {\r\ntmp_str = val_to_str_wmem(NULL, i, rtd->vs_type, "Other (%d)");\r\nprintf("%s | %7u | %8.2f msec | %8.2f msec | %8.2f msec | %10u | %10u | %10u | %10u | %4u (%4.2f%%) | %4u (%4.2f%%) |\n",\r\ntmp_str, rtd_data->stat_table.time_stats[i].rtd[j].num,\r\nnstime_to_msec(&(rtd_data->stat_table.time_stats[i].rtd[j].min)), nstime_to_msec(&(rtd_data->stat_table.time_stats[i].rtd[j].max)),\r\nget_average(&(rtd_data->stat_table.time_stats[i].rtd[j].tot), rtd_data->stat_table.time_stats[i].rtd[j].num),\r\nrtd_data->stat_table.time_stats[i].rtd[j].min_num, rtd_data->stat_table.time_stats[i].rtd[j].max_num,\r\nrtd_data->stat_table.time_stats[i].open_req_num, rtd_data->stat_table.time_stats[i].disc_rsp_num,\r\nrtd_data->stat_table.time_stats[i].req_dup_num,\r\nrtd_data->stat_table.time_stats[i].rtd[j].num?((double)rtd_data->stat_table.time_stats[i].req_dup_num*100)/(double)rtd_data->stat_table.time_stats[i].rtd[j].num:0,\r\nrtd_data->stat_table.time_stats[i].rsp_dup_num,\r\nrtd_data->stat_table.time_stats[i].rtd[j].num?((double)rtd_data->stat_table.time_stats[i].rsp_dup_num*100)/(double)rtd_data->stat_table.time_stats[i].rtd[j].num:0\r\n);\r\nwmem_free(NULL, tmp_str);\r\n}\r\n}\r\n}\r\n}\r\nprintf("=====================================================================================================\n");\r\n}\r\nstatic void\r\ninit_rtd_tables(register_rtd_t* rtd, const char *filter)\r\n{\r\nGString *error_string;\r\nrtd_t* ui;\r\nui = g_new0(rtd_t, 1);\r\nui->type = proto_get_protocol_short_name(find_protocol_by_id(get_rtd_proto_id(rtd)));\r\nui->filter = g_strdup(filter);\r\nui->vs_type = get_rtd_value_string(rtd);\r\nui->rtd.user_data = ui;\r\nrtd_table_dissector_init(rtd, &ui->rtd.stat_table, NULL, NULL);\r\nerror_string = register_tap_listener(get_rtd_tap_listener_name(rtd), &ui->rtd, filter, 0, NULL, get_rtd_packet_func(rtd), rtd_draw);\r\nif (error_string) {\r\nfree_rtd_table(&ui->rtd.stat_table, NULL, NULL);\r\nfprintf(stderr, "tshark: Couldn't register srt tap: %s\n", error_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nstatic void\r\ndissector_rtd_init(const char *opt_arg, void* userdata)\r\n{\r\nregister_rtd_t *rtd = (register_rtd_t*)userdata;\r\nconst char *filter=NULL;\r\nchar* err = NULL;\r\nrtd_table_get_filter(rtd, opt_arg, &filter, &err);\r\nif (err != NULL)\r\n{\r\nfprintf(stderr, "tshark: %s\n", err);\r\ng_free(err);\r\nexit(1);\r\n}\r\ninit_rtd_tables(rtd, filter);\r\n}\r\nvoid\r\nregister_rtd_tables(gpointer data, gpointer user_data _U_)\r\n{\r\nregister_rtd_t *rtd = (register_rtd_t*)data;\r\nstat_tap_ui ui_info;\r\nui_info.group = REGISTER_STAT_GROUP_RESPONSE_TIME;\r\nui_info.title = NULL;\r\nui_info.cli_string = rtd_table_get_tap_string(rtd);\r\nui_info.tap_init_cb = dissector_rtd_init;\r\nui_info.nparams = 0;\r\nui_info.params = NULL;\r\nregister_stat_tap_ui(&ui_info, rtd);\r\n}

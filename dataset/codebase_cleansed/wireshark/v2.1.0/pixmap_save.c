void\r\npixmap_save_cb(GtkWidget *w, gpointer pixmap_ptr _U_)\r\n{\r\nGtkWidget *save_as_w;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nsurface_info_t *surface_info = (surface_info_t *)g_object_get_data(G_OBJECT(w), "surface-info");\r\n#else\r\nGdkPixmap *pixmap = (GdkPixmap *)g_object_get_data(G_OBJECT(w), "pixmap");\r\n#endif\r\nGdkPixbuf *pixbuf;\r\nGdkPixbufFormat *pixbuf_format;\r\nGtkWidget *main_vb, *save_as_type_hb, *type_lb, *type_cm;\r\nGSList *file_formats,*ffp;\r\nGtkWidget *parent;\r\ngchar *format_name;\r\nguint format_index = 0;\r\nguint default_index = 0;\r\ngchar *filename, *file_type;\r\nGError *error = NULL;\r\ngboolean ret;\r\nGtkWidget *msg_dialog;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\npixbuf = gdk_pixbuf_get_from_surface (surface_info->surface,\r\n0, 0, surface_info->width, surface_info->height);\r\n#else\r\npixbuf = gdk_pixbuf_get_from_drawable(NULL, pixmap, NULL,\r\n0, 0, 0, 0, -1, -1);\r\n#endif\r\nif(!pixbuf) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"%sCould not get image from graph%s",\r\nsimple_dialog_primary_start(),\r\nsimple_dialog_primary_end());\r\nreturn;\r\n}\r\nparent = gtk_widget_get_toplevel(w);\r\nsave_as_w = file_selection_new("Wireshark: Save Graph As ...",\r\nGTK_WINDOW(parent),\r\nFILE_SELECTION_SAVE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\nfile_selection_set_extra_widget(save_as_w, main_vb);\r\ngtk_widget_show(main_vb);\r\nsave_as_type_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), save_as_type_hb, FALSE, FALSE, 0);\r\ngtk_widget_show(save_as_type_hb);\r\ntype_lb = gtk_label_new("File type: ");\r\ngtk_box_pack_start(GTK_BOX(save_as_type_hb), type_lb, FALSE, FALSE, 0);\r\ngtk_widget_show(type_lb);\r\ntype_cm = gtk_combo_box_text_new();\r\ngtk_box_pack_start(GTK_BOX(save_as_type_hb), type_cm, FALSE, FALSE, 0);\r\nfile_formats = gdk_pixbuf_get_formats();\r\nffp = file_formats;\r\nwhile(ffp) {\r\npixbuf_format = (GdkPixbufFormat *)ffp->data;\r\nif (gdk_pixbuf_format_is_writable(pixbuf_format)) {\r\nformat_name = gdk_pixbuf_format_get_name(pixbuf_format);\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(type_cm),\r\nformat_name);\r\nif (!(g_ascii_strcasecmp(format_name, "png")))\r\ndefault_index = format_index;\r\nformat_index++;\r\n}\r\nffp = g_slist_next(ffp);\r\n}\r\ng_slist_free(file_formats);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(type_cm), default_index);\r\ngtk_widget_show(type_cm);\r\ngtk_widget_show(save_as_w);\r\nwindow_present(save_as_w);\r\nfor (;;) {\r\nif (gtk_dialog_run(GTK_DIALOG(save_as_w)) != GTK_RESPONSE_ACCEPT) {\r\nwindow_destroy(save_as_w);\r\nreturn;\r\n}\r\nfilename = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(save_as_w));\r\nif (test_for_directory(filename) == EISDIR) {\r\nset_last_open_dir(filename);\r\ng_free(filename);\r\nfile_selection_set_current_folder(save_as_w,\r\nget_last_open_dir());\r\ngtk_file_chooser_set_current_name(GTK_FILE_CHOOSER(save_as_w), "");\r\ncontinue;\r\n}\r\nfile_type = gtk_combo_box_text_get_active_text(GTK_COMBO_BOX_TEXT(type_cm));\r\nret = gdk_pixbuf_save(pixbuf, filename, file_type, &error, NULL);\r\ng_free(filename);\r\ng_free(file_type);\r\nif (!ret) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(save_as_w),\r\nGTK_DIALOG_DESTROY_WITH_PARENT,\r\nGTK_MESSAGE_ERROR,\r\nGTK_BUTTONS_OK,\r\n"%s", error->message);\r\ngtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\ncontinue;\r\n}\r\nwindow_destroy(save_as_w);\r\nreturn;\r\n}\r\n}

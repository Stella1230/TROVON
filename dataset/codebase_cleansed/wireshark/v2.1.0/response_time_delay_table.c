static void\r\nrtd_set_title(rtd_t *rr)\r\n{\r\ngchar *str;\r\nstr = g_strdup_printf("%s Service Response Time statistics", proto_get_protocol_short_name(find_protocol_by_id(get_rtd_proto_id(rr->rtd))));\r\nset_window_title(rr->gtk_data.win, str);\r\ng_free(str);\r\n}\r\nstatic void\r\nwin_destroy_cb(GtkWindow *win _U_, gpointer data)\r\n{\r\nrtd_t *rr = (rtd_t*)data;\r\nremove_tap_listener(&rr->data);\r\nfree_rtd_table(&rr->data.stat_table, NULL, NULL);\r\ng_free(rr);\r\n}\r\nstatic void\r\ninit_gtk_rtd_table(rtd_stat_table* rtd, void* gui_data)\r\n{\r\ngtk_rtd_t* gtk_data = (gtk_rtd_t*)gui_data;\r\nif (rtd->num_rtds == 1)\r\n{\r\ngtk_window_set_default_size(GTK_WINDOW(gtk_data->win), RTD_PREFERRED_WIDTH, 300);\r\ngtk_data->open_req_label = gtk_label_new("Open Requests: 0");\r\ngtk_box_pack_start(GTK_BOX(gtk_data->vbox), gtk_data->open_req_label, FALSE, FALSE, 0);\r\ngtk_widget_show(gtk_data->open_req_label);\r\ngtk_data->dis_rsp_label = gtk_label_new("Discarded Responses: 0");\r\ngtk_box_pack_start(GTK_BOX(gtk_data->vbox), gtk_data->dis_rsp_label, FALSE, FALSE, 0);\r\ngtk_widget_show(gtk_data->dis_rsp_label);\r\ngtk_data->repeat_req_label = gtk_label_new("Repeated Requests: 0");\r\ngtk_box_pack_start(GTK_BOX(gtk_data->vbox), gtk_data->repeat_req_label, FALSE, FALSE, 0);\r\ngtk_widget_show(gtk_data->repeat_req_label);\r\ngtk_data->repeat_rsp_label = gtk_label_new("Repeated Responses: 0");\r\ngtk_box_pack_start(GTK_BOX(gtk_data->vbox), gtk_data->repeat_rsp_label, FALSE, FALSE, 0);\r\ngtk_widget_show(gtk_data->repeat_rsp_label);\r\ngtk_data->table = create_stat_table(gtk_data->scrolled_window, gtk_data->vbox, 7, titles);\r\n}\r\nelse\r\n{\r\ngtk_window_set_default_size(GTK_WINDOW(gtk_data->win), RTD_PREFERRED_WIDTH+100, 200);\r\ngtk_data->table = create_stat_table(gtk_data->scrolled_window, gtk_data->vbox, 11, titles_more);\r\n}\r\n}\r\nstatic void\r\nrtd_draw(void *arg)\r\n{\r\nGtkListStore *store;\r\nrtd_data_t* rtd_data = (rtd_data_t*)arg;\r\nrtd_t* rtd = (rtd_t*)rtd_data->user_data;\r\nrtd_timestat *ms;\r\nGtkTreeIter iter;\r\nchar str[5][256];\r\ngchar* tmp_str;\r\nguint i, j;\r\nchar label_str[256];\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(rtd->gtk_data.table));\r\ngtk_list_store_clear(store);\r\nif (rtd_data->stat_table.num_rtds == 1)\r\n{\r\nms = &rtd_data->stat_table.time_stats[0];\r\ng_snprintf(label_str, sizeof(char[256]), "Open Requests: %u", ms->open_req_num);\r\ngtk_label_set_text(GTK_LABEL(rtd->gtk_data.open_req_label), label_str);\r\ng_snprintf(label_str, sizeof(char[256]), "Discarded Responses: %u", ms->disc_rsp_num);\r\ngtk_label_set_text(GTK_LABEL(rtd->gtk_data.dis_rsp_label), label_str);\r\ng_snprintf(label_str, sizeof(char[256]), "Repeated Requests: %u", ms->req_dup_num);\r\ngtk_label_set_text(GTK_LABEL(rtd->gtk_data.repeat_req_label), label_str);\r\ng_snprintf(label_str, sizeof(char[256]), "Repeated Responses: %u", ms->rsp_dup_num);\r\ngtk_label_set_text(GTK_LABEL(rtd->gtk_data.repeat_rsp_label), label_str);\r\nfor(i=0;i<ms->num_timestat;i++)\r\n{\r\nif(ms->rtd[i].num==0){\r\ncontinue;\r\n}\r\ng_snprintf(str[0], sizeof(char[256]), "%8.2f msec", nstime_to_msec(&(ms->rtd[i].min)));\r\ng_snprintf(str[1], sizeof(char[256]), "%8.2f msec", nstime_to_msec(&(ms->rtd[i].max)));\r\ng_snprintf(str[2], sizeof(char[256]), "%8.2f msec", get_average(&(ms->rtd[i].tot), ms->rtd[i].num));\r\ntmp_str = val_to_str_wmem(NULL, i, get_rtd_value_string(rtd->rtd), "Other (%d)");\r\ngtk_list_store_append(store, &iter);\r\ngtk_list_store_set(store, &iter,\r\nTYPE_COLUMN, tmp_str,\r\nMESSAGES_COLUMN, ms->rtd[i].num,\r\nMIN_SRT_COLUMN, str[0],\r\nMAX_SRT_COLUMN, str[1],\r\nAVG_SRT_COLUMN, str[2],\r\nMIN_FRAME_COLUMN, ms->rtd[i].min_num,\r\nMAX_FRAME_COLUMN, ms->rtd[i].max_num,\r\n-1);\r\nwmem_free(NULL, tmp_str);\r\n}\r\n}\r\nelse\r\n{\r\nfor (i=0; i<rtd_data->stat_table.num_rtds; i++)\r\n{\r\nfor (j=0; j<rtd_data->stat_table.time_stats[i].num_timestat; j++)\r\n{\r\nif(rtd_data->stat_table.time_stats[i].rtd[j].num==0){\r\ncontinue;\r\n}\r\ng_snprintf(str[0], 256, "%8.2f msec", nstime_to_msec(&(rtd_data->stat_table.time_stats[i].rtd[j].min)));\r\ng_snprintf(str[1], 256, "%8.2f msec", nstime_to_msec(&(rtd_data->stat_table.time_stats[i].rtd[j].max)));\r\ng_snprintf(str[2], 256, "%8.2f msec", get_average(&(rtd_data->stat_table.time_stats[i].rtd[j].tot), rtd_data->stat_table.time_stats[i].rtd[j].num));\r\ng_snprintf(str[3], 256, "%4u (%4.2f%%)", rtd_data->stat_table.time_stats[i].req_dup_num,\r\nrtd_data->stat_table.time_stats[i].rtd[j].num?((double)rtd_data->stat_table.time_stats[i].req_dup_num*100)/(double)rtd_data->stat_table.time_stats[i].rtd[j].num:0);\r\ng_snprintf(str[4], 256, "%4u (%4.2f%%)", rtd_data->stat_table.time_stats[i].rsp_dup_num,\r\nrtd_data->stat_table.time_stats[i].rtd[j].num?((double)rtd_data->stat_table.time_stats[i].rsp_dup_num*100)/(double)rtd_data->stat_table.time_stats[i].rtd[j].num:0);\r\ntmp_str = val_to_str_wmem(NULL, i, get_rtd_value_string(rtd->rtd), "Other (%d)");\r\ngtk_list_store_append(store, &iter);\r\ngtk_list_store_set(store, &iter,\r\nTYPE_COLUMN, tmp_str,\r\nMESSAGES_COLUMN, rtd_data->stat_table.time_stats[i].rtd[j].num,\r\nMIN_SRT_COLUMN, str[0],\r\nMAX_SRT_COLUMN, str[1],\r\nAVG_SRT_COLUMN, str[2],\r\nMIN_FRAME_COLUMN, rtd_data->stat_table.time_stats[i].rtd[j].min_num,\r\nMAX_FRAME_COLUMN, rtd_data->stat_table.time_stats[i].rtd[j].max_num,\r\nOPEN_REQUESTS_COLUMN, rtd_data->stat_table.time_stats[i].open_req_num,\r\nDISCARDED_RESPONSES_COLUMN, rtd_data->stat_table.time_stats[i].disc_rsp_num,\r\nREPEATED_REQUESTS_COLUMN, str[3],\r\nREPEATED_RESPONSES_COLUMN, str[4],\r\n-1);\r\nwmem_free(NULL, tmp_str);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nreset_table_data(rtd_stat_table* table _U_, void* gui_data)\r\n{\r\nGtkListStore *store;\r\ngtk_rtd_t* gtk_data = (gtk_rtd_t*)gui_data;\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(gtk_data->table));\r\ngtk_list_store_clear(store);\r\n}\r\nstatic void\r\nrtd_reset(void *arg)\r\n{\r\nrtd_data_t *rtd = (rtd_data_t*)arg;\r\nrtd_t *rr = (rtd_t *)rtd->user_data;\r\nreset_rtd_table(&rtd->stat_table, reset_table_data, &rr->gtk_data);\r\nrtd_set_title(rr);\r\n}\r\nstatic void\r\ninit_rtd_tables(register_rtd_t* rtd, const char *filter)\r\n{\r\nrtd_t *rr;\r\ngchar *str;\r\nGString *error_string;\r\nGtkWidget *bbox;\r\nGtkWidget *close_bt;\r\nrr = g_new0(rtd_t, 1);\r\nstr = g_strdup_printf("%s SRT", proto_get_protocol_short_name(find_protocol_by_id(get_rtd_proto_id(rtd))));\r\nrr->gtk_data.win=dlg_window_new(str);\r\ng_free(str);\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(rr->gtk_data.win), TRUE);\r\nrr->gtk_data.vbox=ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\nstr = g_strdup_printf("%s Service Response Time statistics", proto_get_protocol_short_name(find_protocol_by_id(get_rtd_proto_id(rtd))));\r\ninit_main_stat_window(rr->gtk_data.win, rr->gtk_data.vbox, str, filter);\r\ng_free(str);\r\nrr->gtk_data.scrolled_window = scrolled_window_new(NULL, NULL);\r\nrr->type = proto_get_protocol_short_name(find_protocol_by_id(get_rtd_proto_id(rtd)));\r\nrr->filter = g_strdup(filter);\r\nrr->rtd = rtd;\r\nrr->data.user_data = rr;\r\nrtd_table_dissector_init(rtd, &rr->data.stat_table, init_gtk_rtd_table, &rr->gtk_data);\r\nerror_string = register_tap_listener(get_rtd_tap_listener_name(rtd), &rr->data, filter, 0, rtd_reset, get_rtd_packet_func(rtd), rtd_draw);\r\nif(error_string){\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", error_string->str);\r\ng_string_free(error_string, TRUE);\r\nfree_rtd_table(&rr->data.stat_table, NULL, NULL);\r\ng_free(rr);\r\nreturn;\r\n}\r\nbbox = dlg_button_row_new(GTK_STOCK_CLOSE, NULL);\r\ngtk_box_pack_end(GTK_BOX(rr->gtk_data.vbox), bbox, FALSE, FALSE, 0);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(rr->gtk_data.win, close_bt, window_cancel_button_cb);\r\ng_signal_connect(rr->gtk_data.win, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(rr->gtk_data.win, "destroy", G_CALLBACK(win_destroy_cb), rr);\r\ngtk_widget_show_all(rr->gtk_data.win);\r\nwindow_present(rr->gtk_data.win);\r\ncf_retap_packets(&cfile);\r\ngdk_window_raise(gtk_widget_get_window(rr->gtk_data.win));\r\n}\r\nstatic void\r\ngtk_rtdstat_init(const char *opt_arg, void *userdata _U_)\r\n{\r\ngchar** dissector_name;\r\nregister_rtd_t *rtd;\r\nconst char *filter=NULL;\r\nchar* err;\r\ndissector_name = g_strsplit(opt_arg, ",", -1);\r\ng_assert(dissector_name[0]);\r\nrtd = get_rtd_table_by_name(dissector_name[0]);\r\ng_assert(rtd);\r\nrtd_table_get_filter(rtd, opt_arg, &filter, &err);\r\nif (err != NULL)\r\n{\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", err);\r\ng_free(err);\r\nreturn;\r\n}\r\ninit_rtd_tables(rtd, filter);\r\n}\r\nvoid register_response_time_delay_tables(gpointer data, gpointer user_data _U_)\r\n{\r\nregister_rtd_t* rtd = (register_rtd_t*)data;\r\nconst char* short_name = proto_get_protocol_short_name(find_protocol_by_id(get_rtd_proto_id(rtd)));\r\ntap_param_dlg* rtd_dlg;\r\nrtd_dlg = g_new(tap_param_dlg, 1);\r\nrtd_dlg->win_title = g_strdup_printf("%s RTD Statistics", short_name);\r\nrtd_dlg->init_string = rtd_table_get_tap_string(rtd);\r\nrtd_dlg->tap_init_cb = gtk_rtdstat_init;\r\nrtd_dlg->index = -1;\r\nrtd_dlg->nparams = G_N_ELEMENTS(rtd_stat_params);\r\nrtd_dlg->params = rtd_stat_params;\r\nrtd_dlg->user_data = rtd;\r\nregister_param_stat(rtd_dlg, short_name, REGISTER_STAT_GROUP_RESPONSE_TIME);\r\n}

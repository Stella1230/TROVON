wtap_open_return_val capsa_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nchar magic[sizeof capsa_magic];\r\nguint16 format_indicator;\r\nint file_type_subtype;\r\nguint32 number_of_frames;\r\ncapsa_t *capsa;\r\nif (!wtap_read_bytes(wth->fh, magic, sizeof magic, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (memcmp(magic, capsa_magic, sizeof capsa_magic) != 0) {\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nif (!wtap_read_bytes(wth->fh, &format_indicator, sizeof format_indicator,\r\nerr, err_info))\r\nreturn WTAP_OPEN_ERROR;\r\nformat_indicator = GUINT16_FROM_LE(format_indicator);\r\nswitch (format_indicator) {\r\ncase 1:\r\nfile_type_subtype = WTAP_FILE_TYPE_SUBTYPE_COLASOFT_CAPSA;\r\nbreak;\r\ncase 2:\r\nfile_type_subtype = WTAP_FILE_TYPE_SUBTYPE_COLASOFT_PACKET_BUILDER;\r\nbreak;\r\ndefault:\r\n*err = WTAP_ERR_UNSUPPORTED;\r\n*err_info = g_strdup_printf("capsa: format indicator %u unsupported",\r\nformat_indicator);\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nif (!file_skip(wth->fh, 2, err))\r\nreturn WTAP_OPEN_ERROR;\r\nif (!file_skip(wth->fh, 4, err))\r\nreturn WTAP_OPEN_ERROR;\r\nif (!file_skip(wth->fh, 4, err))\r\nreturn WTAP_OPEN_ERROR;\r\nif (!file_skip(wth->fh, 4, err))\r\nreturn WTAP_OPEN_ERROR;\r\nif (!wtap_read_bytes(wth->fh, &number_of_frames, sizeof number_of_frames,\r\nerr, err_info))\r\nreturn WTAP_OPEN_ERROR;\r\nnumber_of_frames = GUINT32_FROM_LE(number_of_frames);\r\nif (!file_seek(wth->fh, 0x44ef, SEEK_SET, err))\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_type_subtype = file_type_subtype;\r\ncapsa = (capsa_t *)g_malloc(sizeof(capsa_t));\r\ncapsa->format_indicator = format_indicator;\r\ncapsa->number_of_frames = number_of_frames;\r\ncapsa->frame_count = 0;\r\nwth->priv = (void *)capsa;\r\nwth->subtype_read = capsa_read;\r\nwth->subtype_seek_read = capsa_seek_read;\r\nwth->file_encap = WTAP_ENCAP_ETHERNET;\r\nwth->snapshot_length = 0;\r\nwth->file_tsprec = WTAP_TSPREC_USEC;\r\nreturn WTAP_OPEN_MINE;\r\n}\r\nstatic gboolean capsa_read(wtap *wth, int *err, gchar **err_info,\r\ngint64 *data_offset)\r\n{\r\ncapsa_t *capsa = (capsa_t *)wth->priv;\r\nguint32 frame_within_block;\r\nint padbytes;\r\nif (capsa->frame_count == capsa->number_of_frames) {\r\n*err = 0;\r\nreturn FALSE;\r\n}\r\nframe_within_block = capsa->frame_count % N_RECORDS_PER_GROUP;\r\nif (frame_within_block == 0) {\r\ncapsa->base_offset = file_tell(wth->fh);\r\nif (!file_skip(wth->fh, 1, err))\r\nreturn FALSE;\r\nif (!wtap_read_bytes(wth->fh, &capsa->record_offsets,\r\nsizeof capsa->record_offsets, err, err_info))\r\nreturn FALSE;\r\nif (!file_skip(wth->fh, 4, err))\r\nreturn FALSE;\r\n}\r\n*data_offset = capsa->base_offset +\r\nGUINT32_FROM_LE(capsa->record_offsets[frame_within_block]);\r\nif (!file_seek(wth->fh, *data_offset, SEEK_SET, err))\r\nreturn FALSE;\r\npadbytes = capsa_read_packet(wth, wth->fh, &wth->phdr,\r\nwth->frame_buffer, err, err_info);\r\nif (padbytes == -1)\r\nreturn FALSE;\r\nif (padbytes != 0) {\r\nif (!file_skip(wth->fh, padbytes, err))\r\nreturn FALSE;\r\n}\r\ncapsa->frame_count++;\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\ncapsa_seek_read(wtap *wth, gint64 seek_off,\r\nstruct wtap_pkthdr *phdr, Buffer *buf, int *err, gchar **err_info)\r\n{\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nif (capsa_read_packet(wth, wth->random_fh, phdr, buf, err, err_info) == -1) {\r\nif (*err == 0)\r\n*err = WTAP_ERR_SHORT_READ;\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic int\r\ncapsa_read_packet(wtap *wth, FILE_T fh, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\ncapsa_t *capsa = (capsa_t *)wth->priv;\r\nstruct capsarec_hdr capsarec_hdr;\r\nstruct pbrec_hdr pbrec_hdr;\r\nguint32 rec_size;\r\nguint32 packet_size;\r\nguint32 orig_size;\r\nguint32 header_size;\r\nguint64 timestamp;\r\nswitch (capsa->format_indicator) {\r\ncase 1:\r\nif (!wtap_read_bytes_or_eof(fh, &capsarec_hdr,\r\nsizeof capsarec_hdr, err, err_info))\r\nreturn -1;\r\nrec_size = GUINT16_FROM_LE(capsarec_hdr.rec_len);\r\norig_size = GUINT16_FROM_LE(capsarec_hdr.orig_len);\r\npacket_size = GUINT16_FROM_LE(capsarec_hdr.incl_len);\r\nheader_size = sizeof capsarec_hdr;\r\ntimestamp = (((guint64)GUINT32_FROM_LE(capsarec_hdr.timestamphi))<<32) + GUINT32_FROM_LE(capsarec_hdr.timestamplo);\r\nif (!file_skip(fh, (capsarec_hdr.count1 + capsarec_hdr.count2)*4,\r\nerr))\r\nreturn -1;\r\nheader_size += (capsarec_hdr.count1 + capsarec_hdr.count2)*4;\r\nbreak;\r\ncase 2:\r\nif (!wtap_read_bytes_or_eof(fh, &pbrec_hdr,\r\nsizeof pbrec_hdr, err, err_info))\r\nreturn -1;\r\nrec_size = GUINT16_FROM_LE(pbrec_hdr.rec_len);\r\norig_size = GUINT16_FROM_LE(pbrec_hdr.orig_len);\r\npacket_size = GUINT16_FROM_LE(pbrec_hdr.incl_len);\r\nheader_size = sizeof pbrec_hdr;\r\ntimestamp = (((guint64)GUINT32_FROM_LE(pbrec_hdr.timestamphi))<<32) + GUINT32_FROM_LE(pbrec_hdr.timestamplo);\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n*err = WTAP_ERR_INTERNAL;\r\nreturn -1;\r\n}\r\nif (orig_size > WTAP_MAX_PACKET_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("capsa: File has %u-byte original length, bigger than maximum of %u",\r\norig_size, WTAP_MAX_PACKET_SIZE);\r\nreturn -1;\r\n}\r\nif (packet_size > WTAP_MAX_PACKET_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("capsa: File has %u-byte packet, bigger than maximum of %u",\r\npacket_size, WTAP_MAX_PACKET_SIZE);\r\nreturn -1;\r\n}\r\nif (header_size + packet_size > rec_size) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("capsa: File has %u-byte packet with %u-byte record header, bigger than record size %u",\r\npacket_size, header_size, rec_size);\r\nreturn -1;\r\n}\r\nif (orig_size == packet_size + 4)\r\norig_size = packet_size;\r\nphdr->pseudo_header.eth.fcs_len = 0;\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->caplen = packet_size;\r\nphdr->len = orig_size;\r\nphdr->presence_flags = WTAP_HAS_CAP_LEN|WTAP_HAS_TS;\r\nphdr->ts.secs = (time_t)(timestamp / 1000000);\r\nphdr->ts.nsecs = ((int)(timestamp % 1000000))*1000;\r\nif (!wtap_read_packet_bytes(fh, buf, packet_size, err, err_info))\r\nreturn -1;\r\nreturn rec_size - (header_size + packet_size);\r\n}

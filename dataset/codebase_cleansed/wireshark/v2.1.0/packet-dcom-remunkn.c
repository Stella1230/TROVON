static int\r\ndissect_remunk_remqueryinterface_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\ne_guid_t ipid;\r\nguint32 u32Refs;\r\nguint16 u16IIDs;\r\nguint32 u32ArraySize;\r\nguint32 u32ItemIdx;\r\ne_guid_t iid;\r\nremunk_remqueryinterface_call_t *call;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_ipid, &ipid);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_remunk_refs, &u32Refs);\r\noffset = dissect_dcom_WORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_remunk_iids, &u16IIDs);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nif(u32ArraySize < 100) {\r\ncall = (remunk_remqueryinterface_call_t *)wmem_alloc(wmem_file_scope(), sizeof(remunk_remqueryinterface_call_t) + u32ArraySize * sizeof(e_guid_t));\r\ncall->iid_count = u32ArraySize;\r\ncall->iids = (e_guid_t *) (call+1);\r\ndi->call_data->private_data = call;\r\n} else {\r\ncall = NULL;\r\n}\r\nfor (u32ItemIdx = 0; u32ArraySize--; u32ItemIdx++) {\r\noffset = dissect_dcom_append_UUID(tvb, offset, pinfo, tree, di, drep,\r\nhf_dcom_iid, u32ItemIdx+1, &iid);\r\nif(call != NULL) {\r\ncall->iids[u32ItemIdx] = iid;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_remunk_remqueryinterface_resp(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Pointer;\r\nguint32 u32ArraySize;\r\nguint32 u32ItemIdx;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32HResult;\r\nguint32 u32SubStart;\r\ne_guid_t iid;\r\ne_guid_t iid_null = DCERPC_UUID_NULL;\r\nremunk_remqueryinterface_call_t *call = (remunk_remqueryinterface_call_t *)di->call_data->private_data;\r\nguint64 oxid;\r\nguint64 oid;\r\ne_guid_t ipid;\r\noffset = dissect_dcom_that(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\noffset = dissect_dcom_dcerpc_array_size(tvb, offset, pinfo, tree, di, drep,\r\n&u32ArraySize);\r\nu32ItemIdx = 1;\r\nwhile (u32ArraySize--) {\r\nsub_item = proto_tree_add_item(tree, hf_remunk_qiresult, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_remunk_rqi_result);\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32HResult);\r\nu32SubStart = offset - 4;\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, sub_tree, di, drep,\r\n&u32Pointer);\r\nif(call != NULL && u32ItemIdx <= call->iid_count) {\r\niid = call->iids[u32ItemIdx-1];\r\n} else {\r\niid = iid_null;\r\n}\r\noffset = dissect_dcom_STDOBJREF(tvb, offset, pinfo, sub_tree, di, drep, 0 ,\r\n&oxid, &oid, &ipid);\r\nif(pinfo->net_src.type == AT_IPv4) {\r\ndcom_interface_new(pinfo,\r\n&pinfo->net_src,\r\n&iid, oxid, oid, &ipid);\r\n}\r\nproto_item_append_text(sub_item, "[%u]: %s",\r\nu32ItemIdx,\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)") );\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %s[%u]",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)"),\r\nu32ItemIdx);\r\nu32ItemIdx++;\r\n}\r\noffset = dissect_dcom_HRESULT(tvb, offset, pinfo, tree, di, drep,\r\n&u32HResult);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " -> %s",\r\nval_to_str(u32HResult, dcom_hresult_vals, "Unknown (0x%08x)"));\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_remunk_remrelease_rqst(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, dcerpc_info *di, guint8 *drep)\r\n{\r\nguint32 u32Pointer;\r\nguint32 u32IntRefs;\r\nguint32 u32ItemIdx;\r\ne_guid_t ipid;\r\nguint32 u32PublicRefs;\r\nguint32 u32PrivateRefs;\r\nconst gchar *pszFormat;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nguint32 u32SubStart;\r\noffset = dissect_dcom_this(tvb, offset, pinfo, tree, di, drep);\r\noffset = dissect_dcom_dcerpc_pointer(tvb, offset, pinfo, tree, di, drep,\r\n&u32Pointer);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, tree, di, drep,\r\nhf_remunk_interface_refs, &u32IntRefs);\r\nif (u32IntRefs) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Cnt=%u Refs=", u32IntRefs);\r\n} else {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " Cnt=0");\r\n}\r\nu32ItemIdx = 1;\r\nwhile (u32IntRefs--) {\r\nsub_item = proto_tree_add_item(tree, hf_remunk_reminterfaceref, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_remunk_reminterfaceref);\r\nu32SubStart = offset;\r\noffset = dissect_dcom_UUID(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_dcom_ipid, &ipid);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_remunk_public_refs, &u32PublicRefs);\r\noffset = dissect_dcom_DWORD(tvb, offset, pinfo, sub_tree, di, drep,\r\nhf_remunk_private_refs, &u32PrivateRefs);\r\nproto_item_append_text(sub_item, "[%u]: IPID=%s, PublicRefs=%u, PrivateRefs=%u",\r\nu32ItemIdx,\r\nguids_resolve_guid_to_str(&ipid),\r\nu32PublicRefs, u32PrivateRefs);\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\npszFormat = "";\r\nif (u32ItemIdx == 1) {\r\npszFormat = "%u-%u";\r\n} else if (u32ItemIdx < 10) {\r\npszFormat = ",%u-%u";\r\n} else if (u32ItemIdx == 10) {\r\npszFormat = ",...";\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, pszFormat, u32PublicRefs, u32PrivateRefs);\r\nu32ItemIdx++;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_remunk (void)\r\n{\r\nstatic hf_register_info hf_remunk_rqi_array[] = {\r\n{ &hf_remunk_opnum,\r\n{ "Operation", "remunk.opnum", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_remunk_refs,\r\n{ "Refs", "remunk.refs", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_remunk_iids,\r\n{ "IIDs", "remunk.iids", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_remunk_qiresult,\r\n{ "QIResult", "remunk.qiresult", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n#if 0\r\n{ &hf_remunk_flags,\r\n{ "Flags", "remunk.flags", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n#endif\r\n{ &hf_remunk_public_refs,\r\n{ "PublicRefs", "remunk.public_refs", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_remunk_reminterfaceref,\r\n{ "RemInterfaceRef", "remunk.reminterfaceref", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_remunk_interface_refs,\r\n{ "InterfaceRefs", "remunk.int_refs", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_remunk_private_refs,\r\n{ "PrivateRefs", "remunk.private_refs", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett_remunk_array[] = {\r\n&ett_remunk,\r\n&ett_remunk_rqi_result,\r\n&ett_remunk2,\r\n&ett_remunk_reminterfaceref\r\n};\r\nproto_remunk = proto_register_protocol ("IRemUnknown", "IRemUnknown", "remunk");\r\nproto_register_field_array (proto_remunk, hf_remunk_rqi_array, array_length (hf_remunk_rqi_array));\r\nproto_remunk2 = proto_register_protocol ("IRemUnknown2", "IRemUnknown2", "remunk2");\r\nproto_register_subtree_array (ett_remunk_array, array_length (ett_remunk_array));\r\n}\r\nvoid\r\nproto_reg_handoff_remunk (void)\r\n{\r\nguids_add_uuid(&ipid_remunk, "IPID-IRemUnknown");\r\ndcerpc_init_uuid(proto_remunk, ett_remunk,\r\n&uuid_remunk, ver_remunk,\r\nremunk_dissectors, hf_remunk_opnum);\r\ndcerpc_init_uuid(proto_remunk2, ett_remunk2,\r\n&uuid_remunk2, ver_remunk2,\r\nremunk2_dissectors, hf_remunk_opnum);\r\n}

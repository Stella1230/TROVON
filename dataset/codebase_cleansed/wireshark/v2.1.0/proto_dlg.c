static void\r\nproto_col_clicked_cb(GtkWidget *col _U_, GtkWidget *proto_list) {\r\ngtk_widget_grab_focus(proto_list);\r\n}\r\nstatic void\r\nstatus_toggled(GtkCellRendererToggle *cell _U_, gchar *path_str, gpointer data)\r\n{\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreeIter iter;\r\nGtkTreePath *path = gtk_tree_path_new_from_string(path_str);\r\nprotocol_data_t *p;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_tree_model_get(model, &iter, PROTO_DATA_COLUMN, &p, -1);\r\nif (p->enabled)\r\np->enabled = FALSE;\r\nelse\r\np->enabled = TRUE;\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, ENABLE_COLUMN, p->enabled, -1);\r\ngtk_tree_path_free(path);\r\n}\r\nstatic void\r\nheur_status_toggled(GtkCellRendererToggle *cell _U_, gchar *path_str, gpointer data)\r\n{\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreeIter iter;\r\nGtkTreePath *path = gtk_tree_path_new_from_string(path_str);\r\nheur_protocol_data_t *p;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_tree_model_get(model, &iter, PROTO_DATA_COLUMN, &p, -1);\r\nif (p->enabled)\r\np->enabled = FALSE;\r\nelse\r\np->enabled = TRUE;\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, ENABLE_COLUMN, p->enabled, -1);\r\ngtk_tree_path_free(path);\r\n}\r\nstatic void\r\ntoggle_all_cb(GtkWidget *button _U_, gpointer pl)\r\n{\r\nGSList *entry;\r\nGtkListStore *s = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(pl)));\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nprotocol_data_t *p = (protocol_data_t *)entry->data;\r\nif (p->enabled)\r\np->enabled = FALSE;\r\nelse\r\np->enabled = TRUE;\r\ngtk_list_store_set(s, &p->iter, ENABLE_COLUMN, p->enabled, -1);\r\n}\r\n}\r\nstatic void\r\nset_active_all(GtkWidget *w, gboolean new_state)\r\n{\r\nGtkListStore *s = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(w)));\r\nGSList *entry;\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nprotocol_data_t *p = (protocol_data_t *)entry->data;\r\np->enabled = new_state;\r\ngtk_list_store_set(s, &p->iter, ENABLE_COLUMN, new_state, -1);\r\n}\r\n}\r\nstatic void\r\nenable_all_cb(GtkWidget *button _U_, gpointer pl)\r\n{\r\nset_active_all((GtkWidget *)pl, TRUE);\r\n}\r\nstatic void\r\ndisable_all_cb(GtkWidget *button _U_, gpointer pl)\r\n{\r\nset_active_all((GtkWidget *)pl, FALSE);\r\n}\r\nstatic void heur_toggle_all_cb(GtkWidget *button _U_, gpointer pl)\r\n{\r\nGSList *entry;\r\nGtkListStore *s = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(pl)));\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nheur_protocol_data_t *p = (heur_protocol_data_t *)entry->data;\r\nif (p->enabled)\r\np->enabled = FALSE;\r\nelse\r\np->enabled = TRUE;\r\ngtk_list_store_set(s, &p->iter, ENABLE_COLUMN, p->enabled, -1);\r\n}\r\n}\r\nstatic void\r\nheur_set_active_all(GtkWidget *w, gboolean new_state)\r\n{\r\nGtkListStore *s = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(w)));\r\nGSList *entry;\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nheur_protocol_data_t *p = (heur_protocol_data_t *)entry->data;\r\np->enabled = new_state;\r\ngtk_list_store_set(s, &p->iter, ENABLE_COLUMN, new_state, -1);\r\n}\r\n}\r\nstatic void heur_enable_all_cb(GtkWidget *button _U_, gpointer pl)\r\n{\r\nheur_set_active_all((GtkWidget *)pl, TRUE);\r\n}\r\nstatic void heur_disable_all_cb(GtkWidget *button _U_, gpointer pl)\r\n{\r\nheur_set_active_all((GtkWidget *)pl, FALSE);\r\n}\r\nstatic void\r\nproto_destroy_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nGSList *entry;\r\nproto_w = NULL;\r\nif (protocol_list) {\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\ng_free(entry->data);\r\n}\r\ng_slist_free(protocol_list);\r\nprotocol_list = NULL;\r\n}\r\n}\r\nstatic void\r\nheur_proto_destroy_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nGSList *entry;\r\nproto_w = NULL;\r\nif (heur_protocol_list) {\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\ng_free(entry->data);\r\n}\r\ng_slist_free(heur_protocol_list);\r\nheur_protocol_list = NULL;\r\n}\r\n}\r\nstatic void\r\nupdate_was_enabled(void)\r\n{\r\nGSList *entry;\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nprotocol_data_t *p = (protocol_data_t *)entry->data;\r\np->was_enabled = p->enabled;\r\n}\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nheur_protocol_data_t *p = (heur_protocol_data_t *)entry->data;\r\np->was_enabled = p->enabled;\r\n}\r\n}\r\nstatic void\r\nproto_write(gpointer parent_w _U_)\r\n{\r\nchar *pf_dir_path;\r\nchar *pf_path;\r\nint pf_save_errno;\r\nif (create_persconffile_dir(&pf_dir_path) == -1) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Can't create directory\n\"%s\"\nfor disabled protocols file: %s.", pf_dir_path,\r\ng_strerror(errno));\r\ng_free(pf_dir_path);\r\n} else {\r\nsave_disabled_protos_list(&pf_path, &pf_save_errno);\r\nif (pf_path != NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Could not save to your disabled protocols file\n\"%s\": %s.",\r\npf_path, g_strerror(pf_save_errno));\r\ng_free(pf_path);\r\n}\r\nsave_disabled_heur_dissector_list(&pf_path, &pf_save_errno);\r\nif (pf_path != NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Could not save to your disabled heuristic protocol file\n\"%s\": %s.",\r\npf_path, g_strerror(pf_save_errno));\r\ng_free(pf_path);\r\n}\r\n}\r\n}\r\nstatic void\r\nproto_ok_cb(GtkWidget *ok_bt _U_, gpointer parent_w)\r\n{\r\ngboolean redissect;\r\nredissect = set_proto_selection(GTK_WIDGET(parent_w));\r\nif (!prefs.gui_use_pref_save) {\r\nproto_write(parent_w);\r\n}\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nif (redissect)\r\nredissect_packets();\r\n}\r\nstatic void\r\nproto_apply_cb(GtkWidget *apply_bt _U_, gpointer parent_w)\r\n{\r\ngboolean redissect;\r\nredissect = set_proto_selection(GTK_WIDGET(parent_w));\r\nif (!prefs.gui_use_pref_save) {\r\nproto_write(parent_w);\r\nupdate_was_enabled();\r\n}\r\nif (redissect)\r\nredissect_packets();\r\n}\r\nstatic void\r\nproto_save_cb(GtkWidget *save_bt _U_, gpointer parent_w)\r\n{\r\nproto_write(parent_w);\r\nif (set_proto_selection(GTK_WIDGET(parent_w))) {\r\nredissect_packets();\r\n}\r\n}\r\nstatic void\r\nproto_cancel_cb(GtkWidget *cancel_bt _U_, gpointer parent_w)\r\n{\r\ngboolean redissect;\r\nredissect = revert_proto_selection();\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nif (redissect)\r\nredissect_packets();\r\n}\r\nstatic gboolean\r\nproto_delete_event_cb(GtkWidget *proto_w_lcl, GdkEvent *event _U_,\r\ngpointer dummy _U_)\r\n{\r\nproto_cancel_cb(NULL, proto_w_lcl);\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nset_proto_selection(GtkWidget *parent_w _U_)\r\n{\r\nGSList *entry;\r\nheur_dtbl_entry_t* h;\r\ngboolean need_redissect = FALSE;\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nprotocol_data_t *p = (protocol_data_t *)entry->data;\r\nprotocol_t *protocol;\r\nprotocol = find_protocol_by_id(p->hfinfo_index);\r\nif (proto_is_protocol_enabled(protocol) != p->enabled) {\r\nproto_set_decoding(p->hfinfo_index, p->enabled);\r\nneed_redissect = TRUE;\r\n}\r\n}\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nheur_protocol_data_t *p = (heur_protocol_data_t*)entry->data;\r\nh = find_heur_dissector_by_unique_short_name(p->abbrev);\r\nif ((h != NULL) && (h->enabled != p->enabled)) {\r\nh->enabled = p->enabled;\r\nneed_redissect = TRUE;\r\n}\r\n}\r\nreturn need_redissect;\r\n}\r\nstatic gboolean\r\nrevert_proto_selection(void)\r\n{\r\nGSList *entry;\r\ngboolean need_redissect = FALSE;\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nprotocol_data_t *p = (protocol_data_t *)entry->data;\r\nprotocol_t *protocol;\r\nprotocol = find_protocol_by_id(p->hfinfo_index);\r\nif (proto_is_protocol_enabled(protocol) != p->was_enabled) {\r\nproto_set_decoding(p->hfinfo_index, p->was_enabled);\r\nneed_redissect = TRUE;\r\n}\r\n}\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nheur_protocol_data_t *p = (heur_protocol_data_t*)entry->data;\r\nheur_dtbl_entry_t* h = find_heur_dissector_by_unique_short_name(p->abbrev);\r\nif ((h != NULL) && (h->enabled != p->was_enabled)) {\r\nh->enabled = p->was_enabled;\r\nneed_redissect = TRUE;\r\n}\r\n}\r\nreturn need_redissect;\r\n}\r\nstatic gint\r\nprotocol_data_compare(gconstpointer a, gconstpointer b)\r\n{\r\nconst protocol_data_t *ap = (const protocol_data_t *)a;\r\nconst protocol_data_t *bp = (const protocol_data_t *)b;\r\nreturn strcmp(ap->abbrev, bp->abbrev);\r\n}\r\nstatic gint\r\nheur_protocol_data_compare(gconstpointer a, gconstpointer b)\r\n{\r\nconst heur_protocol_data_t *ap = (const heur_protocol_data_t *)a;\r\nconst heur_protocol_data_t *bp = (const heur_protocol_data_t *)b;\r\nreturn strcmp(ap->abbrev, bp->abbrev);\r\n}\r\nstatic void\r\ncreate_protocol_list(void)\r\n{\r\ngint i;\r\nvoid *cookie;\r\nprotocol_t *protocol;\r\nprotocol_data_t *p;\r\nfor (i = proto_get_first_protocol(&cookie); i != -1;\r\ni = proto_get_next_protocol(&cookie)) {\r\nif (proto_can_toggle_protocol(i)) {\r\np = (protocol_data_t *)g_malloc(sizeof(protocol_data_t));\r\nprotocol = find_protocol_by_id(i);\r\np->name = proto_get_protocol_name(i);\r\np->abbrev = proto_get_protocol_short_name(protocol);\r\np->hfinfo_index = i;\r\np->enabled = proto_is_protocol_enabled(protocol);\r\np->was_enabled = p->enabled;\r\nprotocol_list = g_slist_insert_sorted(protocol_list, p, protocol_data_compare);\r\n}\r\n}\r\n}\r\nstatic void\r\nshow_proto_selection(GtkListStore *proto_store)\r\n{\r\nGSList *entry;\r\nprotocol_data_t *p;\r\nif (protocol_list == NULL)\r\ncreate_protocol_list();\r\nfor (entry = protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\np = (protocol_data_t *)entry->data;\r\ngtk_list_store_append(proto_store, &p->iter);\r\ngtk_list_store_set(proto_store, &p->iter,\r\nENABLE_COLUMN, p->enabled,\r\nPROTOCOL_COLUMN, p->abbrev,\r\nDESCRIPTION_COLUMN, p->name,\r\nPROTO_DATA_COLUMN, p,\r\n-1);\r\n}\r\n}\r\nstatic void\r\npopulate_heur_dissector_table_entries(const char *table_name _U_,\r\nheur_dtbl_entry_t *dtbl_entry, gpointer user_data _U_)\r\n{\r\nheur_protocol_data_t *p;\r\nif (dtbl_entry->protocol) {\r\np = g_new(heur_protocol_data_t, 1);\r\np->name = dtbl_entry->display_name;\r\np->abbrev = dtbl_entry->short_name;\r\np->enabled = dtbl_entry->enabled;\r\np->list_name = dtbl_entry->list_name;\r\np->was_enabled = p->enabled;\r\nheur_protocol_list = g_slist_insert_sorted(heur_protocol_list, p, heur_protocol_data_compare);\r\n}else{\r\ng_warning("no protocol info");\r\n}\r\n}\r\nstatic void\r\npopulate_heur_dissector_tables(const char *table_name, struct heur_dissector_list *list, gpointer w)\r\n{\r\nif (list) {\r\nheur_dissector_table_foreach(table_name, populate_heur_dissector_table_entries, w);\r\n}\r\n}\r\nstatic void\r\nshow_heur_selection(GtkListStore *proto_store)\r\n{\r\nGSList *entry;\r\nif (heur_protocol_list == NULL)\r\ndissector_all_heur_tables_foreach_table(populate_heur_dissector_tables, NULL, NULL);\r\nfor (entry = heur_protocol_list; entry != NULL; entry = g_slist_next(entry)) {\r\nheur_protocol_data_t *p = (heur_protocol_data_t *)entry->data;\r\ngtk_list_store_append(proto_store, &p->iter);\r\ngtk_list_store_set(proto_store, &p->iter,\r\nENABLE_COLUMN, p->enabled,\r\nPROTOCOL_COLUMN, p->name,\r\nHEUR_SHORT_NAME_COLUMN, p->abbrev,\r\nPROTO_DATA_COLUMN, p,\r\n-1);\r\n}\r\n}\r\nstatic void\r\nproto_disable_dialog_cb(gpointer dialog _U_, gint btn, gpointer data)\r\n{\r\nprotocol_t *protocol;\r\ngint id = GPOINTER_TO_INT(data);\r\nif (btn == ESD_BTN_OK) {\r\nif (protocol_list == NULL)\r\ncreate_protocol_list();\r\nprotocol = find_protocol_by_id(id);\r\nif (proto_is_protocol_enabled(protocol) == TRUE) {\r\nif (proto_can_toggle_protocol(id) == TRUE) {\r\nproto_set_decoding(id, FALSE);\r\nredissect_packets();\r\n}\r\n}\r\n}\r\n}\r\nvoid\r\nproto_disable_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nheader_field_info *hfinfo;\r\ngint id;\r\ngpointer dialog;\r\nif (cfile.finfo_selected == NULL) {\r\nreturn;\r\n}\r\nhfinfo = cfile.finfo_selected->hfinfo;\r\nif (hfinfo->parent == -1)\r\nid = proto_get_id((protocol_t *)hfinfo->strings);\r\nelse\r\nid = hfinfo->parent;\r\ndialog = simple_dialog(ESD_TYPE_CONFIRMATION, ESD_BTNS_OK_CANCEL,\r\n"Do you want to temporarily disable protocol: %s ?",\r\nproto_registrar_get_abbrev(id));\r\nsimple_dialog_set_cb(dialog, proto_disable_dialog_cb, GINT_TO_POINTER(id));\r\n}\r\nstatic GtkWidget *\r\nbuild_heur_dissectors_treeview(void)\r\n{\r\nGtkWidget *bbox, *proto_list, *label, *proto_sw, *proto_vb, *button,\r\n*ok_bt, *apply_bt, *save_bt, *cancel_bt, *help_bt;\r\nstatic const gchar *titles[] = { "Status", "Heuristic Protocol", "Short name"};\r\nGtkListStore *proto_store;\r\nGtkCellRenderer *proto_rend;\r\nGtkTreeViewColumn *proto_col;\r\nproto_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_widget_show(proto_vb);\r\nproto_sw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(proto_sw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), proto_sw, TRUE, TRUE, 0);\r\ngtk_widget_show(proto_sw);\r\nproto_store = gtk_list_store_new(4, G_TYPE_BOOLEAN, G_TYPE_STRING, G_TYPE_STRING, G_TYPE_POINTER);\r\nshow_heur_selection(proto_store);\r\ngtk_tree_sortable_set_sort_column_id(GTK_TREE_SORTABLE(proto_store), PROTOCOL_COLUMN,\r\nGTK_SORT_ASCENDING);\r\nproto_list = tree_view_new(GTK_TREE_MODEL(proto_store));\r\ngtk_container_add(GTK_CONTAINER(proto_sw), proto_list);\r\nproto_rend = gtk_cell_renderer_toggle_new();\r\ng_signal_connect(proto_rend, "toggled", G_CALLBACK(heur_status_toggled), proto_store);\r\nproto_col = gtk_tree_view_column_new_with_attributes(titles[ENABLE_COLUMN], proto_rend, "active", ENABLE_COLUMN, NULL);\r\ngtk_tree_view_column_set_sort_column_id(proto_col, ENABLE_COLUMN);\r\ng_signal_connect(proto_col, "clicked", G_CALLBACK(proto_col_clicked_cb), proto_list);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(proto_list), proto_col);\r\nproto_rend = gtk_cell_renderer_text_new();\r\nproto_col = gtk_tree_view_column_new_with_attributes(titles[PROTOCOL_COLUMN], proto_rend, "text", PROTOCOL_COLUMN, NULL);\r\ngtk_tree_view_column_set_sort_column_id(proto_col, PROTOCOL_COLUMN);\r\ng_signal_connect(proto_col, "clicked", G_CALLBACK(proto_col_clicked_cb), proto_list);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(proto_list), proto_col);\r\nproto_rend = gtk_cell_renderer_text_new();\r\nproto_col = gtk_tree_view_column_new_with_attributes(titles[HEUR_SHORT_NAME_COLUMN], proto_rend, "text", HEUR_SHORT_NAME_COLUMN, NULL);\r\ngtk_tree_view_column_set_sort_column_id(proto_col, HEUR_SHORT_NAME_COLUMN);\r\ng_signal_connect(proto_col, "clicked", G_CALLBACK(proto_col_clicked_cb), proto_list);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(proto_list), proto_col);\r\ngtk_tree_view_set_search_column(GTK_TREE_VIEW(proto_list), PROTOCOL_COLUMN);\r\ng_object_unref(G_OBJECT(proto_store));\r\ngtk_widget_show(proto_list);\r\nlabel = gtk_label_new("Disabling a heuristic protocol prevents higher layer protocols from being displayed");\r\ngtk_misc_set_alignment(GTK_MISC(label), 0.5f, 0.5f);\r\ngtk_widget_show(label);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), label, FALSE, FALSE, 5);\r\nbbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_button_box_set_layout(GTK_BUTTON_BOX(bbox), GTK_BUTTONBOX_END);\r\ngtk_box_set_spacing(GTK_BOX(bbox), 5);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nbutton = gtk_button_new_with_label("Enable All");\r\ng_signal_connect(button, "clicked", G_CALLBACK(heur_enable_all_cb), proto_list);\r\ngtk_box_pack_start(GTK_BOX(bbox), button, TRUE, TRUE, 0);\r\ngtk_widget_show(button);\r\nbutton = gtk_button_new_with_label("Disable All");\r\ng_signal_connect(button, "clicked", G_CALLBACK(heur_disable_all_cb), proto_list);\r\ngtk_box_pack_start(GTK_BOX(bbox), button, TRUE, TRUE, 0);\r\ngtk_widget_show(button);\r\nbutton = gtk_button_new_with_label("Invert");\r\ng_signal_connect(button, "clicked", G_CALLBACK(heur_toggle_all_cb), proto_list);\r\ngtk_box_pack_start(GTK_BOX(bbox), button, TRUE, TRUE, 0);\r\ngtk_widget_show(button);\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_SAVE, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(proto_ok_cb), proto_w);\r\ngtk_widget_grab_default(ok_bt);\r\napply_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_APPLY);\r\ng_signal_connect(apply_bt, "clicked", G_CALLBACK(proto_apply_cb), proto_w);\r\nsave_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_SAVE);\r\ng_signal_connect(save_bt, "clicked", G_CALLBACK(proto_save_cb), proto_w);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button(proto_w, cancel_bt, proto_cancel_cb);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_ENABLED_HEURISTICS_DIALOG);\r\ng_signal_connect(proto_w, "delete_event", G_CALLBACK(proto_delete_event_cb), NULL);\r\ng_signal_connect(proto_w, "destroy", G_CALLBACK(heur_proto_destroy_cb), NULL);\r\ngtk_widget_show(proto_w);\r\ngtk_widget_grab_focus(proto_list);\r\nif(!prefs.gui_use_pref_save) {\r\ngtk_widget_hide(save_bt);\r\n}\r\nreturn proto_vb;\r\n}\r\nstatic GtkWidget *\r\nbuild_protocols_treeview(void)\r\n{\r\nGtkWidget *bbox, *proto_list, *label, *proto_sw, *proto_vb, *button,\r\n*ok_bt, *apply_bt, *save_bt, *cancel_bt, *help_bt;\r\nstatic const gchar *titles[] = { "Status", "Protocol", "Description" };\r\nGtkListStore *proto_store;\r\nGtkCellRenderer *proto_rend;\r\nGtkTreeViewColumn *proto_col;\r\nproto_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_widget_show(proto_vb);\r\nproto_sw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(proto_sw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), proto_sw, TRUE, TRUE, 0);\r\ngtk_widget_show(proto_sw);\r\nproto_store = gtk_list_store_new(4, G_TYPE_BOOLEAN, G_TYPE_STRING, G_TYPE_STRING, G_TYPE_POINTER);\r\nshow_proto_selection(proto_store);\r\ngtk_tree_sortable_set_sort_column_id(GTK_TREE_SORTABLE(proto_store), PROTOCOL_COLUMN,\r\nGTK_SORT_ASCENDING);\r\nproto_list = tree_view_new(GTK_TREE_MODEL(proto_store));\r\ngtk_container_add(GTK_CONTAINER(proto_sw), proto_list);\r\nproto_rend = gtk_cell_renderer_toggle_new();\r\ng_signal_connect(proto_rend, "toggled", G_CALLBACK(status_toggled), proto_store);\r\nproto_col = gtk_tree_view_column_new_with_attributes(titles[ENABLE_COLUMN], proto_rend, "active", ENABLE_COLUMN, NULL);\r\ngtk_tree_view_column_set_sort_column_id(proto_col, ENABLE_COLUMN);\r\ng_signal_connect(proto_col, "clicked", G_CALLBACK(proto_col_clicked_cb), proto_list);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(proto_list), proto_col);\r\nproto_rend = gtk_cell_renderer_text_new();\r\nproto_col = gtk_tree_view_column_new_with_attributes(titles[PROTOCOL_COLUMN], proto_rend, "text", PROTOCOL_COLUMN, NULL);\r\ngtk_tree_view_column_set_sort_column_id(proto_col, PROTOCOL_COLUMN);\r\ng_signal_connect(proto_col, "clicked", G_CALLBACK(proto_col_clicked_cb), proto_list);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(proto_list), proto_col);\r\nproto_rend = gtk_cell_renderer_text_new();\r\nproto_col = gtk_tree_view_column_new_with_attributes(titles[DESCRIPTION_COLUMN], proto_rend, "text", DESCRIPTION_COLUMN, NULL);\r\ngtk_tree_view_column_set_sort_column_id(proto_col, DESCRIPTION_COLUMN);\r\ng_signal_connect(proto_col, "clicked", G_CALLBACK(proto_col_clicked_cb), proto_list);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(proto_list), proto_col);\r\ngtk_tree_view_set_search_column(GTK_TREE_VIEW(proto_list), PROTOCOL_COLUMN);\r\ng_object_unref(G_OBJECT(proto_store));\r\ngtk_widget_show(proto_list);\r\nlabel = gtk_label_new("Disabling a protocol prevents higher layer protocols from being displayed");\r\ngtk_misc_set_alignment(GTK_MISC(label), 0.5f, 0.5f);\r\ngtk_widget_show(label);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), label, FALSE, FALSE, 5);\r\nbbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_button_box_set_layout(GTK_BUTTON_BOX(bbox), GTK_BUTTONBOX_END);\r\ngtk_box_set_spacing(GTK_BOX(bbox), 5);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nbutton = gtk_button_new_with_label("Enable All");\r\ng_signal_connect(button, "clicked", G_CALLBACK(enable_all_cb), proto_list);\r\ngtk_box_pack_start(GTK_BOX(bbox), button, TRUE, TRUE, 0);\r\ngtk_widget_show(button);\r\nbutton = gtk_button_new_with_label("Disable All");\r\ng_signal_connect(button, "clicked", G_CALLBACK(disable_all_cb), proto_list);\r\ngtk_box_pack_start(GTK_BOX(bbox), button, TRUE, TRUE, 0);\r\ngtk_widget_show(button);\r\nbutton = gtk_button_new_with_label("Invert");\r\ng_signal_connect(button, "clicked", G_CALLBACK(toggle_all_cb), proto_list);\r\ngtk_box_pack_start(GTK_BOX(bbox), button, TRUE, TRUE, 0);\r\ngtk_widget_show(button);\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_SAVE, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(proto_ok_cb), proto_w);\r\ngtk_widget_grab_default(ok_bt);\r\napply_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_APPLY);\r\ng_signal_connect(apply_bt, "clicked", G_CALLBACK(proto_apply_cb), proto_w);\r\nsave_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_SAVE);\r\ng_signal_connect(save_bt, "clicked", G_CALLBACK(proto_save_cb), proto_w);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button(proto_w, cancel_bt, proto_cancel_cb);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_ENABLED_PROTOCOLS_DIALOG);\r\ng_signal_connect(proto_w, "delete_event", G_CALLBACK(proto_delete_event_cb), NULL);\r\ng_signal_connect(proto_w, "destroy", G_CALLBACK(proto_destroy_cb), NULL);\r\ngtk_widget_show(proto_w);\r\ngtk_widget_grab_focus(proto_list);\r\nif(!prefs.gui_use_pref_save) {\r\ngtk_widget_hide(save_bt);\r\n}\r\nreturn proto_vb;\r\n}\r\nvoid\r\nproto_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nGtkWidget *main_vb, *main_nb, *page_lb, *protocols_page;\r\nGtkWidget *heur_dissectors_page;\r\nif (proto_w != NULL) {\r\nreactivate_window(proto_w);\r\nreturn;\r\n}\r\nproto_w = dlg_conf_window_new("Wireshark: Enabled Protocols");\r\ngtk_window_set_default_size(GTK_WINDOW(proto_w), DEF_WIDTH , DEF_HEIGHT);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 6, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\ngtk_container_add(GTK_CONTAINER(proto_w), main_vb);\r\ngtk_widget_show(main_vb);\r\nmain_nb = gtk_notebook_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_nb, TRUE, TRUE, 0);\r\npage_lb = gtk_label_new("Enabled Protocols");\r\nprotocols_page = build_protocols_treeview();\r\ngtk_notebook_append_page(GTK_NOTEBOOK(main_nb), protocols_page, page_lb);\r\npage_lb = gtk_label_new("Enabled Heuristic dissectors");\r\nheur_dissectors_page = build_heur_dissectors_treeview();\r\ngtk_notebook_append_page(GTK_NOTEBOOK(main_nb), heur_dissectors_page, page_lb);\r\ngtk_widget_show_all(proto_w);\r\nwindow_present(proto_w);\r\n}

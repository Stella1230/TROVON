static phs_t *\r\nnew_phs_t(phs_t *parent)\r\n{\r\nphs_t *rs;\r\nrs = g_new(phs_t, 1);\r\nrs->sibling = NULL;\r\nrs->child = NULL;\r\nrs->parent = parent;\r\nrs->filter = NULL;\r\nrs->protocol = -1;\r\nrs->proto_name = NULL;\r\nrs->frames = 0;\r\nrs->bytes = 0;\r\nreturn rs;\r\n}\r\nstatic int\r\nprotohierstat_packet(void *prs, packet_info *pinfo, epan_dissect_t *edt, const void *dummy _U_)\r\n{\r\nphs_t *rs = (phs_t *)prs;\r\nphs_t *tmprs;\r\nproto_node *node;\r\nfield_info *fi;\r\nif (!edt) {\r\nreturn 0;\r\n}\r\nif (!edt->tree) {\r\nreturn 0;\r\n}\r\nif (!edt->tree->first_child) {\r\nreturn 0;\r\n}\r\nfor (node=edt->tree->first_child; node; node=node->next) {\r\nfi = PNODE_FINFO(node);\r\nif (rs->protocol == -1) {\r\nrs->protocol = fi->hfinfo->id;\r\nrs->proto_name = fi->hfinfo->abbrev;\r\nrs->frames = 1;\r\nrs->bytes = pinfo->fd->pkt_len;\r\nrs->child = new_phs_t(rs);\r\nrs = rs->child;\r\ncontinue;\r\n}\r\nfor (tmprs=rs; tmprs; tmprs=tmprs->sibling) {\r\nif (tmprs->protocol == fi->hfinfo->id) {\r\nbreak;\r\n}\r\n}\r\nif (!tmprs) {\r\nfor (tmprs=rs; tmprs->sibling; tmprs=tmprs->sibling)\r\n;\r\ntmprs->sibling = new_phs_t(rs->parent);\r\nrs = tmprs->sibling;\r\nrs->protocol = fi->hfinfo->id;\r\nrs->proto_name = fi->hfinfo->abbrev;\r\n} else {\r\nrs = tmprs;\r\n}\r\nrs->frames++;\r\nrs->bytes += pinfo->fd->pkt_len;\r\nif (!rs->child) {\r\nrs->child = new_phs_t(rs);\r\n}\r\nrs = rs->child;\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nphs_draw(phs_t *rs, int indentation)\r\n{\r\nint i, stroff;\r\n#define MAXPHSLINE 80\r\nchar str[MAXPHSLINE];\r\nfor (;rs;rs = rs->sibling) {\r\nif (rs->protocol == -1) {\r\nreturn;\r\n}\r\nstr[0] = 0;\r\nstroff = 0;\r\nfor (i=0; i<indentation; i++) {\r\nif (i > 15) {\r\nstroff += g_snprintf(str+stroff, MAXPHSLINE-stroff, "...");\r\nbreak;\r\n}\r\nstroff += g_snprintf(str+stroff, MAXPHSLINE-stroff, " ");\r\n}\r\ng_snprintf(str+stroff, MAXPHSLINE-stroff, "%s", rs->proto_name);\r\nprintf("%-40s frames:%u bytes:%" G_GINT64_MODIFIER "u\n", str, rs->frames, rs->bytes);\r\nphs_draw(rs->child, indentation+1);\r\n}\r\n}\r\nstatic void\r\nprotohierstat_draw(void *prs)\r\n{\r\nphs_t *rs = (phs_t *)prs;\r\nprintf("\n");\r\nprintf("===================================================================\n");\r\nprintf("Protocol Hierarchy Statistics\n");\r\nprintf("Filter: %s\n\n", rs->filter ? rs->filter : "");\r\nphs_draw(rs, 0);\r\nprintf("===================================================================\n");\r\n}\r\nstatic void\r\nprotohierstat_init(const char *opt_arg, void *userdata _U_)\r\n{\r\nphs_t *rs;\r\nint pos = 0;\r\nconst char *filter = NULL;\r\nGString *error_string;\r\nif (strcmp("io,phs", opt_arg) == 0) {\r\n} else if (sscanf(opt_arg, "io,phs,%n", &pos) == 0) {\r\nif (pos) {\r\nfilter = opt_arg+pos;\r\n}\r\n} else {\r\nfprintf(stderr, "tshark: invalid \"-z io,phs[,<filter>]\" argument\n");\r\nexit(1);\r\n}\r\nrs = new_phs_t(NULL);\r\nif (filter) {\r\nrs->filter = g_strdup(filter);\r\n} else {\r\nrs->filter = NULL;\r\n}\r\nerror_string = register_tap_listener("frame", rs, filter, TL_REQUIRES_PROTO_TREE, NULL, protohierstat_packet, protohierstat_draw);\r\nif (error_string) {\r\ng_free(rs->filter);\r\ng_free(rs);\r\nfprintf(stderr, "tshark: Couldn't register io,phs tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_protohierstat(void)\r\n{\r\nregister_stat_tap_ui(&protohierstat_ui, NULL);\r\n}

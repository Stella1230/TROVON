GtkWidget * text_page_new(const char *absolute_path)\r\n{\r\nGtkWidget *page_vb, *txt_scrollw, *txt;\r\npage_vb =ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(page_vb), 1);\r\ntxt_scrollw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(txt_scrollw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(page_vb), txt_scrollw, TRUE, TRUE, 0);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(txt_scrollw),\r\nGTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC);\r\ntxt = gtk_text_view_new();\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(txt), FALSE);\r\ngtk_text_view_set_wrap_mode(GTK_TEXT_VIEW(txt), GTK_WRAP_WORD);\r\ngtk_text_view_set_cursor_visible(GTK_TEXT_VIEW(txt), FALSE);\r\ng_object_set_data(G_OBJECT(page_vb), TEXT_KEY, txt);\r\ntext_page_set_text(page_vb, absolute_path);\r\ngtk_container_add(GTK_CONTAINER(txt_scrollw), txt);\r\ngtk_widget_show(txt_scrollw);\r\ngtk_widget_show(txt);\r\nreturn page_vb;\r\n}\r\nstatic void text_page_insert(GtkWidget *page, const char *buffer, int nchars)\r\n{\r\nGtkWidget *txt = (GtkWidget *)g_object_get_data(G_OBJECT(page), TEXT_KEY);\r\nGtkTextBuffer *buf= gtk_text_view_get_buffer(GTK_TEXT_VIEW(txt));\r\nGtkTextIter iter;\r\ngtk_text_buffer_get_end_iter(buf, &iter);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(GTK_WIDGET(txt), user_font_get_regular());\r\n#else\r\ngtk_widget_modify_font(GTK_WIDGET(txt), user_font_get_regular());\r\n#endif\r\nif (!g_utf8_validate(buffer, -1, NULL))\r\nprintf("Invalid utf8 encoding: %s\n", buffer);\r\ngtk_text_buffer_insert(buf, &iter, buffer, nchars);\r\n}\r\nstatic void text_page_set_text(GtkWidget *page, const char *absolute_path)\r\n{\r\nFILE *text_file;\r\nchar line[4096+1];\r\ntext_file = ws_fopen(absolute_path, "r");\r\nif (text_file != NULL) {\r\nwhile (fgets(line, sizeof line, text_file) != NULL) {\r\ntext_page_insert(page, line, (int) strlen(line));\r\n}\r\nif(ferror(text_file)) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "Error reading file \"%s\": %s",\r\nabsolute_path, g_strerror(errno));\r\n}\r\nfclose(text_file);\r\n} else {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "Could not open file \"%s\": %s",\r\nabsolute_path, g_strerror(errno));\r\n}\r\n}\r\nstatic void text_page_clear(GtkWidget *page)\r\n{\r\nGtkTextBuffer *buf = gtk_text_view_get_buffer(GTK_TEXT_VIEW(g_object_get_data(G_OBJECT(page), TEXT_KEY)));\r\ngtk_text_buffer_set_text(buf, "", 0);\r\n}\r\nvoid text_page_redraw(GtkWidget *page, const char *absolute_path)\r\n{\r\ntext_page_clear(page);\r\ntext_page_set_text(page, absolute_path);\r\n}

static gboolean\r\nneeds_redirection(int std_handle)\r\n{\r\nHANDLE fd;\r\nDWORD handle_type;\r\nDWORD error;\r\nfd = GetStdHandle(std_handle);\r\nif (fd == NULL) {\r\nreturn TRUE;\r\n}\r\nif (fd == INVALID_HANDLE_VALUE) {\r\nreturn FALSE;\r\n}\r\nhandle_type = GetFileType(fd);\r\nif (handle_type == FILE_TYPE_UNKNOWN) {\r\nerror = GetLastError();\r\nif (error == ERROR_INVALID_HANDLE) {\r\nreturn TRUE;\r\n}\r\n}\r\nreturn FALSE;\r\n}\r\nvoid\r\ncreate_console(void)\r\n{\r\ngboolean must_redirect_stdin;\r\ngboolean must_redirect_stdout;\r\ngboolean must_redirect_stderr;\r\nif (stdin_capture) {\r\nreturn;\r\n}\r\nif (!has_console) {\r\nmust_redirect_stdin = needs_redirection(STD_INPUT_HANDLE);\r\nmust_redirect_stdout = needs_redirection(STD_OUTPUT_HANDLE);\r\nmust_redirect_stderr = needs_redirection(STD_ERROR_HANDLE);\r\nif (!must_redirect_stdin && !must_redirect_stdout && !must_redirect_stderr)\r\nreturn;\r\nif (!AttachConsole(ATTACH_PARENT_PROCESS)) {\r\nFreeConsole();\r\nif (AllocConsole()) {\r\nconsole_wait = TRUE;\r\nSetConsoleTitle(_T("Wireshark Debug Console"));\r\n} else {\r\nreturn;\r\n}\r\n}\r\nif (must_redirect_stdin)\r\nws_freopen("CONIN$", "r", stdin);\r\nif (must_redirect_stdout) {\r\nws_freopen("CONOUT$", "w", stdout);\r\nfprintf(stdout, "\n");\r\n}\r\nif (must_redirect_stderr) {\r\nws_freopen("CONOUT$", "w", stderr);\r\nfprintf(stderr, "\n");\r\n}\r\natexit(destroy_console);\r\nhas_console = TRUE;\r\n}\r\n}\r\nvoid\r\ndestroy_console(void)\r\n{\r\nif (console_wait) {\r\nprintf("\n\nPress any key to exit\n");\r\n_getch();\r\n}\r\nFreeConsole();\r\n}\r\nvoid\r\nset_console_wait(gboolean set_console_wait)\r\n{\r\nconsole_wait = set_console_wait;\r\n}\r\ngboolean\r\nget_console_wait(void)\r\n{\r\nreturn console_wait;\r\n}\r\nvoid\r\nset_has_console(gboolean set_has_console)\r\n{\r\nhas_console = set_has_console;\r\n}\r\ngboolean\r\nget_has_console(void)\r\n{\r\nreturn has_console;\r\n}\r\nvoid\r\nset_stdin_capture(gboolean set_stdin_capture)\r\n{\r\nstdin_capture = set_stdin_capture;\r\n}\r\ngboolean\r\nget_stdin_capture(void)\r\n{\r\nreturn stdin_capture;\r\n}

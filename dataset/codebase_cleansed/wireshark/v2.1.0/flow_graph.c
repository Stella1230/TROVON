static void\r\nflow_graph_data_init(void) {\r\ngraph_analysis = sequence_analysis_info_new();\r\ngraph_analysis->type = SEQ_ANALYSIS_ANY;\r\ngraph_analysis->all_packets = TRUE;\r\n}\r\nstatic void\r\nflow_graph_on_destroy(GObject *object _U_, gpointer user_data _U_)\r\n{\r\ng_assert(graph_analysis != NULL);\r\ng_assert(graph_analysis_data != NULL);\r\nsequence_analysis_info_free(graph_analysis);\r\ngraph_analysis = NULL;\r\ng_free(graph_analysis_data);\r\ngraph_analysis_data = NULL;\r\nflow_graph_dlg = NULL;\r\n}\r\nstatic void\r\ntoggle_select_all(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(select_all_rb))) {\r\ngraph_analysis->all_packets = TRUE;\r\n}\r\n}\r\nstatic void\r\ntoggle_select_displayed(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(select_displayed_rb))) {\r\ngraph_analysis->all_packets = FALSE;\r\n}\r\n}\r\nstatic void\r\ntoggle_select_general(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(select_general_rb))) {\r\ngraph_analysis->type = SEQ_ANALYSIS_ANY;\r\n}\r\n}\r\nstatic void\r\ntoggle_select_tcp(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(select_tcp_rb))) {\r\ngraph_analysis->type = SEQ_ANALYSIS_TCP;\r\n}\r\n}\r\nstatic void\r\ntoggle_select_srcdst(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(src_dst_rb))) {\r\ngraph_analysis->any_addr = FALSE;\r\n}\r\n}\r\nstatic void\r\ntoggle_select_netsrcdst(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(net_src_dst_rb))) {\r\ngraph_analysis->any_addr = TRUE;\r\n}\r\n}\r\nstatic void\r\nflow_graph_on_ok(GtkButton *button _U_,\r\ngpointer user_data)\r\n{\r\nsequence_analysis_list_free(graph_analysis);\r\nsequence_analysis_list_get(&cfile, graph_analysis);\r\nif (graph_analysis_data->dlg.window != NULL){\r\ngraph_analysis_update(graph_analysis_data);\r\n}\r\nelse{\r\ngraph_analysis_data->dlg.parent_w = (GtkWidget *)user_data;\r\ngraph_analysis_create(graph_analysis_data);\r\n}\r\n}\r\nstatic void\r\nflow_graph_on_cancel(GtkButton *button _U_,\r\ngpointer user_data)\r\n{\r\nif (graph_analysis_data->dlg.window) {\r\nwindow_destroy(graph_analysis_data->dlg.window);\r\n}\r\nwindow_destroy(GTK_WIDGET(user_data));\r\n}\r\nstatic gboolean\r\nflow_graph_on_delete(GtkButton *button _U_,\r\ngpointer user_data _U_)\r\n{\r\nif (graph_analysis_data->dlg.window) {\r\nwindow_destroy(graph_analysis_data->dlg.window);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\nflow_graph_dlg_create(void)\r\n{\r\nGtkWidget *flow_graph_dlg_w;\r\nGtkWidget *main_vb;\r\nGtkWidget *hbuttonbox;\r\nGtkWidget *bt_cancel, *bt_ok;\r\n#if 0\r\nGtkWidget *top_label = NULL;\r\n#endif\r\nGtkWidget *flow_type_fr, *range_fr, *range_grid, *flow_type_grid, *node_addr_fr, *node_addr_grid;\r\nflow_graph_dlg_w = dlg_window_new("Wireshark: Flow Graph");\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(flow_graph_dlg_w), TRUE);\r\ngtk_window_set_default_size(GTK_WINDOW(flow_graph_dlg_w), 250, 150);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(flow_graph_dlg_w), main_vb);\r\ngtk_container_set_border_width (GTK_CONTAINER (main_vb), 7);\r\n#if 0\r\ntop_label = gtk_label_new ("Choose packets to include in the graph");\r\ngtk_box_pack_start (GTK_BOX (main_vb), top_label, FALSE, FALSE, 8);\r\n#endif\r\ngtk_widget_show(flow_graph_dlg_w);\r\nrange_fr = gtk_frame_new("Choose packets");\r\ngtk_box_pack_start(GTK_BOX(main_vb), range_fr, FALSE, FALSE, 5);\r\nrange_grid = ws_gtk_grid_new();\r\ngtk_container_set_border_width(GTK_CONTAINER(range_grid), 5);\r\ngtk_container_add(GTK_CONTAINER(range_fr), range_grid);\r\nselect_all_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "_All packets");\r\ngtk_widget_set_tooltip_text (select_all_rb, ("Process all packets"));\r\ng_signal_connect(select_all_rb, "toggled", G_CALLBACK(toggle_select_all), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(range_grid), select_all_rb, 0, 0, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (graph_analysis->all_packets) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(select_all_rb),TRUE);\r\n}\r\ngtk_widget_show(select_all_rb);\r\nselect_displayed_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(select_all_rb),\r\n"_Displayed packets");\r\ngtk_widget_set_tooltip_text (select_displayed_rb, ("Process displayed packets"));\r\ng_signal_connect(select_displayed_rb, "toggled", G_CALLBACK(toggle_select_displayed), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(range_grid), select_displayed_rb, 0, 1, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (!graph_analysis->all_packets) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(select_displayed_rb),TRUE);\r\n}\r\ngtk_widget_show(select_displayed_rb);\r\ngtk_widget_show(range_grid);\r\ngtk_widget_show(range_fr);\r\nflow_type_fr = gtk_frame_new("Choose flow type");\r\ngtk_box_pack_start(GTK_BOX(main_vb), flow_type_fr, FALSE, FALSE, 5);\r\nflow_type_grid = ws_gtk_grid_new();\r\ngtk_container_set_border_width(GTK_CONTAINER(flow_type_grid), 5);\r\ngtk_container_add(GTK_CONTAINER(flow_type_fr), flow_type_grid);\r\nselect_general_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "_General flow");\r\ngtk_widget_set_tooltip_text (select_general_rb, ("Show all packets, with general information"));\r\ng_signal_connect(select_general_rb, "toggled", G_CALLBACK(toggle_select_general), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(flow_type_grid), select_general_rb, 0, 0, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (graph_analysis->type == SEQ_ANALYSIS_ANY) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(select_general_rb),TRUE);\r\n}\r\ngtk_widget_show(select_general_rb);\r\nselect_tcp_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(select_general_rb),\r\n"_TCP flow");\r\ngtk_widget_set_tooltip_text (select_tcp_rb, ("Show only TCP packets, with TCP specific information"));\r\ng_signal_connect(select_tcp_rb, "toggled", G_CALLBACK(toggle_select_tcp), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(flow_type_grid), select_tcp_rb, 0, 1, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (graph_analysis->type == SEQ_ANALYSIS_TCP) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(select_tcp_rb),TRUE);\r\n}\r\ngtk_widget_show(select_tcp_rb);\r\ngtk_widget_show(flow_type_grid);\r\ngtk_widget_show(flow_type_fr);\r\nnode_addr_fr = gtk_frame_new("Choose node address type");\r\ngtk_box_pack_start(GTK_BOX(main_vb), node_addr_fr, FALSE, FALSE, 5);\r\nnode_addr_grid = ws_gtk_grid_new();\r\ngtk_container_set_border_width(GTK_CONTAINER(node_addr_grid), 5);\r\ngtk_container_add(GTK_CONTAINER(node_addr_fr), node_addr_grid);\r\nsrc_dst_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "_Standard source/destination addresses");\r\ngtk_widget_set_tooltip_text (src_dst_rb,\r\n("Nodes in the diagram are identified with source and destination addresses"));\r\ng_signal_connect(src_dst_rb, "toggled", G_CALLBACK(toggle_select_srcdst), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(node_addr_grid), src_dst_rb, 0, 0, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (graph_analysis->any_addr) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(src_dst_rb),TRUE);\r\n}\r\ngtk_widget_show(src_dst_rb);\r\nnet_src_dst_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(src_dst_rb),\r\n"_Network source/destination addresses");\r\ngtk_widget_set_tooltip_text (net_src_dst_rb,\r\n("Nodes in the diagram are identified with network source and destination addresses"));\r\ng_signal_connect(net_src_dst_rb, "toggled", G_CALLBACK(toggle_select_netsrcdst), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(node_addr_grid), net_src_dst_rb, 0, 1, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (!graph_analysis->any_addr) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(net_src_dst_rb),TRUE);\r\n}\r\ngtk_widget_show(net_src_dst_rb);\r\ngtk_widget_show(node_addr_grid);\r\ngtk_widget_show(node_addr_fr);\r\nhbuttonbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_box_pack_start (GTK_BOX (main_vb), hbuttonbox, FALSE, FALSE, 5);\r\ngtk_button_box_set_layout (GTK_BUTTON_BOX (hbuttonbox), GTK_BUTTONBOX_SPREAD);\r\ngtk_box_set_spacing (GTK_BOX (hbuttonbox), 30);\r\nbt_ok = ws_gtk_button_new_from_stock(GTK_STOCK_OK);\r\ngtk_box_pack_start(GTK_BOX(hbuttonbox), bt_ok, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text (bt_ok, "Show the flow graph");\r\ng_signal_connect(bt_ok, "clicked", G_CALLBACK(flow_graph_on_ok), flow_graph_dlg_w);\r\ngtk_widget_show(bt_ok);\r\nbt_cancel = ws_gtk_button_new_from_stock(GTK_STOCK_CANCEL);\r\ngtk_box_pack_start(GTK_BOX(hbuttonbox), bt_cancel, TRUE, TRUE, 0);\r\ngtk_widget_set_can_default(bt_cancel, TRUE);\r\ngtk_widget_set_tooltip_text (bt_cancel, "Cancel this dialog");\r\ng_signal_connect(bt_cancel, "clicked", G_CALLBACK(flow_graph_on_cancel), flow_graph_dlg_w);\r\ng_signal_connect(flow_graph_dlg_w, "delete_event", G_CALLBACK(flow_graph_on_delete), NULL);\r\ng_signal_connect(flow_graph_dlg_w, "destroy", G_CALLBACK(flow_graph_on_destroy), NULL);\r\ngtk_widget_show_all(flow_graph_dlg_w);\r\nwindow_present(flow_graph_dlg_w);\r\nflow_graph_dlg = flow_graph_dlg_w;\r\n}\r\nstatic void\r\nflow_graph_init_tap(const char *dummy _U_, void *userdata _U_)\r\n{\r\nif (flow_graph_dlg != NULL) {\r\ng_assert(graph_analysis != NULL);\r\ng_assert(graph_analysis_data != NULL);\r\nreactivate_window(flow_graph_dlg);\r\n} else {\r\ng_assert(graph_analysis == NULL);\r\ng_assert(graph_analysis_data == NULL);\r\nflow_graph_data_init();\r\ngraph_analysis_data = graph_analysis_init(graph_analysis);\r\nflow_graph_dlg_create();\r\n}\r\n}\r\nvoid\r\nflow_graph_launch(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nflow_graph_init_tap("",NULL);\r\n}\r\nvoid\r\nregister_tap_listener_flow_graph(void)\r\n{\r\nregister_stat_tap_ui(&flow_graph_ui,NULL);\r\n}

static void\r\ndissect_option_qos(const guint8 qos, proto_tree *tree, tvbuff_t *tvb, int offset)\r\n{\r\nproto_item *ti;\r\nproto_tree *osi_qos_tree;\r\nti = proto_tree_add_item(tree, hf_osi_options_qos_maintenance, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nosi_qos_tree = proto_item_add_subtree(ti, ott_osi_qos);\r\nif ( ((qos & OSI_OPT_QOS_MASK) >> 6) == OSI_OPT_QOS_GLOBAL_UNIQUE) {\r\nproto_tree_add_item(osi_qos_tree, hf_osi_options_qos_reserved, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(osi_qos_tree, hf_osi_options_qos_sequencing_vs_transit_delay, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(osi_qos_tree, hf_osi_options_congestion_experienced, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(osi_qos_tree, hf_osi_options_transit_delay_vs_cost, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(osi_qos_tree, hf_osi_options_residual_error_prob_vs_transit_delay, tvb, offset, 1, ENC_NA);\r\nproto_tree_add_item(osi_qos_tree, hf_osi_options_residual_error_prob_vs_cost, tvb, offset, 1, ENC_NA);\r\n}\r\n}\r\nstatic void\r\ndissect_option_route(guchar parm_type, int offset, guchar parm_len,\r\ntvbuff_t *tvb, proto_tree *tree )\r\n{\r\nguchar next_hop = 0;\r\nguint16 this_hop = 0;\r\nguchar netl = 0;\r\nguchar last_hop = 0;\r\nguchar cnt_hops = 0;\r\nguchar crr = 0;\r\ngchar* str;\r\nproto_tree *osi_route_tree = NULL;\r\nif ( parm_type == OSI_OPT_SOURCE_ROUTING ) {\r\nnext_hop = tvb_get_guint8(tvb, offset + 1);\r\nnetl = tvb_get_guint8(tvb, next_hop + 2);\r\nthis_hop = offset + 2;\r\nproto_tree_add_uint_format_value(tree, hf_osi_options_source_routing, tvb, offset + next_hop, netl,\r\ntvb_get_guint8(tvb, offset), "%s ( Next Hop Highlighted In Data Buffer )",\r\n(tvb_get_guint8(tvb, offset) == 0) ? "Partial Source Routing" :\r\n"Complete Source Routing");\r\n}\r\nelse if ( parm_type == OSI_OPT_RECORD_OF_ROUTE ) {\r\ncrr = tvb_get_guint8(tvb, offset);\r\nlast_hop = tvb_get_guint8(tvb, offset + 1);\r\nosi_route_tree = proto_tree_add_subtree(tree, tvb, offset, parm_len, ott_osi_route, NULL,\r\n(crr == 0) ? "Partial Route Recording" : "Complete Route Recording");\r\nproto_tree_add_uint_format_value(tree, hf_osi_options_route_recording, tvb, offset, 1, crr, "%s ",\r\n(crr == 0) ? "Partial Route Recording" :\r\n"Complete Route Recording");\r\nif ( last_hop == 0x03 )\r\nproto_tree_add_uint_format(osi_route_tree, hf_osi_options_last_hop, tvb, offset + 1, 1, last_hop,\r\n"No Network Entity Titles Recorded Yet");\r\nif ( last_hop == 0xFF )\r\nproto_tree_add_uint_format(osi_route_tree, hf_osi_options_last_hop, tvb, offset + 1, 1, last_hop,\r\n"Recording Terminated : No more space !");\r\nif ( last_hop == 255 || last_hop == 0x03 )\r\nthis_hop = parm_len + 1;\r\nelse\r\nthis_hop = offset + 2;\r\n}\r\nwhile ( this_hop < offset + last_hop -2 ) {\r\nnetl = tvb_get_guint8(tvb, this_hop);\r\nstr = print_nsap_net(tvb, this_hop + 1, netl);\r\nproto_tree_add_string_format(osi_route_tree, hf_osi_options_route, tvb, this_hop, netl + 1, str,\r\n"Hop #%3u NETL: %2u, NET: %s", cnt_hops++, netl, str);\r\nthis_hop += 1 + netl;\r\n}\r\n}\r\nstatic void\r\ndissect_option_rfd(const guchar error, const guchar field, int offset,\r\nguchar len _U_, tvbuff_t *tvb, proto_tree *tree, packet_info *pinfo )\r\n{\r\nproto_item *ti;\r\nti = proto_tree_add_item(tree, hf_osi_options_rfd_error_class, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nswitch ((error & OSI_OPT_RFD_MASK) >> 4)\r\n{\r\ncase OSI_OPT_RFD_GENERAL:\r\nproto_tree_add_item(tree, hf_osi_options_rtd_general, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase OSI_OPT_RFD_ADDRESS:\r\nproto_tree_add_item(tree, hf_osi_options_rtd_address, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase OSI_OPT_RFD_SOURCE_ROUTING:\r\nproto_tree_add_item(tree, hf_osi_options_rtd_source_routing, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase OSI_OPT_RFD_LIFETIME:\r\nproto_tree_add_item(tree, hf_osi_options_rtd_lifetime, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase OSI_OPT_RFD_PDU_DISCARDED:\r\nproto_tree_add_item(tree, hf_osi_options_rtd_pdu_discarded, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase OSI_OPT_RFD_REASSEMBLY:\r\nproto_tree_add_item(tree, hf_osi_options_rtd_reassembly, tvb, offset + field, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, ti, &ei_osi_options_rfd_error_class);\r\n}\r\nproto_tree_add_item(tree, hf_osi_options_rfd_field, tvb, offset + 1, 1, ENC_BIG_ENDIAN);\r\n}\r\nstatic void\r\ndissect_option_atn_security_label(const guchar sub_type, guchar length,\r\ntvbuff_t *tvb, guint offset,\r\nproto_tree *tree)\r\n{\r\nproto_tree *atn_sl_tree;\r\nguchar len = 0;\r\nguint8 tag_name = 0;\r\nguint security_info_end = 0;\r\nif ( OSI_OPT_SECURITY_ATN_SR != sub_type )\r\nreturn;\r\nlen = tvb_get_guint8(tvb, ++offset);\r\nif ( OSI_OPT_SECURITY_ATN_SR_LEN != len )\r\nreturn;\r\nif ( tvb_memeql(tvb, ++offset , atn_security_registration_val, OSI_OPT_SECURITY_ATN_SR_LEN) )\r\nreturn;\r\natn_sl_tree = proto_tree_add_subtree(tree, tvb, offset, length, ott_osi_qos, NULL,\r\nval_to_str(sub_type, osi_opt_sec_atn_sr_vals, "Unknown (0x%x)"));\r\noffset += OSI_OPT_SECURITY_ATN_SR_LEN;\r\nlen = tvb_get_guint8(tvb, offset);\r\nif ( OSI_OPT_SECURITY_ATN_SI_MAX_LEN < len )\r\nreturn;\r\noffset++;\r\nsecurity_info_end = offset + len;\r\nwhile ( offset < security_info_end ) {\r\nlen = tvb_get_guint8(tvb, offset);\r\nif ( len != 1 )\r\nreturn;\r\noffset++;\r\ntag_name = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nswitch(tag_name) {\r\ncase OSI_OPT_SECURITY_ATN_TT:\r\nlen = tvb_get_guint8(tvb, offset);\r\nif ( len != OSI_OPT_SECURITY_ATN_TT_LEN )\r\nreturn;\r\noffset++;\r\nproto_tree_add_uint_format(atn_sl_tree, hf_clnp_atntt, tvb, offset, 1,\r\ntvb_get_guint8(tvb, offset), "%s: %s",\r\nval_to_str(OSI_OPT_SECURITY_ATN_TT, osi_opt_sec_atn_si_vals, "Unknown (0x%x)"),\r\nval_to_str(tvb_get_guint8(tvb, offset ), osi_opt_sec_atn_tt_vals, "Unknown (0x%x)"));\r\noffset += len;\r\nbreak;\r\ncase OSI_OPT_SECURITY_ATN_SC:\r\nlen = tvb_get_guint8(tvb, offset);\r\nif ( len != OSI_OPT_SECURITY_ATN_SC_LEN )\r\nreturn;\r\noffset++;\r\nproto_tree_add_uint_format(atn_sl_tree, hf_clnp_atnsc, tvb, offset, 1,\r\ntvb_get_guint8(tvb, offset), "%s: %s",\r\nval_to_str(OSI_OPT_SECURITY_ATN_SC, osi_opt_sec_atn_si_vals, "Unknown (0x%x)"),\r\nval_to_str(tvb_get_guint8(tvb, offset ), osi_opt_sec_atn_sc_vals, "Unknown (0x%x)"));\r\noffset += len;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\n}\r\n}\r\nvoid\r\ndissect_osi_options(guchar opt_len, tvbuff_t *tvb, int offset, proto_tree *tree, packet_info *pinfo)\r\n{\r\nproto_item *ti;\r\nproto_tree *osi_option_tree = NULL;\r\nguchar parm_len = 0;\r\nguchar parm_type = 0;\r\nguint8 octet;\r\nosi_option_tree = proto_tree_add_subtree(tree, tvb, offset, opt_len,\r\nott_osi_options, &ti, "### Option Section ###");\r\nif ( 0 == opt_len ) {\r\nexpert_add_info(pinfo, ti, &ei_osi_options_none);\r\nreturn;\r\n}\r\nwhile ( 0 < opt_len ) {\r\nparm_type = tvb_get_guint8(tvb, offset++);\r\nparm_len = tvb_get_guint8(tvb, offset++);\r\nswitch ( parm_type ) {\r\ncase OSI_OPT_QOS_MAINTANANCE:\r\noctet = tvb_get_guint8(tvb, offset);\r\ndissect_option_qos(octet, osi_option_tree, tvb, offset);\r\nbreak;\r\ncase OSI_OPT_SECURITY:\r\noctet = tvb_get_guint8(tvb, offset);\r\nif ( clnp_decode_atn_options ) {\r\ndissect_option_atn_security_label(octet,parm_len,tvb, offset,\r\nosi_option_tree);\r\n} else {\r\nti = proto_tree_add_item(osi_option_tree, hf_osi_options_security_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_item_set_len(ti, parm_len);\r\n}\r\nbreak;\r\ncase OSI_OPT_PRIORITY:\r\noctet = tvb_get_guint8(tvb, offset);\r\nif ( OSI_OPT_MAX_PRIORITY >= octet ) {\r\nti = proto_tree_add_item(osi_option_tree, hf_osi_options_priority, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n} else {\r\nti = proto_tree_add_uint_format_value(osi_option_tree, hf_osi_options_priority, tvb, offset, 1,\r\noctet, "%u ( Invalid )", octet);\r\n}\r\nproto_item_set_len(ti, parm_len);\r\nbreak;\r\ncase OSI_OPT_ADDRESS_MASK:\r\nproto_tree_add_bytes_format_value(osi_option_tree, hf_osi_options_address_mask, tvb, offset, parm_len,\r\nNULL, "%s",\r\nprint_area(tvb, offset, parm_len));\r\nbreak;\r\ncase OSI_OPT_SNPA_MASK:\r\nproto_tree_add_item(osi_option_tree, hf_osi_options_snpa_mask, tvb, offset, parm_len, ENC_NA);\r\nbreak;\r\ncase OSI_OPT_ES_CONFIG_TIMER:\r\nti = proto_tree_add_item(osi_option_tree, hf_osi_options_esct, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_item_set_len(ti, parm_len); break;\r\ncase OSI_OPT_PADDING:\r\nproto_tree_add_item(osi_option_tree, hf_osi_options_padding, tvb, offset, parm_len, ENC_NA);\r\nbreak;\r\ncase OSI_OPT_SOURCE_ROUTING:\r\ncase OSI_OPT_RECORD_OF_ROUTE:\r\ndissect_option_route(parm_type, offset, parm_len, tvb,\r\nosi_option_tree);\r\nbreak;\r\ncase OSI_OPT_REASON_OF_DISCARD:\r\ndissect_option_rfd(tvb_get_guint8(tvb, offset),\r\ntvb_get_guint8(tvb, offset + 1), offset, parm_len,\r\ntvb, osi_option_tree, pinfo);\r\nbreak;\r\n}\r\nopt_len -= parm_len + 2;\r\noffset += parm_len;\r\n}\r\n}\r\nvoid\r\nproto_register_osi_options(void) {\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_osi_options_qos_maintenance, { "Quality of service maintenance", "osi.options.qos.maintenance", FT_UINT8, BASE_DEC, VALS(osi_opt_qos_vals), OSI_OPT_QOS_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_qos_reserved, { "Reserved", "osi.options.qos.reserved", FT_BOOLEAN, 8, NULL, OSI_OPT_QOS_SUB_RSVD, NULL, HFILL }},\r\n{ &hf_osi_options_qos_sequencing_vs_transit_delay, { "Sequencing versus transit delay", "osi.options.qos.seq_vs_trs", FT_BOOLEAN, 8, NULL, OSI_OPT_QOS_SUB_SEQ_VS_TRS, NULL, HFILL }},\r\n{ &hf_osi_options_congestion_experienced, { "Congestion experienced", "osi.options.qos.cong_exped", FT_BOOLEAN, 8, NULL, OSI_OPT_QOS_SUB_CONG_EXPED, NULL, HFILL }},\r\n{ &hf_osi_options_transit_delay_vs_cost, { "Transit delay versus cost", "osi.options.qos.tsd_vs_cost", FT_BOOLEAN, 8, NULL, OSI_OPT_QOS_SUB_TSD_VS_COST, NULL, HFILL }},\r\n{ &hf_osi_options_residual_error_prob_vs_transit_delay, { "Residual error probability versus transit delay", "osi.options.qos.reserror_trs", FT_BOOLEAN, 8, NULL, OSI_OPT_QOS_SUB_RESERR_TRS, NULL, HFILL }},\r\n{ &hf_osi_options_residual_error_prob_vs_cost, { "Residual error probability versus cost", "osi.options.qos.reserror_cost", FT_BOOLEAN, 8, NULL, OSI_OPT_QOS_SUB_RESERR_COST, NULL, HFILL }},\r\n{ &hf_osi_options_source_routing, { "Source Routing", "osi.options.source_routing", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_route_recording, { "Route Recording", "osi.options.route_recording", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_last_hop, { "Last Hop", "osi.options.last_hop", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_route, { "Route", "osi.options.route", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_rfd_error_class, { "Error Class", "osi.options.rfd.error_class", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_error_class), OSI_OPT_RFD_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rtd_general, { "Reason for discard {General}", "osi.options.rtd_general", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_general), OSI_OPT_RFD_SUB_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rtd_address, { "Reason for discard {Address}", "osi.options.rtd_address", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_address), OSI_OPT_RFD_SUB_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rtd_source_routing, { "Reason for discard {Source Routing}", "osi.options.rtd_source_routing", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_src_route), OSI_OPT_RFD_SUB_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rtd_lifetime, { "Reason for discard {Lifetime}", "osi.options.rtd_lifetime", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_lifetime), OSI_OPT_RFD_SUB_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rtd_pdu_discarded, { "Reason for discard {PDU discarded}", "osi.options.rtd_pdu_discarded", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_discarded), OSI_OPT_RFD_SUB_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rtd_reassembly, { "Reason for discard {Reassembly}", "osi.options.rtd_reassembly", FT_UINT8, BASE_DEC, VALS(osi_opt_rfd_reassembly), OSI_OPT_RFD_SUB_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_rfd_field, { "Field", "osi.options.rfd.field", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_security_type, { "Security type", "osi.options.security_type", FT_UINT8, BASE_DEC, VALS(osi_opt_sec_vals), OSI_OPT_SEC_MASK, NULL, HFILL }},\r\n{ &hf_osi_options_priority, { "Priority", "osi.options.priority", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_address_mask, { "Address Mask", "osi.options.address_mask", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_snpa_mask, { "SNPA Mask", "osi.options.snpa_mask", FT_SYSTEM_ID, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_esct, { "ESCT (seconds)", "osi.options.esct", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_osi_options_padding, { "Padding", "osi.options.padding", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ott[] = {\r\n&ott_osi_options,\r\n&ott_osi_qos,\r\n&ott_osi_route,\r\n&ott_osi_redirect\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_osi_options_none, { "osi.options.none", PI_PROTOCOL, PI_NOTE, "No Options for this PDU", EXPFILL }},\r\n{ &ei_osi_options_rfd_error_class, { "osi.options.rfd.error_class.unknown", PI_PROTOCOL, PI_WARN, "UNKNOWN Error Class", EXPFILL }},\r\n};\r\nexpert_module_t *expert_osi_options;\r\nproto_register_field_array(proto_osi, hf, array_length(hf));\r\nproto_register_subtree_array(ott, array_length(ott));\r\nexpert_osi_options = expert_register_protocol(proto_osi);\r\nexpert_register_field_array(expert_osi_options, ei, array_length(ei));\r\n}

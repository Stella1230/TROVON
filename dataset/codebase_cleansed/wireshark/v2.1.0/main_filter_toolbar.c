static void\r\nfilter_activate_cb(GtkWidget *w _U_, gpointer data)\r\n{\r\nconst char *s;\r\ns = gtk_entry_get_text(GTK_ENTRY(data));\r\nmain_filter_packets(&cfile, s, FALSE);\r\n}\r\nstatic void\r\nfilter_changed_cb(GtkWidget *w _U_, gpointer data)\r\n{\r\ngtk_widget_set_sensitive ((GtkWidget *)g_object_get_data (G_OBJECT(data), E_DFILTER_APPLY_KEY), TRUE);\r\ngtk_widget_set_sensitive ((GtkWidget *)g_object_get_data (G_OBJECT(data), E_DFILTER_CLEAR_KEY), TRUE);\r\ngtk_widget_set_sensitive ((GtkWidget *)g_object_get_data (G_OBJECT(data), E_DFILTER_SAVE_KEY), TRUE);\r\n}\r\nstatic void\r\nfilter_reset_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *filter_te = NULL;\r\nif ((filter_te = (GtkWidget *)g_object_get_data(G_OBJECT(w), E_DFILTER_TE_KEY))) {\r\ngtk_entry_set_text(GTK_ENTRY(filter_te), "");\r\n}\r\nmain_filter_packets(&cfile, NULL, FALSE);\r\n}\r\nstatic void\r\nfilter_save_cb(GtkWidget *w _U_, GtkWindow *parent_w)\r\n{\r\nfilter_expression_save_dlg(parent_w);\r\n}\r\nstatic void\r\nplugin_if_filter_apply(gconstpointer user_data)\r\n{\r\nsize_t filter_length;\r\nsize_t max_filter_length = 2048;\r\ngchar *filter_string;\r\nif ( main_display_filter_widget != 0 )\r\n{\r\nGHashTable * dataSet = (GHashTable *) user_data;\r\nif ( g_hash_table_lookup_extended(dataSet, "filter_string", NULL, NULL ) )\r\n{\r\nfilter_string = g_strndup((const char *)g_hash_table_lookup(dataSet, "filter_string"), max_filter_length);\r\nfilter_length = strlen(filter_string);\r\nif ( filter_length < max_filter_length )\r\n{\r\ngtk_entry_set_text(GTK_ENTRY(main_display_filter_widget), filter_string);\r\nmain_filter_packets(&cfile, filter_string, FALSE);\r\n}\r\n}\r\n}\r\n}\r\nGtkWidget *\r\nfilter_toolbar_new(void)\r\n{\r\nGtkWidget *filter_cm;\r\nGtkWidget *filter_te;\r\nGtkWidget *filter_tb;\r\nGtkToolItem *filter_bt, *filter_add_expr_bt, *filter_reset;\r\nGtkToolItem *filter_apply, *filter_save, *item;\r\nstatic construct_args_t args = {\r\n"Wireshark: Display Filter",\r\nTRUE,\r\nTRUE,\r\nFALSE\r\n};\r\nfilter_tb = gtk_toolbar_new();\r\ngtk_orientable_set_orientation(GTK_ORIENTABLE(filter_tb),\r\nGTK_ORIENTATION_HORIZONTAL);\r\ng_object_set_data(G_OBJECT(top_level), E_TB_FILTER_KEY, filter_tb);\r\ngtk_widget_show(filter_tb);\r\nfilter_bt = ws_gtk_tool_button_new_from_stock (WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked", G_CALLBACK(display_filter_construct_cb), &args);\r\ngtk_widget_show(GTK_WIDGET (filter_bt));\r\ng_object_set_data(G_OBJECT(top_level), E_FILT_BT_PTR_KEY, filter_bt);\r\ngtk_toolbar_insert(GTK_TOOLBAR(filter_tb),\r\nfilter_bt,\r\n-1);\r\ngtk_widget_set_tooltip_text(GTK_WIDGET(filter_bt), "Open the \"Display Filter\" dialog, to edit/apply filters");\r\nfilter_cm = gtk_combo_box_text_new_with_entry ();\r\nfilter_te = gtk_bin_get_child(GTK_BIN(filter_cm));\r\nmain_display_filter_widget=filter_te;\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, filter_te);\r\ng_object_set_data(G_OBJECT(filter_te), E_DFILTER_CM_KEY, filter_cm);\r\ng_object_set_data(G_OBJECT(top_level), E_DFILTER_CM_KEY, filter_cm);\r\ng_signal_connect(filter_te, "activate", G_CALLBACK(filter_activate_cb), filter_te);\r\ng_signal_connect(filter_te, "changed", G_CALLBACK(filter_changed_cb), filter_cm);\r\ng_signal_connect(filter_te, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_tb), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_object_set_data(G_OBJECT(filter_te), E_FILT_FIELD_USE_STATUSBAR_KEY, (gpointer)"");\r\ng_signal_connect(filter_te, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(filter_tb, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ngtk_widget_set_size_request(filter_cm, 400, -1);\r\ngtk_widget_show(filter_cm);\r\nitem = gtk_tool_item_new ();\r\ngtk_container_add (GTK_CONTAINER (item), filter_cm);\r\ngtk_widget_show (GTK_WIDGET (item));\r\ngtk_toolbar_insert(GTK_TOOLBAR(filter_tb), item, -1);\r\ngtk_widget_set_tooltip_text(filter_cm,\r\n"Enter a display filter, or choose one of your recently used filters. "\r\n"The background color of this field is changed by a continuous syntax check "\r\n"(green is valid, red is invalid, yellow may have unexpected results).");\r\nfilter_add_expr_bt = ws_gtk_tool_button_new_from_stock(WIRESHARK_STOCK_ADD_EXPRESSION);\r\ng_object_set_data(G_OBJECT(filter_tb), E_FILT_FILTER_TE_KEY, filter_te);\r\ng_signal_connect(filter_add_expr_bt, "clicked", G_CALLBACK(filter_add_expr_bt_cb), filter_tb);\r\ngtk_widget_show(GTK_WIDGET(filter_add_expr_bt));\r\ngtk_toolbar_insert(GTK_TOOLBAR(filter_tb),\r\nfilter_add_expr_bt,\r\n-1);\r\ngtk_widget_set_tooltip_text(GTK_WIDGET(filter_add_expr_bt), "Add an expression to this filter string");\r\nfilter_reset = ws_gtk_tool_button_new_from_stock(WIRESHARK_STOCK_CLEAR_EXPRESSION);\r\ng_object_set_data(G_OBJECT(filter_reset), E_DFILTER_TE_KEY, filter_te);\r\ng_object_set_data (G_OBJECT(filter_cm), E_DFILTER_CLEAR_KEY, filter_reset);\r\ng_signal_connect(filter_reset, "clicked", G_CALLBACK(filter_reset_cb), NULL);\r\ngtk_widget_set_sensitive (GTK_WIDGET(filter_reset), FALSE);\r\ngtk_widget_show(GTK_WIDGET(filter_reset));\r\ngtk_toolbar_insert(GTK_TOOLBAR(filter_tb),\r\nfilter_reset,\r\n-1);\r\ngtk_widget_set_tooltip_text(GTK_WIDGET(filter_reset), "Clear this filter string and update the display");\r\nfilter_apply = ws_gtk_tool_button_new_from_stock(WIRESHARK_STOCK_APPLY_EXPRESSION);\r\ng_object_set_data(G_OBJECT(filter_apply), E_DFILTER_CM_KEY, filter_cm);\r\ng_object_set_data (G_OBJECT(filter_cm), E_DFILTER_APPLY_KEY, filter_apply);\r\ng_signal_connect(filter_apply, "clicked", G_CALLBACK(filter_activate_cb), filter_te);\r\ngtk_widget_set_sensitive (GTK_WIDGET(filter_apply), FALSE);\r\ngtk_widget_show(GTK_WIDGET(filter_apply));\r\ngtk_toolbar_insert(GTK_TOOLBAR(filter_tb),\r\nfilter_apply,\r\n-1);\r\ngtk_widget_set_tooltip_text(GTK_WIDGET(filter_apply), "Apply this filter string to the display");\r\nfilter_save = ws_gtk_tool_button_new_from_stock(GTK_STOCK_SAVE);\r\ng_object_set_data(G_OBJECT(filter_save), E_DFILTER_CM_KEY, filter_cm);\r\ng_object_set_data(G_OBJECT(filter_cm), E_DFILTER_SAVE_KEY, filter_save);\r\ng_signal_connect(filter_save, "clicked", G_CALLBACK(filter_save_cb), filter_te);\r\ngtk_widget_set_sensitive (GTK_WIDGET(filter_save), FALSE);\r\ngtk_widget_show(GTK_WIDGET(filter_save));\r\ngtk_toolbar_insert(GTK_TOOLBAR(filter_tb),\r\nfilter_save,\r\n-1);\r\ngtk_widget_set_tooltip_text(GTK_WIDGET(filter_save), "Create a button based on the current display filter");\r\nset_menu_object_data(MENU_BAR_PATH_FILE_OPEN, E_DFILTER_TE_KEY, filter_te);\r\nset_menu_object_data(MENU_BAR_PATH_EDIT_COPY_AS_FLT, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_DISPLAY_FLT, E_FILT_TE_PTR_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_FOLLOW_TCP_STREAM, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_FOLLOW_UDP_STREAM, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_FOLLOW_SSL_STREAM, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_APL_AS_FLT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_APL_AS_FLT_NOT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_APL_AS_FLT_AND_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_APL_AS_FLT_OR_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_APL_AS_FLT_AND_NOT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_APL_AS_FLT_OR_NOT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_PREP_A_FLT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_PREP_A_FLT_NOT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_PREP_A_FLT_AND_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_PREP_A_FLT_OR_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_PREP_A_FLT_AND_NOT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_menu_object_data(MENU_BAR_PATH_ANALYZE_PREP_A_FLT_OR_NOT_SEL, E_DFILTER_TE_KEY,\r\nfilter_te);\r\nset_toolbar_object_data(E_DFILTER_TE_KEY, filter_te);\r\ng_object_set_data(G_OBJECT(popup_menu_object), E_DFILTER_TE_KEY, filter_te);\r\nfilter_expression_save_dlg_init(filter_tb, filter_te);\r\ntoolbar_redraw_all();\r\nplugin_if_register_gui_cb(PLUGIN_IF_FILTER_ACTION_APPLY, plugin_if_filter_apply );\r\nplugin_if_register_gui_cb(PLUGIN_IF_FILTER_ACTION_PREPARE, plugin_if_filter_apply );\r\nreturn filter_tb;\r\n}\r\nstatic gboolean\r\ndfilter_entry_match(GtkWidget *filter_cm, char *s, int *indx)\r\n{\r\nGtkTreeModel *model = gtk_combo_box_get_model (GTK_COMBO_BOX(filter_cm));\r\nGtkTreeIter iter;\r\nGValue value = { 0, {{0}}};\r\nconst char *filter_str;\r\nint i;\r\ni = -1;\r\nif (!gtk_tree_model_get_iter_first (model, &iter)) {\r\n*indx = i;\r\nreturn FALSE;\r\n}\r\ndo {\r\ni++;\r\ngtk_tree_model_get_value (model, &iter, 0, &value);\r\nfilter_str = g_value_get_string (&value);\r\nif(filter_str) {\r\nif(strcmp(s, filter_str) == 0) {\r\ng_value_unset (&value);\r\n*indx = i;\r\nreturn TRUE;\r\n}\r\n}\r\ng_value_unset (&value);\r\n} while (gtk_tree_model_iter_next (model, &iter));\r\n*indx = -1;\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ndfilter_combo_add(GtkWidget *filter_cm, char *s) {\r\nint indx;\r\nif(!dfilter_entry_match(filter_cm,s, &indx))\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(filter_cm), s);\r\ng_free(s);\r\nreturn TRUE;\r\n}\r\nvoid\r\ndfilter_recent_combo_write_all(FILE *rf) {\r\nGtkWidget *filter_cm = (GtkWidget *)g_object_get_data(G_OBJECT(top_level), E_DFILTER_CM_KEY);\r\nGtkTreeModel *model = gtk_combo_box_get_model (GTK_COMBO_BOX(filter_cm));\r\nGtkTreeIter iter;\r\nGValue value = { 0, {{0}}};\r\nconst char *filter_str;\r\nguint max_count = 0;\r\nif (!gtk_tree_model_get_iter_first (model, &iter))\r\nreturn;\r\ndo {\r\ngtk_tree_model_get_value (model, &iter, 0, &value);\r\nfilter_str = g_value_get_string (&value);\r\nif(filter_str)\r\nfprintf (rf, RECENT_KEY_DISPLAY_FILTER ": %s\n", filter_str);\r\ng_value_unset (&value);\r\n} while (gtk_tree_model_iter_next (model, &iter)&& (max_count++ < prefs.gui_recent_df_entries_max));\r\n}\r\ngboolean\r\ndfilter_combo_add_recent(const gchar *s) {\r\nGtkWidget *filter_cm = (GtkWidget *)g_object_get_data(G_OBJECT(top_level), E_DFILTER_CM_KEY);\r\nchar *dupstr;\r\ndupstr = g_strdup(s);\r\nreturn dfilter_combo_add(filter_cm, dupstr);\r\n}\r\ngboolean\r\nmain_filter_packets(capture_file *cf, const gchar *dftext, gboolean force)\r\n{\r\nGtkWidget *filter_cm = (GtkWidget *)g_object_get_data(G_OBJECT(top_level), E_DFILTER_CM_KEY);\r\ngboolean free_filter = TRUE;\r\nchar *s;\r\ncf_status_t cf_status;\r\ngint filter_count;\r\ns = g_strdup(dftext);\r\ncf_status = cf_filter_packets(cf, s, force);\r\nif (cf_status == CF_OK) {\r\ngtk_widget_set_sensitive ((GtkWidget *)g_object_get_data (G_OBJECT(filter_cm), E_DFILTER_APPLY_KEY), FALSE);\r\nif (!s || strlen (s) == 0) {\r\ngtk_widget_set_sensitive ((GtkWidget *)g_object_get_data (G_OBJECT(filter_cm), E_DFILTER_CLEAR_KEY), FALSE);\r\ngtk_widget_set_sensitive ((GtkWidget *)g_object_get_data (G_OBJECT(filter_cm), E_DFILTER_SAVE_KEY), FALSE);\r\n}\r\n}\r\nif (!s)\r\nreturn (cf_status == CF_OK);\r\nif (cf_status == CF_OK && strlen(s) > 0) {\r\nint indx;\r\nif(!dfilter_entry_match(filter_cm,s, &indx) || indx > -1) {\r\nif (indx > -1) {\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(filter_cm), indx);\r\nindx--;\r\n}\r\ngtk_combo_box_text_prepend_text(GTK_COMBO_BOX_TEXT(filter_cm), s);\r\nindx++;\r\n}\r\n}\r\nif (free_filter)\r\ng_free(s);\r\nfilter_count = gtk_tree_model_iter_n_children(gtk_combo_box_get_model(GTK_COMBO_BOX(filter_cm)), NULL);\r\nwhile (filter_count >= (gint)prefs.gui_recent_df_entries_max) {\r\nfilter_count--;\r\ngtk_combo_box_text_remove(GTK_COMBO_BOX_TEXT(filter_cm), filter_count);\r\n}\r\nreturn (cf_status == CF_OK);\r\n}

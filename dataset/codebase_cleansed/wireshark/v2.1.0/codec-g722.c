void *codec_g722_init(void) {\r\nstruct g722_context *ctx = 0;\r\nctx = (struct g722_context*)g_malloc0(sizeof(struct g722_context));\r\nctx->handle = EasyG722_init_decoder();\r\nreturn ctx;\r\n}\r\nvoid codec_g722_release(void *context) {\r\nstruct g722_context *ctx = (struct g722_context*)context;\r\nif (!ctx) return;\r\nEasyG722_release_decoder(ctx->handle);\r\ng_free(ctx);\r\n}\r\nint codec_g722_decode(void *context, const void *input, int inputSizeBytes, void *output, int *outputSizeBytes) {\r\nstruct g722_context *ctx = (struct g722_context*)context;\r\nconst unsigned char *bitstream = (const unsigned char*)input;\r\nshort *speech = (short*)output;\r\nint decodedBytes = 0;\r\nint i;\r\nif (!ctx) return 0;\r\nif ((inputSizeBytes % L_G722_FRAME_COMPRESSED) != 0)\r\nreturn 0;\r\nif (!output)\r\nreturn (inputSizeBytes / L_G722_FRAME_COMPRESSED ) * L_G722_FRAME / 2 * sizeof(short) ;\r\nwhile ((inputSizeBytes >= L_G722_FRAME_COMPRESSED) &&\r\n((*outputSizeBytes - decodedBytes) >= L_G722_FRAME / 2 * sizeof(short))) {\r\nif (EasyG722_decoder(ctx->handle, (unsigned char*)bitstream, ctx->speach_buffer)) {\r\nint write_index = 0;\r\nfor(i = 0; i < L_G722_FRAME; i+=2) {\r\nctx->speach_buffer[write_index] = ctx->speach_buffer[i];\r\nwrite_index++;\r\n}\r\nmemcpy(speech, ctx->speach_buffer, L_G722_FRAME / 2 * sizeof(short));\r\nspeech += L_G722_FRAME / 2;\r\ndecodedBytes += L_G722_FRAME / 2 * sizeof(short);\r\n}\r\nbitstream += L_G722_FRAME_COMPRESSED;\r\ninputSizeBytes -= L_G722_FRAME_COMPRESSED;\r\n}\r\nreturn decodedBytes;\r\n}

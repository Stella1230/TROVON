static int\r\ndissect_ypserv_status(tvbuff_t *tvb, int offset, packet_info *pinfo _U_, proto_tree *tree, gint32 *rstatus)\r\n{\r\ngint32 status;\r\nconst char *err;\r\nstatus=tvb_get_ntohl(tvb, offset);\r\nif(rstatus){\r\n*rstatus=status;\r\n}\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_status, offset);\r\nif(status<0){\r\nerr=val_to_str(status, ypstat, "Unknown error:%u");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO," %s", err);\r\nproto_item_append_text(tree, " Error:%s", err);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_domain_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item_append_text(tree, " DOMAIN call");\r\nreturn dissect_rpc_string(tvb,tree,hf_ypserv_domain,0,NULL);\r\n}\r\nstatic int\r\ndissect_domain_nonack_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item_append_text(tree, " DOMAIN_NONACK call");\r\nreturn dissect_rpc_string(tvb,tree,hf_ypserv_domain,0,NULL);\r\n}\r\nstatic int\r\ndissect_maplist_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item_append_text(tree, " MAPLIST call");\r\nreturn dissect_rpc_string(tvb,tree,hf_ypserv_domain,0,NULL);\r\n}\r\nstatic int\r\ndissect_domain_reply(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " DOMAIN reply");\r\nproto_tree_add_item(tree, hf_ypserv_servesdomain, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_domain_nonack_reply(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " DOMAIN_NONACK reply");\r\nproto_tree_add_item(tree, hf_ypserv_servesdomain, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_match_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nconst char *str;\r\nint offset = 0;\r\nproto_item_append_text(tree, " MATCH call");\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_domain, offset, &str);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO," %s/", str);\r\nproto_item_append_text(tree, " %s/", str);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, &str);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,"%s/", str);\r\nproto_item_append_text(tree, "%s/", str);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_key, offset, &str);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO,"%s", str);\r\nproto_item_append_text(tree, "%s", str);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_match_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ngint32 status;\r\nconst char *str;\r\nint offset = 0;\r\nproto_item_append_text(tree, " MATCH reply");\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, &status);\r\nif(status>=0){\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_value,offset, &str);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO," %s", str);\r\nproto_item_append_text(tree, " %s", str);\r\n} else {\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_value,offset, NULL);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_first_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " FIRST call");\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_domain, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_first_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " FIRST reply");\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_value, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_key, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_next_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " NEXT reply");\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_value, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_key, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_next_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " NEXT call");\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_domain, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_key, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_xfr_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *sub_item=NULL;\r\nproto_tree *sub_tree=NULL;\r\nint offset = 0;\r\nint start_offset = offset;\r\nproto_item_append_text(tree, " XFR call");\r\nif(tree){\r\nsub_item = proto_tree_add_item(tree, hf_ypserv_map_parms, tvb,\r\noffset, -1, ENC_NA);\r\nif(sub_item)\r\nsub_tree = proto_item_add_subtree(sub_item, ett_ypserv_map_parms);\r\n}\r\noffset = dissect_rpc_string(tvb, sub_tree, hf_ypserv_domain, offset, NULL);\r\noffset = dissect_rpc_string(tvb, sub_tree, hf_ypserv_map, offset, NULL);\r\noffset = dissect_rpc_uint32(tvb, sub_tree, hf_ypserv_ordernum, offset);\r\noffset = dissect_rpc_string(tvb, sub_tree, hf_ypserv_peer, offset, NULL);\r\nproto_tree_add_item(tree, hf_ypserv_transid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_prog, offset);\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_port, offset);\r\nif(sub_item)\r\nproto_item_set_len(sub_item, offset - start_offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_clear_call(tvbuff_t *tvb _U_, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " CLEAR call");\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_clear_reply(tvbuff_t *tvb _U_, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item_append_text(tree, " CLEAR reply");\r\nreturn 0;\r\n}\r\nstatic int\r\ndissect_xfr_reply(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " XFR reply");\r\nproto_tree_add_item(tree, hf_ypserv_transid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_xfrstat, offset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_order_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nconst char *str;\r\nint offset = 0;\r\nproto_item_append_text(tree, " ORDER call");\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_domain, offset, &str);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO," %s/", str);\r\nproto_item_append_text(tree, " %s/", str);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, &str);\r\ncol_append_str(pinfo->cinfo, COL_INFO, str);\r\nproto_item_append_text(tree, "%s", str);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_all_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " ALL call");\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_domain, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_master_call(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " MASTER call");\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_domain, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_all_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint32 more;\r\nint offset = 0;\r\nproto_item_append_text(tree, " ALL reply");\r\nfor (;;) {\r\nmore = tvb_get_ntohl(tvb, offset);\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_more, offset);\r\nif (!more)\r\nbreak;\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_value, offset, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_key, offset, NULL);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_master_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " MASTER reply");\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, NULL);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_peer, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_order_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint32 num;\r\nint offset = 0;\r\nproto_item_append_text(tree, " ORDER reply");\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, NULL);\r\nnum=tvb_get_ntohl(tvb, offset);\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_ordernum, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO," 0x%08x", num);\r\nproto_item_append_text(tree, " 0x%08x", num);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_maplist_reply(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nproto_item_append_text(tree, " MAPLIST reply");\r\noffset = dissect_ypserv_status(tvb, offset, pinfo, tree, NULL);\r\nwhile(tvb_get_ntohl(tvb,offset)){\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_more, offset);\r\noffset = dissect_rpc_string(tvb, tree, hf_ypserv_map, offset, NULL);\r\n}\r\noffset = dissect_rpc_uint32(tvb, tree, hf_ypserv_more, offset);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_ypserv(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ypserv_procedure_v1, {\r\n"V1 Procedure", "ypserv.procedure_v1", FT_UINT32, BASE_DEC,\r\nVALS(ypserv1_proc_vals), 0, NULL, HFILL }},\r\n{ &hf_ypserv_procedure_v2, {\r\n"V2 Procedure", "ypserv.procedure_v2", FT_UINT32, BASE_DEC,\r\nVALS(ypserv2_proc_vals), 0, NULL, HFILL }},\r\n{ &hf_ypserv_domain, {\r\n"Domain", "ypserv.domain", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_ypserv_servesdomain, {\r\n"Serves Domain", "ypserv.servesdomain", FT_BOOLEAN, BASE_NONE,\r\nTFS(&tfs_yes_no), 0x0, NULL, HFILL }},\r\n{ &hf_ypserv_map, {\r\n"Map Name", "ypserv.map", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_ypserv_peer, {\r\n"Peer Name", "ypserv.peer", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_ypserv_more, {\r\n"More", "ypserv.more", FT_BOOLEAN, BASE_NONE,\r\nTFS(&tfs_yes_no), 0x0, NULL, HFILL }},\r\n{ &hf_ypserv_ordernum, {\r\n"Order Number", "ypserv.ordernum", FT_UINT32, BASE_DEC,\r\nNULL, 0, "Order Number for XFR", HFILL }},\r\n{ &hf_ypserv_transid, {\r\n"Host Transport ID", "ypserv.transid", FT_IPv4, BASE_NONE,\r\nNULL, 0, "Host Transport ID to use for XFR Callback", HFILL }},\r\n{ &hf_ypserv_prog, {\r\n"Program Number", "ypserv.prog", FT_UINT32, BASE_DEC,\r\nNULL, 0, "Program Number to use for XFR Callback", HFILL }},\r\n{ &hf_ypserv_port, {\r\n"Port", "ypserv.port", FT_UINT32, BASE_DEC,\r\nNULL, 0, "Port to use for XFR Callback", HFILL }},\r\n{ &hf_ypserv_key, {\r\n"Key", "ypserv.key", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_ypserv_value, {\r\n"Value", "ypserv.value", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_ypserv_status, {\r\n"Status", "ypserv.status", FT_INT32, BASE_DEC,\r\nVALS(ypstat) , 0, NULL, HFILL }},\r\n{ &hf_ypserv_map_parms, {\r\n"YP Map Parameters", "ypserv.map_parms", FT_NONE, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_ypserv_xfrstat, {\r\n"Xfrstat", "ypserv.xfrstat", FT_INT32, BASE_DEC,\r\nVALS(xfrstat), 0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ypserv,\r\n&ett_ypserv_map_parms,\r\n};\r\nproto_ypserv = proto_register_protocol("Yellow Pages Service",\r\n"YPSERV", "ypserv");\r\nproto_register_field_array(proto_ypserv, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_ypserv(void)\r\n{\r\nrpc_init_prog(proto_ypserv, YPSERV_PROGRAM, ett_ypserv,\r\nG_N_ELEMENTS(ypserv_vers_info), ypserv_vers_info);\r\n}

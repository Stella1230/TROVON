static gboolean\r\ndissect_dcc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *dcc_tree, *dcc_optree, *dcc_opnumtree, *ti;\r\nproto_tree *dcc_tracetree;\r\nproto_item *len_item;\r\nint offset = 0;\r\nint client_is_le = 0;\r\nint op = 0;\r\nint i, is_response;\r\nif (pinfo->srcport != DCC_PORT && pinfo->destport != DCC_PORT) {\r\nreturn FALSE;\r\n}\r\nif ( tvb_reported_length(tvb) < sizeof(DCC_HDR) ) {\r\nreturn FALSE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "DCC");\r\noffset = 0;\r\nis_response = pinfo->srcport == DCC_PORT;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"%s: %s",\r\nis_response ? "Response" : "Request",\r\nval_to_str(tvb_get_guint8(tvb, offset+3),\r\ndcc_op_vals, "Unknown Op: %u"));\r\nti = proto_tree_add_item(tree, proto_dcc, tvb, offset, -1,\r\nENC_NA);\r\ndcc_tree = proto_item_add_subtree(ti, ett_dcc);\r\nlen_item = proto_tree_add_item(dcc_tree, hf_dcc_len, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\nif ( tvb_reported_length(tvb) < tvb_get_ntohs(tvb, offset)) {\r\nexpert_add_info(pinfo, len_item, &ei_dcc_len);\r\n}\r\noffset += 2;\r\nif (tree) {\r\nproto_tree_add_item(dcc_tree, hf_dcc_pkt_vers, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nop = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(dcc_tree, hf_dcc_op, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dcc_tree, hf_dcc_clientid, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ndcc_opnumtree = proto_tree_add_subtree(dcc_tree, tvb, offset, -1, ett_dcc_opnums, NULL, "Operation Numbers (Opaque to Server)");\r\nclient_is_le = ( (tvb_get_guint8(tvb, offset+4) | tvb_get_guint8(tvb, offset+5)) &&\r\n(tvb_get_guint8(tvb, offset+8) | tvb_get_guint8(tvb, offset+9)) &&\r\n(tvb_get_guint8(tvb, offset+12) | tvb_get_guint8(tvb, offset+13)) );\r\nproto_tree_add_item(dcc_opnumtree, hf_dcc_opnums_host, tvb,\r\noffset, 4, client_is_le);\r\noffset += 4;\r\nproto_tree_add_item(dcc_opnumtree, hf_dcc_opnums_pid, tvb,\r\noffset, 4, client_is_le);\r\noffset += 4;\r\nproto_tree_add_item(dcc_opnumtree, hf_dcc_opnums_report, tvb,\r\noffset, 4, client_is_le);\r\noffset += 4;\r\nproto_tree_add_item(dcc_opnumtree, hf_dcc_opnums_retrans, tvb,\r\noffset, 4, client_is_le);\r\noffset += 4;\r\ndcc_optree = proto_tree_add_subtree_format(dcc_tree, tvb, offset, -1, ett_dcc_op, NULL,\r\n"Operation: %s", val_to_str(op, dcc_op_vals, "Unknown Op: %u"));\r\nswitch(op) {\r\ncase DCC_OP_NOP:\r\nD_SIGNATURE();\r\nbreak;\r\ncase DCC_OP_REPORT:\r\nD_TARGET();\r\nfor (i=0; i<=DCC_QUERY_MAX &&\r\ntvb_bytes_exist(tvb, offset+(int)sizeof(DCC_SIGNATURE),1); i++)\r\n{\r\nD_CHECKSUM();\r\n}\r\nD_SIGNATURE();\r\nbreak;\r\ncase DCC_OP_QUERY_RESP:\r\nfor (i=0; i<=DCC_QUERY_MAX &&\r\ntvb_bytes_exist(tvb, offset+(int)sizeof(DCC_SIGNATURE),1); i++)\r\n{\r\nD_TARGET();\r\n}\r\nD_SIGNATURE();\r\nbreak;\r\ncase DCC_OP_ADMN:\r\nif ( is_response )\r\n{\r\nint left_local = tvb_reported_length_remaining(tvb, offset) -\r\n(int)sizeof(DCC_SIGNATURE);\r\nif ( left_local == sizeof(DCC_ADMN_RESP_CLIENTS) )\r\n{\r\nD_LABEL(hf_dcc_addr, 16, ENC_NA);\r\nD_LABEL(hf_dcc_id, (int)sizeof(DCC_CLNT_ID), ENC_BIG_ENDIAN);\r\nD_LABEL(hf_dcc_last_used, 4, ENC_BIG_ENDIAN);\r\nD_LABEL(hf_dcc_requests, 4, ENC_BIG_ENDIAN);\r\n}\r\nelse\r\n{\r\nD_TEXT(hf_dcc_response_text, (int)sizeof(DCC_SIGNATURE));\r\n}\r\nD_SIGNATURE();\r\n}\r\nelse\r\n{\r\nint aop;\r\nD_DATE();\r\naop = tvb_get_guint8(tvb, offset+4);\r\nproto_tree_add_item(dcc_optree, hf_dcc_adminop, tvb, offset+4,\r\n1, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s",\r\nval_to_str(tvb_get_guint8(tvb,offset+4),\r\ndcc_adminop_vals, "Unknown (%u)"));\r\nif (aop == DCC_AOP_TRACE_ON || aop == DCC_AOP_TRACE_OFF )\r\n{\r\nti = proto_tree_add_item(dcc_optree, hf_dcc_trace, tvb, offset,\r\n4, ENC_BIG_ENDIAN);\r\ndcc_tracetree = proto_item_add_subtree(ti, ett_dcc_trace);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_admin, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_anon, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_client, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_rlim, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_query, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_ridc, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dcc_tracetree, hf_dcc_trace_flood, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nelse if ( aop == DCC_AOP_FLOD )\r\n{\r\nproto_tree_add_item(dcc_optree, hf_dcc_floodop,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s",\r\nval_to_str(tvb_get_ntohl(tvb,offset),\r\ndcc_floodop_vals, "Unknown (%u)"));\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(dcc_optree, hf_dcc_adminval,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\noffset += 4;\r\noffset += 1;\r\nD_LABEL(hf_dcc_pad, 3, ENC_NA);\r\nD_SIGNATURE();\r\n}\r\nbreak;\r\ncase DCC_OP_OK:\r\nproto_tree_add_item(dcc_optree, hf_dcc_max_pkt_vers, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nD_LABEL(hf_dcc_unused, 1, ENC_NA);\r\nproto_tree_add_item(dcc_optree, hf_dcc_qdelay_ms, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dcc_optree, hf_dcc_brand, tvb,\r\noffset, (int)sizeof(DCC_BRAND), ENC_ASCII|ENC_NA);\r\noffset += (int)sizeof(DCC_BRAND);\r\nD_SIGNATURE();\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_dcc(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dcc_len, {\r\n"Packet Length", "dcc.len", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_pkt_vers, {\r\n"Packet Version", "dcc.pkt_vers", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_op, {\r\n"Operation Type", "dcc.op", FT_UINT8, BASE_DEC,\r\nVALS(dcc_op_vals), 0, NULL, HFILL }},\r\n{ &hf_dcc_clientid, {\r\n"Client ID", "dcc.clientid", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_opnums_host, {\r\n"Host", "dcc.opnums.host", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_opnums_pid, {\r\n"Process ID", "dcc.opnums.pid", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_opnums_report, {\r\n"Report", "dcc.opnums.report", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_opnums_retrans, {\r\n"Retransmission", "dcc.opnums.retrans", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_signature, {\r\n"Signature", "dcc.signature", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_max_pkt_vers, {\r\n"Maximum Packet Version", "dcc.max_pkt_vers", FT_UINT8, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_qdelay_ms, {\r\n"Client Delay", "dcc.qdelay_ms", FT_UINT16, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_brand, {\r\n"Server Brand", "dcc.brand", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_ck_type, {\r\n"Type", "dcc.checksum.type", FT_UINT8, BASE_DEC,\r\nVALS(dcc_cktype_vals), 0, "Checksum Type", HFILL }},\r\n{ &hf_dcc_ck_len, {\r\n"Length", "dcc.checksum.length", FT_UINT8, BASE_DEC,\r\nNULL, 0, "Checksum Length", HFILL }},\r\n{ &hf_dcc_ck_sum, {\r\n"Sum", "dcc.checksum.sum", FT_BYTES, BASE_NONE,\r\nNULL, 0, "Checksum", HFILL }},\r\n{ &hf_dcc_target, {\r\n"Target", "dcc.target", FT_UINT32, BASE_HEX,\r\nVALS(dcc_target_vals), 0, NULL, HFILL }},\r\n{ &hf_dcc_response_text, {\r\n"Response Text", "dcc.response_text", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_date, {\r\n"Date", "dcc.date", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_adminop, {\r\n"Admin Op", "dcc.adminop", FT_UINT8, BASE_DEC,\r\nVALS(dcc_adminop_vals), 0, NULL, HFILL }},\r\n{ &hf_dcc_adminval, {\r\n"Admin Value", "dcc.adminval", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_trace, {\r\n"Trace Bits", "dcc.trace", FT_UINT32, BASE_HEX,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_trace_admin, {\r\n"Admin Requests", "dcc.trace.admin", FT_BOOLEAN, 32,\r\nNULL, 0x00000001, NULL, HFILL }},\r\n{ &hf_dcc_trace_anon, {\r\n"Anonymous Requests", "dcc.trace.anon", FT_BOOLEAN, 32,\r\nNULL, 0x00000002, NULL, HFILL }},\r\n{ &hf_dcc_trace_client, {\r\n"Authenticated Client Requests", "dcc.trace.client", FT_BOOLEAN, 32,\r\nNULL, 0x00000004, NULL, HFILL }},\r\n{ &hf_dcc_trace_rlim, {\r\n"Rate-Limited Requests", "dcc.trace.rlim", FT_BOOLEAN, 32,\r\nNULL, 0x00000008, NULL, HFILL }},\r\n{ &hf_dcc_trace_query, {\r\n"Queries and Reports", "dcc.trace.query", FT_BOOLEAN, 32,\r\nNULL, 0x00000010, NULL, HFILL }},\r\n{ &hf_dcc_trace_ridc, {\r\n"RID Cache Messages", "dcc.trace.ridc", FT_BOOLEAN, 32,\r\nNULL, 0x00000020, NULL, HFILL }},\r\n{ &hf_dcc_trace_flood, {\r\n"Input/Output Flooding", "dcc.trace.flood", FT_BOOLEAN, 32,\r\nNULL, 0x00000040, NULL, HFILL }},\r\n{ &hf_dcc_floodop, {\r\n"Flood Control Operation", "dcc.floodop", FT_UINT32, BASE_DEC,\r\nVALS(dcc_floodop_vals), 0, NULL, HFILL }},\r\n{ &hf_dcc_id, {\r\n"Id", "dcc.id", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_last_used, {\r\n"Last Used", "dcc.last_used", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_requests, {\r\n"Requests", "dcc.requests", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_addr, {\r\n"Addr", "dcc.addr", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_pad, {\r\n"Pad", "dcc.pad", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_dcc_unused, {\r\n"Unused", "dcc.unused", FT_BYTES, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dcc,\r\n&ett_dcc_op,\r\n&ett_dcc_ck,\r\n&ett_dcc_opnums,\r\n&ett_dcc_trace,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_dcc_len, { "dcc.len.short", PI_MALFORMED, PI_ERROR, "Error - packet is shorter than header claims!", EXPFILL }},\r\n};\r\nexpert_module_t* expert_dcc;\r\nproto_dcc = proto_register_protocol("Distributed Checksum Clearinghouse protocol", "DCC", "dcc");\r\nproto_register_field_array(proto_dcc, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_dcc = expert_register_protocol(proto_dcc);\r\nexpert_register_field_array(expert_dcc, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_dcc(void)\r\n{\r\nheur_dissector_add("udp", dissect_dcc, "Distributed Checksum Clearinghouse over UDP", "dcc_udp", proto_dcc, HEURISTIC_ENABLE);\r\n}

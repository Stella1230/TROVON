static gboolean\r\nmime_read_file(wtap *wth, FILE_T fh, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\ngint64 file_size;\r\nint packet_size;\r\nif ((file_size = wtap_file_size(wth, err)) == -1)\r\nreturn FALSE;\r\nif (file_size > MAX_FILE_SIZE) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("mime_file: File has %" G_GINT64_MODIFIER "d-byte packet, bigger than maximum of %u",\r\nfile_size, MAX_FILE_SIZE);\r\nreturn FALSE;\r\n}\r\npacket_size = (int)file_size;\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = 0;\r\nphdr->caplen = packet_size;\r\nphdr->len = packet_size;\r\nphdr->ts.secs = 0;\r\nphdr->ts.nsecs = 0;\r\nreturn wtap_read_packet_bytes(fh, buf, packet_size, err, err_info);\r\n}\r\nstatic gboolean\r\nmime_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\ngint64 offset;\r\n*err = 0;\r\noffset = file_tell(wth->fh);\r\nif (offset != 0)\r\nreturn FALSE;\r\n*data_offset = offset;\r\nreturn mime_read_file(wth, wth->fh, &wth->phdr, wth->frame_buffer, err, err_info);\r\n}\r\nstatic gboolean\r\nmime_seek_read(wtap *wth, gint64 seek_off, struct wtap_pkthdr *phdr, Buffer *buf, int *err, gchar **err_info)\r\n{\r\nif (seek_off > 0) {\r\n*err = 0;\r\nreturn FALSE;\r\n}\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nreturn mime_read_file(wth, wth->random_fh, phdr, buf, err, err_info);\r\n}\r\nwtap_open_return_val\r\nmime_file_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\nchar magic_buf[128];\r\nint bytes_read;\r\ngboolean found_file;\r\nguint i;\r\nguint read_bytes = 12;\r\nfor (i = 0; i < N_MAGIC_TYPES; i++)\r\nread_bytes = MAX(read_bytes, magic_files[i].magic_len);\r\nread_bytes = (guint)MIN(read_bytes, sizeof(magic_buf));\r\nbytes_read = file_read(magic_buf, read_bytes, wth->fh);\r\nif (bytes_read < 0) {\r\n*err = file_error(wth->fh, err_info);\r\nreturn WTAP_OPEN_ERROR;\r\n}\r\nif (bytes_read == 0)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nfound_file = FALSE;\r\nfor (i = 0; i < N_MAGIC_TYPES; i++) {\r\nif ((guint) bytes_read >= magic_files[i].magic_len && !memcmp(magic_buf, magic_files[i].magic, MIN(magic_files[i].magic_len, (guint) bytes_read))) {\r\nif (!found_file) {\r\nif (magic_files[i].magic == pcapng_premagic) {\r\nif (memcmp(magic_buf + 8, pcapng_xmagic, sizeof(pcapng_xmagic)) &&\r\nmemcmp(magic_buf + 8, pcapng_swapped_xmagic, sizeof(pcapng_swapped_xmagic)))\r\ncontinue;\r\n}\r\nfound_file = TRUE;\r\n} else\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\n}\r\nif (!found_file)\r\nreturn WTAP_OPEN_NOT_MINE;\r\nif (file_seek(wth->fh, 0, SEEK_SET, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_MIME;\r\nwth->file_encap = WTAP_ENCAP_MIME;\r\nwth->file_tsprec = WTAP_TSPREC_SEC;\r\nwth->subtype_read = mime_read;\r\nwth->subtype_seek_read = mime_seek_read;\r\nwth->snapshot_length = 0;\r\nreturn WTAP_OPEN_MINE;\r\n}

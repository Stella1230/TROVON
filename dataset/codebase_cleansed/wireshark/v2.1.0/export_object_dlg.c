static void\r\neo_remember_this_row(GtkTreeModel *model _U_, GtkTreePath *path,\r\nGtkTreeIter *iter _U_, gpointer arg)\r\n{\r\nexport_object_list_t *object_list = (export_object_list_t *)arg;\r\nexport_object_entry_t *entry;\r\ngint *path_index;\r\nif((path_index = gtk_tree_path_get_indices(path)) == NULL)\r\nreturn;\r\nobject_list->row_selected = path_index[0];\r\nentry = (export_object_entry_t *)g_slist_nth_data(object_list->entries,\r\nobject_list->row_selected);\r\ncf_goto_frame(&cfile, entry->pkt_num);\r\n}\r\nstatic void\r\neo_remember_row_num(GtkTreeSelection *sel, gpointer data)\r\n{\r\ngtk_tree_selection_selected_foreach(sel, eo_remember_this_row, data);\r\n}\r\nstatic void\r\neo_win_destroy_cb(GtkWindow *win _U_, gpointer data)\r\n{\r\nexport_object_list_t *object_list = (export_object_list_t *)data;\r\nexport_object_entry_t *entry;\r\nGSList *slist = object_list->entries;\r\nremove_tap_listener(object_list);\r\nwhile(slist) {\r\nentry = (export_object_entry_t *)slist->data;\r\ng_free(entry->hostname);\r\ng_free(entry->content_type);\r\ng_free(entry->filename);\r\ng_free(entry->payload_data);\r\nslist = slist->next;\r\ng_free(entry);\r\n}\r\ng_slist_free(object_list->entries);\r\ng_free(object_list);\r\nif (eo_protocoldata_reset != NULL) eo_protocoldata_reset();\r\n}\r\nstatic char *\r\ngtk_eo_save_object_as_file(export_object_list_t *object_list, char *auxfilename)\r\n{\r\nGtkWidget *save_as_w;\r\nchar *pathname;\r\nsave_as_w = file_selection_new("Wireshark: Save Object As ...",\r\nGTK_WINDOW(object_list->dlg),\r\nFILE_SELECTION_SAVE);\r\ngtk_file_chooser_set_current_name(GTK_FILE_CHOOSER(save_as_w),\r\nauxfilename);\r\npathname = file_selection_run(save_as_w);\r\nif (pathname == NULL) {\r\nreturn NULL;\r\n}\r\nwindow_destroy(save_as_w);\r\nreturn pathname;\r\n}\r\nstatic void\r\neo_save_clicked_cb(GtkWidget *widget _U_, gpointer arg)\r\n{\r\nexport_object_list_t *object_list = (export_object_list_t *)arg;\r\nexport_object_entry_t *entry;\r\nGString *safe_filename = NULL;\r\nchar *pathname;\r\nentry =(export_object_entry_t *) g_slist_nth_data(object_list->entries,\r\nobject_list->row_selected);\r\nif(!entry) {\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK, "No object was selected for saving. Please click on an object and click save again.");\r\nreturn;\r\n}\r\nsafe_filename = eo_massage_str(entry->filename, 256, 0);\r\nfor (;;) {\r\npathname = gtk_eo_save_object_as_file(object_list, safe_filename->str);\r\nif (pathname == NULL) {\r\nbreak;\r\n}\r\nif (eo_save_entry(pathname, entry, TRUE)) {\r\ng_free(pathname);\r\nbreak;\r\n}\r\ng_free(pathname);\r\n}\r\ng_string_free(safe_filename, TRUE);\r\n}\r\nstatic void\r\neo_save_all_clicked_cb(GtkWidget *widget _U_, gpointer arg)\r\n{\r\ngchar *save_as_fullpath = NULL;\r\nexport_object_list_t *object_list = (export_object_list_t *)arg;\r\nexport_object_entry_t *entry;\r\nGtkWidget *save_in_w;\r\nGSList *slist = object_list->entries;\r\ngboolean all_saved = TRUE;\r\ngchar *save_in_path;\r\nGString *safe_filename;\r\nint count = 0;\r\nsave_in_w = file_selection_new("Wireshark: Save All Objects In ...",\r\nGTK_WINDOW(object_list->dlg),\r\nFILE_SELECTION_CREATE_FOLDER);\r\nif (gtk_dialog_run(GTK_DIALOG(save_in_w)) == GTK_RESPONSE_ACCEPT) {\r\nwhile (slist) {\r\nentry = (export_object_entry_t *)slist->data;\r\nsave_in_path = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(save_in_w));\r\nif ((strlen(save_in_path) < MAXFILELEN)) {\r\ndo {\r\ng_free(save_as_fullpath);\r\nif (entry->filename) {\r\nsafe_filename = eo_massage_str(entry->filename,\r\nMAXFILELEN - strlen(save_in_path), count);\r\n} else {\r\nchar generic_name[MAXFILELEN+1];\r\nconst char *ext;\r\next = ct2ext(entry->content_type);\r\ng_snprintf(generic_name, sizeof(generic_name),\r\n"object%u%s%s", entry->pkt_num, ext ? "." : "",\r\next ? ext : "");\r\nsafe_filename = eo_massage_str(generic_name,\r\nMAXFILELEN - strlen(save_in_path), count);\r\n}\r\nsave_as_fullpath = g_build_filename(\r\nsave_in_path, safe_filename->str, NULL);\r\ng_string_free(safe_filename, TRUE);\r\n} while (g_file_test(save_as_fullpath, G_FILE_TEST_EXISTS) && ++count < 1000);\r\ncount = 0;\r\nif (!eo_save_entry(save_as_fullpath, entry, FALSE))\r\nall_saved = FALSE;\r\ng_free(save_as_fullpath);\r\nsave_as_fullpath = NULL;\r\n}\r\nelse\r\nall_saved = FALSE;\r\nslist = slist->next;\r\n}\r\n}\r\nif (!all_saved)\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Some files could not be saved.");\r\nwindow_destroy(save_in_w);\r\n}\r\nstatic void\r\neo_reset(void *tapdata)\r\n{\r\nexport_object_list_t *object_list = (export_object_list_t *)tapdata;\r\nobject_list->entries = NULL;\r\nobject_list->iter = NULL;\r\nobject_list->row_selected = -1;\r\nif (eo_protocoldata_reset != NULL) eo_protocoldata_reset();\r\n}\r\nstatic void\r\neo_draw(void *tapdata)\r\n{\r\nexport_object_list_t *object_list = (export_object_list_t *)tapdata;\r\nexport_object_entry_t *eo_entry;\r\ngchar *size_str;\r\nGSList *slist = object_list->entries;\r\nGtkTreeIter new_iter;\r\ngtk_tree_store_clear(object_list->store);\r\nwhile(slist) {\r\neo_entry = (export_object_entry_t *)slist->data;\r\ngtk_tree_store_append(object_list->store, &new_iter,\r\nobject_list->iter);\r\nsize_str = format_size(eo_entry->payload_len, (format_size_flags_e)(format_size_unit_bytes|format_size_prefix_si));\r\ngtk_tree_store_set(object_list->store, &new_iter,\r\nEO_PKT_NUM_COLUMN, eo_entry->pkt_num,\r\nEO_HOSTNAME_COLUMN, eo_entry->hostname,\r\nEO_CONTENT_TYPE_COLUMN, eo_entry->content_type,\r\nEO_BYTES_COLUMN, size_str,\r\nEO_FILENAME_COLUMN, eo_entry->filename,\r\n-1);\r\ng_free(size_str);\r\nslist = slist->next;\r\n}\r\n}\r\nvoid object_list_add_entry(export_object_list_t *object_list, export_object_entry_t *entry)\r\n{\r\nobject_list->entries = g_slist_append(object_list->entries, entry);\r\n}\r\nexport_object_entry_t *object_list_get_entry(export_object_list_t *object_list, int row) {\r\nreturn (export_object_entry_t *)g_slist_nth_data(object_list->entries, row);\r\n}\r\nstatic void\r\nexport_object_window(const gchar *tapname, const gchar *name, tap_packet_cb tap_packet, eo_protocoldata_reset_cb eo_protocoldata_resetfn)\r\n{\r\nGtkWidget *sw;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nGtkTreeSelection *selection;\r\nGtkWidget *vbox, *bbox, *help_bt, *cancel_bt, *save_bt, *save_all_bt;\r\nGString *error_msg;\r\nexport_object_list_t *object_list;\r\ngchar *window_title;\r\neo_protocoldata_reset = eo_protocoldata_resetfn;\r\nobject_list = g_new0(export_object_list_t,1);\r\nerror_msg = register_tap_listener(tapname, object_list, NULL, 0,\r\neo_reset,\r\ntap_packet,\r\neo_draw);\r\nif (error_msg) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Can't register %s tap: %s\n", name, error_msg->str);\r\ng_string_free(error_msg, TRUE);\r\ng_free(object_list);\r\nreturn;\r\n}\r\nwindow_title = g_strdup_printf("Wireshark: %s object list", name);\r\nobject_list->dlg = dlg_window_new(window_title);\r\ng_free(window_title);\r\ngtk_window_set_default_size(GTK_WINDOW(object_list->dlg),\r\nDEF_WIDTH, DEF_HEIGHT);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(object_list->dlg), vbox);\r\nsw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(sw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX (vbox), sw, TRUE, TRUE, 0);\r\nobject_list->store = gtk_tree_store_new(EO_NUM_COLUMNS,\r\nG_TYPE_INT, G_TYPE_STRING,\r\nG_TYPE_STRING, G_TYPE_STRING,\r\nG_TYPE_STRING);\r\nobject_list->tree = tree_view_new(GTK_TREE_MODEL(object_list->store));\r\ng_object_unref(G_OBJECT(object_list->store));\r\nobject_list->tree_view = GTK_TREE_VIEW(object_list->tree);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Packet num",\r\nrenderer,\r\n"text",\r\nEO_PKT_NUM_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(object_list->tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Hostname",\r\nrenderer,\r\n"text",\r\nEO_HOSTNAME_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(object_list->tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Content Type",\r\nrenderer,\r\n"text",\r\nEO_CONTENT_TYPE_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(object_list->tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Size",\r\nrenderer,\r\n"text",\r\nEO_BYTES_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(object_list->tree_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Filename",\r\nrenderer,\r\n"text",\r\nEO_FILENAME_COLUMN,\r\nNULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(object_list->tree_view, column);\r\ngtk_container_add(GTK_CONTAINER(sw), object_list->tree);\r\nselection = gtk_tree_view_get_selection(object_list->tree_view);\r\ng_signal_connect(selection, "changed", G_CALLBACK(eo_remember_row_num), object_list);\r\nbbox = dlg_button_row_new(GTK_STOCK_HELP, WIRESHARK_STOCK_SAVE_ALL, GTK_STOCK_SAVE_AS, GTK_STOCK_CANCEL, NULL);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_EXPORT_OBJECT_LIST);\r\ngtk_widget_set_tooltip_text(help_bt, "Show help for this dialog.");\r\nsave_all_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_SAVE_ALL);\r\ng_signal_connect(save_all_bt, "clicked", G_CALLBACK(eo_save_all_clicked_cb),\r\nobject_list);\r\ngtk_widget_set_tooltip_text(save_all_bt, "Save all listed objects with their displayed filenames.");\r\nsave_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_SAVE_AS);\r\ng_signal_connect(save_bt, "clicked", G_CALLBACK(eo_save_clicked_cb), object_list);\r\ngtk_widget_set_tooltip_text(save_bt, "Saves the currently selected content to a file.");\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ngtk_widget_set_tooltip_text(cancel_bt, "Cancel this dialog.");\r\ngtk_box_pack_end(GTK_BOX(vbox), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\ng_signal_connect(object_list->dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(object_list->dlg, "destroy",\r\nG_CALLBACK(eo_win_destroy_cb), object_list);\r\nwindow_set_cancel_button(object_list->dlg, cancel_bt,\r\nwindow_cancel_button_cb);\r\ngtk_widget_show_all(object_list->dlg);\r\nwindow_present(object_list->dlg);\r\ncf_retap_packets(&cfile);\r\n}\r\nvoid\r\neo_dicom_cb(GtkWidget *widget _U_, gpointer data _U_)\r\n{\r\nexport_object_window("dicom_eo", "DICOM", eo_dicom_packet, NULL);\r\n}\r\nvoid\r\neo_http_cb(GtkWidget *widget _U_, gpointer data _U_)\r\n{\r\nexport_object_window("http_eo", "HTTP", eo_http_packet, NULL);\r\n}\r\nvoid\r\neo_smb_cb(GtkWidget *widget _U_, gpointer data _U_)\r\n{\r\nexport_object_window("smb_eo", "SMB", eo_smb_packet, eo_smb_cleanup);\r\n}\r\nvoid\r\neo_tftp_cb(GtkWidget *widget _U_, gpointer data _U_)\r\n{\r\nexport_object_window("tftp_eo", "TFTP", eo_tftp_packet, eo_tftp_cleanup);\r\n}

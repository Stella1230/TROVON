void\r\nws_buffer_init(Buffer* buffer, gsize space)\r\n{\r\nbuffer->data = (guint8*)g_malloc(space);\r\nbuffer->allocated = space;\r\nbuffer->start = 0;\r\nbuffer->first_free = 0;\r\n}\r\nvoid\r\nws_buffer_free(Buffer* buffer)\r\n{\r\ng_free(buffer->data);\r\nbuffer->data = NULL;\r\n}\r\nvoid\r\nws_buffer_assure_space(Buffer* buffer, gsize space)\r\n{\r\ngsize available_at_end = buffer->allocated - buffer->first_free;\r\ngsize space_used;\r\ngboolean space_at_beginning;\r\nif (space <= available_at_end) {\r\nreturn;\r\n}\r\nspace_at_beginning = buffer->start >= space;\r\nif (space_at_beginning || buffer->start > 0) {\r\nspace_used = buffer->first_free - buffer->start;\r\nmemmove(buffer->data, buffer->data + buffer->start, space_used);\r\nbuffer->start = 0;\r\nbuffer->first_free = space_used;\r\n}\r\nif (space_at_beginning) {\r\nreturn;\r\n}\r\nbuffer->allocated += space + 1024;\r\nbuffer->data = (guint8*)g_realloc(buffer->data, buffer->allocated);\r\n}\r\nvoid\r\nws_buffer_append(Buffer* buffer, guint8 *from, gsize bytes)\r\n{\r\nws_buffer_assure_space(buffer, bytes);\r\nmemcpy(buffer->data + buffer->first_free, from, bytes);\r\nbuffer->first_free += bytes;\r\n}\r\nvoid\r\nws_buffer_remove_start(Buffer* buffer, gsize bytes)\r\n{\r\nif (buffer->start + bytes > buffer->first_free) {\r\ng_error("ws_buffer_remove_start trying to remove %" G_GINT64_MODIFIER "u bytes. s=%" G_GINT64_MODIFIER "u ff=%" G_GINT64_MODIFIER "u!\n",\r\n(guint64)bytes, (guint64)buffer->start,\r\n(guint64)buffer->first_free);\r\n}\r\nbuffer->start += bytes;\r\nif (buffer->start == buffer->first_free) {\r\nbuffer->start = 0;\r\nbuffer->first_free = 0;\r\n}\r\n}\r\nvoid\r\nws_buffer_clean(Buffer* buffer)\r\n{\r\nws_buffer_remove_start(buffer, ws_buffer_length(buffer));\r\n}\r\nvoid\r\nws_buffer_increase_length(Buffer* buffer, gsize bytes)\r\n{\r\nbuffer->first_free += bytes;\r\n}\r\ngsize\r\nws_buffer_length(Buffer* buffer)\r\n{\r\nreturn buffer->first_free - buffer->start;\r\n}\r\nguint8 *\r\nws_buffer_start_ptr(Buffer* buffer)\r\n{\r\nreturn buffer->data + buffer->start;\r\n}\r\nguint8 *\r\nws_buffer_end_ptr(Buffer* buffer)\r\n{\r\nreturn buffer->data + buffer->first_free;\r\n}\r\nvoid\r\nws_buffer_append_buffer(Buffer* buffer, Buffer* src_buffer)\r\n{\r\nws_buffer_append(buffer, ws_buffer_start_ptr(src_buffer), ws_buffer_length(src_buffer));\r\n}

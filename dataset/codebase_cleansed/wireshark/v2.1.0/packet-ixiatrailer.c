static int\r\ndissect_ixiatrailer(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *ti;\r\nguint tvblen, trailer_length, field_length;\r\ngboolean matched_without_fcs, matched_with_fcs;\r\nproto_tree *ixiatrailer_tree = NULL;\r\nguint offset = 0;\r\nguint16 cksum, comp_cksum;\r\nvec_t vec;\r\nguint8 field_type;\r\ntvblen = tvb_reported_length(tvb);\r\nif (tvblen != tvb_captured_length(tvb)) {\r\nreturn 0;\r\n}\r\nif (tvblen < 9) {\r\nreturn 0;\r\n}\r\nif (tvblen == 23) {\r\ntvblen = 19;\r\n}\r\nmatched_without_fcs = (tvb_get_ntohs(tvb, tvblen-4) == IXIA_PATTERN);\r\nif (!matched_without_fcs && tvblen >= 13)\r\nmatched_with_fcs = (tvb_get_ntohs(tvb, tvblen-(4+4)) == IXIA_PATTERN);\r\nelse\r\nmatched_with_fcs = FALSE;\r\nif (!matched_without_fcs) {\r\nif (!matched_with_fcs) {\r\nreturn 0;\r\n}\r\ntvblen -= 4;\r\n}\r\ntrailer_length = tvb_get_guint8(tvb, tvblen-5);\r\nif ((tvblen-5) != trailer_length) {\r\nreturn 0;\r\n}\r\ncksum = tvb_get_ntohs(tvb, tvblen-2);\r\nSET_CKSUM_VEC_TVB(vec, tvb, offset, trailer_length + 3);\r\ncomp_cksum = in_cksum(&vec, 1);\r\nif (pntoh16(&comp_cksum) != cksum) {\r\nreturn 0;\r\n}\r\nti = proto_tree_add_item(tree, proto_ixiatrailer, tvb, offset, trailer_length + 5, ENC_NA);\r\nif (ixiatrailer_summary_in_tree) {\r\nproto_item_append_text(ti, ", Length: %u, Checksum: 0x%x", trailer_length, cksum);\r\n}\r\nixiatrailer_tree = proto_item_add_subtree(ti, ett_ixiatrailer);\r\nwhile (offset < trailer_length - 2)\r\n{\r\nfield_type = tvb_get_guint8(tvb, offset++);\r\nfield_length = tvb_get_guint8(tvb, offset++);\r\nswitch (field_type) {\r\ncase IXIATRAILER_FTYPE_ORIGINAL_PACKET_SIZE:\r\nif (field_length != 2){\r\nexpert_add_info_format(pinfo, ti, &ei_ixiatrailer_field_length_invalid, "Field length %u invalid", field_length);\r\nbreak;\r\n}\r\nti = proto_tree_add_item(ixiatrailer_tree, hf_ixiatrailer_packetlen, tvb, offset, field_length, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, " bytes");\r\nbreak;\r\ncase IXIATRAILER_FTYPE_TIMESTAMP_LOCAL:\r\ncase IXIATRAILER_FTYPE_TIMESTAMP_NTP:\r\ncase IXIATRAILER_FTYPE_TIMESTAMP_GPS:\r\ncase IXIATRAILER_FTYPE_TIMESTAMP_1588:\r\ncase IXIATRAILER_FTYPE_TIMESTAMP_HOLDOVER:\r\nif (field_length != 8) {\r\nexpert_add_info_format(pinfo, ti, &ei_ixiatrailer_field_length_invalid, "Field length %u invalid", field_length);\r\nbreak;\r\n}\r\nti = proto_tree_add_item(ixiatrailer_tree, hf_ixiatrailer_timestamp, tvb, offset, field_length, ENC_TIME_TIMESPEC|ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, "; Source: %s", val_to_str_const(field_type, ixiatrailer_ftype_timestamp, "Unknown"));\r\nbreak;\r\ndefault:\r\nti = proto_tree_add_item(ixiatrailer_tree, hf_ixiatrailer_generic, tvb, offset, field_length, ENC_NA);\r\nproto_item_append_text(ti, " [Id: %u, Length: %u bytes]", field_type, field_length);\r\nbreak;\r\n};\r\noffset += field_length;\r\n}\r\nreturn tvblen;\r\n}\r\nvoid\r\nproto_register_ixiatrailer(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ixiatrailer_packetlen, {\r\n"Original packet length", "ixiatrailer.packetlen", FT_UINT16, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_ixiatrailer_timestamp, {\r\n"Time Stamp", "ixiatrailer.timestamp", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL,\r\nNULL, 0x0, NULL, HFILL }},\r\n{ &hf_ixiatrailer_generic, {\r\n"Generic Field", "ixiatrailer.generic", FT_BYTES, BASE_NONE,\r\nNULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ixiatrailer_ett[] = {\r\n&ett_ixiatrailer\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ixiatrailer_field_length_invalid, { "ixiatrailer.field_length_invalid", PI_MALFORMED, PI_ERROR, "Field length invalid", EXPFILL }},\r\n};\r\nmodule_t *ixiatrailer_module;\r\nexpert_module_t* expert_ixiatrailer;\r\nproto_ixiatrailer = proto_register_protocol("Ixia Trailer", "IXIATRAILER", "ixiatrailer");\r\nproto_register_field_array(proto_ixiatrailer, hf, array_length(hf));\r\nproto_register_subtree_array(ixiatrailer_ett, array_length(ixiatrailer_ett));\r\nexpert_ixiatrailer = expert_register_protocol(proto_ixiatrailer);\r\nexpert_register_field_array(expert_ixiatrailer, ei, array_length(ei));\r\nixiatrailer_module = prefs_register_protocol(proto_ixiatrailer, NULL);\r\nprefs_register_bool_preference(ixiatrailer_module, "summary_in_tree",\r\n"Show trailer summary in protocol tree",\r\n"Whether the trailer summary line should be shown in the protocol tree",\r\n&ixiatrailer_summary_in_tree);\r\n}\r\nvoid\r\nproto_reg_handoff_ixiatrailer(void)\r\n{\r\nheur_dissector_add("eth.trailer", dissect_ixiatrailer, "Ixia Trailer", "ixiatrailer_eth", proto_ixiatrailer, HEURISTIC_ENABLE);\r\n}

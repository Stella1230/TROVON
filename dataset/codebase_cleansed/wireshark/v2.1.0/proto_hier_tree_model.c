static GtkTreeModelFlags\r\nproto_hier_tree_get_flags(GtkTreeModel *tree_model)\r\n{\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), (GtkTreeModelFlags)0);\r\nreturn GTK_TREE_MODEL_ITERS_PERSIST;\r\n}\r\nstatic gint\r\nproto_hier_tree_get_n_columns(GtkTreeModel *tree_model)\r\n{\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), 0);\r\nreturn 2;\r\n}\r\nstatic GType\r\nproto_hier_tree_get_column_type(GtkTreeModel *tree_model, gint idx)\r\n{\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), G_TYPE_INVALID);\r\ng_return_val_if_fail(idx == 0 || idx == 1, G_TYPE_INVALID);\r\nswitch (idx) {\r\ncase 0:\r\nreturn G_TYPE_POINTER;\r\ncase 1:\r\nreturn G_TYPE_STRING;\r\n}\r\nreturn G_TYPE_INVALID;\r\n}\r\nstatic gboolean\r\nproto_hier_tree_iter_nth_child(GtkTreeModel *tree_model, GtkTreeIter *iter, GtkTreeIter *parent, gint n)\r\n{\r\nProtoHierTreeModel *model;\r\ngint proto_id;\r\nvoid *cookie;\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), FALSE);\r\nmodel = (ProtoHierTreeModel *) tree_model;\r\nif (parent) {\r\nheader_field_info *hfinfo;\r\ng_return_val_if_fail(parent->stamp == model->stamp, FALSE);\r\nif (parent->user_data2 != NULL)\r\nreturn FALSE;\r\nproto_id = proto_get_data_protocol(parent->user_data);\r\nhfinfo = proto_get_first_protocol_field(proto_id, &cookie);\r\nwhile (hfinfo) {\r\nif (hfinfo->same_name_prev_id == -1) {\r\nif (!n)\r\nbreak;\r\nn--;\r\n}\r\nhfinfo = proto_get_next_protocol_field(proto_id, &cookie);\r\n}\r\nif (!hfinfo)\r\nreturn FALSE;\r\niter->stamp = model->stamp;\r\niter->user_data = parent->user_data;\r\niter->user_data2 = cookie;\r\niter->user_data3 = hfinfo;\r\nreturn TRUE;\r\n}\r\nproto_id = proto_get_first_protocol(&cookie);\r\nwhile (proto_id != -1) {\r\nprotocol_t *p = find_protocol_by_id(proto_id);\r\nif (proto_is_protocol_enabled(p)) {\r\nif (!n)\r\nbreak;\r\nn--;\r\n}\r\nproto_id = proto_get_next_protocol(&cookie);\r\n}\r\nif (proto_id == -1)\r\nreturn FALSE;\r\niter->stamp = model->stamp;\r\niter->user_data = cookie;\r\niter->user_data2 = NULL;\r\niter->user_data3 = proto_registrar_get_nth(proto_id);\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nproto_hier_tree_get_iter(GtkTreeModel *tree_model, GtkTreeIter *iter, GtkTreePath *path)\r\n{\r\ngint *indices, depth;\r\ng_assert(PROTOHIER_IS_TREE(tree_model));\r\ng_assert(path != NULL);\r\nindices = gtk_tree_path_get_indices(path);\r\ndepth = gtk_tree_path_get_depth(path);\r\ng_assert(depth == 1 || depth == 2);\r\nif (!proto_hier_tree_iter_nth_child(tree_model, iter, NULL, indices[0]))\r\nreturn FALSE;\r\nif (depth == 2) {\r\nif (!proto_hier_tree_iter_nth_child(tree_model, iter, iter, indices[1]))\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic char *\r\nhfinfo_to_name(const header_field_info *hfinfo)\r\n{\r\nif (hfinfo->parent == -1) {\r\nprotocol_t *protocol = find_protocol_by_id(hfinfo->id);\r\nreturn g_strdup_printf("%s - %s", proto_get_protocol_short_name(protocol), proto_get_protocol_long_name(protocol));\r\n}\r\nif (hfinfo->blurb != NULL && hfinfo->blurb[0] != '\0')\r\nreturn g_strdup_printf("%s - %s (%s)", hfinfo->abbrev, hfinfo->name, hfinfo->blurb);\r\nelse\r\nreturn g_strdup_printf("%s - %s", hfinfo->abbrev, hfinfo->name);\r\n}\r\nstatic void\r\nproto_hier_tree_get_value(GtkTreeModel *tree_model, GtkTreeIter *iter, gint column, GValue *value)\r\n{\r\nProtoHierTreeModel *model;\r\nheader_field_info *hfinfo;\r\ng_return_if_fail(PROTOHIER_IS_TREE(tree_model));\r\nmodel = (ProtoHierTreeModel *) tree_model;\r\ng_return_if_fail(iter != NULL);\r\ng_return_if_fail(iter->stamp == model->stamp);\r\ng_return_if_fail(column == 0 || column == 1);\r\nhfinfo = (header_field_info *)iter->user_data3;\r\nswitch (column) {\r\ncase 0:\r\ng_value_init(value, G_TYPE_POINTER);\r\ng_value_set_pointer(value, hfinfo);\r\nbreak;\r\ncase 1:\r\ng_value_init(value, G_TYPE_STRING);\r\ng_value_take_string(value, hfinfo_to_name(hfinfo));\r\nbreak;\r\n}\r\n}\r\nstatic gboolean\r\nproto_hier_tree_iter_next(GtkTreeModel *tree_model, GtkTreeIter *iter)\r\n{\r\nProtoHierTreeModel *model;\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), FALSE);\r\nmodel = (ProtoHierTreeModel *) tree_model;\r\ng_return_val_if_fail(iter->stamp == model->stamp, FALSE);\r\nif (iter->user_data2 == NULL) {\r\nvoid *cookie = iter->user_data;\r\nint proto_id;\r\nproto_id = proto_get_next_protocol(&cookie);\r\nwhile (proto_id != -1) {\r\nprotocol_t *p = find_protocol_by_id(proto_id);\r\nif (proto_is_protocol_enabled(p))\r\nbreak;\r\nproto_id = proto_get_next_protocol(&cookie);\r\n}\r\nif (proto_id == -1)\r\nreturn FALSE;\r\niter->user_data = cookie;\r\niter->user_data3 = proto_registrar_get_nth(proto_id);\r\nreturn TRUE;\r\n}\r\n{\r\nvoid *cookie2 = iter->user_data2;\r\nheader_field_info *hfinfo;\r\nint proto_id = proto_get_data_protocol(iter->user_data);\r\nhfinfo = proto_get_next_protocol_field(proto_id, &cookie2);\r\nwhile (hfinfo) {\r\nif (hfinfo->same_name_prev_id == -1)\r\nbreak;\r\nhfinfo = proto_get_next_protocol_field(proto_id, &cookie2);\r\n}\r\nif (!hfinfo)\r\nreturn FALSE;\r\niter->user_data2 = cookie2;\r\niter->user_data3 = hfinfo;\r\nreturn TRUE;\r\n}\r\n}\r\nstatic gboolean\r\nproto_hier_tree_iter_children(GtkTreeModel *tree_model, GtkTreeIter *iter, GtkTreeIter *parent)\r\n{\r\nreturn proto_hier_tree_iter_nth_child(tree_model, iter, parent, 0);\r\n}\r\nstatic gint\r\nproto_hier_tree_iter_n_children(GtkTreeModel *tree_model, GtkTreeIter *iter)\r\n{\r\nProtoHierTreeModel *model;\r\ngint count = 0;\r\nint p_id;\r\nvoid *cookie;\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), 0);\r\nmodel = (ProtoHierTreeModel *) tree_model;\r\ng_return_val_if_fail(iter == NULL || iter->user_data != NULL, 0);\r\nif (iter) {\r\nheader_field_info *hfinfo;\r\ng_return_val_if_fail(iter->stamp == model->stamp, 0);\r\nif (iter->user_data2 != NULL)\r\nreturn 0;\r\np_id = proto_get_data_protocol(iter->user_data);\r\nfor (hfinfo = proto_get_first_protocol_field(p_id, &cookie); hfinfo; hfinfo = proto_get_next_protocol_field(p_id, &cookie)) {\r\nif (hfinfo->same_name_prev_id != -1)\r\ncontinue;\r\ncount++;\r\n}\r\n} else {\r\nfor (p_id = proto_get_first_protocol(&cookie); p_id != -1; p_id = proto_get_next_protocol(&cookie)) {\r\nprotocol_t *p = find_protocol_by_id(p_id);\r\nif (!proto_is_protocol_enabled(p))\r\ncontinue;\r\ncount++;\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic GtkTreePath *\r\nproto_hier_tree_get_path(GtkTreeModel *tree_model, GtkTreeIter *iter)\r\n{\r\nProtoHierTreeModel *model;\r\nGtkTreePath *path;\r\nint pos;\r\nint p_id;\r\nvoid *cookie;\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), NULL);\r\nmodel = (ProtoHierTreeModel *) tree_model;\r\ng_return_val_if_fail(iter != NULL, NULL);\r\ng_return_val_if_fail(iter->stamp == model->stamp, FALSE);\r\np_id = proto_get_data_protocol(iter->user_data);\r\npath = gtk_tree_path_new();\r\n{\r\nint id;\r\npos = 0;\r\nfor (id = proto_get_first_protocol(&cookie); id != p_id && id != -1; id = proto_get_next_protocol(&cookie)) {\r\nprotocol_t *p = find_protocol_by_id(id);\r\nif (!proto_is_protocol_enabled(p))\r\ncontinue;\r\npos++;\r\n}\r\ngtk_tree_path_append_index(path, pos);\r\n}\r\nif (iter->user_data2 != NULL) {\r\nheader_field_info *hfinfo;\r\npos = 0;\r\nfor (hfinfo = proto_get_first_protocol_field(p_id, &cookie); hfinfo && hfinfo != iter->user_data3; hfinfo = proto_get_next_protocol_field(p_id, &cookie)) {\r\nif (hfinfo->same_name_prev_id != -1)\r\ncontinue;\r\npos++;\r\n}\r\ngtk_tree_path_append_index(path, pos);\r\n}\r\nreturn path;\r\n}\r\nstatic gboolean\r\nproto_hier_tree_iter_has_child(GtkTreeModel *tree_model, GtkTreeIter *iter)\r\n{\r\nreturn proto_hier_tree_iter_n_children(tree_model, iter) != 0;\r\n}\r\nstatic gboolean\r\nproto_hier_tree_iter_parent(GtkTreeModel *tree_model, GtkTreeIter *iter, GtkTreeIter *child)\r\n{\r\nProtoHierTreeModel *model;\r\ng_return_val_if_fail(PROTOHIER_IS_TREE(tree_model), FALSE);\r\nmodel = (ProtoHierTreeModel *) tree_model;\r\ng_return_val_if_fail(iter != NULL, FALSE);\r\ng_return_val_if_fail(child->stamp == model->stamp, FALSE);\r\nif (child->user_data2 != NULL) {\r\nint p_id = proto_get_data_protocol(child->user_data);\r\niter->stamp = model->stamp;\r\niter->user_data = child->user_data;\r\niter->user_data2 = NULL;\r\niter->user_data3 = proto_registrar_get_nth(p_id);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\nproto_hier_tree_model_tree_init(GtkTreeModelIface *iface)\r\n{\r\niface->get_flags = proto_hier_tree_get_flags;\r\niface->get_n_columns = proto_hier_tree_get_n_columns;\r\niface->get_column_type = proto_hier_tree_get_column_type;\r\niface->get_iter = proto_hier_tree_get_iter;\r\niface->get_path = proto_hier_tree_get_path;\r\niface->get_value = proto_hier_tree_get_value;\r\niface->iter_next = proto_hier_tree_iter_next;\r\niface->iter_children = proto_hier_tree_iter_children;\r\niface->iter_has_child = proto_hier_tree_iter_has_child;\r\niface->iter_n_children = proto_hier_tree_iter_n_children;\r\niface->iter_nth_child = proto_hier_tree_iter_nth_child;\r\niface->iter_parent = proto_hier_tree_iter_parent;\r\n}\r\nstatic void\r\nproto_hier_tree_model_init(ProtoHierTreeModel *model)\r\n{\r\nmodel->stamp = g_random_int();\r\n}\r\nstatic void\r\n_class_finalize(GObject *object)\r\n{\r\n(*parent_class->finalize)(object);\r\n}\r\nstatic void\r\nproto_hier_tree_class_init(ProtoHierTreeModelClass *klass)\r\n{\r\nGObjectClass *object_class;\r\nparent_class = (GObjectClass*) g_type_class_peek_parent(klass);\r\nobject_class = (GObjectClass*) klass;\r\nobject_class->finalize = _class_finalize;\r\n}\r\nGType\r\nproto_hier_tree_get_type(void)\r\n{\r\nstatic GType proto_hier_tree_type = 0;\r\nif (proto_hier_tree_type == 0) {\r\nstatic const GTypeInfo proto_hier_tree_info = {\r\nsizeof(ProtoHierTreeModelClass),\r\nNULL,\r\nNULL,\r\n(GClassInitFunc) proto_hier_tree_class_init,\r\nNULL,\r\nNULL,\r\nsizeof(ProtoHierTreeModel),\r\n0,\r\n(GInstanceInitFunc) proto_hier_tree_model_init,\r\nNULL\r\n};\r\nstatic const GInterfaceInfo tree_model_info = {\r\n(GInterfaceInitFunc) proto_hier_tree_model_tree_init,\r\nNULL,\r\nNULL\r\n};\r\nproto_hier_tree_type = g_type_register_static(G_TYPE_OBJECT,\r\n"ProtoHierTreeModel",\r\n&proto_hier_tree_info,\r\n(GTypeFlags)0);\r\ng_type_add_interface_static(proto_hier_tree_type,\r\nGTK_TYPE_TREE_MODEL,\r\n&tree_model_info);\r\n}\r\nreturn proto_hier_tree_type;\r\n}\r\nProtoHierTreeModel *\r\nproto_hier_tree_model_new(void)\r\n{\r\nProtoHierTreeModel *model;\r\nmodel = (ProtoHierTreeModel *) g_object_new(PROTOHIER_TYPE_TREE, NULL);\r\ng_assert(model != NULL);\r\nreturn model;\r\n}

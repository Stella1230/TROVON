static int\r\ndissect_pcnfsd_username(tvbuff_t *tvb, int offset, proto_tree *tree)\r\n{\r\nreturn dissect_rpc_string(tvb, tree, hf_pcnfsd_username, offset, NULL);\r\n}\r\nstatic int\r\ndissect_pcnfsd2_dissect_mapreq_arg_item(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree_add_item(tree, hf_pcnfsd_mapreq, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset = dissect_rpc_uint32(tvb, tree, hf_pcnfsd_uid, offset);\r\noffset = dissect_pcnfsd_username(tvb, offset, tree);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_pcnfsd2_mapid_call(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\noffset = dissect_rpc_string(tvb, tree, hf_pcnfsd_comment, offset, NULL);\r\noffset = dissect_rpc_list(tvb, pinfo, tree, offset,\r\ndissect_pcnfsd2_dissect_mapreq_arg_item, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_pcnfsd2_dissect_mapreq_res_item(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo _U_, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree_add_item(tree, hf_pcnfsd_mapreq, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_pcnfsd_mapreq_status, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset = dissect_rpc_uint32(tvb, tree, hf_pcnfsd_uid, offset);\r\noffset = dissect_pcnfsd_username(tvb, offset, tree);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_pcnfsd2_mapid_reply(tvbuff_t *tvb, packet_info *pinfo,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nint offset = 0;\r\noffset = dissect_rpc_string(tvb, tree, hf_pcnfsd_comment, offset, NULL);\r\noffset = dissect_rpc_list(tvb, pinfo, tree, offset,\r\ndissect_pcnfsd2_dissect_mapreq_res_item, NULL);\r\nreturn offset;\r\n}\r\nstatic char *\r\npcnfsd_decode_obscure(const char* data, int len)\r\n{\r\nchar *decoded_buf;\r\nchar *decoded_data;\r\ndecoded_buf = (char *)wmem_alloc(wmem_packet_scope(), len);\r\ndecoded_data = decoded_buf;\r\nfor ( ; len>0 ; len--, data++, decoded_data++) {\r\n*decoded_data = (*data ^ 0x5b) & 0x7f;\r\n}\r\nreturn decoded_buf;\r\n}\r\nstatic int\r\ndissect_pcnfsd2_auth_call(tvbuff_t *tvb, packet_info *pinfo _U_,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nint newoffset;\r\nconst char *ident = NULL;\r\nconst char *ident_decoded;\r\nproto_item *ident_item;\r\nproto_tree *ident_tree;\r\nconst char *password = NULL;\r\nproto_item *password_item = NULL;\r\nproto_tree *password_tree = NULL;\r\nint offset = 0;\r\noffset = dissect_rpc_string(tvb, tree,\r\nhf_pcnfsd_auth_client, offset, NULL);\r\nident_tree = proto_tree_add_subtree(tree, tvb,\r\noffset, -1, ett_pcnfsd_auth_ident, &ident_item, "Authentication Ident");\r\nnewoffset = dissect_rpc_string(tvb, ident_tree,\r\nhf_pcnfsd_auth_ident_obscure, offset, &ident);\r\nproto_item_set_len(ident_item, newoffset-offset);\r\nif (ident) {\r\nif (strcmp(ident, RPC_STRING_EMPTY) != 0)\r\nident_decoded = pcnfsd_decode_obscure(ident, (int)strlen(ident));\r\nelse\r\nident_decoded = ident;\r\nif (ident_tree)\r\nproto_tree_add_string(ident_tree,\r\nhf_pcnfsd_auth_ident_clear,\r\ntvb, offset+4, (gint)strlen(ident_decoded), ident_decoded);\r\n}\r\nif (ident_item) {\r\nproto_item_set_text(ident_item, "Authentication Ident: %s",\r\nident);\r\n}\r\noffset = newoffset;\r\npassword_tree = proto_tree_add_subtree(tree, tvb,\r\noffset, -1, ett_pcnfsd_auth_password, NULL, "Authentication Password");\r\nnewoffset = dissect_rpc_string(tvb, password_tree,\r\nhf_pcnfsd_auth_password_obscure, offset, &password);\r\nif (password_item) {\r\nproto_item_set_len(password_item, newoffset-offset);\r\n}\r\nif (password) {\r\nif (strcmp(password, RPC_STRING_EMPTY))\r\npcnfsd_decode_obscure(password, (int)strlen(password));\r\nif (password_tree)\r\nproto_tree_add_string(password_tree,\r\nhf_pcnfsd_auth_password_clear,\r\ntvb, offset+4, (gint)strlen(password), password);\r\n}\r\nif (password_item) {\r\nproto_item_set_text(password_item, "Authentication Password: %s",\r\npassword);\r\n}\r\noffset = newoffset;\r\noffset = dissect_rpc_string(tvb, tree,\r\nhf_pcnfsd_comment, offset, NULL);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_pcnfsd2_auth_reply(tvbuff_t *tvb, packet_info *pinfo _U_,\r\nproto_tree *tree, void* data _U_)\r\n{\r\nint gids_count;\r\nproto_tree *gtree;\r\nint gids_i;\r\nint offset = 0;\r\noffset = dissect_rpc_uint32(tvb, tree, hf_pcnfsd_status, offset);\r\noffset = dissect_rpc_uint32(tvb, tree, hf_pcnfsd_uid, offset);\r\noffset = dissect_rpc_uint32(tvb, tree, hf_pcnfsd_gid, offset);\r\ngids_count = tvb_get_ntohl(tvb,offset+0);\r\ngtree = proto_tree_add_subtree_format(tree, tvb,\r\noffset, 4+gids_count*4, ett_pcnfsd_gids, NULL, "Group IDs: %d", gids_count);\r\nproto_tree_add_item(gtree, hf_pcnfsd_gids_count, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nfor (gids_i = 0 ; gids_i < gids_count ; gids_i++) {\r\noffset = dissect_rpc_uint32(tvb, gtree,\r\nhf_pcnfsd_gid, offset);\r\n}\r\noffset = dissect_rpc_string(tvb, tree,\r\nhf_pcnfsd_homedir, offset, NULL);\r\noffset = dissect_rpc_uint32(tvb, tree, hf_pcnfsd_def_umask, offset);\r\noffset = dissect_rpc_string(tvb, tree,\r\nhf_pcnfsd_comment, offset, NULL);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_pcnfsd(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_pcnfsd_procedure_v1, {\r\n"V1 Procedure", "pcnfsd.procedure_v1", FT_UINT32, BASE_DEC,\r\nVALS(pcnfsd1_proc_vals), 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_procedure_v2, {\r\n"V2 Procedure", "pcnfsd.procedure_v2", FT_UINT32, BASE_DEC,\r\nVALS(pcnfsd2_proc_vals), 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_auth_client, {\r\n"Authentication Client", "pcnfsd.auth.client", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_auth_ident_obscure, {\r\n"Obscure Ident", "pcnfsd.auth.ident.obscure", FT_STRING, BASE_NONE,\r\nNULL, 0, "Authentication Obscure Ident", HFILL }},\r\n{ &hf_pcnfsd_auth_ident_clear, {\r\n"Clear Ident", "pcnfsd.auth.ident.clear", FT_STRING, BASE_NONE,\r\nNULL, 0, "Authentication Clear Ident", HFILL }},\r\n{ &hf_pcnfsd_auth_password_obscure, {\r\n"Obscure Password", "pcnfsd.auth.password.obscure", FT_STRING, BASE_NONE,\r\nNULL, 0, "Authentication Obscure Password", HFILL }},\r\n{ &hf_pcnfsd_auth_password_clear, {\r\n"Clear Password", "pcnfsd.auth.password.clear", FT_STRING, BASE_NONE,\r\nNULL, 0, "Authentication Clear Password", HFILL }},\r\n{ &hf_pcnfsd_comment, {\r\n"Comment", "pcnfsd.comment", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_status, {\r\n"Reply Status", "pcnfsd.status", FT_UINT32, BASE_DEC,\r\nNULL, 0, "Status", HFILL }},\r\n{ &hf_pcnfsd_uid, {\r\n"User ID", "pcnfsd.uid", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_gid, {\r\n"Group ID", "pcnfsd.gid", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_gids_count, {\r\n"Group ID Count", "pcnfsd.gids.count", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_homedir, {\r\n"Home Directory", "pcnfsd.homedir", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_def_umask, {\r\n"def_umask", "pcnfsd.def_umask", FT_UINT32, BASE_OCT,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_mapreq, {\r\n"Request", "pcnfsd.mapreq", FT_UINT32, BASE_DEC,\r\nVALS(names_mapreq), 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_mapreq_status, {\r\n"Status", "pcnfsd.mapreq_status", FT_UINT32, BASE_DEC,\r\nVALS(names_maprstat), 0, NULL, HFILL }},\r\n{ &hf_pcnfsd_username, {\r\n"User name", "pcnfsd.username", FT_STRING, BASE_NONE,\r\nNULL, 0, "pcnfsd.username", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_pcnfsd,\r\n&ett_pcnfsd_auth_ident,\r\n&ett_pcnfsd_auth_password,\r\n&ett_pcnfsd_gids\r\n};\r\nproto_pcnfsd = proto_register_protocol("PC NFS",\r\n"PCNFSD", "pcnfsd");\r\nproto_register_field_array(proto_pcnfsd, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_pcnfsd(void)\r\n{\r\nrpc_init_prog(proto_pcnfsd, PCNFSD_PROGRAM, ett_pcnfsd,\r\nG_N_ELEMENTS(pcnfsd_vers_info), pcnfsd_vers_info);\r\n}

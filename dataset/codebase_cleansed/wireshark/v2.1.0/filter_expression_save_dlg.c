void\r\nfilter_expression_save_dlg_init(gpointer filter_tb, gpointer filter_te)\r\n{\r\nstruct filter_expression *fe;\r\n_filter_tb = (GtkWidget *)filter_tb;\r\n_filter_te = (GtkWidget *)filter_te;\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nfilter_button_add(NULL, NULL, fe);\r\nfe = fe->next;\r\n}\r\n}\r\nvoid\r\nfilter_expression_reinit(int what)\r\n{\r\nstruct filter_expression *fe, *prevhead;\r\nif ((what & FILTER_EXPRESSION_REINIT_DESTROY) != 0) {\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nif (fe->button != NULL) {\r\ngtk_widget_destroy((GtkWidget *)fe->button);\r\nfe->button = NULL;\r\n}\r\nfe = fe->next;\r\n}\r\n}\r\nif (what == FILTER_EXPRESSION_REINIT_DESTROY) {\r\nfilter_expression_free(*pfilter_expression_head);\r\n*pfilter_expression_head = NULL;\r\nreturn;\r\n}\r\nif ((what & FILTER_EXPRESSION_REINIT_CREATE) != 0) {\r\ngint maxindx = -1, indx;\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nmaxindx = MAX(maxindx, fe->index);\r\nfe = fe->next;\r\n}\r\nprevhead = *pfilter_expression_head;\r\n*pfilter_expression_head = NULL;\r\nfor (indx = 0; indx <= maxindx; indx++) {\r\nif (prevhead != NULL) {\r\nfe = prevhead;\r\nwhile (fe != NULL && fe->index != indx)\r\nfe = fe->next;\r\n}\r\nif (fe == NULL)\r\ncontinue;\r\nif (fe->deleted)\r\ncontinue;\r\nfilter_expression_new(fe->label, fe->expression,\r\nfe->enabled);\r\n}\r\nfilter_expression_free(prevhead);\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nif (fe->enabled && !fe->deleted)\r\nfilter_button_add(NULL, NULL, fe);\r\nfe = fe->next;\r\n}\r\n}\r\n}\r\nstatic int\r\nfilter_button_add(const char *label, const char *expr, struct filter_expression *newfe)\r\n{\r\nstruct filter_expression *fe;\r\nif (newfe == NULL)\r\nfe = filter_expression_new(label, expr, TRUE);\r\nelse\r\nfe = newfe;\r\nif (fe->enabled == FALSE)\r\nreturn(0);\r\nfe->button = gtk_tool_button_new(NULL, fe->label);\r\ng_signal_connect(fe->button, "clicked", G_CALLBACK(filter_button_cb),\r\nNULL);\r\ngtk_widget_set_sensitive(GTK_WIDGET(fe->button), FALSE);\r\ngtk_widget_show(GTK_WIDGET(fe->button));\r\ngtk_toolbar_insert(GTK_TOOLBAR(_filter_tb), (GtkToolItem *)fe->button, -1);\r\ngtk_widget_set_sensitive(GTK_WIDGET(fe->button), TRUE);\r\ngtk_widget_set_tooltip_text(GTK_WIDGET(fe->button), fe->expression);\r\nreturn(0);\r\n}\r\nstatic void\r\nfilter_button_cb(GtkWidget *this_button, gpointer parent_w _U_)\r\n{\r\nstruct filter_expression *fe;\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nif ((void *)fe->button == (void *)this_button) {\r\ngtk_entry_set_text(GTK_ENTRY(_filter_te),\r\nfe->expression);\r\nmain_filter_packets(&cfile, fe->expression, FALSE);\r\nreturn;\r\n}\r\nfe = fe->next;\r\n}\r\nprintf("No Callback\n");\r\n}\r\nvoid\r\nfilter_expression_save_dlg(gpointer data)\r\n{\r\nGtkWidget *main_vb, *main_filter_save_hb, *filter_save_frame,\r\n*filter_save_type_vb, *filter_save_type_hb, *entry_hb,\r\n*bbox, *ok_bt, *cancel_bt, *help_bt, *filter_text_box,\r\n*label_text_box;\r\nconst char *expr;\r\nexpr = gtk_entry_get_text(GTK_ENTRY(data));\r\nif (filter_save_frame_w != NULL) {\r\nreactivate_window(filter_save_frame_w);\r\nreturn;\r\n}\r\nfilter_save_frame_w = dlg_window_new("Wireshark: Save Filter");\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(filter_save_frame_w), main_vb);\r\ngtk_widget_show(main_vb);\r\nmain_filter_save_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (main_vb), main_filter_save_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(main_filter_save_hb);\r\nfilter_save_frame = gtk_frame_new("Save Filter as...");\r\ngtk_box_pack_start(GTK_BOX(main_filter_save_hb), filter_save_frame,\r\nTRUE, TRUE, 0);\r\ngtk_widget_show(filter_save_frame);\r\nfilter_save_type_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(filter_save_type_vb), 3);\r\ngtk_container_add(GTK_CONTAINER(filter_save_frame),\r\nfilter_save_type_vb);\r\ngtk_widget_show(filter_save_type_vb);\r\nfilter_save_type_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (filter_save_type_vb), filter_save_type_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(filter_save_type_hb);\r\nentry_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX(filter_save_type_vb), entry_hb, FALSE,\r\nFALSE, 0);\r\ngtk_widget_show(entry_hb);\r\nfilter_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(entry_hb), filter_text_box, TRUE, TRUE, 0);\r\ng_signal_connect(filter_text_box, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_signal_connect(filter_text_box, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(filter_save_frame_w, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ngtk_entry_set_text(GTK_ENTRY(filter_text_box), expr);\r\ngtk_widget_show(filter_text_box);\r\nlabel_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(entry_hb), label_text_box, TRUE, TRUE, 0);\r\ngtk_entry_set_text(GTK_ENTRY(label_text_box), "Filter");\r\ngtk_widget_show(label_text_box);\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_CANCEL,\r\nGTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(filter_save_ok_cb),\r\nfilter_save_frame_w);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(filter_save_close_cb),\r\nfilter_save_frame_w);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb),\r\n(gpointer)HELP_FILTER_SAVE_DIALOG);\r\ng_object_set_data(G_OBJECT(filter_save_frame_w),\r\nE_FILTER_SAVE_EXPR_KEY, filter_text_box);\r\ng_object_set_data(G_OBJECT(filter_save_frame_w),\r\nE_FILTER_SAVE_LABEL_KEY, label_text_box);\r\ndlg_set_activate(label_text_box, ok_bt);\r\ngtk_widget_grab_focus(label_text_box);\r\ng_signal_connect(filter_save_frame_w, "delete_event",\r\nG_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(filter_save_frame_w, "destroy",\r\nG_CALLBACK(filter_save_frame_destroy_cb), NULL);\r\ngtk_widget_show(filter_save_frame_w);\r\nwindow_present(filter_save_frame_w);\r\n}\r\nstatic void\r\nfilter_save_ok_cb(GtkWidget *ok_bt _U_, GtkWindow *parent_w)\r\n{\r\nGtkWidget *expr_te, *label_te;\r\nconst char *expr, *label;\r\nexpr_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_FILTER_SAVE_EXPR_KEY);\r\nlabel_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_FILTER_SAVE_LABEL_KEY);\r\nexpr = gtk_entry_get_text(GTK_ENTRY(expr_te));\r\nlabel = gtk_entry_get_text(GTK_ENTRY(label_te));\r\nif (filter_button_add(label, expr, NULL) == 0) {\r\nprefs_main_write();\r\nfilter_save_close_cb(NULL, parent_w);\r\n}\r\n}\r\nstatic void\r\nfilter_save_close_cb(GtkWidget *close_bt _U_, gpointer parent_w)\r\n{\r\ngtk_grab_remove(GTK_WIDGET(parent_w));\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\nfilter_save_frame_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\nfilter_save_frame_w = NULL;\r\n}

void nghttp2_buf_init(nghttp2_buf *buf) {\r\nbuf->begin = NULL;\r\nbuf->end = NULL;\r\nbuf->pos = NULL;\r\nbuf->last = NULL;\r\nbuf->mark = NULL;\r\n}\r\nint nghttp2_buf_init2(nghttp2_buf *buf, size_t initial, nghttp2_mem *mem) {\r\nnghttp2_buf_init(buf);\r\nreturn nghttp2_buf_reserve(buf, initial, mem);\r\n}\r\nvoid nghttp2_buf_free(nghttp2_buf *buf, nghttp2_mem *mem) {\r\nif (buf == NULL) {\r\nreturn;\r\n}\r\nnghttp2_mem_free(mem, buf->begin);\r\nbuf->begin = NULL;\r\n}\r\nint nghttp2_buf_reserve(nghttp2_buf *buf, size_t new_cap, nghttp2_mem *mem) {\r\nuint8_t *ptr;\r\nsize_t cap;\r\ncap = nghttp2_buf_cap(buf);\r\nif (cap >= new_cap) {\r\nreturn 0;\r\n}\r\nnew_cap = nghttp2_max(new_cap, cap * 2);\r\nptr = (uint8_t *)nghttp2_mem_realloc(mem, buf->begin, new_cap);\r\nif (ptr == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nbuf->pos = ptr + (buf->pos - buf->begin);\r\nbuf->last = ptr + (buf->last - buf->begin);\r\nbuf->mark = ptr + (buf->mark - buf->begin);\r\nbuf->begin = ptr;\r\nbuf->end = ptr + new_cap;\r\nreturn 0;\r\n}\r\nvoid nghttp2_buf_reset(nghttp2_buf *buf) {\r\nbuf->pos = buf->last = buf->mark = buf->begin;\r\n}\r\nvoid nghttp2_buf_wrap_init(nghttp2_buf *buf, uint8_t *begin, size_t len) {\r\nbuf->begin = buf->pos = buf->last = buf->mark = begin;\r\nbuf->end = begin + len;\r\n}\r\nstatic int buf_chain_new(nghttp2_buf_chain **chain, size_t chunk_length,\r\nnghttp2_mem *mem) {\r\nint rv;\r\n*chain = (nghttp2_buf_chain *)nghttp2_mem_malloc(mem, sizeof(nghttp2_buf_chain));\r\nif (*chain == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\n(*chain)->next = NULL;\r\nrv = nghttp2_buf_init2(&(*chain)->buf, chunk_length, mem);\r\nif (rv != 0) {\r\nnghttp2_mem_free(mem, *chain);\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic void buf_chain_del(nghttp2_buf_chain *chain, nghttp2_mem *mem) {\r\nnghttp2_buf_free(&chain->buf, mem);\r\nnghttp2_mem_free(mem, chain);\r\n}\r\nint nghttp2_bufs_init(nghttp2_bufs *bufs, size_t chunk_length, size_t max_chunk,\r\nnghttp2_mem *mem) {\r\nreturn nghttp2_bufs_init2(bufs, chunk_length, max_chunk, 0, mem);\r\n}\r\nint nghttp2_bufs_init2(nghttp2_bufs *bufs, size_t chunk_length,\r\nsize_t max_chunk, size_t offset, nghttp2_mem *mem) {\r\nreturn nghttp2_bufs_init3(bufs, chunk_length, max_chunk, max_chunk, offset,\r\nmem);\r\n}\r\nint nghttp2_bufs_init3(nghttp2_bufs *bufs, size_t chunk_length,\r\nsize_t max_chunk, size_t chunk_keep, size_t offset,\r\nnghttp2_mem *mem) {\r\nint rv;\r\nnghttp2_buf_chain *chain;\r\nif (chunk_keep == 0 || max_chunk < chunk_keep || chunk_length < offset) {\r\nreturn NGHTTP2_ERR_INVALID_ARGUMENT;\r\n}\r\nrv = buf_chain_new(&chain, chunk_length, mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nbufs->mem = mem;\r\nbufs->offset = offset;\r\nbufs->head = chain;\r\nbufs->cur = bufs->head;\r\nnghttp2_buf_shift_right(&bufs->cur->buf, offset);\r\nbufs->chunk_length = chunk_length;\r\nbufs->chunk_used = 1;\r\nbufs->max_chunk = max_chunk;\r\nbufs->chunk_keep = chunk_keep;\r\nreturn 0;\r\n}\r\nint nghttp2_bufs_realloc(nghttp2_bufs *bufs, size_t chunk_length) {\r\nint rv;\r\nnghttp2_buf_chain *chain;\r\nif (chunk_length < bufs->offset) {\r\nreturn NGHTTP2_ERR_INVALID_ARGUMENT;\r\n}\r\nrv = buf_chain_new(&chain, chunk_length, bufs->mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nnghttp2_bufs_free(bufs);\r\nbufs->head = chain;\r\nbufs->cur = bufs->head;\r\nnghttp2_buf_shift_right(&bufs->cur->buf, bufs->offset);\r\nbufs->chunk_length = chunk_length;\r\nbufs->chunk_used = 1;\r\nreturn 0;\r\n}\r\nvoid nghttp2_bufs_free(nghttp2_bufs *bufs) {\r\nnghttp2_buf_chain *chain, *next_chain;\r\nif (bufs == NULL) {\r\nreturn;\r\n}\r\nfor (chain = bufs->head; chain;) {\r\nnext_chain = chain->next;\r\nbuf_chain_del(chain, bufs->mem);\r\nchain = next_chain;\r\n}\r\nbufs->head = NULL;\r\n}\r\nint nghttp2_bufs_wrap_init(nghttp2_bufs *bufs, uint8_t *begin, size_t len,\r\nnghttp2_mem *mem) {\r\nnghttp2_buf_chain *chain;\r\nchain = (nghttp2_buf_chain *)nghttp2_mem_malloc(mem, sizeof(nghttp2_buf_chain));\r\nif (chain == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nchain->next = NULL;\r\nnghttp2_buf_wrap_init(&chain->buf, begin, len);\r\nbufs->mem = mem;\r\nbufs->offset = 0;\r\nbufs->head = chain;\r\nbufs->cur = bufs->head;\r\nbufs->chunk_length = len;\r\nbufs->chunk_used = 1;\r\nbufs->max_chunk = 1;\r\nbufs->chunk_keep = 1;\r\nreturn 0;\r\n}\r\nvoid nghttp2_bufs_wrap_free(nghttp2_bufs *bufs) {\r\nif (bufs == NULL) {\r\nreturn;\r\n}\r\nnghttp2_mem_free(bufs->mem, bufs->head);\r\nbufs->head = NULL;\r\n}\r\nvoid nghttp2_bufs_seek_last_present(nghttp2_bufs *bufs) {\r\nnghttp2_buf_chain *ci;\r\nfor (ci = bufs->cur; ci; ci = ci->next) {\r\nif (nghttp2_buf_len(&ci->buf) == 0) {\r\nreturn;\r\n} else {\r\nbufs->cur = ci;\r\n}\r\n}\r\n}\r\nsize_t nghttp2_bufs_len(nghttp2_bufs *bufs) {\r\nnghttp2_buf_chain *ci;\r\nsize_t len;\r\nlen = 0;\r\nfor (ci = bufs->head; ci; ci = ci->next) {\r\nlen += nghttp2_buf_len(&ci->buf);\r\n}\r\nreturn len;\r\n}\r\nstatic size_t bufs_avail(nghttp2_bufs *bufs) {\r\nreturn nghttp2_buf_avail(&bufs->cur->buf) +\r\n(bufs->chunk_length - bufs->offset) *\r\n(bufs->max_chunk - bufs->chunk_used);\r\n}\r\nstatic int bufs_alloc_chain(nghttp2_bufs *bufs) {\r\nint rv;\r\nnghttp2_buf_chain *chain;\r\nif (bufs->cur->next) {\r\nbufs->cur = bufs->cur->next;\r\nreturn 0;\r\n}\r\nif (bufs->max_chunk == bufs->chunk_used) {\r\nreturn NGHTTP2_ERR_BUFFER_ERROR;\r\n}\r\nrv = buf_chain_new(&chain, bufs->chunk_length, bufs->mem);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nDEBUGF(fprintf(stderr,\r\n"new buffer %zu bytes allocated for bufs %p, used %zu\n",\r\nbufs->chunk_length, bufs, bufs->chunk_used));\r\n++bufs->chunk_used;\r\nbufs->cur->next = chain;\r\nbufs->cur = chain;\r\nnghttp2_buf_shift_right(&bufs->cur->buf, bufs->offset);\r\nreturn 0;\r\n}\r\nint nghttp2_bufs_add(nghttp2_bufs *bufs, const void *data, size_t len) {\r\nint rv;\r\nsize_t nwrite;\r\nnghttp2_buf *buf;\r\nconst uint8_t *p;\r\nif (bufs_avail(bufs) < len) {\r\nreturn NGHTTP2_ERR_BUFFER_ERROR;\r\n}\r\np = (const uint8_t *)data;\r\nwhile (len) {\r\nbuf = &bufs->cur->buf;\r\nnwrite = nghttp2_min(nghttp2_buf_avail(buf), len);\r\nif (nwrite == 0) {\r\nrv = bufs_alloc_chain(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\ncontinue;\r\n}\r\nbuf->last = nghttp2_cpymem(buf->last, p, nwrite);\r\np += nwrite;\r\nlen -= nwrite;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bufs_ensure_addb(nghttp2_bufs *bufs) {\r\nint rv;\r\nnghttp2_buf *buf;\r\nbuf = &bufs->cur->buf;\r\nif (nghttp2_buf_avail(buf) > 0) {\r\nreturn 0;\r\n}\r\nrv = bufs_alloc_chain(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\nreturn 0;\r\n}\r\nint nghttp2_bufs_addb(nghttp2_bufs *bufs, uint8_t b) {\r\nint rv;\r\nrv = bufs_ensure_addb(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n*bufs->cur->buf.last++ = b;\r\nreturn 0;\r\n}\r\nint nghttp2_bufs_addb_hold(nghttp2_bufs *bufs, uint8_t b) {\r\nint rv;\r\nrv = bufs_ensure_addb(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n*bufs->cur->buf.last = b;\r\nreturn 0;\r\n}\r\nint nghttp2_bufs_orb(nghttp2_bufs *bufs, uint8_t b) {\r\nint rv;\r\nrv = bufs_ensure_addb(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n*bufs->cur->buf.last++ |= b;\r\nreturn 0;\r\n}\r\nint nghttp2_bufs_orb_hold(nghttp2_bufs *bufs, uint8_t b) {\r\nint rv;\r\nrv = bufs_ensure_addb(bufs);\r\nif (rv != 0) {\r\nreturn rv;\r\n}\r\n*bufs->cur->buf.last |= b;\r\nreturn 0;\r\n}\r\nssize_t nghttp2_bufs_remove(nghttp2_bufs *bufs, uint8_t **out) {\r\nsize_t len;\r\nnghttp2_buf_chain *chain;\r\nnghttp2_buf *buf;\r\nuint8_t *res;\r\nnghttp2_buf resbuf;\r\nlen = 0;\r\nfor (chain = bufs->head; chain; chain = chain->next) {\r\nlen += nghttp2_buf_len(&chain->buf);\r\n}\r\nif (len == 0) {\r\nres = NULL;\r\nreturn 0;\r\n}\r\nres = (uint8_t *)nghttp2_mem_malloc(bufs->mem, len);\r\nif (res == NULL) {\r\nreturn NGHTTP2_ERR_NOMEM;\r\n}\r\nnghttp2_buf_wrap_init(&resbuf, res, len);\r\nfor (chain = bufs->head; chain; chain = chain->next) {\r\nbuf = &chain->buf;\r\nresbuf.last = nghttp2_cpymem(resbuf.last, buf->pos, nghttp2_buf_len(buf));\r\n}\r\n*out = res;\r\nreturn (ssize_t)len;\r\n}\r\nsize_t nghttp2_bufs_remove_copy(nghttp2_bufs *bufs, uint8_t *out) {\r\nsize_t len;\r\nnghttp2_buf_chain *chain;\r\nnghttp2_buf *buf;\r\nnghttp2_buf resbuf;\r\nlen = nghttp2_bufs_len(bufs);\r\nnghttp2_buf_wrap_init(&resbuf, out, len);\r\nfor (chain = bufs->head; chain; chain = chain->next) {\r\nbuf = &chain->buf;\r\nresbuf.last = nghttp2_cpymem(resbuf.last, buf->pos, nghttp2_buf_len(buf));\r\n}\r\nreturn len;\r\n}\r\nvoid nghttp2_bufs_reset(nghttp2_bufs *bufs) {\r\nnghttp2_buf_chain *chain, *ci;\r\nsize_t k;\r\nk = bufs->chunk_keep;\r\nfor (ci = bufs->head; ci; ci = ci->next) {\r\nnghttp2_buf_reset(&ci->buf);\r\nnghttp2_buf_shift_right(&ci->buf, bufs->offset);\r\nif (--k == 0) {\r\nbreak;\r\n}\r\n}\r\nif (ci) {\r\nchain = ci->next;\r\nci->next = NULL;\r\nfor (ci = chain; ci;) {\r\nchain = ci->next;\r\nbuf_chain_del(ci, bufs->mem);\r\nci = chain;\r\n}\r\nbufs->chunk_used = bufs->chunk_keep;\r\n}\r\nbufs->cur = bufs->head;\r\n}\r\nint nghttp2_bufs_advance(nghttp2_bufs *bufs) { return bufs_alloc_chain(bufs); }\r\nint nghttp2_bufs_next_present(nghttp2_bufs *bufs) {\r\nnghttp2_buf_chain *chain;\r\nchain = bufs->cur->next;\r\nreturn chain && nghttp2_buf_len(&chain->buf);\r\n}

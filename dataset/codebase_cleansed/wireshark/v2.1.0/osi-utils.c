gchar *\r\nprint_nsap_net( tvbuff_t *tvb, const gint offset, int length )\r\n{\r\ngchar *cur;\r\ncur = (gchar *)wmem_alloc(wmem_packet_scope(), MAX_NSAP_LEN * 3 + 50);\r\nprint_nsap_net_buf( tvb_get_ptr(tvb, offset, length), length, cur, MAX_NSAP_LEN * 3 + 50);\r\nreturn( cur );\r\n}\r\nvoid\r\nprint_nsap_net_buf( const guint8 *ad, int length, gchar *buf, int buf_len)\r\n{\r\ngchar *cur;\r\nif ( (length <= 0 ) || ( length > MAX_NSAP_LEN ) ) {\r\ng_strlcpy(buf, "<Invalid length of NSAP>", buf_len);\r\nreturn;\r\n}\r\ncur = buf;\r\nif ( ( length == RFC1237_NSAP_LEN ) || ( length == RFC1237_NSAP_LEN + 1 ) ) {\r\nprint_area_buf(ad, RFC1237_FULLAREA_LEN, cur, buf_len);\r\ncur += strlen( cur );\r\nprint_system_id_buf( ad + RFC1237_FULLAREA_LEN, RFC1237_SYSTEMID_LEN, cur, (int) (buf_len-(cur-buf)));\r\ncur += strlen( cur );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "[%02x]",\r\nad[ RFC1237_FULLAREA_LEN + RFC1237_SYSTEMID_LEN ] );\r\nif ( length == RFC1237_NSAP_LEN + 1 ) {\r\ng_snprintf(cur, (int) (buf_len-(cur-buf)), "-%02x", ad[ length -1 ] );\r\n}\r\n}\r\nelse {\r\nprint_area_buf( ad, length, buf, buf_len);\r\n}\r\n}\r\ngchar *\r\nprint_system_id(wmem_allocator_t* scope, const guint8 *ad, int length )\r\n{\r\ngchar *cur;\r\ncur = (gchar *)wmem_alloc(scope, MAX_SYSTEMID_LEN * 3 + 5);\r\nprint_system_id_buf(ad, length, cur, MAX_SYSTEMID_LEN * 3 + 5);\r\nreturn( cur );\r\n}\r\ngchar *\r\ntvb_print_system_id( tvbuff_t *tvb, const gint offset, int length )\r\n{\r\nreturn( print_system_id(wmem_packet_scope(), tvb_get_ptr(tvb, offset, length), length) );\r\n}\r\nvoid\r\nprint_system_id_buf( const guint8 *ad, int length, gchar *buf, int buf_len)\r\n{\r\ngchar *cur;\r\nint tmp;\r\nif ( ( length <= 0 ) || ( length > MAX_SYSTEMID_LEN ) ) {\r\ng_strlcpy(buf, "<Invalid length of SYSTEM ID>", buf_len);\r\nreturn;\r\n}\r\ncur = buf;\r\nif ( ( 6 == length ) ||\r\n( 7 == length ) ||\r\n( 8 == length )) {\r\ncur += g_snprintf(cur, buf_len, "%02x%02x.%02x%02x.%02x%02x", ad[0], ad[1],\r\nad[2], ad[3], ad[4], ad[5] );\r\nif ( ( 7 == length ) ||\r\n( 8 == length )) {\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), ".%02x", ad[6] );\r\n}\r\nif ( 8 == length ) {\r\ng_snprintf(cur, (gulong) (buf_len-(cur-buf)), "-%02x", ad[7] );\r\n}\r\n}\r\nelse {\r\ntmp = 0;\r\nwhile ( tmp < length / 4 ) {\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x.", ad[tmp++] );\r\n}\r\nif ( 1 == tmp ) {\r\ncur--;\r\ng_snprintf(cur, (gulong) (buf_len-(cur-buf)), ".%02x", ad[tmp] );\r\n}\r\nelse {\r\nfor ( ; tmp < length; ) {\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\n}\r\n}\r\n}\r\n}\r\ngchar *\r\nprint_area(tvbuff_t *tvb, const gint offset, int length)\r\n{\r\ngchar *cur;\r\ncur = (gchar *)wmem_alloc(wmem_packet_scope(), MAX_AREA_LEN * 3 + 20);\r\nprint_area_buf(tvb_get_ptr(tvb, offset, length), length, cur, MAX_AREA_LEN * 3 + 20);\r\nreturn cur;\r\n}\r\nvoid\r\nprint_area_buf(const guint8 *ad, int length, gchar *buf, int buf_len)\r\n{\r\ngchar *cur;\r\nint tmp = 0;\r\nif (length <= 0 || length > MAX_AREA_LEN) {\r\ng_strlcpy(buf, "<Invalid length of AREA>", buf_len);\r\nreturn;\r\n}\r\ncur = buf;\r\nif ( ( ( NSAP_IDI_ISODCC == *ad )\r\n|| ( NSAP_IDI_GOSIP2 == *ad )\r\n)\r\n&&\r\n( ( RFC1237_FULLAREA_LEN == length )\r\n|| ( RFC1237_FULLAREA_LEN + 1 == length )\r\n)\r\n) {\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "[%02x|%02x:%02x][%02x|%02x:%02x:%02x|%02x:%02x]",\r\nad[0], ad[1], ad[2], ad[3], ad[4],\r\nad[5], ad[6], ad[7], ad[8] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "[%02x:%02x|%02x:%02x]",\r\nad[9], ad[10], ad[11], ad[12] );\r\nif ( RFC1237_FULLAREA_LEN + 1 == length )\r\ng_snprintf(cur, (gulong) (buf_len-(cur-buf)), "-[%02x]", ad[20] );\r\n}\r\nelse {\r\nif ( length == RFC1237_AREA_LEN ) {\r\ng_snprintf(buf, buf_len, "%02x.%02x%02x", ad[0], ad[1], ad[2] );\r\nreturn;\r\n}\r\nif ( length == 4 ) {\r\ng_snprintf(buf, buf_len, "%02x%02x%02x%02x", ad[0], ad[1], ad[2], ad[3] );\r\nreturn;\r\n}\r\nwhile ( tmp < length / 4 ) {\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x.", ad[tmp++] );\r\n}\r\nif ( 1 == tmp ) {\r\ncur--;\r\ng_snprintf(cur, (gulong) (buf_len-(cur-buf)), "-%02x", ad[tmp] );\r\n}\r\nelse {\r\nfor ( ; tmp < length; ) {\r\ncur += g_snprintf(cur, (gulong) (buf_len-(cur-buf)), "%02x", ad[tmp++] );\r\n}\r\n}\r\n}\r\n}\r\nstatic int osi_address_to_str(const address* addr, gchar *buf, int buf_len)\r\n{\r\nprint_nsap_net_buf((const guint8 *)addr->data, addr->len, buf, buf_len);\r\nreturn (int)strlen(buf)+1;\r\n}\r\nstatic int osi_address_str_len(const address* addr _U_)\r\n{\r\nreturn MAX_NSAP_LEN * 3 + 50;\r\n}\r\nint get_osi_address_type(void)\r\n{\r\nreturn osi_address_type;\r\n}\r\nvoid register_osi_address_type(void)\r\n{\r\nif (osi_address_type != -1)\r\nreturn;\r\nosi_address_type = address_type_dissector_register("AT_OSI", "OSI Address", osi_address_to_str, osi_address_str_len, NULL, NULL, NULL, NULL);\r\n}

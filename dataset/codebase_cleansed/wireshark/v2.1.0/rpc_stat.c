static char *\r\nrpcstat_gen_title(rpcstat_t *rs)\r\n{\r\nchar *display_name;\r\nchar *title;\r\ndisplay_name = cf_get_display_name(&cfile);\r\ntitle = g_strdup_printf("ONC-RPC Service Response Time statistics for %s version %d: %s",\r\nrs->prog, rs->version, display_name);\r\ng_free(display_name);\r\nreturn title;\r\n}\r\nstatic void\r\nrpcstat_set_title(rpcstat_t *rs)\r\n{\r\nchar *title;\r\ntitle = rpcstat_gen_title(rs);\r\ngtk_window_set_title(GTK_WINDOW(rs->gtk_data.win), title);\r\ng_free(title);\r\n}\r\nstatic void\r\nrpcstat_reset(void *arg)\r\n{\r\nsrt_data_t *srt = (srt_data_t*)arg;\r\nrpcstat_t *rs = (rpcstat_t *)srt->user_data;\r\nreset_srt_table(rs->data.srt_array, reset_table_data, &rs->gtk_data);\r\nrpcstat_set_title(rs);\r\n}\r\nstatic void\r\nrpcstat_draw(void *arg)\r\n{\r\nguint i = 0;\r\nsrt_stat_table *srt_table;\r\nsrt_data_t *srt = (srt_data_t*)arg;\r\nrpcstat_t *rs = (rpcstat_t *)srt->user_data;\r\nfor (i = 0; i < srt->srt_array->len; i++)\r\n{\r\nsrt_table = g_array_index(srt->srt_array, srt_stat_table*, i);\r\ndraw_srt_table_data(srt_table, &rs->gtk_data);\r\n}\r\n}\r\nstatic void\r\nrpcstat_find_procs(const gchar *table_name _U_, ftenum_t selector_type _U_, gpointer key, gpointer value _U_, gpointer user_data _U_)\r\n{\r\nrpc_proc_info_key *k=(rpc_proc_info_key *)key;\r\nif(k->prog!=rpc_program){\r\nreturn;\r\n}\r\nif(k->vers!=rpc_version){\r\nreturn;\r\n}\r\nif(rpc_min_proc==-1){\r\nrpc_min_proc=k->proc;\r\nrpc_max_proc=k->proc;\r\n}\r\nif((gint32)k->proc<rpc_min_proc){\r\nrpc_min_proc=k->proc;\r\n}\r\nif((gint32)k->proc>rpc_max_proc){\r\nrpc_max_proc=k->proc;\r\n}\r\nreturn;\r\n}\r\nstatic void\r\nrpcstat_find_vers(const gchar *table_name _U_, ftenum_t selector_type _U_, gpointer key, gpointer value _U_, gpointer user_data _U_)\r\n{\r\nrpc_proc_info_key *k=(rpc_proc_info_key *)key;\r\nif(k->prog!=rpc_program){\r\nreturn;\r\n}\r\nif(rpc_min_vers==-1){\r\nrpc_min_vers=k->vers;\r\nrpc_max_vers=k->vers;\r\n}\r\nif((gint32)k->vers<rpc_min_vers){\r\nrpc_min_vers=k->vers;\r\n}\r\nif((gint32)k->vers>rpc_max_vers){\r\nrpc_max_vers=k->vers;\r\n}\r\nreturn;\r\n}\r\nstatic void\r\nwin_destroy_cb(GtkWindow *win _U_, gpointer data)\r\n{\r\nrpcstat_t *rs=(rpcstat_t *)data;\r\nremove_tap_listener(&rs->data);\r\nfree_srt_table(rs->srt, rs->data.srt_array, free_table_data, &rs->gtk_data);\r\ng_free(rs);\r\n}\r\nstatic void\r\ngtk_rpcstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nrpcstat_t *rs;\r\nchar *title_string;\r\nchar *filter_string;\r\nGtkWidget *stat_label;\r\nGtkWidget *filter_label;\r\nGtkWidget *bbox;\r\nGtkWidget *close_bt;\r\nint program, version, pos;\r\nconst char *filter=NULL;\r\nGString *error_string;\r\nrpcstat_tap_data_t* tap_data;\r\npos=0;\r\nif(sscanf(opt_arg,"rpc,srt,%d,%d,%n",&program,&version,&pos)==2){\r\nif(pos){\r\nfilter=opt_arg+pos;\r\n} else {\r\nfilter=NULL;\r\n}\r\n} else {\r\nfprintf(stderr, "wireshark: invalid \"-z rpc,srt,<program>,<version>[,<filter>]\" argument\n");\r\nexit(1);\r\n}\r\nrpc_program=program;\r\nrpc_version=version;\r\nrs=(rpcstat_t *)g_malloc0(sizeof(rpcstat_t));\r\nrs->prog = rpc_prog_name(program);\r\nrs->version = version;\r\nrs->gtk_data.win = dlg_window_new("rpc-stat");\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(rs->gtk_data.win), TRUE);\r\ngtk_window_set_default_size(GTK_WINDOW(rs->gtk_data.win), SRT_PREFERRED_WIDTH, SRT_PREFERRED_HEIGHT);\r\nrpcstat_set_title(rs);\r\nrs->gtk_data.vbox=ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(rs->gtk_data.win), rs->gtk_data.vbox);\r\ngtk_container_set_border_width(GTK_CONTAINER(rs->gtk_data.vbox), 12);\r\ntitle_string = rpcstat_gen_title(rs);\r\nstat_label=gtk_label_new(title_string);\r\ng_free(title_string);\r\ngtk_box_pack_start(GTK_BOX(rs->gtk_data.vbox), stat_label, FALSE, FALSE, 0);\r\nfilter_string = g_strdup_printf("Filter: %s", filter ? filter : "");\r\nfilter_label=gtk_label_new(filter_string);\r\ng_free(filter_string);\r\ngtk_label_set_line_wrap(GTK_LABEL(filter_label), TRUE);\r\ngtk_box_pack_start(GTK_BOX(rs->gtk_data.vbox), filter_label, FALSE, FALSE, 0);\r\nrpc_min_proc=-1;\r\nrpc_max_proc=-1;\r\ndissector_table_foreach ("rpc.call", rpcstat_find_procs, NULL);\r\ndissector_table_foreach ("rpc.reply", rpcstat_find_procs, NULL);\r\ngtk_widget_show_all(rs->gtk_data.win);\r\nrs->srt = get_srt_table_by_name("rpc");\r\ntap_data = g_new0(rpcstat_tap_data_t, 1);\r\ntap_data->prog = rpc_prog_name(program);\r\ntap_data->program = program;\r\ntap_data->version = version;\r\ntap_data->num_procedures = rpc_max_proc+1;\r\nset_srt_table_param_data(rs->srt, tap_data);\r\nrs->gtk_data.gtk_srt_array = g_array_new(FALSE, TRUE, sizeof(gtk_srt_table_t*));\r\nrs->data.srt_array = g_array_new(FALSE, TRUE, sizeof(srt_stat_table*));\r\nrs->data.user_data = rs;\r\nsrt_table_dissector_init(rs->srt, rs->data.srt_array, init_gtk_srt_table, &rs->gtk_data);\r\nerror_string=register_tap_listener("rpc", &rs->data, filter, 0, rpcstat_reset, get_srt_packet_func(rs->srt), rpcstat_draw);\r\nif(error_string){\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", error_string->str);\r\ng_string_free(error_string, TRUE);\r\nfree_srt_table(rs->srt, rs->data.srt_array, NULL, NULL);\r\ng_free(rs);\r\nreturn;\r\n}\r\nbbox = dlg_button_row_new(GTK_STOCK_CLOSE, NULL);\r\ngtk_box_pack_end(GTK_BOX(rs->gtk_data.vbox), bbox, FALSE, FALSE, 0);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(rs->gtk_data.win, close_bt, window_cancel_button_cb);\r\ng_signal_connect(rs->gtk_data.win, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(rs->gtk_data.win, "destroy", G_CALLBACK(win_destroy_cb), rs);\r\ngtk_widget_show_all(rs->gtk_data.win);\r\nwindow_present(rs->gtk_data.win);\r\ncf_retap_packets(&cfile);\r\ngdk_window_raise(gtk_widget_get_window(rs->gtk_data.win));\r\n}\r\nstatic void\r\nrpcstat_start_button_clicked(GtkWidget *item _U_, gpointer data _U_)\r\n{\r\nGString *str;\r\nconst char *filter;\r\nstr = g_string_new("rpc,srt");\r\ng_string_append_printf(str, ",%d,%d", rpc_program, rpc_version);\r\nfilter=gtk_entry_get_text(GTK_ENTRY(filter_entry));\r\nif(filter[0]!=0){\r\ng_string_append_printf(str, ",%s", filter);\r\n}\r\ngtk_rpcstat_init(str->str,NULL);\r\ng_string_free(str, TRUE);\r\n}\r\nstatic void\r\nrpcstat_version_select(GtkWidget *vers_combo_box, gpointer user_data _U_)\r\n{\r\ngpointer ptr;\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(vers_combo_box), &ptr)) {\r\ng_assert_not_reached();\r\n}\r\nrpc_version=GPOINTER_TO_INT(ptr);\r\n}\r\nstatic void\r\nrpcstat_program_select(GtkWidget *prog_combo_box, gpointer user_data)\r\n{\r\nguint32 k;\r\nGtkWidget *vers_combo_box;\r\nint i;\r\nvers_combo_box = (GtkWidget *)user_data;\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(prog_combo_box), (gpointer *)&k)) {\r\ng_assert_not_reached();\r\n}\r\nrpc_program=k;\r\nrpc_version=0;\r\ng_signal_handlers_disconnect_by_func(vers_combo_box, G_CALLBACK(rpcstat_version_select), NULL );\r\nws_combo_box_clear_text_and_pointer(GTK_COMBO_BOX(vers_combo_box));\r\nrpc_min_vers=-1;\r\nrpc_max_vers=-1;\r\ndissector_table_foreach ("rpc.call", rpcstat_find_vers, NULL);\r\ndissector_table_foreach ("rpc.reply", rpcstat_find_vers, NULL);\r\nfor(i=rpc_min_vers;i<=rpc_max_vers;i++){\r\nchar vs[5];\r\ng_snprintf(vs, sizeof(vs), "%d",i);\r\nws_combo_box_append_text_and_pointer(GTK_COMBO_BOX(vers_combo_box),\r\nvs, GINT_TO_POINTER(i));\r\n}\r\ng_signal_connect(vers_combo_box, "changed", G_CALLBACK(rpcstat_version_select), NULL);\r\nws_combo_box_set_active(GTK_COMBO_BOX(vers_combo_box), 0);\r\n}\r\nstatic void\r\nrpcstat_list_programs(gpointer *key, gpointer *value, gpointer user_data)\r\n{\r\nguint32 k=GPOINTER_TO_UINT(key);\r\nrpc_prog_info_value *v=(rpc_prog_info_value *)value;\r\nGtkComboBox *prog_combo_box = (GtkComboBox *)user_data;\r\nws_combo_box_append_text_and_pointer(prog_combo_box, v->progname, GUINT_TO_POINTER(k));\r\nif(!rpc_program){\r\nrpc_program=k;\r\n}\r\n}\r\nstatic void\r\ndlg_destroy_cb(GtkWidget *w _U_, gpointer user_data _U_)\r\n{\r\ndlg=NULL;\r\n}\r\nvoid\r\ngtk_rpcstat_cb(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nGtkWidget *dlg_box;\r\nGtkWidget *prog_box, *prog_label;\r\nGtkWidget *vers_label;\r\nGtkWidget *prog_combo_box, *vers_combo_box;\r\nGtkWidget *filter_box, *filter_bt;\r\nGtkWidget *bbox, *start_button, *cancel_button;\r\nconst char *filter;\r\nstatic construct_args_t args = {\r\n"Service Response Time Statistics Filter",\r\nTRUE,\r\nFALSE,\r\nFALSE\r\n};\r\nif(dlg){\r\ngdk_window_raise(gtk_widget_get_window(dlg));\r\nreturn;\r\n}\r\ndlg=dlg_window_new("Wireshark: Compute ONC-RPC SRT statistics");\r\ngtk_window_set_default_size(GTK_WINDOW(dlg), 300, -1);\r\ndlg_box=ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 10, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(dlg_box), 10);\r\ngtk_container_add(GTK_CONTAINER(dlg), dlg_box);\r\ngtk_widget_show(dlg_box);\r\nprog_box=ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 10, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(prog_box), 10);\r\nprog_label=gtk_label_new("Program:");\r\ngtk_box_pack_start(GTK_BOX(prog_box), prog_label, FALSE, FALSE, 0);\r\ngtk_widget_show(prog_label);\r\nprog_combo_box=ws_combo_box_new_text_and_pointer();\r\ng_hash_table_foreach(rpc_progs, (GHFunc)rpcstat_list_programs, prog_combo_box);\r\ngtk_box_pack_start(GTK_BOX(prog_box), prog_combo_box, TRUE, TRUE, 0);\r\ngtk_widget_show(prog_combo_box);\r\ngtk_container_set_border_width(GTK_CONTAINER(prog_box), 10);\r\nvers_label=gtk_label_new("Version:");\r\ngtk_box_pack_start(GTK_BOX(prog_box), vers_label, FALSE, FALSE, 0);\r\ngtk_widget_show(vers_label);\r\nvers_combo_box=ws_combo_box_new_text_and_pointer();\r\ngtk_box_pack_start(GTK_BOX(prog_box), vers_combo_box, TRUE, TRUE, 0);\r\ngtk_widget_show(vers_combo_box);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), prog_box, TRUE, TRUE, 0);\r\ng_signal_connect(prog_combo_box, "changed", G_CALLBACK(rpcstat_program_select), vers_combo_box);\r\nws_combo_box_set_active(GTK_COMBO_BOX(prog_combo_box), 0);\r\ngtk_widget_show(prog_box);\r\nfilter_box=ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\nfilter_bt=ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked", G_CALLBACK(display_filter_construct_cb), &args);\r\ngtk_box_pack_start(GTK_BOX(filter_box), filter_bt, FALSE, FALSE, 0);\r\ngtk_widget_show(filter_bt);\r\nfilter_entry=gtk_entry_new();\r\ng_signal_connect(filter_entry, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_box), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(filter_entry, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(dlg, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, filter_entry);\r\ngtk_box_pack_start(GTK_BOX(filter_box), filter_entry, TRUE, TRUE, 0);\r\nfilter=gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\nif(filter){\r\ngtk_entry_set_text(GTK_ENTRY(filter_entry), filter);\r\n} else {\r\ncolorize_filter_te_as_empty(filter_entry);\r\n}\r\ngtk_widget_show(filter_entry);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), filter_box, TRUE, TRUE, 0);\r\ngtk_widget_show(filter_box);\r\nbbox = dlg_button_row_new(WIRESHARK_STOCK_CREATE_STAT, GTK_STOCK_CANCEL, NULL);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nstart_button = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CREATE_STAT);\r\ng_signal_connect_swapped(start_button, "clicked",\r\nG_CALLBACK(rpcstat_start_button_clicked), NULL);\r\ncancel_button = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button(dlg, cancel_button, window_cancel_button_cb);\r\ngtk_widget_grab_focus(filter_entry);\r\ngtk_widget_grab_default(start_button );\r\ng_signal_connect(dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(dlg, "destroy", G_CALLBACK(dlg_destroy_cb), NULL);\r\ngtk_widget_show_all(dlg);\r\nwindow_present(dlg);\r\n}\r\nvoid\r\nregister_tap_listener_gtkrpcstat(void)\r\n{\r\nregister_stat_tap_ui(&rpcstat_ui, NULL);\r\n}

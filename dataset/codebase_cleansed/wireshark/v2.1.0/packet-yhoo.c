static gboolean\r\ndissect_yhoo(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *yhoo_tree, *ti;\r\nint offset = 0;\r\nif (pinfo->srcport != TCP_PORT_YHOO && pinfo->destport != TCP_PORT_YHOO) {\r\nreturn FALSE;\r\n}\r\nif ( tvb_captured_length(tvb) < YAHOO_RAWPACKET_LEN ) {\r\nreturn FALSE;\r\n}\r\nif (tvb_memeql(tvb, offset, "YPNS", 4) != 0 &&\r\ntvb_memeql(tvb, offset, "YHOO", 4) != 0) {\r\nreturn FALSE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "YHOO");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s: %s",\r\n( tvb_memeql(tvb, offset + 0, "YPNS", 4) == 0 ) ? "Request" : "Response",\r\nval_to_str(tvb_get_letohl(tvb, offset + 12),\r\nyhoo_service_vals, "Unknown Service: %u"));\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_yhoo, tvb,\r\noffset, -1, ENC_NA);\r\nyhoo_tree = proto_item_add_subtree(ti, ett_yhoo);\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_version, tvb,\r\noffset, 8, ENC_ASCII|ENC_NA);\r\noffset += 8;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_len, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_service, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_connection_id, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_magic_id, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_unknown1, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_msgtype, tvb,\r\noffset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_nick1, tvb,\r\noffset, 36, ENC_ASCII|ENC_NA);\r\noffset += 36;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_nick2, tvb,\r\noffset, 36, ENC_ASCII|ENC_NA);\r\noffset += 36;\r\nproto_tree_add_item(yhoo_tree, hf_yhoo_content, tvb, -1,\r\noffset, ENC_ASCII|ENC_NA);\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_yhoo(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_yhoo_service, {\r\n"Service Type", "yhoo.service", FT_UINT32, BASE_DEC,\r\nVALS(yhoo_service_vals), 0, NULL, HFILL }},\r\n{ &hf_yhoo_msgtype, {\r\n"Message Type", "yhoo.msgtype", FT_UINT32, BASE_DEC,\r\nVALS(yhoo_msgtype_vals), 0, "Message Type Flags", HFILL }},\r\n{ &hf_yhoo_connection_id, {\r\n"Connection ID", "yhoo.connection_id", FT_UINT32, BASE_HEX,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_yhoo_magic_id, {\r\n"Magic ID", "yhoo.magic_id", FT_UINT32, BASE_HEX,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_yhoo_unknown1, {\r\n"Unknown 1", "yhoo.unknown1", FT_UINT32, BASE_HEX,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_yhoo_len, {\r\n"Packet Length", "yhoo.len", FT_UINT32, BASE_DEC,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_yhoo_nick1, {\r\n"Real Nick (nick1)", "yhoo.nick1", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_yhoo_nick2, {\r\n"Active Nick (nick2)", "yhoo.nick2", FT_STRING, BASE_NONE,\r\nNULL, 0, NULL, HFILL }},\r\n{ &hf_yhoo_content, {\r\n"Content", "yhoo.content", FT_STRING, BASE_NONE,\r\nNULL, 0, "Data portion of the packet", HFILL }},\r\n{ &hf_yhoo_version, {\r\n"Version", "yhoo.version", FT_STRING, BASE_NONE,\r\nNULL, 0, "Packet version identifier", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_yhoo,\r\n};\r\nproto_yhoo = proto_register_protocol("Yahoo Messenger Protocol",\r\n"YHOO", "yhoo");\r\nproto_register_field_array(proto_yhoo, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_yhoo(void)\r\n{\r\nheur_dissector_add("tcp", dissect_yhoo, "Yahoo Messenger over TCP", "yhoo_tcp", proto_yhoo, HEURISTIC_ENABLE);\r\n}

int\r\nmapi_dissect_element_EcDoRpc_response(tvbuff_t *tvb _U_, int offset _U_, packet_info *pinfo _U_, proto_tree *tree _U_, dcerpc_info* di _U_, guint8 *drep _U_)\r\n{\r\noffset = mapi_dissect_element_EcDoRpc_response_(tvb, offset, pinfo, tree, di, drep);\r\nreturn offset;\r\n}\r\nstatic int\r\nmapi_dissect_element_EcDoRpc_response_(tvbuff_t *tvb _U_, int offset _U_, packet_info *pinfo _U_, proto_tree *tree _U_, dcerpc_info* di _U_, guint8 *drep _U_)\r\n{\r\nguint32 size;\r\nint start_offset = offset;\r\nguint8 *decrypted_data;\r\ntvbuff_t *decrypted_tvb;\r\nconst guint8 *ptr;\r\ngint reported_len;\r\nguint16 pdu_len;\r\nguint32 i;\r\nproto_tree *tr = NULL;\r\noffset = dissect_ndr_uint32(tvb, offset, pinfo, tree, di, drep, hf_mapi_EcDoRpc_mapi_response, &size);\r\nproto_tree_add_uint(tree, hf_mapi_EcDoRpc_subcontext_size, tvb, start_offset, offset - start_offset + size, size);\r\nreported_len = tvb_reported_length_remaining(tvb, offset);\r\nif ((guint32) reported_len > size) {\r\nreported_len = size;\r\n}\r\nif (size > (guint32) reported_len) {\r\nsize = reported_len;\r\n}\r\nptr = tvb_get_ptr(tvb, offset, size);\r\ndecrypted_data = (guint8 *)g_malloc(size);\r\nfor (i = 0; i < size; i++) {\r\ndecrypted_data[i] = ptr[i] ^ 0xA5;\r\n}\r\ndecrypted_tvb = tvb_new_child_real_data(tvb, decrypted_data, size, reported_len);\r\ntvb_set_free_cb(decrypted_tvb, g_free);\r\nadd_new_data_source(pinfo, decrypted_tvb, "Decrypted MAPI");\r\ntr = proto_tree_add_subtree(tree, decrypted_tvb, 0, size, ett_mapi_mapi_response, NULL, "Decrypted MAPI PDU");\r\npdu_len = tvb_get_letohs(decrypted_tvb, 0);\r\nproto_tree_add_uint(tr, hf_mapi_pdu_len, decrypted_tvb, 0, 2, pdu_len);\r\nproto_tree_add_item(tr, hf_mapi_decrypted_data, decrypted_tvb, 2, pdu_len - 2, ENC_NA);\r\noffset = mapi_dissect_element_EcDoRpc_response__(decrypted_tvb, 0, pinfo, tr, di, drep);\r\noffset = mapi_dissect_element_request_handles_cnf(decrypted_tvb, offset, pinfo, tr, di, drep);\r\nreturn start_offset + offset + 4;\r\n}\r\nstatic int\r\nmapi_dissect_element_EcDoRpc_response__(tvbuff_t *tvb _U_, int offset _U_, packet_info *pinfo _U_, proto_tree *tree _U_, dcerpc_info* di _U_, guint8 *drep _U_)\r\n{\r\nguint16 length;\r\ntvbuff_t *subtvb;\r\nlength = tvb_get_letohs(tvb, offset);\r\nsubtvb = tvb_new_subset(tvb, offset, length, length);\r\noffset += 2;\r\nwhile (offset < length) {\r\noffset = mapi_dissect_struct_EcDoRpc_MAPI_REPL(subtvb, offset, pinfo, tree, di, drep, hf_mapi_mapi_response_mapi_repl, length - offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\nmapi_dissect_element_EcDoRpc_MAPI_REPL_UNION_OpenFolder(tvbuff_t *tvb _U_, int offset _U_, packet_info *pinfo _U_, proto_tree *parent_tree _U_, dcerpc_info* di _U_, guint8 *drep _U_)\r\n{\r\nproto_item *item = NULL;\r\nproto_tree *tree = NULL;\r\nint old_offset;\r\nint origin_offset;\r\norigin_offset = offset;\r\nif (parent_tree) {\r\nitem = proto_tree_add_item(parent_tree, hf_mapi_EcDoRpc_MAPI_REPL_UNION_mapi_OpenFolder, tvb, offset, -1, ENC_NA);\r\ntree = proto_item_add_subtree(item, ett_mapi_OpenFolder_repl);\r\n}\r\nold_offset = offset;\r\nproto_tree_add_item(tree, hf_mapi_EcDoRpc_unknown1, tvb, old_offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_item_set_len(item, offset - origin_offset);\r\nreturn offset;\r\n}\r\nstatic int\r\nmapi_dissect_element_EcDoRpc_MAPI_REPL_UNION_GetProps(tvbuff_t *tvb _U_, int offset _U_, packet_info *pinfo _U_, proto_tree *parent_tree _U_, dcerpc_info* di _U_, guint8 *drep _U_)\r\n{\r\nproto_item *item = NULL;\r\nproto_tree *tree = NULL;\r\nint origin_offset;\r\nguint16 length;\r\norigin_offset = offset;\r\nif (parent_tree) {\r\nitem = proto_tree_add_item(parent_tree, hf_mapi_EcDoRpc_MAPI_REPL_UNION_mapi_GetProps, tvb, offset, -1, ENC_NA);\r\ntree = proto_item_add_subtree(item, ett_mapi_GetProps_repl);\r\n}\r\nproto_tree_add_item(tree, hf_mapi_EcDoRpc_layout, tvb, offset, 1, ENC_NA);\r\noffset += 1;\r\nlength = tvb_reported_length_remaining(tvb, offset);\r\nproto_tree_add_uint(tree, hf_mapi_EcDoRpc_prop_count, tvb, offset, 0, length);\r\noffset += length;\r\nproto_item_set_len(item, offset - origin_offset);\r\nreturn offset;\r\n}

static char *\r\nget_string_from_dictionary(CFPropertyListRef dict, CFStringRef key)\r\n{\r\nCFStringRef cfstring;\r\ncfstring = (CFStringRef)CFDictionaryGetValue((CFDictionaryRef)dict,\r\n(const void *)key);\r\nif (cfstring == NULL)\r\nreturn NULL;\r\nif (CFGetTypeID(cfstring) != CFStringGetTypeID()) {\r\nreturn NULL;\r\n}\r\nreturn CFString_to_C_string(cfstring);\r\n}\r\nstatic gboolean\r\nget_os_x_version_info(GString *str)\r\n{\r\nstatic const UInt8 server_version_plist_path[] =\r\n"/System/Library/CoreServices/ServerVersion.plist";\r\nstatic const UInt8 system_version_plist_path[] =\r\n"/System/Library/CoreServices/SystemVersion.plist";\r\nCFURLRef version_plist_file_url;\r\nCFReadStreamRef version_plist_stream;\r\nCFDictionaryRef version_dict;\r\nchar *string;\r\nversion_plist_file_url = CFURLCreateFromFileSystemRepresentation(NULL,\r\nserver_version_plist_path, sizeof server_version_plist_path - 1,\r\nfalse);\r\nif (version_plist_file_url == NULL)\r\nreturn FALSE;\r\nversion_plist_stream = CFReadStreamCreateWithFile(NULL,\r\nversion_plist_file_url);\r\nCFRelease(version_plist_file_url);\r\nif (version_plist_stream == NULL)\r\nreturn FALSE;\r\nif (!CFReadStreamOpen(version_plist_stream)) {\r\nCFRelease(version_plist_stream);\r\nversion_plist_file_url = CFURLCreateFromFileSystemRepresentation(NULL,\r\nsystem_version_plist_path, sizeof system_version_plist_path - 1,\r\nfalse);\r\nif (version_plist_file_url == NULL)\r\nreturn FALSE;\r\nversion_plist_stream = CFReadStreamCreateWithFile(NULL,\r\nversion_plist_file_url);\r\nCFRelease(version_plist_file_url);\r\nif (version_plist_stream == NULL)\r\nreturn FALSE;\r\nif (!CFReadStreamOpen(version_plist_stream)) {\r\nCFRelease(version_plist_stream);\r\nreturn FALSE;\r\n}\r\n}\r\n#ifdef HAVE_CFPROPERTYLISTCREATEWITHSTREAM\r\nversion_dict = (CFDictionaryRef)CFPropertyListCreateWithStream(NULL,\r\nversion_plist_stream, 0, kCFPropertyListImmutable,\r\nNULL, NULL);\r\n#else\r\nversion_dict = (CFDictionaryRef)CFPropertyListCreateFromStream(NULL,\r\nversion_plist_stream, 0, kCFPropertyListImmutable,\r\nNULL, NULL);\r\n#endif\r\nif (version_dict == NULL) {\r\nCFRelease(version_plist_stream);\r\nreturn FALSE;\r\n}\r\nif (CFGetTypeID(version_dict) != CFDictionaryGetTypeID()) {\r\nCFRelease(version_dict);\r\nCFReadStreamClose(version_plist_stream);\r\nCFRelease(version_plist_stream);\r\nreturn FALSE;\r\n}\r\nstring = get_string_from_dictionary(version_dict,\r\nCFSTR("ProductName"));\r\nif (string == NULL) {\r\nCFRelease(version_dict);\r\nCFReadStreamClose(version_plist_stream);\r\nCFRelease(version_plist_stream);\r\nreturn FALSE;\r\n}\r\ng_string_append_printf(str, "%s", string);\r\ng_free(string);\r\nstring = get_string_from_dictionary(version_dict,\r\nCFSTR("ProductUserVisibleVersion"));\r\nif (string == NULL) {\r\nCFRelease(version_dict);\r\nCFReadStreamClose(version_plist_stream);\r\nCFRelease(version_plist_stream);\r\nreturn FALSE;\r\n}\r\ng_string_append_printf(str, " %s", string);\r\ng_free(string);\r\nstring = get_string_from_dictionary(version_dict,\r\nCFSTR("ProductBuildVersion"));\r\nif (string == NULL) {\r\nCFRelease(version_dict);\r\nCFReadStreamClose(version_plist_stream);\r\nCFRelease(version_plist_stream);\r\nreturn FALSE;\r\n}\r\ng_string_append_printf(str, ", build %s", string);\r\ng_free(string);\r\nCFRelease(version_dict);\r\nCFReadStreamClose(version_plist_stream);\r\nCFRelease(version_plist_stream);\r\nreturn TRUE;\r\n}\r\nvoid\r\nget_os_version_info(GString *str)\r\n{\r\n#if defined(_WIN32)\r\nOSVERSIONINFOEX info;\r\nSYSTEM_INFO system_info;\r\nnativesi_func_ptr nativesi_func;\r\n#elif defined(HAVE_SYS_UTSNAME_H)\r\nstruct utsname name;\r\n#endif\r\n#if defined(_WIN32)\r\nmemset(&info, '\0', sizeof info);\r\ninfo.dwOSVersionInfoSize = sizeof info;\r\nif (!GetVersionEx((OSVERSIONINFO *)&info)) {\r\ng_string_append(str, "unknown Windows version");\r\nreturn;\r\n}\r\nmemset(&system_info, '\0', sizeof system_info);\r\nnativesi_func = (nativesi_func_ptr)GetProcAddress(GetModuleHandle(_T("kernel32.dll")), "GetNativeSystemInfo");\r\nif(nativesi_func)\r\nnativesi_func(&system_info);\r\nelse\r\nGetSystemInfo(&system_info);\r\nswitch (info.dwPlatformId) {\r\ncase VER_PLATFORM_WIN32s:\r\ng_string_append_printf(str, "Windows 3.1 with Win32s");\r\nbreak;\r\ncase VER_PLATFORM_WIN32_WINDOWS:\r\nswitch (info.dwMajorVersion) {\r\ncase 4:\r\nswitch (info.dwMinorVersion) {\r\ncase 0:\r\ng_string_append_printf(str, "Windows 95");\r\nbreak;\r\ncase 10:\r\ng_string_append_printf(str, "Windows 98");\r\nbreak;\r\ncase 90:\r\ng_string_append_printf(str, "Windows Me");\r\nbreak;\r\ndefault:\r\ng_string_append_printf(str, "Windows OT, unknown version %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\ng_string_append_printf(str, "Windows OT, unknown version %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nbreak;\r\ncase VER_PLATFORM_WIN32_NT:\r\nswitch (info.dwMajorVersion) {\r\ncase 3:\r\ncase 4:\r\ng_string_append_printf(str, "Windows NT %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\ncase 5:\r\nswitch (info.dwMinorVersion) {\r\ncase 0:\r\ng_string_append_printf(str, "Windows 2000");\r\nbreak;\r\ncase 1:\r\ng_string_append_printf(str, "Windows XP");\r\nbreak;\r\ncase 2:\r\nif ((info.wProductType == VER_NT_WORKSTATION) &&\r\n(system_info.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64)) {\r\ng_string_append_printf(str, "Windows XP Professional x64 Edition");\r\n} else {\r\ng_string_append_printf(str, "Windows Server 2003");\r\nif (system_info.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64)\r\ng_string_append_printf(str, " x64 Edition");\r\n}\r\nbreak;\r\ndefault:\r\ng_string_append_printf(str, "Windows NT, unknown version %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nbreak;\r\ncase 6: {\r\ngboolean is_nt_workstation;\r\nif (system_info.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64)\r\ng_string_append(str, "64-bit ");\r\nelse if (system_info.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_INTEL)\r\ng_string_append(str, "32-bit ");\r\n#ifndef VER_NT_WORKSTATION\r\n#define VER_NT_WORKSTATION 0x01\r\nis_nt_workstation = ((info.wReserved[1] & 0xff) == VER_NT_WORKSTATION);\r\n#else\r\nis_nt_workstation = (info.wProductType == VER_NT_WORKSTATION);\r\n#endif\r\nswitch (info.dwMinorVersion) {\r\ncase 0:\r\ng_string_append_printf(str, is_nt_workstation ? "Windows Vista" : "Windows Server 2008");\r\nbreak;\r\ncase 1:\r\ng_string_append_printf(str, is_nt_workstation ? "Windows 7" : "Windows Server 2008 R2");\r\nbreak;\r\ncase 2:\r\ng_string_append_printf(str, is_nt_workstation ? "Windows 8" : "Windows Server 2012");\r\nbreak;\r\ncase 3:\r\ng_string_append_printf(str, is_nt_workstation ? "Windows 8.1" : "Windows Server 2012 R2");\r\nbreak;\r\ndefault:\r\ng_string_append_printf(str, "Windows NT, unknown version %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase 10: {\r\ngboolean is_nt_workstation;\r\nif (system_info.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_AMD64)\r\ng_string_append(str, "64-bit ");\r\nelse if (system_info.wProcessorArchitecture == PROCESSOR_ARCHITECTURE_INTEL)\r\ng_string_append(str, "32-bit ");\r\nis_nt_workstation = (info.wProductType == VER_NT_WORKSTATION);\r\nswitch (info.dwMinorVersion) {\r\ncase 0:\r\ng_string_append_printf(str, is_nt_workstation ? "Windows 10" : "Windows Server 2016");\r\nbreak;\r\ndefault:\r\ng_string_append_printf(str, "Windows NT, unknown version %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ndefault:\r\ng_string_append_printf(str, "Windows NT, unknown version %lu.%lu",\r\ninfo.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\ng_string_append_printf(str, "Unknown Windows platform %lu version %lu.%lu",\r\ninfo.dwPlatformId, info.dwMajorVersion, info.dwMinorVersion);\r\nbreak;\r\n}\r\nif (info.szCSDVersion[0] != '\0')\r\ng_string_append_printf(str, " %s", utf_16to8(info.szCSDVersion));\r\ng_string_append_printf(str, ", build %lu", info.dwBuildNumber);\r\n#elif defined(HAVE_SYS_UTSNAME_H)\r\nif (uname(&name) < 0) {\r\ng_string_append_printf(str, "unknown OS version (uname failed - %s)",\r\ng_strerror(errno));\r\nreturn;\r\n}\r\nif (strcmp(name.sysname, "AIX") == 0) {\r\ng_string_append_printf(str, "%s %s.%s", name.sysname, name.version,\r\nname.release);\r\n} else {\r\n#ifdef HAVE_OS_X_FRAMEWORKS\r\nif (get_os_x_version_info(str)) {\r\ng_string_append_printf(str, " (%s %s)", name.sysname, name.release);\r\n} else {\r\ng_string_append_printf(str, "%s %s", name.sysname, name.release);\r\n}\r\n#else\r\ng_string_append_printf(str, "%s %s", name.sysname, name.release);\r\n#endif\r\n}\r\n#else\r\ng_string_append(str, "an unknown OS");\r\n#endif\r\n}\r\nguint32\r\nget_windows_major_version(void)\r\n{\r\nOSVERSIONINFO info;\r\ninfo.dwOSVersionInfoSize = sizeof info;\r\nif (GetVersionEx(&info)) {\r\nreturn info.dwMajorVersion;\r\n}\r\nreturn 0;\r\n}

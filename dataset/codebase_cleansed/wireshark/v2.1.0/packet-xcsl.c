static gboolean get_next_item(tvbuff_t *tvb, gint offset, gint maxlen, guint8 *str, gint *next_offset, guint *len)\r\n{\r\nguint idx = 0;\r\nguint8 ch;\r\nwhile (maxlen > 1) {\r\nch = tvb_get_guint8(tvb, offset+idx);\r\nif (ch == ';' || ch == '\r' || ch == '\n')\r\nbreak;\r\nif (idx==MAXLEN) {\r\n*next_offset = offset + idx;\r\n*len = idx;\r\nreturn FALSE;\r\n}\r\nstr[idx++] = ch;\r\nmaxlen--;\r\n}\r\nstr[idx] = '\0';\r\n*next_offset = offset + idx;\r\n*len = idx;\r\nreturn TRUE;\r\n}\r\nstatic void dissect_xcsl_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree) {\r\nguint offset = 0;\r\ngint length_remaining;\r\nguint8 idx;\r\ngboolean request;\r\nguint8 par;\r\nguint8 str[MAXLEN];\r\nguint8 result;\r\nconst gchar *code;\r\nguint len;\r\ngint next_offset;\r\nproto_tree *xcsl_tree = NULL;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "Xcsl");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nproto_item *xcsl_item;\r\nxcsl_item = proto_tree_add_item(tree, hfi_xcsl, tvb, offset, -1, ENC_NA);\r\nxcsl_tree = proto_item_add_subtree(xcsl_item, ett_xcsl);\r\n}\r\nidx = 0;\r\npar = 0;\r\nrequest = FALSE;\r\nwhile ((length_remaining = tvb_reported_length_remaining(tvb, offset)) > 0) {\r\nif (!(get_next_item(tvb, offset, length_remaining, str, &next_offset, &len))) {\r\nreturn;\r\n}\r\nif ( strlen(str) == 0 ) {\r\noffset = next_offset + 1;\r\ncontinue;\r\n}\r\nswitch (idx) {\r\ncase 0:\r\nproto_tree_add_item(xcsl_tree, &hfi_xcsl_protocol_version, tvb, offset, len, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase 1:\r\nif ( g_ascii_isdigit(str[0]) ) {\r\nproto_tree_add_item(xcsl_tree, &hfi_xcsl_transaction_id, tvb, offset, len, ENC_ASCII|ENC_NA);\r\n} else {\r\nproto_tree_add_item(xcsl_tree, &hfi_xcsl_information, tvb, offset, len, ENC_ASCII|ENC_NA);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s ",str);\r\nbreak;\r\ncase 2:\r\nif ( g_ascii_isdigit(str[0]) ) {\r\nproto_item *xcsl_item;\r\nrequest = FALSE;\r\nresult = atoi(str);\r\nif ( result >= XCSL_NONE ) {\r\nresult = XCSL_UNDEFINED;\r\n}\r\ncode = val_to_str(result, xcsl_action_vals, "Unknown: %d");\r\nxcsl_item = proto_tree_add_item(xcsl_tree, &hfi_xcsl_result, tvb, offset, len, ENC_ASCII|ENC_NA);\r\nproto_item_append_text(xcsl_item, " (%s)", code);\r\nif (result != 0)\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "[%s] ", code);\r\n} else {\r\nrequest = TRUE;\r\nproto_tree_add_item(xcsl_tree, &hfi_xcsl_command, tvb, offset, len, ENC_ASCII|ENC_NA);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s ", str);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(xcsl_tree, &hfi_xcsl_parameter, tvb, offset, len, ENC_ASCII|ENC_NA);\r\nif ( request == TRUE ) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s ",str);\r\n} else {\r\nif (par == 0) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "reply: %s ",str);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s ",str);\r\n}\r\n}\r\npar++;\r\nbreak;\r\n}\r\noffset = next_offset + 1;\r\nidx++;\r\n}\r\nreturn;\r\n}\r\nstatic gboolean dissect_xcsl_tcp_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_) {\r\nguint8 *protocol;\r\nif (tvb_captured_length (tvb) >= 5) {\r\nprotocol = tvb_get_string_enc(wmem_packet_scope(), tvb, 0, 5, ENC_ASCII);\r\nif (strncmp(protocol,"xcsl",4) == 0 && (protocol[4] == ';' || protocol[4] == '-')) {\r\ndissect_xcsl_tcp(tvb, pinfo, tree);\r\nreturn TRUE;\r\n}\r\n}\r\nreturn FALSE;\r\n}\r\nvoid proto_register_xcsl(void) {\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_xcsl_protocol_version,\r\n&hfi_xcsl_transaction_id,\r\n&hfi_xcsl_command,\r\n&hfi_xcsl_result,\r\n&hfi_xcsl_parameter,\r\n&hfi_xcsl_information,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_xcsl\r\n};\r\nint proto_xcsl;\r\nproto_xcsl = proto_register_protocol("Call Specification Language (Xcsl)", "XCSL", "xcsl");\r\nhfi_xcsl = proto_registrar_get_nth(proto_xcsl);\r\nproto_register_fields(proto_xcsl, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_xcsl(void) {\r\nheur_dissector_add("tcp", dissect_xcsl_tcp_heur, "XCSL over TCP", "xcsl_tcp", hfi_xcsl->id, HEURISTIC_ENABLE);\r\n}

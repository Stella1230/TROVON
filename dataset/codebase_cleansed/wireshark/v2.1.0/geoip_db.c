static void\r\ngeoip_dat_scan_dir(const char *dirname) {\r\nWS_DIR *dir;\r\nWS_DIRENT *file;\r\nconst char *name;\r\nchar *datname;\r\nGeoIP *gi;\r\nif ((dir = ws_dir_open(dirname, 0, NULL)) != NULL) {\r\nwhile ((file = ws_dir_read_name(dir)) != NULL) {\r\nname = ws_dir_get_name(file);\r\nif (g_str_has_prefix(file, "Geo") && g_str_has_suffix(file, ".dat")) {\r\ndatname = g_strdup_printf("%s" G_DIR_SEPARATOR_S "%s", dirname, name);\r\ngi = GeoIP_open(datname, GEOIP_MEMORY_CACHE);\r\nif (gi) {\r\ng_array_append_val(geoip_dat_arr, gi);\r\n}\r\ng_free(datname);\r\n}\r\n}\r\nws_dir_close (dir);\r\n}\r\n}\r\nstatic void* geoip_db_path_copy_cb(void* dest, const void* orig, size_t len _U_) {\r\nconst geoip_db_path_t *m = (const geoip_db_path_t *)orig;\r\ngeoip_db_path_t *d = (geoip_db_path_t *)dest;\r\nd->path = g_strdup(m->path);\r\nreturn d;\r\n}\r\nstatic void geoip_db_path_free_cb(void* p) {\r\ngeoip_db_path_t *m = (geoip_db_path_t *)p;\r\ng_free(m->path);\r\n}\r\nstatic void geoip_db_post_update_cb(void) {\r\nGeoIP *gi;\r\nguint i;\r\nif (geoip_dat_arr) {\r\nfor (i = 0; i < geoip_db_num_dbs() - 2; i++) {\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, i);\r\nif (gi) {\r\nGeoIP_delete(gi);\r\n}\r\n}\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, i);\r\nif (gi) {\r\ng_free(gi);\r\n}\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, i+1);\r\nif (gi) {\r\ng_free(gi);\r\n}\r\ng_array_free(geoip_dat_arr, TRUE);\r\n}\r\ngeoip_dat_arr = g_array_new(FALSE, FALSE, sizeof(GeoIP *));\r\nfor (i = 0; i < num_geoip_db_paths; i++) {\r\nif (geoip_db_paths[i].path) {\r\ngeoip_dat_scan_dir(geoip_db_paths[i].path);\r\n}\r\n}\r\ngi = (GeoIP *)g_malloc(sizeof (GeoIP));\r\ngi->databaseType = WS_LAT_FAKE_EDITION;\r\ng_array_append_val(geoip_dat_arr, gi);\r\ngi = (GeoIP *)g_malloc(sizeof (GeoIP));\r\ngi->databaseType = WS_LON_FAKE_EDITION;\r\ng_array_append_val(geoip_dat_arr, gi);\r\n}\r\nvoid\r\ngeoip_db_pref_init(module_t *nameres)\r\n{\r\nstatic uat_field_t geoip_db_paths_fields[] = {\r\nUAT_FLD_DIRECTORYNAME(geoip_mod, path, "GeoIP Database Directory", "The GeoIP database directory path"),\r\nUAT_END_FIELDS\r\n};\r\ngeoip_db_paths_uat = uat_new("GeoIP Database Paths",\r\nsizeof(geoip_db_path_t),\r\n"geoip_db_paths",\r\nFALSE,\r\n(void**)&geoip_db_paths,\r\n&num_geoip_db_paths,\r\nUAT_AFFECTS_DISSECTION,\r\n"ChGeoIPDbPaths",\r\ngeoip_db_path_copy_cb,\r\nNULL,\r\ngeoip_db_path_free_cb,\r\ngeoip_db_post_update_cb,\r\ngeoip_db_paths_fields);\r\nprefs_register_uat_preference(nameres,\r\n"geoip_db_paths",\r\n"GeoIP database directories",\r\n"Search paths for GeoIP address mapping databases.\n"\r\n"Wireshark will look in each directory for files beginning\n"\r\n"with \"Geo\" and ending with \".dat\".",\r\ngeoip_db_paths_uat);\r\n}\r\nguint\r\ngeoip_db_num_dbs(void) {\r\nreturn geoip_dat_arr->len;\r\n}\r\nconst gchar *\r\ngeoip_db_name(guint dbnum) {\r\nGeoIP *gi;\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, dbnum);\r\nif (gi) {\r\nreturn (val_to_str_const(gi->databaseType, geoip_type_name_vals, "Unknown database"));\r\n}\r\nreturn "Invalid database";\r\n}\r\nint\r\ngeoip_db_type(guint dbnum) {\r\nGeoIP *gi;\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, dbnum);\r\nif (gi) {\r\nreturn (gi->databaseType);\r\n}\r\nreturn -1;\r\n}\r\nstatic int\r\ngeoip_db_lookup_latlon4(guint32 addr, float *lat, float *lon) {\r\nGeoIP *gi;\r\nGeoIPRecord *gir;\r\nguint i;\r\nfor (i = 0; i < geoip_db_num_dbs(); i++) {\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, i);\r\nif (gi) {\r\nswitch (gi->databaseType) {\r\ncase GEOIP_CITY_EDITION_REV0:\r\ncase GEOIP_CITY_EDITION_REV1:\r\ngir = GeoIP_record_by_ipnum(gi, addr);\r\nif(gir) {\r\n*lat = gir->latitude;\r\n*lon = gir->longitude;\r\nreturn 0;\r\n}\r\nreturn -1;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic char *\r\ndb_val_to_utf_8(const char *val, GeoIP *gi) {\r\nif (GeoIP_charset(gi) == GEOIP_CHARSET_ISO_8859_1) {\r\nchar *utf8_val;\r\nutf8_val = g_convert(val, -1, "UTF-8", "ISO-8859-1", NULL, NULL, NULL);\r\nif (utf8_val) {\r\nchar *ret_val = wmem_strdup(NULL, utf8_val);\r\ng_free(utf8_val);\r\nreturn ret_val;\r\n}\r\n}\r\nreturn wmem_strdup(NULL, val);\r\n}\r\nchar *\r\ngeoip_db_lookup_ipv4(guint dbnum, guint32 addr, const char *not_found) {\r\nGeoIP *gi;\r\nGeoIPRecord *gir;\r\nconst char *raw_val;\r\nchar *val, *ret = NULL;\r\nif (dbnum > geoip_db_num_dbs()) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn wmem_strdup(NULL, not_found);\r\n}\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, dbnum);\r\nif (gi) {\r\nswitch (gi->databaseType) {\r\ncase GEOIP_COUNTRY_EDITION:\r\nraw_val = GeoIP_country_name_by_ipnum(gi, addr);\r\nif (raw_val) {\r\nret = db_val_to_utf_8(raw_val, gi);\r\n}\r\nbreak;\r\ncase GEOIP_CITY_EDITION_REV0:\r\ncase GEOIP_CITY_EDITION_REV1:\r\ngir = GeoIP_record_by_ipnum(gi, addr);\r\nif (gir && gir->city && gir->region) {\r\nval = wmem_strdup_printf(NULL, "%s, %s", gir->city, gir->region);\r\nret = db_val_to_utf_8(val, gi);\r\nwmem_free(NULL, val);\r\n} else if (gir && gir->city) {\r\nret = db_val_to_utf_8(gir->city, gi);\r\n}\r\nbreak;\r\ncase GEOIP_ORG_EDITION:\r\ncase GEOIP_ISP_EDITION:\r\ncase GEOIP_ASNUM_EDITION:\r\nraw_val = GeoIP_name_by_ipnum(gi, addr);\r\nif (raw_val) {\r\nret = db_val_to_utf_8(raw_val, gi);\r\n}\r\nbreak;\r\ncase WS_LAT_FAKE_EDITION:\r\n{\r\nfloat lat;\r\nfloat lon;\r\nchar *c;\r\nif(geoip_db_lookup_latlon4(addr, &lat, &lon) == 0) {\r\nval = wmem_strdup_printf(NULL, "%f", lat);\r\nc = strchr(val, ',');\r\nif (c != NULL) *c = '.';\r\nret = val;\r\n}\r\n}\r\nbreak;\r\ncase WS_LON_FAKE_EDITION:\r\n{\r\nfloat lat;\r\nfloat lon;\r\nchar *c;\r\nif(geoip_db_lookup_latlon4(addr, &lat, &lon) == 0) {\r\nval = wmem_strdup_printf(NULL, "%f", lon);\r\nc = strchr(val, ',');\r\nif (c != NULL) *c = '.';\r\nret = val;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (ret == NULL) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn wmem_strdup(NULL, not_found);\r\n}\r\nreturn ret;\r\n}\r\nstatic int\r\n#if NUM_DB_TYPES > 31\r\ngeoip_db_lookup_latlon6(geoipv6_t addr, float *lat, float *lon) {\r\nGeoIP *gi;\r\nGeoIPRecord *gir;\r\nguint i;\r\nfor (i = 0; i < geoip_db_num_dbs(); i++) {\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, i);\r\nif (gi) {\r\nswitch (gi->databaseType) {\r\ncase GEOIP_CITY_EDITION_REV0_V6:\r\ncase GEOIP_CITY_EDITION_REV1_V6:\r\ngir = GeoIP_record_by_ipnum_v6(gi, addr);\r\nif(gir) {\r\n*lat = gir->latitude;\r\n*lon = gir->longitude;\r\nreturn 0;\r\n}\r\nreturn -1;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn -1;\r\n}\r\nchar *\r\ngeoip_db_lookup_ipv6(guint dbnum, struct e_in6_addr addr, const char *not_found) {\r\nGeoIP *gi;\r\ngeoipv6_t gaddr;\r\nconst char *raw_val;\r\nchar *val, *ret = NULL;\r\n#if NUM_DB_TYPES > 31\r\nGeoIPRecord *gir;\r\n#endif\r\nif (dbnum > geoip_db_num_dbs()) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn wmem_strdup(NULL, not_found);\r\n}\r\nmemcpy(&gaddr, &addr, sizeof(addr));\r\ngi = g_array_index(geoip_dat_arr, GeoIP *, dbnum);\r\nif (gi) {\r\nswitch (gi->databaseType) {\r\ncase GEOIP_COUNTRY_EDITION_V6:\r\nraw_val = GeoIP_country_name_by_ipnum_v6(gi, gaddr);\r\nif (raw_val) {\r\nret = db_val_to_utf_8(raw_val, gi);\r\n}\r\nbreak;\r\n#if NUM_DB_TYPES > 31\r\ncase GEOIP_CITY_EDITION_REV0_V6:\r\ncase GEOIP_CITY_EDITION_REV1_V6:\r\ngir = GeoIP_record_by_ipnum_v6(gi, gaddr);\r\nif (gir && gir->city && gir->region) {\r\nval = wmem_strdup_printf(NULL, "%s, %s", gir->city, gir->region);\r\nret = db_val_to_utf_8(val, gi);\r\nwmem_free(NULL, val);\r\n} else if (gir && gir->city) {\r\nret = db_val_to_utf_8(gir->city, gi);\r\n}\r\nbreak;\r\ncase GEOIP_ORG_EDITION_V6:\r\ncase GEOIP_ISP_EDITION_V6:\r\ncase GEOIP_ASNUM_EDITION_V6:\r\nraw_val = GeoIP_name_by_ipnum_v6(gi, gaddr);\r\nif (raw_val) {\r\nret = db_val_to_utf_8(raw_val, gi);\r\n}\r\nbreak;\r\n#endif\r\ncase WS_LAT_FAKE_EDITION:\r\n{\r\nfloat lat;\r\nfloat lon;\r\nchar *c;\r\nif(geoip_db_lookup_latlon6(gaddr, &lat, &lon) == 0) {\r\nval = wmem_strdup_printf(NULL, "%f", lat);\r\nc = strchr(val, ',');\r\nif (c != NULL) *c = '.';\r\nret = val;\r\n}\r\n}\r\nbreak;\r\ncase WS_LON_FAKE_EDITION:\r\n{\r\nfloat lat;\r\nfloat lon;\r\nchar *c;\r\nif(geoip_db_lookup_latlon6(gaddr, &lat, &lon) == 0) {\r\nval = wmem_strdup_printf(NULL, "%f", lon);\r\nc = strchr(val, ',');\r\nif (c != NULL) *c = '.';\r\nret = val;\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (ret == NULL) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn wmem_strdup(NULL, not_found);\r\n}\r\nreturn ret;\r\n}\r\nchar *\r\ngeoip_db_lookup_ipv6(guint dbnum _U_, struct e_in6_addr addr _U_, const char *not_found) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn wmem_strdup(NULL, not_found);\r\n}\r\ngchar *\r\ngeoip_db_get_paths(void) {\r\nGString* path_str = NULL;\r\nchar path_separator;\r\nguint i;\r\npath_str = g_string_new("");\r\n#ifdef _WIN32\r\npath_separator = ';';\r\n#else\r\npath_separator = ':';\r\n#endif\r\nfor (i = 0; i < num_geoip_db_paths; i++) {\r\nif (geoip_db_paths[i].path) {\r\ng_string_append_printf(path_str, "%s%c", geoip_db_paths[i].path, path_separator);\r\n}\r\n}\r\ng_string_truncate(path_str, path_str->len-1);\r\nreturn g_string_free(path_str, FALSE);\r\n}\r\nguint\r\ngeoip_db_num_dbs(void) {\r\nreturn 0;\r\n}\r\nconst gchar *\r\ngeoip_db_name(guint dbnum _U_) {\r\nreturn "Unsupported";\r\n}\r\nint\r\ngeoip_db_type(guint dbnum _U_) {\r\nreturn -1;\r\n}\r\nchar *\r\ngeoip_db_lookup_ipv4(guint dbnum _U_, guint32 addr _U_, const char *not_found) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn (char *)wmem_strdup(NULL, not_found);\r\n}\r\nchar *\r\ngeoip_db_lookup_ipv6(guint dbnum _U_, guint32 addr _U_, const char *not_found) {\r\nif (not_found == NULL)\r\nreturn NULL;\r\nreturn (char *)wmem_strdup(NULL, not_found);\r\n}\r\ngchar *\r\ngeoip_db_get_paths(void) {\r\nreturn g_strdup("");\r\n}

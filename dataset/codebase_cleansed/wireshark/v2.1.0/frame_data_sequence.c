frame_data_sequence *\r\nnew_frame_data_sequence(void)\r\n{\r\nframe_data_sequence *fds;\r\nfds = (frame_data_sequence *)g_malloc(sizeof *fds);\r\nfds->count = 0;\r\nfds->ptree_root = NULL;\r\nreturn fds;\r\n}\r\nframe_data *\r\nframe_data_sequence_add(frame_data_sequence *fds, frame_data *fdata)\r\n{\r\nframe_data *leaf;\r\nframe_data **level1;\r\nframe_data ***level2;\r\nframe_data ****level3;\r\nframe_data *node;\r\nif (fds->count == 0) {\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nnode = &leaf[0];\r\nfds->ptree_root = leaf;\r\n} else if (fds->count < NODES_PER_LEVEL) {\r\nleaf = (frame_data *)fds->ptree_root;\r\nnode = &leaf[fds->count];\r\n} else if (fds->count == NODES_PER_LEVEL) {\r\nlevel1 = (frame_data **)g_malloc0((sizeof *level1)*NODES_PER_LEVEL);\r\nlevel1[0] = (frame_data *)fds->ptree_root;\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nlevel1[1] = leaf;\r\nnode = &leaf[0];\r\nfds->ptree_root = level1;\r\n} else if (fds->count < NODES_PER_LEVEL*NODES_PER_LEVEL) {\r\nlevel1 = (frame_data **)fds->ptree_root;\r\nleaf = level1[fds->count >> LOG2_NODES_PER_LEVEL];\r\nif (leaf == NULL) {\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nlevel1[fds->count >> LOG2_NODES_PER_LEVEL] = leaf;\r\n}\r\nnode = &leaf[LEAF_INDEX(fds->count)];\r\n} else if (fds->count == NODES_PER_LEVEL*NODES_PER_LEVEL) {\r\nlevel2 = (frame_data ***)g_malloc0((sizeof *level2)*NODES_PER_LEVEL);\r\nlevel2[0] = (frame_data **)fds->ptree_root;\r\nlevel1 = (frame_data **)g_malloc0((sizeof *level1)*NODES_PER_LEVEL);\r\nlevel2[1] = level1;\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nlevel1[0] = leaf;\r\nnode = &leaf[0];\r\nfds->ptree_root = level2;\r\n} else if (fds->count < NODES_PER_LEVEL*NODES_PER_LEVEL*NODES_PER_LEVEL) {\r\nlevel2 = (frame_data ***)fds->ptree_root;\r\nlevel1 = level2[fds->count >> (LOG2_NODES_PER_LEVEL+LOG2_NODES_PER_LEVEL)];\r\nif (level1 == NULL) {\r\nlevel1 = (frame_data **)g_malloc0((sizeof *level1)*NODES_PER_LEVEL);\r\nlevel2[fds->count >> (LOG2_NODES_PER_LEVEL+LOG2_NODES_PER_LEVEL)] = level1;\r\n}\r\nleaf = level1[LEVEL_1_INDEX(fds->count)];\r\nif (leaf == NULL) {\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nlevel1[LEVEL_1_INDEX(fds->count)] = leaf;\r\n}\r\nnode = &leaf[LEAF_INDEX(fds->count)];\r\n} else if (fds->count == NODES_PER_LEVEL*NODES_PER_LEVEL*NODES_PER_LEVEL) {\r\nlevel3 = (frame_data ****)g_malloc0((sizeof *level3)*NODES_PER_LEVEL);\r\nlevel3[0] = (frame_data ***)fds->ptree_root;\r\nlevel2 = (frame_data ***)g_malloc0((sizeof *level2)*NODES_PER_LEVEL);\r\nlevel3[1] = level2;\r\nlevel1 = (frame_data **)g_malloc0((sizeof *level1)*NODES_PER_LEVEL);\r\nlevel2[0] = level1;\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nlevel1[0] = leaf;\r\nnode = &leaf[0];\r\nfds->ptree_root = level3;\r\n} else {\r\nlevel3 = (frame_data ****)fds->ptree_root;\r\nlevel2 = level3[LEVEL_3_INDEX(fds->count)];\r\nif (level2 == NULL) {\r\nlevel2 = (frame_data ***)g_malloc0((sizeof *level2)*NODES_PER_LEVEL);\r\nlevel3[LEVEL_3_INDEX(fds->count)] = level2;\r\n}\r\nlevel1 = level2[LEVEL_2_INDEX(fds->count)];\r\nif (level1 == NULL) {\r\nlevel1 = (frame_data **)g_malloc0((sizeof *level1)*NODES_PER_LEVEL);\r\nlevel2[LEVEL_2_INDEX(fds->count)] = level1;\r\n}\r\nleaf = level1[LEVEL_1_INDEX(fds->count)];\r\nif (leaf == NULL) {\r\nleaf = (frame_data *)g_malloc((sizeof *leaf)*NODES_PER_LEVEL);\r\nlevel1[LEVEL_1_INDEX(fds->count)] = leaf;\r\n}\r\nnode = &leaf[LEAF_INDEX(fds->count)];\r\n}\r\n*node = *fdata;\r\nfds->count++;\r\nreturn node;\r\n}\r\nframe_data *\r\nframe_data_sequence_find(frame_data_sequence *fds, guint32 num)\r\n{\r\nframe_data *leaf;\r\nframe_data **level1;\r\nframe_data ***level2;\r\nframe_data ****level3;\r\nif (num == 0) {\r\nreturn NULL;\r\n}\r\nnum--;\r\nif (num >= fds->count) {\r\nreturn NULL;\r\n}\r\nif (fds->count <= NODES_PER_LEVEL) {\r\nleaf = (frame_data *)fds->ptree_root;\r\nreturn &leaf[num];\r\n}\r\nif (fds->count <= NODES_PER_LEVEL*NODES_PER_LEVEL) {\r\nlevel1 = (frame_data **)fds->ptree_root;\r\nleaf = level1[num >> LOG2_NODES_PER_LEVEL];\r\nreturn &leaf[LEAF_INDEX(num)];\r\n}\r\nif (fds->count <= NODES_PER_LEVEL*NODES_PER_LEVEL*NODES_PER_LEVEL) {\r\nlevel2 = (frame_data ***)fds->ptree_root;\r\nlevel1 = level2[num >> (LOG2_NODES_PER_LEVEL+LOG2_NODES_PER_LEVEL)];\r\nleaf = level1[(num >> LOG2_NODES_PER_LEVEL) & (NODES_PER_LEVEL - 1)];\r\nreturn &leaf[LEAF_INDEX(num)];\r\n}\r\nlevel3 = (frame_data ****)fds->ptree_root;\r\nlevel2 = level3[num >> (LOG2_NODES_PER_LEVEL+LOG2_NODES_PER_LEVEL+LOG2_NODES_PER_LEVEL)];\r\nlevel1 = level2[(num >> (LOG2_NODES_PER_LEVEL+LOG2_NODES_PER_LEVEL)) & (NODES_PER_LEVEL - 1)];\r\nleaf = level1[(num >> LOG2_NODES_PER_LEVEL) & (NODES_PER_LEVEL - 1)];\r\nreturn &leaf[LEAF_INDEX(num)];\r\n}\r\nstatic void\r\nfree_frame_data_array(void *array, guint count, guint level, gboolean last)\r\n{\r\nguint i, level_count;\r\nif (last) {\r\nlevel_count = (count >> ((level - 1) * LOG2_NODES_PER_LEVEL)) &\r\n(NODES_PER_LEVEL - 1);\r\nif (count & ((1 << ((level - 1) * LOG2_NODES_PER_LEVEL)) - 1)) {\r\nlevel_count++;\r\n}\r\n}\r\nelse {\r\nlevel_count = NODES_PER_LEVEL;\r\n}\r\nif (level > 1) {\r\nframe_data **real_array = (frame_data **) array;\r\nfor (i=0; i < level_count-1; i++) {\r\nfree_frame_data_array(real_array[i], count, level-1, FALSE);\r\n}\r\nfree_frame_data_array(real_array[level_count-1], count, level-1, last);\r\n}\r\nelse if (level == 1) {\r\nframe_data *real_array = (frame_data *) array;\r\nfor (i=0; i < level_count; i++) {\r\nframe_data_destroy(&real_array[i]);\r\n}\r\n}\r\ng_free(array);\r\n}\r\nvoid\r\nfree_frame_data_sequence(frame_data_sequence *fds)\r\n{\r\nguint32 count = fds->count;\r\nguint levels = 0;\r\nwhile (count) {\r\nlevels++;\r\ncount >>= LOG2_NODES_PER_LEVEL;\r\n}\r\nif (levels > 0) {\r\nfree_frame_data_array(fds->ptree_root, fds->count, levels, TRUE);\r\n}\r\ng_free(fds);\r\n}\r\nvoid\r\nfind_and_mark_frame_depended_upon(gpointer data, gpointer user_data)\r\n{\r\nframe_data *dependent_fd;\r\nguint32 dependent_frame = GPOINTER_TO_UINT(data);\r\nframe_data_sequence *frames = (frame_data_sequence *)user_data;\r\nif (dependent_frame && frames) {\r\ndependent_fd = frame_data_sequence_find(frames, dependent_frame);\r\ndependent_fd->flags.dependent_of_displayed = 1;\r\n}\r\n}

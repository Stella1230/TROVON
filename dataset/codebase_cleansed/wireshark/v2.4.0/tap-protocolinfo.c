static int\r\nprotocolinfo_packet(void *prs, packet_info *pinfo, epan_dissect_t *edt, const void *dummy _U_)\r\n{\r\npci_t *rs = (pci_t *)prs;\r\nGPtrArray *gp;\r\nguint i;\r\nchar *str;\r\nif (!col_get_writable(pinfo->cinfo, COL_INFO)) {\r\nfprintf(stderr, "tshark: the proto,colinfo tap doesn't work if the INFO column isn't being printed.\n");\r\nexit(1);\r\n}\r\ngp = proto_get_finfo_ptr_array(edt->tree, rs->hf_index);\r\nif (!gp) {\r\nreturn 0;\r\n}\r\nfor (i=0; i<gp->len; i++) {\r\nstr = (char *)proto_construct_match_selected_string((field_info *)gp->pdata[i], NULL);\r\nif (str) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " %s", str);\r\nwmem_free(NULL, str);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void\r\nprotocolinfo_init(const char *opt_arg, void *userdata _U_)\r\n{\r\npci_t *rs;\r\nconst char *field = NULL;\r\nconst char *filter = NULL;\r\nheader_field_info *hfi;\r\nGString *error_string;\r\nif (!strncmp("proto,colinfo,", opt_arg, 14)) {\r\nfilter = opt_arg+14;\r\nfield = strchr(filter, ',');\r\nif (field) {\r\nfield += 1;\r\n}\r\n}\r\nif (!field) {\r\nfprintf(stderr, "tshark: invalid \"-z proto,colinfo,<filter>,<field>\" argument\n");\r\nexit(1);\r\n}\r\nhfi = proto_registrar_get_byname(field);\r\nif (!hfi) {\r\nfprintf(stderr, "tshark: Field \"%s\" doesn't exist.\n", field);\r\nexit(1);\r\n}\r\nrs = g_new(pci_t, 1);\r\nrs->hf_index = hfi->id;\r\nif ((field-filter) > 1) {\r\nrs->filter = (char *)g_malloc(field-filter);\r\ng_strlcpy(rs->filter, filter, (field-filter));\r\n} else {\r\nrs->filter = NULL;\r\n}\r\nerror_string = register_tap_listener("frame", rs, rs->filter, TL_REQUIRES_PROTO_TREE, NULL, protocolinfo_packet, NULL);\r\nif (error_string) {\r\nfprintf(stderr, "tshark: Couldn't register proto,colinfo tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\ng_free(rs->filter);\r\ng_free(rs);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_protocolinfo(void)\r\n{\r\nregister_stat_tap_ui(&protocolinfo_ui, NULL);\r\n}

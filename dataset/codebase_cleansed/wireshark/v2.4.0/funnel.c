const funnel_ops_t* funnel_get_funnel_ops(void) { return ops; }\r\nvoid funnel_set_funnel_ops(const funnel_ops_t* o) { ops = o; }\r\nstatic void funnel_insert_menu (funnel_menu_t** menu_list, funnel_menu_t *menu)\r\n{\r\nif (!(*menu_list)) {\r\n*menu_list = menu;\r\n} else {\r\nfunnel_menu_t* c;\r\nfor (c = *menu_list; c->next; c = c->next);\r\nc->next = menu;\r\n}\r\n}\r\nstatic void funnel_remove_menu (funnel_menu_t ** menu_list, funnel_menu_t *menu)\r\n{\r\nfunnel_menu_t *m = *menu_list, *p = NULL;\r\nwhile (m) {\r\nif (m->callback == menu->callback) {\r\nif (p) {\r\np->next = m->next;\r\n} else {\r\n*menu_list = m->next;\r\n}\r\ng_free(m->name);\r\ng_free(m);\r\nif (p) {\r\nm = p->next;\r\n} else {\r\nm = *menu_list ? (*menu_list)->next : NULL;\r\n}\r\n} else {\r\np = m;\r\nm = m->next;\r\n}\r\n}\r\n}\r\nstatic void funnel_clear_menu (funnel_menu_t** menu_list)\r\n{\r\nfunnel_menu_t *m;\r\nwhile (*menu_list) {\r\nm = *menu_list;\r\n*menu_list = m->next;\r\ng_free(m->name);\r\ng_free(m);\r\n}\r\n*menu_list = NULL;\r\n}\r\nvoid funnel_register_menu(const char *name,\r\nregister_stat_group_t group,\r\nfunnel_menu_callback callback,\r\ngpointer callback_data,\r\ngboolean retap)\r\n{\r\nfunnel_menu_t* m = (funnel_menu_t *)g_malloc(sizeof(funnel_menu_t));\r\nm->name = g_strdup(name);\r\nm->group = group;\r\nm->callback = callback;\r\nm->callback_data = callback_data;\r\nm->retap = retap;\r\nm->next = NULL;\r\nfunnel_insert_menu(&registered_menus, m);\r\nif (menus_registered) {\r\nfunnel_menu_t* m_r = (funnel_menu_t *)g_memdup(m, sizeof *m);\r\nm_r->name = g_strdup(name);\r\nfunnel_insert_menu(&added_menus, m_r);\r\n}\r\n}\r\nvoid funnel_deregister_menus(funnel_menu_callback callback)\r\n{\r\nfunnel_menu_t* m = (funnel_menu_t *)g_malloc0(sizeof(funnel_menu_t));\r\nm->callback = callback;\r\nfunnel_remove_menu(&registered_menus, m);\r\nfunnel_insert_menu(&removed_menus, m);\r\n}\r\nvoid funnel_register_all_menus(funnel_registration_cb_t r_cb)\r\n{\r\nfunnel_menu_t* c;\r\nfor (c = registered_menus; c; c = c->next) {\r\nr_cb(c->name,c->group,c->callback,c->callback_data,c->retap);\r\n}\r\nmenus_registered = TRUE;\r\n}\r\nvoid funnel_reload_menus(funnel_deregistration_cb_t d_cb,\r\nfunnel_registration_cb_t r_cb)\r\n{\r\nfunnel_menu_t* c;\r\nfor (c = removed_menus; c; c = c->next) {\r\nd_cb(c->callback);\r\n}\r\nfor (c = added_menus; c; c = c->next) {\r\nr_cb(c->name,c->group,c->callback,c->callback_data,c->retap);\r\n}\r\nfunnel_clear_menu(&removed_menus);\r\nfunnel_clear_menu(&added_menus);\r\n}

static int\r\ndissect_dvb_data_mpe(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0, tot_len = 0;\r\nguint8 llc_snap_flag;\r\nint i;\r\nproto_item *ti;\r\nproto_tree *dvb_data_mpe_tree;\r\ntvbuff_t *mac_tvb;\r\ntvbuff_t *mac_bytes_tvb[6];\r\ntvbuff_t *data_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "DVB-DATA");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "MultiProtocol Encapsulation");\r\nti = proto_tree_add_item(tree, proto_dvb_data_mpe, tvb, offset, -1, ENC_NA);\r\ndvb_data_mpe_tree = proto_item_add_subtree(ti, ett_dvb_data_mpe);\r\noffset += packet_mpeg_sect_header(tvb, offset, dvb_data_mpe_tree, &tot_len, NULL);\r\nmac_bytes_tvb[5] = tvb_new_subset_length(tvb, offset, 1);\r\noffset += 1;\r\nmac_bytes_tvb[4] = tvb_new_subset_length(tvb, offset, 1);\r\noffset += 1;\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_payload_scrambling_control, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_address_scrambling_control, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_llc_snap_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_current_next_indicator, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nllc_snap_flag = tvb_get_guint8(tvb, offset) & DVB_DATA_MPE_LLC_SNAP_FLAG_MASK;\r\noffset += 1;\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_last_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (i = 3; i >= 0; i--) {\r\nmac_bytes_tvb[i] = tvb_new_subset_length(tvb, offset, 1);\r\noffset += 1;\r\n}\r\nmac_tvb = tvb_new_composite();\r\nfor (i = 0; i < 6; i++)\r\ntvb_composite_append(mac_tvb, mac_bytes_tvb[i]);\r\ntvb_composite_finalize(mac_tvb);\r\nproto_tree_add_item(dvb_data_mpe_tree, hf_dvb_data_mpe_dst_mac, mac_tvb, 0 , 6, ENC_NA);\r\ncol_add_str(pinfo->cinfo, COL_RES_DL_DST, tvb_ether_to_str(mac_tvb, 0));\r\ndata_tvb = tvb_new_subset_remaining(tvb, offset);\r\nif (llc_snap_flag) {\r\ncall_dissector(llc_handle, data_tvb, pinfo, tree);\r\n} else {\r\ncall_dissector(ip_handle, data_tvb, pinfo, tree);\r\n}\r\npacket_mpeg_sect_crc(tvb, pinfo, dvb_data_mpe_tree, 0, tot_len - 1);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_dvb_data_mpe(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dvb_data_mpe_reserved, {\r\n"Reserved", "dvb_data_mpe.reserved",\r\nFT_UINT8, BASE_HEX, NULL, DVB_DATA_MPE_RESERVED_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_payload_scrambling_control, {\r\n"Payload Scrambling Control", "dvb_data_mpe.pload_scrambling",\r\nFT_UINT8, BASE_HEX, NULL, DVB_DATA_MPE_PAYLOAD_SCRAMBLING_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_address_scrambling_control, {\r\n"Address Scrambling Control", "dvb_data_mpe.addr_scrambling",\r\nFT_UINT8, BASE_HEX, NULL, DVB_DATA_MPE_ADDRESS_SCRAMBLING_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_llc_snap_flag, {\r\n"LLC SNAP Flag", "dvb_data_mpe.llc_snap_flag",\r\nFT_UINT8, BASE_HEX, NULL, DVB_DATA_MPE_LLC_SNAP_FLAG_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_current_next_indicator, {\r\n"Current/Next Indicator", "mpeg_sect.cur_next_ind",\r\nFT_UINT8, BASE_HEX, VALS(dvb_rcs_cur_next_vals), DVB_DATA_MPE_CURRENT_NEXT_INDICATOR_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_section_number, {\r\n"Section Number", "dvb_data_mpe.sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_last_section_number, {\r\n"Last Section Number", "dvb_data_mpe.last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_data_mpe_dst_mac, {\r\n"Destination MAC address", "dvb_data_mpe.dst_mac",\r\nFT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL\r\n} },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dvb_data_mpe,\r\n};\r\nproto_dvb_data_mpe = proto_register_protocol("DVB-DATA MultiProtocol Encapsulation", "DVB-DATA MPE", "dvb_data_mpe");\r\nproto_register_field_array(proto_dvb_data_mpe, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_dvb_data_mpe(void)\r\n{\r\ndissector_handle_t dvb_data_mpe_handle;\r\ndvb_data_mpe_handle = create_dissector_handle(dissect_dvb_data_mpe, proto_dvb_data_mpe);\r\ndissector_add_uint("mpeg_sect.tid", DVB_DATA_MPE_TID, dvb_data_mpe_handle);\r\nip_handle = find_dissector_add_dependency("ip", proto_dvb_data_mpe);\r\nllc_handle = find_dissector_add_dependency("llc", proto_dvb_data_mpe);\r\n}

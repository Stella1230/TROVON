static int\r\ndissect_redback(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint16 l3off, dataoff, proto;\r\nproto_item *ti, *protocol_item;\r\nproto_tree *rbtree = NULL;\r\ntvbuff_t *next_tvb;\r\ncol_set_str(pinfo->cinfo,COL_PROTOCOL,"RBN");\r\ndataoff = tvb_get_ntohs(tvb, 20);\r\nl3off = tvb_get_ntohs(tvb, 22);\r\nti = proto_tree_add_item(tree, hfi_redback, tvb, 0, -1, ENC_NA);\r\nrbtree = proto_item_add_subtree(ti, ett_redback);\r\nproto_tree_add_item(rbtree, &hfi_redback_context, tvb, 0, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rbtree, &hfi_redback_flags, tvb, 4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rbtree, &hfi_redback_circuit, tvb, 8, 8, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rbtree, &hfi_redback_length, tvb, 16, 2, ENC_BIG_ENDIAN);\r\nprotocol_item = proto_tree_add_item(rbtree, &hfi_redback_protocol, tvb, 18, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rbtree, &hfi_redback_dataoffset, tvb, 20, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(rbtree, &hfi_redback_l3offset, tvb, 22, 2, ENC_BIG_ENDIAN);\r\nif (dataoff > 24) {\r\nproto_tree_add_item(rbtree, &hfi_redback_padding, tvb, 24, dataoff-24, ENC_NA);\r\n}\r\nproto = tvb_get_ntohs(tvb, 18);\r\nswitch(proto) {\r\ncase 0x01:\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff);\r\nif (dataoff == l3off)\r\ncall_dissector(ipv4_handle, next_tvb, pinfo, tree);\r\nelse if (dataoff+2 == l3off)\r\ncall_dissector(ppp_handle, next_tvb, pinfo, tree);\r\nelse if (dataoff+4 == l3off)\r\ncall_dissector(ppphdlc_handle, next_tvb, pinfo, tree);\r\nelse\r\ncall_dissector(ethnofcs_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase 0x02:\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff);\r\nif (l3off > dataoff) {\r\ncall_dissector(ethnofcs_handle, next_tvb, pinfo, tree);\r\n} else {\r\nguint8 nlpid = tvb_get_guint8(tvb, dataoff);\r\nif(dissector_try_uint(osinl_incl_subdissector_table, nlpid, next_tvb, pinfo, tree))\r\nbreak;\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff+1);\r\nif(dissector_try_uint(osinl_excl_subdissector_table, nlpid, next_tvb, pinfo, tree))\r\nbreak;\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nbreak;\r\ncase 0x06: {\r\nguint32 flags;\r\nflags = tvb_get_ntohl(tvb, 4);\r\nif (flags & 0x04000000) {\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff);\r\n} else {\r\nif (tree)\r\nproto_tree_add_item(rbtree, &hfi_redback_unknown, tvb, dataoff, 4, ENC_NA);\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff+4);\r\n}\r\nif (l3off == dataoff) {\r\ncall_dissector(ppp_handle, next_tvb, pinfo, tree);\r\n} else {\r\ncall_dissector(ethnofcs_handle, next_tvb, pinfo, tree);\r\n}\r\nbreak;\r\n}\r\ncase 0x03:\r\ncase 0x04:\r\ncase 0x08:\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff);\r\ncall_dissector(ethnofcs_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase 0x09:\r\nnext_tvb = tvb_new_subset_remaining(tvb, dataoff);\r\nif (dataoff == l3off)\r\ncall_dissector(ipv6_handle, next_tvb, pinfo, tree);\r\nelse\r\ncall_dissector(ethnofcs_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, protocol_item, &ei_redback_protocol);\r\nbreak;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_redback(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_redback_context,\r\n&hfi_redback_flags,\r\n&hfi_redback_circuit,\r\n&hfi_redback_length,\r\n&hfi_redback_protocol,\r\n&hfi_redback_l3offset,\r\n&hfi_redback_dataoffset,\r\n&hfi_redback_padding,\r\n&hfi_redback_unknown,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_redback\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_redback_protocol, { "redback.protocol.unknown", PI_PROTOCOL, PI_WARN, "Unknown Protocol Data", EXPFILL }},\r\n};\r\nexpert_module_t* expert_redback;\r\nint proto_redback;\r\nproto_redback = proto_register_protocol("Redback", "Redback", "redback");\r\nhfi_redback = proto_registrar_get_nth(proto_redback);\r\nredback_handle = register_dissector("redback", dissect_redback, proto_redback);\r\nproto_register_fields(proto_redback, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_redback = expert_register_protocol(proto_redback);\r\nexpert_register_field_array(expert_redback, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_redback(void)\r\n{\r\nosinl_incl_subdissector_table = find_dissector_table("osinl.incl");\r\nosinl_excl_subdissector_table = find_dissector_table("osinl.excl");\r\nipv4_handle = find_dissector_add_dependency("ip", hfi_redback->id);\r\nipv6_handle = find_dissector_add_dependency("ipv6", hfi_redback->id);\r\nethnofcs_handle = find_dissector_add_dependency("eth_withoutfcs", hfi_redback->id);\r\nclnp_handle = find_dissector_add_dependency("clnp", hfi_redback->id);\r\narp_handle = find_dissector_add_dependency("arp", hfi_redback->id);\r\nppp_handle = find_dissector_add_dependency("ppp", hfi_redback->id);\r\nppphdlc_handle = find_dissector_add_dependency("ppp_hdlc", hfi_redback->id);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_REDBACK, redback_handle);\r\n}

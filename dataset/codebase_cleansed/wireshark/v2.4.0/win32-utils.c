gchar *\r\nprotect_arg (const gchar *argv)\r\n{\r\ngchar *new_arg;\r\nconst gchar *p = argv;\r\ngchar *q;\r\ngint len = 0;\r\ngboolean need_dblquotes = FALSE;\r\nwhile (*p) {\r\nif (*p == ' ' || *p == '\t')\r\nneed_dblquotes = TRUE;\r\nelse if (*p == '"')\r\nlen++;\r\nelse if (*p == '\\') {\r\nconst gchar *pp = p;\r\nwhile (*pp && *pp == '\\')\r\npp++;\r\nif (*pp == '"')\r\nlen++;\r\n}\r\nlen++;\r\np++;\r\n}\r\nq = new_arg = g_malloc (len + need_dblquotes*2 + 1);\r\np = argv;\r\nif (need_dblquotes)\r\n*q++ = '"';\r\nwhile (*p) {\r\nif (*p == '"')\r\n*q++ = '\\';\r\nelse if (*p == '\\') {\r\nconst gchar *pp = p;\r\nwhile (*pp && *pp == '\\')\r\npp++;\r\nif (*pp == '"')\r\n*q++ = '\\';\r\n}\r\n*q++ = *p;\r\np++;\r\n}\r\nif (need_dblquotes)\r\n*q++ = '"';\r\n*q++ = '\0';\r\nreturn new_arg;\r\n}\r\nconst char *\r\nwin32strerror(DWORD error)\r\n{\r\nstatic char errbuf[ERRBUF_SIZE+1];\r\nsize_t errlen;\r\nchar *p;\r\nFormatMessageA(FORMAT_MESSAGE_FROM_SYSTEM | FORMAT_MESSAGE_IGNORE_INSERTS,\r\nNULL, error, 0, errbuf, ERRBUF_SIZE, NULL);\r\nerrlen = strlen(errbuf);\r\nif (errlen >= 2) {\r\nerrbuf[errlen - 1] = '\0';\r\nerrbuf[errlen - 2] = '\0';\r\n}\r\np = strchr(errbuf, '\0');\r\ng_snprintf(p, (gulong)(sizeof errbuf - (p-errbuf)), " (%lu)", error);\r\nreturn errbuf;\r\n}\r\nconst char *\r\nwin32strexception(DWORD exception)\r\n{\r\nstatic char errbuf[ERRBUF_SIZE+1];\r\nstatic const struct exception_msg {\r\nint code;\r\nchar *msg;\r\n} exceptions[] = {\r\n{ EXCEPTION_ACCESS_VIOLATION, "Access violation" },\r\n{ EXCEPTION_ARRAY_BOUNDS_EXCEEDED, "Array bounds exceeded" },\r\n{ EXCEPTION_BREAKPOINT, "Breakpoint" },\r\n{ EXCEPTION_DATATYPE_MISALIGNMENT, "Data type misalignment" },\r\n{ EXCEPTION_FLT_DENORMAL_OPERAND, "Denormal floating-point operand" },\r\n{ EXCEPTION_FLT_DIVIDE_BY_ZERO, "Floating-point divide by zero" },\r\n{ EXCEPTION_FLT_INEXACT_RESULT, "Floating-point inexact result" },\r\n{ EXCEPTION_FLT_INVALID_OPERATION, "Invalid floating-point operation" },\r\n{ EXCEPTION_FLT_OVERFLOW, "Floating-point overflow" },\r\n{ EXCEPTION_FLT_STACK_CHECK, "Floating-point stack check" },\r\n{ EXCEPTION_FLT_UNDERFLOW, "Floating-point underflow" },\r\n{ EXCEPTION_GUARD_PAGE, "Guard page violation" },\r\n{ EXCEPTION_ILLEGAL_INSTRUCTION, "Illegal instruction" },\r\n{ EXCEPTION_IN_PAGE_ERROR, "Page-in error" },\r\n{ EXCEPTION_INT_DIVIDE_BY_ZERO, "Integer divide by zero" },\r\n{ EXCEPTION_INT_OVERFLOW, "Integer overflow" },\r\n{ EXCEPTION_INVALID_DISPOSITION, "Invalid disposition" },\r\n{ EXCEPTION_INVALID_HANDLE, "Invalid handle" },\r\n{ EXCEPTION_NONCONTINUABLE_EXCEPTION, "Non-continuable exception" },\r\n{ EXCEPTION_PRIV_INSTRUCTION, "Privileged instruction" },\r\n{ EXCEPTION_SINGLE_STEP, "Single-step complete" },\r\n{ EXCEPTION_STACK_OVERFLOW, "Stack overflow" },\r\n{ 0, NULL }\r\n};\r\n#define N_EXCEPTIONS (sizeof exceptions / sizeof exceptions[0])\r\nint i;\r\nfor (i = 0; i < N_EXCEPTIONS; i++) {\r\nif (exceptions[i].code == exception)\r\nreturn exceptions[i].msg;\r\n}\r\ng_snprintf(errbuf, (gulong)sizeof errbuf, "Exception 0x%08x", exception);\r\nreturn errbuf;\r\n}

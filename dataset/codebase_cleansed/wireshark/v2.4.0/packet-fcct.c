guint8\r\nget_gs_server (guint8 gstype, guint8 gssubtype)\r\n{\r\nswitch (gstype) {\r\ncase FCCT_GSTYPE_KEYSVC:\r\nreturn FCCT_GSRVR_KS;\r\ncase FCCT_GSTYPE_ALIASSVC:\r\nif (gssubtype == FCCT_GSSUBTYPE_AS)\r\nreturn FCCT_GSRVR_AS;\r\nreturn FCCT_GSRVR_UNKNOWN;\r\ncase FCCT_GSTYPE_MGMTSVC:\r\nif (gssubtype == FCCT_GSSUBTYPE_FCS)\r\nreturn FCCT_GSRVR_FCS;\r\nelse if (gssubtype == FCCT_GSSUBTYPE_UNS)\r\nreturn FCCT_GSRVR_UNS;\r\nelse if (gssubtype == FCCT_GSSUBTYPE_FZS)\r\nreturn FCCT_GSRVR_FZS;\r\nelse return FCCT_GSRVR_UNKNOWN;\r\ncase FCCT_GSTYPE_TIMESVC:\r\nif (gssubtype == FCCT_GSSUBTYPE_TS)\r\nreturn FCCT_GSRVR_TS;\r\nreturn FCCT_GSRVR_UNKNOWN;\r\ncase FCCT_GSTYPE_DIRSVC:\r\nif (gssubtype == FCCT_GSSUBTYPE_DNS)\r\nreturn FCCT_GSRVR_DNS;\r\nelse if (gssubtype == FCCT_GSSUBTYPE_IP)\r\nreturn FCCT_GSRVR_IP;\r\nreturn FCCT_GSRVR_UNKNOWN;\r\ncase FCCT_GSRVR_FCTLR:\r\nif (gssubtype == FCCT_GSSUBTYPE_FCTLR)\r\nreturn (FCCT_GSRVR_FCTLR);\r\nelse return (FCCT_GSRVR_UNKNOWN);\r\ndefault:\r\nreturn FCCT_GSRVR_UNKNOWN;\r\n}\r\n}\r\nstatic int\r\ndissect_fcct (tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nproto_item *ti;\r\nproto_tree *fcct_tree;\r\ntvbuff_t *next_tvb;\r\nint in_id,\r\noffset = 0;\r\nguint8 server;\r\nfc_ct_preamble cthdr;\r\naddress addr;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "FC_CT");\r\ntvb_memcpy (tvb, (guint8 *)&cthdr, offset, FCCT_PRMBL_SIZE);\r\ncthdr.revision = tvb_get_guint8 (tvb, offset++);\r\ncthdr.in_id = tvb_get_ntoh24 (tvb, offset);\r\ncthdr.opcode = g_ntohs (cthdr.opcode);\r\ncthdr.maxres_size = g_ntohs (cthdr.maxres_size);\r\nif (cthdr.opcode < FCCT_MSG_REQ_MAX) {\r\ncol_append_str (pinfo->cinfo, COL_INFO, " Request");\r\n}\r\nelse if (cthdr.opcode == FCCT_MSG_ACC) {\r\ncol_append_str (pinfo->cinfo, COL_INFO, " Accept");\r\n}\r\nelse if (cthdr.opcode == FCCT_MSG_RJT) {\r\ncol_append_fstr (pinfo->cinfo, COL_INFO, " Reject (%s)",\r\nval_to_str (cthdr.rjt_code, fc_ct_rjt_code_vals, "0x%x"));\r\n}\r\nelse {\r\ncol_append_str (pinfo->cinfo, COL_INFO, " Reserved");\r\n}\r\nin_id = cthdr.in_id;\r\nin_id = g_htonl (in_id) >> 8;\r\nserver = get_gs_server (cthdr.gstype, cthdr.gssubtype);\r\nif (tree) {\r\noffset = 0;\r\nti = proto_tree_add_protocol_format (tree, proto_fcct, tvb, 0, FCCT_PRMBL_SIZE,\r\n"FC_CT");\r\nfcct_tree = proto_item_add_subtree (ti, ett_fcct);\r\nproto_tree_add_item (fcct_tree, hf_fcct_revision, tvb, offset++,\r\nsizeof (guint8), ENC_BIG_ENDIAN);\r\nset_address(&addr, AT_FC, 3, &in_id);\r\nproto_tree_add_string (fcct_tree, hf_fcct_inid, tvb, offset, 3,\r\naddress_to_str(wmem_packet_scope(), &addr));\r\noffset += 3;\r\nproto_tree_add_item (fcct_tree, hf_fcct_gstype, tvb, offset++,\r\nsizeof (guint8), ENC_BIG_ENDIAN);\r\nproto_tree_add_item (fcct_tree, hf_fcct_gssubtype, tvb, offset,\r\nsizeof (guint8), ENC_BIG_ENDIAN);\r\nproto_tree_add_uint (fcct_tree, hf_fcct_server, tvb, offset++, 1,\r\nserver);\r\nproto_tree_add_item (fcct_tree, hf_fcct_options, tvb, offset++,\r\nsizeof (guint8), ENC_BIG_ENDIAN);\r\n}\r\nnext_tvb = tvb_new_subset_remaining (tvb, 0);\r\nif (!dissector_try_uint_new(fcct_gserver_table, server, next_tvb, pinfo,\r\ntree, TRUE, data)) {\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_fcct(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_fcct_revision,\r\n{"Revision", "fcct.revision", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL}},\r\n{ &hf_fcct_inid,\r\n{"IN_ID", "fcct.in_id", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL}},\r\n{ &hf_fcct_gstype,\r\n{"GS Type", "fcct.gstype", FT_UINT8, BASE_HEX, VALS(fc_ct_gstype_vals),\r\n0x0, NULL, HFILL}},\r\n{ &hf_fcct_gssubtype,\r\n{"GS Subtype", "fcct.gssubtype", FT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_fcct_server,\r\n{"Server", "fcct.server", FT_UINT8, BASE_HEX,\r\nVALS (fc_ct_gsserver_vals), 0x0,\r\n"Derived from GS Type & Subtype fields", HFILL}},\r\n{ &hf_fcct_options,\r\n{"Options", "fcct.options", FT_UINT8, BASE_HEX, NULL, 0x0, NULL,\r\nHFILL}},\r\n#if 0\r\n{ &hf_fcct_ext_said,\r\n{"Auth SAID", "fcct.ext_said", FT_UINT32, BASE_HEX, NULL, 0x0, NULL,\r\nHFILL}},\r\n{ &hf_fcct_ext_tid,\r\n{"Transaction ID", "fcct.ext_tid", FT_UINT32, BASE_HEX, NULL, 0x0, NULL,\r\nHFILL}},\r\n{ &hf_fcct_ext_reqname,\r\n{"Requestor Port Name", "fcct.ext_reqnm", FT_BYTES, BASE_NONE, NULL,\r\n0x0, NULL, HFILL}},\r\n{ &hf_fcct_ext_tstamp,\r\n{"Timestamp", "fcct.ext_tstamp", FT_BYTES, BASE_NONE, NULL, 0x0, NULL,\r\nHFILL}},\r\n{ &hf_fcct_ext_authblk,\r\n{"Auth Hash Blk", "fcct.ext_authblk", FT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n#endif\r\n};\r\nstatic gint *ett[] = {\r\n&ett_fcct,\r\n&ett_fcct_ext,\r\n};\r\nproto_fcct = proto_register_protocol("Fibre Channel Common Transport", "FC_CT", "fcct");\r\nproto_register_field_array(proto_fcct, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nfcct_gserver_table = register_dissector_table ("fcct.server",\r\n"FCCT Server",\r\nproto_fcct, FT_UINT8, BASE_HEX);\r\n}\r\nvoid\r\nproto_reg_handoff_fcct (void)\r\n{\r\ndissector_handle_t fcct_handle;\r\nfcct_handle = create_dissector_handle (dissect_fcct, proto_fcct);\r\ndissector_add_uint("fc.ftype", FC_FTYPE_FCCT, fcct_handle);\r\n}

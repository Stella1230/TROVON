static int\r\ndissect_ppcap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *ppcap_tree, *ppcap_tree1;\r\nguint16 msg_type;\r\nint offset = 0;\r\npayload_type_type payload_type = PPCAP_UNKNOWN;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PPCAP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_ppcap, tvb, 0, -1, ENC_NA);\r\nppcap_tree = proto_item_add_subtree(ti, ett_ppcap);\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0)\r\n{\r\nmsg_type = tvb_get_ntohs(tvb, offset);\r\nppcap_tree1 = proto_tree_add_subtree(ppcap_tree, tvb, offset, 2, ett_ppcap1, NULL,\r\nval_to_str(msg_type, payload_tag_values, "Unknown PPCAP message type (%u)"));\r\noffset = offset + 2;\r\nswitch (msg_type) {\r\ncase 1:\r\npayload_type = PPCAP_UNKNOWN;\r\noffset = dissect_ppcap_payload_type(tvb, ppcap_tree1, offset, &payload_type);\r\nbreak;\r\ncase 2:\r\noffset = dissect_ppcap_payload_data(tvb, pinfo, ppcap_tree1, offset, tree, payload_type);\r\nbreak;\r\ncase 3:\r\noffset = dissect_ppcap_source_address(tvb, pinfo, ppcap_tree1, offset);\r\nbreak;\r\ncase 4:\r\noffset = dissect_ppcap_destination_address(tvb, pinfo, ppcap_tree1, offset);\r\nbreak;\r\ncase 5:\r\noffset = dissect_ppcap_local_port(tvb,ppcap_tree1, offset);\r\nbreak;\r\ncase 6:\r\noffset = dissect_ppcap_remote_port(tvb,ppcap_tree1, offset);\r\nbreak;\r\ncase 7:\r\noffset = dissect_ppcap_transport_protocol(tvb,ppcap_tree1, offset);\r\nbreak;\r\ncase 8:\r\noffset = dissect_ppcap_sctp_assoc(tvb, ppcap_tree1, offset);\r\nbreak;\r\ncase 256:\r\noffset = dissect_ppcap_info_string(tvb, ppcap_tree1, offset);\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_ppcap_payload_type(tvbuff_t *tvb, proto_tree * ppcap_tree1, int offset, payload_type_type *payload_type)\r\n{\r\nchar *string;\r\nguint16 msg_len =0;\r\nmsg_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item( ppcap_tree1, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nstring = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, msg_len, ENC_UTF_8|ENC_NA);\r\nif (strcmp(string,"mtp3") == 0) {\r\n*payload_type = PPCAP_MTP3;\r\n}else if (strcmp(string,"tcap") == 0) {\r\n*payload_type = PPCAP_TCAP;\r\n}else if (strcmp(string,"bssap") == 0) {\r\n*payload_type = PPCAP_BSSAP;\r\n}else if (strcmp(string,"ranap") == 0) {\r\n*payload_type = PPCAP_RANAP;\r\n}else if (strcmp(string,"h248") == 0) {\r\n*payload_type = PPCAP_H248;\r\n}else if (strcmp(string,"sip") == 0) {\r\n*payload_type = PPCAP_SIP;\r\n}else if (strcmp(string,"sccp") == 0) {\r\n*payload_type = PPCAP_SCCP;\r\n}else if (strcmp(string, "sgsap") == 0) {\r\n*payload_type = PPCAP_SGSAP;\r\n}else if (strcmp(string, "gtpv2") == 0) {\r\n*payload_type = PPCAP_GTPV2;\r\n}\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_payload_type, tvb, offset, msg_len, ENC_UTF_8|ENC_NA);\r\nif (msg_len%4)\r\nmsg_len = msg_len+(4-(msg_len%4));\r\noffset += msg_len;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_source_address(tvbuff_t *tvb, packet_info *pinfo, proto_tree * ppcap_tree1, int offset)\r\n{\r\nint key1;\r\nguint16 msg_len;\r\nmsg_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item( ppcap_tree1, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_reserved, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nkey1 = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_address_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (key1 == 1)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_ssn, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_spc, tvb, offset, 3, ENC_BIG_ENDIAN);\r\nmtp3_addr_opc = wmem_new0(wmem_packet_scope(), mtp3_addr_pc_t);\r\nmtp3_addr_opc->pc = (guint32 )tvb_get_ntoh24(tvb, offset);\r\nmtp3_addr_opc->type = ITU_STANDARD;\r\nmtp3_addr_opc->ni = 0;\r\nset_address(&pinfo->src, ss7pc_address_type, sizeof(mtp3_addr_pc_t), (guint8 *) mtp3_addr_opc);\r\nif (msg_len%4)\r\nmsg_len = msg_len + (4 - (msg_len%4));\r\noffset += msg_len-1;\r\nreturn offset;\r\n}\r\nelse if (key1 == 2)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_opc, tvb, offset, msg_len, ENC_BIG_ENDIAN);\r\nmtp3_addr_opc = wmem_new0(wmem_packet_scope(), mtp3_addr_pc_t);\r\nmtp3_addr_opc->pc = tvb_get_ntohl(tvb, offset);\r\nmtp3_addr_opc->type = ITU_STANDARD;\r\nmtp3_addr_opc->ni = 0;\r\nset_address(&pinfo->src, ss7pc_address_type, sizeof(mtp3_addr_pc_t), (guint8 *) mtp3_addr_opc);\r\n}\r\nelse if (key1 == 3)\r\n{\r\nif (msg_len%16 != 0)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_source_ip_address1, tvb, offset, msg_len, ENC_NA);\r\nset_address_tvb(&pinfo->net_src, AT_IPv4, 4, tvb, offset);\r\ncopy_address_shallow(&pinfo->src, &pinfo->net_src);\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_source_ip_address2, tvb, offset, msg_len, ENC_NA);\r\nset_address_tvb(&pinfo->net_src, AT_IPv6, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->src, &pinfo->net_src);\r\n}\r\n}\r\nelse if (key1 == 4)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_source_nodeid, tvb, offset, msg_len, ENC_ASCII|ENC_NA);\r\nset_address_tvb(&pinfo->net_src, AT_STRINGZ, msg_len, tvb, offset);\r\ncopy_address_shallow(&pinfo->src, &pinfo->net_src);\r\n}\r\nif (msg_len%4)\r\nmsg_len = msg_len + (4 - (msg_len%4));\r\noffset += msg_len;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_destination_address(tvbuff_t *tvb, packet_info * pinfo, proto_tree * ppcap_tree1, int offset)\r\n{\r\nint key2;\r\nguint16 msg_len;\r\nmsg_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item( ppcap_tree1, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_destreserved, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nkey2 = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_address_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (key2 == 1)\r\n{\r\nssn = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_ssn1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_spc1, tvb, offset, 3, ENC_BIG_ENDIAN);\r\nmtp3_addr_dpc = wmem_new0(wmem_packet_scope(), mtp3_addr_pc_t);\r\nmtp3_addr_dpc->pc = (guint32)tvb_get_ntoh24(tvb, offset);\r\nmtp3_addr_dpc->type = ITU_STANDARD;\r\nmtp3_addr_dpc->ni = 0;\r\nset_address(&pinfo->dst, ss7pc_address_type, sizeof(mtp3_addr_pc_t), (guint8 *) mtp3_addr_dpc);\r\nif (msg_len%4)\r\nmsg_len = msg_len + (4 - (msg_len%4));\r\noffset += msg_len-1;\r\nreturn offset;\r\n}\r\nelse if (key2 == 2)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_dpc, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nmtp3_addr_dpc = wmem_new0(wmem_packet_scope(), mtp3_addr_pc_t);\r\nmtp3_addr_dpc->pc = tvb_get_ntohl(tvb, offset);\r\nmtp3_addr_dpc->type = ITU_STANDARD;\r\nmtp3_addr_dpc->ni = 0;\r\nset_address(&pinfo->dst, ss7pc_address_type, sizeof(mtp3_addr_pc_t), (guint8 *) mtp3_addr_dpc);\r\n}\r\nelse if (key2 == 3)\r\n{\r\nif (msg_len%16 != 0)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_destination_ip_address1, tvb, offset, msg_len, ENC_NA);\r\nset_address_tvb(&pinfo->net_dst, AT_IPv4, 4, tvb, offset);\r\ncopy_address_shallow(&pinfo->dst, &pinfo->net_dst);\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_destination_ip_address2, tvb, offset, msg_len, ENC_NA);\r\nset_address_tvb(&pinfo->net_dst, AT_IPv6, 6, tvb, offset);\r\ncopy_address_shallow(&pinfo->dst, &pinfo->net_dst);\r\n}\r\n}\r\nelse if (key2 == 4)\r\n{\r\nconst guint8 *string;\r\nproto_tree_add_item_ret_string(ppcap_tree1, hf_ppcap_destination_nodeid, tvb, offset, msg_len, ENC_UTF_8|ENC_NA, wmem_packet_scope(), &string);\r\nset_address_tvb(&pinfo->net_dst, AT_STRINGZ, msg_len, tvb, offset);\r\ncopy_address_shallow(&pinfo->dst, &pinfo->net_dst);\r\n}\r\nif (msg_len%4)\r\nmsg_len = msg_len+(4-(msg_len%4));\r\noffset += msg_len;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_info_string(tvbuff_t *tvb, proto_tree * ppcap_tree1, int offset)\r\n{\r\nguint16 msg_len;\r\nmsg_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item( ppcap_tree1, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_info, tvb, offset, msg_len, ENC_ASCII|ENC_NA);\r\nif (msg_len%4)\r\nmsg_len = msg_len +( 4- (msg_len%4));\r\noffset += msg_len;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_local_port(tvbuff_t *tvb,proto_tree * ppcap_tree1, int offset)\r\n{\r\nproto_tree_add_item(ppcap_tree1,hf_ppcap_local_port,tvb,offset,2,ENC_BIG_ENDIAN);\r\noffset = offset+6;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_remote_port(tvbuff_t *tvb,proto_tree * ppcap_tree1, int offset)\r\n{\r\nproto_tree_add_item(ppcap_tree1,hf_ppcap_remote_port,tvb,offset,2,ENC_BIG_ENDIAN);\r\noffset = offset+6;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_transport_protocol(tvbuff_t *tvb,proto_tree * ppcap_tree1, int offset)\r\n{\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_transport_prot, tvb, offset, 4, ENC_ASCII | ENC_NA);\r\noffset += 4;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_ppcap_sctp_assoc(tvbuff_t *tvb _U_, proto_tree * tree _U_, int offset)\r\n{\r\nguint16 length;\r\nlength = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(tree, hf_ppcap_sctp_assoc, tvb, offset, length, ENC_ASCII | ENC_NA);\r\nreturn offset + 16;\r\n}\r\nstatic int\r\ndissect_ppcap_payload_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree * ppcap_tree1, int offset, proto_tree *tree, payload_type_type payload_type)\r\n{\r\ntvbuff_t *next_tvb;\r\nguint16 msg_len;\r\nmsg_len = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item( ppcap_tree1, hf_ppcap_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset = offset + 2;\r\nproto_tree_add_item(ppcap_tree1, hf_ppcap_payload_data, tvb, offset, msg_len, ENC_NA);\r\nif (msg_len%4)\r\nmsg_len = msg_len +( 4- (msg_len%4));\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\nswitch (payload_type) {\r\ncase PPCAP_MTP3:\r\ncall_dissector(mtp3_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_TCAP:\r\nif (ssn != INVALID_SSN && dissector_try_uint(sccp_ssn_dissector_table, ssn, next_tvb, pinfo, tree)) {\r\nreturn offset+msg_len;\r\n}else{\r\ncall_dissector(tcap_handle, next_tvb, pinfo, tree);\r\n}\r\nbreak;\r\ncase PPCAP_BSSAP:\r\ncall_dissector(bssap_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_RANAP:\r\ncall_dissector(ranap_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_H248:\r\ncall_dissector(h248_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_SIP:\r\ncall_dissector(sip_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_SCCP:\r\ncall_dissector(sccp_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_SGSAP:\r\ncall_dissector(sgsap_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase PPCAP_GTPV2:\r\ncall_dissector(gtpv2_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ndefault:\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\nbreak;\r\n}\r\noffset += msg_len;\r\nreturn offset;\r\n}\r\nvoid proto_register_ppcap(void)\r\n{\r\nmodule_t *ppcap_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ppcap_length,\r\n{ "Length", "ppcap.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_payload_type,\r\n{ "Payload Type" , "ppcap.payload_type", FT_STRING,\r\nBASE_NONE, NULL, 0x0 , NULL, HFILL}},\r\n{ &hf_ppcap_reserved,\r\n{ "Reserved", "ppcap.reserved", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_address_type,\r\n{ "Address Type", "ppcap.address_type", FT_UINT16,\r\nBASE_DEC, VALS(address_type_values), 0x00 , NULL, HFILL}},\r\n#if 0\r\n{ &hf_ppcap_source_address_type,\r\n{ "Source Address Type", "ppcap.source_address_type", FT_UINT16,\r\nBASE_DEC, VALS(address_type_values), 0x00 , NULL, HFILL}},\r\n#endif\r\n{ &hf_ppcap_ssn,\r\n{ "SSN", "ppcap.ssn", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_spc,\r\n{"OPC", "ppcap.spc", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_opc,\r\n{ "OPC", "ppcap.opc", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_source_ip_address1,\r\n{ "Source IP Address", "ppcap.source_ip_address1", FT_IPv4,\r\nBASE_NONE, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_source_ip_address2,\r\n{ "Source IP Address", "ppcap.source_ip_address2", FT_IPv6,\r\nBASE_NONE, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_destreserved,\r\n{ "Reserved", "ppcap.destreserved", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n#if 0\r\n{ &hf_ppcap_destination_address_type,\r\n{ "Destination Address Type", "ppcap.destination_address_type", FT_UINT16,\r\nBASE_DEC, VALS(address_type_values), 0x00, NULL, HFILL}},\r\n#endif\r\n{ &hf_ppcap_ssn1,\r\n{ "SSN", "ppcap.ssn1", FT_UINT8,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_spc1,\r\n{ "DPC", "ppcap.spc1", FT_UINT24,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_dpc,\r\n{ "DPC", "ppcap.dpc", FT_UINT32,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_destination_ip_address1,\r\n{ "Destination IP Address", "ppcap.destination_ip_address1", FT_IPv4,\r\nBASE_NONE, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_destination_ip_address2,\r\n{ "Destination IP Address", "ppcap.destination_ip_address2", FT_IPv6,\r\nBASE_NONE, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_source_nodeid,\r\n{ "Source Node ID", "ppcap.source_nodeid", FT_STRING,\r\nBASE_NONE, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_destination_nodeid,\r\n{ "Destination Node ID", "ppcap.destination_address", FT_STRING,\r\nBASE_NONE, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_info,\r\n{ "Info", "ppcap.info", FT_STRING,\r\nBASE_NONE, NULL, 0x0000, NULL, HFILL}},\r\n{ &hf_ppcap_payload_data,\r\n{ "Payload Data", "ppcap.payload_data", FT_BYTES,\r\nBASE_NONE, NULL, 0x0000, NULL, HFILL}},\r\n{ &hf_ppcap_local_port,\r\n{ "Local Port", "ppcap.local_port", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_remote_port,\r\n{ "Remote Port", "ppcap.remote_port", FT_UINT16,\r\nBASE_DEC, NULL, 0x00, NULL, HFILL}},\r\n{ &hf_ppcap_transport_prot,\r\n{ "Transport Protocol" , "ppcap.transport_prot", FT_STRING,\r\nBASE_NONE, NULL, 0x0 , NULL, HFILL}},\r\n{ &hf_ppcap_sctp_assoc,\r\n{ "SCTP Association ID" , "ppcap.sctp_assoc", FT_STRING,\r\nBASE_NONE, NULL, 0x0 , NULL, HFILL } },\r\n};\r\nstatic gint *ett[]= {\r\n&ett_ppcap,\r\n&ett_ppcap1,\r\n&ett_ppcap_new,\r\n};\r\nproto_ppcap = proto_register_protocol("Proprietary PCAP", "PPCAP", "ppcap");\r\nproto_register_field_array(proto_ppcap , hf , array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("ppcap", dissect_ppcap, proto_ppcap);\r\nppcap_module = prefs_register_protocol(proto_ppcap, proto_reg_handoff_ppcap);\r\nprefs_register_obsolete_preference(ppcap_module, "rev_doc");\r\n}\r\nvoid proto_reg_handoff_ppcap(void)\r\n{\r\nppcap_handle = find_dissector_add_dependency("ppcap", proto_ppcap);\r\nmtp3_handle = find_dissector_add_dependency("mtp3", proto_ppcap);\r\ntcap_handle = find_dissector_add_dependency("tcap", proto_ppcap);\r\nbssap_handle = find_dissector_add_dependency("bssap", proto_ppcap);\r\nranap_handle = find_dissector_add_dependency("ranap", proto_ppcap);\r\nh248_handle = find_dissector_add_dependency("h248", proto_ppcap);\r\nsip_handle = find_dissector_add_dependency("sip", proto_ppcap);\r\nsccp_handle = find_dissector_add_dependency("sccp", proto_ppcap);\r\nsgsap_handle = find_dissector_add_dependency("sgsap", proto_ppcap);\r\ngtpv2_handle = find_dissector_add_dependency("gtpv2", proto_ppcap);\r\nsccp_ssn_dissector_table = find_dissector_table("sccp.ssn");\r\nss7pc_address_type = address_type_get_by_name("AT_SS7PC");\r\n}

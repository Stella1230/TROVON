static int\r\ndissect_PNPTCP_TLVHeader(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item _U_, guint16 *type, guint16 *length)\r\n{\r\nguint16 tl_type;\r\nguint16 tl_length;\r\ndissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_ptcp_tl_type, &tl_type);\r\n*type = tl_type >> 9;\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_ptcp_tl_length, &tl_length);\r\n*length = tl_length & 0x1FF;\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_Subdomain(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 u16FrameID)\r\n{\r\nguint8 mac[6];\r\ne_guid_t uuid;\r\noffset = dissect_pn_mac(tvb, offset, pinfo, tree, hf_pn_ptcp_master_source_address, mac);\r\noffset = dissect_pn_uuid(tvb, offset, pinfo, tree, hf_pn_ptcp_subdomain_uuid, &uuid);\r\nif ((u16FrameID == 0xff00) || (u16FrameID == 0xff01)) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Master=%02x:%02x:%02x:%02x:%02x:%02x",\r\nmac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);\r\n}\r\nproto_item_append_text(item, ": MasterSource=%02x:%02x:%02x:%02x:%02x:%02x",\r\nmac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);\r\nproto_item_append_text(item, ", Subdomain=%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x",\r\nuuid.data1, uuid.data2, uuid.data3,\r\nuuid.data4[0], uuid.data4[1],\r\nuuid.data4[2], uuid.data4[3],\r\nuuid.data4[4], uuid.data4[5],\r\nuuid.data4[6], uuid.data4[7]);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_Time(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint16 EpochNumber;\r\nguint32 Seconds;\r\nguint32 NanoSeconds;\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_ptcp_epoch_number, &EpochNumber);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, tree, hf_pn_ptcp_seconds, &Seconds);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, tree, hf_pn_ptcp_nanoseconds, &NanoSeconds);\r\nproto_item_append_text(item, ": Seconds=%u NanoSeconds=%u EpochNumber=%u",\r\nSeconds, NanoSeconds, EpochNumber);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Time: %4us %09uns, Epoch: %u",\r\nSeconds, NanoSeconds, EpochNumber);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_TimeExtension(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint16 Flags;\r\nguint16 CurrentUTCOffset;\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_ptcp_flags, &Flags);\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, tree, hf_pn_ptcp_currentutcoffset, &CurrentUTCOffset);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\nproto_item_append_text(item, ": Flags=0x%x, CurrentUTCOffset=%u", Flags, CurrentUTCOffset);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_Master(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint8 MasterPriority1;\r\nguint8 MasterPriority2;\r\nguint8 ClockClass;\r\nguint8 ClockAccuracy;\r\ngint16 ClockVariance;\r\ndissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_master_priority1, &MasterPriority1);\r\ndissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_master_priority_level, &MasterPriority1);\r\ndissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_master_priority1_res, &MasterPriority1);\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_master_priority1_act, &MasterPriority1);\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_master_priority2, &MasterPriority2);\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_clock_class, &ClockClass);\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_clock_accuracy, &ClockAccuracy);\r\noffset = dissect_pn_int16(tvb, offset, pinfo, tree, hf_pn_ptcp_clockvariance, &ClockVariance);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Prio1=\"%s\"",\r\nval_to_str(MasterPriority1 & 0x7, pn_ptcp_master_prio1_vals, "(Reserved: 0x%x)"));\r\nif ((MasterPriority1 & 0x80) == 0) {\r\nproto_item_append_text(item, ": Prio1=\"%s\", Prio2=%s, Clock: Class=\"%s\", Accuracy=%s, Variance=%d",\r\nval_to_str(MasterPriority1 & 0x7, pn_ptcp_master_prio1_vals, "(Reserved: 0x%x)"),\r\nval_to_str(MasterPriority2, pn_ptcp_master_prio2_vals, "(Reserved: 0x%x)"),\r\nval_to_str(ClockClass, pn_ptcp_clock_class_vals, "(Reserved: 0x%x)"),\r\nval_to_str(ClockAccuracy, pn_ptcp_clock_accuracy_vals, "(Reserved: 0x%x)"),\r\nClockVariance);\r\n}\r\nelse {\r\ncol_append_str(pinfo->cinfo, COL_INFO, " active");\r\nproto_item_append_text(item, ": Prio1=\"%s\" is active, Prio2=%s, Clock: Class=\"%s\", Accuracy=%s, Variance=%d",\r\nval_to_str(MasterPriority1 & 0x7, pn_ptcp_master_prio1_vals, "(Reserved: 0x%x)"),\r\nval_to_str(MasterPriority2, pn_ptcp_master_prio2_vals, "(Reserved: 0x%x)"),\r\nval_to_str(ClockClass, pn_ptcp_clock_class_vals, "(Reserved: 0x%x)"),\r\nval_to_str(ClockAccuracy, pn_ptcp_clock_accuracy_vals, "(Reserved: 0x%x)"),\r\nClockVariance);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_PortParameter(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint32 t2portrxdelay;\r\nguint32 t3porttxdelay;\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, tree, hf_pn_ptcp_t2portrxdelay, &t2portrxdelay);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, tree, hf_pn_ptcp_t3porttxdelay, &t3porttxdelay);\r\nproto_item_append_text(item, ": T2PortRxDelay=%uns, T3PortTxDelay=%uns",\r\nt2portrxdelay, t3porttxdelay);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", T2Rx=%uns, T3Tx=%uns",\r\nt2portrxdelay, t3porttxdelay);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_DelayParameter(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint8 mac[6];\r\noffset = dissect_pn_mac(tvb, offset, pinfo, tree, hf_pn_ptcp_port_mac_address, mac);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\nproto_item_append_text(item, ": PortMAC=%02x:%02x:%02x:%02x:%02x:%02x",\r\nmac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", PortMAC=%02x:%02x:%02x:%02x:%02x:%02x",\r\nmac[0], mac[1], mac[2], mac[3], mac[4], mac[5]);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_PortTime(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item)\r\n{\r\nguint32 t2timestamp;\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, tree, hf_pn_ptcp_t2timestamp, &t2timestamp);\r\nproto_item_append_text(item, ": T2TimeStamp=%uns", t2timestamp);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", T2TS=%uns", t2timestamp);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_Option_PROFINET(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 length)\r\n{\r\nguint8 subType;\r\ne_guid_t uuid;\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, tree, hf_pn_ptcp_profinet_subtype, &subType);\r\nlength -= 1;\r\nswitch (subType) {\r\ncase 1:\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\noffset = dissect_pn_uuid(tvb, offset, pinfo, tree, hf_pn_ptcp_irdata_uuid, &uuid);\r\nproto_item_append_text(item, ": IRDataUUID=%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x",\r\nuuid.data1, uuid.data2, uuid.data3,\r\nuuid.data4[0], uuid.data4[1],\r\nuuid.data4[2], uuid.data4[3],\r\nuuid.data4[4], uuid.data4[5],\r\nuuid.data4[6], uuid.data4[7]);\r\nbreak;\r\ndefault:\r\noffset = dissect_pn_undecoded(tvb, offset, pinfo, tree, length);\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_Option(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 length)\r\n{\r\nguint32 oui;\r\nif (length < 4)\r\n{\r\noffset = dissect_pn_undecoded(tvb, offset, pinfo, tree, length);\r\nreturn (offset);\r\n}\r\noffset = dissect_pn_oid(tvb, offset, pinfo,tree, hf_pn_ptcp_oui, &oui);\r\nlength -= 3;\r\nswitch (oui)\r\n{\r\ncase OUI_PROFINET:\r\ncase OUI_PROFINET_MULTICAST:\r\nproto_item_append_text(item, ": PROFINET");\r\noffset = dissect_PNPTCP_Option_PROFINET(tvb, offset, pinfo, tree, item, length);\r\nbreak;\r\ndefault:\r\noffset = dissect_pn_undecoded(tvb, offset, pinfo, tree, length);\r\n}\r\nreturn (offset);\r\n}\r\nstatic int\r\ndissect_PNPTCP_block(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item _U_, gboolean *end, guint16 u16FrameID)\r\n{\r\nguint16 type;\r\nguint16 length;\r\nproto_item *sub_item;\r\nproto_tree *sub_tree;\r\nproto_item *tlvheader_item;\r\nproto_tree *tlvheader_tree;\r\nguint32 u32SubStart;\r\n*end = FALSE;\r\nsub_item = proto_tree_add_item(tree, hf_pn_ptcp_block, tvb, offset, 0, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_pn_ptcp_block);\r\nu32SubStart = offset;\r\ntlvheader_item = proto_tree_add_item(sub_tree, hf_pn_ptcp_block_tlvheader, tvb, offset, 2 , ENC_NA);\r\ntlvheader_tree = proto_item_add_subtree(tlvheader_item, ett_pn_ptcp_block_header);\r\noffset = dissect_PNPTCP_TLVHeader(tvb, offset, pinfo, tlvheader_tree, sub_item, &type, &length);\r\nproto_item_set_text(sub_item, "%s",\r\nval_to_str(type, pn_ptcp_block_type, "Unknown"));\r\nproto_item_append_text(tlvheader_item, ": Type=%s (%x), Length=%u",\r\nval_to_str(type, pn_ptcp_block_type, "Unknown"), type, length);\r\nswitch (type) {\r\ncase 0x00:\r\n*end = TRUE;\r\nbreak;\r\ncase 0x01:\r\ndissect_PNPTCP_Subdomain(tvb, offset, pinfo, sub_tree, sub_item, u16FrameID);\r\nbreak;\r\ncase 0x02:\r\ndissect_PNPTCP_Time(tvb, offset, pinfo, sub_tree, sub_item);\r\nbreak;\r\ncase 0x03:\r\ndissect_PNPTCP_TimeExtension(tvb, offset, pinfo, sub_tree, sub_item);\r\nbreak;\r\ncase 0x04:\r\ndissect_PNPTCP_Master(tvb, offset, pinfo, sub_tree, sub_item);\r\nbreak;\r\ncase 0x05:\r\ndissect_PNPTCP_PortParameter(tvb, offset, pinfo, sub_tree, sub_item);\r\nbreak;\r\ncase 0x06:\r\ndissect_PNPTCP_DelayParameter(tvb, offset, pinfo, sub_tree, sub_item);\r\nbreak;\r\ncase 0x07:\r\ndissect_PNPTCP_PortTime(tvb, offset, pinfo, sub_tree, sub_item);\r\nbreak;\r\ncase 0x7F:\r\ndissect_PNPTCP_Option(tvb, offset, pinfo, sub_tree, sub_item, length);\r\nbreak;\r\ndefault:\r\noffset = dissect_pn_undecoded(tvb, offset, pinfo, tree, length);\r\n}\r\noffset += length;\r\nproto_item_set_len(sub_item, offset - u32SubStart);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_blocks(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 u16FrameID)\r\n{\r\ngboolean end = FALSE;\r\nwhile (!end) {\r\noffset = dissect_PNPTCP_block(tvb, offset, pinfo, tree, item, &end, u16FrameID);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_FollowUpPDU(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 u16FrameID,\r\nconst char *name, const char *name_short)\r\n{\r\nproto_item *header_item;\r\nproto_tree *header_tree;\r\nguint16 seq_id;\r\ngint32 delay1ns_fup;\r\nheader_item = proto_tree_add_item(tree, hf_pn_ptcp_header, tvb, offset, 20 , ENC_NA);\r\nheader_tree = proto_item_add_subtree(header_item, ett_pn_ptcp_header);\r\noffset = dissect_pn_padding(tvb, offset, pinfo, header_tree, 12);\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, header_tree, hf_pn_ptcp_seq_id, &seq_id);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, header_tree);\r\noffset = dissect_pn_int32(tvb, offset, pinfo, header_tree, hf_pn_ptcp_delay1ns_fup, &delay1ns_fup);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq=%3u, Delay=%11dns", name, seq_id, delay1ns_fup);\r\nproto_item_append_text(item, "%s: Sequence=%u, Delay=%dns", name_short, seq_id, delay1ns_fup);\r\nproto_item_append_text(header_item, ": Sequence=%u, Delay=%dns", seq_id, delay1ns_fup);\r\noffset = dissect_PNPTCP_blocks(tvb, offset, pinfo, tree, item, u16FrameID);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_RTSyncPDU(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 u16FrameID,\r\nconst char *name, const char *name_short)\r\n{\r\nproto_item *header_item;\r\nproto_tree *header_tree;\r\nguint32 res_1;\r\nguint32 res_2;\r\nguint32 delay10ns;\r\nguint16 seq_id;\r\nguint8 delay1ns_8;\r\nguint64 delay1ns_64;\r\nguint32 delay1ns_32;\r\nguint32 delayms;\r\nheader_item = proto_tree_add_item(tree, hf_pn_ptcp_header, tvb, offset, 20 , ENC_NA);\r\nheader_tree = proto_item_add_subtree(header_item, ett_pn_ptcp_header);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, header_tree, hf_pn_ptcp_res1, &res_1);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, header_tree, hf_pn_ptcp_res2, &res_2);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, header_tree, hf_pn_ptcp_delay10ns, &delay10ns);\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, header_tree, hf_pn_ptcp_seq_id, &seq_id);\r\noffset = dissect_pn_uint8(tvb, offset, pinfo, header_tree, hf_pn_ptcp_delay1ns_byte, &delay1ns_8);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, header_tree);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, header_tree, hf_pn_ptcp_delay1ns, &delay1ns_32);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, tree);\r\ndelay1ns_64 = ((guint64) delay10ns) * 10 + delay1ns_8 + delay1ns_32;\r\ndelayms = (guint32) (delay1ns_64 / (1000 * 1000));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq=%3u, Delay=%11" G_GINT64_MODIFIER "uns",\r\nname, seq_id, delay1ns_64);\r\nproto_item_append_text(item, "%s: Sequence=%u, Delay=%" G_GINT64_MODIFIER "uns",\r\nname_short, seq_id, delay1ns_64);\r\nproto_item_append_text(header_item, ": Sequence=%u, Delay=%" G_GINT64_MODIFIER "uns",\r\nseq_id, delay1ns_64);\r\nif (delay1ns_64 != 0)\r\nproto_item_append_text(header_item, " (%u.%03u,%03u,%03u sec)",\r\ndelayms / 1000,\r\ndelayms % 1000,\r\n(delay10ns % (1000*100)) / 100,\r\ndelay10ns % 100 * 10 + delay1ns_8);\r\noffset = dissect_PNPTCP_blocks(tvb, offset, pinfo, tree, item, u16FrameID);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_AnnouncePDU(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 u16FrameID,\r\nconst char *name, const char *name_short)\r\n{\r\nproto_item *header_item;\r\nproto_tree *header_tree;\r\nguint16 seq_id;\r\nheader_item = proto_tree_add_item(tree, hf_pn_ptcp_header, tvb, offset, 20 , ENC_NA);\r\nheader_tree = proto_item_add_subtree(header_item, ett_pn_ptcp_header);\r\noffset = dissect_pn_padding(tvb, offset, pinfo, header_tree, 12);\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, header_tree, hf_pn_ptcp_seq_id, &seq_id);\r\noffset = dissect_pn_padding(tvb, offset, pinfo, header_tree, 6);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq=%3u", name, seq_id);\r\nproto_item_append_text(item, "%s: Sequence=%u", name_short, seq_id);\r\nproto_item_append_text(header_item, ": Sequence=%u", seq_id);\r\noffset = dissect_PNPTCP_blocks(tvb, offset, pinfo, tree, item, u16FrameID);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_PNPTCP_DelayPDU(tvbuff_t *tvb, int offset,\r\npacket_info *pinfo, proto_tree *tree, proto_item *item, guint16 u16FrameID,\r\nconst char *name, const char *name_short)\r\n{\r\nproto_item *header_item;\r\nproto_tree *header_tree;\r\nguint16 seq_id;\r\nguint32 delay1ns;\r\nheader_item = proto_tree_add_item(tree, hf_pn_ptcp_header, tvb, offset, 20 , ENC_NA);\r\nheader_tree = proto_item_add_subtree(header_item, ett_pn_ptcp_header);\r\noffset = dissect_pn_padding(tvb, offset, pinfo, header_tree, 12);\r\noffset = dissect_pn_uint16(tvb, offset, pinfo, header_tree, hf_pn_ptcp_seq_id, &seq_id);\r\noffset = dissect_pn_align4(tvb, offset, pinfo, header_tree);\r\noffset = dissect_pn_uint32(tvb, offset, pinfo, header_tree, hf_pn_ptcp_delay1ns, &delay1ns);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, Seq=%3u, Delay=%11uns", name, seq_id, delay1ns);\r\nproto_item_append_text(item, "%s: Sequence=%u, Delay=%uns", name_short, seq_id, delay1ns);\r\nproto_item_append_text(header_item, ": Sequence=%u, Delay=%uns", seq_id, delay1ns);\r\noffset = dissect_PNPTCP_blocks(tvb, offset, pinfo, tree, item, u16FrameID);\r\nreturn offset;\r\n}\r\nstatic gboolean\r\ndissect_PNPTCP_Data_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nguint16 u16FrameID = GPOINTER_TO_UINT(data);\r\nproto_item *item;\r\nproto_tree *ptcp_tree;\r\nint offset = 0;\r\nguint32 u32SubStart;\r\nif ( ((u16FrameID >= 0x0100) && (u16FrameID < 0xFF00)) || (u16FrameID > 0xFF5F) ) {\r\nreturn FALSE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "PN-PTCP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nitem = proto_tree_add_protocol_format(tree, proto_pn_ptcp, tvb, 0, 0, "PROFINET PTCP, ");\r\nptcp_tree = proto_item_add_subtree(item, ett_pn_ptcp);\r\nu32SubStart = offset;\r\nswitch (u16FrameID) {\r\ncase 0x0020:\r\noffset = dissect_PNPTCP_RTSyncPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"RTSync FU (Clock)", "RTSync FU (Clock)");\r\nbreak;\r\ncase 0x0021:\r\noffset = dissect_PNPTCP_RTSyncPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"RTSync FU (Time)", "RTSync FU (Time)");\r\nbreak;\r\ncase 0x0080:\r\noffset = dissect_PNPTCP_RTSyncPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"RTSync (Clock)", "RTSync (Clock)");\r\nbreak;\r\ncase 0x0081:\r\noffset = dissect_PNPTCP_RTSyncPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"RTSync (Time)", "RTSync (Time)");\r\nbreak;\r\ncase 0xff00:\r\noffset = dissect_PNPTCP_AnnouncePDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"Announce (Clock)", "Announce (Clock)");\r\nbreak;\r\ncase 0xff01:\r\noffset = dissect_PNPTCP_AnnouncePDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"Announce (Time)", "Announce (Time)");\r\nbreak;\r\ncase 0xff20:\r\noffset = dissect_PNPTCP_FollowUpPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"FollowUp (Clock)", "FollowUp (Clock)");\r\nbreak;\r\ncase 0xff21:\r\noffset = dissect_PNPTCP_FollowUpPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"FollowUp (Time)", "FollowUp (Time)");\r\nbreak;\r\ncase 0xff40:\r\noffset = dissect_PNPTCP_DelayPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"DelayReq ", "DelayReq");\r\nbreak;\r\ncase 0xff41:\r\noffset = dissect_PNPTCP_DelayPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"DelayRes ", "DelayRes");\r\nbreak;\r\ncase 0xff42:\r\noffset = dissect_PNPTCP_DelayPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"DelayFuRes ", "DelayFuRes");\r\nbreak;\r\ncase 0xff43:\r\noffset = dissect_PNPTCP_DelayPDU(tvb, offset, pinfo, ptcp_tree, item, u16FrameID,\r\n"DelayRes ", "DelayRes");\r\nbreak;\r\ndefault:\r\noffset = dissect_pn_undecoded(tvb, offset, pinfo, tree, tvb_captured_length_remaining(tvb, offset));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Reserved FrameID 0x%04x", u16FrameID);\r\nproto_item_append_text(item, "Reserved FrameID 0x%04x", u16FrameID);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\nbreak;\r\n}\r\nproto_item_set_len(item, offset - u32SubStart);\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_pn_ptcp (void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_pn_ptcp_header,\r\n{ "Header", "pn_ptcp.header",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_block,\r\n{ "Block", "pn_ptcp.block",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_block_tlvheader,\r\n{ "TLVHeader", "pn_ptcp.tlvheader",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_res1,\r\n{ "Reserved 1", "pn_ptcp.res1",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_res2,\r\n{ "Reserved 2", "pn_ptcp.res2",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_delay10ns,\r\n{ "Delay10ns", "pn_ptcp.delay10ns",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_seq_id,\r\n{ "SequenceID", "pn_ptcp.sequence_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_delay1ns_byte,\r\n{ "Delay1ns_Byte", "pn_ptcp.delay1ns_byte",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_delay1ns,\r\n{ "Delay1ns", "pn_ptcp.delay1ns",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_delay1ns_fup,\r\n{ "Delay1ns_FUP", "pn_ptcp.delay1ns_fup",\r\nFT_INT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_tl_length,\r\n{ "TypeLength.Length", "pn_ptcp.tl_length",\r\nFT_UINT16, BASE_DEC, 0x0, 0x1FF,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_tl_type,\r\n{ "TypeLength.Type", "pn_ptcp.tl_type",\r\nFT_UINT16, BASE_DEC, 0x0, 0xFE00,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_master_source_address,\r\n{ "MasterSourceAddress", "pn_ptcp.master_source_address",\r\nFT_ETHER, BASE_NONE, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_subdomain_uuid,\r\n{ "SubdomainUUID", "pn_ptcp.subdomain_uuid",\r\nFT_GUID, BASE_NONE, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_port_mac_address,\r\n{ "PortMACAddress", "pn_ptcp.port_mac_address",\r\nFT_ETHER, BASE_NONE, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_t2portrxdelay,\r\n{ "T2PortRxDelay (ns)", "pn_ptcp.t2portrxdelay",\r\nFT_UINT32, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_t3porttxdelay,\r\n{ "T3PortTxDelay (ns)", "pn_ptcp.t3porttxdelay",\r\nFT_UINT32, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_t2timestamp,\r\n{ "T2TimeStamp (ns)", "pn_ptcp.t2timestamp",\r\nFT_UINT32, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_epoch_number,\r\n{ "EpochNumber", "pn_ptcp.epoch_number",\r\nFT_UINT16, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_seconds,\r\n{ "Seconds", "pn_ptcp.seconds",\r\nFT_UINT32, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_nanoseconds,\r\n{ "NanoSeconds", "pn_ptcp.nanoseconds",\r\nFT_UINT32, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_flags,\r\n{ "Flags", "pn_ptcp.flags",\r\nFT_UINT16, BASE_HEX, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_currentutcoffset,\r\n{ "CurrentUTCOffset", "pn_ptcp.currentutcoffset",\r\nFT_UINT16, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_master_priority1,\r\n{ "MasterPriority1.Priority", "pn_ptcp.master_priority1_prio",\r\nFT_UINT8, BASE_HEX, VALS(pn_ptcp_master_prio1_vals), 0x07,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_master_priority_level,\r\n{ "MasterPriority1.Level", "pn_ptcp.master_priority1_level",\r\nFT_UINT8, BASE_HEX, VALS(pn_ptcp_master_prio1_levels), 0x38,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_master_priority1_res,\r\n{ "MasterPriority1.Reserved", "pn_ptcp.master_priority1_res",\r\nFT_UINT8, BASE_HEX, 0x0, 0x40,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_master_priority1_act,\r\n{ "MasterPriority1.Active", "pn_ptcp.master_priority1_act",\r\nFT_UINT8, BASE_HEX, VALS(pn_ptcp_master_prio1_vals_active), 0x80,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_master_priority2,\r\n{ "MasterPriority2", "pn_ptcp.master_priority2",\r\nFT_UINT8, BASE_DEC, VALS(pn_ptcp_master_prio2_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_clock_class,\r\n{ "ClockClass", "pn_ptcp.clock_class",\r\nFT_UINT8, BASE_DEC, VALS(pn_ptcp_clock_class_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_clock_accuracy,\r\n{ "ClockAccuracy", "pn_ptcp.clock_accuracy",\r\nFT_UINT8, BASE_DEC, VALS(pn_ptcp_clock_accuracy_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_clockvariance,\r\n{ "ClockVariance", "pn_ptcp.clockvariance",\r\nFT_INT16, BASE_DEC, 0x0, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_oui,\r\n{ "Organizationally Unique Identifier", "pn_ptcp.oui",\r\nFT_UINT24, BASE_HEX, VALS(pn_ptcp_oui_vals), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_pn_ptcp_profinet_subtype,\r\n{ "Subtype", "pn_ptcp.subtype",\r\nFT_UINT8, BASE_HEX, VALS(pn_ptcp_profinet_subtype_vals), 0x0,\r\n"PROFINET Subtype", HFILL }},\r\n{ &hf_pn_ptcp_irdata_uuid,\r\n{ "IRDataUUID", "pn_ptcp.irdata_uuid",\r\nFT_GUID, BASE_NONE, 0x0, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_pn_ptcp,\r\n&ett_pn_ptcp_header,\r\n&ett_pn_ptcp_block,\r\n&ett_pn_ptcp_block_header\r\n};\r\nproto_pn_ptcp = proto_register_protocol ("PROFINET PTCP", "PN-PTCP", "pn_ptcp");\r\nproto_register_field_array (proto_pn_ptcp, hf, array_length (hf));\r\nproto_register_subtree_array (ett, array_length (ett));\r\n}\r\nvoid\r\nproto_reg_handoff_pn_ptcp (void)\r\n{\r\nheur_dissector_add("pn_rt", dissect_PNPTCP_Data_heur, "PROFINET PTCP IO", "pn_ptcp_pn_rt", proto_pn_ptcp, HEURISTIC_ENABLE);\r\n}

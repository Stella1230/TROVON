static void\r\ndissect_q932_facility_ie(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree, int length) {\r\ngint8 appclass;\r\ngboolean pc;\r\ngint32 tag;\r\nguint32 len;\r\nint hoffset, eoffset;\r\nint ie_end;\r\ntvbuff_t *next_tvb;\r\nie_end = offset + length;\r\nproto_tree_add_item(tree, hf_q932_pp, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwhile (offset < ie_end) {\r\nhoffset = offset;\r\noffset = get_ber_identifier(tvb, offset, &appclass, &pc, &tag);\r\noffset = get_ber_length(tvb, offset, &len, NULL);\r\neoffset = offset + len;\r\nnext_tvb = tvb_new_subset_length(tvb, hoffset, eoffset - hoffset);\r\nswitch (appclass) {\r\ncase BER_CLASS_CON:\r\nswitch (tag) {\r\ncase 10 :\r\ndissect_NetworkFacilityExtension_PDU(next_tvb, pinfo, tree, NULL);\r\nbreak;\r\ncase 18 :\r\ndissect_NetworkProtocolProfile_PDU(next_tvb, pinfo, tree, NULL);\r\nbreak;\r\ncase 11 :\r\ndissect_InterpretationComponent_PDU(next_tvb, pinfo, tree, NULL);\r\nbreak;\r\ncase 1 :\r\ncase 2 :\r\ncase 3 :\r\ncase 4 :\r\nq932_rose_ctx.apdu_depth = 1;\r\ncall_dissector_with_data(q932_ros_handle, next_tvb, pinfo, tree, &q932_rose_ctx);\r\nbreak;\r\ncase 12 :\r\ncase 14 :\r\ncase 15 :\r\ncase 17 :\r\noffset = dissect_ber_identifier(pinfo, tree, tvb, hoffset, NULL, NULL, NULL);\r\noffset = dissect_ber_length(pinfo, tree, tvb, offset, NULL, NULL);\r\nproto_tree_add_expert(tree, pinfo, &ei_q932_dse_not_supported, tvb, offset, len);\r\nbreak;\r\ndefault:\r\noffset = dissect_ber_identifier(pinfo, tree, tvb, hoffset, NULL, NULL, NULL);\r\noffset = dissect_ber_length(pinfo, tree, tvb, offset, NULL, NULL);\r\nproto_tree_add_expert(tree, pinfo, &ei_q932_unknown_component, tvb, offset, len);\r\n}\r\nbreak;\r\ncase BER_CLASS_APP:\r\nswitch (tag) {\r\ncase 0 :\r\ncase 1 :\r\ncase 2 :\r\ncase 3 :\r\ncase 4 :\r\noffset = dissect_ber_identifier(pinfo, tree, tvb, hoffset, NULL, NULL, NULL);\r\noffset = dissect_ber_length(pinfo, tree, tvb, offset, NULL, NULL);\r\nproto_tree_add_expert(tree, pinfo, &ei_q932_acse_not_supported, tvb, offset, len);\r\nbreak;\r\ndefault:\r\noffset = dissect_ber_identifier(pinfo, tree, tvb, hoffset, NULL, NULL, NULL);\r\noffset = dissect_ber_length(pinfo, tree, tvb, offset, NULL, NULL);\r\nproto_tree_add_expert(tree, pinfo, &ei_q932_unknown_component, tvb, offset, len);\r\n}\r\nbreak;\r\ndefault:\r\noffset = dissect_ber_identifier(pinfo, tree, tvb, hoffset, NULL, NULL, NULL);\r\noffset = dissect_ber_length(pinfo, tree, tvb, offset, NULL, NULL);\r\nproto_tree_add_expert(tree, pinfo, &ei_q932_unknown_component, tvb, offset, len);\r\n}\r\noffset = eoffset;\r\n}\r\n}\r\nstatic void\r\ndissect_q932_ni_ie(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree, int length) {\r\nint remain = length;\r\nguint8 octet = 0;\r\nguint32 value = 0;\r\nproto_item* ti;\r\nwhile ((remain > 0) && !(octet & 0x80)) {\r\noctet = tvb_get_guint8(tvb, offset++);\r\nremain--;\r\nvalue <<= 7;\r\nvalue |= octet & 0x7F;\r\n}\r\nti = proto_tree_add_uint(tree, hf_q932_nd, tvb, offset - (length - remain), length - remain, value);\r\nif (remain > 0) {\r\nexpert_add_info(pinfo, ti, &ei_q932_asn1_encoded);\r\n}\r\n}\r\nstatic int\r\ndissect_q932_ie(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\ngint offset;\r\nproto_item *ti;\r\nproto_tree *ie_tree;\r\nguint8 ie_type, ie_len;\r\noffset = 0;\r\nti = proto_tree_add_item(tree, proto_q932, tvb, offset, -1, ENC_NA);\r\nPROTO_ITEM_SET_HIDDEN(ti);\r\nie_type = tvb_get_guint8(tvb, offset);\r\nie_len = tvb_get_guint8(tvb, offset + 1);\r\nie_tree = proto_tree_add_subtree(tree, tvb, offset, -1, ett_q932_ie, NULL,\r\nval_to_str(ie_type, VALS(q932_str_ie_type), "unknown (0x%02X)"));\r\nproto_tree_add_item(ie_tree, hf_q932_ie_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ie_tree, hf_q932_ie_len, tvb, offset + 1, 1, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (tvb_reported_length_remaining(tvb, offset) <= 0)\r\nreturn offset;\r\nswitch (ie_type) {\r\ncase Q932_IE_FACILITY :\r\ndissect_q932_facility_ie(tvb, offset, pinfo, ie_tree, ie_len);\r\nbreak;\r\ncase Q932_IE_NOTIFICATION_INDICATOR :\r\ndissect_q932_ni_ie(tvb, offset, pinfo, ie_tree, ie_len);\r\nbreak;\r\ndefault:\r\nif (ie_len > 0) {\r\nproto_tree_add_item(ie_tree, hf_q932_ie_data, tvb, offset, ie_len, ENC_NA);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_q932_apdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\nreturn call_dissector(q932_ros_handle, tvb, pinfo, tree);\r\n}\r\nvoid proto_register_q932(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_q932_ie_type, { "Type", "q932.ie.type",\r\nFT_UINT8, BASE_HEX, VALS(q932_str_ie_type), 0x0,\r\n"Information Element Type", HFILL }},\r\n{ &hf_q932_ie_len, { "Length", "q932.ie.len",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Information Element Length", HFILL }},\r\n{ &hf_q932_ie_data, { "Data", "q932.ie.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_q932_pp, { "Protocol profile", "q932.pp",\r\nFT_UINT8, BASE_HEX, VALS(str_pp), 0x1F,\r\nNULL, HFILL }},\r\n{ &hf_q932_nd, { "Notification description", "q932.nd",\r\nFT_UINT8, BASE_HEX, VALS(str_nd), 0x0,\r\nNULL, HFILL }},\r\n#include "packet-q932-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n&ett_q932,\r\n&ett_q932_ie,\r\n#include "packet-q932-ettarr.c"\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_q932_dse_not_supported, { "q932.dse_not_supported", PI_UNDECODED, PI_WARN, "DSE APDU (not supported)", EXPFILL }},\r\n{ &ei_q932_acse_not_supported, { "q932.acse_not_supported", PI_UNDECODED, PI_WARN, "ACSE APDU (not supported)", EXPFILL }},\r\n{ &ei_q932_unknown_component, { "q932.unknown_component", PI_UNDECODED, PI_WARN, "Unknown Component", EXPFILL }},\r\n{ &ei_q932_asn1_encoded, { "q932.asn1_encoded", PI_UNDECODED, PI_WARN, "ASN.1 Encoded Data Structure(NOT IMPLEMENTED)", EXPFILL }},\r\n};\r\nmodule_t *q932_module;\r\nexpert_module_t* expert_q932;\r\nstatic const enum_val_t facility_encoding[] = {\r\n{"Facility as QSIG", "Dissect facility as QSIG", FACILITY_QSIG},\r\n{"Facility as ETSI", "Dissect facility as ETSI", FACILITY_ETSI},\r\n{NULL, NULL, -1}\r\n};\r\nproto_q932 = proto_register_protocol(PNAME, PSNAME, PFNAME);\r\nregister_dissector("q932.apdu", dissect_q932_apdu, proto_q932);\r\nproto_register_field_array(proto_q932, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_q932 = expert_register_protocol(proto_q932);\r\nexpert_register_field_array(expert_q932, ei, array_length(ei));\r\nrose_ctx_init(&q932_rose_ctx);\r\nq932_rose_ctx.arg_global_dissector_table = register_dissector_table("q932.ros.global.arg", "Q.932 Operation Argument (global opcode)", proto_q932, FT_STRING, BASE_NONE);\r\nq932_rose_ctx.res_global_dissector_table = register_dissector_table("q932.ros.global.res", "Q.932 Operation Result (global opcode)", proto_q932, FT_STRING, BASE_NONE);\r\nq932_rose_ctx.err_global_dissector_table = register_dissector_table("q932.ros.global.err", "Q.932 Error (global opcode)", proto_q932, FT_STRING, BASE_NONE);\r\nqsig_arg_local_dissector_table = register_dissector_table("q932.ros.local.arg", "Q.932 Operation Argument (local opcode)", proto_q932, FT_UINT32, BASE_HEX);\r\nqsig_res_local_dissector_table = register_dissector_table("q932.ros.local.res", "Q.932 Operation Result (local opcode)", proto_q932, FT_UINT32, BASE_HEX);\r\nqsig_err_local_dissector_table = register_dissector_table("q932.ros.local.err", "Q.932 Error (local opcode)", proto_q932, FT_UINT32, BASE_HEX);\r\netsi_arg_local_dissector_table = register_dissector_table("q932.ros.etsi.local.arg", "Q.932 ETSI Operation Argument (local opcode)", proto_q932, FT_UINT32, BASE_HEX);\r\netsi_res_local_dissector_table = register_dissector_table("q932.ros.etsi.local.res", "Q.932 ETSI Operation Result (local opcode)", proto_q932, FT_UINT32, BASE_HEX);\r\netsi_err_local_dissector_table = register_dissector_table("q932.ros.etsi.local.err", "Q.932 ETSI Error (local opcode)", proto_q932, FT_UINT32, BASE_HEX);\r\nq932_module = prefs_register_protocol(proto_q932, proto_reg_handoff_q932);\r\nprefs_register_enum_preference(q932_module, "facility_encoding",\r\n"Type of Facility encoding",\r\n"Type of Facility encoding",\r\n&g_facility_encoding, facility_encoding, FALSE);\r\n}\r\nvoid proto_reg_handoff_q932(void) {\r\ndissector_handle_t q932_ie_handle;\r\nstatic gboolean q931_prefs_initialized = FALSE;\r\nif (!q931_prefs_initialized) {\r\nq932_ie_handle = create_dissector_handle(dissect_q932_ie, proto_q932);\r\ndissector_add_uint("q931.ie", (0x00 << 8) | Q932_IE_FACILITY, q932_ie_handle);\r\ndissector_add_uint("q931.ie", (0x00 << 8) | Q932_IE_NOTIFICATION_INDICATOR, q932_ie_handle);\r\nq932_ros_handle = find_dissector_add_dependency("q932.ros", proto_q932);\r\n}\r\nif(g_facility_encoding == FACILITY_QSIG){\r\nq932_rose_ctx.arg_local_dissector_table = qsig_arg_local_dissector_table;\r\nq932_rose_ctx.res_local_dissector_table = qsig_res_local_dissector_table;\r\nq932_rose_ctx.err_local_dissector_table = qsig_err_local_dissector_table;\r\n}else{\r\nq932_rose_ctx.arg_local_dissector_table = etsi_arg_local_dissector_table;\r\nq932_rose_ctx.res_local_dissector_table = etsi_res_local_dissector_table;\r\nq932_rose_ctx.err_local_dissector_table = etsi_err_local_dissector_table;\r\n}\r\n}

progdlg_t *\r\ncreate_progress_dlg(gpointer top_level_window _U_, const gchar *task_title, const gchar *item_title,\r\ngboolean terminate_is_stop, gboolean *stop_flag)\r\n{\r\nprogdlg_t *dlg;\r\nGtkWidget *dlg_w, *main_vb, *title_lb, *status_lb, *elapsed_lb, *time_left_lb, *percentage_lb;\r\nGtkWidget *prog_bar, *bbox, *cancel_bt;\r\nGtkWidget *static_vb, *tmp_lb, *main_hb, *dynamic_vb, *percentage_hb;\r\ngchar *task_title_dup;\r\ngchar *item_title_dup;\r\ndlg = (progdlg_t *)g_malloc(sizeof (progdlg_t));\r\nitem_title_dup = g_strdup(item_title);\r\nif (strlen(item_title_dup) > 110) {\r\ng_strlcpy(&item_title_dup[100], "...", 4);\r\n}\r\ndlg->title = g_strdup_printf("%s: %s", task_title, item_title_dup);\r\ndlg_w = dlg_window_new(dlg->title);\r\ngtk_window_set_modal(GTK_WINDOW(dlg_w), TRUE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(dlg_w), main_vb);\r\nstatic_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ntask_title_dup = g_strdup_printf ("%s:", task_title);\r\ntmp_lb = gtk_label_new(task_title_dup);\r\ngtk_misc_set_alignment(GTK_MISC(tmp_lb), 1.0f, 0.0f);\r\ngtk_box_pack_start(GTK_BOX(static_vb), tmp_lb, FALSE, TRUE, 3);\r\ntmp_lb = gtk_label_new("Status:");\r\ngtk_misc_set_alignment(GTK_MISC(tmp_lb), 1.0f, 0.0f);\r\ngtk_box_pack_start(GTK_BOX(static_vb), tmp_lb, FALSE, TRUE, 3);\r\ntmp_lb = gtk_label_new("Elapsed Time:");\r\ngtk_misc_set_alignment(GTK_MISC(tmp_lb), 1.0f, 0.0f);\r\ngtk_box_pack_start(GTK_BOX(static_vb), tmp_lb, FALSE, TRUE, 3);\r\ntmp_lb = gtk_label_new("Time Left:");\r\ngtk_misc_set_alignment(GTK_MISC(tmp_lb), 1.0f, 0.0f);\r\ngtk_box_pack_start(GTK_BOX(static_vb), tmp_lb, FALSE, TRUE, 3);\r\ntmp_lb = gtk_label_new("Progress:");\r\ngtk_misc_set_alignment(GTK_MISC(tmp_lb), 1.0f, 0.0f);\r\ngtk_box_pack_start(GTK_BOX(static_vb), tmp_lb, FALSE, TRUE, 3);\r\ndynamic_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ntitle_lb = gtk_label_new(item_title_dup);\r\ngtk_box_pack_start(GTK_BOX(dynamic_vb), title_lb, FALSE, TRUE, 3);\r\ngtk_misc_set_alignment(GTK_MISC(title_lb), 0.0f, 0.0f);\r\ngtk_misc_set_padding(GTK_MISC(title_lb), 0, 0);\r\nstatus_lb = gtk_label_new("");\r\ngtk_box_pack_start(GTK_BOX(dynamic_vb), status_lb, FALSE, TRUE, 3);\r\ngtk_misc_set_alignment(GTK_MISC(status_lb), 0.0f, 0.0f);\r\ngtk_misc_set_padding(GTK_MISC(status_lb), 0, 0);\r\ndlg->status_lb = (GtkLabel *) status_lb;\r\nelapsed_lb = gtk_label_new("00:00");\r\ngtk_box_pack_start(GTK_BOX(dynamic_vb), elapsed_lb, FALSE, TRUE, 3);\r\ngtk_misc_set_alignment(GTK_MISC(elapsed_lb), 0.0f, 0.0f);\r\ngtk_misc_set_padding(GTK_MISC(elapsed_lb), 0, 0);\r\ndlg->elapsed_lb = (GtkLabel *) elapsed_lb;\r\ntime_left_lb = gtk_label_new("--:--");\r\ngtk_box_pack_start(GTK_BOX(dynamic_vb), time_left_lb, FALSE, TRUE, 3);\r\ngtk_misc_set_alignment(GTK_MISC(time_left_lb), 0.0f, 0.0f);\r\ngtk_misc_set_padding(GTK_MISC(time_left_lb), 0, 0);\r\ndlg->time_left_lb = (GtkLabel *) time_left_lb;\r\npercentage_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 1, FALSE);\r\ngtk_box_pack_start(GTK_BOX(dynamic_vb), percentage_hb, FALSE, TRUE, 3);\r\nprog_bar = gtk_progress_bar_new();\r\ngtk_box_pack_start(GTK_BOX(percentage_hb), prog_bar, FALSE, TRUE, 3);\r\npercentage_lb = gtk_label_new(" 0%");\r\ngtk_misc_set_alignment(GTK_MISC(percentage_lb), 0.0f, 0.0f);\r\ngtk_box_pack_start(GTK_BOX(percentage_hb), percentage_lb, FALSE, TRUE, 3);\r\ndlg->percentage_lb = (GtkLabel *) percentage_lb;\r\ng_object_set_data(G_OBJECT(dlg_w), PROG_BAR_KEY, prog_bar);\r\nmain_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 1, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_hb), static_vb, FALSE, TRUE, 3);\r\ngtk_box_pack_start(GTK_BOX(main_hb), dynamic_vb, FALSE, TRUE, 3);\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_hb, FALSE, TRUE, 3);\r\nbbox = dlg_button_row_new(terminate_is_stop ? GTK_STOCK_STOP :\r\nGTK_STOCK_CANCEL, NULL);\r\ngtk_container_add(GTK_CONTAINER(main_vb), bbox);\r\ngtk_widget_show(bbox);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), terminate_is_stop ? GTK_STOCK_STOP :\r\nGTK_STOCK_CANCEL);\r\ngtk_widget_grab_default(cancel_bt);\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(stop_cb), stop_flag);\r\ng_signal_connect(dlg_w, "delete_event", G_CALLBACK(delete_event_cb), stop_flag);\r\ngtk_widget_show_all(dlg_w);\r\ndlg->dlg_w = dlg_w;\r\ng_get_current_time(&dlg->start_time);\r\nmemset(&dlg->last_time, 0, sizeof(dlg->last_time));\r\ng_free(task_title_dup);\r\ng_free(item_title_dup);\r\nreturn dlg;\r\n}\r\nprogdlg_t *\r\ndelayed_create_progress_dlg(gpointer top_level_window, const gchar *task_title,\r\nconst gchar *item_title, gboolean terminate_is_stop,\r\ngboolean *stop_flag, const GTimeVal *start_time, gfloat progress)\r\n{\r\nGTimeVal time_now;\r\ngdouble delta_time;\r\ngdouble min_display;\r\nprogdlg_t *dlg;\r\n#define INIT_DELAY 0.1 * 1e6\r\n#define MIN_DISPLAY_DEFAULT 2.0 * 1e6\r\ng_get_current_time(&time_now);\r\ndelta_time = (time_now.tv_sec - start_time->tv_sec) * 1e6 +\r\ntime_now.tv_usec - start_time->tv_usec;\r\nif (delta_time < INIT_DELAY)\r\nreturn NULL;\r\nif (delta_time <= INIT_DELAY + MIN_DISPLAY_DEFAULT)\r\nmin_display = MIN_DISPLAY_DEFAULT;\r\nelse\r\nmin_display = 2 * MIN_DISPLAY_DEFAULT - delta_time;\r\nif (progress >= (delta_time / (delta_time + min_display)))\r\nreturn NULL;\r\ndlg = create_progress_dlg(top_level_window, task_title, item_title, terminate_is_stop,\r\nstop_flag);\r\nwhile (gtk_events_pending())\r\ngtk_main_iteration();\r\ndlg->start_time = *start_time;\r\nreturn dlg;\r\n}\r\nstatic gboolean\r\ndelete_event_cb(GtkWidget *w _U_, GdkEvent *event _U_, gpointer data)\r\n{\r\ngboolean *stop_flag = (gboolean *) data;\r\n*stop_flag = TRUE;\r\nreturn TRUE;\r\n}\r\nstatic void\r\nstop_cb(GtkWidget *w _U_, gpointer data)\r\n{\r\ngboolean *stop_flag = (gboolean *) data;\r\n*stop_flag = TRUE;\r\n}\r\nvoid\r\nupdate_progress_dlg(progdlg_t *dlg, gfloat percentage, const gchar *status)\r\n{\r\nGtkWidget *dlg_w = dlg->dlg_w;\r\nGtkWidget *prog_bar;\r\nGTimeVal time_now;\r\ngdouble delta_time;\r\ngulong ul_left;\r\ngulong ul_elapsed;\r\ngulong ul_percentage;\r\ngchar tmp[100];\r\ng_get_current_time(&time_now);\r\ndelta_time = (time_now.tv_sec - dlg->last_time.tv_sec) * 1e6 +\r\ntime_now.tv_usec - dlg->last_time.tv_usec;\r\nif (dlg->last_time.tv_sec && delta_time < 100*1000)\r\nreturn;\r\ndlg->last_time = time_now;\r\ndelta_time = (time_now.tv_sec - dlg->start_time.tv_sec) * 1e6 +\r\ntime_now.tv_usec - dlg->start_time.tv_usec;\r\nul_percentage = (gulong) (percentage * 100);\r\nul_elapsed = (gulong) (delta_time / 1000 / 1000);\r\ng_snprintf(tmp, sizeof(tmp), "%lu%% of %s", ul_percentage, dlg->title);\r\ngtk_window_set_title(GTK_WINDOW(dlg_w), tmp);\r\ngtk_label_set_text(dlg->status_lb, status);\r\ng_snprintf(tmp, sizeof(tmp), "%lu%%", ul_percentage);\r\ngtk_label_set_text(dlg->percentage_lb, tmp);\r\ng_snprintf(tmp, sizeof(tmp), "%02lu:%02lu", ul_elapsed / 60,\r\nul_elapsed % 60);\r\ngtk_label_set_text(dlg->elapsed_lb, tmp);\r\nif (ul_percentage >= 5 && delta_time >= 3 * 1e6) {\r\nul_left = (gulong) ((delta_time / percentage - delta_time) / 1000 / 1000);\r\ng_snprintf(tmp, sizeof(tmp), "%02lu:%02lu", ul_left / 60,\r\nul_left % 60);\r\ngtk_label_set_text(dlg->time_left_lb, tmp);\r\n}\r\nprog_bar = (GtkWidget *)g_object_get_data(G_OBJECT(dlg_w), PROG_BAR_KEY);\r\ngtk_progress_bar_set_fraction(GTK_PROGRESS_BAR(prog_bar), percentage);\r\nwhile (gtk_events_pending())\r\ngtk_main_iteration();\r\n}\r\nvoid\r\ndestroy_progress_dlg(progdlg_t *dlg)\r\n{\r\nGtkWidget *dlg_w = dlg->dlg_w;\r\nwindow_destroy(GTK_WIDGET(dlg_w));\r\ng_free(dlg->title);\r\ng_free(dlg);\r\n}

static char *\r\ndcerpcstat_gen_title(dcerpcstat_t *rs)\r\n{\r\nchar *title;\r\nchar *display_name;\r\ndisplay_name = cf_get_display_name(&cfile);\r\ntitle = g_strdup_printf("DCE-RPC Service Response Time statistics for %s major version %u: %s", rs->prog, rs->ver, display_name);\r\ng_free(display_name);\r\nreturn title;\r\n}\r\nstatic void\r\ndcerpcstat_set_title(dcerpcstat_t *rs)\r\n{\r\nchar *title;\r\ntitle = dcerpcstat_gen_title(rs);\r\ngtk_window_set_title(GTK_WINDOW(rs->gtk_data.win), title);\r\ng_free(title);\r\n}\r\nstatic void\r\ndcerpcstat_reset(void *rs_arg)\r\n{\r\nsrt_data_t *srt = (srt_data_t*)rs_arg;\r\ndcerpcstat_t *rs = (dcerpcstat_t *)srt->user_data;\r\nreset_srt_table(rs->data.srt_array, reset_table_data, &rs->gtk_data);\r\ndcerpcstat_set_title(rs);\r\n}\r\nstatic void\r\ndcerpcstat_draw(void *rs_arg)\r\n{\r\nguint i = 0;\r\nsrt_stat_table *srt_table;\r\nsrt_data_t *srt = (srt_data_t*)rs_arg;\r\ndcerpcstat_t *rs = (dcerpcstat_t *)srt->user_data;\r\nfor (i = 0; i < srt->srt_array->len; i++)\r\n{\r\nsrt_table = g_array_index(srt->srt_array, srt_stat_table*, i);\r\ndraw_srt_table_data(srt_table, &rs->gtk_data);\r\n}\r\n}\r\nstatic void\r\nwin_destroy_cb(GtkWindow *win _U_, gpointer data)\r\n{\r\ndcerpcstat_t *rs = (dcerpcstat_t *)data;\r\nremove_tap_listener(&rs->data);\r\nfree_srt_table(rs->srt, rs->data.srt_array, free_table_data, &rs->gtk_data);\r\ng_free(rs);\r\n}\r\nstatic void\r\ngtk_dcerpcstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\ndcerpcstat_t *rs;\r\nguint32 i, max_procs;\r\nchar *title_string;\r\nchar *filter_string;\r\nGtkWidget *stat_label;\r\nGtkWidget *filter_label;\r\nGtkWidget *bbox;\r\nGtkWidget *close_bt;\r\ndcerpc_sub_dissector *procs;\r\ne_guid_t uuid;\r\nguint d1,d2,d3,d40,d41,d42,d43,d44,d45,d46,d47;\r\nint major, minor;\r\nguint16 ver;\r\nint pos = 0;\r\nconst char *filter = NULL;\r\ndcerpcstat_tap_data_t* tap_data;\r\nGString *error_string;\r\nif(sscanf(\r\nopt_arg,\r\n"dcerpc,srt,%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x,%d.%d,%n",\r\n&d1,&d2,&d3,&d40,&d41,&d42,&d43,&d44,&d45,&d46,&d47,&major,&minor,&pos)\r\n== 13) {\r\nuuid.data1 = d1;\r\nuuid.data2 = d2;\r\nuuid.data3 = d3;\r\nuuid.data4[0] = d40;\r\nuuid.data4[1] = d41;\r\nuuid.data4[2] = d42;\r\nuuid.data4[3] = d43;\r\nuuid.data4[4] = d44;\r\nuuid.data4[5] = d45;\r\nuuid.data4[6] = d46;\r\nuuid.data4[7] = d47;\r\nif(pos) {\r\nfilter = opt_arg+pos;\r\n} else {\r\nfilter = NULL;\r\n}\r\n} else {\r\nfprintf(stderr, "wireshark: invalid \"-z dcerpc,srt,<uuid>,<major version>.<minor version>[,<filter>]\" argument\n");\r\nexit(1);\r\n}\r\nif ((major < 0) || (major > 65535)) {\r\nfprintf(stderr,"wireshark: dcerpcstat_init() Major version number %d is invalid - must be positive and <= 65535\n", major);\r\nexit(1);\r\n}\r\nif ((minor < 0) || (minor > 65535)) {\r\nfprintf(stderr,"wireshark: dcerpcstat_init() Minor version number %d is invalid - must be positive and <= 65535\n", minor);\r\nexit(1);\r\n}\r\nver = major;\r\nrs = (dcerpcstat_t *)g_malloc0(sizeof(dcerpcstat_t));\r\nrs->prog = dcerpc_get_proto_name(&uuid, ver);\r\nif(!rs->prog){\r\ng_free(rs);\r\nfprintf(stderr,\r\n"wireshark: dcerpcstat_init() Protocol with uuid:%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x v%u not supported\n",\r\nuuid.data1,uuid.data2,uuid.data3,uuid.data4[0],uuid.data4[1],uuid.data4[2],uuid.data4[3],uuid.data4[4],uuid.data4[5],uuid.data4[6],uuid.data4[7],ver);\r\nexit(1);\r\n}\r\nprocs = dcerpc_get_proto_sub_dissector(&uuid, ver);\r\nrs->ver = ver;\r\nrs->gtk_data.win = dlg_window_new("dcerpc-stat");\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(rs->gtk_data.win), TRUE);\r\ndcerpcstat_set_title(rs);\r\ngtk_window_set_default_size(GTK_WINDOW(rs->gtk_data.win), SRT_PREFERRED_WIDTH, SRT_PREFERRED_HEIGHT);\r\nrs->gtk_data.vbox =ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(rs->gtk_data.win), rs->gtk_data.vbox);\r\ngtk_container_set_border_width(GTK_CONTAINER(rs->gtk_data.vbox), 12);\r\ntitle_string = dcerpcstat_gen_title(rs);\r\nstat_label = gtk_label_new(title_string);\r\ng_free(title_string);\r\ngtk_box_pack_start(GTK_BOX(rs->gtk_data.vbox), stat_label, FALSE, FALSE, 0);\r\nfilter_string = g_strdup_printf("Filter: %s",filter ? filter : "");\r\nfilter_label = gtk_label_new(filter_string);\r\ng_free(filter_string);\r\ngtk_label_set_line_wrap(GTK_LABEL(filter_label), TRUE);\r\ngtk_box_pack_start(GTK_BOX(rs->gtk_data.vbox), filter_label, FALSE, FALSE, 0);\r\ngtk_widget_show_all(rs->gtk_data.win);\r\nrs->srt = get_srt_table_by_name("dcerpc");\r\nfor(i=0,max_procs=0;procs[i].name;i++){\r\nif(procs[i].num>max_procs){\r\nmax_procs = procs[i].num;\r\n}\r\n}\r\ntap_data = g_new0(dcerpcstat_tap_data_t, 1);\r\ntap_data->uuid = uuid;\r\ntap_data->prog = dcerpc_get_proto_name(&tap_data->uuid, ver);\r\ntap_data->ver = ver;\r\ntap_data->num_procedures = max_procs+1;\r\nset_srt_table_param_data(rs->srt, tap_data);\r\nrs->gtk_data.gtk_srt_array = g_array_new(FALSE, TRUE, sizeof(gtk_srt_table_t*));\r\nrs->data.srt_array = g_array_new(FALSE, TRUE, sizeof(srt_stat_table*));\r\nrs->data.user_data = rs;\r\nsrt_table_dissector_init(rs->srt, rs->data.srt_array, init_gtk_srt_table, &rs->gtk_data);\r\nerror_string = register_tap_listener("dcerpc", &rs->data, filter, 0, dcerpcstat_reset, get_srt_packet_func(rs->srt), dcerpcstat_draw);\r\nif(error_string){\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", error_string->str);\r\ng_string_free(error_string, TRUE);\r\nfree_srt_table(rs->srt, rs->data.srt_array, NULL, NULL);\r\ng_free(rs);\r\nreturn;\r\n}\r\nbbox = dlg_button_row_new(GTK_STOCK_CLOSE, NULL);\r\ngtk_box_pack_end(GTK_BOX(rs->gtk_data.vbox), bbox, FALSE, FALSE, 0);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(rs->gtk_data.win, close_bt, window_cancel_button_cb);\r\ng_signal_connect(rs->gtk_data.win, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(rs->gtk_data.win, "destroy", G_CALLBACK(win_destroy_cb), rs);\r\ngtk_widget_show_all(rs->gtk_data.win);\r\nwindow_present(rs->gtk_data.win);\r\ncf_retap_packets(&cfile);\r\ngdk_window_raise(gtk_widget_get_window(rs->gtk_data.win));\r\n}\r\nstatic void\r\ndcerpcstat_start_button_clicked(GtkWidget *item _U_, gpointer data _U_)\r\n{\r\nGString *str;\r\nconst char *filter;\r\nif (dcerpc_uuid_program == NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "Please select a program");\r\nreturn;\r\n}\r\nstr = g_string_new("dcerpc,srt");\r\ng_string_append_printf(str,\r\n",%08x-%04x-%04x-%02x%02x-%02x%02x%02x%02x%02x%02x,%u.%u",\r\ndcerpc_uuid_program->data1, dcerpc_uuid_program->data2,\r\ndcerpc_uuid_program->data3,\r\ndcerpc_uuid_program->data4[0], dcerpc_uuid_program->data4[1],\r\ndcerpc_uuid_program->data4[2], dcerpc_uuid_program->data4[3],\r\ndcerpc_uuid_program->data4[4], dcerpc_uuid_program->data4[5],\r\ndcerpc_uuid_program->data4[6], dcerpc_uuid_program->data4[7],\r\ndcerpc_version, 0);\r\nfilter = gtk_entry_get_text(GTK_ENTRY(filter_entry));\r\nif(filter[0] != 0){\r\ng_string_append_printf(str, ",%s", filter);\r\n}\r\ngtk_dcerpcstat_init(str->str,NULL);\r\ng_string_free(str, TRUE);\r\n}\r\nstatic void\r\ndcerpcstat_version_select(GtkWidget *vers_combo_box, gpointer user_data _U_)\r\n{\r\nguid_key *k;\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(vers_combo_box), (gpointer *)&k)) {\r\ng_assert_not_reached();\r\n}\r\ndcerpc_version = k->ver;\r\n}\r\nstatic void\r\ndcerpcstat_find_vers(gpointer *key, gpointer *value _U_, gpointer user_data)\r\n{\r\nguid_key *k = (guid_key *)key;\r\nGtkWidget *vers_combo_box = (GtkWidget *)user_data;\r\nchar vs[5];\r\nif(guid_cmp(&(k->guid), dcerpc_uuid_program)){\r\nreturn;\r\n}\r\ng_snprintf(vs, sizeof(vs), "%u", k->ver);\r\nws_combo_box_append_text_and_pointer(GTK_COMBO_BOX(vers_combo_box), vs, k);\r\n}\r\nstatic void\r\ndcerpcstat_program_select(GtkWidget *prog_combo_box, gpointer user_data)\r\n{\r\nguid_key *k;\r\nGtkWidget *vers_combo_box;\r\nvers_combo_box = (GtkWidget *)user_data;\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(prog_combo_box), (gpointer *)&k)) {\r\ng_assert_not_reached();\r\n}\r\ng_signal_handlers_disconnect_by_func(vers_combo_box, G_CALLBACK(dcerpcstat_version_select), NULL );\r\nws_combo_box_clear_text_and_pointer(GTK_COMBO_BOX(vers_combo_box));\r\ng_assert(k != NULL);\r\ndcerpc_uuid_program = &(k->guid);\r\ng_signal_handlers_disconnect_by_func(vers_combo_box, G_CALLBACK(dcerpcstat_version_select), NULL );\r\nws_combo_box_clear_text_and_pointer(GTK_COMBO_BOX(vers_combo_box));\r\ng_hash_table_foreach(dcerpc_uuids, (GHFunc)dcerpcstat_find_vers, vers_combo_box);\r\ng_signal_connect(vers_combo_box, "changed", G_CALLBACK(dcerpcstat_version_select), NULL);\r\nws_combo_box_set_active(GTK_COMBO_BOX(vers_combo_box), 0);\r\n}\r\nstatic GtkTreeIter\r\ndcerpcstat_add_program_to_menu(guid_key *k, dcerpc_uuid_value *v, GtkWidget *prog_combo_box, int program_item_index)\r\n{\r\nstatic GtkTreeIter iter;\r\nchar str[64];\r\nswitch(program_item_index%15){\r\ncase 0:\r\ng_snprintf(str,sizeof(str),"%s ...",v->name);\r\niter = ws_combo_box_append_text_and_pointer_full(\r\nGTK_COMBO_BOX(prog_combo_box), NULL, str, NULL, FALSE);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ws_combo_box_append_text_and_pointer_full(\r\nGTK_COMBO_BOX(prog_combo_box), &iter, v->name, k, TRUE);\r\n}\r\nstatic void\r\ndcerpcstat_find_next_program(gpointer *key, gpointer *value, gpointer *user_data _U_)\r\n{\r\nguid_key *k = (guid_key *)key;\r\ndcerpc_uuid_value *v = (dcerpc_uuid_value *)value;\r\nif((current_uuid_key==NULL) && (new_uuid_key==NULL)){\r\nnew_uuid_key = k;\r\nnew_uuid_value = v;\r\nreturn;\r\n}\r\nif(current_uuid_key==NULL){\r\nif(strcmp(new_uuid_value->name, v->name)>0){\r\nnew_uuid_key = k;\r\nnew_uuid_value = v;\r\nreturn;\r\n}\r\nreturn;\r\n}\r\nif(strcmp(current_uuid_value->name, v->name) >= 0){\r\nreturn;\r\n}\r\nif(new_uuid_key==NULL){\r\nnew_uuid_key = k;\r\nnew_uuid_value = v;\r\nreturn;\r\n}\r\nif(strcmp(new_uuid_value->name, v->name) > 0){\r\nnew_uuid_key = k;\r\nnew_uuid_value = v;\r\nreturn;\r\n}\r\nreturn;\r\n}\r\nstatic void\r\ndlg_destroy_cb(GtkWidget *w _U_, gpointer user_data _U_)\r\n{\r\ndlg = NULL;\r\n}\r\nvoid gtk_dcerpcstat_cb(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nGtkWidget *dlg_box;\r\nGtkWidget *prog_box, *prog_label, *prog_combo_box;\r\nGtkWidget *vers_label, *vers_combo_box;\r\nGtkWidget *filter_box, *filter_bt;\r\nGtkWidget *bbox, *start_button, *cancel_button;\r\nGtkCellRenderer *cell_renderer;\r\n#if 0\r\nGtkTreeIter program_first_item_iter;\r\n#endif\r\nconst char *filter;\r\nint program_item_index = 0;\r\nstatic construct_args_t args = {\r\n"Service Response Time Statistics Filter",\r\nFALSE,\r\nFALSE,\r\nFALSE\r\n};\r\nif(dlg){\r\nreactivate_window(dlg);\r\nreturn;\r\n}\r\ndlg = dlg_window_new("Wireshark: Compute DCE-RPC SRT statistics");\r\ngtk_window_set_default_size(GTK_WINDOW(dlg), 400, -1);\r\ndlg_box = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 10, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(dlg_box), 10);\r\ngtk_container_add(GTK_CONTAINER(dlg), dlg_box);\r\ngtk_widget_show(dlg_box);\r\nprog_box = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(prog_box), 10);\r\nprog_label = gtk_label_new("Program:");\r\ngtk_box_pack_start(GTK_BOX(prog_box), prog_label, FALSE, FALSE, 0);\r\ngtk_widget_show(prog_label);\r\ndcerpc_uuid_program = NULL;\r\nprog_combo_box = ws_combo_box_new_text_and_pointer_full(&cell_renderer);\r\n{\r\n#if GTK_CHECK_VERSION(3,0,0)\r\nGtkStyleContext *context;\r\nGdkRGBA *new_rgba_fg_color;\r\ncontext = gtk_widget_get_style_context (prog_combo_box);\r\ngtk_style_context_get (context, GTK_STATE_FLAG_NORMAL,\r\n"color", &new_rgba_fg_color,\r\nNULL);\r\ng_object_set(cell_renderer,\r\n"foreground-rgba", &new_rgba_fg_color,\r\n"foreground-set", TRUE,\r\nNULL);\r\n#else\r\nGtkStyle *s;\r\ns = gtk_widget_get_style(prog_combo_box);\r\ng_object_set(cell_renderer,\r\n"foreground-gdk", &(s->fg[GTK_STATE_NORMAL]),\r\n"foreground-set", TRUE,\r\nNULL);\r\n#endif\r\n}\r\ncurrent_uuid_key = NULL;\r\ncurrent_uuid_value = NULL;\r\ndo {\r\nnew_uuid_key = NULL;\r\nnew_uuid_value = NULL;\r\ng_hash_table_foreach(dcerpc_uuids, (GHFunc)dcerpcstat_find_next_program, NULL);\r\nif(new_uuid_key){\r\n#if 0\r\nGtkTreeIter tmp_iter;\r\ntmp_iter = dcerpcstat_add_program_to_menu(new_uuid_key, new_uuid_value,\r\nprog_combo_box, program_item_index);\r\nif (program_item_index == 0)\r\nprogram_first_item_iter = tmp_iter;\r\n#else\r\ndcerpcstat_add_program_to_menu(new_uuid_key, new_uuid_value,\r\nprog_combo_box, program_item_index);\r\n#endif\r\nprogram_item_index += 1;\r\n}\r\ncurrent_uuid_key = new_uuid_key;\r\ncurrent_uuid_value = new_uuid_value;\r\n} while(new_uuid_key != NULL);\r\ngtk_box_pack_start(GTK_BOX(prog_box), prog_combo_box, TRUE, TRUE, 0);\r\ngtk_widget_show(prog_combo_box);\r\ngtk_container_set_border_width(GTK_CONTAINER(prog_box), 10);\r\nvers_label = gtk_label_new("Version:");\r\ngtk_box_pack_start(GTK_BOX(prog_box), vers_label, FALSE, FALSE, 0);\r\ngtk_widget_show(vers_label);\r\nvers_combo_box = ws_combo_box_new_text_and_pointer();\r\ngtk_box_pack_start(GTK_BOX(prog_box), vers_combo_box, TRUE, TRUE, 0);\r\ngtk_widget_show(vers_combo_box);\r\ng_signal_connect(prog_combo_box, "changed", G_CALLBACK(dcerpcstat_program_select), vers_combo_box);\r\n#if 0\r\nws_combo_box_set_active_iter(GTK_COMBO_BOX(prog_combo_box), &program_first_item_iter);\r\n#endif\r\ngtk_box_pack_start(GTK_BOX(dlg_box), prog_box, TRUE, TRUE, 0);\r\ngtk_widget_show(prog_box);\r\nfilter_box = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\nfilter_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked", G_CALLBACK(display_filter_construct_cb), &args);\r\ngtk_box_pack_start(GTK_BOX(filter_box), filter_bt, FALSE, FALSE, 0);\r\ngtk_widget_show(filter_bt);\r\nfilter_entry = gtk_entry_new();\r\ng_signal_connect(filter_entry, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_box), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(filter_entry, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(dlg, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ngtk_box_pack_start(GTK_BOX(filter_box), filter_entry, TRUE, TRUE, 0);\r\nfilter = gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\nif(filter){\r\ngtk_entry_set_text(GTK_ENTRY(filter_entry), filter);\r\n} else {\r\ncolorize_filter_te_as_empty(filter_entry);\r\n}\r\ngtk_widget_show(filter_entry);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), filter_box, TRUE, TRUE, 0);\r\ngtk_widget_show(filter_box);\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, filter_entry);\r\nbbox = dlg_button_row_new(WIRESHARK_STOCK_CREATE_STAT, GTK_STOCK_CANCEL, NULL);\r\ngtk_box_pack_start(GTK_BOX(dlg_box), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nstart_button = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CREATE_STAT);\r\ng_signal_connect_swapped(start_button, "clicked",\r\nG_CALLBACK(dcerpcstat_start_button_clicked), NULL);\r\ncancel_button = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button(dlg, cancel_button, window_cancel_button_cb);\r\ng_signal_connect(dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(dlg, "destroy", G_CALLBACK(dlg_destroy_cb), NULL);\r\ndlg_set_activate(filter_entry, start_button);\r\ngtk_widget_grab_default(start_button );\r\ngtk_widget_grab_focus(filter_entry);\r\ngtk_widget_show_all(dlg);\r\nwindow_present(dlg);\r\n}\r\nvoid\r\nregister_tap_listener_gtkdcerpcstat(void)\r\n{\r\nregister_stat_tap_ui(&dcerpcstat_ui, NULL);\r\n}

static gint\r\ndissect_dvb_ait_app_desc_body(tvbuff_t *tvb, guint offset,\r\nguint8 body_len, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nguint offset_start, offset_app_prof_start;\r\nguint8 app_prof_len;\r\nguint8 ver_maj, ver_min, ver_mic;\r\noffset_start = offset;\r\napp_prof_len = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_prof_len,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\noffset_app_prof_start = offset;\r\nwhile (offset-offset_app_prof_start < app_prof_len) {\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_prof,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nver_maj = tvb_get_guint8(tvb, offset);\r\nver_min = tvb_get_guint8(tvb, offset+1);\r\nver_mic = tvb_get_guint8(tvb, offset+2);\r\nproto_tree_add_uint_format(tree, hf_dvb_ait_descr_app_ver,\r\ntvb, offset, 3, ver_maj<<16|ver_min<<8|ver_mic,\r\n"Version %d.%d.%d", ver_maj, ver_min, ver_mic);\r\noffset += 3;\r\n}\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_svc_bound,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_vis,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_prio,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwhile (offset-offset_start < body_len) {\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_trpt_proto_label,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\n}\r\nreturn (gint)(offset-offset_start);\r\n}\r\nstatic gint\r\ndissect_dvb_ait_app_name_desc_body(tvbuff_t *tvb, guint offset,\r\nguint8 body_len, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nguint offset_start;\r\nguint8 len;\r\noffset_start = offset;\r\nwhile (offset-offset_start < body_len) {\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_name_lang,\r\ntvb, offset, 3, ENC_ASCII|ENC_NA);\r\noffset += 3;\r\nlen = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_app_name_name,\r\ntvb, offset, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\noffset += 1+len;\r\n}\r\nreturn (gint)(offset-offset_start);\r\n}\r\nstatic gint\r\ndissect_dvb_ait_trpt_proto_desc_body(tvbuff_t *tvb, guint offset,\r\nguint8 body_len, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nguint offset_start;\r\nguint16 proto_id;\r\ngboolean remote_connection;\r\noffset_start = offset;\r\nproto_id = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_proto_id,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_proto_label,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (offset-offset_start < body_len) {\r\nif (proto_id == TRPT_OBJ_CAROUSEL) {\r\nremote_connection = ((tvb_get_guint8(tvb, offset) & 0x80) == 0x80);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_remote,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nif (remote_connection) {\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_onid,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_tsid,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_svcid,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_comp,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\n}\r\nelse if (proto_id == TRPT_HTTP) {\r\nguint8 url_base_len, url_ext_cnt, url_ext_len, i;\r\nurl_base_len = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_url_base,\r\ntvb, offset, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\noffset += 1+url_base_len;\r\nurl_ext_cnt = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_url_ext_cnt,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nfor (i=0; i<url_ext_cnt; i++) {\r\nurl_ext_len = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_url_ext,\r\ntvb, offset, 1, ENC_ASCII|ENC_BIG_ENDIAN);\r\noffset += 1+url_ext_len;\r\n}\r\n}\r\nelse {\r\nproto_tree_add_item(tree, hf_dvb_ait_descr_trpt_sel_bytes,\r\ntvb, offset, offset_start+body_len-offset, ENC_NA);\r\noffset = offset_start+body_len;\r\n}\r\n}\r\nreturn (gint)(offset-offset_start);\r\n}\r\nstatic gint\r\ndissect_dvb_ait_descriptor(tvbuff_t *tvb, guint offset,\r\npacket_info *pinfo, proto_tree *tree)\r\n{\r\ngint ret;\r\nguint offset_start;\r\nguint8 tag, len;\r\nproto_tree *descr_tree;\r\ntag = tvb_get_guint8(tvb, offset);\r\nlen = tvb_get_guint8(tvb, offset+1);\r\nif (try_val_to_str(tag, ait_descr_tag)) {\r\noffset_start = offset;\r\ndescr_tree = proto_tree_add_subtree_format(tree, tvb, offset_start, len+2,\r\nett_dvb_ait_descr, NULL, "Descriptor Tag=0x%02x", tag);\r\nproto_tree_add_item(descr_tree, hf_dvb_ait_descr_tag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(descr_tree, hf_dvb_ait_descr_len,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nswitch (tag) {\r\ncase AIT_DESCR_APP:\r\nret = dissect_dvb_ait_app_desc_body(tvb, offset, len,\r\npinfo, descr_tree);\r\nif (ret>0)\r\noffset += ret;\r\nbreak;\r\ncase AIT_DESCR_APP_NAME:\r\nret = dissect_dvb_ait_app_name_desc_body(tvb, offset, len,\r\npinfo, descr_tree);\r\nif (ret>0)\r\noffset += ret;\r\nbreak;\r\ncase AIT_DESCR_TRPT_PROTO:\r\nret = dissect_dvb_ait_trpt_proto_desc_body(tvb, offset, len,\r\npinfo, descr_tree);\r\nif (ret>0)\r\noffset += ret;\r\nbreak;\r\ncase AIT_DESCR_SIM_APP_LOC:\r\nproto_tree_add_item(descr_tree,\r\nhf_dvb_ait_descr_sal_init_path,\r\ntvb, offset, len, ENC_ASCII|ENC_NA);\r\noffset += len;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(descr_tree, hf_dvb_ait_descr_data,\r\ntvb, offset, len, ENC_NA);\r\noffset += len;\r\nbreak;\r\n}\r\nret = (gint)(offset-offset_start);\r\n}\r\nelse\r\nret = (gint)proto_mpeg_descriptor_dissect(tvb, offset, tree);\r\nreturn ret;\r\n}\r\nstatic int\r\ndissect_dvb_ait(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ngint offset=0;\r\nproto_item *ait_tree_ti = NULL, *app_tree_ti = NULL;\r\nproto_tree *ait_tree = NULL, *ait_app_tree = NULL;\r\ngint offset_loop_start, offset_inner_loop_start, offset_app_start;\r\nguint16 descr_loop_len, app_loop_len;\r\ngint ret;\r\nguint32 org_id;\r\nguint16 app_id;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Application Information Table (AIT)");\r\nif (tree) {\r\nait_tree_ti = proto_tree_add_protocol_format(tree, proto_dvb_ait,\r\ntvb, 0, -1, "Application Information Table (AIT)");\r\nait_tree = proto_item_add_subtree(ait_tree_ti, ett_dvb_ait);\r\n}\r\noffset += packet_mpeg_sect_header(tvb, offset, ait_tree, NULL, NULL);\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_test_app_flag,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_app_type,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_version_number,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_current_next_indicator,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_section_number,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_last_section_number,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ndescr_loop_len = tvb_get_ntohs(tvb, offset) & 0x0FFF;\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_descr_loop_len,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset_loop_start = offset;\r\nwhile (offset-offset_loop_start < descr_loop_len) {\r\nret = dissect_dvb_ait_descriptor(tvb, offset, pinfo, ait_tree);\r\nif (ret<=0)\r\nbreak;\r\noffset += ret;\r\n}\r\napp_loop_len = tvb_get_ntohs(tvb, offset) & 0x0FFF;\r\nproto_tree_add_item(ait_tree, hf_dvb_ait_app_loop_len,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset_loop_start = offset;\r\nwhile (offset-offset_loop_start < app_loop_len) {\r\noffset_app_start = offset;\r\norg_id = tvb_get_ntohl(tvb, offset);\r\napp_id = tvb_get_ntohs(tvb, offset+4);\r\nait_app_tree = proto_tree_add_subtree_format(ait_tree, tvb, offset, -1,\r\nett_dvb_ait_app, &app_tree_ti, "Application: Org 0x%x, App 0x%x", org_id, app_id);\r\nproto_tree_add_item(ait_app_tree, hf_dvb_ait_org_id,\r\ntvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(ait_app_tree, hf_dvb_ait_app_id,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ait_app_tree, hf_dvb_ait_app_ctrl_code,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ndescr_loop_len = tvb_get_ntohs(tvb, offset) & 0x0FFF;\r\nproto_tree_add_item(ait_app_tree, hf_dvb_ait_descr_loop_len,\r\ntvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset_inner_loop_start = offset;\r\nwhile (offset-offset_inner_loop_start < descr_loop_len) {\r\nret = dissect_dvb_ait_descriptor(tvb, offset, pinfo, ait_app_tree);\r\nif (ret<=0)\r\nbreak;\r\noffset += ret;\r\n}\r\nproto_item_set_len(app_tree_ti, offset-offset_app_start);\r\n}\r\noffset += packet_mpeg_sect_crc(tvb, pinfo, ait_tree, 0, offset);\r\nproto_item_set_len(ait_tree_ti, offset);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_dvb_ait(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_dvb_ait,\r\n&ett_dvb_ait_descr,\r\n&ett_dvb_ait_app\r\n};\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dvb_ait_test_app_flag,\r\n{ "Test application flag", "dvb_ait.test_app_flag",\r\nFT_UINT8, BASE_HEX, NULL, 0x80, NULL, HFILL } },\r\n{ &hf_dvb_ait_app_type,\r\n{ "Application type", "dvb_ait.app_type",\r\nFT_UINT16, BASE_HEX, NULL, 0x7FFF, NULL, HFILL } },\r\n{ &hf_dvb_ait_version_number,\r\n{ "Version Number", "dvb_ait.version",\r\nFT_UINT8, BASE_HEX, NULL, 0x3E, NULL, HFILL } },\r\n{ &hf_dvb_ait_current_next_indicator,\r\n{ "Current/Next Indicator", "dvb_ait.cur_next_ind",\r\nFT_UINT8, BASE_DEC, NULL, 0x01, NULL, HFILL } },\r\n{ &hf_dvb_ait_section_number,\r\n{ "Section Number", "dvb_ait.sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_last_section_number,\r\n{ "Last Section Number", "dvb_ait.last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_loop_len,\r\n{ "Descriptor loop length", "dvb_ait.descr_loop_len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0FFF, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_tag,\r\n{ "Descriptor Tag", "dvb_ait.descr.tag",\r\nFT_UINT8, BASE_HEX, VALS(ait_descr_tag), 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_len,\r\n{ "Descriptor Length", "dvb_ait.descr.len",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_data,\r\n{ "Descriptor Data", "dvb_ait.descr.data",\r\nFT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_prof_len,\r\n{ "Application profiles length", "dvb_ait.descr.app.prof_len",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_prof,\r\n{ "Application profile", "dvb_ait.descr.app.prof",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_ver,\r\n{ "Version", "dvb_ait.descr.app.ver",\r\nFT_UINT24, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_svc_bound,\r\n{ "Service-bound flag", "dvb_ait.descr.app.svc_bound_flag",\r\nFT_UINT8, BASE_HEX, NULL, 0x80, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_vis,\r\n{ "Visibility", "dvb_ait.descr.app.visibility",\r\nFT_UINT8, BASE_HEX, VALS(app_vis), 0x60, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_prio,\r\n{ "Application priority", "dvb_ait.descr.app.prio",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_trpt_proto_label,\r\n{ "Transport protocol label", "dvb_ait.descr.app.trpt_proto_label",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_name_lang,\r\n{ "ISO 639 language code", "dvb_ait.descr.app_name.lang",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_app_name_name,\r\n{ "Application name", "dvb_ait.descr.app_name.name",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_proto_id,\r\n{ "Protocol ID", "dvb_ait.descr.trpt_proto.id",\r\nFT_UINT16, BASE_HEX, VALS(trpt_proto_id), 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_proto_label,\r\n{ "Transport protocol label", "dvb_ait.descr.trpt_proto.label",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_remote,\r\n{ "Remote connection", "dvb_ait.descr.trpt_proto.remote",\r\nFT_UINT8, BASE_HEX, NULL, 0x80, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_onid,\r\n{ "Original network ID", "dvb_ait.descr.trpt_proto.onid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_tsid,\r\n{ "Transport stream ID", "dvb_ait.descr.trpt_proto.tsid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_svcid,\r\n{ "Service ID", "dvb_ait.descr.trpt_proto.svcid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_comp,\r\n{ "Component tag", "dvb_ait.descr.trpt_proto.comp_tag",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_url_base,\r\n{ "URL base", "dvb_ait.descr.trpt_proto.url_base",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_url_ext_cnt,\r\n{ "URL extension count", "dvb_ait.descr.trpt_proto.url_ext_cnt",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_url_ext,\r\n{ "URL extension", "dvb_ait.descr.trpt_proto.url_ext",\r\nFT_UINT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_trpt_sel_bytes,\r\n{ "Selector bytes", "dvb_ait.descr.trpt_proto.selector_bytes",\r\nFT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_descr_sal_init_path,\r\n{ "Initial path", "dvb_ait.descr.sim_app_loc.initial_path",\r\nFT_STRING, BASE_NONE, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_app_loop_len,\r\n{ "Application loop length", "dvb_ait.app_loop_len",\r\nFT_UINT16, BASE_DEC, NULL, 0x0FFF, NULL, HFILL } },\r\n{ &hf_dvb_ait_org_id,\r\n{ "Organisation ID", "dvb_ait.app.org_id",\r\nFT_UINT32, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_app_id,\r\n{ "Application ID", "dvb_ait.app.app_id",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL } },\r\n{ &hf_dvb_ait_app_ctrl_code,\r\n{ "Application control code", "dvb_ait.app.ctrl_code",\r\nFT_UINT8, BASE_HEX, VALS(app_ctrl_code), 0, NULL, HFILL } }\r\n};\r\nproto_dvb_ait = proto_register_protocol(\r\n"DVB Application Information Table", "DVB AIT", "dvb_ait");\r\nproto_register_field_array(proto_dvb_ait, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_dvb_ait(void)\r\n{\r\ndissector_handle_t dvb_ait_handle;\r\ndvb_ait_handle = create_dissector_handle(dissect_dvb_ait, proto_dvb_ait);\r\ndissector_add_uint("mpeg_sect.tid", DVB_AIT_TID, dvb_ait_handle);\r\n}

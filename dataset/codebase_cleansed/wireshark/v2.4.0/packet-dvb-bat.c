static int\r\ndissect_dvb_bat(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0, length = 0, ts_loop_end;\r\nguint16 ts_id, descriptor_len, ts_loop_len;\r\nproto_item *ti;\r\nproto_tree *dvb_bat_tree;\r\nproto_tree *transport_stream_tree;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Bouquet Association Table (BAT)");\r\nti = proto_tree_add_item(tree, proto_dvb_bat, tvb, offset, -1, ENC_NA);\r\ndvb_bat_tree = proto_item_add_subtree(ti, ett_dvb_bat);\r\noffset += packet_mpeg_sect_header(tvb, offset, dvb_bat_tree, &length, NULL);\r\nlength -= 4;\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_bouquet_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_reserved1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_version_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_current_next_indicator, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_last_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ndescriptor_len = tvb_get_ntohs(tvb, offset) & DVB_BAT_BOUQUET_DESCRIPTORS_LENGTH_MASK;\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_reserved2, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_bouquet_descriptors_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += proto_mpeg_descriptor_loop_dissect(tvb, offset, descriptor_len, dvb_bat_tree);\r\nts_loop_len = tvb_get_ntohs(tvb, offset) & DVB_BAT_TRANSPORT_STREAM_LOOP_LENGTH_MASK;\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_reserved3, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_bat_tree, hf_dvb_bat_transport_stream_loop_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nts_loop_end = offset + ts_loop_len;\r\nwhile (offset < ts_loop_end) {\r\nts_id = tvb_get_ntohs(tvb, offset);\r\ndescriptor_len = tvb_get_ntohs(tvb, offset + 4) & DVB_BAT_TRANSPORT_DESCRIPTORS_LENGTH_MASK;\r\ntransport_stream_tree = proto_tree_add_subtree_format(dvb_bat_tree, tvb, offset, 6 + descriptor_len,\r\nett_dvb_bat_transport_stream, NULL, "Transport Stream 0x%04x", ts_id);\r\nproto_tree_add_item(transport_stream_tree, hf_dvb_bat_transport_stream_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(transport_stream_tree, hf_dvb_bat_original_network_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(transport_stream_tree, hf_dvb_bat_reserved4, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(transport_stream_tree, hf_dvb_bat_transport_descriptors_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += proto_mpeg_descriptor_loop_dissect(tvb, offset, descriptor_len, transport_stream_tree);\r\n}\r\noffset += packet_mpeg_sect_crc(tvb, pinfo, dvb_bat_tree, 0, offset);\r\nproto_item_set_len(ti, offset);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_dvb_bat(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dvb_bat_bouquet_id, {\r\n"Bouquet ID", "dvb_bat.bouquet_id",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_reserved1, {\r\n"Reserved", "dvb_bat.reserved1",\r\nFT_UINT8, BASE_HEX, NULL, DVB_BAT_RESERVED1_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_version_number, {\r\n"Version Number", "dvb_bat.version",\r\nFT_UINT8, BASE_HEX, NULL, DVB_BAT_VERSION_NUMBER_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_current_next_indicator, {\r\n"Current/Next Indicator", "dvb_bat.cur_next_ind",\r\nFT_UINT8, BASE_DEC, VALS(dvb_bat_cur_next_vals), DVB_BAT_CURRENT_NEXT_INDICATOR_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_section_number, {\r\n"Section Number", "dvb_bat.sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_last_section_number, {\r\n"Last Section Number", "dvb_bat.last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_reserved2, {\r\n"Reserved", "dvb_bat.reserved2",\r\nFT_UINT16, BASE_HEX, NULL, DVB_BAT_RESERVED2_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_bouquet_descriptors_length, {\r\n"Bouquet Descriptors Length", "dvb_bat.bouquet_desc_len",\r\nFT_UINT16, BASE_DEC, NULL, DVB_BAT_BOUQUET_DESCRIPTORS_LENGTH_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_reserved3, {\r\n"Reserved", "dvb_bat.reserved3",\r\nFT_UINT16, BASE_HEX, NULL, DVB_BAT_RESERVED3_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_transport_stream_loop_length, {\r\n"Transport Stream Loop Length", "dvb_bat.ts_loop_len",\r\nFT_UINT16, BASE_DEC, NULL, DVB_BAT_TRANSPORT_STREAM_LOOP_LENGTH_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_transport_stream_id, {\r\n"Transport Stream ID", "dvb_bat.ts.id",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_original_network_id, {\r\n"Original Network ID", "dvb_bat.ts.original_nid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_reserved4, {\r\n"Reserved", "dvb_bat.ts.reserved",\r\nFT_UINT16, BASE_HEX, NULL, DVB_BAT_RESERVED4_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_bat_transport_descriptors_length, {\r\n"Bouquet Descriptors Length", "dvb_bat.ts.desc_len",\r\nFT_UINT16, BASE_DEC, NULL, DVB_BAT_BOUQUET_DESCRIPTORS_LENGTH_MASK, NULL, HFILL\r\n} },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dvb_bat,\r\n&ett_dvb_bat_transport_stream\r\n};\r\nproto_dvb_bat = proto_register_protocol("DVB Bouquet Association Table", "DVB BAT", "dvb_bat");\r\nproto_register_field_array(proto_dvb_bat, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_dvb_bat(void)\r\n{\r\ndissector_handle_t dvb_bat_handle;\r\ndvb_bat_handle = create_dissector_handle(dissect_dvb_bat, proto_dvb_bat);\r\ndissector_add_uint("mpeg_sect.tid", DVB_BAT_TID, dvb_bat_handle);\r\n}

static gboolean dissect_lanforge(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_item *tmp;\r\nproto_tree *lanforge_tree;\r\nguint32 offset = 0;\r\nnstime_t tstamp;\r\nguint32 tss;\r\nguint32 tmpi;\r\nguint32 pld_len, magic;\r\nif(tvb_captured_length(tvb) < 28) {\r\nreturn FALSE;\r\n}\r\nmagic = tvb_get_ntohl(tvb, 4);\r\nif(magic != LANFORGE_MAGIC){\r\nreturn FALSE;\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "LANforge");\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Seq: %u", tvb_get_ntohl(tvb, 16));\r\nif(tree) {\r\nti = proto_tree_add_item(tree, proto_lanforge, tvb, 0, -1, ENC_NA);\r\nlanforge_tree = proto_item_add_subtree(ti, ett_lanforge);\r\nproto_tree_add_item(lanforge_tree, hf_lanforge_crc, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nproto_tree_add_item(lanforge_tree, hf_lanforge_magic, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nproto_tree_add_item(lanforge_tree, hf_lanforge_src_session, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\nproto_tree_add_item(lanforge_tree, hf_lanforge_dst_session, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset+=2;\r\npld_len = tvb_get_ntohs(tvb, offset);\r\ntmp = proto_tree_add_item(lanforge_tree, hf_lanforge_pld_len_l, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nPROTO_ITEM_SET_GENERATED(tmp);\r\noffset+=2;\r\ntmpi = tvb_get_guint8(tvb, offset);\r\ntmp = proto_tree_add_item(lanforge_tree, hf_lanforge_pld_len_h, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nPROTO_ITEM_SET_GENERATED(tmp);\r\noffset+=1;\r\npld_len |= (tmpi << 16);\r\nproto_tree_add_uint(lanforge_tree, hf_lanforge_pld_len, tvb, offset-3, 3, pld_len);\r\nproto_tree_add_item(lanforge_tree, hf_lanforge_pld_pattern, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset+=1;\r\nproto_tree_add_item(lanforge_tree, hf_lanforge_seq, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\ntss = tvb_get_ntohl(tvb, offset);\r\ntstamp.secs = tss;\r\ntmp = proto_tree_add_item(lanforge_tree, hf_lanforge_tx_time_s, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nPROTO_ITEM_SET_GENERATED(tmp);\r\noffset+=4;\r\ntss = tvb_get_ntohl(tvb, offset);\r\ntstamp.nsecs = tss;\r\ntmp = proto_tree_add_item(lanforge_tree, hf_lanforge_tx_time_ns, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nPROTO_ITEM_SET_GENERATED(tmp);\r\noffset+=4;\r\nproto_tree_add_time(lanforge_tree, hf_lanforge_timestamp, tvb, offset - 8, 8, &tstamp);\r\nif(tvb_reported_length_remaining(tvb, offset) > 0)\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset), pinfo,\r\nlanforge_tree);\r\n}\r\nreturn TRUE;\r\n}\r\nvoid proto_register_lanforge(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_lanforge_crc,\r\n{\r\n"CRC", "lanforge.CRC",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"The LANforge CRC number", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_magic,\r\n{\r\n"Magic number", "lanforge.magic",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\n"The LANforge magic number", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_src_session,\r\n{\r\n"Source session ID", "lanforge.source-session-id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"The LANforge source session ID", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_dst_session,\r\n{\r\n"Dest session ID", "lanforge.dest-session-id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"The LANforge dest session ID", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_pld_len_l,\r\n{\r\n"Payload Length(L)", "lanforge.pld-len-L",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"The LANforge payload length (low bytes)", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_pld_len_h,\r\n{\r\n"Payload Length(H)", "lanforge.pld-len-H",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"The LANforge payload length (high byte)", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_pld_len,\r\n{\r\n"Payload Length", "lanforge.pld-length",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"The LANforge payload length", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_pld_pattern,\r\n{\r\n"Payload Pattern", "lanforge.pld-pattern",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"The LANforge payload pattern", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_seq,\r\n{\r\n"Sequence Number", "lanforge.seqno",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\n"The LANforge Sequence Number", HFILL\r\n}\r\n},\r\n{ &hf_lanforge_tx_time_s,\r\n{\r\n"Timestamp Secs", "lanforge.ts-secs",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_lanforge_tx_time_ns,\r\n{\r\n"Timestamp nsecs", "lanforge.ts-nsecs",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{ &hf_lanforge_timestamp,\r\n{\r\n"Timestamp", "lanforge.timestamp",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\nNULL, HFILL\r\n}\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_lanforge\r\n};\r\nproto_lanforge = proto_register_protocol("LANforge Traffic Generator", "LANforge", "lanforge");\r\nproto_register_field_array(proto_lanforge, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_lanforge(void)\r\n{\r\nheur_dissector_add("udp", dissect_lanforge, "LANforge over UDP", "lanforge_udp", proto_lanforge, HEURISTIC_ENABLE);\r\nheur_dissector_add("tcp", dissect_lanforge, "LANforge over TCP", "lanforge_tcp", proto_lanforge, HEURISTIC_ENABLE);\r\n}

static gint\r\ndissect_epl_v1_soc(proto_tree *epl_v1_tree, tvbuff_t *tvb, gint offset)\r\n{\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_soc_ms, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_soc_ps, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_soc_net_command, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_soc_net_time, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_soc_powerlink_cycle_time, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_soc_net_command_parameter, tvb, offset, 32, ENC_NA);\r\noffset += 32;\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_epl_v1_eoc(proto_tree *epl_v1_tree, tvbuff_t *tvb, gint offset)\r\n{\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_eoc_net_command, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 8;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_eoc_net_command_parameter, tvb, offset, 32, ENC_NA);\r\noffset += 32;\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_epl_v1_preq(proto_tree *epl_v1_tree, tvbuff_t *tvb, gint offset)\r\n{\r\nguint16 len;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_preq_ms, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_preq_rd, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_preq_poll_size_out, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nlen = tvb_get_letohs(tvb, offset);\r\noffset += 6;\r\nif(len>0){\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_preq_out_data, tvb, offset, len, ENC_NA);\r\noffset += len;\r\n}\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_epl_v1_pres(proto_tree *epl_v1_tree, tvbuff_t *tvb, gint offset)\r\n{\r\nguint16 len;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_ms, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_ex, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_rs, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_wa, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_er, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_rd, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_poll_size_in, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nlen = tvb_get_letohs(tvb, offset);\r\noffset += 6;\r\nif(len>0){\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_pres_in_data, tvb, offset, len, ENC_NA);\r\noffset += len;\r\n}\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_epl_v1_ainv(proto_tree *epl_v1_tree, tvbuff_t *tvb, gint offset)\r\n{\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_ainv_channel, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_epl_v1_asnd(proto_tree *epl_v1_tree, tvbuff_t *tvb, gint offset)\r\n{\r\nguint8 epl_v1_asnd_channel;\r\nguint16 len;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_channel, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nepl_v1_asnd_channel = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_size, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\nlen = tvb_get_letohs(tvb, offset);\r\noffset += 2;\r\nif(epl_v1_asnd_channel == EPL_V1_AINV_IDENT){\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_node_id, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_hardware_revision, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_firmware_version, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_device_variant, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_poll_in_size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_poll_out_size, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset += 4;\r\n} else {\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_asnd_data, tvb, offset, len, ENC_NA);\r\noffset += len;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_epl_v1(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nguint8 epl_v1_service, epl_v1_dest, epl_v1_src, epl_v1_ainv_ch, epl_v1_asnd_ch;\r\ngint offset;\r\nproto_item *ti=NULL;\r\nproto_tree *epl_v1_tree=NULL;\r\nif(tvb_captured_length(tvb) < 3){\r\nreturn FALSE;\r\n}\r\noffset = 0;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "EPL_V1");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nepl_v1_service = tvb_get_guint8(tvb, EPL_V1_SERVICE_OFFSET) & 0x7F;\r\nepl_v1_dest = tvb_get_guint8(tvb, EPL_V1_DEST_OFFSET);\r\nepl_v1_src = tvb_get_guint8(tvb, EPL_V1_SRC_OFFSET);\r\nswitch(epl_v1_service){\r\ncase EPL_V1_SOC:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "SoC dest = %3d src = %3d ", epl_v1_dest, epl_v1_src);\r\nbreak;\r\ncase EPL_V1_EOC:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "EoC dest = %3d src = %3d ", epl_v1_dest, epl_v1_src);\r\nbreak;\r\ncase EPL_V1_PREQ:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "PReq dest = %3d src = %3d ", epl_v1_dest, epl_v1_src);\r\nbreak;\r\ncase EPL_V1_PRES:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "PRes dest = %3d src = %3d ", epl_v1_dest, epl_v1_src);\r\nbreak;\r\ncase EPL_V1_AINV:\r\nepl_v1_ainv_ch = tvb_get_guint8(tvb, EPL_V1_AINV_CHANNEL_OFFSET);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "AInv dest = %3d src = %3d channel = %s ",\r\nepl_v1_dest, epl_v1_src, val_to_str(epl_v1_ainv_ch, ainv_channel_number_vals, "unknown Channel (%d)"));\r\nbreak;\r\ncase EPL_V1_ASND:\r\nepl_v1_asnd_ch = tvb_get_guint8(tvb, EPL_V1_ASND_CHANNEL_OFFSET);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "ASnd dest = %3d src = %3d channel = %s ",\r\nepl_v1_dest, epl_v1_src, val_to_str(epl_v1_asnd_ch, asnd_channel_number_vals, "unknown Channel (%d)"));\r\nbreak;\r\ndefault:\r\nreturn FALSE;\r\n}\r\nif(tree){\r\nti = proto_tree_add_item(tree, proto_epl_v1, tvb, 0, -1, ENC_NA);\r\nepl_v1_tree = proto_item_add_subtree(ti, ett_epl_v1);\r\n}\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_service, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_dest, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(epl_v1_tree, hf_epl_v1_src, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset += 1;\r\nswitch(epl_v1_service){\r\ncase EPL_V1_SOC:\r\noffset = dissect_epl_v1_soc(epl_v1_tree, tvb, offset);\r\nbreak;\r\ncase EPL_V1_EOC:\r\noffset = dissect_epl_v1_eoc(epl_v1_tree, tvb, offset);\r\nbreak;\r\ncase EPL_V1_PREQ:\r\noffset = dissect_epl_v1_preq(epl_v1_tree, tvb, offset);\r\nbreak;\r\ncase EPL_V1_PRES:\r\noffset = dissect_epl_v1_pres(epl_v1_tree, tvb, offset);\r\nbreak;\r\ncase EPL_V1_AINV:\r\noffset = dissect_epl_v1_ainv(epl_v1_tree, tvb, offset);\r\nbreak;\r\ncase EPL_V1_ASND:\r\noffset = dissect_epl_v1_asnd(epl_v1_tree, tvb, offset);\r\nbreak;\r\ndefault:\r\nreturn FALSE;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_epl_v1(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_epl_v1_service,\r\n{ "Service", "epl_v1.service",\r\nFT_UINT8, BASE_DEC, VALS(service_vals), 0x7F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_dest,\r\n{ "Destination", "epl_v1.dest",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_src,\r\n{ "Source", "epl_v1.src",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_soc_ms,\r\n{ "MS (Multiplexed Slot)", "epl_v1.soc.ms",\r\nFT_UINT8, BASE_DEC, NULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_soc_ps,\r\n{ "PS (Prescaled Slot)", "epl_v1.soc.ps",\r\nFT_UINT8, BASE_DEC, NULL, 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_soc_net_command,\r\n{ "Net Command", "epl_v1.soc.netcommand",\r\nFT_UINT16, BASE_DEC, VALS(soc_net_command_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_soc_net_time,\r\n{ "Net Time", "epl_v1.soc.nettime",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_soc_powerlink_cycle_time,\r\n{ "Cycle Time", "epl_v1.soc.cycletime",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_soc_net_command_parameter,\r\n{ "Net Command Parameter", "epl_v1.soc.netcommand.parameter",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_preq_ms,\r\n{ "MS (Multiplexed Slot)", "epl_v1.preq.ms",\r\nFT_UINT8, BASE_DEC, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_preq_rd,\r\n{ "RD (Ready)", "epl_v1.preq.rd",\r\nFT_UINT8, BASE_DEC, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_preq_poll_size_out,\r\n{ "Poll Size OUT", "epl_v1.preq.pollsize",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_preq_out_data,\r\n{ "OUT Data", "epl_v1.preq.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_ms,\r\n{ "MS (Multiplexed)", "epl_v1.pres.ms",\r\nFT_UINT8, BASE_DEC, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_ex,\r\n{ "EX (Exception)", "epl_v1.pres.ex",\r\nFT_UINT8, BASE_DEC, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_rs,\r\n{ "RS (Request to Send)", "epl_v1.pres.rs",\r\nFT_UINT8, BASE_DEC, NULL, 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_wa,\r\n{ "WA (Warning)", "epl_v1.pres.wa",\r\nFT_UINT8, BASE_DEC, NULL, 0x04,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_er,\r\n{ "ER (Error)", "epl_v1.pres.er",\r\nFT_UINT8, BASE_DEC, NULL, 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_rd,\r\n{ "RD (Ready)", "epl_v1.pres.rd",\r\nFT_UINT8, BASE_DEC, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_poll_size_in,\r\n{ "Poll Size IN", "epl_v1.pres.pollsize",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_pres_in_data,\r\n{ "IN Data", "epl_v1.pres.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_eoc_net_command,\r\n{ "Net Command", "epl_v1.eoc.netcommand",\r\nFT_UINT16, BASE_DEC, VALS(eoc_net_command_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_eoc_net_command_parameter,\r\n{ "Net Command Parameter", "epl_v1.soa.netcommand.parameter",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_ainv_channel,\r\n{ "Channel", "epl_v1.ainv.channel",\r\nFT_UINT8, BASE_DEC, VALS(ainv_channel_number_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_channel,\r\n{ "Channel", "epl_v1.asnd.channel",\r\nFT_UINT8, BASE_DEC, VALS(asnd_channel_number_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_size,\r\n{ "Size", "epl_v1.asnd.size",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_data,\r\n{ "Data", "epl_v1.asnd.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_node_id,\r\n{ "NodeID", "epl_v1.asnd.node_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_hardware_revision,\r\n{ "Hardware Revision", "epl_v1.asnd.hardware.revision",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_firmware_version,\r\n{ "Firmware Version", "epl_v1.asnd.firmware.version",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_device_variant,\r\n{ "Device Variant", "epl_v1.asnd.device.variant",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_poll_in_size,\r\n{ "Poll IN Size", "epl_v1.asnd.poll.in.size",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_epl_v1_asnd_poll_out_size,\r\n{ "Poll OUT Size", "epl_v1.asnd.poll.out.size",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_epl_v1,\r\n};\r\nproto_epl_v1 = proto_register_protocol("ETHERNET Powerlink V1.0", "EPL_V1", "epl_v1");\r\nproto_register_field_array(proto_epl_v1, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_epl_v1(void)\r\n{\r\ndissector_handle_t epl_v1_handle;\r\nepl_v1_handle = create_dissector_handle(dissect_epl_v1, proto_epl_v1);\r\ndissector_add_uint("ethertype", ETHERTYPE_EPL_V1, epl_v1_handle);\r\n}

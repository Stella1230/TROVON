static const h450_op_t *get_op(gint32 opcode) {\r\nint i;\r\nfor (i = array_length(h450_op_tab) - 1; i >= 0; i--)\r\nif (h450_op_tab[i].opcode == opcode)\r\nreturn &h450_op_tab[i];\r\nreturn NULL;\r\n}\r\nstatic const h450_err_t *get_err(gint32 errcode) {\r\nint i;\r\nfor (i = array_length(h450_err_tab) - 1; i >= 0; i--)\r\nif (h450_err_tab[i].errcode == errcode)\r\nreturn &h450_err_tab[i];\r\nreturn NULL;\r\n}\r\nstatic int\r\ndissect_h450_arg(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data) {\r\nproto_item *hidden_item;\r\nint offset = 0;\r\nrose_ctx_t *rctx;\r\ngint32 opcode;\r\nconst h450_op_t *op_ptr;\r\nconst gchar *p;\r\nif (data == NULL)\r\nreturn 0;\r\nrctx = get_rose_ctx(data);\r\nDISSECTOR_ASSERT(rctx);\r\nif (rctx->d.pdu != 1)\r\nreturn offset;\r\nif (rctx->d.code != 0)\r\nreturn offset;\r\nopcode = rctx->d.code_local;\r\nop_ptr = get_op(opcode);\r\nif (!op_ptr)\r\nreturn offset;\r\nhidden_item = proto_tree_add_uint(tree, hf_h450_operation, tvb, 0, 0, opcode);\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\np = try_val_to_str(opcode, VALS(h450_str_operation));\r\nif (p) {\r\nproto_item_append_text(rctx->d.code_item, " - %s", p);\r\nif (rctx->apdu_depth >= 0)\r\nproto_item_append_text(proto_item_get_parent_nth(proto_tree_get_parent(tree), rctx->apdu_depth), " %s", p);\r\n}\r\nif (op_ptr->arg_pdu && (tvb_reported_length_remaining(tvb, offset) > 0))\r\noffset = op_ptr->arg_pdu(tvb, pinfo, tree, NULL);\r\nelse\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(tree, pinfo, &ei_h450_unsupported_arg_type, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_h450_res(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data) {\r\nproto_item *hidden_item;\r\nint offset = 0;\r\nrose_ctx_t *rctx;\r\ngint32 opcode;\r\nconst h450_op_t *op_ptr;\r\nconst gchar *p;\r\nif (data == NULL)\r\nreturn 0;\r\nrctx = get_rose_ctx(data);\r\nDISSECTOR_ASSERT(rctx);\r\nif (rctx->d.pdu != 2)\r\nreturn offset;\r\nif (rctx->d.code != 0)\r\nreturn offset;\r\nopcode = rctx->d.code_local;\r\nop_ptr = get_op(opcode);\r\nif (!op_ptr)\r\nreturn offset;\r\nhidden_item = proto_tree_add_uint(tree, hf_h450_operation, tvb, 0, 0, opcode);\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\np = try_val_to_str(opcode, VALS(h450_str_operation));\r\nif (p) {\r\nproto_item_append_text(rctx->d.code_item, " - %s", p);\r\nif (rctx->apdu_depth >= 0)\r\nproto_item_append_text(proto_item_get_parent_nth(proto_tree_get_parent(tree), rctx->apdu_depth), " %s", p);\r\n}\r\nif (op_ptr->res_pdu && (tvb_reported_length_remaining(tvb, offset) > 0))\r\noffset = op_ptr->res_pdu(tvb, pinfo, tree, NULL);\r\nelse\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(tree, pinfo, &ei_h450_unsupported_result_type, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_h450_err(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data) {\r\nproto_item *hidden_item;\r\nint offset = 0;\r\nrose_ctx_t *rctx;\r\ngint32 errcode;\r\nconst h450_err_t *err_ptr;\r\nconst gchar *p;\r\nif (data == NULL)\r\nreturn 0;\r\nrctx = get_rose_ctx(data);\r\nDISSECTOR_ASSERT(rctx);\r\nif (rctx->d.pdu != 3)\r\nreturn offset;\r\nif (rctx->d.code != 0)\r\nreturn offset;\r\nerrcode = rctx->d.code_local;\r\nerr_ptr = get_err(errcode);\r\nif (!err_ptr)\r\nreturn offset;\r\nhidden_item = proto_tree_add_uint(tree, hf_h450_error, tvb, 0, 0, errcode);\r\nPROTO_ITEM_SET_HIDDEN(hidden_item);\r\np = try_val_to_str(errcode, VALS(h450_str_error));\r\nif (p) {\r\nproto_item_append_text(rctx->d.code_item, " - %s", p);\r\nif (rctx->apdu_depth >= 0)\r\nproto_item_append_text(proto_item_get_parent_nth(proto_tree_get_parent(tree), rctx->apdu_depth), " %s", p);\r\n}\r\nif (err_ptr->err_pdu && (tvb_reported_length_remaining(tvb, offset) > 0))\r\noffset = err_ptr->err_pdu(tvb, pinfo, tree, NULL);\r\nelse\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_expert(tree, pinfo, &ei_h450_unsupported_error_type, tvb, offset, -1);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nreturn offset;\r\n}\r\nvoid proto_register_h450(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_h450_operation, { "Operation", "h450.operation",\r\nFT_UINT8, BASE_DEC, VALS(h450_str_operation), 0x0,\r\nNULL, HFILL }},\r\n{ &hf_h450_error, { "Error", "h450.error",\r\nFT_UINT8, BASE_DEC, VALS(h450_str_error), 0x0,\r\nNULL, HFILL }},\r\n#include "packet-h450-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n#include "packet-h450-ettarr.c"\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_h450_unsupported_arg_type, { "h450.unsupported.arg_type", PI_UNDECODED, PI_WARN, "UNSUPPORTED ARGUMENT TYPE (H.450)", EXPFILL }},\r\n{ &ei_h450_unsupported_result_type, { "h450.unsupported.result_type", PI_UNDECODED, PI_WARN, "UNSUPPORTED RESULT TYPE (H.450)", EXPFILL }},\r\n{ &ei_h450_unsupported_error_type, { "h450.unsupported.error_type", PI_UNDECODED, PI_WARN, "UNSUPPORTED ERROR TYPE (H.450)", EXPFILL }},\r\n};\r\nexpert_module_t* expert_h450;\r\nproto_h450 = proto_register_protocol(PNAME, PSNAME, PFNAME);\r\nregister_dissector("h4501", dissect_h450_H4501SupplementaryService_PDU, proto_h450);\r\nproto_register_field_array(proto_h450, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_h450 = expert_register_protocol(proto_h450);\r\nexpert_register_field_array(expert_h450, ei, array_length(ei));\r\nrose_ctx_init(&h450_rose_ctx);\r\nh450_rose_ctx.arg_global_dissector_table = register_dissector_table("h450.ros.global.arg", "H.450 Operation Argument (global opcode)", proto_h450, FT_STRING, BASE_NONE);\r\nh450_rose_ctx.res_global_dissector_table = register_dissector_table("h450.ros.global.res", "H.450 Operation Result (global opcode)", proto_h450, FT_STRING, BASE_NONE);\r\nh450_rose_ctx.arg_local_dissector_table = register_dissector_table("h450.ros.local.arg", "H.450 Operation Argument (local opcode)", proto_h450, FT_UINT32, BASE_HEX);\r\nh450_rose_ctx.res_local_dissector_table = register_dissector_table("h450.ros.local.res", "H.450 Operation Result (local opcode)", proto_h450, FT_UINT32, BASE_HEX);\r\nh450_rose_ctx.err_global_dissector_table = register_dissector_table("h450.ros.global.err", "H.450 Error (global opcode)", proto_h450, FT_STRING, BASE_NONE);\r\nh450_rose_ctx.err_local_dissector_table = register_dissector_table("h450.ros.local.err", "H.450 Error (local opcode)", proto_h450, FT_UINT32, BASE_HEX);\r\n}\r\nvoid\r\nproto_reg_handoff_h450(void)\r\n{\r\nint i;\r\ndissector_handle_t h450_arg_handle;\r\ndissector_handle_t h450_res_handle;\r\ndissector_handle_t h450_err_handle;\r\nh450_arg_handle = create_dissector_handle(dissect_h450_arg, proto_h450);\r\nh450_res_handle = create_dissector_handle(dissect_h450_res, proto_h450);\r\nfor (i=0; i<(int)array_length(h450_op_tab); i++) {\r\ndissector_add_uint("h450.ros.local.arg", h450_op_tab[i].opcode, h450_arg_handle);\r\ndissector_add_uint("h450.ros.local.res", h450_op_tab[i].opcode, h450_res_handle);\r\n}\r\nh450_err_handle = create_dissector_handle(dissect_h450_err, proto_h450);\r\nfor (i=0; i<(int)array_length(h450_err_tab); i++) {\r\ndissector_add_uint("h450.ros.local.err", h450_err_tab[i].errcode, h450_err_handle);\r\n}\r\n}

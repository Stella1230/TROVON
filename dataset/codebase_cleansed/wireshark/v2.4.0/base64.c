size_t ws_base64_decode_inplace(char *s)\r\n{\r\nstatic const char b64[] = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/\r\n";\r\nint bit_offset, byte_offset, idx, i;\r\nunsigned char *d = (unsigned char *)s;\r\nchar *p;\r\nint cr_idx;\r\ncr_idx = (int) (strchr(b64, '\r') - b64);\r\ni = 0;\r\nwhile (*s && (p=strchr(b64, *s))) {\r\nidx = (int)(p - b64);\r\nif(idx < cr_idx) {\r\nbyte_offset = (i*6)/8;\r\nbit_offset = (i*6)%8;\r\nd[byte_offset] &= ~((1<<(8-bit_offset))-1);\r\nif (bit_offset < 3) {\r\nd[byte_offset] |= (idx << (2-bit_offset));\r\n} else {\r\nd[byte_offset] |= (idx >> (bit_offset-2));\r\nd[byte_offset+1] = 0;\r\nd[byte_offset+1] |= (idx << (8-(bit_offset-2))) & 0xFF;\r\n}\r\ni++;\r\n}\r\ns++;\r\n}\r\nd[i*3/4] = 0;\r\nreturn i*3/4;\r\n}

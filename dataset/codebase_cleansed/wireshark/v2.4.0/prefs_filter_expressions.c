static void\r\nenable_toggled(GtkCellRendererToggle *cell _U_, gchar *path_str, gpointer data)\r\n{\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreeIter iter;\r\nGtkTreePath *path = gtk_tree_path_new_from_string(path_str);\r\nstruct filter_expression *fe;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fe, -1);\r\nfe->enabled = !fe->enabled;\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, ENABLED_COLUMN,\r\nfe->enabled, -1);\r\ngtk_tree_path_free(path);\r\n}\r\nGtkWidget *\r\nfilter_expressions_prefs_show(void) {\r\nGtkWidget *main_vb, *bottom_hb, *column_l, *add_bt, *remove_bt;\r\nGtkWidget *list_vb, *list_lb, *list_sc;\r\nGtkWidget *add_remove_hb;\r\nGtkListStore *store;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nGtkTreeSelection *sel;\r\nGtkTreeIter iter;\r\nGtkTreeIter first_iter;\r\ngint first_row = TRUE;\r\nstruct filter_expression *fe;\r\nstatic const gchar *column_titles[] = {"Enabled", "Label", "Filter Expression"};\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_widget_show(main_vb);\r\nlist_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(list_vb), 5);\r\ngtk_widget_show(list_vb);\r\ngtk_box_pack_start(GTK_BOX(main_vb), list_vb, TRUE, TRUE, 0);\r\nlist_lb = gtk_label_new(("[The first list entry will be displayed as the "\r\n"first button right of the Save button - Drag and drop entries to "\r\n"change column order]"));\r\ngtk_widget_show(list_lb);\r\ngtk_box_pack_start(GTK_BOX(list_vb), list_lb, FALSE, FALSE, 0);\r\nlist_sc = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(list_sc),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(list_vb), list_sc, TRUE, TRUE, 0);\r\ngtk_widget_show(list_sc);\r\nstore = gtk_list_store_new(N_COLUMN,\r\nG_TYPE_BOOLEAN, G_TYPE_STRING, G_TYPE_STRING,\r\nG_TYPE_POINTER);\r\ncolumn_l = tree_view_new(GTK_TREE_MODEL(store));\r\ngtk_tree_view_set_headers_visible(GTK_TREE_VIEW(column_l), TRUE);\r\ngtk_tree_view_set_headers_clickable(GTK_TREE_VIEW(column_l), FALSE);\r\ngtk_tree_view_set_reorderable(GTK_TREE_VIEW(column_l), TRUE);\r\ngtk_widget_set_tooltip_text(column_l, "Click on a label or expression to "\r\n"change its name.\nDrag an item to change its order.\nTick 'Enable' "\r\n"to enable the filter in the buttons.");\r\nrenderer = gtk_cell_renderer_toggle_new();\r\ng_signal_connect(renderer, "toggled", G_CALLBACK(enable_toggled), store);\r\ncolumn = gtk_tree_view_column_new_with_attributes(\r\ncolumn_titles[ENABLED_COLUMN], renderer, "active", ENABLED_COLUMN, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(column_l), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(G_OBJECT(renderer), "editable", TRUE, NULL);\r\ng_signal_connect(renderer, "edited",\r\nG_CALLBACK(filter_expressions_label_changed_cb), GTK_TREE_MODEL(store));\r\ncolumn = gtk_tree_view_column_new_with_attributes(\r\ncolumn_titles[LABEL_COLUMN], renderer, "text", LABEL_COLUMN, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(column_l), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(G_OBJECT(renderer), "editable", TRUE, NULL);\r\ng_signal_connect(renderer, "edited",\r\nG_CALLBACK(filter_expressions_expression_changed_cb),\r\nGTK_TREE_MODEL(store));\r\ncolumn = gtk_tree_view_column_new_with_attributes(\r\ncolumn_titles[EXPRESSION_COLUMN], renderer, "text", EXPRESSION_COLUMN, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(column_l), column);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(column_l));\r\ngtk_tree_selection_set_mode(sel, GTK_SELECTION_SINGLE);\r\ngtk_container_add(GTK_CONTAINER(list_sc), column_l);\r\ngtk_widget_show(column_l);\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nfe->filter_index = -1;\r\ngtk_list_store_insert_with_values(store, &iter, G_MAXINT,\r\nENABLED_COLUMN, fe->enabled,\r\nLABEL_COLUMN, fe->label,\r\nEXPRESSION_COLUMN, fe->expression,\r\nDATA_COLUMN, fe,\r\n-1);\r\nif (first_row) {\r\nfirst_iter = iter;\r\nfirst_row = FALSE;\r\n}\r\nfe = fe->next;\r\n}\r\ng_object_unref(G_OBJECT(store));\r\nbottom_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bottom_hb, FALSE, TRUE, 0);\r\ngtk_widget_show(bottom_hb);\r\nadd_remove_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, TRUE);\r\ngtk_container_set_border_width(GTK_CONTAINER(add_remove_hb), 5);\r\ngtk_box_pack_start(GTK_BOX(bottom_hb), add_remove_hb, FALSE, FALSE, 0);\r\ngtk_widget_show(add_remove_hb);\r\nadd_bt = ws_gtk_button_new_from_stock(GTK_STOCK_ADD);\r\ng_signal_connect(add_bt, "clicked",\r\nG_CALLBACK(filter_expressions_list_new_cb), column_l);\r\ngtk_box_pack_start(GTK_BOX(add_remove_hb), add_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(add_bt,\r\n"Add a new row at the end of the list.");\r\ngtk_widget_show(add_bt);\r\nremove_bt = ws_gtk_button_new_from_stock(GTK_STOCK_REMOVE);\r\ng_signal_connect(remove_bt, "clicked",\r\nG_CALLBACK(filter_expressions_list_remove_cb), column_l);\r\ngtk_box_pack_start(GTK_BOX(add_remove_hb), remove_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(remove_bt, "Remove the selected row.");\r\ngtk_widget_show(remove_bt);\r\nif (first_row == FALSE)\r\ngtk_tree_selection_select_iter(sel, &first_iter);\r\ng_object_set_data(G_OBJECT(main_vb), E_FILTER_EXPRESSION_COLUMNL, column_l);\r\ng_object_set_data(G_OBJECT(main_vb), E_FILTER_EXPRESSION_STORE, store);\r\nreturn(main_vb);\r\n}\r\nstatic void\r\nfilter_expressions_list_remove_cb(GtkWidget *w _U_, gpointer data)\r\n{\r\nGtkTreeView *column_l = GTK_TREE_VIEW(data);\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nstruct filter_expression *fe;\r\nsel = gtk_tree_view_get_selection(column_l);\r\nif (!gtk_tree_selection_get_selected(sel, &model, &iter))\r\nreturn;\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fe, -1);\r\nfe->deleted = TRUE;\r\ngtk_list_store_remove(GTK_LIST_STORE(model), &iter);\r\n}\r\nstatic void\r\nfilter_expressions_list_new_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nconst gchar *label = "New Label";\r\nconst gchar *expression = "New Expression";\r\nGtkTreeView *fe_l = GTK_TREE_VIEW(data);\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkTreePath *path;\r\nGtkTreeViewColumn *label_column;\r\nstruct filter_expression *fe;\r\nfe = filter_expression_new(label, expression, TRUE);\r\nmodel = gtk_tree_view_get_model(fe_l);\r\ngtk_list_store_insert_with_values(GTK_LIST_STORE(model), &iter, G_MAXINT,\r\nENABLED_COLUMN, fe->enabled,\r\nLABEL_COLUMN, fe->label,\r\nEXPRESSION_COLUMN, fe->expression,\r\nDATA_COLUMN, fe,\r\n-1);\r\ngtk_tree_selection_select_iter(gtk_tree_view_get_selection(fe_l), &iter);\r\npath = gtk_tree_model_get_path(model, &iter);\r\nlabel_column = gtk_tree_view_get_column(fe_l, 2);\r\ngtk_tree_view_set_cursor(fe_l, path, label_column, TRUE);\r\ngtk_tree_path_free(path);\r\n}\r\nstatic gboolean\r\nfilter_expressions_expression_changed_cb(GtkCellRendererText *cell _U_, const gchar *str_path, const gchar *new_expression, gpointer data)\r\n{\r\nstruct filter_expression *fe;\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreePath *path = gtk_tree_path_new_from_string(str_path);\r\nGtkTreeIter iter;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, EXPRESSION_COLUMN,\r\nnew_expression, -1);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fe, -1);\r\nif (fe != NULL) {\r\ng_free(fe->expression);\r\nfe->expression = g_strdup(new_expression);\r\n}\r\ngtk_tree_path_free(path);\r\nreturn(TRUE);\r\n}\r\nstatic gboolean\r\nfilter_expressions_label_changed_cb(GtkCellRendererText *cell _U_, const gchar *str_path, const gchar *new_label, gpointer data)\r\n{\r\nstruct filter_expression *fe;\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreePath *path = gtk_tree_path_new_from_string(str_path);\r\nGtkTreeIter iter;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, LABEL_COLUMN, new_label, -1);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fe, -1);\r\nif (fe != NULL) {\r\ng_free(fe->label);\r\nfe->label = g_strdup(new_label);\r\n}\r\ngtk_tree_path_free(path);\r\nreturn TRUE;\r\n}\r\nvoid\r\nfilter_expressions_prefs_fetch(GtkWidget *w)\r\n{\r\ngboolean items_left;\r\nGtkTreeModel *model;\r\nGtkTreeView *column_l;\r\nGtkTreeIter iter;\r\nGtkListStore *store;\r\nstruct filter_expression *fe;\r\ngint first_row = TRUE;\r\ngint indx = 0;\r\ncolumn_l = (GtkTreeView *)g_object_get_data(G_OBJECT(w),\r\nE_FILTER_EXPRESSION_COLUMNL);\r\nmodel = gtk_tree_view_get_model(column_l);\r\nstore = (GtkListStore *)g_object_get_data(G_OBJECT(w),\r\nE_FILTER_EXPRESSION_STORE);\r\nitems_left = gtk_tree_model_get_iter_first(model, &iter);\r\nwhile (items_left) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fe, -1);\r\nif (fe != NULL)\r\nfe->filter_index = indx++;\r\nitems_left = gtk_tree_model_iter_next (model, &iter);\r\n}\r\nfilter_expression_reinit(FILTER_EXPRESSION_REINIT_DESTROY | FILTER_EXPRESSION_REINIT_CREATE);\r\ngtk_list_store_clear(store);\r\nfe = *pfilter_expression_head;\r\nwhile (fe != NULL) {\r\nfe->filter_index = -1;\r\ngtk_list_store_insert_with_values(store, &iter, G_MAXINT,\r\nENABLED_COLUMN, fe->enabled,\r\nLABEL_COLUMN, fe->label,\r\nEXPRESSION_COLUMN, fe->expression,\r\nDATA_COLUMN, fe,\r\n-1);\r\nif (first_row) {\r\nfirst_row = FALSE;\r\n}\r\nfe = fe->next;\r\n}\r\n}

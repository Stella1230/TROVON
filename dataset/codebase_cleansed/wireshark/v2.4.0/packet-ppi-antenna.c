static int\r\ndissect_ppi_antenna(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_) {\r\nguint32 version;\r\nguint length;\r\ngint length_remaining;\r\nproto_tree *ppi_antenna_tree;\r\nproto_tree *pt;\r\nproto_item *antenna_line, *version_item, *length_item;\r\nint bit;\r\nguint32 present, next_present;\r\nguint8 gaindb;\r\nguint16 beamid;\r\nguint32 t_hbw, t_vbw, t_pgain, t_appspecific_num;\r\ngdouble horizbw, vertbw, pgain;\r\ngchar *curr_str;\r\nint offset = 0;\r\nstatic const int * ppi_antenna_present_flags[] = {\r\n&hf_ppi_antenna_present_flags,\r\n&hf_ppi_antenna_present_gaindb,\r\n&hf_ppi_antenna_present_horizbw,\r\n&hf_ppi_antenna_present_vertbw,\r\n&hf_ppi_antenna_present_pgain,\r\n&hf_ppi_antenna_present_beamid,\r\n&hf_ppi_antenna_present_serialnum,\r\n&hf_ppi_antenna_present_modelname,\r\n&hf_ppi_antenna_present_descstr,\r\n&hf_ppi_antenna_present_appspecific_num,\r\n&hf_ppi_antenna_present_appspecific_data,\r\n&hf_ppi_antenna_present_ext,\r\nNULL\r\n};\r\nstatic const int * ppi_antenna_ant_flags[] = {\r\n&hf_ppi_antennaflags_mimo,\r\n&hf_ppi_antennaflags_horizpol,\r\n&hf_ppi_antennaflags_vertpol,\r\n&hf_ppi_antennaflags_circpol_l,\r\n&hf_ppi_antennaflags_circpol_r,\r\n&hf_ppi_antennaflags_steer_elec,\r\n&hf_ppi_antennaflags_steer_mech,\r\nNULL\r\n};\r\ncol_clear(pinfo->cinfo,COL_INFO);\r\nversion = tvb_get_guint8(tvb, offset);\r\nlength = tvb_get_letohs(tvb, offset+2);\r\npresent = tvb_get_letohl(tvb, offset+4);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "PPI Antenna info v%u, Length %u",\r\nversion, length);\r\nantenna_line = proto_tree_add_protocol_format(tree, proto_ppi_antenna,\r\ntvb, 0, length, "Antenna: ");\r\nppi_antenna_tree = proto_item_add_subtree(antenna_line, ett_ppi_antenna);\r\nversion_item = proto_tree_add_uint(ppi_antenna_tree, hf_ppi_antenna_version,\r\ntvb, offset, 1, version);\r\nproto_tree_add_item(ppi_antenna_tree, hf_ppi_antenna_pad,\r\ntvb, offset + 1, 1, ENC_LITTLE_ENDIAN);\r\nlength_item = proto_tree_add_uint(ppi_antenna_tree, hf_ppi_antenna_length,\r\ntvb, offset + 2, 2, length);\r\nif (! (version == 1 || version == 2) ) {\r\nexpert_add_info_format(pinfo, version_item, &ei_ppi_antenna_version, "Invalid version (got %d, expected 1 or 2)", version);\r\n}\r\nlength_remaining = length;\r\nif (length_remaining < PPI_GEOBASE_MIN_HEADER_LEN) {\r\nexpert_add_info_format(pinfo, length_item, &ei_ppi_antenna_length, "Invalid PPI-Antenna length - minimum length is 8");\r\nreturn 2;\r\n}\r\nif (length > PPI_ANTENNA_MAXTAGLEN ) {\r\nexpert_add_info_format(pinfo, length_item, &ei_ppi_antenna_length, "Invalid PPI-Antenna length (got %d, %d max\n)", length, PPI_ANTENNA_MAXTAGLEN);\r\nreturn 2;\r\n}\r\npt = proto_tree_add_bitmask(ppi_antenna_tree, tvb, offset + 4, hf_ppi_antenna_present, ett_ppi_antenna_present, ppi_antenna_present_flags, ENC_LITTLE_ENDIAN);\r\noffset += PPI_GEOBASE_MIN_HEADER_LEN;\r\nlength_remaining -= PPI_GEOBASE_MIN_HEADER_LEN;\r\nfor (; present; present = next_present) {\r\nnext_present = present & (present - 1);\r\nbit = BITNO_32(present ^ next_present);\r\nswitch (bit) {\r\ncase PPI_ANTENNA_ANTFLAGS:\r\nif (length_remaining < 4)\r\nbreak;\r\nproto_tree_add_bitmask(ppi_antenna_tree, tvb, offset, hf_ppi_antenna_flags, ett_ppi_antennaflags, ppi_antenna_ant_flags, ENC_LITTLE_ENDIAN);\r\noffset+=4;\r\nlength_remaining-=4;\r\nbreak;\r\ncase PPI_ANTENNA_GAINDB:\r\nif (length_remaining < 1)\r\nbreak;\r\ngaindb = tvb_get_guint8(tvb, offset);\r\nif (tree) {\r\nproto_tree_add_uint(ppi_antenna_tree, hf_ppi_antenna_gaindb, tvb, offset, 1, gaindb);\r\nproto_item_append_text(antenna_line, " Gain: %d", gaindb);\r\n}\r\noffset+=1;\r\nlength_remaining-=1;\r\nbreak;\r\ncase PPI_ANTENNA_HORIZBW:\r\nif (length_remaining < 4)\r\nbreak;\r\nt_hbw = tvb_get_letohl(tvb, offset);\r\nhorizbw = ppi_fixed3_6_to_gdouble(t_hbw);\r\nif (tree) {\r\nproto_tree_add_double(ppi_antenna_tree, hf_ppi_antenna_horizbw, tvb, offset, 4, horizbw);\r\nproto_item_append_text(antenna_line, " HorizBw: %f", horizbw);\r\n}\r\noffset+=4;\r\nlength_remaining-=4;\r\nbreak;\r\ncase PPI_ANTENNA_VERTBW:\r\nif (length_remaining < 4)\r\nbreak;\r\nt_vbw = tvb_get_letohl(tvb, offset);\r\nvertbw = ppi_fixed3_6_to_gdouble(t_vbw);\r\nproto_tree_add_double(ppi_antenna_tree, hf_ppi_antenna_vertbw, tvb, offset, 4, vertbw);\r\noffset+=4;\r\nlength_remaining-=4;\r\nbreak;\r\ncase PPI_ANTENNA_PGAIN:\r\nif (length_remaining < 4)\r\nbreak;\r\nt_pgain = tvb_get_letohl(tvb, offset);\r\npgain = ppi_fixed3_6_to_gdouble(t_pgain);\r\nproto_tree_add_double(ppi_antenna_tree, hf_ppi_antenna_pgain, tvb, offset, 4, pgain);\r\noffset+=4;\r\nlength_remaining-=4;\r\nbreak;\r\ncase PPI_ANTENNA_BEAMID:\r\nif (length_remaining < 2)\r\nbreak;\r\nbeamid= tvb_get_letohs(tvb, offset);\r\nproto_tree_add_uint(ppi_antenna_tree, hf_ppi_antenna_beamid, tvb, offset, 2, beamid);\r\noffset+=2;\r\nlength_remaining-=2;\r\nbreak;\r\ncase PPI_ANTENNA_SERIALNUM:\r\nif (length_remaining < 32)\r\nbreak;\r\nproto_tree_add_item(ppi_antenna_tree, hf_ppi_antenna_serialnum, tvb, offset, 32, ENC_ASCII|ENC_NA);\r\noffset+=32;\r\nlength_remaining-=32;\r\nbreak;\r\ncase PPI_ANTENNA_MODELSTR:\r\nif (length_remaining < 32)\r\nbreak;\r\nif (tree) {\r\ncurr_str = tvb_format_stringzpad(tvb, offset, 32);\r\nproto_tree_add_string(ppi_antenna_tree, hf_ppi_antenna_modelname, tvb, offset, 32, curr_str);\r\nproto_item_append_text(antenna_line, " (%s)", curr_str);\r\n}\r\noffset+=32;\r\nlength_remaining-=32;\r\nbreak;\r\ncase PPI_ANTENNA_DESCSTR:\r\nif (length_remaining < 32)\r\nbreak;\r\nif (tree) {\r\ncurr_str = tvb_format_stringzpad(tvb, offset, 32);\r\nproto_tree_add_string(ppi_antenna_tree, hf_ppi_antenna_descstr, tvb, offset, 32, curr_str);\r\nproto_item_append_text(antenna_line, " (%s)", curr_str);\r\n}\r\noffset+=32;\r\nlength_remaining-=32;\r\nbreak;\r\ncase PPI_ANTENNA_APPID:\r\nif (length_remaining < 4)\r\nbreak;\r\nt_appspecific_num = tvb_get_letohl(tvb, offset);\r\nproto_tree_add_uint(ppi_antenna_tree, hf_ppi_antenna_appspecific_num, tvb, offset, 4, t_appspecific_num);\r\noffset+=4;\r\nlength_remaining-=4;\r\nbreak;\r\ncase PPI_ANTENNA_APPDATA:\r\nif (length_remaining < 60)\r\nbreak;\r\nproto_tree_add_item(ppi_antenna_tree, hf_ppi_antenna_appspecific_data, tvb, offset, 60, ENC_NA);\r\noffset+=60;\r\nlength_remaining-=60;\r\nbreak;\r\ndefault:\r\nexpert_add_info_format(pinfo, pt, &ei_ppi_antenna_present_bit,\r\n"Error: PPI-ANTENNA: unknown bit (%d) set in present field.", bit);\r\nnext_present = 0;\r\ncontinue;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ppi_antenna(void) {\r\nstatic hf_register_info hf[] = {\r\n{ &hf_ppi_antenna_version,\r\n{ "Header revision", "ppi_antenna.version",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Version of ppi_antenna header format", HFILL } },\r\n{ &hf_ppi_antenna_pad,\r\n{ "Header pad", "ppi_antenna.pad",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Padding", HFILL } },\r\n{ &hf_ppi_antenna_length,\r\n{ "Header length", "ppi_antenna.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Length of header including version, pad, length and data fields", HFILL } },\r\n{ &hf_ppi_antenna_flags,\r\n{ "Antenna flags", "ppi_antenna.antenna_flags",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, "Bitmask indicating polarity, etc", HFILL } },\r\n{ &hf_ppi_antenna_present,\r\n{ "Present", "ppi_antenna.present",\r\nFT_UINT32, BASE_HEX, NULL, 0x0, "Bitmask indicating which fields are present", HFILL } },\r\n#define PPI_ANTENNA_MASK_FLAGS 0x00000001\r\n#define PPI_ANTENNA_MASK_GAINDB 0x00000002\r\n#define PPI_ANTENNA_MASK_HORIZBW 0x00000004\r\n#define PPI_ANTENNA_MASK_VERTBW 0x00000008\r\n#define PPI_ANTENNA_MASK_PGAIN 0x00000010\r\n#define PPI_ANTENNA_MASK_BEAMID 0x00000020\r\n#define PPI_ANTENNA_MASK_RES7 0x00000080\r\n#define PPI_ANTENNA_MASK_SERIALNUM 0x04000000\r\n#define PPI_ANTENNA_MASK_MODELSTR 0x08000000\r\n#define PPI_ANTENNA_MASK_DESCSTR 0x10000000\r\n#define PPI_ANTENNA_MASK_APPID 0x20000000\r\n#define PPI_ANTENNA_MASK_APPDATA 0x40000000\r\n#define PPI_ANTENNA_MASK_EXT 0x80000000\r\n#define PPI_ANTENNAFLAGS_MASK_MIMO 0x00000001\r\n#define PPI_ANTENNAFLAGS_MASK_HPOL 0x00000002\r\n#define PPI_ANTENNAFLAGS_MASK_VPOL 0x00000004\r\n#define PPI_ANTENNAFLAGS_MASK_CPOL_L 0x00000008\r\n#define PPI_ANTENNAFLAGS_MASK_CPOL_R 0x00000010\r\n#define PPI_ANTENNAFLAGS_MASK_STEER_ELEC 0x00010000\r\n#define PPI_ANTENNAFLAGS_MASK_STEER_MECH 0x00020000\r\n{ &hf_ppi_antenna_present_flags,\r\n{ "flags", "ppi_antenna.present.flags",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_FLAGS,\r\n"Specifies if the flags bitfield is present", HFILL } },\r\n{ &hf_ppi_antenna_present_gaindb,\r\n{ "gaindb", "ppi_antenna.present.gaindb",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_GAINDB,\r\n"Specifies if the antenna gain field is present", HFILL } },\r\n{ &hf_ppi_antenna_present_horizbw,\r\n{ "horizbw", "ppi_antenna.present.horizbw",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_HORIZBW,\r\n"Specifies if the horizontal beamwidth field is present", HFILL } },\r\n{ &hf_ppi_antenna_present_vertbw,\r\n{ "vertbw", "ppi_antenna.present.vertbw",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_VERTBW,\r\n"Specifies if the vertical beamwidth field is present", HFILL } },\r\n{ &hf_ppi_antenna_present_pgain,\r\n{ "pgain", "ppi_antenna.present.pgain",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_PGAIN,\r\n"Specifies if the precision gain field is present", HFILL } },\r\n{ &hf_ppi_antenna_present_beamid,\r\n{ "beamid", "ppi_antenna.present.beamid",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_BEAMID,\r\n"Specifies if the BeamID field is present", HFILL } },\r\n{ &hf_ppi_antenna_present_serialnum,\r\n{ "serialnum", "ppi_antenna.present.serialnum",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_SERIALNUM,\r\n"Specifies if the serial num is present", HFILL } },\r\n{ &hf_ppi_antenna_present_modelname,\r\n{ "modelname", "ppi_antenna.present.modelname",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_MODELSTR,\r\n"Specifies if the model name is present", HFILL } },\r\n{ &hf_ppi_antenna_present_descstr,\r\n{ "Description", "ppi_antenna.present.descr",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_DESCSTR,\r\n"Specifies if the description string is present", HFILL } },\r\n{ &hf_ppi_antenna_present_appspecific_num,\r\n{ "appid", "ppi_antenna.present.appid",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_APPID,\r\n"Specifies if the application specific field id is present", HFILL } },\r\n{ &hf_ppi_antenna_present_appspecific_data,\r\n{ "appdata", "ppi_antenna.present.appdata",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_APPDATA,\r\n"Specifies if the application specific data field is present", HFILL } },\r\n{ &hf_ppi_antenna_present_ext,\r\n{ "ext", "ppi_antenna.present.ext",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNA_MASK_EXT,\r\n"Specifies if there are any extensions to the header present", HFILL } },\r\n{ &hf_ppi_antennaflags_mimo,\r\n{ "mimo", "ppi_antenna.antennaflags.mimo",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_MIMO,\r\n"Antenna is part of MIMO system", HFILL } },\r\n{ &hf_ppi_antennaflags_horizpol,\r\n{ "horizontally polarized", "ppi_antenna.antennaflags.horizpol",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_HPOL,\r\n"Specifies if the antenna is horizontally polarized", HFILL } },\r\n{ &hf_ppi_antennaflags_vertpol,\r\n{ "vertically polarized", "ppi_antenna.antennaflags.vertpol",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_VPOL,\r\n"Specifies if the antenna is vertically polarized", HFILL } },\r\n{ &hf_ppi_antennaflags_circpol_l,\r\n{ "circularly polarized left", "ppi_antenna.antennaflags.circpol_l",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_CPOL_L,\r\n"Specifies if the antenna is circularly polarized, left handed", HFILL } },\r\n{ &hf_ppi_antennaflags_circpol_r,\r\n{ "circularly polarized right", "ppi_antenna.antennaflags.circpol_r",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_CPOL_R,\r\n"Specifies if the antenna is circularly polarized, right handed", HFILL } },\r\n{ &hf_ppi_antennaflags_steer_elec,\r\n{ "electrically steerable", "ppi_antenna.antennaflags.steer_elec",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_STEER_ELEC,\r\n"Specifies if the antenna is electrically steerable", HFILL } },\r\n{ &hf_ppi_antennaflags_steer_mech,\r\n{ "mechanically steerable", "ppi_antenna.antennaflags.steer_mech",\r\nFT_BOOLEAN, 32, NULL, PPI_ANTENNAFLAGS_MASK_STEER_MECH,\r\n"Specifies if the antenna is mechanically steerable", HFILL } },\r\n{ &hf_ppi_antenna_gaindb,\r\n{ "Gain (dBi)", "ppi_antenna.gaindb",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Gain of antenna (dBi)", HFILL } },\r\n{ &hf_ppi_antenna_horizbw,\r\n{ "HorizBw", "ppi_antenna.horizbw",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\n"Horizontal beamwidth", HFILL } },\r\n{ &hf_ppi_antenna_vertbw,\r\n{ "VertBw", "ppi_antenna.vertbw",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\n"Vertical beamwidth", HFILL } },\r\n{ &hf_ppi_antenna_pgain,\r\n{ "Precision Gain (dBi)", "ppi_antenna.pgain",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL } },\r\n{ &hf_ppi_antenna_beamid,\r\n{ "BeamID", "ppi_antenna.beamid",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL } },\r\n{ &hf_ppi_antenna_serialnum,\r\n{ "SerialNumber", "ppi_antenna.serialnum",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL } } ,\r\n{ &hf_ppi_antenna_modelname,\r\n{ "ModelName", "ppi_antenna.modelname",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL } } ,\r\n{ &hf_ppi_antenna_descstr,\r\n{ "Description", "ppi_antenna.descr",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL } } ,\r\n{ &hf_ppi_antenna_appspecific_num,\r\n{ "Application Specific id", "ppi_antenna.appid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL } },\r\n{ &hf_ppi_antenna_appspecific_data,\r\n{ "Application specific data", "ppi_antenna.appdata",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL } },\r\n};\r\nstatic gint *ett[] = {\r\n&ett_ppi_antenna,\r\n&ett_ppi_antenna_present,\r\n&ett_ppi_antennaflags\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_ppi_antenna_present_bit, { "ppi_antenna.present.unknown_bit", PI_PROTOCOL, PI_WARN, "Error: PPI-ANTENNA: unknown bit set in present field.", EXPFILL }},\r\n{ &ei_ppi_antenna_version, { "ppi_antenna.version.unsupported", PI_PROTOCOL, PI_WARN, "Invalid version", EXPFILL }},\r\n{ &ei_ppi_antenna_length, { "ppi_antenna.length.invalid", PI_MALFORMED, PI_ERROR, "Invalid length", EXPFILL }},\r\n};\r\nexpert_module_t* expert_ppi_antenna;\r\nproto_ppi_antenna = proto_register_protocol("PPI antenna decoder", "PPI antenna Decoder", "ppi_antenna");\r\nproto_register_field_array(proto_ppi_antenna, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_ppi_antenna = expert_register_protocol(proto_ppi_antenna);\r\nexpert_register_field_array(expert_ppi_antenna, ei, array_length(ei));\r\nregister_dissector("ppi_antenna", dissect_ppi_antenna, proto_ppi_antenna);\r\n}

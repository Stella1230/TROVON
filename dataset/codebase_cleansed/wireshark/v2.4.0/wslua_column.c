void Push_Columns(lua_State *L, Columns c)\r\n{\r\ng_ptr_array_add(outstanding_Columns, c);\r\npushColumns(L, c);\r\n}\r\nstatic gint col_name_to_id(const gchar* name) {\r\nconst struct col_names_t* cn;\r\nfor(cn = colnames; cn->name; cn++) {\r\nif (g_str_equal(cn->name,name)) {\r\nreturn cn->id;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic const gchar* col_id_to_name(gint id) {\r\nconst struct col_names_t* cn;\r\nfor(cn = colnames; cn->name; cn++) {\r\nif ( cn->id == id ) {\r\nreturn cn->name;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nWSLUA_METAMETHOD Column__tostring(lua_State *L) {\r\nColumn c = checkColumn(L,1);\r\nconst gchar* text;\r\nif (!c->cinfo) {\r\ntext = col_id_to_name(c->col);\r\nlua_pushfstring(L, "(%s)", text ? text : "unknown");\r\n}\r\nelse {\r\ntext = col_get_text(c->cinfo, c->col);\r\nlua_pushstring(L, text ? text : "(nil)");\r\n}\r\nWSLUA_RETURN(1);\r\n}\r\nstatic int Column__gc(lua_State* L) {\r\nColumn col = toColumn(L,1);\r\nif (!col) return 0;\r\nif (!col->expired)\r\ncol->expired = TRUE;\r\nelse\r\ng_free(col);\r\nreturn 0;\r\n}\r\nWSLUA_METHOD Column_clear(lua_State *L) {\r\nColumn c = checkColumn(L,1);\r\nif (!(c->cinfo)) return 0;\r\ncol_clear(c->cinfo, c->col);\r\nreturn 0;\r\n}\r\nWSLUA_METHOD Column_set(lua_State *L) {\r\n#define WSLUA_ARG_Column_set_TEXT 2\r\nColumn c = checkColumn(L,1);\r\nconst gchar* s = luaL_checkstring(L,WSLUA_ARG_Column_set_TEXT);\r\nif (!(c->cinfo))\r\nreturn 0;\r\ncol_add_str(c->cinfo, c->col, s);\r\nreturn 0;\r\n}\r\nWSLUA_METHOD Column_append(lua_State *L) {\r\n#define WSLUA_ARG_Column_append_TEXT 2\r\nColumn c = checkColumn(L,1);\r\nconst gchar* s = luaL_checkstring(L,WSLUA_ARG_Column_append_TEXT);\r\nif (!(c->cinfo))\r\nreturn 0;\r\ncol_append_str(c->cinfo, c->col, s);\r\nreturn 0;\r\n}\r\nWSLUA_METHOD Column_prepend(lua_State *L) {\r\n#define WSLUA_ARG_Column_prepend_TEXT 2\r\nColumn c = checkColumn(L,1);\r\nconst gchar* s = luaL_checkstring(L,WSLUA_ARG_Column_prepend_TEXT);\r\nif (!(c->cinfo))\r\nreturn 0;\r\ncol_prepend_fstr(c->cinfo, c->col, "%s",s);\r\nreturn 0;\r\n}\r\nWSLUA_METHOD Column_fence(lua_State *L) {\r\nColumn c = checkColumn(L,1);\r\nif (c->cinfo)\r\ncol_set_fence(c->cinfo, c->col);\r\nreturn 0;\r\n}\r\nWSLUA_METHOD Column_clear_fence(lua_State *L) {\r\nColumn c = checkColumn(L,1);\r\nif (c->cinfo)\r\ncol_clear_fence(c->cinfo, c->col);\r\nreturn 0;\r\n}\r\nint Column_register(lua_State *L) {\r\nWSLUA_REGISTER_CLASS(Column);\r\noutstanding_Column = g_ptr_array_new();\r\nreturn 0;\r\n}\r\nWSLUA_METAMETHOD Columns__tostring(lua_State *L) {\r\nlua_pushstring(L,"Columns");\r\nWSLUA_RETURN(1);\r\n}\r\nWSLUA_METAMETHOD Columns__newindex(lua_State *L) {\r\n#define WSLUA_ARG_Columns__newindex_COLUMN 2\r\n#define WSLUA_ARG_Columns__newindex_TEXT 3\r\nColumns cols = checkColumns(L,1);\r\nconst struct col_names_t* cn;\r\nconst char* colname;\r\nconst char* text;\r\nif (!cols) return 0;\r\nif (cols->expired) {\r\nluaL_error(L,"expired column");\r\nreturn 0;\r\n}\r\ncolname = luaL_checkstring(L,WSLUA_ARG_Columns__newindex_COLUMN);\r\ntext = luaL_checkstring(L,WSLUA_ARG_Columns__newindex_TEXT);\r\nfor(cn = colnames; cn->name; cn++) {\r\nif( g_str_equal(cn->name,colname) ) {\r\ncol_add_str(cols->cinfo, cn->id, text);\r\nreturn 0;\r\n}\r\n}\r\nWSLUA_ARG_ERROR(Columns__newindex,COLUMN,"the column name must be a valid column");\r\nreturn 0;\r\n}\r\nWSLUA_METAMETHOD Columns__index(lua_State *L) {\r\nColumns cols = checkColumns(L,1);\r\nconst struct col_names_t* cn;\r\nconst char* colname = luaL_checkstring(L,2);\r\nif (!cols) {\r\nColumn c = (Column)g_malloc(sizeof(struct _wslua_col_info));\r\nc->cinfo = NULL;\r\nc->col = col_name_to_id(colname);\r\nc->expired = FALSE;\r\nPUSH_COLUMN(L,c);\r\nreturn 1;\r\n}\r\nif (cols->expired) {\r\nluaL_error(L,"expired column");\r\nreturn 0;\r\n}\r\nfor(cn = colnames; cn->name; cn++) {\r\nif( g_str_equal(cn->name,colname) ) {\r\nColumn c = (Column)g_malloc(sizeof(struct _wslua_col_info));\r\nc->cinfo = cols->cinfo;\r\nc->col = col_name_to_id(colname);\r\nc->expired = FALSE;\r\nPUSH_COLUMN(L,c);\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint get_Columns_index(lua_State *L)\r\n{\r\nreturn Columns__index(L);\r\n}\r\nstatic int Columns__gc(lua_State* L) {\r\nColumns cols = toColumns(L,1);\r\nif (!cols) return 0;\r\nif (!cols->expired)\r\ncols->expired = TRUE;\r\nelse\r\ng_free(cols);\r\nreturn 0;\r\n}\r\nint Columns_register(lua_State *L) {\r\nWSLUA_REGISTER_META(Columns);\r\noutstanding_Columns = g_ptr_array_new();\r\nreturn 0;\r\n}

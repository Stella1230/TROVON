void\r\ndissect_e164_number(tvbuff_t *tvb, proto_tree *tree, int offset, int length, e164_info_t e164_info)\r\n{\r\nproto_item *pi;\r\nswitch (e164_info.e164_number_type) {\r\ncase CALLING_PARTY_NUMBER:\r\nproto_tree_add_string(tree, hf_E164_calling_party_number, tvb, offset,\r\nlength, e164_info.E164_number_str);\r\nbreak;\r\ncase CALLED_PARTY_NUMBER:\r\nproto_tree_add_string(tree, hf_E164_called_party_number, tvb, offset,\r\nlength, e164_info.E164_number_str);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (e164_info.nature_of_address == E164_NA_INTERNATIONAL_NUMBER) {\r\npi = proto_tree_add_string(tree, hf_E164_number, tvb, offset, length, e164_info.E164_number_str);\r\nPROTO_ITEM_SET_HIDDEN(pi);\r\n}\r\n}\r\nstatic gboolean\r\nconvert_bcd_to_dec(guint16 bcd, guint16 * dec)\r\n{\r\ngboolean rok = TRUE;\r\nguint16 result = 0;\r\nguint16 mult = 1;\r\nwhile (bcd) {\r\nif ((bcd & 0x0f) > 9)\r\nrok = FALSE;\r\nresult += (bcd & 0x0f) * mult;\r\nbcd >>= 4;\r\nmult *= 10;\r\n}\r\n*dec = result;\r\nreturn rok;\r\n}\r\nvoid\r\ndissect_e164_cc(tvbuff_t *tvb, proto_tree *tree, int offset, e164_encoding_t encoding)\r\n{\r\nint cc_offset;\r\nguint8 address_digit_pair;\r\nguint16 id_code = 0;\r\nguint8 cc_length;\r\nguint8 length;\r\nguint16 cc = 0;\r\ngboolean bcd_ok = FALSE;\r\nproto_item *item = NULL;\r\ncc_offset = offset;\r\naddress_digit_pair = tvb_get_guint8(tvb, cc_offset);\r\nswitch (encoding) {\r\ncase E164_ENC_BINARY:\r\nwhile (address_digit_pair == 0) {\r\ncc_offset = cc_offset + 1;\r\naddress_digit_pair = tvb_get_guint8(tvb, cc_offset);\r\n}\r\ncc = tvb_get_ntohs(tvb, cc_offset);\r\nif ((address_digit_pair & 0xf0) != 0) {\r\ncc = cc >> 4;\r\n}\r\nbreak;\r\ncase E164_ENC_BCD:\r\ncc = address_digit_pair &0x0f;\r\ncc = cc << 4;\r\ncc = cc | (address_digit_pair &0xf0)>>4;\r\ncc = cc << 4;\r\nif (tvb_bytes_exist(tvb, cc_offset+1, 1)) {\r\naddress_digit_pair = tvb_get_guint8(tvb, cc_offset+1);\r\ncc = cc | (address_digit_pair &0x0f);\r\n}\r\nbreak;\r\ncase E164_ENC_UTF8:\r\ncc = (tvb_get_guint8(tvb, cc_offset) - '0') << 8;\r\ncc |= (tvb_get_guint8(tvb, cc_offset+1) - '0') << 4;\r\ncc |= (tvb_get_guint8(tvb, cc_offset+2) - '0');\r\nbreak;\r\n}\r\nswitch (cc & 0x0f00) {\r\ncase 0x0:\r\ncc_length = 1;\r\nbreak;\r\ncase 0x0100:\r\ncc_length = 1;\r\nbreak;\r\ncase 0x0200:\r\nswitch (cc & 0x00f0) {\r\ncase 0:\r\ncase 0x70:\r\ncc_length = 2;\r\nbreak;\r\ndefault:\r\ncc_length = 3;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x0300:\r\nswitch (cc & 0x00f0) {\r\ncase 0:\r\ncase 0x10:\r\ncase 0x20:\r\ncase 0x30:\r\ncase 0x40:\r\ncase 0x60:\r\ncase 0x90:\r\ncc_length = 2;\r\nbreak;\r\ndefault:\r\ncc_length = 3;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x0400:\r\nswitch (cc & 0x00f0) {\r\ncase 0x20:\r\ncc_length = 3;\r\nbreak;\r\ndefault:\r\ncc_length = 2;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x0500:\r\nswitch (cc & 0x00f0) {\r\ncase 0:\r\ncase 0x90:\r\ncc_length = 3;\r\nbreak;\r\ndefault:\r\ncc_length = 2;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x0600:\r\nswitch (cc & 0x00f0) {\r\ncase 0x70:\r\ncase 0x80:\r\ncase 0x90:\r\ncc_length = 3;\r\nbreak;\r\ndefault:\r\ncc_length = 2;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x0700:\r\ncc_length = 1;\r\nbreak;\r\ncase 0x0800:\r\nswitch (cc & 0x00f0) {\r\ncase 0x10:\r\ncase 0x20:\r\ncase 0x40:\r\ncase 0x60:\r\ncc_length = 2;\r\nbreak;\r\ndefault:\r\ncc_length = 3;\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x0900:\r\nswitch (cc & 0x00f0) {\r\ncase 0:\r\ncase 0x10:\r\ncase 0x20:\r\ncase 0x30:\r\ncase 0x40:\r\ncase 0x50:\r\ncase 0x80:\r\ncc_length = 2;\r\nbreak;\r\ndefault:\r\ncc_length = 3;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\ncc_length = 0;\r\nbreak;\r\n}\r\nswitch (cc_length) {\r\ncase 1:\r\ncc = cc >> 8;\r\nlength = 1;\r\nbreak;\r\ncase 2:\r\ncc = cc >> 4;\r\nlength = 1;\r\nbreak;\r\ndefault:\r\nlength = 2;\r\nbreak;\r\n}\r\nbcd_ok = convert_bcd_to_dec(cc, &cc);\r\nif (encoding == E164_ENC_UTF8)\r\nitem = proto_tree_add_uint(tree, hf_E164_country_code, tvb, cc_offset, cc_length, cc);\r\nelse\r\nitem = proto_tree_add_uint(tree, hf_E164_country_code, tvb, cc_offset, length, cc);\r\nif (!bcd_ok) {\r\nexpert_add_info(NULL, item, &ei_E164_country_code_non_decimal);\r\n}\r\nswitch (cc) {\r\ncase 881:\r\nswitch (encoding) {\r\ncase E164_ENC_BINARY:\r\nid_code = tvb_get_guint8(tvb, cc_offset + 1) & 0x0f;\r\nbreak;\r\ncase E164_ENC_BCD:\r\nid_code = (tvb_get_guint8(tvb, cc_offset + 1) & 0xf0) >> 4;\r\nbreak;\r\ncase E164_ENC_UTF8:\r\nid_code = tvb_get_guint8(tvb, cc_offset + cc_length) - '0';\r\nbreak;\r\n}\r\nbcd_ok = (id_code <= 9);\r\nitem = proto_tree_add_uint_format_value(tree, hf_E164_identification_code, tvb, (cc_offset + 1), 1,\r\nid_code, "%d %s", id_code, val_to_str_const(id_code, E164_GMSS_vals, "Unknown"));\r\nif (!bcd_ok) {\r\nexpert_add_info(NULL, item, &ei_E164_identification_code_non_decimal);\r\n}\r\nbreak;\r\ncase 882:\r\nswitch (encoding) {\r\ncase E164_ENC_BINARY:\r\nid_code = tvb_get_ntohs(tvb, cc_offset + 1);\r\nid_code = (id_code & 0x0ff0) >> 4;\r\nbreak;\r\ncase E164_ENC_BCD:\r\nid_code = tvb_get_guint8(tvb, cc_offset + 1) & 0xf0;\r\nid_code |= tvb_get_guint8(tvb, cc_offset + 2) & 0x0f;\r\nbreak;\r\ncase E164_ENC_UTF8:\r\nid_code = (tvb_get_guint8(tvb, cc_offset+cc_length) - '0') << 4;\r\nid_code |= (tvb_get_guint8(tvb, cc_offset+cc_length+1) - '0');\r\nbreak;\r\n}\r\nbcd_ok = convert_bcd_to_dec(id_code, &id_code);\r\nitem = proto_tree_add_uint_format_value(tree, hf_E164_identification_code, tvb, (cc_offset + 1), 2,\r\nid_code, "%d %s", id_code, val_to_str_ext_const(id_code, &E164_International_Networks_882_vals_ext, "Unknown"));\r\nif (!bcd_ok) {\r\nexpert_add_info(NULL, item, &ei_E164_identification_code_non_decimal);\r\n}\r\nbreak;\r\ncase 883:\r\nswitch (encoding) {\r\ncase E164_ENC_BINARY:\r\nid_code = tvb_get_ntohs(tvb, cc_offset + 1);\r\nid_code = id_code & 0x0fff;\r\nbreak;\r\ncase E164_ENC_BCD:\r\nid_code = (tvb_get_guint8(tvb, cc_offset + 1) & 0xf0) << 4;\r\nid_code |= (tvb_get_guint8(tvb, cc_offset + 2) & 0x0f) << 4;\r\nid_code |= (tvb_get_guint8(tvb, cc_offset + 2) & 0xf0) >> 4;\r\nbreak;\r\ncase E164_ENC_UTF8:\r\nid_code = (tvb_get_guint8(tvb, cc_offset+cc_length) - '0') << 8;\r\nid_code |= (tvb_get_guint8(tvb, cc_offset+cc_length+1) - '0') << 4;\r\nid_code |= (tvb_get_guint8(tvb, cc_offset+cc_length+2) - '0');\r\nbreak;\r\n}\r\nif ((id_code & 0x0ff0) == 0x510) {\r\nswitch (encoding) {\r\ncase E164_ENC_BINARY:\r\nid_code = (id_code << 4) | ((tvb_get_guint8(tvb, cc_offset + 3) & 0xf0) >> 4);\r\nbreak;\r\ncase E164_ENC_BCD:\r\nid_code = (id_code << 4) | (tvb_get_guint8(tvb, cc_offset + 3) & 0x0f);\r\nbreak;\r\ncase E164_ENC_UTF8:\r\nid_code = (id_code << 4) | (tvb_get_guint8(tvb, cc_offset + cc_length + 3) - '0');\r\nbreak;\r\n}\r\nbcd_ok = convert_bcd_to_dec(id_code, &id_code);\r\nitem = proto_tree_add_uint_format_value(tree, hf_E164_identification_code, tvb, (cc_offset + 1), 3,\r\nid_code, "%d %s", id_code, val_to_str_const(id_code, E164_International_Networks_883_vals, "Unknown"));\r\nif (!bcd_ok) {\r\nexpert_add_info(NULL, item, &ei_E164_identification_code_non_decimal);\r\n}\r\n} else {\r\nbcd_ok = convert_bcd_to_dec(id_code, &id_code);\r\nitem = proto_tree_add_uint_format_value(tree, hf_E164_identification_code, tvb, (cc_offset + 1), 2,\r\nid_code, "%d %s", id_code, val_to_str_const(id_code, E164_International_Networks_883_vals, "Unknown"));\r\nif (!bcd_ok) {\r\nexpert_add_info(NULL, item, &ei_E164_identification_code_non_decimal);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nconst gchar *\r\ndissect_e164_msisdn(tvbuff_t *tvb, proto_tree *tree, int offset, int length, e164_encoding_t encoding)\r\n{\r\nproto_item *pi;\r\nproto_tree *subtree;\r\nconst gchar *msisdn_str;\r\nswitch (encoding) {\r\ncase E164_ENC_UTF8:\r\nmsisdn_str = tvb_get_string_enc(wmem_packet_scope(), tvb, offset, length, ENC_UTF_8);\r\nbreak;\r\ncase E164_ENC_BCD:\r\nmsisdn_str = tvb_bcd_dig_to_wmem_packet_str(tvb, offset, length, NULL, FALSE);\r\nbreak;\r\ncase E164_ENC_BINARY:\r\ndefault:\r\nDISSECTOR_ASSERT_NOT_REACHED();\r\n}\r\npi = proto_tree_add_string(tree, hf_E164_number, tvb, offset, length, msisdn_str);\r\nsubtree = proto_item_add_subtree(pi, ett_e164_msisdn);\r\ndissect_e164_cc(tvb, subtree, offset, encoding);\r\nreturn msisdn_str;\r\n}\r\nvoid\r\nproto_register_e164(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_E164_calling_party_number,\r\n{ "E.164 Calling party number digits", "e164.calling_party_number.digits",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_E164_called_party_number,\r\n{ "E.164 Called party number digits", "e164.called_party_number.digits",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_E164_number,\r\n{ "E.164 number (MSISDN)", "e164.msisdn",\r\nFT_STRING, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_E164_identification_code,\r\n{ "Identification Code", "e164.identification_code",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_E164_country_code,\r\n{ "Country Code", "e164.country_code",\r\nFT_UINT16, BASE_DEC|BASE_EXT_STRING, &E164_country_code_value_ext, 0x0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett_e164_array[] = {\r\n&ett_e164_msisdn,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_E164_country_code_non_decimal, { "e164.country_code.non_decimal", PI_MALFORMED, PI_WARN, "Country Code contains non-decimal digits", EXPFILL }},\r\n{ &ei_E164_identification_code_non_decimal, { "e164.identification_code.non_decimal", PI_MALFORMED, PI_WARN, "Identification Code contains non-decimal digits", EXPFILL }},\r\n};\r\nexpert_module_t* expert_e164;\r\nproto_e164 = proto_register_protocol("ITU-T E.164 number", "E.164", "e164");\r\nproto_register_field_array(proto_e164, hf, array_length(hf));\r\nproto_register_subtree_array(ett_e164_array, array_length(ett_e164_array));\r\nexpert_e164 = expert_register_protocol(proto_e164);\r\nexpert_register_field_array(expert_e164, ei, array_length(ei));\r\n}

static const char *\r\nws_get_next_media_type_parameter(const char *pos, gsize *retnamelen,\r\nconst char **retvalue, gsize *retvaluelen,\r\nconst char **nextp)\r\n{\r\nconst char *p, *namep, *valuep;\r\nchar c;\r\np = pos;\r\nwhile ((c = *p) != '\0' && g_ascii_isspace(c))\r\np++;\r\nif (c == '\0') {\r\nreturn NULL;\r\n}\r\nnamep = p;\r\nwhile ((c = *p) != '\0' && c != '=' && c != ';')\r\np++;\r\n*retnamelen = (gsize) (p - namep);\r\nif (c == '\0') {\r\nif (retvalue != NULL)\r\n*retvalue = NULL;\r\nif (retvaluelen != NULL)\r\n*retvaluelen = 0;\r\n*nextp = p;\r\nreturn namep;\r\n}\r\nif (c == ';') {\r\nif (retvalue != NULL)\r\n*retvalue = NULL;\r\nif (retvaluelen != NULL)\r\n*retvaluelen = 0;\r\n*nextp = p + 1;\r\nreturn namep;\r\n}\r\np++;\r\nvaluep = p;\r\nif (retvalue != NULL)\r\n*retvalue = valuep;\r\nif (*p == '"') {\r\np++;\r\nfor (;;) {\r\nc = *p;\r\nif (c == '\0') {\r\nif (retvaluelen != NULL) {\r\n*retvaluelen = (gsize) (p - valuep);\r\n}\r\n*nextp = p;\r\nreturn namep;\r\n}\r\nif (c == '"') {\r\np++;\r\nbreak;\r\n}\r\nif (c == '\\') {\r\np++;\r\nif (*p == '\0') {\r\nbreak;\r\n}\r\n}\r\np++;\r\n}\r\nwhile ((c = *p) != '\0' && c != ';')\r\np++;\r\n} else {\r\nwhile ((c = *p) != '\0' && c != ';')\r\np++;\r\n}\r\nif (c == '\0') {\r\nif (retvaluelen != NULL) {\r\n*retvaluelen = (gsize) (p - valuep);\r\n}\r\n*nextp = p;\r\nreturn namep;\r\n}\r\nif (retvaluelen != NULL) {\r\n*retvaluelen = (gsize) (p - valuep);\r\n}\r\n*nextp = p + 1;\r\nreturn namep;\r\n}\r\nchar *\r\nws_find_media_type_parameter(const char *parameters, const char *key)\r\n{\r\nconst char *p, *name, *value;\r\nchar c;\r\ngsize keylen, namelen, valuelen;\r\nchar *valuestr, *vp;\r\nif (parameters == NULL || key == NULL)\r\nreturn NULL;\r\nkeylen = (gsize) strlen(key);\r\nif (keylen == 0) {\r\nreturn NULL;\r\n}\r\np = parameters;\r\nif (*p == '\0') {\r\nreturn NULL;\r\n}\r\ndo {\r\nname = ws_get_next_media_type_parameter(p, &namelen, &value,\r\n&valuelen, &p);\r\nif (name == NULL) {\r\nreturn NULL;\r\n}\r\nif (namelen == keylen && g_ascii_strncasecmp(name, key, keylen) == 0) {\r\nbreak;\r\n}\r\n} while (*p);\r\nif (value == NULL) {\r\nreturn NULL;\r\n}\r\nvaluestr = (char *)g_malloc(valuelen + 1);\r\nvp = valuestr;\r\np = value;\r\nif (*p == '"') {\r\np++;\r\nfor (;;) {\r\nc = *p;\r\nif (c == '\0') {\r\n*vp = '\0';\r\nreturn valuestr;\r\n}\r\nif (c == '"') {\r\np++;\r\nbreak;\r\n}\r\nif (c == '\\') {\r\np++;\r\nif (*p == '\0') {\r\nbreak;\r\n}\r\n}\r\n*vp++ = *p++;\r\n}\r\n} else {\r\nwhile ((c = *p) != '\0' && g_ascii_isgraph(c) && c != '(' &&\r\nc != ')' && c != '<' && c != '>' && c != '@' &&\r\nc != ',' && c != ';' && c != ':' && c != '\\' &&\r\nc != '"' && c != '/' && c != '[' && c != ']' &&\r\nc != '?' && c != '=' && c != '{' && c != '}') {\r\n*vp++ = c;\r\np++;\r\n}\r\n}\r\n*vp = '\0';\r\nreturn valuestr;\r\n}

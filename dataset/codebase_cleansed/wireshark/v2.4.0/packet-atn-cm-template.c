static int\r\ndissect_atn_cm(\r\ntvbuff_t *tvb,\r\npacket_info *pinfo,\r\nproto_tree *tree,\r\nvoid *data _U_)\r\n{\r\nint type;\r\nproto_tree *sub_tree;\r\nsub_tree = proto_tree_add_subtree(\r\ntree, tvb, 0, -1, ett_atn_cm, NULL, ATN_CM_PROTO);\r\ntype = check_heur_msg_type(pinfo);\r\nswitch(type){\r\ncase um:\r\ndissect_CMGroundMessage_PDU(\r\ntvb,\r\npinfo,\r\nsub_tree, NULL);\r\nbreak;\r\ncase dm:\r\ndissect_CMAircraftMessage_PDU(\r\ntvb,\r\npinfo,\r\nsub_tree, NULL);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn tvb_reported_length_remaining(tvb, 0);\r\n}\r\nstatic gboolean\r\ndissect_atn_cm_heur(\r\ntvbuff_t *tvb,\r\npacket_info *pinfo,\r\nproto_tree *tree,\r\nvoid *data _U_)\r\n{\r\natn_conversation_t *volatile atn_cv = NULL;\r\nvolatile gboolean is_atn_cm = FALSE;\r\nint type;\r\ntype = check_heur_msg_type(pinfo);\r\nswitch(type){\r\ncase um:\r\nTRY {\r\ndissect_CMGroundMessage_PDU(\r\ntvb,\r\npinfo,\r\nNULL, NULL);\r\nis_atn_cm = TRUE; }\r\nCATCH_ALL {\r\nis_atn_cm = FALSE; }\r\nENDTRY;\r\nbreak;\r\ncase dm:\r\nTRY {\r\ndissect_CMAircraftMessage_PDU(\r\ntvb,\r\npinfo,\r\nNULL, NULL);\r\nis_atn_cm = TRUE;}\r\nCATCH_ALL {\r\nis_atn_cm = FALSE; }\r\nENDTRY;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (is_atn_cm == TRUE) {\r\nif((pinfo->clnp_dstref) &&\r\n(!pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(\r\n&pinfo->dst,\r\npinfo->clnp_dstref,\r\n&pinfo->src );\r\n}\r\nif((!pinfo->clnp_dstref) &&\r\n(pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(\r\n&pinfo->src,\r\npinfo->clnp_srcref,\r\n&pinfo->dst );\r\n}\r\nif((pinfo->clnp_dstref) &&\r\n(pinfo->clnp_srcref)){\r\natn_cv = find_atn_conversation(\r\n&pinfo->src,\r\npinfo->clnp_srcref,\r\n&pinfo->dst );\r\n}\r\nif(atn_cv){\r\natn_cv->ae_qualifier = cma;\r\n}\r\ndissect_atn_cm(\r\ntvb,\r\npinfo,\r\ntree,\r\nNULL);\r\n}\r\nreturn is_atn_cm;\r\n}\r\nvoid proto_register_atn_cm (void)\r\n{\r\nstatic hf_register_info hf_atn_cm[] = {\r\n#include "packet-atn-cm-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n#include "packet-atn-cm-ettarr.c"\r\n&ett_atn_cm\r\n};\r\nproto_atn_cm = proto_register_protocol(\r\nATN_CM_PROTO ,\r\n"ATN-CM",\r\n"atn-cm");\r\nproto_register_field_array(\r\nproto_atn_cm,\r\nhf_atn_cm,\r\narray_length(hf_atn_cm));\r\nproto_register_subtree_array(\r\nett,\r\narray_length(ett));\r\nregister_dissector(\r\n"atn-cm",\r\ndissect_atn_cm,\r\nproto_atn_cm);\r\n}\r\nvoid proto_reg_handoff_atn_cm(void)\r\n{\r\nheur_dissector_add(\r\n"atn-ulcs",\r\ndissect_atn_cm_heur,\r\n"ATN-CM over ATN-ULCS",\r\n"atn-cm-ulcs",\r\nproto_atn_cm, HEURISTIC_ENABLE);\r\n}

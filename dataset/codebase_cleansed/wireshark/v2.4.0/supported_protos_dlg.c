void supported_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nGtkWidget *main_vb, *bbox, *supported_nb, *ok_bt, *label, *txt_scrollw,\r\n*proto_vb,\r\n*dfilter_vb;\r\nif (supported_w != NULL) {\r\nreactivate_window(supported_w);\r\nreturn;\r\n}\r\nsupported_w = window_new(GTK_WINDOW_TOPLEVEL, "Wireshark: Supported Protocols");\r\ngtk_window_set_default_size(GTK_WINDOW(supported_w), DEF_WIDTH * 2/3, DEF_HEIGHT * 2/3);\r\ngtk_container_set_border_width(GTK_CONTAINER(supported_w), 2);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 1);\r\ngtk_container_add(GTK_CONTAINER(supported_w), main_vb);\r\ngtk_widget_show(main_vb);\r\nsupported_nb = gtk_notebook_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), supported_nb, TRUE, TRUE, 0);\r\nproto_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(proto_vb), 1);\r\ntxt_scrollw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(txt_scrollw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(proto_vb), txt_scrollw, TRUE, TRUE, 0);\r\nproto_text = gtk_text_view_new();\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(proto_text), FALSE);\r\nset_supported_text(proto_text, PROTOCOL_SUPPORTED);\r\ngtk_container_add(GTK_CONTAINER(txt_scrollw), proto_text);\r\ngtk_widget_show(txt_scrollw);\r\ngtk_widget_show(proto_text);\r\ngtk_widget_show(proto_vb);\r\nlabel = gtk_label_new("Protocols");\r\ngtk_notebook_append_page(GTK_NOTEBOOK(supported_nb), proto_vb, label);\r\ndfilter_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(dfilter_vb), 1);\r\ntxt_scrollw = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(txt_scrollw),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(dfilter_vb), txt_scrollw, TRUE, TRUE, 0);\r\ndfilter_text = gtk_text_view_new();\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(dfilter_text), FALSE);\r\nset_supported_text(dfilter_text, DFILTER_SUPPORTED);\r\ngtk_container_add(GTK_CONTAINER(txt_scrollw), dfilter_text);\r\ngtk_widget_show(txt_scrollw);\r\ngtk_widget_show(dfilter_text);\r\ngtk_widget_show(dfilter_vb);\r\nlabel = gtk_label_new("Display Filter Fields");\r\ngtk_notebook_append_page(GTK_NOTEBOOK(supported_nb), dfilter_vb, label);\r\ngtk_widget_show(supported_nb);\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, NULL);\r\ngtk_box_pack_end(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\nwindow_set_cancel_button(supported_w, ok_bt, window_cancel_button_cb);\r\ng_signal_connect(supported_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(supported_w, "destroy", G_CALLBACK(supported_destroy_cb), NULL);\r\ngtk_widget_show(supported_w);\r\nwindow_present(supported_w);\r\n}\r\nstatic void supported_destroy_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nsupported_w = NULL;\r\n}\r\nstatic void insert_text(GtkWidget *w, const char *buffer, int nchars)\r\n{\r\nGtkTextBuffer *buf= gtk_text_view_get_buffer(GTK_TEXT_VIEW(w));\r\nGtkTextIter iter;\r\ngtk_text_buffer_get_end_iter(buf, &iter);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(w, user_font_get_regular());\r\n#else\r\ngtk_widget_modify_font(w, user_font_get_regular());\r\n#endif\r\nif (!g_utf8_validate(buffer, -1, NULL))\r\nprintf("Invalid utf8 encoding: %s\n", buffer);\r\ngtk_text_buffer_insert(buf, &iter, buffer, nchars);\r\n}\r\nstatic void set_supported_text(GtkWidget *w, supported_type_t type)\r\n{\r\n#define BUFF_LEN 4096\r\n#define B_LEN 256\r\nchar buffer[BUFF_LEN];\r\nheader_field_info *hfinfo;\r\nint i, len, maxlen = 0, maxlen2 = 0, maxlen4 = 0;\r\nconst char *type_name;\r\nvoid *cookie, *cookie2;\r\nprotocol_t *protocol;\r\nconst char *name, *short_name, *filter_name;\r\nint namel = 0, short_namel = 0, filter_namel = 0;\r\nint count, fcount;\r\nswitch(type) {\r\ncase PROTOCOL_SUPPORTED :\r\ncount = 0;\r\nfor (i = proto_get_first_protocol(&cookie); i != -1;\r\ni = proto_get_next_protocol(&cookie)) {\r\ncount++;\r\nprotocol = find_protocol_by_id(i);\r\nname = proto_get_protocol_name(i);\r\nshort_name = proto_get_protocol_short_name(protocol);\r\nfilter_name = proto_get_protocol_filter_name(i);\r\nif ((len = (int) strlen(name)) > namel)\r\nnamel = len;\r\nif ((len = (int) strlen(short_name)) > short_namel)\r\nshort_namel = len;\r\nif ((len = (int) strlen(filter_name)) > filter_namel)\r\nfilter_namel = len;\r\n}\r\nlen = g_snprintf(buffer, BUFF_LEN, proto_supported, count);\r\ninsert_text(w, buffer, len);\r\nfor (i = proto_get_first_protocol(&cookie); i != -1;\r\ni = proto_get_next_protocol(&cookie)) {\r\nprotocol = find_protocol_by_id(i);\r\nname = proto_get_protocol_name(i);\r\nshort_name = proto_get_protocol_short_name(protocol);\r\nfilter_name = proto_get_protocol_filter_name(i);\r\nlen = g_snprintf(buffer, BUFF_LEN, "%*s %*s %*s\n",\r\n-short_namel, short_name,\r\n-namel, name,\r\n-filter_namel, filter_name);\r\ninsert_text(w, buffer, len);\r\n}\r\nbreak;\r\ncase DFILTER_SUPPORTED :\r\nfor (i = proto_get_first_protocol(&cookie); i != -1;\r\ni = proto_get_next_protocol(&cookie)) {\r\nfor (hfinfo = proto_get_first_protocol_field(i, &cookie2); hfinfo != NULL;\r\nhfinfo = proto_get_next_protocol_field(i, &cookie2)) {\r\nif (hfinfo->same_name_prev_id != -1)\r\ncontinue;\r\nif ((len = (int) strlen(hfinfo->abbrev)) > maxlen)\r\nmaxlen = len;\r\nif ((len = (int) strlen(hfinfo->name)) > maxlen2)\r\nmaxlen2 = len;\r\nif (hfinfo->blurb != NULL) {\r\nif ((len = (int) strlen(hfinfo->blurb)) > maxlen4)\r\nmaxlen4 = len;\r\n}\r\n}\r\n}\r\ninsert_text(w, dfilter_supported, (int) strlen(dfilter_supported));\r\nfcount = 0;\r\nfor (i = proto_get_first_protocol(&cookie); i != -1;\r\ni = proto_get_next_protocol(&cookie)) {\r\nprotocol = find_protocol_by_id(i);\r\nname = proto_get_protocol_name(i);\r\nshort_name = proto_get_protocol_short_name(protocol);\r\nfilter_name = proto_get_protocol_filter_name(i);\r\ncount = 0;\r\nfor (hfinfo = proto_get_first_protocol_field(i, &cookie2); hfinfo != NULL;\r\nhfinfo = proto_get_next_protocol_field(i, &cookie2)) {\r\nif (hfinfo->same_name_prev_id != -1)\r\ncontinue;\r\ncount++;\r\n}\r\nfcount += count;\r\nlen = g_snprintf(buffer, BUFF_LEN, "\n%s - %s (%s) [%d fields]:\n",\r\nshort_name, name, filter_name, count);\r\ninsert_text(w, buffer, len);\r\nfor (hfinfo = proto_get_first_protocol_field(i, &cookie2); hfinfo != NULL;\r\nhfinfo = proto_get_next_protocol_field(i, &cookie2)) {\r\nif (hfinfo->same_name_prev_id != -1)\r\ncontinue;\r\ntype_name = ftype_pretty_name(hfinfo->type);\r\nif (hfinfo->blurb != NULL && hfinfo->blurb[0] != '\0') {\r\nlen = g_snprintf(buffer, BUFF_LEN, "%*s %*s %*s (%s)\n",\r\n-maxlen, hfinfo->abbrev,\r\n-maxlen2, hfinfo->name,\r\n-maxlen4, hfinfo->blurb,\r\ntype_name);\r\n} else {\r\nlen = g_snprintf(buffer, BUFF_LEN, "%*s %*s (%s)\n",\r\n-maxlen, hfinfo->abbrev,\r\n-maxlen2, hfinfo->name,\r\ntype_name);\r\n}\r\ninsert_text(w, buffer, len);\r\n}\r\n}\r\nlen = g_snprintf(buffer, BUFF_LEN, "\n-- Total %d fields\n", fcount);\r\ninsert_text(w, buffer, len);\r\nbreak;\r\ndefault :\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\n}\r\nstatic void clear_supported_text(GtkWidget *w)\r\n{\r\nGtkTextBuffer *buf = gtk_text_view_get_buffer(GTK_TEXT_VIEW(w));\r\ngtk_text_buffer_set_text(buf, "", 0);\r\n}\r\nvoid supported_redraw(void)\r\n{\r\nif (supported_w != NULL) {\r\nclear_supported_text(proto_text);\r\nset_supported_text(proto_text, PROTOCOL_SUPPORTED);\r\nclear_supported_text(dfilter_text);\r\nset_supported_text(dfilter_text, DFILTER_SUPPORTED);\r\n}\r\n}

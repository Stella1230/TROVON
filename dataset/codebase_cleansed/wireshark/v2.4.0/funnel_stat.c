static void text_window_cancel_button_cb(GtkWidget *bt _U_, gpointer data) {\r\nfunnel_text_window_t* tw = (funnel_text_window_t *)data;\r\nwindow_destroy(GTK_WIDGET(tw->win));\r\ntw->win = NULL;\r\nif (tw->close_cb)\r\ntw->close_cb(tw->close_data);\r\n}\r\nstatic void unref_text_win_cancel_bt_cb(GtkWidget *bt _U_, gpointer data) {\r\nfunnel_text_window_t* tw = (funnel_text_window_t *)data;\r\nguint i;\r\nwindow_destroy(GTK_WIDGET(tw->win));\r\ntw->win = NULL;\r\nif (tw->close_cb)\r\ntw->close_cb(tw->close_data);\r\nfor (i = 0; i < tw->buttons->len; i++) {\r\nfunnel_bt_t* cbd = (funnel_bt_t *)g_ptr_array_index(tw->buttons,i);\r\nif (cbd->data && cbd->free_data_fcn) cbd->free_data_fcn(cbd->data);\r\nif (cbd->free_fcn) cbd->free_fcn(cbd);\r\n}\r\ng_ptr_array_free(tw->buttons,TRUE);\r\ng_free(tw);\r\n}\r\nstatic gboolean text_window_unref_del_event_cb(GtkWidget *win _U_, GdkEvent *event _U_, gpointer user_data) {\r\nfunnel_text_window_t* tw = (funnel_text_window_t *)user_data;\r\nguint i;\r\nwindow_destroy(GTK_WIDGET(tw->win));\r\ntw->win = NULL;\r\nif (tw->close_cb)\r\ntw->close_cb(tw->close_data);\r\nfor (i = 0; i < tw->buttons->len; i++) {\r\nfunnel_bt_t* cbd = (funnel_bt_t *)g_ptr_array_index(tw->buttons,i);\r\nif (cbd->data && cbd->free_data_fcn) cbd->free_data_fcn(cbd->data);\r\nif (cbd->free_fcn) cbd->free_fcn(cbd);\r\n}\r\ng_ptr_array_free(tw->buttons,TRUE);\r\ng_free(tw);\r\nreturn TRUE;\r\n}\r\nstatic gboolean text_window_delete_event_cb(GtkWidget *win _U_, GdkEvent *event _U_, gpointer user_data)\r\n{\r\nfunnel_text_window_t* tw = (funnel_text_window_t *)user_data;\r\nwindow_destroy(GTK_WIDGET(tw->win));\r\ntw->win = NULL;\r\nif (tw->close_cb)\r\ntw->close_cb(tw->close_data);\r\nreturn TRUE;\r\n}\r\nstatic funnel_text_window_t* new_text_window(const char* title) {\r\nfunnel_text_window_t* tw = (funnel_text_window_t *)g_malloc(sizeof(funnel_text_window_t));\r\nGtkWidget *txt_scrollw, *main_vb, *hbox;\r\ntw->close_cb = NULL;\r\ntw->close_data = NULL;\r\ntw->buttons = g_ptr_array_new();\r\ntw->win = dlg_window_new(title);\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(tw->win), TRUE);\r\ng_signal_connect(tw->win, "delete-event", G_CALLBACK(text_window_delete_event_cb), tw);\r\ntxt_scrollw = scrolled_window_new(NULL, NULL);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\ngtk_container_add(GTK_CONTAINER(tw->win), main_vb);\r\ngtk_box_pack_start(GTK_BOX (main_vb), txt_scrollw, TRUE, TRUE, 0);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(txt_scrollw),\r\nGTK_SHADOW_IN);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(txt_scrollw),\r\nGTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC);\r\ntw->txt = gtk_text_view_new();\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(tw->txt), FALSE);\r\ngtk_text_view_set_wrap_mode(GTK_TEXT_VIEW(tw->txt), GTK_WRAP_WORD);\r\ngtk_text_view_set_cursor_visible(GTK_TEXT_VIEW(tw->txt), FALSE);\r\ngtk_text_view_set_left_margin(GTK_TEXT_VIEW(tw->txt), 4);\r\ngtk_text_view_set_right_margin(GTK_TEXT_VIEW(tw->txt), 4);\r\nhbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_widget_show(hbox);\r\ntw->button_hbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_button_box_set_layout(GTK_BUTTON_BOX(tw->button_hbox), GTK_BUTTONBOX_START);\r\ngtk_box_pack_start(GTK_BOX(hbox), tw->button_hbox, TRUE, TRUE, 0);\r\ngtk_widget_show(tw->button_hbox);\r\ngtk_box_pack_start(GTK_BOX(main_vb), hbox, FALSE, FALSE, 0);\r\ntw->bt_close = gtk_button_new_with_label("Close");\r\ngtk_widget_set_can_default(tw->bt_close, TRUE);\r\ng_object_set_data(G_OBJECT(hbox), "Close", tw->bt_close);\r\ngtk_box_pack_end(GTK_BOX(hbox), tw->bt_close, FALSE, FALSE, 0);\r\ngtk_widget_show(tw->bt_close);\r\ng_signal_connect(tw->bt_close, "clicked", G_CALLBACK(text_window_cancel_button_cb), tw);\r\ngtk_widget_grab_default(tw->bt_close);\r\ngtk_container_add(GTK_CONTAINER(txt_scrollw), tw->txt);\r\ngtk_window_resize(GTK_WINDOW(tw->win),400,300);\r\ngtk_widget_show_all(tw->win);\r\nreturn tw;\r\n}\r\nstatic void text_window_clear(funnel_text_window_t* tw)\r\n{\r\nGtkTextBuffer *buf;\r\nif (! tw->win) return;\r\nbuf = gtk_text_view_get_buffer(GTK_TEXT_VIEW(tw->txt));\r\ngtk_text_buffer_set_text(buf, "", 0);\r\n}\r\nstatic void text_window_append(funnel_text_window_t* tw, const char *str)\r\n{\r\nGtkWidget *txt;\r\nint nchars;\r\nGtkTextBuffer *buf;\r\nGtkTextIter iter;\r\nif (! tw->win) return;\r\ntxt = tw->txt;\r\nnchars = (int) strlen(str);\r\nbuf= gtk_text_view_get_buffer(GTK_TEXT_VIEW(txt));\r\ngtk_text_buffer_get_end_iter(buf, &iter);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(GTK_WIDGET(txt), user_font_get_regular());\r\n#else\r\ngtk_widget_modify_font(GTK_WIDGET(txt), user_font_get_regular());\r\n#endif\r\nif (!g_utf8_validate(str, -1, NULL))\r\nprintf("Invalid utf8 encoding: %s\n", str);\r\ngtk_text_buffer_insert(buf, &iter, str, nchars);\r\n}\r\nstatic void text_window_set_text(funnel_text_window_t* tw, const char* text)\r\n{\r\nif (! tw->win) return;\r\ntext_window_clear(tw);\r\ntext_window_append(tw, text);\r\n}\r\nstatic void text_window_prepend(funnel_text_window_t* tw, const char *str _U_) {\r\nGtkWidget *txt;\r\nint nchars;\r\nGtkTextBuffer *buf;\r\nGtkTextIter iter;\r\nif (! tw->win) return;\r\ntxt = tw->txt;\r\nnchars = (int) strlen(str);\r\nbuf= gtk_text_view_get_buffer(GTK_TEXT_VIEW(txt));\r\ngtk_text_buffer_get_start_iter(buf, &iter);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(GTK_WIDGET(txt), user_font_get_regular());\r\n#else\r\ngtk_widget_modify_font(GTK_WIDGET(txt), user_font_get_regular());\r\n#endif\r\nif (!g_utf8_validate(str, -1, NULL))\r\nprintf("Invalid utf8 encoding: %s\n", str);\r\ngtk_text_buffer_insert(buf, &iter, str, nchars);\r\n}\r\nstatic const gchar* text_window_get_text(funnel_text_window_t* tw) {\r\nGtkWidget *txt;\r\nGtkTextBuffer *buf;\r\nGtkTextIter start;\r\nGtkTextIter end;\r\nif (! tw->win) return "";\r\ntxt = tw->txt;\r\nbuf= gtk_text_view_get_buffer(GTK_TEXT_VIEW(txt));\r\ngtk_text_buffer_get_start_iter(buf, &start);\r\ngtk_text_buffer_get_end_iter(buf, &end);\r\nreturn gtk_text_buffer_get_text(buf, &start, &end, FALSE);\r\n}\r\nstatic void text_window_set_close_cb(funnel_text_window_t* tw, text_win_close_cb_t cb, void* data) {\r\ntw->close_cb = cb;\r\ntw->close_data = data;\r\n}\r\nstatic void text_window_destroy(funnel_text_window_t* tw) {\r\nif (tw->win) {\r\ng_signal_connect(tw->bt_close, "clicked", G_CALLBACK(unref_text_win_cancel_bt_cb), tw);\r\ng_signal_connect(tw->win, "delete-event", G_CALLBACK(text_window_unref_del_event_cb), tw);\r\n} else {\r\nguint i;\r\nfor (i = 0; i < tw->buttons->len; i++) {\r\nfunnel_bt_t* cbd = (funnel_bt_t *)g_ptr_array_index(tw->buttons,i);\r\nif (cbd->data && cbd->free_data_fcn) cbd->free_data_fcn(cbd->data);\r\nif (cbd->free_fcn) cbd->free_fcn(cbd);\r\n}\r\ng_ptr_array_free(tw->buttons,TRUE);\r\ng_free(tw);\r\n}\r\n}\r\nstatic void text_window_set_editable(funnel_text_window_t* tw, gboolean editable){\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(tw->txt), editable);\r\ngtk_text_view_set_cursor_visible(GTK_TEXT_VIEW(tw->txt), editable);\r\n}\r\nstatic gboolean text_window_button_cb(GtkWidget *bt _U_, gpointer user_data)\r\n{\r\nfunnel_bt_t* cbd = (funnel_bt_t *)user_data;\r\nif (cbd->func) {\r\nreturn cbd->func(cbd->tw,cbd->data);\r\n} else {\r\nreturn TRUE;\r\n}\r\n}\r\nstatic void text_window_add_button(funnel_text_window_t* tw, funnel_bt_t* cbd, const gchar* label) {\r\nGtkWidget *button;\r\ncbd->tw = tw;\r\ng_ptr_array_add(tw->buttons,cbd);\r\nbutton = gtk_button_new_with_label(label);\r\ngtk_widget_set_can_default(button, TRUE);\r\ngtk_box_pack_start(GTK_BOX(tw->button_hbox), button, FALSE, FALSE, 0);\r\ngtk_widget_show(button);\r\ng_signal_connect(button, "clicked", G_CALLBACK(text_window_button_cb), cbd);\r\n}\r\nstatic gboolean funnel_dlg_cb(GtkWidget *win _U_, gpointer user_data)\r\n{\r\nstruct _funnel_dlg_data* dd = (struct _funnel_dlg_data *)user_data;\r\nguint i;\r\nguint len = dd->entries->len;\r\nGPtrArray* returns = g_ptr_array_new();\r\nfor(i=0; i<len; i++) {\r\nGtkEntry* entry = (GtkEntry *)g_ptr_array_index(dd->entries,i);\r\ng_ptr_array_add(returns,g_strdup(gtk_entry_get_text(entry)));\r\n}\r\ng_ptr_array_add(returns,NULL);\r\nif (dd->dlg_cb)\r\ndd->dlg_cb((gchar**)returns->pdata,dd->data);\r\nwindow_destroy(GTK_WIDGET(dd->win));\r\ng_ptr_array_free(returns,FALSE);\r\nreturn TRUE;\r\n}\r\nstatic void funnel_cancel_btn_cb(GtkWidget *bt _U_, gpointer data) {\r\nGtkWidget* win = (GtkWidget *)data;\r\nwindow_destroy(GTK_WIDGET(win));\r\n}\r\nstatic void funnel_new_dialog(const gchar* title,\r\nconst gchar** fieldnames,\r\nfunnel_dlg_cb_t dlg_cb,\r\nvoid* data) {\r\nGtkWidget *win, *main_grid, *main_vb, *bbox, *bt_cancel, *bt_ok;\r\nguint i;\r\nconst gchar* fieldname;\r\nstruct _funnel_dlg_data* dd = (struct _funnel_dlg_data *)g_malloc(sizeof(struct _funnel_dlg_data));\r\ndd->entries = g_ptr_array_new();\r\ndd->dlg_cb = dlg_cb;\r\ndd->data = data;\r\nwin = dlg_window_new(title);\r\ndd->win = win;\r\nfor (i=0; fieldnames[i]; i++);\r\ngtk_window_resize(GTK_WINDOW(win),400,10*(i+2));\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_add(GTK_CONTAINER(win), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 15);\r\nfor (i = 0; (fieldname = fieldnames[i]) ; i++) {\r\nGtkWidget *entry, *label;\r\nlabel = gtk_label_new(fieldname);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, i+1, 1, 1);\r\ngtk_widget_show(label);\r\nentry = gtk_entry_new();\r\ng_ptr_array_add(dd->entries,entry);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), entry, 1, i+1, 1, 1);\r\ngtk_widget_show(entry);\r\n}\r\nbbox = dlg_button_row_new(GTK_STOCK_CANCEL,GTK_STOCK_OK, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\nbt_ok = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(bt_ok, "clicked", G_CALLBACK(funnel_dlg_cb), dd);\r\ngtk_widget_grab_default(bt_ok);\r\nbt_cancel = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(bt_cancel, "clicked", G_CALLBACK(funnel_cancel_btn_cb), win);\r\ngtk_widget_grab_default(bt_cancel);\r\ngtk_widget_show(main_grid);\r\ngtk_widget_show(main_vb);\r\ngtk_widget_show(win);\r\n}\r\nstatic const gchar * funnel_get_filter(funnel_ops_id_t *ops_id _U_ _U_) {\r\nreturn gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\n}\r\nstatic void funnel_set_filter(funnel_ops_id_t *ops_id _U_, const char* filter_string) {\r\ngtk_entry_set_text(GTK_ENTRY(main_display_filter_widget), filter_string);\r\n}\r\nstatic void funnel_set_color_filter_slot(guint8 filt_nr, const gchar* filter_string) {\r\ngchar *err_msg = NULL;\r\nif (!color_filters_set_tmp(filt_nr, (gchar *)filter_string, FALSE, &err_msg)) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", err_msg);\r\ng_free(err_msg);\r\n}\r\n}\r\nstatic void funnel_apply_filter(funnel_ops_id_t *ops_id _U_) {\r\nconst char* filter_string = gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\nmain_filter_packets(&cfile, filter_string, FALSE);\r\n}\r\nstatic void funnel_logger(const gchar *log_domain _U_,\r\nGLogLevelFlags log_level _U_,\r\nconst gchar *message,\r\ngpointer user_data _U_) {\r\nfputs(message,stderr);\r\n}\r\nstatic void funnel_retap_packets(funnel_ops_id_t *ops_id _U_) {\r\ncf_retap_packets(&cfile);\r\n}\r\nstatic gboolean funnel_open_file(funnel_ops_id_t *ops_id _U_, const char* fname, const char* filter, char** err_str) {\r\nint err = 0;\r\ndfilter_t *rfcode = NULL;\r\n*err_str = NULL;\r\nswitch (cfile.state) {\r\ncase FILE_CLOSED:\r\ncase FILE_READ_DONE:\r\ncase FILE_READ_ABORTED:\r\nbreak;\r\ncase FILE_READ_IN_PROGRESS:\r\n*err_str = g_strdup("file read in progress");\r\nreturn FALSE;\r\n}\r\nif (filter) {\r\nif (!dfilter_compile(filter, &rfcode, err_str)) {\r\nreturn FALSE;\r\n}\r\n}\r\nif (cf_open(&cfile, fname, WTAP_TYPE_AUTO, FALSE, &err) != CF_OK) {\r\n*err_str = g_strdup(g_strerror(err));\r\nif (rfcode != NULL) dfilter_free(rfcode);\r\nreturn FALSE;\r\n}\r\ncfile.rfcode = rfcode;\r\nswitch (cf_read(&cfile, FALSE)) {\r\ncase CF_READ_OK:\r\ncase CF_READ_ERROR:\r\nbreak;\r\ndefault:\r\n*err_str = g_strdup("problem while reading file");\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic struct progdlg* funnel_new_progress_window(funnel_ops_id_t *ops_id _U_, const gchar* label, const gchar* task, gboolean terminate_is_stop, gboolean *stop_flag) {\r\nreturn create_progress_dlg(top_level, label, task, terminate_is_stop, stop_flag);\r\n}\r\nstatic void funnel_update_progress(struct progdlg* win, float pr, const gchar* task) {\r\nupdate_progress_dlg(win, pr, task);\r\n}\r\nstatic void funnel_destroy_progress_window(struct progdlg* win) {\r\ndestroy_progress_dlg(win);\r\n}\r\nstatic void funnel_reload_packets(funnel_ops_id_t *ops_id _U_) {\r\nif (cfile.state == FILE_READ_DONE) cf_reload(&cfile);\r\n}\r\nstatic void our_menu_callback(void* unused _U_, gpointer data) {\r\nmenu_cb_t* mcb = (menu_cb_t *)data;\r\nmcb->callback(mcb->callback_data);\r\nif (mcb->retap) cf_retap_packets(&cfile);\r\n}\r\nstatic void register_menu_cb(const char *name,\r\nregister_stat_group_t group,\r\nvoid (*callback)(gpointer),\r\ngpointer callback_data,\r\ngboolean retap) {\r\nmenu_cb_t* mcb = (menu_cb_t *)g_malloc(sizeof(menu_cb_t));\r\nconst char *label = NULL, *str = NULL;\r\nmcb->callback = callback;\r\nmcb->callback_data = callback_data;\r\nmcb->retap = retap;\r\nstr = strrchr(name,'/');\r\nif(str){\r\nlabel = str+1;\r\n}else{\r\nlabel = name;\r\n}\r\nregister_menu_bar_menu_items(\r\nstat_group_name(group),\r\nname,\r\nNULL,\r\nlabel,\r\nNULL,\r\nNULL,\r\nour_menu_callback,\r\nmcb,\r\nTRUE,\r\nNULL,\r\nNULL);\r\n}\r\nvoid initialize_funnel_ops(void) {\r\nfunnel_set_funnel_ops(&funnel_ops);\r\n}\r\nvoid\r\nregister_tap_listener_gtkfunnel(void)\r\n{\r\nfunnel_register_all_menus(register_menu_cb);\r\n}

static gint\r\ndissect_control(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\ngint offset, gboolean is_client_message)\r\n{\r\nproto_item *pitem;\r\nguint16 control_pdu_id;\r\nguint credits;\r\nguint timeout;\r\nguint context_id;\r\nguint notification_register;\r\nguint number;\r\ngint parameter_length;\r\npitem = proto_tree_add_item(tree, hf_bthcrp_control_pdu_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ncontrol_pdu_id = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Control: %s %s",\r\n((is_client_message) ? "Request" : "Response"),\r\nval_to_str(control_pdu_id, control_pdu_id_vals, "Unknown PDU ID"));\r\nif (control_pdu_id >= 0x8000) {\r\nproto_item_append_text(pitem, " (Vendor Specific)");\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (Vendor Specific)");\r\n} else if (control_pdu_id == 0x0000 || control_pdu_id >= 0x000B ) {\r\nproto_item_append_text(pitem, " (Reserved)");\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (Reserved)");\r\n}\r\nproto_tree_add_item(tree, hf_bthcrp_control_transaction_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\npitem = proto_tree_add_item(tree, hf_bthcrp_control_parameter_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nparameter_length = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nif (!is_client_message && parameter_length < 2) {\r\nexpert_add_info_format(pinfo, pitem, &ei_bthcrp_control_parameter_length,\r\n"Parameter length is shorter than 2 in response");\r\n}\r\nif (parameter_length < tvb_reported_length_remaining(tvb, offset)) {\r\nexpert_add_info_format(pinfo, pitem, &ei_bthcrp_control_parameter_length,\r\n"Parameter length is shorter than payload length");\r\n} else if (parameter_length > tvb_reported_length_remaining(tvb, offset)) {\r\nexpert_add_info_format(pinfo, pitem, &ei_bthcrp_control_parameter_length,\r\n"Parameter length is larger than payload length");\r\n}\r\nif (!is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_status, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nif (control_pdu_id >= 0x8000) {\r\nif (tvb_reported_length_remaining(tvb, offset)) {\r\nproto_tree_add_item(tree, hf_bthcrp_data, tvb, offset, tvb_reported_length_remaining(tvb, offset), ENC_NA);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\n} else switch(control_pdu_id) {\r\ncase 0x0001:\r\nif (is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_client_credit_granted, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncredits = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - CreditGranted: %u", credits);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 0x0002:\r\nif (!is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_server_credit_granted, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncredits = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - CreditGranted: %u", credits);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 0x0003:\r\nif (is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_client_credit_return, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncredits = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Client Credit Return: %u", credits);\r\noffset += 4;\r\n} else {\r\nproto_tree_add_item(tree, hf_bthcrp_control_server_credit_return, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncredits = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Server Credit Return: %u", credits);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 0x0004:\r\nif (is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_client_credit_query, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncredits = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Client Credit: %u", credits);\r\noffset += 4;\r\n} else {\r\nproto_tree_add_item(tree, hf_bthcrp_control_server_credit_query, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncredits = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Server Credit: %u", credits);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 0x0005:\r\nif (!is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_status_reserved_76, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_bthcrp_control_status_paper_empty, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_bthcrp_control_status_select, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_bthcrp_control_status_not_error, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_bthcrp_control_status_reserved_20, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\n}\r\nbreak;\r\ncase 0x0006:\r\nif (is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_start_byte, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nnumber = tvb_get_ntohs(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Start Byte: %u", number);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_bthcrp_control_number_of_bytes, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nnumber = tvb_get_ntohs(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Number Of Bytes: %u", number);\r\noffset += 2;\r\n} else {\r\nconst guint8 *id;\r\nproto_tree_add_item_ret_string(tree, hf_bthcrp_control_1284_id, tvb, offset, tvb_reported_length_remaining(tvb, offset), ENC_ASCII | ENC_NA, wmem_packet_scope(), &id);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - 1284 ID: %s", id);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\nbreak;\r\ncase 0x0007:\r\ncase 0x0008:\r\nbreak;\r\ncase 0x0009:\r\nif (is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_register, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nnotification_register = tvb_get_guint8(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Register: %s", val_to_str(notification_register, register_vals, "unknown register"));\r\noffset += 1;\r\nproto_tree_add_item(tree, hf_bthcrp_callback_context_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncontext_id = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Callback ContextID: %u", context_id);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bthcrp_control_callback_timeout, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ntimeout = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Callback Timeout: %u", timeout);\r\noffset += 4;\r\n} else {\r\nproto_tree_add_item(tree, hf_bthcrp_control_timeout, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ntimeout = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Timeout: %u", timeout);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_bthcrp_control_callback_timeout, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ntimeout = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Callback Timeout: %u", timeout);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase 0x000A:\r\nif (!is_client_message) {\r\nproto_tree_add_item(tree, hf_bthcrp_control_timeout, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ntimeout = tvb_get_ntohl(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Timeout: %u", timeout);\r\noffset += 4;\r\n}\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gint offset)\r\n{\r\ntvbuff_t *next_tvb;\r\ncol_append_str(pinfo->cinfo, COL_INFO, "HCRP data stream");\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_notification(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\ngint offset, gboolean is_client_message)\r\n{\r\nguint16 notification_pdu_id;\r\nproto_item *pitem;\r\nif (is_client_message) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, "Notification: unexpected notification stream");\r\nreturn offset;\r\n}\r\npitem = proto_tree_add_item(tree, hf_bthcrp_notification_pdu_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nnotification_pdu_id = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "Notification: %s", val_to_str(notification_pdu_id, notification_pdu_id_vals, "Unknown PDU ID"));\r\nif (notification_pdu_id >= 0x8000) {\r\nproto_item_append_text(pitem, " (Vendor Specific)");\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (Vendor Specific)");\r\nif (tvb_reported_length_remaining(tvb, offset)) {\r\nproto_tree_add_item(tree, hf_bthcrp_data, tvb, offset, tvb_reported_length_remaining(tvb, offset), ENC_NA);\r\noffset += tvb_reported_length_remaining(tvb, offset);\r\n}\r\n} else if (notification_pdu_id != 0x001) {\r\nproto_item_append_text(pitem, " (Reserved)");\r\ncol_append_str(pinfo->cinfo, COL_INFO, " (Reserved)");\r\n}\r\nswitch(notification_pdu_id) {\r\ncase 0x01:\r\nproto_tree_add_item(tree, hf_bthcrp_callback_context_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_bthcrp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nproto_item *main_item;\r\nproto_tree *main_tree;\r\ngint offset = 0;\r\ngint protocol = -1;\r\ngboolean is_client_message = FALSE;\r\ngint previous_proto;\r\nprevious_proto = (GPOINTER_TO_INT(wmem_list_frame_data(wmem_list_frame_prev(wmem_list_tail(pinfo->layers)))));\r\nif (previous_proto == proto_btl2cap) {\r\nbtl2cap_data_t *l2cap_data;\r\nwmem_tree_key_t key[10];\r\nguint32 interface_id;\r\nguint32 adapter_id;\r\nguint32 sdp_psm = SDP_PSM_DEFAULT;\r\nguint32 direction;\r\nguint32 bd_addr_oui;\r\nguint32 bd_addr_id;\r\nguint32 service_type;\r\nguint32 service_channel;\r\nguint32 frame_number;\r\nservice_info_t *service_info;\r\nl2cap_data = (btl2cap_data_t *) data;\r\ninterface_id = l2cap_data->interface_id;\r\nadapter_id = l2cap_data->adapter_id;\r\ndirection = (l2cap_data->is_local_psm) ? P2P_DIR_SENT : P2P_DIR_RECV;\r\nif (direction == P2P_DIR_RECV) {\r\nbd_addr_oui = l2cap_data->remote_bd_addr_oui;\r\nbd_addr_id = l2cap_data->remote_bd_addr_id;\r\n} else {\r\nbd_addr_oui = 0;\r\nbd_addr_id = 0;\r\n}\r\nservice_type = BTSDP_L2CAP_PROTOCOL_UUID;\r\nservice_channel = l2cap_data->psm;\r\nframe_number = pinfo->num;\r\nkey[0].length = 1;\r\nkey[0].key = &interface_id;\r\nkey[1].length = 1;\r\nkey[1].key = &adapter_id;\r\nkey[2].length = 1;\r\nkey[2].key = &sdp_psm;\r\nkey[3].length = 1;\r\nkey[3].key = &direction;\r\nkey[4].length = 1;\r\nkey[4].key = &bd_addr_oui;\r\nkey[5].length = 1;\r\nkey[5].key = &bd_addr_id;\r\nkey[6].length = 1;\r\nkey[6].key = &service_type;\r\nkey[7].length = 1;\r\nkey[7].key = &service_channel;\r\nkey[8].length = 1;\r\nkey[8].key = &frame_number;\r\nkey[9].length = 0;\r\nkey[9].key = NULL;\r\nservice_info = btsdp_get_service_info(key);\r\nif (service_info && service_info->interface_id == interface_id &&\r\nservice_info->adapter_id == adapter_id &&\r\nservice_info->sdp_psm == SDP_PSM_DEFAULT &&\r\n((service_info->direction == P2P_DIR_RECV &&\r\nservice_info->bd_addr_oui == bd_addr_oui &&\r\nservice_info->bd_addr_id == bd_addr_id) ||\r\n(service_info->direction != P2P_DIR_RECV &&\r\nservice_info->bd_addr_oui == 0 &&\r\nservice_info->bd_addr_id == 0)) &&\r\nservice_info->type == BTSDP_L2CAP_PROTOCOL_UUID &&\r\nservice_info->channel == l2cap_data->psm) {\r\nif ((service_info->protocol == BTSDP_HARDCOPY_CONTROL_CHANNEL_PROTOCOL_UUID ||\r\nservice_info->protocol == BTSDP_HARDCOPY_DATA_CHANNEL_PROTOCOL_UUID) &&\r\n((!l2cap_data->is_local_psm && pinfo->p2p_dir == P2P_DIR_SENT) ||\r\n(l2cap_data->is_local_psm && pinfo->p2p_dir == P2P_DIR_RECV))) {\r\nis_client_message = TRUE;\r\n} else if (service_info->protocol == BTSDP_HARDCOPY_NOTIFICATION_PROTOCOL_UUID &&\r\n((l2cap_data->is_local_psm && pinfo->p2p_dir == P2P_DIR_SENT) ||\r\n(!l2cap_data->is_local_psm && pinfo->p2p_dir == P2P_DIR_RECV))) {\r\nis_client_message = TRUE;\r\n}\r\nprotocol = service_info->protocol;\r\n}\r\nif (psm_control != 0 && l2cap_data->psm == psm_control) {\r\nprotocol = BTSDP_HARDCOPY_CONTROL_CHANNEL_PROTOCOL_UUID;\r\n} else if (psm_data_stream != 0 && l2cap_data->psm == psm_data_stream) {\r\nprotocol = BTSDP_HARDCOPY_DATA_CHANNEL_PROTOCOL_UUID;\r\n} else if (psm_notification != 0 && l2cap_data->psm == psm_notification) {\r\nprotocol = BTSDP_HARDCOPY_NOTIFICATION_PROTOCOL_UUID;\r\n}\r\n}\r\nmain_item = proto_tree_add_item(tree, proto_bthcrp, tvb, offset, -1, ENC_NA);\r\nmain_tree = proto_item_add_subtree(main_item, ett_bthcrp);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "HCRP");\r\nswitch (pinfo->p2p_dir) {\r\ncase P2P_DIR_SENT:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Sent ");\r\nbreak;\r\ncase P2P_DIR_RECV:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "UnknownDirection ");\r\nbreak;\r\n}\r\nif (force_client != FORCE_CLIENT_DEFAULT) {\r\nis_client_message = (force_client == FORCE_CLIENT_YES && pinfo->p2p_dir == P2P_DIR_SENT) ||\r\n(force_client != FORCE_CLIENT_YES && pinfo->p2p_dir == P2P_DIR_RECV);\r\n}\r\nif (protocol == BTSDP_HARDCOPY_CONTROL_CHANNEL_PROTOCOL_UUID) {\r\noffset = dissect_control(tvb, pinfo, main_tree, offset, is_client_message);\r\n} else if (protocol == BTSDP_HARDCOPY_DATA_CHANNEL_PROTOCOL_UUID) {\r\noffset = dissect_data(tvb, pinfo, main_tree, offset);\r\n} else if (protocol == BTSDP_HARDCOPY_NOTIFICATION_PROTOCOL_UUID) {\r\noffset = dissect_notification(tvb, pinfo, main_tree, offset, is_client_message);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "HCRP stream");\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset)) {\r\nproto_item *pitem;\r\npitem = proto_tree_add_item(main_tree, hf_bthcrp_data, tvb, offset, tvb_reported_length_remaining(tvb, offset), ENC_NA);\r\nexpert_add_info(pinfo, pitem, &ei_bthcrp_unexpected_data);\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_bthcrp(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t* expert_bthcrp;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_bthcrp_control_pdu_id,\r\n{ "Control PDU ID", "bthcrp.control.pdu_id",\r\nFT_UINT16, BASE_HEX, VALS(control_pdu_id_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_transaction_id,\r\n{ "Transaction ID", "bthcrp.control.transaction_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_parameter_length,\r\n{ "Parameter Length", "bthcrp.control.parameter_length",\r\nFT_UINT16, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_status,\r\n{ "Status", "bthcrp.control.status",\r\nFT_UINT16, BASE_HEX, VALS(status_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_notification_pdu_id,\r\n{ "Notification PDU ID", "bthcrp.notification.pdu_id",\r\nFT_UINT16, BASE_HEX, VALS(notification_pdu_id_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_callback_context_id,\r\n{ "Callback Context ID", "bthcrp.callback.context_id",\r\nFT_UINT32, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_callback_timeout,\r\n{ "Callback Timeout", "bthcrp.callback.timeout",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_timeout,\r\n{ "Timeout", "bthcrp.timeout",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_register,\r\n{ "Register", "bthcrp.register",\r\nFT_UINT8, BASE_HEX, VALS(register_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_1284_id,\r\n{ "1284 ID", "bthcrp.1284_id",\r\nFT_STRING, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_start_byte,\r\n{ "Start Byte", "bthcrp.start_byte",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_number_of_bytes,\r\n{ "Number Of Bytes", "bthcrp.number_of_bytes",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_client_credit_granted,\r\n{ "Client Credit Granted", "bthcrp.client_credit_granted",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_server_credit_granted,\r\n{ "Server Credit Granted", "bthcrp.server_credit_granted",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_client_credit_return,\r\n{ "Client Credit Return", "bthcrp.client_credit_return",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_server_credit_return,\r\n{ "Server Credit Return", "bthcrp.server_credit_return",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_client_credit_query,\r\n{ "Client Credit Query", "bthcrp.client_credit_query",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_server_credit_query,\r\n{ "Server Credit Query", "bthcrp.server_credit_query",\r\nFT_UINT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_status_reserved_76,\r\n{ "Reserved", "bthcrp.status.reserved76",\r\nFT_UINT8, BASE_DEC, NULL, 0xC0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_status_paper_empty,\r\n{ "Paper Empty", "bthcrp.status.paper_empty",\r\nFT_BOOLEAN, 8, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_status_select,\r\n{ "Select", "bthcrp.status.select",\r\nFT_BOOLEAN, 8, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_status_not_error,\r\n{ "Not Error", "bthcrp.status.not_error",\r\nFT_BOOLEAN, 8, NULL, 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_control_status_reserved_20,\r\n{ "Reserved", "bthcrp.status.reserved210",\r\nFT_UINT8, BASE_HEX, NULL, 0x07,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bthcrp_data,\r\n{ "Data", "bthcrp.data",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_bthcrp\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_bthcrp_control_parameter_length, { "bthcrp.control_parameter_length.bad", PI_PROTOCOL, PI_WARN, "Length bad", EXPFILL }},\r\n{ &ei_bthcrp_unexpected_data, { "bthcrp.unexpected_data", PI_PROTOCOL, PI_WARN, "Unexpected data", EXPFILL }},\r\n};\r\nproto_bthcrp = proto_register_protocol("Bluetooth HCRP Profile", "BT HCRP", "bthcrp");\r\nbthcrp_handle = register_dissector("bthcrp", dissect_bthcrp, proto_bthcrp);\r\nproto_register_field_array(proto_bthcrp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_bthcrp = expert_register_protocol(proto_bthcrp);\r\nexpert_register_field_array(expert_bthcrp, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_bthcrp, NULL);\r\nprefs_register_static_text_preference(module, "hcrp.version",\r\n"Bluetooth Profile HCRP version: 1.2",\r\n"Version of profile supported by this dissector.");\r\nprefs_register_obsolete_preference(module, "hcrp.is_client");\r\nprefs_register_enum_preference(module, "hcrp.force_client", "Force Client",\r\n"If \"yes\" localhost will be treat as Client, \"no\" as Server",\r\n&force_client, force_client_enum, FALSE);\r\nprefs_register_uint_preference(module, "hcrp.control.psm", "L2CAP PSM for Control",\r\n"L2CAP PSM for Control",\r\n10, &psm_control);\r\nprefs_register_uint_preference(module, "hcrp.data.psm", "L2CAP PSM for Data",\r\n"L2CAP PSM for Data",\r\n10, &psm_data_stream);\r\nprefs_register_uint_preference(module, "hcrp.notification.psm", "L2CAP PSM for Notification",\r\n"L2CAP PSM for Notification",\r\n10, &psm_notification);\r\n}\r\nvoid\r\nproto_reg_handoff_bthcrp(void)\r\n{\r\ndissector_add_string("bluetooth.uuid", "12", bthcrp_handle);\r\ndissector_add_string("bluetooth.uuid", "14", bthcrp_handle);\r\ndissector_add_string("bluetooth.uuid", "16", bthcrp_handle);\r\ndissector_add_string("bluetooth.uuid", "1125", bthcrp_handle);\r\ndissector_add_string("bluetooth.uuid", "1126", bthcrp_handle);\r\ndissector_add_string("bluetooth.uuid", "1127", bthcrp_handle);\r\ndissector_add_for_decode_as("btl2cap.psm", bthcrp_handle);\r\ndissector_add_for_decode_as("btl2cap.cid", bthcrp_handle);\r\n}

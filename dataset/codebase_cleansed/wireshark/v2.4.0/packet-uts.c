static int testchar(tvbuff_t *tvb, packet_info *pinfo _U_, int offset, int op, gchar match, gchar *storage)\r\n{\r\ngchar temp;\r\nif (tvb_bytes_exist(tvb, offset, 1)) {\r\ntemp = tvb_get_guint8(tvb, offset) & 0x7f;\r\nif (op == FETCH || (op == MATCH && temp == match)) {\r\nif (storage != NULL)\r\n*storage = temp;\r\nreturn 1;\r\n} else {\r\nreturn 0;\r\n}\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Unknown Message Format");\r\nreturn 0;\r\n}\r\n}\r\nstatic void\r\nset_addr(packet_info *pinfo _U_ , int field, gchar rid, gchar sid, gchar did)\r\n{\r\nif (field == SRC) {\r\ncol_append_fstr(pinfo->cinfo, COL_DEF_SRC, " %2.2X:%2.2X:%2.2X", rid, sid, did);\r\n} else {\r\ncol_append_fstr(pinfo->cinfo, COL_DEF_DST, " %2.2X:%2.2X:%2.2X", rid, sid, did);\r\n}\r\n}\r\nstatic int\r\ndissect_uts(tvbuff_t *tvb, packet_info *pinfo _U_ , proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *uts_tree = NULL;\r\nproto_tree *uts_header_tree = NULL;\r\nproto_tree *uts_trailer_tree = NULL;\r\nproto_item *ti;\r\nint length;\r\ngchar rid = 0, sid = 0, did = 0;\r\nint offset = 0;\r\nint header_length = -1;\r\nint ack_start = 0;\r\nint busy_start = 0;\r\nint notbusy_start = 0;\r\nint replyrequest_start = 0;\r\nint function_start = 0;\r\nint msgwaiting_start = 0;\r\nint nak_start = 0;\r\nint etx_start = 0;\r\nint bcc_start = 0;\r\nint stx_start = 0;\r\ngchar function_code;\r\nguint8 *data_ptr;\r\nenum { NOTRAFFIC, OTHER } msg_type = OTHER;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "UTS");\r\nif (testchar(tvb, pinfo, 0, MATCH, EOT, NULL) &&\r\ntestchar(tvb, pinfo, 1, MATCH, EOT, NULL) &&\r\ntestchar(tvb, pinfo, 2, MATCH, ETX, NULL)) {\r\nmsg_type = NOTRAFFIC;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "No Traffic");\r\n} else {\r\nif (testchar(tvb, pinfo, 0, MATCH, SOH, NULL) &&\r\ntestchar(tvb, pinfo, 1, FETCH, 0, (gchar *)&rid) &&\r\ntestchar(tvb, pinfo, 2, FETCH, 0, (gchar *)&sid) &&\r\ntestchar(tvb, pinfo, 3, FETCH, 0, (gchar *)&did)) {\r\noffset = 4;\r\nif (testchar(tvb, pinfo, offset, MATCH, ETX, NULL)) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "General Poll");\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, '1', NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, ETX, NULL)) {\r\nack_start = offset;\r\nif (sid == GSID && did == GDID) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "General Poll + ACK");\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else if (sid != GSID && did == GDID) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Specific Poll + ACK");\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else if (sid != GSID && did != GDID) {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "No Traffic + ACK");\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Unknown Message Format");\r\nif ((pinfo->pseudo_header->sita.sita_flags & SITA_FRAME_DIR) == SITA_FRAME_DIR_TXED) {\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else {\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n}\r\n}\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, NAK, NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, ETX, NULL) &&\r\nsid != GSID && did == GDID) {\r\nnak_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Retransmit Request");\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, BEL, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, STX, NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, ETX, NULL)) {\r\nheader_length = offset+2;\r\nmsgwaiting_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Message Waiting");\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, '1', NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, STX, NULL)) {\r\nack_start = offset;\r\nheader_length = offset+3;\r\nstx_start = offset+2;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Text + ACK");\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, STX, NULL)) {\r\nheader_length = offset+1;\r\nstx_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Text");\r\nif ((pinfo->pseudo_header->sita.sita_flags & SITA_FRAME_DIR) == SITA_FRAME_DIR_TXED) {\r\nset_addr(pinfo, DST, rid, sid, did);\r\n} else {\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n}\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, ENQ, NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, ETX, NULL)) {\r\nreplyrequest_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Reply Request");\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, '?', NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, ETX, NULL)) {\r\nbusy_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Busy");\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, ';', NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, ETX, NULL)) {\r\nnotbusy_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Not Busy");\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, '1', NULL) &&\r\ntestchar(tvb, pinfo, offset+2, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+3, MATCH, ';', NULL) &&\r\ntestchar(tvb, pinfo, offset+4, MATCH, ETX, NULL)) {\r\nnotbusy_start = offset+2;\r\nack_start = offset;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Not Busy + ACK");\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, MATCH, DLE, NULL) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, '1', NULL) &&\r\ntestchar(tvb, pinfo, offset+2, FETCH, 0, &function_code) &&\r\ntestchar(tvb, pinfo, offset+3, MATCH, ETX, NULL)) {\r\nack_start = offset;\r\nfunction_start = offset + 2;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Function Message '%c' + ACK", function_code);\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n} else if (testchar(tvb, pinfo, offset, FETCH, 0, &function_code) &&\r\ntestchar(tvb, pinfo, offset+1, MATCH, ETX, NULL)) {\r\nfunction_start = offset;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Function Message '%c'", function_code);\r\nset_addr(pinfo, SRC, rid, sid, did);\r\n}\r\n}\r\n}\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nif ((tvb_get_guint8(tvb, offset) & 0x7f) == ETX) {\r\nif (header_length == -1)\r\nheader_length = offset;\r\netx_start = offset;\r\noffset++;\r\nbreak;\r\n}\r\noffset++;\r\n}\r\nif (tvb_reported_length_remaining(tvb, offset))\r\nbcc_start = offset;\r\nif (tree) {\r\nti = proto_tree_add_protocol_format(tree, proto_uts, tvb, 0, -1, "UTS");\r\nuts_tree = proto_item_add_subtree(ti, ett_uts);\r\nif (msg_type == NOTRAFFIC) {\r\nproto_tree_add_protocol_format(uts_tree, proto_uts, tvb, 0, 2, "No Traffic");\r\nproto_tree_add_protocol_format(uts_tree, proto_uts, tvb, 2, -1, "ETX + padding");\r\n} else {\r\nuts_header_tree = proto_tree_add_subtree(uts_tree, tvb, 0, header_length, ett_header_uts, NULL, "Header");\r\nproto_tree_add_protocol_format(uts_header_tree, proto_uts, tvb, 0, 1, "SOH");\r\nif (rid == GRID)\r\nproto_tree_add_uint_format(uts_header_tree, hf_rid, tvb, 1, 1, rid, "RID (%02X) (General)", rid);\r\nelse\r\nproto_tree_add_uint_format(uts_header_tree, hf_rid, tvb, 1, 1, rid, "RID (%02X)", rid);\r\nif (sid == GSID)\r\nproto_tree_add_uint_format(uts_header_tree, hf_sid, tvb, 2, 1, sid, "SID (%02X) (General)", sid);\r\nelse\r\nproto_tree_add_uint_format(uts_header_tree, hf_sid, tvb, 2, 1, sid, "SID (%02X)", sid);\r\nif (did == GDID)\r\nproto_tree_add_uint_format(uts_header_tree, hf_did, tvb, 3, 1, did, "DID (%02X) (General)", did);\r\nelse\r\nproto_tree_add_uint_format(uts_header_tree, hf_did, tvb, 3, 1, did, "DID (%02X)", did);\r\nif (nak_start)\r\nproto_tree_add_boolean_format(uts_header_tree, hf_retxrequest, tvb, nak_start, 2, 1, "Re-transmit Request");\r\nif (ack_start)\r\nproto_tree_add_boolean_format(uts_header_tree, hf_ack, tvb, ack_start, 2, 1, "Ack");\r\nif (replyrequest_start)\r\nproto_tree_add_boolean_format(uts_header_tree, hf_replyrequest, tvb, replyrequest_start, 2, 1, "Reply Request");\r\nif (busy_start)\r\nproto_tree_add_boolean_format(uts_header_tree, hf_busy, tvb, busy_start, 2, 1, "Busy");\r\nif (notbusy_start)\r\nproto_tree_add_boolean_format(uts_header_tree, hf_notbusy, tvb, notbusy_start, 2, 1, "Not Busy");\r\nif (msgwaiting_start)\r\nproto_tree_add_boolean_format(uts_header_tree, hf_msgwaiting, tvb, msgwaiting_start, 1, 1, "Message Waiting");\r\nif (function_start)\r\nproto_tree_add_uint_format(uts_header_tree, hf_function, tvb, function_start, 1, function_code, "Function '%c'", function_code );\r\nif (stx_start) {\r\nproto_tree_add_protocol_format(uts_header_tree, proto_uts, tvb, stx_start, 1, "Start of Text");\r\nlength = tvb_captured_length_remaining(tvb, stx_start+1);\r\nif (etx_start)\r\nlength = (etx_start - stx_start - 1);\r\ndata_ptr = tvb_get_string_enc(wmem_packet_scope(), tvb, stx_start+1, length, ENC_ASCII);\r\nproto_tree_add_string_format(uts_tree, hf_data, tvb, stx_start + 1, length, data_ptr,\r\n"Text (%d byte%s)", length, plurality(length, "", "s"));\r\n}\r\nif (etx_start) {\r\nuts_trailer_tree = proto_tree_add_subtree(uts_tree, tvb, etx_start, -1, ett_trailer_uts, NULL, "Trailer");\r\nif (etx_start)\r\nproto_tree_add_protocol_format(uts_trailer_tree, proto_uts, tvb, etx_start, 1, "ETX");\r\nif (bcc_start)\r\nproto_tree_add_protocol_format(uts_trailer_tree, proto_uts, tvb, bcc_start, -1, "CCC + padding");\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_uts(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_rid,\r\n{ "RID", "uts.rid",\r\nFT_UINT8, BASE_HEX, NULL, 0, "Remote Identifier address", HFILL }},\r\n{ &hf_sid,\r\n{ "SID", "uts.sid",\r\nFT_UINT8, BASE_HEX, NULL, 0, "Site Identifier address", HFILL }},\r\n{ &hf_did,\r\n{ "DID", "uts.did",\r\nFT_UINT8, BASE_HEX, NULL, 0, "Device Identifier address", HFILL }},\r\n{ &hf_retxrequest,\r\n{ "ReTxRequst", "uts.retxrequst",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0, "TRUE if Re-transmit Request", HFILL }},\r\n{ &hf_ack,\r\n{ "Ack", "uts.ack",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0, "TRUE if Ack", HFILL }},\r\n{ &hf_replyrequest,\r\n{ "ReplyRequst", "uts.replyrequest",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0, "TRUE if Reply Request", HFILL }},\r\n{ &hf_busy,\r\n{ "Busy", "uts.busy",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0, "TRUE if Busy", HFILL }},\r\n{ &hf_notbusy,\r\n{ "NotBusy", "uts.notbusy",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0, "TRUE if Not Busy", HFILL }},\r\n{ &hf_msgwaiting,\r\n{ "MsgWaiting", "uts.msgwaiting",\r\nFT_BOOLEAN, BASE_NONE, NULL, 0x0, "TRUE if Message Waiting", HFILL }},\r\n{ &hf_function,\r\n{ "Function", "uts.function",\r\nFT_UINT8, BASE_HEX, NULL, 0, "Function Code value", HFILL }},\r\n{ &hf_data,\r\n{ "Data", "uts.data",\r\nFT_STRING, BASE_NONE, NULL, 0, "User Data Message", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_uts,\r\n&ett_header_uts,\r\n&ett_trailer_uts,\r\n};\r\nproto_uts = proto_register_protocol("Unisys Transmittal System", "UTS", "uts");\r\nproto_register_field_array(proto_uts, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("uts", dissect_uts, proto_uts);\r\n}

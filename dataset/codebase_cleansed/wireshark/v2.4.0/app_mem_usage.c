static gsize\r\nwin32_get_total_mem_used_by_app(void)\r\n{\r\nHANDLE pHandle;\r\nPROCESS_MEMORY_COUNTERS pmc;\r\nSIZE_T workingSize = 0;\r\npHandle = GetCurrentProcess();\r\nif (GetProcessMemoryInfo(pHandle, &pmc, sizeof(pmc))){\r\nworkingSize = pmc.WorkingSetSize;\r\n}\r\nCloseHandle(pHandle);\r\nif(workingSize == 0){\r\nreturn -1;\r\n}else{\r\nreturn (int)workingSize;\r\n}\r\n}\r\nstatic gboolean\r\nlinux_get_memory(gsize *ptotal, gsize *prss)\r\n{\r\nstatic int fd = -1;\r\nstatic intptr_t pagesize = 0;\r\nchar buf[128];\r\nunsigned long total, rss;\r\nssize_t ret;\r\nif (!pagesize)\r\npagesize = sysconf(_SC_PAGESIZE);\r\nif (pagesize == -1)\r\nreturn FALSE;\r\nif (fd < 0) {\r\nchar path[64];\r\ng_snprintf(path, sizeof(path), "/proc/%d/statm", getpid());\r\nfd = ws_open(path, O_RDONLY);\r\n}\r\nif (fd < 0)\r\nreturn FALSE;\r\nret = pread(fd, buf, sizeof(buf)-1, 0);\r\nif (ret <= 0)\r\nreturn FALSE;\r\nbuf[ret] = '\0';\r\nif (sscanf(buf, "%lu %lu", &total, &rss) != 2)\r\nreturn FALSE;\r\nif (ptotal)\r\n*ptotal = pagesize * (gsize) total;\r\nif (prss)\r\n*prss = pagesize * (gsize) rss;\r\nreturn TRUE;\r\n}\r\nstatic gsize\r\nlinux_get_total_mem_used_by_app(void)\r\n{\r\ngsize total;\r\nif (!linux_get_memory(&total, NULL))\r\ntotal = 0;\r\nreturn total;\r\n}\r\nstatic gsize\r\nlinux_get_rss_mem_used_by_app(void)\r\n{\r\ngsize rss;\r\nif (!linux_get_memory(NULL, &rss))\r\nrss = 0;\r\nreturn rss;\r\n}\r\nvoid\r\nmemory_usage_component_register(const ws_mem_usage_t *component)\r\n{\r\nif (memory_register_num >= MAX_COMPONENTS)\r\nreturn;\r\nmemory_components[memory_register_num++] = component;\r\n}\r\nconst char *\r\nmemory_usage_get(guint idx, gsize *value)\r\n{\r\nif (idx >= memory_register_num)\r\nreturn NULL;\r\nif (value)\r\n*value = memory_components[idx]->fetch();\r\nreturn memory_components[idx]->name;\r\n}\r\nvoid\r\nmemory_usage_gc(void)\r\n{\r\nguint i;\r\nfor (i = 0; i < memory_register_num; i++) {\r\nif (memory_components[i]->gc)\r\nmemory_components[i]->gc();\r\n}\r\n}

static guint\r\nget_tali_pdu_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset, void *data _U_)\r\n{\r\nguint16 length;\r\nlength = tvb_get_letohs(tvb, offset + TALI_SYNC_LENGTH + TALI_OPCODE_LENGTH);\r\nreturn length+TALI_HEADER_LENGTH;\r\n}\r\nstatic int\r\ndissect_tali_pdu(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nchar opcode[TALI_OPCODE_LENGTH+1];\r\nguint16 length;\r\ntvbuff_t *payload_tvb = NULL;\r\nproto_item *tali_item = NULL;\r\nproto_tree *tali_tree = NULL;\r\ntvb_memcpy(tvb, (guint8*)opcode, TALI_SYNC_LENGTH, TALI_OPCODE_LENGTH);\r\nopcode[TALI_OPCODE_LENGTH] = '\0';\r\nlength = tvb_get_letohs(tvb, TALI_SYNC_LENGTH + TALI_OPCODE_LENGTH);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "TALI");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "[%s] packet, [%u] bytes in payload", opcode, length);\r\nif (tree) {\r\ntali_item = proto_tree_add_item(tree, hfi_tali, tvb, 0, TALI_HEADER_LENGTH, ENC_NA);\r\ntali_tree = proto_item_add_subtree(tali_item, ett_tali);\r\nproto_tree_add_string(tali_tree, &hfi_tali_sync_indicator, tvb, 0, TALI_SYNC_LENGTH, TALI_SYNC);\r\nproto_tree_add_string(tali_tree, &hfi_tali_opcode_indicator, tvb, TALI_SYNC_LENGTH, TALI_OPCODE_LENGTH, opcode);\r\nproto_tree_add_uint(tali_tree, &hfi_tali_length_indicator, tvb, TALI_SYNC_LENGTH + TALI_OPCODE_LENGTH, TALI_MSU_LENGTH, length);\r\n}\r\nif (length > 0) {\r\npayload_tvb = tvb_new_subset_remaining(tvb, TALI_HEADER_LENGTH);\r\nif (payload_tvb != NULL && !dissector_try_string(tali_dissector_table, opcode, payload_tvb, pinfo, tree, NULL)) {\r\ncall_data_dissector(payload_tvb, pinfo, tree);\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int\r\ndissect_tali(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, tali_desegment, TALI_HEADER_LENGTH,\r\nget_tali_pdu_len, dissect_tali_pdu, data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_tali_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nchar opcode[TALI_OPCODE_LENGTH];\r\nif (tvb_reported_length(tvb) < TALI_HEADER_LENGTH)\r\nreturn FALSE;\r\nif (tvb_strneql(tvb, 0, TALI_SYNC, TALI_SYNC_LENGTH) != 0)\r\nreturn FALSE;\r\ntvb_memcpy(tvb, (guint8*)opcode, TALI_SYNC_LENGTH, TALI_OPCODE_LENGTH);\r\nif (strncmp(opcode, TALI_TEST, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_ALLO, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_PROH, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_PROA, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_MONI, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_MONA, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_SCCP, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_ISOT, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_MTP3, TALI_OPCODE_LENGTH) != 0 &&\r\nstrncmp(opcode, TALI_SAAL, TALI_OPCODE_LENGTH) != 0)\r\nreturn FALSE;\r\ndissect_tali(tvb, pinfo, tree, data);\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_tali(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_tali_sync_indicator,\r\n&hfi_tali_opcode_indicator,\r\n&hfi_tali_length_indicator\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_tali,\r\n&ett_tali_sync,\r\n&ett_tali_opcode,\r\n&ett_tali_msu_length\r\n};\r\nmodule_t *tali_module;\r\nint proto_tali;\r\nproto_tali = proto_register_protocol("Transport Adapter Layer Interface v1.0, RFC 3094", "TALI", "tali");\r\nhfi_tali = proto_registrar_get_nth(proto_tali);\r\nregister_dissector("tali", dissect_tali, proto_tali);\r\nproto_register_fields(proto_tali, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\ntali_dissector_table = register_dissector_table("tali.opcode", "Tali OPCODE", proto_tali, FT_STRING, BASE_NONE);\r\ntali_module = prefs_register_protocol(proto_tali, NULL);\r\nprefs_register_bool_preference(tali_module, "reassemble",\r\n"Reassemble TALI messages spanning multiple TCP segments",\r\n"Whether the TALI dissector should reassemble messages spanning multiple TCP segments."\r\n" To use this option, you must also enable \"Allow subdissectors to reassemble TCP streams\" in the TCP protocol settings.",\r\n&tali_desegment);\r\n}\r\nvoid\r\nproto_reg_handoff_tali(void)\r\n{\r\nheur_dissector_add("tcp", dissect_tali_heur, "Tali over TCP", "tali_tcp", hfi_tali->id, HEURISTIC_ENABLE);\r\n}

static int\r\ndissect_vmlab(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree* vmlab_tree;\r\nproto_item* ti;\r\nguint32 offset=0;\r\nguint8 attributes;\r\nguint8 portgroup;\r\nethertype_data_t ethertype_data;\r\nguint16 encap_proto;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "VMLAB");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_vmlab, tvb, 0, 24, ENC_NA);\r\nvmlab_tree = proto_item_add_subtree(ti, ett_vmlab);\r\nattributes = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(vmlab_tree, hf_vmlab_flags_part1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(vmlab_tree, hf_vmlab_flags_fragment, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(vmlab_tree, hf_vmlab_flags_part2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (attributes & 0x04) {\r\nproto_item_append_text(ti, ", Fragment");\r\n}\r\noffset += 1;\r\nportgroup = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(vmlab_tree, hf_vmlab_portgroup, tvb, offset, 1, portgroup);\r\nproto_item_append_text(ti, ", Portgroup: %d", portgroup);\r\noffset += 1;\r\noffset += 2;\r\nproto_tree_add_item(vmlab_tree, hf_vmlab_eth_addr, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(vmlab_tree, hf_vmlab_eth_dst, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_tree_add_item(vmlab_tree, hf_vmlab_eth_src, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nproto_item_append_text(ti, ", Src: %s, Dst: %s",\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, offset-6),\r\ntvb_address_with_resolution_to_str(wmem_packet_scope(), tvb, AT_ETHER, offset-12));\r\nencap_proto = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nethertype_data.etype = encap_proto;\r\nethertype_data.offset_after_ethertype = offset;\r\nethertype_data.fh_tree = vmlab_tree;\r\nethertype_data.etype_id = hf_vmlab_etype;\r\nethertype_data.trailer_id = hf_vmlab_trailer;\r\nethertype_data.fcs_len = 0;\r\ncall_dissector_with_data(ethertype_handle, tvb, pinfo, tree, &ethertype_data);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_vmlab(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_vmlab_flags_part1, { "Unknown", "vmlab.unknown1",\r\nFT_UINT8, BASE_HEX, NULL, 0xF8, NULL, HFILL }},\r\n{ &hf_vmlab_flags_fragment, { "More Fragments", "vmlab.fragment",\r\nFT_UINT8, BASE_DEC, VALS(fragment_vals), 0x04, NULL, HFILL }},\r\n{ &hf_vmlab_flags_part2, { "Unknown", "vmlab.unknown2",\r\nFT_UINT8, BASE_HEX, NULL, 0x03, NULL, HFILL }},\r\n{ &hf_vmlab_portgroup, { "Portgroup", "vmlab.pgrp",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_vmlab_eth_src, { "Source", "vmlab.src",\r\nFT_ETHER, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_vmlab_eth_dst, { "Destination", "vmlab.dst",\r\nFT_ETHER, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_vmlab_eth_addr, { "Address", "vmlab.addr",\r\nFT_ETHER, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_vmlab_etype, { "Encapsulated Type", "vmlab.subtype",\r\nFT_UINT16, BASE_HEX, VALS(etype_vals), 0x0, NULL, HFILL }},\r\n{ &hf_vmlab_trailer, { "Trailer", "vmlab.trailer",\r\nFT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_vmlab\r\n};\r\nproto_vmlab = proto_register_protocol("VMware Lab Manager", "VMLAB", "vmlab");\r\nproto_register_field_array(proto_vmlab, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_vmlab(void)\r\n{\r\ndissector_handle_t vmlab_handle;\r\nvmlab_handle = create_dissector_handle(dissect_vmlab, proto_vmlab);\r\ndissector_add_uint("ethertype", ETHERTYPE_VMLAB, vmlab_handle);\r\nethertype_handle = find_dissector_add_dependency("ethertype", proto_vmlab);\r\n}

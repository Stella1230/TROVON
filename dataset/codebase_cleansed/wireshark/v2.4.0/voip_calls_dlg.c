static voip_calls_tapinfo_t*\r\nvoip_calls_get_info(void)\r\n{\r\nstatic voip_calls_tapinfo_t the_tapinfo_struct =\r\n{\r\nvoip_calls_dlg_reset, voip_calls_dlg_packet, voip_calls_dlg_draw, NULL,\r\n0, NULL, {0}, 0, NULL, 0, 0, 0, NULL, NULL,\r\n0, NULL,\r\n0, 0, FALSE,\r\nNULL, 0,\r\n0, 0, 0, 0,\r\nNULL,\r\nNULL, NULL, 0, 0, 0,\r\n0, 0, H225_OTHER, FALSE,\r\n0,\r\n0, 0, 0,\r\nFLOW_ALL,\r\n0 };\r\nif (!the_tapinfo_struct.session) {\r\nthe_tapinfo_struct.session = cfile.epan;\r\n}\r\nif (!the_tapinfo_struct.callsinfos) {\r\nthe_tapinfo_struct.callsinfos = g_queue_new();\r\n}\r\nreturn &the_tapinfo_struct;\r\n}\r\nstatic void\r\nvoip_calls_dlg_remove_tap_listeners(voip_calls_tapinfo_t* tap_id_base)\r\n{\r\nvoip_calls_remove_all_tap_listeners(tap_id_base);\r\nhave_voip_calls_tap_listeners = FALSE;\r\n}\r\nstatic void\r\nvoip_calls_on_destroy(GObject *object _U_, gpointer user_data _U_)\r\n{\r\nvoip_calls_dlg_remove_tap_listeners(voip_calls_get_info());\r\nvoip_calls_dlg_reset(NULL);\r\nvoip_calls_dlg = NULL;\r\ng_free(graph_analysis_data);\r\ngraph_analysis_data = NULL;\r\n}\r\nstatic void\r\nvoip_calls_on_unselect(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ngtk_widget_set_sensitive(bt_filter, FALSE);\r\ngtk_widget_set_sensitive(bt_graph, FALSE);\r\n#ifdef HAVE_LIBPORTAUDIO\r\ngtk_widget_set_sensitive(bt_player, FALSE);\r\n#endif\r\n}\r\nstatic void\r\nvoip_calls_on_filter(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ngchar *filter_string;\r\nGString *filter_string_fwd;\r\nconst gchar *filter_prepend;\r\ngboolean is_first = TRUE;\r\nGList* lista;\r\nGList* listb;\r\nvoip_calls_info_t *listinfo;\r\nseq_analysis_item_t *gai;\r\nsize_t filter_length;\r\nsize_t max_filter_length = 2048;\r\nint pos;\r\nchar *addr_str, *guid_str;\r\nconst sip_calls_info_t *sipinfo;\r\nconst isup_calls_info_t *isupinfo;\r\nconst h323_calls_info_t *h323info;\r\nconst h245_address_t *h245_add = NULL;\r\nconst gcp_ctx_t* ctx;\r\nfilter_string = g_strdup(gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget)));\r\nfilter_length = strlen(filter_string);\r\npos = (int)filter_length;\r\ng_strstrip(filter_string);\r\nif (strlen(filter_string) > 0)\r\nfilter_prepend = " or ";\r\nelse\r\nfilter_prepend = "";\r\ng_free(filter_string);\r\nfilter_string_fwd = g_string_new(filter_prepend);\r\ng_string_append_printf(filter_string_fwd, "(");\r\nlista = g_queue_peek_nth_link(voip_calls_get_info()->callsinfos, 0);\r\nwhile (lista) {\r\nlistinfo = (voip_calls_info_t *)lista->data;\r\nif (listinfo->selected) {\r\nlistb = g_queue_peek_nth_link(voip_calls_get_info()->graph_analysis->items, 0);\r\nwhile (listb) {\r\ngai = (seq_analysis_item_t *)listb->data;\r\nif (gai->conv_num == listinfo->call_num) {\r\ng_string_append_printf(filter_string_fwd, "%sframe.number == %u", is_first?"":" or ", gai->frame_number);\r\nis_first = FALSE;\r\n}\r\nlistb = g_list_next(listb);\r\n}\r\n}\r\nlista = g_list_next(lista);\r\n}\r\ng_string_append_printf(filter_string_fwd, ")");\r\nfilter_length += filter_string_fwd->len;\r\nif (filter_length < max_filter_length) {\r\ngtk_editable_insert_text(GTK_EDITABLE(main_display_filter_widget), filter_string_fwd->str, -1, &pos);\r\n} else {\r\ng_string_free(filter_string_fwd, TRUE);\r\nfilter_string_fwd = g_string_new(filter_prepend);\r\ng_string_append_printf(filter_string_fwd, "(");\r\nis_first = TRUE;\r\nlista = g_queue_peek_nth_link(voip_calls_get_info()->callsinfos, 0);\r\nwhile (lista) {\r\nlistinfo = (voip_calls_info_t *)lista->data;\r\nif (listinfo->selected) {\r\nif (!is_first)\r\ng_string_append_printf(filter_string_fwd, " or ");\r\nswitch (listinfo->protocol) {\r\ncase VOIP_SIP:\r\nsipinfo = (sip_calls_info_t *)listinfo->prot_info;\r\ng_string_append_printf(filter_string_fwd,\r\n"(sip.Call-ID == \"%s\")",\r\nsipinfo->call_identifier\r\n);\r\nbreak;\r\ncase VOIP_ISUP:\r\nisupinfo = (isup_calls_info_t *)listinfo->prot_info;\r\ng_string_append_printf(filter_string_fwd,\r\n"(isup.cic == %i and frame.number >= %i and frame.number <= %i and mtp3.network_indicator == %i and ((mtp3.dpc == %i) and (mtp3.opc == %i)) or ((mtp3.dpc == %i) and (mtp3.opc == %i)))",\r\nisupinfo->cic, listinfo->start_fd->num,\r\nlistinfo->stop_fd->num,\r\nisupinfo->ni, isupinfo->dpc, isupinfo->opc,\r\nisupinfo->opc, isupinfo->dpc\r\n);\r\nbreak;\r\ncase VOIP_H323:\r\nh323info = (h323_calls_info_t *)listinfo->prot_info;\r\nguid_str = guid_to_str(NULL, &h323info->guid[0]);\r\ng_string_append_printf(filter_string_fwd,\r\n"((h225.guid == %s || q931.call_ref == %x:%x || q931.call_ref == %x:%x)",\r\nguid_str,\r\n(guint8) (h323info->q931_crv & 0x00ff),\r\n(guint8)((h323info->q931_crv & 0xff00)>>8),\r\n(guint8) (h323info->q931_crv2 & 0x00ff),\r\n(guint8)((h323info->q931_crv2 & 0xff00)>>8));\r\nlistb = g_list_first(h323info->h245_list);\r\nwmem_free(NULL, guid_str);\r\nwhile (listb) {\r\nh245_add = (h245_address_t *)listb->data;\r\naddr_str = (char*)address_to_str(NULL, &h245_add->h245_address);\r\ng_string_append_printf(filter_string_fwd,\r\n" || (ip.addr == %s && tcp.port == %d && h245)",\r\naddr_str, h245_add->h245_port);\r\nlistb = g_list_next(listb);\r\nwmem_free(NULL, addr_str);\r\n}\r\ng_string_append_printf(filter_string_fwd, ")");\r\nbreak;\r\ncase TEL_H248:\r\nctx = (gcp_ctx_t *)listinfo->prot_info;\r\ng_string_append_printf(filter_string_fwd,\r\n"(h248.ctx == 0x%x)", ctx->id);\r\nbreak;\r\ndefault:\r\ng_string_append_printf(filter_string_fwd,\r\n"(frame)");\r\nbreak;\r\n}\r\nis_first = FALSE;\r\n}\r\nlista = g_list_next(lista);\r\n}\r\ng_string_append_printf(filter_string_fwd, ")");\r\ngtk_editable_insert_text(GTK_EDITABLE(main_display_filter_widget), filter_string_fwd->str, -1, &pos);\r\n}\r\ng_string_free(filter_string_fwd, TRUE);\r\n}\r\nstatic void\r\nvoip_calls_on_select_all(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nGtkTreeSelection *selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(list));\r\ngtk_tree_selection_select_all(selection);\r\n}\r\nstatic void\r\non_graph_bt_clicked(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nseq_analysis_item_t *gai;\r\nGList* lista;\r\nGList* listb;\r\nvoip_calls_info_t *listinfo;\r\nvoip_calls_tapinfo_t *tapinfo = voip_calls_get_info();\r\nif(!tapinfo->graph_analysis){\r\nreturn;\r\n}\r\nsequence_analysis_list_sort(tapinfo->graph_analysis);\r\nlistb = g_queue_peek_nth_link(tapinfo->graph_analysis->items, 0);\r\nwhile (listb) {\r\ngai = (seq_analysis_item_t *)listb->data;\r\ngai->display = FALSE;\r\nlistb = g_list_next(listb);\r\n}\r\nlista = g_queue_peek_nth_link(tapinfo->callsinfos, 0);\r\nwhile (lista) {\r\nlistinfo = (voip_calls_info_t *)lista->data;\r\nif (listinfo->selected) {\r\nlistb = g_queue_peek_nth_link(tapinfo->graph_analysis->items, 0);\r\nwhile (listb) {\r\ngai = (seq_analysis_item_t *)listb->data;\r\nif (gai->conv_num == listinfo->call_num) {\r\ngai->display = TRUE;\r\n}\r\nlistb = g_list_next(listb);\r\n}\r\n}\r\nlista = g_list_next(lista);\r\n}\r\nif (graph_analysis_data->dlg.window == NULL)\r\ngraph_analysis_create(graph_analysis_data);\r\nelse\r\ngraph_analysis_update(graph_analysis_data);\r\n}\r\nstatic void\r\non_flow_bt_clicked(GtkButton *button, gpointer user_data)\r\n{\r\non_graph_bt_clicked(button,user_data);\r\n}\r\nstatic void\r\non_player_bt_clicked(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nrtp_player_init(voip_calls_get_info());\r\n}\r\nstatic gboolean\r\nvoip_calls_mark_selected(GtkTreeModel *model, GtkTreePath *path _U_, GtkTreeIter *iter, gpointer data)\r\n{\r\nGtkTreeSelection *selection = (GtkTreeSelection *)data;\r\nvoip_calls_info_t* strinfo;\r\ngtk_tree_model_get(model, iter, CALL_COL_DATA, &strinfo, -1);\r\nstrinfo->selected = gtk_tree_selection_iter_is_selected(selection, iter);\r\nreturn FALSE;\r\n}\r\nstatic void\r\nvoip_calls_on_select_row_cb(GtkTreeSelection *selection, gpointer data _U_)\r\n{\r\ngchar label_text[80];\r\ngtk_tree_model_foreach(GTK_TREE_MODEL(list_store), voip_calls_mark_selected, selection);\r\ncalls_ns = gtk_tree_selection_count_selected_rows(selection);\r\ng_snprintf(label_text, 80,\r\n"Detected %u VoIP %s. Selected %u %s.",\r\ncalls_nb,\r\nplurality(calls_nb, "Call", "Calls"),\r\ncalls_ns,\r\nplurality(calls_ns, "Call", "Calls"));\r\ngtk_label_set_text(GTK_LABEL(top_label), label_text);\r\ngtk_widget_set_sensitive(bt_filter, calls_ns ? TRUE : FALSE);\r\ngtk_widget_set_sensitive(bt_graph, calls_ns ? TRUE : FALSE);\r\n#ifdef HAVE_LIBPORTAUDIO\r\ngtk_widget_set_sensitive(bt_player, calls_ns ? TRUE : FALSE);\r\n#endif\r\n}\r\nstatic void\r\nadd_to_list_store(voip_calls_info_t* strinfo)\r\n{\r\ngchar field[NUM_COLS][50];\r\nisup_calls_info_t *isupinfo;\r\nh323_calls_info_t *h323info;\r\ngboolean flag = FALSE;\r\nchar* addr_str = address_to_display(NULL, &(strinfo->initial_speaker));\r\ng_snprintf(field[CALL_COL_INITIAL_SPEAKER], 30, "%s", addr_str);\r\ng_snprintf(field[CALL_COL_FROM], 50, "%s", strinfo->from_identity);\r\ng_snprintf(field[CALL_COL_TO], 50, "%s", strinfo->to_identity);\r\ng_snprintf(field[CALL_COL_PROTOCOL], 15, "%s",\r\n((strinfo->protocol==VOIP_COMMON)&&strinfo->protocol_name)?\r\nstrinfo->protocol_name:voip_protocol_name[strinfo->protocol]);\r\ng_snprintf(field[CALL_COL_STATE], 15, "%s", voip_call_state_name[strinfo->call_state]);\r\nwmem_free(NULL, addr_str);\r\nswitch (strinfo->protocol) {\r\ncase VOIP_ISUP:\r\nisupinfo = (isup_calls_info_t *)strinfo->prot_info;\r\ng_snprintf(field[CALL_COL_COMMENTS],30, "%i-%i -> %i-%i", isupinfo->ni, isupinfo->opc,\r\nisupinfo->ni, isupinfo->dpc);\r\nbreak;\r\ncase VOIP_H323:\r\nh323info = (h323_calls_info_t *)strinfo->prot_info;\r\nif (strinfo->call_state == VOIP_CALL_SETUP)\r\nflag = h323info->is_faststart_Setup;\r\nelse\r\nif ((h323info->is_faststart_Setup == TRUE) && (h323info->is_faststart_Proc == TRUE))\r\nflag = TRUE;\r\ng_snprintf(field[CALL_COL_COMMENTS],35, "Tunneling: %s Fast Start: %s",\r\n(h323info->is_h245Tunneling==TRUE?"ON":"OFF"),\r\n(flag==TRUE?"ON":"OFF"));\r\nbreak;\r\ncase VOIP_COMMON:\r\nfield[CALL_COL_COMMENTS][0]='\0';\r\nif (strinfo->call_comment)\r\ng_snprintf(field[CALL_COL_COMMENTS],30, "%s", strinfo->call_comment);\r\nbreak;\r\ndefault:\r\nfield[CALL_COL_COMMENTS][0]='\0';\r\nif (strinfo->call_comment)\r\ng_snprintf(field[CALL_COL_COMMENTS],30, "%s", strinfo->call_comment);\r\n}\r\ngtk_list_store_append(list_store, &list_iter);\r\ngtk_list_store_set(list_store, &list_iter,\r\nCALL_COL_START_TIME, nstime_to_sec(&strinfo->start_rel_ts),\r\nCALL_COL_STOP_TIME, nstime_to_sec(&strinfo->stop_rel_ts),\r\nCALL_COL_INITIAL_SPEAKER, &field[CALL_COL_INITIAL_SPEAKER][0],\r\nCALL_COL_FROM, &field[CALL_COL_FROM][0],\r\nCALL_COL_TO, &field[CALL_COL_TO][0],\r\nCALL_COL_PROTOCOL, &field[CALL_COL_PROTOCOL][0],\r\nCALL_COL_PACKETS, strinfo->npackets,\r\nCALL_COL_STATE, &field[CALL_COL_STATE][0],\r\nCALL_COL_COMMENTS, &field[CALL_COL_COMMENTS][0],\r\nCALL_COL_DATA, strinfo,\r\n-1);\r\ncalls_nb += 1;\r\n}\r\nstatic void\r\ncreate_list_view(void)\r\n{\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeSortable *sortable;\r\nGtkTreeView *list_view;\r\nGtkTreeSelection *selection;\r\nlist_store = gtk_list_store_new(NUM_COLS,\r\nG_TYPE_DOUBLE,\r\nG_TYPE_DOUBLE,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_UINT,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_POINTER\r\n);\r\nlist = gtk_tree_view_new_with_model(GTK_TREE_MODEL(list_store));\r\ng_object_unref(G_OBJECT(list_store));\r\nlist_view = GTK_TREE_VIEW(list);\r\nsortable = GTK_TREE_SORTABLE(list_store);\r\ngtk_tree_view_set_fixed_height_mode(list_view, TRUE);\r\ngtk_tree_sortable_set_sort_column_id(sortable, CALL_COL_START_TIME, GTK_SORT_ASCENDING);\r\ngtk_tree_view_set_headers_clickable(list_view, FALSE);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ng_object_set(G_OBJECT(renderer), "xpad", 10, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Start Time", renderer,\r\n"text", CALL_COL_START_TIME,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_START_TIME);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ng_object_set(G_OBJECT(renderer), "xpad", 10, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Stop Time", renderer,\r\n"text", CALL_COL_STOP_TIME,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_STOP_TIME);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Initial Speaker", renderer,\r\n"text", CALL_COL_INITIAL_SPEAKER,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_INITIAL_SPEAKER);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 80);\r\ngtk_tree_view_column_set_fixed_width(column, 120);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("From", renderer,\r\n"text", CALL_COL_FROM,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_FROM);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 130);\r\ngtk_tree_view_column_set_fixed_width(column, 140);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("To", renderer,\r\n"text", CALL_COL_TO,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_TO);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 130);\r\ngtk_tree_view_column_set_fixed_width(column, 140);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Protocol", renderer,\r\n"text", CALL_COL_PROTOCOL,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_PROTOCOL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 50);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(G_OBJECT(renderer), "xalign", 1.0, NULL);\r\ng_object_set(G_OBJECT(renderer), "xpad", 10, NULL);\r\ncolumn = gtk_tree_view_column_new_with_attributes("Packets", renderer,\r\n"text", CALL_COL_PACKETS,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_PACKETS);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 70);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("State", renderer,\r\n"text", CALL_COL_STATE,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_STATE);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Comments", renderer,\r\n"text", CALL_COL_COMMENTS,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, CALL_COL_COMMENTS);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 100);\r\ngtk_tree_view_column_set_fixed_width(column, 140);\r\ngtk_tree_view_append_column(list_view, column);\r\ngtk_tree_view_set_rules_hint(list_view, TRUE);\r\ngtk_tree_view_set_headers_clickable(list_view, TRUE);\r\nselection = gtk_tree_view_get_selection(list_view);\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_MULTIPLE);\r\ng_signal_connect(G_OBJECT(selection), "changed",\r\nG_CALLBACK(voip_calls_on_select_row_cb),\r\nNULL);\r\n}\r\nstatic void\r\nvoip_calls_dlg_create(void)\r\n{\r\nGtkWidget *voip_calls_dlg_w;\r\nGtkWidget *main_vb;\r\nGtkWidget *scrolledwindow;\r\nGtkWidget *hbuttonbox;\r\nGtkWidget *bt_close;\r\nGtkWidget *bt_select_all;\r\ngchar *title_name_ptr;\r\ngchar *win_name;\r\ntitle_name_ptr = cf_get_display_name(&cfile);\r\nwin_name = g_strdup_printf("%s - VoIP Calls", title_name_ptr);\r\ng_free(title_name_ptr);\r\nvoip_calls_dlg_w = dlg_window_new(win_name);\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(voip_calls_dlg_w), TRUE);\r\ngtk_window_set_default_size(GTK_WINDOW(voip_calls_dlg_w), 1000, 350);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(voip_calls_dlg_w), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER (main_vb), 12);\r\ntop_label = gtk_label_new("Detected 0 VoIP Calls. Selected 0 Calls.");\r\ngtk_box_pack_start(GTK_BOX (main_vb), top_label, FALSE, FALSE, 8);\r\nscrolledwindow = scrolled_window_new(NULL, NULL);\r\ngtk_box_pack_start(GTK_BOX (main_vb), scrolledwindow, TRUE, TRUE, 0);\r\ncreate_list_view();\r\ngtk_container_add(GTK_CONTAINER(scrolledwindow), list);\r\ngtk_widget_show(voip_calls_dlg_w);\r\nstatus_label = gtk_label_new("Total: Calls: 0 Start packets: 0 Completed calls: 0 Rejected calls: 0");\r\ngtk_box_pack_start(GTK_BOX(main_vb), status_label, FALSE, FALSE, 8);\r\nhbuttonbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), hbuttonbox, FALSE, FALSE, 0);\r\ngtk_button_box_set_layout(GTK_BUTTON_BOX (hbuttonbox), GTK_BUTTONBOX_SPREAD);\r\ngtk_box_set_spacing(GTK_BOX(hbuttonbox), 30);\r\nbt_filter = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_PREPARE_FILTER);\r\ngtk_container_add(GTK_CONTAINER(hbuttonbox), bt_filter);\r\ngtk_widget_set_tooltip_text(bt_filter, "Prepare a display filter of the selected conversation");\r\nbt_graph = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_VOIP_FLOW);\r\ngtk_container_add(GTK_CONTAINER(hbuttonbox), bt_graph);\r\ngtk_widget_show(bt_graph);\r\ng_signal_connect(bt_graph, "clicked", G_CALLBACK(on_flow_bt_clicked), NULL);\r\ngtk_widget_set_tooltip_text(bt_graph, "Show a flow graph of the selected calls.");\r\n#ifdef HAVE_LIBPORTAUDIO\r\nbt_player = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_AUDIO_PLAYER);\r\ngtk_container_add(GTK_CONTAINER(hbuttonbox), bt_player);\r\ngtk_widget_show(bt_player);\r\ng_signal_connect(bt_player, "clicked", G_CALLBACK(on_player_bt_clicked), NULL);\r\ngtk_widget_set_tooltip_text(bt_player, "Launch the RTP player to listen the selected calls.");\r\n#endif\r\nbt_select_all = ws_gtk_button_new_from_stock(GTK_STOCK_SELECT_ALL);\r\ngtk_container_add(GTK_CONTAINER(hbuttonbox), bt_select_all);\r\ngtk_widget_set_can_default(bt_select_all, TRUE);\r\ngtk_widget_set_tooltip_text(bt_select_all, "Select all the calls");\r\nbt_close = ws_gtk_button_new_from_stock(GTK_STOCK_CLOSE);\r\ngtk_container_add(GTK_CONTAINER (hbuttonbox), bt_close);\r\ngtk_widget_set_can_default(bt_close, TRUE);\r\ngtk_widget_set_tooltip_text(bt_close, "Close this dialog");\r\ng_signal_connect(bt_filter, "clicked", G_CALLBACK(voip_calls_on_filter), NULL);\r\nwindow_set_cancel_button(voip_calls_dlg_w, bt_close, window_cancel_button_cb);\r\ng_signal_connect(voip_calls_dlg_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(voip_calls_dlg_w, "destroy", G_CALLBACK(voip_calls_on_destroy), NULL);\r\ng_signal_connect(bt_select_all, "clicked", G_CALLBACK(voip_calls_on_select_all), NULL);\r\ngtk_widget_show_all(voip_calls_dlg_w);\r\nwindow_present(voip_calls_dlg_w);\r\nvoip_calls_on_unselect(NULL, NULL);\r\nvoip_calls_dlg = voip_calls_dlg_w;\r\ng_free(win_name);\r\n}\r\nvoid\r\nvoip_calls_dlg_update(GList *listx)\r\n{\r\nGtkTreeSortable *sortable;\r\ngchar label_text[256];\r\nsortable = GTK_TREE_SORTABLE(list_store);\r\nif (voip_calls_dlg != NULL) {\r\ncalls_nb = 0;\r\ncalls_ns = 0;\r\ngtk_list_store_clear(list_store);\r\ng_snprintf(label_text, sizeof(label_text),\r\n"Total: Calls: %u Start packets: %u Completed calls: %u Rejected calls: %u",\r\ng_queue_get_length(voip_calls_get_info()->callsinfos),\r\nvoip_calls_get_info()->start_packets,\r\nvoip_calls_get_info()->completed_calls,\r\nvoip_calls_get_info()->rejected_calls);\r\ngtk_label_set_text(GTK_LABEL(status_label), label_text);\r\ngtk_tree_sortable_set_sort_column_id(sortable, GTK_TREE_SORTABLE_UNSORTED_SORT_COLUMN_ID, GTK_SORT_ASCENDING);\r\nlistx = g_list_first(listx);\r\nwhile (listx) {\r\nadd_to_list_store((voip_calls_info_t*)(listx->data));\r\nlistx = g_list_next(listx);\r\n}\r\ngtk_tree_sortable_set_sort_column_id(sortable, CALL_COL_START_TIME, GTK_SORT_ASCENDING);\r\ng_snprintf(label_text, sizeof(label_text),\r\n"Detected %u VoIP %s. Selected %u %s.",\r\ncalls_nb,\r\nplurality(calls_nb, "Call", "Calls"),\r\ncalls_ns,\r\nplurality(calls_ns, "Call", "Calls"));\r\ngtk_label_set_text(GTK_LABEL(top_label), label_text);\r\n}\r\n}\r\ngboolean\r\nvoip_calls_dlg_packet(void *ptr _U_, packet_info *pinfo, epan_dissect_t *edt _U_, const void *data) {\r\nconst struct _rtp_info *rtp_info = (const struct _rtp_info *)data;\r\nadd_rtp_packet(rtp_info, pinfo);\r\nreturn TRUE;\r\n}\r\ngboolean\r\nvoip_calls_dlg_packet(void *ptr _U_, packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *data _U_) {\r\nreturn FALSE;\r\n}\r\nvoid\r\nvoip_calls_dlg_draw(void *ptr _U_)\r\n{\r\nif (voip_calls_get_info()->redraw) {\r\nvoip_calls_dlg_update(g_queue_peek_nth_link(voip_calls_get_info()->callsinfos, 0));\r\n}\r\n}\r\nvoid\r\nvoip_calls_dlg_reset(void *ptr _U_)\r\n{\r\nif (graph_analysis_data) {\r\ngtk_list_store_clear(list_store);\r\n}\r\n#ifdef HAVE_LIBPORTAUDIO\r\nreset_rtp_player();\r\n#endif\r\nvoip_calls_reset_all_taps(voip_calls_get_info());\r\nsequence_analysis_list_free(voip_calls_get_info()->graph_analysis);\r\nif (graph_analysis_data && graph_analysis_data->dlg.window != NULL) {\r\nwindow_cancel_button_cb(NULL, graph_analysis_data->dlg.window);\r\ngraph_analysis_data->dlg.window = NULL;\r\n}\r\n}\r\nstatic void\r\nvoip_calls_dlg_init_taps(const char *dummy _U_, void* userdata _U_)\r\n{\r\nvoip_calls_tapinfo_t* tap_id_base = voip_calls_get_info();\r\nif(NULL == tap_id_base->graph_analysis) {\r\ntap_id_base->graph_analysis = sequence_analysis_info_new();\r\n}\r\ntap_id_base->session = cfile.epan;\r\n#ifdef HAVE_LIBPORTAUDIO\r\nreset_rtp_player();\r\n#endif\r\nvoip_calls_reset_all_taps(tap_id_base);\r\nsequence_analysis_list_free(tap_id_base->graph_analysis);\r\nif (graph_analysis_data == NULL) {\r\ngraph_analysis_data = graph_analysis_init(voip_calls_get_info()->graph_analysis);\r\n}\r\nif (!have_voip_calls_tap_listeners) {\r\nvoip_calls_init_all_taps(tap_id_base);\r\nhave_voip_calls_tap_listeners = TRUE;\r\n}\r\nif (voip_calls_dlg == NULL) {\r\nvoip_calls_dlg_create();\r\n} else {\r\nreactivate_window(voip_calls_dlg);\r\n}\r\nvoip_calls_get_info()->redraw = 1;\r\nvoip_calls_dlg_draw(NULL);\r\nvoip_calls_get_info()->redraw = 0;\r\ncf_retap_packets(&cfile);\r\ngdk_window_raise(gtk_widget_get_window(voip_calls_dlg));\r\n}\r\nvoid\r\nvoip_calls_launch(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nvoip_calls_get_info()->fs_option = FLOW_ONLY_INVITES;\r\nvoip_calls_dlg_init_taps("", NULL);\r\n}\r\nvoid\r\nvoip_flows_launch(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nvoip_calls_get_info()->fs_option = FLOW_ALL;\r\nvoip_calls_dlg_init_taps("", NULL);\r\n}\r\nvoid\r\nregister_tap_listener_voip_calls_dlg(void)\r\n{\r\nregister_stat_tap_ui(&voip_calls_ui, NULL);\r\n}

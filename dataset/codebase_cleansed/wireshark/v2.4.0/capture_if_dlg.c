void\r\nupdate_selected_interface(gchar *name)\r\n{\r\nguint i;\r\ninterface_t device;\r\nif_dlg_data_t data;\r\nfor (i = 0; i < global_capture_opts.all_ifaces->len; i++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, i);\r\ndata = g_array_index(if_array, if_dlg_data_t, i);\r\nif (strcmp(name, device.name) == 0) {\r\ngtk_toggle_button_set_active((GtkToggleButton *)data.choose_bt, device.selected);\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void\r\nstore_selected(GtkWidget *choose_bt, gpointer name)\r\n{\r\ninterface_t device;\r\nguint i;\r\nfor (i = 0; i < global_capture_opts.all_ifaces->len; i++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, i);\r\nif (strcmp((char *)name, device.if_info.name) == 0) {\r\nif (!device.locked) {\r\ndevice.selected ^= 1;\r\nif (device.selected) {\r\nglobal_capture_opts.num_selected++;\r\n} else {\r\nglobal_capture_opts.num_selected--;\r\n}\r\nglobal_capture_opts.all_ifaces = g_array_remove_index(global_capture_opts.all_ifaces, i);\r\ng_array_insert_val(global_capture_opts.all_ifaces, i, device);\r\nif (gtk_widget_is_focus(choose_bt) && get_welcome_window()) {\r\nchange_interface_selection(device.name, device.selected);\r\n}\r\nif (gtk_widget_is_focus(choose_bt) && capture_dlg_window_present()) {\r\nenable_selected_interface(device.name, device.selected);\r\n}\r\ndevice.locked = FALSE;\r\nglobal_capture_opts.all_ifaces = g_array_remove_index(global_capture_opts.all_ifaces, i);\r\ng_array_insert_val(global_capture_opts.all_ifaces, i, device);\r\n}\r\nbreak;\r\n}\r\n}\r\nif (cap_if_w) {\r\ngtk_widget_set_sensitive(capture_bt, !gbl_capture_in_progress && (global_capture_opts.num_selected > 0));\r\n}\r\n}\r\nstatic void\r\ncapture_do_cb(GtkWidget *capture_bt_arg _U_, gpointer if_data _U_)\r\n{\r\nif_dlg_data_t data;\r\nguint ifs;\r\nfor (ifs = 0; ifs < if_array->len; ifs++) {\r\ndata = g_array_index(if_array, if_dlg_data_t, ifs);\r\nif (data.hidden) {\r\ncontinue;\r\n}\r\ngtk_widget_set_sensitive(data.choose_bt, FALSE);\r\nif_array = g_array_remove_index(if_array, ifs);\r\ng_array_insert_val(if_array, ifs, data);\r\n#ifdef HAVE_AIRPCAP\r\nairpcap_if_active = get_airpcap_if_from_name(g_airpcap_if_list, gtk_label_get_text(GTK_LABEL(data.device_lb)));\r\nairpcap_if_selected = airpcap_if_active;\r\n#endif\r\n}\r\nif (global_capture_opts.save_file) {\r\ng_free(global_capture_opts.save_file);\r\nglobal_capture_opts.save_file = NULL;\r\n}\r\nif (global_capture_opts.ifaces->len > 1) {\r\nglobal_capture_opts.use_pcapng = TRUE;\r\n}\r\nwindow_destroy(cap_if_w);\r\ncapture_start_cb(NULL, NULL);\r\n}\r\nstatic void\r\ncapture_prepare_cb(GtkWidget *prepare_bt _U_, gpointer if_data _U_)\r\n{\r\nwindow_destroy(cap_if_w);\r\nif (global_capture_opts.ifaces->len > 1) {\r\nglobal_capture_opts.use_pcapng = TRUE;\r\n}\r\ncapture_prep_cb(NULL, NULL);\r\n}\r\nstatic void\r\ncapture_details_cb(GtkWidget *details_bt _U_, gpointer name)\r\n{\r\ncapture_if_details_open(name);\r\n}\r\nstatic void\r\nupdate_if(gchar *name, if_stat_cache_t *sc_p)\r\n{\r\nstruct pcap_stat stats;\r\ngchar *str;\r\nguint diff, ifs, data_ifs;\r\ninterface_t device;\r\nif_dlg_data_t data;\r\ngboolean found = FALSE;\r\ndevice.last_packets = 0;\r\ndata.curr_lb = NULL;\r\ndata.last_lb = NULL;\r\nif (sc_p) {\r\nfor (ifs = 0, data_ifs = 0; ifs < global_capture_opts.all_ifaces->len; ifs++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, ifs);\r\nif (device.type != IF_PIPE) {\r\ndata = g_array_index(if_array, if_dlg_data_t, data_ifs++);\r\nif (!device.hidden && strcmp(name, device.name) == 0) {\r\nfound = TRUE;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (found) {\r\nif (capture_stats(sc_p, name, &stats)) {\r\nif ((int)(stats.ps_recv - device.last_packets) < 0) {\r\ndiff = 0;\r\n} else {\r\ndiff = stats.ps_recv - device.last_packets;\r\n}\r\ndevice.last_packets = stats.ps_recv;\r\nstr = g_strdup_printf("%u", device.last_packets);\r\ngtk_label_set_text(GTK_LABEL(data.curr_lb), str);\r\ng_free(str);\r\nstr = g_strdup_printf("%u", diff);\r\ngtk_label_set_text(GTK_LABEL(data.last_lb), str);\r\ng_free(str);\r\ngtk_widget_set_sensitive(data.curr_lb, diff);\r\ngtk_widget_set_sensitive(data.last_lb, diff);\r\n} else {\r\ngtk_label_set_text(GTK_LABEL(data.curr_lb), "error");\r\ngtk_label_set_text(GTK_LABEL(data.last_lb), "error");\r\n}\r\nglobal_capture_opts.all_ifaces = g_array_remove_index(global_capture_opts.all_ifaces, ifs);\r\ng_array_insert_val(global_capture_opts.all_ifaces, ifs, device);\r\nif_array = g_array_remove_index(if_array, ifs);\r\ng_array_insert_val(if_array, ifs, data);\r\n}\r\n}\r\n}\r\nstatic gboolean\r\nupdate_all(gpointer data)\r\n{\r\ninterface_t device;\r\nguint ifs;\r\nif_stat_cache_t *sc_p = (if_stat_cache_t *)data;\r\nif (!cap_if_w) {\r\nreturn FALSE;\r\n}\r\nfor (ifs = 0; ifs < global_capture_opts.all_ifaces->len; ifs++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, ifs);\r\nupdate_if(device.name, sc_p);\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nset_capture_if_dialog_for_capture_in_progress(gboolean capture_in_progress)\r\n{\r\ngbl_capture_in_progress = capture_in_progress;\r\nif (cap_if_w) {\r\ngtk_widget_set_sensitive(stop_bt, capture_in_progress);\r\ngtk_widget_set_sensitive(capture_bt, !capture_in_progress && (global_capture_opts.num_selected > 0));\r\n}\r\n}\r\nvoid\r\nset_capture_if_dialog_for_capture_stopping(void)\r\n{\r\nif (cap_if_w) {\r\ngtk_widget_set_sensitive(stop_bt, FALSE);\r\n}\r\n}\r\nstatic void\r\ncapture_if_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\ng_source_remove(timer_id);\r\nif (sc) {\r\ncapture_stat_stop(sc);\r\nsc = NULL;\r\n}\r\nwindow_destroy(GTK_WIDGET(cap_if_w));\r\ncap_if_w = NULL;\r\ncap_if_top_vb = NULL;\r\ncap_if_sw = NULL;\r\n#ifdef HAVE_AIRPCAP\r\nif (airpcap_if_active)\r\nairpcap_set_toolbar_stop_capture(airpcap_if_active);\r\n#endif\r\n}\r\nGtkWidget * capture_get_if_icon(interface_t *device)\r\n{\r\n#ifdef HAVE_PCAP_REMOTE\r\nif (!device->local) {\r\nreturn PIXBUF_TO_WIDGET(remote_sat_pb_data, "/org/wireshark/image/toolbar/remote_sat_16.png");\r\n}\r\n#endif\r\nif (device->display_name && strstr(device->display_name,"Wi-Fi") != NULL) {\r\nreturn PIXBUF_TO_WIDGET(network_wireless_pb_data, "/org/wireshark/image/toolbar/network_wireless_16.png");\r\n}\r\nswitch (device->type) {\r\ncase IF_DIALUP:\r\nreturn xpm_to_widget(modem_16_xpm);\r\ncase IF_WIRELESS:\r\nreturn PIXBUF_TO_WIDGET(network_wireless_pb_data, "/org/wireshark/image/toolbar/network_wireless_16.png");\r\n#ifdef HAVE_AIRPCAP\r\ncase IF_AIRPCAP:\r\nreturn xpm_to_widget(capture_airpcap_16_xpm);\r\n#endif\r\ncase IF_BLUETOOTH:\r\nreturn PIXBUF_TO_WIDGET(network_bluetooth_pb_data, "/org/wireshark/image/toolbar/network_bluetooth_16.png");\r\ncase IF_USB:\r\nreturn PIXBUF_TO_WIDGET(network_usb_pb_data, "/org/wireshark/image/toolbar/network_usb_16.png");\r\ncase IF_VIRTUAL:\r\nreturn xpm_to_widget(network_virtual_16_xpm);\r\ncase IF_WIRED:\r\nreturn PIXBUF_TO_WIDGET(network_wired_pb_data, "/org/wireshark/image/toolbar/network_wired_16.png");\r\n#ifdef HAVE_EXTCAP\r\ncase IF_EXTCAP:\r\n#ifdef _WIN32\r\nif (strncmp(device->friendly_name, "USBPcap", 7) == 0) {\r\nreturn PIXBUF_TO_WIDGET(network_usb_pb_data, "/org/wireshark/image/toolbar/network_usb_16.png");\r\n}\r\n#endif\r\n#endif\r\ncase IF_PIPE:\r\ncase IF_STDIN:\r\nreturn PIXBUF_TO_WIDGET(pipe_pb_data, "/org/wireshark/image/toolbar/pipe_16.png");\r\ndefault:\r\nprintf("unknown device type\n");\r\n}\r\nreturn PIXBUF_TO_WIDGET(network_wired_pb_data, "/org/wireshark/image/toolbar/network_wired_16.png");\r\n}\r\nstatic int\r\nget_ip_addr_count(GSList *addr_list)\r\n{\r\nGSList *curr_addr;\r\nif_addr_t *addr;\r\nint count;\r\ncount = 0;\r\nfor (curr_addr = addr_list; curr_addr != NULL;\r\ncurr_addr = g_slist_next(curr_addr)) {\r\naddr = (if_addr_t *)curr_addr->data;\r\nswitch (addr->ifat_type) {\r\ncase IF_AT_IPv4:\r\ncase IF_AT_IPv6:\r\ncount++;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn count;\r\n}\r\nstatic const gchar *\r\nset_ip_addr_label(GSList *addr_list, GtkWidget *ip_lb, guint selected_ip_addr)\r\n{\r\nGSList *curr_addr;\r\nif_addr_t *addr;\r\naddress addr_address;\r\nchar *addr_str = NULL;\r\ncurr_addr = g_slist_nth(addr_list, selected_ip_addr);\r\nif (curr_addr) {\r\naddr = (if_addr_t *)curr_addr->data;\r\nswitch (addr->ifat_type) {\r\ncase IF_AT_IPv4:\r\nset_address(&addr_address, AT_IPv4, 4, &addr->addr.ip4_addr);\r\naddr_str = (char*)address_to_str(NULL, &addr_address);\r\nbreak;\r\ncase IF_AT_IPv6:\r\nset_address(&addr_address, AT_IPv6, 16, addr->addr.ip6_addr);\r\naddr_str = (char*)address_to_str(NULL, &addr_address);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nif (addr_str) {\r\ngtk_label_set_text(GTK_LABEL(ip_lb), addr_str);\r\n} else {\r\ngtk_label_set_text(GTK_LABEL(ip_lb), "none");\r\n}\r\nwmem_free(NULL, addr_str);\r\ng_object_set_data(G_OBJECT(ip_lb), CAPTURE_IF_SELECTED_IP_ADDR, GINT_TO_POINTER(selected_ip_addr));\r\nreturn addr_str;\r\n}\r\nstatic gboolean\r\nip_label_enter_cb(GtkWidget *eb, GdkEventCrossing *event _U_, gpointer user_data _U_)\r\n{\r\ngtk_widget_set_state(eb, GTK_STATE_PRELIGHT);\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nip_label_leave_cb(GtkWidget *eb, GdkEvent *event _U_, gpointer user_data _U_)\r\n{\r\ngtk_widget_set_state(eb, GTK_STATE_NORMAL);\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nip_label_press_cb(GtkWidget *widget, GdkEvent *event _U_, gpointer data)\r\n{\r\nGtkWidget *ip_lb = (GtkWidget *)g_object_get_data(G_OBJECT(widget), CAPTURE_IF_IP_ADDR_LABEL);\r\nGSList *addr_list = (GSList *)data;\r\nGSList *curr_addr, *start_addr;\r\nif_addr_t *addr;\r\nguint selected_ip_addr = GPOINTER_TO_UINT(g_object_get_data(G_OBJECT(ip_lb), CAPTURE_IF_SELECTED_IP_ADDR));\r\nstart_addr = g_slist_nth(addr_list, selected_ip_addr);\r\nfor (;;) {\r\nselected_ip_addr++;\r\nif (g_slist_length(addr_list) <= selected_ip_addr) {\r\nselected_ip_addr = 0;\r\n}\r\ncurr_addr = g_slist_nth(addr_list, selected_ip_addr);\r\nif (curr_addr == start_addr) {\r\nbreak;\r\n}\r\naddr = (if_addr_t *)curr_addr->data;\r\nswitch (addr->ifat_type) {\r\ncase IF_AT_IPv4:\r\ncase IF_AT_IPv6:\r\ngoto found;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nfound:\r\nset_ip_addr_label(addr_list, ip_lb, selected_ip_addr);\r\nreturn FALSE;\r\n}\r\nstatic void\r\ncapture_if_stop_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nguint ifs;\r\nif_dlg_data_t data;\r\nfor (ifs = 0; ifs < if_array->len; ifs++) {\r\ndata = g_array_index(if_array, if_dlg_data_t, ifs);\r\nif (data.hidden) {\r\ncontinue;\r\n}\r\ngtk_widget_set_sensitive(data.choose_bt, TRUE);\r\nif_array = g_array_remove_index(if_array, ifs);\r\ng_array_insert_val(if_array, ifs, data);\r\n}\r\ncapture_stop_cb(NULL, NULL);\r\n}\r\nstatic void\r\nmake_if_array(void)\r\n{\r\nif_dlg_data_t data;\r\nguint i;\r\nif_array = g_array_new(FALSE, FALSE, sizeof(if_dlg_data_t));\r\nfor (i = 0; i < global_capture_opts.all_ifaces->len; i++) {\r\ndata.device_lb = NULL;\r\ndata.descr_lb = NULL;\r\ndata.ip_lb = NULL;\r\ndata.curr_lb = NULL;\r\ndata.last_lb = NULL;\r\ndata.choose_bt = NULL;\r\n#ifdef _WIN32\r\ndata.details_bt = NULL;\r\n#endif\r\ndata.hidden = FALSE;\r\ng_array_append_val(if_array, data);\r\n}\r\n}\r\nstatic gboolean\r\ncan_capture(void)\r\n{\r\n#ifdef _WIN32\r\nif (!has_wpcap) {\r\nchar *detailed_err;\r\ndetailed_err = cant_load_winpcap_err("Wireshark");\r\nsimple_error_message_box("%s", detailed_err);\r\ng_free(detailed_err);\r\nreturn FALSE;\r\n}\r\n#endif\r\nif (global_capture_opts.all_ifaces->len == 0) {\r\nsimple_error_message_box("There are no interfaces on which a capture can be done.");\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic void\r\ncapture_if_refresh_if_list(void)\r\n{\r\nGtkWidget *if_vb, *if_grid, *icon, *if_lb, *eb;\r\nGtkRequisition requisition;\r\nint row = 0, height = 0;\r\nguint ifs;\r\ninterface_t device;\r\nconst gchar *addr_str;\r\ngchar *user_descr;\r\nif_dlg_data_t data;\r\nif (!can_capture()) {\r\ndestroy_if_window();\r\nreturn;\r\n}\r\nif (cap_if_sw) {\r\ngtk_container_remove(GTK_CONTAINER(cap_if_top_vb), cap_if_sw);\r\ncapture_stat_stop(sc);\r\ng_source_remove(timer_id);\r\n}\r\nmake_if_array();\r\ncap_if_sw = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(cap_if_sw), GTK_POLICY_NEVER, GTK_POLICY_AUTOMATIC);\r\ngtk_box_pack_start(GTK_BOX(cap_if_top_vb), cap_if_sw, TRUE, TRUE, 0);\r\nif_vb = gtk_alignment_new(0.0F, 0.0F, 1.0F, 0.0F);\r\ngtk_container_set_border_width(GTK_CONTAINER(if_vb), 5);\r\n#if ! GTK_CHECK_VERSION(3,8,0)\r\ngtk_scrolled_window_add_with_viewport(GTK_SCROLLED_WINDOW(cap_if_sw), if_vb);\r\n#else\r\ngtk_container_add(GTK_CONTAINER(cap_if_sw), if_vb);\r\n#endif\r\nif_grid = ws_gtk_grid_new();\r\nws_gtk_grid_set_row_spacing(GTK_GRID(if_grid), 3);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(if_grid), 3);\r\ngtk_container_add(GTK_CONTAINER(if_vb), if_grid);\r\nif_lb = gtk_label_new("");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), if_lb, 0, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\nif_lb = gtk_label_new("Device");\r\nws_gtk_grid_attach_defaults(GTK_GRID(if_grid), if_lb, 1, row, 3, 1);\r\nif_lb = gtk_label_new("Description");\r\nws_gtk_grid_attach_defaults(GTK_GRID(if_grid), if_lb, 4, row, 1, 1);\r\nif_lb = gtk_label_new(" IP ");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), if_lb, 5, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\nif_lb = gtk_label_new("Packets");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), if_lb, 6, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\nif_lb = gtk_label_new(" Packets/s ");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), if_lb, 7, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\nrow++;\r\nheight += 30;\r\nsc = capture_stat_start(&global_capture_opts);\r\nfor (ifs = 0; ifs < global_capture_opts.all_ifaces->len; ifs++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, ifs);\r\ndata = g_array_index(if_array, if_dlg_data_t, ifs);\r\nif (device.hidden) {\r\ndata.hidden = TRUE;\r\nif_array = g_array_remove_index(if_array, ifs);\r\ng_array_insert_val(if_array, ifs, data);\r\ncontinue;\r\n}\r\ndata.choose_bt = gtk_check_button_new();\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), data.choose_bt, 0, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\nif (gbl_capture_in_progress) {\r\ngtk_widget_set_sensitive(data.choose_bt, FALSE);\r\n} else {\r\ngtk_widget_set_sensitive(data.choose_bt, TRUE);\r\n}\r\ngtk_toggle_button_set_active((GtkToggleButton *)data.choose_bt, device.selected);\r\ng_signal_connect(data.choose_bt, "toggled", G_CALLBACK(store_selected), device.name);\r\nicon = capture_get_if_icon(&(device));\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), icon, 1, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\n#ifdef _WIN32\r\ndata.device_lb = gtk_label_new(device.display_name);\r\n#else\r\ndata.device_lb = gtk_label_new(device.name);\r\n#endif\r\ngtk_misc_set_alignment(GTK_MISC(data.device_lb), 0.0f, 0.5f);\r\nif (strlen(gtk_label_get_text(GTK_LABEL(data.device_lb))) > SOFT_LABEL_LEN) {\r\ngtk_label_set_ellipsize(GTK_LABEL(data.device_lb), PANGO_ELLIPSIZE_MIDDLE);\r\ngtk_label_set_width_chars(GTK_LABEL(data.device_lb), SOFT_LABEL_LEN);\r\n}\r\nws_gtk_grid_attach_defaults(GTK_GRID(if_grid), data.device_lb, 2, row, 2, 1);\r\nuser_descr = capture_dev_user_descr_find(device.name);\r\nif (user_descr) {\r\ndata.descr_lb = gtk_label_new(user_descr);\r\ng_free (user_descr);\r\n} else {\r\nif (device.if_info.vendor_description)\r\ndata.descr_lb = gtk_label_new(device.if_info.vendor_description);\r\nelse\r\ndata.descr_lb = gtk_label_new("");\r\n}\r\ngtk_misc_set_alignment(GTK_MISC(data.descr_lb), 0.0f, 0.5f);\r\nif (strlen(gtk_label_get_text(GTK_LABEL(data.descr_lb))) > SOFT_LABEL_LEN) {\r\ngtk_label_set_ellipsize(GTK_LABEL(data.descr_lb), PANGO_ELLIPSIZE_MIDDLE);\r\ngtk_label_set_width_chars(GTK_LABEL(data.descr_lb), SOFT_LABEL_LEN);\r\n}\r\nws_gtk_grid_attach_defaults(GTK_GRID(if_grid), data.descr_lb, 4, row, 1, 1);\r\ndata.ip_lb = gtk_label_new("");\r\naddr_str = set_ip_addr_label (device.if_info.addrs, data.ip_lb, 0);\r\nif (addr_str) {\r\ngtk_widget_set_sensitive(data.ip_lb, TRUE);\r\n} else {\r\ngtk_widget_set_sensitive(data.ip_lb, FALSE);\r\n}\r\neb = gtk_event_box_new ();\r\ngtk_container_add(GTK_CONTAINER(eb), data.ip_lb);\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), eb, 5, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\nif (get_ip_addr_count(device.if_info.addrs) > 1) {\r\ng_object_set_data(G_OBJECT(eb), CAPTURE_IF_IP_ADDR_LABEL, data.ip_lb);\r\ngtk_widget_set_tooltip_text(eb, "Click to see additional IP addresses");\r\ng_signal_connect(eb, "enter-notify-event", G_CALLBACK(ip_label_enter_cb), NULL);\r\ng_signal_connect(eb, "leave-notify-event", G_CALLBACK(ip_label_leave_cb), NULL);\r\ng_signal_connect(eb, "button-press-event", G_CALLBACK(ip_label_press_cb), device.if_info.addrs);\r\n}\r\ndata.curr_lb = gtk_label_new("-");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), data.curr_lb, 6, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\ndata.last_lb = gtk_label_new("-");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), data.last_lb, 7, row, 1, 1,\r\n(GtkAttachOptions)0, (GtkAttachOptions)0, 0, 0);\r\n#ifdef _WIN32\r\ndata.details_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_CAPTURE_DETAILS);\r\ngtk_widget_set_tooltip_text(data.details_bt, "Open the capture details dialog of this interface.");\r\nws_gtk_grid_attach_extended(GTK_GRID(if_grid), data.details_bt, 8, row, 1, 1, 0, 0, 0, 0);\r\nif (capture_if_has_details(device.name)) {\r\ng_signal_connect(data.details_bt, "clicked", G_CALLBACK(capture_details_cb), device.name);\r\n} else {\r\ngtk_widget_set_sensitive(data.details_bt, FALSE);\r\n}\r\n#endif\r\nif_array = g_array_remove_index(if_array, ifs);\r\ng_array_insert_val(if_array, ifs, data);\r\nrow++;\r\nif (row <= 20) {\r\n#ifdef _WIN32\r\ngtk_widget_get_preferred_size(GTK_WIDGET(data.details_bt), &requisition, NULL);\r\n#else\r\ngtk_widget_get_preferred_size(GTK_WIDGET(data.choose_bt), &requisition, NULL);\r\n#endif\r\nheight += requisition.height;\r\n}\r\n}\r\ngtk_widget_get_preferred_size(GTK_WIDGET(close_bt), &requisition, NULL);\r\nheight += requisition.height + 40 + (row * 3);\r\ngtk_window_set_default_size(GTK_WINDOW(cap_if_w), -1, height);\r\ngtk_widget_show_all(cap_if_w);\r\ntimer_id = g_timeout_add(1000, update_all, sc);\r\n}\r\nvoid\r\ncapture_if_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nGtkWidget *bbox,\r\n*help_bt;\r\n#ifdef HAVE_AIRPCAP\r\nGtkWidget *decryption_cb;\r\n#endif\r\nif (cap_if_w != NULL) {\r\nreactivate_window(cap_if_w);\r\nreturn;\r\n}\r\nif (!can_capture()) {\r\nreturn;\r\n}\r\n#ifdef HAVE_AIRPCAP\r\nif (airpcap_if_active == NULL) {\r\nif (g_airpcap_if_list == NULL) {\r\nairpcap_enable_toolbar_widgets(wireless_tb,FALSE);\r\n} else {\r\nif (airpcap_if_active){\r\nairpcap_set_toolbar_stop_capture(airpcap_if_active);\r\n}\r\nairpcap_enable_toolbar_widgets(wireless_tb,FALSE);\r\n}\r\n}\r\nif (airpcap_if_active){\r\ndecryption_cb = (GtkWidget *)g_object_get_data(G_OBJECT(wireless_tb),AIRPCAP_TOOLBAR_DECRYPTION_KEY);\r\nupdate_decryption_mode_list(decryption_cb);\r\nairpcap_set_toolbar_start_capture(airpcap_if_active);\r\n}\r\n#endif\r\ncap_if_w = dlg_window_new("Wireshark: Capture Interfaces");\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(cap_if_w), TRUE);\r\ncap_if_top_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_UNRELATED_SPACING, FALSE);\r\ngtk_container_add(GTK_CONTAINER(cap_if_w), cap_if_top_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(cap_if_top_vb), DLG_OUTER_MARGIN);\r\nbbox = dlg_button_row_new(GTK_STOCK_HELP, WIRESHARK_STOCK_CAPTURE_START, WIRESHARK_STOCK_CAPTURE_OPTIONS, WIRESHARK_STOCK_CAPTURE_STOP, GTK_STOCK_CLOSE, NULL);\r\ngtk_box_pack_end(GTK_BOX(cap_if_top_vb), bbox, FALSE, FALSE, 0);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)(HELP_CAPTURE_INTERFACES_DIALOG));\r\nstop_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CAPTURE_STOP);\r\ng_signal_connect(stop_bt, "clicked", G_CALLBACK(capture_if_stop_cb), NULL);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(cap_if_w, close_bt, window_cancel_button_cb);\r\ngtk_widget_set_tooltip_text(close_bt, "Close this window.");\r\noptions_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CAPTURE_OPTIONS);\r\ng_signal_connect(options_bt, "clicked", G_CALLBACK(capture_prepare_cb), NULL);\r\ncapture_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CAPTURE_START);\r\ng_signal_connect(capture_bt, "clicked", G_CALLBACK(capture_do_cb), NULL);\r\ngtk_widget_grab_default(close_bt);\r\ng_signal_connect(cap_if_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(cap_if_w, "destroy", G_CALLBACK(capture_if_destroy_cb), sc);\r\ncapture_if_refresh_if_list();\r\nwindow_present(cap_if_w);\r\nset_capture_if_dialog_for_capture_in_progress(gbl_capture_in_progress);\r\n}\r\ngboolean interfaces_dialog_window_present(void)\r\n{\r\nreturn (cap_if_w?TRUE:FALSE);\r\n}\r\nvoid refresh_if_window(void)\r\n{\r\nif (cap_if_w) {\r\ncapture_if_refresh_if_list();\r\n}\r\n}\r\nvoid select_all_interfaces(gboolean enable _U_)\r\n{\r\nguint ifs;\r\ninterface_t device;\r\nfor (ifs = 0; ifs < global_capture_opts.all_ifaces->len; ifs++) {\r\ndevice = g_array_index(global_capture_opts.all_ifaces, interface_t, ifs);\r\nupdate_selected_interface(device.if_info.name);\r\n}\r\n}\r\nvoid destroy_if_window(void)\r\n{\r\nif (cap_if_w) {\r\nwindow_destroy(cap_if_w);\r\n}\r\n}\r\nvoid\r\nset_capture_if_dialog_for_capture_in_progress(gboolean capture_in_progress _U_)\r\n{\r\n}

static void AirPDcapTkipMixingPhase1(\r\nUINT16 *TTAK,\r\nconst UINT8 *TK,\r\nconst UINT8 *TA,\r\nUINT32 TSC)\r\n{\r\nUINT16 i, j;\r\nTTAK[0] = Lo16(TSC);\r\nTTAK[1] = Hi16(TSC);\r\nTTAK[2] = Mk16(TA[1], TA[0]);\r\nTTAK[3] = Mk16(TA[3], TA[2]);\r\nTTAK[4] = Mk16(TA[5], TA[4]);\r\nfor (i = 0; i < PHASE1_LOOP_COUNT; i++) {\r\nj = (UINT16)(2 * (i & 1));\r\nTTAK[0] = (UINT16)(TTAK[0] + _S_((UINT16)(TTAK[4] ^ Mk16(TK[1 + j], TK[0 + j]))));\r\nTTAK[1] = (UINT16)(TTAK[1] + _S_((UINT16)(TTAK[0] ^ Mk16(TK[5 + j], TK[4 + j]))));\r\nTTAK[2] = (UINT16)(TTAK[2] + _S_((UINT16)(TTAK[1] ^ Mk16(TK[9 + j], TK[8 + j]))));\r\nTTAK[3] = (UINT16)(TTAK[3] + _S_((UINT16)(TTAK[2] ^ Mk16(TK[13 + j], TK[12 + j]))));\r\nTTAK[4] = (UINT16)(TTAK[4] + _S_((UINT16)(TTAK[3] ^ Mk16(TK[1 + j], TK[0 + j]))) + i);\r\n}\r\n}\r\nstatic void AirPDcapTkipMixingPhase2(\r\nUINT8 *wep_seed,\r\nconst UINT8 *TK,\r\nUINT16 *TTAK,\r\nUINT16 TSC16)\r\n{\r\nINT i;\r\nTTAK[5] = (UINT16)(TTAK[4] + TSC16);\r\nTTAK[0] = (UINT16)(TTAK[0] + _S_((UINT16)(TTAK[5] ^ Mk16_le(&TK[0]))));\r\nTTAK[1] = (UINT16)(TTAK[1] + _S_((UINT16)(TTAK[0] ^ Mk16_le(&TK[2]))));\r\nTTAK[2] = (UINT16)(TTAK[2] + _S_((UINT16)(TTAK[1] ^ Mk16_le(&TK[4]))));\r\nTTAK[3] = (UINT16)(TTAK[3] + _S_((UINT16)(TTAK[2] ^ Mk16_le(&TK[6]))));\r\nTTAK[4] = (UINT16)(TTAK[4] + _S_((UINT16)(TTAK[3] ^ Mk16_le(&TK[8]))));\r\nTTAK[5] = (UINT16)(TTAK[5] + _S_((UINT16)(TTAK[4] ^ Mk16_le(&TK[10]))));\r\nTTAK[0] = (UINT16)(TTAK[0] + RotR1((UINT16)(TTAK[5] ^ Mk16_le(&TK[12]))));\r\nTTAK[1] = (UINT16)(TTAK[1] + RotR1((UINT16)(TTAK[0] ^ Mk16_le(&TK[14]))));\r\nTTAK[2] = (UINT16)(TTAK[2] + RotR1(TTAK[1]));\r\nTTAK[3] = (UINT16)(TTAK[3] + RotR1(TTAK[2]));\r\nTTAK[4] = (UINT16)(TTAK[4] + RotR1(TTAK[3]));\r\nTTAK[5] = (UINT16)(TTAK[5] + RotR1(TTAK[4]));\r\nwep_seed[0] = Hi8(TSC16);\r\nwep_seed[1] = (UINT8)((Hi8(TSC16) | 0x20) & 0x7F);\r\nwep_seed[2] = Lo8(TSC16);\r\nwep_seed[3] = Lo8((UINT16)((TTAK[5] ^ Mk16_le(&TK[0])) >> 1));\r\nfor (i = 0; i < 6; i++)\r\n{\r\nwep_seed[4 + ( 2 * i)] = Lo8( TTAK[i] );\r\nwep_seed[5 + ( 2 * i)] = Hi8( TTAK[i] );\r\n}\r\n}\r\nINT AirPDcapTkipDecrypt(\r\nUCHAR *tkip_mpdu,\r\nsize_t mpdu_len,\r\nUCHAR TA[AIRPDCAP_MAC_LEN],\r\nUCHAR TK[AIRPDCAP_TK_LEN])\r\n{\r\nUINT64 TSC64;\r\nUINT32 TSC;\r\nUINT16 TSC16;\r\nUINT8 *IV;\r\nUINT16 TTAK[AIRPDCAP_TTAK_LEN];\r\nUINT8 wep_seed[AIRPDCAP_WEP_128_KEY_LEN];\r\nIV = tkip_mpdu;\r\nTSC64 = READ_6(IV[2], IV[0], IV[4], IV[5], IV[6], IV[7]);\r\nTSC16 = (UINT16)TSC64;\r\nTSC = (UINT32)(TSC64 >> 16);\r\nAirPDcapTkipMixingPhase1(TTAK, TK, TA, TSC);\r\nAirPDcapTkipMixingPhase2(wep_seed, TK, TTAK, TSC16);\r\nreturn AirPDcapWepDecrypt(\r\nwep_seed,\r\nAIRPDCAP_WEP_128_KEY_LEN,\r\ntkip_mpdu + AIRPDCAP_TKIP_HEADER,\r\nmpdu_len-(AIRPDCAP_TKIP_HEADER+AIRPDCAP_WEP_ICV));\r\n}

static int\r\ndissect_bmc(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nguint8 message_type;\r\nguint8 *reversing_buffer;\r\ngint offset = 0;\r\ngint len;\r\nproto_item *ti;\r\nproto_tree *bmc_tree;\r\ntvbuff_t *bit_reversed_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "BMC");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_bmc, tvb, 0, -1, ENC_NA);\r\nbmc_tree = proto_item_add_subtree(ti, ett_bmc);\r\nlen = tvb_reported_length(tvb);\r\nreversing_buffer = (guint8 *)tvb_memdup(pinfo->pool, tvb, offset, len);\r\nbitswap_buf_inplace(reversing_buffer, len);\r\nbit_reversed_tvb = tvb_new_child_real_data(tvb, reversing_buffer, len, len);\r\nadd_new_data_source(pinfo, bit_reversed_tvb, "Bit-reversed Data");\r\nmessage_type = tvb_get_guint8(bit_reversed_tvb, offset);\r\nproto_tree_add_item(bmc_tree, hf_bmc_message_type, bit_reversed_tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", val_to_str(message_type, message_type_vals,"Reserved 0x%02x"));\r\nswitch (message_type) {\r\ncase MESSAGE_TYPE_CBS_MESSAGE:\r\noffset = dissect_bmc_cbs_message(bit_reversed_tvb, pinfo, bmc_tree);\r\nbreak;\r\ncase MESSAGE_TYPE_SCHEDULE_MESSAGE:\r\noffset = dissect_bmc_schedule_message(bit_reversed_tvb, pinfo, bmc_tree);\r\nbreak;\r\ncase MESSAGE_TYPE_CBS41_MESSAGE:\r\noffset = dissect_bmc_cbs41_message(bit_reversed_tvb, pinfo, bmc_tree);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_bmc_cbs_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\ntvbuff_t *cell_broadcast_tvb;\r\ngint offset = 1;\r\ndissect_cbs_message_identifier(tvb, tree, offset);\r\noffset += 2;\r\ndissect_cbs_serial_number(tvb, tree, offset);\r\noffset += 2;\r\ndissect_cbs_data_coding_scheme(tvb, pinfo, tree, offset);\r\noffset += 1;\r\ncell_broadcast_tvb = tvb_new_subset_remaining(tvb, offset);\r\ndissect_umts_cell_broadcast_message(cell_broadcast_tvb, pinfo, tree, NULL);\r\noffset = tvb_reported_length(cell_broadcast_tvb);\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_bmc_schedule_message(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\ngint offset = 1, i, saved_offset;\r\nguint8 new_message_bitmap_len;\r\nguint8 length_of_cbs_schedule_period;\r\nguint8 message_description_type;\r\nguint8 future_extension_bitmap;\r\nguint8 length_of_serial_number_list;\r\nguint8 entry;\r\nguint8 bit;\r\nproto_tree *message_description_tree;\r\nproto_item *ti;\r\nproto_tree_add_item(tree, hf_bmc_offset_to_begin_ctch_bs_index, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nlength_of_cbs_schedule_period = tvb_get_guint8(tvb,offset);\r\nproto_tree_add_item(tree, hf_bmc_length_of_cbs_schedule_period, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nnew_message_bitmap_len = length_of_cbs_schedule_period>>3;\r\nif (length_of_cbs_schedule_period & 0x7)\r\nnew_message_bitmap_len += 1;\r\nproto_tree_add_item(tree, hf_bmc_new_message_bitmap, tvb, offset, new_message_bitmap_len, ENC_NA);\r\noffset += new_message_bitmap_len;\r\nmessage_description_tree = proto_tree_add_subtree(tree, tvb, offset, 0,\r\nett_bmc_message_description, &ti, "Message Description" );\r\nsaved_offset = offset;\r\nbit=1;\r\nfor (i=0; i<new_message_bitmap_len; i++) {\r\nfor(; bit<=length_of_cbs_schedule_period; bit++) {\r\nmessage_description_type = tvb_get_guint8(tvb,offset);\r\nproto_tree_add_uint_format(message_description_tree, hf_bmc_message_description_type,\r\ntvb, offset, 1, message_description_type,\r\n"Message %d Message Description Type: %s (%d)",\r\nbit,\r\nval_to_str_const(message_description_type, message_description_type_vals,"Unknown"),\r\nmessage_description_type);\r\noffset += 1;\r\nif ((message_description_type==1) || (message_description_type==5)) {\r\nproto_tree_add_item(message_description_tree, hf_bmc_message_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nelse if ((message_description_type==0) || (message_description_type==4)) {\r\nproto_tree_add_item(message_description_tree, hf_bmc_offset_to_ctch_bs_index_of_first_transmission,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\n}\r\n}\r\n}\r\nproto_item_set_len(ti, offset-saved_offset);\r\nif (tvb_reported_length_remaining(tvb,offset)) {\r\nfuture_extension_bitmap = tvb_get_guint8(tvb,offset);\r\nproto_tree_add_item(tree, hf_bmc_future_extension_bitmap, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nif (future_extension_bitmap & 0x01) {\r\nlength_of_serial_number_list = tvb_get_guint8(tvb,offset);\r\nproto_tree_add_item(tree, hf_bmc_length_of_serial_number_list, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nfor (entry=0; entry<length_of_serial_number_list; entry++) {\r\nproto_tree_add_item(tree, hf_bmc_serial_number, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_bmc_ctch_bs_index, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\n}\r\n}\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_bmc_cbs41_message(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\ngint offset=1;\r\nproto_tree_add_item(tree, hf_bmc_broadcast_address, tvb, offset, 5, ENC_NA);\r\noffset += 5;\r\nproto_tree_add_item(tree, hf_bmc_cb_data41, tvb, offset, tvb_reported_length_remaining(tvb,offset), ENC_NA);\r\noffset = tvb_reported_length(tvb);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_bmc(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_bmc_message_type,\r\n{ "Message Type", "bmc.message_type",\r\nFT_UINT8, BASE_DEC, VALS(message_type_vals), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_message_id,\r\n{ "Message ID", "bmc.message_id",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_serial_number,\r\n{ "Serial Number", "bmc.serial_number",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_bmc_data_coding_scheme,\r\n{ "Data Coding Scheme", "bmc.data_coding_scheme",\r\nFT_UINT8, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_cb_data,\r\n{ "CB Data", "bmc.cb_data",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_bmc_offset_to_begin_ctch_bs_index,\r\n{ "Offset to Begin CTCH Block Set Index", "bmc.offset_to_begin_ctch_bs_index",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_length_of_cbs_schedule_period,\r\n{ "Length of CBS Schedule Period", "bmc.length_of_cbs_schedule_period",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_new_message_bitmap,\r\n{ "New Message Bitmap", "bmc.new_message_bitmap",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_message_description_type,\r\n{ "Message Description Type", "bmc.message_description_type",\r\nFT_UINT8, BASE_DEC, VALS(message_description_type_vals), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_offset_to_ctch_bs_index_of_first_transmission,\r\n{ "Offset to CTCH BS index of first transmission", "bmc.offset_to_ctch_bs_index_of_first_transmission",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_broadcast_address,\r\n{ "Broadcast Address", "bmc.broadcast_address",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_cb_data41,\r\n{ "CB Data41", "bmc.cb_data41",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_future_extension_bitmap,\r\n{ "Future Extension Bitmap", "bmc.future_extension_bitmap",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_length_of_serial_number_list,\r\n{ "Length of Serial Number List", "bmc.length_of_serial_number_list",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_bmc_ctch_bs_index,\r\n{ "CTCH BS Index", "bmc.ctch_bs_index",\r\nFT_UINT8, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_bmc,\r\n&ett_bmc_message_description\r\n};\r\nproto_bmc = proto_register_protocol("Broadcast/Multicast Control", "BMC", "bmc");\r\nregister_dissector("bmc", dissect_bmc, proto_bmc);\r\nproto_register_field_array(proto_bmc, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}

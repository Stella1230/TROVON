ssize_t\r\npipe_write_header(int pipe_fd, char indicator, int length)\r\n{\r\nguchar header[1+3];\r\ng_assert(length <= SP_MAX_MSG_LEN);\r\nheader[0] = indicator;\r\nheader[1] = (length >> 16) & 0xFF;\r\nheader[2] = (length >> 8) & 0xFF;\r\nheader[3] = (length >> 0) & 0xFF;\r\nreturn ws_write(pipe_fd, header, sizeof header);\r\n}\r\nvoid\r\npipe_write_block(int pipe_fd, char indicator, const char *msg)\r\n{\r\nssize_t ret;\r\nint len;\r\nif(msg != NULL) {\r\nlen = (int) strlen(msg) + 1;\r\n} else {\r\nlen = 0;\r\n}\r\nret = pipe_write_header(pipe_fd, indicator, len);\r\nif(ret == -1) {\r\nreturn;\r\n}\r\nif(len) {\r\nret = ws_write(pipe_fd, msg, len);\r\nif(ret == -1) {\r\nreturn;\r\n}\r\n} else {\r\n}\r\n}\r\nvoid\r\nsync_pipe_errmsg_to_parent(int pipe_fd, const char *error_msg,\r\nconst char *secondary_error_msg)\r\n{\r\npipe_write_header(pipe_fd, SP_ERROR_MSG, (int) (strlen(error_msg) + 1 + 4 + strlen(secondary_error_msg) + 1 + 4));\r\npipe_write_block(pipe_fd, SP_ERROR_MSG, error_msg);\r\npipe_write_block(pipe_fd, SP_ERROR_MSG, secondary_error_msg);\r\n}

static void\r\nvisible_toggled(GtkCellRendererToggle *cell _U_, gchar *path_str, gpointer data)\r\n{\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreeIter iter;\r\nGtkTreePath *path = gtk_tree_path_new_from_string(path_str);\r\nGList *clp;\r\nfmt_data *cfmt;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\ncfmt = (fmt_data *) clp->data;\r\nif (cfmt->visible)\r\ncfmt->visible = FALSE;\r\nelse\r\ncfmt->visible = TRUE;\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, VISIBLE_COLUMN, cfmt->visible, -1);\r\ncfile.columns_changed = TRUE;\r\ngtk_tree_path_free(path);\r\n}\r\nGtkWidget *\r\ncolumn_prefs_show(GtkWidget *prefs_window) {\r\nGtkWidget *main_vb, *bottom_hb, *column_l, *add_bt, *grid, *lb;\r\nGtkWidget *list_vb, *list_lb, *list_sc;\r\nGtkWidget *add_remove_vb;\r\nGtkWidget *props_fr, *props_hb;\r\nGList *clp;\r\nfmt_data *cfmt;\r\ngint i;\r\ngchar *fmt;\r\nstatic const gchar *column_titles[] = {"Displayed", "Title", "Field type"};\r\nGtkListStore *store;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nGtkTreeSelection *sel;\r\nGtkTreeIter iter;\r\nGtkTreeIter first_iter;\r\ngint first_row = TRUE;\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_widget_show(main_vb);\r\nlist_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (list_vb), 5);\r\ngtk_widget_show (list_vb);\r\ngtk_box_pack_start (GTK_BOX (main_vb), list_vb, TRUE, TRUE, 0);\r\nlist_lb = gtk_label_new (\r\n"[The first list entry will be displayed as the leftmost column"\r\n" - Drag and drop entries to change column order]");\r\ngtk_widget_show (list_lb);\r\ngtk_box_pack_start (GTK_BOX (list_vb), list_lb, FALSE, FALSE, 0);\r\nlist_sc = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(list_sc), GTK_SHADOW_IN);\r\ngtk_box_pack_start(GTK_BOX(list_vb), list_sc, TRUE, TRUE, 0);\r\ngtk_widget_show(list_sc);\r\nstore = gtk_list_store_new(N_COLUMN,\r\nG_TYPE_BOOLEAN,\r\nG_TYPE_STRING, G_TYPE_STRING, G_TYPE_POINTER);\r\ncolumn_row_deleted_handler_id =\r\ng_signal_connect(GTK_TREE_MODEL(store), "row-deleted", G_CALLBACK(column_dnd_row_deleted_cb), NULL);\r\ncolumn_l = tree_view_new(GTK_TREE_MODEL(store));\r\ngtk_tree_view_set_headers_visible(GTK_TREE_VIEW(column_l), TRUE);\r\ngtk_tree_view_set_headers_clickable(GTK_TREE_VIEW(column_l), FALSE);\r\ngtk_tree_view_set_reorderable(GTK_TREE_VIEW(column_l), TRUE);\r\ngtk_widget_set_tooltip_text(column_l, "Click on a title to change its name.\nDrag an item to change its order.");\r\nrenderer = gtk_cell_renderer_toggle_new();\r\ng_signal_connect(renderer, "toggled", G_CALLBACK(visible_toggled), store);\r\ncolumn = gtk_tree_view_column_new_with_attributes(column_titles[VISIBLE_COLUMN], renderer, "active", VISIBLE_COLUMN, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(column_l), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ng_object_set(G_OBJECT(renderer), "editable", TRUE, NULL);\r\ng_signal_connect (renderer, "edited", G_CALLBACK(column_title_changed_cb), GTK_TREE_MODEL(store));\r\ncolumn = gtk_tree_view_column_new_with_attributes(column_titles[TITLE_COLUMN], renderer, "text", TITLE_COLUMN, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(column_l), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes(column_titles[FORMAT_COLUMN], renderer, "text", FORMAT_COLUMN, NULL);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_AUTOSIZE);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(column_l), column);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(column_l));\r\ngtk_tree_selection_set_mode(sel, GTK_SELECTION_SINGLE);\r\ng_signal_connect(sel, "changed", G_CALLBACK(column_list_select_cb), NULL);\r\ngtk_container_add(GTK_CONTAINER(list_sc), column_l);\r\ngtk_widget_show(column_l);\r\nclp = g_list_first(prefs.col_list);\r\nwhile (clp) {\r\ncfmt = (fmt_data *) clp->data;\r\nif (cfmt->fmt == COL_CUSTOM) {\r\nif (cfmt->custom_occurrence) {\r\nfmt = g_strdup_printf("%s (%s#%d)", col_format_desc(cfmt->fmt), cfmt->custom_fields, cfmt->custom_occurrence);\r\n} else {\r\nfmt = g_strdup_printf("%s (%s)", col_format_desc(cfmt->fmt), cfmt->custom_fields);\r\n}\r\n} else {\r\nif (cfmt->custom_fields) {\r\ng_free (cfmt->custom_fields);\r\ncfmt->custom_fields = NULL;\r\ncfmt->custom_occurrence = 0;\r\n}\r\nfmt = g_strdup(col_format_desc(cfmt->fmt));\r\n}\r\ngtk_list_store_insert_with_values(store, &iter, G_MAXINT,\r\nVISIBLE_COLUMN, cfmt->visible,\r\nTITLE_COLUMN, cfmt->title, FORMAT_COLUMN, fmt, DATA_COLUMN, clp, -1);\r\nif (first_row) {\r\nfirst_iter = iter;\r\nfirst_row = FALSE;\r\n}\r\nclp = clp->next;\r\ng_free (fmt);\r\n}\r\ng_object_unref(G_OBJECT(store));\r\nbottom_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5, FALSE);\r\ngtk_box_pack_start (GTK_BOX (main_vb), bottom_hb, FALSE, FALSE, 0);\r\ngtk_widget_show(bottom_hb);\r\nadd_remove_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, TRUE);\r\ngtk_container_set_border_width (GTK_CONTAINER (add_remove_vb), 5);\r\ngtk_box_pack_start (GTK_BOX (bottom_hb), add_remove_vb, FALSE, FALSE, 0);\r\ngtk_widget_show(add_remove_vb);\r\nadd_bt = ws_gtk_button_new_from_stock(GTK_STOCK_ADD);\r\ng_signal_connect(add_bt, "clicked", G_CALLBACK(column_list_new_cb), column_l);\r\ngtk_box_pack_start (GTK_BOX (add_remove_vb), add_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(add_bt, "Add a new column at the end of the list.");\r\ngtk_widget_show(add_bt);\r\nremove_bt = ws_gtk_button_new_from_stock(GTK_STOCK_REMOVE);\r\ngtk_widget_set_sensitive(remove_bt, FALSE);\r\ng_signal_connect(remove_bt, "clicked", G_CALLBACK(column_list_delete_cb), column_l);\r\ngtk_box_pack_start (GTK_BOX (add_remove_vb), remove_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(remove_bt, "Remove the selected column.");\r\ngtk_widget_show(remove_bt);\r\nprops_fr = gtk_frame_new("Properties");\r\ngtk_box_pack_start (GTK_BOX (bottom_hb), props_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(props_fr);\r\ngrid = ws_gtk_grid_new();\r\ngtk_container_set_border_width(GTK_CONTAINER(grid), 5);\r\ngtk_container_add(GTK_CONTAINER(props_fr), grid);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(grid), 10);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(grid), 15);\r\ngtk_widget_show(grid);\r\nlb = gtk_label_new("Field type:");\r\ngtk_misc_set_alignment(GTK_MISC(lb), 0.0f, 0.5f);\r\nws_gtk_grid_attach_extended(GTK_GRID(grid), lb, 0, 0, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_tooltip_text(lb, "Select which packet information to present in the column.");\r\ngtk_widget_show(lb);\r\nprops_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 5, FALSE);\r\nws_gtk_grid_attach_extended(GTK_GRID(grid), props_hb, 1, 0, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_tooltip_text(props_hb, "Select which packet information to present in the column.");\r\ngtk_widget_show(props_hb);\r\nfield_lb = gtk_label_new("Field name:");\r\ngtk_misc_set_alignment(GTK_MISC(field_lb), 0.0f, 0.5f);\r\nws_gtk_grid_attach_extended(GTK_GRID(grid), field_lb, 0, 1, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(field_lb, FALSE);\r\ngtk_widget_set_tooltip_text(field_lb,\r\n"Display filter field name to show when the field type is \"Custom\".");\r\ngtk_widget_show(field_lb);\r\nfield_te = gtk_entry_new();\r\ng_object_set_data (G_OBJECT(field_te), E_FILT_MULTI_FIELD_NAME_ONLY_KEY, (gpointer)"");\r\ng_signal_connect(field_te, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ncolumn_field_changed_handler_id =\r\ng_signal_connect(field_te, "changed", G_CALLBACK(column_field_changed_cb), column_l);\r\ng_object_set_data(G_OBJECT(main_vb), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(field_te, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(prefs_window, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ncolorize_filter_te_as_empty(field_te);\r\nws_gtk_grid_attach_extended(GTK_GRID(grid), field_te, 1, 1, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(field_te, FALSE);\r\ngtk_widget_set_tooltip_text(field_te,\r\n"Display filter field name to show when the field type is \"Custom\".");\r\ngtk_widget_show(field_te);\r\noccurrence_lb = gtk_label_new("Field occurrence:");\r\ngtk_misc_set_alignment(GTK_MISC(occurrence_lb), 0.0f, 0.5f);\r\nws_gtk_grid_attach_extended(GTK_GRID(grid), occurrence_lb, 2, 1, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(occurrence_lb, FALSE);\r\ngtk_widget_set_tooltip_text(occurrence_lb,\r\n"Field occurrence to use. "\r\n"0=all (default), 1=first, 2=second, ..., -1=last.");\r\ngtk_widget_show(occurrence_lb);\r\noccurrence_te = gtk_entry_new();\r\ngtk_entry_set_max_length (GTK_ENTRY(occurrence_te),4);\r\ng_object_set_data (G_OBJECT(occurrence_te), "occurrence", (gpointer)"");\r\ncolumn_occurrence_changed_handler_id =\r\ng_signal_connect(occurrence_te, "changed", G_CALLBACK(column_occurrence_changed_cb), column_l);\r\nws_gtk_grid_attach_extended(GTK_GRID(grid), occurrence_te, 3, 1, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(occurrence_te, FALSE);\r\ngtk_widget_set_tooltip_text(occurrence_te,\r\n"Field occurrence to use. "\r\n"0=all (default), 1=first, 2=second, ..., -1=last.");\r\ngtk_widget_show(occurrence_te);\r\nfmt_cmb = gtk_combo_box_text_new();\r\nfor (i = 0; i < NUM_COL_FMTS; i++)\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(fmt_cmb), col_format_desc(i));\r\ncolumn_menu_changed_handler_id = g_signal_connect(fmt_cmb, "changed", G_CALLBACK(column_menu_changed_cb), column_l);\r\ngtk_widget_set_sensitive(fmt_cmb, FALSE);\r\ngtk_box_pack_start(GTK_BOX(props_hb), fmt_cmb, FALSE, FALSE, 0);\r\ngtk_widget_show(fmt_cmb);\r\ngtk_tree_selection_select_iter(sel, &first_iter);\r\nreturn(main_vb);\r\n}\r\nstatic void\r\ncolumn_list_new_cb(GtkWidget *w _U_, gpointer data) {\r\ngint cur_fmt;\r\nconst gchar *title = "New Column";\r\nGtkTreeView *column_l = GTK_TREE_VIEW(data);\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkTreePath *path;\r\nGtkTreeViewColumn *title_column;\r\ncur_fmt = COL_NUMBER;\r\ncolumn_prefs_add_custom (cur_fmt, title, NULL, 0);\r\nmodel = gtk_tree_view_get_model(column_l);\r\ngtk_list_store_insert_with_values(GTK_LIST_STORE(model), &iter, G_MAXINT,\r\nVISIBLE_COLUMN, TRUE,\r\nTITLE_COLUMN, title,\r\nFORMAT_COLUMN, col_format_desc(cur_fmt),\r\nDATA_COLUMN, g_list_last(prefs.col_list),\r\n-1);\r\ngtk_tree_selection_select_iter(gtk_tree_view_get_selection(column_l), &iter);\r\npath = gtk_tree_model_get_path(model, &iter);\r\ntitle_column = gtk_tree_view_get_column(column_l, 0);\r\ngtk_tree_view_set_cursor(column_l, path, title_column, TRUE);\r\ngtk_tree_path_free(path);\r\ncfile.columns_changed = TRUE;\r\n}\r\nstatic void\r\ncolumn_list_delete_cb(GtkWidget *w _U_, gpointer data) {\r\nGtkTreeView *column_l = GTK_TREE_VIEW(data);\r\nGList *clp;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkTreeIter new_iter;\r\nsel = gtk_tree_view_get_selection(column_l);\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter))\r\n{\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\ncolumn_prefs_remove_link(clp);\r\nnew_iter = iter;\r\nif ( gtk_tree_model_iter_next(model, &new_iter)) {\r\ngtk_tree_selection_select_iter(sel, &new_iter);\r\n} else {\r\nGtkTreePath *path = gtk_tree_model_get_path(model, &iter);\r\nif (gtk_tree_path_prev(path)) {\r\ngtk_tree_model_get_iter(model, &new_iter, path);\r\ngtk_tree_selection_select_iter(sel, &new_iter);\r\n}\r\ngtk_tree_path_free(path);\r\n}\r\ng_signal_handler_block(model, column_row_deleted_handler_id);\r\ngtk_list_store_remove(GTK_LIST_STORE(model), &iter);\r\ng_signal_handler_unblock (model, column_row_deleted_handler_id);\r\ncfile.columns_changed = TRUE;\r\n}\r\n}\r\nstatic gboolean\r\ncolumn_title_changed_cb(GtkCellRendererText *cell _U_, const gchar *str_path, const gchar *new_title, gpointer data) {\r\nfmt_data *cfmt;\r\nGList *clp;\r\nGtkTreeModel *model = (GtkTreeModel *)data;\r\nGtkTreePath *path = gtk_tree_path_new_from_string (str_path);\r\nGtkTreeIter iter;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, TITLE_COLUMN, new_title, -1);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\nif (clp) {\r\ncfmt = (fmt_data *) clp->data;\r\ng_free(cfmt->title);\r\ncfmt->title = g_strdup(new_title);\r\n}\r\ngtk_tree_path_free (path);\r\ncfile.columns_changed = TRUE;\r\nreturn TRUE;\r\n}\r\nstatic void\r\ncolumn_list_select_cb(GtkTreeSelection *sel, gpointer data _U_)\r\n{\r\nfmt_data *cfmt;\r\nGList *clp;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter))\r\n{\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\ng_assert(clp != NULL);\r\ncfmt = (fmt_data *) clp->data;\r\ng_signal_handler_block (fmt_cmb, column_menu_changed_handler_id);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(fmt_cmb), cfmt->fmt);\r\ng_signal_handler_unblock(fmt_cmb, column_menu_changed_handler_id);\r\ng_signal_handler_block (field_te, column_field_changed_handler_id);\r\ng_signal_handler_block (occurrence_te, column_occurrence_changed_handler_id);\r\nif (cfmt->fmt == COL_CUSTOM) {\r\ngtk_entry_set_text(GTK_ENTRY(field_te), cfmt->custom_fields);\r\ngtk_widget_set_sensitive(field_lb, TRUE);\r\ngtk_widget_set_sensitive(field_te, TRUE);\r\ng_snprintf(custom_occurrence_str, sizeof(custom_occurrence_str), "%d", cfmt->custom_occurrence);\r\ngtk_entry_set_text(GTK_ENTRY(occurrence_te), custom_occurrence_str);\r\ngtk_widget_set_sensitive(occurrence_lb, TRUE);\r\ngtk_widget_set_sensitive(occurrence_te, TRUE);\r\n} else {\r\ngtk_editable_delete_text(GTK_EDITABLE(field_te), 0, -1);\r\ngtk_widget_set_sensitive(field_lb, FALSE);\r\ngtk_widget_set_sensitive(field_te, FALSE);\r\ngtk_editable_delete_text(GTK_EDITABLE(occurrence_te), 0, -1);\r\ngtk_widget_set_sensitive(occurrence_lb, FALSE);\r\ngtk_widget_set_sensitive(occurrence_te, FALSE);\r\n}\r\ng_signal_handler_unblock(occurrence_te, column_occurrence_changed_handler_id);\r\ng_signal_handler_unblock(field_te, column_field_changed_handler_id);\r\ngtk_widget_set_sensitive(remove_bt, TRUE);\r\ngtk_widget_set_sensitive(fmt_cmb, TRUE);\r\n}\r\nelse\r\n{\r\ngtk_editable_delete_text(GTK_EDITABLE(field_te), 0, -1);\r\ngtk_editable_delete_text(GTK_EDITABLE(occurrence_te), 0, -1);\r\ngtk_widget_set_sensitive(remove_bt, FALSE);\r\ngtk_widget_set_sensitive(field_te, FALSE);\r\ngtk_widget_set_sensitive(occurrence_te, FALSE);\r\ngtk_widget_set_sensitive(fmt_cmb, FALSE);\r\n}\r\n}\r\nstatic void\r\ncolumn_menu_changed_cb(GtkWidget *w, gpointer data) {\r\nGtkTreeView *column_l = GTK_TREE_VIEW(data);\r\nfmt_data *cfmt;\r\ngint cur_cb_fmt;\r\nGList *clp;\r\ngchar *fmt;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nsel = gtk_tree_view_get_selection(column_l);\r\nif (! (gtk_tree_selection_get_selected(sel, &model, &iter)))\r\nreturn;\r\ncur_cb_fmt = gtk_combo_box_get_active(GTK_COMBO_BOX(w));\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\ncfmt = (fmt_data *) clp->data;\r\ng_assert(cur_cb_fmt != cfmt->fmt);\r\ng_signal_handler_block (field_te, column_field_changed_handler_id);\r\ng_signal_handler_block (occurrence_te, column_occurrence_changed_handler_id);\r\nif (cfmt->fmt == COL_CUSTOM) {\r\ngtk_editable_delete_text(GTK_EDITABLE(field_te), 0, -1);\r\ngtk_editable_delete_text(GTK_EDITABLE(occurrence_te), 0, -1);\r\nfmt = g_strdup(col_format_desc(cur_cb_fmt));\r\ngtk_widget_set_sensitive(field_lb, FALSE);\r\ngtk_widget_set_sensitive(field_te, FALSE);\r\ngtk_widget_set_sensitive(occurrence_lb, FALSE);\r\ngtk_widget_set_sensitive(occurrence_te, FALSE);\r\n} else if (cur_cb_fmt == COL_CUSTOM) {\r\nif (cfmt->custom_fields == NULL)\r\ncfmt->custom_fields = g_strdup("");\r\ngtk_entry_set_text(GTK_ENTRY(field_te), cfmt->custom_fields);\r\ng_snprintf(custom_occurrence_str, sizeof(custom_occurrence_str), "%d", cfmt->custom_occurrence);\r\ngtk_entry_set_text(GTK_ENTRY(occurrence_te), custom_occurrence_str);\r\nif (cfmt->custom_occurrence) {\r\nfmt = g_strdup_printf("%s (%s#%d)", col_format_desc(cur_cb_fmt), cfmt->custom_fields, cfmt->custom_occurrence);\r\n} else {\r\nfmt = g_strdup_printf("%s (%s)", col_format_desc(cur_cb_fmt), cfmt->custom_fields);\r\n}\r\ngtk_widget_set_sensitive(field_lb, TRUE);\r\ngtk_widget_set_sensitive(field_te, TRUE);\r\ngtk_widget_set_sensitive(occurrence_lb, TRUE);\r\ngtk_widget_set_sensitive(occurrence_te, TRUE);\r\n} else {\r\nfmt = g_strdup(col_format_desc(cur_cb_fmt));\r\n}\r\ng_signal_handler_unblock(occurrence_te, column_occurrence_changed_handler_id);\r\ng_signal_handler_unblock(field_te, column_field_changed_handler_id);\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, FORMAT_COLUMN, fmt, -1);\r\ng_free(fmt);\r\ncfmt->fmt = cur_cb_fmt;\r\ncfile.columns_changed = TRUE;\r\n}\r\nstatic void\r\ncolumn_field_changed_cb(GtkEditable *te, gpointer data) {\r\nfmt_data *cfmt;\r\nGList *clp;\r\ngchar *field, *fmt;\r\nGtkTreeView *tree = (GtkTreeView *)data;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nsel = gtk_tree_view_get_selection(tree);\r\nif ( ! (gtk_tree_selection_get_selected(sel, &model, &iter))) {\r\nreturn;\r\n}\r\nfield = gtk_editable_get_chars(te, 0, -1);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\ncfmt = (fmt_data *) clp->data;\r\nif (strcmp(cfmt->custom_fields, field) == 0) {\r\nreturn;\r\n}\r\nif (cfmt->custom_occurrence) {\r\nfmt = g_strdup_printf("%s (%s#%d)", col_format_desc(cfmt->fmt), field, cfmt->custom_occurrence);\r\n} else {\r\nfmt = g_strdup_printf("%s (%s)", col_format_desc(cfmt->fmt), field);\r\n}\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, FORMAT_COLUMN, fmt, -1);\r\ng_free(fmt);\r\ng_free(cfmt->custom_fields);\r\ncfmt->custom_fields = field;\r\ncfile.columns_changed = TRUE;\r\n}\r\nstatic void\r\ncolumn_occurrence_changed_cb(GtkEditable *te, gpointer data) {\r\nfmt_data *cfmt;\r\ngint occurrence;\r\nGList *clp;\r\ngchar *fmt;\r\nGtkTreeView *tree = (GtkTreeView *)data;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nsel = gtk_tree_view_get_selection(tree);\r\nif ( ! (gtk_tree_selection_get_selected(sel, &model, &iter))) {\r\nreturn;\r\n}\r\noccurrence = (gint)strtol(gtk_editable_get_chars(te, 0, -1), NULL, 10);\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\ncfmt = (fmt_data *) clp->data;\r\nif (cfmt->custom_occurrence == occurrence) {\r\nreturn;\r\n}\r\nif (occurrence) {\r\nfmt = g_strdup_printf("%s (%s#%d)", col_format_desc(cfmt->fmt), cfmt->custom_fields, occurrence);\r\n} else {\r\nfmt = g_strdup_printf("%s (%s)", col_format_desc(cfmt->fmt), cfmt->custom_fields);\r\n}\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, FORMAT_COLUMN, fmt, -1);\r\ng_free(fmt);\r\ncfmt->custom_occurrence = occurrence;\r\ncfile.columns_changed = TRUE;\r\n}\r\nstatic void\r\ncolumn_dnd_row_deleted_cb(GtkTreeModel *model, GtkTreePath *path _U_, gpointer data _U_) {\r\nGtkTreeIter iter;\r\nGList *clp, *new_col_list = NULL;\r\ngboolean items_left;\r\nfor (items_left = gtk_tree_model_get_iter_first (model, &iter);\r\nitems_left;\r\nitems_left = gtk_tree_model_iter_next (model, &iter)) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &clp, -1);\r\nif (clp) {\r\nprefs.col_list = g_list_remove_link(prefs.col_list, clp);\r\nnew_col_list = g_list_concat(new_col_list, clp);\r\n}\r\n}\r\nif (prefs.col_list) {\r\ng_warning("column_dnd_row_deleted_cb: prefs.col_list has %d leftover data",\r\ng_list_length(prefs.col_list));\r\ng_list_free(prefs.col_list);\r\n}\r\nprefs.col_list = new_col_list;\r\ncfile.columns_changed = TRUE;\r\n}\r\nvoid\r\ncolumn_prefs_fetch(GtkWidget *w _U_) {\r\n}\r\nvoid\r\ncolumn_prefs_apply(GtkWidget *w _U_)\r\n{\r\nif(cfile.columns_changed) {\r\npacket_list_recreate();\r\ncfile.columns_changed = FALSE;\r\n}\r\n}\r\nvoid\r\ncolumn_prefs_destroy(GtkWidget *w _U_) {\r\n}

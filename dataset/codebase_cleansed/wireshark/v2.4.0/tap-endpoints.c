static void\r\nendpoints_draw(void *arg)\r\n{\r\nconv_hash_t *hash = (conv_hash_t*)arg;\r\nendpoints_t *iu = (endpoints_t *)hash->user_data;\r\nhostlist_talker_t *host;\r\nguint64 last_frames, max_frames;\r\nguint i;\r\ngboolean display_port = (!strncmp(iu->type, "TCP", 3) || !strncmp(iu->type, "UDP", 3) || !strncmp(iu->type, "SCTP", 4)) ? TRUE : FALSE;\r\nprintf("================================================================================\n");\r\nprintf("%s Endpoints\n", iu->type);\r\nprintf("Filter:%s\n", iu->filter ? iu->filter : "<No Filter>");\r\nprintf(" | %sPackets | | Bytes | | Tx Packets | | Tx Bytes | | Rx Packets | | Rx Bytes |\n",\r\ndisplay_port ? "Port || " : "");\r\nmax_frames = UINT_MAX;\r\ndo {\r\nlast_frames = 0;\r\nfor (i=0; (iu->hash.conv_array && i < iu->hash.conv_array->len); i++) {\r\nguint64 tot_frames;\r\nhost = &g_array_index(iu->hash.conv_array, hostlist_talker_t, i);\r\ntot_frames = host->rx_frames + host->tx_frames;\r\nif ((tot_frames > last_frames) && (tot_frames < max_frames)) {\r\nlast_frames = tot_frames;\r\n}\r\n}\r\nfor (i=0; (iu->hash.conv_array && i < iu->hash.conv_array->len); i++) {\r\nguint64 tot_frames;\r\ngchar *conversation_str, *port_str;\r\nhost = &g_array_index(iu->hash.conv_array, hostlist_talker_t, i);\r\ntot_frames = host->rx_frames + host->tx_frames;\r\nif (tot_frames == last_frames) {\r\nconversation_str = get_conversation_address(NULL, &host->myaddress, TRUE);\r\nif (display_port) {\r\nport_str = get_conversation_port(NULL, host->port, host->ptype, TRUE);\r\nprintf("%-20s %5s %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER\r\n"u %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u %6"\r\nG_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u \n",\r\nconversation_str,\r\nport_str,\r\nhost->tx_frames+host->rx_frames, host->tx_bytes+host->rx_bytes,\r\nhost->tx_frames, host->tx_bytes,\r\nhost->rx_frames, host->rx_bytes);\r\nwmem_free(NULL, port_str);\r\n} else {\r\nprintf("%-20s %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER\r\n"u %6" G_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u %6"\r\nG_GINT64_MODIFIER "u %9" G_GINT64_MODIFIER "u \n",\r\nconversation_str,\r\nhost->tx_frames+host->rx_frames, host->tx_bytes+host->rx_bytes,\r\nhost->tx_frames, host->tx_bytes,\r\nhost->rx_frames, host->rx_bytes);\r\n}\r\nwmem_free(NULL, conversation_str);\r\n}\r\n}\r\nmax_frames = last_frames;\r\n} while (last_frames);\r\nprintf("================================================================================\n");\r\n}\r\nvoid init_hostlists(struct register_ct *ct, const char *filter)\r\n{\r\nendpoints_t *iu;\r\nGString *error_string;\r\niu = g_new0(endpoints_t, 1);\r\niu->type = proto_get_protocol_short_name(find_protocol_by_id(get_conversation_proto_id(ct)));\r\niu->filter = g_strdup(filter);\r\niu->hash.user_data = iu;\r\nerror_string = register_tap_listener(proto_get_protocol_filter_name(get_conversation_proto_id(ct)), &iu->hash, filter, 0, NULL, get_hostlist_packet_func(ct), endpoints_draw);\r\nif (error_string) {\r\ng_free(iu);\r\nfprintf(stderr, "tshark: Couldn't register endpoint tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}

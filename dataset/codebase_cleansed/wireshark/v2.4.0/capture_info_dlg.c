static void\r\ncapture_info_stop(capture_session *cap_session)\r\n{\r\n#ifdef HAVE_AIRPCAP\r\nairpcap_set_toolbar_stop_capture(airpcap_if_active);\r\n#endif\r\ncapture_stop(cap_session);\r\n}\r\nstatic gboolean\r\ncapture_info_delete_cb(GtkWidget *w _U_, GdkEvent *event _U_, gpointer data) {\r\ncapture_info_stop((capture_session *)data);\r\nreturn TRUE;\r\n}\r\nstatic void\r\ncapture_info_stop_clicked_cb(GtkButton *w _U_, gpointer data) {\r\ncapture_info_stop((capture_session *)data);\r\n}\r\nstatic gboolean\r\ncapture_info_ui_update_cb(gpointer data)\r\n{\r\ncapture_info *cinfo = (capture_info *)data;\r\ncapture_info_ui_t *info = (capture_info_ui_t *)cinfo->ui;\r\nif (!info)\r\nreturn TRUE;\r\ncinfo->running_time = time(NULL) - info->start_time;\r\ncapture_info_ui_update(cinfo);\r\nreturn TRUE;\r\n}\r\nstatic void\r\ncapture_info_count_init(capture_info_counts_t* count, int idx, GtkWidget *percent_pb, gboolean show, GtkWidget *counts_grid)\r\n{\r\ncount->label = gtk_label_new(count->title);\r\ngtk_misc_set_alignment(GTK_MISC(count->label), 0.0f, 0.5f);\r\ncount->value_lb = gtk_label_new("0");\r\ngtk_misc_set_alignment(GTK_MISC(count->value_lb), 0.5f, 0.5f);\r\ncount->percent_pb = percent_pb;\r\nif (!show)\r\n{\r\ngtk_widget_set_size_request(count->percent_pb, 70, -1);\r\n}\r\ncount->percent_lb = gtk_label_new("0.0%");\r\ngtk_misc_set_alignment(GTK_MISC(count->percent_lb), 1.0f, 0.5f);\r\nws_gtk_grid_attach_extended(GTK_GRID(counts_grid), count->label,\r\n0, idx, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nws_gtk_grid_attach_extended(GTK_GRID(counts_grid), count->value_lb,\r\n1, idx, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nws_gtk_grid_attach_extended(GTK_GRID(counts_grid), count->percent_pb,\r\n2, idx, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nws_gtk_grid_attach_extended(GTK_GRID(counts_grid), count->percent_lb,\r\n3, idx, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_show(count->label);\r\ngtk_widget_show(count->value_lb);\r\ngtk_widget_show(count->percent_pb);\r\nif (show) {\r\ngtk_widget_show(count->percent_lb);\r\n}\r\n}\r\nvoid\r\ncapture_info_ui_create(capture_info *cinfo, capture_session *cap_session)\r\n{\r\ncapture_options *capture_opts = cap_session->capture_opts;\r\nunsigned int i;\r\nGtkWidget *main_vb, *stop_bt, *counts_grid;\r\nGtkWidget *counts_fr, *running_grid, *running_label, *lb, *bbox, *ci_help;\r\ncapture_info_ui_t *info;\r\ngchar *cap_w_title;\r\ngchar *title_iface;\r\nGString *str;\r\ninfo = g_new0(capture_info_ui_t,1);\r\ninfo->total_count.title = "Total";\r\ninfo->other_count.title = "Other";\r\ninfo->counts[0].title = "SCTP";\r\ninfo->counts[0].proto = proto_get_id_by_short_name(info->counts[0].title);\r\ninfo->counts[1].title = "TCP";\r\ninfo->counts[1].proto = proto_get_id_by_short_name(info->counts[1].title);\r\ninfo->counts[2].title = "UDP";\r\ninfo->counts[2].proto = proto_get_id_by_short_name(info->counts[2].title);\r\ninfo->counts[3].title = "ICMP";\r\ninfo->counts[3].proto = proto_get_id_by_short_name(info->counts[3].title);\r\ninfo->counts[4].title = "ARP";\r\ninfo->counts[4].proto = proto_get_id_by_short_name(info->counts[4].title);\r\ninfo->counts[5].title = "OSPF";\r\ninfo->counts[5].proto = proto_get_id_by_short_name(info->counts[5].title);\r\ninfo->counts[6].title = "GRE";\r\ninfo->counts[6].proto = proto_get_id_by_short_name(info->counts[6].title);\r\ninfo->counts[7].title = "NetBIOS";\r\ninfo->counts[7].proto = proto_get_id_by_short_name(info->counts[7].title);\r\ninfo->counts[8].title = "IPX";\r\ninfo->counts[8].proto = proto_get_id_by_short_name(info->counts[8].title);\r\ninfo->counts[9].title = "VINES";\r\ninfo->counts[9].proto = proto_get_id_by_short_name(info->counts[9].title);\r\ninfo->counts[10].title = "I2C Events";\r\ninfo->counts[10].proto = proto_get_id_by_short_name(info->counts[10].title);\r\ninfo->counts[11].title = "I2C Data";\r\ninfo->counts[11].proto = proto_get_id_by_short_name(info->counts[11].title);\r\nstr = get_iface_list_string(capture_opts, 0);\r\ntitle_iface = g_strdup_printf("Wireshark: Capture from %s", str->str);\r\ng_string_free(str, TRUE);\r\ncap_w_title = create_user_window_title(title_iface);\r\ng_free(title_iface);\r\ninfo->cap_w = dlg_window_new(cap_w_title);\r\ng_free(cap_w_title);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(info->cap_w), main_vb);\r\ngtk_widget_show(main_vb);\r\ncounts_fr = gtk_frame_new("Captured Packets");\r\ngtk_box_pack_start(GTK_BOX(main_vb), counts_fr, FALSE, FALSE, 3);\r\ngtk_widget_show(counts_fr);\r\ncounts_grid = ws_gtk_grid_new();\r\nws_gtk_grid_set_homogeneous(GTK_GRID(counts_grid), TRUE);\r\ngtk_container_add(GTK_CONTAINER(counts_fr), counts_grid);\r\ngtk_container_set_border_width(GTK_CONTAINER(counts_grid), 5);\r\ngtk_widget_show(counts_grid);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(counts_grid), 0);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(counts_grid), 5);\r\ncapture_info_count_init(&info->total_count, 0, gtk_label_new("% of total"), FALSE, counts_grid);\r\nfor (i = 0; i < PACKET_COUNTS_SIZE; i++) {\r\ncapture_info_count_init(&info->counts[i], i+1, gtk_progress_bar_new(), TRUE, counts_grid);\r\n}\r\ncapture_info_count_init(&info->other_count, i+1, gtk_progress_bar_new(), TRUE, counts_grid);\r\nrunning_grid = ws_gtk_grid_new();\r\nws_gtk_grid_set_homogeneous(GTK_GRID(running_grid), TRUE);\r\nrunning_label = gtk_label_new("Running");\r\ngtk_misc_set_alignment(GTK_MISC(running_label), 0.0f, 0.0f);\r\ngtk_widget_show(running_label);\r\nws_gtk_grid_attach_extended(GTK_GRID(running_grid), running_label,\r\n0, 0, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ninfo->running_time_lb = gtk_label_new("00:00:00");\r\ngtk_misc_set_alignment(GTK_MISC(info->running_time_lb), 0.5f, 0.0f);\r\ngtk_widget_show(info->running_time_lb);\r\nws_gtk_grid_attach_extended(GTK_GRID(running_grid), info->running_time_lb,\r\n1, 0, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 5, 0);\r\nlb = gtk_label_new("");\r\ngtk_widget_show(lb);\r\nws_gtk_grid_attach_extended(GTK_GRID(running_grid), lb,\r\n2, 0, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nlb = gtk_label_new("");\r\ngtk_widget_show(lb);\r\nws_gtk_grid_attach_extended(GTK_GRID(running_grid), lb,\r\n3, 0, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_box_pack_start(GTK_BOX(main_vb), running_grid, FALSE, FALSE, 3);\r\ngtk_widget_show(running_grid);\r\nbbox = dlg_button_row_new(WIRESHARK_STOCK_CAPTURE_STOP, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 3);\r\ngtk_widget_show(bbox);\r\nstop_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), WIRESHARK_STOCK_CAPTURE_STOP);\r\nwindow_set_cancel_button(info->cap_w, stop_bt, NULL);\r\ng_signal_connect(stop_bt, "clicked", G_CALLBACK(capture_info_stop_clicked_cb), cap_session);\r\ng_signal_connect(info->cap_w, "delete_event", G_CALLBACK(capture_info_delete_cb), cap_session);\r\nci_help = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ngtk_widget_set_tooltip_text(ci_help, "Get help about this dialog");\r\ng_signal_connect(ci_help, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_CAPTURE_INFO_DIALOG);\r\ngtk_widget_show(info->cap_w);\r\nwindow_present(info->cap_w);\r\ninfo->start_time = time(NULL);\r\ncinfo->ui = info;\r\ninfo->timer_id = g_timeout_add(1000, capture_info_ui_update_cb,cinfo);\r\n}\r\nstatic void\r\ncapture_info_count_update(capture_info_counts_t* count, capture_info *cinfo)\r\n{\r\ngchar label_str[64];\r\nfloat pb_frac;\r\nguint32 proto_count;\r\nproto_count = capture_dissector_get_count(cinfo->counts, count->proto);\r\ng_snprintf(label_str, sizeof(label_str), "%d", proto_count);\r\ngtk_label_set_text(GTK_LABEL(count->value_lb), label_str);\r\npb_frac = (cinfo->counts->total != 0) ?\r\n((float)proto_count / cinfo->counts->total) : 0.0f;\r\ngtk_progress_bar_set_fraction(GTK_PROGRESS_BAR(count->percent_pb), pb_frac);\r\ng_snprintf(label_str, sizeof(label_str), "%.1f%%", pb_frac * 100.0);\r\ngtk_label_set_text(GTK_LABEL(count->percent_lb), label_str);\r\n}\r\nvoid capture_info_ui_update(\r\ncapture_info *cinfo)\r\n{\r\nunsigned int i;\r\ngchar label_str[64];\r\ncapture_info_ui_t *info = (capture_info_ui_t *)cinfo->ui;\r\nif (!info)\r\nreturn;\r\ng_snprintf(label_str, sizeof(label_str), "%02ld:%02ld:%02ld",\r\n(long)(cinfo->running_time/3600), (long)((cinfo->running_time%3600)/60),\r\n(long)(cinfo->running_time%60));\r\ngtk_label_set_text(GTK_LABEL(info->running_time_lb), label_str);\r\nif (cinfo->new_packets) {\r\nfloat pb_frac;\r\ng_snprintf(label_str, sizeof(label_str), "%d", cinfo->counts->total);\r\ngtk_label_set_text(GTK_LABEL(info->total_count.value_lb), label_str);\r\nfor (i = 0; i < PACKET_COUNTS_SIZE; i++) {\r\ncapture_info_count_update(&info->counts[i], cinfo);\r\n}\r\ng_snprintf(label_str, sizeof(label_str), "%d", cinfo->counts->other);\r\ngtk_label_set_text(GTK_LABEL(info->other_count.value_lb), label_str);\r\npb_frac = (cinfo->counts->total != 0) ?\r\n((float)cinfo->counts->other / cinfo->counts->total) : 0.0f;\r\ngtk_progress_bar_set_fraction(GTK_PROGRESS_BAR(info->other_count.percent_pb), pb_frac);\r\ng_snprintf(label_str, sizeof(label_str), "%.1f%%", pb_frac * 100.0);\r\ngtk_label_set_text(GTK_LABEL(info->other_count.percent_lb), label_str);\r\n}\r\n}\r\nvoid capture_info_ui_destroy(\r\ncapture_info *cinfo)\r\n{\r\ncapture_info_ui_t *info = (capture_info_ui_t *)cinfo->ui;\r\nif (!info)\r\nreturn;\r\ng_source_remove(info->timer_id);\r\ngtk_grab_remove(GTK_WIDGET(info->cap_w));\r\nwindow_destroy(GTK_WIDGET(info->cap_w));\r\ng_free(info);\r\ncinfo->ui = NULL;\r\n}

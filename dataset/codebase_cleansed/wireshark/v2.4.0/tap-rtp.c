static void\r\nrtp_streams_stat_draw(void *arg _U_)\r\n{\r\nGList *list;\r\nrtp_stream_info_t *strinfo;\r\ngchar *payload_type;\r\nguint32 expected;\r\ngint32 lost;\r\ndouble perc;\r\nchar *savelocale;\r\nchar *src_addr, *dst_addr;\r\nprintf("========================= RTP Streams ========================\n");\r\nprintf("%15s %5s %15s %5s %10s %16s %5s %12s %15s %15s %15s %s\n","Src IP addr", "Port", "Dest IP addr", "Port", "SSRC", "Payload", "Pkts", "Lost", "Max Delta(ms)", "Max Jitter(ms)", "Mean Jitter(ms)", "Problems?");\r\nsavelocale = g_strdup(setlocale(LC_NUMERIC, NULL));\r\nsetlocale(LC_NUMERIC, "C");\r\nlist = the_tapinfo_struct.strinfo_list;\r\nlist = g_list_first(list);\r\nwhile (list)\r\n{\r\nstrinfo = (rtp_stream_info_t*)(list->data);\r\nif (strinfo->payload_type > 95) {\r\nif (strinfo->payload_type_name != NULL) {\r\npayload_type = wmem_strdup(NULL, strinfo->payload_type_name);\r\n}else{\r\npayload_type = wmem_strdup_printf(NULL, "Unknown(%u)", strinfo->payload_type);\r\n}\r\n}else{\r\npayload_type = val_to_str_ext_wmem(NULL, strinfo->payload_type, &rtp_payload_type_vals_ext, "Unknown (%u)");\r\n}\r\nexpected = (strinfo->rtp_stats.stop_seq_nr + strinfo->rtp_stats.cycles*65536)\r\n- strinfo->rtp_stats.start_seq_nr + 1;\r\nlost = expected - strinfo->rtp_stats.total_nr;\r\nif (expected) {\r\nperc = (double)(lost*100)/(double)expected;\r\n} else {\r\nperc = 0;\r\n}\r\nsrc_addr = address_to_display(NULL, &(strinfo->src_addr));\r\ndst_addr = address_to_display(NULL, &(strinfo->dest_addr));\r\nprintf("%15s %5u %15s %5u 0x%08X %16s %5u %5d (%.1f%%) %15.2f %15.2f %15.2f %s\n",\r\nsrc_addr,\r\nstrinfo->src_port,\r\ndst_addr,\r\nstrinfo->dest_port,\r\nstrinfo->ssrc,\r\npayload_type,\r\nstrinfo->packet_count,\r\nlost, perc,\r\nstrinfo->rtp_stats.max_delta,\r\nstrinfo->rtp_stats.max_jitter,\r\nstrinfo->rtp_stats.mean_jitter,\r\n(strinfo->problem)?"X":"");\r\nlist = g_list_next(list);\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\nwmem_free(NULL, payload_type);\r\n}\r\nprintf("==============================================================\n");\r\nsetlocale(LC_NUMERIC, savelocale);\r\ng_free(savelocale);\r\n}\r\nstatic void\r\nrtp_streams_stat_init(const char *opt_arg _U_, void *userdata _U_)\r\n{\r\nGString *err_p;\r\nerr_p =\r\nregister_tap_listener("rtp", &the_tapinfo_struct, NULL, 0,\r\nrtpstream_reset_cb,\r\nrtpstream_packet,\r\nrtp_streams_stat_draw);\r\nif (err_p != NULL)\r\n{\r\ng_string_free(err_p, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_rtp_streams(void)\r\n{\r\nregister_stat_tap_ui(&rtp_streams_stat_ui, NULL);\r\n}

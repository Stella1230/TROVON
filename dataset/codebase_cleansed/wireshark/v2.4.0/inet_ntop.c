const char *\r\ninet_ntop(int af, const void *src, char *dst, size_t size)\r\n{\r\nswitch (af) {\r\ncase AF_INET:\r\nreturn (inet_ntop4(src, dst, size));\r\ncase AF_INET6:\r\nreturn (inet_ntop6(src, dst, size));\r\ndefault:\r\nerrno = EAFNOSUPPORT;\r\nreturn (NULL);\r\n}\r\n}\r\nstatic const char *\r\ninet_ntop4(const u_char *src, char *dst, size_t size)\r\n{\r\nstatic const char fmt[] = "%u.%u.%u.%u";\r\nchar tmp[sizeof "255.255.255.255"];\r\nint nprinted;\r\nnprinted = g_snprintf(tmp, sizeof(tmp), fmt, src[0], src[1], src[2], src[3]);\r\nif ((size_t)nprinted >= size) {\r\nerrno = ENOSPC;\r\nreturn (NULL);\r\n}\r\ng_strlcpy(dst, tmp, size);\r\nreturn (dst);\r\n}\r\nstatic const char *\r\ninet_ntop6(const u_char *src, char *dst, size_t size)\r\n{\r\nchar tmp[sizeof "ffff:ffff:ffff:ffff:ffff:ffff:255.255.255.255"], *tp;\r\nstruct { int base, len; } best, cur;\r\nu_int words[NS_IN6ADDRSZ / NS_INT16SZ];\r\nint i;\r\nmemset(&best, 0, sizeof best);\r\nmemset(&cur, 0, sizeof cur);\r\nmemset(words, '\0', sizeof words);\r\nfor (i = 0; i < NS_IN6ADDRSZ; i++)\r\nwords[i / 2] |= (src[i] << ((1 - (i % 2)) << 3));\r\nbest.base = -1;\r\ncur.base = -1;\r\nfor (i = 0; i < (NS_IN6ADDRSZ / NS_INT16SZ); i++) {\r\nif (words[i] == 0) {\r\nif (cur.base == -1)\r\ncur.base = i, cur.len = 1;\r\nelse\r\ncur.len++;\r\n} else {\r\nif (cur.base != -1) {\r\nif (best.base == -1 || cur.len > best.len)\r\nbest = cur;\r\ncur.base = -1;\r\n}\r\n}\r\n}\r\nif (cur.base != -1) {\r\nif (best.base == -1 || cur.len > best.len)\r\nbest = cur;\r\n}\r\nif (best.base != -1 && best.len < 2)\r\nbest.base = -1;\r\ntp = tmp;\r\nfor (i = 0; i < (NS_IN6ADDRSZ / NS_INT16SZ); i++) {\r\nif (best.base != -1 && i >= best.base &&\r\ni < (best.base + best.len)) {\r\nif (i == best.base)\r\n*tp++ = ':';\r\ncontinue;\r\n}\r\nif (i != 0)\r\n*tp++ = ':';\r\nif (i == 6 && best.base == 0 &&\r\n(best.len == 6 || (best.len == 5 && words[5] == 0xffff))) {\r\nif (!inet_ntop4(src+12, tp, sizeof tmp - (tp - tmp)))\r\nreturn (NULL);\r\ntp += strlen(tp);\r\nbreak;\r\n}\r\ntp += g_snprintf(tp, (gulong) (sizeof tmp - (tp - tmp)), "%x", words[i]);\r\n}\r\nif (best.base != -1 && (best.base + best.len) ==\r\n(NS_IN6ADDRSZ / NS_INT16SZ))\r\n*tp++ = ':';\r\n*tp++ = '\0';\r\nif ((size_t)(tp - tmp) > size) {\r\nerrno = ENOSPC;\r\nreturn (NULL);\r\n}\r\ng_strlcpy(dst, tmp, size);\r\nreturn (dst);\r\n}

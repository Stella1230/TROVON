static void dissect_dreg_tlv(proto_tree *dreg_tree, gint tlv_type, tvbuff_t *tvb, guint tlv_offset, guint tlv_len)\r\n{\r\nswitch (tlv_type) {\r\ncase DREG_PAGING_INFO:\r\nproto_tree_add_item(dreg_tree, hf_dreg_paging_cycle, tvb, tlv_offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_paging_offset, tvb, tlv_offset + 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_paging_group_id, tvb, tlv_offset + 3, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DREG_REQ_DURATION:\r\nproto_tree_add_item(dreg_tree, hf_dreg_req_duration, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DREG_PAGING_CONTROLLER_ID:\r\nproto_tree_add_item(dreg_tree, hf_paging_controller_id, tvb, tlv_offset, 6, ENC_NA);\r\nbreak;\r\ncase DREG_IDLE_MODE_RETAIN_INFO:\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_sbc, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_pkm, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_reg, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_network_address, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_tod, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_tftp, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_retain_ms_service_full_service, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_tree, hf_dreg_consider_paging_pref, tvb, tlv_offset, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DREG_MAC_HASH_SKIP_THRESHOLD:\r\nproto_tree_add_item(dreg_tree, hf_mac_hash_skip_threshold, tvb, tlv_offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase DREG_PAGING_CYCLE_REQUEST:\r\nproto_tree_add_item(dreg_tree, hf_dreg_paging_cycle_request, tvb, tlv_offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(dreg_tree, hf_tlv_value, tvb, tlv_offset, tlv_len, ENC_NA);\r\nbreak;\r\n}\r\n}\r\nvoid proto_register_mac_mgmt_msg_dreg_req(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_dreg_consider_paging_pref,\r\n{\r\n"Consider Paging Preference of each Service Flow in resource retention", "wmx.dreg.consider_paging_preference",\r\nFT_UINT8, BASE_DEC, NULL, 0x80, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_invalid_tlv,\r\n{\r\n"Invalid TLV", "wmx.dreg.invalid_tlv",\r\nFT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mac_hash_skip_threshold,\r\n{\r\n"MAC Hash Skip Threshold", "wmx.dreg.mac_hash_skip_threshold",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_paging_controller_id,\r\n{\r\n"Paging Controller ID", "wmx.dreg.paging_controller_id",\r\nFT_ETHER, BASE_NONE, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_paging_cycle,\r\n{\r\n"PAGING CYCLE", "wmx.dreg.paging_cycle",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_paging_cycle_request,\r\n{\r\n"Paging Cycle Request", "wmx.dreg.paging_cycle_request",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_paging_group_id,\r\n{\r\n"Paging-group-ID", "wmx.dreg.paging_group_id",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_paging_offset,\r\n{\r\n"PAGING OFFSET", "wmx.dreg.paging_offset",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_req_duration,\r\n{\r\n"REQ-duration (Waiting value for the DREG-REQ message re-transmission in frames)", "wmx.dreg.req_duration",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_full_service,\r\n{\r\n"Retain MS service and operation information associated with Full service", "wmx.dreg.retain_ms_full_service",\r\nFT_UINT8, BASE_DEC, NULL, 0x40, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_network_address,\r\n{\r\n"Retain MS service and operational information associated with Network Address", "wmx.dreg.retain_ms_service_network_address",\r\nFT_UINT8, BASE_DEC, NULL, 0x08, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_pkm,\r\n{\r\n"Retain MS service and operational information associated with PKM-REQ/RSP", "wmx.dreg.retain_ms_service_pkm",\r\nFT_UINT8, BASE_DEC, NULL, 0x02, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_reg,\r\n{\r\n"Retain MS service and operational information associated with REG-REQ/RSP", "wmx.dreg.retain_ms_service_reg",\r\nFT_UINT8, BASE_DEC, NULL, 0x04, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_sbc,\r\n{\r\n"Retain MS service and operational information associated with SBC-REQ/RSP", "wmx.dreg.retain_ms_service_sbc",\r\nFT_UINT8, BASE_DEC, NULL, 0x01, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_tftp,\r\n{\r\n"Retain MS service and operational information associated with TFTP messages", "wmx.dreg.retain_ms_service_tftp",\r\nFT_UINT8, BASE_DEC, NULL, 0x20, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_retain_ms_service_tod,\r\n{\r\n"Retain MS service and operational information associated with Time of Day", "wmx.dreg.retain_ms_service_tod",\r\nFT_UINT8, BASE_DEC, NULL, 0x10, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_cmd_action,\r\n{\r\n"DREG-CMD Action code", "wmx.dreg_cmd.action",\r\nFT_UINT8, BASE_DEC, VALS(vals_dreg_cmd_action), 0x07, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_cmd_action_cor2,\r\n{\r\n"DREG-CMD Action code", "wmx.dreg_cmd.action",\r\nFT_UINT8, BASE_DEC, VALS(vals_dreg_cmd_action_cor2), 0x07, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_cmd_reserved,\r\n{\r\n"Reserved", "wmx.dreg_cmd.action_reserved",\r\nFT_UINT8, BASE_DEC, NULL, 0xF8, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_req_action,\r\n{\r\n"DREG-REQ Action code", "wmx.dreg_req.action",\r\nFT_UINT8, BASE_DEC, VALS(vals_dreg_req_code), 0x03, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_dreg_req_reserved,\r\n{\r\n"Reserved", "wmx.dreg_req.action_reserved",\r\nFT_UINT8, BASE_DEC, NULL, 0xFC, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_tlv_value,\r\n{\r\n"Value", "wmx.dreg.unknown_tlv_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x00, NULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{\r\n&hf_ack_type_reserved,\r\n{\r\n"Reserved", "wmx.ack_type_reserved",\r\nFT_UINT8, BASE_DEC, NULL, 0x03, NULL, HFILL\r\n}\r\n}\r\n#endif\r\n};\r\nproto_mac_mgmt_msg_dreg_req_decoder = proto_register_protocol (\r\n"WiMax DREG-REQ Messages",\r\n"WiMax DREG-REQ",\r\n"wmx.dreg_req"\r\n);\r\nproto_register_field_array(proto_mac_mgmt_msg_dreg_req_decoder, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_register_mac_mgmt_msg_dreg_cmd(void)\r\n{\r\nproto_mac_mgmt_msg_dreg_cmd_decoder = proto_register_protocol (\r\n"WiMax DREG-CMD Messages",\r\n"WiMax DREG-CMD",\r\n"wmx.dreg_cmd"\r\n);\r\n}\r\nstatic int dissect_mac_mgmt_msg_dreg_req_decoder(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0;\r\nguint tlv_offset;\r\nguint tvb_len;\r\nproto_item *dreg_req_item;\r\nproto_tree *dreg_req_tree;\r\nproto_tree *tlv_tree = NULL;\r\ntlv_info_t tlv_info;\r\ngint tlv_type;\r\ngint tlv_len;\r\ngboolean hmac_found = FALSE;\r\n{\r\ntvb_len = tvb_reported_length(tvb);\r\ndreg_req_item = proto_tree_add_protocol_format(tree, proto_mac_mgmt_msg_dreg_req_decoder, tvb, 0, -1, "MAC Management Message, DREG-REQ");\r\ndreg_req_tree = proto_item_add_subtree(dreg_req_item, ett_mac_mgmt_msg_dreg_decoder);\r\nproto_tree_add_item(dreg_req_tree, hf_dreg_req_action, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_req_tree, hf_dreg_req_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nwhile(offset < tvb_len)\r\n{\r\ninit_tlv_info(&tlv_info, tvb, offset);\r\ntlv_type = get_tlv_type(&tlv_info);\r\ntlv_len = get_tlv_length(&tlv_info);\r\nif(tlv_type == -1 || tlv_len > MAX_TLV_LEN || tlv_len < 1)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "DREG-REQ TLV error");\r\nproto_tree_add_item(dreg_req_tree, hf_dreg_invalid_tlv, tvb, offset, (tvb_len - offset), ENC_NA);\r\nbreak;\r\n}\r\ntlv_offset = offset + get_tlv_value_offset(&tlv_info);\r\nswitch (tlv_type) {\r\ncase HMAC_TUPLE:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_dreg_decoder, dreg_req_tree, proto_mac_mgmt_msg_dreg_req_decoder, tvb, offset, tlv_len, "HMAC Tuple");\r\nwimax_hmac_tuple_decoder(tlv_tree, tvb, tlv_offset, tlv_len);\r\nhmac_found = TRUE;\r\nbreak;\r\ncase CMAC_TUPLE:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_dreg_decoder, dreg_req_tree, proto_mac_mgmt_msg_dreg_req_decoder, tvb, offset, tlv_len, "CMAC Tuple");\r\nwimax_cmac_tuple_decoder(tlv_tree, tvb, tlv_offset, tlv_len);\r\nbreak;\r\ndefault:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_dreg_decoder, dreg_req_tree, proto_mac_mgmt_msg_dreg_req_decoder, tvb, offset, tlv_len, "DREG-REQ sub-TLV's");\r\ndissect_dreg_tlv(tlv_tree, tlv_type, tvb, tlv_offset, tlv_len);\r\nbreak;\r\n}\r\noffset = tlv_len + tlv_offset;\r\n}\r\nif (!hmac_found)\r\nproto_item_append_text(dreg_req_tree, " (HMAC Tuple is missing !)");\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic int dissect_mac_mgmt_msg_dreg_cmd_decoder(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0;\r\nguint tlv_offset;\r\nguint tvb_len;\r\nproto_item *dreg_cmd_item;\r\nproto_tree *dreg_cmd_tree;\r\nproto_tree *tlv_tree = NULL;\r\ntlv_info_t tlv_info;\r\ngint tlv_type;\r\ngint tlv_len;\r\ngboolean hmac_found = FALSE;\r\n{\r\ntvb_len = tvb_reported_length(tvb);\r\ndreg_cmd_item = proto_tree_add_protocol_format(tree, proto_mac_mgmt_msg_dreg_cmd_decoder, tvb, 0, -1, "MAC Management Message, DREG-CMD");\r\ndreg_cmd_tree = proto_item_add_subtree(dreg_cmd_item, ett_mac_mgmt_msg_dreg_decoder);\r\nif (include_cor2_changes)\r\nproto_tree_add_item(dreg_cmd_tree, hf_dreg_cmd_action_cor2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nelse\r\nproto_tree_add_item(dreg_cmd_tree, hf_dreg_cmd_action, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dreg_cmd_tree, hf_dreg_cmd_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset ++;\r\nwhile(offset < tvb_len)\r\n{\r\ninit_tlv_info(&tlv_info, tvb, offset);\r\ntlv_type = get_tlv_type(&tlv_info);\r\ntlv_len = get_tlv_length(&tlv_info);\r\nif(tlv_type == -1 || tlv_len > MAX_TLV_LEN || tlv_len < 1)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "DREG-CMD TLV error");\r\nproto_tree_add_item(dreg_cmd_tree, hf_dreg_invalid_tlv, tvb, offset, (tvb_len - offset), ENC_NA);\r\nbreak;\r\n}\r\ntlv_offset = offset + get_tlv_value_offset(&tlv_info);\r\nswitch (tlv_type) {\r\ncase HMAC_TUPLE:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_dreg_decoder, dreg_cmd_tree, proto_mac_mgmt_msg_dreg_cmd_decoder, tvb, offset, tlv_len, "HMAC Tuple");\r\nwimax_hmac_tuple_decoder(tlv_tree, tvb, tlv_offset, tlv_len);\r\nhmac_found = TRUE;\r\nbreak;\r\ncase CMAC_TUPLE:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_dreg_decoder, dreg_cmd_tree, proto_mac_mgmt_msg_dreg_cmd_decoder, tvb, offset, tlv_len, "CMAC Tuple");\r\nwimax_cmac_tuple_decoder(tlv_tree, tvb, tlv_offset, tlv_len);\r\nbreak;\r\ndefault:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_dreg_decoder, dreg_cmd_tree, proto_mac_mgmt_msg_dreg_cmd_decoder, tvb, offset, tlv_len, "DREG-CMD sub-TLV's");\r\ndissect_dreg_tlv(tlv_tree, tlv_type, tvb, tlv_offset, tlv_len);\r\nbreak;\r\n}\r\noffset = tlv_len + tlv_offset;\r\n}\r\nif (!hmac_found)\r\nproto_item_append_text(dreg_cmd_tree, " (HMAC Tuple is missing !)");\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_reg_handoff_mac_mgmt_msg_dreg(void)\r\n{\r\ndissector_handle_t dreg_handle;\r\ndreg_handle = create_dissector_handle(dissect_mac_mgmt_msg_dreg_req_decoder, proto_mac_mgmt_msg_dreg_req_decoder);\r\ndissector_add_uint("wmx.mgmtmsg", MAC_MGMT_MSG_DREG_REQ, dreg_handle);\r\ndreg_handle = create_dissector_handle(dissect_mac_mgmt_msg_dreg_cmd_decoder, proto_mac_mgmt_msg_dreg_cmd_decoder);\r\ndissector_add_uint("wmx.mgmtmsg", MAC_MGMT_MSG_DREG_CMD, dreg_handle);\r\n}

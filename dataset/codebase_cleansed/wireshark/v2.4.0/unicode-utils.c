int\r\nws_utf8_char_len(guint8 ch)\r\n{\r\nif (ch >= 0xfe) return -1;\r\nif (ch >= 0xfc) return 6;\r\nif (ch >= 0xf8) return 5;\r\nif (ch >= 0xf0) return 4;\r\nif (ch >= 0xe0) return 3;\r\nif (ch >= 0xc0) return 2;\r\nelse return 1;\r\n}\r\nconst wchar_t *\r\nutf_8to16(const char *utf8str)\r\n{\r\nstatic wchar_t *utf16buf[3];\r\nstatic int utf16buf_len[3];\r\nstatic int idx;\r\nif (utf8str == NULL)\r\nreturn NULL;\r\nidx = (idx + 1) % 3;\r\nif (utf16buf[idx] == NULL) {\r\nutf16buf_len[idx] = INITIAL_UTFBUF_SIZE;\r\nutf16buf[idx] = g_malloc(utf16buf_len[idx] * sizeof(wchar_t));\r\n}\r\nwhile (MultiByteToWideChar(CP_UTF8, 0, utf8str,\r\n-1, NULL, 0) >= utf16buf_len[idx]) {\r\nutf16buf_len[idx] *= 2;\r\nutf16buf[idx] = g_realloc(utf16buf[idx], utf16buf_len[idx] * sizeof(wchar_t));\r\n}\r\nif (MultiByteToWideChar(CP_UTF8, 0, utf8str,\r\n-1, utf16buf[idx], utf16buf_len[idx]) == 0)\r\nreturn NULL;\r\nreturn utf16buf[idx];\r\n}\r\nvoid\r\nutf_8to16_snprintf(TCHAR *utf16buf, gint utf16buf_len, const gchar* fmt, ...)\r\n{\r\nva_list ap;\r\ngchar* dst;\r\nva_start(ap,fmt);\r\ndst = g_strdup_vprintf(fmt, ap);\r\nva_end(ap);\r\nStringCchPrintf(utf16buf, utf16buf_len, _T("%s"), utf_8to16(dst));\r\ng_free(dst);\r\n}\r\ngchar *\r\nutf_16to8(const wchar_t *utf16str)\r\n{\r\nstatic gchar *utf8buf[3];\r\nstatic int utf8buf_len[3];\r\nstatic int idx;\r\nif (utf16str == NULL)\r\nreturn NULL;\r\nidx = (idx + 1) % 3;\r\nif (utf8buf[idx] == NULL) {\r\nutf8buf_len[idx] = INITIAL_UTFBUF_SIZE;\r\nutf8buf[idx] = g_malloc(utf8buf_len[idx]);\r\n}\r\nwhile (WideCharToMultiByte(CP_UTF8, 0, utf16str, -1,\r\nNULL, 0, NULL, NULL) >= utf8buf_len[idx]) {\r\nutf8buf_len[idx] *= 2;\r\nutf8buf[idx] = g_realloc(utf8buf[idx], utf8buf_len[idx]);\r\n}\r\nif (WideCharToMultiByte(CP_UTF8, 0, utf16str, -1,\r\nutf8buf[idx], utf8buf_len[idx], NULL, NULL) == 0)\r\nreturn NULL;\r\nreturn utf8buf[idx];\r\n}\r\nvoid\r\narg_list_utf_16to8(int argc, char *argv[]) {\r\nLPWSTR *wc_argv;\r\nint wc_argc, i;\r\nwc_argv = CommandLineToArgvW(GetCommandLineW(), &wc_argc);\r\nif (wc_argv && wc_argc == argc) {\r\nfor (i = 0; i < argc; i++) {\r\nargv[i] = g_utf16_to_utf8(wc_argv[i], -1, NULL, NULL, NULL);\r\n}\r\n}\r\nLocalFree(wc_argv);\r\n}

static int\r\ndissect_metamako(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_tree *ti, *item;\r\nproto_tree *metamako_tree, *timestamp_tree;\r\nguint offset = 0;\r\nguint trailer_len;\r\nnstime_t metamako_time, timediff;\r\nguint8 metamako_srcport;\r\nguint16 metamako_srcdevice;\r\nstruct tm *tmp;\r\ntrailer_len = tvb_reported_length(tvb);\r\nif ( (trailer_len != 20) && (trailer_len != 16) )\r\nreturn 0;\r\nif( tvb_captured_length(tvb) < 12)\r\nreturn 0;\r\nmetamako_time.secs = tvb_get_ntohl(tvb, offset + 4);\r\nmetamako_time.nsecs = tvb_get_ntohl(tvb, offset + 8);\r\nnstime_delta(&timediff, &metamako_time, &pinfo->fd->abs_ts);\r\nif (metamako_time.secs == 0)\r\nreturn 0;\r\nif (metamako_time.secs > 3600) {\r\nif ( metamako_time.secs > pinfo->fd->abs_ts.secs ) {\r\nif ( metamako_time.secs - pinfo->fd->abs_ts.secs > 2592000 )\r\nreturn 0;\r\n} else {\r\nif ( pinfo->fd->abs_ts.secs - metamako_time.secs > 2592000 )\r\nreturn 0;\r\n}\r\n}\r\nif ( metamako_time.nsecs >= 1000000000 )\r\nreturn 0;\r\nti = proto_tree_add_item(tree, proto_metamako, tvb, 0, (trailer_len & 0xb), ENC_NA);\r\nmetamako_tree = proto_item_add_subtree(ti, ett_metamako);\r\nproto_tree_add_item(metamako_tree, hf_metamako_origfcs, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nitem = proto_tree_add_time(metamako_tree, hf_metamako_time, tvb, offset, 8, &metamako_time);\r\ntimestamp_tree = proto_item_add_subtree(item, ett_metamako_timestamp);\r\ntmp = localtime(&metamako_time.secs);\r\nif (tmp)\r\nproto_item_append_text(ti, ", Timestamp: %02d:%02d:%02d.%09ld",\r\ntmp->tm_hour, tmp->tm_min, tmp->tm_sec,(long)metamako_time.nsecs);\r\nelse\r\nproto_item_append_text(ti, ", Timestamp: <Not representable>");\r\nitem = proto_tree_add_time(timestamp_tree, hf_metamako_tdiff, tvb, offset, 8, &timediff);\r\nPROTO_ITEM_SET_GENERATED(item);\r\noffset += 8;\r\nproto_tree_add_bitmask(metamako_tree, tvb, offset, hf_metamako_flags, ett_metamako_flags, flags, ENC_BIG_ENDIAN);\r\noffset++;\r\nmetamako_srcdevice = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(metamako_tree, hf_metamako_srcdevice, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_item_append_text(ti, ", Source Device: %d", metamako_srcdevice);\r\nmetamako_srcport = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(metamako_tree, hf_metamako_srcport, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset++;\r\nproto_item_append_text(ti, ", Source Port: %d", metamako_srcport);\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_metamako(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_metamako_origfcs, {\r\n"Original FCS", "metamako.orig_fcs",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_metamako_time, {\r\n"Time Stamp", "metamako.time",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0,\r\nNULL, HFILL }},\r\n{&hf_metamako_flags, {\r\n"Flags", "metamako.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{&hf_metamako_flags_orig_fcs_vld, {\r\n"Original FCS Valid", "metamako.flags.orig_fcs_vld",\r\nFT_BOOLEAN, 8, TFS(&tfs_valid_invalid), 0x01,\r\nNULL, HFILL}},\r\n{&hf_metamako_reserved, {\r\n"Reserved", "metamako.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0xFE,\r\nNULL, HFILL}},\r\n{ &hf_metamako_srcdevice, {\r\n"Source Device ID", "metamako.srcdevice",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_metamako_srcport, {\r\n"Source Port", "metamako.srcport",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }},\r\n{ &hf_metamako_tdiff, {\r\n"Time Difference", "metamako.tdiff",\r\nFT_RELATIVE_TIME, BASE_NONE, NULL, 0x0,\r\n"Difference from capture timestamp", HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_metamako,\r\n&ett_metamako_timestamp,\r\n&ett_metamako_flags\r\n};\r\nproto_metamako = proto_register_protocol("Metamako ethernet trailer", "Metamako", "metamako");\r\nproto_register_field_array(proto_metamako, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_metamako(void)\r\n{\r\nheur_dissector_add("eth.trailer", dissect_metamako, "Metamako ethernet trailer", "metamako_eth", proto_metamako, HEURISTIC_ENABLE);\r\n}

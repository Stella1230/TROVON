static gboolean\r\nsavesslkeys_save_clicked_cb(char *file, gchar *keylist)\r\n{\r\nint fd;\r\nfd = ws_open(file, O_WRONLY|O_CREAT|O_TRUNC|O_BINARY, 0666);\r\nif (fd == -1) {\r\nopen_failure_alert_box(file, errno, TRUE);\r\nreturn FALSE;\r\n}\r\nif (ws_write(fd, keylist, (unsigned int)strlen(keylist)) < 0) {\r\nwrite_failure_alert_box(file, errno);\r\nws_close(fd);\r\nreturn FALSE;\r\n}\r\nif (ws_close(fd) < 0) {\r\nwrite_failure_alert_box(file, errno);\r\nreturn FALSE;\r\n}\r\ng_free(keylist);\r\nreturn TRUE;\r\n}\r\nvoid\r\nsavesslkeys_cb(GtkWidget * w _U_, gpointer data _U_)\r\n{\r\nwin32_export_sslkeys_file(GDK_WINDOW_HWND(gtk_widget_get_window(top_level)));\r\nreturn;\r\n}\r\nstatic char *\r\ngtk_export_sslkeys_file(guint keylist_len)\r\n{\r\nGtkWidget *savesslkeys_dlg;\r\ngchar *label;\r\nGtkWidget *dlg_lb;\r\nchar *pathname;\r\nsavesslkeys_dlg = file_selection_new("Wireshark: Export SSL Session Keys",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_SAVE);\r\nlabel = g_strdup_printf("Will save %u SSL Session %s to specified file.",\r\nkeylist_len, plurality(keylist_len, "key", "keys"));\r\ndlg_lb = gtk_label_new(label);\r\ng_free(label);\r\nfile_selection_set_extra_widget(savesslkeys_dlg, dlg_lb);\r\ngtk_widget_show(dlg_lb);\r\npathname = file_selection_run(savesslkeys_dlg);\r\nif (pathname == NULL) {\r\nreturn NULL;\r\n}\r\nwindow_destroy(savesslkeys_dlg);\r\nreturn pathname;\r\n}\r\nvoid\r\nsavesslkeys_cb(GtkWidget * w _U_, gpointer data _U_)\r\n{\r\nchar *pathname;\r\nguint keylist_len;\r\ngchar *keylist;\r\nkeylist_len = ssl_session_key_count();\r\nif (keylist_len==0) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "There are no SSL Session Keys to save.");\r\nreturn;\r\n}\r\nkeylist = ssl_export_sessions();\r\nfor (;;) {\r\npathname = gtk_export_sslkeys_file(keylist_len);\r\nif (pathname == NULL) {\r\nbreak;\r\n}\r\nif (savesslkeys_save_clicked_cb(pathname, keylist)) {\r\ng_free(pathname);\r\nbreak;\r\n}\r\ng_free(pathname);\r\n}\r\n}

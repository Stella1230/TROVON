void\r\ntime_shift_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nGtkWidget *main_vb, *label,\r\n*types_vb, *indent,\r\n*timeshift_offset_hb,\r\n*timeshift_offset_text_box,\r\n*settime_time_hb,\r\n*settime_packetnumber_text_box,\r\n*settime_time_text_box,\r\n*adjtime_offset_hb,\r\n*adjtime_packetnumber1_text_box,\r\n*adjtime_packetnumber2_text_box,\r\n*adjtime_time1_text_box,\r\n*adjtime_time2_text_box,\r\n*undo_offset_hb,\r\n*undo_type_hb,\r\n*timeshift_rb, *settime_rb,\r\n*adjtime_rb, *undo_rb,\r\n*bbox, *apply_bt, *close_bt, *help_bt;\r\nGString * frame_str = g_string_new("");\r\ngint rb_size = 0, rb_spacing = 0, indent_width = 0;\r\nif (time_shift_frame_w != NULL) {\r\nreactivate_window(time_shift_frame_w);\r\nreturn;\r\n}\r\ntime_shift_frame_w = dlg_window_new("Wireshark: Time Shift");\r\ngtk_container_set_border_width (GTK_CONTAINER (time_shift_frame_w), DLG_OUTER_MARGIN);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_UNRELATED_SPACING, FALSE);\r\ngtk_container_add(GTK_CONTAINER(time_shift_frame_w), main_vb);\r\ntypes_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_LABEL_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), types_vb, TRUE, TRUE, 0);\r\ntimeshift_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), timeshift_offset_hb, FALSE, FALSE, 0);\r\ntimeshift_rb = gtk_radio_button_new_with_label (NULL, "Shift all packets");\r\ngtk_box_pack_start(GTK_BOX(timeshift_offset_hb), timeshift_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(timeshift_rb, "Shift the time on the frames.");\r\ngtk_widget_style_get(timeshift_rb, "indicator-size", &rb_size,\r\n"indicator-spacing", &rb_spacing, NULL);\r\nindent_width += rb_size + rb_spacing;\r\ntimeshift_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), timeshift_offset_hb, FALSE, FALSE, 0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(timeshift_offset_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Time offset in the format [+-][[hh:]mm:]ss[.ddd]");\r\ngtk_box_pack_start(GTK_BOX(timeshift_offset_hb), label, FALSE, FALSE, 0);\r\ntimeshift_offset_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(timeshift_offset_hb), timeshift_offset_text_box,\r\nTRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(timeshift_offset_text_box,\r\n"Enter the time to shift here. The format is "\r\n"[+-][[hh:]mm:]ss.[.ddddddddd].");\r\ntypes_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_LABEL_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), types_vb, TRUE, TRUE, 0);\r\nsettime_time_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), settime_time_hb, FALSE,\r\nFALSE, 0);\r\nsettime_rb = gtk_radio_button_new_with_label(gtk_radio_button_get_group(\r\nGTK_RADIO_BUTTON(timeshift_rb)), "Set packet to time");\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), settime_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(settime_rb,\r\n"Set the time of a certain frame and adjust the rest of the frames "\r\n"automatically.");\r\nsettime_time_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), settime_time_hb, FALSE,\r\nFALSE, 0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Packet number");\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), label, FALSE, FALSE, 0);\r\nif (cfile.current_frame) {\r\ng_string_printf(frame_str, "%u", cfile.current_frame->num);\r\n} else {\r\ng_string_printf(frame_str, "%u", cfile.first_displayed);\r\n}\r\nsettime_packetnumber_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), settime_packetnumber_text_box,\r\nTRUE, TRUE, 0);\r\ngtk_entry_set_text(GTK_ENTRY(settime_packetnumber_text_box), frame_str->str);\r\ngtk_widget_set_tooltip_text(settime_packetnumber_text_box,\r\n"The frame which will be set to the time.");\r\nsettime_time_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), settime_time_hb, FALSE, FALSE,\r\n0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Set packet to time [YYYY-MM-DD] hh:mm:ss[.ddd]");\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), label, FALSE, FALSE, 0);\r\nsettime_time_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(settime_time_hb), settime_time_text_box, TRUE,\r\nTRUE, 0);\r\ngtk_widget_set_tooltip_text(settime_time_text_box,\r\n"The time for the frame in the format of [YYYY-MM-DD] "\r\n"hh:mm:ss[.ddddddddd]");\r\ntypes_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_LABEL_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), types_vb, TRUE, TRUE, 0);\r\nadjtime_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), adjtime_offset_hb, FALSE, FALSE, 0);\r\nadjtime_rb = gtk_radio_button_new_with_label(gtk_radio_button_get_group(\r\nGTK_RADIO_BUTTON(timeshift_rb)), "Set packets to time and extrapolate");\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), adjtime_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(adjtime_rb,\r\n"Set the time of two frames and adjust the rest of the frames "\r\n"automatically.");\r\nadjtime_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), adjtime_offset_hb, FALSE, FALSE, 0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Packet number");\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), label, FALSE, FALSE, 0);\r\nadjtime_packetnumber1_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), adjtime_packetnumber1_text_box,\r\nTRUE, TRUE, 0);\r\ngtk_entry_set_text(GTK_ENTRY(adjtime_packetnumber1_text_box), frame_str->str);\r\ngtk_widget_set_tooltip_text(adjtime_packetnumber1_text_box,\r\n"The frame which will be set to the time.");\r\nadjtime_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), adjtime_offset_hb, FALSE, FALSE,\r\n0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Set packet to time [YYYY-MM-DD] hh:mm:ss[.ddd]");\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), label, FALSE, FALSE, 0);\r\nadjtime_time1_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), adjtime_time1_text_box, TRUE,\r\nTRUE, 0);\r\ngtk_entry_set_text(GTK_ENTRY(adjtime_time1_text_box), "");\r\ngtk_widget_set_tooltip_text(adjtime_time1_text_box,\r\n"The time for the frame in the format of [YYYY-MM-DD] "\r\n"hh:mm:ss[.ddddddddd]");\r\nadjtime_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), adjtime_offset_hb, FALSE,\r\nFALSE, 0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Packet number");\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), label, FALSE, FALSE, 0);\r\ng_string_printf(frame_str, "%u", cfile.last_displayed);\r\nadjtime_packetnumber2_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), adjtime_packetnumber2_text_box,\r\nTRUE, TRUE, 0);\r\ngtk_entry_set_text(GTK_ENTRY(adjtime_packetnumber2_text_box), frame_str->str);\r\ngtk_widget_set_tooltip_text(adjtime_packetnumber2_text_box,\r\n"The frame which will be set to the time.");\r\nadjtime_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), adjtime_offset_hb, FALSE, FALSE,\r\n0);\r\nindent = gtk_alignment_new(0,0,0,0);\r\ngtk_widget_set_size_request(indent, indent_width, -1);\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), indent, FALSE, FALSE, 0);\r\nlabel = gtk_label_new("Set packet to time [YYYY-MM-DD] hh:mm:ss[.ddd]");\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), label, FALSE, FALSE, 0);\r\nadjtime_time2_text_box = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(adjtime_offset_hb), adjtime_time2_text_box, TRUE,\r\nTRUE, 0);\r\ngtk_entry_set_text(GTK_ENTRY(adjtime_time2_text_box), "");\r\ngtk_widget_set_tooltip_text(adjtime_time2_text_box,\r\n"The time for the frame in the format of [YYYY-MM-DD] "\r\n"hh:mm:ss[.ddddddddd]");\r\ntypes_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, DLG_LABEL_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), types_vb, TRUE, TRUE, 0);\r\nundo_type_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), undo_type_hb, TRUE, TRUE, 0);\r\nundo_offset_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, DLG_BUTTON_SPACING, FALSE);\r\ngtk_box_pack_start(GTK_BOX(types_vb), undo_offset_hb, FALSE,\r\nFALSE, 0);\r\nundo_rb = gtk_radio_button_new_with_label(gtk_radio_button_get_group(\r\nGTK_RADIO_BUTTON(timeshift_rb)), "Undo all shifts");\r\ngtk_box_pack_start(GTK_BOX(undo_offset_hb), undo_rb, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(undo_rb,\r\n"Undo all the Time Shift offsets on the frames.");\r\nbbox = dlg_button_row_new(GTK_STOCK_APPLY, GTK_STOCK_CLOSE, GTK_STOCK_HELP,\r\nNULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, TRUE, TRUE, 0);\r\napply_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_APPLY);\r\ng_signal_connect(apply_bt, "clicked", G_CALLBACK(time_shift_apply_cb),\r\ntime_shift_frame_w);\r\ngtk_widget_set_tooltip_text(apply_bt,\r\n"Apply the Time Shift options to the frame data.");\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(time_shift_frame_w, close_bt, window_cancel_button_cb);\r\ng_signal_connect(close_bt, "clicked", G_CALLBACK(time_shift_close_cb),\r\ntime_shift_frame_w);\r\ngtk_widget_set_tooltip_text(close_bt, "Close this dialog box.");\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb),\r\n(gpointer)HELP_TIME_SHIFT_DIALOG);\r\ngtk_widget_set_tooltip_text(help_bt,\r\n"Help on how the Time Shift feature works.");\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_TIMESHIFT_SELECT,\r\ntimeshift_rb);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_TIMESHIFT_OFFSET_KEY,\r\ntimeshift_offset_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_SETTIME_SELECT, settime_rb);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_SETTIME_TIME_KEY,\r\nsettime_time_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_SETTIME_PACKETNUMBER_KEY,\r\nsettime_packetnumber_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_ADJTIME_SELECT, adjtime_rb);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_ADJTIME_TIME1_KEY,\r\nadjtime_time1_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_ADJTIME_PACKETNUMBER1_KEY,\r\nadjtime_packetnumber1_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_ADJTIME_TIME2_KEY,\r\nadjtime_time2_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_ADJTIME_PACKETNUMBER2_KEY,\r\nadjtime_packetnumber2_text_box);\r\ng_object_set_data(G_OBJECT(time_shift_frame_w), E_UNDO_SELECT, undo_rb);\r\ndlg_set_activate(timeshift_offset_text_box, apply_bt);\r\ngtk_widget_grab_focus(timeshift_offset_text_box);\r\ng_signal_connect(time_shift_frame_w, "delete_event",\r\nG_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(time_shift_frame_w, "destroy",\r\nG_CALLBACK(time_shift_frame_destroy_cb), NULL);\r\ng_string_free(frame_str, TRUE);\r\ngtk_widget_show_all(time_shift_frame_w);\r\nwindow_present(time_shift_frame_w);\r\n}\r\nstatic void\r\nerror_message(const gchar *msg)\r\n{\r\nif (msg)\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", msg);\r\n}\r\nstatic void\r\ntime_shift_apply_cb(GtkWidget *ok_bt _U_, GtkWindow *parent_w)\r\n{\r\nGtkWidget *flag_rb, *offset_te, *packetnumber_te, *time_te;\r\nconst gchar *offset_text, *time_text, *time2_text;\r\nguint packet_num, packet2_num;\r\nif (cfile.state == FILE_CLOSED) {\r\nreturn;\r\n}\r\nif (cfile.state == FILE_READ_IN_PROGRESS) {\r\nerror_message("The Time Shift functions are not available on live captures.");\r\nreturn;\r\n}\r\nflag_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_TIMESHIFT_SELECT);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(flag_rb)) == TRUE) {\r\noffset_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_TIMESHIFT_OFFSET_KEY);\r\noffset_text = gtk_entry_get_text(GTK_ENTRY(offset_te));\r\nerror_message(time_shift_all(&cfile, offset_text));\r\nreturn;\r\n}\r\nflag_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_SETTIME_SELECT);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(flag_rb)) == TRUE) {\r\npacketnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_SETTIME_PACKETNUMBER_KEY);\r\npacket_num = (guint)strtol(gtk_entry_get_text(GTK_ENTRY(packetnumber_te)), NULL, 10);\r\ntime_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_SETTIME_TIME_KEY);\r\ntime_text = gtk_entry_get_text(GTK_ENTRY(time_te));\r\nerror_message(time_shift_settime(&cfile, packet_num, time_text));\r\nreturn;\r\n}\r\nflag_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_ADJTIME_SELECT);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(flag_rb)) == TRUE) {\r\npacketnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_ADJTIME_PACKETNUMBER1_KEY);\r\npacket_num = (guint)strtol(gtk_entry_get_text(GTK_ENTRY(packetnumber_te)), NULL, 10);\r\ntime_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_ADJTIME_TIME1_KEY);\r\ntime_text = gtk_entry_get_text(GTK_ENTRY(time_te));\r\npacketnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_ADJTIME_PACKETNUMBER2_KEY);\r\npacket2_num = (guint)strtol(gtk_entry_get_text(GTK_ENTRY(packetnumber_te)), NULL, 10);\r\ntime_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w),\r\nE_ADJTIME_TIME2_KEY);\r\ntime2_text = gtk_entry_get_text(GTK_ENTRY(time_te));\r\nerror_message(time_shift_adjtime(&cfile, packet_num, time_text, packet2_num, time2_text));\r\nreturn;\r\n}\r\nflag_rb = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_UNDO_SELECT);\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(flag_rb)) == TRUE) {\r\nerror_message(time_shift_undo(&cfile));\r\nreturn;\r\n}\r\n}\r\nstatic void\r\ntime_shift_close_cb(GtkWidget *close_bt _U_, gpointer parent_w _U_)\r\n{\r\ngtk_grab_remove(GTK_WIDGET(parent_w));\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\ntime_shift_frame_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\ntime_shift_frame_w = NULL;\r\n}

static gint\r\ndissect_parameter(tvbuff_t *tvb, packet_info *pinfo, proto_tree *top_tree,\r\nproto_tree *tree, gint offset, guint8 *parameter, gint *parameter_offset)\r\n{\r\nproto_item *parameter_item;\r\nproto_item *pitem;\r\nproto_tree *ptree;\r\ntvbuff_t *next_tvb;\r\nguint parameter_id;\r\nguint parameter_length;\r\nguint parameter_padding_length;\r\nguint padding_length;\r\nguint length;\r\nguint16 max_msg_size;\r\nguint8 connection_status;\r\nguint8 result_code;\r\nguint8 disconnection_type;\r\nguint8 status_change;\r\nguint8 transport_protocol;\r\nparameter_id = tvb_get_guint8(tvb, offset);\r\nparameter_length = tvb_get_ntohs(tvb, offset + 2);\r\nparameter_padding_length = parameter_length % 4;\r\nif (parameter_padding_length > 0)\r\nparameter_padding_length = 4 - parameter_padding_length;\r\nparameter_item = proto_tree_add_none_format(tree, hf_btsap_parameter, tvb, offset,\r\n2 + 2 + parameter_length + parameter_padding_length, "Parameter: %s: ",\r\nval_to_str_const(parameter_id, parameter_id_vals, "Unknown ParameterID"));\r\nptree = proto_item_add_subtree(parameter_item, ett_btsap_parameter);\r\nproto_tree_add_item(ptree, hf_btsap_parameter_id, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - %s", val_to_str_const(parameter_id, parameter_id_vals, "Unknown ParameterID"));\r\noffset += 1;\r\nproto_tree_add_item(ptree, hf_btsap_parameter_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\npitem = proto_tree_add_item(ptree, hf_btsap_parameter_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_item_append_text(pitem, " (in 4 bytes sections, padding length: %u)", parameter_padding_length);\r\noffset += 2;\r\nswitch(parameter_id) {\r\ncase 0x00:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_max_msg_size, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nmax_msg_size = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(parameter_item, "%u", max_msg_size);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u", max_msg_size);\r\nlength = 2;\r\npadding_length = 2;\r\nbreak;\r\ncase 0x01:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_connection_status, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nconnection_status = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(parameter_item, "%s", val_to_str_const(connection_status, connection_status_vals, "Unknown"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s", val_to_str_const(connection_status, connection_status_vals, "Unknown"));\r\nlength = 1;\r\npadding_length = 3;\r\nbreak;\r\ncase 0x02:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_result_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nresult_code = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(parameter_item, "%s", val_to_str_const(result_code, result_code_vals, "Unknown"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s", val_to_str_const(result_code, result_code_vals, "Unknown"));\r\nlength = 1;\r\npadding_length = 3;\r\nbreak;\r\ncase 0x03:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_disconnection_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ndisconnection_type = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(parameter_item, "%s", val_to_str_const(disconnection_type, disconnection_type_vals, "Unknown"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s", val_to_str_const(disconnection_type, disconnection_type_vals, "Unknown"));\r\nlength = 1;\r\npadding_length = 3;\r\nbreak;\r\ncase 0x04:\r\nif (gsm_sim_cmd_handle && top_dissect != TOP_DISSECT_OFF) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, parameter_length);\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": ");\r\nif (top_dissect == TOP_DISSECT_INTERNAL) {\r\ncall_dissector(gsm_sim_cmd_handle, next_tvb, pinfo, ptree);\r\n} else {\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncall_dissector(gsm_sim_cmd_handle, next_tvb, pinfo, top_tree);\r\n}\r\n} else {\r\nproto_tree_add_item(ptree, hf_btsap_data, tvb, offset, parameter_length, ENC_NA);\r\n}\r\nlength = parameter_length;\r\npadding_length = parameter_padding_length;\r\nbreak;\r\ncase 0x05:\r\nif (gsm_sim_resp_handle && top_dissect != TOP_DISSECT_OFF) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, parameter_length);\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": ");\r\nif (top_dissect == TOP_DISSECT_INTERNAL) {\r\ncall_dissector(gsm_sim_resp_handle, next_tvb, pinfo, ptree);\r\n} else {\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncall_dissector(gsm_sim_resp_handle, next_tvb, pinfo, top_tree);\r\n}\r\n} else {\r\nproto_tree_add_item(ptree, hf_btsap_data, tvb, offset, parameter_length, ENC_NA);\r\n}\r\nlength = parameter_length;\r\npadding_length = parameter_padding_length;\r\nbreak;\r\ncase 0x06:\r\nif (iso7816_atr_handle && top_dissect != TOP_DISSECT_OFF) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, parameter_length);\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": ");\r\nif (top_dissect == TOP_DISSECT_INTERNAL) {\r\ncall_dissector(iso7816_atr_handle, next_tvb, pinfo, ptree);\r\n} else {\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncall_dissector(iso7816_atr_handle, next_tvb, pinfo, top_tree);\r\n}\r\n} else {\r\nproto_tree_add_item(ptree, hf_btsap_data, tvb, offset, parameter_length, ENC_NA);\r\n}\r\nlength = parameter_length;\r\npadding_length = parameter_padding_length;\r\nbreak;\r\ncase 0x07:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_card_reader_status_card_powered, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptree, hf_btsap_parameter_card_reader_status_card_present, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptree, hf_btsap_parameter_card_reader_status_card_reader_present_lower, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptree, hf_btsap_parameter_card_reader_status_card_reader_present, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptree, hf_btsap_parameter_card_reader_status_card_reader_removable, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ptree, hf_btsap_parameter_card_reader_status_card_reader_identity, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nlength = 1;\r\npadding_length = 3;\r\nbreak;\r\ncase 0x08:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_status_change, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nstatus_change = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(parameter_item, "%s", val_to_str_const(status_change, status_change_vals, "Unknown"));\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s", val_to_str_const(status_change, status_change_vals, "Unknown"));\r\nlength = 1;\r\npadding_length = 3;\r\nbreak;\r\ncase 0x09:\r\nproto_tree_add_item(ptree, hf_btsap_parameter_transport_protocol, tvb, offset, 1, ENC_BIG_ENDIAN);\r\ntransport_protocol = tvb_get_guint8(tvb, offset);\r\nproto_item_append_text(parameter_item, "%u", transport_protocol);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %u", transport_protocol);\r\nlength = 1;\r\npadding_length = 3;\r\nbreak;\r\ncase 0x10:\r\nif (gsm_sim_cmd_handle && top_dissect != TOP_DISSECT_OFF) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, parameter_length);\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": ");\r\nif (top_dissect == TOP_DISSECT_INTERNAL) {\r\ncall_dissector(gsm_sim_cmd_handle, next_tvb, pinfo, ptree);\r\n} else {\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncall_dissector(gsm_sim_cmd_handle, next_tvb, pinfo, top_tree);\r\n}\r\n} else {\r\nproto_tree_add_item(ptree, hf_btsap_data, tvb, offset, parameter_length, ENC_NA);\r\n}\r\nlength = parameter_length;\r\npadding_length = parameter_padding_length;\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(ptree, hf_btsap_data, tvb, offset, parameter_length, ENC_NA);\r\nlength = parameter_length;\r\npadding_length = parameter_padding_length;\r\n}\r\n*parameter = parameter_id;\r\n*parameter_offset = offset;\r\nif (length != parameter_length || padding_length != parameter_padding_length) {\r\nexpert_add_info_format(pinfo, pitem, &ei_btsap_parameter_error,\r\n"Parameter Length does not meet content length");\r\n}\r\noffset += parameter_length;\r\nif (parameter_padding_length > 0) {\r\npitem = proto_tree_add_item(ptree, hf_btsap_parameter_padding, tvb, offset, parameter_padding_length, ENC_NA);\r\nproto_item_append_text(pitem, " (length %d)", parameter_padding_length);\r\noffset += parameter_padding_length;\r\n}\r\nreturn offset;\r\n}\r\nstatic gint\r\ndissect_btsap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *btsap_tree;\r\nguint offset = 0;\r\nguint msg_id;\r\nguint number_of_parameters;\r\nguint8 *parameters;\r\ngint *parameter_offsets;\r\nguint parameters_check = 0;\r\nguint required_parameters = 0;\r\nguint i_parameter;\r\nguint i_next_parameter;\r\nti = proto_tree_add_item(tree, proto_btsap, tvb, offset, -1, ENC_NA);\r\nbtsap_tree = proto_item_add_subtree(ti, ett_btsap);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SAP");\r\nswitch (pinfo->p2p_dir) {\r\ncase P2P_DIR_SENT:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Sent ");\r\nbreak;\r\ncase P2P_DIR_RECV:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "UnknownDirection ");\r\nbreak;\r\n}\r\nproto_tree_add_item(btsap_tree, hf_btsap_header_msg_id, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nmsg_id = tvb_get_guint8(tvb, offset);\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str_const(msg_id, msg_id_vals, "Unknown MsgID"));\r\noffset += 1;\r\nproto_tree_add_item(btsap_tree, hf_btsap_header_number_of_parameters, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nnumber_of_parameters = tvb_get_guint8(tvb, offset);\r\noffset += 1;\r\nproto_tree_add_item(btsap_tree, hf_btsap_header_reserved, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nparameters = (guint8 *) wmem_alloc(wmem_packet_scope(), number_of_parameters * sizeof(guint8));\r\nparameter_offsets = (gint *) wmem_alloc0(wmem_packet_scope(), number_of_parameters * sizeof(guint));\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\noffset = dissect_parameter(tvb, pinfo, tree, btsap_tree, offset, &parameters[i_parameter], &parameter_offsets[i_parameter]);\r\n}\r\nswitch(msg_id) {\r\ncase 0x02:\r\ncase 0x03:\r\ncase 0x07:\r\ncase 0x09:\r\ncase 0x0B:\r\ncase 0x0D:\r\ncase 0x0F:\r\ncase 0x12:\r\nrequired_parameters = 0;\r\nbreak;\r\ncase 0x0A:\r\ncase 0x0C:\r\ncase 0x0E:\r\ncase 0x14:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_RESULT_CODE) ++parameters_check;\r\n}\r\nbreak;\r\ncase 0x00:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_MAX_MSG_SIZE) ++parameters_check;\r\n}\r\nbreak;\r\ncase 0x01:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_CONNECTION_STATUS) {\r\nif (tvb_get_guint8(tvb, parameter_offsets[i_parameter]) != 0x00) {\r\nfor (i_next_parameter = 0; i_next_parameter < number_of_parameters; ++i_next_parameter) {\r\nif (parameters[i_next_parameter] == PARAMETER_MAX_MSG_SIZE) {\r\n++parameters_check;\r\nrequired_parameters = 2;\r\n}\r\n}\r\n}\r\n++parameters_check;\r\n}\r\n}\r\nbreak;\r\ncase 0x04:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_DISCONNECTION_TYPE) ++parameters_check;\r\n}\r\nbreak;\r\ncase 0x05:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_COMMAND_APDU ||\r\nparameters[i_parameter] == PARAMETER_COMMAND_APDU_7816)\r\n++parameters_check;\r\n}\r\nbreak;\r\ncase 0x06:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_RESULT_CODE) {\r\nif (tvb_get_guint8(tvb, parameter_offsets[i_parameter]) == 0x00) {\r\nfor (i_next_parameter = 0; i_next_parameter < number_of_parameters; ++i_next_parameter) {\r\nif (parameters[i_next_parameter] == PARAMETER_RESPONSE_APDU) {\r\n++parameters_check;\r\nrequired_parameters = 2;\r\n}\r\n}\r\n}\r\n++parameters_check;\r\n}\r\n}\r\nbreak;\r\ncase 0x08:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_RESULT_CODE) {\r\nif (tvb_get_guint8(tvb, parameter_offsets[i_parameter]) == 0x00) {\r\nfor (i_next_parameter = 0; i_next_parameter < number_of_parameters; ++i_next_parameter) {\r\nif (parameters[i_next_parameter] == PARAMETER_ATR) {\r\n++parameters_check;\r\nrequired_parameters = 2;\r\n}\r\n}\r\n}\r\n++parameters_check;\r\n}\r\n}\r\nbreak;\r\ncase 0x10:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_RESULT_CODE) {\r\nif (tvb_get_guint8(tvb, parameter_offsets[i_parameter]) == 0x00) {\r\nfor (i_next_parameter = 0; i_next_parameter < number_of_parameters; ++i_next_parameter) {\r\nif (parameters[i_next_parameter] == PARAMETER_CARD_READER_STATUS) {\r\n++parameters_check;\r\nrequired_parameters = 2;\r\n}\r\n}\r\n}\r\n++parameters_check;\r\n}\r\n}\r\nbreak;\r\ncase 0x11:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_STATUS_CHANGE) ++parameters_check;\r\n}\r\nbreak;\r\ncase 0x13:\r\nrequired_parameters = 1;\r\nfor (i_parameter = 0; i_parameter < number_of_parameters; ++i_parameter) {\r\nif (parameters[i_parameter] == PARAMETER_TRANSPORT_PROTOCOL) ++parameters_check;\r\n}\r\nbreak;\r\n}\r\nif (parameters_check < required_parameters) {\r\nproto_tree_add_expert_format(tree, pinfo, &ei_btsap_parameter_error,\r\ntvb, offset, 0, "There are no required parameters");\r\n} else if (parameters_check > required_parameters) {\r\nproto_tree_add_expert_format(tree, pinfo, &ei_btsap_parameter_error,\r\ntvb, offset, 0, "Invalid parameters");\r\n}\r\nif (number_of_parameters < required_parameters) {\r\nproto_tree_add_expert_format(tree, pinfo, &ei_btsap_parameter_error,\r\ntvb, offset, 0, "Too few parameters");\r\n} else if (number_of_parameters > required_parameters) {\r\nproto_tree_add_expert_format(tree, pinfo, &ei_btsap_parameter_error,\r\ntvb, offset, 0, "Too many parameters");\r\n}\r\nif (tvb_reported_length(tvb) > offset)\r\nproto_tree_add_expert(tree, pinfo, &ei_unexpected_data, tvb, offset, tvb_reported_length_remaining(tvb, offset));\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_btsap(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t *expert_btsap;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_btsap_header_msg_id,\r\n{ "MsgID", "btsap.msg_id",\r\nFT_UINT8, BASE_HEX, VALS(msg_id_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_header_number_of_parameters,\r\n{ "Number of Parameters", "btsap.number_of_parameters",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_header_reserved,\r\n{ "reserved", "btsap.reserved",\r\nFT_UINT16, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter,\r\n{ "Parameter", "btsap.parameter",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_id,\r\n{ "Parameter ID", "btsap.parameter_id",\r\nFT_UINT8, BASE_HEX, VALS(parameter_id_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_reserved,\r\n{ "reserved", "btsap.parameter.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_length,\r\n{ "Parameter Length", "btsap.parameter.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_padding,\r\n{ "Parameter Padding", "btsap.parameter.padding",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_max_msg_size,\r\n{ "Max Msg Size", "btsap.parameter.max_msg_size",\r\nFT_UINT16, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_connection_status,\r\n{ "Connection Status", "btsap.parameter.connection_status",\r\nFT_UINT8, BASE_HEX, VALS(connection_status_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_result_code,\r\n{ "Result Code", "btsap.parameter.result_code",\r\nFT_UINT8, BASE_HEX, VALS(result_code_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_disconnection_type,\r\n{ "Disconnection Type", "btsap.parameter.disconnection_type",\r\nFT_UINT8, BASE_HEX, VALS(disconnection_type_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_card_reader_status_card_reader_identity,\r\n{ "Identify of Card Reader", "btsap.parameter.card_reader_status.card_reader_identity",\r\nFT_UINT8, BASE_HEX, NULL, 0x03,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_card_reader_status_card_reader_removable,\r\n{ "Card Reader is Removable", "btsap.parameter.card_reader_status.card_reader_removable",\r\nFT_BOOLEAN, 8, NULL, 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_card_reader_status_card_reader_present,\r\n{ "Card Reader is Present", "btsap.parameter.card_reader_status.card_reader_present",\r\nFT_BOOLEAN, 8, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_card_reader_status_card_reader_present_lower,\r\n{ "Card Reader Present is ID-1 Size","btsap.parameter.card_reader_status.card_reader_present_lower",\r\nFT_BOOLEAN, 8, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_card_reader_status_card_present,\r\n{ "Card is Present in Reader", "btsap.parameter.card_reader_status.card_present",\r\nFT_BOOLEAN, 8, NULL, 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_card_reader_status_card_powered,\r\n{ "Card in Reader is Powered", "btsap.parameter.card_reader_status.card_powered",\r\nFT_BOOLEAN, 8, NULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_status_change,\r\n{ "Status Change", "btsap.parameter.status_change",\r\nFT_UINT8, BASE_HEX, VALS(status_change_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_parameter_transport_protocol,\r\n{ "Transport Protocol", "btsap.parameter.transport_protocol",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_btsap_data,\r\n{ "Data", "btsap.data",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_btsap,\r\n&ett_btsap_parameter\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_btsap_parameter_error, { "btsap.parameter_error", PI_PROTOCOL, PI_WARN, "Parameter error", EXPFILL }},\r\n{ &ei_unexpected_data, { "btsap.unexpected_data", PI_PROTOCOL, PI_WARN, "Unexpected_data", EXPFILL }},\r\n};\r\nproto_btsap = proto_register_protocol("Bluetooth SAP Profile", "BT SAP", "btsap");\r\nbtsap_handle = register_dissector("btsap", dissect_btsap, proto_btsap);\r\nproto_register_field_array(proto_btsap, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_btsap = expert_register_protocol(proto_btsap);\r\nexpert_register_field_array(expert_btsap, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_btsap, NULL);\r\nprefs_register_static_text_preference(module, "sap.version",\r\n"Bluetooth Profile SAP version: 1.1",\r\n"Version of protocol supported by this dissector.");\r\nprefs_register_enum_preference(module, "sap.top_dissect",\r\n"Dissecting the top protocols", "Dissecting the top protocols",\r\n&top_dissect, pref_top_dissect, FALSE);\r\n}\r\nvoid\r\nproto_reg_handoff_btsap(void)\r\n{\r\ngsm_sim_cmd_handle = find_dissector_add_dependency("gsm_sim.command", proto_btsap);\r\ngsm_sim_resp_handle = find_dissector_add_dependency("gsm_sim.response", proto_btsap);\r\niso7816_atr_handle = find_dissector_add_dependency("iso7816.atr", proto_btsap);\r\ndissector_add_string("bluetooth.uuid", "112d", btsap_handle);\r\ndissector_add_for_decode_as("btrfcomm.dlci", btsap_handle);\r\n}

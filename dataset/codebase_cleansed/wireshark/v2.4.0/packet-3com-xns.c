static int\r\ndissect_3com_xns(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *subtree;\r\nproto_tree *ti;\r\nguint16 type;\r\ntvbuff_t *next_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "3Com XNS");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nti = proto_tree_add_item(tree, proto_3com_xns, tvb, 0, 4, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_3com_xns);\r\ntype = tvb_get_ntohs(tvb, 0);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 2);\r\nif (type == 0x0004) {\r\nproto_tree_add_uint(subtree, hf_3com_xns_type_retix_bpdu,\r\ntvb, 0, 2, type);\r\ncall_dissector(retix_bpdu_handle, next_tvb, pinfo, tree);\r\n} else {\r\nproto_tree_add_uint(subtree, hf_3com_xns_type_ethertype,\r\ntvb, 0, 2, type);\r\nif (!dissector_try_uint(ethertype_subdissector_table,\r\ntype, next_tvb, pinfo, tree))\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_3com_xns(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_3com_xns_type_ethertype,\r\n{ "Type", "3comxns.type", FT_UINT16, BASE_HEX,\r\nVALS(etype_vals), 0x0, NULL, HFILL }},\r\n{ &hf_3com_xns_type_retix_bpdu,\r\n{ "Type", "3comxns.type", FT_UINT16, BASE_HEX,\r\nVALS(retix_bpdu_type_vals), 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] ={\r\n&ett_3com_xns,\r\n};\r\nproto_3com_xns = proto_register_protocol("3Com XNS Encapsulation", "3COMXNS", "3comxns");\r\nproto_register_field_array(proto_3com_xns, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_3com_xns(void)\r\n{\r\ndissector_handle_t our_xns_handle;\r\nretix_bpdu_handle = find_dissector_add_dependency("rbpdu", proto_3com_xns);\r\nethertype_subdissector_table = find_dissector_table("ethertype");\r\nour_xns_handle = create_dissector_handle(dissect_3com_xns, proto_3com_xns);\r\ndissector_add_uint("llc.dsap", 0x80, our_xns_handle);\r\n}

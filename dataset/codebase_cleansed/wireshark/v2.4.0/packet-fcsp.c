static void dissect_fcsp_dhchap_auth_param(tvbuff_t *tvb, proto_tree *tree,\r\nint offset, gint32 total_len)\r\n{\r\nguint16 auth_param_tag;\r\nguint16 param_len, i;\r\nif (tree) {\r\ntotal_len -= 4;\r\nwhile (total_len > 0) {\r\nproto_tree_add_item(tree, hf_auth_dhchap_param_tag, tvb, offset,\r\n2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_auth_dhchap_param_len, tvb, offset+2,\r\n2, ENC_BIG_ENDIAN);\r\nauth_param_tag = tvb_get_ntohs(tvb, offset);\r\nparam_len = tvb_get_ntohs(tvb, offset+2)*4;\r\nswitch (auth_param_tag) {\r\ncase FC_AUTH_DHCHAP_PARAM_HASHLIST:\r\noffset += 4;\r\ntotal_len -= 4;\r\nfor (i = 0; i < param_len; i += 4) {\r\nproto_tree_add_item(tree, hf_auth_dhchap_hash_type, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nbreak;\r\ncase FC_AUTH_DHCHAP_PARAM_DHgIDLIST:\r\noffset += 4;\r\ntotal_len -= 4;\r\nfor (i = 0; i < param_len; i += 4) {\r\nproto_tree_add_item(tree, hf_auth_dhchap_group_type, tvb,\r\noffset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nbreak;\r\ndefault:\r\nif (param_len == 0) {\r\nreturn;\r\n}\r\nbreak;\r\n}\r\ntotal_len -= param_len;\r\n}\r\n}\r\n}\r\nstatic void dissect_fcsp_dhchap_challenge(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nint offset = 12;\r\nguint16 name_type;\r\nguint16 param_len, name_len;\r\nif (tree) {\r\nproto_tree_add_item(tree, hf_auth_responder_name_type, tvb, offset,\r\n2, ENC_BIG_ENDIAN);\r\nname_type = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_responder_name_len, tvb, offset+2,\r\n2, ENC_BIG_ENDIAN);\r\nname_len = tvb_get_ntohs(tvb, offset+2);\r\nif (name_type == FC_AUTH_NAME_TYPE_WWN) {\r\nproto_tree_add_item(tree, hf_auth_responder_wwn, tvb, offset+4,\r\n8, ENC_NA);\r\n}\r\nelse {\r\nproto_tree_add_item(tree, hf_auth_responder_name, tvb, offset+4,\r\nname_len, ENC_NA);\r\n}\r\noffset += (4+name_len);\r\nproto_tree_add_item(tree, hf_auth_dhchap_hash_type, tvb, offset,\r\n4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_auth_dhchap_group_type, tvb, offset+4,\r\n4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_auth_dhchap_chal_len, tvb, offset+8,\r\n4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset+8);\r\nproto_tree_add_item(tree, hf_auth_dhchap_chal_value, tvb, offset+12,\r\nparam_len, ENC_NA);\r\noffset += (param_len + 12);\r\nproto_tree_add_item(tree, hf_auth_dhchap_val_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_dhchap_dhvalue, tvb, offset+4,\r\nparam_len, ENC_NA);\r\n}\r\n}\r\nstatic void dissect_fcsp_dhchap_reply(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nint offset = 12;\r\nguint32 param_len;\r\nif (tree) {\r\nproto_tree_add_item(tree, hf_auth_dhchap_rsp_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_dhchap_rsp_value, tvb, offset+4,\r\nparam_len, ENC_NA);\r\noffset += (param_len + 4);\r\nproto_tree_add_item(tree, hf_auth_dhchap_val_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_dhchap_dhvalue, tvb, offset+4,\r\nparam_len, ENC_NA);\r\noffset += (param_len + 4);\r\nproto_tree_add_item(tree, hf_auth_dhchap_chal_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_dhchap_chal_value, tvb, offset+4,\r\nparam_len, ENC_NA);\r\n}\r\n}\r\nstatic void dissect_fcsp_dhchap_success(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nint offset = 12;\r\nguint32 param_len;\r\nif (tree) {\r\nproto_tree_add_item(tree, hf_auth_dhchap_rsp_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_dhchap_rsp_value, tvb, offset+4,\r\nparam_len, ENC_NA);\r\n}\r\n}\r\nstatic void dissect_fcsp_auth_negotiate(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nint offset = 12;\r\nguint16 name_type, name_len, proto_type, param_len;\r\nguint32 num_protos, i;\r\nif (tree) {\r\nproto_tree_add_item(tree, hf_auth_initiator_name_type, tvb, offset,\r\n2, ENC_BIG_ENDIAN);\r\nname_type = tvb_get_ntohs(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_initiator_name_len, tvb, offset+2,\r\n2, ENC_BIG_ENDIAN);\r\nname_len = tvb_get_ntohs(tvb, offset+2);\r\nif (name_type == FC_AUTH_NAME_TYPE_WWN) {\r\nproto_tree_add_item(tree, hf_auth_initiator_wwn, tvb, offset+4, 8, ENC_NA);\r\n}\r\nelse {\r\nproto_tree_add_item(tree, hf_auth_initiator_name, tvb, offset+4,\r\nname_len, ENC_NA);\r\n}\r\noffset += (4+name_len);\r\nproto_tree_add_item(tree, hf_auth_usable_proto, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nnum_protos = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nfor (i = 0; i < num_protos; i++) {\r\nproto_tree_add_item(tree, hf_auth_proto_param_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nparam_len = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nif (tvb_bytes_exist(tvb, offset, param_len)) {\r\nproto_type = tvb_get_ntohl(tvb, offset);\r\nproto_tree_add_item(tree, hf_auth_proto_type, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nswitch (proto_type) {\r\ncase FC_AUTH_PROTO_TYPE_DHCHAP:\r\ndissect_fcsp_dhchap_auth_param(tvb, tree, offset+4, param_len);\r\nbreak;\r\ncase FC_AUTH_PROTO_TYPE_FCAP:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\noffset += param_len;\r\n}\r\n}\r\n}\r\nstatic void dissect_fcsp_auth_done(tvbuff_t *tvb _U_, proto_tree *tree _U_)\r\n{\r\n}\r\nstatic void dissect_fcsp_auth_rjt(tvbuff_t *tvb, proto_tree *tree)\r\n{\r\nint offset = 12;\r\nif (tree) {\r\nproto_tree_add_item(tree, hf_auth_rjt_code, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_auth_rjt_codedet, tvb, offset+1, 1, ENC_BIG_ENDIAN);\r\n}\r\n}\r\nstatic int dissect_fcsp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti = NULL;\r\nguint8 opcode;\r\nint offset = 0;\r\nproto_tree *fcsp_tree = NULL;\r\nopcode = tvb_get_guint8(tvb, 2);\r\ncol_add_str(pinfo->cinfo, COL_INFO,\r\nval_to_str(opcode, fcauth_msgcode_vals, "0x%x"));\r\nif (tree) {\r\nti = proto_tree_add_protocol_format(tree, proto_fcsp, tvb, 0,\r\ntvb_captured_length(tvb), "FC-SP");\r\nfcsp_tree = proto_item_add_subtree(ti, ett_fcsp);\r\nproto_tree_add_item(fcsp_tree, hf_auth_flags, tvb, offset+1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fcsp_tree, hf_auth_msg_code, tvb, offset+2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fcsp_tree, hf_auth_proto_ver, tvb, offset+3, 1,\r\nENC_BIG_ENDIAN);\r\nproto_tree_add_item(fcsp_tree, hf_auth_len, tvb, offset+4, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(fcsp_tree, hf_auth_tid, tvb, offset+8, 4, ENC_BIG_ENDIAN);\r\nswitch (opcode) {\r\ncase FC_AUTH_MSG_AUTH_REJECT:\r\ndissect_fcsp_auth_rjt(tvb, tree);\r\nbreak;\r\ncase FC_AUTH_MSG_AUTH_NEGOTIATE:\r\ndissect_fcsp_auth_negotiate(tvb, tree);\r\nbreak;\r\ncase FC_AUTH_MSG_AUTH_DONE:\r\ndissect_fcsp_auth_done(tvb, tree);\r\nbreak;\r\ncase FC_AUTH_DHCHAP_CHALLENGE:\r\ndissect_fcsp_dhchap_challenge(tvb, tree);\r\nbreak;\r\ncase FC_AUTH_DHCHAP_REPLY:\r\ndissect_fcsp_dhchap_reply(tvb, tree);\r\nbreak;\r\ncase FC_AUTH_DHCHAP_SUCCESS:\r\ndissect_fcsp_dhchap_success(tvb, tree);\r\nbreak;\r\ncase FC_AUTH_FCAP_REQUEST:\r\ncase FC_AUTH_FCAP_ACKNOWLEDGE:\r\ncase FC_AUTH_FCAP_CONFIRM:\r\ncase FC_AUTH_FCPAP_INIT:\r\ncase FC_AUTH_FCPAP_ACCEPT:\r\ncase FC_AUTH_FCPAP_COMPLETE:\r\nproto_tree_add_expert(fcsp_tree, pinfo, &ei_auth_fcap_undecoded, tvb, offset+12, -1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_fcsp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_auth_proto_ver,\r\n{ "Protocol Version", "fcsp.version",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_msg_code,\r\n{ "Message Code", "fcsp.opcode",\r\nFT_UINT8, BASE_HEX, VALS(fcauth_msgcode_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_flags,\r\n{ "Flags", "fcsp.flags",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_len,\r\n{ "Packet Length", "fcsp.len",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_tid,\r\n{ "Transaction Identifier", "fcsp.tid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_initiator_wwn,\r\n{ "Initiator Name (WWN)", "fcsp.initwwn",\r\nFT_FCWWN, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_initiator_name,\r\n{ "Initiator Name (Unknown Type)", "fcsp.initname",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_initiator_name_type,\r\n{ "Initiator Name Type", "fcsp.initnametype",\r\nFT_UINT16, BASE_HEX, VALS(fcauth_name_type_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_initiator_name_len,\r\n{ "Initiator Name Length", "fcsp.initnamelen",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_usable_proto,\r\n{ "Number of Usable Protocols", "fcsp.usableproto",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_rjt_code,\r\n{ "Reason Code", "fcsp.rjtcode",\r\nFT_UINT8, BASE_DEC, VALS(fcauth_rjtcode_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_rjt_codedet,\r\n{ "Reason Code Explanation", "fcsp.rjtcodet",\r\nFT_UINT8, BASE_DEC, VALS(fcauth_rjtcode_detail_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_responder_wwn,\r\n{ "Responder Name (WWN)", "fcsp.rspwwn",\r\nFT_FCWWN, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_responder_name,\r\n{ "Responder Name (Unknown Type)", "fcsp.rspname",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_responder_name_type,\r\n{ "Responder Name Type", "fcsp.rspnametype",\r\nFT_UINT16, BASE_HEX, VALS(fcauth_name_type_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_responder_name_len,\r\n{ "Responder Name Type", "fcsp.rspnamelen",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n#if 0\r\n{ &hf_auth_dhchap_hashid,\r\n{ "Hash Identifier", "fcsp.dhchap.hashid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n#endif\r\n#if 0\r\n{ &hf_auth_dhchap_groupid,\r\n{ "DH Group Identifier", "fcsp.dhchap.groupid",\r\nFT_UINT32, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}},\r\n#endif\r\n{ &hf_auth_dhchap_chal_len,\r\n{ "Challenge Value Length", "fcsp.dhchap.challen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_val_len,\r\n{ "DH Value Length", "fcsp.dhchap.vallen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_rsp_len,\r\n{ "Response Value Length", "fcsp.dhchap.rsplen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_proto_type,\r\n{ "Authentication Protocol Type", "fcsp.proto",\r\nFT_UINT32, BASE_DEC, VALS(fcauth_proto_type_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_proto_param_len,\r\n{ "Protocol Parameters Length", "fcsp.protoparamlen",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_param_tag,\r\n{ "Parameter Tag", "fcsp.dhchap.paramtype",\r\nFT_UINT16, BASE_HEX, VALS(fcauth_dhchap_param_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_param_len,\r\n{ "Parameter Length", "fcsp.dhchap.paramlen",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_hash_type,\r\n{ "Hash Algorithm", "fcsp.dhchap.hashtype",\r\nFT_UINT32, BASE_DEC, VALS(fcauth_dhchap_hash_algo_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_group_type,\r\n{ "DH Group", "fcsp.dhchap.dhgid",\r\nFT_UINT32, BASE_DEC, VALS(fcauth_dhchap_dhgid_vals), 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_chal_value,\r\n{ "Challenge Value", "fcsp.dhchap.chalval",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_dhvalue,\r\n{ "DH Value", "fcsp.dhchap.dhvalue",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n{ &hf_auth_dhchap_rsp_value,\r\n{ "Response Value", "fcsp.dhchap.rspval",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_fcsp,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_auth_fcap_undecoded, { "fcsp.fcap_undecoded", PI_UNDECODED, PI_WARN, "FCAP Decoding Not Supported", EXPFILL }},\r\n};\r\nexpert_module_t* expert_fcsp;\r\nproto_fcsp = proto_register_protocol("Fibre Channel Security Protocol", "FC-SP", "fcsp");\r\nregister_dissector("fcsp", dissect_fcsp, proto_fcsp);\r\nproto_register_field_array(proto_fcsp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_fcsp = expert_register_protocol(proto_fcsp);\r\nexpert_register_field_array(expert_fcsp, ei, array_length(ei));\r\n}

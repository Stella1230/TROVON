wmem_strbuf_t *\r\nwmem_strbuf_sized_new(wmem_allocator_t *allocator,\r\ngsize alloc_len, gsize max_len)\r\n{\r\nwmem_strbuf_t *strbuf;\r\ng_assert((max_len == 0) || (alloc_len <= max_len));\r\nstrbuf = wmem_new(allocator, wmem_strbuf_t);\r\nstrbuf->allocator = allocator;\r\nstrbuf->len = 0;\r\nstrbuf->alloc_len = alloc_len ? alloc_len : DEFAULT_MINIMUM_LEN;\r\nstrbuf->max_len = max_len;\r\nstrbuf->str = (gchar *)wmem_alloc(strbuf->allocator, strbuf->alloc_len);\r\nstrbuf->str[0] = '\0';\r\nreturn strbuf;\r\n}\r\nwmem_strbuf_t *\r\nwmem_strbuf_new(wmem_allocator_t *allocator, const gchar *str)\r\n{\r\nwmem_strbuf_t *strbuf;\r\ngsize len, alloc_len;\r\nlen = str ? strlen(str) : 0;\r\nalloc_len = DEFAULT_MINIMUM_LEN;\r\nwhile (alloc_len < (len + 1)) {\r\nalloc_len *= 2;\r\n}\r\nstrbuf = wmem_strbuf_sized_new(allocator, alloc_len, 0);\r\nif (str && len > 0) {\r\ng_strlcpy(strbuf->str, str, alloc_len);\r\nstrbuf->len = len;\r\n}\r\nreturn strbuf;\r\n}\r\nstatic inline void\r\nwmem_strbuf_grow(wmem_strbuf_t *strbuf, const gsize to_add)\r\n{\r\ngsize new_alloc_len, new_len;\r\nif (WMEM_STRBUF_ROOM(strbuf) >= to_add) {\r\nreturn;\r\n}\r\nnew_alloc_len = strbuf->alloc_len;\r\nnew_len = strbuf->len + to_add;\r\nwhile (new_alloc_len < (new_len + 1)) {\r\nnew_alloc_len *= 2;\r\n}\r\nif (strbuf->max_len && new_alloc_len > strbuf->max_len) {\r\nnew_alloc_len = strbuf->max_len;\r\n}\r\nif (new_alloc_len == strbuf->alloc_len) {\r\nreturn;\r\n}\r\nstrbuf->str = (gchar *)wmem_realloc(strbuf->allocator, strbuf->str, new_alloc_len);\r\nstrbuf->alloc_len = new_alloc_len;\r\n}\r\nvoid\r\nwmem_strbuf_append(wmem_strbuf_t *strbuf, const gchar *str)\r\n{\r\ngsize append_len;\r\nif (!str || str[0] == '\0') {\r\nreturn;\r\n}\r\nappend_len = strlen(str);\r\nwmem_strbuf_grow(strbuf, append_len);\r\ng_strlcpy(&strbuf->str[strbuf->len], str, WMEM_STRBUF_RAW_ROOM(strbuf));\r\nstrbuf->len = MIN(strbuf->len + append_len, strbuf->alloc_len - 1);\r\n}\r\nstatic void\r\nwmem_strbuf_append_vprintf(wmem_strbuf_t *strbuf, const gchar *fmt, va_list ap)\r\n{\r\nva_list ap2;\r\ngsize append_len;\r\nG_VA_COPY(ap2, ap);\r\nappend_len = g_printf_string_upper_bound(fmt, ap);\r\nwmem_strbuf_grow(strbuf, append_len - 1);\r\nappend_len = g_vsnprintf(&strbuf->str[strbuf->len],\r\n(gulong) WMEM_STRBUF_RAW_ROOM(strbuf),\r\nfmt, ap2);\r\nva_end(ap2);\r\nstrbuf->len = MIN(strbuf->len + append_len, strbuf->alloc_len - 1);\r\n}\r\nstatic void\r\nwmem_strbuf_append_vprintf(wmem_strbuf_t *strbuf, const gchar *fmt, va_list ap)\r\n{\r\nva_list ap2;\r\ngsize append_len;\r\ngsize printed_len;\r\nG_VA_COPY(ap2, ap);\r\nappend_len = _vscprintf(fmt, ap);\r\nwmem_strbuf_grow(strbuf, append_len);\r\nprinted_len = vsnprintf_s(&strbuf->str[strbuf->len],\r\n(gulong) WMEM_STRBUF_RAW_ROOM(strbuf),\r\n_TRUNCATE,\r\nfmt, ap2);\r\nif (printed_len > -1) append_len = printed_len;\r\nva_end(ap2);\r\nstrbuf->len = MIN(strbuf->len + append_len, strbuf->alloc_len - 1);\r\n}\r\nvoid\r\nwmem_strbuf_append_printf(wmem_strbuf_t *strbuf, const gchar *format, ...)\r\n{\r\nva_list ap;\r\nva_start(ap, format);\r\nwmem_strbuf_append_vprintf(strbuf, format, ap);\r\nva_end(ap);\r\n}\r\nvoid\r\nwmem_strbuf_append_c(wmem_strbuf_t *strbuf, const gchar c)\r\n{\r\nwmem_strbuf_grow(strbuf, 1);\r\nif (WMEM_STRBUF_ROOM(strbuf) >= 1) {\r\nstrbuf->str[strbuf->len] = c;\r\nstrbuf->len++;\r\nstrbuf->str[strbuf->len] = '\0';\r\n}\r\n}\r\nvoid\r\nwmem_strbuf_append_unichar(wmem_strbuf_t *strbuf, const gunichar c)\r\n{\r\ngchar buf[6];\r\ngsize charlen;\r\ncharlen = g_unichar_to_utf8(c, buf);\r\nwmem_strbuf_grow(strbuf, charlen);\r\nif (WMEM_STRBUF_ROOM(strbuf) >= charlen) {\r\nmemcpy(&strbuf->str[strbuf->len], buf, charlen);\r\nstrbuf->len += charlen;\r\nstrbuf->str[strbuf->len] = '\0';\r\n}\r\n}\r\nvoid\r\nwmem_strbuf_truncate(wmem_strbuf_t *strbuf, const gsize len)\r\n{\r\nif (len >= strbuf->len) {\r\nreturn;\r\n}\r\nstrbuf->str[len] = '\0';\r\nstrbuf->len = len;\r\n}\r\nconst gchar *\r\nwmem_strbuf_get_str(wmem_strbuf_t *strbuf)\r\n{\r\nreturn strbuf->str;\r\n}\r\ngsize\r\nwmem_strbuf_get_len(wmem_strbuf_t *strbuf)\r\n{\r\nreturn strbuf->len;\r\n}\r\nchar *\r\nwmem_strbuf_finalize(wmem_strbuf_t *strbuf)\r\n{\r\nchar *ret;\r\nret = (char *)wmem_realloc(strbuf->allocator, strbuf->str, strbuf->len+1);\r\nwmem_free(strbuf->allocator, strbuf);\r\nreturn ret;\r\n}

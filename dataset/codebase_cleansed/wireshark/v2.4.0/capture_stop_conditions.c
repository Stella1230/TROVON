void init_capture_stop_conditions(void){\r\ncnd_register_class(CND_CLASS_TIMEOUT,\r\n_cnd_constr_timeout,\r\n_cnd_destr_timeout,\r\n_cnd_eval_timeout,\r\n_cnd_reset_timeout);\r\ncnd_register_class(CND_CLASS_CAPTURESIZE,\r\n_cnd_constr_capturesize,\r\n_cnd_destr_capturesize,\r\n_cnd_eval_capturesize,\r\n_cnd_reset_capturesize);\r\n}\r\nvoid cleanup_capture_stop_conditions(void){\r\ncnd_unregister_class(CND_CLASS_TIMEOUT);\r\ncnd_unregister_class(CND_CLASS_CAPTURESIZE);\r\n}\r\nstatic condition* _cnd_constr_timeout(condition* cnd, va_list ap){\r\ncnd_timeout_dat *data = NULL;\r\nif((data = (cnd_timeout_dat*)g_malloc(sizeof(cnd_timeout_dat))) == NULL)\r\nreturn NULL;\r\ndata->start_time = time(NULL);\r\ndata->timeout_s = va_arg(ap, gint32);\r\ncnd_set_user_data(cnd, (void*)data);\r\nreturn cnd;\r\n}\r\nstatic void _cnd_destr_timeout(condition* cnd){\r\ng_free(cnd_get_user_data(cnd));\r\n}\r\nstatic gboolean _cnd_eval_timeout(condition* cnd, va_list ap _U_){\r\ncnd_timeout_dat* data = (cnd_timeout_dat*)cnd_get_user_data(cnd);\r\ngint32 elapsed_time;\r\nif(data->timeout_s == 0) return FALSE;\r\nelapsed_time = (gint32) (time(NULL) - data->start_time);\r\nif(elapsed_time >= data->timeout_s) return TRUE;\r\nreturn FALSE;\r\n}\r\nstatic void _cnd_reset_timeout(condition *cnd){\r\n((cnd_timeout_dat*)cnd_get_user_data(cnd))->start_time = time(NULL);\r\n}\r\nstatic condition* _cnd_constr_capturesize(condition* cnd, va_list ap){\r\ncnd_capturesize_dat *data = NULL;\r\nif((data = (cnd_capturesize_dat*)g_malloc(sizeof(cnd_capturesize_dat))) == NULL)\r\nreturn NULL;\r\ndata->max_capture_size = va_arg(ap, guint64);\r\nif (data->max_capture_size > ((guint64)INT_MAX + 1))\r\ndata->max_capture_size = (guint64)INT_MAX + 1;\r\ncnd_set_user_data(cnd, (void*)data);\r\nreturn cnd;\r\n}\r\nstatic void _cnd_destr_capturesize(condition* cnd){\r\ng_free(cnd_get_user_data(cnd));\r\n}\r\nstatic gboolean _cnd_eval_capturesize(condition* cnd, va_list ap){\r\ncnd_capturesize_dat* data = (cnd_capturesize_dat*)cnd_get_user_data(cnd);\r\nif(data->max_capture_size == 0) return FALSE;\r\nif(va_arg(ap, guint64) >= data->max_capture_size){\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void _cnd_reset_capturesize(condition *cnd _U_){\r\n}

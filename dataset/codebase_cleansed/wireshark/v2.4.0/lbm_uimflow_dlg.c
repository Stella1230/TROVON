static void lbmc_uim_flow_graph_data_init(void)\r\n{\r\ndialog_data.graph_analysis = sequence_analysis_info_new();\r\ndialog_data.graph_analysis->type = SEQ_ANALYSIS_ANY;\r\ndialog_data.graph_analysis->all_packets = TRUE;\r\ndialog_data.graph_analysis->any_addr = TRUE;\r\n}\r\nstatic void lbmc_uim_flow_toggle_select_all_cb(GtkWidget * widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(dialog_data.select_all_radio_button)))\r\n{\r\ndialog_data.packet_select_type = select_all_packets;\r\n}\r\n}\r\nstatic void lbmc_uim_flow_toggle_select_displayed_cb(GtkWidget * widget _U_, gpointer user_data _U_)\r\n{\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(dialog_data.select_displayed_radio_button)))\r\n{\r\ndialog_data.packet_select_type = select_displayed_packets;\r\n}\r\n}\r\nstatic void lbmc_uim_flow_tap_reset(void * tap_data _U_)\r\n{\r\nif (dialog_data.graph_analysis != NULL)\r\n{\r\nsequence_analysis_list_free(dialog_data.graph_analysis);\r\n}\r\n}\r\nstatic int lbmc_uim_flow_graph_add_to_graph(packet_info * pinfo, const lbm_uim_stream_info_t * stream_info)\r\n{\r\nlbm_uim_stream_endpoint_t epa;\r\nlbm_uim_stream_endpoint_t epb;\r\nseq_analysis_item_t * item;\r\ngchar * ctxinst1;\r\ngchar * ctxinst2;\r\ngboolean swap_endpoints = FALSE;\r\nint rc;\r\nif (stream_info->endpoint_a.type != stream_info->endpoint_b.type)\r\n{\r\nreturn (1);\r\n}\r\nif (stream_info->endpoint_a.type == lbm_uim_instance_stream)\r\n{\r\nrc = memcmp((void *)stream_info->endpoint_a.stream_info.ctxinst.ctxinst,\r\n(void *)stream_info->endpoint_b.stream_info.ctxinst.ctxinst,\r\nLBM_CONTEXT_INSTANCE_BLOCK_SZ);\r\nif (rc <= 0)\r\n{\r\nswap_endpoints = FALSE;\r\n}\r\nelse\r\n{\r\nswap_endpoints = TRUE;\r\n}\r\n}\r\nelse\r\n{\r\nif (stream_info->endpoint_a.stream_info.dest.domain < stream_info->endpoint_b.stream_info.dest.domain)\r\n{\r\nswap_endpoints = FALSE;\r\n}\r\nelse if (stream_info->endpoint_a.stream_info.dest.domain > stream_info->endpoint_b.stream_info.dest.domain)\r\n{\r\nswap_endpoints = TRUE;\r\n}\r\nelse\r\n{\r\nint compare;\r\ncompare = cmp_address(&(stream_info->endpoint_a.stream_info.dest.addr), &(stream_info->endpoint_b.stream_info.dest.addr));\r\nif (compare < 0)\r\n{\r\nswap_endpoints = FALSE;\r\n}\r\nelse if (compare > 0)\r\n{\r\nswap_endpoints = TRUE;\r\n}\r\nelse\r\n{\r\nif (stream_info->endpoint_a.stream_info.dest.port <= stream_info->endpoint_b.stream_info.dest.port)\r\n{\r\nswap_endpoints = FALSE;\r\n}\r\nelse\r\n{\r\nswap_endpoints = TRUE;\r\n}\r\n}\r\n}\r\n}\r\nif (swap_endpoints == FALSE)\r\n{\r\nepa = stream_info->endpoint_a;\r\nepb = stream_info->endpoint_b;\r\n}\r\nelse\r\n{\r\nepb = stream_info->endpoint_a;\r\nepa = stream_info->endpoint_b;\r\n}\r\nitem = (seq_analysis_item_t *)g_malloc0(sizeof(seq_analysis_item_t));\r\ncopy_address(&(item->src_addr), &(pinfo->src));\r\ncopy_address(&(item->dst_addr), &(pinfo->dst));\r\nitem->frame_number = pinfo->num;\r\nitem->port_src = pinfo->srcport;\r\nitem->port_dst = pinfo->destport;\r\nitem->protocol = g_strdup(port_type_to_str(pinfo->ptype));\r\nif (stream_info->description == NULL)\r\n{\r\nitem->frame_label = g_strdup_printf("(%" G_GUINT32_FORMAT ")", stream_info->sqn);\r\n}\r\nelse\r\n{\r\nitem->frame_label = g_strdup_printf("%s (%" G_GUINT32_FORMAT ")", stream_info->description, stream_info->sqn);\r\n}\r\nif (epa.type == lbm_uim_instance_stream)\r\n{\r\nctxinst1 = bytes_to_str(pinfo->pool, epa.stream_info.ctxinst.ctxinst, sizeof(epa.stream_info.ctxinst.ctxinst));\r\nctxinst2 = bytes_to_str(pinfo->pool, epb.stream_info.ctxinst.ctxinst, sizeof(epb.stream_info.ctxinst.ctxinst));\r\nitem->comment = g_strdup_printf("%s <-> %s [%" G_GUINT64_FORMAT "]",\r\nctxinst1,\r\nctxinst2,\r\nstream_info->channel);\r\n}\r\nelse\r\n{\r\nitem->comment = g_strdup_printf("%" G_GUINT32_FORMAT ":%s:%" G_GUINT16_FORMAT " <-> %" G_GUINT32_FORMAT ":%s:%" G_GUINT16_FORMAT " [%" G_GUINT64_FORMAT "]",\r\nepa.stream_info.dest.domain,\r\naddress_to_str(pinfo->pool, &(epa.stream_info.dest.addr)),\r\nepa.stream_info.dest.port,\r\nepb.stream_info.dest.domain,\r\naddress_to_str(pinfo->pool, &(epb.stream_info.dest.addr)),\r\nepb.stream_info.dest.port,\r\nstream_info->channel);\r\n}\r\nitem->conv_num = (guint16)LBM_CHANNEL_ID(stream_info->channel);\r\nitem->display = TRUE;\r\nitem->line_style = 1;\r\ng_queue_push_tail(dialog_data.graph_analysis->items, item);\r\nreturn (1);\r\n}\r\nstatic gboolean lbmc_uim_flow_tap_packet(void * tap_data _U_, packet_info * pinfo, epan_dissect_t * edt _U_, const void * stream_info)\r\n{\r\nconst lbm_uim_stream_info_t * info = (const lbm_uim_stream_info_t *)stream_info;\r\nif ((dialog_data.packet_select_type == select_all_packets) || (pinfo->fd->flags.passed_dfilter == 1))\r\n{\r\nlbmc_uim_flow_graph_add_to_graph(pinfo, info);\r\nreturn (TRUE);\r\n}\r\nreturn (FALSE);\r\n}\r\nstatic void lbmc_uim_flow_tap_draw(void * tap_data _U_)\r\n{\r\nreturn;\r\n}\r\nstatic void lbmc_uim_flow_remove_tap_listener(void)\r\n{\r\nremove_tap_listener(&(dialog_data.tap_identifier));\r\ndialog_data.have_tap_listener = FALSE;\r\n}\r\nstatic void lbmc_uim_flow_graph_on_ok_cb(GtkButton * button _U_, gpointer user_data)\r\n{\r\nGList * list = NULL;\r\ngchar time_str[COL_MAX_LEN];\r\nif (dialog_data.have_tap_listener == TRUE)\r\n{\r\nlbmc_uim_flow_remove_tap_listener();\r\n}\r\nif (dialog_data.have_tap_listener == FALSE)\r\n{\r\nGString * err_msg;\r\nerr_msg = register_tap_listener("lbm_uim",\r\n&(dialog_data.tap_identifier),\r\nNULL,\r\nTL_REQUIRES_COLUMNS,\r\nlbmc_uim_flow_tap_reset,\r\nlbmc_uim_flow_tap_packet,\r\nlbmc_uim_flow_tap_draw);\r\nif (err_msg != NULL)\r\n{\r\nfprintf(stderr, "register_tap_listener: %s\n", err_msg->str);\r\ng_string_free(err_msg, TRUE);\r\n}\r\ndialog_data.have_tap_listener = TRUE;\r\n}\r\ncf_retap_packets(&cfile);\r\nlist = g_queue_peek_nth_link(dialog_data.graph_analysis->items, 0);\r\nwhile (list != NULL)\r\n{\r\nseq_analysis_item_t * seq_item = (seq_analysis_item_t *)list->data;\r\nset_fd_time(cfile.epan, frame_data_sequence_find(cfile.frames, seq_item->frame_number), time_str);\r\nseq_item->time_str = g_strdup(time_str);\r\nlist = g_list_next(list);\r\n}\r\nif (dialog_data.graph_analysis_data->dlg.window != NULL)\r\n{\r\ngraph_analysis_update(dialog_data.graph_analysis_data);\r\n}\r\nelse\r\n{\r\ndialog_data.graph_analysis_data->dlg.parent_w = (GtkWidget *)user_data;\r\ngraph_analysis_create(dialog_data.graph_analysis_data);\r\n}\r\n}\r\nstatic void lbmc_uim_flow_graph_on_destroy_cb(GtkWidget * widget _U_, gpointer user_data _U_)\r\n{\r\nlbmc_uim_flow_remove_tap_listener();\r\nlbmc_uim_flow_tap_reset(NULL);\r\ng_assert(dialog_data.graph_analysis != NULL);\r\ng_assert(dialog_data.graph_analysis_data != NULL);\r\nsequence_analysis_info_free(dialog_data.graph_analysis);\r\ndialog_data.graph_analysis = NULL;\r\ng_free(dialog_data.graph_analysis_data);\r\ndialog_data.graph_analysis_data = NULL;\r\ndialog_data.flow_graph_dialog = NULL;\r\n}\r\nstatic void lbmc_uim_flow_graph_dlg_create(void)\r\n{\r\nGtkWidget * flow_graph_dlg_w = NULL;\r\nGtkWidget * main_vb = NULL;\r\nGtkWidget * hbuttonbox = NULL;\r\nGtkWidget * bt_cancel = NULL;\r\nGtkWidget * bt_ok = NULL;\r\nGtkWidget * range_fr = NULL;\r\nGtkWidget * range_grid = NULL;\r\nflow_graph_dlg_w = dlg_window_new("Wireshark: UIM Flow Graph");\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(flow_graph_dlg_w), TRUE);\r\ngtk_window_set_default_size(GTK_WINDOW(flow_graph_dlg_w), 250, 150);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(flow_graph_dlg_w), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 7);\r\ngtk_widget_show(flow_graph_dlg_w);\r\nrange_fr = gtk_frame_new("Choose packets");\r\ngtk_box_pack_start(GTK_BOX(main_vb), range_fr, FALSE, FALSE, 5);\r\nrange_grid = ws_gtk_grid_new();\r\ngtk_container_set_border_width(GTK_CONTAINER(range_grid), 5);\r\ngtk_container_add(GTK_CONTAINER(range_fr), range_grid);\r\ndialog_data.select_all_radio_button = gtk_radio_button_new_with_mnemonic_from_widget(NULL, "_All packets");\r\ngtk_widget_set_tooltip_text(dialog_data.select_all_radio_button, ("Process all packets"));\r\ng_signal_connect(dialog_data.select_all_radio_button, "toggled", G_CALLBACK(lbmc_uim_flow_toggle_select_all_cb), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(range_grid), dialog_data.select_all_radio_button, 0, 0, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (dialog_data.packet_select_type == select_all_packets)\r\n{\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(dialog_data.select_all_radio_button), TRUE);\r\n}\r\ngtk_widget_show(dialog_data.select_all_radio_button);\r\ndialog_data.select_displayed_radio_button =\r\ngtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(dialog_data.select_all_radio_button), "_Displayed packets");\r\ngtk_widget_set_tooltip_text(dialog_data.select_displayed_radio_button, ("Process displayed packets"));\r\ng_signal_connect(dialog_data.select_displayed_radio_button, "toggled", G_CALLBACK(lbmc_uim_flow_toggle_select_displayed_cb), NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(range_grid), dialog_data.select_displayed_radio_button, 0, 1, 1, 1,\r\n(GtkAttachOptions)(GTK_FILL), (GtkAttachOptions)(0), 0, 0);\r\nif (dialog_data.packet_select_type == select_displayed_packets)\r\n{\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(dialog_data.select_displayed_radio_button), TRUE);\r\n}\r\ngtk_widget_show(dialog_data.select_displayed_radio_button);\r\ngtk_widget_show(range_grid);\r\ngtk_widget_show(range_fr);\r\nhbuttonbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), hbuttonbox, FALSE, FALSE, 5);\r\ngtk_button_box_set_layout(GTK_BUTTON_BOX(hbuttonbox), GTK_BUTTONBOX_SPREAD);\r\ngtk_box_set_spacing(GTK_BOX(hbuttonbox), 30);\r\nbt_ok = gtk_button_new_from_stock(GTK_STOCK_OK);\r\ngtk_container_add(GTK_CONTAINER(hbuttonbox), bt_ok);\r\ngtk_widget_set_tooltip_text(bt_ok, "Show the flow graph");\r\ng_signal_connect(bt_ok, "clicked", G_CALLBACK(lbmc_uim_flow_graph_on_ok_cb), flow_graph_dlg_w);\r\ngtk_widget_show(bt_ok);\r\nbt_cancel = gtk_button_new_from_stock(GTK_STOCK_CANCEL);\r\ngtk_container_add(GTK_CONTAINER(hbuttonbox), bt_cancel);\r\ngtk_widget_set_can_default(bt_cancel, TRUE);\r\ngtk_widget_set_tooltip_text(bt_cancel, "Cancel this dialog");\r\nwindow_set_cancel_button(flow_graph_dlg_w, bt_cancel, window_cancel_button_cb);\r\ng_signal_connect(flow_graph_dlg_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(flow_graph_dlg_w, "destroy", G_CALLBACK(lbmc_uim_flow_graph_on_destroy_cb), NULL);\r\ngtk_widget_show_all(flow_graph_dlg_w);\r\nwindow_present(flow_graph_dlg_w);\r\ndialog_data.flow_graph_dialog = flow_graph_dlg_w;\r\n}\r\nstatic void lbmc_uim_flow_graph_init_tap(const char * dummy _U_, void * user_data _U_)\r\n{\r\nif (dialog_data.flow_graph_dialog != NULL)\r\n{\r\ng_assert(dialog_data.graph_analysis != NULL);\r\ng_assert(dialog_data.graph_analysis_data != NULL);\r\nreactivate_window(dialog_data.flow_graph_dialog);\r\n}\r\nelse\r\n{\r\ng_assert(dialog_data.graph_analysis == NULL);\r\ng_assert(dialog_data.graph_analysis_data == NULL);\r\nlbmc_uim_flow_graph_data_init();\r\ndialog_data.graph_analysis_data = graph_analysis_init(dialog_data.graph_analysis);\r\nlbmc_uim_flow_graph_dlg_create();\r\n}\r\n}\r\nvoid lbmc_uim_flow_menu_cb(gpointer arg _U_)\r\n{\r\nlbmc_uim_flow_graph_init_tap("", NULL);\r\n}

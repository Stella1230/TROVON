static void save_stream_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\nrtpstream_save_dlg = NULL;\r\n}\r\nstatic gboolean save_stream_ok_cb(GtkWidget *ok_bt _U_, gpointer fs)\r\n{\r\ngchar *g_dest;\r\nif (!selected_stream_fwd) {\r\nreturn TRUE;\r\n}\r\ng_dest = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(fs));\r\nif (test_for_directory(g_dest) == EISDIR) {\r\nset_last_open_dir(g_dest);\r\ng_free(g_dest);\r\nfile_selection_set_current_folder((GtkWidget *)fs, get_last_open_dir());\r\ngtk_file_chooser_set_current_name((GtkFileChooser *)fs, "");\r\nreturn FALSE;\r\n}\r\n#if 0\r\nif (!rtpstream_save(&the_tapinfo_struct, &cfile, selected_stream_fwd, g_dest)) {\r\ng_free(g_dest);\r\nreturn;\r\n}\r\ng_free(g_dest);\r\nwindow_destroy(GTK_WIDGET(rtpstream_save_dlg));\r\nreturn;\r\n#else\r\nrtpstream_save(&the_tapinfo_struct, &cfile, selected_stream_fwd, g_dest);\r\ng_free(g_dest);\r\nreturn TRUE;\r\n#endif\r\n}\r\nstatic void\r\nrtpstream_on_destroy(GObject *object _U_, gpointer user_data _U_)\r\n{\r\nremove_tap_listener_rtp_stream(&the_tapinfo_struct);\r\nif (rtpstream_save_dlg != NULL)\r\nwindow_destroy(rtpstream_save_dlg);\r\nrtpstream_reset(rtpstream_dlg_get_tapinfo());\r\nrtp_stream_dlg = NULL;\r\n}\r\nstatic void\r\nrtpstream_on_unselect(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nGtkTreeSelection *selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(list));\r\ngtk_tree_selection_unselect_all(selection);\r\nselected_stream_fwd = NULL;\r\nselected_stream_rev = NULL;\r\ngtk_label_set_text(GTK_LABEL(label_fwd), FWD_LABEL_TEXT);\r\ngtk_label_set_text(GTK_LABEL(label_rev), REV_LABEL_TEXT);\r\n}\r\nstatic void\r\nrtpstream_on_findrev(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nGtkTreeSelection *selection;\r\nGList *path_list;\r\nGList *path_list_item = NULL;\r\nGtkTreePath *path = NULL;\r\nGtkTreePath *path_fwd = NULL;\r\nGtkTreePath *path_rev = NULL;\r\nGtkTreeIter iter;\r\nrtp_stream_info_t *stream = NULL;\r\ngboolean found_it = FALSE;\r\nif (selected_stream_fwd==NULL)\r\nreturn;\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(list));\r\npath_list = gtk_tree_selection_get_selected_rows(selection, NULL);\r\nif (path_list) {\r\npath_list_item = g_list_first(path_list);\r\npath = (GtkTreePath *)(path_list_item->data);\r\n}\r\nif (path && gtk_tree_model_get_iter(GTK_TREE_MODEL(list_store), &iter, path)) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, RTP_COL_DATA, &stream, -1);\r\nif (stream == selected_stream_fwd) {\r\npath_fwd = path;\r\n}\r\nif (stream == selected_stream_rev) {\r\npath_rev = path;\r\n}\r\n}\r\npath = NULL;\r\nif (path_list_item) {\r\npath_list_item = g_list_next(path_list_item);\r\nif (path_list_item)\r\npath = (GtkTreePath *)(path_list_item->data);\r\n}\r\nif (path && gtk_tree_model_get_iter(GTK_TREE_MODEL(list_store), &iter, path)) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, RTP_COL_DATA, &stream, -1);\r\nif (stream == selected_stream_fwd) {\r\npath_fwd = path;\r\n}\r\nif (stream == selected_stream_rev) {\r\npath_rev = path;\r\n}\r\n}\r\ngtk_tree_model_get_iter(GTK_TREE_MODEL(list_store), &iter, path_fwd);\r\nwhile (gtk_tree_model_iter_next(GTK_TREE_MODEL(list_store), &iter)) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, RTP_COL_DATA, &stream, -1);\r\nif (rtp_stream_info_is_reverse(selected_stream_fwd, stream)) {\r\nfound_it = TRUE;\r\nbreak;\r\n}\r\n};\r\nif (!found_it) {\r\ngtk_tree_model_get_iter_first(GTK_TREE_MODEL(list_store), &iter);\r\ndo {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, RTP_COL_DATA, &stream, -1);\r\nif (rtp_stream_info_is_reverse(selected_stream_fwd, stream)) {\r\nfound_it = TRUE;\r\nbreak;\r\n}\r\nif (stream == selected_stream_fwd)\r\nbreak;\r\n} while (gtk_tree_model_iter_next(GTK_TREE_MODEL(list_store), &iter));\r\n}\r\nif (found_it) {\r\nif (path_rev)\r\ngtk_tree_selection_unselect_path(selection, path_rev);\r\ngtk_tree_selection_select_iter(selection, &iter);\r\n}\r\ng_list_foreach(path_list, (GFunc)gtk_tree_path_free, NULL);\r\ng_list_free(path_list);\r\n}\r\nstatic void\r\nrtpstream_on_save(GtkButton *button _U_, gpointer data _U_)\r\n{\r\nif (!selected_stream_fwd) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Please select a forward stream");\r\nreturn;\r\n}\r\n#if 0\r\nif (rtpstream_save_dlg != NULL) {\r\nreactivate_window(rtpstream_save_dlg);\r\nreturn;\r\n}\r\n#endif\r\nrtpstream_save_dlg = gtk_file_chooser_dialog_new(\r\n"Wireshark: Save selected stream in rtpdump ('-F dump') format",\r\nGTK_WINDOW(rtp_stream_dlg), GTK_FILE_CHOOSER_ACTION_SAVE,\r\nGTK_STOCK_OK, GTK_RESPONSE_ACCEPT,\r\nGTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL,\r\nNULL);\r\ngtk_file_chooser_set_do_overwrite_confirmation(GTK_FILE_CHOOSER(rtpstream_save_dlg), TRUE);\r\ng_signal_connect(rtpstream_save_dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(rtpstream_save_dlg, "destroy", G_CALLBACK(save_stream_destroy_cb), NULL);\r\ngtk_widget_show(rtpstream_save_dlg);\r\nwindow_present(rtpstream_save_dlg);\r\n#if 0\r\nif (gtk_dialog_run(GTK_DIALOG(rtpstream_save_dlg)) == GTK_RESPONSE_ACCEPT){\r\nsave_stream_ok_cb(rtpstream_save_dlg, rtpstream_save_dlg);\r\n}else{\r\nwindow_destroy(rtpstream_save_dlg);\r\n}\r\n#endif\r\nwhile (gtk_dialog_run(GTK_DIALOG(rtpstream_save_dlg)) == GTK_RESPONSE_ACCEPT) {\r\nif (save_stream_ok_cb(NULL, rtpstream_save_dlg)) {\r\nbreak;\r\n}\r\n}\r\nwindow_destroy(rtpstream_save_dlg);\r\n}\r\nstatic void\r\nrtpstream_on_mark(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nif (selected_stream_fwd==NULL && selected_stream_rev==NULL)\r\nreturn;\r\nrtpstream_mark(&the_tapinfo_struct, &cfile, selected_stream_fwd, selected_stream_rev);\r\n}\r\nstatic void\r\nrtpstream_on_filter(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ngchar *filter_string = NULL;\r\ngchar *filter_string_fwd = NULL;\r\ngchar *filter_string_rev = NULL;\r\ngchar ip_version[3];\r\nchar *src_addr, *dst_addr;\r\nif (selected_stream_fwd==NULL && selected_stream_rev==NULL)\r\nreturn;\r\nif (selected_stream_fwd)\r\n{\r\nif (selected_stream_fwd->src_addr.type==AT_IPv6) {\r\ng_strlcpy(ip_version,"v6",sizeof(ip_version));\r\n} else {\r\nip_version[0] = '\0';\r\n}\r\nsrc_addr = (char*)address_to_str(NULL, &(selected_stream_fwd->src_addr));\r\ndst_addr = (char*)address_to_str(NULL, &(selected_stream_fwd->dest_addr));\r\nfilter_string_fwd = g_strdup_printf(\r\n"(ip%s.src==%s && udp.srcport==%u && ip%s.dst==%s && udp.dstport==%u && rtp.ssrc==0x%X)",\r\nip_version,\r\nsrc_addr,\r\nselected_stream_fwd->src_port,\r\nip_version,\r\ndst_addr,\r\nselected_stream_fwd->dest_port,\r\nselected_stream_fwd->ssrc);\r\nfilter_string = filter_string_fwd;\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\n}\r\nif (selected_stream_rev)\r\n{\r\nif (selected_stream_rev->src_addr.type==AT_IPv6) {\r\ng_strlcpy(ip_version,"v6",sizeof(ip_version));\r\n} else {\r\nip_version[0] = '\0';\r\n}\r\nsrc_addr = (char*)address_to_str(NULL, &(selected_stream_rev->src_addr));\r\ndst_addr = (char*)address_to_str(NULL, &(selected_stream_rev->dest_addr));\r\nfilter_string_rev = g_strdup_printf(\r\n"(ip%s.src==%s && udp.srcport==%u && ip%s.dst==%s && udp.dstport==%u && rtp.ssrc==0x%X)",\r\nip_version,\r\nsrc_addr,\r\nselected_stream_rev->src_port,\r\nip_version,\r\ndst_addr,\r\nselected_stream_rev->dest_port,\r\nselected_stream_rev->ssrc);\r\nfilter_string = filter_string_rev;\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\n}\r\nif ((selected_stream_fwd) && (selected_stream_rev))\r\n{\r\nfilter_string = g_strdup_printf("%s || %s", filter_string_fwd, filter_string_rev);\r\ng_free(filter_string_fwd);\r\ng_free(filter_string_rev);\r\n}\r\ngtk_entry_set_text(GTK_ENTRY(main_display_filter_widget), filter_string);\r\ng_free(filter_string);\r\n}\r\nstatic void\r\nrtpstream_on_copy_as_csv(GtkWindow *win _U_, gpointer data _U_)\r\n{\r\nGtkTreeViewColumn *column;\r\nconst gchar *title;\r\nGtkTreeIter iter;\r\nguint i,j;\r\ngchar *table_entry;\r\nguint table_entry_uint;\r\ngdouble table_entry_double;\r\nGString *CSV_str;\r\nGtkClipboard *cb;\r\nCSV_str = g_string_sized_new(240*(1+streams_nb));\r\nfor (j=0; j<NUM_COLS-1; j++) {\r\ncolumn = gtk_tree_view_get_column(GTK_TREE_VIEW(list), j);\r\ntitle = gtk_tree_view_column_get_title(column);\r\ng_string_append_printf(CSV_str, "\"%s\"", title);\r\nif (j<NUM_COLS-2) g_string_append(CSV_str, ",");\r\n}\r\ng_string_append(CSV_str,"\n");\r\nif (gtk_tree_model_get_iter_first(GTK_TREE_MODEL(list_store), &iter)) {\r\nfor (i=0; i<streams_nb; i++) {\r\nfor (j=0; j<NUM_COLS-1; j++) {\r\nif (gtk_tree_model_get_column_type(GTK_TREE_MODEL(list_store), j) == G_TYPE_UINT) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, j, &table_entry_uint, -1);\r\ng_string_append_printf(CSV_str, "\"%u\"", table_entry_uint);\r\n} else if (gtk_tree_model_get_column_type(GTK_TREE_MODEL(list_store), j) == G_TYPE_DOUBLE) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, j, &table_entry_double, -1);\r\ng_string_append_printf(CSV_str, "\"%f\"", table_entry_double);\r\n} else if (gtk_tree_model_get_column_type(GTK_TREE_MODEL(list_store), j) == G_TYPE_STRING) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, j, &table_entry, -1);\r\ng_string_append_printf(CSV_str, "\"%s\"", table_entry);\r\ng_free(table_entry);\r\n} else {\r\ng_assert_not_reached();\r\n}\r\nif (j<NUM_COLS-2) g_string_append(CSV_str,",");\r\n}\r\ng_string_append(CSV_str,"\n");\r\ngtk_tree_model_iter_next (GTK_TREE_MODEL(list_store),&iter);\r\n}\r\n}\r\ncb = gtk_clipboard_get(GDK_SELECTION_CLIPBOARD);\r\ngtk_clipboard_set_text(cb, CSV_str->str, (gint)CSV_str->len);\r\ng_string_free(CSV_str, TRUE);\r\n}\r\nstatic void\r\nrtpstream_on_analyse(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\naddress src_fwd;\r\nguint32 port_src_fwd = 0;\r\naddress dst_fwd;\r\nguint32 port_dst_fwd = 0;\r\nguint32 ssrc_fwd = 0;\r\naddress src_rev;\r\nguint32 port_src_rev = 0;\r\naddress dst_rev;\r\nguint32 port_dst_rev = 0;\r\nguint32 ssrc_rev = 0;\r\nif (!(selected_stream_fwd || selected_stream_rev))\r\n{\r\nreturn;\r\n}\r\nclear_address(&src_fwd);\r\nclear_address(&dst_fwd);\r\nclear_address(&src_rev);\r\nclear_address(&dst_rev);\r\nif (selected_stream_fwd) {\r\ncopy_address(&(src_fwd), &(selected_stream_fwd->src_addr));\r\nport_src_fwd = selected_stream_fwd->src_port;\r\ncopy_address(&(dst_fwd), &(selected_stream_fwd->dest_addr));\r\nport_dst_fwd = selected_stream_fwd->dest_port;\r\nssrc_fwd = selected_stream_fwd->ssrc;\r\n}\r\nif (selected_stream_rev) {\r\ncopy_address(&(src_rev), &(selected_stream_rev->src_addr));\r\nport_src_rev = selected_stream_rev->src_port;\r\ncopy_address(&(dst_rev), &(selected_stream_rev->dest_addr));\r\nport_dst_rev = selected_stream_rev->dest_port;\r\nssrc_rev = selected_stream_rev->ssrc;\r\n}\r\nrtp_analysis(\r\n&src_fwd,\r\nport_src_fwd,\r\n&dst_fwd,\r\nport_dst_fwd,\r\nssrc_fwd,\r\n&src_rev,\r\nport_src_rev,\r\n&dst_rev,\r\nport_dst_rev,\r\nssrc_rev\r\n);\r\n}\r\nstatic gboolean\r\nrtpstream_view_selection_func(GtkTreeSelection *selection, GtkTreeModel *model, GtkTreePath *path, gboolean path_currently_selected, gpointer userdata _U_)\r\n{\r\nGtkTreeIter iter;\r\ngint nb_selected;\r\nrtp_stream_info_t* selected_stream;\r\ngboolean result = TRUE;\r\ngchar label_text[80];\r\nchar *src_addr, *dst_addr;\r\nnb_selected = gtk_tree_selection_count_selected_rows(selection);\r\nif (gtk_tree_model_get_iter(model, &iter, path)) {\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &iter, RTP_COL_DATA, &selected_stream, -1);\r\nswitch (nb_selected)\r\n{\r\ncase 0:\r\n{\r\nif (path_currently_selected)\r\ng_print("Select: He, we've got a selected path while none is selected?\n");\r\nelse\r\nselected_stream_fwd = selected_stream;\r\nbreak;\r\n}\r\ncase 1:\r\n{\r\nif (path_currently_selected)\r\nif (selected_stream == selected_stream_fwd)\r\nselected_stream_fwd = NULL;\r\nelse\r\nselected_stream_rev = NULL;\r\nelse\r\nif (selected_stream == selected_stream_fwd)\r\ng_print("Select: He, this can't be. 1 not selected but equal to fwd\n");\r\nelse\r\nif (selected_stream_rev)\r\nselected_stream_fwd = selected_stream;\r\nelse\r\nselected_stream_rev = selected_stream;\r\nbreak;\r\n}\r\ncase 2:\r\n{\r\nif (path_currently_selected) {\r\nif (selected_stream == selected_stream_fwd)\r\nselected_stream_fwd = NULL;\r\nelse if (selected_stream == selected_stream_rev)\r\nselected_stream_rev = NULL;\r\nelse\r\ng_print("Select: He, this can't be. 2 selected but not equal to fwd or rev\n");\r\n}\r\nresult = path_currently_selected;\r\nbreak;\r\n}\r\ndefault:\r\n{\r\ng_print("Select: He, we're getting a too high selection count\n");\r\nresult = path_currently_selected;\r\n}\r\n}\r\n}\r\nif (selected_stream_fwd) {\r\nsrc_addr = address_to_display(NULL, &(selected_stream_fwd->src_addr));\r\ndst_addr = address_to_display(NULL, &(selected_stream_fwd->dest_addr));\r\ng_snprintf(label_text, sizeof(label_text), "Forward: %s:%u -> %s:%u, SSRC=0x%X",\r\nsrc_addr,\r\nselected_stream_fwd->src_port,\r\ndst_addr,\r\nselected_stream_fwd->dest_port,\r\nselected_stream_fwd->ssrc\r\n);\r\ngtk_label_set_text(GTK_LABEL(label_fwd), label_text);\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\n} else {\r\nif (selected_stream_rev)\r\ngtk_label_set_text(GTK_LABEL(label_fwd), FWD_ONLY_LABEL_TEXT);\r\nelse\r\ngtk_label_set_text(GTK_LABEL(label_fwd), FWD_LABEL_TEXT);\r\n}\r\nif (selected_stream_rev) {\r\nsrc_addr = address_to_display(NULL, &(selected_stream_rev->src_addr));\r\ndst_addr = address_to_display(NULL, &(selected_stream_rev->dest_addr));\r\ng_snprintf(label_text, sizeof(label_text), "Reverse: %s:%u -> %s:%u, SSRC=0x%X",\r\nsrc_addr,\r\nselected_stream_rev->src_port,\r\ndst_addr,\r\nselected_stream_rev->dest_port,\r\nselected_stream_rev->ssrc\r\n);\r\ngtk_label_set_text(GTK_LABEL(label_rev), label_text);\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\n} else {\r\ngtk_label_set_text(GTK_LABEL(label_rev), REV_LABEL_TEXT);\r\n}\r\nreturn result;\r\n}\r\nstatic void\r\nadd_to_list_store(rtp_stream_info_t* strinfo)\r\n{\r\ngchar label_text[256];\r\ngchar *data[NUM_COLS];\r\nguint32 expected;\r\ngint32 lost;\r\ndouble perc;\r\nint i;\r\nchar *savelocale;\r\ngchar *tmp_str;\r\nsavelocale = g_strdup(setlocale(LC_NUMERIC, NULL));\r\nsetlocale(LC_NUMERIC, "C");\r\ndata[0] = address_to_display(NULL, &(strinfo->src_addr));\r\ndata[1] = NULL;\r\ndata[2] = address_to_display(NULL, &(strinfo->dest_addr));\r\ndata[3] = NULL;\r\ndata[4] = wmem_strdup_printf(NULL, "0x%X", strinfo->ssrc);\r\nif (strinfo->payload_type_name != NULL) {\r\ndata[5] = wmem_strdup(NULL, strinfo->payload_type_name);\r\n} else {\r\ntmp_str = val_to_str_ext_wmem(NULL, strinfo->payload_type, &rtp_payload_type_short_vals_ext, "Unknown (%u)");\r\ndata[5] = wmem_strdup(NULL, tmp_str);\r\nwmem_free(NULL, tmp_str);\r\n}\r\ndata[6] = NULL;\r\nexpected = (strinfo->rtp_stats.stop_seq_nr + strinfo->rtp_stats.cycles*65536)\r\n- strinfo->rtp_stats.start_seq_nr + 1;\r\nlost = expected - strinfo->rtp_stats.total_nr;\r\nif (expected) {\r\nperc = (double)(lost*100)/(double)expected;\r\n} else {\r\nperc = 0;\r\n}\r\ndata[7] = wmem_strdup_printf(NULL, "%d (%.1f%%)", lost, perc);\r\ndata[8] = NULL;\r\ndata[9] = NULL;\r\ndata[10] = NULL;\r\nif (strinfo->problem)\r\ndata[11] = wmem_strdup(NULL, "X");\r\nelse\r\ndata[11] = wmem_strdup(NULL, "");\r\nsetlocale(LC_NUMERIC, savelocale);\r\ng_free(savelocale);\r\ngtk_list_store_append(list_store, &list_iter);\r\ngtk_list_store_set(list_store, &list_iter,\r\nRTP_COL_SRC_ADDR, data[0],\r\nRTP_COL_SRC_PORT, strinfo->src_port,\r\nRTP_COL_DST_ADDR, data[2],\r\nRTP_COL_DST_PORT, strinfo->dest_port,\r\nRTP_COL_SSRC, data[4],\r\nRTP_COL_PAYLOAD, data[5],\r\nRTP_COL_PACKETS, strinfo->packet_count,\r\nRTP_COL_LOST, data[7],\r\nRTP_COL_MAX_DELTA, strinfo->rtp_stats.max_delta,\r\nRTP_COL_MAX_JITTER, strinfo->rtp_stats.max_jitter,\r\nRTP_COL_MEAN_JITTER, strinfo->rtp_stats.mean_jitter,\r\nRTP_COL_PROBLEM, data[11],\r\nRTP_COL_DATA, strinfo,\r\n-1);\r\nfor (i = 0; i < NUM_COLS-1; i++)\r\nwmem_free(NULL, data[i]);\r\ng_snprintf(label_text, sizeof(label_text),\r\n"Detected %d RTP streams. Choose one for forward and reverse direction for analysis",\r\n++streams_nb);\r\ngtk_label_set_text(GTK_LABEL(top_label), label_text);\r\n}\r\nstatic void\r\ncreate_list_view(void)\r\n{\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeSortable *sortable;\r\nGtkTreeView *list_view;\r\nGtkTreeSelection *selection;\r\nlist_store = gtk_list_store_new(NUM_COLS,\r\nG_TYPE_STRING,\r\nG_TYPE_UINT,\r\nG_TYPE_STRING,\r\nG_TYPE_UINT,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_UINT,\r\nG_TYPE_STRING,\r\nG_TYPE_DOUBLE,\r\nG_TYPE_DOUBLE,\r\nG_TYPE_DOUBLE,\r\nG_TYPE_STRING,\r\nG_TYPE_POINTER\r\n);\r\nlist = gtk_tree_view_new_with_model(GTK_TREE_MODEL(list_store));\r\nlist_view = GTK_TREE_VIEW(list);\r\nsortable = GTK_TREE_SORTABLE(list_store);\r\ngtk_tree_view_set_fixed_height_mode(list_view, TRUE);\r\ngtk_tree_sortable_set_sort_column_id(sortable, RTP_COL_SRC_ADDR, GTK_SORT_ASCENDING);\r\ngtk_tree_view_set_headers_clickable(list_view, FALSE);\r\ng_object_unref(G_OBJECT(list_store));\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Src addr", renderer,\r\n"text", RTP_COL_SRC_ADDR,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_SRC_ADDR);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Src port", renderer,\r\n"text", RTP_COL_SRC_PORT,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_SRC_PORT);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Dst addr", renderer,\r\n"text", RTP_COL_DST_ADDR,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_DST_ADDR);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Dst port", renderer,\r\n"text", RTP_COL_DST_PORT,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_DST_PORT);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("SSRC", renderer,\r\n"text", RTP_COL_SSRC,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_SSRC);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 70);\r\ngtk_tree_view_column_set_fixed_width(column, 90);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Payload", renderer,\r\n"text", RTP_COL_PAYLOAD,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_PAYLOAD);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 80);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Packets", renderer,\r\n"text", RTP_COL_PACKETS,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_PACKETS);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 70);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Lost", renderer,\r\n"text", RTP_COL_LOST,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_LOST);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 90);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Max Delta (ms)", renderer,\r\n"text", RTP_COL_MAX_DELTA,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_MAX_DELTA);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 90);\r\ngtk_tree_view_column_set_fixed_width(column, 130);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Max Jitter (ms)", renderer,\r\n"text", RTP_COL_MAX_JITTER,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_MAX_JITTER);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 50);\r\ngtk_tree_view_column_set_fixed_width(column, 120);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Mean Jitter (ms)", renderer,\r\n"text", RTP_COL_MEAN_JITTER,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_MEAN_JITTER);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 50);\r\ngtk_tree_view_column_set_fixed_width(column, 130);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Pb?", renderer,\r\n"text", RTP_COL_PROBLEM,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, RTP_COL_PROBLEM);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 30);\r\ngtk_tree_view_column_set_fixed_width(column, 50);\r\ngtk_tree_view_append_column(list_view, column);\r\ngtk_tree_view_set_rules_hint(list_view, TRUE);\r\ngtk_tree_view_set_headers_clickable(list_view, TRUE);\r\nselection = gtk_tree_view_get_selection(list_view);\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_MULTIPLE);\r\ngtk_tree_selection_set_select_function(selection, rtpstream_view_selection_func, NULL, NULL);\r\n}\r\nstatic void\r\nrtpstream_dlg_create (void)\r\n{\r\nGtkWidget *rtpstream_dlg_w;\r\nGtkWidget *main_vb;\r\nGtkWidget *scrolledwindow;\r\nGtkWidget *hbuttonbox;\r\nGtkWidget *bt_unselect;\r\nGtkWidget *bt_findrev;\r\nGtkWidget *bt_save;\r\nGtkWidget *bt_mark;\r\nGtkWidget *bt_filter;\r\nGtkWidget *bt_analyze;\r\nGtkWidget *bt_close;\r\nGtkWidget *bt_copy;\r\nrtpstream_dlg_w = dlg_window_new("Wireshark: RTP Streams");\r\ngtk_window_set_default_size(GTK_WINDOW(rtpstream_dlg_w), 620, 400);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(rtpstream_dlg_w), main_vb);\r\ngtk_container_set_border_width (GTK_CONTAINER (main_vb), 12);\r\ntop_label = gtk_label_new ("Detected 0 RTP streams. Choose one for forward and reverse direction for analysis");\r\ngtk_box_pack_start (GTK_BOX (main_vb), top_label, FALSE, FALSE, 8);\r\nscrolledwindow = scrolled_window_new (NULL, NULL);\r\ngtk_box_pack_start (GTK_BOX (main_vb), scrolledwindow, TRUE, TRUE, 0);\r\ncreate_list_view();\r\ngtk_container_add(GTK_CONTAINER(scrolledwindow), list);\r\ngtk_widget_show(rtpstream_dlg_w);\r\nlabel_fwd = gtk_label_new (FWD_LABEL_TEXT);\r\ngtk_box_pack_start (GTK_BOX (main_vb), label_fwd, FALSE, FALSE, 0);\r\nlabel_rev = gtk_label_new (REV_LABEL_TEXT);\r\ngtk_box_pack_start (GTK_BOX (main_vb), label_rev, FALSE, FALSE, 0);\r\nhbuttonbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_box_pack_start (GTK_BOX (main_vb), hbuttonbox, FALSE, FALSE, 0);\r\ngtk_button_box_set_layout (GTK_BUTTON_BOX (hbuttonbox), GTK_BUTTONBOX_END);\r\ngtk_box_set_spacing (GTK_BOX (hbuttonbox), 0);\r\nbt_unselect = gtk_button_new_with_label ("Unselect");\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_unselect);\r\ngtk_widget_set_tooltip_text (bt_unselect, "Undo stream selection");\r\nbt_findrev = gtk_button_new_with_label ("Find Reverse");\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_findrev);\r\ngtk_widget_set_tooltip_text (bt_findrev, "Find the reverse stream matching the selected forward stream");\r\nbt_save = ws_gtk_button_new_from_stock(GTK_STOCK_SAVE_AS);\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_save);\r\ngtk_widget_set_tooltip_text (bt_save, "Save stream payload in rtpdump format");\r\nbt_mark = gtk_button_new_with_label ("Mark Packets");\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_mark);\r\ngtk_widget_set_tooltip_text (bt_mark, "Mark packets of the selected stream(s)");\r\nbt_filter = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_PREPARE_FILTER);\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_filter);\r\ngtk_widget_set_tooltip_text (bt_filter, "Prepare a display filter of the selected stream(s)");\r\nbt_copy = ws_gtk_button_new_from_stock(GTK_STOCK_COPY);\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_copy);\r\ngtk_widget_set_tooltip_text(bt_copy,\r\n"Copy all statistical values of this page to the clipboard in CSV (Comma Separated Values) format.");\r\nbt_analyze = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_ANALYZE);\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_analyze);\r\ngtk_widget_set_tooltip_text (bt_analyze, "Open an analyze window of the selected stream(s)");\r\nbt_close = ws_gtk_button_new_from_stock(GTK_STOCK_CLOSE);\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_close);\r\ngtk_widget_set_tooltip_text (bt_close, "Close this dialog");\r\ngtk_widget_set_can_default(bt_close, TRUE);\r\ng_signal_connect(bt_unselect, "clicked", G_CALLBACK(rtpstream_on_unselect), NULL);\r\ng_signal_connect(bt_findrev, "clicked", G_CALLBACK(rtpstream_on_findrev), NULL);\r\ng_signal_connect(bt_save, "clicked", G_CALLBACK(rtpstream_on_save), NULL);\r\ng_signal_connect(bt_mark, "clicked", G_CALLBACK(rtpstream_on_mark), NULL);\r\ng_signal_connect(bt_filter, "clicked", G_CALLBACK(rtpstream_on_filter), NULL);\r\ng_signal_connect(bt_copy, "clicked", G_CALLBACK(rtpstream_on_copy_as_csv), NULL);\r\ng_signal_connect(bt_analyze, "clicked", G_CALLBACK(rtpstream_on_analyse), NULL);\r\nwindow_set_cancel_button(rtpstream_dlg_w, bt_close, window_cancel_button_cb);\r\ng_signal_connect(rtpstream_dlg_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(rtpstream_dlg_w, "destroy", G_CALLBACK(rtpstream_on_destroy), NULL);\r\ngtk_widget_show_all(rtpstream_dlg_w);\r\nwindow_present(rtpstream_dlg_w);\r\nrtpstream_on_unselect(NULL, NULL);\r\nrtp_stream_dlg = rtpstream_dlg_w;\r\n}\r\nstatic void\r\nrtpstream_dlg_update(GList *list_lcl)\r\n{\r\nif (rtp_stream_dlg != NULL) {\r\ngtk_list_store_clear(list_store);\r\nstreams_nb = 0;\r\nlist_lcl = g_list_first(list_lcl);\r\nwhile (list_lcl)\r\n{\r\nadd_to_list_store((rtp_stream_info_t*)(list_lcl->data));\r\nlist_lcl = g_list_next(list_lcl);\r\n}\r\nrtpstream_on_unselect(NULL, NULL);\r\n}\r\nlast_list = list_lcl;\r\n}\r\nstatic void\r\nrtpstream_tap_reset(rtpstream_tapinfo_t *tapinfo _U_)\r\n{\r\nif (rtp_stream_dlg != NULL) {\r\ngtk_list_store_clear(list_store);\r\nstreams_nb = 0;\r\n}\r\n}\r\nstatic void\r\nrtpstream_tap_draw(rtpstream_tapinfo_t *tapinfo)\r\n{\r\nif (tapinfo) {\r\nrtpstream_dlg_update(tapinfo->strinfo_list);\r\n}\r\n}\r\nstatic void\r\nrtpstream_dlg_mark_packet(rtpstream_tapinfo_t *tapinfo _U_, frame_data *fd) {\r\nif (!fd) return;\r\ncf_mark_frame(&cfile, fd);\r\n}\r\nvoid rtpstream_dlg_show(GList *list_lcl)\r\n{\r\nif (rtp_stream_dlg != NULL) {\r\nreactivate_window(rtp_stream_dlg);\r\nif (list_lcl != last_list) {\r\nrtpstream_dlg_update(list_lcl);\r\n}\r\n}\r\nelse {\r\nrtpstream_dlg_create();\r\nrtpstream_dlg_update(list_lcl);\r\n}\r\n}\r\nvoid rtpstream_launch(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nconst char *filter = gtk_entry_get_text(GTK_ENTRY(main_display_filter_widget));\r\nregister_tap_listener_rtp_stream(&the_tapinfo_struct, filter);\r\nrtpstream_scan(&the_tapinfo_struct, &cfile, filter);\r\nrtpstream_dlg_show(the_tapinfo_struct.strinfo_list);\r\n}\r\nvoid\r\nregister_tap_listener_rtp_stream_dlg(void)\r\n{\r\n}\r\nrtpstream_tapinfo_t *rtpstream_dlg_get_tapinfo(void) {\r\nreturn &the_tapinfo_struct;\r\n}

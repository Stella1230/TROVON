static int\r\ndissect_ipars(tvbuff_t *tvb, packet_info *pinfo _U_ , proto_tree *tree, void* data _U_)\r\n{\r\nint bytes;\r\nguint8 ia = 0, ta = 0, cmd = 0, la = 0;\r\ntvbuff_t *next_tvb;\r\nint offset = 0;\r\ngchar *eom_msg;\r\neom_msg = (gchar *)wmem_alloc(wmem_packet_scope(), MAX_EOM_MSG_SIZE);\r\neom_msg[0] = 0;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "IPARS");\r\nif (tvb_captured_length_remaining(tvb, 0) >= 2 ) {\r\nia = tvb_get_guint8(tvb, 0) & 0x3f;\r\nta = tvb_get_guint8(tvb, 1) & 0x3f;\r\nif (ia == S1 && ta == S2) {\r\noffset = 2;\r\n}\r\n}\r\nif (tvb_captured_length_remaining(tvb, offset) >= 1) ia = tvb_get_guint8(tvb, offset + 0);\r\nif (tvb_captured_length_remaining(tvb, offset) >= 2) ta = tvb_get_guint8(tvb, offset + 1);\r\nif (ia == 0x83 || ia == 0x43 || ia == GA) {\r\nif (tvb_captured_length_remaining(tvb, offset) > 2) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Poll IA: %2.2X", ta);\r\n} else {\r\nif (tvb_captured_length_remaining(tvb, offset) >= 2 ) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "GoAhead NextIA (0x%2.2X)", ta);\r\n} else {\r\ncol_set_str(pinfo->cinfo, COL_INFO, "GoAhead NextIA");\r\n}\r\n}\r\n} else {\r\nia &= 0x3f;\r\nta &= 0x3f;\r\nif (ta == 0x20) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Reset IA: %2.2X", ia);\r\n}\r\nif (tvb_captured_length_remaining(tvb, offset) >= 3) cmd = tvb_get_guint8(tvb, offset + 2) & 0x3f;\r\nif (tvb_captured_length_remaining(tvb, offset) >= 4) la = tvb_get_guint8(tvb, offset + 3) & 0x3f;\r\nif (cmd == 0x1f && la == 0x38) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Please Resend - IA: %2.2X TA: %2.2X", ia, ta);\r\n} else if (cmd == 0x2a && la == 0x05) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unsolicited Msg Indicator - IA: %2.2X TA: %2.2X", ia, ta);\r\n} else {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Data Msg - IA: %2.2X TA: %2.2X", ia, ta);\r\n}\r\n}\r\nif (tree) {\r\nbytes = tvb_captured_length_remaining(tvb, 0);\r\nif (bytes > 0) {\r\nproto_tree *ipars_tree;\r\nproto_item *ti;\r\nia = tvb_get_guint8(tvb, 0) & 0x3f;\r\nti = proto_tree_add_protocol_format(tree, proto_ipars, tvb, 0, -1, "Ipars");\r\nipars_tree = proto_item_add_subtree(ti, ett_ipars);\r\nif (ia == 0x03) {\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb, 0, 1, "GoAhead Next IA");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "GoAhead");\r\nreturn tvb_captured_length(tvb);\r\n} else if (ia != S1) {\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb,\r\n0,\r\nbytes, "Unknown format - Data (%d byte%s)", bytes,\r\nplurality(bytes, "", "s"));\r\nreturn tvb_captured_length(tvb);\r\n}\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb, 0, 1, "S1");\r\nia = tvb_get_guint8(tvb, 1) & 0x3f;\r\nif (ia != S2) {\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb,\r\n0,\r\nbytes, "Unknown format - Data (%d byte%s)", bytes,\r\nplurality(bytes, "", "s"));\r\nreturn tvb_captured_length(tvb);\r\n}\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb, 1, 1, "S2");\r\nia = tvb_get_guint8(tvb, 2) & 0x3f;\r\nif (ia == GA) {\r\nia = tvb_get_guint8(tvb, 3) & 0x3f;\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb, 2, 2, "GoAhead IA: %2.2X", ia);\r\nipars_eomtype = tvb_get_guint8(tvb, 4) & 0x3f;\r\nswitch (ipars_eomtype) {\r\ncase EOMc: g_snprintf(eom_msg, MAX_EOM_MSG_SIZE, "EOMc"); break;\r\ncase EOMi: g_snprintf(eom_msg, MAX_EOM_MSG_SIZE, "EOMi"); break;\r\ncase EOMu: g_snprintf(eom_msg, MAX_EOM_MSG_SIZE, "EOMu"); break;\r\ncase EOMpb: g_snprintf(eom_msg, MAX_EOM_MSG_SIZE, "EOMpb"); break;\r\ndefault: g_snprintf(eom_msg, MAX_EOM_MSG_SIZE, "Unknown EOM type (0x%2.2X)", ia); break;\r\n}\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb, 4, 1, "%s", eom_msg);\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, tvb, 5, 1, "Good BCC");\r\n} else {\r\nnext_tvb = tvb_new_subset_remaining(tvb, 3);\r\nproto_tree_add_protocol_format(ipars_tree, proto_ipars, next_tvb,\r\n0,\r\nbytes, "Data (%d byte%s)", bytes,\r\nplurality(bytes, "", "s"));\r\nreturn tvb_captured_length(tvb);\r\n}\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_ipars(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_ipars,\r\n};\r\nproto_ipars = proto_register_protocol("International Passenger Airline Reservation System", "IPARS", "ipars");\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("ipars", dissect_ipars, proto_ipars);\r\n}

void\r\ncolor_display_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nif (colorize_win != NULL) {\r\nreactivate_window(colorize_win);\r\n} else {\r\ncolorize_win = colorize_dialog_new(NULL);\r\n}\r\n}\r\nvoid\r\ncolor_display_with_filter(char *filter)\r\n{\r\nif (colorize_win != NULL) {\r\nreactivate_window(colorize_win);\r\n} else {\r\ncolorize_win = colorize_dialog_new(filter);\r\n}\r\n}\r\nstatic void\r\ncount_this_select(gpointer filter_arg, gpointer counter_arg)\r\n{\r\ncolor_filter_t *colorf = (color_filter_t *)filter_arg;\r\nint * cnt = (int *)counter_arg;\r\nif (colorf->selected)\r\n(*cnt)++;\r\n}\r\nint color_selected_count(void)\r\n{\r\nint count = 0;\r\ng_slist_foreach(color_filter_edit_list, count_this_select, &count);\r\nreturn count;\r\n}\r\nvoid\r\ncolor_filter_add_cb(color_filter_t *colorf, gpointer user_data)\r\n{\r\nGtkWidget *color_filters = (GtkWidget*)user_data;\r\nadd_filter_to_list(colorf, color_filters, FALSE);\r\ngtk_widget_grab_focus(color_filters);\r\n}\r\nstatic GtkWidget*\r\ncolorize_dialog_new (char *filter)\r\n{\r\nGtkWidget *color_win;\r\nGtkWidget *dlg_vbox;\r\nGtkWidget *main_hbox;\r\nGtkWidget *ctrl_vbox;\r\nGtkWidget *order_fr;\r\nGtkWidget *order_vbox;\r\nGtkWidget *color_filter_up;\r\nGtkWidget *order_move_label;\r\nGtkWidget *color_filter_down;\r\nGtkWidget *list_fr;\r\nGtkWidget *list_vbox;\r\nGtkWidget *scrolledwindow1;\r\nGtkWidget *color_filters;\r\nGtkWidget *list_label;\r\nGtkWidget *edit_fr;\r\nGtkWidget *edit_vbox;\r\nGtkWidget *color_new;\r\nGtkWidget *color_edit;\r\nGtkWidget *color_enable;\r\nGtkWidget *color_disable;\r\nGtkWidget *color_delete;\r\nGtkWidget *manage_fr;\r\nGtkWidget *manage_vbox;\r\nGtkWidget *color_import;\r\nGtkWidget *color_export;\r\nGtkWidget *color_clear;\r\nGtkWidget *button_ok_hbox;\r\nGtkWidget *color_ok;\r\nGtkWidget *color_apply;\r\nGtkWidget *color_save;\r\nGtkWidget *color_cancel;\r\nGtkWidget *color_help;\r\nGtkListStore *store;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nGtkTreeSelection *selection;\r\nstatic const gchar *titles[] = { "Name", "String" };\r\ncolor_dlg_num_of_filters = 0;\r\ncolor_dlg_row_selected = -1;\r\ncolor_win = dlg_conf_window_new ("Wireshark: Coloring Rules");\r\ng_object_set_data(G_OBJECT(color_win), "color_win", color_win);\r\ngtk_window_set_default_size(GTK_WINDOW(color_win), DEF_WIDTH, DEF_HEIGHT * 2/3);\r\ndlg_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (dlg_vbox), 5);\r\ngtk_container_add (GTK_CONTAINER (color_win), dlg_vbox);\r\nmain_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start (GTK_BOX (dlg_vbox), main_hbox, TRUE, TRUE, 0);\r\nctrl_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_box_pack_start (GTK_BOX (main_hbox), ctrl_vbox, FALSE, FALSE, 0);\r\nedit_fr = gtk_frame_new("Edit");\r\ngtk_box_pack_start (GTK_BOX (ctrl_vbox), edit_fr, TRUE, TRUE, 0);\r\nedit_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, TRUE);\r\ngtk_container_set_border_width (GTK_CONTAINER (edit_vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(edit_fr), edit_vbox);\r\ncolor_new = ws_gtk_button_new_from_stock(GTK_STOCK_NEW);\r\ngtk_box_pack_start (GTK_BOX (edit_vbox), color_new, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_new, "Create a new filter at the top of the list");\r\ncolor_edit = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_EDIT);\r\ngtk_box_pack_start (GTK_BOX (edit_vbox), color_edit, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_edit, " If more than one filter is selected, edit the first selected one");\r\ngtk_widget_set_sensitive (color_edit, FALSE);\r\ncolor_enable = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_ENABLE);\r\ngtk_box_pack_start (GTK_BOX (edit_vbox), color_enable, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_enable, "Enable the selected filter(s)");\r\ngtk_widget_set_sensitive (color_enable, FALSE);\r\ncolor_disable = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISABLE);\r\ngtk_box_pack_start (GTK_BOX (edit_vbox), color_disable, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_disable, "Disable the selected filter(s)");\r\ngtk_widget_set_sensitive (color_disable, FALSE);\r\ncolor_delete = ws_gtk_button_new_from_stock(GTK_STOCK_DELETE);\r\ngtk_box_pack_start (GTK_BOX (edit_vbox), color_delete, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_delete, "Delete the selected filter(s)");\r\ngtk_widget_set_sensitive (color_delete, FALSE);\r\nmanage_fr = gtk_frame_new("Manage");\r\ngtk_box_pack_start (GTK_BOX (ctrl_vbox), manage_fr, TRUE, TRUE, 0);\r\nmanage_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, TRUE);\r\ngtk_container_set_border_width (GTK_CONTAINER (manage_vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(manage_fr), manage_vbox);\r\ncolor_import = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_IMPORT);\r\ngtk_box_pack_start (GTK_BOX (manage_vbox), color_import, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_import, "Load filters from a file and append them to the list");\r\ncolor_export = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_EXPORT);\r\ngtk_box_pack_start (GTK_BOX (manage_vbox), color_export, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_export, "Save all/selected filters to a file");\r\ncolor_clear = ws_gtk_button_new_from_stock(GTK_STOCK_CLEAR);\r\ngtk_box_pack_start(GTK_BOX (manage_vbox), color_clear, FALSE, FALSE, 5);\r\ngtk_widget_set_tooltip_text(color_clear, "Clear the filter list and revert to system-wide default filter set");\r\nlist_fr = gtk_frame_new("Filter");\r\ngtk_box_pack_start (GTK_BOX (main_hbox), list_fr, TRUE, TRUE, 0);\r\nlist_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (list_vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(list_fr), list_vbox);\r\nlist_label = gtk_label_new (("List is processed in order until match is found"));\r\ngtk_box_pack_start (GTK_BOX (list_vbox), list_label, FALSE, FALSE, 0);\r\nscrolledwindow1 = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(scrolledwindow1),\r\nGTK_SHADOW_IN);\r\ngtk_box_pack_start (GTK_BOX (list_vbox), scrolledwindow1, TRUE, TRUE, 0);\r\nstore = gtk_list_store_new(6,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_BOOLEAN,\r\nG_TYPE_POINTER);\r\ncolor_filters = tree_view_new(GTK_TREE_MODEL(store));\r\ng_object_unref(store);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes(titles[0], renderer,\r\n"text", 0,\r\n"foreground", 2,\r\n"background", 3,\r\n"strikethrough", 4,\r\nNULL);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(color_filters), column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes(titles[1], renderer,\r\n"text", 1,\r\n"foreground", 2,\r\n"background", 3,\r\n"strikethrough", 4,\r\nNULL);\r\ngtk_tree_view_column_set_fixed_width(column, 300);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(color_filters), column);\r\ngtk_tree_view_set_headers_visible(GTK_TREE_VIEW(color_filters), TRUE);\r\ngtk_tree_view_set_headers_clickable(GTK_TREE_VIEW(color_filters), FALSE);\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_MULTIPLE);\r\ngtk_container_add (GTK_CONTAINER (scrolledwindow1), color_filters);\r\norder_fr = gtk_frame_new("Order");\r\ngtk_box_pack_start (GTK_BOX (main_hbox), order_fr, FALSE, FALSE, 0);\r\norder_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, TRUE);\r\ngtk_container_set_border_width (GTK_CONTAINER (order_vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(order_fr), order_vbox);\r\ncolor_filter_up = ws_gtk_button_new_from_stock(GTK_STOCK_GO_UP);\r\ngtk_box_pack_start (GTK_BOX (order_vbox), color_filter_up, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(color_filter_up, "Move filter higher in list");\r\ngtk_widget_set_sensitive (color_filter_up, FALSE);\r\norder_move_label = gtk_label_new (("Move\nselected filter\nup or down"));\r\ngtk_box_pack_start (GTK_BOX (order_vbox), order_move_label, FALSE, FALSE, 0);\r\ncolor_filter_down = ws_gtk_button_new_from_stock(GTK_STOCK_GO_DOWN);\r\ngtk_box_pack_start (GTK_BOX (order_vbox), color_filter_down, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(color_filter_down, "Move filter lower in list");\r\ngtk_widget_set_sensitive (color_filter_down, FALSE);\r\nbutton_ok_hbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_SAVE, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start (GTK_BOX (dlg_vbox), button_ok_hbox, FALSE, FALSE, 5);\r\ncolor_ok = (GtkWidget *)g_object_get_data(G_OBJECT(button_ok_hbox), GTK_STOCK_OK);\r\ngtk_widget_set_tooltip_text(color_ok, "Apply the color filters to the display and close this dialog");\r\ncolor_apply = (GtkWidget *)g_object_get_data(G_OBJECT(button_ok_hbox), GTK_STOCK_APPLY);\r\ngtk_widget_set_tooltip_text(color_apply, "Apply the color filters to the display and keep this dialog open");\r\ncolor_save = (GtkWidget *)g_object_get_data(G_OBJECT(button_ok_hbox), GTK_STOCK_SAVE);\r\ngtk_widget_set_tooltip_text(color_save, "Save the color filters permanently and keep this dialog open");\r\ncolor_cancel = (GtkWidget *)g_object_get_data(G_OBJECT(button_ok_hbox), GTK_STOCK_CANCEL);\r\nwindow_set_cancel_button(color_win, color_cancel, color_cancel_cb);\r\ngtk_widget_set_tooltip_text(color_cancel, "Cancel changes done (since last \"Apply\") and close this dialog");\r\ncolor_help = (GtkWidget *)g_object_get_data(G_OBJECT(button_ok_hbox), GTK_STOCK_HELP);\r\ngtk_widget_set_tooltip_text(color_help, "Get help about this dialog");\r\ng_signal_connect(color_help, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_COLORING_RULES_DIALOG);\r\ngtk_widget_grab_default(color_ok);\r\ng_signal_connect(color_win, "destroy", G_CALLBACK(color_destroy_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_filter_up), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_filter_up, "clicked", G_CALLBACK(color_filter_up_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_filter_down), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_filter_down, "clicked", G_CALLBACK(color_filter_down_cb), NULL);\r\ng_signal_connect(selection, "changed", G_CALLBACK(remember_selected_row), color_filters);\r\ng_signal_connect(color_filters, "button_press_event", G_CALLBACK(color_filters_button_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_filters), COLOR_UP_LB, color_filter_up);\r\ng_object_set_data(G_OBJECT(color_filters), COLOR_DOWN_LB, color_filter_down);\r\ng_object_set_data(G_OBJECT(color_filters), COLOR_EDIT_LB, color_edit);\r\ng_object_set_data(G_OBJECT(color_filters), COLOR_ENABLE_LB, color_enable);\r\ng_object_set_data(G_OBJECT(color_filters), COLOR_DISABLE_LB, color_disable);\r\ng_object_set_data(G_OBJECT(color_filters), COLOR_DELETE_LB, color_delete);\r\ng_object_set_data(G_OBJECT(color_new), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_new, "clicked", G_CALLBACK(color_new_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_edit), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_edit, "clicked", G_CALLBACK(color_edit_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_enable), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_enable, "clicked", G_CALLBACK(color_disable_cb), FALSE);\r\ng_object_set_data(G_OBJECT(color_disable), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_disable, "clicked", G_CALLBACK(color_disable_cb), (gpointer)TRUE);\r\ng_object_set_data(G_OBJECT(color_delete), COLOR_EDIT_LB, color_edit);\r\ng_object_set_data(G_OBJECT(color_delete), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_delete, "clicked", G_CALLBACK(color_delete_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_import), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_import, "clicked", G_CALLBACK(color_import_cb), NULL);\r\ng_signal_connect(color_export, "clicked", G_CALLBACK(color_export_cb), NULL);\r\ng_object_set_data(G_OBJECT(color_clear), COLOR_FILTERS_CL, color_filters);\r\ng_signal_connect(color_clear, "clicked", G_CALLBACK(color_clear_cb), NULL);\r\ng_signal_connect(color_ok, "clicked", G_CALLBACK(color_ok_cb), NULL);\r\ng_signal_connect(color_apply, "clicked", G_CALLBACK(color_apply_cb), NULL);\r\ng_signal_connect(color_save, "clicked", G_CALLBACK(color_save_cb), NULL);\r\ng_signal_connect(color_win, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ngtk_widget_grab_focus(color_filters);\r\ncolor_filters_clone(color_filters, color_filter_add_cb);\r\ng_object_set_data(G_OBJECT(color_win), COLOR_FILTER_LIST, &color_filter_edit_list);\r\ngtk_widget_show_all(color_win);\r\nif(!prefs.gui_use_pref_save) {\r\ngtk_widget_hide(color_save);\r\n}\r\nwindow_present(color_win);\r\nif(filter){\r\ncreate_new_color_filter(GTK_BUTTON(color_new), filter);\r\n}\r\nreturn color_win;\r\n}\r\nstatic void move_this_row (GtkWidget *color_filters,\r\ngint filter_number,\r\ngint amount)\r\n{\r\ncolor_filter_t *colorf;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter1, iter2;\r\ngchar *name, *string, *fg_str, *bg_str;\r\ngboolean disabled;\r\ng_assert(amount == +1 || amount == -1);\r\ng_assert(amount == +1 || filter_number > 0);\r\ng_assert(amount == -1 || filter_number < color_dlg_num_of_filters - 1);\r\nrow_is_moving = TRUE;\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter1, NULL, filter_number);\r\ngtk_tree_model_iter_nth_child(model, &iter2, NULL, filter_number + amount);\r\ngtk_tree_model_get(model, &iter1, 0, &name, 1, &string,\r\n2, &fg_str, 3, &bg_str, 4, &disabled, 5, &colorf, -1);\r\ngtk_list_store_remove(GTK_LIST_STORE(model), &iter1);\r\nif (amount < 0)\r\ngtk_list_store_insert_before(GTK_LIST_STORE(model), &iter1, &iter2);\r\nelse\r\ngtk_list_store_insert_after(GTK_LIST_STORE(model), &iter1, &iter2);\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter1,\r\n0, name,\r\n1, string,\r\n2, fg_str,\r\n3, bg_str,\r\n4, disabled,\r\n5, colorf, -1);\r\ng_free(name);\r\ng_free(string);\r\ng_free(fg_str);\r\ng_free(bg_str);\r\nrow_is_moving = FALSE;\r\ngtk_widget_grab_focus(color_filters);\r\ngtk_tree_selection_select_iter(gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters)), &iter1);\r\ncolor_filter_edit_list = g_slist_remove(color_filter_edit_list, colorf);\r\ncolor_filter_edit_list = g_slist_insert(color_filter_edit_list, colorf, filter_number + amount);\r\n}\r\nstatic void\r\ncolor_filter_up_cb(GtkButton *button, gpointer user_data _U_)\r\n{\r\ngint amount;\r\ngint filter_number;\r\nGtkWidget * color_filters;\r\ncolor_filter_t *colorf;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\nGtkTreeSelection *sel;\r\namount = -1;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(button), COLOR_FILTERS_CL);\r\nfor (filter_number = 0; filter_number < color_dlg_num_of_filters; filter_number++)\r\n{\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, filter_number);\r\ngtk_tree_model_get(model, &iter, 5, &colorf, -1);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\nif (gtk_tree_selection_iter_is_selected(sel, &iter))\r\nmove_this_row (color_filters, filter_number, amount);\r\n}\r\n}\r\nstatic void\r\ncolor_filter_down_cb(GtkButton *button, gpointer user_data _U_)\r\n{\r\ngint amount;\r\ngint filter_number;\r\nGtkWidget * color_filters;\r\ncolor_filter_t *colorf;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\namount = +1;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(button), COLOR_FILTERS_CL);\r\nfor (filter_number = color_dlg_num_of_filters - 1; filter_number >= 0; filter_number--)\r\n{\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, filter_number);\r\ngtk_tree_model_get(model, &iter, 5, &colorf, -1);\r\nif (colorf->selected)\r\nmove_this_row (color_filters, filter_number, amount);\r\n}\r\n}\r\nstatic void remember_this_row (GtkTreeModel *model, GtkTreePath *path, GtkTreeIter *iter, gpointer arg)\r\n{\r\ngint *path_index;\r\ncolor_filter_t *colorf;\r\nstruct remember_data *data = (struct remember_data *)arg;\r\ngtk_tree_model_get(model, iter, 5, &colorf, -1);\r\ncolorf->selected = TRUE;\r\ndata->all_enabled &= (!colorf->disabled);\r\ndata->all_disabled &= colorf->disabled;\r\npath_index = gtk_tree_path_get_indices(path);\r\nif (path_index == NULL)\r\n{\r\nreturn;\r\n}\r\ncolor_dlg_row_selected = path_index[0];\r\nif (color_dlg_row_selected == 0)\r\ndata->first_selected = TRUE;\r\nif (color_dlg_row_selected == color_dlg_num_of_filters - 1)\r\ndata->last_selected = TRUE;\r\ndata->count++;\r\ngtk_tree_view_scroll_to_cell((GtkTreeView *)data->color_filters, path, NULL, FALSE, 0.0f, 0.0f);\r\n}\r\nstatic void\r\nclear_select_flag(gpointer filter_arg, gpointer arg _U_)\r\n{\r\ncolor_filter_t *colorf = (color_filter_t *)filter_arg;\r\ncolorf->selected = FALSE;\r\n}\r\nstatic void\r\nremember_selected_row(GtkTreeSelection *sel, gpointer color_filters)\r\n{\r\nGtkWidget *button;\r\nstruct remember_data data;\r\ndata.first_selected = data.last_selected = FALSE;\r\ndata.all_enabled = data.all_disabled = TRUE;\r\ndata.count = 0;\r\ndata.color_filters = color_filters;\r\ng_slist_foreach(color_filter_edit_list, clear_select_flag, NULL);\r\ngtk_tree_selection_selected_foreach(sel,remember_this_row, &data);\r\nif (data.count > 0)\r\n{\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_EDIT_LB);\r\ngtk_widget_set_sensitive (button, data.count == 1);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_ENABLE_LB);\r\ngtk_widget_set_sensitive (button, !data.all_enabled);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DISABLE_LB);\r\ngtk_widget_set_sensitive (button, !data.all_disabled);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DELETE_LB);\r\ngtk_widget_set_sensitive (button, TRUE);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_UP_LB);\r\ngtk_widget_set_sensitive(button, !data.first_selected);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DOWN_LB);\r\ngtk_widget_set_sensitive(button, !data.last_selected);\r\n}\r\nelse\r\n{\r\ncolor_dlg_row_selected = -1;\r\nif (!row_is_moving) {\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_UP_LB);\r\ngtk_widget_set_sensitive (button, FALSE);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DOWN_LB);\r\ngtk_widget_set_sensitive (button, FALSE);\r\n}\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_EDIT_LB);\r\ngtk_widget_set_sensitive (button, FALSE);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_ENABLE_LB);\r\ngtk_widget_set_sensitive (button, FALSE);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DISABLE_LB);\r\ngtk_widget_set_sensitive (button, FALSE);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DELETE_LB);\r\ngtk_widget_set_sensitive (button, FALSE);\r\n}\r\n}\r\nstatic void\r\ndestroy_edit_dialog_cb(gpointer filter_arg, gpointer dummy _U_)\r\n{\r\ncolor_filter_t *colorf = (color_filter_t *)filter_arg;\r\ncolor_edit_dlg_destroy((color_edit_dlg_info_t *)colorf->color_edit_dlg_info);\r\n}\r\nstatic void\r\ncolor_destroy_cb (GtkButton *button _U_,\r\ngpointer user_data _U_)\r\n{\r\ng_slist_foreach(color_filter_edit_list, destroy_edit_dialog_cb, NULL);\r\ncolor_filter_list_delete(&color_filter_edit_list);\r\ncolor_filter_list_delete(&color_filter_tmp_list);\r\ncolorize_win = NULL;\r\n}\r\nstatic void\r\nselect_row(GtkWidget *color_filters, int row)\r\n{\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkTreeSelection *sel;\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, row);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_selection_select_iter(sel, &iter);\r\n}\r\nstatic void\r\nadd_filter_to_list(gpointer filter_arg, gpointer list_arg, gboolean prepend)\r\n{\r\ncolor_filter_t *colorf = (color_filter_t *)filter_arg;\r\ngchar fg_str[14], bg_str[14];\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nif( strstr(colorf->filter_name,CONVERSATION_COLOR_PREFIX)==NULL) {\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(list_arg)));\r\nif (prepend) {\r\ngtk_list_store_prepend(store, &iter);\r\n} else {\r\ngtk_list_store_append(store, &iter);\r\n}\r\ng_snprintf(fg_str, sizeof(fg_str), "#%04X%04X%04X",\r\ncolorf->fg_color.red, colorf->fg_color.green, colorf->fg_color.blue);\r\ng_snprintf(bg_str, sizeof(bg_str), "#%04X%04X%04X",\r\ncolorf->bg_color.red, colorf->bg_color.green, colorf->bg_color.blue);\r\ngtk_list_store_set(store, &iter,\r\n0, colorf->filter_name,\r\n1, colorf->filter_text,\r\n2, fg_str,\r\n3, bg_str,\r\n4, colorf->disabled,\r\n5, colorf, -1);\r\nif (prepend) {\r\ncolor_filter_edit_list = g_slist_prepend(color_filter_edit_list, colorf);\r\n} else {\r\ncolor_filter_edit_list = g_slist_append(color_filter_edit_list, colorf);\r\n}\r\ncolor_dlg_num_of_filters++;\r\n} else {\r\ncolor_filter_tmp_list = g_slist_append(color_filter_tmp_list, colorf);\r\n}\r\n}\r\nstatic void\r\ncreate_new_color_filter(GtkButton *button, const char *filter)\r\n{\r\n#if GTK_CHECK_VERSION(3,0,0)\r\nGtkStyleContext *context;\r\nGdkRGBA *rgba_bg_color;\r\nGdkRGBA *rgba_fg_color;\r\n#else\r\nGtkStyle *style;\r\n#endif\r\ncolor_filter_t *colorf;\r\ncolor_t bg_color, fg_color;\r\nGtkWidget *color_filters;\r\nGtkTreeSelection *sel;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(button), COLOR_FILTERS_CL);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_selection_unselect_all (sel);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ncontext = gtk_widget_get_style_context (packet_list_get_widget());\r\ngtk_style_context_get (context, GTK_STATE_FLAG_NORMAL,\r\n"background-color", &rgba_bg_color,\r\nNULL);\r\ngtk_style_context_get (context, GTK_STATE_FLAG_NORMAL,\r\n"color", &rgba_fg_color,\r\nNULL);\r\ngdkRGBAcolor_to_color_t(&bg_color, rgba_bg_color);\r\ngdkRGBAcolor_to_color_t(&fg_color, rgba_fg_color);\r\ngdk_rgba_free (rgba_bg_color);\r\ngdk_rgba_free (rgba_fg_color);\r\n#else\r\nstyle = gtk_widget_get_style(packet_list_get_widget());\r\ngdkcolor_to_color_t(&bg_color, &style->base[GTK_STATE_NORMAL]);\r\ngdkcolor_to_color_t(&fg_color, &style->text[GTK_STATE_NORMAL]);\r\n#endif\r\ncolorf = color_filter_new("name", filter, &bg_color, &fg_color, FALSE);\r\nadd_filter_to_list(colorf, color_filters, TRUE);\r\nselect_row(color_filters, 0);\r\ncolor_edit_dlg_new(color_filters, TRUE );\r\ngtk_widget_grab_focus(color_filters);\r\n}\r\nstatic void\r\ncolor_new_cb(GtkButton *button, gpointer user_data _U_)\r\n{\r\ncreate_new_color_filter(button, "filter");\r\n}\r\nstatic void\r\ncolor_edit_cb(GtkButton *button, gpointer user_data _U_)\r\n{\r\nGtkWidget *color_filters;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(button), COLOR_FILTERS_CL);\r\ng_assert(color_dlg_row_selected != -1);\r\ncolor_edit_dlg_new(color_filters, FALSE );\r\n}\r\nstatic gboolean\r\ncolor_filters_button_cb(GtkWidget *list, GdkEventButton *event,\r\ngpointer data _U_)\r\n{\r\nif (event->type == GDK_2BUTTON_PRESS) {\r\ncolor_edit_dlg_new(list, FALSE);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\ncolor_disable_cb(GtkWidget *widget, gboolean action_disable)\r\n{\r\ngint filter_number;\r\nGtkWidget *button;\r\nGtkWidget * color_filters;\r\ncolor_filter_t *colorf;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\nGtkTreeSelection *sel;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(widget), COLOR_FILTERS_CL);\r\nfor (filter_number = 0; filter_number < color_dlg_num_of_filters; filter_number++)\r\n{\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, filter_number);\r\ngtk_tree_model_get(model, &iter, 5, &colorf, -1);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\nif (gtk_tree_selection_iter_is_selected(sel, &iter)) {\r\ncolorf->disabled = action_disable;\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter,\r\n4, action_disable, -1);\r\n}\r\n}\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_ENABLE_LB);\r\ngtk_widget_set_sensitive(button, action_disable);\r\nbutton = (GtkWidget *)g_object_get_data(G_OBJECT(color_filters), COLOR_DISABLE_LB);\r\ngtk_widget_set_sensitive(button, !action_disable);\r\n}\r\nvoid\r\ncolor_delete_single(gint row, GtkWidget *color_filters)\r\n{\r\ncolor_filter_t *colorf;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, row);\r\ngtk_tree_model_get(model, &iter, 5, &colorf, -1);\r\ngtk_list_store_remove(GTK_LIST_STORE(model), &iter);\r\ncolor_dlg_num_of_filters--;\r\ncolor_edit_dlg_destroy((color_edit_dlg_info_t *)colorf->color_edit_dlg_info);\r\ncolor_filter_edit_list = g_slist_remove(color_filter_edit_list, colorf);\r\ncolor_filter_delete(colorf);\r\ngtk_widget_grab_focus(color_filters);\r\n}\r\nstatic void\r\ncolor_delete_cb(GtkWidget *widget, gpointer user_data _U_)\r\n{\r\nGtkWidget *color_filters;\r\ngint row, num_filters;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkTreeSelection *sel;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(widget), COLOR_FILTERS_CL);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\nnum_filters = gtk_tree_model_iter_n_children(model, NULL);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\nfor (row = num_filters - 1; row >= 0; row--)\r\n{\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, row);\r\nif (gtk_tree_selection_iter_is_selected(sel, &iter))\r\ncolor_delete_single (row, color_filters);\r\n}\r\n}\r\nstatic void\r\ncolor_import_cb(GtkButton *button, gpointer data _U_)\r\n{\r\nGtkWidget *color_filters;\r\nGtkTreeSelection *sel;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(button), COLOR_FILTERS_CL);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_selection_unselect_all (sel);\r\nfile_color_import_cmd_cb(color_filters, &color_filter_edit_list);\r\n}\r\nstatic void\r\ncolor_export_cb(GtkButton *button, gpointer data _U_)\r\n{\r\nGtkWidget *color_filters;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(button), COLOR_FILTERS_CL);\r\nfile_color_export_cmd_cb(color_filters, color_filter_edit_list);\r\n}\r\nstatic void\r\ncolor_clear_cmd(GtkWidget *widget)\r\n{\r\nGtkWidget * color_filters;\r\ngchar* err_msg = NULL;\r\ncolor_filters = (GtkWidget *)g_object_get_data(G_OBJECT(widget), COLOR_FILTERS_CL);\r\nwhile (color_dlg_num_of_filters > 0)\r\n{\r\ncolor_delete_single (color_dlg_num_of_filters-1, color_filters);\r\n}\r\nif (!color_filters_read_globals(color_filters, &err_msg, color_filter_add_cb))\r\n{\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", err_msg);\r\ng_free(err_msg);\r\n}\r\n}\r\nvoid\r\ncolor_clear_cb(GtkWidget *widget, gpointer data _U_) {\r\nGtkWidget *msg_dialog;\r\ngint response;\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(gtk_widget_get_toplevel(widget)),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"Do you want to remove all your personal color settings?");\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\n"This will revert the color settings to global defaults.\n\n"\r\n"Are you really sure?");\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL);\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CLEAR, GTK_RESPONSE_ACCEPT);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_ACCEPT,\r\nGTK_RESPONSE_CANCEL,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog), GTK_RESPONSE_CANCEL);\r\nresponse = gtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\nswitch (response) {\r\ncase GTK_RESPONSE_ACCEPT:\r\ncolor_clear_cmd(widget);\r\nbreak;\r\ncase GTK_RESPONSE_CANCEL:\r\ncase GTK_RESPONSE_NONE:\r\ncase GTK_RESPONSE_DELETE_EVENT:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void\r\noverwrite_existing_colorfilters_cb(gpointer dialog _U_, gint btn, gpointer data _U_)\r\n{\r\ngchar* err_msg = NULL;\r\nswitch (btn) {\r\ncase(ESD_BTN_SAVE):\r\nif (!color_filters_write(color_filter_edit_list, &err_msg))\r\n{\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Could not open colorfilter file: %s", err_msg);\r\ng_free(err_msg);\r\n}\r\nelse\r\nprefs.unknown_colorfilters = FALSE;\r\nbreak;\r\ncase(ESD_BTN_DONT_SAVE):\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\n}\r\nstatic void\r\ncolorfilters_main_save(void)\r\n{\r\ngchar* err_msg = NULL;\r\nif (prefs.unknown_colorfilters) {\r\ngpointer dialog = simple_dialog(ESD_TYPE_CONFIRMATION, ESD_BTNS_SAVE_DONTSAVE,\r\n"Obsolete or unrecognized color filters have been detected. "\r\n"If this profile will be used with an older or nonstandard Wireshark version "\r\n"or one that includes a proprietary dissector plugin, click 'Continue "\r\n"without Saving' and save this profile under a different name.\n\n");\r\nsimple_dialog_set_cb(dialog, overwrite_existing_colorfilters_cb, NULL);\r\n} else {\r\nif (!color_filters_write(color_filter_edit_list, &err_msg)) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "Could not open filter file: %s", err_msg);\r\ng_free(err_msg);\r\n}\r\n}\r\n}\r\nstatic void\r\ncolor_ok_cb(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ncolor_apply_cb(button,user_data);\r\nwindow_destroy(colorize_win);\r\n}\r\nstatic void\r\ncolor_apply_cb(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ngchar* err_msg = NULL;\r\nif (!prefs.gui_use_pref_save)\r\ncolorfilters_main_save();\r\nif (!color_filters_apply(color_filter_tmp_list, color_filter_edit_list, &err_msg)) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", err_msg);\r\ng_free(err_msg);\r\n}\r\npacket_list_colorize_packets();\r\n}\r\nstatic void\r\ncolor_save_cb(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ncolorfilters_main_save();\r\n}\r\nstatic void\r\ncolor_cancel_cb(GtkWidget *widget _U_, gpointer user_data _U_)\r\n{\r\nwindow_destroy(colorize_win);\r\n}

static int\r\ndissect_text_lines(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nproto_tree *subtree;\r\nproto_item *ti;\r\ngint offset = 0, next_offset;\r\ngint len;\r\nhttp_message_info_t *message_info;\r\nconst char *data_name;\r\nint length = tvb_captured_length(tvb);\r\nif(length > 38){\r\nif (tvb_strncaseeql(tvb, 0, "<?xml", 5) == 0){\r\ncall_dissector(xml_handle, tvb, pinfo, tree);\r\nreturn length;\r\n}\r\n}\r\ndata_name = pinfo->match_string;\r\nif (! (data_name && data_name[0])) {\r\nmessage_info = (http_message_info_t *)data;\r\nif (message_info == NULL) {\r\ndata_name = NULL;\r\n} else {\r\ndata_name = message_info->media_str;\r\nif (! (data_name && data_name[0])) {\r\ndata_name = NULL;\r\n}\r\n}\r\n}\r\nif (data_name)\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "(%s)",\r\ndata_name);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_text_lines,\r\ntvb, 0, -1, ENC_NA);\r\nif (data_name)\r\nproto_item_append_text(ti, ": %s", data_name);\r\nsubtree = proto_item_add_subtree(ti, ett_text_lines);\r\nwhile (tvb_offset_exists(tvb, offset)) {\r\nlen = tvb_find_line_end(tvb, offset, -1, &next_offset, FALSE);\r\nif (len == -1)\r\nbreak;\r\nproto_tree_add_format_text(subtree, tvb, offset, next_offset - offset);\r\noffset = next_offset;\r\n}\r\n}\r\nreturn length;\r\n}\r\nvoid\r\nproto_register_text_lines(void)\r\n{\r\nstatic gint *ett[] = {\r\n&ett_text_lines,\r\n};\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_text_lines = proto_register_protocol(\r\n"Line-based text data",\r\n"Line-based text data",\r\n"data-text-lines");\r\nregister_dissector("data-text-lines", dissect_text_lines, proto_text_lines);\r\n}\r\nvoid\r\nproto_reg_handoff_text_lines(void)\r\n{\r\ndissector_handle_t text_lines_handle;\r\ntext_lines_handle = find_dissector("data-text-lines");\r\ndissector_add_string("media_type", "text/plain", text_lines_handle);\r\ndissector_add_string("media_type", "text/richtext", text_lines_handle);\r\ndissector_add_string("media_type", "text/enriched", text_lines_handle);\r\ndissector_add_string("media_type", "text/parameters", text_lines_handle);\r\ndissector_add_string("media_type", "text/html", text_lines_handle);\r\ndissector_add_string("media_type", "text/xml-external-parsed-entity", text_lines_handle);\r\ndissector_add_string("media_type", "text/css", text_lines_handle);\r\ndissector_add_string("media_type", "application/xml-external-parsed-entity", text_lines_handle);\r\ndissector_add_string("media_type", "text/javascript", text_lines_handle);\r\ndissector_add_string("media_type", "application/x-javascript", text_lines_handle);\r\ndissector_add_string("media_type", "application/x-tia-p25-issi", text_lines_handle);\r\ndissector_add_string("media_type", "application/x-tia-p25-sndcp", text_lines_handle);\r\ndissector_add_string("media_type", "application/x-ns-proxy-autoconfig", text_lines_handle);\r\ndissector_add_string("media_type", "text/vnd.sun.j2me.app-descriptor", text_lines_handle);\r\ndissector_add_string("media_type", "application/vnd.poc.refer-to", text_lines_handle);\r\ndissector_add_string("media_type", "application/vnd.drm.message", text_lines_handle);\r\ndissector_add_string("media_type", "application/x-wms-logplaystats", text_lines_handle);\r\ndissector_add_string("media_type", "application/x-rtsp-udp-packetpair", text_lines_handle);\r\nxml_handle = find_dissector_add_dependency("xml", proto_text_lines);\r\n}

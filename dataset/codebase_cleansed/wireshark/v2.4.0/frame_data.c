void\r\nframe_delta_abs_time(const struct epan_session *epan, const frame_data *fdata, guint32 prev_num, nstime_t *delta)\r\n{\r\nconst nstime_t *prev_abs_ts = (prev_num) ? epan_get_frame_ts(epan, prev_num) : NULL;\r\nif (prev_abs_ts) {\r\nnstime_delta(delta, &fdata->abs_ts, prev_abs_ts);\r\n} else {\r\nnstime_set_zero(delta);\r\n}\r\n}\r\nstatic gint\r\nframe_data_time_delta_compare(const struct epan_session *epan, const frame_data *fdata1, const frame_data *fdata2)\r\n{\r\nnstime_t del_cap_ts1, del_cap_ts2;\r\nframe_delta_abs_time(epan, fdata1, fdata1->num - 1, &del_cap_ts1);\r\nframe_delta_abs_time(epan, fdata2, fdata2->num - 1, &del_cap_ts2);\r\nreturn COMPARE_TS_REAL(del_cap_ts1, del_cap_ts2);\r\n}\r\nstatic gint\r\nframe_data_time_delta_rel_compare(const struct epan_session *epan, const frame_data *fdata1, const frame_data *fdata2)\r\n{\r\nnstime_t del_rel_ts1, del_rel_ts2;\r\nframe_delta_abs_time(epan, fdata1, fdata1->frame_ref_num, &del_rel_ts1);\r\nframe_delta_abs_time(epan, fdata2, fdata2->frame_ref_num, &del_rel_ts2);\r\nreturn COMPARE_TS_REAL(del_rel_ts1, del_rel_ts2);\r\n}\r\nstatic gint\r\nframe_data_time_delta_dis_compare(const struct epan_session *epan, const frame_data *fdata1, const frame_data *fdata2)\r\n{\r\nnstime_t del_dis_ts1, del_dis_ts2;\r\nframe_delta_abs_time(epan, fdata1, fdata1->prev_dis_num, &del_dis_ts1);\r\nframe_delta_abs_time(epan, fdata2, fdata2->prev_dis_num, &del_dis_ts2);\r\nreturn COMPARE_TS_REAL(del_dis_ts1, del_dis_ts2);\r\n}\r\ngint\r\nframe_data_compare(const struct epan_session *epan, const frame_data *fdata1, const frame_data *fdata2, int field)\r\n{\r\nswitch (field) {\r\ncase COL_NUMBER:\r\nreturn COMPARE_FRAME_NUM();\r\ncase COL_CLS_TIME:\r\nswitch (timestamp_get_type()) {\r\ncase TS_ABSOLUTE:\r\ncase TS_ABSOLUTE_WITH_YMD:\r\ncase TS_ABSOLUTE_WITH_YDOY:\r\ncase TS_UTC:\r\ncase TS_UTC_WITH_YMD:\r\ncase TS_UTC_WITH_YDOY:\r\ncase TS_EPOCH:\r\nreturn COMPARE_TS(abs_ts);\r\ncase TS_RELATIVE:\r\nreturn frame_data_time_delta_rel_compare(epan, fdata1, fdata2);\r\ncase TS_DELTA:\r\nreturn frame_data_time_delta_compare(epan, fdata1, fdata2);\r\ncase TS_DELTA_DIS:\r\nreturn frame_data_time_delta_dis_compare(epan, fdata1, fdata2);\r\ncase TS_NOT_SET:\r\nreturn 0;\r\n}\r\nreturn 0;\r\ncase COL_ABS_TIME:\r\ncase COL_ABS_YMD_TIME:\r\ncase COL_ABS_YDOY_TIME:\r\ncase COL_UTC_TIME:\r\ncase COL_UTC_YMD_TIME:\r\ncase COL_UTC_YDOY_TIME:\r\nreturn COMPARE_TS(abs_ts);\r\ncase COL_REL_TIME:\r\nreturn frame_data_time_delta_rel_compare(epan, fdata1, fdata2);\r\ncase COL_DELTA_TIME:\r\nreturn frame_data_time_delta_compare(epan, fdata1, fdata2);\r\ncase COL_DELTA_TIME_DIS:\r\nreturn frame_data_time_delta_dis_compare(epan, fdata1, fdata2);\r\ncase COL_PACKET_LENGTH:\r\nreturn COMPARE_NUM(pkt_len);\r\ncase COL_CUMULATIVE_BYTES:\r\nreturn COMPARE_NUM(cum_bytes);\r\n}\r\ng_return_val_if_reached(0);\r\n}\r\nvoid\r\nframe_data_init(frame_data *fdata, guint32 num,\r\nconst struct wtap_pkthdr *phdr, gint64 offset,\r\nguint32 cum_bytes)\r\n{\r\nfdata->pfd = NULL;\r\nfdata->num = num;\r\nfdata->pkt_len = phdr->len;\r\nfdata->cum_bytes = cum_bytes + phdr->len;\r\nfdata->cap_len = phdr->caplen;\r\nfdata->file_off = offset;\r\nfdata->subnum = 0;\r\ng_assert(phdr->pkt_encap <= G_MAXINT16);\r\nfdata->flags.passed_dfilter = 0;\r\nfdata->flags.dependent_of_displayed = 0;\r\nfdata->flags.encoding = PACKET_CHAR_ENC_CHAR_ASCII;\r\nfdata->flags.visited = 0;\r\nfdata->flags.marked = 0;\r\nfdata->flags.ref_time = 0;\r\nfdata->flags.ignored = 0;\r\nfdata->flags.has_ts = (phdr->presence_flags & WTAP_HAS_TS) ? 1 : 0;\r\nfdata->flags.has_phdr_comment = (phdr->opt_comment != NULL);\r\nfdata->flags.has_user_comment = 0;\r\nfdata->flags.need_colorize = 0;\r\nfdata->tsprec = (gint16)phdr->pkt_tsprec;\r\nfdata->color_filter = NULL;\r\nfdata->abs_ts = phdr->ts;\r\nfdata->shift_offset.secs = 0;\r\nfdata->shift_offset.nsecs = 0;\r\nfdata->frame_ref_num = 0;\r\nfdata->prev_dis_num = 0;\r\n}\r\nvoid\r\nframe_data_set_before_dissect(frame_data *fdata,\r\nnstime_t *elapsed_time,\r\nconst frame_data **frame_ref,\r\nconst frame_data *prev_dis)\r\n{\r\nnstime_t rel_ts;\r\nif (*frame_ref == NULL)\r\n*frame_ref = fdata;\r\nif(fdata->flags.ref_time)\r\n*frame_ref = fdata;\r\nnstime_delta(&rel_ts, &fdata->abs_ts, &(*frame_ref)->abs_ts);\r\nif ((gint32)elapsed_time->secs < rel_ts.secs\r\n|| ((gint32)elapsed_time->secs == rel_ts.secs && (gint32)elapsed_time->nsecs < rel_ts.nsecs)) {\r\n*elapsed_time = rel_ts;\r\n}\r\nfdata->frame_ref_num = (*frame_ref != fdata) ? (*frame_ref)->num : 0;\r\nfdata->prev_dis_num = (prev_dis) ? prev_dis->num : 0;\r\n}\r\nvoid\r\nframe_data_set_after_dissect(frame_data *fdata,\r\nguint32 *cum_bytes)\r\n{\r\nif(fdata->flags.ref_time){\r\n*cum_bytes = fdata->pkt_len;\r\nfdata->cum_bytes = *cum_bytes;\r\n} else {\r\n*cum_bytes += fdata->pkt_len;\r\nfdata->cum_bytes = *cum_bytes;\r\n}\r\n}\r\nvoid\r\nframe_data_reset(frame_data *fdata)\r\n{\r\nfdata->flags.visited = 0;\r\nfdata->subnum = 0;\r\nif (fdata->pfd) {\r\ng_slist_free(fdata->pfd);\r\nfdata->pfd = NULL;\r\n}\r\n}\r\nvoid\r\nframe_data_destroy(frame_data *fdata)\r\n{\r\nif (fdata->pfd) {\r\ng_slist_free(fdata->pfd);\r\nfdata->pfd = NULL;\r\n}\r\n}

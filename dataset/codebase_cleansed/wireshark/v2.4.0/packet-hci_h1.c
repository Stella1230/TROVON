static gint\r\ndissect_hci_h1(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nguint8 type;\r\ntvbuff_t *next_tvb;\r\nproto_item *ti = NULL;\r\nproto_tree *hci_h1_tree = NULL;\r\nbluetooth_data_t *bluetooth_data;\r\nbluetooth_data = (bluetooth_data_t *) data;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "HCI");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nDISSECTOR_ASSERT(bluetooth_data->previous_protocol_data_type == BT_PD_BTHCI);\r\ntype = bluetooth_data->previous_protocol_data.bthci->channel;\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_hci_h1, tvb, 0, 0, ENC_NA);\r\nhci_h1_tree = proto_item_add_subtree(ti, ett_hci_h1);\r\nif(pinfo->p2p_dir == P2P_DIR_SENT ||\r\npinfo->p2p_dir == P2P_DIR_RECV)\r\nproto_item_append_text(hci_h1_tree, " %s %s",\r\nval_to_str(pinfo->p2p_dir,\r\nhci_h1_direction_vals, "Unknown: %d"),\r\nval_to_str(type,\r\nhci_h1_type_vals,\r\n"Unknown 0x%02x"));\r\nelse\r\nproto_item_append_text(hci_h1_tree, " %s",\r\nval_to_str(type,\r\nhci_h1_type_vals,\r\n"Unknown 0x%02x"));\r\n}\r\nif(pinfo->p2p_dir == P2P_DIR_SENT ||\r\npinfo->p2p_dir == P2P_DIR_RECV)\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s %s",\r\nval_to_str(pinfo->p2p_dir,\r\nhci_h1_direction_vals, "Unknown: %d"),\r\nval_to_str(type, hci_h1_type_vals,\r\n"Unknown 0x%02x"));\r\nelse\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s",\r\nval_to_str(type, hci_h1_type_vals,\r\n"Unknown 0x%02x"));\r\nti = proto_tree_add_int(hci_h1_tree, hf_hci_h1_direction, tvb, 0, 0, pinfo->p2p_dir);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 0);\r\nif (!dissector_try_uint_new(hci_h1_table, type, next_tvb, pinfo, tree, TRUE, bluetooth_data)) {\r\ncall_data_dissector(next_tvb, pinfo, tree);\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_hci_h1(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_hci_h1_direction,\r\n{ "Direction", "hci_h1.direction",\r\nFT_INT8, BASE_DEC, VALS(hci_h1_direction_vals), 0x0,\r\n"HCI Packet Direction Sent/Rcvd/Unknown", HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_hci_h1,\r\n};\r\nproto_hci_h1 = proto_register_protocol("Bluetooth HCI H1",\r\n"HCI_H1", "hci_h1");\r\nhci_h1_handle = register_dissector("hci_h1", dissect_hci_h1, proto_hci_h1);\r\nproto_register_field_array(proto_hci_h1, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nhci_h1_table = register_dissector_table("hci_h1.type",\r\n"HCI h1 pdu type", proto_hci_h1, FT_UINT8, BASE_HEX);\r\n}\r\nvoid\r\nproto_reg_handoff_hci_h1(void)\r\n{\r\ndissector_add_uint("bluetooth.encap", WTAP_ENCAP_BLUETOOTH_HCI, hci_h1_handle);\r\n}

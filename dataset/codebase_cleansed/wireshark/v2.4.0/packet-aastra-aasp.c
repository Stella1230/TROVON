static void\r\ndissect_a_binary_command(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_item *ti;\r\nproto_tree *subtree;\r\nconst guint8* pstr;\r\nguint i, len;\r\nti = proto_tree_add_item(tree, hf_a_cmd, tvb, 0, -1, ENC_NA);\r\nsubtree = proto_item_add_subtree(ti, ett_a_cmd);\r\nproto_item_append_text(ti, ", %s", val_to_str(tvb_get_guint8(tvb, 0), szCmdID, "Unk %d"));\r\nproto_tree_add_item(subtree, hf_a_id, tvb, 0, 1, ENC_BIG_ENDIAN);\r\nswitch(tvb_get_guint8(tvb, 0))\r\n{\r\ndefault:\r\n{\r\nif(tvb_reported_length(tvb) > 1)\r\nproto_tree_add_item(subtree, hf_a_data, tvb, 1, -1, ENC_NA);\r\nbreak;\r\n}\r\ncase CONTEXT_INFO:\r\n{\r\nfor(i = 1; i<tvb_reported_length(tvb); )\r\n{\r\nswitch(tvb_get_guint8(tvb, i))\r\n{\r\ndefault: i = tvb_reported_length(tvb); continue;\r\ncase 1:\r\ncase 3:\r\ncase 7:\r\n{\r\nti = proto_tree_add_item(subtree, hf_a_attr, tvb, i, 2, ENC_NA);\r\nproto_item_append_text(ti, " %d", tvb_get_guint8(tvb, i));\r\ni+=2; break;\r\n}\r\ncase 0:\r\ncase 4:\r\n{\r\nti = proto_tree_add_item(subtree, hf_a_attr, tvb, i, 3, ENC_NA);\r\nproto_item_append_text(ti, " %d", tvb_get_guint8(tvb, i));\r\ni+=3; break;\r\n}\r\ncase 2:\r\n{\r\nti = proto_tree_add_item(subtree, hf_a_attr, tvb, i, 5, ENC_NA);\r\nproto_item_append_text(ti, " %d", tvb_get_guint8(tvb, i));\r\ni+=5; break;\r\n}\r\n}\r\n}\r\nbreak;\r\n}\r\ncase BUTTON_PRESSED:\r\n{\r\nguint8 c = tvb_get_guint8(tvb, 5);\r\nproto_item_append_text(ti, ": %d '%c'", c, c);\r\nproto_tree_add_item(subtree, hf_a_data, tvb, 1, 4, ENC_NA);\r\nti = proto_tree_add_item(subtree, hf_a_button_id, tvb, 5, 1, ENC_BIG_ENDIAN);\r\nif(ti)\r\nproto_item_append_text(ti, " '%c'", c);\r\nbreak;\r\n}\r\ncase SET_TEXT:\r\n{\r\nif(tvb_reported_length(tvb) > 3)\r\n{\r\nproto_tree_add_item(subtree, hf_a_data, tvb, 1, 3, ENC_NA);\r\nproto_tree_add_item(subtree, hf_a_length, tvb, 4, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subtree, hf_a_text, tvb, 5, -1, ENC_ASCII|ENC_NA);\r\npstr = tvb_get_string_enc(wmem_packet_scope(), tvb, 5, tvb_get_guint8(tvb, 4), ENC_ASCII|ENC_NA);\r\nif(pstr)\r\n{\r\nproto_item_append_text(ti, ": '%s'", pstr);\r\n}\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(subtree, hf_a_data, tvb, 1, -1, ENC_NA);\r\n}\r\nbreak;\r\n}\r\ncase DATE_TIME_INFO:\r\n{\r\nproto_tree *infotree;\r\nfor(i=1; i<tvb_reported_length(tvb); )\r\n{\r\nswitch(tvb_get_guint8(tvb, i))\r\n{\r\ndefault: i++; break;\r\ncase 1:\r\n{\r\nlen = 2;\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_day, tvb, i+1, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Day: '%d'", tvb_get_guint8(tvb, i+1));\r\ni += len;\r\nbreak;\r\n}\r\ncase 2:\r\n{\r\nlen = 2;\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_month, tvb, i+1, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Month: '%d'", tvb_get_guint8(tvb, i+1));\r\ni += len;\r\nbreak;\r\n}\r\ncase 3:\r\n{\r\nlen = 2;\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_weekofyear, tvb, i+1, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Week of the year: '%d'", tvb_get_guint8(tvb, i+1));\r\ni += len;\r\nbreak;\r\n}\r\ncase 4:\r\n{\r\nlen = tvb_get_guint8(tvb, i+1);\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len+2, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_data, tvb, i+2, len, ENC_NA);\r\ni += len +2;\r\nbreak;\r\n}\r\ncase 5:\r\n{\r\nlen = tvb_get_guint8(tvb, i+1);\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len+2, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item_ret_string(infotree, hf_a_weekday, tvb, i+2, len, ENC_ASCII|ENC_NA, wmem_packet_scope(), &pstr);\r\nif(pstr)\r\nproto_item_append_text(ti, ", Weekday: '%s'", pstr);\r\ni += len +2;\r\nbreak;\r\n}\r\ncase 6:\r\n{\r\nlen = tvb_get_guint8(tvb, i+1);\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len+2, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item_ret_string(infotree, hf_a_month_name, tvb, i+2, len, ENC_ASCII|ENC_NA, wmem_packet_scope(), &pstr);\r\nif(pstr)\r\nproto_item_append_text(ti, ", Month name: '%s'", pstr);\r\ni += len +2;\r\nbreak;\r\n}\r\ncase 7:\r\n{\r\nlen = tvb_get_guint8(tvb, i+1);\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len+2, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item_ret_string(infotree, hf_a_weekofyear_prefix, tvb, i+2, len, ENC_ASCII|ENC_NA, wmem_packet_scope(), &pstr);\r\nif(pstr)\r\nproto_item_append_text(ti, ", Week of the year prefix: '%s'", pstr);\r\ni += len +2;\r\nbreak;\r\n}\r\ncase 8:\r\n{\r\nlen = 2;\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_hour, tvb, i+1, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Hour: '%d'", tvb_get_guint8(tvb, i+1));\r\ni += len;\r\nbreak;\r\n}\r\ncase 9:\r\n{\r\nlen = 2;\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_minute, tvb, i+1, 1, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, ", Minute: '%d'", tvb_get_guint8(tvb, i+1));\r\ni += len;\r\nbreak;\r\n}\r\ncase 10:\r\n{\r\nlen = 2;\r\nti = proto_tree_add_item(subtree, hf_a_item, tvb, i, len, ENC_NA);\r\ninfotree = proto_item_add_subtree(ti, ett_a_item);\r\nproto_tree_add_item(infotree, hf_a_data, tvb, i+1, 1, ENC_NA);\r\ni += len;\r\nbreak;\r\n}\r\n}\r\n}\r\nbreak;\r\n}\r\ncase DO_COMMAND:\r\n{\r\nif(tvb_reported_length(tvb) > 1)\r\n{\r\nproto_tree_add_item(subtree, hf_a_line, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subtree, hf_a_length, tvb, 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subtree, hf_a_cdpn, tvb, 3, -1, ENC_ASCII|ENC_NA);\r\npstr = tvb_get_string_enc(wmem_packet_scope(), tvb, 3, tvb_get_guint8(tvb, 2), ENC_ASCII|ENC_NA);\r\nif(pstr)\r\nproto_item_append_text(ti, ": '%s'", pstr);\r\n}\r\nelse\r\nproto_item_append_text(ti, ": ???");\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic guint searchNext(tvbuff_t *tvb, guint begin, guint end)\r\n{\r\nfor(; begin < end; begin++)\r\n{\r\nif(tvb_get_guint8(tvb, begin) & 0x80)\r\nreturn begin;\r\n}\r\nreturn end;\r\n}\r\nstatic int\r\ndissect_aasp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nproto_item *ti; proto_tree *aasp_tree; guint n;\r\nn = tvb_reported_length(tvb);\r\nif(n < 3) return 0;\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncol_append_str(pinfo->cinfo, COL_PROTOCOL, "/AASP");\r\nif(tree)\r\n{\r\nguint i, prev;\r\nti = proto_tree_add_item(tree, proto_aasp, tvb, 0, -1, ENC_NA);\r\naasp_tree = proto_item_add_subtree(ti, ett_aasp);\r\nif(tvb_memeql(tvb, 0, "a=", 2) == 0)\r\n{\r\nprev = 2;\r\nfor(i=2; i<n;)\r\n{\r\nswitch(tvb_get_guint8(tvb, i))\r\n{\r\n#if 0\r\ncase CONTEXT_INFO:\r\n{\r\nswitch(tvb_get_guint8(tvb, i+2))\r\n{\r\ncase 0x00: i += 11; break;\r\ncase 0x02: i += 8; break;\r\n}\r\nbreak;\r\n}\r\n#endif\r\ndefault:\r\ni = searchNext(tvb, i+1, n);\r\nbreak;\r\n}\r\ndissect_a_binary_command(tvb_new_subset_length(tvb, prev, i-prev), pinfo, aasp_tree);\r\nprev = i;\r\n}\r\n}\r\nelse\r\n{\r\nproto_tree_add_item(aasp_tree, hf_a_text, tvb, 0, -1, ENC_ASCII|ENC_NA);\r\n}\r\n}\r\nreturn n;\r\n}\r\nvoid\r\nproto_register_aasp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_a_data,\r\n{ "Data", "aasp.bin.data", FT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_cmd,\r\n{ "Bin Cmd", "aasp.a", FT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_id,\r\n{ "ID", "aasp.a.id", FT_UINT8, BASE_DEC, VALS(szCmdID), 0, NULL, HFILL }},\r\n{ &hf_a_length,\r\n{ "Length", "aasp.bin.length", FT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_text,\r\n{ "Text", "aasp.bin.text", FT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_line,\r\n{ "Line", "aasp.bin.line", FT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_cdpn,\r\n{ "CDPN", "aasp.bin.cdpn", FT_STRING, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_button_id,\r\n{ "Button ID", "aasp.bin.btnid", FT_UINT8, BASE_HEX_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_attr,\r\n{ "Attribute", "aasp.a.attr", FT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_item,\r\n{ "Info item", "aasp.bin.infoitem", FT_NONE, BASE_NONE, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_hour,\r\n{ "Hour", "aasp.bin.hour", FT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_minute,\r\n{ "Minute", "aasp.bin.minute", FT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_day,\r\n{ "Day", "aasp.bin.day", FT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_month,\r\n{ "Month", "aasp.bin.month", FT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL }},\r\n{ &hf_a_weekofyear,\r\n{ "Week of the year", "aasp.bin.weekofyear", FT_UINT8, BASE_DEC, NULL, 0,\r\n"Week number in the year", HFILL }},\r\n{ &hf_a_weekday,\r\n{ "Weekday", "aasp.bin.weekday", FT_STRING, BASE_NONE, NULL, 0,\r\n"Short weekday name in the PBX current language", HFILL }},\r\n{ &hf_a_month_name,\r\n{ "Month name", "aasp.bin.monthname", FT_STRING, BASE_NONE, NULL, 0,\r\n"Short month name in the PBX current language", HFILL }},\r\n{ &hf_a_weekofyear_prefix,\r\n{ "Week of the year prefix", "aasp.bin.weekofyearprefix", FT_STRING, BASE_NONE, NULL, 0,\r\n"Precedes the number on the screen which is the week number in year", HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_aasp,\r\n&ett_a_cmd,\r\n&ett_a_item,\r\n};\r\nproto_aasp = proto_register_protocol("Aastra Signalling Protocol", "AASP", "aasp");\r\nproto_register_field_array(proto_aasp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_aasp(void)\r\n{\r\ndissector_handle_t aasp_handle;\r\naasp_handle = create_dissector_handle(dissect_aasp, proto_aasp);\r\ndissector_add_string("media_type", "message/x-aasp-signalling", aasp_handle);\r\n}

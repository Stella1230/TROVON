static int dissect_mac_mgmt_msg_reg_rsp_decoder(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0;\r\nguint tlv_offset;\r\nguint tvb_len;\r\nproto_item *reg_rsp_item;\r\nproto_tree *reg_rsp_tree;\r\nproto_item *tlv_item = NULL;\r\nproto_tree *tlv_tree = NULL;\r\nproto_tree *sub_tree = NULL;\r\ngboolean hmac_found = FALSE;\r\ntlv_info_t tlv_info;\r\ngint tlv_type;\r\nguint tlv_len;\r\nguint this_offset = 0;\r\ntlv_info_t sub_tlv_info;\r\ngint sub_tlv_type;\r\ngint sub_tlv_len;\r\nguint sub_tlv_offset;\r\n{\r\ntvb_len = tvb_reported_length(tvb);\r\nreg_rsp_item = proto_tree_add_protocol_format(tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tvb_len, "MAC Management Message, REG-RSP");\r\nreg_rsp_tree = proto_item_add_subtree(reg_rsp_item, ett_mac_mgmt_msg_reg_rsp_decoder);\r\nproto_tree_add_item(reg_rsp_tree, hf_reg_rsp_status, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nwhile (offset < tvb_len)\r\n{\r\ninit_tlv_info(&tlv_info, tvb, offset);\r\ntlv_type = get_tlv_type(&tlv_info);\r\ntlv_len = get_tlv_length(&tlv_info);\r\nif (tlv_type == -1 || tlv_len > MAX_TLV_LEN || tlv_len < 1)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "REG-RSP TLV error");\r\nproto_tree_add_item(reg_rsp_tree, hf_reg_invalid_tlv, tvb, offset, (tvb_len - offset), ENC_NA);\r\nbreak;\r\n}\r\ntlv_offset = offset + get_tlv_value_offset(&tlv_info);\r\nswitch (tlv_type) {\r\ncase REG_ARQ_PARAMETERS:\r\ncase REG_SS_MGMT_SUPPORT:\r\ncase REG_IP_MGMT_MODE:\r\ncase REG_IP_VERSION:\r\ncase REG_UL_TRANSPORT_CIDS_SUPPORTED:\r\ncase REG_IP_PHS_SDU_ENCAP:\r\ncase REG_MAX_CLASSIFIERS_SUPPORTED:\r\ncase REG_PHS_SUPPORT:\r\ncase REG_ARQ_SUPPORT:\r\ncase REG_DSX_FLOW_CONTROL:\r\ncase REG_MCA_FLOW_CONTROL:\r\ncase REG_MCAST_POLLING_CIDS:\r\ncase REG_NUM_DL_TRANS_CID:\r\ncase REG_MAC_ADDRESS:\r\n#ifdef WIMAX_16E_2005\r\ncase REG_TLV_T_20_MAX_MAC_DATA_PER_FRAME_SUPPORT:\r\ncase REG_TLV_T_21_PACKING_SUPPORT:\r\ncase REG_TLV_T_22_MAC_EXTENDED_RTPS_SUPPORT:\r\ncase REG_TLV_T_23_MAX_NUM_BURSTS_TRANSMITTED_CONCURRENTLY_TO_THE_MS:\r\ncase REG_TLV_T_26_METHOD_FOR_ALLOCATING_IP_ADDR_SECONDARY_MGMNT_CONNECTION:\r\ncase REG_TLV_T_27_HANDOVER_SUPPORTED:\r\ncase REG_TLV_T_29_HO_PROCESS_OPTIMIZATION_MS_TIMER:\r\ncase REG_TLV_T_31_MOBILITY_FEATURES_SUPPORTED:\r\ncase REG_TLV_T_40_ARQ_ACK_TYPE:\r\ncase REG_TLV_T_41_MS_HO_CONNECTIONS_PARAM_PROCESSING_TIME:\r\ncase REG_TLV_T_42_MS_HO_TEK_PROCESSING_TIME:\r\ncase REG_TLV_T_43_MAC_HEADER_AND_EXTENDED_SUBHEADER_SUPPORT:\r\ncase REG_POWER_SAVING_CLASS_CAPABILITY:\r\n#endif\r\ndissect_extended_tlv(reg_rsp_tree, tlv_type, tvb, tlv_offset, tlv_len, pinfo, offset, proto_mac_mgmt_msg_reg_rsp_decoder);\r\nbreak;\r\ncase REG_RSP_SECONDARY_MGMT_CID:\r\nadd_tlv_subtree(&tlv_info, reg_rsp_tree, hf_reg_rsp_secondary_mgmt_cid, tvb, offset, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase REG_RSP_TLV_T_36_TOTAL_PROVISIONED_SERVICE_FLOW_DSAs:\r\nadd_tlv_subtree(&tlv_info, reg_rsp_tree, hf_reg_total_provisioned_sf, tvb, offset, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase REG_RSP_TLV_T_24_CID_UPDATE_ENCODINGS:\r\nsub_tree = add_protocol_subtree(&tlv_info, ett_reg_rsp_message_tree, reg_rsp_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tlv_len, "CID update encodings");\r\nthis_offset = tlv_offset;\r\nwhile(this_offset < tlv_len) {\r\ninit_tlv_info(&sub_tlv_info, tvb, this_offset);\r\nsub_tlv_type = get_tlv_type(&sub_tlv_info);\r\nsub_tlv_len = get_tlv_length(&sub_tlv_info);\r\nif (tlv_type == -1 || sub_tlv_len > MAX_TLV_LEN || sub_tlv_len < 1)\r\n{\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "REG-RSP TLV error");\r\nproto_tree_add_item(reg_rsp_tree, hf_reg_invalid_tlv, tvb, offset, (tvb_len - offset), ENC_NA);\r\nbreak;\r\n}\r\nsub_tlv_offset = this_offset + get_tlv_value_offset(&sub_tlv_info);\r\nswitch (sub_tlv_type) {\r\ncase REG_RSP_TLV_T_24_1_CID_UPDATE_ENCODINGS_NEW_CID:\r\nadd_tlv_subtree(&sub_tlv_info, sub_tree, hf_reg_rsp_new_cid_after_ho, tvb, this_offset, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase REG_RSP_TLV_T_24_2_CID_UPDATE_ENCODINGS_SFID:\r\nadd_tlv_subtree(&sub_tlv_info, sub_tree, hf_reg_rsp_service_flow_id, tvb, this_offset, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase REG_RSP_TLV_T_24_3_CID_UPDATE_ENCODINGS_CONNECTION_INFO:\r\ntlv_tree = add_protocol_subtree(&sub_tlv_info, ett_reg_rsp_message_tree, sub_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, this_offset, sub_tlv_len, "CID Update Encodings Connection Info");\r\ncall_dissector(dsc_rsp_handle, tvb_new_subset_length(tvb, sub_tlv_offset, sub_tlv_len), pinfo, tlv_tree);\r\nbreak;\r\ndefault:\r\nadd_tlv_subtree(&sub_tlv_info, sub_tree, hf_tlv_type, tvb, this_offset, ENC_NA);\r\nbreak;\r\n}\r\nthis_offset = sub_tlv_len + sub_tlv_offset;\r\n}\r\nbreak;\r\ncase REG_RSP_TLV_T_28_HO_SYSTEM_RESOURCE_RETAIN_TIME:\r\ntlv_item = add_tlv_subtree(&tlv_info, reg_rsp_tree, hf_reg_rsp_system_resource_retain_time, tvb, offset, ENC_BIG_ENDIAN);\r\nif (include_cor2_changes) {\r\nproto_item_append_text(tlv_item, " (in units of 100 milliseconds)");\r\n} else {\r\nproto_item_append_text(tlv_item, " (multiple of 100 milliseconds)");\r\n}\r\nbreak;\r\ncase DSx_UPLINK_FLOW:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_reg_rsp_decoder, reg_rsp_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tlv_len, "Uplink Service Flow Encodings");\r\nwimax_service_flow_encodings_decoder(tvb_new_subset_length(tvb, tlv_offset, tlv_len), pinfo, tlv_tree);\r\nbreak;\r\ncase DSx_DOWNLINK_FLOW:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_reg_rsp_decoder, reg_rsp_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tlv_len, "Downlink Service Flow Encodings");\r\nwimax_service_flow_encodings_decoder(tvb_new_subset_length(tvb, tlv_offset, tlv_len), pinfo, tlv_tree);\r\nbreak;\r\ncase HMAC_TUPLE:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_reg_rsp_decoder, reg_rsp_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tlv_len, "HMAC Tuple");\r\nwimax_hmac_tuple_decoder(tlv_tree, tvb, offset+2, tlv_len);\r\nhmac_found = TRUE;\r\nbreak;\r\ncase CMAC_TUPLE:\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_reg_rsp_decoder, reg_rsp_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tlv_len, "CMAC Tuple");\r\nwimax_cmac_tuple_decoder(tlv_tree, tvb, offset+2, tlv_len);\r\nbreak;\r\ncase SHORT_HMAC_TUPLE:\r\ncase SHORT_HMAC_TUPLE_COR2:\r\nif ((!include_cor2_changes && (tlv_type == SHORT_HMAC_TUPLE)) ||\r\n(include_cor2_changes && (tlv_type == SHORT_HMAC_TUPLE_COR2))) {\r\ntlv_tree = add_protocol_subtree(&tlv_info, ett_mac_mgmt_msg_reg_rsp_decoder, reg_rsp_tree, proto_mac_mgmt_msg_reg_rsp_decoder, tvb, offset, tlv_len, "Short HMAC Tuple");\r\nwimax_short_hmac_tuple_decoder(tlv_tree, tvb, tlv_offset, tlv_len);\r\n} else {\r\nadd_tlv_subtree(&tlv_info, reg_rsp_tree, hf_tlv_type, tvb, offset, ENC_NA);\r\n}\r\nbreak;\r\ncase VENDOR_SPECIFIC_INFO:\r\ncase VENDOR_ID_ENCODING:\r\ncase MAC_VERSION_ENCODING:\r\nwimax_common_tlv_encoding_decoder(tvb_new_subset_length(tvb, offset, (tvb_len - offset)), pinfo, reg_rsp_tree);\r\nbreak;\r\ndefault:\r\nadd_tlv_subtree(&tlv_info, reg_rsp_tree, hf_tlv_type, tvb, offset, ENC_NA);\r\nbreak;\r\n}\r\noffset = tlv_len + tlv_offset;\r\n}\r\nif (!hmac_found)\r\nproto_item_append_text(reg_rsp_tree, " (HMAC Tuple is missing !)");\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_mac_mgmt_msg_reg_rsp(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{\r\n&hf_reg_invalid_tlv,\r\n{\r\n"Invalid TLV", "wmx.reg_rsp.invalid_tlv",\r\nFT_BYTES, BASE_NONE, NULL, 0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_reg_rsp_new_cid_after_ho,\r\n{\r\n"New CID after handover to new BS", "wmx.reg_rsp.new_cid_after_ho",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_reg_rsp_status,\r\n{\r\n"Response", "wmx.reg_rsp.response",\r\nFT_UINT8, BASE_HEX, VALS(vals_reg_rsp_status), 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_reg_rsp_secondary_mgmt_cid,\r\n{\r\n"Secondary Management CID", "wmx.reg_rsp.secondary_mgmt_cid",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_reg_total_provisioned_sf,\r\n{\r\n"Total Number of Provisional Service Flow", "wmx.reg_rsp.total_provisional_sf",\r\nFT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_reg_rsp_service_flow_id,\r\n{\r\n"Service flow ID", "wmx.reg_rsp.service_flow_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_reg_rsp_system_resource_retain_time,\r\n{\r\n"System Resource Retain Time", "wmx.reg_rsp.system_resource_retain_time",\r\nFT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_tlv_type,\r\n{\r\n"Unknown TLV Type", "wmx.reg_rsp.unknown_tlv_type",\r\nFT_BYTES, BASE_NONE, NULL, 0x00, NULL, HFILL\r\n}\r\n},\r\n#if 0\r\n{\r\n&hf_tlv_value,\r\n{\r\n"Value", "wmx.reg_rsp.tlv_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x00, NULL, HFILL\r\n}\r\n}\r\n#endif\r\n};\r\nstatic gint *ett[] =\r\n{\r\n&ett_mac_mgmt_msg_reg_rsp_decoder,\r\n&ett_reg_rsp_message_tree\r\n};\r\nproto_mac_mgmt_msg_reg_rsp_decoder = proto_register_protocol (\r\n"WiMax REG-RSP Messages",\r\n"WiMax REG-RSP",\r\n"wmx.reg_rsp"\r\n);\r\nproto_register_field_array(proto_mac_mgmt_msg_reg_rsp_decoder, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("mac_mgmt_msg_reg_rsp_handler", dissect_mac_mgmt_msg_reg_rsp_decoder, -1);\r\n}\r\nvoid proto_reg_handoff_mac_mgmt_msg_reg_rsp(void)\r\n{\r\ndissector_handle_t reg_rsp_handle;\r\ndsc_rsp_handle = find_dissector("mac_mgmt_msg_dsc_rsp_handler");\r\nreg_rsp_handle = create_dissector_handle(dissect_mac_mgmt_msg_reg_rsp_decoder, proto_mac_mgmt_msg_reg_rsp_decoder);\r\ndissector_add_uint("wmx.mgmtmsg", MAC_MGMT_MSG_REG_RSP, reg_rsp_handle);\r\n}

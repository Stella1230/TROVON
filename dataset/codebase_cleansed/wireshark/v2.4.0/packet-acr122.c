static void\r\nduration_base(gchar *buf, guint32 value) {\r\ng_snprintf(buf, ITEM_LABEL_LENGTH, "%u.%03u s", value * 100 / 1000, value * 100 % 1000);\r\n}\r\nstatic void\r\ntimeout_base(gchar *buf, guint32 value) {\r\nif (value == 0x00)\r\ng_snprintf(buf, ITEM_LABEL_LENGTH, "No timeout check");\r\nelse if (value == 0xFF)\r\ng_snprintf(buf, ITEM_LABEL_LENGTH, "Wait until the contactless chip responds");\r\nelse if (value < 12)\r\ng_snprintf(buf, ITEM_LABEL_LENGTH, "%u [s]", value * 5);\r\nelse\r\ng_snprintf(buf, ITEM_LABEL_LENGTH, "%u:%02u [mm:ss]", value * 5 / 60, value * 5 % 60);\r\n}\r\nstatic gint\r\ndissect_acr122(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nproto_item *main_item;\r\nproto_tree *main_tree;\r\nproto_item *p1_item;\r\nproto_tree *p1_tree;\r\nproto_item *p2_item;\r\nproto_tree *p2_tree;\r\nproto_item *sub_item;\r\nproto_item *sub_tree;\r\nproto_item *sw2_item;\r\nproto_item *sw2_tree;\r\ngint offset = 0;\r\nguint32 value;\r\ntvbuff_t *next_tvb;\r\nguint8 acr_class;\r\nguint8 ins;\r\nguint8 p1;\r\nguint8 p2;\r\nguint8 length;\r\nguint8 command = CMD_UNKNOWN;\r\ncommand_data_t *command_data;\r\nusb_conv_info_t *usb_conv_info;\r\nwmem_tree_key_t key[5];\r\nguint32 bus_id;\r\nguint32 device_address;\r\nguint32 endpoint;\r\nguint32 k_bus_id;\r\nguint32 k_device_address;\r\nguint32 k_endpoint;\r\nguint32 k_frame_number;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ACR 122");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nmain_item = proto_tree_add_item(tree, proto_acr122, tvb, offset, -1, ENC_NA);\r\nmain_tree = proto_item_add_subtree(main_item, ett_acr122);\r\nif (!data) return offset;\r\nusb_conv_info = (usb_conv_info_t *) data;\r\nbus_id = usb_conv_info->bus_id;\r\ndevice_address = usb_conv_info->device_address;\r\nendpoint = usb_conv_info->endpoint;\r\nk_bus_id = bus_id;\r\nk_device_address = device_address;\r\nk_endpoint = endpoint;\r\nk_frame_number = pinfo->num;\r\nkey[0].length = 1;\r\nkey[0].key = &k_bus_id;\r\nkey[1].length = 1;\r\nkey[1].key = &k_device_address;\r\nkey[2].length = 1;\r\nkey[2].key = &k_endpoint;\r\nkey[3].length = 1;\r\nkey[3].key = &k_frame_number;\r\nkey[4].length = 0;\r\nkey[4].key = NULL;\r\nif (pinfo->p2p_dir == P2P_DIR_SENT) {\r\nacr_class = tvb_get_guint8(tvb, offset);\r\nins = tvb_get_guint8(tvb, offset + 1);\r\np1 = tvb_get_guint8(tvb, offset + 2);\r\np2 = tvb_get_guint8(tvb, offset + 3);\r\nlength = tvb_get_guint8(tvb, offset + 4);\r\nif (acr_class == 0xFF) {\r\nif (ins == 0xCA && p1 == 0x00 && p2 == 0x00 && length == 0)\r\ncommand = CMD_GET_DATA_UID;\r\nif (ins == 0xCA && p1 == 0x01 && p2 == 0x00 && length == 0)\r\ncommand = CMD_GET_DATA_ATS;\r\nelse if (ins == 0x82 && length == 6)\r\ncommand = CMD_LOAD_AUTHENTICATION_KEYS;\r\nelse if (ins == 0x88 && p1 == 0x00)\r\ncommand = CMD_AUTHENTICATION_OBSOLETE;\r\nelse if (ins == 0x86 && p1 == 0x00 && p2 == 0x00 && length == 5)\r\ncommand = CMD_AUTHENTICATION;\r\nelse if (ins == 0xB0 && p1 == 0x00)\r\ncommand = CMD_READ_BINARY_BLOCKS;\r\nelse if (ins == 0xD6 && p1 == 0x00)\r\ncommand = CMD_UPDATE_BINARY_BLOCKS;\r\nelse if (ins == 0xD7 && p1 == 0x00 && length == 5)\r\ncommand = CMD_VALUE_BLOCK_OPERATION;\r\nelse if (ins == 0xB1 && p1 == 0x00 && length == 4)\r\ncommand = CMD_READ_VALUE_BLOCK;\r\nelse if (ins == 0xD7 && p1 == 0x00 && length == 2)\r\ncommand = CMD_RESTORE_VALUE_BLOCK;\r\nelse if (ins == 0x00 && p1 == 0x00 && p2 == 0x00)\r\ncommand = CMD_DIRECT_TRANSMIT;\r\nelse if (ins == 0x00 && p1 == 0x40 && length == 4)\r\ncommand = CMD_BI_COLOR_AND_BUZZER_LED_CONTROL;\r\nelse if (ins == 0x00 && p1 == 0x48 && p2 == 0x00)\r\ncommand = CMD_GET_FIRMWARE_VERSION;\r\nelse if (ins == 0x00 && p1 == 0x50 && p2 == 0x00)\r\ncommand = CMD_GET_PICC_OPERATING_PARAMETER;\r\nelse if (ins == 0x00 && p1 == 0x51 && length == 0)\r\ncommand = CMD_SET_PICC_OPERATING_PARAMETER;\r\nelse if (ins == 0x00 && p1 == 0x41 && length == 0)\r\ncommand = CMD_SET_TIMEOUT_PARAMETER;\r\nelse if (ins == 0x00 && p1 == 0x52 && length == 0)\r\ncommand = CMD_SET_BUZZER_OUTPUT_FOR_CARD_DETECTION;\r\n}\r\nsub_item = proto_tree_add_uint(main_tree, hf_command, tvb, offset, 4 + length, command);\r\nPROTO_ITEM_SET_GENERATED(sub_item);\r\nif (command == CMD_UNKNOWN)\r\nexpert_add_info(pinfo, sub_item, &ei_unknown_command_or_invalid_parameters);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Command: %s", val_to_str_ext_const(command, &command_vals_ext, "Unknown"));\r\nproto_tree_add_item(main_tree, hf_class, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_ins, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\np1_item = proto_tree_add_item(main_tree, hf_p1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\np2_item = proto_tree_add_item(main_tree, hf_p2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_length, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (command) {\r\ncase CMD_DIRECT_TRANSMIT:\r\nif (length > 0) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, length);\r\ncall_dissector_with_data(pn532_handle, next_tvb, pinfo, tree, usb_conv_info);\r\noffset += length;\r\n}\r\nbreak;\r\ncase CMD_BI_COLOR_AND_BUZZER_LED_CONTROL:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_led_green_blinking_state, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_red_blinking_state, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_green_mask, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_red_mask, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_initial_green_blinking_state, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_initial_red_blinking_state, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_final_green_state, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_led_final_red_state, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_led_t1_duration, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_led_t2_duration, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_led_number_of_repetition, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_led_link_to_buzzer, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase CMD_GET_DATA_UID:\r\ncase CMD_GET_DATA_ATS:\r\nbreak;\r\ncase CMD_LOAD_AUTHENTICATION_KEYS:\r\np1_tree = proto_item_add_subtree(p1_item, ett_p1_item);\r\nproto_tree_add_item(p1_tree, hf_key_structure, tvb, offset - 3, 1, ENC_BIG_ENDIAN);\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_key_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_key, tvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nbreak;\r\ncase CMD_AUTHENTICATION_OBSOLETE:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_block_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_key_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_key_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase CMD_AUTHENTICATION:\r\nproto_tree_add_item(main_tree, hf_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(main_tree, hf_block_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_key_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_key_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase CMD_READ_BINARY_BLOCKS:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_block_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CMD_UPDATE_BINARY_BLOCKS:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_block_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_data, tvb, offset, length, ENC_NA);\r\noffset += length;\r\nbreak;\r\ncase CMD_VALUE_BLOCK_OPERATION:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_block_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_vb_op, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_value, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nbreak;\r\ncase CMD_READ_VALUE_BLOCK:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_block_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CMD_RESTORE_VALUE_BLOCK:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_source_block_number, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(main_tree, hf_static_byte, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(main_tree, hf_target_block_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nbreak;\r\ncase CMD_SET_PICC_OPERATING_PARAMETER:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_auto_picc_polling, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_auto_ats_generation, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_polling_interval, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_felica_424k, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_felica_212k, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_topaz, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_iso_14443_type_b, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(p2_tree, hf_picc_operating_iso_14443_type_a, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CMD_SET_TIMEOUT_PARAMETER:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_timeout, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CMD_SET_BUZZER_OUTPUT_FOR_CARD_DETECTION:\r\np2_tree = proto_item_add_subtree(p2_item, ett_p2_item);\r\nproto_tree_add_item(p2_tree, hf_poll_buzzer_status, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CMD_GET_PICC_OPERATING_PARAMETER:\r\nbreak;\r\n}\r\nif (!pinfo->fd->flags.visited) {\r\ncommand_data = wmem_new(wmem_file_scope(), command_data_t);\r\ncommand_data->bus_id = bus_id;\r\ncommand_data->device_address = device_address;\r\ncommand_data->endpoint = endpoint;\r\ncommand_data->command = command;\r\ncommand_data->command_frame_number = pinfo->num;\r\ncommand_data->response_frame_number = 0;\r\nwmem_tree_insert32_array(command_info, key, command_data);\r\n}\r\n} else {\r\nguint32 command_frame_number = 0;\r\ngboolean use_status_word = FALSE;\r\nwmem_tree_t *wmem_tree;\r\nkey[3].length = 0;\r\nkey[3].key = NULL;\r\nwmem_tree = (wmem_tree_t *) wmem_tree_lookup32_array(command_info, key);\r\nif (wmem_tree) {\r\ncommand_data = (command_data_t *) wmem_tree_lookup32_le(wmem_tree, pinfo->num);\r\nif (command_data && (command_data->response_frame_number == 0 ||\r\ncommand_data->response_frame_number == pinfo->num)) {\r\ncommand = command_data->command;\r\ncommand_frame_number = command_data->command_frame_number;\r\nif (!pinfo->fd->flags.visited && command_data->response_frame_number == 0) {\r\ncommand_data->response_frame_number = pinfo->num;\r\n}\r\n}\r\n}\r\nsub_item = proto_tree_add_uint(main_tree, hf_response, tvb, offset, tvb_captured_length_remaining(tvb, offset), command);\r\nPROTO_ITEM_SET_GENERATED(sub_item);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Response: %s", val_to_str_ext_const(command, &command_vals_ext, "Unknown"));\r\nif (command != CMD_UNKNOWN) {\r\nsub_item = proto_tree_add_uint(main_tree, hf_response_for, tvb, offset, tvb_captured_length_remaining(tvb, offset), command_frame_number);\r\nPROTO_ITEM_SET_GENERATED(sub_item);\r\n}\r\nswitch (command) {\r\ncase CMD_GET_FIRMWARE_VERSION:\r\nproto_tree_add_item(main_tree, hf_firmware_version, tvb, offset, -1, ENC_NA | ENC_ASCII);\r\noffset += tvb_captured_length_remaining(tvb, offset);\r\nbreak;\r\ncase CMD_DIRECT_TRANSMIT:\r\nuse_status_word = TRUE;\r\nif (tvb_captured_length_remaining(tvb, offset) > 2) {\r\nnext_tvb = tvb_new_subset_length(tvb, offset, tvb_captured_length_remaining(tvb, offset) - 2);\r\ncall_dissector_with_data(pn532_handle, next_tvb, pinfo, tree, usb_conv_info);\r\noffset += tvb_captured_length_remaining(tvb, offset) - 2;\r\n}\r\nbreak;\r\ncase CMD_READ_BINARY_BLOCKS:\r\nuse_status_word = TRUE;\r\nproto_tree_add_item(main_tree, hf_data, tvb, offset, tvb_captured_length_remaining(tvb, offset) - 2, ENC_NA);\r\noffset += tvb_captured_length_remaining(tvb, offset) - 2;\r\nbreak;\r\ncase CMD_READ_VALUE_BLOCK:\r\nuse_status_word = TRUE;\r\nproto_tree_add_item(main_tree, hf_value, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase CMD_GET_DATA_UID:\r\nuse_status_word = TRUE;\r\nproto_tree_add_item(main_tree, hf_uid, tvb, offset, tvb_captured_length_remaining(tvb, offset) - 2, ENC_NA);\r\noffset += tvb_captured_length_remaining(tvb, offset) - 2;\r\nbreak;\r\ncase CMD_GET_DATA_ATS:\r\nuse_status_word = TRUE;\r\nproto_tree_add_item(main_tree, hf_ats, tvb, offset, tvb_captured_length_remaining(tvb, offset) - 2, ENC_NA);\r\noffset += tvb_captured_length_remaining(tvb, offset) - 2;\r\nbreak;\r\ncase CMD_BI_COLOR_AND_BUZZER_LED_CONTROL:\r\ncase CMD_LOAD_AUTHENTICATION_KEYS:\r\ncase CMD_AUTHENTICATION:\r\ncase CMD_AUTHENTICATION_OBSOLETE:\r\ncase CMD_UPDATE_BINARY_BLOCKS:\r\ncase CMD_VALUE_BLOCK_OPERATION:\r\ncase CMD_RESTORE_VALUE_BLOCK:\r\ncase CMD_SET_TIMEOUT_PARAMETER:\r\ncase CMD_SET_BUZZER_OUTPUT_FOR_CARD_DETECTION:\r\ncase CMD_SET_PICC_OPERATING_PARAMETER:\r\ncase CMD_GET_PICC_OPERATING_PARAMETER:\r\ndefault:\r\nuse_status_word = TRUE;\r\nbreak;\r\n}\r\nif (use_status_word) {\r\nvalue = tvb_get_ntohs(tvb, offset);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - %s%s", (((value & 0xFF00) != 0x9000) && (value & 0xFF00) != 0x6100) ? "Error: " : "", rval_to_str(value, status_word_rvals, "Unknown error"));\r\nif ((value & 0xFF00) == 0x6100)\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Length %u", value & 0x00FF);\r\nsub_item = proto_tree_add_item(main_tree, hf_status_word, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_status_word);\r\nproto_tree_add_item(sub_tree, hf_status_word_sw1, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nsw2_item = proto_tree_add_item(sub_tree, hf_status_word_sw2, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nif (command == CMD_BI_COLOR_AND_BUZZER_LED_CONTROL) {\r\nsw2_tree = proto_item_add_subtree(sw2_item, ett_status_word_sw2);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - Red LED: %s, Green LED: %s", (value & 0x02) ? "On" : "Off", (value & 0x01) ? "On" : "Off");\r\nproto_tree_add_item(sw2_tree, hf_status_word_led_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_status_word_led_green, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_status_word_led_red, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n} else if (command == CMD_SET_PICC_OPERATING_PARAMETER || command == CMD_GET_PICC_OPERATING_PARAMETER) {\r\nsw2_tree = proto_item_add_subtree(sw2_item, ett_status_word_sw2);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_auto_picc_polling, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_auto_ats_generation, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_polling_interval, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_felica_424k, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_felica_212k, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_topaz, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_iso_14443_type_b, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sw2_tree, hf_picc_operating_iso_14443_type_a, tvb, offset - 2, 1, ENC_BIG_ENDIAN);\r\n}\r\noffset += 1;\r\n}\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_acr122(void)\r\n{\r\nmodule_t *module;\r\nexpert_module_t *expert_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_class,\r\n{ "Class", "acr122.class",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ins,\r\n{ "Ins", "acr122.ins",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_p1,\r\n{ "P1", "acr122.p1",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_p2,\r\n{ "P2", "acr122.p2",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_length,\r\n{ "Length", "acr122.length",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_status_word,\r\n{ "Status Word", "acr122.status_word",\r\nFT_UINT16, BASE_HEX | BASE_RANGE_STRING, RVALS(status_word_rvals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_status_word_sw1,\r\n{ "SW1", "acr122.status_word.sw1",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_status_word_sw2,\r\n{ "SW2", "acr122.status_word.sw2",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_command,\r\n{ "Command", "acr122.command",\r\nFT_UINT8, BASE_HEX | BASE_EXT_STRING, &command_vals_ext, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_response,\r\n{ "Response", "acr122.response",\r\nFT_UINT8, BASE_HEX | BASE_EXT_STRING, &command_vals_ext, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_response_for,\r\n{ "Response for", "acr122.response_for",\r\nFT_FRAMENUM, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_auto_picc_polling,\r\n{ "Auto PICC Polling", "acr122.picc_operating.auto_picc_polling",\r\nFT_BOOLEAN, 8, NULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_auto_ats_generation,\r\n{ "ATS Generation", "acr122.picc_operating.ats_generation",\r\nFT_BOOLEAN, 8, NULL, 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_polling_interval,\r\n{ "Polling Interval", "acr122.picc_operating.polling_interval",\r\nFT_BOOLEAN, 8, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_felica_424k,\r\n{ "FeliCa 424k", "acr122.picc_operating.felica_424k",\r\nFT_BOOLEAN, 8, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_felica_212k,\r\n{ "FeliCa 212k", "acr122.picc_operating.felica_212k",\r\nFT_BOOLEAN, 8, NULL, 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_topaz,\r\n{ "Topaz", "acr122.picc_operating.topaz",\r\nFT_BOOLEAN, 8, NULL, 0x04,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_iso_14443_type_b,\r\n{ "ISO 14443 Type B", "acr122.picc_operating.iso_14443_type_b",\r\nFT_BOOLEAN, 8, NULL, 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_picc_operating_iso_14443_type_a,\r\n{ "ISO 14443 Type A", "acr122.picc_operating.iso_14443_type_a",\r\nFT_BOOLEAN, 8, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_firmware_version,\r\n{ "Firmware Version", "acr122.firmware_version",\r\nFT_STRING, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_green_blinking_state,\r\n{ "Green LED Blinking", "acr122.led.green.blinking",\r\nFT_BOOLEAN, 8, NULL, 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_red_blinking_state,\r\n{ "Red LED Blinking", "acr122.led.red.blinking",\r\nFT_BOOLEAN, 8, NULL, 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_green_mask,\r\n{ "Green LED Mask", "acr122.led.green.mask",\r\nFT_BOOLEAN, 8, NULL, 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_red_mask,\r\n{ "Red LED Mask", "acr122.led.red.mask",\r\nFT_BOOLEAN, 8, NULL, 0x10,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_initial_green_blinking_state,\r\n{ "Initial Green LED Blinking", "acr122.led.green.initial",\r\nFT_BOOLEAN, 8, NULL, 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_initial_red_blinking_state,\r\n{ "Initial Red LED Blinking", "acr122.led.red.initial",\r\nFT_BOOLEAN, 8, NULL, 0x04,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_final_green_state,\r\n{ "Final Green LED", "acr122.led.green.final",\r\nFT_BOOLEAN, 8, NULL, 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_final_red_state,\r\n{ "Final Red LED", "acr122.led.red.final",\r\nFT_BOOLEAN, 8, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_t1_duration,\r\n{ "T1 Duration", "acr122.led.t1_duration",\r\nFT_UINT8, BASE_CUSTOM, CF_FUNC(duration_base), 0x00,\r\n"Initial Blinking State", HFILL }\r\n},\r\n{ &hf_led_t2_duration,\r\n{ "T2 Duration", "acr122.led.t2_duration",\r\nFT_UINT8, BASE_CUSTOM, CF_FUNC(duration_base), 0x00,\r\n"Toggle Blinking State", HFILL }\r\n},\r\n{ &hf_led_number_of_repetition,\r\n{ "Number of Repetition", "acr122.led.number_of_repetition",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_led_link_to_buzzer,\r\n{ "Link to Buzzer", "acr122.led.link_to_buzzer",\r\nFT_UINT8, BASE_HEX, VALS(link_to_buzzer_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_poll_buzzer_status,\r\n{ "Poll Buzzer Status", "acr122.poll_buzzer_status",\r\nFT_UINT8, BASE_HEX, VALS(poll_buzzer_status_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_timeout,\r\n{ "Timeout", "acr122.timeout",\r\nFT_UINT8, BASE_CUSTOM, CF_FUNC(timeout_base), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_status_word_led_reserved,\r\n{ "Reserved", "acr122.status_word.sw2.reserved",\r\nFT_UINT8, BASE_HEX, NULL, 0xFC,\r\nNULL, HFILL }\r\n},\r\n{ &hf_status_word_led_green,\r\n{ "Current Green LED", "acr122.status_word.sw2.led.green",\r\nFT_BOOLEAN, 8, NULL, 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_status_word_led_red,\r\n{ "Current Red LED", "acr122.status_word.sw2.led.red",\r\nFT_BOOLEAN, 8, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_key,\r\n{ "Key", "acr122.key",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_key_structure,\r\n{ "Key Structure", "acr122.key_structure",\r\nFT_UINT8, BASE_HEX, VALS(key_structure_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_key_number,\r\n{ "Key Number", "acr122.key_number",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_key_type,\r\n{ "Key Type", "acr122.key_type",\r\nFT_UINT8, BASE_HEX, VALS(key_type_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_block_number,\r\n{ "Block Number", "acr122.block_number",\r\nFT_UINT8, BASE_DEC_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_source_block_number,\r\n{ "Source Block Number", "acr122.source_block_number",\r\nFT_UINT8, BASE_DEC_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_target_block_number,\r\n{ "Target Block Number", "acr122.target_block_number",\r\nFT_UINT8, BASE_DEC_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_static_byte,\r\n{ "Static Byte", "acr122.static_byte",\r\nFT_UINT8, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_vb_op,\r\n{ "VB Op", "acr122.vb_op",\r\nFT_UINT8, BASE_HEX, VALS(vb_op_vals), 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_version,\r\n{ "Version", "acr122.version",\r\nFT_UINT16, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_value,\r\n{ "Value", "acr122.value",\r\nFT_INT32, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_uid,\r\n{ "UID", "acr122.uid",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ats,\r\n{ "ATS", "acr122.ats",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_data,\r\n{ "Data", "acr122.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_acr122,\r\n&ett_p1_item,\r\n&ett_p2_item,\r\n&ett_status_word,\r\n&ett_status_word_sw2\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_unknown_command_or_invalid_parameters, { "acr122.expert.unknown_command", PI_PROTOCOL, PI_NOTE, "Unknown command or invalid parameters", EXPFILL }},\r\n};\r\ncommand_info = wmem_tree_new_autoreset(wmem_epan_scope(), wmem_file_scope());\r\nproto_acr122 = proto_register_protocol("Advanced Card Systems ACR122", "ACR 122", "acr122");\r\nregister_dissector("acr122", dissect_acr122, proto_acr122);\r\nproto_register_field_array(proto_acr122, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_module = expert_register_protocol(proto_acr122);\r\nexpert_register_field_array(expert_module, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_acr122, NULL);\r\nprefs_register_static_text_preference(module, "version",\r\n"ACR122U USB NFC Reader - Application Programming Interface V2.02",\r\n"Version of protocol supported by this dissector.");\r\n}\r\nvoid\r\nproto_reg_handoff_acr122(void)\r\n{\r\npn532_handle = find_dissector_add_dependency("pn532", proto_acr122);\r\n}

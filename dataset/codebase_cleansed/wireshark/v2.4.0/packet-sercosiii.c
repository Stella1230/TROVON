static void dissect_siii_mst(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *subtree;\r\nproto_tree *subtree2;\r\nsubtree = proto_tree_add_subtree(tree, tvb, 0, 6, ett_siii_mst, NULL, "MST");\r\nsubtree2 = proto_tree_add_subtree(subtree, tvb, 0, 1, ett_siii_mst_teltype, NULL, "Telegram Type");\r\nproto_tree_add_item(subtree2, hf_siii_mst_channel, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree2, hf_siii_mst_type, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree2, hf_siii_mst_cyclecntvalid, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree2, hf_siii_mst_telno, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nsubtree2 = proto_tree_add_subtree(subtree, tvb, 1, 1, ett_siii_mst_phase, NULL, "Phase Field");\r\nproto_tree_add_item(subtree2, hf_siii_mst_phase, tvb, 1, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree2, hf_siii_mst_cyclecnt, tvb, 1, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree, hf_siii_mst_crc32, tvb, 2, 4, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void dissect_siii_mdt_hp(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *subtree;\r\nstatic const int * ctrl_fields[] = {\r\n&hf_siii_mdt_hotplug_control_svc_switch,\r\n&hf_siii_mdt_hotplug_control_param,\r\nNULL\r\n};\r\nsubtree = proto_tree_add_subtree(tree, tvb, 0, 8, ett_siii_mdt_hp, NULL, "Hot-Plug");\r\nproto_tree_add_item(subtree, hf_siii_mdt_hotplug_address, tvb, 0, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_bitmask(subtree, tvb, 2, hf_siii_mdt_hp_ctrl,\r\nett_siii_mdt_hp_ctrl, ctrl_fields, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree, hf_siii_mdt_hp_info, tvb, 4, 4, ENC_NA);\r\n}\r\nstatic void dissect_siii_mdt_devctrl(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nstatic const int * ctrl_fields[] = {\r\n&hf_siii_at_dev_control_ident,\r\n&hf_siii_mdt_dev_control_change_topology,\r\n&hf_siii_mdt_dev_control_top_control,\r\nNULL\r\n};\r\nproto_tree_add_bitmask(tree, tvb, 0, hf_siii_mdt_dev_control,\r\nett_siii_mdt_devctrl, ctrl_fields, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void dissect_siii_mdt_svc(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, guint devno _U_)\r\n{\r\nproto_tree *subtree;\r\nproto_item *ti;\r\nstatic const int * svch_fields[] = {\r\n&hf_siii_mdt_svch_dbe,\r\n&hf_siii_mdt_svch_eot,\r\n&hf_siii_mdt_svch_rw,\r\n&hf_siii_mdt_svch_mhs,\r\nNULL\r\n};\r\nguint16 svc_ctrl = tvb_get_letohs(tvb, 0);\r\nguint8 svc_dbe = (svc_ctrl>>3) & 7;\r\nproto_tree_add_bitmask(tree, tvb, 0, hf_siii_mdt_svch_ctrl,\r\nett_siii_mdt_svcctrl, svch_fields, ENC_LITTLE_ENDIAN);\r\nti = proto_tree_add_item(tree, hf_siii_mdt_svch_info, tvb, 2, 4, ENC_NA);\r\nif (1 == svc_dbe)\r\n{\r\nsubtree = proto_item_add_subtree(ti, ett_siii_mdt_svcinfo);\r\nproto_tree_add_item(subtree, hf_siii_idn_code, tvb, 2, 4, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree, hf_siii_mdt_svch_idn, tvb, 2, 4, ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\nstatic void dissect_siii_mdt_cp0(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nstatic const int * version_fields[] = {\r\n&hf_siii_mdt_version_switch_off_sercos_telegrams,\r\n&hf_siii_mdt_version_fast_cp_switch,\r\n&hf_siii_mdt_version_transmission_of_communication_parameters_mdt0_cp0,\r\n&hf_siii_mdt_version_num_mdt_at_cp1_2,\r\n&hf_siii_mdt_version_initprocvers,\r\nNULL\r\n};\r\nproto_tree_add_bitmask(tree, tvb, 0, hf_siii_mdt_version,\r\nett_siii_mdt_version, version_fields, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void dissect_siii_mdt_cp1_2(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint telno)\r\n{\r\nguint devstart = telno * SERCOS_SLAVE_GROUP_SIZE;\r\ntvbuff_t *tvb_n;\r\nguint idx;\r\nproto_tree *subtree;\r\nproto_tree *subtree_svc;\r\nproto_tree *subtree_devctrl;\r\nsubtree_svc = proto_tree_add_subtree(tree, tvb, 0, SERCOS_SLAVE_GROUP_SIZE * 6, ett_siii_mdt_svc, NULL, "Service Channels");\r\nsubtree_devctrl = proto_tree_add_subtree(tree, tvb, SERCOS_SLAVE_GROUP_SIZE * 6, 512, ett_siii_mdt_svc, NULL, "Device Control");\r\nfor (idx = 0; idx < SERCOS_SLAVE_GROUP_SIZE; ++idx)\r\n{\r\ntvb_n = tvb_new_subset_length(tvb, 6 * idx, 6);\r\nsubtree = proto_tree_add_subtree_format(subtree_svc, tvb_n, 0, 6, ett_siii_mdt_svc_channel, NULL, "Device %u", idx + devstart);\r\ndissect_siii_mdt_svc(tvb_n, pinfo, subtree, idx + devstart);\r\ntvb_n = tvb_new_subset_length(tvb, SERCOS_SLAVE_GROUP_SIZE * 6 + 4 * idx, 2);\r\nsubtree = proto_tree_add_subtree_format(subtree_devctrl, tvb_n, 0, 2, ett_siii_mdt_dev_control, NULL, "Device %u", idx + devstart);\r\ndissect_siii_mdt_devctrl(tvb_n, pinfo, subtree);\r\n}\r\n}\r\nstatic void dissect_siii_mdt_cp3_4(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint telno)\r\n{\r\nif (0 == telno)\r\ndissect_siii_mdt_hp(tvb, pinfo, tree);\r\nproto_tree_add_item(tree, hf_siii_service_channels, tvb, 0, 0, ENC_NA);\r\nproto_tree_add_item(tree, hf_siii_device_controls, tvb, 0, 0, ENC_NA);\r\n}\r\nstatic void dissect_siii_mdt(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *subtree;\r\ntvbuff_t *tvb_n;\r\nguint t_phase;\r\nguint telno;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SIII MDT");\r\nt_phase = (tvb_get_guint8(tvb, 1)&0x8F);\r\ntelno = (tvb_get_guint8(tvb, 0) & 0xF);\r\nif (t_phase & 0x80)\r\n{\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Phase=CP?s -> CP%u",\r\n(t_phase&0x0f));\r\n}\r\nelse\r\n{\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Phase=CP%u",\r\n(t_phase&0x0f));\r\n}\r\nsubtree = proto_tree_add_subtree_format(tree, tvb, 0, -1, ett_siii_mdt, NULL, "MDT%u", telno);\r\ndissect_siii_mst(tvb, pinfo, subtree);\r\nswitch (t_phase)\r\n{\r\ncase COMMUNICATION_PHASE_0:\r\ntvb_n = tvb_new_subset_length(tvb, 6, 40);\r\ndissect_siii_mdt_cp0(tvb_n, pinfo, subtree);\r\nbreak;\r\ncase COMMUNICATION_PHASE_1:\r\ncase COMMUNICATION_PHASE_2:\r\ntvb_n = tvb_new_subset_length(tvb, 6, 1280);\r\ndissect_siii_mdt_cp1_2(tvb_n, pinfo, subtree, telno);\r\nbreak;\r\ncase COMMUNICATION_PHASE_3:\r\ncase COMMUNICATION_PHASE_4:\r\ntvb_n = tvb_new_subset_remaining(tvb, 6);\r\ndissect_siii_mdt_cp3_4(tvb_n, pinfo, subtree, telno);\r\nbreak;\r\ndefault:\r\nproto_tree_add_expert(tree, pinfo, &ei_siii_cp_unknown, tvb, 6, -1);\r\n}\r\n}\r\nstatic void dissect_siii_at_svc(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree, guint devno _U_)\r\n{\r\nstatic const int * svch_fields[] = {\r\n&hf_siii_at_svch_valid,\r\n&hf_siii_at_svch_error,\r\n&hf_siii_at_svch_busy,\r\n&hf_siii_at_svch_ahs,\r\nNULL\r\n};\r\nproto_tree_add_bitmask(tree, tvb, 0, hf_siii_at_svch_stat,\r\nett_siii_at_svcstat, svch_fields, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(tree, hf_siii_at_svch_info, tvb, 2, 4, ENC_NA);\r\n}\r\nstatic void dissect_siii_at_devstat(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nstatic const int * status[] = {\r\n&hf_siii_at_dev_status_commwarning,\r\n&hf_siii_at_dev_status_change_topology,\r\n&hf_siii_at_dev_status_top_status,\r\n&hf_siii_at_dev_status_inactive_port_status,\r\n&hf_siii_at_dev_status_errorconnection,\r\n&hf_siii_at_dev_status_slave_valid,\r\n&hf_siii_at_dev_status_proc_command_change,\r\n&hf_siii_at_dev_status_parameterization_level_active,\r\nNULL\r\n};\r\nproto_tree_add_bitmask(tree, tvb, 0, hf_siii_at_dev_status,\r\nett_siii_at_devstatus, status, ENC_LITTLE_ENDIAN);\r\n}\r\nstatic void dissect_siii_at_hp(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nproto_tree *subtree;\r\nstatic const int * status[] = {\r\n&hf_siii_at_hotplug_status_error,\r\n&hf_siii_at_hotplug_status_hp0_finished,\r\n&hf_siii_at_hotplug_status_param,\r\nNULL\r\n};\r\nsubtree = proto_tree_add_subtree(tree, tvb, 0, 8, ett_siii_at_hp, NULL, "Hot-Plug");\r\nproto_tree_add_item(subtree, hf_siii_at_hotplug_address, tvb, 0, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_bitmask(subtree, tvb, 2, hf_siii_at_hp_stat, ett_siii_at_hp_stat, status, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree, hf_siii_at_hp_info, tvb, 4, 4, ENC_NA);\r\n}\r\nstatic void dissect_siii_at_cp0(tvbuff_t *tvb, packet_info *pinfo _U_, proto_tree *tree)\r\n{\r\nguint16 seqcnt;\r\nguint16 tfield;\r\nguint16 i;\r\nproto_tree *subtree, *subtree2;\r\nproto_item* ti;\r\nsubtree = proto_tree_add_subtree(tree, tvb, 0, 1024, ett_siii_recognized_devices, NULL, "Recognized Devices");\r\nseqcnt = tvb_get_letohs(tvb, 0);\r\nproto_tree_add_uint(subtree, hf_siii_at_cp0_num_devices, tvb, 0, 2, (MAX_SERCOS_ADDRESS & seqcnt)-1);\r\nfor (i = 1; i < MAX_SERCOS_DEVICES; ++i)\r\n{\r\ntfield = tvb_get_letohs(tvb, i*2);\r\nif (tfield == 0xFFFF)\r\n{\r\nproto_tree_add_uint_format(subtree, hf_siii_at_cp0_sercos_address, tvb, i*2, 2, 0xFFFF, "Sercos Address %u: No Device", i);\r\n}\r\nelse\r\n{\r\nti = proto_tree_add_uint_format(subtree, hf_siii_at_cp0_sercos_address, tvb, i*2, 2, (tfield & MAX_SERCOS_ADDRESS), "Sercos Address %u: %u", i, (tfield & MAX_SERCOS_ADDRESS));\r\nsubtree2 = proto_item_add_subtree(ti, ett_siii_at_sercos_address);\r\nproto_tree_add_item(subtree2, hf_siii_at_cp0_support_functions, tvb, i*2, 2, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(subtree2, hf_siii_at_cp0_device_address, tvb, i*2, 2, ENC_LITTLE_ENDIAN);\r\n}\r\n}\r\n}\r\nstatic void dissect_siii_at_cp1_2(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint telno)\r\n{\r\nguint devstart = telno * SERCOS_SLAVE_GROUP_SIZE;\r\ntvbuff_t *tvb_n;\r\nguint idx;\r\nproto_tree *subtree;\r\nproto_tree *subtree_svc;\r\nproto_tree *subtree_devstat;\r\nsubtree_svc = proto_tree_add_subtree(tree, tvb, 0, SERCOS_SLAVE_GROUP_SIZE * 6, ett_siii_at_svc, NULL, "Service Channel");\r\nsubtree_devstat = proto_tree_add_subtree(tree, tvb, SERCOS_SLAVE_GROUP_SIZE * 6, 512, ett_siii_at_devstats, NULL, "Device Status");\r\nfor (idx = 0; idx < SERCOS_SLAVE_GROUP_SIZE; ++idx)\r\n{\r\ntvb_n = tvb_new_subset_length(tvb, 6 * idx, 6);\r\nsubtree = proto_tree_add_subtree_format(subtree_svc, tvb_n, 0, 6, ett_siii_at_svc_channel, NULL, "Device %u", idx + devstart);\r\ndissect_siii_at_svc(tvb_n, pinfo, subtree, idx + devstart);\r\ntvb_n = tvb_new_subset_length(tvb, SERCOS_SLAVE_GROUP_SIZE * 6 + 4 * idx, 2);\r\nsubtree = proto_tree_add_subtree_format(subtree_devstat, tvb_n, 0, 2, ett_siii_at_dev_status, NULL, "Device %u", idx + devstart);\r\ndissect_siii_at_devstat(tvb_n, pinfo, subtree);\r\n}\r\n}\r\nstatic void dissect_siii_at_cp3_4(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, guint telno)\r\n{\r\nif (0 == telno)\r\ndissect_siii_at_hp(tvb, pinfo, tree);\r\nproto_tree_add_item(tree, hf_siii_service_channels, tvb, 0, 0, ENC_NA);\r\nproto_tree_add_item(tree, hf_siii_device_status, tvb, 0, 0, ENC_NA);\r\n}\r\nstatic void dissect_siii_at(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *subtree;\r\ntvbuff_t *tvb_n;\r\nguint8 phase;\r\nguint telno;\r\nphase = (tvb_get_guint8(tvb, 1)&0x8F);\r\ntelno = (tvb_get_guint8(tvb, 0) & 0xF);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SIII AT");\r\nif (phase & 0x80)\r\n{\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Phase=CP?s -> CP%u",\r\n(phase&0x0f));\r\n}\r\nelse\r\n{\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " Phase=CP%u",\r\n(phase&0x0f));\r\n}\r\nsubtree = proto_tree_add_subtree_format(tree, tvb, 0, -1, ett_siii_at, NULL, "AT%u", telno);\r\ndissect_siii_mst(tvb, pinfo, subtree);\r\nswitch (phase)\r\n{\r\ncase COMMUNICATION_PHASE_0:\r\ntvb_n = tvb_new_subset_length(tvb, 6, 1024);\r\ndissect_siii_at_cp0(tvb_n, pinfo, subtree);\r\nbreak;\r\ncase COMMUNICATION_PHASE_1:\r\ncase COMMUNICATION_PHASE_2:\r\ntvb_n = tvb_new_subset_length(tvb, 6, 1280);\r\ndissect_siii_at_cp1_2(tvb_n, pinfo, subtree, telno);\r\nbreak;\r\ncase COMMUNICATION_PHASE_3:\r\ncase COMMUNICATION_PHASE_4:\r\ntvb_n = tvb_new_subset_remaining(tvb, 6);\r\ndissect_siii_at_cp3_4(tvb_n, pinfo, subtree, telno);\r\nbreak;\r\ndefault:\r\nproto_tree_add_expert(tree, pinfo, &ei_siii_cp_unknown, tvb, 6, -1);\r\nbreak;\r\n}\r\n}\r\nstatic int\r\ndissect_siii(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *siii_tree;\r\nguint type;\r\nconst char *tel_ch = "?";\r\nconst char *tel_type = "?";\r\nguint tel_no = 0;\r\nheur_dtbl_entry_t *hdtbl_entry;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SERCOS III V1.1");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (dissector_try_heuristic(heur_subdissector_list, tvb, pinfo, tree, &hdtbl_entry, NULL))\r\nreturn tvb_captured_length(tvb);\r\ntype = tvb_get_guint8(tvb, 0);\r\nif (type & 0x80)\r\ntel_ch = "S";\r\nelse\r\ntel_ch = "P";\r\nif (type & 0x40)\r\ntel_type = "AT ";\r\nelse\r\ntel_type = "MDT";\r\ntel_no = type &0xF;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s%u Channel=%s", tel_type, tel_no, tel_ch);\r\nti = proto_tree_add_item(tree, proto_siii, tvb, 0, -1, ENC_NA);\r\nsiii_tree = proto_item_add_subtree(ti, ett_siii);\r\nif (type & 0x40)\r\ndissect_siii_at(tvb, pinfo, siii_tree);\r\nelse\r\ndissect_siii_mdt(tvb, pinfo, siii_tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nstatic void\r\nsercosiii_idn_code_format( gchar *result, guint32 svc_info )\r\n{\r\ng_snprintf( result, ITEM_LABEL_LENGTH, "%c-%u-%04d.%d.%d",\r\n((0xFFFF & svc_info)>>15)?'P':'S',\r\n(svc_info>>12)&7,\r\n(svc_info&4095),\r\n(svc_info>>24) & 0xFF,\r\n(svc_info>>16) & 0xFF);\r\n}\r\nvoid\r\nproto_register_sercosiii(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_siii_mdt_version,\r\n{ "Communication Version", "siii.mdt.version",\r\nFT_UINT32, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_version_num_mdt_at_cp1_2,\r\n{ "Number of MDTs and ATS in CP1 and CP2", "siii.mdt.version.num_mdt_at_cp1_2",\r\nFT_UINT32, BASE_HEX, VALS(siii_mdt_version_num_mdtat_cp1_2_text), 0x30000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_version_transmission_of_communication_parameters_mdt0_cp0,\r\n{ "Transmission of Communication parameters", "siii.mdt.version.mdt0_cp0_transm_comm_parameter",\r\nFT_BOOLEAN, 32, TFS(&tfs_yes_no), 0x100000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_version_fast_cp_switch,\r\n{ "Fast CP switch", "siii.mdt.version.mdt0_cp0_fast_cp_switch",\r\nFT_BOOLEAN, 32, TFS(&siii_mdt_version_fast_cp_switch_text), 0x200000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_version_switch_off_sercos_telegrams,\r\n{ "Switch off Sercos III telegrams", "siii.mdt.version.mdt0_cp0_switch_off_sercos_telegram",\r\nFT_BOOLEAN, 32, TFS(&siii_switch_off_sercos_telegram_text), 0x400000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_version_initprocvers,\r\n{ "Initialization Procedure Version Number", "siii.mdt.version.initprocvers",\r\nFT_BOOLEAN, 32, TFS(&siii_mdt_version_initprocvers_text), 0xFF00,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_dev_control_top_control,\r\n{ "Topology Control", "siii.mdt.devcontrol.topcontrol",\r\nFT_UINT16, BASE_DEC, VALS(siii_mdt_devcontrol_topcontrol_text), 3<<(12),\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_control_ident,\r\n{ "Identification", "siii.mdt.devcontrol.identrequest",\r\nFT_UINT16, BASE_DEC, NULL, 0x8000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_dev_control_change_topology,\r\n{ "Changing Topology", "siii.mdt.devcontrol.topologychange",\r\nFT_UINT16, BASE_DEC, NULL, 1<<14,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_dev_control,\r\n{ "Word", "siii.mdt.devcontrol",\r\nFT_UINT16, BASE_DEC, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status,\r\n{ "Word", "siii.at.devstatus",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_commwarning,\r\n{ "Communication Warning", "siii.at.devstatus.commwarning",\r\nFT_UINT16, BASE_DEC, NULL, 1<<15,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_cp0_support_functions,\r\n{ "Support of requested functions", "siii.at.supfunctions",\r\nFT_BOOLEAN, 16, TFS(&siii_at_cp0_support_functions_text), 1<<15,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_cp0_device_address,\r\n{ "Sercos Address", "siii.at.sercosaddress",\r\nFT_UINT16, BASE_DEC, NULL, MAX_SERCOS_ADDRESS,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_change_topology,\r\n{ "Topology Change", "siii.at.devstatus.topologychanged",\r\nFT_UINT16, BASE_DEC, NULL, 1<<14,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_top_status,\r\n{ "Topology Status", "siii.at.devstatus.topstatus",\r\nFT_UINT16, BASE_DEC, VALS(siii_at_devstatus_topstatus_text), 0x3<<(12),\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_inactive_port_status,\r\n{ "Port 1 Status", "siii.at.devstatus.inactportstatus",\r\nFT_UINT16, BASE_DEC, VALS(siii_at_devstatus_inactiveportstatus_text), 0x3<<(10),\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_errorconnection,\r\n{ "Topology Status", "siii.at.devstatus.errorconnection",\r\nFT_UINT16, BASE_DEC, VALS(siii_at_devstatus_errorconnection_text), 1<<9,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_slave_valid,\r\n{ "Slave data valid", "siii.at.devstatus.slavevalid",\r\nFT_UINT16, BASE_DEC, NULL, 1<<8,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_proc_command_change,\r\n{ "Procedure Command Change", "siii.at.devstatus.proccmdchange",\r\nFT_UINT16, BASE_DEC, VALS(siii_at_dev_status_proc_command_change_text), 1<<5,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_dev_status_parameterization_level_active,\r\n{ "Parameterization level active", "siii.at.devstatus.paralevelactive",\r\nFT_UINT16, BASE_DEC, NULL, 1<<4,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_ctrl,\r\n{"SvcCtrl", "siii.mdt.svch.ctrl",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_svch_stat,\r\n{"SvcStat", "siii.mdt.svch.stat",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_info,\r\n{"Svc Info", "siii.mdt.svch.info",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_svch_info,\r\n{"Svc Info", "siii.at.svch.info",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_idn,\r\n{"IDN", "siii.mdt.svch.idn",\r\nFT_UINT32, BASE_HEX | BASE_EXT_STRING, &siii_mdt_idn_text_ext, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_dbe,\r\n{ "Data block element", "siii.mdt.svch.dbe",\r\nFT_UINT16, BASE_DEC, VALS(siii_mdt_svch_dbe_text), 0x38,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_eot,\r\n{"End of element transmission", "siii.mdt.svch.eot",\r\nFT_BOOLEAN, 16, TFS(&siii_mdt_svch_eot_text), 0x04,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_rw,\r\n{"Read/Write", "siii.mdt.svch.rw",\r\nFT_BOOLEAN, 16, TFS(&siii_mdt_svch_rw_text), 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_svch_mhs,\r\n{"Master Handshake", "siii.mdt.svch.mhs",\r\nFT_UINT16, BASE_DEC, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_svch_valid,\r\n{ "SVC process", "siii.mdt.svch.proc",\r\nFT_BOOLEAN, 16, TFS(&tfs_valid_not_valid), 0x08,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_svch_error,\r\n{"SVC Error", "siii.mdt.svch.error",\r\nFT_BOOLEAN, 16, TFS(&siii_at_svch_error_text), 0x04,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_svch_busy,\r\n{"Busy", "siii.mdt.svch.busy",\r\nFT_BOOLEAN, 16, TFS(&siii_at_svch_busy_text), 0x02,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_svch_ahs,\r\n{"Handshake", "siii.at.svch.ahs",\r\nFT_UINT16, BASE_DEC, NULL, 0x01,\r\nNULL, HFILL }\r\n},\r\n#if 0\r\n{ &hf_siii_svch_data_telofs_telno,\r\n{"Telegram Number", "siii.mdt.svch.data.telassign.telno",\r\nFT_UINT16, BASE_DEC, NULL, 0xF000,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n#if 0\r\n{ &hf_siii_svch_data_telofs_mdt_at,\r\n{"Telegram Type", "siii.mdt.svch.data.telassign.mdt_at",\r\nFT_UINT16, BASE_DEC, VALS(siii_svch_data_mdt_at_text), 0x0800,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n#if 0\r\n{ &hf_siii_svch_data_telofs_offset,\r\n{"Telegram Offset", "siii.mdt.svch.data.telassign.offset",\r\nFT_UINT16, BASE_DEC, NULL, 0x07FF,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n#if 0\r\n{ &hf_siii_svch_data_proccmd_proccmdexec,\r\n{"Procedure Command Execution", "siii.mdt.svch.data.proccmd.interrupt",\r\nFT_UINT16, BASE_DEC, VALS(siii_svch_data_proccmd_proccmdexec_text), 0x0002,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n#if 0\r\n{ &hf_siii_svch_data_proccmd_proccmd,\r\n{"Procedure Command", "siii.mdt.svch.data.proccmd.set",\r\nFT_UINT16, BASE_DEC, VALS(siii_svch_data_proccmd_proccmd_text), 0x0001,\r\nNULL, HFILL }\r\n},\r\n#endif\r\n{ &hf_siii_mst_channel,\r\n{ "Channel", "siii.channel",\r\nFT_UINT8, BASE_DEC, VALS(siii_mst_channel_text), 0x80,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mst_type,\r\n{ "Telegram Type" , "siii.type",\r\nFT_UINT8, BASE_DEC, VALS(siii_mst_type_text), 0x40,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mst_cyclecntvalid,\r\n{ "Cycle Count Valid", "siii.cyclecntvalid",\r\nFT_BOOLEAN, 8, TFS(&tfs_valid_invalid), 0x20,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mst_telno,\r\n{ "Telegram Number", "siii.telno",\r\nFT_UINT8, BASE_DEC, NULL, 0x0F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mst_phase,\r\n{ "Phase", "siii.mst.phase",\r\nFT_UINT8, BASE_HEX, VALS(siii_mst_phase_text), 0x8F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mst_cyclecnt,\r\n{ "Cycle Cnt", "siii.mst.cyclecnt",\r\nFT_UINT8, BASE_DEC, NULL, 0x70,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mst_crc32,\r\n{ "CRC32", "siii.mst.crc32",\r\nFT_UINT32, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_hotplug_address,\r\n{"Sercos address", "siii.mdt.hp.sercosaddress",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_hp_ctrl,\r\n{"HP control", "siii.mdt.hp.ctrl",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_hp_info,\r\n{"HP info", "siii.mdt.hp.info",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_hotplug_address,\r\n{"Sercos address", "siii.at.hp.sercosaddress",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_hp_stat,\r\n{"HP status", "siii.mdt.hp.stat",\r\nFT_UINT16, BASE_HEX, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_hp_info,\r\n{"HP info", "siii.at.hp.info",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_hotplug_control_param,\r\n{"Parameter", "siii.mdt.hp.parameter",\r\nFT_UINT16, BASE_DEC | BASE_EXT_STRING, &siii_mdt_hotplug_control_functioncode_text_ext, 0xFF,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_mdt_hotplug_control_svc_switch,\r\n{"Switch to SVC", "siii.mdt.hp.switch",\r\nFT_UINT16, BASE_DEC, VALS(siii_mdt_hotplug_control_svc_switch_text), 0x100,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_hotplug_status_param,\r\n{"Parameter Received", "siii.at.hp.parameter",\r\nFT_UINT16, BASE_DEC, VALS(siii_mdt_hotplug_status_ackcode_text), 0xFF,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_hotplug_status_hp0_finished,\r\n{"HP/SVC", "siii.at.hp.hp0_finished",\r\nFT_UINT16, BASE_DEC, NULL, 0x100,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_hotplug_status_error,\r\n{"Error", "siii.at.hp.error",\r\nFT_UINT16, BASE_DEC, VALS(siii_at_hotplug_status_error_text), 0x200,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_service_channels,\r\n{"Service Channels", "siii.service_channels",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_device_controls,\r\n{"Device Controls", "siii.device_controls",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_device_status,\r\n{"Device Status", "siii.device_status",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_idn_code,\r\n{"IDN code", "siii.idn_code",\r\nFT_UINT32, BASE_CUSTOM, CF_FUNC(sercosiii_idn_code_format), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_cp0_num_devices,\r\n{"Number of Devices", "siii.at.cp0.num_devices",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_siii_at_cp0_sercos_address,\r\n{"Sercos Address", "siii.at.cp0.sercos_address",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_siii,\r\n&ett_siii_header,\r\n&ett_siii_mdt,\r\n&ett_siii_mdt_version,\r\n&ett_siii_mdt_svc,\r\n&ett_siii_mdt_devctrls,\r\n&ett_siii_mdt_svc_channel,\r\n&ett_siii_mdt_dev_control,\r\n&ett_siii_at,\r\n&ett_siii_at_svc,\r\n&ett_siii_at_sercos_address,\r\n&ett_siii_at_devstats,\r\n&ett_siii_at_svc_channel,\r\n&ett_siii_at_dev_status,\r\n&ett_siii_mdt_devctrl,\r\n&ett_siii_at_devstatus,\r\n&ett_siii_at_sercosaddress,\r\n&ett_siii_mdt_svcctrl,\r\n&ett_siii_mdt_svcinfo,\r\n&ett_siii_at_svcstat,\r\n&ett_siii_at_svcinfo,\r\n&ett_siii_mdt_svch_data_error_info,\r\n&ett_siii_mdt_svch_data,\r\n&ett_siii_mst,\r\n&ett_siii_mst_teltype,\r\n&ett_siii_mst_phase,\r\n&ett_siii_mdt_hp,\r\n&ett_siii_at_hp,\r\n&ett_siii_mdt_hp_ctrl,\r\n&ett_siii_mdt_hp_info,\r\n&ett_siii_at_hp_stat,\r\n&ett_siii_at_hp_info,\r\n&ett_siii_recognized_devices\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_siii_cp_unknown, { "siii.cp_unknown", PI_PROTOCOL, PI_WARN, "CP is unknown", EXPFILL }},\r\n};\r\nexpert_module_t* expert_siii;\r\nproto_siii = proto_register_protocol("SERCOS III V1.1",\r\n"SERCOS III V1.1", "siii");\r\nregister_dissector("sercosiii", dissect_siii, proto_siii);\r\nheur_subdissector_list = register_heur_dissector_list("sercosiii", proto_siii);\r\nproto_register_field_array(proto_siii, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_siii = expert_register_protocol(proto_siii);\r\nexpert_register_field_array(expert_siii, ei, array_length(ei));\r\n}\r\nvoid\r\nproto_reg_handoff_sercosiii(void)\r\n{\r\ndissector_handle_t siii_handle;\r\nsiii_handle = create_dissector_handle(dissect_siii, proto_siii);\r\ndissector_add_uint("ethertype", ETHERTYPE_SERCOS, siii_handle);\r\n}

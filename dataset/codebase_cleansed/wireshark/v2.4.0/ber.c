static gboolean ber_read_file(wtap *wth, FILE_T fh, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\ngint64 file_size;\r\nint packet_size;\r\nif ((file_size = wtap_file_size(wth, err)) == -1)\r\nreturn FALSE;\r\nif (file_size > G_MAXINT) {\r\n*err = WTAP_ERR_BAD_FILE;\r\n*err_info = g_strdup_printf("ber: File has %" G_GINT64_MODIFIER "d-byte packet, bigger than maximum of %u",\r\nfile_size, G_MAXINT);\r\nreturn FALSE;\r\n}\r\npacket_size = (int)file_size;\r\nphdr->rec_type = REC_TYPE_PACKET;\r\nphdr->presence_flags = 0;\r\nphdr->caplen = packet_size;\r\nphdr->len = packet_size;\r\nphdr->ts.secs = 0;\r\nphdr->ts.nsecs = 0;\r\nws_buffer_assure_space(buf, packet_size);\r\nreturn wtap_read_packet_bytes(fh, buf, packet_size, err, err_info);\r\n}\r\nstatic gboolean ber_read(wtap *wth, int *err, gchar **err_info, gint64 *data_offset)\r\n{\r\ngint64 offset;\r\n*err = 0;\r\noffset = file_tell(wth->fh);\r\nif (offset != 0)\r\nreturn FALSE;\r\n*data_offset = offset;\r\nreturn ber_read_file(wth, wth->fh, &wth->phdr, wth->frame_buffer, err, err_info);\r\n}\r\nstatic gboolean ber_seek_read(wtap *wth, gint64 seek_off, struct wtap_pkthdr *phdr,\r\nBuffer *buf, int *err, gchar **err_info)\r\n{\r\nif(seek_off > 0) {\r\n*err = 0;\r\nreturn FALSE;\r\n}\r\nif (file_seek(wth->random_fh, seek_off, SEEK_SET, err) == -1)\r\nreturn FALSE;\r\nreturn ber_read_file(wth, wth->random_fh, phdr, buf, err, err_info);\r\n}\r\nwtap_open_return_val ber_open(wtap *wth, int *err, gchar **err_info)\r\n{\r\n#define BER_BYTES_TO_CHECK 8\r\nguint8 bytes[BER_BYTES_TO_CHECK];\r\nguint8 ber_id;\r\ngint8 ber_class;\r\ngint8 ber_tag;\r\ngboolean ber_pc;\r\nguint8 oct, nlb = 0;\r\nint len = 0;\r\ngint64 file_size;\r\nint offset = 0, i;\r\nif (!wtap_read_bytes(wth->fh, &bytes, BER_BYTES_TO_CHECK, err, err_info)) {\r\nif (*err != WTAP_ERR_SHORT_READ)\r\nreturn WTAP_OPEN_ERROR;\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\nber_id = bytes[offset++];\r\nber_class = (ber_id>>6) & 0x03;\r\nber_pc = (ber_id>>5) & 0x01;\r\nber_tag = ber_id & 0x1F;\r\nif(!(ber_pc &&\r\n(((ber_class == BER_CLASS_UNI) && ((ber_tag == BER_UNI_TAG_SET) || (ber_tag == BER_UNI_TAG_SEQ))) ||\r\n(((ber_class == BER_CLASS_CON) || (ber_class == BER_CLASS_APP)) && (ber_tag < 32)))))\r\nreturn WTAP_OPEN_NOT_MINE;\r\noct = bytes[offset++];\r\nif(oct != 0x80) {\r\nif(!(oct & 0x80))\r\nlen = oct;\r\nelse {\r\nnlb = oct & 0x7F;\r\nif((nlb > 0) && (nlb <= (BER_BYTES_TO_CHECK - 2))) {\r\ni = nlb;\r\nwhile(i--) {\r\noct = bytes[offset++];\r\nlen = (len<<8) + oct;\r\n}\r\n}\r\n}\r\nlen += (2 + nlb);\r\nfile_size = wtap_file_size(wth, err);\r\nif(len != file_size) {\r\nreturn WTAP_OPEN_NOT_MINE;\r\n}\r\n} else {\r\n}\r\nif (file_seek(wth->fh, 0, SEEK_SET, err) == -1)\r\nreturn WTAP_OPEN_ERROR;\r\nwth->file_type_subtype = WTAP_FILE_TYPE_SUBTYPE_BER;\r\nwth->file_encap = WTAP_ENCAP_BER;\r\nwth->snapshot_length = 0;\r\nwth->subtype_read = ber_read;\r\nwth->subtype_seek_read = ber_seek_read;\r\nwth->file_tsprec = WTAP_TSPREC_SEC;\r\nreturn WTAP_OPEN_MINE;\r\n}

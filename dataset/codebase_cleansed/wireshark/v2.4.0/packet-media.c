static int\r\ndissect_media(tvbuff_t *tvb, packet_info *pinfo , proto_tree *tree, void* data)\r\n{\r\nint bytes;\r\nproto_item *ti;\r\nproto_tree *media_tree = 0;\r\nhttp_message_info_t *message_info = (http_message_info_t *)data;\r\nheur_dtbl_entry_t *hdtbl_entry;\r\nif (dissector_try_heuristic(heur_subdissector_list, tvb, pinfo, tree, &hdtbl_entry, data)) {\r\nreturn tvb_reported_length(tvb);\r\n}\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " (%s)", (pinfo->match_string) ? pinfo->match_string : "");\r\nif (tree) {\r\nif ( (bytes = tvb_reported_length(tvb)) > 0 )\r\n{\r\nti = proto_tree_add_item(tree, proto_media, tvb, 0, -1, ENC_NA);\r\nmedia_tree = proto_item_add_subtree(ti, ett_media);\r\nif (message_info != NULL && message_info->media_str != NULL) {\r\nproto_tree_add_bytes_format_value(media_tree, hf_media_type, tvb, 0, bytes,\r\nNULL, "%s; %s (%d byte%s)",\r\npinfo->match_string, message_info->media_str,\r\nbytes, plurality(bytes, "", "s"));\r\n} else {\r\nproto_tree_add_bytes_format_value(media_tree, hf_media_type, tvb, 0, bytes,\r\nNULL, "%s (%d byte%s)",\r\npinfo->match_string ? pinfo->match_string : "",\r\nbytes, plurality(bytes, "", "s"));\r\n}\r\n}\r\n}\r\nreturn tvb_reported_length(tvb);\r\n}\r\nvoid\r\nproto_register_media(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_media_type,\r\n{ "Media type", "media.type",\r\nFT_BYTES, BASE_NONE, NULL, 0,\r\nNULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_media\r\n};\r\nproto_media = proto_register_protocol (\r\n"Media Type",\r\n"Media",\r\n"media"\r\n);\r\nregister_dissector("media", dissect_media, proto_media);\r\nheur_subdissector_list = register_heur_dissector_list("media", proto_media);\r\nproto_register_field_array(proto_media, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nproto_set_cant_toggle(proto_media);\r\n}

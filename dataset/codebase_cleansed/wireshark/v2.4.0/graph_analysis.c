static void graph_analysis_reset(graph_analysis_data_t *user_data)\r\n{\r\nint i;\r\nuser_data->graph_info->num_nodes = 0;\r\nuser_data->num_items = 0;\r\nfor (i=0; i<MAX_NUM_NODES; i++) {\r\nfree_address(&user_data->graph_info->nodes[i]);\r\n}\r\nuser_data->dlg.first_node = 0;\r\nuser_data->dlg.first_item = 0;\r\nuser_data->dlg.left_x_border = 0;\r\nuser_data->dlg.selected_item = 0xFFFFFFFF;\r\n}\r\nstatic void graph_analysis_init_dlg(graph_analysis_data_t *user_data)\r\n{\r\nint i;\r\nuser_data->graph_info->num_nodes = 0;\r\nuser_data->num_items = 0;\r\nuser_data->on_destroy_user_data = NULL;\r\nuser_data->data = NULL;\r\nfor (i=0; i<MAX_NUM_NODES; i++) {\r\nclear_address(&user_data->graph_info->nodes[i]);\r\n}\r\nuser_data->dlg.first_node = 0;\r\nuser_data->dlg.first_item = 0;\r\nuser_data->dlg.left_x_border = 0;\r\nuser_data->dlg.selected_item = 0xFFFFFFFF;\r\nuser_data->dlg.needs_redraw = TRUE;\r\nuser_data->dlg.draw_area_time = NULL;\r\nuser_data->dlg.draw_area = NULL;\r\nuser_data->dlg.draw_area_comments = NULL;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nuser_data->dlg.surface_main = NULL;\r\nuser_data->dlg.surface_time = NULL;\r\nuser_data->dlg.surface_comments = NULL;\r\n#else\r\nuser_data->dlg.pixmap_main = NULL;\r\nuser_data->dlg.pixmap_time = NULL;\r\nuser_data->dlg.pixmap_comments = NULL;\r\n#endif\r\nuser_data->dlg.v_scrollbar = NULL;\r\nuser_data->dlg.v_scrollbar_adjustment = NULL;\r\nuser_data->dlg.hpane = NULL;\r\nuser_data->dlg.surface_width = 350;\r\nuser_data->dlg.surface_height = 400;\r\nuser_data->dlg.first_node = 0;\r\nuser_data->dlg.first_item = 0;\r\nuser_data->dlg.left_x_border = 0;\r\nuser_data->dlg.selected_item = 0xFFFFFFFF;\r\nuser_data->dlg.window = NULL;\r\nuser_data->dlg.parent_w = NULL;\r\nuser_data->dlg.inverse = FALSE;\r\nuser_data->dlg.title = NULL;\r\n}\r\nstatic void on_destroy(GtkWidget *win _U_, graph_analysis_data_t *user_data)\r\n{\r\nint i;\r\nfor (i=0; i<MAX_NUM_NODES; i++) {\r\nfree_address(&user_data->graph_info->nodes[i]);\r\n}\r\nuser_data->dlg.window = NULL;\r\ng_free(user_data->dlg.title);\r\nuser_data->dlg.title = NULL;\r\nif(user_data->on_destroy_user_data) {\r\nuser_data->on_destroy_user_data(user_data->data);\r\n}\r\n}\r\nstatic void draw_arrow(cairo_surface_t *surface, GdkRGBA *color, gint x, gint y, gboolean arrow_type)\r\n{\r\ncairo_t *cr;\r\ncr = cairo_create (surface);\r\ngdk_cairo_set_source_rgba (cr, color);\r\nif (arrow_type == LEFT_ARROW)\r\n{\r\ncairo_move_to (cr, x + WIDTH_ARROW, y);\r\ncairo_line_to (cr, x + WIDTH_ARROW, y + HEIGHT_ARROW);\r\ncairo_line_to (cr, x, y + HEIGHT_ARROW / 2.);\r\n}\r\nelse if (arrow_type == RIGHT_ARROW)\r\n{\r\ncairo_move_to (cr, x, y);\r\ncairo_line_to (cr, x + WIDTH_ARROW, y + HEIGHT_ARROW / 2.);\r\ncairo_line_to (cr, x, y + HEIGHT_ARROW);\r\n}\r\ncairo_close_path (cr);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nstatic void draw_arrow(GdkDrawable *pixmap, GdkRGBA *color, gint x, gint y, gboolean arrow_type)\r\n{\r\ncairo_t *cr;\r\nif (GDK_IS_DRAWABLE(pixmap)) {\r\ncr = gdk_cairo_create (pixmap);\r\ngdk_cairo_set_source_rgba (cr, color);\r\nif (arrow_type == LEFT_ARROW)\r\n{\r\ncairo_move_to (cr, x + WIDTH_ARROW, y);\r\ncairo_line_to (cr, x + WIDTH_ARROW, y + HEIGHT_ARROW);\r\ncairo_line_to (cr, x, y + HEIGHT_ARROW / 2.);\r\n}\r\nelse if (arrow_type == RIGHT_ARROW)\r\n{\r\ncairo_move_to (cr, x, y);\r\ncairo_line_to (cr, x + WIDTH_ARROW, y + HEIGHT_ARROW / 2.);\r\ncairo_line_to (cr, x, y + HEIGHT_ARROW);\r\n}\r\ncairo_close_path (cr);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\n}\r\nstatic char *\r\ngtk_save_graph_as_plain_text_file(graph_analysis_data_t *user_data)\r\n{\r\nGtkWidget *save_to_file_w;\r\nchar *pathname;\r\nsave_to_file_w = file_selection_new("Wireshark: Save graph to plain text file",\r\nGTK_WINDOW(user_data->dlg.window),\r\nFILE_SELECTION_SAVE);\r\ngtk_dialog_set_default_response(GTK_DIALOG(save_to_file_w),\r\nGTK_RESPONSE_ACCEPT);\r\npathname = file_selection_run(save_to_file_w);\r\nif (pathname == NULL) {\r\nreturn NULL;\r\n}\r\nwindow_destroy(save_to_file_w);\r\nreturn pathname;\r\n}\r\nstatic void\r\non_save_bt_clicked (GtkWidget *button _U_,\r\ngraph_analysis_data_t *user_data)\r\n{\r\nchar *pathname;\r\nfor (;;) {\r\npathname = gtk_save_graph_as_plain_text_file(user_data);\r\nif (pathname == NULL) {\r\nbreak;\r\n}\r\nif (sequence_analysis_dump_to_file(pathname, user_data->graph_info, &cfile, user_data->dlg.first_node)) {\r\ng_free(pathname);\r\nbreak;\r\n}\r\ng_free(pathname);\r\n}\r\n}\r\nstatic void dialog_graph_draw(graph_analysis_data_t *user_data)\r\n{\r\nguint32 i, last_item, first_item, display_items;\r\nguint32 start_arrow, end_arrow, label_x, src_port_x, dst_port_x, arrow_width;\r\nguint32 current_item;\r\nguint32 left_x_border;\r\nguint32 right_x_border;\r\nguint32 top_y_border;\r\nguint32 bottom_y_border;\r\nseq_analysis_item_t *gai;\r\nPangoLayout *layout;\r\nPangoLayout *middle_layout;\r\nPangoLayout *small_layout;\r\nPangoFontDescription *middle_font_desc;\r\ngint middle_font_size;\r\nPangoFontDescription *small_font_desc;\r\ngint small_font_size;\r\ngint label_width, label_height;\r\nguint32 draw_width, draw_height;\r\nchar label_string[MAX_COMMENT];\r\nGList *list;\r\ncairo_t *cr;\r\n#if 0\r\nGdkColor *color_p, *bg_color_p;\r\nGdkColor black_color = {0, 0, 0, 0};\r\nGdkColor white_color = {0, 0xffff, 0xffff, 0xffff};\r\nGdkColor grey_color0 = {0, 0x64ff, 0x64ff, 0x64ff};\r\nGdkColor grey_color1 = {0, 0x25ff, 0x25ff, 0x25ff};\r\nstatic GdkColor background_color[MAX_NUM_COL_CONV+1] = {\r\n{0, 0x00FF, 0x00FF, 0xFFFF},\r\n{0, 0x90FF, 0xEEFF, 0x90FF},\r\n{0, 0xFFFF, 0xA0FF, 0x7AFF},\r\n{0, 0xFFFF, 0xB6FF, 0xC1FF},\r\n{0, 0xFAFF, 0xFAFF, 0xD2FF},\r\n{0, 0xFFFF, 0xFFFF, 0x33FF},\r\n{0, 0x66FF, 0xCDFF, 0xAAFF},\r\n{0, 0xE0FF, 0xFFFF, 0xFFFF},\r\n{0, 0xB0FF, 0xC4FF, 0xDEFF},\r\n{0, 0x87FF, 0xCEFF, 0xFAFF},\r\n{0, 0xD3FF, 0xD3FF, 0xD3FF}\r\n};\r\n#endif\r\nGdkRGBA *color_p, *bg_color_p;\r\nGdkRGBA black_color = {0.0, 0.0, 0.0, 1.0};\r\nGdkRGBA white_color = {1.0, 1.0, 1.0, 1.0 };\r\nGdkRGBA grey_color0 = {0.3945, 0.3945, 0.3945, 1.0};\r\nGdkRGBA grey_color1 = {0.1484, 0.1484, 0.1484, 1.0};\r\nGdkRGBA bg_color = {0.9137, 0.8901, 0.8705, 1.0};\r\nstatic GdkRGBA background_color[MAX_NUM_COL_CONV+1] = {\r\n{0.0039, 0.0039, 1.0000, 1.0},\r\n{0.5664, 0.9336, 0.5664, 1.0},\r\n{1.0000, 0.6289, 0.4805, 1.0},\r\n{1.0000, 0.7148, 0.7578, 1.0},\r\n{0.9805, 0.9805, 0.8242, 1.0},\r\n{1.0000, 1.0000, 0.2031, 1.0},\r\n{0.4023, 0.8046, 0.6680, 1.0},\r\n{0.8789, 1.0000, 1.0000, 1.0},\r\n{0.6914, 0.7695, 0.8710, 1.0},\r\n{0.5312, 0.8086, 0.9957, 1.0},\r\n{0.8281, 0.8281, 0.8281, 1.0}\r\n};\r\nstatic const double dashed1[] = {5.0, 4.0};\r\nstatic int len1 = sizeof(dashed1) / sizeof(dashed1[0]);\r\nGtkAllocation draw_area_time_alloc, draw_area_alloc, draw_area_comments_alloc;\r\nif (!user_data->dlg.needs_redraw) {\r\nreturn;\r\n}\r\nuser_data->dlg.needs_redraw = FALSE;\r\nif (g_queue_get_length(user_data->graph_info->items) < 1) {\r\nreturn;\r\n}\r\ngtk_widget_get_allocation(user_data->dlg.draw_area_time, &draw_area_time_alloc);\r\ngtk_widget_get_allocation(user_data->dlg.draw_area, &draw_area_alloc);\r\ngtk_widget_get_allocation(user_data->dlg.draw_area_comments, &draw_area_comments_alloc);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_time);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_rectangle (cr, 0, 0, draw_area_time_alloc.width, draw_area_time_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_rectangle (cr, 0, 0, draw_area_alloc.width, draw_area_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = cairo_create (user_data->dlg.surface_comments);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_rectangle (cr, 0, 0, draw_area_comments_alloc.width, draw_area_comments_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n#else\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_time) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_time);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_rectangle (cr, 0, 0, draw_area_time_alloc.width, draw_area_time_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_rectangle (cr, 0, 0, draw_area_alloc.width, draw_area_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_comments) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_comments);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_rectangle (cr, 0, 0, draw_area_comments_alloc.width, draw_area_comments_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\n#endif\r\ntop_y_border = TOP_Y_BORDER;\r\nbottom_y_border = BOTTOM_Y_BORDER;\r\ndraw_height = draw_area_alloc.height-top_y_border-bottom_y_border;\r\nfirst_item = user_data->dlg.first_item;\r\ndisplay_items = draw_height/ITEM_HEIGHT;\r\nlist = g_queue_peek_nth_link(user_data->graph_info->items, 0);\r\ncurrent_item = 0;\r\ni = 0;\r\nwhile (list)\r\n{\r\ngai = (seq_analysis_item_t *)list->data;\r\nif (gai->display) {\r\nif (current_item>=display_items) break;\r\nif (i>=first_item) {\r\nuser_data->dlg.items[current_item].frame_number = gai->frame_number;\r\nuser_data->dlg.items[current_item].port_src = gai->port_src;\r\nuser_data->dlg.items[current_item].port_dst = gai->port_dst;\r\nuser_data->dlg.items[current_item].frame_label = gai->frame_label;\r\nuser_data->dlg.items[current_item].time_str = gai->time_str;\r\nuser_data->dlg.items[current_item].comment = gai->comment;\r\nuser_data->dlg.items[current_item].conv_num = gai->conv_num;\r\nuser_data->dlg.items[current_item].src_node = gai->src_node;\r\nuser_data->dlg.items[current_item].dst_node = gai->dst_node;\r\nuser_data->dlg.items[current_item].line_style = gai->line_style;\r\ncurrent_item++;\r\n}\r\ni++;\r\n}\r\nlist = g_list_next(list);\r\n}\r\nif ((first_item + display_items) > user_data->num_items) {\r\nif (display_items>user_data->num_items)\r\nfirst_item = 0;\r\nelse\r\nfirst_item = user_data->num_items - display_items;\r\n}\r\ndisplay_items = current_item;\r\nlast_item = first_item+display_items-1;\r\nuser_data->dlg.last_item = last_item;\r\n#if 0\r\ng_snprintf(label_string, MAX_LABEL, "%.3f", nstime_to_sec(&user_data->dlg.items[display_items-1].fd->rel_ts));\r\n#endif\r\ng_snprintf(label_string, MAX_LABEL, "%s", user_data->dlg.items[display_items-1].time_str);\r\nlayout = gtk_widget_create_pango_layout(user_data->dlg.draw_area_time, label_string);\r\nmiddle_layout = gtk_widget_create_pango_layout(user_data->dlg.draw_area_time, label_string);\r\nsmall_layout = gtk_widget_create_pango_layout(user_data->dlg.draw_area_time, label_string);\r\nmiddle_font_desc = pango_font_description_copy(pango_context_get_font_description(pango_layout_get_context(middle_layout)));\r\nmiddle_font_size = pango_font_description_get_size(middle_font_desc);\r\npango_font_description_set_size(middle_font_desc, (gint)(middle_font_size*0.8));\r\npango_layout_set_font_description(middle_layout, middle_font_desc);\r\nsmall_font_desc = pango_font_description_copy(pango_context_get_font_description(pango_layout_get_context(small_layout)));\r\nsmall_font_size = pango_font_description_get_size(small_font_desc);\r\npango_font_description_set_size(small_font_desc, (gint)(small_font_size*0.7));\r\npango_layout_set_font_description(small_layout, small_font_desc);\r\npango_layout_get_pixel_size(layout, &label_width, &label_height);\r\nleft_x_border = 0;\r\nuser_data->dlg.left_x_border = left_x_border;\r\nright_x_border = 0;\r\ndraw_width = user_data->dlg.surface_width-right_x_border-left_x_border;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_time);\r\ngdk_cairo_set_source_rgba (cr, &bg_color);\r\ncairo_rectangle (cr, 0, 0, draw_area_time_alloc.width, top_y_border);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ngdk_cairo_set_source_rgba (cr, &bg_color);\r\ncairo_rectangle (cr, 0, 0, draw_area_alloc.width, top_y_border);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = cairo_create (user_data->dlg.surface_comments);\r\ngdk_cairo_set_source_rgba (cr, &bg_color);\r\ncairo_rectangle (cr, 0, 0, draw_area_comments_alloc.width, top_y_border);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n#else\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_time) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_time);\r\ngdk_cairo_set_source_rgba (cr, &bg_color);\r\ncairo_rectangle (cr, 0, 0, draw_area_time_alloc.width, top_y_border);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ngdk_cairo_set_source_rgba (cr, &bg_color);\r\ncairo_rectangle (cr, 0, 0, draw_area_alloc.width, top_y_border);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_comments) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_comments);\r\ngdk_cairo_set_source_rgba (cr, &bg_color);\r\ncairo_rectangle (cr, 0, 0, draw_area_comments_alloc.width, top_y_border);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\n#endif\r\ng_snprintf(label_string, label_width, "%s", " Time");\r\npango_layout_set_text(layout, label_string, -1);\r\npango_layout_get_pixel_size(layout, &label_width, &label_height);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_time);\r\ncairo_move_to (cr, left_x_border, top_y_border/2-label_height/2);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_time)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_time);\r\ncairo_move_to (cr, left_x_border, top_y_border/2-label_height/2);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\ng_snprintf(label_string, label_width, "%s", "Comment");\r\npango_layout_set_text(layout, label_string, -1);\r\npango_layout_get_pixel_size(layout, &label_width, &label_height);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_comments);\r\ncairo_move_to (cr, MAX_COMMENT/2-label_width/2, top_y_border/2-label_height/2);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_comments)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_comments);\r\ncairo_move_to (cr, MAX_COMMENT/2-label_width/2, top_y_border/2-label_height/2);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\nfor (current_item=0; current_item<display_items; current_item++) {\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\nbg_color_p = &background_color[0];\r\n} else {\r\nbg_color_p = &background_color[1+user_data->dlg.items[current_item].conv_num%MAX_NUM_COL_CONV];\r\n}\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ngdk_cairo_set_source_rgba (cr, bg_color_p);\r\ncairo_rectangle (cr, left_x_border, top_y_border+current_item*ITEM_HEIGHT, draw_width, ITEM_HEIGHT);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ngdk_cairo_set_source_rgba (cr, bg_color_p);\r\ncairo_rectangle (cr, left_x_border, top_y_border+current_item*ITEM_HEIGHT, draw_width, ITEM_HEIGHT);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\n#endif\r\n}\r\nfor (i=0; i<user_data->graph_info->num_nodes; i++) {\r\nchar* addr_str;\r\naddr_str = address_to_display(NULL, &(user_data->graph_info->nodes[i]));\r\ng_strlcpy(label_string, addr_str, NODE_WIDTH/5);\r\nwmem_free(NULL, addr_str);\r\npango_layout_set_text(layout, label_string, -1);\r\npango_layout_get_pixel_size(layout, &label_width, &label_height);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ncairo_move_to (cr, left_x_border+NODE_WIDTH/2-label_width/2+NODE_WIDTH*i, top_y_border/2-((i&1)?0:label_height));\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ncairo_move_to (cr, left_x_border+NODE_WIDTH/2-label_width/2+NODE_WIDTH*i, top_y_border/2-((i&1)?0:label_height));\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\ncairo_set_line_width (cr, 1.0);\r\ncairo_set_line_cap(cr, CAIRO_LINE_CAP_BUTT);\r\ncairo_set_dash(cr, dashed1, len1, 0);\r\ncairo_move_to(cr, left_x_border+NODE_WIDTH/2+NODE_WIDTH*i, top_y_border);\r\ncairo_line_to(cr, (left_x_border+NODE_WIDTH/2+NODE_WIDTH*i), draw_area_alloc.height-bottom_y_border);\r\ncairo_stroke(cr);\r\ncairo_destroy(cr);\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\ncairo_set_line_width (cr, 1.0);\r\ncairo_set_line_cap(cr, CAIRO_LINE_CAP_BUTT);\r\ncairo_set_dash(cr, dashed1, len1, 0);\r\ncairo_move_to(cr, left_x_border+NODE_WIDTH/2+NODE_WIDTH*i, top_y_border);\r\ncairo_line_to(cr, (left_x_border+NODE_WIDTH/2+NODE_WIDTH*i), draw_area_alloc.height-bottom_y_border);\r\ncairo_stroke(cr);\r\ncairo_destroy(cr);\r\n}\r\n#endif\r\n}\r\nfor (current_item=0; current_item<display_items; current_item++) {\r\n#if 0\r\ng_snprintf(label_string, MAX_LABEL, "%.3f", nstime_to_sec(&user_data->dlg.items[current_item].fd->rel_ts));\r\n#endif\r\ng_snprintf(label_string, MAX_LABEL, "%s", user_data->dlg.items[current_item].time_str);\r\npango_layout_set_text(layout, label_string, -1);\r\npango_layout_get_pixel_size(layout, &label_width, &label_height);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_time);\r\ncairo_move_to (cr, 3, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT/2-label_height/2);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_time)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_time);\r\ncairo_move_to (cr, 3, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT/2-label_height/2);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\ng_snprintf(label_string, MAX_COMMENT, "%s", user_data->dlg.items[current_item].comment);\r\npango_layout_set_text(middle_layout, label_string, -1);\r\npango_layout_get_pixel_size(middle_layout, &label_width, &label_height);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_comments);\r\ncairo_move_to (cr, 2, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT/2-label_height/2);\r\npango_cairo_show_layout (cr, middle_layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_comments)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_comments);\r\ncairo_move_to (cr, 2, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT/2-label_height/2);\r\npango_cairo_show_layout (cr, middle_layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\nstart_arrow = left_x_border+(user_data->dlg.items[current_item].src_node)*NODE_WIDTH+NODE_WIDTH/2;\r\nend_arrow = left_x_border+(user_data->dlg.items[current_item].dst_node)*NODE_WIDTH+NODE_WIDTH/2;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\nif (user_data->dlg.items[current_item].line_style == 2) {\r\ncairo_set_line_width (cr, 2.0);\r\n}else{\r\ncairo_set_line_width (cr, 1.0);\r\n}\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\n}else{\r\ncairo_set_source_rgb (cr, 0, 0, 0);\r\n}\r\ncairo_move_to(cr, start_arrow, (top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7)+0.5);\r\ncairo_line_to(cr, end_arrow, (top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7)+0.5);\r\ncairo_stroke(cr);\r\ncairo_destroy(cr);\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\nif (user_data->dlg.items[current_item].line_style == 2) {\r\ncairo_set_line_width (cr, 2.0);\r\n}else{\r\ncairo_set_line_width (cr, 1.0);\r\n}\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\n}else{\r\ncairo_set_source_rgb (cr, 0, 0, 0);\r\n}\r\ncairo_move_to(cr, start_arrow, (top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7)+0.5);\r\ncairo_line_to(cr, end_arrow, (top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7)+0.5);\r\ncairo_stroke(cr);\r\ncairo_destroy(cr);\r\n}\r\n#endif\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ncolor_p = &white_color;\r\n} else {\r\ncolor_p = &black_color;\r\n}\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nif (start_arrow<end_arrow)\r\ndraw_arrow(user_data->dlg.surface_main, color_p, end_arrow-WIDTH_ARROW, (top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7)-(HEIGHT_ARROW/2), RIGHT_ARROW);\r\nelse\r\ndraw_arrow(user_data->dlg.surface_main, color_p, end_arrow, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7-(HEIGHT_ARROW/2), LEFT_ARROW);\r\n#else\r\nif (start_arrow<end_arrow)\r\ndraw_arrow(user_data->dlg.pixmap_main, color_p, end_arrow-WIDTH_ARROW, (top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7)-(HEIGHT_ARROW/2), RIGHT_ARROW);\r\nelse\r\ndraw_arrow(user_data->dlg.pixmap_main, color_p, end_arrow, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-7-(HEIGHT_ARROW/2), LEFT_ARROW);\r\n#endif\r\nif (start_arrow<end_arrow) {\r\narrow_width = end_arrow-start_arrow;\r\nlabel_x = arrow_width/2+start_arrow;\r\n}\r\nelse {\r\narrow_width = start_arrow-end_arrow;\r\nlabel_x = arrow_width/2+end_arrow;\r\n}\r\n#if PANGO_VERSION_CHECK(1,6,0)\r\npango_layout_set_ellipsize(layout, PANGO_ELLIPSIZE_END);\r\npango_layout_set_width(layout, arrow_width * PANGO_SCALE);\r\npango_layout_set_text(layout, user_data->dlg.items[current_item].frame_label, -1);\r\n#else\r\nif (g_snprintf(label_string, MAX_FRAME_LABEL, "%s", user_data->dlg.items[current_item].frame_label) > MAX_FRAME_LABEL) {\r\nmemcpy(&label_string[MAX_FRAME_LABEL-4], "...", 3);\r\n}\r\npango_layout_set_text(layout, label_string, -1);\r\n#endif\r\npango_layout_get_pixel_size(layout, &label_width, &label_height);\r\nif ((int)left_x_border > ((int)label_x-(int)label_width/2))\r\nlabel_x = left_x_border + label_width/2;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ngdk_cairo_set_source_rgba (cr, color_p);\r\ncairo_move_to (cr, label_x - label_width/2, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT/2-label_height/2-3);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ngdk_cairo_set_source_rgba (cr, color_p);\r\ncairo_move_to (cr, label_x - label_width/2, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT/2-label_height/2-3);\r\npango_cairo_show_layout (cr, layout);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\n#if PANGO_VERSION_CHECK(1,6,0)\r\npango_layout_set_width(layout, -1);\r\n#endif\r\ng_snprintf(label_string, MAX_LABEL, "(%i)", user_data->dlg.items[current_item].port_src);\r\npango_layout_set_text(small_layout, label_string, -1);\r\npango_layout_get_pixel_size(small_layout, &label_width, &label_height);\r\nif (start_arrow<end_arrow) {\r\nsrc_port_x = start_arrow - label_width - 2;\r\n}\r\nelse {\r\nsrc_port_x = start_arrow + 2;\r\n}\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ngdk_cairo_set_source_rgba (cr, &grey_color1);\r\n} else {\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\n}\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\ncairo_move_to (cr, src_port_x, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-2-label_height/2-2);\r\npango_cairo_show_layout (cr, small_layout);\r\ncairo_destroy (cr);\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ngdk_cairo_set_source_rgba (cr, &grey_color1);\r\n} else {\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\n}\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\ncairo_move_to (cr, src_port_x, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-2-label_height/2-2);\r\npango_cairo_show_layout (cr, small_layout);\r\ncairo_destroy (cr);\r\n}\r\n#endif\r\ng_snprintf(label_string, MAX_LABEL, "(%i)", user_data->dlg.items[current_item].port_dst);\r\npango_layout_set_text(small_layout, label_string, -1);\r\npango_layout_get_pixel_size(small_layout, &label_width, &label_height);\r\nif (start_arrow<end_arrow) {\r\ndst_port_x = end_arrow + 2;\r\n}\r\nelse {\r\ndst_port_x = end_arrow - label_width - 2;\r\n}\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ngdk_cairo_set_source_rgba (cr, &grey_color1);\r\n} else {\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\n}\r\ncairo_move_to (cr, dst_port_x, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-2-label_height/2-2);\r\npango_cairo_show_layout (cr, small_layout);\r\ncairo_destroy (cr);\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main)) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\nif ( current_item+first_item == user_data->dlg.selected_item ) {\r\ngdk_cairo_set_source_rgba (cr, &grey_color1);\r\n} else {\r\ngdk_cairo_set_source_rgba (cr, &grey_color0);\r\n}\r\ncairo_move_to (cr, dst_port_x, top_y_border+current_item*ITEM_HEIGHT+ITEM_HEIGHT-2-label_height/2-2);\r\npango_cairo_show_layout (cr, small_layout);\r\ncairo_destroy (cr);\r\n}\r\n#endif\r\nif ( current_item+first_item == user_data->dlg.selected_item )\r\nfor (i=0; i<user_data->graph_info->num_nodes; i++) {\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ngdk_cairo_set_source_rgba (cr, &grey_color1);\r\ncairo_set_line_width (cr, 1.0);\r\ncairo_set_line_cap(cr, CAIRO_LINE_CAP_BUTT);\r\ncairo_set_dash(cr, dashed1, len1, 0);\r\ncairo_move_to(cr, left_x_border+NODE_WIDTH/2+NODE_WIDTH*i, (user_data->dlg.selected_item-first_item)*ITEM_HEIGHT+TOP_Y_BORDER);\r\ncairo_line_to(cr, (left_x_border+NODE_WIDTH/2+NODE_WIDTH*i), (user_data->dlg.selected_item-first_item)*ITEM_HEIGHT+TOP_Y_BORDER+ITEM_HEIGHT);\r\ncairo_stroke(cr);\r\ncairo_destroy(cr);\r\n#else\r\nif (GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ngdk_cairo_set_source_rgba (cr, &grey_color1);\r\ncairo_set_line_width (cr, 1.0);\r\ncairo_set_line_cap(cr, CAIRO_LINE_CAP_BUTT);\r\ncairo_set_dash(cr, dashed1, len1, 0);\r\ncairo_move_to(cr, left_x_border+NODE_WIDTH/2+NODE_WIDTH*i, (user_data->dlg.selected_item-first_item)*ITEM_HEIGHT+TOP_Y_BORDER);\r\ncairo_line_to(cr, (left_x_border+NODE_WIDTH/2+NODE_WIDTH*i), (user_data->dlg.selected_item-first_item)*ITEM_HEIGHT+TOP_Y_BORDER+ITEM_HEIGHT);\r\ncairo_stroke(cr);\r\ncairo_destroy(cr);\r\n}\r\n#endif\r\n}\r\n}\r\ng_object_unref(G_OBJECT(layout));\r\nif (gtk_widget_is_drawable(user_data->dlg.draw_area_time) ) {\r\ncr = gdk_cairo_create (gtk_widget_get_window(user_data->dlg.draw_area_time));\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_time, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_time, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, draw_area_time_alloc.width, draw_area_time_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\nif (gtk_widget_is_drawable(user_data->dlg.draw_area) ) {\r\ncr = gdk_cairo_create (gtk_widget_get_window(user_data->dlg.draw_area));\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_main, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_main, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, draw_area_alloc.width, draw_area_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\nif (gtk_widget_is_drawable(user_data->dlg.draw_area_comments) ) {\r\ncr = gdk_cairo_create (gtk_widget_get_window(user_data->dlg.draw_area_comments));\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_comments, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_comments, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, draw_area_comments_alloc.width, draw_area_comments_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\ngtk_adjustment_set_upper(user_data->dlg.v_scrollbar_adjustment, (gdouble) user_data->num_items-1);\r\ngtk_adjustment_set_step_increment(user_data->dlg.v_scrollbar_adjustment, 1);\r\ngtk_adjustment_set_page_increment(user_data->dlg.v_scrollbar_adjustment, (gdouble) (last_item-first_item));\r\ngtk_adjustment_set_page_size(user_data->dlg.v_scrollbar_adjustment, (gdouble) (last_item-first_item));\r\ngtk_adjustment_set_value(user_data->dlg.v_scrollbar_adjustment, (gdouble) first_item);\r\ngtk_adjustment_changed(user_data->dlg.v_scrollbar_adjustment);\r\ngtk_adjustment_value_changed(user_data->dlg.v_scrollbar_adjustment);\r\n}\r\nstatic void dialog_graph_redraw(graph_analysis_data_t *user_data)\r\n{\r\nuser_data->dlg.needs_redraw = TRUE;\r\ndialog_graph_draw(user_data);\r\n}\r\nstatic gboolean button_press_event(GtkWidget *widget _U_, GdkEventButton *event, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nguint32 item;\r\nif (event->type != GDK_BUTTON_PRESS) return TRUE;\r\nif (event->y<TOP_Y_BORDER) return TRUE;\r\nitem = ((guint32)event->y - TOP_Y_BORDER) / ITEM_HEIGHT;\r\nif (item > (user_data->dlg.last_item - user_data->dlg.first_item)) return TRUE;\r\nuser_data->dlg.selected_item = item + user_data->dlg.first_item;\r\nuser_data->dlg.needs_redraw = TRUE;\r\ndialog_graph_draw(user_data);\r\ncf_goto_frame(&cfile, user_data->dlg.items[item].frame_number);\r\nreturn TRUE;\r\n}\r\nstatic gboolean key_press_event(GtkWidget *widget _U_, GdkEventKey *event, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nif (user_data->dlg.selected_item == 0xFFFFFFFF) return TRUE;\r\nif (event->keyval == GDK_Up) {\r\nif (user_data->dlg.selected_item == 0) return TRUE;\r\nuser_data->dlg.selected_item--;\r\nif ( (user_data->dlg.selected_item<user_data->dlg.first_item) || (user_data->dlg.selected_item>user_data->dlg.first_item+gtk_adjustment_get_page_size(user_data->dlg.v_scrollbar_adjustment)) )\r\nuser_data->dlg.first_item = user_data->dlg.selected_item;\r\n} else if (event->keyval == GDK_Down) {\r\nif (user_data->dlg.selected_item == user_data->num_items-1) return TRUE;\r\nuser_data->dlg.selected_item++;\r\nif ( (user_data->dlg.selected_item<user_data->dlg.first_item) || (user_data->dlg.selected_item>user_data->dlg.first_item+gtk_adjustment_get_page_size(user_data->dlg.v_scrollbar_adjustment)) )\r\nuser_data->dlg.first_item = (guint32)user_data->dlg.selected_item-(guint32)gtk_adjustment_get_page_size(user_data->dlg.v_scrollbar_adjustment);\r\n} else if (event->keyval == GDK_Left) {\r\nif (user_data->dlg.first_node == 0) return TRUE;\r\nuser_data->dlg.first_node--;\r\n} else return TRUE;\r\nuser_data->dlg.needs_redraw = TRUE;\r\ndialog_graph_draw(user_data);\r\ncf_goto_frame(&cfile, user_data->dlg.items[user_data->dlg.selected_item-user_data->dlg.first_item].frame_number);\r\nreturn TRUE;\r\n}\r\nstatic gboolean draw_area_draw(GtkWidget *widget, cairo_t *cr, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation allocation;\r\ngtk_widget_get_allocation (widget, &allocation);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_main, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_main, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, allocation.width, allocation.height);\r\ncairo_fill (cr);\r\nreturn FALSE;\r\n}\r\nstatic gboolean expose_event(GtkWidget *widget, GdkEventExpose *event _U_, gpointer data)\r\n{\r\nGtkAllocation allocation;\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\ncairo_t *cr = gdk_cairo_create (gtk_widget_get_window(widget));\r\nif (gtk_widget_is_drawable(widget)) {\r\ngtk_widget_get_allocation (widget, &allocation);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_main, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_main, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, allocation.width, allocation.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ndraw_area_scrolled(GtkAdjustment *adjustment _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\ncairo_t *cr = gdk_cairo_create (gtk_widget_get_window(user_data->dlg.draw_area));\r\ndraw_area_draw(user_data->dlg.draw_area, cr, data);\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nmouse_scrolled(GtkWidget *widget _U_, GdkEventScroll *event, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkWidget *scroll_window;\r\nGtkAdjustment *adjustment;\r\ngdouble v_scroll_items;\r\nGtkAllocation draw_area_alloc, scroll_window_alloc;\r\nif (event->direction == GDK_SCROLL_UP) {\r\nadjustment = user_data->dlg.v_scrollbar_adjustment;\r\nv_scroll_items = pow(gtk_adjustment_get_page_size(adjustment), 2.0/3.0);\r\nif ((gtk_adjustment_get_value(adjustment) - v_scroll_items) <= 0.0) {\r\ngtk_adjustment_set_value(adjustment, 0.0);\r\n}\r\nelse {\r\ngtk_adjustment_set_value(adjustment, gtk_adjustment_get_value(adjustment) - v_scroll_items);\r\n}\r\n}\r\nelse if (event->direction == GDK_SCROLL_DOWN) {\r\nadjustment = user_data->dlg.v_scrollbar_adjustment;\r\nv_scroll_items = pow (gtk_adjustment_get_page_size(adjustment), 2.0/3.0);\r\nif ((gtk_adjustment_get_value(adjustment) + v_scroll_items) >= (user_data->num_items - gtk_adjustment_get_page_size(adjustment) - 1)) {\r\ngtk_adjustment_set_value(adjustment, (user_data->num_items - gtk_adjustment_get_page_size(adjustment) - 1));\r\n}\r\nelse {\r\ngtk_adjustment_set_value(adjustment, gtk_adjustment_get_value(adjustment) + v_scroll_items);\r\n}\r\n}\r\nelse if (event->direction == GDK_SCROLL_LEFT) {\r\nif (widget == user_data->dlg.scroll_window) {\r\nscroll_window = user_data->dlg.scroll_window;\r\n}\r\nelse if (widget == user_data->dlg.scroll_window_comments) {\r\nscroll_window = user_data->dlg.scroll_window_comments;\r\n}\r\nelse return TRUE;\r\nadjustment = gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(scroll_window));\r\nif ((gtk_adjustment_get_value(adjustment) - gtk_adjustment_get_step_increment(adjustment)) <= 0.0) {\r\ngtk_adjustment_set_value(adjustment, 0.0);\r\n}\r\nelse {\r\ngtk_adjustment_set_value(adjustment, gtk_adjustment_get_value(adjustment) - gtk_adjustment_get_step_increment(adjustment));\r\n}\r\ngtk_scrolled_window_set_hadjustment(GTK_SCROLLED_WINDOW(scroll_window), adjustment);\r\n}\r\nelse if (event->direction == GDK_SCROLL_RIGHT) {\r\nif (widget == user_data->dlg.scroll_window) {\r\nscroll_window = user_data->dlg.scroll_window;\r\ngtk_widget_get_allocation(user_data->dlg.draw_area, &draw_area_alloc);\r\ngtk_widget_get_allocation(user_data->dlg.scroll_window, &scroll_window_alloc);\r\n}\r\nelse if (widget == user_data->dlg.scroll_window_comments) {\r\nscroll_window = user_data->dlg.scroll_window_comments;\r\ngtk_widget_get_allocation(user_data->dlg.draw_area_comments, &draw_area_alloc);\r\ngtk_widget_get_allocation(user_data->dlg.scroll_window_comments, &scroll_window_alloc);\r\n}\r\nelse return TRUE;\r\nadjustment = gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(scroll_window));\r\nif ((gtk_adjustment_get_value(adjustment) + gtk_adjustment_get_step_increment(adjustment)) >= (draw_area_alloc.width - scroll_window_alloc.width)) {\r\ngtk_adjustment_set_value(adjustment, (draw_area_alloc.width - scroll_window_alloc.width));\r\n}\r\nelse {\r\ngtk_adjustment_set_value(adjustment, gtk_adjustment_get_value(adjustment) + gtk_adjustment_get_step_increment(adjustment));\r\n}\r\ngtk_scrolled_window_set_hadjustment(GTK_SCROLLED_WINDOW(scroll_window), adjustment);\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean draw_comments(GtkWidget *widget, cairo_t *cr, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation allocation;\r\ngtk_widget_get_allocation (widget, &allocation);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_comments, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_comments, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, allocation.width, allocation.height);\r\ncairo_fill (cr);\r\nreturn FALSE;\r\n}\r\nstatic gboolean expose_event_comments(GtkWidget *widget, GdkEventExpose *event _U_, gpointer data)\r\n{\r\nGtkAllocation allocation;\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\ncairo_t *cr = gdk_cairo_create (gtk_widget_get_window(widget));\r\nif (gtk_widget_is_drawable(widget)) {\r\ngtk_widget_get_allocation (widget, &allocation);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_comments, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_comments, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, allocation.width, allocation.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ncomments_area_scrolled(GtkAdjustment *adjustment _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\ncairo_t *cr = gdk_cairo_create (gtk_widget_get_window(user_data->dlg.draw_area_comments));\r\ndraw_comments(user_data->dlg.draw_area_comments, cr, data);\r\nreturn TRUE;\r\n}\r\nstatic gboolean draw_time(GtkWidget *widget, cairo_t *cr, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation allocation;\r\ngtk_widget_get_allocation (widget, &allocation);\r\ncairo_set_source_surface (cr, user_data->dlg.surface_time, 0, 0);\r\ncairo_rectangle (cr, 0, 0, allocation.width, allocation.height);\r\ncairo_fill (cr);\r\nreturn FALSE;\r\n}\r\nstatic gboolean expose_event_time(GtkWidget *widget, GdkEventExpose *event _U_, gpointer data)\r\n{\r\nGtkAllocation allocation;\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\ncairo_t *cr = gdk_cairo_create (gtk_widget_get_window(widget));\r\nif (gtk_widget_is_drawable(widget) ) {\r\ngtk_widget_get_allocation (widget, &allocation);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_time, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_time, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, allocation.width, allocation.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean configure_event(GtkWidget *widget, GdkEventConfigure *event _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation widget_alloc;\r\ncairo_t *cr;\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nif(user_data->dlg.surface_main) {\r\ncairo_surface_destroy (user_data->dlg.surface_main);\r\nuser_data->dlg.surface_main = NULL;\r\n}\r\n#else\r\nif(user_data->dlg.pixmap_main) {\r\ng_object_unref(user_data->dlg.pixmap_main);\r\nuser_data->dlg.pixmap_main = NULL;\r\n}\r\n#endif\r\ngtk_widget_get_allocation(widget, &widget_alloc);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nuser_data->dlg.surface_main = gdk_window_create_similar_surface (gtk_widget_get_window(widget),\r\nCAIRO_CONTENT_COLOR,\r\nwidget_alloc.width,\r\nwidget_alloc.height);\r\ncr = cairo_create (user_data->dlg.surface_main);\r\ncairo_rectangle (cr, 0, 0, widget_alloc.width, widget_alloc.height);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nuser_data->dlg.pixmap_main = gdk_pixmap_new(gtk_widget_get_window(widget),\r\nwidget_alloc.width,\r\nwidget_alloc.height,\r\n-1);\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_main);\r\ncairo_rectangle (cr, 0, 0, widget_alloc.width, widget_alloc.height);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\ndialog_graph_redraw(user_data);\r\nreturn TRUE;\r\n}\r\nstatic gboolean configure_event_comments(GtkWidget *widget, GdkEventConfigure *event _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation widget_alloc;\r\ncairo_t *cr;\r\ngtk_widget_get_allocation(widget, &widget_alloc);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nif(user_data->dlg.surface_comments) {\r\ncairo_surface_destroy (user_data->dlg.surface_comments);\r\nuser_data->dlg.surface_comments = NULL;\r\n}\r\n#else\r\nif(user_data->dlg.pixmap_comments) {\r\ng_object_unref(user_data->dlg.pixmap_comments);\r\nuser_data->dlg.pixmap_comments = NULL;\r\n}\r\n#endif\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nuser_data->dlg.surface_comments = gdk_window_create_similar_surface (gtk_widget_get_window(widget),\r\nCAIRO_CONTENT_COLOR,\r\nwidget_alloc.width,\r\nwidget_alloc.height);\r\ncr = cairo_create (user_data->dlg.surface_comments);\r\ncairo_rectangle (cr, 0, 0, widget_alloc.width, widget_alloc.height);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nuser_data->dlg.pixmap_comments = gdk_pixmap_new(gtk_widget_get_window(widget),\r\nwidget_alloc.width,\r\nwidget_alloc.height,\r\n-1);\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_main) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_comments);\r\ncairo_rectangle (cr, 0, 0, widget_alloc.width, widget_alloc.height);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\ndialog_graph_redraw(user_data);\r\nreturn TRUE;\r\n}\r\nstatic gboolean configure_event_time(GtkWidget *widget, GdkEventConfigure *event _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation widget_alloc;\r\ncairo_t *cr;\r\ngtk_widget_get_allocation(widget, &widget_alloc);\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nif(user_data->dlg.surface_time) {\r\ncairo_surface_destroy (user_data->dlg.surface_time);\r\nuser_data->dlg.surface_time = NULL;\r\n}\r\n#else\r\nif(user_data->dlg.pixmap_time) {\r\ng_object_unref(user_data->dlg.pixmap_time);\r\nuser_data->dlg.pixmap_time = NULL;\r\n}\r\n#endif\r\n#if GTK_CHECK_VERSION(2,22,0)\r\nuser_data->dlg.surface_time = gdk_window_create_similar_surface(gtk_widget_get_window(widget),\r\nCAIRO_CONTENT_COLOR,\r\nwidget_alloc.width,\r\nwidget_alloc.height);\r\ncr = cairo_create (user_data->dlg.surface_time);\r\ncairo_rectangle (cr, 0, 0, widget_alloc.width, widget_alloc.height);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n#else\r\nuser_data->dlg.pixmap_time = gdk_pixmap_new(gtk_widget_get_window(widget),\r\nwidget_alloc.width,\r\nwidget_alloc.height,\r\n-1);\r\nif ( GDK_IS_DRAWABLE(user_data->dlg.pixmap_time) ) {\r\ncr = gdk_cairo_create (user_data->dlg.pixmap_time);\r\ncairo_rectangle (cr, 0, 0, widget_alloc.width, widget_alloc.height);\r\ncairo_set_source_rgb (cr, 1, 1, 1);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\ncr = NULL;\r\n}\r\n#endif\r\ndialog_graph_redraw(user_data);\r\nreturn TRUE;\r\n}\r\nstatic gboolean pane_callback(GtkWidget *widget _U_, GParamSpec *pspec _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nGtkAllocation draw_area_comments_alloc, draw_area_alloc;\r\ncairo_t *cr;\r\n#if 0\r\nif (gtk_paned_get_position(GTK_PANED(user_data->dlg.hpane)) > user_data->dlg.surface_width)\r\ngtk_paned_set_position(GTK_PANED(user_data->dlg.hpane), user_data->dlg.surface_width);\r\nelse if (gtk_paned_get_position(GTK_PANED(user_data->dlg.hpane)) < NODE_WIDTH*2)\r\ngtk_paned_set_position(GTK_PANED(user_data->dlg.hpane), NODE_WIDTH*2);\r\n#endif\r\ngtk_widget_get_allocation(user_data->dlg.draw_area_comments, &draw_area_comments_alloc);\r\nif (gtk_widget_is_drawable(user_data->dlg.draw_area_comments)) {\r\ncr = gdk_cairo_create (gtk_widget_get_window(user_data->dlg.draw_area_comments));\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_comments, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_comments, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, draw_area_comments_alloc.width, draw_area_comments_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\ngtk_widget_get_allocation(user_data->dlg.draw_area, &draw_area_alloc);\r\nif (gtk_widget_is_drawable(user_data->dlg.draw_area)) {\r\ncr = gdk_cairo_create(gtk_widget_get_window(user_data->dlg.draw_area));\r\n#if GTK_CHECK_VERSION(2,22,0)\r\ncairo_set_source_surface (cr, user_data->dlg.surface_main, 0, 0);\r\n#else\r\nws_gdk_cairo_set_source_pixmap (cr, user_data->dlg.pixmap_main, 0, 0);\r\n#endif\r\ncairo_rectangle (cr, 0, 0, draw_area_alloc.width, draw_area_alloc.height);\r\ncairo_fill (cr);\r\ncairo_destroy (cr);\r\n}\r\nreturn TRUE;\r\n}\r\nstatic void v_scrollbar_changed(GtkWidget *widget _U_, gpointer data)\r\n{\r\ngraph_analysis_data_t *user_data = (graph_analysis_data_t *)data;\r\nif ((user_data->dlg.first_item+gtk_adjustment_get_page_size(user_data->dlg.v_scrollbar_adjustment)+1 == user_data->num_items)\r\n&& (gtk_adjustment_get_value(user_data->dlg.v_scrollbar_adjustment) >= user_data->dlg.first_item ))\r\nreturn;\r\nif (user_data->dlg.first_item == gtk_adjustment_get_value(user_data->dlg.v_scrollbar_adjustment))\r\nreturn;\r\nuser_data->dlg.first_item = (guint32) gtk_adjustment_get_value(user_data->dlg.v_scrollbar_adjustment);\r\ndialog_graph_redraw(user_data);\r\nreturn;\r\n}\r\nstatic void create_draw_area(graph_analysis_data_t *user_data, GtkWidget *box)\r\n{\r\nGtkWidget *hbox;\r\nGtkWidget *hpane_l;\r\nGtkWidget *viewport;\r\nGtkWidget *viewport_time;\r\nGtkWidget *viewport_comments;\r\nGtkWidget *scroll_vbox;\r\nGtkWidget *frame_box;\r\nGtkRequisition scroll_requisition;\r\nGtkWidget *frame;\r\nhbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_widget_show(hbox);\r\nuser_data->dlg.draw_area_time = gtk_drawing_area_new();\r\ngtk_widget_set_size_request(user_data->dlg.draw_area_time, TIME_WIDTH, user_data->dlg.surface_height);\r\nuser_data->dlg.scroll_window_time = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window_time, TIME_WIDTH, user_data->dlg.surface_height);\r\nuser_data->dlg.draw_area_comments = gtk_drawing_area_new();\r\ngtk_widget_set_size_request(user_data->dlg.draw_area_comments, COMMENT_WIDTH, user_data->dlg.surface_height);\r\nuser_data->dlg.scroll_window_comments = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window_comments, (gint)(COMMENT_WIDTH/1.5), user_data->dlg.surface_height);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW (user_data->dlg.scroll_window_time),\r\nGTK_POLICY_NEVER,\r\nGTK_POLICY_NEVER);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW (user_data->dlg.scroll_window_comments),\r\nGTK_POLICY_ALWAYS,\r\nGTK_POLICY_NEVER);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_time),\r\nGTK_SHADOW_ETCHED_IN);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_comments),\r\nGTK_SHADOW_ETCHED_IN);\r\ng_signal_connect(gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_comments)),\r\n"value-changed", G_CALLBACK(comments_area_scrolled), user_data);\r\nviewport_time = gtk_viewport_new(gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_time)),\r\ngtk_scrolled_window_get_vadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_time)));\r\nviewport_comments = gtk_viewport_new(gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_comments)),\r\ngtk_scrolled_window_get_vadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window_comments)));\r\ngtk_container_add(GTK_CONTAINER(viewport_time), user_data->dlg.draw_area_time);\r\ngtk_container_add(GTK_CONTAINER(user_data->dlg.scroll_window_time), viewport_time);\r\ngtk_container_add(GTK_CONTAINER(viewport_comments), user_data->dlg.draw_area_comments);\r\ngtk_container_add(GTK_CONTAINER(user_data->dlg.scroll_window_comments), viewport_comments);\r\ngtk_viewport_set_shadow_type(GTK_VIEWPORT(viewport_comments), GTK_SHADOW_NONE);\r\ngtk_widget_add_events (user_data->dlg.draw_area_comments, GDK_BUTTON_PRESS_MASK);\r\nuser_data->dlg.draw_area = gtk_drawing_area_new();\r\nuser_data->dlg.surface_width = user_data->graph_info->num_nodes * NODE_WIDTH + 2*NODE_WIDTH;\r\ngtk_widget_set_size_request(user_data->dlg.draw_area, user_data->dlg.surface_width, user_data->dlg.surface_height);\r\nuser_data->dlg.scroll_window = gtk_scrolled_window_new(NULL, NULL);\r\nif ( user_data->graph_info->num_nodes < 6)\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window, NODE_WIDTH*user_data->graph_info->num_nodes, user_data->dlg.surface_height);\r\nelse\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window, NODE_WIDTH*5, user_data->dlg.surface_height);\r\ngtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window),\r\nGTK_POLICY_ALWAYS,\r\nGTK_POLICY_NEVER);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window),\r\nGTK_SHADOW_ETCHED_IN);\r\ng_signal_connect(gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window)),\r\n"value-changed", G_CALLBACK(draw_area_scrolled), user_data);\r\ng_signal_connect(user_data->dlg.scroll_window, "scroll_event", G_CALLBACK(mouse_scrolled), user_data);\r\ng_signal_connect(user_data->dlg.scroll_window_time, "scroll_event", G_CALLBACK(mouse_scrolled), user_data);\r\ng_signal_connect(user_data->dlg.scroll_window_comments, "scroll_event", G_CALLBACK(mouse_scrolled), user_data);\r\nviewport = gtk_viewport_new(gtk_scrolled_window_get_hadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window)),\r\ngtk_scrolled_window_get_vadjustment(GTK_SCROLLED_WINDOW(user_data->dlg.scroll_window)));\r\ngtk_container_add(GTK_CONTAINER(viewport), user_data->dlg.draw_area);\r\ngtk_container_add(GTK_CONTAINER(user_data->dlg.scroll_window), viewport);\r\ngtk_viewport_set_shadow_type(GTK_VIEWPORT(viewport_time), GTK_SHADOW_NONE);\r\ngtk_viewport_set_shadow_type(GTK_VIEWPORT(viewport), GTK_SHADOW_NONE);\r\ngtk_widget_set_can_focus(user_data->dlg.draw_area, TRUE);\r\ngtk_widget_grab_focus(user_data->dlg.draw_area);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ng_signal_connect(user_data->dlg.draw_area, "draw", G_CALLBACK(draw_area_draw), user_data);\r\n#else\r\ng_signal_connect(user_data->dlg.draw_area, "expose_event", G_CALLBACK(expose_event), user_data);\r\n#endif\r\ng_signal_connect(user_data->dlg.draw_area, "configure_event", G_CALLBACK(configure_event), user_data);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ng_signal_connect(user_data->dlg.draw_area_comments, "draw", G_CALLBACK(draw_comments), user_data);\r\n#else\r\ng_signal_connect(user_data->dlg.draw_area_comments, "expose_event", G_CALLBACK(expose_event_comments), user_data);\r\n#endif\r\ng_signal_connect(user_data->dlg.draw_area_comments, "configure_event", G_CALLBACK(configure_event_comments), user_data);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ng_signal_connect(user_data->dlg.draw_area_time, "draw", G_CALLBACK(draw_time), user_data);\r\n#else\r\ng_signal_connect(user_data->dlg.draw_area_time, "expose_event", G_CALLBACK(expose_event_time), user_data);\r\n#endif\r\ng_signal_connect(user_data->dlg.draw_area_time, "configure_event", G_CALLBACK(configure_event_time), user_data);\r\ngtk_widget_add_events (user_data->dlg.draw_area, GDK_BUTTON_PRESS_MASK);\r\ng_signal_connect(user_data->dlg.draw_area, "button_press_event", G_CALLBACK(button_press_event), user_data);\r\ng_signal_connect(user_data->dlg.draw_area, "key_press_event", G_CALLBACK(key_press_event), user_data);\r\ngtk_widget_show(user_data->dlg.draw_area_time);\r\ngtk_widget_show(viewport_time);\r\ngtk_widget_show(user_data->dlg.draw_area);\r\ngtk_widget_show(viewport);\r\ngtk_widget_show(user_data->dlg.draw_area_comments);\r\ngtk_widget_show(viewport_comments);\r\ngtk_widget_show(user_data->dlg.scroll_window);\r\ngtk_widget_show(user_data->dlg.scroll_window_time);\r\ngtk_widget_show(user_data->dlg.scroll_window_comments);\r\nuser_data->dlg.hpane = gtk_paned_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_paned_pack1(GTK_PANED (user_data->dlg.hpane), user_data->dlg.scroll_window, FALSE, TRUE);\r\ngtk_paned_pack2(GTK_PANED (user_data->dlg.hpane), user_data->dlg.scroll_window_comments, TRUE, TRUE);\r\ng_signal_connect(user_data->dlg.hpane, "notify::position", G_CALLBACK(pane_callback), user_data);\r\ngtk_widget_show(user_data->dlg.hpane);\r\nhpane_l = gtk_paned_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_paned_pack1(GTK_PANED (hpane_l), user_data->dlg.scroll_window_time, FALSE, TRUE);\r\ngtk_paned_pack2(GTK_PANED (hpane_l), user_data->dlg.hpane, TRUE, TRUE);\r\ng_signal_connect(hpane_l, "notify::position", G_CALLBACK(pane_callback), user_data);\r\ngtk_widget_show(hpane_l);\r\ngtk_box_pack_start(GTK_BOX(hbox), hpane_l, TRUE, TRUE, 0);\r\nscroll_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_widget_show(scroll_vbox);\r\nuser_data->dlg.v_scrollbar_adjustment = (GtkAdjustment *)gtk_adjustment_new(0, 0, 0, 0, 0, 0);\r\nuser_data->dlg.v_scrollbar = gtk_scrollbar_new(GTK_ORIENTATION_VERTICAL, user_data->dlg.v_scrollbar_adjustment);\r\ngtk_widget_show(user_data->dlg.v_scrollbar);\r\ngtk_box_pack_start(GTK_BOX(scroll_vbox), user_data->dlg.v_scrollbar, TRUE, TRUE, 0);\r\ng_signal_connect(user_data->dlg.v_scrollbar_adjustment, "value_changed",\r\nG_CALLBACK(v_scrollbar_changed), user_data);\r\nframe_box = gtk_frame_new(NULL);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_get_preferred_size(user_data->dlg.v_scrollbar, &scroll_requisition, NULL);\r\n#else\r\ngtk_widget_size_request(user_data->dlg.v_scrollbar, &scroll_requisition);\r\n#endif\r\ngtk_widget_set_size_request(frame_box, 1, scroll_requisition.width+2);\r\ngtk_frame_set_shadow_type(GTK_FRAME(frame_box), GTK_SHADOW_NONE);\r\ngtk_widget_show(frame_box);\r\ngtk_box_pack_end(GTK_BOX(scroll_vbox), frame_box, FALSE, FALSE, 0);\r\ngtk_box_pack_end(GTK_BOX(hbox), scroll_vbox, FALSE, FALSE, 3);\r\nframe = gtk_frame_new(NULL);\r\ngtk_widget_show(frame);\r\ngtk_container_add(GTK_CONTAINER(frame), hbox);\r\ngtk_container_set_border_width(GTK_CONTAINER(hbox), 3);\r\ngtk_box_pack_start(GTK_BOX(box), frame, TRUE, TRUE, 0);\r\ngtk_container_set_border_width(GTK_CONTAINER(box), 10);\r\n}\r\nstatic void dialog_graph_create_window(graph_analysis_data_t *user_data)\r\n{\r\nGtkWidget *vbox;\r\nGtkWidget *hbuttonbox;\r\nGtkWidget *bt_close;\r\nGtkWidget *bt_save;\r\ngchar *title_name_ptr;\r\ngchar *win_name;\r\ntitle_name_ptr = cf_get_display_name(&cfile);\r\nwin_name = g_strdup_printf("%s - Graph Analysis", title_name_ptr);\r\ng_free(title_name_ptr);\r\nuser_data->dlg.window = dlg_window_new((user_data->dlg.title)?user_data->dlg.title:win_name);\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(user_data->dlg.window), TRUE);\r\nvbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(user_data->dlg.window), vbox);\r\ngtk_widget_show(vbox);\r\ncreate_draw_area(user_data, vbox);\r\nhbuttonbox = gtk_button_box_new (GTK_ORIENTATION_HORIZONTAL);\r\ngtk_box_pack_start (GTK_BOX (vbox), hbuttonbox, FALSE, FALSE, 10);\r\ngtk_button_box_set_layout (GTK_BUTTON_BOX (hbuttonbox), GTK_BUTTONBOX_SPREAD);\r\ngtk_box_set_spacing (GTK_BOX (hbuttonbox), 30);\r\ngtk_widget_show(hbuttonbox);\r\nbt_save = ws_gtk_button_new_from_stock(GTK_STOCK_SAVE_AS);\r\ngtk_box_pack_start(GTK_BOX(hbuttonbox), bt_save, TRUE, TRUE, 0);\r\ngtk_widget_show(bt_save);\r\ng_signal_connect(bt_save, "clicked", G_CALLBACK(on_save_bt_clicked), user_data);\r\ngtk_widget_set_tooltip_text(bt_save, "Save an ASCII representation of the graph to a file");\r\nbt_close = ws_gtk_button_new_from_stock(GTK_STOCK_CLOSE);\r\ngtk_box_pack_start(GTK_BOX(hbuttonbox), bt_close, TRUE, TRUE, 0);\r\ngtk_widget_set_can_default(bt_close, TRUE);\r\ngtk_widget_show(bt_close);\r\ngtk_widget_set_tooltip_text(bt_close, "Close this dialog");\r\nwindow_set_cancel_button(user_data->dlg.window, bt_close, window_cancel_button_cb);\r\ng_signal_connect(user_data->dlg.window, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(user_data->dlg.window, "destroy", G_CALLBACK(on_destroy), user_data);\r\ngtk_widget_show(user_data->dlg.window);\r\nwindow_present(user_data->dlg.window);\r\nif(user_data->dlg.parent_w) {\r\ngtk_window_set_transient_for(GTK_WINDOW(user_data->dlg.window),\r\nGTK_WINDOW(user_data->dlg.parent_w));\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(user_data->dlg.window), TRUE);\r\n}\r\ng_free(win_name);\r\n}\r\ngraph_analysis_data_t *graph_analysis_init(seq_analysis_info_t *sainfo)\r\n{\r\ngraph_analysis_data_t *user_data;\r\nuser_data = g_new0(graph_analysis_data_t,1);\r\nuser_data->graph_info = sainfo;\r\ngraph_analysis_init_dlg(user_data);\r\nreturn user_data;\r\n}\r\nvoid graph_analysis_create(graph_analysis_data_t *user_data)\r\n{\r\ngraph_analysis_reset(user_data);\r\nuser_data->num_items = sequence_analysis_get_nodes(user_data->graph_info);\r\ndialog_graph_create_window(user_data);\r\ndialog_graph_redraw(user_data);\r\nreturn;\r\n}\r\nvoid graph_analysis_update(graph_analysis_data_t *user_data)\r\n{\r\ngraph_analysis_reset(user_data);\r\nuser_data->num_items = sequence_analysis_get_nodes(user_data->graph_info);\r\nuser_data->dlg.surface_width = user_data->graph_info->num_nodes * NODE_WIDTH;\r\ngtk_widget_set_size_request(user_data->dlg.draw_area, user_data->dlg.surface_width, user_data->dlg.surface_height);\r\nif (user_data->graph_info->num_nodes < 6)\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window, NODE_WIDTH*user_data->graph_info->num_nodes, user_data->dlg.surface_height);\r\nelse\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window, NODE_WIDTH*5, user_data->dlg.surface_height);\r\ndialog_graph_redraw(user_data);\r\nwindow_present(user_data->dlg.window);\r\nreturn;\r\n}\r\nvoid graph_analysis_redraw(graph_analysis_data_t *user_data)\r\n{\r\nuser_data->num_items = sequence_analysis_get_nodes(user_data->graph_info);\r\nuser_data->dlg.surface_width = user_data->graph_info->num_nodes * NODE_WIDTH;\r\ngtk_widget_set_size_request(user_data->dlg.draw_area, user_data->dlg.surface_width, user_data->dlg.surface_height);\r\nif (user_data->graph_info->num_nodes < 6)\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window, NODE_WIDTH*user_data->graph_info->num_nodes, user_data->dlg.surface_height);\r\nelse\r\ngtk_widget_set_size_request(user_data->dlg.scroll_window, NODE_WIDTH*5, user_data->dlg.surface_height);\r\ndialog_graph_redraw(user_data);\r\nwindow_present(user_data->dlg.window);\r\nreturn;\r\n}

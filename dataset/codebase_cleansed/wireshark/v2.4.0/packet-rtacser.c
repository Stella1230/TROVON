static void\r\nrtacser_ppi_prompt(packet_info *pinfo _U_, gchar* result)\r\n{\r\ng_snprintf(result, MAX_DECODE_AS_PROMPT_LEN, "Payload as");\r\n}\r\nstatic gpointer\r\nrtacser_ppi_value(packet_info *pinfo _U_)\r\n{\r\nreturn 0;\r\n}\r\nstatic void\r\ndissect_rtacser_data(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *rtacser_item, *cl_item;\r\nproto_tree *rtacser_tree, *cl_tree;\r\nint offset = 0, len;\r\nguint event_type;\r\nnstime_t tv;\r\ngboolean cts, dcd, dsr, rts, dtr, ring, mbok;\r\ntvbuff_t *payload_tvb;\r\nlen = RTACSER_HEADER_LEN;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "RTAC Serial");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nrtacser_item = proto_tree_add_protocol_format(tree, proto_rtacser, tvb, 0, len, "RTAC Serial Line");\r\nrtacser_tree = proto_item_add_subtree(rtacser_item, ett_rtacser);\r\ntv.secs = tvb_get_ntohl(tvb, offset);\r\ntv.nsecs = tvb_get_ntohl(tvb, offset+4)*1000;\r\nproto_tree_add_time(rtacser_tree, hf_rtacser_timestamp, tvb, offset, 8, &tv);\r\noffset += 8;\r\nevent_type = tvb_get_guint8(tvb, offset);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%-21s", val_to_str_const(event_type, rtacser_eventtype_vals, "Unknown Type"));\r\nproto_tree_add_item(rtacser_tree, hf_rtacser_event_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\ncts = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_CTS;\r\ndcd = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_DCD;\r\ndsr = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_DSR;\r\nrts = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_RTS;\r\ndtr = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_DTR;\r\nring = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_RING;\r\nmbok = tvb_get_guint8(tvb, offset) & RTACSER_CTRL_MBOK;\r\ncl_tree = proto_tree_add_subtree(rtacser_tree, tvb, offset, 1, ett_rtacser_cl, &cl_item, "Control Lines");\r\ncol_append_str(pinfo->cinfo, COL_INFO, " ( ");\r\n(cts) ? col_append_str(pinfo->cinfo, COL_INFO, "CTS") : col_append_str(pinfo->cinfo, COL_INFO, "/CTS");\r\n(dcd) ? col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "DCD") : col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "/DCD");\r\n(dsr) ? col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "DSR") : col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "/DSR");\r\n(rts) ? col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "RTS") : col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "/RTS");\r\n(dtr) ? col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "DTR") : col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "/DTR");\r\n(ring) ? col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "RING") : col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "/RING");\r\n(mbok) ? col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "MBOK") : col_append_sep_str(pinfo->cinfo, COL_INFO, NULL, "/MBOK");\r\ncol_append_str(pinfo->cinfo, COL_INFO, " )");\r\nproto_item_append_text(cl_item, " (");\r\n(cts) ? proto_item_append_text(cl_item, "CTS, ") : proto_item_append_text(cl_item, "/CTS, ");\r\n(dcd) ? proto_item_append_text(cl_item, "DCD, ") : proto_item_append_text(cl_item, "/DCD, ");\r\n(dsr) ? proto_item_append_text(cl_item, "DSR, ") : proto_item_append_text(cl_item, "/DSR, ");\r\n(rts) ? proto_item_append_text(cl_item, "RTS, ") : proto_item_append_text(cl_item, "/RTS, ");\r\n(dtr) ? proto_item_append_text(cl_item, "DTR, ") : proto_item_append_text(cl_item, "/DTR, ");\r\n(ring) ? proto_item_append_text(cl_item, "RING, ") : proto_item_append_text(cl_item, "/RING, ");\r\n(mbok) ? proto_item_append_text(cl_item, "MBOK") : proto_item_append_text(cl_item, "/MBOK");\r\nproto_item_append_text(cl_item, ")");\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_cts, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_dcd, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_dsr, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_rts, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_dtr, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_ring, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(cl_tree, hf_rtacser_ctrl_mbok, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(rtacser_tree, hf_rtacser_footer, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (tvb_reported_length_remaining(tvb, offset) > 0) {\r\npayload_tvb = tvb_new_subset_remaining(tvb, RTACSER_HEADER_LEN);\r\nif (!dissector_try_uint(subdissector_table, 0, payload_tvb, pinfo, tree)){\r\ncall_data_dissector(payload_tvb, pinfo, tree);\r\n}\r\n}\r\n}\r\nstatic int\r\ndissect_rtacser(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\ngint length = tvb_captured_length(tvb);\r\nif(length < 12) {\r\nreturn 0;\r\n}\r\ndissect_rtacser_data(tvb, pinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_rtacser(void)\r\n{\r\nstatic hf_register_info rtacser_hf[] = {\r\n{ &hf_rtacser_timestamp,\r\n{ "Arrived At Time", "rtacser.timestamp", FT_RELATIVE_TIME, BASE_NONE, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_rtacser_event_type,\r\n{ "Event Type", "rtacser.eventtype", FT_UINT8, BASE_HEX, VALS(rtacser_eventtype_vals), 0x0, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_cts,\r\n{ "CTS", "rtacser.cts", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_CTS, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_dcd,\r\n{ "DCD", "rtacser.dcd", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_DCD, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_dsr,\r\n{ "DSR", "rtacser.dsr", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_DSR, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_rts,\r\n{ "RTS", "rtacser.rts", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_RTS, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_dtr,\r\n{ "DTR", "rtacser.dtr", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_DTR, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_ring,\r\n{ "RING", "rtacser.ring", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_RING, NULL, HFILL }},\r\n{ &hf_rtacser_ctrl_mbok,\r\n{ "MBOK", "rtacser.mbok", FT_UINT8, BASE_DEC, NULL, RTACSER_CTRL_MBOK, NULL, HFILL }},\r\n{ &hf_rtacser_footer,\r\n{ "Footer", "rtacser.footer", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL }},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_rtacser,\r\n&ett_rtacser_cl,\r\n};\r\nstatic build_valid_func rtacser_da_ppi_build_value[1] = {rtacser_ppi_value};\r\nstatic decode_as_value_t rtacser_da_ppi_values[1] = {{rtacser_ppi_prompt, 1, rtacser_da_ppi_build_value}};\r\nstatic decode_as_t rtacser_da_ppi = {"rtacser", "RTAC Serial", "rtacser.data", 1, 0, rtacser_da_ppi_values, "RTAC Serial", NULL,\r\ndecode_as_default_populate_list, decode_as_default_reset, decode_as_default_change, NULL};\r\nmodule_t *rtacser_module;\r\nproto_rtacser = proto_register_protocol("RTAC Serial", "RTAC Serial", "rtacser");\r\nrtacser_handle = register_dissector("rtacser", dissect_rtacser, proto_rtacser);\r\nsubdissector_table = register_dissector_table("rtacser.data", "RTAC Serial Data Subdissector", proto_rtacser, FT_UINT32, BASE_HEX);\r\nproto_register_field_array(proto_rtacser, rtacser_hf, array_length(rtacser_hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nrtacser_module = prefs_register_protocol(proto_rtacser, proto_reg_handoff_rtacser);\r\nprefs_register_obsolete_preference(rtacser_module, "rtacserial_payload_proto");\r\nregister_decode_as(&rtacser_da_ppi);\r\n}\r\nvoid\r\nproto_reg_handoff_rtacser(void)\r\n{\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_RTAC_SERIAL, rtacser_handle);\r\n}

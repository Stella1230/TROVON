static void\r\nmcaststream_on_destroy(GObject *object _U_, gpointer user_data _U_)\r\n{\r\nremove_tap_listener_mcast_stream(&the_tapinfo_struct);\r\nif (mcast_params_dlg != NULL)\r\nwindow_destroy(mcast_params_dlg);\r\nmcaststream_reset(mcaststream_dlg_get_tapinfo());\r\nmcast_stream_dlg = NULL;\r\n}\r\nstatic void\r\nmcaststream_on_unselect(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\nGtkTreeSelection *selection = gtk_tree_view_get_selection(GTK_TREE_VIEW(list_w));\r\ngtk_tree_selection_unselect_all(selection);\r\nselected_stream_fwd = NULL;\r\ngtk_label_set_text(GTK_LABEL(label_fwd), FWD_LABEL_TEXT);\r\ngtk_widget_set_sensitive(bt_filter, FALSE);\r\n}\r\nstatic void\r\nmcaststream_on_filter(GtkButton *button _U_, gpointer user_data _U_)\r\n{\r\ngchar *filter_string_fwd;\r\ngchar ip_version[3];\r\nchar *src_addr, *dst_addr;\r\nif (selected_stream_fwd == NULL)\r\nreturn;\r\nif (selected_stream_fwd->src_addr.type == AT_IPv6) {\r\ng_strlcpy(ip_version,"v6",sizeof(ip_version));\r\n} else {\r\nip_version[0] = '\0';\r\n}\r\nsrc_addr = (char*)address_to_str(NULL, &(selected_stream_fwd->src_addr));\r\ndst_addr = (char*)address_to_str(NULL, &(selected_stream_fwd->dest_addr));\r\nfilter_string_fwd = wmem_strdup_printf(NULL,\r\n"(ip%s.src==%s && udp.srcport==%u && ip%s.dst==%s && udp.dstport==%u)",\r\nip_version,\r\nsrc_addr,\r\nselected_stream_fwd->src_port,\r\nip_version,\r\ndst_addr,\r\nselected_stream_fwd->dest_port);\r\ngtk_entry_set_text(GTK_ENTRY(main_display_filter_widget), filter_string_fwd);\r\nwmem_free(NULL, filter_string_fwd);\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\n#if 0\r\nmain_filter_packets(&cfile, filter_string, FALSE);\r\nmcaststream_dlg_update(mcaststream_dlg_get_tapinfo()->strinfo_list);\r\n#endif\r\n}\r\nstatic void\r\nmcaststream_on_select_row(GtkTreeSelection *selection, gpointer data _U_)\r\n{\r\ngchar label_text[80];\r\nchar *src_addr, *dst_addr;\r\nif (gtk_tree_selection_get_selected(selection, NULL, &list_iter))\r\n{\r\ngtk_tree_model_get(GTK_TREE_MODEL(list_store), &list_iter, MC_COL_DATA, &selected_stream_fwd, -1);\r\nsrc_addr = address_to_display(NULL, &(selected_stream_fwd->src_addr));\r\ndst_addr = address_to_display(NULL, &(selected_stream_fwd->dest_addr));\r\ng_snprintf(label_text, sizeof(label_text), "Selected: %s:%u -> %s:%u",\r\nsrc_addr,\r\nselected_stream_fwd->src_port,\r\ndst_addr,\r\nselected_stream_fwd->dest_port\r\n);\r\ngtk_label_set_text(GTK_LABEL(label_fwd), label_text);\r\ngtk_widget_set_sensitive(bt_filter, TRUE);\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\n} else {\r\nselected_stream_fwd = NULL;\r\ngtk_label_set_text(GTK_LABEL(label_fwd), FWD_LABEL_TEXT);\r\ngtk_widget_set_sensitive(bt_filter, FALSE);\r\n}\r\n}\r\nstatic void\r\nmcast_params_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\nmcast_params_dlg = NULL;\r\n}\r\nstatic void\r\nmcast_params_ok_cb(GtkWidget *ok_bt _U_, gpointer parent_w)\r\n{\r\nGtkWidget *fnumber_te;\r\nconst gchar *fnumber_text;\r\ngint32 fnumber;\r\nchar *p;\r\nfnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_MCAST_ENTRY_1);\r\nfnumber_text = gtk_entry_get_text(GTK_ENTRY(fnumber_te));\r\nfnumber = (gint)strtol(fnumber_text, &p, 10);\r\nif ( ((p == fnumber_text) || (*p != '\0')) || (fnumber <= 0) || (fnumber > 1000) ) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "The burst interval should be between 1 and 1000 ms.");\r\nreturn;\r\n}\r\nmcast_stream_burstint = fnumber;\r\nfnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_MCAST_ENTRY_2);\r\nfnumber_text = gtk_entry_get_text(GTK_ENTRY(fnumber_te));\r\nfnumber = (gint)strtol(fnumber_text, &p, 10);\r\nif ( ((p == fnumber_text) || (*p != '\0')) || (fnumber <= 0) ) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "The burst alarm threshold you entered isn't valid.");\r\nreturn;\r\n}\r\nmcast_stream_trigger = fnumber;\r\nfnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_MCAST_ENTRY_3);\r\nfnumber_text = gtk_entry_get_text(GTK_ENTRY(fnumber_te));\r\nfnumber = (gint)strtol(fnumber_text, &p, 10);\r\nif ( ((p == fnumber_text) || (*p != '\0')) || (fnumber <= 0) ) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "The buffer alarm threshold you entered isn't valid.");\r\nreturn;\r\n}\r\nmcast_stream_bufferalarm = fnumber;\r\nfnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_MCAST_ENTRY_4);\r\nfnumber_text = gtk_entry_get_text(GTK_ENTRY(fnumber_te));\r\nfnumber = (gint)strtol(fnumber_text, &p, 10);\r\nif ( ((p == fnumber_text) || (*p != '\0')) || (fnumber <= 0) || (fnumber > 10000000) ) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "The stream empty speed should be between 1 and 10000000");\r\nreturn;\r\n}\r\nmcast_stream_emptyspeed = fnumber;\r\nfnumber_te = (GtkWidget *)g_object_get_data(G_OBJECT(parent_w), E_MCAST_ENTRY_5);\r\nfnumber_text = gtk_entry_get_text(GTK_ENTRY(fnumber_te));\r\nfnumber = (gint)strtol(fnumber_text, &p, 10);\r\nif ( ((p == fnumber_text) || (*p != '\0')) || (fnumber <= 0) || (fnumber > 10000000) ) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "The total empty speed should be between 1 and 10000000");\r\nreturn;\r\n}\r\nmcast_stream_cumulemptyspeed = fnumber;\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nmcaststream_reset((mcaststream_tapinfo_t*)mcaststream_dlg_get_tapinfo());\r\ncf_retap_packets(&cfile);\r\n}\r\nstatic void\r\nmcast_on_params(GtkButton *button _U_, gpointer data _U_)\r\n{\r\nGtkWidget *main_vb;\r\nGtkWidget *label, *hbuttonbox, *grid;\r\nGtkWidget *ok_bt, *cancel_bt;\r\nGtkWidget *entry1, *entry2, *entry3, *entry4, *entry5;\r\ngchar label_text[51];\r\nif (mcast_params_dlg != NULL) {\r\nreactivate_window(mcast_params_dlg);\r\nreturn;\r\n}\r\nmcast_params_dlg = dlg_window_new("Wireshark: Set parameters for Multicast Stream Analysis");\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(mcast_params_dlg), TRUE);\r\ngtk_window_set_default_size(GTK_WINDOW(mcast_params_dlg), 210, 210);\r\ngtk_widget_show(mcast_params_dlg);\r\nmain_vb =ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 2);\r\ngtk_container_add(GTK_CONTAINER(mcast_params_dlg), main_vb);\r\ngtk_widget_show(main_vb);\r\ngrid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), grid, TRUE, TRUE, 0);\r\nlabel = gtk_label_new(" Burst measurement interval (ms) ");\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 0, 0, 1, 1);\r\nentry1 = gtk_entry_new();\r\ng_snprintf(label_text, sizeof(label_text), "%u", mcast_stream_burstint);\r\ngtk_entry_set_text(GTK_ENTRY(entry1), label_text);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), entry1, 1, 0, 1, 1);\r\nlabel = gtk_label_new(" Burst alarm threshold (packets) ");\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 0, 1, 1, 1);\r\nentry2 = gtk_entry_new();\r\ng_snprintf(label_text, sizeof(label_text), "%u", mcast_stream_trigger);\r\ngtk_entry_set_text(GTK_ENTRY(entry2), label_text);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), entry2, 1, 1, 1, 1);\r\nlabel = gtk_label_new(" Buffer alarm threshold (bytes) ");\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 0, 2, 1, 1);\r\nentry3 = gtk_entry_new();\r\ng_snprintf(label_text, sizeof(label_text), "%u", mcast_stream_bufferalarm);\r\ngtk_entry_set_text(GTK_ENTRY(entry3), label_text);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), entry3, 1, 2, 1, 1);\r\nlabel = gtk_label_new(" Stream empty speed (kbit/s) ");\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 0, 3, 1, 1);\r\nentry4 = gtk_entry_new();\r\ng_snprintf(label_text, sizeof(label_text), "%u", mcast_stream_emptyspeed);\r\ngtk_entry_set_text(GTK_ENTRY(entry4), label_text);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), entry4, 1, 3, 1, 1);\r\nlabel = gtk_label_new(" Total empty speed (kbit/s) ");\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 0, 4, 1, 1);\r\nentry5 = gtk_entry_new();\r\ng_snprintf(label_text, sizeof(label_text), "%u", mcast_stream_cumulemptyspeed);\r\ngtk_entry_set_text(GTK_ENTRY(entry5), label_text);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), entry5, 1, 4, 1, 1);\r\ngtk_widget_show (grid);\r\nhbuttonbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), hbuttonbox, 0, 5, 2, 1);\r\nok_bt = ws_gtk_button_new_from_stock(GTK_STOCK_OK);\r\ngtk_container_add (GTK_CONTAINER(hbuttonbox), ok_bt);\r\ncancel_bt = ws_gtk_button_new_from_stock(GTK_STOCK_CANCEL);\r\ngtk_container_add (GTK_CONTAINER(hbuttonbox), cancel_bt);\r\ngtk_widget_set_can_default(cancel_bt, TRUE);\r\ngtk_button_box_set_layout(GTK_BUTTON_BOX(hbuttonbox), GTK_BUTTONBOX_END);\r\ngtk_box_set_spacing(GTK_BOX(hbuttonbox), 0);\r\ng_signal_connect(mcast_params_dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(mcast_params_dlg, "destroy", G_CALLBACK(mcast_params_destroy_cb), NULL);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(mcast_params_ok_cb), mcast_params_dlg);\r\nwindow_set_cancel_button(mcast_params_dlg, cancel_bt, window_cancel_button_cb);\r\ng_object_set_data(G_OBJECT(mcast_params_dlg), E_MCAST_ENTRY_1, entry1);\r\ng_object_set_data(G_OBJECT(mcast_params_dlg), E_MCAST_ENTRY_2, entry2);\r\ng_object_set_data(G_OBJECT(mcast_params_dlg), E_MCAST_ENTRY_3, entry3);\r\ng_object_set_data(G_OBJECT(mcast_params_dlg), E_MCAST_ENTRY_4, entry4);\r\ng_object_set_data(G_OBJECT(mcast_params_dlg), E_MCAST_ENTRY_5, entry5);\r\ngtk_widget_show_all(mcast_params_dlg);\r\nwindow_present(mcast_params_dlg);\r\n}\r\nstatic void\r\nadd_to_list_store(mcast_stream_info_t* strinfo)\r\n{\r\ngchar label_text[256];\r\ngchar *data[NUM_COLS];\r\nint i;\r\nchar *savelocale;\r\nchar *src_addr, *dst_addr;\r\nsavelocale = g_strdup(setlocale(LC_NUMERIC, NULL));\r\nsetlocale(LC_NUMERIC, "C");\r\nsrc_addr = address_to_display(NULL, &(strinfo->src_addr));\r\ndst_addr = address_to_display(NULL, &(strinfo->dest_addr));\r\ndata[0] = g_strdup(src_addr);\r\ndata[1] = g_strdup_printf("%u", strinfo->src_port);\r\ndata[2] = g_strdup(dst_addr);\r\ndata[3] = g_strdup_printf("%u", strinfo->dest_port);\r\ndata[4] = g_strdup_printf("%u", strinfo->npackets);\r\ndata[5] = g_strdup_printf("%.1f /s", strinfo->apackets);\r\ndata[6] = g_strdup_printf("%2.1f Mbps", strinfo->average_bw/1000000);\r\ndata[7] = g_strdup_printf("%2.1f Mbps", strinfo->element.maxbw/1000000);\r\ndata[8] = g_strdup_printf("%u / %dms", strinfo->element.topburstsize, mcast_stream_burstint);\r\ndata[9] = g_strdup_printf("%u", strinfo->element.numbursts);\r\ndata[10] = g_strdup_printf("%.1f KB", (float)strinfo->element.topbuffusage/1000);\r\ndata[11] = g_strdup_printf("%u", strinfo->element.numbuffalarms);\r\nsetlocale(LC_NUMERIC, savelocale);\r\ng_free(savelocale);\r\ngtk_list_store_append(list_store, &list_iter);\r\ngtk_list_store_set(list_store, &list_iter,\r\nMC_COL_SRC_ADDR, data[0],\r\nMC_COL_SRC_PORT, data[1],\r\nMC_COL_DST_ADDR, data[2],\r\nMC_COL_DST_PORT, data[3],\r\nMC_COL_PACKETS, data[4],\r\nMC_COL_PPS, data[5],\r\nMC_COL_AVG_BW, data[6],\r\nMC_COL_MAX_BW, data[7],\r\nMC_COL_MAX_BURST, data[8],\r\nMC_COL_BURST_ALARM, data[9],\r\nMC_COL_MAX_BUFFER, data[10],\r\nMC_COL_BUFFER_ALARM, data[11],\r\nMC_COL_DATA, strinfo,\r\n-1);\r\nfor (i = 0; i < NUM_COLS-1; i++)\r\ng_free(data[i]);\r\nwmem_free(NULL, src_addr);\r\nwmem_free(NULL, dst_addr);\r\ng_snprintf(label_text, sizeof(label_text),\r\n"Detected %d Multicast streams, Average Bw: %.1f Mbps Max Bw: %.1f Mbps Max burst: %d / %dms Max buffer: %.1f KB",\r\n++streams_nb,\r\nmcaststream_dlg_get_tapinfo()->allstreams->average_bw/1000000, mcaststream_dlg_get_tapinfo()->allstreams->element.maxbw/1000000,\r\nmcaststream_dlg_get_tapinfo()->allstreams->element.topburstsize, mcast_stream_burstint,\r\n(float)(mcaststream_dlg_get_tapinfo()->allstreams->element.topbuffusage)/1000);\r\ngtk_label_set_text(GTK_LABEL(top_label), label_text);\r\ng_snprintf(label_text, sizeof(label_text), "\nBurst int: %u ms Burst alarm: %u pps Buffer alarm: %u Bytes Stream empty speed: %u Kbps Total empty speed: %u Kbps\n",\r\nmcast_stream_burstint, mcast_stream_trigger, mcast_stream_bufferalarm, mcast_stream_emptyspeed, mcast_stream_cumulemptyspeed);\r\ngtk_label_set_text(GTK_LABEL(label_par), label_text);\r\n}\r\nstatic void\r\ncreate_list_view(void)\r\n{\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeSortable *sortable;\r\nGtkTreeView *list_view;\r\nGtkTreeSelection *selection;\r\nlist_store = gtk_list_store_new(NUM_COLS,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING,\r\nG_TYPE_POINTER\r\n);\r\nlist_w = gtk_tree_view_new_with_model(GTK_TREE_MODEL(list_store));\r\nlist_view = GTK_TREE_VIEW(list_w);\r\nsortable = GTK_TREE_SORTABLE(list_store);\r\ngtk_tree_view_set_fixed_height_mode(list_view, TRUE);\r\ngtk_tree_sortable_set_sort_column_id(sortable, MC_COL_SRC_ADDR, GTK_SORT_ASCENDING);\r\ngtk_tree_view_set_headers_clickable(list_view, FALSE);\r\ng_object_unref(G_OBJECT(list_store));\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Src IP addr", renderer,\r\n"text", MC_COL_SRC_ADDR,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_SRC_ADDR);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Src port", renderer,\r\n"text", MC_COL_SRC_PORT,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_SRC_PORT);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Dst IP addr", renderer,\r\n"text", MC_COL_DST_ADDR,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_DST_ADDR);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Dst port", renderer,\r\n"text", MC_COL_DST_PORT,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_DST_PORT);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Packets", renderer,\r\n"text", MC_COL_PACKETS,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_PACKETS);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Packets/s", renderer,\r\n"text", MC_COL_PPS,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_PPS);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 60);\r\ngtk_tree_view_column_set_fixed_width(column, 90);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Avg Bw", renderer,\r\n"text", MC_COL_AVG_BW,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_AVG_BW);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 70);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Max Bw", renderer,\r\n"text", MC_COL_MAX_BW,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_MAX_BW);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 70);\r\ngtk_tree_view_column_set_fixed_width(column, 80);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Max bursts", renderer,\r\n"text", MC_COL_MAX_BURST,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_MAX_BURST);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 70);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Burst alarms", renderer,\r\n"text", MC_COL_BURST_ALARM,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_BURST_ALARM);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 90);\r\ngtk_tree_view_column_set_fixed_width(column, 110);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Max buffers", renderer,\r\n"text", MC_COL_MAX_BUFFER,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_MAX_BUFFER);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 90);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column(list_view, column);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Buffer alarms", renderer,\r\n"text", MC_COL_BUFFER_ALARM,\r\nNULL);\r\ngtk_tree_view_column_set_sort_column_id(column, MC_COL_BUFFER_ALARM);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 90);\r\ngtk_tree_view_column_set_fixed_width(column, 120);\r\ngtk_tree_view_append_column(list_view, column);\r\ngtk_tree_view_set_rules_hint(list_view, TRUE);\r\ngtk_tree_view_set_headers_clickable(list_view, TRUE);\r\nselection = gtk_tree_view_get_selection(list_view);\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_SINGLE);\r\ng_signal_connect(G_OBJECT(selection), "changed",\r\nG_CALLBACK(mcaststream_on_select_row),\r\nNULL);\r\n}\r\nstatic void\r\nmcaststream_dlg_create(void)\r\n{\r\nGtkWidget *mcaststream_dlg_w;\r\nGtkWidget *main_vb;\r\nGtkWidget *scrolledwindow;\r\nGtkWidget *hbuttonbox;\r\nGtkWidget *bt_params;\r\nGtkWidget *bt_close;\r\ngchar *title_name_ptr;\r\ngchar *win_name;\r\ntitle_name_ptr = cf_get_display_name(&cfile);\r\nwin_name = g_strdup_printf("%s - UDP Multicast Streams", title_name_ptr);\r\ng_free(title_name_ptr);\r\nmcaststream_dlg_w = dlg_window_new(win_name);\r\ngtk_window_set_default_size(GTK_WINDOW(mcaststream_dlg_w), 1150, 400);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_add(GTK_CONTAINER(mcaststream_dlg_w), main_vb);\r\ngtk_container_set_border_width (GTK_CONTAINER (main_vb), 12);\r\ntop_label = gtk_label_new ("Detected 0 Multicast streams");\r\ngtk_box_pack_start (GTK_BOX (main_vb), top_label, FALSE, FALSE, 8);\r\nscrolledwindow = scrolled_window_new (NULL, NULL);\r\ngtk_box_pack_start (GTK_BOX (main_vb), scrolledwindow, TRUE, TRUE, 0);\r\ncreate_list_view();\r\ngtk_container_add(GTK_CONTAINER(scrolledwindow), list_w);\r\ngtk_widget_show(mcaststream_dlg_w);\r\nlabel_fwd = gtk_label_new (FWD_LABEL_TEXT);\r\ngtk_box_pack_start (GTK_BOX (main_vb), label_fwd, FALSE, FALSE, 0);\r\nlabel_par = gtk_label_new (PAR_LABEL_TEXT);\r\ngtk_box_pack_start (GTK_BOX (main_vb), label_par, FALSE, FALSE, 0);\r\nhbuttonbox = gtk_button_box_new(GTK_ORIENTATION_HORIZONTAL);\r\ngtk_box_pack_start (GTK_BOX (main_vb), hbuttonbox, FALSE, FALSE, 0);\r\ngtk_button_box_set_layout (GTK_BUTTON_BOX (hbuttonbox), GTK_BUTTONBOX_END);\r\ngtk_box_set_spacing (GTK_BOX (hbuttonbox), 0);\r\nbt_params = gtk_button_new_with_label ("Set parameters");\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_params);\r\ngtk_widget_set_tooltip_text (bt_params, "Set buffer, limit and speed parameters");\r\nbt_filter = gtk_button_new_with_label ("Prepare Filter");\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_filter);\r\ngtk_widget_set_tooltip_text (bt_filter, "Prepare a display filter of the selected stream");\r\nbt_close = ws_gtk_button_new_from_stock(GTK_STOCK_CLOSE);\r\ngtk_container_add (GTK_CONTAINER (hbuttonbox), bt_close);\r\ngtk_widget_set_tooltip_text (bt_close, "Close this dialog");\r\ngtk_widget_set_can_default(bt_close, TRUE);\r\ng_signal_connect(bt_params, "clicked", G_CALLBACK(mcast_on_params), NULL);\r\ng_signal_connect(bt_filter, "clicked", G_CALLBACK(mcaststream_on_filter), NULL);\r\nwindow_set_cancel_button(mcaststream_dlg_w, bt_close, window_cancel_button_cb);\r\ng_signal_connect(mcaststream_dlg_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(mcaststream_dlg_w, "destroy", G_CALLBACK(mcaststream_on_destroy), NULL);\r\ngtk_widget_show_all(mcaststream_dlg_w);\r\nwindow_present(mcaststream_dlg_w);\r\nmcaststream_on_unselect(NULL, NULL);\r\nmcast_stream_dlg = mcaststream_dlg_w;\r\ng_free(win_name);\r\n}\r\nstatic void\r\nmcaststream_dlg_update(GList *list)\r\n{\r\nif (mcast_stream_dlg != NULL) {\r\ngtk_list_store_clear(list_store);\r\nstreams_nb = 0;\r\nlist = g_list_first(list);\r\nwhile (list)\r\n{\r\nadd_to_list_store((mcast_stream_info_t*)(list->data));\r\nlist = g_list_next(list);\r\n}\r\nmcaststream_on_unselect(NULL, NULL);\r\n}\r\nlast_list = list;\r\n}\r\nstatic void\r\nmcaststream_tap_reset(mcaststream_tapinfo_t *tapinfo _U_)\r\n{\r\nGtkTreeSelection *selection;\r\nif (mcast_stream_dlg != NULL) {\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(list_w));\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_NONE);\r\ngtk_list_store_clear(list_store);\r\ngtk_tree_selection_set_mode(selection, GTK_SELECTION_SINGLE);\r\nstreams_nb = 0;\r\n}\r\n}\r\nstatic void\r\nmcaststream_tap_draw(mcaststream_tapinfo_t *tapinfo)\r\n{\r\nif (tapinfo) {\r\nmcaststream_dlg_update(tapinfo->strinfo_list);\r\n}\r\n}\r\nvoid\r\nmcaststream_dlg_show(GList *list)\r\n{\r\nif (mcast_stream_dlg != NULL) {\r\nreactivate_window(mcast_stream_dlg);\r\nif (list != last_list) {\r\nmcaststream_dlg_update(list);\r\n}\r\n}\r\nelse {\r\nmcaststream_dlg_create();\r\nmcaststream_dlg_update(list);\r\n}\r\n}\r\nvoid\r\nmcaststream_launch(GtkAction *action _U_, gpointer user_data _U_)\r\n{\r\nregister_tap_listener_mcast_stream(&the_tapinfo_struct);\r\nmcaststream_scan(&the_tapinfo_struct, &cfile);\r\nmcaststream_dlg_show(the_tapinfo_struct.strinfo_list);\r\n}\r\nmcaststream_tapinfo_t *mcaststream_dlg_get_tapinfo(void) {\r\nreturn &the_tapinfo_struct;\r\n}

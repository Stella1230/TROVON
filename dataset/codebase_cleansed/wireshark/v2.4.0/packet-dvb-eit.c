static int\r\ndissect_dvb_eit(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint offset = 0, length = 0;\r\nguint descriptor_len;\r\nguint16 evt_id;\r\nproto_item *ti;\r\nproto_tree *dvb_eit_tree;\r\nproto_tree *dvb_eit_event_tree;\r\nproto_item *duration_item;\r\nnstime_t start_time;\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Event Information Table (EIT)");\r\nti = proto_tree_add_item(tree, proto_dvb_eit, tvb, offset, -1, ENC_NA);\r\ndvb_eit_tree = proto_item_add_subtree(ti, ett_dvb_eit);\r\noffset += packet_mpeg_sect_header(tvb, offset, dvb_eit_tree, &length, NULL);\r\nlength -= 4;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_service_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_reserved, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_version_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_current_next_indicator, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_last_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_transport_stream_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_original_network_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_segment_last_section_number, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(dvb_eit_tree, hf_dvb_eit_last_table_id, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nif (offset >= length) {\r\npacket_mpeg_sect_crc(tvb, pinfo, dvb_eit_tree, 0, offset);\r\nreturn offset;\r\n}\r\nwhile (offset < length) {\r\nevt_id = tvb_get_ntohs(tvb, offset);\r\ndvb_eit_event_tree = proto_tree_add_subtree_format(dvb_eit_tree, tvb, offset, 12, ett_dvb_eit_event, NULL, "Event 0x%04hx", evt_id);\r\nproto_tree_add_item(dvb_eit_event_tree, hf_dvb_eit_event_id, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nif (tvb_memeql(tvb, offset, "\xFF\xFF\xFF\xFF\xFF", 5)) {\r\nif (packet_mpeg_sect_mjd_to_utc_time(tvb, offset, &start_time) < 0) {\r\nproto_tree_add_time_format(dvb_eit_event_tree, hf_dvb_eit_start_time, tvb, offset, 5,\r\n&start_time, "Unparseable time");\r\n} else {\r\nproto_tree_add_time(dvb_eit_event_tree, hf_dvb_eit_start_time, tvb, offset,\r\n5, &start_time);\r\n}\r\n} else {\r\nstart_time.secs = 0xFFFFFFFF;\r\nstart_time.nsecs = 0xFFFFFFFF;\r\nproto_tree_add_time_format_value(tree, hf_dvb_eit_start_time, tvb, offset, 5, &start_time, "Undefined (0xFFFFFFFFFF)");\r\n}\r\noffset += 5;\r\nduration_item = proto_tree_add_item(dvb_eit_event_tree, hf_dvb_eit_duration, tvb, offset, 3, ENC_BIG_ENDIAN);\r\nproto_item_append_text(duration_item, " (%02u:%02u:%02u)",\r\nMPEG_SECT_BCD44_TO_DEC(tvb_get_guint8(tvb, offset)),\r\nMPEG_SECT_BCD44_TO_DEC(tvb_get_guint8(tvb, offset + 1)),\r\nMPEG_SECT_BCD44_TO_DEC(tvb_get_guint8(tvb, offset + 2)));\r\noffset += 3;\r\nproto_tree_add_item(dvb_eit_event_tree, hf_dvb_eit_running_status, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_eit_event_tree, hf_dvb_eit_free_ca_mode, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(dvb_eit_event_tree, hf_dvb_eit_descriptors_loop_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ndescriptor_len = tvb_get_ntohs(tvb, offset) & DVB_EIT_DESCRIPTORS_LOOP_LENGTH_MASK;\r\noffset += 2;\r\noffset += proto_mpeg_descriptor_loop_dissect(tvb, offset, descriptor_len, dvb_eit_event_tree);\r\n}\r\noffset += packet_mpeg_sect_crc(tvb, pinfo, dvb_eit_tree, 0, offset);\r\nproto_item_set_len(ti, offset);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_dvb_eit(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_dvb_eit_service_id, {\r\n"Service ID", "dvb_eit.sid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_reserved, {\r\n"Reserved", "dvb_eit.reserved",\r\nFT_UINT8, BASE_HEX, NULL, DVB_EIT_RESERVED_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_version_number, {\r\n"Version Number", "dvb_eit.version",\r\nFT_UINT8, BASE_HEX, NULL, DVB_EIT_VERSION_NUMBER_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_current_next_indicator, {\r\n"Current/Next Indicator", "dvb_eit.cur_next_ind",\r\nFT_UINT8, BASE_DEC, VALS(dvb_eit_cur_next_vals), DVB_EIT_CURRENT_NEXT_INDICATOR_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_section_number, {\r\n"Section Number", "dvb_eit.sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_last_section_number, {\r\n"Last Section Number", "dvb_eit.last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_transport_stream_id, {\r\n"Transport Stream ID", "dvb_eit.tsid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_original_network_id, {\r\n"Original Network ID", "dvb_eit.original_nid",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_segment_last_section_number, {\r\n"Segment Last Section Number", "dvb_eit.segment_last_sect_num",\r\nFT_UINT8, BASE_DEC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_last_table_id, {\r\n"Last Table ID", "dvb_eit.last_tid",\r\nFT_UINT8, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_event_id, {\r\n"Event ID", "dvb_eit.evt.id",\r\nFT_UINT16, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_start_time, {\r\n"UTC Start Time", "dvb_eit.evt.start_time",\r\nFT_ABSOLUTE_TIME, ABSOLUTE_TIME_UTC, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_duration, {\r\n"Duration", "dvb_eit.evt.duration",\r\nFT_UINT24, BASE_HEX, NULL, 0, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_running_status, {\r\n"Running Status", "dvb_eit.evt.running_status",\r\nFT_UINT16, BASE_HEX, VALS(dvb_eit_running_status_vals), DVB_EIT_RUNNING_STATUS_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_free_ca_mode, {\r\n"Free CA Mode", "dvb_eit.evt.free_ca_mode",\r\nFT_UINT16, BASE_HEX, VALS(dvb_eit_free_ca_mode_vals), DVB_EIT_FREE_CA_MODE_MASK, NULL, HFILL\r\n} },\r\n{ &hf_dvb_eit_descriptors_loop_length, {\r\n"Descriptors Loop Length", "dvb_eit.evt.descr_loop_len",\r\nFT_UINT16, BASE_HEX, NULL, DVB_EIT_DESCRIPTORS_LOOP_LENGTH_MASK, NULL, HFILL\r\n} }\r\n};\r\nstatic gint *ett[] = {\r\n&ett_dvb_eit,\r\n&ett_dvb_eit_event\r\n};\r\nproto_dvb_eit = proto_register_protocol("DVB Event Information Table", "DVB EIT", "dvb_eit");\r\nproto_register_field_array(proto_dvb_eit, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid proto_reg_handoff_dvb_eit(void)\r\n{\r\nint tid;\r\ndissector_handle_t dvb_eit_handle;\r\ndvb_eit_handle = create_dissector_handle(dissect_dvb_eit, proto_dvb_eit);\r\nfor (tid = DVB_EIT_TID_MIN; tid <= DVB_EIT_TID_MAX; tid++)\r\ndissector_add_uint("mpeg_sect.tid", tid, dvb_eit_handle);\r\n}

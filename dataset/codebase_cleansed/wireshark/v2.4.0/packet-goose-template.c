static int\r\ndissect_goose(tvbuff_t *tvb, packet_info *pinfo, proto_tree *parent_tree, void* data _U_)\r\n{\r\nint offset = 0;\r\nint old_offset;\r\nguint16 length;\r\nproto_item *item = NULL;\r\nproto_tree *tree = NULL;\r\nasn1_ctx_t asn1_ctx;\r\nasn1_ctx_init(&asn1_ctx, ASN1_ENC_BER, TRUE, pinfo);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, PNAME);\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nitem = proto_tree_add_item(parent_tree, proto_goose, tvb, 0, -1, ENC_NA);\r\ntree = proto_item_add_subtree(item, ett_goose);\r\nproto_tree_add_item(tree, hf_goose_appid, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohs(tvb, offset + 2);\r\nproto_tree_add_item(tree, hf_goose_length, tvb, offset + 2, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_goose_reserve1, tvb, offset + 4, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree, hf_goose_reserve2, tvb, offset + 6, 2, ENC_BIG_ENDIAN);\r\noffset = 8;\r\nwhile (offset < length){\r\nold_offset = offset;\r\noffset = dissect_goose_GOOSEpdu(FALSE, tvb, offset, &asn1_ctx , tree, -1);\r\nif (offset == old_offset) {\r\nproto_tree_add_expert(tree, pinfo, &ei_goose_zero_pdu, tvb, offset, -1);\r\nbreak;\r\n}\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid proto_register_goose(void) {\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_goose_appid,\r\n{ "APPID", "goose.appid", FT_UINT16, BASE_HEX_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_goose_length,\r\n{ "Length", "goose.length", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_goose_reserve1,\r\n{ "Reserved 1", "goose.reserve1", FT_UINT16, BASE_HEX_DEC, NULL, 0x0, NULL, HFILL }},\r\n{ &hf_goose_reserve2,\r\n{ "Reserved 2", "goose.reserve2", FT_UINT16, BASE_HEX_DEC, NULL, 0x0, NULL, HFILL }},\r\n#include "packet-goose-hfarr.c"\r\n};\r\nstatic gint *ett[] = {\r\n&ett_goose,\r\n#include "packet-goose-ettarr.c"\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_goose_mal_utctime, { "goose.malformed.utctime", PI_MALFORMED, PI_WARN, "BER Error: malformed UTCTime encoding", EXPFILL }},\r\n{ &ei_goose_zero_pdu, { "goose.zero_pdu", PI_PROTOCOL, PI_ERROR, "Internal error, zero-byte GOOSE PDU", EXPFILL }},\r\n};\r\nexpert_module_t* expert_goose;\r\nproto_goose = proto_register_protocol(PNAME, PSNAME, PFNAME);\r\ngoose_handle = register_dissector("goose", dissect_goose, proto_goose);\r\nproto_register_field_array(proto_goose, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_goose = expert_register_protocol(proto_goose);\r\nexpert_register_field_array(expert_goose, ei, array_length(ei));\r\n}\r\nvoid proto_reg_handoff_goose(void) {\r\ndissector_add_uint("ethertype", ETHERTYPE_IEC61850_GOOSE, goose_handle);\r\n}

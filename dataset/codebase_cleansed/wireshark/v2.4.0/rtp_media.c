size_t\r\ndecode_rtp_packet(rtp_packet_t *rp, SAMPLE **out_buff, GHashTable *decoders_hash, unsigned *channels_ptr, unsigned *sample_rate_ptr)\r\n{\r\nunsigned int payload_type;\r\nconst gchar *p;\r\nrtp_decoder_t *decoder;\r\nSAMPLE *tmp_buff = NULL;\r\nsize_t tmp_buff_len;\r\nsize_t decoded_bytes = 0;\r\nif ((rp->payload_data == NULL) || (rp->info->info_payload_len == 0) ) {\r\nreturn 0;\r\n}\r\npayload_type = rp->info->info_payload_type;\r\ndecoder = (rtp_decoder_t *)g_hash_table_lookup(decoders_hash, GUINT_TO_POINTER(payload_type));\r\nif (!decoder) {\r\ndecoder = g_new(rtp_decoder_t,1);\r\ndecoder->handle = NULL;\r\ndecoder->context = NULL;\r\nif (rp->info->info_payload_type_str && find_codec(rp->info->info_payload_type_str)) {\r\np = rp->info->info_payload_type_str;\r\n} else {\r\np = try_val_to_str_ext(payload_type, &rtp_payload_type_short_vals_ext);\r\n}\r\nif (p) {\r\ndecoder->handle = find_codec(p);\r\nif (decoder->handle)\r\ndecoder->context = codec_init(decoder->handle);\r\n}\r\ng_hash_table_insert(decoders_hash, GUINT_TO_POINTER(payload_type), decoder);\r\n}\r\nif (decoder->handle) {\r\ntmp_buff_len = codec_decode(decoder->handle, decoder->context, rp->payload_data, rp->info->info_payload_len, NULL, NULL);\r\ntmp_buff = (SAMPLE *)g_malloc(tmp_buff_len);\r\ndecoded_bytes = codec_decode(decoder->handle, decoder->context, rp->payload_data, rp->info->info_payload_len, tmp_buff, &tmp_buff_len);\r\n*out_buff = tmp_buff;\r\nif (channels_ptr) {\r\n*channels_ptr = codec_get_channels(decoder->handle, decoder->context);\r\n}\r\nif (sample_rate_ptr) {\r\n*sample_rate_ptr = codec_get_frequency(decoder->handle, decoder->context);\r\n}\r\nreturn decoded_bytes;\r\n}\r\n*out_buff = NULL;\r\nreturn 0;\r\n}\r\nstatic void\r\nrtp_decoder_value_destroy(gpointer dec_arg)\r\n{\r\nrtp_decoder_t *dec = (rtp_decoder_t *)dec_arg;\r\nif (dec->handle)\r\ncodec_release(dec->handle, dec->context);\r\ng_free(dec_arg);\r\n}\r\nGHashTable *rtp_decoder_hash_table_new(void)\r\n{\r\nreturn g_hash_table_new_full(g_direct_hash, g_direct_equal, NULL, rtp_decoder_value_destroy);\r\n}

static int\r\ndissect_gmrp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_item *ti;\r\nproto_tree *gmrp_tree, *msg_tree, *attr_tree;\r\nguint16 protocol_id;\r\nguint8 octet;\r\nguint8 attribute_type;\r\nint msg_index, attr_index, offset = 0, length = tvb_reported_length(tvb);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "GMRP");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "GMRP");\r\nti = proto_tree_add_item(tree, proto_gmrp, tvb, 0, -1, ENC_NA);\r\ngmrp_tree = proto_item_add_subtree(ti, ett_gmrp);\r\nprotocol_id = tvb_get_ntohs(tvb, GARP_PROTOCOL_ID);\r\nti = proto_tree_add_uint_format_value(gmrp_tree, hf_gmrp_proto_id, tvb,\r\nGARP_PROTOCOL_ID, 2, protocol_id,\r\n"0x%04x (%s)", protocol_id,\r\nprotocol_id == GARP_DEFAULT_PROTOCOL_ID ?\r\n"GARP Multicast Registration Protocol" :\r\n"Unknown Protocol");\r\nif (protocol_id != GARP_DEFAULT_PROTOCOL_ID)\r\n{\r\nexpert_add_info(pinfo, ti, &ei_gmrp_proto_id);\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, GARP_PROTOCOL_ID + 2),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\noffset += 2;\r\nlength -= 2;\r\nmsg_index = 0;\r\nwhile (length)\r\n{\r\nproto_item *msg_item;\r\nint msg_start = offset;\r\nattribute_type = octet = tvb_get_guint8(tvb, offset);\r\nif (octet == GARP_END_OF_MARK)\r\n{\r\nif (msg_index)\r\n{\r\nproto_tree_add_uint_format(gmrp_tree, hf_gmrp_end_of_mark, tvb, offset, 1, octet, "End of pdu");\r\nbreak;\r\n}\r\nelse\r\n{\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\n}\r\noffset += 1;\r\nlength -= 1;\r\nmsg_tree = proto_tree_add_subtree_format(gmrp_tree, tvb, msg_start, -1,\r\nett_gmrp_message, &msg_item, "Message %d", msg_index + 1);\r\nproto_tree_add_uint(msg_tree, hf_gmrp_attribute_type, tvb,\r\nmsg_start, 1, octet);\r\nif ( (octet != GMRP_ATTRIBUTE_TYPE_GROUP_MEMBERSHIP) && (octet != GMRP_ATTRIBUTE_TYPE_SERVICE_REQUIREMENT) )\r\n{\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset), pinfo,\r\ntree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nattr_index = 0;\r\nwhile (length)\r\n{\r\nint attr_start = offset;\r\nproto_item *attr_item;\r\noctet = tvb_get_guint8(tvb, offset);\r\nif (octet == GARP_END_OF_MARK)\r\n{\r\nif (attr_index)\r\n{\r\nproto_tree_add_uint_format(msg_tree, hf_gmrp_end_of_mark, tvb, offset,\r\n1, octet, " End of mark");\r\noffset += 1;\r\nlength -= 1;\r\nproto_item_set_len(msg_item, offset - msg_start);\r\nbreak;\r\n}\r\nelse\r\n{\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\n}\r\nelse\r\n{\r\nguint8 event;\r\noffset += 1;\r\nlength -= 1;\r\nattr_tree = proto_tree_add_subtree_format(msg_tree, tvb, attr_start, -1,\r\nett_gmrp_attribute_list, &attr_item, " Attribute %d", attr_index + 1);\r\nproto_tree_add_uint(attr_tree, hf_gmrp_attribute_length,\r\ntvb, attr_start, 1, octet);\r\nevent = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_uint(attr_tree, hf_gmrp_attribute_event,\r\ntvb, offset, 1, event);\r\noffset += 1;\r\nlength -= 1;\r\nswitch (event) {\r\ncase GMRP_EVENT_LEAVEALL:\r\nif (octet != GMRP_LENGTH_LEAVEALL)\r\n{\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nbreak;\r\ncase GMRP_EVENT_JOINEMPTY:\r\ncase GMRP_EVENT_JOININ:\r\ncase GMRP_EVENT_LEAVEEMPTY:\r\ncase GMRP_EVENT_LEAVEIN:\r\ncase GMRP_EVENT_EMPTY:\r\nif ( (octet != GMRP_GROUP_MEMBERSHIP_NON_LEAVEALL) &&\r\n(octet != GMRP_SERVICE_REQUIREMENT_NON_LEAVEALL) )\r\n{\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nif ( GMRP_ATTRIBUTE_TYPE_GROUP_MEMBERSHIP == attribute_type )\r\n{\r\nproto_tree_add_item(attr_tree, hf_gmrp_attribute_value_group_membership,\r\ntvb, offset, 6, ENC_NA);\r\noffset += 6;\r\nlength -= 6;\r\n}\r\nelse\r\nif ( GMRP_ATTRIBUTE_TYPE_SERVICE_REQUIREMENT == attribute_type )\r\n{\r\nproto_tree_add_item(attr_tree, hf_gmrp_attribute_value_service_requirement,\r\ntvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nlength -= 1;\r\n}\r\nelse\r\n{\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\nbreak;\r\ndefault:\r\ncall_data_dissector(tvb_new_subset_remaining(tvb, offset),\r\npinfo, tree);\r\nreturn tvb_captured_length(tvb);\r\n}\r\n}\r\nproto_item_set_len(attr_item, offset - attr_start);\r\nattr_index++;\r\n}\r\nmsg_index++;\r\n}\r\nreturn tvb_captured_length(tvb);\r\n}\r\nvoid\r\nproto_register_gmrp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_gmrp_proto_id,\r\n{ "Protocol Identifier", "gmrp.protocol_id",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL , HFILL }\r\n},\r\n{ &hf_gmrp_attribute_type,\r\n{ "Type", "gmrp.attribute_type",\r\nFT_UINT8, BASE_HEX, VALS(attribute_type_vals), 0x0,\r\nNULL , HFILL }\r\n},\r\n{ &hf_gmrp_attribute_length,\r\n{ "Length", "gmrp.attribute_length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL , HFILL }\r\n},\r\n{ &hf_gmrp_attribute_event,\r\n{ "Event", "gmrp.attribute_event",\r\nFT_UINT8, BASE_DEC, VALS(event_vals), 0x0,\r\nNULL , HFILL }\r\n},\r\n{ &hf_gmrp_attribute_value_group_membership,\r\n{ "Value", "gmrp.attribute_value_group_membership",\r\nFT_ETHER, BASE_NONE, NULL, 0x0,\r\nNULL , HFILL }\r\n},\r\n{ &hf_gmrp_attribute_value_service_requirement,\r\n{ "Value", "gmrp.attribute_value_service_requirement",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL , HFILL }\r\n},\r\n{ &hf_gmrp_end_of_mark,\r\n{ "End of mark", "gmrp.end_of_mark",\r\nFT_UINT8, BASE_HEX, NULL, 0x0,\r\nNULL , HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_gmrp,\r\n&ett_gmrp_message,\r\n&ett_gmrp_attribute_list\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_gmrp_proto_id, { "gmrp.protocol_id.not_gmrp", PI_UNDECODED, PI_WARN, "This version of Wireshark only knows about protocol id = 1", EXPFILL }},\r\n};\r\nexpert_module_t* expert_gmrp;\r\nproto_gmrp = proto_register_protocol("GARP Multicast Registration Protocol", "GMRP", "gmrp");\r\nproto_register_field_array(proto_gmrp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_gmrp = expert_register_protocol(proto_gmrp);\r\nexpert_register_field_array(expert_gmrp, ei, array_length(ei));\r\nregister_dissector("gmrp", dissect_gmrp, proto_gmrp);\r\n}

static GtkTreeIter *\r\nfill_list(GtkWidget *main_w)\r\n{\r\nGList *fl_entry;\r\nprofile_def *profile;\r\nGtkTreeView *profile_l;\r\nGtkListStore *store;\r\nGtkTreeIter iter, *l_select = NULL;\r\nconst gchar *profile_name = get_profile_name();\r\nprofile_l = GTK_TREE_VIEW(g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY));\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(profile_l));\r\ninit_profile_list();\r\nfl_entry = edited_profile_list();\r\nwhile (fl_entry && fl_entry->data) {\r\nprofile = (profile_def *)fl_entry->data;\r\ngtk_list_store_append(store, &iter);\r\ngtk_list_store_set(store, &iter, NAME_COLUMN, profile->name, GLOBAL_COLUMN, profile->is_global, DATA_COLUMN, fl_entry, -1);\r\nif (profile->name && (strcmp(profile_name, profile->name) == 0)) {\r\nl_select = (GtkTreeIter *)g_memdup(&iter, sizeof(iter));\r\n}\r\nfl_entry = g_list_next(fl_entry);\r\n}\r\nreturn l_select;\r\n}\r\nstatic void\r\nprofile_select(GtkWidget *main_w, GtkTreeView *profile_l, gboolean destroy)\r\n{\r\nGList *fl_entry;\r\nprofile_def *profile;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(profile_l));\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter)) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fl_entry, -1);\r\nif (fl_entry) {\r\nprofile = (profile_def *)fl_entry->data;\r\nif (profile_exists(profile->name, FALSE) || profile_exists(profile->name, TRUE)) {\r\nchange_configuration_profile(profile->name);\r\n} else if (!profile_exists(get_profile_name(), FALSE)) {\r\nchange_configuration_profile(NULL);\r\n}\r\n}\r\n}\r\nif (destroy) {\r\nempty_profile_list(TRUE);\r\nwindow_destroy(main_w);\r\n}\r\n}\r\nstatic void\r\nprofile_apply(GtkWidget *main_w, GtkTreeView *profile_l, gboolean destroy)\r\n{\r\nconst gchar *err_msg;\r\nif ((err_msg = apply_profile_changes()) != NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK, "%s", err_msg);\r\nreturn;\r\n}\r\nprofile_select(main_w, profile_l, destroy);\r\n}\r\nstatic void\r\nprofile_dlg_ok_cb(GtkWidget *ok_bt, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(ok_bt);\r\nGtkTreeView *profile_l = GTK_TREE_VIEW(g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY));\r\nprofile_apply(main_w, profile_l, TRUE);\r\n}\r\nstatic void\r\nprofile_dlg_apply_cb(GtkWidget *apply_bt, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(apply_bt);\r\nGtkTreeView *profile_l = GTK_TREE_VIEW(g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY));\r\nprofile_apply(main_w, profile_l, FALSE);\r\n}\r\nstatic void\r\nprofile_dlg_cancel_cb(GtkWidget *cancel_bt, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(cancel_bt);\r\nempty_profile_list(TRUE);\r\nwindow_destroy(GTK_WIDGET(main_w));\r\n}\r\nstatic gboolean\r\nprofile_dlg_delete_event_cb(GtkWidget *main_w, GdkEvent *event _U_,\r\ngpointer data)\r\n{\r\nprofile_dlg_cancel_cb(main_w, data);\r\nreturn FALSE;\r\n}\r\nstatic void\r\nprofile_dlg_destroy_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nglobal_profile_w = NULL;\r\n}\r\nstatic gboolean\r\nprofile_button_press_cb(GtkWidget *list, GdkEventButton *event, gpointer data _U_)\r\n{\r\nif (event->type == GDK_2BUTTON_PRESS) {\r\nGtkWidget *main_w = gtk_widget_get_toplevel(list);\r\nprofile_apply(main_w, GTK_TREE_VIEW(list), TRUE);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\nprofile_key_release_cb(GtkWidget *list, GdkEventKey *event, gpointer data _U_)\r\n{\r\nif ((event->keyval == GDK_Return) || (event->keyval == GDK_KP_Enter)) {\r\nGtkWidget *main_w = gtk_widget_get_toplevel(list);\r\nprofile_apply(main_w, GTK_TREE_VIEW(list), TRUE);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\nprofile_sel_list_cb(GtkTreeSelection *sel, gpointer data _U_)\r\n{\r\nGtkWidget *profile_l = GTK_WIDGET(gtk_tree_selection_get_tree_view(sel));\r\nGtkWidget *main_w = gtk_widget_get_toplevel(profile_l);\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkWidget *name_te = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_NAME_TE_KEY);\r\nGtkWidget *del_bt = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_DEL_BT_KEY);\r\nprofile_def *profile;\r\ngchar *name = NULL;\r\nGList *fl_entry;\r\ngint sensitivity = FALSE;\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter)) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fl_entry, -1);\r\nif (fl_entry) {\r\nprofile = (profile_def *)fl_entry->data;\r\nname = g_strdup(profile->name);\r\nif ((profile->status != PROF_STAT_DEFAULT) && !profile->is_global) {\r\nsensitivity = TRUE;\r\n}\r\n}\r\n}\r\nif (name_te != NULL) {\r\ngtk_entry_set_text(GTK_ENTRY(name_te), name ? name : "");\r\ngtk_widget_set_sensitive(name_te, sensitivity);\r\n}\r\nif (del_bt != NULL)\r\ngtk_widget_set_sensitive(del_bt, sensitivity);\r\ng_free(name);\r\n}\r\nstatic void\r\nprofile_new_bt_clicked_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(w);\r\nGtkWidget *name_te = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_NAME_TE_KEY);\r\nGtkTreeView *profile_l = GTK_TREE_VIEW(g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY));\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGList *fl_entry;\r\nconst gchar *name = "New profile";\r\nfl_entry = add_to_profile_list(name, "", PROF_STAT_NEW, FALSE, FALSE);\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(profile_l));\r\ngtk_list_store_append(store, &iter);\r\ngtk_list_store_set(store, &iter, NAME_COLUMN, name, GLOBAL_COLUMN, FALSE, DATA_COLUMN, fl_entry, -1);\r\ngtk_tree_selection_select_iter(gtk_tree_view_get_selection(profile_l), &iter);\r\ngtk_editable_select_region(GTK_EDITABLE(name_te), 0, -1);\r\ngtk_widget_grab_focus(name_te);\r\n}\r\nstatic void\r\nprofile_copy_bt_clicked_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(w);\r\nGtkWidget *name_te = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_NAME_TE_KEY);\r\nGtkTreeView *profile_l = GTK_TREE_VIEW(g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY));\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGList *fl_entry;\r\nconst gchar *name = gtk_entry_get_text(GTK_ENTRY(name_te));\r\nconst gchar *parent = NULL;\r\ngchar *new_name;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nprofile_def *profile = NULL;\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(profile_l));\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter)) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fl_entry, -1);\r\nif (fl_entry) {\r\nprofile = (profile_def *)fl_entry->data;\r\n}\r\n}\r\nif (profile && profile->is_global) {\r\nparent = profile->name;\r\n} else {\r\nparent = get_profile_parent(name);\r\n}\r\nif (profile && profile->is_global && !profile_exists(parent, FALSE)) {\r\nnew_name = g_strdup(name);\r\n} else {\r\nnew_name = g_strdup_printf("%s (copy)", name);\r\n}\r\nfl_entry = add_to_profile_list(new_name, parent, PROF_STAT_COPY, FALSE, profile ? profile->from_global : FALSE);\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(profile_l));\r\ngtk_list_store_append(store, &iter);\r\ngtk_list_store_set(store, &iter, NAME_COLUMN, new_name, GLOBAL_COLUMN, FALSE, DATA_COLUMN, fl_entry, -1);\r\ngtk_tree_selection_select_iter(gtk_tree_view_get_selection(profile_l), &iter);\r\ngtk_editable_select_region(GTK_EDITABLE(name_te), 0, -1);\r\ngtk_widget_grab_focus(name_te);\r\ng_free(new_name);\r\n}\r\nstatic void\r\nprofile_name_te_changed_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(w);\r\nGtkWidget *name_te = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_NAME_TE_KEY);\r\nGtkWidget *profile_l = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY);\r\nprofile_def *profile;\r\nGList *fl_entry;\r\nconst gchar *name;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(profile_l));\r\nname = gtk_entry_get_text(GTK_ENTRY(name_te));\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter)) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fl_entry, -1);\r\nif (fl_entry != NULL) {\r\nprofile = (profile_def *)fl_entry->data;\r\nif ((strlen(name) > 0) && profile && !profile->is_global) {\r\nif (profile->status != PROF_STAT_DEFAULT) {\r\ng_free(profile->name);\r\nprofile->name = g_strdup(name);\r\nif ((profile->status != PROF_STAT_NEW) &&\r\n(profile->status != PROF_STAT_COPY)) {\r\nprofile->status = PROF_STAT_CHANGED;\r\n}\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, NAME_COLUMN, name, -1);\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nprofile_del_bt_clicked_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *main_w = gtk_widget_get_toplevel(w);\r\nGtkWidget *profile_l = (GtkWidget *)g_object_get_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY);\r\nGList *fl_entry;\r\nGtkTreeSelection *sel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(profile_l));\r\nif (gtk_tree_selection_get_selected(sel, &model, &iter)) {\r\ngtk_tree_model_get(model, &iter, DATA_COLUMN, &fl_entry, -1);\r\nif (fl_entry != NULL) {\r\nremove_from_profile_list(fl_entry);\r\ngtk_list_store_remove(GTK_LIST_STORE(model), &iter);\r\n}\r\n}\r\nif (gtk_tree_model_get_iter_first(model, &iter)) {\r\ngtk_tree_selection_select_iter(sel, &iter);\r\n}\r\n}\r\nstatic GtkWidget *\r\nprofile_dialog_new(void)\r\n{\r\nGtkWidget *main_w,\r\n*main_vb,\r\n*bbox,\r\n*ok_bt,\r\n*apply_bt,\r\n*cancel_bt,\r\n*help_bt;\r\nGtkWidget *profile_vb,\r\n*props_vb;\r\nGtkWidget *top_hb,\r\n*list_bb,\r\n*new_bt,\r\n*copy_bt,\r\n*del_bt,\r\n*profile_sc,\r\n*profile_l,\r\n*middle_hb,\r\n*name_lb,\r\n*name_te,\r\n*profile_fr,\r\n*edit_fr,\r\n*props_fr;\r\nGtkListStore *store;\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nGtkTreeSelection *sel;\r\nGtkTreeIter *l_select;\r\ngboolean has_global = has_global_profiles();\r\nmain_w = dlg_conf_window_new("Wireshark: Configuration Profiles");\r\ngtk_window_set_default_size(GTK_WINDOW(main_w), 400, 400);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(main_w), main_vb);\r\ngtk_widget_show(main_vb);\r\nprofile_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(profile_vb), 0);\r\ngtk_box_pack_start(GTK_BOX(main_vb), profile_vb, TRUE, TRUE, 0);\r\ngtk_widget_show(profile_vb);\r\ntop_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start(GTK_BOX(profile_vb), top_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(top_hb);\r\nedit_fr = gtk_frame_new("Edit");\r\ngtk_box_pack_start(GTK_BOX(top_hb), edit_fr, FALSE, FALSE, 0);\r\ngtk_widget_show(edit_fr);\r\nlist_bb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, TRUE);\r\ngtk_container_set_border_width(GTK_CONTAINER(list_bb), 5);\r\ngtk_container_add(GTK_CONTAINER(edit_fr), list_bb);\r\ngtk_widget_show(list_bb);\r\nnew_bt = ws_gtk_button_new_from_stock(GTK_STOCK_NEW);\r\ng_signal_connect(new_bt, "clicked", G_CALLBACK(profile_new_bt_clicked_cb), NULL);\r\ngtk_widget_show(new_bt);\r\ngtk_box_pack_start(GTK_BOX(list_bb), new_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(new_bt, "Create a new profile (with default properties)");\r\ncopy_bt = ws_gtk_button_new_from_stock(GTK_STOCK_COPY);\r\ng_signal_connect(copy_bt, "clicked", G_CALLBACK(profile_copy_bt_clicked_cb), NULL);\r\ngtk_widget_show(copy_bt);\r\ngtk_box_pack_start(GTK_BOX(list_bb), copy_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(copy_bt, "Copy the selected profile");\r\ndel_bt = ws_gtk_button_new_from_stock(GTK_STOCK_DELETE);\r\ngtk_widget_set_sensitive(del_bt, FALSE);\r\ng_signal_connect(del_bt, "clicked", G_CALLBACK(profile_del_bt_clicked_cb), NULL);\r\ng_object_set_data(G_OBJECT(main_w), E_PROF_DEL_BT_KEY, del_bt);\r\ngtk_widget_show(del_bt);\r\ngtk_box_pack_start(GTK_BOX(list_bb), del_bt, FALSE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(del_bt, "Delete the selected profile");\r\nprofile_fr = gtk_frame_new("Configuration Profiles");\r\ngtk_box_pack_start(GTK_BOX(top_hb), profile_fr, TRUE, TRUE, 0);\r\ngtk_widget_show(profile_fr);\r\nprofile_sc = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(profile_sc),\r\nGTK_SHADOW_IN);\r\ngtk_container_set_border_width(GTK_CONTAINER(profile_sc), 5);\r\ngtk_container_add(GTK_CONTAINER(profile_fr), profile_sc);\r\ngtk_widget_show(profile_sc);\r\nstore = gtk_list_store_new(NUM_COLUMNS, G_TYPE_STRING, G_TYPE_BOOLEAN, G_TYPE_POINTER);\r\nprofile_l = tree_view_new(GTK_TREE_MODEL(store));\r\ngtk_tree_view_set_headers_visible(GTK_TREE_VIEW(profile_l), has_global);\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Name", renderer, "text", NAME_COLUMN, NULL);\r\ngtk_tree_view_column_set_expand(column, TRUE);\r\ngtk_tree_view_column_set_sort_column_id(column, NAME_COLUMN);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(profile_l), column);\r\nrenderer = gtk_cell_renderer_toggle_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes("Global", renderer, "active", GLOBAL_COLUMN, NULL);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(profile_l), column);\r\ngtk_widget_set_tooltip_text(gtk_tree_view_column_get_button(column),\r\n"Global profiles will be copied to users profiles when used");\r\ngtk_tree_view_column_set_visible(column, has_global);\r\nsel = gtk_tree_view_get_selection(GTK_TREE_VIEW(profile_l));\r\ngtk_tree_selection_set_mode(sel, GTK_SELECTION_SINGLE);\r\ng_signal_connect(sel, "changed", G_CALLBACK(profile_sel_list_cb), profile_vb);\r\ng_signal_connect(profile_l, "button_press_event", G_CALLBACK(profile_button_press_cb), NULL);\r\ng_signal_connect(profile_l, "key_release_event", G_CALLBACK(profile_key_release_cb), NULL);\r\ng_object_set_data(G_OBJECT(main_w), E_PROF_PROFILE_L_KEY, profile_l);\r\ngtk_container_add(GTK_CONTAINER(profile_sc), profile_l);\r\ngtk_widget_show(profile_l);\r\nl_select = fill_list(main_w);\r\ng_object_unref(G_OBJECT(store));\r\nprops_fr = gtk_frame_new("Properties");\r\ngtk_box_pack_start(GTK_BOX(profile_vb), props_fr, FALSE, FALSE, 0);\r\ngtk_widget_show(props_fr);\r\nprops_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(props_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(props_fr), props_vb);\r\ngtk_widget_show(props_vb);\r\nmiddle_hb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX(props_vb), middle_hb, TRUE, TRUE, 0);\r\ngtk_widget_show(middle_hb);\r\nname_lb = gtk_label_new("Profile name:");\r\ngtk_box_pack_start(GTK_BOX(middle_hb), name_lb, FALSE, FALSE, 0);\r\ngtk_widget_show(name_lb);\r\nname_te = gtk_entry_new();\r\ngtk_box_pack_start(GTK_BOX(middle_hb), name_te, TRUE, TRUE, 0);\r\ng_object_set_data(G_OBJECT(main_w), E_PROF_NAME_TE_KEY, name_te);\r\ng_signal_connect(name_te, "changed", G_CALLBACK(profile_name_te_changed_cb), NULL);\r\n#ifdef _WIN32\r\ngtk_widget_set_tooltip_text(name_te,\r\n"A profile name cannot start or end with a period (.), and cannot"\r\n" contain any of the following characters:\n \\ / : * ? \" < > |");\r\n#else\r\ngtk_widget_set_tooltip_text(name_te, "A profile name cannot contain the '/' character");\r\n#endif\r\ngtk_widget_show(name_te);\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_APPLY, GTK_STOCK_CANCEL, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 5);\r\ngtk_widget_show(bbox);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(profile_dlg_ok_cb), NULL);\r\ngtk_widget_set_tooltip_text(ok_bt, "Apply the profiles and close this dialog");\r\ndlg_set_activate(name_te, ok_bt);\r\napply_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_APPLY);\r\ng_signal_connect(apply_bt, "clicked", G_CALLBACK(profile_dlg_apply_cb), NULL);\r\ngtk_widget_set_tooltip_text(apply_bt, "Apply the profiles and keep this dialog open");\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ngtk_widget_set_tooltip_text(cancel_bt, "Cancel the changes");\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(profile_dlg_cancel_cb), NULL);\r\nwindow_set_cancel_button(main_w, cancel_bt, NULL);\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_CONFIG_PROFILES_DIALOG);\r\ngtk_widget_set_tooltip_text(help_bt, "Show topic specific help");\r\nif (ok_bt) {\r\ngtk_widget_grab_default(ok_bt);\r\n}\r\nif (l_select) {\r\ngtk_tree_selection_select_iter(sel, l_select);\r\ng_free(l_select);\r\n}\r\nif (profile_l) {\r\ngtk_widget_grab_focus(profile_l);\r\n}\r\ng_signal_connect(main_w, "delete_event", G_CALLBACK(profile_dlg_delete_event_cb), NULL);\r\ng_signal_connect(main_w, "destroy", G_CALLBACK(profile_dlg_destroy_cb), NULL);\r\ngtk_widget_show(main_w);\r\nwindow_present(main_w);\r\nreturn main_w;\r\n}\r\nstatic void\r\nselect_profile_cb(GtkWidget *w _U_, gpointer data)\r\n{\r\nconst gchar *current_profile = get_profile_name();\r\ngchar *selected_profile = (gchar *)data;\r\nif (strcmp(selected_profile, current_profile) != 0) {\r\nchange_configuration_profile(selected_profile);\r\n}\r\n}\r\ngboolean\r\nprofile_show_popup_cb(GtkWidget *w _U_, GdkEvent *event, gpointer user_data _U_)\r\n{\r\nGdkEventButton *bevent = (GdkEventButton *)event;\r\nconst gchar *profile_name = get_profile_name();\r\nGList *fl_entry;\r\nprofile_def *profile;\r\nGtkWidget *menu;\r\nGtkWidget *menu_item;\r\nGtkWidget *sub_menu = NULL;\r\nmenu = gtk_menu_new();\r\nif (bevent->button != 1) {\r\nGtkWidget *change_menu = menus_get_profiles_change_menu();\r\n#if GTK_CHECK_VERSION(2,16,0)\r\nGtkWidget *rename_menu = menus_get_profiles_rename_menu();\r\nGtkWidget *delete_menu = menus_get_profiles_delete_menu();\r\nif (strcmp(profile_name, DEFAULT_PROFILE) != 0) {\r\ngchar *label;\r\nlabel = g_strdup_printf("Rename \"%s\"...", profile_name);\r\ngtk_menu_item_set_label(GTK_MENU_ITEM(rename_menu), label);\r\ng_free(label);\r\nlabel = g_strdup_printf("Delete \"%s\"", profile_name);\r\ngtk_menu_item_set_label(GTK_MENU_ITEM(delete_menu), label);\r\ng_free(label);\r\n} else {\r\ngtk_menu_item_set_label(GTK_MENU_ITEM(rename_menu), "Rename...");\r\ngtk_menu_item_set_label(GTK_MENU_ITEM(delete_menu), "Delete");\r\n}\r\n#endif\r\ngtk_menu_item_set_submenu(GTK_MENU_ITEM(change_menu), menu);\r\n}\r\ninit_profile_list();\r\nfl_entry = current_profile_list();\r\nwhile (fl_entry && fl_entry->data) {\r\nprofile = (profile_def *)fl_entry->data;\r\nif (!profile->is_global) {\r\nmenu_item = gtk_check_menu_item_new_with_label(profile->name);\r\nif (strcmp(profile->name, profile_name)==0) {\r\ngtk_check_menu_item_set_active(GTK_CHECK_MENU_ITEM(menu_item), TRUE);\r\n}\r\ng_object_set(G_OBJECT(menu_item), "draw-as-radio", TRUE, NULL);\r\ng_signal_connect(menu_item, "activate", G_CALLBACK(select_profile_cb), g_strdup(profile->name));\r\ngtk_menu_shell_append(GTK_MENU_SHELL(menu), menu_item);\r\ngtk_widget_show(menu_item);\r\n} else {\r\nif (!sub_menu) {\r\nmenu_item = gtk_separator_menu_item_new();\r\ngtk_menu_shell_append(GTK_MENU_SHELL(menu), menu_item);\r\ngtk_widget_show(menu_item);\r\nmenu_item = gtk_menu_item_new_with_label("New from Global");\r\ngtk_menu_shell_append(GTK_MENU_SHELL(menu), menu_item);\r\ngtk_widget_show(menu_item);\r\nsub_menu = gtk_menu_new();\r\ngtk_menu_item_set_submenu(GTK_MENU_ITEM(menu_item), sub_menu);\r\n}\r\nmenu_item = gtk_menu_item_new_with_label(profile->name);\r\ng_signal_connect(menu_item, "activate", G_CALLBACK(select_profile_cb), g_strdup(profile->name));\r\nif (profile_exists(profile->name, FALSE)) {\r\ngtk_widget_set_sensitive(menu_item, FALSE);\r\n}\r\ngtk_menu_shell_append(GTK_MENU_SHELL(sub_menu), menu_item);\r\ngtk_widget_show(menu_item);\r\n}\r\nfl_entry = g_list_next(fl_entry);\r\n}\r\nif (bevent->button != 1) {\r\nreturn FALSE;\r\n}\r\ngtk_menu_popup(GTK_MENU(menu), NULL, NULL, NULL, NULL,\r\nbevent->button, bevent->time);\r\nreturn TRUE;\r\n}\r\nstatic void\r\nprofile_name_edit_ok(GtkWidget *w _U_, gpointer parent_w)\r\n{\r\ngint operation = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(w), "operation"));\r\nGtkComboBox *combo_box = (GtkComboBox *)g_object_get_data(G_OBJECT(w), "create_from");\r\nGtkWidget *entry = (GtkWidget *)g_object_get_data(G_OBJECT(w), "entry");\r\nGtkTreeStore *store;\r\nGtkTreeIter iter;\r\nconst gchar *new_name = gtk_entry_get_text(GTK_ENTRY(entry));\r\nconst gchar *profile_name = "";\r\ngboolean from_global = FALSE;\r\nchar *pf_dir_path, *pf_dir_path2, *pf_filename;\r\nif ((strlen(new_name) == 0) || (profile_name_is_valid(new_name) != NULL)) {\r\nreturn;\r\n}\r\nswitch (operation) {\r\ncase PROF_OPERATION_NEW:\r\nif (gtk_combo_box_get_active_iter(combo_box, &iter)) {\r\nstore = GTK_TREE_STORE(gtk_combo_box_get_model(combo_box));\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter, 0, &profile_name, 1, &from_global, -1);\r\n}\r\nbreak;\r\ncase PROF_OPERATION_RENAME:\r\nprofile_name = get_profile_name();\r\nif (strcmp(new_name, profile_name) == 0) {\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\nreturn;\r\n}\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\nif (profile_exists(new_name, FALSE)) {\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"The profile already exists:\n%s.", new_name);\r\nreturn;\r\n}\r\nwrite_profile_recent();\r\nswitch (operation) {\r\ncase PROF_OPERATION_NEW:\r\nif (create_persconffile_profile(new_name, &pf_dir_path) == -1) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Can't create directory\n\"%s\":\n%s.",\r\npf_dir_path, g_strerror(errno));\r\ng_free(pf_dir_path);\r\n} else if (strlen(profile_name) &&\r\n(copy_persconffile_profile(new_name, profile_name, from_global, &pf_filename,\r\n&pf_dir_path, &pf_dir_path2) != 0))\r\n{\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Can't copy file \"%s\" in directory\n\"%s\" to\n\"%s\":\n%s.",\r\npf_filename, pf_dir_path2, pf_dir_path, g_strerror(errno));\r\ng_free(pf_filename);\r\ng_free(pf_dir_path);\r\ng_free(pf_dir_path2);\r\n} else {\r\nchange_configuration_profile(new_name);\r\n}\r\nbreak;\r\ncase PROF_OPERATION_RENAME:\r\nif (rename_persconffile_profile(profile_name, new_name,\r\n&pf_dir_path, &pf_dir_path2) == -1) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Can't rename directory\n\"%s\" to\n\"%s\":\n%s.",\r\npf_dir_path, pf_dir_path2, g_strerror(errno));\r\ng_free(pf_dir_path);\r\ng_free(pf_dir_path2);\r\n} else {\r\nchange_configuration_profile(new_name);\r\n}\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\nprofile_rename_cancel(GtkWidget *w _U_, gpointer parent_w)\r\n{\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\nprofile_manage_profiles_dlg(gint operation)\r\n{\r\nGtkWidget *win, *main_grid, *main_vb, *bbox, *cancel_bt, *ok_bt;\r\nGtkWidget *entry, *label;\r\nGtkWidget *combo_box = NULL;\r\nGtkCellRenderer *cell;\r\nGtkTreeStore *store;\r\nGtkTreeIter iter, parent;\r\ngchar *window_title = NULL;\r\nGList *fl_entry;\r\nprofile_def *profile;\r\nconst gchar *profile_name;\r\ngboolean has_global = has_global_profiles();\r\nprofile_name = get_profile_name();\r\nswitch (operation) {\r\ncase PROF_OPERATION_NEW:\r\nwindow_title = g_strdup("Create New Profile");\r\nbreak;\r\ncase PROF_OPERATION_RENAME:\r\nwindow_title = g_strdup_printf("Rename: %s", profile_name);\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\nwin = dlg_window_new(window_title);\r\ng_free(window_title);\r\ngtk_window_set_resizable(GTK_WINDOW(win), FALSE);\r\ngtk_window_resize(GTK_WINDOW(win), 400, 100);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_add(GTK_CONTAINER(win), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 5);\r\nif (operation == PROF_OPERATION_NEW) {\r\nlabel = gtk_label_new("Create from:");\r\ngtk_widget_set_tooltip_text(label, "All configuration files will be copied from this profile");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, 0, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nstore = gtk_tree_store_new(3, G_TYPE_STRING, G_TYPE_BOOLEAN, G_TYPE_BOOLEAN);\r\ncombo_box = gtk_combo_box_new_with_model(GTK_TREE_MODEL(store));\r\ngtk_widget_set_tooltip_text(combo_box, "All configuration files will be copied from this profile");\r\ncell = gtk_cell_renderer_text_new();\r\ngtk_cell_layout_pack_start(GTK_CELL_LAYOUT(combo_box), cell, TRUE);\r\ngtk_cell_layout_set_attributes(GTK_CELL_LAYOUT(combo_box), cell,\r\n"text", 0, "sensitive", 2,\r\nNULL);\r\ngtk_tree_store_append(store, &iter, NULL);\r\ngtk_tree_store_set(store, &iter, 0, "", 1, FALSE, 2, TRUE, -1);\r\nif (has_global) {\r\ngtk_tree_store_append(store, &parent, NULL);\r\ngtk_tree_store_set(store, &parent, 0, "Personal", 1, FALSE, 2, FALSE, -1);\r\n}\r\ninit_profile_list();\r\nfl_entry = current_profile_list();\r\nwhile (fl_entry && fl_entry->data) {\r\nprofile = (profile_def *)fl_entry->data;\r\nif (!profile->is_global) {\r\ngtk_tree_store_append(store, &iter, has_global ? &parent : NULL);\r\ngtk_tree_store_set(store, &iter, 0, profile->name, 1, FALSE, 2, TRUE, -1);\r\n}\r\nfl_entry = g_list_next(fl_entry);\r\n}\r\nif (has_global) {\r\ngtk_tree_store_append(store, &parent, NULL);\r\ngtk_tree_store_set(store, &parent, 0, "Global", 1, FALSE, 2, FALSE, -1);\r\nfl_entry = current_profile_list();\r\nwhile (fl_entry && fl_entry->data) {\r\nprofile = (profile_def *)fl_entry->data;\r\nif (profile->is_global) {\r\ngtk_tree_store_append(store, &iter, &parent);\r\ngtk_tree_store_set(store, &iter, 0, profile->name, 1, TRUE, 2, TRUE, -1);\r\n}\r\nfl_entry = g_list_next(fl_entry);\r\n}\r\n}\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), combo_box, 1, 0, 1, 1);\r\ng_object_unref(store);\r\n}\r\nlabel = gtk_label_new("Profile name:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, 1, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nentry = gtk_entry_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), entry, 1, 1, 1, 1);\r\nswitch (operation) {\r\ncase PROF_OPERATION_NEW:\r\ngtk_entry_set_text(GTK_ENTRY(entry), "New profile");\r\nbreak;\r\ncase PROF_OPERATION_RENAME:\r\ngtk_entry_set_text(GTK_ENTRY(entry), profile_name);\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\n#ifdef _WIN32\r\ngtk_widget_set_tooltip_text(entry,\r\n"A profile name cannot start or end with a period (.), and cannot"\r\n" contain any of the following characters:\n \\ / : * ? \" < > |");\r\n#else\r\ngtk_widget_set_tooltip_text(entry, "A profile name cannot contain the '/' character");\r\n#endif\r\nbbox = dlg_button_row_new(GTK_STOCK_CANCEL, GTK_STOCK_OK, NULL);\r\ngtk_box_pack_end(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_object_set_data(G_OBJECT(ok_bt), "entry", entry);\r\ng_object_set_data(G_OBJECT(ok_bt), "create_from", combo_box);\r\ng_object_set_data(G_OBJECT(ok_bt), "operation", GINT_TO_POINTER(operation));\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(profile_name_edit_ok), win);\r\ndlg_set_activate(entry, ok_bt);\r\ngtk_widget_grab_focus(entry);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(profile_rename_cancel), win);\r\nwindow_set_cancel_button(win, cancel_bt, NULL);\r\ngtk_widget_grab_default(ok_bt);\r\ngtk_widget_show_all(win);\r\n}\r\nvoid\r\nprofile_new_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nprofile_manage_profiles_dlg(PROF_OPERATION_NEW);\r\n}\r\nvoid\r\nprofile_delete_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nif (delete_current_profile()) {\r\nchange_configuration_profile(NULL);\r\n}\r\n}\r\nvoid\r\nprofile_rename_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nprofile_manage_profiles_dlg(PROF_OPERATION_RENAME);\r\n}\r\nvoid\r\nprofile_dialog_cb(GtkWidget *w _U_)\r\n{\r\nif (global_profile_w != NULL) {\r\nreactivate_window(global_profile_w);\r\n} else {\r\nglobal_profile_w = profile_dialog_new();\r\n}\r\n}

static int\r\ndissect_btatt(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nint offset = 0;\r\nproto_item *ti, *item;\r\nproto_tree *st, *ltree;\r\nguint8 opcode;\r\nif (tvb_length_remaining(tvb, 0) < 1)\r\nreturn 0;\r\nti = proto_tree_add_item(tree, proto_btatt, tvb, 0, -1, ENC_NA);\r\nst = proto_item_add_subtree(ti, ett_btatt);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "ATT");\r\nswitch (pinfo->p2p_dir) {\r\ncase P2P_DIR_SENT:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Sent ");\r\nbreak;\r\ncase P2P_DIR_RECV:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unknown direction %d ",\r\npinfo->p2p_dir);\r\nbreak;\r\n}\r\nitem = proto_tree_add_item(st, hf_btatt_opcode, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nopcode = tvb_get_guint8(tvb, 0);\r\noffset++;\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str_const(opcode, opcode_vals, "<unknown>"));\r\nswitch (opcode) {\r\ncase 0x01:\r\nproto_tree_add_item(st, hf_btatt_req_opcode_in_error, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(st, hf_btatt_handle_in_error, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, " - %s, Handle: 0x%04x",\r\nval_to_str_const(tvb_get_guint8(tvb, offset+2), error_vals, "<unknown>"),\r\ntvb_get_letohs(tvb, offset));\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_error_code, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase 0x02:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Client Rx MTU: %u", tvb_get_letohs(tvb, offset));\r\nproto_tree_add_item(st, hf_btatt_client_rx_mtu, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x03:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Server Rx MTU: %u", tvb_get_letohs(tvb, offset));\r\nproto_tree_add_item(st, hf_btatt_server_rx_mtu, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x04:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Handles: 0x%04x..0x%04x",\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nproto_tree_add_item(st, hf_btatt_starting_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_ending_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x05:\r\n{\r\nguint8 format = tvb_get_guint8(tvb, offset);\r\nitem = proto_tree_add_item(st, hf_btatt_uuid_format, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nif( format == 1 ) {\r\nwhile( tvb_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_uuid16, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\n}\r\n}\r\nelse if( format == 2 ) {\r\nwhile( tvb_length_remaining(tvb, offset) > 0) {\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_uuid128, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\n}\r\n}\r\nelse {\r\nexpert_add_info(pinfo, item, &ei_btatt_uuid_format_unknown);\r\n}\r\n}\r\nbreak;\r\ncase 0x06:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s, Handles: 0x%04x..0x%04x",\r\nval_to_str_ext_const(tvb_get_letohs(tvb, offset+4), &bt_sig_uuid_vals_ext, "<unknown>"),\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nproto_tree_add_item(st, hf_btatt_starting_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_ending_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_uuid16, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_value, tvb, offset, -1, ENC_NA);\r\noffset = tvb_reported_length(tvb);\r\nbreak;\r\ncase 0x07:\r\nwhile( tvb_length_remaining(tvb, offset) > 0 ) {\r\nitem = proto_tree_add_none_format(st, hf_btatt_handles_info, tvb, offset, 4,\r\n"Handles Info, Handle: 0x%04x, Group End Handle: 0x%04x",\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nltree = proto_item_add_subtree(item, ett_btatt_list);\r\nproto_tree_add_item(ltree, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ltree, hf_btatt_group_end_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\n}\r\nbreak;\r\ncase 0x08:\r\ncase 0x10:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s, Handles: 0x%04x..0x%04x",\r\nval_to_str_ext_const(tvb_get_letohs(tvb, offset+4), &bt_sig_uuid_vals_ext, "<unknown>"),\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nproto_tree_add_item(st, hf_btatt_starting_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_ending_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nif (tvb_length_remaining(tvb, offset) == 2) {\r\nproto_tree_add_item(st, hf_btatt_uuid16, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\n}\r\nelse if (tvb_length_remaining(tvb, offset) == 16) {\r\nitem = proto_tree_add_item(st, hf_btatt_uuid128, tvb, offset, 16, ENC_NA);\r\nproto_item_append_text(item, " (%s)", val_to_str_ext_const(tvb_get_letohs(tvb, offset),\r\n&bt_sig_uuid_vals_ext, "<unknown>"));\r\noffset += 16;\r\n}\r\nbreak;\r\ncase 0x09:\r\n{\r\nguint8 length = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(st, hf_btatt_length, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nif(length > 0) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Attribute List Length: %u",\r\ntvb_length_remaining(tvb, offset)/length);\r\nwhile (tvb_length_remaining(tvb, offset) >= length)\r\n{\r\nitem = proto_tree_add_none_format(st, hf_btatt_attribute_data, tvb,\r\noffset, length, "Attribute Data, Handle: 0x%04x",\r\ntvb_get_letohs(tvb, offset));\r\nltree = proto_item_add_subtree(item, ett_btatt_list);\r\nproto_tree_add_item(ltree, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ltree, hf_btatt_value, tvb, offset, length - 2, ENC_NA);\r\noffset += (length-2);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase 0x0a:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Handle: 0x%04x", tvb_get_letohs(tvb, offset));\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x0b:\r\ncase 0x0d:\r\ncase 0x0f:\r\nproto_tree_add_item(st, hf_btatt_value, tvb, offset, -1, ENC_NA);\r\noffset = tvb_reported_length(tvb);\r\nbreak;\r\ncase 0x0c:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Handle: 0x%04x, Offset: %u",\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_offset, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nbreak;\r\ncase 0x0e:\r\nif(tvb_length_remaining(tvb, offset) < 4) {\r\nexpert_add_info(pinfo, item, &ei_btatt_handle_too_few);\r\nbreak;\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", Handles: ");\r\nwhile (tvb_length_remaining(tvb, offset) >= 2) {\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "0x%04x ", tvb_get_letohs(tvb, offset));\r\noffset += 2;\r\n}\r\nbreak;\r\ncase 0x11:\r\n{\r\nguint8 length = tvb_get_guint8(tvb, offset);\r\nproto_tree_add_item(st, hf_btatt_length, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nif(length > 0) {\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Attribute List Length: %u", tvb_length_remaining(tvb, offset)/length);\r\nwhile (tvb_length_remaining(tvb, offset) >= length) {\r\nitem = proto_tree_add_none_format(st, hf_btatt_attribute_data, tvb, offset, length,\r\n"Attribute Data, Handle: 0x%04x, Group End Handle: 0x%04x",\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nltree = proto_item_add_subtree(item, ett_btatt_list);\r\nproto_tree_add_item(ltree, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ltree, hf_btatt_group_end_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(ltree, hf_btatt_value, tvb, offset, length - 4, ENC_NA);\r\noffset += (length-4);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase 0x12:\r\ncase 0x52:\r\ncase 0x1b:\r\ncase 0x1d:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Handle: 0x%04x", tvb_get_letohs(tvb, offset));\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_value, tvb, offset, -1, ENC_NA);\r\noffset = tvb_reported_length(tvb);\r\nbreak;\r\ncase 0x16:\r\ncase 0x17:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Handle: 0x%04x, Offset: %u",\r\ntvb_get_letohs(tvb, offset), tvb_get_letohs(tvb, offset+2));\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_offset, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btatt_value, tvb, offset, -1, ENC_NA);\r\noffset = tvb_reported_length(tvb);\r\nbreak;\r\ncase 0x18:\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", %s",\r\nval_to_str_const(tvb_get_guint8(tvb, offset), flags_vals, "<unknown>"));\r\nproto_tree_add_item(st, hf_btatt_flags, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nbreak;\r\ncase 0xd2:\r\n{\r\nguint8 length;\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ", Handle: 0x%04x", tvb_get_letohs(tvb, offset));\r\nproto_tree_add_item(st, hf_btatt_handle, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nlength = tvb_length_remaining(tvb, offset);\r\nif (length > 12) {\r\nproto_tree_add_item(st, hf_btatt_value, tvb, offset, length-12, ENC_NA);\r\noffset+=length-12;\r\n}\r\nproto_tree_add_item(st, hf_btatt_sign_counter, tvb, offset, 4, ENC_LITTLE_ENDIAN);\r\noffset+=4;\r\nproto_tree_add_item(st, hf_btatt_signature, tvb, offset, 8, ENC_NA);\r\noffset+=8;\r\nbreak;\r\n}\r\ndefault:\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_btatt(void)\r\n{\r\nmodule_t *module;\r\nstatic hf_register_info hf[] = {\r\n{&hf_btatt_opcode,\r\n{"Opcode", "btatt.opcode",\r\nFT_UINT8, BASE_HEX, VALS(opcode_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_handles_info,\r\n{"Handles Info", "btatt.handles_info",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_attribute_data,\r\n{"Attribute Data", "btatt.attribute_data",\r\nFT_NONE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_handle,\r\n{"Handle", "btatt.handle",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_starting_handle,\r\n{"Starting Handle", "btatt.starting_handle",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_ending_handle,\r\n{"Ending Handle", "btatt.ending_handle",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_group_end_handle,\r\n{"Group End Handle", "btatt.group_end_handle",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_value,\r\n{"Value", "btatt.value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_req_opcode_in_error,\r\n{"Request Opcode in Error", "btatt.req_opcode_in_error",\r\nFT_UINT8, BASE_HEX, VALS(opcode_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_handle_in_error,\r\n{"Handle in Error", "btatt.handle_in_error",\r\nFT_UINT16, BASE_HEX, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_error_code,\r\n{"Error Code", "btatt.error_code",\r\nFT_UINT8, BASE_HEX, VALS(error_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_uuid16,\r\n{"UUID", "btatt.uuid16",\r\nFT_UINT16, BASE_HEX |BASE_EXT_STRING, &bt_sig_uuid_vals_ext, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_uuid128,\r\n{"UUID", "btatt.uuid128",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_client_rx_mtu,\r\n{"Client Rx MTU", "btatt.client_rx_mtu",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_server_rx_mtu,\r\n{"Server Rx MTU", "btatt.server_rx_mtu",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_uuid_format,\r\n{"UUID Format", "btatt.uuid_format",\r\nFT_UINT8, BASE_HEX, VALS(uuid_format_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_length,\r\n{"Length", "btatt.length",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\n"Length of Handle/Value Pair", HFILL}\r\n},\r\n{&hf_btatt_offset,\r\n{"Offset", "btatt.offset",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_flags,\r\n{"Flags", "btatt.flags",\r\nFT_UINT8, BASE_HEX, VALS(flags_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_sign_counter,\r\n{"Sign Counter", "btatt.sign_counter",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btatt_signature,\r\n{"Signature", "btatt.signature",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_btatt,\r\n&ett_btatt_list\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_btatt_uuid_format_unknown, { "btatt.uuid_format.unknown", PI_PROTOCOL, PI_WARN, "Unknown format", EXPFILL }},\r\n{ &ei_btatt_handle_too_few, { "btatt.handle.too_few", PI_PROTOCOL, PI_WARN, "Too few handles, should be 2 or more", EXPFILL }},\r\n};\r\nexpert_module_t* expert_btatt;\r\nproto_btatt = proto_register_protocol("Bluetooth Attribute Protocol", "BT ATT", "btatt");\r\nbtatt_handle = new_register_dissector("btatt", dissect_btatt, proto_btatt);\r\nproto_register_field_array(proto_btatt, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_btatt = expert_register_protocol(proto_btatt);\r\nexpert_register_field_array(expert_btatt, ei, array_length(ei));\r\nmodule = prefs_register_protocol(proto_btatt, NULL);\r\nprefs_register_static_text_preference(module, "att.version",\r\n"Bluetooth Protocol ATT version from Core 4.0",\r\n"Version of protocol supported by this dissector.");\r\n}\r\nvoid\r\nproto_reg_handoff_btatt(void)\r\n{\r\ndissector_add_uint("btl2cap.psm", BTL2CAP_PSM_ATT, btatt_handle);\r\ndissector_add_uint("btl2cap.cid", BTL2CAP_FIXED_CID_ATT, btatt_handle);\r\n}

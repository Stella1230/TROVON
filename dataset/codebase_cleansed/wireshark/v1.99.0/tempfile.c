static int\r\nmkstemp (char *template)\r\n{\r\nstatic const char letters[]\r\n= "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";\r\nsize_t len;\r\nsize_t i;\r\nlen = strlen (template);\r\nif (len < 6 || strcmp (&template[len - 6], TMP_FILE_SUFFIX))\r\n{\r\n__set_errno (EINVAL);\r\nreturn -1;\r\n}\r\nif (g_snprintf (&template[len - 5], 6, "%.5u",\r\n(unsigned int) getpid () % 100000) != 5)\r\nreturn -1;\r\nfor (i = 0; i < sizeof (letters); ++i)\r\n{\r\nint fd;\r\ntemplate[len - 6] = letters[i];\r\nfd = ws_open (template, O_RDWR|O_BINARY|O_CREAT|O_EXCL, 0600);\r\nif (fd >= 0)\r\nreturn fd;\r\n}\r\ntemplate[0] = '\0';\r\nreturn -1;\r\n}\r\nchar *\r\nmkdtemp (char *template)\r\n{\r\nstatic const char letters[]\r\n= "abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789";\r\nsize_t len;\r\nsize_t i;\r\nlen = strlen (template);\r\nif (len < 6 || strcmp (&template[len - 6], TMP_FILE_SUFFIX))\r\n{\r\n__set_errno (EINVAL);\r\nreturn NULL;\r\n}\r\nif (g_snprintf (&template[len - 5], 6, "%.5u",\r\n(unsigned int) getpid () % 100000) != 5)\r\nreturn NULL;\r\nfor (i = 0; i < sizeof (letters); ++i)\r\n{\r\nint ret;\r\ntemplate[len - 6] = letters[i];\r\nret = ws_mkdir(template, 0700);\r\nif (ret >= 0)\r\nreturn template;\r\n}\r\ntemplate[0] = '\0';\r\nreturn NULL;\r\n}\r\nchar *get_tempfile_path(const char *filename)\r\n{\r\nreturn g_strdup_printf("%s" G_DIR_SEPARATOR_S "%s", g_get_tmp_dir(), filename);\r\n}\r\nint\r\ncreate_tempfile(char **namebuf, const char *pfx)\r\n{\r\nstatic struct _tf {\r\nchar *path;\r\nunsigned long len;\r\n} tf[MAX_TEMPFILES];\r\nstatic int idx;\r\nconst char *tmp_dir;\r\nint old_umask;\r\nint fd;\r\ntime_t current_time;\r\nchar timestr[14 + 1];\r\ngchar *tmp_file;\r\ngchar *safe_pfx;\r\ngchar sep[2] = {0, 0};\r\nconst gchar *delimiters = "<>:\"/\\|?*"\r\n"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a"\r\n"\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14"\r\n"\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f";\r\nsafe_pfx = g_strdup(pfx);\r\nsafe_pfx = g_strdelimit(safe_pfx, delimiters, '-');\r\nidx = (idx + 1) % MAX_TEMPFILES;\r\nif (tf[idx].path == NULL) {\r\ntf[idx].len = INITIAL_PATH_SIZE;\r\ntf[idx].path = (char *)g_malloc(tf[idx].len);\r\n}\r\ntmp_dir = g_get_tmp_dir();\r\n#ifdef _WIN32\r\n_tzset();\r\n#endif\r\ncurrent_time = time(NULL);\r\nstrftime(timestr, sizeof(timestr), "%Y%m%d%H%M%S", localtime(&current_time));\r\nsep[0] = G_DIR_SEPARATOR;\r\ntmp_file = g_strconcat(tmp_dir, sep, safe_pfx, "_", timestr, "_", TMP_FILE_SUFFIX, NULL);\r\ng_free(safe_pfx);\r\nif (strlen(tmp_file) > tf[idx].len) {\r\ntf[idx].len = (int)strlen(tmp_file) + 1;\r\ntf[idx].path = (char *)g_realloc(tf[idx].path, tf[idx].len);\r\n}\r\ng_strlcpy(tf[idx].path, tmp_file, tf[idx].len);\r\ng_free(tmp_file);\r\nif (namebuf) {\r\n*namebuf = tf[idx].path;\r\n}\r\nold_umask = umask(0077);\r\nfd = mkstemp(tf[idx].path);\r\numask(old_umask);\r\nreturn fd;\r\n}\r\nconst char *\r\ncreate_tempdir(char **namebuf, const char *pfx)\r\n{\r\nstatic char *td_path[3];\r\nstatic int td_path_len[3];\r\nstatic int idx;\r\nconst char *tmp_dir;\r\nidx = (idx + 1) % 3;\r\nif (td_path[idx] == NULL) {\r\ntd_path_len[idx] = INITIAL_PATH_SIZE;\r\ntd_path[idx] = (char *)g_malloc(td_path_len[idx]);\r\n}\r\ntmp_dir = g_get_tmp_dir();\r\nwhile (g_snprintf(td_path[idx], td_path_len[idx], "%s%c%s" TMP_FILE_SUFFIX, tmp_dir, G_DIR_SEPARATOR, pfx) > td_path_len[idx]) {\r\ntd_path_len[idx] *= 2;\r\ntd_path[idx] = (char *)g_realloc(td_path[idx], td_path_len[idx]);\r\n}\r\nif (namebuf) {\r\n*namebuf = td_path[idx];\r\n}\r\nreturn mkdtemp(td_path[idx]);\r\n}

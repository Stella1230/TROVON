static guint\r\ncircuit_hash(gconstpointer v)\r\n{\r\nconst circuit_key *key = (const circuit_key *)v;\r\nreturn key->ctype ^ key->circuit_id;\r\n}\r\nstatic gint\r\ncircuit_match(gconstpointer v, gconstpointer w)\r\n{\r\nconst circuit_key *v1 = (const circuit_key *)v;\r\nconst circuit_key *v2 = (const circuit_key *)w;\r\nreturn v1->ctype == v2->ctype && v1->circuit_id == v2->circuit_id;\r\n}\r\nvoid\r\ncircuit_cleanup(void)\r\n{\r\nif (circuit_hashtable != NULL)\r\ng_hash_table_destroy(circuit_hashtable);\r\ncircuit_hashtable = NULL;\r\n}\r\nvoid\r\ncircuit_init(void)\r\n{\r\ng_assert(circuit_hashtable == NULL);\r\ncircuit_hashtable = g_hash_table_new(circuit_hash, circuit_match);\r\nnew_index = 0;\r\n}\r\ncircuit_t *\r\ncircuit_new(circuit_type ctype, guint32 circuit_id, guint32 first_frame)\r\n{\r\ncircuit_t *circuit, *old_circuit;\r\ncircuit_key *new_key;\r\nnew_key = se_new(struct circuit_key);\r\nnew_key->ctype = ctype;\r\nnew_key->circuit_id = circuit_id;\r\ncircuit = se_new(circuit_t);\r\ncircuit->next = NULL;\r\ncircuit->first_frame = first_frame;\r\ncircuit->last_frame = 0;\r\ncircuit->index = new_index;\r\ncircuit->data_list = NULL;\r\ncircuit->dissector_handle = NULL;\r\ncircuit->key_ptr = new_key;\r\nnew_index++;\r\nold_circuit = (circuit_t *)g_hash_table_lookup(circuit_hashtable, new_key);\r\nif (old_circuit != NULL) {\r\nwhile (old_circuit->next != NULL)\r\nold_circuit = old_circuit->next;\r\nif (old_circuit->last_frame == 0)\r\nold_circuit->last_frame = first_frame - 1;\r\nold_circuit->next = circuit;\r\n} else {\r\ng_hash_table_insert(circuit_hashtable, new_key, circuit);\r\n}\r\nreturn circuit;\r\n}\r\ncircuit_t *\r\nfind_circuit(circuit_type ctype, guint32 circuit_id, guint32 frame)\r\n{\r\ncircuit_key key;\r\ncircuit_t *circuit;\r\nkey.ctype = ctype;\r\nkey.circuit_id = circuit_id;\r\nfor (circuit = (circuit_t *)g_hash_table_lookup(circuit_hashtable, &key);\r\ncircuit != NULL; circuit = circuit->next) {\r\nif ((circuit->first_frame == 0 || circuit->first_frame <= frame)\r\n&& (circuit->last_frame == 0 || circuit->last_frame >= frame))\r\nbreak;\r\n}\r\nreturn circuit;\r\n}\r\nvoid\r\nclose_circuit(circuit_t *circuit, guint32 last_frame)\r\n{\r\nif (circuit->last_frame == 0)\r\ncircuit->last_frame = last_frame;\r\n}\r\nstatic gint\r\np_compare(gconstpointer a, gconstpointer b)\r\n{\r\nconst circuit_proto_data *ap = (const circuit_proto_data *)a;\r\nconst circuit_proto_data *bp = (const circuit_proto_data *)b;\r\nif (ap->proto > bp->proto)\r\nreturn 1;\r\nelse if (ap->proto == bp->proto)\r\nreturn 0;\r\nelse\r\nreturn -1;\r\n}\r\nvoid\r\ncircuit_add_proto_data(circuit_t *conv, int proto, void *proto_data)\r\n{\r\ncircuit_proto_data *p1 = se_new(circuit_proto_data);\r\np1->proto = proto;\r\np1->proto_data = proto_data;\r\nconv->data_list = g_slist_insert_sorted(conv->data_list, (gpointer *)p1,\r\np_compare);\r\n}\r\nvoid *\r\ncircuit_get_proto_data(circuit_t *conv, int proto)\r\n{\r\ncircuit_proto_data temp, *p1;\r\nGSList *item;\r\ntemp.proto = proto;\r\ntemp.proto_data = NULL;\r\nitem = g_slist_find_custom(conv->data_list, (gpointer *)&temp,\r\np_compare);\r\nif (item != NULL) {\r\np1 = (circuit_proto_data *)item->data;\r\nreturn p1->proto_data;\r\n}\r\nreturn NULL;\r\n}\r\nvoid\r\ncircuit_delete_proto_data(circuit_t *conv, int proto)\r\n{\r\ncircuit_proto_data temp;\r\nGSList *item;\r\ntemp.proto = proto;\r\ntemp.proto_data = NULL;\r\nitem = g_slist_find_custom(conv->data_list, (gpointer *)&temp,\r\np_compare);\r\nif (item != NULL)\r\nconv->data_list = g_slist_remove(conv->data_list, item);\r\n}\r\nvoid\r\ncircuit_set_dissector(circuit_t *circuit, dissector_handle_t handle)\r\n{\r\ncircuit->dissector_handle = handle;\r\n}\r\ndissector_handle_t\r\ncircuit_get_dissector(circuit_t *circuit)\r\n{\r\nreturn circuit->dissector_handle;\r\n}\r\ngboolean\r\ntry_circuit_dissector(circuit_type ctype, guint32 circuit_id, guint32 frame,\r\ntvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ncircuit_t *circuit;\r\ncircuit = find_circuit(ctype, circuit_id, frame);\r\nif (circuit != NULL) {\r\nif (circuit->dissector_handle == NULL)\r\nreturn FALSE;\r\ncall_dissector_with_data(circuit->dissector_handle, tvb, pinfo,\r\ntree, data);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}

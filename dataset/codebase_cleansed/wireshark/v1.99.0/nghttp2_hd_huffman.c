static ssize_t huff_encode_sym(nghttp2_bufs *bufs, size_t *avail_ptr,\r\nsize_t rembits,\r\nconst nghttp2_huff_sym *sym)\r\n{\r\nint rv;\r\nsize_t nbits = sym->nbits;\r\nfor(;;) {\r\nif(rembits > nbits) {\r\nif(*avail_ptr) {\r\nnghttp2_bufs_fast_orb_hold(bufs, sym->code << (rembits - nbits));\r\n} else {\r\nrv = nghttp2_bufs_orb_hold(bufs, sym->code << (rembits - nbits));\r\nif(rv != 0) {\r\nreturn rv;\r\n}\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\n}\r\nrembits -= nbits;\r\nbreak;\r\n}\r\nif(*avail_ptr) {\r\nnghttp2_bufs_fast_orb(bufs, sym->code >> (nbits - rembits));\r\n--*avail_ptr;\r\n} else {\r\nrv = nghttp2_bufs_orb(bufs, sym->code >> (nbits - rembits));\r\nif(rv != 0) {\r\nreturn rv;\r\n}\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\n}\r\nnbits -= rembits;\r\nrembits = 8;\r\nif(nbits == 0) {\r\nbreak;\r\n}\r\nif(*avail_ptr) {\r\nnghttp2_bufs_fast_addb_hold(bufs, 0);\r\n} else {\r\nrv = nghttp2_bufs_addb_hold(bufs, 0);\r\nif(rv != 0) {\r\nreturn rv;\r\n}\r\n*avail_ptr = nghttp2_bufs_cur_avail(bufs);\r\n}\r\n}\r\nreturn (ssize_t)rembits;\r\n}\r\nsize_t nghttp2_hd_huff_encode_count(const uint8_t *src, size_t len)\r\n{\r\nsize_t i;\r\nsize_t nbits = 0;\r\nfor(i = 0; i < len; ++i) {\r\nnbits += huff_sym_table[src[i]].nbits;\r\n}\r\nreturn (nbits + 7) / 8;\r\n}\r\nint nghttp2_hd_huff_encode(nghttp2_bufs *bufs,\r\nconst uint8_t *src, size_t srclen)\r\n{\r\nint rv;\r\nssize_t rembits = 8;\r\nsize_t i;\r\nsize_t avail;\r\navail = nghttp2_bufs_cur_avail(bufs);\r\nfor(i = 0; i < srclen; ++i) {\r\nconst nghttp2_huff_sym *sym = &huff_sym_table[src[i]];\r\nif(rembits == 8) {\r\nif(avail) {\r\nnghttp2_bufs_fast_addb_hold(bufs, 0);\r\n} else {\r\nrv = nghttp2_bufs_addb_hold(bufs, 0);\r\nif(rv != 0) {\r\nreturn rv;\r\n}\r\navail = nghttp2_bufs_cur_avail(bufs);\r\n}\r\n}\r\nrembits = huff_encode_sym(bufs, &avail, rembits, sym);\r\nif(rembits < 0) {\r\nreturn (int)rembits;\r\n}\r\n}\r\nif(rembits < 8) {\r\nconst nghttp2_huff_sym *sym = &huff_sym_table[256];\r\nif(avail) {\r\nnghttp2_bufs_fast_orb(bufs, sym->code >> (sym->nbits - rembits));\r\n} else {\r\nrv = nghttp2_bufs_orb(bufs, sym->code >> (sym->nbits - rembits));\r\nif(rv != 0) {\r\nreturn rv;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid nghttp2_hd_huff_decode_context_init(nghttp2_hd_huff_decode_context *ctx)\r\n{\r\nctx->state = 0;\r\nctx->accept = 1;\r\n}\r\nssize_t nghttp2_hd_huff_decode(nghttp2_hd_huff_decode_context *ctx,\r\nnghttp2_bufs *bufs,\r\nconst uint8_t *src, size_t srclen, int final)\r\n{\r\nsize_t i, j;\r\nint rv;\r\nsize_t avail;\r\navail = nghttp2_bufs_cur_avail(bufs);\r\nfor(i = 0; i < srclen; ++i) {\r\nuint8_t in = src[i] >> 4;\r\nfor(j = 0; j < 2; ++j) {\r\nconst nghttp2_huff_decode *t;\r\nt = &huff_decode_table[ctx->state][in];\r\nif(t->flags & NGHTTP2_HUFF_FAIL) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nif(t->flags & NGHTTP2_HUFF_SYM) {\r\nif(avail) {\r\nnghttp2_bufs_fast_addb(bufs, t->sym);\r\n--avail;\r\n} else {\r\nrv = nghttp2_bufs_addb(bufs, t->sym);\r\nif(rv != 0) {\r\nreturn rv;\r\n}\r\navail = nghttp2_bufs_cur_avail(bufs);\r\n}\r\n}\r\nctx->state = t->state;\r\nctx->accept = (t->flags & NGHTTP2_HUFF_ACCEPTED) != 0;\r\nin = src[i] & 0xf;\r\n}\r\n}\r\nif(final && !ctx->accept) {\r\nreturn NGHTTP2_ERR_HEADER_COMP;\r\n}\r\nreturn (ssize_t)i;\r\n}

static int\r\nafpstat_packet(void *pss, packet_info *pinfo, epan_dissect_t *edt _U_, const void *prv)\r\n{\r\nafpstat_t *ss=(afpstat_t *)pss;\r\nconst afp_request_val *request_val=(const afp_request_val *)prv;\r\nnstime_t t, deltat;\r\ntimestat_t *sp=NULL;\r\nif(!request_val){\r\nreturn 0;\r\n}\r\nsp=&(ss->proc[request_val->command]);\r\nt=pinfo->fd->abs_ts;\r\nnstime_delta(&deltat, &t, &request_val->req_time);\r\nif(sp){\r\ntime_stat_update(sp,&deltat, pinfo);\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nafpstat_draw(void *pss)\r\n{\r\nafpstat_t *ss=(afpstat_t *)pss;\r\nguint32 i;\r\nguint64 td;\r\nprintf("\n");\r\nprintf("===================================================================\n");\r\nprintf("AFP SRT Statistics:\n");\r\nprintf("Filter: %s\n",ss->filter?ss->filter:"");\r\nprintf("Commands Calls Min SRT Max SRT Avg SRT\n");\r\nfor(i=0;i<256;i++){\r\nif(ss->proc[i].num==0){\r\ncontinue;\r\n}\r\ntd=ss->proc[i].tot.secs;\r\ntd=td*100000+(int)ss->proc[i].tot.nsecs/10000;\r\nif(ss->proc[i].num){\r\ntd/=ss->proc[i].num;\r\n} else {\r\ntd=0;\r\n}\r\nprintf("%-25s %6d %3d.%05d %3d.%05d %3" G_GINT64_MODIFIER "u.%05" G_GINT64_MODIFIER "u\n",\r\nval_to_str_ext(i, &CommandCode_vals_ext, "Unknown (%u)"),\r\nss->proc[i].num,\r\n(int)ss->proc[i].min.secs,ss->proc[i].min.nsecs/10000,\r\n(int)ss->proc[i].max.secs,ss->proc[i].max.nsecs/10000,\r\ntd/100000, td%100000\r\n);\r\n}\r\nprintf("===================================================================\n");\r\n}\r\nstatic void\r\nafpstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nafpstat_t *ss;\r\nguint32 i;\r\nconst char *filter=NULL;\r\nGString *error_string;\r\nif(!strncmp(opt_arg,"afp,srt,",8)){\r\nfilter=opt_arg+8;\r\n} else {\r\nfilter=NULL;\r\n}\r\nss=g_new(afpstat_t,1);\r\nif(filter){\r\nss->filter=g_strdup(filter);\r\n} else {\r\nss->filter=NULL;\r\n}\r\nfor(i=0;i<256;i++){\r\nss->proc[i].num=0;\r\nss->proc[i].min_num=0;\r\nss->proc[i].max_num=0;\r\nss->proc[i].min.secs=0;\r\nss->proc[i].min.nsecs=0;\r\nss->proc[i].max.secs=0;\r\nss->proc[i].max.nsecs=0;\r\nss->proc[i].tot.secs=0;\r\nss->proc[i].tot.nsecs=0;\r\n}\r\nerror_string=register_tap_listener("afp", ss, filter, 0, NULL, afpstat_packet, afpstat_draw);\r\nif(error_string){\r\ng_free(ss->filter);\r\ng_free(ss);\r\nfprintf(stderr, "tshark: Couldn't register afp,srt tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_afpstat(void)\r\n{\r\nregister_stat_cmd_arg("afp,srt", afpstat_init,NULL);\r\n}

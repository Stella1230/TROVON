GtkWidget *\r\nfont_color_prefs_show(void)\r\n{\r\nGtkWidget *main_vb, *main_grid, *label, *combo_box;\r\nGtkWidget *font_sample, *color_sample, *colorsel;\r\nstatic const gchar *mt[] = {\r\n"Marked packet foreground",\r\n"Marked packet background",\r\n"Ignored packet foreground",\r\n"Ignored packet background",\r\n"'Follow Stream' client foreground",\r\n"'Follow Stream' client background",\r\n"'Follow Stream' server foreground",\r\n"'Follow Stream' server background",\r\n"Valid filter text entry",\r\n"Invalid filter text entry",\r\n"Deprecated filter text entry"\r\n};\r\nint mcount = sizeof(mt) / sizeof (gchar *);\r\nGtkTextBuffer *buf;\r\nGtkTextIter iter;\r\nGRand *rand_state = g_rand_new();\r\nGString *preview_string = g_string_new("");\r\nint i;\r\n#define GRID_FONT_ROW 0\r\n#define GRID_COLOR_ROW 1\r\n#define GRID_COLOR_SEL_ROW 3\r\nfont_changed = FALSE;\r\ncolor_t_to_gdkxxx(&tcolors[MFG_IDX], &prefs.gui_marked_fg);\r\ncolor_t_to_gdkxxx(&tcolors[MBG_IDX], &prefs.gui_marked_bg);\r\ncolor_t_to_gdkxxx(&tcolors[IFG_IDX], &prefs.gui_ignored_fg);\r\ncolor_t_to_gdkxxx(&tcolors[IBG_IDX], &prefs.gui_ignored_bg);\r\ncolor_t_to_gdkxxx(&tcolors[CFG_IDX], &prefs.st_client_fg);\r\ncolor_t_to_gdkxxx(&tcolors[CBG_IDX], &prefs.st_client_bg);\r\ncolor_t_to_gdkxxx(&tcolors[SFG_IDX], &prefs.st_server_fg);\r\ncolor_t_to_gdkxxx(&tcolors[SBG_IDX], &prefs.st_server_bg);\r\ncolor_t_to_gdkxxx(&tcolors[FTV_IDX], &prefs.gui_text_valid);\r\ncolor_t_to_gdkxxx(&tcolors[FTI_IDX], &prefs.gui_text_invalid);\r\ncolor_t_to_gdkxxx(&tcolors[FTD_IDX], &prefs.gui_text_deprecated);\r\ncolor_t_to_gdkxxx(&filter_text_fg, &filter_text_fg_color);\r\n#if ! GTK_CHECK_VERSION(3,4,0)\r\nfor (i=0; i<MAX_IDX; i++) {\r\ntcolors_orig[i] = tcolors[i];\r\n}\r\n#endif\r\ncurcolor = &tcolors[CFG_IDX];\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 40);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 15);\r\ngtk_widget_show(main_grid);\r\nlabel = gtk_label_new("Main window font:");\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nws_gtk_grid_attach_extended(GTK_GRID(main_grid), label,\r\n0, GRID_FONT_ROW, 1, 1,\r\n(GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_show(label);\r\nfont_button = gtk_font_button_new_with_font(prefs.gui_gtk2_font_name);\r\ngtk_font_button_set_title(GTK_FONT_BUTTON(font_button), "Wireshark: Font");\r\nws_gtk_grid_attach(GTK_GRID(main_grid), font_button,\r\n1, GRID_FONT_ROW, 1, 1);\r\ngtk_widget_show(font_button);\r\ng_string_printf(preview_string, " %s 0123456789",\r\nfont_pangrams[g_rand_int_range(rand_state, 0, NUM_FONT_PANGRAMS)]);\r\nfont_sample = gtk_text_view_new();\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(font_sample), FALSE);\r\nbuf = gtk_text_view_get_buffer(GTK_TEXT_VIEW(font_sample));\r\ngtk_text_buffer_get_start_iter(buf, &iter);\r\nsrand((unsigned int) time(NULL));\r\ngtk_text_buffer_insert(buf, &iter, preview_string->str, -1);\r\nws_gtk_grid_attach_extended(GTK_GRID(main_grid), font_sample,\r\n2, GRID_FONT_ROW, 1, 1,\r\n(GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ng_signal_connect(font_button, "font-set", G_CALLBACK(select_font), NULL);\r\ngtk_widget_show(font_sample);\r\ng_string_free(preview_string, TRUE);\r\ng_object_set_data(G_OBJECT(font_button), FONT_SAMPLE_KEY, font_sample);\r\nlabel = gtk_label_new("Colors:");\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\nws_gtk_grid_attach_extended(GTK_GRID(main_grid), label,\r\n0, GRID_COLOR_ROW, 1, 1,\r\n(GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0,0);\r\ngtk_widget_show(label);\r\n#if GTK_CHECK_VERSION(3,4,0)\r\n#endif\r\ncolorsel = gtk_color_xxx_new();\r\ncombo_box = gtk_combo_box_text_new();\r\nfor (i = 0; i < mcount; i++){\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT (combo_box), mt[i]);\r\n}\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(combo_box), CFG_IDX);\r\ng_signal_connect(combo_box, "changed", G_CALLBACK(update_current_color), colorsel);\r\nws_gtk_grid_attach(GTK_GRID(main_grid), combo_box,\r\n1, GRID_COLOR_ROW, 1, 1);\r\ngtk_widget_show(combo_box);\r\ncolor_sample = gtk_text_view_new();\r\nupdate_font(user_font_get_regular(), font_sample, color_sample);\r\ngtk_text_view_set_editable(GTK_TEXT_VIEW(color_sample), FALSE);\r\nbuf = gtk_text_view_get_buffer(GTK_TEXT_VIEW(color_sample));\r\ngtk_text_buffer_get_start_iter(buf, &iter);\r\ngtk_text_buffer_create_tag(buf, "marked",\r\nTAG_PROP_FG_COLOR, &tcolors[MFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[MBG_IDX],\r\nNULL);\r\ngtk_text_buffer_create_tag(buf, "ignored",\r\nTAG_PROP_FG_COLOR, &tcolors[IFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[IBG_IDX],\r\nNULL);\r\ngtk_text_buffer_create_tag(buf, "client",\r\nTAG_PROP_FG_COLOR, &tcolors[CFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[CBG_IDX],\r\nNULL);\r\ngtk_text_buffer_create_tag(buf, "server",\r\nTAG_PROP_FG_COLOR, &tcolors[SFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[SBG_IDX],\r\nNULL);\r\ngtk_text_buffer_create_tag(buf, "text_valid",\r\nTAG_PROP_FG_COLOR, &filter_text_fg,\r\nTAG_PROP_BG_COLOR, &tcolors[FTV_IDX],\r\nNULL);\r\ngtk_text_buffer_create_tag(buf, "text_invalid",\r\nTAG_PROP_FG_COLOR, &filter_text_fg,\r\nTAG_PROP_BG_COLOR, &tcolors[FTI_IDX],\r\nNULL);\r\ngtk_text_buffer_create_tag(buf, "text_deprecated",\r\nTAG_PROP_FG_COLOR, &filter_text_fg,\r\nTAG_PROP_BG_COLOR, &tcolors[FTD_IDX],\r\nNULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_MARKED_TEXT, -1,\r\n"marked", NULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_IGNORED_TEXT, -1,\r\n"ignored", NULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_CLIENT_TEXT, -1,\r\n"client", NULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_SERVER_TEXT, -1,\r\n"server", NULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_TEXT_VALID_TEXT, -1,\r\n"text_valid", NULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_TEXT_INVALID_TEXT, -1,\r\n"text_invalid", NULL);\r\ngtk_text_buffer_insert_with_tags_by_name(buf, &iter, SAMPLE_TEXT_DEPRECATED_TEXT, -1,\r\n"text_deprecated", NULL);\r\nws_gtk_grid_attach_extended(GTK_GRID(main_grid), color_sample,\r\n2, GRID_COLOR_ROW, 1, 2,\r\n(GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_show(color_sample);\r\ngtk_color_xxx_set_yyy(GTK_COLOR_XXX(colorsel), curcolor);\r\nws_gtk_grid_attach_extended(GTK_GRID(main_grid), colorsel,\r\n1, GRID_COLOR_SEL_ROW, 2, 1,\r\n(GtkAttachOptions)(GTK_FILL|GTK_EXPAND), (GtkAttachOptions)0, 0, 0);\r\ng_object_set_data(G_OBJECT(combo_box), COLOR_SAMPLE_KEY, color_sample);\r\ng_object_set_data(G_OBJECT(colorsel), COLOR_SAMPLE_KEY, color_sample);\r\ng_signal_connect(colorsel, COLOR_CHANGED_SIGNAL, G_CALLBACK(update_text_color), NULL);\r\ngtk_widget_show(colorsel);\r\ng_rand_free(rand_state);\r\ngtk_widget_show(main_vb);\r\nreturn main_vb;\r\n}\r\nstatic void\r\nupdate_font(PangoFontDescription *font, GtkWidget *font_sample _U_, GtkWidget *color_sample _U_) {\r\nif (!font_sample || !color_sample)\r\nreturn;\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(font_sample, font);\r\ngtk_widget_override_font(color_sample, font);\r\n#else\r\ngtk_widget_modify_font(font_sample, font);\r\ngtk_widget_modify_font(color_sample, font);\r\n#endif\r\n}\r\nstatic gboolean\r\nfont_fetch(void)\r\n{\r\ngchar *font_name;\r\nif (!font_button)\r\nreturn FALSE;\r\nfont_name = g_strdup(gtk_font_button_get_font_name(\r\nGTK_FONT_BUTTON(font_button)));\r\nif (font_name == NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"You have not selected a font.");\r\nreturn FALSE;\r\n}\r\nif (!user_font_test(font_name)) {\r\ng_free(font_name);\r\nreturn FALSE;\r\n}\r\nnew_font_name = font_name;\r\nreturn TRUE;\r\n}\r\nstatic void\r\nselect_font(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *font_sample = (GtkWidget *)g_object_get_data(G_OBJECT(w), FONT_SAMPLE_KEY);\r\nGtkWidget *color_sample = (GtkWidget *)g_object_get_data(G_OBJECT(w), COLOR_SAMPLE_KEY);\r\nconst gchar *font_name;\r\nif (!font_sample || !color_sample)\r\nreturn;\r\nfont_name = gtk_font_button_get_font_name(GTK_FONT_BUTTON(w));\r\nif (font_name) {\r\nPangoFontDescription *font = pango_font_description_from_string(font_name);\r\nupdate_font(font, font_sample, color_sample);\r\n}\r\n}\r\nstatic void\r\nupdate_text_color(GObject *obj, GParamSpec *pspec _U_, gpointer data _U_) {\r\nGtkTextView *sample = (GtkTextView *)g_object_get_data(G_OBJECT(obj), COLOR_SAMPLE_KEY);\r\nGtkTextBuffer *buf;\r\nGtkTextTag *tag;\r\ngtk_color_xxx_get_yyy(GTK_COLOR_XXX(obj), curcolor);\r\nbuf = gtk_text_view_get_buffer(sample);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "marked");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &tcolors[MFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[MBG_IDX],\r\nNULL);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "ignored");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &tcolors[IFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[IBG_IDX],\r\nNULL);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "client");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &tcolors[CFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[CBG_IDX],\r\nNULL);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "server");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &tcolors[SFG_IDX],\r\nTAG_PROP_BG_COLOR, &tcolors[SBG_IDX],\r\nNULL);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "text_valid");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &filter_text_fg,\r\nTAG_PROP_BG_COLOR, &tcolors[FTV_IDX],\r\nNULL);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "text_invalid");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &filter_text_fg,\r\nTAG_PROP_BG_COLOR, &tcolors[FTI_IDX],\r\nNULL);\r\ntag = gtk_text_tag_table_lookup(gtk_text_buffer_get_tag_table(buf), "text_deprecated");\r\ng_object_set(tag,\r\nTAG_PROP_FG_COLOR, &filter_text_fg,\r\nTAG_PROP_BG_COLOR, &tcolors[FTD_IDX],\r\nNULL);\r\n}\r\nstatic void\r\nupdate_current_color(GtkWidget *combo_box, gpointer data)\r\n{\r\nGtkWidget *colorsel = (GtkWidget *)data;\r\nGtkTextView *color_sample = (GtkTextView *)g_object_get_data(G_OBJECT(combo_box), COLOR_SAMPLE_KEY);\r\nint i;\r\nGtkTextIter iter;\r\ni = gtk_combo_box_get_active(GTK_COMBO_BOX(combo_box));\r\ncurcolor = &tcolors[i];\r\n#if ! GTK_CHECK_VERSION(3,4,0)\r\ngtk_color_selection_set_previous_color(GTK_COLOR_SELECTION(colorsel), &tcolors_orig[i]);\r\n#endif\r\ngtk_color_xxx_set_yyy(GTK_COLOR_XXX(colorsel), curcolor);\r\ngtk_text_buffer_get_start_iter(gtk_text_view_get_buffer(color_sample), &iter);\r\ngtk_text_iter_set_line(&iter, i/2);\r\ngtk_text_view_scroll_to_iter(color_sample, &iter, 0.0, FALSE, 0, 0);\r\n}\r\nvoid\r\nfont_color_prefs_fetch(GtkWidget *w _U_)\r\n{\r\ngdkxxx_to_color_t(&prefs.gui_marked_fg, &tcolors[MFG_IDX]);\r\ngdkxxx_to_color_t(&prefs.gui_marked_bg, &tcolors[MBG_IDX]);\r\ngdkxxx_to_color_t(&prefs.gui_ignored_fg, &tcolors[IFG_IDX]);\r\ngdkxxx_to_color_t(&prefs.gui_ignored_bg, &tcolors[IBG_IDX]);\r\ngdkxxx_to_color_t(&prefs.st_client_fg, &tcolors[CFG_IDX]);\r\ngdkxxx_to_color_t(&prefs.st_client_bg, &tcolors[CBG_IDX]);\r\ngdkxxx_to_color_t(&prefs.st_server_fg, &tcolors[SFG_IDX]);\r\ngdkxxx_to_color_t(&prefs.st_server_bg, &tcolors[SBG_IDX]);\r\ngdkxxx_to_color_t(&prefs.gui_text_valid, &tcolors[FTV_IDX]);\r\ngdkxxx_to_color_t(&prefs.gui_text_invalid, &tcolors[FTI_IDX]);\r\ngdkxxx_to_color_t(&prefs.gui_text_deprecated, &tcolors[FTD_IDX]);\r\nif (font_fetch()) {\r\nif (strcmp(new_font_name, prefs.gui_gtk2_font_name) != 0) {\r\nfont_changed = TRUE;\r\ng_free(prefs.gui_gtk2_font_name);\r\nprefs.gui_gtk2_font_name = g_strdup(new_font_name);\r\n}\r\n}\r\n}\r\nvoid\r\nfont_color_prefs_apply(GtkWidget *w _U_, gboolean redissect)\r\n{\r\nif (font_changed) {\r\nswitch (user_font_apply()) {\r\ncase FA_SUCCESS:\r\nbreak;\r\ncase FA_FONT_NOT_RESIZEABLE:\r\nrecent.gui_zoom_level = 0;\r\nbreak;\r\ncase FA_FONT_NOT_AVAILABLE:\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"That font isn't available at the specified zoom level;\n"\r\n"turning zooming off.");\r\nrecent.gui_zoom_level = 0;\r\nbreak;\r\n}\r\n} else if (!redissect) {\r\nredraw_packet_bytes_all();\r\n}\r\nfollow_tcp_redraw_all();\r\n}\r\nvoid\r\nfont_color_prefs_destroy(GtkWidget *w _U_)\r\n{\r\nif (new_font_name != NULL) {\r\ng_free(new_font_name);\r\nnew_font_name = NULL;\r\n}\r\nfont_button = NULL;\r\n}

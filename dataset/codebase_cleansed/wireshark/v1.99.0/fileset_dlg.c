static void\r\nfs_open_entry(fileset_entry *entry)\r\n{\r\nchar *fname;\r\nint err;\r\nfname = g_strdup(entry->fullname);\r\ncf_close(&cfile);\r\nif (cf_open(&cfile, fname, WTAP_TYPE_AUTO, FALSE, &err) == CF_OK) {\r\ncf_read(&cfile, FALSE);\r\n}\r\ng_free(fname);\r\n}\r\nstatic void\r\nfs_rb_cb(GtkWidget *open_bt, gpointer fs_data)\r\n{\r\nfileset_entry *entry = (fileset_entry *)fs_data;\r\nif (!gtk_toggle_button_get_active( GTK_TOGGLE_BUTTON(open_bt) )) {\r\nreturn;\r\n}\r\nfs_open_entry(entry);\r\n}\r\nstatic void\r\nfs_destroy_cb(GtkWidget *win _U_, gpointer user_data _U_)\r\n{\r\nfs_w = NULL;\r\n}\r\nstatic char *\r\nfileset_dlg_name2date_dup(const char * name) {\r\nchar *pfx;\r\nchar *filename;\r\nsize_t pos;\r\nif (!fileset_filename_match_pattern(name)) {\r\nreturn NULL;\r\n}\r\npfx = strrchr(name, '_');\r\npfx++;\r\npos = pfx - name;\r\nfilename = g_strdup_printf("%c%c%c%c-%c%c-%c%c %c%c:%c%c:%c%c",\r\nname[pos] , name[pos+1], name[pos+2], name[pos+3],\r\nname[pos+4], name[pos+5],\r\nname[pos+6], name[pos+7],\r\nname[pos+8], name[pos+9],\r\nname[pos+10], name[pos+11],\r\nname[pos+12], name[pos+13]);\r\nreturn filename;\r\n}\r\nvoid\r\nfileset_dlg_add_file(fileset_entry *entry, void *window _U_) {\r\nchar *created;\r\nchar *modified;\r\nchar *size;\r\nstruct tm *local;\r\nGtkWidget *fs_lb;\r\nGtkWidget *fs_rb;\r\ngchar *title;\r\nif (fs_w == NULL) {\r\nreturn;\r\n}\r\ncreated = fileset_dlg_name2date_dup(entry->name);\r\nif (!created) {\r\nlocal = localtime(&entry->ctime);\r\ncreated = g_strdup_printf("%04u-%02u-%02u %02u:%02u:%02u",\r\nlocal->tm_year+1900, local->tm_mon+1, local->tm_mday,\r\nlocal->tm_hour, local->tm_min, local->tm_sec);\r\n}\r\nlocal = localtime(&entry->mtime);\r\nmodified = g_strdup_printf("%04u-%02u-%02u %02u:%02u:%02u",\r\nlocal->tm_year+1900, local->tm_mon+1, local->tm_mday,\r\nlocal->tm_hour, local->tm_min, local->tm_sec);\r\nsize = g_strdup_printf("%" G_GINT64_MODIFIER "d Bytes", entry->size);\r\nfs_rb = gtk_radio_button_new_with_label_from_widget(\r\nfs_first_rb ? GTK_RADIO_BUTTON(fs_first_rb) : NULL, entry->name);\r\nif (row == 1) {\r\nfs_first_rb = fs_rb;\r\n}\r\nif (entry->current) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON (fs_rb), entry->current);\r\n}\r\ngtk_widget_set_tooltip_text(fs_rb, "Open this capture file");\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_rb, 0, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ng_signal_connect(fs_rb, "toggled", G_CALLBACK(fs_rb_cb), entry);\r\ngtk_widget_show(fs_rb);\r\nfs_lb = gtk_label_new(created);\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 1, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(fs_lb, entry->current);\r\ngtk_widget_show(fs_lb);\r\nfs_lb = gtk_label_new(modified);\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 2, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(fs_lb, entry->current);\r\ngtk_widget_show(fs_lb);\r\nfs_lb = gtk_label_new(size);\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 3, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_set_sensitive(fs_lb, entry->current);\r\ngtk_widget_show(fs_lb);\r\ntitle = g_strdup_printf("Wireshark: %u File%s in Set", row, plurality(row, "", "s"));\r\ngtk_window_set_title(GTK_WINDOW(fs_w), title);\r\ng_free(title);\r\ntitle = g_strdup_printf("... in directory: %s", fileset_get_dirname());\r\ngtk_label_set_text(GTK_LABEL(fs_dir_lb), title);\r\ng_free(title);\r\ngtk_widget_show_all(fs_grid);\r\nif (row <= 18) {\r\nGtkRequisition requisition;\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_get_preferred_size(fs_grid, &requisition, NULL);\r\n#else\r\ngtk_widget_size_request(fs_grid, &requisition);\r\n#endif\r\ngtk_widget_set_size_request(fs_sw, -1, requisition.height);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(fs_sw), GTK_POLICY_NEVER, GTK_POLICY_NEVER);\r\n}\r\nif (row == 18) {\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(fs_sw), GTK_POLICY_NEVER, GTK_POLICY_AUTOMATIC);\r\n}\r\nrow++;\r\ng_free(created);\r\ng_free(modified);\r\ng_free(size);\r\n}\r\nstatic void\r\nfileset_init_table(GtkWidget *parent_vb)\r\n{\r\nGtkWidget *fs_lb;\r\nfs_grid = ws_gtk_grid_new();\r\nws_gtk_grid_set_row_spacing(GTK_GRID(fs_grid), 1);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(fs_grid), 12);\r\ngtk_box_pack_start(GTK_BOX(parent_vb), fs_grid, FALSE, FALSE, 0);\r\nrow = 0;\r\nfs_first_rb = NULL;\r\nfs_lb = gtk_label_new("Filename");\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 0, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nfs_lb = gtk_label_new("Created");\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 1, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nfs_lb = gtk_label_new("Last Modified");\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 2, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\nfs_lb = gtk_label_new("Size");\r\nws_gtk_grid_attach_extended(GTK_GRID(fs_grid), fs_lb, 3, row, 1, 1, (GtkAttachOptions)(GTK_EXPAND|GTK_FILL), (GtkAttachOptions)0, 0, 0);\r\ngtk_widget_hide(fs_grid);\r\ngtk_window_set_title(GTK_WINDOW(fs_w), "Wireshark: 0 Files in Set");\r\ngtk_label_set_text(GTK_LABEL(fs_dir_lb), "No capture file loaded.");\r\nrow++;\r\n}\r\nvoid\r\nfileset_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nGtkWidget *main_vb, *bbox, *close_bt, *help_bt;\r\nif (fs_w != NULL) {\r\nreactivate_window(fs_w);\r\nreturn;\r\n}\r\nfs_w = dlg_window_new("");\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(fs_w), TRUE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_container_add(GTK_CONTAINER(fs_w), main_vb);\r\nfs_sw = gtk_scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_policy(GTK_SCROLLED_WINDOW(fs_sw), GTK_POLICY_NEVER, GTK_POLICY_NEVER);\r\ngtk_box_pack_start(GTK_BOX(main_vb), fs_sw, TRUE, TRUE, 0);\r\nfs_grid_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\n#if ! GTK_CHECK_VERSION(3,8,0)\r\ngtk_scrolled_window_add_with_viewport(GTK_SCROLLED_WINDOW(fs_sw), fs_grid_vb);\r\n#else\r\ngtk_container_add(GTK_CONTAINER(fs_sw), fs_grid_vb);\r\n#endif\r\nfs_dir_lb = gtk_label_new("");\r\ngtk_box_pack_start(GTK_BOX(main_vb), fs_dir_lb, FALSE, FALSE, 0);\r\nfileset_init_table(fs_grid_vb);\r\nbbox = dlg_button_row_new(GTK_STOCK_CLOSE, GTK_STOCK_HELP, NULL);\r\ngtk_box_pack_start(GTK_BOX(main_vb), bbox, FALSE, FALSE, 5);\r\nclose_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CLOSE);\r\nwindow_set_cancel_button(fs_w, close_bt, window_cancel_button_cb);\r\ngtk_widget_set_tooltip_text(close_bt, "Close this window.");\r\nhelp_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_HELP);\r\ng_signal_connect(help_bt, "clicked", G_CALLBACK(topic_cb), (gpointer)HELP_FILESET_DIALOG);\r\ngtk_widget_grab_default(close_bt);\r\ng_signal_connect(fs_w, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ng_signal_connect(fs_w, "destroy", G_CALLBACK(fs_destroy_cb), NULL);\r\nfileset_update_dlg(NULL);\r\ngtk_widget_show_all(fs_w);\r\nwindow_present(fs_w);\r\n}\r\nvoid\r\nfileset_next_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nfileset_entry *entry;\r\nentry = fileset_get_next();\r\nif (entry) {\r\nfs_open_entry(entry);\r\n}\r\n}\r\nvoid\r\nfileset_previous_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nfileset_entry *entry;\r\nentry = fileset_get_previous();\r\nif (entry) {\r\nfs_open_entry(entry);\r\n}\r\n}\r\nvoid\r\nfileset_file_opened(const capture_file *cf) {\r\nfileset_add_dir(cf->filename, NULL);\r\nif (fs_w) {\r\nwindow_present(fs_w);\r\n}\r\nset_menus_for_file_set(TRUE ,\r\nfileset_get_previous() != NULL, fileset_get_next() != NULL );\r\n}\r\nvoid\r\nfileset_file_closed(void)\r\n{\r\nif (fs_w) {\r\ng_object_ref(G_OBJECT(fs_grid_vb));\r\ngtk_widget_destroy(fs_grid);\r\nfileset_delete();\r\nfileset_init_table(fs_grid_vb);\r\nwindow_present(fs_w);\r\n} else {\r\nfileset_delete();\r\n}\r\nset_menus_for_file_set(FALSE ,\r\nfileset_get_previous() != NULL,\r\nfileset_get_next() != NULL );\r\n}

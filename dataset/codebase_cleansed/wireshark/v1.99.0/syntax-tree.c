void\r\nsttype_init(void)\r\n{\r\nsttype_register_function();\r\nsttype_register_integer();\r\nsttype_register_pointer();\r\nsttype_register_range();\r\nsttype_register_string();\r\nsttype_register_test();\r\n}\r\nvoid\r\nsttype_cleanup(void)\r\n{\r\n}\r\nvoid\r\nsttype_register(sttype_t *type)\r\n{\r\nsttype_id_t type_id;\r\ntype_id = type->id;\r\ng_assert(type_id < STTYPE_NUM_TYPES);\r\ng_assert(type_list[type_id] == NULL);\r\ntype_list[type_id] = type;\r\n}\r\nstatic sttype_t*\r\nsttype_lookup(sttype_id_t type_id)\r\n{\r\nsttype_t *result;\r\ng_assert(type_id < STTYPE_NUM_TYPES);\r\nresult = type_list[type_id];\r\ng_assert(result != NULL);\r\nreturn result;\r\n}\r\nstnode_t*\r\nstnode_new(sttype_id_t type_id, gpointer data)\r\n{\r\nsttype_t *type;\r\nstnode_t *node;\r\nnode = g_new(stnode_t, 1);\r\nnode->magic = STNODE_MAGIC;\r\nnode->deprecated_token = NULL;\r\nnode->inside_brackets = FALSE;\r\nif (type_id == STTYPE_UNINITIALIZED) {\r\nnode->type = NULL;\r\nnode->data = NULL;\r\n}\r\nelse {\r\ntype = sttype_lookup(type_id);\r\ng_assert(type);\r\nnode->type = type;\r\nif (type->func_new) {\r\nnode->data = type->func_new(data);\r\n}\r\nelse {\r\nnode->data = data;\r\n}\r\n}\r\nreturn node;\r\n}\r\nvoid\r\nstnode_set_bracket(stnode_t *node, gboolean bracket)\r\n{\r\nnode->inside_brackets = bracket;\r\n}\r\nstnode_t*\r\nstnode_dup(const stnode_t *org)\r\n{\r\nsttype_t *type;\r\nstnode_t *node;\r\nif (!org)\r\nreturn NULL;\r\ntype = org->type;\r\nnode = g_new(stnode_t, 1);\r\nnode->magic = STNODE_MAGIC;\r\nnode->deprecated_token = NULL;\r\nnode->type = type;\r\nif (type && type->func_dup)\r\nnode->data = type->func_dup(org->data);\r\nelse\r\nnode->data = org->data;\r\nnode->value = org->value;\r\nnode->inside_brackets = org->inside_brackets;\r\nreturn node;\r\n}\r\nvoid\r\nstnode_init(stnode_t *node, sttype_id_t type_id, gpointer data)\r\n{\r\nsttype_t *type;\r\nassert_magic(node, STNODE_MAGIC);\r\ng_assert(!node->type);\r\ng_assert(!node->data);\r\ntype = sttype_lookup(type_id);\r\ng_assert(type);\r\nnode->type = type;\r\nif (type->func_new) {\r\nnode->data = type->func_new(data);\r\n}\r\nelse {\r\nnode->data = data;\r\n}\r\n}\r\nvoid\r\nstnode_init_int(stnode_t *node, sttype_id_t type_id, gint32 value)\r\n{\r\nstnode_init(node, type_id, NULL);\r\nnode->value = value;\r\n}\r\nvoid\r\nstnode_free(stnode_t *node)\r\n{\r\nassert_magic(node, STNODE_MAGIC);\r\nif (node->type) {\r\nif (node->type->func_free) {\r\nnode->type->func_free(node->data);\r\n}\r\n}\r\nelse {\r\ng_assert(!node->data);\r\n}\r\ng_free(node);\r\n}\r\nconst char*\r\nstnode_type_name(stnode_t *node)\r\n{\r\nassert_magic(node, STNODE_MAGIC);\r\nif (node->type)\r\nreturn node->type->name;\r\nelse\r\nreturn "UNINITIALIZED";\r\n}\r\nsttype_id_t\r\nstnode_type_id(stnode_t *node)\r\n{\r\nassert_magic(node, STNODE_MAGIC);\r\nif (node->type)\r\nreturn node->type->id;\r\nelse\r\nreturn STTYPE_UNINITIALIZED;\r\n}\r\ngpointer\r\nstnode_data(stnode_t *node)\r\n{\r\nassert_magic(node, STNODE_MAGIC);\r\nreturn node->data;\r\n}\r\ngint32\r\nstnode_value(stnode_t *node)\r\n{\r\nassert_magic(node, STNODE_MAGIC);\r\nreturn node->value;\r\n}\r\nconst char *\r\nstnode_deprecated(stnode_t *node)\r\n{\r\nif (!node) {\r\nreturn NULL;\r\n}\r\nreturn node->deprecated_token;\r\n}

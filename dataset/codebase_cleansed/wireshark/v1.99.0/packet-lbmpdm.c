static guint64 lbmpdm_fetch_uint64_encoded(tvbuff_t * tvb, int offset, int encoding)\r\n{\r\nguint64 value = 0;\r\nif (encoding == ENC_BIG_ENDIAN)\r\n{\r\nvalue = tvb_get_ntoh64(tvb, offset);\r\n}\r\nelse\r\n{\r\nvalue = tvb_get_letoh64(tvb, offset);\r\n}\r\nreturn (value);\r\n}\r\nstatic guint32 lbmpdm_fetch_uint32_encoded(tvbuff_t * tvb, int offset, int encoding)\r\n{\r\nguint32 value = 0;\r\nif (encoding == ENC_BIG_ENDIAN)\r\n{\r\nvalue = tvb_get_ntohl(tvb, offset);\r\n}\r\nelse\r\n{\r\nvalue = tvb_get_letohl(tvb, offset);\r\n}\r\nreturn (value);\r\n}\r\nstatic guint16 lbmpdm_fetch_uint16_encoded(tvbuff_t * tvb, int offset, int encoding)\r\n{\r\nguint16 value = 0;\r\nif (encoding == ENC_BIG_ENDIAN)\r\n{\r\nvalue = tvb_get_ntohs(tvb, offset);\r\n}\r\nelse\r\n{\r\nvalue = tvb_get_letohs(tvb, offset);\r\n}\r\nreturn (value);\r\n}\r\nstatic int lbmpdm_get_segment_length(tvbuff_t * tvb, int offset, int encoding, int * data_length)\r\n{\r\nguint32 datalen = 0;\r\nint seglen = 0;\r\ndatalen = lbmpdm_fetch_uint32_encoded(tvb, offset + O_LBMPDM_SEG_HDR_T_LEN, encoding);\r\nseglen = ((int)datalen) + L_LBMPDM_SEG_HDR_T;\r\n*data_length = (int) datalen;\r\nreturn (seglen);\r\n}\r\nstatic void lbmpdm_definition_build_key(guint32 * key_value, wmem_tree_key_t * key, guint64 channel, guint32 id, guint8 version_major, guint8 version_minor)\r\n{\r\nkey_value[LBMPDM_DEFINITION_KEY_ELEMENT_CHANNEL_HIGH] = (guint32) ((channel >> 32) & 0xffffffff);\r\nkey_value[LBMPDM_DEFINITION_KEY_ELEMENT_CHANNEL_LOW] = (guint32) ((channel & 0xffffffff) >> 32);\r\nkey_value[LBMPDM_DEFINITION_KEY_ELEMENT_ID] = id;\r\nkey_value[LBMPDM_DEFINITION_KEY_ELEMENT_VERS_MAJOR] = version_major;\r\nkey_value[LBMPDM_DEFINITION_KEY_ELEMENT_VERS_MINOR] = version_minor;\r\nkey[0].length = LBMPDM_DEFINITION_KEY_ELEMENT_COUNT;\r\nkey[0].key = key_value;\r\nkey[1].length = 0;\r\nkey[1].key = NULL;\r\n}\r\nstatic lbmpdm_definition_t * lbmpdm_definition_find(guint64 channel, guint32 ID, guint8 version_major, guint8 version_minor)\r\n{\r\nlbmpdm_definition_t * entry = NULL;\r\nguint32 keyval[LBMPDM_DEFINITION_KEY_ELEMENT_COUNT];\r\nwmem_tree_key_t tkey[2];\r\nlbmpdm_definition_build_key(keyval, tkey, channel, ID, version_major, version_minor);\r\nentry = (lbmpdm_definition_t *) wmem_tree_lookup32_array(lbmpdm_definition_table, tkey);\r\nreturn (entry);\r\n}\r\nstatic lbmpdm_definition_t * lbmpdm_definition_add(guint64 channel, guint32 id, guint8 version_major, guint8 version_minor)\r\n{\r\nlbmpdm_definition_t * entry = NULL;\r\nguint32 keyval[LBMPDM_DEFINITION_KEY_ELEMENT_COUNT];\r\nwmem_tree_key_t tkey[2];\r\nentry = lbmpdm_definition_find(channel, id, version_major, version_minor);\r\nif (entry != NULL)\r\n{\r\nreturn (entry);\r\n}\r\nentry = wmem_new(wmem_file_scope(), lbmpdm_definition_t);\r\nentry->channel = channel;\r\nentry->id = id;\r\nentry->vers_major = version_major;\r\nentry->vers_minor = version_minor;\r\nentry->field_list = wmem_tree_new(wmem_file_scope());\r\nlbmpdm_definition_build_key(keyval, tkey, channel, id, version_major, version_minor);\r\nwmem_tree_insert32_array(lbmpdm_definition_table, tkey, (void *) entry);\r\nreturn (entry);\r\n}\r\nstatic lbmpdm_definition_field_t * lbmpdm_definition_field_find(lbmpdm_definition_t * definition, guint32 id)\r\n{\r\nlbmpdm_definition_field_t * entry = NULL;\r\nentry = (lbmpdm_definition_field_t *) wmem_tree_lookup32(definition->field_list, id);\r\nreturn (entry);\r\n}\r\nstatic lbmpdm_definition_field_t * lbmpdm_definition_field_add(lbmpdm_definition_t * definition, guint32 id)\r\n{\r\nlbmpdm_definition_field_t * entry = NULL;\r\nentry = lbmpdm_definition_field_find(definition, id);\r\nif (entry != NULL)\r\n{\r\nreturn (entry);\r\n}\r\nentry = wmem_new0(wmem_file_scope(), lbmpdm_definition_field_t);\r\nentry->id = id;\r\nentry->definition = definition;\r\nwmem_tree_insert32(definition->field_list, id, (void *) entry);\r\nreturn (entry);\r\n}\r\nstatic void dissect_field_value(tvbuff_t * tvb, int offset, proto_tree * tree, guint16 field_type, int field_length, int encoding)\r\n{\r\nswitch (field_type)\r\n{\r\ncase PDM_TYPE_BOOLEAN:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_boolean, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_INT8:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_int8, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_UINT8:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_uint8, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_INT16:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_int16, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_UINT16:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_uint16, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_INT32:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_int32, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_UINT32:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_uint32, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_INT64:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_int64, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_UINT64:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_uint64, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_FLOAT:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_float, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_DOUBLE:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_double, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_DECIMAL:\r\n{\r\ngint64 mantissa;\r\ngint8 exponent;\r\ngint64 whole = 0;\r\nguint64 fraction = 0;\r\ngint8 shift_count;\r\nexponent = (gint8)tvb_get_guint8(tvb, offset);\r\nmantissa = (gint64)lbmpdm_fetch_uint64_encoded(tvb, offset + 1, encoding);\r\nif (exponent >= 0)\r\n{\r\nwhole = mantissa;\r\nshift_count = exponent;\r\nwhile (shift_count > 0)\r\n{\r\nwhole *= 10;\r\nshift_count--;\r\n}\r\nproto_tree_add_none_format(tree, hf_lbmpdm_field_value_decimal, tvb, offset, field_length,\r\n"DECIMAL Value: %" G_GINT64_FORMAT " (%" G_GINT64_FORMAT "e%d)", whole, mantissa, exponent);\r\n}\r\nelse\r\n{\r\nguint64 divisor = 1;\r\nint decimal_digits = -exponent;\r\nshift_count = decimal_digits;\r\nwhile (shift_count > 0)\r\n{\r\ndivisor *= 10;\r\nshift_count--;\r\n}\r\nif (mantissa < 0)\r\n{\r\nwhole = -mantissa;\r\n}\r\nelse\r\n{\r\nwhole = mantissa;\r\n}\r\nfraction = whole % divisor;\r\nwhole /= divisor;\r\nif (mantissa < 0)\r\n{\r\nwhole *= -1;\r\n}\r\nproto_tree_add_none_format(tree, hf_lbmpdm_field_value_decimal, tvb, offset, field_length,\r\n"DECIMAL Value: %" G_GINT64_FORMAT ".%0*" G_GUINT64_FORMAT " (%" G_GINT64_FORMAT "e%d)",\r\nwhole, decimal_digits, fraction, mantissa, exponent);\r\n}\r\n}\r\nbreak;\r\ncase PDM_TYPE_TIMESTAMP:\r\n{\r\nnstime_t timestamp;\r\ntimestamp.secs = (time_t)lbmpdm_fetch_uint32_encoded(tvb, offset, encoding);\r\ntimestamp.nsecs = (int)(lbmpdm_fetch_uint32_encoded(tvb, offset + 4, encoding) * 1000);\r\nproto_tree_add_time(tree, hf_lbmpdm_field_value_timestamp, tvb, offset, field_length, &timestamp);\r\n}\r\nbreak;\r\ncase PDM_TYPE_FIX_STRING:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_fixed_string, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_STRING:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_string, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_FIX_UNICODE:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_fixed_unicode, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_UNICODE:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_unicode, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_BLOB:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_blob, tvb, offset, field_length, encoding);\r\nbreak;\r\ncase PDM_TYPE_MESSAGE:\r\nproto_tree_add_item(tree, hf_lbmpdm_field_value_message, tvb, offset, field_length, encoding);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int dissect_field(tvbuff_t * tvb, int offset, proto_tree * tree, lbmpdm_definition_field_t * field, gboolean string_field_names, int encoding)\r\n{\r\nproto_item * field_item = NULL;\r\nproto_tree * field_tree = NULL;\r\nproto_item * ti = NULL;\r\nint ofs = offset;\r\nguint32 element_count = 0;\r\nguint32 idx;\r\nint len_dissected = 0;\r\nfield_item = proto_tree_add_item(tree, hf_lbmpdm_field, tvb, offset, field->len, ENC_NA);\r\nfield_tree = proto_item_add_subtree(field_item, ett_lbmpdm_field);\r\nti = proto_tree_add_uint(field_tree, hf_lbmpdm_field_id, tvb, 0, 0, field->id);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nif (string_field_names)\r\n{\r\nti = proto_tree_add_string(field_tree, hf_lbmpdm_field_string_name, tvb, 0, 0, field->field_string_name);\r\n}\r\nelse\r\n{\r\nti = proto_tree_add_uint(field_tree, hf_lbmpdm_field_int_name, tvb, 0, 0, field->field_int_name);\r\n}\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nti = proto_tree_add_uint(field_tree, hf_lbmpdm_field_type, tvb, 0, 0, field->field_type);\r\nPROTO_ITEM_SET_GENERATED(ti);\r\nif (field->num_array_elem == 0)\r\n{\r\nelement_count = 1;\r\n}\r\nelse\r\n{\r\nelement_count = field->num_array_elem;\r\nif (field->fixed == PDM_DEFN_VARIABLE_LENGTH_FIELD)\r\n{\r\nproto_tree_add_item(field_tree, hf_lbmpdm_field_total_length, tvb, ofs, 4, encoding);\r\nlen_dissected += 4;\r\nofs += 4;\r\n}\r\n}\r\nfor (idx = 0; idx < element_count; ++idx)\r\n{\r\nguint32 field_len = field->len / element_count;\r\nguint32 value_len = field_len;\r\nint value_offset = ofs;\r\nif (field->fixed == PDM_DEFN_VARIABLE_LENGTH_FIELD)\r\n{\r\nproto_tree_add_item(field_tree, hf_lbmpdm_field_length, tvb, ofs, 4, encoding);\r\nvalue_len = lbmpdm_fetch_uint32_encoded(tvb, ofs, encoding);\r\nfield_len = value_len + 4;\r\nvalue_offset += 4;\r\n}\r\nelse if (field->fixed_string_len > 0)\r\n{\r\nvalue_len = field->fixed_string_len;\r\n}\r\ndissect_field_value(tvb, value_offset, field_tree, field->base_type, value_len, encoding);\r\nofs += (int)field_len;\r\nlen_dissected += (int)field_len;\r\n}\r\nreturn (len_dissected);\r\n}\r\nstatic int dissect_segment_data(tvbuff_t * tvb, int offset, packet_info * pinfo _U_, proto_tree * tree, lbmpdm_msg_definition_id_t * id, int encoding)\r\n{\r\nproto_item * subtree_item = NULL;\r\nproto_tree * subtree = NULL;\r\nint datalen = 0;\r\nint seglen = 0;\r\nlbmpdm_definition_t * def = NULL;\r\nseglen = lbmpdm_get_segment_length(tvb, offset, encoding, &datalen);\r\nsubtree_item = proto_tree_add_none_format(tree, hf_lbmpdm_segment, tvb, offset, seglen, "Data Segment");\r\nsubtree = proto_item_add_subtree(subtree_item, ett_lbmpdm_segment);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_next_hdr, tvb, offset + O_LBMPDM_SEG_HDR_T_NEXT_HDR, L_LBMPDM_SEG_HDR_T_NEXT_HDR, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_flags, tvb, offset + O_LBMPDM_SEG_HDR_T_FLAGS, L_LBMPDM_SEG_HDR_T_FLAGS, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_res, tvb, offset + O_LBMPDM_SEG_HDR_T_RES, L_LBMPDM_SEG_HDR_T_RES, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_len, tvb, offset + O_LBMPDM_SEG_HDR_T_LEN, L_LBMPDM_SEG_HDR_T_LEN, encoding);\r\nif ((id != NULL) && (id->offset_table != NULL))\r\n{\r\ndef = lbmpdm_definition_find(id->channel, id->msg_def_id, id->ver_major, id->ver_minor);\r\n}\r\nif (def == NULL)\r\n{\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_data, tvb, offset + L_LBMPDM_SEG_HDR_T, datalen, ENC_NA);\r\n}\r\nelse\r\n{\r\nint fld_offset = offset + L_LBMPDM_SEG_HDR_T;\r\nlbmpdm_definition_field_t * field = NULL;\r\ngboolean string_field_names = FALSE;\r\nguint32 idx;\r\nif (def->field_names_type == PDM_DEFN_STR_FIELD_NAMES)\r\n{\r\nstring_field_names = TRUE;\r\n}\r\nelse\r\n{\r\nstring_field_names = FALSE;\r\n}\r\nfor (field = def->first_fixed_required; field != NULL; field = field->next_fixed_required)\r\n{\r\nfld_offset += dissect_field(tvb, fld_offset, subtree, field, string_field_names, encoding);\r\n}\r\nfor (idx = 0; idx < id->offset_table->num_flds; ++idx)\r\n{\r\ngint32 ofs = id->offset_table->offset_list[idx];\r\nif (ofs != -1)\r\n{\r\nfield = lbmpdm_definition_field_find(def, idx);\r\nif (field != NULL)\r\n{\r\n(void)dissect_field(tvb, offset + L_LBMPDM_SEG_HDR_T + ofs, subtree, field, string_field_names, encoding);\r\n}\r\n}\r\n}\r\n}\r\nreturn (seglen);\r\n}\r\nstatic int dissect_segment_ofstable(tvbuff_t * tvb, int offset, packet_info * pinfo _U_, proto_tree * tree, lbmpdm_offset_table_t * * offset_table, int encoding)\r\n{\r\nproto_item * subtree_item = NULL;\r\nproto_tree * subtree = NULL;\r\nint datalen = 0;\r\nint seglen = 0;\r\nint datalen_remaining = 0;\r\nint ofs = 0;\r\nint field_count = 0;\r\nint idx;\r\ngint32 * id_list = NULL;\r\ngint32 * ofs_list = NULL;\r\ngint32 max_index = -1;\r\ngint32 min_offset = G_MAXINT32;\r\nlbmpdm_offset_table_t * ofs_table = NULL;\r\nseglen = lbmpdm_get_segment_length(tvb, offset, encoding, &datalen);\r\nsubtree_item = proto_tree_add_none_format(tree, hf_lbmpdm_segment, tvb, offset, seglen, "offset Table Segment");\r\nsubtree = proto_item_add_subtree(subtree_item, ett_lbmpdm_segment);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_next_hdr, tvb, offset + O_LBMPDM_SEG_HDR_T_NEXT_HDR, L_LBMPDM_SEG_HDR_T_NEXT_HDR, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_flags, tvb, offset + O_LBMPDM_SEG_HDR_T_FLAGS, L_LBMPDM_SEG_HDR_T_FLAGS, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_res, tvb, offset + O_LBMPDM_SEG_HDR_T_RES, L_LBMPDM_SEG_HDR_T_RES, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_len, tvb, offset + O_LBMPDM_SEG_HDR_T_LEN, L_LBMPDM_SEG_HDR_T_LEN, encoding);\r\nfield_count = datalen / L_LBMPDM_OFFSET_ENTRY_T;\r\nid_list = wmem_alloc_array(wmem_packet_scope(), gint32, field_count);\r\nofs_list = wmem_alloc_array(wmem_packet_scope(), gint32, field_count);\r\nfor (idx = 0; idx < field_count; ++idx)\r\n{\r\nid_list[idx] = -1;\r\nofs_list[idx] = -1;\r\n}\r\ndatalen_remaining = datalen;\r\nofs = offset + L_LBMPDM_SEG_HDR_T;\r\nfor (idx = 0; (idx < field_count) && (datalen_remaining >= L_LBMPDM_OFFSET_ENTRY_T); idx++, ofs += L_LBMPDM_OFFSET_ENTRY_T)\r\n{\r\nproto_item * offset_item = NULL;\r\nproto_tree * offset_tree = NULL;\r\noffset_item = proto_tree_add_item(subtree, hf_lbmpdm_offset_entry, tvb, ofs, L_LBMPDM_OFFSET_ENTRY_T, ENC_NA);\r\noffset_tree = proto_item_add_subtree(offset_item, ett_lbmpdm_offset_entry);\r\nproto_tree_add_item(offset_tree, hf_lbmpdm_offset_entry_id, tvb, ofs + O_LBMPDM_OFFSET_ENTRY_T_ID, L_LBMPDM_OFFSET_ENTRY_T_ID, encoding);\r\nid_list[idx] = (gint32)lbmpdm_fetch_uint32_encoded(tvb, ofs + O_LBMPDM_OFFSET_ENTRY_T_ID, encoding);\r\nproto_tree_add_item(offset_tree, hf_lbmpdm_offset_entry_offset, tvb, ofs + O_LBMPDM_OFFSET_ENTRY_T_OFFSET, L_LBMPDM_OFFSET_ENTRY_T_OFFSET, encoding);\r\nofs_list[idx] = (gint32)lbmpdm_fetch_uint32_encoded(tvb, ofs + O_LBMPDM_OFFSET_ENTRY_T_OFFSET, encoding);\r\nif (id_list[idx] > max_index)\r\n{\r\nmax_index = id_list[idx];\r\n}\r\nif (ofs_list[idx] < min_offset)\r\n{\r\nmin_offset = ofs_list[idx];\r\n}\r\n}\r\nofs_table = wmem_new(wmem_packet_scope(), lbmpdm_offset_table_t);\r\nofs_table->num_flds = max_index + 1;\r\nofs_table->min_set_offset = NULL;\r\nofs_table->offset_list = wmem_alloc_array(wmem_packet_scope(), gint32, ofs_table->num_flds);\r\nfor (idx = 0; idx < (int)ofs_table->num_flds; ++idx)\r\n{\r\nofs_table->offset_list[idx] = -1;\r\n}\r\nfor (idx = 0; idx < field_count; ++idx)\r\n{\r\nofs_table->offset_list[id_list[idx]] = ofs_list[idx];\r\nif (ofs_list[idx] == min_offset)\r\n{\r\nofs_table->min_set_offset = &(ofs_table->offset_list[id_list[idx]]);\r\n}\r\n}\r\nif (offset_table != NULL)\r\n{\r\n*offset_table = ofs_table;\r\n}\r\nreturn (seglen);\r\n}\r\nstatic int dissect_segment_defn(tvbuff_t * tvb, int offset, packet_info * pinfo, proto_tree * tree, guint64 channel, int encoding)\r\n{\r\nproto_item * subtree_item = NULL;\r\nproto_tree * subtree = NULL;\r\nint seglen = 0;\r\nint ofs = 0;\r\ngboolean string_field_name = FALSE;\r\nint remaining_datalen = 0;\r\nguint32 num_fields = 0;\r\nlbmpdm_definition_t * def = NULL;\r\ngboolean add_definition = FALSE;\r\nguint32 def_id = 0;\r\nguint8 vers_major = 0;\r\nguint8 vers_minor = 0;\r\nlbmpdm_definition_field_t * last_fixed_required_field = NULL;\r\nseglen = lbmpdm_get_segment_length(tvb, offset, encoding, &remaining_datalen);\r\nif (pinfo->fd->flags.visited == 0)\r\n{\r\nadd_definition = TRUE;\r\n}\r\nsubtree_item = proto_tree_add_none_format(tree, hf_lbmpdm_segment, tvb, offset, seglen, "Definition Segment");\r\nsubtree = proto_item_add_subtree(subtree_item, ett_lbmpdm_segment);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_next_hdr, tvb, offset + O_LBMPDM_SEG_HDR_T_NEXT_HDR, L_LBMPDM_SEG_HDR_T_NEXT_HDR, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_flags, tvb, offset + O_LBMPDM_SEG_HDR_T_FLAGS, L_LBMPDM_SEG_HDR_T_FLAGS, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_res, tvb, offset + O_LBMPDM_SEG_HDR_T_RES, L_LBMPDM_SEG_HDR_T_RES, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_len, tvb, offset + O_LBMPDM_SEG_HDR_T_LEN, L_LBMPDM_SEG_HDR_T_LEN, encoding);\r\nofs = offset + L_LBMPDM_SEG_HDR_T;\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_id, tvb, ofs + O_LBMPDM_DEFN_T_ID, L_LBMPDM_DEFN_T_ID, encoding);\r\ndef_id = lbmpdm_fetch_uint32_encoded(tvb, ofs + O_LBMPDM_DEFN_T_ID, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_num_fields, tvb, ofs + O_LBMPDM_DEFN_T_NUM_FIELDS, L_LBMPDM_DEFN_T_NUM_FIELDS, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_field_names_type, tvb, ofs + O_LBMPDM_DEFN_T_FIELD_NAMES_TYPE, L_LBMPDM_DEFN_T_FIELD_NAMES_TYPE, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_finalized, tvb, ofs + O_LBMPDM_DEFN_T_FINALIZED, L_LBMPDM_DEFN_T_FINALIZED, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_msg_vers_major, tvb, ofs + O_LBMPDM_DEFN_T_MSG_VERS_MAJOR, L_LBMPDM_DEFN_T_MSG_VERS_MAJOR, encoding);\r\nvers_major = tvb_get_guint8(tvb, ofs + O_LBMPDM_DEFN_T_MSG_VERS_MAJOR);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_msg_vers_minor, tvb, ofs + O_LBMPDM_DEFN_T_MSG_VERS_MINOR, L_LBMPDM_DEFN_T_MSG_VERS_MINOR, encoding);\r\nvers_minor = tvb_get_guint8(tvb, ofs + O_LBMPDM_DEFN_T_MSG_VERS_MINOR);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_fixed_req_section_len, tvb, ofs + O_LBMPDM_DEFN_T_FIXED_REQ_SECTION_LEN, L_LBMPDM_DEFN_T_FIXED_REQ_SECTION_LEN, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_def_field_info_len, tvb, ofs + O_LBMPDM_DEFN_T_FIELD_INFO_LEN, L_LBMPDM_DEFN_T_FIELD_INFO_LEN, encoding);\r\nif (tvb_get_guint8(tvb, ofs + O_LBMPDM_DEFN_T_FIELD_NAMES_TYPE) == PDM_DEFN_STR_FIELD_NAMES)\r\n{\r\nstring_field_name = TRUE;\r\n}\r\nnum_fields = lbmpdm_fetch_uint32_encoded(tvb, ofs + O_LBMPDM_DEFN_T_NUM_FIELDS, encoding);\r\nif (add_definition)\r\n{\r\ndef = lbmpdm_definition_find(channel, def_id, vers_major, vers_minor);\r\nif (def == NULL)\r\n{\r\ndef = lbmpdm_definition_add(channel, def_id, vers_major, vers_minor);\r\ndef->num_fields = num_fields;\r\ndef->field_names_type = tvb_get_guint8(tvb, ofs + O_LBMPDM_DEFN_T_FIELD_NAMES_TYPE);\r\ndef->fixed_req_section_len = lbmpdm_fetch_uint32_encoded(tvb, ofs + O_LBMPDM_DEFN_T_FIXED_REQ_SECTION_LEN, encoding);\r\ndef->first_fixed_required = NULL;\r\ndef->fixed_required_count = 0;\r\n}\r\n}\r\nofs += L_LBMPDM_DEFN_T;\r\nremaining_datalen = seglen - L_LBMPDM_SEG_HDR_T - L_LBMPDM_DEFN_T;\r\nwhile ((remaining_datalen > 0) && (num_fields > 0))\r\n{\r\nproto_item * field_item = NULL;\r\nproto_tree * field_tree = NULL;\r\nguint32 def_len = L_LBMPDM_FIELD_INFO_T_INT_NAME;\r\nint def_ofs = 0;\r\nint type_ofs = L_LBMPDM_FIELD_INFO_T;\r\nguint32 string_name_len = 0;\r\nint string_name_ofs = -1;\r\nif (string_field_name)\r\n{\r\ndef_len = lbmpdm_fetch_uint32_encoded(tvb, ofs, encoding) + 4;\r\n}\r\nfield_item = proto_tree_add_item(subtree, hf_lbmpdm_segment_def_field, tvb, ofs, def_len, ENC_NA);\r\nfield_tree = proto_item_add_subtree(field_item, ett_lbmpdm_segment_def_field);\r\nif (string_field_name)\r\n{\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_def_len, tvb, ofs, 4, encoding);\r\ndef_ofs = 4;\r\ntype_ofs += def_ofs;\r\n}\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_id, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_ID, L_LBMPDM_FIELD_INFO_T_ID, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_len, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_LEN, L_LBMPDM_FIELD_INFO_T_LEN, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_fixed_str_len, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_FIXED_STR_LEN, L_LBMPDM_FIELD_INFO_T_FIXED_STR_LEN, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_num_arr_elem, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_NUM_ARR_ELEM, L_LBMPDM_FIELD_INFO_T_NUM_ARR_ELEM, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_req, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_REQ, L_LBMPDM_FIELD_INFO_T_REQ, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_fixed, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_FIXED, L_LBMPDM_FIELD_INFO_T_FIXED, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_fld_int_name, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_FLD_INT_NAME, L_LBMPDM_FIELD_INFO_T_FLD_INT_NAME, encoding);\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_str_name_len, tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_STR_NAME_LEN, L_LBMPDM_FIELD_INFO_T_STR_NAME_LEN, encoding);\r\nif (string_field_name)\r\n{\r\nstring_name_len = lbmpdm_fetch_uint32_encoded(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_STR_NAME_LEN, encoding);\r\nif (string_name_len > 0)\r\n{\r\nstring_name_ofs = ofs + def_ofs + L_LBMPDM_FIELD_INFO_T;\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_str_name, tvb, string_name_ofs, (int)string_name_len, ENC_ASCII|ENC_NA);\r\ntype_ofs += string_name_len;\r\n}\r\n}\r\nproto_tree_add_item(field_tree, hf_lbmpdm_segment_def_field_fld_type, tvb, ofs + type_ofs, 2, encoding);\r\nif (add_definition && (def != NULL))\r\n{\r\nlbmpdm_definition_field_t * field = NULL;\r\nguint32 field_id;\r\nfield_id = lbmpdm_fetch_uint32_encoded(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_ID, encoding);\r\nfield = lbmpdm_definition_field_find(def, field_id);\r\nif (field == NULL)\r\n{\r\nfield = lbmpdm_definition_field_add(def, field_id);\r\nif (field != NULL)\r\n{\r\nfield->len = lbmpdm_fetch_uint32_encoded(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_LEN, encoding);\r\nfield->fixed_string_len = lbmpdm_fetch_uint32_encoded(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_FIXED_STR_LEN, encoding);\r\nfield->num_array_elem = lbmpdm_fetch_uint32_encoded(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_NUM_ARR_ELEM, encoding);\r\nfield->required = tvb_get_guint8(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_REQ);\r\nfield->fixed = tvb_get_guint8(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_FIXED);\r\nfield->field_int_name = lbmpdm_fetch_uint32_encoded(tvb, ofs + def_ofs + O_LBMPDM_FIELD_INFO_T_FLD_INT_NAME, encoding);\r\nif (string_field_name && (string_name_len > 0))\r\n{\r\nfield->field_string_name_len = string_name_len;\r\nfield->field_string_name = tvb_get_string_enc(wmem_file_scope(), tvb, string_name_ofs, string_name_len, ENC_ASCII);\r\n}\r\nelse\r\n{\r\nfield->field_string_name_len = 0;\r\nfield->field_string_name = NULL;\r\n}\r\nfield->field_type = lbmpdm_fetch_uint16_encoded(tvb, ofs + type_ofs, encoding);\r\nswitch (field->field_type)\r\n{\r\ncase PDM_TYPE_BOOLEAN:\r\ncase PDM_TYPE_BOOLEAN_ARR:\r\nfield->base_type = PDM_TYPE_BOOLEAN;\r\nbreak;\r\ncase PDM_TYPE_INT8:\r\ncase PDM_TYPE_INT8_ARR:\r\nfield->base_type = PDM_TYPE_INT8;\r\nbreak;\r\ncase PDM_TYPE_UINT8:\r\ncase PDM_TYPE_UINT8_ARR:\r\nfield->base_type = PDM_TYPE_UINT8;\r\nbreak;\r\ncase PDM_TYPE_INT16:\r\ncase PDM_TYPE_INT16_ARR:\r\nfield->base_type = PDM_TYPE_INT16;\r\nbreak;\r\ncase PDM_TYPE_UINT16:\r\ncase PDM_TYPE_UINT16_ARR:\r\nfield->base_type = PDM_TYPE_UINT16;\r\nbreak;\r\ncase PDM_TYPE_INT32:\r\ncase PDM_TYPE_INT32_ARR:\r\nfield->base_type = PDM_TYPE_INT32;\r\nbreak;\r\ncase PDM_TYPE_UINT32:\r\ncase PDM_TYPE_UINT32_ARR:\r\nfield->base_type = PDM_TYPE_UINT32;\r\nbreak;\r\ncase PDM_TYPE_INT64:\r\ncase PDM_TYPE_INT64_ARR:\r\nfield->base_type = PDM_TYPE_INT64;\r\nbreak;\r\ncase PDM_TYPE_UINT64:\r\ncase PDM_TYPE_UINT64_ARR:\r\nfield->base_type = PDM_TYPE_UINT64;\r\nbreak;\r\ncase PDM_TYPE_FLOAT:\r\ncase PDM_TYPE_FLOAT_ARR:\r\nfield->base_type = PDM_TYPE_FLOAT;\r\nbreak;\r\ncase PDM_TYPE_DOUBLE:\r\ncase PDM_TYPE_DOUBLE_ARR:\r\nfield->base_type = PDM_TYPE_DOUBLE;\r\nbreak;\r\ncase PDM_TYPE_DECIMAL:\r\ncase PDM_TYPE_DECIMAL_ARR:\r\nfield->base_type = PDM_TYPE_DECIMAL;\r\nbreak;\r\ncase PDM_TYPE_TIMESTAMP:\r\ncase PDM_TYPE_TIMESTAMP_ARR:\r\nfield->base_type = PDM_TYPE_TIMESTAMP;\r\nbreak;\r\ncase PDM_TYPE_FIX_STRING:\r\ncase PDM_TYPE_FIX_STRING_ARR:\r\nfield->base_type = PDM_TYPE_FIX_STRING;\r\nbreak;\r\ncase PDM_TYPE_STRING:\r\ncase PDM_TYPE_STRING_ARR:\r\nfield->base_type = PDM_TYPE_STRING;\r\nbreak;\r\ncase PDM_TYPE_FIX_UNICODE:\r\ncase PDM_TYPE_FIX_UNICODE_ARR:\r\nfield->base_type = PDM_TYPE_FIX_UNICODE;\r\nbreak;\r\ncase PDM_TYPE_UNICODE:\r\ncase PDM_TYPE_UNICODE_ARR:\r\nfield->base_type = PDM_TYPE_UNICODE;\r\nbreak;\r\ncase PDM_TYPE_BLOB:\r\ncase PDM_TYPE_BLOB_ARR:\r\ndefault:\r\nfield->base_type = PDM_TYPE_BLOB;\r\nbreak;\r\ncase PDM_TYPE_MESSAGE:\r\ncase PDM_TYPE_MESSAGE_ARR:\r\nfield->base_type = PDM_TYPE_MESSAGE;\r\nbreak;\r\n}\r\nif ((field->fixed == PDM_DEFN_FIXED_LENGTH_FIELD) && (field->required == PDM_DEFN_REQUIRED_FIELD))\r\n{\r\nif (last_fixed_required_field == NULL)\r\n{\r\ndef->first_fixed_required = field;\r\nfield->fixed_required_offset = 0;\r\n}\r\nelse\r\n{\r\nlast_fixed_required_field->next_fixed_required = field;\r\nfield->fixed_required_offset = last_fixed_required_field->fixed_required_offset + last_fixed_required_field->len;\r\n}\r\nlast_fixed_required_field = field;\r\ndef->fixed_required_count++;\r\n}\r\n}\r\n}\r\n}\r\nofs += def_len;\r\nremaining_datalen -= def_len;\r\nnum_fields--;\r\n}\r\nreturn (seglen);\r\n}\r\nstatic int dissect_segment_unknown(tvbuff_t * tvb, int offset, packet_info * pinfo _U_, proto_tree * tree, int encoding)\r\n{\r\nproto_item * subtree_item = NULL;\r\nproto_tree * subtree = NULL;\r\nint datalen = 0;\r\nint seglen = 0;\r\nseglen = lbmpdm_get_segment_length(tvb, offset, encoding, &datalen);\r\nsubtree_item = proto_tree_add_none_format(tree, hf_lbmpdm_segment, tvb, offset, seglen, "Unknown Segment");\r\nsubtree = proto_item_add_subtree(subtree_item, ett_lbmpdm_segment);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_next_hdr, tvb, offset + O_LBMPDM_SEG_HDR_T_NEXT_HDR, L_LBMPDM_SEG_HDR_T_NEXT_HDR, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_flags, tvb, offset + O_LBMPDM_SEG_HDR_T_FLAGS, L_LBMPDM_SEG_HDR_T_FLAGS, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_res, tvb, offset + O_LBMPDM_SEG_HDR_T_RES, L_LBMPDM_SEG_HDR_T_RES, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_len, tvb, offset + O_LBMPDM_SEG_HDR_T_LEN, L_LBMPDM_SEG_HDR_T_LEN, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_segment_data, tvb, offset + L_LBMPDM_SEG_HDR_T, datalen, ENC_NA);\r\nreturn (seglen);\r\n}\r\nstatic gboolean check_lbmpdm_encoding(tvbuff_t * tvb, int offset, int * encoding)\r\n{\r\nguint8 magic_byte_1;\r\nguint8 magic_byte_2;\r\nguint8 magic_byte_3;\r\nguint8 magic_byte_4;\r\ngboolean result = TRUE;\r\nmagic_byte_1 = tvb_get_guint8(tvb, offset);\r\nmagic_byte_2 = tvb_get_guint8(tvb, offset + 1);\r\nmagic_byte_3 = tvb_get_guint8(tvb, offset + 2);\r\nmagic_byte_4 = tvb_get_guint8(tvb, offset + 3);\r\nif ((magic_byte_1 == PDM_MSG_HDR_BE_MAGIC_BYTE_1) && (magic_byte_2 == PDM_MSG_HDR_BE_MAGIC_BYTE_2)\r\n&& (magic_byte_3 == PDM_MSG_HDR_BE_MAGIC_BYTE_3) && (magic_byte_4 == PDM_MSG_HDR_BE_MAGIC_BYTE_4))\r\n{\r\n*encoding = ENC_BIG_ENDIAN;\r\n}\r\nelse if ((magic_byte_1 == PDM_MSG_HDR_LE_MAGIC_BYTE_1) && (magic_byte_2 == PDM_MSG_HDR_LE_MAGIC_BYTE_2)\r\n&& (magic_byte_3 == PDM_MSG_HDR_LE_MAGIC_BYTE_3) && (magic_byte_4 == PDM_MSG_HDR_LE_MAGIC_BYTE_4))\r\n{\r\n*encoding = ENC_LITTLE_ENDIAN;\r\n}\r\nelse\r\n{\r\nresult = FALSE;\r\n}\r\nreturn (result);\r\n}\r\ngboolean lbmpdm_verify_payload(tvbuff_t * tvb, int offset, int * encoding, int * length)\r\n{\r\nguint8 next_header;\r\nguint32 len = 0;\r\nif (!tvb_bytes_exist(tvb, offset, L_LBMPDM_MSG_HDR_T))\r\n{\r\nreturn (FALSE);\r\n}\r\nif (!check_lbmpdm_encoding(tvb, offset, encoding))\r\n{\r\nreturn (FALSE);\r\n}\r\nnext_header = tvb_get_guint8(tvb, offset + O_LBMPDM_MSG_HDR_T_NEXT_HDR);\r\nswitch (next_header)\r\n{\r\ncase PDM_HDR_TYPE_DATA:\r\ncase PDM_HDR_TYPE_OFSTTBLE:\r\ncase PDM_HDR_TYPE_DEFN:\r\ncase PDM_HDR_TYPE_EOM:\r\nbreak;\r\ndefault:\r\nreturn (FALSE);\r\nbreak;\r\n}\r\nlen = lbmpdm_fetch_uint32_encoded(tvb, offset + O_LBMPDM_MSG_HDR_T_LEN, *encoding);\r\nif (len > G_MAXINT)\r\n{\r\nreturn (FALSE);\r\n}\r\n*length = (int)len;\r\nreturn (TRUE);\r\n}\r\nint lbmpdm_dissect_lbmpdm_payload(tvbuff_t * tvb, int offset, packet_info * pinfo, proto_tree * tree, guint64 channel)\r\n{\r\nproto_item * subtree_item = NULL;\r\nproto_tree * subtree = NULL;\r\nproto_item * ver_type_item = NULL;\r\nproto_tree * ver_type_tree = NULL;\r\nproto_item * segments_item = NULL;\r\nproto_tree * segments_tree = NULL;\r\nproto_item * pi = NULL;\r\nguint8 type;\r\nguint8 version;\r\nguint8 ver_type;\r\nguint8 next_hdr;\r\nint dissected_len = 0;\r\nint encoding;\r\nint msglen = 0;\r\nint len_remaining = 0;\r\nint ofs = 0;\r\nint segment_len = 0;\r\nint datalen = 0;\r\nguint32 raw_msglen = 0;\r\nlbmpdm_msg_definition_id_t msgid;\r\nif (!lbmpdm_verify_payload(tvb, offset, &encoding, &raw_msglen))\r\n{\r\nreturn (0);\r\n}\r\nmsglen = (int)raw_msglen;\r\nmsgid.channel = channel;\r\nmsgid.msg_def_id = 0;\r\nmsgid.ver_major = 0;\r\nmsgid.ver_minor = 0;\r\nmsgid.offset_table = NULL;\r\nsubtree_item = proto_tree_add_protocol_format(tree, proto_lbmpdm, tvb, offset, msglen, "LBMPDM Protocol");\r\nsubtree = proto_item_add_subtree(subtree_item, ett_lbmpdm);\r\nproto_tree_add_item(subtree, hf_lbmpdm_magic, tvb, offset + O_LBMPDM_MSG_HDR_T_MAGIC, L_LBMPDM_MSG_HDR_T_MAGIC, encoding);\r\npi = proto_tree_add_string(subtree, hf_lbmpdm_encoding, tvb, offset + O_LBMPDM_MSG_HDR_T_MAGIC, L_LBMPDM_MSG_HDR_T_MAGIC,\r\n((encoding == ENC_BIG_ENDIAN) ? "Big-Endian" : "Little-Endian"));\r\nPROTO_ITEM_SET_GENERATED(pi);\r\nver_type = tvb_get_guint8(tvb, offset + O_LBMPDM_MSG_HDR_T_VER_TYPE);\r\nversion = PDM_HDR_VER(ver_type);\r\ntype = PDM_HDR_TYPE(ver_type);\r\nver_type_item = proto_tree_add_none_format(subtree, hf_lbmpdm_ver_type, tvb, offset + O_LBMPDM_MSG_HDR_T_VER_TYPE,\r\nL_LBMPDM_MSG_HDR_T_VER_TYPE, "Version/Type: 0x%02x (Version:%u, Type:%u)", ver_type, version, type);\r\nver_type_tree = proto_item_add_subtree(ver_type_item, ett_lbmpdm_ver_type);\r\nproto_tree_add_item(ver_type_tree, hf_lbmpdm_ver_type_ver, tvb, offset + O_LBMPDM_MSG_HDR_T_VER_TYPE, L_LBMPDM_MSG_HDR_T_VER_TYPE, encoding);\r\nproto_tree_add_item(ver_type_tree, hf_lbmpdm_ver_type_type, tvb, offset + O_LBMPDM_MSG_HDR_T_VER_TYPE, L_LBMPDM_MSG_HDR_T_VER_TYPE, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_next_hdr, tvb, offset + O_LBMPDM_MSG_HDR_T_NEXT_HDR, L_LBMPDM_MSG_HDR_T_NEXT_HDR, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_def_major_ver, tvb, offset + O_LBMPDM_MSG_HDR_T_DEF_MAJOR_VER, L_LBMPDM_MSG_HDR_T_DEF_MAJOR_VER, encoding);\r\nmsgid.ver_major = tvb_get_guint8(tvb, offset + O_LBMPDM_MSG_HDR_T_DEF_MAJOR_VER);\r\nproto_tree_add_item(subtree, hf_lbmpdm_def_minor_ver, tvb, offset + O_LBMPDM_MSG_HDR_T_DEF_MINOR_VER, L_LBMPDM_MSG_HDR_T_DEF_MINOR_VER, encoding);\r\nmsgid.ver_minor = tvb_get_guint8(tvb, offset + O_LBMPDM_MSG_HDR_T_DEF_MINOR_VER);\r\nproto_tree_add_item(subtree, hf_lbmpdm_def_id, tvb, offset + O_LBMPDM_MSG_HDR_T_DEF_ID, L_LBMPDM_MSG_HDR_T_DEF_ID, encoding);\r\nmsgid.msg_def_id = lbmpdm_fetch_uint32_encoded(tvb, offset + O_LBMPDM_MSG_HDR_T_DEF_ID, encoding);\r\nproto_tree_add_item(subtree, hf_lbmpdm_len, tvb, offset + O_LBMPDM_MSG_HDR_T_LEN, L_LBMPDM_MSG_HDR_T_LEN, encoding);\r\nnext_hdr = tvb_get_guint8(tvb, offset + O_LBMPDM_MSG_HDR_T_NEXT_HDR);\r\nlen_remaining = msglen - L_LBMPDM_MSG_HDR_T;\r\nofs = offset + L_LBMPDM_MSG_HDR_T;\r\ndissected_len = L_LBMPDM_MSG_HDR_T;\r\ndatalen = msglen - L_LBMPDM_MSG_HDR_T;\r\nif (len_remaining > 0)\r\n{\r\nguint8 this_hdr = next_hdr;\r\nsegments_item = proto_tree_add_item(subtree, hf_lbmpdm_segments, tvb, ofs, datalen, encoding);\r\nsegments_tree = proto_item_add_subtree(segments_item, ett_lbmpdm_segments);\r\nwhile ((this_hdr != PDM_HDR_TYPE_EOM) && (len_remaining >= L_LBMPDM_SEG_HDR_T))\r\n{\r\nnext_hdr = tvb_get_guint8(tvb, ofs + O_LBMPDM_SEG_HDR_T_NEXT_HDR);\r\nswitch (this_hdr)\r\n{\r\ncase PDM_HDR_TYPE_DATA:\r\nsegment_len = dissect_segment_data(tvb, ofs, pinfo, segments_tree, &msgid, encoding);\r\nbreak;\r\ncase PDM_HDR_TYPE_OFSTTBLE:\r\nsegment_len = dissect_segment_ofstable(tvb, ofs, pinfo, segments_tree, &(msgid.offset_table), encoding);\r\nbreak;\r\ncase PDM_HDR_TYPE_DEFN:\r\nsegment_len = dissect_segment_defn(tvb, ofs, pinfo, segments_tree, channel, encoding);\r\nbreak;\r\ndefault:\r\nsegment_len = dissect_segment_unknown(tvb, ofs, pinfo, segments_tree, encoding);\r\nbreak;\r\n}\r\nthis_hdr = next_hdr;\r\ndissected_len += segment_len;\r\nlen_remaining -= segment_len;\r\nofs += segment_len;\r\n}\r\n}\r\nreturn (dissected_len);\r\n}\r\nint lbmpdm_get_minimum_length(void)\r\n{\r\nreturn (L_LBMPDM_MSG_HDR_T);\r\n}\r\nvoid proto_register_lbmpdm(void)\r\n{\r\nstatic hf_register_info hf[] =\r\n{\r\n{ &hf_lbmpdm_magic,\r\n{ "Magic", "lbmpdm.magic", FT_UINT32, BASE_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_encoding,\r\n{ "Encoding", "lbmpdm.encoding", FT_STRING, BASE_NONE, NULL, 0x0, "encoding as determined by magic number", HFILL } },\r\n{ &hf_lbmpdm_ver_type,\r\n{ "Version/Type", "lbmpdm.ver_type", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_ver_type_ver,\r\n{ "Version", "lbmpdm.ver_type.ver", FT_UINT8, BASE_DEC, NULL, PDM_HDR_VER_TYPE_VER_MASK, NULL, HFILL } },\r\n{ &hf_lbmpdm_ver_type_type,\r\n{ "Type", "lbmpdm.ver_type.type", FT_UINT8, BASE_DEC, NULL, PDM_HDR_VER_TYPE_TYPE_MASK, NULL, HFILL } },\r\n{ &hf_lbmpdm_next_hdr,\r\n{ "Next Header", "lbmpdm.next_hdr", FT_UINT8, BASE_DEC_HEX, VALS(lbmpdm_next_header), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_def_major_ver,\r\n{ "Definition Major Version", "lbmpdm.def_major_ver", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_def_minor_ver,\r\n{ "Definition Minor Version", "lbmpdm.def_minor_ver", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_def_id,\r\n{ "Definition ID", "lbmpdm.def_id", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_len,\r\n{ "Length", "lbmpdm.len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segments,\r\n{ "Segments", "lbmpdm.segments", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment,\r\n{ "Segment", "lbmpdm.segment", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_next_hdr,\r\n{ "Next Header", "lbmpdm.segment.next_hdr", FT_UINT8, BASE_DEC_HEX, VALS(lbmpdm_next_header), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_flags,\r\n{ "Flags", "lbmpdm.segment.flags", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_res,\r\n{ "Reserved", "lbmpdm.segment.res", FT_UINT16, BASE_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_len,\r\n{ "Length", "lbmpdm.segment.len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_id,\r\n{ "Definition ID", "lbmpdm.segment_def.id", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_num_fields,\r\n{ "Number Of Fields", "lbmpdm.segment_def.num_fields", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_names_type,\r\n{ "Field Names Type", "lbmpdm.segment_def.field_names_type", FT_UINT8, BASE_HEX, VALS(lbmpdm_field_name_type), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_finalized,\r\n{ "Finalized", "lbmpdm.segment_def.finalized", FT_UINT8, BASE_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_msg_vers_major,\r\n{ "Definition Major Version", "lbmpdm.segment_def.msg_vers_major", FT_UINT8, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_msg_vers_minor,\r\n{ "Definition Minor Version", "lbmpdm.segment_def.msg_vers_minor", FT_UINT8, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_fixed_req_section_len,\r\n{ "Fixed Required Section Length", "lbmpdm.segment_def.fixed_req_section_len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_info_len,\r\n{ "Field Information Length", "lbmpdm.segment_def.field_info_len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field,\r\n{ "Field Definition", "lbmpdm.segment_def.field", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_def_len,\r\n{ "Definition Length", "lbmpdm.segment_def.field.def_len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_id,\r\n{ "ID", "lbmpdm.segment_def.field.id", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_len,\r\n{ "Length", "lbmpdm.segment_def.field.len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_fixed_str_len,\r\n{ "Fixed String Length", "lbmpdm.segment_def.field.fixed_str_len", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_num_arr_elem,\r\n{ "Number Of Array Elements", "lbmpdm.segment_def.field.num_arr_elem", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_req,\r\n{ "Required", "lbmpdm.segment_def.field.req", FT_UINT8, BASE_HEX, VALS(lbmpdm_field_required), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_fixed,\r\n{ "Fixed Length Field", "lbmpdm.segment_def.field.fixed", FT_UINT8, BASE_HEX, VALS(lbmpdm_field_fixed_length), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_fld_int_name,\r\n{ "Field Integer Name", "lbmpdm.segment_def.field.fld_int_name", FT_INT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_str_name_len,\r\n{ "String Name Length", "lbmpdm.segment_def.field.str_name_len", FT_INT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_str_name,\r\n{ "String Name", "lbmpdm.segment_def.field.str_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_def_field_fld_type,\r\n{ "Field Type", "lbmpdm.segment_def.field.fld_type", FT_UINT16, BASE_DEC_HEX, VALS(lbmpdm_field_type), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_offset_entry,\r\n{ "Offset Entry", "lbmpdm.segment_ofs.entry", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_offset_entry_id,\r\n{ "ID", "lbmpdm.segment_ofs.entry.id", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_offset_entry_offset,\r\n{ "Offset", "lbmpdm.segment_ofs.entry.offset", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_segment_data,\r\n{ "Data", "lbmpdm.segment.data", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field,\r\n{ "Field", "lbmpdm.field", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_id,\r\n{ "ID", "lbmpdm.field.id", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_string_name,\r\n{ "String Name", "lbmpdm.field.string_name", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_int_name,\r\n{ "Integer Name", "lbmpdm.field.int_name", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_type,\r\n{ "Type", "lbmpdm.field.type", FT_UINT16, BASE_DEC_HEX, VALS(lbmpdm_field_type), 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_total_length,\r\n{ "Total Length", "lbmpdm.field.total_length", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_length,\r\n{ "Length", "lbmpdm.field.length", FT_UINT32, BASE_DEC_HEX, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_boolean,\r\n{ "Boolean Value", "lbmpdm.field.value_boolean", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_int8,\r\n{ "INT8 Value", "lbmpdm.field.value_int8", FT_INT8, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_uint8,\r\n{ "UINT8 Value", "lbmpdm.field.value_uint8", FT_UINT8, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_int16,\r\n{ "INT16 Value", "lbmpdm.field.value_int16", FT_INT16, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_uint16,\r\n{ "UINT16 Value", "lbmpdm.field.value_uint16", FT_UINT16, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_int32,\r\n{ "INT32 Value", "lbmpdm.field.value_int32", FT_INT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_uint32,\r\n{ "UINT32 Value", "lbmpdm.field.value_uint32", FT_UINT32, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_int64,\r\n{ "INT64 Value", "lbmpdm.field.value_int64", FT_INT64, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_uint64,\r\n{ "UINT64 Value", "lbmpdm.field.value_uint64", FT_UINT64, BASE_DEC, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_float,\r\n{ "FLOAT Value", "lbmpdm.field.value_float", FT_FLOAT, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_double,\r\n{ "DOUBLE Value", "lbmpdm.field.value_double", FT_DOUBLE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_decimal,\r\n{ "DECIMAL Value", "lbmpdm.field.value_decimal", FT_NONE, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_timestamp,\r\n{ "TIMESTAMP Value", "lbmpdm.field.value_timestamp", FT_ABSOLUTE_TIME, ABSOLUTE_TIME_LOCAL, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_fixed_string,\r\n{ "FIXED STRING Value", "lbmpdm.field.value_fixed_string", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_string,\r\n{ "STRING Value", "lbmpdm.field.value_string", FT_STRING, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_fixed_unicode,\r\n{ "FIXED UNICODE Value", "lbmpdm.field.value_fixed_unicode", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_unicode,\r\n{ "UNICODE Value", "lbmpdm.field.value_unicode", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_blob,\r\n{ "BLOB Value", "lbmpdm.field.value_blob", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } },\r\n{ &hf_lbmpdm_field_value_message,\r\n{ "MESSAGE Value", "lbmpdm.field.value_message", FT_BYTES, BASE_NONE, NULL, 0x0, NULL, HFILL } }\r\n};\r\nstatic gint * ett[] =\r\n{\r\n&ett_lbmpdm,\r\n&ett_lbmpdm_ver_type,\r\n&ett_lbmpdm_segments,\r\n&ett_lbmpdm_segment,\r\n&ett_lbmpdm_offset_entry,\r\n&ett_lbmpdm_segment_def_field,\r\n&ett_lbmpdm_field\r\n};\r\nproto_lbmpdm = proto_register_protocol("LBMPDM Protocol", "LBMPDM", "lbmpdm");\r\nproto_register_field_array(proto_lbmpdm, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nlbmpdm_definition_table = wmem_tree_new_autoreset(wmem_epan_scope(), wmem_file_scope());\r\n}

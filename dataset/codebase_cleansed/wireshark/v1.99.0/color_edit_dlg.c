static void\r\nfilter_expr_cb(GtkWidget *w _U_, gpointer filter_te)\r\n{\r\ndfilter_expr_dlg_new(GTK_WIDGET(filter_te));\r\n}\r\nstatic void\r\ncolorize_filter_new(GtkWidget *colorize_hbox,\r\ncolor_selection_type_t color_selection_type,\r\nconst gchar *t1,\r\nconst gchar *t2,\r\nconst gchar *t3,\r\ncolor_filter_t *colorf,\r\ncolor_t *color,\r\nGtkWidget *filt_name_entry)\r\n{\r\nGtkWidget *colorize_filter;\r\ncolor_selection_dlg_info_t *csdi;\r\ncolorize_filter = gtk_button_new_with_label(t2);\r\ngtk_box_pack_start (GTK_BOX (colorize_hbox), colorize_filter, TRUE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(colorize_filter, t3);\r\ncsdi = g_new(color_selection_dlg_info_t, 1);\r\ncsdi->color_selection_dlg = NULL;\r\ncsdi->color_selection_type = color_selection_type;\r\ncsdi->colorf = colorf;\r\ncsdi->color = color;\r\ncsdi->color_selection_type_text = t1;\r\ncsdi->filt_name_entry = filt_name_entry;\r\ng_signal_connect(colorize_filter, "clicked", G_CALLBACK(color_edit_dlg_fg_bg_btn_cb), csdi);\r\ng_signal_connect(colorize_filter, "destroy", G_CALLBACK(color_edit_dlg_fg_bg_btn_destroy_cb), csdi);\r\n}\r\nvoid\r\ncolor_edit_dlg_new(GtkWidget *color_filters,\r\ngboolean is_new_filter)\r\n{\r\ncolor_edit_dlg_info_t *cedi;\r\ncolor_filter_t *colorf;\r\nGtkWidget *color_edit_dlg;\r\nGtkWidget *dialog_vbox;\r\nGtkWidget *filter_fr;\r\nGtkWidget *filter_fr_vbox;\r\nGtkWidget *filter_name_hbox;\r\nGtkWidget *filt_name_entry;\r\nGtkWidget *filt_text_entry;\r\nGtkWidget *color_filter_name;\r\nGtkWidget *filter_string_hbox;\r\nGtkWidget *add_expression_bt;\r\nGtkWidget *color_filter_text;\r\nGtkWidget *settings_hbox;\r\nGtkWidget *colorize_fr;\r\nGtkWidget *colorize_hbox;\r\nGtkWidget *status_fr;\r\nGtkWidget *status_vbox;\r\nGtkWidget *disabled_cb;\r\nGtkWidget *bbox;\r\nGtkWidget *edit_color_filter_ok;\r\nGtkWidget *edit_color_filter_cancel;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, color_dlg_row_selected);\r\ngtk_tree_model_get(model, &iter, 5, &colorf, -1);\r\nif (colorf->color_edit_dlg_info != NULL) {\r\ncedi = (color_edit_dlg_info_t *)colorf->color_edit_dlg_info;\r\ng_assert(cedi->color_edit_dlg != NULL);\r\nreactivate_window(cedi->color_edit_dlg);\r\nreturn;\r\n}\r\ncolor_edit_dlg = dlg_conf_window_new ("Wireshark: Edit Color Filter");\r\ngtk_window_set_default_size(GTK_WINDOW(color_edit_dlg), 500, -1);\r\ndialog_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (dialog_vbox), 5);\r\ngtk_container_add (GTK_CONTAINER (color_edit_dlg), dialog_vbox);\r\nfilter_fr = gtk_frame_new("Filter");\r\ngtk_box_pack_start (GTK_BOX (dialog_vbox), filter_fr, FALSE, FALSE, 0);\r\nfilter_fr_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (filter_fr_vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(filter_fr), filter_fr_vbox);\r\nfilter_name_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start (GTK_BOX (filter_fr_vbox), filter_name_hbox, TRUE, FALSE, 3);\r\ncolor_filter_name = gtk_label_new (("Name: "));\r\ngtk_box_pack_start (GTK_BOX (filter_name_hbox), color_filter_name, FALSE, FALSE, 0);\r\nfilt_name_entry = gtk_entry_new ();\r\ngtk_entry_set_text(GTK_ENTRY(filt_name_entry), colorf->filter_name);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\n{\r\nGdkRGBA bg_rgba_color, fg_rgba_color;\r\ncolor_t_to_gdkRGBAcolor(&bg_rgba_color, &colorf->bg_color);\r\ncolor_t_to_gdkRGBAcolor(&fg_rgba_color, &colorf->fg_color);\r\ngtk_widget_override_background_color(filt_name_entry, GTK_STATE_FLAG_NORMAL, &bg_rgba_color);\r\ngtk_widget_override_color(filt_name_entry, GTK_STATE_FLAG_NORMAL, &fg_rgba_color);\r\n}\r\n#else\r\n{\r\nGdkColor bg_color, fg_color;\r\ncolor_t_to_gdkcolor(&bg_color, &colorf->bg_color);\r\ncolor_t_to_gdkcolor(&fg_color, &colorf->fg_color);\r\ngtk_widget_modify_base(filt_name_entry, GTK_STATE_NORMAL, &bg_color);\r\ngtk_widget_modify_text(filt_name_entry, GTK_STATE_NORMAL, &fg_color);\r\n}\r\n#endif\r\ngtk_box_pack_start (GTK_BOX (filter_name_hbox), filt_name_entry, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(filt_name_entry, "This is the editable name of the filter. (No @ characters allowed.)");\r\nfilter_string_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start (GTK_BOX (filter_fr_vbox), filter_string_hbox, TRUE, FALSE, 3);\r\ncolor_filter_text = gtk_label_new (("String: "));\r\ngtk_box_pack_start (GTK_BOX (filter_string_hbox), color_filter_text, FALSE, FALSE, 0);\r\nfilt_text_entry = gtk_entry_new ();\r\ng_signal_connect(filt_text_entry, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_string_hbox), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(filt_text_entry, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(color_edit_dlg, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ngtk_entry_set_text(GTK_ENTRY(filt_text_entry), colorf->filter_text);\r\ngtk_box_pack_start (GTK_BOX (filter_string_hbox), filt_text_entry, TRUE, TRUE, 0);\r\ngtk_widget_set_tooltip_text(filt_text_entry, "This is the editable text of the filter");\r\nadd_expression_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_ADD_EXPRESSION);\r\ng_signal_connect(add_expression_bt, "clicked", G_CALLBACK(filter_expr_cb), filt_text_entry);\r\ngtk_box_pack_start (GTK_BOX(filter_string_hbox), add_expression_bt, FALSE, FALSE, 3);\r\ngtk_widget_set_tooltip_text(add_expression_bt, "Add an expression to the filter string");\r\nfilter_te_syntax_check_cb(filt_text_entry, NULL);\r\nsettings_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_box_pack_start (GTK_BOX (dialog_vbox), settings_hbox, FALSE, FALSE, 0);\r\ncolorize_fr = gtk_frame_new("Display Colors");\r\ngtk_box_pack_start (GTK_BOX (settings_hbox), colorize_fr, TRUE, TRUE, 0);\r\ncolorize_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (colorize_hbox), 5);\r\ngtk_container_add(GTK_CONTAINER(colorize_fr), colorize_hbox);\r\ncolorize_filter_new(colorize_hbox,\r\nCOLOR_SELECTION_TYPE_FG,\r\n"Foreground", "Foreground Color...", "Select foreground color for data display",\r\ncolorf, &colorf->fg_color,\r\nfilt_name_entry);\r\ncolorize_filter_new(colorize_hbox,\r\nCOLOR_SELECTION_TYPE_BG,\r\n"Background", "Background Color...", "Select background color for data display",\r\ncolorf, &colorf->bg_color,\r\nfilt_name_entry);\r\nstatus_fr = gtk_frame_new("Status");\r\ngtk_box_pack_start (GTK_BOX (settings_hbox), status_fr, TRUE, TRUE, 0);\r\nstatus_vbox = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 0, FALSE);\r\ngtk_container_set_border_width (GTK_CONTAINER (status_vbox), 5);\r\ngtk_container_add(GTK_CONTAINER(status_fr), status_vbox);\r\ndisabled_cb = gtk_check_button_new_with_label("Disabled");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(disabled_cb), colorf->disabled);\r\ngtk_box_pack_start (GTK_BOX (status_vbox), disabled_cb, TRUE, FALSE, 0);\r\ngtk_widget_set_tooltip_text(disabled_cb, "Color rule won't be checked if this box is selected");\r\nbbox = dlg_button_row_new(GTK_STOCK_OK, GTK_STOCK_CANCEL, NULL);\r\ngtk_box_pack_start(GTK_BOX(dialog_vbox), bbox, FALSE, FALSE, 0);\r\ngtk_container_set_border_width (GTK_CONTAINER (bbox), 0);\r\nedit_color_filter_cancel = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ngtk_widget_set_tooltip_text(edit_color_filter_cancel, "Reject filter color change");\r\nwindow_set_cancel_button(color_edit_dlg, edit_color_filter_cancel, window_cancel_button_cb);\r\nedit_color_filter_ok = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ngtk_widget_set_tooltip_text(edit_color_filter_ok, "Accept filter color change");\r\ngtk_widget_grab_default(edit_color_filter_ok);\r\ncedi = g_new(color_edit_dlg_info_t, 1);\r\ncolorf->color_edit_dlg_info = cedi;\r\ncedi->color_filters = color_filters;\r\ncedi->colorf = colorf;\r\ncedi->color_edit_dlg = color_edit_dlg;\r\ncedi->filt_name_entry = filt_name_entry;\r\ncedi->filt_text_entry = filt_text_entry;\r\ncedi->disabled_cb = disabled_cb;\r\ng_signal_connect(color_edit_dlg, "destroy", G_CALLBACK(color_edit_dlg_destroy_cb), cedi);\r\ng_signal_connect(edit_color_filter_ok, "clicked", G_CALLBACK(color_edit_dlg_ok_cb), cedi);\r\nif (is_new_filter) {\r\ng_signal_connect(edit_color_filter_cancel, "clicked",\r\nG_CALLBACK(color_edit_dlg_cancel_cb), cedi);\r\n}\r\ng_signal_connect(color_edit_dlg, "delete_event", G_CALLBACK(window_delete_event_cb), NULL);\r\ngtk_widget_show_all(color_edit_dlg);\r\nwindow_present(color_edit_dlg);\r\n}\r\nstatic void\r\ncolor_edit_dlg_ok_cb(GtkWidget *w _U_, gpointer user_data)\r\n{\r\ncolor_edit_dlg_info_t *cedi = (color_edit_dlg_info_t *)user_data;\r\ngchar *filter_name;\r\ngchar *filter_text;\r\ngboolean filter_disabled;\r\ncolor_filter_t *colorf;\r\ndfilter_t *compiled_filter;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\ngchar fg_str[14], bg_str[14];\r\nfilter_name = g_strdup(gtk_entry_get_text(GTK_ENTRY(cedi->filt_name_entry)));\r\nfilter_text = g_strdup(gtk_entry_get_text(GTK_ENTRY(cedi->filt_text_entry)));\r\nfilter_disabled = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(cedi->disabled_cb));\r\nif (strchr(filter_name,'@') || strchr(filter_text,'@')) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Filter names and strings must not"\r\n" use the '@' character. Filter unchanged.");\r\ng_free(filter_name);\r\ng_free(filter_text);\r\nreturn;\r\n}\r\nif (!dfilter_compile(filter_text, &compiled_filter)) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"Filter \"%s\" didn't compile correctly.\n"\r\n" Please try again. Filter unchanged.\n%s\n", filter_name,\r\ndfilter_error_msg);\r\ng_free(filter_name);\r\ng_free(filter_text);\r\nreturn;\r\n}\r\ncolorf = cedi->colorf;\r\ng_free(colorf->filter_name);\r\ng_free(colorf->filter_text);\r\ncolorf->filter_name = filter_name;\r\ncolorf->filter_text = filter_text;\r\ncolorf->disabled = filter_disabled;\r\n#if GTK_CHECK_VERSION(3,0,0)\r\n{\r\nGtkStyleContext *context;\r\nGdkRGBA new_rgba_fg_color;\r\nGdkRGBA new_rgba_bg_color;\r\ncontext = gtk_widget_get_style_context (cedi->filt_name_entry);\r\ngtk_style_context_get_color(context, (GtkStateFlags)GTK_STATE_NORMAL, &new_rgba_fg_color);\r\ngtk_style_context_get_background_color(context, (GtkStateFlags)GTK_STATE_NORMAL, &new_rgba_bg_color);\r\ngdkRGBAcolor_to_color_t(&colorf->fg_color, &new_rgba_fg_color);\r\ngdkRGBAcolor_to_color_t(&colorf->bg_color, &new_rgba_bg_color);\r\n}\r\n#else\r\n{\r\nGtkStyle *style;\r\nGdkColor new_fg_color;\r\nGdkColor new_bg_color;\r\nstyle = gtk_widget_get_style(cedi->filt_name_entry);\r\nnew_bg_color = style->base[GTK_STATE_NORMAL];\r\nnew_fg_color = style->text[GTK_STATE_NORMAL];\r\ngdkcolor_to_color_t(&colorf->fg_color, &new_fg_color);\r\ngdkcolor_to_color_t(&colorf->bg_color, &new_bg_color);\r\n}\r\n#endif\r\ng_snprintf(fg_str, sizeof(fg_str), "#%04X%04X%04X",\r\ncolorf->fg_color.red, colorf->fg_color.green, colorf->fg_color.blue);\r\ng_snprintf(bg_str, sizeof(bg_str), "#%04X%04X%04X",\r\ncolorf->bg_color.red, colorf->bg_color.green, colorf->bg_color.blue);\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(cedi->color_filters));\r\ngtk_tree_model_iter_nth_child(model, &iter, NULL, color_dlg_row_selected);\r\ngtk_list_store_set(GTK_LIST_STORE(model), &iter, 0, filter_name,\r\n1, filter_text, 2, fg_str, 3, bg_str,\r\n4, filter_disabled, -1);\r\nif (colorf->c_colorfilter != NULL) {\r\ndfilter_free(colorf->c_colorfilter);\r\n}\r\ncolorf->c_colorfilter = compiled_filter;\r\nwindow_destroy(cedi->color_edit_dlg);\r\n}\r\nstatic void\r\ncolor_edit_dlg_cancel_cb(GtkWidget *w _U_, gpointer user_data)\r\n{\r\ncolor_edit_dlg_info_t *cedi = (color_edit_dlg_info_t *)user_data;\r\ncolor_delete_single(0, cedi->color_filters);\r\n}\r\nvoid\r\ncolor_edit_dlg_destroy(color_edit_dlg_info_t *cedi)\r\n{\r\nif (cedi == NULL) {\r\nreturn;\r\n}\r\ng_assert(cedi->color_edit_dlg != NULL);\r\nwindow_destroy(cedi->color_edit_dlg);\r\n}\r\nstatic void\r\ncolor_edit_dlg_destroy_cb(GObject *object _U_, gpointer user_data)\r\n{\r\ncolor_edit_dlg_info_t *cedi = (color_edit_dlg_info_t *)user_data;\r\ng_assert(cedi->color_edit_dlg);\r\ncedi->colorf->color_edit_dlg_info = NULL;\r\ng_free(cedi);\r\n}\r\nstatic void\r\ncolor_edit_dlg_fg_bg_btn_cb(GtkWidget *button, gpointer user_data)\r\n{\r\ncolor_selection_dlg_info_t *csdi = (color_selection_dlg_info_t *)user_data;\r\nGtkWidget *color_selection_dlg;\r\ngchar *title;\r\nif (csdi->color_selection_dlg != NULL) {\r\nreactivate_window(csdi->color_selection_dlg);\r\nreturn;\r\n}\r\ntitle = g_strdup_printf("Wireshark: Choose %s color for \"%s\"",\r\ncsdi->color_selection_type_text,\r\ncsdi->colorf->filter_name);\r\n#if GTK_CHECK_VERSION(3,4,0)\r\n{\r\nGdkRGBA rgba_color;\r\ncolor_selection_dlg = gtk_color_chooser_dialog_new(title, GTK_WINDOW(gtk_widget_get_toplevel(button)));\r\ncsdi->color_selection_dlg = color_selection_dlg;\r\ncolor_t_to_gdkRGBAcolor(&rgba_color, csdi->color);\r\ngtk_color_chooser_set_rgba(GTK_COLOR_CHOOSER(color_selection_dlg), &rgba_color);\r\n}\r\n#else\r\n{\r\nGdkColor gcolor;\r\nGtkWidget *color_selection;\r\nGtkWidget *color_selection_dlg_help_btn;\r\ncolor_selection_dlg = gtk_color_selection_dialog_new(title);\r\ngtk_container_set_border_width (GTK_CONTAINER (color_selection_dlg), 10);\r\ngtk_window_set_transient_for(GTK_WINDOW(color_selection_dlg), GTK_WINDOW(gtk_widget_get_toplevel(button)));\r\ngtk_window_set_destroy_with_parent(GTK_WINDOW(color_selection_dlg), TRUE);\r\ng_object_get(color_selection_dlg, "help-button", &color_selection_dlg_help_btn, NULL);\r\ngtk_widget_destroy(color_selection_dlg_help_btn);\r\ncolor_selection =\r\ngtk_color_selection_dialog_get_color_selection(GTK_COLOR_SELECTION_DIALOG(color_selection_dlg));\r\ncolor_t_to_gdkcolor(&gcolor, csdi->color);\r\ngtk_color_selection_set_current_color(GTK_COLOR_SELECTION(color_selection), &gcolor);\r\ncsdi->color_selection_dlg = color_selection_dlg;\r\n}\r\n#endif\r\ng_free(title);\r\ng_signal_connect(G_OBJECT(color_selection_dlg), "response", G_CALLBACK(color_selection_dlg_response_cb), csdi);\r\ng_signal_connect(G_OBJECT(color_selection_dlg), "destroy", G_CALLBACK(color_selection_dlg_destroy_cb), csdi);\r\ngtk_widget_show_all(color_selection_dlg);\r\n}\r\nstatic void\r\ncolor_edit_dlg_fg_bg_btn_destroy_cb(GObject *object _U_, gpointer user_data)\r\n{\r\ncolor_selection_dlg_info_t *csdi = (color_selection_dlg_info_t *)user_data;\r\ng_free(csdi);\r\n}\r\nstatic void\r\ncolor_selection_dlg_response_cb(GtkWidget *color_selection_dlg, gint response, gpointer user_data)\r\n{\r\ncolor_selection_dlg_info_t *csdi = (color_selection_dlg_info_t *)user_data;\r\nif (response != GTK_RESPONSE_OK) {\r\nwindow_destroy(color_selection_dlg);\r\nreturn;\r\n}\r\n#if GTK_CHECK_VERSION(3,4,0)\r\n{\r\nGdkRGBA new_rgba_color;\r\ngtk_color_chooser_get_rgba(GTK_COLOR_CHOOSER(color_selection_dlg), &new_rgba_color);\r\nif (csdi->color_selection_type == COLOR_SELECTION_TYPE_FG)\r\ngtk_widget_override_color(csdi->filt_name_entry, GTK_STATE_FLAG_NORMAL, &new_rgba_color);\r\nelse\r\ngtk_widget_override_background_color(csdi->filt_name_entry, GTK_STATE_FLAG_NORMAL, &new_rgba_color);\r\n}\r\n#elif GTK_CHECK_VERSION(3,0,0)\r\n{\r\nGtkWidget *color_selection;\r\nGdkRGBA new_rgba_color;\r\ncolor_selection =\r\ngtk_color_selection_dialog_get_color_selection(GTK_COLOR_SELECTION_DIALOG(color_selection_dlg));\r\ngtk_color_selection_get_current_rgba(GTK_COLOR_SELECTION(color_selection), &new_rgba_color);\r\nif (csdi->color_selection_type == COLOR_SELECTION_TYPE_FG)\r\ngtk_widget_override_color(csdi->filt_name_entry, GTK_STATE_FLAG_NORMAL, &new_rgba_color);\r\nelse\r\ngtk_widget_override_background_color(csdi->filt_name_entry, GTK_STATE_FLAG_NORMAL, &new_rgba_color);\r\n}\r\n#else\r\n{\r\nGtkWidget *color_selection;\r\nGdkColor new_color;\r\ncolor_selection =\r\ngtk_color_selection_dialog_get_color_selection(GTK_COLOR_SELECTION_DIALOG(color_selection_dlg));\r\ngtk_color_selection_get_current_color(GTK_COLOR_SELECTION(color_selection), &new_color);\r\nif (csdi->color_selection_type == COLOR_SELECTION_TYPE_FG)\r\ngtk_widget_modify_text(csdi->filt_name_entry, GTK_STATE_NORMAL, &new_color);\r\nelse\r\ngtk_widget_modify_base(csdi->filt_name_entry, GTK_STATE_NORMAL, &new_color);\r\n}\r\n#endif\r\nwindow_destroy(color_selection_dlg);\r\n}\r\nstatic void\r\ncolor_selection_dlg_destroy_cb(GObject *object _U_, gpointer user_data)\r\n{\r\ncolor_selection_dlg_info_t *csdi = (color_selection_dlg_info_t *)user_data;\r\ng_assert(csdi->color_selection_dlg);\r\ncsdi->color_selection_dlg = NULL;\r\n}

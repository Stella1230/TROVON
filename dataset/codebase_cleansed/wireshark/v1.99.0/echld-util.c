static long timevaldiff(struct timeval *starttime, struct timeval *finishtime) {\r\nlong msec;\r\nmsec=(finishtime->tv_sec-starttime->tv_sec)*1000;\r\nmsec+=(finishtime->tv_usec-starttime->tv_usec)/1000;\r\nreturn msec;\r\n}\r\nstatic gboolean pong(echld_msg_type_t type, GByteArray* ba _U_, void* data) {\r\nstruct _ping* p = (struct _ping*)data;\r\nstruct timeval t;\r\nlong ret = -1;\r\ngettimeofday(&t,NULL);\r\nswitch (type) {\r\ncase ECHLD_PONG:\r\nret = timevaldiff(&(p->tv),&t);\r\nbreak;\r\ndefault:\r\nret = -1;\r\nbreak;\r\n}\r\nif (p->cb) p->cb(ret, p->cb_data);\r\ng_free(p);\r\nreturn TRUE;\r\n}\r\nextern echld_state_t echld_ping(int chld_id, echld_ping_cb_t pcb, void* cb_data) {\r\nstruct _ping* p = g_new0(struct _ping,1);\r\np->cb = pcb;\r\np->cb_data = cb_data;\r\ngettimeofday(&(p->tv),NULL);\r\nreturn echld_reqh(chld_id, ECHLD_PING, 0, NULL, pong, p);\r\n}\r\nstatic gboolean got_param(echld_msg_type_t type, GByteArray* ba _U_, void* data) {\r\nstruct _get_param* g = (struct _get_param*)data;\r\nchar* err_msg;\r\nswitch (type) {\r\ncase ECHLD_PARAM:\r\nif (g->cb) {\r\nchar* param;\r\nchar* value;\r\ng->dec(ba,&param,&value);\r\ng->cb(param,value,NULL,g->cb_data);\r\n}\r\nbreak;\r\ncase ECHLD_ERROR: {\r\nint errnum;\r\ng->dec_err(ba,&errnum,&err_msg);\r\ng->cb(NULL,NULL,err_msg,g->cb_data);\r\nbreak;\r\n}\r\ndefault:\r\nerr_msg = g_strdup_printf("other type='%s'",TY(type));\r\ng->cb(NULL,NULL,err_msg,g->cb_data);\r\ng_free(err_msg);\r\nbreak;\r\n}\r\ng_free(g);\r\nreturn TRUE;\r\n}\r\nextern echld_state_t echld_get_param(int chld_id, const char* param, echld_param_cb_t acb, void* cb_data) {\r\nstruct _get_param* g = g_new0(struct _get_param,1);\r\nechld_parent_encoder_t* enc;\r\nparent_decoder_t* dec;\r\nenc_msg_t* em;\r\nechld_get_all_codecs(NULL, NULL, &enc, &dec);\r\nem = enc->get_param(param);\r\ng->name = param;\r\ng->cb = acb;\r\ng->cb_data = cb_data;\r\ng->dec = dec->param;\r\ng->dec_err = dec->error;\r\nreturn echld_reqh(chld_id, ECHLD_GET_PARAM, 0, em, got_param, g);\r\n}\r\nextern echld_state_t echld_set_param(int chld_id, const char* param, const char* value, echld_param_cb_t acb, void* cb_data) {\r\nstruct _get_param* g = g_new0(struct _get_param,1);\r\nechld_parent_encoder_t* enc;\r\nparent_decoder_t* dec;\r\nenc_msg_t* em;\r\nechld_get_all_codecs(NULL, NULL, &enc, &dec);\r\nem = enc->set_param(param,value);\r\ng->name = param;\r\ng->cb = acb;\r\ng->cb_data = cb_data;\r\ng->dec = dec->param;\r\ng->dec_err = dec->error;\r\nreturn echld_reqh(chld_id, ECHLD_SET_PARAM, 0, em, got_param, g);\r\n}\r\nstatic gboolean closed(echld_msg_type_t type, GByteArray* ba, void* data) {\r\nclose_t* c = (close_t*)data;\r\nparent_decoder_t* dec;\r\nchar* err_msg;\r\nechld_get_all_codecs(NULL, NULL, NULL, &dec);\r\nswitch (type) {\r\ncase ECHLD_CLOSING: {\r\nif (c->cb) {\r\nc->cb(NULL,c->cb_data);\r\n}\r\nbreak;\r\n}\r\ncase ECHLD_ERROR: {\r\nint errnum;\r\nif ( dec->error(ba, &errnum ,&err_msg) ) {\r\nc->cb(err_msg,c->cb_data);\r\ng_free(err_msg);\r\n} else {\r\nc->cb("Canot decode error message",c->cb_data);\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nerr_msg = g_strdup_printf("other type='%s'",TY(type));\r\nc->cb(err_msg,c->cb_data);\r\ng_free(err_msg);\r\nbreak;\r\n}\r\ng_free(c);\r\nreturn TRUE;\r\n}\r\nechld_state_t echld_close(int child_id, echld_close_cb_t pcb, void* cb_data) {\r\nclose_t* c = g_new0(close_t,1);\r\nc->cb = pcb;\r\nc->cb_data = cb_data;\r\nreturn echld_reqh(child_id,ECHLD_CLOSE_CHILD, 0, NULL, closed, c);\r\n}

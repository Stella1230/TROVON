static void\r\nwin_destroy_cb(GtkWindow *win _U_, gpointer data _U_)\r\n{\r\nif (dissector_tables_dlg_w != NULL) {\r\nwindow_destroy(dissector_tables_dlg_w);\r\ndissector_tables_dlg_w = NULL;\r\n}\r\n}\r\nstatic gint\r\nui_sort_func(GtkTreeModel *model,\r\nGtkTreeIter *a,\r\nGtkTreeIter *b,\r\ngpointer user_data)\r\n{\r\ngchar *stra, *strb;\r\ngint data_column = GPOINTER_TO_INT(user_data);\r\ngtk_tree_model_get(model, a, data_column, &stra, -1);\r\ngtk_tree_model_get(model, b, data_column, &strb, -1);\r\nreturn strcmp(stra, strb);\r\n}\r\nstatic void\r\nproto_add_to_list(dissector_tables_tree_info_t *tree_info,\r\nGtkTreeStore *store,\r\ngchar *str,\r\nconst gchar *proto_name)\r\n{\r\ngtk_tree_store_insert_with_values(store, &tree_info->new_iter, &tree_info->iter, G_MAXINT,\r\nTABLE_UI_NAME_COL, str,\r\nTABLE_SHORT_NAME_COL, proto_name,\r\n-1);\r\n}\r\nstatic void\r\ndecode_proto_add_to_list (const gchar *table_name _U_, ftenum_t selector_type,\r\ngpointer key, gpointer value _U_, gpointer user_data)\r\n{\r\nGtkTreeStore *store;\r\nconst gchar *proto_name;\r\ndtbl_entry_t *dtbl_entry;\r\ndissector_handle_t handle;\r\nguint32 port;\r\ngchar *str;\r\ndissector_tables_tree_info_t *tree_info;\r\ntree_info = (dissector_tables_tree_info_t *)user_data;\r\ndtbl_entry = (dtbl_entry_t*)value;\r\nhandle = dtbl_entry_get_handle(dtbl_entry);\r\nproto_name = dissector_handle_get_short_name(handle);\r\nstore = GTK_TREE_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(tree_info->tree)));\r\nswitch (selector_type) {\r\ncase FT_UINT8:\r\ncase FT_UINT16:\r\ncase FT_UINT24:\r\ncase FT_UINT32:\r\nport = GPOINTER_TO_UINT(key);\r\nstr = g_strdup_printf ("%10d", port);\r\nproto_add_to_list(tree_info, store, str, proto_name);\r\ng_free (str);\r\nbreak;\r\ncase FT_STRING:\r\ncase FT_STRINGZ:\r\ncase FT_UINT_STRING:\r\ncase FT_STRINGZPAD:\r\nstr = (gchar*) key;\r\nproto_add_to_list(tree_info, store, str, proto_name);\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\n}\r\nstatic void\r\ntable_name_add_to_list(dissector_tables_tree_info_t *tree_info,\r\nGtkWidget *tree_view,\r\nconst char *table_name,\r\nconst char *ui_name)\r\n{\r\nGtkTreeStore *store;\r\ntree_info->tree = tree_view;\r\nstore = GTK_TREE_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(tree_view)));\r\ngtk_tree_store_insert_with_values(store, &tree_info->iter, NULL, G_MAXINT,\r\nTABLE_UI_NAME_COL, ui_name,\r\nTABLE_SHORT_NAME_COL, table_name,\r\n-1);\r\n}\r\nstatic void\r\ndisplay_heur_dissector_table_entries(gpointer data, gpointer user_data)\r\n{\r\nheur_dtbl_entry_t *dtbl_entry = (heur_dtbl_entry_t *)data;\r\ndissector_tables_tree_info_t *tree_info = (dissector_tables_tree_info_t*)user_data;\r\nGtkTreeStore *store;\r\nif (dtbl_entry->protocol) {\r\nstore = GTK_TREE_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(tree_info->tree)));\r\nproto_add_to_list(tree_info, store,\r\n(gchar *)proto_get_protocol_long_name(dtbl_entry->protocol),\r\nproto_get_protocol_short_name(dtbl_entry->protocol));\r\n}else{\r\ng_warning("no protocol info");\r\n}\r\n}\r\nstatic void\r\ndisplay_heur_dissector_table_names(const char *table_name, gpointer table, gpointer w)\r\n{\r\ndissector_tables_trees_t *dis_tbl_trees;\r\ndissector_tables_tree_info_t *tree_info;\r\nheur_dissector_list_t *list;\r\ntree_info = g_new(dissector_tables_tree_info_t, 1);\r\ndis_tbl_trees = (dissector_tables_trees_t*)w;\r\nlist = (heur_dissector_list_t *)table;\r\ntable_name_add_to_list(tree_info, dis_tbl_trees->heuristic_tree_wgt, "", table_name);\r\nif (table) {\r\ng_slist_foreach (*list, display_heur_dissector_table_entries, tree_info);\r\n}\r\n}\r\nstatic void\r\ndisplay_dissector_table_names(const char *table_name, const char *ui_name, gpointer w)\r\n{\r\ndissector_tables_trees_t *dis_tbl_trees;\r\ndissector_tables_tree_info_t *tree_info;\r\nftenum_t selector_type = get_dissector_table_selector_type(table_name);\r\ntree_info = g_new(dissector_tables_tree_info_t, 1);\r\ndis_tbl_trees = (dissector_tables_trees_t*)w;\r\nswitch (selector_type) {\r\ncase FT_UINT8:\r\ncase FT_UINT16:\r\ncase FT_UINT24:\r\ncase FT_UINT32:\r\ntable_name_add_to_list(tree_info, dis_tbl_trees->uint_tree_wgt, table_name, ui_name);\r\nbreak;\r\ncase FT_STRING:\r\ncase FT_STRINGZ:\r\ncase FT_UINT_STRING:\r\ncase FT_STRINGZPAD:\r\ntable_name_add_to_list(tree_info, dis_tbl_trees->str_tree_wgt, table_name, ui_name);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ndissector_table_foreach(table_name, decode_proto_add_to_list, tree_info);\r\ng_free(tree_info);\r\n}\r\nstatic GtkWidget *\r\ninit_table(void)\r\n{\r\nGtkTreeStore *store;\r\nGtkWidget *tree;\r\nGtkTreeView *tree_view;\r\nGtkTreeViewColumn *column;\r\nGtkCellRenderer *renderer;\r\nGtkTreeSortable *sortable;\r\nstore = gtk_tree_store_new (N_COLUMNS,\r\nG_TYPE_STRING,\r\nG_TYPE_STRING);\r\ntree = gtk_tree_view_new_with_model (GTK_TREE_MODEL (store));\r\ntree_view = GTK_TREE_VIEW(tree);\r\nsortable = GTK_TREE_SORTABLE(store);\r\ngtk_tree_view_set_fixed_height_mode(tree_view, TRUE);\r\ngtk_tree_view_set_headers_clickable(GTK_TREE_VIEW (tree), FALSE);\r\ng_object_unref (G_OBJECT (store));\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("UI name", renderer, "text", TABLE_UI_NAME_COL, NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, TABLE_UI_NAME_COL,\r\nui_sort_func, GINT_TO_POINTER(TABLE_UI_NAME_COL), NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, TABLE_UI_NAME_COL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 80);\r\ngtk_tree_view_column_set_fixed_width(column, 330);\r\ngtk_tree_view_append_column (GTK_TREE_VIEW (tree_view), column);\r\nrenderer = gtk_cell_renderer_text_new ();\r\ncolumn = gtk_tree_view_column_new_with_attributes ("Short name", renderer, "text", TABLE_SHORT_NAME_COL, NULL);\r\ngtk_tree_sortable_set_sort_func(sortable, TABLE_SHORT_NAME_COL,\r\nui_sort_func, GINT_TO_POINTER(TABLE_SHORT_NAME_COL), NULL);\r\ngtk_tree_view_column_set_sort_column_id(column, TABLE_SHORT_NAME_COL);\r\ngtk_tree_view_column_set_resizable(column, TRUE);\r\ngtk_tree_view_column_set_sizing(column, GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_min_width(column, 80);\r\ngtk_tree_view_column_set_fixed_width(column, 100);\r\ngtk_tree_view_append_column (GTK_TREE_VIEW (tree_view), column);\r\nreturn tree;\r\n}\r\nstatic void\r\ndissector_tables_dlg_init(void)\r\n{\r\ndissector_tables_trees_t dis_tbl_trees;\r\nGtkWidget *vbox;\r\nGtkWidget *hbox;\r\nGtkWidget *main_nb;\r\nGtkWidget *scrolled_window;\r\nGtkTreeSortable *sortable;\r\nGtkWidget *temp_page, *tmp;\r\ndissector_tables_dlg_w = dlg_window_new("Dissector tables");\r\ngtk_window_set_destroy_with_parent (GTK_WINDOW(dissector_tables_dlg_w), TRUE);\r\ngtk_window_set_default_size(GTK_WINDOW(dissector_tables_dlg_w), 700, 300);\r\nvbox=ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_add(GTK_CONTAINER(dissector_tables_dlg_w), vbox);\r\ngtk_container_set_border_width(GTK_CONTAINER(vbox), 12);\r\nmain_nb = gtk_notebook_new();\r\ngtk_box_pack_start(GTK_BOX(vbox), main_nb, TRUE, TRUE, 0);\r\ntemp_page = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 6, FALSE);\r\ntmp = gtk_label_new("String tables");\r\ngtk_widget_show(tmp);\r\nhbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (hbox), tmp, TRUE, TRUE, 0);\r\ngtk_notebook_append_page(GTK_NOTEBOOK(main_nb), temp_page, hbox);\r\nscrolled_window = scrolled_window_new(NULL, NULL);\r\ndis_tbl_trees.str_tree_wgt = init_table();\r\ngtk_widget_show(dis_tbl_trees.str_tree_wgt);\r\ngtk_container_add(GTK_CONTAINER(scrolled_window), dis_tbl_trees.str_tree_wgt);\r\ngtk_box_pack_start(GTK_BOX(temp_page), scrolled_window, TRUE, TRUE, 0);\r\ngtk_widget_show(scrolled_window);\r\ntemp_page = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 6, FALSE);\r\ntmp = gtk_label_new("Integer tables");\r\ngtk_widget_show(tmp);\r\nhbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX (hbox), tmp, TRUE, TRUE, 0);\r\ngtk_notebook_append_page(GTK_NOTEBOOK(main_nb), temp_page, hbox);\r\nscrolled_window = scrolled_window_new(NULL, NULL);\r\ndis_tbl_trees.uint_tree_wgt = init_table();\r\ngtk_widget_show(dis_tbl_trees.uint_tree_wgt);\r\ngtk_container_add(GTK_CONTAINER(scrolled_window), dis_tbl_trees.uint_tree_wgt);\r\ngtk_box_pack_start(GTK_BOX(temp_page), scrolled_window, TRUE, TRUE, 0);\r\ngtk_widget_show(scrolled_window);\r\ntemp_page = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 6, FALSE);\r\ntmp = gtk_label_new("Heuristic tables");\r\ngtk_widget_show(tmp);\r\nhbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX(hbox), tmp, TRUE, TRUE, 0);\r\ngtk_notebook_append_page(GTK_NOTEBOOK(main_nb), temp_page, hbox);\r\nscrolled_window = scrolled_window_new(NULL, NULL);\r\ndis_tbl_trees.heuristic_tree_wgt = init_table();\r\ngtk_widget_show(dis_tbl_trees.heuristic_tree_wgt);\r\ngtk_container_add(GTK_CONTAINER(scrolled_window), dis_tbl_trees.heuristic_tree_wgt);\r\ngtk_box_pack_start(GTK_BOX(temp_page), scrolled_window, TRUE, TRUE, 0);\r\ngtk_widget_show(scrolled_window);\r\ngtk_widget_show_all(dissector_tables_dlg_w);\r\ng_signal_connect(dissector_tables_dlg_w, "destroy", G_CALLBACK(win_destroy_cb), NULL);\r\ndissector_all_tables_foreach_table(display_dissector_table_names, (gpointer)&dis_tbl_trees, NULL);\r\ndissector_all_heur_tables_foreach_table(display_heur_dissector_table_names, (gpointer)&dis_tbl_trees);\r\nsortable = GTK_TREE_SORTABLE(gtk_tree_view_get_model(GTK_TREE_VIEW(dis_tbl_trees.str_tree_wgt)));\r\ngtk_tree_sortable_set_sort_column_id(sortable, TABLE_UI_NAME_COL, GTK_SORT_ASCENDING);\r\nsortable = GTK_TREE_SORTABLE(gtk_tree_view_get_model(GTK_TREE_VIEW(dis_tbl_trees.uint_tree_wgt)));\r\ngtk_tree_sortable_set_sort_column_id(sortable, TABLE_UI_NAME_COL, GTK_SORT_ASCENDING);\r\nsortable = GTK_TREE_SORTABLE(gtk_tree_view_get_model(GTK_TREE_VIEW(dis_tbl_trees.heuristic_tree_wgt)));\r\ngtk_tree_sortable_set_sort_column_id(sortable, TABLE_UI_NAME_COL, GTK_SORT_ASCENDING);\r\n}\r\nvoid\r\ndissector_tables_dlg_cb(GtkWidget *w _U_, gpointer d _U_)\r\n{\r\nif (dissector_tables_dlg_w) {\r\nreactivate_window(dissector_tables_dlg_w);\r\n} else {\r\ndissector_tables_dlg_init();\r\n}\r\n}

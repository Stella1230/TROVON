static guint\r\nsubset_offset(const tvbuff_t *tvb, const guint counter)\r\n{\r\nconst struct tvb_subset *subset_tvb = (const struct tvb_subset *) tvb;\r\nconst tvbuff_t *member = subset_tvb->subset.tvb;\r\nreturn tvb_offset_from_real_beginning_counter(member, counter + subset_tvb->subset.offset);\r\n}\r\nstatic void *\r\nsubset_memcpy(tvbuff_t *tvb, void *target, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_subset *subset_tvb = (struct tvb_subset *) tvb;\r\nreturn tvb_memcpy(subset_tvb->subset.tvb, target, subset_tvb->subset.offset + abs_offset, abs_length);\r\n}\r\nstatic const guint8 *\r\nsubset_get_ptr(tvbuff_t *tvb, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_subset *subset_tvb = (struct tvb_subset *) tvb;\r\nreturn tvb_get_ptr(subset_tvb->subset.tvb, subset_tvb->subset.offset + abs_offset, abs_length);\r\n}\r\nstatic gint\r\nsubset_find_guint8(tvbuff_t *tvb, guint abs_offset, guint limit, guint8 needle)\r\n{\r\nstruct tvb_subset *subset_tvb = (struct tvb_subset *) tvb;\r\nreturn tvb_find_guint8(subset_tvb->subset.tvb, subset_tvb->subset.offset + abs_offset, limit, needle);\r\n}\r\nstatic gint\r\nsubset_pbrk_guint8(tvbuff_t *tvb, guint abs_offset, guint limit, const guint8 *needles, guchar *found_needle)\r\n{\r\nstruct tvb_subset *subset_tvb = (struct tvb_subset *) tvb;\r\nreturn tvb_pbrk_guint8(subset_tvb->subset.tvb, subset_tvb->subset.offset + abs_offset, limit, needles, found_needle);\r\n}\r\nstatic tvbuff_t *\r\nsubset_clone(tvbuff_t *tvb, guint abs_offset, guint abs_length)\r\n{\r\nstruct tvb_subset *subset_tvb = (struct tvb_subset *) tvb;\r\nreturn tvb_clone_offset_len(subset_tvb->subset.tvb, subset_tvb->subset.offset + abs_offset, abs_length);\r\n}\r\nstatic tvbuff_t *\r\ntvb_new_with_subset(tvbuff_t *backing, const gint reported_length,\r\nconst guint subset_tvb_offset, const guint subset_tvb_length)\r\n{\r\ntvbuff_t *tvb = tvb_new(&tvb_subset_ops);\r\nstruct tvb_subset *subset_tvb = (struct tvb_subset *) tvb;\r\nsubset_tvb->subset.offset = subset_tvb_offset;\r\nsubset_tvb->subset.length = subset_tvb_length;\r\nsubset_tvb->subset.tvb = backing;\r\ntvb->length = subset_tvb_length;\r\ntvb->flags = backing->flags;\r\nif (reported_length == -1) {\r\ntvb->reported_length = backing->reported_length - subset_tvb_offset;\r\n}\r\nelse {\r\ntvb->reported_length = reported_length;\r\n}\r\ntvb->initialized = TRUE;\r\nif (backing->real_data != NULL) {\r\ntvb->real_data = backing->real_data + subset_tvb_offset;\r\n}\r\ntvb->ds_tvb = backing->ds_tvb;\r\nreturn tvb;\r\n}\r\ntvbuff_t *\r\ntvb_new_subset(tvbuff_t *backing, const gint backing_offset, const gint backing_length, const gint reported_length)\r\n{\r\ntvbuff_t *tvb;\r\nguint subset_tvb_offset;\r\nguint subset_tvb_length;\r\nDISSECTOR_ASSERT(backing && backing->initialized);\r\nTHROW_ON(reported_length < -1, ReportedBoundsError);\r\ntvb_check_offset_length(backing, backing_offset, backing_length,\r\n&subset_tvb_offset,\r\n&subset_tvb_length);\r\ntvb = tvb_new_with_subset(backing, reported_length,\r\nsubset_tvb_offset, subset_tvb_length);\r\ntvb_add_to_chain(backing, tvb);\r\nreturn tvb;\r\n}\r\ntvbuff_t *\r\ntvb_new_subset_length(tvbuff_t *backing, const gint backing_offset, const gint backing_length)\r\n{\r\ngint captured_length;\r\ntvbuff_t *tvb;\r\nguint subset_tvb_offset;\r\nguint subset_tvb_length;\r\nDISSECTOR_ASSERT(backing && backing->initialized);\r\nTHROW_ON(backing_length < 0, ReportedBoundsError);\r\ncaptured_length = tvb_length_remaining(backing, backing_offset);\r\nTHROW_ON(captured_length < 0, BoundsError);\r\nif (captured_length > backing_length)\r\ncaptured_length = backing_length;\r\ntvb_check_offset_length(backing, backing_offset, captured_length,\r\n&subset_tvb_offset,\r\n&subset_tvb_length);\r\ntvb = tvb_new_with_subset(backing, backing_length,\r\nsubset_tvb_offset, subset_tvb_length);\r\ntvb_add_to_chain(backing, tvb);\r\nreturn tvb;\r\n}\r\ntvbuff_t *\r\ntvb_new_subset_remaining(tvbuff_t *backing, const gint backing_offset)\r\n{\r\ntvbuff_t *tvb;\r\nguint subset_tvb_offset;\r\nguint subset_tvb_length;\r\ntvb_check_offset_length(backing, backing_offset, -1 ,\r\n&subset_tvb_offset,\r\n&subset_tvb_length);\r\ntvb = tvb_new_with_subset(backing, -1 ,\r\nsubset_tvb_offset, subset_tvb_length);\r\ntvb_add_to_chain(backing, tvb);\r\nreturn tvb;\r\n}\r\ntvbuff_t *\r\ntvb_new_proxy(tvbuff_t *backing)\r\n{\r\ntvbuff_t *tvb;\r\nif (backing)\r\ntvb = tvb_new_with_subset(backing, backing->reported_length, 0, backing->length);\r\nelse\r\ntvb = tvb_new_real_data(NULL, 0, 0);\r\ntvb->ds_tvb = tvb;\r\nreturn tvb;\r\n}

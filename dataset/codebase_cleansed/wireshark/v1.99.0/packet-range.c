static void packet_range_calc(packet_range_t *range) {\r\nguint32 framenum;\r\nguint32 mark_low;\r\nguint32 mark_high;\r\nguint32 displayed_mark_low;\r\nguint32 displayed_mark_high;\r\nframe_data *packet;\r\nrange->selected_packet = 0;\r\nmark_low = 0;\r\nmark_high = 0;\r\nrange->mark_range_cnt = 0;\r\nrange->ignored_cnt = 0;\r\nrange->ignored_marked_cnt = 0;\r\nrange->ignored_mark_range_cnt = 0;\r\nrange->ignored_user_range_cnt = 0;\r\ndisplayed_mark_low = 0;\r\ndisplayed_mark_high = 0;\r\nrange->displayed_cnt = 0;\r\nrange->displayed_marked_cnt = 0;\r\nrange->displayed_mark_range_cnt = 0;\r\nrange->displayed_plus_dependents_cnt = 0;\r\nrange->displayed_ignored_cnt = 0;\r\nrange->displayed_ignored_marked_cnt = 0;\r\nrange->displayed_ignored_mark_range_cnt = 0;\r\nrange->displayed_ignored_user_range_cnt = 0;\r\ng_assert(range->cf != NULL);\r\nif (range->cf->frames != NULL) {\r\nfor(framenum = 1; framenum <= range->cf->count; framenum++) {\r\npacket = frame_data_sequence_find(range->cf->frames, framenum);\r\nif (range->cf->current_frame == packet) {\r\nrange->selected_packet = framenum;\r\n}\r\nif (packet->flags.passed_dfilter) {\r\nrange->displayed_cnt++;\r\n}\r\nif (packet->flags.passed_dfilter ||\r\npacket->flags.dependent_of_displayed) {\r\nrange->displayed_plus_dependents_cnt++;\r\n}\r\nif (packet->flags.marked) {\r\nif (packet->flags.ignored) {\r\nrange->ignored_marked_cnt++;\r\n}\r\nif (packet->flags.passed_dfilter) {\r\nrange->displayed_marked_cnt++;\r\nif (packet->flags.ignored) {\r\nrange->displayed_ignored_marked_cnt++;\r\n}\r\nif (displayed_mark_low == 0) {\r\ndisplayed_mark_low = framenum;\r\n}\r\nif (framenum > displayed_mark_high) {\r\ndisplayed_mark_high = framenum;\r\n}\r\n}\r\nif (mark_low == 0) {\r\nmark_low = framenum;\r\n}\r\nif (framenum > mark_high) {\r\nmark_high = framenum;\r\n}\r\n}\r\nif (packet->flags.ignored) {\r\nrange->ignored_cnt++;\r\nif (packet->flags.passed_dfilter) {\r\nrange->displayed_ignored_cnt++;\r\n}\r\n}\r\n}\r\nfor(framenum = 1; framenum <= range->cf->count; framenum++) {\r\npacket = frame_data_sequence_find(range->cf->frames, framenum);\r\nif (framenum >= mark_low &&\r\nframenum <= mark_high)\r\n{\r\nrange->mark_range_cnt++;\r\nif (packet->flags.ignored) {\r\nrange->ignored_mark_range_cnt++;\r\n}\r\n}\r\nif (framenum >= displayed_mark_low &&\r\nframenum <= displayed_mark_high)\r\n{\r\nif (packet->flags.passed_dfilter) {\r\nrange->displayed_mark_range_cnt++;\r\nif (packet->flags.ignored) {\r\nrange->displayed_ignored_mark_range_cnt++;\r\n}\r\n}\r\n}\r\n}\r\n#if 0\r\nif (range->cf->marked_count != 0) {\r\nrange->mark_range = mark_high - mark_low + 1;\r\n}\r\nif (range->displayed_marked_cnt != 0) {\r\nrange->displayed_mark_range = displayed_mark_high - displayed_mark_low + 1;\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void packet_range_calc_user(packet_range_t *range) {\r\nguint32 framenum;\r\nframe_data *packet;\r\nrange->user_range_cnt = 0;\r\nrange->ignored_user_range_cnt = 0;\r\nrange->displayed_user_range_cnt = 0;\r\nrange->displayed_ignored_user_range_cnt = 0;\r\ng_assert(range->cf != NULL);\r\nif (range->cf->frames != NULL) {\r\nfor(framenum = 1; framenum <= range->cf->count; framenum++) {\r\npacket = frame_data_sequence_find(range->cf->frames, framenum);\r\nif (value_is_in_range(range->user_range, framenum)) {\r\nrange->user_range_cnt++;\r\nif (packet->flags.ignored) {\r\nrange->ignored_user_range_cnt++;\r\n}\r\nif (packet->flags.passed_dfilter) {\r\nrange->displayed_user_range_cnt++;\r\nif (packet->flags.ignored) {\r\nrange->displayed_ignored_user_range_cnt++;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid packet_range_init(packet_range_t *range, capture_file *cf) {\r\nmemset(range, 0, sizeof(packet_range_t));\r\nrange->process = range_process_all;\r\nrange->user_range = range_empty();\r\nrange->cf = cf;\r\npacket_range_calc(range);\r\npacket_range_calc_user(range);\r\n}\r\nconvert_ret_t packet_range_check(packet_range_t *range) {\r\nif (range->process == range_process_user_range && range->user_range == NULL) {\r\nreturn range->user_range_status;\r\n}\r\nreturn CVT_NO_ERROR;\r\n}\r\nvoid packet_range_process_init(packet_range_t *range) {\r\nrange->marked_range_active = FALSE;\r\nrange->selected_done = FALSE;\r\nif (range->process_filtered == FALSE) {\r\nrange->marked_range_left = range->mark_range_cnt;\r\n} else {\r\nrange->marked_range_left = range->displayed_mark_range_cnt;\r\n}\r\n}\r\ngboolean packet_range_process_all(packet_range_t *range) {\r\nreturn range->process == range_process_all && !range->process_filtered && !range->remove_ignored;\r\n}\r\nrange_process_e packet_range_process_packet(packet_range_t *range, frame_data *fdata) {\r\nif (range->remove_ignored && fdata->flags.ignored) {\r\nreturn range_process_next;\r\n}\r\ng_assert(range->cf != NULL);\r\nswitch(range->process) {\r\ncase(range_process_all):\r\nbreak;\r\ncase(range_process_selected):\r\nif (range->selected_done) {\r\nreturn range_processing_finished;\r\n}\r\nif (fdata->num != range->cf->current_frame->num) {\r\nreturn range_process_next;\r\n}\r\nrange->selected_done = TRUE;\r\nbreak;\r\ncase(range_process_marked):\r\nif (fdata->flags.marked == FALSE) {\r\nreturn range_process_next;\r\n}\r\nbreak;\r\ncase(range_process_marked_range):\r\nif (range->marked_range_left == 0) {\r\nreturn range_processing_finished;\r\n}\r\nif (fdata->flags.marked == TRUE) {\r\nrange->marked_range_active = TRUE;\r\n}\r\nif (range->marked_range_active == FALSE ) {\r\nreturn range_process_next;\r\n}\r\nif (!range->process_filtered ||\r\n(range->process_filtered && fdata->flags.passed_dfilter == TRUE))\r\n{\r\nrange->marked_range_left--;\r\n}\r\nbreak;\r\ncase(range_process_user_range):\r\nif (value_is_in_range(range->user_range, fdata->num) == FALSE) {\r\nreturn range_process_next;\r\n}\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\n}\r\nif ((range->process_filtered && fdata->flags.passed_dfilter == FALSE) &&\r\n!(range->include_dependents && fdata->flags.dependent_of_displayed)) {\r\nreturn range_process_next;\r\n}\r\nreturn range_process_this;\r\n}\r\nvoid packet_range_convert_str(packet_range_t *range, const gchar *es)\r\n{\r\nrange_t *new_range;\r\nconvert_ret_t ret;\r\nif (range->user_range != NULL)\r\ng_free(range->user_range);\r\ng_assert(range->cf != NULL);\r\nret = range_convert_str(&new_range, es, range->cf->count);\r\nif (ret != CVT_NO_ERROR) {\r\nrange->user_range = NULL;\r\nrange->user_range_status = ret;\r\nrange->user_range_cnt = 0;\r\nrange->ignored_user_range_cnt = 0;\r\nrange->displayed_user_range_cnt = 0;\r\nrange->displayed_ignored_user_range_cnt = 0;\r\nreturn;\r\n}\r\nrange->user_range = new_range;\r\npacket_range_calc_user(range);\r\n}

static void\r\nstring_fvalue_new(fvalue_t *fv)\r\n{\r\nfv->value.string = NULL;\r\n}\r\nstatic void\r\nstring_fvalue_free(fvalue_t *fv)\r\n{\r\ng_free(fv->value.string);\r\n}\r\nstatic void\r\nstring_fvalue_set_string(fvalue_t *fv, const gchar *value)\r\n{\r\nDISSECTOR_ASSERT(value != NULL);\r\nstring_fvalue_free(fv);\r\nfv->value.string = (gchar *)g_strdup(value);\r\n}\r\nstatic int\r\nstring_repr_len(fvalue_t *fv, ftrepr_t rtype)\r\n{\r\nswitch (rtype) {\r\ncase FTREPR_DISPLAY:\r\nreturn (int)strlen(fv->value.string);\r\ncase FTREPR_DFILTER:\r\nreturn escape_string_len(fv->value.string);\r\n}\r\ng_assert_not_reached();\r\nreturn -1;\r\n}\r\nstatic void\r\nstring_to_repr(fvalue_t *fv, ftrepr_t rtype, char *buf)\r\n{\r\nswitch (rtype) {\r\ncase FTREPR_DISPLAY:\r\nstrcpy(buf, fv->value.string);\r\nreturn;\r\ncase FTREPR_DFILTER:\r\nescape_string(buf, fv->value.string);\r\nreturn;\r\n}\r\ng_assert_not_reached();\r\n}\r\nstatic gpointer\r\nvalue_get(fvalue_t *fv)\r\n{\r\nreturn fv->value.string;\r\n}\r\nstatic gboolean\r\nval_from_string(fvalue_t *fv, const char *s, LogFunc logfunc _U_)\r\n{\r\nstring_fvalue_free(fv);\r\nfv->value.string = g_strdup(s);\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\nval_from_unparsed(fvalue_t *fv, const char *s, gboolean allow_partial_value _U_, LogFunc logfunc)\r\n{\r\nfvalue_t *fv_bytes;\r\nstring_fvalue_free(fv);\r\nfv_bytes = fvalue_from_unparsed(FT_BYTES, s, TRUE, NULL);\r\nif (fv_bytes) {\r\nint num_bytes = fv_bytes->value.bytes->len;\r\nfv->value.string = (gchar *)g_malloc(num_bytes + 1);\r\nmemcpy(fv->value.string, fv_bytes->value.bytes->data, num_bytes);\r\nfv->value.string[num_bytes] = '\0';\r\nFVALUE_FREE(fv_bytes);\r\nreturn TRUE;\r\n}\r\nreturn val_from_string(fv, s, logfunc);\r\n}\r\nstatic guint\r\nlen(fvalue_t *fv)\r\n{\r\nreturn (guint)strlen(fv->value.string);\r\n}\r\nstatic void\r\nslice(fvalue_t *fv, GByteArray *bytes, guint offset, guint length)\r\n{\r\nguint8* data;\r\ndata = fv->value.ustring + offset;\r\ng_byte_array_append(bytes, data, length);\r\n}\r\nstatic gboolean\r\ncmp_eq(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (strcmp(a->value.string, b->value.string) == 0);\r\n}\r\nstatic gboolean\r\ncmp_ne(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (strcmp(a->value.string, b->value.string) != 0);\r\n}\r\nstatic gboolean\r\ncmp_gt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (strcmp(a->value.string, b->value.string) > 0);\r\n}\r\nstatic gboolean\r\ncmp_ge(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (strcmp(a->value.string, b->value.string) >= 0);\r\n}\r\nstatic gboolean\r\ncmp_lt(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (strcmp(a->value.string, b->value.string) < 0);\r\n}\r\nstatic gboolean\r\ncmp_le(const fvalue_t *a, const fvalue_t *b)\r\n{\r\nreturn (strcmp(a->value.string, b->value.string) <= 0);\r\n}\r\nstatic gboolean\r\ncmp_contains(const fvalue_t *fv_a, const fvalue_t *fv_b)\r\n{\r\nif (strlen(fv_b->value.string) == 0) {\r\nreturn FALSE;\r\n}\r\nif (strstr(fv_a->value.string, fv_b->value.string)) {\r\nreturn TRUE;\r\n}\r\nelse {\r\nreturn FALSE;\r\n}\r\n}\r\nstatic gboolean\r\ncmp_matches(const fvalue_t *fv_a, const fvalue_t *fv_b)\r\n{\r\nchar *str = fv_a->value.string;\r\nGRegex *regex = fv_b->value.re;\r\nif (strcmp(fv_b->ftype->name, "FT_PCRE") != 0) {\r\nreturn FALSE;\r\n}\r\nif (! regex) {\r\nreturn FALSE;\r\n}\r\nreturn g_regex_match_full(\r\nregex,\r\nstr,\r\n(int)strlen(str),\r\n0,\r\n(GRegexMatchFlags)0,\r\nNULL,\r\nNULL\r\n);\r\n}\r\nvoid\r\nftype_register_string(void)\r\n{\r\nstatic ftype_t string_type = {\r\nFT_STRING,\r\n"FT_STRING",\r\n"Character string",\r\n0,\r\nstring_fvalue_new,\r\nstring_fvalue_free,\r\nval_from_unparsed,\r\nval_from_string,\r\nstring_to_repr,\r\nstring_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nstring_fvalue_set_string,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nvalue_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\ncmp_eq,\r\ncmp_ne,\r\ncmp_gt,\r\ncmp_ge,\r\ncmp_lt,\r\ncmp_le,\r\nNULL,\r\ncmp_contains,\r\nCMP_MATCHES,\r\nlen,\r\nslice,\r\n};\r\nstatic ftype_t stringz_type = {\r\nFT_STRINGZ,\r\n"FT_STRINGZ",\r\n"Character string",\r\n0,\r\nstring_fvalue_new,\r\nstring_fvalue_free,\r\nval_from_unparsed,\r\nval_from_string,\r\nstring_to_repr,\r\nstring_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nstring_fvalue_set_string,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nvalue_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\ncmp_eq,\r\ncmp_ne,\r\ncmp_gt,\r\ncmp_ge,\r\ncmp_lt,\r\ncmp_le,\r\nNULL,\r\ncmp_contains,\r\nCMP_MATCHES,\r\nlen,\r\nslice,\r\n};\r\nstatic ftype_t uint_string_type = {\r\nFT_UINT_STRING,\r\n"FT_UINT_STRING",\r\n"Character string",\r\n0,\r\nstring_fvalue_new,\r\nstring_fvalue_free,\r\nval_from_unparsed,\r\nval_from_string,\r\nstring_to_repr,\r\nstring_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nstring_fvalue_set_string,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nvalue_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\ncmp_eq,\r\ncmp_ne,\r\ncmp_gt,\r\ncmp_ge,\r\ncmp_lt,\r\ncmp_le,\r\nNULL,\r\ncmp_contains,\r\nCMP_MATCHES,\r\nlen,\r\nslice,\r\n};\r\nstatic ftype_t stringzpad_type = {\r\nFT_STRINGZPAD,\r\n"FT_STRINGZPAD",\r\n"Character string",\r\n0,\r\nstring_fvalue_new,\r\nstring_fvalue_free,\r\nval_from_unparsed,\r\nval_from_string,\r\nstring_to_repr,\r\nstring_repr_len,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nstring_fvalue_set_string,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\nvalue_get,\r\nNULL,\r\nNULL,\r\nNULL,\r\nNULL,\r\ncmp_eq,\r\ncmp_ne,\r\ncmp_gt,\r\ncmp_ge,\r\ncmp_lt,\r\ncmp_le,\r\nNULL,\r\ncmp_contains,\r\nCMP_MATCHES,\r\nlen,\r\nslice,\r\n};\r\nftype_register(FT_STRING, &string_type);\r\nftype_register(FT_STRINGZ, &stringz_type);\r\nftype_register(FT_UINT_STRING, &uint_string_type);\r\nftype_register(FT_STRINGZPAD, &stringzpad_type);\r\n}

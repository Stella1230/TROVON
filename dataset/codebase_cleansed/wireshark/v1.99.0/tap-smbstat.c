static int\r\nsmbstat_packet(void *pss, packet_info *pinfo, epan_dissect_t *edt _U_, const void *psi)\r\n{\r\nsmbstat_t *ss=(smbstat_t *)pss;\r\nconst smb_info_t *si=(const smb_info_t *)psi;\r\nnstime_t t, deltat;\r\ntimestat_t *sp=NULL;\r\nif(si->request){\r\nreturn 0;\r\n}\r\nif(!si->sip){\r\nreturn 0;\r\n}\r\nif(si->cmd==0xA0 && si->sip->extra_info_type == SMB_EI_NTI){\r\nsmb_nt_transact_info_t *sti=(smb_nt_transact_info_t *)si->sip->extra_info;\r\nif(sti){\r\nsp=&(ss->nt_trans[sti->subcmd]);\r\n}\r\n} else if(si->cmd==0x32 && si->sip->extra_info_type == SMB_EI_T2I){\r\nsmb_transact2_info_t *st2i=(smb_transact2_info_t *)si->sip->extra_info;\r\nif(st2i){\r\nsp=&(ss->trans2[st2i->subcmd]);\r\n}\r\n} else {\r\nsp=&(ss->proc[si->cmd]);\r\n}\r\nt=pinfo->fd->abs_ts;\r\nnstime_delta(&deltat, &t, &si->sip->req_time);\r\nif(sp){\r\ntime_stat_update(sp,&deltat, pinfo);\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nsmbstat_draw(void *pss)\r\n{\r\nsmbstat_t *ss=(smbstat_t *)pss;\r\nguint32 i;\r\nguint64 td;\r\nprintf("\n");\r\nprintf("=================================================================\n");\r\nprintf("SMB SRT Statistics:\n");\r\nprintf("Filter: %s\n",ss->filter?ss->filter:"");\r\nprintf("Commands Calls Min SRT Max SRT Avg SRT\n");\r\nfor(i=0;i<256;i++){\r\nif(ss->proc[i].num==0){\r\ncontinue;\r\n}\r\nif(i==0x32){\r\ncontinue;\r\n}\r\nif(i==0xA0){\r\ncontinue;\r\n}\r\ntd = ((guint64)(ss->proc[i].tot.secs)) * NANOSECS_PER_SEC + ss->proc[i].tot.nsecs;\r\ntd = ((td / ss->proc[i].num) + 500) / 1000;\r\nprintf("%-25s %6d %3d.%06d %3d.%06d %3" G_GINT64_MODIFIER "u.%06" G_GINT64_MODIFIER "u\n",\r\nval_to_str_ext(i, &smb_cmd_vals_ext, "Unknown (0x%02x)"),\r\nss->proc[i].num,\r\n(int)(ss->proc[i].min.secs),(ss->proc[i].min.nsecs+500)/1000,\r\n(int)(ss->proc[i].max.secs),(ss->proc[i].max.nsecs+500)/1000,\r\ntd/MICROSECS_PER_SEC, td%MICROSECS_PER_SEC\r\n);\r\n}\r\nprintf("\n");\r\nprintf("Transaction2 Commands Calls Min SRT Max SRT Avg SRT\n");\r\nfor(i=0;i<256;i++){\r\nif(ss->trans2[i].num==0){\r\ncontinue;\r\n}\r\ntd = ((guint64)(ss->trans2[i].tot.secs)) * NANOSECS_PER_SEC + ss->trans2[i].tot.nsecs;\r\ntd = ((td / ss->trans2[i].num) + 500) / 1000;\r\nprintf("%-25s %6d %3d.%06d %3d.%06d %3" G_GINT64_MODIFIER "u.%06" G_GINT64_MODIFIER "u\n",\r\nval_to_str_ext(i, &trans2_cmd_vals_ext, "Unknown (0x%02x)"),\r\nss->trans2[i].num,\r\n(int)(ss->trans2[i].min.secs),(ss->trans2[i].min.nsecs+500)/1000,\r\n(int)(ss->trans2[i].max.secs),(ss->trans2[i].max.nsecs+500)/1000,\r\ntd/MICROSECS_PER_SEC, td%MICROSECS_PER_SEC\r\n);\r\n}\r\nprintf("\n");\r\nprintf("NT Transaction Commands Calls Min SRT Max SRT Avg SRT\n");\r\nfor(i=0;i<256;i++){\r\nif(ss->nt_trans[i].num==0){\r\ncontinue;\r\n}\r\ntd = ((guint64)(ss->nt_trans[i].tot.secs)) * NANOSECS_PER_SEC + ss->nt_trans[i].tot.nsecs;\r\ntd = ((td / ss->nt_trans[i].num) + 500) / 1000;\r\nprintf("%-25s %6d %3d.%06d %3d.%06d %3" G_GINT64_MODIFIER "u.%06" G_GINT64_MODIFIER "u\n",\r\nval_to_str_ext(i, &nt_cmd_vals_ext, "Unknown (0x%02x)"),\r\nss->nt_trans[i].num,\r\n(int)(ss->nt_trans[i].min.secs),(ss->nt_trans[i].min.nsecs+500)/1000,\r\n(int)(ss->nt_trans[i].max.secs),(ss->nt_trans[i].max.nsecs+500)/1000,\r\ntd/MICROSECS_PER_SEC, td%MICROSECS_PER_SEC\r\n);\r\n}\r\nprintf("=================================================================\n");\r\n}\r\nstatic void\r\nsmbstat_init(const char *opt_arg,void* userdata _U_)\r\n{\r\nsmbstat_t *ss;\r\nguint32 i;\r\nconst char *filter=NULL;\r\nGString *error_string;\r\nif(!strncmp(opt_arg,"smb,srt,",8)){\r\nfilter=opt_arg+8;\r\n} else {\r\nfilter=NULL;\r\n}\r\nss=g_new(smbstat_t,1);\r\nif(filter){\r\nss->filter=g_strdup(filter);\r\n} else {\r\nss->filter=NULL;\r\n}\r\nfor(i=0;i<256;i++){\r\nss->proc[i].num=0;\r\nss->proc[i].min_num=0;\r\nss->proc[i].max_num=0;\r\nss->proc[i].min.secs=0;\r\nss->proc[i].min.nsecs=0;\r\nss->proc[i].max.secs=0;\r\nss->proc[i].max.nsecs=0;\r\nss->proc[i].tot.secs=0;\r\nss->proc[i].tot.nsecs=0;\r\nss->trans2[i].num=0;\r\nss->trans2[i].min_num=0;\r\nss->trans2[i].max_num=0;\r\nss->trans2[i].min.secs=0;\r\nss->trans2[i].min.nsecs=0;\r\nss->trans2[i].max.secs=0;\r\nss->trans2[i].max.nsecs=0;\r\nss->trans2[i].tot.secs=0;\r\nss->trans2[i].tot.nsecs=0;\r\nss->nt_trans[i].num=0;\r\nss->nt_trans[i].min_num=0;\r\nss->nt_trans[i].max_num=0;\r\nss->nt_trans[i].min.secs=0;\r\nss->nt_trans[i].min.nsecs=0;\r\nss->nt_trans[i].max.secs=0;\r\nss->nt_trans[i].max.nsecs=0;\r\nss->nt_trans[i].tot.secs=0;\r\nss->nt_trans[i].tot.nsecs=0;\r\n}\r\nerror_string=register_tap_listener("smb", ss, filter, 0, NULL, smbstat_packet, smbstat_draw);\r\nif(error_string){\r\ng_free(ss->filter);\r\ng_free(ss);\r\nfprintf(stderr, "tshark: Couldn't register smb,srt tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_smbstat(void)\r\n{\r\nregister_stat_cmd_arg("smb,srt", smbstat_init,NULL);\r\n}

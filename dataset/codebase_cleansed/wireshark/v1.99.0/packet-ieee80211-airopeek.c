static void\r\ndissect_airopeek(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *airopeek_tree = NULL;\r\nproto_item *ti;\r\nguint8 data_rate;\r\nguint8 signal_level;\r\ntvbuff_t *next_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "AiroPeek");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_airopeek, tvb, 0, 4, ENC_NA);\r\nairopeek_tree = proto_item_add_subtree(ti, ett_airopeek);\r\n}\r\ndata_rate = tvb_get_guint8(tvb, 0);\r\ncol_add_fstr(pinfo->cinfo, COL_TX_RATE, "%u.%u",\r\ndata_rate / 2,\r\ndata_rate & 1 ? 5 : 0);\r\nif (tree) {\r\nproto_tree_add_uint64_format_value(airopeek_tree, hf_data_rate, tvb, 0, 1,\r\n(guint64)data_rate * 500000,\r\n"%u.%u Mb/s",\r\ndata_rate / 2,\r\ndata_rate & 1 ? 5 : 0);\r\n}\r\nif (tree)\r\nproto_tree_add_item(airopeek_tree, hf_channel, tvb, 1, 1, ENC_NA);\r\nsignal_level = tvb_get_guint8(tvb, 2);\r\ncol_add_fstr(pinfo->cinfo, COL_RSSI, "%u%%", signal_level);\r\nproto_tree_add_uint_format_value(airopeek_tree, hf_signal_strength, tvb, 2, 1,\r\nsignal_level,\r\n"%u%%",\r\nsignal_level);\r\npinfo->current_proto = "IEEE 802.11";\r\nnext_tvb = tvb_new_subset_remaining(tvb, 4);\r\ncall_dissector(ieee80211_handle, next_tvb, pinfo, tree);\r\n}\r\nvoid proto_register_ieee80211_airopeek(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_data_rate,\r\n{"Data Rate", "airopeek.data_rate", FT_UINT64, BASE_DEC, NULL, 0,\r\n"Data rate (b/s)", HFILL }},\r\n{&hf_channel,\r\n{"Channel", "airopeek.channel", FT_UINT8, BASE_DEC, NULL, 0,\r\n"802.11 channel number that this frame was sent/received on", HFILL }},\r\n{&hf_signal_strength,\r\n{"Signal Strength", "airopeek.signal_strength", FT_UINT8, BASE_DEC, NULL, 0,\r\n"Signal strength (Percentage)", HFILL }}\r\n};\r\nstatic gint *tree_array[] = {\r\n&ett_airopeek\r\n};\r\nproto_airopeek = proto_register_protocol("AiroPeek 802.11 radio information",\r\n"AiroPeek",\r\n"airopeek");\r\nproto_register_field_array(proto_airopeek, hf, array_length(hf));\r\nproto_register_subtree_array(tree_array, array_length(tree_array));\r\n}\r\nvoid proto_reg_handoff_ieee80211_airopeek(void)\r\n{\r\ndissector_handle_t airopeek_handle;\r\nairopeek_handle = create_dissector_handle(dissect_airopeek, proto_airopeek);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_IEEE_802_11_AIROPEEK,\r\nairopeek_handle);\r\nieee80211_handle = find_dissector("wlan");\r\n}

static void\r\nmegacostat_draw(void *pms)\r\n{\r\nmegacostat_t *ms=(megacostat_t *)pms;\r\nint i;\r\nprintf("\n");\r\nprintf("=====================================================================================================\n");\r\nprintf("MEGACO Response Time Delay (RTD) Statistics:\n");\r\nprintf("Filter for statistics: %s\n",ms->filter?ms->filter:"");\r\nprintf("Duplicate requests: %u\n",ms->req_dup_num);\r\nprintf("Duplicate responses: %u\n",ms->rsp_dup_num);\r\nprintf("Open requests: %u\n",ms->open_req_num);\r\nprintf("Discarded responses: %u\n",ms->disc_rsp_num);\r\nprintf(" Type | Messages | Min RTD | Max RTD | Avg RTD | Min in Frame | Max in Frame |\n");\r\nfor(i=0;i<NUM_TIMESTATS;i++) {\r\nif(ms->rtd[i].num) {\r\nprintf("%5s | %7u | %8.2f msec | %8.2f msec | %8.2f msec | %10u | %10u |\n",\r\nval_to_str(i,megaco_message_type,"Other"),ms->rtd[i].num,\r\nnstime_to_msec(&(ms->rtd[i].min)), nstime_to_msec(&(ms->rtd[i].max)),\r\nget_average(&(ms->rtd[i].tot), ms->rtd[i].num),\r\nms->rtd[i].min_num, ms->rtd[i].max_num\r\n);\r\n}\r\n}\r\nprintf("=====================================================================================================\n");\r\n}\r\nstatic void\r\nmegacostat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nmegacostat_t *ms;\r\nint i;\r\nGString *error_string;\r\npref_t *megaco_ctx_track,*h248_ctx_track;\r\nmegaco_ctx_track = prefs_find_preference(prefs_find_module("megaco"),"ctx_info");\r\nh248_ctx_track = prefs_find_preference(prefs_find_module("h248"),"ctx_info");\r\nif (!megaco_ctx_track || !h248_ctx_track) {\r\nreturn;\r\n}\r\nif (!*megaco_ctx_track->varp.boolp || !*h248_ctx_track->varp.boolp) {\r\nprintf("Track Context option at Protocols -> MEGACO and Protocols -> H248 preferences\n");\r\nprintf("has to be set to true to enable measurement of service response times.\n");\r\nexit(1);\r\n}\r\nms=g_new(megacostat_t,1);\r\nif(!strncmp(opt_arg,"megaco,rtd,",11)){\r\nms->filter=g_strdup(opt_arg+11);\r\n} else {\r\nms->filter=NULL;\r\n}\r\nfor(i=0;i<NUM_TIMESTATS;i++) {\r\nms->rtd[i].num=0;\r\nms->rtd[i].min_num=0;\r\nms->rtd[i].max_num=0;\r\nms->rtd[i].min.secs=0;\r\nms->rtd[i].min.nsecs=0;\r\nms->rtd[i].max.secs=0;\r\nms->rtd[i].max.nsecs=0;\r\nms->rtd[i].tot.secs=0;\r\nms->rtd[i].tot.nsecs=0;\r\n}\r\nms->open_req_num=0;\r\nms->disc_rsp_num=0;\r\nms->req_dup_num=0;\r\nms->rsp_dup_num=0;\r\nerror_string=register_tap_listener("megaco", ms, ms->filter, 0, NULL, megacostat_packet, megacostat_draw);\r\nif(error_string){\r\ng_free(ms->filter);\r\ng_free(ms);\r\nfprintf(stderr, "tshark: Couldn't register megaco,rtd tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_megacostat(void)\r\n{\r\nif (find_tap_id("megaco")) {\r\nregister_stat_cmd_arg("megaco,rtd", megacostat_init, NULL);\r\n}\r\n}

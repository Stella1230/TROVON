void\r\ncapture_wlancap(const guchar *pd, int offset, int len, packet_counts *ld)\r\n{\r\nguint32 length;\r\nif (!BYTES_ARE_IN_FRAME(offset, len, sizeof(guint32)*2)) {\r\nld->other++;\r\nreturn;\r\n}\r\nlength = pntoh32(pd+sizeof(guint32));\r\nif (!BYTES_ARE_IN_FRAME(offset, len, length)) {\r\nld->other++;\r\nreturn;\r\n}\r\noffset += length;\r\ncapture_ieee80211(pd, offset, len, ld);\r\n}\r\nstatic void\r\ndissect_wlancap(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_tree *wlan_tree = NULL;\r\nproto_item *ti;\r\ntvbuff_t *next_tvb;\r\nint offset;\r\nguint32 version;\r\nguint32 length;\r\nguint32 channel;\r\nguint32 datarate;\r\nguint32 ssi_type;\r\nguint32 antnoise;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "WLAN");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\noffset = 0;\r\nversion = tvb_get_ntohl(tvb, offset) - WLANCAP_MAGIC_COOKIE_BASE;\r\nlength = tvb_get_ntohl(tvb, offset+4);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "AVS WLAN Capture v%x, Length %d",version, length);\r\nif (version > 2) {\r\ngoto skip;\r\n}\r\nif (tree) {\r\nti = proto_tree_add_item(tree, proto_wlancap, tvb, 0, length, ENC_NA);\r\nwlan_tree = proto_item_add_subtree(ti, ett_radio);\r\nproto_tree_add_item(wlan_tree, hf_wlan_magic, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(wlan_tree, hf_wlan_version, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_mactime, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset+=8;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_hosttime, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset+=8;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_phytype, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nchannel = tvb_get_ntohl(tvb, offset);\r\nif (channel < 256) {\r\ncol_add_fstr(pinfo->cinfo, COL_FREQ_CHAN, "%u", channel);\r\nif (tree)\r\nproto_tree_add_uint(wlan_tree, hf_channel, tvb, offset, 4, channel);\r\n} else if (channel < 10000) {\r\ncol_add_fstr(pinfo->cinfo, COL_FREQ_CHAN, "%u MHz", channel);\r\nif (tree)\r\nproto_tree_add_uint_format(wlan_tree, hf_channel_frequency, tvb, offset,\r\n4, channel, "Frequency: %u MHz", channel);\r\n} else {\r\ncol_add_fstr(pinfo->cinfo, COL_FREQ_CHAN, "%u KHz", channel);\r\nif (tree)\r\nproto_tree_add_uint_format(wlan_tree, hf_channel_frequency, tvb, offset,\r\n4, channel, "Frequency: %u KHz", channel);\r\n}\r\noffset+=4;\r\ndatarate = tvb_get_ntohl(tvb, offset);\r\nif (datarate < 100000) {\r\ndatarate *= 100000;\r\n}\r\ncol_add_fstr(pinfo->cinfo, COL_TX_RATE, "%u.%u",\r\ndatarate / 1000000,\r\n((datarate % 1000000) > 500000) ? 5 : 0);\r\nif (tree) {\r\nproto_tree_add_uint64_format_value(wlan_tree, hf_data_rate, tvb, offset, 4,\r\ndatarate,\r\n"%u.%u Mb/s",\r\ndatarate/1000000,\r\n((datarate % 1000000) > 500000) ? 5 : 0);\r\n}\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_antenna, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_priority, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nssi_type = tvb_get_ntohl(tvb, offset);\r\nif (tree)\r\nproto_tree_add_uint(wlan_tree, hf_wlan_ssi_type, tvb, offset, 4, ssi_type);\r\noffset+=4;\r\nswitch (ssi_type) {\r\ncase SSI_NONE:\r\ndefault:\r\nbreak;\r\ncase SSI_NORM_RSSI:\r\ncol_add_fstr(pinfo->cinfo, COL_RSSI, "%u (norm)", tvb_get_ntohl(tvb, offset));\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_normrssi_antsignal, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase SSI_DBM:\r\ncol_add_fstr(pinfo->cinfo, COL_RSSI, "%d dBm", tvb_get_ntohl(tvb, offset));\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_dbm_antsignal, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase SSI_RAW_RSSI:\r\ncol_add_fstr(pinfo->cinfo, COL_RSSI, "%u (raw)", tvb_get_ntohl(tvb, offset));\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_rawrssi_antsignal, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\noffset+=4;\r\nantnoise = tvb_get_ntohl(tvb, offset);\r\nif (antnoise != 0xffffffff) {\r\nswitch (ssi_type) {\r\ncase SSI_NONE:\r\ndefault:\r\nbreak;\r\ncase SSI_NORM_RSSI:\r\nif (tree)\r\nproto_tree_add_uint(wlan_tree, hf_normrssi_antnoise, tvb, offset, 4, antnoise);\r\nbreak;\r\ncase SSI_DBM:\r\nif (tree)\r\nproto_tree_add_int(wlan_tree, hf_dbm_antnoise, tvb, offset, 4, antnoise);\r\nbreak;\r\ncase SSI_RAW_RSSI:\r\nif (tree)\r\nproto_tree_add_uint(wlan_tree, hf_rawrssi_antnoise, tvb, offset, 4, antnoise);\r\nbreak;\r\n}\r\n}\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_preamble, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_encoding, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (version > 1) {\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_sequence, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_drops, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset+=4;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_receiver_addr, tvb, offset, 6, ENC_NA);\r\noffset+=6;\r\nif (tree)\r\nproto_tree_add_item(wlan_tree, hf_wlan_padding, tvb, offset, 2, ENC_NA);\r\n}\r\nskip:\r\noffset = length;\r\nnext_tvb = tvb_new_subset_remaining(tvb, offset);\r\ncall_dissector(ieee80211_handle, next_tvb, pinfo, tree);\r\n}\r\nvoid proto_register_ieee80211_wlancap(void)\r\n{\r\nproto_wlancap = proto_register_protocol("AVS WLAN Capture header",\r\n"AVS WLANCAP", "wlancap");\r\nproto_register_field_array(proto_wlancap, hf_wlancap,\r\narray_length(hf_wlancap));\r\nregister_dissector("wlancap", dissect_wlancap, proto_wlancap);\r\nwlancap_handle = create_dissector_handle(dissect_wlancap, proto_wlancap);\r\ndissector_add_uint("wtap_encap", WTAP_ENCAP_IEEE_802_11_AVS,\r\nwlancap_handle);\r\nproto_register_subtree_array(tree_array, array_length(tree_array));\r\n}\r\nvoid proto_reg_handoff_ieee80211_wlancap(void)\r\n{\r\nieee80211_handle = find_dissector("wlan");\r\n}

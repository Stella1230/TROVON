static void\r\ndissect_mifare(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *item;\r\nproto_tree *mifare_tree;\r\nguint8 cmd;\r\ntvbuff_t *next_tvb = NULL;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "MiFare");\r\ncol_set_str(pinfo->cinfo, COL_INFO, "MiFare Packet");\r\nif (tree) {\r\nitem = proto_tree_add_item(tree, proto_mifare, tvb, 0, -1, ENC_NA);\r\nmifare_tree = proto_item_add_subtree(item, ett_mifare);\r\nproto_tree_add_item(mifare_tree, hf_mifare_command, tvb, 0, 1, ENC_NA);\r\ncmd = tvb_get_guint8(tvb, 0);\r\nswitch (cmd) {\r\ncase AUTH_A:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_key_a, tvb, 2, 6, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_uid, tvb, 8, 4, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Authenticate with Key A");\r\nbreak;\r\ncase AUTH_B:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_key_b, tvb, 2, 6, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_uid, tvb, 8, 4, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Authenticate with Key B");\r\nbreak;\r\ncase READ:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Read");\r\nbreak;\r\ncase WRITE:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Write");\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nnext_tvb = tvb_new_subset_remaining(tvb, 2);\r\ncall_dissector(data_handle, next_tvb, pinfo, tree);\r\nbreak;\r\ncase TRANSFER:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Transfer");\r\nbreak;\r\ncase DECREMENT:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_operand, tvb, 2, 4, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Decrement");\r\nbreak;\r\ncase INCREMENT:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_operand, tvb, 2, 4, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Increment");\r\nbreak;\r\ncase RESTORE:\r\nproto_tree_add_item(mifare_tree, hf_mifare_block_address, tvb, 1, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(mifare_tree, hf_mifare_operand, tvb, 2, 4, ENC_BIG_ENDIAN);\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Restore");\r\nbreak;\r\ndefault:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Unknown");\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid\r\nproto_register_mifare(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_mifare_command,\r\n{ "Command", "mifare.cmd", FT_UINT8, BASE_HEX,\r\nVALS(hf_mifare_commands), 0x0, NULL, HFILL }},\r\n{&hf_mifare_block_address,\r\n{ "Block Address", "mifare.block.addr", FT_UINT8, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_key_a,\r\n{ "Key A", "mifare.key.a", FT_UINT64, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_key_b,\r\n{ "Key B", "mifare.key.b", FT_UINT64, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_uid,\r\n{ "UID", "mifare.uid", FT_UINT32, BASE_HEX,\r\nNULL, 0x0, NULL, HFILL }},\r\n{&hf_mifare_operand,\r\n{ "Operand", "mifare.operand", FT_INT32, BASE_DEC,\r\nNULL, 0x0, NULL, HFILL }}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mifare\r\n};\r\nproto_mifare = proto_register_protocol("NXP MiFare", "MiFare", "mifare");\r\nproto_register_field_array(proto_mifare, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("mifare", dissect_mifare, proto_mifare);\r\n}\r\nvoid\r\nproto_reg_handoff_mifare(void)\r\n{\r\ndata_handle = find_dissector("data");\r\n}

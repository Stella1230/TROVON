gboolean\r\neo_save_entry(const gchar *save_as_filename, export_object_entry_t *entry, gboolean show_err)\r\n{\r\nint to_fd;\r\ngint64 bytes_left;\r\nint bytes_to_write;\r\nssize_t bytes_written;\r\nguint8 *ptr;\r\nint err;\r\nto_fd = ws_open(save_as_filename, O_WRONLY | O_CREAT | O_EXCL |\r\nO_BINARY, 0644);\r\nif(to_fd == -1) {\r\nif (show_err)\r\nopen_failure_alert_box(save_as_filename, errno, TRUE);\r\nreturn FALSE;\r\n}\r\nptr = entry->payload_data;\r\nbytes_left = entry->payload_len;\r\nwhile (bytes_left != 0) {\r\nif (bytes_left > 0x40000000)\r\nbytes_to_write = 0x40000000;\r\nelse\r\nbytes_to_write = (int)bytes_left;\r\nbytes_written = ws_write(to_fd, ptr, bytes_to_write);\r\nif(bytes_written <= 0) {\r\nif (bytes_written < 0)\r\nerr = errno;\r\nelse\r\nerr = WTAP_ERR_SHORT_WRITE;\r\nif (show_err)\r\nwrite_failure_alert_box(save_as_filename, err);\r\nws_close(to_fd);\r\nreturn FALSE;\r\n}\r\nbytes_left -= bytes_written;\r\nptr += bytes_written;\r\n}\r\nif (ws_close(to_fd) < 0) {\r\nif (show_err)\r\nwrite_failure_alert_box(save_as_filename, errno);\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic GString *eo_rename(GString *gstr, int dupn)\r\n{\r\nGString *gstr_tmp;\r\ngchar *tmp_ptr;\r\nGString *ext_str;\r\ngstr_tmp = g_string_new("(");\r\ng_string_append_printf (gstr_tmp, "%d)", dupn);\r\nif ( (tmp_ptr = strrchr(gstr->str, '.')) != NULL ) {\r\next_str = g_string_new(tmp_ptr);\r\ngstr = g_string_truncate(gstr, gstr->len - ext_str->len);\r\nif ( gstr->len >= (MAXFILELEN - (strlen(gstr_tmp->str) + ext_str->len)) )\r\ngstr = g_string_truncate(gstr, MAXFILELEN - (strlen(gstr_tmp->str) + ext_str->len));\r\ngstr = g_string_append(gstr, gstr_tmp->str);\r\ngstr = g_string_append(gstr, ext_str->str);\r\ng_string_free(ext_str, TRUE);\r\n}\r\nelse {\r\nif ( gstr->len >= (MAXFILELEN - strlen(gstr_tmp->str)) )\r\ngstr = g_string_truncate(gstr, MAXFILELEN - strlen(gstr_tmp->str));\r\ngstr = g_string_append(gstr, gstr_tmp->str);\r\n}\r\ng_string_free(gstr_tmp, TRUE);\r\nreturn gstr;\r\n}\r\nGString *\r\neo_massage_str(const gchar *in_str, gsize maxlen, int dupn)\r\n{\r\ngchar *tmp_ptr;\r\nconst gchar *reject = "<>:\"/\\|?*"\r\n"\x01\x02\x03\x04\x05\x06\x07\x08\x09\x0a"\r\n"\x0b\x0c\x0d\x0e\x0f\x10\x11\x12\x13\x14"\r\n"\x15\x16\x17\x18\x19\x1a\x1b\x1c\x1d\x1e\x1f";\r\nGString *out_str;\r\nGString *ext_str;\r\nout_str = g_string_new("");\r\nwhile ( (tmp_ptr = strpbrk(in_str, reject)) != NULL ) {\r\nout_str = g_string_append_len(out_str, in_str, tmp_ptr - in_str);\r\nout_str = g_string_append_c(out_str, '%');\r\nout_str = g_string_append_c(out_str, HEXTOASCII(HINIBBLE(*tmp_ptr)));\r\nout_str = g_string_append_c(out_str, HEXTOASCII(LONIBBLE(*tmp_ptr)));\r\nin_str = tmp_ptr + 1;\r\n}\r\nout_str = g_string_append(out_str, in_str);\r\nif ( out_str->len > maxlen ) {\r\nif ( (tmp_ptr = strrchr(out_str->str, '.')) != NULL ) {\r\next_str = g_string_new(tmp_ptr);\r\nout_str = g_string_truncate(out_str, maxlen - ext_str->len);\r\nout_str = g_string_append(out_str, ext_str->str);\r\ng_string_free(ext_str, TRUE);\r\n}\r\nelse\r\nout_str = g_string_truncate(out_str, maxlen);\r\n}\r\nif ( dupn != 0 )\r\nout_str = eo_rename(out_str, dupn);\r\nreturn out_str;\r\n}\r\nconst char *\r\nct2ext(const char *content_type)\r\n{\r\nreturn content_type;\r\n}

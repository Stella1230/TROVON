static void lct_timestamp_parse(guint32 t, nstime_t* s)\r\n{\r\ns->secs = t / 1000;\r\ns->nsecs = (t % 1000) * 1000000;\r\n}\r\ndouble rmt_decode_send_rate(guint16 send_rate )\r\n{\r\ndouble value;\r\nvalue = (send_rate >> 4) * 10.0 / 4096.0 * pow(10.0, (send_rate & 0xf));\r\nreturn value;\r\n}\r\nint lct_ext_decode(proto_tree *tree, tvbuff_t *tvb, packet_info *pinfo, guint offset, guint offset_max, lct_data_exchange_t *data_exchange,\r\nint hfext, int ettext)\r\n{\r\nguint8 het;\r\nguint i, count = 0;\r\nguint length,\r\ntmp_offset = offset,\r\nstart_offset = offset;\r\nproto_item *ti;\r\nproto_tree *hec_tree, *ext_tree;\r\nwhile (tmp_offset < offset_max)\r\n{\r\nhet = tvb_get_guint8(tvb, tmp_offset);\r\nif (het <= 127)\r\n{\r\nlength = tvb_get_guint8(tvb, tmp_offset+1)*4;\r\n}\r\nelse\r\n{\r\nlength = 4;\r\n}\r\nif (length == 0)\r\nbreak;\r\ntmp_offset += length;\r\ncount++;\r\n}\r\nif (count == 0)\r\nreturn 0;\r\nti = proto_tree_add_uint(tree, hfext, tvb, offset, tmp_offset - offset, count);\r\nhec_tree = proto_item_add_subtree(ti, ettext);\r\nfor (i = 0; i < count; i++)\r\n{\r\nhet = tvb_get_guint8(tvb, offset);\r\nif (het <= 127)\r\n{\r\nlength = tvb_get_guint8(tvb, offset+1)*4;\r\n}\r\nelse\r\n{\r\nlength = 4;\r\n}\r\nti = proto_tree_add_item(hec_tree, hf_hec_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\next_tree = proto_item_add_subtree(ti, ett_ext_ext);\r\nproto_item_set_len(ti, length);\r\nif (het <= 127)\r\n{\r\nproto_tree_add_item(ext_tree, hf_hec_len, tvb, offset+1, 1, ENC_BIG_ENDIAN);\r\n}\r\nswitch (het)\r\n{\r\ncase 0:\r\ncase 1:\r\ndefault:\r\nproto_tree_add_item(ext_tree, hf_hec_data, tvb, offset+2, length-2, ENC_NA);\r\nbreak;\r\ncase 3:\r\nproto_tree_add_text(ext_tree, tvb, offset+2, 2,\r\n"CC Sequence: %u", tvb_get_ntohs(tvb, offset+2));\r\nproto_tree_add_text(ext_tree, tvb, offset+4, 1,\r\n"CC Flags: 0x%x", tvb_get_guint8(tvb, offset+4));\r\nproto_tree_add_text(ext_tree, tvb, offset+5, 1,\r\n"CC RTT: %u", tvb_get_guint8(tvb, offset+5));\r\nproto_tree_add_text(ext_tree, tvb, offset+6, 2,\r\n"CC Loss: %g", tvb_get_ntohs(tvb, offset+6)/65535.0);\r\nproto_tree_add_text(ext_tree, tvb, offset+8, 2,\r\n"CC Rate: %u", tvb_get_ntohs(tvb, offset+8));\r\nbreak;\r\ncase 64:\r\nfec_decode_ext_fti(tvb, pinfo, ext_tree, offset,\r\n(data_exchange == NULL) ? 0 : data_exchange->codepoint);\r\nbreak;\r\ncase 128:\r\nproto_tree_add_double(ext_tree, hf_send_rate, tvb, offset+2, 2,\r\nrmt_decode_send_rate(tvb_get_ntohs(tvb, offset+2)));\r\nbreak;\r\ncase 192:\r\nif ((data_exchange != NULL) && (data_exchange->ext_192 == LCT_PREFS_EXT_192_FLUTE))\r\n{\r\nproto_tree_add_item(ext_tree, hf_flute_version, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(ext_tree, hf_fdt_instance_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ndata_exchange->is_flute = TRUE;\r\n}\r\nbreak;\r\ncase 193:\r\nif ((data_exchange != NULL) && (data_exchange->ext_193 == LCT_PREFS_EXT_193_FLUTE))\r\n{\r\nproto_tree_add_item(ext_tree, hf_cenc, tvb, offset+3, 1, ENC_BIG_ENDIAN);\r\n}\r\nbreak;\r\n}\r\noffset += length;\r\n}\r\nreturn offset-start_offset;\r\n}\r\nstatic int\r\ndissect_lct(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data)\r\n{\r\nint offset = 0;\r\nguint16 buffer16;\r\nguint8 cci_size;\r\nguint8 tsi_size;\r\nguint8 toi_size;\r\nguint64 tsi;\r\nguint64 toi = 0;\r\nguint16 hlen;\r\nnstime_t tmp_time;\r\nproto_item *ti;\r\nproto_tree *lct_tree = tree, *lct_fsize_tree, *lct_flags_tree;\r\nlct_data_exchange_t *data_exchange = (lct_data_exchange_t *)data;\r\nbuffer16 = tvb_get_ntohs(tvb, offset);\r\ncci_size = ((buffer16 & 0x0C00) >> 10) * 4 + 4;\r\ntsi_size = ((buffer16 & 0x0080) >> 7) * 4 + ((buffer16 & 0x0010) >> 4) * 2;\r\ntoi_size = ((buffer16 & 0x0060) >> 5) * 4 + ((buffer16 & 0x0010) >> 4) * 2;\r\nhlen = tvb_get_guint8(tvb, offset+2) * 4;\r\nif (data_exchange != NULL)\r\n{\r\ndata_exchange->codepoint = tvb_get_guint8(tvb, offset+3);\r\ndata_exchange->is_flute = FALSE;\r\n}\r\nif (tree)\r\n{\r\nti = proto_tree_add_item(tree, proto_rmt_lct, tvb, offset, hlen, ENC_NA);\r\nlct_tree = proto_item_add_subtree(ti, ett_main);\r\nproto_tree_add_item(lct_tree, hf_version, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nti = proto_tree_add_item(lct_tree, hf_fsize_header, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlct_fsize_tree = proto_item_add_subtree(ti, ett_fsize);\r\nproto_tree_add_uint(lct_fsize_tree, hf_fsize_cci, tvb, offset, 2, cci_size);\r\nproto_tree_add_uint(lct_fsize_tree, hf_fsize_tsi, tvb, offset, 2, tsi_size);\r\nproto_tree_add_uint(lct_fsize_tree, hf_fsize_toi, tvb, offset, 2, toi_size);\r\nti = proto_tree_add_item(lct_tree, hf_flags_header, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nlct_flags_tree = proto_item_add_subtree(ti, ett_flags);\r\nproto_tree_add_item(lct_flags_tree, hf_flags_sct_present, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(lct_flags_tree, hf_flags_ert_present, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(lct_flags_tree, hf_flags_close_session, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(lct_flags_tree, hf_flags_close_object, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_uint(lct_tree, hf_hlen, tvb, offset+2, 1, hlen);\r\nproto_tree_add_item(lct_tree, hf_codepoint, tvb, offset+3, 1, ENC_BIG_ENDIAN);\r\n}\r\noffset += 4;\r\nif (cci_size > 0) {\r\nproto_tree_add_item(lct_tree, hf_cci, tvb, offset, cci_size, ENC_NA);\r\noffset += cci_size;\r\n}\r\nif (tsi_size > 0) {\r\nswitch (tsi_size)\r\n{\r\ncase 0:\r\nproto_tree_add_uint(lct_tree, hf_tsi, tvb, offset, tsi_size, 0);\r\ntsi = 0;\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(lct_tree, hf_tsi16, tvb, offset, tsi_size, ENC_BIG_ENDIAN);\r\ntsi = tvb_get_ntohs(tvb, offset);\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(lct_tree, hf_tsi32, tvb, offset, tsi_size, ENC_BIG_ENDIAN);\r\ntsi = tvb_get_ntohl(tvb, offset);\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(lct_tree, hf_tsi48, tvb, offset, tsi_size, ENC_BIG_ENDIAN);\r\ntsi = tvb_get_ntoh48(tvb, offset);\r\nbreak;\r\ndefault:\r\ntsi = 0;\r\nbreak;\r\n}\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "TSI: %" G_GINT64_MODIFIER "u", tsi);\r\noffset += tsi_size;\r\n}\r\nif (toi_size > 0) {\r\nswitch (toi_size)\r\n{\r\ncase 0:\r\nproto_tree_add_uint(lct_tree, hf_toi, tvb, offset, toi_size, 0);\r\ntoi = 0;\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(lct_tree, hf_toi16, tvb, offset, toi_size, ENC_BIG_ENDIAN);\r\ntoi = tvb_get_ntohs(tvb, offset);\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(lct_tree, hf_toi32, tvb, offset, toi_size, ENC_BIG_ENDIAN);\r\ntoi = tvb_get_ntohl(tvb, offset);\r\nbreak;\r\ncase 6:\r\nproto_tree_add_item(lct_tree, hf_toi48, tvb, offset, toi_size, ENC_BIG_ENDIAN);\r\ntoi = tvb_get_ntoh48(tvb, offset);\r\nbreak;\r\ncase 8:\r\nproto_tree_add_item(lct_tree, hf_toi64, tvb, offset, toi_size, ENC_BIG_ENDIAN);\r\ntoi = tvb_get_ntoh64(tvb, offset);\r\nbreak;\r\ncase 10:\r\nproto_tree_add_item(lct_tree, hf_toi64, tvb, offset+2, 8, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(lct_tree, hf_toi_extended, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 12:\r\nproto_tree_add_item(lct_tree, hf_toi64, tvb, offset+4, 8, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(lct_tree, hf_toi_extended, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 14:\r\nproto_tree_add_item(lct_tree, hf_toi64, tvb, offset+6, 8, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(lct_tree, hf_toi_extended, tvb, offset, 6, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (toi_size <= 8)\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "TOI: %" G_GINT64_MODIFIER "u", toi);\r\nelse\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "TOI: 0x%s", tvb_bytes_to_ep_str(tvb, offset, toi_size));\r\noffset += toi_size;\r\n}\r\nif (buffer16 & LCT_CLOSE_SESSION_FLAG)\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, " ", "Close session");\r\nif (buffer16 & LCT_CLOSE_OBJECT_FLAG)\r\ncol_append_sep_str(pinfo->cinfo, COL_INFO, " ", "Close object");\r\nif (buffer16 & LCT_SCT_FLAG) {\r\nlct_timestamp_parse(tvb_get_ntohl(tvb, offset), &tmp_time);\r\nproto_tree_add_time(lct_tree, hf_sct, tvb, offset, 4, &tmp_time);\r\noffset += 4;\r\n}\r\nif (buffer16 & LCT_ERT_FLAG) {\r\nlct_timestamp_parse(tvb_get_ntohl(tvb, offset), &tmp_time);\r\nproto_tree_add_time(lct_tree, hf_ert, tvb, offset, 4, &tmp_time);\r\noffset += 4;\r\n}\r\nlct_ext_decode(lct_tree, tvb, pinfo, offset, hlen, data_exchange, hf_ext, ett_ext);\r\nreturn hlen;\r\n}\r\nvoid\r\nproto_register_rmt_lct(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_version,\r\n{ "Version", "rmt-lct.version",\r\nFT_UINT16, BASE_DEC, NULL, 0xF000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fsize_header,\r\n{ "Field size flags", "rmt-lct.fsize",\r\nFT_UINT16, BASE_HEX, NULL, 0x0FD0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fsize_cci,\r\n{ "Congestion Control Information field size", "rmt-lct.fsize.cci",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fsize_tsi,\r\n{ "Transport Session Identifier field size", "rmt-lct.fsize.tsi",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fsize_toi,\r\n{ "Transport Object Identifier field size", "rmt-lct.fsize.toi",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_flags_header,\r\n{ "Flags", "rmt-lct.flags",\r\nFT_UINT16, BASE_HEX, NULL, 0x001F,\r\nNULL, HFILL }\r\n},\r\n{ &hf_flags_sct_present,\r\n{ "Sender Current Time present flag", "rmt-lct.flags.sct_present",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), LCT_SCT_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_flags_ert_present,\r\n{ "Expected Residual Time present flag", "rmt-lct.flags.ert_present",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), LCT_ERT_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_flags_close_session,\r\n{ "Close Session flag", "rmt-lct.flags.close_session",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), LCT_CLOSE_SESSION_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_flags_close_object,\r\n{ "Close Object flag", "rmt-lct.flags.close_object",\r\nFT_BOOLEAN, 16, TFS(&tfs_set_notset), LCT_CLOSE_OBJECT_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hlen,\r\n{ "Header length", "rmt-lct.hlen",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_codepoint,\r\n{ "Codepoint", "rmt-lct.codepoint",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cci,\r\n{ "Congestion Control Information", "rmt-lct.cci",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_tsi,\r\n{ "Transport Session Identifier", "rmt-lct.tsi",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_tsi16,\r\n{ "Transport Session Identifier", "rmt-lct.tsi",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_tsi32,\r\n{ "Transport Session Identifier", "rmt-lct.tsi",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_tsi48,\r\n{ "Transport Session Identifier", "rmt-lct.tsi",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_toi,\r\n{ "Transport Object Identifier", "rmt-lct.toi",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_toi16,\r\n{ "Transport Object Identifier", "rmt-lct.toi",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_toi32,\r\n{ "Transport Object Identifier", "rmt-lct.toi",\r\nFT_UINT32, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_toi48,\r\n{ "Transport Object Identifier", "rmt-lct.toi",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_toi64,\r\n{ "Transport Object Identifier (up to 64 bits)", "rmt-lct.toi",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_toi_extended,\r\n{ "Transport Object Identifier (bits 64-112)", "rmt-lct.toi_extended",\r\nFT_UINT64, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sct,\r\n{ "Sender Current Time", "rmt-lct.sct",\r\nFT_RELATIVE_TIME, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ert,\r\n{ "Expected Residual Time", "rmt-lct.ert",\r\nFT_RELATIVE_TIME, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_ext,\r\n{ "Extension count", "rmt-lct.ext",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hec_type,\r\n{ "Header Extension Type (HET)", "rmt-lct.hec.type",\r\nFT_UINT8, BASE_DEC, VALS(hec_type_vals), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hec_len,\r\n{ "Header Extension Length (HEL)", "rmt-lct.hec.len",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_hec_data,\r\n{ "Header Extension Data", "rmt-lct.hec.data",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_send_rate,\r\n{ "Send Rate", "rmt-lct.send_rate",\r\nFT_DOUBLE, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_cenc,\r\n{ "Content Encoding Algorithm (CENC)", "rmt-lct.cenc",\r\nFT_UINT8, BASE_DEC, NULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_flute_version,\r\n{ "FLUTE version (V)", "rmt-lct.flute_version",\r\nFT_UINT32, BASE_DEC, NULL, 0x00F00000,\r\nNULL, HFILL }\r\n},\r\n{ &hf_fdt_instance_id,\r\n{ "FDT Instance ID", "rmt-lct.fdt_instance_id",\r\nFT_UINT32, BASE_DEC, NULL, 0x000FFFFF,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_main,\r\n&ett_fsize,\r\n&ett_flags,\r\n&ett_ext,\r\n&ett_ext_ext\r\n};\r\nproto_rmt_lct = proto_register_protocol("Layered Coding Transport", "RMT-LCT", "rmt-lct");\r\nnew_register_dissector("rmt-lct", dissect_lct, proto_rmt_lct);\r\nproto_register_field_array(proto_rmt_lct, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}

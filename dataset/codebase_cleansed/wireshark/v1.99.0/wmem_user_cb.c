void\r\nwmem_call_callbacks(wmem_allocator_t *allocator, wmem_cb_event_t event)\r\n{\r\nwmem_user_cb_container_t **prev, *cur;\r\ngboolean again;\r\nprev = &(allocator->callbacks);\r\ncur = allocator->callbacks;\r\nwhile (cur) {\r\nagain = cur->cb(allocator, event, cur->user_data);\r\nif (! again || event == WMEM_CB_DESTROY_EVENT) {\r\n*prev = cur->next;\r\nwmem_free(NULL, cur);\r\ncur = *prev;\r\n}\r\nelse {\r\nprev = &(cur->next);\r\ncur = cur->next;\r\n}\r\n}\r\n}\r\nguint\r\nwmem_register_callback(wmem_allocator_t *allocator,\r\nwmem_user_cb_t callback, void *user_data)\r\n{\r\nwmem_user_cb_container_t *container;\r\nstatic guint next_id = 0;\r\ncontainer = wmem_new(NULL, wmem_user_cb_container_t);\r\ncontainer->cb = callback;\r\ncontainer->user_data = user_data;\r\ncontainer->next = allocator->callbacks;\r\ncontainer->id = next_id++;\r\nallocator->callbacks = container;\r\nreturn container->id;\r\n}\r\nvoid\r\nwmem_unregister_callback(wmem_allocator_t *allocator, guint id)\r\n{\r\nwmem_user_cb_container_t **prev, *cur;\r\nprev = &(allocator->callbacks);\r\ncur = allocator->callbacks;\r\nwhile (cur) {\r\nif (cur->id == id) {\r\n*prev = cur->next;\r\nwmem_free(NULL, cur);\r\nreturn;\r\n}\r\nprev = &(cur->next);\r\ncur = cur->next;\r\n}\r\n}

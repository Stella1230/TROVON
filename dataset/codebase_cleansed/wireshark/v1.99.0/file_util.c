int\r\nws_stdio_open (const gchar *filename,\r\nint flags,\r\nint mode)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nint retval;\r\nint save_errno;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nretval = _wopen (wfilename, flags, mode);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nint\r\nws_stdio_rename (const gchar *oldfilename,\r\nconst gchar *newfilename)\r\n{\r\nwchar_t *woldfilename = g_utf8_to_utf16 (oldfilename, -1, NULL, NULL, NULL);\r\nwchar_t *wnewfilename;\r\nint retval;\r\nint save_errno = 0;\r\nif (woldfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nwnewfilename = g_utf8_to_utf16 (newfilename, -1, NULL, NULL, NULL);\r\nif (wnewfilename == NULL)\r\n{\r\ng_free (woldfilename);\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nif (MoveFileExW (woldfilename, wnewfilename, MOVEFILE_REPLACE_EXISTING))\r\nretval = 0;\r\nelse\r\n{\r\nretval = -1;\r\nswitch (GetLastError ())\r\n{\r\n#define CASE(a,b) case ERROR_##a: save_errno = b; break\r\nCASE (FILE_NOT_FOUND, ENOENT);\r\nCASE (PATH_NOT_FOUND, ENOENT);\r\nCASE (ACCESS_DENIED, EACCES);\r\nCASE (NOT_SAME_DEVICE, EXDEV);\r\nCASE (LOCK_VIOLATION, EACCES);\r\nCASE (SHARING_VIOLATION, EACCES);\r\nCASE (FILE_EXISTS, EEXIST);\r\nCASE (ALREADY_EXISTS, EEXIST);\r\n#undef CASE\r\ndefault: save_errno = EIO;\r\n}\r\n}\r\ng_free (woldfilename);\r\ng_free (wnewfilename);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nint\r\nws_stdio_mkdir (const gchar *filename,\r\nint mode)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nint retval;\r\nint save_errno;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nretval = _wmkdir (wfilename);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nint\r\nws_stdio_stat64 (const gchar *filename,\r\nws_statb64 *buf)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nint retval;\r\nint save_errno;\r\nsize_t len;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nlen = wcslen (wfilename);\r\nwhile (len > 0 && G_IS_DIR_SEPARATOR (wfilename[len-1]))\r\nlen--;\r\nif (len > 0 &&\r\n(!g_path_is_absolute (filename) || len > (size_t) (g_path_skip_root (filename) - filename)))\r\nwfilename[len] = '\0';\r\nretval = _wstati64 (wfilename, buf);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nint\r\nws_stdio_unlink (const gchar *filename)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nint retval;\r\nint save_errno;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nretval = _wunlink (wfilename);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nint\r\nws_stdio_remove (const gchar *filename)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nint retval;\r\nint save_errno;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn -1;\r\n}\r\nretval = _wremove (wfilename);\r\nif (retval == -1)\r\nretval = _wrmdir (wfilename);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nFILE *\r\nws_stdio_fopen (const gchar *filename,\r\nconst gchar *mode)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nwchar_t *wmode;\r\nFILE *retval;\r\nint save_errno;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn NULL;\r\n}\r\nwmode = g_utf8_to_utf16 (mode, -1, NULL, NULL, NULL);\r\nif (wmode == NULL)\r\n{\r\ng_free (wfilename);\r\nerrno = EINVAL;\r\nreturn NULL;\r\n}\r\nretval = _wfopen (wfilename, wmode);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\ng_free (wmode);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nFILE *\r\nws_stdio_freopen (const gchar *filename,\r\nconst gchar *mode,\r\nFILE *stream)\r\n{\r\nwchar_t *wfilename = g_utf8_to_utf16 (filename, -1, NULL, NULL, NULL);\r\nwchar_t *wmode;\r\nFILE *retval;\r\nint save_errno;\r\nif (wfilename == NULL)\r\n{\r\nerrno = EINVAL;\r\nreturn NULL;\r\n}\r\nwmode = g_utf8_to_utf16 (mode, -1, NULL, NULL, NULL);\r\nif (wmode == NULL)\r\n{\r\ng_free (wfilename);\r\nerrno = EINVAL;\r\nreturn NULL;\r\n}\r\nretval = _wfreopen (wfilename, wmode, stream);\r\nsave_errno = errno;\r\ng_free (wfilename);\r\ng_free (wmode);\r\nerrno = save_errno;\r\nreturn retval;\r\n}\r\nstatic gboolean\r\ninit_dll_load_paths()\r\n{\r\nTCHAR path_w[MAX_PATH];\r\nif (program_path && system_path)\r\nreturn TRUE;\r\nif (GetModuleFileName(NULL, path_w, MAX_PATH) == 0 || GetLastError() == ERROR_INSUFFICIENT_BUFFER) {\r\nreturn FALSE;\r\n}\r\nif (!program_path) {\r\ngchar *app_path;\r\napp_path = g_utf16_to_utf8(path_w, -1, NULL, NULL, NULL);\r\nprogram_path = g_path_get_dirname(app_path);\r\ng_free(app_path);\r\n}\r\nif (GetSystemDirectory(path_w, MAX_PATH) == 0) {\r\nreturn FALSE;\r\n}\r\nif (!system_path) {\r\nsystem_path = g_utf16_to_utf8(path_w, -1, NULL, NULL, NULL);\r\n}\r\nif (program_path && system_path)\r\nreturn TRUE;\r\nreturn FALSE;\r\n}\r\ngboolean\r\nws_init_dll_search_path()\r\n{\r\ngboolean dll_dir_set = FALSE;\r\nwchar_t *program_path_w;\r\ntypedef BOOL (WINAPI *SetDllDirectoryHandler)(LPCTSTR);\r\nSetDllDirectoryHandler PSetDllDirectory;\r\nPSetDllDirectory = (SetDllDirectoryHandler) GetProcAddress(GetModuleHandle(_T("kernel32.dll")), "SetDllDirectoryW");\r\nif (PSetDllDirectory) {\r\ndll_dir_set = PSetDllDirectory(_T(""));\r\n}\r\nif (!dll_dir_set && init_dll_load_paths()) {\r\nprogram_path_w = g_utf8_to_utf16(program_path, -1, NULL, NULL, NULL);\r\nSetCurrentDirectory(program_path_w);\r\ng_free(program_path_w);\r\n}\r\nreturn dll_dir_set;\r\n}\r\nvoid *\r\nws_load_library(gchar *library_name)\r\n{\r\ngchar *full_path;\r\nwchar_t *full_path_w;\r\nHMODULE dll_h;\r\nif (!init_dll_load_paths() || !library_name)\r\nreturn NULL;\r\nfull_path = g_module_build_path(program_path, library_name);\r\nfull_path_w = g_utf8_to_utf16(full_path, -1, NULL, NULL, NULL);\r\nif (full_path && full_path_w) {\r\ndll_h = LoadLibraryW(full_path_w);\r\nif (dll_h) {\r\ng_free(full_path);\r\ng_free(full_path_w);\r\nreturn dll_h;\r\n}\r\n}\r\nfull_path = g_module_build_path(system_path, library_name);\r\nfull_path_w = g_utf8_to_utf16(full_path, -1, NULL, NULL, NULL);\r\nif (full_path && full_path_w) {\r\ndll_h = LoadLibraryW(full_path_w);\r\nif (dll_h) {\r\ng_free(full_path);\r\ng_free(full_path_w);\r\nreturn dll_h;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nGModule *\r\nws_module_open(gchar *module_name, GModuleFlags flags)\r\n{\r\ngchar *full_path;\r\nGModule *mod;\r\nif (!init_dll_load_paths() || !module_name)\r\nreturn NULL;\r\nfull_path = g_module_build_path(program_path, module_name);\r\nif (full_path) {\r\nmod = g_module_open(full_path, flags);\r\nif (mod) {\r\ng_free(full_path);\r\nreturn mod;\r\n}\r\n}\r\nfull_path = g_module_build_path(system_path, module_name);\r\nif (full_path) {\r\nmod = g_module_open(full_path, flags);\r\nif (mod) {\r\ng_free(full_path);\r\nreturn mod;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nchar *\r\ngetenv_utf8(const char *varname)\r\n{\r\nchar *envvar;\r\nwchar_t *envvarw;\r\nwchar_t *varnamew;\r\nenvvar = getenv(varname);\r\nvarnamew = g_utf8_to_utf16(varname, -1, NULL, NULL, NULL);\r\nif (varnamew == NULL) {\r\nreturn envvar;\r\n}\r\nenvvarw = _wgetenv(varnamew);\r\ng_free(varnamew);\r\nif (envvarw == NULL) {\r\nreturn envvar;\r\n}\r\nenvvar = g_utf16_to_utf8(envvarw, -1, NULL, NULL, NULL);\r\nreturn envvar;\r\n}\r\nvoid create_app_running_mutex() {\r\nSECURITY_ATTRIBUTES *sa = NULL;\r\nif (!sec_attributes_) sec_attributes_ = g_new0(SECURITY_ATTRIBUTES, 1);\r\nsec_attributes_->nLength = sizeof(SECURITY_ATTRIBUTES);\r\nsec_attributes_->lpSecurityDescriptor = g_new0(SECURITY_DESCRIPTOR, 1);\r\nsec_attributes_->bInheritHandle = TRUE;\r\nif (InitializeSecurityDescriptor(sec_attributes_->lpSecurityDescriptor, SECURITY_DESCRIPTOR_REVISION)) {\r\nif (SetSecurityDescriptorDacl(sec_attributes_->lpSecurityDescriptor, TRUE, NULL, FALSE)) {\r\nsa = sec_attributes_;\r\n}\r\n}\r\nif (!sa) {\r\ng_free(sec_attributes_->lpSecurityDescriptor);\r\ng_free(sec_attributes_);\r\nsec_attributes_ = NULL;\r\n}\r\nCreateMutex(sa, FALSE, _T("Wireshark-is-running-{") _T(WIRESHARK_IS_RUNNING_UUID) _T("}"));\r\nCreateMutex(sa, FALSE, _T("Global\\Wireshark-is-running-{") _T(WIRESHARK_IS_RUNNING_UUID) _T("}"));\r\n}

static void\r\nmpls_pm_dissect_counter(tvbuff_t *tvb, proto_tree *pm_tree,\r\nguint32 offset, gboolean query, gboolean bflag,\r\nguint8 i)\r\n{\r\nproto_item *ti;\r\nconst gchar *unit = bflag ? "octets" : "packets";\r\nif (query) {\r\nswitch (i) {\r\ncase 1:\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_counter1, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, " %s (A_Tx)", unit);\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_counter2, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_counter3, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_counter4, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else {\r\nswitch (i) {\r\ncase 1:\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_counter1, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, " %s (B_Tx)", unit);\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_counter2, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 3:\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_counter3, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, " %s (A_Tx)", unit);\r\nbreak;\r\ncase 4:\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_counter4, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nproto_item_append_text(ti, " %s (B_Rx)", unit);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void\r\nmpls_pm_dissect_timestamp(tvbuff_t *tvb, proto_tree *pm_tree,\r\nguint32 offset, guint8 qtf, guint8 rtf,\r\ngboolean query, guint8 i)\r\n{\r\nif (query) {\r\nswitch (i) {\r\ncase 1:\r\nswitch (qtf) {\r\ncase MPLS_PM_TSF_NULL:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp1_q_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_SEQ:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp1_q_seq, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_NTP:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp1_q_ntp, tvb,\r\noffset, 8, ENC_TIME_NTP|ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_PTP:\r\n{\r\nnstime_t ts;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset + 4);\r\nproto_tree_add_time(pm_tree, hf_mpls_pm_timestamp1_q_ptp,\r\ntvb, offset, 8, &ts);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp1_unk, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp2_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 3:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp3_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 4:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp4_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else {\r\nswitch (i) {\r\ncase 1:\r\nswitch (rtf) {\r\ncase MPLS_PM_TSF_NULL:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp1_r_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_SEQ:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp1_r_seq, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_NTP:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp1_r_ntp, tvb,\r\noffset, 8, ENC_TIME_NTP|ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_PTP:\r\n{\r\nnstime_t ts;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset + 4);\r\nproto_tree_add_time(pm_tree, hf_mpls_pm_timestamp1_r_ptp,\r\ntvb, offset, 8, &ts);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp1_unk, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\nbreak;\r\ncase 2:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp2_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase 3:\r\nswitch (rtf) {\r\ncase MPLS_PM_TSF_NULL:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp3_r_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_SEQ:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp3_r_seq, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_NTP:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp3_r_ntp, tvb,\r\noffset, 8, ENC_TIME_NTP|ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_PTP:\r\n{\r\nnstime_t ts;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset + 4);\r\nproto_tree_add_time(pm_tree, hf_mpls_pm_timestamp3_r_ptp,\r\ntvb, offset, 8, &ts);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp3_unk, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\nbreak;\r\ncase 4:\r\nswitch (rtf) {\r\ncase MPLS_PM_TSF_NULL:\r\nproto_tree_add_item(pm_tree,\r\nhf_mpls_pm_timestamp4_r_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_SEQ:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp4_r_seq, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_NTP:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp4_r_ntp, tvb,\r\noffset, 8, ENC_TIME_NTP|ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_PTP:\r\n{\r\nnstime_t ts;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset + 4);\r\nproto_tree_add_time(pm_tree, hf_mpls_pm_timestamp4_r_ptp,\r\ntvb, offset, 8, &ts);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_timestamp4_unk, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void\r\nmpls_pm_build_cinfo(tvbuff_t *tvb, packet_info *pinfo, const char *str_pmt,\r\ngboolean *query, gboolean *response,\r\ngboolean *class_specific,\r\nguint32 *sid, guint8 *code)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_PROTOCOL, "MPLS PM (%s)", str_pmt);\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\n*response = (tvb_get_guint8(tvb, 0) & 0x08) ? TRUE : FALSE;\r\n*class_specific = (tvb_get_guint8(tvb, 0) & 0x04) ? TRUE : FALSE;\r\n*query = !(*response);\r\n*code = tvb_get_guint8(tvb, 1);\r\nif (!(*class_specific)) {\r\n*sid = tvb_get_ntohl(tvb, 8);\r\n} else {\r\n*sid = tvb_get_ntohl(tvb, 8) >> 6;\r\n}\r\nif (*query) {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"Query, sid: %u", *sid);\r\n} else {\r\ncol_add_fstr(pinfo->cinfo, COL_INFO,\r\n"Response, sid: %u, code: %s (%u)",\r\n*sid,\r\nrval_to_str(*code,\r\nmpls_pm_response_ctrl_code_rvals,\r\n"Unknown"),\r\n*code);\r\n}\r\n}\r\nstatic void\r\ndissect_mpls_pm_loss(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 pmt)\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *pm_tree;\r\nproto_tree *pm_tree_flags;\r\nproto_tree *pm_tree_dflags;\r\nguint32 offset = 0;\r\ngboolean query = 0;\r\ngboolean response = 0;\r\ngboolean class_specific = 0;\r\nguint32 sid = 0;\r\nguint8 code = 0;\r\nguint8 otf;\r\ngboolean bflag;\r\nguint8 i;\r\nmpls_pm_build_cinfo(tvb, pinfo,\r\nval_to_str_const(pmt, pmt_vals, ""),\r\n&query, &response, &class_specific, &sid, &code);\r\nif (!tree) {\r\nreturn;\r\n}\r\nif (pmt == DLM) {\r\nti = proto_tree_add_item(tree, proto_mpls_pm_dlm, tvb, 0, -1, ENC_NA);\r\n} else {\r\nti = proto_tree_add_item(tree, proto_mpls_pm_ilm, tvb, 0, -1, ENC_NA);\r\n}\r\npm_tree = proto_item_add_subtree(ti, ett_mpls_pm);\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_version, tvb, offset, 1, ENC_NA);\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_flags, tvb,\r\noffset, 1, ENC_NA);\r\npm_tree_flags = proto_item_add_subtree(ti, ett_mpls_pm_flags);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_r, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_t, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_res, tvb,\r\noffset, 1, ENC_NA);\r\noffset += 1;\r\nif (query) {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_query_ctrl_code,\r\ntvb, offset, 1, ENC_NA);\r\n} else {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_response_ctrl_code,\r\ntvb, offset, 1, ENC_NA);\r\n}\r\noffset += 1;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_length, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_dflags, tvb,\r\noffset, 1, ENC_NA);\r\npm_tree_dflags = proto_item_add_subtree(ti, ett_mpls_pm_dflags);\r\nproto_tree_add_item(pm_tree_dflags, hf_mpls_pm_dflags_x, tvb,\r\noffset, 1, ENC_NA);\r\nbflag = (tvb_get_guint8(tvb, offset) & 0x40) ? TRUE : FALSE;\r\nproto_tree_add_item(pm_tree_dflags, hf_mpls_pm_dflags_b, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_dflags, hf_mpls_pm_dflags_res, tvb,\r\noffset, 1, ENC_NA);\r\notf = tvb_get_guint8(tvb, offset) & 0x0F;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_otf, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 3;\r\nproto_tree_add_uint(pm_tree, hf_mpls_pm_session_id, tvb, offset, 4, sid);\r\nif (class_specific) {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_ds, tvb, offset + 3, 1, ENC_NA);\r\n}\r\noffset += 4;\r\nswitch (otf) {\r\ncase MPLS_PM_TSF_NULL:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_origin_timestamp_null, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_SEQ:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_origin_timestamp_seq, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_NTP:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_origin_timestamp_ntp, tvb,\r\noffset, 8, ENC_TIME_NTP|ENC_BIG_ENDIAN);\r\nbreak;\r\ncase MPLS_PM_TSF_PTP:\r\n{\r\nnstime_t ts;\r\nts.secs = tvb_get_ntohl(tvb, offset);\r\nts.nsecs = tvb_get_ntohl(tvb, offset + 4);\r\nproto_tree_add_time(pm_tree, hf_mpls_pm_origin_timestamp_ptp, tvb,\r\noffset, 8, &ts);\r\n}\r\nbreak;\r\ndefault:\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_origin_timestamp_unk, tvb,\r\noffset, 8, ENC_BIG_ENDIAN);\r\nbreak;\r\n}\r\noffset += 8;\r\nfor (i = 1; i <= 4; i++) {\r\nmpls_pm_dissect_counter(tvb, pm_tree, offset, query, bflag, i);\r\noffset += 8;\r\n}\r\n}\r\nstatic void\r\ndissect_mpls_pm_dlm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\ndissect_mpls_pm_loss(tvb, pinfo, tree, DLM);\r\n}\r\nstatic void\r\ndissect_mpls_pm_ilm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\ndissect_mpls_pm_loss(tvb, pinfo, tree, ILM);\r\n}\r\nstatic void\r\ndissect_mpls_pm_delay(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *ti;\r\nproto_tree *pm_tree;\r\nproto_tree *pm_tree_flags;\r\nguint32 offset = 0;\r\ngboolean query = 0;\r\ngboolean response = 0;\r\ngboolean class_specific = 0;\r\nguint32 sid = 0;\r\nguint8 code = 0;\r\nguint8 qtf;\r\nguint8 rtf;\r\nguint8 i;\r\nmpls_pm_build_cinfo(tvb, pinfo,\r\n"DM",\r\n&query, &response, &class_specific, &sid, &code);\r\nif (!tree) {\r\nreturn;\r\n}\r\nti = proto_tree_add_item(tree, proto_mpls_pm_dm, tvb, 0, -1, ENC_NA);\r\npm_tree = proto_item_add_subtree(ti, ett_mpls_pm);\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_version, tvb, offset, 1, ENC_NA);\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_flags, tvb, offset, 1, ENC_NA);\r\npm_tree_flags = proto_item_add_subtree(ti, ett_mpls_pm_flags);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_r, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_t, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_res, tvb,\r\noffset, 1, ENC_NA);\r\noffset += 1;\r\nif (query) {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_query_ctrl_code,\r\ntvb, offset, 1, ENC_NA);\r\n} else {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_response_ctrl_code,\r\ntvb, offset, 1, ENC_NA);\r\n}\r\noffset += 1;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_length, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nqtf = (tvb_get_guint8(tvb, offset) & 0xF0) >> 4;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_qtf, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\nrtf = tvb_get_guint8(tvb, offset) & 0x0F;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_rtf, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_rptf, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 3;\r\nproto_tree_add_uint(pm_tree, hf_mpls_pm_session_id, tvb, offset, 4, sid);\r\nif (class_specific) {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_ds, tvb, offset + 3, 1, ENC_NA);\r\n}\r\noffset += 4;\r\nfor (i = 1; i <= 4; i++) {\r\nmpls_pm_dissect_timestamp(tvb, pm_tree, offset, qtf, rtf, query, i);\r\noffset += 8;\r\n}\r\n}\r\nstatic void\r\ndissect_mpls_pm_combined(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree,\r\nguint8 pmt)\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *pm_tree;\r\nproto_tree *pm_tree_flags;\r\nproto_tree *pm_tree_dflags;\r\nguint32 offset = 0;\r\ngboolean query = 0;\r\ngboolean response = 0;\r\ngboolean class_specific = 0;\r\nguint32 sid = 0;\r\nguint8 code = 0;\r\nguint8 qtf;\r\nguint8 rtf;\r\ngboolean bflag;\r\nguint8 i;\r\nmpls_pm_build_cinfo(tvb, pinfo,\r\nval_to_str_const(pmt, pmt_vals, ""),\r\n&query, &response, &class_specific, &sid, &code);\r\nif (!tree) {\r\nreturn;\r\n}\r\nif (pmt == DLMDM) {\r\nti = proto_tree_add_item(tree, proto_mpls_pm_dlm_dm,\r\ntvb, 0, -1, ENC_NA);\r\n} else {\r\nti = proto_tree_add_item(tree, proto_mpls_pm_ilm_dm,\r\ntvb, 0, -1, ENC_NA);\r\n}\r\npm_tree = proto_item_add_subtree(ti, ett_mpls_pm);\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_version, tvb, offset, 1, ENC_NA);\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_flags, tvb, offset, 1, ENC_NA);\r\npm_tree_flags = proto_item_add_subtree(ti, ett_mpls_pm_flags);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_r, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_t, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_flags, hf_mpls_pm_flags_res, tvb,\r\noffset, 1, ENC_NA);\r\noffset += 1;\r\nif (query) {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_query_ctrl_code,\r\ntvb, offset, 1, ENC_NA);\r\n} else {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_response_ctrl_code,\r\ntvb, offset, 1, ENC_NA);\r\n}\r\noffset += 1;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_length, tvb,\r\noffset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nti = proto_tree_add_item(pm_tree, hf_mpls_pm_dflags, tvb,\r\noffset, 1, ENC_NA);\r\npm_tree_dflags = proto_item_add_subtree(ti, ett_mpls_pm_dflags);\r\nproto_tree_add_item(pm_tree_dflags, hf_mpls_pm_dflags_x, tvb,\r\noffset, 1, ENC_NA);\r\nbflag = (tvb_get_guint8(tvb, offset) & 0x40) ? TRUE : FALSE;\r\nproto_tree_add_item(pm_tree_dflags, hf_mpls_pm_dflags_b, tvb,\r\noffset, 1, ENC_NA);\r\nproto_tree_add_item(pm_tree_dflags, hf_mpls_pm_dflags_res, tvb,\r\noffset, 1, ENC_NA);\r\nqtf = tvb_get_guint8(tvb, offset) & 0x0F;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_qtf_combined, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nrtf = tvb_get_guint8(tvb, offset) & 0xF0 >> 4;\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_rtf_combined, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_rptf_combined, tvb,\r\noffset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\noffset += 2;\r\nproto_tree_add_uint(pm_tree, hf_mpls_pm_session_id, tvb, offset, 4, sid);\r\nif (class_specific) {\r\nproto_tree_add_item(pm_tree, hf_mpls_pm_ds, tvb, offset + 3, 1, ENC_NA);\r\n}\r\noffset += 4;\r\nfor (i = 1; i <= 4; i++) {\r\nmpls_pm_dissect_timestamp(tvb, pm_tree, offset, qtf, rtf, query, i);\r\noffset += 8;\r\n}\r\nfor (i = 1; i <= 4; i++) {\r\nmpls_pm_dissect_counter(tvb, pm_tree, offset, query, bflag, i);\r\noffset += 8;\r\n}\r\n}\r\nstatic void\r\ndissect_mpls_pm_dlm_dm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\ndissect_mpls_pm_combined(tvb, pinfo, tree, DLMDM);\r\n}\r\nstatic void\r\ndissect_mpls_pm_ilm_dm(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\ndissect_mpls_pm_combined(tvb, pinfo, tree, ILMDM);\r\n}\r\nvoid\r\nproto_register_mpls_pm(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{\r\n&hf_mpls_pm_version,\r\n{\r\n"Version", "mpls_pm.version", FT_UINT8, BASE_DEC, NULL,\r\n0xF0, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_flags,\r\n{\r\n"Flags", "mpls_pm.flags", FT_UINT8,\r\nBASE_HEX, NULL, MPLS_PM_FLAGS_MASK, NULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_flags_r,\r\n{\r\n"Response indicator (R)", "mpls_pm.flags.r",\r\nFT_BOOLEAN, 4, TFS(&tfs_set_notset), MPLS_PM_FLAGS_R,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_flags_t,\r\n{\r\n"Traffic-class-specific measurement indicator (T)",\r\n"mpls_pm.flags.t",\r\nFT_BOOLEAN, 4, TFS(&tfs_set_notset), MPLS_PM_FLAGS_T,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_flags_res,\r\n{\r\n"Reserved",\r\n"mpls_pm.flags.res",\r\nFT_BOOLEAN, 4, TFS(&tfs_set_notset), MPLS_PM_FLAGS_RES,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_query_ctrl_code,\r\n{\r\n"Control Code",\r\n"mpls_pm.ctrl.code",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_HEX,\r\nRVALS(mpls_pm_query_ctrl_code_rvals), 0x0,\r\n"Code identifying the query type", HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_response_ctrl_code,\r\n{\r\n"Control Code",\r\n"mpls_pm.ctrl.code",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_HEX,\r\nRVALS(mpls_pm_response_ctrl_code_rvals), 0x0,\r\n"Code identifying the response type", HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_length,\r\n{\r\n"Message Length",\r\n"mpls_pm.length",\r\nFT_UINT16, BASE_DEC, NULL, 0x0,\r\n"Total length of this message in bytes", HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_dflags,\r\n{\r\n"DFlags", "mpls_pm.dflags", FT_UINT8,\r\nBASE_HEX, NULL, MPLS_PM_DFLAGS_MASK,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_dflags_x,\r\n{\r\n"Extended counter format indicator (X)", "mpls_pm.dflags.x",\r\nFT_BOOLEAN, 4, TFS(&tfs_set_notset), MPLS_PM_DFLAGS_X,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_dflags_b,\r\n{\r\n"Octet/Byte count indicator (B)", "mpls_pm.dflags.b",\r\nFT_BOOLEAN, 4, TFS(&tfs_set_notset), MPLS_PM_DFLAGS_B,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_dflags_res,\r\n{\r\n"Reserved",\r\n"mpls_pm.dflags.res",\r\nFT_BOOLEAN, 4, NULL, MPLS_PM_DFLAGS_RES,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_otf,\r\n{\r\n"Origin Timestamp Format (OTF)",\r\n"mpls_pm.otf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0x0F,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_session_id,\r\n{\r\n"Session Identifier",\r\n"mpls_pm.session.id",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_ds,\r\n{\r\n"Differentiated Services Codepoint",\r\n"mpls_pm.ds",\r\nFT_UINT8, BASE_DEC | BASE_EXT_STRING,\r\n&dscp_vals_ext, 0x3F,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_origin_timestamp_null,\r\n{\r\n"Origin Timestamp",\r\n"mpls_pm.origin.timestamp.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_origin_timestamp_seq,\r\n{\r\n"Origin Timestamp",\r\n"mpls_pm.origin.timestamp.seq",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_origin_timestamp_ntp,\r\n{\r\n"Origin Timestamp",\r\n"mpls_pm.origin.timestamp.ntp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_origin_timestamp_ptp,\r\n{\r\n"Origin Timestamp",\r\n"mpls_pm.origin.timestamp.ptp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_origin_timestamp_unk,\r\n{\r\n"Origin Timestamp (Unknown Type)",\r\n"mpls_pm.origin.timestamp.unk",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_counter1,\r\n{\r\n"Counter 1",\r\n"mpls_pm.counter1",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_counter2,\r\n{\r\n"Counter 2",\r\n"mpls_pm.counter2",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_counter3,\r\n{\r\n"Counter 3",\r\n"mpls_pm.counter3",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_counter4,\r\n{\r\n"Counter 4",\r\n"mpls_pm.counter4",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_qtf,\r\n{\r\n"Querier timestamp format (QTF)",\r\n"mpls_pm.qtf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0xF0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_qtf_combined,\r\n{\r\n"Querier timestamp format (QTF)",\r\n"mpls_pm.qtf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0x0F,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_rtf,\r\n{\r\n"Responder timestamp format (RTF)",\r\n"mpls_pm.rtf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0x0F,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_rtf_combined,\r\n{\r\n"Responder timestamp format (RTF)",\r\n"mpls_pm.rtf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0xF0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_rptf,\r\n{\r\n"Responder's preferred timestamp format (RPTF)",\r\n"mpls_pm.rptf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0xF0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_rptf_combined,\r\n{\r\n"Responder's preferred timestamp format (RPTF)",\r\n"mpls_pm.rptf",\r\nFT_UINT8, BASE_RANGE_STRING | BASE_DEC,\r\nRVALS(mpls_pm_time_stamp_format_rvals), 0x0F,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_q_null,\r\n{\r\n"Timestamp 1 (T1)",\r\n"mpls_pm.timestamp1.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_r_null,\r\n{\r\n"Timestamp 1 (T3)",\r\n"mpls_pm.timestamp1.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_q_seq,\r\n{\r\n"Timestamp 1 (T1)",\r\n"mpls_pm.timestamp1.seq",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_r_seq,\r\n{\r\n"Timestamp 1 (T3)",\r\n"mpls_pm.timestamp1.seq",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_q_ntp,\r\n{\r\n"Timestamp 1 (T1)",\r\n"mpls_pm.timestamp1.ntp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_r_ntp,\r\n{\r\n"Timestamp 1 (T3)",\r\n"mpls_pm.timestamp1.ntp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_q_ptp,\r\n{\r\n"Timestamp 1 (T1)",\r\n"mpls_pm.timestamp1.ptp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_r_ptp,\r\n{\r\n"Timestamp 1 (T3)",\r\n"mpls_pm.timestamp1.ptp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp1_unk,\r\n{\r\n"Timestamp 1 (Unknown Type)",\r\n"mpls_pm.timestamp1.unk",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp2_null,\r\n{\r\n"Timestamp 2",\r\n"mpls_pm.timestamp2.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp3_null,\r\n{\r\n"Timestamp 3",\r\n"mpls_pm.timestamp3.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp3_r_null,\r\n{\r\n"Timestamp 3 (T1)",\r\n"mpls_pm.timestamp3.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp3_r_seq,\r\n{\r\n"Timestamp 3 (T1)",\r\n"mpls_pm.timestamp3.seq",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp3_r_ntp,\r\n{\r\n"Timestamp 3 (T1)",\r\n"mpls_pm.timestamp3.ntp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp3_r_ptp,\r\n{\r\n"Timestamp 3 (T1)",\r\n"mpls_pm.timestamp3_ptp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp3_unk,\r\n{\r\n"Timestamp 3 (Unknown Type)",\r\n"mpls_pm.timestamp3.unk",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp4_null,\r\n{\r\n"Timestamp 4",\r\n"mpls_pm.timestamp4.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp4_r_null,\r\n{\r\n"Timestamp 4 (T2)",\r\n"mpls_pm.timestamp4.null",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp4_r_seq,\r\n{\r\n"Timestamp 4 (T2)",\r\n"mpls_pm.timestamp4.seq",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp4_r_ntp,\r\n{\r\n"Timestamp 4 (T2)",\r\n"mpls_pm.timestamp4.ntp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp4_r_ptp,\r\n{\r\n"Timestamp 4 (T2)",\r\n"mpls_pm.timestamp4.ptp",\r\nFT_RELATIVE_TIME, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n{\r\n&hf_mpls_pm_timestamp4_unk,\r\n{\r\n"Timestamp 4 (Unknown Type)",\r\n"mpls_pm.timestamp4.unk",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_mpls_pm,\r\n&ett_mpls_pm_flags,\r\n&ett_mpls_pm_dflags\r\n};\r\nproto_mpls_pm_dlm =\r\nproto_register_protocol("MPLS Direct Loss Measurement (DLM)",\r\n"MPLS Direct Loss Measurement (DLM)",\r\n"mplspmdlm");\r\nproto_mpls_pm_ilm =\r\nproto_register_protocol("MPLS Inferred Loss Measurement (ILM)",\r\n"MPLS Inferred Loss Measurement (ILM)",\r\n"mplspmilm");\r\nproto_mpls_pm_dm =\r\nproto_register_protocol("MPLS Delay Measurement (DM)",\r\n"MPLS Delay Measurement (DM)",\r\n"mplspmdm");\r\nproto_mpls_pm_dlm_dm =\r\nproto_register_protocol("MPLS Direct Loss and Delay "\r\n"Measurement (DLM+DM)",\r\n"MPLS Direct Loss and Delay "\r\n"Measurement (DLM+DM)",\r\n"mplspmdlmdm");\r\nproto_mpls_pm_ilm_dm =\r\nproto_register_protocol("MPLS Inferred Loss and Delay "\r\n"Measurement (ILM+DM)",\r\n"MPLS Inferred Loss and Delay "\r\n"Measurement (ILM+DM)",\r\n"mplspmilmdm");\r\nproto_register_field_array(proto_mpls_pm_dlm, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nregister_dissector("mpls_pm_dlm", dissect_mpls_pm_dlm,\r\nproto_mpls_pm_dlm);\r\nregister_dissector("mpls_pm_ilm", dissect_mpls_pm_ilm,\r\nproto_mpls_pm_ilm);\r\nregister_dissector("mpls_pm_dm", dissect_mpls_pm_delay,\r\nproto_mpls_pm_dm);\r\nregister_dissector("mpls_pm_dlm_dm", dissect_mpls_pm_dlm_dm,\r\nproto_mpls_pm_dlm_dm);\r\nregister_dissector("mpls_pm_ilm_dm", dissect_mpls_pm_ilm_dm,\r\nproto_mpls_pm_ilm_dm);\r\n}\r\nvoid\r\nproto_reg_handoff_mpls_pm(void)\r\n{\r\nmpls_pm_dlm_handle = find_dissector("mpls_pm_dlm");\r\nmpls_pm_ilm_handle = find_dissector("mpls_pm_ilm");\r\nmpls_pm_dm_handle = find_dissector("mpls_pm_dm");\r\nmpls_pm_dlm_dm_handle = find_dissector("mpls_pm_dlm_dm");\r\nmpls_pm_ilm_dm_handle = find_dissector("mpls_pm_ilm_dm");\r\n}

gboolean u3_active(void)\r\n{\r\nreturn (\r\n#ifdef _WIN32\r\ngetenv_utf8\r\n#else\r\ngetenv\r\n#endif\r\n("U3_HOST_EXEC_PATH") != NULL);\r\n}\r\nvoid u3_runtime_info(GString *str)\r\n{\r\nchar *u3devicepath_lcl = NULL;\r\nchar *u3deviceproduct = NULL;\r\nif((u3deviceproduct =\r\n#ifdef _WIN32\r\ngetenv_utf8\r\n#else\r\ngetenv\r\n#endif\r\n("U3_DEVICE_PRODUCT")) != NULL) {\r\ng_string_append(str, " from the ");\r\ng_string_append(str, u3deviceproduct);\r\n} else {\r\ng_string_append(str, " from a ");\r\n}\r\ng_string_append(str, " U3 device");\r\nif((u3devicepath_lcl =\r\n#ifdef _WIN32\r\ngetenv_utf8\r\n#else\r\ngetenv\r\n#endif\r\n("U3_DEVICE_PATH")) != NULL) {\r\ng_string_append(str, " in drive ");\r\ng_string_append(str, u3devicepath_lcl);\r\n}\r\n}\r\nvoid u3_register_pid(void)\r\n{\r\nint pid;\r\nint pid_fd;\r\nchar *u3hostexecpath;\r\nint pf_size;\r\nif((u3hostexecpath =\r\n#ifdef _WIN32\r\ngetenv_utf8\r\n#else\r\ngetenv\r\n#endif\r\n("U3_HOST_EXEC_PATH")) != NULL) {\r\npid = getpid();\r\npf_size = (int) strlen(u3hostexecpath) + 32;\r\npid_file = (char *)g_malloc(pf_size);\r\ng_snprintf(pid_file, pf_size, "%s\\%d.pid", u3hostexecpath, pid);\r\npid_fd = ws_open(pid_file, O_WRONLY | O_CREAT | O_TRUNC | O_BINARY, 0644);\r\nif(pid_fd != -1)\r\nws_close(pid_fd);\r\nelse {\r\ng_free(pid_file);\r\npid_file = NULL;\r\n}\r\n}\r\n}\r\nvoid u3_deregister_pid(void)\r\n{\r\nif(pid_file) {\r\nws_unlink(pid_file);\r\ng_free(pid_file);\r\npid_file = NULL;\r\n}\r\n}\r\nconst char *u3_expand_device_path(const char *path)\r\n{\r\nreturn u3_change_path(path, U3_DEVICE_PATH_VAR, NULL);\r\n}\r\nconst char *u3_contract_device_path(char *path)\r\n{\r\nreturn u3_change_path(path, NULL, U3_DEVICE_PATH_VAR);\r\n}\r\nstatic const char *u3_change_path(const char *path, const char *old, const char *new_u3devicepath)\r\n{\r\nif(u3devicepath == (char*)-1) {\r\nu3devicepath =\r\n#ifdef _WIN32\r\ngetenv_utf8\r\n#else\r\ngetenv\r\n#endif\r\n("U3_DEVICE_PATH");\r\n}\r\nif(new_u3devicepath == NULL)\r\nnew_u3devicepath = u3devicepath;\r\nif(old == NULL)\r\nold = u3devicepath;\r\nif(newpath != NULL) {\r\ng_free(newpath);\r\nnewpath = NULL;\r\n}\r\nif((path != NULL) && (u3devicepath != NULL) && (strncmp(path, old, strlen(old)) == 0)) {\r\nnewpath = g_strconcat(new_u3devicepath, path + strlen(old), NULL);\r\nreturn newpath;\r\n}\r\nreturn path;\r\n}

exp_pdu_data_t *\r\nload_export_pdu_tags(packet_info *pinfo, const char* proto_name, int wtap_encap _U_,\r\nguint8 *wanted_exp_tags, guint16 wanted_exp_tags_len)\r\n{\r\nexp_pdu_data_t *exp_pdu_data;\r\nint tag_buf_size = 0;\r\nint str_len = 0;\r\nint tag_str_len = 0;\r\nint i = 0;\r\ngboolean port_type_defined = FALSE;\r\nexp_pdu_data = (exp_pdu_data_t *)g_malloc(sizeof(exp_pdu_data_t));\r\nif(proto_name){\r\nstr_len = (int)strlen(proto_name);\r\ntag_str_len = (str_len + 3) & 0xfffffffc;\r\ntag_buf_size = tag_str_len + 4;\r\n}\r\nif (wanted_exp_tags_len >= 1) {\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_IP_SRC_BIT) == EXP_PDU_TAG_IP_SRC_BIT){\r\nif(pinfo->net_src.type == AT_IPv4){\r\ntag_buf_size += 4 + EXP_PDU_TAG_IPV4_SRC_LEN;\r\n}else if(pinfo->net_src.type == AT_IPv6){\r\ntag_buf_size += 4 + EXP_PDU_TAG_IPV6_SRC_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_IP_DST_BIT) == EXP_PDU_TAG_IP_DST_BIT){\r\nif(pinfo->net_dst.type == AT_IPv4){\r\ntag_buf_size += 4 + EXP_PDU_TAG_IPV4_DST_LEN;\r\n}else if(pinfo->net_dst.type == AT_IPv6){\r\ntag_buf_size += 4 + EXP_PDU_TAG_IPV6_DST_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_SRC_PORT_BIT) == EXP_PDU_TAG_SRC_PORT_BIT){\r\nif (!port_type_defined) {\r\ntag_buf_size= tag_buf_size + EXP_PDU_TAG_PORT_TYPE_LEN + 4;\r\nport_type_defined = TRUE;\r\n}\r\ntag_buf_size= tag_buf_size + EXP_PDU_TAG_SRC_PORT_LEN + 4;\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_DST_PORT_BIT) == EXP_PDU_TAG_DST_PORT_BIT){\r\nif (!port_type_defined) {\r\ntag_buf_size= tag_buf_size + EXP_PDU_TAG_PORT_TYPE_LEN + 4;\r\n}\r\ntag_buf_size= tag_buf_size + EXP_PDU_TAG_DST_PORT_LEN + 4;\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_SS7_OPC_BIT) == EXP_PDU_TAG_SS7_OPC_BIT){\r\nif(pinfo->src.type == AT_SS7PC){\r\ntag_buf_size += 4 + EXP_PDU_TAG_SS7_OPC_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_SS7_DPC_BIT) == EXP_PDU_TAG_SS7_DPC_BIT){\r\nif(pinfo->dst.type == AT_SS7PC){\r\ntag_buf_size += 4 + EXP_PDU_TAG_SS7_DPC_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_ORIG_FNO_BIT) == EXP_PDU_TAG_ORIG_FNO_BIT){\r\ntag_buf_size= tag_buf_size + EXP_PDU_TAG_ORIG_FNO_LEN + 4;\r\n}\r\n}\r\nif (wanted_exp_tags_len >= 2) {\r\nif((wanted_exp_tags[1] & EXP_PDU_TAG_DVBCI_EVT_BIT) == EXP_PDU_TAG_DVBCI_EVT_BIT){\r\ntag_buf_size= tag_buf_size + EXP_PDU_TAG_DVBCI_EVT_LEN + 4;\r\n}\r\n}\r\ntag_buf_size+=4;\r\nexp_pdu_data->tlv_buffer = (guint8 *)g_malloc0(tag_buf_size);\r\nexp_pdu_data->tlv_buffer_len = tag_buf_size;\r\nport_type_defined = FALSE;\r\nif(proto_name){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_PROTO_NAME;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = tag_str_len;\r\ni++;\r\nmemcpy(exp_pdu_data->tlv_buffer+i, proto_name, str_len);\r\ni = i + tag_str_len;\r\n}\r\nif (wanted_exp_tags_len >= 1) {\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_IP_SRC_BIT) == EXP_PDU_TAG_IP_SRC_BIT){\r\nif(pinfo->net_src.type == AT_IPv4){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV4_SRC;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV4_SRC_LEN;\r\ni++;\r\nmemcpy(exp_pdu_data->tlv_buffer+i, pinfo->net_src.data, EXP_PDU_TAG_IPV4_SRC_LEN);\r\ni += EXP_PDU_TAG_IPV4_SRC_LEN;\r\n}else if(pinfo->net_src.type == AT_IPv6){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV6_SRC;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV6_SRC_LEN;\r\ni++;\r\nmemcpy(exp_pdu_data->tlv_buffer+i, pinfo->net_src.data, EXP_PDU_TAG_IPV6_SRC_LEN);\r\ni += EXP_PDU_TAG_IPV6_SRC_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_IP_DST_BIT) == EXP_PDU_TAG_IP_DST_BIT){\r\nif(pinfo->net_dst.type == AT_IPv4){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV4_DST;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV4_DST_LEN;\r\ni++;\r\nmemcpy(exp_pdu_data->tlv_buffer+i, pinfo->net_dst.data, EXP_PDU_TAG_IPV4_DST_LEN);\r\ni += EXP_PDU_TAG_IPV4_DST_LEN;\r\n}else if(pinfo->net_dst.type == AT_IPv6){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV6_DST;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_IPV6_DST_LEN;\r\ni++;\r\nmemcpy(exp_pdu_data->tlv_buffer+i, pinfo->net_dst.data, EXP_PDU_TAG_IPV6_DST_LEN);\r\ni += EXP_PDU_TAG_IPV6_DST_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_SRC_PORT_BIT) == EXP_PDU_TAG_SRC_PORT_BIT){\r\nif (!port_type_defined) {\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_PORT_TYPE;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_PORT_TYPE_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (pinfo->ptype & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (pinfo->ptype & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (pinfo->ptype & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (pinfo->ptype & 0x000000ff);\r\ni = i +EXP_PDU_TAG_PORT_TYPE_LEN;\r\nport_type_defined = TRUE;\r\n}\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_SRC_PORT;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_SRC_PORT_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (pinfo->srcport & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (pinfo->srcport & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (pinfo->srcport & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (pinfo->srcport & 0x000000ff);\r\ni = i +EXP_PDU_TAG_SRC_PORT_LEN;\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_DST_PORT_BIT) == EXP_PDU_TAG_DST_PORT_BIT){\r\nif (!port_type_defined) {\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_PORT_TYPE;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_PORT_TYPE_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (pinfo->ptype & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (pinfo->ptype & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (pinfo->ptype & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (pinfo->ptype & 0x000000ff);\r\ni = i +EXP_PDU_TAG_PORT_TYPE_LEN;\r\n}\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_DST_PORT;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_DST_PORT_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (pinfo->destport & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (pinfo->destport & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (pinfo->destport & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (pinfo->destport & 0x000000ff);\r\ni = i +EXP_PDU_TAG_DST_PORT_LEN;\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_SS7_OPC_BIT) == EXP_PDU_TAG_SS7_OPC_BIT){\r\nif(pinfo->src.type == AT_SS7PC){\r\nconst mtp3_addr_pc_t *mtp3_addr = (const mtp3_addr_pc_t *)(pinfo->src.data);\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_SS7_OPC;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_SS7_OPC_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (mtp3_addr->pc & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (mtp3_addr->pc & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (mtp3_addr->pc & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (mtp3_addr->pc & 0x000000ff);\r\nexp_pdu_data->tlv_buffer[i+4] = (mtp3_addr->type & 0xff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+5] = (mtp3_addr->type & 0x00ff);\r\nexp_pdu_data->tlv_buffer[i+6] = mtp3_addr->ni;\r\ni += EXP_PDU_TAG_SS7_OPC_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_SS7_DPC_BIT) == EXP_PDU_TAG_SS7_DPC_BIT){\r\nif(pinfo->dst.type == AT_SS7PC){\r\nconst mtp3_addr_pc_t *mtp3_addr = (const mtp3_addr_pc_t *)(pinfo->dst.data);\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_SS7_DPC;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_SS7_DPC_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (mtp3_addr->pc & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (mtp3_addr->pc & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (mtp3_addr->pc & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (mtp3_addr->pc & 0x000000ff);\r\nexp_pdu_data->tlv_buffer[i+4] = (mtp3_addr->type & 0xff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+5] = (mtp3_addr->type & 0x00ff);\r\nexp_pdu_data->tlv_buffer[i+6] = mtp3_addr->ni;\r\ni += EXP_PDU_TAG_SS7_DPC_LEN;\r\n}\r\n}\r\nif((wanted_exp_tags[0] & EXP_PDU_TAG_ORIG_FNO_BIT) == EXP_PDU_TAG_ORIG_FNO_BIT){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_ORIG_FNO;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_ORIG_FNO_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = (pinfo->fd->num & 0xff000000) >> 24;\r\nexp_pdu_data->tlv_buffer[i+1] = (pinfo->fd->num & 0x00ff0000) >> 16;\r\nexp_pdu_data->tlv_buffer[i+2] = (pinfo->fd->num & 0x0000ff00) >> 8;\r\nexp_pdu_data->tlv_buffer[i+3] = (pinfo->fd->num & 0x000000ff);\r\n}\r\n}\r\nif (wanted_exp_tags_len >= 2) {\r\nif((wanted_exp_tags[1] & EXP_PDU_TAG_DVBCI_EVT_BIT) == EXP_PDU_TAG_DVBCI_EVT_BIT){\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_DVBCI_EVT;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = 0;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = EXP_PDU_TAG_DVBCI_EVT_LEN;\r\ni++;\r\nexp_pdu_data->tlv_buffer[i] = dvbci_get_evt_from_addrs(pinfo);\r\n}\r\n}\r\nreturn exp_pdu_data;\r\n}\r\ngint\r\nregister_export_pdu_tap(const char *name)\r\n{\r\ngchar *tap_name = g_strdup(name);\r\nexport_pdu_tap_name_list = g_slist_prepend(export_pdu_tap_name_list, tap_name);\r\nreturn register_tap(tap_name);\r\n}\r\nstatic\r\ngint sort_pdu_tap_name_list(gconstpointer a, gconstpointer b)\r\n{\r\nreturn g_strcmp0((const char *)a, (const char*)b);\r\n}\r\nGSList *\r\nget_export_pdu_tap_list(void)\r\n{\r\nexport_pdu_tap_name_list = g_slist_sort(export_pdu_tap_name_list, sort_pdu_tap_name_list);\r\nreturn export_pdu_tap_name_list;\r\n}

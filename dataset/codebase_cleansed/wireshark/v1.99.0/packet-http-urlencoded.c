static int\r\nget_form_key_value(tvbuff_t *tvb, char **ptr, int offset, char stop)\r\n{\r\nconst int orig_offset = offset;\r\nchar *tmp;\r\nint len;\r\nlen = 0;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nguint8 ch;\r\nch = tvb_get_guint8(tvb, offset);\r\nif (!ch)\r\nreturn -1;\r\nif (ch == stop)\r\nbreak;\r\nif (ch == '%') {\r\noffset++;\r\nch = tvb_get_guint8(tvb, offset);\r\nif (ws_xton(ch) == -1)\r\nreturn -1;\r\noffset++;\r\nch = tvb_get_guint8(tvb, offset);\r\nif (ws_xton(ch) == -1)\r\nreturn -1;\r\n}\r\nlen++;\r\noffset++;\r\n}\r\n*ptr = tmp = (char*)wmem_alloc(wmem_packet_scope(), len + 1);\r\ntmp[len] = '\0';\r\nlen = 0;\r\noffset = orig_offset;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nguint8 ch;\r\nch = tvb_get_guint8(tvb, offset);\r\nif (!ch)\r\nreturn -1;\r\nif (ch == stop)\r\nbreak;\r\nif (ch == '%') {\r\nguint8 ch1, ch2;\r\noffset++;\r\nch1 = tvb_get_guint8(tvb, offset);\r\noffset++;\r\nch2 = tvb_get_guint8(tvb, offset);\r\ntmp[len] = ws_xton(ch1) << 4 | ws_xton(ch2);\r\n} else if (ch == '+')\r\ntmp[len] = ' ';\r\nelse\r\ntmp[len] = ch;\r\nlen++;\r\noffset++;\r\n}\r\nreturn offset;\r\n}\r\nstatic int\r\ndissect_form_urlencoded(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\nproto_tree *url_tree;\r\nproto_tree *sub;\r\nproto_item *ti;\r\ngint offset = 0, next_offset;\r\nconst char *data_name;\r\ndata_name = pinfo->match_string;\r\nif (! (data_name && data_name[0])) {\r\ndata_name = (char *)data;\r\nif (! (data_name && data_name[0])) {\r\ndata_name = (char *)(pinfo->private_data);\r\nif (! (data_name && data_name[0])) {\r\ndata_name = NULL;\r\n}\r\n}\r\n}\r\nif (data_name)\r\ncol_append_sep_fstr(pinfo->cinfo, COL_INFO, " ", "(%s)", data_name);\r\nti = proto_tree_add_item(tree, hfi_urlencoded, tvb, 0, -1, ENC_NA);\r\nif (data_name)\r\nproto_item_append_text(ti, ": %s", data_name);\r\nurl_tree = proto_item_add_subtree(ti, ett_form_urlencoded);\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 0) {\r\nconst int start_offset = offset;\r\nchar *key, *value;\r\nti = proto_tree_add_item(url_tree, &hfi_form_keyvalue, tvb, offset, 0, ENC_NA);\r\nsub = proto_item_add_subtree(ti, ett_form_keyvalue);\r\nnext_offset = get_form_key_value(tvb, &key, offset, '=');\r\nif (next_offset == -1)\r\nbreak;\r\nproto_tree_add_string(sub, &hfi_form_key, tvb, offset, next_offset - offset, key);\r\nproto_item_append_text(sub, ": \"%s\"", key);\r\noffset = next_offset+1;\r\nnext_offset = get_form_key_value(tvb, &value, offset, '&');\r\nif (next_offset == -1)\r\nbreak;\r\nproto_tree_add_string(sub, &hfi_form_value, tvb, offset, next_offset - offset, value);\r\nproto_item_append_text(sub, " = \"%s\"", value);\r\noffset = next_offset+1;\r\nproto_item_set_len(ti, offset - start_offset);\r\n}\r\nreturn tvb_length(tvb);\r\n}\r\nvoid\r\nproto_register_http_urlencoded(void)\r\n{\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_form_keyvalue,\r\n&hfi_form_key,\r\n&hfi_form_value,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_form_urlencoded,\r\n&ett_form_keyvalue\r\n};\r\nint proto_urlencoded;\r\nproto_urlencoded = proto_register_protocol("HTML Form URL Encoded", "URL Encoded Form Data", "urlencoded-form");\r\nhfi_urlencoded = proto_registrar_get_nth(proto_urlencoded);\r\nform_urlencoded_handle = new_register_dissector("urlencoded-form", dissect_form_urlencoded, proto_urlencoded);\r\nproto_register_fields(proto_urlencoded, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_http_urlencoded(void)\r\n{\r\ndissector_add_string("media_type", "application/x-www-form-urlencoded", form_urlencoded_handle);\r\n}

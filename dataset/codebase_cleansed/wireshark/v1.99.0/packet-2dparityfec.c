static void dissect_2dparityfec(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree)\r\n{\r\nguint8 OffsetField;\r\nguint8 NAField;\r\nguint32 SNBase;\r\nguint8 D;\r\nSNBase = (guint32)tvb_get_guint8(tvb, 0)<<8;\r\nSNBase |= (guint32)tvb_get_guint8(tvb, 1);\r\nSNBase |= (guint32)tvb_get_guint8(tvb, 15)<<16;\r\nD = (tvb_get_guint8(tvb, 12)>>6) & 0x1;\r\nOffsetField = tvb_get_guint8(tvb, 13);\r\nNAField = tvb_get_guint8(tvb, 14);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "2dFEC");\r\nif(D)\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Row FEC - SNBase=%u, Offset=%u, NA=%u",\r\nSNBase, OffsetField, NAField);\r\n}\r\nelse\r\n{\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Column FEC - SNBase=%u, Offset=%u, NA=%u",\r\nSNBase, OffsetField, NAField);\r\n}\r\nif(tree)\r\n{\r\nproto_item *ti = NULL;\r\nproto_tree *tree_2dparityfec = NULL;\r\ngint offset = 0;\r\nti = proto_tree_add_item(tree, hfi_2dparityfec, tvb, 0, -1, ENC_NA);\r\ntree_2dparityfec = proto_item_add_subtree(ti, ett_2dparityfec);\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_snbase_low, tvb, offset, 2, ENC_BIG_ENDIAN); offset += 2;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_length_recovery, tvb, offset, 2, ENC_BIG_ENDIAN); offset += 2;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_rfc2733_ext, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_pt_recovery, tvb, offset, 1, ENC_BIG_ENDIAN); offset += 1;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_mask, tvb, offset, 3, ENC_BIG_ENDIAN); offset += 3;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_ts_recovery, tvb, offset, 4, ENC_BIG_ENDIAN); offset += 4;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_ts_pro_mpeg_ext, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_row_flag, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_type, tvb, offset, 1, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_index, tvb, offset, 1, ENC_BIG_ENDIAN); offset += 1;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_offset, tvb, offset, 1, ENC_BIG_ENDIAN); offset += 1;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_na, tvb, offset, 1, ENC_BIG_ENDIAN); offset += 1;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_snbase_ext, tvb, offset, 1, ENC_BIG_ENDIAN); offset += 1;\r\nproto_tree_add_item(tree_2dparityfec, &hfi_2dparityfec_payload, tvb, offset, -1, ENC_NA);\r\n}\r\n}\r\nvoid proto_register_2dparityfec(void)\r\n{\r\nmodule_t *module_2dparityfec;\r\n#ifndef HAVE_HFI_SECTION_INIT\r\nstatic header_field_info *hfi[] = {\r\n&hfi_2dparityfec_snbase_low,\r\n&hfi_2dparityfec_length_recovery,\r\n&hfi_2dparityfec_rfc2733_ext,\r\n&hfi_2dparityfec_pt_recovery,\r\n&hfi_2dparityfec_mask,\r\n&hfi_2dparityfec_ts_recovery,\r\n&hfi_2dparityfec_ts_pro_mpeg_ext,\r\n&hfi_2dparityfec_row_flag,\r\n&hfi_2dparityfec_type,\r\n&hfi_2dparityfec_index,\r\n&hfi_2dparityfec_offset,\r\n&hfi_2dparityfec_na,\r\n&hfi_2dparityfec_snbase_ext,\r\n&hfi_2dparityfec_payload,\r\n};\r\n#endif\r\nstatic gint *ett[] = {\r\n&ett_2dparityfec,\r\n};\r\nint proto_2dparityfec;\r\nproto_2dparityfec = proto_register_protocol(\r\n"Pro-MPEG Code of Practice #3 release 2 FEC Protocol",\r\n"2dparityfec",\r\n"2dparityfec");\r\nhfi_2dparityfec = proto_registrar_get_nth(proto_2dparityfec);\r\nproto_register_fields(proto_2dparityfec, hfi, array_length(hfi));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nmodule_2dparityfec = prefs_register_protocol(proto_2dparityfec,\r\nproto_reg_handoff_2dparityfec);\r\nprefs_register_bool_preference(module_2dparityfec, "enable",\r\n"Decode Pro-MPEG FEC on RTP dynamic payload type 96",\r\n"Enable this option to recognise all traffic on RTP dynamic payload type 96 (0x60) "\r\n"as FEC data corresponding to Pro-MPEG Code of Practice #3 release 2",\r\n&dissect_fec);\r\nhandle_2dparityfec = create_dissector_handle(dissect_2dparityfec,\r\nproto_2dparityfec);\r\n}\r\nvoid proto_reg_handoff_2dparityfec(void)\r\n{\r\nif (dissect_fec) {\r\ndissector_add_uint("rtp.pt", fec_rtp_payload_type, handle_2dparityfec);\r\n} else {\r\ndissector_delete_uint("rtp.pt", fec_rtp_payload_type, handle_2dparityfec);\r\n}\r\n}

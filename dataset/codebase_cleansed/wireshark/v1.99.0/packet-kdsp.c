static guint\r\nget_kdsp_message_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset)\r\n{\r\nreturn tvb_get_ntohl(tvb, offset+8) + FRAME_HEADER_LEN;\r\n}\r\nstatic int\r\ndissect_kdsp_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nguint32 offset = 0;\r\nguint32 command, length, numChan, bitmap, cptbitmap;\r\nguint32 i, datalink_type=0, payload_len;\r\nguint16 type, reported_payload_len=0, data_hdr_len, data_hdr_len_check;\r\nproto_item *kdsp_item, *sub_item, *subsub_item, *data_len_item, *command_item;\r\nproto_tree *kdsp_tree, *sub_tree, *subsub_tree;\r\ntvbuff_t *payload_tvb;\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "KDSP");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\ncommand = tvb_get_ntohl(tvb, 4);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Command %s; ",\r\nval_to_str(command, packettypenames, "Unknown (0x%02x)"));\r\ncol_set_fence(pinfo->cinfo, COL_INFO);\r\nkdsp_item = proto_tree_add_item(tree, proto_kdsp, tvb, 0, -1, ENC_NA);\r\nkdsp_tree = proto_item_add_subtree(kdsp_item, ett_kdsp_pdu);\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_sentinel, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\ncommand_item = proto_tree_add_item(kdsp_tree, hf_kdsp_cmdnum, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_item_append_text(kdsp_item, ", Command %s",\r\nval_to_str(command, packettypenames, "Unknown (0x%02x)"));\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nlength = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nswitch(command)\r\n{\r\ncase HELLO:\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_version, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset +=4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_server_version,\r\ntvb, offset, 32, ENC_ASCII|ENC_NA);\r\noffset +=32;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_hostname, tvb, offset, 32, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase STRING:\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_str_flags, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset +=4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_str_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset +=4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_str_msg, tvb, offset, -1, ENC_ASCII|ENC_NA);\r\nbreak;\r\ncase CAPPACKET:\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_cpt_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_cpt_bitmap);\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_flag_cpt, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_flag_fcs, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_flag_gps, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_flag_radio, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbitmap = tvb_get_ntohl(tvb, offset);\r\noffset +=4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_cpt_offset, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset +=4;\r\nif (bitmap & FCS_FLAG) {\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_fcs, tvb, offset, 4, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_sub_fcs);\r\nproto_tree_add_item(sub_tree, hf_kdsp_fcs_data, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\n}\r\nif (bitmap & RADIO_FLAG) {\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_radio_hdr, tvb, offset, 30, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_sub_radio);\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_hdr_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_content_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_accuracy, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_freq_mhz, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_signal_dbm, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_noise_dbm, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_carrier, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_encoding, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_datarate, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_signal_rssi, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_radio_noise_rssi, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\nif (bitmap & GPS_FLAG) {\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_gps_hdr, tvb, offset, 68, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_sub_gps);\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_hdr_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_content_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_fix, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_lat, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_lon, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_alt, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_spd, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\nproto_tree_add_item(sub_tree, hf_kdsp_gps_heading, tvb, offset, 12, ENC_NA);\r\noffset += 12;\r\n}\r\nif (bitmap & CPT_FLAG) {\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_cpt_data_hdr, tvb, offset, 44, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_sub_cpt);\r\ndata_len_item = proto_tree_add_item(sub_tree, hf_kdsp_cpt_data_hdr_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\ndata_hdr_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nsubsub_item = proto_tree_add_item(sub_tree, hf_kdsp_cpt_data_content_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nsubsub_tree = proto_item_add_subtree(subsub_item, ett_cpt_data_content_bitmap);\r\nproto_tree_add_item(subsub_tree, hf_kdsp_cpt_dc_flag_uuid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subsub_tree, hf_kdsp_cpt_dc_flag_len, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subsub_tree, hf_kdsp_cpt_dc_flag_sec, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subsub_tree, hf_kdsp_cpt_dc_flag_usec, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(subsub_tree, hf_kdsp_cpt_dc_flag_dlt, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ncptbitmap = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\ndata_hdr_len_check = 6;\r\nif (cptbitmap & DATA_UUID_FLAG) data_hdr_len_check += 16;\r\nif (cptbitmap & DATA_PACKLEN_FLAG) data_hdr_len_check += 2;\r\nif (cptbitmap & DATA_TVSEC_FLAG) data_hdr_len_check += 8;\r\nif (cptbitmap & DATA_TVUSEC_FLAG) data_hdr_len_check += 8;\r\nif (cptbitmap & DATA_DLT_FLAG) data_hdr_len_check += 4;\r\nif (data_hdr_len_check != data_hdr_len) {\r\nexpert_add_info(pinfo, data_len_item, &ei_kdsp_cpt_data_hdr_len);\r\n}\r\nif (cptbitmap & DATA_UUID_FLAG) {\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_uuid, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\n}\r\nif (cptbitmap & DATA_PACKLEN_FLAG) {\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_packet_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nreported_payload_len = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\n}\r\nif (cptbitmap & DATA_TVSEC_FLAG) {\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_tv_sec, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\n}\r\nif (cptbitmap & DATA_TVUSEC_FLAG) {\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_tv_usec, tvb, offset, 8, ENC_BIG_ENDIAN);\r\noffset += 8;\r\n}\r\nif (cptbitmap & DATA_DLT_FLAG) {\r\nproto_tree_add_item(sub_tree, hf_kdsp_cpt_dlt, tvb, offset, 4, ENC_BIG_ENDIAN);\r\ndatalink_type = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\n}\r\npayload_len = (length + FRAME_HEADER_LEN) - offset;\r\nif (cptbitmap & DATA_PACKLEN_FLAG) {\r\npayload_tvb = tvb_new_subset(tvb, offset, payload_len, reported_payload_len);\r\nif (cptbitmap & DATA_DLT_FLAG) {\r\ndissector_try_uint(subdissector_dlt_table, datalink_type, payload_tvb, pinfo, tree);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "KDSP");\r\n} else if (payload_len > 0) {\r\nproto_tree_add_expert(sub_tree, pinfo, &ei_kdsp_payload_expected, tvb, offset, payload_len);\r\n}\r\n} else if (payload_len > 0) {\r\nproto_tree_add_expert(sub_tree, pinfo, &ei_kdsp_payload_unexpected, tvb, offset, payload_len);\r\n}\r\n}\r\nbreak;\r\ncase CHANNELSET:\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_ch_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_ch_bitmap);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_uuid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_cmd, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_curch, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_hop, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_numch, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_channels, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_dwell, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_rate, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_hopdwell, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_uuid, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_cmd, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_cur_ch, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_hop, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_num_ch, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nnumChan = tvb_get_ntohs(tvb, offset);\r\noffset += 2;\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_ch_data, tvb, offset, 2046, ENC_NA);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_ch_data);\r\nfor(i = 0; i<numChan; i++) {\r\ntype = tvb_get_ntohs(tvb, offset);\r\ntype = type >> 15;\r\nif (!type) {\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_ch, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_dwell, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 6;\r\n}\r\nelse{\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_start, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_end, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_width, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_iter, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\n}\r\n}\r\noffset = length+FRAME_HEADER_LEN-4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_rate, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_ch_ch_dwell, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase SOURCE:\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset +=2;\r\nsub_item = proto_tree_add_item(kdsp_tree, hf_kdsp_ch_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nsub_tree = proto_item_add_subtree(sub_item, ett_ch_bitmap);\r\nproto_tree_add_item(sub_tree, hf_kdsp_ch_flag_uuid, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset +=4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_uuid, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_invalidate, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset +=2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_name, tvb, offset, 16, ENC_ASCII|ENC_NA);\r\noffset +=16;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_interface, tvb, offset, 16, ENC_ASCII|ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_type, tvb, offset, 16, ENC_ASCII|ENC_NA);\r\noffset +=16;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_hop, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset +=1;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_dwell, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_source_rate, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nbreak;\r\ncase REPORT:\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_report_hdr_len, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_report_content_bitmap, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_report_uuid, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_report_flags, tvb, offset, 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_report_hop_tm_sec, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(kdsp_tree, hf_kdsp_report_hop_tm_usec, tvb, offset, 4, ENC_BIG_ENDIAN);\r\nbreak;\r\ndefault:\r\nexpert_add_info(pinfo, command_item, &ei_kdsp_cmdnum);\r\n}\r\nreturn tvb_length(tvb);\r\n}\r\nstatic int\r\ndissect_kdsp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, FRAME_HEADER_LEN,\r\nget_kdsp_message_len, dissect_kdsp_message, data);\r\nreturn tvb_length(tvb);\r\n}\r\nvoid\r\nproto_register_kdsp(void)\r\n{\r\nmodule_t *kdsp_module;\r\nstatic hf_register_info hf[] = {\r\n{ &hf_kdsp_sentinel,\r\n{ "Sentinel", "kdsp.sentinel",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cmdnum,\r\n{ "Command", "kdsp.command",\r\nFT_UINT32, BASE_DEC,\r\nVALS(packettypenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_length,\r\n{ "Length", "kdsp.length",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_version,\r\n{ "KDSP Version", "kdsp.version",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_server_version,\r\n{ "Server Version", "kdsp.server.version",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_hostname,\r\n{ "Hostname", "kdsp.hostname",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_str_flags,\r\n{ "String Flags", "kdsp.str.flags",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_str_len,\r\n{ "String Length", "kdsp.str.length",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_str_msg,\r\n{ "Message", "kdsp.str.message",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_bitmap,\r\n{ "Bitmap", "kdsp.cpt.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_flag_cpt,\r\n{ "Capture Packet Flag", "kdsp.cpt.flag.cpt",\r\nFT_BOOLEAN, 32,\r\nNULL, CPT_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_flag_fcs,\r\n{ "Capture FCS Flag", "kdsp.cpt.flag.fcs",\r\nFT_BOOLEAN, 32,\r\nNULL, FCS_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_flag_gps,\r\n{ "Capture GPS Flag", "kdsp.cpt.flag.gps",\r\nFT_BOOLEAN, 32,\r\nNULL, GPS_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_flag_radio,\r\n{ "Capture Radio Flag", "kdsp.cpt.flag.radio",\r\nFT_BOOLEAN, 32,\r\nNULL, RADIO_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_offset,\r\n{ "Offset Capture Packet Header", "kdsp.cpt.offset",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_fcs,\r\n{ "Capture FCS Header", "kdsp.fcs",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_fcs_data,\r\n{ "Frame Checksum", "kdsp.fcs.data",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_hdr,\r\n{ "Capture Radio Header", "kdsp.radio",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_hdr_len,\r\n{ "Length", "kdsp.radio.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_content_bitmap,\r\n{ "Bitmap", "kdsp.radio.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_accuracy,\r\n{ "Accuracy", "kdsp.radio.accuracy",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_freq_mhz,\r\n{ "Frequency", "kdsp.radio.freq",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_signal_dbm,\r\n{ "Signal dbm", "kdsp.radio.signal_dbm",\r\nFT_INT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_noise_dbm,\r\n{ "Noise dbm", "kdsp.radio.noise_dbm",\r\nFT_INT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_carrier,\r\n{ "Carrier", "kdsp.radio.car",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_encoding,\r\n{ "Encoding", "kdsp.radio.enc",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_datarate,\r\n{ "Data Rate", "kdsp.radio.datarate",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_signal_rssi,\r\n{ "Signal rssi", "kdsp.radio.signal_rssi",\r\nFT_INT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_radio_noise_rssi,\r\n{ "Noise rssi", "kdsp.radio.noise_rssi",\r\nFT_INT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_hdr,\r\n{ "Capture GPS Header", "kdsp.gps",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_hdr_len,\r\n{ "GPS Length", "kdsp.gps.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_content_bitmap,\r\n{ "Bitmap", "kdsp.gps.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_fix,\r\n{ "GPS fix", "kdsp.gps.fix",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_lat,\r\n{ "Latitude", "kdsp.gps.lat",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_lon,\r\n{ "Longitude", "kdsp.gps.lon",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_alt,\r\n{ "Alt", "kdsp.gps.alt",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_spd,\r\n{ "Spd", "kdsp.gps.spd",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_gps_heading,\r\n{ "Heading", "kdsp.gps.heading",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_data_hdr,\r\n{ "Capture Packet Header", "kdsp.cpt",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_data_hdr_len,\r\n{ "Length", "kdsp.cpt.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_data_content_bitmap,\r\n{ "Bitmap", "kdsp.cpt.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_dc_flag_uuid,\r\n{ "Capture Content UUID Flag", "kdsp.cpt.cd.flag.uuid",\r\nFT_BOOLEAN, 32,\r\nNULL, DATA_UUID_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_dc_flag_len,\r\n{ "Capture Content Length Flag", "kdsp.cpt.cd.flag.len",\r\nFT_BOOLEAN, 32,\r\nNULL, DATA_PACKLEN_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_dc_flag_sec,\r\n{ "Capture Content Second Flag", "kdsp.cpt.cd.flag.sec",\r\nFT_BOOLEAN, 32,\r\nNULL, DATA_TVSEC_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_dc_flag_usec,\r\n{ "Capture Content Microsecond Flag", "kdsp.cpt.cd.flag.usec",\r\nFT_BOOLEAN, 32,\r\nNULL, DATA_TVUSEC_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_dc_flag_dlt,\r\n{ "Capture Content Datalink Type Flag", "kdsp.cpt.cd.flag.dlt",\r\nFT_BOOLEAN, 32,\r\nNULL, DATA_DLT_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_uuid,\r\n{ "UUID", "kdsp.cpt.uuid",\r\nFT_BYTES, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_packet_len,\r\n{ "Packet Length", "kdsp.cpt.pkt_len",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_tv_sec,\r\n{ "TV sec", "kdsp.cpt.tv_sec",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_tv_usec,\r\n{ "TV usec", "kdsp.cpt.tv_usec",\r\nFT_UINT64, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_cpt_dlt,\r\n{ "Data Link Type", "kdsp.cpt.dlt",\r\nFT_UINT32, BASE_DEC,\r\nVALS(payloadtypenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_length,\r\n{ "Length", "kdsp.chset.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_bitmap,\r\n{ "Bitmap", "kdsp.chset.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_uuid,\r\n{ "UUID Flag", "kdsp.ch.flag.uuid",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_UUID_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_cmd,\r\n{ "Command Flag", "kdsp.ch.flag.cmd",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_CMD_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_curch,\r\n{ "Current Channel Flag", "kdsp.ch.flag.curch",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_CURCH_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_hop,\r\n{ "Hop Flag", "kdsp.ch.flag.hop",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_HOP_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_numch,\r\n{ "Num Channels Flag", "kdsp.ch.flag.numch",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_NUMCH_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_channels,\r\n{ "Channels Flag", "kdsp.ch.flag.channels",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_CHANNELS_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_dwell,\r\n{ "Dwell Flag", "kdsp.ch.flag.dwell",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_DWELL_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_rate,\r\n{ "Rate Flag", "kdsp.ch.flag.rate",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_RATE_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_flag_hopdwell,\r\n{ "Hop-Dwell Flag", "kdsp.ch.flag.hopdwell",\r\nFT_BOOLEAN, 32,\r\nNULL, CH_HOPDWELL_FLAG,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_uuid,\r\n{ "UUID", "kdsp.chset.uuid",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_cmd,\r\n{ "Command", "kdsp.chset.cmd",\r\nFT_UINT16, BASE_DEC,\r\nVALS(channelcmds), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_cur_ch,\r\n{ "Current Channel", "kdsp.chset.cur_ch",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_hop,\r\n{ "Channel Hop", "kdsp.chset.hop",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_num_ch,\r\n{ "Number of Channels", "kdsp.chset.num_ch",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_data,\r\n{ "Channel Data", "kdsp.chset.data",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_ch,\r\n{ "Channel", "kdsp.chset.ch",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_dwell,\r\n{ "Dwell", "kdsp.chset.dwell",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_start,\r\n{ "Start", "kdsp.chset.start",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_end,\r\n{ "End", "kdsp.chset.end",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_width,\r\n{ "Width", "kdsp.chset.width",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_iter,\r\n{ "Iter", "kdsp.chset.iter",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_rate,\r\n{ "Rate", "kdsp.chset.rate",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_ch_ch_dwell,\r\n{ "Dwell", "kdsp.chset.dwell",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_length,\r\n{ "Length", "kdsp.source.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_bitmap,\r\n{ "Source Bitmap", "kdsp.source.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_uuid,\r\n{ "UUID", "kdsp.source.uuid",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_invalidate,\r\n{ "Source Invalidate", "kdsp.source.invalidate",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_name,\r\n{ "Source Name", "kdsp.source.name",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_interface,\r\n{ "Interface", "kdsp.source.interface",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_type,\r\n{ "Type", "kdsp.source.type",\r\nFT_STRING, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_hop,\r\n{ "Source Hop", "kdsp.source.hop",\r\nFT_UINT8, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_dwell,\r\n{ "Source Dwell", "kdsp.source.dwell",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_source_rate,\r\n{ "Source Rate", "kdsp.source.rate",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_report_hdr_len,\r\n{ "Length", "kdsp.report.length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_report_content_bitmap,\r\n{ "Bitmap", "kdsp.report.bitmap",\r\nFT_UINT32, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_report_uuid,\r\n{ "UUID", "kdsp.report.uuid",\r\nFT_NONE, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_report_flags,\r\n{ "flags", "kdsp.report.flags",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_report_hop_tm_sec,\r\n{ "Hop Time (sec)", "kdsp.report.sec",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_kdsp_report_hop_tm_usec,\r\n{ "Hop Time (usec)", "kdsp.report.usec",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_kdsp_pdu,\r\n&ett_cpt_bitmap,\r\n&ett_cpt_data_content_bitmap,\r\n&ett_ch_bitmap,\r\n&ett_ch_data,\r\n&ett_sub_fcs,\r\n&ett_sub_radio,\r\n&ett_sub_gps,\r\n&ett_sub_cpt\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_kdsp_payload_expected, { "kdsp.payload_expected", PI_MALFORMED, PI_ERROR, "Payload expected but no link type specified. Can not decode.", EXPFILL }},\r\n{ &ei_kdsp_payload_unexpected, { "kdsp.payload_unexpected", PI_MALFORMED, PI_ERROR, "No payload expected but found some data", EXPFILL }},\r\n{ &ei_kdsp_cpt_data_hdr_len, { "kdsp.cpt.length.invalid", PI_MALFORMED, PI_ERROR, "Calculated header length does not match reported header length. "\r\n"It is likely the dissector does not support all flags", EXPFILL }},\r\n{ &ei_kdsp_cmdnum, { "kdsp.command.unknown", PI_UNDECODED, PI_WARN, "Unknown command, can not parse message", EXPFILL }},\r\n};\r\nexpert_module_t* expert_kdsp;\r\nproto_kdsp = proto_register_protocol(\r\n"Kismet Drone/Server Protocol",\r\n"KDSP",\r\n"kdsp"\r\n);\r\nproto_register_field_array(proto_kdsp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nkdsp_module = prefs_register_protocol(proto_kdsp, proto_reg_handoff_kdsp);\r\nexpert_kdsp = expert_register_protocol(proto_kdsp);\r\nexpert_register_field_array(expert_kdsp, ei, array_length(ei));\r\nsubdissector_dlt_table = register_dissector_table("kdsp.cpt.dlt", "KDSP DLT Type", FT_UINT32, BASE_DEC);\r\nprefs_register_uint_preference(kdsp_module, "tcp.port",\r\n"Kismet Drone TCP Port",\r\n"Set the port for Kismet Drone/Server messages (if other"\r\n" than the default of 2502)", 10,\r\n&global_kdsp_tcp_port);\r\n}\r\nvoid\r\nproto_reg_handoff_kdsp(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic guint tcp_port;\r\nstatic dissector_handle_t kdsp_handle;\r\ndissector_handle_t dlt_handle;\r\nif (!initialized) {\r\nkdsp_handle = new_create_dissector_handle(dissect_kdsp, proto_kdsp);\r\ndlt_handle = find_dissector("radiotap");\r\nif (dlt_handle)\r\ndissector_add_uint( "kdsp.cpt.dlt", DATALINK_RADIOTAP, dlt_handle);\r\ndlt_handle = find_dissector("wlan");\r\nif (dlt_handle)\r\ndissector_add_uint( "kdsp.cpt.dlt", DATALINK_WLAN, dlt_handle);\r\n} else {\r\ndissector_delete_uint("tcp.port", tcp_port, kdsp_handle);\r\n}\r\ntcp_port = global_kdsp_tcp_port;\r\ndissector_add_uint("tcp.port", global_kdsp_tcp_port, kdsp_handle);\r\n}

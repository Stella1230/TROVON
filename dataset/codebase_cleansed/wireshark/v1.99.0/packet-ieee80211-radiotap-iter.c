int ieee80211_radiotap_iterator_init(\r\nstruct ieee80211_radiotap_iterator *iterator,\r\nstruct ieee80211_radiotap_header *radiotap_header,\r\nint max_length, const struct ieee80211_radiotap_vendor_namespaces *vns)\r\n{\r\nif (max_length < (int)sizeof(struct ieee80211_radiotap_header))\r\nreturn -EINVAL;\r\nif (radiotap_header->it_version)\r\nreturn -EINVAL;\r\nif (max_length < get_unaligned_le16(&radiotap_header->it_len))\r\nreturn -EINVAL;\r\niterator->_rtheader = radiotap_header;\r\niterator->_max_length = get_unaligned_le16(&radiotap_header->it_len);\r\niterator->_arg_index = 0;\r\niterator->_bitmap_shifter = get_unaligned_le32(&radiotap_header->it_present);\r\niterator->_arg = (guint8 *)radiotap_header + sizeof(*radiotap_header);\r\niterator->_reset_on_ext = 0;\r\niterator->_next_bitmap = &radiotap_header->it_present;\r\niterator->_next_bitmap++;\r\niterator->_vns = vns;\r\niterator->current_namespace = &radiotap_ns;\r\niterator->is_radiotap_ns = 1;\r\n#ifdef RADIOTAP_SUPPORT_OVERRIDES\r\niterator->n_overrides = 0;\r\niterator->overrides = NULL;\r\n#endif\r\nif (iterator->_bitmap_shifter & (1<<IEEE80211_RADIOTAP_EXT)) {\r\nif (!ITERATOR_VALID(iterator, sizeof(guint32)))\r\nreturn -EINVAL;\r\nwhile (get_unaligned_le32(iterator->_arg) &\r\n(1 << IEEE80211_RADIOTAP_EXT)) {\r\niterator->_arg += sizeof(guint32);\r\nif (!ITERATOR_VALID(iterator, sizeof(guint32)))\r\nreturn -EINVAL;\r\n}\r\niterator->_arg += sizeof(guint32);\r\n}\r\niterator->this_arg = iterator->_arg;\r\nreturn 0;\r\n}\r\nstatic void find_ns(struct ieee80211_radiotap_iterator *iterator,\r\nguint32 oui, guint8 subns)\r\n{\r\nint i;\r\niterator->current_namespace = NULL;\r\nif (!iterator->_vns)\r\nreturn;\r\nfor (i = 0; i < iterator->_vns->n_ns; i++) {\r\nif (iterator->_vns->ns[i].oui != oui)\r\ncontinue;\r\nif (iterator->_vns->ns[i].subns != subns)\r\ncontinue;\r\niterator->current_namespace = &iterator->_vns->ns[i];\r\nbreak;\r\n}\r\n}\r\nstatic int find_override(struct ieee80211_radiotap_iterator *iterator,\r\nint *align, int *size)\r\n{\r\nint i;\r\nif (!iterator->overrides)\r\nreturn 0;\r\nfor (i = 0; i < iterator->n_overrides; i++) {\r\nif (iterator->_arg_index == iterator->overrides[i].field) {\r\n*align = iterator->overrides[i].align;\r\n*size = iterator->overrides[i].size;\r\nif (!*align)\r\nreturn 0;\r\nreturn 1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint ieee80211_radiotap_iterator_next(\r\nstruct ieee80211_radiotap_iterator *iterator)\r\n{\r\nwhile (1) {\r\nint hit = 0;\r\nint pad, align, size, subns;\r\nguint32 oui;\r\nif ((iterator->_arg_index % 32) == IEEE80211_RADIOTAP_EXT &&\r\n!(iterator->_bitmap_shifter & 1))\r\nreturn -ENOENT;\r\nif (!(iterator->_bitmap_shifter & 1))\r\ngoto next_entry;\r\nswitch (iterator->_arg_index % 32) {\r\ncase IEEE80211_RADIOTAP_RADIOTAP_NAMESPACE:\r\ncase IEEE80211_RADIOTAP_EXT:\r\nalign = 1;\r\nsize = 0;\r\nbreak;\r\ncase IEEE80211_RADIOTAP_VENDOR_NAMESPACE:\r\nalign = 2;\r\nsize = 6;\r\nbreak;\r\ndefault:\r\n#ifdef RADIOTAP_SUPPORT_OVERRIDES\r\nif (find_override(iterator, &align, &size)) {\r\n} else\r\n#endif\r\nif (!iterator->current_namespace ||\r\niterator->_arg_index >= iterator->current_namespace->n_bits) {\r\nif (iterator->current_namespace == &radiotap_ns)\r\nreturn -ENOENT;\r\nalign = 0;\r\n} else {\r\nalign = iterator->current_namespace->align_size[iterator->_arg_index].align;\r\nsize = iterator->current_namespace->align_size[iterator->_arg_index].size;\r\n}\r\nif (!align) {\r\niterator->_arg = iterator->_next_ns_data;\r\niterator->current_namespace = NULL;\r\ngoto next_entry;\r\n}\r\nbreak;\r\n}\r\npad = (int)((iterator->_arg - (unsigned char *)iterator->_rtheader) & (align - 1));\r\nif (pad)\r\niterator->_arg += align - pad;\r\nif (iterator->_arg_index % 32 == IEEE80211_RADIOTAP_VENDOR_NAMESPACE) {\r\nint vnslen;\r\nif (!ITERATOR_VALID(iterator, size))\r\nreturn -EINVAL;\r\noui = (*iterator->_arg << 16) |\r\n(*(iterator->_arg + 1) << 8) |\r\n*(iterator->_arg + 2);\r\nsubns = *(iterator->_arg + 3);\r\nfind_ns(iterator, oui, subns);\r\nvnslen = get_unaligned_le16(iterator->_arg + 4);\r\niterator->_next_ns_data = iterator->_arg + size + vnslen;\r\nif (!iterator->current_namespace)\r\nsize += vnslen;\r\n}\r\niterator->this_arg_index = iterator->_arg_index;\r\niterator->this_arg = iterator->_arg;\r\niterator->this_arg_size = size;\r\niterator->_arg += size;\r\nif (!ITERATOR_VALID(iterator, 0))\r\nreturn -EINVAL;\r\nswitch (iterator->_arg_index % 32) {\r\ncase IEEE80211_RADIOTAP_VENDOR_NAMESPACE:\r\niterator->_reset_on_ext = 1;\r\niterator->is_radiotap_ns = 0;\r\niterator->this_arg_index =\r\nIEEE80211_RADIOTAP_VENDOR_NAMESPACE;\r\nif (!iterator->current_namespace)\r\nhit = 1;\r\ngoto next_entry;\r\ncase IEEE80211_RADIOTAP_RADIOTAP_NAMESPACE:\r\niterator->_reset_on_ext = 1;\r\niterator->current_namespace = &radiotap_ns;\r\niterator->is_radiotap_ns = 1;\r\ngoto next_entry;\r\ncase IEEE80211_RADIOTAP_EXT:\r\niterator->_bitmap_shifter =\r\nget_unaligned_le32(iterator->_next_bitmap);\r\niterator->_next_bitmap++;\r\nif (iterator->_reset_on_ext)\r\niterator->_arg_index = 0;\r\nelse\r\niterator->_arg_index++;\r\niterator->_reset_on_ext = 0;\r\nbreak;\r\ndefault:\r\nhit = 1;\r\nnext_entry:\r\niterator->_bitmap_shifter >>= 1;\r\niterator->_arg_index++;\r\n}\r\nif (hit)\r\nreturn 0;\r\n}\r\n}

static void\r\nwsp_reset_hash(gchar *key _U_ , wsp_status_code_t *data, gpointer ptr _U_ )\r\n{\r\ndata->packets = 0;\r\n}\r\nstatic void\r\nwsp_print_statuscode(gint *key, wsp_status_code_t *data, char* format)\r\n{\r\nif (data && (data->packets!=0))\r\nprintf(format, *key, data->packets ,data->name);\r\n}\r\nstatic void\r\nwsp_free_hash_table( gpointer key, gpointer value, gpointer user_data _U_ )\r\n{\r\ng_free(key);\r\ng_free(value);\r\n}\r\nstatic void\r\nwspstat_reset(void *psp)\r\n{\r\nwspstat_t *sp=(wspstat_t *)psp;\r\nguint32 i;\r\nfor(i=1;i<=sp->num_pdus;i++)\r\n{\r\nsp->pdu_stats[i].packets=0;\r\n}\r\ng_hash_table_foreach( sp->hash, (GHFunc)wsp_reset_hash, NULL);\r\n}\r\nstatic gint\r\npdut2index(gint pdut)\r\n{\r\nif (pdut<=0x09) return pdut;\r\nif (pdut>=0x40){\r\nif (pdut <= 0x44){\r\nreturn pdut-54;\r\n} else if (pdut==0x60||pdut==0x61){\r\nreturn pdut-81;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic gint\r\nindex2pdut(gint pdut)\r\n{\r\nif (pdut<=0x09)\r\nreturn pdut;\r\nif (pdut<=14)\r\nreturn pdut+54;\r\nif (pdut<=16)\r\nreturn pdut+81;\r\nreturn 0;\r\n}\r\nstatic int\r\nwspstat_packet(void *psp, packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *pri)\r\n{\r\nwspstat_t *sp=(wspstat_t *)psp;\r\nconst wsp_info_value_t *value=(const wsp_info_value_t *)pri;\r\ngint idx = pdut2index(value->pdut);\r\nint retour=0;\r\nif (value->status_code != 0) {\r\ngint *key=g_new(gint,1);\r\nwsp_status_code_t *sc;\r\n*key=value->status_code ;\r\nsc = (wsp_status_code_t *)g_hash_table_lookup(\r\nsp->hash,\r\nkey);\r\nif (!sc) {\r\nsc = g_new(wsp_status_code_t,1);\r\nsc -> packets = 1;\r\nsc -> name = NULL;\r\ng_hash_table_insert(\r\nsp->hash,\r\nkey,\r\nsc);\r\n} else {\r\nsc->packets++;\r\n}\r\nretour=1;\r\n}\r\nif (idx!=0) {\r\nsp->pdu_stats[ idx ].packets++;\r\nretour = 1;\r\n}\r\nreturn retour;\r\n}\r\nstatic void\r\nwspstat_draw(void *psp)\r\n{\r\nwspstat_t *sp=(wspstat_t *)psp;\r\nguint32 i;\r\nprintf("\n");\r\nprintf("===================================================================\n");\r\nprintf("WSP Statistics:\n");\r\nprintf("%-23s %9s || %-23s %9s\n","PDU Type", "Packets", "PDU Type", "Packets");\r\nfor(i=1; i<= ((sp->num_pdus+1)/2) ; i++)\r\n{\r\nguint32 ii=i+sp->num_pdus/2;\r\nprintf("%-23s %9d", sp->pdu_stats[i ].type, sp->pdu_stats[i ].packets);\r\nprintf(" || ");\r\nif (ii< (sp->num_pdus) )\r\nprintf("%-23s %9d\n", sp->pdu_stats[ii].type, sp->pdu_stats[ii].packets);\r\nelse\r\nprintf("\n");\r\n}\r\nprintf("\nStatus code in reply packets\n");\r\nprintf( "Status Code Packets Description\n");\r\ng_hash_table_foreach( sp->hash, (GHFunc) wsp_print_statuscode,\r\n(gpointer)" 0x%02X %9d %s\n" ) ;\r\nprintf("===================================================================\n");\r\n}\r\nstatic void\r\nwspstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nwspstat_t *sp;\r\nconst char *filter=NULL;\r\nguint32 i;\r\nGString *error_string;\r\nwsp_status_code_t *sc;\r\nconst value_string *wsp_vals_status_p;\r\nif (!strncmp (opt_arg, "wsp,stat," , 9)){\r\nfilter=opt_arg+9;\r\n} else {\r\nfilter=NULL;\r\n}\r\nsp = g_new(wspstat_t,1);\r\nsp->hash = g_hash_table_new( g_int_hash, g_int_equal);\r\nwsp_vals_status_p = VALUE_STRING_EXT_VS_P(&wsp_vals_status_ext);\r\nfor (i=0 ; wsp_vals_status_p[i].strptr ; i++ )\r\n{\r\ngint *key;\r\nsc=g_new(wsp_status_code_t,1);\r\nkey=g_new(gint,1);\r\nsc->packets=0;\r\nsc->name=wsp_vals_status_p[i].strptr;\r\n*key=wsp_vals_status_p[i].value;\r\ng_hash_table_insert(\r\nsp->hash,\r\nkey,\r\nsc);\r\n}\r\nsp->num_pdus = 16;\r\nsp->pdu_stats=g_new(wsp_pdu_t,(sp->num_pdus+1));\r\nif(filter){\r\nsp->filter=g_strdup(filter);\r\n} else {\r\nsp->filter=NULL;\r\n}\r\nfor (i=0;i<sp->num_pdus; i++)\r\n{\r\nsp->pdu_stats[i].packets=0;\r\nsp->pdu_stats[i].type = try_val_to_str_ext( index2pdut( i ), &wsp_vals_pdu_type_ext) ;\r\n}\r\nerror_string = register_tap_listener(\r\n"wsp",\r\nsp,\r\nfilter,\r\n0,\r\nwspstat_reset,\r\nwspstat_packet,\r\nwspstat_draw);\r\nif (error_string){\r\ng_free(sp->pdu_stats);\r\ng_free(sp->filter);\r\ng_free(sp);\r\ng_hash_table_foreach( sp->hash, (GHFunc) wsp_free_hash_table, NULL ) ;\r\ng_hash_table_destroy( sp->hash );\r\nfprintf(stderr, "tshark: Couldn't register wsp,stat tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_wspstat(void)\r\n{\r\nregister_stat_cmd_arg("wsp,stat,", wspstat_init,NULL);\r\n}

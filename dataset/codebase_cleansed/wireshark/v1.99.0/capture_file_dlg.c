static wtap *\r\npreview_set_filename(GtkWidget *prev, const gchar *cf_name)\r\n{\r\nGtkWidget *label;\r\nwtap *wth;\r\nint err = 0;\r\ngchar *err_info;\r\ngchar string_buff[PREVIEW_STR_MAX];\r\ngint64 filesize;\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_FORMAT_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), "-");\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_SIZE_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), "-");\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_ELAPSED_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), "-");\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_PACKETS_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), "-");\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_FIRST_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), "-");\r\nif (!cf_name) {\r\nreturn NULL;\r\n}\r\nif (test_for_directory(cf_name) == EISDIR) {\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_FORMAT_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), "directory");\r\nreturn NULL;\r\n}\r\nwth = wtap_open_offline(cf_name, WTAP_TYPE_AUTO, &err, &err_info, TRUE);\r\nif (wth == NULL) {\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_FORMAT_KEY);\r\nif (err == WTAP_ERR_FILE_UNKNOWN_FORMAT) {\r\ngtk_label_set_text(GTK_LABEL(label), "unknown file format");\r\n} else {\r\ngtk_label_set_text(GTK_LABEL(label), "error opening file");\r\n}\r\nreturn NULL;\r\n}\r\nfilesize = wtap_file_size(wth, &err);\r\nif (filesize == -1) {\r\ngtk_label_set_text(GTK_LABEL(label), "error getting file size");\r\nwtap_close(wth);\r\nreturn NULL;\r\n}\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "%" G_GINT64_MODIFIER "d bytes", filesize);\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_SIZE_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), string_buff);\r\ng_strlcpy(string_buff, wtap_file_type_subtype_string(wtap_file_type_subtype(wth)), PREVIEW_STR_MAX);\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_FORMAT_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), string_buff);\r\nreturn wth;\r\n}\r\nstatic void\r\npreview_do(GtkWidget *prev, wtap *wth)\r\n{\r\nGtkWidget *label;\r\nunsigned int elapsed_time;\r\ntime_t time_preview;\r\ntime_t time_current;\r\nint err = 0;\r\ngchar *err_info;\r\ngint64 data_offset;\r\ndouble start_time = 0;\r\ndouble stop_time = 0;\r\ndouble cur_time;\r\nunsigned int packets = 0;\r\ngboolean is_breaked = FALSE;\r\ngchar string_buff[PREVIEW_STR_MAX];\r\ntime_t ti_time;\r\nstruct tm *ti_tm;\r\nconst struct wtap_pkthdr *phdr;\r\ntime(&time_preview);\r\nwhile ( (wtap_read(wth, &err, &err_info, &data_offset)) ) {\r\nphdr = wtap_phdr(wth);\r\ncur_time = nstime_to_sec(&phdr->ts);\r\nif (packets == 0) {\r\nstart_time = cur_time;\r\nstop_time = cur_time;\r\n}\r\nif (cur_time < start_time) {\r\nstart_time = cur_time;\r\n}\r\nif (cur_time > stop_time) {\r\nstop_time = cur_time;\r\n}\r\npackets++;\r\nif (packets%1000 == 0) {\r\ntime(&time_current);\r\nif (time_current-time_preview >= (time_t) prefs.gui_fileopen_preview) {\r\nis_breaked = TRUE;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (err != 0) {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "error after reading %u packets", packets);\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_PACKETS_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), string_buff);\r\nwtap_close(wth);\r\nreturn;\r\n}\r\nif (is_breaked) {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "more than %u packets (preview timeout)", packets);\r\n} else {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "%u", packets);\r\n}\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_PACKETS_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), string_buff);\r\nti_time = (long)start_time;\r\nti_tm = localtime( &ti_time );\r\nif (ti_tm) {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX,\r\n"%04d-%02d-%02d %02d:%02d:%02d",\r\nti_tm->tm_year + 1900,\r\nti_tm->tm_mon + 1,\r\nti_tm->tm_mday,\r\nti_tm->tm_hour,\r\nti_tm->tm_min,\r\nti_tm->tm_sec);\r\n} else {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "?");\r\n}\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_FIRST_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), string_buff);\r\nelapsed_time = (unsigned int)(stop_time-start_time);\r\nif (elapsed_time/86400) {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "%02u days %02u:%02u:%02u",\r\nelapsed_time/86400, elapsed_time%86400/3600, elapsed_time%3600/60, elapsed_time%60);\r\n} else {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "%02u:%02u:%02u",\r\nelapsed_time%86400/3600, elapsed_time%3600/60, elapsed_time%60);\r\n}\r\nif (is_breaked) {\r\ng_snprintf(string_buff, PREVIEW_STR_MAX, "unknown");\r\n}\r\nlabel = (GtkWidget *)g_object_get_data(G_OBJECT(prev), PREVIEW_ELAPSED_KEY);\r\ngtk_label_set_text(GTK_LABEL(label), string_buff);\r\nwtap_close(wth);\r\n}\r\nstatic void\r\nfile_open_entry_changed(GtkWidget *w _U_, gpointer file_sel)\r\n{\r\nGtkWidget *prev = (GtkWidget *)g_object_get_data(G_OBJECT(file_sel), PREVIEW_TABLE_KEY);\r\ngchar *cf_name;\r\ngboolean have_preview;\r\nwtap *wth;\r\ncf_name = gtk_file_chooser_get_filename(GTK_FILE_CHOOSER(file_sel));\r\nwth = preview_set_filename(prev, cf_name);\r\nhave_preview = (wth != NULL);\r\ng_free(cf_name);\r\ngtk_widget_set_sensitive(prev, have_preview);\r\n#if 0\r\ngtk_dialog_set_response_sensitive(file_sel, GTK_RESPONSE_ACCEPT, have_preview);\r\n#endif\r\nif (have_preview)\r\npreview_do(prev, wth);\r\n}\r\nstatic GtkWidget *\r\nadd_string_to_grid_sensitive(GtkWidget *grid, guint *row, const gchar *title, const gchar *value, gboolean sensitive)\r\n{\r\nGtkWidget *label;\r\ngchar *indent;\r\nif (strlen(value) != 0) {\r\nindent = g_strdup_printf(" %s", title);\r\n} else {\r\nindent = g_strdup(title);\r\n}\r\nlabel = gtk_label_new(indent);\r\ng_free(indent);\r\ngtk_misc_set_alignment(GTK_MISC(label), 0.0f, 0.5f);\r\ngtk_widget_set_sensitive(label, sensitive);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 0, *row, 1, 1);\r\nlabel = gtk_label_new(value);\r\ngtk_misc_set_alignment(GTK_MISC(label), 0.0f, 0.5f);\r\ngtk_widget_set_sensitive(label, sensitive);\r\nws_gtk_grid_attach_defaults(GTK_GRID(grid), label, 1, *row, 1, 1);\r\n*row = *row + 1;\r\nreturn label;\r\n}\r\nstatic GtkWidget *\r\nadd_string_to_grid(GtkWidget *grid, guint *row, const gchar *title, const gchar *value)\r\n{\r\nreturn add_string_to_grid_sensitive(grid, row, title, value, TRUE);\r\n}\r\nstatic GtkWidget *\r\npreview_new(void)\r\n{\r\nGtkWidget *grid, *label;\r\nguint row;\r\ngrid = ws_gtk_grid_new();\r\nws_gtk_grid_set_column_spacing(GTK_GRID(grid), 6);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(grid), 3);\r\nrow = 0;\r\nlabel = add_string_to_grid(grid, &row, "Format:", "-");\r\ng_object_set_data(G_OBJECT(grid), PREVIEW_FORMAT_KEY, label);\r\nlabel = add_string_to_grid(grid, &row, "Size:", "-");\r\ng_object_set_data(G_OBJECT(grid), PREVIEW_SIZE_KEY, label);\r\nlabel = add_string_to_grid(grid, &row, "Packets:", "-");\r\ng_object_set_data(G_OBJECT(grid), PREVIEW_PACKETS_KEY, label);\r\nlabel = add_string_to_grid(grid, &row, "First Packet:", "-");\r\ng_object_set_data(G_OBJECT(grid), PREVIEW_FIRST_KEY, label);\r\nlabel = add_string_to_grid(grid, &row, "Elapsed time:", "-");\r\ng_object_set_data(G_OBJECT(grid), PREVIEW_ELAPSED_KEY, label);\r\nreturn grid;\r\n}\r\nstatic gboolean\r\ngtk_open_file(GtkWidget *w, GString *file_name, gint *type, GString *display_filter)\r\n{\r\nGtkWidget *file_open_w;\r\nGtkWidget *main_hb, *main_vb, *filter_hbox, *filter_bt, *filter_te;\r\nGtkWidget *m_resolv_cb, *n_resolv_cb, *t_resolv_cb, *e_resolv_cb, *prev;\r\nGtkWidget *format_type_co;\r\nGtkCellRenderer *cell;\r\ngint i;\r\nstatic construct_args_t args = {\r\n"Wireshark: Display Filter",\r\nFALSE,\r\nFALSE,\r\nTRUE\r\n};\r\ngchar *cf_name;\r\nif (!file_name || !display_filter)\r\nreturn FALSE;\r\nfile_open_w = file_selection_new("Wireshark: Open Capture File",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_OPEN);\r\ngtk_widget_set_size_request(file_open_w, DEF_WIDTH, DEF_HEIGHT);\r\nif (file_name->len > 0) {\r\ngchar *dirname = g_path_get_dirname(file_name->str);\r\nfile_selection_set_current_folder(file_open_w, dirname);\r\ng_free(dirname);\r\n} else {\r\nswitch (prefs.gui_fileopen_style) {\r\ncase FO_STYLE_LAST_OPENED:\r\nbreak;\r\ncase FO_STYLE_SPECIFIED:\r\nif (prefs.gui_fileopen_dir[0] != '\0')\r\nfile_selection_set_current_folder(file_open_w, prefs.gui_fileopen_dir);\r\nbreak;\r\n}\r\n}\r\nmain_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_set_vexpand(main_hb, FALSE);\r\n#endif\r\nfile_selection_set_extra_widget(file_open_w, main_hb);\r\ngtk_widget_show(main_hb);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_box_pack_start(GTK_BOX(main_hb), main_vb, FALSE, FALSE, 0);\r\ngtk_widget_show(main_vb);\r\nformat_type_co = gtk_combo_box_text_new();\r\ncell = gtk_cell_renderer_text_new();\r\ngtk_cell_layout_pack_start(GTK_CELL_LAYOUT(format_type_co), cell, TRUE);\r\ngtk_widget_set_tooltip_text(format_type_co, "Format type of capture file");\r\ngtk_box_pack_start(GTK_BOX(main_vb), format_type_co, FALSE, FALSE, 0);\r\ngtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(format_type_co), (const gchar *) "Automatic");\r\nfor (i = 0; open_routines[i].name != NULL; i += 1) {\r\ngtk_combo_box_text_append_text(GTK_COMBO_BOX_TEXT(format_type_co), open_routines[i].name);\r\n}\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(format_type_co), 0);\r\ngtk_widget_show(format_type_co);\r\nfilter_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(filter_hbox), 0);\r\ngtk_box_pack_start(GTK_BOX(main_vb), filter_hbox, FALSE, FALSE, 0);\r\ngtk_widget_show(filter_hbox);\r\nfilter_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked",\r\nG_CALLBACK(display_filter_construct_cb), &args);\r\ng_signal_connect(filter_bt, "destroy",\r\nG_CALLBACK(filter_button_destroy_cb), NULL);\r\ngtk_box_pack_start(GTK_BOX(filter_hbox), filter_bt, FALSE, FALSE, 0);\r\ngtk_widget_show(filter_bt);\r\ngtk_widget_set_tooltip_text(filter_bt, "Open the \"Display Filter\" dialog to edit/apply filters");\r\nfilter_te = gtk_entry_new();\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, filter_te);\r\ngtk_box_pack_start(GTK_BOX(filter_hbox), filter_te, TRUE, TRUE, 3);\r\ng_signal_connect(filter_te, "changed",\r\nG_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_hbox), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(filter_te, "key-press-event", G_CALLBACK(filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(file_open_w, "key-press-event", G_CALLBACK(filter_parent_dlg_key_pressed_cb), NULL);\r\ncolorize_filter_te_as_empty(filter_te);\r\ngtk_entry_set_text(GTK_ENTRY(filter_te), display_filter->str);\r\ngtk_widget_show(filter_te);\r\ngtk_widget_set_tooltip_text(filter_te, "Enter a display filter.");\r\ng_object_set_data(G_OBJECT(file_open_w), E_RFILTER_TE_KEY, filter_te);\r\nm_resolv_cb = gtk_check_button_new_with_mnemonic("Enable _MAC name resolution");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(m_resolv_cb),\r\ngbl_resolv_flags.mac_name);\r\ngtk_box_pack_start(GTK_BOX(main_vb), m_resolv_cb, FALSE, FALSE, 0);\r\ngtk_widget_show(m_resolv_cb);\r\nt_resolv_cb = gtk_check_button_new_with_mnemonic("Enable _transport name resolution");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(t_resolv_cb),\r\ngbl_resolv_flags.transport_name);\r\ngtk_box_pack_start(GTK_BOX(main_vb), t_resolv_cb, FALSE, FALSE, 0);\r\ngtk_widget_show(t_resolv_cb);\r\nn_resolv_cb = gtk_check_button_new_with_mnemonic("Enable _network name resolution");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(n_resolv_cb),\r\ngbl_resolv_flags.network_name);\r\ngtk_box_pack_start(GTK_BOX(main_vb), n_resolv_cb, FALSE, FALSE, 0);\r\ngtk_widget_show(n_resolv_cb);\r\ne_resolv_cb = gtk_check_button_new_with_mnemonic("Use _external network name resolver");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(e_resolv_cb),\r\ngbl_resolv_flags.use_external_net_name_resolver);\r\ngtk_box_pack_start(GTK_BOX(main_vb), e_resolv_cb, FALSE, FALSE, 0);\r\ngtk_widget_show(e_resolv_cb);\r\nprev = preview_new();\r\ng_object_set_data(G_OBJECT(file_open_w), PREVIEW_TABLE_KEY, prev);\r\ngtk_widget_show_all(prev);\r\ngtk_box_pack_start(GTK_BOX(main_hb), prev, FALSE, FALSE, 0);\r\ng_signal_connect(GTK_FILE_CHOOSER(file_open_w), "selection-changed",\r\nG_CALLBACK(file_open_entry_changed), file_open_w);\r\nfile_open_entry_changed(file_open_w, file_open_w);\r\ng_object_set_data(G_OBJECT(file_open_w), E_DFILTER_TE_KEY,\r\ng_object_get_data(G_OBJECT(w), E_DFILTER_TE_KEY));\r\ncf_name = file_selection_run(file_open_w);\r\nif (cf_name == NULL) {\r\nreturn FALSE;\r\n}\r\ng_string_printf(file_name, "%s", cf_name);\r\ng_free(cf_name);\r\ng_string_printf(display_filter, "%s", gtk_entry_get_text(GTK_ENTRY(filter_te)));\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(m_resolv_cb)))\r\ngbl_resolv_flags.mac_name = TRUE;\r\nelse\r\ngbl_resolv_flags.mac_name = FALSE;\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(n_resolv_cb)))\r\ngbl_resolv_flags.network_name = TRUE;\r\nelse\r\ngbl_resolv_flags.network_name = FALSE;\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(t_resolv_cb)))\r\ngbl_resolv_flags.transport_name = TRUE;\r\nelse\r\ngbl_resolv_flags.transport_name = FALSE;\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(e_resolv_cb)))\r\ngbl_resolv_flags.use_external_net_name_resolver = TRUE;\r\nelse\r\ngbl_resolv_flags.use_external_net_name_resolver = FALSE;\r\n*type = gtk_combo_box_get_active((GtkComboBox *) format_type_co);\r\nwindow_destroy(GTK_WIDGET(file_open_w));\r\nreturn TRUE;\r\n}\r\nvoid\r\nfile_open_cmd_cb(GtkWidget *widget, gpointer data _U_) {\r\nif (test_file_close(&cfile, FALSE, " before opening a new capture file"))\r\nfile_open_cmd(&cfile, widget);\r\n}\r\nstatic gboolean\r\ngtk_merge_file(GtkWidget *w, GString *file_name, GString *display_filter, int *merge_type)\r\n{\r\nGtkWidget *file_merge_w;\r\nGtkWidget *main_hb, *main_vb, *filter_hbox, *filter_bt, *filter_te;\r\nGtkWidget *prepend_rb, *chrono_rb, *append_rb, *prev;\r\nstatic construct_args_t args = {\r\n"Wireshark: Display Filter",\r\nFALSE,\r\nFALSE,\r\nTRUE\r\n};\r\ngchar *cf_name;\r\nif (!file_name || !display_filter || !merge_type)\r\nreturn FALSE;\r\nfile_merge_w = file_selection_new("Wireshark: Merge with Capture File",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_OPEN);\r\ngtk_widget_set_size_request(file_merge_w, DEF_WIDTH, DEF_HEIGHT);\r\nif (file_name->len > 0) {\r\ngchar *dirname = g_path_get_dirname(file_name->str);\r\nfile_selection_set_current_folder(file_merge_w, dirname);\r\ng_free(dirname);\r\n} else {\r\nswitch (prefs.gui_fileopen_style) {\r\ncase FO_STYLE_LAST_OPENED:\r\nbreak;\r\ncase FO_STYLE_SPECIFIED:\r\nif (prefs.gui_fileopen_dir[0] != '\0')\r\nfile_selection_set_current_folder(file_merge_w, prefs.gui_fileopen_dir);\r\nbreak;\r\n}\r\n}\r\nmain_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_set_vexpand(main_hb, FALSE);\r\n#endif\r\nfile_selection_set_extra_widget(file_merge_w, main_hb);\r\ngtk_widget_show(main_hb);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\ngtk_box_pack_start(GTK_BOX(main_hb), main_vb, FALSE, FALSE, 0);\r\ngtk_widget_show(main_vb);\r\nfilter_hbox = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 1, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(filter_hbox), 0);\r\ngtk_box_pack_start(GTK_BOX(main_vb), filter_hbox, FALSE, FALSE, 0);\r\ngtk_widget_show(filter_hbox);\r\nfilter_bt = ws_gtk_button_new_from_stock(WIRESHARK_STOCK_DISPLAY_FILTER_ENTRY);\r\ng_signal_connect(filter_bt, "clicked",\r\nG_CALLBACK(display_filter_construct_cb), &args);\r\ng_signal_connect(filter_bt, "destroy",\r\nG_CALLBACK(filter_button_destroy_cb), NULL);\r\ngtk_box_pack_start(GTK_BOX(filter_hbox), filter_bt, FALSE, TRUE, 0);\r\ngtk_widget_show(filter_bt);\r\ngtk_widget_set_tooltip_text(filter_bt, "Open the \"Display Filter\" dialog to edit/apply filters");\r\nfilter_te = gtk_entry_new();\r\ng_object_set_data(G_OBJECT(filter_bt), E_FILT_TE_PTR_KEY, filter_te);\r\ngtk_box_pack_start(GTK_BOX(filter_hbox), filter_te, TRUE, TRUE, 3);\r\ng_signal_connect(filter_te, "changed",\r\nG_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_object_set_data(G_OBJECT(filter_hbox), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\ng_signal_connect(filter_te, "key-press-event", G_CALLBACK(filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(file_merge_w, "key-press-event", G_CALLBACK(filter_parent_dlg_key_pressed_cb), NULL);\r\ncolorize_filter_te_as_empty(filter_te);\r\ngtk_entry_set_text(GTK_ENTRY(filter_te), display_filter->str);\r\ngtk_widget_show(filter_te);\r\ngtk_widget_set_tooltip_text(filter_te, "Enter a display filter.");\r\ng_object_set_data(G_OBJECT(file_merge_w), E_RFILTER_TE_KEY, filter_te);\r\nprepend_rb = gtk_radio_button_new_with_mnemonic_from_widget(NULL,\r\n"Prepend packets");\r\ngtk_widget_set_tooltip_text(prepend_rb, "Insert packets from the selected file before the current file. Packet timestamps will be ignored.");\r\ngtk_box_pack_start(GTK_BOX(main_vb), prepend_rb, FALSE, FALSE, 0);\r\ngtk_widget_show(prepend_rb);\r\nchrono_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(prepend_rb), "Merge chronologically");\r\ngtk_widget_set_tooltip_text(chrono_rb, "Insert packets in chronological order.");\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(chrono_rb), TRUE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), chrono_rb, FALSE, FALSE, 0);\r\ngtk_widget_show(chrono_rb);\r\nappend_rb = gtk_radio_button_new_with_mnemonic_from_widget(GTK_RADIO_BUTTON(prepend_rb), "Append packets");\r\ngtk_widget_set_tooltip_text(append_rb, "Insert packets from the selected file after the current file. Packet timestamps will be ignored.");\r\ngtk_box_pack_start(GTK_BOX(main_vb), append_rb, FALSE, FALSE, 0);\r\ngtk_widget_show(append_rb);\r\nprev = preview_new();\r\ng_object_set_data(G_OBJECT(file_merge_w), PREVIEW_TABLE_KEY, prev);\r\ngtk_widget_show_all(prev);\r\ngtk_box_pack_start(GTK_BOX(main_hb), prev, FALSE, FALSE, 0);\r\ng_signal_connect(GTK_FILE_CHOOSER(file_merge_w), "selection-changed",\r\nG_CALLBACK(file_open_entry_changed), file_merge_w);\r\nfile_open_entry_changed(file_merge_w, file_merge_w);\r\ng_object_set_data(G_OBJECT(file_merge_w), E_DFILTER_TE_KEY,\r\ng_object_get_data(G_OBJECT(w), E_DFILTER_TE_KEY));\r\ncf_name = file_selection_run(file_merge_w);\r\nif (cf_name == NULL) {\r\nreturn FALSE;\r\n}\r\ng_string_printf(file_name, "%s", cf_name);\r\ng_free(cf_name);\r\ng_string_printf(display_filter, "%s", gtk_entry_get_text(GTK_ENTRY(filter_te)));\r\nif (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(chrono_rb))) {\r\n*merge_type = 0;\r\n} else if (gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(prepend_rb))) {\r\n*merge_type = -1;\r\n} else {\r\n*merge_type = 1;\r\n}\r\nwindow_destroy(GTK_WIDGET(file_merge_w));\r\nreturn TRUE;\r\n}\r\nvoid\r\nfile_merge_cmd_cb(GtkWidget *widget, gpointer data _U_) {\r\nGtkWidget *msg_dialog;\r\ngchar *display_basename;\r\ngint response;\r\nif (prefs.gui_ask_unsaved) {\r\nif (cf_has_unsaved_data(&cfile)) {\r\nif (cfile.is_tempfile) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"Do you want to save the captured packets before merging another capture file into it?");\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\n"A temporary capture file can't be merged.");\r\n} else {\r\ndisplay_basename = g_filename_display_basename(cfile.filename);\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"Do you want to save the changes you've made "\r\n"to the capture file \"%s\" before merging another capture file into it?",\r\ndisplay_basename);\r\ng_free(display_basename);\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\n"The changes must be saved before the files are merged.");\r\n}\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL);\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nWIRESHARK_STOCK_SAVE, GTK_RESPONSE_ACCEPT);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_ACCEPT,\r\nGTK_RESPONSE_CANCEL,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_ACCEPT);\r\nresponse = gtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\nswitch (response) {\r\ncase GTK_RESPONSE_ACCEPT:\r\ndo_file_save(&cfile, FALSE);\r\nbreak;\r\ncase GTK_RESPONSE_CANCEL:\r\ncase GTK_RESPONSE_NONE:\r\ncase GTK_RESPONSE_DELETE_EVENT:\r\ndefault:\r\nreturn;\r\n}\r\n}\r\n}\r\nfile_merge_cmd(widget);\r\n}\r\nstatic void\r\ndo_capture_stop(capture_file *cf)\r\n{\r\ncapture_stop_cb(NULL, NULL);\r\nwhile (cf->state == FILE_READ_IN_PROGRESS)\r\ngtk_main_iteration();\r\n}\r\ngboolean\r\ntest_file_close(capture_file *cf, gboolean from_quit, const char *before_what)\r\n{\r\nGtkWidget *msg_dialog;\r\ngchar *display_basename;\r\ngint response;\r\ngboolean capture_in_progress;\r\nif (cf->state == FILE_CLOSED)\r\nreturn TRUE;\r\n#ifdef HAVE_LIBPCAP\r\nif (cf->state == FILE_READ_IN_PROGRESS) {\r\ncapture_in_progress = TRUE;\r\n} else\r\n#endif\r\ncapture_in_progress = FALSE;\r\nif (prefs.gui_ask_unsaved) {\r\nif (cf_has_unsaved_data(cf) || capture_in_progress) {\r\nif (cf->is_tempfile) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\ncapture_in_progress ?\r\n"Do you want to stop the capture and save the captured packets%s?" :\r\n"Do you want to save the captured packets%s?",\r\nbefore_what);\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\n"Your captured packets will be lost if you don't save them.");\r\n} else {\r\ndisplay_basename = g_filename_display_basename(cf->filename);\r\nif (capture_in_progress) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"Do you want to stop the capture and save the captured packets%s?",\r\nbefore_what);\r\n} else {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"Do you want to save the changes you've made "\r\n"to the capture file \"%s\"%s?",\r\ndisplay_basename, before_what);\r\n}\r\ng_free(display_basename);\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\ncapture_in_progress ?\r\n"Your captured packets will be lost if you don't save them." :\r\n"Your changes will be lost if you don't save them.");\r\n}\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\n(from_quit ?\r\n(cf->state == FILE_READ_IN_PROGRESS ?\r\nWIRESHARK_STOCK_STOP_QUIT_DONT_SAVE :\r\nWIRESHARK_STOCK_QUIT_DONT_SAVE) :\r\n(capture_in_progress ?\r\nWIRESHARK_STOCK_STOP_DONT_SAVE :\r\nWIRESHARK_STOCK_DONT_SAVE)),\r\nGTK_RESPONSE_REJECT);\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL);\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\n(capture_in_progress ?\r\nWIRESHARK_STOCK_STOP_SAVE :\r\nWIRESHARK_STOCK_SAVE),\r\nGTK_RESPONSE_ACCEPT);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_ACCEPT,\r\nGTK_RESPONSE_CANCEL,\r\nGTK_RESPONSE_REJECT,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_ACCEPT);\r\nresponse = gtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\nswitch (response) {\r\ncase GTK_RESPONSE_ACCEPT:\r\n#ifdef HAVE_LIBPCAP\r\nif (capture_in_progress)\r\ndo_capture_stop(cf);\r\n#endif\r\ndo_file_save(cf, TRUE);\r\nbreak;\r\ncase GTK_RESPONSE_REJECT:\r\n#ifdef HAVE_LIBPCAP\r\nif (capture_in_progress)\r\ndo_capture_stop(cf);\r\n#endif\r\nbreak;\r\ncase GTK_RESPONSE_CANCEL:\r\ncase GTK_RESPONSE_NONE:\r\ncase GTK_RESPONSE_DELETE_EVENT:\r\ndefault:\r\nreturn FALSE;\r\n}\r\n} else {\r\nreturn TRUE;\r\n}\r\n} else {\r\n#ifdef HAVE_LIBPCAP\r\nif (capture_in_progress)\r\ndo_capture_stop(cf);\r\n#endif\r\nreturn TRUE;\r\n}\r\nreturn TRUE;\r\n}\r\ngboolean\r\ndo_file_close(capture_file *cf, gboolean from_quit, const char *before_what)\r\n{\r\nif (test_file_close(cf, from_quit, before_what)) {\r\ncf_close(cf);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nvoid\r\nfile_close_cmd_cb(GtkWidget *widget _U_, gpointer data _U_) {\r\ndo_file_close(&cfile, FALSE, "");\r\n}\r\nstatic check_savability_t\r\ncheck_save_with_comments(capture_file *cf)\r\n{\r\nguint32 comment_types;\r\nGtkWidget *msg_dialog;\r\ngint response;\r\ncomment_types = cf_comment_types(cf);\r\nif (wtap_dump_supports_comment_types(cf->cd_t, comment_types)) {\r\nreturn SAVE;\r\n}\r\nif (wtap_dump_can_write(cf->linktypes, comment_types)) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\nGTK_DIALOG_DESTROY_WITH_PARENT,\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"The capture has comments, but the file's format "\r\n"doesn't support comments. Do you want to save the capture "\r\n"in a format that supports comments, or discard the comments "\r\n"and save in the file's format?");\r\ngtk_dialog_add_buttons(GTK_DIALOG(msg_dialog),\r\n"Discard comments and save",\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\nGTK_STOCK_CANCEL,\r\nGTK_RESPONSE_CANCEL,\r\n"Save in another format",\r\nRESPONSE_SAVE_IN_ANOTHER_FORMAT,\r\nNULL);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nRESPONSE_SAVE_IN_ANOTHER_FORMAT,\r\nGTK_RESPONSE_CANCEL,\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog),\r\nRESPONSE_SAVE_IN_ANOTHER_FORMAT);\r\n} else {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\nGTK_DIALOG_DESTROY_WITH_PARENT,\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"The capture has comments, but no file format in which it "\r\n"can be saved supports comments. Do you want to discard "\r\n"the comments and save in the file's format?");\r\ngtk_dialog_add_buttons(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CANCEL,\r\nGTK_RESPONSE_CANCEL,\r\n"Discard comments and save",\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\nNULL);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\nGTK_RESPONSE_CANCEL,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_CANCEL);\r\n}\r\nresponse = gtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\nswitch (response) {\r\ncase RESPONSE_SAVE_IN_ANOTHER_FORMAT:\r\nreturn SAVE_IN_ANOTHER_FORMAT;\r\ncase RESPONSE_DISCARD_COMMENTS_AND_SAVE:\r\nreturn SAVE_WITHOUT_COMMENTS;\r\ncase GTK_RESPONSE_CANCEL:\r\ncase GTK_RESPONSE_NONE:\r\ncase GTK_RESPONSE_DELETE_EVENT:\r\ndefault:\r\nreturn CANCELLED;\r\n}\r\n}\r\nstatic void\r\ndo_file_save(capture_file *cf, gboolean dont_reopen)\r\n{\r\nchar *fname;\r\ngboolean discard_comments;\r\ncf_write_status_t status;\r\nif (cf->is_tempfile) {\r\nfile_save_as_cmd(cf, FALSE, dont_reopen);\r\n} else {\r\nif (cf->unsaved_changes) {\r\nswitch (check_save_with_comments(cf)) {\r\ncase SAVE:\r\ndiscard_comments = FALSE;\r\nbreak;\r\ncase SAVE_WITHOUT_COMMENTS:\r\ndiscard_comments = TRUE;\r\nbreak;\r\ncase SAVE_IN_ANOTHER_FORMAT:\r\nfile_save_as_cmd(cf, TRUE, dont_reopen);\r\nreturn;\r\ncase CANCELLED:\r\nreturn;\r\ndefault:\r\ng_assert_not_reached();\r\nreturn;\r\n}\r\nfname = g_strdup(cf->filename);\r\nstatus = cf_save_records(cf, fname, cf->cd_t, cf->iscompressed,\r\ndiscard_comments, dont_reopen);\r\nswitch (status) {\r\ncase CF_WRITE_OK:\r\nif (discard_comments)\r\npacket_list_queue_draw();\r\nbreak;\r\ncase CF_WRITE_ERROR:\r\nbreak;\r\ncase CF_WRITE_ABORTED:\r\nbreak;\r\n}\r\ng_free(fname);\r\n}\r\n}\r\n}\r\nvoid\r\nfile_save_cmd_cb(GtkWidget *w _U_, gpointer data _U_) {\r\ndo_file_save(&cfile, FALSE);\r\n}\r\nstatic int\r\nset_file_type_list(GtkWidget *combo_box, capture_file *cf,\r\ngboolean must_support_all_comments)\r\n{\r\nguint32 required_comment_types;\r\nGArray *savable_file_types_subtypes;\r\nguint i;\r\nint ft;\r\nint default_ft = -1;\r\nif (must_support_all_comments)\r\nrequired_comment_types = cf_comment_types(cf);\r\nelse\r\nrequired_comment_types = 0;\r\nsavable_file_types_subtypes = wtap_get_savable_file_types_subtypes(cf->cd_t,\r\ncf->linktypes,\r\nrequired_comment_types);\r\nif (savable_file_types_subtypes != NULL) {\r\nfor (i = 0; i < savable_file_types_subtypes->len; i++) {\r\nft = g_array_index(savable_file_types_subtypes, int, i);\r\nif (default_ft == -1)\r\ndefault_ft = ft;\r\nws_combo_box_append_text_and_pointer(GTK_COMBO_BOX(combo_box),\r\nwtap_file_type_subtype_string(ft),\r\nGINT_TO_POINTER(ft));\r\n}\r\ng_array_free(savable_file_types_subtypes, TRUE);\r\n}\r\nreturn default_ft;\r\n}\r\nstatic void\r\nfile_select_file_type_cb(GtkWidget *w, gpointer parent_arg)\r\n{\r\nGtkWidget *parent = (GtkWidget *)parent_arg;\r\nint new_file_type;\r\ngpointer ptr;\r\nGtkWidget *compressed_cb;\r\ncompressed_cb = (GtkWidget *)g_object_get_data(G_OBJECT(parent), E_COMPRESSED_CB_KEY);\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(w), &ptr)) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(compressed_cb), FALSE);\r\ngtk_widget_set_sensitive(compressed_cb, FALSE);\r\nreturn;\r\n}\r\nnew_file_type = GPOINTER_TO_INT(ptr);\r\nif (!wtap_dump_can_compress(new_file_type)) {\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(compressed_cb), FALSE);\r\ngtk_widget_set_sensitive(compressed_cb, FALSE);\r\n} else\r\ngtk_widget_set_sensitive(compressed_cb, TRUE);\r\n}\r\nstatic check_savability_t\r\ngtk_check_save_as_with_comments(GtkWidget *w, capture_file *cf, int file_type)\r\n{\r\nguint32 comment_types;\r\nGtkWidget *msg_dialog;\r\ngint response;\r\ncomment_types = cf_comment_types(cf);\r\nif (wtap_dump_supports_comment_types(file_type, comment_types)) {\r\nreturn SAVE;\r\n}\r\nif (wtap_dump_can_write(cf->linktypes, comment_types)) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(w),\r\nGTK_DIALOG_DESTROY_WITH_PARENT,\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"The capture has comments, but the file format you chose "\r\n"doesn't support comments. Do you want to save the capture "\r\n"in a format that supports comments, or discard the comments "\r\n"and save in the format you chose?");\r\ngtk_dialog_add_buttons(GTK_DIALOG(msg_dialog),\r\n"Discard comments and save",\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\nGTK_STOCK_CANCEL,\r\nGTK_RESPONSE_CANCEL,\r\n"Save in another format",\r\nRESPONSE_SAVE_IN_ANOTHER_FORMAT,\r\nNULL);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nRESPONSE_SAVE_IN_ANOTHER_FORMAT,\r\nGTK_RESPONSE_CANCEL,\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog),\r\nRESPONSE_SAVE_IN_ANOTHER_FORMAT);\r\n} else {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(w),\r\nGTK_DIALOG_DESTROY_WITH_PARENT,\r\nGTK_MESSAGE_QUESTION,\r\nGTK_BUTTONS_NONE,\r\n"The capture has comments, but no file format in which it "\r\n"can be saved supports comments. Do you want to discard "\r\n"the comments and save in the format you chose?");\r\ngtk_dialog_add_buttons(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CANCEL,\r\nGTK_RESPONSE_CANCEL,\r\n"Discard comments and save",\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\nNULL);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nRESPONSE_DISCARD_COMMENTS_AND_SAVE,\r\nGTK_RESPONSE_CANCEL,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_CANCEL);\r\n}\r\nresponse = gtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\nswitch (response) {\r\ncase RESPONSE_SAVE_IN_ANOTHER_FORMAT:\r\nreturn SAVE_IN_ANOTHER_FORMAT;\r\ncase RESPONSE_DISCARD_COMMENTS_AND_SAVE:\r\nreturn SAVE_WITHOUT_COMMENTS;\r\ncase GTK_RESPONSE_CANCEL:\r\ncase GTK_RESPONSE_NONE:\r\ncase GTK_RESPONSE_DELETE_EVENT:\r\ndefault:\r\nreturn CANCELLED;\r\n}\r\n}\r\nstatic gboolean\r\ngtk_save_as_file(GtkWidget *w _U_, capture_file *cf, GString *file_name, int *file_type,\r\ngboolean *compressed, gboolean must_support_all_comments)\r\n{\r\nGtkWidget *file_save_as_w;\r\nGtkWidget *main_vb, *ft_hb, *ft_lb, *ft_combo_box, *compressed_cb;\r\nint default_ft;\r\nchar *cf_name;\r\ngpointer ptr;\r\nif (!file_name || !file_type || !compressed)\r\nreturn FALSE;\r\nfile_save_as_w = file_selection_new("Wireshark: Save Capture File As",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_SAVE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\nfile_selection_set_extra_widget(file_save_as_w, main_vb);\r\ngtk_widget_show(main_vb);\r\nft_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), ft_hb, FALSE, FALSE, 0);\r\ngtk_widget_show(ft_hb);\r\nft_lb = gtk_label_new("File type:");\r\ngtk_box_pack_start(GTK_BOX(ft_hb), ft_lb, FALSE, FALSE, 0);\r\ngtk_widget_show(ft_lb);\r\nft_combo_box = ws_combo_box_new_text_and_pointer();\r\ndefault_ft = set_file_type_list(ft_combo_box, cf, must_support_all_comments);\r\ngtk_box_pack_start(GTK_BOX(ft_hb), ft_combo_box, FALSE, FALSE, 0);\r\ngtk_widget_show(ft_combo_box);\r\ng_object_set_data(G_OBJECT(file_save_as_w), E_FILE_TYPE_COMBO_BOX_KEY, ft_combo_box);\r\ncompressed_cb = gtk_check_button_new_with_label("Compress with gzip");\r\ngtk_box_pack_start(GTK_BOX(ft_hb), compressed_cb, FALSE, FALSE, 0);\r\nif (cf->iscompressed && wtap_dump_can_compress(default_ft))\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(compressed_cb), TRUE);\r\ngtk_widget_show(compressed_cb);\r\ng_object_set_data(G_OBJECT(file_save_as_w), E_COMPRESSED_CB_KEY, compressed_cb);\r\ng_signal_connect(ft_combo_box, "changed", G_CALLBACK(file_select_file_type_cb), file_save_as_w);\r\nws_combo_box_set_active(GTK_COMBO_BOX(ft_combo_box), 0);\r\ncf_name = file_selection_run(file_save_as_w);\r\nif (cf_name == NULL) {\r\nreturn FALSE;\r\n}\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(ft_combo_box), &ptr)) {\r\ng_assert_not_reached();\r\n}\r\n*file_type = GPOINTER_TO_INT(ptr);\r\n*compressed = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(compressed_cb));\r\nwindow_destroy(GTK_WIDGET(file_save_as_w));\r\ng_string_printf(file_name, "%s", cf_name);\r\ng_free(cf_name);\r\nreturn TRUE;\r\n}\r\nstatic void\r\nfile_add_extension(GString *file_name, int file_type, gboolean compressed) {\r\ngchar *file_name_lower;\r\nGString *file_suffix;\r\nGSList *extensions_list, *extension;\r\ngboolean add_extension;\r\nfile_name_lower = g_utf8_strdown(file_name->str, -1);\r\nfile_suffix = g_string_new("");\r\nextensions_list = wtap_get_file_extensions_list(file_type, FALSE);\r\nif (extensions_list != NULL) {\r\nadd_extension = TRUE;\r\nfor (extension = extensions_list; extension != NULL;\r\nextension = g_slist_next(extension)) {\r\ng_string_printf(file_suffix, ".%s", (char *)extension->data);\r\nif (g_str_has_suffix(file_name_lower, file_suffix->str)) {\r\nadd_extension = FALSE;\r\nbreak;\r\n}\r\ng_string_append(file_suffix, ".gz");\r\nif (g_str_has_suffix(file_name_lower, file_suffix->str)) {\r\nadd_extension = FALSE;\r\nbreak;\r\n}\r\n}\r\n} else {\r\nadd_extension = FALSE;\r\n}\r\ng_free(file_name_lower);\r\ng_string_free(file_suffix, TRUE);\r\nif (add_extension) {\r\nif (wtap_default_file_extension(file_type) != NULL) {\r\ng_string_append_printf(file_name, ".%s",\r\nwtap_default_file_extension(file_type));\r\nif (compressed) {\r\ng_string_append(file_name, ".gz");\r\n}\r\n}\r\n}\r\n}\r\nvoid\r\nfile_save_as_cmd_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nfile_save_as_cmd(&cfile, FALSE, FALSE);\r\n}\r\nstatic gboolean\r\ngtk_export_specified_packets_file(GtkWidget *w _U_, GString *file_name, int *file_type,\r\ngboolean *compressed, packet_range_t *range)\r\n{\r\nGtkWidget *file_export_specified_packets_w;\r\nGtkWidget *main_vb, *ft_hb, *ft_lb, *ft_combo_box, *range_fr, *range_grid,\r\n*compressed_cb;\r\nchar *cf_name;\r\ngpointer ptr;\r\nif (!file_name || !file_type || !compressed || !range)\r\nreturn FALSE;\r\nfile_export_specified_packets_w = file_selection_new("Wireshark: Export Specified Packets",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_SAVE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 5, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\nfile_selection_set_extra_widget(file_export_specified_packets_w, main_vb);\r\ngtk_widget_show(main_vb);\r\nrange_fr = gtk_frame_new("Packet Range");\r\ngtk_box_pack_start(GTK_BOX(main_vb), range_fr, FALSE, FALSE, 0);\r\ngtk_widget_show(range_fr);\r\nrange_grid = range_new(range, TRUE);\r\ngtk_container_add(GTK_CONTAINER(range_fr), range_grid);\r\ngtk_widget_show(range_grid);\r\nft_hb = ws_gtk_box_new(GTK_ORIENTATION_HORIZONTAL, 3, FALSE);\r\ngtk_box_pack_start(GTK_BOX(main_vb), ft_hb, FALSE, FALSE, 0);\r\ngtk_widget_show(ft_hb);\r\nft_lb = gtk_label_new("File type:");\r\ngtk_box_pack_start(GTK_BOX(ft_hb), ft_lb, FALSE, FALSE, 0);\r\ngtk_widget_show(ft_lb);\r\nft_combo_box = ws_combo_box_new_text_and_pointer();\r\nset_file_type_list(ft_combo_box, &cfile, FALSE);\r\ngtk_box_pack_start(GTK_BOX(ft_hb), ft_combo_box, FALSE, FALSE, 0);\r\ngtk_widget_show(ft_combo_box);\r\ng_object_set_data(G_OBJECT(file_export_specified_packets_w), E_FILE_TYPE_COMBO_BOX_KEY, ft_combo_box);\r\nrange_update_dynamics(range_grid);\r\ncompressed_cb = gtk_check_button_new_with_label("Compress with gzip");\r\ngtk_box_pack_start(GTK_BOX(ft_hb), compressed_cb, FALSE, FALSE, 0);\r\ngtk_widget_show(compressed_cb);\r\ng_object_set_data(G_OBJECT(file_export_specified_packets_w), E_COMPRESSED_CB_KEY, compressed_cb);\r\ng_signal_connect(ft_combo_box, "changed", G_CALLBACK(file_select_file_type_cb), file_export_specified_packets_w);\r\nws_combo_box_set_active(GTK_COMBO_BOX(ft_combo_box), 0);\r\ncf_name = file_selection_run(file_export_specified_packets_w);\r\nif (cf_name == NULL) {\r\nreturn FALSE;\r\n}\r\nif (! ws_combo_box_get_active_pointer(GTK_COMBO_BOX(ft_combo_box), &ptr)) {\r\ng_assert_not_reached();\r\n}\r\n*file_type = GPOINTER_TO_INT(ptr);\r\n*compressed = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(compressed_cb));\r\nwindow_destroy(GTK_WIDGET(file_export_specified_packets_w));\r\ng_string_printf(file_name, "%s", cf_name);\r\ng_free(cf_name);\r\nreturn TRUE;\r\n}\r\nvoid\r\nfile_export_pdu_ok_cb(GtkWidget *widget _U_, gpointer data)\r\n{\r\nGtkWidget *msg_dialog;\r\ngchar *display_basename;\r\ngint response;\r\nif (prefs.gui_ask_unsaved && cf_has_unsaved_data(&cfile)) {\r\nif (cfile.is_tempfile) {\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION, GTK_BUTTONS_NONE,\r\n"Do you want to save the captured packets before exporting PDUs?");\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\n"After the export, the captured packets will no longer be accessible.");\r\n}\r\nelse {\r\ndisplay_basename = g_filename_display_basename(cfile.filename);\r\nmsg_dialog = gtk_message_dialog_new(GTK_WINDOW(top_level),\r\n(GtkDialogFlags)(GTK_DIALOG_MODAL|GTK_DIALOG_DESTROY_WITH_PARENT),\r\nGTK_MESSAGE_QUESTION, GTK_BUTTONS_NONE,\r\n"Do you want to save the changes you've made "\r\n"to the capture file \"%s\" before exporting PDUs from it?",\r\ndisplay_basename);\r\ng_free(display_basename);\r\ngtk_message_dialog_format_secondary_text(GTK_MESSAGE_DIALOG(msg_dialog),\r\n"Unsaved changes will be discarded when PDUs are exported.");\r\n}\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nWIRESHARK_STOCK_DONT_SAVE, GTK_RESPONSE_CLOSE);\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nGTK_STOCK_CANCEL, GTK_RESPONSE_CANCEL);\r\ngtk_dialog_add_button(GTK_DIALOG(msg_dialog),\r\nWIRESHARK_STOCK_SAVE, GTK_RESPONSE_ACCEPT);\r\ngtk_dialog_set_alternative_button_order(GTK_DIALOG(msg_dialog),\r\nGTK_RESPONSE_ACCEPT,\r\nGTK_RESPONSE_CANCEL,\r\nGTK_RESPONSE_CLOSE,\r\n-1);\r\ngtk_dialog_set_default_response(GTK_DIALOG(msg_dialog), GTK_RESPONSE_ACCEPT);\r\nresponse = gtk_dialog_run(GTK_DIALOG(msg_dialog));\r\ngtk_widget_destroy(msg_dialog);\r\nswitch (response) {\r\ncase GTK_RESPONSE_CLOSE:\r\nbreak;\r\ncase GTK_RESPONSE_ACCEPT:\r\ndo_file_save(&cfile, FALSE);\r\nbreak;\r\ncase GTK_RESPONSE_CANCEL:\r\ncase GTK_RESPONSE_NONE:\r\ncase GTK_RESPONSE_DELETE_EVENT:\r\ndefault:\r\nreturn;\r\n}\r\n}\r\nexport_pdu_action(data);\r\n}\r\nvoid\r\nfile_reload_cmd_cb(GtkWidget *w _U_, gpointer data _U_) {\r\ncf_reload(&cfile);\r\n}\r\nstatic void\r\ncolor_global_cb(GtkWidget *widget _U_, gpointer data)\r\n{\r\nGtkWidget *fs_widget = (GtkWidget *)data;\r\ngchar *path;\r\npath = get_datafile_path("colorfilters");\r\ngtk_file_chooser_select_filename(GTK_FILE_CHOOSER(fs_widget), path);\r\ng_free(path);\r\n}\r\nvoid\r\nfile_color_import_cmd_cb(GtkWidget *color_filters, gpointer filter_list _U_)\r\n{\r\n#ifdef USE_WIN32_FILE_DIALOGS\r\nwin32_import_color_file(GDK_WINDOW_HWND(gtk_widget_get_window(top_level)), color_filters);\r\n#else\r\nGtkWidget *main_vb, *cfglobal_but;\r\ngchar *cf_name, *s;\r\nfile_color_import_w = file_selection_new("Wireshark: Import Color Filters",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_OPEN);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\nfile_selection_set_extra_widget(file_color_import_w, main_vb);\r\ngtk_widget_show(main_vb);\r\ncfglobal_but = gtk_button_new_with_label("Global Color Filter File");\r\ngtk_box_pack_start(GTK_BOX(main_vb), cfglobal_but, FALSE, FALSE, 0);\r\ng_signal_connect(cfglobal_but, "clicked",\r\nG_CALLBACK(color_global_cb), file_color_import_w);\r\ngtk_widget_show(cfglobal_but);\r\nfor (;;) {\r\ncf_name = file_selection_run(file_color_import_w);\r\nif (cf_name == NULL) {\r\nreturn;\r\n}\r\nif (!color_filters_import(cf_name, color_filters)) {\r\ng_free(cf_name);\r\ncontinue;\r\n}\r\nwindow_destroy(GTK_WIDGET(file_color_import_w));\r\ns = get_dirname(cf_name);\r\nset_last_open_dir(s);\r\ng_free(cf_name);\r\nreturn;\r\n}\r\n#endif\r\n}\r\nstatic void\r\ncolor_set_export_selected_sensitive(GtkWidget * cfselect_cb)\r\n{\r\nif (color_selected_count() != 0)\r\ngtk_widget_set_sensitive(cfselect_cb, TRUE);\r\nelse {\r\ncolor_selected = FALSE;\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(cfselect_cb), FALSE);\r\ngtk_widget_set_sensitive(cfselect_cb, FALSE);\r\n}\r\n}\r\nstatic void\r\ncolor_toggle_selected_cb(GtkWidget *widget, gpointer data _U_)\r\n{\r\ncolor_selected = gtk_toggle_button_get_active(GTK_TOGGLE_BUTTON(widget));\r\n}\r\nvoid\r\nfile_color_export_cmd_cb(GtkWidget *w _U_, gpointer filter_list)\r\n{\r\n#ifdef USE_WIN32_FILE_DIALOGS\r\nwin32_export_color_file(GDK_WINDOW_HWND(gtk_widget_get_window(top_level)), &cfile, filter_list);\r\n#else\r\nGtkWidget *file_color_export_w;\r\nGtkWidget *main_vb, *cfglobal_but;\r\nGtkWidget *cfselect_cb;\r\ngchar *cf_name;\r\ngchar *dirname;\r\ncolor_selected = FALSE;\r\nfile_color_export_w = file_selection_new("Wireshark: Export Color Filters",\r\nGTK_WINDOW(top_level),\r\nFILE_SELECTION_SAVE);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 3, FALSE);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 5);\r\nfile_selection_set_extra_widget(file_color_export_w, main_vb);\r\ngtk_widget_show(main_vb);\r\ncfselect_cb = gtk_check_button_new_with_label("Export only selected filters");\r\ngtk_box_pack_start(GTK_BOX(main_vb), cfselect_cb, FALSE, FALSE, 0);\r\ngtk_toggle_button_set_active(GTK_TOGGLE_BUTTON(cfselect_cb), FALSE);\r\ng_signal_connect(cfselect_cb, "toggled",\r\nG_CALLBACK(color_toggle_selected_cb), NULL);\r\ngtk_widget_show(cfselect_cb);\r\ncolor_set_export_selected_sensitive(cfselect_cb);\r\ncfglobal_but = gtk_button_new_with_label("Global Color Filter File");\r\ngtk_box_pack_start(GTK_BOX(main_vb), cfglobal_but, FALSE, FALSE, 0);\r\ng_signal_connect(cfglobal_but, "clicked",\r\nG_CALLBACK(color_global_cb), file_color_export_w);\r\ngtk_widget_show(cfglobal_but);\r\nfor (;;) {\r\ncf_name = file_selection_run(file_color_export_w);\r\nif (cf_name == NULL) {\r\nreturn;\r\n}\r\n#ifndef _WIN32\r\nif (!file_target_unwritable_ui(file_color_export_w, cf_name)) {\r\ng_free(cf_name);\r\ncontinue;\r\n}\r\n#endif\r\nif (!color_filters_export(cf_name, (GSList *)filter_list, color_selected)) {\r\ng_free(cf_name);\r\ncontinue;\r\n}\r\nwindow_destroy(GTK_WIDGET(file_color_export_w));\r\ndirname = get_dirname(cf_name);\r\nset_last_open_dir(dirname);\r\ng_free(cf_name);\r\n}\r\n#endif\r\n}

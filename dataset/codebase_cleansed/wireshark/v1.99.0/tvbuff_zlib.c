tvbuff_t *\r\ntvb_uncompress(tvbuff_t *tvb, const int offset, int comprlen)\r\n{\r\ngint err = Z_OK;\r\nguint bytes_out = 0;\r\nguint8 *compr = NULL;\r\nguint8 *uncompr = NULL;\r\ntvbuff_t *uncompr_tvb = NULL;\r\nz_streamp strm = NULL;\r\nBytef *strmbuf = NULL;\r\nguint inits_done = 0;\r\ngint wbits = MAX_WBITS;\r\nguint8 *next = NULL;\r\nguint bufsiz = TVB_Z_MIN_BUFSIZ;\r\n#ifdef TVB_Z_DEBUG\r\nguint inflate_passes = 0;\r\nguint bytes_in = tvb_length_remaining(tvb, offset);\r\n#endif\r\nif (tvb == NULL) {\r\nreturn NULL;\r\n}\r\ncompr = (guint8 *)tvb_memdup(NULL, tvb, offset, comprlen);\r\nif (!compr)\r\nreturn NULL;\r\nbufsiz = tvb_length_remaining(tvb, offset) * 2;\r\nbufsiz = CLAMP(bufsiz, TVB_Z_MIN_BUFSIZ, TVB_Z_MAX_BUFSIZ);\r\n#ifdef TVB_Z_DEBUG\r\nprintf("bufsiz: %u bytes\n", bufsiz);\r\n#endif\r\nnext = compr;\r\nstrm = g_new0(z_stream, 1);\r\nstrm->next_in = next;\r\nstrm->avail_in = comprlen;\r\nstrmbuf = (Bytef *)g_malloc0(bufsiz);\r\nstrm->next_out = strmbuf;\r\nstrm->avail_out = bufsiz;\r\nerr = inflateInit2(strm, wbits);\r\ninits_done = 1;\r\nif (err != Z_OK) {\r\ninflateEnd(strm);\r\ng_free(strm);\r\ng_free(compr);\r\ng_free(strmbuf);\r\nreturn NULL;\r\n}\r\nwhile (1) {\r\nmemset(strmbuf, '\0', bufsiz);\r\nstrm->next_out = strmbuf;\r\nstrm->avail_out = bufsiz;\r\nerr = inflate(strm, Z_SYNC_FLUSH);\r\nif (err == Z_OK || err == Z_STREAM_END) {\r\nguint bytes_pass = bufsiz - strm->avail_out;\r\n#ifdef TVB_Z_DEBUG\r\n++inflate_passes;\r\n#endif\r\nif (uncompr == NULL) {\r\nuncompr = (guint8 *)((bytes_pass || err != Z_STREAM_END) ?\r\ng_memdup(strmbuf, bytes_pass) :\r\ng_strdup(""));\r\n} else {\r\nguint8 *new_data = (guint8 *)g_malloc0(bytes_out + bytes_pass);\r\nmemcpy(new_data, uncompr, bytes_out);\r\nmemcpy(new_data + bytes_out, strmbuf, bytes_pass);\r\ng_free(uncompr);\r\nuncompr = new_data;\r\n}\r\nbytes_out += bytes_pass;\r\nif (err == Z_STREAM_END) {\r\ninflateEnd(strm);\r\ng_free(strm);\r\ng_free(strmbuf);\r\nbreak;\r\n}\r\n} else if (err == Z_BUF_ERROR) {\r\ninflateEnd(strm);\r\ng_free(strm);\r\ng_free(strmbuf);\r\nif (uncompr != NULL) {\r\nbreak;\r\n} else {\r\ng_free(compr);\r\nreturn NULL;\r\n}\r\n} else if (err == Z_DATA_ERROR && inits_done == 1\r\n&& uncompr == NULL && (*compr == 0x1f) &&\r\n(*(compr + 1) == 0x8b)) {\r\nBytef *c = compr + 2;\r\nBytef flags = 0;\r\nif (*c == Z_DEFLATED) {\r\nc++;\r\n} else {\r\ninflateEnd(strm);\r\ng_free(strm);\r\ng_free(compr);\r\ng_free(strmbuf);\r\nreturn NULL;\r\n}\r\nflags = *c;\r\nc += 7;\r\nif (flags & (1 << 2)) {\r\ngint xsize = (gint)(*c |\r\n(*(c + 1) << 8));\r\nc += xsize;\r\n}\r\nif (flags & (1 << 3)) {\r\nwhile ((c - compr) < comprlen && *c != '\0') {\r\nc++;\r\n}\r\nc++;\r\n}\r\nif (flags & (1 << 4)) {\r\nwhile ((c - compr) < comprlen && *c != '\0') {\r\nc++;\r\n}\r\nc++;\r\n}\r\ninflateReset(strm);\r\nnext = c;\r\nstrm->next_in = next;\r\nif (c - compr > comprlen) {\r\ninflateEnd(strm);\r\ng_free(strm);\r\ng_free(compr);\r\ng_free(strmbuf);\r\nreturn NULL;\r\n}\r\ncomprlen -= (int) (c - compr);\r\ninflateEnd(strm);\r\ninflateInit2(strm, wbits);\r\ninits_done++;\r\n} else if (err == Z_DATA_ERROR && uncompr == NULL &&\r\ninits_done <= 3) {\r\nwbits = -MAX_WBITS;\r\ninflateReset(strm);\r\nstrm->next_in = next;\r\nstrm->avail_in = comprlen;\r\ninflateEnd(strm);\r\nmemset(strmbuf, '\0', bufsiz);\r\nstrm->next_out = strmbuf;\r\nstrm->avail_out = bufsiz;\r\nerr = inflateInit2(strm, wbits);\r\ninits_done++;\r\nif (err != Z_OK) {\r\ng_free(strm);\r\ng_free(strmbuf);\r\ng_free(compr);\r\ng_free(uncompr);\r\nreturn NULL;\r\n}\r\n} else {\r\ninflateEnd(strm);\r\ng_free(strm);\r\ng_free(strmbuf);\r\nif (uncompr == NULL) {\r\ng_free(compr);\r\nreturn NULL;\r\n}\r\nbreak;\r\n}\r\n}\r\n#ifdef TVB_Z_DEBUG\r\nprintf("inflate() total passes: %u\n", inflate_passes);\r\nprintf("bytes in: %u\nbytes out: %u\n\n", bytes_in, bytes_out);\r\n#endif\r\nif (uncompr != NULL) {\r\nuncompr_tvb = tvb_new_real_data((guint8*) uncompr, bytes_out, bytes_out);\r\ntvb_set_free_cb(uncompr_tvb, g_free);\r\n}\r\ng_free(compr);\r\nreturn uncompr_tvb;\r\n}\r\ntvbuff_t *\r\ntvb_uncompress(tvbuff_t *tvb _U_, const int offset _U_, int comprlen _U_)\r\n{\r\nreturn NULL;\r\n}\r\ntvbuff_t *\r\ntvb_child_uncompress(tvbuff_t *parent, tvbuff_t *tvb, const int offset, int comprlen)\r\n{\r\ntvbuff_t *new_tvb = tvb_uncompress(tvb, offset, comprlen);\r\nif (new_tvb)\r\ntvb_set_child_real_data_tvbuff (parent, new_tvb);\r\nreturn new_tvb;\r\n}

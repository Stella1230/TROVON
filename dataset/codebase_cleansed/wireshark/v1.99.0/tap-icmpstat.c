static void\r\nicmpstat_reset(void *tapdata)\r\n{\r\nicmpstat_t *icmpstat = (icmpstat_t *)tapdata;\r\ng_slist_free(icmpstat->rt_list);\r\nmemset(icmpstat, 0, sizeof(icmpstat_t));\r\nicmpstat->min_msecs = 1.0 * G_MAXUINT;\r\n}\r\nstatic gint compare_doubles(gconstpointer a, gconstpointer b)\r\n{\r\ndouble ad, bd;\r\nad = *(const double *)a;\r\nbd = *(const double *)b;\r\nif (ad < bd)\r\nreturn -1;\r\nif (ad > bd)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nicmpstat_packet(void *tapdata, packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *data)\r\n{\r\nicmpstat_t *icmpstat = (icmpstat_t *)tapdata;\r\nconst icmp_transaction_t *trans = (const icmp_transaction_t *)data;\r\ndouble resp_time, *rt;\r\nif (trans == NULL)\r\nreturn 0;\r\nif (trans->resp_frame) {\r\nresp_time = nstime_to_msec(&trans->resp_time);\r\nrt = g_new(double,1);\r\nif (rt == NULL)\r\nreturn 0;\r\n*rt = resp_time;\r\nicmpstat->rt_list = g_slist_prepend(icmpstat->rt_list, rt);\r\nicmpstat->num_resps++;\r\nif (icmpstat->min_msecs > resp_time) {\r\nicmpstat->min_frame = trans->resp_frame;\r\nicmpstat->min_msecs = resp_time;\r\n}\r\nif (icmpstat->max_msecs < resp_time) {\r\nicmpstat->max_frame = trans->resp_frame;\r\nicmpstat->max_msecs = resp_time;\r\n}\r\nicmpstat->tot_msecs += resp_time;\r\n} else if (trans->rqst_frame)\r\nicmpstat->num_rqsts++;\r\nelse\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void compute_stats(icmpstat_t *icmpstat, double *mean, double *med, double *sdev)\r\n{\r\nGSList *slist;\r\ndouble diff;\r\ndouble sq_diff_sum = 0.0;\r\nicmpstat->rt_list = g_slist_sort(icmpstat->rt_list, compare_doubles);\r\nslist = icmpstat->rt_list;\r\nif (icmpstat->num_resps == 0 || slist == NULL) {\r\n*mean = 0.0;\r\n*med = 0.0;\r\n*sdev = 0.0;\r\nreturn;\r\n}\r\n*mean = icmpstat->tot_msecs / icmpstat->num_resps;\r\nif (icmpstat->num_resps & 1)\r\n*med = *(double *)g_slist_nth_data(slist, icmpstat->num_resps / 2);\r\nelse {\r\n*med =\r\n(*(double *)g_slist_nth_data(slist, (icmpstat->num_resps - 1) / 2) +\r\n*(double *)g_slist_nth_data(slist, icmpstat->num_resps / 2)) / 2;\r\n}\r\nfor ( ; slist; slist = g_slist_next(slist)) {\r\ndiff = *(double *)slist->data - *mean;\r\nsq_diff_sum += diff * diff;\r\n}\r\nif (icmpstat->num_resps > 1)\r\n*sdev = sqrt(sq_diff_sum / (icmpstat->num_resps - 1));\r\nelse\r\n*sdev = 0.0;\r\n}\r\nstatic void\r\nicmpstat_draw(void *tapdata)\r\n{\r\nicmpstat_t *icmpstat = (icmpstat_t *)tapdata;\r\nunsigned int lost;\r\ndouble mean, sdev, med;\r\nprintf("\n");\r\nprintf("==========================================================================\n");\r\nprintf("ICMP Service Response Time (SRT) Statistics (all times in ms):\n");\r\nprintf("Filter: %s\n", icmpstat->filter ? icmpstat->filter : "<none>");\r\nprintf("\nRequests Replies Lost %% Loss\n");\r\nif (icmpstat->num_rqsts) {\r\nlost = icmpstat->num_rqsts - icmpstat->num_resps;\r\ncompute_stats(icmpstat, &mean, &med, &sdev);\r\nprintf("%-10u%-10u%-10u%5.1f%%\n\n",\r\nicmpstat->num_rqsts, icmpstat->num_resps, lost,\r\n100.0 * lost / icmpstat->num_rqsts);\r\nprintf("Minimum Maximum Mean Median SDeviation Min Frame Max Frame\n");\r\nprintf("%-10.3f%-10.3f%-10.3f%-10.3f%-10.3f %-10u%-10u\n",\r\nicmpstat->min_msecs >= G_MAXUINT ? 0.0 : icmpstat->min_msecs,\r\nicmpstat->max_msecs, mean, med, sdev,\r\nicmpstat->min_frame, icmpstat->max_frame);\r\n} else {\r\nprintf("0 0 0 0.0%%\n\n");\r\nprintf("Minimum Maximum Mean Median SDeviation Min Frame Max Frame\n");\r\nprintf("0.000 0.000 0.000 0.000 0.000 0 0\n");\r\n}\r\nprintf("==========================================================================\n");\r\n}\r\nstatic void\r\nicmpstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nicmpstat_t *icmpstat;\r\nconst char *filter = NULL;\r\nGString *error_string;\r\nif (strstr(opt_arg, "icmp,srt,"))\r\nfilter = opt_arg + strlen("icmp,srt,");\r\nicmpstat = (icmpstat_t *)g_try_malloc(sizeof(icmpstat_t));\r\nif (icmpstat == NULL) {\r\nfprintf(stderr, "tshark: g_try_malloc() fatal error.\n");\r\nexit(1);\r\n}\r\nmemset(icmpstat, 0, sizeof(icmpstat_t));\r\nicmpstat->min_msecs = 1.0 * G_MAXUINT;\r\nif (filter)\r\nicmpstat->filter = g_strdup(filter);\r\nerror_string = register_tap_listener("icmp", icmpstat, icmpstat->filter,\r\nTL_REQUIRES_NOTHING, icmpstat_reset, icmpstat_packet, icmpstat_draw);\r\nif (error_string) {\r\nif (icmpstat->filter)\r\ng_free(icmpstat->filter);\r\ng_free(icmpstat);\r\nfprintf(stderr, "tshark: Couldn't register icmp,srt tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_icmpstat(void)\r\n{\r\nregister_stat_cmd_arg("icmp,srt", icmpstat_init, NULL);\r\n}

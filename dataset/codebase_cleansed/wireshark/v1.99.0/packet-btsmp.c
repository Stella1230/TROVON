static int\r\ndissect_btsmp_auth_req(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree)\r\n{\r\nproto_item *ti_param;\r\nproto_tree *st_param;\r\nguint8 param;\r\nparam = tvb_get_guint8(tvb, offset);\r\nti_param = proto_tree_add_item(tree, hf_btsmp_authreq, tvb, offset, 1, ENC_NA);\r\nst_param = proto_item_add_subtree(ti_param, ett_btsmp_auth_req);\r\nproto_tree_add_item(st_param, hf_btsmp_bonding_flags, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_item_append_text(ti_param, "%s, ", val_to_str_const(param & 0x03, bonding_flag_vals, "<unknown>"));\r\nproto_tree_add_item(st_param, hf_btsmp_mitm_flag, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_item_append_text(ti_param, "%s", (param & 0x04) ? "MITM" : "No MITM");\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, "%s, %s", val_to_str_const(param & 0x03, bonding_flag_vals, "<unknown>"), (param & 0x04) ? "MITM" : "No MITM");\r\nreturn offset + 1;\r\n}\r\nstatic int\r\ndissect_btsmp_key_dist(tvbuff_t *tvb, int offset, packet_info *pinfo, proto_tree *tree, gboolean initiator)\r\n{\r\nproto_item *ti_param;\r\nproto_tree *st_param;\r\nguint8 param;\r\nparam = tvb_get_guint8(tvb, offset);\r\nif (initiator) {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", Initiator Key(s): ");\r\nti_param = proto_tree_add_item(tree, hf_btsmp_initiator_key_distribution, tvb, offset, 1, ENC_NA);\r\n}\r\nelse {\r\ncol_append_str(pinfo->cinfo, COL_INFO, ", Responder Key(s): ");\r\nti_param = proto_tree_add_item(tree, hf_btsmp_responder_key_distribution, tvb, offset, 1, ENC_NA);\r\n}\r\nst_param = proto_item_add_subtree(ti_param, ett_btsmp_key_dist);\r\nproto_tree_add_item(st_param, hf_btsmp_key_dist_enc, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(st_param, hf_btsmp_key_dist_id, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nproto_tree_add_item(st_param, hf_btsmp_key_dist_sign, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\nif (param & 0x01) {\r\nproto_item_append_text(ti_param, "LTK ");\r\ncol_append_str(pinfo->cinfo, COL_INFO, "LTK ");\r\n}\r\nif (param & 0x02) {\r\nproto_item_append_text(ti_param, "IRK ");\r\ncol_append_str(pinfo->cinfo, COL_INFO, "IRK ");\r\n}\r\nif (param & 0x04) {\r\nproto_item_append_text(ti_param, "CSRK ");\r\ncol_append_str(pinfo->cinfo, COL_INFO, "CSRK ");\r\n}\r\nreturn offset + 1;\r\n}\r\nstatic int\r\ndissect_btsmp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nint offset = 0;\r\nproto_item *ti;\r\nproto_tree *st;\r\nguint8 opcode;\r\nti = proto_tree_add_item(tree, proto_btsmp, tvb, 0, -1, ENC_NA);\r\nst = proto_item_add_subtree(ti, ett_btsmp);\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SMP");\r\nswitch (pinfo->p2p_dir) {\r\ncase P2P_DIR_SENT:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Sent ");\r\nbreak;\r\ncase P2P_DIR_RECV:\r\ncol_set_str(pinfo->cinfo, COL_INFO, "Rcvd ");\r\nbreak;\r\ndefault:\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "Unknown direction %d ",\r\npinfo->p2p_dir);\r\nbreak;\r\n}\r\nif (tvb_length_remaining(tvb, 0) < 1)\r\nreturn FALSE;\r\nproto_tree_add_item(st, hf_btsmp_opcode, tvb, 0, 1, ENC_LITTLE_ENDIAN);\r\nopcode = tvb_get_guint8(tvb, 0);\r\noffset++;\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str_const(opcode, opcode_vals, "<unknown>"));\r\nswitch (opcode) {\r\ncase 0x01:\r\ncase 0x02:\r\n{\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": ");\r\nproto_tree_add_item(st, hf_btsmp_io_capabilities, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\nproto_tree_add_item(st, hf_btsmp_oob_data_flags, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\noffset = dissect_btsmp_auth_req(tvb, offset, pinfo, st);\r\nproto_tree_add_item(st, hf_btsmp_max_enc_key_size, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\noffset++;\r\noffset = dissect_btsmp_key_dist(tvb, offset, pinfo, st, TRUE);\r\noffset = dissect_btsmp_key_dist(tvb, offset, pinfo, st, FALSE);\r\nbreak;\r\n}\r\ncase 0x03:\r\nproto_tree_add_item(st, hf_btsmp_cfm_value, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ncase 0x04:\r\nproto_tree_add_item(st, hf_btsmp_random, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ncase 0x05:\r\nproto_tree_add_item(st, hf_btsmp_reason, tvb, offset, 1, ENC_LITTLE_ENDIAN);\r\ncol_append_fstr(pinfo->cinfo, COL_INFO, ": %s", val_to_str_const(tvb_get_guint8(tvb, offset), reason_vals, "<unknown>"));\r\noffset++;\r\nbreak;\r\ncase 0x06:\r\nproto_tree_add_item(st, hf_btsmp_long_term_key, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ncase 0x07:\r\nproto_tree_add_item(st, hf_btsmp_ediv, tvb, offset, 2, ENC_LITTLE_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(st, hf_btsmp_random, tvb, offset, 8, ENC_NA);\r\noffset += 8;\r\nbreak;\r\ncase 0x08:\r\nproto_tree_add_item(st, hf_btsmp_id_resolving_key, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ncase 0x0a:\r\nproto_tree_add_item(st, hf_btsmp_signature_key, tvb, offset, 16, ENC_NA);\r\noffset += 16;\r\nbreak;\r\ncase 0x0b:\r\ncol_append_str(pinfo->cinfo, COL_INFO, ": ");\r\noffset = dissect_btsmp_auth_req(tvb, offset, pinfo, st);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn offset;\r\n}\r\nvoid\r\nproto_register_btsmp(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{&hf_btsmp_opcode,\r\n{"Opcode", "btsmp.opcode",\r\nFT_UINT8, BASE_HEX, VALS(opcode_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_reason,\r\n{"Reason", "btsmp.reason",\r\nFT_UINT8, BASE_HEX, VALS(reason_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_io_capabilities,\r\n{"IO Capability", "btsmp.io_capability",\r\nFT_UINT8, BASE_HEX, VALS(io_capability_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_oob_data_flags,\r\n{"OOB Data Flags", "btsmp.oob_data_flags",\r\nFT_UINT8, BASE_HEX, VALS(oob_data_flag_vals), 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_cfm_value,\r\n{"Confirm Value", "btsmp.cfm_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_random,\r\n{"Random Value", "btsmp.random_value",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_long_term_key,\r\n{"Long Term Key", "btsmp.long_term_key",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_id_resolving_key,\r\n{"Identity Resolving Key", "btsmp.id_resolving_key",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_signature_key,\r\n{"Signature Key", "btsmp.signature_key",\r\nFT_BYTES, BASE_NONE, NULL, 0x0,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_bonding_flags,\r\n{"Bonding Flags", "btsmp.bonding_flags",\r\nFT_UINT8, BASE_HEX, VALS(bonding_flag_vals), 0x03,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_mitm_flag,\r\n{"MITM Flag", "btsmp.mitm_flag",\r\nFT_UINT8, BASE_DEC, NULL, 0x04,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_max_enc_key_size,\r\n{"Max Encryption Key Size", "btsmp.max_enc_key_size",\r\nFT_UINT8, BASE_DEC, NULL, 0x00,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_key_dist_enc,\r\n{"Encryption Key (LTK)", "btsmp.key_dist_enc",\r\nFT_UINT8, BASE_DEC, NULL, 0x01,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_key_dist_id,\r\n{"Id Key (IRK)", "btsmp.key_dist_id",\r\nFT_UINT8, BASE_DEC, NULL, 0x02,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_key_dist_sign,\r\n{"Signature Key (CSRK)", "btsmp.key_dist_sign",\r\nFT_UINT8, BASE_DEC, NULL, 0x04,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_ediv,\r\n{"Encrypted Diversifier (EDIV)", "btsmp.ediv",\r\nFT_UINT16, BASE_HEX, NULL, 0x00,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_authreq,\r\n{"AuthReq", "btsmp.authreq",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_initiator_key_distribution,\r\n{"Initiator Key Distribution", "btsmp.initiator_key_distribution",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL}\r\n},\r\n{&hf_btsmp_responder_key_distribution,\r\n{"Responder Key Distribution", "btsmp.responder_key_distribution",\r\nFT_NONE, BASE_NONE, NULL, 0x00,\r\nNULL, HFILL}\r\n}\r\n};\r\nstatic gint *ett[] = {\r\n&ett_btsmp,\r\n&ett_btsmp_auth_req,\r\n&ett_btsmp_key_dist\r\n};\r\nproto_btsmp = proto_register_protocol("Bluetooth Security Manager Protocol",\r\n"BT SMP", "btsmp");\r\nbtsmp_handle = new_register_dissector("btsmp", dissect_btsmp, proto_btsmp);\r\nproto_register_field_array(proto_btsmp, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\n}\r\nvoid\r\nproto_reg_handoff_btsmp(void)\r\n{\r\ndissector_add_uint("btl2cap.cid", BTL2CAP_FIXED_CID_SMP, btsmp_handle);\r\n}

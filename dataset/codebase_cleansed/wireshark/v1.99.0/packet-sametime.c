static int\r\nadd_text_item(tvbuff_t *tvb, proto_tree *tree, int offset, int hf)\r\n{\r\nguint16 length;\r\nif (! tvb_get_guint8(tvb, offset + 2))\r\nreturn 0;\r\nlength = tvb_get_ntohs(tvb, offset);\r\nif (length) {\r\nif (length > tvb_reported_length_remaining(tvb, offset + 2))\r\nreturn 0;\r\nif (global_sametime_show_length)\r\nproto_tree_add_item(tree, hf_sametime_field_length, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_string(tree, hf, tvb, offset + 2, length,\r\ntvb_get_string_enc(wmem_packet_scope(), tvb, offset + 2, length, ENC_ASCII|ENC_NA));\r\n}\r\nreturn 2 + length;\r\n}\r\nstatic guint16\r\ndissect_set_user_status(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nguint16 user_status;\r\nuser_status = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(user_status, userstatusnames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_user_status, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_sametime_time, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nreturn user_status;\r\n}\r\nstatic int\r\ndissect_handshake(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, hf_sametime_handshake_major, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_sametime_handshake_minor, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_sametime_handshake_srvrcalc_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_sametime_login_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_sametime_handshake_loclcalc_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += 6;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += 8;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nreturn offset;\r\n}\r\nstatic void\r\ndissect_handshake_ack(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nproto_tree_add_item(tree, hf_sametime_handshake_major, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_sametime_handshake_minor, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(tree, hf_sametime_handshake_loclcalc_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += 4;\r\noffset += 4;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nstatic void\r\ndissect_login(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\noffset += 2;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nstatic void\r\ndissect_login_redirect(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\noffset += 2;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nstatic void\r\ndissect_login_ack(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nproto_tree_add_item(tree, hf_sametime_login_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += 3;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nproto_tree_add_item(tree, hf_sametime_handshake_loclcalc_addr, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += 21;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nstatic void\r\ndissect_channel_create(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\noffset += 4;\r\nproto_tree_add_item(tree, hf_sametime_channel_id, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nproto_tree_add_item(tree, hf_sametime_channel_service, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\noffset += 8;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nstatic guint16\r\ndissect_channel_send(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nguint16 send_type, awareness;\r\nguint na;\r\nsend_type = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(send_type, sendtypenames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_channel_send_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nswitch (send_type) {\r\ncase SAMETIME_SENDTYPE_AWARE_ADD:\r\noffset += 8;\r\nawareness = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(awareness, awarenessnames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_channel_awareness, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nbreak;\r\ncase SAMETIME_SENDTYPE_OPT_DO_SET:\r\noffset += 20;\r\nna = tvb_get_ntohl(tvb, offset);\r\noffset += 4;\r\nif (na == 0x33) {\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_location_country);\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_location_postalcode);\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_location_province);\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_location_city);\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_location_phone);\r\noffset += 1;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_location_name);\r\nadd_text_item(tvb, tree, offset, hf_sametime_location_timezone);\r\n} else {\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nbreak;\r\ncase SAMETIME_SENDTYPE_OPT_GOT_SET:\r\noffset += 8;\r\nawareness = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(awareness, awarenessnames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_channel_awareness, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nwhile (tvb_reported_length_remaining(tvb, offset) > 2) {\r\nint n = add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += (n) ? n : 1;\r\n}\r\nbreak;\r\ncase SAMETIME_SENDTYPE_AWARE_SNAPSHOT:\r\noffset += 12;\r\nawareness = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(awareness, awarenessnames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_channel_awareness, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nbreak;\r\ncase SAMETIME_SENDTYPE_AWARE_UPDATE:\r\noffset += 4;\r\noffset += 4;\r\nawareness = tvb_get_ntohs(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(awareness, awarenessnames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_channel_awareness, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += 4;\r\nif (tvb_get_guint8(tvb, offset)) {\r\noffset += 1;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\ndissect_set_user_status(tvb, tree, offset);\r\n}\r\nbreak;\r\ncase 0x0000:\r\noffset += 14;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nbreak;\r\ncase 0x0002:\r\noffset += 8;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += 3;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nbreak;\r\ncase 0x0005:\r\nif (26 <= tvb_reported_length_remaining(tvb, offset + 2)) {\r\noffset += 26;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nbreak;\r\ncase 0x0007:\r\noffset += 8;\r\nif (4 <= tvb_reported_length_remaining(tvb, offset + 2)) {\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\noffset += 3;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\n}\r\nbreak;\r\ncase 0x025a:\r\noffset += 10;\r\nadd_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn send_type;\r\n}\r\nstatic void\r\ndissect_channel_accept(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\noffset += 34;\r\nif (tvb_reported_length_remaining(tvb, offset + 2)) {\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\nif (tvb_get_guint8(tvb, offset)) {\r\noffset += 1;\r\noffset += add_text_item(tvb, tree, offset, hf_sametime_field_text);\r\ndissect_set_user_status(tvb, tree, offset);\r\n}\r\n}\r\n}\r\nstatic void\r\ndissect_sense_service(tvbuff_t *tvb, proto_tree *tree, int offset)\r\n{\r\nguint32 code;\r\ncode = tvb_get_ntohl(tvb, offset);\r\nproto_item_append_text(tree, ", %s", val_to_str(code, codenames, "0x%04x"));\r\nproto_tree_add_item(tree, hf_sametime_code, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\nstatic int\r\ndissect_sametime_content(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data _U_)\r\n{\r\nproto_tree *sametime_tree;\r\nproto_item *ti;\r\nstatic SametimeTap *sinfo;\r\ngint message_type;\r\nint packet_length, offset = 0;\r\npacket_length = tvb_reported_length_remaining(tvb, offset);\r\nif (packet_length == 1) {\r\nmessage_type = tvb_get_guint8(tvb, 0);\r\n} else if (packet_length < 12) {\r\nmessage_type = -1;\r\n} else {\r\nmessage_type = tvb_get_ntohs(tvb, 4);\r\n}\r\ncol_append_str(pinfo->cinfo, COL_INFO, val_to_str(message_type, messagetypenames, "0x%04x"));\r\ncol_append_str(pinfo->cinfo, COL_INFO, " ");\r\nsinfo = wmem_new(wmem_packet_scope(), struct SametimeTap);\r\nsinfo->message_type = message_type;\r\nsinfo->send_type = -1;\r\nsinfo->user_status = -1;\r\nti = proto_tree_add_item(tree, proto_sametime, tvb, offset, -1, ENC_NA);\r\nsametime_tree = proto_item_add_subtree(ti, ett_sametime);\r\nproto_item_append_text(sametime_tree, ", %s", val_to_str(message_type, messagetypenames, "0x%04x"));\r\nif (message_type == SAMETIME_MESSAGETYPE_HEARTBEAT) {\r\nproto_tree_add_item(sametime_tree, hf_sametime_heartbeat, tvb, offset, 1, ENC_BIG_ENDIAN);\r\n} else if (message_type != -1) {\r\nproto_tree *options_tree;\r\nproto_item *op;\r\nif (global_sametime_show_length) {\r\nproto_tree_add_item(sametime_tree, hf_sametime_message_length, tvb, offset, 4, ENC_BIG_ENDIAN);\r\n}\r\noffset += 4;\r\nproto_tree_add_item(sametime_tree, hf_sametime_message_type, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nop = proto_tree_add_item(sametime_tree, hf_sametime_message_options, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noptions_tree = proto_item_add_subtree(op, ett_sametime_options);\r\nproto_tree_add_item(options_tree, hf_sametime_message_options_attribute, tvb, offset, 2, ENC_BIG_ENDIAN);\r\nproto_tree_add_item(options_tree, hf_sametime_message_options_encrypted, tvb, offset, 2, ENC_BIG_ENDIAN);\r\noffset += 2;\r\nproto_tree_add_item(sametime_tree, hf_sametime_message_channel, tvb, offset, 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nswitch (message_type)\r\n{\r\ncase SAMETIME_MESSAGETYPE_HANDSHAKE:\r\ndissect_handshake(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_HANDSHAKE_ACK:\r\ndissect_handshake_ack(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_HANDSHAKE_SYN:\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_LOGIN:\r\ndissect_login(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_LOGIN_REDIRECT:\r\ndissect_login_redirect(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_LOGIN_ACK:\r\ndissect_login_ack(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_CHANNEL_CREATE:\r\ndissect_channel_create(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_CHANNEL_SEND:\r\nsinfo->send_type = dissect_channel_send(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_CHANNEL_ACCEPT:\r\ndissect_channel_accept(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_SET_USER_STATUS:\r\nsinfo->user_status = dissect_set_user_status(tvb, sametime_tree, offset);\r\nbreak;\r\ncase SAMETIME_MESSAGETYPE_SENSE_SERVICE:\r\ndissect_sense_service(tvb, sametime_tree, offset);\r\nbreak;\r\ndefault:\r\nsinfo->message_type = -1;\r\nbreak;\r\n}\r\n}\r\ntap_queue_packet(sametime_tap, pinfo, sinfo);\r\nreturn tvb_length(tvb);\r\n}\r\nstatic int\r\nsametime_stats_tree_packet(stats_tree* st, packet_info* pinfo _U_, epan_dissect_t* edt _U_, const void* p)\r\n{\r\nconst struct SametimeTap *pi = (const struct SametimeTap *)p;\r\ntick_stat_node(st, st_str_packet, 0, FALSE);\r\nif (pi->message_type != -1)\r\nstats_tree_tick_pivot(st, st_node_message_type, val_to_str(pi->message_type, messagetypenames, "Unknown (0x%04x)"));\r\nif (pi->send_type != -1)\r\nstats_tree_tick_pivot(st, st_node_send_type, val_to_str(pi->send_type, sendtypenames, "Unknown (0x%04x)"));\r\nif (pi->user_status != -1)\r\nstats_tree_tick_pivot(st, st_node_user_status, val_to_str(pi->user_status, userstatusnames, "Unknown (0x%04x)"));\r\nreturn 1;\r\n}\r\nstatic void\r\nsametime_stats_tree_init(stats_tree* st)\r\n{\r\nst_node_packet = stats_tree_create_node(st, st_str_packet, 0, TRUE);\r\nst_node_message_type = stats_tree_create_pivot(st, st_str_message_type, st_node_packet);\r\nst_node_send_type = stats_tree_create_pivot(st, st_str_send_type, st_node_packet);\r\nst_node_user_status = stats_tree_create_pivot(st, st_str_user_status, st_node_packet);\r\n}\r\nstatic guint\r\nget_sametime_message_len(packet_info *pinfo _U_, tvbuff_t *tvb, int offset)\r\n{\r\nguint32 N = tvb_length_remaining(tvb, offset);\r\nreturn (N < 4) ? N : tvb_get_ntohl(tvb, offset) + 4;\r\n}\r\nstatic int\r\ndissect_sametime(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "SAMETIME");\r\ncol_clear(pinfo->cinfo,COL_INFO);\r\ntcp_dissect_pdus(tvb, pinfo, tree, global_sametime_reassemble_packets, 4,\r\nget_sametime_message_len, dissect_sametime_content, data);\r\nreturn tvb_length(tvb);\r\n}\r\nvoid\r\nproto_register_sametime(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_sametime_heartbeat,\r\n{ "heartbeat", "sametime.heartbeat",\r\nFT_UINT8, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_message_length,\r\n{ "msg length", "sametime.message_length",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_message_type,\r\n{ "msg type", "sametime.message_type",\r\nFT_UINT16, BASE_HEX,\r\nVALS(messagetypenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_message_options,\r\n{ "msg options", "sametime.message_options",\r\nFT_UINT16, BASE_HEX,\r\nVALS(optionnames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_message_options_encrypted,\r\n{ "ENCRYPT", "sametime.message_options.encrypted",\r\nFT_BOOLEAN, 16,\r\nNULL, SAMETIME_MESSAGEOPTION_ENCRYPT,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_message_options_attribute,\r\n{ "HAS_ATTRIBS", "sametime.message_options.attribute",\r\nFT_BOOLEAN, 16,\r\nNULL, SAMETIME_MESSAGEOPTION_HAS_ATTRIBS,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_message_channel,\r\n{ "msg channel", "sametime.message_channel",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_field_length,\r\n{ "length", "sametime.field_length",\r\nFT_UINT16, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_field_text,\r\n{ "text", "sametime.field_text",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_code,\r\n{ "code", "sametime.code",\r\nFT_UINT32, BASE_HEX,\r\nVALS(codenames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_login_type,\r\n{ "login type", "sametime.login_type",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_time,\r\n{ "time", "sametime.time",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_handshake_major,\r\n{ "major", "sametime.handshake.major",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_handshake_minor,\r\n{ "minor", "sametime.handshake.minor",\r\nFT_UINT16, BASE_HEX,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_handshake_srvrcalc_addr,\r\n{ "srvr", "sametime.handshake.srvrcalc_addr",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_handshake_loclcalc_addr,\r\n{ "locl", "sametime.handshake.loclcalc_addr",\r\nFT_IPv4, BASE_NONE,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_channel_service,\r\n{ "service id", "sametime.channel.service",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_channel_id,\r\n{ "channel id", "sametime.channel.id",\r\nFT_UINT32, BASE_DEC,\r\nNULL, 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_channel_send_type,\r\n{ "send type", "sametime.channel.send_type",\r\nFT_UINT16, BASE_HEX,\r\nVALS(sendtypenames), 0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_channel_awareness,\r\n{ "awareness", "sametime.channel.awareness",\r\nFT_UINT16, BASE_HEX,\r\nVALS(awarenessnames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_user_status,\r\n{ "user status", "sametime.user_status_type",\r\nFT_UINT16, BASE_HEX,\r\nVALS(userstatusnames), 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_name,\r\n{ "name", "sametime.location.name",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_city,\r\n{ "city", "sametime.location.city",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_province,\r\n{ "province", "sametime.location.province",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_postalcode,\r\n{ "postal code", "sametime.location.postalcode",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_country,\r\n{ "country", "sametime.location.country",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_phone,\r\n{ "phone", "sametime.location.phone",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n{ &hf_sametime_location_timezone,\r\n{ "time zone", "sametime.location.timezone",\r\nFT_STRING, STR_ASCII,\r\nNULL, 0x0,\r\nNULL, HFILL }\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_sametime,\r\n&ett_sametime_options\r\n};\r\nmodule_t *sametime_module;\r\nproto_sametime = proto_register_protocol (\r\n"Sametime Protocol",\r\n"SAMETIME",\r\n"sametime"\r\n);\r\nproto_register_field_array(proto_sametime, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nsametime_tap = register_tap("sametime");\r\nsametime_module = prefs_register_protocol(proto_sametime, NULL);\r\nprefs_register_bool_preference(sametime_module, "show_length",\r\n"Show length",\r\n"Show length of text field",\r\n&global_sametime_show_length);\r\nprefs_register_bool_preference(sametime_module, "reassemble",\r\n"Reassemble","reassemble packets",\r\n&global_sametime_reassemble_packets);\r\nprefs_register_uint_preference(sametime_module, "tcp_port",\r\n"SAMETIME port number",\r\n"port number for sametime traffic",\r\n10, &global_sametime_port);\r\n}\r\nvoid\r\nproto_reg_handoff_sametime(void)\r\n{\r\nstatic gboolean initialized = FALSE;\r\nstatic guint saved_sametime_tcp_port;\r\nif (!initialized) {\r\nsametime_handle = new_create_dissector_handle(dissect_sametime, proto_sametime);\r\nstats_tree_register("sametime", "sametime", "Sametime/Messages", 0,\r\nsametime_stats_tree_packet,\r\nsametime_stats_tree_init, NULL );\r\ninitialized = TRUE;\r\n} else {\r\ndissector_delete_uint("tcp.port", saved_sametime_tcp_port, sametime_handle);\r\n}\r\ndissector_add_uint("tcp.port", global_sametime_port, sametime_handle);\r\nsaved_sametime_tcp_port = global_sametime_port;\r\n}

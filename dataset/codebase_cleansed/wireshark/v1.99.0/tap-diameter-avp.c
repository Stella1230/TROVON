static gboolean\r\ntree_traverse_pre_order(proto_tree *tree, proto_tree_traverse_func func, gpointer data)\r\n{\r\nproto_node *pnode = tree;\r\nproto_node *child;\r\nproto_node *current;\r\nif (func(pnode, data))\r\nreturn TRUE;\r\nchild = pnode->first_child;\r\nwhile (child != NULL) {\r\ncurrent = child;\r\nchild = current->next;\r\nif (tree_traverse_pre_order((proto_tree *)current, func, data))\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ndiam_tree_to_csv(proto_node* node, gpointer data)\r\n{\r\nchar* val_str=NULL;\r\nchar* val_tmp=NULL;\r\nftenum_t ftype;\r\nfield_info* fi;\r\nheader_field_info *hfi;\r\nif(!node) {\r\nfprintf(stderr,"traverse end: empty node. node='%p' data='%p'\n",(void *)node,(void *)data);\r\nreturn FALSE;\r\n}\r\nfi=node->finfo;\r\nhfi=fi ? fi->hfinfo : NULL;\r\nif(!hfi) {\r\nfprintf(stderr,"traverse end: hfi not found. node='%p'\n",(void *)node);\r\nreturn FALSE;\r\n}\r\nftype=fvalue_type_ftenum(&fi->value);\r\nif (ftype!=FT_NONE&&ftype!=FT_PROTOCOL) {\r\nval_tmp=fvalue_to_string_repr(&fi->value,FTREPR_DISPLAY,NULL);\r\nif(val_tmp)\r\n{\r\nval_str=ep_strdup(val_tmp);\r\ng_free(val_tmp);\r\n} else\r\nval_str=ep_strdup_printf("unsupported type: %s",ftype_name(ftype));\r\nprintf("%s='%s' ",hfi->name,val_str);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic int\r\ndiameteravp_packet(void *pds, packet_info *pinfo, epan_dissect_t *edt _U_, const void *pdi)\r\n{\r\nint ret = 0;\r\ndouble resp_time=0.;\r\ngboolean is_request=TRUE;\r\nguint32 cmd_code=0;\r\nguint32 req_frame=0;\r\nguint32 ans_frame=0;\r\nguint32 diam_child_node=0;\r\nproto_node* current=NULL;\r\nproto_node* node = NULL;\r\nheader_field_info* hfi=NULL;\r\nfield_info* finfo=NULL;\r\nconst diameter_req_ans_pair_t* dp=(const diameter_req_ans_pair_t*)pdi;\r\ndiameteravp_t *ds=NULL;\r\nif(!dp || !edt || !edt->tree)\r\nreturn ret;\r\nds=(diameteravp_t *)pds;\r\nif(pinfo->fd->num > ds->frame) {\r\nds->frame=pinfo->fd->num;\r\nds->diammsg_toprocess=0;\r\n} else {\r\nds->diammsg_toprocess+=1;\r\n}\r\nis_request=dp->processing_request;\r\ncmd_code=dp->cmd_code;\r\nreq_frame=dp->req_frame;\r\nans_frame=dp->ans_frame;\r\nif(!is_request) {\r\nnstime_t ns;\r\nnstime_delta(&ns, &pinfo->fd->abs_ts, &dp->req_time);\r\nresp_time=nstime_to_sec(&ns);\r\nresp_time=resp_time<0?0.:resp_time;\r\n}\r\nif (ds->cmd_code && ds->cmd_code!=cmd_code)\r\nreturn ret;\r\nnode = edt->tree->first_child;\r\nwhile (node != NULL) {\r\ncurrent = node;\r\nnode = current->next;\r\nfinfo=current->finfo;\r\nhfi=finfo ? finfo->hfinfo : NULL;\r\nif(hfi && hfi->abbrev && strcmp(hfi->abbrev,"diameter")==0) {\r\nif (ds->diammsg_toprocess==diam_child_node) {\r\nif(is_request) {\r\nds->req_count++;\r\n} else {\r\nds->ans_count++;\r\nif (req_frame>0)\r\nds->paired_ans_count++;\r\n}\r\nprintf("frame='%d' time='%f' src='%s' srcport='%d' dst='%s' dstport='%d' proto='diameter' msgnr='%d' is_request='%d' cmd='%d' req_frame='%d' ans_frame='%d' resp_time='%f' ",\r\npinfo->fd->num,nstime_to_sec(&pinfo->fd->abs_ts),ep_address_to_str(&pinfo->src),pinfo->srcport,ep_address_to_str(&pinfo->dst), pinfo->destport,ds->diammsg_toprocess,is_request,cmd_code,req_frame,ans_frame,resp_time);\r\ntree_traverse_pre_order(current, diam_tree_to_csv, &ds);\r\nprintf("\n");\r\n}\r\ndiam_child_node++;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic void\r\ndiameteravp_draw(void* pds)\r\n{\r\ndiameteravp_t *ds=(diameteravp_t *)pds;\r\nprintf("=== Diameter Summary ===\nrequset count:\t%d\nanswer count:\t%d\nreq/ans pairs:\t%d\n",ds->req_count,ds->ans_count,ds->paired_ans_count);\r\n}\r\nstatic void\r\ndiameteravp_init(const char *opt_arg, void* userdata _U_)\r\n{\r\ndiameteravp_t *ds;\r\ngchar* field=NULL;\r\ngchar** tokens;\r\nguint opt_count=0;\r\nguint opt_idx=0;\r\nGString* filter=NULL;\r\nGString* error_string=NULL;\r\nds=g_new(diameteravp_t,1);\r\nds->frame=0;\r\nds->diammsg_toprocess=0;\r\nds->cmd_code=0;\r\nds->req_count=0;\r\nds->ans_count=0;\r\nds->paired_ans_count=0;\r\nds->filter=NULL;\r\nfilter=g_string_new("diameter");\r\ntokens = g_strsplit(opt_arg,",", 1024);\r\nopt_count=0;\r\nwhile (tokens[opt_count])\r\nopt_count++;\r\nif (opt_count>2)\r\nds->cmd_code=(guint32)atoi(tokens[2]);\r\nfor(opt_idx=3;opt_idx<opt_count;opt_idx++)\r\n{\r\nfield=tokens[opt_idx];\r\ng_string_append(filter,"||");\r\nif(!strchr(field,'.'))\r\ng_string_append(filter, "diameter.");\r\ng_string_append(filter, field);\r\n}\r\ng_strfreev(tokens);\r\nds->filter=g_string_free(filter,FALSE);\r\nerror_string=register_tap_listener("diameter", ds, ds->filter, 0, NULL, diameteravp_packet, diameteravp_draw);\r\nif(error_string){\r\ng_free(ds);\r\nfprintf(stderr, "tshark: Couldn't register diam,csv tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_diameteravp(void)\r\n{\r\nregister_stat_cmd_arg("diameter,avp", diameteravp_init, NULL);\r\n}

static guint\r\nget_reload_framing_message_length(packet_info *pinfo _U_, tvbuff_t *tvb, int offset)\r\n{\r\nguint32 length = 9;\r\nif (tvb_get_guint8(tvb, offset) == DATA) {\r\nlength = 1 + 4 + 3 + tvb_get_ntoh24(tvb, 1 + 4);\r\n}\r\nreturn length;\r\n}\r\nstatic int\r\ndissect_reload_framing_message(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, gboolean from_dtls)\r\n{\r\nproto_item *ti;\r\nproto_tree *reload_framing_tree;\r\nguint32 relo_token;\r\nguint32 message_length = 0;\r\nwmem_tree_key_t transaction_id_key[4];\r\nguint32 *key_save, len_save;\r\nguint32 sequence;\r\nguint effective_length;\r\nguint16 offset;\r\nconversation_t *conversation;\r\nreload_conv_info_t *reload_framing_info = NULL;\r\nreload_frame_t * reload_frame;\r\nguint8 type;\r\noffset = 0;\r\neffective_length = tvb_captured_length(tvb);\r\nif (effective_length < MIN_HDR_LENGTH)\r\nreturn 0;\r\nconversation = find_conversation(pinfo->fd->num, &pinfo->src, &pinfo->dst,\r\npinfo->ptype, pinfo->srcport, pinfo->destport, 0);\r\nif (conversation)\r\nreload_framing_info = (reload_conv_info_t *)conversation_get_proto_data(conversation, proto_reload_framing);\r\ntype = tvb_get_guint8(tvb, 0);\r\nswitch(type) {\r\ncase DATA:\r\nif (effective_length < 12)\r\nreturn 0;\r\nrelo_token = tvb_get_ntohl(tvb,1 + 4 + 3);\r\nif (relo_token != RELOAD_TOKEN) {\r\nreturn 0;\r\n}\r\nmessage_length = tvb_get_ntoh24(tvb, 1 + 4);\r\nif (message_length < MIN_RELOADDATA_HDR_LENGTH) {\r\nreturn 0;\r\n}\r\nbreak;\r\ncase ACK:\r\nif (effective_length < 9 || ! reload_framing_info) {\r\nreturn 0;\r\n}\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nif (from_dtls && have_tap_listener(exported_pdu_tap)) {\r\nexp_pdu_data_t *exp_pdu_data;\r\nguint8 tags = EXP_PDU_TAG_IP_SRC_BIT | EXP_PDU_TAG_IP_DST_BIT | EXP_PDU_TAG_SRC_PORT_BIT |\r\nEXP_PDU_TAG_DST_PORT_BIT | EXP_PDU_TAG_ORIG_FNO_BIT;\r\nexp_pdu_data = load_export_pdu_tags(pinfo, "reload-framing", -1, &tags, 1);\r\nexp_pdu_data->tvb_captured_length = effective_length;\r\nexp_pdu_data->tvb_reported_length = tvb_reported_length(tvb);\r\nexp_pdu_data->pdu_tvb = tvb;\r\ntap_queue_packet(exported_pdu_tap, pinfo, exp_pdu_data);\r\n}\r\ncol_set_str(pinfo->cinfo, COL_PROTOCOL, "RELOAD Frame");\r\ncol_clear(pinfo->cinfo, COL_INFO);\r\nsequence = tvb_get_ntohl(tvb, 1);\r\ntransaction_id_key[0].length = 1;\r\ntransaction_id_key[0].key = &sequence;\r\nif (type==DATA) {\r\ntransaction_id_key[1].length = 1;\r\ntransaction_id_key[1].key = &pinfo->srcport;\r\ntransaction_id_key[2].length = (pinfo->src.len) / (guint)sizeof(guint32);\r\ntransaction_id_key[2].key = (guint32 *)g_malloc(pinfo->src.len);\r\nmemcpy(transaction_id_key[2].key, pinfo->src.data, pinfo->src.len);\r\n}\r\nelse {\r\ntransaction_id_key[1].length = 1;\r\ntransaction_id_key[1].key = &pinfo->destport;\r\ntransaction_id_key[2].length = (pinfo->dst.len) / (guint)sizeof(guint32);\r\ntransaction_id_key[2].key = (guint32 *)g_malloc(pinfo->dst.len);\r\nmemcpy(transaction_id_key[2].key, pinfo->dst.data, pinfo->dst.len);\r\n}\r\ntransaction_id_key[3].length=0;\r\ntransaction_id_key[3].key=NULL;\r\nkey_save = transaction_id_key[2].key;\r\nlen_save = transaction_id_key[2].length;\r\nif (!conversation) {\r\nconversation = conversation_new(pinfo->fd->num, &pinfo->src, &pinfo->dst,\r\npinfo->ptype, pinfo->srcport, pinfo->destport, 0);\r\n}\r\nif (!reload_framing_info) {\r\nreload_framing_info = wmem_new(wmem_file_scope(), reload_conv_info_t);\r\nreload_framing_info->transaction_pdus = wmem_tree_new(wmem_file_scope());\r\nconversation_add_proto_data(conversation, proto_reload_framing, reload_framing_info);\r\n}\r\nif (!pinfo->fd->flags.visited) {\r\nif ((reload_frame = (reload_frame_t *)\r\nwmem_tree_lookup32_array(reload_framing_info->transaction_pdus, transaction_id_key)) == NULL) {\r\ntransaction_id_key[2].key = key_save;\r\ntransaction_id_key[2].length = len_save;\r\nreload_frame = wmem_new(wmem_file_scope(), reload_frame_t);\r\nreload_frame->data_frame = 0;\r\nreload_frame->ack_frame = 0;\r\nreload_frame->req_time = pinfo->fd->abs_ts;\r\nwmem_tree_insert32_array(reload_framing_info->transaction_pdus, transaction_id_key, (void *)reload_frame);\r\n}\r\ntransaction_id_key[2].key = key_save;\r\ntransaction_id_key[2].length = len_save;\r\nif (type == DATA) {\r\nif (reload_frame->data_frame == 0) {\r\nreload_frame->data_frame = pinfo->fd->num;\r\n}\r\n}\r\nelse {\r\nif (reload_frame->ack_frame == 0) {\r\nreload_frame->ack_frame = pinfo->fd->num;\r\n}\r\n}\r\n}\r\nelse {\r\nreload_frame=(reload_frame_t *)wmem_tree_lookup32_array(reload_framing_info->transaction_pdus, transaction_id_key);\r\ntransaction_id_key[2].key = key_save;\r\ntransaction_id_key[2].length = len_save;\r\n}\r\ng_free(transaction_id_key[2].key);\r\nif (!reload_frame) {\r\nreload_frame = wmem_new(wmem_packet_scope(), reload_frame_t);\r\nreload_frame->data_frame = (type==DATA) ? pinfo->fd->num : 0;\r\nreload_frame->ack_frame = (type!=DATA) ? pinfo->fd->num : 0;\r\nreload_frame->req_time = pinfo->fd->abs_ts;\r\n}\r\nti = proto_tree_add_item(tree, proto_reload_framing, tvb, 0, -1, ENC_NA);\r\nreload_framing_tree = proto_item_add_subtree(ti, ett_reload_framing);\r\ncol_add_fstr(pinfo->cinfo, COL_INFO, "%s", val_to_str_const(type, types, "Unknown"));\r\nproto_item_append_text(ti, ": %s", val_to_str_const(type, types, "Unknown"));\r\nif (type == DATA) {\r\nif (reload_frame->data_frame != pinfo->fd->num) {\r\nproto_item *it;\r\nit = proto_tree_add_uint(reload_framing_tree, hf_reload_framing_duplicate, tvb, 0, 0, reload_frame->data_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nif (reload_frame->ack_frame) {\r\nproto_item *it;\r\nit = proto_tree_add_uint(reload_framing_tree, hf_reload_framing_response_in, tvb, 0, 0, reload_frame->ack_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\n}\r\nelse {\r\nif (reload_frame->ack_frame != pinfo->fd->num) {\r\nproto_item *it;\r\nit = proto_tree_add_uint(reload_framing_tree, hf_reload_framing_duplicate, tvb, 0, 0, reload_frame->ack_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\nif (reload_frame->data_frame) {\r\nproto_item *it;\r\nnstime_t ns;\r\nit = proto_tree_add_uint(reload_framing_tree, hf_reload_framing_response_to, tvb, 0, 0, reload_frame->data_frame);\r\nPROTO_ITEM_SET_GENERATED(it);\r\nnstime_delta(&ns, &pinfo->fd->abs_ts, &reload_frame->req_time);\r\nit = proto_tree_add_time(reload_framing_tree, hf_reload_framing_time, tvb, 0, 0, &ns);\r\nPROTO_ITEM_SET_GENERATED(it);\r\n}\r\n}\r\nproto_tree_add_item(reload_framing_tree, hf_reload_framing_type, tvb, offset , 1, ENC_BIG_ENDIAN);\r\noffset += 1;\r\nswitch (type) {\r\ncase DATA:\r\n{\r\ntvbuff_t *next_tvb;\r\nproto_item *ti_message;\r\nproto_tree *message_tree;\r\nproto_tree_add_item(reload_framing_tree, hf_reload_framing_sequence, tvb, offset , 4, ENC_BIG_ENDIAN);\r\noffset += 4;\r\nti_message = proto_tree_add_item(reload_framing_tree, hf_reload_framing_message, tvb, offset, 3+message_length, ENC_NA);\r\nproto_item_append_text(ti_message, " (opaque<%d>)", message_length);\r\nmessage_tree = proto_item_add_subtree(ti_message, ett_reload_framing_message);\r\nproto_tree_add_item(message_tree, hf_reload_framing_message_length, tvb, offset, 3, ENC_BIG_ENDIAN);\r\noffset += 3;\r\nproto_tree_add_item(message_tree, hf_reload_framing_message_data, tvb, offset, message_length, ENC_NA);\r\nnext_tvb = tvb_new_subset(tvb, offset, effective_length - offset, message_length);\r\nif (reload_handle == NULL) {\r\nexpert_add_info(pinfo, ti, &ei_reload_no_dissector);\r\nreturn tvb_length(tvb);\r\n}\r\ncall_dissector_only(reload_handle, next_tvb, pinfo, tree, NULL);\r\n}\r\nbreak;\r\ncase ACK:\r\n{\r\nproto_item *ti_received;\r\nproto_tree_add_uint(reload_framing_tree, hf_reload_framing_ack_sequence, tvb, offset , 4, sequence);\r\noffset += 4;\r\nti_received = proto_tree_add_item(reload_framing_tree, hf_reload_framing_received, tvb, offset , 4, ENC_BIG_ENDIAN);\r\n{\r\nguint32 received;\r\nint last_received = -1;\r\nint indx = 0;\r\nproto_tree *received_tree;\r\nproto_item *ti_parsed_received = NULL;\r\nreceived = tvb_get_ntohl(tvb, offset);\r\nwhile ((received<<indx) != 0) {\r\nif (indx>=32) break;\r\nif (received &(0x1<<(31-indx))) {\r\nif (indx==0) {\r\nreceived_tree = proto_item_add_subtree(ti_received, ett_reload_framing_received);\r\nti_parsed_received = proto_tree_add_item(received_tree, hf_reload_framing_parsed_received, tvb, offset, 4, ENC_NA);\r\nproto_item_append_text(ti_parsed_received, "[%u", (sequence -32+indx));\r\nlast_received = indx;\r\n}\r\nelse {\r\nif (received &(0x1<<(31-indx+1))) {\r\nindx++;\r\ncontinue;\r\n}\r\nelse {\r\nif (last_received<0) {\r\nreceived_tree = proto_item_add_subtree(ti_received, ett_reload_framing_received);\r\nti_parsed_received = proto_tree_add_item(received_tree, hf_reload_framing_parsed_received, tvb, offset, 4, ENC_NA);\r\nproto_item_append_text(ti_parsed_received, "[%u",(sequence-32+indx));\r\n}\r\nelse {\r\nproto_item_append_text(ti_parsed_received, ",%u",(sequence-32+indx));\r\n}\r\nlast_received = indx;\r\n}\r\n}\r\n}\r\nelse if (indx>0) {\r\nif ((received &(0x1<<(31-indx+1))) && (received &(0x1<<(31-indx+2)))) {\r\nif ((received &(0x1<<(31-indx+3)))) {\r\nproto_item_append_text(ti_parsed_received,"-%u",(sequence-32+indx-1));\r\n}\r\nelse {\r\nproto_item_append_text(ti_received, ",%u", (sequence-32+indx-1));\r\n}\r\n}\r\nelse {\r\nindx++;\r\ncontinue;\r\n}\r\n}\r\nindx++;\r\n}\r\nif (last_received>=0) {\r\nif ((received &(0x1<<(31-indx+1))) && (received &(0x1<<(31-indx+2)))) {\r\nif ((received &(0x1<<(31-indx+3)))) {\r\nproto_item_append_text(ti_parsed_received,"-%u",(sequence-32+indx-1));\r\n}\r\nelse {\r\nproto_item_append_text(ti_parsed_received, ",%u", (sequence-32+indx-1));\r\n}\r\n}\r\nproto_item_append_text(ti_parsed_received, "]");\r\nPROTO_ITEM_SET_GENERATED(ti_parsed_received);\r\n}\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nDISSECTOR_ASSERT_NOT_REACHED();\r\n}\r\nreturn tvb_length(tvb);\r\n}\r\nstatic int\r\ndissect_reload_framing(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nreturn dissect_reload_framing_message(tvb, pinfo, tree, FALSE);\r\n}\r\nstatic int\r\ndissect_reload_framing_tcp(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void* data)\r\n{\r\ntcp_dissect_pdus(tvb, pinfo, tree, TRUE, MIN_HDR_LENGTH,\r\nget_reload_framing_message_length, dissect_reload_framing, data);\r\nreturn tvb_length(tvb);\r\n}\r\nstatic gboolean\r\ndissect_reload_framing_heur(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif (dissect_reload_framing_message(tvb, pinfo, tree, FALSE) == 0) {\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nstatic gboolean\r\ndissect_reload_framing_heur_dtls(tvbuff_t *tvb, packet_info *pinfo, proto_tree *tree, void *data _U_)\r\n{\r\nif (dissect_reload_framing_message(tvb, pinfo, tree, TRUE) == 0) {\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nvoid\r\nproto_register_reload_framing(void)\r\n{\r\nstatic hf_register_info hf[] = {\r\n{ &hf_reload_framing_type,\r\n{ "type (FramedMessageType)", "reload_framing.type", FT_UINT8,\r\nBASE_DEC, VALS(types), 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_sequence,\r\n{ "sequence (uint32)", "reload_framing.sequence", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_ack_sequence,\r\n{ "ack_sequence (uint32)", "reload_framing.ack_sequence", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_message,\r\n{ "message", "reload_framing.message", FT_NONE,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_message_length,\r\n{ "length (uint24)", "reload_framing.message.length", FT_UINT32,\r\nBASE_DEC, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_message_data,\r\n{ "data", "reload_framing.message.data", FT_BYTES,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_received,\r\n{ "received (uint32)", "reload_framing.received", FT_UINT32,\r\nBASE_HEX, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_parsed_received,\r\n{ "Acked Frames:", "reload_framing.parsed_received", FT_NONE,\r\nBASE_NONE, NULL, 0x0, NULL, HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_response_in,\r\n{ "Response In", "reload_framing.response-in", FT_FRAMENUM,\r\nBASE_NONE, NULL, 0x0, "The response to this RELOAD Request is in this frame", HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_response_to,\r\n{ "Request In", "reload_framing.response-to", FT_FRAMENUM,\r\nBASE_NONE, NULL, 0x0, "This is a response to the RELOAD Request in this frame", HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_time,\r\n{ "Time", "reload_framing.time", FT_RELATIVE_TIME,\r\nBASE_NONE, NULL, 0x0, "The time between the Request and the Response", HFILL\r\n}\r\n},\r\n{ &hf_reload_framing_duplicate,\r\n{ "Duplicated original message in", "reload_framing.duplicate", FT_FRAMENUM,\r\nBASE_NONE, NULL, 0x0, "This is a duplicate of RELOAD message in this frame", HFILL\r\n}\r\n},\r\n};\r\nstatic gint *ett[] = {\r\n&ett_reload_framing,\r\n&ett_reload_framing_message,\r\n&ett_reload_framing_received,\r\n};\r\nstatic ei_register_info ei[] = {\r\n{ &ei_reload_no_dissector, { "reload_framing.no_dissector", PI_PROTOCOL, PI_WARN, "Can not find reload dissector", EXPFILL }},\r\n};\r\nexpert_module_t* expert_reload_framing;\r\nproto_reload_framing = proto_register_protocol("REsource LOcation And Discovery Framing", "RELOAD FRAMING", "reload-framing");\r\nproto_register_field_array(proto_reload_framing, hf, array_length(hf));\r\nproto_register_subtree_array(ett, array_length(ett));\r\nexpert_reload_framing = expert_register_protocol(proto_reload_framing);\r\nexpert_register_field_array(expert_reload_framing, ei, array_length(ei));\r\nnew_register_dissector("reload-framing", dissect_reload_framing, proto_reload_framing);\r\n}\r\nvoid\r\nproto_reg_handoff_reload_framing(void)\r\n{\r\ndissector_handle_t reload_framing_tcp_handle;\r\ndissector_handle_t reload_framing_udp_handle;\r\nreload_framing_tcp_handle = new_create_dissector_handle(dissect_reload_framing_tcp, proto_reload_framing);\r\nreload_framing_udp_handle = new_create_dissector_handle(dissect_reload_framing, proto_reload_framing);\r\nreload_handle = find_dissector("reload");\r\ndissector_add_uint("tcp.port", TCP_PORT_RELOAD, reload_framing_tcp_handle);\r\ndissector_add_uint("udp.port", UDP_PORT_RELOAD, reload_framing_udp_handle);\r\nheur_dissector_add("udp", dissect_reload_framing_heur, proto_reload_framing);\r\nheur_dissector_add("tcp", dissect_reload_framing_heur, proto_reload_framing);\r\nheur_dissector_add("dtls", dissect_reload_framing_heur_dtls, proto_reload_framing);\r\nexported_pdu_tap = find_tap_id(EXPORT_PDU_TAP_NAME_LAYER_7);\r\n}

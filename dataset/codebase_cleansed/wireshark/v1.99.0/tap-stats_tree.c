static void\r\ndraw_stats_tree(void *psp)\r\n{\r\nstats_tree *st = (stats_tree *)psp;\r\nGString *s;\r\ns= stats_tree_format_as_str(st, ST_FORMAT_PLAIN, stats_tree_get_default_sort_col(st),\r\nstats_tree_is_default_sort_DESC(st));\r\nprintf("%s",s->str);\r\ng_string_free(s,TRUE);\r\n}\r\nstatic void\r\ninit_stats_tree(const char *opt_arg, void *userdata _U_)\r\n{\r\nchar *abbr = stats_tree_get_abbr(opt_arg);\r\nGString *error_string;\r\nstats_tree_cfg *cfg = NULL;\r\nstats_tree *st = NULL;\r\nif (abbr) {\r\ncfg = stats_tree_get_cfg_by_abbr(abbr);\r\nif (cfg != NULL) {\r\nif (strncmp (opt_arg, cfg->pr->init_string, strlen(cfg->pr->init_string)) == 0){\r\nst = stats_tree_new(cfg,NULL,opt_arg+strlen(cfg->pr->init_string));\r\n} else {\r\nreport_failure("Wrong stats_tree (%s) found when looking at ->init_string",abbr);\r\nreturn;\r\n}\r\n} else {\r\nreport_failure("no such stats_tree (%s) found in stats_tree registry",abbr);\r\nreturn;\r\n}\r\ng_free(abbr);\r\n} else {\r\nreport_failure("could not obtain stats_tree abbr (%s) from arg '%s'",abbr,opt_arg);\r\nreturn;\r\n}\r\nerror_string = register_tap_listener(st->cfg->tapname,\r\nst,\r\nst->filter,\r\nst->cfg->flags,\r\nstats_tree_reset,\r\nstats_tree_packet,\r\ndraw_stats_tree);\r\nif (error_string) {\r\nreport_failure("stats_tree for: %s failed to attach to the tap: %s",cfg->name,error_string->str);\r\nreturn;\r\n}\r\nif (cfg->init) cfg->init(st);\r\n}\r\nstatic void\r\nregister_stats_tree_tap (gpointer k _U_, gpointer v, gpointer p _U_)\r\n{\r\nstats_tree_cfg *cfg = (stats_tree_cfg *)v;\r\ncfg->pr = (tree_cfg_pres *)g_malloc(sizeof(tree_cfg_pres));\r\ncfg->pr->init_string = g_strdup_printf("%s,tree", cfg->abbr);\r\nregister_stat_cmd_arg(cfg->pr->init_string, init_stats_tree, NULL);\r\n}\r\nstatic void\r\nfree_tree_presentation(stats_tree *st)\r\n{\r\ng_free(st->pr);\r\n}\r\nvoid\r\nregister_tap_listener_stats_tree_stat(void)\r\n{\r\nstats_tree_presentation(register_stats_tree_tap, NULL, NULL, NULL, NULL,\r\nNULL, free_tree_presentation, NULL, NULL, NULL);\r\n}

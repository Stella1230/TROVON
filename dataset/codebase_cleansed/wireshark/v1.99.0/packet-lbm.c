static void lbm_init(void)\r\n{\r\nlbm_channel_reset();\r\n}\r\nvoid proto_register_lbm(void)\r\n{\r\nregister_init_routine(lbm_init);\r\n}\r\nvoid lbm_channel_reset(void)\r\n{\r\nlbm_next_channel_value = 1;\r\n}\r\nguint64 lbm_channel_assign(guint8 channel_type)\r\n{\r\nguint64 ch;\r\nguint64 ch_counter = lbm_next_channel_value++;\r\nif (lbm_next_channel_value == LBM_CHANNEL_MAX_VALUE)\r\n{\r\nlbm_next_channel_value = 1;\r\n}\r\nch = ((guint64)((ch_counter & LBM_CHANNEL_VALUE_LIMIT_MASK) << LBM_CHANNEL_VALUE_SHIFT_COUNT)) | channel_type;\r\nreturn (ch);\r\n}\r\ngboolean lbm_channel_is_transport(guint64 channel)\r\n{\r\nguint8 ch_type;\r\nch_type = LBM_CHANNEL_TYPE(channel);\r\nswitch (ch_type)\r\n{\r\ncase LBM_CHANNEL_TRANSPORT_LBTTCP:\r\ncase LBM_CHANNEL_TRANSPORT_LBTRU:\r\ncase LBM_CHANNEL_TRANSPORT_LBTRM:\r\ncase LBM_CHANNEL_TRANSPORT_LBTIPC:\r\ncase LBM_CHANNEL_TRANSPORT_LBTRDMA:\r\ncase LBM_CHANNEL_TRANSPORT_LBTSMX:\r\nreturn (TRUE);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn (FALSE);\r\n}\r\nguint8 lbm_channel_type(guint64 channel)\r\n{\r\nguint8 ch_type;\r\nch_type = LBM_CHANNEL_TYPE(channel);\r\nreturn (ch_type);\r\n}\r\nguint64 lbm_channel_assign_unknown_transport_source_lbttcp(void)\r\n{\r\nreturn (LBM_CHANNEL_UNKNOWN_TRANSPORT_SOURCE_LBTTCP);\r\n}\r\nguint64 lbm_channel_assign_unknown_transport_client_lbttcp(void)\r\n{\r\nreturn (LBM_CHANNEL_UNKNOWN_TRANSPORT_CLIENT_LBTTCP);\r\n}\r\nguint64 lbm_channel_assign_unknown_stream_tcp(void)\r\n{\r\nreturn (LBM_CHANNEL_UNKNOWN_STREAM_TCP);\r\n}\r\ngboolean lbm_channel_is_unknown_transport_lbttcp(guint64 channel)\r\n{\r\nreturn (lbm_channel_is_unknown_transport_source_lbttcp(channel) || lbm_channel_is_unknown_transport_client_lbttcp(channel));\r\n}\r\ngboolean lbm_channel_is_unknown_transport_source_lbttcp(guint64 channel)\r\n{\r\nif (channel == LBM_CHANNEL_UNKNOWN_TRANSPORT_SOURCE_LBTTCP)\r\n{\r\nreturn (TRUE);\r\n}\r\nreturn (FALSE);\r\n}\r\ngboolean lbm_channel_is_unknown_transport_client_lbttcp(guint64 channel)\r\n{\r\nif (channel == LBM_CHANNEL_UNKNOWN_TRANSPORT_CLIENT_LBTTCP)\r\n{\r\nreturn (TRUE);\r\n}\r\nreturn (FALSE);\r\n}\r\ngboolean lbm_channel_is_unknown_stream_tcp(guint64 channel)\r\n{\r\nif (channel == LBM_CHANNEL_UNKNOWN_STREAM_TCP)\r\n{\r\nreturn (TRUE);\r\n}\r\nreturn (FALSE);\r\n}\r\ngboolean lbm_channel_is_known(guint64 channel)\r\n{\r\nreturn (!lbm_channel_is_unknown_transport_lbttcp(channel) && !lbm_channel_is_unknown_stream_tcp(channel));\r\n}\r\nlbm_transport_frame_t * lbm_transport_frame_add(wmem_tree_t * list, guint8 type, guint32 frame, guint32 sqn, gboolean retransmission)\r\n{\r\nlbm_transport_frame_t * frame_entry = NULL;\r\nframe_entry = (lbm_transport_frame_t *) wmem_tree_lookup32(list, frame);\r\nif (frame_entry != NULL)\r\n{\r\nreturn (frame_entry);\r\n}\r\nframe_entry = wmem_new(wmem_file_scope(), lbm_transport_frame_t);\r\nframe_entry->frame = frame;\r\nframe_entry->type = type;\r\nframe_entry->sqn = sqn;\r\nframe_entry->previous_frame = 0;\r\nframe_entry->previous_type_frame = 0;\r\nframe_entry->next_frame = 0;\r\nframe_entry->next_type_frame = 0;\r\nframe_entry->retransmission = retransmission;\r\nframe_entry->sqn_gap = 0;\r\nframe_entry->ooo_gap = 0;\r\nframe_entry->duplicate = FALSE;\r\nwmem_tree_insert32(list, frame, (void *) frame_entry);\r\nreturn (frame_entry);\r\n}\r\nlbm_transport_sqn_t * lbm_transport_sqn_add(wmem_tree_t * list, lbm_transport_frame_t * frame)\r\n{\r\nlbm_transport_sqn_t * sqn_entry = NULL;\r\nlbm_transport_sqn_frame_t * frame_entry = NULL;\r\nsqn_entry = (lbm_transport_sqn_t *) wmem_tree_lookup32(list, frame->sqn);\r\nif (sqn_entry == NULL)\r\n{\r\nsqn_entry = wmem_new(wmem_file_scope(), lbm_transport_sqn_t);\r\nsqn_entry->sqn = frame->sqn;\r\nsqn_entry->frame_count = 0;\r\nsqn_entry->frame = wmem_tree_new(wmem_file_scope());\r\nwmem_tree_insert32(list, frame->sqn, (void *) sqn_entry);\r\n}\r\nframe_entry = wmem_new(wmem_file_scope(), lbm_transport_sqn_frame_t);\r\nframe_entry->frame = frame->frame;\r\nframe_entry->retransmission = frame->retransmission;\r\nwmem_tree_insert32(sqn_entry->frame, frame->frame, (void *) frame_entry);\r\nsqn_entry->frame_count++;\r\nreturn (sqn_entry);\r\n}\r\nvoid lbm_topic_init(void)\r\n{\r\nlbm_topic_table = wmem_tree_new_autoreset(wmem_epan_scope(), wmem_file_scope());\r\n}\r\nstatic void lbm_topic_build_key(guint32 * key_value, wmem_tree_key_t * key, guint64 channel, guint32 topic_index)\r\n{\r\nkey_value[LBM_TOPIC_KEY_ELEMENT_CHANNEL_HIGH] = (guint32) ((channel >> 32) & 0xffffffff);\r\nkey_value[LBM_TOPIC_KEY_ELEMENT_CHANNEL_LOW] = (guint32) ((channel & 0xffffffff) >> 32);\r\nkey_value[LBM_TOPIC_KEY_ELEMENT_TOPIC_INDEX] = topic_index;\r\nkey[0].length = LBM_TOPIC_KEY_ELEMENT_COUNT;\r\nkey[0].key = key_value;\r\nkey[1].length = 0;\r\nkey[1].key = NULL;\r\n}\r\nstatic lbm_topic_t * lbm_topic_locate(guint64 channel, guint32 topic_index)\r\n{\r\nlbm_topic_t * entry = NULL;\r\nguint32 keyval[LBM_TOPIC_KEY_ELEMENT_COUNT];\r\nwmem_tree_key_t tkey[2];\r\nlbm_topic_build_key(keyval, tkey, channel, topic_index);\r\nentry = (lbm_topic_t *) wmem_tree_lookup32_array(lbm_topic_table, tkey);\r\nreturn (entry);\r\n}\r\nconst char * lbm_topic_find(guint64 channel, guint32 topic_index)\r\n{\r\nlbm_topic_t * entry = NULL;\r\nconst char * topic = NULL;\r\nentry = lbm_topic_locate(channel, topic_index);\r\nif (entry != NULL)\r\n{\r\ntopic = entry->topic;\r\n}\r\nreturn (topic);\r\n}\r\nvoid lbm_topic_add(guint64 channel, guint32 topic_index, const char * name)\r\n{\r\nlbm_topic_t * entry;\r\nguint32 keyval[LBM_TOPIC_KEY_ELEMENT_COUNT];\r\nwmem_tree_key_t tkey[2];\r\nentry = lbm_topic_locate(channel, topic_index);\r\nif (entry != NULL)\r\n{\r\nreturn;\r\n}\r\nentry = wmem_new(wmem_file_scope(), lbm_topic_t);\r\nentry->key.channel = channel;\r\nentry->key.topic_idx = topic_index;\r\nentry->key.topic = entry;\r\nentry->topic = wmem_strdup(wmem_file_scope(), name);\r\nlbm_topic_build_key(keyval, tkey, channel, topic_index);\r\nwmem_tree_insert32_array(lbm_topic_table, tkey, (void *) entry);\r\n}

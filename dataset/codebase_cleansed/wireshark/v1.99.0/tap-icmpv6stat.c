static void\r\nicmpv6stat_reset(void *tapdata)\r\n{\r\nicmpv6stat_t *icmpv6stat = (icmpv6stat_t *)tapdata;\r\ng_slist_free(icmpv6stat->rt_list);\r\nmemset(icmpv6stat, 0, sizeof(icmpv6stat_t));\r\nicmpv6stat->min_msecs = 1.0 * G_MAXUINT;\r\n}\r\nstatic gint compare_doubles(gconstpointer a, gconstpointer b)\r\n{\r\ndouble ad, bd;\r\nad = *(const double *)a;\r\nbd = *(const double *)b;\r\nif (ad < bd)\r\nreturn -1;\r\nif (ad > bd)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nicmpv6stat_packet(void *tapdata, packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *data)\r\n{\r\nicmpv6stat_t *icmpv6stat = (icmpv6stat_t *)tapdata;\r\nconst icmp_transaction_t *trans = (const icmp_transaction_t *)data;\r\ndouble resp_time, *rt;\r\nif (trans == NULL)\r\nreturn 0;\r\nif (trans->resp_frame) {\r\nresp_time = nstime_to_msec(&trans->resp_time);\r\nrt = g_new(double,1);\r\nif (rt == NULL)\r\nreturn 0;\r\n*rt = resp_time;\r\nicmpv6stat->rt_list = g_slist_prepend(icmpv6stat->rt_list, rt);\r\nicmpv6stat->num_resps++;\r\nif (icmpv6stat->min_msecs > resp_time) {\r\nicmpv6stat->min_frame = trans->resp_frame;\r\nicmpv6stat->min_msecs = resp_time;\r\n}\r\nif (icmpv6stat->max_msecs < resp_time) {\r\nicmpv6stat->max_frame = trans->resp_frame;\r\nicmpv6stat->max_msecs = resp_time;\r\n}\r\nicmpv6stat->tot_msecs += resp_time;\r\n} else if (trans->rqst_frame)\r\nicmpv6stat->num_rqsts++;\r\nelse\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void compute_stats(icmpv6stat_t *icmpv6stat, double *mean, double *med, double *sdev)\r\n{\r\nGSList *slist;\r\ndouble diff;\r\ndouble sq_diff_sum = 0.0;\r\nicmpv6stat->rt_list = g_slist_sort(icmpv6stat->rt_list, compare_doubles);\r\nslist = icmpv6stat->rt_list;\r\nif (icmpv6stat->num_resps == 0 || slist == NULL) {\r\n*mean = 0.0;\r\n*med = 0.0;\r\n*sdev = 0.0;\r\nreturn;\r\n}\r\n*mean = icmpv6stat->tot_msecs / icmpv6stat->num_resps;\r\nif (icmpv6stat->num_resps & 1)\r\n*med = *(double *)g_slist_nth_data(slist, icmpv6stat->num_resps / 2);\r\nelse {\r\n*med =\r\n(*(double *)g_slist_nth_data(slist, (icmpv6stat->num_resps - 1) / 2) +\r\n*(double *)g_slist_nth_data(slist, icmpv6stat->num_resps / 2)) / 2;\r\n}\r\nfor ( ; slist; slist = g_slist_next(slist)) {\r\ndiff = *(double *)slist->data - *mean;\r\nsq_diff_sum += diff * diff;\r\n}\r\nif (icmpv6stat->num_resps > 1)\r\n*sdev = sqrt(sq_diff_sum / (icmpv6stat->num_resps - 1));\r\nelse\r\n*sdev = 0.0;\r\n}\r\nstatic void\r\nicmpv6stat_draw(void *tapdata)\r\n{\r\nicmpv6stat_t *icmpv6stat = (icmpv6stat_t *)tapdata;\r\nunsigned int lost;\r\ndouble mean, sdev, med;\r\nprintf("\n");\r\nprintf("==========================================================================\n");\r\nprintf("ICMPv6 Service Response Time (SRT) Statistics (all times in ms):\n");\r\nprintf("Filter: %s\n", icmpv6stat->filter ? icmpv6stat->filter : "<none>");\r\nprintf("\nRequests Replies Lost %% Loss\n");\r\nif (icmpv6stat->num_rqsts) {\r\nlost = icmpv6stat->num_rqsts - icmpv6stat->num_resps;\r\ncompute_stats(icmpv6stat, &mean, &med, &sdev);\r\nprintf("%-10u%-10u%-10u%5.1f%%\n\n",\r\nicmpv6stat->num_rqsts, icmpv6stat->num_resps, lost,\r\n100.0 * lost / icmpv6stat->num_rqsts);\r\nprintf("Minimum Maximum Mean Median SDeviation Min Frame Max Frame\n");\r\nprintf("%-10.3f%-10.3f%-10.3f%-10.3f%-10.3f %-10u%-10u\n",\r\nicmpv6stat->min_msecs >= G_MAXUINT ? 0.0 : icmpv6stat->min_msecs,\r\nicmpv6stat->max_msecs, mean, med, sdev,\r\nicmpv6stat->min_frame, icmpv6stat->max_frame);\r\n} else {\r\nprintf("0 0 0 0.0%%\n\n");\r\nprintf("Minimum Maximum Mean Median SDeviation Min Frame Max Frame\n");\r\nprintf("0.000 0.000 0.000 0.000 0.000 0 0\n");\r\n}\r\nprintf("==========================================================================\n");\r\n}\r\nstatic void\r\nicmpv6stat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nicmpv6stat_t *icmpv6stat;\r\nconst char *filter = NULL;\r\nGString *error_string;\r\nif (strstr(opt_arg, "icmpv6,srt,"))\r\nfilter = opt_arg + strlen("icmpv6,srt,");\r\nicmpv6stat = (icmpv6stat_t *)g_try_malloc(sizeof(icmpv6stat_t));\r\nif (icmpv6stat == NULL) {\r\nfprintf(stderr, "tshark: g_try_malloc() fatal error.\n");\r\nexit(1);\r\n}\r\nmemset(icmpv6stat, 0, sizeof(icmpv6stat_t));\r\nicmpv6stat->min_msecs = 1.0 * G_MAXUINT;\r\nif (filter)\r\nicmpv6stat->filter = g_strdup(filter);\r\nerror_string = register_tap_listener("icmpv6", icmpv6stat, icmpv6stat->filter,\r\nTL_REQUIRES_NOTHING, icmpv6stat_reset, icmpv6stat_packet, icmpv6stat_draw);\r\nif (error_string) {\r\nif (icmpv6stat->filter)\r\ng_free(icmpv6stat->filter);\r\ng_free(icmpv6stat);\r\nfprintf(stderr, "tshark: Couldn't register icmpv6,srt tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_icmpv6stat(void)\r\n{\r\nregister_stat_cmd_arg("icmpv6,srt", icmpv6stat_init, NULL);\r\n}

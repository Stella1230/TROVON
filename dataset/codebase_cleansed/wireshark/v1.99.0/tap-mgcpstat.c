static int\r\nmgcpstat_packet(void *pms, packet_info *pinfo, epan_dissect_t *edt _U_, const void *pmi)\r\n{\r\nmgcpstat_t *ms=(mgcpstat_t *)pms;\r\nconst mgcp_info_t *mi=(const mgcp_info_t *)pmi;\r\nnstime_t delta;\r\nint ret = 0;\r\nswitch (mi->mgcp_type) {\r\ncase MGCP_REQUEST:\r\nif(mi->is_duplicate){\r\nms->req_dup_num++;\r\n}\r\nelse {\r\nms->open_req_num++;\r\n}\r\nbreak;\r\ncase MGCP_RESPONSE:\r\nif(mi->is_duplicate){\r\nms->rsp_dup_num++;\r\n}\r\nelse if (!mi->request_available) {\r\nms->disc_rsp_num++;\r\n}\r\nelse {\r\nms->open_req_num--;\r\nnstime_delta(&delta, &pinfo->fd->abs_ts, &mi->req_time);\r\ntime_stat_update(&(ms->rtd[0]),&delta, pinfo);\r\nif (g_ascii_strncasecmp(mi->code, "EPCF", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[1]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "CRCX", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[2]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "MDCX", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[3]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "DLCX", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[4]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "RQNT", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[5]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "NTFY", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[6]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "AUEP", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[7]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "AUCX", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[8]),&delta, pinfo);\r\n}\r\nelse if (g_ascii_strncasecmp(mi->code, "RSIP", 4) == 0 ) {\r\ntime_stat_update(&(ms->rtd[9]),&delta, pinfo);\r\n}\r\nelse {\r\ntime_stat_update(&(ms->rtd[10]),&delta, pinfo);\r\n}\r\nret = 1;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void\r\nmgcpstat_draw(void *pms)\r\n{\r\nmgcpstat_t *ms=(mgcpstat_t *)pms;\r\nint i;\r\nprintf("\n");\r\nprintf("=====================================================================================================\n");\r\nprintf("MGCP Response Time Delay (RTD) Statistics:\n");\r\nprintf("Filter for statistics: %s\n",ms->filter?ms->filter:"");\r\nprintf("Duplicate requests: %u\n",ms->req_dup_num);\r\nprintf("Duplicate responses: %u\n",ms->rsp_dup_num);\r\nprintf("Open requests: %u\n",ms->open_req_num);\r\nprintf("Discarded responses: %u\n",ms->disc_rsp_num);\r\nprintf("Type | Messages | Min RTD | Max RTD | Avg RTD | Min in Frame | Max in Frame |\n");\r\nfor(i=0;i<NUM_TIMESTATS;i++) {\r\nif(ms->rtd[i].num) {\r\nprintf("%s | %7u | %8.2f msec | %8.2f msec | %8.2f msec | %10u | %10u |\n",\r\nval_to_str(i,mgcp_mesage_type,"Other "),ms->rtd[i].num,\r\nnstime_to_msec(&(ms->rtd[i].min)), nstime_to_msec(&(ms->rtd[i].max)),\r\nget_average(&(ms->rtd[i].tot), ms->rtd[i].num),\r\nms->rtd[i].min_num, ms->rtd[i].max_num\r\n);\r\n}\r\n}\r\nprintf("=====================================================================================================\n");\r\n}\r\nstatic void\r\nmgcpstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nmgcpstat_t *ms;\r\nint i;\r\nGString *error_string;\r\nms=g_new(mgcpstat_t,1);\r\nif(!strncmp(opt_arg,"mgcp,rtd,",9)){\r\nms->filter=g_strdup(opt_arg+9);\r\n} else {\r\nms->filter=NULL;\r\n}\r\nfor(i=0;i<NUM_TIMESTATS;i++) {\r\nms->rtd[i].num=0;\r\nms->rtd[i].min_num=0;\r\nms->rtd[i].max_num=0;\r\nms->rtd[i].min.secs=0;\r\nms->rtd[i].min.nsecs=0;\r\nms->rtd[i].max.secs=0;\r\nms->rtd[i].max.nsecs=0;\r\nms->rtd[i].tot.secs=0;\r\nms->rtd[i].tot.nsecs=0;\r\n}\r\nms->open_req_num=0;\r\nms->disc_rsp_num=0;\r\nms->req_dup_num=0;\r\nms->rsp_dup_num=0;\r\nerror_string=register_tap_listener("mgcp", ms, ms->filter, 0, NULL, mgcpstat_packet, mgcpstat_draw);\r\nif(error_string){\r\ng_free(ms->filter);\r\ng_free(ms);\r\nfprintf(stderr, "tshark: Couldn't register mgcp,rtd tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_mgcpstat(void)\r\n{\r\nif (find_tap_id("mgcp")) {\r\nregister_stat_cmd_arg("mgcp,rtd", mgcpstat_init, NULL);\r\n}\r\n}

static void rtpstream_draw(void *arg _U_)\r\n{\r\nrtpstream_dlg_update(the_tapinfo_struct.strinfo_list);\r\nreturn;\r\n}\r\nvoid rtpstream_scan(void)\r\n{\r\ngboolean was_registered = the_tapinfo_struct.is_registered;\r\nif (!the_tapinfo_struct.is_registered)\r\nregister_tap_listener_rtp_stream();\r\nthe_tapinfo_struct.mode = TAP_ANALYSE;\r\ncf_retap_packets(&cfile);\r\nif (!was_registered)\r\nremove_tap_listener_rtp_stream();\r\n}\r\ngboolean rtpstream_save(rtp_stream_info_t* stream, const gchar *filename)\r\n{\r\ngboolean was_registered = the_tapinfo_struct.is_registered;\r\nthe_tapinfo_struct.save_file = ws_fopen(filename, "wb");\r\nif (the_tapinfo_struct.save_file==NULL) {\r\nopen_failure_alert_box(filename, errno, TRUE);\r\nreturn FALSE;\r\n}\r\nrtp_write_header(stream, the_tapinfo_struct.save_file);\r\nif (ferror(the_tapinfo_struct.save_file)) {\r\nwrite_failure_alert_box(filename, errno);\r\nfclose(the_tapinfo_struct.save_file);\r\nreturn FALSE;\r\n}\r\nif (!the_tapinfo_struct.is_registered)\r\nregister_tap_listener_rtp_stream();\r\nthe_tapinfo_struct.mode = TAP_SAVE;\r\nthe_tapinfo_struct.filter_stream_fwd = stream;\r\ncf_retap_packets(&cfile);\r\nthe_tapinfo_struct.mode = TAP_ANALYSE;\r\nif (!was_registered)\r\nremove_tap_listener_rtp_stream();\r\nif (ferror(the_tapinfo_struct.save_file)) {\r\nwrite_failure_alert_box(filename, errno);\r\nfclose(the_tapinfo_struct.save_file);\r\nreturn FALSE;\r\n}\r\nif (fclose(the_tapinfo_struct.save_file) == EOF) {\r\nwrite_failure_alert_box(filename, errno);\r\nreturn FALSE;\r\n}\r\nreturn TRUE;\r\n}\r\nvoid rtpstream_mark(rtp_stream_info_t* stream_fwd, rtp_stream_info_t* stream_rev)\r\n{\r\ngboolean was_registered = the_tapinfo_struct.is_registered;\r\nif (!the_tapinfo_struct.is_registered)\r\nregister_tap_listener_rtp_stream();\r\nthe_tapinfo_struct.mode = TAP_MARK;\r\nthe_tapinfo_struct.filter_stream_fwd = stream_fwd;\r\nthe_tapinfo_struct.filter_stream_rev = stream_rev;\r\ncf_retap_packets(&cfile);\r\nthe_tapinfo_struct.mode = TAP_ANALYSE;\r\nif (!was_registered)\r\nremove_tap_listener_rtp_stream();\r\n}\r\nconst rtpstream_tapinfo_t* rtpstream_get_info(void)\r\n{\r\nreturn &the_tapinfo_struct;\r\n}\r\nvoid\r\nremove_tap_listener_rtp_stream(void)\r\n{\r\nif (the_tapinfo_struct.is_registered) {\r\nremove_tap_listener(&the_tapinfo_struct);\r\nthe_tapinfo_struct.is_registered = FALSE;\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_rtp_stream(void)\r\n{\r\nGString *error_string;\r\nif (!the_tapinfo_struct.is_registered) {\r\nerror_string = register_tap_listener("rtp", &the_tapinfo_struct,\r\nNULL, 0, rtpstream_reset_cb, rtpstream_packet,\r\nrtpstream_draw);\r\nif (error_string != NULL) {\r\nsimple_dialog(ESD_TYPE_ERROR, ESD_BTN_OK,\r\n"%s", error_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\nthe_tapinfo_struct.is_registered = TRUE;\r\n}\r\n}

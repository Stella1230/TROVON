GtkWidget *\r\npacket_list_create(void)\r\n{\r\nGtkWidget *view, *scrollwin;\r\nscrollwin = scrolled_window_new(NULL, NULL);\r\nview = create_view_and_model();\r\ngtk_container_add(GTK_CONTAINER(scrollwin), view);\r\ng_object_set_data(G_OBJECT(popup_menu_object), E_MPACKET_LIST_KEY, view);\r\nreturn scrollwin;\r\n}\r\nvoid\r\npacket_list_recreate(void)\r\n{\r\ng_signal_handler_block(packetlist->view, column_changed_handler_id);\r\ngtk_widget_destroy(pkt_scrollw);\r\nprefs.num_cols = g_list_length(prefs.col_list);\r\ncol_cleanup(&cfile.cinfo);\r\nbuild_column_format_array(&cfile.cinfo, prefs.num_cols, FALSE);\r\npkt_scrollw = packet_list_create();\r\ngtk_widget_show_all(pkt_scrollw);\r\nmain_widgets_rearrange();\r\nif(cfile.state != FILE_CLOSED)\r\nredissect_packets();\r\n}\r\nguint\r\npacket_list_append(column_info *cinfo _U_, frame_data *fdata)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nguint visible_pos = packet_list_append_record(packetlist, fdata);\r\nif(model)\r\npackets_bar_update();\r\nreturn visible_pos;\r\n}\r\nstatic void\r\ncol_title_change_ok (GtkWidget *w, gpointer parent_w)\r\n{\r\nGtkTreeViewColumn *col;\r\nconst gchar *title, *name, *occurrence_text;\r\ngint col_id, cur_fmt, occurrence, col_width;\r\ngchar *escaped_title;\r\ngboolean recreate = FALSE;\r\ncol = (GtkTreeViewColumn *)g_object_get_data (G_OBJECT(w), COL_EDIT_COLUMN);\r\ncol_id = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(col), E_MPACKET_LIST_COL_KEY));\r\ntitle = gtk_entry_get_text(GTK_ENTRY(g_object_get_data (G_OBJECT(w), COL_EDIT_TITLE_TE)));\r\nname = gtk_entry_get_text(GTK_ENTRY(g_object_get_data (G_OBJECT(w), COL_EDIT_FIELD_TE)));\r\ncur_fmt = gtk_combo_box_get_active(GTK_COMBO_BOX(g_object_get_data (G_OBJECT(w), COL_EDIT_FORMAT_CMB)));\r\noccurrence_text = gtk_entry_get_text(GTK_ENTRY(g_object_get_data (G_OBJECT(w), COL_EDIT_OCCURRENCE_TE)));\r\noccurrence = (gint)strtol(occurrence_text, NULL, 10);\r\nescaped_title = ws_strdup_escape_char(title, '_');\r\ngtk_tree_view_column_set_title(col, escaped_title);\r\ng_free(escaped_title);\r\nif (strcmp (title, get_column_title(col_id)) != 0) {\r\nset_column_title (col_id, title);\r\n}\r\nif (cur_fmt != get_column_format(col_id)) {\r\nset_column_format (col_id, cur_fmt);\r\nrecreate = TRUE;\r\n}\r\nif (cur_fmt == COL_CUSTOM) {\r\nif (strcmp (name, get_column_custom_field(col_id)) != 0) {\r\nset_column_custom_field (col_id, name);\r\nrecreate = TRUE;\r\n}\r\nif (occurrence != get_column_custom_occurrence(col_id)) {\r\nset_column_custom_occurrence (col_id, occurrence);\r\nrecreate = TRUE;\r\n}\r\n}\r\ncol_width = get_default_col_size (packetlist->view, title);\r\ngtk_tree_view_column_set_min_width(col, col_width);\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_write();\r\n}\r\nrebuild_visible_columns_menu ();\r\nif (recreate) {\r\npacket_list_recreate();\r\n}\r\npacket_list_resize_column (col_id);\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\ncol_title_change_cancel (GtkWidget *w _U_, gpointer parent_w)\r\n{\r\nwindow_destroy(GTK_WIDGET(parent_w));\r\n}\r\nstatic void\r\ncol_details_format_changed_cb(GtkWidget *w, gpointer data _U_)\r\n{\r\nGtkWidget *field_lb, *field_te, *occurrence_lb, *occurrence_te;\r\ngint cur_fmt;\r\nfield_lb = (GtkWidget *)g_object_get_data (G_OBJECT(w), COL_EDIT_FIELD_LB);\r\nfield_te = (GtkWidget *)g_object_get_data (G_OBJECT(w), COL_EDIT_FIELD_TE);\r\noccurrence_lb = (GtkWidget *)g_object_get_data (G_OBJECT(w), COL_EDIT_OCCURRENCE_LB);\r\noccurrence_te = (GtkWidget *)g_object_get_data (G_OBJECT(w), COL_EDIT_OCCURRENCE_TE);\r\ncur_fmt = gtk_combo_box_get_active(GTK_COMBO_BOX(w));\r\nif (cur_fmt == COL_CUSTOM) {\r\ngtk_widget_set_sensitive(field_lb, TRUE);\r\ngtk_widget_set_sensitive(field_te, TRUE);\r\ngtk_widget_set_sensitive(occurrence_lb, TRUE);\r\ngtk_widget_set_sensitive(occurrence_te, TRUE);\r\n} else {\r\ngtk_widget_set_sensitive(field_lb, FALSE);\r\ngtk_widget_set_sensitive(field_te, FALSE);\r\ngtk_widget_set_sensitive(occurrence_lb, FALSE);\r\ngtk_widget_set_sensitive(occurrence_te, FALSE);\r\n}\r\n}\r\nstatic void\r\ncol_details_edit_dlg (gint col_id, GtkTreeViewColumn *col)\r\n{\r\nconst gchar *title = gtk_tree_view_column_get_title(col);\r\ngchar *unescaped_title = ws_strdup_unescape_char(title, '_');\r\nGtkWidget *label, *field_lb, *occurrence_lb;\r\nGtkWidget *title_te, *format_cmb, *field_te, *occurrence_te;\r\nGtkWidget *win, *main_grid, *main_vb, *bbox, *cancel_bt, *ok_bt;\r\nchar custom_occurrence_str[8];\r\ngint cur_fmt, i;\r\nwin = dlg_window_new("Wireshark: Edit Column Details");\r\ngtk_window_set_resizable(GTK_WINDOW(win),FALSE);\r\ngtk_window_resize(GTK_WINDOW(win), 400, 100);\r\nmain_vb = ws_gtk_box_new(GTK_ORIENTATION_VERTICAL, 6, FALSE);\r\ngtk_container_add(GTK_CONTAINER(win), main_vb);\r\ngtk_container_set_border_width(GTK_CONTAINER(main_vb), 6);\r\nmain_grid = ws_gtk_grid_new();\r\ngtk_box_pack_start(GTK_BOX(main_vb), main_grid, FALSE, FALSE, 0);\r\nws_gtk_grid_set_column_spacing(GTK_GRID(main_grid), 10);\r\nws_gtk_grid_set_row_spacing(GTK_GRID(main_grid), 5);\r\nlabel = gtk_label_new("Title:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, 0, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\ngtk_widget_set_tooltip_text(label, "Packet list column title.");\r\ntitle_te = gtk_entry_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), title_te, 1, 0, 1, 1);\r\ngtk_entry_set_text(GTK_ENTRY(title_te), unescaped_title);\r\ng_free(unescaped_title);\r\ngtk_widget_set_tooltip_text(title_te, "Packet list column title.");\r\nlabel = gtk_label_new("Field type:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), label, 0, 1, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(label), 1.0f, 0.5f);\r\ngtk_widget_set_tooltip_text(label, "Select which packet information to present in the column.");\r\nformat_cmb = gtk_combo_box_text_new();\r\nfor (i = 0; i < NUM_COL_FMTS; i++) {\r\ngtk_combo_box_text_append_text (GTK_COMBO_BOX_TEXT(format_cmb), col_format_desc(i));\r\n}\r\ng_signal_connect(format_cmb, "changed", G_CALLBACK(col_details_format_changed_cb), NULL);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), format_cmb, 1, 1, 1, 1);\r\ngtk_widget_set_tooltip_text(format_cmb, "Select which packet information to present in the column.");\r\nfield_lb = gtk_label_new("Field name:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), field_lb, 0, 2, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(field_lb), 1.0f, 0.5f);\r\ngtk_widget_set_tooltip_text(field_lb,\r\n"Field name used when field type is \"Custom\". "\r\n"This string has the same syntax as a display filter string.");\r\nfield_te = gtk_entry_new();\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), field_te, 1, 2, 1, 1);\r\ng_object_set_data (G_OBJECT(field_te), E_FILT_FIELD_NAME_ONLY_KEY, (gpointer)"");\r\ng_signal_connect(field_te, "changed", G_CALLBACK(filter_te_syntax_check_cb), NULL);\r\ng_signal_connect(field_te, "key-press-event", G_CALLBACK (filter_string_te_key_pressed_cb), NULL);\r\ng_signal_connect(win, "key-press-event", G_CALLBACK (filter_parent_dlg_key_pressed_cb), NULL);\r\ngtk_widget_set_tooltip_text(field_te,\r\n"Field name used when field type is \"Custom\". "\r\n"This string has the same syntax as a display filter string.");\r\noccurrence_lb = gtk_label_new("Occurrence:");\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), occurrence_lb, 0, 3, 1, 1);\r\ngtk_misc_set_alignment(GTK_MISC(occurrence_lb), 1.0f, 0.5f);\r\ngtk_widget_set_tooltip_text (occurrence_lb,\r\n"Field occurrence to use. "\r\n"0=all (default), 1=first, 2=second, ..., -1=last.");\r\noccurrence_te = gtk_entry_new();\r\ngtk_entry_set_max_length (GTK_ENTRY(occurrence_te), 4);\r\nws_gtk_grid_attach_defaults(GTK_GRID(main_grid), occurrence_te, 1, 3, 1, 1);\r\ngtk_widget_set_tooltip_text (occurrence_te,\r\n"Field occurrence to use. "\r\n"0=all (default), 1=first, 2=second, ..., -1=last.");\r\nbbox = dlg_button_row_new(GTK_STOCK_CANCEL,GTK_STOCK_OK, NULL);\r\ngtk_box_pack_end(GTK_BOX(main_vb), bbox, FALSE, FALSE, 0);\r\nok_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_OK);\r\ng_object_set_data (G_OBJECT(ok_bt), COL_EDIT_COLUMN, col);\r\ng_object_set_data (G_OBJECT(ok_bt), COL_EDIT_FORMAT_CMB, format_cmb);\r\ng_object_set_data (G_OBJECT(ok_bt), COL_EDIT_TITLE_TE, title_te);\r\ng_object_set_data (G_OBJECT(ok_bt), COL_EDIT_FIELD_TE, field_te);\r\ng_object_set_data (G_OBJECT(ok_bt), COL_EDIT_OCCURRENCE_TE, occurrence_te);\r\ng_object_set_data (G_OBJECT(format_cmb), COL_EDIT_FIELD_LB, field_lb);\r\ng_object_set_data (G_OBJECT(format_cmb), COL_EDIT_FIELD_TE, field_te);\r\ng_object_set_data (G_OBJECT(format_cmb), COL_EDIT_OCCURRENCE_LB, occurrence_lb);\r\ng_object_set_data (G_OBJECT(format_cmb), COL_EDIT_OCCURRENCE_TE, occurrence_te);\r\ng_signal_connect(ok_bt, "clicked", G_CALLBACK(col_title_change_ok), win);\r\ncur_fmt = get_column_format (col_id);\r\ngtk_combo_box_set_active(GTK_COMBO_BOX(format_cmb), cur_fmt);\r\nif (cur_fmt == COL_CUSTOM) {\r\ngtk_entry_set_text(GTK_ENTRY(field_te), get_column_custom_field(col_id));\r\ng_snprintf(custom_occurrence_str, sizeof(custom_occurrence_str), "%d", get_column_custom_occurrence(col_id));\r\ngtk_entry_set_text(GTK_ENTRY(occurrence_te), custom_occurrence_str);\r\n}\r\ndlg_set_activate(title_te, ok_bt);\r\ndlg_set_activate(field_te, ok_bt);\r\ndlg_set_activate(occurrence_te, ok_bt);\r\ncancel_bt = (GtkWidget *)g_object_get_data(G_OBJECT(bbox), GTK_STOCK_CANCEL);\r\ng_signal_connect(cancel_bt, "clicked", G_CALLBACK(col_title_change_cancel), win);\r\nwindow_set_cancel_button(win, cancel_bt, NULL);\r\ngtk_widget_grab_default(ok_bt);\r\ngtk_widget_show_all(win);\r\n}\r\nstatic void\r\npacket_list_sort_column (gint col_id, GtkTreeViewColumn *col, GtkSortType order, gboolean sort_indicator)\r\n{\r\nGtkTreeViewColumn *prev_col;\r\nif (col == NULL) {\r\ncol = gtk_tree_view_get_column(GTK_TREE_VIEW(packetlist->view), col_id);\r\n}\r\ng_assert(col);\r\nif (!packet_list_do_packet_list_dissect_and_cache_all(packetlist, col_id)) {\r\nreturn;\r\n}\r\nprev_col = (GtkTreeViewColumn *)\r\ng_object_get_data(G_OBJECT(packetlist->view), E_MPACKET_LIST_PREV_COLUMN_KEY);\r\nif (prev_col) {\r\ngtk_tree_view_column_set_sort_indicator(prev_col, FALSE);\r\n}\r\ngtk_tree_view_column_set_sort_indicator(col, sort_indicator);\r\ngtk_tree_view_column_set_sort_order (col, order);\r\ng_object_set_data(G_OBJECT(packetlist->view), E_MPACKET_LIST_PREV_COLUMN_KEY, col);\r\ngtk_tree_sortable_set_sort_column_id(GTK_TREE_SORTABLE(packetlist), col_id, order);\r\nscroll_to_current ();\r\n}\r\nstatic void\r\npacket_list_column_clicked_cb (GtkTreeViewColumn *col, gpointer user_data _U_)\r\n{\r\nGtkSortType order = gtk_tree_view_column_get_sort_order (col);\r\ngint col_id = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(col), E_MPACKET_LIST_COL_KEY));\r\nif (cfile.state == FILE_READ_IN_PROGRESS)\r\nreturn;\r\nif (!gtk_tree_view_column_get_sort_indicator(col)) {\r\npacket_list_sort_column (col_id, col, GTK_SORT_ASCENDING, TRUE);\r\n} else if (order == GTK_SORT_ASCENDING) {\r\npacket_list_sort_column (col_id, col, GTK_SORT_DESCENDING, TRUE);\r\n} else {\r\npacket_list_sort_column (0, NULL, GTK_SORT_ASCENDING, FALSE);\r\n}\r\n}\r\nstatic gdouble\r\nget_xalign_value (gchar xalign, gboolean right_justify)\r\n{\r\ndouble value;\r\nswitch (xalign) {\r\ncase COLUMN_XALIGN_RIGHT:\r\nvalue = 1.0f;\r\nbreak;\r\ncase COLUMN_XALIGN_CENTER:\r\nvalue = 0.5f;\r\nbreak;\r\ncase COLUMN_XALIGN_LEFT:\r\nvalue = 0.0f;\r\nbreak;\r\ncase COLUMN_XALIGN_DEFAULT:\r\ndefault:\r\nif (right_justify) {\r\nvalue = 1.0f;\r\n} else {\r\nvalue = 0.0f;\r\n}\r\nbreak;\r\n}\r\nreturn value;\r\n}\r\nstatic void\r\npacket_list_xalign_column (gint col_id, GtkTreeViewColumn *col, gchar xalign)\r\n{\r\nGList *renderers = gtk_cell_layout_get_cells (GTK_CELL_LAYOUT(col));\r\ngboolean right_justify = right_justify_column(col_id, &cfile);\r\ngdouble value = get_xalign_value (xalign, right_justify);\r\nGList *entry;\r\nGtkCellRenderer *renderer;\r\nentry = g_list_first(renderers);\r\nwhile (entry) {\r\nrenderer = (GtkCellRenderer *)entry->data;\r\ng_object_set(G_OBJECT(renderer), "xalign", value, NULL);\r\nentry = g_list_next (entry);\r\n}\r\ng_list_free (renderers);\r\nif ((xalign == COLUMN_XALIGN_LEFT && !right_justify) ||\r\n(xalign == COLUMN_XALIGN_RIGHT && right_justify)) {\r\nxalign = COLUMN_XALIGN_DEFAULT;\r\n}\r\nrecent_set_column_xalign (col_id, xalign);\r\ngtk_widget_queue_draw (packetlist->view);\r\n}\r\nstatic void\r\npacket_list_set_visible_column (gint col_id, GtkTreeViewColumn *col, gboolean visible)\r\n{\r\ngtk_tree_view_column_set_visible(col, visible);\r\nset_column_visible(col_id, visible);\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_write();\r\n}\r\nrebuild_visible_columns_menu ();\r\ngtk_widget_queue_draw (packetlist->view);\r\n}\r\nvoid\r\npacket_list_toggle_visible_column (gint col_id)\r\n{\r\nGtkTreeViewColumn *col =\r\ngtk_tree_view_get_column(GTK_TREE_VIEW(packetlist->view), col_id);\r\npacket_list_set_visible_column (col_id, col, get_column_visible(col_id) ? FALSE : TRUE);\r\n}\r\nvoid\r\npacket_list_set_all_columns_visible (void)\r\n{\r\nGtkTreeViewColumn *col;\r\nint col_id;\r\nfor (col_id = 0; col_id < cfile.cinfo.num_cols; col_id++) {\r\ncol = gtk_tree_view_get_column(GTK_TREE_VIEW(packetlist->view), col_id);\r\ngtk_tree_view_column_set_visible(col, TRUE);\r\nset_column_visible(col_id, TRUE);\r\n}\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_write();\r\n}\r\nrebuild_visible_columns_menu ();\r\ngtk_widget_queue_draw (packetlist->view);\r\n}\r\nstatic void\r\npacket_list_remove_column (gint col_id, GtkTreeViewColumn *col _U_)\r\n{\r\ncolumn_prefs_remove_nth(col_id);\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_write();\r\n}\r\npacket_list_recreate();\r\n}\r\nstatic void\r\npacket_list_toggle_resolved (GtkWidget *w, gint col_id)\r\n{\r\nif (g_object_get_data(G_OBJECT(w), "skip-update") == NULL) {\r\nset_column_resolved (col_id, get_column_resolved (col_id) ? FALSE : TRUE);\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_write();\r\n}\r\npacket_list_recreate();\r\n}\r\n}\r\nvoid\r\npacket_list_column_menu_cb (GtkWidget *w, gpointer user_data _U_, COLUMN_SELECTED_E action)\r\n{\r\nGtkTreeViewColumn *col = (GtkTreeViewColumn *)\r\ng_object_get_data(G_OBJECT(packetlist->view), E_MPACKET_LIST_COLUMN_KEY);\r\ngint col_id = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(col), E_MPACKET_LIST_COL_KEY));\r\nswitch (action) {\r\ncase COLUMN_SELECTED_SORT_ASCENDING:\r\npacket_list_sort_column (col_id, col, GTK_SORT_ASCENDING, TRUE);\r\nbreak;\r\ncase COLUMN_SELECTED_SORT_DESCENDING:\r\npacket_list_sort_column (col_id, col, GTK_SORT_DESCENDING, TRUE);\r\nbreak;\r\ncase COLUMN_SELECTED_SORT_NONE:\r\npacket_list_sort_column (0, NULL, GTK_SORT_ASCENDING, FALSE);\r\nbreak;\r\ncase COLUMN_SELECTED_TOGGLE_RESOLVED:\r\npacket_list_toggle_resolved (w, col_id);\r\nbreak;\r\ncase COLUMN_SELECTED_ALIGN_LEFT:\r\npacket_list_xalign_column (col_id, col, COLUMN_XALIGN_LEFT);\r\nbreak;\r\ncase COLUMN_SELECTED_ALIGN_CENTER:\r\npacket_list_xalign_column (col_id, col, COLUMN_XALIGN_CENTER);\r\nbreak;\r\ncase COLUMN_SELECTED_ALIGN_RIGHT:\r\npacket_list_xalign_column (col_id, col, COLUMN_XALIGN_RIGHT);\r\nbreak;\r\ncase COLUMN_SELECTED_ALIGN_DEFAULT:\r\npacket_list_xalign_column (col_id, col, COLUMN_XALIGN_DEFAULT);\r\nbreak;\r\ncase COLUMN_SELECTED_RESIZE:\r\npacket_list_resize_column (col_id);\r\nbreak;\r\ncase COLUMN_SELECTED_CHANGE:\r\ncol_details_edit_dlg (col_id, col);\r\nbreak;\r\ncase COLUMN_SELECTED_HIDE:\r\npacket_list_set_visible_column (col_id, col, FALSE);\r\nbreak;\r\ncase COLUMN_SELECTED_REMOVE:\r\npacket_list_remove_column (col_id, col);\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\nbreak;\r\n}\r\n}\r\nstatic gboolean\r\npacket_list_column_button_pressed_cb (GtkWidget *widget, GdkEvent *event, gpointer data)\r\n{\r\nGtkWidget *col = (GtkWidget *) data;\r\nGtkWidget *menu = (GtkWidget *)g_object_get_data(G_OBJECT(popup_menu_object), PM_PACKET_LIST_COL_KEY);\r\ngint col_id = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(col), E_MPACKET_LIST_COL_KEY));\r\ngboolean right_justify = right_justify_column (col_id, &cfile);\r\nmenus_set_column_align_default (right_justify);\r\nmenus_set_column_resolved (get_column_resolved (col_id), resolve_column (col_id, &cfile));\r\ng_object_set_data(G_OBJECT(packetlist->view), E_MPACKET_LIST_COLUMN_KEY, col);\r\nreturn popup_menu_handler (widget, event, menu);\r\n}\r\nstatic void\r\ncolumn_dnd_changed_cb(GtkTreeView *tree_view, gpointer data _U_)\r\n{\r\nGtkTreeViewColumn *column;\r\nGtkTreeSelection *selection;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGList *columns, *list, *clp, *new_col_list = NULL;\r\ngint old_col_id, new_col_id = 0;\r\nfmt_data *cfmt;\r\nselection = gtk_tree_view_get_selection(tree_view);\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nlist = columns = gtk_tree_view_get_columns(tree_view);\r\nwhile (columns) {\r\ncolumn = (GtkTreeViewColumn *)columns->data;\r\nold_col_id = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(column), E_MPACKET_LIST_COL_KEY));\r\nclp = g_list_nth (prefs.col_list, old_col_id);\r\ncfmt = (fmt_data *) clp->data;\r\nnew_col_list = g_list_append (new_col_list, cfmt);\r\ncolumns = g_list_next (columns);\r\nnew_col_id++;\r\n}\r\ng_list_free (list);\r\ng_list_free (prefs.col_list);\r\nprefs.col_list = new_col_list;\r\nif (!prefs.gui_use_pref_save) {\r\nprefs_main_write();\r\n}\r\npacket_list_recreate();\r\n}\r\nstatic GtkWidget *\r\ncreate_view_and_model(void)\r\n{\r\nGtkTreeViewColumn *col;\r\nGtkCellRenderer *renderer;\r\ngint i, col_width;\r\ngdouble value;\r\ngchar *tooltip_text;\r\nheader_field_info *hfi;\r\ngint col_min_width;\r\ngchar *escaped_title;\r\npacketlist = packet_list_new();\r\npacketlist->view = tree_view_new(GTK_TREE_MODEL(packetlist));\r\ngtk_tree_view_set_fixed_height_mode(GTK_TREE_VIEW(packetlist->view),\r\nTRUE);\r\ng_signal_connect(packetlist->view, "cursor-changed",\r\nG_CALLBACK(packet_list_select_cb), NULL);\r\ng_signal_connect(packetlist->view, "row-activated",\r\nG_CALLBACK(packet_list_double_click_cb), NULL);\r\ng_signal_connect(packetlist->view, "button_press_event", G_CALLBACK(popup_menu_handler),\r\ng_object_get_data(G_OBJECT(popup_menu_object), PM_PACKET_LIST_KEY));\r\ncolumn_changed_handler_id = g_signal_connect(packetlist->view, "columns-changed", G_CALLBACK(column_dnd_changed_cb), NULL);\r\ng_object_set(packetlist->view, "has-tooltip", TRUE, NULL);\r\ng_signal_connect(packetlist->view, "query-tooltip",\r\nG_CALLBACK(query_packet_list_tooltip_cb), NULL);\r\ng_object_set_data(G_OBJECT(popup_menu_object), E_MPACKET_LIST_KEY, packetlist);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(packetlist->view, user_font_get_regular());\r\n#else\r\ngtk_widget_modify_font(packetlist->view, user_font_get_regular());\r\n#endif\r\nfor(i = 0; i < cfile.cinfo.num_cols; i++) {\r\nrenderer = gtk_cell_renderer_text_new();\r\ncol = gtk_tree_view_column_new();\r\ngtk_tree_view_column_pack_start(col, renderer, TRUE);\r\nvalue = get_xalign_value(recent_get_column_xalign(i), right_justify_column(i, &cfile));\r\ng_object_set(G_OBJECT(renderer),\r\n"xalign", value,\r\nNULL);\r\ng_object_set(renderer,\r\n"ypad", 0,\r\nNULL);\r\ngtk_tree_view_column_add_attribute(col, renderer, "text", i);\r\ngtk_tree_view_column_set_cell_data_func(col, renderer,\r\nshow_cell_data_func,\r\nGINT_TO_POINTER(i),\r\nNULL);\r\nif (cfile.cinfo.col_fmt[i] == COL_CUSTOM) {\r\nhfi = proto_registrar_get_byname(cfile.cinfo.col_custom_field[i]);\r\nif (hfi != NULL) {\r\nif (hfi->parent != -1) {\r\nif (cfile.cinfo.col_custom_occurrence[i] != 0) {\r\ntooltip_text = g_strdup_printf("%s\n%s (%s#%d)", proto_get_protocol_name(hfi->parent), hfi->name, hfi->abbrev, cfile.cinfo.col_custom_occurrence[i]);\r\n} else {\r\ntooltip_text = g_strdup_printf("%s\n%s (%s)", proto_get_protocol_name(hfi->parent), hfi->name, hfi->abbrev);\r\n}\r\n} else {\r\ntooltip_text = g_strdup_printf("%s (%s)", hfi->name, hfi->abbrev);\r\n}\r\n} else {\r\ntooltip_text = g_strdup_printf("Unknown Field: %s", get_column_custom_field(i));\r\n}\r\n} else {\r\ntooltip_text = g_strdup(col_format_desc(cfile.cinfo.col_fmt[i]));\r\n}\r\nescaped_title = ws_strdup_escape_char(cfile.cinfo.col_title[i], '_');\r\ngtk_tree_view_column_set_title(col, escaped_title);\r\ng_free (escaped_title);\r\ngtk_tree_view_column_set_clickable(col, TRUE);\r\ngtk_tree_view_column_set_resizable(col, TRUE);\r\ngtk_tree_view_column_set_visible(col, get_column_visible(i));\r\ngtk_tree_view_column_set_sizing(col,GTK_TREE_VIEW_COLUMN_FIXED);\r\ngtk_tree_view_column_set_reorderable(col, TRUE);\r\ng_object_set_data(G_OBJECT(col), E_MPACKET_LIST_COL_KEY, GINT_TO_POINTER(i));\r\ng_signal_connect(col, "clicked", G_CALLBACK(packet_list_column_clicked_cb), NULL);\r\ncol_min_width = get_default_col_size (packetlist->view, cfile.cinfo.col_title[i]);\r\nif(col_min_width<COLUMN_WIDTH_MIN){\r\ngtk_tree_view_column_set_min_width(col, COLUMN_WIDTH_MIN);\r\n}else{\r\ngtk_tree_view_column_set_min_width(col, col_min_width);\r\n}\r\ncol_width = recent_get_column_width(i);\r\nif(col_width < 1) {\r\ngint fmt;\r\nconst gchar *long_str;\r\nfmt = get_column_format(i);\r\nlong_str = get_column_width_string(fmt, i);\r\nif(long_str){\r\ncol_width = get_default_col_size (packetlist->view, long_str);\r\n}else{\r\ncol_width = COLUMN_WIDTH_MIN;\r\n}\r\ngtk_tree_view_column_set_fixed_width(col, col_width);\r\n}else{\r\ngtk_tree_view_column_set_fixed_width(col, col_width);\r\n}\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(packetlist->view), col);\r\ngtk_widget_set_tooltip_text(gtk_tree_view_column_get_button(col), tooltip_text);\r\ng_free(tooltip_text);\r\ng_signal_connect(gtk_tree_view_column_get_button(col), "button_press_event",\r\nG_CALLBACK(packet_list_column_button_pressed_cb), col);\r\nif (i == 0) {\r\ng_object_set_data(G_OBJECT(packetlist->view), E_MPACKET_LIST_COLUMN_KEY, col);\r\ng_object_set_data(G_OBJECT(packetlist->view), E_MPACKET_LIST_PREV_COLUMN_KEY, col);\r\n}\r\n}\r\nrebuild_visible_columns_menu ();\r\nreturn packetlist->view;\r\n}\r\nstatic frame_data *\r\npacket_list_get_record(GtkTreeModel *model, GtkTreeIter *iter)\r\n{\r\nframe_data *fdata;\r\ngint record_column = gtk_tree_model_get_n_columns(model)-1;\r\ngtk_tree_model_get(model, iter,\r\nrecord_column,\r\n&fdata,\r\n-1);\r\nreturn fdata;\r\n}\r\nvoid\r\npacket_list_clear(void)\r\n{\r\npacket_history_clear();\r\npacket_list_store_clear(packetlist);\r\ngtk_widget_queue_draw(packetlist->view);\r\npacket_list_sort_column(0, NULL, GTK_SORT_ASCENDING, FALSE);\r\n}\r\nvoid\r\npacket_list_freeze(void)\r\n{\r\ng_object_ref(packetlist);\r\ngtk_tree_view_set_model(GTK_TREE_VIEW(packetlist->view), NULL);\r\n}\r\nvoid\r\npacket_list_thaw(void)\r\n{\r\ngtk_tree_view_set_model( GTK_TREE_VIEW(packetlist->view), GTK_TREE_MODEL(packetlist));\r\ng_object_unref(packetlist);\r\npackets_bar_update();\r\n}\r\nvoid\r\npacket_list_recreate_visible_rows(void)\r\n{\r\npacket_list_recreate_visible_rows_list(packetlist);\r\n}\r\nvoid packet_list_resize_column(gint col)\r\n{\r\nGtkTreeViewColumn *column;\r\ngint col_width;\r\nconst gchar *long_str;\r\nlong_str = packet_list_get_widest_column_string(packetlist, col);\r\nif(!long_str || strcmp("",long_str)==0)\r\nreturn;\r\ncolumn = gtk_tree_view_get_column (GTK_TREE_VIEW(packetlist->view), col);\r\ncol_width = get_default_col_size (packetlist->view, long_str);\r\ngtk_tree_view_column_set_fixed_width(column, col_width);\r\n}\r\nstatic void\r\npacket_list_resize_columns(void)\r\n{\r\ngint progbar_loop_max;\r\ngint progbar_loop_var;\r\nprogbar_loop_max = cfile.cinfo.num_cols;\r\nfor (progbar_loop_var = 0; progbar_loop_var < progbar_loop_max; ++progbar_loop_var)\r\npacket_list_resize_column(progbar_loop_var);\r\n}\r\nvoid\r\npacket_list_resize_columns_cb(GtkWidget *widget _U_, gpointer data _U_)\r\n{\r\npacket_list_resize_columns();\r\n}\r\nstatic void\r\nscroll_to_current(void)\r\n{\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\nGtkWidget *focus = gtk_window_get_focus(GTK_WINDOW(top_level));\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nscroll_to_and_select_iter(model, selection, &iter);\r\nif (focus)\r\ngtk_window_set_focus(GTK_WINDOW(top_level), focus);\r\n}\r\nvoid\r\npacket_list_next(void)\r\n{\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\nGtkWidget *focus = gtk_window_get_focus(GTK_WINDOW(top_level));\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nif (!gtk_tree_model_iter_next(model, &iter))\r\nreturn;\r\nscroll_to_and_select_iter(model, selection, &iter);\r\nif (focus)\r\ngtk_window_set_focus(GTK_WINDOW(top_level), focus);\r\n}\r\nvoid\r\npacket_list_prev(void)\r\n{\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nGtkTreeModel *model;\r\nGtkTreePath *path;\r\nGtkWidget *focus = gtk_window_get_focus(GTK_WINDOW(top_level));\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\npath = gtk_tree_model_get_path(model, &iter);\r\nif (!gtk_tree_path_prev(path))\r\nreturn;\r\nif (!gtk_tree_model_get_iter(model, &iter, path))\r\nreturn;\r\nscroll_to_and_select_iter(model, selection, &iter);\r\ngtk_tree_path_free(path);\r\nif (focus)\r\ngtk_window_set_focus(GTK_WINDOW(top_level), focus);\r\n}\r\nstatic void\r\nscroll_to_and_select_iter(GtkTreeModel *model, GtkTreeSelection *selection, GtkTreeIter *iter)\r\n{\r\nGtkTreePath *path;\r\ng_assert(model);\r\nif(!selection)\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\ngtk_tree_selection_select_iter (selection, iter);\r\npath = gtk_tree_model_get_path(model, iter);\r\ngtk_tree_view_scroll_to_cell(GTK_TREE_VIEW(packetlist->view),\r\npath,\r\nNULL,\r\nTRUE,\r\n0.5f,\r\n0);\r\ngtk_tree_view_set_cursor(GTK_TREE_VIEW(packetlist->view),\r\npath,\r\nNULL,\r\nFALSE);\r\ngtk_tree_path_free(path);\r\n}\r\nvoid\r\npacket_list_select_first_row(void)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nGtkTreeIter iter;\r\nif(!gtk_tree_model_get_iter_first(model, &iter))\r\nreturn;\r\nscroll_to_and_select_iter(model, NULL, &iter);\r\ngtk_widget_grab_focus(packetlist->view);\r\n}\r\nvoid\r\npacket_list_select_last_row(void)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nGtkTreeIter iter;\r\ngint children;\r\nguint last_row;\r\nif((children = gtk_tree_model_iter_n_children(model, NULL)) == 0)\r\nreturn;\r\nlast_row = children-1;\r\nif(!gtk_tree_model_iter_nth_child(model, &iter, NULL, last_row))\r\nreturn;\r\nscroll_to_and_select_iter(model, NULL, &iter);\r\n}\r\nvoid\r\npacket_list_moveto_end(void)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nGtkTreeIter iter;\r\nGtkTreePath *path;\r\ngint children;\r\nguint last_row;\r\nif((children = gtk_tree_model_iter_n_children(model, NULL)) == 0)\r\nreturn;\r\nlast_row = children-1;\r\nif(!gtk_tree_model_iter_nth_child(model, &iter, NULL, last_row))\r\nreturn;\r\npath = gtk_tree_model_get_path(model, &iter);\r\ngtk_tree_view_scroll_to_cell(GTK_TREE_VIEW(packetlist->view),\r\npath,\r\nNULL,\r\nTRUE,\r\n0.5f,\r\n0);\r\ngtk_tree_path_free(path);\r\n}\r\ngboolean\r\npacket_list_check_end(void)\r\n{\r\ngboolean at_end = FALSE;\r\nGtkAdjustment *adj;\r\n#if GTK_CHECK_VERSION(3,0,0)\r\nadj = gtk_scrollable_get_vadjustment (GTK_SCROLLABLE (packetlist->view));\r\n#else\r\nadj = gtk_tree_view_get_vadjustment(GTK_TREE_VIEW(packetlist->view));\r\n#endif\r\ng_return_val_if_fail(adj != NULL, FALSE);\r\nif (gtk_adjustment_get_value(adj) >= gtk_adjustment_get_upper(adj) - gtk_adjustment_get_page_size(adj)) {\r\nat_end = TRUE;\r\n}\r\n#ifdef HAVE_LIBPCAP\r\nif (gtk_adjustment_get_value(adj) > 0 && at_end != last_at_end && at_end != auto_scroll_live) {\r\nmain_auto_scroll_live_changed(at_end);\r\n}\r\n#endif\r\nlast_at_end = at_end;\r\nreturn at_end;\r\n}\r\ngboolean\r\npacket_list_select_row_from_data(frame_data *fdata_needle)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nGtkTreeIter iter;\r\nif(!gtk_tree_model_get_iter_first(model, &iter))\r\nreturn FALSE;\r\ndo {\r\nframe_data *fdata;\r\nfdata = packet_list_get_record(model, &iter);\r\nif(fdata == fdata_needle) {\r\nscroll_to_and_select_iter(model, NULL, &iter);\r\nreturn TRUE;\r\n}\r\n} while (gtk_tree_model_iter_next(model, &iter));\r\nreturn FALSE;\r\n}\r\nvoid\r\npacket_list_set_selected_row(gint row)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nGtkTreeIter iter;\r\nGtkTreeSelection *selection;\r\nGtkTreePath *path;\r\npath = gtk_tree_path_new_from_indices(row-1, -1);\r\nif (!gtk_tree_model_get_iter(model, &iter, path))\r\nreturn;\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\ngtk_tree_selection_select_iter (selection, &iter);\r\ngtk_tree_view_set_cursor(GTK_TREE_VIEW(packetlist->view),\r\npath,\r\nNULL,\r\nFALSE);\r\ngtk_tree_path_free(path);\r\n}\r\nstatic gint\r\nrow_number_from_iter(GtkTreeIter *iter)\r\n{\r\ngint row;\r\ngint *indices;\r\nGtkTreePath *path;\r\nGtkTreeModel *model;\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\npath = gtk_tree_model_get_path(model, iter);\r\nindices = gtk_tree_path_get_indices(path);\r\ng_assert(indices);\r\nrow = indices[0] + 1;\r\ngtk_tree_path_free(path);\r\nreturn row;\r\n}\r\nstatic void\r\npacket_list_select_cb(GtkTreeView *tree_view, gpointer data _U_)\r\n{\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\ngint row;\r\nif ((selection = gtk_tree_view_get_selection(tree_view)) == NULL)\r\nreturn;\r\nif (!gtk_tree_selection_get_selected(selection, NULL, &iter))\r\nreturn;\r\nrow = row_number_from_iter(&iter);\r\nif (cfile.current_frame && cfile.current_row == row)\r\nreturn;\r\nwhile(gtk_notebook_get_nth_page(GTK_NOTEBOOK(byte_nb_ptr_gbl), 0))\r\ngtk_notebook_remove_page(GTK_NOTEBOOK(byte_nb_ptr_gbl), 0);\r\ncf_select_packet(&cfile, row);\r\nif (cfile.search_in_progress && cfile.decode_data) {\r\ngtk_widget_grab_focus(tree_view_gbl);\r\n} else {\r\ngtk_widget_grab_focus(packetlist->view);\r\n}\r\npacket_history_add(row);\r\n}\r\nstatic void\r\npacket_list_double_click_cb(GtkTreeView *treeview, GtkTreePath *path _U_,\r\nGtkTreeViewColumn *col _U_, gpointer userdata _U_)\r\n{\r\nnew_packet_window(GTK_WIDGET(treeview), FALSE, FALSE);\r\n}\r\ngboolean\r\npacket_list_get_event_row_column(GdkEventButton *event_button,\r\ngint *physical_row, gint *row, gint *column)\r\n{\r\nGtkTreeModel *model = gtk_tree_view_get_model(GTK_TREE_VIEW(packetlist->view));\r\nGtkTreePath *path;\r\nGtkTreeViewColumn *view_column;\r\nif (gtk_tree_view_get_path_at_pos(GTK_TREE_VIEW(packetlist->view),\r\n(gint) event_button->x,\r\n(gint) event_button->y,\r\n&path, &view_column, NULL, NULL)) {\r\nGtkTreeIter iter;\r\nGList *cols;\r\ngint *indices;\r\nframe_data *fdata;\r\ngtk_tree_model_get_iter(model, &iter, path);\r\nindices = gtk_tree_path_get_indices(path);\r\ng_assert(indices);\r\n*row = indices[0] + 1;\r\ngtk_tree_path_free(path);\r\nfdata = packet_list_get_record(model, &iter);\r\n*physical_row = fdata->num;\r\ncols = gtk_tree_view_get_columns(GTK_TREE_VIEW(packetlist->view));\r\n*column = g_list_index(cols, (gpointer) view_column);\r\ng_list_free(cols);\r\nreturn TRUE;\r\n}\r\nelse\r\nreturn FALSE;\r\n}\r\nframe_data *\r\npacket_list_get_row_data(gint row)\r\n{\r\nGtkTreePath *path = gtk_tree_path_new();\r\nGtkTreeIter iter;\r\nframe_data *fdata;\r\ngtk_tree_path_append_index(path, row-1);\r\ngtk_tree_model_get_iter(GTK_TREE_MODEL(packetlist), &iter, path);\r\nfdata = packet_list_get_record(GTK_TREE_MODEL(packetlist), &iter);\r\ngtk_tree_path_free(path);\r\nreturn fdata;\r\n}\r\nstatic void\r\nshow_cell_data_func(GtkTreeViewColumn *col _U_, GtkCellRenderer *renderer,\r\nGtkTreeModel *model, GtkTreeIter *iter, gpointer data _U_)\r\n{\r\nframe_data *fdata = packet_list_get_record(model, iter);\r\ngboolean color_on;\r\nGdkColor fg_gdk;\r\nGdkColor bg_gdk;\r\nif (fdata->flags.ignored) {\r\ncolor_t_to_gdkcolor(&fg_gdk, &prefs.gui_ignored_fg);\r\ncolor_t_to_gdkcolor(&bg_gdk, &prefs.gui_ignored_bg);\r\ncolor_on = TRUE;\r\n} else if (fdata->flags.marked) {\r\ncolor_t_to_gdkcolor(&fg_gdk, &prefs.gui_marked_fg);\r\ncolor_t_to_gdkcolor(&bg_gdk, &prefs.gui_marked_bg);\r\ncolor_on = TRUE;\r\n} else if (fdata->color_filter) {\r\nconst color_filter_t *color_filter = (const color_filter_t *)fdata->color_filter;\r\ncolor_t_to_gdkcolor(&fg_gdk, &color_filter->fg_color);\r\ncolor_t_to_gdkcolor(&bg_gdk, &color_filter->bg_color);\r\ncolor_on = enable_color;\r\n} else\r\ncolor_on = FALSE;\r\nif (color_on) {\r\ng_object_set(renderer,\r\n"foreground-gdk", &fg_gdk,\r\n"foreground-set", TRUE,\r\n"background-gdk", &bg_gdk,\r\n"background-set", TRUE,\r\nNULL);\r\n} else {\r\ng_object_set(renderer,\r\n"foreground-set", FALSE,\r\n"background-set", FALSE,\r\nNULL);\r\n}\r\n}\r\nvoid\r\npacket_list_enable_color(gboolean enable)\r\n{\r\nenable_color = enable;\r\ngtk_widget_queue_draw (packetlist->view);\r\n}\r\nvoid\r\npacket_list_queue_draw(void)\r\n{\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\ngint row;\r\ngtk_widget_queue_draw (packetlist->view);\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, NULL, &iter))\r\nreturn;\r\nrow = row_number_from_iter(&iter);\r\ncf_select_packet(&cfile, row);\r\n}\r\nvoid\r\npacket_list_set_font(PangoFontDescription *font)\r\n{\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_override_font(packetlist->view, font);\r\n#else\r\ngtk_widget_modify_font(packetlist->view, font);\r\n#endif\r\n}\r\nstatic void\r\nmark_frames_ready(void)\r\n{\r\npackets_bar_update();\r\npacket_list_queue_draw();\r\n}\r\nstatic void\r\nset_frame_mark(gboolean set, frame_data *fdata)\r\n{\r\nif (set)\r\ncf_mark_frame(&cfile, fdata);\r\nelse\r\ncf_unmark_frame(&cfile, fdata);\r\n}\r\nvoid\r\npacket_list_mark_frame_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nGtkTreeModel *model;\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nframe_data *fdata;\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nfdata = packet_list_get_record(model, &iter);\r\nset_frame_mark(!fdata->flags.marked, fdata);\r\nmark_frames_ready();\r\n}\r\nstatic void\r\nmark_all_displayed_frames(gboolean set)\r\n{\r\nguint32 framenum;\r\nframe_data *fdata;\r\nfor (framenum = 1; framenum <= cfile.count; framenum++) {\r\nfdata = frame_data_sequence_find(cfile.frames, framenum);\r\nif( fdata->flags.passed_dfilter )\r\nset_frame_mark(set, fdata);\r\n}\r\n}\r\nvoid\r\npacket_list_mark_all_displayed_frames_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nmark_all_displayed_frames(TRUE);\r\nmark_frames_ready();\r\n}\r\nvoid\r\npacket_list_unmark_all_displayed_frames_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nmark_all_displayed_frames(FALSE);\r\nmark_frames_ready();\r\n}\r\nstatic void\r\ntoggle_mark_all_displayed_frames(void)\r\n{\r\nguint32 framenum;\r\nframe_data *fdata;\r\nfor (framenum = 1; framenum <= cfile.count; framenum++) {\r\nfdata = frame_data_sequence_find(cfile.frames, framenum);\r\nif( fdata->flags.passed_dfilter )\r\nset_frame_mark(!fdata->flags.marked, fdata);\r\n}\r\n}\r\nvoid\r\npacket_list_toggle_mark_all_displayed_frames_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\ntoggle_mark_all_displayed_frames();\r\nmark_frames_ready();\r\n}\r\nstatic void\r\nset_frame_ignore(gboolean set, frame_data *fdata)\r\n{\r\nif (set)\r\ncf_ignore_frame(&cfile, fdata);\r\nelse\r\ncf_unignore_frame(&cfile, fdata);\r\n}\r\nvoid\r\npacket_list_ignore_frame_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nGtkTreeModel *model;\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nframe_data *fdata;\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nfdata = packet_list_get_record(model, &iter);\r\nset_frame_ignore(!fdata->flags.ignored, fdata);\r\nredissect_packets();\r\n}\r\nstatic void\r\nignore_all_displayed_frames(gboolean set)\r\n{\r\nguint32 framenum;\r\nframe_data *fdata;\r\nfor (framenum = 1; framenum <= cfile.count; framenum++) {\r\nfdata = frame_data_sequence_find(cfile.frames, framenum);\r\nif( fdata->flags.passed_dfilter )\r\nset_frame_ignore(set, fdata);\r\n}\r\nredissect_packets();\r\n}\r\nvoid\r\npacket_list_ignore_all_displayed_frames_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nif(cfile.displayed_count < cfile.count){\r\nframe_data *fdata;\r\nfdata = frame_data_sequence_find(cfile.frames, cfile.first_displayed);\r\nif (fdata->flags.ignored==TRUE) {\r\nignore_all_displayed_frames(FALSE);\r\n} else {\r\nignore_all_displayed_frames(TRUE);\r\n}\r\n}\r\n}\r\nstatic void\r\nunignore_all_frames(void)\r\n{\r\nguint32 framenum;\r\nframe_data *fdata;\r\nfor (framenum = 1; framenum <= cfile.count; framenum++) {\r\nfdata = frame_data_sequence_find(cfile.frames, framenum);\r\nset_frame_ignore(FALSE, fdata);\r\n}\r\nredissect_packets();\r\n}\r\nvoid\r\npacket_list_unignore_all_frames_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nunignore_all_frames();\r\n}\r\nstatic void\r\nuntime_reference_all_frames(void)\r\n{\r\nguint32 framenum;\r\nframe_data *fdata;\r\nfor (framenum = 1; framenum <= cfile.count && cfile.ref_time_count > 0; framenum++) {\r\nfdata = frame_data_sequence_find(cfile.frames, framenum);\r\nif (fdata->flags.ref_time == 1) {\r\nset_frame_reftime(FALSE, fdata, cfile.current_row);\r\n}\r\n}\r\n}\r\nvoid\r\npacket_list_untime_reference_all_frames_cb(GtkWidget *w _U_, gpointer data _U_)\r\n{\r\nuntime_reference_all_frames();\r\n}\r\nguint\r\npacket_list_get_column_id (gint col_num)\r\n{\r\nGtkTreeViewColumn *column = gtk_tree_view_get_column (GTK_TREE_VIEW(packetlist->view), col_num);\r\ngint col_id = GPOINTER_TO_INT(g_object_get_data(G_OBJECT(column), E_MPACKET_LIST_COL_KEY));\r\nreturn col_id;\r\n}\r\nvoid\r\npacket_list_copy_summary_cb(gpointer data _U_, copy_summary_type copy_type)\r\n{\r\ngint col;\r\ngchar *celltext;\r\nGString* text;\r\nGtkTreeModel *model;\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nif(CS_CSV == copy_type) {\r\ntext = g_string_new("\"");\r\n} else {\r\ntext = g_string_new("");\r\n}\r\nif (cfile.current_frame) {\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nfor(col = 0; col < cfile.cinfo.num_cols; ++col) {\r\nif(col != 0) {\r\nif(CS_CSV == copy_type) {\r\ng_string_append(text,"\",\"");\r\n} else {\r\ng_string_append_c(text, '\t');\r\n}\r\n}\r\ngtk_tree_model_get(model, &iter, packet_list_get_column_id(col), &celltext, -1);\r\ng_string_append(text,celltext);\r\ng_free(celltext);\r\n}\r\nif(CS_CSV == copy_type) {\r\ng_string_append_c(text,'"');\r\n}\r\ncopy_to_clipboard(text);\r\n}\r\ng_string_free(text,TRUE);\r\n}\r\ngchar *\r\npacket_list_get_packet_comment(void)\r\n{\r\nGtkTreeModel *model;\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nframe_data *fdata;\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn NULL;\r\nfdata = packet_list_get_record(model, &iter);\r\nreturn cf_get_comment(&cfile, fdata);\r\n}\r\nvoid\r\npacket_list_return_all_comments(GtkTextBuffer *buffer)\r\n{\r\nguint32 framenum;\r\nframe_data *fdata;\r\ngchar *buf_str;\r\nfor (framenum = 1; framenum <= cfile.count ; framenum++) {\r\nchar *pkt_comment;\r\nfdata = frame_data_sequence_find(cfile.frames, framenum);\r\npkt_comment = cf_get_comment(&cfile, fdata);\r\nif (pkt_comment) {\r\nbuf_str = g_strdup_printf("Frame %u: %s \n\n",framenum, pkt_comment);\r\ngtk_text_buffer_insert_at_cursor (buffer, buf_str, -1);\r\ng_free(buf_str);\r\ng_free(pkt_comment);\r\n}\r\nif (gtk_text_buffer_get_char_count(buffer) > MAX_COMMENTS_TO_FETCH) {\r\nbuf_str = g_strdup_printf("[ Comment text exceeds %s. Stopping. ]",\r\nformat_size(MAX_COMMENTS_TO_FETCH, (format_size_flags_e)(format_size_unit_bytes|format_size_prefix_si)));\r\ngtk_text_buffer_insert_at_cursor (buffer, buf_str, -1);\r\nreturn;\r\n}\r\n}\r\n}\r\nvoid\r\npacket_list_update_packet_comment(gchar *new_packet_comment)\r\n{\r\nGtkTreeModel *model;\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\nframe_data *fdata;\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(packetlist->view));\r\nif (!gtk_tree_selection_get_selected(selection, &model, &iter))\r\nreturn;\r\nfdata = packet_list_get_record(model, &iter);\r\nif(strlen(new_packet_comment) == 0) {\r\ng_free(new_packet_comment);\r\nnew_packet_comment = NULL;\r\n}\r\ncf_set_user_packet_comment(&cfile, fdata, new_packet_comment);\r\ng_free(new_packet_comment);\r\nmain_update_for_unsaved_changes(&cfile);\r\npacket_list_queue_draw();\r\n}\r\nvoid\r\npacket_list_recent_write_all(FILE *rf)\r\n{\r\ngint col, width, num_cols, col_fmt;\r\nGtkTreeViewColumn *tree_column;\r\ngchar xalign;\r\nfprintf (rf, "%s:", RECENT_KEY_COL_WIDTH);\r\nnum_cols = g_list_length(prefs.col_list);\r\nfor (col = 0; col < num_cols; col++) {\r\ncol_fmt = get_column_format(col);\r\nif (col_fmt == COL_CUSTOM) {\r\nfprintf (rf, " %%Cus:%s,", get_column_custom_field(col));\r\n} else {\r\nfprintf (rf, " %s,", col_format_to_string(col_fmt));\r\n}\r\ntree_column = gtk_tree_view_get_column(GTK_TREE_VIEW(packetlist->view), col);\r\nwidth = gtk_tree_view_column_get_width(tree_column);\r\nxalign = recent_get_column_xalign (col);\r\nif (width == 0) {\r\nwidth = recent_get_column_width (col);\r\n}\r\nfprintf (rf, " %d", width);\r\nif (xalign != COLUMN_XALIGN_DEFAULT) {\r\nfprintf (rf, ":%c", xalign);\r\n}\r\nif (col != num_cols-1) {\r\nfprintf (rf, ",");\r\n}\r\n}\r\nfprintf (rf, "\n");\r\n}\r\nGtkWidget *\r\npacket_list_get_widget(void)\r\n{\r\ng_assert(packetlist);\r\ng_assert(packetlist->view);\r\nreturn packetlist->view;\r\n}\r\nvoid\r\npacket_list_colorize_packets(void)\r\n{\r\npacket_list_reset_colorized(packetlist);\r\ngtk_widget_queue_draw (packetlist->view);\r\n}\r\nstatic gboolean\r\nquery_packet_list_tooltip_cb(GtkWidget *widget, gint x, gint y, gboolean keyboard_tip, GtkTooltip *tooltip, gpointer data _U_)\r\n{\r\nGtkTreeIter iter;\r\nGtkTreeView *tree_view = GTK_TREE_VIEW(widget);\r\nGtkTreeModel *model = gtk_tree_view_get_model(tree_view);\r\nGtkTreePath *path = NULL;\r\nGtkTreeViewColumn *column;\r\ngint col, num_cols;\r\nframe_data *fdata;\r\nGtkCellRenderer* renderer=NULL;\r\nGList *renderer_list;\r\ngboolean result = FALSE;\r\nif (!gtk_tree_view_get_tooltip_context(tree_view, &x, &y, keyboard_tip, &model, &path, &iter))\r\nreturn result;\r\nif (gtk_tree_view_get_path_at_pos(GTK_TREE_VIEW(tree_view), x, y, NULL, &column, NULL, NULL)) {\r\nchar *pkt_comment;\r\nnum_cols = g_list_length(prefs.col_list);\r\nfor (col = 0; col < num_cols; col++) {\r\nif (gtk_tree_view_get_column(tree_view, col) == column)\r\nbreak;\r\n}\r\nfdata = packet_list_get_record(model, &iter);\r\npkt_comment = cf_get_comment(&cfile, fdata);\r\nif (pkt_comment != NULL) {\r\ngtk_tooltip_set_markup(tooltip, pkt_comment);\r\nrenderer_list = gtk_cell_layout_get_cells(GTK_CELL_LAYOUT(column));\r\nif (g_list_first(renderer_list)) {\r\nrenderer = (GtkCellRenderer*)g_list_nth_data(renderer_list, 0);\r\ngtk_tree_view_set_tooltip_cell (tree_view, tooltip, path, column, renderer);\r\n}\r\ng_list_free(renderer_list);\r\ng_free(pkt_comment);\r\nresult = TRUE;\r\n}\r\n}\r\ngtk_tree_path_free(path);\r\nreturn result;\r\n}

static void\r\nh225counter_reset(void *phs)\r\n{\r\nh225counter_t *hs=(h225counter_t *)phs;\r\nchar *save_filter = hs->filter;\r\nmemset(hs, 0, sizeof(h225counter_t));\r\nhs->filter = save_filter;\r\n}\r\nstatic int\r\nh225counter_packet(void *phs, packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *phi)\r\n{\r\nh225counter_t *hs=(h225counter_t *)phs;\r\nconst h225_packet_info *pi=(const h225_packet_info *)phi;\r\nswitch (pi->msg_type) {\r\ncase H225_RAS:\r\nif(pi->msg_tag==-1) {\r\nreturn 0;\r\n}\r\nelse if (pi->msg_tag >= RAS_MSG_TYPES) {\r\nhs->ras_msg[RAS_MSG_TYPES]++;\r\n}\r\nelse {\r\nhs->ras_msg[pi->msg_tag]++;\r\n}\r\nif(pi->reason==-1) {\r\nbreak;\r\n}\r\nswitch(pi->msg_tag) {\r\ncase 2:\r\nif(pi->reason < GRJ_REASONS)\r\nhs->grj_reason[pi->reason]++;\r\nelse\r\nhs->grj_reason[GRJ_REASONS]++;\r\nbreak;\r\ncase 5:\r\nif(pi->reason < RRJ_REASONS)\r\nhs->rrj_reason[pi->reason]++;\r\nelse\r\nhs->rrj_reason[RRJ_REASONS]++;\r\nbreak;\r\ncase 6:\r\nif(pi->reason < URQ_REASONS)\r\nhs->urq_reason[pi->reason]++;\r\nelse\r\nhs->urq_reason[URQ_REASONS]++;\r\nbreak;\r\ncase 8:\r\nif(pi->reason < URJ_REASONS)\r\nhs->urj_reason[pi->reason]++;\r\nelse\r\nhs->urj_reason[URJ_REASONS]++;\r\nbreak;\r\ncase 11:\r\nif(pi->reason < ARJ_REASONS)\r\nhs->arj_reason[pi->reason]++;\r\nelse\r\nhs->arj_reason[ARJ_REASONS]++;\r\nbreak;\r\ncase 14:\r\nif(pi->reason < BRJ_REASONS)\r\nhs->brj_reason[pi->reason]++;\r\nelse\r\nhs->brj_reason[BRJ_REASONS]++;\r\nbreak;\r\ncase 15:\r\nif(pi->reason < DRQ_REASONS)\r\nhs->drq_reason[pi->reason]++;\r\nelse\r\nhs->drq_reason[DRQ_REASONS]++;\r\nbreak;\r\ncase 17:\r\nif(pi->reason < DRJ_REASONS)\r\nhs->drj_reason[pi->reason]++;\r\nelse\r\nhs->drj_reason[DRJ_REASONS]++;\r\nbreak;\r\ncase 20:\r\nif(pi->reason < LRJ_REASONS)\r\nhs->lrj_reason[pi->reason]++;\r\nelse\r\nhs->lrj_reason[LRJ_REASONS]++;\r\nbreak;\r\ncase 29:\r\nif(pi->reason < IRQNAK_REASONS)\r\nhs->irqnak_reason[pi->reason]++;\r\nelse\r\nhs->irqnak_reason[IRQNAK_REASONS]++;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ncase H225_CS:\r\nif(pi->msg_tag==-1) {\r\nreturn 0;\r\n}\r\nelse if (pi->msg_tag >= CS_MSG_TYPES) {\r\nhs->cs_msg[CS_MSG_TYPES]++;\r\n}\r\nelse {\r\nhs->cs_msg[pi->msg_tag]++;\r\n}\r\nif(pi->reason==-1) {\r\nbreak;\r\n}\r\nswitch(pi->msg_tag) {\r\ncase 5:\r\nif(pi->reason < REL_CMP_REASONS)\r\nhs->rel_cmp_reason[pi->reason]++;\r\nelse\r\nhs->rel_cmp_reason[REL_CMP_REASONS]++;\r\nbreak;\r\ncase 6:\r\nif(pi->reason < FACILITY_REASONS)\r\nhs->facility_reason[pi->reason]++;\r\nelse\r\nhs->facility_reason[FACILITY_REASONS]++;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\nh225counter_draw(void *phs)\r\n{\r\nh225counter_t *hs=(h225counter_t *)phs;\r\nint i,j;\r\nprintf("================== H225 Message and Reason Counter ==================\n");\r\nprintf("RAS-Messages:\n");\r\nfor(i=0;i<=RAS_MSG_TYPES;i++) {\r\nif(hs->ras_msg[i]!=0) {\r\nprintf(" %s : %u\n", val_to_str(i,h225_RasMessage_vals,"unknown ras-messages "), hs->ras_msg[i]);\r\nswitch(i) {\r\ncase 2:\r\nfor(j=0;j<=GRJ_REASONS;j++) {\r\nif(hs->grj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,GatekeeperRejectReason_vals,"unknown reason "), hs->grj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 5:\r\nfor(j=0;j<=RRJ_REASONS;j++) {\r\nif(hs->rrj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,RegistrationRejectReason_vals,"unknown reason "), hs->rrj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 6:\r\nfor(j=0;j<=URQ_REASONS;j++) {\r\nif(hs->urq_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,UnregRequestReason_vals,"unknown reason "), hs->urq_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 8:\r\nfor(j=0;j<=URJ_REASONS;j++) {\r\nif(hs->urj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,UnregRejectReason_vals,"unknown reason "), hs->urj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 11:\r\nfor(j=0;j<=ARJ_REASONS;j++) {\r\nif(hs->arj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,AdmissionRejectReason_vals,"unknown reason "), hs->arj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 14:\r\nfor(j=0;j<=BRJ_REASONS;j++) {\r\nif(hs->brj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,BandRejectReason_vals,"unknown reason "), hs->brj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 15:\r\nfor(j=0;j<=DRQ_REASONS;j++) {\r\nif(hs->drq_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,DisengageReason_vals,"unknown reason "), hs->drq_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 17:\r\nfor(j=0;j<=DRJ_REASONS;j++) {\r\nif(hs->drj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,DisengageRejectReason_vals,"unknown reason "), hs->drj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 20:\r\nfor(j=0;j<=LRJ_REASONS;j++) {\r\nif(hs->lrj_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,LocationRejectReason_vals,"unknown reason "), hs->lrj_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 29:\r\nfor(j=0;j<=IRQNAK_REASONS;j++) {\r\nif(hs->irqnak_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,InfoRequestNakReason_vals,"unknown reason "), hs->irqnak_reason[j]);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nprintf("Call Signalling:\n");\r\nfor(i=0;i<=CS_MSG_TYPES;i++) {\r\nif(hs->cs_msg[i]!=0) {\r\nprintf(" %s : %u\n", val_to_str(i,T_h323_message_body_vals,"unknown cs-messages "), hs->cs_msg[i]);\r\nswitch(i) {\r\ncase 5:\r\nfor(j=0;j<=REL_CMP_REASONS;j++) {\r\nif(hs->rel_cmp_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,h225_ReleaseCompleteReason_vals,"unknown reason "), hs->rel_cmp_reason[j]);\r\n}\r\n}\r\nbreak;\r\ncase 6:\r\nfor(j=0;j<=FACILITY_REASONS;j++) {\r\nif(hs->facility_reason[j]!=0) {\r\nprintf(" %s : %u\n", val_to_str(j,FacilityReason_vals,"unknown reason "), hs->facility_reason[j]);\r\n}\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nprintf("=====================================================================\n");\r\n}\r\nstatic void\r\nh225counter_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nh225counter_t *hs;\r\nGString *error_string;\r\nhs = g_new(h225counter_t,1);\r\nif(!strncmp(opt_arg,"h225,counter,",13)){\r\nhs->filter=g_strdup(opt_arg+13);\r\n} else {\r\nhs->filter=NULL;\r\n}\r\nh225counter_reset(hs);\r\nerror_string=register_tap_listener("h225", hs, hs->filter, 0, NULL, h225counter_packet, h225counter_draw);\r\nif(error_string){\r\ng_free(hs->filter);\r\ng_free(hs);\r\nfprintf(stderr, "tshark: Couldn't register h225,counter tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_h225counter(void)\r\n{\r\nregister_stat_cmd_arg("h225,counter", h225counter_init,NULL);\r\n}

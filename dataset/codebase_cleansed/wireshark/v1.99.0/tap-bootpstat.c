static void\r\ndhcp_reset_hash(gchar *key _U_ , dhcp_message_type_t *data, gpointer ptr _U_ )\r\n{\r\ndata->packets = 0;\r\n}\r\nstatic void\r\ndhcp_draw_message_type(gchar *key _U_, dhcp_message_type_t *data, gchar * format )\r\n{\r\nif ((data==NULL) || (data->packets==0))\r\nreturn;\r\nprintf( format, data->name, data->packets);\r\n}\r\nstatic void\r\ndhcpstat_reset(void *psp)\r\n{\r\ndhcpstat_t *sp=(dhcpstat_t *)psp;\r\ng_hash_table_foreach( sp->hash, (GHFunc)dhcp_reset_hash, NULL);\r\n}\r\nstatic int\r\ndhcpstat_packet(void *psp, packet_info *pinfo _U_, epan_dissect_t *edt _U_, const void *pri)\r\n{\r\ndhcpstat_t *sp=(dhcpstat_t *)psp;\r\nconst bootp_info_value_t value=(const bootp_info_value_t)pri;\r\ndhcp_message_type_t *sc;\r\nif (sp==NULL)\r\nreturn 0;\r\nsc = (dhcp_message_type_t *)g_hash_table_lookup(\r\nsp->hash,\r\nvalue);\r\nif (!sc) {\r\nsc = g_new(dhcp_message_type_t,1);\r\nsc -> packets = 1;\r\nsc -> name = value;\r\nsc -> sp = sp;\r\ng_hash_table_insert(\r\nsp->hash,\r\n(gpointer) value,\r\nsc);\r\n} else {\r\nsc->packets++;\r\n}\r\nreturn 1;\r\n}\r\nstatic void\r\ndhcpstat_draw(void *psp)\r\n{\r\ndhcpstat_t *sp=(dhcpstat_t *)psp;\r\nprintf("\n");\r\nprintf("===================================================================\n");\r\nif (sp->filter==NULL)\r\nprintf("BOOTP Statistics\n");\r\nelse\r\nprintf("BOOTP Statistics with filter %s\n", sp->filter);\r\nprintf("BOOTP Option 53: DHCP Messages Types:\n");\r\nprintf("DHCP Message Type Packets nb\n" );\r\ng_hash_table_foreach( sp->hash, (GHFunc) dhcp_draw_message_type,\r\n(gpointer)"%23s %-9d\n" );\r\nprintf("===================================================================\n");\r\n}\r\nstatic void\r\ndhcpstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\ndhcpstat_t *sp;\r\nconst char *filter=NULL;\r\nGString *error_string;\r\nif (!strncmp (opt_arg, "bootp,stat,", 11)){\r\nfilter=opt_arg+11;\r\n} else {\r\nfilter=NULL;\r\n}\r\nsp = g_new(dhcpstat_t,1);\r\nsp->hash = g_hash_table_new( g_str_hash, g_str_equal);\r\nif(filter){\r\nsp->filter=g_strdup(filter);\r\n} else {\r\nsp->filter=NULL;\r\n}\r\nsp->index = 0;\r\nerror_string = register_tap_listener(\r\n"bootp",\r\nsp,\r\nfilter,\r\n0,\r\ndhcpstat_reset,\r\ndhcpstat_packet,\r\ndhcpstat_draw);\r\nif (error_string){\r\ng_free(sp->filter);\r\ng_free(sp);\r\nfprintf(stderr, "tshark: Couldn't register dhcp,stat tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_gtkdhcpstat(void)\r\n{\r\nregister_stat_cmd_arg("bootp,stat,", dhcpstat_init,NULL);\r\n}

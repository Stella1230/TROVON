gboolean\r\nbrowser_needs_pref(void)\r\n{\r\n#ifdef MUST_LAUNCH_BROWSER_OURSELVES\r\nreturn TRUE;\r\n#else\r\nreturn FALSE;\r\n#endif\r\n}\r\ngboolean\r\nbrowser_open_url (const gchar *url)\r\n{\r\n#if defined(G_OS_WIN32)\r\nreturn ((gint) ShellExecute (HWND_DESKTOP, _T("open"), utf_8to16(url), NULL, NULL, SW_SHOWNORMAL) > 32);\r\n#elif defined(HAVE_OS_X_FRAMEWORKS)\r\nCFStringRef url_CFString;\r\nCFURLRef url_CFURL;\r\nOSStatus status;\r\nurl_CFString = CFStringCreateWithCString(NULL, url, kCFStringEncodingASCII);\r\nif (url_CFString == NULL)\r\nreturn (FALSE);\r\nurl_CFURL = CFURLCreateWithString(NULL, url_CFString, NULL);\r\nCFRelease(url_CFString);\r\nif (url_CFURL == NULL) {\r\nreturn (FALSE);\r\n}\r\nstatus = LSOpenCFURLRef(url_CFURL, NULL);\r\nCFRelease(url_CFURL);\r\nreturn (status == 0);\r\n#elif defined(HAVE_XDG_OPEN)\r\nGError *error = NULL;\r\nconst gchar *argv[3];\r\ngboolean retval;\r\ng_return_val_if_fail (url != NULL, FALSE);\r\nargv[0] = "xdg-open";\r\nargv[1] = url;\r\nargv[2] = NULL;\r\nretval = g_spawn_async (NULL, (gchar**) argv, NULL,\r\nG_SPAWN_SEARCH_PATH,\r\nNULL, NULL,\r\nNULL, &error);\r\nif (! retval)\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not execute xdg-open: %s\n\n\"%s\"",\r\nsimple_dialog_primary_start(), simple_dialog_primary_end(),\r\nerror->message);\r\ng_error_free (error);\r\n}\r\nreturn retval;\r\n#elif defined(MUST_LAUNCH_BROWSER_OURSELVES)\r\nGError *error = NULL;\r\ngchar *browser;\r\ngchar *argument;\r\ngchar *cmd;\r\ngchar **argv;\r\ngboolean retval;\r\ng_return_val_if_fail (url != NULL, FALSE);\r\nbrowser = g_strdup(prefs.gui_webbrowser);\r\nif (browser == NULL || ! strlen (browser))\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"Web browser not specified.\n"\r\n"Please correct the web browser setting in the Preferences dialog.\n"\r\n"URL: %s", url);\r\ng_free (browser);\r\nreturn FALSE;\r\n}\r\nargument = g_shell_quote (url);\r\nif (strstr (browser, "%s"))\r\ncmd = strreplace (browser, "%s", argument);\r\nelse\r\ncmd = g_strconcat (browser, " ", argument, NULL);\r\ng_free (argument);\r\nif (! g_shell_parse_argv (cmd, NULL, &argv, &error))\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not parse web browser command: \"%s\"%s\n\n\"%s\"\n\n%s",\r\nsimple_dialog_primary_start(), browser, simple_dialog_primary_end(),\r\nerror->message,\r\n"Please correct the web browser setting in the Preferences dialog.");\r\ng_error_free (error);\r\nreturn FALSE;\r\n}\r\nretval = g_spawn_async (NULL, argv, NULL,\r\nG_SPAWN_SEARCH_PATH,\r\nNULL, NULL,\r\nNULL, &error);\r\nif (! retval)\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not execute web browser: \"%s\"%s\n\n\"%s\"\n\n%s",\r\nsimple_dialog_primary_start(), browser, simple_dialog_primary_end(),\r\nerror->message,\r\n"Please correct the web browser setting in the Preferences dialog.");\r\ng_error_free (error);\r\n}\r\ng_free (browser);\r\ng_free (cmd);\r\ng_strfreev (argv);\r\nreturn retval;\r\n#endif\r\n}\r\ngboolean\r\nfilemanager_open_directory (const gchar *path)\r\n{\r\n#if defined(G_OS_WIN32)\r\ngint ret;\r\ngchar *xpath;\r\nxpath = g_strconcat(path,\r\ng_str_has_suffix(path, "\\") ? "" : "\\",\r\nNULL);\r\nret = (gint) ShellExecute (HWND_DESKTOP, _T("explore"), utf_8to16(xpath), NULL, NULL, SW_SHOWNORMAL);\r\ng_free(xpath);\r\nreturn (ret > 32);\r\n#elif defined(HAVE_OS_X_FRAMEWORKS)\r\nCFStringRef path_CFString;\r\nCFURLRef path_CFURL;\r\nOSStatus status;\r\npath_CFString = CFStringCreateWithCString(NULL, path, kCFStringEncodingUTF8);\r\nif (path_CFString == NULL)\r\nreturn (FALSE);\r\npath_CFURL = CFURLCreateWithFileSystemPath(NULL, path_CFString,\r\nkCFURLPOSIXPathStyle, true);\r\nCFRelease(path_CFString);\r\nif (path_CFURL == NULL) {\r\nreturn (FALSE);\r\n}\r\nstatus = LSOpenCFURLRef(path_CFURL, NULL);\r\nCFRelease(path_CFURL);\r\nreturn (status == 0);\r\n#elif defined(HAVE_XDG_OPEN)\r\nGError *error = NULL;\r\nconst gchar *argv[3];\r\ngboolean retval;\r\ng_return_val_if_fail (path != NULL, FALSE);\r\nargv[0] = "xdg-open";\r\nargv[1] = path;\r\nargv[2] = NULL;\r\nretval = g_spawn_async (NULL, (gchar**) argv, NULL,\r\nG_SPAWN_SEARCH_PATH,\r\nNULL, NULL,\r\nNULL, &error);\r\nif (! retval)\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not execute xdg-open: %s\n\n\"%s\"",\r\nsimple_dialog_primary_start(), simple_dialog_primary_end(),\r\nerror->message);\r\ng_error_free (error);\r\n}\r\nreturn retval;\r\n#elif defined(MUST_LAUNCH_BROWSER_OURSELVES)\r\nGError *error;\r\ngchar *browser;\r\ngchar *argument;\r\ngchar *cmd;\r\ngchar **argv;\r\ngboolean retval;\r\ng_return_val_if_fail (path != NULL, FALSE);\r\nbrowser = g_strdup(prefs.gui_webbrowser);\r\nif (browser == NULL || ! strlen (browser))\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"Web browser not specified.\n"\r\n"Please correct the web browser setting in the Preferences dialog.\n"\r\n"URL: %s", path);\r\ng_free (browser);\r\nreturn FALSE;\r\n}\r\nargument = g_filename_to_uri(path, NULL, &error);\r\nif (argument == NULL)\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not convert \"%s\" to a URI: \"%s\"%s\"",\r\nsimple_dialog_primary_start(), path, simple_dialog_primary_end(),\r\nerror->message);\r\ng_error_free (error);\r\nreturn FALSE;\r\n}\r\nif (strstr (browser, "%s"))\r\ncmd = strreplace (browser, "%s", argument);\r\nelse\r\ncmd = g_strconcat (browser, " ", argument, NULL);\r\ng_free (argument);\r\nif (! g_shell_parse_argv (cmd, NULL, &argv, &error))\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not parse web browser command: \"%s\"%s\n\n\"%s\"\n\n%s",\r\nsimple_dialog_primary_start(), browser, simple_dialog_primary_end(),\r\nerror->message,\r\n"Please correct the web browser setting in the Preferences dialog.");\r\ng_error_free (error);\r\nreturn FALSE;\r\n}\r\nretval = g_spawn_async (NULL, argv, NULL,\r\nG_SPAWN_SEARCH_PATH,\r\nNULL, NULL,\r\nNULL, &error);\r\nif (! retval)\r\n{\r\nsimple_dialog(ESD_TYPE_WARN, ESD_BTN_OK,\r\n"%sCould not execute web browser: \"%s\"%s\n\n\"%s\"\n\n%s",\r\nsimple_dialog_primary_start(), browser, simple_dialog_primary_end(),\r\nerror->message,\r\n"Please correct the web browser setting in the Preferences dialog.");\r\ng_error_free (error);\r\n}\r\ng_free (browser);\r\ng_free (cmd);\r\ng_strfreev (argv);\r\nreturn retval;\r\n#endif\r\n}\r\nstatic gchar*\r\nstrreplace (const gchar *string,\r\nconst gchar *delimiter,\r\nconst gchar *replacement)\r\n{\r\ngchar *ret;\r\ngchar **tmp;\r\ng_return_val_if_fail (string != NULL, NULL);\r\ng_return_val_if_fail (delimiter != NULL, NULL);\r\ng_return_val_if_fail (replacement != NULL, NULL);\r\ntmp = g_strsplit (string, delimiter, 0);\r\nret = g_strjoinv (replacement, tmp);\r\ng_strfreev (tmp);\r\nreturn ret;\r\n}\r\nvoid\r\nbrowser_open_data_file(const gchar *filename)\r\n{\r\ngchar *uri;\r\nuri = data_file_url(filename);\r\nbrowser_open_url (uri);\r\ng_free(uri);\r\n}

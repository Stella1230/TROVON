static void\r\nexpert_stat_reset(void *tapdata)\r\n{\r\ngint n;\r\nexpert_tapdata_t *etd = (expert_tapdata_t *)tapdata;\r\ng_string_chunk_free(etd->text);\r\netd->text = g_string_chunk_new(100);\r\nfor (n=0; n < max_level; n++) {\r\ng_array_set_size(etd->ei_array[n], 0);\r\n}\r\n}\r\nstatic int\r\nexpert_stat_packet(void *tapdata, packet_info *pinfo _U_, epan_dissect_t *edt _U_,\r\nconst void *pointer)\r\n{\r\nconst expert_info_t *ei = (const expert_info_t *)pointer;\r\nexpert_tapdata_t *data = (expert_tapdata_t *)tapdata;\r\nseverity_level_t severity_level;\r\nexpert_entry tmp_entry;\r\nexpert_entry *entry;\r\nguint n;\r\nswitch (ei->severity) {\r\ncase PI_CHAT:\r\nseverity_level = chat_level;\r\nbreak;\r\ncase PI_NOTE:\r\nseverity_level = note_level;\r\nbreak;\r\ncase PI_WARN:\r\nseverity_level = warn_level;\r\nbreak;\r\ncase PI_ERROR:\r\nseverity_level = error_level;\r\nbreak;\r\ndefault:\r\ng_assert_not_reached();\r\nreturn 0;\r\n}\r\nif (severity_level < lowest_report_level) {\r\nreturn 1;\r\n}\r\nfor (n=0; n < data->ei_array[severity_level]->len; n++) {\r\nentry = &g_array_index(data->ei_array[severity_level], expert_entry, n);\r\nif ((strcmp(ei->protocol, entry->protocol) == 0) &&\r\n(strcmp(ei->summary, entry->summary) == 0)) {\r\nentry->frequency++;\r\nreturn 1;\r\n}\r\n}\r\nentry = &tmp_entry;\r\nentry->protocol = g_string_chunk_insert_const(data->text, ei->protocol);\r\nentry->summary = g_string_chunk_insert_const(data->text, ei->summary);\r\nentry->group = ei->group;\r\nentry->frequency = 1;\r\ng_array_append_val(data->ei_array[severity_level], tmp_entry);\r\nreturn 1;\r\n}\r\nstatic void draw_items_for_severity(GArray *items, const gchar *label)\r\n{\r\nguint n;\r\nexpert_entry *ei;\r\nint total = 0;\r\nif (items->len == 0) {\r\nreturn;\r\n}\r\nfor (n=0; n < items->len; n++) {\r\nei = &g_array_index(items, expert_entry, n);\r\ntotal += ei->frequency;\r\n}\r\nprintf("\n%s (%u)\n", label, total);\r\nprintf("=============\n");\r\nprintf(" Frequency Group Protocol Summary\n");\r\nfor (n=0; n < items->len; n++) {\r\nei = &g_array_index(items, expert_entry, n);\r\nprintf("%12u %10s %18s %s\n",\r\nei->frequency,\r\nval_to_str(ei->group, expert_group_vals, "Unknown"),\r\nei->protocol, ei->summary);\r\n}\r\n}\r\nstatic void\r\nexpert_stat_draw(void *phs _U_)\r\n{\r\nexpert_tapdata_t *hs = (expert_tapdata_t *)phs;\r\ndraw_items_for_severity(hs->ei_array[error_level], "Errors");\r\ndraw_items_for_severity(hs->ei_array[warn_level], "Warns");\r\ndraw_items_for_severity(hs->ei_array[note_level], "Notes");\r\ndraw_items_for_severity(hs->ei_array[chat_level], "Chats");\r\n}\r\nstatic void expert_stat_init(const char *opt_arg, void *userdata _U_)\r\n{\r\nconst char *args = NULL;\r\nconst char *filter = NULL;\r\nGString *error_string;\r\nexpert_tapdata_t *hs;\r\nint n;\r\nif (strncmp(opt_arg, "expert", 6) == 0) {\r\nargs = opt_arg + 6;\r\n}\r\nelse {\r\nlowest_report_level = max_level;\r\n}\r\nif (args != NULL) {\r\nif (g_ascii_strncasecmp(args, ",error", 6) == 0) {\r\nlowest_report_level = error_level;\r\nargs += 6;\r\n}\r\nelse if (g_ascii_strncasecmp(args, ",warn", 5) == 0) {\r\nlowest_report_level = warn_level;\r\nargs += 5;\r\n} else if (g_ascii_strncasecmp(args, ",note", 5) == 0) {\r\nlowest_report_level = note_level;\r\nargs += 5;\r\n} else if (g_ascii_strncasecmp(args, ",chat", 5) == 0) {\r\nlowest_report_level = chat_level;\r\nargs += 5;\r\n}\r\n}\r\nif (args != NULL) {\r\nif (args[0] == ',') {\r\nfilter = args+1;\r\n}\r\n}\r\nhs = g_new(expert_tapdata_t,1);\r\nmemset(hs, 0, sizeof(expert_tapdata_t));\r\nhs->text = g_string_chunk_new(100);\r\nfor (n=0; n < max_level; n++) {\r\nhs->ei_array[n] = g_array_sized_new(FALSE, FALSE, sizeof(expert_entry), 1000);\r\n}\r\nerror_string = register_tap_listener("expert", hs,\r\nfilter, 0,\r\nexpert_stat_reset,\r\nexpert_stat_packet,\r\nexpert_stat_draw);\r\nif (error_string) {\r\nprintf("Expert tap error (%s)!\n", error_string->str);\r\ng_string_free(error_string, TRUE);\r\ng_free(hs);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_expert_info(void)\r\n{\r\nregister_stat_cmd_arg("expert", expert_stat_init, NULL);\r\n}

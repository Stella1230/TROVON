static void camelcounter_reset(void *phs)\r\n{\r\nstruct camelcounter_t * p_counter= ( struct camelcounter_t *) phs;\r\nmemset(p_counter,0,sizeof(struct camelcounter_t));\r\n}\r\nstatic int camelcounter_packet(void *phs,\r\npacket_info *pinfo _U_,\r\nepan_dissect_t *edt _U_,\r\nconst void *phi)\r\n{\r\nstruct camelcounter_t * p_counter =(struct camelcounter_t *)phs;\r\nconst struct camelsrt_info_t * pi=(const struct camelsrt_info_t *)phi;\r\nif (pi->opcode != 255)\r\np_counter->camel_msg[pi->opcode]++;\r\nreturn 1;\r\n}\r\nstatic void camelcounter_draw(void *phs)\r\n{\r\nstruct camelcounter_t * p_counter= (struct camelcounter_t *)phs;\r\nint i;\r\nprintf("\n");\r\nprintf("CAMEL Message and Response Status Counter:\n");\r\nprintf("------------------------------------------\n");\r\nfor(i=0;i<camel_MAX_NUM_OPR_CODES;i++) {\r\nif(p_counter->camel_msg[i]!=0) {\r\nprintf("%30s ", val_to_str(i,camel_opr_code_strings,"Unknown message "));\r\nprintf("%6d\n", p_counter->camel_msg[i]);\r\n}\r\n}\r\nprintf("------------------------------------------\n");\r\n}\r\nstatic void camelcounter_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nstruct camelcounter_t *p_camelcounter;\r\nGString *error_string;\r\np_camelcounter = g_new(struct camelcounter_t,1);\r\nif(!strncmp(opt_arg,"camel,counter,",13)){\r\np_camelcounter->filter=g_strdup(opt_arg+13);\r\n} else {\r\np_camelcounter->filter=NULL;\r\n}\r\ncamelcounter_reset(p_camelcounter);\r\nerror_string=register_tap_listener("CAMEL",\r\np_camelcounter,\r\np_camelcounter->filter,\r\n0,\r\nNULL,\r\ncamelcounter_packet,\r\ncamelcounter_draw);\r\nif(error_string){\r\ng_free(p_camelcounter->filter);\r\ng_free(p_camelcounter);\r\nfprintf(stderr, "tshark: Couldn't register camel,counter tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_camelcounter(void)\r\n{\r\nregister_stat_cmd_arg("camel,counter", camelcounter_init, NULL);\r\n}

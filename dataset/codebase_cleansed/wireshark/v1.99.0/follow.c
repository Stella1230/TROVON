static char *\r\nsgetline(char *str, int *next)\r\n{\r\nchar *end;\r\nend = strstr(str, "\r\n");\r\nif (!end) {\r\n*next = (int)strlen(str);\r\nreturn NULL;\r\n}\r\n*end = '\0';\r\n*next = (int)(end-str+2);\r\nreturn str;\r\n}\r\ngboolean\r\nparse_http_header(char *data, size_t len, size_t *content_start)\r\n{\r\nchar *tmp, *copy, *line;\r\nsize_t pos = 0;\r\nint next_line;\r\ngboolean is_gzipped;\r\ntmp = copy = g_strndup(data, len);\r\nif (!tmp) {\r\n*content_start = 0;\r\nreturn FALSE;\r\n}\r\nsgetline(tmp, &next_line);\r\ntmp += next_line;\r\npos += next_line;\r\nis_gzipped = FALSE;\r\n*content_start = -1;\r\nwhile ((line = sgetline(tmp, &next_line))) {\r\nchar *key, *val, *c;\r\ntmp += next_line;\r\npos += next_line;\r\nif (strlen(line) == 0) {\r\nbreak;\r\n}\r\nc = strchr(line, ':');\r\nif (!c) break;\r\nkey = line;\r\n*c = '\0';\r\nval = c+2;\r\nif (!strcmp(key, "Content-Encoding") && strstr(val, "gzip")) {\r\nis_gzipped = TRUE;\r\n}\r\n}\r\n*content_start = pos;\r\ng_free(copy);\r\nreturn is_gzipped;\r\n}

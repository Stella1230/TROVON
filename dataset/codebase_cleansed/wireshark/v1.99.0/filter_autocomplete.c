static gboolean\r\nis_protocol_name_being_typed(GtkWidget *filter_te, int str_len)\r\n{\r\nunsigned int i;\r\nint op_len, cursor_pos;\r\ngchar *start;\r\ngchar *pos;\r\nstatic const gchar *logic_ops[] =\r\n{ "!", "not",\r\n"||", "or",\r\n"&&", "and",\r\n"^^", "xor" };\r\nif(!(cursor_pos = gtk_editable_get_position(GTK_EDITABLE(filter_te))))\r\nreturn TRUE;\r\nstart = gtk_editable_get_chars(GTK_EDITABLE(filter_te), 0, (gint) cursor_pos);\r\npos = start + (cursor_pos - str_len);\r\nwhile(pos > start) {\r\nif(*pos != ' ' && *pos != '(') {\r\nfor(i = 0; i < (sizeof(logic_ops)/sizeof(logic_ops[0])); i++) {\r\nop_len = (int) strlen(logic_ops[i]);\r\nif(pos-start+1 < op_len)\r\ncontinue;\r\nif(!strncmp(pos-op_len+1, logic_ops[i], op_len)) {\r\ng_free (start);\r\nreturn TRUE;\r\n}\r\n}\r\ng_free (start);\r\nreturn FALSE;\r\n}\r\npos--;\r\n}\r\ng_free (start);\r\nreturn TRUE;\r\n}\r\nstatic void\r\nautocomplete_protocol_string(GtkWidget *filter_te, gchar *selected_str)\r\n{\r\nint pos;\r\ngchar *filter_str;\r\ngchar *pch;\r\npos = gtk_editable_get_position(GTK_EDITABLE(filter_te));\r\nfilter_str = gtk_editable_get_chars(GTK_EDITABLE(filter_te), 0, pos);\r\npch = filter_str + strlen(filter_str);\r\nwhile(pch != filter_str) {\r\npch--;\r\nif(!g_ascii_isalnum(*pch) && (*pch) != '.' && (*pch) != '_' && (*pch) != '-') {\r\npch++;\r\nbreak;\r\n}\r\n}\r\nif(strncmp(pch, selected_str, pos-(pch-filter_str))) {\r\ngtk_editable_delete_text(GTK_EDITABLE(filter_te), (gint) (pch-filter_str), pos);\r\npos = (int) (pch-filter_str);\r\npch = selected_str;\r\n} else {\r\npch = (selected_str + strlen(pch));\r\n}\r\ngtk_editable_insert_text(GTK_EDITABLE(filter_te), pch, (gint) strlen(pch), &pos);\r\ngtk_editable_set_position(GTK_EDITABLE(filter_te), pos);\r\ng_free (filter_str);\r\n}\r\nstatic void\r\nautoc_filter_row_activated_cb(GtkTreeView *treeview,\r\nGtkTreePath *path,\r\nGtkTreeViewColumn *column _U_,\r\ngpointer data)\r\n{\r\nGtkWidget *w_main;\r\nGtkTreeModel *model;\r\nGtkTreeIter iter;\r\nGtkWidget *win;\r\ngchar *proto;\r\nmodel = gtk_tree_view_get_model(treeview);\r\nif (gtk_tree_model_get_iter(model, &iter, path)) {\r\ngtk_tree_model_get(model, &iter, 0, &proto, -1);\r\nautocomplete_protocol_string(GTK_WIDGET(data), proto);\r\ng_free (proto);\r\n}\r\nw_main = gtk_widget_get_toplevel(GTK_WIDGET(data));\r\nwin = (GtkWidget *)g_object_get_data(G_OBJECT(w_main), E_FILT_AUTOCOMP_PTR_KEY);\r\nif(win != NULL) {\r\ngtk_widget_destroy(win);\r\ng_object_set_data(G_OBJECT(w_main), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\n}\r\n}\r\nstatic gboolean\r\nfilter_te_focus_out_cb(GtkWidget *filter_te _U_,\r\nGdkEvent *event _U_,\r\ngpointer data)\r\n{\r\nGtkWidget *win;\r\nwin = (GtkWidget *)g_object_get_data(G_OBJECT(data), E_FILT_AUTOCOMP_PTR_KEY);\r\nif(win != NULL) {\r\ngtk_widget_destroy(win);\r\ng_object_set_data(G_OBJECT(data), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\n}\r\nreturn FALSE;\r\n}\r\nstatic gboolean\r\ncheck_select_region (GtkWidget *filter_te, GtkWidget *popup_win,\r\nconst gchar *string, unsigned int str_len)\r\n{\r\ngint pos1 = gtk_editable_get_position(GTK_EDITABLE(filter_te));\r\ngint pos2 = pos1 + (gint) strlen(string) - str_len;\r\ngint pos3 = pos1;\r\nif (pos2 > pos1) {\r\ngtk_editable_insert_text(GTK_EDITABLE(filter_te), &string[str_len-1],\r\npos2-pos1+1, &pos3);\r\ngtk_editable_set_position(GTK_EDITABLE(filter_te), pos1+1);\r\ngtk_editable_select_region(GTK_EDITABLE(filter_te), pos1+1, pos2+1);\r\ngtk_widget_hide (popup_win);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\nstatic void\r\ninit_autocompletion_list(GtkWidget *list)\r\n{\r\nGtkCellRenderer *renderer;\r\nGtkTreeViewColumn *column;\r\nGtkListStore *store;\r\nrenderer = gtk_cell_renderer_text_new();\r\ncolumn = gtk_tree_view_column_new_with_attributes(NULL, renderer, "text", 0, NULL);\r\ngtk_tree_view_append_column(GTK_TREE_VIEW(list), column);\r\ngtk_tree_view_set_headers_visible(GTK_TREE_VIEW(list), FALSE);\r\nstore = gtk_list_store_new(1, G_TYPE_STRING);\r\ngtk_tree_view_set_model(GTK_TREE_VIEW(list), GTK_TREE_MODEL(store));\r\ng_object_unref(store);\r\n}\r\nstatic void\r\nadd_to_autocompletion_list(GtkWidget *list, const gchar *str)\r\n{\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(list)));\r\ngtk_list_store_append(store, &iter);\r\ngtk_list_store_set(store, &iter, 0, str, -1);\r\n}\r\nstatic gboolean\r\nautocompletion_list_lookup(GtkWidget *filter_te, GtkWidget *popup_win, GtkWidget *list,\r\nconst gchar *str, gboolean *stop_propagation)\r\n{\r\nGtkRequisition requisition;\r\nGtkListStore *store;\r\nGtkTreeIter iter;\r\nGtkAllocation popup_win_alloc;\r\ngchar *curr_str;\r\nunsigned int str_len = (unsigned int) strlen(str);\r\ngchar *first = NULL;\r\ngint count = 0;\r\ngboolean loop = TRUE;\r\ngboolean exact_match = FALSE;\r\nstore = GTK_LIST_STORE(gtk_tree_view_get_model(GTK_TREE_VIEW(list)));\r\nif( gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter) ) {\r\ndo {\r\ngtk_tree_model_get(GTK_TREE_MODEL(store), &iter, 0, &curr_str, -1);\r\nif( !g_ascii_strncasecmp(str, curr_str, str_len) ) {\r\nloop = gtk_tree_model_iter_next(GTK_TREE_MODEL(store), &iter);\r\nif (strlen(curr_str) == str_len) {\r\nexact_match = TRUE;\r\n}\r\ncount++;\r\nif (count == 1)\r\nfirst = g_strdup (curr_str);\r\n} else {\r\nloop = gtk_list_store_remove(store, &iter);\r\n}\r\ng_free(curr_str);\r\n} while( loop );\r\nif (count == 1 && !exact_match && strncmp(str, first, str_len) == 0) {\r\n*stop_propagation = check_select_region(filter_te, popup_win, first, str_len);\r\n}\r\nif ((count == 1 && exact_match && strncmp(str, first, str_len) == 0) ||\r\n!gtk_tree_model_get_iter_first(GTK_TREE_MODEL(store), &iter))\r\n{\r\ng_free (first);\r\nreturn FALSE;\r\n}\r\ng_free (first);\r\ngtk_tree_view_columns_autosize(GTK_TREE_VIEW(list));\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_get_preferred_size(list, &requisition, NULL);\r\n#else\r\ngtk_widget_size_request(list, &requisition);\r\n#endif\r\ngtk_widget_get_allocation(popup_win, &popup_win_alloc);\r\ngtk_widget_set_size_request(popup_win, popup_win_alloc.width,\r\n(requisition.height<200? requisition.height+8:200));\r\ngtk_window_resize(GTK_WINDOW(popup_win), popup_win_alloc.width,\r\n(requisition.height<200? requisition.height+8:200));\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}\r\ngboolean\r\nfilter_string_te_key_pressed_cb(GtkWidget *filter_te, GdkEventKey *event, gpointer user_data _U_)\r\n{\r\nGtkWidget *popup_win;\r\nGtkWidget *w_toplevel;\r\nGtkWidget *treeview;\r\nGtkTreeModel *model;\r\nGtkTreePath *path;\r\nGtkTreeSelection *selection;\r\nGtkTreeIter iter;\r\ngchar* prefix;\r\ngchar* prefix_start;\r\ngboolean stop_propagation = FALSE;\r\nguint k;\r\ngchar ckey;\r\ngint pos;\r\nw_toplevel = gtk_widget_get_toplevel(filter_te);\r\npopup_win = (GtkWidget *)g_object_get_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY);\r\nk = event->keyval;\r\nckey = event->string[0];\r\nif( k == GDK_Shift_L || k == GDK_Shift_R)\r\nreturn FALSE;\r\nif (popup_win)\r\ngtk_widget_show(popup_win);\r\npos = gtk_editable_get_position(GTK_EDITABLE(filter_te));\r\nif (g_ascii_isalnum(ckey) ||\r\nk == GDK_KP_Decimal || k == GDK_period ||\r\nk == GDK_underscore || k == GDK_minus)\r\n{\r\ngtk_editable_delete_selection(GTK_EDITABLE(filter_te));\r\n} else if (k == GDK_Return || k == GDK_KP_Enter) {\r\ngtk_editable_select_region(GTK_EDITABLE(filter_te), pos, pos);\r\n}\r\nprefix_start = gtk_editable_get_chars(GTK_EDITABLE(filter_te), 0, pos);\r\nif( !g_ascii_isalnum(ckey) &&\r\nk != GDK_KP_Decimal && k != GDK_period &&\r\nk != GDK_underscore && k != GDK_minus &&\r\nk != GDK_space && k != GDK_Return && k != GDK_KP_Enter &&\r\nk != GDK_Page_Down && k != GDK_Down && k != GDK_Page_Up && k != GDK_Up &&\r\nk != GDK_BackSpace)\r\n{\r\nif (popup_win) {\r\ngtk_widget_destroy(popup_win);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\n}\r\nreturn FALSE;\r\n}\r\nprefix = prefix_start + strlen(prefix_start);\r\nwhile(prefix != prefix_start) {\r\nprefix--;\r\nif(!g_ascii_isalnum((*prefix)) && (*prefix) != '.' && (*prefix) != '_' && (*prefix) != '-') {\r\nprefix++;\r\nbreak;\r\n}\r\n}\r\nif(k==GDK_period || k==GDK_KP_Decimal) {\r\nif( !strchr(prefix, '.') || !popup_win) {\r\ngchar* name_with_period;\r\nif (popup_win) {\r\ngtk_widget_destroy (popup_win);\r\n}\r\nname_with_period = g_strconcat(prefix, event->string, NULL);\r\npopup_win = filter_autocomplete_new(filter_te, name_with_period, FALSE, &stop_propagation);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, popup_win);\r\ng_free(name_with_period);\r\ng_free(prefix_start);\r\nreturn stop_propagation;\r\n}\r\n} else if(k==GDK_BackSpace && !popup_win) {\r\nif(strlen(prefix) > 1) {\r\nprefix[strlen(prefix)-1] = '\0';\r\nif(strchr(prefix, '.')) {\r\npopup_win = filter_autocomplete_new(filter_te, prefix, FALSE, NULL);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, popup_win);\r\n} else if(strlen(prefix) && is_protocol_name_being_typed(filter_te, (int) strlen(prefix)+2)) {\r\npopup_win = filter_autocomplete_new(filter_te, prefix, TRUE, NULL);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, popup_win);\r\n}\r\n}\r\ng_free(prefix_start);\r\nreturn FALSE;\r\n} else if(g_ascii_isalnum(ckey) && !popup_win) {\r\ngchar *name = g_strconcat(prefix, event->string, NULL);\r\nif( !strchr(name, '.') && is_protocol_name_being_typed(filter_te, (int) strlen(name)) ) {\r\npopup_win = filter_autocomplete_new(filter_te, name, TRUE, &stop_propagation);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, popup_win);\r\n}\r\ng_free(name);\r\ng_free(prefix_start);\r\nreturn stop_propagation;\r\n}\r\nif( !popup_win ) {\r\ng_free(prefix_start);\r\nreturn FALSE;\r\n}\r\ntreeview = (GtkWidget *)g_object_get_data(G_OBJECT(popup_win), E_FILT_AUTOCOMP_TREE_KEY);\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(treeview));\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(treeview));\r\nswitch(k)\r\n{\r\ncase GDK_Page_Down:\r\ncase GDK_Down:\r\nif (gtk_tree_selection_get_selected(selection, &model, &iter)) {\r\nif (gtk_tree_model_iter_next(model, &iter)) {\r\nif (k == GDK_Page_Down) {\r\nGtkTreeIter last_iter;\r\ngint count = 0;\r\ndo {\r\nlast_iter = iter;\r\n} while (++count < 8 && gtk_tree_model_iter_next(model, &iter));\r\niter = last_iter;\r\n}\r\ngtk_tree_selection_select_iter(GTK_TREE_SELECTION(selection), &iter);\r\npath = gtk_tree_model_get_path(model, &iter);\r\ngtk_tree_view_scroll_to_cell(GTK_TREE_VIEW(treeview), path,\r\nNULL, FALSE, 0, 0);\r\ngtk_tree_path_free(path);\r\n} else {\r\ngtk_tree_selection_unselect_all(selection);\r\n}\r\n} else if (gtk_tree_model_get_iter_first(model, &iter)) {\r\ngtk_tree_selection_select_iter(GTK_TREE_SELECTION(selection), &iter);\r\npath = gtk_tree_model_get_path(model, &iter);\r\ngtk_tree_view_scroll_to_cell(GTK_TREE_VIEW(treeview), path,\r\nNULL, FALSE, 0, 0);\r\ngtk_tree_path_free(path);\r\n}\r\ng_free(prefix_start);\r\nreturn TRUE;\r\ncase GDK_Page_Up:\r\ncase GDK_Up:\r\n{\r\nGtkTreeIter last_iter;\r\nif (gtk_tree_selection_get_selected(selection, &model, &iter) ) {\r\npath = gtk_tree_model_get_path(model, &iter);\r\nif (gtk_tree_path_prev(path)) {\r\nif (k == GDK_Page_Up) {\r\nGtkTreePath *last_path;\r\ngint count = 0;\r\ndo {\r\nlast_path = path;\r\n} while (++count < 8 && gtk_tree_path_prev(path));\r\npath = last_path;\r\n}\r\ngtk_tree_selection_select_path(GTK_TREE_SELECTION(selection), path);\r\ngtk_tree_view_scroll_to_cell(GTK_TREE_VIEW(treeview), path, NULL, FALSE, 0, 0);\r\n} else {\r\ngtk_tree_selection_unselect_iter(selection, &iter);\r\n}\r\ngtk_tree_path_free(path);\r\n} else if (gtk_tree_model_get_iter_first(model, &iter)) {\r\ndo {\r\nlast_iter = iter;\r\n} while (gtk_tree_model_iter_next(model, &iter));\r\ngtk_tree_selection_select_iter(GTK_TREE_SELECTION(selection), &last_iter);\r\npath = gtk_tree_model_get_path(model, &last_iter);\r\ngtk_tree_view_scroll_to_cell(GTK_TREE_VIEW(treeview), path,\r\nNULL, FALSE, 0, 0);\r\ngtk_tree_path_free(path);\r\n}\r\ng_free(prefix_start);\r\nreturn TRUE;\r\n}\r\ncase GDK_space:\r\ncase GDK_Return:\r\ncase GDK_KP_Enter:\r\nif(gtk_tree_selection_get_selected(selection, &model, &iter) ) {\r\ngchar *value;\r\nif(k != GDK_space || strchr(prefix, '.')) {\r\ngtk_tree_model_get(model, &iter, 0, &value, -1);\r\nautocomplete_protocol_string(filter_te, value);\r\ng_free(value);\r\n}\r\nif(k != GDK_space) {\r\nstop_propagation = TRUE;\r\n}\r\n}\r\ngtk_widget_destroy(popup_win);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\nbreak;\r\ncase GDK_BackSpace:\r\nfilter_autocomplete_handle_backspace(filter_te, treeview, popup_win, prefix, w_toplevel);\r\nbreak;\r\ndefault: {\r\ngchar* updated_str;\r\nupdated_str = g_strconcat(prefix, event->string, NULL);\r\nif( !autocompletion_list_lookup(filter_te, popup_win, treeview, updated_str, &stop_propagation) ) {\r\ngtk_widget_destroy(popup_win);\r\ng_object_set_data(G_OBJECT(w_toplevel), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\n}\r\ng_free(updated_str);\r\n}\r\n}\r\ng_free(prefix_start);\r\nreturn stop_propagation;\r\n}\r\nstatic gboolean\r\nbuild_autocompletion_list(GtkWidget *filter_te, GtkWidget *treeview, GtkWidget *popup_win,\r\nconst gchar *protocol_name, gboolean protocols_only, gboolean *stop_propagation)\r\n{\r\nvoid *cookie, *cookie2;\r\nprotocol_t *protocol;\r\nunsigned int protocol_name_len;\r\nheader_field_info *hfinfo;\r\ngint count = 0;\r\ngboolean exact_match = FALSE;\r\nconst gchar *first = NULL;\r\nint i;\r\nprotocol_name_len = (unsigned int) strlen(protocol_name);\r\nif(protocol_name[protocol_name_len-1] == '.')\r\nproto_registrar_get_byname(protocol_name);\r\nfor (i = proto_get_first_protocol(&cookie); i != -1; i = proto_get_next_protocol(&cookie)) {\r\nprotocol = find_protocol_by_id(i);\r\nif (!proto_is_protocol_enabled(protocol))\r\ncontinue;\r\nif (protocols_only) {\r\nconst gchar *name = proto_get_protocol_filter_name (i);\r\nif (!g_ascii_strncasecmp(protocol_name, name, protocol_name_len)) {\r\nadd_to_autocompletion_list(treeview, name);\r\nif (strlen(name) == protocol_name_len) {\r\nexact_match = TRUE;\r\n}\r\ncount++;\r\nif (count == 1)\r\nfirst = name;\r\n}\r\n} else {\r\nfor (hfinfo = proto_get_first_protocol_field(i, &cookie2);\r\nhfinfo != NULL;\r\nhfinfo = proto_get_next_protocol_field(i, &cookie2))\r\n{\r\nif (hfinfo->same_name_prev_id != -1)\r\ncontinue;\r\nif(!g_ascii_strncasecmp(protocol_name, hfinfo->abbrev, protocol_name_len)) {\r\nadd_to_autocompletion_list(treeview, hfinfo->abbrev);\r\nif (strlen(hfinfo->abbrev) == protocol_name_len) {\r\nexact_match = TRUE;\r\n}\r\ncount++;\r\nif (count == 1)\r\nfirst = hfinfo->abbrev;\r\n}\r\n}\r\n}\r\n}\r\nif (count == 1 && !exact_match && stop_propagation &&\r\nstrncmp(protocol_name, first, protocol_name_len) == 0)\r\n{\r\n*stop_propagation = check_select_region(filter_te, popup_win, first, protocol_name_len);\r\n}\r\nif (count == 0 || (count == 1 && exact_match &&\r\nstrncmp(protocol_name, first, protocol_name_len) == 0))\r\nreturn FALSE;\r\nreturn TRUE;\r\n}\r\nstatic void\r\nfilter_autocomplete_disable_sorting(GtkTreeModel *model)\r\n{\r\ngtk_tree_sortable_set_sort_column_id(GTK_TREE_SORTABLE(model),\r\nGTK_TREE_SORTABLE_UNSORTED_SORT_COLUMN_ID, GTK_SORT_ASCENDING);\r\n}\r\nstatic void\r\nfilter_autocomplete_enable_sorting(GtkTreeModel *model)\r\n{\r\ngtk_tree_sortable_set_sort_column_id(GTK_TREE_SORTABLE(model), 0, GTK_SORT_ASCENDING);\r\n}\r\nstatic GtkWidget *\r\nfilter_autocomplete_new(GtkWidget *filter_te, const gchar *protocol_name,\r\ngboolean protocols_only, gboolean *stop_propagation)\r\n{\r\nGtkWidget *popup_win;\r\nGtkWidget *treeview;\r\nGtkWidget *filter_sc;\r\ngint x_pos, y_pos;\r\nGtkTreeModel *model;\r\nGtkTreeSelection *selection;\r\nGtkRequisition requisition;\r\nGtkWidget *w_toplevel;\r\nGtkAllocation filter_te_alloc;\r\nw_toplevel = gtk_widget_get_toplevel(filter_te);\r\npopup_win = gtk_window_new (GTK_WINDOW_POPUP);\r\nfilter_sc = scrolled_window_new(NULL, NULL);\r\ngtk_scrolled_window_set_policy (GTK_SCROLLED_WINDOW (filter_sc), GTK_POLICY_AUTOMATIC, GTK_POLICY_AUTOMATIC);\r\ngtk_scrolled_window_set_shadow_type(GTK_SCROLLED_WINDOW(filter_sc), GTK_SHADOW_IN);\r\ngtk_container_add(GTK_CONTAINER(popup_win), filter_sc);\r\ntreeview = gtk_tree_view_new();\r\ngtk_tree_view_set_hover_selection(GTK_TREE_VIEW(treeview), TRUE);\r\ninit_autocompletion_list(treeview);\r\ng_object_set_data(G_OBJECT(popup_win), E_FILT_AUTOCOMP_TREE_KEY, treeview);\r\nif (!build_autocompletion_list(filter_te, treeview, popup_win, protocol_name, protocols_only, stop_propagation)) {\r\ngtk_widget_destroy(popup_win);\r\nreturn NULL;\r\n}\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(treeview));\r\nif(model)\r\nfilter_autocomplete_enable_sorting(model);\r\ngtk_container_add (GTK_CONTAINER (filter_sc), treeview);\r\ng_signal_connect(treeview, "row-activated", G_CALLBACK(autoc_filter_row_activated_cb), filter_te);\r\ng_signal_connect(filter_te, "focus-out-event", G_CALLBACK(filter_te_focus_out_cb), w_toplevel);\r\ng_signal_connect(popup_win, "destroy", G_CALLBACK(filter_autocomplete_win_destroy_cb), NULL);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_get_preferred_size(treeview, &requisition, NULL);\r\n#else\r\ngtk_widget_size_request(treeview, &requisition);\r\n#endif\r\ngtk_widget_get_allocation(filter_te, &filter_te_alloc);\r\ngtk_widget_set_size_request(popup_win, filter_te_alloc.width,\r\n(requisition.height<200? requisition.height+8:200));\r\ngtk_window_resize(GTK_WINDOW(popup_win), filter_te_alloc.width,\r\n(requisition.height<200? requisition.height+8:200));\r\ngdk_window_get_origin(gtk_widget_get_window(filter_te), &x_pos, &y_pos);\r\n#if GTK_CHECK_VERSION(3,0,0)\r\nx_pos += filter_te_alloc.x;\r\ny_pos += (filter_te_alloc.y + filter_te_alloc.height);\r\n#else\r\ny_pos += filter_te_alloc.height;\r\n#endif\r\ngtk_window_move(GTK_WINDOW(popup_win), x_pos, y_pos);\r\ngtk_widget_show_all (popup_win);\r\nselection = gtk_tree_view_get_selection(GTK_TREE_VIEW(treeview));\r\ngtk_tree_selection_unselect_all(selection);\r\nreturn popup_win;\r\n}\r\nstatic void\r\nfilter_autocomplete_handle_backspace(GtkWidget *filter_te, GtkWidget *list, GtkWidget *popup_win,\r\ngchar *prefix, GtkWidget *main_win)\r\n{\r\nGtkTreeModel *model;\r\nGtkListStore *store;\r\nGtkRequisition requisition;\r\nsize_t prefix_len;\r\ngboolean protocols_only = FALSE;\r\nGtkAllocation popup_win_alloc;\r\nprefix_len = strlen(prefix);\r\nif (prefix_len <= 1) {\r\ngtk_widget_destroy(popup_win);\r\ng_object_set_data(G_OBJECT(main_win), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\nreturn;\r\n}\r\nprefix_len--;\r\nprefix[prefix_len] = '\0';\r\nif(strchr(prefix, '.') == NULL) {\r\nprotocols_only = TRUE;\r\n}\r\nmodel = gtk_tree_view_get_model(GTK_TREE_VIEW(list));\r\nstore = GTK_LIST_STORE(model);\r\ngtk_list_store_clear(store);\r\nfilter_autocomplete_disable_sorting(model);\r\nif (!build_autocompletion_list(filter_te, list, popup_win, prefix, protocols_only, NULL)) {\r\ngtk_widget_destroy(popup_win);\r\ng_object_set_data(G_OBJECT(main_win), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\nreturn;\r\n}\r\nfilter_autocomplete_enable_sorting(model);\r\ngtk_tree_view_columns_autosize(GTK_TREE_VIEW(list));\r\n#if GTK_CHECK_VERSION(3,0,0)\r\ngtk_widget_get_preferred_size(list, &requisition, NULL);\r\n#else\r\ngtk_widget_size_request(list, &requisition);\r\n#endif\r\ngtk_widget_get_allocation(popup_win, &popup_win_alloc);\r\ngtk_widget_set_size_request(popup_win, popup_win_alloc.width,\r\n(requisition.height<200? requisition.height+8:200));\r\ngtk_window_resize(GTK_WINDOW(popup_win), popup_win_alloc.width,\r\n(requisition.height<200? requisition.height+8:200));\r\n}\r\nstatic void\r\nfilter_autocomplete_win_destroy_cb(GtkWidget *win, gpointer data _U_)\r\n{\r\ng_object_set_data(G_OBJECT(win), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\n}\r\ngboolean\r\nfilter_parent_dlg_key_pressed_cb(GtkWidget *win, GdkEventKey *event, gpointer user_data _U_)\r\n{\r\nGtkWidget *popup_win;\r\npopup_win = (GtkWidget *)g_object_get_data(G_OBJECT(win), E_FILT_AUTOCOMP_PTR_KEY);\r\nif(popup_win && event->keyval == GDK_Escape) {\r\ngtk_widget_destroy(popup_win);\r\ng_object_set_data(G_OBJECT(win), E_FILT_AUTOCOMP_PTR_KEY, NULL);\r\nreturn TRUE;\r\n}\r\nreturn FALSE;\r\n}

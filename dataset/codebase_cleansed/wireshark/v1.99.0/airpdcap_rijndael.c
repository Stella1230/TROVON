UCHAR\r\nAES_unwrap(UCHAR *kek, UINT16 key_len, UCHAR *cipher_text, UINT16 cipher_len, UCHAR *output)\r\n{\r\nUCHAR a[8], b[16];\r\nUCHAR *r;\r\nUCHAR *c;\r\ngint16 i, j, n;\r\nrijndael_ctx ctx;\r\nif (! kek || cipher_len < 16 || ! cipher_text || ! output) {\r\nreturn 1;\r\n}\r\nn = (cipher_len/8)-1;\r\nmemcpy(a, cipher_text, 8);\r\nr = output;\r\nc = cipher_text;\r\nmemcpy(r, c+8, cipher_len - 8);\r\nfor (j=5; j >= 0; --j){\r\nr = output + (n - 1) * 8;\r\nfor (i = n; i >= 1; --i){\r\nUINT16 t = (n*j) + i;\r\nmemcpy(b, a, 8);\r\nb[7] ^= t;\r\nmemcpy(b+8, r, 8);\r\nrijndael_set_key(&ctx, kek, key_len*8 );\r\nrijndael_decrypt(&ctx, b, b);\r\nmemcpy(a,b,8);\r\nmemcpy(r, b+8, 8);\r\nr -= 8;\r\n}\r\n}\r\nreturn 0;\r\n}

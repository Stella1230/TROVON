static gboolean\r\ncheck_for_codec_plugin(GModule *handle)\r\n{\r\ngpointer gp;\r\nvoid (*register_codec_module)(void);\r\ncodec_plugin *plugin;\r\nif (!g_module_symbol(handle, "register_codec_module", &gp)) {\r\nreturn FALSE;\r\n}\r\nregister_codec_module = (void (*)(void))gp;\r\nplugin = (codec_plugin *)g_malloc(sizeof (codec_plugin));\r\nplugin->register_codec_module = register_codec_module;\r\ncodec_plugins = g_slist_append(codec_plugins, plugin);\r\nreturn TRUE;\r\n}\r\nvoid\r\ncodec_register_plugin_types(void)\r\n{\r\nadd_plugin_type("codec", check_for_codec_plugin);\r\n}\r\nstatic void\r\nregister_codec_plugin(gpointer data, gpointer user_data _U_)\r\n{\r\ncodec_plugin *plugin = (codec_plugin *)data;\r\n(plugin->register_codec_module)();\r\n}\r\nvoid\r\nregister_all_codecs(void)\r\n{\r\nregister_codec("g711U", codec_g711u_init, codec_g711u_release,\r\ncodec_g711u_get_channels, codec_g711u_get_frequency, codec_g711u_decode);\r\nregister_codec("g711A", codec_g711a_init, codec_g711a_release,\r\ncodec_g711a_get_channels, codec_g711a_get_frequency, codec_g711a_decode);\r\n#ifdef HAVE_SPANDSP\r\nregister_codec("g722", codec_g722_init, codec_g722_release,\r\ncodec_g722_get_channels, codec_g722_get_frequency, codec_g722_decode);\r\nregister_codec("g726", codec_g726_init, codec_g726_release,\r\ncodec_g726_get_channels, codec_g726_get_frequency, codec_g726_decode);\r\n#endif\r\n#ifdef HAVE_SBC\r\nregister_codec("SBC", codec_sbc_init, codec_sbc_release,\r\ncodec_sbc_get_channels, codec_sbc_get_frequency, codec_sbc_decode);\r\n#endif\r\ng_slist_foreach(codec_plugins, register_codec_plugin, NULL);\r\n}\r\ncodec_handle_t\r\nfind_codec(const char *name)\r\n{\r\nreturn (registered_codecs) ? (codec_handle_t)g_hash_table_lookup(registered_codecs, name) : NULL;\r\n}\r\ngboolean\r\nregister_codec(const char *name, codec_init_fn init_fn, codec_release_fn release_fn,\r\ncodec_get_channels_fn channels_fn, codec_get_frequency_fn frequency_fn,\r\ncodec_decode_fn decode_fn)\r\n{\r\nstruct codec_handle *handle;\r\nif (registered_codecs == NULL)\r\nregistered_codecs = g_hash_table_new(g_str_hash, g_str_equal);\r\nif (g_hash_table_lookup(registered_codecs, name) != NULL)\r\nreturn FALSE;\r\nhandle = (struct codec_handle *)g_malloc(sizeof (struct codec_handle));\r\nhandle->name = name;\r\nhandle->init_fn = init_fn;\r\nhandle->release_fn = release_fn;\r\nhandle->channels_fn = channels_fn;\r\nhandle->frequency_fn = frequency_fn;\r\nhandle->decode_fn = decode_fn;\r\ng_hash_table_insert(registered_codecs, (gpointer)name, (gpointer) handle);\r\nreturn TRUE;\r\n}\r\nvoid *codec_init(codec_handle_t codec)\r\n{\r\nif (!codec) return NULL;\r\nreturn (codec->init_fn)();\r\n}\r\nvoid codec_release(codec_handle_t codec, void *context)\r\n{\r\nif (!codec) return;\r\n(codec->release_fn)(context);\r\n}\r\nint codec_get_channels(codec_handle_t codec, void *context)\r\n{\r\nif (!codec) return 0;\r\nreturn (codec->channels_fn)(context);\r\n}\r\nint codec_get_frequency(codec_handle_t codec, void *context)\r\n{\r\nif (!codec) return 0;\r\nreturn (codec->frequency_fn)(context);\r\n}\r\nint codec_decode(codec_handle_t codec, void *context, const void *input, int inputSizeBytes, void *output, int *outputSizeBytes)\r\n{\r\nif (!codec) return 0;\r\nreturn (codec->decode_fn)(context, input, inputSizeBytes, output, outputSizeBytes);\r\n}

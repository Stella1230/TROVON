static int\r\nradiusstat_packet(void *prs, packet_info *pinfo, epan_dissect_t *edt _U_, const void *pri)\r\n{\r\nradiusstat_t *rs=(radiusstat_t *)prs;\r\nconst radius_info_t *ri=(const radius_info_t *)pri;\r\nnstime_t delta;\r\nint ret = 0;\r\nswitch (ri->code) {\r\ncase RADIUS_PKT_TYPE_ACCESS_REQUEST:\r\ncase RADIUS_PKT_TYPE_ACCOUNTING_REQUEST:\r\ncase RADIUS_PKT_TYPE_PASSWORD_REQUEST:\r\ncase RADIUS_PKT_TYPE_RESOURCE_FREE_REQUEST:\r\ncase RADIUS_PKT_TYPE_RESOURCE_QUERY_REQUEST:\r\ncase RADIUS_PKT_TYPE_NAS_REBOOT_REQUEST:\r\ncase RADIUS_PKT_TYPE_EVENT_REQUEST:\r\ncase RADIUS_PKT_TYPE_DISCONNECT_REQUEST:\r\ncase RADIUS_PKT_TYPE_COA_REQUEST:\r\nif(ri->is_duplicate){\r\nrs->req_dup_num++;\r\n}\r\nelse {\r\nrs->open_req_num++;\r\n}\r\nbreak;\r\ncase RADIUS_PKT_TYPE_ACCESS_ACCEPT:\r\ncase RADIUS_PKT_TYPE_ACCESS_REJECT:\r\ncase RADIUS_PKT_TYPE_ACCOUNTING_RESPONSE:\r\ncase RADIUS_PKT_TYPE_PASSWORD_ACK:\r\ncase RADIUS_PKT_TYPE_PASSWORD_REJECT:\r\ncase RADIUS_PKT_TYPE_RESOURCE_FREE_RESPONSE:\r\ncase RADIUS_PKT_TYPE_RESOURCE_QUERY_RESPONSE:\r\ncase RADIUS_PKT_TYPE_NAS_REBOOT_RESPONSE:\r\ncase RADIUS_PKT_TYPE_EVENT_RESPONSE:\r\ncase RADIUS_PKT_TYPE_DISCONNECT_ACK:\r\ncase RADIUS_PKT_TYPE_DISCONNECT_NAK:\r\ncase RADIUS_PKT_TYPE_COA_ACK:\r\ncase RADIUS_PKT_TYPE_COA_NAK:\r\nif(ri->is_duplicate){\r\nrs->rsp_dup_num++;\r\n}\r\nelse if (!ri->request_available) {\r\nrs->disc_rsp_num++;\r\n}\r\nelse {\r\nrs->open_req_num--;\r\nnstime_delta(&delta, &pinfo->fd->abs_ts, &ri->req_time);\r\ntime_stat_update(&(rs->rtd[RADIUS_CAT_OVERALL]),&delta, pinfo);\r\nif (ri->code == RADIUS_PKT_TYPE_ACCESS_ACCEPT || ri->code == RADIUS_PKT_TYPE_ACCESS_REJECT) {\r\ntime_stat_update(&(rs->rtd[RADIUS_CAT_ACCESS]),&delta, pinfo);\r\n}\r\nelse if (ri->code == RADIUS_PKT_TYPE_ACCOUNTING_RESPONSE) {\r\ntime_stat_update(&(rs->rtd[RADIUS_CAT_ACCOUNTING]),&delta, pinfo);\r\n}\r\nelse {\r\ntime_stat_update(&(rs->rtd[RADIUS_CAT_OTHERS]),&delta, pinfo);\r\n}\r\nret = 1;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void\r\nradiusstat_draw(void *prs)\r\n{\r\nradiusstat_t *rs=(radiusstat_t *)prs;\r\nint i;\r\nprintf("\n");\r\nprintf("===========================================================================================================\n");\r\nprintf("RADIUS Response Time Delay (RTD) Statistics:\n");\r\nprintf("Filter for statistics: %s\n",rs->filter?rs->filter:"");\r\nprintf("Duplicate requests: %u\n",rs->req_dup_num);\r\nprintf("Duplicate responses: %u\n",rs->rsp_dup_num);\r\nprintf("Open requests: %u\n",rs->open_req_num);\r\nprintf("Discarded responses: %u\n",rs->disc_rsp_num);\r\nprintf("Type | Messages | Min RTD | Max RTD | Avg RTD | Min in Frame | Max in Frame |\n");\r\nfor(i=0;i<RADIUS_CAT_NUM_TIMESTATS;i++) {\r\nif(rs->rtd[i].num) {\r\nprintf("%s | %7u | %8.2f msec | %8.2f msec | %8.2f msec | %10u | %10u |\n",\r\nval_to_str(i,radius_message_code,"Other "),rs->rtd[i].num,\r\nnstime_to_msec(&(rs->rtd[i].min)), nstime_to_msec(&(rs->rtd[i].max)),\r\nget_average(&(rs->rtd[i].tot), rs->rtd[i].num),\r\nrs->rtd[i].min_num, rs->rtd[i].max_num\r\n);\r\n}\r\n}\r\nprintf("===========================================================================================================\n");\r\n}\r\nstatic void\r\nradiusstat_init(const char *opt_arg, void* userdata _U_)\r\n{\r\nradiusstat_t *rs;\r\nint i;\r\nGString *error_string;\r\nrs=g_new(radiusstat_t,1);\r\nif(!strncmp(opt_arg,"radius,rtd,",11)){\r\nrs->filter=g_strdup(opt_arg+11);\r\n} else {\r\nrs->filter=NULL;\r\n}\r\nfor(i=0;i<RADIUS_CAT_NUM_TIMESTATS;i++) {\r\nrs->rtd[i].num=0;\r\nrs->rtd[i].min_num=0;\r\nrs->rtd[i].max_num=0;\r\nrs->rtd[i].min.secs=0;\r\nrs->rtd[i].min.nsecs=0;\r\nrs->rtd[i].max.secs=0;\r\nrs->rtd[i].max.nsecs=0;\r\nrs->rtd[i].tot.secs=0;\r\nrs->rtd[i].tot.nsecs=0;\r\n}\r\nrs->open_req_num=0;\r\nrs->disc_rsp_num=0;\r\nrs->req_dup_num=0;\r\nrs->rsp_dup_num=0;\r\nerror_string=register_tap_listener("radius", rs, rs->filter, 0, NULL, radiusstat_packet, radiusstat_draw);\r\nif(error_string){\r\ng_free(rs->filter);\r\ng_free(rs);\r\nfprintf(stderr, "tshark: Couldn't register radius,rtd tap: %s\n",\r\nerror_string->str);\r\ng_string_free(error_string, TRUE);\r\nexit(1);\r\n}\r\n}\r\nvoid\r\nregister_tap_listener_radiusstat(void)\r\n{\r\nregister_stat_cmd_arg("radius,rtd", radiusstat_init, NULL);\r\n}

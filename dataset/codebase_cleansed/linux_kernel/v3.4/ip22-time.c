static unsigned long dosample(void)\r\n{\r\nu32 ct0, ct1;\r\nu8 msb;\r\nsgint->tcword = (SGINT_TCWORD_CNT2 | SGINT_TCWORD_CALL |\r\nSGINT_TCWORD_MRGEN);\r\nsgint->tcnt2 = SGINT_TCSAMP_COUNTER & 0xff;\r\nsgint->tcnt2 = SGINT_TCSAMP_COUNTER >> 8;\r\nct0 = read_c0_count();\r\ndo {\r\nwriteb(SGINT_TCWORD_CNT2 | SGINT_TCWORD_CLAT, &sgint->tcword);\r\n(void) readb(&sgint->tcnt2);\r\nmsb = readb(&sgint->tcnt2);\r\nct1 = read_c0_count();\r\n} while (msb);\r\nwriteb(SGINT_TCWORD_CNT2 | SGINT_TCWORD_CALL | SGINT_TCWORD_MSWST,\r\n&sgint->tcword);\r\nreturn (ct1 - ct0) / (500000/HZ) * (500000/HZ);\r\n}\r\n__init void plat_time_init(void)\r\n{\r\nunsigned long r4k_ticks[3];\r\nunsigned long r4k_tick;\r\nprintk(KERN_INFO "Calibrating system timer... ");\r\ndosample();\r\ndosample();\r\ndo {\r\nr4k_ticks[0] = dosample();\r\n} while (!r4k_ticks[0]);\r\ndo {\r\nr4k_ticks[1] = dosample();\r\n} while (!r4k_ticks[1]);\r\nif (r4k_ticks[0] != r4k_ticks[1]) {\r\nprintk("warning: timer counts differ, retrying... ");\r\nr4k_ticks[2] = dosample();\r\nif (r4k_ticks[2] == r4k_ticks[0]\r\n|| r4k_ticks[2] == r4k_ticks[1])\r\nr4k_tick = r4k_ticks[2];\r\nelse {\r\nprintk("disagreement, using average... ");\r\nr4k_tick = (r4k_ticks[0] + r4k_ticks[1]\r\n+ r4k_ticks[2]) / 3;\r\n}\r\n} else\r\nr4k_tick = r4k_ticks[0];\r\nprintk("%d [%d.%04d MHz CPU]\n", (int) r4k_tick,\r\n(int) (r4k_tick / (500000 / HZ)),\r\n(int) (r4k_tick % (500000 / HZ)));\r\nmips_hpt_frequency = r4k_tick * HZ;\r\nif (ip22_is_fullhouse())\r\nsetup_pit_timer();\r\n}\r\nvoid __irq_entry indy_8254timer_irq(void)\r\n{\r\nint irq = SGI_8254_0_IRQ;\r\nULONG cnt;\r\nchar c;\r\nirq_enter();\r\nkstat_incr_irqs_this_cpu(irq, irq_to_desc(irq));\r\nprintk(KERN_ALERT "Oops, got 8254 interrupt.\n");\r\nArcRead(0, &c, 1, &cnt);\r\nArcEnterInteractiveMode();\r\nirq_exit();\r\n}

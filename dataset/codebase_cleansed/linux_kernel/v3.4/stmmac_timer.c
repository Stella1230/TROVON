static void stmmac_timer_handler(void *data)\r\n{\r\nstruct net_device *dev = (struct net_device *)data;\r\nstmmac_schedule(dev);\r\n}\r\nstatic void stmmac_rtc_start(unsigned int new_freq)\r\n{\r\nrtc_irq_set_freq(stmmac_rtc, &stmmac_task, new_freq);\r\nrtc_irq_set_state(stmmac_rtc, &stmmac_task, 1);\r\n}\r\nstatic void stmmac_rtc_stop(void)\r\n{\r\nrtc_irq_set_state(stmmac_rtc, &stmmac_task, 0);\r\n}\r\nint stmmac_open_ext_timer(struct net_device *dev, struct stmmac_timer *tm)\r\n{\r\nstmmac_task.private_data = dev;\r\nstmmac_task.func = stmmac_timer_handler;\r\nstmmac_rtc = rtc_class_open(CONFIG_RTC_HCTOSYS_DEVICE);\r\nif (stmmac_rtc == NULL) {\r\npr_err("open rtc device failed\n");\r\nreturn -ENODEV;\r\n}\r\nrtc_irq_register(stmmac_rtc, &stmmac_task);\r\nif ((rtc_irq_set_freq(stmmac_rtc, &stmmac_task, tm->freq) < 0)) {\r\npr_err("set periodic failed\n");\r\nrtc_irq_unregister(stmmac_rtc, &stmmac_task);\r\nrtc_class_close(stmmac_rtc);\r\nreturn -1;\r\n}\r\nSTMMAC_TIMER_MSG(CONFIG_RTC_HCTOSYS_DEVICE, tm->freq);\r\ntm->timer_start = stmmac_rtc_start;\r\ntm->timer_stop = stmmac_rtc_stop;\r\nreturn 0;\r\n}\r\nint stmmac_close_ext_timer(void)\r\n{\r\nrtc_irq_set_state(stmmac_rtc, &stmmac_task, 0);\r\nrtc_irq_unregister(stmmac_rtc, &stmmac_task);\r\nrtc_class_close(stmmac_rtc);\r\nreturn 0;\r\n}\r\nstatic void stmmac_tmu_start(unsigned int new_freq)\r\n{\r\nclk_set_rate(timer_clock, new_freq);\r\nclk_enable(timer_clock);\r\n}\r\nstatic void stmmac_tmu_stop(void)\r\n{\r\nclk_disable(timer_clock);\r\n}\r\nint stmmac_open_ext_timer(struct net_device *dev, struct stmmac_timer *tm)\r\n{\r\ntimer_clock = clk_get(NULL, TMU_CHANNEL);\r\nif (timer_clock == NULL)\r\nreturn -1;\r\nif (tmu2_register_user(stmmac_timer_handler, (void *)dev) < 0) {\r\ntimer_clock = NULL;\r\nreturn -1;\r\n}\r\nSTMMAC_TIMER_MSG("TMU2", tm->freq);\r\ntm->timer_start = stmmac_tmu_start;\r\ntm->timer_stop = stmmac_tmu_stop;\r\nreturn 0;\r\n}\r\nint stmmac_close_ext_timer(void)\r\n{\r\nclk_disable(timer_clock);\r\ntmu2_unregister_user();\r\nclk_put(timer_clock);\r\nreturn 0;\r\n}

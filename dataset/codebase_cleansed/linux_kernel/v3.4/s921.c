static int s921_i2c_writereg(struct s921_state *state,\r\nu8 i2c_addr, int reg, int data)\r\n{\r\nu8 buf[] = { reg, data };\r\nstruct i2c_msg msg = {\r\n.addr = i2c_addr, .flags = 0, .buf = buf, .len = 2\r\n};\r\nint rc;\r\nrc = i2c_transfer(state->i2c, &msg, 1);\r\nif (rc != 1) {\r\nprintk("%s: writereg rcor(rc == %i, reg == 0x%02x,"\r\n" data == 0x%02x)\n", __func__, rc, reg, data);\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s921_i2c_writeregdata(struct s921_state *state, u8 i2c_addr,\r\nstruct regdata *rd, int size)\r\n{\r\nint i, rc;\r\nfor (i = 0; i < size; i++) {\r\nrc = s921_i2c_writereg(state, i2c_addr, rd[i].reg, rd[i].data);\r\nif (rc < 0)\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s921_i2c_readreg(struct s921_state *state, u8 i2c_addr, u8 reg)\r\n{\r\nu8 val;\r\nint rc;\r\nstruct i2c_msg msg[] = {\r\n{ .addr = i2c_addr, .flags = 0, .buf = &reg, .len = 1 },\r\n{ .addr = i2c_addr, .flags = I2C_M_RD, .buf = &val, .len = 1 }\r\n};\r\nrc = i2c_transfer(state->i2c, msg, 2);\r\nif (rc != 2) {\r\nrc("%s: reg=0x%x (rcor=%d)\n", __func__, reg, rc);\r\nreturn rc;\r\n}\r\nreturn val;\r\n}\r\nstatic int s921_pll_tune(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct s921_state *state = fe->demodulator_priv;\r\nint band, rc, i;\r\nunsigned long f_offset;\r\nu8 f_switch;\r\nu64 offset;\r\ndprintk("frequency=%i\n", p->frequency);\r\nfor (band = 0; band < ARRAY_SIZE(s921_bandselect); band++)\r\nif (p->frequency < s921_bandselect[band].freq_low)\r\nbreak;\r\nband--;\r\nif (band < 0) {\r\nrc("%s: frequency out of range\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nf_switch = s921_bandselect[band].band_reg;\r\noffset = ((u64)p->frequency) * 258;\r\ndo_div(offset, 6000000);\r\nf_offset = ((unsigned long)offset) + 2321;\r\nrc = s921_writeregdata(state, s921_prefreq);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = s921_writereg(state, 0xf2, (f_offset >> 8) & 0xff);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = s921_writereg(state, 0xf3, f_offset & 0xff);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = s921_writereg(state, 0xf4, f_switch);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = s921_writeregdata(state, s921_postfreq);\r\nif (rc < 0)\r\nreturn rc;\r\nfor (i = 0 ; i < 6; i++) {\r\nrc = s921_readreg(state, 0x80);\r\ndprintk("status 0x80: %02x\n", rc);\r\n}\r\nrc = s921_writereg(state, 0x01, 0x40);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = s921_readreg(state, 0x01);\r\ndprintk("status 0x01: %02x\n", rc);\r\nrc = s921_readreg(state, 0x80);\r\ndprintk("status 0x80: %02x\n", rc);\r\nrc = s921_readreg(state, 0x80);\r\ndprintk("status 0x80: %02x\n", rc);\r\nrc = s921_readreg(state, 0x32);\r\ndprintk("status 0x32: %02x\n", rc);\r\ndprintk("pll tune band=%d, pll=%d\n", f_switch, (int)f_offset);\r\nreturn 0;\r\n}\r\nstatic int s921_initfe(struct dvb_frontend *fe)\r\n{\r\nstruct s921_state *state = fe->demodulator_priv;\r\nint rc;\r\ndprintk("\n");\r\nrc = s921_writeregdata(state, s921_init);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn 0;\r\n}\r\nstatic int s921_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct s921_state *state = fe->demodulator_priv;\r\nint regstatus, rc;\r\n*status = 0;\r\nrc = s921_readreg(state, 0x81);\r\nif (rc < 0)\r\nreturn rc;\r\nregstatus = rc << 8;\r\nrc = s921_readreg(state, 0x82);\r\nif (rc < 0)\r\nreturn rc;\r\nregstatus |= rc;\r\ndprintk("status = %04x\n", regstatus);\r\nif ((regstatus & 0xff) == 0x40) {\r\n*status = FE_HAS_SIGNAL |\r\nFE_HAS_CARRIER |\r\nFE_HAS_VITERBI |\r\nFE_HAS_SYNC |\r\nFE_HAS_LOCK;\r\n} else if (regstatus & 0x40) {\r\n*status = FE_HAS_SIGNAL |\r\nFE_HAS_CARRIER |\r\nFE_HAS_VITERBI |\r\nFE_HAS_SYNC;\r\n}\r\nreturn 0;\r\n}\r\nstatic int s921_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nfe_status_t status;\r\nstruct s921_state *state = fe->demodulator_priv;\r\nint rc;\r\nrc = s921_read_status(fe, &status);\r\nif (rc < 0)\r\nreturn rc;\r\n*strength = (status & FE_HAS_LOCK) ? 0xffff : 0;\r\ndprintk("strength = 0x%04x\n", *strength);\r\nrc = s921_readreg(state, 0x01);\r\ndprintk("status 0x01: %02x\n", rc);\r\nrc = s921_readreg(state, 0x80);\r\ndprintk("status 0x80: %02x\n", rc);\r\nrc = s921_readreg(state, 0x32);\r\ndprintk("status 0x32: %02x\n", rc);\r\nreturn 0;\r\n}\r\nstatic int s921_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct s921_state *state = fe->demodulator_priv;\r\nint rc;\r\ndprintk("\n");\r\nrc = s921_pll_tune(fe);\r\nif (rc < 0)\r\nreturn rc;\r\nstate->currentfreq = p->frequency;\r\nreturn 0;\r\n}\r\nstatic int s921_get_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct s921_state *state = fe->demodulator_priv;\r\np->frequency = state->currentfreq;\r\np->delivery_system = SYS_ISDBT;\r\nreturn 0;\r\n}\r\nstatic int s921_tune(struct dvb_frontend *fe,\r\nbool re_tune,\r\nunsigned int mode_flags,\r\nunsigned int *delay,\r\nfe_status_t *status)\r\n{\r\nint rc = 0;\r\ndprintk("\n");\r\nif (re_tune)\r\nrc = s921_set_frontend(fe);\r\nif (!(mode_flags & FE_TUNE_MODE_ONESHOT))\r\ns921_read_status(fe, status);\r\nreturn rc;\r\n}\r\nstatic int s921_get_algo(struct dvb_frontend *fe)\r\n{\r\nreturn 1;\r\n}\r\nstatic void s921_release(struct dvb_frontend *fe)\r\n{\r\nstruct s921_state *state = fe->demodulator_priv;\r\ndprintk("\n");\r\nkfree(state);\r\n}\r\nstruct dvb_frontend *s921_attach(const struct s921_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct s921_state *state =\r\nkzalloc(sizeof(struct s921_state), GFP_KERNEL);\r\ndprintk("\n");\r\nif (state == NULL) {\r\nrc("Unable to kzalloc\n");\r\ngoto rcor;\r\n}\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nmemcpy(&state->frontend.ops, &s921_ops,\r\nsizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\nrcor:\r\nkfree(state);\r\nreturn NULL;\r\n}

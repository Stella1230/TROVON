void of_register_spi_devices(struct spi_master *master)\r\n{\r\nstruct spi_device *spi;\r\nstruct device_node *nc;\r\nconst __be32 *prop;\r\nint rc;\r\nint len;\r\nif (!master->dev.of_node)\r\nreturn;\r\nfor_each_child_of_node(master->dev.of_node, nc) {\r\nspi = spi_alloc_device(master);\r\nif (!spi) {\r\ndev_err(&master->dev, "spi_device alloc error for %s\n",\r\nnc->full_name);\r\nspi_dev_put(spi);\r\ncontinue;\r\n}\r\nif (of_modalias_node(nc, spi->modalias,\r\nsizeof(spi->modalias)) < 0) {\r\ndev_err(&master->dev, "cannot find modalias for %s\n",\r\nnc->full_name);\r\nspi_dev_put(spi);\r\ncontinue;\r\n}\r\nprop = of_get_property(nc, "reg", &len);\r\nif (!prop || len < sizeof(*prop)) {\r\ndev_err(&master->dev, "%s has no 'reg' property\n",\r\nnc->full_name);\r\nspi_dev_put(spi);\r\ncontinue;\r\n}\r\nspi->chip_select = be32_to_cpup(prop);\r\nif (of_find_property(nc, "spi-cpha", NULL))\r\nspi->mode |= SPI_CPHA;\r\nif (of_find_property(nc, "spi-cpol", NULL))\r\nspi->mode |= SPI_CPOL;\r\nif (of_find_property(nc, "spi-cs-high", NULL))\r\nspi->mode |= SPI_CS_HIGH;\r\nprop = of_get_property(nc, "spi-max-frequency", &len);\r\nif (!prop || len < sizeof(*prop)) {\r\ndev_err(&master->dev, "%s has no 'spi-max-frequency' property\n",\r\nnc->full_name);\r\nspi_dev_put(spi);\r\ncontinue;\r\n}\r\nspi->max_speed_hz = be32_to_cpup(prop);\r\nspi->irq = irq_of_parse_and_map(nc, 0);\r\nof_node_get(nc);\r\nspi->dev.of_node = nc;\r\nrequest_module(spi->modalias);\r\nrc = spi_add_device(spi);\r\nif (rc) {\r\ndev_err(&master->dev, "spi_device register error %s\n",\r\nnc->full_name);\r\nspi_dev_put(spi);\r\n}\r\n}\r\n}

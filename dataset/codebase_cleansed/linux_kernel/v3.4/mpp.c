static __init unsigned long mpp_ctrl_addr(unsigned int i,\r\nunsigned long dev_bus)\r\n{\r\nreturn dev_bus + (i) * 4;\r\n}\r\nvoid __init orion_mpp_conf(unsigned int *mpp_list, unsigned int variant_mask,\r\nunsigned int mpp_max, unsigned int dev_bus)\r\n{\r\nunsigned int mpp_nr_regs = (1 + mpp_max/8);\r\nu32 mpp_ctrl[mpp_nr_regs];\r\nint i;\r\nprintk(KERN_DEBUG "initial MPP regs:");\r\nfor (i = 0; i < mpp_nr_regs; i++) {\r\nmpp_ctrl[i] = readl(mpp_ctrl_addr(i, dev_bus));\r\nprintk(" %08x", mpp_ctrl[i]);\r\n}\r\nprintk("\n");\r\nfor ( ; *mpp_list; mpp_list++) {\r\nunsigned int num = MPP_NUM(*mpp_list);\r\nunsigned int sel = MPP_SEL(*mpp_list);\r\nint shift, gpio_mode;\r\nif (num > mpp_max) {\r\nprintk(KERN_ERR "orion_mpp_conf: invalid MPP "\r\n"number (%u)\n", num);\r\ncontinue;\r\n}\r\nif (variant_mask & !(*mpp_list & variant_mask)) {\r\nprintk(KERN_WARNING\r\n"orion_mpp_conf: requested MPP%u config "\r\n"unavailable on this hardware\n", num);\r\ncontinue;\r\n}\r\nshift = (num & 7) << 2;\r\nmpp_ctrl[num / 8] &= ~(0xf << shift);\r\nmpp_ctrl[num / 8] |= sel << shift;\r\ngpio_mode = 0;\r\nif (*mpp_list & MPP_INPUT_MASK)\r\ngpio_mode |= GPIO_INPUT_OK;\r\nif (*mpp_list & MPP_OUTPUT_MASK)\r\ngpio_mode |= GPIO_OUTPUT_OK;\r\norion_gpio_set_valid(num, gpio_mode);\r\n}\r\nprintk(KERN_DEBUG " final MPP regs:");\r\nfor (i = 0; i < mpp_nr_regs; i++) {\r\nwritel(mpp_ctrl[i], mpp_ctrl_addr(i, dev_bus));\r\nprintk(" %08x", mpp_ctrl[i]);\r\n}\r\nprintk("\n");\r\n}

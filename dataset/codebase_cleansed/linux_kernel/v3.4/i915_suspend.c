static bool i915_pipe_enabled(struct drm_device *dev, enum pipe pipe)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nu32 dpll_reg;\r\nif (pipe > 1)\r\nreturn false;\r\nif (HAS_PCH_SPLIT(dev))\r\ndpll_reg = PCH_DPLL(pipe);\r\nelse\r\ndpll_reg = (pipe == PIPE_A) ? _DPLL_A : _DPLL_B;\r\nreturn (I915_READ(dpll_reg) & DPLL_VCO_ENABLE);\r\n}\r\nstatic void i915_save_palette(struct drm_device *dev, enum pipe pipe)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nunsigned long reg = (pipe == PIPE_A ? _PALETTE_A : _PALETTE_B);\r\nu32 *array;\r\nint i;\r\nif (!i915_pipe_enabled(dev, pipe))\r\nreturn;\r\nif (HAS_PCH_SPLIT(dev))\r\nreg = (pipe == PIPE_A) ? _LGC_PALETTE_A : _LGC_PALETTE_B;\r\nif (pipe == PIPE_A)\r\narray = dev_priv->save_palette_a;\r\nelse\r\narray = dev_priv->save_palette_b;\r\nfor (i = 0; i < 256; i++)\r\narray[i] = I915_READ(reg + (i << 2));\r\n}\r\nstatic void i915_restore_palette(struct drm_device *dev, enum pipe pipe)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nunsigned long reg = (pipe == PIPE_A ? _PALETTE_A : _PALETTE_B);\r\nu32 *array;\r\nint i;\r\nif (!i915_pipe_enabled(dev, pipe))\r\nreturn;\r\nif (HAS_PCH_SPLIT(dev))\r\nreg = (pipe == PIPE_A) ? _LGC_PALETTE_A : _LGC_PALETTE_B;\r\nif (pipe == PIPE_A)\r\narray = dev_priv->save_palette_a;\r\nelse\r\narray = dev_priv->save_palette_b;\r\nfor (i = 0; i < 256; i++)\r\nI915_WRITE(reg + (i << 2), array[i]);\r\n}\r\nstatic u8 i915_read_indexed(struct drm_device *dev, u16 index_port, u16 data_port, u8 reg)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nI915_WRITE8(index_port, reg);\r\nreturn I915_READ8(data_port);\r\n}\r\nstatic u8 i915_read_ar(struct drm_device *dev, u16 st01, u8 reg, u16 palette_enable)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nI915_READ8(st01);\r\nI915_WRITE8(VGA_AR_INDEX, palette_enable | reg);\r\nreturn I915_READ8(VGA_AR_DATA_READ);\r\n}\r\nstatic void i915_write_ar(struct drm_device *dev, u16 st01, u8 reg, u8 val, u16 palette_enable)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nI915_READ8(st01);\r\nI915_WRITE8(VGA_AR_INDEX, palette_enable | reg);\r\nI915_WRITE8(VGA_AR_DATA_WRITE, val);\r\n}\r\nstatic void i915_write_indexed(struct drm_device *dev, u16 index_port, u16 data_port, u8 reg, u8 val)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nI915_WRITE8(index_port, reg);\r\nI915_WRITE8(data_port, val);\r\n}\r\nstatic void i915_save_vga(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\nu16 cr_index, cr_data, st01;\r\ndev_priv->saveDACMASK = I915_READ8(VGA_DACMASK);\r\ndev_priv->saveMSR = I915_READ8(VGA_MSR_READ);\r\nif (dev_priv->saveMSR & VGA_MSR_CGA_MODE) {\r\ncr_index = VGA_CR_INDEX_CGA;\r\ncr_data = VGA_CR_DATA_CGA;\r\nst01 = VGA_ST01_CGA;\r\n} else {\r\ncr_index = VGA_CR_INDEX_MDA;\r\ncr_data = VGA_CR_DATA_MDA;\r\nst01 = VGA_ST01_MDA;\r\n}\r\ni915_write_indexed(dev, cr_index, cr_data, 0x11,\r\ni915_read_indexed(dev, cr_index, cr_data, 0x11) &\r\n(~0x80));\r\nfor (i = 0; i <= 0x24; i++)\r\ndev_priv->saveCR[i] =\r\ni915_read_indexed(dev, cr_index, cr_data, i);\r\ndev_priv->saveCR[0x11] &= ~0x80;\r\nI915_READ8(st01);\r\ndev_priv->saveAR_INDEX = I915_READ8(VGA_AR_INDEX);\r\nfor (i = 0; i <= 0x14; i++)\r\ndev_priv->saveAR[i] = i915_read_ar(dev, st01, i, 0);\r\nI915_READ8(st01);\r\nI915_WRITE8(VGA_AR_INDEX, dev_priv->saveAR_INDEX);\r\nI915_READ8(st01);\r\nfor (i = 0; i < 9; i++)\r\ndev_priv->saveGR[i] =\r\ni915_read_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, i);\r\ndev_priv->saveGR[0x10] =\r\ni915_read_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, 0x10);\r\ndev_priv->saveGR[0x11] =\r\ni915_read_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, 0x11);\r\ndev_priv->saveGR[0x18] =\r\ni915_read_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, 0x18);\r\nfor (i = 0; i < 8; i++)\r\ndev_priv->saveSR[i] =\r\ni915_read_indexed(dev, VGA_SR_INDEX, VGA_SR_DATA, i);\r\n}\r\nstatic void i915_restore_vga(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\nu16 cr_index, cr_data, st01;\r\nI915_WRITE8(VGA_MSR_WRITE, dev_priv->saveMSR);\r\nif (dev_priv->saveMSR & VGA_MSR_CGA_MODE) {\r\ncr_index = VGA_CR_INDEX_CGA;\r\ncr_data = VGA_CR_DATA_CGA;\r\nst01 = VGA_ST01_CGA;\r\n} else {\r\ncr_index = VGA_CR_INDEX_MDA;\r\ncr_data = VGA_CR_DATA_MDA;\r\nst01 = VGA_ST01_MDA;\r\n}\r\nfor (i = 0; i < 7; i++)\r\ni915_write_indexed(dev, VGA_SR_INDEX, VGA_SR_DATA, i,\r\ndev_priv->saveSR[i]);\r\ni915_write_indexed(dev, cr_index, cr_data, 0x11, dev_priv->saveCR[0x11]);\r\nfor (i = 0; i <= 0x24; i++)\r\ni915_write_indexed(dev, cr_index, cr_data, i, dev_priv->saveCR[i]);\r\nfor (i = 0; i < 9; i++)\r\ni915_write_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, i,\r\ndev_priv->saveGR[i]);\r\ni915_write_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, 0x10,\r\ndev_priv->saveGR[0x10]);\r\ni915_write_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, 0x11,\r\ndev_priv->saveGR[0x11]);\r\ni915_write_indexed(dev, VGA_GR_INDEX, VGA_GR_DATA, 0x18,\r\ndev_priv->saveGR[0x18]);\r\nI915_READ8(st01);\r\nfor (i = 0; i <= 0x14; i++)\r\ni915_write_ar(dev, st01, i, dev_priv->saveAR[i], 0);\r\nI915_READ8(st01);\r\nI915_WRITE8(VGA_AR_INDEX, dev_priv->saveAR_INDEX | 0x20);\r\nI915_READ8(st01);\r\nI915_WRITE8(VGA_DACMASK, dev_priv->saveDACMASK);\r\n}\r\nstatic void i915_save_modeset_reg(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\nif (drm_core_check_feature(dev, DRIVER_MODESET))\r\nreturn;\r\ndev_priv->saveCURACNTR = I915_READ(_CURACNTR);\r\ndev_priv->saveCURAPOS = I915_READ(_CURAPOS);\r\ndev_priv->saveCURABASE = I915_READ(_CURABASE);\r\ndev_priv->saveCURBCNTR = I915_READ(_CURBCNTR);\r\ndev_priv->saveCURBPOS = I915_READ(_CURBPOS);\r\ndev_priv->saveCURBBASE = I915_READ(_CURBBASE);\r\nif (IS_GEN2(dev))\r\ndev_priv->saveCURSIZE = I915_READ(CURSIZE);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->savePCH_DREF_CONTROL = I915_READ(PCH_DREF_CONTROL);\r\ndev_priv->saveDISP_ARB_CTL = I915_READ(DISP_ARB_CTL);\r\n}\r\ndev_priv->savePIPEACONF = I915_READ(_PIPEACONF);\r\ndev_priv->savePIPEASRC = I915_READ(_PIPEASRC);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->saveFPA0 = I915_READ(_PCH_FPA0);\r\ndev_priv->saveFPA1 = I915_READ(_PCH_FPA1);\r\ndev_priv->saveDPLL_A = I915_READ(_PCH_DPLL_A);\r\n} else {\r\ndev_priv->saveFPA0 = I915_READ(_FPA0);\r\ndev_priv->saveFPA1 = I915_READ(_FPA1);\r\ndev_priv->saveDPLL_A = I915_READ(_DPLL_A);\r\n}\r\nif (INTEL_INFO(dev)->gen >= 4 && !HAS_PCH_SPLIT(dev))\r\ndev_priv->saveDPLL_A_MD = I915_READ(_DPLL_A_MD);\r\ndev_priv->saveHTOTAL_A = I915_READ(_HTOTAL_A);\r\ndev_priv->saveHBLANK_A = I915_READ(_HBLANK_A);\r\ndev_priv->saveHSYNC_A = I915_READ(_HSYNC_A);\r\ndev_priv->saveVTOTAL_A = I915_READ(_VTOTAL_A);\r\ndev_priv->saveVBLANK_A = I915_READ(_VBLANK_A);\r\ndev_priv->saveVSYNC_A = I915_READ(_VSYNC_A);\r\nif (!HAS_PCH_SPLIT(dev))\r\ndev_priv->saveBCLRPAT_A = I915_READ(_BCLRPAT_A);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->savePIPEA_DATA_M1 = I915_READ(_PIPEA_DATA_M1);\r\ndev_priv->savePIPEA_DATA_N1 = I915_READ(_PIPEA_DATA_N1);\r\ndev_priv->savePIPEA_LINK_M1 = I915_READ(_PIPEA_LINK_M1);\r\ndev_priv->savePIPEA_LINK_N1 = I915_READ(_PIPEA_LINK_N1);\r\ndev_priv->saveFDI_TXA_CTL = I915_READ(_FDI_TXA_CTL);\r\ndev_priv->saveFDI_RXA_CTL = I915_READ(_FDI_RXA_CTL);\r\ndev_priv->savePFA_CTL_1 = I915_READ(_PFA_CTL_1);\r\ndev_priv->savePFA_WIN_SZ = I915_READ(_PFA_WIN_SZ);\r\ndev_priv->savePFA_WIN_POS = I915_READ(_PFA_WIN_POS);\r\ndev_priv->saveTRANSACONF = I915_READ(_TRANSACONF);\r\ndev_priv->saveTRANS_HTOTAL_A = I915_READ(_TRANS_HTOTAL_A);\r\ndev_priv->saveTRANS_HBLANK_A = I915_READ(_TRANS_HBLANK_A);\r\ndev_priv->saveTRANS_HSYNC_A = I915_READ(_TRANS_HSYNC_A);\r\ndev_priv->saveTRANS_VTOTAL_A = I915_READ(_TRANS_VTOTAL_A);\r\ndev_priv->saveTRANS_VBLANK_A = I915_READ(_TRANS_VBLANK_A);\r\ndev_priv->saveTRANS_VSYNC_A = I915_READ(_TRANS_VSYNC_A);\r\n}\r\ndev_priv->saveDSPACNTR = I915_READ(_DSPACNTR);\r\ndev_priv->saveDSPASTRIDE = I915_READ(_DSPASTRIDE);\r\ndev_priv->saveDSPASIZE = I915_READ(_DSPASIZE);\r\ndev_priv->saveDSPAPOS = I915_READ(_DSPAPOS);\r\ndev_priv->saveDSPAADDR = I915_READ(_DSPAADDR);\r\nif (INTEL_INFO(dev)->gen >= 4) {\r\ndev_priv->saveDSPASURF = I915_READ(_DSPASURF);\r\ndev_priv->saveDSPATILEOFF = I915_READ(_DSPATILEOFF);\r\n}\r\ni915_save_palette(dev, PIPE_A);\r\ndev_priv->savePIPEASTAT = I915_READ(_PIPEASTAT);\r\ndev_priv->savePIPEBCONF = I915_READ(_PIPEBCONF);\r\ndev_priv->savePIPEBSRC = I915_READ(_PIPEBSRC);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->saveFPB0 = I915_READ(_PCH_FPB0);\r\ndev_priv->saveFPB1 = I915_READ(_PCH_FPB1);\r\ndev_priv->saveDPLL_B = I915_READ(_PCH_DPLL_B);\r\n} else {\r\ndev_priv->saveFPB0 = I915_READ(_FPB0);\r\ndev_priv->saveFPB1 = I915_READ(_FPB1);\r\ndev_priv->saveDPLL_B = I915_READ(_DPLL_B);\r\n}\r\nif (INTEL_INFO(dev)->gen >= 4 && !HAS_PCH_SPLIT(dev))\r\ndev_priv->saveDPLL_B_MD = I915_READ(_DPLL_B_MD);\r\ndev_priv->saveHTOTAL_B = I915_READ(_HTOTAL_B);\r\ndev_priv->saveHBLANK_B = I915_READ(_HBLANK_B);\r\ndev_priv->saveHSYNC_B = I915_READ(_HSYNC_B);\r\ndev_priv->saveVTOTAL_B = I915_READ(_VTOTAL_B);\r\ndev_priv->saveVBLANK_B = I915_READ(_VBLANK_B);\r\ndev_priv->saveVSYNC_B = I915_READ(_VSYNC_B);\r\nif (!HAS_PCH_SPLIT(dev))\r\ndev_priv->saveBCLRPAT_B = I915_READ(_BCLRPAT_B);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->savePIPEB_DATA_M1 = I915_READ(_PIPEB_DATA_M1);\r\ndev_priv->savePIPEB_DATA_N1 = I915_READ(_PIPEB_DATA_N1);\r\ndev_priv->savePIPEB_LINK_M1 = I915_READ(_PIPEB_LINK_M1);\r\ndev_priv->savePIPEB_LINK_N1 = I915_READ(_PIPEB_LINK_N1);\r\ndev_priv->saveFDI_TXB_CTL = I915_READ(_FDI_TXB_CTL);\r\ndev_priv->saveFDI_RXB_CTL = I915_READ(_FDI_RXB_CTL);\r\ndev_priv->savePFB_CTL_1 = I915_READ(_PFB_CTL_1);\r\ndev_priv->savePFB_WIN_SZ = I915_READ(_PFB_WIN_SZ);\r\ndev_priv->savePFB_WIN_POS = I915_READ(_PFB_WIN_POS);\r\ndev_priv->saveTRANSBCONF = I915_READ(_TRANSBCONF);\r\ndev_priv->saveTRANS_HTOTAL_B = I915_READ(_TRANS_HTOTAL_B);\r\ndev_priv->saveTRANS_HBLANK_B = I915_READ(_TRANS_HBLANK_B);\r\ndev_priv->saveTRANS_HSYNC_B = I915_READ(_TRANS_HSYNC_B);\r\ndev_priv->saveTRANS_VTOTAL_B = I915_READ(_TRANS_VTOTAL_B);\r\ndev_priv->saveTRANS_VBLANK_B = I915_READ(_TRANS_VBLANK_B);\r\ndev_priv->saveTRANS_VSYNC_B = I915_READ(_TRANS_VSYNC_B);\r\n}\r\ndev_priv->saveDSPBCNTR = I915_READ(_DSPBCNTR);\r\ndev_priv->saveDSPBSTRIDE = I915_READ(_DSPBSTRIDE);\r\ndev_priv->saveDSPBSIZE = I915_READ(_DSPBSIZE);\r\ndev_priv->saveDSPBPOS = I915_READ(_DSPBPOS);\r\ndev_priv->saveDSPBADDR = I915_READ(_DSPBADDR);\r\nif (INTEL_INFO(dev)->gen >= 4) {\r\ndev_priv->saveDSPBSURF = I915_READ(_DSPBSURF);\r\ndev_priv->saveDSPBTILEOFF = I915_READ(_DSPBTILEOFF);\r\n}\r\ni915_save_palette(dev, PIPE_B);\r\ndev_priv->savePIPEBSTAT = I915_READ(_PIPEBSTAT);\r\nswitch (INTEL_INFO(dev)->gen) {\r\ncase 7:\r\ncase 6:\r\nfor (i = 0; i < 16; i++)\r\ndev_priv->saveFENCE[i] = I915_READ64(FENCE_REG_SANDYBRIDGE_0 + (i * 8));\r\nbreak;\r\ncase 5:\r\ncase 4:\r\nfor (i = 0; i < 16; i++)\r\ndev_priv->saveFENCE[i] = I915_READ64(FENCE_REG_965_0 + (i * 8));\r\nbreak;\r\ncase 3:\r\nif (IS_I945G(dev) || IS_I945GM(dev) || IS_G33(dev))\r\nfor (i = 0; i < 8; i++)\r\ndev_priv->saveFENCE[i+8] = I915_READ(FENCE_REG_945_8 + (i * 4));\r\ncase 2:\r\nfor (i = 0; i < 8; i++)\r\ndev_priv->saveFENCE[i] = I915_READ(FENCE_REG_830_0 + (i * 4));\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nstatic void i915_restore_modeset_reg(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint dpll_a_reg, fpa0_reg, fpa1_reg;\r\nint dpll_b_reg, fpb0_reg, fpb1_reg;\r\nint i;\r\nif (drm_core_check_feature(dev, DRIVER_MODESET))\r\nreturn;\r\nswitch (INTEL_INFO(dev)->gen) {\r\ncase 7:\r\ncase 6:\r\nfor (i = 0; i < 16; i++)\r\nI915_WRITE64(FENCE_REG_SANDYBRIDGE_0 + (i * 8), dev_priv->saveFENCE[i]);\r\nbreak;\r\ncase 5:\r\ncase 4:\r\nfor (i = 0; i < 16; i++)\r\nI915_WRITE64(FENCE_REG_965_0 + (i * 8), dev_priv->saveFENCE[i]);\r\nbreak;\r\ncase 3:\r\ncase 2:\r\nif (IS_I945G(dev) || IS_I945GM(dev) || IS_G33(dev))\r\nfor (i = 0; i < 8; i++)\r\nI915_WRITE(FENCE_REG_945_8 + (i * 4), dev_priv->saveFENCE[i+8]);\r\nfor (i = 0; i < 8; i++)\r\nI915_WRITE(FENCE_REG_830_0 + (i * 4), dev_priv->saveFENCE[i]);\r\nbreak;\r\n}\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndpll_a_reg = _PCH_DPLL_A;\r\ndpll_b_reg = _PCH_DPLL_B;\r\nfpa0_reg = _PCH_FPA0;\r\nfpb0_reg = _PCH_FPB0;\r\nfpa1_reg = _PCH_FPA1;\r\nfpb1_reg = _PCH_FPB1;\r\n} else {\r\ndpll_a_reg = _DPLL_A;\r\ndpll_b_reg = _DPLL_B;\r\nfpa0_reg = _FPA0;\r\nfpb0_reg = _FPB0;\r\nfpa1_reg = _FPA1;\r\nfpb1_reg = _FPB1;\r\n}\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(PCH_DREF_CONTROL, dev_priv->savePCH_DREF_CONTROL);\r\nI915_WRITE(DISP_ARB_CTL, dev_priv->saveDISP_ARB_CTL);\r\n}\r\nif (dev_priv->saveDPLL_A & DPLL_VCO_ENABLE) {\r\nI915_WRITE(dpll_a_reg, dev_priv->saveDPLL_A &\r\n~DPLL_VCO_ENABLE);\r\nPOSTING_READ(dpll_a_reg);\r\nudelay(150);\r\n}\r\nI915_WRITE(fpa0_reg, dev_priv->saveFPA0);\r\nI915_WRITE(fpa1_reg, dev_priv->saveFPA1);\r\nI915_WRITE(dpll_a_reg, dev_priv->saveDPLL_A);\r\nPOSTING_READ(dpll_a_reg);\r\nudelay(150);\r\nif (INTEL_INFO(dev)->gen >= 4 && !HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(_DPLL_A_MD, dev_priv->saveDPLL_A_MD);\r\nPOSTING_READ(_DPLL_A_MD);\r\n}\r\nudelay(150);\r\nI915_WRITE(_HTOTAL_A, dev_priv->saveHTOTAL_A);\r\nI915_WRITE(_HBLANK_A, dev_priv->saveHBLANK_A);\r\nI915_WRITE(_HSYNC_A, dev_priv->saveHSYNC_A);\r\nI915_WRITE(_VTOTAL_A, dev_priv->saveVTOTAL_A);\r\nI915_WRITE(_VBLANK_A, dev_priv->saveVBLANK_A);\r\nI915_WRITE(_VSYNC_A, dev_priv->saveVSYNC_A);\r\nif (!HAS_PCH_SPLIT(dev))\r\nI915_WRITE(_BCLRPAT_A, dev_priv->saveBCLRPAT_A);\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(_PIPEA_DATA_M1, dev_priv->savePIPEA_DATA_M1);\r\nI915_WRITE(_PIPEA_DATA_N1, dev_priv->savePIPEA_DATA_N1);\r\nI915_WRITE(_PIPEA_LINK_M1, dev_priv->savePIPEA_LINK_M1);\r\nI915_WRITE(_PIPEA_LINK_N1, dev_priv->savePIPEA_LINK_N1);\r\nI915_WRITE(_FDI_RXA_CTL, dev_priv->saveFDI_RXA_CTL);\r\nI915_WRITE(_FDI_TXA_CTL, dev_priv->saveFDI_TXA_CTL);\r\nI915_WRITE(_PFA_CTL_1, dev_priv->savePFA_CTL_1);\r\nI915_WRITE(_PFA_WIN_SZ, dev_priv->savePFA_WIN_SZ);\r\nI915_WRITE(_PFA_WIN_POS, dev_priv->savePFA_WIN_POS);\r\nI915_WRITE(_TRANSACONF, dev_priv->saveTRANSACONF);\r\nI915_WRITE(_TRANS_HTOTAL_A, dev_priv->saveTRANS_HTOTAL_A);\r\nI915_WRITE(_TRANS_HBLANK_A, dev_priv->saveTRANS_HBLANK_A);\r\nI915_WRITE(_TRANS_HSYNC_A, dev_priv->saveTRANS_HSYNC_A);\r\nI915_WRITE(_TRANS_VTOTAL_A, dev_priv->saveTRANS_VTOTAL_A);\r\nI915_WRITE(_TRANS_VBLANK_A, dev_priv->saveTRANS_VBLANK_A);\r\nI915_WRITE(_TRANS_VSYNC_A, dev_priv->saveTRANS_VSYNC_A);\r\n}\r\nI915_WRITE(_DSPASIZE, dev_priv->saveDSPASIZE);\r\nI915_WRITE(_DSPAPOS, dev_priv->saveDSPAPOS);\r\nI915_WRITE(_PIPEASRC, dev_priv->savePIPEASRC);\r\nI915_WRITE(_DSPAADDR, dev_priv->saveDSPAADDR);\r\nI915_WRITE(_DSPASTRIDE, dev_priv->saveDSPASTRIDE);\r\nif (INTEL_INFO(dev)->gen >= 4) {\r\nI915_WRITE(_DSPASURF, dev_priv->saveDSPASURF);\r\nI915_WRITE(_DSPATILEOFF, dev_priv->saveDSPATILEOFF);\r\n}\r\nI915_WRITE(_PIPEACONF, dev_priv->savePIPEACONF);\r\ni915_restore_palette(dev, PIPE_A);\r\nI915_WRITE(_DSPACNTR, dev_priv->saveDSPACNTR);\r\nI915_WRITE(_DSPAADDR, I915_READ(_DSPAADDR));\r\nif (dev_priv->saveDPLL_B & DPLL_VCO_ENABLE) {\r\nI915_WRITE(dpll_b_reg, dev_priv->saveDPLL_B &\r\n~DPLL_VCO_ENABLE);\r\nPOSTING_READ(dpll_b_reg);\r\nudelay(150);\r\n}\r\nI915_WRITE(fpb0_reg, dev_priv->saveFPB0);\r\nI915_WRITE(fpb1_reg, dev_priv->saveFPB1);\r\nI915_WRITE(dpll_b_reg, dev_priv->saveDPLL_B);\r\nPOSTING_READ(dpll_b_reg);\r\nudelay(150);\r\nif (INTEL_INFO(dev)->gen >= 4 && !HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(_DPLL_B_MD, dev_priv->saveDPLL_B_MD);\r\nPOSTING_READ(_DPLL_B_MD);\r\n}\r\nudelay(150);\r\nI915_WRITE(_HTOTAL_B, dev_priv->saveHTOTAL_B);\r\nI915_WRITE(_HBLANK_B, dev_priv->saveHBLANK_B);\r\nI915_WRITE(_HSYNC_B, dev_priv->saveHSYNC_B);\r\nI915_WRITE(_VTOTAL_B, dev_priv->saveVTOTAL_B);\r\nI915_WRITE(_VBLANK_B, dev_priv->saveVBLANK_B);\r\nI915_WRITE(_VSYNC_B, dev_priv->saveVSYNC_B);\r\nif (!HAS_PCH_SPLIT(dev))\r\nI915_WRITE(_BCLRPAT_B, dev_priv->saveBCLRPAT_B);\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(_PIPEB_DATA_M1, dev_priv->savePIPEB_DATA_M1);\r\nI915_WRITE(_PIPEB_DATA_N1, dev_priv->savePIPEB_DATA_N1);\r\nI915_WRITE(_PIPEB_LINK_M1, dev_priv->savePIPEB_LINK_M1);\r\nI915_WRITE(_PIPEB_LINK_N1, dev_priv->savePIPEB_LINK_N1);\r\nI915_WRITE(_FDI_RXB_CTL, dev_priv->saveFDI_RXB_CTL);\r\nI915_WRITE(_FDI_TXB_CTL, dev_priv->saveFDI_TXB_CTL);\r\nI915_WRITE(_PFB_CTL_1, dev_priv->savePFB_CTL_1);\r\nI915_WRITE(_PFB_WIN_SZ, dev_priv->savePFB_WIN_SZ);\r\nI915_WRITE(_PFB_WIN_POS, dev_priv->savePFB_WIN_POS);\r\nI915_WRITE(_TRANSBCONF, dev_priv->saveTRANSBCONF);\r\nI915_WRITE(_TRANS_HTOTAL_B, dev_priv->saveTRANS_HTOTAL_B);\r\nI915_WRITE(_TRANS_HBLANK_B, dev_priv->saveTRANS_HBLANK_B);\r\nI915_WRITE(_TRANS_HSYNC_B, dev_priv->saveTRANS_HSYNC_B);\r\nI915_WRITE(_TRANS_VTOTAL_B, dev_priv->saveTRANS_VTOTAL_B);\r\nI915_WRITE(_TRANS_VBLANK_B, dev_priv->saveTRANS_VBLANK_B);\r\nI915_WRITE(_TRANS_VSYNC_B, dev_priv->saveTRANS_VSYNC_B);\r\n}\r\nI915_WRITE(_DSPBSIZE, dev_priv->saveDSPBSIZE);\r\nI915_WRITE(_DSPBPOS, dev_priv->saveDSPBPOS);\r\nI915_WRITE(_PIPEBSRC, dev_priv->savePIPEBSRC);\r\nI915_WRITE(_DSPBADDR, dev_priv->saveDSPBADDR);\r\nI915_WRITE(_DSPBSTRIDE, dev_priv->saveDSPBSTRIDE);\r\nif (INTEL_INFO(dev)->gen >= 4) {\r\nI915_WRITE(_DSPBSURF, dev_priv->saveDSPBSURF);\r\nI915_WRITE(_DSPBTILEOFF, dev_priv->saveDSPBTILEOFF);\r\n}\r\nI915_WRITE(_PIPEBCONF, dev_priv->savePIPEBCONF);\r\ni915_restore_palette(dev, PIPE_B);\r\nI915_WRITE(_DSPBCNTR, dev_priv->saveDSPBCNTR);\r\nI915_WRITE(_DSPBADDR, I915_READ(_DSPBADDR));\r\nI915_WRITE(_CURAPOS, dev_priv->saveCURAPOS);\r\nI915_WRITE(_CURACNTR, dev_priv->saveCURACNTR);\r\nI915_WRITE(_CURABASE, dev_priv->saveCURABASE);\r\nI915_WRITE(_CURBPOS, dev_priv->saveCURBPOS);\r\nI915_WRITE(_CURBCNTR, dev_priv->saveCURBCNTR);\r\nI915_WRITE(_CURBBASE, dev_priv->saveCURBBASE);\r\nif (IS_GEN2(dev))\r\nI915_WRITE(CURSIZE, dev_priv->saveCURSIZE);\r\nreturn;\r\n}\r\nstatic void i915_save_display(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\ndev_priv->saveDSPARB = I915_READ(DSPARB);\r\ni915_save_modeset_reg(dev);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->saveADPA = I915_READ(PCH_ADPA);\r\n} else {\r\ndev_priv->saveADPA = I915_READ(ADPA);\r\n}\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->savePP_CONTROL = I915_READ(PCH_PP_CONTROL);\r\ndev_priv->saveBLC_PWM_CTL = I915_READ(BLC_PWM_PCH_CTL1);\r\ndev_priv->saveBLC_PWM_CTL2 = I915_READ(BLC_PWM_PCH_CTL2);\r\ndev_priv->saveBLC_CPU_PWM_CTL = I915_READ(BLC_PWM_CPU_CTL);\r\ndev_priv->saveBLC_CPU_PWM_CTL2 = I915_READ(BLC_PWM_CPU_CTL2);\r\ndev_priv->saveLVDS = I915_READ(PCH_LVDS);\r\n} else {\r\ndev_priv->savePP_CONTROL = I915_READ(PP_CONTROL);\r\ndev_priv->savePFIT_PGM_RATIOS = I915_READ(PFIT_PGM_RATIOS);\r\ndev_priv->saveBLC_PWM_CTL = I915_READ(BLC_PWM_CTL);\r\ndev_priv->saveBLC_HIST_CTL = I915_READ(BLC_HIST_CTL);\r\nif (INTEL_INFO(dev)->gen >= 4)\r\ndev_priv->saveBLC_PWM_CTL2 = I915_READ(BLC_PWM_CTL2);\r\nif (IS_MOBILE(dev) && !IS_I830(dev))\r\ndev_priv->saveLVDS = I915_READ(LVDS);\r\n}\r\nif (!IS_I830(dev) && !IS_845G(dev) && !HAS_PCH_SPLIT(dev))\r\ndev_priv->savePFIT_CONTROL = I915_READ(PFIT_CONTROL);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->savePP_ON_DELAYS = I915_READ(PCH_PP_ON_DELAYS);\r\ndev_priv->savePP_OFF_DELAYS = I915_READ(PCH_PP_OFF_DELAYS);\r\ndev_priv->savePP_DIVISOR = I915_READ(PCH_PP_DIVISOR);\r\n} else {\r\ndev_priv->savePP_ON_DELAYS = I915_READ(PP_ON_DELAYS);\r\ndev_priv->savePP_OFF_DELAYS = I915_READ(PP_OFF_DELAYS);\r\ndev_priv->savePP_DIVISOR = I915_READ(PP_DIVISOR);\r\n}\r\nif (SUPPORTS_INTEGRATED_DP(dev)) {\r\ndev_priv->saveDP_B = I915_READ(DP_B);\r\ndev_priv->saveDP_C = I915_READ(DP_C);\r\ndev_priv->saveDP_D = I915_READ(DP_D);\r\ndev_priv->savePIPEA_GMCH_DATA_M = I915_READ(_PIPEA_GMCH_DATA_M);\r\ndev_priv->savePIPEB_GMCH_DATA_M = I915_READ(_PIPEB_GMCH_DATA_M);\r\ndev_priv->savePIPEA_GMCH_DATA_N = I915_READ(_PIPEA_GMCH_DATA_N);\r\ndev_priv->savePIPEB_GMCH_DATA_N = I915_READ(_PIPEB_GMCH_DATA_N);\r\ndev_priv->savePIPEA_DP_LINK_M = I915_READ(_PIPEA_DP_LINK_M);\r\ndev_priv->savePIPEB_DP_LINK_M = I915_READ(_PIPEB_DP_LINK_M);\r\ndev_priv->savePIPEA_DP_LINK_N = I915_READ(_PIPEA_DP_LINK_N);\r\ndev_priv->savePIPEB_DP_LINK_N = I915_READ(_PIPEB_DP_LINK_N);\r\n}\r\nif (I915_HAS_FBC(dev)) {\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->saveDPFC_CB_BASE = I915_READ(ILK_DPFC_CB_BASE);\r\n} else if (IS_GM45(dev)) {\r\ndev_priv->saveDPFC_CB_BASE = I915_READ(DPFC_CB_BASE);\r\n} else {\r\ndev_priv->saveFBC_CFB_BASE = I915_READ(FBC_CFB_BASE);\r\ndev_priv->saveFBC_LL_BASE = I915_READ(FBC_LL_BASE);\r\ndev_priv->saveFBC_CONTROL2 = I915_READ(FBC_CONTROL2);\r\ndev_priv->saveFBC_CONTROL = I915_READ(FBC_CONTROL);\r\n}\r\n}\r\ndev_priv->saveVGA0 = I915_READ(VGA0);\r\ndev_priv->saveVGA1 = I915_READ(VGA1);\r\ndev_priv->saveVGA_PD = I915_READ(VGA_PD);\r\nif (HAS_PCH_SPLIT(dev))\r\ndev_priv->saveVGACNTRL = I915_READ(CPU_VGACNTRL);\r\nelse\r\ndev_priv->saveVGACNTRL = I915_READ(VGACNTRL);\r\ni915_save_vga(dev);\r\n}\r\nstatic void i915_restore_display(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nI915_WRITE(DSPARB, dev_priv->saveDSPARB);\r\nif (SUPPORTS_INTEGRATED_DP(dev)) {\r\nI915_WRITE(_PIPEA_GMCH_DATA_M, dev_priv->savePIPEA_GMCH_DATA_M);\r\nI915_WRITE(_PIPEB_GMCH_DATA_M, dev_priv->savePIPEB_GMCH_DATA_M);\r\nI915_WRITE(_PIPEA_GMCH_DATA_N, dev_priv->savePIPEA_GMCH_DATA_N);\r\nI915_WRITE(_PIPEB_GMCH_DATA_N, dev_priv->savePIPEB_GMCH_DATA_N);\r\nI915_WRITE(_PIPEA_DP_LINK_M, dev_priv->savePIPEA_DP_LINK_M);\r\nI915_WRITE(_PIPEB_DP_LINK_M, dev_priv->savePIPEB_DP_LINK_M);\r\nI915_WRITE(_PIPEA_DP_LINK_N, dev_priv->savePIPEA_DP_LINK_N);\r\nI915_WRITE(_PIPEB_DP_LINK_N, dev_priv->savePIPEB_DP_LINK_N);\r\n}\r\ni915_restore_modeset_reg(dev);\r\nif (HAS_PCH_SPLIT(dev))\r\nI915_WRITE(PCH_ADPA, dev_priv->saveADPA);\r\nelse\r\nI915_WRITE(ADPA, dev_priv->saveADPA);\r\nif (INTEL_INFO(dev)->gen >= 4 && !HAS_PCH_SPLIT(dev))\r\nI915_WRITE(BLC_PWM_CTL2, dev_priv->saveBLC_PWM_CTL2);\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(PCH_LVDS, dev_priv->saveLVDS);\r\n} else if (IS_MOBILE(dev) && !IS_I830(dev))\r\nI915_WRITE(LVDS, dev_priv->saveLVDS);\r\nif (!IS_I830(dev) && !IS_845G(dev) && !HAS_PCH_SPLIT(dev))\r\nI915_WRITE(PFIT_CONTROL, dev_priv->savePFIT_CONTROL);\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(BLC_PWM_PCH_CTL1, dev_priv->saveBLC_PWM_CTL);\r\nI915_WRITE(BLC_PWM_PCH_CTL2, dev_priv->saveBLC_PWM_CTL2);\r\nI915_WRITE(BLC_PWM_CPU_CTL, dev_priv->saveBLC_CPU_PWM_CTL);\r\nI915_WRITE(BLC_PWM_CPU_CTL2, dev_priv->saveBLC_CPU_PWM_CTL2);\r\nI915_WRITE(PCH_PP_ON_DELAYS, dev_priv->savePP_ON_DELAYS);\r\nI915_WRITE(PCH_PP_OFF_DELAYS, dev_priv->savePP_OFF_DELAYS);\r\nI915_WRITE(PCH_PP_DIVISOR, dev_priv->savePP_DIVISOR);\r\nI915_WRITE(PCH_PP_CONTROL, dev_priv->savePP_CONTROL);\r\nI915_WRITE(RSTDBYCTL,\r\ndev_priv->saveMCHBAR_RENDER_STANDBY);\r\n} else {\r\nI915_WRITE(PFIT_PGM_RATIOS, dev_priv->savePFIT_PGM_RATIOS);\r\nI915_WRITE(BLC_PWM_CTL, dev_priv->saveBLC_PWM_CTL);\r\nI915_WRITE(BLC_HIST_CTL, dev_priv->saveBLC_HIST_CTL);\r\nI915_WRITE(PP_ON_DELAYS, dev_priv->savePP_ON_DELAYS);\r\nI915_WRITE(PP_OFF_DELAYS, dev_priv->savePP_OFF_DELAYS);\r\nI915_WRITE(PP_DIVISOR, dev_priv->savePP_DIVISOR);\r\nI915_WRITE(PP_CONTROL, dev_priv->savePP_CONTROL);\r\n}\r\nif (SUPPORTS_INTEGRATED_DP(dev)) {\r\nI915_WRITE(DP_B, dev_priv->saveDP_B);\r\nI915_WRITE(DP_C, dev_priv->saveDP_C);\r\nI915_WRITE(DP_D, dev_priv->saveDP_D);\r\n}\r\nintel_disable_fbc(dev);\r\nif (I915_HAS_FBC(dev)) {\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(ILK_DPFC_CB_BASE, dev_priv->saveDPFC_CB_BASE);\r\n} else if (IS_GM45(dev)) {\r\nI915_WRITE(DPFC_CB_BASE, dev_priv->saveDPFC_CB_BASE);\r\n} else {\r\nI915_WRITE(FBC_CFB_BASE, dev_priv->saveFBC_CFB_BASE);\r\nI915_WRITE(FBC_LL_BASE, dev_priv->saveFBC_LL_BASE);\r\nI915_WRITE(FBC_CONTROL2, dev_priv->saveFBC_CONTROL2);\r\nI915_WRITE(FBC_CONTROL, dev_priv->saveFBC_CONTROL);\r\n}\r\n}\r\nif (HAS_PCH_SPLIT(dev))\r\nI915_WRITE(CPU_VGACNTRL, dev_priv->saveVGACNTRL);\r\nelse\r\nI915_WRITE(VGACNTRL, dev_priv->saveVGACNTRL);\r\nI915_WRITE(VGA0, dev_priv->saveVGA0);\r\nI915_WRITE(VGA1, dev_priv->saveVGA1);\r\nI915_WRITE(VGA_PD, dev_priv->saveVGA_PD);\r\nPOSTING_READ(VGA_PD);\r\nudelay(150);\r\ni915_restore_vga(dev);\r\n}\r\nint i915_save_state(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\npci_read_config_byte(dev->pdev, LBB, &dev_priv->saveLBB);\r\nmutex_lock(&dev->struct_mutex);\r\ndev_priv->saveHWS = I915_READ(HWS_PGA);\r\ni915_save_display(dev);\r\nif (HAS_PCH_SPLIT(dev)) {\r\ndev_priv->saveDEIER = I915_READ(DEIER);\r\ndev_priv->saveDEIMR = I915_READ(DEIMR);\r\ndev_priv->saveGTIER = I915_READ(GTIER);\r\ndev_priv->saveGTIMR = I915_READ(GTIMR);\r\ndev_priv->saveFDI_RXA_IMR = I915_READ(_FDI_RXA_IMR);\r\ndev_priv->saveFDI_RXB_IMR = I915_READ(_FDI_RXB_IMR);\r\ndev_priv->saveMCHBAR_RENDER_STANDBY =\r\nI915_READ(RSTDBYCTL);\r\ndev_priv->savePCH_PORT_HOTPLUG = I915_READ(PCH_PORT_HOTPLUG);\r\n} else {\r\ndev_priv->saveIER = I915_READ(IER);\r\ndev_priv->saveIMR = I915_READ(IMR);\r\n}\r\nif (IS_IRONLAKE_M(dev))\r\nironlake_disable_drps(dev);\r\nif (INTEL_INFO(dev)->gen >= 6)\r\ngen6_disable_rps(dev);\r\ndev_priv->saveCACHE_MODE_0 = I915_READ(CACHE_MODE_0);\r\ndev_priv->saveMI_ARB_STATE = I915_READ(MI_ARB_STATE);\r\nfor (i = 0; i < 16; i++) {\r\ndev_priv->saveSWF0[i] = I915_READ(SWF00 + (i << 2));\r\ndev_priv->saveSWF1[i] = I915_READ(SWF10 + (i << 2));\r\n}\r\nfor (i = 0; i < 3; i++)\r\ndev_priv->saveSWF2[i] = I915_READ(SWF30 + (i << 2));\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn 0;\r\n}\r\nint i915_restore_state(struct drm_device *dev)\r\n{\r\nstruct drm_i915_private *dev_priv = dev->dev_private;\r\nint i;\r\npci_write_config_byte(dev->pdev, LBB, dev_priv->saveLBB);\r\nmutex_lock(&dev->struct_mutex);\r\nI915_WRITE(HWS_PGA, dev_priv->saveHWS);\r\ni915_restore_display(dev);\r\nif (HAS_PCH_SPLIT(dev)) {\r\nI915_WRITE(DEIER, dev_priv->saveDEIER);\r\nI915_WRITE(DEIMR, dev_priv->saveDEIMR);\r\nI915_WRITE(GTIER, dev_priv->saveGTIER);\r\nI915_WRITE(GTIMR, dev_priv->saveGTIMR);\r\nI915_WRITE(_FDI_RXA_IMR, dev_priv->saveFDI_RXA_IMR);\r\nI915_WRITE(_FDI_RXB_IMR, dev_priv->saveFDI_RXB_IMR);\r\nI915_WRITE(PCH_PORT_HOTPLUG, dev_priv->savePCH_PORT_HOTPLUG);\r\n} else {\r\nI915_WRITE(IER, dev_priv->saveIER);\r\nI915_WRITE(IMR, dev_priv->saveIMR);\r\n}\r\nmutex_unlock(&dev->struct_mutex);\r\nif (drm_core_check_feature(dev, DRIVER_MODESET))\r\nintel_init_clock_gating(dev);\r\nif (IS_IRONLAKE_M(dev)) {\r\nironlake_enable_drps(dev);\r\nintel_init_emon(dev);\r\n}\r\nif (INTEL_INFO(dev)->gen >= 6) {\r\ngen6_enable_rps(dev_priv);\r\ngen6_update_ring_freq(dev_priv);\r\n}\r\nmutex_lock(&dev->struct_mutex);\r\nI915_WRITE(CACHE_MODE_0, dev_priv->saveCACHE_MODE_0 | 0xffff0000);\r\nI915_WRITE(MI_ARB_STATE, dev_priv->saveMI_ARB_STATE | 0xffff0000);\r\nfor (i = 0; i < 16; i++) {\r\nI915_WRITE(SWF00 + (i << 2), dev_priv->saveSWF0[i]);\r\nI915_WRITE(SWF10 + (i << 2), dev_priv->saveSWF1[i]);\r\n}\r\nfor (i = 0; i < 3; i++)\r\nI915_WRITE(SWF30 + (i << 2), dev_priv->saveSWF2[i]);\r\nmutex_unlock(&dev->struct_mutex);\r\nintel_i2c_reset(dev);\r\nreturn 0;\r\n}

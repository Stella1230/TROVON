static inline\r\nstruct ssb_ohci_device *hcd_to_ssb_ohci(struct usb_hcd *hcd)\r\n{\r\nreturn (struct ssb_ohci_device *)(hcd->hcd_priv);\r\n}\r\nstatic int ssb_ohci_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ssb_ohci_device *ohcidev = hcd_to_ssb_ohci(hcd);\r\nstruct ohci_hcd *ohci = &ohcidev->ohci;\r\nint err;\r\nohci_hcd_init(ohci);\r\nerr = ohci_init(ohci);\r\nreturn err;\r\n}\r\nstatic int ssb_ohci_start(struct usb_hcd *hcd)\r\n{\r\nstruct ssb_ohci_device *ohcidev = hcd_to_ssb_ohci(hcd);\r\nstruct ohci_hcd *ohci = &ohcidev->ohci;\r\nint err;\r\nerr = ohci_run(ohci);\r\nif (err < 0) {\r\nohci_err(ohci, "can't start\n");\r\nohci_stop(hcd);\r\n}\r\nreturn err;\r\n}\r\nstatic void ssb_ohci_detach(struct ssb_device *dev)\r\n{\r\nstruct usb_hcd *hcd = ssb_get_drvdata(dev);\r\nif (hcd->driver->shutdown)\r\nhcd->driver->shutdown(hcd);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nssb_device_disable(dev, 0);\r\n}\r\nstatic int ssb_ohci_attach(struct ssb_device *dev)\r\n{\r\nstruct ssb_ohci_device *ohcidev;\r\nstruct usb_hcd *hcd;\r\nint err = -ENOMEM;\r\nu32 tmp, flags = 0;\r\nif (dma_set_mask(dev->dma_dev, DMA_BIT_MASK(32)) ||\r\ndma_set_coherent_mask(dev->dma_dev, DMA_BIT_MASK(32)))\r\nreturn -EOPNOTSUPP;\r\nif (dev->id.coreid == SSB_DEV_USB11_HOSTDEV) {\r\nflags |= SSB_OHCI_TMSLOW_HOSTMODE;\r\nssb_device_enable(dev, flags);\r\n} else if (dev->id.coreid == SSB_DEV_USB20_HOST) {\r\nssb_device_enable(dev, 0);\r\nssb_write32(dev, 0x200, 0x7ff);\r\ntmp = ssb_read32(dev, 0x400);\r\ntmp &= ~8;\r\nssb_write32(dev, 0x400, tmp);\r\ntmp = ssb_read32(dev, 0x400);\r\ntmp = ssb_read32(dev, 0x304);\r\ntmp &= ~0x100;\r\nssb_write32(dev, 0x304, tmp);\r\ntmp = ssb_read32(dev, 0x304);\r\nudelay(1);\r\nif (dev->id.revision == 2 && dev->bus->chip_id == 0x5354) {\r\ntmp = 0x00fe00fe;\r\nssb_write32(dev, 0x894, tmp);\r\ntmp = ssb_read32(dev, 0x89c);\r\ntmp |= 0x1;\r\nssb_write32(dev, 0x89c, tmp);\r\n}\r\n} else\r\nssb_device_enable(dev, 0);\r\nhcd = usb_create_hcd(&ssb_ohci_hc_driver, dev->dev,\r\ndev_name(dev->dev));\r\nif (!hcd)\r\ngoto err_dev_disable;\r\nohcidev = hcd_to_ssb_ohci(hcd);\r\nohcidev->enable_flags = flags;\r\ntmp = ssb_read32(dev, SSB_ADMATCH0);\r\nhcd->rsrc_start = ssb_admatch_base(tmp);\r\nhcd->rsrc_len = ssb_admatch_size(tmp);\r\nhcd->regs = ioremap_nocache(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs)\r\ngoto err_put_hcd;\r\nerr = usb_add_hcd(hcd, dev->irq, IRQF_SHARED);\r\nif (err)\r\ngoto err_iounmap;\r\nssb_set_drvdata(dev, hcd);\r\nreturn err;\r\nerr_iounmap:\r\niounmap(hcd->regs);\r\nerr_put_hcd:\r\nusb_put_hcd(hcd);\r\nerr_dev_disable:\r\nssb_device_disable(dev, flags);\r\nreturn err;\r\n}\r\nstatic int ssb_ohci_probe(struct ssb_device *dev,\r\nconst struct ssb_device_id *id)\r\n{\r\nint err;\r\nu16 chipid_top;\r\nchipid_top = (dev->bus->chip_id & 0xFF00);\r\nif (chipid_top != 0x4700 && chipid_top != 0x5300)\r\nreturn -ENODEV;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nerr = ssb_ohci_attach(dev);\r\nreturn err;\r\n}\r\nstatic void ssb_ohci_remove(struct ssb_device *dev)\r\n{\r\nssb_ohci_detach(dev);\r\n}\r\nstatic int ssb_ohci_suspend(struct ssb_device *dev, pm_message_t state)\r\n{\r\nssb_device_disable(dev, 0);\r\nreturn 0;\r\n}\r\nstatic int ssb_ohci_resume(struct ssb_device *dev)\r\n{\r\nstruct usb_hcd *hcd = ssb_get_drvdata(dev);\r\nstruct ssb_ohci_device *ohcidev = hcd_to_ssb_ohci(hcd);\r\nssb_device_enable(dev, ohcidev->enable_flags);\r\nohci_finish_controller_resume(hcd);\r\nreturn 0;\r\n}

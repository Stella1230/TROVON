int\r\nnv20_graph_unload_context(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nstruct nouveau_channel *chan;\r\nstruct nouveau_gpuobj *grctx;\r\nu32 tmp;\r\nchan = nv10_graph_channel(dev);\r\nif (!chan)\r\nreturn 0;\r\ngrctx = chan->engctx[NVOBJ_ENGINE_GR];\r\nnv_wr32(dev, NV20_PGRAPH_CHANNEL_CTX_POINTER, grctx->pinst >> 4);\r\nnv_wr32(dev, NV20_PGRAPH_CHANNEL_CTX_XFER,\r\nNV20_PGRAPH_CHANNEL_CTX_XFER_SAVE);\r\nnouveau_wait_for_idle(dev);\r\nnv_wr32(dev, NV10_PGRAPH_CTX_CONTROL, 0x10000000);\r\ntmp = nv_rd32(dev, NV10_PGRAPH_CTX_USER) & 0x00ffffff;\r\ntmp |= (pfifo->channels - 1) << 24;\r\nnv_wr32(dev, NV10_PGRAPH_CTX_USER, tmp);\r\nreturn 0;\r\n}\r\nstatic void\r\nnv20_graph_rdi(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nint i, writecount = 32;\r\nuint32_t rdi_index = 0x2c80000;\r\nif (dev_priv->chipset == 0x20) {\r\nrdi_index = 0x3d0000;\r\nwritecount = 15;\r\n}\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, rdi_index);\r\nfor (i = 0; i < writecount; i++)\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA, 0);\r\nnouveau_wait_for_idle(dev);\r\n}\r\nstatic void\r\nnv20_graph_context_init(struct nouveau_gpuobj *ctx)\r\n{\r\nint i;\r\nnv_wo32(ctx, 0x033c, 0xffff0000);\r\nnv_wo32(ctx, 0x03a0, 0x0fff0000);\r\nnv_wo32(ctx, 0x03a4, 0x0fff0000);\r\nnv_wo32(ctx, 0x047c, 0x00000101);\r\nnv_wo32(ctx, 0x0490, 0x00000111);\r\nnv_wo32(ctx, 0x04a8, 0x44400000);\r\nfor (i = 0x04d4; i <= 0x04e0; i += 4)\r\nnv_wo32(ctx, i, 0x00030303);\r\nfor (i = 0x04f4; i <= 0x0500; i += 4)\r\nnv_wo32(ctx, i, 0x00080000);\r\nfor (i = 0x050c; i <= 0x0518; i += 4)\r\nnv_wo32(ctx, i, 0x01012000);\r\nfor (i = 0x051c; i <= 0x0528; i += 4)\r\nnv_wo32(ctx, i, 0x000105b8);\r\nfor (i = 0x052c; i <= 0x0538; i += 4)\r\nnv_wo32(ctx, i, 0x00080008);\r\nfor (i = 0x055c; i <= 0x0598; i += 4)\r\nnv_wo32(ctx, i, 0x07ff0000);\r\nnv_wo32(ctx, 0x05a4, 0x4b7fffff);\r\nnv_wo32(ctx, 0x05fc, 0x00000001);\r\nnv_wo32(ctx, 0x0604, 0x00004000);\r\nnv_wo32(ctx, 0x0610, 0x00000001);\r\nnv_wo32(ctx, 0x0618, 0x00040000);\r\nnv_wo32(ctx, 0x061c, 0x00010000);\r\nfor (i = 0x1c1c; i <= 0x248c; i += 16) {\r\nnv_wo32(ctx, (i + 0), 0x10700ff9);\r\nnv_wo32(ctx, (i + 4), 0x0436086c);\r\nnv_wo32(ctx, (i + 8), 0x000c001b);\r\n}\r\nnv_wo32(ctx, 0x281c, 0x3f800000);\r\nnv_wo32(ctx, 0x2830, 0x3f800000);\r\nnv_wo32(ctx, 0x285c, 0x40000000);\r\nnv_wo32(ctx, 0x2860, 0x3f800000);\r\nnv_wo32(ctx, 0x2864, 0x3f000000);\r\nnv_wo32(ctx, 0x286c, 0x40000000);\r\nnv_wo32(ctx, 0x2870, 0x3f800000);\r\nnv_wo32(ctx, 0x2878, 0xbf800000);\r\nnv_wo32(ctx, 0x2880, 0xbf800000);\r\nnv_wo32(ctx, 0x34a4, 0x000fe000);\r\nnv_wo32(ctx, 0x3530, 0x000003f8);\r\nnv_wo32(ctx, 0x3540, 0x002fe000);\r\nfor (i = 0x355c; i <= 0x3578; i += 4)\r\nnv_wo32(ctx, i, 0x001c527c);\r\n}\r\nstatic void\r\nnv25_graph_context_init(struct nouveau_gpuobj *ctx)\r\n{\r\nint i;\r\nnv_wo32(ctx, 0x035c, 0xffff0000);\r\nnv_wo32(ctx, 0x03c0, 0x0fff0000);\r\nnv_wo32(ctx, 0x03c4, 0x0fff0000);\r\nnv_wo32(ctx, 0x049c, 0x00000101);\r\nnv_wo32(ctx, 0x04b0, 0x00000111);\r\nnv_wo32(ctx, 0x04c8, 0x00000080);\r\nnv_wo32(ctx, 0x04cc, 0xffff0000);\r\nnv_wo32(ctx, 0x04d0, 0x00000001);\r\nnv_wo32(ctx, 0x04e4, 0x44400000);\r\nnv_wo32(ctx, 0x04fc, 0x4b800000);\r\nfor (i = 0x0510; i <= 0x051c; i += 4)\r\nnv_wo32(ctx, i, 0x00030303);\r\nfor (i = 0x0530; i <= 0x053c; i += 4)\r\nnv_wo32(ctx, i, 0x00080000);\r\nfor (i = 0x0548; i <= 0x0554; i += 4)\r\nnv_wo32(ctx, i, 0x01012000);\r\nfor (i = 0x0558; i <= 0x0564; i += 4)\r\nnv_wo32(ctx, i, 0x000105b8);\r\nfor (i = 0x0568; i <= 0x0574; i += 4)\r\nnv_wo32(ctx, i, 0x00080008);\r\nfor (i = 0x0598; i <= 0x05d4; i += 4)\r\nnv_wo32(ctx, i, 0x07ff0000);\r\nnv_wo32(ctx, 0x05e0, 0x4b7fffff);\r\nnv_wo32(ctx, 0x0620, 0x00000080);\r\nnv_wo32(ctx, 0x0624, 0x30201000);\r\nnv_wo32(ctx, 0x0628, 0x70605040);\r\nnv_wo32(ctx, 0x062c, 0xb0a09080);\r\nnv_wo32(ctx, 0x0630, 0xf0e0d0c0);\r\nnv_wo32(ctx, 0x0664, 0x00000001);\r\nnv_wo32(ctx, 0x066c, 0x00004000);\r\nnv_wo32(ctx, 0x0678, 0x00000001);\r\nnv_wo32(ctx, 0x0680, 0x00040000);\r\nnv_wo32(ctx, 0x0684, 0x00010000);\r\nfor (i = 0x1b04; i <= 0x2374; i += 16) {\r\nnv_wo32(ctx, (i + 0), 0x10700ff9);\r\nnv_wo32(ctx, (i + 4), 0x0436086c);\r\nnv_wo32(ctx, (i + 8), 0x000c001b);\r\n}\r\nnv_wo32(ctx, 0x2704, 0x3f800000);\r\nnv_wo32(ctx, 0x2718, 0x3f800000);\r\nnv_wo32(ctx, 0x2744, 0x40000000);\r\nnv_wo32(ctx, 0x2748, 0x3f800000);\r\nnv_wo32(ctx, 0x274c, 0x3f000000);\r\nnv_wo32(ctx, 0x2754, 0x40000000);\r\nnv_wo32(ctx, 0x2758, 0x3f800000);\r\nnv_wo32(ctx, 0x2760, 0xbf800000);\r\nnv_wo32(ctx, 0x2768, 0xbf800000);\r\nnv_wo32(ctx, 0x308c, 0x000fe000);\r\nnv_wo32(ctx, 0x3108, 0x000003f8);\r\nnv_wo32(ctx, 0x3468, 0x002fe000);\r\nfor (i = 0x3484; i <= 0x34a0; i += 4)\r\nnv_wo32(ctx, i, 0x001c527c);\r\n}\r\nstatic void\r\nnv2a_graph_context_init(struct nouveau_gpuobj *ctx)\r\n{\r\nint i;\r\nnv_wo32(ctx, 0x033c, 0xffff0000);\r\nnv_wo32(ctx, 0x03a0, 0x0fff0000);\r\nnv_wo32(ctx, 0x03a4, 0x0fff0000);\r\nnv_wo32(ctx, 0x047c, 0x00000101);\r\nnv_wo32(ctx, 0x0490, 0x00000111);\r\nnv_wo32(ctx, 0x04a8, 0x44400000);\r\nfor (i = 0x04d4; i <= 0x04e0; i += 4)\r\nnv_wo32(ctx, i, 0x00030303);\r\nfor (i = 0x04f4; i <= 0x0500; i += 4)\r\nnv_wo32(ctx, i, 0x00080000);\r\nfor (i = 0x050c; i <= 0x0518; i += 4)\r\nnv_wo32(ctx, i, 0x01012000);\r\nfor (i = 0x051c; i <= 0x0528; i += 4)\r\nnv_wo32(ctx, i, 0x000105b8);\r\nfor (i = 0x052c; i <= 0x0538; i += 4)\r\nnv_wo32(ctx, i, 0x00080008);\r\nfor (i = 0x055c; i <= 0x0598; i += 4)\r\nnv_wo32(ctx, i, 0x07ff0000);\r\nnv_wo32(ctx, 0x05a4, 0x4b7fffff);\r\nnv_wo32(ctx, 0x05fc, 0x00000001);\r\nnv_wo32(ctx, 0x0604, 0x00004000);\r\nnv_wo32(ctx, 0x0610, 0x00000001);\r\nnv_wo32(ctx, 0x0618, 0x00040000);\r\nnv_wo32(ctx, 0x061c, 0x00010000);\r\nfor (i = 0x1a9c; i <= 0x22fc; i += 16) {\r\nnv_wo32(ctx, (i + 0), 0x10700ff9);\r\nnv_wo32(ctx, (i + 4), 0x0436086c);\r\nnv_wo32(ctx, (i + 8), 0x000c001b);\r\n}\r\nnv_wo32(ctx, 0x269c, 0x3f800000);\r\nnv_wo32(ctx, 0x26b0, 0x3f800000);\r\nnv_wo32(ctx, 0x26dc, 0x40000000);\r\nnv_wo32(ctx, 0x26e0, 0x3f800000);\r\nnv_wo32(ctx, 0x26e4, 0x3f000000);\r\nnv_wo32(ctx, 0x26ec, 0x40000000);\r\nnv_wo32(ctx, 0x26f0, 0x3f800000);\r\nnv_wo32(ctx, 0x26f8, 0xbf800000);\r\nnv_wo32(ctx, 0x2700, 0xbf800000);\r\nnv_wo32(ctx, 0x3024, 0x000fe000);\r\nnv_wo32(ctx, 0x30a0, 0x000003f8);\r\nnv_wo32(ctx, 0x33fc, 0x002fe000);\r\nfor (i = 0x341c; i <= 0x3438; i += 4)\r\nnv_wo32(ctx, i, 0x001c527c);\r\n}\r\nstatic void\r\nnv30_31_graph_context_init(struct nouveau_gpuobj *ctx)\r\n{\r\nint i;\r\nnv_wo32(ctx, 0x0410, 0x00000101);\r\nnv_wo32(ctx, 0x0424, 0x00000111);\r\nnv_wo32(ctx, 0x0428, 0x00000060);\r\nnv_wo32(ctx, 0x0444, 0x00000080);\r\nnv_wo32(ctx, 0x0448, 0xffff0000);\r\nnv_wo32(ctx, 0x044c, 0x00000001);\r\nnv_wo32(ctx, 0x0460, 0x44400000);\r\nnv_wo32(ctx, 0x048c, 0xffff0000);\r\nfor (i = 0x04e0; i < 0x04e8; i += 4)\r\nnv_wo32(ctx, i, 0x0fff0000);\r\nnv_wo32(ctx, 0x04ec, 0x00011100);\r\nfor (i = 0x0508; i < 0x0548; i += 4)\r\nnv_wo32(ctx, i, 0x07ff0000);\r\nnv_wo32(ctx, 0x0550, 0x4b7fffff);\r\nnv_wo32(ctx, 0x058c, 0x00000080);\r\nnv_wo32(ctx, 0x0590, 0x30201000);\r\nnv_wo32(ctx, 0x0594, 0x70605040);\r\nnv_wo32(ctx, 0x0598, 0xb8a89888);\r\nnv_wo32(ctx, 0x059c, 0xf8e8d8c8);\r\nnv_wo32(ctx, 0x05b0, 0xb0000000);\r\nfor (i = 0x0600; i < 0x0640; i += 4)\r\nnv_wo32(ctx, i, 0x00010588);\r\nfor (i = 0x0640; i < 0x0680; i += 4)\r\nnv_wo32(ctx, i, 0x00030303);\r\nfor (i = 0x06c0; i < 0x0700; i += 4)\r\nnv_wo32(ctx, i, 0x0008aae4);\r\nfor (i = 0x0700; i < 0x0740; i += 4)\r\nnv_wo32(ctx, i, 0x01012000);\r\nfor (i = 0x0740; i < 0x0780; i += 4)\r\nnv_wo32(ctx, i, 0x00080008);\r\nnv_wo32(ctx, 0x085c, 0x00040000);\r\nnv_wo32(ctx, 0x0860, 0x00010000);\r\nfor (i = 0x0864; i < 0x0874; i += 4)\r\nnv_wo32(ctx, i, 0x00040004);\r\nfor (i = 0x1f18; i <= 0x3088 ; i += 16) {\r\nnv_wo32(ctx, i + 0, 0x10700ff9);\r\nnv_wo32(ctx, i + 1, 0x0436086c);\r\nnv_wo32(ctx, i + 2, 0x000c001b);\r\n}\r\nfor (i = 0x30b8; i < 0x30c8; i += 4)\r\nnv_wo32(ctx, i, 0x0000ffff);\r\nnv_wo32(ctx, 0x344c, 0x3f800000);\r\nnv_wo32(ctx, 0x3808, 0x3f800000);\r\nnv_wo32(ctx, 0x381c, 0x3f800000);\r\nnv_wo32(ctx, 0x3848, 0x40000000);\r\nnv_wo32(ctx, 0x384c, 0x3f800000);\r\nnv_wo32(ctx, 0x3850, 0x3f000000);\r\nnv_wo32(ctx, 0x3858, 0x40000000);\r\nnv_wo32(ctx, 0x385c, 0x3f800000);\r\nnv_wo32(ctx, 0x3864, 0xbf800000);\r\nnv_wo32(ctx, 0x386c, 0xbf800000);\r\n}\r\nstatic void\r\nnv34_graph_context_init(struct nouveau_gpuobj *ctx)\r\n{\r\nint i;\r\nnv_wo32(ctx, 0x040c, 0x01000101);\r\nnv_wo32(ctx, 0x0420, 0x00000111);\r\nnv_wo32(ctx, 0x0424, 0x00000060);\r\nnv_wo32(ctx, 0x0440, 0x00000080);\r\nnv_wo32(ctx, 0x0444, 0xffff0000);\r\nnv_wo32(ctx, 0x0448, 0x00000001);\r\nnv_wo32(ctx, 0x045c, 0x44400000);\r\nnv_wo32(ctx, 0x0480, 0xffff0000);\r\nfor (i = 0x04d4; i < 0x04dc; i += 4)\r\nnv_wo32(ctx, i, 0x0fff0000);\r\nnv_wo32(ctx, 0x04e0, 0x00011100);\r\nfor (i = 0x04fc; i < 0x053c; i += 4)\r\nnv_wo32(ctx, i, 0x07ff0000);\r\nnv_wo32(ctx, 0x0544, 0x4b7fffff);\r\nnv_wo32(ctx, 0x057c, 0x00000080);\r\nnv_wo32(ctx, 0x0580, 0x30201000);\r\nnv_wo32(ctx, 0x0584, 0x70605040);\r\nnv_wo32(ctx, 0x0588, 0xb8a89888);\r\nnv_wo32(ctx, 0x058c, 0xf8e8d8c8);\r\nnv_wo32(ctx, 0x05a0, 0xb0000000);\r\nfor (i = 0x05f0; i < 0x0630; i += 4)\r\nnv_wo32(ctx, i, 0x00010588);\r\nfor (i = 0x0630; i < 0x0670; i += 4)\r\nnv_wo32(ctx, i, 0x00030303);\r\nfor (i = 0x06b0; i < 0x06f0; i += 4)\r\nnv_wo32(ctx, i, 0x0008aae4);\r\nfor (i = 0x06f0; i < 0x0730; i += 4)\r\nnv_wo32(ctx, i, 0x01012000);\r\nfor (i = 0x0730; i < 0x0770; i += 4)\r\nnv_wo32(ctx, i, 0x00080008);\r\nnv_wo32(ctx, 0x0850, 0x00040000);\r\nnv_wo32(ctx, 0x0854, 0x00010000);\r\nfor (i = 0x0858; i < 0x0868; i += 4)\r\nnv_wo32(ctx, i, 0x00040004);\r\nfor (i = 0x15ac; i <= 0x271c ; i += 16) {\r\nnv_wo32(ctx, i + 0, 0x10700ff9);\r\nnv_wo32(ctx, i + 1, 0x0436086c);\r\nnv_wo32(ctx, i + 2, 0x000c001b);\r\n}\r\nfor (i = 0x274c; i < 0x275c; i += 4)\r\nnv_wo32(ctx, i, 0x0000ffff);\r\nnv_wo32(ctx, 0x2ae0, 0x3f800000);\r\nnv_wo32(ctx, 0x2e9c, 0x3f800000);\r\nnv_wo32(ctx, 0x2eb0, 0x3f800000);\r\nnv_wo32(ctx, 0x2edc, 0x40000000);\r\nnv_wo32(ctx, 0x2ee0, 0x3f800000);\r\nnv_wo32(ctx, 0x2ee4, 0x3f000000);\r\nnv_wo32(ctx, 0x2eec, 0x40000000);\r\nnv_wo32(ctx, 0x2ef0, 0x3f800000);\r\nnv_wo32(ctx, 0x2ef8, 0xbf800000);\r\nnv_wo32(ctx, 0x2f00, 0xbf800000);\r\n}\r\nstatic void\r\nnv35_36_graph_context_init(struct nouveau_gpuobj *ctx)\r\n{\r\nint i;\r\nnv_wo32(ctx, 0x040c, 0x00000101);\r\nnv_wo32(ctx, 0x0420, 0x00000111);\r\nnv_wo32(ctx, 0x0424, 0x00000060);\r\nnv_wo32(ctx, 0x0440, 0x00000080);\r\nnv_wo32(ctx, 0x0444, 0xffff0000);\r\nnv_wo32(ctx, 0x0448, 0x00000001);\r\nnv_wo32(ctx, 0x045c, 0x44400000);\r\nnv_wo32(ctx, 0x0488, 0xffff0000);\r\nfor (i = 0x04dc; i < 0x04e4; i += 4)\r\nnv_wo32(ctx, i, 0x0fff0000);\r\nnv_wo32(ctx, 0x04e8, 0x00011100);\r\nfor (i = 0x0504; i < 0x0544; i += 4)\r\nnv_wo32(ctx, i, 0x07ff0000);\r\nnv_wo32(ctx, 0x054c, 0x4b7fffff);\r\nnv_wo32(ctx, 0x0588, 0x00000080);\r\nnv_wo32(ctx, 0x058c, 0x30201000);\r\nnv_wo32(ctx, 0x0590, 0x70605040);\r\nnv_wo32(ctx, 0x0594, 0xb8a89888);\r\nnv_wo32(ctx, 0x0598, 0xf8e8d8c8);\r\nnv_wo32(ctx, 0x05ac, 0xb0000000);\r\nfor (i = 0x0604; i < 0x0644; i += 4)\r\nnv_wo32(ctx, i, 0x00010588);\r\nfor (i = 0x0644; i < 0x0684; i += 4)\r\nnv_wo32(ctx, i, 0x00030303);\r\nfor (i = 0x06c4; i < 0x0704; i += 4)\r\nnv_wo32(ctx, i, 0x0008aae4);\r\nfor (i = 0x0704; i < 0x0744; i += 4)\r\nnv_wo32(ctx, i, 0x01012000);\r\nfor (i = 0x0744; i < 0x0784; i += 4)\r\nnv_wo32(ctx, i, 0x00080008);\r\nnv_wo32(ctx, 0x0860, 0x00040000);\r\nnv_wo32(ctx, 0x0864, 0x00010000);\r\nfor (i = 0x0868; i < 0x0878; i += 4)\r\nnv_wo32(ctx, i, 0x00040004);\r\nfor (i = 0x1f1c; i <= 0x308c ; i += 16) {\r\nnv_wo32(ctx, i + 0, 0x10700ff9);\r\nnv_wo32(ctx, i + 4, 0x0436086c);\r\nnv_wo32(ctx, i + 8, 0x000c001b);\r\n}\r\nfor (i = 0x30bc; i < 0x30cc; i += 4)\r\nnv_wo32(ctx, i, 0x0000ffff);\r\nnv_wo32(ctx, 0x3450, 0x3f800000);\r\nnv_wo32(ctx, 0x380c, 0x3f800000);\r\nnv_wo32(ctx, 0x3820, 0x3f800000);\r\nnv_wo32(ctx, 0x384c, 0x40000000);\r\nnv_wo32(ctx, 0x3850, 0x3f800000);\r\nnv_wo32(ctx, 0x3854, 0x3f000000);\r\nnv_wo32(ctx, 0x385c, 0x40000000);\r\nnv_wo32(ctx, 0x3860, 0x3f800000);\r\nnv_wo32(ctx, 0x3868, 0xbf800000);\r\nnv_wo32(ctx, 0x3870, 0xbf800000);\r\n}\r\nint\r\nnv20_graph_context_new(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct nv20_graph_engine *pgraph = nv_engine(chan->dev, engine);\r\nstruct nouveau_gpuobj *grctx = NULL;\r\nstruct drm_device *dev = chan->dev;\r\nint ret;\r\nret = nouveau_gpuobj_new(dev, NULL, pgraph->grctx_size, 16,\r\nNVOBJ_FLAG_ZERO_ALLOC, &grctx);\r\nif (ret)\r\nreturn ret;\r\npgraph->grctx_init(grctx);\r\nnv_wo32(grctx, pgraph->grctx_user, (chan->id << 24) | 0x1);\r\nnv_wo32(pgraph->ctxtab, chan->id * 4, grctx->pinst >> 4);\r\nchan->engctx[engine] = grctx;\r\nreturn 0;\r\n}\r\nvoid\r\nnv20_graph_context_del(struct nouveau_channel *chan, int engine)\r\n{\r\nstruct nv20_graph_engine *pgraph = nv_engine(chan->dev, engine);\r\nstruct nouveau_gpuobj *grctx = chan->engctx[engine];\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000000);\r\nif (nv10_graph_channel(dev) == chan)\r\nnv20_graph_unload_context(dev);\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000001);\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\nnv_wo32(pgraph->ctxtab, chan->id * 4, 0);\r\nnouveau_gpuobj_ref(NULL, &grctx);\r\nchan->engctx[engine] = NULL;\r\n}\r\nstatic void\r\nnv20_graph_set_tile_region(struct drm_device *dev, int i)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_tile_reg *tile = &dev_priv->tile.reg[i];\r\nnv_wr32(dev, NV20_PGRAPH_TLIMIT(i), tile->limit);\r\nnv_wr32(dev, NV20_PGRAPH_TSIZE(i), tile->pitch);\r\nnv_wr32(dev, NV20_PGRAPH_TILE(i), tile->addr);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0030 + 4 * i);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA, tile->limit);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0050 + 4 * i);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA, tile->pitch);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0010 + 4 * i);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA, tile->addr);\r\nif (dev_priv->card_type == NV_20) {\r\nnv_wr32(dev, NV20_PGRAPH_ZCOMP(i), tile->zcomp);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00ea0090 + 4 * i);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA, tile->zcomp);\r\n}\r\n}\r\nint\r\nnv20_graph_init(struct drm_device *dev, int engine)\r\n{\r\nstruct nv20_graph_engine *pgraph = nv_engine(dev, engine);\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nuint32_t tmp, vramsz;\r\nint i;\r\nnv_wr32(dev, NV03_PMC_ENABLE,\r\nnv_rd32(dev, NV03_PMC_ENABLE) & ~NV_PMC_ENABLE_PGRAPH);\r\nnv_wr32(dev, NV03_PMC_ENABLE,\r\nnv_rd32(dev, NV03_PMC_ENABLE) | NV_PMC_ENABLE_PGRAPH);\r\nnv_wr32(dev, NV20_PGRAPH_CHANNEL_CTX_TABLE, pgraph->ctxtab->pinst >> 4);\r\nnv20_graph_rdi(dev);\r\nnv_wr32(dev, NV03_PGRAPH_INTR , 0xFFFFFFFF);\r\nnv_wr32(dev, NV03_PGRAPH_INTR_EN, 0xFFFFFFFF);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_0, 0xFFFFFFFF);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_0, 0x00000000);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_1, 0x00118700);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_3, 0xF3CE0475);\r\nnv_wr32(dev, NV10_PGRAPH_DEBUG_4, 0x00000000);\r\nnv_wr32(dev, 0x40009C , 0x00000040);\r\nif (dev_priv->chipset >= 0x25) {\r\nnv_wr32(dev, 0x400890, 0x00a8cfff);\r\nnv_wr32(dev, 0x400610, 0x304B1FB6);\r\nnv_wr32(dev, 0x400B80, 0x1cbd3883);\r\nnv_wr32(dev, 0x400B84, 0x44000000);\r\nnv_wr32(dev, 0x400098, 0x40000080);\r\nnv_wr32(dev, 0x400B88, 0x000000ff);\r\n} else {\r\nnv_wr32(dev, 0x400880, 0x0008c7df);\r\nnv_wr32(dev, 0x400094, 0x00000005);\r\nnv_wr32(dev, 0x400B80, 0x45eae20e);\r\nnv_wr32(dev, 0x400B84, 0x24000000);\r\nnv_wr32(dev, 0x400098, 0x00000040);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00E00038);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , 0x00000030);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00E10038);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , 0x00000030);\r\n}\r\nfor (i = 0; i < NV10_PFB_TILE__SIZE; i++)\r\nnv20_graph_set_tile_region(dev, i);\r\nnv_wr32(dev, 0x4009a0, nv_rd32(dev, 0x100324));\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA000C);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA, nv_rd32(dev, 0x100324));\r\nnv_wr32(dev, NV10_PGRAPH_CTX_CONTROL, 0x10000100);\r\nnv_wr32(dev, NV10_PGRAPH_STATE , 0xFFFFFFFF);\r\ntmp = nv_rd32(dev, NV10_PGRAPH_SURFACE) & 0x0007ff00;\r\nnv_wr32(dev, NV10_PGRAPH_SURFACE, tmp);\r\ntmp = nv_rd32(dev, NV10_PGRAPH_SURFACE) | 0x00020100;\r\nnv_wr32(dev, NV10_PGRAPH_SURFACE, tmp);\r\nvramsz = pci_resource_len(dev->pdev, 0) - 1;\r\nnv_wr32(dev, 0x4009A4, nv_rd32(dev, NV04_PFB_CFG0));\r\nnv_wr32(dev, 0x4009A8, nv_rd32(dev, NV04_PFB_CFG1));\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0000);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , nv_rd32(dev, NV04_PFB_CFG0));\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0004);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , nv_rd32(dev, NV04_PFB_CFG1));\r\nnv_wr32(dev, 0x400820, 0);\r\nnv_wr32(dev, 0x400824, 0);\r\nnv_wr32(dev, 0x400864, vramsz - 1);\r\nnv_wr32(dev, 0x400868, vramsz - 1);\r\nnv_wr32(dev, 0x400B20, 0x00000000);\r\nnv_wr32(dev, 0x400B04, 0xFFFFFFFF);\r\nnv_wr32(dev, NV03_PGRAPH_ABS_UCLIP_XMIN, 0);\r\nnv_wr32(dev, NV03_PGRAPH_ABS_UCLIP_YMIN, 0);\r\nnv_wr32(dev, NV03_PGRAPH_ABS_UCLIP_XMAX, 0x7fff);\r\nnv_wr32(dev, NV03_PGRAPH_ABS_UCLIP_YMAX, 0x7fff);\r\nreturn 0;\r\n}\r\nint\r\nnv30_graph_init(struct drm_device *dev, int engine)\r\n{\r\nstruct nv20_graph_engine *pgraph = nv_engine(dev, engine);\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nint i;\r\nnv_wr32(dev, NV03_PMC_ENABLE,\r\nnv_rd32(dev, NV03_PMC_ENABLE) & ~NV_PMC_ENABLE_PGRAPH);\r\nnv_wr32(dev, NV03_PMC_ENABLE,\r\nnv_rd32(dev, NV03_PMC_ENABLE) | NV_PMC_ENABLE_PGRAPH);\r\nnv_wr32(dev, NV20_PGRAPH_CHANNEL_CTX_TABLE, pgraph->ctxtab->pinst >> 4);\r\nnv_wr32(dev, NV03_PGRAPH_INTR , 0xFFFFFFFF);\r\nnv_wr32(dev, NV03_PGRAPH_INTR_EN, 0xFFFFFFFF);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_0, 0xFFFFFFFF);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_0, 0x00000000);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_1, 0x401287c0);\r\nnv_wr32(dev, 0x400890, 0x01b463ff);\r\nnv_wr32(dev, NV04_PGRAPH_DEBUG_3, 0xf2de0475);\r\nnv_wr32(dev, NV10_PGRAPH_DEBUG_4, 0x00008000);\r\nnv_wr32(dev, NV04_PGRAPH_LIMIT_VIOL_PIX, 0xf04bdff6);\r\nnv_wr32(dev, 0x400B80, 0x1003d888);\r\nnv_wr32(dev, 0x400B84, 0x0c000000);\r\nnv_wr32(dev, 0x400098, 0x00000000);\r\nnv_wr32(dev, 0x40009C, 0x0005ad00);\r\nnv_wr32(dev, 0x400B88, 0x62ff00ff);\r\nnv_wr32(dev, 0x4000a0, 0x00000000);\r\nnv_wr32(dev, 0x4000a4, 0x00000008);\r\nnv_wr32(dev, 0x4008a8, 0xb784a400);\r\nnv_wr32(dev, 0x400ba0, 0x002f8685);\r\nnv_wr32(dev, 0x400ba4, 0x00231f3f);\r\nnv_wr32(dev, 0x4008a4, 0x40000020);\r\nif (dev_priv->chipset == 0x34) {\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0004);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , 0x00200201);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0008);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , 0x00000008);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00EA0000);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , 0x00000032);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_INDEX, 0x00E00004);\r\nnv_wr32(dev, NV10_PGRAPH_RDI_DATA , 0x00000002);\r\n}\r\nnv_wr32(dev, 0x4000c0, 0x00000016);\r\nfor (i = 0; i < NV10_PFB_TILE__SIZE; i++)\r\nnv20_graph_set_tile_region(dev, i);\r\nnv_wr32(dev, NV10_PGRAPH_CTX_CONTROL, 0x10000100);\r\nnv_wr32(dev, NV10_PGRAPH_STATE , 0xFFFFFFFF);\r\nnv_wr32(dev, 0x0040075c , 0x00000001);\r\nnv_wr32(dev, 0x4009A4, nv_rd32(dev, NV04_PFB_CFG0));\r\nnv_wr32(dev, 0x4009A8, nv_rd32(dev, NV04_PFB_CFG1));\r\nif (dev_priv->chipset != 0x34) {\r\nnv_wr32(dev, 0x400750, 0x00EA0000);\r\nnv_wr32(dev, 0x400754, nv_rd32(dev, NV04_PFB_CFG0));\r\nnv_wr32(dev, 0x400750, 0x00EA0004);\r\nnv_wr32(dev, 0x400754, nv_rd32(dev, NV04_PFB_CFG1));\r\n}\r\nreturn 0;\r\n}\r\nint\r\nnv20_graph_fini(struct drm_device *dev, int engine, bool suspend)\r\n{\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000000);\r\nif (!nv_wait(dev, NV04_PGRAPH_STATUS, ~0, 0) && suspend) {\r\nnv_mask(dev, NV04_PGRAPH_FIFO, 0x00000001, 0x00000001);\r\nreturn -EBUSY;\r\n}\r\nnv20_graph_unload_context(dev);\r\nnv_wr32(dev, NV03_PGRAPH_INTR_EN, 0x00000000);\r\nreturn 0;\r\n}\r\nstatic void\r\nnv20_graph_isr(struct drm_device *dev)\r\n{\r\nu32 stat;\r\nwhile ((stat = nv_rd32(dev, NV03_PGRAPH_INTR))) {\r\nu32 nsource = nv_rd32(dev, NV03_PGRAPH_NSOURCE);\r\nu32 nstatus = nv_rd32(dev, NV03_PGRAPH_NSTATUS);\r\nu32 addr = nv_rd32(dev, NV04_PGRAPH_TRAPPED_ADDR);\r\nu32 chid = (addr & 0x01f00000) >> 20;\r\nu32 subc = (addr & 0x00070000) >> 16;\r\nu32 mthd = (addr & 0x00001ffc);\r\nu32 data = nv_rd32(dev, NV04_PGRAPH_TRAPPED_DATA);\r\nu32 class = nv_rd32(dev, 0x400160 + subc * 4) & 0xfff;\r\nu32 show = stat;\r\nif (stat & NV_PGRAPH_INTR_ERROR) {\r\nif (nsource & NV03_PGRAPH_NSOURCE_ILLEGAL_MTHD) {\r\nif (!nouveau_gpuobj_mthd_call2(dev, chid, class, mthd, data))\r\nshow &= ~NV_PGRAPH_INTR_ERROR;\r\n}\r\n}\r\nnv_wr32(dev, NV03_PGRAPH_INTR, stat);\r\nnv_wr32(dev, NV04_PGRAPH_FIFO, 0x00000001);\r\nif (show && nouveau_ratelimit()) {\r\nNV_INFO(dev, "PGRAPH -");\r\nnouveau_bitfield_print(nv10_graph_intr, show);\r\nprintk(" nsource:");\r\nnouveau_bitfield_print(nv04_graph_nsource, nsource);\r\nprintk(" nstatus:");\r\nnouveau_bitfield_print(nv10_graph_nstatus, nstatus);\r\nprintk("\n");\r\nNV_INFO(dev, "PGRAPH - ch %d/%d class 0x%04x "\r\n"mthd 0x%04x data 0x%08x\n",\r\nchid, subc, class, mthd, data);\r\n}\r\n}\r\n}\r\nstatic void\r\nnv20_graph_destroy(struct drm_device *dev, int engine)\r\n{\r\nstruct nv20_graph_engine *pgraph = nv_engine(dev, engine);\r\nnouveau_irq_unregister(dev, 12);\r\nnouveau_gpuobj_ref(NULL, &pgraph->ctxtab);\r\nNVOBJ_ENGINE_DEL(dev, GR);\r\nkfree(pgraph);\r\n}\r\nint\r\nnv20_graph_create(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nv20_graph_engine *pgraph;\r\nint ret;\r\npgraph = kzalloc(sizeof(*pgraph), GFP_KERNEL);\r\nif (!pgraph)\r\nreturn -ENOMEM;\r\npgraph->base.destroy = nv20_graph_destroy;\r\npgraph->base.fini = nv20_graph_fini;\r\npgraph->base.context_new = nv20_graph_context_new;\r\npgraph->base.context_del = nv20_graph_context_del;\r\npgraph->base.object_new = nv04_graph_object_new;\r\npgraph->base.set_tile_region = nv20_graph_set_tile_region;\r\npgraph->grctx_user = 0x0028;\r\nif (dev_priv->card_type == NV_20) {\r\npgraph->base.init = nv20_graph_init;\r\nswitch (dev_priv->chipset) {\r\ncase 0x20:\r\npgraph->grctx_init = nv20_graph_context_init;\r\npgraph->grctx_size = NV20_GRCTX_SIZE;\r\npgraph->grctx_user = 0x0000;\r\nbreak;\r\ncase 0x25:\r\ncase 0x28:\r\npgraph->grctx_init = nv25_graph_context_init;\r\npgraph->grctx_size = NV25_GRCTX_SIZE;\r\nbreak;\r\ncase 0x2a:\r\npgraph->grctx_init = nv2a_graph_context_init;\r\npgraph->grctx_size = NV2A_GRCTX_SIZE;\r\npgraph->grctx_user = 0x0000;\r\nbreak;\r\ndefault:\r\nNV_ERROR(dev, "PGRAPH: unknown chipset\n");\r\nkfree(pgraph);\r\nreturn 0;\r\n}\r\n} else {\r\npgraph->base.init = nv30_graph_init;\r\nswitch (dev_priv->chipset) {\r\ncase 0x30:\r\ncase 0x31:\r\npgraph->grctx_init = nv30_31_graph_context_init;\r\npgraph->grctx_size = NV30_31_GRCTX_SIZE;\r\nbreak;\r\ncase 0x34:\r\npgraph->grctx_init = nv34_graph_context_init;\r\npgraph->grctx_size = NV34_GRCTX_SIZE;\r\nbreak;\r\ncase 0x35:\r\ncase 0x36:\r\npgraph->grctx_init = nv35_36_graph_context_init;\r\npgraph->grctx_size = NV35_36_GRCTX_SIZE;\r\nbreak;\r\ndefault:\r\nNV_ERROR(dev, "PGRAPH: unknown chipset\n");\r\nkfree(pgraph);\r\nreturn 0;\r\n}\r\n}\r\nret = nouveau_gpuobj_new(dev, NULL, 32 * 4, 16, NVOBJ_FLAG_ZERO_ALLOC,\r\n&pgraph->ctxtab);\r\nif (ret) {\r\nkfree(pgraph);\r\nreturn ret;\r\n}\r\nNVOBJ_ENGINE_ADD(dev, GR, &pgraph->base);\r\nnouveau_irq_register(dev, 12, nv20_graph_isr);\r\nNVOBJ_CLASS(dev, 0x506e, SW);\r\nNVOBJ_MTHD (dev, 0x506e, 0x0500, nv04_graph_mthd_page_flip);\r\nNVOBJ_CLASS(dev, 0x0030, GR);\r\nNVOBJ_CLASS(dev, 0x0039, GR);\r\nNVOBJ_CLASS(dev, 0x004a, GR);\r\nNVOBJ_CLASS(dev, 0x009f, GR);\r\nNVOBJ_CLASS(dev, 0x008a, GR);\r\nNVOBJ_CLASS(dev, 0x0089, GR);\r\nNVOBJ_CLASS(dev, 0x0062, GR);\r\nNVOBJ_CLASS(dev, 0x0043, GR);\r\nNVOBJ_CLASS(dev, 0x0012, GR);\r\nNVOBJ_CLASS(dev, 0x0072, GR);\r\nNVOBJ_CLASS(dev, 0x0019, GR);\r\nNVOBJ_CLASS(dev, 0x0044, GR);\r\nif (dev_priv->card_type == NV_20) {\r\nNVOBJ_CLASS(dev, 0x009e, GR);\r\nNVOBJ_CLASS(dev, 0x0096, GR);\r\nif (dev_priv->chipset < 0x25)\r\nNVOBJ_CLASS(dev, 0x0097, GR);\r\nelse\r\nNVOBJ_CLASS(dev, 0x0597, GR);\r\n} else {\r\nNVOBJ_CLASS(dev, 0x038a, GR);\r\nNVOBJ_CLASS(dev, 0x0389, GR);\r\nNVOBJ_CLASS(dev, 0x0362, GR);\r\nNVOBJ_CLASS(dev, 0x039e, GR);\r\nif (0x00000003 & (1 << (dev_priv->chipset & 0x0f)))\r\nNVOBJ_CLASS(dev, 0x0397, GR);\r\nelse\r\nif (0x00000010 & (1 << (dev_priv->chipset & 0x0f)))\r\nNVOBJ_CLASS(dev, 0x0697, GR);\r\nelse\r\nif (0x000001e0 & (1 << (dev_priv->chipset & 0x0f)))\r\nNVOBJ_CLASS(dev, 0x0497, GR);\r\n}\r\nreturn 0;\r\n}

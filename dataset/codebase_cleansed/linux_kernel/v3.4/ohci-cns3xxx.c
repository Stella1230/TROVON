static int __devinit\r\ncns3xxx_ohci_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nif (atomic_inc_return(&usb_pwr_ref) == 1) {\r\ncns3xxx_pwr_power_up(1 << PM_PLL_HM_PD_CTRL_REG_OFFSET_PLL_USB);\r\ncns3xxx_pwr_clk_en(1 << PM_CLK_GATE_REG_OFFSET_USB_HOST);\r\ncns3xxx_pwr_soft_rst(1 << PM_SOFT_RST_REG_OFFST_USB_HOST);\r\n__raw_writel((__raw_readl(MISC_CHIP_CONFIG_REG) | (0X2 << 24)),\r\nMISC_CHIP_CONFIG_REG);\r\n}\r\nret = ohci_init(ohci);\r\nif (ret < 0)\r\nreturn ret;\r\nohci->num_ports = 1;\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\nerr("can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cns3xxx_ohci_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct usb_hcd *hcd;\r\nconst struct hc_driver *driver = &cns3xxx_ohci_hc_driver;\r\nstruct resource *res;\r\nint irq;\r\nint retval;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res) {\r\ndev_err(dev, "Found HC with no IRQ.\n");\r\nreturn -ENODEV;\r\n}\r\nirq = res->start;\r\nhcd = usb_create_hcd(driver, dev, dev_name(dev));\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(dev, "Found HC with no register addr.\n");\r\nretval = -ENODEV;\r\ngoto err1;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len,\r\ndriver->description)) {\r\ndev_dbg(dev, "controller already in use\n");\r\nretval = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_dbg(dev, "error mapping memory\n");\r\nretval = -EFAULT;\r\ngoto err2;\r\n}\r\nohci_hcd_init(hcd_to_ohci(hcd));\r\nretval = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (retval == 0)\r\nreturn retval;\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nstatic int cns3xxx_ohci_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nif (atomic_dec_return(&usb_pwr_ref) == 0)\r\ncns3xxx_pwr_clk_dis(1 << PM_CLK_GATE_REG_OFFSET_USB_HOST);\r\nusb_put_hcd(hcd);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

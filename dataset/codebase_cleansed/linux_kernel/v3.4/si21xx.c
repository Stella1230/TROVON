static int si21_writeregs(struct si21xx_state *state, u8 reg1,\r\nu8 *data, int len)\r\n{\r\nint ret;\r\nu8 buf[60];\r\nstruct i2c_msg msg = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = len + 1\r\n};\r\nmsg.buf[0] = reg1;\r\nmemcpy(msg.buf + 1, data, len);\r\nret = i2c_transfer(state->i2c, &msg, 1);\r\nif (ret != 1)\r\ndprintk("%s: writereg error (reg1 == 0x%02x, data == 0x%02x, "\r\n"ret == %i)\n", __func__, reg1, data[0], ret);\r\nreturn (ret != 1) ? -EREMOTEIO : 0;\r\n}\r\nstatic int si21_writereg(struct si21xx_state *state, u8 reg, u8 data)\r\n{\r\nint ret;\r\nu8 buf[] = { reg, data };\r\nstruct i2c_msg msg = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = 2\r\n};\r\nret = i2c_transfer(state->i2c, &msg, 1);\r\nif (ret != 1)\r\ndprintk("%s: writereg error (reg == 0x%02x, data == 0x%02x, "\r\n"ret == %i)\n", __func__, reg, data, ret);\r\nreturn (ret != 1) ? -EREMOTEIO : 0;\r\n}\r\nstatic int si21_write(struct dvb_frontend *fe, const u8 buf[], int len)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nif (len != 2)\r\nreturn -EINVAL;\r\nreturn si21_writereg(state, buf[0], buf[1]);\r\n}\r\nstatic u8 si21_readreg(struct si21xx_state *state, u8 reg)\r\n{\r\nint ret;\r\nu8 b0[] = { reg };\r\nu8 b1[] = { 0 };\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = b0,\r\n.len = 1\r\n}, {\r\n.addr = state->config->demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = b1,\r\n.len = 1\r\n}\r\n};\r\nret = i2c_transfer(state->i2c, msg, 2);\r\nif (ret != 2)\r\ndprintk("%s: readreg error (reg == 0x%02x, ret == %i)\n",\r\n__func__, reg, ret);\r\nreturn b1[0];\r\n}\r\nstatic int si21_readregs(struct si21xx_state *state, u8 reg1, u8 *b, u8 len)\r\n{\r\nint ret;\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = &reg1,\r\n.len = 1\r\n}, {\r\n.addr = state->config->demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = b,\r\n.len = len\r\n}\r\n};\r\nret = i2c_transfer(state->i2c, msg, 2);\r\nif (ret != 2)\r\ndprintk("%s: readreg error (ret == %i)\n", __func__, ret);\r\nreturn ret == 2 ? 0 : -1;\r\n}\r\nstatic int si21xx_wait_diseqc_idle(struct si21xx_state *state, int timeout)\r\n{\r\nunsigned long start = jiffies;\r\ndprintk("%s\n", __func__);\r\nwhile ((si21_readreg(state, LNB_CTRL_REG_1) & 0x8) == 8) {\r\nif (jiffies - start > timeout) {\r\ndprintk("%s: timeout!!\n", __func__);\r\nreturn -ETIMEDOUT;\r\n}\r\nmsleep(10);\r\n};\r\nreturn 0;\r\n}\r\nstatic int si21xx_set_symbolrate(struct dvb_frontend *fe, u32 srate)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu32 sym_rate, data_rate;\r\nint i;\r\nu8 sym_rate_bytes[3];\r\ndprintk("%s : srate = %i\n", __func__ , srate);\r\nif ((srate < 1000000) || (srate > 45000000))\r\nreturn -EINVAL;\r\ndata_rate = srate;\r\nsym_rate = 0;\r\nfor (i = 0; i < 4; ++i) {\r\nsym_rate /= 100;\r\nsym_rate = sym_rate + ((data_rate % 100) * 0x800000) /\r\nstate->fs;\r\ndata_rate /= 100;\r\n}\r\nfor (i = 0; i < 3; ++i)\r\nsym_rate_bytes[i] = (u8)((sym_rate >> (i * 8)) & 0xff);\r\nsi21_writeregs(state, SYM_RATE_REG_L, sym_rate_bytes, 0x03);\r\nreturn 0;\r\n}\r\nstatic int si21xx_send_diseqc_msg(struct dvb_frontend *fe,\r\nstruct dvb_diseqc_master_cmd *m)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 lnb_status;\r\nu8 LNB_CTRL_1;\r\nint status;\r\ndprintk("%s\n", __func__);\r\nstatus = PASS;\r\nLNB_CTRL_1 = 0;\r\nstatus |= si21_readregs(state, LNB_CTRL_STATUS_REG, &lnb_status, 0x01);\r\nstatus |= si21_readregs(state, LNB_CTRL_REG_1, &lnb_status, 0x01);\r\nstatus |= si21_writeregs(state, LNB_FIFO_REGS_0, m->msg, m->msg_len);\r\nLNB_CTRL_1 = (lnb_status & 0x70);\r\nLNB_CTRL_1 |= m->msg_len;\r\nLNB_CTRL_1 |= 0x80;\r\nstatus |= si21_writeregs(state, LNB_CTRL_REG_1, &LNB_CTRL_1, 0x01);\r\nreturn status;\r\n}\r\nstatic int si21xx_send_diseqc_burst(struct dvb_frontend *fe,\r\nfe_sec_mini_cmd_t burst)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 val;\r\ndprintk("%s\n", __func__);\r\nif (si21xx_wait_diseqc_idle(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nval = (0x80 | si21_readreg(state, 0xc1));\r\nif (si21_writereg(state, LNB_CTRL_REG_1,\r\nburst == SEC_MINI_A ? (val & ~0x10) : (val | 0x10)))\r\nreturn -EREMOTEIO;\r\nif (si21xx_wait_diseqc_idle(state, 100) < 0)\r\nreturn -ETIMEDOUT;\r\nif (si21_writereg(state, LNB_CTRL_REG_1, val))\r\nreturn -EREMOTEIO;\r\nreturn 0;\r\n}\r\nstatic int si21xx_set_tone(struct dvb_frontend *fe, fe_sec_tone_mode_t tone)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 val;\r\ndprintk("%s\n", __func__);\r\nval = (0x80 | si21_readreg(state, LNB_CTRL_REG_1));\r\nswitch (tone) {\r\ncase SEC_TONE_ON:\r\nreturn si21_writereg(state, LNB_CTRL_REG_1, val | 0x20);\r\ncase SEC_TONE_OFF:\r\nreturn si21_writereg(state, LNB_CTRL_REG_1, (val & ~0x20));\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int si21xx_set_voltage(struct dvb_frontend *fe, fe_sec_voltage_t volt)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 val;\r\ndprintk("%s: %s\n", __func__,\r\nvolt == SEC_VOLTAGE_13 ? "SEC_VOLTAGE_13" :\r\nvolt == SEC_VOLTAGE_18 ? "SEC_VOLTAGE_18" : "??");\r\nval = (0x80 | si21_readreg(state, LNB_CTRL_REG_1));\r\nswitch (volt) {\r\ncase SEC_VOLTAGE_18:\r\nreturn si21_writereg(state, LNB_CTRL_REG_1, val | 0x40);\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nreturn si21_writereg(state, LNB_CTRL_REG_1, (val & ~0x40));\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\n}\r\nstatic int si21xx_init(struct dvb_frontend *fe)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nint i;\r\nint status = 0;\r\nu8 reg1;\r\nu8 val;\r\nu8 reg2[2];\r\ndprintk("%s\n", __func__);\r\nfor (i = 0; ; i += 2) {\r\nreg1 = serit_sp1511lhb_inittab[i];\r\nval = serit_sp1511lhb_inittab[i+1];\r\nif (reg1 == 0xff && val == 0xff)\r\nbreak;\r\nsi21_writeregs(state, reg1, &val, 1);\r\n}\r\nreg1 = 0x08;\r\nsi21_writeregs(state, SYSTEM_MODE_REG, &reg1, 0x01);\r\nreg2[0] =\r\nPARALLEL + (LSB_FIRST << 1)\r\n+ (FALLING_EDGE << 2) + (CLK_GAPPED_MODE << 3)\r\n+ (BYTE_WIDE << 4) + (ACTIVE_HIGH << 5)\r\n+ (ACTIVE_HIGH << 6) + (ACTIVE_HIGH << 7);\r\nreg2[1] = 0;\r\nstatus |= si21_writeregs(state, TS_CTRL_REG_1, reg2, 0x02);\r\nif (status != 0)\r\ndprintk(" %s : TS Set Error\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int si21_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 regs_read[2];\r\nu8 reg_read;\r\nu8 i;\r\nu8 lock;\r\nu8 signal = si21_readreg(state, ANALOG_AGC_POWER_LEVEL_REG);\r\nsi21_readregs(state, LOCK_STATUS_REG_1, regs_read, 0x02);\r\nreg_read = 0;\r\nfor (i = 0; i < 7; ++i)\r\nreg_read |= ((regs_read[0] >> i) & 0x01) << (6 - i);\r\nlock = ((reg_read & 0x7f) | (regs_read[1] & 0x80));\r\ndprintk("%s : FE_READ_STATUS : VSTATUS: 0x%02x\n", __func__, lock);\r\n*status = 0;\r\nif (signal > 10)\r\n*status |= FE_HAS_SIGNAL;\r\nif (lock & 0x2)\r\n*status |= FE_HAS_CARRIER;\r\nif (lock & 0x20)\r\n*status |= FE_HAS_VITERBI;\r\nif (lock & 0x40)\r\n*status |= FE_HAS_SYNC;\r\nif ((lock & 0x7b) == 0x7b)\r\n*status |= FE_HAS_LOCK;\r\nreturn 0;\r\n}\r\nstatic int si21_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu16 signal = (3 * si21_readreg(state, 0x27) *\r\nsi21_readreg(state, 0x28));\r\ndprintk("%s : AGCPWR: 0x%02x%02x, signal=0x%04x\n", __func__,\r\nsi21_readreg(state, 0x27),\r\nsi21_readreg(state, 0x28), (int) signal);\r\nsignal <<= 4;\r\n*strength = signal;\r\nreturn 0;\r\n}\r\nstatic int si21_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\ndprintk("%s\n", __func__);\r\nif (state->errmode != STATUS_BER)\r\nreturn 0;\r\n*ber = (si21_readreg(state, 0x1d) << 8) |\r\nsi21_readreg(state, 0x1e);\r\nreturn 0;\r\n}\r\nstatic int si21_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\ns32 xsnr = 0xffff - ((si21_readreg(state, 0x24) << 8) |\r\nsi21_readreg(state, 0x25));\r\nxsnr = 3 * (xsnr - 0xa100);\r\n*snr = (xsnr > 0xffff) ? 0xffff : (xsnr < 0) ? 0 : xsnr;\r\ndprintk("%s\n", __func__);\r\nreturn 0;\r\n}\r\nstatic int si21_read_ucblocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\ndprintk("%s\n", __func__);\r\nif (state->errmode != STATUS_UCBLOCKS)\r\n*ucblocks = 0;\r\nelse\r\n*ucblocks = (si21_readreg(state, 0x1d) << 8) |\r\nsi21_readreg(state, 0x1e);\r\nreturn 0;\r\n}\r\nstatic int si21xx_setacquire(struct dvb_frontend *fe, int symbrate,\r\nfe_code_rate_t crate)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 coderates[] = {\r\n0x0, 0x01, 0x02, 0x04, 0x00,\r\n0x8, 0x10, 0x20, 0x00, 0x3f\r\n};\r\nu8 coderate_ptr;\r\nint status;\r\nu8 start_acq = 0x80;\r\nu8 reg, regs[3];\r\ndprintk("%s\n", __func__);\r\nstatus = PASS;\r\ncoderate_ptr = coderates[crate];\r\nsi21xx_set_symbolrate(fe, symbrate);\r\nstatus |= si21_writeregs(state,\r\nVIT_SRCH_CTRL_REG_1,\r\n&coderate_ptr, 0x01);\r\nstatus |= si21_readregs(state, ACQ_CTRL_REG_2, &reg, 0x01);\r\nreg &= ~start_acq;\r\nstatus |= si21_writeregs(state, ACQ_CTRL_REG_2, &reg, 0x01);\r\nregs[0] = 0xCB;\r\nregs[1] = 0x40;\r\nregs[2] = 0xCB;\r\nstatus |= si21_writeregs(state,\r\nTWO_DB_BNDWDTH_THRSHLD_REG,\r\n&regs[0], 0x03);\r\nreg = 0x56;\r\nstatus |= si21_writeregs(state,\r\nLSA_CTRL_REG_1, &reg, 1);\r\nreg = 0x05;\r\nstatus |= si21_writeregs(state,\r\nBLIND_SCAN_CTRL_REG, &reg, 1);\r\nstatus |= si21_writeregs(state,\r\nACQ_CTRL_REG_2, &start_acq, 0x01);\r\nreturn status;\r\n}\r\nstatic int si21xx_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nunsigned char coarse_tune_freq;\r\nint fine_tune_freq;\r\nunsigned char sample_rate = 0;\r\nbool inband_interferer_ind;\r\nint icoarse_tune_freq;\r\nint ifine_tune_freq;\r\nunsigned int band_high;\r\nunsigned int band_low;\r\nunsigned int x1;\r\nunsigned int x2;\r\nint i;\r\nbool inband_interferer_div2[ALLOWABLE_FS_COUNT];\r\nbool inband_interferer_div4[ALLOWABLE_FS_COUNT];\r\nint status;\r\nint afs[ALLOWABLE_FS_COUNT] = { 200, 192, 193, 194, 195,\r\n196, 204, 205, 206, 207\r\n};\r\nint if_limit_high;\r\nint if_limit_low;\r\nint lnb_lo;\r\nint lnb_uncertanity;\r\nint rf_freq;\r\nint data_rate;\r\nunsigned char regs[4];\r\ndprintk("%s : FE_SET_FRONTEND\n", __func__);\r\nif (c->delivery_system != SYS_DVBS) {\r\ndprintk("%s: unsupported delivery system selected (%d)\n",\r\n__func__, c->delivery_system);\r\nreturn -EOPNOTSUPP;\r\n}\r\nfor (i = 0; i < ALLOWABLE_FS_COUNT; ++i)\r\ninband_interferer_div2[i] = inband_interferer_div4[i] = false;\r\nif_limit_high = -700000;\r\nif_limit_low = -100000;\r\nlnb_lo = 0;\r\nlnb_uncertanity = 0;\r\nrf_freq = 10 * c->frequency ;\r\ndata_rate = c->symbol_rate / 100;\r\nstatus = PASS;\r\nband_low = (rf_freq - lnb_lo) - ((lnb_uncertanity * 200)\r\n+ (data_rate * 135)) / 200;\r\nband_high = (rf_freq - lnb_lo) + ((lnb_uncertanity * 200)\r\n+ (data_rate * 135)) / 200;\r\nicoarse_tune_freq = 100000 *\r\n(((rf_freq - lnb_lo) -\r\n(if_limit_low + if_limit_high) / 2)\r\n/ 100000);\r\nifine_tune_freq = (rf_freq - lnb_lo) - icoarse_tune_freq ;\r\nfor (i = 0; i < ALLOWABLE_FS_COUNT; ++i) {\r\nx1 = ((rf_freq - lnb_lo) / (afs[i] * 2500)) *\r\n(afs[i] * 2500) + afs[i] * 2500;\r\nx2 = ((rf_freq - lnb_lo) / (afs[i] * 2500)) *\r\n(afs[i] * 2500);\r\nif (((band_low < x1) && (x1 < band_high)) ||\r\n((band_low < x2) && (x2 < band_high)))\r\ninband_interferer_div4[i] = true;\r\n}\r\nfor (i = 0; i < ALLOWABLE_FS_COUNT; ++i) {\r\nx1 = ((rf_freq - lnb_lo) / (afs[i] * 5000)) *\r\n(afs[i] * 5000) + afs[i] * 5000;\r\nx2 = ((rf_freq - lnb_lo) / (afs[i] * 5000)) *\r\n(afs[i] * 5000);\r\nif (((band_low < x1) && (x1 < band_high)) ||\r\n((band_low < x2) && (x2 < band_high)))\r\ninband_interferer_div2[i] = true;\r\n}\r\ninband_interferer_ind = true;\r\nfor (i = 0; i < ALLOWABLE_FS_COUNT; ++i) {\r\nif (inband_interferer_div2[i] || inband_interferer_div4[i]) {\r\ninband_interferer_ind = false;\r\nbreak;\r\n}\r\n}\r\nif (inband_interferer_ind) {\r\nfor (i = 0; i < ALLOWABLE_FS_COUNT; ++i) {\r\nif (!inband_interferer_div2[i]) {\r\nsample_rate = (u8) afs[i];\r\nbreak;\r\n}\r\n}\r\n} else {\r\nfor (i = 0; i < ALLOWABLE_FS_COUNT; ++i) {\r\nif ((inband_interferer_div2[i] ||\r\n!inband_interferer_div4[i])) {\r\nsample_rate = (u8) afs[i];\r\nbreak;\r\n}\r\n}\r\n}\r\nif (sample_rate > 207 || sample_rate < 192)\r\nsample_rate = 200;\r\nfine_tune_freq = ((0x4000 * (ifine_tune_freq / 10)) /\r\n((sample_rate) * 1000));\r\ncoarse_tune_freq = (u8)(icoarse_tune_freq / 100000);\r\nregs[0] = sample_rate;\r\nregs[1] = coarse_tune_freq;\r\nregs[2] = fine_tune_freq & 0xFF;\r\nregs[3] = fine_tune_freq >> 8 & 0xFF;\r\nstatus |= si21_writeregs(state, PLL_DIVISOR_REG, &regs[0], 0x04);\r\nstate->fs = sample_rate;\r\nsi21xx_setacquire(fe, c->symbol_rate, c->fec_inner);\r\nreturn 0;\r\n}\r\nstatic int si21xx_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\nu8 regdata;\r\ndprintk("%s\n", __func__);\r\nsi21_readregs(state, SYSTEM_MODE_REG, &regdata, 0x01);\r\nregdata |= 1 << 6;\r\nsi21_writeregs(state, SYSTEM_MODE_REG, &regdata, 0x01);\r\nstate->initialised = 0;\r\nreturn 0;\r\n}\r\nstatic void si21xx_release(struct dvb_frontend *fe)\r\n{\r\nstruct si21xx_state *state = fe->demodulator_priv;\r\ndprintk("%s\n", __func__);\r\nkfree(state);\r\n}\r\nstruct dvb_frontend *si21xx_attach(const struct si21xx_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct si21xx_state *state = NULL;\r\nint id;\r\ndprintk("%s\n", __func__);\r\nstate = kzalloc(sizeof(struct si21xx_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->initialised = 0;\r\nstate->errmode = STATUS_BER;\r\nid = si21_readreg(state, SYSTEM_MODE_REG);\r\nsi21_writereg(state, SYSTEM_MODE_REG, id | 0x40);\r\nmsleep(200);\r\nid = si21_readreg(state, 0x00);\r\nif (id != 0x04 && id != 0x14)\r\ngoto error;\r\nmemcpy(&state->frontend.ops, &si21xx_ops,\r\nsizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\nerror:\r\nkfree(state);\r\nreturn NULL;\r\n}

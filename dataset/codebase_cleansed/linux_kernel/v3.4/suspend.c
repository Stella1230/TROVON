void __cpu_suspend_save(u32 *ptr, u32 ptrsz, u32 sp, u32 *save_ptr)\r\n{\r\n*save_ptr = virt_to_phys(ptr);\r\n*ptr++ = virt_to_phys(idmap_pgd);\r\n*ptr++ = sp;\r\n*ptr++ = virt_to_phys(cpu_do_resume);\r\ncpu_do_suspend(ptr);\r\nflush_cache_all();\r\nouter_clean_range(*save_ptr, *save_ptr + ptrsz);\r\nouter_clean_range(virt_to_phys(save_ptr),\r\nvirt_to_phys(save_ptr) + sizeof(*save_ptr));\r\n}\r\nint cpu_suspend(unsigned long arg, int (*fn)(unsigned long))\r\n{\r\nstruct mm_struct *mm = current->active_mm;\r\nint ret;\r\nif (!idmap_pgd)\r\nreturn -EINVAL;\r\nret = __cpu_suspend(arg, fn);\r\nif (ret == 0) {\r\ncpu_switch_mm(mm->pgd, mm);\r\nlocal_flush_tlb_all();\r\n}\r\nreturn ret;\r\n}

static int __init nokia_bind_config(struct usb_configuration *c)\r\n{\r\nint status = 0;\r\nstatus = phonet_bind_config(c);\r\nif (status)\r\nprintk(KERN_DEBUG "could not bind phonet config\n");\r\nstatus = obex_bind_config(c, 0);\r\nif (status)\r\nprintk(KERN_DEBUG "could not bind obex config %d\n", 0);\r\nstatus = obex_bind_config(c, 1);\r\nif (status)\r\nprintk(KERN_DEBUG "could not bind obex config %d\n", 0);\r\nstatus = acm_bind_config(c, 2);\r\nif (status)\r\nprintk(KERN_DEBUG "could not bind acm config\n");\r\nstatus = ecm_bind_config(c, hostaddr);\r\nif (status)\r\nprintk(KERN_DEBUG "could not bind ecm config\n");\r\nreturn status;\r\n}\r\nstatic int __init nokia_bind(struct usb_composite_dev *cdev)\r\n{\r\nint gcnum;\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nint status;\r\nstatus = gphonet_setup(cdev->gadget);\r\nif (status < 0)\r\ngoto err_phonet;\r\nstatus = gserial_setup(cdev->gadget, 3);\r\nif (status < 0)\r\ngoto err_serial;\r\nstatus = gether_setup(cdev->gadget, hostaddr);\r\nif (status < 0)\r\ngoto err_ether;\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\ngoto err_usb;\r\nstrings_dev[STRING_MANUFACTURER_IDX].id = status;\r\ndevice_desc.iManufacturer = status;\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\ngoto err_usb;\r\nstrings_dev[STRING_PRODUCT_IDX].id = status;\r\ndevice_desc.iProduct = status;\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\ngoto err_usb;\r\nstrings_dev[STRING_DESCRIPTION_IDX].id = status;\r\nnokia_config_500ma_driver.iConfiguration = status;\r\nnokia_config_100ma_driver.iConfiguration = status;\r\ngcnum = usb_gadget_controller_number(gadget);\r\nif (gcnum >= 0)\r\ndevice_desc.bcdDevice = cpu_to_le16(NOKIA_VERSION_NUM);\r\nelse {\r\npr_err("nokia_bind: controller '%s' not recognized\n",\r\ngadget->name);\r\ngoto err_usb;\r\n}\r\nstatus = usb_add_config(cdev, &nokia_config_500ma_driver,\r\nnokia_bind_config);\r\nif (status < 0)\r\ngoto err_usb;\r\nstatus = usb_add_config(cdev, &nokia_config_100ma_driver,\r\nnokia_bind_config);\r\nif (status < 0)\r\ngoto err_usb;\r\ndev_info(&gadget->dev, "%s\n", NOKIA_LONG_NAME);\r\nreturn 0;\r\nerr_usb:\r\ngether_cleanup();\r\nerr_ether:\r\ngserial_cleanup();\r\nerr_serial:\r\ngphonet_cleanup();\r\nerr_phonet:\r\nreturn status;\r\n}\r\nstatic int __exit nokia_unbind(struct usb_composite_dev *cdev)\r\n{\r\ngphonet_cleanup();\r\ngserial_cleanup();\r\ngether_cleanup();\r\nreturn 0;\r\n}\r\nstatic int __init nokia_init(void)\r\n{\r\nreturn usb_composite_probe(&nokia_driver, nokia_bind);\r\n}\r\nstatic void __exit nokia_cleanup(void)\r\n{\r\nusb_composite_unregister(&nokia_driver);\r\n}

static int lnbp21_set_voltage(struct dvb_frontend *fe,\r\nfe_sec_voltage_t voltage)\r\n{\r\nstruct lnbp21 *lnbp21 = (struct lnbp21 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = lnbp21->i2c_addr, .flags = 0,\r\n.buf = &lnbp21->config,\r\n.len = sizeof(lnbp21->config) };\r\nlnbp21->config &= ~(LNBP21_VSEL | LNBP21_EN);\r\nswitch(voltage) {\r\ncase SEC_VOLTAGE_OFF:\r\nbreak;\r\ncase SEC_VOLTAGE_13:\r\nlnbp21->config |= LNBP21_EN;\r\nbreak;\r\ncase SEC_VOLTAGE_18:\r\nlnbp21->config |= (LNBP21_EN | LNBP21_VSEL);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\nlnbp21->config |= lnbp21->override_or;\r\nlnbp21->config &= lnbp21->override_and;\r\nreturn (i2c_transfer(lnbp21->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic int lnbp21_enable_high_lnb_voltage(struct dvb_frontend *fe, long arg)\r\n{\r\nstruct lnbp21 *lnbp21 = (struct lnbp21 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = lnbp21->i2c_addr, .flags = 0,\r\n.buf = &lnbp21->config,\r\n.len = sizeof(lnbp21->config) };\r\nif (arg)\r\nlnbp21->config |= LNBP21_LLC;\r\nelse\r\nlnbp21->config &= ~LNBP21_LLC;\r\nlnbp21->config |= lnbp21->override_or;\r\nlnbp21->config &= lnbp21->override_and;\r\nreturn (i2c_transfer(lnbp21->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic int lnbp21_set_tone(struct dvb_frontend *fe,\r\nfe_sec_tone_mode_t tone)\r\n{\r\nstruct lnbp21 *lnbp21 = (struct lnbp21 *) fe->sec_priv;\r\nstruct i2c_msg msg = { .addr = lnbp21->i2c_addr, .flags = 0,\r\n.buf = &lnbp21->config,\r\n.len = sizeof(lnbp21->config) };\r\nswitch (tone) {\r\ncase SEC_TONE_OFF:\r\nlnbp21->config &= ~LNBP21_TEN;\r\nbreak;\r\ncase SEC_TONE_ON:\r\nlnbp21->config |= LNBP21_TEN;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n};\r\nlnbp21->config |= lnbp21->override_or;\r\nlnbp21->config &= lnbp21->override_and;\r\nreturn (i2c_transfer(lnbp21->i2c, &msg, 1) == 1) ? 0 : -EIO;\r\n}\r\nstatic void lnbp21_release(struct dvb_frontend *fe)\r\n{\r\nlnbp21_set_voltage(fe, SEC_VOLTAGE_OFF);\r\nkfree(fe->sec_priv);\r\nfe->sec_priv = NULL;\r\n}\r\nstatic struct dvb_frontend *lnbx2x_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c, u8 override_set,\r\nu8 override_clear, u8 i2c_addr, u8 config)\r\n{\r\nstruct lnbp21 *lnbp21 = kmalloc(sizeof(struct lnbp21), GFP_KERNEL);\r\nif (!lnbp21)\r\nreturn NULL;\r\nlnbp21->config = config;\r\nlnbp21->i2c = i2c;\r\nlnbp21->i2c_addr = i2c_addr;\r\nfe->sec_priv = lnbp21;\r\nlnbp21->override_or = override_set;\r\nlnbp21->override_and = ~override_clear;\r\nif (lnbp21_set_voltage(fe, SEC_VOLTAGE_OFF)) {\r\nkfree(lnbp21);\r\nreturn NULL;\r\n}\r\nfe->ops.release_sec = lnbp21_release;\r\nfe->ops.set_voltage = lnbp21_set_voltage;\r\nfe->ops.enable_high_lnb_voltage = lnbp21_enable_high_lnb_voltage;\r\nif (!(override_clear & LNBH24_TEN))\r\nfe->ops.set_tone = lnbp21_set_tone;\r\nprintk(KERN_INFO "LNBx2x attached on addr=%x\n", lnbp21->i2c_addr);\r\nreturn fe;\r\n}\r\nstruct dvb_frontend *lnbh24_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c, u8 override_set,\r\nu8 override_clear, u8 i2c_addr)\r\n{\r\nreturn lnbx2x_attach(fe, i2c, override_set, override_clear,\r\ni2c_addr, LNBH24_TTX);\r\n}\r\nstruct dvb_frontend *lnbp21_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c, u8 override_set,\r\nu8 override_clear)\r\n{\r\nreturn lnbx2x_attach(fe, i2c, override_set, override_clear,\r\n0x08, LNBP21_ISEL);\r\n}

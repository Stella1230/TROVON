int __init raid6_select_algo(void)\r\n{\r\nconst struct raid6_calls * const * algo;\r\nconst struct raid6_calls * best;\r\nchar *syndromes;\r\nvoid *dptrs[(65536/PAGE_SIZE)+2];\r\nint i, disks;\r\nunsigned long perf, bestperf;\r\nint bestprefer;\r\nunsigned long j0, j1;\r\ndisks = (65536/PAGE_SIZE)+2;\r\nfor ( i = 0 ; i < disks-2 ; i++ ) {\r\ndptrs[i] = ((char *)raid6_gfmul) + PAGE_SIZE*i;\r\n}\r\nsyndromes = (void *) __get_free_pages(GFP_KERNEL, 1);\r\nif ( !syndromes ) {\r\nprintk("raid6: Yikes! No memory available.\n");\r\nreturn -ENOMEM;\r\n}\r\ndptrs[disks-2] = syndromes;\r\ndptrs[disks-1] = syndromes + PAGE_SIZE;\r\nbestperf = 0; bestprefer = 0; best = NULL;\r\nfor ( algo = raid6_algos ; *algo ; algo++ ) {\r\nif ( !(*algo)->valid || (*algo)->valid() ) {\r\nperf = 0;\r\npreempt_disable();\r\nj0 = jiffies;\r\nwhile ( (j1 = jiffies) == j0 )\r\ncpu_relax();\r\nwhile (time_before(jiffies,\r\nj1 + (1<<RAID6_TIME_JIFFIES_LG2))) {\r\n(*algo)->gen_syndrome(disks, PAGE_SIZE, dptrs);\r\nperf++;\r\n}\r\npreempt_enable();\r\nif ( (*algo)->prefer > bestprefer ||\r\n((*algo)->prefer == bestprefer &&\r\nperf > bestperf) ) {\r\nbest = *algo;\r\nbestprefer = best->prefer;\r\nbestperf = perf;\r\n}\r\nprintk("raid6: %-8s %5ld MB/s\n", (*algo)->name,\r\n(perf*HZ) >> (20-16+RAID6_TIME_JIFFIES_LG2));\r\n}\r\n}\r\nif (best) {\r\nprintk("raid6: using algorithm %s (%ld MB/s)\n",\r\nbest->name,\r\n(bestperf*HZ) >> (20-16+RAID6_TIME_JIFFIES_LG2));\r\nraid6_call = *best;\r\n} else\r\nprintk("raid6: Yikes! No algorithm found!\n");\r\nfree_pages((unsigned long)syndromes, 1);\r\nreturn best ? 0 : -EINVAL;\r\n}\r\nstatic void raid6_exit(void)\r\n{\r\ndo { } while (0);\r\n}

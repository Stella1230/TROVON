void ulist_init(struct ulist *ulist)\r\n{\r\nulist->nnodes = 0;\r\nulist->nodes = ulist->int_nodes;\r\nulist->nodes_alloced = ULIST_SIZE;\r\n}\r\nvoid ulist_fini(struct ulist *ulist)\r\n{\r\nif (ulist->nodes_alloced > ULIST_SIZE)\r\nkfree(ulist->nodes);\r\nulist->nodes_alloced = 0;\r\n}\r\nvoid ulist_reinit(struct ulist *ulist)\r\n{\r\nulist_fini(ulist);\r\nulist_init(ulist);\r\n}\r\nstruct ulist *ulist_alloc(unsigned long gfp_mask)\r\n{\r\nstruct ulist *ulist = kmalloc(sizeof(*ulist), gfp_mask);\r\nif (!ulist)\r\nreturn NULL;\r\nulist_init(ulist);\r\nreturn ulist;\r\n}\r\nvoid ulist_free(struct ulist *ulist)\r\n{\r\nif (!ulist)\r\nreturn;\r\nulist_fini(ulist);\r\nkfree(ulist);\r\n}\r\nint ulist_add(struct ulist *ulist, u64 val, unsigned long aux,\r\nunsigned long gfp_mask)\r\n{\r\nint i;\r\nfor (i = 0; i < ulist->nnodes; ++i) {\r\nif (ulist->nodes[i].val == val)\r\nreturn 0;\r\n}\r\nif (ulist->nnodes >= ulist->nodes_alloced) {\r\nu64 new_alloced = ulist->nodes_alloced + 128;\r\nstruct ulist_node *new_nodes;\r\nvoid *old = NULL;\r\nif (ulist->nodes_alloced > ULIST_SIZE)\r\nold = ulist->nodes;\r\nnew_nodes = krealloc(old, sizeof(*new_nodes) * new_alloced,\r\ngfp_mask);\r\nif (!new_nodes)\r\nreturn -ENOMEM;\r\nif (!old)\r\nmemcpy(new_nodes, ulist->int_nodes,\r\nsizeof(ulist->int_nodes));\r\nulist->nodes = new_nodes;\r\nulist->nodes_alloced = new_alloced;\r\n}\r\nulist->nodes[ulist->nnodes].val = val;\r\nulist->nodes[ulist->nnodes].aux = aux;\r\n++ulist->nnodes;\r\nreturn 1;\r\n}\r\nstruct ulist_node *ulist_next(struct ulist *ulist, struct ulist_node *prev)\r\n{\r\nint next;\r\nif (ulist->nnodes == 0)\r\nreturn NULL;\r\nif (!prev)\r\nreturn &ulist->nodes[0];\r\nnext = (prev - ulist->nodes) + 1;\r\nif (next < 0 || next >= ulist->nnodes)\r\nreturn NULL;\r\nreturn &ulist->nodes[next];\r\n}

static int kirkwood_i2s_set_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long mask;\r\nunsigned long value;\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_RIGHT_J:\r\nmask = KIRKWOOD_I2S_CTL_RJ;\r\nbreak;\r\ncase SND_SOC_DAIFMT_LEFT_J:\r\nmask = KIRKWOOD_I2S_CTL_LJ;\r\nbreak;\r\ncase SND_SOC_DAIFMT_I2S:\r\nmask = KIRKWOOD_I2S_CTL_I2S;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nvalue = readl(priv->io+KIRKWOOD_I2S_PLAYCTL);\r\nvalue &= ~KIRKWOOD_I2S_CTL_JUST_MASK;\r\nvalue |= mask;\r\nwritel(value, priv->io+KIRKWOOD_I2S_PLAYCTL);\r\nvalue = readl(priv->io+KIRKWOOD_I2S_RECCTL);\r\nvalue &= ~KIRKWOOD_I2S_CTL_JUST_MASK;\r\nvalue |= mask;\r\nwritel(value, priv->io+KIRKWOOD_I2S_RECCTL);\r\nreturn 0;\r\n}\r\nstatic inline void kirkwood_set_dco(void __iomem *io, unsigned long rate)\r\n{\r\nunsigned long value;\r\nvalue = KIRKWOOD_DCO_CTL_OFFSET_0;\r\nswitch (rate) {\r\ndefault:\r\ncase 44100:\r\nvalue |= KIRKWOOD_DCO_CTL_FREQ_11;\r\nbreak;\r\ncase 48000:\r\nvalue |= KIRKWOOD_DCO_CTL_FREQ_12;\r\nbreak;\r\ncase 96000:\r\nvalue |= KIRKWOOD_DCO_CTL_FREQ_24;\r\nbreak;\r\n}\r\nwritel(value, io + KIRKWOOD_DCO_CTL);\r\ndo {\r\ncpu_relax();\r\nvalue = readl(io + KIRKWOOD_DCO_SPCR_STATUS);\r\nvalue &= KIRKWOOD_DCO_SPCR_STATUS;\r\n} while (value == 0);\r\n}\r\nstatic int kirkwood_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, priv);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nunsigned int i2s_reg, reg;\r\nunsigned long i2s_value, value;\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\ni2s_reg = KIRKWOOD_I2S_PLAYCTL;\r\nreg = KIRKWOOD_PLAYCTL;\r\n} else {\r\ni2s_reg = KIRKWOOD_I2S_RECCTL;\r\nreg = KIRKWOOD_RECCTL;\r\n}\r\nkirkwood_set_dco(priv->io, params_rate(params));\r\ni2s_value = readl(priv->io+i2s_reg);\r\ni2s_value &= ~KIRKWOOD_I2S_CTL_SIZE_MASK;\r\nvalue = readl(priv->io+reg);\r\nvalue &= ~KIRKWOOD_PLAYCTL_SIZE_MASK;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\ni2s_value |= KIRKWOOD_I2S_CTL_SIZE_16;\r\nvalue |= KIRKWOOD_PLAYCTL_SIZE_16_C;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\ni2s_value |= KIRKWOOD_I2S_CTL_SIZE_24;\r\nvalue |= KIRKWOOD_PLAYCTL_SIZE_24;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S32_LE:\r\ni2s_value |= KIRKWOOD_I2S_CTL_SIZE_32;\r\nvalue |= KIRKWOOD_PLAYCTL_SIZE_32;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nvalue &= ~KIRKWOOD_PLAYCTL_MONO_MASK;\r\nif (params_channels(params) == 1)\r\nvalue |= KIRKWOOD_PLAYCTL_MONO_BOTH;\r\nelse\r\nvalue |= KIRKWOOD_PLAYCTL_MONO_OFF;\r\n}\r\nwritel(i2s_value, priv->io+i2s_reg);\r\nwritel(value, priv->io+reg);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_play_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nunsigned long value;\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue |= KIRKWOOD_PLAYCTL_PAUSE;\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue |= KIRKWOOD_INT_CAUSE_PLAY_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue &= ~KIRKWOOD_PLAYCTL_BURST_MASK;\r\nvalue &= ~(KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE\r\n| KIRKWOOD_PLAYCTL_SPDIF_EN);\r\nif (priv->burst == 32)\r\nvalue |= KIRKWOOD_PLAYCTL_BURST_32;\r\nelse\r\nvalue |= KIRKWOOD_PLAYCTL_BURST_128;\r\nvalue |= KIRKWOOD_PLAYCTL_I2S_EN;\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue |= KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE;\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue &= ~KIRKWOOD_INT_CAUSE_PLAY_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue &= ~(KIRKWOOD_PLAYCTL_I2S_EN | KIRKWOOD_PLAYCTL_SPDIF_EN);\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue |= KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE;\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue &= ~(KIRKWOOD_PLAYCTL_PAUSE | KIRKWOOD_PLAYCTL_I2S_MUTE);\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_rec_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nunsigned long value;\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue |= KIRKWOOD_RECCTL_PAUSE;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue |= KIRKWOOD_INT_CAUSE_REC_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~KIRKWOOD_RECCTL_BURST_MASK;\r\nvalue &= ~KIRKWOOD_RECCTL_MONO;\r\nvalue &= ~(KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE\r\n| KIRKWOOD_RECCTL_SPDIF_EN);\r\nif (priv->burst == 32)\r\nvalue |= KIRKWOOD_RECCTL_BURST_32;\r\nelse\r\nvalue |= KIRKWOOD_RECCTL_BURST_128;\r\nvalue |= KIRKWOOD_RECCTL_I2S_EN;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue |= KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nvalue = readl(priv->io + KIRKWOOD_INT_MASK);\r\nvalue &= ~KIRKWOOD_INT_CAUSE_REC_BYTES;\r\nwritel(value, priv->io + KIRKWOOD_INT_MASK);\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~(KIRKWOOD_RECCTL_I2S_EN | KIRKWOOD_RECCTL_SPDIF_EN);\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue |= KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE;\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~(KIRKWOOD_RECCTL_PAUSE | KIRKWOOD_RECCTL_MUTE);\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nreturn kirkwood_i2s_play_trigger(substream, cmd, dai);\r\nelse\r\nreturn kirkwood_i2s_rec_trigger(substream, cmd, dai);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct kirkwood_dma_data *priv = snd_soc_dai_get_drvdata(dai);\r\nunsigned long value;\r\nunsigned int reg_data;\r\nwritel(0xffffffff, priv->io + KIRKWOOD_INT_CAUSE);\r\nwritel(0, priv->io + KIRKWOOD_INT_MASK);\r\nreg_data = readl(priv->io + 0x1200);\r\nreg_data &= (~(0x333FF8));\r\nreg_data |= 0x111D18;\r\nwritel(reg_data, priv->io + 0x1200);\r\nmsleep(500);\r\nreg_data = readl(priv->io + 0x1200);\r\nreg_data &= (~(0x333FF8));\r\nreg_data |= 0x111D18;\r\nwritel(reg_data, priv->io + 0x1200);\r\nvalue = readl(priv->io + KIRKWOOD_PLAYCTL);\r\nvalue &= ~(KIRKWOOD_PLAYCTL_I2S_EN|KIRKWOOD_PLAYCTL_SPDIF_EN);\r\nwritel(value, priv->io + KIRKWOOD_PLAYCTL);\r\nvalue = readl(priv->io + KIRKWOOD_RECCTL);\r\nvalue &= ~(KIRKWOOD_RECCTL_I2S_EN | KIRKWOOD_RECCTL_SPDIF_EN);\r\nwritel(value, priv->io + KIRKWOOD_RECCTL);\r\nreturn 0;\r\n}\r\nstatic int kirkwood_i2s_remove(struct snd_soc_dai *dai)\r\n{\r\nreturn 0;\r\n}\r\nstatic __devinit int kirkwood_i2s_dev_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *mem;\r\nstruct kirkwood_asoc_platform_data *data =\r\npdev->dev.platform_data;\r\nstruct kirkwood_dma_data *priv;\r\nint err;\r\npriv = kzalloc(sizeof(struct kirkwood_dma_data), GFP_KERNEL);\r\nif (!priv) {\r\ndev_err(&pdev->dev, "allocation failed\n");\r\nerr = -ENOMEM;\r\ngoto error;\r\n}\r\ndev_set_drvdata(&pdev->dev, priv);\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_err(&pdev->dev, "platform_get_resource failed\n");\r\nerr = -ENXIO;\r\ngoto err_alloc;\r\n}\r\npriv->mem = request_mem_region(mem->start, SZ_16K, DRV_NAME);\r\nif (!priv->mem) {\r\ndev_err(&pdev->dev, "request_mem_region failed\n");\r\nerr = -EBUSY;\r\ngoto err_alloc;\r\n}\r\npriv->io = ioremap(priv->mem->start, SZ_16K);\r\nif (!priv->io) {\r\ndev_err(&pdev->dev, "ioremap failed\n");\r\nerr = -ENOMEM;\r\ngoto err_iomem;\r\n}\r\npriv->irq = platform_get_irq(pdev, 0);\r\nif (priv->irq <= 0) {\r\ndev_err(&pdev->dev, "platform_get_irq failed\n");\r\nerr = -ENXIO;\r\ngoto err_ioremap;\r\n}\r\nif (!data) {\r\ndev_err(&pdev->dev, "no platform data ?!\n");\r\nerr = -EINVAL;\r\ngoto err_ioremap;\r\n}\r\npriv->burst = data->burst;\r\nreturn snd_soc_register_dai(&pdev->dev, &kirkwood_i2s_dai);\r\nerr_ioremap:\r\niounmap(priv->io);\r\nerr_iomem:\r\nrelease_mem_region(priv->mem->start, SZ_16K);\r\nerr_alloc:\r\nkfree(priv);\r\nerror:\r\nreturn err;\r\n}\r\nstatic __devexit int kirkwood_i2s_dev_remove(struct platform_device *pdev)\r\n{\r\nstruct kirkwood_dma_data *priv = dev_get_drvdata(&pdev->dev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\niounmap(priv->io);\r\nrelease_mem_region(priv->mem->start, SZ_16K);\r\nkfree(priv);\r\nreturn 0;\r\n}

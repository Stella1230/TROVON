int ieee802154_nl_assoc_indic(struct net_device *dev,\r\nstruct ieee802154_addr *addr, u8 cap)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nif (addr->addr_type != IEEE802154_ADDR_LONG) {\r\npr_err("%s: received non-long source address!\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nmsg = ieee802154_nl_create(0, IEEE802154_ASSOCIATE_INDIC);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT(msg, IEEE802154_ATTR_SRC_HW_ADDR, IEEE802154_ADDR_LEN,\r\naddr->hwaddr);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_CAPABILITY, cap);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nint ieee802154_nl_assoc_confirm(struct net_device *dev, u16 short_addr,\r\nu8 status)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_ASSOCIATE_CONF);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT_U16(msg, IEEE802154_ATTR_SHORT_ADDR, short_addr);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_STATUS, status);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nint ieee802154_nl_disassoc_indic(struct net_device *dev,\r\nstruct ieee802154_addr *addr, u8 reason)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_DISASSOCIATE_INDIC);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nif (addr->addr_type == IEEE802154_ADDR_LONG)\r\nNLA_PUT(msg, IEEE802154_ATTR_SRC_HW_ADDR, IEEE802154_ADDR_LEN,\r\naddr->hwaddr);\r\nelse\r\nNLA_PUT_U16(msg, IEEE802154_ATTR_SRC_SHORT_ADDR,\r\naddr->short_addr);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_REASON, reason);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nint ieee802154_nl_disassoc_confirm(struct net_device *dev, u8 status)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_DISASSOCIATE_CONF);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_STATUS, status);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nint ieee802154_nl_beacon_indic(struct net_device *dev,\r\nu16 panid, u16 coord_addr)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_BEACON_NOTIFY_INDIC);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT_U16(msg, IEEE802154_ATTR_COORD_SHORT_ADDR, coord_addr);\r\nNLA_PUT_U16(msg, IEEE802154_ATTR_COORD_PAN_ID, panid);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nint ieee802154_nl_scan_confirm(struct net_device *dev,\r\nu8 status, u8 scan_type, u32 unscanned, u8 page,\r\nu8 *edl)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_SCAN_CONF);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_STATUS, status);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_SCAN_TYPE, scan_type);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_CHANNELS, unscanned);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_PAGE, page);\r\nif (edl)\r\nNLA_PUT(msg, IEEE802154_ATTR_ED_LIST, 27, edl);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nint ieee802154_nl_start_confirm(struct net_device *dev, u8 status)\r\n{\r\nstruct sk_buff *msg;\r\npr_debug("%s\n", __func__);\r\nmsg = ieee802154_nl_create(0, IEEE802154_START_CONF);\r\nif (!msg)\r\nreturn -ENOBUFS;\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT_U8(msg, IEEE802154_ATTR_STATUS, status);\r\nreturn ieee802154_nl_mcast(msg, ieee802154_coord_mcgrp.id);\r\nnla_put_failure:\r\nnlmsg_free(msg);\r\nreturn -ENOBUFS;\r\n}\r\nstatic int ieee802154_nl_fill_iface(struct sk_buff *msg, u32 pid,\r\nu32 seq, int flags, struct net_device *dev)\r\n{\r\nvoid *hdr;\r\nstruct wpan_phy *phy;\r\npr_debug("%s\n", __func__);\r\nhdr = genlmsg_put(msg, 0, seq, &nl802154_family, flags,\r\nIEEE802154_LIST_IFACE);\r\nif (!hdr)\r\ngoto out;\r\nphy = ieee802154_mlme_ops(dev)->get_phy(dev);\r\nBUG_ON(!phy);\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_DEV_NAME, dev->name);\r\nNLA_PUT_STRING(msg, IEEE802154_ATTR_PHY_NAME, wpan_phy_name(phy));\r\nNLA_PUT_U32(msg, IEEE802154_ATTR_DEV_INDEX, dev->ifindex);\r\nNLA_PUT(msg, IEEE802154_ATTR_HW_ADDR, IEEE802154_ADDR_LEN,\r\ndev->dev_addr);\r\nNLA_PUT_U16(msg, IEEE802154_ATTR_SHORT_ADDR,\r\nieee802154_mlme_ops(dev)->get_short_addr(dev));\r\nNLA_PUT_U16(msg, IEEE802154_ATTR_PAN_ID,\r\nieee802154_mlme_ops(dev)->get_pan_id(dev));\r\nwpan_phy_put(phy);\r\nreturn genlmsg_end(msg, hdr);\r\nnla_put_failure:\r\nwpan_phy_put(phy);\r\ngenlmsg_cancel(msg, hdr);\r\nout:\r\nreturn -EMSGSIZE;\r\n}\r\nstatic struct net_device *ieee802154_nl_get_dev(struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nif (info->attrs[IEEE802154_ATTR_DEV_NAME]) {\r\nchar name[IFNAMSIZ + 1];\r\nnla_strlcpy(name, info->attrs[IEEE802154_ATTR_DEV_NAME],\r\nsizeof(name));\r\ndev = dev_get_by_name(&init_net, name);\r\n} else if (info->attrs[IEEE802154_ATTR_DEV_INDEX])\r\ndev = dev_get_by_index(&init_net,\r\nnla_get_u32(info->attrs[IEEE802154_ATTR_DEV_INDEX]));\r\nelse\r\nreturn NULL;\r\nif (!dev)\r\nreturn NULL;\r\nif (dev->type != ARPHRD_IEEE802154) {\r\ndev_put(dev);\r\nreturn NULL;\r\n}\r\nreturn dev;\r\n}\r\nstatic int ieee802154_associate_req(struct sk_buff *skb,\r\nstruct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nu8 page;\r\nint ret = -EINVAL;\r\nif (!info->attrs[IEEE802154_ATTR_CHANNEL] ||\r\n!info->attrs[IEEE802154_ATTR_COORD_PAN_ID] ||\r\n(!info->attrs[IEEE802154_ATTR_COORD_HW_ADDR] &&\r\n!info->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]) ||\r\n!info->attrs[IEEE802154_ATTR_CAPABILITY])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (info->attrs[IEEE802154_ATTR_COORD_HW_ADDR]) {\r\naddr.addr_type = IEEE802154_ADDR_LONG;\r\nnla_memcpy(addr.hwaddr,\r\ninfo->attrs[IEEE802154_ATTR_COORD_HW_ADDR],\r\nIEEE802154_ADDR_LEN);\r\n} else {\r\naddr.addr_type = IEEE802154_ADDR_SHORT;\r\naddr.short_addr = nla_get_u16(\r\ninfo->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]);\r\n}\r\naddr.pan_id = nla_get_u16(info->attrs[IEEE802154_ATTR_COORD_PAN_ID]);\r\nif (info->attrs[IEEE802154_ATTR_PAGE])\r\npage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\r\nelse\r\npage = 0;\r\nret = ieee802154_mlme_ops(dev)->assoc_req(dev, &addr,\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_CHANNEL]),\r\npage,\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_CAPABILITY]));\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nstatic int ieee802154_associate_resp(struct sk_buff *skb,\r\nstruct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nint ret = -EINVAL;\r\nif (!info->attrs[IEEE802154_ATTR_STATUS] ||\r\n!info->attrs[IEEE802154_ATTR_DEST_HW_ADDR] ||\r\n!info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\naddr.addr_type = IEEE802154_ADDR_LONG;\r\nnla_memcpy(addr.hwaddr, info->attrs[IEEE802154_ATTR_DEST_HW_ADDR],\r\nIEEE802154_ADDR_LEN);\r\naddr.pan_id = ieee802154_mlme_ops(dev)->get_pan_id(dev);\r\nret = ieee802154_mlme_ops(dev)->assoc_resp(dev, &addr,\r\nnla_get_u16(info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]),\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_STATUS]));\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nstatic int ieee802154_disassociate_req(struct sk_buff *skb,\r\nstruct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nint ret = -EINVAL;\r\nif ((!info->attrs[IEEE802154_ATTR_DEST_HW_ADDR] &&\r\n!info->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]) ||\r\n!info->attrs[IEEE802154_ATTR_REASON])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nif (info->attrs[IEEE802154_ATTR_DEST_HW_ADDR]) {\r\naddr.addr_type = IEEE802154_ADDR_LONG;\r\nnla_memcpy(addr.hwaddr,\r\ninfo->attrs[IEEE802154_ATTR_DEST_HW_ADDR],\r\nIEEE802154_ADDR_LEN);\r\n} else {\r\naddr.addr_type = IEEE802154_ADDR_SHORT;\r\naddr.short_addr = nla_get_u16(\r\ninfo->attrs[IEEE802154_ATTR_DEST_SHORT_ADDR]);\r\n}\r\naddr.pan_id = ieee802154_mlme_ops(dev)->get_pan_id(dev);\r\nret = ieee802154_mlme_ops(dev)->disassoc_req(dev, &addr,\r\nnla_get_u8(info->attrs[IEEE802154_ATTR_REASON]));\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nstatic int ieee802154_start_req(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nstruct ieee802154_addr addr;\r\nu8 channel, bcn_ord, sf_ord;\r\nu8 page;\r\nint pan_coord, blx, coord_realign;\r\nint ret;\r\nif (!info->attrs[IEEE802154_ATTR_COORD_PAN_ID] ||\r\n!info->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR] ||\r\n!info->attrs[IEEE802154_ATTR_CHANNEL] ||\r\n!info->attrs[IEEE802154_ATTR_BCN_ORD] ||\r\n!info->attrs[IEEE802154_ATTR_SF_ORD] ||\r\n!info->attrs[IEEE802154_ATTR_PAN_COORD] ||\r\n!info->attrs[IEEE802154_ATTR_BAT_EXT] ||\r\n!info->attrs[IEEE802154_ATTR_COORD_REALIGN]\r\n)\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\naddr.addr_type = IEEE802154_ADDR_SHORT;\r\naddr.short_addr = nla_get_u16(\r\ninfo->attrs[IEEE802154_ATTR_COORD_SHORT_ADDR]);\r\naddr.pan_id = nla_get_u16(info->attrs[IEEE802154_ATTR_COORD_PAN_ID]);\r\nchannel = nla_get_u8(info->attrs[IEEE802154_ATTR_CHANNEL]);\r\nbcn_ord = nla_get_u8(info->attrs[IEEE802154_ATTR_BCN_ORD]);\r\nsf_ord = nla_get_u8(info->attrs[IEEE802154_ATTR_SF_ORD]);\r\npan_coord = nla_get_u8(info->attrs[IEEE802154_ATTR_PAN_COORD]);\r\nblx = nla_get_u8(info->attrs[IEEE802154_ATTR_BAT_EXT]);\r\ncoord_realign = nla_get_u8(info->attrs[IEEE802154_ATTR_COORD_REALIGN]);\r\nif (info->attrs[IEEE802154_ATTR_PAGE])\r\npage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\r\nelse\r\npage = 0;\r\nif (addr.short_addr == IEEE802154_ADDR_BROADCAST) {\r\nieee802154_nl_start_confirm(dev, IEEE802154_NO_SHORT_ADDRESS);\r\ndev_put(dev);\r\nreturn -EINVAL;\r\n}\r\nret = ieee802154_mlme_ops(dev)->start_req(dev, &addr, channel, page,\r\nbcn_ord, sf_ord, pan_coord, blx, coord_realign);\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nstatic int ieee802154_scan_req(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nstruct net_device *dev;\r\nint ret;\r\nu8 type;\r\nu32 channels;\r\nu8 duration;\r\nu8 page;\r\nif (!info->attrs[IEEE802154_ATTR_SCAN_TYPE] ||\r\n!info->attrs[IEEE802154_ATTR_CHANNELS] ||\r\n!info->attrs[IEEE802154_ATTR_DURATION])\r\nreturn -EINVAL;\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\ntype = nla_get_u8(info->attrs[IEEE802154_ATTR_SCAN_TYPE]);\r\nchannels = nla_get_u32(info->attrs[IEEE802154_ATTR_CHANNELS]);\r\nduration = nla_get_u8(info->attrs[IEEE802154_ATTR_DURATION]);\r\nif (info->attrs[IEEE802154_ATTR_PAGE])\r\npage = nla_get_u8(info->attrs[IEEE802154_ATTR_PAGE]);\r\nelse\r\npage = 0;\r\nret = ieee802154_mlme_ops(dev)->scan_req(dev, type, channels, page,\r\nduration);\r\ndev_put(dev);\r\nreturn ret;\r\n}\r\nstatic int ieee802154_list_iface(struct sk_buff *skb,\r\nstruct genl_info *info)\r\n{\r\nstruct sk_buff *msg;\r\nstruct net_device *dev = NULL;\r\nint rc = -ENOBUFS;\r\npr_debug("%s\n", __func__);\r\ndev = ieee802154_nl_get_dev(info);\r\nif (!dev)\r\nreturn -ENODEV;\r\nmsg = nlmsg_new(NLMSG_GOODSIZE, GFP_KERNEL);\r\nif (!msg)\r\ngoto out_dev;\r\nrc = ieee802154_nl_fill_iface(msg, info->snd_pid, info->snd_seq,\r\n0, dev);\r\nif (rc < 0)\r\ngoto out_free;\r\ndev_put(dev);\r\nreturn genlmsg_reply(msg, info);\r\nout_free:\r\nnlmsg_free(msg);\r\nout_dev:\r\ndev_put(dev);\r\nreturn rc;\r\n}\r\nstatic int ieee802154_dump_iface(struct sk_buff *skb,\r\nstruct netlink_callback *cb)\r\n{\r\nstruct net *net = sock_net(skb->sk);\r\nstruct net_device *dev;\r\nint idx;\r\nint s_idx = cb->args[0];\r\npr_debug("%s\n", __func__);\r\nidx = 0;\r\nfor_each_netdev(net, dev) {\r\nif (idx < s_idx || (dev->type != ARPHRD_IEEE802154))\r\ngoto cont;\r\nif (ieee802154_nl_fill_iface(skb, NETLINK_CB(cb->skb).pid,\r\ncb->nlh->nlmsg_seq, NLM_F_MULTI, dev) < 0)\r\nbreak;\r\ncont:\r\nidx++;\r\n}\r\ncb->args[0] = idx;\r\nreturn skb->len;\r\n}\r\nint nl802154_mac_register(void)\r\n{\r\nint i;\r\nint rc;\r\nrc = genl_register_mc_group(&nl802154_family,\r\n&ieee802154_coord_mcgrp);\r\nif (rc)\r\nreturn rc;\r\nrc = genl_register_mc_group(&nl802154_family,\r\n&ieee802154_beacon_mcgrp);\r\nif (rc)\r\nreturn rc;\r\nfor (i = 0; i < ARRAY_SIZE(ieee802154_coordinator_ops); i++) {\r\nrc = genl_register_ops(&nl802154_family,\r\n&ieee802154_coordinator_ops[i]);\r\nif (rc)\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}

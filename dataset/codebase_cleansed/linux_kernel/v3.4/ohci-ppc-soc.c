static int usb_hcd_ppc_soc_probe(const struct hc_driver *driver,\r\nstruct platform_device *pdev)\r\n{\r\nint retval;\r\nstruct usb_hcd *hcd;\r\nstruct ohci_hcd *ohci;\r\nstruct resource *res;\r\nint irq;\r\npr_debug("initializing PPC-SOC USB Controller\n");\r\nres = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (!res) {\r\npr_debug("%s: no irq\n", __FILE__);\r\nreturn -ENODEV;\r\n}\r\nirq = res->start;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\npr_debug("%s: no reg addr\n", __FILE__);\r\nreturn -ENODEV;\r\n}\r\nhcd = usb_create_hcd(driver, &pdev->dev, "PPC-SOC USB");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_debug("%s: request_mem_region failed\n", __FILE__);\r\nretval = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\npr_debug("%s: ioremap failed\n", __FILE__);\r\nretval = -ENOMEM;\r\ngoto err2;\r\n}\r\nohci = hcd_to_ohci(hcd);\r\nohci->flags |= OHCI_QUIRK_BE_MMIO | OHCI_QUIRK_BE_DESC;\r\n#ifdef CONFIG_PPC_MPC52xx\r\nohci->flags |= OHCI_QUIRK_FRAME_NO;\r\n#endif\r\nohci_hcd_init(ohci);\r\nretval = usb_add_hcd(hcd, irq, 0);\r\nif (retval == 0)\r\nreturn retval;\r\npr_debug("Removing PPC-SOC USB Controller\n");\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn retval;\r\n}\r\nstatic void usb_hcd_ppc_soc_remove(struct usb_hcd *hcd,\r\nstruct platform_device *pdev)\r\n{\r\nusb_remove_hcd(hcd);\r\npr_debug("stopping PPC-SOC USB Controller\n");\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\n}\r\nstatic int __devinit\r\nohci_ppc_soc_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nint ret;\r\nif ((ret = ohci_init(ohci)) < 0)\r\nreturn ret;\r\nif ((ret = ohci_run(ohci)) < 0) {\r\nerr("can't start %s", ohci_to_hcd(ohci)->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_hcd_ppc_soc_drv_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nret = usb_hcd_ppc_soc_probe(&ohci_ppc_soc_hc_driver, pdev);\r\nreturn ret;\r\n}\r\nstatic int ohci_hcd_ppc_soc_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_hcd_ppc_soc_remove(hcd, pdev);\r\nreturn 0;\r\n}

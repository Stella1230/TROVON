static int wl1251_event_scan_complete(struct wl1251 *wl,\r\nstruct event_mailbox *mbox)\r\n{\r\nwl1251_debug(DEBUG_EVENT, "status: 0x%x, channels: %d",\r\nmbox->scheduled_scan_status,\r\nmbox->scheduled_scan_channels);\r\nif (wl->scanning) {\r\nieee80211_scan_completed(wl->hw, false);\r\nwl1251_debug(DEBUG_MAC80211, "mac80211 hw scan completed");\r\nwl->scanning = false;\r\n}\r\nreturn 0;\r\n}\r\nstatic void wl1251_event_mbox_dump(struct event_mailbox *mbox)\r\n{\r\nwl1251_debug(DEBUG_EVENT, "MBOX DUMP:");\r\nwl1251_debug(DEBUG_EVENT, "\tvector: 0x%x", mbox->events_vector);\r\nwl1251_debug(DEBUG_EVENT, "\tmask: 0x%x", mbox->events_mask);\r\n}\r\nstatic int wl1251_event_process(struct wl1251 *wl, struct event_mailbox *mbox)\r\n{\r\nint ret;\r\nu32 vector;\r\nwl1251_event_mbox_dump(mbox);\r\nvector = mbox->events_vector & ~(mbox->events_mask);\r\nwl1251_debug(DEBUG_EVENT, "vector: 0x%x", vector);\r\nif (vector & SCAN_COMPLETE_EVENT_ID) {\r\nret = wl1251_event_scan_complete(wl, mbox);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (vector & BSS_LOSE_EVENT_ID) {\r\nwl1251_debug(DEBUG_EVENT, "BSS_LOSE_EVENT");\r\nif (wl->psm_requested &&\r\nwl->station_mode != STATION_ACTIVE_MODE) {\r\nret = wl1251_ps_set_mode(wl, STATION_ACTIVE_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\nif (vector & SYNCHRONIZATION_TIMEOUT_EVENT_ID &&\r\nwl->station_mode != STATION_ACTIVE_MODE) {\r\nwl1251_debug(DEBUG_EVENT, "SYNCHRONIZATION_TIMEOUT_EVENT");\r\nieee80211_beacon_loss(wl->vif);\r\n}\r\nif (vector & REGAINED_BSS_EVENT_ID) {\r\nif (wl->psm_requested) {\r\nret = wl1251_ps_set_mode(wl, STATION_POWER_SAVE_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\n}\r\nif (wl->vif && wl->rssi_thold) {\r\nif (vector & ROAMING_TRIGGER_LOW_RSSI_EVENT_ID) {\r\nwl1251_debug(DEBUG_EVENT,\r\n"ROAMING_TRIGGER_LOW_RSSI_EVENT");\r\nieee80211_cqm_rssi_notify(wl->vif,\r\nNL80211_CQM_RSSI_THRESHOLD_EVENT_LOW,\r\nGFP_KERNEL);\r\n}\r\nif (vector & ROAMING_TRIGGER_REGAINED_RSSI_EVENT_ID) {\r\nwl1251_debug(DEBUG_EVENT,\r\n"ROAMING_TRIGGER_REGAINED_RSSI_EVENT");\r\nieee80211_cqm_rssi_notify(wl->vif,\r\nNL80211_CQM_RSSI_THRESHOLD_EVENT_HIGH,\r\nGFP_KERNEL);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint wl1251_event_wait(struct wl1251 *wl, u32 mask, int timeout_ms)\r\n{\r\nu32 events_vector, event;\r\nunsigned long timeout;\r\ntimeout = jiffies + msecs_to_jiffies(timeout_ms);\r\ndo {\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIMEDOUT;\r\nmsleep(1);\r\nwl1251_mem_read(wl, wl->mbox_ptr[0], &events_vector,\r\nsizeof(events_vector));\r\nevent = events_vector & mask;\r\nwl1251_mem_read(wl, wl->mbox_ptr[1], &events_vector,\r\nsizeof(events_vector));\r\nevent |= events_vector & mask;\r\n} while (!event);\r\nreturn 0;\r\n}\r\nint wl1251_event_unmask(struct wl1251 *wl)\r\n{\r\nint ret;\r\nret = wl1251_acx_event_mbox_mask(wl, ~(wl->event_mask));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nvoid wl1251_event_mbox_config(struct wl1251 *wl)\r\n{\r\nwl->mbox_ptr[0] = wl1251_reg_read32(wl, REG_EVENT_MAILBOX_PTR);\r\nwl->mbox_ptr[1] = wl->mbox_ptr[0] + sizeof(struct event_mailbox);\r\nwl1251_debug(DEBUG_EVENT, "MBOX ptrs: 0x%x 0x%x",\r\nwl->mbox_ptr[0], wl->mbox_ptr[1]);\r\n}\r\nint wl1251_event_handle(struct wl1251 *wl, u8 mbox_num)\r\n{\r\nstruct event_mailbox mbox;\r\nint ret;\r\nwl1251_debug(DEBUG_EVENT, "EVENT on mbox %d", mbox_num);\r\nif (mbox_num > 1)\r\nreturn -EINVAL;\r\nwl1251_mem_read(wl, wl->mbox_ptr[mbox_num], &mbox,\r\nsizeof(struct event_mailbox));\r\nret = wl1251_event_process(wl, &mbox);\r\nif (ret < 0)\r\nreturn ret;\r\nwl1251_reg_write32(wl, ACX_REG_INTERRUPT_TRIG, INTR_TRIG_EVENT_ACK);\r\nreturn 0;\r\n}

static void sam9_smc_cs_write_mode(void __iomem *base,\r\nstruct sam9_smc_config *config)\r\n{\r\n__raw_writel(config->mode\r\n| AT91_SMC_TDF_(config->tdf_cycles),\r\nbase + AT91_SMC_MODE);\r\n}\r\nvoid sam9_smc_write_mode(int id, int cs,\r\nstruct sam9_smc_config *config)\r\n{\r\nsam9_smc_cs_write_mode(AT91_SMC_CS(id, cs), config);\r\n}\r\nstatic void sam9_smc_cs_configure(void __iomem *base,\r\nstruct sam9_smc_config *config)\r\n{\r\n__raw_writel(AT91_SMC_NWESETUP_(config->nwe_setup)\r\n| AT91_SMC_NCS_WRSETUP_(config->ncs_write_setup)\r\n| AT91_SMC_NRDSETUP_(config->nrd_setup)\r\n| AT91_SMC_NCS_RDSETUP_(config->ncs_read_setup),\r\nbase + AT91_SMC_SETUP);\r\n__raw_writel(AT91_SMC_NWEPULSE_(config->nwe_pulse)\r\n| AT91_SMC_NCS_WRPULSE_(config->ncs_write_pulse)\r\n| AT91_SMC_NRDPULSE_(config->nrd_pulse)\r\n| AT91_SMC_NCS_RDPULSE_(config->ncs_read_pulse),\r\nbase + AT91_SMC_PULSE);\r\n__raw_writel(AT91_SMC_NWECYCLE_(config->write_cycle)\r\n| AT91_SMC_NRDCYCLE_(config->read_cycle),\r\nbase + AT91_SMC_CYCLE);\r\nsam9_smc_cs_write_mode(base, config);\r\n}\r\nvoid sam9_smc_configure(int id, int cs,\r\nstruct sam9_smc_config *config)\r\n{\r\nsam9_smc_cs_configure(AT91_SMC_CS(id, cs), config);\r\n}\r\nstatic void sam9_smc_cs_read_mode(void __iomem *base,\r\nstruct sam9_smc_config *config)\r\n{\r\nu32 val = __raw_readl(base + AT91_SMC_MODE);\r\nconfig->mode = (val & ~AT91_SMC_NWECYCLE);\r\nconfig->tdf_cycles = (val & AT91_SMC_NWECYCLE) >> 16 ;\r\n}\r\nvoid sam9_smc_read_mode(int id, int cs,\r\nstruct sam9_smc_config *config)\r\n{\r\nsam9_smc_cs_read_mode(AT91_SMC_CS(id, cs), config);\r\n}\r\nstatic void sam9_smc_cs_read(void __iomem *base,\r\nstruct sam9_smc_config *config)\r\n{\r\nu32 val;\r\nval = __raw_readl(base + AT91_SMC_SETUP);\r\nconfig->nwe_setup = val & AT91_SMC_NWESETUP;\r\nconfig->ncs_write_setup = (val & AT91_SMC_NCS_WRSETUP) >> 8;\r\nconfig->nrd_setup = (val & AT91_SMC_NRDSETUP) >> 16;\r\nconfig->ncs_read_setup = (val & AT91_SMC_NCS_RDSETUP) >> 24;\r\nval = __raw_readl(base + AT91_SMC_PULSE);\r\nconfig->nwe_setup = val & AT91_SMC_NWEPULSE;\r\nconfig->ncs_write_pulse = (val & AT91_SMC_NCS_WRPULSE) >> 8;\r\nconfig->nrd_pulse = (val & AT91_SMC_NRDPULSE) >> 16;\r\nconfig->ncs_read_pulse = (val & AT91_SMC_NCS_RDPULSE) >> 24;\r\nval = __raw_readl(base + AT91_SMC_CYCLE);\r\nconfig->write_cycle = val & AT91_SMC_NWECYCLE;\r\nconfig->read_cycle = (val & AT91_SMC_NRDCYCLE) >> 16;\r\nsam9_smc_cs_read_mode(base, config);\r\n}\r\nvoid sam9_smc_read(int id, int cs, struct sam9_smc_config *config)\r\n{\r\nsam9_smc_cs_read(AT91_SMC_CS(id, cs), config);\r\n}\r\nvoid __init at91sam9_ioremap_smc(int id, u32 addr)\r\n{\r\nif (id > 1) {\r\npr_warn("%s: id > 2\n", __func__);\r\nreturn;\r\n}\r\nsmc_base_addr[id] = ioremap(addr, 512);\r\nif (!smc_base_addr[id])\r\npr_warn("Impossible to ioremap smc.%d 0x%x\n", id, addr);\r\n}

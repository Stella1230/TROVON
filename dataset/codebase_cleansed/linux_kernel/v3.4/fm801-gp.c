static int fm801_gp_cooked_read(struct gameport *gameport, int *axes, int *buttons)\r\n{\r\nunsigned short w;\r\nw = inw(gameport->io + 2);\r\n*buttons = (~w >> 14) & 0x03;\r\naxes[0] = (w == 0xffff) ? -1 : ((w & 0x1fff) << 5);\r\nw = inw(gameport->io + 4);\r\naxes[1] = (w == 0xffff) ? -1 : ((w & 0x1fff) << 5);\r\nw = inw(gameport->io + 6);\r\n*buttons |= ((~w >> 14) & 0x03) << 2;\r\naxes[2] = (w == 0xffff) ? -1 : ((w & 0x1fff) << 5);\r\nw = inw(gameport->io + 8);\r\naxes[3] = (w == 0xffff) ? -1 : ((w & 0x1fff) << 5);\r\noutw(0xff, gameport->io);\r\nreturn 0;\r\n}\r\nstatic int fm801_gp_open(struct gameport *gameport, int mode)\r\n{\r\nswitch (mode) {\r\n#ifdef HAVE_COOKED\r\ncase GAMEPORT_MODE_COOKED:\r\nreturn 0;\r\n#endif\r\ncase GAMEPORT_MODE_RAW:\r\nreturn 0;\r\ndefault:\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit fm801_gp_probe(struct pci_dev *pci, const struct pci_device_id *id)\r\n{\r\nstruct fm801_gp *gp;\r\nstruct gameport *port;\r\nint error;\r\ngp = kzalloc(sizeof(struct fm801_gp), GFP_KERNEL);\r\nport = gameport_allocate_port();\r\nif (!gp || !port) {\r\nprintk(KERN_ERR "fm801-gp: Memory allocation failed\n");\r\nerror = -ENOMEM;\r\ngoto err_out_free;\r\n}\r\nerror = pci_enable_device(pci);\r\nif (error)\r\ngoto err_out_free;\r\nport->open = fm801_gp_open;\r\n#ifdef HAVE_COOKED\r\nport->cooked_read = fm801_gp_cooked_read;\r\n#endif\r\ngameport_set_name(port, "FM801");\r\ngameport_set_phys(port, "pci%s/gameport0", pci_name(pci));\r\nport->dev.parent = &pci->dev;\r\nport->io = pci_resource_start(pci, 0);\r\ngp->gameport = port;\r\ngp->res_port = request_region(port->io, 0x10, "FM801 GP");\r\nif (!gp->res_port) {\r\nprintk(KERN_DEBUG "fm801-gp: unable to grab region 0x%x-0x%x\n",\r\nport->io, port->io + 0x0f);\r\nerror = -EBUSY;\r\ngoto err_out_disable_dev;\r\n}\r\npci_set_drvdata(pci, gp);\r\noutb(0x60, port->io + 0x0d);\r\ngameport_register_port(port);\r\nreturn 0;\r\nerr_out_disable_dev:\r\npci_disable_device(pci);\r\nerr_out_free:\r\ngameport_free_port(port);\r\nkfree(gp);\r\nreturn error;\r\n}\r\nstatic void __devexit fm801_gp_remove(struct pci_dev *pci)\r\n{\r\nstruct fm801_gp *gp = pci_get_drvdata(pci);\r\ngameport_unregister_port(gp->gameport);\r\nrelease_resource(gp->res_port);\r\nkfree(gp);\r\npci_disable_device(pci);\r\n}\r\nstatic int __init fm801_gp_init(void)\r\n{\r\nreturn pci_register_driver(&fm801_gp_driver);\r\n}\r\nstatic void __exit fm801_gp_exit(void)\r\n{\r\npci_unregister_driver(&fm801_gp_driver);\r\n}

int fsl_udc_clk_init(struct platform_device *pdev)\r\n{\r\nstruct fsl_usb2_platform_data *pdata;\r\nunsigned long freq;\r\nint ret;\r\npdata = pdev->dev.platform_data;\r\nif (!cpu_is_mx35() && !cpu_is_mx25()) {\r\nmxc_ahb_clk = clk_get(&pdev->dev, "usb_ahb");\r\nif (IS_ERR(mxc_ahb_clk))\r\nreturn PTR_ERR(mxc_ahb_clk);\r\nret = clk_enable(mxc_ahb_clk);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "clk_enable(\"usb_ahb\") failed\n");\r\ngoto eenahb;\r\n}\r\n}\r\nmxc_usb_clk = clk_get(&pdev->dev, "usb");\r\nif (IS_ERR(mxc_usb_clk)) {\r\ndev_err(&pdev->dev, "clk_get(\"usb\") failed\n");\r\nret = PTR_ERR(mxc_usb_clk);\r\ngoto egusb;\r\n}\r\nif (!cpu_is_mx51()) {\r\nfreq = clk_get_rate(mxc_usb_clk);\r\nif (pdata->phy_mode != FSL_USB2_PHY_ULPI &&\r\n(freq < 59999000 || freq > 60001000)) {\r\ndev_err(&pdev->dev, "USB_CLK=%lu, should be 60MHz\n", freq);\r\nret = -EINVAL;\r\ngoto eclkrate;\r\n}\r\n}\r\nret = clk_enable(mxc_usb_clk);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "clk_enable(\"usb_clk\") failed\n");\r\ngoto eenusb;\r\n}\r\nreturn 0;\r\neenusb:\r\neclkrate:\r\nclk_put(mxc_usb_clk);\r\nmxc_usb_clk = NULL;\r\negusb:\r\nif (!cpu_is_mx35())\r\nclk_disable(mxc_ahb_clk);\r\neenahb:\r\nif (!cpu_is_mx35())\r\nclk_put(mxc_ahb_clk);\r\nreturn ret;\r\n}\r\nvoid fsl_udc_clk_finalize(struct platform_device *pdev)\r\n{\r\nstruct fsl_usb2_platform_data *pdata = pdev->dev.platform_data;\r\nif (cpu_is_mx35()) {\r\nunsigned int v;\r\nif (pdata->workaround & FLS_USB2_WORKAROUND_ENGCM09152) {\r\nv = readl(MX35_IO_ADDRESS(MX35_USB_BASE_ADDR +\r\nUSBPHYCTRL_OTGBASE_OFFSET));\r\nwritel(v | USBPHYCTRL_EVDO,\r\nMX35_IO_ADDRESS(MX35_USB_BASE_ADDR +\r\nUSBPHYCTRL_OTGBASE_OFFSET));\r\n}\r\n}\r\nif (pdata->phy_mode == FSL_USB2_PHY_ULPI) {\r\nclk_disable(mxc_usb_clk);\r\nclk_put(mxc_usb_clk);\r\nmxc_usb_clk = NULL;\r\n}\r\n}\r\nvoid fsl_udc_clk_release(void)\r\n{\r\nif (mxc_usb_clk) {\r\nclk_disable(mxc_usb_clk);\r\nclk_put(mxc_usb_clk);\r\n}\r\nif (!cpu_is_mx35()) {\r\nclk_disable(mxc_ahb_clk);\r\nclk_put(mxc_ahb_clk);\r\n}\r\n}

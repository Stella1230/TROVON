void\r\nvxfs_dumpi(struct vxfs_inode_info *vip, ino_t ino)\r\n{\r\nprintk(KERN_DEBUG "\n\n");\r\nif (ino)\r\nprintk(KERN_DEBUG "dumping vxfs inode %ld\n", ino);\r\nelse\r\nprintk(KERN_DEBUG "dumping unknown vxfs inode\n");\r\nprintk(KERN_DEBUG "---------------------------\n");\r\nprintk(KERN_DEBUG "mode is %x\n", vip->vii_mode);\r\nprintk(KERN_DEBUG "nlink:%u, uid:%u, gid:%u\n",\r\nvip->vii_nlink, vip->vii_uid, vip->vii_gid);\r\nprintk(KERN_DEBUG "size:%Lx, blocks:%u\n",\r\nvip->vii_size, vip->vii_blocks);\r\nprintk(KERN_DEBUG "orgtype:%u\n", vip->vii_orgtype);\r\n}\r\nstruct vxfs_inode_info *\r\nvxfs_blkiget(struct super_block *sbp, u_long extent, ino_t ino)\r\n{\r\nstruct buffer_head *bp;\r\nu_long block, offset;\r\nblock = extent + ((ino * VXFS_ISIZE) / sbp->s_blocksize);\r\noffset = ((ino % (sbp->s_blocksize / VXFS_ISIZE)) * VXFS_ISIZE);\r\nbp = sb_bread(sbp, block);\r\nif (bp && buffer_mapped(bp)) {\r\nstruct vxfs_inode_info *vip;\r\nstruct vxfs_dinode *dip;\r\nif (!(vip = kmem_cache_alloc(vxfs_inode_cachep, GFP_KERNEL)))\r\ngoto fail;\r\ndip = (struct vxfs_dinode *)(bp->b_data + offset);\r\nmemcpy(vip, dip, sizeof(*vip));\r\n#ifdef DIAGNOSTIC\r\nvxfs_dumpi(vip, ino);\r\n#endif\r\nbrelse(bp);\r\nreturn (vip);\r\n}\r\nfail:\r\nprintk(KERN_WARNING "vxfs: unable to read block %ld\n", block);\r\nbrelse(bp);\r\nreturn NULL;\r\n}\r\nstatic struct vxfs_inode_info *\r\n__vxfs_iget(ino_t ino, struct inode *ilistp)\r\n{\r\nstruct page *pp;\r\nu_long offset;\r\noffset = (ino % (PAGE_SIZE / VXFS_ISIZE)) * VXFS_ISIZE;\r\npp = vxfs_get_page(ilistp->i_mapping, ino * VXFS_ISIZE / PAGE_SIZE);\r\nif (!IS_ERR(pp)) {\r\nstruct vxfs_inode_info *vip;\r\nstruct vxfs_dinode *dip;\r\ncaddr_t kaddr = (char *)page_address(pp);\r\nif (!(vip = kmem_cache_alloc(vxfs_inode_cachep, GFP_KERNEL)))\r\ngoto fail;\r\ndip = (struct vxfs_dinode *)(kaddr + offset);\r\nmemcpy(vip, dip, sizeof(*vip));\r\n#ifdef DIAGNOSTIC\r\nvxfs_dumpi(vip, ino);\r\n#endif\r\nvxfs_put_page(pp);\r\nreturn (vip);\r\n}\r\nprintk(KERN_WARNING "vxfs: error on page %p\n", pp);\r\nreturn ERR_CAST(pp);\r\nfail:\r\nprintk(KERN_WARNING "vxfs: unable to read inode %ld\n", (unsigned long)ino);\r\nvxfs_put_page(pp);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nstruct vxfs_inode_info *\r\nvxfs_stiget(struct super_block *sbp, ino_t ino)\r\n{\r\nstruct vxfs_inode_info *vip;\r\nvip = __vxfs_iget(ino, VXFS_SBI(sbp)->vsi_stilist);\r\nreturn IS_ERR(vip) ? NULL : vip;\r\n}\r\nstatic __inline__ umode_t\r\nvxfs_transmod(struct vxfs_inode_info *vip)\r\n{\r\numode_t ret = vip->vii_mode & ~VXFS_TYPE_MASK;\r\nif (VXFS_ISFIFO(vip))\r\nret |= S_IFIFO;\r\nif (VXFS_ISCHR(vip))\r\nret |= S_IFCHR;\r\nif (VXFS_ISDIR(vip))\r\nret |= S_IFDIR;\r\nif (VXFS_ISBLK(vip))\r\nret |= S_IFBLK;\r\nif (VXFS_ISLNK(vip))\r\nret |= S_IFLNK;\r\nif (VXFS_ISREG(vip))\r\nret |= S_IFREG;\r\nif (VXFS_ISSOC(vip))\r\nret |= S_IFSOCK;\r\nreturn (ret);\r\n}\r\nstatic void\r\nvxfs_iinit(struct inode *ip, struct vxfs_inode_info *vip)\r\n{\r\nip->i_mode = vxfs_transmod(vip);\r\nip->i_uid = (uid_t)vip->vii_uid;\r\nip->i_gid = (gid_t)vip->vii_gid;\r\nset_nlink(ip, vip->vii_nlink);\r\nip->i_size = vip->vii_size;\r\nip->i_atime.tv_sec = vip->vii_atime;\r\nip->i_ctime.tv_sec = vip->vii_ctime;\r\nip->i_mtime.tv_sec = vip->vii_mtime;\r\nip->i_atime.tv_nsec = 0;\r\nip->i_ctime.tv_nsec = 0;\r\nip->i_mtime.tv_nsec = 0;\r\nip->i_blocks = vip->vii_blocks;\r\nip->i_generation = vip->vii_gen;\r\nip->i_private = vip;\r\n}\r\nstruct inode *\r\nvxfs_get_fake_inode(struct super_block *sbp, struct vxfs_inode_info *vip)\r\n{\r\nstruct inode *ip = NULL;\r\nif ((ip = new_inode(sbp))) {\r\nip->i_ino = get_next_ino();\r\nvxfs_iinit(ip, vip);\r\nip->i_mapping->a_ops = &vxfs_aops;\r\n}\r\nreturn (ip);\r\n}\r\nvoid\r\nvxfs_put_fake_inode(struct inode *ip)\r\n{\r\niput(ip);\r\n}\r\nstruct inode *\r\nvxfs_iget(struct super_block *sbp, ino_t ino)\r\n{\r\nstruct vxfs_inode_info *vip;\r\nconst struct address_space_operations *aops;\r\nstruct inode *ip;\r\nip = iget_locked(sbp, ino);\r\nif (!ip)\r\nreturn ERR_PTR(-ENOMEM);\r\nif (!(ip->i_state & I_NEW))\r\nreturn ip;\r\nvip = __vxfs_iget(ino, VXFS_SBI(sbp)->vsi_ilist);\r\nif (IS_ERR(vip)) {\r\niget_failed(ip);\r\nreturn ERR_CAST(vip);\r\n}\r\nvxfs_iinit(ip, vip);\r\nif (VXFS_ISIMMED(vip))\r\naops = &vxfs_immed_aops;\r\nelse\r\naops = &vxfs_aops;\r\nif (S_ISREG(ip->i_mode)) {\r\nip->i_fop = &generic_ro_fops;\r\nip->i_mapping->a_ops = aops;\r\n} else if (S_ISDIR(ip->i_mode)) {\r\nip->i_op = &vxfs_dir_inode_ops;\r\nip->i_fop = &vxfs_dir_operations;\r\nip->i_mapping->a_ops = aops;\r\n} else if (S_ISLNK(ip->i_mode)) {\r\nif (!VXFS_ISIMMED(vip)) {\r\nip->i_op = &page_symlink_inode_operations;\r\nip->i_mapping->a_ops = &vxfs_aops;\r\n} else {\r\nip->i_op = &vxfs_immed_symlink_iops;\r\nvip->vii_immed.vi_immed[ip->i_size] = '\0';\r\n}\r\n} else\r\ninit_special_inode(ip, ip->i_mode, old_decode_dev(vip->vii_rdev));\r\nunlock_new_inode(ip);\r\nreturn ip;\r\n}\r\nstatic void vxfs_i_callback(struct rcu_head *head)\r\n{\r\nstruct inode *inode = container_of(head, struct inode, i_rcu);\r\nkmem_cache_free(vxfs_inode_cachep, inode->i_private);\r\n}\r\nvoid\r\nvxfs_evict_inode(struct inode *ip)\r\n{\r\ntruncate_inode_pages(&ip->i_data, 0);\r\nend_writeback(ip);\r\ncall_rcu(&ip->i_rcu, vxfs_i_callback);\r\n}

void viafb_get_device_support_state(u32 *support_state)\r\n{\r\n*support_state = CRT_Device;\r\nif (viaparinfo->chip_info->tmds_chip_info.tmds_chip_name == VT1632_TMDS)\r\n*support_state |= DVI_Device;\r\nif (viaparinfo->chip_info->lvds_chip_info.lvds_chip_name == VT1631_LVDS)\r\n*support_state |= LCD_Device;\r\n}\r\nvoid viafb_get_device_connect_state(u32 *connect_state)\r\n{\r\nbool mobile = false;\r\n*connect_state = CRT_Device;\r\nif (viafb_dvi_sense())\r\n*connect_state |= DVI_Device;\r\nviafb_lcd_get_mobile_state(&mobile);\r\nif (mobile)\r\n*connect_state |= LCD_Device;\r\n}\r\nbool viafb_lcd_get_support_expand_state(u32 xres, u32 yres)\r\n{\r\nunsigned int support_state = 0;\r\nswitch (viafb_lcd_panel_id) {\r\ncase LCD_PANEL_ID0_640X480:\r\nif ((xres < 640) && (yres < 480))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID1_800X600:\r\nif ((xres < 800) && (yres < 600))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID2_1024X768:\r\nif ((xres < 1024) && (yres < 768))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID3_1280X768:\r\nif ((xres < 1280) && (yres < 768))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID4_1280X1024:\r\nif ((xres < 1280) && (yres < 1024))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID5_1400X1050:\r\nif ((xres < 1400) && (yres < 1050))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID6_1600X1200:\r\nif ((xres < 1600) && (yres < 1200))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID7_1366X768:\r\nif ((xres < 1366) && (yres < 768))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID8_1024X600:\r\nif ((xres < 1024) && (yres < 600))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_ID9_1280X800:\r\nif ((xres < 1280) && (yres < 800))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_IDA_800X480:\r\nif ((xres < 800) && (yres < 480))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_IDB_1360X768:\r\nif ((xres < 1360) && (yres < 768))\r\nsupport_state = true;\r\nbreak;\r\ncase LCD_PANEL_IDC_480X640:\r\nif ((xres < 480) && (yres < 640))\r\nsupport_state = true;\r\nbreak;\r\ndefault:\r\nsupport_state = false;\r\nbreak;\r\n}\r\nreturn support_state;\r\n}\r\nvoid viafb_set_gamma_table(int bpp, unsigned int *gamma_table)\r\n{\r\nint i, sr1a;\r\nint active_device_amount = 0;\r\nint device_status = viafb_DeviceStatus;\r\nfor (i = 0; i < sizeof(viafb_DeviceStatus) * 8; i++) {\r\nif (device_status & 1)\r\nactive_device_amount++;\r\ndevice_status >>= 1;\r\n}\r\nif (bpp == 8)\r\nreturn ;\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_CLE266:\r\ncase UNICHROME_K400:\r\nviafb_write_reg_mask(SR16, VIASR, 0x80, BIT7);\r\nbreak;\r\ncase UNICHROME_K800:\r\ncase UNICHROME_PM800:\r\ncase UNICHROME_CN700:\r\ncase UNICHROME_CX700:\r\ncase UNICHROME_K8M890:\r\ncase UNICHROME_P4M890:\r\ncase UNICHROME_P4M900:\r\nviafb_write_reg_mask(CR33, VIACR, 0x80, BIT7);\r\nbreak;\r\n}\r\nsr1a = (unsigned int)viafb_read_reg(VIASR, SR1A);\r\nviafb_write_reg_mask(SR1A, VIASR, 0x0, BIT0);\r\noutb(0, LUT_INDEX_WRITE);\r\nfor (i = 0; i < 256; i++) {\r\noutb(gamma_table[i] >> 16, LUT_DATA);\r\noutb(gamma_table[i] >> 8 & 0xFF, LUT_DATA);\r\noutb(gamma_table[i] & 0xFF, LUT_DATA);\r\n}\r\nif ((active_device_amount > 1) &&\r\n!((viaparinfo->chip_info->gfx_chip_name ==\r\nUNICHROME_CLE266) &&\r\n(viaparinfo->chip_info->gfx_chip_revision < 15))) {\r\nviafb_write_reg_mask(SR1A, VIASR, 0x01, BIT0);\r\nviafb_write_reg_mask(CR6A, VIACR, 0x02, BIT1);\r\noutb(0, LUT_INDEX_WRITE);\r\nfor (i = 0; i < 256; i++) {\r\noutb(gamma_table[i] >> 16, LUT_DATA);\r\noutb(gamma_table[i] >> 8 & 0xFF, LUT_DATA);\r\noutb(gamma_table[i] & 0xFF, LUT_DATA);\r\n}\r\n}\r\nviafb_write_reg(SR1A, VIASR, sr1a);\r\n}\r\nvoid viafb_get_gamma_table(unsigned int *gamma_table)\r\n{\r\nunsigned char color_r, color_g, color_b;\r\nunsigned char sr1a = 0;\r\nint i;\r\nswitch (viaparinfo->chip_info->gfx_chip_name) {\r\ncase UNICHROME_CLE266:\r\ncase UNICHROME_K400:\r\nviafb_write_reg_mask(SR16, VIASR, 0x80, BIT7);\r\nbreak;\r\ncase UNICHROME_K800:\r\ncase UNICHROME_PM800:\r\ncase UNICHROME_CN700:\r\ncase UNICHROME_CX700:\r\ncase UNICHROME_K8M890:\r\ncase UNICHROME_P4M890:\r\ncase UNICHROME_P4M900:\r\nviafb_write_reg_mask(CR33, VIACR, 0x80, BIT7);\r\nbreak;\r\n}\r\nsr1a = viafb_read_reg(VIASR, SR1A);\r\nviafb_write_reg_mask(SR1A, VIASR, 0x0, BIT0);\r\noutb(0, LUT_INDEX_READ);\r\nfor (i = 0; i < 256; i++) {\r\ncolor_r = inb(LUT_DATA);\r\ncolor_g = inb(LUT_DATA);\r\ncolor_b = inb(LUT_DATA);\r\ngamma_table[i] =\r\n((((u32) color_r) << 16) |\r\n(((u16) color_g) << 8)) | color_b;\r\n}\r\nviafb_write_reg(SR1A, VIASR, sr1a);\r\n}\r\nvoid viafb_get_gamma_support_state(int bpp, unsigned int *support_state)\r\n{\r\nif (bpp == 8)\r\n*support_state = None_Device;\r\nelse\r\n*support_state = CRT_Device | DVI_Device | LCD_Device;\r\n}

static void __clk_disable(struct clk *clk)\r\n{\r\nif (clk == NULL || IS_ERR(clk))\r\nreturn;\r\nWARN_ON(!clk->usecount);\r\nif (!(--clk->usecount)) {\r\nif (clk->disable)\r\nclk->disable(clk);\r\n__clk_disable(clk->parent);\r\n__clk_disable(clk->secondary);\r\n}\r\n}\r\nstatic int __clk_enable(struct clk *clk)\r\n{\r\nif (clk == NULL || IS_ERR(clk))\r\nreturn -EINVAL;\r\nif (clk->usecount++ == 0) {\r\n__clk_enable(clk->parent);\r\n__clk_enable(clk->secondary);\r\nif (clk->enable)\r\nclk->enable(clk);\r\n}\r\nreturn 0;\r\n}\r\nint clk_enable(struct clk *clk)\r\n{\r\nint ret = 0;\r\nif (clk == NULL || IS_ERR(clk))\r\nreturn -EINVAL;\r\nmutex_lock(&clocks_mutex);\r\nret = __clk_enable(clk);\r\nmutex_unlock(&clocks_mutex);\r\nreturn ret;\r\n}\r\nvoid clk_disable(struct clk *clk)\r\n{\r\nif (clk == NULL || IS_ERR(clk))\r\nreturn;\r\nmutex_lock(&clocks_mutex);\r\n__clk_disable(clk);\r\nmutex_unlock(&clocks_mutex);\r\n}\r\nunsigned long clk_get_rate(struct clk *clk)\r\n{\r\nif (clk == NULL || IS_ERR(clk))\r\nreturn 0UL;\r\nif (clk->get_rate)\r\nreturn clk->get_rate(clk);\r\nreturn clk_get_rate(clk->parent);\r\n}\r\nlong clk_round_rate(struct clk *clk, unsigned long rate)\r\n{\r\nif (clk == NULL || IS_ERR(clk) || !clk->round_rate)\r\nreturn 0;\r\nreturn clk->round_rate(clk, rate);\r\n}\r\nint clk_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nint ret = -EINVAL;\r\nif (clk == NULL || IS_ERR(clk) || clk->set_rate == NULL || rate == 0)\r\nreturn ret;\r\nmutex_lock(&clocks_mutex);\r\nret = clk->set_rate(clk, rate);\r\nmutex_unlock(&clocks_mutex);\r\nreturn ret;\r\n}\r\nint clk_set_parent(struct clk *clk, struct clk *parent)\r\n{\r\nint ret = -EINVAL;\r\nstruct clk *old;\r\nif (clk == NULL || IS_ERR(clk) || parent == NULL ||\r\nIS_ERR(parent) || clk->set_parent == NULL)\r\nreturn ret;\r\nif (clk->usecount)\r\nclk_enable(parent);\r\nmutex_lock(&clocks_mutex);\r\nret = clk->set_parent(clk, parent);\r\nif (ret == 0) {\r\nold = clk->parent;\r\nclk->parent = parent;\r\n} else {\r\nold = parent;\r\n}\r\nmutex_unlock(&clocks_mutex);\r\nif (clk->usecount)\r\nclk_disable(old);\r\nreturn ret;\r\n}\r\nstruct clk *clk_get_parent(struct clk *clk)\r\n{\r\nstruct clk *ret = NULL;\r\nif (clk == NULL || IS_ERR(clk))\r\nreturn ret;\r\nreturn clk->parent;\r\n}\r\nunsigned long mxc_decode_pll(unsigned int reg_val, u32 freq)\r\n{\r\nlong long ll;\r\nint mfn_abs;\r\nunsigned int mfi, mfn, mfd, pd;\r\nmfi = (reg_val >> 10) & 0xf;\r\nmfn = reg_val & 0x3ff;\r\nmfd = (reg_val >> 16) & 0x3ff;\r\npd = (reg_val >> 26) & 0xf;\r\nmfi = mfi <= 5 ? 5 : mfi;\r\nmfn_abs = mfn;\r\nif (!cpu_is_mx1() && !cpu_is_mx21() && mfn >= 0x200)\r\nmfn_abs = 0x400 - mfn;\r\nfreq *= 2;\r\nfreq /= pd + 1;\r\nll = (unsigned long long)freq * mfn_abs;\r\ndo_div(ll, mfd + 1);\r\nif (!cpu_is_mx1() && !cpu_is_mx21() && mfn >= 0x200)\r\nll = -ll;\r\nll = (freq * mfi) + ll;\r\nreturn ll;\r\n}

static void sun4c_mask_irq(struct irq_data *data)\r\n{\r\nunsigned long mask = (unsigned long)data->chip_data;\r\nif (mask) {\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nmask = sbus_readb(interrupt_enable) & ~mask;\r\nsbus_writeb(mask, interrupt_enable);\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nstatic void sun4c_unmask_irq(struct irq_data *data)\r\n{\r\nunsigned long mask = (unsigned long)data->chip_data;\r\nif (mask) {\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nmask = sbus_readb(interrupt_enable) | mask;\r\nsbus_writeb(mask, interrupt_enable);\r\nlocal_irq_restore(flags);\r\n}\r\n}\r\nstatic unsigned int sun4c_startup_irq(struct irq_data *data)\r\n{\r\nirq_link(data->irq);\r\nsun4c_unmask_irq(data);\r\nreturn 0;\r\n}\r\nstatic void sun4c_shutdown_irq(struct irq_data *data)\r\n{\r\nsun4c_mask_irq(data);\r\nirq_unlink(data->irq);\r\n}\r\nstatic unsigned int sun4c_build_device_irq(struct platform_device *op,\r\nunsigned int real_irq)\r\n{\r\nunsigned int irq;\r\nif (real_irq >= 16) {\r\nprom_printf("Bogus sun4c IRQ %u\n", real_irq);\r\nprom_halt();\r\n}\r\nirq = irq_alloc(real_irq, real_irq);\r\nif (irq) {\r\nunsigned long mask = 0UL;\r\nswitch (real_irq) {\r\ncase 1:\r\nmask = SUN4C_INT_E1;\r\nbreak;\r\ncase 8:\r\nmask = SUN4C_INT_E8;\r\nbreak;\r\ncase 10:\r\nmask = SUN4C_INT_E10;\r\nbreak;\r\ncase 14:\r\nmask = SUN4C_INT_E14;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nirq_set_chip_and_handler_name(irq, &sun4c_irq,\r\nhandle_level_irq, "level");\r\nirq_set_chip_data(irq, (void *)mask);\r\n}\r\nreturn irq;\r\n}\r\nstatic void sun4c_clear_clock_irq(void)\r\n{\r\nsbus_readl(&sun4c_timers->l10_limit);\r\n}\r\nstatic void sun4c_load_profile_irq(int cpu, unsigned int limit)\r\n{\r\n}\r\nstatic void __init sun4c_init_timers(irq_handler_t counter_fn)\r\n{\r\nconst struct linux_prom_irqs *prom_irqs;\r\nstruct device_node *dp;\r\nunsigned int irq;\r\nconst u32 *addr;\r\nint err;\r\ndp = of_find_node_by_name(NULL, "counter-timer");\r\nif (!dp) {\r\nprom_printf("sun4c_init_timers: Unable to find counter-timer\n");\r\nprom_halt();\r\n}\r\naddr = of_get_property(dp, "address", NULL);\r\nif (!addr) {\r\nprom_printf("sun4c_init_timers: No address property\n");\r\nprom_halt();\r\n}\r\nsun4c_timers = (void __iomem *) (unsigned long) addr[0];\r\nprom_irqs = of_get_property(dp, "intr", NULL);\r\nof_node_put(dp);\r\nif (!prom_irqs) {\r\nprom_printf("sun4c_init_timers: No intr property\n");\r\nprom_halt();\r\n}\r\nsbus_writel((((1000000/HZ) + 1) << 10), &sun4c_timers->l10_limit);\r\nmaster_l10_counter = &sun4c_timers->l10_count;\r\nirq = sun4c_build_device_irq(NULL, prom_irqs[0].pri);\r\nerr = request_irq(irq, counter_fn, IRQF_TIMER, "timer", NULL);\r\nif (err) {\r\nprom_printf("sun4c_init_timers: request_irq() fails with %d\n", err);\r\nprom_halt();\r\n}\r\nsun4c_mask_irq(irq_get_irq_data(irq));\r\n}\r\nstatic void sun4c_nop(void)\r\n{\r\n}\r\nvoid __init sun4c_init_IRQ(void)\r\n{\r\nstruct device_node *dp;\r\nconst u32 *addr;\r\ndp = of_find_node_by_name(NULL, "interrupt-enable");\r\nif (!dp) {\r\nprom_printf("sun4c_init_IRQ: Unable to find interrupt-enable\n");\r\nprom_halt();\r\n}\r\naddr = of_get_property(dp, "address", NULL);\r\nof_node_put(dp);\r\nif (!addr) {\r\nprom_printf("sun4c_init_IRQ: No address property\n");\r\nprom_halt();\r\n}\r\ninterrupt_enable = (void __iomem *) (unsigned long) addr[0];\r\nBTFIXUPSET_CALL(clear_clock_irq, sun4c_clear_clock_irq, BTFIXUPCALL_NORM);\r\nBTFIXUPSET_CALL(load_profile_irq, sun4c_load_profile_irq, BTFIXUPCALL_NOP);\r\nsparc_irq_config.init_timers = sun4c_init_timers;\r\nsparc_irq_config.build_device_irq = sun4c_build_device_irq;\r\n#ifdef CONFIG_SMP\r\nBTFIXUPSET_CALL(set_cpu_int, sun4c_nop, BTFIXUPCALL_NOP);\r\nBTFIXUPSET_CALL(clear_cpu_int, sun4c_nop, BTFIXUPCALL_NOP);\r\nBTFIXUPSET_CALL(set_irq_udt, sun4c_nop, BTFIXUPCALL_NOP);\r\n#endif\r\nsbus_writeb(SUN4C_INT_ENABLE, interrupt_enable);\r\n}

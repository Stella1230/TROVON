void\r\nnv30_fb_init_tile_region(struct drm_device *dev, int i, uint32_t addr,\r\nuint32_t size, uint32_t pitch, uint32_t flags)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_tile_reg *tile = &dev_priv->tile.reg[i];\r\ntile->addr = addr | 1;\r\ntile->limit = max(1u, addr + size) - 1;\r\ntile->pitch = pitch;\r\n}\r\nvoid\r\nnv30_fb_free_tile_region(struct drm_device *dev, int i)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_tile_reg *tile = &dev_priv->tile.reg[i];\r\ntile->addr = tile->limit = tile->pitch = 0;\r\n}\r\nstatic int\r\ncalc_bias(struct drm_device *dev, int k, int i, int j)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nint b = (dev_priv->chipset > 0x30 ?\r\nnv_rd32(dev, 0x122c + 0x10 * k + 0x4 * j) >> (4 * (i ^ 1)) :\r\n0) & 0xf;\r\nreturn 2 * (b & 0x8 ? b - 0x10 : b);\r\n}\r\nstatic int\r\ncalc_ref(struct drm_device *dev, int l, int k, int i)\r\n{\r\nint j, x = 0;\r\nfor (j = 0; j < 4; j++) {\r\nint m = (l >> (8 * i) & 0xff) + calc_bias(dev, k, i, j);\r\nx |= (0x80 | clamp(m, 0, 0x1f)) << (8 * j);\r\n}\r\nreturn x;\r\n}\r\nint\r\nnv30_fb_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fb_engine *pfb = &dev_priv->engine.fb;\r\nint i, j;\r\npfb->num_tiles = NV10_PFB_TILE__SIZE;\r\nfor (i = 0; i < pfb->num_tiles; i++)\r\npfb->set_tile_region(dev, i);\r\nif (dev_priv->chipset == 0x30 ||\r\ndev_priv->chipset == 0x31 ||\r\ndev_priv->chipset == 0x35) {\r\nint n = (dev_priv->chipset == 0x31 ? 2 : 4);\r\nint l = nv_rd32(dev, 0x1003d0);\r\nfor (i = 0; i < n; i++) {\r\nfor (j = 0; j < 3; j++)\r\nnv_wr32(dev, 0x10037c + 0xc * i + 0x4 * j,\r\ncalc_ref(dev, l, 0, j));\r\nfor (j = 0; j < 2; j++)\r\nnv_wr32(dev, 0x1003ac + 0x8 * i + 0x4 * j,\r\ncalc_ref(dev, l, 1, j));\r\n}\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nnv30_fb_takedown(struct drm_device *dev)\r\n{\r\n}

static void *fd_init(char *str, int device, const struct chan_opts *opts)\r\n{\r\nstruct fd_chan *data;\r\nchar *end;\r\nint n;\r\nif (*str != ':') {\r\nprintk(UM_KERN_ERR "fd_init : channel type 'fd' must specify a "\r\n"file descriptor\n");\r\nreturn NULL;\r\n}\r\nstr++;\r\nn = strtoul(str, &end, 0);\r\nif ((*end != '\0') || (end == str)) {\r\nprintk(UM_KERN_ERR "fd_init : couldn't parse file descriptor "\r\n"'%s'\n", str);\r\nreturn NULL;\r\n}\r\ndata = uml_kmalloc(sizeof(*data), UM_GFP_KERNEL);\r\nif (data == NULL)\r\nreturn NULL;\r\n*data = ((struct fd_chan) { .fd = n,\r\n.raw = opts->raw });\r\nreturn data;\r\n}\r\nstatic int fd_open(int input, int output, int primary, void *d, char **dev_out)\r\n{\r\nstruct fd_chan *data = d;\r\nint err;\r\nif (data->raw && isatty(data->fd)) {\r\nCATCH_EINTR(err = tcgetattr(data->fd, &data->tt));\r\nif (err)\r\nreturn err;\r\nerr = raw(data->fd);\r\nif (err)\r\nreturn err;\r\n}\r\nsprintf(data->str, "%d", data->fd);\r\n*dev_out = data->str;\r\nreturn data->fd;\r\n}\r\nstatic void fd_close(int fd, void *d)\r\n{\r\nstruct fd_chan *data = d;\r\nint err;\r\nif (!data->raw || !isatty(fd))\r\nreturn;\r\nCATCH_EINTR(err = tcsetattr(fd, TCSAFLUSH, &data->tt));\r\nif (err)\r\nprintk(UM_KERN_ERR "Failed to restore terminal state - "\r\n"errno = %d\n", -err);\r\ndata->raw = 0;\r\n}

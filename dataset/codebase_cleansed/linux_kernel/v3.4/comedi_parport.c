static int __init driver_parport_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_parport);\r\n}\r\nstatic void __exit driver_parport_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_parport);\r\n}\r\nstatic int parport_insn_a(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (data[0]) {\r\ndevpriv->a_data &= ~data[0];\r\ndevpriv->a_data |= (data[0] & data[1]);\r\noutb(devpriv->a_data, dev->iobase + PARPORT_A);\r\n}\r\ndata[1] = inb(dev->iobase + PARPORT_A);\r\nreturn 2;\r\n}\r\nstatic int parport_insn_config_a(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (data[0]) {\r\ns->io_bits = 0xff;\r\ndevpriv->c_data &= ~(1 << 5);\r\n} else {\r\ns->io_bits = 0;\r\ndevpriv->c_data |= (1 << 5);\r\n}\r\noutb(devpriv->c_data, dev->iobase + PARPORT_C);\r\nreturn 1;\r\n}\r\nstatic int parport_insn_b(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (data[0]) {\r\n}\r\ndata[1] = (inb(dev->iobase + PARPORT_B) >> 3);\r\nreturn 2;\r\n}\r\nstatic int parport_insn_c(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[0] &= 0x0f;\r\nif (data[0]) {\r\ndevpriv->c_data &= ~data[0];\r\ndevpriv->c_data |= (data[0] & data[1]);\r\noutb(devpriv->c_data, dev->iobase + PARPORT_C);\r\n}\r\ndata[1] = devpriv->c_data & 0xf;\r\nreturn 2;\r\n}\r\nstatic int parport_intr_insn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n < 1)\r\nreturn -EINVAL;\r\ndata[1] = 0;\r\nreturn 2;\r\n}\r\nstatic int parport_intr_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nint tmp;\r\ntmp = cmd->start_src;\r\ncmd->start_src &= TRIG_NOW;\r\nif (!cmd->start_src || tmp != cmd->start_src)\r\nerr++;\r\ntmp = cmd->scan_begin_src;\r\ncmd->scan_begin_src &= TRIG_EXT;\r\nif (!cmd->scan_begin_src || tmp != cmd->scan_begin_src)\r\nerr++;\r\ntmp = cmd->convert_src;\r\ncmd->convert_src &= TRIG_FOLLOW;\r\nif (!cmd->convert_src || tmp != cmd->convert_src)\r\nerr++;\r\ntmp = cmd->scan_end_src;\r\ncmd->scan_end_src &= TRIG_COUNT;\r\nif (!cmd->scan_end_src || tmp != cmd->scan_end_src)\r\nerr++;\r\ntmp = cmd->stop_src;\r\ncmd->stop_src &= TRIG_NONE;\r\nif (!cmd->stop_src || tmp != cmd->stop_src)\r\nerr++;\r\nif (err)\r\nreturn 1;\r\nif (err)\r\nreturn 2;\r\nif (cmd->start_arg != 0) {\r\ncmd->start_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_begin_arg != 0) {\r\ncmd->scan_begin_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->convert_arg != 0) {\r\ncmd->convert_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_end_arg != 1) {\r\ncmd->scan_end_arg = 1;\r\nerr++;\r\n}\r\nif (cmd->stop_arg != 0) {\r\ncmd->stop_arg = 0;\r\nerr++;\r\n}\r\nif (err)\r\nreturn 3;\r\nif (err)\r\nreturn 4;\r\nreturn 0;\r\n}\r\nstatic int parport_intr_cmd(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\ndevpriv->c_data |= 0x10;\r\noutb(devpriv->c_data, dev->iobase + PARPORT_C);\r\ndevpriv->enable_irq = 1;\r\nreturn 0;\r\n}\r\nstatic int parport_intr_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nprintk(KERN_DEBUG "parport_intr_cancel()\n");\r\ndevpriv->c_data &= ~0x10;\r\noutb(devpriv->c_data, dev->iobase + PARPORT_C);\r\ndevpriv->enable_irq = 0;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t parport_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct comedi_subdevice *s = dev->subdevices + 3;\r\nif (!devpriv->enable_irq) {\r\nprintk(KERN_ERR "comedi_parport: bogus irq, ignored\n");\r\nreturn IRQ_NONE;\r\n}\r\ncomedi_buf_put(s->async, 0);\r\ns->async->events |= COMEDI_CB_BLOCK | COMEDI_CB_EOS;\r\ncomedi_event(dev, s);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int parport_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nint ret;\r\nunsigned int irq;\r\nunsigned long iobase;\r\nstruct comedi_subdevice *s;\r\niobase = it->options[0];\r\nprintk(KERN_INFO "comedi%d: parport: 0x%04lx ", dev->minor, iobase);\r\nif (!request_region(iobase, PARPORT_SIZE, "parport (comedi)")) {\r\nprintk(KERN_ERR "I/O port conflict\n");\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\nirq = it->options[1];\r\nif (irq) {\r\nprintk(KERN_INFO " irq=%u", irq);\r\nret = request_irq(irq, parport_interrupt, 0, "comedi_parport",\r\ndev);\r\nif (ret < 0) {\r\nprintk(KERN_ERR " irq not available\n");\r\nreturn -EINVAL;\r\n}\r\ndev->irq = irq;\r\n}\r\ndev->board_name = "parport";\r\nret = alloc_subdevices(dev, 4);\r\nif (ret < 0)\r\nreturn ret;\r\nret = alloc_private(dev, sizeof(struct parport_private));\r\nif (ret < 0)\r\nreturn ret;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = parport_insn_a;\r\ns->insn_config = parport_insn_config_a;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 5;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = parport_insn_b;\r\ns = dev->subdevices + 2;\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 4;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = parport_insn_c;\r\ns = dev->subdevices + 3;\r\nif (irq) {\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_CMD_READ;\r\ns->n_chan = 1;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = parport_intr_insn;\r\ns->do_cmdtest = parport_intr_cmdtest;\r\ns->do_cmd = parport_intr_cmd;\r\ns->cancel = parport_intr_cancel;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ndevpriv->a_data = 0;\r\noutb(devpriv->a_data, dev->iobase + PARPORT_A);\r\ndevpriv->c_data = 0;\r\noutb(devpriv->c_data, dev->iobase + PARPORT_C);\r\nprintk(KERN_INFO "\n");\r\nreturn 1;\r\n}\r\nstatic int parport_detach(struct comedi_device *dev)\r\n{\r\nprintk(KERN_INFO "comedi%d: parport: remove\n", dev->minor);\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, PARPORT_SIZE);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}

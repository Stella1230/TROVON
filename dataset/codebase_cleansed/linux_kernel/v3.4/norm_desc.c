static int ndesc_get_tx_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_desc *p, void __iomem *ioaddr)\r\n{\r\nint ret = 0;\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nif (unlikely(p->des01.tx.error_summary)) {\r\nif (unlikely(p->des01.tx.underflow_error)) {\r\nx->tx_underflow++;\r\nstats->tx_fifo_errors++;\r\n}\r\nif (unlikely(p->des01.tx.no_carrier)) {\r\nx->tx_carrier++;\r\nstats->tx_carrier_errors++;\r\n}\r\nif (unlikely(p->des01.tx.loss_carrier)) {\r\nx->tx_losscarrier++;\r\nstats->tx_carrier_errors++;\r\n}\r\nif (unlikely((p->des01.tx.excessive_deferral) ||\r\n(p->des01.tx.excessive_collisions) ||\r\n(p->des01.tx.late_collision)))\r\nstats->collisions += p->des01.tx.collision_count;\r\nret = -1;\r\n}\r\nif (p->des01.etx.vlan_frame) {\r\nCHIP_DBG(KERN_INFO "GMAC TX status: VLAN frame\n");\r\nx->tx_vlan++;\r\n}\r\nif (unlikely(p->des01.tx.deferred))\r\nx->tx_deferred++;\r\nreturn ret;\r\n}\r\nstatic int ndesc_get_tx_len(struct dma_desc *p)\r\n{\r\nreturn p->des01.tx.buffer1_size;\r\n}\r\nstatic int ndesc_get_rx_status(void *data, struct stmmac_extra_stats *x,\r\nstruct dma_desc *p)\r\n{\r\nint ret = good_frame;\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nif (unlikely(p->des01.rx.last_descriptor == 0)) {\r\npr_warning("ndesc Error: Oversized Ethernet "\r\n"frame spanned multiple buffers\n");\r\nstats->rx_length_errors++;\r\nreturn discard_frame;\r\n}\r\nif (unlikely(p->des01.rx.error_summary)) {\r\nif (unlikely(p->des01.rx.descriptor_error))\r\nx->rx_desc++;\r\nif (unlikely(p->des01.rx.sa_filter_fail))\r\nx->sa_filter_fail++;\r\nif (unlikely(p->des01.rx.overflow_error))\r\nx->overflow_error++;\r\nif (unlikely(p->des01.rx.ipc_csum_error))\r\nx->ipc_csum_error++;\r\nif (unlikely(p->des01.rx.collision)) {\r\nx->rx_collision++;\r\nstats->collisions++;\r\n}\r\nif (unlikely(p->des01.rx.crc_error)) {\r\nx->rx_crc++;\r\nstats->rx_crc_errors++;\r\n}\r\nret = discard_frame;\r\n}\r\nif (unlikely(p->des01.rx.dribbling))\r\nx->dribbling_bit++;\r\nif (unlikely(p->des01.rx.length_error)) {\r\nx->rx_length++;\r\nret = discard_frame;\r\n}\r\nif (unlikely(p->des01.rx.mii_error)) {\r\nx->rx_mii++;\r\nret = discard_frame;\r\n}\r\n#ifdef STMMAC_VLAN_TAG_USED\r\nif (p->des01.rx.vlan_tag)\r\nx->vlan_tag++;\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void ndesc_init_rx_desc(struct dma_desc *p, unsigned int ring_size,\r\nint disable_rx_ic)\r\n{\r\nint i;\r\nfor (i = 0; i < ring_size; i++) {\r\np->des01.rx.own = 1;\r\np->des01.rx.buffer1_size = BUF_SIZE_2KiB - 1;\r\nndesc_rx_set_on_ring_chain(p, (i == ring_size - 1));\r\nif (disable_rx_ic)\r\np->des01.rx.disable_ic = 1;\r\np++;\r\n}\r\n}\r\nstatic void ndesc_init_tx_desc(struct dma_desc *p, unsigned int ring_size)\r\n{\r\nint i;\r\nfor (i = 0; i < ring_size; i++) {\r\np->des01.tx.own = 0;\r\nndesc_tx_set_on_ring_chain(p, (i == (ring_size - 1)));\r\np++;\r\n}\r\n}\r\nstatic int ndesc_get_tx_owner(struct dma_desc *p)\r\n{\r\nreturn p->des01.tx.own;\r\n}\r\nstatic int ndesc_get_rx_owner(struct dma_desc *p)\r\n{\r\nreturn p->des01.rx.own;\r\n}\r\nstatic void ndesc_set_tx_owner(struct dma_desc *p)\r\n{\r\np->des01.tx.own = 1;\r\n}\r\nstatic void ndesc_set_rx_owner(struct dma_desc *p)\r\n{\r\np->des01.rx.own = 1;\r\n}\r\nstatic int ndesc_get_tx_ls(struct dma_desc *p)\r\n{\r\nreturn p->des01.tx.last_segment;\r\n}\r\nstatic void ndesc_release_tx_desc(struct dma_desc *p)\r\n{\r\nint ter = p->des01.tx.end_ring;\r\nmemset(p, 0, offsetof(struct dma_desc, des2));\r\nndesc_end_tx_desc(p, ter);\r\n}\r\nstatic void ndesc_prepare_tx_desc(struct dma_desc *p, int is_fs, int len,\r\nint csum_flag)\r\n{\r\np->des01.tx.first_segment = is_fs;\r\nnorm_set_tx_desc_len(p, len);\r\nif (likely(csum_flag))\r\np->des01.tx.checksum_insertion = cic_full;\r\n}\r\nstatic void ndesc_clear_tx_ic(struct dma_desc *p)\r\n{\r\np->des01.tx.interrupt = 0;\r\n}\r\nstatic void ndesc_close_tx_desc(struct dma_desc *p)\r\n{\r\np->des01.tx.last_segment = 1;\r\np->des01.tx.interrupt = 1;\r\n}\r\nstatic int ndesc_get_rx_frame_len(struct dma_desc *p)\r\n{\r\nreturn p->des01.rx.frame_length;\r\n}

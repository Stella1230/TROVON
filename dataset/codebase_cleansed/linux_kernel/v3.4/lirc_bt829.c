static struct pci_dev *do_pci_probe(void)\r\n{\r\nstruct pci_dev *my_dev;\r\nmy_dev = pci_get_device(PCI_VENDOR_ID_ATI,\r\nPCI_DEVICE_ID_ATI_264VT, NULL);\r\nif (my_dev) {\r\nprintk(KERN_ERR DRIVER_NAME ": Using device: %s\n",\r\npci_name(my_dev));\r\npci_addr_phys = 0;\r\nif (my_dev->resource[0].flags & IORESOURCE_MEM) {\r\npci_addr_phys = my_dev->resource[0].start;\r\nprintk(KERN_INFO DRIVER_NAME ": memory at 0x%08X\n",\r\n(unsigned int)pci_addr_phys);\r\n}\r\nif (pci_addr_phys == 0) {\r\nprintk(KERN_ERR DRIVER_NAME ": no memory resource ?\n");\r\nreturn NULL;\r\n}\r\n} else {\r\nprintk(KERN_ERR DRIVER_NAME ": pci_probe failed\n");\r\nreturn NULL;\r\n}\r\nreturn my_dev;\r\n}\r\nstatic int atir_add_to_buf(void *data, struct lirc_buffer *buf)\r\n{\r\nunsigned char key;\r\nint status;\r\nstatus = poll_main();\r\nkey = (status >> 8) & 0xFF;\r\nif (status & 0xFF) {\r\ndprintk("reading key %02X\n", key);\r\nlirc_buffer_write(buf, &key);\r\nreturn 0;\r\n}\r\nreturn -ENODATA;\r\n}\r\nstatic int atir_set_use_inc(void *data)\r\n{\r\ndprintk("driver is opened\n");\r\nreturn 0;\r\n}\r\nstatic void atir_set_use_dec(void *data)\r\n{\r\ndprintk("driver is closed\n");\r\n}\r\nint init_module(void)\r\n{\r\nstruct pci_dev *pdev;\r\npdev = do_pci_probe();\r\nif (pdev == NULL)\r\nreturn -ENODEV;\r\nif (!atir_init_start())\r\nreturn -ENODEV;\r\nstrcpy(atir_driver.name, "ATIR");\r\natir_driver.minor = -1;\r\natir_driver.code_length = 8;\r\natir_driver.sample_rate = 10;\r\natir_driver.data = 0;\r\natir_driver.add_to_buf = atir_add_to_buf;\r\natir_driver.set_use_inc = atir_set_use_inc;\r\natir_driver.set_use_dec = atir_set_use_dec;\r\natir_driver.dev = &pdev->dev;\r\natir_driver.owner = THIS_MODULE;\r\natir_minor = lirc_register_driver(&atir_driver);\r\nif (atir_minor < 0) {\r\nprintk(KERN_ERR DRIVER_NAME ": failed to register driver!\n");\r\nreturn atir_minor;\r\n}\r\ndprintk("driver is registered on minor %d\n", atir_minor);\r\nreturn 0;\r\n}\r\nvoid cleanup_module(void)\r\n{\r\nlirc_unregister_driver(atir_minor);\r\n}\r\nstatic int atir_init_start(void)\r\n{\r\npci_addr_lin = ioremap(pci_addr_phys + DATA_PCI_OFF, 0x400);\r\nif (pci_addr_lin == 0) {\r\nprintk(KERN_INFO DRIVER_NAME ": pci mem must be mapped\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic void cycle_delay(int cycle)\r\n{\r\nudelay(WAIT_CYCLE*cycle);\r\n}\r\nstatic int poll_main()\r\n{\r\nunsigned char status_high, status_low;\r\ndo_i2c_start();\r\nseems_wr_byte(0xAA);\r\nseems_wr_byte(0x01);\r\ndo_i2c_start();\r\nseems_wr_byte(0xAB);\r\nstatus_low = seems_rd_byte();\r\nstatus_high = seems_rd_byte();\r\ndo_i2c_stop();\r\nreturn (status_high << 8) | status_low;\r\n}\r\nstatic void do_i2c_start(void)\r\n{\r\ndo_set_bits(3);\r\ncycle_delay(4);\r\ndo_set_bits(1);\r\ncycle_delay(7);\r\ndo_set_bits(0);\r\ncycle_delay(2);\r\n}\r\nstatic void do_i2c_stop(void)\r\n{\r\nunsigned char bits;\r\nbits = do_get_bits() & 0xFD;\r\ndo_set_bits(bits);\r\ncycle_delay(1);\r\nbits |= 1;\r\ndo_set_bits(bits);\r\ncycle_delay(2);\r\nbits |= 2;\r\ndo_set_bits(bits);\r\nbits = 3;\r\ndo_set_bits(bits);\r\ncycle_delay(2);\r\n}\r\nstatic void seems_wr_byte(unsigned char value)\r\n{\r\nint i;\r\nunsigned char reg;\r\nreg = do_get_bits();\r\nfor (i = 0; i < 8; i++) {\r\nif (value & 0x80)\r\nreg |= 0x02;\r\nelse\r\nreg &= 0xFD;\r\ndo_set_bits(reg);\r\ncycle_delay(1);\r\nreg |= 1;\r\ndo_set_bits(reg);\r\ncycle_delay(1);\r\nreg &= 0xFE;\r\ndo_set_bits(reg);\r\ncycle_delay(1);\r\nvalue <<= 1;\r\n}\r\ncycle_delay(2);\r\nreg |= 2;\r\ndo_set_bits(reg);\r\nreg |= 1;\r\ndo_set_bits(reg);\r\ncycle_delay(1);\r\ndo_get_bits();\r\nreg &= 0xFE;\r\ndo_set_bits(reg);\r\ncycle_delay(3);\r\n}\r\nstatic unsigned char seems_rd_byte(void)\r\n{\r\nint i;\r\nint rd_byte;\r\nunsigned char bits_2, bits_1;\r\nbits_1 = do_get_bits() | 2;\r\ndo_set_bits(bits_1);\r\nrd_byte = 0;\r\nfor (i = 0; i < 8; i++) {\r\nbits_1 &= 0xFE;\r\ndo_set_bits(bits_1);\r\ncycle_delay(2);\r\nbits_1 |= 1;\r\ndo_set_bits(bits_1);\r\ncycle_delay(1);\r\nbits_2 = do_get_bits();\r\nif (bits_2 & 2)\r\nrd_byte |= 1;\r\nrd_byte <<= 1;\r\n}\r\nbits_1 = 0;\r\nif (bits_2 == 0)\r\nbits_1 |= 2;\r\ndo_set_bits(bits_1);\r\ncycle_delay(2);\r\nbits_1 |= 1;\r\ndo_set_bits(bits_1);\r\ncycle_delay(3);\r\nbits_1 &= 0xFE;\r\ndo_set_bits(bits_1);\r\ncycle_delay(2);\r\nrd_byte >>= 1;\r\nrd_byte &= 0xFF;\r\nreturn rd_byte;\r\n}\r\nstatic void do_set_bits(unsigned char new_bits)\r\n{\r\nint reg_val;\r\nreg_val = read_index(0x34);\r\nif (new_bits & 2) {\r\nreg_val &= 0xFFFFFFDF;\r\nreg_val |= 1;\r\n} else {\r\nreg_val &= 0xFFFFFFFE;\r\nreg_val |= 0x20;\r\n}\r\nreg_val |= 0x10;\r\nwrite_index(0x34, reg_val);\r\nreg_val = read_index(0x31);\r\nif (new_bits & 1)\r\nreg_val |= 0x1000000;\r\nelse\r\nreg_val &= 0xFEFFFFFF;\r\nreg_val |= 0x8000000;\r\nwrite_index(0x31, reg_val);\r\n}\r\nstatic unsigned char do_get_bits(void)\r\n{\r\nunsigned char bits;\r\nint reg_val;\r\nreg_val = read_index(0x34);\r\nreg_val |= 0x10;\r\nreg_val &= 0xFFFFFFDF;\r\nwrite_index(0x34, reg_val);\r\nreg_val = read_index(0x34);\r\nbits = 0;\r\nif (reg_val & 8)\r\nbits |= 2;\r\nelse\r\nbits &= 0xFD;\r\nreg_val = read_index(0x31);\r\nif (reg_val & 0x1000000)\r\nbits |= 1;\r\nelse\r\nbits &= 0xFE;\r\nreturn bits;\r\n}\r\nstatic unsigned int read_index(unsigned char index)\r\n{\r\nunsigned char *addr;\r\nunsigned int value;\r\naddr = pci_addr_lin + ((index & 0xFF) << 2);\r\nvalue = readl(addr);\r\nreturn value;\r\n}\r\nstatic void write_index(unsigned char index, unsigned int reg_val)\r\n{\r\nunsigned char *addr;\r\naddr = pci_addr_lin + ((index & 0xFF) << 2);\r\nwritel(reg_val, addr);\r\n}

static int __init alsa_card_aw2_init(void)\r\n{\r\nsnd_printdd(KERN_DEBUG "aw2: Load aw2 module\n");\r\nreturn pci_register_driver(&driver);\r\n}\r\nstatic void __exit alsa_card_aw2_exit(void)\r\n{\r\nsnd_printdd(KERN_DEBUG "aw2: Unload aw2 module\n");\r\npci_unregister_driver(&driver);\r\n}\r\nstatic int snd_aw2_dev_free(struct snd_device *device)\r\n{\r\nstruct aw2 *chip = device->device_data;\r\nsnd_aw2_saa7146_free(&chip->saa7146);\r\nif (chip->irq >= 0)\r\nfree_irq(chip->irq, (void *)chip);\r\nif (chip->iobase_virt)\r\niounmap(chip->iobase_virt);\r\npci_release_regions(chip->pci);\r\npci_disable_device(chip->pci);\r\nkfree(chip);\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_aw2_create(struct snd_card *card,\r\nstruct pci_dev *pci, struct aw2 **rchip)\r\n{\r\nstruct aw2 *chip;\r\nint err;\r\nstatic struct snd_device_ops ops = {\r\n.dev_free = snd_aw2_dev_free,\r\n};\r\n*rchip = NULL;\r\nerr = pci_enable_device(pci);\r\nif (err < 0)\r\nreturn err;\r\npci_set_master(pci);\r\nif ((pci_set_dma_mask(pci, DMA_BIT_MASK(32)) < 0) ||\r\n(pci_set_consistent_dma_mask(pci, DMA_BIT_MASK(32)) < 0)) {\r\nprintk(KERN_ERR "aw2: Impossible to set 32bit mask DMA\n");\r\npci_disable_device(pci);\r\nreturn -ENXIO;\r\n}\r\nchip = kzalloc(sizeof(*chip), GFP_KERNEL);\r\nif (chip == NULL) {\r\npci_disable_device(pci);\r\nreturn -ENOMEM;\r\n}\r\nchip->card = card;\r\nchip->pci = pci;\r\nchip->irq = -1;\r\nerr = pci_request_regions(pci, "Audiowerk2");\r\nif (err < 0) {\r\npci_disable_device(pci);\r\nkfree(chip);\r\nreturn err;\r\n}\r\nchip->iobase_phys = pci_resource_start(pci, 0);\r\nchip->iobase_virt =\r\nioremap_nocache(chip->iobase_phys,\r\npci_resource_len(pci, 0));\r\nif (chip->iobase_virt == NULL) {\r\nprintk(KERN_ERR "aw2: unable to remap memory region");\r\npci_release_regions(pci);\r\npci_disable_device(pci);\r\nkfree(chip);\r\nreturn -ENOMEM;\r\n}\r\nsnd_aw2_saa7146_setup(&chip->saa7146, chip->iobase_virt);\r\nif (request_irq(pci->irq, snd_aw2_saa7146_interrupt,\r\nIRQF_SHARED, KBUILD_MODNAME, chip)) {\r\nprintk(KERN_ERR "aw2: Cannot grab irq %d\n", pci->irq);\r\niounmap(chip->iobase_virt);\r\npci_release_regions(chip->pci);\r\npci_disable_device(chip->pci);\r\nkfree(chip);\r\nreturn -EBUSY;\r\n}\r\nchip->irq = pci->irq;\r\nerr = snd_device_new(card, SNDRV_DEV_LOWLEVEL, chip, &ops);\r\nif (err < 0) {\r\nfree_irq(chip->irq, (void *)chip);\r\niounmap(chip->iobase_virt);\r\npci_release_regions(chip->pci);\r\npci_disable_device(chip->pci);\r\nkfree(chip);\r\nreturn err;\r\n}\r\nsnd_card_set_dev(card, &pci->dev);\r\n*rchip = chip;\r\nprintk(KERN_INFO\r\n"Audiowerk 2 sound card (saa7146 chipset) detected and "\r\n"managed\n");\r\nreturn 0;\r\n}\r\nstatic int __devinit snd_aw2_probe(struct pci_dev *pci,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstatic int dev;\r\nstruct snd_card *card;\r\nstruct aw2 *chip;\r\nint err;\r\nif (dev >= SNDRV_CARDS)\r\nreturn -ENODEV;\r\nif (!enable[dev]) {\r\ndev++;\r\nreturn -ENOENT;\r\n}\r\nerr = snd_card_create(index[dev], id[dev], THIS_MODULE, 0, &card);\r\nif (err < 0)\r\nreturn err;\r\nerr = snd_aw2_create(card, pci, &chip);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nmutex_init(&chip->mtx);\r\nspin_lock_init(&chip->reg_lock);\r\nstrcpy(card->driver, "aw2");\r\nstrcpy(card->shortname, "Audiowerk2");\r\nsprintf(card->longname, "%s with SAA7146 irq %i",\r\ncard->shortname, chip->irq);\r\nsnd_aw2_new_pcm(chip);\r\nerr = snd_card_register(card);\r\nif (err < 0) {\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\npci_set_drvdata(pci, card);\r\ndev++;\r\nreturn 0;\r\n}\r\nstatic void __devexit snd_aw2_remove(struct pci_dev *pci)\r\n{\r\nsnd_card_free(pci_get_drvdata(pci));\r\npci_set_drvdata(pci, NULL);\r\n}\r\nstatic int snd_aw2_pcm_playback_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nsnd_printdd(KERN_DEBUG "aw2: Playback_open\n");\r\nruntime->hw = snd_aw2_playback_hw;\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_pcm_playback_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_pcm_capture_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nsnd_printdd(KERN_DEBUG "aw2: Capture_open\n");\r\nruntime->hw = snd_aw2_capture_hw;\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_pcm_capture_close(struct snd_pcm_substream *substream)\r\n{\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nreturn snd_pcm_lib_malloc_pages(substream,\r\nparams_buffer_bytes(hw_params));\r\n}\r\nstatic int snd_aw2_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nreturn snd_pcm_lib_free_pages(substream);\r\n}\r\nstatic int snd_aw2_pcm_prepare_playback(struct snd_pcm_substream *substream)\r\n{\r\nstruct aw2_pcm_device *pcm_device = snd_pcm_substream_chip(substream);\r\nstruct aw2 *chip = pcm_device->chip;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned long period_size, buffer_size;\r\nmutex_lock(&chip->mtx);\r\nperiod_size = snd_pcm_lib_period_bytes(substream);\r\nbuffer_size = snd_pcm_lib_buffer_bytes(substream);\r\nsnd_aw2_saa7146_pcm_init_playback(&chip->saa7146,\r\npcm_device->stream_number,\r\nruntime->dma_addr, period_size,\r\nbuffer_size);\r\nsnd_aw2_saa7146_define_it_playback_callback(pcm_device->stream_number,\r\n(snd_aw2_saa7146_it_cb)\r\nsnd_pcm_period_elapsed,\r\n(void *)substream);\r\nmutex_unlock(&chip->mtx);\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_pcm_prepare_capture(struct snd_pcm_substream *substream)\r\n{\r\nstruct aw2_pcm_device *pcm_device = snd_pcm_substream_chip(substream);\r\nstruct aw2 *chip = pcm_device->chip;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nunsigned long period_size, buffer_size;\r\nmutex_lock(&chip->mtx);\r\nperiod_size = snd_pcm_lib_period_bytes(substream);\r\nbuffer_size = snd_pcm_lib_buffer_bytes(substream);\r\nsnd_aw2_saa7146_pcm_init_capture(&chip->saa7146,\r\npcm_device->stream_number,\r\nruntime->dma_addr, period_size,\r\nbuffer_size);\r\nsnd_aw2_saa7146_define_it_capture_callback(pcm_device->stream_number,\r\n(snd_aw2_saa7146_it_cb)\r\nsnd_pcm_period_elapsed,\r\n(void *)substream);\r\nmutex_unlock(&chip->mtx);\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_pcm_trigger_playback(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nint status = 0;\r\nstruct aw2_pcm_device *pcm_device = snd_pcm_substream_chip(substream);\r\nstruct aw2 *chip = pcm_device->chip;\r\nspin_lock(&chip->reg_lock);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nsnd_aw2_saa7146_pcm_trigger_start_playback(&chip->saa7146,\r\npcm_device->\r\nstream_number);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nsnd_aw2_saa7146_pcm_trigger_stop_playback(&chip->saa7146,\r\npcm_device->\r\nstream_number);\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nspin_unlock(&chip->reg_lock);\r\nreturn status;\r\n}\r\nstatic int snd_aw2_pcm_trigger_capture(struct snd_pcm_substream *substream,\r\nint cmd)\r\n{\r\nint status = 0;\r\nstruct aw2_pcm_device *pcm_device = snd_pcm_substream_chip(substream);\r\nstruct aw2 *chip = pcm_device->chip;\r\nspin_lock(&chip->reg_lock);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nsnd_aw2_saa7146_pcm_trigger_start_capture(&chip->saa7146,\r\npcm_device->\r\nstream_number);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nsnd_aw2_saa7146_pcm_trigger_stop_capture(&chip->saa7146,\r\npcm_device->\r\nstream_number);\r\nbreak;\r\ndefault:\r\nstatus = -EINVAL;\r\n}\r\nspin_unlock(&chip->reg_lock);\r\nreturn status;\r\n}\r\nstatic snd_pcm_uframes_t snd_aw2_pcm_pointer_playback(struct snd_pcm_substream\r\n*substream)\r\n{\r\nstruct aw2_pcm_device *pcm_device = snd_pcm_substream_chip(substream);\r\nstruct aw2 *chip = pcm_device->chip;\r\nunsigned int current_ptr;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\ncurrent_ptr =\r\nsnd_aw2_saa7146_get_hw_ptr_playback(&chip->saa7146,\r\npcm_device->stream_number,\r\nruntime->dma_area,\r\nruntime->buffer_size);\r\nreturn bytes_to_frames(substream->runtime, current_ptr);\r\n}\r\nstatic snd_pcm_uframes_t snd_aw2_pcm_pointer_capture(struct snd_pcm_substream\r\n*substream)\r\n{\r\nstruct aw2_pcm_device *pcm_device = snd_pcm_substream_chip(substream);\r\nstruct aw2 *chip = pcm_device->chip;\r\nunsigned int current_ptr;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\ncurrent_ptr =\r\nsnd_aw2_saa7146_get_hw_ptr_capture(&chip->saa7146,\r\npcm_device->stream_number,\r\nruntime->dma_area,\r\nruntime->buffer_size);\r\nreturn bytes_to_frames(substream->runtime, current_ptr);\r\n}\r\nstatic int __devinit snd_aw2_new_pcm(struct aw2 *chip)\r\n{\r\nstruct snd_pcm *pcm_playback_ana;\r\nstruct snd_pcm *pcm_playback_num;\r\nstruct snd_pcm *pcm_capture;\r\nstruct aw2_pcm_device *pcm_device;\r\nint err = 0;\r\nerr = snd_pcm_new(chip->card, "Audiowerk2 analog playback", 0, 1, 0,\r\n&pcm_playback_ana);\r\nif (err < 0) {\r\nprintk(KERN_ERR "aw2: snd_pcm_new error (0x%X)\n", err);\r\nreturn err;\r\n}\r\npcm_device = &chip->device_playback[NUM_STREAM_PLAYBACK_ANA];\r\nstrcpy(pcm_playback_ana->name, "Analog playback");\r\npcm_playback_ana->private_data = pcm_device;\r\nsnd_pcm_set_ops(pcm_playback_ana, SNDRV_PCM_STREAM_PLAYBACK,\r\n&snd_aw2_playback_ops);\r\npcm_device->pcm = pcm_playback_ana;\r\npcm_device->chip = chip;\r\npcm_device->stream_number = NUM_STREAM_PLAYBACK_ANA;\r\nerr = snd_pcm_lib_preallocate_pages_for_all(pcm_playback_ana,\r\nSNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data\r\n(chip->pci),\r\n64 * 1024, 64 * 1024);\r\nif (err)\r\nprintk(KERN_ERR "aw2: snd_pcm_lib_preallocate_pages_for_all "\r\n"error (0x%X)\n", err);\r\nerr = snd_pcm_new(chip->card, "Audiowerk2 digital playback", 1, 1, 0,\r\n&pcm_playback_num);\r\nif (err < 0) {\r\nprintk(KERN_ERR "aw2: snd_pcm_new error (0x%X)\n", err);\r\nreturn err;\r\n}\r\npcm_device = &chip->device_playback[NUM_STREAM_PLAYBACK_DIG];\r\nstrcpy(pcm_playback_num->name, "Digital playback");\r\npcm_playback_num->private_data = pcm_device;\r\nsnd_pcm_set_ops(pcm_playback_num, SNDRV_PCM_STREAM_PLAYBACK,\r\n&snd_aw2_playback_ops);\r\npcm_device->pcm = pcm_playback_num;\r\npcm_device->chip = chip;\r\npcm_device->stream_number = NUM_STREAM_PLAYBACK_DIG;\r\nerr = snd_pcm_lib_preallocate_pages_for_all(pcm_playback_num,\r\nSNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data\r\n(chip->pci),\r\n64 * 1024, 64 * 1024);\r\nif (err)\r\nprintk(KERN_ERR\r\n"aw2: snd_pcm_lib_preallocate_pages_for_all error "\r\n"(0x%X)\n", err);\r\nerr = snd_pcm_new(chip->card, "Audiowerk2 capture", 2, 0, 1,\r\n&pcm_capture);\r\nif (err < 0) {\r\nprintk(KERN_ERR "aw2: snd_pcm_new error (0x%X)\n", err);\r\nreturn err;\r\n}\r\npcm_device = &chip->device_capture[NUM_STREAM_CAPTURE_ANA];\r\nstrcpy(pcm_capture->name, "Capture");\r\npcm_capture->private_data = pcm_device;\r\nsnd_pcm_set_ops(pcm_capture, SNDRV_PCM_STREAM_CAPTURE,\r\n&snd_aw2_capture_ops);\r\npcm_device->pcm = pcm_capture;\r\npcm_device->chip = chip;\r\npcm_device->stream_number = NUM_STREAM_CAPTURE_ANA;\r\nerr = snd_pcm_lib_preallocate_pages_for_all(pcm_capture,\r\nSNDRV_DMA_TYPE_DEV,\r\nsnd_dma_pci_data\r\n(chip->pci),\r\n64 * 1024, 64 * 1024);\r\nif (err)\r\nprintk(KERN_ERR\r\n"aw2: snd_pcm_lib_preallocate_pages_for_all error "\r\n"(0x%X)\n", err);\r\nerr = snd_ctl_add(chip->card, snd_ctl_new1(&aw2_control, chip));\r\nif (err < 0) {\r\nprintk(KERN_ERR "aw2: snd_ctl_add error (0x%X)\n", err);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_control_switch_capture_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nstatic char *texts[2] = {\r\n"Analog", "Digital"\r\n};\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_ENUMERATED;\r\nuinfo->count = 1;\r\nuinfo->value.enumerated.items = 2;\r\nif (uinfo->value.enumerated.item >= uinfo->value.enumerated.items) {\r\nuinfo->value.enumerated.item =\r\nuinfo->value.enumerated.items - 1;\r\n}\r\nstrcpy(uinfo->value.enumerated.name,\r\ntexts[uinfo->value.enumerated.item]);\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_control_switch_capture_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value\r\n*ucontrol)\r\n{\r\nstruct aw2 *chip = snd_kcontrol_chip(kcontrol);\r\nif (snd_aw2_saa7146_is_using_digital_input(&chip->saa7146))\r\nucontrol->value.enumerated.item[0] = CTL_ROUTE_DIGITAL;\r\nelse\r\nucontrol->value.enumerated.item[0] = CTL_ROUTE_ANALOG;\r\nreturn 0;\r\n}\r\nstatic int snd_aw2_control_switch_capture_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value\r\n*ucontrol)\r\n{\r\nstruct aw2 *chip = snd_kcontrol_chip(kcontrol);\r\nint changed = 0;\r\nint is_disgital =\r\nsnd_aw2_saa7146_is_using_digital_input(&chip->saa7146);\r\nif (((ucontrol->value.integer.value[0] == CTL_ROUTE_DIGITAL)\r\n&& !is_disgital)\r\n|| ((ucontrol->value.integer.value[0] == CTL_ROUTE_ANALOG)\r\n&& is_disgital)) {\r\nsnd_aw2_saa7146_use_digital_input(&chip->saa7146, !is_disgital);\r\nchanged = 1;\r\n}\r\nreturn changed;\r\n}

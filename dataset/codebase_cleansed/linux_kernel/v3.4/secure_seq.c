static int __init net_secret_init(void)\r\n{\r\nget_random_bytes(net_secret, sizeof(net_secret));\r\nreturn 0;\r\n}\r\nstatic u32 seq_scale(u32 seq)\r\n{\r\nreturn seq + (ktime_to_ns(ktime_get_real()) >> 6);\r\n}\r\n__u32 secure_tcpv6_sequence_number(const __be32 *saddr, const __be32 *daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nu32 secret[MD5_MESSAGE_BYTES / 4];\r\nu32 hash[MD5_DIGEST_WORDS];\r\nu32 i;\r\nmemcpy(hash, saddr, 16);\r\nfor (i = 0; i < 4; i++)\r\nsecret[i] = net_secret[i] + (__force u32)daddr[i];\r\nsecret[4] = net_secret[4] +\r\n(((__force u16)sport << 16) + (__force u16)dport);\r\nfor (i = 5; i < MD5_MESSAGE_BYTES / 4; i++)\r\nsecret[i] = net_secret[i];\r\nmd5_transform(hash, secret);\r\nreturn seq_scale(hash[0]);\r\n}\r\nu32 secure_ipv6_port_ephemeral(const __be32 *saddr, const __be32 *daddr,\r\n__be16 dport)\r\n{\r\nu32 secret[MD5_MESSAGE_BYTES / 4];\r\nu32 hash[MD5_DIGEST_WORDS];\r\nu32 i;\r\nmemcpy(hash, saddr, 16);\r\nfor (i = 0; i < 4; i++)\r\nsecret[i] = net_secret[i] + (__force u32) daddr[i];\r\nsecret[4] = net_secret[4] + (__force u32)dport;\r\nfor (i = 5; i < MD5_MESSAGE_BYTES / 4; i++)\r\nsecret[i] = net_secret[i];\r\nmd5_transform(hash, secret);\r\nreturn hash[0];\r\n}\r\n__u32 secure_ip_id(__be32 daddr)\r\n{\r\nu32 hash[MD5_DIGEST_WORDS];\r\nhash[0] = (__force __u32) daddr;\r\nhash[1] = net_secret[13];\r\nhash[2] = net_secret[14];\r\nhash[3] = net_secret[15];\r\nmd5_transform(hash, net_secret);\r\nreturn hash[0];\r\n}\r\n__u32 secure_ipv6_id(const __be32 daddr[4])\r\n{\r\n__u32 hash[4];\r\nmemcpy(hash, daddr, 16);\r\nmd5_transform(hash, net_secret);\r\nreturn hash[0];\r\n}\r\n__u32 secure_tcp_sequence_number(__be32 saddr, __be32 daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nu32 hash[MD5_DIGEST_WORDS];\r\nhash[0] = (__force u32)saddr;\r\nhash[1] = (__force u32)daddr;\r\nhash[2] = ((__force u16)sport << 16) + (__force u16)dport;\r\nhash[3] = net_secret[15];\r\nmd5_transform(hash, net_secret);\r\nreturn seq_scale(hash[0]);\r\n}\r\nu32 secure_ipv4_port_ephemeral(__be32 saddr, __be32 daddr, __be16 dport)\r\n{\r\nu32 hash[MD5_DIGEST_WORDS];\r\nhash[0] = (__force u32)saddr;\r\nhash[1] = (__force u32)daddr;\r\nhash[2] = (__force u32)dport ^ net_secret[14];\r\nhash[3] = net_secret[15];\r\nmd5_transform(hash, net_secret);\r\nreturn hash[0];\r\n}\r\nu64 secure_dccp_sequence_number(__be32 saddr, __be32 daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nu32 hash[MD5_DIGEST_WORDS];\r\nu64 seq;\r\nhash[0] = (__force u32)saddr;\r\nhash[1] = (__force u32)daddr;\r\nhash[2] = ((__force u16)sport << 16) + (__force u16)dport;\r\nhash[3] = net_secret[15];\r\nmd5_transform(hash, net_secret);\r\nseq = hash[0] | (((u64)hash[1]) << 32);\r\nseq += ktime_to_ns(ktime_get_real());\r\nseq &= (1ull << 48) - 1;\r\nreturn seq;\r\n}\r\nu64 secure_dccpv6_sequence_number(__be32 *saddr, __be32 *daddr,\r\n__be16 sport, __be16 dport)\r\n{\r\nu32 secret[MD5_MESSAGE_BYTES / 4];\r\nu32 hash[MD5_DIGEST_WORDS];\r\nu64 seq;\r\nu32 i;\r\nmemcpy(hash, saddr, 16);\r\nfor (i = 0; i < 4; i++)\r\nsecret[i] = net_secret[i] + daddr[i];\r\nsecret[4] = net_secret[4] +\r\n(((__force u16)sport << 16) + (__force u16)dport);\r\nfor (i = 5; i < MD5_MESSAGE_BYTES / 4; i++)\r\nsecret[i] = net_secret[i];\r\nmd5_transform(hash, secret);\r\nseq = hash[0] | (((u64)hash[1]) << 32);\r\nseq += ktime_to_ns(ktime_get_real());\r\nseq &= (1ull << 48) - 1;\r\nreturn seq;\r\n}

static inline u_long\r\ndir_pages(struct inode *inode)\r\n{\r\nreturn (inode->i_size + PAGE_CACHE_SIZE - 1) >> PAGE_CACHE_SHIFT;\r\n}\r\nstatic inline u_long\r\ndir_blocks(struct inode *ip)\r\n{\r\nu_long bsize = ip->i_sb->s_blocksize;\r\nreturn (ip->i_size + bsize - 1) & ~(bsize - 1);\r\n}\r\nstatic inline int\r\nvxfs_match(int len, const char * const name, struct vxfs_direct *de)\r\n{\r\nif (len != de->d_namelen)\r\nreturn 0;\r\nif (!de->d_ino)\r\nreturn 0;\r\nreturn !memcmp(name, de->d_name, len);\r\n}\r\nstatic inline struct vxfs_direct *\r\nvxfs_next_entry(struct vxfs_direct *de)\r\n{\r\nreturn ((struct vxfs_direct *)((char*)de + de->d_reclen));\r\n}\r\nstatic struct vxfs_direct *\r\nvxfs_find_entry(struct inode *ip, struct dentry *dp, struct page **ppp)\r\n{\r\nu_long npages, page, nblocks, pblocks, block;\r\nu_long bsize = ip->i_sb->s_blocksize;\r\nconst char *name = dp->d_name.name;\r\nint namelen = dp->d_name.len;\r\nnpages = dir_pages(ip);\r\nnblocks = dir_blocks(ip);\r\npblocks = VXFS_BLOCK_PER_PAGE(ip->i_sb);\r\nfor (page = 0; page < npages; page++) {\r\ncaddr_t kaddr;\r\nstruct page *pp;\r\npp = vxfs_get_page(ip->i_mapping, page);\r\nif (IS_ERR(pp))\r\ncontinue;\r\nkaddr = (caddr_t)page_address(pp);\r\nfor (block = 0; block <= nblocks && block <= pblocks; block++) {\r\ncaddr_t baddr, limit;\r\nstruct vxfs_dirblk *dbp;\r\nstruct vxfs_direct *de;\r\nbaddr = kaddr + (block * bsize);\r\nlimit = baddr + bsize - VXFS_DIRLEN(1);\r\ndbp = (struct vxfs_dirblk *)baddr;\r\nde = (struct vxfs_direct *)(baddr + VXFS_DIRBLKOV(dbp));\r\nfor (; (caddr_t)de <= limit; de = vxfs_next_entry(de)) {\r\nif (!de->d_reclen)\r\nbreak;\r\nif (!de->d_ino)\r\ncontinue;\r\nif (vxfs_match(namelen, name, de)) {\r\n*ppp = pp;\r\nreturn (de);\r\n}\r\n}\r\n}\r\nvxfs_put_page(pp);\r\n}\r\nreturn NULL;\r\n}\r\nstatic ino_t\r\nvxfs_inode_by_name(struct inode *dip, struct dentry *dp)\r\n{\r\nstruct vxfs_direct *de;\r\nstruct page *pp;\r\nino_t ino = 0;\r\nde = vxfs_find_entry(dip, dp, &pp);\r\nif (de) {\r\nino = de->d_ino;\r\nkunmap(pp);\r\npage_cache_release(pp);\r\n}\r\nreturn (ino);\r\n}\r\nstatic struct dentry *\r\nvxfs_lookup(struct inode *dip, struct dentry *dp, struct nameidata *nd)\r\n{\r\nstruct inode *ip = NULL;\r\nino_t ino;\r\nif (dp->d_name.len > VXFS_NAMELEN)\r\nreturn ERR_PTR(-ENAMETOOLONG);\r\nino = vxfs_inode_by_name(dip, dp);\r\nif (ino) {\r\nip = vxfs_iget(dip->i_sb, ino);\r\nif (IS_ERR(ip))\r\nreturn ERR_CAST(ip);\r\n}\r\nd_add(dp, ip);\r\nreturn NULL;\r\n}\r\nstatic int\r\nvxfs_readdir(struct file *fp, void *retp, filldir_t filler)\r\n{\r\nstruct inode *ip = fp->f_path.dentry->d_inode;\r\nstruct super_block *sbp = ip->i_sb;\r\nu_long bsize = sbp->s_blocksize;\r\nu_long page, npages, block, pblocks, nblocks, offset;\r\nloff_t pos;\r\nswitch ((long)fp->f_pos) {\r\ncase 0:\r\nif (filler(retp, ".", 1, fp->f_pos, ip->i_ino, DT_DIR) < 0)\r\ngoto out;\r\nfp->f_pos++;\r\ncase 1:\r\nif (filler(retp, "..", 2, fp->f_pos, VXFS_INO(ip)->vii_dotdot, DT_DIR) < 0)\r\ngoto out;\r\nfp->f_pos++;\r\n}\r\npos = fp->f_pos - 2;\r\nif (pos > VXFS_DIRROUND(ip->i_size))\r\nreturn 0;\r\nnpages = dir_pages(ip);\r\nnblocks = dir_blocks(ip);\r\npblocks = VXFS_BLOCK_PER_PAGE(sbp);\r\npage = pos >> PAGE_CACHE_SHIFT;\r\noffset = pos & ~PAGE_CACHE_MASK;\r\nblock = (u_long)(pos >> sbp->s_blocksize_bits) % pblocks;\r\nfor (; page < npages; page++, block = 0) {\r\ncaddr_t kaddr;\r\nstruct page *pp;\r\npp = vxfs_get_page(ip->i_mapping, page);\r\nif (IS_ERR(pp))\r\ncontinue;\r\nkaddr = (caddr_t)page_address(pp);\r\nfor (; block <= nblocks && block <= pblocks; block++) {\r\ncaddr_t baddr, limit;\r\nstruct vxfs_dirblk *dbp;\r\nstruct vxfs_direct *de;\r\nbaddr = kaddr + (block * bsize);\r\nlimit = baddr + bsize - VXFS_DIRLEN(1);\r\ndbp = (struct vxfs_dirblk *)baddr;\r\nde = (struct vxfs_direct *)\r\n(offset ?\r\n(kaddr + offset) :\r\n(baddr + VXFS_DIRBLKOV(dbp)));\r\nfor (; (caddr_t)de <= limit; de = vxfs_next_entry(de)) {\r\nint over;\r\nif (!de->d_reclen)\r\nbreak;\r\nif (!de->d_ino)\r\ncontinue;\r\noffset = (caddr_t)de - kaddr;\r\nover = filler(retp, de->d_name, de->d_namelen,\r\n((page << PAGE_CACHE_SHIFT) | offset) + 2,\r\nde->d_ino, DT_UNKNOWN);\r\nif (over) {\r\nvxfs_put_page(pp);\r\ngoto done;\r\n}\r\n}\r\noffset = 0;\r\n}\r\nvxfs_put_page(pp);\r\noffset = 0;\r\n}\r\ndone:\r\nfp->f_pos = ((page << PAGE_CACHE_SHIFT) | offset) + 2;\r\nout:\r\nreturn 0;\r\n}

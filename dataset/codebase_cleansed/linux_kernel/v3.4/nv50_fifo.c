static void\r\nnv50_fifo_playlist_update(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nstruct nouveau_gpuobj *cur;\r\nint i, nr;\r\nNV_DEBUG(dev, "\n");\r\ncur = pfifo->playlist[pfifo->cur_playlist];\r\npfifo->cur_playlist = !pfifo->cur_playlist;\r\nfor (i = 1, nr = 0; i < 127; i++) {\r\nif (dev_priv->channels.ptr[i] &&\r\ndev_priv->channels.ptr[i]->ramfc) {\r\nnv_wo32(cur, (nr * 4), i);\r\nnr++;\r\n}\r\n}\r\ndev_priv->engine.instmem.flush(dev);\r\nnv_wr32(dev, 0x32f4, cur->vinst >> 12);\r\nnv_wr32(dev, 0x32ec, nr);\r\nnv_wr32(dev, 0x2500, 0x101);\r\n}\r\nstatic void\r\nnv50_fifo_channel_enable(struct drm_device *dev, int channel)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_channel *chan = dev_priv->channels.ptr[channel];\r\nuint32_t inst;\r\nNV_DEBUG(dev, "ch%d\n", channel);\r\nif (dev_priv->chipset == 0x50)\r\ninst = chan->ramfc->vinst >> 12;\r\nelse\r\ninst = chan->ramfc->vinst >> 8;\r\nnv_wr32(dev, NV50_PFIFO_CTX_TABLE(channel), inst |\r\nNV50_PFIFO_CTX_TABLE_CHANNEL_ENABLED);\r\n}\r\nstatic void\r\nnv50_fifo_channel_disable(struct drm_device *dev, int channel)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nuint32_t inst;\r\nNV_DEBUG(dev, "ch%d\n", channel);\r\nif (dev_priv->chipset == 0x50)\r\ninst = NV50_PFIFO_CTX_TABLE_INSTANCE_MASK_G80;\r\nelse\r\ninst = NV50_PFIFO_CTX_TABLE_INSTANCE_MASK_G84;\r\nnv_wr32(dev, NV50_PFIFO_CTX_TABLE(channel), inst);\r\n}\r\nstatic void\r\nnv50_fifo_init_reset(struct drm_device *dev)\r\n{\r\nuint32_t pmc_e = NV_PMC_ENABLE_PFIFO;\r\nNV_DEBUG(dev, "\n");\r\nnv_wr32(dev, NV03_PMC_ENABLE, nv_rd32(dev, NV03_PMC_ENABLE) & ~pmc_e);\r\nnv_wr32(dev, NV03_PMC_ENABLE, nv_rd32(dev, NV03_PMC_ENABLE) | pmc_e);\r\n}\r\nstatic void\r\nnv50_fifo_init_intr(struct drm_device *dev)\r\n{\r\nNV_DEBUG(dev, "\n");\r\nnouveau_irq_register(dev, 8, nv04_fifo_isr);\r\nnv_wr32(dev, NV03_PFIFO_INTR_0, 0xFFFFFFFF);\r\nnv_wr32(dev, NV03_PFIFO_INTR_EN_0, 0xFFFFFFFF);\r\n}\r\nstatic void\r\nnv50_fifo_init_context_table(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nint i;\r\nNV_DEBUG(dev, "\n");\r\nfor (i = 0; i < NV50_PFIFO_CTX_TABLE__SIZE; i++) {\r\nif (dev_priv->channels.ptr[i])\r\nnv50_fifo_channel_enable(dev, i);\r\nelse\r\nnv50_fifo_channel_disable(dev, i);\r\n}\r\nnv50_fifo_playlist_update(dev);\r\n}\r\nstatic void\r\nnv50_fifo_init_regs__nv(struct drm_device *dev)\r\n{\r\nNV_DEBUG(dev, "\n");\r\nnv_wr32(dev, 0x250c, 0x6f3cfc34);\r\n}\r\nstatic void\r\nnv50_fifo_init_regs(struct drm_device *dev)\r\n{\r\nNV_DEBUG(dev, "\n");\r\nnv_wr32(dev, 0x2500, 0);\r\nnv_wr32(dev, 0x3250, 0);\r\nnv_wr32(dev, 0x3220, 0);\r\nnv_wr32(dev, 0x3204, 0);\r\nnv_wr32(dev, 0x3210, 0);\r\nnv_wr32(dev, 0x3270, 0);\r\nnv_wr32(dev, 0x2044, 0x01003fff);\r\nnv50_fifo_channel_enable(dev, 0);\r\nnv50_fifo_channel_enable(dev, 127);\r\n}\r\nint\r\nnv50_fifo_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nint ret;\r\nNV_DEBUG(dev, "\n");\r\nif (pfifo->playlist[0]) {\r\npfifo->cur_playlist = !pfifo->cur_playlist;\r\ngoto just_reset;\r\n}\r\nret = nouveau_gpuobj_new(dev, NULL, 128*4, 0x1000,\r\nNVOBJ_FLAG_ZERO_ALLOC,\r\n&pfifo->playlist[0]);\r\nif (ret) {\r\nNV_ERROR(dev, "error creating playlist 0: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = nouveau_gpuobj_new(dev, NULL, 128*4, 0x1000,\r\nNVOBJ_FLAG_ZERO_ALLOC,\r\n&pfifo->playlist[1]);\r\nif (ret) {\r\nnouveau_gpuobj_ref(NULL, &pfifo->playlist[0]);\r\nNV_ERROR(dev, "error creating playlist 1: %d\n", ret);\r\nreturn ret;\r\n}\r\njust_reset:\r\nnv50_fifo_init_reset(dev);\r\nnv50_fifo_init_intr(dev);\r\nnv50_fifo_init_context_table(dev);\r\nnv50_fifo_init_regs__nv(dev);\r\nnv50_fifo_init_regs(dev);\r\ndev_priv->engine.fifo.enable(dev);\r\ndev_priv->engine.fifo.reassign(dev, true);\r\nreturn 0;\r\n}\r\nvoid\r\nnv50_fifo_takedown(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nNV_DEBUG(dev, "\n");\r\nif (!pfifo->playlist[0])\r\nreturn;\r\nnv_wr32(dev, 0x2140, 0x00000000);\r\nnouveau_irq_unregister(dev, 8);\r\nnouveau_gpuobj_ref(NULL, &pfifo->playlist[0]);\r\nnouveau_gpuobj_ref(NULL, &pfifo->playlist[1]);\r\n}\r\nint\r\nnv50_fifo_channel_id(struct drm_device *dev)\r\n{\r\nreturn nv_rd32(dev, NV03_PFIFO_CACHE1_PUSH1) &\r\nNV50_PFIFO_CACHE1_PUSH1_CHID_MASK;\r\n}\r\nint\r\nnv50_fifo_create_context(struct nouveau_channel *chan)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_gpuobj *ramfc = NULL;\r\nuint64_t ib_offset = chan->pushbuf_base + chan->dma.ib_base * 4;\r\nunsigned long flags;\r\nint ret;\r\nNV_DEBUG(dev, "ch%d\n", chan->id);\r\nif (dev_priv->chipset == 0x50) {\r\nret = nouveau_gpuobj_new_fake(dev, chan->ramin->pinst,\r\nchan->ramin->vinst, 0x100,\r\nNVOBJ_FLAG_ZERO_ALLOC |\r\nNVOBJ_FLAG_ZERO_FREE,\r\n&chan->ramfc);\r\nif (ret)\r\nreturn ret;\r\nret = nouveau_gpuobj_new_fake(dev, chan->ramin->pinst + 0x0400,\r\nchan->ramin->vinst + 0x0400,\r\n4096, 0, &chan->cache);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\nret = nouveau_gpuobj_new(dev, chan, 0x100, 256,\r\nNVOBJ_FLAG_ZERO_ALLOC |\r\nNVOBJ_FLAG_ZERO_FREE, &chan->ramfc);\r\nif (ret)\r\nreturn ret;\r\nret = nouveau_gpuobj_new(dev, chan, 4096, 1024,\r\n0, &chan->cache);\r\nif (ret)\r\nreturn ret;\r\n}\r\nramfc = chan->ramfc;\r\nchan->user = ioremap(pci_resource_start(dev->pdev, 0) +\r\nNV50_USER(chan->id), PAGE_SIZE);\r\nif (!chan->user)\r\nreturn -ENOMEM;\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\nnv_wo32(ramfc, 0x48, chan->pushbuf->cinst >> 4);\r\nnv_wo32(ramfc, 0x80, ((chan->ramht->bits - 9) << 27) |\r\n(4 << 24) |\r\n(chan->ramht->gpuobj->cinst >> 4));\r\nnv_wo32(ramfc, 0x44, 0x01003fff);\r\nnv_wo32(ramfc, 0x60, 0x7fffffff);\r\nnv_wo32(ramfc, 0x40, 0x00000000);\r\nnv_wo32(ramfc, 0x7c, 0x30000001);\r\nnv_wo32(ramfc, 0x78, 0x00000000);\r\nnv_wo32(ramfc, 0x3c, 0x403f6078);\r\nnv_wo32(ramfc, 0x50, lower_32_bits(ib_offset));\r\nnv_wo32(ramfc, 0x54, upper_32_bits(ib_offset) |\r\ndrm_order(chan->dma.ib_max + 1) << 16);\r\nif (dev_priv->chipset != 0x50) {\r\nnv_wo32(chan->ramin, 0, chan->id);\r\nnv_wo32(chan->ramin, 4, chan->ramfc->vinst >> 8);\r\nnv_wo32(ramfc, 0x88, chan->cache->vinst >> 10);\r\nnv_wo32(ramfc, 0x98, chan->ramin->vinst >> 12);\r\n}\r\ndev_priv->engine.instmem.flush(dev);\r\nnv50_fifo_channel_enable(dev, chan->id);\r\nnv50_fifo_playlist_update(dev);\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\nreturn 0;\r\n}\r\nvoid\r\nnv50_fifo_destroy_context(struct nouveau_channel *chan)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nstruct nouveau_gpuobj *ramfc = NULL;\r\nunsigned long flags;\r\nNV_DEBUG(dev, "ch%d\n", chan->id);\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\npfifo->reassign(dev, false);\r\nif (pfifo->channel_id(dev) == chan->id) {\r\npfifo->disable(dev);\r\npfifo->unload_context(dev);\r\npfifo->enable(dev);\r\n}\r\nnouveau_gpuobj_ref(chan->ramfc, &ramfc);\r\nnouveau_gpuobj_ref(NULL, &chan->ramfc);\r\nnv50_fifo_channel_disable(dev, chan->id);\r\nif (chan->id == 0)\r\nnv50_fifo_channel_disable(dev, 127);\r\nnv50_fifo_playlist_update(dev);\r\npfifo->reassign(dev, true);\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\nif (chan->user) {\r\niounmap(chan->user);\r\nchan->user = NULL;\r\n}\r\nnouveau_gpuobj_ref(NULL, &ramfc);\r\nnouveau_gpuobj_ref(NULL, &chan->cache);\r\n}\r\nint\r\nnv50_fifo_load_context(struct nouveau_channel *chan)\r\n{\r\nstruct drm_device *dev = chan->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_gpuobj *ramfc = chan->ramfc;\r\nstruct nouveau_gpuobj *cache = chan->cache;\r\nint ptr, cnt;\r\nNV_DEBUG(dev, "ch%d\n", chan->id);\r\nnv_wr32(dev, 0x3330, nv_ro32(ramfc, 0x00));\r\nnv_wr32(dev, 0x3334, nv_ro32(ramfc, 0x04));\r\nnv_wr32(dev, 0x3240, nv_ro32(ramfc, 0x08));\r\nnv_wr32(dev, 0x3320, nv_ro32(ramfc, 0x0c));\r\nnv_wr32(dev, 0x3244, nv_ro32(ramfc, 0x10));\r\nnv_wr32(dev, 0x3328, nv_ro32(ramfc, 0x14));\r\nnv_wr32(dev, 0x3368, nv_ro32(ramfc, 0x18));\r\nnv_wr32(dev, 0x336c, nv_ro32(ramfc, 0x1c));\r\nnv_wr32(dev, 0x3370, nv_ro32(ramfc, 0x20));\r\nnv_wr32(dev, 0x3374, nv_ro32(ramfc, 0x24));\r\nnv_wr32(dev, 0x3378, nv_ro32(ramfc, 0x28));\r\nnv_wr32(dev, 0x337c, nv_ro32(ramfc, 0x2c));\r\nnv_wr32(dev, 0x3228, nv_ro32(ramfc, 0x30));\r\nnv_wr32(dev, 0x3364, nv_ro32(ramfc, 0x34));\r\nnv_wr32(dev, 0x32a0, nv_ro32(ramfc, 0x38));\r\nnv_wr32(dev, 0x3224, nv_ro32(ramfc, 0x3c));\r\nnv_wr32(dev, 0x324c, nv_ro32(ramfc, 0x40));\r\nnv_wr32(dev, 0x2044, nv_ro32(ramfc, 0x44));\r\nnv_wr32(dev, 0x322c, nv_ro32(ramfc, 0x48));\r\nnv_wr32(dev, 0x3234, nv_ro32(ramfc, 0x4c));\r\nnv_wr32(dev, 0x3340, nv_ro32(ramfc, 0x50));\r\nnv_wr32(dev, 0x3344, nv_ro32(ramfc, 0x54));\r\nnv_wr32(dev, 0x3280, nv_ro32(ramfc, 0x58));\r\nnv_wr32(dev, 0x3254, nv_ro32(ramfc, 0x5c));\r\nnv_wr32(dev, 0x3260, nv_ro32(ramfc, 0x60));\r\nnv_wr32(dev, 0x3264, nv_ro32(ramfc, 0x64));\r\nnv_wr32(dev, 0x3268, nv_ro32(ramfc, 0x68));\r\nnv_wr32(dev, 0x326c, nv_ro32(ramfc, 0x6c));\r\nnv_wr32(dev, 0x32e4, nv_ro32(ramfc, 0x70));\r\nnv_wr32(dev, 0x3248, nv_ro32(ramfc, 0x74));\r\nnv_wr32(dev, 0x2088, nv_ro32(ramfc, 0x78));\r\nnv_wr32(dev, 0x2058, nv_ro32(ramfc, 0x7c));\r\nnv_wr32(dev, 0x2210, nv_ro32(ramfc, 0x80));\r\ncnt = nv_ro32(ramfc, 0x84);\r\nfor (ptr = 0; ptr < cnt; ptr++) {\r\nnv_wr32(dev, NV40_PFIFO_CACHE1_METHOD(ptr),\r\nnv_ro32(cache, (ptr * 8) + 0));\r\nnv_wr32(dev, NV40_PFIFO_CACHE1_DATA(ptr),\r\nnv_ro32(cache, (ptr * 8) + 4));\r\n}\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUT, cnt << 2);\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_GET, 0);\r\nif (dev_priv->chipset != 0x50) {\r\nnv_wr32(dev, 0x340c, nv_ro32(ramfc, 0x88));\r\nnv_wr32(dev, 0x3400, nv_ro32(ramfc, 0x8c));\r\nnv_wr32(dev, 0x3404, nv_ro32(ramfc, 0x90));\r\nnv_wr32(dev, 0x3408, nv_ro32(ramfc, 0x94));\r\nnv_wr32(dev, 0x3410, nv_ro32(ramfc, 0x98));\r\n}\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUSH1, chan->id | (1<<16));\r\nreturn 0;\r\n}\r\nint\r\nnv50_fifo_unload_context(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nstruct nouveau_fifo_engine *pfifo = &dev_priv->engine.fifo;\r\nstruct nouveau_gpuobj *ramfc, *cache;\r\nstruct nouveau_channel *chan = NULL;\r\nint chid, get, put, ptr;\r\nNV_DEBUG(dev, "\n");\r\nchid = pfifo->channel_id(dev);\r\nif (chid < 1 || chid >= dev_priv->engine.fifo.channels - 1)\r\nreturn 0;\r\nchan = dev_priv->channels.ptr[chid];\r\nif (!chan) {\r\nNV_ERROR(dev, "Inactive channel on PFIFO: %d\n", chid);\r\nreturn -EINVAL;\r\n}\r\nNV_DEBUG(dev, "ch%d\n", chan->id);\r\nramfc = chan->ramfc;\r\ncache = chan->cache;\r\nnv_wo32(ramfc, 0x00, nv_rd32(dev, 0x3330));\r\nnv_wo32(ramfc, 0x04, nv_rd32(dev, 0x3334));\r\nnv_wo32(ramfc, 0x08, nv_rd32(dev, 0x3240));\r\nnv_wo32(ramfc, 0x0c, nv_rd32(dev, 0x3320));\r\nnv_wo32(ramfc, 0x10, nv_rd32(dev, 0x3244));\r\nnv_wo32(ramfc, 0x14, nv_rd32(dev, 0x3328));\r\nnv_wo32(ramfc, 0x18, nv_rd32(dev, 0x3368));\r\nnv_wo32(ramfc, 0x1c, nv_rd32(dev, 0x336c));\r\nnv_wo32(ramfc, 0x20, nv_rd32(dev, 0x3370));\r\nnv_wo32(ramfc, 0x24, nv_rd32(dev, 0x3374));\r\nnv_wo32(ramfc, 0x28, nv_rd32(dev, 0x3378));\r\nnv_wo32(ramfc, 0x2c, nv_rd32(dev, 0x337c));\r\nnv_wo32(ramfc, 0x30, nv_rd32(dev, 0x3228));\r\nnv_wo32(ramfc, 0x34, nv_rd32(dev, 0x3364));\r\nnv_wo32(ramfc, 0x38, nv_rd32(dev, 0x32a0));\r\nnv_wo32(ramfc, 0x3c, nv_rd32(dev, 0x3224));\r\nnv_wo32(ramfc, 0x40, nv_rd32(dev, 0x324c));\r\nnv_wo32(ramfc, 0x44, nv_rd32(dev, 0x2044));\r\nnv_wo32(ramfc, 0x48, nv_rd32(dev, 0x322c));\r\nnv_wo32(ramfc, 0x4c, nv_rd32(dev, 0x3234));\r\nnv_wo32(ramfc, 0x50, nv_rd32(dev, 0x3340));\r\nnv_wo32(ramfc, 0x54, nv_rd32(dev, 0x3344));\r\nnv_wo32(ramfc, 0x58, nv_rd32(dev, 0x3280));\r\nnv_wo32(ramfc, 0x5c, nv_rd32(dev, 0x3254));\r\nnv_wo32(ramfc, 0x60, nv_rd32(dev, 0x3260));\r\nnv_wo32(ramfc, 0x64, nv_rd32(dev, 0x3264));\r\nnv_wo32(ramfc, 0x68, nv_rd32(dev, 0x3268));\r\nnv_wo32(ramfc, 0x6c, nv_rd32(dev, 0x326c));\r\nnv_wo32(ramfc, 0x70, nv_rd32(dev, 0x32e4));\r\nnv_wo32(ramfc, 0x74, nv_rd32(dev, 0x3248));\r\nnv_wo32(ramfc, 0x78, nv_rd32(dev, 0x2088));\r\nnv_wo32(ramfc, 0x7c, nv_rd32(dev, 0x2058));\r\nnv_wo32(ramfc, 0x80, nv_rd32(dev, 0x2210));\r\nput = (nv_rd32(dev, NV03_PFIFO_CACHE1_PUT) & 0x7ff) >> 2;\r\nget = (nv_rd32(dev, NV03_PFIFO_CACHE1_GET) & 0x7ff) >> 2;\r\nptr = 0;\r\nwhile (put != get) {\r\nnv_wo32(cache, ptr + 0,\r\nnv_rd32(dev, NV40_PFIFO_CACHE1_METHOD(get)));\r\nnv_wo32(cache, ptr + 4,\r\nnv_rd32(dev, NV40_PFIFO_CACHE1_DATA(get)));\r\nget = (get + 1) & 0x1ff;\r\nptr += 8;\r\n}\r\nif (dev_priv->chipset != 0x50) {\r\nnv_wo32(ramfc, 0x84, ptr >> 3);\r\nnv_wo32(ramfc, 0x88, nv_rd32(dev, 0x340c));\r\nnv_wo32(ramfc, 0x8c, nv_rd32(dev, 0x3400));\r\nnv_wo32(ramfc, 0x90, nv_rd32(dev, 0x3404));\r\nnv_wo32(ramfc, 0x94, nv_rd32(dev, 0x3408));\r\nnv_wo32(ramfc, 0x98, nv_rd32(dev, 0x3410));\r\n}\r\ndev_priv->engine.instmem.flush(dev);\r\nnv_wr32(dev, NV03_PFIFO_CACHE1_PUSH1, 127);\r\nreturn 0;\r\n}\r\nvoid\r\nnv50_fifo_tlb_flush(struct drm_device *dev)\r\n{\r\nnv50_vm_flush_engine(dev, 5);\r\n}

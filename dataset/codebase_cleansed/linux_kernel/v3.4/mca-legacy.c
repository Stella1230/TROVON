static int mca_find_adapter_callback(struct device *dev, void *data)\r\n{\r\nstruct mca_find_adapter_info *info = data;\r\nstruct mca_device *mca_dev = to_mca_device(dev);\r\nif(mca_dev->pos_id != info->id)\r\nreturn 0;\r\nif(mca_dev->slot < info->slot)\r\nreturn 0;\r\nif(!info->mca_dev || info->mca_dev->slot >= mca_dev->slot)\r\ninfo->mca_dev = mca_dev;\r\nreturn 0;\r\n}\r\nint mca_find_adapter(int id, int start)\r\n{\r\nstruct mca_find_adapter_info info;\r\nif(id == 0xffff)\r\nreturn MCA_NOTFOUND;\r\ninfo.slot = start;\r\ninfo.id = id;\r\ninfo.mca_dev = NULL;\r\nfor(;;) {\r\nbus_for_each_dev(&mca_bus_type, NULL, &info, mca_find_adapter_callback);\r\nif(info.mca_dev == NULL)\r\nreturn MCA_NOTFOUND;\r\nif(info.mca_dev->status != MCA_ADAPTER_DISABLED)\r\nbreak;\r\ninfo.slot = info.mca_dev->slot + 1;\r\ninfo.mca_dev = NULL;\r\n}\r\nreturn info.mca_dev->slot;\r\n}\r\nint mca_find_unused_adapter(int id, int start)\r\n{\r\nstruct mca_find_adapter_info info = { 0 };\r\nif (!MCA_bus || id == 0xffff)\r\nreturn MCA_NOTFOUND;\r\ninfo.slot = start;\r\ninfo.id = id;\r\ninfo.mca_dev = NULL;\r\nfor(;;) {\r\nbus_for_each_dev(&mca_bus_type, NULL, &info, mca_find_adapter_callback);\r\nif(info.mca_dev == NULL)\r\nreturn MCA_NOTFOUND;\r\nif(info.mca_dev->status != MCA_ADAPTER_DISABLED\r\n&& !info.mca_dev->driver_loaded)\r\nbreak;\r\ninfo.slot = info.mca_dev->slot + 1;\r\ninfo.mca_dev = NULL;\r\n}\r\nreturn info.mca_dev->slot;\r\n}\r\nstatic int mca_find_device_by_slot_callback(struct device *dev, void *data)\r\n{\r\nstruct mca_find_device_by_slot_info *info = data;\r\nstruct mca_device *mca_dev = to_mca_device(dev);\r\nif(mca_dev->slot == info->slot)\r\ninfo->mca_dev = mca_dev;\r\nreturn 0;\r\n}\r\nstruct mca_device *mca_find_device_by_slot(int slot)\r\n{\r\nstruct mca_find_device_by_slot_info info;\r\ninfo.slot = slot;\r\ninfo.mca_dev = NULL;\r\nbus_for_each_dev(&mca_bus_type, NULL, &info, mca_find_device_by_slot_callback);\r\nreturn info.mca_dev;\r\n}\r\nunsigned char mca_read_stored_pos(int slot, int reg)\r\n{\r\nstruct mca_device *mca_dev = mca_find_device_by_slot(slot);\r\nif(!mca_dev)\r\nreturn 0;\r\nreturn mca_device_read_stored_pos(mca_dev, reg);\r\n}\r\nunsigned char mca_read_pos(int slot, int reg)\r\n{\r\nstruct mca_device *mca_dev = mca_find_device_by_slot(slot);\r\nif(!mca_dev)\r\nreturn 0;\r\nreturn mca_device_read_pos(mca_dev, reg);\r\n}\r\nvoid mca_write_pos(int slot, int reg, unsigned char byte)\r\n{\r\nstruct mca_device *mca_dev = mca_find_device_by_slot(slot);\r\nif(!mca_dev)\r\nreturn;\r\nmca_device_write_pos(mca_dev, reg, byte);\r\n}\r\nvoid mca_set_adapter_name(int slot, char* name)\r\n{\r\nstruct mca_device *mca_dev = mca_find_device_by_slot(slot);\r\nif(!mca_dev)\r\nreturn;\r\nmca_device_set_name(mca_dev, name);\r\n}\r\nint mca_mark_as_used(int slot)\r\n{\r\nstruct mca_device *mca_dev = mca_find_device_by_slot(slot);\r\nif(!mca_dev)\r\nreturn 1;\r\nif(mca_device_claimed(mca_dev))\r\nreturn 1;\r\nmca_device_set_claim(mca_dev, 1);\r\nreturn 0;\r\n}\r\nvoid mca_mark_as_unused(int slot)\r\n{\r\nstruct mca_device *mca_dev = mca_find_device_by_slot(slot);\r\nif(!mca_dev)\r\nreturn;\r\nmca_device_set_claim(mca_dev, 0);\r\n}

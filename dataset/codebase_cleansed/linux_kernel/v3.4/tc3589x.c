int tc3589x_reg_read(struct tc3589x *tc3589x, u8 reg)\r\n{\r\nint ret;\r\nret = i2c_smbus_read_byte_data(tc3589x->i2c, reg);\r\nif (ret < 0)\r\ndev_err(tc3589x->dev, "failed to read reg %#x: %d\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nint tc3589x_reg_write(struct tc3589x *tc3589x, u8 reg, u8 data)\r\n{\r\nint ret;\r\nret = i2c_smbus_write_byte_data(tc3589x->i2c, reg, data);\r\nif (ret < 0)\r\ndev_err(tc3589x->dev, "failed to write reg %#x: %d\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nint tc3589x_block_read(struct tc3589x *tc3589x, u8 reg, u8 length, u8 *values)\r\n{\r\nint ret;\r\nret = i2c_smbus_read_i2c_block_data(tc3589x->i2c, reg, length, values);\r\nif (ret < 0)\r\ndev_err(tc3589x->dev, "failed to read regs %#x: %d\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nint tc3589x_block_write(struct tc3589x *tc3589x, u8 reg, u8 length,\r\nconst u8 *values)\r\n{\r\nint ret;\r\nret = i2c_smbus_write_i2c_block_data(tc3589x->i2c, reg, length,\r\nvalues);\r\nif (ret < 0)\r\ndev_err(tc3589x->dev, "failed to write regs %#x: %d\n",\r\nreg, ret);\r\nreturn ret;\r\n}\r\nint tc3589x_set_bits(struct tc3589x *tc3589x, u8 reg, u8 mask, u8 val)\r\n{\r\nint ret;\r\nmutex_lock(&tc3589x->lock);\r\nret = tc3589x_reg_read(tc3589x, reg);\r\nif (ret < 0)\r\ngoto out;\r\nret &= ~mask;\r\nret |= val;\r\nret = tc3589x_reg_write(tc3589x, reg, ret);\r\nout:\r\nmutex_unlock(&tc3589x->lock);\r\nreturn ret;\r\n}\r\nstatic irqreturn_t tc3589x_irq(int irq, void *data)\r\n{\r\nstruct tc3589x *tc3589x = data;\r\nint status;\r\nagain:\r\nstatus = tc3589x_reg_read(tc3589x, TC3589x_IRQST);\r\nif (status < 0)\r\nreturn IRQ_NONE;\r\nwhile (status) {\r\nint bit = __ffs(status);\r\nhandle_nested_irq(tc3589x->irq_base + bit);\r\nstatus &= ~(1 << bit);\r\n}\r\nstatus = tc3589x_reg_read(tc3589x, TC3589x_IRQST);\r\nif (status)\r\ngoto again;\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int tc3589x_irq_init(struct tc3589x *tc3589x)\r\n{\r\nint base = tc3589x->irq_base;\r\nint irq;\r\nfor (irq = base; irq < base + TC3589x_NR_INTERNAL_IRQS; irq++) {\r\nirq_set_chip_data(irq, tc3589x);\r\nirq_set_chip_and_handler(irq, &dummy_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(irq);\r\n#endif\r\n}\r\nreturn 0;\r\n}\r\nstatic void tc3589x_irq_remove(struct tc3589x *tc3589x)\r\n{\r\nint base = tc3589x->irq_base;\r\nint irq;\r\nfor (irq = base; irq < base + TC3589x_NR_INTERNAL_IRQS; irq++) {\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, 0);\r\n#endif\r\nirq_set_chip_and_handler(irq, NULL, NULL);\r\nirq_set_chip_data(irq, NULL);\r\n}\r\n}\r\nstatic int tc3589x_chip_init(struct tc3589x *tc3589x)\r\n{\r\nint manf, ver, ret;\r\nmanf = tc3589x_reg_read(tc3589x, TC3589x_MANFCODE);\r\nif (manf < 0)\r\nreturn manf;\r\nver = tc3589x_reg_read(tc3589x, TC3589x_VERSION);\r\nif (ver < 0)\r\nreturn ver;\r\nif (manf != TC3589x_MANFCODE_MAGIC) {\r\ndev_err(tc3589x->dev, "unknown manufacturer: %#x\n", manf);\r\nreturn -EINVAL;\r\n}\r\ndev_info(tc3589x->dev, "manufacturer: %#x, version: %#x\n", manf, ver);\r\nret = tc3589x_reg_write(tc3589x, TC3589x_RSTCTRL,\r\nTC3589x_RSTCTRL_TIMRST\r\n| TC3589x_RSTCTRL_ROTRST\r\n| TC3589x_RSTCTRL_KBDRST);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn tc3589x_reg_write(tc3589x, TC3589x_RSTINTCLR, 0x1);\r\n}\r\nstatic int __devinit tc3589x_device_init(struct tc3589x *tc3589x)\r\n{\r\nint ret = 0;\r\nunsigned int blocks = tc3589x->pdata->block;\r\nif (blocks & TC3589x_BLOCK_GPIO) {\r\nret = mfd_add_devices(tc3589x->dev, -1, tc3589x_dev_gpio,\r\nARRAY_SIZE(tc3589x_dev_gpio), NULL,\r\ntc3589x->irq_base);\r\nif (ret) {\r\ndev_err(tc3589x->dev, "failed to add gpio child\n");\r\nreturn ret;\r\n}\r\ndev_info(tc3589x->dev, "added gpio block\n");\r\n}\r\nif (blocks & TC3589x_BLOCK_KEYPAD) {\r\nret = mfd_add_devices(tc3589x->dev, -1, tc3589x_dev_keypad,\r\nARRAY_SIZE(tc3589x_dev_keypad), NULL,\r\ntc3589x->irq_base);\r\nif (ret) {\r\ndev_err(tc3589x->dev, "failed to keypad child\n");\r\nreturn ret;\r\n}\r\ndev_info(tc3589x->dev, "added keypad block\n");\r\n}\r\nreturn ret;\r\n}\r\nstatic int __devinit tc3589x_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tc3589x_platform_data *pdata = i2c->dev.platform_data;\r\nstruct tc3589x *tc3589x;\r\nint ret;\r\nif (!i2c_check_functionality(i2c->adapter, I2C_FUNC_SMBUS_BYTE_DATA\r\n| I2C_FUNC_SMBUS_I2C_BLOCK))\r\nreturn -EIO;\r\ntc3589x = kzalloc(sizeof(struct tc3589x), GFP_KERNEL);\r\nif (!tc3589x)\r\nreturn -ENOMEM;\r\nmutex_init(&tc3589x->lock);\r\ntc3589x->dev = &i2c->dev;\r\ntc3589x->i2c = i2c;\r\ntc3589x->pdata = pdata;\r\ntc3589x->irq_base = pdata->irq_base;\r\ntc3589x->num_gpio = id->driver_data;\r\ni2c_set_clientdata(i2c, tc3589x);\r\nret = tc3589x_chip_init(tc3589x);\r\nif (ret)\r\ngoto out_free;\r\nret = tc3589x_irq_init(tc3589x);\r\nif (ret)\r\ngoto out_free;\r\nret = request_threaded_irq(tc3589x->i2c->irq, NULL, tc3589x_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\n"tc3589x", tc3589x);\r\nif (ret) {\r\ndev_err(tc3589x->dev, "failed to request IRQ: %d\n", ret);\r\ngoto out_removeirq;\r\n}\r\nret = tc3589x_device_init(tc3589x);\r\nif (ret) {\r\ndev_err(tc3589x->dev, "failed to add child devices\n");\r\ngoto out_freeirq;\r\n}\r\nreturn 0;\r\nout_freeirq:\r\nfree_irq(tc3589x->i2c->irq, tc3589x);\r\nout_removeirq:\r\ntc3589x_irq_remove(tc3589x);\r\nout_free:\r\nkfree(tc3589x);\r\nreturn ret;\r\n}\r\nstatic int __devexit tc3589x_remove(struct i2c_client *client)\r\n{\r\nstruct tc3589x *tc3589x = i2c_get_clientdata(client);\r\nmfd_remove_devices(tc3589x->dev);\r\nfree_irq(tc3589x->i2c->irq, tc3589x);\r\ntc3589x_irq_remove(tc3589x);\r\nkfree(tc3589x);\r\nreturn 0;\r\n}\r\nstatic int tc3589x_suspend(struct device *dev)\r\n{\r\nstruct tc3589x *tc3589x = dev_get_drvdata(dev);\r\nstruct i2c_client *client = tc3589x->i2c;\r\nint ret = 0;\r\nif (!device_may_wakeup(&client->dev))\r\nret = tc3589x_reg_write(tc3589x, TC3589x_CLKMODE,\r\nTC3589x_CLKMODE_MODCTL_SLEEP);\r\nreturn ret;\r\n}\r\nstatic int tc3589x_resume(struct device *dev)\r\n{\r\nstruct tc3589x *tc3589x = dev_get_drvdata(dev);\r\nstruct i2c_client *client = tc3589x->i2c;\r\nint ret = 0;\r\nif (!device_may_wakeup(&client->dev))\r\nret = tc3589x_reg_write(tc3589x, TC3589x_CLKMODE,\r\nTC3589x_CLKMODE_MODCTL_OPERATION);\r\nreturn ret;\r\n}\r\nstatic int __init tc3589x_init(void)\r\n{\r\nreturn i2c_add_driver(&tc3589x_driver);\r\n}\r\nstatic void __exit tc3589x_exit(void)\r\n{\r\ni2c_del_driver(&tc3589x_driver);\r\n}

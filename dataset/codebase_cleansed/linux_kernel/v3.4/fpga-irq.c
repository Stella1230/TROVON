static void fpga_irq_mask(struct irq_data *d)\r\n{\r\nstruct fpga_irq_data *f = irq_data_get_irq_chip_data(d);\r\nu32 mask = 1 << (d->irq - f->irq_start);\r\nwritel(mask, f->base + IRQ_ENABLE_CLEAR);\r\n}\r\nstatic void fpga_irq_unmask(struct irq_data *d)\r\n{\r\nstruct fpga_irq_data *f = irq_data_get_irq_chip_data(d);\r\nu32 mask = 1 << (d->irq - f->irq_start);\r\nwritel(mask, f->base + IRQ_ENABLE_SET);\r\n}\r\nstatic void fpga_irq_handle(unsigned int irq, struct irq_desc *desc)\r\n{\r\nstruct fpga_irq_data *f = irq_desc_get_handler_data(desc);\r\nu32 status = readl(f->base + IRQ_STATUS);\r\nif (status == 0) {\r\ndo_bad_IRQ(irq, desc);\r\nreturn;\r\n}\r\ndo {\r\nirq = ffs(status) - 1;\r\nstatus &= ~(1 << irq);\r\ngeneric_handle_irq(irq + f->irq_start);\r\n} while (status);\r\n}\r\nvoid __init fpga_irq_init(int parent_irq, u32 valid, struct fpga_irq_data *f)\r\n{\r\nunsigned int i;\r\nf->chip.irq_ack = fpga_irq_mask;\r\nf->chip.irq_mask = fpga_irq_mask;\r\nf->chip.irq_unmask = fpga_irq_unmask;\r\nif (parent_irq != -1) {\r\nirq_set_handler_data(parent_irq, f);\r\nirq_set_chained_handler(parent_irq, fpga_irq_handle);\r\n}\r\nfor (i = 0; i < 32; i++) {\r\nif (valid & (1 << i)) {\r\nunsigned int irq = f->irq_start + i;\r\nirq_set_chip_data(irq, f);\r\nirq_set_chip_and_handler(irq, &f->chip,\r\nhandle_level_irq);\r\nset_irq_flags(irq, IRQF_VALID | IRQF_PROBE);\r\n}\r\n}\r\n}

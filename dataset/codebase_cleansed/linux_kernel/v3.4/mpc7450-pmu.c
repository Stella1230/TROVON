static int mpc7450_classify_event(u32 event)\r\n{\r\nint pmc;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc) {\r\nif (pmc > N_COUNTER)\r\nreturn -1;\r\nreturn 4;\r\n}\r\nevent &= PM_PMCSEL_MSK;\r\nif (event <= 1)\r\nreturn 0;\r\nif (event <= 7)\r\nreturn 1;\r\nif (event <= 13)\r\nreturn 2;\r\nif (event <= 22)\r\nreturn 3;\r\nreturn -1;\r\n}\r\nstatic int mpc7450_threshold_use(u32 event)\r\n{\r\nint pmc, sel;\r\npmc = (event >> PM_PMC_SH) & PM_PMC_MSK;\r\nsel = event & PM_PMCSEL_MSK;\r\nswitch (pmc) {\r\ncase 1:\r\nif (sel == 0x1e || sel == 0x1f)\r\nreturn 1;\r\nif (sel == 0x28 || sel == 0x2b)\r\nreturn 2;\r\nbreak;\r\ncase 2:\r\nif (sel == 0x20)\r\nreturn 1;\r\nbreak;\r\ncase 3:\r\nif (sel == 0xc || sel == 0xd)\r\nreturn 1;\r\nif (sel == 0x11)\r\nreturn 2;\r\nbreak;\r\ncase 4:\r\nif (sel == 0x10)\r\nreturn 1;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mpc7450_get_constraint(u64 event, unsigned long *maskp,\r\nunsigned long *valp)\r\n{\r\nint pmc, class;\r\nu32 mask, value;\r\nint thresh, tuse;\r\nclass = mpc7450_classify_event(event);\r\nif (class < 0)\r\nreturn -1;\r\nif (class == 4) {\r\npmc = ((unsigned int)event >> PM_PMC_SH) & PM_PMC_MSK;\r\nmask = pmcbits[pmc - 1][0];\r\nvalue = pmcbits[pmc - 1][1];\r\n} else {\r\nmask = classbits[class][0];\r\nvalue = classbits[class][1];\r\n}\r\ntuse = mpc7450_threshold_use(event);\r\nif (tuse) {\r\nthresh = ((unsigned int)event >> PM_THRESH_SH) & PM_THRESH_MSK;\r\nmask |= 0x3f << 24;\r\nvalue |= thresh << 24;\r\nif (tuse == 2) {\r\nmask |= 0x40000000;\r\nif ((unsigned int)event & PM_THRMULT_MSKS)\r\nvalue |= 0x40000000;\r\n}\r\n}\r\n*maskp = mask;\r\n*valp = value;\r\nreturn 0;\r\n}\r\nstatic int find_alternative(u32 event)\r\n{\r\nint i, j;\r\nfor (i = 0; i < ARRAY_SIZE(event_alternatives); ++i) {\r\nif (event < event_alternatives[i][0])\r\nbreak;\r\nfor (j = 0; j < MAX_ALT && event_alternatives[i][j]; ++j)\r\nif (event == event_alternatives[i][j])\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nstatic int mpc7450_get_alternatives(u64 event, unsigned int flags, u64 alt[])\r\n{\r\nint i, j, nalt = 1;\r\nu32 ae;\r\nalt[0] = event;\r\nnalt = 1;\r\ni = find_alternative((u32)event);\r\nif (i >= 0) {\r\nfor (j = 0; j < MAX_ALT; ++j) {\r\nae = event_alternatives[i][j];\r\nif (ae && ae != (u32)event)\r\nalt[nalt++] = ae;\r\n}\r\n}\r\nreturn nalt;\r\n}\r\nstatic int mpc7450_compute_mmcr(u64 event[], int n_ev,\r\nunsigned int hwc[], unsigned long mmcr[])\r\n{\r\nu8 event_index[N_CLASSES][N_COUNTER];\r\nint n_classevent[N_CLASSES];\r\nint i, j, class, tuse;\r\nu32 pmc_inuse = 0, pmc_avail;\r\nu32 mmcr0 = 0, mmcr1 = 0, mmcr2 = 0;\r\nu32 ev, pmc, thresh;\r\nif (n_ev > N_COUNTER)\r\nreturn -1;\r\nfor (i = 0; i < N_CLASSES; ++i)\r\nn_classevent[i] = 0;\r\nfor (i = 0; i < n_ev; ++i) {\r\nclass = mpc7450_classify_event(event[i]);\r\nif (class < 0)\r\nreturn -1;\r\nj = n_classevent[class]++;\r\nevent_index[class][j] = i;\r\n}\r\nfor (class = N_CLASSES - 1; class >= 0; --class) {\r\nfor (i = 0; i < n_classevent[class]; ++i) {\r\nev = event[event_index[class][i]];\r\nif (class == 4) {\r\npmc = (ev >> PM_PMC_SH) & PM_PMC_MSK;\r\nif (pmc_inuse & (1 << (pmc - 1)))\r\nreturn -1;\r\n} else {\r\npmc_avail = classmap[class] & ~pmc_inuse;\r\nif (!pmc_avail)\r\nreturn -1;\r\npmc = ffs(pmc_avail);\r\n}\r\npmc_inuse |= 1 << (pmc - 1);\r\ntuse = mpc7450_threshold_use(ev);\r\nif (tuse) {\r\nthresh = (ev >> PM_THRESH_SH) & PM_THRESH_MSK;\r\nmmcr0 |= thresh << 16;\r\nif (tuse == 2 && (ev & PM_THRMULT_MSKS))\r\nmmcr2 = 0x80000000;\r\n}\r\nev &= pmcsel_mask[pmc - 1];\r\nev <<= pmcsel_shift[pmc - 1];\r\nif (pmc <= 2)\r\nmmcr0 |= ev;\r\nelse\r\nmmcr1 |= ev;\r\nhwc[event_index[class][i]] = pmc - 1;\r\n}\r\n}\r\nif (pmc_inuse & 1)\r\nmmcr0 |= MMCR0_PMC1CE;\r\nif (pmc_inuse & 0x3e)\r\nmmcr0 |= MMCR0_PMCnCE;\r\nmmcr[0] = mmcr0;\r\nmmcr[1] = mmcr1;\r\nmmcr[2] = mmcr2;\r\nreturn 0;\r\n}\r\nstatic void mpc7450_disable_pmc(unsigned int pmc, unsigned long mmcr[])\r\n{\r\nif (pmc <= 1)\r\nmmcr[0] &= ~(pmcsel_mask[pmc] << pmcsel_shift[pmc]);\r\nelse\r\nmmcr[1] &= ~(pmcsel_mask[pmc] << pmcsel_shift[pmc]);\r\n}\r\nstatic int __init init_mpc7450_pmu(void)\r\n{\r\nif (!cur_cpu_spec->oprofile_cpu_type ||\r\nstrcmp(cur_cpu_spec->oprofile_cpu_type, "ppc/7450"))\r\nreturn -ENODEV;\r\nreturn register_power_pmu(&mpc7450_pmu);\r\n}

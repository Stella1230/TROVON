static int __init nand_init(int chipsel, struct davinci_nand_pdata *data)\r\n{\r\nstruct resource res[2];\r\nstruct platform_device *pdev;\r\nu32 range;\r\nint ret;\r\nrange = max(data->mask_cle, data->mask_ale);\r\nrange = PAGE_ALIGN(range + 4) - 1;\r\nif (range >= emif_window_sizes[chipsel])\r\nreturn -EINVAL;\r\npdev = kzalloc(sizeof(*pdev), GFP_KERNEL);\r\nif (!pdev)\r\nreturn -ENOMEM;\r\npdev->name = "davinci_nand";\r\npdev->id = chipsel;\r\npdev->dev.platform_data = data;\r\nmemset(res, 0, sizeof(res));\r\nres[0].start = emif_windows[chipsel];\r\nres[0].end = res[0].start + range;\r\nres[0].flags = IORESOURCE_MEM;\r\nres[1].start = TNETV107X_ASYNC_EMIF_CNTRL_BASE;\r\nres[1].end = res[1].start + SZ_4K - 1;\r\nres[1].flags = IORESOURCE_MEM;\r\nret = platform_device_add_resources(pdev, res, ARRAY_SIZE(res));\r\nif (ret < 0) {\r\nkfree(pdev);\r\nreturn ret;\r\n}\r\nreturn platform_device_register(pdev);\r\n}\r\nvoid __init tnetv107x_devices_init(struct tnetv107x_device_info *info)\r\n{\r\nint i, error;\r\nstruct clk *tsc_clk;\r\ntsc_clk = clk_get(NULL, "sys_tsc_clk");\r\nif (tsc_clk) {\r\nerror = clk_set_rate(tsc_clk, 5000000);\r\nWARN_ON(error < 0);\r\nclk_put(tsc_clk);\r\n}\r\nplatform_device_register(&edma_device);\r\nplatform_device_register(&tnetv107x_wdt_device);\r\nplatform_device_register(&tsc_device);\r\nif (info->serial_config)\r\ndavinci_serial_init(info->serial_config);\r\nfor (i = 0; i < 2; i++)\r\nif (info->mmc_config[i]) {\r\nmmc_devices[i].dev.platform_data = info->mmc_config[i];\r\nplatform_device_register(&mmc_devices[i]);\r\n}\r\nfor (i = 0; i < 4; i++)\r\nif (info->nand_config[i])\r\nnand_init(i, info->nand_config[i]);\r\nif (info->keypad_config) {\r\nkeypad_device.dev.platform_data = info->keypad_config;\r\nplatform_device_register(&keypad_device);\r\n}\r\nif (info->ssp_config) {\r\nssp_device.dev.platform_data = info->ssp_config;\r\nplatform_device_register(&ssp_device);\r\n}\r\n}

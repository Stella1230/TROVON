static u32 bcm63xx_int_cfg_readl(u32 reg)\r\n{\r\nu32 tmp;\r\ntmp = reg & MPI_PCICFGCTL_CFGADDR_MASK;\r\ntmp |= MPI_PCICFGCTL_WRITEEN_MASK;\r\nbcm_mpi_writel(tmp, MPI_PCICFGCTL_REG);\r\niob();\r\nreturn bcm_mpi_readl(MPI_PCICFGDATA_REG);\r\n}\r\nstatic void bcm63xx_int_cfg_writel(u32 val, u32 reg)\r\n{\r\nu32 tmp;\r\ntmp = reg & MPI_PCICFGCTL_CFGADDR_MASK;\r\ntmp |= MPI_PCICFGCTL_WRITEEN_MASK;\r\nbcm_mpi_writel(tmp, MPI_PCICFGCTL_REG);\r\nbcm_mpi_writel(val, MPI_PCICFGDATA_REG);\r\n}\r\nstatic int __init bcm63xx_pci_init(void)\r\n{\r\nunsigned int mem_size;\r\nu32 val;\r\nif (!BCMCPU_IS_6348() && !BCMCPU_IS_6358() && !BCMCPU_IS_6368())\r\nreturn -ENODEV;\r\nif (!bcm63xx_pci_enabled)\r\nreturn -ENODEV;\r\npci_iospace_start = ioremap_nocache(BCM_PCI_IO_BASE_PA, 4);\r\nif (!pci_iospace_start)\r\nreturn -ENOMEM;\r\nval = BCM_PCI_MEM_BASE_PA & MPI_L2P_BASE_MASK;\r\nbcm_mpi_writel(val, MPI_L2PMEMBASE1_REG);\r\nbcm_mpi_writel(~(BCM_PCI_MEM_SIZE - 1), MPI_L2PMEMRANGE1_REG);\r\nbcm_mpi_writel(val | MPI_L2PREMAP_ENABLED_MASK, MPI_L2PMEMREMAP1_REG);\r\nval = bcm_pcmcia_readl(PCMCIA_C1_REG);\r\nval &= ~PCMCIA_C1_CBIDSEL_MASK;\r\nval |= (CARDBUS_PCI_IDSEL << PCMCIA_C1_CBIDSEL_SHIFT);\r\nbcm_pcmcia_writel(val, PCMCIA_C1_REG);\r\n#ifdef CONFIG_CARDBUS\r\nval = BCM_CB_MEM_BASE_PA & MPI_L2P_BASE_MASK;\r\nbcm_mpi_writel(val, MPI_L2PMEMBASE2_REG);\r\nbcm_mpi_writel(~(BCM_CB_MEM_SIZE - 1), MPI_L2PMEMRANGE2_REG);\r\nval |= MPI_L2PREMAP_ENABLED_MASK | MPI_L2PREMAP_IS_CARDBUS_MASK;\r\nbcm_mpi_writel(val, MPI_L2PMEMREMAP2_REG);\r\n#else\r\nbcm_mpi_writel(0, MPI_L2PMEMREMAP2_REG);\r\n#endif\r\nval = BCM_PCI_IO_BASE_PA & MPI_L2P_BASE_MASK;\r\nbcm_mpi_writel(val, MPI_L2PIOBASE_REG);\r\nbcm_mpi_writel(~(BCM_PCI_IO_SIZE - 1), MPI_L2PIORANGE_REG);\r\nbcm_mpi_writel(val | MPI_L2PREMAP_ENABLED_MASK, MPI_L2PIOREMAP_REG);\r\nbcm_mpi_writel(MPI_LOCBUSCTL_EN_PCI_GPIO_MASK, MPI_LOCBUSCTL_REG);\r\nbcm63xx_int_cfg_writel(0, PCI_BASE_ADDRESS_3);\r\nif (BCMCPU_IS_6358() || BCMCPU_IS_6368())\r\nval = MPI_SP0_REMAP_ENABLE_MASK;\r\nelse\r\nval = 0;\r\nbcm_mpi_writel(val, MPI_SP0_REMAP_REG);\r\nbcm63xx_int_cfg_writel(0x0, PCI_BASE_ADDRESS_4);\r\nbcm_mpi_writel(0, MPI_SP1_REMAP_REG);\r\nmem_size = bcm63xx_get_memory_size();\r\nif (BCMCPU_IS_6348() && (bcm63xx_get_cpu_rev() & 0xf0) == 0xa0) {\r\nif (mem_size > (16 * 1024 * 1024))\r\nprintk(KERN_WARNING "bcm63xx: this CPU "\r\n"revision cannot handle more than 16MB "\r\n"of RAM for PCI bus mastering\n");\r\n} else {\r\nbcm_mpi_writel(~(mem_size - 1), MPI_SP0_RANGE_REG);\r\nbcm_mpi_writel(0, MPI_SP1_RANGE_REG);\r\n}\r\nval = bcm63xx_int_cfg_readl(BCMPCI_REG_TIMERS);\r\nval &= ~REG_TIMER_RETRY_MASK;\r\nbcm63xx_int_cfg_writel(val, BCMPCI_REG_TIMERS);\r\nval = bcm63xx_int_cfg_readl(PCI_COMMAND);\r\nval |= (PCI_COMMAND_MEMORY | PCI_COMMAND_MASTER);\r\nbcm63xx_int_cfg_writel(val, PCI_COMMAND);\r\nval = bcm_mpi_readl(MPI_PCIMODESEL_REG);\r\nval &= ~MPI_PCIMODESEL_BAR1_NOSWAP_MASK;\r\nval &= ~MPI_PCIMODESEL_BAR2_NOSWAP_MASK;\r\nval &= ~MPI_PCIMODESEL_PREFETCH_MASK;\r\nval |= (8 << MPI_PCIMODESEL_PREFETCH_SHIFT);\r\nbcm_mpi_writel(val, MPI_PCIMODESEL_REG);\r\nval = bcm_mpi_readl(MPI_LOCINT_REG);\r\nval |= MPI_LOCINT_MASK(MPI_LOCINT_EXT_PCI_INT);\r\nbcm_mpi_writel(val, MPI_LOCINT_REG);\r\nregister_pci_controller(&bcm63xx_controller);\r\n#ifdef CONFIG_CARDBUS\r\nregister_pci_controller(&bcm63xx_cb_controller);\r\n#endif\r\nrequest_mem_region(BCM_PCI_IO_BASE_PA, BCM_PCI_IO_SIZE,\r\n"bcm63xx PCI IO space");\r\nreturn 0;\r\n}

static void set_local_port_range(int range[2])\r\n{\r\nwrite_seqlock(&sysctl_local_ports.lock);\r\nsysctl_local_ports.range[0] = range[0];\r\nsysctl_local_ports.range[1] = range[1];\r\nwrite_sequnlock(&sysctl_local_ports.lock);\r\n}\r\nstatic int ipv4_local_port_range(ctl_table *table, int write,\r\nvoid __user *buffer,\r\nsize_t *lenp, loff_t *ppos)\r\n{\r\nint ret;\r\nint range[2];\r\nctl_table tmp = {\r\n.data = &range,\r\n.maxlen = sizeof(range),\r\n.mode = table->mode,\r\n.extra1 = &ip_local_port_range_min,\r\n.extra2 = &ip_local_port_range_max,\r\n};\r\ninet_get_local_port_range(range, range + 1);\r\nret = proc_dointvec_minmax(&tmp, write, buffer, lenp, ppos);\r\nif (write && ret == 0) {\r\nif (range[1] < range[0])\r\nret = -EINVAL;\r\nelse\r\nset_local_port_range(range);\r\n}\r\nreturn ret;\r\n}\r\nstatic void inet_get_ping_group_range_table(struct ctl_table *table, gid_t *low, gid_t *high)\r\n{\r\ngid_t *data = table->data;\r\nunsigned seq;\r\ndo {\r\nseq = read_seqbegin(&sysctl_local_ports.lock);\r\n*low = data[0];\r\n*high = data[1];\r\n} while (read_seqretry(&sysctl_local_ports.lock, seq));\r\n}\r\nstatic void set_ping_group_range(struct ctl_table *table, gid_t range[2])\r\n{\r\ngid_t *data = table->data;\r\nwrite_seqlock(&sysctl_local_ports.lock);\r\ndata[0] = range[0];\r\ndata[1] = range[1];\r\nwrite_sequnlock(&sysctl_local_ports.lock);\r\n}\r\nstatic int ipv4_ping_group_range(ctl_table *table, int write,\r\nvoid __user *buffer,\r\nsize_t *lenp, loff_t *ppos)\r\n{\r\nint ret;\r\ngid_t range[2];\r\nctl_table tmp = {\r\n.data = &range,\r\n.maxlen = sizeof(range),\r\n.mode = table->mode,\r\n.extra1 = &ip_ping_group_range_min,\r\n.extra2 = &ip_ping_group_range_max,\r\n};\r\ninet_get_ping_group_range_table(table, range, range + 1);\r\nret = proc_dointvec_minmax(&tmp, write, buffer, lenp, ppos);\r\nif (write && ret == 0)\r\nset_ping_group_range(table, range);\r\nreturn ret;\r\n}\r\nstatic int proc_tcp_congestion_control(ctl_table *ctl, int write,\r\nvoid __user *buffer, size_t *lenp, loff_t *ppos)\r\n{\r\nchar val[TCP_CA_NAME_MAX];\r\nctl_table tbl = {\r\n.data = val,\r\n.maxlen = TCP_CA_NAME_MAX,\r\n};\r\nint ret;\r\ntcp_get_default_congestion_control(val);\r\nret = proc_dostring(&tbl, write, buffer, lenp, ppos);\r\nif (write && ret == 0)\r\nret = tcp_set_default_congestion_control(val);\r\nreturn ret;\r\n}\r\nstatic int proc_tcp_available_congestion_control(ctl_table *ctl,\r\nint write,\r\nvoid __user *buffer, size_t *lenp,\r\nloff_t *ppos)\r\n{\r\nctl_table tbl = { .maxlen = TCP_CA_BUF_MAX, };\r\nint ret;\r\ntbl.data = kmalloc(tbl.maxlen, GFP_USER);\r\nif (!tbl.data)\r\nreturn -ENOMEM;\r\ntcp_get_available_congestion_control(tbl.data, TCP_CA_BUF_MAX);\r\nret = proc_dostring(&tbl, write, buffer, lenp, ppos);\r\nkfree(tbl.data);\r\nreturn ret;\r\n}\r\nstatic int proc_allowed_congestion_control(ctl_table *ctl,\r\nint write,\r\nvoid __user *buffer, size_t *lenp,\r\nloff_t *ppos)\r\n{\r\nctl_table tbl = { .maxlen = TCP_CA_BUF_MAX };\r\nint ret;\r\ntbl.data = kmalloc(tbl.maxlen, GFP_USER);\r\nif (!tbl.data)\r\nreturn -ENOMEM;\r\ntcp_get_allowed_congestion_control(tbl.data, tbl.maxlen);\r\nret = proc_dostring(&tbl, write, buffer, lenp, ppos);\r\nif (write && ret == 0)\r\nret = tcp_set_allowed_congestion_control(tbl.data);\r\nkfree(tbl.data);\r\nreturn ret;\r\n}\r\nstatic int ipv4_tcp_mem(ctl_table *ctl, int write,\r\nvoid __user *buffer, size_t *lenp,\r\nloff_t *ppos)\r\n{\r\nint ret;\r\nunsigned long vec[3];\r\nstruct net *net = current->nsproxy->net_ns;\r\n#ifdef CONFIG_CGROUP_MEM_RES_CTLR_KMEM\r\nstruct mem_cgroup *memcg;\r\n#endif\r\nctl_table tmp = {\r\n.data = &vec,\r\n.maxlen = sizeof(vec),\r\n.mode = ctl->mode,\r\n};\r\nif (!write) {\r\nctl->data = &net->ipv4.sysctl_tcp_mem;\r\nreturn proc_doulongvec_minmax(ctl, write, buffer, lenp, ppos);\r\n}\r\nret = proc_doulongvec_minmax(&tmp, write, buffer, lenp, ppos);\r\nif (ret)\r\nreturn ret;\r\n#ifdef CONFIG_CGROUP_MEM_RES_CTLR_KMEM\r\nrcu_read_lock();\r\nmemcg = mem_cgroup_from_task(current);\r\ntcp_prot_mem(memcg, vec[0], 0);\r\ntcp_prot_mem(memcg, vec[1], 1);\r\ntcp_prot_mem(memcg, vec[2], 2);\r\nrcu_read_unlock();\r\n#endif\r\nnet->ipv4.sysctl_tcp_mem[0] = vec[0];\r\nnet->ipv4.sysctl_tcp_mem[1] = vec[1];\r\nnet->ipv4.sysctl_tcp_mem[2] = vec[2];\r\nreturn 0;\r\n}\r\nstatic __net_init int ipv4_sysctl_init_net(struct net *net)\r\n{\r\nstruct ctl_table *table;\r\ntable = ipv4_net_table;\r\nif (!net_eq(net, &init_net)) {\r\ntable = kmemdup(table, sizeof(ipv4_net_table), GFP_KERNEL);\r\nif (table == NULL)\r\ngoto err_alloc;\r\ntable[0].data =\r\n&net->ipv4.sysctl_icmp_echo_ignore_all;\r\ntable[1].data =\r\n&net->ipv4.sysctl_icmp_echo_ignore_broadcasts;\r\ntable[2].data =\r\n&net->ipv4.sysctl_icmp_ignore_bogus_error_responses;\r\ntable[3].data =\r\n&net->ipv4.sysctl_icmp_errors_use_inbound_ifaddr;\r\ntable[4].data =\r\n&net->ipv4.sysctl_icmp_ratelimit;\r\ntable[5].data =\r\n&net->ipv4.sysctl_icmp_ratemask;\r\ntable[6].data =\r\n&net->ipv4.sysctl_rt_cache_rebuild_count;\r\ntable[7].data =\r\n&net->ipv4.sysctl_ping_group_range;\r\n}\r\nnet->ipv4.sysctl_ping_group_range[0] = 1;\r\nnet->ipv4.sysctl_ping_group_range[1] = 0;\r\nnet->ipv4.sysctl_rt_cache_rebuild_count = 4;\r\ntcp_init_mem(net);\r\nnet->ipv4.ipv4_hdr = register_net_sysctl_table(net,\r\nnet_ipv4_ctl_path, table);\r\nif (net->ipv4.ipv4_hdr == NULL)\r\ngoto err_reg;\r\nreturn 0;\r\nerr_reg:\r\nif (!net_eq(net, &init_net))\r\nkfree(table);\r\nerr_alloc:\r\nreturn -ENOMEM;\r\n}\r\nstatic __net_exit void ipv4_sysctl_exit_net(struct net *net)\r\n{\r\nstruct ctl_table *table;\r\ntable = net->ipv4.ipv4_hdr->ctl_table_arg;\r\nunregister_net_sysctl_table(net->ipv4.ipv4_hdr);\r\nkfree(table);\r\n}\r\nstatic __init int sysctl_ipv4_init(void)\r\n{\r\nstruct ctl_table_header *hdr;\r\nstruct ctl_table *i;\r\nfor (i = ipv4_table; i->procname; i++) {\r\nif (strcmp(i->procname, "ip_local_reserved_ports") == 0) {\r\ni->data = sysctl_local_reserved_ports;\r\nbreak;\r\n}\r\n}\r\nif (!i->procname)\r\nreturn -EINVAL;\r\nhdr = register_sysctl_paths(net_ipv4_ctl_path, ipv4_table);\r\nif (hdr == NULL)\r\nreturn -ENOMEM;\r\nif (register_pernet_subsys(&ipv4_sysctl_ops)) {\r\nunregister_sysctl_table(hdr);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

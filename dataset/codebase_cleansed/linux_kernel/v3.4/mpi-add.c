int mpi_add_ui(MPI w, const MPI u, unsigned long v)\r\n{\r\nmpi_ptr_t wp, up;\r\nmpi_size_t usize, wsize;\r\nint usign, wsign;\r\nusize = u->nlimbs;\r\nusign = u->sign;\r\nwsign = 0;\r\nwsize = usize + 1;\r\nif (w->alloced < wsize)\r\nif (mpi_resize(w, wsize) < 0)\r\nreturn -ENOMEM;\r\nup = u->d;\r\nwp = w->d;\r\nif (!usize) {\r\nwp[0] = v;\r\nwsize = v ? 1 : 0;\r\n} else if (!usign) {\r\nmpi_limb_t cy;\r\ncy = mpihelp_add_1(wp, up, usize, v);\r\nwp[usize] = cy;\r\nwsize = usize + cy;\r\n} else {\r\nif (usize == 1 && up[0] < v) {\r\nwp[0] = v - up[0];\r\nwsize = 1;\r\n} else {\r\nmpihelp_sub_1(wp, up, usize, v);\r\nwsize = usize - (wp[usize - 1] == 0);\r\nwsign = 1;\r\n}\r\n}\r\nw->nlimbs = wsize;\r\nw->sign = wsign;\r\nreturn 0;\r\n}\r\nint mpi_add(MPI w, MPI u, MPI v)\r\n{\r\nmpi_ptr_t wp, up, vp;\r\nmpi_size_t usize, vsize, wsize;\r\nint usign, vsign, wsign;\r\nif (u->nlimbs < v->nlimbs) {\r\nusize = v->nlimbs;\r\nusign = v->sign;\r\nvsize = u->nlimbs;\r\nvsign = u->sign;\r\nwsize = usize + 1;\r\nif (RESIZE_IF_NEEDED(w, wsize) < 0)\r\nreturn -ENOMEM;\r\nup = v->d;\r\nvp = u->d;\r\n} else {\r\nusize = u->nlimbs;\r\nusign = u->sign;\r\nvsize = v->nlimbs;\r\nvsign = v->sign;\r\nwsize = usize + 1;\r\nif (RESIZE_IF_NEEDED(w, wsize) < 0)\r\nreturn -ENOMEM;\r\nup = u->d;\r\nvp = v->d;\r\n}\r\nwp = w->d;\r\nwsign = 0;\r\nif (!vsize) {\r\nMPN_COPY(wp, up, usize);\r\nwsize = usize;\r\nwsign = usign;\r\n} else if (usign != vsign) {\r\nif (usize != vsize) {\r\nmpihelp_sub(wp, up, usize, vp, vsize);\r\nwsize = usize;\r\nMPN_NORMALIZE(wp, wsize);\r\nwsign = usign;\r\n} else if (mpihelp_cmp(up, vp, usize) < 0) {\r\nmpihelp_sub_n(wp, vp, up, usize);\r\nwsize = usize;\r\nMPN_NORMALIZE(wp, wsize);\r\nif (!usign)\r\nwsign = 1;\r\n} else {\r\nmpihelp_sub_n(wp, up, vp, usize);\r\nwsize = usize;\r\nMPN_NORMALIZE(wp, wsize);\r\nif (usign)\r\nwsign = 1;\r\n}\r\n} else {\r\nmpi_limb_t cy = mpihelp_add(wp, up, usize, vp, vsize);\r\nwp[usize] = cy;\r\nwsize = usize + cy;\r\nif (usign)\r\nwsign = 1;\r\n}\r\nw->nlimbs = wsize;\r\nw->sign = wsign;\r\nreturn 0;\r\n}\r\nint mpi_sub_ui(MPI w, MPI u, unsigned long v)\r\n{\r\nmpi_ptr_t wp, up;\r\nmpi_size_t usize, wsize;\r\nint usign, wsign;\r\nusize = u->nlimbs;\r\nusign = u->sign;\r\nwsign = 0;\r\nwsize = usize + 1;\r\nif (w->alloced < wsize)\r\nif (mpi_resize(w, wsize) < 0)\r\nreturn -ENOMEM;\r\nup = u->d;\r\nwp = w->d;\r\nif (!usize) {\r\nwp[0] = v;\r\nwsize = v ? 1 : 0;\r\nwsign = 1;\r\n} else if (usign) {\r\nmpi_limb_t cy;\r\ncy = mpihelp_add_1(wp, up, usize, v);\r\nwp[usize] = cy;\r\nwsize = usize + cy;\r\n} else {\r\nif (usize == 1 && up[0] < v) {\r\nwp[0] = v - up[0];\r\nwsize = 1;\r\nwsign = 1;\r\n} else {\r\nmpihelp_sub_1(wp, up, usize, v);\r\nwsize = usize - (wp[usize - 1] == 0);\r\n}\r\n}\r\nw->nlimbs = wsize;\r\nw->sign = wsign;\r\nreturn 0;\r\n}\r\nint mpi_sub(MPI w, MPI u, MPI v)\r\n{\r\nint rc;\r\nif (w == v) {\r\nMPI vv;\r\nif (mpi_copy(&vv, v) < 0)\r\nreturn -ENOMEM;\r\nvv->sign = !vv->sign;\r\nrc = mpi_add(w, u, vv);\r\nmpi_free(vv);\r\n} else {\r\nv->sign = !v->sign;\r\nrc = mpi_add(w, u, v);\r\nv->sign = !v->sign;\r\n}\r\nreturn rc;\r\n}\r\nint mpi_addm(MPI w, MPI u, MPI v, MPI m)\r\n{\r\nif (mpi_add(w, u, v) < 0 || mpi_fdiv_r(w, w, m) < 0)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nint mpi_subm(MPI w, MPI u, MPI v, MPI m)\r\n{\r\nif (mpi_sub(w, u, v) < 0 || mpi_fdiv_r(w, w, m) < 0)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}

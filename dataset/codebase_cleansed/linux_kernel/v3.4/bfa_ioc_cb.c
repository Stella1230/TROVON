void\r\nbfa_ioc_set_cb_hwif(struct bfa_ioc_s *ioc)\r\n{\r\nhwif_cb.ioc_pll_init = bfa_ioc_cb_pll_init;\r\nhwif_cb.ioc_firmware_lock = bfa_ioc_cb_firmware_lock;\r\nhwif_cb.ioc_firmware_unlock = bfa_ioc_cb_firmware_unlock;\r\nhwif_cb.ioc_reg_init = bfa_ioc_cb_reg_init;\r\nhwif_cb.ioc_map_port = bfa_ioc_cb_map_port;\r\nhwif_cb.ioc_isr_mode_set = bfa_ioc_cb_isr_mode_set;\r\nhwif_cb.ioc_notify_fail = bfa_ioc_cb_notify_fail;\r\nhwif_cb.ioc_ownership_reset = bfa_ioc_cb_ownership_reset;\r\nhwif_cb.ioc_sync_start = bfa_ioc_cb_sync_start;\r\nhwif_cb.ioc_sync_join = bfa_ioc_cb_sync_join;\r\nhwif_cb.ioc_sync_leave = bfa_ioc_cb_sync_leave;\r\nhwif_cb.ioc_sync_ack = bfa_ioc_cb_sync_ack;\r\nhwif_cb.ioc_sync_complete = bfa_ioc_cb_sync_complete;\r\nioc->ioc_hwif = &hwif_cb;\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioc_cb_firmware_lock(struct bfa_ioc_s *ioc)\r\n{\r\nreturn BFA_TRUE;\r\n}\r\nstatic void\r\nbfa_ioc_cb_firmware_unlock(struct bfa_ioc_s *ioc)\r\n{\r\n}\r\nstatic void\r\nbfa_ioc_cb_notify_fail(struct bfa_ioc_s *ioc)\r\n{\r\nwritel(~0U, ioc->ioc_regs.err_set);\r\nreadl(ioc->ioc_regs.err_set);\r\n}\r\nstatic void\r\nbfa_ioc_cb_reg_init(struct bfa_ioc_s *ioc)\r\n{\r\nvoid __iomem *rb;\r\nint pcifn = bfa_ioc_pcifn(ioc);\r\nrb = bfa_ioc_bar0(ioc);\r\nioc->ioc_regs.hfn_mbox = rb + iocreg_fnreg[pcifn].hfn_mbox;\r\nioc->ioc_regs.lpu_mbox = rb + iocreg_fnreg[pcifn].lpu_mbox;\r\nioc->ioc_regs.host_page_num_fn = rb + iocreg_fnreg[pcifn].hfn_pgn;\r\nif (ioc->port_id == 0) {\r\nioc->ioc_regs.heartbeat = rb + BFA_IOC0_HBEAT_REG;\r\nioc->ioc_regs.ioc_fwstate = rb + BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.alt_ioc_fwstate = rb + BFA_IOC1_STATE_REG;\r\n} else {\r\nioc->ioc_regs.heartbeat = (rb + BFA_IOC1_HBEAT_REG);\r\nioc->ioc_regs.ioc_fwstate = (rb + BFA_IOC1_STATE_REG);\r\nioc->ioc_regs.alt_ioc_fwstate = (rb + BFA_IOC0_STATE_REG);\r\n}\r\nioc->ioc_regs.hfn_mbox_cmd = rb + iocreg_mbcmd[pcifn].hfn;\r\nioc->ioc_regs.lpu_mbox_cmd = rb + iocreg_mbcmd[pcifn].lpu;\r\nioc->ioc_regs.pss_ctl_reg = (rb + PSS_CTL_REG);\r\nioc->ioc_regs.pss_err_status_reg = (rb + PSS_ERR_STATUS_REG);\r\nioc->ioc_regs.app_pll_fast_ctl_reg = (rb + APP_PLL_LCLK_CTL_REG);\r\nioc->ioc_regs.app_pll_slow_ctl_reg = (rb + APP_PLL_SCLK_CTL_REG);\r\nioc->ioc_regs.ioc_sem_reg = (rb + HOST_SEM0_REG);\r\nioc->ioc_regs.ioc_init_sem_reg = (rb + HOST_SEM2_REG);\r\nioc->ioc_regs.smem_page_start = (rb + PSS_SMEM_PAGE_START);\r\nioc->ioc_regs.smem_pg0 = BFI_IOC_SMEM_PG0_CB;\r\nioc->ioc_regs.err_set = (rb + ERR_SET_REG);\r\n}\r\nstatic void\r\nbfa_ioc_cb_map_port(struct bfa_ioc_s *ioc)\r\n{\r\nioc->port_id = bfa_ioc_pcifn(ioc);\r\nbfa_trc(ioc, ioc->port_id);\r\n}\r\nstatic void\r\nbfa_ioc_cb_isr_mode_set(struct bfa_ioc_s *ioc, bfa_boolean_t msix)\r\n{\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioc_cb_sync_start(struct bfa_ioc_s *ioc)\r\n{\r\nreturn bfa_ioc_cb_sync_complete(ioc);\r\n}\r\nstatic void\r\nbfa_ioc_cb_ownership_reset(struct bfa_ioc_s *ioc)\r\n{\r\nreadl(ioc->ioc_regs.ioc_sem_reg);\r\nwritel(1, ioc->ioc_regs.ioc_sem_reg);\r\n}\r\nstatic void\r\nbfa_ioc_cb_sync_join(struct bfa_ioc_s *ioc)\r\n{\r\n}\r\nstatic void\r\nbfa_ioc_cb_sync_leave(struct bfa_ioc_s *ioc)\r\n{\r\n}\r\nstatic void\r\nbfa_ioc_cb_sync_ack(struct bfa_ioc_s *ioc)\r\n{\r\nwritel(BFI_IOC_FAIL, ioc->ioc_regs.ioc_fwstate);\r\n}\r\nstatic bfa_boolean_t\r\nbfa_ioc_cb_sync_complete(struct bfa_ioc_s *ioc)\r\n{\r\nuint32_t fwstate, alt_fwstate;\r\nfwstate = readl(ioc->ioc_regs.ioc_fwstate);\r\nif (fwstate == BFI_IOC_UNINIT ||\r\nfwstate == BFI_IOC_INITING ||\r\nfwstate == BFI_IOC_DISABLED ||\r\nfwstate == BFI_IOC_MEMTEST ||\r\nfwstate == BFI_IOC_OP)\r\nreturn BFA_TRUE;\r\nelse {\r\nalt_fwstate = readl(ioc->ioc_regs.alt_ioc_fwstate);\r\nif (alt_fwstate == BFI_IOC_FAIL ||\r\nalt_fwstate == BFI_IOC_DISABLED ||\r\nalt_fwstate == BFI_IOC_UNINIT ||\r\nalt_fwstate == BFI_IOC_INITING ||\r\nalt_fwstate == BFI_IOC_MEMTEST)\r\nreturn BFA_TRUE;\r\nelse\r\nreturn BFA_FALSE;\r\n}\r\n}\r\nbfa_status_t\r\nbfa_ioc_cb_pll_init(void __iomem *rb, enum bfi_asic_mode fcmode)\r\n{\r\nu32 pll_sclk, pll_fclk;\r\npll_sclk = __APP_PLL_SCLK_ENABLE | __APP_PLL_SCLK_LRESETN |\r\n__APP_PLL_SCLK_P0_1(3U) |\r\n__APP_PLL_SCLK_JITLMT0_1(3U) |\r\n__APP_PLL_SCLK_CNTLMT0_1(3U);\r\npll_fclk = __APP_PLL_LCLK_ENABLE | __APP_PLL_LCLK_LRESETN |\r\n__APP_PLL_LCLK_RSEL200500 | __APP_PLL_LCLK_P0_1(3U) |\r\n__APP_PLL_LCLK_JITLMT0_1(3U) |\r\n__APP_PLL_LCLK_CNTLMT0_1(3U);\r\nwritel(BFI_IOC_UNINIT, (rb + BFA_IOC0_STATE_REG));\r\nwritel(BFI_IOC_UNINIT, (rb + BFA_IOC1_STATE_REG));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_MSK));\r\nwritel(__APP_PLL_SCLK_LOGIC_SOFT_RESET, rb + APP_PLL_SCLK_CTL_REG);\r\nwritel(__APP_PLL_SCLK_BYPASS | __APP_PLL_SCLK_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_SCLK_CTL_REG);\r\nwritel(__APP_PLL_LCLK_LOGIC_SOFT_RESET, rb + APP_PLL_LCLK_CTL_REG);\r\nwritel(__APP_PLL_LCLK_BYPASS | __APP_PLL_LCLK_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_LCLK_CTL_REG);\r\nudelay(2);\r\nwritel(__APP_PLL_SCLK_LOGIC_SOFT_RESET, rb + APP_PLL_SCLK_CTL_REG);\r\nwritel(__APP_PLL_LCLK_LOGIC_SOFT_RESET, rb + APP_PLL_LCLK_CTL_REG);\r\nwritel(pll_sclk | __APP_PLL_SCLK_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_SCLK_CTL_REG);\r\nwritel(pll_fclk | __APP_PLL_LCLK_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_LCLK_CTL_REG);\r\nudelay(2000);\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_STATUS));\r\nwritel(pll_sclk, (rb + APP_PLL_SCLK_CTL_REG));\r\nwritel(pll_fclk, (rb + APP_PLL_LCLK_CTL_REG));\r\nreturn BFA_STATUS_OK;\r\n}

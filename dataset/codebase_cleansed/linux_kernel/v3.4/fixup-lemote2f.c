int __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint virq;\r\nif ((PCI_SLOT(dev->devfn) != PCI_IDSEL_CS5536)\r\n&& (PCI_SLOT(dev->devfn) < 32)) {\r\nvirq = irq_tab[slot][pin];\r\nprintk(KERN_INFO "slot: %d, pin: %d, irq: %d\n", slot, pin,\r\nvirq + LOONGSON_IRQ_BASE);\r\nif (virq != 0)\r\nreturn LOONGSON_IRQ_BASE + virq;\r\nelse\r\nreturn 0;\r\n} else if (PCI_SLOT(dev->devfn) == PCI_IDSEL_CS5536) {\r\nswitch (PCI_FUNC(dev->devfn)) {\r\ncase 2:\r\npci_write_config_byte(dev, PCI_INTERRUPT_LINE,\r\nCS5536_IDE_INTR);\r\nreturn CS5536_IDE_INTR;\r\ncase 3:\r\npci_write_config_byte(dev, PCI_INTERRUPT_LINE,\r\nCS5536_ACC_INTR);\r\nreturn CS5536_ACC_INTR;\r\ncase 4:\r\ncase 5:\r\ncase 6:\r\ncase 7:\r\npci_write_config_byte(dev, PCI_INTERRUPT_LINE,\r\nCS5536_USB_INTR);\r\nreturn CS5536_USB_INTR;\r\n}\r\nreturn dev->irq;\r\n} else {\r\nprintk(KERN_INFO " strange pci slot number.\n");\r\nreturn 0;\r\n}\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __init loongson_cs5536_isa_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_dword(pdev, PCI_UART1_INT_REG, 1);\r\npci_write_config_dword(pdev, PCI_UART2_INT_REG, 1);\r\n}\r\nstatic void __init loongson_cs5536_ide_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_dword(pdev, PCI_IDE_CFG_REG,\r\nCS5536_IDE_FLASH_SIGNATURE);\r\n}\r\nstatic void __init loongson_cs5536_acc_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_dword(pdev, PCI_ACC_INT_REG, 1);\r\npci_write_config_byte(pdev, PCI_LATENCY_TIMER, 0xc0);\r\n}\r\nstatic void __init loongson_cs5536_ohci_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_dword(pdev, PCI_OHCI_INT_REG, 1);\r\n}\r\nstatic void __init loongson_cs5536_ehci_fixup(struct pci_dev *pdev)\r\n{\r\nu32 hi, lo;\r\n_rdmsr(USB_MSR_REG(USB_CONFIG), &hi, &lo);\r\n_wrmsr(USB_MSR_REG(USB_CONFIG), (1 << 1) | (1 << 3), lo);\r\npci_write_config_dword(pdev, PCI_EHCI_FLADJ_REG, 0x2000);\r\n}\r\nstatic void __init loongson_nec_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned int val;\r\npci_read_config_dword(pdev, 0xe0, &val);\r\npci_write_config_dword(pdev, 0xe0, (val & ~3) | 0x2);\r\n}

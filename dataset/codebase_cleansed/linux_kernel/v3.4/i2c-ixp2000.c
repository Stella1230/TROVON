static inline int ixp2000_scl_pin(void *data)\r\n{\r\nreturn ((struct ixp2000_i2c_pins*)data)->scl_pin;\r\n}\r\nstatic inline int ixp2000_sda_pin(void *data)\r\n{\r\nreturn ((struct ixp2000_i2c_pins*)data)->sda_pin;\r\n}\r\nstatic void ixp2000_bit_setscl(void *data, int val)\r\n{\r\nint i = 5000;\r\nif (val) {\r\ngpio_line_config(ixp2000_scl_pin(data), GPIO_IN);\r\nwhile(!gpio_line_get(ixp2000_scl_pin(data)) && i--);\r\n} else {\r\ngpio_line_config(ixp2000_scl_pin(data), GPIO_OUT);\r\n}\r\n}\r\nstatic void ixp2000_bit_setsda(void *data, int val)\r\n{\r\nif (val) {\r\ngpio_line_config(ixp2000_sda_pin(data), GPIO_IN);\r\n} else {\r\ngpio_line_config(ixp2000_sda_pin(data), GPIO_OUT);\r\n}\r\n}\r\nstatic int ixp2000_bit_getscl(void *data)\r\n{\r\nreturn gpio_line_get(ixp2000_scl_pin(data));\r\n}\r\nstatic int ixp2000_bit_getsda(void *data)\r\n{\r\nreturn gpio_line_get(ixp2000_sda_pin(data));\r\n}\r\nstatic int ixp2000_i2c_remove(struct platform_device *plat_dev)\r\n{\r\nstruct ixp2000_i2c_data *drv_data = platform_get_drvdata(plat_dev);\r\nplatform_set_drvdata(plat_dev, NULL);\r\ni2c_del_adapter(&drv_data->adapter);\r\nkfree(drv_data);\r\nreturn 0;\r\n}\r\nstatic int ixp2000_i2c_probe(struct platform_device *plat_dev)\r\n{\r\nint err;\r\nstruct ixp2000_i2c_pins *gpio = plat_dev->dev.platform_data;\r\nstruct ixp2000_i2c_data *drv_data =\r\nkzalloc(sizeof(struct ixp2000_i2c_data), GFP_KERNEL);\r\nif (!drv_data)\r\nreturn -ENOMEM;\r\ndrv_data->gpio_pins = gpio;\r\ndrv_data->algo_data.data = gpio;\r\ndrv_data->algo_data.setsda = ixp2000_bit_setsda;\r\ndrv_data->algo_data.setscl = ixp2000_bit_setscl;\r\ndrv_data->algo_data.getsda = ixp2000_bit_getsda;\r\ndrv_data->algo_data.getscl = ixp2000_bit_getscl;\r\ndrv_data->algo_data.udelay = 6;\r\ndrv_data->algo_data.timeout = HZ;\r\nstrlcpy(drv_data->adapter.name, plat_dev->dev.driver->name,\r\nsizeof(drv_data->adapter.name));\r\ndrv_data->adapter.algo_data = &drv_data->algo_data,\r\ndrv_data->adapter.dev.parent = &plat_dev->dev;\r\ngpio_line_config(gpio->sda_pin, GPIO_IN);\r\ngpio_line_config(gpio->scl_pin, GPIO_IN);\r\ngpio_line_set(gpio->scl_pin, 0);\r\ngpio_line_set(gpio->sda_pin, 0);\r\nif ((err = i2c_bit_add_bus(&drv_data->adapter)) != 0) {\r\ndev_err(&plat_dev->dev, "Could not install, error %d\n", err);\r\nkfree(drv_data);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(plat_dev, drv_data);\r\nreturn 0;\r\n}

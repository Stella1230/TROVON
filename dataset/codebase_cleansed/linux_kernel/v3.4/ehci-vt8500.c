static int ehci_update_device(struct usb_hcd *hcd, struct usb_device *udev)\r\n{\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nint rc = 0;\r\nif (!udev->parent)\r\nrc = -1;\r\nif (ehci->has_lpm && !udev->parent->parent) {\r\nrc = ehci_lpm_set_da(ehci, udev->devnum, udev->portnum);\r\nif (!rc)\r\nrc = ehci_lpm_check(ehci, udev->portnum);\r\n}\r\nreturn rc;\r\n}\r\nstatic int vt8500_ehci_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nstruct resource *res;\r\nint ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (pdev->resource[1].flags != IORESOURCE_IRQ) {\r\npr_debug("resource[1] is not IORESOURCE_IRQ");\r\nreturn -ENOMEM;\r\n}\r\nhcd = usb_create_hcd(&vt8500_ehci_hc_driver, &pdev->dev, "VT8500");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name)) {\r\npr_debug("request_mem_region failed");\r\nret = -EBUSY;\r\ngoto err1;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\npr_debug("ioremap failed");\r\nret = -ENOMEM;\r\ngoto err2;\r\n}\r\nehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\nehci->regs = hcd->regs +\r\nHC_LENGTH(ehci, readl(&ehci->caps->hc_capbase));\r\ndbg_hcs_params(ehci, "reset");\r\ndbg_hcc_params(ehci, "reset");\r\nehci->hcs_params = readl(&ehci->caps->hcs_params);\r\nehci_port_power(ehci, 1);\r\nehci_reset(ehci);\r\nret = usb_add_hcd(hcd, pdev->resource[1].start,\r\nIRQF_SHARED);\r\nif (ret == 0) {\r\nplatform_set_drvdata(pdev, hcd);\r\nreturn ret;\r\n}\r\niounmap(hcd->regs);\r\nerr2:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr1:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int vt8500_ehci_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

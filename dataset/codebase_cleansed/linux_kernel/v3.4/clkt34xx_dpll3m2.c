int omap3_core_dpll_m2_set_rate(struct clk *clk, unsigned long rate)\r\n{\r\nu32 new_div = 0;\r\nu32 unlock_dll = 0;\r\nu32 c;\r\nunsigned long validrate, sdrcrate, _mpurate;\r\nstruct omap_sdrc_params *sdrc_cs0;\r\nstruct omap_sdrc_params *sdrc_cs1;\r\nint ret;\r\nif (!clk || !rate)\r\nreturn -EINVAL;\r\nvalidrate = omap2_clksel_round_rate_div(clk, rate, &new_div);\r\nif (validrate != rate)\r\nreturn -EINVAL;\r\nsdrcrate = sdrc_ick_p->rate;\r\nif (rate > clk->rate)\r\nsdrcrate <<= ((rate / clk->rate) >> 1);\r\nelse\r\nsdrcrate >>= ((clk->rate / rate) >> 1);\r\nret = omap2_sdrc_get_params(sdrcrate, &sdrc_cs0, &sdrc_cs1);\r\nif (ret)\r\nreturn -EINVAL;\r\nif (sdrcrate < MIN_SDRC_DLL_LOCK_FREQ) {\r\npr_debug("clock: will unlock SDRC DLL\n");\r\nunlock_dll = 1;\r\n}\r\n_mpurate = arm_fck_p->rate / CYCLES_PER_MHZ;\r\nc = (_mpurate << SDRC_MPURATE_SCALE) >> SDRC_MPURATE_BASE_SHIFT;\r\nc += 1;\r\nc *= SDRC_MPURATE_LOOPS;\r\nc >>= SDRC_MPURATE_SCALE;\r\nif (c == 0)\r\nc = 1;\r\npr_debug("clock: changing CORE DPLL rate from %lu to %lu\n", clk->rate,\r\nvalidrate);\r\npr_debug("clock: SDRC CS0 timing params used:"\r\n" RFR %08x CTRLA %08x CTRLB %08x MR %08x\n",\r\nsdrc_cs0->rfr_ctrl, sdrc_cs0->actim_ctrla,\r\nsdrc_cs0->actim_ctrlb, sdrc_cs0->mr);\r\nif (sdrc_cs1)\r\npr_debug("clock: SDRC CS1 timing params used: "\r\n" RFR %08x CTRLA %08x CTRLB %08x MR %08x\n",\r\nsdrc_cs1->rfr_ctrl, sdrc_cs1->actim_ctrla,\r\nsdrc_cs1->actim_ctrlb, sdrc_cs1->mr);\r\nif (sdrc_cs1)\r\nomap3_configure_core_dpll(\r\nnew_div, unlock_dll, c, rate > clk->rate,\r\nsdrc_cs0->rfr_ctrl, sdrc_cs0->actim_ctrla,\r\nsdrc_cs0->actim_ctrlb, sdrc_cs0->mr,\r\nsdrc_cs1->rfr_ctrl, sdrc_cs1->actim_ctrla,\r\nsdrc_cs1->actim_ctrlb, sdrc_cs1->mr);\r\nelse\r\nomap3_configure_core_dpll(\r\nnew_div, unlock_dll, c, rate > clk->rate,\r\nsdrc_cs0->rfr_ctrl, sdrc_cs0->actim_ctrla,\r\nsdrc_cs0->actim_ctrlb, sdrc_cs0->mr,\r\n0, 0, 0, 0);\r\nclk->rate = rate;\r\nreturn 0;\r\n}

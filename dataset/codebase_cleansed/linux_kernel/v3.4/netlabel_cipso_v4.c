static int netlbl_cipsov4_add_common(struct genl_info *info,\r\nstruct cipso_v4_doi *doi_def)\r\n{\r\nstruct nlattr *nla;\r\nint nla_rem;\r\nu32 iter = 0;\r\ndoi_def->doi = nla_get_u32(info->attrs[NLBL_CIPSOV4_A_DOI]);\r\nif (nla_validate_nested(info->attrs[NLBL_CIPSOV4_A_TAGLST],\r\nNLBL_CIPSOV4_A_MAX,\r\nnetlbl_cipsov4_genl_policy) != 0)\r\nreturn -EINVAL;\r\nnla_for_each_nested(nla, info->attrs[NLBL_CIPSOV4_A_TAGLST], nla_rem)\r\nif (nla_type(nla) == NLBL_CIPSOV4_A_TAG) {\r\nif (iter >= CIPSO_V4_TAG_MAXCNT)\r\nreturn -EINVAL;\r\ndoi_def->tags[iter++] = nla_get_u8(nla);\r\n}\r\nwhile (iter < CIPSO_V4_TAG_MAXCNT)\r\ndoi_def->tags[iter++] = CIPSO_V4_TAG_INVALID;\r\nreturn 0;\r\n}\r\nstatic int netlbl_cipsov4_add_std(struct genl_info *info,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val = -EINVAL;\r\nstruct cipso_v4_doi *doi_def = NULL;\r\nstruct nlattr *nla_a;\r\nstruct nlattr *nla_b;\r\nint nla_a_rem;\r\nint nla_b_rem;\r\nu32 iter;\r\nif (!info->attrs[NLBL_CIPSOV4_A_TAGLST] ||\r\n!info->attrs[NLBL_CIPSOV4_A_MLSLVLLST])\r\nreturn -EINVAL;\r\nif (nla_validate_nested(info->attrs[NLBL_CIPSOV4_A_MLSLVLLST],\r\nNLBL_CIPSOV4_A_MAX,\r\nnetlbl_cipsov4_genl_policy) != 0)\r\nreturn -EINVAL;\r\ndoi_def = kmalloc(sizeof(*doi_def), GFP_KERNEL);\r\nif (doi_def == NULL)\r\nreturn -ENOMEM;\r\ndoi_def->map.std = kzalloc(sizeof(*doi_def->map.std), GFP_KERNEL);\r\nif (doi_def->map.std == NULL) {\r\nret_val = -ENOMEM;\r\ngoto add_std_failure;\r\n}\r\ndoi_def->type = CIPSO_V4_MAP_TRANS;\r\nret_val = netlbl_cipsov4_add_common(info, doi_def);\r\nif (ret_val != 0)\r\ngoto add_std_failure;\r\nret_val = -EINVAL;\r\nnla_for_each_nested(nla_a,\r\ninfo->attrs[NLBL_CIPSOV4_A_MLSLVLLST],\r\nnla_a_rem)\r\nif (nla_type(nla_a) == NLBL_CIPSOV4_A_MLSLVL) {\r\nif (nla_validate_nested(nla_a,\r\nNLBL_CIPSOV4_A_MAX,\r\nnetlbl_cipsov4_genl_policy) != 0)\r\ngoto add_std_failure;\r\nnla_for_each_nested(nla_b, nla_a, nla_b_rem)\r\nswitch (nla_type(nla_b)) {\r\ncase NLBL_CIPSOV4_A_MLSLVLLOC:\r\nif (nla_get_u32(nla_b) >\r\nCIPSO_V4_MAX_LOC_LVLS)\r\ngoto add_std_failure;\r\nif (nla_get_u32(nla_b) >=\r\ndoi_def->map.std->lvl.local_size)\r\ndoi_def->map.std->lvl.local_size =\r\nnla_get_u32(nla_b) + 1;\r\nbreak;\r\ncase NLBL_CIPSOV4_A_MLSLVLREM:\r\nif (nla_get_u32(nla_b) >\r\nCIPSO_V4_MAX_REM_LVLS)\r\ngoto add_std_failure;\r\nif (nla_get_u32(nla_b) >=\r\ndoi_def->map.std->lvl.cipso_size)\r\ndoi_def->map.std->lvl.cipso_size =\r\nnla_get_u32(nla_b) + 1;\r\nbreak;\r\n}\r\n}\r\ndoi_def->map.std->lvl.local = kcalloc(doi_def->map.std->lvl.local_size,\r\nsizeof(u32),\r\nGFP_KERNEL);\r\nif (doi_def->map.std->lvl.local == NULL) {\r\nret_val = -ENOMEM;\r\ngoto add_std_failure;\r\n}\r\ndoi_def->map.std->lvl.cipso = kcalloc(doi_def->map.std->lvl.cipso_size,\r\nsizeof(u32),\r\nGFP_KERNEL);\r\nif (doi_def->map.std->lvl.cipso == NULL) {\r\nret_val = -ENOMEM;\r\ngoto add_std_failure;\r\n}\r\nfor (iter = 0; iter < doi_def->map.std->lvl.local_size; iter++)\r\ndoi_def->map.std->lvl.local[iter] = CIPSO_V4_INV_LVL;\r\nfor (iter = 0; iter < doi_def->map.std->lvl.cipso_size; iter++)\r\ndoi_def->map.std->lvl.cipso[iter] = CIPSO_V4_INV_LVL;\r\nnla_for_each_nested(nla_a,\r\ninfo->attrs[NLBL_CIPSOV4_A_MLSLVLLST],\r\nnla_a_rem)\r\nif (nla_type(nla_a) == NLBL_CIPSOV4_A_MLSLVL) {\r\nstruct nlattr *lvl_loc;\r\nstruct nlattr *lvl_rem;\r\nlvl_loc = nla_find_nested(nla_a,\r\nNLBL_CIPSOV4_A_MLSLVLLOC);\r\nlvl_rem = nla_find_nested(nla_a,\r\nNLBL_CIPSOV4_A_MLSLVLREM);\r\nif (lvl_loc == NULL || lvl_rem == NULL)\r\ngoto add_std_failure;\r\ndoi_def->map.std->lvl.local[nla_get_u32(lvl_loc)] =\r\nnla_get_u32(lvl_rem);\r\ndoi_def->map.std->lvl.cipso[nla_get_u32(lvl_rem)] =\r\nnla_get_u32(lvl_loc);\r\n}\r\nif (info->attrs[NLBL_CIPSOV4_A_MLSCATLST]) {\r\nif (nla_validate_nested(info->attrs[NLBL_CIPSOV4_A_MLSCATLST],\r\nNLBL_CIPSOV4_A_MAX,\r\nnetlbl_cipsov4_genl_policy) != 0)\r\ngoto add_std_failure;\r\nnla_for_each_nested(nla_a,\r\ninfo->attrs[NLBL_CIPSOV4_A_MLSCATLST],\r\nnla_a_rem)\r\nif (nla_type(nla_a) == NLBL_CIPSOV4_A_MLSCAT) {\r\nif (nla_validate_nested(nla_a,\r\nNLBL_CIPSOV4_A_MAX,\r\nnetlbl_cipsov4_genl_policy) != 0)\r\ngoto add_std_failure;\r\nnla_for_each_nested(nla_b, nla_a, nla_b_rem)\r\nswitch (nla_type(nla_b)) {\r\ncase NLBL_CIPSOV4_A_MLSCATLOC:\r\nif (nla_get_u32(nla_b) >\r\nCIPSO_V4_MAX_LOC_CATS)\r\ngoto add_std_failure;\r\nif (nla_get_u32(nla_b) >=\r\ndoi_def->map.std->cat.local_size)\r\ndoi_def->map.std->cat.local_size =\r\nnla_get_u32(nla_b) + 1;\r\nbreak;\r\ncase NLBL_CIPSOV4_A_MLSCATREM:\r\nif (nla_get_u32(nla_b) >\r\nCIPSO_V4_MAX_REM_CATS)\r\ngoto add_std_failure;\r\nif (nla_get_u32(nla_b) >=\r\ndoi_def->map.std->cat.cipso_size)\r\ndoi_def->map.std->cat.cipso_size =\r\nnla_get_u32(nla_b) + 1;\r\nbreak;\r\n}\r\n}\r\ndoi_def->map.std->cat.local = kcalloc(\r\ndoi_def->map.std->cat.local_size,\r\nsizeof(u32),\r\nGFP_KERNEL);\r\nif (doi_def->map.std->cat.local == NULL) {\r\nret_val = -ENOMEM;\r\ngoto add_std_failure;\r\n}\r\ndoi_def->map.std->cat.cipso = kcalloc(\r\ndoi_def->map.std->cat.cipso_size,\r\nsizeof(u32),\r\nGFP_KERNEL);\r\nif (doi_def->map.std->cat.cipso == NULL) {\r\nret_val = -ENOMEM;\r\ngoto add_std_failure;\r\n}\r\nfor (iter = 0; iter < doi_def->map.std->cat.local_size; iter++)\r\ndoi_def->map.std->cat.local[iter] = CIPSO_V4_INV_CAT;\r\nfor (iter = 0; iter < doi_def->map.std->cat.cipso_size; iter++)\r\ndoi_def->map.std->cat.cipso[iter] = CIPSO_V4_INV_CAT;\r\nnla_for_each_nested(nla_a,\r\ninfo->attrs[NLBL_CIPSOV4_A_MLSCATLST],\r\nnla_a_rem)\r\nif (nla_type(nla_a) == NLBL_CIPSOV4_A_MLSCAT) {\r\nstruct nlattr *cat_loc;\r\nstruct nlattr *cat_rem;\r\ncat_loc = nla_find_nested(nla_a,\r\nNLBL_CIPSOV4_A_MLSCATLOC);\r\ncat_rem = nla_find_nested(nla_a,\r\nNLBL_CIPSOV4_A_MLSCATREM);\r\nif (cat_loc == NULL || cat_rem == NULL)\r\ngoto add_std_failure;\r\ndoi_def->map.std->cat.local[\r\nnla_get_u32(cat_loc)] =\r\nnla_get_u32(cat_rem);\r\ndoi_def->map.std->cat.cipso[\r\nnla_get_u32(cat_rem)] =\r\nnla_get_u32(cat_loc);\r\n}\r\n}\r\nret_val = cipso_v4_doi_add(doi_def, audit_info);\r\nif (ret_val != 0)\r\ngoto add_std_failure;\r\nreturn 0;\r\nadd_std_failure:\r\nif (doi_def)\r\ncipso_v4_doi_free(doi_def);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_cipsov4_add_pass(struct genl_info *info,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val;\r\nstruct cipso_v4_doi *doi_def = NULL;\r\nif (!info->attrs[NLBL_CIPSOV4_A_TAGLST])\r\nreturn -EINVAL;\r\ndoi_def = kmalloc(sizeof(*doi_def), GFP_KERNEL);\r\nif (doi_def == NULL)\r\nreturn -ENOMEM;\r\ndoi_def->type = CIPSO_V4_MAP_PASS;\r\nret_val = netlbl_cipsov4_add_common(info, doi_def);\r\nif (ret_val != 0)\r\ngoto add_pass_failure;\r\nret_val = cipso_v4_doi_add(doi_def, audit_info);\r\nif (ret_val != 0)\r\ngoto add_pass_failure;\r\nreturn 0;\r\nadd_pass_failure:\r\ncipso_v4_doi_free(doi_def);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_cipsov4_add_local(struct genl_info *info,\r\nstruct netlbl_audit *audit_info)\r\n{\r\nint ret_val;\r\nstruct cipso_v4_doi *doi_def = NULL;\r\nif (!info->attrs[NLBL_CIPSOV4_A_TAGLST])\r\nreturn -EINVAL;\r\ndoi_def = kmalloc(sizeof(*doi_def), GFP_KERNEL);\r\nif (doi_def == NULL)\r\nreturn -ENOMEM;\r\ndoi_def->type = CIPSO_V4_MAP_LOCAL;\r\nret_val = netlbl_cipsov4_add_common(info, doi_def);\r\nif (ret_val != 0)\r\ngoto add_local_failure;\r\nret_val = cipso_v4_doi_add(doi_def, audit_info);\r\nif (ret_val != 0)\r\ngoto add_local_failure;\r\nreturn 0;\r\nadd_local_failure:\r\ncipso_v4_doi_free(doi_def);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_cipsov4_add(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint ret_val = -EINVAL;\r\nstruct netlbl_audit audit_info;\r\nif (!info->attrs[NLBL_CIPSOV4_A_DOI] ||\r\n!info->attrs[NLBL_CIPSOV4_A_MTYPE])\r\nreturn -EINVAL;\r\nnetlbl_netlink_auditinfo(skb, &audit_info);\r\nswitch (nla_get_u32(info->attrs[NLBL_CIPSOV4_A_MTYPE])) {\r\ncase CIPSO_V4_MAP_TRANS:\r\nret_val = netlbl_cipsov4_add_std(info, &audit_info);\r\nbreak;\r\ncase CIPSO_V4_MAP_PASS:\r\nret_val = netlbl_cipsov4_add_pass(info, &audit_info);\r\nbreak;\r\ncase CIPSO_V4_MAP_LOCAL:\r\nret_val = netlbl_cipsov4_add_local(info, &audit_info);\r\nbreak;\r\n}\r\nif (ret_val == 0)\r\natomic_inc(&netlabel_mgmt_protocount);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_cipsov4_list(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint ret_val;\r\nstruct sk_buff *ans_skb = NULL;\r\nu32 nlsze_mult = 1;\r\nvoid *data;\r\nu32 doi;\r\nstruct nlattr *nla_a;\r\nstruct nlattr *nla_b;\r\nstruct cipso_v4_doi *doi_def;\r\nu32 iter;\r\nif (!info->attrs[NLBL_CIPSOV4_A_DOI]) {\r\nret_val = -EINVAL;\r\ngoto list_failure;\r\n}\r\nlist_start:\r\nans_skb = nlmsg_new(NLMSG_DEFAULT_SIZE * nlsze_mult, GFP_KERNEL);\r\nif (ans_skb == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_failure;\r\n}\r\ndata = genlmsg_put_reply(ans_skb, info, &netlbl_cipsov4_gnl_family,\r\n0, NLBL_CIPSOV4_C_LIST);\r\nif (data == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_failure;\r\n}\r\ndoi = nla_get_u32(info->attrs[NLBL_CIPSOV4_A_DOI]);\r\nrcu_read_lock();\r\ndoi_def = cipso_v4_doi_getdef(doi);\r\nif (doi_def == NULL) {\r\nret_val = -EINVAL;\r\ngoto list_failure_lock;\r\n}\r\nret_val = nla_put_u32(ans_skb, NLBL_CIPSOV4_A_MTYPE, doi_def->type);\r\nif (ret_val != 0)\r\ngoto list_failure_lock;\r\nnla_a = nla_nest_start(ans_skb, NLBL_CIPSOV4_A_TAGLST);\r\nif (nla_a == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_failure_lock;\r\n}\r\nfor (iter = 0;\r\niter < CIPSO_V4_TAG_MAXCNT &&\r\ndoi_def->tags[iter] != CIPSO_V4_TAG_INVALID;\r\niter++) {\r\nret_val = nla_put_u8(ans_skb,\r\nNLBL_CIPSOV4_A_TAG,\r\ndoi_def->tags[iter]);\r\nif (ret_val != 0)\r\ngoto list_failure_lock;\r\n}\r\nnla_nest_end(ans_skb, nla_a);\r\nswitch (doi_def->type) {\r\ncase CIPSO_V4_MAP_TRANS:\r\nnla_a = nla_nest_start(ans_skb, NLBL_CIPSOV4_A_MLSLVLLST);\r\nif (nla_a == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_failure_lock;\r\n}\r\nfor (iter = 0;\r\niter < doi_def->map.std->lvl.local_size;\r\niter++) {\r\nif (doi_def->map.std->lvl.local[iter] ==\r\nCIPSO_V4_INV_LVL)\r\ncontinue;\r\nnla_b = nla_nest_start(ans_skb, NLBL_CIPSOV4_A_MLSLVL);\r\nif (nla_b == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_retry;\r\n}\r\nret_val = nla_put_u32(ans_skb,\r\nNLBL_CIPSOV4_A_MLSLVLLOC,\r\niter);\r\nif (ret_val != 0)\r\ngoto list_retry;\r\nret_val = nla_put_u32(ans_skb,\r\nNLBL_CIPSOV4_A_MLSLVLREM,\r\ndoi_def->map.std->lvl.local[iter]);\r\nif (ret_val != 0)\r\ngoto list_retry;\r\nnla_nest_end(ans_skb, nla_b);\r\n}\r\nnla_nest_end(ans_skb, nla_a);\r\nnla_a = nla_nest_start(ans_skb, NLBL_CIPSOV4_A_MLSCATLST);\r\nif (nla_a == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_retry;\r\n}\r\nfor (iter = 0;\r\niter < doi_def->map.std->cat.local_size;\r\niter++) {\r\nif (doi_def->map.std->cat.local[iter] ==\r\nCIPSO_V4_INV_CAT)\r\ncontinue;\r\nnla_b = nla_nest_start(ans_skb, NLBL_CIPSOV4_A_MLSCAT);\r\nif (nla_b == NULL) {\r\nret_val = -ENOMEM;\r\ngoto list_retry;\r\n}\r\nret_val = nla_put_u32(ans_skb,\r\nNLBL_CIPSOV4_A_MLSCATLOC,\r\niter);\r\nif (ret_val != 0)\r\ngoto list_retry;\r\nret_val = nla_put_u32(ans_skb,\r\nNLBL_CIPSOV4_A_MLSCATREM,\r\ndoi_def->map.std->cat.local[iter]);\r\nif (ret_val != 0)\r\ngoto list_retry;\r\nnla_nest_end(ans_skb, nla_b);\r\n}\r\nnla_nest_end(ans_skb, nla_a);\r\nbreak;\r\n}\r\nrcu_read_unlock();\r\ngenlmsg_end(ans_skb, data);\r\nreturn genlmsg_reply(ans_skb, info);\r\nlist_retry:\r\nif (nlsze_mult < 4) {\r\nrcu_read_unlock();\r\nkfree_skb(ans_skb);\r\nnlsze_mult *= 2;\r\ngoto list_start;\r\n}\r\nlist_failure_lock:\r\nrcu_read_unlock();\r\nlist_failure:\r\nkfree_skb(ans_skb);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_cipsov4_listall_cb(struct cipso_v4_doi *doi_def, void *arg)\r\n{\r\nint ret_val = -ENOMEM;\r\nstruct netlbl_cipsov4_doiwalk_arg *cb_arg = arg;\r\nvoid *data;\r\ndata = genlmsg_put(cb_arg->skb, NETLINK_CB(cb_arg->nl_cb->skb).pid,\r\ncb_arg->seq, &netlbl_cipsov4_gnl_family,\r\nNLM_F_MULTI, NLBL_CIPSOV4_C_LISTALL);\r\nif (data == NULL)\r\ngoto listall_cb_failure;\r\nret_val = nla_put_u32(cb_arg->skb, NLBL_CIPSOV4_A_DOI, doi_def->doi);\r\nif (ret_val != 0)\r\ngoto listall_cb_failure;\r\nret_val = nla_put_u32(cb_arg->skb,\r\nNLBL_CIPSOV4_A_MTYPE,\r\ndoi_def->type);\r\nif (ret_val != 0)\r\ngoto listall_cb_failure;\r\nreturn genlmsg_end(cb_arg->skb, data);\r\nlistall_cb_failure:\r\ngenlmsg_cancel(cb_arg->skb, data);\r\nreturn ret_val;\r\n}\r\nstatic int netlbl_cipsov4_listall(struct sk_buff *skb,\r\nstruct netlink_callback *cb)\r\n{\r\nstruct netlbl_cipsov4_doiwalk_arg cb_arg;\r\nu32 doi_skip = cb->args[0];\r\ncb_arg.nl_cb = cb;\r\ncb_arg.skb = skb;\r\ncb_arg.seq = cb->nlh->nlmsg_seq;\r\ncipso_v4_doi_walk(&doi_skip, netlbl_cipsov4_listall_cb, &cb_arg);\r\ncb->args[0] = doi_skip;\r\nreturn skb->len;\r\n}\r\nstatic int netlbl_cipsov4_remove_cb(struct netlbl_dom_map *entry, void *arg)\r\n{\r\nstruct netlbl_domhsh_walk_arg *cb_arg = arg;\r\nif (entry->type == NETLBL_NLTYPE_CIPSOV4 &&\r\nentry->type_def.cipsov4->doi == cb_arg->doi)\r\nreturn netlbl_domhsh_remove_entry(entry, cb_arg->audit_info);\r\nreturn 0;\r\n}\r\nstatic int netlbl_cipsov4_remove(struct sk_buff *skb, struct genl_info *info)\r\n{\r\nint ret_val = -EINVAL;\r\nstruct netlbl_domhsh_walk_arg cb_arg;\r\nstruct netlbl_audit audit_info;\r\nu32 skip_bkt = 0;\r\nu32 skip_chain = 0;\r\nif (!info->attrs[NLBL_CIPSOV4_A_DOI])\r\nreturn -EINVAL;\r\nnetlbl_netlink_auditinfo(skb, &audit_info);\r\ncb_arg.doi = nla_get_u32(info->attrs[NLBL_CIPSOV4_A_DOI]);\r\ncb_arg.audit_info = &audit_info;\r\nret_val = netlbl_domhsh_walk(&skip_bkt, &skip_chain,\r\nnetlbl_cipsov4_remove_cb, &cb_arg);\r\nif (ret_val == 0 || ret_val == -ENOENT) {\r\nret_val = cipso_v4_doi_remove(cb_arg.doi, &audit_info);\r\nif (ret_val == 0)\r\natomic_dec(&netlabel_mgmt_protocount);\r\n}\r\nreturn ret_val;\r\n}\r\nint __init netlbl_cipsov4_genl_init(void)\r\n{\r\nreturn genl_register_family_with_ops(&netlbl_cipsov4_gnl_family,\r\nnetlbl_cipsov4_ops, ARRAY_SIZE(netlbl_cipsov4_ops));\r\n}

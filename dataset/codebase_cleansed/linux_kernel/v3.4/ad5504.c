static int ad5504_spi_write(struct spi_device *spi, u8 addr, u16 val)\r\n{\r\nu16 tmp = cpu_to_be16(AD5504_CMD_WRITE |\r\nAD5504_ADDR(addr) |\r\n(val & AD5504_RES_MASK));\r\nreturn spi_write(spi, (u8 *)&tmp, 2);\r\n}\r\nstatic int ad5504_spi_read(struct spi_device *spi, u8 addr)\r\n{\r\nu16 tmp = cpu_to_be16(AD5504_CMD_READ | AD5504_ADDR(addr));\r\nu16 val;\r\nint ret;\r\nstruct spi_transfer t = {\r\n.tx_buf = &tmp,\r\n.rx_buf = &val,\r\n.len = 2,\r\n};\r\nstruct spi_message m;\r\nspi_message_init(&m);\r\nspi_message_add_tail(&t, &m);\r\nret = spi_sync(spi, &m);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn be16_to_cpu(val) & AD5504_RES_MASK;\r\n}\r\nstatic int ad5504_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\nunsigned long scale_uv;\r\nint ret;\r\nswitch (m) {\r\ncase 0:\r\nret = ad5504_spi_read(st->spi, chan->address);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = ret;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\nscale_uv = (st->vref_mv * 1000) >> chan->scan_type.realbits;\r\n*val = scale_uv / 1000;\r\n*val2 = (scale_uv % 1000) * 1000;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ad5504_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\nint ret;\r\nswitch (mask) {\r\ncase 0:\r\nif (val >= (1 << chan->scan_type.realbits) || val < 0)\r\nreturn -EINVAL;\r\nreturn ad5504_spi_write(st->spi, chan->address, val);\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t ad5504_read_powerdown_mode(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\nconst char mode[][14] = {"20kohm_to_gnd", "three_state"};\r\nreturn sprintf(buf, "%s\n", mode[st->pwr_down_mode]);\r\n}\r\nstatic ssize_t ad5504_write_powerdown_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\nint ret;\r\nif (sysfs_streq(buf, "20kohm_to_gnd"))\r\nst->pwr_down_mode = AD5504_DAC_PWRDN_20K;\r\nelse if (sysfs_streq(buf, "three_state"))\r\nst->pwr_down_mode = AD5504_DAC_PWRDN_3STATE;\r\nelse\r\nret = -EINVAL;\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ad5504_read_dac_powerdown(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nreturn sprintf(buf, "%d\n",\r\n!(st->pwr_down_mask & (1 << this_attr->address)));\r\n}\r\nstatic ssize_t ad5504_write_dac_powerdown(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nlong readin;\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = strict_strtol(buf, 10, &readin);\r\nif (ret)\r\nreturn ret;\r\nif (readin == 0)\r\nst->pwr_down_mask |= (1 << this_attr->address);\r\nelse if (readin == 1)\r\nst->pwr_down_mask &= ~(1 << this_attr->address);\r\nelse\r\nret = -EINVAL;\r\nret = ad5504_spi_write(st->spi, AD5504_ADDR_CTRL,\r\nAD5504_DAC_PWRDWN_MODE(st->pwr_down_mode) |\r\nAD5504_DAC_PWR(st->pwr_down_mask));\r\nad5504_spi_write(st->spi, AD5504_ADDR_NOOP, 0);\r\nreturn ret ? ret : len;\r\n}\r\nstatic irqreturn_t ad5504_event_handler(int irq, void *private)\r\n{\r\niio_push_event(private,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP,\r\n0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_RISING),\r\niio_get_time_ns());\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit ad5504_probe(struct spi_device *spi)\r\n{\r\nstruct ad5504_platform_data *pdata = spi->dev.platform_data;\r\nstruct iio_dev *indio_dev;\r\nstruct ad5504_state *st;\r\nstruct regulator *reg;\r\nint ret, voltage_uv = 0;\r\nindio_dev = iio_allocate_device(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nreg = regulator_get(&spi->dev, "vcc");\r\nif (!IS_ERR(reg)) {\r\nret = regulator_enable(reg);\r\nif (ret)\r\ngoto error_put_reg;\r\nvoltage_uv = regulator_get_voltage(reg);\r\n}\r\nspi_set_drvdata(spi, indio_dev);\r\nst = iio_priv(indio_dev);\r\nif (voltage_uv)\r\nst->vref_mv = voltage_uv / 1000;\r\nelse if (pdata)\r\nst->vref_mv = pdata->vref_mv;\r\nelse\r\ndev_warn(&spi->dev, "reference voltage unspecified\n");\r\nst->reg = reg;\r\nst->spi = spi;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->name = spi_get_device_id(st->spi)->name;\r\nif (spi_get_device_id(st->spi)->driver_data == ID_AD5501) {\r\nindio_dev->info = &ad5501_info;\r\nindio_dev->num_channels = 1;\r\n} else {\r\nindio_dev->info = &ad5504_info;\r\nindio_dev->num_channels = 4;\r\n}\r\nindio_dev->channels = ad5504_channels;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nif (spi->irq) {\r\nret = request_threaded_irq(spi->irq,\r\nNULL,\r\n&ad5504_event_handler,\r\nIRQF_TRIGGER_FALLING | IRQF_ONESHOT,\r\nspi_get_device_id(st->spi)->name,\r\nindio_dev);\r\nif (ret)\r\ngoto error_disable_reg;\r\n}\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_free_irq;\r\nreturn 0;\r\nerror_free_irq:\r\nfree_irq(spi->irq, indio_dev);\r\nerror_disable_reg:\r\nif (!IS_ERR(reg))\r\nregulator_disable(reg);\r\nerror_put_reg:\r\nif (!IS_ERR(reg))\r\nregulator_put(reg);\r\niio_free_device(indio_dev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int __devexit ad5504_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\nstruct ad5504_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nif (spi->irq)\r\nfree_irq(spi->irq, indio_dev);\r\nif (!IS_ERR(st->reg)) {\r\nregulator_disable(st->reg);\r\nregulator_put(st->reg);\r\n}\r\niio_free_device(indio_dev);\r\nreturn 0;\r\n}

char *strchr(const char *s, int c)\r\n{\r\nint z, g;\r\nconst uintptr_t s_int = (uintptr_t) s;\r\nconst uint64_t *p = (const uint64_t *)(s_int & -8);\r\nconst uint64_t goal = 0x0101010101010101ULL * (uint8_t) c;\r\nconst uint64_t before_mask = (1ULL << (s_int << 3)) - 1;\r\nuint64_t v = (*p | before_mask) ^\r\n(goal & __insn_v1shrsi(before_mask, 1));\r\nuint64_t zero_matches, goal_matches;\r\nwhile (1) {\r\nzero_matches = __insn_v1cmpeqi(v, 0);\r\ngoal_matches = __insn_v1cmpeq(v, goal);\r\nif (__builtin_expect((zero_matches | goal_matches) != 0, 0))\r\nbreak;\r\nv = *++p;\r\n}\r\nz = __insn_ctz(zero_matches);\r\ng = __insn_ctz(goal_matches);\r\nreturn (g <= z) ? ((char *)p) + (g >> 3) : NULL;\r\n}

static ssize_t arvo_sysfs_show_mode_key(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct arvo_device *arvo =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nstruct usb_device *usb_dev =\r\ninterface_to_usbdev(to_usb_interface(dev->parent->parent));\r\nstruct arvo_mode_key temp_buf;\r\nint retval;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_receive(usb_dev, ARVO_COMMAND_MODE_KEY,\r\n&temp_buf, sizeof(struct arvo_mode_key));\r\nmutex_unlock(&arvo->arvo_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", temp_buf.state);\r\n}\r\nstatic ssize_t arvo_sysfs_set_mode_key(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct arvo_device *arvo =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nstruct usb_device *usb_dev =\r\ninterface_to_usbdev(to_usb_interface(dev->parent->parent));\r\nstruct arvo_mode_key temp_buf;\r\nunsigned long state;\r\nint retval;\r\nretval = strict_strtoul(buf, 10, &state);\r\nif (retval)\r\nreturn retval;\r\ntemp_buf.command = ARVO_COMMAND_MODE_KEY;\r\ntemp_buf.state = state;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_send(usb_dev, ARVO_COMMAND_MODE_KEY,\r\n&temp_buf, sizeof(struct arvo_mode_key));\r\nmutex_unlock(&arvo->arvo_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn size;\r\n}\r\nstatic ssize_t arvo_sysfs_show_key_mask(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct arvo_device *arvo =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nstruct usb_device *usb_dev =\r\ninterface_to_usbdev(to_usb_interface(dev->parent->parent));\r\nstruct arvo_key_mask temp_buf;\r\nint retval;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_receive(usb_dev, ARVO_COMMAND_KEY_MASK,\r\n&temp_buf, sizeof(struct arvo_key_mask));\r\nmutex_unlock(&arvo->arvo_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", temp_buf.key_mask);\r\n}\r\nstatic ssize_t arvo_sysfs_set_key_mask(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct arvo_device *arvo =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nstruct usb_device *usb_dev =\r\ninterface_to_usbdev(to_usb_interface(dev->parent->parent));\r\nstruct arvo_key_mask temp_buf;\r\nunsigned long key_mask;\r\nint retval;\r\nretval = strict_strtoul(buf, 10, &key_mask);\r\nif (retval)\r\nreturn retval;\r\ntemp_buf.command = ARVO_COMMAND_KEY_MASK;\r\ntemp_buf.key_mask = key_mask;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_send(usb_dev, ARVO_COMMAND_KEY_MASK,\r\n&temp_buf, sizeof(struct arvo_key_mask));\r\nmutex_unlock(&arvo->arvo_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn size;\r\n}\r\nstatic int arvo_get_actual_profile(struct usb_device *usb_dev)\r\n{\r\nstruct arvo_actual_profile temp_buf;\r\nint retval;\r\nretval = roccat_common_receive(usb_dev, ARVO_COMMAND_ACTUAL_PROFILE,\r\n&temp_buf, sizeof(struct arvo_actual_profile));\r\nif (retval)\r\nreturn retval;\r\nreturn temp_buf.actual_profile;\r\n}\r\nstatic ssize_t arvo_sysfs_show_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct arvo_device *arvo =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", arvo->actual_profile);\r\n}\r\nstatic ssize_t arvo_sysfs_set_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char const *buf, size_t size)\r\n{\r\nstruct arvo_device *arvo =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nstruct usb_device *usb_dev =\r\ninterface_to_usbdev(to_usb_interface(dev->parent->parent));\r\nstruct arvo_actual_profile temp_buf;\r\nunsigned long profile;\r\nint retval;\r\nretval = strict_strtoul(buf, 10, &profile);\r\nif (retval)\r\nreturn retval;\r\nif (profile < 1 || profile > 5)\r\nreturn -EINVAL;\r\ntemp_buf.command = ARVO_COMMAND_ACTUAL_PROFILE;\r\ntemp_buf.actual_profile = profile;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_send(usb_dev, ARVO_COMMAND_ACTUAL_PROFILE,\r\n&temp_buf, sizeof(struct arvo_actual_profile));\r\nif (!retval) {\r\narvo->actual_profile = profile;\r\nretval = size;\r\n}\r\nmutex_unlock(&arvo->arvo_lock);\r\nreturn retval;\r\n}\r\nstatic ssize_t arvo_sysfs_write(struct file *fp,\r\nstruct kobject *kobj, void const *buf,\r\nloff_t off, size_t count, size_t real_size, uint command)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct arvo_device *arvo = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_send(usb_dev, command, buf, real_size);\r\nmutex_unlock(&arvo->arvo_lock);\r\nreturn (retval ? retval : real_size);\r\n}\r\nstatic ssize_t arvo_sysfs_read(struct file *fp,\r\nstruct kobject *kobj, void *buf, loff_t off,\r\nsize_t count, size_t real_size, uint command)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct arvo_device *arvo = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off >= real_size)\r\nreturn 0;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&arvo->arvo_lock);\r\nretval = roccat_common_receive(usb_dev, command, buf, real_size);\r\nmutex_unlock(&arvo->arvo_lock);\r\nreturn (retval ? retval : real_size);\r\n}\r\nstatic ssize_t arvo_sysfs_write_button(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nreturn arvo_sysfs_write(fp, kobj, buf, off, count,\r\nsizeof(struct arvo_button), ARVO_COMMAND_BUTTON);\r\n}\r\nstatic ssize_t arvo_sysfs_read_info(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nreturn arvo_sysfs_read(fp, kobj, buf, off, count,\r\nsizeof(struct arvo_info), ARVO_COMMAND_INFO);\r\n}\r\nstatic int arvo_init_arvo_device_struct(struct usb_device *usb_dev,\r\nstruct arvo_device *arvo)\r\n{\r\nint retval;\r\nmutex_init(&arvo->arvo_lock);\r\nretval = arvo_get_actual_profile(usb_dev);\r\nif (retval < 0)\r\nreturn retval;\r\narvo->actual_profile = retval;\r\nreturn 0;\r\n}\r\nstatic int arvo_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct arvo_device *arvo;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_KEYBOARD) {\r\nhid_set_drvdata(hdev, NULL);\r\nreturn 0;\r\n}\r\narvo = kzalloc(sizeof(*arvo), GFP_KERNEL);\r\nif (!arvo) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, arvo);\r\nretval = arvo_init_arvo_device_struct(usb_dev, arvo);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init struct arvo_device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(arvo_class, hdev,\r\nsizeof(struct arvo_roccat_report));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\narvo->chrdev_minor = retval;\r\narvo->roccat_claimed = 1;\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(arvo);\r\nreturn retval;\r\n}\r\nstatic void arvo_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct arvo_device *arvo;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_KEYBOARD)\r\nreturn;\r\narvo = hid_get_drvdata(hdev);\r\nif (arvo->roccat_claimed)\r\nroccat_disconnect(arvo->chrdev_minor);\r\nkfree(arvo);\r\n}\r\nstatic int arvo_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = arvo_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install keyboard\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void arvo_remove(struct hid_device *hdev)\r\n{\r\narvo_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic void arvo_report_to_chrdev(struct arvo_device const *arvo,\r\nu8 const *data)\r\n{\r\nstruct arvo_special_report const *special_report;\r\nstruct arvo_roccat_report roccat_report;\r\nspecial_report = (struct arvo_special_report const *)data;\r\nroccat_report.profile = arvo->actual_profile;\r\nroccat_report.button = special_report->event &\r\nARVO_SPECIAL_REPORT_EVENT_MASK_BUTTON;\r\nif ((special_report->event & ARVO_SPECIAL_REPORT_EVENT_MASK_ACTION) ==\r\nARVO_SPECIAL_REPORT_EVENT_ACTION_PRESS)\r\nroccat_report.action = ARVO_ROCCAT_REPORT_ACTION_PRESS;\r\nelse\r\nroccat_report.action = ARVO_ROCCAT_REPORT_ACTION_RELEASE;\r\nroccat_report_event(arvo->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\n}\r\nstatic int arvo_raw_event(struct hid_device *hdev,\r\nstruct hid_report *report, u8 *data, int size)\r\n{\r\nstruct arvo_device *arvo = hid_get_drvdata(hdev);\r\nif (size != 3)\r\nreturn 0;\r\nif (arvo && arvo->roccat_claimed)\r\narvo_report_to_chrdev(arvo, data);\r\nreturn 0;\r\n}\r\nstatic int __init arvo_init(void)\r\n{\r\nint retval;\r\narvo_class = class_create(THIS_MODULE, "arvo");\r\nif (IS_ERR(arvo_class))\r\nreturn PTR_ERR(arvo_class);\r\narvo_class->dev_attrs = arvo_attributes;\r\narvo_class->dev_bin_attrs = arvo_bin_attributes;\r\nretval = hid_register_driver(&arvo_driver);\r\nif (retval)\r\nclass_destroy(arvo_class);\r\nreturn retval;\r\n}\r\nstatic void __exit arvo_exit(void)\r\n{\r\nhid_unregister_driver(&arvo_driver);\r\nclass_destroy(arvo_class);\r\n}

static int __net_init ipv6_sysctl_net_init(struct net *net)\r\n{\r\nstruct ctl_table *ipv6_table;\r\nstruct ctl_table *ipv6_route_table;\r\nstruct ctl_table *ipv6_icmp_table;\r\nint err;\r\nerr = -ENOMEM;\r\nipv6_table = kmemdup(ipv6_table_template, sizeof(ipv6_table_template),\r\nGFP_KERNEL);\r\nif (!ipv6_table)\r\ngoto out;\r\nipv6_route_table = ipv6_route_sysctl_init(net);\r\nif (!ipv6_route_table)\r\ngoto out_ipv6_table;\r\nipv6_table[0].child = ipv6_route_table;\r\nipv6_icmp_table = ipv6_icmp_sysctl_init(net);\r\nif (!ipv6_icmp_table)\r\ngoto out_ipv6_route_table;\r\nipv6_table[1].child = ipv6_icmp_table;\r\nipv6_table[2].data = &net->ipv6.sysctl.bindv6only;\r\nnet->ipv6.sysctl.table = register_net_sysctl_table(net, net_ipv6_ctl_path,\r\nipv6_table);\r\nif (!net->ipv6.sysctl.table)\r\ngoto out_ipv6_icmp_table;\r\nerr = 0;\r\nout:\r\nreturn err;\r\nout_ipv6_icmp_table:\r\nkfree(ipv6_icmp_table);\r\nout_ipv6_route_table:\r\nkfree(ipv6_route_table);\r\nout_ipv6_table:\r\nkfree(ipv6_table);\r\ngoto out;\r\n}\r\nstatic void __net_exit ipv6_sysctl_net_exit(struct net *net)\r\n{\r\nstruct ctl_table *ipv6_table;\r\nstruct ctl_table *ipv6_route_table;\r\nstruct ctl_table *ipv6_icmp_table;\r\nipv6_table = net->ipv6.sysctl.table->ctl_table_arg;\r\nipv6_route_table = ipv6_table[0].child;\r\nipv6_icmp_table = ipv6_table[1].child;\r\nunregister_net_sysctl_table(net->ipv6.sysctl.table);\r\nkfree(ipv6_table);\r\nkfree(ipv6_route_table);\r\nkfree(ipv6_icmp_table);\r\n}\r\nint ipv6_sysctl_register(void)\r\n{\r\nint err = -ENOMEM;\r\nip6_header = register_net_sysctl_rotable(net_ipv6_ctl_path, ipv6_rotable);\r\nif (ip6_header == NULL)\r\ngoto out;\r\nerr = register_pernet_subsys(&ipv6_sysctl_net_ops);\r\nif (err)\r\ngoto err_pernet;\r\nout:\r\nreturn err;\r\nerr_pernet:\r\nunregister_net_sysctl_table(ip6_header);\r\ngoto out;\r\n}\r\nvoid ipv6_sysctl_unregister(void)\r\n{\r\nunregister_net_sysctl_table(ip6_header);\r\nunregister_pernet_subsys(&ipv6_sysctl_net_ops);\r\n}\r\nint ipv6_static_sysctl_register(void)\r\n{\r\nip6_base = register_sysctl_paths(net_ipv6_ctl_path, ipv6_static_skeleton);\r\nif (ip6_base == NULL)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid ipv6_static_sysctl_unregister(void)\r\n{\r\nunregister_net_sysctl_table(ip6_base);\r\n}

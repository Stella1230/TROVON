const char *rcode_string(unsigned int rcode)\r\n{\r\nstatic const char *const names[] = {\r\n[RCODE_COMPLETE] = "complete",\r\n[RCODE_CONFLICT_ERROR] = "conflict error",\r\n[RCODE_DATA_ERROR] = "data error",\r\n[RCODE_TYPE_ERROR] = "type error",\r\n[RCODE_ADDRESS_ERROR] = "address error",\r\n[RCODE_SEND_ERROR] = "send error",\r\n[RCODE_CANCELLED] = "cancelled",\r\n[RCODE_BUSY] = "busy",\r\n[RCODE_GENERATION] = "generation",\r\n[RCODE_NO_ACK] = "no ack",\r\n};\r\nif (rcode < ARRAY_SIZE(names) && names[rcode])\r\nreturn names[rcode];\r\nelse\r\nreturn "unknown";\r\n}\r\nint snd_fw_transaction(struct fw_unit *unit, int tcode,\r\nu64 offset, void *buffer, size_t length)\r\n{\r\nstruct fw_device *device = fw_parent_device(unit);\r\nint generation, rcode, tries = 0;\r\nfor (;;) {\r\ngeneration = device->generation;\r\nsmp_rmb();\r\nrcode = fw_run_transaction(device->card, tcode,\r\ndevice->node_id, generation,\r\ndevice->max_speed, offset,\r\nbuffer, length);\r\nif (rcode == RCODE_COMPLETE)\r\nreturn 0;\r\nif (rcode_is_permanent_error(rcode) || ++tries >= 3) {\r\ndev_err(&unit->device, "transaction failed: %s\n",\r\nrcode_string(rcode));\r\nreturn -EIO;\r\n}\r\nmsleep(ERROR_RETRY_DELAY_MS);\r\n}\r\n}

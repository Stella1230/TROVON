unsigned long get_cmos_time(void)\r\n{\r\nunsigned int year, mon, day, hour, min, sec;\r\nspin_lock(&sh03_rtc_lock);\r\nagain:\r\ndo {\r\nsec = (__raw_readb(RTC_SEC1) & 0xf) + (__raw_readb(RTC_SEC10) & 0x7) * 10;\r\nmin = (__raw_readb(RTC_MIN1) & 0xf) + (__raw_readb(RTC_MIN10) & 0xf) * 10;\r\nhour = (__raw_readb(RTC_HOU1) & 0xf) + (__raw_readb(RTC_HOU10) & 0xf) * 10;\r\nday = (__raw_readb(RTC_DAY1) & 0xf) + (__raw_readb(RTC_DAY10) & 0xf) * 10;\r\nmon = (__raw_readb(RTC_MON1) & 0xf) + (__raw_readb(RTC_MON10) & 0xf) * 10;\r\nyear = (__raw_readb(RTC_YEA1) & 0xf) + (__raw_readb(RTC_YEA10) & 0xf) * 10\r\n+ (__raw_readb(RTC_YEA100 ) & 0xf) * 100\r\n+ (__raw_readb(RTC_YEA1000) & 0xf) * 1000;\r\n} while (sec != (__raw_readb(RTC_SEC1) & 0xf) + (__raw_readb(RTC_SEC10) & 0x7) * 10);\r\nif (year == 0 || mon < 1 || mon > 12 || day > 31 || day < 1 ||\r\nhour > 23 || min > 59 || sec > 59) {\r\nprintk(KERN_ERR\r\n"SH-03 RTC: invalid value, resetting to 1 Jan 2000\n");\r\nprintk("year=%d, mon=%d, day=%d, hour=%d, min=%d, sec=%d\n",\r\nyear, mon, day, hour, min, sec);\r\n__raw_writeb(0, RTC_SEC1); __raw_writeb(0, RTC_SEC10);\r\n__raw_writeb(0, RTC_MIN1); __raw_writeb(0, RTC_MIN10);\r\n__raw_writeb(0, RTC_HOU1); __raw_writeb(0, RTC_HOU10);\r\n__raw_writeb(6, RTC_WEE1);\r\n__raw_writeb(1, RTC_DAY1); __raw_writeb(0, RTC_DAY10);\r\n__raw_writeb(1, RTC_MON1); __raw_writeb(0, RTC_MON10);\r\n__raw_writeb(0, RTC_YEA1); __raw_writeb(0, RTC_YEA10);\r\n__raw_writeb(0, RTC_YEA100);\r\n__raw_writeb(2, RTC_YEA1000);\r\n__raw_writeb(0, RTC_CTL);\r\ngoto again;\r\n}\r\nspin_unlock(&sh03_rtc_lock);\r\nreturn mktime(year, mon, day, hour, min, sec);\r\n}\r\nvoid sh03_rtc_gettimeofday(struct timespec *tv)\r\n{\r\ntv->tv_sec = get_cmos_time();\r\ntv->tv_nsec = 0;\r\n}\r\nstatic int set_rtc_mmss(unsigned long nowtime)\r\n{\r\nint retval = 0;\r\nint real_seconds, real_minutes, cmos_minutes;\r\nint i;\r\nspin_lock(&sh03_rtc_lock);\r\nfor (i = 0 ; i < 1000000 ; i++)\r\nif (!(__raw_readb(RTC_CTL) & RTC_BUSY))\r\nbreak;\r\ncmos_minutes = (__raw_readb(RTC_MIN1) & 0xf) + (__raw_readb(RTC_MIN10) & 0xf) * 10;\r\nreal_seconds = nowtime % 60;\r\nreal_minutes = nowtime / 60;\r\nif (((abs(real_minutes - cmos_minutes) + 15)/30) & 1)\r\nreal_minutes += 30;\r\nreal_minutes %= 60;\r\nif (abs(real_minutes - cmos_minutes) < 30) {\r\n__raw_writeb(real_seconds % 10, RTC_SEC1);\r\n__raw_writeb(real_seconds / 10, RTC_SEC10);\r\n__raw_writeb(real_minutes % 10, RTC_MIN1);\r\n__raw_writeb(real_minutes / 10, RTC_MIN10);\r\n} else {\r\nprintk_once(KERN_NOTICE\r\n"set_rtc_mmss: can't update from %d to %d\n",\r\ncmos_minutes, real_minutes);\r\nretval = -1;\r\n}\r\nspin_unlock(&sh03_rtc_lock);\r\nreturn retval;\r\n}\r\nint sh03_rtc_settimeofday(const time_t secs)\r\n{\r\nunsigned long nowtime = secs;\r\nreturn set_rtc_mmss(nowtime);\r\n}\r\nvoid sh03_time_init(void)\r\n{\r\nrtc_sh_get_time = sh03_rtc_gettimeofday;\r\nrtc_sh_set_time = sh03_rtc_settimeofday;\r\n}

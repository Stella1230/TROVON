static irqreturn_t gpio_interrupt(int irq, void *ignored)\r\n{\r\nint state;\r\nif (!ssb_chipco_irq_status(&bcm47xx_bus.ssb.chipco,\r\nSSB_CHIPCO_IRQ_GPIO))\r\nreturn IRQ_NONE;\r\nstate = gpio_get_value(WGT634U_GPIO_RESET);\r\ngpio_polarity(WGT634U_GPIO_RESET, state);\r\nif (!state) {\r\nprintk(KERN_INFO "Reset button pressed");\r\nctrl_alt_del();\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init wgt634u_init(void)\r\n{\r\nu8 *et0mac;\r\nif (bcm47xx_bus_type != BCM47XX_BUS_TYPE_SSB)\r\nreturn -ENODEV;\r\net0mac = bcm47xx_bus.ssb.sprom.et0mac;\r\nif (et0mac[0] == 0x00 &&\r\n((et0mac[1] == 0x09 && et0mac[2] == 0x5b) ||\r\n(et0mac[1] == 0x0f && et0mac[2] == 0xb5))) {\r\nstruct ssb_mipscore *mcore = &bcm47xx_bus.ssb.mipscore;\r\nprintk(KERN_INFO "WGT634U machine detected.\n");\r\nif (!request_irq(gpio_to_irq(WGT634U_GPIO_RESET),\r\ngpio_interrupt, IRQF_SHARED,\r\n"WGT634U GPIO", &bcm47xx_bus.ssb.chipco)) {\r\ngpio_direction_input(WGT634U_GPIO_RESET);\r\ngpio_intmask(WGT634U_GPIO_RESET, 1);\r\nssb_chipco_irq_mask(&bcm47xx_bus.ssb.chipco,\r\nSSB_CHIPCO_IRQ_GPIO,\r\nSSB_CHIPCO_IRQ_GPIO);\r\n}\r\nwgt634u_flash_data.width = mcore->flash_buswidth;\r\nwgt634u_flash_resource.start = mcore->flash_window;\r\nwgt634u_flash_resource.end = mcore->flash_window\r\n+ mcore->flash_window_size\r\n- 1;\r\nreturn platform_add_devices(wgt634u_devices,\r\nARRAY_SIZE(wgt634u_devices));\r\n} else\r\nreturn -ENODEV;\r\n}

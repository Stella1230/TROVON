int radeon_sa_bo_manager_init(struct radeon_device *rdev,\r\nstruct radeon_sa_manager *sa_manager,\r\nunsigned size, u32 domain)\r\n{\r\nint r;\r\nsa_manager->bo = NULL;\r\nsa_manager->size = size;\r\nsa_manager->domain = domain;\r\nINIT_LIST_HEAD(&sa_manager->sa_bo);\r\nr = radeon_bo_create(rdev, size, RADEON_GPU_PAGE_SIZE, true,\r\nRADEON_GEM_DOMAIN_CPU, &sa_manager->bo);\r\nif (r) {\r\ndev_err(rdev->dev, "(%d) failed to allocate bo for manager\n", r);\r\nreturn r;\r\n}\r\nreturn r;\r\n}\r\nvoid radeon_sa_bo_manager_fini(struct radeon_device *rdev,\r\nstruct radeon_sa_manager *sa_manager)\r\n{\r\nstruct radeon_sa_bo *sa_bo, *tmp;\r\nif (!list_empty(&sa_manager->sa_bo)) {\r\ndev_err(rdev->dev, "sa_manager is not empty, clearing anyway\n");\r\n}\r\nlist_for_each_entry_safe(sa_bo, tmp, &sa_manager->sa_bo, list) {\r\nlist_del_init(&sa_bo->list);\r\n}\r\nradeon_bo_unref(&sa_manager->bo);\r\nsa_manager->size = 0;\r\n}\r\nint radeon_sa_bo_manager_start(struct radeon_device *rdev,\r\nstruct radeon_sa_manager *sa_manager)\r\n{\r\nint r;\r\nif (sa_manager->bo == NULL) {\r\ndev_err(rdev->dev, "no bo for sa manager\n");\r\nreturn -EINVAL;\r\n}\r\nr = radeon_bo_reserve(sa_manager->bo, false);\r\nif (r) {\r\ndev_err(rdev->dev, "(%d) failed to reserve manager bo\n", r);\r\nreturn r;\r\n}\r\nr = radeon_bo_pin(sa_manager->bo, sa_manager->domain, &sa_manager->gpu_addr);\r\nif (r) {\r\nradeon_bo_unreserve(sa_manager->bo);\r\ndev_err(rdev->dev, "(%d) failed to pin manager bo\n", r);\r\nreturn r;\r\n}\r\nr = radeon_bo_kmap(sa_manager->bo, &sa_manager->cpu_ptr);\r\nradeon_bo_unreserve(sa_manager->bo);\r\nreturn r;\r\n}\r\nint radeon_sa_bo_manager_suspend(struct radeon_device *rdev,\r\nstruct radeon_sa_manager *sa_manager)\r\n{\r\nint r;\r\nif (sa_manager->bo == NULL) {\r\ndev_err(rdev->dev, "no bo for sa manager\n");\r\nreturn -EINVAL;\r\n}\r\nr = radeon_bo_reserve(sa_manager->bo, false);\r\nif (!r) {\r\nradeon_bo_kunmap(sa_manager->bo);\r\nradeon_bo_unpin(sa_manager->bo);\r\nradeon_bo_unreserve(sa_manager->bo);\r\n}\r\nreturn r;\r\n}\r\nint radeon_sa_bo_new(struct radeon_device *rdev,\r\nstruct radeon_sa_manager *sa_manager,\r\nstruct radeon_sa_bo *sa_bo,\r\nunsigned size, unsigned align)\r\n{\r\nstruct radeon_sa_bo *tmp;\r\nstruct list_head *head;\r\nunsigned offset = 0, wasted = 0;\r\nBUG_ON(align > RADEON_GPU_PAGE_SIZE);\r\nBUG_ON(size > sa_manager->size);\r\nhead = sa_manager->sa_bo.prev;\r\nif (list_empty(&sa_manager->sa_bo)) {\r\ngoto out;\r\n}\r\noffset = 0;\r\nlist_for_each_entry(tmp, &sa_manager->sa_bo, list) {\r\nif ((tmp->offset - offset) >= size) {\r\nhead = tmp->list.prev;\r\ngoto out;\r\n}\r\noffset = tmp->offset + tmp->size;\r\nwasted = offset % align;\r\nif (wasted) {\r\nwasted = align - wasted;\r\n}\r\noffset += wasted;\r\n}\r\nhead = sa_manager->sa_bo.prev;\r\ntmp = list_entry(head, struct radeon_sa_bo, list);\r\noffset = tmp->offset + tmp->size;\r\nwasted = offset % align;\r\nif (wasted) {\r\nwasted = align - wasted;\r\n}\r\noffset += wasted;\r\nif ((sa_manager->size - offset) < size) {\r\nreturn -ENOMEM;\r\n}\r\nout:\r\nsa_bo->manager = sa_manager;\r\nsa_bo->offset = offset;\r\nsa_bo->size = size;\r\nlist_add(&sa_bo->list, head);\r\nreturn 0;\r\n}\r\nvoid radeon_sa_bo_free(struct radeon_device *rdev, struct radeon_sa_bo *sa_bo)\r\n{\r\nlist_del_init(&sa_bo->list);\r\n}

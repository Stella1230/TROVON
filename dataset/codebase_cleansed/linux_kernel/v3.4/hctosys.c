static int __init rtc_hctosys(void)\r\n{\r\nint err = -ENODEV;\r\nstruct rtc_time tm;\r\nstruct timespec tv = {\r\n.tv_nsec = NSEC_PER_SEC >> 1,\r\n};\r\nstruct rtc_device *rtc = rtc_class_open(CONFIG_RTC_HCTOSYS_DEVICE);\r\nif (rtc == NULL) {\r\npr_err("%s: unable to open rtc device (%s)\n",\r\n__FILE__, CONFIG_RTC_HCTOSYS_DEVICE);\r\ngoto err_open;\r\n}\r\nerr = rtc_read_time(rtc, &tm);\r\nif (err) {\r\ndev_err(rtc->dev.parent,\r\n"hctosys: unable to read the hardware clock\n");\r\ngoto err_read;\r\n}\r\nerr = rtc_valid_tm(&tm);\r\nif (err) {\r\ndev_err(rtc->dev.parent,\r\n"hctosys: invalid date/time\n");\r\ngoto err_invalid;\r\n}\r\nrtc_tm_to_time(&tm, &tv.tv_sec);\r\ndo_settimeofday(&tv);\r\ndev_info(rtc->dev.parent,\r\n"setting system clock to "\r\n"%d-%02d-%02d %02d:%02d:%02d UTC (%u)\n",\r\ntm.tm_year + 1900, tm.tm_mon + 1, tm.tm_mday,\r\ntm.tm_hour, tm.tm_min, tm.tm_sec,\r\n(unsigned int) tv.tv_sec);\r\nerr_invalid:\r\nerr_read:\r\nrtc_class_close(rtc);\r\nerr_open:\r\nrtc_hctosys_ret = err;\r\nreturn err;\r\n}

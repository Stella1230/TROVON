static int ab8500_registers_print(struct seq_file *s, void *p)\r\n{\r\nstruct device *dev = s->private;\r\nunsigned int i;\r\nu32 bank = debug_bank;\r\nseq_printf(s, AB8500_NAME_STRING " register values:\n");\r\nseq_printf(s, " bank %u:\n", bank);\r\nfor (i = 0; i < debug_ranges[bank].num_ranges; i++) {\r\nu32 reg;\r\nfor (reg = debug_ranges[bank].range[i].first;\r\nreg <= debug_ranges[bank].range[i].last;\r\nreg++) {\r\nu8 value;\r\nint err;\r\nerr = abx500_get_register_interruptible(dev,\r\n(u8)bank, (u8)reg, &value);\r\nif (err < 0) {\r\ndev_err(dev, "ab->read fail %d\n", err);\r\nreturn err;\r\n}\r\nerr = seq_printf(s, " [%u/0x%02X]: 0x%02X\n", bank,\r\nreg, value);\r\nif (err < 0) {\r\ndev_err(dev, "seq_printf overflow\n");\r\nreturn 0;\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab8500_registers_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_registers_print, inode->i_private);\r\n}\r\nstatic int ab8500_bank_print(struct seq_file *s, void *p)\r\n{\r\nreturn seq_printf(s, "%d\n", debug_bank);\r\n}\r\nstatic int ab8500_bank_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_bank_print, inode->i_private);\r\n}\r\nstatic ssize_t ab8500_bank_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_bank;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_bank);\r\nif (err)\r\nreturn err;\r\nif (user_bank >= AB8500_NUM_BANKS) {\r\ndev_err(dev, "debugfs error input > number of banks\n");\r\nreturn -EINVAL;\r\n}\r\ndebug_bank = user_bank;\r\nreturn count;\r\n}\r\nstatic int ab8500_address_print(struct seq_file *s, void *p)\r\n{\r\nreturn seq_printf(s, "0x%02X\n", debug_address);\r\n}\r\nstatic int ab8500_address_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_address_print, inode->i_private);\r\n}\r\nstatic ssize_t ab8500_address_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_address;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_address);\r\nif (err)\r\nreturn err;\r\nif (user_address > 0xff) {\r\ndev_err(dev, "debugfs error input > 0xff\n");\r\nreturn -EINVAL;\r\n}\r\ndebug_address = user_address;\r\nreturn count;\r\n}\r\nstatic int ab8500_val_print(struct seq_file *s, void *p)\r\n{\r\nstruct device *dev = s->private;\r\nint ret;\r\nu8 regvalue;\r\nret = abx500_get_register_interruptible(dev,\r\n(u8)debug_bank, (u8)debug_address, &regvalue);\r\nif (ret < 0) {\r\ndev_err(dev, "abx500_get_reg fail %d, %d\n",\r\nret, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nseq_printf(s, "0x%02X\n", regvalue);\r\nreturn 0;\r\n}\r\nstatic int ab8500_val_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab8500_val_print, inode->i_private);\r\n}\r\nstatic ssize_t ab8500_val_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct device *dev = ((struct seq_file *)(file->private_data))->private;\r\nunsigned long user_val;\r\nint err;\r\nerr = kstrtoul_from_user(user_buf, count, 0, &user_val);\r\nif (err)\r\nreturn err;\r\nif (user_val > 0xff) {\r\ndev_err(dev, "debugfs error input > 0xff\n");\r\nreturn -EINVAL;\r\n}\r\nerr = abx500_set_register_interruptible(dev,\r\n(u8)debug_bank, debug_address, (u8)user_val);\r\nif (err < 0) {\r\nprintk(KERN_ERR "abx500_set_reg failed %d, %d", err, __LINE__);\r\nreturn -EINVAL;\r\n}\r\nreturn count;\r\n}\r\nstatic int __devinit ab8500_debug_probe(struct platform_device *plf)\r\n{\r\ndebug_bank = AB8500_MISC;\r\ndebug_address = AB8500_REV_REG & 0x00FF;\r\nab8500_dir = debugfs_create_dir(AB8500_NAME_STRING, NULL);\r\nif (!ab8500_dir)\r\ngoto exit_no_debugfs;\r\nab8500_reg_file = debugfs_create_file("all-bank-registers",\r\nS_IRUGO, ab8500_dir, &plf->dev, &ab8500_registers_fops);\r\nif (!ab8500_reg_file)\r\ngoto exit_destroy_dir;\r\nab8500_bank_file = debugfs_create_file("register-bank",\r\n(S_IRUGO | S_IWUSR), ab8500_dir, &plf->dev, &ab8500_bank_fops);\r\nif (!ab8500_bank_file)\r\ngoto exit_destroy_reg;\r\nab8500_address_file = debugfs_create_file("register-address",\r\n(S_IRUGO | S_IWUSR), ab8500_dir, &plf->dev,\r\n&ab8500_address_fops);\r\nif (!ab8500_address_file)\r\ngoto exit_destroy_bank;\r\nab8500_val_file = debugfs_create_file("register-value",\r\n(S_IRUGO | S_IWUSR), ab8500_dir, &plf->dev, &ab8500_val_fops);\r\nif (!ab8500_val_file)\r\ngoto exit_destroy_address;\r\nreturn 0;\r\nexit_destroy_address:\r\ndebugfs_remove(ab8500_address_file);\r\nexit_destroy_bank:\r\ndebugfs_remove(ab8500_bank_file);\r\nexit_destroy_reg:\r\ndebugfs_remove(ab8500_reg_file);\r\nexit_destroy_dir:\r\ndebugfs_remove(ab8500_dir);\r\nexit_no_debugfs:\r\ndev_err(&plf->dev, "failed to create debugfs entries.\n");\r\nreturn -ENOMEM;\r\n}\r\nstatic int __devexit ab8500_debug_remove(struct platform_device *plf)\r\n{\r\ndebugfs_remove(ab8500_val_file);\r\ndebugfs_remove(ab8500_address_file);\r\ndebugfs_remove(ab8500_bank_file);\r\ndebugfs_remove(ab8500_reg_file);\r\ndebugfs_remove(ab8500_dir);\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_debug_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_debug_driver);\r\n}\r\nstatic void __exit ab8500_debug_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_debug_driver);\r\n}

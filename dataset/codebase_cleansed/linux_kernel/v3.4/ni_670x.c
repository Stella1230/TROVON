static int __devinit driver_ni_670x_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_ni_670x.driver_name);\r\n}\r\nstatic void __devexit driver_ni_670x_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_ni_670x_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_ni_670x);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_ni_670x_pci_driver.name = (char *)driver_ni_670x.driver_name;\r\nreturn pci_register_driver(&driver_ni_670x_pci_driver);\r\n}\r\nstatic void __exit driver_ni_670x_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_ni_670x_pci_driver);\r\ncomedi_driver_unregister(&driver_ni_670x);\r\n}\r\nstatic int ni_670x_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nint i;\r\nprintk(KERN_INFO "comedi%d: ni_670x: ", dev->minor);\r\nret = alloc_private(dev, sizeof(struct ni_670x_private));\r\nif (ret < 0)\r\nreturn ret;\r\nret = ni_670x_find_device(dev, it->options[0], it->options[1]);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mite_setup(devpriv->mite);\r\nif (ret < 0) {\r\nprintk(KERN_WARNING "error setting up mite\n");\r\nreturn ret;\r\n}\r\ndev->board_name = thisboard->name;\r\ndev->irq = mite_irq(devpriv->mite);\r\nprintk(KERN_INFO " %s", dev->board_name);\r\nif (alloc_subdevices(dev, 2) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->ao_chans;\r\ns->maxdata = 0xffff;\r\nif (s->n_chan == 32) {\r\nconst struct comedi_lrange **range_table_list;\r\nrange_table_list = kmalloc(sizeof(struct comedi_lrange *) * 32,\r\nGFP_KERNEL);\r\nif (!range_table_list)\r\nreturn -ENOMEM;\r\ns->range_table_list = range_table_list;\r\nfor (i = 0; i < 16; i++) {\r\nrange_table_list[i] = &range_bipolar10;\r\nrange_table_list[16 + i] = &range_0_20mA;\r\n}\r\n} else {\r\ns->range_table = &range_bipolar10;\r\n}\r\ns->insn_write = &ni_670x_ao_winsn;\r\ns->insn_read = &ni_670x_ao_rinsn;\r\ns = dev->subdevices + 1;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = ni_670x_dio_insn_bits;\r\ns->insn_config = ni_670x_dio_insn_config;\r\nwritel(0x10, devpriv->mite->daq_io_addr + MISC_CONTROL_OFFSET);\r\nwritel(0x00, devpriv->mite->daq_io_addr + AO_CONTROL_OFFSET);\r\nprintk(KERN_INFO "attached\n");\r\nreturn 1;\r\n}\r\nstatic int ni_670x_detach(struct comedi_device *dev)\r\n{\r\nprintk(KERN_INFO "comedi%d: ni_670x: remove\n", dev->minor);\r\nkfree(dev->subdevices[0].range_table_list);\r\nif (dev->private && devpriv->mite)\r\nmite_unsetup(devpriv->mite);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nreturn 0;\r\n}\r\nstatic int ni_670x_ao_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\nwritel(((chan & 15) << 1) | ((chan & 16) >> 4),\r\ndevpriv->mite->daq_io_addr + AO_CHAN_OFFSET);\r\nwritel(data[i], devpriv->mite->daq_io_addr + AO_VALUE_OFFSET);\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn i;\r\n}\r\nstatic int ni_670x_ao_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int ni_670x_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n != 2)\r\nreturn -EINVAL;\r\nif (data[0]) {\r\ns->state &= ~data[0];\r\ns->state |= data[0] & data[1];\r\nwritel(s->state,\r\ndevpriv->mite->daq_io_addr + DIO_PORT0_DATA_OFFSET);\r\n}\r\ndata[1] = readl(devpriv->mite->daq_io_addr + DIO_PORT0_DATA_OFFSET);\r\nreturn 2;\r\n}\r\nstatic int ni_670x_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint chan = CR_CHAN(insn->chanspec);\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ns->io_bits |= 1 << chan;\r\nbreak;\r\ncase INSN_CONFIG_DIO_INPUT:\r\ns->io_bits &= ~(1 << chan);\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] =\r\n(s->io_bits & (1 << chan)) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nwritel(s->io_bits, devpriv->mite->daq_io_addr + DIO_PORT0_DIR_OFFSET);\r\nreturn insn->n;\r\n}\r\nstatic int ni_670x_find_device(struct comedi_device *dev, int bus, int slot)\r\n{\r\nstruct mite_struct *mite;\r\nint i;\r\nfor (mite = mite_devices; mite; mite = mite->next) {\r\nif (mite->used)\r\ncontinue;\r\nif (bus || slot) {\r\nif (bus != mite->pcidev->bus->number\r\n|| slot != PCI_SLOT(mite->pcidev->devfn))\r\ncontinue;\r\n}\r\nfor (i = 0; i < n_ni_670x_boards; i++) {\r\nif (mite_device_id(mite) == ni_670x_boards[i].dev_id) {\r\ndev->board_ptr = ni_670x_boards + i;\r\ndevpriv->mite = mite;\r\nreturn 0;\r\n}\r\n}\r\n}\r\nprintk(KERN_INFO "no device found\n");\r\nmite_list_devices();\r\nreturn -EIO;\r\n}

void\r\nSiS_UnLockCRT2(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType == XGI_20)\r\nreturn;\r\nelse if(SiS_Pr->ChipType >= SIS_315H)\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2f,0x01);\r\nelse\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x24,0x01);\r\n}\r\nstatic\r\nvoid\r\nSiS_LockCRT2(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType == XGI_20)\r\nreturn;\r\nelse if(SiS_Pr->ChipType >= SIS_315H)\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2F,0xFE);\r\nelse\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x24,0xFE);\r\n}\r\nstatic void\r\nSiS_SetRegSR11ANDOR(struct SiS_Private *SiS_Pr, unsigned short DataAND, unsigned short DataOR)\r\n{\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\nDataAND &= 0x0f;\r\nDataOR &= 0x0f;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x11,DataAND,DataOR);\r\n}\r\nstatic unsigned char *\r\nGetLCDStructPtr661(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned char *myptr = NULL;\r\nunsigned short romindex = 0, reg = 0, idx = 0;\r\nif((SiS_Pr->SiS_ROMNew) &&\r\n((SiS_Pr->SiS_VBType & VB_SISLVDS) || (!SiS_Pr->PanelSelfDetected))) {\r\nif(SiS_Pr->ChipType < SIS_661) reg = 0x3c;\r\nelse reg = 0x7d;\r\nidx = (SiS_GetReg(SiS_Pr->SiS_P3d4,reg) & 0x1f) * 26;\r\nif(idx < (8*26)) {\r\nmyptr = (unsigned char *)&SiS_LCDStruct661[idx];\r\n}\r\nromindex = SISGETROMW(0x100);\r\nif(romindex) {\r\nromindex += idx;\r\nmyptr = &ROMAddr[romindex];\r\n}\r\n}\r\nreturn myptr;\r\n}\r\nstatic unsigned short\r\nGetLCDStructPtr661_2(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr = 0;\r\nif((SiS_Pr->SiS_ROMNew) &&\r\n((SiS_Pr->SiS_VBType & VB_SISLVDS) || (!SiS_Pr->PanelSelfDetected))) {\r\nromptr = SISGETROMW(0x102);\r\nromptr += ((SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) >> 4) * SiS_Pr->SiS661LCD2TableSize);\r\n}\r\nreturn romptr;\r\n}\r\nstatic bool\r\nSiS_AdjustCRT2Rate(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RRTI, unsigned short *i)\r\n{\r\nunsigned short checkmask=0, modeid, infoflag;\r\nmodeid = SiS_Pr->SiS_RefIndex[RRTI + (*i)].ModeID;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) {\r\ncheckmask |= SupportRAMDAC2;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\ncheckmask |= SupportRAMDAC2_135;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\ncheckmask |= SupportRAMDAC2_162;\r\nif(SiS_Pr->SiS_VBType & VB_SISRAMDAC202) {\r\ncheckmask |= SupportRAMDAC2_202;\r\n}\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\ncheckmask |= SupportLCD;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nif(modeid == 0x2e) checkmask |= Support64048060Hz;\r\n}\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\ncheckmask |= SupportHiVision;\r\n} else if(SiS_Pr->SiS_VBInfo & (SetCRT2ToYPbPr525750|SetCRT2ToAVIDEO|SetCRT2ToSVIDEO|SetCRT2ToSCART)) {\r\ncheckmask |= SupportTV;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\ncheckmask |= SupportTV1024;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) {\r\ncheckmask |= SupportYPbPr750p;\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\ncheckmask |= SupportCHTV;\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\ncheckmask |= SupportLCD;\r\n}\r\n}\r\nfor(; SiS_Pr->SiS_RefIndex[RRTI + (*i)].ModeID == modeid; (*i)--) {\r\ninfoflag = SiS_Pr->SiS_RefIndex[RRTI + (*i)].Ext_InfoFlag;\r\nif(infoflag & checkmask) return true;\r\nif((*i) == 0) break;\r\n}\r\nfor((*i) = 0; ; (*i)++) {\r\nif(SiS_Pr->SiS_RefIndex[RRTI + (*i)].ModeID != modeid) break;\r\ninfoflag = SiS_Pr->SiS_RefIndex[RRTI + (*i)].Ext_InfoFlag;\r\nif(infoflag & checkmask) return true;\r\n}\r\nreturn false;\r\n}\r\nunsigned short\r\nSiS_GetRatePtr(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short RRTI,i,backup_i;\r\nunsigned short modeflag,index,temp,backupindex;\r\nstatic const unsigned short LCDRefreshIndex[] = {\r\n0x00, 0x00, 0x01, 0x01,\r\n0x01, 0x01, 0x01, 0x01,\r\n0x01, 0x01, 0x01, 0x01,\r\n0x01, 0x01, 0x01, 0x01,\r\n0x00, 0x00, 0x00, 0x00\r\n};\r\nif(ModeNo == 0xfe) return 0;\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(modeflag & HalfDCLK) return 0;\r\n}\r\n}\r\nif(ModeNo < 0x14) return 0xFFFF;\r\nindex = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x33) >> SiS_Pr->SiS_SelectCRT2Rate) & 0x0F;\r\nbackupindex = index;\r\nif(index > 0) index--;\r\nif(SiS_Pr->SiS_SetFlag & ProgrammingCRT2) {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->SiS_VBType & VB_NoLCD) index = 0;\r\nelse if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) index = backupindex = 0;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_VBType & VB_NoLCD)) {\r\ntemp = LCDRefreshIndex[SiS_GetBIOSLCDResInfo(SiS_Pr)];\r\nif(index > temp) index = temp;\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) index = 0;\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) index = 0;\r\n}\r\n}\r\n}\r\nRRTI = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].REFindex;\r\nModeNo = SiS_Pr->SiS_RefIndex[RRTI].ModeID;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(!(SiS_Pr->SiS_VBInfo & DriverMode)) {\r\nif( (SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_VESAID == 0x105) ||\r\n(SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_VESAID == 0x107) ) {\r\nif(backupindex <= 1) RRTI++;\r\n}\r\n}\r\n}\r\ni = 0;\r\ndo {\r\nif(SiS_Pr->SiS_RefIndex[RRTI + i].ModeID != ModeNo) break;\r\ntemp = SiS_Pr->SiS_RefIndex[RRTI + i].Ext_InfoFlag;\r\ntemp &= ModeTypeMask;\r\nif(temp < SiS_Pr->SiS_ModeType) break;\r\ni++;\r\nindex--;\r\n} while(index != 0xFFFF);\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC)) {\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\ntemp = SiS_Pr->SiS_RefIndex[RRTI + i - 1].Ext_InfoFlag;\r\nif(temp & InterlaceMode) i++;\r\n}\r\n}\r\ni--;\r\nif((SiS_Pr->SiS_SetFlag & ProgrammingCRT2) && (!(SiS_Pr->SiS_VBInfo & DisableCRT2Display))) {\r\nbackup_i = i;\r\nif(!(SiS_AdjustCRT2Rate(SiS_Pr, ModeNo, ModeIdIndex, RRTI, &i))) {\r\ni = backup_i;\r\n}\r\n}\r\nreturn (RRTI + i);\r\n}\r\nstatic void\r\nSiS_SaveCRT2Info(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nunsigned short temp1, temp2;\r\nSiS_SetReg(SiS_Pr->SiS_P3d4,0x34,ModeNo);\r\ntemp1 = (SiS_Pr->SiS_VBInfo & SetInSlaveMode) >> 8;\r\ntemp2 = ~(SetInSlaveMode >> 8);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x31,temp2,temp1);\r\n}\r\nstatic bool\r\nSiS_CR36BIOSWord23b(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short temp,temp1;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif((ROMAddr[0x233] == 0x12) && (ROMAddr[0x234] == 0x34)) {\r\ntemp = 1 << ((SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) >> 4) & 0x0f);\r\ntemp1 = SISGETROMW(0x23b);\r\nif(temp1 & temp) return true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_CR36BIOSWord23d(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short temp,temp1;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif((ROMAddr[0x233] == 0x12) && (ROMAddr[0x234] == 0x34)) {\r\ntemp = 1 << ((SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) >> 4) & 0x0f);\r\ntemp1 = SISGETROMW(0x23d);\r\nif(temp1 & temp) return true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nvoid\r\nSiS_DDC2Delay(struct SiS_Private *SiS_Pr, unsigned int delaytime)\r\n{\r\nwhile (delaytime-- > 0)\r\nSiS_GetReg(SiS_Pr->SiS_P3c4, 0x05);\r\n}\r\nstatic void\r\nSiS_GenericDelay(struct SiS_Private *SiS_Pr, unsigned short delay)\r\n{\r\nSiS_DDC2Delay(SiS_Pr, delay * 36);\r\n}\r\nstatic void\r\nSiS_LongDelay(struct SiS_Private *SiS_Pr, unsigned short delay)\r\n{\r\nwhile(delay--) {\r\nSiS_GenericDelay(SiS_Pr, 6623);\r\n}\r\n}\r\nstatic void\r\nSiS_ShortDelay(struct SiS_Private *SiS_Pr, unsigned short delay)\r\n{\r\nwhile(delay--) {\r\nSiS_GenericDelay(SiS_Pr, 66);\r\n}\r\n}\r\nstatic void\r\nSiS_PanelDelay(struct SiS_Private *SiS_Pr, unsigned short DelayTime)\r\n{\r\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short PanelID, DelayIndex, Delay=0;\r\n#endif\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nPanelID = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36);\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) PanelID &= 0xf7;\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x18) & 0x10)) PanelID = 0x12;\r\n}\r\nDelayIndex = PanelID >> 4;\r\nif((DelayTime >= 2) && ((PanelID & 0x0f) == 1)) {\r\nDelay = 3;\r\n} else {\r\nif(DelayTime >= 2) DelayTime -= 2;\r\nif(!(DelayTime & 0x01)) {\r\nDelay = SiS_Pr->SiS_PanelDelayTbl[DelayIndex].timer[0];\r\n} else {\r\nDelay = SiS_Pr->SiS_PanelDelayTbl[DelayIndex].timer[1];\r\n}\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(ROMAddr[0x220] & 0x40) {\r\nif(!(DelayTime & 0x01)) Delay = (unsigned short)ROMAddr[0x225];\r\nelse Delay = (unsigned short)ROMAddr[0x226];\r\n}\r\n}\r\n}\r\nSiS_ShortDelay(SiS_Pr, Delay);\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif((SiS_Pr->ChipType >= SIS_661) ||\r\n(SiS_Pr->ChipType <= SIS_315PRO) ||\r\n(SiS_Pr->ChipType == SIS_330) ||\r\n(SiS_Pr->SiS_ROMNew)) {\r\nif(!(DelayTime & 0x01)) {\r\nSiS_DDC2Delay(SiS_Pr, 0x1000);\r\n} else {\r\nSiS_DDC2Delay(SiS_Pr, 0x4000);\r\n}\r\n} else if((SiS_Pr->SiS_IF_DEF_LVDS == 1) ) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nPanelID = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36);\r\nif(SiS_Pr->SiS_CustomT == CUT_CLEVO1400) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x1b) & 0x10)) PanelID = 0x12;\r\n}\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) {\r\nDelayIndex = PanelID & 0x0f;\r\n} else {\r\nDelayIndex = PanelID >> 4;\r\n}\r\nif((DelayTime >= 2) && ((PanelID & 0x0f) == 1)) {\r\nDelay = 3;\r\n} else {\r\nif(DelayTime >= 2) DelayTime -= 2;\r\nif(!(DelayTime & 0x01)) {\r\nDelay = SiS_Pr->SiS_PanelDelayTblLVDS[DelayIndex].timer[0];\r\n} else {\r\nDelay = SiS_Pr->SiS_PanelDelayTblLVDS[DelayIndex].timer[1];\r\n}\r\nif((SiS_Pr->SiS_UseROM) && (!(SiS_Pr->SiS_ROMNew))) {\r\nif(ROMAddr[0x13c] & 0x40) {\r\nif(!(DelayTime & 0x01)) {\r\nDelay = (unsigned short)ROMAddr[0x17e];\r\n} else {\r\nDelay = (unsigned short)ROMAddr[0x17f];\r\n}\r\n}\r\n}\r\n}\r\nSiS_ShortDelay(SiS_Pr, Delay);\r\n}\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nDelayIndex = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) >> 4;\r\nif(!(DelayTime & 0x01)) {\r\nDelay = SiS_Pr->SiS_PanelDelayTbl[DelayIndex].timer[0];\r\n} else {\r\nDelay = SiS_Pr->SiS_PanelDelayTbl[DelayIndex].timer[1];\r\n}\r\nDelay <<= 8;\r\nSiS_DDC2Delay(SiS_Pr, Delay);\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void\r\nSiS_PanelDelayLoop(struct SiS_Private *SiS_Pr, unsigned short DelayTime, unsigned short DelayLoop)\r\n{\r\nint i;\r\nfor(i = 0; i < DelayLoop; i++) {\r\nSiS_PanelDelay(SiS_Pr, DelayTime);\r\n}\r\n}\r\nvoid\r\nSiS_WaitRetrace1(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short watchdog;\r\nif(SiS_GetReg(SiS_Pr->SiS_P3c4,0x1f) & 0xc0) return;\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3d4,0x17) & 0x80)) return;\r\nwatchdog = 65535;\r\nwhile((SiS_GetRegByte(SiS_Pr->SiS_P3da) & 0x08) && --watchdog);\r\nwatchdog = 65535;\r\nwhile((!(SiS_GetRegByte(SiS_Pr->SiS_P3da) & 0x08)) && --watchdog);\r\n}\r\nstatic void\r\nSiS_WaitRetrace2(struct SiS_Private *SiS_Pr, unsigned short reg)\r\n{\r\nunsigned short watchdog;\r\nwatchdog = 65535;\r\nwhile((SiS_GetReg(SiS_Pr->SiS_Part1Port,reg) & 0x02) && --watchdog);\r\nwatchdog = 65535;\r\nwhile((!(SiS_GetReg(SiS_Pr->SiS_Part1Port,reg) & 0x02)) && --watchdog);\r\n}\r\nstatic void\r\nSiS_WaitVBRetrace(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x20)) return;\r\n}\r\nif(!(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x80)) {\r\nSiS_WaitRetrace1(SiS_Pr);\r\n} else {\r\nSiS_WaitRetrace2(SiS_Pr, 0x25);\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(!(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x40)) {\r\nSiS_WaitRetrace1(SiS_Pr);\r\n} else {\r\nSiS_WaitRetrace2(SiS_Pr, 0x30);\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void\r\nSiS_VBWait(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short tempal,temp,i,j;\r\ntemp = 0;\r\nfor(i = 0; i < 3; i++) {\r\nfor(j = 0; j < 100; j++) {\r\ntempal = SiS_GetRegByte(SiS_Pr->SiS_P3da);\r\nif(temp & 0x01) {\r\nif((tempal & 0x08)) continue;\r\nelse break;\r\n} else {\r\nif(!(tempal & 0x08)) continue;\r\nelse break;\r\n}\r\n}\r\ntemp ^= 0x01;\r\n}\r\n}\r\nstatic void\r\nSiS_VBLongWait(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_VBWait(SiS_Pr);\r\n} else {\r\nSiS_WaitRetrace1(SiS_Pr);\r\n}\r\n}\r\nstatic bool\r\nSiS_Is301B(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_GetReg(SiS_Pr->SiS_Part4Port,0x01) >= 0xb0) return true;\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_CRT2IsLCD(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType == SIS_730) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3c4,0x13) & 0x20) return true;\r\n}\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x30) & 0x20) return true;\r\nreturn false;\r\n}\r\nbool\r\nSiS_IsDualEdge(struct SiS_Private *SiS_Pr)\r\n{\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif((SiS_Pr->ChipType != SIS_650) || (SiS_GetReg(SiS_Pr->SiS_P3d4,0x5f) & 0xf0)) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x38) & EnableDualEdge) return true;\r\n}\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nbool\r\nSiS_IsVAMode(struct SiS_Private *SiS_Pr)\r\n{\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short flag;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif((flag & EnableDualEdge) && (flag & SetToLCDA)) return true;\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_IsVAorLCD(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_IsVAMode(SiS_Pr)) return true;\r\nif(SiS_CRT2IsLCD(SiS_Pr)) return true;\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_IsDualLink(struct SiS_Private *SiS_Pr)\r\n{\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif((SiS_CRT2IsLCD(SiS_Pr)) ||\r\n(SiS_IsVAMode(SiS_Pr))) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDDualLink) return true;\r\n}\r\n}\r\n#endif\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_TVEnabled(struct SiS_Private *SiS_Pr)\r\n{\r\nif((SiS_GetReg(SiS_Pr->SiS_Part2Port,0x00) & 0x0f) != 0x0c) return true;\r\nif(SiS_Pr->SiS_VBType & VB_SISYPBPR) {\r\nif(SiS_GetReg(SiS_Pr->SiS_Part2Port,0x4d) & 0x10) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_LCDAEnabled(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x13) & 0x04) return true;\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_WeHaveBacklightCtrl(struct SiS_Private *SiS_Pr)\r\n{\r\nif((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->ChipType < SIS_661)) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x79) & 0x10) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_IsNotM650orLater(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag;\r\nif(SiS_Pr->ChipType == SIS_650) {\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x5f) & 0xf0;\r\nif((flag == 0xe0) || (flag == 0xc0) ||\r\n(flag == 0xb0) || (flag == 0x90)) return false;\r\n} else if(SiS_Pr->ChipType >= SIS_661) return false;\r\nreturn true;\r\n}\r\nstatic bool\r\nSiS_IsYPbPr(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x38) & EnableCHYPbPr) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_IsChScart(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x38) & EnableCHScart) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_IsTVOrYPbPrOrScart(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(flag & SetCRT2ToTV) return true;\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif(flag & EnableCHYPbPr) return true;\r\nif(flag & EnableCHScart) return true;\r\n} else {\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(flag & SetCRT2ToTV) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_IsLCDOrLCDA(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(flag & SetCRT2ToLCD) return true;\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif(flag & SetToLCDA) return true;\r\n} else {\r\nflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(flag & SetCRT2ToLCD) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_HaveBridge(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag;\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nreturn true;\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nflag = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x00);\r\nif((flag == 1) || (flag == 2)) return true;\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_BridgeIsEnabled(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag;\r\nif(SiS_HaveBridge(SiS_Pr)) {\r\nflag = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00);\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nflag &= 0xa0;\r\nif((flag == 0x80) || (flag == 0x20)) return true;\r\n} else {\r\nflag &= 0x50;\r\nif((flag == 0x40) || (flag == 0x10)) return true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic bool\r\nSiS_BridgeInSlavemode(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag1;\r\nflag1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x31);\r\nif(flag1 & (SetInSlaveMode >> 8)) return true;\r\nreturn false;\r\n}\r\nvoid\r\nSiS_SetChrontelGPIO(struct SiS_Private *SiS_Pr, unsigned short myvbinfo)\r\n{\r\nunsigned int acpibase;\r\nunsigned short temp;\r\nif(!(SiS_Pr->SiS_ChSW)) return;\r\nacpibase = sisfb_read_lpc_pci_dword(SiS_Pr, 0x74);\r\nacpibase &= 0xFFFF;\r\nif(!acpibase) return;\r\ntemp = SiS_GetRegShort((acpibase + 0x3c));\r\ntemp &= 0xFEFF;\r\nSiS_SetRegShort((acpibase + 0x3c), temp);\r\ntemp = SiS_GetRegShort((acpibase + 0x3c));\r\ntemp = SiS_GetRegShort((acpibase + 0x3a));\r\ntemp &= 0xFEFF;\r\nif(!(myvbinfo & SetCRT2ToTV)) temp |= 0x0100;\r\nSiS_SetRegShort((acpibase + 0x3a), temp);\r\ntemp = SiS_GetRegShort((acpibase + 0x3a));\r\n}\r\nvoid\r\nSiS_GetVBInfo(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, int checkcrt2mode)\r\n{\r\nunsigned short tempax, tempbx, temp;\r\nunsigned short modeflag, resinfo = 0;\r\nSiS_Pr->SiS_SetFlag = 0;\r\nmodeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_Pr->SiS_ModeType = modeflag & ModeTypeMask;\r\nif((ModeNo > 0x13) && (!SiS_Pr->UseCustomMode)) {\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n}\r\ntempbx = 0;\r\nif(SiS_HaveBridge(SiS_Pr)) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\ntempbx |= temp;\r\ntempax = SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) << 8;\r\ntempax &= (DriverMode | LoadDACFlag | SetNotSimuMode | SetPALTV);\r\ntempbx |= tempax;\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBType & VB_SISLCDA) {\r\nif(ModeNo == 0x03) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3d4,0x31,0xbf);\r\n}\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & (DriverMode >> 8))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3d4,0x38,0xfc);\r\n}\r\nif(IS_SIS650) {\r\nif(SiS_Pr->SiS_UseLCDA) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x5f) & 0xF0) {\r\nif((ModeNo <= 0x13) || (!(SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & (DriverMode >> 8)))) {\r\nSiS_SetRegOR(SiS_Pr->SiS_P3d4,0x38,(EnableDualEdge | SetToLCDA));\r\n}\r\n}\r\n}\r\n}\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif((temp & (EnableDualEdge | SetToLCDA)) == (EnableDualEdge | SetToLCDA)) {\r\ntempbx |= SetCRT2ToLCDA;\r\n}\r\n}\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\ntempbx &= ~(SetCRT2ToYPbPr525750 | SetCRT2ToHiVision);\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x38) & 0x04) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x35) & 0xe0;\r\nif(temp == 0x60) tempbx |= SetCRT2ToHiVision;\r\nelse if(SiS_Pr->SiS_VBType & VB_SISYPBPR) {\r\ntempbx |= SetCRT2ToYPbPr525750;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif(temp & SetToLCDA) {\r\ntempbx |= SetCRT2ToLCDA;\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(temp & EnableCHYPbPr) {\r\ntempbx |= SetCRT2ToCHYPbPr;\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\nif(!(SiS_Pr->SiS_VBType & VB_SISVGA2)) {\r\ntempbx &= ~(SetCRT2ToRAMDAC);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntemp = SetCRT2ToSVIDEO |\r\nSetCRT2ToAVIDEO |\r\nSetCRT2ToSCART |\r\nSetCRT2ToLCDA |\r\nSetCRT2ToLCD |\r\nSetCRT2ToRAMDAC |\r\nSetCRT2ToHiVision |\r\nSetCRT2ToYPbPr525750;\r\n} else {\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\ntemp = SetCRT2ToAVIDEO |\r\nSetCRT2ToSVIDEO |\r\nSetCRT2ToSCART |\r\nSetCRT2ToLCDA |\r\nSetCRT2ToLCD |\r\nSetCRT2ToCHYPbPr;\r\n} else {\r\ntemp = SetCRT2ToLCDA |\r\nSetCRT2ToLCD;\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\ntemp = SetCRT2ToTV | SetCRT2ToLCD;\r\n} else {\r\ntemp = SetCRT2ToLCD;\r\n}\r\n}\r\n}\r\nif(!(tempbx & temp)) {\r\ntempax = DisableCRT2Display;\r\ntempbx = 0;\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nunsigned short clearmask = ( DriverMode |\r\nDisableCRT2Display |\r\nLoadDACFlag |\r\nSetNotSimuMode |\r\nSetInSlaveMode |\r\nSetPALTV |\r\nSwitchCRT2 |\r\nSetSimuScanMode );\r\nif(tempbx & SetCRT2ToLCDA) tempbx &= (clearmask | SetCRT2ToLCDA);\r\nif(tempbx & SetCRT2ToRAMDAC) tempbx &= (clearmask | SetCRT2ToRAMDAC);\r\nif(tempbx & SetCRT2ToLCD) tempbx &= (clearmask | SetCRT2ToLCD);\r\nif(tempbx & SetCRT2ToSCART) tempbx &= (clearmask | SetCRT2ToSCART);\r\nif(tempbx & SetCRT2ToHiVision) tempbx &= (clearmask | SetCRT2ToHiVision);\r\nif(tempbx & SetCRT2ToYPbPr525750) tempbx &= (clearmask | SetCRT2ToYPbPr525750);\r\n} else {\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(tempbx & SetCRT2ToLCDA) {\r\ntempbx &= (0xFF00|SwitchCRT2|SetSimuScanMode);\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(tempbx & SetCRT2ToTV) {\r\ntempbx &= (0xFF00|SetCRT2ToTV|SwitchCRT2|SetSimuScanMode);\r\n}\r\n}\r\nif(tempbx & SetCRT2ToLCD) {\r\ntempbx &= (0xFF00|SetCRT2ToLCD|SwitchCRT2|SetSimuScanMode);\r\n}\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(tempbx & SetCRT2ToLCDA) {\r\ntempbx |= SetCRT2ToLCD;\r\n}\r\n}\r\n}\r\nif(tempax & DisableCRT2Display) {\r\nif(!(tempbx & (SwitchCRT2 | SetSimuScanMode))) {\r\ntempbx = SetSimuScanMode | DisableCRT2Display;\r\n}\r\n}\r\nif(!(tempbx & DriverMode)) tempbx |= SetSimuScanMode;\r\nif(SiS_Pr->SiS_ModeType <= ModeVGA) {\r\nif( (SiS_Pr->SiS_IF_DEF_LVDS == 1) ||\r\n((SiS_Pr->SiS_VBType & VB_NoLCD) && (tempbx & SetCRT2ToLCD)) ) {\r\nmodeflag &= (~CRT2Mode);\r\n}\r\n}\r\nif(!(tempbx & SetSimuScanMode)) {\r\nif(tempbx & SwitchCRT2) {\r\nif((!(modeflag & CRT2Mode)) && (checkcrt2mode)) {\r\nif(resinfo != SIS_RI_1600x1200) {\r\ntempbx |= SetSimuScanMode;\r\n}\r\n}\r\n} else {\r\nif(SiS_BridgeIsEnabled(SiS_Pr)) {\r\nif(!(tempbx & DriverMode)) {\r\nif(SiS_BridgeInSlavemode(SiS_Pr)) {\r\ntempbx |= SetSimuScanMode;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nif(!(tempbx & DisableCRT2Display)) {\r\nif(tempbx & DriverMode) {\r\nif(tempbx & SetSimuScanMode) {\r\nif((!(modeflag & CRT2Mode)) && (checkcrt2mode)) {\r\nif(resinfo != SIS_RI_1600x1200) {\r\ntempbx |= SetInSlaveMode;\r\n}\r\n}\r\n}\r\n} else {\r\ntempbx |= SetInSlaveMode;\r\n}\r\n}\r\n}\r\nSiS_Pr->SiS_VBInfo = tempbx;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->ChipType == SIS_630) {\r\nSiS_SetChrontelGPIO(SiS_Pr, SiS_Pr->SiS_VBInfo);\r\n}\r\n#endif\r\n#if 0\r\nprintk(KERN_DEBUG "sisfb: (init301: VBInfo= 0x%04x, SetFlag=0x%04x)\n",\r\nSiS_Pr->SiS_VBInfo, SiS_Pr->SiS_SetFlag);\r\n#endif\r\n}\r\nvoid\r\nSiS_SetYPbPr(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char temp;\r\nSiS_Pr->SiS_YPbPr = 0;\r\nif(SiS_Pr->ChipType >= SIS_661) return;\r\nif(SiS_Pr->SiS_VBType) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nSiS_Pr->SiS_YPbPr = YPbPrHiVision;\r\n}\r\n}\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBType & VB_SISYPBPR) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif(temp & 0x08) {\r\nswitch((temp >> 4)) {\r\ncase 0x00: SiS_Pr->SiS_YPbPr = YPbPr525i; break;\r\ncase 0x01: SiS_Pr->SiS_YPbPr = YPbPr525p; break;\r\ncase 0x02: SiS_Pr->SiS_YPbPr = YPbPr750p; break;\r\ncase 0x03: SiS_Pr->SiS_YPbPr = YPbPrHiVision; break;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nvoid\r\nSiS_SetTVMode(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short temp, temp1, resinfo = 0, romindex = 0;\r\nunsigned char OutputSelect = *SiS_Pr->pSiS_OutputSelect;\r\nSiS_Pr->SiS_TVMode = 0;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) return;\r\nif(SiS_Pr->UseCustomMode) return;\r\nif(ModeNo > 0x13) {\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n}\r\nif(SiS_Pr->ChipType < SIS_661) {\r\nif(SiS_Pr->SiS_VBInfo & SetPALTV) SiS_Pr->SiS_TVMode |= TVSetPAL;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntemp = 0;\r\nif((SiS_Pr->ChipType == SIS_630) ||\r\n(SiS_Pr->ChipType == SIS_730)) {\r\ntemp = 0x35;\r\nromindex = 0xfe;\r\n} else if(SiS_Pr->ChipType >= SIS_315H) {\r\ntemp = 0x38;\r\nif(SiS_Pr->ChipType < XGI_20) {\r\nromindex = 0xf3;\r\nif(SiS_Pr->ChipType >= SIS_330) romindex = 0x11b;\r\n}\r\n}\r\nif(temp) {\r\nif(romindex && SiS_Pr->SiS_UseROM && (!(SiS_Pr->SiS_ROMNew))) {\r\nOutputSelect = ROMAddr[romindex];\r\nif(!(OutputSelect & EnablePALMN)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3d4,temp,0x3F);\r\n}\r\n}\r\ntemp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,temp);\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nif(temp1 & EnablePALM) {\r\nSiS_Pr->SiS_TVMode |= TVSetPALM;\r\nSiS_Pr->SiS_TVMode &= ~TVSetPAL;\r\n} else if(temp1 & EnablePALN) {\r\nSiS_Pr->SiS_TVMode |= TVSetPALN;\r\n}\r\n} else {\r\nif(temp1 & EnableNTSCJ) {\r\nSiS_Pr->SiS_TVMode |= TVSetNTSCJ;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif(SiS_Pr->SiS_YPbPr == YPbPr750p) SiS_Pr->SiS_TVMode |= TVSetYPbPr750p;\r\nelse if(SiS_Pr->SiS_YPbPr == YPbPr525p) SiS_Pr->SiS_TVMode |= TVSetYPbPr525p;\r\nelse if(SiS_Pr->SiS_YPbPr == YPbPrHiVision) SiS_Pr->SiS_TVMode |= TVSetHiVision;\r\nelse SiS_Pr->SiS_TVMode |= TVSetYPbPr525i;\r\nif(SiS_Pr->SiS_TVMode & (TVSetYPbPr750p | TVSetYPbPr525p | TVSetYPbPr525i)) {\r\nSiS_Pr->SiS_VBInfo &= ~SetCRT2ToHiVision;\r\nSiS_Pr->SiS_VBInfo |= SetCRT2ToYPbPr525750;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetHiVision) {\r\nSiS_Pr->SiS_TVMode |= TVSetPAL;\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->SiS_CHOverScan) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x35);\r\nif((temp & TVOverScan) || (SiS_Pr->SiS_CHOverScan == 1)) {\r\nSiS_Pr->SiS_TVMode |= TVSetCHOverScan;\r\n}\r\n} else if(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x79);\r\nif((temp & 0x80) || (SiS_Pr->SiS_CHOverScan == 1)) {\r\nSiS_Pr->SiS_TVMode |= TVSetCHOverScan;\r\n}\r\n}\r\nif(SiS_Pr->SiS_CHSOverScan) {\r\nSiS_Pr->SiS_TVMode |= TVSetCHOverScan;\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x38);\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nif(temp & EnablePALM) SiS_Pr->SiS_TVMode |= TVSetPALM;\r\nelse if(temp & EnablePALN) SiS_Pr->SiS_TVMode |= TVSetPALN;\r\n} else {\r\nif(temp & EnableNTSCJ) {\r\nSiS_Pr->SiS_TVMode |= TVSetNTSCJ;\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\ntemp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x35);\r\nif(temp1 & 0x01) {\r\nSiS_Pr->SiS_TVMode |= TVSetPAL;\r\nif(temp1 & 0x08) {\r\nSiS_Pr->SiS_TVMode |= TVSetPALN;\r\n} else if(temp1 & 0x04) {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nSiS_Pr->SiS_TVMode &= ~TVSetPAL;\r\n}\r\nSiS_Pr->SiS_TVMode |= TVSetPALM;\r\n}\r\n} else {\r\nif(temp1 & 0x02) {\r\nSiS_Pr->SiS_TVMode |= TVSetNTSCJ;\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(SiS_Pr->SiS_CHOverScan) {\r\nif((temp1 & 0x10) || (SiS_Pr->SiS_CHOverScan == 1)) {\r\nSiS_Pr->SiS_TVMode |= TVSetCHOverScan;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\ntemp1 &= 0xe0;\r\nif(temp1 == 0x00) SiS_Pr->SiS_TVMode |= TVSetYPbPr525i;\r\nelse if(temp1 == 0x20) SiS_Pr->SiS_TVMode |= TVSetYPbPr525p;\r\nelse if(temp1 == 0x40) SiS_Pr->SiS_TVMode |= TVSetYPbPr750p;\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nSiS_Pr->SiS_TVMode |= (TVSetHiVision | TVSetPAL);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToYPbPr525750 | SetCRT2ToHiVision)) {\r\nif(resinfo == SIS_RI_800x480 || resinfo == SIS_RI_1024x576 || resinfo == SIS_RI_1280x720) {\r\nSiS_Pr->SiS_TVMode |= TVAspect169;\r\n} else {\r\ntemp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x39);\r\nif(temp1 & 0x02) {\r\nif(SiS_Pr->SiS_TVMode & (TVSetYPbPr750p | TVSetHiVision)) {\r\nSiS_Pr->SiS_TVMode |= TVAspect169;\r\n} else {\r\nSiS_Pr->SiS_TVMode |= TVAspect43LB;\r\n}\r\n} else {\r\nSiS_Pr->SiS_TVMode |= TVAspect43;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToSCART) SiS_Pr->SiS_TVMode |= TVSetPAL;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nSiS_Pr->SiS_TVMode |= TVSetPAL;\r\nSiS_Pr->SiS_TVMode &= ~(TVSetPALM | TVSetPALN | TVSetNTSCJ);\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & (TVSetYPbPr525i | TVSetYPbPr525p | TVSetYPbPr750p)) {\r\nSiS_Pr->SiS_TVMode &= ~(TVSetPAL | TVSetNTSCJ | TVSetPALM | TVSetPALN);\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetNotSimuMode)) {\r\nSiS_Pr->SiS_TVMode |= TVSetTVSimuMode;\r\n}\r\n}\r\nif(!(SiS_Pr->SiS_TVMode & TVSetPAL)) {\r\nif(resinfo == SIS_RI_1024x768) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) {\r\nSiS_Pr->SiS_TVMode |= TVSet525p1024;\r\n} else if(!(SiS_Pr->SiS_TVMode & (TVSetHiVision | TVSetYPbPr750p))) {\r\nSiS_Pr->SiS_TVMode |= TVSetNTSC1024;\r\n}\r\n}\r\n}\r\nSiS_Pr->SiS_TVMode |= TVRPLLDIV2XO;\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) &&\r\n(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nSiS_Pr->SiS_TVMode &= ~TVRPLLDIV2XO;\r\n} else if(SiS_Pr->SiS_TVMode & (TVSetYPbPr525p | TVSetYPbPr750p)) {\r\nSiS_Pr->SiS_TVMode &= ~TVRPLLDIV2XO;\r\n} else if(!(SiS_Pr->SiS_VBType & VB_SIS30xBLV)) {\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) {\r\nSiS_Pr->SiS_TVMode &= ~TVRPLLDIV2XO;\r\n}\r\n}\r\n}\r\nSiS_Pr->SiS_VBInfo &= ~SetPALTV;\r\n}\r\nstatic unsigned short\r\nSiS_GetBIOSLCDResInfo(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp = SiS_Pr->SiS_LCDResInfo;\r\nswitch(temp) {\r\ncase Panel_1280x768_2: temp = Panel_1280x768; break;\r\ncase Panel_1280x800_2: temp = Panel_1280x800; break;\r\ncase Panel_1280x854: temp = Panel661_1280x854; break;\r\n}\r\nreturn temp;\r\n}\r\nstatic void\r\nSiS_GetLCDInfoBIOS(struct SiS_Private *SiS_Pr)\r\n{\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned char *ROMAddr;\r\nunsigned short temp;\r\nif((ROMAddr = GetLCDStructPtr661(SiS_Pr))) {\r\nif((temp = SISGETROMW(6)) != SiS_Pr->PanelHT) {\r\nSiS_Pr->SiS_NeedRomModeData = true;\r\nSiS_Pr->PanelHT = temp;\r\n}\r\nif((temp = SISGETROMW(8)) != SiS_Pr->PanelVT) {\r\nSiS_Pr->SiS_NeedRomModeData = true;\r\nSiS_Pr->PanelVT = temp;\r\n}\r\nSiS_Pr->PanelHRS = SISGETROMW(10);\r\nSiS_Pr->PanelHRE = SISGETROMW(12);\r\nSiS_Pr->PanelVRS = SISGETROMW(14);\r\nSiS_Pr->PanelVRE = SISGETROMW(16);\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_CUSTOM_315;\r\nSiS_Pr->SiS_VCLKData[VCLK_CUSTOM_315].CLOCK =\r\nSiS_Pr->SiS_VBVCLKData[VCLK_CUSTOM_315].CLOCK = (unsigned short)((unsigned char)ROMAddr[18]);\r\nSiS_Pr->SiS_VCLKData[VCLK_CUSTOM_315].SR2B =\r\nSiS_Pr->SiS_VBVCLKData[VCLK_CUSTOM_315].Part4_A = ROMAddr[19];\r\nSiS_Pr->SiS_VCLKData[VCLK_CUSTOM_315].SR2C =\r\nSiS_Pr->SiS_VBVCLKData[VCLK_CUSTOM_315].Part4_B = ROMAddr[20];\r\n}\r\n#endif\r\n}\r\nstatic void\r\nSiS_CheckScaling(struct SiS_Private *SiS_Pr, unsigned short resinfo,\r\nconst unsigned char *nonscalingmodes)\r\n{\r\nint i = 0;\r\nwhile(nonscalingmodes[i] != 0xff) {\r\nif(nonscalingmodes[i++] == resinfo) {\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) ||\r\n(SiS_Pr->UsePanelScaler == -1)) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nvoid\r\nSiS_GetLCDResInfo(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short temp,modeflag,resinfo=0,modexres=0,modeyres=0;\r\nbool panelcanscale = false;\r\n#ifdef CONFIG_FB_SIS_300\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nstatic const unsigned char SiS300SeriesLCDRes[] =\r\n{ 0, 1, 2, 3, 7, 4, 5, 8,\r\n0, 0, 10, 0, 0, 0, 0, 15 };\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned char *myptr = NULL;\r\n#endif\r\nSiS_Pr->SiS_LCDResInfo = 0;\r\nSiS_Pr->SiS_LCDTypeInfo = 0;\r\nSiS_Pr->SiS_LCDInfo = 0;\r\nSiS_Pr->PanelHRS = 999;\r\nSiS_Pr->PanelHRE = 999;\r\nSiS_Pr->PanelVRS = 999;\r\nSiS_Pr->PanelVRE = 999;\r\nSiS_Pr->SiS_NeedRomModeData = false;\r\nSiS_Pr->Alternate1600x1200 = false;\r\nif(!(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA))) return;\r\nmodeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\r\nif((ModeNo > 0x13) && (!SiS_Pr->UseCustomMode)) {\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nmodexres = SiS_Pr->SiS_ModeResInfo[resinfo].HTotal;\r\nmodeyres = SiS_Pr->SiS_ModeResInfo[resinfo].VTotal;\r\n}\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36);\r\nif(temp == 0) temp = 0x02;\r\nif((SiS_Pr->ChipType >= SIS_661) || (SiS_Pr->SiS_ROMNew)) {\r\nSiS_Pr->SiS_LCDTypeInfo = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x39) & 0x7c) >> 2;\r\n} else if((SiS_Pr->ChipType < SIS_315H) || (SiS_Pr->ChipType >= SIS_661)) {\r\nSiS_Pr->SiS_LCDTypeInfo = temp >> 4;\r\n} else {\r\nSiS_Pr->SiS_LCDTypeInfo = (temp & 0x0F) - 1;\r\n}\r\ntemp &= 0x0f;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nif(temp < 0x0f) temp &= 0x07;\r\n}\r\ntemp = SiS300SeriesLCDRes[temp];\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType == SIS_550) {\r\nif (temp == Panel310_1152x768) temp = Panel_320x240_2;\r\nelse if(temp == Panel310_320x240_2) temp = Panel_320x240_2;\r\nelse if(temp == Panel310_320x240_3) temp = Panel_320x240_3;\r\n} else if(SiS_Pr->ChipType >= SIS_661) {\r\nif(temp == Panel661_1280x854) temp = Panel_1280x854;\r\n}\r\n#endif\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(temp == Panel310_1280x768) {\r\ntemp = Panel_1280x768_2;\r\n}\r\nif(SiS_Pr->SiS_ROMNew) {\r\nif(temp == Panel661_1280x800) {\r\ntemp = Panel_1280x800_2;\r\n}\r\n}\r\n}\r\nSiS_Pr->SiS_LCDResInfo = temp;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1366) {\r\nSiS_Pr->SiS_LCDResInfo = Panel_Barco1366;\r\n} else if(SiS_Pr->SiS_CustomT == CUT_PANEL848) {\r\nSiS_Pr->SiS_LCDResInfo = Panel_848x480;\r\n} else if(SiS_Pr->SiS_CustomT == CUT_PANEL856) {\r\nSiS_Pr->SiS_LCDResInfo = Panel_856x480;\r\n}\r\n}\r\n#endif\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_LCDResInfo < SiS_Pr->SiS_PanelMin301)\r\nSiS_Pr->SiS_LCDResInfo = SiS_Pr->SiS_PanelMin301;\r\n} else {\r\nif(SiS_Pr->SiS_LCDResInfo < SiS_Pr->SiS_PanelMinLVDS)\r\nSiS_Pr->SiS_LCDResInfo = SiS_Pr->SiS_PanelMinLVDS;\r\n}\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x37);\r\nSiS_Pr->SiS_LCDInfo = temp & ~0x000e;\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_320x240_1:\r\ncase Panel_320x240_2:\r\ncase Panel_320x240_3:\r\ncase Panel_1280x960:\r\nSiS_Pr->SiS_LCDInfo &= ~DontExpandLCD;\r\nbreak;\r\ncase Panel_640x480:\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\npanelcanscale = (bool)(SiS_Pr->SiS_LCDInfo & DontExpandLCD);\r\nif(!SiS_Pr->UsePanelScaler) SiS_Pr->SiS_LCDInfo &= ~DontExpandLCD;\r\nelse if(SiS_Pr->UsePanelScaler == 1) SiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(temp & 0x08) SiS_Pr->SiS_LCDInfo |= LCDPass11;\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISDUALLINK) {\r\nif(SiS_Pr->SiS_ROMNew) {\r\nif(temp & 0x02) SiS_Pr->SiS_LCDInfo |= LCDDualLink;\r\n} else if((myptr = GetLCDStructPtr661(SiS_Pr))) {\r\nif(myptr[2] & 0x01) SiS_Pr->SiS_LCDInfo |= LCDDualLink;\r\n}\r\n}\r\n} else if(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x39) & 0x01) SiS_Pr->SiS_LCDInfo |= LCDPass11;\r\n}\r\nif((SiS_Pr->SiS_ROMNew) && (!(SiS_Pr->PanelSelfDetected))) {\r\nSiS_Pr->SiS_LCDInfo &= ~(LCDRGB18Bit);\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x35);\r\nif(temp & 0x01) SiS_Pr->SiS_LCDInfo |= LCDRGB18Bit;\r\nif(SiS_Pr->SiS_VBType & VB_SISDUALLINK) {\r\nif(temp & 0x02) SiS_Pr->SiS_LCDInfo |= LCDDualLink;\r\n}\r\n} else if(!(SiS_Pr->SiS_ROMNew)) {\r\nif(SiS_Pr->SiS_VBType & VB_SISDUALLINK) {\r\nif((SiS_Pr->SiS_CustomT == CUT_CLEVO1024) &&\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1024x768)) {\r\nSiS_Pr->SiS_LCDInfo |= LCDDualLink;\r\n}\r\nif((SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1680x1050)) {\r\nSiS_Pr->SiS_LCDInfo |= LCDDualLink;\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\nif((SiS_Pr->SiS_IF_DEF_LVDS == 1) || (SiS_Pr->SiS_VBType & VB_NoLCD)) {\r\nSiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\n} else {\r\nif(panelcanscale) SiS_Pr->SiS_LCDInfo |= LCDPass11;\r\nif(SiS_Pr->CenterScreen == 1) SiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\n}\r\n}\r\nSiS_Pr->PanelVCLKIdx300 = VCLK65_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK108_2_315;\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_320x240_1:\r\ncase Panel_320x240_2:\r\ncase Panel_320x240_3: SiS_Pr->PanelXRes = 640; SiS_Pr->PanelYRes = 480;\r\nSiS_Pr->PanelVRS = 24; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK28;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK28;\r\nbreak;\r\ncase Panel_640x480: SiS_Pr->PanelXRes = 640; SiS_Pr->PanelYRes = 480;\r\nSiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK28;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK28;\r\nbreak;\r\ncase Panel_800x600: SiS_Pr->PanelXRes = 800; SiS_Pr->PanelYRes = 600;\r\nSiS_Pr->PanelHT = 1056; SiS_Pr->PanelVT = 628;\r\nSiS_Pr->PanelHRS = 40; SiS_Pr->PanelHRE = 128;\r\nSiS_Pr->PanelVRS = 1; SiS_Pr->PanelVRE = 4;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK40;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK40;\r\nbreak;\r\ncase Panel_1024x600: SiS_Pr->PanelXRes = 1024; SiS_Pr->PanelYRes = 600;\r\nSiS_Pr->PanelHT = 1344; SiS_Pr->PanelVT = 800;\r\nSiS_Pr->PanelHRS = 24; SiS_Pr->PanelHRE = 136;\r\nSiS_Pr->PanelVRS = 2 ; SiS_Pr->PanelVRE = 6;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK65_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK65_315;\r\nbreak;\r\ncase Panel_1024x768: SiS_Pr->PanelXRes = 1024; SiS_Pr->PanelYRes = 768;\r\nSiS_Pr->PanelHT = 1344; SiS_Pr->PanelVT = 806;\r\nSiS_Pr->PanelHRS = 24; SiS_Pr->PanelHRE = 136;\r\nSiS_Pr->PanelVRS = 3; SiS_Pr->PanelVRE = 6;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nSiS_Pr->PanelHRS = 23;\r\nSiS_Pr->PanelVRE = 5;\r\n}\r\nSiS_Pr->PanelVCLKIdx300 = VCLK65_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK65_315;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1152x768: SiS_Pr->PanelXRes = 1152; SiS_Pr->PanelYRes = 768;\r\nSiS_Pr->PanelHT = 1344; SiS_Pr->PanelVT = 806;\r\nSiS_Pr->PanelHRS = 24; SiS_Pr->PanelHRE = 136;\r\nSiS_Pr->PanelVRS = 3; SiS_Pr->PanelVRE = 6;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nSiS_Pr->PanelHRS = 23;\r\nSiS_Pr->PanelVRE = 5;\r\n}\r\nSiS_Pr->PanelVCLKIdx300 = VCLK65_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK65_315;\r\nbreak;\r\ncase Panel_1152x864: SiS_Pr->PanelXRes = 1152; SiS_Pr->PanelYRes = 864;\r\nbreak;\r\ncase Panel_1280x720: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 720;\r\nSiS_Pr->PanelHT = 1650; SiS_Pr->PanelVT = 750;\r\nSiS_Pr->PanelHRS = 110; SiS_Pr->PanelHRE = 40;\r\nSiS_Pr->PanelVRS = 5; SiS_Pr->PanelVRE = 5;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_1280x720;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1280x768: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 768;\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nSiS_Pr->PanelHT = 1408; SiS_Pr->PanelVT = 806;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK81_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK81_315;\r\n} else {\r\nSiS_Pr->PanelHT = 1688; SiS_Pr->PanelVT = 802;\r\nSiS_Pr->PanelHRS = 48; SiS_Pr->PanelHRS = 112;\r\nSiS_Pr->PanelVRS = 3; SiS_Pr->PanelVRE = 6;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK81_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK81_315;\r\n}\r\nbreak;\r\ncase Panel_1280x768_2: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 768;\r\nSiS_Pr->PanelHT = 1660; SiS_Pr->PanelVT = 806;\r\nSiS_Pr->PanelHRS = 48; SiS_Pr->PanelHRE = 112;\r\nSiS_Pr->PanelVRS = 3; SiS_Pr->PanelVRE = 6;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_1280x768_2;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1280x800: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 800;\r\nSiS_Pr->PanelHT = 1408; SiS_Pr->PanelVT = 816;\r\nSiS_Pr->PanelHRS = 21; SiS_Pr->PanelHRE = 24;\r\nSiS_Pr->PanelVRS = 4; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_1280x800_315;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1280x800_2: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 800;\r\nSiS_Pr->PanelHT = 1552; SiS_Pr->PanelVT = 812;\r\nSiS_Pr->PanelHRS = 48; SiS_Pr->PanelHRE = 112;\r\nSiS_Pr->PanelVRS = 4; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_1280x800_315_2;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1280x854: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 854;\r\nSiS_Pr->PanelHT = 1664; SiS_Pr->PanelVT = 861;\r\nSiS_Pr->PanelHRS = 16; SiS_Pr->PanelHRE = 112;\r\nSiS_Pr->PanelVRS = 1; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_1280x854;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1280x960: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 960;\r\nSiS_Pr->PanelHT = 1800; SiS_Pr->PanelVT = 1000;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK108_3_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK108_3_315;\r\nif(resinfo == SIS_RI_1280x1024) {\r\nSiS_Pr->PanelVCLKIdx300 = VCLK100_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK100_315;\r\n}\r\nbreak;\r\ncase Panel_1280x1024: SiS_Pr->PanelXRes = 1280; SiS_Pr->PanelYRes = 1024;\r\nSiS_Pr->PanelHT = 1688; SiS_Pr->PanelVT = 1066;\r\nSiS_Pr->PanelHRS = 48; SiS_Pr->PanelHRE = 112;\r\nSiS_Pr->PanelVRS = 1; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK108_3_300;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK108_2_315;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1400x1050: SiS_Pr->PanelXRes = 1400; SiS_Pr->PanelYRes = 1050;\r\nSiS_Pr->PanelHT = 1688; SiS_Pr->PanelVT = 1066;\r\nSiS_Pr->PanelHRS = 48; SiS_Pr->PanelHRE = 112;\r\nSiS_Pr->PanelVRS = 1; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK108_2_315;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1600x1200: SiS_Pr->PanelXRes = 1600; SiS_Pr->PanelYRes = 1200;\r\nSiS_Pr->PanelHT = 2160; SiS_Pr->PanelVT = 1250;\r\nSiS_Pr->PanelHRS = 64; SiS_Pr->PanelHRE = 192;\r\nSiS_Pr->PanelVRS = 1; SiS_Pr->PanelVRE = 3;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK162_315;\r\nif(SiS_Pr->SiS_VBType & VB_SISTMDSLCDA) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_Pr->PanelHT = 1760; SiS_Pr->PanelVT = 1235;\r\nSiS_Pr->PanelHRS = 48; SiS_Pr->PanelHRE = 32;\r\nSiS_Pr->PanelVRS = 2; SiS_Pr->PanelVRE = 4;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK130_315;\r\nSiS_Pr->Alternate1600x1200 = true;\r\n}\r\n} else if(SiS_Pr->SiS_IF_DEF_LVDS) {\r\nSiS_Pr->PanelHT = 2048; SiS_Pr->PanelVT = 1320;\r\nSiS_Pr->PanelHRS = SiS_Pr->PanelHRE = 999;\r\nSiS_Pr->PanelVRS = SiS_Pr->PanelVRE = 999;\r\n}\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_1680x1050: SiS_Pr->PanelXRes = 1680; SiS_Pr->PanelYRes = 1050;\r\nSiS_Pr->PanelHT = 1900; SiS_Pr->PanelVT = 1066;\r\nSiS_Pr->PanelHRS = 26; SiS_Pr->PanelHRE = 76;\r\nSiS_Pr->PanelVRS = 3; SiS_Pr->PanelVRE = 6;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK121_315;\r\nSiS_GetLCDInfoBIOS(SiS_Pr);\r\nbreak;\r\ncase Panel_Barco1366: SiS_Pr->PanelXRes = 1360; SiS_Pr->PanelYRes = 1024;\r\nSiS_Pr->PanelHT = 1688; SiS_Pr->PanelVT = 1066;\r\nbreak;\r\ncase Panel_848x480: SiS_Pr->PanelXRes = 848; SiS_Pr->PanelYRes = 480;\r\nSiS_Pr->PanelHT = 1088; SiS_Pr->PanelVT = 525;\r\nbreak;\r\ncase Panel_856x480: SiS_Pr->PanelXRes = 856; SiS_Pr->PanelYRes = 480;\r\nSiS_Pr->PanelHT = 1088; SiS_Pr->PanelVT = 525;\r\nbreak;\r\ncase Panel_Custom: SiS_Pr->PanelXRes = SiS_Pr->CP_MaxX;\r\nSiS_Pr->PanelYRes = SiS_Pr->CP_MaxY;\r\nSiS_Pr->PanelHT = SiS_Pr->CHTotal;\r\nSiS_Pr->PanelVT = SiS_Pr->CVTotal;\r\nif(SiS_Pr->CP_PreferredIndex != -1) {\r\nSiS_Pr->PanelXRes = SiS_Pr->CP_HDisplay[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelYRes = SiS_Pr->CP_VDisplay[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelHT = SiS_Pr->CP_HTotal[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelVT = SiS_Pr->CP_VTotal[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelHRS = SiS_Pr->CP_HSyncStart[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelHRE = SiS_Pr->CP_HSyncEnd[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelVRS = SiS_Pr->CP_VSyncStart[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelVRE = SiS_Pr->CP_VSyncEnd[SiS_Pr->CP_PreferredIndex];\r\nSiS_Pr->PanelHRS -= SiS_Pr->PanelXRes;\r\nSiS_Pr->PanelHRE -= SiS_Pr->PanelHRS;\r\nSiS_Pr->PanelVRS -= SiS_Pr->PanelYRes;\r\nSiS_Pr->PanelVRE -= SiS_Pr->PanelVRS;\r\nif(SiS_Pr->CP_PrefClock) {\r\nint idx;\r\nSiS_Pr->PanelVCLKIdx315 = VCLK_CUSTOM_315;\r\nSiS_Pr->PanelVCLKIdx300 = VCLK_CUSTOM_300;\r\nif(SiS_Pr->ChipType < SIS_315H) idx = VCLK_CUSTOM_300;\r\nelse idx = VCLK_CUSTOM_315;\r\nSiS_Pr->SiS_VCLKData[idx].CLOCK =\r\nSiS_Pr->SiS_VBVCLKData[idx].CLOCK = SiS_Pr->CP_PrefClock;\r\nSiS_Pr->SiS_VCLKData[idx].SR2B =\r\nSiS_Pr->SiS_VBVCLKData[idx].Part4_A = SiS_Pr->CP_PrefSR2B;\r\nSiS_Pr->SiS_VCLKData[idx].SR2C =\r\nSiS_Pr->SiS_VBVCLKData[idx].Part4_B = SiS_Pr->CP_PrefSR2C;\r\n}\r\n}\r\nbreak;\r\ndefault: SiS_Pr->PanelXRes = 1024; SiS_Pr->PanelYRes = 768;\r\nSiS_Pr->PanelHT = 1344; SiS_Pr->PanelVT = 806;\r\nbreak;\r\n}\r\nif( (SiS_Pr->SiS_IF_DEF_FSTN) ||\r\n(SiS_Pr->SiS_IF_DEF_DSTN) ||\r\n(SiS_Pr->SiS_CustomT == CUT_BARCO1366) ||\r\n(SiS_Pr->SiS_CustomT == CUT_BARCO1024) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL848) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL856) ) {\r\nSiS_Pr->PanelHRS = 999;\r\nSiS_Pr->PanelHRE = 999;\r\n}\r\nif( (SiS_Pr->SiS_CustomT == CUT_BARCO1366) ||\r\n(SiS_Pr->SiS_CustomT == CUT_BARCO1024) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL848) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL856) ) {\r\nSiS_Pr->PanelVRS = 999;\r\nSiS_Pr->PanelVRE = 999;\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SISVB) && (!(SiS_Pr->SiS_VBType & VB_NoLCD))) {\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) && (modeflag & NoSupportLCDScale)) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_Custom:\r\ncase Panel_1152x864:\r\ncase Panel_1280x768:\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\nbreak;\r\ncase Panel_800x600: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, 0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\ncase Panel_1024x768: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\n0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\ncase Panel_1280x720: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\n0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nif(SiS_Pr->PanelHT == 1650) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nbreak;\r\n}\r\ncase Panel_1280x768_2: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nswitch(resinfo) {\r\ncase SIS_RI_1280x720: if(SiS_Pr->UsePanelScaler == -1) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase Panel_1280x800: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,SIS_RI_1280x720,SIS_RI_1280x768,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\ncase Panel_1280x800_2: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nswitch(resinfo) {\r\ncase SIS_RI_1280x720:\r\ncase SIS_RI_1280x768: if(SiS_Pr->UsePanelScaler == -1) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase Panel_1280x854: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nswitch(resinfo) {\r\ncase SIS_RI_1280x720:\r\ncase SIS_RI_1280x768:\r\ncase SIS_RI_1280x800: if(SiS_Pr->UsePanelScaler == -1) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase Panel_1280x960: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,SIS_RI_1152x864,SIS_RI_1280x720,SIS_RI_1280x768,SIS_RI_1280x800,\r\nSIS_RI_1280x854,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\ncase Panel_1280x1024: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,SIS_RI_1152x864,SIS_RI_1280x720,SIS_RI_1280x768,SIS_RI_1280x800,\r\nSIS_RI_1280x854,SIS_RI_1280x960,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\ncase Panel_1400x1050: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,SIS_RI_1152x864,SIS_RI_1280x768,SIS_RI_1280x800,SIS_RI_1280x854,\r\nSIS_RI_1280x960,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nswitch(resinfo) {\r\ncase SIS_RI_1280x720: if(SiS_Pr->UsePanelScaler == -1) {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\n}\r\nbreak;\r\ncase SIS_RI_1280x1024: SiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\ncase Panel_1600x1200: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,SIS_RI_1152x864,SIS_RI_1280x720,SIS_RI_1280x768,SIS_RI_1280x800,\r\nSIS_RI_1280x854,SIS_RI_1280x960,SIS_RI_1360x768,SIS_RI_1360x1024,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\ncase Panel_1680x1050: {\r\nstatic const unsigned char nonscalingmodes[] = {\r\nSIS_RI_720x480, SIS_RI_720x576, SIS_RI_768x576, SIS_RI_800x480, SIS_RI_848x480,\r\nSIS_RI_856x480, SIS_RI_960x540, SIS_RI_960x600, SIS_RI_1024x576,SIS_RI_1024x600,\r\nSIS_RI_1152x768,SIS_RI_1152x864,SIS_RI_1280x854,SIS_RI_1280x960,SIS_RI_1360x768,\r\nSIS_RI_1360x1024,0xff\r\n};\r\nSiS_CheckScaling(SiS_Pr, resinfo, nonscalingmodes);\r\nbreak;\r\n}\r\n}\r\n}\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(SiS_Pr->SiS_CustomT == CUT_PANEL848 || SiS_Pr->SiS_CustomT == CUT_PANEL856) {\r\nSiS_Pr->SiS_LCDInfo = 0x80 | 0x40 | 0x20;\r\n}\r\n}\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(SiS_Pr->SiS_UseROM) {\r\nif((ROMAddr[0x233] == 0x12) && (ROMAddr[0x234] == 0x34)) {\r\nif(!(ROMAddr[0x235] & 0x02)) {\r\nSiS_Pr->SiS_LCDInfo &= (~DontExpandLCD);\r\n}\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif((SiS_Pr->SiS_SetFlag & SetDOSMode) && ((ModeNo == 0x03) || (ModeNo == 0x10))) {\r\nSiS_Pr->SiS_LCDInfo &= (~DontExpandLCD);\r\n}\r\n}\r\n}\r\n#endif\r\nif(modexres == SiS_Pr->PanelXRes && modeyres == SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION) {\r\nSiS_Pr->SiS_LCDInfo |= (DontExpandLCD | LCDPass11);\r\n}\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_640x480:\r\nSiS_Pr->SiS_LCDInfo |= (DontExpandLCD | LCDPass11);\r\nbreak;\r\ncase Panel_1280x800:\r\nif(SiS_Pr->CenterScreen == -1) SiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\nbreak;\r\ncase Panel_1280x960:\r\nSiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\nbreak;\r\ncase Panel_Custom:\r\nif((!SiS_Pr->CP_PrefClock) ||\r\n(modexres > SiS_Pr->PanelXRes) || (modeyres > SiS_Pr->PanelYRes)) {\r\nSiS_Pr->SiS_LCDInfo |= LCDPass11;\r\n}\r\nbreak;\r\n}\r\nif((SiS_Pr->UseCustomMode) || (SiS_Pr->SiS_CustomT == CUT_UNKNOWNLCD)) {\r\nSiS_Pr->SiS_LCDInfo |= (DontExpandLCD | LCDPass11);\r\n}\r\nif(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\nSiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\n}\r\nif(!((SiS_Pr->ChipType < SIS_315H) && (SiS_Pr->SiS_SetFlag & SetDOSMode))) {\r\nif((SiS_Pr->SiS_IF_DEF_LVDS == 1) || (SiS_Pr->SiS_VBType & VB_NoLCD)) {\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION == 0) {\r\nif(ModeNo == 0x12) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) {\r\nSiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n}\r\n} else if(ModeNo > 0x13) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x600) {\r\nif(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\nif((resinfo == SIS_RI_800x600) || (resinfo == SIS_RI_400x300)) {\r\nSiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nif(modeflag & HalfDCLK) {\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION == 1) {\r\nSiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n} else if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nSiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n} else if(SiS_Pr->SiS_LCDResInfo == Panel_640x480) {\r\nSiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n} else if(ModeNo > 0x13) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(resinfo == SIS_RI_512x384) SiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n} else if(SiS_Pr->SiS_LCDResInfo == Panel_800x600) {\r\nif(resinfo == SIS_RI_400x300) SiS_Pr->SiS_SetFlag |= EnableLVDSDDA;\r\n}\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(SiS_Pr->SiS_VBInfo & SetNotSimuMode) {\r\nSiS_Pr->SiS_SetFlag |= LCDVESATiming;\r\n}\r\n} else {\r\nSiS_Pr->SiS_SetFlag |= LCDVESATiming;\r\n}\r\n#if 0\r\nprintk(KERN_DEBUG "sisfb: (LCDInfo=0x%04x LCDResInfo=0x%02x LCDTypeInfo=0x%02x)\n",\r\nSiS_Pr->SiS_LCDInfo, SiS_Pr->SiS_LCDResInfo, SiS_Pr->SiS_LCDTypeInfo);\r\n#endif\r\n}\r\nunsigned short\r\nSiS_GetVCLK2Ptr(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short CRT2Index, VCLKIndex = 0, VCLKIndexGEN = 0, VCLKIndexGENCRT = 0;\r\nunsigned short modeflag, resinfo, tempbx;\r\nconst unsigned char *CHTVVCLKPtr = NULL;\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nresinfo = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo;\r\nCRT2Index = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\nVCLKIndexGEN = (SiS_GetRegByte((SiS_Pr->SiS_P3ca+0x02)) >> 2) & 0x03;\r\nVCLKIndexGENCRT = VCLKIndexGEN;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nCRT2Index = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\nVCLKIndexGEN = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRTVCLK;\r\nVCLKIndexGENCRT = SiS_GetRefCRTVCLK(SiS_Pr, RefreshRateTableIndex,\r\n(SiS_Pr->SiS_SetFlag & ProgrammingCRT2) ? SiS_Pr->SiS_UseWideCRT2 : SiS_Pr->SiS_UseWide);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_SetFlag & ProgrammingCRT2) {\r\nCRT2Index >>= 6;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nVCLKIndex = SiS_Pr->PanelVCLKIdx300;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nVCLKIndex = VCLKIndexGEN;\r\n}\r\n} else {\r\nVCLKIndex = SiS_Pr->PanelVCLKIdx315;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nswitch(resinfo) {\r\ncase SIS_RI_720x480: VCLKIndex = VCLK_720x480; break;\r\ncase SIS_RI_720x576: VCLKIndex = VCLK_720x576; break;\r\ncase SIS_RI_768x576: VCLKIndex = VCLK_768x576; break;\r\ncase SIS_RI_848x480: VCLKIndex = VCLK_848x480; break;\r\ncase SIS_RI_856x480: VCLKIndex = VCLK_856x480; break;\r\ncase SIS_RI_800x480: VCLKIndex = VCLK_800x480; break;\r\ncase SIS_RI_1024x576: VCLKIndex = VCLK_1024x576; break;\r\ncase SIS_RI_1152x864: VCLKIndex = VCLK_1152x864; break;\r\ncase SIS_RI_1280x720: VCLKIndex = VCLK_1280x720; break;\r\ncase SIS_RI_1360x768: VCLKIndex = VCLK_1360x768; break;\r\ndefault: VCLKIndex = VCLKIndexGEN;\r\n}\r\nif(ModeNo <= 0x13) {\r\nif(SiS_Pr->ChipType <= SIS_315PRO) {\r\nif(SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC == 1) VCLKIndex = 0x42;\r\n} else {\r\nif(SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC == 1) VCLKIndex = 0x00;\r\n}\r\n}\r\nif(SiS_Pr->ChipType <= SIS_315PRO) {\r\nif(VCLKIndex == 0) VCLKIndex = 0x41;\r\nif(VCLKIndex == 1) VCLKIndex = 0x43;\r\nif(VCLKIndex == 4) VCLKIndex = 0x44;\r\n}\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif(SiS_Pr->SiS_TVMode & TVRPLLDIV2XO) VCLKIndex = HiTVVCLKDIV2;\r\nelse VCLKIndex = HiTVVCLK;\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) VCLKIndex = HiTVSimuVCLK;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) VCLKIndex = YPbPr750pVCLK;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) VCLKIndex = TVVCLKDIV2;\r\nelse if(SiS_Pr->SiS_TVMode & TVRPLLDIV2XO) VCLKIndex = TVVCLKDIV2;\r\nelse VCLKIndex = TVVCLK;\r\nif(SiS_Pr->ChipType < SIS_315H) VCLKIndex += TVCLKBASE_300;\r\nelse VCLKIndex += TVCLKBASE_315;\r\n} else {\r\nVCLKIndex = VCLKIndexGENCRT;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(ModeNo > 0x13) {\r\nif( (SiS_Pr->ChipType == SIS_630) &&\r\n(SiS_Pr->ChipRevision >= 0x30)) {\r\nif(VCLKIndex == 0x14) VCLKIndex = 0x34;\r\n}\r\nif(VCLKIndex == 0x17) VCLKIndex = 0x45;\r\n}\r\n}\r\n}\r\n} else {\r\nVCLKIndex = VCLKIndexGENCRT;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(ModeNo > 0x13) {\r\nif( (SiS_Pr->ChipType != SIS_630) &&\r\n(SiS_Pr->ChipType != SIS_300) ) {\r\nif(VCLKIndex == 0x1b) VCLKIndex = 0x48;\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\nVCLKIndex = CRT2Index;\r\nif(SiS_Pr->SiS_SetFlag & ProgrammingCRT2) {\r\nif( (SiS_Pr->SiS_IF_DEF_CH70xx != 0) && (SiS_Pr->SiS_VBInfo & SetCRT2ToTV) ) {\r\nVCLKIndex &= 0x1f;\r\ntempbx = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) tempbx += 1;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\ntempbx += 2;\r\nif(SiS_Pr->SiS_ModeType > ModeVGA) {\r\nif(SiS_Pr->SiS_CHSOverScan) tempbx = 8;\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) {\r\ntempbx = 4;\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) tempbx += 1;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetPALN) {\r\ntempbx = 6;\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) tempbx += 1;\r\n}\r\n}\r\nswitch(tempbx) {\r\ncase 0: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKUNTSC; break;\r\ncase 1: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKONTSC; break;\r\ncase 2: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKUPAL; break;\r\ncase 3: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKOPAL; break;\r\ncase 4: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKUPALM; break;\r\ncase 5: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKOPALM; break;\r\ncase 6: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKUPALN; break;\r\ncase 7: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKOPALN; break;\r\ncase 8: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKSOPAL; break;\r\ndefault: CHTVVCLKPtr = SiS_Pr->SiS_CHTVVCLKOPAL; break;\r\n}\r\nVCLKIndex = CHTVVCLKPtr[VCLKIndex];\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nVCLKIndex = SiS_Pr->PanelVCLKIdx300;\r\n} else {\r\nVCLKIndex = SiS_Pr->PanelVCLKIdx315;\r\n}\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1366) VCLKIndex = 0x44;\r\nif(SiS_Pr->SiS_CustomT == CUT_PANEL848 || SiS_Pr->SiS_CustomT == CUT_PANEL856) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nVCLKIndex = VCLK34_300;\r\n} else {\r\nVCLKIndex = VCLK34_315;\r\n}\r\n}\r\n#endif\r\n} else {\r\nVCLKIndex = VCLKIndexGENCRT;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(ModeNo > 0x13) {\r\nif( (SiS_Pr->ChipType == SIS_630) &&\r\n(SiS_Pr->ChipRevision >= 0x30) ) {\r\nif(VCLKIndex == 0x14) VCLKIndex = 0x2e;\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\nVCLKIndex = VCLKIndexGENCRT;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(ModeNo > 0x13) {\r\nif( (SiS_Pr->ChipType != SIS_630) &&\r\n(SiS_Pr->ChipType != SIS_300) ) {\r\nif(VCLKIndex == 0x1b) VCLKIndex = 0x48;\r\n}\r\n#if 0\r\nif(SiS_Pr->ChipType == SIS_730) {\r\nif(VCLKIndex == 0x0b) VCLKIndex = 0x40;\r\nif(VCLKIndex == 0x0d) VCLKIndex = 0x41;\r\n}\r\n#endif\r\n}\r\n}\r\n}\r\n}\r\nreturn VCLKIndex;\r\n}\r\nstatic void\r\nSiS_SetCRT2ModeRegs(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short i, j, modeflag, tempah=0;\r\nshort tempcl;\r\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\r\nunsigned short tempbl;\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short tempah2, tempbl2;\r\n#endif\r\nmodeflag = SiS_GetModeFlag(SiS_Pr, ModeNo, ModeIdIndex);\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x00,0xAF,0x40);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2E,0xF7);\r\n} else {\r\nfor(i=0,j=4; i<3; i++,j++) SiS_SetReg(SiS_Pr->SiS_Part1Port,j,0);\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x02,0x7F);\r\n}\r\ntempcl = SiS_Pr->SiS_ModeType;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_VBType & VB_NoLCD) {\r\ntempbl = SiS_GetReg(SiS_Pr->SiS_P3c4,0x32);\r\ntempbl &= 0xef;\r\ntempbl |= 0x02;\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToTV) || (SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC)) {\r\ntempbl |= 0x10;\r\ntempbl &= 0xfd;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x32,tempbl);\r\n}\r\nif(ModeNo > 0x13) {\r\ntempcl -= ModeVGA;\r\nif(tempcl >= 0) {\r\ntempah = ((0x10 >> tempcl) | 0x80);\r\n}\r\n} else tempah = 0x80;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) tempah ^= 0xA0;\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(ModeNo > 0x13) {\r\ntempcl -= ModeVGA;\r\nif(tempcl >= 0) {\r\ntempah = (0x08 >> tempcl);\r\nif (tempah == 0) tempah = 1;\r\ntempah |= 0x40;\r\n}\r\n} else tempah = 0x40;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) tempah ^= 0x50;\r\n#endif\r\n}\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) tempah = 0;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x00,tempah);\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x00,0xa0,tempah);\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(IS_SIS740) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x00,tempah);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x00,0xa0,tempah);\r\n}\r\n}\r\n#endif\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntempah = 0x01;\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\ntempah |= 0x02;\r\n}\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC)) {\r\ntempah ^= 0x05;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD)) {\r\ntempah ^= 0x01;\r\n}\r\n}\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) tempah = 0;\r\ntempah = (tempah << 5) & 0xFF;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x01,tempah);\r\ntempah = (tempah >> 5) & 0xFF;\r\n} else {\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) tempah = 0x08;\r\nelse if(!(SiS_IsDualEdge(SiS_Pr))) tempah |= 0x08;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2E,0xF0,tempah);\r\ntempah &= ~0x08;\r\n}\r\nif((SiS_Pr->SiS_ModeType == ModeVGA) && (!(SiS_Pr->SiS_VBInfo & SetInSlaveMode))) {\r\ntempah |= 0x10;\r\n}\r\ntempah |= 0x80;\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nif(SiS_Pr->PanelXRes < 1280 && SiS_Pr->PanelYRes < 960) tempah &= ~0x80;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(!(SiS_Pr->SiS_TVMode & (TVSetYPbPr750p | TVSetYPbPr525p))) {\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\ntempah |= 0x20;\r\n}\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x0D,0x40,tempah);\r\ntempah = 0x80;\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nif(SiS_Pr->PanelXRes < 1280 && SiS_Pr->PanelYRes < 960) tempah = 0;\r\n}\r\nif(SiS_IsDualLink(SiS_Pr)) tempah |= 0x40;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(SiS_Pr->SiS_TVMode & TVRPLLDIV2XO) {\r\ntempah |= 0x40;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0C,tempah);\r\n} else {\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_315\r\ntempah = 0x80;\r\nif((modeflag & CRT2Mode) && (SiS_Pr->SiS_ModeType > ModeVGA)) {\r\nif(SiS_Pr->SiS_VBInfo & DriverMode) {\r\ntempah |= 0x02;\r\n}\r\n}\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) tempah |= 0x02;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) tempah ^= 0x01;\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) tempah = 1;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2e,0xF0,tempah);\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_300\r\ntempah = 0;\r\nif( (!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) && (SiS_Pr->SiS_ModeType > ModeVGA) ) {\r\ntempah |= 0x02;\r\n}\r\ntempah <<= 5;\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) tempah = 0;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x01,tempah);\r\n#endif\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(!(IS_SIS740)) {\r\ntempah = 0x04;\r\ntempbl = 0xfb;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\ntempah = 0x00;\r\nif(SiS_IsDualEdge(SiS_Pr)) {\r\ntempbl = 0xff;\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,tempbl,tempah);\r\n}\r\nif((IS_SIS740) || (SiS_Pr->ChipType >= SIS_661) || (SiS_Pr->SiS_ROMNew)) {\r\ntempah = 0x30;\r\ntempbl = 0xc0;\r\nif((SiS_Pr->SiS_VBInfo & DisableCRT2Display) ||\r\n((SiS_Pr->SiS_ROMNew) && (!(ROMAddr[0x5b] & 0x04)))) {\r\ntempah = 0x00;\r\ntempbl = 0x00;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2c,0xcf,tempah);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x21,0x3f,tempbl);\r\n} else if(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2c,0xcf);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x21,0x3f);\r\n} else if(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2c,0x30);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x21,0xc0);\r\n} else if(SiS_Pr->SiS_VBType & VB_NoLCD) {\r\ntempah = 0x30; tempah2 = 0xc0;\r\ntempbl = 0xcf; tempbl2 = 0x3f;\r\nif(SiS_Pr->SiS_TVBlue == 0) {\r\ntempah = tempah2 = 0x00;\r\n} else if(SiS_Pr->SiS_TVBlue == -1) {\r\nif(!(IS_SIS65x)) {\r\ntempah = tempah2 = 0x00;\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2c,tempbl,tempah);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x21,tempbl2,tempah2);\r\n} else {\r\ntempah = 0x30; tempah2 = 0xc0;\r\ntempbl = 0xcf; tempbl2 = 0x3f;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\ntempah = tempah2 = 0x00;\r\nif(SiS_IsDualEdge(SiS_Pr)) {\r\ntempbl = tempbl2 = 0xff;\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2c,tempbl,tempah);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x21,tempbl2,tempah2);\r\n}\r\nif(IS_SIS740) {\r\ntempah = 0x80;\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) tempah = 0x00;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x23,0x7f,tempah);\r\n} else {\r\ntempah = 0x00;\r\ntempbl = 0x7f;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\ntempbl = 0xff;\r\nif(!(SiS_IsDualEdge(SiS_Pr))) tempah = 0x80;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x23,tempbl,tempah);\r\n}\r\n#endif\r\n} else if(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\n#ifdef CONFIG_FB_SIS_300\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x21,0x3f);\r\nif((SiS_Pr->SiS_VBInfo & DisableCRT2Display) ||\r\n((SiS_Pr->SiS_VBType & VB_NoLCD) &&\r\n(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x23,0x7F);\r\n} else {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x23,0x80);\r\n}\r\n#endif\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x0D,0x80);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xCLV) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x3A,0xC0);\r\n}\r\n}\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\ntempah = 0x04;\r\ntempbl = 0xfb;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\ntempah = 0x00;\r\nif(SiS_IsDualEdge(SiS_Pr)) tempbl = 0xff;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,tempbl,tempah);\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x13,0xfb);\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2c,0x30);\r\n} else if(SiS_Pr->ChipType == SIS_550) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x13,0xfb);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2c,0x30);\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\nunsigned short\r\nSiS_GetResInfo(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nif(ModeNo <= 0x13)\r\nreturn ((unsigned short)SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo);\r\nelse\r\nreturn ((unsigned short)SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO);\r\n}\r\nstatic void\r\nSiS_GetCRT2ResInfo(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short xres, yres, modeflag=0, resindex;\r\nif(SiS_Pr->UseCustomMode) {\r\nxres = SiS_Pr->CHDisplay;\r\nif(SiS_Pr->CModeFlag & HalfDCLK) xres <<= 1;\r\nSiS_Pr->SiS_VGAHDE = SiS_Pr->SiS_HDE = xres;\r\nSiS_Pr->SiS_VGAVDE = SiS_Pr->SiS_VDE = SiS_Pr->CVDisplay;\r\nreturn;\r\n}\r\nresindex = SiS_GetResInfo(SiS_Pr,ModeNo,ModeIdIndex);\r\nif(ModeNo <= 0x13) {\r\nxres = SiS_Pr->SiS_StResInfo[resindex].HTotal;\r\nyres = SiS_Pr->SiS_StResInfo[resindex].VTotal;\r\n} else {\r\nxres = SiS_Pr->SiS_ModeResInfo[resindex].HTotal;\r\nyres = SiS_Pr->SiS_ModeResInfo[resindex].VTotal;\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\n}\r\nif(!SiS_Pr->SiS_IF_DEF_DSTN && !SiS_Pr->SiS_IF_DEF_FSTN) {\r\nif((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->SiS_IF_DEF_LVDS == 1)) {\r\nif((ModeNo != 0x03) && (SiS_Pr->SiS_SetFlag & SetDOSMode)) {\r\nif(yres == 350) yres = 400;\r\n}\r\nif(SiS_GetReg(SiS_Pr->SiS_P3d4,0x3a) & 0x01) {\r\nif(ModeNo == 0x12) yres = 400;\r\n}\r\n}\r\nif(modeflag & HalfDCLK) xres <<= 1;\r\nif(modeflag & DoubleScanMode) yres <<= 1;\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SISVB) && (!(SiS_Pr->SiS_VBType & VB_NoLCD))) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_1024x768:\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\nif(yres == 350) yres = 357;\r\nif(yres == 400) yres = 420;\r\nif(yres == 480) yres = 525;\r\n}\r\n}\r\nbreak;\r\ncase Panel_1280x1024:\r\nif(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\nif(yres == 400) yres = 405;\r\n}\r\nif(yres == 350) yres = 360;\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) {\r\nif(yres == 360) yres = 375;\r\n}\r\nbreak;\r\ncase Panel_1600x1200:\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) {\r\nif(yres == 1024) yres = 1056;\r\n}\r\nbreak;\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToHiVision)) {\r\nif(xres == 720) xres = 640;\r\n}\r\n} else if(xres == 720) xres = 640;\r\nif(SiS_Pr->SiS_SetFlag & SetDOSMode) {\r\nyres = 400;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3c4,0x17) & 0x80) yres = 480;\r\n} else {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3c4,0x13) & 0x80) yres = 480;\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_DSTN || SiS_Pr->SiS_IF_DEF_FSTN) yres = 480;\r\n}\r\n}\r\nSiS_Pr->SiS_VGAHDE = SiS_Pr->SiS_HDE = xres;\r\nSiS_Pr->SiS_VGAVDE = SiS_Pr->SiS_VDE = yres;\r\n}\r\nstatic void\r\nSiS_GetCRT2Ptr(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex, unsigned short *CRT2Index,\r\nunsigned short *ResIndex)\r\n{\r\nunsigned short tempbx=0, tempal=0, resinfo=0;\r\nif(ModeNo <= 0x13) {\r\ntempal = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n} else {\r\ntempal = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SISVB) && (SiS_Pr->SiS_IF_DEF_LVDS == 0)) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\ntempbx = SiS_Pr->SiS_LCDResInfo;\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) tempbx += 32;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1680x1050) {\r\nif (resinfo == SIS_RI_1280x800) tempal = 9;\r\nelse if(resinfo == SIS_RI_1400x1050) tempal = 11;\r\n} else if((SiS_Pr->SiS_LCDResInfo == Panel_1280x800) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1280x800_2) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1280x854)) {\r\nif (resinfo == SIS_RI_1280x768) tempal = 9;\r\n}\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\ntempbx = 100;\r\nif(ModeNo >= 0x13) {\r\ntempal = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC_NS;\r\n}\r\n}\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) {\r\nif(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\ntempbx = 200;\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) tempbx++;\r\n}\r\n}\r\n}\r\n#endif\r\n} else {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\ntempbx = 2;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\ntempbx = 13;\r\nif(!(SiS_Pr->SiS_TVMode & TVSetTVSimuMode)) tempbx = 14;\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) tempbx = 7;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) tempbx = 6;\r\nelse tempbx = 5;\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) tempbx += 5;\r\n} else {\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) tempbx = 3;\r\nelse tempbx = 4;\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) tempbx += 5;\r\n}\r\n}\r\ntempal &= 0x3F;\r\nif(ModeNo > 0x13) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTVNoHiVision) {\r\nswitch(resinfo) {\r\ncase SIS_RI_720x480:\r\ntempal = 6;\r\nif(SiS_Pr->SiS_TVMode & (TVSetPAL | TVSetPALN)) tempal = 9;\r\nbreak;\r\ncase SIS_RI_720x576:\r\ncase SIS_RI_768x576:\r\ncase SIS_RI_1024x576:\r\ntempal = 6;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) tempal = 8;\r\n}\r\nbreak;\r\ncase SIS_RI_800x480:\r\ntempal = 4;\r\nbreak;\r\ncase SIS_RI_512x384:\r\ncase SIS_RI_1024x768:\r\ntempal = 7;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) tempal = 8;\r\n}\r\nbreak;\r\ncase SIS_RI_1280x720:\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) tempal = 9;\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\n*CRT2Index = tempbx;\r\n*ResIndex = tempal;\r\n} else {\r\ntempbx = 0;\r\nif((SiS_Pr->SiS_IF_DEF_CH70xx) && (SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\ntempbx = 90;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\ntempbx = 92;\r\nif(SiS_Pr->SiS_ModeType > ModeVGA) {\r\nif(SiS_Pr->SiS_CHSOverScan) tempbx = 99;\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) tempbx = 94;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetPALN) tempbx = 96;\r\n}\r\nif(tempbx != 99) {\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) tempbx++;\r\n}\r\n} else {\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_640x480: tempbx = 12; break;\r\ncase Panel_320x240_1: tempbx = 10; break;\r\ncase Panel_320x240_2:\r\ncase Panel_320x240_3: tempbx = 14; break;\r\ncase Panel_800x600: tempbx = 16; break;\r\ncase Panel_1024x600: tempbx = 18; break;\r\ncase Panel_1152x768:\r\ncase Panel_1024x768: tempbx = 20; break;\r\ncase Panel_1280x768: tempbx = 22; break;\r\ncase Panel_1280x1024: tempbx = 24; break;\r\ncase Panel_1400x1050: tempbx = 26; break;\r\ncase Panel_1600x1200: tempbx = 28; break;\r\n#ifdef CONFIG_FB_SIS_300\r\ncase Panel_Barco1366: tempbx = 80; break;\r\n#endif\r\n}\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_320x240_1:\r\ncase Panel_320x240_2:\r\ncase Panel_320x240_3:\r\ncase Panel_640x480:\r\nbreak;\r\ndefault:\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) tempbx++;\r\n}\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) tempbx = 30;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1024) {\r\ntempbx = 82;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) tempbx++;\r\n} else if(SiS_Pr->SiS_CustomT == CUT_PANEL848 || SiS_Pr->SiS_CustomT == CUT_PANEL856) {\r\ntempbx = 84;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) tempbx++;\r\n}\r\n#endif\r\n}\r\n(*CRT2Index) = tempbx;\r\n(*ResIndex) = tempal & 0x1F;\r\n}\r\n}\r\nstatic void\r\nSiS_GetRAMDAC2DATA(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short tempax=0, tempbx=0, index, dotclock;\r\nunsigned short temp1=0, modeflag=0, tempcx=0;\r\nSiS_Pr->SiS_RVBHCMAX = 1;\r\nSiS_Pr->SiS_RVBHCFACT = 1;\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nindex = SiS_GetModePtr(SiS_Pr,ModeNo,ModeIdIndex);\r\ntempax = SiS_Pr->SiS_StandTable[index].CRTC[0];\r\ntempbx = SiS_Pr->SiS_StandTable[index].CRTC[6];\r\ntemp1 = SiS_Pr->SiS_StandTable[index].CRTC[7];\r\ndotclock = (modeflag & Charx8Dot) ? 8 : 9;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nindex = SiS_GetRefCRT1CRTC(SiS_Pr, RefreshRateTableIndex, SiS_Pr->SiS_UseWideCRT2);\r\ntempax = SiS_Pr->SiS_CRT1Table[index].CR[0];\r\ntempax |= (SiS_Pr->SiS_CRT1Table[index].CR[14] << 8);\r\ntempax &= 0x03FF;\r\ntempbx = SiS_Pr->SiS_CRT1Table[index].CR[6];\r\ntempcx = SiS_Pr->SiS_CRT1Table[index].CR[13] << 8;\r\ntempcx &= 0x0100;\r\ntempcx <<= 2;\r\ntempbx |= tempcx;\r\ntemp1 = SiS_Pr->SiS_CRT1Table[index].CR[7];\r\ndotclock = 8;\r\n}\r\nif(temp1 & 0x01) tempbx |= 0x0100;\r\nif(temp1 & 0x20) tempbx |= 0x0200;\r\ntempax += 5;\r\ntempax *= dotclock;\r\nif(modeflag & HalfDCLK) tempax <<= 1;\r\ntempbx++;\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->SiS_HT = tempax;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->SiS_VT = tempbx;\r\n}\r\nstatic void\r\nSiS_CalcPanelLinkTiming(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short ResIndex;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) {\r\nif(SiS_Pr->UseCustomMode) {\r\nResIndex = SiS_Pr->CHTotal;\r\nif(SiS_Pr->CModeFlag & HalfDCLK) ResIndex <<= 1;\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->SiS_HT = ResIndex;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->SiS_VT = SiS_Pr->CVTotal;\r\n} else {\r\nif(ModeNo < 0x13) {\r\nResIndex = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n} else {\r\nResIndex = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC_NS;\r\n}\r\nif(ResIndex == 0x09) {\r\nif(SiS_Pr->Alternate1600x1200) ResIndex = 0x20;\r\nelse if(SiS_Pr->SiS_IF_DEF_LVDS == 1) ResIndex = 0x21;\r\n}\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->SiS_NoScaleData[ResIndex].VGAHT;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->SiS_NoScaleData[ResIndex].VGAVT;\r\nSiS_Pr->SiS_HT = SiS_Pr->SiS_NoScaleData[ResIndex].LCDHT;\r\nSiS_Pr->SiS_VT = SiS_Pr->SiS_NoScaleData[ResIndex].LCDVT;\r\n}\r\n} else {\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->SiS_HT = SiS_Pr->PanelHT;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->SiS_VT = SiS_Pr->PanelVT;\r\n}\r\n} else {\r\nSiS_Pr->SiS_HDE = SiS_Pr->PanelXRes;\r\nSiS_Pr->SiS_VDE = SiS_Pr->PanelYRes;\r\nSiS_Pr->SiS_HT = SiS_Pr->PanelHT;\r\nSiS_Pr->SiS_VT = SiS_Pr->PanelVT;\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->PanelHT - (SiS_Pr->PanelXRes - SiS_Pr->SiS_VGAHDE);\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->PanelVT - (SiS_Pr->PanelYRes - SiS_Pr->SiS_VGAVDE);\r\n}\r\n}\r\nstatic void\r\nSiS_GetCRT2DataLVDS(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short CRT2Index, ResIndex, backup;\r\nconst struct SiS_LVDSData *LVDSData = NULL;\r\nSiS_GetCRT2ResInfo(SiS_Pr, ModeNo, ModeIdIndex);\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nSiS_Pr->SiS_RVBHCMAX = 1;\r\nSiS_Pr->SiS_RVBHCFACT = 1;\r\nSiS_Pr->SiS_NewFlickerMode = 0;\r\nSiS_Pr->SiS_RVBHRS = 50;\r\nSiS_Pr->SiS_RY1COE = 0;\r\nSiS_Pr->SiS_RY2COE = 0;\r\nSiS_Pr->SiS_RY3COE = 0;\r\nSiS_Pr->SiS_RY4COE = 0;\r\nSiS_Pr->SiS_RVBHRS2 = 0;\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SISVB) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS_CalcPanelLinkTiming(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\nSiS_CalcLCDACRT1Timing(SiS_Pr, ModeNo, ModeIdIndex);\r\n#endif\r\n} else {\r\nbackup = SiS_Pr->SiS_IF_DEF_LVDS;\r\nif((SiS_Pr->SiS_VBType & VB_NoLCD) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD)) {\r\nSiS_Pr->SiS_IF_DEF_LVDS = 1;\r\n}\r\nSiS_GetCRT2Ptr(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex,\r\n&CRT2Index, &ResIndex);\r\nSiS_Pr->SiS_IF_DEF_LVDS = backup;\r\nswitch(CRT2Index) {\r\ncase 10: LVDSData = SiS_Pr->SiS_LVDS320x240Data_1; break;\r\ncase 14: LVDSData = SiS_Pr->SiS_LVDS320x240Data_2; break;\r\ncase 12: LVDSData = SiS_Pr->SiS_LVDS640x480Data_1; break;\r\ncase 16: LVDSData = SiS_Pr->SiS_LVDS800x600Data_1; break;\r\ncase 18: LVDSData = SiS_Pr->SiS_LVDS1024x600Data_1; break;\r\ncase 20: LVDSData = SiS_Pr->SiS_LVDS1024x768Data_1; break;\r\n#ifdef CONFIG_FB_SIS_300\r\ncase 80: LVDSData = SiS_Pr->SiS_LVDSBARCO1366Data_1; break;\r\ncase 81: LVDSData = SiS_Pr->SiS_LVDSBARCO1366Data_2; break;\r\ncase 82: LVDSData = SiS_Pr->SiS_LVDSBARCO1024Data_1; break;\r\ncase 84: LVDSData = SiS_Pr->SiS_LVDS848x480Data_1; break;\r\ncase 85: LVDSData = SiS_Pr->SiS_LVDS848x480Data_2; break;\r\n#endif\r\ncase 90: LVDSData = SiS_Pr->SiS_CHTVUNTSCData; break;\r\ncase 91: LVDSData = SiS_Pr->SiS_CHTVONTSCData; break;\r\ncase 92: LVDSData = SiS_Pr->SiS_CHTVUPALData; break;\r\ncase 93: LVDSData = SiS_Pr->SiS_CHTVOPALData; break;\r\ncase 94: LVDSData = SiS_Pr->SiS_CHTVUPALMData; break;\r\ncase 95: LVDSData = SiS_Pr->SiS_CHTVOPALMData; break;\r\ncase 96: LVDSData = SiS_Pr->SiS_CHTVUPALNData; break;\r\ncase 97: LVDSData = SiS_Pr->SiS_CHTVOPALNData; break;\r\ncase 99: LVDSData = SiS_Pr->SiS_CHTVSOPALData; break;\r\n}\r\nif(LVDSData) {\r\nSiS_Pr->SiS_VGAHT = (LVDSData+ResIndex)->VGAHT;\r\nSiS_Pr->SiS_VGAVT = (LVDSData+ResIndex)->VGAVT;\r\nSiS_Pr->SiS_HT = (LVDSData+ResIndex)->LCDHT;\r\nSiS_Pr->SiS_VT = (LVDSData+ResIndex)->LCDVT;\r\n} else {\r\nSiS_CalcPanelLinkTiming(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\nif( (!(SiS_Pr->SiS_VBType & VB_SISVB)) &&\r\n(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) &&\r\n(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) ) {\r\nif( (!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) ||\r\n(SiS_Pr->SiS_SetFlag & SetDOSMode) ) {\r\nSiS_Pr->SiS_HDE = SiS_Pr->PanelXRes;\r\nSiS_Pr->SiS_VDE = SiS_Pr->PanelYRes;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1366) {\r\nif(ResIndex < 0x08) {\r\nSiS_Pr->SiS_HDE = 1280;\r\nSiS_Pr->SiS_VDE = 1024;\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_GetCRT2Data301(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned char *ROMAddr = NULL;\r\nunsigned short tempax, tempbx, modeflag, romptr=0;\r\nunsigned short resinfo, CRT2Index, ResIndex;\r\nconst struct SiS_LCDData *LCDPtr = NULL;\r\nconst struct SiS_TVData *TVPtr = NULL;\r\n#ifdef CONFIG_FB_SIS_315\r\nshort resinfo661;\r\n#endif\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nresinfo = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo;\r\n} else if(SiS_Pr->UseCustomMode) {\r\nmodeflag = SiS_Pr->CModeFlag;\r\nresinfo = 0;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n#ifdef CONFIG_FB_SIS_315\r\nresinfo661 = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].ROMMODEIDX661;\r\nif( (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) &&\r\n(SiS_Pr->SiS_SetFlag & LCDVESATiming) &&\r\n(resinfo661 >= 0) &&\r\n(SiS_Pr->SiS_NeedRomModeData) ) {\r\nif((ROMAddr = GetLCDStructPtr661(SiS_Pr))) {\r\nif((romptr = (SISGETROMW(21)))) {\r\nromptr += (resinfo661 * 10);\r\nROMAddr = SiS_Pr->VirtualRomBase;\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\nSiS_Pr->SiS_NewFlickerMode = 0;\r\nSiS_Pr->SiS_RVBHRS = 50;\r\nSiS_Pr->SiS_RY1COE = 0;\r\nSiS_Pr->SiS_RY2COE = 0;\r\nSiS_Pr->SiS_RY3COE = 0;\r\nSiS_Pr->SiS_RY4COE = 0;\r\nSiS_Pr->SiS_RVBHRS2 = 0;\r\nSiS_GetCRT2ResInfo(SiS_Pr,ModeNo,ModeIdIndex);\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) {\r\nif(SiS_Pr->UseCustomMode) {\r\nSiS_Pr->SiS_RVBHCMAX = 1;\r\nSiS_Pr->SiS_RVBHCFACT = 1;\r\nSiS_Pr->SiS_HDE = SiS_Pr->SiS_VGAHDE;\r\nSiS_Pr->SiS_VDE = SiS_Pr->SiS_VGAVDE;\r\ntempax = SiS_Pr->CHTotal;\r\nif(modeflag & HalfDCLK) tempax <<= 1;\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->SiS_HT = tempax;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->SiS_VT = SiS_Pr->CVTotal;\r\n} else {\r\nSiS_GetRAMDAC2DATA(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_GetCRT2Ptr(SiS_Pr,ModeNo,ModeIdIndex,RefreshRateTableIndex,\r\n&CRT2Index,&ResIndex);\r\nswitch(CRT2Index) {\r\ncase 2: TVPtr = SiS_Pr->SiS_ExtHiTVData; break;\r\ncase 3: TVPtr = SiS_Pr->SiS_ExtPALData; break;\r\ncase 4: TVPtr = SiS_Pr->SiS_ExtNTSCData; break;\r\ncase 5: TVPtr = SiS_Pr->SiS_Ext525iData; break;\r\ncase 6: TVPtr = SiS_Pr->SiS_Ext525pData; break;\r\ncase 7: TVPtr = SiS_Pr->SiS_Ext750pData; break;\r\ncase 8: TVPtr = SiS_Pr->SiS_StPALData; break;\r\ncase 9: TVPtr = SiS_Pr->SiS_StNTSCData; break;\r\ncase 10: TVPtr = SiS_Pr->SiS_St525iData; break;\r\ncase 11: TVPtr = SiS_Pr->SiS_St525pData; break;\r\ncase 12: TVPtr = SiS_Pr->SiS_St750pData; break;\r\ncase 13: TVPtr = SiS_Pr->SiS_St1HiTVData; break;\r\ncase 14: TVPtr = SiS_Pr->SiS_St2HiTVData; break;\r\ndefault: TVPtr = SiS_Pr->SiS_StPALData; break;\r\n}\r\nSiS_Pr->SiS_RVBHCMAX = (TVPtr+ResIndex)->RVBHCMAX;\r\nSiS_Pr->SiS_RVBHCFACT = (TVPtr+ResIndex)->RVBHCFACT;\r\nSiS_Pr->SiS_VGAHT = (TVPtr+ResIndex)->VGAHT;\r\nSiS_Pr->SiS_VGAVT = (TVPtr+ResIndex)->VGAVT;\r\nSiS_Pr->SiS_HDE = (TVPtr+ResIndex)->TVHDE;\r\nSiS_Pr->SiS_VDE = (TVPtr+ResIndex)->TVVDE;\r\nSiS_Pr->SiS_RVBHRS2 = (TVPtr+ResIndex)->RVBHRS2 & 0x0fff;\r\nif(modeflag & HalfDCLK) {\r\nSiS_Pr->SiS_RVBHRS = (TVPtr+ResIndex)->HALFRVBHRS;\r\nif(SiS_Pr->SiS_RVBHRS2) {\r\nSiS_Pr->SiS_RVBHRS2 = ((SiS_Pr->SiS_RVBHRS2 + 3) >> 1) - 3;\r\ntempax = ((TVPtr+ResIndex)->RVBHRS2 >> 12) & 0x07;\r\nif((TVPtr+ResIndex)->RVBHRS2 & 0x8000) SiS_Pr->SiS_RVBHRS2 -= tempax;\r\nelse SiS_Pr->SiS_RVBHRS2 += tempax;\r\n}\r\n} else {\r\nSiS_Pr->SiS_RVBHRS = (TVPtr+ResIndex)->RVBHRS;\r\n}\r\nSiS_Pr->SiS_NewFlickerMode = ((TVPtr+ResIndex)->FlickerMode) << 7;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif((resinfo == SIS_RI_960x600) ||\r\n(resinfo == SIS_RI_1024x768) ||\r\n(resinfo == SIS_RI_1280x1024) ||\r\n(resinfo == SIS_RI_1280x720)) {\r\nSiS_Pr->SiS_NewFlickerMode = 0x40;\r\n}\r\nif(SiS_Pr->SiS_VGAVDE == 350) SiS_Pr->SiS_TVMode |= TVSetTVSimuMode;\r\nSiS_Pr->SiS_HT = ExtHiTVHT;\r\nSiS_Pr->SiS_VT = ExtHiTVVT;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) {\r\nSiS_Pr->SiS_HT = StHiTVHT;\r\nSiS_Pr->SiS_VT = StHiTVVT;\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) {\r\nSiS_Pr->SiS_HT = 1650;\r\nSiS_Pr->SiS_VT = 750;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) {\r\nSiS_Pr->SiS_HT = NTSCHT;\r\nif(SiS_Pr->SiS_TVMode & TVSet525p1024) SiS_Pr->SiS_HT = NTSC2HT;\r\nSiS_Pr->SiS_VT = NTSCVT;\r\n} else {\r\nSiS_Pr->SiS_HT = NTSCHT;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSC1024) SiS_Pr->SiS_HT = NTSC2HT;\r\nSiS_Pr->SiS_VT = NTSCVT;\r\n}\r\n} else {\r\nSiS_Pr->SiS_RY1COE = (TVPtr+ResIndex)->RY1COE;\r\nSiS_Pr->SiS_RY2COE = (TVPtr+ResIndex)->RY2COE;\r\nSiS_Pr->SiS_RY3COE = (TVPtr+ResIndex)->RY3COE;\r\nSiS_Pr->SiS_RY4COE = (TVPtr+ResIndex)->RY4COE;\r\nif(modeflag & HalfDCLK) {\r\nSiS_Pr->SiS_RY1COE = 0x00;\r\nSiS_Pr->SiS_RY2COE = 0xf4;\r\nSiS_Pr->SiS_RY3COE = 0x10;\r\nSiS_Pr->SiS_RY4COE = 0x38;\r\n}\r\nif(!(SiS_Pr->SiS_TVMode & TVSetPAL)) {\r\nSiS_Pr->SiS_HT = NTSCHT;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSC1024) SiS_Pr->SiS_HT = NTSC2HT;\r\nSiS_Pr->SiS_VT = NTSCVT;\r\n} else {\r\nSiS_Pr->SiS_HT = PALHT;\r\nSiS_Pr->SiS_VT = PALVT;\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nSiS_Pr->SiS_RVBHCMAX = 1;\r\nSiS_Pr->SiS_RVBHCFACT = 1;\r\nif(SiS_Pr->UseCustomMode) {\r\nSiS_Pr->SiS_HDE = SiS_Pr->SiS_VGAHDE;\r\nSiS_Pr->SiS_VDE = SiS_Pr->SiS_VGAVDE;\r\ntempax = SiS_Pr->CHTotal;\r\nif(modeflag & HalfDCLK) tempax <<= 1;\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->SiS_HT = tempax;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->SiS_VT = SiS_Pr->CVTotal;\r\n} else {\r\nbool gotit = false;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (!(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->PanelHT;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->PanelVT;\r\nSiS_Pr->SiS_HT = SiS_Pr->PanelHT;\r\nSiS_Pr->SiS_VT = SiS_Pr->PanelVT;\r\ngotit = true;\r\n} else if( (!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) && (romptr) && (ROMAddr) ) {\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS_Pr->SiS_RVBHCMAX = ROMAddr[romptr];\r\nSiS_Pr->SiS_RVBHCFACT = ROMAddr[romptr+1];\r\nSiS_Pr->SiS_VGAHT = ROMAddr[romptr+2] | ((ROMAddr[romptr+3] & 0x0f) << 8);\r\nSiS_Pr->SiS_VGAVT = (ROMAddr[romptr+4] << 4) | ((ROMAddr[romptr+3] & 0xf0) >> 4);\r\nSiS_Pr->SiS_HT = ROMAddr[romptr+5] | ((ROMAddr[romptr+6] & 0x0f) << 8);\r\nSiS_Pr->SiS_VT = (ROMAddr[romptr+7] << 4) | ((ROMAddr[romptr+6] & 0xf0) >> 4);\r\nSiS_Pr->SiS_RVBHRS2 = ROMAddr[romptr+8] | ((ROMAddr[romptr+9] & 0x0f) << 8);\r\nif((SiS_Pr->SiS_RVBHRS2) && (modeflag & HalfDCLK)) {\r\nSiS_Pr->SiS_RVBHRS2 = ((SiS_Pr->SiS_RVBHRS2 + 3) >> 1) - 3;\r\ntempax = (ROMAddr[romptr+9] >> 4) & 0x07;\r\nif(ROMAddr[romptr+9] & 0x80) SiS_Pr->SiS_RVBHRS2 -= tempax;\r\nelse SiS_Pr->SiS_RVBHRS2 += tempax;\r\n}\r\nif(SiS_Pr->SiS_VGAHT) gotit = true;\r\nelse {\r\nSiS_Pr->SiS_LCDInfo |= DontExpandLCD;\r\nSiS_Pr->SiS_LCDInfo &= ~LCDPass11;\r\nSiS_Pr->SiS_RVBHCMAX = 1;\r\nSiS_Pr->SiS_RVBHCFACT = 1;\r\nSiS_Pr->SiS_VGAHT = SiS_Pr->PanelHT;\r\nSiS_Pr->SiS_VGAVT = SiS_Pr->PanelVT;\r\nSiS_Pr->SiS_HT = SiS_Pr->PanelHT;\r\nSiS_Pr->SiS_VT = SiS_Pr->PanelVT;\r\nSiS_Pr->SiS_RVBHRS2 = 0;\r\ngotit = true;\r\n}\r\n#endif\r\n}\r\nif(!gotit) {\r\nSiS_GetCRT2Ptr(SiS_Pr,ModeNo,ModeIdIndex,RefreshRateTableIndex,\r\n&CRT2Index,&ResIndex);\r\nswitch(CRT2Index) {\r\ncase Panel_1024x768 : LCDPtr = SiS_Pr->SiS_ExtLCD1024x768Data; break;\r\ncase Panel_1024x768 + 32: LCDPtr = SiS_Pr->SiS_St2LCD1024x768Data; break;\r\ncase Panel_1280x720 :\r\ncase Panel_1280x720 + 32: LCDPtr = SiS_Pr->SiS_LCD1280x720Data; break;\r\ncase Panel_1280x768_2 : LCDPtr = SiS_Pr->SiS_ExtLCD1280x768_2Data; break;\r\ncase Panel_1280x768_2+ 32: LCDPtr = SiS_Pr->SiS_StLCD1280x768_2Data; break;\r\ncase Panel_1280x800 :\r\ncase Panel_1280x800 + 32: LCDPtr = SiS_Pr->SiS_LCD1280x800Data; break;\r\ncase Panel_1280x800_2 :\r\ncase Panel_1280x800_2+ 32: LCDPtr = SiS_Pr->SiS_LCD1280x800_2Data; break;\r\ncase Panel_1280x854 :\r\ncase Panel_1280x854 + 32: LCDPtr = SiS_Pr->SiS_LCD1280x854Data; break;\r\ncase Panel_1280x960 :\r\ncase Panel_1280x960 + 32: LCDPtr = SiS_Pr->SiS_LCD1280x960Data; break;\r\ncase Panel_1280x1024 : LCDPtr = SiS_Pr->SiS_ExtLCD1280x1024Data; break;\r\ncase Panel_1280x1024 + 32: LCDPtr = SiS_Pr->SiS_St2LCD1280x1024Data; break;\r\ncase Panel_1400x1050 : LCDPtr = SiS_Pr->SiS_ExtLCD1400x1050Data; break;\r\ncase Panel_1400x1050 + 32: LCDPtr = SiS_Pr->SiS_StLCD1400x1050Data; break;\r\ncase Panel_1600x1200 : LCDPtr = SiS_Pr->SiS_ExtLCD1600x1200Data; break;\r\ncase Panel_1600x1200 + 32: LCDPtr = SiS_Pr->SiS_StLCD1600x1200Data; break;\r\ncase Panel_1680x1050 :\r\ncase Panel_1680x1050 + 32: LCDPtr = SiS_Pr->SiS_LCD1680x1050Data; break;\r\ncase 100 : LCDPtr = SiS_Pr->SiS_NoScaleData; break;\r\n#ifdef CONFIG_FB_SIS_315\r\ncase 200 : LCDPtr = SiS310_ExtCompaq1280x1024Data; break;\r\ncase 201 : LCDPtr = SiS_Pr->SiS_St2LCD1280x1024Data; break;\r\n#endif\r\ndefault : LCDPtr = SiS_Pr->SiS_ExtLCD1024x768Data; break;\r\n}\r\nSiS_Pr->SiS_RVBHCMAX = (LCDPtr+ResIndex)->RVBHCMAX;\r\nSiS_Pr->SiS_RVBHCFACT = (LCDPtr+ResIndex)->RVBHCFACT;\r\nSiS_Pr->SiS_VGAHT = (LCDPtr+ResIndex)->VGAHT;\r\nSiS_Pr->SiS_VGAVT = (LCDPtr+ResIndex)->VGAVT;\r\nSiS_Pr->SiS_HT = (LCDPtr+ResIndex)->LCDHT;\r\nSiS_Pr->SiS_VT = (LCDPtr+ResIndex)->LCDVT;\r\n}\r\ntempax = SiS_Pr->PanelXRes;\r\ntempbx = SiS_Pr->PanelYRes;\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_1024x768:\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif (SiS_Pr->SiS_VGAVDE == 350) tempbx = 560;\r\nelse if(SiS_Pr->SiS_VGAVDE == 400) tempbx = 640;\r\n}\r\n} else {\r\nif (SiS_Pr->SiS_VGAVDE == 357) tempbx = 527;\r\nelse if(SiS_Pr->SiS_VGAVDE == 420) tempbx = 620;\r\nelse if(SiS_Pr->SiS_VGAVDE == 525) tempbx = 775;\r\nelse if(SiS_Pr->SiS_VGAVDE == 600) tempbx = 775;\r\nelse if(SiS_Pr->SiS_VGAVDE == 350) tempbx = 560;\r\nelse if(SiS_Pr->SiS_VGAVDE == 400) tempbx = 640;\r\n}\r\nbreak;\r\ncase Panel_1280x960:\r\nif (SiS_Pr->SiS_VGAVDE == 350) tempbx = 700;\r\nelse if(SiS_Pr->SiS_VGAVDE == 400) tempbx = 800;\r\nelse if(SiS_Pr->SiS_VGAVDE == 1024) tempbx = 960;\r\nbreak;\r\ncase Panel_1280x1024:\r\nif (SiS_Pr->SiS_VGAVDE == 360) tempbx = 768;\r\nelse if(SiS_Pr->SiS_VGAVDE == 375) tempbx = 800;\r\nelse if(SiS_Pr->SiS_VGAVDE == 405) tempbx = 864;\r\nbreak;\r\ncase Panel_1600x1200:\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) {\r\nif (SiS_Pr->SiS_VGAVDE == 350) tempbx = 875;\r\nelse if(SiS_Pr->SiS_VGAVDE == 400) tempbx = 1000;\r\n}\r\nbreak;\r\n}\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\ntempax = SiS_Pr->SiS_VGAHDE;\r\ntempbx = SiS_Pr->SiS_VGAVDE;\r\n}\r\nSiS_Pr->SiS_HDE = tempax;\r\nSiS_Pr->SiS_VDE = tempbx;\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_GetCRT2Data(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_GetCRT2DataLVDS(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n} else {\r\nif((SiS_Pr->SiS_VBType & VB_NoLCD) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD)) {\r\nSiS_GetCRT2DataLVDS(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n} else {\r\nSiS_GetCRT2Data301(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n}\r\n} else {\r\nSiS_GetCRT2DataLVDS(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n}\r\nstatic const struct SiS_LVDSDes *\r\nSiS_GetLVDSDesPtr(struct SiS_Private *SiS_Pr)\r\n{\r\nconst struct SiS_LVDSDes *PanelDesPtr = NULL;\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_LCDTypeInfo == 4) {\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1366) {\r\nPanelDesPtr = SiS_Pr->SiS_PanelType04_1a;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nPanelDesPtr = SiS_Pr->SiS_PanelType04_2a;\r\n}\r\n} else if(SiS_Pr->SiS_CustomT == CUT_BARCO1024) {\r\nPanelDesPtr = SiS_Pr->SiS_PanelType04_1b;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nPanelDesPtr = SiS_Pr->SiS_PanelType04_2b;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\nreturn PanelDesPtr;\r\n}\r\nstatic void\r\nSiS_GetLVDSDesData(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short modeflag, ResIndex;\r\nconst struct SiS_LVDSDes *PanelDesPtr = NULL;\r\nSiS_Pr->SiS_LCDHDES = 0;\r\nSiS_Pr->SiS_LCDVDES = 0;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->SiS_VGAVDE == SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n}\r\n}\r\nreturn;\r\n}\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_640x480 && SiS_Pr->SiS_LCDTypeInfo == 3) {\r\nSiS_Pr->SiS_LCDHDES = 8;\r\nif (SiS_Pr->SiS_VGAVDE >= 480) SiS_Pr->SiS_LCDVDES = 512;\r\nelse if(SiS_Pr->SiS_VGAVDE >= 400) SiS_Pr->SiS_LCDVDES = 436;\r\nelse if(SiS_Pr->SiS_VGAVDE >= 350) SiS_Pr->SiS_LCDVDES = 440;\r\nreturn;\r\n}\r\n}\r\n}\r\nif( (SiS_Pr->UseCustomMode) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_Custom) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL848) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL856) ||\r\n(SiS_Pr->SiS_LCDInfo & LCDPass11) ) {\r\nreturn;\r\n}\r\nif(ModeNo <= 0x13) ResIndex = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\nelse ResIndex = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\nif((SiS_Pr->SiS_VBType & VB_SIS30xBLV) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(SiS_Pr->SiS_VGAHDE != SiS_Pr->PanelXRes) {\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->SiS_HT - ((SiS_Pr->PanelXRes - SiS_Pr->SiS_VGAHDE) / 2);\r\n}\r\nif(SiS_Pr->SiS_VGAVDE != SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->SiS_VT - ((SiS_Pr->PanelYRes - SiS_Pr->SiS_VGAVDE) / 2);\r\n}\r\n}\r\nif(SiS_Pr->SiS_VGAVDE == SiS_Pr->PanelYRes) {\r\nswitch(SiS_Pr->SiS_CustomT) {\r\ncase CUT_UNIWILL1024:\r\ncase CUT_UNIWILL10242:\r\ncase CUT_CLEVO1400:\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n}\r\nbreak;\r\n}\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_1280x1024:\r\nif(SiS_Pr->SiS_CustomT != CUT_COMPAQ1280) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n}\r\nbreak;\r\ncase Panel_1280x800:\r\ncase Panel_1280x800_2:\r\ncase Panel_1280x854:\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\nbreak;\r\n}\r\n}\r\n#endif\r\n} else {\r\nif((SiS_Pr->SiS_IF_DEF_CH70xx != 0) && (SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\nif((SiS_Pr->SiS_TVMode & TVSetPAL) && (!(SiS_Pr->SiS_TVMode & TVSetPALM))) {\r\nif(ResIndex <= 3) SiS_Pr->SiS_LCDHDES = 256;\r\n}\r\n} else if((PanelDesPtr = SiS_GetLVDSDesPtr(SiS_Pr))) {\r\nSiS_Pr->SiS_LCDHDES = (PanelDesPtr+ResIndex)->LCDHDES;\r\nSiS_Pr->SiS_LCDVDES = (PanelDesPtr+ResIndex)->LCDVDES;\r\n} else if(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(SiS_Pr->SiS_VGAHDE != SiS_Pr->PanelXRes) {\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->SiS_HT - ((SiS_Pr->PanelXRes - SiS_Pr->SiS_VGAHDE) / 2);\r\n}\r\nif(SiS_Pr->SiS_VGAVDE != SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->SiS_VT - ((SiS_Pr->PanelYRes - SiS_Pr->SiS_VGAVDE) / 2);\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n} else {\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_800x600:\r\ncase Panel_1024x768:\r\ncase Panel_1280x1024:\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT;\r\nbreak;\r\ncase Panel_1400x1050:\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\nbreak;\r\n}\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_800x600:\r\nif(SiS_Pr->SiS_VGAVDE == SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n} else {\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->PanelHT + 3;\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT;\r\nif(SiS_Pr->SiS_VGAVDE == 400) SiS_Pr->SiS_LCDVDES -= 2;\r\nelse SiS_Pr->SiS_LCDVDES -= 4;\r\n}\r\nbreak;\r\ncase Panel_1024x768:\r\nif(SiS_Pr->SiS_VGAVDE == SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n} else {\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->PanelHT - 1;\r\nif(SiS_Pr->SiS_VGAVDE <= 400) SiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 8;\r\nif(SiS_Pr->SiS_VGAVDE <= 350) SiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 12;\r\n}\r\nbreak;\r\ncase Panel_1024x600:\r\ndefault:\r\nif( (SiS_Pr->SiS_VGAHDE == SiS_Pr->PanelXRes) &&\r\n(SiS_Pr->SiS_VGAVDE == SiS_Pr->PanelYRes) ) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n} else {\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->PanelHT - 1;\r\n}\r\nbreak;\r\n}\r\nswitch(SiS_Pr->SiS_LCDTypeInfo) {\r\ncase 1:\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->SiS_LCDVDES = 0;\r\nbreak;\r\ncase 3:\r\nSiS_Pr->SiS_LCDHDES = 8;\r\nif (SiS_Pr->SiS_VGAVDE >= 480) SiS_Pr->SiS_LCDVDES = 512;\r\nelse if(SiS_Pr->SiS_VGAVDE >= 400) SiS_Pr->SiS_LCDVDES = 436;\r\nelse if(SiS_Pr->SiS_VGAVDE >= 350) SiS_Pr->SiS_LCDVDES = 440;\r\nbreak;\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_1024x768:\r\ncase Panel_1280x1024:\r\nif(SiS_Pr->SiS_VGAVDE == SiS_Pr->PanelYRes) {\r\nSiS_Pr->SiS_LCDVDES = SiS_Pr->PanelVT - 1;\r\n}\r\nbreak;\r\ncase Panel_320x240_1:\r\ncase Panel_320x240_2:\r\ncase Panel_320x240_3:\r\nSiS_Pr->SiS_LCDVDES = 524;\r\nbreak;\r\n}\r\n#endif\r\n}\r\n}\r\nif((ModeNo <= 0x13) && (SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nif((SiS_Pr->SiS_VBType & VB_SIS30xBLV) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\nif(!(modeflag & HalfDCLK)) SiS_Pr->SiS_LCDHDES = 632;\r\n} else if(!(SiS_Pr->SiS_SetFlag & SetDOSMode)) {\r\nif(SiS_Pr->SiS_LCDResInfo != Panel_1280x1024) {\r\nif(SiS_Pr->SiS_LCDResInfo >= Panel_1024x768) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(!(modeflag & HalfDCLK)) SiS_Pr->SiS_LCDHDES = 320;\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) SiS_Pr->SiS_LCDHDES = 480;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) SiS_Pr->SiS_LCDHDES = 804;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) SiS_Pr->SiS_LCDHDES = 704;\r\nif(!(modeflag & HalfDCLK)) {\r\nSiS_Pr->SiS_LCDHDES = 320;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) SiS_Pr->SiS_LCDHDES = 632;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) SiS_Pr->SiS_LCDHDES = 542;\r\n}\r\n#endif\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nstatic int\r\nSiS_HandlePWD(struct SiS_Private *SiS_Pr)\r\n{\r\nint ret = 0;\r\n#ifdef SET_PWD\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr = GetLCDStructPtr661_2(SiS_Pr);\r\nunsigned char drivermode = SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & 0x40;\r\nunsigned short temp;\r\nif( (SiS_Pr->SiS_VBType & VB_SISPWD) &&\r\n(romptr) &&\r\n(SiS_Pr->SiS_PWDOffset) ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2b,ROMAddr[romptr + SiS_Pr->SiS_PWDOffset + 0]);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2c,ROMAddr[romptr + SiS_Pr->SiS_PWDOffset + 1]);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2d,ROMAddr[romptr + SiS_Pr->SiS_PWDOffset + 2]);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2e,ROMAddr[romptr + SiS_Pr->SiS_PWDOffset + 3]);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2f,ROMAddr[romptr + SiS_Pr->SiS_PWDOffset + 4]);\r\ntemp = 0x00;\r\nif((ROMAddr[romptr + 2] & (0x06 << 1)) && !drivermode) {\r\ntemp = 0x80;\r\nret = 1;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x27,0x7f,temp);\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nvoid\r\nSiS_DisableBridge(struct SiS_Private *SiS_Pr)\r\n{\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short tempah, pushax=0, modenum;\r\n#endif\r\nunsigned short temp=0;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x26,0xFE);\r\n} else {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x08);\r\n}\r\nSiS_PanelDelay(SiS_Pr, 3);\r\n}\r\nif(SiS_Is301B(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x1f,0x3f);\r\nSiS_ShortDelay(SiS_Pr,1);\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x00,0xDF);\r\nSiS_DisplayOff(SiS_Pr);\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x32,0xDF);\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1E,0xDF);\r\nSiS_UnLockCRT2(SiS_Pr);\r\nif(!(SiS_Pr->SiS_VBType & VB_SISLVDS)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x01,0x80);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x02,0x40);\r\n}\r\nif( (!(SiS_CRT2IsLCD(SiS_Pr))) ||\r\n(!(SiS_CR36BIOSWord23d(SiS_Pr))) ) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x26,0xFD);\r\n} else {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x04);\r\n}\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nint didpwd = 0;\r\nbool custom1 = (SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) ||\r\n(SiS_Pr->SiS_CustomT == CUT_CLEVO1400);\r\nmodenum = SiS_GetReg(SiS_Pr->SiS_P3d4,0x34) & 0x7f;\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\n#ifdef SET_EMI\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nif(SiS_Pr->SiS_CustomT != CUT_CLEVO1400) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x30,0x0c);\r\n}\r\n}\r\n#endif\r\ndidpwd = SiS_HandlePWD(SiS_Pr);\r\nif( (modenum <= 0x13) ||\r\n(SiS_IsVAMode(SiS_Pr)) ||\r\n(!(SiS_IsDualEdge(SiS_Pr))) ) {\r\nif(!didpwd) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x26,0xfe);\r\nif(custom1) SiS_PanelDelay(SiS_Pr, 3);\r\n} else {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x26,0xfc);\r\n}\r\n}\r\nif(!custom1) {\r\nSiS_DDC2Delay(SiS_Pr,0xff00);\r\nSiS_DDC2Delay(SiS_Pr,0xe000);\r\nSiS_SetRegByte(SiS_Pr->SiS_P3c6,0x00);\r\npushax = SiS_GetReg(SiS_Pr->SiS_P3c4,0x06);\r\nif(IS_SIS740) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x06,0xE3);\r\n}\r\nSiS_PanelDelay(SiS_Pr, 3);\r\n}\r\n}\r\nif(!(SiS_IsNotM650orLater(SiS_Pr))) {\r\ntempah = 0xef;\r\nif(SiS_IsVAMode(SiS_Pr)) tempah = 0xf7;\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x4c,tempah);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x1F,~0x10);\r\n}\r\ntempah = 0x3f;\r\nif(SiS_IsDualEdge(SiS_Pr)) {\r\ntempah = 0x7f;\r\nif(!(SiS_IsVAMode(SiS_Pr))) tempah = 0xbf;\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x1F,tempah);\r\nif((SiS_IsVAMode(SiS_Pr)) ||\r\n((SiS_Pr->SiS_VBType & VB_SISLVDS) && (modenum <= 0x13))) {\r\nSiS_DisplayOff(SiS_Pr);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x32,0xDF);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x1E,0xDF);\r\n}\r\nif((!(SiS_IsVAMode(SiS_Pr))) ||\r\n((SiS_Pr->SiS_VBType & VB_SISLVDS) && (modenum <= 0x13))) {\r\nif(!(SiS_IsDualEdge(SiS_Pr))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x00,0xdf);\r\nSiS_DisplayOff(SiS_Pr);\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x00,0x80);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x32,0xDF);\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x00,0x10);\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1E,0xDF);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x00,temp);\r\n}\r\nif(SiS_IsNotM650orLater(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2e,0x7f);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif( (!(SiS_IsVAMode(SiS_Pr))) &&\r\n(!(SiS_CRT2IsLCD(SiS_Pr))) &&\r\n(!(SiS_IsDualEdge(SiS_Pr))) ) {\r\nif(custom1) SiS_PanelDelay(SiS_Pr, 2);\r\nif(!didpwd) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x26,0xFD);\r\n}\r\nif(custom1) SiS_PanelDelay(SiS_Pr, 4);\r\n}\r\nif(!custom1) {\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x06,pushax);\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nif(SiS_IsVAorLCD(SiS_Pr)) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 20);\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x08);\r\nSiS_PanelDelay(SiS_Pr, 3);\r\n}\r\n#endif\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x00,0xDF);\r\nSiS_DisplayOff(SiS_Pr);\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x00,0x80);\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x32,0xDF);\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x00,0x10);\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x00,temp);\r\n} else {\r\n#ifdef CONFIG_FB_SIS_300\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1E,0xDF);\r\nif( (!(SiS_CRT2IsLCD(SiS_Pr))) ||\r\n(!(SiS_CR36BIOSWord23d(SiS_Pr))) ) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x04);\r\n}\r\n#endif\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1) {\r\nSiS_SetCH700x(SiS_Pr,0x0E,0x09);\r\n}\r\nif(SiS_Pr->ChipType == SIS_730) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x11) & 0x08)) {\r\nSiS_WaitVBRetrace(SiS_Pr);\r\n}\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x08);\r\nSiS_PanelDelay(SiS_Pr, 3);\r\n}\r\n} else {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x11) & 0x08)) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x13) & 0x40)) {\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x06) & 0x1c)) {\r\nSiS_DisplayOff(SiS_Pr);\r\n}\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x08);\r\nSiS_PanelDelay(SiS_Pr, 3);\r\n}\r\n}\r\n}\r\n}\r\nSiS_DisplayOff(SiS_Pr);\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x32,0xDF);\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1E,0xDF);\r\nSiS_UnLockCRT2(SiS_Pr);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x01,0x80);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x02,0x40);\r\nif( (!(SiS_CRT2IsLCD(SiS_Pr))) ||\r\n(!(SiS_CR36BIOSWord23d(SiS_Pr))) ) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x04);\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(!(SiS_IsNotM650orLater(SiS_Pr))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x4c,~0x18);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->ChipType == SIS_740) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x61);\r\nif(temp < 1) {\r\nSiS_SetCH701x(SiS_Pr,0x76,0xac);\r\nSiS_SetCH701x(SiS_Pr,0x66,0x00);\r\n}\r\nif( (!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(SiS_IsTVOrYPbPrOrScart(SiS_Pr)) ) {\r\nSiS_SetCH701x(SiS_Pr,0x49,0x3e);\r\n}\r\n}\r\nif( (!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(SiS_IsVAMode(SiS_Pr)) ) {\r\nSiS_Chrontel701xBLOff(SiS_Pr);\r\nSiS_Chrontel701xOff(SiS_Pr);\r\n}\r\nif(SiS_Pr->ChipType != SIS_740) {\r\nif( (!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(SiS_IsTVOrYPbPrOrScart(SiS_Pr)) ) {\r\nSiS_SetCH701x(SiS_Pr,0x49,0x01);\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x08);\r\nSiS_PanelDelay(SiS_Pr, 3);\r\n}\r\nif( (SiS_Pr->SiS_IF_DEF_CH70xx == 0) ||\r\n(!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(!(SiS_IsTVOrYPbPrOrScart(SiS_Pr))) ) {\r\nSiS_DisplayOff(SiS_Pr);\r\n}\r\nif( (SiS_Pr->SiS_IF_DEF_CH70xx == 0) ||\r\n(!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(!(SiS_IsVAMode(SiS_Pr))) ) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x00,0x80);\r\n}\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2e,0x7f);\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x32,0xDF);\r\nif( (SiS_Pr->SiS_IF_DEF_CH70xx == 0) ||\r\n(!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(!(SiS_IsVAMode(SiS_Pr))) ) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x1E,0xDF);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x1e,0xdf);\r\nif(SiS_Pr->ChipType == SIS_550) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x1e,0xbf);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x1e,0xef);\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nif(SiS_IsLCDOrLCDA(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x1e,0xdf);\r\n}\r\n} else if(SiS_IsVAMode(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x1e,0xdf);\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_IsDualEdge(SiS_Pr)) {\r\n} else {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x13,0xfb);\r\n}\r\n}\r\nSiS_UnLockCRT2(SiS_Pr);\r\nif(SiS_Pr->ChipType == SIS_550) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x01,0x80);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x02,0x40);\r\n} else if( (SiS_Pr->SiS_IF_DEF_CH70xx == 0) ||\r\n(!(SiS_IsDualEdge(SiS_Pr))) ||\r\n(!(SiS_IsVAMode(SiS_Pr))) ) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2e,0xf7);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nif(!(SiS_WeHaveBacklightCtrl(SiS_Pr))) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x04);\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\n}\r\nstatic\r\nvoid\r\nSiS_EnableBridge(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp=0, tempah;\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short temp1, pushax=0;\r\nbool delaylong = false;\r\n#endif\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x02);\r\n} else if(SiS_Pr->SiS_VBType & VB_NoLCD) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x00);\r\n}\r\nif(SiS_Pr->SiS_VBType & (VB_SISLVDS | VB_NoLCD)) {\r\nif(!(SiS_CR36BIOSWord23d(SiS_Pr))) {\r\nSiS_PanelDelay(SiS_Pr, 0);\r\n}\r\n}\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_NoLCD) &&\r\n(SiS_CRT2IsLCD(SiS_Pr))) {\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_DisplayOn(SiS_Pr);\r\nSiS_UnLockCRT2(SiS_Pr);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x02,0xBF);\r\nif(SiS_BridgeInSlavemode(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x01,0x1F);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x01,0x1F,0x40);\r\n}\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x13) & 0x40)) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x16) & 0x10)) {\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nSiS_PanelDelay(SiS_Pr, 1);\r\n}\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x00);\r\n}\r\n}\r\n} else {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3c4,0x32) & 0xDF;\r\nif(SiS_BridgeInSlavemode(SiS_Pr)) {\r\ntempah = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(!(tempah & SetCRT2ToRAMDAC)) temp |= 0x20;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x32,temp);\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x00,0x1F,0x20);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x1F,0xC0);\r\nSiS_DisplayOn(SiS_Pr);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x16) & 0x10)) {\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nSiS_PanelDelay(SiS_Pr, 1);\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x01);\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\n#ifdef SET_EMI\r\nunsigned char r30=0, r31=0, r32=0, r33=0, cr36=0;\r\nint didpwd = 0;\r\n#endif\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x1f,0xef);\r\n#ifdef SET_EMI\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x30,0x0c);\r\n}\r\n#endif\r\n}\r\nif(!(SiS_IsNotM650orLater(SiS_Pr))) {\r\ntempah = 0x10;\r\nif(SiS_LCDAEnabled(SiS_Pr)) {\r\nif(SiS_TVEnabled(SiS_Pr)) tempah = 0x18;\r\nelse tempah = 0x08;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x4c,tempah);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_SetRegByte(SiS_Pr->SiS_P3c6,0x00);\r\nSiS_DisplayOff(SiS_Pr);\r\npushax = SiS_GetReg(SiS_Pr->SiS_P3c4,0x06);\r\nif(IS_SIS740) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3c4,0x06,0xE3);\r\n}\r\ndidpwd = SiS_HandlePWD(SiS_Pr);\r\nif(SiS_IsVAorLCD(SiS_Pr)) {\r\nif(!didpwd) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_Part4Port,0x26) & 0x02)) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 2);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x02);\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 2);\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_GenericDelay(SiS_Pr, 17664);\r\n}\r\n}\r\n} else {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 2);\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_GenericDelay(SiS_Pr, 17664);\r\n}\r\n}\r\n}\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3d4,0x31) & 0x40)) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 10);\r\ndelaylong = true;\r\n}\r\n}\r\nif(!(SiS_IsVAMode(SiS_Pr))) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3c4,0x32) & 0xDF;\r\nif(SiS_BridgeInSlavemode(SiS_Pr)) {\r\ntempah = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(!(tempah & SetCRT2ToRAMDAC)) {\r\nif(!(SiS_LCDAEnabled(SiS_Pr))) temp |= 0x20;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x32,temp);\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2e,0x7f);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2e,0x80);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\n}\r\n} else {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1e,0x20);\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x00,0x1f,0x20);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2e,0x80);\r\nif(SiS_Pr->SiS_VBType & VB_SISPOWER) {\r\nif( (SiS_LCDAEnabled(SiS_Pr)) ||\r\n(SiS_CRT2IsLCD(SiS_Pr)) ) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x2a,0x7f);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x30,0x7f);\r\n}\r\n}\r\ntempah = 0xc0;\r\nif(SiS_IsDualEdge(SiS_Pr)) {\r\ntempah = 0x80;\r\nif(!(SiS_IsVAMode(SiS_Pr))) tempah = 0x40;\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x1F,tempah);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nSiS_PanelDelay(SiS_Pr, 2);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x1f,0x10);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2e,0x80);\r\nif(SiS_Pr->SiS_CustomT != CUT_CLEVO1400) {\r\n#ifdef SET_EMI\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x30,0x0c);\r\nSiS_GenericDelay(SiS_Pr, 2048);\r\n}\r\n#endif\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x27,0x0c);\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\n#ifdef SET_EMI\r\ncr36 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36);\r\nif(SiS_Pr->SiS_ROMNew) {\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr = GetLCDStructPtr661_2(SiS_Pr);\r\nif(romptr) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x30,0x20);\r\nSiS_Pr->EMI_30 = 0;\r\nSiS_Pr->EMI_31 = ROMAddr[romptr + SiS_Pr->SiS_EMIOffset + 0];\r\nSiS_Pr->EMI_32 = ROMAddr[romptr + SiS_Pr->SiS_EMIOffset + 1];\r\nSiS_Pr->EMI_33 = ROMAddr[romptr + SiS_Pr->SiS_EMIOffset + 2];\r\nif(ROMAddr[romptr + 1] & 0x10) SiS_Pr->EMI_30 = 0x40;\r\nSiS_Pr->HaveEMI = SiS_Pr->HaveEMILCD = SiS_Pr->OverruleEMI = true;\r\n}\r\n}\r\nif(SiS_Pr->HaveEMI) {\r\nr30 = SiS_Pr->EMI_30; r31 = SiS_Pr->EMI_31;\r\nr32 = SiS_Pr->EMI_32; r33 = SiS_Pr->EMI_33;\r\n} else {\r\nr30 = 0;\r\n}\r\nif((!SiS_Pr->HaveEMI) || (!SiS_Pr->HaveEMILCD)) {\r\nswitch((cr36 & 0x0f)) {\r\ncase 2:\r\nr30 |= 0x40;\r\nif(SiS_Pr->SiS_CustomT == CUT_CLEVO1024) r30 &= ~0x40;\r\nif(!SiS_Pr->HaveEMI) {\r\nr31 = 0x05; r32 = 0x60; r33 = 0x33;\r\nif((cr36 & 0xf0) == 0x30) {\r\nr31 = 0x0d; r32 = 0x70; r33 = 0x40;\r\n}\r\n}\r\nbreak;\r\ncase 3:\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) r30 |= 0x40;\r\nif(!SiS_Pr->HaveEMI) {\r\nr31 = 0x12; r32 = 0xd0; r33 = 0x6b;\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) {\r\nr31 = 0x0d; r32 = 0x70; r33 = 0x6b;\r\n}\r\n}\r\nbreak;\r\ncase 9:\r\nr30 |= 0x40;\r\nif(!SiS_Pr->HaveEMI) {\r\nr31 = 0x05; r32 = 0x60; r33 = 0x00;\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAL1400_2) {\r\nr31 = 0x0d; r32 = 0x70; r33 = 0x40;\r\n}\r\n}\r\nbreak;\r\ncase 11:\r\nr30 |= 0x40;\r\nif(!SiS_Pr->HaveEMI) {\r\nr31 = 0x05; r32 = 0x60; r33 = 0x00;\r\n}\r\n}\r\n}\r\nif(!SiS_Pr->OverruleEMI) {\r\n#ifdef COMPAL_HACK\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAL1400_2) {\r\nif((cr36 & 0x0f) == 0x09) {\r\nr30 = 0x60; r31 = 0x05; r32 = 0x60; r33 = 0x00;\r\n}\r\n}\r\n#endif\r\n#ifdef COMPAQ_HACK\r\nif(SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) {\r\nif((cr36 & 0x0f) == 0x03) {\r\nr30 = 0x20; r31 = 0x12; r32 = 0xd0; r33 = 0x6b;\r\n}\r\n}\r\n#endif\r\n#ifdef ASUS_HACK\r\nif(SiS_Pr->SiS_CustomT == CUT_ASUSA2H_2) {\r\nif((cr36 & 0x0f) == 0x02) {\r\n}\r\n}\r\n#endif\r\n}\r\nif(!(SiS_Pr->OverruleEMI && (!r30) && (!r31) && (!r32) && (!r33))) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x30,0x20);\r\nSiS_GenericDelay(SiS_Pr, 2048);\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x31,r31);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x32,r32);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x33,r33);\r\n#endif\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x34,0x10);\r\n#ifdef SET_EMI\r\nif( (SiS_LCDAEnabled(SiS_Pr)) ||\r\n(SiS_CRT2IsLCD(SiS_Pr)) ) {\r\nif(r30 & 0x40) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 5);\r\nif(delaylong) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 5);\r\ndelaylong = false;\r\n}\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nif(SiS_Pr->SiS_CustomT == CUT_ASUSA2H_2) {\r\nSiS_GenericDelay(SiS_Pr, 1280);\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x30,0x40);\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\nif(!(SiS_WeHaveBacklightCtrl(SiS_Pr))) {\r\nif(SiS_IsVAorLCD(SiS_Pr)) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 10);\r\nif(delaylong) {\r\nSiS_PanelDelayLoop(SiS_Pr, 3, 10);\r\n}\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_GenericDelay(SiS_Pr, 2048);\r\nSiS_WaitVBRetrace(SiS_Pr);\r\n}\r\nif(!didpwd) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x01);\r\n} else {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x03);\r\n}\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x06,pushax);\r\nSiS_DisplayOn(SiS_Pr);\r\nSiS_SetRegByte(SiS_Pr->SiS_P3c6,0xff);\r\n}\r\nif(!(SiS_WeHaveBacklightCtrl(SiS_Pr))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x00,0x7f);\r\n}\r\n#endif\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x00);\r\nSiS_PanelDelay(SiS_Pr, 0);\r\n}\r\n}\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3c4,0x32) & 0xDF;\r\nif(SiS_BridgeInSlavemode(SiS_Pr)) {\r\ntempah = SiS_GetReg(SiS_Pr->SiS_P3d4,0x30);\r\nif(!(tempah & SetCRT2ToRAMDAC)) temp |= 0x20;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x32,temp);\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x2E);\r\nif(!(temp & 0x80)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2E,0x80);\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x00,0x1F,0x20);\r\nSiS_VBLongWait(SiS_Pr);\r\nSiS_DisplayOn(SiS_Pr);\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x00,0x7f);\r\n}\r\nSiS_VBLongWait(SiS_Pr);\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nSiS_PanelDelay(SiS_Pr, 1);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x00);\r\n}\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nif(SiS_Pr->ChipType == SIS_730) {\r\nSiS_PanelDelay(SiS_Pr, 1);\r\nSiS_PanelDelay(SiS_Pr, 1);\r\nSiS_PanelDelay(SiS_Pr, 1);\r\n}\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x00);\r\nif(!(SiS_CR36BIOSWord23d(SiS_Pr))) {\r\nSiS_PanelDelay(SiS_Pr, 0);\r\n}\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_DisplayOn(SiS_Pr);\r\nSiS_UnLockCRT2(SiS_Pr);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x02,0xBF);\r\nif(SiS_BridgeInSlavemode(SiS_Pr)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x01,0x1F);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x01,0x1F,0x40);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1) {\r\nif(!(SiS_CRT2IsLCD(SiS_Pr))) {\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nSiS_SetCH700x(SiS_Pr,0x0E,0x0B);\r\n}\r\n}\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x13) & 0x40)) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x16) & 0x10)) {\r\nif(!(SiS_CR36BIOSWord23b(SiS_Pr))) {\r\nSiS_PanelDelay(SiS_Pr, 1);\r\nSiS_PanelDelay(SiS_Pr, 1);\r\n}\r\nSiS_WaitVBRetrace(SiS_Pr);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x00);\r\n}\r\n}\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(!(SiS_IsNotM650orLater(SiS_Pr))) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x4c,0x18);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFB,0x00);\r\nSiS_PanelDelay(SiS_Pr, 0);\r\n}\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_UnLockCRT2(SiS_Pr);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2e,0xf7);\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\ntemp &= 0x20;\r\nSiS_Chrontel701xBLOff(SiS_Pr);\r\n}\r\nif(SiS_Pr->ChipType != SIS_550) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2e,0x7f);\r\n}\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(SiS_IsLCDOrLCDA(SiS_Pr)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1E,0x20);\r\n}\r\n}\r\n}\r\ntemp1 = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x2E);\r\nif(!(temp1 & 0x80)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2E,0x80);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(temp) {\r\nSiS_Chrontel701xBLOn(SiS_Pr);\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1E,0x20);\r\nif(SiS_Pr->ChipType == SIS_550) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1E,0x40);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1E,0x10);\r\n}\r\n}\r\n} else if(SiS_IsVAMode(SiS_Pr)) {\r\nif(SiS_Pr->ChipType != SIS_740) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1E,0x20);\r\n}\r\n}\r\nif(!(SiS_WeHaveBacklightCtrl(SiS_Pr))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x00,0x7f);\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(SiS_IsTVOrYPbPrOrScart(SiS_Pr)) {\r\nSiS_Chrontel701xOn(SiS_Pr);\r\n}\r\nif( (SiS_IsVAMode(SiS_Pr)) ||\r\n(SiS_IsLCDOrLCDA(SiS_Pr)) ) {\r\nSiS_ChrontelDoSomething1(SiS_Pr);\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(!(SiS_WeHaveBacklightCtrl(SiS_Pr))) {\r\nif( (SiS_IsVAMode(SiS_Pr)) ||\r\n(SiS_IsLCDOrLCDA(SiS_Pr)) ) {\r\nSiS_Chrontel701xBLOn(SiS_Pr);\r\nSiS_ChrontelInitTVVSync(SiS_Pr);\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_IF_DEF_CH70xx == 0) {\r\nif(!(SiS_WeHaveBacklightCtrl(SiS_Pr))) {\r\nif(SiS_CRT2IsLCD(SiS_Pr)) {\r\nSiS_PanelDelay(SiS_Pr, 1);\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xF7,0x00);\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_SetCRT2Offset(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RRTI)\r\n{\r\nunsigned short offset;\r\nunsigned char temp;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) return;\r\noffset = SiS_GetOffset(SiS_Pr,ModeNo,ModeIdIndex,RRTI);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x07,(offset & 0xFF));\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x09,(offset >> 8));\r\ntemp = (unsigned char)(((offset >> 3) & 0xFF) + 1);\r\nif(offset & 0x07) temp++;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x03,temp);\r\n}\r\nstatic void\r\nSiS_SetCRT2Sync(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short tempah=0, tempbl, infoflag;\r\ntempbl = 0xC0;\r\nif(SiS_Pr->UseCustomMode) {\r\ninfoflag = SiS_Pr->CInfoFlag;\r\n} else {\r\ninfoflag = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_InfoFlag;\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\ntempah = 0;\r\n} else if((SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) && (SiS_Pr->SiS_LCDInfo & LCDSync)) {\r\ntempah = SiS_Pr->SiS_LCDInfo;\r\n} else tempah = infoflag >> 8;\r\ntempah &= 0xC0;\r\ntempah |= 0x20;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit)) tempah |= 0x10;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif((SiS_Pr->SiS_CustomT == CUT_BARCO1366) ||\r\n(SiS_Pr->SiS_CustomT == CUT_BARCO1024)) {\r\ntempah |= 0xf0;\r\n}\r\nif( (SiS_Pr->SiS_IF_DEF_FSTN) ||\r\n(SiS_Pr->SiS_IF_DEF_DSTN) ||\r\n(SiS_Pr->SiS_IF_DEF_TRUMPION) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL848) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL856) ) {\r\ntempah |= 0x30;\r\n}\r\nif( (SiS_Pr->SiS_IF_DEF_FSTN) ||\r\n(SiS_Pr->SiS_IF_DEF_DSTN) ) {\r\ntempah &= ~0xc0;\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\ntempah >>= 3;\r\ntempah &= 0x18;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,0xE7,tempah);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0F,0xe0);\r\n}\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0F,tempah);\r\n}\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\ntempah = infoflag >> 8;\r\ntempbl = 0;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDSync) {\r\ntempah = SiS_Pr->SiS_LCDInfo;\r\ntempbl = (tempah >> 6) & 0x03;\r\n}\r\n}\r\ntempah &= 0xC0;\r\ntempah |= 0x20;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit)) tempah |= 0x10;\r\ntempah |= 0xc0;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0F,tempah);\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) && (!(SiS_Pr->SiS_VBType & VB_NoLCD))) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1a,0xf0,tempbl);\r\n}\r\n} else {\r\ntempah = ((infoflag >> 8) & 0xc0) | 0x20;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit)) tempah |= 0x10;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0F,tempah);\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\ntempbl = 0;\r\nif((SiS_Pr->SiS_CustomT == CUT_COMPAQ1280) &&\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024)) {\r\ntempah = infoflag >> 8;\r\nif(SiS_Pr->SiS_LCDInfo & LCDSync) {\r\ntempbl = ((SiS_Pr->SiS_LCDInfo & 0xc0) >> 6);\r\n}\r\n} else if((SiS_Pr->SiS_CustomT == CUT_CLEVO1400) &&\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050)) {\r\ntempah = infoflag >> 8;\r\ntempbl = 0x03;\r\n} else {\r\ntempah = SiS_GetReg(SiS_Pr->SiS_P3d4,0x37);\r\ntempbl = (tempah >> 6) & 0x03;\r\ntempbl |= 0x08;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit)) tempbl |= 0x04;\r\n}\r\ntempah &= 0xC0;\r\ntempah |= 0x20;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit)) tempah |= 0x10;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) tempah |= 0xc0;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0F,tempah);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1a,0xf0,tempbl);\r\n}\r\n}\r\n} else {\r\ntempah = tempbl = infoflag >> 8;\r\nif(!SiS_Pr->UseCustomMode) {\r\ntempbl = 0;\r\nif((SiS_Pr->SiS_VBType & VB_SIS30xC) && (SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC)) {\r\nif(ModeNo <= 0x13) {\r\ntempah = SiS_GetRegByte((SiS_Pr->SiS_P3ca+0x02));\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDSync) {\r\ntempah = SiS_Pr->SiS_LCDInfo;\r\ntempbl = (tempah >> 6) & 0x03;\r\n}\r\n}\r\n}\r\n}\r\ntempah &= 0xC0;\r\ntempah |= 0x20;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit)) tempah |= 0x10;\r\nif(SiS_Pr->SiS_VBType & VB_NoLCD) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) tempah |= 0xc0;\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SIS30xC) && (SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC)) {\r\ntempah >>= 3;\r\ntempah &= 0x18;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,0xe7,tempah);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0F,tempah);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1a,0xf0,tempbl);\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_SetCRT2FIFO_300(struct SiS_Private *SiS_Pr,unsigned short ModeNo)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short temp, index, modeidindex, refreshratetableindex;\r\nunsigned short VCLK = 0, MCLK, colorth = 0, data2 = 0;\r\nunsigned short tempbx, tempcl, CRT1ModeNo, CRT2ModeNo, SelectRate_backup;\r\nunsigned int data, pci50, pciA0;\r\nstatic const unsigned char colortharray[] = {\r\n1, 1, 2, 2, 3, 4\r\n};\r\nSelectRate_backup = SiS_Pr->SiS_SelectCRT2Rate;\r\nif(!SiS_Pr->CRT1UsesCustomMode) {\r\nCRT1ModeNo = SiS_Pr->SiS_CRT1Mode;\r\nSiS_SearchModeID(SiS_Pr, &CRT1ModeNo, &modeidindex);\r\nSiS_Pr->SiS_SetFlag &= (~ProgrammingCRT2);\r\nSiS_Pr->SiS_SelectCRT2Rate = 0;\r\nrefreshratetableindex = SiS_GetRatePtr(SiS_Pr, CRT1ModeNo, modeidindex);\r\nif(CRT1ModeNo >= 0x13) {\r\nindex = SiS_GetRefCRTVCLK(SiS_Pr, refreshratetableindex, SiS_Pr->SiS_UseWide);\r\nVCLK = SiS_Pr->SiS_VCLKData[index].CLOCK;\r\ncolorth = SiS_GetColorDepth(SiS_Pr,CRT1ModeNo,modeidindex) >> 1;\r\nif(!colorth) colorth++;\r\n}\r\n} else {\r\nCRT1ModeNo = 0xfe;\r\nVCLK = SiS_Pr->CSRClock_CRT1;\r\ncolorth = colortharray[((SiS_Pr->CModeFlag_CRT1 & ModeTypeMask) - 2)];\r\n}\r\nif(CRT1ModeNo >= 0x13) {\r\nif(SiS_Pr->ChipType == SIS_300) {\r\nindex = SiS_GetReg(SiS_Pr->SiS_P3c4,0x3A);\r\n} else {\r\nindex = SiS_GetReg(SiS_Pr->SiS_P3c4,0x1A);\r\n}\r\nindex &= 0x07;\r\nMCLK = SiS_Pr->SiS_MCLKData_0[index].CLOCK;\r\ntemp = ((SiS_GetReg(SiS_Pr->SiS_P3c4,0x14) >> 6) & 0x03) << 1;\r\nif(!temp) temp++;\r\ntemp <<= 2;\r\ndata2 = temp - ((colorth * VCLK) / MCLK);\r\ntemp = (28 * 16) % data2;\r\ndata2 = (28 * 16) / data2;\r\nif(temp) data2++;\r\nif(SiS_Pr->ChipType == SIS_300) {\r\nSiS_GetFIFOThresholdIndex300(SiS_Pr, &tempbx, &tempcl);\r\ndata = SiS_GetFIFOThresholdB300(tempbx, tempcl);\r\n} else {\r\npci50 = sisfb_read_nbridge_pci_dword(SiS_Pr, 0x50);\r\npciA0 = sisfb_read_nbridge_pci_dword(SiS_Pr, 0xa0);\r\nif(SiS_Pr->ChipType == SIS_730) {\r\nindex = (unsigned short)(((pciA0 >> 28) & 0x0f) * 3);\r\nindex += (unsigned short)(((pci50 >> 9)) & 0x03);\r\nindex = 0;\r\n} else {\r\npci50 >>= 24;\r\npciA0 >>= 24;\r\nindex = (pci50 >> 1) & 0x07;\r\nif(pci50 & 0x01) index += 6;\r\nif(!(pciA0 & 0x01)) index += 24;\r\nif(SiS_GetReg(SiS_Pr->SiS_P3c4,0x14) & 0x80) index += 12;\r\n}\r\ndata = SiS_GetLatencyFactor630(SiS_Pr, index) + 15;\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3c4,0x14) & 0x80)) data += 5;\r\n}\r\ndata += data2;\r\nSiS_Pr->SiS_SetFlag |= ProgrammingCRT2;\r\nSiS_Pr->SiS_SelectCRT2Rate = SelectRate_backup;\r\nif(!SiS_Pr->UseCustomMode) {\r\nCRT2ModeNo = ModeNo;\r\nSiS_SearchModeID(SiS_Pr, &CRT2ModeNo, &modeidindex);\r\nrefreshratetableindex = SiS_GetRatePtr(SiS_Pr, CRT2ModeNo, modeidindex);\r\nindex = SiS_GetVCLK2Ptr(SiS_Pr, CRT2ModeNo, modeidindex, refreshratetableindex);\r\nVCLK = SiS_Pr->SiS_VCLKData[index].CLOCK;\r\nif((SiS_Pr->SiS_CustomT == CUT_BARCO1366) || (SiS_Pr->SiS_CustomT == CUT_BARCO1024)) {\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(ROMAddr[0x220] & 0x01) {\r\nVCLK = ROMAddr[0x229] | (ROMAddr[0x22a] << 8);\r\n}\r\n}\r\n}\r\n} else {\r\nCRT2ModeNo = 0xfe;\r\nVCLK = SiS_Pr->CSRClock;\r\n}\r\ncolorth = SiS_GetColorDepth(SiS_Pr,CRT2ModeNo,modeidindex) >> 1;\r\nif(!colorth) colorth++;\r\ndata = data * VCLK * colorth;\r\ntemp = data % (MCLK << 4);\r\ndata = data / (MCLK << 4);\r\nif(temp) data++;\r\nif(data < 6) data = 6;\r\nelse if(data > 0x14) data = 0x14;\r\nif(SiS_Pr->ChipType == SIS_300) {\r\ntemp = 0x16;\r\nif((data <= 0x0f) || (SiS_Pr->SiS_LCDResInfo == Panel_1280x1024))\r\ntemp = 0x13;\r\n} else {\r\ntemp = 0x16;\r\nif(( (SiS_Pr->ChipType == SIS_630) ||\r\n(SiS_Pr->ChipType == SIS_730) ) &&\r\n(SiS_Pr->ChipRevision >= 0x30))\r\ntemp = 0x1b;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x01,0xe0,temp);\r\nif((SiS_Pr->ChipType == SIS_630) &&\r\n(SiS_Pr->ChipRevision >= 0x30)) {\r\nif(data > 0x13) data = 0x13;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x02,0xe0,data);\r\n} else {\r\nSiS_Pr->SiS_SetFlag |= ProgrammingCRT2;\r\nSiS_Pr->SiS_SelectCRT2Rate = SelectRate_backup;\r\n}\r\n}\r\nstatic void\r\nSiS_SetCRT2FIFO_310(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x01,0x3B);\r\nif( (SiS_Pr->ChipType == SIS_760) &&\r\n(SiS_Pr->SiS_SysFlags & SF_760LFB) &&\r\n(SiS_Pr->SiS_ModeType == Mode32Bpp) &&\r\n(SiS_Pr->SiS_VGAHDE >= 1280) &&\r\n(SiS_Pr->SiS_VGAVDE >= 1024) ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2f,0x03);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x01,0x3b);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x4d,0xc0);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2f,0x01);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x4d,0xc0);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x02,0x6e);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x02,~0x3f,0x04);\r\n}\r\n}\r\nstatic unsigned short\r\nSiS_GetVGAHT2(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned int tempax,tempbx;\r\ntempbx = (SiS_Pr->SiS_VGAVT - SiS_Pr->SiS_VGAVDE) * SiS_Pr->SiS_RVBHCMAX;\r\ntempax = (SiS_Pr->SiS_VT - SiS_Pr->SiS_VDE) * SiS_Pr->SiS_RVBHCFACT;\r\ntempax = (tempax * SiS_Pr->SiS_HT) / tempbx;\r\nreturn (unsigned short)tempax;\r\n}\r\nstatic void\r\nSiS_SetGroup1_301(struct SiS_Private *SiS_Pr, unsigned short ModeNo,unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short temp, modeflag, i, j, xres=0, VGAVDE;\r\nstatic const unsigned short CRTranslation[] = {\r\n0x03, 0x04, 0x05, 0x06, 0x07, 0x08, 0x09, 0x0a,\r\n0x00, 0x0b, 0x17, 0x18, 0x19, 0x00, 0x1a, 0x00,\r\n0x0c, 0x0d, 0x0e, 0x00, 0x0f, 0x10, 0x11, 0x00\r\n};\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\n} else if(SiS_Pr->UseCustomMode) {\r\nmodeflag = SiS_Pr->CModeFlag;\r\nxres = SiS_Pr->CHDisplay;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nxres = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].XRes;\r\n}\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(xres >= 1600) {\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x31,0x04);\r\n}\r\n}\r\nSiS_Pr->CHTotal = 8224;\r\nSiS_Pr->CHDisplay = SiS_Pr->SiS_VGAHDE;\r\nif(modeflag & HalfDCLK) SiS_Pr->CHDisplay >>= 1;\r\nSiS_Pr->CHBlankStart = SiS_Pr->CHDisplay;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_Pr->CHBlankStart += 16;\r\n}\r\nSiS_Pr->CHBlankEnd = 32;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(xres == 1600) SiS_Pr->CHBlankEnd += 80;\r\n}\r\ntemp = SiS_Pr->SiS_VGAHT - 96;\r\nif(!(modeflag & HalfDCLK)) temp -= 32;\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x04);\r\ntemp |= ((SiS_GetReg(SiS_Pr->SiS_P3c4,0x0b) & 0xc0) << 2);\r\ntemp -= 3;\r\ntemp <<= 3;\r\n} else {\r\nif(SiS_Pr->SiS_RVBHRS2) temp = SiS_Pr->SiS_RVBHRS2;\r\n}\r\nSiS_Pr->CHSyncStart = temp;\r\nSiS_Pr->CHSyncEnd = 0xffe8;\r\nSiS_Pr->CVTotal = 2049;\r\nVGAVDE = SiS_Pr->SiS_VGAVDE;\r\nif (VGAVDE == 357) VGAVDE = 350;\r\nelse if(VGAVDE == 360) VGAVDE = 350;\r\nelse if(VGAVDE == 375) VGAVDE = 350;\r\nelse if(VGAVDE == 405) VGAVDE = 400;\r\nelse if(VGAVDE == 420) VGAVDE = 400;\r\nelse if(VGAVDE == 525) VGAVDE = 480;\r\nelse if(VGAVDE == 1056) VGAVDE = 1024;\r\nSiS_Pr->CVDisplay = VGAVDE;\r\nSiS_Pr->CVBlankStart = SiS_Pr->CVDisplay;\r\nSiS_Pr->CVBlankEnd = 1;\r\nif(ModeNo == 0x3c) SiS_Pr->CVBlankEnd = 226;\r\ntemp = (SiS_Pr->SiS_VGAVT - VGAVDE) >> 1;\r\nSiS_Pr->CVSyncStart = VGAVDE + temp;\r\ntemp >>= 3;\r\nSiS_Pr->CVSyncEnd = SiS_Pr->CVSyncStart + temp;\r\nSiS_CalcCRRegisters(SiS_Pr, 0);\r\nSiS_Pr->CCRT1CRTC[16] &= ~0xE0;\r\nfor(i = 0; i <= 7; i++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,CRTranslation[i],SiS_Pr->CCRT1CRTC[i]);\r\n}\r\nfor(i = 0x10, j = 8; i <= 0x12; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,CRTranslation[i],SiS_Pr->CCRT1CRTC[j]);\r\n}\r\nfor(i = 0x15, j = 11; i <= 0x16; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,CRTranslation[i],SiS_Pr->CCRT1CRTC[j]);\r\n}\r\nfor(i = 0x0a, j = 13; i <= 0x0c; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,CRTranslation[i],SiS_Pr->CCRT1CRTC[j]);\r\n}\r\ntemp = SiS_Pr->CCRT1CRTC[16] & 0xE0;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,CRTranslation[0x0E],0x1F,temp);\r\ntemp = (SiS_Pr->CCRT1CRTC[16] & 0x01) << 5;\r\nif(modeflag & DoubleScanMode) temp |= 0x80;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,CRTranslation[0x09],0x5F,temp);\r\ntemp = 0;\r\ntemp |= (SiS_GetReg(SiS_Pr->SiS_P3c4,0x01) & 0x01);\r\nif(modeflag & HalfDCLK) temp |= 0x08;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x16,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0F,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x12,0x00);\r\ntemp = 0;\r\nif(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit) {\r\ntemp = (SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x01) << 7;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1A,temp);\r\ntemp = SiS_GetRegByte((SiS_Pr->SiS_P3ca+0x02));\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,temp);\r\n}\r\nstatic void\r\nSiS_SetGroup1_LVDS(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short modeflag, resinfo = 0;\r\nunsigned short push2, tempax, tempbx, tempcx, temp;\r\nunsigned int tempeax = 0, tempebx, tempecx, tempvcfact = 0;\r\nbool islvds = false, issis = false, chkdclkfirst = false;\r\n#ifdef CONFIG_FB_SIS_300\r\nunsigned short crt2crtc = 0;\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short pushcx;\r\n#endif\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nresinfo = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo;\r\n#ifdef CONFIG_FB_SIS_300\r\ncrt2crtc = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n#endif\r\n} else if(SiS_Pr->UseCustomMode) {\r\nmodeflag = SiS_Pr->CModeFlag;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n#ifdef CONFIG_FB_SIS_300\r\ncrt2crtc = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\n#endif\r\n}\r\nif((SiS_Pr->SiS_IF_DEF_LVDS == 1) || (SiS_Pr->SiS_VBType & VB_NoLCD)) {\r\nislvds = true;\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SISVB) && (!(SiS_Pr->SiS_VBType & VB_NoLCD))) {\r\nissis = true;\r\n}\r\nif((SiS_Pr->ChipType >= SIS_315H) && (islvds) && (!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA))) {\r\nif((!SiS_Pr->SiS_IF_DEF_FSTN) && (!SiS_Pr->SiS_IF_DEF_DSTN)) {\r\nchkdclkfirst = true;\r\n}\r\n}\r\n#ifdef CONFIG_FB_SIS_315\r\nif((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\nif(IS_SIS330) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2D,0x10);\r\n} else if(IS_SIS740) {\r\nif(islvds) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,0xfb,0x04);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2D,0x03);\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2D,0x10);\r\n}\r\n} else {\r\nif(islvds) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,0xfb,0x04);\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2D,0x00);\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x2D,0x0f);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xC) {\r\nif((SiS_Pr->SiS_LCDResInfo == Panel_1024x768) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x2D,0x20);\r\n}\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\ntempax = SiS_Pr->SiS_LCDHDES;\r\nif(islvds) {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!SiS_Pr->SiS_IF_DEF_FSTN && !SiS_Pr->SiS_IF_DEF_DSTN) {\r\nif((SiS_Pr->SiS_LCDResInfo == Panel_640x480) &&\r\n(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode))) {\r\ntempax -= 8;\r\n}\r\n}\r\n}\r\n}\r\ntemp = (tempax & 0x0007);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1A,temp);\r\ntemp = (tempax >> 3) & 0x00FF;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x16,temp);\r\ntempbx = SiS_Pr->SiS_HDE;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\ntempbx = SiS_Pr->PanelXRes;\r\n}\r\nif((SiS_Pr->SiS_LCDResInfo == Panel_320x240_1) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_320x240_2) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_320x240_3)) {\r\ntempbx >>= 1;\r\n}\r\n}\r\ntempax += tempbx;\r\nif(tempax >= SiS_Pr->SiS_HT) tempax -= SiS_Pr->SiS_HT;\r\ntemp = tempax;\r\nif(temp & 0x07) temp += 8;\r\ntemp >>= 3;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x17,temp);\r\ntempcx = (SiS_Pr->SiS_HT - tempbx) >> 2;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nif(SiS_Pr->PanelHRS != 999) tempcx = SiS_Pr->PanelHRS;\r\n}\r\n}\r\ntempcx += tempax;\r\nif(tempcx >= SiS_Pr->SiS_HT) tempcx -= SiS_Pr->SiS_HT;\r\ntemp = (tempcx >> 3) & 0x00FF;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nswitch(ModeNo) {\r\ncase 0x04:\r\ncase 0x05:\r\ncase 0x0d: temp = 0x56; break;\r\ncase 0x10: temp = 0x60; break;\r\ncase 0x13: temp = 0x5f; break;\r\ncase 0x40:\r\ncase 0x41:\r\ncase 0x4f:\r\ncase 0x43:\r\ncase 0x44:\r\ncase 0x62:\r\ncase 0x56:\r\ncase 0x53:\r\ncase 0x5d:\r\ncase 0x5e: temp = 0x54; break;\r\n}\r\n}\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x14,temp);\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\ntemp += 2;\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\ntemp += 8;\r\nif(SiS_Pr->PanelHRE != 999) {\r\ntemp = tempcx + SiS_Pr->PanelHRE;\r\nif(temp >= SiS_Pr->SiS_HT) temp -= SiS_Pr->SiS_HT;\r\ntemp >>= 3;\r\n}\r\n}\r\n} else {\r\ntemp += 10;\r\n}\r\ntemp &= 0x1F;\r\ntemp |= ((tempcx & 0x07) << 5);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x15,temp);\r\ntempax = SiS_Pr->SiS_VGAVDE;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\ntempax = SiS_Pr->PanelYRes;\r\n}\r\n}\r\ntempbx = SiS_Pr->SiS_LCDVDES + tempax;\r\nif(tempbx >= SiS_Pr->SiS_VT) tempbx -= SiS_Pr->SiS_VT;\r\npush2 = tempbx;\r\ntempcx = SiS_Pr->SiS_VGAVT - SiS_Pr->SiS_VGAVDE;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\ntempcx = SiS_Pr->SiS_VGAVT - SiS_Pr->PanelYRes;\r\n}\r\n}\r\n}\r\nif(islvds) tempcx >>= 1;\r\nelse tempcx >>= 2;\r\nif( (SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) &&\r\n(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) &&\r\n(SiS_Pr->PanelVRS != 999) ) {\r\ntempcx = SiS_Pr->PanelVRS;\r\ntempbx += tempcx;\r\nif(issis) tempbx++;\r\n} else {\r\ntempbx += tempcx;\r\nif(SiS_Pr->ChipType < SIS_315H) tempbx++;\r\nelse if(issis) tempbx++;\r\n}\r\nif(tempbx >= SiS_Pr->SiS_VT) tempbx -= SiS_Pr->SiS_VT;\r\ntemp = tempbx & 0x00FF;\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(ModeNo == 0x10) temp = 0xa9;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,temp);\r\ntempcx >>= 3;\r\ntempcx++;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nif(SiS_Pr->PanelVRE != 999) tempcx = SiS_Pr->PanelVRE;\r\n}\r\n}\r\ntempcx += tempbx;\r\ntemp = tempcx & 0x000F;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0xF0,temp);\r\ntemp = ((tempbx >> 8) & 0x07) << 3;\r\nif(SiS_Pr->SiS_IF_DEF_FSTN || SiS_Pr->SiS_IF_DEF_DSTN) {\r\nif(SiS_Pr->SiS_HDE != 640) {\r\nif(SiS_Pr->SiS_VGAVDE != SiS_Pr->SiS_VDE) temp |= 0x40;\r\n}\r\n} else if(SiS_Pr->SiS_VGAVDE != SiS_Pr->SiS_VDE) temp |= 0x40;\r\nif(SiS_Pr->SiS_SetFlag & EnableLVDSDDA) temp |= 0x40;\r\ntempbx = 0x87;\r\nif((SiS_Pr->ChipType >= SIS_315H) ||\r\n(SiS_Pr->ChipRevision >= 0x30)) {\r\ntempbx = 0x07;\r\nif((SiS_Pr->SiS_IF_DEF_CH70xx == 1) && (SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\nif(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x03) temp |= 0x80;\r\n}\r\nif(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nif(SiS_GetReg(SiS_Pr->SiS_P3c4,0x06) & 0x10) temp |= 0x80;\r\n} else {\r\nif(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x01) temp |= 0x80;\r\n}\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x1A,tempbx,temp);\r\ntempbx = push2;\r\ntempcx = SiS_Pr->SiS_LCDVDES;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_640x480:\r\ntempbx = SiS_Pr->SiS_VGAVDE - 1;\r\ntempcx = SiS_Pr->SiS_VGAVDE;\r\nbreak;\r\ncase Panel_800x600:\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nif(resinfo == SIS_RI_800x600) tempcx++;\r\n}\r\nbreak;\r\ncase Panel_1024x600:\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nif(resinfo == SIS_RI_1024x600) tempcx++;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(resinfo == SIS_RI_800x600) tempcx++;\r\n}\r\n}\r\nbreak;\r\ncase Panel_1024x768:\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nif(resinfo == SIS_RI_1024x768) tempcx++;\r\n}\r\n}\r\nbreak;\r\n}\r\n}\r\ntemp = ((tempbx >> 8) & 0x07) << 3;\r\ntemp |= ((tempcx >> 8) & 0x07);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1D,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1C,tempbx);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1B,tempcx);\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\ntempeax = SiS_Pr->SiS_VGAVDE << 6;\r\ntemp = (tempeax % (unsigned int)SiS_Pr->SiS_VDE);\r\ntempeax = tempeax / (unsigned int)SiS_Pr->SiS_VDE;\r\nif(temp) tempeax++;\r\nif(SiS_Pr->SiS_SetFlag & EnableLVDSDDA) tempeax = 0x3F;\r\ntemp = (unsigned short)(tempeax & 0x00FF);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1E,temp);\r\ntempvcfact = temp;\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\ntempeax = SiS_Pr->SiS_VGAVDE << 18;\r\ntempebx = SiS_Pr->SiS_VDE;\r\ntemp = (tempeax % tempebx);\r\ntempeax = tempeax / tempebx;\r\nif(temp) tempeax++;\r\ntempvcfact = tempeax;\r\ntemp = (unsigned short)(tempeax & 0x00FF);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x37,temp);\r\ntemp = (unsigned short)((tempeax & 0x00FF00) >> 8);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x36,temp);\r\ntemp = (unsigned short)((tempeax & 0x00030000) >> 16);\r\nif(SiS_Pr->SiS_VDE == SiS_Pr->SiS_VGAVDE) temp |= 0x04;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x35,temp);\r\nif(SiS_Pr->SiS_VBType & VB_SISPART4SCALER) {\r\ntemp = (unsigned short)(tempeax & 0x00FF);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x3c,temp);\r\ntemp = (unsigned short)((tempeax & 0x00FF00) >> 8);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x3b,temp);\r\ntemp = (unsigned short)(((tempeax & 0x00030000) >> 16) << 6);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x3a,0x3f,temp);\r\ntemp = 0;\r\nif(SiS_Pr->SiS_VDE != SiS_Pr->SiS_VGAVDE) temp |= 0x08;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x30,0xf3,temp);\r\n}\r\n#endif\r\n}\r\ntempeax = SiS_Pr->SiS_VGAHDE;\r\nif(chkdclkfirst) {\r\nif(modeflag & HalfDCLK) tempeax >>= 1;\r\n}\r\ntempebx = tempeax << 16;\r\nif(SiS_Pr->SiS_HDE == tempeax) {\r\ntempecx = 0xFFFF;\r\n} else {\r\ntempecx = tempebx / SiS_Pr->SiS_HDE;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(tempebx % SiS_Pr->SiS_HDE) tempecx++;\r\n}\r\n}\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\ntempeax = (tempebx / tempecx) - 1;\r\n} else {\r\ntempeax = ((SiS_Pr->SiS_VGAHT << 16) / tempecx) - 1;\r\n}\r\ntempecx = (tempecx << 16) | (tempeax & 0xFFFF);\r\ntemp = (unsigned short)(tempecx & 0x00FF);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1F,temp);\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\ntempeax = (SiS_Pr->SiS_VGAVDE << 18) / tempvcfact;\r\ntempbx = (unsigned short)(tempeax & 0xFFFF);\r\n} else {\r\ntempeax = SiS_Pr->SiS_VGAVDE << 6;\r\ntempbx = tempvcfact & 0x3f;\r\nif(tempbx == 0) tempbx = 64;\r\ntempeax /= tempbx;\r\ntempbx = (unsigned short)(tempeax & 0xFFFF);\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) tempbx--;\r\nif(SiS_Pr->SiS_SetFlag & EnableLVDSDDA) {\r\nif((!SiS_Pr->SiS_IF_DEF_FSTN) && (!SiS_Pr->SiS_IF_DEF_DSTN)) tempbx = 1;\r\nelse if(SiS_Pr->SiS_LCDResInfo != Panel_640x480) tempbx = 1;\r\n}\r\ntemp = ((tempbx >> 8) & 0x07) << 3;\r\ntemp = temp | ((tempecx >> 8) & 0x07);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x20,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x21,tempbx);\r\ntempecx >>= 16;\r\nif(!chkdclkfirst) {\r\nif(modeflag & HalfDCLK) tempecx >>= 1;\r\n}\r\ntemp = (unsigned short)((tempecx & 0xFF00) >> 8);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x22,temp);\r\ntemp = (unsigned short)(tempecx & 0x00FF);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x23,temp);\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nif((islvds) || (SiS_Pr->SiS_VBInfo & VB_SISLVDS)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1e,0x20);\r\n}\r\n} else {\r\nif(islvds) {\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1e,0x03);\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1e,0x23);\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_IF_DEF_TRUMPION) {\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned char *trumpdata;\r\nint i, j = crt2crtc;\r\nunsigned char TrumpMode13[4] = { 0x01, 0x10, 0x2c, 0x00 };\r\nunsigned char TrumpMode10_1[4] = { 0x01, 0x10, 0x27, 0x00 };\r\nunsigned char TrumpMode10_2[4] = { 0x01, 0x16, 0x10, 0x00 };\r\nif(SiS_Pr->SiS_UseROM) {\r\ntrumpdata = &ROMAddr[0x8001 + (j * 80)];\r\n} else {\r\nif(SiS_Pr->SiS_LCDTypeInfo == 0x0e) j += 7;\r\ntrumpdata = &SiS300_TrumpionData[j][0];\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x02,0xbf);\r\nfor(i=0; i<5; i++) {\r\nSiS_SetTrumpionBlock(SiS_Pr, trumpdata);\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(ModeNo == 0x13) {\r\nfor(i=0; i<4; i++) {\r\nSiS_SetTrumpionBlock(SiS_Pr, &TrumpMode13[0]);\r\n}\r\n} else if(ModeNo == 0x10) {\r\nfor(i=0; i<4; i++) {\r\nSiS_SetTrumpionBlock(SiS_Pr, &TrumpMode10_1[0]);\r\nSiS_SetTrumpionBlock(SiS_Pr, &TrumpMode10_2[0]);\r\n}\r\n}\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x02,0x40);\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->SiS_IF_DEF_FSTN || SiS_Pr->SiS_IF_DEF_DSTN) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x25,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x26,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x27,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x28,0x87);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x29,0x5A);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2A,0x4B);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x44,~0x07,0x03);\r\ntempax = SiS_Pr->SiS_HDE;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_320x240_1 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_2 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_3) tempax >>= 1;\r\ntempax += 64;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x38,tempax & 0xff);\r\ntemp = (tempax >> 8) << 3;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x35,~0x078,temp);\r\ntempax += 32;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x39,tempax & 0xff);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3A,0x00);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x3C,~0x007);\r\ntempax = SiS_Pr->SiS_VDE;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_320x240_1 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_2 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_3) tempax >>= 1;\r\ntempax >>= 1;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3B,tempax & 0xff);\r\ntemp = (tempax >> 8) << 3;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x3C,~0x038,temp);\r\ntempeax = SiS_Pr->SiS_HDE;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_320x240_1 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_2 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_3) tempeax >>= 1;\r\ntempeax <<= 2;\r\ntemp = tempeax & 0x7f;\r\ntempeax >>= 7;\r\nif(temp) tempeax++;\r\ntemp = tempeax & 0x3f;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x45,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3F,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3E,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3D,0x10);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x3C,~0x040);\r\ntempax = SiS_Pr->SiS_HDE;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_320x240_1 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_2 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_3) tempax >>= 1;\r\ntempax >>= 4;\r\npushcx = tempax;\r\ntemp = tempax & 0x00FF;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x43,temp);\r\ntemp = ((tempax & 0xFF00) >> 8) << 3;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port, 0x44, 0x07, temp);\r\ntempax = SiS_Pr->SiS_VDE;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_320x240_1 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_2 ||\r\nSiS_Pr->SiS_LCDResInfo == Panel_320x240_3) tempax >>= 1;\r\ntempeax = tempax * pushcx;\r\ntemp = tempeax & 0xFF;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x42,temp);\r\ntemp = (tempeax & 0xFF00) >> 8;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x41,temp);\r\ntemp = ((tempeax & 0xFF0000) >> 16) | 0x10;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x40,temp);\r\ntemp = ((tempeax & 0x01000000) >> 24) << 7;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port, 0x3C, 0x7F, temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2F,0x03);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x03,0x50);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x04,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2F,0x01);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x19,0x38);\r\nif(SiS_Pr->SiS_IF_DEF_FSTN) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2b,0x02);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2c,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2d,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x35,0x0c);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x36,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x37,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x38,0x80);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x39,0xA0);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3a,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3b,0xf0);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3c,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3d,0x10);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3e,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x3f,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x40,0x10);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x41,0x25);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x42,0x80);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x43,0x14);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x44,0x03);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x45,0x0a);\r\n}\r\n}\r\n#endif\r\n}\r\nstatic void\r\nSiS_SetGroup1(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\n#if defined(CONFIG_FB_SIS_300) || defined(CONFIG_FB_SIS_315)\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\n#endif\r\nunsigned short temp=0, tempax=0, tempbx=0, tempcx=0, bridgeadd=0;\r\nunsigned short pushbx=0, CRT1Index=0, modeflag, resinfo=0;\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short tempbl=0;\r\n#endif\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_SetGroup1_LVDS(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\nreturn;\r\n}\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\n} else if(SiS_Pr->UseCustomMode) {\r\nmodeflag = SiS_Pr->CModeFlag;\r\n} else {\r\nCRT1Index = SiS_GetRefCRT1CRTC(SiS_Pr, RefreshRateTableIndex, SiS_Pr->SiS_UseWideCRT2);\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\n}\r\nSiS_SetCRT2Offset(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\nif( ! ((SiS_Pr->ChipType >= SIS_315H) &&\r\n(SiS_Pr->SiS_IF_DEF_LVDS == 1) &&\r\n(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) ) {\r\nif(SiS_Pr->ChipType < SIS_315H ) {\r\n#ifdef CONFIG_FB_SIS_300\r\nSiS_SetCRT2FIFO_300(SiS_Pr, ModeNo);\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS_SetCRT2FIFO_310(SiS_Pr);\r\n#endif\r\n}\r\nif(SiS_Pr->ChipType < SIS_315H ) {\r\n#ifdef CONFIG_FB_SIS_300\r\ntemp = (SiS_Pr->SiS_VGAHT - 1) & 0x0FF;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x08,temp);\r\ntemp = (((SiS_Pr->SiS_VGAHT - 1) & 0xFF00) >> 8) << 4;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x09,0x0f,temp);\r\ntemp = (SiS_Pr->SiS_VGAHDE + 12) & 0x0FF;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0A,temp);\r\npushbx = SiS_Pr->SiS_VGAHDE + 12;\r\ntempcx = (SiS_Pr->SiS_VGAHT - SiS_Pr->SiS_VGAHDE) >> 2;\r\ntempbx = pushbx + tempcx;\r\ntempcx <<= 1;\r\ntempcx += tempbx;\r\nbridgeadd = 12;\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\ntempcx = SiS_Pr->SiS_VGAHT;\r\nif(modeflag & HalfDCLK) {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntempcx >>= 1;\r\n} else {\r\ntempax = SiS_Pr->SiS_VGAHDE >> 1;\r\ntempcx = SiS_Pr->SiS_HT - SiS_Pr->SiS_HDE + tempax;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\ntempcx = SiS_Pr->SiS_HT - tempax;\r\n}\r\n}\r\n}\r\ntempcx--;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x08,tempcx);\r\ntemp = (tempcx >> 4) & 0xF0;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x09,0x0F,temp);\r\ntempcx = SiS_Pr->SiS_VGAHT;\r\ntempbx = SiS_Pr->SiS_VGAHDE;\r\ntempcx -= tempbx;\r\ntempcx >>= 2;\r\nif(modeflag & HalfDCLK) {\r\ntempbx >>= 1;\r\ntempcx >>= 1;\r\n}\r\ntempbx += 16;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0A,tempbx);\r\npushbx = tempbx;\r\ntempcx >>= 1;\r\ntempbx += tempcx;\r\ntempcx += tempbx;\r\nbridgeadd = 16;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\nif((SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024)) {\r\nif(resinfo == SIS_RI_1280x1024) {\r\ntempcx = (tempcx & 0xff00) | 0x30;\r\n} else if(resinfo == SIS_RI_1600x1200) {\r\ntempcx = (tempcx & 0xff00) | 0xff;\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->UseCustomMode) {\r\ntempbx = SiS_Pr->CHSyncStart + bridgeadd;\r\ntempcx = SiS_Pr->CHSyncEnd + bridgeadd;\r\ntempax = SiS_Pr->SiS_VGAHT;\r\nif(modeflag & HalfDCLK) tempax >>= 1;\r\ntempax--;\r\nif(tempcx > tempax) tempcx = tempax;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) {\r\nunsigned char cr4, cr14, cr5, cr15;\r\nif(SiS_Pr->UseCustomMode) {\r\ncr4 = SiS_Pr->CCRT1CRTC[4];\r\ncr14 = SiS_Pr->CCRT1CRTC[14];\r\ncr5 = SiS_Pr->CCRT1CRTC[5];\r\ncr15 = SiS_Pr->CCRT1CRTC[15];\r\n} else {\r\ncr4 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[4];\r\ncr14 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[14];\r\ncr5 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[5];\r\ncr15 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[15];\r\n}\r\ntempbx = ((cr4 | ((cr14 & 0xC0) << 2)) - 3) << 3;\r\ntempcx = (((cr5 & 0x1f) | ((cr15 & 0x04) << (5-2))) - 3) << 3;\r\ntempcx &= 0x00FF;\r\ntempcx |= (tempbx & 0xFF00);\r\ntempbx += bridgeadd;\r\ntempcx += bridgeadd;\r\ntempax = SiS_Pr->SiS_VGAHT;\r\nif(modeflag & HalfDCLK) tempax >>= 1;\r\ntempax--;\r\nif(tempcx > tempax) tempcx = tempax;\r\n}\r\nif(SiS_Pr->SiS_TVMode & (TVSetNTSC1024 | TVSet525p1024)) {\r\ntempbx = 1040;\r\ntempcx = 1044;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0B,tempbx);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0D,tempcx);\r\ntemp = ((tempbx >> 8) & 0x0F) | ((pushbx >> 4) & 0xF0);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0C,temp);\r\ntempcx = SiS_Pr->SiS_VGAVT - 1;\r\ntemp = tempcx & 0x00FF;\r\nif(SiS_Pr->ChipType < SIS_661) {\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToSVIDEO | SetCRT2ToAVIDEO)) {\r\ntemp--;\r\n}\r\n}\r\n} else {\r\ntemp--;\r\n}\r\n} else if(SiS_Pr->ChipType >= SIS_315H) {\r\ntemp--;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0E,temp);\r\ntempbx = SiS_Pr->SiS_VGAVDE - 1;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x0F,tempbx);\r\ntemp = ((tempbx >> 5) & 0x38) | ((tempcx >> 8) & 0x07);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x12,temp);\r\nif((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->ChipType < SIS_661)) {\r\ntempbx++;\r\ntempax = tempbx;\r\ntempcx++;\r\ntempcx -= tempax;\r\ntempcx >>= 2;\r\ntempbx += tempcx;\r\nif(tempcx < 4) tempcx = 4;\r\ntempcx >>= 2;\r\ntempcx += tempbx;\r\ntempcx++;\r\n} else {\r\ntempbx = (SiS_Pr->SiS_VGAVT + SiS_Pr->SiS_VGAVDE) >> 1;\r\ntempcx = ((SiS_Pr->SiS_VGAVT - SiS_Pr->SiS_VGAVDE) >> 4) + tempbx + 1;\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->UseCustomMode) {\r\ntempbx = SiS_Pr->CVSyncStart;\r\ntempcx = SiS_Pr->CVSyncEnd;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) {\r\nunsigned char cr8, cr7, cr13;\r\nif(SiS_Pr->UseCustomMode) {\r\ncr8 = SiS_Pr->CCRT1CRTC[8];\r\ncr7 = SiS_Pr->CCRT1CRTC[7];\r\ncr13 = SiS_Pr->CCRT1CRTC[13];\r\ntempcx = SiS_Pr->CCRT1CRTC[9];\r\n} else {\r\ncr8 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[8];\r\ncr7 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[7];\r\ncr13 = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[13];\r\ntempcx = SiS_Pr->SiS_CRT1Table[CRT1Index].CR[9];\r\n}\r\ntempbx = cr8;\r\nif(cr7 & 0x04) tempbx |= 0x0100;\r\nif(cr7 & 0x80) tempbx |= 0x0200;\r\nif(cr13 & 0x08) tempbx |= 0x0400;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x10,tempbx);\r\ntemp = ((tempbx >> 4) & 0x70) | (tempcx & 0x0F);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x11,temp);\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntemp = 0x20;\r\nif(SiS_Pr->ChipType == SIS_300) {\r\ntemp = 0x10;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) temp = 0x2c;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) temp = 0x20;\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) temp = 0x20;\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x960) temp = 0x24;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_Custom) temp = 0x2c;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) temp = 0x08;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) temp = 0x2c;\r\nelse temp = 0x20;\r\n}\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(ROMAddr[0x220] & 0x80) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTVNoYPbPrHiVision)\r\ntemp = ROMAddr[0x221];\r\nelse if(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision)\r\ntemp = ROMAddr[0x222];\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024)\r\ntemp = ROMAddr[0x223];\r\nelse\r\ntemp = ROMAddr[0x224];\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->PDC != -1) temp = SiS_Pr->PDC;\r\n}\r\n} else {\r\ntemp = 0x20;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_640x480) temp = 0x04;\r\n}\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(ROMAddr[0x220] & 0x80) {\r\ntemp = ROMAddr[0x220];\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->PDC != -1) temp = SiS_Pr->PDC;\r\n}\r\n}\r\ntemp &= 0x3c;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,~0x3C,temp);\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType < SIS_661) {\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(SiS_Pr->ChipType == SIS_740) temp = 0x03;\r\nelse temp = 0x00;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) temp = 0x0a;\r\ntempbl = 0xF0;\r\nif(SiS_Pr->ChipType == SIS_650) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) tempbl = 0x0F;\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_DSTN || SiS_Pr->SiS_IF_DEF_FSTN) {\r\ntemp = 0x08;\r\ntempbl = 0;\r\nif((SiS_Pr->SiS_UseROM) && (!(SiS_Pr->SiS_ROMNew))) {\r\nif(ROMAddr[0x13c] & 0x80) tempbl = 0xf0;\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2D,tempbl,temp);\r\n}\r\n}\r\ntempax = 0;\r\nif(modeflag & DoubleScanMode) tempax |= 0x80;\r\nif(modeflag & HalfDCLK) tempax |= 0x40;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2C,0x3f,tempax);\r\n#endif\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif((SiS_Pr->SiS_VBType & VB_NoLCD) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD)) {\r\nSiS_SetGroup1_LVDS(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n} else if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nSiS_SetGroup1_301(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n} else {\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nSiS_SetGroup1_LVDS(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n} else {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif((!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) || (SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nSiS_SetGroup1_LVDS(SiS_Pr, ModeNo,ModeIdIndex,RefreshRateTableIndex);\r\n}\r\n} else {\r\nSiS_SetGroup1_LVDS(SiS_Pr, ModeNo,ModeIdIndex,RefreshRateTableIndex);\r\n}\r\n}\r\n}\r\n}\r\nstatic unsigned char *\r\nSiS_GetGroup2CLVXPtr(struct SiS_Private *SiS_Pr, int tabletype)\r\n{\r\nconst unsigned char *tableptr = NULL;\r\nunsigned short a, b, p = 0;\r\na = SiS_Pr->SiS_VGAHDE;\r\nb = SiS_Pr->SiS_HDE;\r\nif(tabletype) {\r\na = SiS_Pr->SiS_VGAVDE;\r\nb = SiS_Pr->SiS_VDE;\r\n}\r\nif(a < b) {\r\ntableptr = SiS_Part2CLVX_1;\r\n} else if(a == b) {\r\ntableptr = SiS_Part2CLVX_2;\r\n} else {\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\ntableptr = SiS_Part2CLVX_4;\r\n} else {\r\ntableptr = SiS_Part2CLVX_3;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525i) tableptr = SiS_Part2CLVX_3;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) tableptr = SiS_Part2CLVX_3;\r\nelse tableptr = SiS_Part2CLVX_5;\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\ntableptr = SiS_Part2CLVX_6;\r\n}\r\ndo {\r\nif((tableptr[p] | tableptr[p+1] << 8) == a) break;\r\np += 0x42;\r\n} while((tableptr[p] | tableptr[p+1] << 8) != 0xffff);\r\nif((tableptr[p] | tableptr[p+1] << 8) == 0xffff) p -= 0x42;\r\n}\r\np += 2;\r\nreturn ((unsigned char *)&tableptr[p]);\r\n}\r\nstatic void\r\nSiS_SetGroup2_C_ELV(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned char *tableptr;\r\nunsigned char temp;\r\nint i, j;\r\nif(!(SiS_Pr->SiS_VBType & VB_SISTAP4SCALER)) return;\r\ntableptr = SiS_GetGroup2CLVXPtr(SiS_Pr, 0);\r\nfor(i = 0x80, j = 0; i <= 0xbf; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port, i, tableptr[j]);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\ntableptr = SiS_GetGroup2CLVXPtr(SiS_Pr, 1);\r\nfor(i = 0xc0, j = 0; i <= 0xff; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port, i, tableptr[j]);\r\n}\r\n}\r\ntemp = 0x10;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) temp |= 0x04;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x4e,0xeb,temp);\r\n}\r\nstatic bool\r\nSiS_GetCRT2Part2Ptr(struct SiS_Private *SiS_Pr,unsigned short ModeNo,unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex,unsigned short *CRT2Index,\r\nunsigned short *ResIndex)\r\n{\r\nif(SiS_Pr->ChipType < SIS_315H) return false;\r\nif(ModeNo <= 0x13)\r\n(*ResIndex) = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\nelse\r\n(*ResIndex) = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\n(*ResIndex) &= 0x3f;\r\n(*CRT2Index) = 0;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) {\r\n(*CRT2Index) = 200;\r\n}\r\n}\r\nif(SiS_Pr->SiS_CustomT == CUT_ASUSA2H_2) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) (*CRT2Index) = 206;\r\n}\r\n}\r\nreturn (((*CRT2Index) != 0));\r\n}\r\nstatic void\r\nSiS_Group2LCDSpecial(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short crt2crtc)\r\n{\r\nunsigned short tempcx;\r\nstatic const unsigned char atable[] = {\r\n0xc3,0x9e,0xc3,0x9e,0x02,0x02,0x02,\r\n0xab,0x87,0xab,0x9e,0xe7,0x02,0x02\r\n};\r\nif(!SiS_Pr->UseCustomMode) {\r\nif( ( ( (SiS_Pr->ChipType == SIS_630) ||\r\n(SiS_Pr->ChipType == SIS_730) ) &&\r\n(SiS_Pr->ChipRevision > 2) ) &&\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) &&\r\n(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) &&\r\n(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) ) {\r\nif(ModeNo == 0x13) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x04,0xB9);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x05,0xCC);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x06,0xA6);\r\n} else if((crt2crtc & 0x3F) == 4) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x2B);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x13);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x04,0xE5);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x05,0x08);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x06,0xE2);\r\n}\r\n}\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_LCDTypeInfo == 0x0c) {\r\ncrt2crtc &= 0x1f;\r\ntempcx = 0;\r\nif(!(SiS_Pr->SiS_VBInfo & SetNotSimuMode)) {\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\ntempcx += 7;\r\n}\r\n}\r\ntempcx += crt2crtc;\r\nif(crt2crtc >= 4) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x06,0xff);\r\n}\r\nif(!(SiS_Pr->SiS_VBInfo & SetNotSimuMode)) {\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(crt2crtc == 4) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x28);\r\n}\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x18);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x04,atable[tempcx]);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_Set300Part2Regs(struct SiS_Private *SiS_Pr, unsigned short ModeIdIndex, unsigned short RefreshRateTableIndex,\r\nunsigned short ModeNo)\r\n{\r\nconst struct SiS_Part2PortTbl *CRT2Part2Ptr = NULL;\r\nunsigned short crt2crtc, resindex;\r\nint i, j;\r\nif(SiS_Pr->ChipType != SIS_300) return;\r\nif(!(SiS_Pr->SiS_VBType & VB_SIS30xBLV)) return;\r\nif(SiS_Pr->UseCustomMode) return;\r\nif(ModeNo <= 0x13) {\r\ncrt2crtc = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n} else {\r\ncrt2crtc = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\n}\r\nresindex = crt2crtc & 0x3F;\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) CRT2Part2Ptr = SiS_Pr->SiS_CRT2Part2_1024x768_1;\r\nelse CRT2Part2Ptr = SiS_Pr->SiS_CRT2Part2_1024x768_2;\r\nif(ModeNo > 0x13) {\r\nCRT2Part2Ptr = SiS_Pr->SiS_CRT2Part2_1024x768_1;\r\nresindex = 4;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x01,0x80,(CRT2Part2Ptr+resindex)->CR[0]);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x02,0x80,(CRT2Part2Ptr+resindex)->CR[1]);\r\nfor(i = 2, j = 0x04; j <= 0x06; i++, j++ ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,j,(CRT2Part2Ptr+resindex)->CR[i]);\r\n}\r\nfor(j = 0x1c; j <= 0x1d; i++, j++ ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,j,(CRT2Part2Ptr+resindex)->CR[i]);\r\n}\r\nfor(j = 0x1f; j <= 0x21; i++, j++ ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,j,(CRT2Part2Ptr+resindex)->CR[i]);\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x23,(CRT2Part2Ptr+resindex)->CR[10]);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x25,0x0f,(CRT2Part2Ptr+resindex)->CR[11]);\r\n}\r\nstatic void\r\nSiS_SetTVSpecial(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nif(!(SiS_Pr->SiS_VBType & VB_SIS30xBLV)) return;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTVNoHiVision)) return;\r\nif(SiS_Pr->SiS_TVMode & (TVSetYPbPr525p | TVSetYPbPr750p)) return;\r\nif(!(SiS_Pr->SiS_TVMode & TVSetPAL)) {\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSC1024) {\r\nconst unsigned char specialtv[] = {\r\n0xa7,0x07,0xf2,0x6e,0x17,0x8b,0x73,0x53,\r\n0x13,0x40,0x34,0xf4,0x63,0xbb,0xcc,0x7a,\r\n0x58,0xe4,0x73,0xda,0x13\r\n};\r\nint i, j;\r\nfor(i = 0x1c, j = 0; i <= 0x30; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,specialtv[j]);\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x43,0x72);\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750)) {\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x14);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x1b);\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x14);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x1a);\r\n}\r\n}\r\n}\r\n} else {\r\nif((ModeNo == 0x38) || (ModeNo == 0x4a) || (ModeNo == 0x64) ||\r\n(ModeNo == 0x52) || (ModeNo == 0x58) || (ModeNo == 0x5c)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x1b);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x54);\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x1a);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x53);\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_SetGroup2_Tail(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nunsigned short temp;\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) {\r\nif(SiS_Pr->SiS_VGAVDE == 525) {\r\ntemp = 0xc3;\r\nif(SiS_Pr->SiS_ModeType <= ModeVGA) {\r\ntemp++;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) temp += 2;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x2f,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x30,0xb3);\r\n} else if(SiS_Pr->SiS_VGAVDE == 420) {\r\ntemp = 0x4d;\r\nif(SiS_Pr->SiS_ModeType <= ModeVGA) {\r\ntemp++;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) temp++;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x2f,temp);\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) {\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xB) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part2Port,0x1a,0x03);\r\n}\r\ntemp = 1;\r\nif(ModeNo <= 0x13) temp = 3;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x0b,temp);\r\n}\r\n#if 0\r\nif((SiS_Pr->SiS_PanelXRes == 1280) && (SiS_Pr->SiS_PanelYRes == 768)) {\r\nif(SiS_Pr->SiS_VBInfo & SetSimuScanMode) {\r\nif(((SiS_Pr->SiS_HDE == 640) && (SiS_Pr->SiS_VDE == 480)) ||\r\n((SiS_Pr->SiS_HDE == 320) && (SiS_Pr->SiS_VDE == 240))) {\r\nSiS_SetReg(SiS_Part2Port,0x01,0x2b);\r\nSiS_SetReg(SiS_Part2Port,0x02,0x13);\r\nSiS_SetReg(SiS_Part2Port,0x04,0xe5);\r\nSiS_SetReg(SiS_Part2Port,0x05,0x08);\r\nSiS_SetReg(SiS_Part2Port,0x06,0xe2);\r\nSiS_SetReg(SiS_Part2Port,0x1c,0x21);\r\nSiS_SetReg(SiS_Part2Port,0x1d,0x45);\r\nSiS_SetReg(SiS_Part2Port,0x1f,0x0b);\r\nSiS_SetReg(SiS_Part2Port,0x20,0x00);\r\nSiS_SetReg(SiS_Part2Port,0x21,0xa9);\r\nSiS_SetReg(SiS_Part2Port,0x23,0x0b);\r\nSiS_SetReg(SiS_Part2Port,0x25,0x04);\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void\r\nSiS_SetGroup2(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short i, j, tempax, tempbx, tempcx, tempch, tempcl, temp;\r\nunsigned short push2, modeflag, crt2crtc, bridgeoffset;\r\nunsigned int longtemp, PhaseIndex;\r\nbool newtvphase;\r\nconst unsigned char *TimingPoint;\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short resindex, CRT2Index;\r\nconst struct SiS_Part2PortTbl *CRT2Part2Ptr = NULL;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) return;\r\n#endif\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\ncrt2crtc = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n} else if(SiS_Pr->UseCustomMode) {\r\nmodeflag = SiS_Pr->CModeFlag;\r\ncrt2crtc = 0;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ncrt2crtc = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\n}\r\ntemp = 0;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToAVIDEO)) temp |= 0x08;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToSVIDEO)) temp |= 0x04;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToSCART) temp |= 0x02;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) temp |= 0x01;\r\nif(!(SiS_Pr->SiS_TVMode & TVSetPAL)) temp |= 0x10;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x00,temp);\r\nPhaseIndex = 0x01;\r\nTimingPoint = SiS_Pr->SiS_PALTiming;\r\nnewtvphase = false;\r\nif( (SiS_Pr->SiS_VBType & VB_SIS30xBLV) &&\r\n( (!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) ||\r\n(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) ) ) {\r\nnewtvphase = true;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nTimingPoint = SiS_Pr->SiS_HiTVExtTiming;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nTimingPoint = SiS_Pr->SiS_HiTVSt2Timing;\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) {\r\nTimingPoint = SiS_Pr->SiS_HiTVSt1Timing;\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\ni = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) i = 2;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) i = 1;\r\nTimingPoint = &SiS_YPbPrTable[i][0];\r\nPhaseIndex = 0x00;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nif(newtvphase) PhaseIndex = 0x09;\r\n} else {\r\nTimingPoint = SiS_Pr->SiS_NTSCTiming;\r\nPhaseIndex = (SiS_Pr->SiS_TVMode & TVSetNTSCJ) ? 0x01 : 0x00;\r\nif(newtvphase) PhaseIndex += 8;\r\n}\r\nif(SiS_Pr->SiS_TVMode & (TVSetPALM | TVSetPALN)) {\r\nPhaseIndex = (SiS_Pr->SiS_TVMode & TVSetPALM) ? 0x02 : 0x03;\r\nif(newtvphase) PhaseIndex += 8;\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSC1024) {\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) {\r\nPhaseIndex = 0x05;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetNTSCJ) {\r\nPhaseIndex = 0x11;\r\n} else {\r\nPhaseIndex = 0x10;\r\n}\r\n}\r\nfor(i = 0x31, j = 0; i <= 0x34; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS_TVPhase[(PhaseIndex * 4) + j]);\r\n}\r\nfor(i = 0x01, j = 0; i <= 0x2D; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,TimingPoint[j]);\r\n}\r\nfor(i = 0x39; i <= 0x45; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,TimingPoint[j]);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(SiS_Pr->SiS_ModeType != ModeText) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x3A,0x1F);\r\n}\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part2Port,0x0A,SiS_Pr->SiS_NewFlickerMode);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x35,SiS_Pr->SiS_RY1COE);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x36,SiS_Pr->SiS_RY2COE);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x37,SiS_Pr->SiS_RY3COE);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x38,SiS_Pr->SiS_RY4COE);\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) tempax = 950;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) tempax = 680;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetPAL) tempax = 520;\r\nelse tempax = 440;\r\nif( ((SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) && (SiS_Pr->SiS_VDE <= tempax)) ||\r\n( (SiS_Pr->SiS_VBInfo & SetCRT2ToTVNoHiVision) &&\r\n((SiS_Pr->SiS_VGAHDE == 1024) || (SiS_Pr->SiS_VDE <= tempax)) ) ) {\r\ntempax -= SiS_Pr->SiS_VDE;\r\ntempax >>= 1;\r\nif(!(SiS_Pr->SiS_TVMode & (TVSetYPbPr525p | TVSetYPbPr750p))) {\r\ntempax >>= 1;\r\n}\r\ntempax &= 0x00ff;\r\ntemp = tempax + (unsigned short)TimingPoint[0];\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,temp);\r\ntemp = tempax + (unsigned short)TimingPoint[1];\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,temp);\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToTVNoYPbPrHiVision) && (SiS_Pr->SiS_VGAHDE >= 1024)) {\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x1b);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x54);\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,0x17);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,0x1d);\r\n}\r\n}\r\n}\r\ntempcx = SiS_Pr->SiS_HT;\r\nif(SiS_IsDualLink(SiS_Pr)) tempcx >>= 1;\r\ntempcx--;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) tempcx--;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x1B,tempcx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1D,0xF0,((tempcx >> 8) & 0x0f));\r\ntempcx = SiS_Pr->SiS_HT >> 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempcx >>= 1;\r\ntempcx += 7;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) tempcx -= 4;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x22,0x0F,((tempcx << 4) & 0xf0));\r\ntempbx = TimingPoint[j] | (TimingPoint[j+1] << 8);\r\ntempbx += tempcx;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x24,tempbx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x25,0x0F,((tempbx >> 4) & 0xf0));\r\ntempbx += 8;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\ntempbx -= 4;\r\ntempcx = tempbx;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x29,0x0F,((tempbx << 4) & 0xf0));\r\nj += 2;\r\ntempcx += (TimingPoint[j] | (TimingPoint[j+1] << 8));\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x27,tempcx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x28,0x0F,((tempcx >> 4) & 0xf0));\r\ntempcx += 8;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) tempcx -= 4;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x2A,0x0F,((tempcx << 4) & 0xf0));\r\ntempcx = SiS_Pr->SiS_HT >> 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempcx >>= 1;\r\nj += 2;\r\ntempcx -= (TimingPoint[j] | ((TimingPoint[j+1]) << 8));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x2D,0x0F,((tempcx << 4) & 0xf0));\r\ntempcx -= 11;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\ntempcx = SiS_GetVGAHT2(SiS_Pr) - 1;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x2E,tempcx);\r\ntempbx = SiS_Pr->SiS_VDE;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->SiS_VGAVDE == 360) tempbx = 746;\r\nif(SiS_Pr->SiS_VGAVDE == 375) tempbx = 746;\r\nif(SiS_Pr->SiS_VGAVDE == 405) tempbx = 853;\r\n} else if( (SiS_Pr->SiS_VBInfo & SetCRT2ToTV) &&\r\n(!(SiS_Pr->SiS_TVMode & (TVSetYPbPr525p|TVSetYPbPr750p))) ) {\r\ntempbx >>= 1;\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) {\r\nif((ModeNo <= 0x13) && (crt2crtc == 1)) tempbx++;\r\n} else if(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(SiS_Pr->SiS_ModeType <= ModeVGA) {\r\nif(crt2crtc == 4) tempbx++;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif((ModeNo == 0x2f) || (ModeNo == 0x5d) || (ModeNo == 0x5e)) tempbx++;\r\n}\r\nif(!(SiS_Pr->SiS_TVMode & TVSetPAL)) {\r\nif(ModeNo == 0x03) tempbx++;\r\n}\r\n}\r\n}\r\ntempbx -= 2;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x2F,tempbx);\r\ntemp = (tempcx >> 8) & 0x0F;\r\ntemp |= ((tempbx >> 2) & 0xC0);\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToSVIDEO | SetCRT2ToAVIDEO)) {\r\ntemp |= 0x10;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToAVIDEO) temp |= 0x20;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x30,temp);\r\nif(SiS_Pr->SiS_VBType & VB_SISPART4OVERFLOW) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x10,0xdf,((tempbx & 0x0400) >> 5));\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\ntempbx = SiS_Pr->SiS_VDE;\r\nif( (SiS_Pr->SiS_VBInfo & SetCRT2ToTV) &&\r\n(!(SiS_Pr->SiS_TVMode & (TVSetYPbPr525p | TVSetYPbPr750p))) ) {\r\ntempbx >>= 1;\r\n}\r\ntempbx -= 3;\r\ntemp = ((tempbx >> 3) & 0x60) | 0x18;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x46,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x47,tempbx);\r\nif(SiS_Pr->SiS_VBType & VB_SISPART4OVERFLOW) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x10,0xbf,((tempbx & 0x0400) >> 4));\r\n}\r\n}\r\ntempbx = 0;\r\nif(!(modeflag & HalfDCLK)) {\r\nif(SiS_Pr->SiS_VGAHDE >= SiS_Pr->SiS_HDE) {\r\ntempax = 0;\r\ntempbx |= 0x20;\r\n}\r\n}\r\ntempch = tempcl = 0x01;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(SiS_Pr->SiS_VGAHDE >= 960) {\r\nif((!(modeflag & HalfDCLK)) || (SiS_Pr->ChipType < SIS_315H)) {\r\ntempcl = 0x20;\r\nif(SiS_Pr->SiS_VGAHDE >= 1280) {\r\ntempch = 20;\r\ntempbx &= ~0x20;\r\n} else if(SiS_Pr->SiS_VGAHDE >= 1024) {\r\ntempch = 25;\r\n} else {\r\ntempch = 25;\r\n}\r\n}\r\n}\r\n}\r\nif(!(tempbx & 0x20)) {\r\nif(modeflag & HalfDCLK) tempcl <<= 1;\r\nlongtemp = ((SiS_Pr->SiS_VGAHDE * tempch) / tempcl) << 13;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) longtemp <<= 3;\r\ntempax = longtemp / SiS_Pr->SiS_HDE;\r\nif(longtemp % SiS_Pr->SiS_HDE) tempax++;\r\ntempbx |= ((tempax >> 8) & 0x1F);\r\ntempcx = tempax >> 13;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x44,tempax);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x45,0xC0,tempbx);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\ntempcx &= 0x07;\r\nif(tempbx & 0x20) tempcx = 0;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x46,0xF8,tempcx);\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\ntempbx = 0x0382;\r\ntempcx = 0x007e;\r\n} else {\r\ntempbx = 0x0369;\r\ntempcx = 0x0061;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x4B,tempbx);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x4C,tempcx);\r\ntemp = (tempcx & 0x0300) >> 6;\r\ntemp |= ((tempbx >> 8) & 0x03);\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\ntemp |= 0x10;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) temp |= 0x20;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) temp |= 0x40;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x4D,temp);\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part2Port,0x43);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x43,(temp - 3));\r\nSiS_SetTVSpecial(SiS_Pr, ModeNo);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xCLV) {\r\ntemp = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) temp = 8;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x4e,0xf7,temp);\r\n}\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) {\r\nif(!(SiS_Pr->SiS_TVMode & TVSetNTSC1024)) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part2Port,0x01);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,(temp - 1));\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x00,0xEF);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x0B,0x00);\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) return;\r\ntempbx = SiS_Pr->SiS_HDE;\r\nif(SiS_IsDualLink(SiS_Pr)) tempbx >>= 1;\r\ntempbx--;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x2C,tempbx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x2B,0x0F,((tempbx >> 4) & 0xf0));\r\ntemp = 0x01;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) {\r\nif(SiS_Pr->SiS_ModeType == ModeEGA) {\r\nif(SiS_Pr->SiS_VGAHDE >= 1024) {\r\ntemp = 0x02;\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) {\r\ntemp = 0x01;\r\n}\r\n}\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x0B,temp);\r\ntempbx = SiS_Pr->SiS_VDE - 1;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x03,tempbx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x0C,0xF8,((tempbx >> 8) & 0x07));\r\ntempcx = SiS_Pr->SiS_VT - 1;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x19,tempcx);\r\ntemp = (tempcx >> 3) & 0xE0;\r\nif(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit) {\r\nif(SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00) & 0x01) {\r\ntemp |= 0x10;\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1A,0x0f,temp);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x09,0xF0);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x0A,0xF0);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x17,0xFB);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part2Port,0x18,0xDF);\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_GetCRT2Part2Ptr(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex,\r\n&CRT2Index, &resindex)) {\r\nswitch(CRT2Index) {\r\ncase 206: CRT2Part2Ptr = SiS310_CRT2Part2_Asus1024x768_3; break;\r\ndefault:\r\ncase 200: CRT2Part2Ptr = SiS_Pr->SiS_CRT2Part2_1024x768_1; break;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x01,0x80,(CRT2Part2Ptr+resindex)->CR[0]);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x02,0x80,(CRT2Part2Ptr+resindex)->CR[1]);\r\nfor(i = 2, j = 0x04; j <= 0x06; i++, j++ ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,j,(CRT2Part2Ptr+resindex)->CR[i]);\r\n}\r\nfor(j = 0x1c; j <= 0x1d; i++, j++ ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,j,(CRT2Part2Ptr+resindex)->CR[i]);\r\n}\r\nfor(j = 0x1f; j <= 0x21; i++, j++ ) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,j,(CRT2Part2Ptr+resindex)->CR[i]);\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x23,(CRT2Part2Ptr+resindex)->CR[10]);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x25,0x0f,(CRT2Part2Ptr+resindex)->CR[11]);\r\nSiS_SetGroup2_Tail(SiS_Pr, ModeNo);\r\n} else {\r\n#endif\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif((SiS_Pr->SiS_LCDInfo & LCDPass11) || (SiS_Pr->PanelYRes == SiS_Pr->SiS_VDE)) {\r\ntempbx = SiS_Pr->SiS_VDE - 1;\r\ntempcx = SiS_Pr->SiS_VT - 1;\r\n} else {\r\ntempbx = SiS_Pr->SiS_VDE + ((SiS_Pr->PanelYRes - SiS_Pr->SiS_VDE) / 2);\r\ntempcx = SiS_Pr->SiS_VT - ((SiS_Pr->PanelYRes - SiS_Pr->SiS_VDE) / 2);\r\n}\r\n} else {\r\ntempbx = SiS_Pr->PanelYRes;\r\ntempcx = SiS_Pr->SiS_VT;\r\ntempax = 1;\r\nif(SiS_Pr->PanelYRes != SiS_Pr->SiS_VDE) {\r\ntempax = SiS_Pr->PanelYRes;\r\nif(SiS_Pr->PanelYRes < SiS_Pr->SiS_VDE) {\r\ntempax = tempcx = 0;\r\n} else {\r\ntempax -= SiS_Pr->SiS_VDE;\r\n}\r\ntempax >>= 1;\r\n}\r\ntempcx -= tempax;\r\ntempbx -= tempax;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x05,tempcx);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x06,tempbx);\r\ntemp = (tempbx >> 5) & 0x38;\r\ntemp |= ((tempcx >> 8) & 0x07);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x02,temp);\r\ntempax = SiS_Pr->SiS_VDE;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (!(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\ntempax = SiS_Pr->PanelYRes;\r\n}\r\ntempcx = (SiS_Pr->SiS_VT - tempax) >> 4;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (!(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\nif(SiS_Pr->PanelYRes != SiS_Pr->SiS_VDE) {\r\ntempcx = (SiS_Pr->SiS_VT - tempax) / 10;\r\n}\r\n}\r\ntempbx = ((SiS_Pr->SiS_VT + SiS_Pr->SiS_VDE) >> 1) - 1;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(SiS_Pr->PanelYRes != SiS_Pr->SiS_VDE) {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\ntempax = SiS_Pr->SiS_VT - SiS_Pr->PanelYRes;\r\nif(tempax % 4) { tempax >>= 2; tempax++; }\r\nelse { tempax >>= 2; }\r\ntempbx -= (tempax - 1);\r\n} else {\r\ntempbx -= 10;\r\nif(tempbx <= SiS_Pr->SiS_VDE) tempbx = SiS_Pr->SiS_VDE + 1;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\ntempbx++;\r\nif((!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) || (crt2crtc == 6)) {\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) {\r\ntempbx = 770;\r\ntempcx = 3;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->UseCustomMode) {\r\ntempbx = SiS_Pr->CVSyncStart;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x04,tempbx);\r\ntemp = (tempbx >> 4) & 0xF0;\r\ntempbx += (tempcx + 1);\r\ntemp |= (tempbx & 0x0F);\r\nif(SiS_Pr->UseCustomMode) {\r\ntemp &= 0xf0;\r\ntemp |= (SiS_Pr->CVSyncEnd & 0x0f);\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x01,temp);\r\n#ifdef CONFIG_FB_SIS_300\r\nSiS_Group2LCDSpecial(SiS_Pr, ModeNo, crt2crtc);\r\n#endif\r\nbridgeoffset = 7;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) bridgeoffset += 2;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xCLV) bridgeoffset += 2;\r\nif(SiS_IsDualLink(SiS_Pr)) bridgeoffset++;\r\nelse if(SiS_Pr->SiS_VBType & VB_SIS302LV) bridgeoffset++;\r\ntemp = 0;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (!(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\nif(SiS_Pr->PanelXRes != SiS_Pr->SiS_HDE) {\r\ntemp = SiS_Pr->SiS_HT - ((SiS_Pr->PanelXRes - SiS_Pr->SiS_HDE) / 2);\r\nif(SiS_IsDualLink(SiS_Pr)) temp >>= 1;\r\n}\r\n}\r\ntemp += bridgeoffset;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x1F,temp);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x20,0x0F,((temp >> 4) & 0xf0));\r\ntempcx = SiS_Pr->SiS_HT;\r\ntempax = tempbx = SiS_Pr->SiS_HDE;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (!(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\nif(SiS_Pr->PanelXRes != SiS_Pr->SiS_HDE) {\r\ntempax = SiS_Pr->PanelXRes;\r\ntempbx = SiS_Pr->PanelXRes - ((SiS_Pr->PanelXRes - SiS_Pr->SiS_HDE) / 2);\r\n}\r\n}\r\nif(SiS_IsDualLink(SiS_Pr)) {\r\ntempcx >>= 1;\r\ntempbx >>= 1;\r\ntempax >>= 1;\r\n}\r\ntempbx += bridgeoffset;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x23,tempbx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x25,0xF0,((tempbx >> 8) & 0x0f));\r\ntempcx = (tempcx - tempax) >> 2;\r\ntempbx += tempcx;\r\npush2 = tempbx;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) {\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) {\r\nif(SiS_Pr->SiS_HDE == 1280) tempbx = (tempbx & 0xff00) | 0x47;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->UseCustomMode) {\r\ntempbx = SiS_Pr->CHSyncStart;\r\nif(modeflag & HalfDCLK) tempbx <<= 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempbx >>= 1;\r\ntempbx += bridgeoffset;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x1C,tempbx);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1D,0x0F,((tempbx >> 4) & 0xf0));\r\ntempbx = push2;\r\ntempcx <<= 1;\r\nif((SiS_Pr->SiS_LCDInfo & DontExpandLCD) && (!(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\nif(SiS_Pr->PanelXRes != SiS_Pr->SiS_HDE) tempcx >>= 2;\r\n}\r\ntempbx += tempcx;\r\nif(SiS_Pr->UseCustomMode) {\r\ntempbx = SiS_Pr->CHSyncEnd;\r\nif(modeflag & HalfDCLK) tempbx <<= 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempbx >>= 1;\r\ntempbx += bridgeoffset;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x21,tempbx);\r\nSiS_SetGroup2_Tail(SiS_Pr, ModeNo);\r\n#ifdef CONFIG_FB_SIS_300\r\nSiS_Set300Part2Regs(SiS_Pr, ModeIdIndex, RefreshRateTableIndex, ModeNo);\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\n}\r\n#endif\r\n}\r\nstatic void\r\nSiS_SetGroup3(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short i;\r\nconst unsigned char *tempdi;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) return;\r\n#ifndef SIS_CP\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x00,0x00);\r\n#else\r\nSIS_CP_INIT301_CP\r\n#endif\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x13,0xFA);\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x14,0xC8);\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x13,0xF5);\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x14,0xB7);\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) {\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x13,0xFA);\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x14,0xC8);\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x3D,0xA8);\r\n}\r\ntempdi = NULL;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\ntempdi = SiS_Pr->SiS_HiTVGroup3Data;\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) {\r\ntempdi = SiS_Pr->SiS_HiTVGroup3Simu;\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) {\r\nif(!(SiS_Pr->SiS_TVMode & TVSetYPbPr525i)) {\r\ntempdi = SiS_HiTVGroup3_1;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) tempdi = SiS_HiTVGroup3_2;\r\n}\r\n}\r\nif(tempdi) {\r\nfor(i=0; i<=0x3E; i++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,i,tempdi[i]);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xCLV) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) {\r\nSiS_SetReg(SiS_Pr->SiS_Part3Port,0x28,0x3f);\r\n}\r\n}\r\n}\r\n#ifdef SIS_CP\r\nSIS_CP_INIT301_CP2\r\n#endif\r\n}\r\nstatic void\r\nSiS_SetGroup4_C_ELV(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short temp, temp1, resinfo = 0;\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nif(!(SiS_Pr->SiS_VBType & VB_SIS30xCLV)) return;\r\nif(!(SiS_Pr->SiS_VBInfo & (SetCRT2ToHiVision | SetCRT2ToYPbPr525750))) return;\r\nif(SiS_Pr->ChipType >= XGI_20) return;\r\nif((SiS_Pr->ChipType >= SIS_661) && (SiS_Pr->SiS_ROMNew)) {\r\nif(!(ROMAddr[0x61] & 0x04)) return;\r\n}\r\nif(ModeNo > 0x13) {\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x3a,0x08);\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part4Port,0x3a);\r\nif(!(temp & 0x01)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x3a,0xdf);\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x25,0xfc);\r\nif((SiS_Pr->ChipType < SIS_661) && (!(SiS_Pr->SiS_ROMNew))) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x25,0xf8);\r\n}\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x0f,0xfb);\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) temp = 0x0000;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) temp = 0x0002;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetHiVision) temp = 0x0400;\r\nelse temp = 0x0402;\r\nif((SiS_Pr->ChipType >= SIS_661) || (SiS_Pr->SiS_ROMNew)) {\r\ntemp1 = 0;\r\nif(SiS_Pr->SiS_TVMode & TVAspect43) temp1 = 4;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x0f,0xfb,temp1);\r\nif(SiS_Pr->SiS_TVMode & TVAspect43LB) temp |= 0x01;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x26,0x7c,(temp & 0xff));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x3a,0xfb,(temp >> 8));\r\nif(ModeNo > 0x13) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3d4,0x39,0xfd);\r\n}\r\n} else {\r\ntemp1 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x3b) & 0x03;\r\nif(temp1 == 0x01) temp |= 0x01;\r\nif(temp1 == 0x03) temp |= 0x04;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x26,0xf8,(temp & 0xff));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x3a,0xfb,(temp >> 8));\r\nif(ModeNo > 0x13) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x3b,0xfd);\r\n}\r\n}\r\n#if 0\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\nif(SiS_Pr->SiS_TVMode & TVAspect43) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) {\r\nif(resinfo == SIS_RI_1024x768) {\r\nSiS_ShiftXPos(SiS_Pr, 97);\r\n} else {\r\nSiS_ShiftXPos(SiS_Pr, 111);\r\n}\r\n} else if(SiS_Pr->SiS_TVMode & TVSetHiVision) {\r\nSiS_ShiftXPos(SiS_Pr, 136);\r\n}\r\n}\r\n}\r\n#endif\r\n}\r\n}\r\nstatic void\r\nSiS_SetCRT2VCLK(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short vclkindex, temp, reg1, reg2;\r\nif(SiS_Pr->UseCustomMode) {\r\nreg1 = SiS_Pr->CSR2B;\r\nreg2 = SiS_Pr->CSR2C;\r\n} else {\r\nvclkindex = SiS_GetVCLK2Ptr(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\nreg1 = SiS_Pr->SiS_VBVCLKData[vclkindex].Part4_A;\r\nreg2 = SiS_Pr->SiS_VBVCLKData[vclkindex].Part4_B;\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(SiS_Pr->SiS_TVMode & (TVSetNTSC1024 | TVSet525p1024)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0a,0x57);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0b,0x46);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x1f,0xf6);\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0a,reg1);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0b,reg2);\r\n}\r\n} else {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0a,0x01);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0b,reg2);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x0a,reg1);\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x12,0x00);\r\ntemp = 0x08;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) temp |= 0x20;\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x12,temp);\r\n}\r\nstatic void\r\nSiS_SetDualLinkEtc(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBType & VB_SISDUALLINK) {\r\nif((SiS_CRT2IsLCD(SiS_Pr)) ||\r\n(SiS_IsVAMode(SiS_Pr))) {\r\nif(SiS_Pr->SiS_LCDInfo & LCDDualLink) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x27,0x2c);\r\n} else {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x27,~0x20);\r\n}\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2a,0x00);\r\n#ifdef SET_EMI\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x30,0x0c);\r\n#endif\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x34,0x10);\r\n}\r\n}\r\nstatic void\r\nSiS_SetGroup4(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short tempax, tempcx, tempbx, modeflag, temp, resinfo;\r\nunsigned int tempebx, tempeax, templong;\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nresinfo = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo;\r\n} else if(SiS_Pr->UseCustomMode) {\r\nmodeflag = SiS_Pr->CModeFlag;\r\nresinfo = 0;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n}\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x24,0x0e);\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBType & (VB_SIS30xCLV | VB_SIS302LV)) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x10,0x9f);\r\n}\r\n}\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_SetDualLinkEtc(SiS_Pr);\r\nreturn;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x13,SiS_Pr->SiS_RVBHCFACT);\r\ntempbx = SiS_Pr->SiS_RVBHCMAX;\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x14,tempbx);\r\ntemp = (tempbx >> 1) & 0x80;\r\ntempcx = SiS_Pr->SiS_VGAHT - 1;\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x16,tempcx);\r\ntemp |= ((tempcx >> 5) & 0x78);\r\ntempcx = SiS_Pr->SiS_VGAVT - 1;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) tempcx -= 5;\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x17,tempcx);\r\ntemp |= ((tempcx >> 8) & 0x07);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x15,temp);\r\ntempbx = SiS_Pr->SiS_VGAHDE;\r\nif(modeflag & HalfDCLK) tempbx >>= 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempbx >>= 1;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\ntemp = 0;\r\nif(tempbx > 800) temp = 0x60;\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\ntemp = 0;\r\nif(tempbx > 1024) temp = 0xC0;\r\nelse if(tempbx >= 960) temp = 0xA0;\r\n} else if(SiS_Pr->SiS_TVMode & (TVSetYPbPr525p | TVSetYPbPr750p)) {\r\ntemp = 0;\r\nif(tempbx >= 1280) temp = 0x40;\r\nelse if(tempbx >= 1024) temp = 0x20;\r\n} else {\r\ntemp = 0x80;\r\nif(tempbx >= 1024) temp = 0xA0;\r\n}\r\ntemp |= SiS_Pr->Init_P4_0E;\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nif(SiS_Pr->SiS_LCDResInfo != Panel_1280x1024) {\r\ntemp &= 0xf0;\r\ntemp |= 0x0A;\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x0E,0x10,temp);\r\ntempeax = SiS_Pr->SiS_VGAVDE;\r\ntempebx = SiS_Pr->SiS_VDE;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif(!(temp & 0xE0)) tempebx >>=1;\r\n}\r\ntempcx = SiS_Pr->SiS_RVBHRS;\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x18,tempcx);\r\ntempcx >>= 8;\r\ntempcx |= 0x40;\r\nif(tempeax <= tempebx) {\r\ntempcx ^= 0x40;\r\n} else {\r\ntempeax -= tempebx;\r\n}\r\ntempeax *= (256 * 1024);\r\ntemplong = tempeax % tempebx;\r\ntempeax /= tempebx;\r\nif(templong) tempeax++;\r\ntemp = (unsigned short)(tempeax & 0x000000FF);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x1B,temp);\r\ntemp = (unsigned short)((tempeax & 0x0000FF00) >> 8);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x1A,temp);\r\ntemp = (unsigned short)((tempeax >> 12) & 0x70);\r\ntemp |= (tempcx & 0x4F);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x19,temp);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x1C,0x28);\r\ntempbx = 0;\r\nif(SiS_Pr->SiS_TVMode & (TVSetHiVision | TVSetYPbPr750p)) tempbx = 0x08;\r\ntempax = SiS_Pr->SiS_VGAHDE;\r\nif(modeflag & HalfDCLK) tempax >>= 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempax >>= 1;\r\nif(tempax > 800) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\ntempax -= 800;\r\n} else {\r\ntempbx = 0x08;\r\nif(tempax == 960) tempax *= 25;\r\nelse if(tempax == 1024) tempax *= 25;\r\nelse tempax *= 20;\r\ntemp = tempax % 32;\r\ntempax /= 32;\r\nif(temp) tempax++;\r\ntempax++;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(resinfo == SIS_RI_1024x768 ||\r\nresinfo == SIS_RI_1024x576 ||\r\nresinfo == SIS_RI_1280x1024 ||\r\nresinfo == SIS_RI_1280x720) {\r\ntempax = (tempax & 0xff00) | 0x20;\r\n}\r\n}\r\n}\r\n}\r\ntempax--;\r\ntemp = ((tempax >> 4) & 0x30) | tempbx;\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x1D,tempax);\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x1E,temp);\r\ntemp = 0x0036; tempbx = 0xD0;\r\nif((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->SiS_VBType & VB_SISLVDS)) {\r\ntemp = 0x0026; tempbx = 0xC0;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nif(!(SiS_Pr->SiS_TVMode & (TVSetNTSC1024 | TVSetHiVision | TVSetYPbPr750p | TVSetYPbPr525p))) {\r\ntemp |= 0x01;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nif(!(SiS_Pr->SiS_TVMode & TVSetTVSimuMode)) {\r\ntemp &= ~0x01;\r\n}\r\n}\r\n}\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x1F,tempbx,temp);\r\ntempbx = SiS_Pr->SiS_HT >> 1;\r\nif(SiS_IsDualLink(SiS_Pr)) tempbx >>= 1;\r\ntempbx -= 2;\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x22,tempbx);\r\ntemp = (tempbx >> 5) & 0x38;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x21,0xC0,temp);\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x24,0x0e);\r\n}\r\n}\r\nSiS_SetDualLinkEtc(SiS_Pr);\r\n}\r\nSiS_SetCRT2VCLK(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\nstatic void\r\nSiS_SetGroup5(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) return;\r\nif(SiS_Pr->SiS_ModeType == ModeVGA) {\r\nif(!(SiS_Pr->SiS_VBInfo & (SetInSlaveMode | LoadDACFlag))) {\r\nSiS_SetRegOR(SiS_Pr->SiS_P3c4,0x1E,0x20);\r\nSiS_LoadDAC(SiS_Pr, ModeNo, ModeIdIndex);\r\n}\r\n}\r\n}\r\nstatic bool\r\nSiS_GetLVDSCRT1Ptr(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex, unsigned short *ResIndex,\r\nunsigned short *DisplayType)\r\n{\r\nunsigned short modeflag = 0;\r\nbool checkhd = true;\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\n(*ResIndex) = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\n(*ResIndex) = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\n}\r\n(*ResIndex) &= 0x3F;\r\nif((SiS_Pr->SiS_IF_DEF_CH70xx) && (SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\n(*DisplayType) = 80;\r\nif((SiS_Pr->SiS_TVMode & TVSetPAL) && (!(SiS_Pr->SiS_TVMode & TVSetPALM))) {\r\n(*DisplayType) = 82;\r\nif(SiS_Pr->SiS_ModeType > ModeVGA) {\r\nif(SiS_Pr->SiS_CHSOverScan) (*DisplayType) = 84;\r\n}\r\n}\r\nif((*DisplayType) != 84) {\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) (*DisplayType)++;\r\n}\r\n} else {\r\n(*DisplayType = 0);\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_320x240_1: (*DisplayType) = 50;\r\ncheckhd = false;\r\nbreak;\r\ncase Panel_320x240_2: (*DisplayType) = 14;\r\nbreak;\r\ncase Panel_320x240_3: (*DisplayType) = 18;\r\nbreak;\r\ncase Panel_640x480: (*DisplayType) = 10;\r\nbreak;\r\ncase Panel_1024x600: (*DisplayType) = 26;\r\nbreak;\r\ndefault: return true;\r\n}\r\nif(checkhd) {\r\nif(modeflag & HalfDCLK) (*DisplayType)++;\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x600) {\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) (*DisplayType) += 2;\r\n}\r\n}\r\nreturn true;\r\n}\r\nstatic void\r\nSiS_ModCRT1CRTC(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short tempah, i, modeflag, j, ResIndex, DisplayType;\r\nconst struct SiS_LVDSCRT1Data *LVDSCRT1Ptr=NULL;\r\nstatic const unsigned short CRIdx[] = {\r\n0x00, 0x02, 0x03, 0x04, 0x05, 0x06,\r\n0x07, 0x10, 0x11, 0x15, 0x16\r\n};\r\nif((SiS_Pr->SiS_CustomT == CUT_BARCO1366) ||\r\n(SiS_Pr->SiS_CustomT == CUT_BARCO1024) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL848) ||\r\n(SiS_Pr->SiS_CustomT == CUT_PANEL856) )\r\nreturn;\r\nif(SiS_Pr->SiS_IF_DEF_LVDS) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) return;\r\n}\r\n} else if(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) return;\r\n} else return;\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) return;\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_SetFlag & SetDOSMode) return;\r\n}\r\nif(!(SiS_GetLVDSCRT1Ptr(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex,\r\n&ResIndex, &DisplayType))) {\r\nreturn;\r\n}\r\nswitch(DisplayType) {\r\ncase 50: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1320x240_1; break;\r\ncase 14: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1320x240_2; break;\r\ncase 15: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1320x240_2_H; break;\r\ncase 18: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1320x240_3; break;\r\ncase 19: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1320x240_3_H; break;\r\ncase 10: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1640x480_1; break;\r\ncase 11: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT1640x480_1_H; break;\r\n#if 0\r\ncase 26: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT11024x600_1; break;\r\ncase 27: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT11024x600_1_H; break;\r\ncase 28: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT11024x600_2; break;\r\ncase 29: LVDSCRT1Ptr = SiS_Pr->SiS_LVDSCRT11024x600_2_H; break;\r\n#endif\r\ncase 80: LVDSCRT1Ptr = SiS_Pr->SiS_CHTVCRT1UNTSC; break;\r\ncase 81: LVDSCRT1Ptr = SiS_Pr->SiS_CHTVCRT1ONTSC; break;\r\ncase 82: LVDSCRT1Ptr = SiS_Pr->SiS_CHTVCRT1UPAL; break;\r\ncase 83: LVDSCRT1Ptr = SiS_Pr->SiS_CHTVCRT1OPAL; break;\r\ncase 84: LVDSCRT1Ptr = SiS_Pr->SiS_CHTVCRT1SOPAL; break;\r\n}\r\nif(LVDSCRT1Ptr) {\r\nSiS_SetRegAND(SiS_Pr->SiS_P3d4,0x11,0x7f);\r\nfor(i = 0; i <= 10; i++) {\r\ntempah = (LVDSCRT1Ptr + ResIndex)->CR[i];\r\nSiS_SetReg(SiS_Pr->SiS_P3d4,CRIdx[i],tempah);\r\n}\r\nfor(i = 0x0A, j = 11; i <= 0x0C; i++, j++) {\r\ntempah = (LVDSCRT1Ptr + ResIndex)->CR[j];\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,i,tempah);\r\n}\r\ntempah = (LVDSCRT1Ptr + ResIndex)->CR[14] & 0xE0;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x0E,0x1f,tempah);\r\nif(ModeNo <= 0x13) modeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\nelse modeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ntempah = ((LVDSCRT1Ptr + ResIndex)->CR[14] & 0x01) << 5;\r\nif(modeflag & DoubleScanMode) tempah |= 0x80;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x09,~0x020,tempah);\r\n} else {\r\nSiS_CalcLCDACRT1Timing(SiS_Pr, ModeNo, ModeIdIndex);\r\n}\r\n}\r\nstatic void\r\nSiS_SetCRT2ECLK(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short clkbase, vclkindex = 0;\r\nunsigned char sr2b, sr2c;\r\nif(SiS_Pr->SiS_LCDInfo & LCDPass11) {\r\nSiS_Pr->SiS_SetFlag &= (~ProgrammingCRT2);\r\nif(SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRTVCLK == 2) {\r\nRefreshRateTableIndex--;\r\n}\r\nvclkindex = SiS_GetVCLK2Ptr(SiS_Pr, ModeNo, ModeIdIndex,\r\nRefreshRateTableIndex);\r\nSiS_Pr->SiS_SetFlag |= ProgrammingCRT2;\r\n} else {\r\nvclkindex = SiS_GetVCLK2Ptr(SiS_Pr, ModeNo, ModeIdIndex,\r\nRefreshRateTableIndex);\r\n}\r\nsr2b = SiS_Pr->SiS_VCLKData[vclkindex].SR2B;\r\nsr2c = SiS_Pr->SiS_VCLKData[vclkindex].SR2C;\r\nif((SiS_Pr->SiS_CustomT == CUT_BARCO1366) || (SiS_Pr->SiS_CustomT == CUT_BARCO1024)) {\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(ROMAddr[0x220] & 0x01) {\r\nsr2b = ROMAddr[0x227];\r\nsr2c = ROMAddr[0x228];\r\n}\r\n}\r\n}\r\nclkbase = 0x02B;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA)) {\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) {\r\nclkbase += 3;\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x31,0x20);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,clkbase,sr2b);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,clkbase+1,sr2c);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x31,0x10);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,clkbase,sr2b);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,clkbase+1,sr2c);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x31,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,clkbase,sr2b);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,clkbase+1,sr2c);\r\n}\r\nstatic void\r\nSiS_SetCHTVReg(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefreshRateTableIndex)\r\n{\r\nunsigned short TVType, resindex;\r\nconst struct SiS_CHTVRegData *CHTVRegData = NULL;\r\nif(ModeNo <= 0x13)\r\nresindex = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\nelse\r\nresindex = SiS_Pr->SiS_RefIndex[RefreshRateTableIndex].Ext_CRT2CRTC;\r\nresindex &= 0x3F;\r\nTVType = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) TVType += 1;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nTVType += 2;\r\nif(SiS_Pr->SiS_ModeType > ModeVGA) {\r\nif(SiS_Pr->SiS_CHSOverScan) TVType = 8;\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) {\r\nTVType = 4;\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) TVType += 1;\r\n} else if(SiS_Pr->SiS_TVMode & TVSetPALN) {\r\nTVType = 6;\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) TVType += 1;\r\n}\r\n}\r\nswitch(TVType) {\r\ncase 0: CHTVRegData = SiS_Pr->SiS_CHTVReg_UNTSC; break;\r\ncase 1: CHTVRegData = SiS_Pr->SiS_CHTVReg_ONTSC; break;\r\ncase 2: CHTVRegData = SiS_Pr->SiS_CHTVReg_UPAL; break;\r\ncase 3: CHTVRegData = SiS_Pr->SiS_CHTVReg_OPAL; break;\r\ncase 4: CHTVRegData = SiS_Pr->SiS_CHTVReg_UPALM; break;\r\ncase 5: CHTVRegData = SiS_Pr->SiS_CHTVReg_OPALM; break;\r\ncase 6: CHTVRegData = SiS_Pr->SiS_CHTVReg_UPALN; break;\r\ncase 7: CHTVRegData = SiS_Pr->SiS_CHTVReg_OPALN; break;\r\ncase 8: CHTVRegData = SiS_Pr->SiS_CHTVReg_SOPAL; break;\r\ndefault: CHTVRegData = SiS_Pr->SiS_CHTVReg_OPAL; break;\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1) {\r\n#ifdef CONFIG_FB_SIS_300\r\nif (resindex > 5) return;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) {\r\nSiS_SetCH700x(SiS_Pr,0x04,0x43);\r\nSiS_SetCH700x(SiS_Pr,0x09,0x69);\r\n} else {\r\nSiS_SetCH700x(SiS_Pr,0x04,0x03);\r\nSiS_SetCH700x(SiS_Pr,0x09,0x71);\r\n}\r\nSiS_SetCH700x(SiS_Pr,0x00,CHTVRegData[resindex].Reg[0]);\r\nSiS_SetCH700x(SiS_Pr,0x07,CHTVRegData[resindex].Reg[1]);\r\nSiS_SetCH700x(SiS_Pr,0x08,CHTVRegData[resindex].Reg[2]);\r\nSiS_SetCH700x(SiS_Pr,0x0a,CHTVRegData[resindex].Reg[3]);\r\nSiS_SetCH700x(SiS_Pr,0x0b,CHTVRegData[resindex].Reg[4]);\r\nSiS_SetCH700x(SiS_Pr,0x01,0x28);\r\nSiS_SetCH700x(SiS_Pr,0x03,0xb1);\r\n#ifndef SIS_CP\r\nSiS_SetCH70xx(SiS_Pr,0x3d,0x00);\r\n#endif\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x10,0x00,0x1F);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x11,0x02,0xF8);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1c,0x00,0xEF);\r\nif(!(SiS_Pr->SiS_TVMode & TVSetPAL)) {\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) {\r\nif(resindex == 0x04) {\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x00,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x01,0xFE);\r\n} else if(resindex == 0x05) {\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x18,0x01,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x19,0x0C,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1a,0x00,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1b,0x00,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1c,0x00,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1d,0x00,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1e,0x00,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1f,0x00,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x01,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x00,0xFE);\r\n}\r\n} else {\r\nif(resindex == 0x04) {\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x00,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x01,0xFE);\r\n} else if(resindex == 0x05) {\r\n#if 0\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x18,0x01,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x19,0x09,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1a,0x08,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1b,0x0b,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1c,0x04,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1d,0x01,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1e,0x06,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x1f,0x05,0xF0);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x00,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x00,0xFE); * ACIV off, need to set FSCI */\r\n#endif\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x00,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x01,0xFE);\r\n}\r\n}\r\n} else {\r\nif(resindex == 0x04) {\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x00,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x01,0xFE);\r\n} else {\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x20,0x00,0xEF);\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x21,0x01,0xFE);\r\n}\r\n}\r\n#endif\r\n} else {\r\n#ifdef CONFIG_FB_SIS_315\r\nunsigned short temp;\r\nif (resindex > 6) return;\r\ntemp = CHTVRegData[resindex].Reg[0];\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSCJ) temp |= 0x10;\r\nSiS_SetCH701x(SiS_Pr,0x00,temp);\r\nSiS_SetCH701x(SiS_Pr,0x01,CHTVRegData[resindex].Reg[1]);\r\nSiS_SetCH701x(SiS_Pr,0x02,CHTVRegData[resindex].Reg[2]);\r\nSiS_SetCH701x(SiS_Pr,0x04,CHTVRegData[resindex].Reg[3]);\r\nSiS_SetCH701x(SiS_Pr,0x03,CHTVRegData[resindex].Reg[4]);\r\nSiS_SetCH701x(SiS_Pr,0x05,CHTVRegData[resindex].Reg[5]);\r\nSiS_SetCH701x(SiS_Pr,0x06,CHTVRegData[resindex].Reg[6]);\r\ntemp = CHTVRegData[resindex].Reg[7];\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSCJ) temp = 0x66;\r\nSiS_SetCH701x(SiS_Pr,0x07,temp);\r\nSiS_SetCH701x(SiS_Pr,0x08,CHTVRegData[resindex].Reg[8]);\r\nSiS_SetCH701x(SiS_Pr,0x15,CHTVRegData[resindex].Reg[9]);\r\nSiS_SetCH701x(SiS_Pr,0x1f,CHTVRegData[resindex].Reg[10]);\r\nSiS_SetCH701x(SiS_Pr,0x0c,CHTVRegData[resindex].Reg[11]);\r\nSiS_SetCH701x(SiS_Pr,0x0d,CHTVRegData[resindex].Reg[12]);\r\nSiS_SetCH701x(SiS_Pr,0x0e,CHTVRegData[resindex].Reg[13]);\r\nSiS_SetCH701x(SiS_Pr,0x0f,CHTVRegData[resindex].Reg[14]);\r\nSiS_SetCH701x(SiS_Pr,0x10,CHTVRegData[resindex].Reg[15]);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x21) & ~0x02;\r\nif(SiS_Pr->SiS_TVMode & (TVSetPALN | TVSetNTSCJ)) temp |= 0x02;\r\nSiS_SetCH701x(SiS_Pr,0x21,temp);\r\n#endif\r\n}\r\n#ifdef SIS_CP\r\nSIS_CP_INIT301_CP3\r\n#endif\r\n}\r\nvoid\r\nSiS_Chrontel701xBLOn(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_SetCH701x(SiS_Pr,0x66,0x65);\r\n} else {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\ntemp |= 0x20;\r\nSiS_SetCH701x(SiS_Pr,0x66,temp);\r\n}\r\n}\r\n}\r\nvoid\r\nSiS_Chrontel701xBLOff(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\ntemp &= 0xDF;\r\nSiS_SetCH701x(SiS_Pr,0x66,temp);\r\n}\r\n}\r\nstatic void\r\nSiS_ChrontelPowerSequencing(struct SiS_Private *SiS_Pr)\r\n{\r\nstatic const unsigned char regtable[] = { 0x67, 0x68, 0x69, 0x6a, 0x6b };\r\nstatic const unsigned char table1024_740[] = { 0x01, 0x02, 0x01, 0x01, 0x01 };\r\nstatic const unsigned char table1400_740[] = { 0x01, 0x6e, 0x01, 0x01, 0x01 };\r\nstatic const unsigned char asus1024_740[] = { 0x19, 0x6e, 0x01, 0x19, 0x09 };\r\nstatic const unsigned char asus1400_740[] = { 0x19, 0x6e, 0x01, 0x19, 0x09 };\r\nstatic const unsigned char table1024_650[] = { 0x01, 0x02, 0x01, 0x01, 0x02 };\r\nstatic const unsigned char table1400_650[] = { 0x01, 0x02, 0x01, 0x01, 0x02 };\r\nconst unsigned char *tableptr = NULL;\r\nint i;\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->SiS_CustomT == CUT_ASUSL3000D) tableptr = asus1024_740;\r\nelse tableptr = table1024_740;\r\n} else if((SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200)) {\r\nif(SiS_Pr->SiS_CustomT == CUT_ASUSL3000D) tableptr = asus1400_740;\r\nelse tableptr = table1400_740;\r\n} else return;\r\n} else {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\ntableptr = table1024_650;\r\n} else if((SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) ||\r\n(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200)) {\r\ntableptr = table1400_650;\r\n} else return;\r\n}\r\nfor(i=0; i<5; i++) {\r\nSiS_SetCH701x(SiS_Pr, regtable[i], tableptr[i]);\r\n}\r\n}\r\nstatic void\r\nSiS_SetCH701xForLCD(struct SiS_Private *SiS_Pr)\r\n{\r\nconst unsigned char *tableptr = NULL;\r\nunsigned short tempbh;\r\nint i;\r\nstatic const unsigned char regtable[] = {\r\n0x1c, 0x5f, 0x64, 0x6f, 0x70, 0x71,\r\n0x72, 0x73, 0x74, 0x76, 0x78, 0x7d, 0x66\r\n};\r\nstatic const unsigned char table1024_740[] = {\r\n0x60, 0x02, 0x00, 0x07, 0x40, 0xed,\r\n0xa3, 0xc8, 0xc7, 0xac, 0xe0, 0x02, 0x44\r\n};\r\nstatic const unsigned char table1280_740[] = {\r\n0x60, 0x03, 0x11, 0x00, 0x40, 0xe3,\r\n0xad, 0xdb, 0xf6, 0xac, 0xe0, 0x02, 0x44\r\n};\r\nstatic const unsigned char table1400_740[] = {\r\n0x60, 0x03, 0x11, 0x00, 0x40, 0xe3,\r\n0xad, 0xdb, 0xf6, 0xac, 0xe0, 0x02, 0x44\r\n};\r\nstatic const unsigned char table1600_740[] = {\r\n0x60, 0x04, 0x11, 0x00, 0x40, 0xe3,\r\n0xad, 0xde, 0xf6, 0xac, 0x60, 0x1a, 0x44\r\n};\r\nstatic const unsigned char table1024_650[] = {\r\n0x60, 0x02, 0x00, 0x07, 0x40, 0xed,\r\n0xa3, 0xc8, 0xc7, 0xac, 0x60, 0x02\r\n};\r\nstatic const unsigned char table1280_650[] = {\r\n0x60, 0x03, 0x11, 0x00, 0x40, 0xe3,\r\n0xad, 0xdb, 0xf6, 0xac, 0xe0, 0x02\r\n};\r\nstatic const unsigned char table1400_650[] = {\r\n0x60, 0x03, 0x11, 0x00, 0x40, 0xef,\r\n0xad, 0xdb, 0xf6, 0xac, 0x60, 0x02\r\n};\r\nstatic const unsigned char table1600_650[] = {\r\n0x60, 0x04, 0x11, 0x00, 0x40, 0xe3,\r\n0xad, 0xde, 0xf6, 0xac, 0x60, 0x1a\r\n};\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) tableptr = table1024_740;\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) tableptr = table1280_740;\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) tableptr = table1400_740;\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) tableptr = table1600_740;\r\nelse return;\r\n} else {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) tableptr = table1024_650;\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) tableptr = table1280_650;\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) tableptr = table1400_650;\r\nelse if(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) tableptr = table1600_650;\r\nelse return;\r\n}\r\ntempbh = SiS_GetCH701x(SiS_Pr,0x74);\r\nif((tempbh == 0xf6) || (tempbh == 0xc7)) {\r\ntempbh = SiS_GetCH701x(SiS_Pr,0x73);\r\nif(tempbh == 0xc8) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) return;\r\n} else if(tempbh == 0xdb) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) return;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) return;\r\n} else if(tempbh == 0xde) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) return;\r\n}\r\n}\r\nif(SiS_Pr->ChipType == SIS_740) tempbh = 0x0d;\r\nelse tempbh = 0x0c;\r\nfor(i = 0; i < tempbh; i++) {\r\nSiS_SetCH701x(SiS_Pr, regtable[i], tableptr[i]);\r\n}\r\nSiS_ChrontelPowerSequencing(SiS_Pr);\r\ntempbh = SiS_GetCH701x(SiS_Pr,0x1e);\r\ntempbh |= 0xc0;\r\nSiS_SetCH701x(SiS_Pr,0x1e,tempbh);\r\nif(SiS_Pr->ChipType == SIS_740) {\r\ntempbh = SiS_GetCH701x(SiS_Pr,0x1c);\r\ntempbh &= 0xfb;\r\nSiS_SetCH701x(SiS_Pr,0x1c,tempbh);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2d,0x03);\r\ntempbh = SiS_GetCH701x(SiS_Pr,0x64);\r\ntempbh |= 0x40;\r\nSiS_SetCH701x(SiS_Pr,0x64,tempbh);\r\ntempbh = SiS_GetCH701x(SiS_Pr,0x03);\r\ntempbh &= 0x3f;\r\nSiS_SetCH701x(SiS_Pr,0x03,tempbh);\r\n}\r\n}\r\nstatic void\r\nSiS_ChrontelResetVSync(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char temp, temp1;\r\ntemp1 = SiS_GetCH701x(SiS_Pr,0x49);\r\nSiS_SetCH701x(SiS_Pr,0x49,0x3e);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x47);\r\ntemp &= 0x7f;\r\nSiS_SetCH701x(SiS_Pr,0x47,temp);\r\nSiS_LongDelay(SiS_Pr, 3);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x47);\r\ntemp |= 0x80;\r\nSiS_SetCH701x(SiS_Pr,0x47,temp);\r\nSiS_SetCH701x(SiS_Pr,0x49,temp1);\r\n}\r\nstatic void\r\nSiS_Chrontel701xOn(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(SiS_Pr->ChipType == SIS_740) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x1c);\r\ntemp |= 0x04;\r\nSiS_SetCH701x(SiS_Pr,0x1c,temp);\r\n}\r\nif(SiS_IsYPbPr(SiS_Pr)) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x01);\r\ntemp &= 0x3f;\r\ntemp |= 0x80;\r\nSiS_SetCH701x(SiS_Pr,0x01,temp);\r\n}\r\nif(SiS_IsChScart(SiS_Pr)) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x01);\r\ntemp &= 0x3f;\r\ntemp |= 0xc0;\r\nSiS_SetCH701x(SiS_Pr,0x01,temp);\r\n}\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_ChrontelResetVSync(SiS_Pr);\r\nSiS_SetCH701x(SiS_Pr,0x49,0x20);\r\n} else {\r\nSiS_SetCH701x(SiS_Pr,0x49,0x20);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x49);\r\nif(SiS_IsYPbPr(SiS_Pr)) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x73);\r\ntemp |= 0x60;\r\nSiS_SetCH701x(SiS_Pr,0x73,temp);\r\n}\r\ntemp = SiS_GetCH701x(SiS_Pr,0x47);\r\ntemp &= 0x7f;\r\nSiS_SetCH701x(SiS_Pr,0x47,temp);\r\nSiS_LongDelay(SiS_Pr, 2);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x47);\r\ntemp |= 0x80;\r\nSiS_SetCH701x(SiS_Pr,0x47,temp);\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_Chrontel701xOff(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_LongDelay(SiS_Pr, 1);\r\nSiS_GenericDelay(SiS_Pr, 5887);\r\nSiS_SetCH701x(SiS_Pr,0x76,0xac);\r\nSiS_SetCH701x(SiS_Pr,0x66,0x00);\r\n} else {\r\nSiS_LongDelay(SiS_Pr, 2);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x76);\r\ntemp &= 0xfc;\r\nSiS_SetCH701x(SiS_Pr,0x76,temp);\r\nSiS_SetCH701x(SiS_Pr,0x66,0x00);\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_ChrontelResetDB(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nif(SiS_Pr->ChipType == SIS_740) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x4a);\r\ntemp &= 0x01;\r\nif(!temp) {\r\nif(SiS_WeHaveBacklightCtrl(SiS_Pr)) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x49);\r\nSiS_SetCH701x(SiS_Pr,0x49,0x3e);\r\n}\r\nSiS_SetCH701x(SiS_Pr,0x48,0x10);\r\nSiS_LongDelay(SiS_Pr, 1);\r\nSiS_SetCH701x(SiS_Pr,0x48,0x18);\r\nif(SiS_WeHaveBacklightCtrl(SiS_Pr)) {\r\nSiS_ChrontelResetVSync(SiS_Pr);\r\nSiS_SetCH701x(SiS_Pr,0x49,temp);\r\n}\r\n} else {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x5c);\r\ntemp &= 0xef;\r\nSiS_SetCH701x(SiS_Pr,0x5c,temp);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x5c);\r\ntemp |= 0x10;\r\nSiS_SetCH701x(SiS_Pr,0x5c,temp);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x5c);\r\ntemp &= 0xef;\r\nSiS_SetCH701x(SiS_Pr,0x5c,temp);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x61);\r\nif(!temp) {\r\nSiS_SetCH701xForLCD(SiS_Pr);\r\n}\r\n}\r\n} else {\r\nSiS_SetCH701x(SiS_Pr,0x48,0x10);\r\nSiS_LongDelay(SiS_Pr, 1);\r\nSiS_SetCH701x(SiS_Pr,0x48,0x18);\r\n}\r\n}\r\nstatic void\r\nSiS_ChrontelInitTVVSync(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nif(SiS_WeHaveBacklightCtrl(SiS_Pr)) {\r\nSiS_ChrontelResetVSync(SiS_Pr);\r\n}\r\n} else {\r\nSiS_SetCH701x(SiS_Pr,0x76,0xaf);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x49);\r\ntemp &= 1;\r\nif(temp != 1) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x47);\r\ntemp &= 0x70;\r\nSiS_SetCH701x(SiS_Pr,0x47,temp);\r\nSiS_LongDelay(SiS_Pr, 3);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x47);\r\ntemp |= 0x80;\r\nSiS_SetCH701x(SiS_Pr,0x47,temp);\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_ChrontelDoSomething3(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nunsigned short temp,temp1;\r\nif(SiS_Pr->ChipType == SIS_740) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x61);\r\nif(temp < 1) {\r\ntemp++;\r\nSiS_SetCH701x(SiS_Pr,0x61,temp);\r\n}\r\nSiS_SetCH701x(SiS_Pr,0x66,0x45);\r\nSiS_SetCH701x(SiS_Pr,0x76,0xaf);\r\nSiS_LongDelay(SiS_Pr, 1);\r\nSiS_GenericDelay(SiS_Pr, 5887);\r\n} else {\r\ntemp1 = 0;\r\ntemp = SiS_GetCH701x(SiS_Pr,0x61);\r\nif(temp < 2) {\r\ntemp++;\r\nSiS_SetCH701x(SiS_Pr,0x61,temp);\r\ntemp1 = 1;\r\n}\r\nSiS_SetCH701x(SiS_Pr,0x76,0xac);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\ntemp |= 0x5f;\r\nSiS_SetCH701x(SiS_Pr,0x66,temp);\r\nif(ModeNo > 0x13) {\r\nif(SiS_WeHaveBacklightCtrl(SiS_Pr)) {\r\nSiS_GenericDelay(SiS_Pr, 1023);\r\n} else {\r\nSiS_GenericDelay(SiS_Pr, 767);\r\n}\r\n} else {\r\nif(!temp1)\r\nSiS_GenericDelay(SiS_Pr, 767);\r\n}\r\ntemp = SiS_GetCH701x(SiS_Pr,0x76);\r\ntemp |= 0x03;\r\nSiS_SetCH701x(SiS_Pr,0x76,temp);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\ntemp &= 0x7f;\r\nSiS_SetCH701x(SiS_Pr,0x66,temp);\r\nSiS_LongDelay(SiS_Pr, 1);\r\n}\r\n}\r\nstatic void\r\nSiS_ChrontelDoSomething2(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\nSiS_LongDelay(SiS_Pr, 1);\r\ndo {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\ntemp &= 0x04;\r\nif(temp == 0x04) break;\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_SetCH701x(SiS_Pr,0x76,0xac);\r\n}\r\nSiS_SetCH701xForLCD(SiS_Pr);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x76);\r\ntemp &= 0xfb;\r\nSiS_SetCH701x(SiS_Pr,0x76,temp);\r\nSiS_LongDelay(SiS_Pr, 2);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x76);\r\ntemp |= 0x04;\r\nSiS_SetCH701x(SiS_Pr,0x76,temp);\r\nif(SiS_Pr->ChipType == SIS_740) {\r\nSiS_SetCH701x(SiS_Pr,0x78,0xe0);\r\n} else {\r\nSiS_SetCH701x(SiS_Pr,0x78,0x60);\r\n}\r\nSiS_LongDelay(SiS_Pr, 2);\r\n} while(0);\r\nSiS_SetCH701x(SiS_Pr,0x77,0x00);\r\n}\r\nstatic void\r\nSiS_ChrontelDoSomething1(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp;\r\ntemp = SiS_GetCH701x(SiS_Pr,0x03);\r\ntemp |= 0x80;\r\ntemp &= 0xbf;\r\nSiS_SetCH701x(SiS_Pr,0x03,temp);\r\nif(SiS_Pr->ChipType == SIS_740) {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x1c);\r\ntemp &= 0xfb;\r\nSiS_SetCH701x(SiS_Pr,0x1c,temp);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2d,0x03);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x64);\r\ntemp |= 0x40;\r\nSiS_SetCH701x(SiS_Pr,0x64,temp);\r\ntemp = SiS_GetCH701x(SiS_Pr,0x03);\r\ntemp &= 0x3f;\r\nSiS_SetCH701x(SiS_Pr,0x03,temp);\r\nif(SiS_Pr->SiS_CustomT == CUT_ASUSL3000D) {\r\nSiS_SetCH701x(SiS_Pr,0x63,0x40);\r\nSiS_LongDelay(SiS_Pr, 1);\r\nSiS_SetCH701x(SiS_Pr,0x63,0x00);\r\nSiS_ChrontelResetDB(SiS_Pr);\r\nSiS_ChrontelDoSomething2(SiS_Pr);\r\nSiS_ChrontelDoSomething3(SiS_Pr, 0);\r\n} else {\r\ntemp = SiS_GetCH701x(SiS_Pr,0x66);\r\nif(temp != 0x45) {\r\nSiS_ChrontelResetDB(SiS_Pr);\r\nSiS_ChrontelDoSomething2(SiS_Pr);\r\nSiS_ChrontelDoSomething3(SiS_Pr, 0);\r\n}\r\n}\r\n} else {\r\nSiS_ChrontelResetDB(SiS_Pr);\r\nSiS_ChrontelDoSomething2(SiS_Pr);\r\ntemp = SiS_GetReg(SiS_Pr->SiS_P3d4,0x34);\r\nSiS_ChrontelDoSomething3(SiS_Pr,temp);\r\nSiS_SetCH701x(SiS_Pr,0x76,0xaf);\r\n}\r\n}\r\nbool\r\nSiS_SetCRT2Group(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\n#ifdef CONFIG_FB_SIS_300\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\n#endif\r\nunsigned short ModeIdIndex, RefreshRateTableIndex;\r\nSiS_Pr->SiS_SetFlag |= ProgrammingCRT2;\r\nif(!SiS_Pr->UseCustomMode) {\r\nSiS_SearchModeID(SiS_Pr, &ModeNo, &ModeIdIndex);\r\n} else {\r\nModeIdIndex = 0;\r\n}\r\nSiS_Pr->SiS_SelectCRT2Rate = 4;\r\nSiS_UnLockCRT2(SiS_Pr);\r\nRefreshRateTableIndex = SiS_GetRatePtr(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_SaveCRT2Info(SiS_Pr,ModeNo);\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nSiS_DisableBridge(SiS_Pr);\r\nif((SiS_Pr->SiS_IF_DEF_LVDS == 1) && (SiS_Pr->ChipType == SIS_730)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x00,0x80);\r\n}\r\nSiS_SetCRT2ModeRegs(SiS_Pr, ModeNo, ModeIdIndex);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & DisableCRT2Display) {\r\nSiS_LockCRT2(SiS_Pr);\r\nSiS_DisplayOn(SiS_Pr);\r\nreturn true;\r\n}\r\nSiS_GetCRT2Data(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\nSiS_Pr->SiS_LCDHDES = SiS_Pr->SiS_LCDVDES = 0;\r\nif( (SiS_Pr->SiS_IF_DEF_LVDS == 1) ||\r\n((SiS_Pr->SiS_VBType & VB_NoLCD) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD)) ||\r\n((SiS_Pr->ChipType >= SIS_315H) && (SiS_Pr->SiS_VBType & VB_SIS30xBLV)) ) {\r\nSiS_GetLVDSDesData(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nSiS_SetGroup1(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nSiS_SetGroup2(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS_SetGroup2_C_ELV(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n#endif\r\nSiS_SetGroup3(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_SetGroup4(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS_SetGroup4_C_ELV(SiS_Pr, ModeNo, ModeIdIndex);\r\n#endif\r\nSiS_SetGroup5(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_SetCRT2Sync(SiS_Pr, ModeNo, RefreshRateTableIndex);\r\nif((SiS_Pr->SiS_VBType & VB_NoLCD) && (SiS_Pr->SiS_VBInfo & SetCRT2ToLCD)) {\r\nif(!((SiS_Pr->SiS_SetFlag & SetDOSMode) && ((ModeNo == 0x03) || (ModeNo == 0x10)))) {\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) {\r\nSiS_ModCRT1CRTC(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n}\r\nSiS_SetCRT2ECLK(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n}\r\n} else {\r\nSiS_SetCRT2Sync(SiS_Pr, ModeNo, RefreshRateTableIndex);\r\nSiS_ModCRT1CRTC(SiS_Pr,ModeNo,ModeIdIndex,RefreshRateTableIndex);\r\nSiS_SetCRT2ECLK(SiS_Pr,ModeNo,ModeIdIndex,RefreshRateTableIndex);\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx != 0) {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 2) {\r\n#ifdef CONFIG_FB_SIS_315\r\nSiS_SetCH701xForLCD(SiS_Pr);\r\n#endif\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_SetCHTVReg(SiS_Pr,ModeNo,ModeIdIndex,RefreshRateTableIndex);\r\n}\r\n}\r\n}\r\n}\r\n#ifdef CONFIG_FB_SIS_300\r\nif(SiS_Pr->ChipType < SIS_315H) {\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nif(SiS_Pr->SiS_UseOEM) {\r\nif((SiS_Pr->SiS_UseROM) && (SiS_Pr->SiS_UseOEM == -1)) {\r\nif((ROMAddr[0x233] == 0x12) && (ROMAddr[0x234] == 0x34)) {\r\nSiS_OEM300Setting(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n} else {\r\nSiS_OEM300Setting(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\n}\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif((SiS_Pr->SiS_CustomT == CUT_BARCO1366) ||\r\n(SiS_Pr->SiS_CustomT == CUT_BARCO1024)) {\r\nSetOEMLCDData2(SiS_Pr, ModeNo, ModeIdIndex,RefreshRateTableIndex);\r\n}\r\nSiS_DisplayOn(SiS_Pr);\r\n}\r\n}\r\n}\r\n#endif\r\n#ifdef CONFIG_FB_SIS_315\r\nif(SiS_Pr->ChipType >= SIS_315H) {\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nif(SiS_Pr->ChipType < SIS_661) {\r\nSiS_FinalizeLCD(SiS_Pr, ModeNo, ModeIdIndex);\r\nSiS_OEM310Setting(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n} else {\r\nSiS_OEM661Setting(SiS_Pr, ModeNo, ModeIdIndex, RefreshRateTableIndex);\r\n}\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x01,0x40);\r\n}\r\n}\r\n#endif\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nSiS_EnableBridge(SiS_Pr);\r\n}\r\nSiS_DisplayOn(SiS_Pr);\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_SetRegSR11ANDOR(SiS_Pr,0xFF,0x0C);\r\n} else {\r\nSiS_SetCH70xxANDOR(SiS_Pr,0x0e,0x01,0xf8);\r\n}\r\n}\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nSiS_LockCRT2(SiS_Pr);\r\n}\r\nreturn true;\r\n}\r\nvoid\r\nSiS_SiS30xBLOn(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_DDC2Delay(SiS_Pr,0xff00);\r\nif(!(SiS_GetReg(SiS_Pr->SiS_Part4Port,0x26) & 0x02)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x02);\r\nSiS_WaitVBRetrace(SiS_Pr);\r\n}\r\nif(!(SiS_GetReg(SiS_Pr->SiS_Part4Port,0x26) & 0x01)) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part4Port,0x26,0x01);\r\n}\r\n}\r\nvoid\r\nSiS_SiS30xBLOff(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x26,0xFE);\r\nSiS_DDC2Delay(SiS_Pr,0xff00);\r\n}\r\nstatic void\r\nSiS_SetupDDCN(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_Pr->SiS_DDC_NData = ~SiS_Pr->SiS_DDC_Data;\r\nSiS_Pr->SiS_DDC_NClk = ~SiS_Pr->SiS_DDC_Clk;\r\nif((SiS_Pr->SiS_DDC_Index == 0x11) && (SiS_Pr->SiS_SensibleSR11)) {\r\nSiS_Pr->SiS_DDC_NData &= 0x0f;\r\nSiS_Pr->SiS_DDC_NClk &= 0x0f;\r\n}\r\n}\r\nstatic unsigned char *\r\nSiS_SetTrumpBlockLoop(struct SiS_Private *SiS_Pr, unsigned char *dataptr)\r\n{\r\nint i, j, num;\r\nunsigned short tempah,temp;\r\nunsigned char *mydataptr;\r\nfor(i=0; i<20; i++) {\r\nmydataptr = dataptr;\r\nnum = *mydataptr++;\r\nif(!num) return mydataptr;\r\nif(i) {\r\nSiS_SetStop(SiS_Pr);\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT * 2);\r\n}\r\nif(SiS_SetStart(SiS_Pr)) continue;\r\ntempah = SiS_Pr->SiS_DDC_DeviceAddr;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr,tempah);\r\nif(temp) continue;\r\ntempah = *mydataptr++;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr,tempah);\r\nif(temp) continue;\r\nfor(j=0; j<num; j++) {\r\ntempah = *mydataptr++;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr,tempah);\r\nif(temp) break;\r\n}\r\nif(temp) continue;\r\nif(SiS_SetStop(SiS_Pr)) continue;\r\nreturn mydataptr;\r\n}\r\nreturn NULL;\r\n}\r\nstatic bool\r\nSiS_SetTrumpionBlock(struct SiS_Private *SiS_Pr, unsigned char *dataptr)\r\n{\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xF0;\r\nSiS_Pr->SiS_DDC_Index = 0x11;\r\nSiS_Pr->SiS_DDC_Data = 0x02;\r\nSiS_Pr->SiS_DDC_Clk = 0x01;\r\nSiS_SetupDDCN(SiS_Pr);\r\nSiS_SetSwitchDDC2(SiS_Pr);\r\nwhile(*dataptr) {\r\ndataptr = SiS_SetTrumpBlockLoop(SiS_Pr, dataptr);\r\nif(!dataptr) return false;\r\n}\r\nreturn true;\r\n}\r\nstatic bool\r\nSiS_SetChReg(struct SiS_Private *SiS_Pr, unsigned short reg, unsigned char val, unsigned short myor)\r\n{\r\nunsigned short temp, i;\r\nfor(i=0; i<20; i++) {\r\nif(i) {\r\nSiS_SetStop(SiS_Pr);\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT * 4);\r\n}\r\nif(SiS_SetStart(SiS_Pr)) continue;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr, SiS_Pr->SiS_DDC_DeviceAddr);\r\nif(temp) continue;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr, (reg | myor));\r\nif(temp) continue;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr, val);\r\nif(temp) continue;\r\nif(SiS_SetStop(SiS_Pr)) continue;\r\nSiS_Pr->SiS_ChrontelInit = 1;\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid\r\nSiS_SetCH700x(struct SiS_Private *SiS_Pr, unsigned short reg, unsigned char val)\r\n{\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xEA;\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT);\r\nif(!(SiS_Pr->SiS_ChrontelInit)) {\r\nSiS_Pr->SiS_DDC_Index = 0x11;\r\nSiS_Pr->SiS_DDC_Data = 0x02;\r\nSiS_Pr->SiS_DDC_Clk = 0x01;\r\nSiS_SetupDDCN(SiS_Pr);\r\n}\r\nif( (!(SiS_SetChReg(SiS_Pr, reg, val, 0x80))) &&\r\n(!(SiS_Pr->SiS_ChrontelInit)) ) {\r\nSiS_Pr->SiS_DDC_Index = 0x0a;\r\nSiS_Pr->SiS_DDC_Data = 0x80;\r\nSiS_Pr->SiS_DDC_Clk = 0x40;\r\nSiS_SetupDDCN(SiS_Pr);\r\nSiS_SetChReg(SiS_Pr, reg, val, 0x80);\r\n}\r\n}\r\nvoid\r\nSiS_SetCH701x(struct SiS_Private *SiS_Pr, unsigned short reg, unsigned char val)\r\n{\r\nSiS_Pr->SiS_DDC_Index = 0x11;\r\nSiS_Pr->SiS_DDC_Data = 0x08;\r\nSiS_Pr->SiS_DDC_Clk = 0x04;\r\nSiS_SetupDDCN(SiS_Pr);\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xEA;\r\nSiS_SetChReg(SiS_Pr, reg, val, 0);\r\n}\r\nstatic\r\nvoid\r\nSiS_SetCH70xx(struct SiS_Private *SiS_Pr, unsigned short reg, unsigned char val)\r\n{\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1)\r\nSiS_SetCH700x(SiS_Pr, reg, val);\r\nelse\r\nSiS_SetCH701x(SiS_Pr, reg, val);\r\n}\r\nstatic unsigned short\r\nSiS_GetChReg(struct SiS_Private *SiS_Pr, unsigned short myor)\r\n{\r\nunsigned short tempah, temp, i;\r\nfor(i=0; i<20; i++) {\r\nif(i) {\r\nSiS_SetStop(SiS_Pr);\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT * 4);\r\n}\r\nif(SiS_SetStart(SiS_Pr)) continue;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr,SiS_Pr->SiS_DDC_DeviceAddr);\r\nif(temp) continue;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr,SiS_Pr->SiS_DDC_ReadAddr | myor);\r\nif(temp) continue;\r\nif (SiS_SetStart(SiS_Pr)) continue;\r\ntemp = SiS_WriteDDC2Data(SiS_Pr,SiS_Pr->SiS_DDC_DeviceAddr | 0x01);\r\nif(temp) continue;\r\ntempah = SiS_ReadDDC2Data(SiS_Pr);\r\nif(SiS_SetStop(SiS_Pr)) continue;\r\nSiS_Pr->SiS_ChrontelInit = 1;\r\nreturn tempah;\r\n}\r\nreturn 0xFFFF;\r\n}\r\nunsigned short\r\nSiS_GetCH700x(struct SiS_Private *SiS_Pr, unsigned short tempbx)\r\n{\r\nunsigned short result;\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xEA;\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT);\r\nif(!(SiS_Pr->SiS_ChrontelInit)) {\r\nSiS_Pr->SiS_DDC_Index = 0x11;\r\nSiS_Pr->SiS_DDC_Data = 0x02;\r\nSiS_Pr->SiS_DDC_Clk = 0x01;\r\nSiS_SetupDDCN(SiS_Pr);\r\n}\r\nSiS_Pr->SiS_DDC_ReadAddr = tempbx;\r\nif( ((result = SiS_GetChReg(SiS_Pr,0x80)) == 0xFFFF) &&\r\n(!SiS_Pr->SiS_ChrontelInit) ) {\r\nSiS_Pr->SiS_DDC_Index = 0x0a;\r\nSiS_Pr->SiS_DDC_Data = 0x80;\r\nSiS_Pr->SiS_DDC_Clk = 0x40;\r\nSiS_SetupDDCN(SiS_Pr);\r\nresult = SiS_GetChReg(SiS_Pr,0x80);\r\n}\r\nreturn result;\r\n}\r\nunsigned short\r\nSiS_GetCH701x(struct SiS_Private *SiS_Pr, unsigned short tempbx)\r\n{\r\nSiS_Pr->SiS_DDC_Index = 0x11;\r\nSiS_Pr->SiS_DDC_Data = 0x08;\r\nSiS_Pr->SiS_DDC_Clk = 0x04;\r\nSiS_SetupDDCN(SiS_Pr);\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xEA;\r\nSiS_Pr->SiS_DDC_ReadAddr = tempbx;\r\nreturn SiS_GetChReg(SiS_Pr,0);\r\n}\r\nstatic\r\nunsigned short\r\nSiS_GetCH70xx(struct SiS_Private *SiS_Pr, unsigned short tempbx)\r\n{\r\nif(SiS_Pr->SiS_IF_DEF_CH70xx == 1)\r\nreturn SiS_GetCH700x(SiS_Pr, tempbx);\r\nelse\r\nreturn SiS_GetCH701x(SiS_Pr, tempbx);\r\n}\r\nvoid\r\nSiS_SetCH70xxANDOR(struct SiS_Private *SiS_Pr, unsigned short reg,\r\nunsigned char myor, unsigned short myand)\r\n{\r\nunsigned short tempbl;\r\ntempbl = (SiS_GetCH70xx(SiS_Pr, (reg & 0xFF)) & myand) | myor;\r\nSiS_SetCH70xx(SiS_Pr, reg, tempbl);\r\n}\r\nstatic\r\nunsigned short\r\nSiS_InitDDCRegs(struct SiS_Private *SiS_Pr, unsigned int VBFlags, int VGAEngine,\r\nunsigned short adaptnum, unsigned short DDCdatatype, bool checkcr32,\r\nunsigned int VBFlags2)\r\n{\r\nunsigned char ddcdtype[] = { 0xa0, 0xa0, 0xa0, 0xa2, 0xa6 };\r\nunsigned char flag, cr32;\r\nunsigned short temp = 0, myadaptnum = adaptnum;\r\nif(adaptnum != 0) {\r\nif(!(VBFlags2 & VB2_SISTMDSBRIDGE)) return 0xFFFF;\r\nif((VBFlags2 & VB2_30xBDH) && (adaptnum == 1)) return 0xFFFF;\r\n}\r\nSiS_Pr->SiS_ChrontelInit = 0;\r\nSiS_Pr->SiS_DDC_SecAddr = 0;\r\nSiS_Pr->SiS_DDC_DeviceAddr = ddcdtype[DDCdatatype];\r\nSiS_Pr->SiS_DDC_Port = SiS_Pr->SiS_P3c4;\r\nSiS_Pr->SiS_DDC_Index = 0x11;\r\nflag = 0xff;\r\ncr32 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x32);\r\n#if 0\r\nif(VBFlags2 & VB2_SISBRIDGE) {\r\nif(myadaptnum == 0) {\r\nif(!(cr32 & 0x20)) {\r\nmyadaptnum = 2;\r\nif(!(cr32 & 0x10)) {\r\nmyadaptnum = 1;\r\nif(!(cr32 & 0x08)) {\r\nmyadaptnum = 0;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n#endif\r\nif(VGAEngine == SIS_300_VGA) {\r\nif(myadaptnum != 0) {\r\nflag = 0;\r\nif(VBFlags2 & VB2_SISBRIDGE) {\r\nSiS_Pr->SiS_DDC_Port = SiS_Pr->SiS_Part4Port;\r\nSiS_Pr->SiS_DDC_Index = 0x0f;\r\n}\r\n}\r\nif(!(VBFlags2 & VB2_301)) {\r\nif((cr32 & 0x80) && (checkcr32)) {\r\nif(myadaptnum >= 1) {\r\nif(!(cr32 & 0x08)) {\r\nmyadaptnum = 1;\r\nif(!(cr32 & 0x10)) return 0xFFFF;\r\n}\r\n}\r\n}\r\n}\r\ntemp = 4 - (myadaptnum * 2);\r\nif(flag) temp = 0;\r\n} else {\r\nif(VBFlags2 & VB2_SISBRIDGE) {\r\nif(myadaptnum == 2) {\r\nmyadaptnum = 1;\r\n}\r\n}\r\nif(myadaptnum == 1) {\r\nflag = 0;\r\nif(VBFlags2 & VB2_SISBRIDGE) {\r\nSiS_Pr->SiS_DDC_Port = SiS_Pr->SiS_Part4Port;\r\nSiS_Pr->SiS_DDC_Index = 0x0f;\r\n}\r\n}\r\nif((cr32 & 0x80) && (checkcr32)) {\r\nif(myadaptnum >= 1) {\r\nif(!(cr32 & 0x08)) {\r\nmyadaptnum = 1;\r\nif(!(cr32 & 0x10)) return 0xFFFF;\r\n}\r\n}\r\n}\r\ntemp = myadaptnum;\r\nif(myadaptnum == 1) {\r\ntemp = 0;\r\nif(VBFlags2 & VB2_LVDS) flag = 0xff;\r\n}\r\nif(flag) temp = 0;\r\n}\r\nSiS_Pr->SiS_DDC_Data = 0x02 << temp;\r\nSiS_Pr->SiS_DDC_Clk = 0x01 << temp;\r\nSiS_SetupDDCN(SiS_Pr);\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_WriteDABDDC(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_SetStart(SiS_Pr)) return 0xFFFF;\r\nif(SiS_WriteDDC2Data(SiS_Pr, SiS_Pr->SiS_DDC_DeviceAddr)) {\r\nreturn 0xFFFF;\r\n}\r\nif(SiS_WriteDDC2Data(SiS_Pr, SiS_Pr->SiS_DDC_SecAddr)) {\r\nreturn 0xFFFF;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_PrepareReadDDC(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_SetStart(SiS_Pr)) return 0xFFFF;\r\nif(SiS_WriteDDC2Data(SiS_Pr, (SiS_Pr->SiS_DDC_DeviceAddr | 0x01))) {\r\nreturn 0xFFFF;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_PrepareDDC(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_WriteDABDDC(SiS_Pr)) SiS_WriteDABDDC(SiS_Pr);\r\nif(SiS_PrepareReadDDC(SiS_Pr)) return (SiS_PrepareReadDDC(SiS_Pr));\r\nreturn 0;\r\n}\r\nstatic void\r\nSiS_SendACK(struct SiS_Private *SiS_Pr, unsigned short yesno)\r\n{\r\nSiS_SetSCLKLow(SiS_Pr);\r\nif(yesno) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\nSiS_Pr->SiS_DDC_Data);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\n0);\r\n}\r\nSiS_SetSCLKHigh(SiS_Pr);\r\n}\r\nstatic unsigned short\r\nSiS_DoProbeDDC(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char mask, value;\r\nunsigned short temp, ret=0;\r\nbool failed = false;\r\nSiS_SetSwitchDDC2(SiS_Pr);\r\nif(SiS_PrepareDDC(SiS_Pr)) {\r\nSiS_SetStop(SiS_Pr);\r\nreturn 0xFFFF;\r\n}\r\nmask = 0xf0;\r\nvalue = 0x20;\r\nif(SiS_Pr->SiS_DDC_DeviceAddr == 0xa0) {\r\ntemp = (unsigned char)SiS_ReadDDC2Data(SiS_Pr);\r\nSiS_SendACK(SiS_Pr, 0);\r\nif(temp == 0) {\r\nmask = 0xff;\r\nvalue = 0xff;\r\n} else {\r\nfailed = true;\r\nret = 0xFFFF;\r\n}\r\n}\r\nif(!failed) {\r\ntemp = (unsigned char)SiS_ReadDDC2Data(SiS_Pr);\r\nSiS_SendACK(SiS_Pr, 1);\r\ntemp &= mask;\r\nif(temp == value) ret = 0;\r\nelse {\r\nret = 0xFFFF;\r\nif(SiS_Pr->SiS_DDC_DeviceAddr == 0xa0) {\r\nif(temp == 0x30) ret = 0;\r\n}\r\n}\r\n}\r\nSiS_SetStop(SiS_Pr);\r\nreturn ret;\r\n}\r\nstatic\r\nunsigned short\r\nSiS_ProbeDDC(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short flag;\r\nflag = 0x180;\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xa0;\r\nif(!(SiS_DoProbeDDC(SiS_Pr))) flag |= 0x02;\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xa2;\r\nif(!(SiS_DoProbeDDC(SiS_Pr))) flag |= 0x08;\r\nSiS_Pr->SiS_DDC_DeviceAddr = 0xa6;\r\nif(!(SiS_DoProbeDDC(SiS_Pr))) flag |= 0x10;\r\nif(!(flag & 0x1a)) flag = 0;\r\nreturn flag;\r\n}\r\nstatic\r\nunsigned short\r\nSiS_ReadDDC(struct SiS_Private *SiS_Pr, unsigned short DDCdatatype, unsigned char *buffer)\r\n{\r\nunsigned short flag, length, i;\r\nunsigned char chksum,gotcha;\r\nif(DDCdatatype > 4) return 0xFFFF;\r\nflag = 0;\r\nSiS_SetSwitchDDC2(SiS_Pr);\r\nif(!(SiS_PrepareDDC(SiS_Pr))) {\r\nlength = 127;\r\nif(DDCdatatype != 1) length = 255;\r\nchksum = 0;\r\ngotcha = 0;\r\nfor(i=0; i<length; i++) {\r\nbuffer[i] = (unsigned char)SiS_ReadDDC2Data(SiS_Pr);\r\nchksum += buffer[i];\r\ngotcha |= buffer[i];\r\nSiS_SendACK(SiS_Pr, 0);\r\n}\r\nbuffer[i] = (unsigned char)SiS_ReadDDC2Data(SiS_Pr);\r\nchksum += buffer[i];\r\nSiS_SendACK(SiS_Pr, 1);\r\nif(gotcha) flag = (unsigned short)chksum;\r\nelse flag = 0xFFFF;\r\n} else {\r\nflag = 0xFFFF;\r\n}\r\nSiS_SetStop(SiS_Pr);\r\nreturn flag;\r\n}\r\nunsigned short\r\nSiS_HandleDDC(struct SiS_Private *SiS_Pr, unsigned int VBFlags, int VGAEngine,\r\nunsigned short adaptnum, unsigned short DDCdatatype, unsigned char *buffer,\r\nunsigned int VBFlags2)\r\n{\r\nunsigned char sr1f, cr17=1;\r\nunsigned short result;\r\nif(adaptnum > 2)\r\nreturn 0xFFFF;\r\nif(DDCdatatype > 4)\r\nreturn 0xFFFF;\r\nif((!(VBFlags2 & VB2_VIDEOBRIDGE)) && (adaptnum > 0))\r\nreturn 0xFFFF;\r\nif(SiS_InitDDCRegs(SiS_Pr, VBFlags, VGAEngine, adaptnum, DDCdatatype, false, VBFlags2) == 0xFFFF)\r\nreturn 0xFFFF;\r\nsr1f = SiS_GetReg(SiS_Pr->SiS_P3c4,0x1f);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_P3c4,0x1f,0x3f,0x04);\r\nif(VGAEngine == SIS_300_VGA) {\r\ncr17 = SiS_GetReg(SiS_Pr->SiS_P3d4,0x17) & 0x80;\r\nif(!cr17) {\r\nSiS_SetRegOR(SiS_Pr->SiS_P3d4,0x17,0x80);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x00,0x01);\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x00,0x03);\r\n}\r\n}\r\nif((sr1f) || (!cr17)) {\r\nSiS_WaitRetrace1(SiS_Pr);\r\nSiS_WaitRetrace1(SiS_Pr);\r\nSiS_WaitRetrace1(SiS_Pr);\r\nSiS_WaitRetrace1(SiS_Pr);\r\n}\r\nif(DDCdatatype == 0) {\r\nresult = SiS_ProbeDDC(SiS_Pr);\r\n} else {\r\nresult = SiS_ReadDDC(SiS_Pr, DDCdatatype, buffer);\r\nif((!result) && (DDCdatatype == 1)) {\r\nif((buffer[0] == 0x00) && (buffer[1] == 0xff) &&\r\n(buffer[2] == 0xff) && (buffer[3] == 0xff) &&\r\n(buffer[4] == 0xff) && (buffer[5] == 0xff) &&\r\n(buffer[6] == 0xff) && (buffer[7] == 0x00) &&\r\n(buffer[0x12] == 1)) {\r\nif(!SiS_Pr->DDCPortMixup) {\r\nif(adaptnum == 1) {\r\nif(!(buffer[0x14] & 0x80)) result = 0xFFFE;\r\n} else {\r\nif(buffer[0x14] & 0x80) result = 0xFFFE;\r\n}\r\n}\r\n}\r\n}\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_P3c4,0x1f,sr1f);\r\nif(VGAEngine == SIS_300_VGA) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_P3d4,0x17,0x7f,cr17);\r\n}\r\nreturn result;\r\n}\r\nstatic void\r\nSiS_SetSwitchDDC2(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetSCLKHigh(SiS_Pr);\r\nSiS_WaitRetrace1(SiS_Pr);\r\nSiS_SetSCLKLow(SiS_Pr);\r\nSiS_WaitRetrace1(SiS_Pr);\r\n}\r\nunsigned short\r\nSiS_ReadDDC1Bit(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_WaitRetrace1(SiS_Pr);\r\nreturn ((SiS_GetReg(SiS_Pr->SiS_P3c4,0x11) & 0x02) >> 1);\r\n}\r\nstatic unsigned short\r\nSiS_SetStart(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_SetSCLKLow(SiS_Pr)) return 0xFFFF;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\nSiS_Pr->SiS_DDC_Data);\r\nif(SiS_SetSCLKHigh(SiS_Pr)) return 0xFFFF;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\n0x00);\r\nif(SiS_SetSCLKHigh(SiS_Pr)) return 0xFFFF;\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_SetStop(struct SiS_Private *SiS_Pr)\r\n{\r\nif(SiS_SetSCLKLow(SiS_Pr)) return 0xFFFF;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\n0x00);\r\nif(SiS_SetSCLKHigh(SiS_Pr)) return 0xFFFF;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\nSiS_Pr->SiS_DDC_Data);\r\nif(SiS_SetSCLKHigh(SiS_Pr)) return 0xFFFF;\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_WriteDDC2Data(struct SiS_Private *SiS_Pr, unsigned short tempax)\r\n{\r\nunsigned short i,flag,temp;\r\nflag = 0x80;\r\nfor(i = 0; i < 8; i++) {\r\nSiS_SetSCLKLow(SiS_Pr);\r\nif(tempax & flag) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\nSiS_Pr->SiS_DDC_Data);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\n0x00);\r\n}\r\nSiS_SetSCLKHigh(SiS_Pr);\r\nflag >>= 1;\r\n}\r\ntemp = SiS_CheckACK(SiS_Pr);\r\nreturn temp;\r\n}\r\nstatic unsigned short\r\nSiS_ReadDDC2Data(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short i, temp, getdata;\r\ngetdata = 0;\r\nfor(i = 0; i < 8; i++) {\r\ngetdata <<= 1;\r\nSiS_SetSCLKLow(SiS_Pr);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\nSiS_Pr->SiS_DDC_Data);\r\nSiS_SetSCLKHigh(SiS_Pr);\r\ntemp = SiS_GetReg(SiS_Pr->SiS_DDC_Port,SiS_Pr->SiS_DDC_Index);\r\nif(temp & SiS_Pr->SiS_DDC_Data) getdata |= 0x01;\r\n}\r\nreturn getdata;\r\n}\r\nstatic unsigned short\r\nSiS_SetSCLKLow(struct SiS_Private *SiS_Pr)\r\n{\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NClk,\r\n0x00);\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT);\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_SetSCLKHigh(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short temp, watchdog=1000;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NClk,\r\nSiS_Pr->SiS_DDC_Clk);\r\ndo {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_DDC_Port,SiS_Pr->SiS_DDC_Index);\r\n} while((!(temp & SiS_Pr->SiS_DDC_Clk)) && --watchdog);\r\nif (!watchdog) {\r\nreturn 0xFFFF;\r\n}\r\nSiS_DDC2Delay(SiS_Pr,SiS_I2CDELAYSHORT);\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nSiS_CheckACK(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short tempah;\r\nSiS_SetSCLKLow(SiS_Pr);\r\nSiS_SetRegANDOR(SiS_Pr->SiS_DDC_Port,\r\nSiS_Pr->SiS_DDC_Index,\r\nSiS_Pr->SiS_DDC_NData,\r\nSiS_Pr->SiS_DDC_Data);\r\nSiS_SetSCLKHigh(SiS_Pr);\r\ntempah = SiS_GetReg(SiS_Pr->SiS_DDC_Port,SiS_Pr->SiS_DDC_Index);\r\nSiS_SetSCLKLow(SiS_Pr);\r\nif(tempah & SiS_Pr->SiS_DDC_Data) return 1;\r\nreturn 0;\r\n}\r\nstatic unsigned short\r\nGetRAMDACromptr(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr;\r\nif(SiS_Pr->ChipType < SIS_330) {\r\nromptr = SISGETROMW(0x128);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xB)\r\nromptr = SISGETROMW(0x12a);\r\n} else {\r\nromptr = SISGETROMW(0x1a8);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xB)\r\nromptr = SISGETROMW(0x1aa);\r\n}\r\nreturn romptr;\r\n}\r\nstatic unsigned short\r\nGetLCDromptr(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr;\r\nif(SiS_Pr->ChipType < SIS_330) {\r\nromptr = SISGETROMW(0x120);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV)\r\nromptr = SISGETROMW(0x122);\r\n} else {\r\nromptr = SISGETROMW(0x1a0);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV)\r\nromptr = SISGETROMW(0x1a2);\r\n}\r\nreturn romptr;\r\n}\r\nstatic unsigned short\r\nGetTVromptr(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr;\r\nif(SiS_Pr->ChipType < SIS_330) {\r\nromptr = SISGETROMW(0x114);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV)\r\nromptr = SISGETROMW(0x11a);\r\n} else {\r\nromptr = SISGETROMW(0x194);\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV)\r\nromptr = SISGETROMW(0x19a);\r\n}\r\nreturn romptr;\r\n}\r\nstatic unsigned short\r\nGetLCDPtrIndexBIOS(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short index;\r\nif((IS_SIS650) && (SiS_Pr->SiS_VBType & VB_SISLVDS)) {\r\nif(!(SiS_IsNotM650orLater(SiS_Pr))) {\r\nif((index = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) & 0xf0)) {\r\nindex >>= 4;\r\nindex *= 3;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) index += 2;\r\nelse if(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) index++;\r\nreturn index;\r\n}\r\n}\r\n}\r\nindex = SiS_GetBIOSLCDResInfo(SiS_Pr) & 0x0F;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) index -= 5;\r\nif(SiS_Pr->SiS_VBType & VB_SIS301C) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) index -= 5;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x768) index -= 5;\r\n} else {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) index -= 6;\r\n}\r\nindex--;\r\nindex *= 3;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) index += 2;\r\nelse if(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) index++;\r\nreturn index;\r\n}\r\nstatic unsigned short\r\nGetLCDPtrIndex(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short index;\r\nindex = ((SiS_GetBIOSLCDResInfo(SiS_Pr) & 0x0F) - 1) * 3;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) index += 2;\r\nelse if(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) index++;\r\nreturn index;\r\n}\r\nstatic unsigned short\r\nGetTVPtrIndex(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short index;\r\nindex = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) index = 1;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) index = 2;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToYPbPr525750) index = 0;\r\nindex <<= 1;\r\nif((SiS_Pr->SiS_VBInfo & SetInSlaveMode) &&\r\n(SiS_Pr->SiS_TVMode & TVSetTVSimuMode)) {\r\nindex++;\r\n}\r\nreturn index;\r\n}\r\nstatic unsigned int\r\nGetOEMTVPtr661_2_GEN(struct SiS_Private *SiS_Pr, int addme)\r\n{\r\nunsigned short index = 0, temp = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) index = 1;\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) index = 2;\r\nif(SiS_Pr->SiS_TVMode & TVSetPALN) index = 3;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSCJ) index = 6;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSC1024) {\r\nindex = 4;\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) index++;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSCJ) index = 7;\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif((!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) ||\r\n(SiS_Pr->SiS_TVMode & TVSetTVSimuMode)) {\r\nindex += addme;\r\ntemp++;\r\n}\r\ntemp += 0x0100;\r\n}\r\nreturn (unsigned int)(index | (temp << 16));\r\n}\r\nstatic unsigned int\r\nGetOEMTVPtr661_2_OLD(struct SiS_Private *SiS_Pr)\r\n{\r\nreturn (GetOEMTVPtr661_2_GEN(SiS_Pr, 8));\r\n}\r\nstatic int\r\nGetOEMTVPtr661(struct SiS_Private *SiS_Pr)\r\n{\r\nint index = 0;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) index = 2;\r\nif(SiS_Pr->SiS_ROMNew) {\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525i) index = 4;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) index = 6;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) index = 8;\r\nif(SiS_Pr->SiS_TVMode & TVSetHiVision) index = 10;\r\n} else {\r\nif(SiS_Pr->SiS_TVMode & TVSetHiVision) index = 4;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525i) index = 6;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr525p) index = 8;\r\nif(SiS_Pr->SiS_TVMode & TVSetYPbPr750p) index = 10;\r\n}\r\nif(SiS_Pr->SiS_TVMode & TVSetTVSimuMode) index++;\r\nreturn index;\r\n}\r\nstatic void\r\nSetDelayComp(struct SiS_Private *SiS_Pr, unsigned short ModeNo)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short delay=0,index,myindex,temp,romptr=0;\r\nbool dochiptest = true;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x20,0xbf);\r\n} else {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x35,0x7f);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) {\r\nif((SiS_Pr->SiS_UseROM) && (!(SiS_Pr->SiS_ROMNew))) {\r\nromptr = GetRAMDACromptr(SiS_Pr);\r\n}\r\nif(romptr) delay = ROMAddr[romptr];\r\nelse {\r\ndelay = 0x04;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xB) {\r\nif(IS_SIS650) {\r\ndelay = 0x0a;\r\n} else if(IS_SIS740) {\r\ndelay = 0x00;\r\n} else if(SiS_Pr->ChipType < SIS_330) {\r\ndelay = 0x0c;\r\n} else {\r\ndelay = 0x0c;\r\n}\r\n} else if(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\ndelay = 0x00;\r\n}\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD|SetCRT2ToLCDA)) {\r\nbool gotitfrompci = false;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nif(SiS_Pr->PDC != -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0xf0,((SiS_Pr->PDC >> 1) & 0x0f));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x35,0x7f,((SiS_Pr->PDC & 0x01) << 7));\r\nreturn;\r\n}\r\n} else {\r\nif(SiS_Pr->PDCA != -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0x0f,((SiS_Pr->PDCA << 3) & 0xf0));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x20,0xbf,((SiS_Pr->PDCA & 0x01) << 6));\r\nreturn;\r\n}\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_Custom) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\ndelay = 0x00;\r\nif((SiS_Pr->PanelXRes <= 1280) && (SiS_Pr->PanelYRes <= 1024)) {\r\ndelay = 0x20;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0x0f,delay);\r\n} else {\r\ndelay = 0x0c;\r\nif(SiS_Pr->SiS_VBType & VB_SIS301C) {\r\ndelay = 0x03;\r\nif((SiS_Pr->PanelXRes > 1280) && (SiS_Pr->PanelYRes > 1024)) {\r\ndelay = 0x00;\r\n}\r\n} else if(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(IS_SIS740) delay = 0x01;\r\nelse delay = 0x03;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0xf0,delay);\r\n}\r\nreturn;\r\n}\r\nswitch(SiS_Pr->SiS_CustomT) {\r\ncase CUT_COMPAQ1280:\r\ncase CUT_COMPAQ12802:\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) {\r\ngotitfrompci = true;\r\ndochiptest = false;\r\ndelay = 0x03;\r\n}\r\nbreak;\r\ncase CUT_CLEVO1400:\r\ncase CUT_CLEVO14002:\r\ngotitfrompci = true;\r\ndochiptest = false;\r\ndelay = 0x02;\r\nbreak;\r\ncase CUT_CLEVO1024:\r\ncase CUT_CLEVO10242:\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\ngotitfrompci = true;\r\ndochiptest = false;\r\ndelay = 0x33;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2D,delay);\r\ndelay &= 0x0f;\r\n}\r\nbreak;\r\n}\r\nif(!gotitfrompci) {\r\nindex = GetLCDPtrIndexBIOS(SiS_Pr);\r\nmyindex = GetLCDPtrIndex(SiS_Pr);\r\nif(IS_SIS650 && (SiS_Pr->SiS_VBType & VB_SISLVDS)) {\r\nif(SiS_IsNotM650orLater(SiS_Pr)) {\r\nif((SiS_Pr->SiS_UseROM) && (!(SiS_Pr->SiS_ROMNew))) {\r\nromptr = SISGETROMW(0x122);\r\nif(!romptr) return;\r\ndelay = ROMAddr[(romptr + index)];\r\n} else {\r\ndelay = SiS310_LCDDelayCompensation_650301LV[myindex];\r\n}\r\n} else {\r\ndelay = SiS310_LCDDelayCompensation_651301LV[myindex];\r\nif(SiS_Pr->SiS_VBType & (VB_SIS302LV | VB_SIS302ELV))\r\ndelay = SiS310_LCDDelayCompensation_651302LV[myindex];\r\n}\r\n} else if(SiS_Pr->SiS_UseROM &&\r\n(!(SiS_Pr->SiS_ROMNew)) &&\r\n(SiS_Pr->SiS_LCDResInfo != Panel_1280x1024) &&\r\n(SiS_Pr->SiS_LCDResInfo != Panel_1280x768) &&\r\n(SiS_Pr->SiS_LCDResInfo != Panel_1280x960) &&\r\n(SiS_Pr->SiS_LCDResInfo != Panel_1600x1200) &&\r\n((romptr = GetLCDromptr(SiS_Pr)))) {\r\ndelay = ROMAddr[(romptr + index)];\r\n} else if(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nif(IS_SIS740) delay = 0x03;\r\nelse delay = 0x00;\r\n} else {\r\ndelay = SiS310_LCDDelayCompensation_301[myindex];\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(IS_SIS740) delay = 0x01;\r\nelse if(SiS_Pr->ChipType <= SIS_315PRO) delay = SiS310_LCDDelayCompensation_3xx301LV[myindex];\r\nelse delay = SiS310_LCDDelayCompensation_650301LV[myindex];\r\n} else if(SiS_Pr->SiS_VBType & VB_SIS301C) {\r\nif(IS_SIS740) delay = 0x01;\r\nelse delay = 0x03;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1600x1200) delay = 0x00;\r\n} else if(SiS_Pr->SiS_VBType & VB_SIS30xB) {\r\nif(IS_SIS740) delay = 0x01;\r\nelse delay = SiS310_LCDDelayCompensation_3xx301B[myindex];\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2D,0x0F,((delay << 4) & 0xf0));\r\ndochiptest = false;\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nindex = GetTVPtrIndex(SiS_Pr);\r\nif(IS_SIS650 && (SiS_Pr->SiS_VBType & VB_SISLVDS)) {\r\nif(SiS_IsNotM650orLater(SiS_Pr)) {\r\nif((SiS_Pr->SiS_UseROM) && (!(SiS_Pr->SiS_ROMNew))) {\r\nromptr = SISGETROMW(0x11a);\r\nif(!romptr) return;\r\ndelay = ROMAddr[romptr + index];\r\n} else {\r\ndelay = SiS310_TVDelayCompensation_301B[index];\r\n}\r\n} else {\r\nswitch(SiS_Pr->SiS_CustomT) {\r\ncase CUT_COMPAQ1280:\r\ncase CUT_COMPAQ12802:\r\ncase CUT_CLEVO1400:\r\ncase CUT_CLEVO14002:\r\ndelay = 0x02;\r\ndochiptest = false;\r\nbreak;\r\ncase CUT_CLEVO1024:\r\ncase CUT_CLEVO10242:\r\ndelay = 0x03;\r\ndochiptest = false;\r\nbreak;\r\ndefault:\r\ndelay = SiS310_TVDelayCompensation_651301LV[index];\r\nif(SiS_Pr->SiS_VBType & VB_SIS302LV) {\r\ndelay = SiS310_TVDelayCompensation_651302LV[index];\r\n}\r\n}\r\n}\r\n} else if((SiS_Pr->SiS_UseROM) && (!(SiS_Pr->SiS_ROMNew))) {\r\nromptr = GetTVromptr(SiS_Pr);\r\nif(!romptr) return;\r\ndelay = ROMAddr[romptr + index];\r\n} else if(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\ndelay = SiS310_TVDelayCompensation_LVDS[index];\r\n} else {\r\ndelay = SiS310_TVDelayCompensation_301[index];\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nif(IS_SIS740) {\r\ndelay = SiS310_TVDelayCompensation_740301B[index];\r\n} else {\r\ndelay = SiS310_TVDelayCompensation_301B[index];\r\nif(SiS_Pr->SiS_VBType & VB_SIS301C) delay = 0x02;\r\n}\r\n}\r\n}\r\nif(SiS_LCDAEnabled(SiS_Pr)) {\r\ndelay &= 0x0f;\r\ndochiptest = false;\r\n}\r\n} else return;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(IS_SIS650 && (SiS_Pr->SiS_VBType & VB_SISLVDS) && dochiptest) {\r\ntemp = (SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) & 0xf0) >> 4;\r\nif(temp == 8) {\r\ndelay &= 0x0f;\r\ndelay |= 0xb0;\r\n} else if(temp == 6) {\r\ndelay &= 0x0f;\r\ndelay |= 0xc0;\r\n} else if(temp > 7) {\r\ndelay = 0x35;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x2D,delay);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2D,0xF0,delay);\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2D,0xF0,delay);\r\n} else {\r\nif(IS_SIS650 && (SiS_Pr->SiS_IF_DEF_CH70xx != 0)) {\r\ndelay <<= 4;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2D,0x0F,delay);\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2D,0xF0,delay);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSetAntiFlicker(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,temp1,romptr=0;\r\nif(SiS_Pr->SiS_TVMode & (TVSetYPbPr750p|TVSetYPbPr525p)) return;\r\nif(ModeNo<=0x13)\r\nindex = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].VB_StTVFlickerIndex;\r\nelse\r\nindex = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].VB_ExtTVFlickerIndex;\r\ntemp = GetTVPtrIndex(SiS_Pr);\r\ntemp >>= 1;\r\ntemp1 = temp;\r\nif(SiS_Pr->SiS_UseROM && (!(SiS_Pr->SiS_ROMNew))) {\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\ntemp1 = GetOEMTVPtr661(SiS_Pr);\r\ntemp1 >>= 1;\r\nromptr = SISGETROMW(0x260);\r\nif(SiS_Pr->ChipType >= SIS_760) {\r\nromptr = SISGETROMW(0x360);\r\n}\r\n} else if(SiS_Pr->ChipType >= SIS_330) {\r\nromptr = SISGETROMW(0x192);\r\n} else {\r\nromptr = SISGETROMW(0x112);\r\n}\r\n}\r\nif(romptr) {\r\ntemp1 <<= 1;\r\ntemp = ROMAddr[romptr + temp1 + index];\r\n} else {\r\ntemp = SiS310_TVAntiFlick1[temp][index];\r\n}\r\ntemp <<= 4;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x0A,0x8f,temp);\r\n}\r\nstatic void\r\nSetEdgeEnhance(struct SiS_Private *SiS_Pr, unsigned short ModeNo,unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,temp1,romptr=0;\r\ntemp = temp1 = GetTVPtrIndex(SiS_Pr) >> 1;\r\nif(ModeNo <= 0x13)\r\nindex = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].VB_StTVEdgeIndex;\r\nelse\r\nindex = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].VB_ExtTVEdgeIndex;\r\nif(SiS_Pr->SiS_UseROM && (!(SiS_Pr->SiS_ROMNew))) {\r\nif(SiS_Pr->ChipType >= SIS_661) {\r\nromptr = SISGETROMW(0x26c);\r\nif(SiS_Pr->ChipType >= SIS_760) {\r\nromptr = SISGETROMW(0x36c);\r\n}\r\ntemp1 = GetOEMTVPtr661(SiS_Pr);\r\ntemp1 >>= 1;\r\n} else if(SiS_Pr->ChipType >= SIS_330) {\r\nromptr = SISGETROMW(0x1a4);\r\n} else {\r\nromptr = SISGETROMW(0x124);\r\n}\r\n}\r\nif(romptr) {\r\ntemp1 <<= 1;\r\ntemp = ROMAddr[romptr + temp1 + index];\r\n} else {\r\ntemp = SiS310_TVEdge1[temp][index];\r\n}\r\ntemp <<= 5;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x3A,0x1F,temp);\r\n}\r\nstatic void\r\nSetYFilter(struct SiS_Private *SiS_Pr, unsigned short ModeNo,unsigned short ModeIdIndex)\r\n{\r\nunsigned short index, temp, i, j;\r\nif(ModeNo <= 0x13) {\r\nindex = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].VB_StTVYFilterIndex;\r\n} else {\r\nindex = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].VB_ExtTVYFilterIndex;\r\n}\r\ntemp = GetTVPtrIndex(SiS_Pr) >> 1;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSCJ) temp = 1;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetPALM) temp = 3;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetPALN) temp = 4;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) temp = 1;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nfor(i=0x35, j=0; i<=0x38; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS310_TVYFilter2[temp][index][j]);\r\n}\r\nfor(i=0x48; i<=0x4A; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS310_TVYFilter2[temp][index][j]);\r\n}\r\n} else {\r\nfor(i=0x35, j=0; i<=0x38; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS310_TVYFilter1[temp][index][j]);\r\n}\r\n}\r\n}\r\nstatic void\r\nSetPhaseIncr(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,i,j,resinfo,romptr=0;\r\nunsigned int lindex;\r\nif(!(SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) return;\r\nif(SiS_Pr->SiS_TVMode & TVSetNTSCJ) return;\r\nif((SiS_Pr->ChipType >= SIS_661) || SiS_Pr->SiS_ROMNew) {\r\nlindex = GetOEMTVPtr661_2_OLD(SiS_Pr) & 0xffff;\r\nlindex <<= 2;\r\nfor(j=0, i=0x31; i<=0x34; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS_TVPhase[lindex + j]);\r\n}\r\nreturn;\r\n}\r\nif(SiS_Pr->SiS_TVMode & (TVSetPALM | TVSetPALN)) return;\r\nif(ModeNo<=0x13) {\r\nresinfo = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo;\r\n} else {\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\n}\r\ntemp = GetTVPtrIndex(SiS_Pr);\r\nif(SiS_Pr->SiS_UseROM) {\r\nromptr = SISGETROMW(0x116);\r\nif(SiS_Pr->ChipType >= SIS_330) {\r\nromptr = SISGETROMW(0x196);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nromptr = SISGETROMW(0x11c);\r\nif(SiS_Pr->ChipType >= SIS_330) {\r\nromptr = SISGETROMW(0x19c);\r\n}\r\nif((SiS_Pr->SiS_VBInfo & SetInSlaveMode) && (!(SiS_Pr->SiS_TVMode & TVSetTVSimuMode))) {\r\nromptr = SISGETROMW(0x116);\r\nif(SiS_Pr->ChipType >= SIS_330) {\r\nromptr = SISGETROMW(0x196);\r\n}\r\n}\r\n}\r\n}\r\nif(romptr) {\r\nromptr += (temp << 2);\r\nfor(j=0, i=0x31; i<=0x34; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,ROMAddr[romptr + j]);\r\n}\r\n} else {\r\nindex = temp % 2;\r\ntemp >>= 1;\r\nfor(j=0, i=0x31; i<=0x34; i++, j++) {\r\nif(!(SiS_Pr->SiS_VBType & VB_SIS30xBLV))\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS310_TVPhaseIncr1[temp][index][j]);\r\nelse if((!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) || (SiS_Pr->SiS_TVMode & TVSetTVSimuMode))\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS310_TVPhaseIncr2[temp][index][j]);\r\nelse\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS310_TVPhaseIncr1[temp][index][j]);\r\n}\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SIS30xBLV) && (!(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision))) {\r\nif((!(SiS_Pr->SiS_TVMode & (TVSetPAL | TVSetYPbPr525p | TVSetYPbPr750p))) && (ModeNo > 0x13)) {\r\nif((resinfo == SIS_RI_640x480) ||\r\n(resinfo == SIS_RI_800x600)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x31,0x21);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x32,0xf0);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x33,0xf5);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x34,0x7f);\r\n} else if(resinfo == SIS_RI_1024x768) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x31,0x1e);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x32,0x8b);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x33,0xfb);\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x34,0x7b);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSetDelayComp661(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short RTI)\r\n{\r\nunsigned short delay = 0, romptr = 0, index, lcdpdcindex;\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nif(!(SiS_Pr->SiS_VBInfo & (SetCRT2ToTV | SetCRT2ToLCD | SetCRT2ToLCDA | SetCRT2ToRAMDAC)))\r\nreturn;\r\nif(SiS_Pr->SiS_ROMNew) {\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToRAMDAC) ||\r\n((SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) &&\r\n(SiS_Pr->SiS_LCDInfo & LCDPass11))) {\r\nindex = 25;\r\nif(SiS_Pr->UseCustomMode) {\r\nindex = SiS_Pr->CSRClock;\r\n} else if(ModeNo > 0x13) {\r\nindex = SiS_GetVCLK2Ptr(SiS_Pr,ModeNo,ModeIdIndex,RTI);\r\nindex = SiS_Pr->SiS_VCLKData[index].CLOCK;\r\n}\r\nif(index < 25) index = 25;\r\nindex = ((index / 25) - 1) << 1;\r\nif((ROMAddr[0x5b] & 0x80) || (SiS_Pr->SiS_VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToLCD))) {\r\nindex++;\r\n}\r\nromptr = SISGETROMW(0x104);\r\ndelay = ROMAddr[romptr + index];\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToRAMDAC | SetCRT2ToLCD)) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0xf0,((delay >> 1) & 0x0f));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x35,0x7f,((delay & 0x01) << 7));\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0x0f,((delay << 3) & 0xf0));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x20,0xbf,((delay & 0x01) << 6));\r\n}\r\nreturn;\r\n}\r\n}\r\nif(SiS_Pr->UseCustomMode) delay = 0x04;\r\nelse if(ModeNo <= 0x13) delay = 0x04;\r\nelse delay = (SiS_Pr->SiS_RefIndex[RTI].Ext_PDC >> 4);\r\ndelay |= (delay << 8);\r\nif(SiS_Pr->ChipType >= XGI_20) {\r\ndelay = 0x0606;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\ndelay = 0x0404;\r\nif(SiS_Pr->SiS_XGIROM) {\r\nindex = GetTVPtrIndex(SiS_Pr);\r\nif((romptr = SISGETROMW(0x35e))) {\r\ndelay = (ROMAddr[romptr + index] & 0x0f) << 1;\r\ndelay |= (delay << 8);\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) {\r\nif(SiS_Pr->ChipType == XGI_40 && SiS_Pr->ChipRevision == 0x02) {\r\ndelay -= 0x0404;\r\n}\r\n}\r\n}\r\n} else if(SiS_Pr->ChipType >= SIS_340) {\r\ndelay = 0x0606;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\ndelay = 0x0404;\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nindex = GetOEMTVPtr661(SiS_Pr);\r\nif(SiS_Pr->SiS_ROMNew) {\r\nromptr = SISGETROMW(0x106);\r\nif(SiS_Pr->SiS_VBType & VB_UMC) romptr += 12;\r\ndelay = ROMAddr[romptr + index];\r\n} else {\r\ndelay = 0x04;\r\nif(index > 3) delay = 0;\r\n}\r\n} else if(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif( (SiS_Pr->SiS_LCDResInfo != Panel_Custom) &&\r\n((romptr = GetLCDStructPtr661_2(SiS_Pr))) ) {\r\nlcdpdcindex = (SiS_Pr->SiS_VBType & VB_UMC) ? 14 : 12;\r\ndelay = ROMAddr[romptr + lcdpdcindex + 1];\r\ndelay |= (ROMAddr[romptr + lcdpdcindex] << 8);\r\n} else {\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\nswitch(SiS_Pr->SiS_LCDResInfo) {\r\ncase Panel_1024x768: delay = 0x0008; break;\r\ncase Panel_1280x720: delay = 0x0004; break;\r\ncase Panel_1280x768:\r\ncase Panel_1280x768_2:delay = 0x0004; break;\r\ncase Panel_1280x800:\r\ncase Panel_1280x800_2:delay = 0x0004; break;\r\ncase Panel_1280x854: delay = 0x0004; break;\r\ncase Panel_1280x1024: delay = 0x1e04; break;\r\ncase Panel_1400x1050: delay = 0x0004; break;\r\ncase Panel_1600x1200: delay = 0x0400; break;\r\ncase Panel_1680x1050: delay = 0x0e04; break;\r\ndefault:\r\nif((SiS_Pr->PanelXRes <= 1024) && (SiS_Pr->PanelYRes <= 768)) {\r\ndelay = 0x0008;\r\n} else if((SiS_Pr->PanelXRes == 1280) && (SiS_Pr->PanelYRes == 1024)) {\r\ndelay = 0x1e04;\r\n} else if((SiS_Pr->PanelXRes <= 1400) && (SiS_Pr->PanelYRes <= 1050)) {\r\ndelay = 0x0004;\r\n} else if((SiS_Pr->PanelXRes <= 1600) && (SiS_Pr->PanelYRes <= 1200)) {\r\ndelay = 0x0400;\r\n} else\r\ndelay = 0x0e04;\r\nbreak;\r\n}\r\n}\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) && (SiS_Pr->PDC != -1)) {\r\ndelay = SiS_Pr->PDC & 0x1f;\r\n}\r\nif((SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) && (SiS_Pr->PDCA != -1)) {\r\ndelay = (SiS_Pr->PDCA & 0x1f) << 8;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\ndelay >>= 8;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0x0f,((delay << 3) & 0xf0));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x20,0xbf,((delay & 0x01) << 6));\r\n} else {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x2d,0xf0,((delay >> 1) & 0x0f));\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x35,0x7f,((delay & 0x01) << 7));\r\n}\r\n}\r\nstatic void\r\nSetCRT2SyncDither661(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short RTI)\r\n{\r\nunsigned short infoflag;\r\nunsigned char temp;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(ModeNo <= 0x13) {\r\ninfoflag = SiS_GetRegByte(SiS_Pr->SiS_P3ca+2);\r\n} else if(SiS_Pr->UseCustomMode) {\r\ninfoflag = SiS_Pr->CInfoFlag;\r\n} else {\r\ninfoflag = SiS_Pr->SiS_RefIndex[RTI].Ext_InfoFlag;\r\n}\r\nif(!(SiS_Pr->SiS_LCDInfo & LCDPass11)) {\r\ninfoflag = SiS_GetReg(SiS_Pr->SiS_P3d4,0x37);\r\n}\r\ninfoflag &= 0xc0;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\ntemp = (infoflag >> 6) | 0x0c;\r\nif(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit) {\r\ntemp ^= 0x04;\r\nif(SiS_Pr->SiS_ModeType >= Mode24Bpp) temp |= 0x10;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x1a,0xe0,temp);\r\n} else {\r\ntemp = 0x30;\r\nif(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit) temp = 0x20;\r\ntemp |= infoflag;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x19,0x0f,temp);\r\ntemp = 0;\r\nif(SiS_Pr->SiS_LCDInfo & LCDRGB18Bit) {\r\nif(SiS_Pr->SiS_ModeType >= Mode24Bpp) temp |= 0x80;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x1a,0x7f,temp);\r\n}\r\n}\r\n}\r\nstatic void\r\nSetPanelParms661(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short romptr, temp1, temp2;\r\nif(SiS_Pr->SiS_VBType & (VB_SISLVDS | VB_SIS30xC)) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x24,0x0f);\r\n}\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\nif(SiS_Pr->LVDSHL != -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x24,0xfc,SiS_Pr->LVDSHL);\r\n}\r\n}\r\nif(SiS_Pr->SiS_ROMNew) {\r\nif((romptr = GetLCDStructPtr661_2(SiS_Pr))) {\r\nif(SiS_Pr->SiS_VBType & VB_SISLVDS) {\r\ntemp1 = (ROMAddr[romptr] & 0x03) | 0x0c;\r\ntemp2 = 0xfc;\r\nif(SiS_Pr->LVDSHL != -1) {\r\ntemp1 &= 0xfc;\r\ntemp2 = 0xf3;\r\n}\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x24,temp2,temp1);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\ntemp1 = (ROMAddr[romptr + 1] & 0x80) >> 1;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x0d,0xbf,temp1);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_OEM310Setting(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex, unsigned short RRTI)\r\n{\r\nif((SiS_Pr->SiS_ROMNew) && (SiS_Pr->SiS_VBType & VB_SISLVDS)) {\r\nSetDelayComp661(SiS_Pr, ModeNo, ModeIdIndex, RRTI);\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nSetCRT2SyncDither661(SiS_Pr, ModeNo, RRTI);\r\nSetPanelParms661(SiS_Pr);\r\n}\r\n} else {\r\nSetDelayComp(SiS_Pr,ModeNo);\r\n}\r\nif((SiS_Pr->SiS_VBType & VB_SISVB) && (SiS_Pr->SiS_VBInfo & SetCRT2ToTV)) {\r\nSetAntiFlicker(SiS_Pr,ModeNo,ModeIdIndex);\r\nSetPhaseIncr(SiS_Pr,ModeNo,ModeIdIndex);\r\nSetYFilter(SiS_Pr,ModeNo,ModeIdIndex);\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nSetEdgeEnhance(SiS_Pr,ModeNo,ModeIdIndex);\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_OEM661Setting(struct SiS_Private *SiS_Pr, unsigned short ModeNo,\r\nunsigned short ModeIdIndex, unsigned short RRTI)\r\n{\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nSetDelayComp661(SiS_Pr, ModeNo, ModeIdIndex, RRTI);\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nSetCRT2SyncDither661(SiS_Pr, ModeNo, RRTI);\r\nSetPanelParms661(SiS_Pr);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSetPhaseIncr(SiS_Pr, ModeNo, ModeIdIndex);\r\nSetYFilter(SiS_Pr, ModeNo, ModeIdIndex);\r\nSetAntiFlicker(SiS_Pr, ModeNo, ModeIdIndex);\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) {\r\nSetEdgeEnhance(SiS_Pr, ModeNo, ModeIdIndex);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSiS_FinalizeLCD(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned short tempcl,tempch,tempbl,tempbh,tempbx,tempax,temp;\r\nunsigned short resinfo,modeflag;\r\nif(!(SiS_Pr->SiS_VBType & VB_SISLVDS)) return;\r\nif(SiS_Pr->SiS_ROMNew) return;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(SiS_Pr->LVDSHL != -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x24,0xfc,SiS_Pr->LVDSHL);\r\n}\r\n}\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_Custom) return;\r\nif(SiS_Pr->UseCustomMode) return;\r\nswitch(SiS_Pr->SiS_CustomT) {\r\ncase CUT_COMPAQ1280:\r\ncase CUT_COMPAQ12802:\r\ncase CUT_CLEVO1400:\r\ncase CUT_CLEVO14002:\r\nreturn;\r\n}\r\nif(ModeNo <= 0x13) {\r\nresinfo = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ResInfo;\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\n} else {\r\nresinfo = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_RESINFO;\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\n}\r\nif(IS_SIS650) {\r\nif(!(SiS_GetReg(SiS_Pr->SiS_P3d4, 0x5f) & 0xf0)) {\r\nif(SiS_Pr->SiS_CustomT == CUT_CLEVO1024) {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1e,0x02);\r\n} else {\r\nSiS_SetRegOR(SiS_Pr->SiS_Part1Port,0x1e,0x03);\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_CustomT == CUT_CLEVO1024) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->LVDSHL == -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x24,0xfc,0x01);\r\n}\r\nreturn;\r\n}\r\n}\r\nif(SiS_Pr->SiS_CustomT == CUT_CLEVO10242) {\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->LVDSHL == -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x24,0xfc,0x01);\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\ntempch = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) >> 4;\r\nif(tempch == 3) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x02);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,0x25);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1c,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1d,0x1b);\r\n}\r\n}\r\nreturn;\r\n}\r\n}\r\n}\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToLCD | SetCRT2ToLCDA)) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->SiS_VBType & VB_SISEMI) {\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x2a,0x00);\r\n#ifdef SET_EMI\r\nSiS_SetRegAND(SiS_Pr->SiS_Part4Port,0x30,0x0c);\r\n#endif\r\nSiS_SetReg(SiS_Pr->SiS_Part4Port,0x34,0x10);\r\n}\r\n} else if(SiS_Pr->SiS_LCDResInfo == Panel_1280x1024) {\r\nif(SiS_Pr->LVDSHL == -1) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part4Port,0x24,0xfc,0x01);\r\n}\r\n}\r\ntempch = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) >> 4;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCDA) {\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1400x1050) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1f,0x76);\r\n} else if(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(tempch == 0x03) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x02);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,0x25);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1c,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1d,0x1b);\r\n}\r\nif(SiS_Pr->Backup && (SiS_Pr->Backup_Mode == ModeNo)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x14,SiS_Pr->Backup_14);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x15,SiS_Pr->Backup_15);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x16,SiS_Pr->Backup_16);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x17,SiS_Pr->Backup_17);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,SiS_Pr->Backup_18);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x19,SiS_Pr->Backup_19);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1a,SiS_Pr->Backup_1a);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,SiS_Pr->Backup_1b);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1c,SiS_Pr->Backup_1c);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1d,SiS_Pr->Backup_1d);\r\n} else if(!(SiS_Pr->SiS_LCDInfo & DontExpandLCD)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x14,0x90);\r\nif(ModeNo <= 0x13) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x11);\r\nif((resinfo == 0) || (resinfo == 2)) return;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x18);\r\nif((resinfo == 1) || (resinfo == 3)) return;\r\n}\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x02);\r\nif((ModeNo > 0x13) && (resinfo == SIS_RI_1024x768)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x02);\r\n#if 0\r\ntempbx = 806;\r\ntempbx--;\r\ntemp = tempbx & 0xff;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,temp);\r\ntemp = (tempbx >> 8) & 0x03;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x1d,0xf8,temp);\r\n#endif\r\n}\r\n} else if(ModeNo <= 0x13) {\r\nif(ModeNo <= 1) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x70);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x19,0xff);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,0x48);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1d,0x12);\r\n}\r\nif(!(modeflag & HalfDCLK)) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x14,0x20);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x15,0x1a);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x16,0x28);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x17,0x00);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x4c);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x19,0xdc);\r\nif(ModeNo == 0x12) {\r\nswitch(tempch) {\r\ncase 0:\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x95);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x19,0xdc);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1a,0x10);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,0x95);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1c,0x48);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1d,0x12);\r\nbreak;\r\ncase 2:\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,0x95);\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,0x48);\r\nbreak;\r\ncase 3:\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x1b,0x95);\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\n}\r\n} else {\r\ntempcl = tempbh = SiS_GetReg(SiS_Pr->SiS_Part2Port,0x01);\r\ntempcl &= 0x0f;\r\ntempbh &= 0x70;\r\ntempbh >>= 4;\r\ntempbl = SiS_GetReg(SiS_Pr->SiS_Part2Port,0x04);\r\ntempbx = (tempbh << 8) | tempbl;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif((resinfo == SIS_RI_1024x768) || (!(SiS_Pr->SiS_LCDInfo & DontExpandLCD))) {\r\nif(SiS_Pr->SiS_SetFlag & LCDVESATiming) {\r\ntempbx = 770;\r\n} else {\r\nif(tempbx > 770) tempbx = 770;\r\nif(SiS_Pr->SiS_VGAVDE < 600) {\r\ntempax = 768 - SiS_Pr->SiS_VGAVDE;\r\ntempax >>= 4;\r\nif(SiS_Pr->SiS_VGAVDE <= 480) tempax >>= 4;\r\ntempbx -= tempax;\r\n}\r\n}\r\n} else return;\r\n}\r\ntemp = tempbx & 0xff;\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,0x04,temp);\r\ntemp = ((tempbx & 0xff00) >> 4) | tempcl;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x01,0x80,temp);\r\n}\r\n}\r\n}\r\nstatic void\r\nSetOEMLCDData2(struct SiS_Private *SiS_Pr, unsigned short ModeNo,unsigned short ModeIdIndex,\r\nunsigned short RefTabIndex)\r\n{\r\nunsigned short crt2crtc=0, modeflag, myindex=0;\r\nunsigned char temp;\r\nint i;\r\nif(ModeNo <= 0x13) {\r\nmodeflag = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_ModeFlag;\r\ncrt2crtc = SiS_Pr->SiS_SModeIDTable[ModeIdIndex].St_CRT2CRTC;\r\n} else {\r\nmodeflag = SiS_Pr->SiS_EModeIDTable[ModeIdIndex].Ext_ModeFlag;\r\ncrt2crtc = SiS_Pr->SiS_RefIndex[RefTabIndex].Ext_CRT2CRTC;\r\n}\r\ncrt2crtc &= 0x3f;\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1024) {\r\nSiS_SetRegAND(SiS_Pr->SiS_Part1Port,0x13,0xdf);\r\n}\r\nif(SiS_Pr->SiS_CustomT == CUT_BARCO1366) {\r\nif(modeflag & HalfDCLK) myindex = 1;\r\nif(SiS_Pr->SiS_SetFlag & LowModeTests) {\r\nfor(i=0; i<7; i++) {\r\nif(barco_p1[myindex][crt2crtc][i][0]) {\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,\r\nbarco_p1[myindex][crt2crtc][i][0],\r\nbarco_p1[myindex][crt2crtc][i][2],\r\nbarco_p1[myindex][crt2crtc][i][1]);\r\n}\r\n}\r\n}\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x00);\r\nif(temp & 0x80) {\r\ntemp = SiS_GetReg(SiS_Pr->SiS_Part1Port,0x18);\r\ntemp++;\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,0x18,temp);\r\n}\r\n}\r\n}\r\nstatic unsigned short\r\nGetOEMLCDPtr(struct SiS_Private *SiS_Pr, int Flag)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short tempbx=0,romptr=0;\r\nstatic const unsigned char customtable300[] = {\r\n0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,\r\n0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff\r\n};\r\nstatic const unsigned char customtable630[] = {\r\n0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff,\r\n0xff,0xff,0xff,0xff,0xff,0xff,0xff,0xff\r\n};\r\nif(SiS_Pr->ChipType == SIS_300) {\r\ntempbx = SiS_GetReg(SiS_Pr->SiS_P3d4,0x36) & 0x0f;\r\nif(SiS_Pr->SiS_VBType & VB_SIS301) tempbx &= 0x07;\r\ntempbx -= 2;\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) tempbx += 4;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_1024x768) {\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) tempbx += 3;\r\n}\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(ROMAddr[0x235] & 0x80) {\r\ntempbx = SiS_Pr->SiS_LCDTypeInfo;\r\nif(Flag) {\r\nromptr = SISGETROMW(0x255);\r\nif(romptr) tempbx = ROMAddr[romptr + SiS_Pr->SiS_LCDTypeInfo];\r\nelse tempbx = customtable300[SiS_Pr->SiS_LCDTypeInfo];\r\nif(tempbx == 0xFF) return 0xFFFF;\r\n}\r\ntempbx <<= 1;\r\nif(!(SiS_Pr->SiS_SetFlag & LCDVESATiming)) tempbx++;\r\n}\r\n}\r\n} else {\r\nif(Flag) {\r\nif(SiS_Pr->SiS_UseROM) {\r\nromptr = SISGETROMW(0x255);\r\nif(romptr) tempbx = ROMAddr[romptr + SiS_Pr->SiS_LCDTypeInfo];\r\nelse tempbx = 0xff;\r\n} else {\r\ntempbx = customtable630[SiS_Pr->SiS_LCDTypeInfo];\r\n}\r\nif(tempbx == 0xFF) return 0xFFFF;\r\ntempbx <<= 2;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) tempbx += 2;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) tempbx++;\r\nreturn tempbx;\r\n}\r\ntempbx = SiS_Pr->SiS_LCDTypeInfo << 2;\r\nif(SiS_Pr->SiS_VBInfo & SetInSlaveMode) tempbx += 2;\r\nif(SiS_Pr->SiS_LCDInfo & DontExpandLCD) tempbx++;\r\n}\r\nreturn tempbx;\r\n}\r\nstatic void\r\nSetOEMLCDDelay(struct SiS_Private *SiS_Pr, unsigned short ModeNo,unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,romptr=0;\r\nif(SiS_Pr->SiS_LCDResInfo == Panel_Custom) return;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(!(ROMAddr[0x237] & 0x01)) return;\r\nif(!(ROMAddr[0x237] & 0x02)) return;\r\nromptr = SISGETROMW(0x24b);\r\n}\r\nif(SiS_Pr->PDC != -1) return;\r\ntemp = GetOEMLCDPtr(SiS_Pr, 0);\r\nif(SiS_Pr->UseCustomMode)\r\nindex = 0;\r\nelse\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].VB_LCDDelayIndex;\r\nif(SiS_Pr->ChipType != SIS_300) {\r\nif(romptr) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += index;\r\ntemp = ROMAddr[romptr];\r\n} else {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntemp = SiS300_OEMLCDDelay2[temp][index];\r\n} else {\r\ntemp = SiS300_OEMLCDDelay3[temp][index];\r\n}\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_UseROM && (ROMAddr[0x235] & 0x80)) {\r\nif(romptr) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += index;\r\ntemp = ROMAddr[romptr];\r\n} else {\r\ntemp = SiS300_OEMLCDDelay5[temp][index];\r\n}\r\n} else {\r\nif(SiS_Pr->SiS_UseROM) {\r\nromptr = ROMAddr[0x249] | (ROMAddr[0x24a] << 8);\r\nif(romptr) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += index;\r\ntemp = ROMAddr[romptr];\r\n} else {\r\ntemp = SiS300_OEMLCDDelay4[temp][index];\r\n}\r\n} else {\r\ntemp = SiS300_OEMLCDDelay4[temp][index];\r\n}\r\n}\r\n}\r\ntemp &= 0x3c;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,~0x3C,temp);\r\n}\r\nstatic void\r\nSetOEMLCDData(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\n#if 0\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp;\r\nif((SiS_Pr->SiS_UseROM) {\r\nif(!(ROMAddr[0x237] & 0x01)) return;\r\nif(!(ROMAddr[0x237] & 0x04)) return;\r\n}\r\ntemp = GetOEMLCDPtr(SiS_Pr, 1);\r\nif(temp == 0xFFFF) return;\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex]._VB_LCDHIndex;\r\nfor(i=0x14, j=0; i<=0x17; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,i,SiS300_LCDHData[temp][index][j]);\r\n}\r\nSiS_SetRegANDOR(SiS_SiS_Part1Port,0x1a, 0xf8, (SiS300_LCDHData[temp][index][j] & 0x07));\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex]._VB_LCDVIndex;\r\nSiS_SetReg(SiS_SiS_Part1Port,0x18, SiS300_LCDVData[temp][index][0]);\r\nSiS_SetRegANDOR(SiS_SiS_Part1Port,0x19, 0xF0, SiS300_LCDVData[temp][index][1]);\r\nSiS_SetRegANDOR(SiS_SiS_Part1Port,0x1A, 0xC7, (SiS300_LCDVData[temp][index][2] & 0x38));\r\nfor(i=0x1b, j=3; i<=0x1d; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part1Port,i,SiS300_LCDVData[temp][index][j]);\r\n}\r\n#endif\r\n}\r\nstatic unsigned short\r\nGetOEMTVPtr(struct SiS_Private *SiS_Pr)\r\n{\r\nunsigned short index;\r\nindex = 0;\r\nif(!(SiS_Pr->SiS_VBInfo & SetInSlaveMode)) index += 4;\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToSCART) index += 2;\r\nelse if(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) index += 3;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetPAL) index += 1;\r\n} else {\r\nif(SiS_Pr->SiS_TVMode & TVSetCHOverScan) index += 2;\r\nif(SiS_Pr->SiS_TVMode & TVSetPAL) index += 1;\r\n}\r\nreturn index;\r\n}\r\nstatic void\r\nSetOEMTVDelay(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,romptr=0;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(!(ROMAddr[0x238] & 0x01)) return;\r\nif(!(ROMAddr[0x238] & 0x02)) return;\r\nromptr = SISGETROMW(0x241);\r\n}\r\ntemp = GetOEMTVPtr(SiS_Pr);\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].VB_TVDelayIndex;\r\nif(romptr) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += index;\r\ntemp = ROMAddr[romptr];\r\n} else {\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\ntemp = SiS300_OEMTVDelay301[temp][index];\r\n} else {\r\ntemp = SiS300_OEMTVDelayLVDS[temp][index];\r\n}\r\n}\r\ntemp &= 0x3c;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part1Port,0x13,~0x3C,temp);\r\n}\r\nstatic void\r\nSetOEMAntiFlicker(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,romptr=0;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(!(ROMAddr[0x238] & 0x01)) return;\r\nif(!(ROMAddr[0x238] & 0x04)) return;\r\nromptr = SISGETROMW(0x243);\r\n}\r\ntemp = GetOEMTVPtr(SiS_Pr);\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].VB_TVFlickerIndex;\r\nif(romptr) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += index;\r\ntemp = ROMAddr[romptr];\r\n} else {\r\ntemp = SiS300_OEMTVFlicker[temp][index];\r\n}\r\ntemp &= 0x70;\r\nSiS_SetRegANDOR(SiS_Pr->SiS_Part2Port,0x0A,0x8F,temp);\r\n}\r\nstatic void\r\nSetOEMPhaseIncr(struct SiS_Private *SiS_Pr, unsigned short ModeNo,unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,i,j,temp,romptr=0;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToHiVision) return;\r\nif(SiS_Pr->SiS_TVMode & (TVSetNTSC1024 | TVSetNTSCJ | TVSetPALM | TVSetPALN)) return;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(!(ROMAddr[0x238] & 0x01)) return;\r\nif(!(ROMAddr[0x238] & 0x08)) return;\r\nromptr = SISGETROMW(0x245);\r\n}\r\ntemp = GetOEMTVPtr(SiS_Pr);\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].VB_TVPhaseIndex;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nfor(i=0x31, j=0; i<=0x34; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS300_Phase2[temp][index][j]);\r\n}\r\n} else {\r\nif(romptr) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += (index * 4);\r\nfor(i=0x31, j=0; i<=0x34; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,ROMAddr[romptr + j]);\r\n}\r\n} else {\r\nfor(i=0x31, j=0; i<=0x34; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS300_Phase1[temp][index][j]);\r\n}\r\n}\r\n}\r\n}\r\nstatic void\r\nSetOEMYFilter(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex)\r\n{\r\nunsigned char *ROMAddr = SiS_Pr->VirtualRomBase;\r\nunsigned short index,temp,i,j,romptr=0;\r\nif(SiS_Pr->SiS_VBInfo & (SetCRT2ToSCART | SetCRT2ToHiVision | SetCRT2ToYPbPr525750)) return;\r\nif(SiS_Pr->SiS_UseROM) {\r\nif(!(ROMAddr[0x238] & 0x01)) return;\r\nif(!(ROMAddr[0x238] & 0x10)) return;\r\nromptr = SISGETROMW(0x247);\r\n}\r\ntemp = GetOEMTVPtr(SiS_Pr);\r\nif(SiS_Pr->SiS_TVMode & TVSetPALM) temp = 8;\r\nelse if(SiS_Pr->SiS_TVMode & TVSetPALN) temp = 9;\r\nindex = SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].VB_TVYFilterIndex;\r\nif(SiS_Pr->SiS_VBType & VB_SIS30xBLV) {\r\nfor(i=0x35, j=0; i<=0x38; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS300_Filter2[temp][index][j]);\r\n}\r\nfor(i=0x48; i<=0x4A; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS300_Filter2[temp][index][j]);\r\n}\r\n} else {\r\nif((romptr) && (!(SiS_Pr->SiS_TVMode & (TVSetPALM|TVSetPALN)))) {\r\nromptr += (temp * 2);\r\nromptr = SISGETROMW(romptr);\r\nromptr += (index * 4);\r\nfor(i=0x35, j=0; i<=0x38; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,ROMAddr[romptr + j]);\r\n}\r\n} else {\r\nfor(i=0x35, j=0; i<=0x38; i++, j++) {\r\nSiS_SetReg(SiS_Pr->SiS_Part2Port,i,SiS300_Filter1[temp][index][j]);\r\n}\r\n}\r\n}\r\n}\r\nstatic unsigned short\r\nSiS_SearchVBModeID(struct SiS_Private *SiS_Pr, unsigned short *ModeNo)\r\n{\r\nunsigned short ModeIdIndex;\r\nunsigned char VGAINFO = SiS_Pr->SiS_VGAINFO;\r\nif(*ModeNo <= 5) *ModeNo |= 1;\r\nfor(ModeIdIndex=0; ; ModeIdIndex++) {\r\nif(SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].ModeID == *ModeNo) break;\r\nif(SiS_Pr->SiS_VBModeIDTable[ModeIdIndex].ModeID == 0xFF) return 0;\r\n}\r\nif(*ModeNo != 0x07) {\r\nif(*ModeNo > 0x03) return ModeIdIndex;\r\nif(VGAINFO & 0x80) return ModeIdIndex;\r\nModeIdIndex++;\r\n}\r\nif(VGAINFO & 0x10) ModeIdIndex++;\r\nreturn ModeIdIndex;\r\n}\r\nstatic void\r\nSiS_OEM300Setting(struct SiS_Private *SiS_Pr, unsigned short ModeNo, unsigned short ModeIdIndex,\r\nunsigned short RefTableIndex)\r\n{\r\nunsigned short OEMModeIdIndex = 0;\r\nif(!SiS_Pr->UseCustomMode) {\r\nOEMModeIdIndex = SiS_SearchVBModeID(SiS_Pr,&ModeNo);\r\nif(!(OEMModeIdIndex)) return;\r\n}\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToLCD) {\r\nSetOEMLCDDelay(SiS_Pr, ModeNo, OEMModeIdIndex);\r\nif(SiS_Pr->SiS_IF_DEF_LVDS == 1) {\r\nSetOEMLCDData(SiS_Pr, ModeNo, OEMModeIdIndex);\r\n}\r\n}\r\nif(SiS_Pr->UseCustomMode) return;\r\nif(SiS_Pr->SiS_VBInfo & SetCRT2ToTV) {\r\nSetOEMTVDelay(SiS_Pr, ModeNo,OEMModeIdIndex);\r\nif(SiS_Pr->SiS_VBType & VB_SISVB) {\r\nSetOEMAntiFlicker(SiS_Pr, ModeNo, OEMModeIdIndex);\r\nSetOEMPhaseIncr(SiS_Pr, ModeNo, OEMModeIdIndex);\r\nSetOEMYFilter(SiS_Pr, ModeNo, OEMModeIdIndex);\r\n}\r\n}\r\n}

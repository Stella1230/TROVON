static int ab5500_registers_print(struct seq_file *s, void *p)\r\n{\r\nstruct ab5500 *ab = s->private;\r\nunsigned int i;\r\nu8 bank = (u8)ab->debug_bank;\r\nseq_printf(s, "ab5500 register values:\n");\r\nfor (bank = 0; bank < AB5500_NUM_BANKS; bank++) {\r\nseq_printf(s, " bank %u, %s (0x%x):\n", bank,\r\nbankinfo[bank].name,\r\nbankinfo[bank].slave_addr);\r\nfor (i = 0; i < ab5500_reg_ranges[bank].nranges; i++) {\r\nu8 reg;\r\nint err;\r\nfor (reg = ab5500_reg_ranges[bank].range[i].first;\r\nreg <= ab5500_reg_ranges[bank].range[i].last;\r\nreg++) {\r\nu8 value;\r\nerr = ab5500_get_register_interruptible_raw(ab,\r\nbank, reg,\r\n&value);\r\nif (err < 0) {\r\ndev_err(ab->dev, "get_reg failed %d"\r\n"bank 0x%x reg 0x%x\n",\r\nerr, bank, reg);\r\nreturn err;\r\n}\r\nerr = seq_printf(s, "[%d/0x%02X]: 0x%02X\n",\r\nbank, reg, value);\r\nif (err < 0) {\r\ndev_err(ab->dev,\r\n"seq_printf overflow\n");\r\nreturn 0;\r\n}\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ab5500_registers_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab5500_registers_print, inode->i_private);\r\n}\r\nstatic int ab5500_bank_print(struct seq_file *s, void *p)\r\n{\r\nstruct ab5500 *ab = s->private;\r\nseq_printf(s, "%d\n", ab->debug_bank);\r\nreturn 0;\r\n}\r\nstatic int ab5500_bank_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab5500_bank_print, inode->i_private);\r\n}\r\nstatic ssize_t ab5500_bank_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ab5500 *ab = ((struct seq_file *)(file->private_data))->private;\r\nchar buf[32];\r\nint buf_size;\r\nunsigned long user_bank;\r\nint err;\r\nbuf_size = min(count, (sizeof(buf) - 1));\r\nif (copy_from_user(buf, user_buf, buf_size))\r\nreturn -EFAULT;\r\nbuf[buf_size] = 0;\r\nerr = strict_strtoul(buf, 0, &user_bank);\r\nif (err)\r\nreturn -EINVAL;\r\nif (user_bank >= AB5500_NUM_BANKS) {\r\ndev_err(ab->dev,\r\n"debugfs error input > number of banks\n");\r\nreturn -EINVAL;\r\n}\r\nab->debug_bank = user_bank;\r\nreturn buf_size;\r\n}\r\nstatic int ab5500_address_print(struct seq_file *s, void *p)\r\n{\r\nstruct ab5500 *ab = s->private;\r\nseq_printf(s, "0x%02X\n", ab->debug_address);\r\nreturn 0;\r\n}\r\nstatic int ab5500_address_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab5500_address_print, inode->i_private);\r\n}\r\nstatic ssize_t ab5500_address_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ab5500 *ab = ((struct seq_file *)(file->private_data))->private;\r\nchar buf[32];\r\nint buf_size;\r\nunsigned long user_address;\r\nint err;\r\nbuf_size = min(count, (sizeof(buf) - 1));\r\nif (copy_from_user(buf, user_buf, buf_size))\r\nreturn -EFAULT;\r\nbuf[buf_size] = 0;\r\nerr = strict_strtoul(buf, 0, &user_address);\r\nif (err)\r\nreturn -EINVAL;\r\nif (user_address > 0xff) {\r\ndev_err(ab->dev,\r\n"debugfs error input > 0xff\n");\r\nreturn -EINVAL;\r\n}\r\nab->debug_address = user_address;\r\nreturn buf_size;\r\n}\r\nstatic int ab5500_val_print(struct seq_file *s, void *p)\r\n{\r\nstruct ab5500 *ab = s->private;\r\nint err;\r\nu8 regvalue;\r\nerr = ab5500_get_register_interruptible_raw(ab, (u8)ab->debug_bank,\r\n(u8)ab->debug_address, &regvalue);\r\nif (err) {\r\ndev_err(ab->dev, "get_reg failed %d, bank 0x%x"\r\n", reg 0x%x\n", err, ab->debug_bank,\r\nab->debug_address);\r\nreturn -EINVAL;\r\n}\r\nseq_printf(s, "0x%02X\n", regvalue);\r\nreturn 0;\r\n}\r\nstatic int ab5500_val_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, ab5500_val_print, inode->i_private);\r\n}\r\nstatic ssize_t ab5500_val_write(struct file *file,\r\nconst char __user *user_buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct ab5500 *ab = ((struct seq_file *)(file->private_data))->private;\r\nchar buf[32];\r\nint buf_size;\r\nunsigned long user_val;\r\nint err;\r\nu8 regvalue;\r\nbuf_size = min(count, (sizeof(buf)-1));\r\nif (copy_from_user(buf, user_buf, buf_size))\r\nreturn -EFAULT;\r\nbuf[buf_size] = 0;\r\nerr = strict_strtoul(buf, 0, &user_val);\r\nif (err)\r\nreturn -EINVAL;\r\nif (user_val > 0xff) {\r\ndev_err(ab->dev,\r\n"debugfs error input > 0xff\n");\r\nreturn -EINVAL;\r\n}\r\nerr = ab5500_mask_and_set_register_interruptible_raw(\r\nab, (u8)ab->debug_bank,\r\n(u8)ab->debug_address, 0xFF, (u8)user_val);\r\nif (err)\r\nreturn -EINVAL;\r\nab5500_get_register_interruptible_raw(ab, (u8)ab->debug_bank,\r\n(u8)ab->debug_address, &regvalue);\r\nif (err)\r\nreturn -EINVAL;\r\nreturn buf_size;\r\n}\r\nvoid __init ab5500_setup_debugfs(struct ab5500 *ab)\r\n{\r\nab->debug_bank = AB5500_BANK_VIT_IO_I2C_CLK_TST_OTP;\r\nab->debug_address = AB5500_CHIP_ID;\r\nab5500_dir = debugfs_create_dir("ab5500", NULL);\r\nif (!ab5500_dir)\r\ngoto exit_no_debugfs;\r\nab5500_reg_file = debugfs_create_file("all-bank-registers",\r\nS_IRUGO, ab5500_dir, ab, &ab5500_registers_fops);\r\nif (!ab5500_reg_file)\r\ngoto exit_destroy_dir;\r\nab5500_bank_file = debugfs_create_file("register-bank",\r\n(S_IRUGO | S_IWUGO), ab5500_dir, ab, &ab5500_bank_fops);\r\nif (!ab5500_bank_file)\r\ngoto exit_destroy_reg;\r\nab5500_address_file = debugfs_create_file("register-address",\r\n(S_IRUGO | S_IWUGO), ab5500_dir, ab, &ab5500_address_fops);\r\nif (!ab5500_address_file)\r\ngoto exit_destroy_bank;\r\nab5500_val_file = debugfs_create_file("register-value",\r\n(S_IRUGO | S_IWUGO), ab5500_dir, ab, &ab5500_val_fops);\r\nif (!ab5500_val_file)\r\ngoto exit_destroy_address;\r\nreturn;\r\nexit_destroy_address:\r\ndebugfs_remove(ab5500_address_file);\r\nexit_destroy_bank:\r\ndebugfs_remove(ab5500_bank_file);\r\nexit_destroy_reg:\r\ndebugfs_remove(ab5500_reg_file);\r\nexit_destroy_dir:\r\ndebugfs_remove(ab5500_dir);\r\nexit_no_debugfs:\r\ndev_err(ab->dev, "failed to create debugfs entries.\n");\r\nreturn;\r\n}\r\nvoid __exit ab5500_remove_debugfs(void)\r\n{\r\ndebugfs_remove(ab5500_val_file);\r\ndebugfs_remove(ab5500_address_file);\r\ndebugfs_remove(ab5500_bank_file);\r\ndebugfs_remove(ab5500_reg_file);\r\ndebugfs_remove(ab5500_dir);\r\n}

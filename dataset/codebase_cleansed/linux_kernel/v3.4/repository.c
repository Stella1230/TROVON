static void _dump_field(const char *hdr, u64 n, const char *func, int line)\r\n{\r\n#if defined(DEBUG)\r\nchar s[16];\r\nconst char *const in = (const char *)&n;\r\nunsigned int i;\r\nfor (i = 0; i < 8; i++)\r\ns[i] = (in[i] <= 126 && in[i] >= 32) ? in[i] : '.';\r\ns[i] = 0;\r\npr_devel("%s:%d: %s%016llx : %s\n", func, line, hdr, n, s);\r\n#endif\r\n}\r\nstatic void _dump_node_name(unsigned int lpar_id, u64 n1, u64 n2, u64 n3,\r\nu64 n4, const char *func, int line)\r\n{\r\npr_devel("%s:%d: lpar: %u\n", func, line, lpar_id);\r\n_dump_field("n1: ", n1, func, line);\r\n_dump_field("n2: ", n2, func, line);\r\n_dump_field("n3: ", n3, func, line);\r\n_dump_field("n4: ", n4, func, line);\r\n}\r\nstatic void _dump_node(unsigned int lpar_id, u64 n1, u64 n2, u64 n3, u64 n4,\r\nu64 v1, u64 v2, const char *func, int line)\r\n{\r\npr_devel("%s:%d: lpar: %u\n", func, line, lpar_id);\r\n_dump_field("n1: ", n1, func, line);\r\n_dump_field("n2: ", n2, func, line);\r\n_dump_field("n3: ", n3, func, line);\r\n_dump_field("n4: ", n4, func, line);\r\npr_devel("%s:%d: v1: %016llx\n", func, line, v1);\r\npr_devel("%s:%d: v2: %016llx\n", func, line, v2);\r\n}\r\nstatic u64 make_first_field(const char *text, u64 index)\r\n{\r\nu64 n;\r\nstrncpy((char *)&n, text, 8);\r\nreturn PS3_VENDOR_ID_NONE + (n >> 32) + index;\r\n}\r\nstatic u64 make_field(const char *text, u64 index)\r\n{\r\nu64 n;\r\nstrncpy((char *)&n, text, 8);\r\nreturn n + index;\r\n}\r\nstatic int read_node(unsigned int lpar_id, u64 n1, u64 n2, u64 n3, u64 n4,\r\nu64 *_v1, u64 *_v2)\r\n{\r\nint result;\r\nu64 v1;\r\nu64 v2;\r\nif (lpar_id == PS3_LPAR_ID_CURRENT) {\r\nu64 id;\r\nlv1_get_logical_partition_id(&id);\r\nlpar_id = id;\r\n}\r\nresult = lv1_read_repository_node(lpar_id, n1, n2, n3, n4, &v1,\r\n&v2);\r\nif (result) {\r\npr_warn("%s:%d: lv1_read_repository_node failed: %s\n",\r\n__func__, __LINE__, ps3_result(result));\r\ndump_node_name(lpar_id, n1, n2, n3, n4);\r\nreturn -ENOENT;\r\n}\r\ndump_node(lpar_id, n1, n2, n3, n4, v1, v2);\r\nif (_v1)\r\n*_v1 = v1;\r\nif (_v2)\r\n*_v2 = v2;\r\nif (v1 && !_v1)\r\npr_devel("%s:%d: warning: discarding non-zero v1: %016llx\n",\r\n__func__, __LINE__, v1);\r\nif (v2 && !_v2)\r\npr_devel("%s:%d: warning: discarding non-zero v2: %016llx\n",\r\n__func__, __LINE__, v2);\r\nreturn 0;\r\n}\r\nint ps3_repository_read_bus_str(unsigned int bus_index, const char *bus_str,\r\nu64 *value)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field(bus_str, 0),\r\n0, 0,\r\nvalue, NULL);\r\n}\r\nint ps3_repository_read_bus_id(unsigned int bus_index, u64 *bus_id)\r\n{\r\nint result;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("id", 0),\r\n0, 0,\r\nbus_id, NULL);\r\nreturn result;\r\n}\r\nint ps3_repository_read_bus_type(unsigned int bus_index,\r\nenum ps3_bus_type *bus_type)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("type", 0),\r\n0, 0,\r\n&v1, NULL);\r\n*bus_type = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_bus_num_dev(unsigned int bus_index,\r\nunsigned int *num_dev)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("num_dev", 0),\r\n0, 0,\r\n&v1, NULL);\r\n*num_dev = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_dev_str(unsigned int bus_index,\r\nunsigned int dev_index, const char *dev_str, u64 *value)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field(dev_str, 0),\r\n0,\r\nvalue, NULL);\r\n}\r\nint ps3_repository_read_dev_id(unsigned int bus_index, unsigned int dev_index,\r\nu64 *dev_id)\r\n{\r\nint result;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("id", 0),\r\n0,\r\ndev_id, NULL);\r\nreturn result;\r\n}\r\nint ps3_repository_read_dev_type(unsigned int bus_index,\r\nunsigned int dev_index, enum ps3_dev_type *dev_type)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("type", 0),\r\n0,\r\n&v1, NULL);\r\n*dev_type = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_dev_intr(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int intr_index,\r\nenum ps3_interrupt_type *intr_type, unsigned int *interrupt_id)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nu64 v2 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("intr", intr_index),\r\n0,\r\n&v1, &v2);\r\n*intr_type = v1;\r\n*interrupt_id = v2;\r\nreturn result;\r\n}\r\nint ps3_repository_read_dev_reg_type(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int reg_index,\r\nenum ps3_reg_type *reg_type)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("reg", reg_index),\r\nmake_field("type", 0),\r\n&v1, NULL);\r\n*reg_type = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_dev_reg_addr(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int reg_index, u64 *bus_addr, u64 *len)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("reg", reg_index),\r\nmake_field("data", 0),\r\nbus_addr, len);\r\n}\r\nint ps3_repository_read_dev_reg(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int reg_index,\r\nenum ps3_reg_type *reg_type, u64 *bus_addr, u64 *len)\r\n{\r\nint result = ps3_repository_read_dev_reg_type(bus_index, dev_index,\r\nreg_index, reg_type);\r\nreturn result ? result\r\n: ps3_repository_read_dev_reg_addr(bus_index, dev_index,\r\nreg_index, bus_addr, len);\r\n}\r\nint ps3_repository_find_device(struct ps3_repository_device *repo)\r\n{\r\nint result;\r\nstruct ps3_repository_device tmp = *repo;\r\nunsigned int num_dev;\r\nBUG_ON(repo->bus_index > 10);\r\nBUG_ON(repo->dev_index > 10);\r\nresult = ps3_repository_read_bus_num_dev(tmp.bus_index, &num_dev);\r\nif (result) {\r\npr_devel("%s:%d read_bus_num_dev failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\npr_devel("%s:%d: bus_type %u, bus_index %u, bus_id %llu, num_dev %u\n",\r\n__func__, __LINE__, tmp.bus_type, tmp.bus_index, tmp.bus_id,\r\nnum_dev);\r\nif (tmp.dev_index >= num_dev) {\r\npr_devel("%s:%d: no device found\n", __func__, __LINE__);\r\nreturn -ENODEV;\r\n}\r\nresult = ps3_repository_read_dev_type(tmp.bus_index, tmp.dev_index,\r\n&tmp.dev_type);\r\nif (result) {\r\npr_devel("%s:%d read_dev_type failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nresult = ps3_repository_read_dev_id(tmp.bus_index, tmp.dev_index,\r\n&tmp.dev_id);\r\nif (result) {\r\npr_devel("%s:%d ps3_repository_read_dev_id failed\n", __func__,\r\n__LINE__);\r\nreturn result;\r\n}\r\npr_devel("%s:%d: found: dev_type %u, dev_index %u, dev_id %llu\n",\r\n__func__, __LINE__, tmp.dev_type, tmp.dev_index, tmp.dev_id);\r\n*repo = tmp;\r\nreturn 0;\r\n}\r\nint ps3_repository_find_device_by_id(struct ps3_repository_device *repo,\r\nu64 bus_id, u64 dev_id)\r\n{\r\nint result = -ENODEV;\r\nstruct ps3_repository_device tmp;\r\nunsigned int num_dev;\r\npr_devel(" -> %s:%u: find device by id %llu:%llu\n", __func__, __LINE__,\r\nbus_id, dev_id);\r\nfor (tmp.bus_index = 0; tmp.bus_index < 10; tmp.bus_index++) {\r\nresult = ps3_repository_read_bus_id(tmp.bus_index,\r\n&tmp.bus_id);\r\nif (result) {\r\npr_devel("%s:%u read_bus_id(%u) failed\n", __func__,\r\n__LINE__, tmp.bus_index);\r\nreturn result;\r\n}\r\nif (tmp.bus_id == bus_id)\r\ngoto found_bus;\r\npr_devel("%s:%u: skip, bus_id %llu\n", __func__, __LINE__,\r\ntmp.bus_id);\r\n}\r\npr_devel(" <- %s:%u: bus not found\n", __func__, __LINE__);\r\nreturn result;\r\nfound_bus:\r\nresult = ps3_repository_read_bus_type(tmp.bus_index, &tmp.bus_type);\r\nif (result) {\r\npr_devel("%s:%u read_bus_type(%u) failed\n", __func__,\r\n__LINE__, tmp.bus_index);\r\nreturn result;\r\n}\r\nresult = ps3_repository_read_bus_num_dev(tmp.bus_index, &num_dev);\r\nif (result) {\r\npr_devel("%s:%u read_bus_num_dev failed\n", __func__,\r\n__LINE__);\r\nreturn result;\r\n}\r\nfor (tmp.dev_index = 0; tmp.dev_index < num_dev; tmp.dev_index++) {\r\nresult = ps3_repository_read_dev_id(tmp.bus_index,\r\ntmp.dev_index,\r\n&tmp.dev_id);\r\nif (result) {\r\npr_devel("%s:%u read_dev_id(%u:%u) failed\n", __func__,\r\n__LINE__, tmp.bus_index, tmp.dev_index);\r\nreturn result;\r\n}\r\nif (tmp.dev_id == dev_id)\r\ngoto found_dev;\r\npr_devel("%s:%u: skip, dev_id %llu\n", __func__, __LINE__,\r\ntmp.dev_id);\r\n}\r\npr_devel(" <- %s:%u: dev not found\n", __func__, __LINE__);\r\nreturn result;\r\nfound_dev:\r\nresult = ps3_repository_read_dev_type(tmp.bus_index, tmp.dev_index,\r\n&tmp.dev_type);\r\nif (result) {\r\npr_devel("%s:%u read_dev_type failed\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\npr_devel(" <- %s:%u: found: type (%u:%u) index (%u:%u) id (%llu:%llu)\n",\r\n__func__, __LINE__, tmp.bus_type, tmp.dev_type, tmp.bus_index,\r\ntmp.dev_index, tmp.bus_id, tmp.dev_id);\r\n*repo = tmp;\r\nreturn 0;\r\n}\r\nint __devinit ps3_repository_find_devices(enum ps3_bus_type bus_type,\r\nint (*callback)(const struct ps3_repository_device *repo))\r\n{\r\nint result = 0;\r\nstruct ps3_repository_device repo;\r\npr_devel(" -> %s:%d: find bus_type %u\n", __func__, __LINE__, bus_type);\r\nrepo.bus_type = bus_type;\r\nresult = ps3_repository_find_bus(repo.bus_type, 0, &repo.bus_index);\r\nif (result) {\r\npr_devel(" <- %s:%u: bus not found\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nresult = ps3_repository_read_bus_id(repo.bus_index, &repo.bus_id);\r\nif (result) {\r\npr_devel("%s:%d read_bus_id(%u) failed\n", __func__, __LINE__,\r\nrepo.bus_index);\r\nreturn result;\r\n}\r\nfor (repo.dev_index = 0; ; repo.dev_index++) {\r\nresult = ps3_repository_find_device(&repo);\r\nif (result == -ENODEV) {\r\nresult = 0;\r\nbreak;\r\n} else if (result)\r\nbreak;\r\nresult = callback(&repo);\r\nif (result) {\r\npr_devel("%s:%d: abort at callback\n", __func__,\r\n__LINE__);\r\nbreak;\r\n}\r\n}\r\npr_devel(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nint ps3_repository_find_bus(enum ps3_bus_type bus_type, unsigned int from,\r\nunsigned int *bus_index)\r\n{\r\nunsigned int i;\r\nenum ps3_bus_type type;\r\nint error;\r\nfor (i = from; i < 10; i++) {\r\nerror = ps3_repository_read_bus_type(i, &type);\r\nif (error) {\r\npr_devel("%s:%d read_bus_type failed\n",\r\n__func__, __LINE__);\r\n*bus_index = UINT_MAX;\r\nreturn error;\r\n}\r\nif (type == bus_type) {\r\n*bus_index = i;\r\nreturn 0;\r\n}\r\n}\r\n*bus_index = UINT_MAX;\r\nreturn -ENODEV;\r\n}\r\nint ps3_repository_find_interrupt(const struct ps3_repository_device *repo,\r\nenum ps3_interrupt_type intr_type, unsigned int *interrupt_id)\r\n{\r\nint result = 0;\r\nunsigned int res_index;\r\npr_devel("%s:%d: find intr_type %u\n", __func__, __LINE__, intr_type);\r\n*interrupt_id = UINT_MAX;\r\nfor (res_index = 0; res_index < 10; res_index++) {\r\nenum ps3_interrupt_type t;\r\nunsigned int id;\r\nresult = ps3_repository_read_dev_intr(repo->bus_index,\r\nrepo->dev_index, res_index, &t, &id);\r\nif (result) {\r\npr_devel("%s:%d read_dev_intr failed\n",\r\n__func__, __LINE__);\r\nreturn result;\r\n}\r\nif (t == intr_type) {\r\n*interrupt_id = id;\r\nbreak;\r\n}\r\n}\r\nif (res_index == 10)\r\nreturn -ENODEV;\r\npr_devel("%s:%d: found intr_type %u at res_index %u\n",\r\n__func__, __LINE__, intr_type, res_index);\r\nreturn result;\r\n}\r\nint ps3_repository_find_reg(const struct ps3_repository_device *repo,\r\nenum ps3_reg_type reg_type, u64 *bus_addr, u64 *len)\r\n{\r\nint result = 0;\r\nunsigned int res_index;\r\npr_devel("%s:%d: find reg_type %u\n", __func__, __LINE__, reg_type);\r\n*bus_addr = *len = 0;\r\nfor (res_index = 0; res_index < 10; res_index++) {\r\nenum ps3_reg_type t;\r\nu64 a;\r\nu64 l;\r\nresult = ps3_repository_read_dev_reg(repo->bus_index,\r\nrepo->dev_index, res_index, &t, &a, &l);\r\nif (result) {\r\npr_devel("%s:%d read_dev_reg failed\n",\r\n__func__, __LINE__);\r\nreturn result;\r\n}\r\nif (t == reg_type) {\r\n*bus_addr = a;\r\n*len = l;\r\nbreak;\r\n}\r\n}\r\nif (res_index == 10)\r\nreturn -ENODEV;\r\npr_devel("%s:%d: found reg_type %u at res_index %u\n",\r\n__func__, __LINE__, reg_type, res_index);\r\nreturn result;\r\n}\r\nint ps3_repository_read_stor_dev_port(unsigned int bus_index,\r\nunsigned int dev_index, u64 *port)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("port", 0),\r\n0, port, NULL);\r\n}\r\nint ps3_repository_read_stor_dev_blk_size(unsigned int bus_index,\r\nunsigned int dev_index, u64 *blk_size)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("blk_size", 0),\r\n0, blk_size, NULL);\r\n}\r\nint ps3_repository_read_stor_dev_num_blocks(unsigned int bus_index,\r\nunsigned int dev_index, u64 *num_blocks)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("n_blocks", 0),\r\n0, num_blocks, NULL);\r\n}\r\nint ps3_repository_read_stor_dev_num_regions(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int *num_regions)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("n_regs", 0),\r\n0, &v1, NULL);\r\n*num_regions = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_stor_dev_region_id(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int region_index,\r\nunsigned int *region_id)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("region", region_index),\r\nmake_field("id", 0),\r\n&v1, NULL);\r\n*region_id = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_stor_dev_region_size(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int region_index, u64 *region_size)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("region", region_index),\r\nmake_field("size", 0),\r\nregion_size, NULL);\r\n}\r\nint ps3_repository_read_stor_dev_region_start(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int region_index, u64 *region_start)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("bus", bus_index),\r\nmake_field("dev", dev_index),\r\nmake_field("region", region_index),\r\nmake_field("start", 0),\r\nregion_start, NULL);\r\n}\r\nint ps3_repository_read_stor_dev_info(unsigned int bus_index,\r\nunsigned int dev_index, u64 *port, u64 *blk_size,\r\nu64 *num_blocks, unsigned int *num_regions)\r\n{\r\nint result;\r\nresult = ps3_repository_read_stor_dev_port(bus_index, dev_index, port);\r\nif (result)\r\nreturn result;\r\nresult = ps3_repository_read_stor_dev_blk_size(bus_index, dev_index,\r\nblk_size);\r\nif (result)\r\nreturn result;\r\nresult = ps3_repository_read_stor_dev_num_blocks(bus_index, dev_index,\r\nnum_blocks);\r\nif (result)\r\nreturn result;\r\nresult = ps3_repository_read_stor_dev_num_regions(bus_index, dev_index,\r\nnum_regions);\r\nreturn result;\r\n}\r\nint ps3_repository_read_stor_dev_region(unsigned int bus_index,\r\nunsigned int dev_index, unsigned int region_index,\r\nunsigned int *region_id, u64 *region_start, u64 *region_size)\r\n{\r\nint result;\r\nresult = ps3_repository_read_stor_dev_region_id(bus_index, dev_index,\r\nregion_index, region_id);\r\nif (result)\r\nreturn result;\r\nresult = ps3_repository_read_stor_dev_region_start(bus_index, dev_index,\r\nregion_index, region_start);\r\nif (result)\r\nreturn result;\r\nresult = ps3_repository_read_stor_dev_region_size(bus_index, dev_index,\r\nregion_index, region_size);\r\nreturn result;\r\n}\r\nint ps3_repository_read_num_pu(u64 *num_pu)\r\n{\r\n*num_pu = 0;\r\nreturn read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("pun", 0),\r\n0, 0,\r\nnum_pu, NULL);\r\n}\r\nint ps3_repository_read_pu_id(unsigned int pu_index, u64 *pu_id)\r\n{\r\nreturn read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("pu", pu_index),\r\n0, 0,\r\npu_id, NULL);\r\n}\r\nint ps3_repository_read_rm_size(unsigned int ppe_id, u64 *rm_size)\r\n{\r\nreturn read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("pu", 0),\r\nppe_id,\r\nmake_field("rm_size", 0),\r\nrm_size, NULL);\r\n}\r\nint ps3_repository_read_region_total(u64 *region_total)\r\n{\r\nreturn read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("rgntotal", 0),\r\n0, 0,\r\nregion_total, NULL);\r\n}\r\nint ps3_repository_read_mm_info(u64 *rm_base, u64 *rm_size, u64 *region_total)\r\n{\r\nint result;\r\nu64 ppe_id;\r\nlv1_get_logical_ppe_id(&ppe_id);\r\n*rm_base = 0;\r\nresult = ps3_repository_read_rm_size(ppe_id, rm_size);\r\nreturn result ? result\r\n: ps3_repository_read_region_total(region_total);\r\n}\r\nint ps3_repository_read_num_spu_reserved(unsigned int *num_spu_reserved)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("spun", 0),\r\n0, 0,\r\n&v1, NULL);\r\n*num_spu_reserved = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_num_spu_resource_id(unsigned int *num_resource_id)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("spursvn", 0),\r\n0, 0,\r\n&v1, NULL);\r\n*num_resource_id = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_spu_resource_id(unsigned int res_index,\r\nenum ps3_spu_resource_type *resource_type, unsigned int *resource_id)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nu64 v2 = 0;\r\nresult = read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("spursv", 0),\r\nres_index,\r\n0,\r\n&v1, &v2);\r\n*resource_type = v1;\r\n*resource_id = v2;\r\nreturn result;\r\n}\r\nstatic int ps3_repository_read_boot_dat_address(u64 *address)\r\n{\r\nreturn read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("boot_dat", 0),\r\nmake_field("address", 0),\r\n0,\r\naddress, NULL);\r\n}\r\nint ps3_repository_read_boot_dat_size(unsigned int *size)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("boot_dat", 0),\r\nmake_field("size", 0),\r\n0,\r\n&v1, NULL);\r\n*size = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_vuart_av_port(unsigned int *port)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("vir_uart", 0),\r\nmake_field("port", 0),\r\nmake_field("avset", 0),\r\n&v1, NULL);\r\n*port = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_vuart_sysmgr_port(unsigned int *port)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_CURRENT,\r\nmake_first_field("bi", 0),\r\nmake_field("vir_uart", 0),\r\nmake_field("port", 0),\r\nmake_field("sysmgr", 0),\r\n&v1, NULL);\r\n*port = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_boot_dat_info(u64 *lpar_addr, unsigned int *size)\r\n{\r\nint result;\r\n*size = 0;\r\nresult = ps3_repository_read_boot_dat_address(lpar_addr);\r\nreturn result ? result\r\n: ps3_repository_read_boot_dat_size(size);\r\n}\r\nint ps3_repository_read_num_be(unsigned int *num_be)\r\n{\r\nint result;\r\nu64 v1 = 0;\r\nresult = read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("ben", 0),\r\n0,\r\n0,\r\n0,\r\n&v1, NULL);\r\n*num_be = v1;\r\nreturn result;\r\n}\r\nint ps3_repository_read_be_node_id(unsigned int be_index, u64 *node_id)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("be", be_index),\r\n0,\r\n0,\r\n0,\r\nnode_id, NULL);\r\n}\r\nint ps3_repository_read_be_id(u64 node_id, u64 *be_id)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("be", 0),\r\nnode_id,\r\n0,\r\n0,\r\nbe_id, NULL);\r\n}\r\nint ps3_repository_read_tb_freq(u64 node_id, u64 *tb_freq)\r\n{\r\nreturn read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("be", 0),\r\nnode_id,\r\nmake_field("clock", 0),\r\n0,\r\ntb_freq, NULL);\r\n}\r\nint ps3_repository_read_be_tb_freq(unsigned int be_index, u64 *tb_freq)\r\n{\r\nint result;\r\nu64 node_id;\r\n*tb_freq = 0;\r\nresult = ps3_repository_read_be_node_id(be_index, &node_id);\r\nreturn result ? result\r\n: ps3_repository_read_tb_freq(node_id, tb_freq);\r\n}\r\nint ps3_repository_read_lpm_privileges(unsigned int be_index, u64 *lpar,\r\nu64 *rights)\r\n{\r\nint result;\r\nu64 node_id;\r\n*lpar = 0;\r\n*rights = 0;\r\nresult = ps3_repository_read_be_node_id(be_index, &node_id);\r\nreturn result ? result\r\n: read_node(PS3_LPAR_ID_PME,\r\nmake_first_field("be", 0),\r\nnode_id,\r\nmake_field("lpm", 0),\r\nmake_field("priv", 0),\r\nlpar, rights);\r\n}\r\nint ps3_repository_dump_resource_info(const struct ps3_repository_device *repo)\r\n{\r\nint result = 0;\r\nunsigned int res_index;\r\npr_devel(" -> %s:%d: (%u:%u)\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\nfor (res_index = 0; res_index < 10; res_index++) {\r\nenum ps3_interrupt_type intr_type;\r\nunsigned int interrupt_id;\r\nresult = ps3_repository_read_dev_intr(repo->bus_index,\r\nrepo->dev_index, res_index, &intr_type, &interrupt_id);\r\nif (result) {\r\nif (result != LV1_NO_ENTRY)\r\npr_devel("%s:%d ps3_repository_read_dev_intr"\r\n" (%u:%u) failed\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\nbreak;\r\n}\r\npr_devel("%s:%d (%u:%u) intr_type %u, interrupt_id %u\n",\r\n__func__, __LINE__, repo->bus_index, repo->dev_index,\r\nintr_type, interrupt_id);\r\n}\r\nfor (res_index = 0; res_index < 10; res_index++) {\r\nenum ps3_reg_type reg_type;\r\nu64 bus_addr;\r\nu64 len;\r\nresult = ps3_repository_read_dev_reg(repo->bus_index,\r\nrepo->dev_index, res_index, &reg_type, &bus_addr, &len);\r\nif (result) {\r\nif (result != LV1_NO_ENTRY)\r\npr_devel("%s:%d ps3_repository_read_dev_reg"\r\n" (%u:%u) failed\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\nbreak;\r\n}\r\npr_devel("%s:%d (%u:%u) reg_type %u, bus_addr %llxh, len %llxh\n",\r\n__func__, __LINE__, repo->bus_index, repo->dev_index,\r\nreg_type, bus_addr, len);\r\n}\r\npr_devel(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int dump_stor_dev_info(struct ps3_repository_device *repo)\r\n{\r\nint result = 0;\r\nunsigned int num_regions, region_index;\r\nu64 port, blk_size, num_blocks;\r\npr_devel(" -> %s:%d: (%u:%u)\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\nresult = ps3_repository_read_stor_dev_info(repo->bus_index,\r\nrepo->dev_index, &port, &blk_size, &num_blocks, &num_regions);\r\nif (result) {\r\npr_devel("%s:%d ps3_repository_read_stor_dev_info"\r\n" (%u:%u) failed\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\ngoto out;\r\n}\r\npr_devel("%s:%d (%u:%u): port %llu, blk_size %llu, num_blocks "\r\n"%llu, num_regions %u\n",\r\n__func__, __LINE__, repo->bus_index, repo->dev_index,\r\nport, blk_size, num_blocks, num_regions);\r\nfor (region_index = 0; region_index < num_regions; region_index++) {\r\nunsigned int region_id;\r\nu64 region_start, region_size;\r\nresult = ps3_repository_read_stor_dev_region(repo->bus_index,\r\nrepo->dev_index, region_index, &region_id,\r\n&region_start, &region_size);\r\nif (result) {\r\npr_devel("%s:%d ps3_repository_read_stor_dev_region"\r\n" (%u:%u) failed\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\nbreak;\r\n}\r\npr_devel("%s:%d (%u:%u) region_id %u, start %lxh, size %lxh\n",\r\n__func__, __LINE__, repo->bus_index, repo->dev_index,\r\nregion_id, (unsigned long)region_start,\r\n(unsigned long)region_size);\r\n}\r\nout:\r\npr_devel(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nstatic int dump_device_info(struct ps3_repository_device *repo,\r\nunsigned int num_dev)\r\n{\r\nint result = 0;\r\npr_devel(" -> %s:%d: bus_%u\n", __func__, __LINE__, repo->bus_index);\r\nfor (repo->dev_index = 0; repo->dev_index < num_dev;\r\nrepo->dev_index++) {\r\nresult = ps3_repository_read_dev_type(repo->bus_index,\r\nrepo->dev_index, &repo->dev_type);\r\nif (result) {\r\npr_devel("%s:%d ps3_repository_read_dev_type"\r\n" (%u:%u) failed\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\nbreak;\r\n}\r\nresult = ps3_repository_read_dev_id(repo->bus_index,\r\nrepo->dev_index, &repo->dev_id);\r\nif (result) {\r\npr_devel("%s:%d ps3_repository_read_dev_id"\r\n" (%u:%u) failed\n", __func__, __LINE__,\r\nrepo->bus_index, repo->dev_index);\r\ncontinue;\r\n}\r\npr_devel("%s:%d (%u:%u): dev_type %u, dev_id %lu\n", __func__,\r\n__LINE__, repo->bus_index, repo->dev_index,\r\nrepo->dev_type, (unsigned long)repo->dev_id);\r\nps3_repository_dump_resource_info(repo);\r\nif (repo->bus_type == PS3_BUS_TYPE_STORAGE)\r\ndump_stor_dev_info(repo);\r\n}\r\npr_devel(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\n}\r\nint ps3_repository_dump_bus_info(void)\r\n{\r\nint result = 0;\r\nstruct ps3_repository_device repo;\r\npr_devel(" -> %s:%d\n", __func__, __LINE__);\r\nmemset(&repo, 0, sizeof(repo));\r\nfor (repo.bus_index = 0; repo.bus_index < 10; repo.bus_index++) {\r\nunsigned int num_dev;\r\nresult = ps3_repository_read_bus_type(repo.bus_index,\r\n&repo.bus_type);\r\nif (result) {\r\npr_devel("%s:%d read_bus_type(%u) failed\n",\r\n__func__, __LINE__, repo.bus_index);\r\nbreak;\r\n}\r\nresult = ps3_repository_read_bus_id(repo.bus_index,\r\n&repo.bus_id);\r\nif (result) {\r\npr_devel("%s:%d read_bus_id(%u) failed\n",\r\n__func__, __LINE__, repo.bus_index);\r\ncontinue;\r\n}\r\nif (repo.bus_index != repo.bus_id)\r\npr_devel("%s:%d bus_index != bus_id\n",\r\n__func__, __LINE__);\r\nresult = ps3_repository_read_bus_num_dev(repo.bus_index,\r\n&num_dev);\r\nif (result) {\r\npr_devel("%s:%d read_bus_num_dev(%u) failed\n",\r\n__func__, __LINE__, repo.bus_index);\r\ncontinue;\r\n}\r\npr_devel("%s:%d bus_%u: bus_type %u, bus_id %lu, num_dev %u\n",\r\n__func__, __LINE__, repo.bus_index, repo.bus_type,\r\n(unsigned long)repo.bus_id, num_dev);\r\ndump_device_info(&repo, num_dev);\r\n}\r\npr_devel(" <- %s:%d\n", __func__, __LINE__);\r\nreturn result;\r\n}

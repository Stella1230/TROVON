static void pps_tty_dcd_change(struct tty_struct *tty, unsigned int status,\r\nstruct pps_event_time *ts)\r\n{\r\nstruct pps_device *pps = (struct pps_device *)tty->disc_data;\r\nBUG_ON(pps == NULL);\r\npps_event(pps, ts, status ? PPS_CAPTUREASSERT :\r\nPPS_CAPTURECLEAR, NULL);\r\ndev_dbg(pps->dev, "PPS %s at %lu\n",\r\nstatus ? "assert" : "clear", jiffies);\r\n}\r\nstatic int pps_tty_open(struct tty_struct *tty)\r\n{\r\nstruct pps_source_info info;\r\nstruct tty_driver *drv = tty->driver;\r\nint index = tty->index + drv->name_base;\r\nstruct pps_device *pps;\r\nint ret;\r\ninfo.owner = THIS_MODULE;\r\ninfo.dev = NULL;\r\nsnprintf(info.name, PPS_MAX_NAME_LEN, "%s%d", drv->driver_name, index);\r\nsnprintf(info.path, PPS_MAX_NAME_LEN, "/dev/%s%d", drv->name, index);\r\ninfo.mode = PPS_CAPTUREBOTH | \\r\nPPS_OFFSETASSERT | PPS_OFFSETCLEAR | \\r\nPPS_CANWAIT | PPS_TSFMT_TSPEC;\r\npps = pps_register_source(&info, PPS_CAPTUREBOTH | \\r\nPPS_OFFSETASSERT | PPS_OFFSETCLEAR);\r\nif (pps == NULL) {\r\npr_err("cannot register PPS source \"%s\"\n", info.path);\r\nreturn -ENOMEM;\r\n}\r\ntty->disc_data = pps;\r\nret = alias_n_tty_open(tty);\r\nif (ret < 0) {\r\npr_err("cannot open tty ldisc \"%s\"\n", info.path);\r\ngoto err_unregister;\r\n}\r\ndev_info(pps->dev, "source \"%s\" added\n", info.path);\r\nreturn 0;\r\nerr_unregister:\r\ntty->disc_data = NULL;\r\npps_unregister_source(pps);\r\nreturn ret;\r\n}\r\nstatic void pps_tty_close(struct tty_struct *tty)\r\n{\r\nstruct pps_device *pps = (struct pps_device *)tty->disc_data;\r\nalias_n_tty_close(tty);\r\ntty->disc_data = NULL;\r\ndev_info(pps->dev, "removed\n");\r\npps_unregister_source(pps);\r\n}\r\nstatic int __init pps_tty_init(void)\r\n{\r\nint err;\r\nn_tty_inherit_ops(&pps_ldisc_ops);\r\nalias_n_tty_open = pps_ldisc_ops.open;\r\nalias_n_tty_close = pps_ldisc_ops.close;\r\npps_ldisc_ops.owner = THIS_MODULE;\r\npps_ldisc_ops.magic = PPS_TTY_MAGIC;\r\npps_ldisc_ops.name = "pps_tty";\r\npps_ldisc_ops.dcd_change = pps_tty_dcd_change;\r\npps_ldisc_ops.open = pps_tty_open;\r\npps_ldisc_ops.close = pps_tty_close;\r\nerr = tty_register_ldisc(N_PPS, &pps_ldisc_ops);\r\nif (err)\r\npr_err("can't register PPS line discipline\n");\r\nelse\r\npr_info("PPS line discipline registered\n");\r\nreturn err;\r\n}\r\nstatic void __exit pps_tty_cleanup(void)\r\n{\r\nint err;\r\nerr = tty_unregister_ldisc(N_PPS);\r\nif (err)\r\npr_err("can't unregister PPS line discipline\n");\r\nelse\r\npr_info("PPS line discipline removed\n");\r\n}

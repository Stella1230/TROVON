static int sirfsoc_list_groups(struct pinctrl_dev *pctldev, unsigned selector)\r\n{\r\nif (selector >= ARRAY_SIZE(sirfsoc_pin_groups))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic const char *sirfsoc_get_group_name(struct pinctrl_dev *pctldev,\r\nunsigned selector)\r\n{\r\nif (selector >= ARRAY_SIZE(sirfsoc_pin_groups))\r\nreturn NULL;\r\nreturn sirfsoc_pin_groups[selector].name;\r\n}\r\nstatic int sirfsoc_get_group_pins(struct pinctrl_dev *pctldev, unsigned selector,\r\nconst unsigned **pins,\r\nunsigned *num_pins)\r\n{\r\nif (selector >= ARRAY_SIZE(sirfsoc_pin_groups))\r\nreturn -EINVAL;\r\n*pins = sirfsoc_pin_groups[selector].pins;\r\n*num_pins = sirfsoc_pin_groups[selector].num_pins;\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_pin_dbg_show(struct pinctrl_dev *pctldev, struct seq_file *s,\r\nunsigned offset)\r\n{\r\nseq_printf(s, " " DRIVER_NAME);\r\n}\r\nstatic void sirfsoc_pinmux_endisable(struct sirfsoc_pmx *spmx, unsigned selector,\r\nbool enable)\r\n{\r\nint i;\r\nconst struct sirfsoc_padmux *mux = sirfsoc_pmx_functions[selector].padmux;\r\nconst struct sirfsoc_muxmask *mask = mux->muxmask;\r\nfor (i = 0; i < mux->muxmask_counts; i++) {\r\nu32 muxval;\r\nmuxval = readl(spmx->gpio_virtbase + SIRFSOC_GPIO_PAD_EN(mask[i].group));\r\nif (enable)\r\nmuxval = muxval & ~mask[i].mask;\r\nelse\r\nmuxval = muxval | mask[i].mask;\r\nwritel(muxval, spmx->gpio_virtbase + SIRFSOC_GPIO_PAD_EN(mask[i].group));\r\n}\r\nif (mux->funcmask && enable) {\r\nu32 func_en_val;\r\nfunc_en_val =\r\nreadl(spmx->rsc_virtbase + SIRFSOC_RSC_PIN_MUX);\r\nfunc_en_val =\r\n(func_en_val & ~mux->funcmask) | (mux->\r\nfuncval);\r\nwritel(func_en_val, spmx->rsc_virtbase + SIRFSOC_RSC_PIN_MUX);\r\n}\r\n}\r\nstatic int sirfsoc_pinmux_enable(struct pinctrl_dev *pmxdev, unsigned selector,\r\nunsigned group)\r\n{\r\nstruct sirfsoc_pmx *spmx;\r\nspmx = pinctrl_dev_get_drvdata(pmxdev);\r\nsirfsoc_pinmux_endisable(spmx, selector, true);\r\nreturn 0;\r\n}\r\nstatic void sirfsoc_pinmux_disable(struct pinctrl_dev *pmxdev, unsigned selector,\r\nunsigned group)\r\n{\r\nstruct sirfsoc_pmx *spmx;\r\nspmx = pinctrl_dev_get_drvdata(pmxdev);\r\nsirfsoc_pinmux_endisable(spmx, selector, false);\r\n}\r\nstatic int sirfsoc_pinmux_list_funcs(struct pinctrl_dev *pmxdev, unsigned selector)\r\n{\r\nif (selector >= ARRAY_SIZE(sirfsoc_pmx_functions))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic const char *sirfsoc_pinmux_get_func_name(struct pinctrl_dev *pctldev,\r\nunsigned selector)\r\n{\r\nreturn sirfsoc_pmx_functions[selector].name;\r\n}\r\nstatic int sirfsoc_pinmux_get_groups(struct pinctrl_dev *pctldev, unsigned selector,\r\nconst char * const **groups,\r\nunsigned * const num_groups)\r\n{\r\n*groups = sirfsoc_pmx_functions[selector].groups;\r\n*num_groups = sirfsoc_pmx_functions[selector].num_groups;\r\nreturn 0;\r\n}\r\nstatic int sirfsoc_pinmux_request_gpio(struct pinctrl_dev *pmxdev,\r\nstruct pinctrl_gpio_range *range, unsigned offset)\r\n{\r\nstruct sirfsoc_pmx *spmx;\r\nint group = range->id;\r\nu32 muxval;\r\nspmx = pinctrl_dev_get_drvdata(pmxdev);\r\nmuxval = readl(spmx->gpio_virtbase + SIRFSOC_GPIO_PAD_EN(group));\r\nmuxval = muxval | (1 << (offset - range->pin_base));\r\nwritel(muxval, spmx->gpio_virtbase + SIRFSOC_GPIO_PAD_EN(group));\r\nreturn 0;\r\n}\r\nstatic void __iomem *sirfsoc_rsc_of_iomap(void)\r\n{\r\nconst struct of_device_id rsc_ids[] = {\r\n{ .compatible = "sirf,prima2-rsc" },\r\n{}\r\n};\r\nstruct device_node *np;\r\nnp = of_find_matching_node(NULL, rsc_ids);\r\nif (!np)\r\npanic("unable to find compatible rsc node in dtb\n");\r\nreturn of_iomap(np, 0);\r\n}\r\nstatic int __devinit sirfsoc_pinmux_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct sirfsoc_pmx *spmx;\r\nstruct device_node *np = pdev->dev.of_node;\r\nint i;\r\nspmx = devm_kzalloc(&pdev->dev, sizeof(*spmx), GFP_KERNEL);\r\nif (!spmx)\r\nreturn -ENOMEM;\r\nspmx->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, spmx);\r\nspmx->gpio_virtbase = of_iomap(np, 0);\r\nif (!spmx->gpio_virtbase) {\r\nret = -ENOMEM;\r\ndev_err(&pdev->dev, "can't map gpio registers\n");\r\ngoto out_no_gpio_remap;\r\n}\r\nspmx->rsc_virtbase = sirfsoc_rsc_of_iomap();\r\nif (!spmx->rsc_virtbase) {\r\nret = -ENOMEM;\r\ndev_err(&pdev->dev, "can't map rsc registers\n");\r\ngoto out_no_rsc_remap;\r\n}\r\nspmx->pmx = pinctrl_register(&sirfsoc_pinmux_desc, &pdev->dev, spmx);\r\nif (!spmx->pmx) {\r\ndev_err(&pdev->dev, "could not register SIRFSOC pinmux driver\n");\r\nret = -EINVAL;\r\ngoto out_no_pmx;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(sirfsoc_gpio_ranges); i++)\r\npinctrl_add_gpio_range(spmx->pmx, &sirfsoc_gpio_ranges[i]);\r\ndev_info(&pdev->dev, "initialized SIRFSOC pinmux driver\n");\r\nreturn 0;\r\nout_no_pmx:\r\niounmap(spmx->rsc_virtbase);\r\nout_no_rsc_remap:\r\niounmap(spmx->gpio_virtbase);\r\nout_no_gpio_remap:\r\nplatform_set_drvdata(pdev, NULL);\r\ndevm_kfree(&pdev->dev, spmx);\r\nreturn ret;\r\n}\r\nstatic int __init sirfsoc_pinmux_init(void)\r\n{\r\nreturn platform_driver_register(&sirfsoc_pinmux_driver);\r\n}

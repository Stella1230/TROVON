int create_user_ns(struct cred *new)\r\n{\r\nstruct user_namespace *ns;\r\nstruct user_struct *root_user;\r\nint n;\r\nns = kmem_cache_alloc(user_ns_cachep, GFP_KERNEL);\r\nif (!ns)\r\nreturn -ENOMEM;\r\nkref_init(&ns->kref);\r\nfor (n = 0; n < UIDHASH_SZ; ++n)\r\nINIT_HLIST_HEAD(ns->uidhash_table + n);\r\nroot_user = alloc_uid(ns, 0);\r\nif (!root_user) {\r\nkmem_cache_free(user_ns_cachep, ns);\r\nreturn -ENOMEM;\r\n}\r\nns->creator = new->user;\r\nnew->user = root_user;\r\nnew->uid = new->euid = new->suid = new->fsuid = 0;\r\nnew->gid = new->egid = new->sgid = new->fsgid = 0;\r\nput_group_info(new->group_info);\r\nnew->group_info = get_group_info(&init_groups);\r\n#ifdef CONFIG_KEYS\r\nkey_put(new->request_key_auth);\r\nnew->request_key_auth = NULL;\r\n#endif\r\nput_user_ns(ns);\r\nreturn 0;\r\n}\r\nstatic void free_user_ns_work(struct work_struct *work)\r\n{\r\nstruct user_namespace *ns =\r\ncontainer_of(work, struct user_namespace, destroyer);\r\nfree_uid(ns->creator);\r\nkmem_cache_free(user_ns_cachep, ns);\r\n}\r\nvoid free_user_ns(struct kref *kref)\r\n{\r\nstruct user_namespace *ns =\r\ncontainer_of(kref, struct user_namespace, kref);\r\nINIT_WORK(&ns->destroyer, free_user_ns_work);\r\nschedule_work(&ns->destroyer);\r\n}\r\nuid_t user_ns_map_uid(struct user_namespace *to, const struct cred *cred, uid_t uid)\r\n{\r\nstruct user_namespace *tmp;\r\nif (likely(to == cred->user->user_ns))\r\nreturn uid;\r\nfor ( tmp = to; tmp != &init_user_ns;\r\ntmp = tmp->creator->user_ns ) {\r\nif (cred->user == tmp->creator) {\r\nreturn (uid_t)0;\r\n}\r\n}\r\nreturn overflowuid;\r\n}\r\ngid_t user_ns_map_gid(struct user_namespace *to, const struct cred *cred, gid_t gid)\r\n{\r\nstruct user_namespace *tmp;\r\nif (likely(to == cred->user->user_ns))\r\nreturn gid;\r\nfor ( tmp = to; tmp != &init_user_ns;\r\ntmp = tmp->creator->user_ns ) {\r\nif (cred->user == tmp->creator) {\r\nreturn (gid_t)0;\r\n}\r\n}\r\nreturn overflowgid;\r\n}\r\nstatic __init int user_namespaces_init(void)\r\n{\r\nuser_ns_cachep = KMEM_CACHE(user_namespace, SLAB_PANIC);\r\nreturn 0;\r\n}

static int pci171x_insn_read_ai(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, timeout;\r\n#ifdef PCI171x_PARANOIDCHECK\r\nunsigned int idata;\r\n#endif\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_insn_read_ai(...)\n");\r\ndevpriv->CntrlReg &= Control_CNT0;\r\ndevpriv->CntrlReg |= Control_SW;\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nsetup_channel_list(dev, s, &insn->chanspec, 1, 1);\r\nDPRINTK("adv_pci1710 A ST=%4x IO=%x\n",\r\ninw(dev->iobase + PCI171x_STATUS),\r\ndev->iobase + PCI171x_STATUS);\r\nfor (n = 0; n < insn->n; n++) {\r\noutw(0, dev->iobase + PCI171x_SOFTTRG);\r\nDPRINTK("adv_pci1710 B n=%d ST=%4x\n", n,\r\ninw(dev->iobase + PCI171x_STATUS));\r\nDPRINTK("adv_pci1710 C n=%d ST=%4x\n", n,\r\ninw(dev->iobase + PCI171x_STATUS));\r\ntimeout = 100;\r\nwhile (timeout--) {\r\nif (!(inw(dev->iobase + PCI171x_STATUS) & Status_FE))\r\ngoto conv_finish;\r\nif (!(timeout % 10))\r\nDPRINTK("adv_pci1710 D n=%d tm=%d ST=%4x\n", n,\r\ntimeout,\r\ninw(dev->iobase + PCI171x_STATUS));\r\n}\r\ncomedi_error(dev, "A/D insn timeout");\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\ndata[n] = 0;\r\nDPRINTK\r\n("adv_pci1710 EDBG: END: pci171x_insn_read_ai(...) n=%d\n",\r\nn);\r\nreturn -ETIME;\r\nconv_finish:\r\n#ifdef PCI171x_PARANOIDCHECK\r\nidata = inw(dev->iobase + PCI171x_AD_DATA);\r\nif (this_board->cardtype != TYPE_PCI1713)\r\nif ((idata & 0xf000) != devpriv->act_chanlist[0]) {\r\ncomedi_error(dev, "A/D insn data droput!");\r\nreturn -ETIME;\r\n}\r\ndata[n] = idata & 0x0fff;\r\n#else\r\ndata[n] = inw(dev->iobase + PCI171x_AD_DATA) & 0x0fff;\r\n#endif\r\n}\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nDPRINTK("adv_pci1710 EDBG: END: pci171x_insn_read_ai(...) n=%d\n", n);\r\nreturn n;\r\n}\r\nstatic int pci171x_insn_write_ao(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, chan, range, ofs;\r\nchan = CR_CHAN(insn->chanspec);\r\nrange = CR_RANGE(insn->chanspec);\r\nif (chan) {\r\ndevpriv->da_ranges &= 0xfb;\r\ndevpriv->da_ranges |= (range << 2);\r\noutw(devpriv->da_ranges, dev->iobase + PCI171x_DAREF);\r\nofs = PCI171x_DA2;\r\n} else {\r\ndevpriv->da_ranges &= 0xfe;\r\ndevpriv->da_ranges |= range;\r\noutw(devpriv->da_ranges, dev->iobase + PCI171x_DAREF);\r\nofs = PCI171x_DA1;\r\n}\r\nfor (n = 0; n < insn->n; n++)\r\noutw(data[n], dev->iobase + ofs);\r\ndevpriv->ao_data[chan] = data[n];\r\nreturn n;\r\n}\r\nstatic int pci171x_insn_read_ao(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++)\r\ndata[n] = devpriv->ao_data[chan];\r\nreturn n;\r\n}\r\nstatic int pci171x_insn_bits_di(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[1] = inw(dev->iobase + PCI171x_DI);\r\nreturn 2;\r\n}\r\nstatic int pci171x_insn_bits_do(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (data[0]) {\r\ns->state &= ~data[0];\r\ns->state |= (data[0] & data[1]);\r\noutw(s->state, dev->iobase + PCI171x_DO);\r\n}\r\ndata[1] = s->state;\r\nreturn 2;\r\n}\r\nstatic int pci171x_insn_counter_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int msb, lsb, ccntrl;\r\nint i;\r\nccntrl = 0xD2;\r\nfor (i = 0; i < insn->n; i++) {\r\noutw(ccntrl, dev->iobase + PCI171x_CNTCTRL);\r\nlsb = inw(dev->iobase + PCI171x_CNT0) & 0xFF;\r\nmsb = inw(dev->iobase + PCI171x_CNT0) & 0xFF;\r\ndata[0] = lsb | (msb << 8);\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int pci171x_insn_counter_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nuint msb, lsb, ccntrl, status;\r\nlsb = data[0] & 0x00FF;\r\nmsb = (data[0] & 0xFF00) >> 8;\r\noutw(lsb, dev->iobase + PCI171x_CNT0);\r\noutw(msb, dev->iobase + PCI171x_CNT0);\r\nif (devpriv->cnt0_write_wait) {\r\nccntrl = 0xE2;\r\ndo {\r\noutw(ccntrl, dev->iobase + PCI171x_CNTCTRL);\r\nstatus = inw(dev->iobase + PCI171x_CNT0) & 0xFF;\r\n} while (status & 0x40);\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int pci171x_insn_counter_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\n#ifdef unused\r\nuint ccntrl = 0;\r\ndevpriv->cnt0_write_wait = data[0] & 0x20;\r\nif (!(data[0] & 0x10)) {\r\ndevpriv->CntrlReg &= ~Control_CNT0;\r\n} else {\r\ndevpriv->CntrlReg |= Control_CNT0;\r\n}\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\nif (data[0] & 0x01)\r\nccntrl |= Counter_M0;\r\nif (data[0] & 0x02)\r\nccntrl |= Counter_M1;\r\nif (data[0] & 0x04)\r\nccntrl |= Counter_M2;\r\nif (data[0] & 0x08)\r\nccntrl |= Counter_BCD;\r\nccntrl |= Counter_RW0;\r\nccntrl |= Counter_RW1;\r\noutw(ccntrl, dev->iobase + PCI171x_CNTCTRL);\r\n#endif\r\nreturn 1;\r\n}\r\nstatic int pci1720_insn_write_ao(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, rangereg, chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nrangereg = devpriv->da_ranges & (~(0x03 << (chan << 1)));\r\nrangereg |= (CR_RANGE(insn->chanspec) << (chan << 1));\r\nif (rangereg != devpriv->da_ranges) {\r\noutb(rangereg, dev->iobase + PCI1720_RANGE);\r\ndevpriv->da_ranges = rangereg;\r\n}\r\nfor (n = 0; n < insn->n; n++) {\r\noutw(data[n], dev->iobase + PCI1720_DA0 + (chan << 1));\r\noutb(0, dev->iobase + PCI1720_SYNCOUT);\r\n}\r\ndevpriv->ao_data[chan] = data[n];\r\nreturn n;\r\n}\r\nstatic void interrupt_pci1710_every_sample(void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct comedi_subdevice *s = dev->subdevices + 0;\r\nint m;\r\n#ifdef PCI171x_PARANOIDCHECK\r\nshort sampl;\r\n#endif\r\nDPRINTK("adv_pci1710 EDBG: BGN: interrupt_pci1710_every_sample(...)\n");\r\nm = inw(dev->iobase + PCI171x_STATUS);\r\nif (m & Status_FE) {\r\nprintk("comedi%d: A/D FIFO empty (%4x)\n", dev->minor, m);\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |= COMEDI_CB_EOA | COMEDI_CB_ERROR;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\nif (m & Status_FF) {\r\nprintk\r\n("comedi%d: A/D FIFO Full status (Fatal Error!) (%4x)\n",\r\ndev->minor, m);\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |= COMEDI_CB_EOA | COMEDI_CB_ERROR;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nDPRINTK("FOR ");\r\nfor (; !(inw(dev->iobase + PCI171x_STATUS) & Status_FE);) {\r\n#ifdef PCI171x_PARANOIDCHECK\r\nsampl = inw(dev->iobase + PCI171x_AD_DATA);\r\nDPRINTK("%04x:", sampl);\r\nif (this_board->cardtype != TYPE_PCI1713)\r\nif ((sampl & 0xf000) !=\r\ndevpriv->act_chanlist[s->async->cur_chan]) {\r\nprintk\r\n("comedi: A/D data dropout: received data from channel %d, expected %d!\n",\r\n(sampl & 0xf000) >> 12,\r\n(devpriv->\r\nact_chanlist[s->\r\nasync->cur_chan] & 0xf000) >>\r\n12);\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |=\r\nCOMEDI_CB_EOA | COMEDI_CB_ERROR;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\nDPRINTK("%8d %2d %8d~", s->async->buf_int_ptr,\r\ns->async->cur_chan, s->async->buf_int_count);\r\ncomedi_buf_put(s->async, sampl & 0x0fff);\r\n#else\r\ncomedi_buf_put(s->async,\r\ninw(dev->iobase + PCI171x_AD_DATA) & 0x0fff);\r\n#endif\r\n++s->async->cur_chan;\r\nif (s->async->cur_chan >= devpriv->ai_n_chan)\r\ns->async->cur_chan = 0;\r\nif (s->async->cur_chan == 0) {\r\ndevpriv->ai_act_scan++;\r\nDPRINTK\r\n("adv_pci1710 EDBG: EOS1 bic %d bip %d buc %d bup %d\n",\r\ns->async->buf_int_count, s->async->buf_int_ptr,\r\ns->async->buf_user_count, s->async->buf_user_ptr);\r\nDPRINTK("adv_pci1710 EDBG: EOS2\n");\r\nif ((!devpriv->neverending_ai) && (devpriv->ai_act_scan >= devpriv->ai_scans)) {\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |= COMEDI_CB_EOA;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\n}\r\n}\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nDPRINTK("adv_pci1710 EDBG: END: interrupt_pci1710_every_sample(...)\n");\r\ncomedi_event(dev, s);\r\n}\r\nstatic int move_block_from_fifo(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, int n, int turn)\r\n{\r\nint i, j;\r\n#ifdef PCI171x_PARANOIDCHECK\r\nint sampl;\r\n#endif\r\nDPRINTK("adv_pci1710 EDBG: BGN: move_block_from_fifo(...,%d,%d)\n", n,\r\nturn);\r\nj = s->async->cur_chan;\r\nfor (i = 0; i < n; i++) {\r\n#ifdef PCI171x_PARANOIDCHECK\r\nsampl = inw(dev->iobase + PCI171x_AD_DATA);\r\nif (this_board->cardtype != TYPE_PCI1713)\r\nif ((sampl & 0xf000) != devpriv->act_chanlist[j]) {\r\nprintk\r\n("comedi%d: A/D FIFO data dropout: received data from channel %d, expected %d! (%d/%d/%d/%d/%d/%4x)\n",\r\ndev->minor, (sampl & 0xf000) >> 12,\r\n(devpriv->act_chanlist[j] & 0xf000) >> 12,\r\ni, j, devpriv->ai_act_scan, n, turn,\r\nsampl);\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |=\r\nCOMEDI_CB_EOA | COMEDI_CB_ERROR;\r\ncomedi_event(dev, s);\r\nreturn 1;\r\n}\r\ncomedi_buf_put(s->async, sampl & 0x0fff);\r\n#else\r\ncomedi_buf_put(s->async,\r\ninw(dev->iobase + PCI171x_AD_DATA) & 0x0fff);\r\n#endif\r\nj++;\r\nif (j >= devpriv->ai_n_chan) {\r\nj = 0;\r\ndevpriv->ai_act_scan++;\r\n}\r\n}\r\ns->async->cur_chan = j;\r\nDPRINTK("adv_pci1710 EDBG: END: move_block_from_fifo(...)\n");\r\nreturn 0;\r\n}\r\nstatic void interrupt_pci1710_half_fifo(void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct comedi_subdevice *s = dev->subdevices + 0;\r\nint m, samplesinbuf;\r\nDPRINTK("adv_pci1710 EDBG: BGN: interrupt_pci1710_half_fifo(...)\n");\r\nm = inw(dev->iobase + PCI171x_STATUS);\r\nif (!(m & Status_FH)) {\r\nprintk("comedi%d: A/D FIFO not half full! (%4x)\n",\r\ndev->minor, m);\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |= COMEDI_CB_EOA | COMEDI_CB_ERROR;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\nif (m & Status_FF) {\r\nprintk\r\n("comedi%d: A/D FIFO Full status (Fatal Error!) (%4x)\n",\r\ndev->minor, m);\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |= COMEDI_CB_EOA | COMEDI_CB_ERROR;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\nsamplesinbuf = this_board->fifo_half_size;\r\nif (samplesinbuf * sizeof(short) >= devpriv->ai_data_len) {\r\nm = devpriv->ai_data_len / sizeof(short);\r\nif (move_block_from_fifo(dev, s, m, 0))\r\nreturn;\r\nsamplesinbuf -= m;\r\n}\r\nif (samplesinbuf) {\r\nif (move_block_from_fifo(dev, s, samplesinbuf, 1))\r\nreturn;\r\n}\r\nif (!devpriv->neverending_ai)\r\nif (devpriv->ai_act_scan >= devpriv->ai_scans) {\r\npci171x_ai_cancel(dev, s);\r\ns->async->events |= COMEDI_CB_EOA;\r\ncomedi_event(dev, s);\r\nreturn;\r\n}\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nDPRINTK("adv_pci1710 EDBG: END: interrupt_pci1710_half_fifo(...)\n");\r\ncomedi_event(dev, s);\r\n}\r\nstatic irqreturn_t interrupt_service_pci1710(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nDPRINTK("adv_pci1710 EDBG: BGN: interrupt_service_pci1710(%d,...)\n",\r\nirq);\r\nif (!dev->attached)\r\nreturn IRQ_NONE;\r\nif (!(inw(dev->iobase + PCI171x_STATUS) & Status_IRQ))\r\nreturn IRQ_NONE;\r\nDPRINTK("adv_pci1710 EDBG: interrupt_service_pci1710() ST: %4x\n",\r\ninw(dev->iobase + PCI171x_STATUS));\r\nif (devpriv->ai_et) {\r\ndevpriv->ai_et = 0;\r\ndevpriv->CntrlReg &= Control_CNT0;\r\ndevpriv->CntrlReg |= Control_SW;\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\ndevpriv->CntrlReg = devpriv->ai_et_CntrlReg;\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\noutw(devpriv->ai_et_MuxVal, dev->iobase + PCI171x_MUX);\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\nstart_pacer(dev, 1, devpriv->ai_et_div1, devpriv->ai_et_div2);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (devpriv->ai_eos) {\r\ninterrupt_pci1710_every_sample(d);\r\n} else {\r\ninterrupt_pci1710_half_fifo(d);\r\n}\r\nDPRINTK("adv_pci1710 EDBG: END: interrupt_service_pci1710(...)\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pci171x_ai_docmd_and_mode(int mode, struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nunsigned int divisor1 = 0, divisor2 = 0;\r\nunsigned int seglen;\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_ai_docmd_and_mode(%d,...)\n",\r\nmode);\r\nstart_pacer(dev, -1, 0, 0);\r\nseglen = check_channel_list(dev, s, devpriv->ai_chanlist,\r\ndevpriv->ai_n_chan);\r\nif (seglen < 1)\r\nreturn -EINVAL;\r\nsetup_channel_list(dev, s, devpriv->ai_chanlist,\r\ndevpriv->ai_n_chan, seglen);\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\ndevpriv->ai_do = mode;\r\ndevpriv->ai_act_scan = 0;\r\ns->async->cur_chan = 0;\r\ndevpriv->ai_buf_ptr = 0;\r\ndevpriv->neverending_ai = 0;\r\ndevpriv->CntrlReg &= Control_CNT0;\r\nif ((devpriv->ai_flags & TRIG_WAKE_EOS)) {\r\ndevpriv->ai_eos = 1;\r\n} else {\r\ndevpriv->CntrlReg |= Control_ONEFH;\r\ndevpriv->ai_eos = 0;\r\n}\r\nif ((devpriv->ai_scans == 0) || (devpriv->ai_scans == -1))\r\ndevpriv->neverending_ai = 1;\r\nelse\r\ndevpriv->neverending_ai = 0;\r\nswitch (mode) {\r\ncase 1:\r\ncase 2:\r\nif (devpriv->ai_timer1 < this_board->ai_ns_min)\r\ndevpriv->ai_timer1 = this_board->ai_ns_min;\r\ndevpriv->CntrlReg |= Control_PACER | Control_IRQEN;\r\nif (mode == 2) {\r\ndevpriv->ai_et_CntrlReg = devpriv->CntrlReg;\r\ndevpriv->CntrlReg &=\r\n~(Control_PACER | Control_ONEFH | Control_GATE);\r\ndevpriv->CntrlReg |= Control_EXT;\r\ndevpriv->ai_et = 1;\r\n} else {\r\ndevpriv->ai_et = 0;\r\n}\r\ni8253_cascade_ns_to_timer(devpriv->i8254_osc_base, &divisor1,\r\n&divisor2, &devpriv->ai_timer1,\r\ndevpriv->ai_flags & TRIG_ROUND_MASK);\r\nDPRINTK\r\n("adv_pci1710 EDBG: OSC base=%u div1=%u div2=%u timer=%u\n",\r\ndevpriv->i8254_osc_base, divisor1, divisor2,\r\ndevpriv->ai_timer1);\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\nif (mode != 2) {\r\nstart_pacer(dev, mode, divisor1, divisor2);\r\n} else {\r\ndevpriv->ai_et_div1 = divisor1;\r\ndevpriv->ai_et_div2 = divisor2;\r\n}\r\nbreak;\r\ncase 3:\r\ndevpriv->CntrlReg |= Control_EXT | Control_IRQEN;\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\nbreak;\r\n}\r\nDPRINTK("adv_pci1710 EDBG: END: pci171x_ai_docmd_and_mode(...)\n");\r\nreturn 0;\r\n}\r\nstatic void pci171x_cmdtest_out(int e, struct comedi_cmd *cmd)\r\n{\r\nprintk("adv_pci1710 e=%d startsrc=%x scansrc=%x convsrc=%x\n", e,\r\ncmd->start_src, cmd->scan_begin_src, cmd->convert_src);\r\nprintk("adv_pci1710 e=%d startarg=%d scanarg=%d convarg=%d\n", e,\r\ncmd->start_arg, cmd->scan_begin_arg, cmd->convert_arg);\r\nprintk("adv_pci1710 e=%d stopsrc=%x scanend=%x\n", e, cmd->stop_src,\r\ncmd->scan_end_src);\r\nprintk("adv_pci1710 e=%d stoparg=%d scanendarg=%d chanlistlen=%d\n",\r\ne, cmd->stop_arg, cmd->scan_end_arg, cmd->chanlist_len);\r\n}\r\nstatic int pci171x_ai_cmdtest(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_cmd *cmd)\r\n{\r\nint err = 0;\r\nint tmp;\r\nunsigned int divisor1 = 0, divisor2 = 0;\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_ai_cmdtest(...)\n");\r\n#ifdef PCI171X_EXTDEBUG\r\npci171x_cmdtest_out(-1, cmd);\r\n#endif\r\ntmp = cmd->start_src;\r\ncmd->start_src &= TRIG_NOW | TRIG_EXT;\r\nif (!cmd->start_src || tmp != cmd->start_src)\r\nerr++;\r\ntmp = cmd->scan_begin_src;\r\ncmd->scan_begin_src &= TRIG_FOLLOW;\r\nif (!cmd->scan_begin_src || tmp != cmd->scan_begin_src)\r\nerr++;\r\ntmp = cmd->convert_src;\r\ncmd->convert_src &= TRIG_TIMER | TRIG_EXT;\r\nif (!cmd->convert_src || tmp != cmd->convert_src)\r\nerr++;\r\ntmp = cmd->scan_end_src;\r\ncmd->scan_end_src &= TRIG_COUNT;\r\nif (!cmd->scan_end_src || tmp != cmd->scan_end_src)\r\nerr++;\r\ntmp = cmd->stop_src;\r\ncmd->stop_src &= TRIG_COUNT | TRIG_NONE;\r\nif (!cmd->stop_src || tmp != cmd->stop_src)\r\nerr++;\r\nif (err) {\r\n#ifdef PCI171X_EXTDEBUG\r\npci171x_cmdtest_out(1, cmd);\r\n#endif\r\nDPRINTK\r\n("adv_pci1710 EDBG: BGN: pci171x_ai_cmdtest(...) err=%d ret=1\n",\r\nerr);\r\nreturn 1;\r\n}\r\nif (cmd->start_src != TRIG_NOW && cmd->start_src != TRIG_EXT) {\r\ncmd->start_src = TRIG_NOW;\r\nerr++;\r\n}\r\nif (cmd->scan_begin_src != TRIG_FOLLOW) {\r\ncmd->scan_begin_src = TRIG_FOLLOW;\r\nerr++;\r\n}\r\nif (cmd->convert_src != TRIG_TIMER && cmd->convert_src != TRIG_EXT)\r\nerr++;\r\nif (cmd->scan_end_src != TRIG_COUNT) {\r\ncmd->scan_end_src = TRIG_COUNT;\r\nerr++;\r\n}\r\nif (cmd->stop_src != TRIG_NONE && cmd->stop_src != TRIG_COUNT)\r\nerr++;\r\nif (err) {\r\n#ifdef PCI171X_EXTDEBUG\r\npci171x_cmdtest_out(2, cmd);\r\n#endif\r\nDPRINTK\r\n("adv_pci1710 EDBG: BGN: pci171x_ai_cmdtest(...) err=%d ret=2\n",\r\nerr);\r\nreturn 2;\r\n}\r\nif (cmd->start_arg != 0) {\r\ncmd->start_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->scan_begin_arg != 0) {\r\ncmd->scan_begin_arg = 0;\r\nerr++;\r\n}\r\nif (cmd->convert_src == TRIG_TIMER) {\r\nif (cmd->convert_arg < this_board->ai_ns_min) {\r\ncmd->convert_arg = this_board->ai_ns_min;\r\nerr++;\r\n}\r\n} else {\r\nif (cmd->convert_arg != 0) {\r\ncmd->convert_arg = 0;\r\nerr++;\r\n}\r\n}\r\nif (cmd->scan_end_arg != cmd->chanlist_len) {\r\ncmd->scan_end_arg = cmd->chanlist_len;\r\nerr++;\r\n}\r\nif (cmd->stop_src == TRIG_COUNT) {\r\nif (!cmd->stop_arg) {\r\ncmd->stop_arg = 1;\r\nerr++;\r\n}\r\n} else {\r\nif (cmd->stop_arg != 0) {\r\ncmd->stop_arg = 0;\r\nerr++;\r\n}\r\n}\r\nif (err) {\r\n#ifdef PCI171X_EXTDEBUG\r\npci171x_cmdtest_out(3, cmd);\r\n#endif\r\nDPRINTK\r\n("adv_pci1710 EDBG: BGN: pci171x_ai_cmdtest(...) err=%d ret=3\n",\r\nerr);\r\nreturn 3;\r\n}\r\nif (cmd->convert_src == TRIG_TIMER) {\r\ntmp = cmd->convert_arg;\r\ni8253_cascade_ns_to_timer(devpriv->i8254_osc_base, &divisor1,\r\n&divisor2, &cmd->convert_arg,\r\ncmd->flags & TRIG_ROUND_MASK);\r\nif (cmd->convert_arg < this_board->ai_ns_min)\r\ncmd->convert_arg = this_board->ai_ns_min;\r\nif (tmp != cmd->convert_arg)\r\nerr++;\r\n}\r\nif (err) {\r\nDPRINTK\r\n("adv_pci1710 EDBG: BGN: pci171x_ai_cmdtest(...) err=%d ret=4\n",\r\nerr);\r\nreturn 4;\r\n}\r\nif (cmd->chanlist) {\r\nif (!check_channel_list(dev, s, cmd->chanlist,\r\ncmd->chanlist_len))\r\nreturn 5;\r\n}\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_ai_cmdtest(...) ret=0\n");\r\nreturn 0;\r\n}\r\nstatic int pci171x_ai_cmd(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nstruct comedi_cmd *cmd = &s->async->cmd;\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_ai_cmd(...)\n");\r\ndevpriv->ai_n_chan = cmd->chanlist_len;\r\ndevpriv->ai_chanlist = cmd->chanlist;\r\ndevpriv->ai_flags = cmd->flags;\r\ndevpriv->ai_data_len = s->async->prealloc_bufsz;\r\ndevpriv->ai_data = s->async->prealloc_buf;\r\ndevpriv->ai_timer1 = 0;\r\ndevpriv->ai_timer2 = 0;\r\nif (cmd->stop_src == TRIG_COUNT)\r\ndevpriv->ai_scans = cmd->stop_arg;\r\nelse\r\ndevpriv->ai_scans = 0;\r\nif (cmd->scan_begin_src == TRIG_FOLLOW) {\r\nif (cmd->convert_src == TRIG_TIMER) {\r\ndevpriv->ai_timer1 = cmd->convert_arg;\r\nreturn pci171x_ai_docmd_and_mode(cmd->start_src ==\r\nTRIG_EXT ? 2 : 1, dev,\r\ns);\r\n}\r\nif (cmd->convert_src == TRIG_EXT) {\r\nreturn pci171x_ai_docmd_and_mode(3, dev, s);\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int check_channel_list(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nunsigned int *chanlist, unsigned int n_chan)\r\n{\r\nunsigned int chansegment[32];\r\nunsigned int i, nowmustbechan, seglen, segpos;\r\nDPRINTK("adv_pci1710 EDBG: check_channel_list(...,%d)\n", n_chan);\r\nif (n_chan < 1) {\r\ncomedi_error(dev, "range/channel list is empty!");\r\nreturn 0;\r\n}\r\nif (n_chan > 1) {\r\nchansegment[0] = chanlist[0];\r\nfor (i = 1, seglen = 1; i < n_chan; i++, seglen++) {\r\nif (chanlist[0] == chanlist[i])\r\nbreak;\r\nif (CR_CHAN(chanlist[i]) & 1)\r\nif (CR_AREF(chanlist[i]) == AREF_DIFF) {\r\ncomedi_error(dev,\r\n"Odd channel can't be differential input!\n");\r\nreturn 0;\r\n}\r\nnowmustbechan =\r\n(CR_CHAN(chansegment[i - 1]) + 1) % s->n_chan;\r\nif (CR_AREF(chansegment[i - 1]) == AREF_DIFF)\r\nnowmustbechan = (nowmustbechan + 1) % s->n_chan;\r\nif (nowmustbechan != CR_CHAN(chanlist[i])) {\r\nprintk\r\n("channel list must be continuous! chanlist[%i]=%d but must be %d or %d!\n",\r\ni, CR_CHAN(chanlist[i]), nowmustbechan,\r\nCR_CHAN(chanlist[0]));\r\nreturn 0;\r\n}\r\nchansegment[i] = chanlist[i];\r\n}\r\nfor (i = 0, segpos = 0; i < n_chan; i++) {\r\nif (chanlist[i] != chansegment[i % seglen]) {\r\nprintk\r\n("bad channel, reference or range number! chanlist[%i]=%d,%d,%d and not %d,%d,%d!\n",\r\ni, CR_CHAN(chansegment[i]),\r\nCR_RANGE(chansegment[i]),\r\nCR_AREF(chansegment[i]),\r\nCR_CHAN(chanlist[i % seglen]),\r\nCR_RANGE(chanlist[i % seglen]),\r\nCR_AREF(chansegment[i % seglen]));\r\nreturn 0;\r\n}\r\n}\r\n} else {\r\nseglen = 1;\r\n}\r\nreturn seglen;\r\n}\r\nstatic void setup_channel_list(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nunsigned int *chanlist, unsigned int n_chan,\r\nunsigned int seglen)\r\n{\r\nunsigned int i, range, chanprog;\r\nDPRINTK("adv_pci1710 EDBG: setup_channel_list(...,%d,%d)\n", n_chan,\r\nseglen);\r\ndevpriv->act_chanlist_len = seglen;\r\ndevpriv->act_chanlist_pos = 0;\r\nDPRINTK("SegLen: %d\n", seglen);\r\nfor (i = 0; i < seglen; i++) {\r\nchanprog = muxonechan[CR_CHAN(chanlist[i])];\r\noutw(chanprog, dev->iobase + PCI171x_MUX);\r\nrange = this_board->rangecode_ai[CR_RANGE(chanlist[i])];\r\nif (CR_AREF(chanlist[i]) == AREF_DIFF)\r\nrange |= 0x0020;\r\noutw(range, dev->iobase + PCI171x_RANGE);\r\n#ifdef PCI171x_PARANOIDCHECK\r\ndevpriv->act_chanlist[i] =\r\n(CR_CHAN(chanlist[i]) << 12) & 0xf000;\r\n#endif\r\nDPRINTK("GS: %2d. [%4x]=%4x %4x\n", i, chanprog, range,\r\ndevpriv->act_chanlist[i]);\r\n}\r\n#ifdef PCI171x_PARANOIDCHECK\r\nfor ( ; i < n_chan; i++) {\r\ndevpriv->act_chanlist[i] =\r\n(CR_CHAN(chanlist[i]) << 12) & 0xf000;\r\n}\r\n#endif\r\ndevpriv->ai_et_MuxVal =\r\nCR_CHAN(chanlist[0]) | (CR_CHAN(chanlist[seglen - 1]) << 8);\r\noutw(devpriv->ai_et_MuxVal, dev->iobase + PCI171x_MUX);\r\nDPRINTK("MUX: %4x L%4x.H%4x\n",\r\nCR_CHAN(chanlist[0]) | (CR_CHAN(chanlist[seglen - 1]) << 8),\r\nCR_CHAN(chanlist[0]), CR_CHAN(chanlist[seglen - 1]));\r\n}\r\nstatic void start_pacer(struct comedi_device *dev, int mode,\r\nunsigned int divisor1, unsigned int divisor2)\r\n{\r\nDPRINTK("adv_pci1710 EDBG: BGN: start_pacer(%d,%u,%u)\n", mode,\r\ndivisor1, divisor2);\r\noutw(0xb4, dev->iobase + PCI171x_CNTCTRL);\r\noutw(0x74, dev->iobase + PCI171x_CNTCTRL);\r\nif (mode == 1) {\r\noutw(divisor2 & 0xff, dev->iobase + PCI171x_CNT2);\r\noutw((divisor2 >> 8) & 0xff, dev->iobase + PCI171x_CNT2);\r\noutw(divisor1 & 0xff, dev->iobase + PCI171x_CNT1);\r\noutw((divisor1 >> 8) & 0xff, dev->iobase + PCI171x_CNT1);\r\n}\r\nDPRINTK("adv_pci1710 EDBG: END: start_pacer(...)\n");\r\n}\r\nstatic int pci171x_ai_cancel(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_ai_cancel(...)\n");\r\nswitch (this_board->cardtype) {\r\ndefault:\r\ndevpriv->CntrlReg &= Control_CNT0;\r\ndevpriv->CntrlReg |= Control_SW;\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\nstart_pacer(dev, -1, 0, 0);\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nbreak;\r\n}\r\ndevpriv->ai_do = 0;\r\ndevpriv->ai_act_scan = 0;\r\ns->async->cur_chan = 0;\r\ndevpriv->ai_buf_ptr = 0;\r\ndevpriv->neverending_ai = 0;\r\nDPRINTK("adv_pci1710 EDBG: END: pci171x_ai_cancel(...)\n");\r\nreturn 0;\r\n}\r\nstatic int pci171x_reset(struct comedi_device *dev)\r\n{\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci171x_reset(...)\n");\r\noutw(0x30, dev->iobase + PCI171x_CNTCTRL);\r\ndevpriv->CntrlReg = Control_SW | Control_CNT0;\r\noutw(devpriv->CntrlReg, dev->iobase + PCI171x_CONTROL);\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nstart_pacer(dev, -1, 0, 0);\r\ndevpriv->da_ranges = 0;\r\nif (this_board->n_aochan) {\r\noutb(devpriv->da_ranges, dev->iobase + PCI171x_DAREF);\r\noutw(0, dev->iobase + PCI171x_DA1);\r\ndevpriv->ao_data[0] = 0x0000;\r\nif (this_board->n_aochan > 1) {\r\noutw(0, dev->iobase + PCI171x_DA2);\r\ndevpriv->ao_data[1] = 0x0000;\r\n}\r\n}\r\noutw(0, dev->iobase + PCI171x_DO);\r\noutb(0, dev->iobase + PCI171x_CLRFIFO);\r\noutb(0, dev->iobase + PCI171x_CLRINT);\r\nDPRINTK("adv_pci1710 EDBG: END: pci171x_reset(...)\n");\r\nreturn 0;\r\n}\r\nstatic int pci1720_reset(struct comedi_device *dev)\r\n{\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci1720_reset(...)\n");\r\noutb(Syncont_SC0, dev->iobase + PCI1720_SYNCONT);\r\ndevpriv->da_ranges = 0xAA;\r\noutb(devpriv->da_ranges, dev->iobase + PCI1720_RANGE);\r\noutw(0x0800, dev->iobase + PCI1720_DA0);\r\noutw(0x0800, dev->iobase + PCI1720_DA1);\r\noutw(0x0800, dev->iobase + PCI1720_DA2);\r\noutw(0x0800, dev->iobase + PCI1720_DA3);\r\noutb(0, dev->iobase + PCI1720_SYNCOUT);\r\ndevpriv->ao_data[0] = 0x0800;\r\ndevpriv->ao_data[1] = 0x0800;\r\ndevpriv->ao_data[2] = 0x0800;\r\ndevpriv->ao_data[3] = 0x0800;\r\nDPRINTK("adv_pci1710 EDBG: END: pci1720_reset(...)\n");\r\nreturn 0;\r\n}\r\nstatic int pci1710_reset(struct comedi_device *dev)\r\n{\r\nDPRINTK("adv_pci1710 EDBG: BGN: pci1710_reset(...)\n");\r\nswitch (this_board->cardtype) {\r\ncase TYPE_PCI1720:\r\nreturn pci1720_reset(dev);\r\ndefault:\r\nreturn pci171x_reset(dev);\r\n}\r\nDPRINTK("adv_pci1710 EDBG: END: pci1710_reset(...)\n");\r\n}\r\nstatic int pci1710_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret, subdev, n_subdevices;\r\nunsigned int irq;\r\nunsigned long iobase;\r\nstruct pci_dev *pcidev;\r\nint opt_bus, opt_slot;\r\nconst char *errstr;\r\nunsigned char pci_bus, pci_slot, pci_func;\r\nint i;\r\nint board_index;\r\ndev_info(dev->hw_dev, "comedi%d: adv_pci1710:\n", dev->minor);\r\nopt_bus = it->options[0];\r\nopt_slot = it->options[1];\r\nret = alloc_private(dev, sizeof(struct pci1710_private));\r\nif (ret < 0)\r\nreturn -ENOMEM;\r\nerrstr = "not found!";\r\npcidev = NULL;\r\nboard_index = this_board - boardtypes;\r\nwhile (NULL != (pcidev = pci_get_device(PCI_VENDOR_ID_ADVANTECH,\r\nPCI_ANY_ID, pcidev))) {\r\nif (strcmp(this_board->name, DRV_NAME) == 0) {\r\nfor (i = 0; i < n_boardtypes; ++i) {\r\nif (pcidev->device == boardtypes[i].device_id) {\r\nboard_index = i;\r\nbreak;\r\n}\r\n}\r\nif (i == n_boardtypes)\r\ncontinue;\r\n} else {\r\nif (pcidev->device != boardtypes[board_index].device_id)\r\ncontinue;\r\n}\r\nif (opt_bus || opt_slot) {\r\nif (opt_bus != pcidev->bus->number\r\n|| opt_slot != PCI_SLOT(pcidev->devfn))\r\ncontinue;\r\n}\r\nif (comedi_pci_enable(pcidev, DRV_NAME)) {\r\nerrstr =\r\n"failed to enable PCI device and request regions!";\r\ncontinue;\r\n}\r\ndev->board_ptr = &boardtypes[board_index];\r\nbreak;\r\n}\r\nif (!pcidev) {\r\nif (opt_bus || opt_slot) {\r\ndev_err(dev->hw_dev, "- Card at b:s %d:%d %s\n",\r\nopt_bus, opt_slot, errstr);\r\n} else {\r\ndev_err(dev->hw_dev, "- Card %s\n", errstr);\r\n}\r\nreturn -EIO;\r\n}\r\npci_bus = pcidev->bus->number;\r\npci_slot = PCI_SLOT(pcidev->devfn);\r\npci_func = PCI_FUNC(pcidev->devfn);\r\nirq = pcidev->irq;\r\niobase = pci_resource_start(pcidev, 2);\r\ndev_dbg(dev->hw_dev, "b:s:f=%d:%d:%d, io=0x%4lx\n", pci_bus, pci_slot,\r\npci_func, iobase);\r\ndev->iobase = iobase;\r\ndev->board_name = this_board->name;\r\ndevpriv->pcidev = pcidev;\r\nn_subdevices = 0;\r\nif (this_board->n_aichan)\r\nn_subdevices++;\r\nif (this_board->n_aochan)\r\nn_subdevices++;\r\nif (this_board->n_dichan)\r\nn_subdevices++;\r\nif (this_board->n_dochan)\r\nn_subdevices++;\r\nif (this_board->n_counter)\r\nn_subdevices++;\r\nret = alloc_subdevices(dev, n_subdevices);\r\nif (ret < 0)\r\nreturn ret;\r\npci1710_reset(dev);\r\nif (this_board->have_irq) {\r\nif (irq) {\r\nif (request_irq(irq, interrupt_service_pci1710,\r\nIRQF_SHARED, "Advantech PCI-1710",\r\ndev)) {\r\ndev_dbg(dev->hw_dev, "unable to allocate IRQ %d, DISABLING IT",\r\nirq);\r\nirq = 0;\r\n} else {\r\ndev_dbg(dev->hw_dev, "irq=%u", irq);\r\n}\r\n} else {\r\ndev_dbg(dev->hw_dev, "IRQ disabled");\r\n}\r\n} else {\r\nirq = 0;\r\n}\r\ndev->irq = irq;\r\nsubdev = 0;\r\nif (this_board->n_aichan) {\r\ns = dev->subdevices + subdev;\r\ndev->read_subdev = s;\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_COMMON | SDF_GROUND;\r\nif (this_board->n_aichand)\r\ns->subdev_flags |= SDF_DIFF;\r\ns->n_chan = this_board->n_aichan;\r\ns->maxdata = this_board->ai_maxdata;\r\ns->len_chanlist = this_board->n_aichan;\r\ns->range_table = this_board->rangelist_ai;\r\ns->cancel = pci171x_ai_cancel;\r\ns->insn_read = pci171x_insn_read_ai;\r\nif (irq) {\r\ns->subdev_flags |= SDF_CMD_READ;\r\ns->do_cmdtest = pci171x_ai_cmdtest;\r\ns->do_cmd = pci171x_ai_cmd;\r\n}\r\ndevpriv->i8254_osc_base = 100;\r\nsubdev++;\r\n}\r\nif (this_board->n_aochan) {\r\ns = dev->subdevices + subdev;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = this_board->n_aochan;\r\ns->maxdata = this_board->ao_maxdata;\r\ns->len_chanlist = this_board->n_aochan;\r\ns->range_table = this_board->rangelist_ao;\r\nswitch (this_board->cardtype) {\r\ncase TYPE_PCI1720:\r\ns->insn_write = pci1720_insn_write_ao;\r\nbreak;\r\ndefault:\r\ns->insn_write = pci171x_insn_write_ao;\r\nbreak;\r\n}\r\ns->insn_read = pci171x_insn_read_ao;\r\nsubdev++;\r\n}\r\nif (this_board->n_dichan) {\r\ns = dev->subdevices + subdev;\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = this_board->n_dichan;\r\ns->maxdata = 1;\r\ns->len_chanlist = this_board->n_dichan;\r\ns->range_table = &range_digital;\r\ns->io_bits = 0;\r\ns->insn_bits = pci171x_insn_bits_di;\r\nsubdev++;\r\n}\r\nif (this_board->n_dochan) {\r\ns = dev->subdevices + subdev;\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = this_board->n_dochan;\r\ns->maxdata = 1;\r\ns->len_chanlist = this_board->n_dochan;\r\ns->range_table = &range_digital;\r\ns->io_bits = (1 << this_board->n_dochan) - 1;\r\ns->state = 0;\r\ns->insn_bits = pci171x_insn_bits_do;\r\nsubdev++;\r\n}\r\nif (this_board->n_counter) {\r\ns = dev->subdevices + subdev;\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = this_board->n_counter;\r\ns->len_chanlist = this_board->n_counter;\r\ns->maxdata = 0xffff;\r\ns->range_table = &range_unknown;\r\ns->insn_read = pci171x_insn_counter_read;\r\ns->insn_write = pci171x_insn_counter_write;\r\ns->insn_config = pci171x_insn_counter_config;\r\nsubdev++;\r\n}\r\ndevpriv->valid = 1;\r\nreturn 0;\r\n}\r\nstatic int pci1710_detach(struct comedi_device *dev)\r\n{\r\nif (dev->private) {\r\nif (devpriv->valid)\r\npci1710_reset(dev);\r\nif (dev->irq)\r\nfree_irq(dev->irq, dev);\r\nif (devpriv->pcidev) {\r\nif (dev->iobase)\r\ncomedi_pci_disable(devpriv->pcidev);\r\npci_dev_put(devpriv->pcidev);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit driver_pci1710_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_pci1710.driver_name);\r\n}\r\nstatic void __devexit driver_pci1710_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_pci1710_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_pci1710);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_pci1710_pci_driver.name = (char *)driver_pci1710.driver_name;\r\nreturn pci_register_driver(&driver_pci1710_pci_driver);\r\n}\r\nstatic void __exit driver_pci1710_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_pci1710_pci_driver);\r\ncomedi_driver_unregister(&driver_pci1710);\r\n}

static int poc_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nunsigned long iobase;\r\nunsigned int iosize;\r\niobase = it->options[0];\r\nprintk(KERN_INFO "comedi%d: poc: using %s iobase 0x%lx\n", dev->minor,\r\nthis_board->name, iobase);\r\ndev->board_name = this_board->name;\r\nif (iobase == 0) {\r\nprintk(KERN_ERR "io base address required\n");\r\nreturn -EINVAL;\r\n}\r\niosize = this_board->iosize;\r\nif (!request_region(iobase, iosize, "dac02")) {\r\nprintk(KERN_ERR "I/O port conflict: failed to allocate ports "\r\n"0x%lx to 0x%lx\n", iobase, iobase + iosize - 1);\r\nreturn -EIO;\r\n}\r\ndev->iobase = iobase;\r\nif (alloc_subdevices(dev, 1) < 0)\r\nreturn -ENOMEM;\r\nif (alloc_private(dev, sizeof(unsigned int) * this_board->n_chan) < 0)\r\nreturn -ENOMEM;\r\ns = dev->subdevices + 0;\r\ns->type = this_board->type;\r\ns->n_chan = this_board->n_chan;\r\ns->maxdata = (1 << this_board->n_bits) - 1;\r\ns->range_table = this_board->range;\r\ns->insn_write = this_board->winsn;\r\ns->insn_read = this_board->rinsn;\r\ns->insn_bits = this_board->insnbits;\r\nif (s->type == COMEDI_SUBD_AO || s->type == COMEDI_SUBD_DO)\r\ns->subdev_flags = SDF_WRITABLE;\r\nreturn 0;\r\n}\r\nstatic int poc_detach(struct comedi_device *dev)\r\n{\r\nif (dev->iobase)\r\nrelease_region(dev->iobase, this_board->iosize);\r\nprintk(KERN_INFO "comedi%d: dac02: remove\n", dev->minor);\r\nreturn 0;\r\n}\r\nstatic int readback_insn(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint chan;\r\nchan = CR_CHAN(insn->chanspec);\r\ndata[0] = ((unsigned int *)dev->private)[chan];\r\nreturn 1;\r\n}\r\nstatic int dac02_ao_winsn(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint temp;\r\nint chan;\r\nint output;\r\nchan = CR_CHAN(insn->chanspec);\r\n((unsigned int *)dev->private)[chan] = data[0];\r\noutput = data[0];\r\n#ifdef wrong\r\nif ((CR_RANGE(insn->chanspec) & 0x2) == 0)\r\noutput = ~output;\r\n#endif\r\ntemp = (output << 4) & 0xf0;\r\noutb(temp, dev->iobase + DAC02_LSB(chan));\r\ntemp = (output >> 4) & 0xff;\r\noutb(temp, dev->iobase + DAC02_MSB(chan));\r\nreturn 1;\r\n}\r\nstatic int pcl733_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n != 2)\r\nreturn -EINVAL;\r\ndata[1] = inb(dev->iobase + 0);\r\ndata[1] |= (inb(dev->iobase + 1) << 8);\r\ndata[1] |= (inb(dev->iobase + 2) << 16);\r\ndata[1] |= (inb(dev->iobase + 3) << 24);\r\nreturn 2;\r\n}\r\nstatic int pcl734_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (insn->n != 2)\r\nreturn -EINVAL;\r\nif (data[0]) {\r\ns->state &= ~data[0];\r\ns->state |= (data[0] & data[1]);\r\nif ((data[0] >> 0) & 0xff)\r\noutb((s->state >> 0) & 0xff, dev->iobase + 0);\r\nif ((data[0] >> 8) & 0xff)\r\noutb((s->state >> 8) & 0xff, dev->iobase + 1);\r\nif ((data[0] >> 16) & 0xff)\r\noutb((s->state >> 16) & 0xff, dev->iobase + 2);\r\nif ((data[0] >> 24) & 0xff)\r\noutb((s->state >> 24) & 0xff, dev->iobase + 3);\r\n}\r\ndata[1] = s->state;\r\nreturn 2;\r\n}\r\nstatic int __init driver_poc_init_module(void)\r\n{\r\nreturn comedi_driver_register(&driver_poc);\r\n}\r\nstatic void __exit driver_poc_cleanup_module(void)\r\n{\r\ncomedi_driver_unregister(&driver_poc);\r\n}

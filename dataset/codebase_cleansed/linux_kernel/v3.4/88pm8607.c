static int pm8607_list_voltage(struct regulator_dev *rdev, unsigned index)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret = -EINVAL;\r\nif (info->vol_table && (index < (1 << info->vol_nbits))) {\r\nret = info->vol_table[index];\r\nif (info->slope_double)\r\nret <<= 1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int choose_voltage(struct regulator_dev *rdev, int min_uV, int max_uV)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nint i, ret = -ENOENT;\r\nif (info->slope_double) {\r\nmin_uV = min_uV >> 1;\r\nmax_uV = max_uV >> 1;\r\n}\r\nif (info->vol_table) {\r\nfor (i = 0; i < (1 << info->vol_nbits); i++) {\r\nif (!info->vol_table[i])\r\nbreak;\r\nif ((min_uV <= info->vol_table[i])\r\n&& (max_uV >= info->vol_table[i])) {\r\nret = i;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (ret < 0)\r\npr_err("invalid voltage range (%d %d) uV\n", min_uV, max_uV);\r\nreturn ret;\r\n}\r\nstatic int pm8607_set_voltage(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nif (min_uV > max_uV) {\r\npr_err("invalid voltage range (%d, %d) uV\n", min_uV, max_uV);\r\nreturn -EINVAL;\r\n}\r\nret = choose_voltage(rdev, min_uV, max_uV);\r\nif (ret < 0)\r\nreturn -EINVAL;\r\n*selector = ret;\r\nval = (uint8_t)(ret << info->vol_shift);\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nret = pm860x_set_bits(info->i2c, info->vol_reg, mask, val);\r\nif (ret)\r\nreturn ret;\r\nswitch (info->desc.id) {\r\ncase PM8607_ID_BUCK1:\r\ncase PM8607_ID_BUCK3:\r\nret = pm860x_set_bits(info->i2c, info->update_reg,\r\n1 << info->update_bit,\r\n1 << info->update_bit);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int pm8607_get_voltage(struct regulator_dev *rdev)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nuint8_t val, mask;\r\nint ret;\r\nret = pm860x_reg_read(info->i2c, info->vol_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nmask = ((1 << info->vol_nbits) - 1) << info->vol_shift;\r\nval = ((unsigned char)ret & mask) >> info->vol_shift;\r\nreturn pm8607_list_voltage(rdev, val);\r\n}\r\nstatic int pm8607_enable(struct regulator_dev *rdev)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn pm860x_set_bits(info->i2c, info->enable_reg,\r\n1 << info->enable_bit,\r\n1 << info->enable_bit);\r\n}\r\nstatic int pm8607_disable(struct regulator_dev *rdev)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn pm860x_set_bits(info->i2c, info->enable_reg,\r\n1 << info->enable_bit, 0);\r\n}\r\nstatic int pm8607_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct pm8607_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = pm860x_reg_read(info->i2c, info->enable_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !!((unsigned char)ret & (1 << info->enable_bit));\r\n}\r\nstatic int __devinit pm8607_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm8607_regulator_info *info = NULL;\r\nstruct regulator_init_data *pdata = pdev->dev.platform_data;\r\nstruct resource *res;\r\nint i;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (res == NULL) {\r\ndev_err(&pdev->dev, "No I/O resource!\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pm8607_regulator_info); i++) {\r\ninfo = &pm8607_regulator_info[i];\r\nif (info->desc.id == res->start)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(pm8607_regulator_info)) {\r\ndev_err(&pdev->dev, "Failed to find regulator %llu\n",\r\n(unsigned long long)res->start);\r\nreturn -EINVAL;\r\n}\r\ninfo->i2c = (chip->id == CHIP_PM8607) ? chip->client : chip->companion;\r\ninfo->chip = chip;\r\nif ((i == PM8607_ID_BUCK3) && info->chip->buck3_double)\r\ninfo->slope_double = 1;\r\ninfo->regulator = regulator_register(&info->desc, &pdev->dev,\r\npdata, info, NULL);\r\nif (IS_ERR(info->regulator)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\ninfo->desc.name);\r\nreturn PTR_ERR(info->regulator);\r\n}\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\n}\r\nstatic int __devexit pm8607_regulator_remove(struct platform_device *pdev)\r\n{\r\nstruct pm8607_regulator_info *info = platform_get_drvdata(pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nregulator_unregister(info->regulator);\r\nreturn 0;\r\n}\r\nstatic int __init pm8607_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&pm8607_regulator_driver);\r\n}\r\nstatic void __exit pm8607_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&pm8607_regulator_driver);\r\n}

static inline int bfin_kpad_find_key(struct bf54x_kpad *bf54x_kpad,\r\nstruct input_dev *input, u16 keyident)\r\n{\r\nu16 i;\r\nfor (i = 0; i < input->keycodemax; i++)\r\nif (bf54x_kpad->keycode[i + input->keycodemax] == keyident)\r\nreturn bf54x_kpad->keycode[i];\r\nreturn -1;\r\n}\r\nstatic inline void bfin_keycodecpy(unsigned short *keycode,\r\nconst unsigned int *pdata_kc,\r\nunsigned short keymapsize)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < keymapsize; i++) {\r\nkeycode[i] = pdata_kc[i] & 0xffff;\r\nkeycode[i + keymapsize] = pdata_kc[i] >> 16;\r\n}\r\n}\r\nstatic inline u16 bfin_kpad_get_prescale(u32 timescale)\r\n{\r\nu32 sclk = get_sclk();\r\nreturn ((((sclk / 1000) * timescale) / 1024) - 1);\r\n}\r\nstatic inline u16 bfin_kpad_get_keypressed(struct bf54x_kpad *bf54x_kpad)\r\n{\r\nreturn (bfin_read_KPAD_STAT() & KPAD_PRESSED);\r\n}\r\nstatic inline void bfin_kpad_clear_irq(void)\r\n{\r\nbfin_write_KPAD_STAT(0xFFFF);\r\nbfin_write_KPAD_ROWCOL(0xFFFF);\r\n}\r\nstatic void bfin_kpad_timer(unsigned long data)\r\n{\r\nstruct platform_device *pdev = (struct platform_device *) data;\r\nstruct bf54x_kpad *bf54x_kpad = platform_get_drvdata(pdev);\r\nif (bfin_kpad_get_keypressed(bf54x_kpad)) {\r\nmod_timer(&bf54x_kpad->timer,\r\njiffies + bf54x_kpad->keyup_test_jiffies);\r\nreturn;\r\n}\r\ninput_report_key(bf54x_kpad->input, bf54x_kpad->lastkey, 0);\r\ninput_sync(bf54x_kpad->input);\r\nbfin_kpad_clear_irq();\r\nenable_irq(bf54x_kpad->irq);\r\n}\r\nstatic irqreturn_t bfin_kpad_isr(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct bf54x_kpad *bf54x_kpad = platform_get_drvdata(pdev);\r\nstruct input_dev *input = bf54x_kpad->input;\r\nint key;\r\nu16 rowcol = bfin_read_KPAD_ROWCOL();\r\nkey = bfin_kpad_find_key(bf54x_kpad, input, rowcol);\r\ninput_report_key(input, key, 1);\r\ninput_sync(input);\r\nif (bfin_kpad_get_keypressed(bf54x_kpad)) {\r\ndisable_irq_nosync(bf54x_kpad->irq);\r\nbf54x_kpad->lastkey = key;\r\nmod_timer(&bf54x_kpad->timer,\r\njiffies + bf54x_kpad->keyup_test_jiffies);\r\n} else {\r\ninput_report_key(input, key, 0);\r\ninput_sync(input);\r\nbfin_kpad_clear_irq();\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit bfin_kpad_probe(struct platform_device *pdev)\r\n{\r\nstruct bf54x_kpad *bf54x_kpad;\r\nstruct bfin_kpad_platform_data *pdata = pdev->dev.platform_data;\r\nstruct input_dev *input;\r\nint i, error;\r\nif (!pdata->rows || !pdata->cols || !pdata->keymap) {\r\ndev_err(&pdev->dev, "no rows, cols or keymap from pdata\n");\r\nreturn -EINVAL;\r\n}\r\nif (!pdata->keymapsize ||\r\npdata->keymapsize > (pdata->rows * pdata->cols)) {\r\ndev_err(&pdev->dev, "invalid keymapsize\n");\r\nreturn -EINVAL;\r\n}\r\nbf54x_kpad = kzalloc(sizeof(struct bf54x_kpad), GFP_KERNEL);\r\nif (!bf54x_kpad)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, bf54x_kpad);\r\nbf54x_kpad->keycode = kmalloc(pdata->keymapsize *\r\nsizeof(unsigned short) * 2, GFP_KERNEL);\r\nif (!bf54x_kpad->keycode) {\r\nerror = -ENOMEM;\r\ngoto out;\r\n}\r\nif (!pdata->debounce_time || pdata->debounce_time > MAX_MULT ||\r\n!pdata->coldrive_time || pdata->coldrive_time > MAX_MULT) {\r\ndev_warn(&pdev->dev,\r\n"invalid platform debounce/columndrive time\n");\r\nbfin_write_KPAD_MSEL(0xFF0);\r\n} else {\r\nbfin_write_KPAD_MSEL(\r\n((pdata->debounce_time / TIME_SCALE)\r\n& DBON_SCALE) |\r\n(((pdata->coldrive_time / TIME_SCALE) << 8)\r\n& COLDRV_SCALE));\r\n}\r\nif (!pdata->keyup_test_interval)\r\nbf54x_kpad->keyup_test_jiffies = msecs_to_jiffies(50);\r\nelse\r\nbf54x_kpad->keyup_test_jiffies =\r\nmsecs_to_jiffies(pdata->keyup_test_interval);\r\nif (peripheral_request_list((u16 *)&per_rows[MAX_RC - pdata->rows],\r\nDRV_NAME)) {\r\ndev_err(&pdev->dev, "requesting peripherals failed\n");\r\nerror = -EFAULT;\r\ngoto out0;\r\n}\r\nif (peripheral_request_list((u16 *)&per_cols[MAX_RC - pdata->cols],\r\nDRV_NAME)) {\r\ndev_err(&pdev->dev, "requesting peripherals failed\n");\r\nerror = -EFAULT;\r\ngoto out1;\r\n}\r\nbf54x_kpad->irq = platform_get_irq(pdev, 0);\r\nif (bf54x_kpad->irq < 0) {\r\nerror = -ENODEV;\r\ngoto out2;\r\n}\r\nerror = request_irq(bf54x_kpad->irq, bfin_kpad_isr,\r\n0, DRV_NAME, pdev);\r\nif (error) {\r\ndev_err(&pdev->dev, "unable to claim irq %d\n",\r\nbf54x_kpad->irq);\r\ngoto out2;\r\n}\r\ninput = input_allocate_device();\r\nif (!input) {\r\nerror = -ENOMEM;\r\ngoto out3;\r\n}\r\nbf54x_kpad->input = input;\r\ninput->name = pdev->name;\r\ninput->phys = "bf54x-keys/input0";\r\ninput->dev.parent = &pdev->dev;\r\ninput_set_drvdata(input, bf54x_kpad);\r\ninput->id.bustype = BUS_HOST;\r\ninput->id.vendor = 0x0001;\r\ninput->id.product = 0x0001;\r\ninput->id.version = 0x0100;\r\ninput->keycodesize = sizeof(unsigned short);\r\ninput->keycodemax = pdata->keymapsize;\r\ninput->keycode = bf54x_kpad->keycode;\r\nbfin_keycodecpy(bf54x_kpad->keycode, pdata->keymap, pdata->keymapsize);\r\n__set_bit(EV_KEY, input->evbit);\r\nif (pdata->repeat)\r\n__set_bit(EV_REP, input->evbit);\r\nfor (i = 0; i < input->keycodemax; i++)\r\n__set_bit(bf54x_kpad->keycode[i] & KEY_MAX, input->keybit);\r\n__clear_bit(KEY_RESERVED, input->keybit);\r\nerror = input_register_device(input);\r\nif (error) {\r\ndev_err(&pdev->dev, "unable to register input device\n");\r\ngoto out4;\r\n}\r\nsetup_timer(&bf54x_kpad->timer, bfin_kpad_timer, (unsigned long) pdev);\r\nbfin_write_KPAD_PRESCALE(bfin_kpad_get_prescale(TIME_SCALE));\r\nbfin_write_KPAD_CTL((((pdata->cols - 1) << 13) & KPAD_COLEN) |\r\n(((pdata->rows - 1) << 10) & KPAD_ROWEN) |\r\n(2 & KPAD_IRQMODE));\r\nbfin_write_KPAD_CTL(bfin_read_KPAD_CTL() | KPAD_EN);\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nreturn 0;\r\nout4:\r\ninput_free_device(input);\r\nout3:\r\nfree_irq(bf54x_kpad->irq, pdev);\r\nout2:\r\nperipheral_free_list((u16 *)&per_cols[MAX_RC - pdata->cols]);\r\nout1:\r\nperipheral_free_list((u16 *)&per_rows[MAX_RC - pdata->rows]);\r\nout0:\r\nkfree(bf54x_kpad->keycode);\r\nout:\r\nkfree(bf54x_kpad);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn error;\r\n}\r\nstatic int __devexit bfin_kpad_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_kpad_platform_data *pdata = pdev->dev.platform_data;\r\nstruct bf54x_kpad *bf54x_kpad = platform_get_drvdata(pdev);\r\ndel_timer_sync(&bf54x_kpad->timer);\r\nfree_irq(bf54x_kpad->irq, pdev);\r\ninput_unregister_device(bf54x_kpad->input);\r\nperipheral_free_list((u16 *)&per_rows[MAX_RC - pdata->rows]);\r\nperipheral_free_list((u16 *)&per_cols[MAX_RC - pdata->cols]);\r\nkfree(bf54x_kpad->keycode);\r\nkfree(bf54x_kpad);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int bfin_kpad_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct bf54x_kpad *bf54x_kpad = platform_get_drvdata(pdev);\r\nbf54x_kpad->kpad_msel = bfin_read_KPAD_MSEL();\r\nbf54x_kpad->kpad_prescale = bfin_read_KPAD_PRESCALE();\r\nbf54x_kpad->kpad_ctl = bfin_read_KPAD_CTL();\r\nif (device_may_wakeup(&pdev->dev))\r\nenable_irq_wake(bf54x_kpad->irq);\r\nreturn 0;\r\n}\r\nstatic int bfin_kpad_resume(struct platform_device *pdev)\r\n{\r\nstruct bf54x_kpad *bf54x_kpad = platform_get_drvdata(pdev);\r\nbfin_write_KPAD_MSEL(bf54x_kpad->kpad_msel);\r\nbfin_write_KPAD_PRESCALE(bf54x_kpad->kpad_prescale);\r\nbfin_write_KPAD_CTL(bf54x_kpad->kpad_ctl);\r\nif (device_may_wakeup(&pdev->dev))\r\ndisable_irq_wake(bf54x_kpad->irq);\r\nreturn 0;\r\n}

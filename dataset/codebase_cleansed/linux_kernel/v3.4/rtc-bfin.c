static inline u32 rtc_time_to_bfin(unsigned long now)\r\n{\r\nu32 sec = (now % 60);\r\nu32 min = (now % (60 * 60)) / 60;\r\nu32 hour = (now % (60 * 60 * 24)) / (60 * 60);\r\nu32 days = (now / (60 * 60 * 24));\r\nreturn (sec << SEC_BITS_OFF) +\r\n(min << MIN_BITS_OFF) +\r\n(hour << HOUR_BITS_OFF) +\r\n(days << DAY_BITS_OFF);\r\n}\r\nstatic inline unsigned long rtc_bfin_to_time(u32 rtc_bfin)\r\n{\r\nreturn (((rtc_bfin >> SEC_BITS_OFF) & 0x003F)) +\r\n(((rtc_bfin >> MIN_BITS_OFF) & 0x003F) * 60) +\r\n(((rtc_bfin >> HOUR_BITS_OFF) & 0x001F) * 60 * 60) +\r\n(((rtc_bfin >> DAY_BITS_OFF) & 0x7FFF) * 60 * 60 * 24);\r\n}\r\nstatic inline void rtc_bfin_to_tm(u32 rtc_bfin, struct rtc_time *tm)\r\n{\r\nrtc_time_to_tm(rtc_bfin_to_time(rtc_bfin), tm);\r\n}\r\nstatic void bfin_rtc_sync_pending(struct device *dev)\r\n{\r\ndev_dbg_stamp(dev);\r\nwhile (bfin_read_RTC_ISTAT() & RTC_ISTAT_WRITE_PENDING)\r\nwait_for_completion_timeout(&bfin_write_complete, HZ * 5);\r\ndev_dbg_stamp(dev);\r\n}\r\nstatic void bfin_rtc_reset(struct device *dev, u16 rtc_ictl)\r\n{\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\ndev_dbg_stamp(dev);\r\nbfin_rtc_sync_pending(dev);\r\nbfin_write_RTC_PREN(0x1);\r\nbfin_write_RTC_ICTL(rtc_ictl);\r\nbfin_write_RTC_ALARM(0);\r\nbfin_write_RTC_ISTAT(0xFFFF);\r\nrtc->rtc_wrote_regs = 0;\r\n}\r\nstatic irqreturn_t bfin_rtc_interrupt(int irq, void *dev_id)\r\n{\r\nstruct device *dev = dev_id;\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long events = 0;\r\nbool write_complete = false;\r\nu16 rtc_istat, rtc_istat_clear, rtc_ictl, bits;\r\ndev_dbg_stamp(dev);\r\nrtc_istat = bfin_read_RTC_ISTAT();\r\nrtc_ictl = bfin_read_RTC_ICTL();\r\nrtc_istat_clear = 0;\r\nbits = RTC_ISTAT_WRITE_COMPLETE;\r\nif (rtc_istat & bits) {\r\nrtc_istat_clear |= bits;\r\nwrite_complete = true;\r\ncomplete(&bfin_write_complete);\r\n}\r\nbits = (RTC_ISTAT_ALARM | RTC_ISTAT_ALARM_DAY);\r\nif (rtc_ictl & bits) {\r\nif (rtc_istat & bits) {\r\nrtc_istat_clear |= bits;\r\nevents |= RTC_AF | RTC_IRQF;\r\n}\r\n}\r\nbits = RTC_ISTAT_SEC;\r\nif (rtc_ictl & bits) {\r\nif (rtc_istat & bits) {\r\nrtc_istat_clear |= bits;\r\nevents |= RTC_UF | RTC_IRQF;\r\n}\r\n}\r\nif (events)\r\nrtc_update_irq(rtc->rtc_dev, 1, events);\r\nif (write_complete || events) {\r\nbfin_write_RTC_ISTAT(rtc_istat_clear);\r\nreturn IRQ_HANDLED;\r\n} else\r\nreturn IRQ_NONE;\r\n}\r\nstatic void bfin_rtc_int_set(u16 rtc_int)\r\n{\r\nbfin_write_RTC_ISTAT(rtc_int);\r\nbfin_write_RTC_ICTL(bfin_read_RTC_ICTL() | rtc_int);\r\n}\r\nstatic void bfin_rtc_int_clear(u16 rtc_int)\r\n{\r\nbfin_write_RTC_ICTL(bfin_read_RTC_ICTL() & rtc_int);\r\n}\r\nstatic void bfin_rtc_int_set_alarm(struct bfin_rtc *rtc)\r\n{\r\nbfin_rtc_int_set(rtc->rtc_alarm.tm_yday == -1 ? RTC_ISTAT_ALARM : RTC_ISTAT_ALARM_DAY);\r\n}\r\nstatic int bfin_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\ndev_dbg_stamp(dev);\r\nif (enabled)\r\nbfin_rtc_int_set_alarm(rtc);\r\nelse\r\nbfin_rtc_int_clear(~(RTC_ISTAT_ALARM | RTC_ISTAT_ALARM_DAY));\r\nreturn 0;\r\n}\r\nstatic int bfin_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\ndev_dbg_stamp(dev);\r\nif (rtc->rtc_wrote_regs & 0x1)\r\nbfin_rtc_sync_pending(dev);\r\nrtc_bfin_to_tm(bfin_read_RTC_STAT(), tm);\r\nreturn 0;\r\n}\r\nstatic int bfin_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\nint ret;\r\nunsigned long now;\r\ndev_dbg_stamp(dev);\r\nret = rtc_tm_to_time(tm, &now);\r\nif (ret == 0) {\r\nif (rtc->rtc_wrote_regs & 0x1)\r\nbfin_rtc_sync_pending(dev);\r\nbfin_write_RTC_STAT(rtc_time_to_bfin(now));\r\nrtc->rtc_wrote_regs = 0x1;\r\n}\r\nreturn ret;\r\n}\r\nstatic int bfin_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\ndev_dbg_stamp(dev);\r\nalrm->time = rtc->rtc_alarm;\r\nbfin_rtc_sync_pending(dev);\r\nalrm->enabled = !!(bfin_read_RTC_ICTL() & (RTC_ISTAT_ALARM | RTC_ISTAT_ALARM_DAY));\r\nreturn 0;\r\n}\r\nstatic int bfin_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct bfin_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long rtc_alarm;\r\ndev_dbg_stamp(dev);\r\nif (rtc_tm_to_time(&alrm->time, &rtc_alarm))\r\nreturn -EINVAL;\r\nrtc->rtc_alarm = alrm->time;\r\nbfin_rtc_sync_pending(dev);\r\nbfin_write_RTC_ALARM(rtc_time_to_bfin(rtc_alarm));\r\nif (alrm->enabled)\r\nbfin_rtc_int_set_alarm(rtc);\r\nreturn 0;\r\n}\r\nstatic int bfin_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\n#define yesno(x) ((x) ? "yes" : "no")\r\nu16 ictl = bfin_read_RTC_ICTL();\r\ndev_dbg_stamp(dev);\r\nseq_printf(seq,\r\n"alarm_IRQ\t: %s\n"\r\n"wkalarm_IRQ\t: %s\n"\r\n"seconds_IRQ\t: %s\n",\r\nyesno(ictl & RTC_ISTAT_ALARM),\r\nyesno(ictl & RTC_ISTAT_ALARM_DAY),\r\nyesno(ictl & RTC_ISTAT_SEC));\r\nreturn 0;\r\n#undef yesno\r\n}\r\nstatic int __devinit bfin_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct bfin_rtc *rtc;\r\nstruct device *dev = &pdev->dev;\r\nint ret = 0;\r\nunsigned long timeout = jiffies + HZ;\r\ndev_dbg_stamp(dev);\r\nrtc = kzalloc(sizeof(*rtc), GFP_KERNEL);\r\nif (unlikely(!rtc))\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, rtc);\r\ndevice_init_wakeup(dev, 1);\r\nrtc->rtc_dev = rtc_device_register(pdev->name, dev, &bfin_rtc_ops,\r\nTHIS_MODULE);\r\nif (unlikely(IS_ERR(rtc->rtc_dev))) {\r\nret = PTR_ERR(rtc->rtc_dev);\r\ngoto err;\r\n}\r\nret = request_irq(IRQ_RTC, bfin_rtc_interrupt, 0, pdev->name, dev);\r\nif (unlikely(ret))\r\ngoto err_reg;\r\nwhile (bfin_read_RTC_ISTAT() & RTC_ISTAT_WRITE_PENDING)\r\nif (time_after(jiffies, timeout))\r\nbreak;\r\nbfin_rtc_reset(dev, RTC_ISTAT_WRITE_COMPLETE);\r\nbfin_write_RTC_SWCNT(0);\r\nreturn 0;\r\nerr_reg:\r\nrtc_device_unregister(rtc->rtc_dev);\r\nerr:\r\nkfree(rtc);\r\nreturn ret;\r\n}\r\nstatic int __devexit bfin_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct bfin_rtc *rtc = platform_get_drvdata(pdev);\r\nstruct device *dev = &pdev->dev;\r\nbfin_rtc_reset(dev, 0);\r\nfree_irq(IRQ_RTC, dev);\r\nrtc_device_unregister(rtc->rtc_dev);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(rtc);\r\nreturn 0;\r\n}\r\nstatic int bfin_rtc_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct device *dev = &pdev->dev;\r\ndev_dbg_stamp(dev);\r\nif (device_may_wakeup(dev)) {\r\nenable_irq_wake(IRQ_RTC);\r\nbfin_rtc_sync_pending(dev);\r\n} else\r\nbfin_rtc_int_clear(0);\r\nreturn 0;\r\n}\r\nstatic int bfin_rtc_resume(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\ndev_dbg_stamp(dev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(IRQ_RTC);\r\nwhile (!(bfin_read_RTC_ISTAT() & RTC_ISTAT_SEC))\r\ncontinue;\r\nbfin_rtc_int_set(RTC_ISTAT_WRITE_COMPLETE);\r\nreturn 0;\r\n}

int of_mdiobus_register(struct mii_bus *mdio, struct device_node *np)\r\n{\r\nstruct phy_device *phy;\r\nstruct device_node *child;\r\nint rc, i;\r\nmdio->phy_mask = ~0;\r\nif (mdio->irq)\r\nfor (i=0; i<PHY_MAX_ADDR; i++)\r\nmdio->irq[i] = PHY_POLL;\r\nrc = mdiobus_register(mdio);\r\nif (rc)\r\nreturn rc;\r\nfor_each_child_of_node(np, child) {\r\nconst __be32 *paddr;\r\nu32 addr;\r\nint len;\r\npaddr = of_get_property(child, "reg", &len);\r\nif (!paddr || len < sizeof(*paddr)) {\r\ndev_err(&mdio->dev, "%s has invalid PHY address\n",\r\nchild->full_name);\r\ncontinue;\r\n}\r\naddr = be32_to_cpup(paddr);\r\nif (addr >= 32) {\r\ndev_err(&mdio->dev, "%s PHY address %i is too large\n",\r\nchild->full_name, addr);\r\ncontinue;\r\n}\r\nif (mdio->irq) {\r\nmdio->irq[addr] = irq_of_parse_and_map(child, 0);\r\nif (!mdio->irq[addr])\r\nmdio->irq[addr] = PHY_POLL;\r\n}\r\nphy = get_phy_device(mdio, addr);\r\nif (!phy || IS_ERR(phy)) {\r\ndev_err(&mdio->dev, "error probing PHY at address %i\n",\r\naddr);\r\ncontinue;\r\n}\r\nof_node_get(child);\r\nphy->dev.of_node = child;\r\nrc = phy_device_register(phy);\r\nif (rc) {\r\nphy_device_free(phy);\r\nof_node_put(child);\r\ncontinue;\r\n}\r\ndev_dbg(&mdio->dev, "registered phy %s at address %i\n",\r\nchild->name, addr);\r\n}\r\nreturn 0;\r\n}\r\nstatic int of_phy_match(struct device *dev, void *phy_np)\r\n{\r\nreturn dev->of_node == phy_np;\r\n}\r\nstruct phy_device *of_phy_find_device(struct device_node *phy_np)\r\n{\r\nstruct device *d;\r\nif (!phy_np)\r\nreturn NULL;\r\nd = bus_find_device(&mdio_bus_type, NULL, phy_np, of_phy_match);\r\nreturn d ? to_phy_device(d) : NULL;\r\n}\r\nstruct phy_device *of_phy_connect(struct net_device *dev,\r\nstruct device_node *phy_np,\r\nvoid (*hndlr)(struct net_device *), u32 flags,\r\nphy_interface_t iface)\r\n{\r\nstruct phy_device *phy = of_phy_find_device(phy_np);\r\nif (!phy)\r\nreturn NULL;\r\nreturn phy_connect_direct(dev, phy, hndlr, flags, iface) ? NULL : phy;\r\n}\r\nstruct phy_device *of_phy_connect_fixed_link(struct net_device *dev,\r\nvoid (*hndlr)(struct net_device *),\r\nphy_interface_t iface)\r\n{\r\nstruct device_node *net_np;\r\nchar bus_id[MII_BUS_ID_SIZE + 3];\r\nstruct phy_device *phy;\r\nconst __be32 *phy_id;\r\nint sz;\r\nif (!dev->dev.parent)\r\nreturn NULL;\r\nnet_np = dev->dev.parent->of_node;\r\nif (!net_np)\r\nreturn NULL;\r\nphy_id = of_get_property(net_np, "fixed-link", &sz);\r\nif (!phy_id || sz < sizeof(*phy_id))\r\nreturn NULL;\r\nsprintf(bus_id, PHY_ID_FMT, "fixed-0", be32_to_cpu(phy_id[0]));\r\nphy = phy_connect(dev, bus_id, hndlr, 0, iface);\r\nreturn IS_ERR(phy) ? NULL : phy;\r\n}

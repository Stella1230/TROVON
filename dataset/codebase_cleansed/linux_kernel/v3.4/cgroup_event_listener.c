int main(int argc, char **argv)\r\n{\r\nint efd = -1;\r\nint cfd = -1;\r\nint event_control = -1;\r\nchar event_control_path[PATH_MAX];\r\nchar line[LINE_MAX];\r\nint ret;\r\nif (argc != 3) {\r\nfputs(USAGE_STR, stderr);\r\nreturn 1;\r\n}\r\ncfd = open(argv[1], O_RDONLY);\r\nif (cfd == -1) {\r\nfprintf(stderr, "Cannot open %s: %s\n", argv[1],\r\nstrerror(errno));\r\ngoto out;\r\n}\r\nret = snprintf(event_control_path, PATH_MAX, "%s/cgroup.event_control",\r\ndirname(argv[1]));\r\nif (ret >= PATH_MAX) {\r\nfputs("Path to cgroup.event_control is too long\n", stderr);\r\ngoto out;\r\n}\r\nevent_control = open(event_control_path, O_WRONLY);\r\nif (event_control == -1) {\r\nfprintf(stderr, "Cannot open %s: %s\n", event_control_path,\r\nstrerror(errno));\r\ngoto out;\r\n}\r\nefd = eventfd(0, 0);\r\nif (efd == -1) {\r\nperror("eventfd() failed");\r\ngoto out;\r\n}\r\nret = snprintf(line, LINE_MAX, "%d %d %s", efd, cfd, argv[2]);\r\nif (ret >= LINE_MAX) {\r\nfputs("Arguments string is too long\n", stderr);\r\ngoto out;\r\n}\r\nret = write(event_control, line, strlen(line) + 1);\r\nif (ret == -1) {\r\nperror("Cannot write to cgroup.event_control");\r\ngoto out;\r\n}\r\nwhile (1) {\r\nuint64_t result;\r\nret = read(efd, &result, sizeof(result));\r\nif (ret == -1) {\r\nif (errno == EINTR)\r\ncontinue;\r\nperror("Cannot read from eventfd");\r\nbreak;\r\n}\r\nassert(ret == sizeof(result));\r\nret = access(event_control_path, W_OK);\r\nif ((ret == -1) && (errno == ENOENT)) {\r\nputs("The cgroup seems to have removed.");\r\nret = 0;\r\nbreak;\r\n}\r\nif (ret == -1) {\r\nperror("cgroup.event_control "\r\n"is not accessible any more");\r\nbreak;\r\n}\r\nprintf("%s %s: crossed\n", argv[1], argv[2]);\r\n}\r\nout:\r\nif (efd >= 0)\r\nclose(efd);\r\nif (event_control >= 0)\r\nclose(event_control);\r\nif (cfd >= 0)\r\nclose(cfd);\r\nreturn (ret != 0);\r\n}

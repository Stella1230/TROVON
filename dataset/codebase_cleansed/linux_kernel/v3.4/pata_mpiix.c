static int mpiix_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstatic const struct pci_bits mpiix_enable_bits = { 0x6D, 1, 0x80, 0x80 };\r\nif (!pci_test_config_bits(pdev, &mpiix_enable_bits))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void mpiix_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nint control = 0;\r\nint pio = adev->pio_mode - XFER_PIO_0;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu16 idetim;\r\nstatic const\r\nu8 timings[][2] = { { 0, 0 },\r\n{ 0, 0 },\r\n{ 1, 0 },\r\n{ 2, 1 },\r\n{ 2, 3 }, };\r\npci_read_config_word(pdev, IDETIM, &idetim);\r\nif (adev->class == ATA_DEV_ATA)\r\ncontrol |= PPE;\r\nif (ata_pio_need_iordy(adev))\r\ncontrol |= IORDY;\r\nif (pio > 1)\r\ncontrol |= FTIM;\r\nidetim &= 0xCCEE;\r\nidetim &= ~(0x07 << (4 * adev->devno));\r\nidetim |= control << (4 * adev->devno);\r\nidetim |= (timings[pio][0] << 12) | (timings[pio][1] << 8);\r\npci_write_config_word(pdev, IDETIM, idetim);\r\nap->private_data = adev;\r\n}\r\nstatic unsigned int mpiix_qc_issue(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nstruct ata_device *adev = qc->dev;\r\nif (adev->pio_mode && adev != ap->private_data)\r\nmpiix_set_piomode(ap, adev);\r\nreturn ata_sff_qc_issue(qc);\r\n}\r\nstatic int mpiix_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ata_host *host;\r\nstruct ata_port *ap;\r\nvoid __iomem *cmd_addr, *ctl_addr;\r\nu16 idetim;\r\nint cmd, ctl, irq;\r\nata_print_version_once(&dev->dev, DRV_VERSION);\r\nhost = ata_host_alloc(&dev->dev, 1);\r\nif (!host)\r\nreturn -ENOMEM;\r\nap = host->ports[0];\r\npci_read_config_word(dev, IDETIM, &idetim);\r\nif (!(idetim & ENABLED))\r\nreturn -ENODEV;\r\nif (!(idetim & SECONDARY)) {\r\ncmd = 0x1F0;\r\nctl = 0x3F6;\r\nirq = 14;\r\n} else {\r\ncmd = 0x170;\r\nctl = 0x376;\r\nirq = 15;\r\n}\r\ncmd_addr = devm_ioport_map(&dev->dev, cmd, 8);\r\nctl_addr = devm_ioport_map(&dev->dev, ctl, 1);\r\nif (!cmd_addr || !ctl_addr)\r\nreturn -ENOMEM;\r\nata_port_desc(ap, "cmd 0x%x ctl 0x%x", cmd, ctl);\r\nap->ops = &mpiix_port_ops;\r\nap->pio_mask = ATA_PIO4;\r\nap->flags |= ATA_FLAG_SLAVE_POSS;\r\nap->ioaddr.cmd_addr = cmd_addr;\r\nap->ioaddr.ctl_addr = ctl_addr;\r\nap->ioaddr.altstatus_addr = ctl_addr;\r\nata_sff_std_ports(&ap->ioaddr);\r\nreturn ata_host_activate(host, irq, ata_sff_interrupt, IRQF_SHARED,\r\n&mpiix_sht);\r\n}\r\nstatic int __init mpiix_init(void)\r\n{\r\nreturn pci_register_driver(&mpiix_pci_driver);\r\n}\r\nstatic void __exit mpiix_exit(void)\r\n{\r\npci_unregister_driver(&mpiix_pci_driver);\r\n}

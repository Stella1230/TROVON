static inline const struct spi_gpio_platform_data * __pure\r\nspi_to_pdata(const struct spi_device *spi)\r\n{\r\nconst struct spi_bitbang *bang;\r\nconst struct spi_gpio *spi_gpio;\r\nbang = spi_master_get_devdata(spi->master);\r\nspi_gpio = container_of(bang, struct spi_gpio, bitbang);\r\nreturn &spi_gpio->pdata;\r\n}\r\nstatic inline void setsck(const struct spi_device *spi, int is_on)\r\n{\r\ngpio_set_value(SPI_SCK_GPIO, is_on);\r\n}\r\nstatic inline void setmosi(const struct spi_device *spi, int is_on)\r\n{\r\ngpio_set_value(SPI_MOSI_GPIO, is_on);\r\n}\r\nstatic inline int getmiso(const struct spi_device *spi)\r\n{\r\nreturn !!gpio_get_value(SPI_MISO_GPIO);\r\n}\r\nstatic u32 spi_gpio_txrx_word_mode0(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha0(spi, nsecs, 0, 0, word, bits);\r\n}\r\nstatic u32 spi_gpio_txrx_word_mode1(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha1(spi, nsecs, 0, 0, word, bits);\r\n}\r\nstatic u32 spi_gpio_txrx_word_mode2(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha0(spi, nsecs, 1, 0, word, bits);\r\n}\r\nstatic u32 spi_gpio_txrx_word_mode3(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nreturn bitbang_txrx_be_cpha1(spi, nsecs, 1, 0, word, bits);\r\n}\r\nstatic u32 spi_gpio_spec_txrx_word_mode0(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nunsigned flags = spi->master->flags;\r\nreturn bitbang_txrx_be_cpha0(spi, nsecs, 0, flags, word, bits);\r\n}\r\nstatic u32 spi_gpio_spec_txrx_word_mode1(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nunsigned flags = spi->master->flags;\r\nreturn bitbang_txrx_be_cpha1(spi, nsecs, 0, flags, word, bits);\r\n}\r\nstatic u32 spi_gpio_spec_txrx_word_mode2(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nunsigned flags = spi->master->flags;\r\nreturn bitbang_txrx_be_cpha0(spi, nsecs, 1, flags, word, bits);\r\n}\r\nstatic u32 spi_gpio_spec_txrx_word_mode3(struct spi_device *spi,\r\nunsigned nsecs, u32 word, u8 bits)\r\n{\r\nunsigned flags = spi->master->flags;\r\nreturn bitbang_txrx_be_cpha1(spi, nsecs, 1, flags, word, bits);\r\n}\r\nstatic void spi_gpio_chipselect(struct spi_device *spi, int is_active)\r\n{\r\nunsigned long cs = (unsigned long) spi->controller_data;\r\nif (is_active)\r\nsetsck(spi, spi->mode & SPI_CPOL);\r\nif (cs != SPI_GPIO_NO_CHIPSELECT) {\r\ngpio_set_value(cs, (spi->mode & SPI_CS_HIGH) ? is_active : !is_active);\r\n}\r\n}\r\nstatic int spi_gpio_setup(struct spi_device *spi)\r\n{\r\nunsigned long cs = (unsigned long) spi->controller_data;\r\nint status = 0;\r\nif (spi->bits_per_word > 32)\r\nreturn -EINVAL;\r\nif (!spi->controller_state) {\r\nif (cs != SPI_GPIO_NO_CHIPSELECT) {\r\nstatus = gpio_request(cs, dev_name(&spi->dev));\r\nif (status)\r\nreturn status;\r\nstatus = gpio_direction_output(cs, spi->mode & SPI_CS_HIGH);\r\n}\r\n}\r\nif (!status)\r\nstatus = spi_bitbang_setup(spi);\r\nif (status) {\r\nif (!spi->controller_state && cs != SPI_GPIO_NO_CHIPSELECT)\r\ngpio_free(cs);\r\n}\r\nreturn status;\r\n}\r\nstatic void spi_gpio_cleanup(struct spi_device *spi)\r\n{\r\nunsigned long cs = (unsigned long) spi->controller_data;\r\nif (cs != SPI_GPIO_NO_CHIPSELECT)\r\ngpio_free(cs);\r\nspi_bitbang_cleanup(spi);\r\n}\r\nstatic int __devinit spi_gpio_alloc(unsigned pin, const char *label, bool is_in)\r\n{\r\nint value;\r\nvalue = gpio_request(pin, label);\r\nif (value == 0) {\r\nif (is_in)\r\nvalue = gpio_direction_input(pin);\r\nelse\r\nvalue = gpio_direction_output(pin, 0);\r\n}\r\nreturn value;\r\n}\r\nstatic int __devinit\r\nspi_gpio_request(struct spi_gpio_platform_data *pdata, const char *label,\r\nu16 *res_flags)\r\n{\r\nint value;\r\nif (SPI_MOSI_GPIO != SPI_GPIO_NO_MOSI) {\r\nvalue = spi_gpio_alloc(SPI_MOSI_GPIO, label, false);\r\nif (value)\r\ngoto done;\r\n} else {\r\n*res_flags |= SPI_MASTER_NO_TX;\r\n}\r\nif (SPI_MISO_GPIO != SPI_GPIO_NO_MISO) {\r\nvalue = spi_gpio_alloc(SPI_MISO_GPIO, label, true);\r\nif (value)\r\ngoto free_mosi;\r\n} else {\r\n*res_flags |= SPI_MASTER_NO_RX;\r\n}\r\nvalue = spi_gpio_alloc(SPI_SCK_GPIO, label, false);\r\nif (value)\r\ngoto free_miso;\r\ngoto done;\r\nfree_miso:\r\nif (SPI_MISO_GPIO != SPI_GPIO_NO_MISO)\r\ngpio_free(SPI_MISO_GPIO);\r\nfree_mosi:\r\nif (SPI_MOSI_GPIO != SPI_GPIO_NO_MOSI)\r\ngpio_free(SPI_MOSI_GPIO);\r\ndone:\r\nreturn value;\r\n}\r\nstatic int __devinit spi_gpio_probe(struct platform_device *pdev)\r\n{\r\nint status;\r\nstruct spi_master *master;\r\nstruct spi_gpio *spi_gpio;\r\nstruct spi_gpio_platform_data *pdata;\r\nu16 master_flags = 0;\r\npdata = pdev->dev.platform_data;\r\n#ifdef GENERIC_BITBANG\r\nif (!pdata || !pdata->num_chipselect)\r\nreturn -ENODEV;\r\n#endif\r\nstatus = spi_gpio_request(pdata, dev_name(&pdev->dev), &master_flags);\r\nif (status < 0)\r\nreturn status;\r\nmaster = spi_alloc_master(&pdev->dev, sizeof *spi_gpio);\r\nif (!master) {\r\nstatus = -ENOMEM;\r\ngoto gpio_free;\r\n}\r\nspi_gpio = spi_master_get_devdata(master);\r\nplatform_set_drvdata(pdev, spi_gpio);\r\nspi_gpio->pdev = pdev;\r\nif (pdata)\r\nspi_gpio->pdata = *pdata;\r\nmaster->flags = master_flags;\r\nmaster->bus_num = pdev->id;\r\nmaster->num_chipselect = SPI_N_CHIPSEL;\r\nmaster->setup = spi_gpio_setup;\r\nmaster->cleanup = spi_gpio_cleanup;\r\nspi_gpio->bitbang.master = spi_master_get(master);\r\nspi_gpio->bitbang.chipselect = spi_gpio_chipselect;\r\nif ((master_flags & (SPI_MASTER_NO_TX | SPI_MASTER_NO_RX)) == 0) {\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_0] = spi_gpio_txrx_word_mode0;\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_1] = spi_gpio_txrx_word_mode1;\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_2] = spi_gpio_txrx_word_mode2;\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_3] = spi_gpio_txrx_word_mode3;\r\n} else {\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_0] = spi_gpio_spec_txrx_word_mode0;\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_1] = spi_gpio_spec_txrx_word_mode1;\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_2] = spi_gpio_spec_txrx_word_mode2;\r\nspi_gpio->bitbang.txrx_word[SPI_MODE_3] = spi_gpio_spec_txrx_word_mode3;\r\n}\r\nspi_gpio->bitbang.setup_transfer = spi_bitbang_setup_transfer;\r\nspi_gpio->bitbang.flags = SPI_CS_HIGH;\r\nstatus = spi_bitbang_start(&spi_gpio->bitbang);\r\nif (status < 0) {\r\nspi_master_put(spi_gpio->bitbang.master);\r\ngpio_free:\r\nif (SPI_MISO_GPIO != SPI_GPIO_NO_MISO)\r\ngpio_free(SPI_MISO_GPIO);\r\nif (SPI_MOSI_GPIO != SPI_GPIO_NO_MOSI)\r\ngpio_free(SPI_MOSI_GPIO);\r\ngpio_free(SPI_SCK_GPIO);\r\nspi_master_put(master);\r\n}\r\nreturn status;\r\n}\r\nstatic int __devexit spi_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_gpio *spi_gpio;\r\nstruct spi_gpio_platform_data *pdata;\r\nint status;\r\nspi_gpio = platform_get_drvdata(pdev);\r\npdata = pdev->dev.platform_data;\r\nstatus = spi_bitbang_stop(&spi_gpio->bitbang);\r\nspi_master_put(spi_gpio->bitbang.master);\r\nplatform_set_drvdata(pdev, NULL);\r\nif (SPI_MISO_GPIO != SPI_GPIO_NO_MISO)\r\ngpio_free(SPI_MISO_GPIO);\r\nif (SPI_MOSI_GPIO != SPI_GPIO_NO_MOSI)\r\ngpio_free(SPI_MOSI_GPIO);\r\ngpio_free(SPI_SCK_GPIO);\r\nreturn status;\r\n}

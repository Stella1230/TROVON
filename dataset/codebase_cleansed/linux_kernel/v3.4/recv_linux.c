int r8712_os_recv_resource_alloc(struct _adapter *padapter,\r\nunion recv_frame *precvframe)\r\n{\r\nprecvframe->u.hdr.pkt_newalloc = precvframe->u.hdr.pkt = NULL;\r\nreturn _SUCCESS;\r\n}\r\nint r8712_os_recvbuf_resource_alloc(struct _adapter *padapter,\r\nstruct recv_buf *precvbuf)\r\n{\r\nint res = _SUCCESS;\r\nprecvbuf->irp_pending = false;\r\nprecvbuf->purb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (precvbuf->purb == NULL)\r\nres = _FAIL;\r\nprecvbuf->pskb = NULL;\r\nprecvbuf->reuse = false;\r\nprecvbuf->pallocated_buf = NULL;\r\nprecvbuf->pbuf = NULL;\r\nprecvbuf->pdata = NULL;\r\nprecvbuf->phead = NULL;\r\nprecvbuf->ptail = NULL;\r\nprecvbuf->pend = NULL;\r\nprecvbuf->transfer_len = 0;\r\nprecvbuf->len = 0;\r\nreturn res;\r\n}\r\nint r8712_os_recvbuf_resource_free(struct _adapter *padapter,\r\nstruct recv_buf *precvbuf)\r\n{\r\nif (precvbuf->pskb)\r\ndev_kfree_skb_any(precvbuf->pskb);\r\nif (precvbuf->purb) {\r\nusb_kill_urb(precvbuf->purb);\r\nusb_free_urb(precvbuf->purb);\r\n}\r\nreturn _SUCCESS;\r\n}\r\nvoid r8712_handle_tkip_mic_err(struct _adapter *padapter, u8 bgroup)\r\n{\r\nunion iwreq_data wrqu;\r\nstruct iw_michaelmicfailure ev;\r\nstruct mlme_priv *pmlmepriv = &padapter->mlmepriv;\r\nmemset(&ev, 0x00, sizeof(ev));\r\nif (bgroup)\r\nev.flags |= IW_MICFAILURE_GROUP;\r\nelse\r\nev.flags |= IW_MICFAILURE_PAIRWISE;\r\nev.src_addr.sa_family = ARPHRD_ETHER;\r\nmemcpy(ev.src_addr.sa_data, &pmlmepriv->assoc_bssid[0], ETH_ALEN);\r\nmemset(&wrqu, 0x00, sizeof(wrqu));\r\nwrqu.data.length = sizeof(ev);\r\nwireless_send_event(padapter->pnetdev, IWEVMICHAELMICFAILURE, &wrqu,\r\n(char *)&ev);\r\n}\r\nvoid r8712_recv_indicatepkt(struct _adapter *padapter,\r\nunion recv_frame *precv_frame)\r\n{\r\nstruct recv_priv *precvpriv;\r\nstruct __queue *pfree_recv_queue;\r\n_pkt *skb;\r\nstruct rx_pkt_attrib *pattrib = &precv_frame->u.hdr.attrib;\r\nprecvpriv = &(padapter->recvpriv);\r\npfree_recv_queue = &(precvpriv->free_recv_queue);\r\nskb = precv_frame->u.hdr.pkt;\r\nif (skb == NULL)\r\ngoto _recv_indicatepkt_drop;\r\nskb->data = precv_frame->u.hdr.rx_data;\r\n#ifdef NET_SKBUFF_DATA_USES_OFFSET\r\nskb->tail = (sk_buff_data_t)(precv_frame->u.hdr.rx_tail -\r\nprecv_frame->u.hdr.rx_head);\r\n#else\r\nskb->tail = (sk_buff_data_t)precv_frame->u.hdr.rx_tail;\r\n#endif\r\nskb->len = precv_frame->u.hdr.len;\r\nif ((pattrib->tcpchk_valid == 1) && (pattrib->tcp_chkrpt == 1))\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\nelse\r\nskb->ip_summed = CHECKSUM_NONE;\r\nskb->dev = padapter->pnetdev;\r\nskb->protocol = eth_type_trans(skb, padapter->pnetdev);\r\nnetif_rx(skb);\r\nprecv_frame->u.hdr.pkt = NULL;\r\nr8712_free_recvframe(precv_frame, pfree_recv_queue);\r\nreturn;\r\n_recv_indicatepkt_drop:\r\nif (precv_frame)\r\nr8712_free_recvframe(precv_frame, pfree_recv_queue);\r\nprecvpriv->rx_drop++;\r\n}\r\nvoid r8712_os_read_port(struct _adapter *padapter, struct recv_buf *precvbuf)\r\n{\r\nstruct recv_priv *precvpriv = &padapter->recvpriv;\r\nprecvbuf->ref_cnt--;\r\ndev_kfree_skb_any(precvbuf->pskb);\r\nprecvbuf->pskb = NULL;\r\nprecvbuf->reuse = false;\r\nif (precvbuf->irp_pending == false)\r\nr8712_read_port(padapter, precvpriv->ff_hwaddr, 0,\r\n(unsigned char *)precvbuf);\r\n}\r\nstatic void _r8712_reordering_ctrl_timeout_handler (void *FunctionContext)\r\n{\r\nstruct recv_reorder_ctrl *preorder_ctrl =\r\n(struct recv_reorder_ctrl *)FunctionContext;\r\nr8712_reordering_ctrl_timeout_handler(preorder_ctrl);\r\n}\r\nvoid r8712_init_recv_timer(struct recv_reorder_ctrl *preorder_ctrl)\r\n{\r\nstruct _adapter *padapter = preorder_ctrl->padapter;\r\n_init_timer(&(preorder_ctrl->reordering_ctrl_timer), padapter->pnetdev,\r\n_r8712_reordering_ctrl_timeout_handler, preorder_ctrl);\r\n}

int sci_unsolicited_frame_control_construct(struct isci_host *ihost)\r\n{\r\nstruct sci_unsolicited_frame_control *uf_control = &ihost->uf_control;\r\nstruct sci_unsolicited_frame *uf;\r\nu32 buf_len, header_len, i;\r\ndma_addr_t dma;\r\nsize_t size;\r\nvoid *virt;\r\nbuf_len = SCU_MAX_UNSOLICITED_FRAMES * SCU_UNSOLICITED_FRAME_BUFFER_SIZE;\r\nheader_len = SCU_MAX_UNSOLICITED_FRAMES * sizeof(struct scu_unsolicited_frame_header);\r\nsize = buf_len + header_len + SCU_MAX_UNSOLICITED_FRAMES * sizeof(uf_control->address_table.array[0]);\r\nvirt = dmam_alloc_coherent(&ihost->pdev->dev, size, &dma, GFP_KERNEL);\r\nif (!virt)\r\nreturn -ENOMEM;\r\nuf_control->headers.physical_address = dma + buf_len;\r\nuf_control->headers.array = virt + buf_len;\r\nuf_control->address_table.physical_address = dma + buf_len + header_len;\r\nuf_control->address_table.array = virt + buf_len + header_len;\r\nuf_control->get = 0;\r\nfor (i = 0; i < SCU_MAX_UNSOLICITED_FRAMES; i++) {\r\nuf = &uf_control->buffers.array[i];\r\nuf_control->address_table.array[i] = dma;\r\nuf->buffer = virt;\r\nuf->header = &uf_control->headers.array[i];\r\nuf->state = UNSOLICITED_FRAME_EMPTY;\r\nvirt += SCU_UNSOLICITED_FRAME_BUFFER_SIZE;\r\ndma += SCU_UNSOLICITED_FRAME_BUFFER_SIZE;\r\n}\r\nreturn 0;\r\n}\r\nenum sci_status sci_unsolicited_frame_control_get_header(struct sci_unsolicited_frame_control *uf_control,\r\nu32 frame_index,\r\nvoid **frame_header)\r\n{\r\nif (frame_index < SCU_MAX_UNSOLICITED_FRAMES) {\r\n*frame_header = &uf_control->buffers.array[frame_index].header->data;\r\nreturn SCI_SUCCESS;\r\n}\r\nreturn SCI_FAILURE_INVALID_PARAMETER_VALUE;\r\n}\r\nenum sci_status sci_unsolicited_frame_control_get_buffer(struct sci_unsolicited_frame_control *uf_control,\r\nu32 frame_index,\r\nvoid **frame_buffer)\r\n{\r\nif (frame_index < SCU_MAX_UNSOLICITED_FRAMES) {\r\n*frame_buffer = uf_control->buffers.array[frame_index].buffer;\r\nreturn SCI_SUCCESS;\r\n}\r\nreturn SCI_FAILURE_INVALID_PARAMETER_VALUE;\r\n}\r\nbool sci_unsolicited_frame_control_release_frame(struct sci_unsolicited_frame_control *uf_control,\r\nu32 frame_index)\r\n{\r\nu32 frame_get;\r\nu32 frame_cycle;\r\nframe_get = uf_control->get & (SCU_MAX_UNSOLICITED_FRAMES - 1);\r\nframe_cycle = uf_control->get & SCU_MAX_UNSOLICITED_FRAMES;\r\nwhile (lower_32_bits(uf_control->address_table.array[frame_get]) == 0 &&\r\nupper_32_bits(uf_control->address_table.array[frame_get]) == 0 &&\r\nframe_get < SCU_MAX_UNSOLICITED_FRAMES)\r\nframe_get++;\r\nBUG_ON(frame_get >= SCU_MAX_UNSOLICITED_FRAMES);\r\nif (frame_index >= SCU_MAX_UNSOLICITED_FRAMES)\r\nreturn false;\r\nuf_control->buffers.array[frame_index].state = UNSOLICITED_FRAME_RELEASED;\r\nif (frame_get != frame_index) {\r\nreturn false;\r\n}\r\nwhile (uf_control->buffers.array[frame_get].state == UNSOLICITED_FRAME_RELEASED) {\r\nuf_control->buffers.array[frame_get].state = UNSOLICITED_FRAME_EMPTY;\r\nif (frame_get+1 == SCU_MAX_UNSOLICITED_FRAMES-1) {\r\nframe_cycle ^= SCU_MAX_UNSOLICITED_FRAMES;\r\nframe_get = 0;\r\n} else\r\nframe_get++;\r\n}\r\nuf_control->get = SCU_UFQGP_GEN_BIT(ENABLE_BIT) | frame_cycle | frame_get;\r\nreturn true;\r\n}

static void __clockboard_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val, u8 bit)\r\n{\r\nstruct sunfire_led *p = to_sunfire_led(led_cdev);\r\nu8 reg = upa_readb(p->reg);\r\nswitch (bit) {\r\ncase CLOCK_CTRL_LLED:\r\nif (led_val)\r\nreg &= ~bit;\r\nelse\r\nreg |= bit;\r\nbreak;\r\ndefault:\r\nif (led_val)\r\nreg |= bit;\r\nelse\r\nreg &= ~bit;\r\nbreak;\r\n}\r\nupa_writeb(reg, p->reg);\r\n}\r\nstatic void clockboard_left_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val)\r\n{\r\n__clockboard_set(led_cdev, led_val, CLOCK_CTRL_LLED);\r\n}\r\nstatic void clockboard_middle_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val)\r\n{\r\n__clockboard_set(led_cdev, led_val, CLOCK_CTRL_MLED);\r\n}\r\nstatic void clockboard_right_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val)\r\n{\r\n__clockboard_set(led_cdev, led_val, CLOCK_CTRL_RLED);\r\n}\r\nstatic void __fhc_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val, u32 bit)\r\n{\r\nstruct sunfire_led *p = to_sunfire_led(led_cdev);\r\nu32 reg = upa_readl(p->reg);\r\nswitch (bit) {\r\ncase FHC_CONTROL_LLED:\r\nif (led_val)\r\nreg &= ~bit;\r\nelse\r\nreg |= bit;\r\nbreak;\r\ndefault:\r\nif (led_val)\r\nreg |= bit;\r\nelse\r\nreg &= ~bit;\r\nbreak;\r\n}\r\nupa_writel(reg, p->reg);\r\n}\r\nstatic void fhc_left_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val)\r\n{\r\n__fhc_set(led_cdev, led_val, FHC_CONTROL_LLED);\r\n}\r\nstatic void fhc_middle_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val)\r\n{\r\n__fhc_set(led_cdev, led_val, FHC_CONTROL_MLED);\r\n}\r\nstatic void fhc_right_set(struct led_classdev *led_cdev,\r\nenum led_brightness led_val)\r\n{\r\n__fhc_set(led_cdev, led_val, FHC_CONTROL_RLED);\r\n}\r\nstatic int __devinit sunfire_led_generic_probe(struct platform_device *pdev,\r\nstruct led_type *types)\r\n{\r\nstruct sunfire_drvdata *p;\r\nint i, err;\r\nif (pdev->num_resources != 1) {\r\nprintk(KERN_ERR PFX "Wrong number of resources %d, should be 1\n",\r\npdev->num_resources);\r\nerr = -EINVAL;\r\ngoto out;\r\n}\r\np = kzalloc(sizeof(*p), GFP_KERNEL);\r\nif (!p) {\r\nprintk(KERN_ERR PFX "Could not allocate struct sunfire_drvdata\n");\r\nerr = -ENOMEM;\r\ngoto out;\r\n}\r\nfor (i = 0; i < NUM_LEDS_PER_BOARD; i++) {\r\nstruct led_classdev *lp = &p->leds[i].led_cdev;\r\np->leds[i].reg = (void __iomem *) pdev->resource[0].start;\r\nlp->name = types[i].name;\r\nlp->brightness = LED_FULL;\r\nlp->brightness_set = types[i].handler;\r\nlp->default_trigger = types[i].default_trigger;\r\nerr = led_classdev_register(&pdev->dev, lp);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Could not register %s LED\n",\r\nlp->name);\r\ngoto out_unregister_led_cdevs;\r\n}\r\n}\r\ndev_set_drvdata(&pdev->dev, p);\r\nreturn 0;\r\nout_unregister_led_cdevs:\r\nfor (i--; i >= 0; i--)\r\nled_classdev_unregister(&p->leds[i].led_cdev);\r\nkfree(p);\r\nout:\r\nreturn err;\r\n}\r\nstatic int __devexit sunfire_led_generic_remove(struct platform_device *pdev)\r\n{\r\nstruct sunfire_drvdata *p = dev_get_drvdata(&pdev->dev);\r\nint i;\r\nfor (i = 0; i < NUM_LEDS_PER_BOARD; i++)\r\nled_classdev_unregister(&p->leds[i].led_cdev);\r\nkfree(p);\r\nreturn 0;\r\n}\r\nstatic int __devinit sunfire_clockboard_led_probe(struct platform_device *pdev)\r\n{\r\nreturn sunfire_led_generic_probe(pdev, clockboard_led_types);\r\n}\r\nstatic int __devinit sunfire_fhc_led_probe(struct platform_device *pdev)\r\n{\r\nreturn sunfire_led_generic_probe(pdev, fhc_led_types);\r\n}\r\nstatic int __init sunfire_leds_init(void)\r\n{\r\nint err = platform_driver_register(&sunfire_clockboard_led_driver);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Could not register clock board LED driver\n");\r\nreturn err;\r\n}\r\nerr = platform_driver_register(&sunfire_fhc_led_driver);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Could not register FHC LED driver\n");\r\nplatform_driver_unregister(&sunfire_clockboard_led_driver);\r\n}\r\nreturn err;\r\n}\r\nstatic void __exit sunfire_leds_exit(void)\r\n{\r\nplatform_driver_unregister(&sunfire_clockboard_led_driver);\r\nplatform_driver_unregister(&sunfire_fhc_led_driver);\r\n}

static u32 dur_to_usecs(struct ath_hw *ah, u32 dur)\r\n{\r\nconst u32 AR93X_NSECS_PER_DUR = 800;\r\nconst u32 AR93X_NSECS_PER_DUR_FAST = (8000 / 11);\r\nu32 nsecs;\r\nif (IS_CHAN_A_FAST_CLOCK(ah, ah->curchan))\r\nnsecs = dur * AR93X_NSECS_PER_DUR_FAST;\r\nelse\r\nnsecs = dur * AR93X_NSECS_PER_DUR;\r\nreturn (nsecs + 500) / 1000;\r\n}\r\nstatic bool\r\nath9k_postprocess_radar_event(struct ath_softc *sc,\r\nstruct ath_radar_data *are,\r\nstruct dfs_radar_pulse *drp)\r\n{\r\nu8 rssi;\r\nu16 dur;\r\nath_dbg(ath9k_hw_common(sc->sc_ah), DFS,\r\n"pulse_bw_info=0x%x, pri,ext len/rssi=(%u/%u, %u/%u)\n",\r\nare->pulse_bw_info,\r\nare->pulse_length_pri, are->rssi,\r\nare->pulse_length_ext, are->ext_rssi);\r\nare->pulse_bw_info &= 0x03;\r\nswitch (are->pulse_bw_info) {\r\ncase PRI_CH_RADAR_FOUND:\r\ndur = are->pulse_length_pri;\r\nDFS_STAT_INC(sc, pri_phy_errors);\r\nrssi = (are->ext_rssi >= (are->rssi + 3)) ? 0 : are->rssi;\r\nbreak;\r\ncase EXT_CH_RADAR_FOUND:\r\ndur = are->pulse_length_ext;\r\nDFS_STAT_INC(sc, ext_phy_errors);\r\nrssi = (are->rssi >= (are->ext_rssi + 12)) ? 0 : are->ext_rssi;\r\nbreak;\r\ncase (PRI_CH_RADAR_FOUND | EXT_CH_RADAR_FOUND):\r\nif (are->pulse_length_ext >= are->pulse_length_pri)\r\ndur = are->pulse_length_ext;\r\nelse\r\ndur = are->pulse_length_pri;\r\nDFS_STAT_INC(sc, dc_phy_errors);\r\nrssi = (are->rssi < are->ext_rssi) ? are->ext_rssi : are->rssi;\r\nbreak;\r\ndefault:\r\nDFS_STAT_INC(sc, bwinfo_discards);\r\nreturn false;\r\n}\r\nif (rssi == 0) {\r\nDFS_STAT_INC(sc, rssi_discards);\r\nreturn false;\r\n}\r\ndrp->width = dur_to_usecs(sc->sc_ah, dur);\r\ndrp->rssi = rssi;\r\nDFS_STAT_INC(sc, pulses_detected);\r\nreturn true;\r\n}\r\nvoid ath9k_dfs_process_phyerr(struct ath_softc *sc, void *data,\r\nstruct ath_rx_status *rs, u64 mactime)\r\n{\r\nstruct ath_radar_data ard;\r\nu16 datalen;\r\nchar *vdata_end;\r\nstruct dfs_radar_pulse drp;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nif ((!(rs->rs_phyerr != ATH9K_PHYERR_RADAR)) &&\r\n(!(rs->rs_phyerr != ATH9K_PHYERR_FALSE_RADAR_EXT))) {\r\nath_dbg(common, DFS,\r\n"Error: rs_phyer=0x%x not a radar error\n",\r\nrs->rs_phyerr);\r\nreturn;\r\n}\r\ndatalen = rs->rs_datalen;\r\nif (datalen == 0) {\r\nDFS_STAT_INC(sc, datalen_discards);\r\nreturn;\r\n}\r\nard.rssi = rs->rs_rssi_ctl0;\r\nard.ext_rssi = rs->rs_rssi_ext0;\r\nif (ard.rssi & 0x80)\r\nard.rssi = 0;\r\nif (ard.ext_rssi & 0x80)\r\nard.ext_rssi = 0;\r\nvdata_end = (char *)data + datalen;\r\nard.pulse_bw_info = vdata_end[-1];\r\nard.pulse_length_ext = vdata_end[-2];\r\nard.pulse_length_pri = vdata_end[-3];\r\nath_dbg(common, DFS,\r\n"bw_info=%d, length_pri=%d, length_ext=%d, "\r\n"rssi_pri=%d, rssi_ext=%d\n",\r\nard.pulse_bw_info, ard.pulse_length_pri, ard.pulse_length_ext,\r\nard.rssi, ard.ext_rssi);\r\ndrp.freq = ah->curchan->channel;\r\ndrp.ts = mactime;\r\nif (ath9k_postprocess_radar_event(sc, &ard, &drp)) {\r\nstatic u64 last_ts;\r\nath_dbg(common, DFS,\r\n"ath9k_dfs_process_phyerr: channel=%d, ts=%llu, "\r\n"width=%d, rssi=%d, delta_ts=%llu\n",\r\ndrp.freq, drp.ts, drp.width, drp.rssi, drp.ts-last_ts);\r\nlast_ts = drp.ts;\r\n}\r\n}

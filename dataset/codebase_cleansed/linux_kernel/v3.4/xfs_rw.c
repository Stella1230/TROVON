void\r\nxfs_do_force_shutdown(\r\nxfs_mount_t *mp,\r\nint flags,\r\nchar *fname,\r\nint lnnum)\r\n{\r\nint logerror;\r\nlogerror = flags & SHUTDOWN_LOG_IO_ERROR;\r\nif (!(flags & SHUTDOWN_FORCE_UMOUNT)) {\r\nxfs_notice(mp,\r\n"%s(0x%x) called from line %d of file %s. Return address = 0x%p",\r\n__func__, flags, lnnum, fname, __return_address);\r\n}\r\nif (XFS_FORCED_SHUTDOWN(mp) && !logerror)\r\nreturn;\r\nif (xfs_log_force_umount(mp, logerror))\r\nreturn;\r\nif (flags & SHUTDOWN_CORRUPT_INCORE) {\r\nxfs_alert_tag(mp, XFS_PTAG_SHUTDOWN_CORRUPT,\r\n"Corruption of in-memory data detected. Shutting down filesystem");\r\nif (XFS_ERRLEVEL_HIGH <= xfs_error_level)\r\nxfs_stack_trace();\r\n} else if (!(flags & SHUTDOWN_FORCE_UMOUNT)) {\r\nif (logerror) {\r\nxfs_alert_tag(mp, XFS_PTAG_SHUTDOWN_LOGERROR,\r\n"Log I/O Error Detected. Shutting down filesystem");\r\n} else if (flags & SHUTDOWN_DEVICE_REQ) {\r\nxfs_alert_tag(mp, XFS_PTAG_SHUTDOWN_IOERROR,\r\n"All device paths lost. Shutting down filesystem");\r\n} else if (!(flags & SHUTDOWN_REMOTE_REQ)) {\r\nxfs_alert_tag(mp, XFS_PTAG_SHUTDOWN_IOERROR,\r\n"I/O Error Detected. Shutting down filesystem");\r\n}\r\n}\r\nif (!(flags & SHUTDOWN_FORCE_UMOUNT)) {\r\nxfs_alert(mp,\r\n"Please umount the filesystem and rectify the problem(s)");\r\n}\r\n}\r\nint\r\nxfs_read_buf(\r\nstruct xfs_mount *mp,\r\nxfs_buftarg_t *target,\r\nxfs_daddr_t blkno,\r\nint len,\r\nuint flags,\r\nxfs_buf_t **bpp)\r\n{\r\nxfs_buf_t *bp;\r\nint error;\r\nif (!flags)\r\nflags = XBF_LOCK | XBF_MAPPED;\r\nbp = xfs_buf_read(target, blkno, len, flags);\r\nif (!bp)\r\nreturn XFS_ERROR(EIO);\r\nerror = bp->b_error;\r\nif (!error && !XFS_FORCED_SHUTDOWN(mp)) {\r\n*bpp = bp;\r\n} else {\r\n*bpp = NULL;\r\nif (error) {\r\nxfs_buf_ioerror_alert(bp, __func__);\r\n} else {\r\nerror = XFS_ERROR(EIO);\r\n}\r\nif (bp) {\r\nXFS_BUF_UNDONE(bp);\r\nxfs_buf_stale(bp);\r\nxfs_buf_relse(bp);\r\n}\r\n}\r\nreturn (error);\r\n}\r\nxfs_extlen_t\r\nxfs_get_extsz_hint(\r\nstruct xfs_inode *ip)\r\n{\r\nif ((ip->i_d.di_flags & XFS_DIFLAG_EXTSIZE) && ip->i_d.di_extsize)\r\nreturn ip->i_d.di_extsize;\r\nif (XFS_IS_REALTIME_INODE(ip))\r\nreturn ip->i_mount->m_sb.sb_rextsize;\r\nreturn 0;\r\n}

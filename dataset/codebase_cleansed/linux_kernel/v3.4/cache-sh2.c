static void sh2__flush_wback_region(void *start, int size)\r\n{\r\nunsigned long v;\r\nunsigned long begin, end;\r\nbegin = (unsigned long)start & ~(L1_CACHE_BYTES-1);\r\nend = ((unsigned long)start + size + L1_CACHE_BYTES-1)\r\n& ~(L1_CACHE_BYTES-1);\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES) {\r\nunsigned long addr = CACHE_OC_ADDRESS_ARRAY | (v & 0x00000ff0);\r\nint way;\r\nfor (way = 0; way < 4; way++) {\r\nunsigned long data = __raw_readl(addr | (way << 12));\r\nif ((data & CACHE_PHYSADDR_MASK) == (v & CACHE_PHYSADDR_MASK)) {\r\ndata &= ~SH_CACHE_UPDATED;\r\n__raw_writel(data, addr | (way << 12));\r\n}\r\n}\r\n}\r\n}\r\nstatic void sh2__flush_purge_region(void *start, int size)\r\n{\r\nunsigned long v;\r\nunsigned long begin, end;\r\nbegin = (unsigned long)start & ~(L1_CACHE_BYTES-1);\r\nend = ((unsigned long)start + size + L1_CACHE_BYTES-1)\r\n& ~(L1_CACHE_BYTES-1);\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES)\r\n__raw_writel((v & CACHE_PHYSADDR_MASK),\r\nCACHE_OC_ADDRESS_ARRAY | (v & 0x00000ff0) | 0x00000008);\r\n}\r\nstatic void sh2__flush_invalidate_region(void *start, int size)\r\n{\r\n#ifdef CONFIG_CACHE_WRITEBACK\r\nunsigned long ccr;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\njump_to_uncached();\r\nccr = __raw_readl(CCR);\r\nccr |= CCR_CACHE_INVALIDATE;\r\n__raw_writel(ccr, CCR);\r\nback_to_cached();\r\nlocal_irq_restore(flags);\r\n#else\r\nunsigned long v;\r\nunsigned long begin, end;\r\nbegin = (unsigned long)start & ~(L1_CACHE_BYTES-1);\r\nend = ((unsigned long)start + size + L1_CACHE_BYTES-1)\r\n& ~(L1_CACHE_BYTES-1);\r\nfor (v = begin; v < end; v+=L1_CACHE_BYTES)\r\n__raw_writel((v & CACHE_PHYSADDR_MASK),\r\nCACHE_OC_ADDRESS_ARRAY | (v & 0x00000ff0) | 0x00000008);\r\n#endif\r\n}\r\nvoid __init sh2_cache_init(void)\r\n{\r\n__flush_wback_region = sh2__flush_wback_region;\r\n__flush_purge_region = sh2__flush_purge_region;\r\n__flush_invalidate_region = sh2__flush_invalidate_region;\r\n}

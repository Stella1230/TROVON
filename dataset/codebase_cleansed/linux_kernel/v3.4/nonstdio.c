int xmon_putchar(int c)\r\n{\r\nchar ch = c;\r\nif (c == '\n')\r\nxmon_putchar('\r');\r\nreturn xmon_write(&ch, 1) == 1? c: -1;\r\n}\r\nint xmon_expect(const char *str, unsigned long timeout)\r\n{\r\nint c;\r\nunsigned long t0;\r\ntimeout *= tb_ticks_per_sec? tb_ticks_per_sec: 25000000;\r\nt0 = get_tbl();\r\ndo {\r\nlineptr = line;\r\nfor (;;) {\r\nc = xmon_read_poll();\r\nif (c == -1) {\r\nif (get_tbl() - t0 > timeout)\r\nreturn 0;\r\ncontinue;\r\n}\r\nif (c == '\n')\r\nbreak;\r\nif (c != '\r' && lineptr < &line[sizeof(line) - 1])\r\n*lineptr++ = c;\r\n}\r\n*lineptr = 0;\r\n} while (strstr(line, str) == NULL);\r\nreturn 1;\r\n}\r\nint xmon_getchar(void)\r\n{\r\nint c;\r\nif (lineleft == 0) {\r\nlineptr = line;\r\nfor (;;) {\r\nc = xmon_readchar();\r\nif (c == -1 || c == 4)\r\nbreak;\r\nif (c == '\r' || c == '\n') {\r\n*lineptr++ = '\n';\r\nxmon_putchar('\n');\r\nbreak;\r\n}\r\nswitch (c) {\r\ncase 0177:\r\ncase '\b':\r\nif (lineptr > line) {\r\nxmon_putchar('\b');\r\nxmon_putchar(' ');\r\nxmon_putchar('\b');\r\n--lineptr;\r\n}\r\nbreak;\r\ncase 'U' & 0x1F:\r\nwhile (lineptr > line) {\r\nxmon_putchar('\b');\r\nxmon_putchar(' ');\r\nxmon_putchar('\b');\r\n--lineptr;\r\n}\r\nbreak;\r\ndefault:\r\nif (lineptr >= &line[sizeof(line) - 1])\r\nxmon_putchar('\a');\r\nelse {\r\nxmon_putchar(c);\r\n*lineptr++ = c;\r\n}\r\n}\r\n}\r\nlineleft = lineptr - line;\r\nlineptr = line;\r\n}\r\nif (lineleft == 0)\r\nreturn -1;\r\n--lineleft;\r\nreturn *lineptr++;\r\n}\r\nchar *xmon_gets(char *str, int nb)\r\n{\r\nchar *p;\r\nint c;\r\nfor (p = str; p < str + nb - 1; ) {\r\nc = xmon_getchar();\r\nif (c == -1) {\r\nif (p == str)\r\nreturn NULL;\r\nbreak;\r\n}\r\n*p++ = c;\r\nif (c == '\n')\r\nbreak;\r\n}\r\n*p = 0;\r\nreturn str;\r\n}\r\nvoid xmon_printf(const char *format, ...)\r\n{\r\nva_list args;\r\nint n;\r\nstatic char xmon_outbuf[1024];\r\nva_start(args, format);\r\nn = vsnprintf(xmon_outbuf, sizeof(xmon_outbuf), format, args);\r\nva_end(args);\r\nxmon_write(xmon_outbuf, n);\r\n}\r\nvoid xmon_puts(const char *str)\r\n{\r\nxmon_write(str, strlen(str));\r\n}

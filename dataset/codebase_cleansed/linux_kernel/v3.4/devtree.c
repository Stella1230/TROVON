void __init early_init_dt_add_memory_arch(u64 base, u64 size)\r\n{\r\narm_add_memory(base, size);\r\n}\r\nvoid * __init early_init_dt_alloc_memory_arch(u64 size, u64 align)\r\n{\r\nreturn alloc_bootmem_align(size, align);\r\n}\r\nvoid __init arm_dt_memblock_reserve(void)\r\n{\r\nu64 *reserve_map, base, size;\r\nif (!initial_boot_params)\r\nreturn;\r\nmemblock_reserve(virt_to_phys(initial_boot_params),\r\nbe32_to_cpu(initial_boot_params->totalsize));\r\nreserve_map = ((void*)initial_boot_params) +\r\nbe32_to_cpu(initial_boot_params->off_mem_rsvmap);\r\nwhile (1) {\r\nbase = be64_to_cpup(reserve_map++);\r\nsize = be64_to_cpup(reserve_map++);\r\nif (!size)\r\nbreak;\r\nmemblock_reserve(base, size);\r\n}\r\n}\r\nstruct machine_desc * __init setup_machine_fdt(unsigned int dt_phys)\r\n{\r\nstruct boot_param_header *devtree;\r\nstruct machine_desc *mdesc, *mdesc_best = NULL;\r\nunsigned int score, mdesc_score = ~1;\r\nunsigned long dt_root;\r\nconst char *model;\r\nif (!dt_phys)\r\nreturn NULL;\r\ndevtree = phys_to_virt(dt_phys);\r\nif (be32_to_cpu(devtree->magic) != OF_DT_HEADER)\r\nreturn NULL;\r\ninitial_boot_params = devtree;\r\ndt_root = of_get_flat_dt_root();\r\nfor_each_machine_desc(mdesc) {\r\nscore = of_flat_dt_match(dt_root, mdesc->dt_compat);\r\nif (score > 0 && score < mdesc_score) {\r\nmdesc_best = mdesc;\r\nmdesc_score = score;\r\n}\r\n}\r\nif (!mdesc_best) {\r\nconst char *prop;\r\nlong size;\r\nearly_print("\nError: unrecognized/unsupported "\r\n"device tree compatible list:\n[ ");\r\nprop = of_get_flat_dt_prop(dt_root, "compatible", &size);\r\nwhile (size > 0) {\r\nearly_print("'%s' ", prop);\r\nsize -= strlen(prop) + 1;\r\nprop += strlen(prop) + 1;\r\n}\r\nearly_print("]\n\n");\r\ndump_machine_table();\r\n}\r\nmodel = of_get_flat_dt_prop(dt_root, "model", NULL);\r\nif (!model)\r\nmodel = of_get_flat_dt_prop(dt_root, "compatible", NULL);\r\nif (!model)\r\nmodel = "<unknown>";\r\npr_info("Machine: %s, model: %s\n", mdesc_best->name, model);\r\nof_scan_flat_dt(early_init_dt_scan_chosen, boot_command_line);\r\nof_scan_flat_dt(early_init_dt_scan_root, NULL);\r\nof_scan_flat_dt(early_init_dt_scan_memory, NULL);\r\n__machine_arch_type = mdesc_best->nr;\r\nreturn mdesc_best;\r\n}

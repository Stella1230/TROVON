static inline u8 gige_read8(struct ssb_gige *dev, u16 offset)\r\n{\r\nreturn ssb_read8(dev->dev, offset);\r\n}\r\nstatic inline u16 gige_read16(struct ssb_gige *dev, u16 offset)\r\n{\r\nreturn ssb_read16(dev->dev, offset);\r\n}\r\nstatic inline u32 gige_read32(struct ssb_gige *dev, u16 offset)\r\n{\r\nreturn ssb_read32(dev->dev, offset);\r\n}\r\nstatic inline void gige_write8(struct ssb_gige *dev,\r\nu16 offset, u8 value)\r\n{\r\nssb_write8(dev->dev, offset, value);\r\n}\r\nstatic inline void gige_write16(struct ssb_gige *dev,\r\nu16 offset, u16 value)\r\n{\r\nssb_write16(dev->dev, offset, value);\r\n}\r\nstatic inline void gige_write32(struct ssb_gige *dev,\r\nu16 offset, u32 value)\r\n{\r\nssb_write32(dev->dev, offset, value);\r\n}\r\nstatic inline\r\nu8 gige_pcicfg_read8(struct ssb_gige *dev, unsigned int offset)\r\n{\r\nBUG_ON(offset >= 256);\r\nreturn gige_read8(dev, SSB_GIGE_PCICFG + offset);\r\n}\r\nstatic inline\r\nu16 gige_pcicfg_read16(struct ssb_gige *dev, unsigned int offset)\r\n{\r\nBUG_ON(offset >= 256);\r\nreturn gige_read16(dev, SSB_GIGE_PCICFG + offset);\r\n}\r\nstatic inline\r\nu32 gige_pcicfg_read32(struct ssb_gige *dev, unsigned int offset)\r\n{\r\nBUG_ON(offset >= 256);\r\nreturn gige_read32(dev, SSB_GIGE_PCICFG + offset);\r\n}\r\nstatic inline\r\nvoid gige_pcicfg_write8(struct ssb_gige *dev,\r\nunsigned int offset, u8 value)\r\n{\r\nBUG_ON(offset >= 256);\r\ngige_write8(dev, SSB_GIGE_PCICFG + offset, value);\r\n}\r\nstatic inline\r\nvoid gige_pcicfg_write16(struct ssb_gige *dev,\r\nunsigned int offset, u16 value)\r\n{\r\nBUG_ON(offset >= 256);\r\ngige_write16(dev, SSB_GIGE_PCICFG + offset, value);\r\n}\r\nstatic inline\r\nvoid gige_pcicfg_write32(struct ssb_gige *dev,\r\nunsigned int offset, u32 value)\r\n{\r\nBUG_ON(offset >= 256);\r\ngige_write32(dev, SSB_GIGE_PCICFG + offset, value);\r\n}\r\nstatic int __devinit ssb_gige_pci_read_config(struct pci_bus *bus,\r\nunsigned int devfn, int reg,\r\nint size, u32 *val)\r\n{\r\nstruct ssb_gige *dev = container_of(bus->ops, struct ssb_gige, pci_ops);\r\nunsigned long flags;\r\nif ((PCI_SLOT(devfn) > 0) || (PCI_FUNC(devfn) > 0))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (reg >= 256)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nspin_lock_irqsave(&dev->lock, flags);\r\nswitch (size) {\r\ncase 1:\r\n*val = gige_pcicfg_read8(dev, reg);\r\nbreak;\r\ncase 2:\r\n*val = gige_pcicfg_read16(dev, reg);\r\nbreak;\r\ncase 4:\r\n*val = gige_pcicfg_read32(dev, reg);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int __devinit ssb_gige_pci_write_config(struct pci_bus *bus,\r\nunsigned int devfn, int reg,\r\nint size, u32 val)\r\n{\r\nstruct ssb_gige *dev = container_of(bus->ops, struct ssb_gige, pci_ops);\r\nunsigned long flags;\r\nif ((PCI_SLOT(devfn) > 0) || (PCI_FUNC(devfn) > 0))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (reg >= 256)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nspin_lock_irqsave(&dev->lock, flags);\r\nswitch (size) {\r\ncase 1:\r\ngige_pcicfg_write8(dev, reg, val);\r\nbreak;\r\ncase 2:\r\ngige_pcicfg_write16(dev, reg, val);\r\nbreak;\r\ncase 4:\r\ngige_pcicfg_write32(dev, reg, val);\r\nbreak;\r\ndefault:\r\nWARN_ON(1);\r\n}\r\nspin_unlock_irqrestore(&dev->lock, flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int __devinit ssb_gige_probe(struct ssb_device *sdev,\r\nconst struct ssb_device_id *id)\r\n{\r\nstruct ssb_gige *dev;\r\nu32 base, tmslow, tmshigh;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\ndev->dev = sdev;\r\nspin_lock_init(&dev->lock);\r\ndev->pci_controller.pci_ops = &dev->pci_ops;\r\ndev->pci_controller.io_resource = &dev->io_resource;\r\ndev->pci_controller.mem_resource = &dev->mem_resource;\r\ndev->pci_controller.io_map_base = 0x800;\r\ndev->pci_ops.read = ssb_gige_pci_read_config;\r\ndev->pci_ops.write = ssb_gige_pci_write_config;\r\ndev->io_resource.name = SSB_GIGE_IO_RES_NAME;\r\ndev->io_resource.start = 0x800;\r\ndev->io_resource.end = 0x8FF;\r\ndev->io_resource.flags = IORESOURCE_IO | IORESOURCE_PCI_FIXED;\r\nif (!ssb_device_is_enabled(sdev))\r\nssb_device_enable(sdev, 0);\r\nbase = ssb_admatch_base(ssb_read32(sdev, SSB_ADMATCH1));\r\ngige_pcicfg_write32(dev, PCI_BASE_ADDRESS_0, base);\r\ngige_pcicfg_write32(dev, PCI_BASE_ADDRESS_1, 0);\r\ndev->mem_resource.name = SSB_GIGE_MEM_RES_NAME;\r\ndev->mem_resource.start = base;\r\ndev->mem_resource.end = base + 0x10000 - 1;\r\ndev->mem_resource.flags = IORESOURCE_MEM | IORESOURCE_PCI_FIXED;\r\ngige_pcicfg_write16(dev, PCI_COMMAND,\r\ngige_pcicfg_read16(dev, PCI_COMMAND)\r\n| PCI_COMMAND_MEMORY);\r\ngige_write32(dev, SSB_GIGE_SHIM_FLUSHSTAT, 0x00000068);\r\ntmslow = ssb_read32(sdev, SSB_TMSLOW);\r\ntmshigh = ssb_read32(sdev, SSB_TMSHIGH);\r\nif (tmshigh & SSB_GIGE_TMSHIGH_RGMII) {\r\ntmslow &= ~SSB_GIGE_TMSLOW_TXBYPASS;\r\ntmslow &= ~SSB_GIGE_TMSLOW_RXBYPASS;\r\ndev->has_rgmii = 1;\r\n} else {\r\ntmslow |= SSB_GIGE_TMSLOW_TXBYPASS;\r\ntmslow |= SSB_GIGE_TMSLOW_RXBYPASS;\r\ndev->has_rgmii = 0;\r\n}\r\ntmslow |= SSB_GIGE_TMSLOW_DLLEN;\r\nssb_write32(sdev, SSB_TMSLOW, tmslow);\r\nssb_set_drvdata(sdev, dev);\r\nregister_pci_controller(&dev->pci_controller);\r\nreturn 0;\r\n}\r\nbool pdev_is_ssb_gige_core(struct pci_dev *pdev)\r\n{\r\nif (!pdev->resource[0].name)\r\nreturn 0;\r\nreturn (strcmp(pdev->resource[0].name, SSB_GIGE_MEM_RES_NAME) == 0);\r\n}\r\nint ssb_gige_pcibios_plat_dev_init(struct ssb_device *sdev,\r\nstruct pci_dev *pdev)\r\n{\r\nstruct ssb_gige *dev = ssb_get_drvdata(sdev);\r\nstruct resource *res;\r\nif (pdev->bus->ops != &dev->pci_ops) {\r\nreturn -ENODEV;\r\n}\r\nres = &(pdev->resource[0]);\r\nres->flags = IORESOURCE_MEM | IORESOURCE_PCI_FIXED;\r\nres->name = dev->mem_resource.name;\r\nres->start = dev->mem_resource.start;\r\nres->end = dev->mem_resource.end;\r\npdev->irq = ssb_mips_irq(sdev) + 2;\r\npci_write_config_byte(pdev, PCI_INTERRUPT_LINE, pdev->irq);\r\nreturn 0;\r\n}\r\nint ssb_gige_map_irq(struct ssb_device *sdev,\r\nconst struct pci_dev *pdev)\r\n{\r\nstruct ssb_gige *dev = ssb_get_drvdata(sdev);\r\nif (pdev->bus->ops != &dev->pci_ops) {\r\nreturn -ENODEV;\r\n}\r\nreturn ssb_mips_irq(sdev) + 2;\r\n}\r\nint ssb_gige_init(void)\r\n{\r\nreturn ssb_driver_register(&ssb_gige_driver);\r\n}

void\r\nPSvEnablePowerSaving(\r\nvoid *hDeviceContext,\r\nunsigned short wListenInterval\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned short wAID = pMgmt->wCurrAID | BIT14 | BIT15;\r\nVNSvOutPortW(pDevice->PortOffset + MAC_REG_PWBT, C_PWBT);\r\nif (pDevice->eOPMode != OP_MODE_ADHOC) {\r\nVNSvOutPortW(pDevice->PortOffset + MAC_REG_AIDATIM, wAID);\r\n} else {\r\nMACvWriteATIMW(pDevice->PortOffset, pMgmt->wCurrATIMWindow);\r\n}\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCFG, PSCFG_AUTOSLEEP);\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_TFTCTL, TFTCTL_HWUTSF);\r\nif (wListenInterval >= 2) {\r\nMACvRegBitsOff(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_ALBCN);\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_LNBCN);\r\npMgmt->wCountToWakeUp = wListenInterval;\r\n}\r\nelse {\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_ALBCN);\r\npMgmt->wCountToWakeUp = 0;\r\n}\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_PSEN);\r\npDevice->bEnablePSMode = true;\r\nif (pDevice->eOPMode == OP_MODE_ADHOC) {\r\n}\r\nelse if (pDevice->eOPMode == OP_MODE_INFRASTRUCTURE) {\r\nPSbSendNullPacket(pDevice);\r\n}\r\npDevice->bPWBitOn = true;\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "PS:Power Saving Mode Enable... \n");\r\nreturn;\r\n}\r\nvoid\r\nPSvDisablePowerSaving(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nMACbPSWakeup(pDevice->PortOffset);\r\nMACvRegBitsOff(pDevice->PortOffset, MAC_REG_PSCFG, PSCFG_AUTOSLEEP);\r\nMACvRegBitsOff(pDevice->PortOffset, MAC_REG_TFTCTL, TFTCTL_HWUTSF);\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_ALBCN);\r\npDevice->bEnablePSMode = false;\r\nif (pDevice->eOPMode == OP_MODE_INFRASTRUCTURE) {\r\nPSbSendNullPacket(pDevice);\r\n}\r\npDevice->bPWBitOn = false;\r\nreturn;\r\n}\r\nbool\r\nPSbConsiderPowerDown(\r\nvoid *hDeviceContext,\r\nbool bCheckRxDMA,\r\nbool bCheckCountToWakeUp\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int uIdx;\r\nif (MACbIsRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_PS))\r\nreturn true;\r\nif (pMgmt->eCurrMode != WMAC_MODE_IBSS_STA) {\r\nif (pMgmt->bInTIMWake)\r\nreturn false;\r\n}\r\nif (pDevice->bCmdRunning)\r\nreturn false;\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_PSEN);\r\nfor (uIdx = 0; uIdx < TYPE_MAXTD; uIdx ++) {\r\nif (pDevice->iTDUsed[uIdx] != 0)\r\nreturn false;\r\n}\r\nif (bCheckRxDMA &&\r\n((pDevice->dwIsr& ISR_RXDMA0) != 0) &&\r\n((pDevice->dwIsr & ISR_RXDMA1) != 0)){\r\nreturn false;\r\n}\r\nif (pMgmt->eCurrMode != WMAC_MODE_IBSS_STA) {\r\nif (bCheckCountToWakeUp &&\r\n(pMgmt->wCountToWakeUp == 0 || pMgmt->wCountToWakeUp == 1)) {\r\nreturn false;\r\n}\r\n}\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_GO2DOZE);\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Go to Doze ZZZZZZZZZZZZZZZ\n");\r\nreturn true;\r\n}\r\nvoid\r\nPSvSendPSPOLL(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nmemset(pMgmt->pbyPSPacketPool, 0, sizeof(STxMgmtPacket) + WLAN_HDR_ADDR2_LEN);\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyPSPacketPool;\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((unsigned char *)pTxPacket + sizeof(STxMgmtPacket));\r\npTxPacket->p80211Header->sA2.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_CTL) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_PSPOLL) |\r\nWLAN_SET_FC_PWRMGT(0)\r\n));\r\npTxPacket->p80211Header->sA2.wDurationID = pMgmt->wCurrAID | BIT14 | BIT15;\r\nmemcpy(pTxPacket->p80211Header->sA2.abyAddr1, pMgmt->abyCurrBSSID, WLAN_ADDR_LEN);\r\nmemcpy(pTxPacket->p80211Header->sA2.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\npTxPacket->cbMPDULen = WLAN_HDR_ADDR2_LEN;\r\npTxPacket->cbPayloadLen = 0;\r\nif (csMgmt_xmit(pDevice, pTxPacket) != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Send PS-Poll packet failed..\n");\r\n}\r\nelse {\r\n};\r\nreturn;\r\n}\r\nbool\r\nPSbSendNullPacket(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSTxMgmtPacket pTxPacket = NULL;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nunsigned int uIdx;\r\nif (pDevice->bLinkPass == false) {\r\nreturn false;\r\n}\r\n#ifdef TxInSleep\r\nif ((pDevice->bEnablePSMode == false) &&\r\n(pDevice->fTxDataInSleep == false)){\r\nreturn false;\r\n}\r\n#else\r\nif (pDevice->bEnablePSMode == false) {\r\nreturn false;\r\n}\r\n#endif\r\nif (pDevice->bEnablePSMode) {\r\nfor (uIdx = 0; uIdx < TYPE_MAXTD; uIdx ++) {\r\nif (pDevice->iTDUsed[uIdx] != 0)\r\nreturn false;\r\n}\r\n}\r\nmemset(pMgmt->pbyPSPacketPool, 0, sizeof(STxMgmtPacket) + WLAN_NULLDATA_FR_MAXLEN);\r\npTxPacket = (PSTxMgmtPacket)pMgmt->pbyPSPacketPool;\r\npTxPacket->p80211Header = (PUWLAN_80211HDR)((unsigned char *)pTxPacket + sizeof(STxMgmtPacket));\r\nif (pDevice->bEnablePSMode) {\r\npTxPacket->p80211Header->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_DATA) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_NULL) |\r\nWLAN_SET_FC_PWRMGT(1)\r\n));\r\n}\r\nelse {\r\npTxPacket->p80211Header->sA3.wFrameCtl = cpu_to_le16(\r\n(\r\nWLAN_SET_FC_FTYPE(WLAN_TYPE_DATA) |\r\nWLAN_SET_FC_FSTYPE(WLAN_FSTYPE_NULL) |\r\nWLAN_SET_FC_PWRMGT(0)\r\n));\r\n}\r\nif(pMgmt->eCurrMode != WMAC_MODE_IBSS_STA) {\r\npTxPacket->p80211Header->sA3.wFrameCtl |= cpu_to_le16((unsigned short)WLAN_SET_FC_TODS(1));\r\n}\r\nmemcpy(pTxPacket->p80211Header->sA3.abyAddr1, pMgmt->abyCurrBSSID, WLAN_ADDR_LEN);\r\nmemcpy(pTxPacket->p80211Header->sA3.abyAddr2, pMgmt->abyMACAddr, WLAN_ADDR_LEN);\r\nmemcpy(pTxPacket->p80211Header->sA3.abyAddr3, pMgmt->abyCurrBSSID, WLAN_BSSID_LEN);\r\npTxPacket->cbMPDULen = WLAN_HDR_ADDR3_LEN;\r\npTxPacket->cbPayloadLen = 0;\r\nif (csMgmt_xmit(pDevice, pTxPacket) != CMD_STATUS_PENDING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO "Send Null Packet failed !\n");\r\nreturn false;\r\n}\r\nelse {\r\n}\r\nreturn true ;\r\n}\r\nbool\r\nPSbIsNextTBTTWakeUp(\r\nvoid *hDeviceContext\r\n)\r\n{\r\nPSDevice pDevice = (PSDevice)hDeviceContext;\r\nPSMgmtObject pMgmt = pDevice->pMgmt;\r\nbool bWakeUp = false;\r\nif (pMgmt->wListenInterval >= 2) {\r\nif (pMgmt->wCountToWakeUp == 0) {\r\npMgmt->wCountToWakeUp = pMgmt->wListenInterval;\r\n}\r\npMgmt->wCountToWakeUp --;\r\nif (pMgmt->wCountToWakeUp == 1) {\r\nMACvRegBitsOn(pDevice->PortOffset, MAC_REG_PSCTL, PSCTL_LNBCN);\r\nbWakeUp = true;\r\n}\r\n}\r\nreturn bWakeUp;\r\n}

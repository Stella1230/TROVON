static int ohci_xls_probe_internal(const struct hc_driver *driver,\r\nstruct platform_device *dev)\r\n{\r\nstruct resource *res;\r\nstruct usb_hcd *hcd;\r\nint retval, irq;\r\nirq = platform_get_irq(dev, 0);\r\nif (irq < 0) {\r\ndev_err(&dev->dev, "Found HC with no IRQ\n");\r\nreturn -ENODEV;\r\n}\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&dev->dev, "MMIO Handle incorrect!\n");\r\nreturn -ENODEV;\r\n}\r\nhcd = usb_create_hcd(driver, &dev->dev, "XLS");\r\nif (!hcd) {\r\nretval = -ENOMEM;\r\ngoto err1;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len,\r\ndriver->description)) {\r\ndev_dbg(&dev->dev, "Controller already in use\n");\r\nretval = -EBUSY;\r\ngoto err2;\r\n}\r\nhcd->regs = ioremap_nocache(hcd->rsrc_start, hcd->rsrc_len);\r\nif (hcd->regs == NULL) {\r\ndev_dbg(&dev->dev, "error mapping memory\n");\r\nretval = -EFAULT;\r\ngoto err3;\r\n}\r\nretval = usb_add_hcd(hcd, irq, IRQF_DISABLED | IRQF_SHARED);\r\nif (retval != 0)\r\ngoto err4;\r\nreturn retval;\r\nerr4:\r\niounmap(hcd->regs);\r\nerr3:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nerr2:\r\nusb_put_hcd(hcd);\r\nerr1:\r\ndev_err(&dev->dev, "init fail, %d\n", retval);\r\nreturn retval;\r\n}\r\nstatic int ohci_xls_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nohci_hcd_init(ohci);\r\nreturn ohci_init(ohci);\r\n}\r\nstatic int __devinit ohci_xls_start(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci;\r\nint ret;\r\nohci = hcd_to_ohci(hcd);\r\nret = ohci_run(ohci);\r\nif (ret < 0) {\r\nerr("can't start %s", hcd->self.bus_name);\r\nohci_stop(hcd);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ohci_xls_probe(struct platform_device *dev)\r\n{\r\nint ret;\r\npr_debug("In ohci_xls_probe");\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nret = ohci_xls_probe_internal(&ohci_xls_hc_driver, dev);\r\nreturn ret;\r\n}\r\nstatic int ohci_xls_remove(struct platform_device *dev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(dev);\r\nusb_remove_hcd(hcd);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

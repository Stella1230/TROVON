static void wm831x_pd_data_work(struct work_struct *work)\r\n{\r\nstruct wm831x_ts *wm831x_ts =\r\ncontainer_of(work, struct wm831x_ts, pd_data_work);\r\nif (wm831x_ts->pen_down) {\r\nenable_irq(wm831x_ts->data_irq);\r\ndev_dbg(wm831x_ts->wm831x->dev, "IRQ PD->DATA done\n");\r\n} else {\r\nenable_irq(wm831x_ts->pd_irq);\r\ndev_dbg(wm831x_ts->wm831x->dev, "IRQ DATA->PD done\n");\r\n}\r\n}\r\nstatic irqreturn_t wm831x_ts_data_irq(int irq, void *irq_data)\r\n{\r\nstruct wm831x_ts *wm831x_ts = irq_data;\r\nstruct wm831x *wm831x = wm831x_ts->wm831x;\r\nstatic int data_types[] = { ABS_X, ABS_Y, ABS_PRESSURE };\r\nu16 data[3];\r\nint count;\r\nint i, ret;\r\nif (wm831x_ts->pressure)\r\ncount = 3;\r\nelse\r\ncount = 2;\r\nwm831x_set_bits(wm831x, WM831X_INTERRUPT_STATUS_1,\r\nWM831X_TCHDATA_EINT, WM831X_TCHDATA_EINT);\r\nret = wm831x_bulk_read(wm831x, WM831X_TOUCH_DATA_X, count,\r\ndata);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to read touch data: %d\n",\r\nret);\r\nreturn IRQ_NONE;\r\n}\r\nwm831x_ts->pen_down = true;\r\nfor (i = 0; i < count; i++) {\r\nif (!(data[i] & WM831X_TCH_PD)) {\r\nwm831x_ts->pen_down = false;\r\ncontinue;\r\n}\r\ninput_report_abs(wm831x_ts->input_dev, data_types[i],\r\ndata[i] & WM831X_TCH_DATA_MASK);\r\n}\r\nif (!wm831x_ts->pen_down) {\r\ndev_dbg(wm831x->dev, "IRQ DATA->PD\n");\r\ndisable_irq_nosync(wm831x_ts->data_irq);\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_1,\r\nWM831X_TCH_X_ENA | WM831X_TCH_Y_ENA |\r\nWM831X_TCH_Z_ENA, 0);\r\nwm831x_set_bits(wm831x, WM831X_INTERRUPT_STATUS_1,\r\nWM831X_TCHDATA_EINT, WM831X_TCHDATA_EINT);\r\nwm831x_bulk_read(wm831x, WM831X_TOUCH_DATA_X, count, data);\r\nif (wm831x_ts->pressure)\r\ninput_report_abs(wm831x_ts->input_dev,\r\nABS_PRESSURE, 0);\r\ninput_report_key(wm831x_ts->input_dev, BTN_TOUCH, 0);\r\nschedule_work(&wm831x_ts->pd_data_work);\r\n} else {\r\ninput_report_key(wm831x_ts->input_dev, BTN_TOUCH, 1);\r\n}\r\ninput_sync(wm831x_ts->input_dev);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wm831x_ts_pen_down_irq(int irq, void *irq_data)\r\n{\r\nstruct wm831x_ts *wm831x_ts = irq_data;\r\nstruct wm831x *wm831x = wm831x_ts->wm831x;\r\nint ena = 0;\r\nif (wm831x_ts->pen_down)\r\nreturn IRQ_HANDLED;\r\ndisable_irq_nosync(wm831x_ts->pd_irq);\r\nif (wm831x_ts->pressure)\r\nena |= WM831X_TCH_Z_ENA;\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_1,\r\nWM831X_TCH_X_ENA | WM831X_TCH_Y_ENA | WM831X_TCH_Z_ENA,\r\nWM831X_TCH_X_ENA | WM831X_TCH_Y_ENA | ena);\r\nwm831x_set_bits(wm831x, WM831X_INTERRUPT_STATUS_1,\r\nWM831X_TCHPD_EINT, WM831X_TCHPD_EINT);\r\nwm831x_ts->pen_down = true;\r\ndev_dbg(wm831x->dev, "IRQ PD->DATA\n");\r\nschedule_work(&wm831x_ts->pd_data_work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm831x_ts_input_open(struct input_dev *idev)\r\n{\r\nstruct wm831x_ts *wm831x_ts = input_get_drvdata(idev);\r\nstruct wm831x *wm831x = wm831x_ts->wm831x;\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_1,\r\nWM831X_TCH_ENA | WM831X_TCH_CVT_ENA |\r\nWM831X_TCH_X_ENA | WM831X_TCH_Y_ENA |\r\nWM831X_TCH_Z_ENA, WM831X_TCH_ENA);\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_1,\r\nWM831X_TCH_CVT_ENA, WM831X_TCH_CVT_ENA);\r\nreturn 0;\r\n}\r\nstatic void wm831x_ts_input_close(struct input_dev *idev)\r\n{\r\nstruct wm831x_ts *wm831x_ts = input_get_drvdata(idev);\r\nstruct wm831x *wm831x = wm831x_ts->wm831x;\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_1,\r\nWM831X_TCH_ENA | WM831X_TCH_X_ENA |\r\nWM831X_TCH_Y_ENA | WM831X_TCH_Z_ENA, 0);\r\nsynchronize_irq(wm831x_ts->data_irq);\r\nsynchronize_irq(wm831x_ts->pd_irq);\r\nflush_work_sync(&wm831x_ts->pd_data_work);\r\nif (wm831x_ts->pen_down) {\r\ndisable_irq(wm831x_ts->data_irq);\r\nenable_irq(wm831x_ts->pd_irq);\r\nwm831x_ts->pen_down = false;\r\n}\r\n}\r\nstatic __devinit int wm831x_ts_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x_ts *wm831x_ts;\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *core_pdata = dev_get_platdata(pdev->dev.parent);\r\nstruct wm831x_touch_pdata *pdata = NULL;\r\nstruct input_dev *input_dev;\r\nint error, irqf;\r\nif (core_pdata)\r\npdata = core_pdata->touch;\r\nwm831x_ts = kzalloc(sizeof(struct wm831x_ts), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!wm831x_ts || !input_dev) {\r\nerror = -ENOMEM;\r\ngoto err_alloc;\r\n}\r\nwm831x_ts->wm831x = wm831x;\r\nwm831x_ts->input_dev = input_dev;\r\nINIT_WORK(&wm831x_ts->pd_data_work, wm831x_pd_data_work);\r\nif (pdata && pdata->data_irq)\r\nwm831x_ts->data_irq = pdata->data_irq;\r\nelse\r\nwm831x_ts->data_irq = platform_get_irq_byname(pdev, "TCHDATA");\r\nif (pdata && pdata->pd_irq)\r\nwm831x_ts->pd_irq = pdata->pd_irq;\r\nelse\r\nwm831x_ts->pd_irq = platform_get_irq_byname(pdev, "TCHPD");\r\nif (pdata)\r\nwm831x_ts->pressure = pdata->pressure;\r\nelse\r\nwm831x_ts->pressure = true;\r\nif (pdata && pdata->fivewire) {\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_2,\r\nWM831X_TCH_5WIRE, WM831X_TCH_5WIRE);\r\nWARN_ON(pdata->pressure && pdata->fivewire);\r\nwm831x_ts->pressure = false;\r\n} else {\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_2,\r\nWM831X_TCH_5WIRE, 0);\r\n}\r\nif (pdata) {\r\nswitch (pdata->isel) {\r\ndefault:\r\ndev_err(&pdev->dev, "Unsupported ISEL setting: %d\n",\r\npdata->isel);\r\ncase 200:\r\ncase 0:\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_2,\r\nWM831X_TCH_ISEL, 0);\r\nbreak;\r\ncase 400:\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_2,\r\nWM831X_TCH_ISEL, WM831X_TCH_ISEL);\r\nbreak;\r\n}\r\n}\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_2,\r\nWM831X_TCH_PDONLY, 0);\r\nwm831x_set_bits(wm831x, WM831X_TOUCH_CONTROL_1,\r\nWM831X_TCH_RATE_MASK, 6);\r\nif (pdata && pdata->data_irqf)\r\nirqf = pdata->data_irqf;\r\nelse\r\nirqf = IRQF_TRIGGER_HIGH;\r\nerror = request_threaded_irq(wm831x_ts->data_irq,\r\nNULL, wm831x_ts_data_irq,\r\nirqf | IRQF_ONESHOT,\r\n"Touchscreen data", wm831x_ts);\r\nif (error) {\r\ndev_err(&pdev->dev, "Failed to request data IRQ %d: %d\n",\r\nwm831x_ts->data_irq, error);\r\ngoto err_alloc;\r\n}\r\ndisable_irq(wm831x_ts->data_irq);\r\nif (pdata && pdata->pd_irqf)\r\nirqf = pdata->pd_irqf;\r\nelse\r\nirqf = IRQF_TRIGGER_HIGH;\r\nerror = request_threaded_irq(wm831x_ts->pd_irq,\r\nNULL, wm831x_ts_pen_down_irq,\r\nirqf | IRQF_ONESHOT,\r\n"Touchscreen pen down", wm831x_ts);\r\nif (error) {\r\ndev_err(&pdev->dev, "Failed to request pen down IRQ %d: %d\n",\r\nwm831x_ts->pd_irq, error);\r\ngoto err_data_irq;\r\n}\r\ninput_dev->name = "WM831x touchscreen";\r\ninput_dev->phys = "wm831x";\r\ninput_dev->open = wm831x_ts_input_open;\r\ninput_dev->close = wm831x_ts_input_close;\r\n__set_bit(EV_ABS, input_dev->evbit);\r\n__set_bit(EV_KEY, input_dev->evbit);\r\n__set_bit(BTN_TOUCH, input_dev->keybit);\r\ninput_set_abs_params(input_dev, ABS_X, 0, 4095, 5, 0);\r\ninput_set_abs_params(input_dev, ABS_Y, 0, 4095, 5, 0);\r\nif (wm831x_ts->pressure)\r\ninput_set_abs_params(input_dev, ABS_PRESSURE, 0, 4095, 5, 0);\r\ninput_set_drvdata(input_dev, wm831x_ts);\r\ninput_dev->dev.parent = &pdev->dev;\r\nerror = input_register_device(input_dev);\r\nif (error)\r\ngoto err_pd_irq;\r\nplatform_set_drvdata(pdev, wm831x_ts);\r\nreturn 0;\r\nerr_pd_irq:\r\nfree_irq(wm831x_ts->pd_irq, wm831x_ts);\r\nerr_data_irq:\r\nfree_irq(wm831x_ts->data_irq, wm831x_ts);\r\nerr_alloc:\r\ninput_free_device(input_dev);\r\nkfree(wm831x_ts);\r\nreturn error;\r\n}\r\nstatic __devexit int wm831x_ts_remove(struct platform_device *pdev)\r\n{\r\nstruct wm831x_ts *wm831x_ts = platform_get_drvdata(pdev);\r\nfree_irq(wm831x_ts->pd_irq, wm831x_ts);\r\nfree_irq(wm831x_ts->data_irq, wm831x_ts);\r\ninput_unregister_device(wm831x_ts->input_dev);\r\nkfree(wm831x_ts);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}

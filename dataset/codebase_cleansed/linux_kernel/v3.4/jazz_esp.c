static void jazz_esp_write8(struct esp *esp, u8 val, unsigned long reg)\r\n{\r\n*(volatile u8 *)(esp->regs + reg) = val;\r\n}\r\nstatic u8 jazz_esp_read8(struct esp *esp, unsigned long reg)\r\n{\r\nreturn *(volatile u8 *)(esp->regs + reg);\r\n}\r\nstatic dma_addr_t jazz_esp_map_single(struct esp *esp, void *buf,\r\nsize_t sz, int dir)\r\n{\r\nreturn dma_map_single(esp->dev, buf, sz, dir);\r\n}\r\nstatic int jazz_esp_map_sg(struct esp *esp, struct scatterlist *sg,\r\nint num_sg, int dir)\r\n{\r\nreturn dma_map_sg(esp->dev, sg, num_sg, dir);\r\n}\r\nstatic void jazz_esp_unmap_single(struct esp *esp, dma_addr_t addr,\r\nsize_t sz, int dir)\r\n{\r\ndma_unmap_single(esp->dev, addr, sz, dir);\r\n}\r\nstatic void jazz_esp_unmap_sg(struct esp *esp, struct scatterlist *sg,\r\nint num_sg, int dir)\r\n{\r\ndma_unmap_sg(esp->dev, sg, num_sg, dir);\r\n}\r\nstatic int jazz_esp_irq_pending(struct esp *esp)\r\n{\r\nif (jazz_esp_read8(esp, ESP_STATUS) & ESP_STAT_INTR)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void jazz_esp_reset_dma(struct esp *esp)\r\n{\r\nvdma_disable ((int)esp->dma_regs);\r\n}\r\nstatic void jazz_esp_dma_drain(struct esp *esp)\r\n{\r\n}\r\nstatic void jazz_esp_dma_invalidate(struct esp *esp)\r\n{\r\nvdma_disable ((int)esp->dma_regs);\r\n}\r\nstatic void jazz_esp_send_dma_cmd(struct esp *esp, u32 addr, u32 esp_count,\r\nu32 dma_count, int write, u8 cmd)\r\n{\r\nBUG_ON(!(cmd & ESP_CMD_DMA));\r\njazz_esp_write8(esp, (esp_count >> 0) & 0xff, ESP_TCLOW);\r\njazz_esp_write8(esp, (esp_count >> 8) & 0xff, ESP_TCMED);\r\nvdma_disable ((int)esp->dma_regs);\r\nif (write)\r\nvdma_set_mode ((int)esp->dma_regs, DMA_MODE_READ);\r\nelse\r\nvdma_set_mode ((int)esp->dma_regs, DMA_MODE_WRITE);\r\nvdma_set_addr ((int)esp->dma_regs, addr);\r\nvdma_set_count ((int)esp->dma_regs, dma_count);\r\nvdma_enable ((int)esp->dma_regs);\r\nscsi_esp_cmd(esp, cmd);\r\n}\r\nstatic int jazz_esp_dma_error(struct esp *esp)\r\n{\r\nu32 enable = vdma_get_enable((int)esp->dma_regs);\r\nif (enable & (R4030_MEM_INTR|R4030_ADDR_INTR))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic int __devinit esp_jazz_probe(struct platform_device *dev)\r\n{\r\nstruct scsi_host_template *tpnt = &scsi_esp_template;\r\nstruct Scsi_Host *host;\r\nstruct esp *esp;\r\nstruct resource *res;\r\nint err;\r\nhost = scsi_host_alloc(tpnt, sizeof(struct esp));\r\nerr = -ENOMEM;\r\nif (!host)\r\ngoto fail;\r\nhost->max_id = 8;\r\nesp = shost_priv(host);\r\nesp->host = host;\r\nesp->dev = dev;\r\nesp->ops = &jazz_esp_ops;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\ngoto fail_unlink;\r\nesp->regs = (void __iomem *)res->start;\r\nif (!esp->regs)\r\ngoto fail_unlink;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 1);\r\nif (!res)\r\ngoto fail_unlink;\r\nesp->dma_regs = (void __iomem *)res->start;\r\nesp->command_block = dma_alloc_coherent(esp->dev, 16,\r\n&esp->command_block_dma,\r\nGFP_KERNEL);\r\nif (!esp->command_block)\r\ngoto fail_unmap_regs;\r\nhost->irq = platform_get_irq(dev, 0);\r\nerr = request_irq(host->irq, scsi_esp_intr, IRQF_SHARED, "ESP", esp);\r\nif (err < 0)\r\ngoto fail_unmap_command_block;\r\nesp->scsi_id = 7;\r\nesp->host->this_id = esp->scsi_id;\r\nesp->scsi_id_mask = (1 << esp->scsi_id);\r\nesp->cfreq = 40000000;\r\ndev_set_drvdata(&dev->dev, esp);\r\nerr = scsi_esp_register(esp, &dev->dev);\r\nif (err)\r\ngoto fail_free_irq;\r\nreturn 0;\r\nfail_free_irq:\r\nfree_irq(host->irq, esp);\r\nfail_unmap_command_block:\r\ndma_free_coherent(esp->dev, 16,\r\nesp->command_block,\r\nesp->command_block_dma);\r\nfail_unmap_regs:\r\nfail_unlink:\r\nscsi_host_put(host);\r\nfail:\r\nreturn err;\r\n}\r\nstatic int __devexit esp_jazz_remove(struct platform_device *dev)\r\n{\r\nstruct esp *esp = dev_get_drvdata(&dev->dev);\r\nunsigned int irq = esp->host->irq;\r\nscsi_esp_unregister(esp);\r\nfree_irq(irq, esp);\r\ndma_free_coherent(esp->dev, 16,\r\nesp->command_block,\r\nesp->command_block_dma);\r\nscsi_host_put(esp->host);\r\nreturn 0;\r\n}\r\nstatic int __init jazz_esp_init(void)\r\n{\r\nreturn platform_driver_register(&esp_jazz_driver);\r\n}\r\nstatic void __exit jazz_esp_exit(void)\r\n{\r\nplatform_driver_unregister(&esp_jazz_driver);\r\n}

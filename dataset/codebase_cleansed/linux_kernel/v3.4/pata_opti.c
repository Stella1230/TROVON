static int opti_pre_reset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nstatic const struct pci_bits opti_enable_bits[] = {\r\n{ 0x45, 1, 0x80, 0x00 },\r\n{ 0x40, 1, 0x08, 0x00 }\r\n};\r\nif (!pci_test_config_bits(pdev, &opti_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void opti_write_reg(struct ata_port *ap, u8 val, int reg)\r\n{\r\nvoid __iomem *regio = ap->ioaddr.cmd_addr;\r\nioread16(regio + 1);\r\nioread16(regio + 1);\r\niowrite8(3, regio + 2);\r\niowrite8(val, regio + reg);\r\niowrite8(0x83, regio + 2);\r\n}\r\nstatic void opti_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct ata_device *pair = ata_dev_pair(adev);\r\nint clock;\r\nint pio = adev->pio_mode - XFER_PIO_0;\r\nvoid __iomem *regio = ap->ioaddr.cmd_addr;\r\nu8 addr;\r\nstatic const u8 addr_timing[2][5] = {\r\n{ 0x30, 0x20, 0x20, 0x10, 0x10 },\r\n{ 0x20, 0x20, 0x10, 0x10, 0x10 }\r\n};\r\nstatic const u8 data_rec_timing[2][5] = {\r\n{ 0x6B, 0x56, 0x42, 0x32, 0x31 },\r\n{ 0x58, 0x44, 0x32, 0x22, 0x21 }\r\n};\r\niowrite8(0xff, regio + 5);\r\nclock = ioread16(regio + 5) & 1;\r\naddr = addr_timing[clock][pio];\r\nif (pair) {\r\nu8 pair_addr = addr_timing[clock][pair->pio_mode - XFER_PIO_0];\r\nif (pair_addr > addr)\r\naddr = pair_addr;\r\n}\r\nopti_write_reg(ap, adev->devno, MISC_REG);\r\nopti_write_reg(ap, data_rec_timing[clock][pio], READ_REG);\r\nopti_write_reg(ap, data_rec_timing[clock][pio], WRITE_REG);\r\nopti_write_reg(ap, addr, MISC_REG);\r\nopti_write_reg(ap, 0x85, CNTRL_REG);\r\n}\r\nstatic int opti_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.port_ops = &opti_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nata_print_version_once(&dev->dev, DRV_VERSION);\r\nreturn ata_pci_sff_init_one(dev, ppi, &opti_sht, NULL, 0);\r\n}\r\nstatic int __init opti_init(void)\r\n{\r\nreturn pci_register_driver(&opti_pci_driver);\r\n}\r\nstatic void __exit opti_exit(void)\r\n{\r\npci_unregister_driver(&opti_pci_driver);\r\n}

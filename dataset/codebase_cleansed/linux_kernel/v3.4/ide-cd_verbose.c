void ide_cd_log_error(const char *name, struct request *failed_command,\r\nstruct request_sense *sense)\r\n{\r\nif (sense->sense_key == UNIT_ATTENTION ||\r\n(sense->sense_key == NOT_READY && (sense->asc == 4 ||\r\nsense->asc == 0x3a)))\r\nreturn;\r\nprintk(KERN_ERR "%s: error code: 0x%02x sense_key: 0x%02x "\r\n"asc: 0x%02x ascq: 0x%02x\n",\r\nname, sense->error_code, sense->sense_key,\r\nsense->asc, sense->ascq);\r\n}\r\nvoid ide_cd_log_error(const char *name, struct request *failed_command,\r\nstruct request_sense *sense)\r\n{\r\nint i;\r\nconst char *s = "bad sense key!";\r\nchar buf[80];\r\nprintk(KERN_ERR "ATAPI device %s:\n", name);\r\nif (sense->error_code == 0x70)\r\nprintk(KERN_CONT " Error: ");\r\nelse if (sense->error_code == 0x71)\r\nprintk(" Deferred Error: ");\r\nelse if (sense->error_code == 0x7f)\r\nprintk(KERN_CONT " Vendor-specific Error: ");\r\nelse\r\nprintk(KERN_CONT " Unknown Error Type: ");\r\nif (sense->sense_key < ARRAY_SIZE(sense_key_texts))\r\ns = sense_key_texts[sense->sense_key];\r\nprintk(KERN_CONT "%s -- (Sense key=0x%02x)\n", s, sense->sense_key);\r\nif (sense->asc == 0x40) {\r\nsprintf(buf, "Diagnostic failure on component 0x%02x",\r\nsense->ascq);\r\ns = buf;\r\n} else {\r\nint lo = 0, mid, hi = ARRAY_SIZE(sense_data_texts);\r\nunsigned long key = (sense->sense_key << 16);\r\nkey |= (sense->asc << 8);\r\nif (!(sense->ascq >= 0x80 && sense->ascq <= 0xdd))\r\nkey |= sense->ascq;\r\ns = NULL;\r\nwhile (hi > lo) {\r\nmid = (lo + hi) / 2;\r\nif (sense_data_texts[mid].asc_ascq == key ||\r\nsense_data_texts[mid].asc_ascq == (0xff0000|key)) {\r\ns = sense_data_texts[mid].text;\r\nbreak;\r\n} else if (sense_data_texts[mid].asc_ascq > key)\r\nhi = mid;\r\nelse\r\nlo = mid + 1;\r\n}\r\n}\r\nif (s == NULL) {\r\nif (sense->asc > 0x80)\r\ns = "(vendor-specific error)";\r\nelse\r\ns = "(reserved error code)";\r\n}\r\nprintk(KERN_ERR " %s -- (asc=0x%02x, ascq=0x%02x)\n",\r\ns, sense->asc, sense->ascq);\r\nif (failed_command != NULL) {\r\nint lo = 0, mid, hi = ARRAY_SIZE(packet_command_texts);\r\ns = NULL;\r\nwhile (hi > lo) {\r\nmid = (lo + hi) / 2;\r\nif (packet_command_texts[mid].packet_command ==\r\nfailed_command->cmd[0]) {\r\ns = packet_command_texts[mid].text;\r\nbreak;\r\n}\r\nif (packet_command_texts[mid].packet_command >\r\nfailed_command->cmd[0])\r\nhi = mid;\r\nelse\r\nlo = mid + 1;\r\n}\r\nprintk(KERN_ERR " The failed \"%s\" packet command "\r\n"was: \n \"", s);\r\nfor (i = 0; i < BLK_MAX_CDB; i++)\r\nprintk(KERN_CONT "%02x ", failed_command->cmd[i]);\r\nprintk(KERN_CONT "\"\n");\r\n}\r\nif (sense->sense_key == NOT_READY && (sense->sks[0] & 0x80)) {\r\nint progress = (sense->sks[1] << 8 | sense->sks[2]) * 100;\r\nprintk(KERN_ERR " Command is %02d%% complete\n",\r\nprogress / 0xffff);\r\n}\r\nif (sense->sense_key == ILLEGAL_REQUEST &&\r\n(sense->sks[0] & 0x80) != 0) {\r\nprintk(KERN_ERR " Error in %s byte %d",\r\n(sense->sks[0] & 0x40) != 0 ?\r\n"command packet" : "command data",\r\n(sense->sks[1] << 8) + sense->sks[2]);\r\nif ((sense->sks[0] & 0x40) != 0)\r\nprintk(KERN_CONT " bit %d", sense->sks[0] & 0x07);\r\nprintk(KERN_CONT "\n");\r\n}\r\n}

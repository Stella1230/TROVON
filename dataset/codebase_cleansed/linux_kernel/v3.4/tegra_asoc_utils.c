int tegra_asoc_utils_set_rate(struct tegra_asoc_utils_data *data, int srate,\r\nint mclk)\r\n{\r\nint new_baseclock;\r\nbool clk_change;\r\nint err;\r\nswitch (srate) {\r\ncase 11025:\r\ncase 22050:\r\ncase 44100:\r\ncase 88200:\r\nnew_baseclock = 56448000;\r\nbreak;\r\ncase 8000:\r\ncase 16000:\r\ncase 32000:\r\ncase 48000:\r\ncase 64000:\r\ncase 96000:\r\nnew_baseclock = 73728000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nclk_change = ((new_baseclock != data->set_baseclock) ||\r\n(mclk != data->set_mclk));\r\nif (!clk_change)\r\nreturn 0;\r\ndata->set_baseclock = 0;\r\ndata->set_mclk = 0;\r\nclk_disable(data->clk_cdev1);\r\nclk_disable(data->clk_pll_a_out0);\r\nclk_disable(data->clk_pll_a);\r\nerr = clk_set_rate(data->clk_pll_a, new_baseclock);\r\nif (err) {\r\ndev_err(data->dev, "Can't set pll_a rate: %d\n", err);\r\nreturn err;\r\n}\r\nerr = clk_set_rate(data->clk_pll_a_out0, mclk);\r\nif (err) {\r\ndev_err(data->dev, "Can't set pll_a_out0 rate: %d\n", err);\r\nreturn err;\r\n}\r\nerr = clk_enable(data->clk_pll_a);\r\nif (err) {\r\ndev_err(data->dev, "Can't enable pll_a: %d\n", err);\r\nreturn err;\r\n}\r\nerr = clk_enable(data->clk_pll_a_out0);\r\nif (err) {\r\ndev_err(data->dev, "Can't enable pll_a_out0: %d\n", err);\r\nreturn err;\r\n}\r\nerr = clk_enable(data->clk_cdev1);\r\nif (err) {\r\ndev_err(data->dev, "Can't enable cdev1: %d\n", err);\r\nreturn err;\r\n}\r\ndata->set_baseclock = new_baseclock;\r\ndata->set_mclk = mclk;\r\nreturn 0;\r\n}\r\nint tegra_asoc_utils_init(struct tegra_asoc_utils_data *data,\r\nstruct device *dev)\r\n{\r\nint ret;\r\ndata->dev = dev;\r\ndata->clk_pll_a = clk_get_sys(NULL, "pll_a");\r\nif (IS_ERR(data->clk_pll_a)) {\r\ndev_err(data->dev, "Can't retrieve clk pll_a\n");\r\nret = PTR_ERR(data->clk_pll_a);\r\ngoto err;\r\n}\r\ndata->clk_pll_a_out0 = clk_get_sys(NULL, "pll_a_out0");\r\nif (IS_ERR(data->clk_pll_a_out0)) {\r\ndev_err(data->dev, "Can't retrieve clk pll_a_out0\n");\r\nret = PTR_ERR(data->clk_pll_a_out0);\r\ngoto err_put_pll_a;\r\n}\r\ndata->clk_cdev1 = clk_get_sys(NULL, "cdev1");\r\nif (IS_ERR(data->clk_cdev1)) {\r\ndev_err(data->dev, "Can't retrieve clk cdev1\n");\r\nret = PTR_ERR(data->clk_cdev1);\r\ngoto err_put_pll_a_out0;\r\n}\r\nreturn 0;\r\nerr_put_pll_a_out0:\r\nclk_put(data->clk_pll_a_out0);\r\nerr_put_pll_a:\r\nclk_put(data->clk_pll_a);\r\nerr:\r\nreturn ret;\r\n}\r\nvoid tegra_asoc_utils_fini(struct tegra_asoc_utils_data *data)\r\n{\r\nclk_put(data->clk_cdev1);\r\nclk_put(data->clk_pll_a_out0);\r\nclk_put(data->clk_pll_a);\r\n}

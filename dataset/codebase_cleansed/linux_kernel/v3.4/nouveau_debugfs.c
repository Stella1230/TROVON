static int\r\nnouveau_debugfs_channel_info(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct nouveau_channel *chan = node->info_ent->data;\r\nseq_printf(m, "channel id : %d\n", chan->id);\r\nseq_printf(m, "cpu fifo state:\n");\r\nseq_printf(m, " base: 0x%10llx\n", chan->pushbuf_base);\r\nseq_printf(m, " max: 0x%08x\n", chan->dma.max << 2);\r\nseq_printf(m, " cur: 0x%08x\n", chan->dma.cur << 2);\r\nseq_printf(m, " put: 0x%08x\n", chan->dma.put << 2);\r\nseq_printf(m, " free: 0x%08x\n", chan->dma.free << 2);\r\nif (chan->dma.ib_max) {\r\nseq_printf(m, " ib max: 0x%08x\n", chan->dma.ib_max);\r\nseq_printf(m, " ib put: 0x%08x\n", chan->dma.ib_put);\r\nseq_printf(m, " ib free: 0x%08x\n", chan->dma.ib_free);\r\n}\r\nseq_printf(m, "gpu fifo state:\n");\r\nseq_printf(m, " get: 0x%08x\n",\r\nnvchan_rd32(chan, chan->user_get));\r\nseq_printf(m, " put: 0x%08x\n",\r\nnvchan_rd32(chan, chan->user_put));\r\nif (chan->dma.ib_max) {\r\nseq_printf(m, " ib get: 0x%08x\n",\r\nnvchan_rd32(chan, 0x88));\r\nseq_printf(m, " ib put: 0x%08x\n",\r\nnvchan_rd32(chan, 0x8c));\r\n}\r\nseq_printf(m, "last fence : %d\n", chan->fence.sequence);\r\nseq_printf(m, "last signalled: %d\n", chan->fence.sequence_ack);\r\nreturn 0;\r\n}\r\nint\r\nnouveau_debugfs_channel_init(struct nouveau_channel *chan)\r\n{\r\nstruct drm_nouveau_private *dev_priv = chan->dev->dev_private;\r\nstruct drm_minor *minor = chan->dev->primary;\r\nint ret;\r\nif (!dev_priv->debugfs.channel_root) {\r\ndev_priv->debugfs.channel_root =\r\ndebugfs_create_dir("channel", minor->debugfs_root);\r\nif (!dev_priv->debugfs.channel_root)\r\nreturn -ENOENT;\r\n}\r\nsnprintf(chan->debugfs.name, 32, "%d", chan->id);\r\nchan->debugfs.info.name = chan->debugfs.name;\r\nchan->debugfs.info.show = nouveau_debugfs_channel_info;\r\nchan->debugfs.info.driver_features = 0;\r\nchan->debugfs.info.data = chan;\r\nret = drm_debugfs_create_files(&chan->debugfs.info, 1,\r\ndev_priv->debugfs.channel_root,\r\nchan->dev->primary);\r\nif (ret == 0)\r\nchan->debugfs.active = true;\r\nreturn ret;\r\n}\r\nvoid\r\nnouveau_debugfs_channel_fini(struct nouveau_channel *chan)\r\n{\r\nstruct drm_nouveau_private *dev_priv = chan->dev->dev_private;\r\nif (!chan->debugfs.active)\r\nreturn;\r\ndrm_debugfs_remove_files(&chan->debugfs.info, 1, chan->dev->primary);\r\nchan->debugfs.active = false;\r\nif (chan == dev_priv->channel) {\r\ndebugfs_remove(dev_priv->debugfs.channel_root);\r\ndev_priv->debugfs.channel_root = NULL;\r\n}\r\n}\r\nstatic int\r\nnouveau_debugfs_chipset_info(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_minor *minor = node->minor;\r\nstruct drm_device *dev = minor->dev;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nuint32_t ppci_0;\r\nppci_0 = nv_rd32(dev, dev_priv->chipset >= 0x40 ? 0x88000 : 0x1800);\r\nseq_printf(m, "PMC_BOOT_0: 0x%08x\n", nv_rd32(dev, NV03_PMC_BOOT_0));\r\nseq_printf(m, "PCI ID : 0x%04x:0x%04x\n",\r\nppci_0 & 0xffff, ppci_0 >> 16);\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_debugfs_memory_info(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_minor *minor = node->minor;\r\nstruct drm_nouveau_private *dev_priv = minor->dev->dev_private;\r\nseq_printf(m, "VRAM total: %dKiB\n", (int)(dev_priv->vram_size >> 10));\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_debugfs_vbios_image(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_nouveau_private *dev_priv = node->minor->dev->dev_private;\r\nint i;\r\nfor (i = 0; i < dev_priv->vbios.length; i++)\r\nseq_printf(m, "%c", dev_priv->vbios.data[i]);\r\nreturn 0;\r\n}\r\nstatic int\r\nnouveau_debugfs_evict_vram(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_nouveau_private *dev_priv = node->minor->dev->dev_private;\r\nint ret;\r\nret = ttm_bo_evict_mm(&dev_priv->ttm.bdev, TTM_PL_VRAM);\r\nif (ret)\r\nseq_printf(m, "failed: %d", ret);\r\nelse\r\nseq_printf(m, "succeeded\n");\r\nreturn 0;\r\n}\r\nint\r\nnouveau_debugfs_init(struct drm_minor *minor)\r\n{\r\ndrm_debugfs_create_files(nouveau_debugfs_list, NOUVEAU_DEBUGFS_ENTRIES,\r\nminor->debugfs_root, minor);\r\nreturn 0;\r\n}\r\nvoid\r\nnouveau_debugfs_takedown(struct drm_minor *minor)\r\n{\r\ndrm_debugfs_remove_files(nouveau_debugfs_list, NOUVEAU_DEBUGFS_ENTRIES,\r\nminor);\r\n}

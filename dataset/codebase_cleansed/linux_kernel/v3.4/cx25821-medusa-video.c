static void medusa_enable_bluefield_output(struct cx25821_dev *dev, int channel,\r\nint enable)\r\n{\r\nint ret_val = 1;\r\nu32 value = 0;\r\nu32 tmp = 0;\r\nint out_ctrl = OUT_CTRL1;\r\nint out_ctrl_ns = OUT_CTRL_NS;\r\nswitch (channel) {\r\ndefault:\r\ncase VDEC_A:\r\nbreak;\r\ncase VDEC_B:\r\nout_ctrl = VDEC_B_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_B_OUT_CTRL_NS;\r\nbreak;\r\ncase VDEC_C:\r\nout_ctrl = VDEC_C_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_C_OUT_CTRL_NS;\r\nbreak;\r\ncase VDEC_D:\r\nout_ctrl = VDEC_D_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_D_OUT_CTRL_NS;\r\nbreak;\r\ncase VDEC_E:\r\nout_ctrl = VDEC_E_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_E_OUT_CTRL_NS;\r\nreturn;\r\ncase VDEC_F:\r\nout_ctrl = VDEC_F_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_F_OUT_CTRL_NS;\r\nreturn;\r\ncase VDEC_G:\r\nout_ctrl = VDEC_G_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_G_OUT_CTRL_NS;\r\nreturn;\r\ncase VDEC_H:\r\nout_ctrl = VDEC_H_OUT_CTRL1;\r\nout_ctrl_ns = VDEC_H_OUT_CTRL_NS;\r\nreturn;\r\n}\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], out_ctrl, &tmp);\r\nvalue &= 0xFFFFFF7F;\r\nif (enable)\r\nvalue |= 0x00000080;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], out_ctrl, value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], out_ctrl_ns, &tmp);\r\nvalue &= 0xFFFFFF7F;\r\nif (enable)\r\nvalue |= 0x00000080;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], out_ctrl_ns, value);\r\n}\r\nstatic int medusa_initialize_ntsc(struct cx25821_dev *dev)\r\n{\r\nint ret_val = 0;\r\nint i = 0;\r\nu32 value = 0;\r\nu32 tmp = 0;\r\nmutex_lock(&dev->lock);\r\nfor (i = 0; i < MAX_DECODERS; i++) {\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nMODE_CTRL + (0x200 * i), &tmp);\r\nvalue &= 0xFFFFFFF0;\r\nvalue |= 0x10001;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nMODE_CTRL + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nHORIZ_TIM_CTRL + (0x200 * i), &tmp);\r\nvalue &= 0x00C00C00;\r\nvalue |= 0x612D0074;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nHORIZ_TIM_CTRL + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVERT_TIM_CTRL + (0x200 * i), &tmp);\r\nvalue &= 0x00C00C00;\r\nvalue |= 0x1C1E001A;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nVERT_TIM_CTRL + (0x200 * i), value);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nSC_STEP_SIZE + (0x200 * i), 0x43E00000);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nOUT_CTRL_NS + (0x200 * i), &tmp);\r\nvalue &= 0xFFFBFFFF;\r\nvalue |= 0x00040000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nOUT_CTRL_NS + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nOUT_CTRL1 + (0x200 * i), &tmp);\r\nvalue &= 0xFFFBFFFF;\r\nvalue |= 0x00040000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nOUT_CTRL1 + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nMISC_TIM_CTRL + (0x200 * i), &tmp);\r\nvalue = setBitAtPos(value, 14);\r\nvalue = clearBitAtPos(value, 15);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nMISC_TIM_CTRL + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDFE_CTRL1 + (0x200 * i), &tmp);\r\nvalue = clearBitAtPos(value, 29);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDFE_CTRL1 + (0x200 * i), value);\r\nmedusa_enable_bluefield_output(dev, i, 1);\r\n}\r\nfor (i = 0; i < MAX_ENCODERS; i++) {\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_1 + (0x100 * i), &tmp);\r\nvalue &= 0xF000FC00;\r\nvalue |= 0x06B402D0;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_1 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_2 + (0x100 * i), &tmp);\r\nvalue &= 0xFF000000;\r\nvalue |= 0x007E9054;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_2 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_3 + (0x100 * i), &tmp);\r\nvalue &= 0xFC00FE00;\r\nvalue |= 0x00EC00F0;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_3 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_4 + (0x100 * i), &tmp);\r\nvalue &= 0x00FCFFFF;\r\nvalue |= 0x13020000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_4 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_5 + (0x100 * i), &tmp);\r\nvalue &= 0xFFFF0000;\r\nvalue |= 0x0000E575;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_5 + (0x100 * i), value);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_6 + (0x100 * i), 0x009A89C1);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_7 + (0x100 * i), 0x21F07C1F);\r\n}\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], HSCALE_CTRL, 0x0);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], VSCALE_CTRL, 0x0);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], BYP_AB_CTRL, &tmp);\r\nvalue |= 0x00080200;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], BYP_AB_CTRL, value);\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}\r\nstatic int medusa_PALCombInit(struct cx25821_dev *dev, int dec)\r\n{\r\nint ret_val = -1;\r\nu32 value = 0, tmp = 0;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nCOMB_2D_HFS_CFG + (0x200 * dec), 0x20002861);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nCOMB_2D_HFD_CFG + (0x200 * dec), 0x20002861);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nCOMB_2D_LF_CFG + (0x200 * dec), 0x200A1023);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nCOMB_FLAT_THRESH_CTRL + (0x200 * dec), &tmp);\r\nvalue &= 0x06230000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nCOMB_FLAT_THRESH_CTRL + (0x200 * dec), value);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nCOMB_2D_BLEND + (0x200 * dec), 0x210F0F0F);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nCOMB_MISC_CTRL + (0x200 * dec), 0x41120A7F);\r\nreturn ret_val;\r\n}\r\nstatic int medusa_initialize_pal(struct cx25821_dev *dev)\r\n{\r\nint ret_val = 0;\r\nint i = 0;\r\nu32 value = 0;\r\nu32 tmp = 0;\r\nmutex_lock(&dev->lock);\r\nfor (i = 0; i < MAX_DECODERS; i++) {\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nMODE_CTRL + (0x200 * i), &tmp);\r\nvalue &= 0xFFFFFFF0;\r\nvalue |= 0x10004;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nMODE_CTRL + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nHORIZ_TIM_CTRL + (0x200 * i), &tmp);\r\nvalue &= 0x00C00C00;\r\nvalue |= 0x632D007D;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nHORIZ_TIM_CTRL + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVERT_TIM_CTRL + (0x200 * i), &tmp);\r\nvalue &= 0x00C00C00;\r\nvalue |= 0x28240026;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nVERT_TIM_CTRL + (0x200 * i), value);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nSC_STEP_SIZE + (0x200 * i), 0x5411E2D0);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nOUT_CTRL_NS + (0x200 * i), &tmp);\r\nvalue &= 0xFFFBFFFF;\r\nvalue |= 0x00040000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nOUT_CTRL_NS + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nOUT_CTRL1 + (0x200 * i), &tmp);\r\nvalue &= 0xFFFBFFFF;\r\nvalue |= 0x00040000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nOUT_CTRL1 + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nMISC_TIM_CTRL + (0x200 * i), &tmp);\r\nvalue = setBitAtPos(value, 14);\r\nvalue = clearBitAtPos(value, 15);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nMISC_TIM_CTRL + (0x200 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDFE_CTRL1 + (0x200 * i), &tmp);\r\nvalue = clearBitAtPos(value, 29);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDFE_CTRL1 + (0x200 * i), value);\r\nmedusa_PALCombInit(dev, i);\r\nmedusa_enable_bluefield_output(dev, i, 1);\r\n}\r\nfor (i = 0; i < MAX_ENCODERS; i++) {\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_1 + (0x100 * i), &tmp);\r\nvalue &= 0xF000FC00;\r\nvalue |= 0x06C002D0;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_1 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_2 + (0x100 * i), &tmp);\r\nvalue &= 0xFF000000;\r\nvalue |= 0x007E9754;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_2 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_3 + (0x100 * i), &tmp);\r\nvalue &= 0xFC00FE00;\r\nvalue |= 0x00FC0120;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_3 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_4 + (0x100 * i), &tmp);\r\nvalue &= 0x00FCFFFF;\r\nvalue |= 0x14010000;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_4 + (0x100 * i), value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0],\r\nDENC_A_REG_5 + (0x100 * i), &tmp);\r\nvalue &= 0xFFFF0000;\r\nvalue |= 0x0000F078;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_5 + (0x100 * i), value);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_6 + (0x100 * i), 0x00A493CF);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nDENC_A_REG_7 + (0x100 * i), 0x2A098ACB);\r\n}\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], HSCALE_CTRL, 0x0);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], VSCALE_CTRL, 0x0);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], BYP_AB_CTRL, &tmp);\r\nvalue &= 0xFFF7FDFF;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], BYP_AB_CTRL, value);\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}\r\nint medusa_set_videostandard(struct cx25821_dev *dev)\r\n{\r\nint status = STATUS_SUCCESS;\r\nu32 value = 0, tmp = 0;\r\nif (dev->tvnorm & V4L2_STD_PAL_BG || dev->tvnorm & V4L2_STD_PAL_DK)\r\nstatus = medusa_initialize_pal(dev);\r\nelse\r\nstatus = medusa_initialize_ntsc(dev);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], DENC_A_REG_4, &tmp);\r\nvalue = setBitAtPos(value, 4);\r\nstatus = cx25821_i2c_write(&dev->i2c_bus[0], DENC_A_REG_4, value);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], DENC_B_REG_4, &tmp);\r\nvalue = setBitAtPos(value, 4);\r\nstatus = cx25821_i2c_write(&dev->i2c_bus[0], DENC_B_REG_4, value);\r\nreturn status;\r\n}\r\nvoid medusa_set_resolution(struct cx25821_dev *dev, int width,\r\nint decoder_select)\r\n{\r\nint decoder = 0;\r\nint decoder_count = 0;\r\nint ret_val = 0;\r\nu32 hscale = 0x0;\r\nu32 vscale = 0x0;\r\nconst int MAX_WIDTH = 720;\r\nmutex_lock(&dev->lock);\r\nif (width > MAX_WIDTH) {\r\npr_info("%s(): width %d > MAX_WIDTH %d ! resetting to MAX_WIDTH\n",\r\n__func__, width, MAX_WIDTH);\r\nwidth = MAX_WIDTH;\r\n}\r\nif (decoder_select <= 7 && decoder_select >= 0) {\r\ndecoder = decoder_select;\r\ndecoder_count = decoder_select + 1;\r\n} else {\r\ndecoder = 0;\r\ndecoder_count = _num_decoders;\r\n}\r\nswitch (width) {\r\ncase 320:\r\nhscale = 0x13E34B;\r\nvscale = 0x0;\r\nbreak;\r\ncase 352:\r\nhscale = 0x10A273;\r\nvscale = 0x0;\r\nbreak;\r\ncase 176:\r\nhscale = 0x3115B2;\r\nvscale = 0x1E00;\r\nbreak;\r\ncase 160:\r\nhscale = 0x378D84;\r\nvscale = 0x1E00;\r\nbreak;\r\ndefault:\r\nhscale = 0x0;\r\nvscale = 0x0;\r\nbreak;\r\n}\r\nfor (; decoder < decoder_count; decoder++) {\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nHSCALE_CTRL + (0x200 * decoder), hscale);\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0],\r\nVSCALE_CTRL + (0x200 * decoder), vscale);\r\n}\r\nmutex_unlock(&dev->lock);\r\n}\r\nstatic void medusa_set_decoderduration(struct cx25821_dev *dev, int decoder,\r\nint duration)\r\n{\r\nint ret_val = 0;\r\nu32 fld_cnt = 0;\r\nu32 tmp = 0;\r\nu32 disp_cnt_reg = DISP_AB_CNT;\r\nmutex_lock(&dev->lock);\r\nif (decoder < VDEC_A && decoder > VDEC_H) {\r\nmutex_unlock(&dev->lock);\r\nreturn;\r\n}\r\nswitch (decoder) {\r\ndefault:\r\nbreak;\r\ncase VDEC_C:\r\ncase VDEC_D:\r\ndisp_cnt_reg = DISP_CD_CNT;\r\nbreak;\r\ncase VDEC_E:\r\ncase VDEC_F:\r\ndisp_cnt_reg = DISP_EF_CNT;\r\nbreak;\r\ncase VDEC_G:\r\ncase VDEC_H:\r\ndisp_cnt_reg = DISP_GH_CNT;\r\nbreak;\r\n}\r\n_display_field_cnt[decoder] = duration;\r\nfld_cnt = cx25821_i2c_read(&dev->i2c_bus[0], disp_cnt_reg, &tmp);\r\nif (!(decoder % 2)) {\r\nfld_cnt &= 0xFFFF0000;\r\nfld_cnt |= duration;\r\n} else {\r\nfld_cnt &= 0x0000FFFF;\r\nfld_cnt |= ((u32) duration) << 16;\r\n}\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], disp_cnt_reg, fld_cnt);\r\nmutex_unlock(&dev->lock);\r\n}\r\nstatic int mapM(int srcMin, int srcMax, int srcVal, int dstMin, int dstMax,\r\nint *dstVal)\r\n{\r\nint numerator;\r\nint denominator;\r\nint quotient;\r\nif ((srcMin == srcMax) || (srcVal < srcMin) || (srcVal > srcMax))\r\nreturn -1;\r\nnumerator = (srcVal - srcMin) * (dstMax - dstMin);\r\ndenominator = srcMax - srcMin;\r\nquotient = numerator / denominator;\r\nif (2 * (numerator % denominator) >= denominator)\r\nquotient++;\r\n*dstVal = quotient + dstMin;\r\nreturn 0;\r\n}\r\nstatic unsigned long convert_to_twos(long numeric, unsigned long bits_len)\r\n{\r\nunsigned char temp;\r\nif (numeric >= 0)\r\nreturn numeric;\r\nelse {\r\ntemp = ~(abs(numeric) & 0xFF);\r\ntemp += 1;\r\nreturn temp;\r\n}\r\n}\r\nint medusa_set_brightness(struct cx25821_dev *dev, int brightness, int decoder)\r\n{\r\nint ret_val = 0;\r\nint value = 0;\r\nu32 val = 0, tmp = 0;\r\nmutex_lock(&dev->lock);\r\nif ((brightness > VIDEO_PROCAMP_MAX) ||\r\n(brightness < VIDEO_PROCAMP_MIN)) {\r\nmutex_unlock(&dev->lock);\r\nreturn -1;\r\n}\r\nret_val = mapM(VIDEO_PROCAMP_MIN, VIDEO_PROCAMP_MAX, brightness,\r\nSIGNED_BYTE_MIN, SIGNED_BYTE_MAX, &value);\r\nvalue = convert_to_twos(value, 8);\r\nval = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVDEC_A_BRITE_CTRL + (0x200 * decoder), &tmp);\r\nval &= 0xFFFFFF00;\r\nret_val |= cx25821_i2c_write(&dev->i2c_bus[0],\r\nVDEC_A_BRITE_CTRL + (0x200 * decoder), val | value);\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}\r\nint medusa_set_contrast(struct cx25821_dev *dev, int contrast, int decoder)\r\n{\r\nint ret_val = 0;\r\nint value = 0;\r\nu32 val = 0, tmp = 0;\r\nmutex_lock(&dev->lock);\r\nif ((contrast > VIDEO_PROCAMP_MAX) || (contrast < VIDEO_PROCAMP_MIN)) {\r\nmutex_unlock(&dev->lock);\r\nreturn -1;\r\n}\r\nret_val = mapM(VIDEO_PROCAMP_MIN, VIDEO_PROCAMP_MAX, contrast,\r\nUNSIGNED_BYTE_MIN, UNSIGNED_BYTE_MAX, &value);\r\nval = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVDEC_A_CNTRST_CTRL + (0x200 * decoder), &tmp);\r\nval &= 0xFFFFFF00;\r\nret_val |= cx25821_i2c_write(&dev->i2c_bus[0],\r\nVDEC_A_CNTRST_CTRL + (0x200 * decoder), val | value);\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}\r\nint medusa_set_hue(struct cx25821_dev *dev, int hue, int decoder)\r\n{\r\nint ret_val = 0;\r\nint value = 0;\r\nu32 val = 0, tmp = 0;\r\nmutex_lock(&dev->lock);\r\nif ((hue > VIDEO_PROCAMP_MAX) || (hue < VIDEO_PROCAMP_MIN)) {\r\nmutex_unlock(&dev->lock);\r\nreturn -1;\r\n}\r\nret_val = mapM(VIDEO_PROCAMP_MIN, VIDEO_PROCAMP_MAX, hue,\r\nSIGNED_BYTE_MIN, SIGNED_BYTE_MAX, &value);\r\nvalue = convert_to_twos(value, 8);\r\nval = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVDEC_A_HUE_CTRL + (0x200 * decoder), &tmp);\r\nval &= 0xFFFFFF00;\r\nret_val |= cx25821_i2c_write(&dev->i2c_bus[0],\r\nVDEC_A_HUE_CTRL + (0x200 * decoder), val | value);\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}\r\nint medusa_set_saturation(struct cx25821_dev *dev, int saturation, int decoder)\r\n{\r\nint ret_val = 0;\r\nint value = 0;\r\nu32 val = 0, tmp = 0;\r\nmutex_lock(&dev->lock);\r\nif ((saturation > VIDEO_PROCAMP_MAX) ||\r\n(saturation < VIDEO_PROCAMP_MIN)) {\r\nmutex_unlock(&dev->lock);\r\nreturn -1;\r\n}\r\nret_val = mapM(VIDEO_PROCAMP_MIN, VIDEO_PROCAMP_MAX, saturation,\r\nUNSIGNED_BYTE_MIN, UNSIGNED_BYTE_MAX, &value);\r\nval = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVDEC_A_USAT_CTRL + (0x200 * decoder), &tmp);\r\nval &= 0xFFFFFF00;\r\nret_val |= cx25821_i2c_write(&dev->i2c_bus[0],\r\nVDEC_A_USAT_CTRL + (0x200 * decoder), val | value);\r\nval = cx25821_i2c_read(&dev->i2c_bus[0],\r\nVDEC_A_VSAT_CTRL + (0x200 * decoder), &tmp);\r\nval &= 0xFFFFFF00;\r\nret_val |= cx25821_i2c_write(&dev->i2c_bus[0],\r\nVDEC_A_VSAT_CTRL + (0x200 * decoder), val | value);\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}\r\nint medusa_video_init(struct cx25821_dev *dev)\r\n{\r\nu32 value = 0, tmp = 0;\r\nint ret_val = 0;\r\nint i = 0;\r\nmutex_lock(&dev->lock);\r\n_num_decoders = dev->_max_num_decoders;\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], MON_A_CTRL, &tmp);\r\nvalue &= 0xFFFFF0FF;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], MON_A_CTRL, value);\r\nif (ret_val < 0)\r\ngoto error;\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], MON_A_CTRL, &tmp);\r\nvalue &= 0xFFFFFFDF;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], MON_A_CTRL, value);\r\nif (ret_val < 0)\r\ngoto error;\r\nmutex_unlock(&dev->lock);\r\nfor (i = 0; i < _num_decoders; i++)\r\nmedusa_set_decoderduration(dev, i, _display_field_cnt[i]);\r\nmutex_lock(&dev->lock);\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], DENC_AB_CTRL, &tmp);\r\nvalue &= 0xFF70FF70;\r\nvalue |= 0x00090008;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], DENC_AB_CTRL, value);\r\nif (ret_val < 0)\r\ngoto error;\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], BYP_AB_CTRL, &tmp);\r\nvalue |= 0x00040100;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], BYP_AB_CTRL, value);\r\nif (ret_val < 0)\r\ngoto error;\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], AFE_AB_DIAG_CTRL, &tmp);\r\nvalue &= 0x83FFFFFF;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], AFE_AB_DIAG_CTRL,\r\nvalue | 0x10000000);\r\nif (ret_val < 0)\r\ngoto error;\r\nvalue = cx25821_i2c_read(&dev->i2c_bus[0], PIN_OE_CTRL, &tmp);\r\nvalue &= 0xFEF0FE00;\r\nif (_num_decoders == MAX_DECODERS) {\r\nvalue |= 0x010001F8;\r\n} else {\r\nvalue |= 0x010F0108;\r\n}\r\nvalue |= 7;\r\nret_val = cx25821_i2c_write(&dev->i2c_bus[0], PIN_OE_CTRL, value);\r\nif (ret_val < 0)\r\ngoto error;\r\nmutex_unlock(&dev->lock);\r\nret_val = medusa_set_videostandard(dev);\r\nreturn ret_val;\r\nerror:\r\nmutex_unlock(&dev->lock);\r\nreturn ret_val;\r\n}

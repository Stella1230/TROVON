BOOL IFRFbWriteEmbeded (PSDevice pDevice, DWORD dwData)\r\n{\r\nBYTE pbyData[4];\r\npbyData[0] = (BYTE)dwData;\r\npbyData[1] = (BYTE)(dwData>>8);\r\npbyData[2] = (BYTE)(dwData>>16);\r\npbyData[3] = (BYTE)(dwData>>24);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE_IFRF,\r\n0,\r\n0,\r\n4,\r\npbyData\r\n);\r\nreturn TRUE;\r\n}\r\nBOOL RFbSetPower (\r\nPSDevice pDevice,\r\nunsigned int uRATE,\r\nunsigned int uCH\r\n)\r\n{\r\nBOOL bResult = TRUE;\r\nBYTE byPwr = pDevice->byCCKPwr;\r\nif (pDevice->dwDiagRefCount != 0) {\r\nreturn TRUE;\r\n}\r\nswitch (uRATE) {\r\ncase RATE_1M:\r\ncase RATE_2M:\r\ncase RATE_5M:\r\ncase RATE_11M:\r\nbyPwr = pDevice->abyCCKPwrTbl[uCH-1];\r\nbreak;\r\ncase RATE_6M:\r\ncase RATE_9M:\r\ncase RATE_18M:\r\ncase RATE_24M:\r\ncase RATE_36M:\r\ncase RATE_48M:\r\ncase RATE_54M:\r\nif (uCH > CB_MAX_CHANNEL_24G) {\r\nbyPwr = pDevice->abyOFDMAPwrTbl[uCH-15];\r\n} else {\r\nbyPwr = pDevice->abyOFDMPwrTbl[uCH-1];\r\n}\r\nbreak;\r\n}\r\nbResult = RFbRawSetPower(pDevice, byPwr, uRATE);\r\nreturn bResult;\r\n}\r\nBOOL RFbRawSetPower (\r\nPSDevice pDevice,\r\nBYTE byPwr,\r\nunsigned int uRATE\r\n)\r\n{\r\nBOOL bResult = TRUE;\r\nif (pDevice->byCurPwr == byPwr)\r\nreturn TRUE;\r\npDevice->byCurPwr = byPwr;\r\nswitch (pDevice->byRFType) {\r\ncase RF_AL2230 :\r\nif (pDevice->byCurPwr >= AL2230_PWR_IDX_LEN)\r\nreturn FALSE;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwAL2230PowerTable[pDevice->byCurPwr]);\r\nif (uRATE <= RATE_11M)\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x0001B400+(BY_AL2230_REG_LEN<<3)+IFREGCTL_REGW);\r\nelse\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x0005A400+(BY_AL2230_REG_LEN<<3)+IFREGCTL_REGW);\r\nbreak;\r\ncase RF_AL2230S :\r\nif (pDevice->byCurPwr >= AL2230_PWR_IDX_LEN)\r\nreturn FALSE;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwAL2230PowerTable[pDevice->byCurPwr]);\r\nif (uRATE <= RATE_11M) {\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x040C1400+(BY_AL2230_REG_LEN<<3)+IFREGCTL_REGW);\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x00299B00+(BY_AL2230_REG_LEN<<3)+IFREGCTL_REGW);\r\n}else {\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x0005A400+(BY_AL2230_REG_LEN<<3)+IFREGCTL_REGW);\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x00099B00+(BY_AL2230_REG_LEN<<3)+IFREGCTL_REGW);\r\n}\r\nbreak;\r\ncase RF_AIROHA7230:\r\n{\r\nDWORD dwMax7230Pwr;\r\nif (uRATE <= RATE_11M) {\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x111BB900+(BY_AL7230_REG_LEN<<3)+IFREGCTL_REGW);\r\n}\r\nelse {\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x221BB900+(BY_AL7230_REG_LEN<<3)+IFREGCTL_REGW);\r\n}\r\nif (pDevice->byCurPwr > AL7230_PWR_IDX_LEN) return FALSE;\r\ndwMax7230Pwr = 0x080C0B00 | ( (pDevice->byCurPwr) << 12 ) |\r\n(BY_AL7230_REG_LEN << 3 ) | IFREGCTL_REGW;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwMax7230Pwr);\r\nbreak;\r\n}\r\nbreak;\r\ncase RF_VT3226:\r\n{\r\nDWORD dwVT3226Pwr;\r\nif (pDevice->byCurPwr >= VT3226_PWR_IDX_LEN)\r\nreturn FALSE;\r\ndwVT3226Pwr = ((0x3F-pDevice->byCurPwr) << 20 ) | ( 0x17 << 8 ) |\r\n(BY_VT3226_REG_LEN << 3 ) | IFREGCTL_REGW;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3226Pwr);\r\nbreak;\r\n}\r\ncase RF_VT3226D0:\r\n{\r\nDWORD dwVT3226Pwr;\r\nif (pDevice->byCurPwr >= VT3226_PWR_IDX_LEN)\r\nreturn FALSE;\r\nif (uRATE <= RATE_11M) {\r\ndwVT3226Pwr = ((0x3F-pDevice->byCurPwr) << 20 ) | ( 0xE07 << 8 ) |\r\n(BY_VT3226_REG_LEN << 3 ) | IFREGCTL_REGW;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3226Pwr);\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x03C6A200+(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\nif (pDevice->sMgmtObj.eScanState != WMAC_NO_SCANNING) {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"@@@@ RFbRawSetPower> 11B mode uCurrChannel[%d]\n", pDevice->sMgmtObj.uScanChannel);\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3226D0LoCurrentTable[pDevice->sMgmtObj.uScanChannel-1]);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"@@@@ RFbRawSetPower> 11B mode uCurrChannel[%d]\n", pDevice->sMgmtObj.uCurrChannel);\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3226D0LoCurrentTable[pDevice->sMgmtObj.uCurrChannel-1]);\r\n}\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x015C0800+(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\n} else {\r\nDBG_PRT(MSG_LEVEL_DEBUG, KERN_INFO"@@@@ RFbRawSetPower> 11G mode\n");\r\ndwVT3226Pwr = ((0x3F-pDevice->byCurPwr) << 20 ) | ( 0x7 << 8 ) |\r\n(BY_VT3226_REG_LEN << 3 ) | IFREGCTL_REGW;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3226Pwr);\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x00C6A200+(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x016BC600+(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x00900800+(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\n}\r\nbreak;\r\n}\r\ncase RF_VT3342A0:\r\n{\r\nDWORD dwVT3342Pwr;\r\nif (pDevice->byCurPwr >= VT3342_PWR_IDX_LEN)\r\nreturn FALSE;\r\ndwVT3342Pwr = ((0x3F-pDevice->byCurPwr) << 20 ) | ( 0x27 << 8 ) |\r\n(BY_VT3342_REG_LEN << 3 ) | IFREGCTL_REGW;\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3342Pwr);\r\nbreak;\r\n}\r\ndefault :\r\nbreak;\r\n}\r\nreturn bResult;\r\n}\r\nvoid\r\nRFvRSSITodBm (\r\nPSDevice pDevice,\r\nBYTE byCurrRSSI,\r\nlong * pldBm\r\n)\r\n{\r\nBYTE byIdx = (((byCurrRSSI & 0xC0) >> 6) & 0x03);\r\nsigned long b = (byCurrRSSI & 0x3F);\r\nsigned long a = 0;\r\nBYTE abyAIROHARF[4] = {0, 18, 0, 40};\r\nswitch (pDevice->byRFType) {\r\ncase RF_AL2230:\r\ncase RF_AL2230S:\r\ncase RF_AIROHA7230:\r\ncase RF_VT3226:\r\ncase RF_VT3226D0:\r\ncase RF_VT3342A0:\r\na = abyAIROHARF[byIdx];\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n*pldBm = -1 * (a + b * 2);\r\n}\r\nvoid\r\nRFbRFTableDownload (\r\nPSDevice pDevice\r\n)\r\n{\r\nWORD wLength1 = 0,wLength2 = 0 ,wLength3 = 0;\r\nPBYTE pbyAddr1 = NULL,pbyAddr2 = NULL,pbyAddr3 = NULL;\r\nWORD wLength,wValue;\r\nBYTE abyArray[256];\r\nswitch ( pDevice->byRFType ) {\r\ncase RF_AL2230:\r\ncase RF_AL2230S:\r\nwLength1 = CB_AL2230_INIT_SEQ * 3;\r\nwLength2 = CB_MAX_CHANNEL_24G * 3;\r\nwLength3 = CB_MAX_CHANNEL_24G * 3;\r\npbyAddr1 = &(abyAL2230InitTable[0][0]);\r\npbyAddr2 = &(abyAL2230ChannelTable0[0][0]);\r\npbyAddr3 = &(abyAL2230ChannelTable1[0][0]);\r\nbreak;\r\ncase RF_AIROHA7230:\r\nwLength1 = CB_AL7230_INIT_SEQ * 3;\r\nwLength2 = CB_MAX_CHANNEL * 3;\r\nwLength3 = CB_MAX_CHANNEL * 3;\r\npbyAddr1 = &(abyAL7230InitTable[0][0]);\r\npbyAddr2 = &(abyAL7230ChannelTable0[0][0]);\r\npbyAddr3 = &(abyAL7230ChannelTable1[0][0]);\r\nbreak;\r\ncase RF_VT3226:\r\nwLength1 = CB_VT3226_INIT_SEQ * 3;\r\nwLength2 = CB_MAX_CHANNEL_24G * 3;\r\nwLength3 = CB_MAX_CHANNEL_24G * 3;\r\npbyAddr1 = &(abyVT3226_InitTable[0][0]);\r\npbyAddr2 = &(abyVT3226_ChannelTable0[0][0]);\r\npbyAddr3 = &(abyVT3226_ChannelTable1[0][0]);\r\nbreak;\r\ncase RF_VT3226D0:\r\nwLength1 = CB_VT3226_INIT_SEQ * 3;\r\nwLength2 = CB_MAX_CHANNEL_24G * 3;\r\nwLength3 = CB_MAX_CHANNEL_24G * 3;\r\npbyAddr1 = &(abyVT3226D0_InitTable[0][0]);\r\npbyAddr2 = &(abyVT3226_ChannelTable0[0][0]);\r\npbyAddr3 = &(abyVT3226_ChannelTable1[0][0]);\r\nbreak;\r\ncase RF_VT3342A0:\r\nwLength1 = CB_VT3342_INIT_SEQ * 3;\r\nwLength2 = CB_MAX_CHANNEL * 3;\r\nwLength3 = CB_MAX_CHANNEL * 3;\r\npbyAddr1 = &(abyVT3342A0_InitTable[0][0]);\r\npbyAddr2 = &(abyVT3342_ChannelTable0[0][0]);\r\npbyAddr3 = &(abyVT3342_ChannelTable1[0][0]);\r\nbreak;\r\n}\r\nmemcpy(abyArray, pbyAddr1, wLength1);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE,\r\n0,\r\nMESSAGE_REQUEST_RF_INIT,\r\nwLength1,\r\nabyArray\r\n);\r\nwValue = 0;\r\nwhile ( wLength2 > 0 ) {\r\nif ( wLength2 >= 64 ) {\r\nwLength = 64;\r\n} else {\r\nwLength = wLength2;\r\n}\r\nmemcpy(abyArray, pbyAddr2, wLength);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE,\r\nwValue,\r\nMESSAGE_REQUEST_RF_CH0,\r\nwLength,\r\nabyArray);\r\nwLength2 -= wLength;\r\nwValue += wLength;\r\npbyAddr2 += wLength;\r\n}\r\nwValue = 0;\r\nwhile ( wLength3 > 0 ) {\r\nif ( wLength3 >= 64 ) {\r\nwLength = 64;\r\n} else {\r\nwLength = wLength3;\r\n}\r\nmemcpy(abyArray, pbyAddr3, wLength);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE,\r\nwValue,\r\nMESSAGE_REQUEST_RF_CH1,\r\nwLength,\r\nabyArray);\r\nwLength3 -= wLength;\r\nwValue += wLength;\r\npbyAddr3 += wLength;\r\n}\r\nif ( pDevice->byRFType == RF_AIROHA7230 ) {\r\nwLength1 = CB_AL7230_INIT_SEQ * 3;\r\nwLength2 = CB_MAX_CHANNEL * 3;\r\npbyAddr1 = &(abyAL7230InitTableAMode[0][0]);\r\npbyAddr2 = &(abyAL7230ChannelTable2[0][0]);\r\nmemcpy(abyArray, pbyAddr1, wLength1);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE,\r\n0,\r\nMESSAGE_REQUEST_RF_INIT2,\r\nwLength1,\r\nabyArray);\r\nwValue = 0;\r\nwhile ( wLength2 > 0 ) {\r\nif ( wLength2 >= 64 ) {\r\nwLength = 64;\r\n} else {\r\nwLength = wLength2;\r\n}\r\nmemcpy(abyArray, pbyAddr2, wLength);\r\nCONTROLnsRequestOut(pDevice,\r\nMESSAGE_TYPE_WRITE,\r\nwValue,\r\nMESSAGE_REQUEST_RF_CH2,\r\nwLength,\r\nabyArray);\r\nwLength2 -= wLength;\r\nwValue += wLength;\r\npbyAddr2 += wLength;\r\n}\r\n}\r\n}\r\nBOOL s_bVT3226D0_11bLoCurrentAdjust(\r\nPSDevice pDevice,\r\nBYTE byChannel,\r\nBOOL b11bMode)\r\n{\r\nBOOL bResult;\r\nbResult = TRUE;\r\nif( b11bMode )\r\nbResult &= IFRFbWriteEmbeded(pDevice, dwVT3226D0LoCurrentTable[byChannel-1]);\r\nelse\r\nbResult &= IFRFbWriteEmbeded(pDevice, 0x016BC600+(BY_VT3226_REG_LEN<<3)+IFREGCTL_REGW);\r\nreturn bResult;\r\n}

static int gayle_test_irq(ide_hwif_t *hwif)\r\n{\r\nunsigned char ch;\r\nch = z_readb(hwif->io_ports.irq_addr);\r\nif (!(ch & GAYLE_IRQ_IDE))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nstatic void gayle_a1200_clear_irq(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\n(void)z_readb(hwif->io_ports.status_addr);\r\nz_writeb(0x7c, hwif->io_ports.irq_addr);\r\n}\r\nstatic void __init gayle_setup_ports(struct ide_hw *hw, unsigned long base,\r\nunsigned long ctl, unsigned long irq_port)\r\n{\r\nint i;\r\nmemset(hw, 0, sizeof(*hw));\r\nhw->io_ports.data_addr = base;\r\nfor (i = 1; i < 8; i++)\r\nhw->io_ports_array[i] = base + 2 + i * 4;\r\nhw->io_ports.ctl_addr = ctl;\r\nhw->io_ports.irq_addr = irq_port;\r\nhw->irq = IRQ_AMIGA_PORTS;\r\n}\r\nstatic int __init amiga_gayle_ide_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct gayle_ide_platform_data *pdata;\r\nunsigned long base, ctrlport, irqport;\r\nunsigned int i;\r\nint error;\r\nstruct ide_hw hw[GAYLE_NUM_HWIFS], *hws[GAYLE_NUM_HWIFS];\r\nstruct ide_port_info d = gayle_port_info;\r\nstruct ide_host *host;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nif (!request_mem_region(res->start, resource_size(res), "IDE"))\r\nreturn -EBUSY;\r\npdata = pdev->dev.platform_data;\r\npr_info("ide: Gayle IDE controller (A%u style%s)\n",\r\npdata->explicit_ack ? 1200 : 4000,\r\nide_doubler ? ", IDE doubler" : "");\r\nbase = (unsigned long)ZTWO_VADDR(pdata->base);\r\nctrlport = 0;\r\nirqport = (unsigned long)ZTWO_VADDR(pdata->irqport);\r\nif (pdata->explicit_ack)\r\nd.port_ops = &gayle_a1200_port_ops;\r\nelse\r\nd.port_ops = &gayle_a4000_port_ops;\r\nfor (i = 0; i < GAYLE_NUM_PROBE_HWIFS; i++, base += GAYLE_NEXT_PORT) {\r\nif (GAYLE_HAS_CONTROL_REG)\r\nctrlport = base + GAYLE_CONTROL;\r\ngayle_setup_ports(&hw[i], base, ctrlport, irqport);\r\nhws[i] = &hw[i];\r\n}\r\nerror = ide_host_add(&d, hws, i, &host);\r\nif (error)\r\ngoto out;\r\nplatform_set_drvdata(pdev, host);\r\nreturn 0;\r\nout:\r\nrelease_mem_region(res->start, resource_size(res));\r\nreturn error;\r\n}\r\nstatic int __exit amiga_gayle_ide_remove(struct platform_device *pdev)\r\n{\r\nstruct ide_host *host = platform_get_drvdata(pdev);\r\nstruct resource *res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nide_host_remove(host);\r\nrelease_mem_region(res->start, resource_size(res));\r\nreturn 0;\r\n}\r\nstatic int __init amiga_gayle_ide_init(void)\r\n{\r\nreturn platform_driver_probe(&amiga_gayle_ide_driver,\r\namiga_gayle_ide_probe);\r\n}\r\nstatic void __exit amiga_gayle_ide_exit(void)\r\n{\r\nplatform_driver_unregister(&amiga_gayle_ide_driver);\r\n}

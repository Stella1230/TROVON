static void s5p_time_stop(enum s5p_timer_mode mode)\r\n{\r\nunsigned long tcon;\r\ntcon = __raw_readl(S3C2410_TCON);\r\nswitch (mode) {\r\ncase S5P_PWM0:\r\ntcon &= ~S3C2410_TCON_T0START;\r\nbreak;\r\ncase S5P_PWM1:\r\ntcon &= ~S3C2410_TCON_T1START;\r\nbreak;\r\ncase S5P_PWM2:\r\ntcon &= ~S3C2410_TCON_T2START;\r\nbreak;\r\ncase S5P_PWM3:\r\ntcon &= ~S3C2410_TCON_T3START;\r\nbreak;\r\ncase S5P_PWM4:\r\ntcon &= ~S3C2410_TCON_T4START;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "Invalid Timer %d\n", mode);\r\nbreak;\r\n}\r\n__raw_writel(tcon, S3C2410_TCON);\r\n}\r\nstatic void s5p_time_setup(enum s5p_timer_mode mode, unsigned long tcnt)\r\n{\r\nunsigned long tcon;\r\ntcon = __raw_readl(S3C2410_TCON);\r\ntcnt--;\r\nswitch (mode) {\r\ncase S5P_PWM0:\r\ntcon &= ~(0x0f << 0);\r\ntcon |= S3C2410_TCON_T0MANUALUPD;\r\nbreak;\r\ncase S5P_PWM1:\r\ntcon &= ~(0x0f << 8);\r\ntcon |= S3C2410_TCON_T1MANUALUPD;\r\nbreak;\r\ncase S5P_PWM2:\r\ntcon &= ~(0x0f << 12);\r\ntcon |= S3C2410_TCON_T2MANUALUPD;\r\nbreak;\r\ncase S5P_PWM3:\r\ntcon &= ~(0x0f << 16);\r\ntcon |= S3C2410_TCON_T3MANUALUPD;\r\nbreak;\r\ncase S5P_PWM4:\r\ntcon &= ~(0x07 << 20);\r\ntcon |= S3C2410_TCON_T4MANUALUPD;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "Invalid Timer %d\n", mode);\r\nbreak;\r\n}\r\n__raw_writel(tcnt, S3C2410_TCNTB(mode));\r\n__raw_writel(tcnt, S3C2410_TCMPB(mode));\r\n__raw_writel(tcon, S3C2410_TCON);\r\n}\r\nstatic void s5p_time_start(enum s5p_timer_mode mode, bool periodic)\r\n{\r\nunsigned long tcon;\r\ntcon = __raw_readl(S3C2410_TCON);\r\nswitch (mode) {\r\ncase S5P_PWM0:\r\ntcon |= S3C2410_TCON_T0START;\r\ntcon &= ~S3C2410_TCON_T0MANUALUPD;\r\nif (periodic)\r\ntcon |= S3C2410_TCON_T0RELOAD;\r\nelse\r\ntcon &= ~S3C2410_TCON_T0RELOAD;\r\nbreak;\r\ncase S5P_PWM1:\r\ntcon |= S3C2410_TCON_T1START;\r\ntcon &= ~S3C2410_TCON_T1MANUALUPD;\r\nif (periodic)\r\ntcon |= S3C2410_TCON_T1RELOAD;\r\nelse\r\ntcon &= ~S3C2410_TCON_T1RELOAD;\r\nbreak;\r\ncase S5P_PWM2:\r\ntcon |= S3C2410_TCON_T2START;\r\ntcon &= ~S3C2410_TCON_T2MANUALUPD;\r\nif (periodic)\r\ntcon |= S3C2410_TCON_T2RELOAD;\r\nelse\r\ntcon &= ~S3C2410_TCON_T2RELOAD;\r\nbreak;\r\ncase S5P_PWM3:\r\ntcon |= S3C2410_TCON_T3START;\r\ntcon &= ~S3C2410_TCON_T3MANUALUPD;\r\nif (periodic)\r\ntcon |= S3C2410_TCON_T3RELOAD;\r\nelse\r\ntcon &= ~S3C2410_TCON_T3RELOAD;\r\nbreak;\r\ncase S5P_PWM4:\r\ntcon |= S3C2410_TCON_T4START;\r\ntcon &= ~S3C2410_TCON_T4MANUALUPD;\r\nif (periodic)\r\ntcon |= S3C2410_TCON_T4RELOAD;\r\nelse\r\ntcon &= ~S3C2410_TCON_T4RELOAD;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "Invalid Timer %d\n", mode);\r\nbreak;\r\n}\r\n__raw_writel(tcon, S3C2410_TCON);\r\n}\r\nstatic int s5p_set_next_event(unsigned long cycles,\r\nstruct clock_event_device *evt)\r\n{\r\ns5p_time_setup(timer_source.event_id, cycles);\r\ns5p_time_start(timer_source.event_id, NON_PERIODIC);\r\nreturn 0;\r\n}\r\nstatic void s5p_set_mode(enum clock_event_mode mode,\r\nstruct clock_event_device *evt)\r\n{\r\ns5p_time_stop(timer_source.event_id);\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\ns5p_time_setup(timer_source.event_id, clock_count_per_tick);\r\ns5p_time_start(timer_source.event_id, PERIODIC);\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nbreak;\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\nbreak;\r\ncase CLOCK_EVT_MODE_RESUME:\r\ns5p_timer_resume();\r\nbreak;\r\n}\r\n}\r\nstatic void s5p_timer_resume(void)\r\n{\r\ns5p_time_setup(timer_source.event_id, clock_count_per_tick);\r\ns5p_time_start(timer_source.event_id, PERIODIC);\r\ns5p_time_setup(timer_source.source_id, TCNT_MAX);\r\ns5p_time_start(timer_source.source_id, PERIODIC);\r\n}\r\nvoid __init s5p_set_timer_source(enum s5p_timer_mode event,\r\nenum s5p_timer_mode source)\r\n{\r\ns3c_device_timer[event].dev.bus = &platform_bus_type;\r\ns3c_device_timer[source].dev.bus = &platform_bus_type;\r\ntimer_source.event_id = event;\r\ntimer_source.source_id = source;\r\n}\r\nstatic irqreturn_t s5p_clock_event_isr(int irq, void *dev_id)\r\n{\r\nstruct clock_event_device *evt = dev_id;\r\nevt->event_handler(evt);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __init s5p_clockevent_init(void)\r\n{\r\nunsigned long pclk;\r\nunsigned long clock_rate;\r\nunsigned int irq_number;\r\nstruct clk *tscaler;\r\npclk = clk_get_rate(timerclk);\r\ntscaler = clk_get_parent(tdiv_event);\r\nclk_set_rate(tscaler, pclk / 2);\r\nclk_set_rate(tdiv_event, pclk / 2);\r\nclk_set_parent(tin_event, tdiv_event);\r\nclock_rate = clk_get_rate(tin_event);\r\nclock_count_per_tick = clock_rate / HZ;\r\nclockevents_calc_mult_shift(&time_event_device,\r\nclock_rate, S5PTIMER_MIN_RANGE);\r\ntime_event_device.max_delta_ns =\r\nclockevent_delta2ns(-1, &time_event_device);\r\ntime_event_device.min_delta_ns =\r\nclockevent_delta2ns(1, &time_event_device);\r\ntime_event_device.cpumask = cpumask_of(0);\r\nclockevents_register_device(&time_event_device);\r\nirq_number = timer_source.event_id + IRQ_TIMER0;\r\nsetup_irq(irq_number, &s5p_clock_event_irq);\r\n}\r\nstatic void __iomem *s5p_timer_reg(void)\r\n{\r\nunsigned long offset = 0;\r\nswitch (timer_source.source_id) {\r\ncase S5P_PWM0:\r\ncase S5P_PWM1:\r\ncase S5P_PWM2:\r\ncase S5P_PWM3:\r\noffset = (timer_source.source_id * 0x0c) + 0x14;\r\nbreak;\r\ncase S5P_PWM4:\r\noffset = 0x40;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "Invalid Timer %d\n", timer_source.source_id);\r\nreturn NULL;\r\n}\r\nreturn S3C_TIMERREG(offset);\r\n}\r\nstatic u32 notrace s5p_read_sched_clock(void)\r\n{\r\nvoid __iomem *reg = s5p_timer_reg();\r\nif (!reg)\r\nreturn 0;\r\nreturn ~__raw_readl(reg);\r\n}\r\nstatic void __init s5p_clocksource_init(void)\r\n{\r\nunsigned long pclk;\r\nunsigned long clock_rate;\r\npclk = clk_get_rate(timerclk);\r\nclk_set_rate(tdiv_source, pclk / 2);\r\nclk_set_parent(tin_source, tdiv_source);\r\nclock_rate = clk_get_rate(tin_source);\r\ns5p_time_setup(timer_source.source_id, TCNT_MAX);\r\ns5p_time_start(timer_source.source_id, PERIODIC);\r\nsetup_sched_clock(s5p_read_sched_clock, 32, clock_rate);\r\nif (clocksource_mmio_init(s5p_timer_reg(), "s5p_clocksource_timer",\r\nclock_rate, 250, 32, clocksource_mmio_readl_down))\r\npanic("s5p_clocksource_timer: can't register clocksource\n");\r\n}\r\nstatic void __init s5p_timer_resources(void)\r\n{\r\nunsigned long event_id = timer_source.event_id;\r\nunsigned long source_id = timer_source.source_id;\r\nchar devname[15];\r\ntimerclk = clk_get(NULL, "timers");\r\nif (IS_ERR(timerclk))\r\npanic("failed to get timers clock for timer");\r\nclk_enable(timerclk);\r\nsprintf(devname, "s3c24xx-pwm.%lu", event_id);\r\ns3c_device_timer[event_id].id = event_id;\r\ns3c_device_timer[event_id].dev.init_name = devname;\r\ntin_event = clk_get(&s3c_device_timer[event_id].dev, "pwm-tin");\r\nif (IS_ERR(tin_event))\r\npanic("failed to get pwm-tin clock for event timer");\r\ntdiv_event = clk_get(&s3c_device_timer[event_id].dev, "pwm-tdiv");\r\nif (IS_ERR(tdiv_event))\r\npanic("failed to get pwm-tdiv clock for event timer");\r\nclk_enable(tin_event);\r\nsprintf(devname, "s3c24xx-pwm.%lu", source_id);\r\ns3c_device_timer[source_id].id = source_id;\r\ns3c_device_timer[source_id].dev.init_name = devname;\r\ntin_source = clk_get(&s3c_device_timer[source_id].dev, "pwm-tin");\r\nif (IS_ERR(tin_source))\r\npanic("failed to get pwm-tin clock for source timer");\r\ntdiv_source = clk_get(&s3c_device_timer[source_id].dev, "pwm-tdiv");\r\nif (IS_ERR(tdiv_source))\r\npanic("failed to get pwm-tdiv clock for source timer");\r\nclk_enable(tin_source);\r\n}\r\nstatic void __init s5p_timer_init(void)\r\n{\r\ns5p_timer_resources();\r\ns5p_clockevent_init();\r\ns5p_clocksource_init();\r\n}

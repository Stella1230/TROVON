static int reg_write(struct usb_device *dev,\r\n__u16 req, __u16 index, __u16 value)\r\n{\r\nint ret;\r\nret = usb_control_msg(dev,\r\nusb_sndctrlpipe(dev, 0),\r\nreq,\r\nUSB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, index, NULL, 0, 500);\r\nPDEBUG(D_USBO, "reg write: 0x%02x 0x%02x 0x%02x",\r\nreq, index, value);\r\nif (ret < 0)\r\npr_err("reg write: error %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int write_vector(struct gspca_dev *gspca_dev,\r\nconst __u16 data[][3])\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint ret, i = 0;\r\nwhile (data[i][0] != 0 || data[i][1] != 0 || data[i][2] != 0) {\r\nret = reg_write(dev, data[i][0], data[i][2], data[i][1]);\r\nif (ret < 0) {\r\nPDEBUG(D_ERR,\r\n"Reg write failed for 0x%02x,0x%02x,0x%02x",\r\ndata[i][0], data[i][1], data[i][2]);\r\nreturn ret;\r\n}\r\ni++;\r\n}\r\nreturn 0;\r\n}\r\nstatic void setbrightness(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_write(gspca_dev->dev, SPCA501_REG_CCDSP, 0x12, sd->brightness);\r\n}\r\nstatic void setcontrast(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_write(gspca_dev->dev, 0x00, 0x00,\r\n(sd->contrast >> 8) & 0xff);\r\nreg_write(gspca_dev->dev, 0x00, 0x01,\r\nsd->contrast & 0xff);\r\n}\r\nstatic void setcolors(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_write(gspca_dev->dev, SPCA501_REG_CCDSP, 0x0c, sd->colors);\r\n}\r\nstatic void setblue_balance(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_write(gspca_dev->dev, SPCA501_REG_CCDSP, 0x11, sd->blue_balance);\r\n}\r\nstatic void setred_balance(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nreg_write(gspca_dev->dev, SPCA501_REG_CCDSP, 0x13, sd->red_balance);\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct cam *cam;\r\ncam = &gspca_dev->cam;\r\ncam->cam_mode = vga_mode;\r\ncam->nmodes = ARRAY_SIZE(vga_mode);\r\nsd->subtype = id->driver_info;\r\nsd->brightness = sd_ctrls[MY_BRIGHTNESS].qctrl.default_value;\r\nsd->contrast = sd_ctrls[MY_CONTRAST].qctrl.default_value;\r\nsd->colors = sd_ctrls[MY_COLOR].qctrl.default_value;\r\nreturn 0;\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nswitch (sd->subtype) {\r\ncase Arowana300KCMOSCamera:\r\ncase SmileIntlCamera:\r\nif (write_vector(gspca_dev, spca501c_arowana_init_data))\r\ngoto error;\r\nbreak;\r\ncase MystFromOriUnknownCamera:\r\nif (write_vector(gspca_dev, spca501c_mysterious_open_data))\r\ngoto error;\r\nbreak;\r\ndefault:\r\nif (write_vector(gspca_dev, spca501_init_data))\r\ngoto error;\r\nbreak;\r\n}\r\nPDEBUG(D_STREAM, "Initializing SPCA501 finished");\r\nreturn 0;\r\nerror:\r\nreturn -EINVAL;\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nstruct usb_device *dev = gspca_dev->dev;\r\nint mode;\r\nswitch (sd->subtype) {\r\ncase ThreeComHomeConnectLite:\r\nwrite_vector(gspca_dev, spca501_3com_open_data);\r\nbreak;\r\ncase Arowana300KCMOSCamera:\r\ncase SmileIntlCamera:\r\nwrite_vector(gspca_dev, spca501c_arowana_open_data);\r\nbreak;\r\ncase MystFromOriUnknownCamera:\r\nwrite_vector(gspca_dev, spca501c_mysterious_init_data);\r\nbreak;\r\ndefault:\r\nwrite_vector(gspca_dev, spca501_open_data);\r\n}\r\nmode = gspca_dev->cam.cam_mode[(int) gspca_dev->curr_mode].priv;\r\nreg_write(dev, SPCA50X_REG_USB, 0x6, 0x94);\r\nswitch (mode) {\r\ncase 0:\r\nreg_write(dev, SPCA50X_REG_USB, 0x07, 0x004a);\r\nbreak;\r\ncase 1:\r\nreg_write(dev, SPCA50X_REG_USB, 0x07, 0x104a);\r\nbreak;\r\ndefault:\r\nreg_write(dev, SPCA50X_REG_USB, 0x07, 0x204a);\r\nbreak;\r\n}\r\nreg_write(dev, SPCA501_REG_CTLRL, 0x01, 0x02);\r\nsetbrightness(gspca_dev);\r\nsetcontrast(gspca_dev);\r\nsetcolors(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nreg_write(gspca_dev->dev, SPCA501_REG_CTLRL, 0x01, 0x00);\r\n}\r\nstatic void sd_stop0(struct gspca_dev *gspca_dev)\r\n{\r\nif (!gspca_dev->present)\r\nreturn;\r\nreg_write(gspca_dev->dev, SPCA501_REG_CTLRL, 0x05, 0x00);\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nswitch (data[0]) {\r\ncase 0:\r\ngspca_frame_add(gspca_dev, LAST_PACKET, NULL, 0);\r\ndata += SPCA501_OFFSET_DATA;\r\nlen -= SPCA501_OFFSET_DATA;\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\nreturn;\r\ncase 0xff:\r\nreturn;\r\n}\r\ndata++;\r\nlen--;\r\ngspca_frame_add(gspca_dev, INTER_PACKET, data, len);\r\n}\r\nstatic int sd_setbrightness(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->brightness = val;\r\nif (gspca_dev->streaming)\r\nsetbrightness(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getbrightness(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->brightness;\r\nreturn 0;\r\n}\r\nstatic int sd_setcontrast(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->contrast = val;\r\nif (gspca_dev->streaming)\r\nsetcontrast(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getcontrast(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->contrast;\r\nreturn 0;\r\n}\r\nstatic int sd_setcolors(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->colors = val;\r\nif (gspca_dev->streaming)\r\nsetcolors(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getcolors(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->colors;\r\nreturn 0;\r\n}\r\nstatic int sd_setblue_balance(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->blue_balance = val;\r\nif (gspca_dev->streaming)\r\nsetblue_balance(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getblue_balance(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->blue_balance;\r\nreturn 0;\r\n}\r\nstatic int sd_setred_balance(struct gspca_dev *gspca_dev, __s32 val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->red_balance = val;\r\nif (gspca_dev->streaming)\r\nsetred_balance(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int sd_getred_balance(struct gspca_dev *gspca_dev, __s32 *val)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*val = sd->red_balance;\r\nreturn 0;\r\n}\r\nstatic int sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}

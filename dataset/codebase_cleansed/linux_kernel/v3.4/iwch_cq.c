static int iwch_poll_cq_one(struct iwch_dev *rhp, struct iwch_cq *chp,\r\nstruct ib_wc *wc)\r\n{\r\nstruct iwch_qp *qhp = NULL;\r\nstruct t3_cqe cqe, *rd_cqe;\r\nstruct t3_wq *wq;\r\nu32 credit = 0;\r\nu8 cqe_flushed;\r\nu64 cookie;\r\nint ret = 1;\r\nrd_cqe = cxio_next_cqe(&chp->cq);\r\nif (!rd_cqe)\r\nreturn 0;\r\nqhp = get_qhp(rhp, CQE_QPID(*rd_cqe));\r\nif (!qhp)\r\nwq = NULL;\r\nelse {\r\nspin_lock(&qhp->lock);\r\nwq = &(qhp->wq);\r\n}\r\nret = cxio_poll_cq(wq, &(chp->cq), &cqe, &cqe_flushed, &cookie,\r\n&credit);\r\nif (t3a_device(chp->rhp) && credit) {\r\nPDBG("%s updating %d cq credits on id %d\n", __func__,\r\ncredit, chp->cq.cqid);\r\ncxio_hal_cq_op(&rhp->rdev, &chp->cq, CQ_CREDIT_UPDATE, credit);\r\n}\r\nif (ret) {\r\nret = -EAGAIN;\r\ngoto out;\r\n}\r\nret = 1;\r\nwc->wr_id = cookie;\r\nwc->qp = &qhp->ibqp;\r\nwc->vendor_err = CQE_STATUS(cqe);\r\nwc->wc_flags = 0;\r\nPDBG("%s qpid 0x%x type %d opcode %d status 0x%x wrid hi 0x%x "\r\n"lo 0x%x cookie 0x%llx\n", __func__,\r\nCQE_QPID(cqe), CQE_TYPE(cqe),\r\nCQE_OPCODE(cqe), CQE_STATUS(cqe), CQE_WRID_HI(cqe),\r\nCQE_WRID_LOW(cqe), (unsigned long long) cookie);\r\nif (CQE_TYPE(cqe) == 0) {\r\nif (!CQE_STATUS(cqe))\r\nwc->byte_len = CQE_LEN(cqe);\r\nelse\r\nwc->byte_len = 0;\r\nwc->opcode = IB_WC_RECV;\r\nif (CQE_OPCODE(cqe) == T3_SEND_WITH_INV ||\r\nCQE_OPCODE(cqe) == T3_SEND_WITH_SE_INV) {\r\nwc->ex.invalidate_rkey = CQE_WRID_STAG(cqe);\r\nwc->wc_flags |= IB_WC_WITH_INVALIDATE;\r\n}\r\n} else {\r\nswitch (CQE_OPCODE(cqe)) {\r\ncase T3_RDMA_WRITE:\r\nwc->opcode = IB_WC_RDMA_WRITE;\r\nbreak;\r\ncase T3_READ_REQ:\r\nwc->opcode = IB_WC_RDMA_READ;\r\nwc->byte_len = CQE_LEN(cqe);\r\nbreak;\r\ncase T3_SEND:\r\ncase T3_SEND_WITH_SE:\r\ncase T3_SEND_WITH_INV:\r\ncase T3_SEND_WITH_SE_INV:\r\nwc->opcode = IB_WC_SEND;\r\nbreak;\r\ncase T3_BIND_MW:\r\nwc->opcode = IB_WC_BIND_MW;\r\nbreak;\r\ncase T3_LOCAL_INV:\r\nwc->opcode = IB_WC_LOCAL_INV;\r\nbreak;\r\ncase T3_FAST_REGISTER:\r\nwc->opcode = IB_WC_FAST_REG_MR;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR MOD "Unexpected opcode %d "\r\n"in the CQE received for QPID=0x%0x\n",\r\nCQE_OPCODE(cqe), CQE_QPID(cqe));\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\n}\r\nif (cqe_flushed)\r\nwc->status = IB_WC_WR_FLUSH_ERR;\r\nelse {\r\nswitch (CQE_STATUS(cqe)) {\r\ncase TPT_ERR_SUCCESS:\r\nwc->status = IB_WC_SUCCESS;\r\nbreak;\r\ncase TPT_ERR_STAG:\r\nwc->status = IB_WC_LOC_ACCESS_ERR;\r\nbreak;\r\ncase TPT_ERR_PDID:\r\nwc->status = IB_WC_LOC_PROT_ERR;\r\nbreak;\r\ncase TPT_ERR_QPID:\r\ncase TPT_ERR_ACCESS:\r\nwc->status = IB_WC_LOC_ACCESS_ERR;\r\nbreak;\r\ncase TPT_ERR_WRAP:\r\nwc->status = IB_WC_GENERAL_ERR;\r\nbreak;\r\ncase TPT_ERR_BOUND:\r\nwc->status = IB_WC_LOC_LEN_ERR;\r\nbreak;\r\ncase TPT_ERR_INVALIDATE_SHARED_MR:\r\ncase TPT_ERR_INVALIDATE_MR_WITH_MW_BOUND:\r\nwc->status = IB_WC_MW_BIND_ERR;\r\nbreak;\r\ncase TPT_ERR_CRC:\r\ncase TPT_ERR_MARKER:\r\ncase TPT_ERR_PDU_LEN_ERR:\r\ncase TPT_ERR_OUT_OF_RQE:\r\ncase TPT_ERR_DDP_VERSION:\r\ncase TPT_ERR_RDMA_VERSION:\r\ncase TPT_ERR_DDP_QUEUE_NUM:\r\ncase TPT_ERR_MSN:\r\ncase TPT_ERR_TBIT:\r\ncase TPT_ERR_MO:\r\ncase TPT_ERR_MSN_RANGE:\r\ncase TPT_ERR_IRD_OVERFLOW:\r\ncase TPT_ERR_OPCODE:\r\nwc->status = IB_WC_FATAL_ERR;\r\nbreak;\r\ncase TPT_ERR_SWFLUSH:\r\nwc->status = IB_WC_WR_FLUSH_ERR;\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR MOD "Unexpected cqe_status 0x%x for "\r\n"QPID=0x%0x\n", CQE_STATUS(cqe), CQE_QPID(cqe));\r\nret = -EINVAL;\r\n}\r\n}\r\nout:\r\nif (wq)\r\nspin_unlock(&qhp->lock);\r\nreturn ret;\r\n}\r\nint iwch_poll_cq(struct ib_cq *ibcq, int num_entries, struct ib_wc *wc)\r\n{\r\nstruct iwch_dev *rhp;\r\nstruct iwch_cq *chp;\r\nunsigned long flags;\r\nint npolled;\r\nint err = 0;\r\nchp = to_iwch_cq(ibcq);\r\nrhp = chp->rhp;\r\nspin_lock_irqsave(&chp->lock, flags);\r\nfor (npolled = 0; npolled < num_entries; ++npolled) {\r\n#ifdef DEBUG\r\nint i=0;\r\n#endif\r\ndo {\r\nerr = iwch_poll_cq_one(rhp, chp, wc + npolled);\r\n#ifdef DEBUG\r\nBUG_ON(++i > 1000);\r\n#endif\r\n} while (err == -EAGAIN);\r\nif (err <= 0)\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&chp->lock, flags);\r\nif (err < 0)\r\nreturn err;\r\nelse {\r\nreturn npolled;\r\n}\r\n}

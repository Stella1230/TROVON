static int __cvmx_helper_initialize_fpa_pool(int pool, uint64_t buffer_size,\r\nuint64_t buffers, const char *name)\r\n{\r\nuint64_t current_num;\r\nvoid *memory;\r\nuint64_t align = CVMX_CACHE_LINE_SIZE;\r\nwhile (align < buffer_size)\r\nalign = align << 1;\r\nif (buffers == 0)\r\nreturn 0;\r\ncurrent_num = cvmx_read_csr(CVMX_FPA_QUEX_AVAILABLE(pool));\r\nif (current_num) {\r\ncvmx_dprintf("Fpa pool %d(%s) already has %llu buffers. "\r\n"Skipping setup.\n",\r\npool, name, (unsigned long long)current_num);\r\nreturn 0;\r\n}\r\nmemory = cvmx_bootmem_alloc(buffer_size * buffers, align);\r\nif (memory == NULL) {\r\ncvmx_dprintf("Out of memory initializing fpa pool %d(%s).\n",\r\npool, name);\r\nreturn -1;\r\n}\r\ncvmx_fpa_setup_pool(pool, name, memory, buffer_size, buffers);\r\nreturn 0;\r\n}\r\nstatic int __cvmx_helper_initialize_fpa(int pip_pool, int pip_size,\r\nint pip_buffers, int wqe_pool,\r\nint wqe_size, int wqe_entries,\r\nint pko_pool, int pko_size,\r\nint pko_buffers, int tim_pool,\r\nint tim_size, int tim_buffers,\r\nint dfa_pool, int dfa_size,\r\nint dfa_buffers)\r\n{\r\nint status;\r\ncvmx_fpa_enable();\r\nif ((pip_buffers > 0) && (pip_buffers <= 64))\r\ncvmx_dprintf\r\n("Warning: %d packet buffers may not be enough for hardware"\r\n" prefetch. 65 or more is recommended.\n", pip_buffers);\r\nif (pip_pool >= 0) {\r\nstatus =\r\n__cvmx_helper_initialize_fpa_pool(pip_pool, pip_size,\r\npip_buffers,\r\n"Packet Buffers");\r\nif (status)\r\nreturn status;\r\n}\r\nif (wqe_pool >= 0) {\r\nstatus =\r\n__cvmx_helper_initialize_fpa_pool(wqe_pool, wqe_size,\r\nwqe_entries,\r\n"Work Queue Entries");\r\nif (status)\r\nreturn status;\r\n}\r\nif (pko_pool >= 0) {\r\nstatus =\r\n__cvmx_helper_initialize_fpa_pool(pko_pool, pko_size,\r\npko_buffers,\r\n"PKO Command Buffers");\r\nif (status)\r\nreturn status;\r\n}\r\nif (tim_pool >= 0) {\r\nstatus =\r\n__cvmx_helper_initialize_fpa_pool(tim_pool, tim_size,\r\ntim_buffers,\r\n"TIM Command Buffers");\r\nif (status)\r\nreturn status;\r\n}\r\nif (dfa_pool >= 0) {\r\nstatus =\r\n__cvmx_helper_initialize_fpa_pool(dfa_pool, dfa_size,\r\ndfa_buffers,\r\n"DFA Command Buffers");\r\nif (status)\r\nreturn status;\r\n}\r\nreturn 0;\r\n}\r\nint cvmx_helper_initialize_fpa(int packet_buffers, int work_queue_entries,\r\nint pko_buffers, int tim_buffers,\r\nint dfa_buffers)\r\n{\r\n#ifndef CVMX_FPA_PACKET_POOL\r\n#define CVMX_FPA_PACKET_POOL -1\r\n#define CVMX_FPA_PACKET_POOL_SIZE 0\r\n#endif\r\n#ifndef CVMX_FPA_WQE_POOL\r\n#define CVMX_FPA_WQE_POOL -1\r\n#define CVMX_FPA_WQE_POOL_SIZE 0\r\n#endif\r\n#ifndef CVMX_FPA_OUTPUT_BUFFER_POOL\r\n#define CVMX_FPA_OUTPUT_BUFFER_POOL -1\r\n#define CVMX_FPA_OUTPUT_BUFFER_POOL_SIZE 0\r\n#endif\r\n#ifndef CVMX_FPA_TIMER_POOL\r\n#define CVMX_FPA_TIMER_POOL -1\r\n#define CVMX_FPA_TIMER_POOL_SIZE 0\r\n#endif\r\n#ifndef CVMX_FPA_DFA_POOL\r\n#define CVMX_FPA_DFA_POOL -1\r\n#define CVMX_FPA_DFA_POOL_SIZE 0\r\n#endif\r\nreturn __cvmx_helper_initialize_fpa(CVMX_FPA_PACKET_POOL,\r\nCVMX_FPA_PACKET_POOL_SIZE,\r\npacket_buffers, CVMX_FPA_WQE_POOL,\r\nCVMX_FPA_WQE_POOL_SIZE,\r\nwork_queue_entries,\r\nCVMX_FPA_OUTPUT_BUFFER_POOL,\r\nCVMX_FPA_OUTPUT_BUFFER_POOL_SIZE,\r\npko_buffers, CVMX_FPA_TIMER_POOL,\r\nCVMX_FPA_TIMER_POOL_SIZE,\r\ntim_buffers, CVMX_FPA_DFA_POOL,\r\nCVMX_FPA_DFA_POOL_SIZE,\r\ndfa_buffers);\r\n}

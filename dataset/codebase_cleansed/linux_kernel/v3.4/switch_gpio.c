static void gpio_switch_work(struct work_struct *work)\r\n{\r\nint state;\r\nstruct gpio_switch_data *data =\r\ncontainer_of(work, struct gpio_switch_data, work);\r\nstate = gpio_get_value(data->gpio);\r\nswitch_set_state(&data->sdev, state);\r\n}\r\nstatic irqreturn_t gpio_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct gpio_switch_data *switch_data =\r\n(struct gpio_switch_data *)dev_id;\r\nschedule_work(&switch_data->work);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t switch_gpio_print_state(struct switch_dev *sdev, char *buf)\r\n{\r\nstruct gpio_switch_data *switch_data =\r\ncontainer_of(sdev, struct gpio_switch_data, sdev);\r\nconst char *state;\r\nif (switch_get_state(sdev))\r\nstate = switch_data->state_on;\r\nelse\r\nstate = switch_data->state_off;\r\nif (state)\r\nreturn sprintf(buf, "%s\n", state);\r\nreturn -1;\r\n}\r\nstatic int gpio_switch_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_switch_platform_data *pdata = pdev->dev.platform_data;\r\nstruct gpio_switch_data *switch_data;\r\nint ret = 0;\r\nif (!pdata)\r\nreturn -EBUSY;\r\nswitch_data = kzalloc(sizeof(struct gpio_switch_data), GFP_KERNEL);\r\nif (!switch_data)\r\nreturn -ENOMEM;\r\nswitch_data->sdev.name = pdata->name;\r\nswitch_data->gpio = pdata->gpio;\r\nswitch_data->name_on = pdata->name_on;\r\nswitch_data->name_off = pdata->name_off;\r\nswitch_data->state_on = pdata->state_on;\r\nswitch_data->state_off = pdata->state_off;\r\nswitch_data->sdev.print_state = switch_gpio_print_state;\r\nret = switch_dev_register(&switch_data->sdev);\r\nif (ret < 0)\r\ngoto err_switch_dev_register;\r\nret = gpio_request(switch_data->gpio, pdev->name);\r\nif (ret < 0)\r\ngoto err_request_gpio;\r\nret = gpio_direction_input(switch_data->gpio);\r\nif (ret < 0)\r\ngoto err_set_gpio_input;\r\nINIT_WORK(&switch_data->work, gpio_switch_work);\r\nswitch_data->irq = gpio_to_irq(switch_data->gpio);\r\nif (switch_data->irq < 0) {\r\nret = switch_data->irq;\r\ngoto err_detect_irq_num_failed;\r\n}\r\nret = request_irq(switch_data->irq, gpio_irq_handler,\r\nIRQF_TRIGGER_LOW, pdev->name, switch_data);\r\nif (ret < 0)\r\ngoto err_request_irq;\r\ngpio_switch_work(&switch_data->work);\r\nreturn 0;\r\nerr_request_irq:\r\nerr_detect_irq_num_failed:\r\nerr_set_gpio_input:\r\ngpio_free(switch_data->gpio);\r\nerr_request_gpio:\r\nswitch_dev_unregister(&switch_data->sdev);\r\nerr_switch_dev_register:\r\nkfree(switch_data);\r\nreturn ret;\r\n}\r\nstatic int __devexit gpio_switch_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_switch_data *switch_data = platform_get_drvdata(pdev);\r\ncancel_work_sync(&switch_data->work);\r\ngpio_free(switch_data->gpio);\r\nswitch_dev_unregister(&switch_data->sdev);\r\nkfree(switch_data);\r\nreturn 0;\r\n}\r\nstatic int __init gpio_switch_init(void)\r\n{\r\nreturn platform_driver_register(&gpio_switch_driver);\r\n}\r\nstatic void __exit gpio_switch_exit(void)\r\n{\r\nplatform_driver_unregister(&gpio_switch_driver);\r\n}

static inline struct wm8350_irq_data *irq_to_wm8350_irq(struct wm8350 *wm8350,\r\nint irq)\r\n{\r\nreturn &wm8350_irqs[irq - wm8350->irq_base];\r\n}\r\nstatic irqreturn_t wm8350_irq(int irq, void *irq_data)\r\n{\r\nstruct wm8350 *wm8350 = irq_data;\r\nu16 level_one;\r\nu16 sub_reg[WM8350_NUM_IRQ_REGS];\r\nint read_done[WM8350_NUM_IRQ_REGS];\r\nstruct wm8350_irq_data *data;\r\nint i;\r\nlevel_one = wm8350_reg_read(wm8350, WM8350_SYSTEM_INTERRUPTS)\r\n& ~wm8350_reg_read(wm8350, WM8350_SYSTEM_INTERRUPTS_MASK);\r\nif (!level_one)\r\nreturn IRQ_NONE;\r\nmemset(&read_done, 0, sizeof(read_done));\r\nfor (i = 0; i < ARRAY_SIZE(wm8350_irqs); i++) {\r\ndata = &wm8350_irqs[i];\r\nif (!(level_one & data->primary))\r\ncontinue;\r\nif (!read_done[data->reg]) {\r\nsub_reg[data->reg] =\r\nwm8350_reg_read(wm8350, WM8350_INT_STATUS_1 +\r\ndata->reg);\r\nsub_reg[data->reg] &= ~wm8350->irq_masks[data->reg];\r\nread_done[data->reg] = 1;\r\n}\r\nif (sub_reg[data->reg] & data->mask)\r\nhandle_nested_irq(wm8350->irq_base + i);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void wm8350_irq_lock(struct irq_data *data)\r\n{\r\nstruct wm8350 *wm8350 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&wm8350->irq_lock);\r\n}\r\nstatic void wm8350_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct wm8350 *wm8350 = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(wm8350->irq_masks); i++) {\r\nif (wm8350->irq_masks[i] !=\r\nwm8350->reg_cache[WM8350_INT_STATUS_1_MASK + i])\r\nWARN_ON(wm8350_reg_write(wm8350,\r\nWM8350_INT_STATUS_1_MASK + i,\r\nwm8350->irq_masks[i]));\r\n}\r\nmutex_unlock(&wm8350->irq_lock);\r\n}\r\nstatic void wm8350_irq_enable(struct irq_data *data)\r\n{\r\nstruct wm8350 *wm8350 = irq_data_get_irq_chip_data(data);\r\nstruct wm8350_irq_data *irq_data = irq_to_wm8350_irq(wm8350,\r\ndata->irq);\r\nwm8350->irq_masks[irq_data->reg] &= ~irq_data->mask;\r\n}\r\nstatic void wm8350_irq_disable(struct irq_data *data)\r\n{\r\nstruct wm8350 *wm8350 = irq_data_get_irq_chip_data(data);\r\nstruct wm8350_irq_data *irq_data = irq_to_wm8350_irq(wm8350,\r\ndata->irq);\r\nwm8350->irq_masks[irq_data->reg] |= irq_data->mask;\r\n}\r\nint wm8350_irq_init(struct wm8350 *wm8350, int irq,\r\nstruct wm8350_platform_data *pdata)\r\n{\r\nint ret, cur_irq, i;\r\nint flags = IRQF_ONESHOT;\r\nint irq_base = -1;\r\nif (!irq) {\r\ndev_warn(wm8350->dev, "No interrupt support, no core IRQ\n");\r\nreturn 0;\r\n}\r\nwm8350_reg_write(wm8350, WM8350_SYSTEM_INTERRUPTS_MASK, 0xFFFF);\r\nfor (i = 0; i < ARRAY_SIZE(wm8350->irq_masks); i++) {\r\nwm8350_reg_write(wm8350, WM8350_INT_STATUS_1_MASK + i,\r\n0xFFFF);\r\nwm8350->irq_masks[i] =\r\nwm8350_reg_read(wm8350,\r\nWM8350_INT_STATUS_1_MASK + i);\r\n}\r\nmutex_init(&wm8350->irq_lock);\r\nwm8350->chip_irq = irq;\r\nif (pdata && pdata->irq_base > 0)\r\nirq_base = pdata->irq_base;\r\nwm8350->irq_base = irq_alloc_descs(irq_base, 0, ARRAY_SIZE(wm8350_irqs), 0);\r\nif (wm8350->irq_base < 0) {\r\ndev_warn(wm8350->dev, "Allocating irqs failed with %d\n",\r\nwm8350->irq_base);\r\nreturn 0;\r\n}\r\nif (pdata && pdata->irq_high) {\r\nflags |= IRQF_TRIGGER_HIGH;\r\nwm8350_set_bits(wm8350, WM8350_SYSTEM_CONTROL_1,\r\nWM8350_IRQ_POL);\r\n} else {\r\nflags |= IRQF_TRIGGER_LOW;\r\nwm8350_clear_bits(wm8350, WM8350_SYSTEM_CONTROL_1,\r\nWM8350_IRQ_POL);\r\n}\r\nfor (cur_irq = wm8350->irq_base;\r\ncur_irq < ARRAY_SIZE(wm8350_irqs) + wm8350->irq_base;\r\ncur_irq++) {\r\nirq_set_chip_data(cur_irq, wm8350);\r\nirq_set_chip_and_handler(cur_irq, &wm8350_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(cur_irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(cur_irq);\r\n#endif\r\n}\r\nret = request_threaded_irq(irq, NULL, wm8350_irq, flags,\r\n"wm8350", wm8350);\r\nif (ret != 0)\r\ndev_err(wm8350->dev, "Failed to request IRQ: %d\n", ret);\r\nwm8350_reg_write(wm8350, WM8350_SYSTEM_INTERRUPTS_MASK, 0);\r\nreturn ret;\r\n}\r\nint wm8350_irq_exit(struct wm8350 *wm8350)\r\n{\r\nfree_irq(wm8350->chip_irq, wm8350);\r\nreturn 0;\r\n}

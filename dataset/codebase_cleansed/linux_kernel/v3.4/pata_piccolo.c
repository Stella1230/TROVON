static void tosh_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstatic const u16 pio[6] = {\r\n0x0566, 0x0433, 0x0311, 0x0201, 0x0200, 0x0100\r\n};\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu16 conf;\r\npci_read_config_word(pdev, 0x50, &conf);\r\nconf &= 0xE088;\r\nconf |= pio[adev->pio_mode - XFER_PIO_0];\r\npci_write_config_word(pdev, 0x50, conf);\r\n}\r\nstatic void tosh_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu32 conf;\r\npci_read_config_dword(pdev, 0x5C, &conf);\r\nconf &= 0x78FFE088;\r\nif (adev->dma_mode >= XFER_UDMA_0) {\r\nint udma = adev->dma_mode - XFER_UDMA_0;\r\nconf |= 0x80000000;\r\nconf |= (udma + 2) << 28;\r\nconf |= (2 - udma) * 0x111;\r\n} else {\r\nstatic const u32 mwdma[4] = {\r\n0x0655, 0x0200, 0x0200, 0x0100\r\n};\r\nconf |= mwdma[adev->dma_mode - XFER_MW_DMA_0];\r\n}\r\npci_write_config_dword(pdev, 0x5C, conf);\r\n}\r\nstatic int ata_tosh_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO5,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA2,\r\n.port_ops = &tosh_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, &ata_dummy_port_info };\r\nreturn ata_pci_bmdma_init_one(dev, ppi, &tosh_sht, NULL, 0);\r\n}\r\nstatic int __init ata_tosh_init(void)\r\n{\r\nreturn pci_register_driver(&ata_tosh_pci_driver);\r\n}\r\nstatic void __exit ata_tosh_exit(void)\r\n{\r\npci_unregister_driver(&ata_tosh_pci_driver);\r\n}

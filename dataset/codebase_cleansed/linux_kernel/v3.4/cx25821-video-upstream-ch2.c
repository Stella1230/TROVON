static __le32 *cx25821_update_riscprogram_ch2(struct cx25821_dev *dev,\r\n__le32 *rp, unsigned int offset,\r\nunsigned int bpl, u32 sync_line,\r\nunsigned int lines,\r\nint fifo_enable, int field_type)\r\n{\r\nunsigned int line, i;\r\nint dist_betwn_starts = bpl * 2;\r\n*(rp++) = cpu_to_le32(RISC_RESYNC | sync_line);\r\nif (USE_RISC_NOOP_VIDEO) {\r\nfor (i = 0; i < NUM_NO_OPS; i++)\r\n*(rp++) = cpu_to_le32(RISC_NOOP);\r\n}\r\nfor (line = 0; line < lines; line++) {\r\n*(rp++) = cpu_to_le32(RISC_READ | RISC_SOL | RISC_EOL | bpl);\r\n*(rp++) = cpu_to_le32(dev->_data_buf_phys_addr_ch2 + offset);\r\n*(rp++) = cpu_to_le32(0);\r\nif ((lines <= NTSC_FIELD_HEIGHT) ||\r\n(line < (NTSC_FIELD_HEIGHT - 1)) || !(dev->_isNTSC_ch2)) {\r\noffset += dist_betwn_starts;\r\n}\r\n}\r\nreturn rp;\r\n}\r\nstatic __le32 *cx25821_risc_field_upstream_ch2(struct cx25821_dev *dev,\r\n__le32 *rp,\r\ndma_addr_t databuf_phys_addr,\r\nunsigned int offset,\r\nu32 sync_line, unsigned int bpl,\r\nunsigned int lines,\r\nint fifo_enable, int field_type)\r\n{\r\nunsigned int line, i;\r\nstruct sram_channel *sram_ch =\r\ndev->channels[dev->_channel2_upstream_select].sram_channels;\r\nint dist_betwn_starts = bpl * 2;\r\nif (sync_line != NO_SYNC_LINE)\r\n*(rp++) = cpu_to_le32(RISC_RESYNC | sync_line);\r\nif (USE_RISC_NOOP_VIDEO) {\r\nfor (i = 0; i < NUM_NO_OPS; i++)\r\n*(rp++) = cpu_to_le32(RISC_NOOP);\r\n}\r\nfor (line = 0; line < lines; line++) {\r\n*(rp++) = cpu_to_le32(RISC_READ | RISC_SOL | RISC_EOL | bpl);\r\n*(rp++) = cpu_to_le32(databuf_phys_addr + offset);\r\n*(rp++) = cpu_to_le32(0);\r\nif ((lines <= NTSC_FIELD_HEIGHT) ||\r\n(line < (NTSC_FIELD_HEIGHT - 1)) || !(dev->_isNTSC_ch2)) {\r\noffset += dist_betwn_starts;\r\n}\r\nif (fifo_enable && line == 3) {\r\n*(rp++) = RISC_WRITECR;\r\n*(rp++) = sram_ch->dma_ctl;\r\n*(rp++) = FLD_VID_FIFO_EN;\r\n*(rp++) = 0x00000001;\r\n}\r\n}\r\nreturn rp;\r\n}\r\nint cx25821_risc_buffer_upstream_ch2(struct cx25821_dev *dev,\r\nstruct pci_dev *pci,\r\nunsigned int top_offset, unsigned int bpl,\r\nunsigned int lines)\r\n{\r\n__le32 *rp;\r\nint fifo_enable = 0;\r\nint singlefield_lines = lines >> 1;\r\nint odd_num_lines = singlefield_lines;\r\nint frame = 0;\r\nint frame_size = 0;\r\nint databuf_offset = 0;\r\nint risc_program_size = 0;\r\nint risc_flag = RISC_CNT_RESET;\r\nunsigned int bottom_offset = bpl;\r\ndma_addr_t risc_phys_jump_addr;\r\nif (dev->_isNTSC_ch2) {\r\nodd_num_lines = singlefield_lines + 1;\r\nrisc_program_size = FRAME1_VID_PROG_SIZE;\r\nif (bpl == Y411_LINE_SZ)\r\nframe_size = FRAME_SIZE_NTSC_Y411;\r\nelse\r\nframe_size = FRAME_SIZE_NTSC_Y422;\r\n} else {\r\nrisc_program_size = PAL_VID_PROG_SIZE;\r\nif (bpl == Y411_LINE_SZ)\r\nframe_size = FRAME_SIZE_PAL_Y411;\r\nelse\r\nframe_size = FRAME_SIZE_PAL_Y422;\r\n}\r\nrp = dev->_dma_virt_addr_ch2;\r\nfor (frame = 0; frame < NUM_FRAMES; frame++) {\r\ndatabuf_offset = frame_size * frame;\r\nif (UNSET != top_offset) {\r\nfifo_enable = (frame == 0) ? FIFO_ENABLE : FIFO_DISABLE;\r\nrp = cx25821_risc_field_upstream_ch2(dev, rp,\r\ndev->_data_buf_phys_addr_ch2 + databuf_offset,\r\ntop_offset, 0, bpl, odd_num_lines, fifo_enable,\r\nODD_FIELD);\r\n}\r\nfifo_enable = FIFO_DISABLE;\r\nrp = cx25821_risc_field_upstream_ch2(dev, rp,\r\ndev->_data_buf_phys_addr_ch2 + databuf_offset,\r\nbottom_offset, 0x200, bpl, singlefield_lines,\r\nfifo_enable, EVEN_FIELD);\r\nif (frame == 0) {\r\nrisc_flag = RISC_CNT_RESET;\r\nrisc_phys_jump_addr = dev->_dma_phys_start_addr_ch2 +\r\nrisc_program_size;\r\n} else {\r\nrisc_flag = RISC_CNT_INC;\r\nrisc_phys_jump_addr = dev->_dma_phys_start_addr_ch2;\r\n}\r\n*(rp++) = cpu_to_le32(RISC_JUMP | RISC_IRQ1 | risc_flag);\r\n*(rp++) = cpu_to_le32(risc_phys_jump_addr);\r\n*(rp++) = cpu_to_le32(0);\r\n}\r\nreturn 0;\r\n}\r\nvoid cx25821_stop_upstream_video_ch2(struct cx25821_dev *dev)\r\n{\r\nstruct sram_channel *sram_ch =\r\ndev->channels[VID_UPSTREAM_SRAM_CHANNEL_J].sram_channels;\r\nu32 tmp = 0;\r\nif (!dev->_is_running_ch2) {\r\npr_info("No video file is currently running so return!\n");\r\nreturn;\r\n}\r\ntmp = cx_read(sram_ch->int_msk);\r\ncx_write(sram_ch->int_msk, tmp & ~_intr_msk);\r\ntmp = cx_read(sram_ch->dma_ctl);\r\ncx_write(sram_ch->dma_ctl, tmp & ~(FLD_VID_FIFO_EN | FLD_VID_RISC_EN));\r\nif (dev->_data_buf_virt_addr_ch2)\r\nmemset(dev->_data_buf_virt_addr_ch2, 0,\r\ndev->_data_buf_size_ch2);\r\ndev->_is_running_ch2 = 0;\r\ndev->_is_first_frame_ch2 = 0;\r\ndev->_frame_count_ch2 = 0;\r\ndev->_file_status_ch2 = END_OF_FILE;\r\nkfree(dev->_irq_queues_ch2);\r\ndev->_irq_queues_ch2 = NULL;\r\nkfree(dev->_filename_ch2);\r\ntmp = cx_read(VID_CH_MODE_SEL);\r\ncx_write(VID_CH_MODE_SEL, tmp & 0xFFFFFE00);\r\n}\r\nvoid cx25821_free_mem_upstream_ch2(struct cx25821_dev *dev)\r\n{\r\nif (dev->_is_running_ch2)\r\ncx25821_stop_upstream_video_ch2(dev);\r\nif (dev->_dma_virt_addr_ch2) {\r\npci_free_consistent(dev->pci, dev->_risc_size_ch2,\r\ndev->_dma_virt_addr_ch2,\r\ndev->_dma_phys_addr_ch2);\r\ndev->_dma_virt_addr_ch2 = NULL;\r\n}\r\nif (dev->_data_buf_virt_addr_ch2) {\r\npci_free_consistent(dev->pci, dev->_data_buf_size_ch2,\r\ndev->_data_buf_virt_addr_ch2,\r\ndev->_data_buf_phys_addr_ch2);\r\ndev->_data_buf_virt_addr_ch2 = NULL;\r\n}\r\n}\r\nint cx25821_get_frame_ch2(struct cx25821_dev *dev, struct sram_channel *sram_ch)\r\n{\r\nstruct file *myfile;\r\nint frame_index_temp = dev->_frame_index_ch2;\r\nint i = 0;\r\nint line_size = (dev->_pixel_format_ch2 == PIXEL_FRMT_411) ?\r\nY411_LINE_SZ : Y422_LINE_SZ;\r\nint frame_size = 0;\r\nint frame_offset = 0;\r\nssize_t vfs_read_retval = 0;\r\nchar mybuf[line_size];\r\nloff_t file_offset;\r\nloff_t pos;\r\nmm_segment_t old_fs;\r\nif (dev->_file_status_ch2 == END_OF_FILE)\r\nreturn 0;\r\nif (dev->_isNTSC_ch2) {\r\nframe_size = (line_size == Y411_LINE_SZ) ?\r\nFRAME_SIZE_NTSC_Y411 : FRAME_SIZE_NTSC_Y422;\r\n} else {\r\nframe_size = (line_size == Y411_LINE_SZ) ?\r\nFRAME_SIZE_PAL_Y411 : FRAME_SIZE_PAL_Y422;\r\n}\r\nframe_offset = (frame_index_temp > 0) ? frame_size : 0;\r\nfile_offset = dev->_frame_count_ch2 * frame_size;\r\nmyfile = filp_open(dev->_filename_ch2, O_RDONLY | O_LARGEFILE, 0);\r\nif (IS_ERR(myfile)) {\r\nconst int open_errno = -PTR_ERR(myfile);\r\npr_err("%s(): ERROR opening file(%s) with errno = %d!\n",\r\n__func__, dev->_filename_ch2, open_errno);\r\nreturn PTR_ERR(myfile);\r\n} else {\r\nif (!(myfile->f_op)) {\r\npr_err("%s(): File has no file operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\nif (!myfile->f_op->read) {\r\npr_err("%s(): File has no READ operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\npos = myfile->f_pos;\r\nold_fs = get_fs();\r\nset_fs(KERNEL_DS);\r\nfor (i = 0; i < dev->_lines_count_ch2; i++) {\r\npos = file_offset;\r\nvfs_read_retval = vfs_read(myfile, mybuf, line_size,\r\n&pos);\r\nif (vfs_read_retval > 0 && vfs_read_retval == line_size\r\n&& dev->_data_buf_virt_addr_ch2 != NULL) {\r\nmemcpy((void *)(dev->_data_buf_virt_addr_ch2 +\r\nframe_offset / 4), mybuf,\r\nvfs_read_retval);\r\n}\r\nfile_offset += vfs_read_retval;\r\nframe_offset += vfs_read_retval;\r\nif (vfs_read_retval < line_size) {\r\npr_info("Done: exit %s() since no more bytes to read from Video file\n",\r\n__func__);\r\nbreak;\r\n}\r\n}\r\nif (i > 0)\r\ndev->_frame_count_ch2++;\r\ndev->_file_status_ch2 = (vfs_read_retval == line_size) ?\r\nIN_PROGRESS : END_OF_FILE;\r\nset_fs(old_fs);\r\nfilp_close(myfile, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic void cx25821_vidups_handler_ch2(struct work_struct *work)\r\n{\r\nstruct cx25821_dev *dev = container_of(work, struct cx25821_dev,\r\n_irq_work_entry_ch2);\r\nif (!dev) {\r\npr_err("ERROR %s(): since container_of(work_struct) FAILED!\n",\r\n__func__);\r\nreturn;\r\n}\r\ncx25821_get_frame_ch2(dev, dev->channels[dev->\r\n_channel2_upstream_select].sram_channels);\r\n}\r\nint cx25821_openfile_ch2(struct cx25821_dev *dev, struct sram_channel *sram_ch)\r\n{\r\nstruct file *myfile;\r\nint i = 0, j = 0;\r\nint line_size = (dev->_pixel_format_ch2 == PIXEL_FRMT_411) ?\r\nY411_LINE_SZ : Y422_LINE_SZ;\r\nssize_t vfs_read_retval = 0;\r\nchar mybuf[line_size];\r\nloff_t pos;\r\nloff_t offset = (unsigned long)0;\r\nmm_segment_t old_fs;\r\nmyfile = filp_open(dev->_filename_ch2, O_RDONLY | O_LARGEFILE, 0);\r\nif (IS_ERR(myfile)) {\r\nconst int open_errno = -PTR_ERR(myfile);\r\npr_err("%s(): ERROR opening file(%s) with errno = %d!\n",\r\n__func__, dev->_filename_ch2, open_errno);\r\nreturn PTR_ERR(myfile);\r\n} else {\r\nif (!(myfile->f_op)) {\r\npr_err("%s(): File has no file operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\nif (!myfile->f_op->read) {\r\npr_err("%s(): File has no READ operations registered! Returning\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\npos = myfile->f_pos;\r\nold_fs = get_fs();\r\nset_fs(KERNEL_DS);\r\nfor (j = 0; j < NUM_FRAMES; j++) {\r\nfor (i = 0; i < dev->_lines_count_ch2; i++) {\r\npos = offset;\r\nvfs_read_retval = vfs_read(myfile, mybuf,\r\nline_size, &pos);\r\nif (vfs_read_retval > 0 &&\r\nvfs_read_retval == line_size &&\r\ndev->_data_buf_virt_addr_ch2 != NULL) {\r\nmemcpy((void *)(dev->\r\n_data_buf_virt_addr_ch2\r\n+ offset / 4), mybuf,\r\nvfs_read_retval);\r\n}\r\noffset += vfs_read_retval;\r\nif (vfs_read_retval < line_size) {\r\npr_info("Done: exit %s() since no more bytes to read from Video file\n",\r\n__func__);\r\nbreak;\r\n}\r\n}\r\nif (i > 0)\r\ndev->_frame_count_ch2++;\r\nif (vfs_read_retval < line_size)\r\nbreak;\r\n}\r\ndev->_file_status_ch2 = (vfs_read_retval == line_size) ?\r\nIN_PROGRESS : END_OF_FILE;\r\nset_fs(old_fs);\r\nmyfile->f_pos = 0;\r\nfilp_close(myfile, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic int cx25821_upstream_buffer_prepare_ch2(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch,\r\nint bpl)\r\n{\r\nint ret = 0;\r\ndma_addr_t dma_addr;\r\ndma_addr_t data_dma_addr;\r\nif (dev->_dma_virt_addr_ch2 != NULL) {\r\npci_free_consistent(dev->pci, dev->upstream_riscbuf_size_ch2,\r\ndev->_dma_virt_addr_ch2,\r\ndev->_dma_phys_addr_ch2);\r\n}\r\ndev->_dma_virt_addr_ch2 = pci_alloc_consistent(dev->pci,\r\ndev->upstream_riscbuf_size_ch2, &dma_addr);\r\ndev->_dma_virt_start_addr_ch2 = dev->_dma_virt_addr_ch2;\r\ndev->_dma_phys_start_addr_ch2 = dma_addr;\r\ndev->_dma_phys_addr_ch2 = dma_addr;\r\ndev->_risc_size_ch2 = dev->upstream_riscbuf_size_ch2;\r\nif (!dev->_dma_virt_addr_ch2) {\r\npr_err("FAILED to allocate memory for Risc buffer! Returning\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(dev->_dma_virt_addr_ch2, 0, dev->_risc_size_ch2);\r\nif (dev->_data_buf_virt_addr_ch2 != NULL) {\r\npci_free_consistent(dev->pci, dev->upstream_databuf_size_ch2,\r\ndev->_data_buf_virt_addr_ch2,\r\ndev->_data_buf_phys_addr_ch2);\r\n}\r\ndev->_data_buf_virt_addr_ch2 = pci_alloc_consistent(dev->pci,\r\ndev->upstream_databuf_size_ch2, &data_dma_addr);\r\ndev->_data_buf_phys_addr_ch2 = data_dma_addr;\r\ndev->_data_buf_size_ch2 = dev->upstream_databuf_size_ch2;\r\nif (!dev->_data_buf_virt_addr_ch2) {\r\npr_err("FAILED to allocate memory for data buffer! Returning\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(dev->_data_buf_virt_addr_ch2, 0, dev->_data_buf_size_ch2);\r\nret = cx25821_openfile_ch2(dev, sram_ch);\r\nif (ret < 0)\r\nreturn ret;\r\nret = cx25821_risc_buffer_upstream_ch2(dev, dev->pci, 0, bpl,\r\ndev->_lines_count_ch2);\r\nif (ret < 0) {\r\npr_info("Failed creating Video Upstream Risc programs!\n");\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nreturn ret;\r\n}\r\nint cx25821_video_upstream_irq_ch2(struct cx25821_dev *dev, int chan_num,\r\nu32 status)\r\n{\r\nu32 int_msk_tmp;\r\nstruct sram_channel *channel = dev->channels[chan_num].sram_channels;\r\nint singlefield_lines = NTSC_FIELD_HEIGHT;\r\nint line_size_in_bytes = Y422_LINE_SZ;\r\nint odd_risc_prog_size = 0;\r\ndma_addr_t risc_phys_jump_addr;\r\n__le32 *rp;\r\nif (status & FLD_VID_SRC_RISC1) {\r\nu32 prog_cnt = cx_read(channel->gpcnt);\r\nint_msk_tmp = cx_read(channel->int_msk);\r\ncx_write(channel->int_msk, int_msk_tmp & ~_intr_msk);\r\ncx_write(channel->int_stat, _intr_msk);\r\nspin_lock(&dev->slock);\r\ndev->_frame_index_ch2 = prog_cnt;\r\nqueue_work(dev->_irq_queues_ch2, &dev->_irq_work_entry_ch2);\r\nif (dev->_is_first_frame_ch2) {\r\ndev->_is_first_frame_ch2 = 0;\r\nif (dev->_isNTSC_ch2) {\r\nsinglefield_lines += 1;\r\nodd_risc_prog_size = ODD_FLD_NTSC_PROG_SIZE;\r\n} else {\r\nsinglefield_lines = PAL_FIELD_HEIGHT;\r\nodd_risc_prog_size = ODD_FLD_PAL_PROG_SIZE;\r\n}\r\nif (dev->_dma_virt_start_addr_ch2 != NULL) {\r\nif (dev->_pixel_format_ch2 == PIXEL_FRMT_411)\r\nline_size_in_bytes = Y411_LINE_SZ;\r\nelse\r\nline_size_in_bytes = Y422_LINE_SZ;\r\nrisc_phys_jump_addr =\r\ndev->_dma_phys_start_addr_ch2 +\r\nodd_risc_prog_size;\r\nrp = cx25821_update_riscprogram_ch2(dev,\r\ndev->_dma_virt_start_addr_ch2,\r\nTOP_OFFSET, line_size_in_bytes,\r\n0x0, singlefield_lines,\r\nFIFO_DISABLE, ODD_FIELD);\r\n*(rp++) = cpu_to_le32(RISC_JUMP);\r\n*(rp++) = cpu_to_le32(risc_phys_jump_addr);\r\n*(rp++) = cpu_to_le32(0);\r\n}\r\n}\r\nspin_unlock(&dev->slock);\r\n}\r\nif (dev->_file_status_ch2 == END_OF_FILE) {\r\npr_info("EOF Channel 2 Framecount = %d\n",\r\ndev->_frame_count_ch2);\r\nreturn -1;\r\n}\r\nint_msk_tmp = cx_read(channel->int_msk);\r\ncx_write(channel->int_msk, int_msk_tmp |= _intr_msk);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t cx25821_upstream_irq_ch2(int irq, void *dev_id)\r\n{\r\nstruct cx25821_dev *dev = dev_id;\r\nu32 msk_stat, vid_status;\r\nint handled = 0;\r\nint channel_num = 0;\r\nstruct sram_channel *sram_ch;\r\nif (!dev)\r\nreturn -1;\r\nchannel_num = VID_UPSTREAM_SRAM_CHANNEL_J;\r\nsram_ch = dev->channels[channel_num].sram_channels;\r\nmsk_stat = cx_read(sram_ch->int_mstat);\r\nvid_status = cx_read(sram_ch->int_stat);\r\nif (vid_status)\r\nhandled = cx25821_video_upstream_irq_ch2(dev, channel_num,\r\nvid_status);\r\nif (handled < 0)\r\ncx25821_stop_upstream_video_ch2(dev);\r\nelse\r\nhandled += handled;\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void cx25821_set_pixelengine_ch2(struct cx25821_dev *dev,\r\nstruct sram_channel *ch, int pix_format)\r\n{\r\nint width = WIDTH_D1;\r\nint height = dev->_lines_count_ch2;\r\nint num_lines, odd_num_lines;\r\nu32 value;\r\nint vip_mode = PIXEL_ENGINE_VIP1;\r\nvalue = ((pix_format & 0x3) << 12) | (vip_mode & 0x7);\r\nvalue &= 0xFFFFFFEF;\r\nvalue |= dev->_isNTSC_ch2 ? 0 : 0x10;\r\ncx_write(ch->vid_fmt_ctl, value);\r\ncx_write(ch->vid_active_ctl1, width);\r\nnum_lines = (height / 2) & 0x3FF;\r\nodd_num_lines = num_lines;\r\nif (dev->_isNTSC_ch2)\r\nodd_num_lines += 1;\r\nvalue = (num_lines << 16) | odd_num_lines;\r\ncx_write(ch->vid_active_ctl2, value);\r\ncx_write(ch->vid_cdt_size, VID_CDT_SIZE >> 3);\r\n}\r\nint cx25821_start_video_dma_upstream_ch2(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch)\r\n{\r\nu32 tmp = 0;\r\nint err = 0;\r\ntmp = cx_read(VID_CH_MODE_SEL);\r\ncx_write(VID_CH_MODE_SEL, tmp | 0x1B0001FF);\r\ncx_write(sram_ch->cmds_start + 0, dev->_dma_phys_addr_ch2);\r\ncx_write(sram_ch->cmds_start + 4, 0);\r\ncx_write(sram_ch->gpcnt_ctl, 3);\r\ncx_write(sram_ch->int_stat, _intr_msk);\r\ncx_set(PCI_INT_MSK, cx_read(PCI_INT_MSK) | (1 << sram_ch->irq_bit));\r\ntmp = cx_read(sram_ch->int_msk);\r\ncx_write(sram_ch->int_msk, tmp |= _intr_msk);\r\nerr = request_irq(dev->pci->irq, cx25821_upstream_irq_ch2,\r\nIRQF_SHARED, dev->name, dev);\r\nif (err < 0) {\r\npr_err("%s: can't get upstream IRQ %d\n",\r\ndev->name, dev->pci->irq);\r\ngoto fail_irq;\r\n}\r\ntmp = cx_read(sram_ch->dma_ctl);\r\ncx_set(sram_ch->dma_ctl, tmp | FLD_VID_RISC_EN);\r\ndev->_is_running_ch2 = 1;\r\ndev->_is_first_frame_ch2 = 1;\r\nreturn 0;\r\nfail_irq:\r\ncx25821_dev_unregister(dev);\r\nreturn err;\r\n}\r\nint cx25821_vidupstream_init_ch2(struct cx25821_dev *dev, int channel_select,\r\nint pixel_format)\r\n{\r\nstruct sram_channel *sram_ch;\r\nu32 tmp;\r\nint retval = 0;\r\nint err = 0;\r\nint data_frame_size = 0;\r\nint risc_buffer_size = 0;\r\nint str_length = 0;\r\nif (dev->_is_running_ch2) {\r\npr_info("Video Channel is still running so return!\n");\r\nreturn 0;\r\n}\r\ndev->_channel2_upstream_select = channel_select;\r\nsram_ch = dev->channels[channel_select].sram_channels;\r\nINIT_WORK(&dev->_irq_work_entry_ch2, cx25821_vidups_handler_ch2);\r\ndev->_irq_queues_ch2 =\r\ncreate_singlethread_workqueue("cx25821_workqueue2");\r\nif (!dev->_irq_queues_ch2) {\r\npr_err("create_singlethread_workqueue() for Video FAILED!\n");\r\nreturn -ENOMEM;\r\n}\r\ntmp = cx_read(VID_CH_MODE_SEL);\r\ncx_write(VID_CH_MODE_SEL, tmp | 0x1B0001FF);\r\ndev->_is_running_ch2 = 0;\r\ndev->_frame_count_ch2 = 0;\r\ndev->_file_status_ch2 = RESET_STATUS;\r\ndev->_lines_count_ch2 = dev->_isNTSC_ch2 ? 480 : 576;\r\ndev->_pixel_format_ch2 = pixel_format;\r\ndev->_line_size_ch2 = (dev->_pixel_format_ch2 == PIXEL_FRMT_422) ?\r\n(WIDTH_D1 * 2) : (WIDTH_D1 * 3) / 2;\r\ndata_frame_size = dev->_isNTSC_ch2 ? NTSC_DATA_BUF_SZ : PAL_DATA_BUF_SZ;\r\nrisc_buffer_size = dev->_isNTSC_ch2 ?\r\nNTSC_RISC_BUF_SIZE : PAL_RISC_BUF_SIZE;\r\nif (dev->input_filename_ch2) {\r\nstr_length = strlen(dev->input_filename_ch2);\r\ndev->_filename_ch2 = kmemdup(dev->input_filename_ch2,\r\nstr_length + 1, GFP_KERNEL);\r\nif (!dev->_filename_ch2)\r\ngoto error;\r\n} else {\r\nstr_length = strlen(dev->_defaultname_ch2);\r\ndev->_filename_ch2 = kmemdup(dev->_defaultname_ch2,\r\nstr_length + 1, GFP_KERNEL);\r\nif (!dev->_filename_ch2)\r\ngoto error;\r\n}\r\nif (strcmp(dev->input_filename_ch2, "") == 0) {\r\nif (dev->_isNTSC_ch2) {\r\ndev->_filename_ch2 = (dev->_pixel_format_ch2 ==\r\nPIXEL_FRMT_411) ? "/root/vid411.yuv" :\r\n"/root/vidtest.yuv";\r\n} else {\r\ndev->_filename_ch2 = (dev->_pixel_format_ch2 ==\r\nPIXEL_FRMT_411) ? "/root/pal411.yuv" :\r\n"/root/pal422.yuv";\r\n}\r\n}\r\nretval = cx25821_sram_channel_setup_upstream(dev, sram_ch,\r\ndev->_line_size_ch2, 0);\r\ncx25821_set_pixelengine_ch2(dev, sram_ch, dev->_pixel_format_ch2);\r\ndev->upstream_riscbuf_size_ch2 = risc_buffer_size * 2;\r\ndev->upstream_databuf_size_ch2 = data_frame_size * 2;\r\nretval = cx25821_upstream_buffer_prepare_ch2(dev, sram_ch,\r\ndev->_line_size_ch2);\r\nif (retval < 0) {\r\npr_err("%s: Failed to set up Video upstream buffers!\n",\r\ndev->name);\r\ngoto error;\r\n}\r\ncx25821_start_video_dma_upstream_ch2(dev, sram_ch);\r\nreturn 0;\r\nerror:\r\ncx25821_dev_unregister(dev);\r\nreturn err;\r\n}

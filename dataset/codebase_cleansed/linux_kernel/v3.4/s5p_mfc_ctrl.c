int s5p_mfc_alloc_and_load_firmware(struct s5p_mfc_dev *dev)\r\n{\r\nstruct firmware *fw_blob;\r\nsize_t bank2_base_phys;\r\nvoid *b_base;\r\nint err;\r\nmfc_debug_enter();\r\nerr = request_firmware((const struct firmware **)&fw_blob,\r\n"s5p-mfc.fw", dev->v4l2_dev.dev);\r\nif (err != 0) {\r\nmfc_err("Firmware is not present in the /lib/firmware directory nor compiled in kernel\n");\r\nreturn -EINVAL;\r\n}\r\ndev->fw_size = ALIGN(fw_blob->size, FIRMWARE_ALIGN);\r\nif (s5p_mfc_bitproc_buf) {\r\nmfc_err("Attempting to allocate firmware when it seems that it is already loaded\n");\r\nrelease_firmware(fw_blob);\r\nreturn -ENOMEM;\r\n}\r\ns5p_mfc_bitproc_buf = vb2_dma_contig_memops.alloc(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], dev->fw_size);\r\nif (IS_ERR(s5p_mfc_bitproc_buf)) {\r\ns5p_mfc_bitproc_buf = 0;\r\nmfc_err("Allocating bitprocessor buffer failed\n");\r\nrelease_firmware(fw_blob);\r\nreturn -ENOMEM;\r\n}\r\ns5p_mfc_bitproc_phys = s5p_mfc_mem_cookie(\r\ndev->alloc_ctx[MFC_BANK1_ALLOC_CTX], s5p_mfc_bitproc_buf);\r\nif (s5p_mfc_bitproc_phys & ((1 << MFC_BASE_ALIGN_ORDER) - 1)) {\r\nmfc_err("The base memory for bank 1 is not aligned to 128KB\n");\r\nvb2_dma_contig_memops.put(s5p_mfc_bitproc_buf);\r\ns5p_mfc_bitproc_phys = 0;\r\ns5p_mfc_bitproc_buf = 0;\r\nrelease_firmware(fw_blob);\r\nreturn -EIO;\r\n}\r\ns5p_mfc_bitproc_virt = vb2_dma_contig_memops.vaddr(s5p_mfc_bitproc_buf);\r\nif (!s5p_mfc_bitproc_virt) {\r\nmfc_err("Bitprocessor memory remap failed\n");\r\nvb2_dma_contig_memops.put(s5p_mfc_bitproc_buf);\r\ns5p_mfc_bitproc_phys = 0;\r\ns5p_mfc_bitproc_buf = 0;\r\nrelease_firmware(fw_blob);\r\nreturn -EIO;\r\n}\r\ndev->bank1 = s5p_mfc_bitproc_phys;\r\nb_base = vb2_dma_contig_memops.alloc(\r\ndev->alloc_ctx[MFC_BANK2_ALLOC_CTX], 1 << MFC_BANK2_ALIGN_ORDER);\r\nif (IS_ERR(b_base)) {\r\nvb2_dma_contig_memops.put(s5p_mfc_bitproc_buf);\r\ns5p_mfc_bitproc_phys = 0;\r\ns5p_mfc_bitproc_buf = 0;\r\nmfc_err("Allocating bank2 base failed\n");\r\nrelease_firmware(fw_blob);\r\nreturn -ENOMEM;\r\n}\r\nbank2_base_phys = s5p_mfc_mem_cookie(\r\ndev->alloc_ctx[MFC_BANK2_ALLOC_CTX], b_base);\r\nvb2_dma_contig_memops.put(b_base);\r\nif (bank2_base_phys & ((1 << MFC_BASE_ALIGN_ORDER) - 1)) {\r\nmfc_err("The base memory for bank 2 is not aligned to 128KB\n");\r\nvb2_dma_contig_memops.put(s5p_mfc_bitproc_buf);\r\ns5p_mfc_bitproc_phys = 0;\r\ns5p_mfc_bitproc_buf = 0;\r\nrelease_firmware(fw_blob);\r\nreturn -EIO;\r\n}\r\ndev->bank2 = bank2_base_phys;\r\nmemcpy(s5p_mfc_bitproc_virt, fw_blob->data, fw_blob->size);\r\nwmb();\r\nrelease_firmware(fw_blob);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_reload_firmware(struct s5p_mfc_dev *dev)\r\n{\r\nstruct firmware *fw_blob;\r\nint err;\r\nmfc_debug_enter();\r\nerr = request_firmware((const struct firmware **)&fw_blob,\r\n"s5p-mfc.fw", dev->v4l2_dev.dev);\r\nif (err != 0) {\r\nmfc_err("Firmware is not present in the /lib/firmware directory nor compiled in kernel\n");\r\nreturn -EINVAL;\r\n}\r\nif (fw_blob->size > dev->fw_size) {\r\nmfc_err("MFC firmware is too big to be loaded\n");\r\nrelease_firmware(fw_blob);\r\nreturn -ENOMEM;\r\n}\r\nif (s5p_mfc_bitproc_buf == 0 || s5p_mfc_bitproc_phys == 0) {\r\nmfc_err("MFC firmware is not allocated or was not mapped correctly\n");\r\nrelease_firmware(fw_blob);\r\nreturn -EINVAL;\r\n}\r\nmemcpy(s5p_mfc_bitproc_virt, fw_blob->data, fw_blob->size);\r\nwmb();\r\nrelease_firmware(fw_blob);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_release_firmware(struct s5p_mfc_dev *dev)\r\n{\r\nif (!s5p_mfc_bitproc_buf)\r\nreturn -EINVAL;\r\nvb2_dma_contig_memops.put(s5p_mfc_bitproc_buf);\r\ns5p_mfc_bitproc_virt = 0;\r\ns5p_mfc_bitproc_phys = 0;\r\ns5p_mfc_bitproc_buf = 0;\r\nreturn 0;\r\n}\r\nint s5p_mfc_reset(struct s5p_mfc_dev *dev)\r\n{\r\nunsigned int mc_status;\r\nunsigned long timeout;\r\nmfc_debug_enter();\r\nmfc_write(dev, 0x3f6, S5P_FIMV_SW_RESET);\r\nmfc_write(dev, 0x3e2, S5P_FIMV_SW_RESET);\r\nmdelay(10);\r\ntimeout = jiffies + msecs_to_jiffies(MFC_BW_TIMEOUT);\r\ndo {\r\nif (time_after(jiffies, timeout)) {\r\nmfc_err("Timeout while resetting MFC\n");\r\nreturn -EIO;\r\n}\r\nmc_status = mfc_read(dev, S5P_FIMV_MC_STATUS);\r\n} while (mc_status & 0x3);\r\nmfc_write(dev, 0x0, S5P_FIMV_SW_RESET);\r\nmfc_write(dev, 0x3fe, S5P_FIMV_SW_RESET);\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nstatic inline void s5p_mfc_init_memctrl(struct s5p_mfc_dev *dev)\r\n{\r\nmfc_write(dev, dev->bank1, S5P_FIMV_MC_DRAMBASE_ADR_A);\r\nmfc_write(dev, dev->bank2, S5P_FIMV_MC_DRAMBASE_ADR_B);\r\nmfc_debug(2, "Bank1: %08x, Bank2: %08x\n", dev->bank1, dev->bank2);\r\n}\r\nstatic inline void s5p_mfc_clear_cmds(struct s5p_mfc_dev *dev)\r\n{\r\nmfc_write(dev, 0xffffffff, S5P_FIMV_SI_CH0_INST_ID);\r\nmfc_write(dev, 0xffffffff, S5P_FIMV_SI_CH1_INST_ID);\r\nmfc_write(dev, 0, S5P_FIMV_RISC2HOST_CMD);\r\nmfc_write(dev, 0, S5P_FIMV_HOST2RISC_CMD);\r\n}\r\nint s5p_mfc_init_hw(struct s5p_mfc_dev *dev)\r\n{\r\nunsigned int ver;\r\nint ret;\r\nmfc_debug_enter();\r\nif (!s5p_mfc_bitproc_buf)\r\nreturn -EINVAL;\r\nmfc_debug(2, "MFC reset..\n");\r\ns5p_mfc_clock_on();\r\nret = s5p_mfc_reset(dev);\r\nif (ret) {\r\nmfc_err("Failed to reset MFC - timeout\n");\r\nreturn ret;\r\n}\r\nmfc_debug(2, "Done MFC reset..\n");\r\ns5p_mfc_init_memctrl(dev);\r\ns5p_mfc_clear_cmds(dev);\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nmfc_write(dev, 0x3ff, S5P_FIMV_SW_RESET);\r\nmfc_debug(2, "Will now wait for completion of firmware transfer\n");\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_FIMV_R2H_CMD_FW_STATUS_RET)) {\r\nmfc_err("Failed to load firmware\n");\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn -EIO;\r\n}\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nret = s5p_mfc_sys_init_cmd(dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFC - timeout\n");\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn ret;\r\n}\r\nmfc_debug(2, "Ok, now will write a command to init the system\n");\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_FIMV_R2H_CMD_SYS_INIT_RET)) {\r\nmfc_err("Failed to load firmware\n");\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn -EIO;\r\n}\r\ndev->int_cond = 0;\r\nif (dev->int_err != 0 || dev->int_type !=\r\nS5P_FIMV_R2H_CMD_SYS_INIT_RET) {\r\nmfc_err("Failed to init firmware - error: %d int: %d\n",\r\ndev->int_err, dev->int_type);\r\ns5p_mfc_reset(dev);\r\ns5p_mfc_clock_off();\r\nreturn -EIO;\r\n}\r\nver = mfc_read(dev, S5P_FIMV_FW_VERSION);\r\nmfc_debug(2, "MFC F/W version : %02xyy, %02xmm, %02xdd\n",\r\n(ver >> 16) & 0xFF, (ver >> 8) & 0xFF, ver & 0xFF);\r\ns5p_mfc_clock_off();\r\nmfc_debug_leave();\r\nreturn 0;\r\n}\r\nint s5p_mfc_sleep(struct s5p_mfc_dev *dev)\r\n{\r\nint ret;\r\nmfc_debug_enter();\r\ns5p_mfc_clock_on();\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nret = s5p_mfc_sleep_cmd(dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFC - timeout\n");\r\nreturn ret;\r\n}\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_FIMV_R2H_CMD_SLEEP_RET)) {\r\nmfc_err("Failed to sleep\n");\r\nreturn -EIO;\r\n}\r\ns5p_mfc_clock_off();\r\ndev->int_cond = 0;\r\nif (dev->int_err != 0 || dev->int_type !=\r\nS5P_FIMV_R2H_CMD_SLEEP_RET) {\r\nmfc_err("Failed to sleep - error: %d int: %d\n", dev->int_err,\r\ndev->int_type);\r\nreturn -EIO;\r\n}\r\nmfc_debug_leave();\r\nreturn ret;\r\n}\r\nint s5p_mfc_wakeup(struct s5p_mfc_dev *dev)\r\n{\r\nint ret;\r\nmfc_debug_enter();\r\nmfc_debug(2, "MFC reset..\n");\r\ns5p_mfc_clock_on();\r\nret = s5p_mfc_reset(dev);\r\nif (ret) {\r\nmfc_err("Failed to reset MFC - timeout\n");\r\nreturn ret;\r\n}\r\nmfc_debug(2, "Done MFC reset..\n");\r\ns5p_mfc_init_memctrl(dev);\r\ns5p_mfc_clear_cmds(dev);\r\ns5p_mfc_clean_dev_int_flags(dev);\r\nret = s5p_mfc_wakeup_cmd(dev);\r\nif (ret) {\r\nmfc_err("Failed to send command to MFC - timeout\n");\r\nreturn ret;\r\n}\r\nmfc_write(dev, 0x3ff, S5P_FIMV_SW_RESET);\r\nmfc_debug(2, "Ok, now will write a command to wakeup the system\n");\r\nif (s5p_mfc_wait_for_done_dev(dev, S5P_FIMV_R2H_CMD_WAKEUP_RET)) {\r\nmfc_err("Failed to load firmware\n");\r\nreturn -EIO;\r\n}\r\ns5p_mfc_clock_off();\r\ndev->int_cond = 0;\r\nif (dev->int_err != 0 || dev->int_type !=\r\nS5P_FIMV_R2H_CMD_WAKEUP_RET) {\r\nmfc_err("Failed to wakeup - error: %d int: %d\n", dev->int_err,\r\ndev->int_type);\r\nreturn -EIO;\r\n}\r\nmfc_debug_leave();\r\nreturn 0;\r\n}

static inline struct xfs_buf_log_item *BUF_ITEM(struct xfs_log_item *lip)\r\n{\r\nreturn container_of(lip, struct xfs_buf_log_item, bli_item);\r\n}\r\nSTATIC void\r\nxfs_buf_item_log_debug(\r\nxfs_buf_log_item_t *bip,\r\nuint first,\r\nuint last)\r\n{\r\nuint x;\r\nuint byte;\r\nuint nbytes;\r\nuint chunk_num;\r\nuint word_num;\r\nuint bit_num;\r\nuint bit_set;\r\nuint *wordp;\r\nASSERT(bip->bli_logged != NULL);\r\nbyte = first;\r\nnbytes = last - first + 1;\r\nbfset(bip->bli_logged, first, nbytes);\r\nfor (x = 0; x < nbytes; x++) {\r\nchunk_num = byte >> XFS_BLF_SHIFT;\r\nword_num = chunk_num >> BIT_TO_WORD_SHIFT;\r\nbit_num = chunk_num & (NBWORD - 1);\r\nwordp = &(bip->bli_format.blf_data_map[word_num]);\r\nbit_set = *wordp & (1 << bit_num);\r\nASSERT(bit_set);\r\nbyte++;\r\n}\r\n}\r\nvoid\r\nxfs_buf_item_flush_log_debug(\r\nxfs_buf_t *bp,\r\nuint first,\r\nuint last)\r\n{\r\nxfs_buf_log_item_t *bip = bp->b_fspriv;\r\nuint nbytes;\r\nif (bip == NULL || (bip->bli_item.li_type != XFS_LI_BUF))\r\nreturn;\r\nASSERT(bip->bli_logged != NULL);\r\nnbytes = last - first + 1;\r\nbfset(bip->bli_logged, first, nbytes);\r\n}\r\nSTATIC void\r\nxfs_buf_item_log_check(\r\nxfs_buf_log_item_t *bip)\r\n{\r\nchar *orig;\r\nchar *buffer;\r\nint x;\r\nxfs_buf_t *bp;\r\nASSERT(bip->bli_orig != NULL);\r\nASSERT(bip->bli_logged != NULL);\r\nbp = bip->bli_buf;\r\nASSERT(XFS_BUF_COUNT(bp) > 0);\r\nASSERT(bp->b_addr != NULL);\r\norig = bip->bli_orig;\r\nbuffer = bp->b_addr;\r\nfor (x = 0; x < XFS_BUF_COUNT(bp); x++) {\r\nif (orig[x] != buffer[x] && !btst(bip->bli_logged, x)) {\r\nxfs_emerg(bp->b_mount,\r\n"%s: bip %x buffer %x orig %x index %d",\r\n__func__, bip, bp, orig, x);\r\nASSERT(0);\r\n}\r\n}\r\n}\r\nSTATIC uint\r\nxfs_buf_item_size(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nuint nvecs;\r\nint next_bit;\r\nint last_bit;\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\ntrace_xfs_buf_item_size_stale(bip);\r\nASSERT(bip->bli_format.blf_flags & XFS_BLF_CANCEL);\r\nreturn 1;\r\n}\r\nASSERT(bip->bli_flags & XFS_BLI_LOGGED);\r\nnvecs = 1;\r\nlast_bit = xfs_next_bit(bip->bli_format.blf_data_map,\r\nbip->bli_format.blf_map_size, 0);\r\nASSERT(last_bit != -1);\r\nnvecs++;\r\nwhile (last_bit != -1) {\r\nnext_bit = xfs_next_bit(bip->bli_format.blf_data_map,\r\nbip->bli_format.blf_map_size,\r\nlast_bit + 1);\r\nif (next_bit == -1) {\r\nlast_bit = -1;\r\n} else if (next_bit != last_bit + 1) {\r\nlast_bit = next_bit;\r\nnvecs++;\r\n} else if (xfs_buf_offset(bp, next_bit * XFS_BLF_CHUNK) !=\r\n(xfs_buf_offset(bp, last_bit * XFS_BLF_CHUNK) +\r\nXFS_BLF_CHUNK)) {\r\nlast_bit = next_bit;\r\nnvecs++;\r\n} else {\r\nlast_bit++;\r\n}\r\n}\r\ntrace_xfs_buf_item_size(bip);\r\nreturn nvecs;\r\n}\r\nSTATIC void\r\nxfs_buf_item_format(\r\nstruct xfs_log_item *lip,\r\nstruct xfs_log_iovec *vecp)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nuint base_size;\r\nuint nvecs;\r\nint first_bit;\r\nint last_bit;\r\nint next_bit;\r\nuint nbits;\r\nuint buffer_offset;\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nASSERT((bip->bli_flags & XFS_BLI_LOGGED) ||\r\n(bip->bli_flags & XFS_BLI_STALE));\r\nbase_size =\r\n(uint)(sizeof(xfs_buf_log_format_t) +\r\n((bip->bli_format.blf_map_size - 1) * sizeof(uint)));\r\nvecp->i_addr = &bip->bli_format;\r\nvecp->i_len = base_size;\r\nvecp->i_type = XLOG_REG_TYPE_BFORMAT;\r\nvecp++;\r\nnvecs = 1;\r\nif (bip->bli_flags & XFS_BLI_INODE_BUF) {\r\nif (!((bip->bli_flags & XFS_BLI_INODE_ALLOC_BUF) &&\r\nxfs_log_item_in_current_chkpt(lip)))\r\nbip->bli_format.blf_flags |= XFS_BLF_INODE_BUF;\r\nbip->bli_flags &= ~XFS_BLI_INODE_BUF;\r\n}\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\ntrace_xfs_buf_item_format_stale(bip);\r\nASSERT(bip->bli_format.blf_flags & XFS_BLF_CANCEL);\r\nbip->bli_format.blf_size = nvecs;\r\nreturn;\r\n}\r\nfirst_bit = xfs_next_bit(bip->bli_format.blf_data_map,\r\nbip->bli_format.blf_map_size, 0);\r\nASSERT(first_bit != -1);\r\nlast_bit = first_bit;\r\nnbits = 1;\r\nfor (;;) {\r\nnext_bit = xfs_next_bit(bip->bli_format.blf_data_map,\r\nbip->bli_format.blf_map_size,\r\n(uint)last_bit + 1);\r\nif (next_bit == -1) {\r\nbuffer_offset = first_bit * XFS_BLF_CHUNK;\r\nvecp->i_addr = xfs_buf_offset(bp, buffer_offset);\r\nvecp->i_len = nbits * XFS_BLF_CHUNK;\r\nvecp->i_type = XLOG_REG_TYPE_BCHUNK;\r\nnvecs++;\r\nbreak;\r\n} else if (next_bit != last_bit + 1) {\r\nbuffer_offset = first_bit * XFS_BLF_CHUNK;\r\nvecp->i_addr = xfs_buf_offset(bp, buffer_offset);\r\nvecp->i_len = nbits * XFS_BLF_CHUNK;\r\nvecp->i_type = XLOG_REG_TYPE_BCHUNK;\r\nnvecs++;\r\nvecp++;\r\nfirst_bit = next_bit;\r\nlast_bit = next_bit;\r\nnbits = 1;\r\n} else if (xfs_buf_offset(bp, next_bit << XFS_BLF_SHIFT) !=\r\n(xfs_buf_offset(bp, last_bit << XFS_BLF_SHIFT) +\r\nXFS_BLF_CHUNK)) {\r\nbuffer_offset = first_bit * XFS_BLF_CHUNK;\r\nvecp->i_addr = xfs_buf_offset(bp, buffer_offset);\r\nvecp->i_len = nbits * XFS_BLF_CHUNK;\r\nvecp->i_type = XLOG_REG_TYPE_BCHUNK;\r\nvecp++;\r\nfirst_bit = next_bit;\r\nlast_bit = next_bit;\r\nnbits = 1;\r\n} else {\r\nlast_bit++;\r\nnbits++;\r\n}\r\n}\r\nbip->bli_format.blf_size = nvecs;\r\ntrace_xfs_buf_item_format(bip);\r\nxfs_buf_item_log_check(bip);\r\n}\r\nSTATIC void\r\nxfs_buf_item_pin(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\nASSERT((bip->bli_flags & XFS_BLI_LOGGED) ||\r\n(bip->bli_flags & XFS_BLI_STALE));\r\ntrace_xfs_buf_item_pin(bip);\r\natomic_inc(&bip->bli_refcount);\r\natomic_inc(&bip->bli_buf->b_pin_count);\r\n}\r\nSTATIC void\r\nxfs_buf_item_unpin(\r\nstruct xfs_log_item *lip,\r\nint remove)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nxfs_buf_t *bp = bip->bli_buf;\r\nstruct xfs_ail *ailp = lip->li_ailp;\r\nint stale = bip->bli_flags & XFS_BLI_STALE;\r\nint freed;\r\nASSERT(bp->b_fspriv == bip);\r\nASSERT(atomic_read(&bip->bli_refcount) > 0);\r\ntrace_xfs_buf_item_unpin(bip);\r\nfreed = atomic_dec_and_test(&bip->bli_refcount);\r\nif (atomic_dec_and_test(&bp->b_pin_count))\r\nwake_up_all(&bp->b_waiters);\r\nif (freed && stale) {\r\nASSERT(bip->bli_flags & XFS_BLI_STALE);\r\nASSERT(xfs_buf_islocked(bp));\r\nASSERT(!(XFS_BUF_ISDELAYWRITE(bp)));\r\nASSERT(XFS_BUF_ISSTALE(bp));\r\nASSERT(bip->bli_format.blf_flags & XFS_BLF_CANCEL);\r\ntrace_xfs_buf_item_unpin_stale(bip);\r\nif (remove) {\r\nif (lip->li_desc)\r\nxfs_trans_del_item(lip);\r\nbp->b_transp = NULL;\r\n}\r\nif (bip->bli_flags & XFS_BLI_STALE_INODE) {\r\nxfs_buf_do_callbacks(bp);\r\nbp->b_fspriv = NULL;\r\nbp->b_iodone = NULL;\r\n} else {\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_delete(ailp, (xfs_log_item_t *)bip);\r\nxfs_buf_item_relse(bp);\r\nASSERT(bp->b_fspriv == NULL);\r\n}\r\nxfs_buf_relse(bp);\r\n}\r\n}\r\nSTATIC uint\r\nxfs_buf_item_trylock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nif (xfs_buf_ispinned(bp))\r\nreturn XFS_ITEM_PINNED;\r\nif (!xfs_buf_trylock(bp))\r\nreturn XFS_ITEM_LOCKED;\r\nxfs_buf_hold(bp);\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\ntrace_xfs_buf_item_trylock(bip);\r\nif (XFS_BUF_ISDELAYWRITE(bp))\r\nreturn XFS_ITEM_PUSHBUF;\r\nreturn XFS_ITEM_SUCCESS;\r\n}\r\nSTATIC void\r\nxfs_buf_item_unlock(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nint aborted;\r\nuint hold;\r\nbp->b_transp = NULL;\r\naborted = (lip->li_flags & XFS_LI_ABORTED) != 0;\r\nhold = bip->bli_flags & XFS_BLI_HOLD;\r\nbip->bli_flags &= ~(XFS_BLI_LOGGED | XFS_BLI_HOLD);\r\nif (bip->bli_flags & XFS_BLI_STALE) {\r\ntrace_xfs_buf_item_unlock_stale(bip);\r\nASSERT(bip->bli_format.blf_flags & XFS_BLF_CANCEL);\r\nif (!aborted) {\r\natomic_dec(&bip->bli_refcount);\r\nreturn;\r\n}\r\n}\r\ntrace_xfs_buf_item_unlock(bip);\r\nif (xfs_bitmap_empty(bip->bli_format.blf_data_map,\r\nbip->bli_format.blf_map_size))\r\nxfs_buf_item_relse(bp);\r\nelse\r\natomic_dec(&bip->bli_refcount);\r\nif (!hold)\r\nxfs_buf_relse(bp);\r\n}\r\nSTATIC xfs_lsn_t\r\nxfs_buf_item_committed(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t lsn)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\ntrace_xfs_buf_item_committed(bip);\r\nif ((bip->bli_flags & XFS_BLI_INODE_ALLOC_BUF) && lip->li_lsn != 0)\r\nreturn lip->li_lsn;\r\nreturn lsn;\r\n}\r\nSTATIC void\r\nxfs_buf_item_push(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT(!XFS_BUF_ISDELAYWRITE(bp));\r\ntrace_xfs_buf_item_push(bip);\r\nxfs_buf_relse(bp);\r\n}\r\nSTATIC bool\r\nxfs_buf_item_pushbuf(\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_buf_log_item *bip = BUF_ITEM(lip);\r\nstruct xfs_buf *bp = bip->bli_buf;\r\nASSERT(!(bip->bli_flags & XFS_BLI_STALE));\r\nASSERT(XFS_BUF_ISDELAYWRITE(bp));\r\ntrace_xfs_buf_item_pushbuf(bip);\r\nxfs_buf_delwri_promote(bp);\r\nxfs_buf_relse(bp);\r\nreturn true;\r\n}\r\nSTATIC void\r\nxfs_buf_item_committing(\r\nstruct xfs_log_item *lip,\r\nxfs_lsn_t commit_lsn)\r\n{\r\n}\r\nvoid\r\nxfs_buf_item_init(\r\nxfs_buf_t *bp,\r\nxfs_mount_t *mp)\r\n{\r\nxfs_log_item_t *lip = bp->b_fspriv;\r\nxfs_buf_log_item_t *bip;\r\nint chunks;\r\nint map_size;\r\nASSERT(bp->b_target->bt_mount == mp);\r\nif (lip != NULL && lip->li_type == XFS_LI_BUF)\r\nreturn;\r\nchunks = (int)((XFS_BUF_COUNT(bp) + (XFS_BLF_CHUNK - 1)) >> XFS_BLF_SHIFT);\r\nmap_size = (int)((chunks + NBWORD) >> BIT_TO_WORD_SHIFT);\r\nbip = (xfs_buf_log_item_t*)kmem_zone_zalloc(xfs_buf_item_zone,\r\nKM_SLEEP);\r\nxfs_log_item_init(mp, &bip->bli_item, XFS_LI_BUF, &xfs_buf_item_ops);\r\nbip->bli_buf = bp;\r\nxfs_buf_hold(bp);\r\nbip->bli_format.blf_type = XFS_LI_BUF;\r\nbip->bli_format.blf_blkno = (__int64_t)XFS_BUF_ADDR(bp);\r\nbip->bli_format.blf_len = (ushort)BTOBB(XFS_BUF_COUNT(bp));\r\nbip->bli_format.blf_map_size = map_size;\r\n#ifdef XFS_TRANS_DEBUG\r\nbip->bli_orig = (char *)kmem_alloc(XFS_BUF_COUNT(bp), KM_SLEEP);\r\nmemcpy(bip->bli_orig, bp->b_addr, XFS_BUF_COUNT(bp));\r\nbip->bli_logged = (char *)kmem_zalloc(XFS_BUF_COUNT(bp) / NBBY, KM_SLEEP);\r\n#endif\r\nif (bp->b_fspriv)\r\nbip->bli_item.li_bio_list = bp->b_fspriv;\r\nbp->b_fspriv = bip;\r\n}\r\nvoid\r\nxfs_buf_item_log(\r\nxfs_buf_log_item_t *bip,\r\nuint first,\r\nuint last)\r\n{\r\nuint first_bit;\r\nuint last_bit;\r\nuint bits_to_set;\r\nuint bits_set;\r\nuint word_num;\r\nuint *wordp;\r\nuint bit;\r\nuint end_bit;\r\nuint mask;\r\nbip->bli_flags |= XFS_BLI_DIRTY;\r\nfirst_bit = first >> XFS_BLF_SHIFT;\r\nlast_bit = last >> XFS_BLF_SHIFT;\r\nbits_to_set = last_bit - first_bit + 1;\r\nword_num = first_bit >> BIT_TO_WORD_SHIFT;\r\nwordp = &(bip->bli_format.blf_data_map[word_num]);\r\nbit = first_bit & (uint)(NBWORD - 1);\r\nif (bit) {\r\nend_bit = MIN(bit + bits_to_set, (uint)NBWORD);\r\nmask = ((1 << (end_bit - bit)) - 1) << bit;\r\n*wordp |= mask;\r\nwordp++;\r\nbits_set = end_bit - bit;\r\n} else {\r\nbits_set = 0;\r\n}\r\nwhile ((bits_to_set - bits_set) >= NBWORD) {\r\n*wordp |= 0xffffffff;\r\nbits_set += NBWORD;\r\nwordp++;\r\n}\r\nend_bit = bits_to_set - bits_set;\r\nif (end_bit) {\r\nmask = (1 << end_bit) - 1;\r\n*wordp |= mask;\r\n}\r\nxfs_buf_item_log_debug(bip, first, last);\r\n}\r\nuint\r\nxfs_buf_item_dirty(\r\nxfs_buf_log_item_t *bip)\r\n{\r\nreturn (bip->bli_flags & XFS_BLI_DIRTY);\r\n}\r\nSTATIC void\r\nxfs_buf_item_free(\r\nxfs_buf_log_item_t *bip)\r\n{\r\n#ifdef XFS_TRANS_DEBUG\r\nkmem_free(bip->bli_orig);\r\nkmem_free(bip->bli_logged);\r\n#endif\r\nkmem_zone_free(xfs_buf_item_zone, bip);\r\n}\r\nvoid\r\nxfs_buf_item_relse(\r\nxfs_buf_t *bp)\r\n{\r\nxfs_buf_log_item_t *bip;\r\ntrace_xfs_buf_item_relse(bp, _RET_IP_);\r\nbip = bp->b_fspriv;\r\nbp->b_fspriv = bip->bli_item.li_bio_list;\r\nif (bp->b_fspriv == NULL)\r\nbp->b_iodone = NULL;\r\nxfs_buf_rele(bp);\r\nxfs_buf_item_free(bip);\r\n}\r\nvoid\r\nxfs_buf_attach_iodone(\r\nxfs_buf_t *bp,\r\nvoid (*cb)(xfs_buf_t *, xfs_log_item_t *),\r\nxfs_log_item_t *lip)\r\n{\r\nxfs_log_item_t *head_lip;\r\nASSERT(xfs_buf_islocked(bp));\r\nlip->li_cb = cb;\r\nhead_lip = bp->b_fspriv;\r\nif (head_lip) {\r\nlip->li_bio_list = head_lip->li_bio_list;\r\nhead_lip->li_bio_list = lip;\r\n} else {\r\nbp->b_fspriv = lip;\r\n}\r\nASSERT(bp->b_iodone == NULL ||\r\nbp->b_iodone == xfs_buf_iodone_callbacks);\r\nbp->b_iodone = xfs_buf_iodone_callbacks;\r\n}\r\nSTATIC void\r\nxfs_buf_do_callbacks(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_log_item *lip;\r\nwhile ((lip = bp->b_fspriv) != NULL) {\r\nbp->b_fspriv = lip->li_bio_list;\r\nASSERT(lip->li_cb != NULL);\r\nlip->li_bio_list = NULL;\r\nlip->li_cb(bp, lip);\r\n}\r\n}\r\nvoid\r\nxfs_buf_iodone_callbacks(\r\nstruct xfs_buf *bp)\r\n{\r\nstruct xfs_log_item *lip = bp->b_fspriv;\r\nstruct xfs_mount *mp = lip->li_mountp;\r\nstatic ulong lasttime;\r\nstatic xfs_buftarg_t *lasttarg;\r\nif (likely(!xfs_buf_geterror(bp)))\r\ngoto do_callbacks;\r\nif (XFS_FORCED_SHUTDOWN(mp)) {\r\nxfs_buf_stale(bp);\r\nXFS_BUF_DONE(bp);\r\ntrace_xfs_buf_item_iodone(bp, _RET_IP_);\r\ngoto do_callbacks;\r\n}\r\nif (bp->b_target != lasttarg ||\r\ntime_after(jiffies, (lasttime + 5*HZ))) {\r\nlasttime = jiffies;\r\nxfs_buf_ioerror_alert(bp, __func__);\r\n}\r\nlasttarg = bp->b_target;\r\nif (XFS_BUF_ISASYNC(bp)) {\r\nxfs_buf_ioerror(bp, 0);\r\nif (!XFS_BUF_ISSTALE(bp)) {\r\nxfs_buf_delwri_queue(bp);\r\nXFS_BUF_DONE(bp);\r\n}\r\nASSERT(bp->b_iodone != NULL);\r\ntrace_xfs_buf_item_iodone_async(bp, _RET_IP_);\r\nxfs_buf_relse(bp);\r\nreturn;\r\n}\r\nxfs_buf_stale(bp);\r\nXFS_BUF_DONE(bp);\r\ntrace_xfs_buf_error_relse(bp, _RET_IP_);\r\ndo_callbacks:\r\nxfs_buf_do_callbacks(bp);\r\nbp->b_fspriv = NULL;\r\nbp->b_iodone = NULL;\r\nxfs_buf_ioend(bp, 0);\r\n}\r\nvoid\r\nxfs_buf_iodone(\r\nstruct xfs_buf *bp,\r\nstruct xfs_log_item *lip)\r\n{\r\nstruct xfs_ail *ailp = lip->li_ailp;\r\nASSERT(BUF_ITEM(lip)->bli_buf == bp);\r\nxfs_buf_rele(bp);\r\nspin_lock(&ailp->xa_lock);\r\nxfs_trans_ail_delete(ailp, lip);\r\nxfs_buf_item_free(BUF_ITEM(lip));\r\n}

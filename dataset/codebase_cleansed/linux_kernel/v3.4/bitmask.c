struct bitmask *bitmask_alloc(unsigned int n)\r\n{\r\nstruct bitmask *bmp;\r\nbmp = malloc(sizeof(*bmp));\r\nif (bmp == 0)\r\nreturn 0;\r\nbmp->size = n;\r\nbmp->maskp = calloc(longsperbits(n), sizeof(unsigned long));\r\nif (bmp->maskp == 0) {\r\nfree(bmp);\r\nreturn 0;\r\n}\r\nreturn bmp;\r\n}\r\nvoid bitmask_free(struct bitmask *bmp)\r\n{\r\nif (bmp == 0)\r\nreturn;\r\nfree(bmp->maskp);\r\nbmp->maskp = (unsigned long *)0xdeadcdef;\r\nfree(bmp);\r\n}\r\nstatic unsigned int _getbit(const struct bitmask *bmp, unsigned int n)\r\n{\r\nif (n < bmp->size)\r\nreturn (bmp->maskp[n/bitsperlong] >> (n % bitsperlong)) & 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void _setbit(struct bitmask *bmp, unsigned int n, unsigned int v)\r\n{\r\nif (n < bmp->size) {\r\nif (v)\r\nbmp->maskp[n/bitsperlong] |= 1UL << (n % bitsperlong);\r\nelse\r\nbmp->maskp[n/bitsperlong] &=\r\n~(1UL << (n % bitsperlong));\r\n}\r\n}\r\nstatic int scan_was_ok(int sret, char nextc, const char *ok_next_chars)\r\n{\r\nreturn sret == 1 ||\r\n(sret == 2 && strchr(ok_next_chars, nextc) != NULL);\r\n}\r\nstatic const char *nexttoken(const char *q, int sep)\r\n{\r\nif (q)\r\nq = strchr(q, sep);\r\nif (q)\r\nq++;\r\nreturn q;\r\n}\r\nstruct bitmask *bitmask_setbit(struct bitmask *bmp, unsigned int i)\r\n{\r\n_setbit(bmp, i, 1);\r\nreturn bmp;\r\n}\r\nstruct bitmask *bitmask_setall(struct bitmask *bmp)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < bmp->size; i++)\r\n_setbit(bmp, i, 1);\r\nreturn bmp;\r\n}\r\nstruct bitmask *bitmask_clearall(struct bitmask *bmp)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < bmp->size; i++)\r\n_setbit(bmp, i, 0);\r\nreturn bmp;\r\n}\r\nint bitmask_isallclear(const struct bitmask *bmp)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < bmp->size; i++)\r\nif (_getbit(bmp, i))\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint bitmask_isbitset(const struct bitmask *bmp, unsigned int i)\r\n{\r\nreturn _getbit(bmp, i);\r\n}\r\nunsigned int bitmask_first(const struct bitmask *bmp)\r\n{\r\nreturn bitmask_next(bmp, 0);\r\n}\r\nunsigned int bitmask_last(const struct bitmask *bmp)\r\n{\r\nunsigned int i;\r\nunsigned int m = bmp->size;\r\nfor (i = 0; i < bmp->size; i++)\r\nif (_getbit(bmp, i))\r\nm = i;\r\nreturn m;\r\n}\r\nunsigned int bitmask_next(const struct bitmask *bmp, unsigned int i)\r\n{\r\nunsigned int n;\r\nfor (n = i; n < bmp->size; n++)\r\nif (_getbit(bmp, n))\r\nbreak;\r\nreturn n;\r\n}\r\nint bitmask_parselist(const char *buf, struct bitmask *bmp)\r\n{\r\nconst char *p, *q;\r\nbitmask_clearall(bmp);\r\nq = buf;\r\nwhile (p = q, q = nexttoken(q, ','), p) {\r\nunsigned int a;\r\nunsigned int b;\r\nunsigned int s;\r\nconst char *c1, *c2;\r\nchar nextc;\r\nint sret;\r\nsret = sscanf(p, "%u%c", &a, &nextc);\r\nif (!scan_was_ok(sret, nextc, ",-"))\r\ngoto err;\r\nb = a;\r\ns = 1;\r\nc1 = nexttoken(p, '-');\r\nc2 = nexttoken(p, ',');\r\nif (c1 != NULL && (c2 == NULL || c1 < c2)) {\r\nsret = sscanf(c1, "%u%c", &b, &nextc);\r\nif (!scan_was_ok(sret, nextc, ",:"))\r\ngoto err;\r\nc1 = nexttoken(c1, ':');\r\nif (c1 != NULL && (c2 == NULL || c1 < c2)) {\r\nsret = sscanf(c1, "%u%c", &s, &nextc);\r\nif (!scan_was_ok(sret, nextc, ","))\r\ngoto err;\r\n}\r\n}\r\nif (!(a <= b))\r\ngoto err;\r\nif (b >= bmp->size)\r\ngoto err;\r\nwhile (a <= b) {\r\n_setbit(bmp, a, 1);\r\na += s;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\nbitmask_clearall(bmp);\r\nreturn -1;\r\n}\r\nstatic inline int emit(char *buf, int buflen, int rbot, int rtop, int len)\r\n{\r\nif (len > 0)\r\nlen += snprintf(buf + len, max(buflen - len, 0), ",");\r\nif (rbot == rtop)\r\nlen += snprintf(buf + len, max(buflen - len, 0), "%d", rbot);\r\nelse\r\nlen += snprintf(buf + len, max(buflen - len, 0), "%d-%d",\r\nrbot, rtop);\r\nreturn len;\r\n}\r\nint bitmask_displaylist(char *buf, int buflen, const struct bitmask *bmp)\r\n{\r\nint len = 0;\r\nunsigned int cur, rbot, rtop;\r\nif (buflen > 0)\r\n*buf = 0;\r\nrbot = cur = bitmask_first(bmp);\r\nwhile (cur < bmp->size) {\r\nrtop = cur;\r\ncur = bitmask_next(bmp, cur+1);\r\nif (cur >= bmp->size || cur > rtop + 1) {\r\nlen = emit(buf, buflen, rbot, rtop, len);\r\nrbot = cur;\r\n}\r\n}\r\nreturn len;\r\n}

static int genericbl_send_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.state & BL_CORE_FBBLANK)\r\nintensity = 0;\r\nif (bd->props.state & BL_CORE_SUSPENDED)\r\nintensity = 0;\r\nif (bd->props.state & GENERICBL_BATTLOW)\r\nintensity &= bl_machinfo->limit_mask;\r\nbl_machinfo->set_bl_intensity(intensity);\r\ngenericbl_intensity = intensity;\r\nif (bl_machinfo->kick_battery)\r\nbl_machinfo->kick_battery();\r\nreturn 0;\r\n}\r\nstatic int genericbl_get_intensity(struct backlight_device *bd)\r\n{\r\nreturn genericbl_intensity;\r\n}\r\nvoid genericbl_limit_intensity(int limit)\r\n{\r\nstruct backlight_device *bd = generic_backlight_device;\r\nmutex_lock(&bd->ops_lock);\r\nif (limit)\r\nbd->props.state |= GENERICBL_BATTLOW;\r\nelse\r\nbd->props.state &= ~GENERICBL_BATTLOW;\r\nbacklight_update_status(generic_backlight_device);\r\nmutex_unlock(&bd->ops_lock);\r\n}\r\nstatic int genericbl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct generic_bl_info *machinfo = pdev->dev.platform_data;\r\nconst char *name = "generic-bl";\r\nstruct backlight_device *bd;\r\nbl_machinfo = machinfo;\r\nif (!machinfo->limit_mask)\r\nmachinfo->limit_mask = -1;\r\nif (machinfo->name)\r\nname = machinfo->name;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = machinfo->max_intensity;\r\nbd = backlight_device_register(name, &pdev->dev, NULL, &genericbl_ops,\r\n&props);\r\nif (IS_ERR (bd))\r\nreturn PTR_ERR (bd);\r\nplatform_set_drvdata(pdev, bd);\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbd->props.brightness = machinfo->default_intensity;\r\nbacklight_update_status(bd);\r\ngeneric_backlight_device = bd;\r\nprintk("Generic Backlight Driver Initialized.\n");\r\nreturn 0;\r\n}\r\nstatic int genericbl_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nbd->props.power = 0;\r\nbd->props.brightness = 0;\r\nbacklight_update_status(bd);\r\nbacklight_device_unregister(bd);\r\nprintk("Generic Backlight Driver Unloaded\n");\r\nreturn 0;\r\n}

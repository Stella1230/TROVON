static mpi_limb_t\r\nmul_n_basecase(mpi_ptr_t prodp, mpi_ptr_t up, mpi_ptr_t vp, mpi_size_t size)\r\n{\r\nmpi_size_t i;\r\nmpi_limb_t cy;\r\nmpi_limb_t v_limb;\r\nv_limb = vp[0];\r\nif (v_limb <= 1) {\r\nif (v_limb == 1)\r\nMPN_COPY(prodp, up, size);\r\nelse\r\nMPN_ZERO(prodp, size);\r\ncy = 0;\r\n} else\r\ncy = mpihelp_mul_1(prodp, up, size, v_limb);\r\nprodp[size] = cy;\r\nprodp++;\r\nfor (i = 1; i < size; i++) {\r\nv_limb = vp[i];\r\nif (v_limb <= 1) {\r\ncy = 0;\r\nif (v_limb == 1)\r\ncy = mpihelp_add_n(prodp, prodp, up, size);\r\n} else\r\ncy = mpihelp_addmul_1(prodp, up, size, v_limb);\r\nprodp[size] = cy;\r\nprodp++;\r\n}\r\nreturn cy;\r\n}\r\nstatic void\r\nmul_n(mpi_ptr_t prodp, mpi_ptr_t up, mpi_ptr_t vp,\r\nmpi_size_t size, mpi_ptr_t tspace)\r\n{\r\nif (size & 1) {\r\nmpi_size_t esize = size - 1;\r\nmpi_limb_t cy_limb;\r\nMPN_MUL_N_RECURSE(prodp, up, vp, esize, tspace);\r\ncy_limb = mpihelp_addmul_1(prodp + esize, up, esize, vp[esize]);\r\nprodp[esize + esize] = cy_limb;\r\ncy_limb = mpihelp_addmul_1(prodp + esize, vp, size, up[esize]);\r\nprodp[esize + size] = cy_limb;\r\n} else {\r\nmpi_size_t hsize = size >> 1;\r\nmpi_limb_t cy;\r\nint negflg;\r\nMPN_MUL_N_RECURSE(prodp + size, up + hsize, vp + hsize, hsize,\r\ntspace);\r\nif (mpihelp_cmp(up + hsize, up, hsize) >= 0) {\r\nmpihelp_sub_n(prodp, up + hsize, up, hsize);\r\nnegflg = 0;\r\n} else {\r\nmpihelp_sub_n(prodp, up, up + hsize, hsize);\r\nnegflg = 1;\r\n}\r\nif (mpihelp_cmp(vp + hsize, vp, hsize) >= 0) {\r\nmpihelp_sub_n(prodp + hsize, vp + hsize, vp, hsize);\r\nnegflg ^= 1;\r\n} else {\r\nmpihelp_sub_n(prodp + hsize, vp, vp + hsize, hsize);\r\n}\r\nMPN_MUL_N_RECURSE(tspace, prodp, prodp + hsize, hsize,\r\ntspace + size);\r\nMPN_COPY(prodp + hsize, prodp + size, hsize);\r\ncy = mpihelp_add_n(prodp + size, prodp + size,\r\nprodp + size + hsize, hsize);\r\nif (negflg)\r\ncy -=\r\nmpihelp_sub_n(prodp + hsize, prodp + hsize, tspace,\r\nsize);\r\nelse\r\ncy +=\r\nmpihelp_add_n(prodp + hsize, prodp + hsize, tspace,\r\nsize);\r\nMPN_MUL_N_RECURSE(tspace, up, vp, hsize, tspace + size);\r\ncy += mpihelp_add_n(prodp + hsize, prodp + hsize, tspace, size);\r\nif (cy)\r\nmpihelp_add_1(prodp + hsize + size,\r\nprodp + hsize + size, hsize, cy);\r\nMPN_COPY(prodp, tspace, hsize);\r\ncy = mpihelp_add_n(prodp + hsize, prodp + hsize, tspace + hsize,\r\nhsize);\r\nif (cy)\r\nmpihelp_add_1(prodp + size, prodp + size, size, 1);\r\n}\r\n}\r\nvoid mpih_sqr_n_basecase(mpi_ptr_t prodp, mpi_ptr_t up, mpi_size_t size)\r\n{\r\nmpi_size_t i;\r\nmpi_limb_t cy_limb;\r\nmpi_limb_t v_limb;\r\nv_limb = up[0];\r\nif (v_limb <= 1) {\r\nif (v_limb == 1)\r\nMPN_COPY(prodp, up, size);\r\nelse\r\nMPN_ZERO(prodp, size);\r\ncy_limb = 0;\r\n} else\r\ncy_limb = mpihelp_mul_1(prodp, up, size, v_limb);\r\nprodp[size] = cy_limb;\r\nprodp++;\r\nfor (i = 1; i < size; i++) {\r\nv_limb = up[i];\r\nif (v_limb <= 1) {\r\ncy_limb = 0;\r\nif (v_limb == 1)\r\ncy_limb = mpihelp_add_n(prodp, prodp, up, size);\r\n} else\r\ncy_limb = mpihelp_addmul_1(prodp, up, size, v_limb);\r\nprodp[size] = cy_limb;\r\nprodp++;\r\n}\r\n}\r\nvoid\r\nmpih_sqr_n(mpi_ptr_t prodp, mpi_ptr_t up, mpi_size_t size, mpi_ptr_t tspace)\r\n{\r\nif (size & 1) {\r\nmpi_size_t esize = size - 1;\r\nmpi_limb_t cy_limb;\r\nMPN_SQR_N_RECURSE(prodp, up, esize, tspace);\r\ncy_limb = mpihelp_addmul_1(prodp + esize, up, esize, up[esize]);\r\nprodp[esize + esize] = cy_limb;\r\ncy_limb = mpihelp_addmul_1(prodp + esize, up, size, up[esize]);\r\nprodp[esize + size] = cy_limb;\r\n} else {\r\nmpi_size_t hsize = size >> 1;\r\nmpi_limb_t cy;\r\nMPN_SQR_N_RECURSE(prodp + size, up + hsize, hsize, tspace);\r\nif (mpihelp_cmp(up + hsize, up, hsize) >= 0)\r\nmpihelp_sub_n(prodp, up + hsize, up, hsize);\r\nelse\r\nmpihelp_sub_n(prodp, up, up + hsize, hsize);\r\nMPN_SQR_N_RECURSE(tspace, prodp, hsize, tspace + size);\r\nMPN_COPY(prodp + hsize, prodp + size, hsize);\r\ncy = mpihelp_add_n(prodp + size, prodp + size,\r\nprodp + size + hsize, hsize);\r\ncy -= mpihelp_sub_n(prodp + hsize, prodp + hsize, tspace, size);\r\nMPN_SQR_N_RECURSE(tspace, up, hsize, tspace + size);\r\ncy += mpihelp_add_n(prodp + hsize, prodp + hsize, tspace, size);\r\nif (cy)\r\nmpihelp_add_1(prodp + hsize + size,\r\nprodp + hsize + size, hsize, cy);\r\nMPN_COPY(prodp, tspace, hsize);\r\ncy = mpihelp_add_n(prodp + hsize, prodp + hsize, tspace + hsize,\r\nhsize);\r\nif (cy)\r\nmpihelp_add_1(prodp + size, prodp + size, size, 1);\r\n}\r\n}\r\nint mpihelp_mul_n(mpi_ptr_t prodp, mpi_ptr_t up, mpi_ptr_t vp, mpi_size_t size)\r\n{\r\nif (up == vp) {\r\nif (size < KARATSUBA_THRESHOLD)\r\nmpih_sqr_n_basecase(prodp, up, size);\r\nelse {\r\nmpi_ptr_t tspace;\r\ntspace = mpi_alloc_limb_space(2 * size);\r\nif (!tspace)\r\nreturn -ENOMEM;\r\nmpih_sqr_n(prodp, up, size, tspace);\r\nmpi_free_limb_space(tspace);\r\n}\r\n} else {\r\nif (size < KARATSUBA_THRESHOLD)\r\nmul_n_basecase(prodp, up, vp, size);\r\nelse {\r\nmpi_ptr_t tspace;\r\ntspace = mpi_alloc_limb_space(2 * size);\r\nif (!tspace)\r\nreturn -ENOMEM;\r\nmul_n(prodp, up, vp, size, tspace);\r\nmpi_free_limb_space(tspace);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint\r\nmpihelp_mul_karatsuba_case(mpi_ptr_t prodp,\r\nmpi_ptr_t up, mpi_size_t usize,\r\nmpi_ptr_t vp, mpi_size_t vsize,\r\nstruct karatsuba_ctx *ctx)\r\n{\r\nmpi_limb_t cy;\r\nif (!ctx->tspace || ctx->tspace_size < vsize) {\r\nif (ctx->tspace)\r\nmpi_free_limb_space(ctx->tspace);\r\nctx->tspace = mpi_alloc_limb_space(2 * vsize);\r\nif (!ctx->tspace)\r\nreturn -ENOMEM;\r\nctx->tspace_size = vsize;\r\n}\r\nMPN_MUL_N_RECURSE(prodp, up, vp, vsize, ctx->tspace);\r\nprodp += vsize;\r\nup += vsize;\r\nusize -= vsize;\r\nif (usize >= vsize) {\r\nif (!ctx->tp || ctx->tp_size < vsize) {\r\nif (ctx->tp)\r\nmpi_free_limb_space(ctx->tp);\r\nctx->tp = mpi_alloc_limb_space(2 * vsize);\r\nif (!ctx->tp) {\r\nif (ctx->tspace)\r\nmpi_free_limb_space(ctx->tspace);\r\nctx->tspace = NULL;\r\nreturn -ENOMEM;\r\n}\r\nctx->tp_size = vsize;\r\n}\r\ndo {\r\nMPN_MUL_N_RECURSE(ctx->tp, up, vp, vsize, ctx->tspace);\r\ncy = mpihelp_add_n(prodp, prodp, ctx->tp, vsize);\r\nmpihelp_add_1(prodp + vsize, ctx->tp + vsize, vsize,\r\ncy);\r\nprodp += vsize;\r\nup += vsize;\r\nusize -= vsize;\r\n} while (usize >= vsize);\r\n}\r\nif (usize) {\r\nif (usize < KARATSUBA_THRESHOLD) {\r\nmpi_limb_t tmp;\r\nif (mpihelp_mul(ctx->tspace, vp, vsize, up, usize, &tmp)\r\n< 0)\r\nreturn -ENOMEM;\r\n} else {\r\nif (!ctx->next) {\r\nctx->next = kzalloc(sizeof *ctx, GFP_KERNEL);\r\nif (!ctx->next)\r\nreturn -ENOMEM;\r\n}\r\nif (mpihelp_mul_karatsuba_case(ctx->tspace,\r\nvp, vsize,\r\nup, usize,\r\nctx->next) < 0)\r\nreturn -ENOMEM;\r\n}\r\ncy = mpihelp_add_n(prodp, prodp, ctx->tspace, vsize);\r\nmpihelp_add_1(prodp + vsize, ctx->tspace + vsize, usize, cy);\r\n}\r\nreturn 0;\r\n}\r\nvoid mpihelp_release_karatsuba_ctx(struct karatsuba_ctx *ctx)\r\n{\r\nstruct karatsuba_ctx *ctx2;\r\nif (ctx->tp)\r\nmpi_free_limb_space(ctx->tp);\r\nif (ctx->tspace)\r\nmpi_free_limb_space(ctx->tspace);\r\nfor (ctx = ctx->next; ctx; ctx = ctx2) {\r\nctx2 = ctx->next;\r\nif (ctx->tp)\r\nmpi_free_limb_space(ctx->tp);\r\nif (ctx->tspace)\r\nmpi_free_limb_space(ctx->tspace);\r\nkfree(ctx);\r\n}\r\n}\r\nint\r\nmpihelp_mul(mpi_ptr_t prodp, mpi_ptr_t up, mpi_size_t usize,\r\nmpi_ptr_t vp, mpi_size_t vsize, mpi_limb_t *_result)\r\n{\r\nmpi_ptr_t prod_endp = prodp + usize + vsize - 1;\r\nmpi_limb_t cy;\r\nstruct karatsuba_ctx ctx;\r\nif (vsize < KARATSUBA_THRESHOLD) {\r\nmpi_size_t i;\r\nmpi_limb_t v_limb;\r\nif (!vsize) {\r\n*_result = 0;\r\nreturn 0;\r\n}\r\nv_limb = vp[0];\r\nif (v_limb <= 1) {\r\nif (v_limb == 1)\r\nMPN_COPY(prodp, up, usize);\r\nelse\r\nMPN_ZERO(prodp, usize);\r\ncy = 0;\r\n} else\r\ncy = mpihelp_mul_1(prodp, up, usize, v_limb);\r\nprodp[usize] = cy;\r\nprodp++;\r\nfor (i = 1; i < vsize; i++) {\r\nv_limb = vp[i];\r\nif (v_limb <= 1) {\r\ncy = 0;\r\nif (v_limb == 1)\r\ncy = mpihelp_add_n(prodp, prodp, up,\r\nusize);\r\n} else\r\ncy = mpihelp_addmul_1(prodp, up, usize, v_limb);\r\nprodp[usize] = cy;\r\nprodp++;\r\n}\r\n*_result = cy;\r\nreturn 0;\r\n}\r\nmemset(&ctx, 0, sizeof ctx);\r\nif (mpihelp_mul_karatsuba_case(prodp, up, usize, vp, vsize, &ctx) < 0)\r\nreturn -ENOMEM;\r\nmpihelp_release_karatsuba_ctx(&ctx);\r\n*_result = *prod_endp;\r\nreturn 0;\r\n}

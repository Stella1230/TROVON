static u8 sis5595_read(u8 reg)\r\n{\r\noutb(reg, sis5595_base + SMB_INDEX);\r\nreturn inb(sis5595_base + SMB_DAT);\r\n}\r\nstatic void sis5595_write(u8 reg, u8 data)\r\n{\r\noutb(reg, sis5595_base + SMB_INDEX);\r\noutb(data, sis5595_base + SMB_DAT);\r\n}\r\nstatic int __devinit sis5595_setup(struct pci_dev *SIS5595_dev)\r\n{\r\nu16 a;\r\nu8 val;\r\nint *i;\r\nint retval;\r\nfor (i = blacklist; *i != 0; i++) {\r\nstruct pci_dev *dev;\r\ndev = pci_get_device(PCI_VENDOR_ID_SI, *i, NULL);\r\nif (dev) {\r\ndev_err(&SIS5595_dev->dev, "Looked for SIS5595 but found unsupported device %.4x\n", *i);\r\npci_dev_put(dev);\r\nreturn -ENODEV;\r\n}\r\n}\r\npci_read_config_word(SIS5595_dev, ACPI_BASE, &sis5595_base);\r\nif (sis5595_base == 0 && force_addr == 0) {\r\ndev_err(&SIS5595_dev->dev, "ACPI base address uninitialized - upgrade BIOS or use force_addr=0xaddr\n");\r\nreturn -ENODEV;\r\n}\r\nif (force_addr)\r\nsis5595_base = force_addr & ~(SIS5595_EXTENT - 1);\r\ndev_dbg(&SIS5595_dev->dev, "ACPI Base address: %04x\n", sis5595_base);\r\nretval = acpi_check_region(sis5595_base + SMB_INDEX, 2,\r\nsis5595_driver.name);\r\nif (retval)\r\nreturn retval;\r\nif (!request_region(sis5595_base + SMB_INDEX, 2,\r\nsis5595_driver.name)) {\r\ndev_err(&SIS5595_dev->dev, "SMBus registers 0x%04x-0x%04x already in use!\n",\r\nsis5595_base + SMB_INDEX, sis5595_base + SMB_INDEX + 1);\r\nreturn -ENODEV;\r\n}\r\nif (force_addr) {\r\ndev_info(&SIS5595_dev->dev, "forcing ISA address 0x%04X\n", sis5595_base);\r\nif (pci_write_config_word(SIS5595_dev, ACPI_BASE, sis5595_base)\r\n!= PCIBIOS_SUCCESSFUL)\r\ngoto error;\r\nif (pci_read_config_word(SIS5595_dev, ACPI_BASE, &a)\r\n!= PCIBIOS_SUCCESSFUL)\r\ngoto error;\r\nif ((a & ~(SIS5595_EXTENT - 1)) != sis5595_base) {\r\ndev_err(&SIS5595_dev->dev, "force address failed - not supported?\n");\r\ngoto error;\r\n}\r\n}\r\nif (pci_read_config_byte(SIS5595_dev, SIS5595_ENABLE_REG, &val)\r\n!= PCIBIOS_SUCCESSFUL)\r\ngoto error;\r\nif ((val & 0x80) == 0) {\r\ndev_info(&SIS5595_dev->dev, "enabling ACPI\n");\r\nif (pci_write_config_byte(SIS5595_dev, SIS5595_ENABLE_REG, val | 0x80)\r\n!= PCIBIOS_SUCCESSFUL)\r\ngoto error;\r\nif (pci_read_config_byte(SIS5595_dev, SIS5595_ENABLE_REG, &val)\r\n!= PCIBIOS_SUCCESSFUL)\r\ngoto error;\r\nif ((val & 0x80) == 0) {\r\ndev_err(&SIS5595_dev->dev, "ACPI enable failed - not supported?\n");\r\ngoto error;\r\n}\r\n}\r\nreturn 0;\r\nerror:\r\nrelease_region(sis5595_base + SMB_INDEX, 2);\r\nreturn -ENODEV;\r\n}\r\nstatic int sis5595_transaction(struct i2c_adapter *adap)\r\n{\r\nint temp;\r\nint result = 0;\r\nint timeout = 0;\r\ntemp = sis5595_read(SMB_STS_LO) + (sis5595_read(SMB_STS_HI) << 8);\r\nif (temp != 0x00) {\r\ndev_dbg(&adap->dev, "SMBus busy (%04x). Resetting...\n", temp);\r\nsis5595_write(SMB_STS_LO, temp & 0xff);\r\nsis5595_write(SMB_STS_HI, temp >> 8);\r\nif ((temp = sis5595_read(SMB_STS_LO) + (sis5595_read(SMB_STS_HI) << 8)) != 0x00) {\r\ndev_dbg(&adap->dev, "Failed! (%02x)\n", temp);\r\nreturn -EBUSY;\r\n} else {\r\ndev_dbg(&adap->dev, "Successful!\n");\r\n}\r\n}\r\nsis5595_write(SMB_CTL_LO, sis5595_read(SMB_CTL_LO) | 0x10);\r\ndo {\r\nmsleep(1);\r\ntemp = sis5595_read(SMB_STS_LO);\r\n} while (!(temp & 0x40) && (timeout++ < MAX_TIMEOUT));\r\nif (timeout > MAX_TIMEOUT) {\r\ndev_dbg(&adap->dev, "SMBus Timeout!\n");\r\nresult = -ETIMEDOUT;\r\n}\r\nif (temp & 0x10) {\r\ndev_dbg(&adap->dev, "Error: Failed bus transaction\n");\r\nresult = -ENXIO;\r\n}\r\nif (temp & 0x20) {\r\ndev_err(&adap->dev, "Bus collision! SMBus may be locked until "\r\n"next hard reset (or not...)\n");\r\nresult = -EIO;\r\n}\r\ntemp = sis5595_read(SMB_STS_LO) + (sis5595_read(SMB_STS_HI) << 8);\r\nif (temp != 0x00) {\r\nsis5595_write(SMB_STS_LO, temp & 0xff);\r\nsis5595_write(SMB_STS_HI, temp >> 8);\r\n}\r\ntemp = sis5595_read(SMB_STS_LO) + (sis5595_read(SMB_STS_HI) << 8);\r\nif (temp != 0x00)\r\ndev_dbg(&adap->dev, "Failed reset at end of transaction (%02x)\n", temp);\r\nreturn result;\r\n}\r\nstatic s32 sis5595_access(struct i2c_adapter *adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size, union i2c_smbus_data *data)\r\n{\r\nint status;\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\nsis5595_write(SMB_ADDR, ((addr & 0x7f) << 1) | (read_write & 0x01));\r\nsize = SIS5595_QUICK;\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\nsis5595_write(SMB_ADDR, ((addr & 0x7f) << 1) | (read_write & 0x01));\r\nif (read_write == I2C_SMBUS_WRITE)\r\nsis5595_write(SMB_CMD, command);\r\nsize = SIS5595_BYTE;\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\nsis5595_write(SMB_ADDR, ((addr & 0x7f) << 1) | (read_write & 0x01));\r\nsis5595_write(SMB_CMD, command);\r\nif (read_write == I2C_SMBUS_WRITE)\r\nsis5595_write(SMB_BYTE, data->byte);\r\nsize = SIS5595_BYTE_DATA;\r\nbreak;\r\ncase I2C_SMBUS_PROC_CALL:\r\ncase I2C_SMBUS_WORD_DATA:\r\nsis5595_write(SMB_ADDR, ((addr & 0x7f) << 1) | (read_write & 0x01));\r\nsis5595_write(SMB_CMD, command);\r\nif (read_write == I2C_SMBUS_WRITE) {\r\nsis5595_write(SMB_BYTE, data->word & 0xff);\r\nsis5595_write(SMB_BYTE + 1,\r\n(data->word & 0xff00) >> 8);\r\n}\r\nsize = (size == I2C_SMBUS_PROC_CALL) ? SIS5595_PROC_CALL : SIS5595_WORD_DATA;\r\nbreak;\r\ndefault:\r\ndev_warn(&adap->dev, "Unsupported transaction %d\n", size);\r\nreturn -EOPNOTSUPP;\r\n}\r\nsis5595_write(SMB_CTL_LO, ((size & 0x0E)));\r\nstatus = sis5595_transaction(adap);\r\nif (status)\r\nreturn status;\r\nif ((size != SIS5595_PROC_CALL) &&\r\n((read_write == I2C_SMBUS_WRITE) || (size == SIS5595_QUICK)))\r\nreturn 0;\r\nswitch (size) {\r\ncase SIS5595_BYTE:\r\ncase SIS5595_BYTE_DATA:\r\ndata->byte = sis5595_read(SMB_BYTE);\r\nbreak;\r\ncase SIS5595_WORD_DATA:\r\ncase SIS5595_PROC_CALL:\r\ndata->word = sis5595_read(SMB_BYTE) + (sis5595_read(SMB_BYTE + 1) << 8);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic u32 sis5595_func(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA |\r\nI2C_FUNC_SMBUS_PROC_CALL;\r\n}\r\nstatic int __devinit sis5595_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nint err;\r\nif (sis5595_setup(dev)) {\r\ndev_err(&dev->dev, "SIS5595 not detected, module not inserted.\n");\r\nreturn -ENODEV;\r\n}\r\nsis5595_adapter.dev.parent = &dev->dev;\r\nsnprintf(sis5595_adapter.name, sizeof(sis5595_adapter.name),\r\n"SMBus SIS5595 adapter at %04x", sis5595_base + SMB_INDEX);\r\nerr = i2c_add_adapter(&sis5595_adapter);\r\nif (err) {\r\nrelease_region(sis5595_base + SMB_INDEX, 2);\r\nreturn err;\r\n}\r\nsis5595_pdev = pci_dev_get(dev);\r\nreturn -ENODEV;\r\n}\r\nstatic int __init i2c_sis5595_init(void)\r\n{\r\nreturn pci_register_driver(&sis5595_driver);\r\n}\r\nstatic void __exit i2c_sis5595_exit(void)\r\n{\r\npci_unregister_driver(&sis5595_driver);\r\nif (sis5595_pdev) {\r\ni2c_del_adapter(&sis5595_adapter);\r\nrelease_region(sis5595_base + SMB_INDEX, 2);\r\npci_dev_put(sis5595_pdev);\r\nsis5595_pdev = NULL;\r\n}\r\n}

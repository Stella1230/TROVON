static int ath724x_pci_read(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, uint32_t *value)\r\n{\r\nunsigned long flags, addr, tval, mask;\r\nif (devfn)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (where & (size - 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nspin_lock_irqsave(&ath724x_pci_lock, flags);\r\nswitch (size) {\r\ncase 1:\r\naddr = where & ~3;\r\nmask = 0xff000000 >> ((where % 4) * 8);\r\ntval = reg_read(ATH724X_PCI_DEV_BASE + addr);\r\ntval = tval & ~mask;\r\n*value = (tval >> ((4 - (where % 4))*8));\r\nbreak;\r\ncase 2:\r\naddr = where & ~3;\r\nmask = 0xffff0000 >> ((where % 4)*8);\r\ntval = reg_read(ATH724X_PCI_DEV_BASE + addr);\r\ntval = tval & ~mask;\r\n*value = (tval >> ((4 - (where % 4))*8));\r\nbreak;\r\ncase 4:\r\n*value = reg_read(ATH724X_PCI_DEV_BASE + where);\r\nbreak;\r\ndefault:\r\nspin_unlock_irqrestore(&ath724x_pci_lock, flags);\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\n}\r\nspin_unlock_irqrestore(&ath724x_pci_lock, flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int ath724x_pci_write(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, uint32_t value)\r\n{\r\nunsigned long flags, tval, addr, mask;\r\nif (devfn)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (where & (size - 1))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nspin_lock_irqsave(&ath724x_pci_lock, flags);\r\nswitch (size) {\r\ncase 1:\r\naddr = (ATH724X_PCI_DEV_BASE + where) & ~3;\r\nmask = 0xff000000 >> ((where % 4)*8);\r\ntval = reg_read(addr);\r\ntval = tval & ~mask;\r\ntval |= (value << ((4 - (where % 4))*8)) & mask;\r\nreg_write(addr, tval);\r\nbreak;\r\ncase 2:\r\naddr = (ATH724X_PCI_DEV_BASE + where) & ~3;\r\nmask = 0xffff0000 >> ((where % 4)*8);\r\ntval = reg_read(addr);\r\ntval = tval & ~mask;\r\ntval |= (value << ((4 - (where % 4))*8)) & mask;\r\nreg_write(addr, tval);\r\nbreak;\r\ncase 4:\r\nreg_write((ATH724X_PCI_DEV_BASE + where), value);\r\nbreak;\r\ndefault:\r\nspin_unlock_irqrestore(&ath724x_pci_lock, flags);\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\n}\r\nspin_unlock_irqrestore(&ath724x_pci_lock, flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nvoid ath724x_pci_add_data(struct ath724x_pci_data *data, int size)\r\n{\r\npci_data = data;\r\npci_data_size = size;\r\n}\r\nint __init pcibios_map_irq(const struct pci_dev *dev, uint8_t slot, uint8_t pin)\r\n{\r\nunsigned int devfn = dev->devfn;\r\nint irq = -1;\r\nif (devfn > pci_data_size - 1)\r\nreturn irq;\r\nirq = pci_data[devfn].irq;\r\nreturn irq;\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nunsigned int devfn = dev->devfn;\r\nif (devfn > pci_data_size - 1)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\ndev->dev.platform_data = pci_data[devfn].pdata;\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int __init ath724x_pcibios_init(void)\r\n{\r\nregister_pci_controller(&ath724x_pci_controller);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}

static int dvb_buf_setup(struct videobuf_queue *q,\r\nunsigned int *count, unsigned int *size)\r\n{\r\nstruct cx23885_tsport *port = q->priv_data;\r\nport->ts_packet_size = 188 * 4;\r\nport->ts_packet_count = 32;\r\n*size = port->ts_packet_size * port->ts_packet_count;\r\n*count = 32;\r\nreturn 0;\r\n}\r\nstatic int dvb_buf_prepare(struct videobuf_queue *q,\r\nstruct videobuf_buffer *vb, enum v4l2_field field)\r\n{\r\nstruct cx23885_tsport *port = q->priv_data;\r\nreturn cx23885_buf_prepare(q, port, (struct cx23885_buffer *)vb, field);\r\n}\r\nstatic void dvb_buf_queue(struct videobuf_queue *q, struct videobuf_buffer *vb)\r\n{\r\nstruct cx23885_tsport *port = q->priv_data;\r\ncx23885_buf_queue(port, (struct cx23885_buffer *)vb);\r\n}\r\nstatic void dvb_buf_release(struct videobuf_queue *q,\r\nstruct videobuf_buffer *vb)\r\n{\r\ncx23885_free_buffer(q, (struct cx23885_buffer *)vb);\r\n}\r\nstatic void cx23885_dvb_gate_ctrl(struct cx23885_tsport *port, int open)\r\n{\r\nstruct videobuf_dvb_frontends *f;\r\nstruct videobuf_dvb_frontend *fe;\r\nf = &port->frontends;\r\nif (f->gate <= 1)\r\nfe = videobuf_dvb_get_frontend(f, 1);\r\nelse\r\nfe = videobuf_dvb_get_frontend(f, f->gate);\r\nif (fe && fe->dvb.frontend && fe->dvb.frontend->ops.i2c_gate_ctrl)\r\nfe->dvb.frontend->ops.i2c_gate_ctrl(fe->dvb.frontend, open);\r\ncx23885_dvb_set_frontend(fe->dvb.frontend);\r\n}\r\nstatic int cx23885_dvb_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct cx23885_tsport *port = fe->dvb->priv;\r\nstruct cx23885_dev *dev = port->dev;\r\nswitch (dev->board) {\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1275:\r\nswitch (p->modulation) {\r\ncase VSB_8:\r\ncx23885_gpio_clear(dev, GPIO_5);\r\nbreak;\r\ncase QAM_64:\r\ncase QAM_256:\r\ndefault:\r\ncx23885_gpio_set(dev, GPIO_5);\r\nbreak;\r\n}\r\nbreak;\r\ncase CX23885_BOARD_MYGICA_X8506:\r\ncase CX23885_BOARD_MAGICPRO_PROHDTVE2:\r\ncx23885_gpio_set(dev, GPIO_0);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nint netup_altera_fpga_rw(void *device, int flag, int data, int read)\r\n{\r\nstruct cx23885_dev *dev = (struct cx23885_dev *)device;\r\nunsigned long timeout = jiffies + msecs_to_jiffies(1);\r\nuint32_t mem = 0;\r\nmem = cx_read(MC417_RWD);\r\nif (read)\r\ncx_set(MC417_OEN, ALT_DATA);\r\nelse {\r\ncx_clear(MC417_OEN, ALT_DATA);\r\nmem &= ~ALT_DATA;\r\nmem |= (data & ALT_DATA);\r\n}\r\nif (flag)\r\nmem |= ALT_AD_RG;\r\nelse\r\nmem &= ~ALT_AD_RG;\r\nmem &= ~ALT_CS;\r\nif (read)\r\nmem = (mem & ~ALT_RD) | ALT_WR;\r\nelse\r\nmem = (mem & ~ALT_WR) | ALT_RD;\r\ncx_write(MC417_RWD, mem);\r\nfor (;;) {\r\nmem = cx_read(MC417_RWD);\r\nif ((mem & ALT_RDY) == 0)\r\nbreak;\r\nif (time_after(jiffies, timeout))\r\nbreak;\r\nudelay(1);\r\n}\r\ncx_set(MC417_RWD, ALT_RD | ALT_WR | ALT_CS);\r\nif (read)\r\nreturn mem & ALT_DATA;\r\nreturn 0;\r\n}\r\nstatic int dvb_register(struct cx23885_tsport *port)\r\n{\r\nstruct cx23885_dev *dev = port->dev;\r\nstruct cx23885_i2c *i2c_bus = NULL, *i2c_bus2 = NULL;\r\nstruct videobuf_dvb_frontend *fe0, *fe1 = NULL;\r\nint mfe_shared = 0;\r\nint ret;\r\nfe0 = videobuf_dvb_get_frontend(&port->frontends, 1);\r\nif (!fe0)\r\nreturn -EINVAL;\r\nfe0->dvb.name = dev->name;\r\nport->frontends.gate = 0;\r\nport->gate_ctrl = cx23885_dvb_gate_ctrl;\r\nswitch (dev->board) {\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1250:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&hauppauge_generic_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(mt2131_attach, fe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&hauppauge_generic_tunerconfig, 0);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1270:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1275:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(lgdt3305_attach,\r\n&hauppauge_lgdt3305_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[1].i2c_adap,\r\n&hauppauge_hvr127x_config);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1255:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(s5h1411_attach,\r\n&hcw_s5h1411_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[1].i2c_adap,\r\n&hauppauge_tda18271_config);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1800:\r\ni2c_bus = &dev->i2c_bus[0];\r\nswitch (alt_tuner) {\r\ncase 1:\r\nfe0->dvb.frontend =\r\ndvb_attach(s5h1409_attach,\r\n&hauppauge_ezqam_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(tda829x_attach, fe0->dvb.frontend,\r\n&dev->i2c_bus[1].i2c_adap, 0x42,\r\n&tda829x_no_probe);\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[1].i2c_adap,\r\n&hauppauge_tda18271_config);\r\n}\r\nbreak;\r\ncase 0:\r\ndefault:\r\nfe0->dvb.frontend =\r\ndvb_attach(s5h1409_attach,\r\n&hauppauge_generic_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\ndvb_attach(mt2131_attach, fe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&hauppauge_generic_tunerconfig, 0);\r\nbreak;\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1800lp:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&hauppauge_hvr1800lp_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(mt2131_attach, fe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&hauppauge_generic_tunerconfig, 0);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_DVICO_FUSIONHDTV_5_EXP:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(lgdt330x_attach,\r\n&fusionhdtv_5_express,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(simple_tuner_attach, fe0->dvb.frontend,\r\n&i2c_bus->i2c_adap, 0x61,\r\nTUNER_LG_TDVS_H06XF);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1500Q:\r\ni2c_bus = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&hauppauge_hvr1500q_config,\r\n&dev->i2c_bus[0].i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\ndvb_attach(xc5000_attach, fe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&hauppauge_hvr1500q_tunerconfig);\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1500:\r\ni2c_bus = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&hauppauge_hvr1500_config,\r\n&dev->i2c_bus[0].i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nstruct dvb_frontend *fe;\r\nstruct xc2028_config cfg = {\r\n.i2c_adap = &i2c_bus->i2c_adap,\r\n.i2c_addr = 0x61,\r\n};\r\nstatic struct xc2028_ctrl ctl = {\r\n.fname = XC2028_DEFAULT_FIRMWARE,\r\n.max_len = 64,\r\n.demod = XC3028_FE_OREN538,\r\n};\r\nfe = dvb_attach(xc2028_attach,\r\nfe0->dvb.frontend, &cfg);\r\nif (fe != NULL && fe->ops.tuner_ops.set_config != NULL)\r\nfe->ops.tuner_ops.set_config(fe, &ctl);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1200:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1700:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(tda10048_attach,\r\n&hauppauge_hvr1200_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(tda829x_attach, fe0->dvb.frontend,\r\n&dev->i2c_bus[1].i2c_adap, 0x42,\r\n&tda829x_no_probe);\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[1].i2c_adap,\r\n&hauppauge_hvr1200_tuner_config);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1210:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(tda10048_attach,\r\n&hauppauge_hvr1210_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[1].i2c_adap,\r\n&hauppauge_hvr1210_tuner_config);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1400:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(dib7000p_attach,\r\n&i2c_bus->i2c_adap,\r\n0x12, &hauppauge_hvr1400_dib7000_config);\r\nif (fe0->dvb.frontend != NULL) {\r\nstruct dvb_frontend *fe;\r\nstruct xc2028_config cfg = {\r\n.i2c_adap = &dev->i2c_bus[1].i2c_adap,\r\n.i2c_addr = 0x64,\r\n};\r\nstatic struct xc2028_ctrl ctl = {\r\n.fname = XC3028L_DEFAULT_FIRMWARE,\r\n.max_len = 64,\r\n.demod = XC3028_FE_DIBCOM52,\r\n.type = XC2028_D2633,\r\n};\r\nfe = dvb_attach(xc2028_attach,\r\nfe0->dvb.frontend, &cfg);\r\nif (fe != NULL && fe->ops.tuner_ops.set_config != NULL)\r\nfe->ops.tuner_ops.set_config(fe, &ctl);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_DVICO_FUSIONHDTV_7_DUAL_EXP:\r\ni2c_bus = &dev->i2c_bus[port->nr - 1];\r\nfe0->dvb.frontend = dvb_attach(s5h1409_attach,\r\n&dvico_s5h1409_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend == NULL)\r\nfe0->dvb.frontend = dvb_attach(s5h1411_attach,\r\n&dvico_s5h1411_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\ndvb_attach(xc5000_attach, fe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&dvico_xc5000_tunerconfig);\r\nbreak;\r\ncase CX23885_BOARD_DVICO_FUSIONHDTV_DVB_T_DUAL_EXP: {\r\ni2c_bus = &dev->i2c_bus[port->nr - 1];\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_xc3028,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nstruct dvb_frontend *fe;\r\nstruct xc2028_config cfg = {\r\n.i2c_adap = &i2c_bus->i2c_adap,\r\n.i2c_addr = 0x61,\r\n};\r\nstatic struct xc2028_ctrl ctl = {\r\n.fname = XC2028_DEFAULT_FIRMWARE,\r\n.max_len = 64,\r\n.demod = XC3028_FE_ZARLINK456,\r\n};\r\nfe = dvb_attach(xc2028_attach, fe0->dvb.frontend,\r\n&cfg);\r\nif (fe != NULL && fe->ops.tuner_ops.set_config != NULL)\r\nfe->ops.tuner_ops.set_config(fe, &ctl);\r\n}\r\nbreak;\r\n}\r\ncase CX23885_BOARD_LEADTEK_WINFAST_PXDVR3200_H:\r\ncase CX23885_BOARD_COMPRO_VIDEOMATE_E650F:\r\ncase CX23885_BOARD_COMPRO_VIDEOMATE_E800:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_xc3028,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nstruct dvb_frontend *fe;\r\nstruct xc2028_config cfg = {\r\n.i2c_adap = &dev->i2c_bus[1].i2c_adap,\r\n.i2c_addr = 0x61,\r\n};\r\nstatic struct xc2028_ctrl ctl = {\r\n.fname = XC2028_DEFAULT_FIRMWARE,\r\n.max_len = 64,\r\n.demod = XC3028_FE_ZARLINK456,\r\n};\r\nfe = dvb_attach(xc2028_attach, fe0->dvb.frontend,\r\n&cfg);\r\nif (fe != NULL && fe->ops.tuner_ops.set_config != NULL)\r\nfe->ops.tuner_ops.set_config(fe, &ctl);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_LEADTEK_WINFAST_PXDVR3200_H_XC4000:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(zl10353_attach,\r\n&dvico_fusionhdtv_xc3028,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nstruct dvb_frontend *fe;\r\nstruct xc4000_config cfg = {\r\n.i2c_address = 0x61,\r\n.default_pm = 0,\r\n.dvb_amplitude = 134,\r\n.set_smoothedcvbs = 1,\r\n.if_khz = 4560\r\n};\r\nfe = dvb_attach(xc4000_attach, fe0->dvb.frontend,\r\n&dev->i2c_bus[1].i2c_adap, &cfg);\r\nif (!fe) {\r\nprintk(KERN_ERR "%s/2: xc4000 attach failed\n",\r\ndev->name);\r\ngoto frontend_detach;\r\n}\r\n}\r\nbreak;\r\ncase CX23885_BOARD_TBS_6920:\r\ni2c_bus = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(cx24116_attach,\r\n&tbs_cx24116_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\nfe0->dvb.frontend->ops.set_voltage = f300_set_voltage;\r\nbreak;\r\ncase CX23885_BOARD_TEVII_S470:\r\ni2c_bus = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(ds3000_attach,\r\n&tevii_ds3000_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\nfe0->dvb.frontend->ops.set_voltage = f300_set_voltage;\r\nbreak;\r\ncase CX23885_BOARD_DVBWORLD_2005:\r\ni2c_bus = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(cx24116_attach,\r\n&dvbworld_cx24116_config,\r\n&i2c_bus->i2c_adap);\r\nbreak;\r\ncase CX23885_BOARD_NETUP_DUAL_DVBS2_CI:\r\ni2c_bus = &dev->i2c_bus[0];\r\nswitch (port->nr) {\r\ncase 1:\r\nfe0->dvb.frontend = dvb_attach(stv0900_attach,\r\n&netup_stv0900_config,\r\n&i2c_bus->i2c_adap, 0);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (dvb_attach(stv6110_attach,\r\nfe0->dvb.frontend,\r\n&netup_stv6110_tunerconfig_a,\r\n&i2c_bus->i2c_adap)) {\r\nif (!dvb_attach(lnbh24_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\nLNBH24_PCL | LNBH24_TTX,\r\nLNBH24_TEN, 0x09))\r\nprintk(KERN_ERR\r\n"No LNBH24 found!\n");\r\n}\r\n}\r\nbreak;\r\ncase 2:\r\nfe0->dvb.frontend = dvb_attach(stv0900_attach,\r\n&netup_stv0900_config,\r\n&i2c_bus->i2c_adap, 1);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (dvb_attach(stv6110_attach,\r\nfe0->dvb.frontend,\r\n&netup_stv6110_tunerconfig_b,\r\n&i2c_bus->i2c_adap)) {\r\nif (!dvb_attach(lnbh24_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\nLNBH24_PCL | LNBH24_TTX,\r\nLNBH24_TEN, 0x0a))\r\nprintk(KERN_ERR\r\n"No LNBH24 found!\n");\r\n}\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase CX23885_BOARD_MYGICA_X8506:\r\ni2c_bus = &dev->i2c_bus[0];\r\ni2c_bus2 = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(lgs8gxx_attach,\r\n&mygica_x8506_lgs8gl5_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(xc5000_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus2->i2c_adap,\r\n&mygica_x8506_xc5000_config);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_MAGICPRO_PROHDTVE2:\r\ni2c_bus = &dev->i2c_bus[0];\r\ni2c_bus2 = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(lgs8gxx_attach,\r\n&magicpro_prohdtve2_lgs8g75_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(xc5000_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus2->i2c_adap,\r\n&magicpro_prohdtve2_xc5000_config);\r\n}\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1850:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(s5h1411_attach,\r\n&hcw_s5h1411_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[0].i2c_adap,\r\n&hauppauge_tda18271_config);\r\ntda18271_attach(&dev->ts1.analog_fe,\r\n0x60, &dev->i2c_bus[1].i2c_adap,\r\n&hauppauge_tda18271_config);\r\nbreak;\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1290:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(s5h1411_attach,\r\n&hcw_s5h1411_config,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL)\r\ndvb_attach(tda18271_attach, fe0->dvb.frontend,\r\n0x60, &dev->i2c_bus[0].i2c_adap,\r\n&hauppauge_tda18271_config);\r\nbreak;\r\ncase CX23885_BOARD_MYGICA_X8558PRO:\r\nswitch (port->nr) {\r\ncase 1:\r\ni2c_bus = &dev->i2c_bus[0];\r\nfe0->dvb.frontend = dvb_attach(atbm8830_attach,\r\n&mygica_x8558pro_atbm8830_cfg1,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(max2165_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&mygic_x8558pro_max2165_cfg1);\r\n}\r\nbreak;\r\ncase 2:\r\ni2c_bus = &dev->i2c_bus[1];\r\nfe0->dvb.frontend = dvb_attach(atbm8830_attach,\r\n&mygica_x8558pro_atbm8830_cfg2,\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\ndvb_attach(max2165_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&mygic_x8558pro_max2165_cfg2);\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ncase CX23885_BOARD_NETUP_DUAL_DVB_T_C_CI_RF:\r\ni2c_bus = &dev->i2c_bus[0];\r\nmfe_shared = 1;\r\nport->frontends.gate = 0;\r\nfe0->dvb.frontend = dvb_attach(stv0367ter_attach,\r\n&netup_stv0367_config[port->nr - 1],\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (NULL == dvb_attach(xc5000_attach,\r\nfe0->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&netup_xc5000_config[port->nr - 1]))\r\ngoto frontend_detach;\r\nfe0->dvb.frontend->ops.tuner_ops.init(fe0->dvb.frontend);\r\n}\r\nfe1 = videobuf_dvb_get_frontend(&port->frontends, 2);\r\nif (fe1 == NULL)\r\ngoto frontend_detach;\r\nfe1->dvb.frontend = dvb_attach(stv0367cab_attach,\r\n&netup_stv0367_config[port->nr - 1],\r\n&i2c_bus->i2c_adap);\r\nif (fe1->dvb.frontend != NULL) {\r\nfe1->dvb.frontend->id = 1;\r\nif (NULL == dvb_attach(xc5000_attach,\r\nfe1->dvb.frontend,\r\n&i2c_bus->i2c_adap,\r\n&netup_xc5000_config[port->nr - 1]))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\r\ni2c_bus = &dev->i2c_bus[0];\r\ni2c_bus2 = &dev->i2c_bus[1];\r\nswitch (port->nr) {\r\ncase 1:\r\nfe0->dvb.frontend = dvb_attach(drxk_attach,\r\n&terratec_drxk_config[0],\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(mt2063_attach,\r\nfe0->dvb.frontend,\r\n&terratec_mt2063_config[0],\r\n&i2c_bus2->i2c_adap))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\ncase 2:\r\nfe0->dvb.frontend = dvb_attach(drxk_attach,\r\n&terratec_drxk_config[1],\r\n&i2c_bus->i2c_adap);\r\nif (fe0->dvb.frontend != NULL) {\r\nif (!dvb_attach(mt2063_attach,\r\nfe0->dvb.frontend,\r\n&terratec_mt2063_config[1],\r\n&i2c_bus2->i2c_adap))\r\ngoto frontend_detach;\r\n}\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "%s: The frontend of your DVB/ATSC card "\r\n" isn't supported yet\n",\r\ndev->name);\r\nbreak;\r\n}\r\nif ((NULL == fe0->dvb.frontend) || (fe1 && NULL == fe1->dvb.frontend)) {\r\nprintk(KERN_ERR "%s: frontend initialization failed\n",\r\ndev->name);\r\ngoto frontend_detach;\r\n}\r\nfe0->dvb.frontend->callback = cx23885_tuner_callback;\r\nif (fe1)\r\nfe1->dvb.frontend->callback = cx23885_tuner_callback;\r\n#if 0\r\nfe0->dvb.frontend->ops.ts_bus_ctrl = cx23885_dvb_bus_ctrl;\r\nif (fe1)\r\nfe1->dvb.frontend->ops.ts_bus_ctrl = cx23885_dvb_bus_ctrl;\r\n#endif\r\ncall_all(dev, core, s_power, 0);\r\nif (fe0->dvb.frontend->ops.analog_ops.standby)\r\nfe0->dvb.frontend->ops.analog_ops.standby(fe0->dvb.frontend);\r\nret = videobuf_dvb_register_bus(&port->frontends, THIS_MODULE, port,\r\n&dev->pci->dev, adapter_nr, mfe_shared,\r\nNULL);\r\nif (ret)\r\ngoto frontend_detach;\r\nswitch (dev->board) {\r\ncase CX23885_BOARD_NETUP_DUAL_DVBS2_CI: {\r\nstatic struct netup_card_info cinfo;\r\nnetup_get_card_info(&dev->i2c_bus[0].i2c_adap, &cinfo);\r\nmemcpy(port->frontends.adapter.proposed_mac,\r\ncinfo.port[port->nr - 1].mac, 6);\r\nprintk(KERN_INFO "NetUP Dual DVB-S2 CI card port%d MAC=%pM\n",\r\nport->nr, port->frontends.adapter.proposed_mac);\r\nnetup_ci_init(port);\r\nbreak;\r\n}\r\ncase CX23885_BOARD_NETUP_DUAL_DVB_T_C_CI_RF: {\r\nstruct altera_ci_config netup_ci_cfg = {\r\n.dev = dev,\r\n.adapter = &port->frontends.adapter,\r\n.demux = &fe0->dvb.demux,\r\n.fpga_rw = netup_altera_fpga_rw,\r\n};\r\naltera_ci_init(&netup_ci_cfg, port->nr);\r\nbreak;\r\n}\r\ncase CX23885_BOARD_TEVII_S470: {\r\nu8 eeprom[256];\r\nif (port->nr != 1)\r\nbreak;\r\ndev->i2c_bus[0].i2c_client.addr = 0xa0 >> 1;\r\ntveeprom_read(&dev->i2c_bus[0].i2c_client, eeprom, sizeof(eeprom));\r\nprintk(KERN_INFO "TeVii S470 MAC= %pM\n", eeprom + 0xa0);\r\nmemcpy(port->frontends.adapter.proposed_mac, eeprom + 0xa0, 6);\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\nfrontend_detach:\r\nport->gate_ctrl = NULL;\r\nvideobuf_dvb_dealloc_frontends(&port->frontends);\r\nreturn -EINVAL;\r\n}\r\nint cx23885_dvb_register(struct cx23885_tsport *port)\r\n{\r\nstruct videobuf_dvb_frontend *fe0;\r\nstruct cx23885_dev *dev = port->dev;\r\nint err, i;\r\nprintk(KERN_INFO "%s() allocating %d frontend(s)\n", __func__,\r\nport->num_frontends);\r\nfor (i = 1; i <= port->num_frontends; i++) {\r\nif (videobuf_dvb_alloc_frontend(\r\n&port->frontends, i) == NULL) {\r\nprintk(KERN_ERR "%s() failed to alloc\n", __func__);\r\nreturn -ENOMEM;\r\n}\r\nfe0 = videobuf_dvb_get_frontend(&port->frontends, i);\r\nif (!fe0)\r\nerr = -EINVAL;\r\ndprintk(1, "%s\n", __func__);\r\ndprintk(1, " ->probed by Card=%d Name=%s, PCI %02x:%02x\n",\r\ndev->board,\r\ndev->name,\r\ndev->pci_bus,\r\ndev->pci_slot);\r\nerr = -ENODEV;\r\nprintk(KERN_INFO "%s: cx23885 based dvb card\n", dev->name);\r\nvideobuf_queue_sg_init(&fe0->dvb.dvbq, &dvb_qops,\r\n&dev->pci->dev, &port->slock,\r\nV4L2_BUF_TYPE_VIDEO_CAPTURE, V4L2_FIELD_TOP,\r\nsizeof(struct cx23885_buffer), port, NULL);\r\n}\r\nerr = dvb_register(port);\r\nif (err != 0)\r\nprintk(KERN_ERR "%s() dvb_register failed err = %d\n",\r\n__func__, err);\r\nreturn err;\r\n}\r\nint cx23885_dvb_unregister(struct cx23885_tsport *port)\r\n{\r\nstruct videobuf_dvb_frontend *fe0;\r\nfe0 = videobuf_dvb_get_frontend(&port->frontends, 1);\r\nif (fe0 && fe0->dvb.frontend)\r\nvideobuf_dvb_unregister_bus(&port->frontends);\r\nswitch (port->dev->board) {\r\ncase CX23885_BOARD_NETUP_DUAL_DVBS2_CI:\r\nnetup_ci_exit(port);\r\nbreak;\r\ncase CX23885_BOARD_NETUP_DUAL_DVB_T_C_CI_RF:\r\naltera_ci_release(port->dev, port->nr);\r\nbreak;\r\n}\r\nport->gate_ctrl = NULL;\r\nreturn 0;\r\n}

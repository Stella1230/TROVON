void show_regs(struct pt_regs *regs)\r\n{\r\nprintk("\n");\r\nprintk("EIP: %04lx:[<%08lx>] CPU: %d %s",\r\n0xffff & PT_REGS_CS(regs), PT_REGS_IP(regs),\r\nsmp_processor_id(), print_tainted());\r\nif (PT_REGS_CS(regs) & 3)\r\nprintk(" ESP: %04lx:%08lx", 0xffff & PT_REGS_SS(regs),\r\nPT_REGS_SP(regs));\r\nprintk(" EFLAGS: %08lx\n %s\n", PT_REGS_EFLAGS(regs),\r\nprint_tainted());\r\nprintk("EAX: %08lx EBX: %08lx ECX: %08lx EDX: %08lx\n",\r\nPT_REGS_EAX(regs), PT_REGS_EBX(regs),\r\nPT_REGS_ECX(regs),\r\nPT_REGS_EDX(regs));\r\nprintk("ESI: %08lx EDI: %08lx EBP: %08lx",\r\nPT_REGS_ESI(regs), PT_REGS_EDI(regs),\r\nPT_REGS_EBP(regs));\r\nprintk(" DS: %04lx ES: %04lx\n",\r\n0xffff & PT_REGS_DS(regs),\r\n0xffff & PT_REGS_ES(regs));\r\nshow_trace(NULL, (unsigned long *) &regs);\r\n}\r\nstatic inline int valid_stack_ptr(struct thread_info *tinfo, void *p)\r\n{\r\nreturn p > (void *)tinfo &&\r\np < (void *)tinfo + THREAD_SIZE - 3;\r\n}\r\nstatic inline unsigned long print_context_stack(struct thread_info *tinfo,\r\nunsigned long *stack, unsigned long ebp)\r\n{\r\nunsigned long addr;\r\n#ifdef CONFIG_FRAME_POINTER\r\nwhile (valid_stack_ptr(tinfo, (void *)ebp)) {\r\naddr = *(unsigned long *)(ebp + 4);\r\nprintk("%08lx: [<%08lx>]", ebp + 4, addr);\r\nprint_symbol(" %s", addr);\r\nprintk("\n");\r\nebp = *(unsigned long *)ebp;\r\n}\r\n#else\r\nwhile (valid_stack_ptr(tinfo, stack)) {\r\naddr = *stack;\r\nif (__kernel_text_address(addr)) {\r\nprintk("%08lx: [<%08lx>]", (unsigned long) stack, addr);\r\nprint_symbol(" %s", addr);\r\nprintk("\n");\r\n}\r\nstack++;\r\n}\r\n#endif\r\nreturn ebp;\r\n}\r\nvoid show_trace(struct task_struct* task, unsigned long * stack)\r\n{\r\nunsigned long ebp;\r\nstruct thread_info *context;\r\nif (!stack) {\r\nstack = (unsigned long*) &stack;\r\nprintk("show_trace: got NULL stack, implicit assumption task == current");\r\nWARN_ON(1);\r\n}\r\nif (!task)\r\ntask = current;\r\nif (task != current) {\r\nebp = (unsigned long) KSTK_EBP(task);\r\n} else {\r\nasm ("movl %%ebp, %0" : "=r" (ebp) : );\r\n}\r\ncontext = (struct thread_info *)\r\n((unsigned long)stack & (~(THREAD_SIZE - 1)));\r\nprint_context_stack(context, stack, ebp);\r\nprintk("\n");\r\n}

static int __devinit twl4030_write_script_byte(u8 address, u8 byte)\r\n{\r\nint err;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, address,\r\nR_MEMORY_ADDRESS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, byte,\r\nR_MEMORY_DATA);\r\nout:\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_write_script_ins(u8 address, u16 pmb_message,\r\nu8 delay, u8 next)\r\n{\r\nint err;\r\naddress *= 4;\r\nerr = twl4030_write_script_byte(address++, pmb_message >> 8);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_write_script_byte(address++, pmb_message & 0xff);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_write_script_byte(address++, delay);\r\nif (err)\r\ngoto out;\r\nerr = twl4030_write_script_byte(address++, next);\r\nout:\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_write_script(u8 address, struct twl4030_ins *script,\r\nint len)\r\n{\r\nint err;\r\nfor (; len; len--, address++, script++) {\r\nif (len == 1) {\r\nerr = twl4030_write_script_ins(address,\r\nscript->pmb_message,\r\nscript->delay,\r\nEND_OF_SCRIPT);\r\nif (err)\r\nbreak;\r\n} else {\r\nerr = twl4030_write_script_ins(address,\r\nscript->pmb_message,\r\nscript->delay,\r\naddress + 1);\r\nif (err)\r\nbreak;\r\n}\r\n}\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_config_wakeup3_sequence(u8 address)\r\n{\r\nint err;\r\nu8 data;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, address,\r\nR_SEQ_ADD_S2A3);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &data,\r\nR_P3_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\ndata |= LVL_WAKEUP;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, data,\r\nR_P3_SW_EVENTS);\r\nout:\r\nif (err)\r\npr_err("TWL4030 wakeup sequence for P3 config error\n");\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_config_wakeup12_sequence(u8 address)\r\n{\r\nint err = 0;\r\nu8 data;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, address,\r\nR_SEQ_ADD_S2A12);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &data,\r\nR_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\ndata |= LVL_WAKEUP;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, data,\r\nR_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &data,\r\nR_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\ndata |= LVL_WAKEUP;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, data,\r\nR_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nif (machine_is_omap_3430sdp() || machine_is_omap_ldp()) {\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &data,\r\nR_CFG_P1_TRANSITION);\r\nif (err)\r\ngoto out;\r\ndata &= ~(1<<1);\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, data ,\r\nR_CFG_P1_TRANSITION);\r\nif (err)\r\ngoto out;\r\n}\r\nout:\r\nif (err)\r\npr_err("TWL4030 wakeup sequence for P1 and P2" \\r\n"config error\n");\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_config_sleep_sequence(u8 address)\r\n{\r\nint err;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, address,\r\nR_SEQ_ADD_A2S);\r\nif (err)\r\npr_err("TWL4030 sleep sequence config error\n");\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_config_warmreset_sequence(u8 address)\r\n{\r\nint err;\r\nu8 rd_data;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, address,\r\nR_SEQ_ADD_WARM);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &rd_data,\r\nR_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nrd_data |= ENABLE_WARMRESET;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, rd_data,\r\nR_P1_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &rd_data,\r\nR_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nrd_data |= ENABLE_WARMRESET;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, rd_data,\r\nR_P2_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &rd_data,\r\nR_P3_SW_EVENTS);\r\nif (err)\r\ngoto out;\r\nrd_data |= ENABLE_WARMRESET;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, rd_data,\r\nR_P3_SW_EVENTS);\r\nout:\r\nif (err)\r\npr_err("TWL4030 warmreset seq config error\n");\r\nreturn err;\r\n}\r\nstatic int __devinit twl4030_configure_resource(struct twl4030_resconfig *rconfig)\r\n{\r\nint rconfig_addr;\r\nint err;\r\nu8 type;\r\nu8 grp;\r\nu8 remap;\r\nif (rconfig->resource > TOTAL_RESOURCES) {\r\npr_err("TWL4030 Resource %d does not exist\n",\r\nrconfig->resource);\r\nreturn -EINVAL;\r\n}\r\nrconfig_addr = res_config_addrs[rconfig->resource];\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_RECEIVER, &grp,\r\nrconfig_addr + DEV_GRP_OFFSET);\r\nif (err) {\r\npr_err("TWL4030 Resource %d group could not be read\n",\r\nrconfig->resource);\r\nreturn err;\r\n}\r\nif (rconfig->devgroup != TWL4030_RESCONFIG_UNDEF) {\r\ngrp &= ~DEV_GRP_MASK;\r\ngrp |= rconfig->devgroup << DEV_GRP_SHIFT;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER,\r\ngrp, rconfig_addr + DEV_GRP_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 failed to program devgroup\n");\r\nreturn err;\r\n}\r\n}\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_RECEIVER, &type,\r\nrconfig_addr + TYPE_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 Resource %d type could not be read\n",\r\nrconfig->resource);\r\nreturn err;\r\n}\r\nif (rconfig->type != TWL4030_RESCONFIG_UNDEF) {\r\ntype &= ~TYPE_MASK;\r\ntype |= rconfig->type << TYPE_SHIFT;\r\n}\r\nif (rconfig->type2 != TWL4030_RESCONFIG_UNDEF) {\r\ntype &= ~TYPE2_MASK;\r\ntype |= rconfig->type2 << TYPE2_SHIFT;\r\n}\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER,\r\ntype, rconfig_addr + TYPE_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 failed to program resource type\n");\r\nreturn err;\r\n}\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_RECEIVER, &remap,\r\nrconfig_addr + REMAP_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 Resource %d remap could not be read\n",\r\nrconfig->resource);\r\nreturn err;\r\n}\r\nif (rconfig->remap_off != TWL4030_RESCONFIG_UNDEF) {\r\nremap &= ~OFF_STATE_MASK;\r\nremap |= rconfig->remap_off << OFF_STATE_SHIFT;\r\n}\r\nif (rconfig->remap_sleep != TWL4030_RESCONFIG_UNDEF) {\r\nremap &= ~SLEEP_STATE_MASK;\r\nremap |= rconfig->remap_sleep << SLEEP_STATE_SHIFT;\r\n}\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER,\r\nremap,\r\nrconfig_addr + REMAP_OFFSET);\r\nif (err < 0) {\r\npr_err("TWL4030 failed to program remap\n");\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit load_twl4030_script(struct twl4030_script *tscript,\r\nu8 address)\r\n{\r\nint err;\r\nstatic int order;\r\nif ((address + tscript->size) > END_OF_SCRIPT) {\r\npr_err("TWL4030 scripts too big error\n");\r\nreturn -EINVAL;\r\n}\r\nerr = twl4030_write_script(address, tscript->script, tscript->size);\r\nif (err)\r\ngoto out;\r\nif (tscript->flags & TWL4030_WRST_SCRIPT) {\r\nerr = twl4030_config_warmreset_sequence(address);\r\nif (err)\r\ngoto out;\r\n}\r\nif (tscript->flags & TWL4030_WAKEUP12_SCRIPT) {\r\nerr = twl4030_config_wakeup12_sequence(address);\r\nif (err)\r\ngoto out;\r\norder = 1;\r\n}\r\nif (tscript->flags & TWL4030_WAKEUP3_SCRIPT) {\r\nerr = twl4030_config_wakeup3_sequence(address);\r\nif (err)\r\ngoto out;\r\n}\r\nif (tscript->flags & TWL4030_SLEEP_SCRIPT) {\r\nif (!order)\r\npr_warning("TWL4030: Bad order of scripts (sleep "\\r\n"script before wakeup) Leads to boot"\\r\n"failure on some boards\n");\r\nerr = twl4030_config_sleep_sequence(address);\r\n}\r\nout:\r\nreturn err;\r\n}\r\nint twl4030_remove_script(u8 flags)\r\n{\r\nint err = 0;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER,\r\nTWL4030_PM_MASTER_KEY_CFG1,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err) {\r\npr_err("twl4030: unable to unlock PROTECT_KEY\n");\r\nreturn err;\r\n}\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER,\r\nTWL4030_PM_MASTER_KEY_CFG2,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err) {\r\npr_err("twl4030: unable to unlock PROTECT_KEY\n");\r\nreturn err;\r\n}\r\nif (flags & TWL4030_WRST_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_WARM);\r\nif (err)\r\nreturn err;\r\n}\r\nif (flags & TWL4030_WAKEUP12_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_S2A12);\r\nif (err)\r\nreturn err;\r\n}\r\nif (flags & TWL4030_WAKEUP3_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_S2A3);\r\nif (err)\r\nreturn err;\r\n}\r\nif (flags & TWL4030_SLEEP_SCRIPT) {\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, END_OF_SCRIPT,\r\nR_SEQ_ADD_A2S);\r\nif (err)\r\nreturn err;\r\n}\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, 0,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\npr_err("TWL4030 Unable to relock registers\n");\r\nreturn err;\r\n}\r\nvoid twl4030_power_off(void)\r\n{\r\nint err;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, PWR_DEVOFF,\r\nTWL4030_PM_MASTER_P1_SW_EVENTS);\r\nif (err)\r\npr_err("TWL4030 Unable to power off\n");\r\n}\r\nvoid __devinit twl4030_power_init(struct twl4030_power_data *twl4030_scripts)\r\n{\r\nint err = 0;\r\nint i;\r\nstruct twl4030_resconfig *resconfig;\r\nu8 val, address = twl4030_start_script_address;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER,\r\nTWL4030_PM_MASTER_KEY_CFG1,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\ngoto unlock;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER,\r\nTWL4030_PM_MASTER_KEY_CFG2,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\ngoto unlock;\r\nfor (i = 0; i < twl4030_scripts->num; i++) {\r\nerr = load_twl4030_script(twl4030_scripts->scripts[i], address);\r\nif (err)\r\ngoto load;\r\naddress += twl4030_scripts->scripts[i]->size;\r\n}\r\nresconfig = twl4030_scripts->resource_config;\r\nif (resconfig) {\r\nwhile (resconfig->resource) {\r\nerr = twl4030_configure_resource(resconfig);\r\nif (err)\r\ngoto resource;\r\nresconfig++;\r\n}\r\n}\r\nif (twl4030_scripts->use_poweroff && !pm_power_off) {\r\nerr = twl_i2c_read_u8(TWL4030_MODULE_PM_MASTER, &val,\r\nTWL4030_PM_MASTER_CFG_P123_TRANSITION);\r\nif (err) {\r\npr_warning("TWL4030 Unable to read registers\n");\r\n} else if (!(val & SEQ_OFFSYNC)) {\r\nval |= SEQ_OFFSYNC;\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, val,\r\nTWL4030_PM_MASTER_CFG_P123_TRANSITION);\r\nif (err) {\r\npr_err("TWL4030 Unable to setup SEQ_OFFSYNC\n");\r\ngoto relock;\r\n}\r\n}\r\npm_power_off = twl4030_power_off;\r\n}\r\nrelock:\r\nerr = twl_i2c_write_u8(TWL4030_MODULE_PM_MASTER, 0,\r\nTWL4030_PM_MASTER_PROTECT_KEY);\r\nif (err)\r\npr_err("TWL4030 Unable to relock registers\n");\r\nreturn;\r\nunlock:\r\nif (err)\r\npr_err("TWL4030 Unable to unlock registers\n");\r\nreturn;\r\nload:\r\nif (err)\r\npr_err("TWL4030 failed to load scripts\n");\r\nreturn;\r\nresource:\r\nif (err)\r\npr_err("TWL4030 failed to configure resource\n");\r\nreturn;\r\n}

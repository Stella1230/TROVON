void fimc_hw_reset(struct fimc_dev *dev)\r\n{\r\nu32 cfg;\r\ncfg = readl(dev->regs + S5P_CISRCFMT);\r\ncfg |= S5P_CISRCFMT_ITU601_8BIT;\r\nwritel(cfg, dev->regs + S5P_CISRCFMT);\r\ncfg = readl(dev->regs + S5P_CIGCTRL);\r\ncfg |= (S5P_CIGCTRL_SWRST | S5P_CIGCTRL_IRQ_LEVEL);\r\nwritel(cfg, dev->regs + S5P_CIGCTRL);\r\nudelay(10);\r\ncfg = readl(dev->regs + S5P_CIGCTRL);\r\ncfg &= ~S5P_CIGCTRL_SWRST;\r\nwritel(cfg, dev->regs + S5P_CIGCTRL);\r\nif (dev->variant->out_buf_count > 4)\r\nfimc_hw_set_dma_seq(dev, 0xF);\r\n}\r\nstatic u32 fimc_hw_get_in_flip(struct fimc_ctx *ctx)\r\n{\r\nu32 flip = S5P_MSCTRL_FLIP_NORMAL;\r\nif (ctx->hflip)\r\nflip = S5P_MSCTRL_FLIP_X_MIRROR;\r\nif (ctx->vflip)\r\nflip = S5P_MSCTRL_FLIP_Y_MIRROR;\r\nif (ctx->rotation <= 90)\r\nreturn flip;\r\nreturn (flip ^ S5P_MSCTRL_FLIP_180) & S5P_MSCTRL_FLIP_180;\r\n}\r\nstatic u32 fimc_hw_get_target_flip(struct fimc_ctx *ctx)\r\n{\r\nu32 flip = S5P_CITRGFMT_FLIP_NORMAL;\r\nif (ctx->hflip)\r\nflip |= S5P_CITRGFMT_FLIP_X_MIRROR;\r\nif (ctx->vflip)\r\nflip |= S5P_CITRGFMT_FLIP_Y_MIRROR;\r\nif (ctx->rotation <= 90)\r\nreturn flip;\r\nreturn (flip ^ S5P_CITRGFMT_FLIP_180) & S5P_CITRGFMT_FLIP_180;\r\n}\r\nvoid fimc_hw_set_rotation(struct fimc_ctx *ctx)\r\n{\r\nu32 cfg, flip;\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\ncfg = readl(dev->regs + S5P_CITRGFMT);\r\ncfg &= ~(S5P_CITRGFMT_INROT90 | S5P_CITRGFMT_OUTROT90 |\r\nS5P_CITRGFMT_FLIP_180);\r\nif (ctx->rotation == 90 || ctx->rotation == 270) {\r\nif (ctx->out_path == FIMC_LCDFIFO)\r\ncfg |= S5P_CITRGFMT_INROT90;\r\nelse\r\ncfg |= S5P_CITRGFMT_OUTROT90;\r\n}\r\nif (ctx->out_path == FIMC_DMA) {\r\ncfg |= fimc_hw_get_target_flip(ctx);\r\nwritel(cfg, dev->regs + S5P_CITRGFMT);\r\n} else {\r\nflip = readl(dev->regs + S5P_MSCTRL);\r\nflip &= ~S5P_MSCTRL_FLIP_MASK;\r\nflip |= fimc_hw_get_in_flip(ctx);\r\nwritel(flip, dev->regs + S5P_MSCTRL);\r\n}\r\n}\r\nvoid fimc_hw_set_target_format(struct fimc_ctx *ctx)\r\n{\r\nu32 cfg;\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_frame *frame = &ctx->d_frame;\r\ndbg("w= %d, h= %d color: %d", frame->width,\r\nframe->height, frame->fmt->color);\r\ncfg = readl(dev->regs + S5P_CITRGFMT);\r\ncfg &= ~(S5P_CITRGFMT_FMT_MASK | S5P_CITRGFMT_HSIZE_MASK |\r\nS5P_CITRGFMT_VSIZE_MASK);\r\nswitch (frame->fmt->color) {\r\ncase S5P_FIMC_RGB444...S5P_FIMC_RGB888:\r\ncfg |= S5P_CITRGFMT_RGB;\r\nbreak;\r\ncase S5P_FIMC_YCBCR420:\r\ncfg |= S5P_CITRGFMT_YCBCR420;\r\nbreak;\r\ncase S5P_FIMC_YCBYCR422...S5P_FIMC_CRYCBY422:\r\nif (frame->fmt->colplanes == 1)\r\ncfg |= S5P_CITRGFMT_YCBCR422_1P;\r\nelse\r\ncfg |= S5P_CITRGFMT_YCBCR422;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (ctx->rotation == 90 || ctx->rotation == 270) {\r\ncfg |= S5P_CITRGFMT_HSIZE(frame->height);\r\ncfg |= S5P_CITRGFMT_VSIZE(frame->width);\r\n} else {\r\ncfg |= S5P_CITRGFMT_HSIZE(frame->width);\r\ncfg |= S5P_CITRGFMT_VSIZE(frame->height);\r\n}\r\nwritel(cfg, dev->regs + S5P_CITRGFMT);\r\ncfg = readl(dev->regs + S5P_CITAREA) & ~S5P_CITAREA_MASK;\r\ncfg |= (frame->width * frame->height);\r\nwritel(cfg, dev->regs + S5P_CITAREA);\r\n}\r\nstatic void fimc_hw_set_out_dma_size(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_frame *frame = &ctx->d_frame;\r\nu32 cfg;\r\ncfg = S5P_ORIG_SIZE_HOR(frame->f_width);\r\ncfg |= S5P_ORIG_SIZE_VER(frame->f_height);\r\nwritel(cfg, dev->regs + S5P_ORGOSIZE);\r\ncfg = readl(dev->regs + S5P_CIGCTRL);\r\nif (frame->f_width >= 1280)\r\ncfg |= S5P_CIGCTRL_CSC_ITU601_709;\r\nelse\r\ncfg &= ~S5P_CIGCTRL_CSC_ITU601_709;\r\nwritel(cfg, dev->regs + S5P_CIGCTRL);\r\n}\r\nvoid fimc_hw_set_out_dma(struct fimc_ctx *ctx)\r\n{\r\nu32 cfg;\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_frame *frame = &ctx->d_frame;\r\nstruct fimc_dma_offset *offset = &frame->dma_offset;\r\nstruct fimc_fmt *fmt = frame->fmt;\r\ncfg = 0;\r\ncfg |= S5P_CIO_OFFS_HOR(offset->y_h);\r\ncfg |= S5P_CIO_OFFS_VER(offset->y_v);\r\nwritel(cfg, dev->regs + S5P_CIOYOFF);\r\ncfg = 0;\r\ncfg |= S5P_CIO_OFFS_HOR(offset->cb_h);\r\ncfg |= S5P_CIO_OFFS_VER(offset->cb_v);\r\nwritel(cfg, dev->regs + S5P_CIOCBOFF);\r\ncfg = 0;\r\ncfg |= S5P_CIO_OFFS_HOR(offset->cr_h);\r\ncfg |= S5P_CIO_OFFS_VER(offset->cr_v);\r\nwritel(cfg, dev->regs + S5P_CIOCROFF);\r\nfimc_hw_set_out_dma_size(ctx);\r\ncfg = readl(dev->regs + S5P_CIOCTRL);\r\ncfg &= ~(S5P_CIOCTRL_ORDER2P_MASK | S5P_CIOCTRL_ORDER422_MASK |\r\nS5P_CIOCTRL_YCBCR_PLANE_MASK | S5P_CIOCTRL_RGB16FMT_MASK);\r\nif (fmt->colplanes == 1)\r\ncfg |= ctx->out_order_1p;\r\nelse if (fmt->colplanes == 2)\r\ncfg |= ctx->out_order_2p | S5P_CIOCTRL_YCBCR_2PLANE;\r\nelse if (fmt->colplanes == 3)\r\ncfg |= S5P_CIOCTRL_YCBCR_3PLANE;\r\nif (fmt->color == S5P_FIMC_RGB565)\r\ncfg |= S5P_CIOCTRL_RGB565;\r\nelse if (fmt->color == S5P_FIMC_RGB555)\r\ncfg |= S5P_CIOCTRL_ARGB1555;\r\nelse if (fmt->color == S5P_FIMC_RGB444)\r\ncfg |= S5P_CIOCTRL_ARGB4444;\r\nwritel(cfg, dev->regs + S5P_CIOCTRL);\r\n}\r\nstatic void fimc_hw_en_autoload(struct fimc_dev *dev, int enable)\r\n{\r\nu32 cfg = readl(dev->regs + S5P_ORGISIZE);\r\nif (enable)\r\ncfg |= S5P_CIREAL_ISIZE_AUTOLOAD_EN;\r\nelse\r\ncfg &= ~S5P_CIREAL_ISIZE_AUTOLOAD_EN;\r\nwritel(cfg, dev->regs + S5P_ORGISIZE);\r\n}\r\nvoid fimc_hw_en_lastirq(struct fimc_dev *dev, int enable)\r\n{\r\nu32 cfg = readl(dev->regs + S5P_CIOCTRL);\r\nif (enable)\r\ncfg |= S5P_CIOCTRL_LASTIRQ_ENABLE;\r\nelse\r\ncfg &= ~S5P_CIOCTRL_LASTIRQ_ENABLE;\r\nwritel(cfg, dev->regs + S5P_CIOCTRL);\r\n}\r\nvoid fimc_hw_set_prescaler(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_scaler *sc = &ctx->scaler;\r\nu32 cfg, shfactor;\r\nshfactor = 10 - (sc->hfactor + sc->vfactor);\r\ncfg = S5P_CISCPRERATIO_SHFACTOR(shfactor);\r\ncfg |= S5P_CISCPRERATIO_HOR(sc->pre_hratio);\r\ncfg |= S5P_CISCPRERATIO_VER(sc->pre_vratio);\r\nwritel(cfg, dev->regs + S5P_CISCPRERATIO);\r\ncfg = S5P_CISCPREDST_WIDTH(sc->pre_dst_width);\r\ncfg |= S5P_CISCPREDST_HEIGHT(sc->pre_dst_height);\r\nwritel(cfg, dev->regs + S5P_CISCPREDST);\r\n}\r\nstatic void fimc_hw_set_scaler(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_scaler *sc = &ctx->scaler;\r\nstruct fimc_frame *src_frame = &ctx->s_frame;\r\nstruct fimc_frame *dst_frame = &ctx->d_frame;\r\nu32 cfg = readl(dev->regs + S5P_CISCCTRL);\r\ncfg &= ~(S5P_CISCCTRL_CSCR2Y_WIDE | S5P_CISCCTRL_CSCY2R_WIDE |\r\nS5P_CISCCTRL_SCALEUP_H | S5P_CISCCTRL_SCALEUP_V |\r\nS5P_CISCCTRL_SCALERBYPASS | S5P_CISCCTRL_ONE2ONE |\r\nS5P_CISCCTRL_INRGB_FMT_MASK | S5P_CISCCTRL_OUTRGB_FMT_MASK |\r\nS5P_CISCCTRL_INTERLACE | S5P_CISCCTRL_RGB_EXT);\r\nif (!(ctx->flags & FIMC_COLOR_RANGE_NARROW))\r\ncfg |= (S5P_CISCCTRL_CSCR2Y_WIDE | S5P_CISCCTRL_CSCY2R_WIDE);\r\nif (!sc->enabled)\r\ncfg |= S5P_CISCCTRL_SCALERBYPASS;\r\nif (sc->scaleup_h)\r\ncfg |= S5P_CISCCTRL_SCALEUP_H;\r\nif (sc->scaleup_v)\r\ncfg |= S5P_CISCCTRL_SCALEUP_V;\r\nif (sc->copy_mode)\r\ncfg |= S5P_CISCCTRL_ONE2ONE;\r\nif (ctx->in_path == FIMC_DMA) {\r\nswitch (src_frame->fmt->color) {\r\ncase S5P_FIMC_RGB565:\r\ncfg |= S5P_CISCCTRL_INRGB_FMT_RGB565;\r\nbreak;\r\ncase S5P_FIMC_RGB666:\r\ncfg |= S5P_CISCCTRL_INRGB_FMT_RGB666;\r\nbreak;\r\ncase S5P_FIMC_RGB888:\r\ncfg |= S5P_CISCCTRL_INRGB_FMT_RGB888;\r\nbreak;\r\n}\r\n}\r\nif (ctx->out_path == FIMC_DMA) {\r\nu32 color = dst_frame->fmt->color;\r\nif (color >= S5P_FIMC_RGB444 && color <= S5P_FIMC_RGB565)\r\ncfg |= S5P_CISCCTRL_OUTRGB_FMT_RGB565;\r\nelse if (color == S5P_FIMC_RGB666)\r\ncfg |= S5P_CISCCTRL_OUTRGB_FMT_RGB666;\r\nelse if (color == S5P_FIMC_RGB888)\r\ncfg |= S5P_CISCCTRL_OUTRGB_FMT_RGB888;\r\n} else {\r\ncfg |= S5P_CISCCTRL_OUTRGB_FMT_RGB888;\r\nif (ctx->flags & FIMC_SCAN_MODE_INTERLACED)\r\ncfg |= S5P_CISCCTRL_INTERLACE;\r\n}\r\nwritel(cfg, dev->regs + S5P_CISCCTRL);\r\n}\r\nvoid fimc_hw_set_mainscaler(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct samsung_fimc_variant *variant = dev->variant;\r\nstruct fimc_scaler *sc = &ctx->scaler;\r\nu32 cfg;\r\ndbg("main_hratio= 0x%X main_vratio= 0x%X",\r\nsc->main_hratio, sc->main_vratio);\r\nfimc_hw_set_scaler(ctx);\r\ncfg = readl(dev->regs + S5P_CISCCTRL);\r\ncfg &= ~(S5P_CISCCTRL_MHRATIO_MASK | S5P_CISCCTRL_MVRATIO_MASK);\r\nif (variant->has_mainscaler_ext) {\r\ncfg |= S5P_CISCCTRL_MHRATIO_EXT(sc->main_hratio);\r\ncfg |= S5P_CISCCTRL_MVRATIO_EXT(sc->main_vratio);\r\nwritel(cfg, dev->regs + S5P_CISCCTRL);\r\ncfg = readl(dev->regs + S5P_CIEXTEN);\r\ncfg &= ~(S5P_CIEXTEN_MVRATIO_EXT_MASK |\r\nS5P_CIEXTEN_MHRATIO_EXT_MASK);\r\ncfg |= S5P_CIEXTEN_MHRATIO_EXT(sc->main_hratio);\r\ncfg |= S5P_CIEXTEN_MVRATIO_EXT(sc->main_vratio);\r\nwritel(cfg, dev->regs + S5P_CIEXTEN);\r\n} else {\r\ncfg |= S5P_CISCCTRL_MHRATIO(sc->main_hratio);\r\ncfg |= S5P_CISCCTRL_MVRATIO(sc->main_vratio);\r\nwritel(cfg, dev->regs + S5P_CISCCTRL);\r\n}\r\n}\r\nvoid fimc_hw_en_capture(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nu32 cfg = readl(dev->regs + S5P_CIIMGCPT);\r\nif (ctx->out_path == FIMC_DMA) {\r\ncfg |= S5P_CIIMGCPT_CPT_FREN_ENABLE | S5P_CIIMGCPT_IMGCPTEN;\r\n} else {\r\ncfg &= ~(S5P_CIIMGCPT_CPT_FREN_ENABLE |\r\nS5P_CIIMGCPT_CPT_FRMOD_CNT);\r\ncfg |= S5P_CIIMGCPT_IMGCPTEN;\r\n}\r\nif (ctx->scaler.enabled)\r\ncfg |= S5P_CIIMGCPT_IMGCPTEN_SC;\r\nwritel(cfg | S5P_CIIMGCPT_IMGCPTEN, dev->regs + S5P_CIIMGCPT);\r\n}\r\nvoid fimc_hw_set_effect(struct fimc_ctx *ctx, bool active)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_effect *effect = &ctx->effect;\r\nu32 cfg = 0;\r\nif (active) {\r\ncfg |= S5P_CIIMGEFF_IE_SC_AFTER | S5P_CIIMGEFF_IE_ENABLE;\r\ncfg |= effect->type;\r\nif (effect->type == S5P_FIMC_EFFECT_ARBITRARY) {\r\ncfg |= S5P_CIIMGEFF_PAT_CB(effect->pat_cb);\r\ncfg |= S5P_CIIMGEFF_PAT_CR(effect->pat_cr);\r\n}\r\n}\r\nwritel(cfg, dev->regs + S5P_CIIMGEFF);\r\n}\r\nvoid fimc_hw_set_rgb_alpha(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_frame *frame = &ctx->d_frame;\r\nu32 cfg;\r\nif (!(frame->fmt->flags & FMT_HAS_ALPHA))\r\nreturn;\r\ncfg = readl(dev->regs + S5P_CIOCTRL);\r\ncfg &= ~S5P_CIOCTRL_ALPHA_OUT_MASK;\r\ncfg |= (frame->alpha << 4);\r\nwritel(cfg, dev->regs + S5P_CIOCTRL);\r\n}\r\nstatic void fimc_hw_set_in_dma_size(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_frame *frame = &ctx->s_frame;\r\nu32 cfg_o = 0;\r\nu32 cfg_r = 0;\r\nif (FIMC_LCDFIFO == ctx->out_path)\r\ncfg_r |= S5P_CIREAL_ISIZE_AUTOLOAD_EN;\r\ncfg_o |= S5P_ORIG_SIZE_HOR(frame->f_width);\r\ncfg_o |= S5P_ORIG_SIZE_VER(frame->f_height);\r\ncfg_r |= S5P_CIREAL_ISIZE_WIDTH(frame->width);\r\ncfg_r |= S5P_CIREAL_ISIZE_HEIGHT(frame->height);\r\nwritel(cfg_o, dev->regs + S5P_ORGISIZE);\r\nwritel(cfg_r, dev->regs + S5P_CIREAL_ISIZE);\r\n}\r\nvoid fimc_hw_set_in_dma(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nstruct fimc_frame *frame = &ctx->s_frame;\r\nstruct fimc_dma_offset *offset = &frame->dma_offset;\r\nu32 cfg;\r\ncfg = S5P_CIO_OFFS_HOR(offset->y_h);\r\ncfg |= S5P_CIO_OFFS_VER(offset->y_v);\r\nwritel(cfg, dev->regs + S5P_CIIYOFF);\r\ncfg = S5P_CIO_OFFS_HOR(offset->cb_h);\r\ncfg |= S5P_CIO_OFFS_VER(offset->cb_v);\r\nwritel(cfg, dev->regs + S5P_CIICBOFF);\r\ncfg = S5P_CIO_OFFS_HOR(offset->cr_h);\r\ncfg |= S5P_CIO_OFFS_VER(offset->cr_v);\r\nwritel(cfg, dev->regs + S5P_CIICROFF);\r\nfimc_hw_set_in_dma_size(ctx);\r\nfimc_hw_en_autoload(dev, ctx->out_path == FIMC_LCDFIFO);\r\ncfg = readl(dev->regs + S5P_MSCTRL);\r\ncfg &= ~(S5P_MSCTRL_INFORMAT_MASK\r\n| S5P_MSCTRL_IN_BURST_COUNT_MASK\r\n| S5P_MSCTRL_INPUT_MASK\r\n| S5P_MSCTRL_C_INT_IN_MASK\r\n| S5P_MSCTRL_2P_IN_ORDER_MASK);\r\ncfg |= (S5P_MSCTRL_IN_BURST_COUNT(4)\r\n| S5P_MSCTRL_INPUT_MEMORY\r\n| S5P_MSCTRL_FIFO_CTRL_FULL);\r\nswitch (frame->fmt->color) {\r\ncase S5P_FIMC_RGB565...S5P_FIMC_RGB888:\r\ncfg |= S5P_MSCTRL_INFORMAT_RGB;\r\nbreak;\r\ncase S5P_FIMC_YCBCR420:\r\ncfg |= S5P_MSCTRL_INFORMAT_YCBCR420;\r\nif (frame->fmt->colplanes == 2)\r\ncfg |= ctx->in_order_2p | S5P_MSCTRL_C_INT_IN_2PLANE;\r\nelse\r\ncfg |= S5P_MSCTRL_C_INT_IN_3PLANE;\r\nbreak;\r\ncase S5P_FIMC_YCBYCR422...S5P_FIMC_CRYCBY422:\r\nif (frame->fmt->colplanes == 1) {\r\ncfg |= ctx->in_order_1p\r\n| S5P_MSCTRL_INFORMAT_YCBCR422_1P;\r\n} else {\r\ncfg |= S5P_MSCTRL_INFORMAT_YCBCR422;\r\nif (frame->fmt->colplanes == 2)\r\ncfg |= ctx->in_order_2p\r\n| S5P_MSCTRL_C_INT_IN_2PLANE;\r\nelse\r\ncfg |= S5P_MSCTRL_C_INT_IN_3PLANE;\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nwritel(cfg, dev->regs + S5P_MSCTRL);\r\ncfg = readl(dev->regs + S5P_CIDMAPARAM);\r\ncfg &= ~S5P_CIDMAPARAM_TILE_MASK;\r\nif (tiled_fmt(ctx->s_frame.fmt))\r\ncfg |= S5P_CIDMAPARAM_R_64X32;\r\nif (tiled_fmt(ctx->d_frame.fmt))\r\ncfg |= S5P_CIDMAPARAM_W_64X32;\r\nwritel(cfg, dev->regs + S5P_CIDMAPARAM);\r\n}\r\nvoid fimc_hw_set_input_path(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nu32 cfg = readl(dev->regs + S5P_MSCTRL);\r\ncfg &= ~S5P_MSCTRL_INPUT_MASK;\r\nif (ctx->in_path == FIMC_DMA)\r\ncfg |= S5P_MSCTRL_INPUT_MEMORY;\r\nelse\r\ncfg |= S5P_MSCTRL_INPUT_EXTCAM;\r\nwritel(cfg, dev->regs + S5P_MSCTRL);\r\n}\r\nvoid fimc_hw_set_output_path(struct fimc_ctx *ctx)\r\n{\r\nstruct fimc_dev *dev = ctx->fimc_dev;\r\nu32 cfg = readl(dev->regs + S5P_CISCCTRL);\r\ncfg &= ~S5P_CISCCTRL_LCDPATHEN_FIFO;\r\nif (ctx->out_path == FIMC_LCDFIFO)\r\ncfg |= S5P_CISCCTRL_LCDPATHEN_FIFO;\r\nwritel(cfg, dev->regs + S5P_CISCCTRL);\r\n}\r\nvoid fimc_hw_set_input_addr(struct fimc_dev *dev, struct fimc_addr *paddr)\r\n{\r\nu32 cfg = readl(dev->regs + S5P_CIREAL_ISIZE);\r\ncfg |= S5P_CIREAL_ISIZE_ADDR_CH_DIS;\r\nwritel(cfg, dev->regs + S5P_CIREAL_ISIZE);\r\nwritel(paddr->y, dev->regs + S5P_CIIYSA(0));\r\nwritel(paddr->cb, dev->regs + S5P_CIICBSA(0));\r\nwritel(paddr->cr, dev->regs + S5P_CIICRSA(0));\r\ncfg &= ~S5P_CIREAL_ISIZE_ADDR_CH_DIS;\r\nwritel(cfg, dev->regs + S5P_CIREAL_ISIZE);\r\n}\r\nvoid fimc_hw_set_output_addr(struct fimc_dev *dev,\r\nstruct fimc_addr *paddr, int index)\r\n{\r\nint i = (index == -1) ? 0 : index;\r\ndo {\r\nwritel(paddr->y, dev->regs + S5P_CIOYSA(i));\r\nwritel(paddr->cb, dev->regs + S5P_CIOCBSA(i));\r\nwritel(paddr->cr, dev->regs + S5P_CIOCRSA(i));\r\ndbg("dst_buf[%d]: 0x%X, cb: 0x%X, cr: 0x%X",\r\ni, paddr->y, paddr->cb, paddr->cr);\r\n} while (index == -1 && ++i < FIMC_MAX_OUT_BUFS);\r\n}\r\nint fimc_hw_set_camera_polarity(struct fimc_dev *fimc,\r\nstruct s5p_fimc_isp_info *cam)\r\n{\r\nu32 cfg = readl(fimc->regs + S5P_CIGCTRL);\r\ncfg &= ~(S5P_CIGCTRL_INVPOLPCLK | S5P_CIGCTRL_INVPOLVSYNC |\r\nS5P_CIGCTRL_INVPOLHREF | S5P_CIGCTRL_INVPOLHSYNC |\r\nS5P_CIGCTRL_INVPOLFIELD);\r\nif (cam->flags & V4L2_MBUS_PCLK_SAMPLE_FALLING)\r\ncfg |= S5P_CIGCTRL_INVPOLPCLK;\r\nif (cam->flags & V4L2_MBUS_VSYNC_ACTIVE_LOW)\r\ncfg |= S5P_CIGCTRL_INVPOLVSYNC;\r\nif (cam->flags & V4L2_MBUS_HSYNC_ACTIVE_LOW)\r\ncfg |= S5P_CIGCTRL_INVPOLHREF;\r\nif (cam->flags & V4L2_MBUS_HSYNC_ACTIVE_LOW)\r\ncfg |= S5P_CIGCTRL_INVPOLHSYNC;\r\nif (cam->flags & V4L2_MBUS_FIELD_EVEN_LOW)\r\ncfg |= S5P_CIGCTRL_INVPOLFIELD;\r\nwritel(cfg, fimc->regs + S5P_CIGCTRL);\r\nreturn 0;\r\n}\r\nint fimc_hw_set_camera_source(struct fimc_dev *fimc,\r\nstruct s5p_fimc_isp_info *cam)\r\n{\r\nstruct fimc_frame *f = &fimc->vid_cap.ctx->s_frame;\r\nu32 cfg = 0;\r\nu32 bus_width;\r\nint i;\r\nstatic const struct {\r\nu32 pixelcode;\r\nu32 cisrcfmt;\r\nu16 bus_width;\r\n} pix_desc[] = {\r\n{ V4L2_MBUS_FMT_YUYV8_2X8, S5P_CISRCFMT_ORDER422_YCBYCR, 8 },\r\n{ V4L2_MBUS_FMT_YVYU8_2X8, S5P_CISRCFMT_ORDER422_YCRYCB, 8 },\r\n{ V4L2_MBUS_FMT_VYUY8_2X8, S5P_CISRCFMT_ORDER422_CRYCBY, 8 },\r\n{ V4L2_MBUS_FMT_UYVY8_2X8, S5P_CISRCFMT_ORDER422_CBYCRY, 8 },\r\n};\r\nif (cam->bus_type == FIMC_ITU_601 || cam->bus_type == FIMC_ITU_656) {\r\nfor (i = 0; i < ARRAY_SIZE(pix_desc); i++) {\r\nif (fimc->vid_cap.mf.code == pix_desc[i].pixelcode) {\r\ncfg = pix_desc[i].cisrcfmt;\r\nbus_width = pix_desc[i].bus_width;\r\nbreak;\r\n}\r\n}\r\nif (i == ARRAY_SIZE(pix_desc)) {\r\nv4l2_err(fimc->vid_cap.vfd,\r\n"Camera color format not supported: %d\n",\r\nfimc->vid_cap.mf.code);\r\nreturn -EINVAL;\r\n}\r\nif (cam->bus_type == FIMC_ITU_601) {\r\nif (bus_width == 8)\r\ncfg |= S5P_CISRCFMT_ITU601_8BIT;\r\nelse if (bus_width == 16)\r\ncfg |= S5P_CISRCFMT_ITU601_16BIT;\r\n}\r\n} else if (cam->bus_type == FIMC_MIPI_CSI2) {\r\nif (fimc_fmt_is_jpeg(f->fmt->color))\r\ncfg |= S5P_CISRCFMT_ITU601_8BIT;\r\n}\r\ncfg |= S5P_CISRCFMT_HSIZE(f->o_width) | S5P_CISRCFMT_VSIZE(f->o_height);\r\nwritel(cfg, fimc->regs + S5P_CISRCFMT);\r\nreturn 0;\r\n}\r\nint fimc_hw_set_camera_offset(struct fimc_dev *fimc, struct fimc_frame *f)\r\n{\r\nu32 hoff2, voff2;\r\nu32 cfg = readl(fimc->regs + S5P_CIWDOFST);\r\ncfg &= ~(S5P_CIWDOFST_HOROFF_MASK | S5P_CIWDOFST_VEROFF_MASK);\r\ncfg |= S5P_CIWDOFST_OFF_EN |\r\nS5P_CIWDOFST_HOROFF(f->offs_h) |\r\nS5P_CIWDOFST_VEROFF(f->offs_v);\r\nwritel(cfg, fimc->regs + S5P_CIWDOFST);\r\nhoff2 = f->o_width - f->width - f->offs_h;\r\nvoff2 = f->o_height - f->height - f->offs_v;\r\ncfg = S5P_CIWDOFST2_HOROFF(hoff2) | S5P_CIWDOFST2_VEROFF(voff2);\r\nwritel(cfg, fimc->regs + S5P_CIWDOFST2);\r\nreturn 0;\r\n}\r\nint fimc_hw_set_camera_type(struct fimc_dev *fimc,\r\nstruct s5p_fimc_isp_info *cam)\r\n{\r\nu32 cfg, tmp;\r\nstruct fimc_vid_cap *vid_cap = &fimc->vid_cap;\r\ncfg = readl(fimc->regs + S5P_CIGCTRL);\r\ncfg &= ~(S5P_CIGCTRL_TESTPAT_MASK | S5P_CIGCTRL_SELCAM_ITU_A |\r\nS5P_CIGCTRL_SELCAM_MIPI | S5P_CIGCTRL_CAMIF_SELWB |\r\nS5P_CIGCTRL_SELCAM_MIPI_A | S5P_CIGCTRL_CAM_JPEG);\r\nif (cam->bus_type == FIMC_MIPI_CSI2) {\r\ncfg |= S5P_CIGCTRL_SELCAM_MIPI;\r\nif (cam->mux_id == 0)\r\ncfg |= S5P_CIGCTRL_SELCAM_MIPI_A;\r\nswitch (vid_cap->mf.code) {\r\ncase V4L2_MBUS_FMT_VYUY8_2X8:\r\ntmp = S5P_CSIIMGFMT_YCBCR422_8BIT;\r\nbreak;\r\ncase V4L2_MBUS_FMT_JPEG_1X8:\r\ntmp = S5P_CSIIMGFMT_USER(1);\r\ncfg |= S5P_CIGCTRL_CAM_JPEG;\r\nbreak;\r\ndefault:\r\nv4l2_err(fimc->vid_cap.vfd,\r\n"Not supported camera pixel format: %d",\r\nvid_cap->mf.code);\r\nreturn -EINVAL;\r\n}\r\ntmp |= (cam->csi_data_align == 32) << 8;\r\nwritel(tmp, fimc->regs + S5P_CSIIMGFMT);\r\n} else if (cam->bus_type == FIMC_ITU_601 ||\r\ncam->bus_type == FIMC_ITU_656) {\r\nif (cam->mux_id == 0)\r\ncfg |= S5P_CIGCTRL_SELCAM_ITU_A;\r\n} else if (cam->bus_type == FIMC_LCD_WB) {\r\ncfg |= S5P_CIGCTRL_CAMIF_SELWB;\r\n} else {\r\nerr("invalid camera bus type selected\n");\r\nreturn -EINVAL;\r\n}\r\nwritel(cfg, fimc->regs + S5P_CIGCTRL);\r\nreturn 0;\r\n}

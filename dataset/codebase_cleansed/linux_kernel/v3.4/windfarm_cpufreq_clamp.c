static int clamp_notifier_call(struct notifier_block *self,\r\nunsigned long event, void *data)\r\n{\r\nstruct cpufreq_policy *p = data;\r\nunsigned long max_freq;\r\nif (event != CPUFREQ_ADJUST)\r\nreturn 0;\r\nmax_freq = clamped ? (p->cpuinfo.min_freq) : (p->cpuinfo.max_freq);\r\ncpufreq_verify_within_limits(p, 0, max_freq);\r\nreturn 0;\r\n}\r\nstatic int clamp_set(struct wf_control *ct, s32 value)\r\n{\r\nif (value)\r\nprintk(KERN_INFO "windfarm: Clamping CPU frequency to "\r\n"minimum !\n");\r\nelse\r\nprintk(KERN_INFO "windfarm: CPU frequency unclamped !\n");\r\nclamped = value;\r\ncpufreq_update_policy(0);\r\nreturn 0;\r\n}\r\nstatic int clamp_get(struct wf_control *ct, s32 *value)\r\n{\r\n*value = clamped;\r\nreturn 0;\r\n}\r\nstatic s32 clamp_min(struct wf_control *ct)\r\n{\r\nreturn 0;\r\n}\r\nstatic s32 clamp_max(struct wf_control *ct)\r\n{\r\nreturn 1;\r\n}\r\nstatic int __init wf_cpufreq_clamp_init(void)\r\n{\r\nstruct wf_control *clamp;\r\nif (of_machine_is_compatible("PowerMac7,2") ||\r\nof_machine_is_compatible("PowerMac7,3") ||\r\nof_machine_is_compatible("RackMac3,1"))\r\nreturn -ENODEV;\r\nclamp = kmalloc(sizeof(struct wf_control), GFP_KERNEL);\r\nif (clamp == NULL)\r\nreturn -ENOMEM;\r\ncpufreq_register_notifier(&clamp_notifier, CPUFREQ_POLICY_NOTIFIER);\r\nclamp->ops = &clamp_ops;\r\nclamp->name = "cpufreq-clamp";\r\nif (wf_register_control(clamp))\r\ngoto fail;\r\nclamp_control = clamp;\r\nreturn 0;\r\nfail:\r\nkfree(clamp);\r\nreturn -ENODEV;\r\n}\r\nstatic void __exit wf_cpufreq_clamp_exit(void)\r\n{\r\nif (clamp_control)\r\nwf_unregister_control(clamp_control);\r\n}

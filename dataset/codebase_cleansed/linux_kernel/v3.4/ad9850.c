static ssize_t ad9850_set_parameter(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct spi_message msg;\r\nstruct spi_transfer xfer;\r\nint ret;\r\nstruct ad9850_config *config = (struct ad9850_config *)buf;\r\nstruct iio_dev *idev = dev_get_drvdata(dev);\r\nstruct ad9850_state *st = iio_priv(idev);\r\nxfer.len = len;\r\nxfer.tx_buf = config;\r\nmutex_lock(&st->lock);\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfer, &msg);\r\nret = spi_sync(st->sdev, &msg);\r\nif (ret)\r\ngoto error_ret;\r\nerror_ret:\r\nmutex_unlock(&st->lock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int __devinit ad9850_probe(struct spi_device *spi)\r\n{\r\nstruct ad9850_state *st;\r\nstruct iio_dev *idev;\r\nint ret = 0;\r\nidev = iio_allocate_device(sizeof(*st));\r\nif (idev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nspi_set_drvdata(spi, idev);\r\nst = iio_priv(idev);\r\nmutex_init(&st->lock);\r\nst->sdev = spi;\r\nidev->dev.parent = &spi->dev;\r\nidev->info = &ad9850_info;\r\nidev->modes = INDIO_DIRECT_MODE;\r\nret = iio_device_register(idev);\r\nif (ret)\r\ngoto error_free_dev;\r\nspi->max_speed_hz = 2000000;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 16;\r\nspi_setup(spi);\r\nreturn 0;\r\nerror_free_dev:\r\niio_free_device(idev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int __devexit ad9850_remove(struct spi_device *spi)\r\n{\r\niio_device_unregister(spi_get_drvdata(spi));\r\niio_free_device(spi_get_drvdata(spi));\r\nreturn 0;\r\n}

static void pr28829_delay(void)\r\n{\r\nudelay(10);\r\n}\r\nstruct pcicore_info *pcicore_init(struct si_pub *sih, struct bcma_device *core)\r\n{\r\nstruct pcicore_info *pi;\r\npi = kzalloc(sizeof(struct pcicore_info), GFP_ATOMIC);\r\nif (pi == NULL)\r\nreturn NULL;\r\npi->sih = sih;\r\npi->dev = core->bus->host_pci;\r\npi->core = core;\r\nif (core->id.id == PCIE_CORE_ID) {\r\nu8 cap_ptr;\r\ncap_ptr = pcicore_find_pci_capability(pi->dev, PCI_CAP_ID_EXP,\r\nNULL, NULL);\r\npi->pciecap_lcreg_offset = cap_ptr + PCIE_CAP_LINKCTRL_OFFSET;\r\n}\r\nreturn pi;\r\n}\r\nvoid pcicore_deinit(struct pcicore_info *pch)\r\n{\r\nkfree(pch);\r\n}\r\nu8\r\npcicore_find_pci_capability(struct pci_dev *dev, u8 req_cap_id,\r\nunsigned char *buf, u32 *buflen)\r\n{\r\nu8 cap_id;\r\nu8 cap_ptr = 0;\r\nu32 bufsize;\r\nu8 byte_val;\r\npci_read_config_byte(dev, PCI_HEADER_TYPE, &byte_val);\r\nif ((byte_val & 0x7f) != PCI_HEADER_TYPE_NORMAL)\r\ngoto end;\r\npci_read_config_byte(dev, PCI_STATUS, &byte_val);\r\nif (!(byte_val & PCI_STATUS_CAP_LIST))\r\ngoto end;\r\npci_read_config_byte(dev, PCI_CAPABILITY_LIST, &cap_ptr);\r\nif (cap_ptr == 0x00)\r\ngoto end;\r\npci_read_config_byte(dev, cap_ptr, &cap_id);\r\nwhile (cap_id != req_cap_id) {\r\npci_read_config_byte(dev, cap_ptr + 1, &cap_ptr);\r\nif (cap_ptr == 0x00)\r\nbreak;\r\npci_read_config_byte(dev, cap_ptr, &cap_id);\r\n}\r\nif (cap_id != req_cap_id)\r\ngoto end;\r\nif (buf != NULL && buflen != NULL) {\r\nu8 cap_data;\r\nbufsize = *buflen;\r\nif (!bufsize)\r\ngoto end;\r\n*buflen = 0;\r\ncap_data = cap_ptr + 2;\r\nif ((bufsize + cap_data) > PCI_SZPCR)\r\nbufsize = PCI_SZPCR - cap_data;\r\n*buflen = bufsize;\r\nwhile (bufsize--) {\r\npci_read_config_byte(dev, cap_data, buf);\r\ncap_data++;\r\nbuf++;\r\n}\r\n}\r\nend:\r\nreturn cap_ptr;\r\n}\r\nstatic uint\r\npcie_readreg(struct bcma_device *core, uint addrtype, uint offset)\r\n{\r\nuint retval = 0xFFFFFFFF;\r\nswitch (addrtype) {\r\ncase PCIE_CONFIGREGS:\r\nbcma_write32(core, PCIEREGOFFS(configaddr), offset);\r\n(void)bcma_read32(core, PCIEREGOFFS(configaddr));\r\nretval = bcma_read32(core, PCIEREGOFFS(configdata));\r\nbreak;\r\ncase PCIE_PCIEREGS:\r\nbcma_write32(core, PCIEREGOFFS(pcieindaddr), offset);\r\n(void)bcma_read32(core, PCIEREGOFFS(pcieindaddr));\r\nretval = bcma_read32(core, PCIEREGOFFS(pcieinddata));\r\nbreak;\r\n}\r\nreturn retval;\r\n}\r\nstatic uint pcie_writereg(struct bcma_device *core, uint addrtype,\r\nuint offset, uint val)\r\n{\r\nswitch (addrtype) {\r\ncase PCIE_CONFIGREGS:\r\nbcma_write32(core, PCIEREGOFFS(configaddr), offset);\r\nbcma_write32(core, PCIEREGOFFS(configdata), val);\r\nbreak;\r\ncase PCIE_PCIEREGS:\r\nbcma_write32(core, PCIEREGOFFS(pcieindaddr), offset);\r\nbcma_write32(core, PCIEREGOFFS(pcieinddata), val);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic bool pcie_mdiosetblock(struct pcicore_info *pi, uint blk)\r\n{\r\nuint mdiodata, i = 0;\r\nuint pcie_serdes_spinwait = 200;\r\nmdiodata = (MDIODATA_START | MDIODATA_WRITE | MDIODATA_TA |\r\n(MDIODATA_DEV_ADDR << MDIODATA_DEVADDR_SHF) |\r\n(MDIODATA_BLK_ADDR << MDIODATA_REGADDR_SHF) |\r\n(blk << 4));\r\nbcma_write32(pi->core, PCIEREGOFFS(mdiodata), mdiodata);\r\npr28829_delay();\r\nwhile (i < pcie_serdes_spinwait) {\r\nif (bcma_read32(pi->core, PCIEREGOFFS(mdiocontrol)) &\r\nMDIOCTL_ACCESS_DONE)\r\nbreak;\r\nudelay(1000);\r\ni++;\r\n}\r\nif (i >= pcie_serdes_spinwait)\r\nreturn false;\r\nreturn true;\r\n}\r\nstatic int\r\npcie_mdioop(struct pcicore_info *pi, uint physmedia, uint regaddr, bool write,\r\nuint *val)\r\n{\r\nuint mdiodata;\r\nuint i = 0;\r\nuint pcie_serdes_spinwait = 10;\r\nbcma_write32(pi->core, PCIEREGOFFS(mdiocontrol),\r\nMDIOCTL_PREAM_EN | MDIOCTL_DIVISOR_VAL);\r\nif (ai_get_buscorerev(pi->sih) >= 10) {\r\nif (!pcie_mdiosetblock(pi, physmedia))\r\nreturn 1;\r\nmdiodata = ((MDIODATA_DEV_ADDR << MDIODATA_DEVADDR_SHF) |\r\n(regaddr << MDIODATA_REGADDR_SHF));\r\npcie_serdes_spinwait *= 20;\r\n} else {\r\nmdiodata = ((physmedia << MDIODATA_DEVADDR_SHF_OLD) |\r\n(regaddr << MDIODATA_REGADDR_SHF_OLD));\r\n}\r\nif (!write)\r\nmdiodata |= (MDIODATA_START | MDIODATA_READ | MDIODATA_TA);\r\nelse\r\nmdiodata |= (MDIODATA_START | MDIODATA_WRITE | MDIODATA_TA |\r\n*val);\r\nbcma_write32(pi->core, PCIEREGOFFS(mdiodata), mdiodata);\r\npr28829_delay();\r\nwhile (i < pcie_serdes_spinwait) {\r\nif (bcma_read32(pi->core, PCIEREGOFFS(mdiocontrol)) &\r\nMDIOCTL_ACCESS_DONE) {\r\nif (!write) {\r\npr28829_delay();\r\n*val = (bcma_read32(pi->core,\r\nPCIEREGOFFS(mdiodata)) &\r\nMDIODATA_MASK);\r\n}\r\nbcma_write32(pi->core, PCIEREGOFFS(mdiocontrol), 0);\r\nreturn 0;\r\n}\r\nudelay(1000);\r\ni++;\r\n}\r\nbcma_write32(pi->core, PCIEREGOFFS(mdiocontrol), 0);\r\nreturn 1;\r\n}\r\nstatic int\r\npcie_mdioread(struct pcicore_info *pi, uint physmedia, uint regaddr,\r\nuint *regval)\r\n{\r\nreturn pcie_mdioop(pi, physmedia, regaddr, false, regval);\r\n}\r\nstatic int\r\npcie_mdiowrite(struct pcicore_info *pi, uint physmedia, uint regaddr, uint val)\r\n{\r\nreturn pcie_mdioop(pi, physmedia, regaddr, true, &val);\r\n}\r\nstatic u8 pcie_clkreq(struct pcicore_info *pi, u32 mask, u32 val)\r\n{\r\nu32 reg_val;\r\nu8 offset;\r\noffset = pi->pciecap_lcreg_offset;\r\nif (!offset)\r\nreturn 0;\r\npci_read_config_dword(pi->dev, offset, &reg_val);\r\nif (mask) {\r\nif (val)\r\nreg_val |= PCIE_CLKREQ_ENAB;\r\nelse\r\nreg_val &= ~PCIE_CLKREQ_ENAB;\r\npci_write_config_dword(pi->dev, offset, reg_val);\r\npci_read_config_dword(pi->dev, offset, &reg_val);\r\n}\r\nif (reg_val & PCIE_CLKREQ_ENAB)\r\nreturn 1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic void pcie_extendL1timer(struct pcicore_info *pi, bool extend)\r\n{\r\nu32 w;\r\nstruct si_pub *sih = pi->sih;\r\nif (ai_get_buscoretype(sih) != PCIE_CORE_ID ||\r\nai_get_buscorerev(sih) < 7)\r\nreturn;\r\nw = pcie_readreg(pi->core, PCIE_PCIEREGS, PCIE_DLLP_PMTHRESHREG);\r\nif (extend)\r\nw |= PCIE_ASPMTIMER_EXTEND;\r\nelse\r\nw &= ~PCIE_ASPMTIMER_EXTEND;\r\npcie_writereg(pi->core, PCIE_PCIEREGS, PCIE_DLLP_PMTHRESHREG, w);\r\nw = pcie_readreg(pi->core, PCIE_PCIEREGS, PCIE_DLLP_PMTHRESHREG);\r\n}\r\nstatic void pcie_clkreq_upd(struct pcicore_info *pi, uint state)\r\n{\r\nstruct si_pub *sih = pi->sih;\r\nswitch (state) {\r\ncase SI_DOATTACH:\r\nif (PCIE_ASPM(sih))\r\npcie_clkreq(pi, 1, 0);\r\nbreak;\r\ncase SI_PCIDOWN:\r\nif (ai_get_buscorerev(sih) == 6) {\r\nai_cc_reg(sih,\r\noffsetof(struct chipcregs, chipcontrol_addr),\r\n~0, 0);\r\nai_cc_reg(sih,\r\noffsetof(struct chipcregs, chipcontrol_data),\r\n~0x40, 0);\r\n} else if (pi->pcie_pr42767) {\r\npcie_clkreq(pi, 1, 1);\r\n}\r\nbreak;\r\ncase SI_PCIUP:\r\nif (ai_get_buscorerev(sih) == 6) {\r\nai_cc_reg(sih,\r\noffsetof(struct chipcregs, chipcontrol_addr),\r\n~0, 0);\r\nai_cc_reg(sih,\r\noffsetof(struct chipcregs, chipcontrol_data),\r\n~0x40, 0x40);\r\n} else if (PCIE_ASPM(sih)) {\r\npcie_clkreq(pi, 1, 0);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void pcie_war_polarity(struct pcicore_info *pi)\r\n{\r\nu32 w;\r\nif (pi->pcie_polarity != 0)\r\nreturn;\r\nw = pcie_readreg(pi->core, PCIE_PCIEREGS, PCIE_PLP_STATUSREG);\r\nif ((w & PCIE_PLP_POLARITYINV_STAT) == 0)\r\npi->pcie_polarity = SERDES_RX_CTRL_FORCE;\r\nelse\r\npi->pcie_polarity = (SERDES_RX_CTRL_FORCE |\r\nSERDES_RX_CTRL_POLARITY);\r\n}\r\nstatic void pcie_war_aspm_clkreq(struct pcicore_info *pi)\r\n{\r\nstruct si_pub *sih = pi->sih;\r\nu16 val16;\r\nu32 w;\r\nif (!PCIE_ASPM(sih))\r\nreturn;\r\nval16 = bcma_read16(pi->core, PCIEREGOFFS(sprom[SRSH_ASPM_OFFSET]));\r\nval16 &= ~SRSH_ASPM_ENB;\r\nif (pi->pcie_war_aspm_ovr == PCIE_ASPM_ENAB)\r\nval16 |= SRSH_ASPM_ENB;\r\nelse if (pi->pcie_war_aspm_ovr == PCIE_ASPM_L1_ENAB)\r\nval16 |= SRSH_ASPM_L1_ENB;\r\nelse if (pi->pcie_war_aspm_ovr == PCIE_ASPM_L0s_ENAB)\r\nval16 |= SRSH_ASPM_L0s_ENB;\r\nbcma_write16(pi->core, PCIEREGOFFS(sprom[SRSH_ASPM_OFFSET]), val16);\r\npci_read_config_dword(pi->dev, pi->pciecap_lcreg_offset, &w);\r\nw &= ~PCIE_ASPM_ENAB;\r\nw |= pi->pcie_war_aspm_ovr;\r\npci_write_config_dword(pi->dev, pi->pciecap_lcreg_offset, w);\r\nval16 = bcma_read16(pi->core,\r\nPCIEREGOFFS(sprom[SRSH_CLKREQ_OFFSET_REV5]));\r\nif (pi->pcie_war_aspm_ovr != PCIE_ASPM_DISAB) {\r\nval16 |= SRSH_CLKREQ_ENB;\r\npi->pcie_pr42767 = true;\r\n} else\r\nval16 &= ~SRSH_CLKREQ_ENB;\r\nbcma_write16(pi->core, PCIEREGOFFS(sprom[SRSH_CLKREQ_OFFSET_REV5]),\r\nval16);\r\n}\r\nstatic void pcie_war_serdes(struct pcicore_info *pi)\r\n{\r\nu32 w = 0;\r\nif (pi->pcie_polarity != 0)\r\npcie_mdiowrite(pi, MDIODATA_DEV_RX, SERDES_RX_CTRL,\r\npi->pcie_polarity);\r\npcie_mdioread(pi, MDIODATA_DEV_PLL, SERDES_PLL_CTRL, &w);\r\nif (w & PLL_CTRL_FREQDET_EN) {\r\nw &= ~PLL_CTRL_FREQDET_EN;\r\npcie_mdiowrite(pi, MDIODATA_DEV_PLL, SERDES_PLL_CTRL, w);\r\n}\r\n}\r\nstatic void pcie_misc_config_fixup(struct pcicore_info *pi)\r\n{\r\nu16 val16;\r\nval16 = bcma_read16(pi->core,\r\nPCIEREGOFFS(sprom[SRSH_PCIE_MISC_CONFIG]));\r\nif ((val16 & SRSH_L23READY_EXIT_NOPERST) == 0) {\r\nval16 |= SRSH_L23READY_EXIT_NOPERST;\r\nbcma_write16(pi->core,\r\nPCIEREGOFFS(sprom[SRSH_PCIE_MISC_CONFIG]), val16);\r\n}\r\n}\r\nstatic void pcie_war_noplldown(struct pcicore_info *pi)\r\n{\r\nai_cc_reg(pi->sih, offsetof(struct chipcregs, chipcontrol),\r\nCHIPCTRL_4321_PLL_DOWN, CHIPCTRL_4321_PLL_DOWN);\r\nbcma_write16(pi->core, PCIEREGOFFS(sprom[SRSH_BD_OFFSET]), 0);\r\n}\r\nstatic void pcie_war_pci_setup(struct pcicore_info *pi)\r\n{\r\nstruct si_pub *sih = pi->sih;\r\nu32 w;\r\nif (ai_get_buscorerev(sih) == 0 || ai_get_buscorerev(sih) == 1) {\r\nw = pcie_readreg(pi->core, PCIE_PCIEREGS,\r\nPCIE_TLP_WORKAROUNDSREG);\r\nw |= 0x8;\r\npcie_writereg(pi->core, PCIE_PCIEREGS,\r\nPCIE_TLP_WORKAROUNDSREG, w);\r\n}\r\nif (ai_get_buscorerev(sih) == 1) {\r\nw = pcie_readreg(pi->core, PCIE_PCIEREGS, PCIE_DLLP_LCREG);\r\nw |= 0x40;\r\npcie_writereg(pi->core, PCIE_PCIEREGS, PCIE_DLLP_LCREG, w);\r\n}\r\nif (ai_get_buscorerev(sih) == 0) {\r\npcie_mdiowrite(pi, MDIODATA_DEV_RX, SERDES_RX_TIMER1, 0x8128);\r\npcie_mdiowrite(pi, MDIODATA_DEV_RX, SERDES_RX_CDR, 0x0100);\r\npcie_mdiowrite(pi, MDIODATA_DEV_RX, SERDES_RX_CDRBW, 0x1466);\r\n} else if (PCIE_ASPM(sih)) {\r\nw = pcie_readreg(pi->core, PCIE_PCIEREGS,\r\nPCIE_DLLP_PMTHRESHREG);\r\nw &= ~PCIE_L1THRESHOLDTIME_MASK;\r\nw |= PCIE_L1THRESHOLD_WARVAL << PCIE_L1THRESHOLDTIME_SHIFT;\r\npcie_writereg(pi->core, PCIE_PCIEREGS,\r\nPCIE_DLLP_PMTHRESHREG, w);\r\npcie_war_serdes(pi);\r\npcie_war_aspm_clkreq(pi);\r\n} else if (ai_get_buscorerev(pi->sih) == 7)\r\npcie_war_noplldown(pi);\r\nif (ai_get_buscorerev(pi->sih) >= 6)\r\npcie_misc_config_fixup(pi);\r\n}\r\nvoid pcicore_attach(struct pcicore_info *pi, int state)\r\n{\r\nstruct si_pub *sih = pi->sih;\r\nu32 bfl2 = (u32)getintvar(sih, BRCMS_SROM_BOARDFLAGS2);\r\nif (PCIE_ASPM(sih)) {\r\nif (bfl2 & BFL2_PCIEWAR_OVR)\r\npi->pcie_war_aspm_ovr = PCIE_ASPM_DISAB;\r\nelse\r\npi->pcie_war_aspm_ovr = PCIE_ASPM_ENAB;\r\n}\r\npcie_war_polarity(pi);\r\npcie_war_serdes(pi);\r\npcie_war_aspm_clkreq(pi);\r\npcie_clkreq_upd(pi, state);\r\n}\r\nvoid pcicore_hwup(struct pcicore_info *pi)\r\n{\r\nif (!pi || ai_get_buscoretype(pi->sih) != PCIE_CORE_ID)\r\nreturn;\r\npcie_war_pci_setup(pi);\r\n}\r\nvoid pcicore_up(struct pcicore_info *pi, int state)\r\n{\r\nif (!pi || ai_get_buscoretype(pi->sih) != PCIE_CORE_ID)\r\nreturn;\r\npcie_extendL1timer(pi, true);\r\npcie_clkreq_upd(pi, state);\r\n}\r\nvoid pcicore_sleep(struct pcicore_info *pi)\r\n{\r\nu32 w;\r\nif (!pi || !PCIE_ASPM(pi->sih))\r\nreturn;\r\npci_read_config_dword(pi->dev, pi->pciecap_lcreg_offset, &w);\r\nw &= ~PCIE_CAP_LCREG_ASPML1;\r\npci_write_config_dword(pi->dev, pi->pciecap_lcreg_offset, w);\r\npi->pcie_pr42767 = false;\r\n}\r\nvoid pcicore_down(struct pcicore_info *pi, int state)\r\n{\r\nif (!pi || ai_get_buscoretype(pi->sih) != PCIE_CORE_ID)\r\nreturn;\r\npcie_clkreq_upd(pi, state);\r\npcie_extendL1timer(pi, false);\r\n}\r\nvoid pcicore_fixcfg(struct pcicore_info *pi)\r\n{\r\nstruct bcma_device *core = pi->core;\r\nu16 val16;\r\nuint regoff;\r\nswitch (pi->core->id.id) {\r\ncase BCMA_CORE_PCI:\r\nregoff = PCIREGOFFS(sprom[SRSH_PI_OFFSET]);\r\nbreak;\r\ncase BCMA_CORE_PCIE:\r\nregoff = PCIEREGOFFS(sprom[SRSH_PI_OFFSET]);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nval16 = bcma_read16(pi->core, regoff);\r\nif (((val16 & SRSH_PI_MASK) >> SRSH_PI_SHIFT) !=\r\n(u16)core->core_index) {\r\nval16 = ((u16)core->core_index << SRSH_PI_SHIFT) |\r\n(val16 & ~SRSH_PI_MASK);\r\nbcma_write16(pi->core, regoff, val16);\r\n}\r\n}\r\nvoid\r\npcicore_pci_setup(struct pcicore_info *pi)\r\n{\r\nbcma_set32(pi->core, PCIREGOFFS(sbtopci2),\r\nSBTOPCI_PREF | SBTOPCI_BURST);\r\nif (pi->core->id.rev >= 11) {\r\nbcma_set32(pi->core, PCIREGOFFS(sbtopci2),\r\nSBTOPCI_RC_READMULTI);\r\nbcma_set32(pi->core, PCIREGOFFS(clkrun), PCI_CLKRUN_DSBL);\r\n(void)bcma_read32(pi->core, PCIREGOFFS(clkrun));\r\n}\r\n}

static void *r_start(struct seq_file *m, loff_t *pos)\r\n{\r\nstruct wan_device *wandev;\r\nloff_t l = *pos;\r\nmutex_lock(&config_mutex);\r\nif (!l--)\r\nreturn SEQ_START_TOKEN;\r\nfor (wandev = wanrouter_router_devlist; l-- && wandev;\r\nwandev = wandev->next)\r\n;\r\nreturn wandev;\r\n}\r\nstatic void *r_next(struct seq_file *m, void *v, loff_t *pos)\r\n{\r\nstruct wan_device *wandev = v;\r\n(*pos)++;\r\nreturn (v == SEQ_START_TOKEN) ? wanrouter_router_devlist : wandev->next;\r\n}\r\nstatic void r_stop(struct seq_file *m, void *v)\r\n{\r\nmutex_unlock(&config_mutex);\r\n}\r\nstatic int config_show(struct seq_file *m, void *v)\r\n{\r\nstruct wan_device *p = v;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_puts(m, "Device name | port |IRQ|DMA| mem.addr |"\r\n"mem.size|option1|option2|option3|option4\n");\r\nreturn 0;\r\n}\r\nif (!p->state)\r\nreturn 0;\r\nseq_printf(m, "%-15s|0x%-4X|%3u|%3u| 0x%-8lX |0x%-6X|%7u|%7u|%7u|%7u\n",\r\np->name, p->ioport, p->irq, p->dma, p->maddr, p->msize,\r\np->hw_opt[0], p->hw_opt[1], p->hw_opt[2], p->hw_opt[3]);\r\nreturn 0;\r\n}\r\nstatic int status_show(struct seq_file *m, void *v)\r\n{\r\nstruct wan_device *p = v;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_puts(m, "Device name |protocol|station|interface|"\r\n"clocking|baud rate| MTU |ndev|link state\n");\r\nreturn 0;\r\n}\r\nif (!p->state)\r\nreturn 0;\r\nseq_printf(m, "%-15s|%-8s| %-7s| %-9s|%-8s|%9u|%5u|%3u |",\r\np->name,\r\nPROT_DECODE(p->config_id),\r\np->config_id == WANCONFIG_FR ?\r\n(p->station ? "Node" : "CPE") :\r\n(p->config_id == WANCONFIG_X25 ?\r\n(p->station ? "DCE" : "DTE") :\r\n("N/A")),\r\np->interface ? "V.35" : "RS-232",\r\np->clocking ? "internal" : "external",\r\np->bps,\r\np->mtu,\r\np->ndev);\r\nswitch (p->state) {\r\ncase WAN_UNCONFIGURED:\r\nseq_printf(m, "%-12s\n", "unconfigured");\r\nbreak;\r\ncase WAN_DISCONNECTED:\r\nseq_printf(m, "%-12s\n", "disconnected");\r\nbreak;\r\ncase WAN_CONNECTING:\r\nseq_printf(m, "%-12s\n", "connecting");\r\nbreak;\r\ncase WAN_CONNECTED:\r\nseq_printf(m, "%-12s\n", "connected");\r\nbreak;\r\ndefault:\r\nseq_printf(m, "%-12s\n", "invalid");\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int config_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &config_op);\r\n}\r\nstatic int status_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &status_op);\r\n}\r\nstatic int wandev_show(struct seq_file *m, void *v)\r\n{\r\nstruct wan_device *wandev = m->private;\r\nif (wandev->magic != ROUTER_MAGIC)\r\nreturn 0;\r\nif (!wandev->state) {\r\nseq_puts(m, "device is not configured!\n");\r\nreturn 0;\r\n}\r\nif (wandev->update) {\r\nint err = wandev->update(wandev);\r\nif (err == -EAGAIN) {\r\nseq_puts(m, "Device is busy!\n");\r\nreturn 0;\r\n}\r\nif (err) {\r\nseq_puts(m, "Device is not configured!\n");\r\nreturn 0;\r\n}\r\n}\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"total packets received", wandev->stats.rx_packets);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"total packets transmitted", wandev->stats.tx_packets);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"total bytes received", wandev->stats.rx_bytes);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"total bytes transmitted", wandev->stats.tx_bytes);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"bad packets received", wandev->stats.rx_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"packet transmit problems", wandev->stats.tx_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"received frames dropped", wandev->stats.rx_dropped);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"transmit frames dropped", wandev->stats.tx_dropped);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"multicast packets received", wandev->stats.multicast);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"transmit collisions", wandev->stats.collisions);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"receive length errors", wandev->stats.rx_length_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"receiver overrun errors", wandev->stats.rx_over_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"CRC errors", wandev->stats.rx_crc_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"frame format errors (aborts)", wandev->stats.rx_frame_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"receiver fifo overrun", wandev->stats.rx_fifo_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"receiver missed packet", wandev->stats.rx_missed_errors);\r\nseq_printf(m, PROC_STATS_FORMAT,\r\n"aborted frames transmitted", wandev->stats.tx_aborted_errors);\r\nreturn 0;\r\n}\r\nstatic int wandev_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, wandev_show, PDE(inode)->data);\r\n}\r\nint __init wanrouter_proc_init(void)\r\n{\r\nstruct proc_dir_entry *p;\r\nproc_router = proc_mkdir(ROUTER_NAME, init_net.proc_net);\r\nif (!proc_router)\r\ngoto fail;\r\np = proc_create("config", S_IRUGO, proc_router, &config_fops);\r\nif (!p)\r\ngoto fail_config;\r\np = proc_create("status", S_IRUGO, proc_router, &status_fops);\r\nif (!p)\r\ngoto fail_stat;\r\nreturn 0;\r\nfail_stat:\r\nremove_proc_entry("config", proc_router);\r\nfail_config:\r\nremove_proc_entry(ROUTER_NAME, init_net.proc_net);\r\nfail:\r\nreturn -ENOMEM;\r\n}\r\nvoid wanrouter_proc_cleanup(void)\r\n{\r\nremove_proc_entry("config", proc_router);\r\nremove_proc_entry("status", proc_router);\r\nremove_proc_entry(ROUTER_NAME, init_net.proc_net);\r\n}\r\nint wanrouter_proc_add(struct wan_device* wandev)\r\n{\r\nif (wandev->magic != ROUTER_MAGIC)\r\nreturn -EINVAL;\r\nwandev->dent = proc_create(wandev->name, S_IRUGO,\r\nproc_router, &wandev_fops);\r\nif (!wandev->dent)\r\nreturn -ENOMEM;\r\nwandev->dent->data = wandev;\r\nreturn 0;\r\n}\r\nint wanrouter_proc_delete(struct wan_device* wandev)\r\n{\r\nif (wandev->magic != ROUTER_MAGIC)\r\nreturn -EINVAL;\r\nremove_proc_entry(wandev->name, proc_router);\r\nreturn 0;\r\n}\r\nint __init wanrouter_proc_init(void)\r\n{\r\nreturn 0;\r\n}\r\nvoid wanrouter_proc_cleanup(void)\r\n{\r\n}\r\nint wanrouter_proc_add(struct wan_device *wandev)\r\n{\r\nreturn 0;\r\n}\r\nint wanrouter_proc_delete(struct wan_device *wandev)\r\n{\r\nreturn 0;\r\n}

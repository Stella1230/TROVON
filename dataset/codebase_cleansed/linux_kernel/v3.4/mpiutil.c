MPI mpi_alloc(unsigned nlimbs)\r\n{\r\nMPI a;\r\na = kmalloc(sizeof *a, GFP_KERNEL);\r\nif (!a)\r\nreturn a;\r\nif (nlimbs) {\r\na->d = mpi_alloc_limb_space(nlimbs);\r\nif (!a->d) {\r\nkfree(a);\r\nreturn NULL;\r\n}\r\n} else {\r\na->d = NULL;\r\n}\r\na->alloced = nlimbs;\r\na->nlimbs = 0;\r\na->sign = 0;\r\na->flags = 0;\r\na->nbits = 0;\r\nreturn a;\r\n}\r\nmpi_ptr_t mpi_alloc_limb_space(unsigned nlimbs)\r\n{\r\nsize_t len = nlimbs * sizeof(mpi_limb_t);\r\nif (!len)\r\nreturn NULL;\r\nreturn kmalloc(len, GFP_KERNEL);\r\n}\r\nvoid mpi_free_limb_space(mpi_ptr_t a)\r\n{\r\nif (!a)\r\nreturn;\r\nkfree(a);\r\n}\r\nvoid mpi_assign_limb_space(MPI a, mpi_ptr_t ap, unsigned nlimbs)\r\n{\r\nmpi_free_limb_space(a->d);\r\na->d = ap;\r\na->alloced = nlimbs;\r\n}\r\nint mpi_resize(MPI a, unsigned nlimbs)\r\n{\r\nvoid *p;\r\nif (nlimbs <= a->alloced)\r\nreturn 0;\r\nif (a->d) {\r\np = kmalloc(nlimbs * sizeof(mpi_limb_t), GFP_KERNEL);\r\nif (!p)\r\nreturn -ENOMEM;\r\nmemcpy(p, a->d, a->alloced * sizeof(mpi_limb_t));\r\nkfree(a->d);\r\na->d = p;\r\n} else {\r\na->d = kzalloc(nlimbs * sizeof(mpi_limb_t), GFP_KERNEL);\r\nif (!a->d)\r\nreturn -ENOMEM;\r\n}\r\na->alloced = nlimbs;\r\nreturn 0;\r\n}\r\nvoid mpi_clear(MPI a)\r\n{\r\na->nlimbs = 0;\r\na->nbits = 0;\r\na->flags = 0;\r\n}\r\nvoid mpi_free(MPI a)\r\n{\r\nif (!a)\r\nreturn;\r\nif (a->flags & 4)\r\nkfree(a->d);\r\nelse\r\nmpi_free_limb_space(a->d);\r\nif (a->flags & ~7)\r\npr_info("invalid flag value in mpi\n");\r\nkfree(a);\r\n}\r\nint mpi_copy(MPI *copied, const MPI a)\r\n{\r\nsize_t i;\r\nMPI b;\r\n*copied = NULL;\r\nif (a) {\r\nb = mpi_alloc(a->nlimbs);\r\nif (!b)\r\nreturn -ENOMEM;\r\nb->nlimbs = a->nlimbs;\r\nb->sign = a->sign;\r\nb->flags = a->flags;\r\nb->nbits = a->nbits;\r\nfor (i = 0; i < b->nlimbs; i++)\r\nb->d[i] = a->d[i];\r\n*copied = b;\r\n}\r\nreturn 0;\r\n}\r\nint mpi_set(MPI w, const MPI u)\r\n{\r\nmpi_ptr_t wp, up;\r\nmpi_size_t usize = u->nlimbs;\r\nint usign = u->sign;\r\nif (RESIZE_IF_NEEDED(w, (size_t) usize) < 0)\r\nreturn -ENOMEM;\r\nwp = w->d;\r\nup = u->d;\r\nMPN_COPY(wp, up, usize);\r\nw->nlimbs = usize;\r\nw->nbits = u->nbits;\r\nw->flags = u->flags;\r\nw->sign = usign;\r\nreturn 0;\r\n}\r\nint mpi_set_ui(MPI w, unsigned long u)\r\n{\r\nif (RESIZE_IF_NEEDED(w, 1) < 0)\r\nreturn -ENOMEM;\r\nw->d[0] = u;\r\nw->nlimbs = u ? 1 : 0;\r\nw->sign = 0;\r\nw->nbits = 0;\r\nw->flags = 0;\r\nreturn 0;\r\n}\r\nMPI mpi_alloc_set_ui(unsigned long u)\r\n{\r\nMPI w = mpi_alloc(1);\r\nif (!w)\r\nreturn w;\r\nw->d[0] = u;\r\nw->nlimbs = u ? 1 : 0;\r\nw->sign = 0;\r\nreturn w;\r\n}\r\nvoid mpi_swap(MPI a, MPI b)\r\n{\r\nstruct gcry_mpi tmp;\r\ntmp = *a;\r\n*a = *b;\r\n*b = tmp;\r\n}

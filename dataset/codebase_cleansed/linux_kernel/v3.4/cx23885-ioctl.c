int cx23885_g_chip_ident(struct file *file, void *fh,\r\nstruct v4l2_dbg_chip_ident *chip)\r\n{\r\nstruct cx23885_dev *dev = ((struct cx23885_fh *)fh)->dev;\r\nint err = 0;\r\nu8 rev;\r\nchip->ident = V4L2_IDENT_NONE;\r\nchip->revision = 0;\r\nswitch (chip->match.type) {\r\ncase V4L2_CHIP_MATCH_HOST:\r\nswitch (chip->match.addr) {\r\ncase 0:\r\nrev = cx_read(RDR_CFG2) & 0xff;\r\nswitch (dev->pci->device) {\r\ncase 0x8852:\r\nif (rev == 0x04)\r\nchip->ident = V4L2_IDENT_CX23888;\r\nelse\r\nchip->ident = V4L2_IDENT_CX23885;\r\nbreak;\r\ncase 0x8880:\r\nif (rev == 0x0e || rev == 0x0f)\r\nchip->ident = V4L2_IDENT_CX23887;\r\nelse\r\nchip->ident = V4L2_IDENT_CX23888;\r\nbreak;\r\ndefault:\r\nchip->ident = V4L2_IDENT_UNKNOWN;\r\nbreak;\r\n}\r\nchip->revision = (dev->pci->device << 16) | (rev << 8) |\r\n(dev->hwrevision & 0xff);\r\nbreak;\r\ncase 1:\r\nif (dev->v4l_device != NULL) {\r\nchip->ident = V4L2_IDENT_CX23417;\r\nchip->revision = 0;\r\n}\r\nbreak;\r\ncase 2:\r\ncall_hw(dev, CX23885_HW_888_IR, core, g_chip_ident,\r\nchip);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nbreak;\r\ncase V4L2_CHIP_MATCH_I2C_DRIVER:\r\ncall_all(dev, core, g_chip_ident, chip);\r\nbreak;\r\ncase V4L2_CHIP_MATCH_I2C_ADDR:\r\ncall_all(dev, core, g_chip_ident, chip);\r\nbreak;\r\ndefault:\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int cx23885_g_host_register(struct cx23885_dev *dev,\r\nstruct v4l2_dbg_register *reg)\r\n{\r\nif ((reg->reg & 0x3) != 0 || reg->reg >= pci_resource_len(dev->pci, 0))\r\nreturn -EINVAL;\r\nreg->size = 4;\r\nreg->val = cx_read(reg->reg);\r\nreturn 0;\r\n}\r\nstatic int cx23417_g_register(struct cx23885_dev *dev,\r\nstruct v4l2_dbg_register *reg)\r\n{\r\nu32 value;\r\nif (dev->v4l_device == NULL)\r\nreturn -EINVAL;\r\nif ((reg->reg & 0x3) != 0 || reg->reg >= 0x10000)\r\nreturn -EINVAL;\r\nif (mc417_register_read(dev, (u16) reg->reg, &value))\r\nreturn -EINVAL;\r\nreg->size = 4;\r\nreg->val = value;\r\nreturn 0;\r\n}\r\nint cx23885_g_register(struct file *file, void *fh,\r\nstruct v4l2_dbg_register *reg)\r\n{\r\nstruct cx23885_dev *dev = ((struct cx23885_fh *)fh)->dev;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nif (reg->match.type == V4L2_CHIP_MATCH_HOST) {\r\nswitch (reg->match.addr) {\r\ncase 0:\r\nreturn cx23885_g_host_register(dev, reg);\r\ncase 1:\r\nreturn cx23417_g_register(dev, reg);\r\ndefault:\r\nbreak;\r\n}\r\n}\r\ncall_all(dev, core, g_register, reg);\r\nreturn 0;\r\n}\r\nstatic int cx23885_s_host_register(struct cx23885_dev *dev,\r\nstruct v4l2_dbg_register *reg)\r\n{\r\nif ((reg->reg & 0x3) != 0 || reg->reg >= pci_resource_len(dev->pci, 0))\r\nreturn -EINVAL;\r\nreg->size = 4;\r\ncx_write(reg->reg, reg->val);\r\nreturn 0;\r\n}\r\nstatic int cx23417_s_register(struct cx23885_dev *dev,\r\nstruct v4l2_dbg_register *reg)\r\n{\r\nif (dev->v4l_device == NULL)\r\nreturn -EINVAL;\r\nif ((reg->reg & 0x3) != 0 || reg->reg >= 0x10000)\r\nreturn -EINVAL;\r\nif (mc417_register_write(dev, (u16) reg->reg, (u32) reg->val))\r\nreturn -EINVAL;\r\nreg->size = 4;\r\nreturn 0;\r\n}\r\nint cx23885_s_register(struct file *file, void *fh,\r\nstruct v4l2_dbg_register *reg)\r\n{\r\nstruct cx23885_dev *dev = ((struct cx23885_fh *)fh)->dev;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nif (reg->match.type == V4L2_CHIP_MATCH_HOST) {\r\nswitch (reg->match.addr) {\r\ncase 0:\r\nreturn cx23885_s_host_register(dev, reg);\r\ncase 1:\r\nreturn cx23417_s_register(dev, reg);\r\ndefault:\r\nbreak;\r\n}\r\n}\r\ncall_all(dev, core, s_register, reg);\r\nreturn 0;\r\n}

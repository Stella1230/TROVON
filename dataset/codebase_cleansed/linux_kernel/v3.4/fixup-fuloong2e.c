int __init pcibios_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\nint irq = 0;\r\nif (slot == sb_slot) {\r\nswitch (PCI_FUNC(dev->devfn)) {\r\ncase 2:\r\nirq = 10;\r\nbreak;\r\ncase 3:\r\nirq = 11;\r\nbreak;\r\ncase 5:\r\nirq = 9;\r\nbreak;\r\n}\r\n} else {\r\nirq = LOONGSON_IRQ_BASE + 25 + pin;\r\n}\r\nreturn irq;\r\n}\r\nint pcibios_plat_dev_init(struct pci_dev *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __init loongson2e_nec_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned int val;\r\npci_read_config_dword(pdev, 0xe0, &val);\r\npci_write_config_dword(pdev, 0xe0, (val & ~7) | 0x4);\r\npci_write_config_dword(pdev, 0xe4, 1 << 5);\r\n}\r\nstatic void __init loongson2e_686b_func0_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned char c;\r\nsb_slot = PCI_SLOT(pdev->devfn);\r\nprintk(KERN_INFO "via686b fix: ISA bridge\n");\r\npci_write_config_byte(pdev, 0x40, 0x08);\r\npci_write_config_byte(pdev, 0x41, 0x01);\r\npci_write_config_byte(pdev, 0x45, 0x00);\r\npci_write_config_byte(pdev, 0x46, 0xe0);\r\npci_write_config_byte(pdev, 0x47, 0xe6);\r\noutb(0x2e, 0x4d1);\r\npci_write_config_byte(pdev, 0x48, 0x01);\r\npci_write_config_byte(pdev, 0x4a, 0x84);\r\npci_write_config_byte(pdev, 0x50, 0x0e);\r\npci_write_config_byte(pdev, 0x51, 0x76);\r\npci_write_config_byte(pdev, 0x52, 0x34);\r\npci_write_config_byte(pdev, 0x54, 0x00);\r\npci_write_config_byte(pdev, 0x55, 0x90);\r\npci_write_config_byte(pdev, 0x56, 0xba);\r\npci_write_config_byte(pdev, 0x57, 0xd0);\r\npci_read_config_byte(pdev, 0x85, &c);\r\nc &= ~(0x3 << 2);\r\npci_write_config_byte(pdev, 0x85, c);\r\nprintk(KERN_INFO"via686b fix: ISA bridge done\n");\r\n}\r\nstatic void __init loongson2e_686b_func1_fixup(struct pci_dev *pdev)\r\n{\r\nprintk(KERN_INFO"via686b fix: IDE\n");\r\npci_write_config_byte(pdev, PCI_LATENCY_TIMER, 48);\r\npci_write_config_byte(pdev, PCI_COMMAND,\r\nPCI_COMMAND_IO | PCI_COMMAND_MEMORY |\r\nPCI_COMMAND_MASTER);\r\npci_write_config_byte(pdev, 0x40, 0x0b);\r\npci_write_config_byte(pdev, 0x42, 0x09);\r\n#if 1\r\npci_write_config_byte(pdev, 0x41, 0x02);\r\npci_write_config_byte(pdev, 0x43, 0x0a);\r\npci_write_config_byte(pdev, 0x44, 0x00);\r\npci_write_config_byte(pdev, 0x45, 0x00);\r\n#else\r\npci_write_config_byte(pdev, 0x41, 0xc2);\r\npci_write_config_byte(pdev, 0x43, 0x35);\r\npci_write_config_byte(pdev, 0x44, 0x1c);\r\npci_write_config_byte(pdev, 0x45, 0x10);\r\n#endif\r\nprintk(KERN_INFO"via686b fix: IDE done\n");\r\n}\r\nstatic void __init loongson2e_686b_func2_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_byte(pdev, PCI_INTERRUPT_LINE, 10);\r\n}\r\nstatic void __init loongson2e_686b_func3_fixup(struct pci_dev *pdev)\r\n{\r\npci_write_config_byte(pdev, PCI_INTERRUPT_LINE, 11);\r\n}\r\nstatic void __init loongson2e_686b_func5_fixup(struct pci_dev *pdev)\r\n{\r\nunsigned int val;\r\nunsigned char c;\r\npci_write_config_byte(pdev, PCI_COMMAND,\r\nPCI_COMMAND_IO | PCI_COMMAND_MEMORY |\r\nPCI_COMMAND_MASTER);\r\npci_read_config_dword(pdev, 0x4, &val);\r\npci_write_config_dword(pdev, 0x4, val | 1);\r\npci_write_config_byte(pdev, 0x3c, 9);\r\npci_read_config_byte(pdev, 0x8, &c);\r\npci_write_config_byte(pdev, 0x41, 0xcc);\r\npci_write_config_byte(pdev, 0x42, 0x20);\r\npci_write_config_word(pdev, 0x2c, 0x1005);\r\npci_write_config_word(pdev, 0x2e, 0x4710);\r\npci_read_config_dword(pdev, 0x2c, &val);\r\npci_write_config_byte(pdev, 0x42, 0x0);\r\n}

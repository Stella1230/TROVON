u32 omap_prcm_get_reset_sources(void)\r\n{\r\nif (cpu_is_omap24xx() || cpu_is_omap34xx())\r\nreturn omap2_prm_read_mod_reg(WKUP_MOD, OMAP2_RM_RSTST) & 0x7f;\r\nif (cpu_is_omap44xx())\r\nreturn omap2_prm_read_mod_reg(WKUP_MOD, OMAP4_RM_RSTST) & 0x7f;\r\nreturn 0;\r\n}\r\nvoid omap_prcm_restart(char mode, const char *cmd)\r\n{\r\ns16 prcm_offs = 0;\r\nif (cpu_is_omap24xx()) {\r\nomap2xxx_clk_prepare_for_reboot();\r\nprcm_offs = WKUP_MOD;\r\n} else if (cpu_is_omap34xx()) {\r\nprcm_offs = OMAP3430_GR_MOD;\r\nomap3_ctrl_write_boot_mode((cmd ? (u8)*cmd : 0));\r\n} else if (cpu_is_omap44xx()) {\r\nomap4_prminst_global_warm_sw_reset();\r\n} else {\r\nWARN_ON(1);\r\n}\r\nomap2_prm_set_mod_reg_bits(OMAP_RST_DPLL3_MASK, prcm_offs,\r\nOMAP2_RM_RSTCTRL);\r\nomap2_prm_read_mod_reg(prcm_offs, OMAP2_RM_RSTCTRL);\r\n}\r\nint omap2_cm_wait_idlest(void __iomem *reg, u32 mask, u8 idlest,\r\nconst char *name)\r\n{\r\nint i = 0;\r\nint ena = 0;\r\nif (idlest)\r\nena = 0;\r\nelse\r\nena = mask;\r\nomap_test_timeout(((__raw_readl(reg) & mask) == ena),\r\nMAX_MODULE_ENABLE_WAIT, i);\r\nif (i < MAX_MODULE_ENABLE_WAIT)\r\npr_debug("cm: Module associated with clock %s ready after %d "\r\n"loops\n", name, i);\r\nelse\r\npr_err("cm: Module associated with clock %s didn't enable in "\r\n"%d tries\n", name, MAX_MODULE_ENABLE_WAIT);\r\nreturn (i < MAX_MODULE_ENABLE_WAIT) ? 1 : 0;\r\n}\r\nvoid __init omap2_set_globals_prcm(struct omap_globals *omap2_globals)\r\n{\r\nif (omap2_globals->prm)\r\nprm_base = omap2_globals->prm;\r\nif (omap2_globals->cm)\r\ncm_base = omap2_globals->cm;\r\nif (omap2_globals->cm2)\r\ncm2_base = omap2_globals->cm2;\r\n}

void snd_gf1_delay(struct snd_gus_card * gus)\r\n{\r\nint i;\r\nfor (i = 0; i < 6; i++) {\r\nmb();\r\ninb(GUSP(gus, DRAM));\r\n}\r\n}\r\nstatic inline void __snd_gf1_ctrl_stop(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\nunsigned char value;\r\noutb(reg | 0x80, gus->gf1.reg_regsel);\r\nmb();\r\nvalue = inb(gus->gf1.reg_data8);\r\nmb();\r\noutb(reg, gus->gf1.reg_regsel);\r\nmb();\r\noutb((value | 0x03) & ~(0x80 | 0x20), gus->gf1.reg_data8);\r\nmb();\r\n}\r\nstatic inline void __snd_gf1_write8(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nunsigned char data)\r\n{\r\noutb(reg, gus->gf1.reg_regsel);\r\nmb();\r\noutb(data, gus->gf1.reg_data8);\r\nmb();\r\n}\r\nstatic inline unsigned char __snd_gf1_look8(struct snd_gus_card * gus,\r\nunsigned char reg)\r\n{\r\noutb(reg, gus->gf1.reg_regsel);\r\nmb();\r\nreturn inb(gus->gf1.reg_data8);\r\n}\r\nstatic inline void __snd_gf1_write16(struct snd_gus_card * gus,\r\nunsigned char reg, unsigned int data)\r\n{\r\noutb(reg, gus->gf1.reg_regsel);\r\nmb();\r\noutw((unsigned short) data, gus->gf1.reg_data16);\r\nmb();\r\n}\r\nstatic inline unsigned short __snd_gf1_look16(struct snd_gus_card * gus,\r\nunsigned char reg)\r\n{\r\noutb(reg, gus->gf1.reg_regsel);\r\nmb();\r\nreturn inw(gus->gf1.reg_data16);\r\n}\r\nstatic inline void __snd_gf1_adlib_write(struct snd_gus_card * gus,\r\nunsigned char reg, unsigned char data)\r\n{\r\noutb(reg, gus->gf1.reg_timerctrl);\r\ninb(gus->gf1.reg_timerctrl);\r\ninb(gus->gf1.reg_timerctrl);\r\noutb(data, gus->gf1.reg_timerdata);\r\ninb(gus->gf1.reg_timerctrl);\r\ninb(gus->gf1.reg_timerctrl);\r\n}\r\nstatic inline void __snd_gf1_write_addr(struct snd_gus_card * gus, unsigned char reg,\r\nunsigned int addr, int w_16bit)\r\n{\r\nif (gus->gf1.enh_mode) {\r\nif (w_16bit)\r\naddr = ((addr >> 1) & ~0x0000000f) | (addr & 0x0000000f);\r\n__snd_gf1_write8(gus, SNDRV_GF1_VB_UPPER_ADDRESS, (unsigned char) ((addr >> 26) & 0x03));\r\n} else if (w_16bit)\r\naddr = (addr & 0x00c0000f) | ((addr & 0x003ffff0) >> 1);\r\n__snd_gf1_write16(gus, reg, (unsigned short) (addr >> 11));\r\n__snd_gf1_write16(gus, reg + 1, (unsigned short) (addr << 5));\r\n}\r\nstatic inline unsigned int __snd_gf1_read_addr(struct snd_gus_card * gus,\r\nunsigned char reg, short w_16bit)\r\n{\r\nunsigned int res;\r\nres = ((unsigned int) __snd_gf1_look16(gus, reg | 0x80) << 11) & 0xfff800;\r\nres |= ((unsigned int) __snd_gf1_look16(gus, (reg + 1) | 0x80) >> 5) & 0x0007ff;\r\nif (gus->gf1.enh_mode) {\r\nres |= (unsigned int) __snd_gf1_look8(gus, SNDRV_GF1_VB_UPPER_ADDRESS | 0x80) << 26;\r\nif (w_16bit)\r\nres = ((res << 1) & 0xffffffe0) | (res & 0x0000000f);\r\n} else if (w_16bit)\r\nres = ((res & 0x001ffff0) << 1) | (res & 0x00c0000f);\r\nreturn res;\r\n}\r\nvoid snd_gf1_ctrl_stop(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\n__snd_gf1_ctrl_stop(gus, reg);\r\n}\r\nvoid snd_gf1_write8(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nunsigned char data)\r\n{\r\n__snd_gf1_write8(gus, reg, data);\r\n}\r\nunsigned char snd_gf1_look8(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\nreturn __snd_gf1_look8(gus, reg);\r\n}\r\nvoid snd_gf1_write16(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nunsigned int data)\r\n{\r\n__snd_gf1_write16(gus, reg, data);\r\n}\r\nunsigned short snd_gf1_look16(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\nreturn __snd_gf1_look16(gus, reg);\r\n}\r\nvoid snd_gf1_adlib_write(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nunsigned char data)\r\n{\r\n__snd_gf1_adlib_write(gus, reg, data);\r\n}\r\nvoid snd_gf1_write_addr(struct snd_gus_card * gus, unsigned char reg,\r\nunsigned int addr, short w_16bit)\r\n{\r\n__snd_gf1_write_addr(gus, reg, addr, w_16bit);\r\n}\r\nunsigned int snd_gf1_read_addr(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nshort w_16bit)\r\n{\r\nreturn __snd_gf1_read_addr(gus, reg, w_16bit);\r\n}\r\nvoid snd_gf1_i_ctrl_stop(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\n__snd_gf1_ctrl_stop(gus, reg);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nvoid snd_gf1_i_write8(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nunsigned char data)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\n__snd_gf1_write8(gus, reg, data);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nunsigned char snd_gf1_i_look8(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\nunsigned long flags;\r\nunsigned char res;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nres = __snd_gf1_look8(gus, reg);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn res;\r\n}\r\nvoid snd_gf1_i_write16(struct snd_gus_card * gus,\r\nunsigned char reg,\r\nunsigned int data)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\n__snd_gf1_write16(gus, reg, data);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nunsigned short snd_gf1_i_look16(struct snd_gus_card * gus, unsigned char reg)\r\n{\r\nunsigned long flags;\r\nunsigned short res;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nres = __snd_gf1_look16(gus, reg);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn res;\r\n}\r\nstatic unsigned int snd_gf1_i_read_addr(struct snd_gus_card * gus,\r\nunsigned char reg, short w_16bit)\r\n{\r\nunsigned int res;\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\nres = __snd_gf1_read_addr(gus, reg, w_16bit);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn res;\r\n}\r\nvoid snd_gf1_dram_addr(struct snd_gus_card * gus, unsigned int addr)\r\n{\r\noutb(0x43, gus->gf1.reg_regsel);\r\nmb();\r\noutw((unsigned short) addr, gus->gf1.reg_data16);\r\nmb();\r\noutb(0x44, gus->gf1.reg_regsel);\r\nmb();\r\noutb((unsigned char) (addr >> 16), gus->gf1.reg_data8);\r\nmb();\r\n}\r\nvoid snd_gf1_poke(struct snd_gus_card * gus, unsigned int addr, unsigned char data)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\noutb(SNDRV_GF1_GW_DRAM_IO_LOW, gus->gf1.reg_regsel);\r\nmb();\r\noutw((unsigned short) addr, gus->gf1.reg_data16);\r\nmb();\r\noutb(SNDRV_GF1_GB_DRAM_IO_HIGH, gus->gf1.reg_regsel);\r\nmb();\r\noutb((unsigned char) (addr >> 16), gus->gf1.reg_data8);\r\nmb();\r\noutb(data, gus->gf1.reg_dram);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\n}\r\nunsigned char snd_gf1_peek(struct snd_gus_card * gus, unsigned int addr)\r\n{\r\nunsigned long flags;\r\nunsigned char res;\r\nspin_lock_irqsave(&gus->reg_lock, flags);\r\noutb(SNDRV_GF1_GW_DRAM_IO_LOW, gus->gf1.reg_regsel);\r\nmb();\r\noutw((unsigned short) addr, gus->gf1.reg_data16);\r\nmb();\r\noutb(SNDRV_GF1_GB_DRAM_IO_HIGH, gus->gf1.reg_regsel);\r\nmb();\r\noutb((unsigned char) (addr >> 16), gus->gf1.reg_data8);\r\nmb();\r\nres = inb(gus->gf1.reg_dram);\r\nspin_unlock_irqrestore(&gus->reg_lock, flags);\r\nreturn res;\r\n}\r\nvoid snd_gf1_select_active_voices(struct snd_gus_card * gus)\r\n{\r\nunsigned short voices;\r\nstatic unsigned short voices_tbl[32 - 14 + 1] =\r\n{\r\n44100, 41160, 38587, 36317, 34300, 32494, 30870, 29400, 28063, 26843,\r\n25725, 24696, 23746, 22866, 22050, 21289, 20580, 19916, 19293\r\n};\r\nvoices = gus->gf1.active_voices;\r\nif (voices > 32)\r\nvoices = 32;\r\nif (voices < 14)\r\nvoices = 14;\r\nif (gus->gf1.enh_mode)\r\nvoices = 32;\r\ngus->gf1.active_voices = voices;\r\ngus->gf1.playback_freq =\r\ngus->gf1.enh_mode ? 44100 : voices_tbl[voices - 14];\r\nif (!gus->gf1.enh_mode) {\r\nsnd_gf1_i_write8(gus, SNDRV_GF1_GB_ACTIVE_VOICES, 0xc0 | (voices - 1));\r\nudelay(100);\r\n}\r\n}\r\nvoid snd_gf1_print_voice_registers(struct snd_gus_card * gus)\r\n{\r\nunsigned char mode;\r\nint voice, ctrl;\r\nvoice = gus->gf1.active_voice;\r\nprintk(KERN_INFO " -%i- GF1 voice ctrl, ramp ctrl = 0x%x, 0x%x\n", voice, ctrl = snd_gf1_i_read8(gus, 0), snd_gf1_i_read8(gus, 0x0d));\r\nprintk(KERN_INFO " -%i- GF1 frequency = 0x%x\n", voice, snd_gf1_i_read16(gus, 1));\r\nprintk(KERN_INFO " -%i- GF1 loop start, end = 0x%x (0x%x), 0x%x (0x%x)\n", voice, snd_gf1_i_read_addr(gus, 2, ctrl & 4), snd_gf1_i_read_addr(gus, 2, (ctrl & 4) ^ 4), snd_gf1_i_read_addr(gus, 4, ctrl & 4), snd_gf1_i_read_addr(gus, 4, (ctrl & 4) ^ 4));\r\nprintk(KERN_INFO " -%i- GF1 ramp start, end, rate = 0x%x, 0x%x, 0x%x\n", voice, snd_gf1_i_read8(gus, 7), snd_gf1_i_read8(gus, 8), snd_gf1_i_read8(gus, 6));\r\nprintk(KERN_INFO" -%i- GF1 volume = 0x%x\n", voice, snd_gf1_i_read16(gus, 9));\r\nprintk(KERN_INFO " -%i- GF1 position = 0x%x (0x%x)\n", voice, snd_gf1_i_read_addr(gus, 0x0a, ctrl & 4), snd_gf1_i_read_addr(gus, 0x0a, (ctrl & 4) ^ 4));\r\nif (gus->interwave && snd_gf1_i_read8(gus, 0x19) & 0x01) {\r\nmode = snd_gf1_i_read8(gus, 0x15);\r\nprintk(KERN_INFO " -%i- GFA1 mode = 0x%x\n", voice, mode);\r\nif (mode & 0x01) {\r\nprintk(KERN_INFO " -%i- GFA1 effect address = 0x%x\n", voice, snd_gf1_i_read_addr(gus, 0x11, ctrl & 4));\r\nprintk(KERN_INFO " -%i- GFA1 effect volume = 0x%x\n", voice, snd_gf1_i_read16(gus, 0x16));\r\nprintk(KERN_INFO " -%i- GFA1 effect volume final = 0x%x\n", voice, snd_gf1_i_read16(gus, 0x1d));\r\nprintk(KERN_INFO " -%i- GFA1 effect acumulator = 0x%x\n", voice, snd_gf1_i_read8(gus, 0x14));\r\n}\r\nif (mode & 0x20) {\r\nprintk(KERN_INFO " -%i- GFA1 left offset = 0x%x (%i)\n", voice, snd_gf1_i_read16(gus, 0x13), snd_gf1_i_read16(gus, 0x13) >> 4);\r\nprintk(KERN_INFO " -%i- GFA1 left offset final = 0x%x (%i)\n", voice, snd_gf1_i_read16(gus, 0x1c), snd_gf1_i_read16(gus, 0x1c) >> 4);\r\nprintk(KERN_INFO " -%i- GFA1 right offset = 0x%x (%i)\n", voice, snd_gf1_i_read16(gus, 0x0c), snd_gf1_i_read16(gus, 0x0c) >> 4);\r\nprintk(KERN_INFO " -%i- GFA1 right offset final = 0x%x (%i)\n", voice, snd_gf1_i_read16(gus, 0x1b), snd_gf1_i_read16(gus, 0x1b) >> 4);\r\n} else\r\nprintk(KERN_INFO " -%i- GF1 pan = 0x%x\n", voice, snd_gf1_i_read8(gus, 0x0c));\r\n} else\r\nprintk(KERN_INFO " -%i- GF1 pan = 0x%x\n", voice, snd_gf1_i_read8(gus, 0x0c));\r\n}

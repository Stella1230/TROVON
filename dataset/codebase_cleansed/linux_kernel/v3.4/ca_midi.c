static void ca_midi_clear_rx(struct snd_ca_midi *midi)\r\n{\r\nint timeout = 100000;\r\nfor (; timeout > 0 && ca_midi_input_avail(midi); timeout--)\r\nca_midi_read_data(midi);\r\n#ifdef CONFIG_SND_DEBUG\r\nif (timeout <= 0)\r\nsnd_printk(KERN_ERR "ca_midi_clear_rx: timeout (status = 0x%x)\n",\r\nca_midi_read_stat(midi));\r\n#endif\r\n}\r\nstatic void ca_midi_interrupt(struct snd_ca_midi *midi, unsigned int status)\r\n{\r\nunsigned char byte;\r\nif (midi->rmidi == NULL) {\r\nmidi->interrupt_disable(midi,midi->tx_enable | midi->rx_enable);\r\nreturn;\r\n}\r\nspin_lock(&midi->input_lock);\r\nif ((status & midi->ipr_rx) && ca_midi_input_avail(midi)) {\r\nif (!(midi->midi_mode & CA_MIDI_MODE_INPUT)) {\r\nca_midi_clear_rx(midi);\r\n} else {\r\nbyte = ca_midi_read_data(midi);\r\nif(midi->substream_input)\r\nsnd_rawmidi_receive(midi->substream_input, &byte, 1);\r\n}\r\n}\r\nspin_unlock(&midi->input_lock);\r\nspin_lock(&midi->output_lock);\r\nif ((status & midi->ipr_tx) && ca_midi_output_ready(midi)) {\r\nif (midi->substream_output &&\r\nsnd_rawmidi_transmit(midi->substream_output, &byte, 1) == 1) {\r\nca_midi_write_data(midi, byte);\r\n} else {\r\nmidi->interrupt_disable(midi,midi->tx_enable);\r\n}\r\n}\r\nspin_unlock(&midi->output_lock);\r\n}\r\nstatic void ca_midi_cmd(struct snd_ca_midi *midi, unsigned char cmd, int ack)\r\n{\r\nunsigned long flags;\r\nint timeout, ok;\r\nspin_lock_irqsave(&midi->input_lock, flags);\r\nca_midi_write_data(midi, 0x00);\r\nca_midi_write_cmd(midi, cmd);\r\nif (ack) {\r\nok = 0;\r\ntimeout = 10000;\r\nwhile (!ok && timeout-- > 0) {\r\nif (ca_midi_input_avail(midi)) {\r\nif (ca_midi_read_data(midi) == midi->ack)\r\nok = 1;\r\n}\r\n}\r\nif (!ok && ca_midi_read_data(midi) == midi->ack)\r\nok = 1;\r\n} else {\r\nok = 1;\r\n}\r\nspin_unlock_irqrestore(&midi->input_lock, flags);\r\nif (!ok)\r\nsnd_printk(KERN_ERR "ca_midi_cmd: 0x%x failed at 0x%x (status = 0x%x, data = 0x%x)!!!\n",\r\ncmd,\r\nmidi->get_dev_id_port(midi->dev_id),\r\nca_midi_read_stat(midi),\r\nca_midi_read_data(midi));\r\n}\r\nstatic int ca_midi_input_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_ca_midi *midi = substream->rmidi->private_data;\r\nunsigned long flags;\r\nif (snd_BUG_ON(!midi->dev_id))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nmidi->midi_mode |= CA_MIDI_MODE_INPUT;\r\nmidi->substream_input = substream;\r\nif (!(midi->midi_mode & CA_MIDI_MODE_OUTPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nca_midi_cmd(midi, midi->reset, 1);\r\nca_midi_cmd(midi, midi->enter_uart, 1);\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ca_midi_output_open(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_ca_midi *midi = substream->rmidi->private_data;\r\nunsigned long flags;\r\nif (snd_BUG_ON(!midi->dev_id))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nmidi->midi_mode |= CA_MIDI_MODE_OUTPUT;\r\nmidi->substream_output = substream;\r\nif (!(midi->midi_mode & CA_MIDI_MODE_INPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nca_midi_cmd(midi, midi->reset, 1);\r\nca_midi_cmd(midi, midi->enter_uart, 1);\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ca_midi_input_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_ca_midi *midi = substream->rmidi->private_data;\r\nunsigned long flags;\r\nif (snd_BUG_ON(!midi->dev_id))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nmidi->interrupt_disable(midi,midi->rx_enable);\r\nmidi->midi_mode &= ~CA_MIDI_MODE_INPUT;\r\nmidi->substream_input = NULL;\r\nif (!(midi->midi_mode & CA_MIDI_MODE_OUTPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nca_midi_cmd(midi, midi->reset, 0);\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ca_midi_output_close(struct snd_rawmidi_substream *substream)\r\n{\r\nstruct snd_ca_midi *midi = substream->rmidi->private_data;\r\nunsigned long flags;\r\nif (snd_BUG_ON(!midi->dev_id))\r\nreturn -ENXIO;\r\nspin_lock_irqsave(&midi->open_lock, flags);\r\nmidi->interrupt_disable(midi,midi->tx_enable);\r\nmidi->midi_mode &= ~CA_MIDI_MODE_OUTPUT;\r\nmidi->substream_output = NULL;\r\nif (!(midi->midi_mode & CA_MIDI_MODE_INPUT)) {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\nca_midi_cmd(midi, midi->reset, 0);\r\n} else {\r\nspin_unlock_irqrestore(&midi->open_lock, flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ca_midi_input_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_ca_midi *midi = substream->rmidi->private_data;\r\nif (snd_BUG_ON(!midi->dev_id))\r\nreturn;\r\nif (up) {\r\nmidi->interrupt_enable(midi,midi->rx_enable);\r\n} else {\r\nmidi->interrupt_disable(midi, midi->rx_enable);\r\n}\r\n}\r\nstatic void ca_midi_output_trigger(struct snd_rawmidi_substream *substream, int up)\r\n{\r\nstruct snd_ca_midi *midi = substream->rmidi->private_data;\r\nunsigned long flags;\r\nif (snd_BUG_ON(!midi->dev_id))\r\nreturn;\r\nif (up) {\r\nint max = 4;\r\nunsigned char byte;\r\nspin_lock_irqsave(&midi->output_lock, flags);\r\nwhile (max > 0) {\r\nif (ca_midi_output_ready(midi)) {\r\nif (!(midi->midi_mode & CA_MIDI_MODE_OUTPUT) ||\r\nsnd_rawmidi_transmit(substream, &byte, 1) != 1) {\r\nspin_unlock_irqrestore(&midi->output_lock, flags);\r\nreturn;\r\n}\r\nca_midi_write_data(midi, byte);\r\nmax--;\r\n} else {\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&midi->output_lock, flags);\r\nmidi->interrupt_enable(midi,midi->tx_enable);\r\n} else {\r\nmidi->interrupt_disable(midi,midi->tx_enable);\r\n}\r\n}\r\nstatic void ca_midi_free(struct snd_ca_midi *midi)\r\n{\r\nmidi->interrupt = NULL;\r\nmidi->interrupt_enable = NULL;\r\nmidi->interrupt_disable = NULL;\r\nmidi->read = NULL;\r\nmidi->write = NULL;\r\nmidi->get_dev_id_card = NULL;\r\nmidi->get_dev_id_port = NULL;\r\nmidi->rmidi = NULL;\r\n}\r\nstatic void ca_rmidi_free(struct snd_rawmidi *rmidi)\r\n{\r\nca_midi_free(rmidi->private_data);\r\n}\r\nint __devinit ca_midi_init(void *dev_id, struct snd_ca_midi *midi, int device, char *name)\r\n{\r\nstruct snd_rawmidi *rmidi;\r\nint err;\r\nif ((err = snd_rawmidi_new(midi->get_dev_id_card(midi->dev_id), name, device, 1, 1, &rmidi)) < 0)\r\nreturn err;\r\nmidi->dev_id = dev_id;\r\nmidi->interrupt = ca_midi_interrupt;\r\nspin_lock_init(&midi->open_lock);\r\nspin_lock_init(&midi->input_lock);\r\nspin_lock_init(&midi->output_lock);\r\nstrcpy(rmidi->name, name);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_OUTPUT, &ca_midi_output);\r\nsnd_rawmidi_set_ops(rmidi, SNDRV_RAWMIDI_STREAM_INPUT, &ca_midi_input);\r\nrmidi->info_flags |= SNDRV_RAWMIDI_INFO_OUTPUT |\r\nSNDRV_RAWMIDI_INFO_INPUT |\r\nSNDRV_RAWMIDI_INFO_DUPLEX;\r\nrmidi->private_data = midi;\r\nrmidi->private_free = ca_rmidi_free;\r\nmidi->rmidi = rmidi;\r\nreturn 0;\r\n}

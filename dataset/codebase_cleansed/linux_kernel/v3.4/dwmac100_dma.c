static int dwmac100_dma_init(void __iomem *ioaddr, int pbl, u32 dma_tx,\r\nu32 dma_rx)\r\n{\r\nu32 value = readl(ioaddr + DMA_BUS_MODE);\r\nint limit;\r\nvalue |= DMA_BUS_MODE_SFT_RESET;\r\nwritel(value, ioaddr + DMA_BUS_MODE);\r\nlimit = 10;\r\nwhile (limit--) {\r\nif (!(readl(ioaddr + DMA_BUS_MODE) & DMA_BUS_MODE_SFT_RESET))\r\nbreak;\r\nmdelay(10);\r\n}\r\nif (limit < 0)\r\nreturn -EBUSY;\r\nwritel(DMA_BUS_MODE_DEFAULT | (pbl << DMA_BUS_MODE_PBL_SHIFT),\r\nioaddr + DMA_BUS_MODE);\r\nwritel(DMA_INTR_DEFAULT_MASK, ioaddr + DMA_INTR_ENA);\r\nwritel(dma_tx, ioaddr + DMA_TX_BASE_ADDR);\r\nwritel(dma_rx, ioaddr + DMA_RCV_BASE_ADDR);\r\nreturn 0;\r\n}\r\nstatic void dwmac100_dma_operation_mode(void __iomem *ioaddr, int txmode,\r\nint rxmode)\r\n{\r\nu32 csr6 = readl(ioaddr + DMA_CONTROL);\r\nif (txmode <= 32)\r\ncsr6 |= DMA_CONTROL_TTC_32;\r\nelse if (txmode <= 64)\r\ncsr6 |= DMA_CONTROL_TTC_64;\r\nelse\r\ncsr6 |= DMA_CONTROL_TTC_128;\r\nwritel(csr6, ioaddr + DMA_CONTROL);\r\n}\r\nstatic void dwmac100_dump_dma_regs(void __iomem *ioaddr)\r\n{\r\nint i;\r\nCHIP_DBG(KERN_DEBUG "DWMAC 100 DMA CSR\n");\r\nfor (i = 0; i < 9; i++)\r\npr_debug("\t CSR%d (offset 0x%x): 0x%08x\n", i,\r\n(DMA_BUS_MODE + i * 4),\r\nreadl(ioaddr + DMA_BUS_MODE + i * 4));\r\nCHIP_DBG(KERN_DEBUG "\t CSR20 (offset 0x%x): 0x%08x\n",\r\nDMA_CUR_TX_BUF_ADDR, readl(ioaddr + DMA_CUR_TX_BUF_ADDR));\r\nCHIP_DBG(KERN_DEBUG "\t CSR21 (offset 0x%x): 0x%08x\n",\r\nDMA_CUR_RX_BUF_ADDR, readl(ioaddr + DMA_CUR_RX_BUF_ADDR));\r\n}\r\nstatic void dwmac100_dma_diagnostic_fr(void *data, struct stmmac_extra_stats *x,\r\nvoid __iomem *ioaddr)\r\n{\r\nstruct net_device_stats *stats = (struct net_device_stats *)data;\r\nu32 csr8 = readl(ioaddr + DMA_MISSED_FRAME_CTR);\r\nif (unlikely(csr8)) {\r\nif (csr8 & DMA_MISSED_FRAME_OVE) {\r\nstats->rx_over_errors += 0x800;\r\nx->rx_overflow_cntr += 0x800;\r\n} else {\r\nunsigned int ove_cntr;\r\nove_cntr = ((csr8 & DMA_MISSED_FRAME_OVE_CNTR) >> 17);\r\nstats->rx_over_errors += ove_cntr;\r\nx->rx_overflow_cntr += ove_cntr;\r\n}\r\nif (csr8 & DMA_MISSED_FRAME_OVE_M) {\r\nstats->rx_missed_errors += 0xffff;\r\nx->rx_missed_cntr += 0xffff;\r\n} else {\r\nunsigned int miss_f = (csr8 & DMA_MISSED_FRAME_M_CNTR);\r\nstats->rx_missed_errors += miss_f;\r\nx->rx_missed_cntr += miss_f;\r\n}\r\n}\r\n}

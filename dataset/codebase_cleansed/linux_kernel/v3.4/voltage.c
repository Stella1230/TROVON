unsigned long voltdm_get_voltage(struct voltagedomain *voltdm)\r\n{\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn 0;\r\n}\r\nreturn voltdm->nominal_volt;\r\n}\r\nint voltdm_scale(struct voltagedomain *voltdm,\r\nunsigned long target_volt)\r\n{\r\nint ret;\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nif (!voltdm->scale) {\r\npr_err("%s: No voltage scale API registered for vdd_%s\n",\r\n__func__, voltdm->name);\r\nreturn -ENODATA;\r\n}\r\nret = voltdm->scale(voltdm, target_volt);\r\nif (!ret)\r\nvoltdm->nominal_volt = target_volt;\r\nreturn ret;\r\n}\r\nvoid voltdm_reset(struct voltagedomain *voltdm)\r\n{\r\nunsigned long target_volt;\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn;\r\n}\r\ntarget_volt = voltdm_get_voltage(voltdm);\r\nif (!target_volt) {\r\npr_err("%s: unable to find current voltage for vdd_%s\n",\r\n__func__, voltdm->name);\r\nreturn;\r\n}\r\nvoltdm_scale(voltdm, target_volt);\r\n}\r\nvoid omap_voltage_get_volttable(struct voltagedomain *voltdm,\r\nstruct omap_volt_data **volt_data)\r\n{\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn;\r\n}\r\n*volt_data = voltdm->volt_data;\r\n}\r\nstruct omap_volt_data *omap_voltage_get_voltdata(struct voltagedomain *voltdm,\r\nunsigned long volt)\r\n{\r\nint i;\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nif (!voltdm->volt_data) {\r\npr_warning("%s: voltage table does not exist for vdd_%s\n",\r\n__func__, voltdm->name);\r\nreturn ERR_PTR(-ENODATA);\r\n}\r\nfor (i = 0; voltdm->volt_data[i].volt_nominal != 0; i++) {\r\nif (voltdm->volt_data[i].volt_nominal == volt)\r\nreturn &voltdm->volt_data[i];\r\n}\r\npr_notice("%s: Unable to match the current voltage with the voltage"\r\n"table for vdd_%s\n", __func__, voltdm->name);\r\nreturn ERR_PTR(-ENODATA);\r\n}\r\nint omap_voltage_register_pmic(struct voltagedomain *voltdm,\r\nstruct omap_voltdm_pmic *pmic)\r\n{\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nvoltdm->pmic = pmic;\r\nreturn 0;\r\n}\r\nvoid omap_change_voltscale_method(struct voltagedomain *voltdm,\r\nint voltscale_method)\r\n{\r\nif (!voltdm || IS_ERR(voltdm)) {\r\npr_warning("%s: VDD specified does not exist!\n", __func__);\r\nreturn;\r\n}\r\nswitch (voltscale_method) {\r\ncase VOLTSCALE_VPFORCEUPDATE:\r\nvoltdm->scale = omap_vp_forceupdate_scale;\r\nreturn;\r\ncase VOLTSCALE_VCBYPASS:\r\nvoltdm->scale = omap_vc_bypass_scale;\r\nreturn;\r\ndefault:\r\npr_warning("%s: Trying to change the method of voltage scaling"\r\n"to an unsupported one!\n", __func__);\r\n}\r\n}\r\nint __init omap_voltage_late_init(void)\r\n{\r\nstruct voltagedomain *voltdm;\r\nif (list_empty(&voltdm_list)) {\r\npr_err("%s: Voltage driver support not added\n",\r\n__func__);\r\nreturn -EINVAL;\r\n}\r\nlist_for_each_entry(voltdm, &voltdm_list, node) {\r\nstruct clk *sys_ck;\r\nif (!voltdm->scalable)\r\ncontinue;\r\nsys_ck = clk_get(NULL, voltdm->sys_clk.name);\r\nif (IS_ERR(sys_ck)) {\r\npr_warning("%s: Could not get sys clk.\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nvoltdm->sys_clk.rate = clk_get_rate(sys_ck);\r\nWARN_ON(!voltdm->sys_clk.rate);\r\nclk_put(sys_ck);\r\nif (voltdm->vc) {\r\nvoltdm->scale = omap_vc_bypass_scale;\r\nomap_vc_init_channel(voltdm);\r\n}\r\nif (voltdm->vp) {\r\nvoltdm->scale = omap_vp_forceupdate_scale;\r\nomap_vp_init(voltdm);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic struct voltagedomain *_voltdm_lookup(const char *name)\r\n{\r\nstruct voltagedomain *voltdm, *temp_voltdm;\r\nvoltdm = NULL;\r\nlist_for_each_entry(temp_voltdm, &voltdm_list, node) {\r\nif (!strcmp(name, temp_voltdm->name)) {\r\nvoltdm = temp_voltdm;\r\nbreak;\r\n}\r\n}\r\nreturn voltdm;\r\n}\r\nint voltdm_add_pwrdm(struct voltagedomain *voltdm, struct powerdomain *pwrdm)\r\n{\r\nif (!voltdm || !pwrdm)\r\nreturn -EINVAL;\r\npr_debug("voltagedomain: associating powerdomain %s with voltagedomain "\r\n"%s\n", pwrdm->name, voltdm->name);\r\nlist_add(&pwrdm->voltdm_node, &voltdm->pwrdm_list);\r\nreturn 0;\r\n}\r\nint voltdm_for_each_pwrdm(struct voltagedomain *voltdm,\r\nint (*fn)(struct voltagedomain *voltdm,\r\nstruct powerdomain *pwrdm))\r\n{\r\nstruct powerdomain *pwrdm;\r\nint ret = 0;\r\nif (!fn)\r\nreturn -EINVAL;\r\nlist_for_each_entry(pwrdm, &voltdm->pwrdm_list, voltdm_node)\r\nret = (*fn)(voltdm, pwrdm);\r\nreturn ret;\r\n}\r\nint voltdm_for_each(int (*fn)(struct voltagedomain *voltdm, void *user),\r\nvoid *user)\r\n{\r\nstruct voltagedomain *temp_voltdm;\r\nint ret = 0;\r\nif (!fn)\r\nreturn -EINVAL;\r\nlist_for_each_entry(temp_voltdm, &voltdm_list, node) {\r\nret = (*fn)(temp_voltdm, user);\r\nif (ret)\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int _voltdm_register(struct voltagedomain *voltdm)\r\n{\r\nif (!voltdm || !voltdm->name)\r\nreturn -EINVAL;\r\nINIT_LIST_HEAD(&voltdm->pwrdm_list);\r\nlist_add(&voltdm->node, &voltdm_list);\r\npr_debug("voltagedomain: registered %s\n", voltdm->name);\r\nreturn 0;\r\n}\r\nstruct voltagedomain *voltdm_lookup(const char *name)\r\n{\r\nstruct voltagedomain *voltdm ;\r\nif (!name)\r\nreturn NULL;\r\nvoltdm = _voltdm_lookup(name);\r\nreturn voltdm;\r\n}\r\nvoid voltdm_init(struct voltagedomain **voltdms)\r\n{\r\nstruct voltagedomain **v;\r\nif (voltdms) {\r\nfor (v = voltdms; *v; v++)\r\n_voltdm_register(*v);\r\n}\r\n}

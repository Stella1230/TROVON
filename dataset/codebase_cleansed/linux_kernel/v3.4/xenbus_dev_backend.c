static int xenbus_backend_open(struct inode *inode, struct file *filp)\r\n{\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nreturn nonseekable_open(inode, filp);\r\n}\r\nstatic long xenbus_backend_ioctl(struct file *file, unsigned int cmd, unsigned long data)\r\n{\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nswitch (cmd) {\r\ncase IOCTL_XENBUS_BACKEND_EVTCHN:\r\nif (xen_store_evtchn > 0)\r\nreturn xen_store_evtchn;\r\nreturn -ENODEV;\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int xenbus_backend_mmap(struct file *file, struct vm_area_struct *vma)\r\n{\r\nsize_t size = vma->vm_end - vma->vm_start;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nif ((size > PAGE_SIZE) || (vma->vm_pgoff != 0))\r\nreturn -EINVAL;\r\nif (remap_pfn_range(vma, vma->vm_start,\r\nvirt_to_pfn(xen_store_interface),\r\nsize, vma->vm_page_prot))\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic int __init xenbus_backend_init(void)\r\n{\r\nint err;\r\nif (!xen_initial_domain())\r\nreturn -ENODEV;\r\nerr = misc_register(&xenbus_backend_dev);\r\nif (err)\r\nprintk(KERN_ERR "Could not register xenbus backend device\n");\r\nreturn err;\r\n}\r\nstatic void __exit xenbus_backend_exit(void)\r\n{\r\nmisc_deregister(&xenbus_backend_dev);\r\n}

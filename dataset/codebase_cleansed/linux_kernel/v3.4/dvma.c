static unsigned long dvma_page(unsigned long kaddr, unsigned long vaddr)\r\n{\r\nunsigned long pte;\r\nunsigned long j;\r\npte_t ptep;\r\nj = *(volatile unsigned long *)kaddr;\r\n*(volatile unsigned long *)kaddr = j;\r\nptep = pfn_pte(virt_to_pfn(kaddr), PAGE_KERNEL);\r\npte = pte_val(ptep);\r\nif(ptelist[(vaddr & 0xff000) >> PAGE_SHIFT] != pte) {\r\nsun3_put_pte(vaddr, pte);\r\nptelist[(vaddr & 0xff000) >> PAGE_SHIFT] = pte;\r\n}\r\nreturn (vaddr + (kaddr & ~PAGE_MASK));\r\n}\r\nint dvma_map_iommu(unsigned long kaddr, unsigned long baddr,\r\nint len)\r\n{\r\nunsigned long end;\r\nunsigned long vaddr;\r\nvaddr = dvma_btov(baddr);\r\nend = vaddr + len;\r\nwhile(vaddr < end) {\r\ndvma_page(kaddr, vaddr);\r\nkaddr += PAGE_SIZE;\r\nvaddr += PAGE_SIZE;\r\n}\r\nreturn 0;\r\n}\r\nvoid sun3_dvma_init(void)\r\n{\r\nmemset(ptelist, 0, sizeof(ptelist));\r\n}

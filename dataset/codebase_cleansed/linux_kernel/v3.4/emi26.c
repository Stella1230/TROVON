static int emi26_writememory (struct usb_device *dev, int address,\r\nconst unsigned char *data, int length,\r\n__u8 request)\r\n{\r\nint result;\r\nunsigned char *buffer = kmemdup(data, length, GFP_KERNEL);\r\nif (!buffer) {\r\ndev_err(&dev->dev, "kmalloc(%d) failed.\n", length);\r\nreturn -ENOMEM;\r\n}\r\nresult = usb_control_msg (dev, usb_sndctrlpipe(dev, 0), request, 0x40, address, 0, buffer, length, 300);\r\nkfree (buffer);\r\nreturn result;\r\n}\r\nstatic int emi26_set_reset (struct usb_device *dev, unsigned char reset_bit)\r\n{\r\nint response;\r\ndev_info(&dev->dev, "%s - %d\n", __func__, reset_bit);\r\nresponse = emi26_writememory (dev, CPUCS_REG, &reset_bit, 1, 0xa0);\r\nif (response < 0) {\r\ndev_err(&dev->dev, "set_reset (%d) failed\n", reset_bit);\r\n}\r\nreturn response;\r\n}\r\nstatic int emi26_load_firmware (struct usb_device *dev)\r\n{\r\nconst struct firmware *loader_fw = NULL;\r\nconst struct firmware *bitstream_fw = NULL;\r\nconst struct firmware *firmware_fw = NULL;\r\nconst struct ihex_binrec *rec;\r\nint err;\r\nint i;\r\n__u32 addr;\r\n__u8 *buf;\r\nbuf = kmalloc(FW_LOAD_SIZE, GFP_KERNEL);\r\nif (!buf) {\r\ndev_err(&dev->dev, "%s - error loading firmware: error = %d\n",\r\n__func__, -ENOMEM);\r\nerr = -ENOMEM;\r\ngoto wraperr;\r\n}\r\nerr = request_ihex_firmware(&loader_fw, "emi26/loader.fw", &dev->dev);\r\nif (err)\r\ngoto nofw;\r\nerr = request_ihex_firmware(&bitstream_fw, "emi26/bitstream.fw",\r\n&dev->dev);\r\nif (err)\r\ngoto nofw;\r\nerr = request_ihex_firmware(&firmware_fw, "emi26/firmware.fw",\r\n&dev->dev);\r\nif (err) {\r\nnofw:\r\ndev_err(&dev->dev, "%s - request_firmware() failed\n",\r\n__func__);\r\ngoto wraperr;\r\n}\r\nerr = emi26_set_reset(dev,1);\r\nif (err < 0) {\r\ndev_err(&dev->dev,"%s - error loading firmware: error = %d\n",\r\n__func__, err);\r\ngoto wraperr;\r\n}\r\nrec = (const struct ihex_binrec *)loader_fw->data;\r\nwhile (rec) {\r\nerr = emi26_writememory(dev, be32_to_cpu(rec->addr),\r\nrec->data, be16_to_cpu(rec->len),\r\nANCHOR_LOAD_INTERNAL);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\nrec = ihex_next_binrec(rec);\r\n}\r\nerr = emi26_set_reset(dev,0);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\nmsleep(250);\r\nrec = (const struct ihex_binrec *)bitstream_fw->data;\r\ndo {\r\ni = 0;\r\naddr = be32_to_cpu(rec->addr);\r\nwhile (rec && (i + be16_to_cpu(rec->len) < FW_LOAD_SIZE)) {\r\nmemcpy(buf + i, rec->data, be16_to_cpu(rec->len));\r\ni += be16_to_cpu(rec->len);\r\nrec = ihex_next_binrec(rec);\r\n}\r\nerr = emi26_writememory(dev, addr, buf, i, ANCHOR_LOAD_FPGA);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\n} while (rec);\r\nerr = emi26_set_reset(dev,1);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\nfor (rec = (const struct ihex_binrec *)loader_fw->data;\r\nrec; rec = ihex_next_binrec(rec)) {\r\nerr = emi26_writememory(dev, be32_to_cpu(rec->addr),\r\nrec->data, be16_to_cpu(rec->len),\r\nANCHOR_LOAD_INTERNAL);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\n}\r\nmsleep(250);\r\nerr = emi26_set_reset(dev,0);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\nfor (rec = (const struct ihex_binrec *)firmware_fw->data;\r\nrec; rec = ihex_next_binrec(rec)) {\r\nif (!INTERNAL_RAM(be32_to_cpu(rec->addr))) {\r\nerr = emi26_writememory(dev, be32_to_cpu(rec->addr),\r\nrec->data, be16_to_cpu(rec->len),\r\nANCHOR_LOAD_EXTERNAL);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\n}\r\n}\r\nerr = emi26_set_reset(dev,1);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\nfor (rec = (const struct ihex_binrec *)firmware_fw->data;\r\nrec; rec = ihex_next_binrec(rec)) {\r\nif (INTERNAL_RAM(be32_to_cpu(rec->addr))) {\r\nerr = emi26_writememory(dev, be32_to_cpu(rec->addr),\r\nrec->data, be16_to_cpu(rec->len),\r\nANCHOR_LOAD_INTERNAL);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\n}\r\n}\r\nerr = emi26_set_reset(dev,0);\r\nif (err < 0) {\r\nerr("%s - error loading firmware: error = %d", __func__, err);\r\ngoto wraperr;\r\n}\r\nmsleep(250);\r\nerr = 1;\r\nwraperr:\r\nrelease_firmware(loader_fw);\r\nrelease_firmware(bitstream_fw);\r\nrelease_firmware(firmware_fw);\r\nkfree(buf);\r\nreturn err;\r\n}\r\nstatic int emi26_probe(struct usb_interface *intf, const struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\ndev_info(&intf->dev, "%s start\n", __func__);\r\nemi26_load_firmware(dev);\r\nreturn -EIO;\r\n}\r\nstatic void emi26_disconnect(struct usb_interface *intf)\r\n{\r\n}

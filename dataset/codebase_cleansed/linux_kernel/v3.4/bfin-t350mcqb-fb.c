static void bfin_t350mcqb_config_ppi(struct bfin_t350mcqbfb_info *fbi)\r\n{\r\nbfin_write_PPI_DELAY(H_START);\r\nbfin_write_PPI_COUNT(H_ACTPIX-1);\r\nbfin_write_PPI_FRAME(V_LINES);\r\nbfin_write_PPI_CONTROL(PPI_TX_MODE |\r\nPPI_XFER_TYPE_11 |\r\nPPI_PORT_CFG_01 |\r\nPPI_PACK_EN |\r\nPPI_POLS_1);\r\n}\r\nstatic inline void bfin_t350mcqb_disable_ppi(void)\r\n{\r\nbfin_write_PPI_CONTROL(bfin_read_PPI_CONTROL() & ~PORT_EN);\r\n}\r\nstatic inline void bfin_t350mcqb_enable_ppi(void)\r\n{\r\nbfin_write_PPI_CONTROL(bfin_read_PPI_CONTROL() | PORT_EN);\r\n}\r\nstatic void bfin_t350mcqb_start_timers(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nenable_gptimers(TIMER1bit);\r\nenable_gptimers(TIMER0bit);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic void bfin_t350mcqb_stop_timers(void)\r\n{\r\ndisable_gptimers(TIMER0bit | TIMER1bit);\r\nset_gptimer_status(0, TIMER_STATUS_TRUN0 | TIMER_STATUS_TRUN1 |\r\nTIMER_STATUS_TIMIL0 | TIMER_STATUS_TIMIL1 |\r\nTIMER_STATUS_TOVF0 | TIMER_STATUS_TOVF1);\r\n}\r\nstatic void bfin_t350mcqb_init_timers(void)\r\n{\r\nbfin_t350mcqb_stop_timers();\r\nset_gptimer_period(TIMER0_id, H_PERIOD);\r\nset_gptimer_pwidth(TIMER0_id, H_PULSE);\r\nset_gptimer_config(TIMER0_id, TIMER_MODE_PWM | TIMER_PERIOD_CNT |\r\nTIMER_TIN_SEL | TIMER_CLK_SEL|\r\nTIMER_EMU_RUN);\r\nset_gptimer_period(TIMER1_id, V_PERIOD);\r\nset_gptimer_pwidth(TIMER1_id, V_PULSE);\r\nset_gptimer_config(TIMER1_id, TIMER_MODE_PWM | TIMER_PERIOD_CNT |\r\nTIMER_TIN_SEL | TIMER_CLK_SEL |\r\nTIMER_EMU_RUN);\r\n}\r\nstatic void bfin_t350mcqb_config_dma(struct bfin_t350mcqbfb_info *fbi)\r\n{\r\nset_dma_config(CH_PPI,\r\nset_bfin_dma_config(DIR_READ, DMA_FLOW_AUTO,\r\nINTR_DISABLE, DIMENSION_2D,\r\nDATA_SIZE_16,\r\nDMA_NOSYNC_KEEP_DMA_BUF));\r\nset_dma_x_count(CH_PPI, (LCD_X_RES * LCD_BPP) / DMA_BUS_SIZE);\r\nset_dma_x_modify(CH_PPI, DMA_BUS_SIZE / 8);\r\nset_dma_y_count(CH_PPI, V_LINES);\r\nset_dma_y_modify(CH_PPI, DMA_BUS_SIZE / 8);\r\nset_dma_start_addr(CH_PPI, (unsigned long)fbi->fb_buffer);\r\n}\r\nstatic int bfin_t350mcqb_request_ports(int action)\r\n{\r\nif (action) {\r\nif (peripheral_request_list(ppi0_req_8, DRIVER_NAME)) {\r\nprintk(KERN_ERR "Requesting Peripherals failed\n");\r\nreturn -EFAULT;\r\n}\r\n} else\r\nperipheral_free_list(ppi0_req_8);\r\nreturn 0;\r\n}\r\nstatic int bfin_t350mcqb_fb_open(struct fb_info *info, int user)\r\n{\r\nstruct bfin_t350mcqbfb_info *fbi = info->par;\r\nspin_lock(&fbi->lock);\r\nfbi->lq043_open_cnt++;\r\nif (fbi->lq043_open_cnt <= 1) {\r\nbfin_t350mcqb_disable_ppi();\r\nSSYNC();\r\nbfin_t350mcqb_config_dma(fbi);\r\nbfin_t350mcqb_config_ppi(fbi);\r\nbfin_t350mcqb_init_timers();\r\nenable_dma(CH_PPI);\r\nbfin_t350mcqb_enable_ppi();\r\nbfin_t350mcqb_start_timers();\r\n}\r\nspin_unlock(&fbi->lock);\r\nreturn 0;\r\n}\r\nstatic int bfin_t350mcqb_fb_release(struct fb_info *info, int user)\r\n{\r\nstruct bfin_t350mcqbfb_info *fbi = info->par;\r\nspin_lock(&fbi->lock);\r\nfbi->lq043_open_cnt--;\r\nif (fbi->lq043_open_cnt <= 0) {\r\nbfin_t350mcqb_disable_ppi();\r\nSSYNC();\r\ndisable_dma(CH_PPI);\r\nbfin_t350mcqb_stop_timers();\r\n}\r\nspin_unlock(&fbi->lock);\r\nreturn 0;\r\n}\r\nstatic int bfin_t350mcqb_fb_check_var(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nswitch (var->bits_per_pixel) {\r\ncase 24:\r\nvar->red.offset = 0;\r\nvar->green.offset = 8;\r\nvar->blue.offset = 16;\r\nvar->red.length = var->green.length = var->blue.length = 8;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nvar->transp.msb_right = 0;\r\nvar->red.msb_right = 0;\r\nvar->green.msb_right = 0;\r\nvar->blue.msb_right = 0;\r\nbreak;\r\ndefault:\r\npr_debug("%s: depth not supported: %u BPP\n", __func__,\r\nvar->bits_per_pixel);\r\nreturn -EINVAL;\r\n}\r\nif (info->var.xres != var->xres || info->var.yres != var->yres ||\r\ninfo->var.xres_virtual != var->xres_virtual ||\r\ninfo->var.yres_virtual != var->yres_virtual) {\r\npr_debug("%s: Resolution not supported: X%u x Y%u \n",\r\n__func__, var->xres, var->yres);\r\nreturn -EINVAL;\r\n}\r\nif ((info->fix.line_length * var->yres_virtual) > info->fix.smem_len) {\r\npr_debug("%s: Memory Limit requested yres_virtual = %u\n",\r\n__func__, var->yres_virtual);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nint bfin_t350mcqb_fb_cursor(struct fb_info *info, struct fb_cursor *cursor)\r\n{\r\nif (nocursor)\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nstatic int bfin_t350mcqb_fb_setcolreg(u_int regno, u_int red, u_int green,\r\nu_int blue, u_int transp,\r\nstruct fb_info *info)\r\n{\r\nif (regno >= BFIN_LCD_NBR_PALETTE_ENTRIES)\r\nreturn -EINVAL;\r\nif (info->var.grayscale) {\r\nred = green = blue = (red * 77 + green * 151 + blue * 28) >> 8;\r\n}\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR) {\r\nu32 value;\r\nif (regno > 16)\r\nreturn -EINVAL;\r\nred >>= (16 - info->var.red.length);\r\ngreen >>= (16 - info->var.green.length);\r\nblue >>= (16 - info->var.blue.length);\r\nvalue = (red << info->var.red.offset) |\r\n(green << info->var.green.offset) |\r\n(blue << info->var.blue.offset);\r\nvalue &= 0xFFFFFF;\r\n((u32 *) (info->pseudo_palette))[regno] = value;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bl_get_brightness(struct backlight_device *bd)\r\n{\r\nreturn 0;\r\n}\r\nstatic int bfin_lcd_get_power(struct lcd_device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int bfin_lcd_set_power(struct lcd_device *dev, int power)\r\n{\r\nreturn 0;\r\n}\r\nstatic int bfin_lcd_get_contrast(struct lcd_device *dev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int bfin_lcd_set_contrast(struct lcd_device *dev, int contrast)\r\n{\r\nreturn 0;\r\n}\r\nstatic int bfin_lcd_check_fb(struct lcd_device *dev, struct fb_info *fi)\r\n{\r\nif (!fi || (fi == &bfin_t350mcqb_fb))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t bfin_t350mcqb_irq_error(int irq, void *dev_id)\r\n{\r\nu16 status = bfin_read_PPI_STATUS();\r\nbfin_write_PPI_STATUS(0xFFFF);\r\nif (status) {\r\nbfin_t350mcqb_disable_ppi();\r\ndisable_dma(CH_PPI);\r\nenable_dma(CH_PPI);\r\nbfin_t350mcqb_enable_ppi();\r\nbfin_write_PPI_STATUS(0xFFFF);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit bfin_t350mcqb_probe(struct platform_device *pdev)\r\n{\r\n#ifndef NO_BL_SUPPORT\r\nstruct backlight_properties props;\r\n#endif\r\nstruct bfin_t350mcqbfb_info *info;\r\nstruct fb_info *fbinfo;\r\nint ret;\r\nprintk(KERN_INFO DRIVER_NAME ": %dx%d %d-bit RGB FrameBuffer initializing...\n",\r\nLCD_X_RES, LCD_Y_RES, LCD_BPP);\r\nif (request_dma(CH_PPI, "CH_PPI") < 0) {\r\nprintk(KERN_ERR DRIVER_NAME\r\n": couldn't request CH_PPI DMA\n");\r\nret = -EFAULT;\r\ngoto out1;\r\n}\r\nfbinfo =\r\nframebuffer_alloc(sizeof(struct bfin_t350mcqbfb_info), &pdev->dev);\r\nif (!fbinfo) {\r\nret = -ENOMEM;\r\ngoto out2;\r\n}\r\ninfo = fbinfo->par;\r\ninfo->fb = fbinfo;\r\ninfo->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, fbinfo);\r\nstrcpy(fbinfo->fix.id, driver_name);\r\nfbinfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\nfbinfo->fix.type_aux = 0;\r\nfbinfo->fix.xpanstep = 0;\r\nfbinfo->fix.ypanstep = 0;\r\nfbinfo->fix.ywrapstep = 0;\r\nfbinfo->fix.accel = FB_ACCEL_NONE;\r\nfbinfo->fix.visual = FB_VISUAL_TRUECOLOR;\r\nfbinfo->var.nonstd = 0;\r\nfbinfo->var.activate = FB_ACTIVATE_NOW;\r\nfbinfo->var.height = 53;\r\nfbinfo->var.width = 70;\r\nfbinfo->var.accel_flags = 0;\r\nfbinfo->var.vmode = FB_VMODE_NONINTERLACED;\r\nfbinfo->var.xres = LCD_X_RES;\r\nfbinfo->var.xres_virtual = LCD_X_RES;\r\nfbinfo->var.yres = LCD_Y_RES;\r\nfbinfo->var.yres_virtual = LCD_Y_RES;\r\nfbinfo->var.bits_per_pixel = LCD_BPP;\r\nfbinfo->var.red.offset = 0;\r\nfbinfo->var.green.offset = 8;\r\nfbinfo->var.blue.offset = 16;\r\nfbinfo->var.transp.offset = 0;\r\nfbinfo->var.red.length = 8;\r\nfbinfo->var.green.length = 8;\r\nfbinfo->var.blue.length = 8;\r\nfbinfo->var.transp.length = 0;\r\nfbinfo->fix.smem_len = LCD_X_RES * LCD_Y_RES * LCD_BPP / 8;\r\nfbinfo->fix.line_length = fbinfo->var.xres_virtual *\r\nfbinfo->var.bits_per_pixel / 8;\r\nfbinfo->fbops = &bfin_t350mcqb_fb_ops;\r\nfbinfo->flags = FBINFO_FLAG_DEFAULT;\r\ninfo->fb_buffer = dma_alloc_coherent(NULL, fbinfo->fix.smem_len +\r\nACTIVE_VIDEO_MEM_OFFSET,\r\n&info->dma_handle, GFP_KERNEL);\r\nif (NULL == info->fb_buffer) {\r\nprintk(KERN_ERR DRIVER_NAME\r\n": couldn't allocate dma buffer.\n");\r\nret = -ENOMEM;\r\ngoto out3;\r\n}\r\nfbinfo->screen_base = (void *)info->fb_buffer + ACTIVE_VIDEO_MEM_OFFSET;\r\nfbinfo->fix.smem_start = (int)info->fb_buffer + ACTIVE_VIDEO_MEM_OFFSET;\r\nfbinfo->fbops = &bfin_t350mcqb_fb_ops;\r\nfbinfo->pseudo_palette = &info->pseudo_pal;\r\nif (fb_alloc_cmap(&fbinfo->cmap, BFIN_LCD_NBR_PALETTE_ENTRIES, 0)\r\n< 0) {\r\nprintk(KERN_ERR DRIVER_NAME\r\n"Fail to allocate colormap (%d entries)\n",\r\nBFIN_LCD_NBR_PALETTE_ENTRIES);\r\nret = -EFAULT;\r\ngoto out4;\r\n}\r\nif (bfin_t350mcqb_request_ports(1)) {\r\nprintk(KERN_ERR DRIVER_NAME ": couldn't request gpio port.\n");\r\nret = -EFAULT;\r\ngoto out6;\r\n}\r\ninfo->irq = platform_get_irq(pdev, 0);\r\nif (info->irq < 0) {\r\nret = -EINVAL;\r\ngoto out7;\r\n}\r\nret = request_irq(info->irq, bfin_t350mcqb_irq_error, 0,\r\n"PPI ERROR", info);\r\nif (ret < 0) {\r\nprintk(KERN_ERR DRIVER_NAME\r\n": unable to request PPI ERROR IRQ\n");\r\ngoto out7;\r\n}\r\nif (register_framebuffer(fbinfo) < 0) {\r\nprintk(KERN_ERR DRIVER_NAME\r\n": unable to register framebuffer.\n");\r\nret = -EINVAL;\r\ngoto out8;\r\n}\r\n#ifndef NO_BL_SUPPORT\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = 255;\r\nbl_dev = backlight_device_register("bf52x-bl", NULL, NULL,\r\n&bfin_lq043fb_bl_ops, &props);\r\nif (IS_ERR(bl_dev)) {\r\nprintk(KERN_ERR DRIVER_NAME\r\n": unable to register backlight.\n");\r\nret = -EINVAL;\r\nunregister_framebuffer(fbinfo);\r\ngoto out8;\r\n}\r\nlcd_dev = lcd_device_register(DRIVER_NAME, NULL, &bfin_lcd_ops);\r\nlcd_dev->props.max_contrast = 255, printk(KERN_INFO "Done.\n");\r\n#endif\r\nreturn 0;\r\nout8:\r\nfree_irq(info->irq, info);\r\nout7:\r\nbfin_t350mcqb_request_ports(0);\r\nout6:\r\nfb_dealloc_cmap(&fbinfo->cmap);\r\nout4:\r\ndma_free_coherent(NULL, fbinfo->fix.smem_len + ACTIVE_VIDEO_MEM_OFFSET,\r\ninfo->fb_buffer, info->dma_handle);\r\nout3:\r\nframebuffer_release(fbinfo);\r\nout2:\r\nfree_dma(CH_PPI);\r\nout1:\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn ret;\r\n}\r\nstatic int __devexit bfin_t350mcqb_remove(struct platform_device *pdev)\r\n{\r\nstruct fb_info *fbinfo = platform_get_drvdata(pdev);\r\nstruct bfin_t350mcqbfb_info *info = fbinfo->par;\r\nunregister_framebuffer(fbinfo);\r\nfree_dma(CH_PPI);\r\nfree_irq(info->irq, info);\r\nif (info->fb_buffer != NULL)\r\ndma_free_coherent(NULL, fbinfo->fix.smem_len +\r\nACTIVE_VIDEO_MEM_OFFSET, info->fb_buffer,\r\ninfo->dma_handle);\r\nfb_dealloc_cmap(&fbinfo->cmap);\r\n#ifndef NO_BL_SUPPORT\r\nlcd_device_unregister(lcd_dev);\r\nbacklight_device_unregister(bl_dev);\r\n#endif\r\nbfin_t350mcqb_request_ports(0);\r\nplatform_set_drvdata(pdev, NULL);\r\nframebuffer_release(fbinfo);\r\nprintk(KERN_INFO DRIVER_NAME ": Unregister LCD driver.\n");\r\nreturn 0;\r\n}\r\nstatic int bfin_t350mcqb_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct fb_info *fbinfo = platform_get_drvdata(pdev);\r\nstruct bfin_t350mcqbfb_info *fbi = fbinfo->par;\r\nif (fbi->lq043_open_cnt) {\r\nbfin_t350mcqb_disable_ppi();\r\ndisable_dma(CH_PPI);\r\nbfin_t350mcqb_stop_timers();\r\nbfin_write_PPI_STATUS(-1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int bfin_t350mcqb_resume(struct platform_device *pdev)\r\n{\r\nstruct fb_info *fbinfo = platform_get_drvdata(pdev);\r\nstruct bfin_t350mcqbfb_info *fbi = fbinfo->par;\r\nif (fbi->lq043_open_cnt) {\r\nbfin_t350mcqb_config_dma(fbi);\r\nbfin_t350mcqb_config_ppi(fbi);\r\nbfin_t350mcqb_init_timers();\r\nenable_dma(CH_PPI);\r\nbfin_t350mcqb_enable_ppi();\r\nbfin_t350mcqb_start_timers();\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init bfin_t350mcqb_driver_init(void)\r\n{\r\nreturn platform_driver_register(&bfin_t350mcqb_driver);\r\n}\r\nstatic void __exit bfin_t350mcqb_driver_cleanup(void)\r\n{\r\nplatform_driver_unregister(&bfin_t350mcqb_driver);\r\n}

static int is_device_present(acpi_handle handle)\r\n{\r\nacpi_handle temp;\r\nacpi_status status;\r\nunsigned long long sta;\r\nstatus = acpi_get_handle(handle, "_STA", &temp);\r\nif (ACPI_FAILURE(status))\r\nreturn 1;\r\nstatus = acpi_evaluate_integer(handle, "_STA", NULL, &sta);\r\nif (ACPI_FAILURE(status))\r\nreturn 0;\r\nreturn ((sta & ACPI_STA_DEVICE_PRESENT) == ACPI_STA_DEVICE_PRESENT);\r\n}\r\nstatic int acpi_container_add(struct acpi_device *device)\r\n{\r\nstruct acpi_container *container;\r\nif (!device) {\r\nprintk(KERN_ERR PREFIX "device is NULL\n");\r\nreturn -EINVAL;\r\n}\r\ncontainer = kzalloc(sizeof(struct acpi_container), GFP_KERNEL);\r\nif (!container)\r\nreturn -ENOMEM;\r\ncontainer->handle = device->handle;\r\nstrcpy(acpi_device_name(device), ACPI_CONTAINER_DEVICE_NAME);\r\nstrcpy(acpi_device_class(device), ACPI_CONTAINER_CLASS);\r\ndevice->driver_data = container;\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO, "Device <%s> bid <%s>\n",\r\nacpi_device_name(device), acpi_device_bid(device)));\r\nreturn 0;\r\n}\r\nstatic int acpi_container_remove(struct acpi_device *device, int type)\r\n{\r\nacpi_status status = AE_OK;\r\nstruct acpi_container *pc = NULL;\r\npc = acpi_driver_data(device);\r\nkfree(pc);\r\nreturn status;\r\n}\r\nstatic int container_device_add(struct acpi_device **device, acpi_handle handle)\r\n{\r\nacpi_handle phandle;\r\nstruct acpi_device *pdev;\r\nint result;\r\nif (acpi_get_parent(handle, &phandle)) {\r\nreturn -ENODEV;\r\n}\r\nif (acpi_bus_get_device(phandle, &pdev)) {\r\nreturn -ENODEV;\r\n}\r\nif (acpi_bus_add(device, pdev, handle, ACPI_BUS_TYPE_DEVICE)) {\r\nreturn -ENODEV;\r\n}\r\nresult = acpi_bus_start(*device);\r\nreturn result;\r\n}\r\nstatic void container_notify_cb(acpi_handle handle, u32 type, void *context)\r\n{\r\nstruct acpi_device *device = NULL;\r\nint result;\r\nint present;\r\nacpi_status status;\r\npresent = is_device_present(handle);\r\nswitch (type) {\r\ncase ACPI_NOTIFY_BUS_CHECK:\r\ncase ACPI_NOTIFY_DEVICE_CHECK:\r\nprintk(KERN_WARNING "Container driver received %s event\n",\r\n(type == ACPI_NOTIFY_BUS_CHECK) ?\r\n"ACPI_NOTIFY_BUS_CHECK" : "ACPI_NOTIFY_DEVICE_CHECK");\r\nstatus = acpi_bus_get_device(handle, &device);\r\nif (present) {\r\nif (ACPI_FAILURE(status) || !device) {\r\nresult = container_device_add(&device, handle);\r\nif (!result)\r\nkobject_uevent(&device->dev.kobj,\r\nKOBJ_ONLINE);\r\nelse\r\nprintk(KERN_WARNING\r\n"Failed to add container\n");\r\n}\r\n} else {\r\nif (ACPI_SUCCESS(status)) {\r\nkobject_uevent(&device->dev.kobj, KOBJ_OFFLINE);\r\n}\r\n}\r\nbreak;\r\ncase ACPI_NOTIFY_EJECT_REQUEST:\r\nif (!acpi_bus_get_device(handle, &device) && device) {\r\nkobject_uevent(&device->dev.kobj, KOBJ_OFFLINE);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn;\r\n}\r\nstatic acpi_status\r\ncontainer_walk_namespace_cb(acpi_handle handle,\r\nu32 lvl, void *context, void **rv)\r\n{\r\nchar *hid = NULL;\r\nstruct acpi_device_info *info;\r\nacpi_status status;\r\nint *action = context;\r\nstatus = acpi_get_object_info(handle, &info);\r\nif (ACPI_FAILURE(status)) {\r\nreturn AE_OK;\r\n}\r\nif (info->valid & ACPI_VALID_HID)\r\nhid = info->hardware_id.string;\r\nif (hid == NULL) {\r\ngoto end;\r\n}\r\nif (strcmp(hid, "ACPI0004") && strcmp(hid, "PNP0A05") &&\r\nstrcmp(hid, "PNP0A06")) {\r\ngoto end;\r\n}\r\nswitch (*action) {\r\ncase INSTALL_NOTIFY_HANDLER:\r\nacpi_install_notify_handler(handle,\r\nACPI_SYSTEM_NOTIFY,\r\ncontainer_notify_cb, NULL);\r\nbreak;\r\ncase UNINSTALL_NOTIFY_HANDLER:\r\nacpi_remove_notify_handler(handle,\r\nACPI_SYSTEM_NOTIFY,\r\ncontainer_notify_cb);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nend:\r\nkfree(info);\r\nreturn AE_OK;\r\n}\r\nstatic int __init acpi_container_init(void)\r\n{\r\nint result = 0;\r\nint action = INSTALL_NOTIFY_HANDLER;\r\nresult = acpi_bus_register_driver(&acpi_container_driver);\r\nif (result < 0) {\r\nreturn (result);\r\n}\r\nacpi_walk_namespace(ACPI_TYPE_DEVICE,\r\nACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX,\r\ncontainer_walk_namespace_cb, NULL, &action, NULL);\r\nreturn (0);\r\n}\r\nstatic void __exit acpi_container_exit(void)\r\n{\r\nint action = UNINSTALL_NOTIFY_HANDLER;\r\nacpi_walk_namespace(ACPI_TYPE_DEVICE,\r\nACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX,\r\ncontainer_walk_namespace_cb, NULL, &action, NULL);\r\nacpi_bus_unregister_driver(&acpi_container_driver);\r\nreturn;\r\n}

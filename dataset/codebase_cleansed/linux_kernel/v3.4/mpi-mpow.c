static int build_index(const MPI *exparray, int k, int i, int t)\r\n{\r\nint j, bitno;\r\nint index = 0;\r\nbitno = t - i;\r\nfor (j = k - 1; j >= 0; j--) {\r\nindex <<= 1;\r\nif (mpi_test_bit(exparray[j], bitno))\r\nindex |= 1;\r\n}\r\nreturn index;\r\n}\r\nint mpi_mulpowm(MPI res, MPI *basearray, MPI *exparray, MPI m)\r\n{\r\nint rc = -ENOMEM;\r\nint k;\r\nint t;\r\nint i, j, idx;\r\nMPI *G = NULL;\r\nMPI tmp = NULL;\r\nfor (k = 0; basearray[k]; k++)\r\n;\r\nif (!k) {\r\npr_emerg("mpi_mulpowm: assert(k) failed\n");\r\nBUG();\r\n}\r\nfor (t = 0, i = 0; (tmp = exparray[i]); i++) {\r\nj = mpi_get_nbits(tmp);\r\nif (j > t)\r\nt = j;\r\n}\r\nif (i != k) {\r\npr_emerg("mpi_mulpowm: assert(i==k) failed\n");\r\nBUG();\r\n}\r\nif (!t) {\r\npr_emerg("mpi_mulpowm: assert(t) failed\n");\r\nBUG();\r\n}\r\nif (k >= 10) {\r\npr_emerg("mpi_mulpowm: assert(k<10) failed\n");\r\nBUG();\r\n}\r\nG = kzalloc((1 << k) * sizeof *G, GFP_KERNEL);\r\nif (!G)\r\ngoto err_out;\r\ntmp = mpi_alloc(mpi_get_nlimbs(m) + 1);\r\nif (!tmp)\r\ngoto nomem;\r\nif (mpi_set_ui(res, 1) < 0)\r\ngoto nomem;\r\nfor (i = 1; i <= t; i++) {\r\nif (mpi_mulm(tmp, res, res, m) < 0)\r\ngoto nomem;\r\nidx = build_index(exparray, k, i, t);\r\nif (!(idx >= 0 && idx < (1 << k))) {\r\npr_emerg("mpi_mulpowm: assert(idx >= 0 && idx < (1<<k)) failed\n");\r\nBUG();\r\n}\r\nif (!G[idx]) {\r\nif (!idx) {\r\nG[0] = mpi_alloc_set_ui(1);\r\nif (!G[0])\r\ngoto nomem;\r\n} else {\r\nfor (j = 0; j < k; j++) {\r\nif ((idx & (1 << j))) {\r\nif (!G[idx]) {\r\nif (mpi_copy\r\n(&G[idx],\r\nbasearray[j]) < 0)\r\ngoto nomem;\r\n} else {\r\nif (mpi_mulm\r\n(G[idx], G[idx],\r\nbasearray[j],\r\nm) < 0)\r\ngoto nomem;\r\n}\r\n}\r\n}\r\nif (!G[idx]) {\r\nG[idx] = mpi_alloc(0);\r\nif (!G[idx])\r\ngoto nomem;\r\n}\r\n}\r\n}\r\nif (mpi_mulm(res, tmp, G[idx], m) < 0)\r\ngoto nomem;\r\n}\r\nrc = 0;\r\nnomem:\r\nmpi_free(tmp);\r\nfor (i = 0; i < (1 << k); i++)\r\nmpi_free(G[i]);\r\nkfree(G);\r\nerr_out:\r\nreturn rc;\r\n}

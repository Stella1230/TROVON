static xfs_ino_t\r\nxfs_dir2_sf_get_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nxfs_dir2_inou_t *from)\r\n{\r\nif (hdr->i8count)\r\nreturn get_unaligned_be64(&from->i8.i) & 0x00ffffffffffffffULL;\r\nelse\r\nreturn get_unaligned_be32(&from->i4.i);\r\n}\r\nstatic void\r\nxfs_dir2_sf_put_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nxfs_dir2_inou_t *to,\r\nxfs_ino_t ino)\r\n{\r\nASSERT((ino & 0xff00000000000000ULL) == 0);\r\nif (hdr->i8count)\r\nput_unaligned_be64(ino, &to->i8.i);\r\nelse\r\nput_unaligned_be32(ino, &to->i4.i);\r\n}\r\nxfs_ino_t\r\nxfs_dir2_sf_get_parent_ino(\r\nstruct xfs_dir2_sf_hdr *hdr)\r\n{\r\nreturn xfs_dir2_sf_get_ino(hdr, &hdr->parent);\r\n}\r\nstatic void\r\nxfs_dir2_sf_put_parent_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nxfs_ino_t ino)\r\n{\r\nxfs_dir2_sf_put_ino(hdr, &hdr->parent, ino);\r\n}\r\nstatic xfs_dir2_inou_t *\r\nxfs_dir2_sfe_inop(\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn (xfs_dir2_inou_t *)&sfep->name[sfep->namelen];\r\n}\r\nxfs_ino_t\r\nxfs_dir2_sfe_get_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep)\r\n{\r\nreturn xfs_dir2_sf_get_ino(hdr, xfs_dir2_sfe_inop(sfep));\r\n}\r\nstatic void\r\nxfs_dir2_sfe_put_ino(\r\nstruct xfs_dir2_sf_hdr *hdr,\r\nstruct xfs_dir2_sf_entry *sfep,\r\nxfs_ino_t ino)\r\n{\r\nxfs_dir2_sf_put_ino(hdr, xfs_dir2_sfe_inop(sfep), ino);\r\n}\r\nint\r\nxfs_dir2_block_sfsize(\r\nxfs_inode_t *dp,\r\nxfs_dir2_data_hdr_t *hdr,\r\nxfs_dir2_sf_hdr_t *sfhp)\r\n{\r\nxfs_dir2_dataptr_t addr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nxfs_dir2_block_tail_t *btp;\r\nint count;\r\nxfs_dir2_data_entry_t *dep;\r\nint i;\r\nint i8count;\r\nint isdot;\r\nint isdotdot;\r\nxfs_mount_t *mp;\r\nint namelen;\r\nxfs_ino_t parent = 0;\r\nint size=0;\r\nmp = dp->i_mount;\r\ncount = i8count = namelen = 0;\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nfor (i = 0; i < be32_to_cpu(btp->count); i++) {\r\nif ((addr = be32_to_cpu(blp[i].address)) == XFS_DIR2_NULL_DATAPTR)\r\ncontinue;\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)hdr + xfs_dir2_dataptr_to_off(mp, addr));\r\nisdot = dep->namelen == 1 && dep->name[0] == '.';\r\nisdotdot =\r\ndep->namelen == 2 &&\r\ndep->name[0] == '.' && dep->name[1] == '.';\r\n#if XFS_BIG_INUMS\r\nif (!isdot)\r\ni8count += be64_to_cpu(dep->inumber) > XFS_DIR2_MAX_SHORT_INUM;\r\n#endif\r\nif (!isdot && !isdotdot) {\r\ncount++;\r\nnamelen += dep->namelen;\r\n} else if (isdotdot)\r\nparent = be64_to_cpu(dep->inumber);\r\nsize = xfs_dir2_sf_hdr_size(i8count) +\r\ncount +\r\ncount * (uint)sizeof(xfs_dir2_sf_off_t) +\r\nnamelen +\r\n(i8count ?\r\n(uint)sizeof(xfs_dir2_ino8_t) * count :\r\n(uint)sizeof(xfs_dir2_ino4_t) * count);\r\nif (size > XFS_IFORK_DSIZE(dp))\r\nreturn size;\r\n}\r\nsfhp->count = count;\r\nsfhp->i8count = i8count;\r\nxfs_dir2_sf_put_parent_ino(sfhp, parent);\r\nreturn size;\r\n}\r\nint\r\nxfs_dir2_block_to_sf(\r\nxfs_da_args_t *args,\r\nxfs_dabuf_t *bp,\r\nint size,\r\nxfs_dir2_sf_hdr_t *sfhp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *endptr;\r\nint error;\r\nint logflags;\r\nxfs_mount_t *mp;\r\nchar *ptr;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ntrace_xfs_dir2_block_to_sf(args);\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\nhdr = kmem_alloc(mp->m_dirblksize, KM_SLEEP);\r\nmemcpy(hdr, bp->data, mp->m_dirblksize);\r\nlogflags = XFS_ILOG_CORE;\r\nif ((error = xfs_dir2_shrink_inode(args, mp->m_dirdatablk, bp))) {\r\nASSERT(error != ENOSPC);\r\ngoto out;\r\n}\r\ndp->i_df.if_flags &= ~XFS_IFEXTENTS;\r\ndp->i_df.if_flags |= XFS_IFINLINE;\r\ndp->i_d.di_format = XFS_DINODE_FMT_LOCAL;\r\nASSERT(dp->i_df.if_bytes == 0);\r\nxfs_idata_realloc(dp, size, XFS_DATA_FORK);\r\nlogflags |= XFS_ILOG_DDATA;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nmemcpy(sfp, sfhp, xfs_dir2_sf_hdr_size(sfhp->i8count));\r\ndp->i_d.di_size = size;\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nptr = (char *)(hdr + 1);\r\nendptr = (char *)xfs_dir2_block_leaf_p(btp);\r\nsfep = xfs_dir2_sf_firstentry(sfp);\r\nwhile (ptr < endptr) {\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nptr += be16_to_cpu(dup->length);\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nif (dep->namelen == 1 && dep->name[0] == '.')\r\nASSERT(be64_to_cpu(dep->inumber) == dp->i_ino);\r\nelse if (dep->namelen == 2 &&\r\ndep->name[0] == '.' && dep->name[1] == '.')\r\nASSERT(be64_to_cpu(dep->inumber) ==\r\nxfs_dir2_sf_get_parent_ino(sfp));\r\nelse {\r\nsfep->namelen = dep->namelen;\r\nxfs_dir2_sf_put_offset(sfep,\r\n(xfs_dir2_data_aoff_t)\r\n((char *)dep - (char *)hdr));\r\nmemcpy(sfep->name, dep->name, dep->namelen);\r\nxfs_dir2_sfe_put_ino(sfp, sfep,\r\nbe64_to_cpu(dep->inumber));\r\nsfep = xfs_dir2_sf_nextentry(sfp, sfep);\r\n}\r\nptr += xfs_dir2_data_entsize(dep->namelen);\r\n}\r\nASSERT((char *)sfep - (char *)sfp == size);\r\nxfs_dir2_sf_check(args);\r\nout:\r\nxfs_trans_log_inode(args->trans, dp, logflags);\r\nkmem_free(hdr);\r\nreturn error;\r\n}\r\nint\r\nxfs_dir2_sf_addname(\r\nxfs_da_args_t *args)\r\n{\r\nint add_entsize;\r\nxfs_inode_t *dp;\r\nint error;\r\nint incr_isize;\r\nint new_isize;\r\nint objchange;\r\nxfs_dir2_data_aoff_t offset = 0;\r\nint old_isize;\r\nint pick;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nxfs_dir2_sf_entry_t *sfep = NULL;\r\ntrace_xfs_dir2_sf_addname(args);\r\nASSERT(xfs_dir2_sf_lookup(args) == ENOENT);\r\ndp = args->dp;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nif (dp->i_d.di_size < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(dp->i_mount));\r\nreturn XFS_ERROR(EIO);\r\n}\r\nASSERT(dp->i_df.if_bytes == dp->i_d.di_size);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(dp->i_d.di_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\r\nadd_entsize = xfs_dir2_sf_entsize(sfp, args->namelen);\r\nincr_isize = add_entsize;\r\nobjchange = 0;\r\n#if XFS_BIG_INUMS\r\nif (args->inumber > XFS_DIR2_MAX_SHORT_INUM && sfp->i8count == 0) {\r\nadd_entsize +=\r\n(uint)sizeof(xfs_dir2_ino8_t) -\r\n(uint)sizeof(xfs_dir2_ino4_t);\r\nincr_isize +=\r\n(sfp->count + 2) *\r\n((uint)sizeof(xfs_dir2_ino8_t) -\r\n(uint)sizeof(xfs_dir2_ino4_t));\r\nobjchange = 1;\r\n}\r\n#endif\r\nold_isize = (int)dp->i_d.di_size;\r\nnew_isize = old_isize + incr_isize;\r\nif (new_isize > XFS_IFORK_DSIZE(dp) ||\r\n(pick =\r\nxfs_dir2_sf_addname_pick(args, objchange, &sfep, &offset)) == 0) {\r\nif ((args->op_flags & XFS_DA_OP_JUSTCHECK) || args->total == 0)\r\nreturn XFS_ERROR(ENOSPC);\r\nerror = xfs_dir2_sf_to_block(args);\r\nif (error)\r\nreturn error;\r\nreturn xfs_dir2_block_addname(args);\r\n}\r\nif (args->op_flags & XFS_DA_OP_JUSTCHECK)\r\nreturn 0;\r\nif (pick == 1)\r\nxfs_dir2_sf_addname_easy(args, sfep, offset, new_isize);\r\nelse {\r\nASSERT(pick == 2);\r\n#if XFS_BIG_INUMS\r\nif (objchange)\r\nxfs_dir2_sf_toino8(args);\r\n#endif\r\nxfs_dir2_sf_addname_hard(args, objchange, new_isize);\r\n}\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\r\nreturn 0;\r\n}\r\nstatic void\r\nxfs_dir2_sf_addname_easy(\r\nxfs_da_args_t *args,\r\nxfs_dir2_sf_entry_t *sfep,\r\nxfs_dir2_data_aoff_t offset,\r\nint new_isize)\r\n{\r\nint byteoff;\r\nxfs_inode_t *dp;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ndp = args->dp;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nbyteoff = (int)((char *)sfep - (char *)sfp);\r\nxfs_idata_realloc(dp, xfs_dir2_sf_entsize(sfp, args->namelen),\r\nXFS_DATA_FORK);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nsfep = (xfs_dir2_sf_entry_t *)((char *)sfp + byteoff);\r\nsfep->namelen = args->namelen;\r\nxfs_dir2_sf_put_offset(sfep, offset);\r\nmemcpy(sfep->name, args->name, sfep->namelen);\r\nxfs_dir2_sfe_put_ino(sfp, sfep, args->inumber);\r\nsfp->count++;\r\n#if XFS_BIG_INUMS\r\nif (args->inumber > XFS_DIR2_MAX_SHORT_INUM)\r\nsfp->i8count++;\r\n#endif\r\ndp->i_d.di_size = new_isize;\r\nxfs_dir2_sf_check(args);\r\n}\r\nstatic void\r\nxfs_dir2_sf_addname_hard(\r\nxfs_da_args_t *args,\r\nint objchange,\r\nint new_isize)\r\n{\r\nint add_datasize;\r\nchar *buf;\r\nxfs_inode_t *dp;\r\nint eof;\r\nint nbytes;\r\nxfs_dir2_data_aoff_t new_offset;\r\nxfs_dir2_data_aoff_t offset;\r\nint old_isize;\r\nxfs_dir2_sf_entry_t *oldsfep;\r\nxfs_dir2_sf_hdr_t *oldsfp;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ndp = args->dp;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nold_isize = (int)dp->i_d.di_size;\r\nbuf = kmem_alloc(old_isize, KM_SLEEP);\r\noldsfp = (xfs_dir2_sf_hdr_t *)buf;\r\nmemcpy(oldsfp, sfp, old_isize);\r\nfor (offset = XFS_DIR2_DATA_FIRST_OFFSET,\r\noldsfep = xfs_dir2_sf_firstentry(oldsfp),\r\nadd_datasize = xfs_dir2_data_entsize(args->namelen),\r\neof = (char *)oldsfep == &buf[old_isize];\r\n!eof;\r\noffset = new_offset + xfs_dir2_data_entsize(oldsfep->namelen),\r\noldsfep = xfs_dir2_sf_nextentry(oldsfp, oldsfep),\r\neof = (char *)oldsfep == &buf[old_isize]) {\r\nnew_offset = xfs_dir2_sf_get_offset(oldsfep);\r\nif (offset + add_datasize <= new_offset)\r\nbreak;\r\n}\r\nxfs_idata_realloc(dp, -old_isize, XFS_DATA_FORK);\r\nxfs_idata_realloc(dp, new_isize, XFS_DATA_FORK);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nnbytes = (int)((char *)oldsfep - (char *)oldsfp);\r\nmemcpy(sfp, oldsfp, nbytes);\r\nsfep = (xfs_dir2_sf_entry_t *)((char *)sfp + nbytes);\r\nsfep->namelen = args->namelen;\r\nxfs_dir2_sf_put_offset(sfep, offset);\r\nmemcpy(sfep->name, args->name, sfep->namelen);\r\nxfs_dir2_sfe_put_ino(sfp, sfep, args->inumber);\r\nsfp->count++;\r\n#if XFS_BIG_INUMS\r\nif (args->inumber > XFS_DIR2_MAX_SHORT_INUM && !objchange)\r\nsfp->i8count++;\r\n#endif\r\nif (!eof) {\r\nsfep = xfs_dir2_sf_nextentry(sfp, sfep);\r\nmemcpy(sfep, oldsfep, old_isize - nbytes);\r\n}\r\nkmem_free(buf);\r\ndp->i_d.di_size = new_isize;\r\nxfs_dir2_sf_check(args);\r\n}\r\nstatic int\r\nxfs_dir2_sf_addname_pick(\r\nxfs_da_args_t *args,\r\nint objchange,\r\nxfs_dir2_sf_entry_t **sfepp,\r\nxfs_dir2_data_aoff_t *offsetp)\r\n{\r\nxfs_inode_t *dp;\r\nint holefit;\r\nint i;\r\nxfs_mount_t *mp;\r\nxfs_dir2_data_aoff_t offset;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nint size;\r\nint used;\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nsize = xfs_dir2_data_entsize(args->namelen);\r\noffset = XFS_DIR2_DATA_FIRST_OFFSET;\r\nsfep = xfs_dir2_sf_firstentry(sfp);\r\nholefit = 0;\r\nfor (i = 0; i < sfp->count; i++) {\r\nif (!holefit)\r\nholefit = offset + size <= xfs_dir2_sf_get_offset(sfep);\r\noffset = xfs_dir2_sf_get_offset(sfep) +\r\nxfs_dir2_data_entsize(sfep->namelen);\r\nsfep = xfs_dir2_sf_nextentry(sfp, sfep);\r\n}\r\nused = offset +\r\n(sfp->count + 3) * (uint)sizeof(xfs_dir2_leaf_entry_t) +\r\n(uint)sizeof(xfs_dir2_block_tail_t);\r\nif (used + (holefit ? 0 : size) > mp->m_dirblksize)\r\nreturn 0;\r\n#if XFS_BIG_INUMS\r\nif (objchange) {\r\nreturn 2;\r\n}\r\n#else\r\nASSERT(objchange == 0);\r\n#endif\r\nif (used + size > mp->m_dirblksize)\r\nreturn 2;\r\n*sfepp = sfep;\r\n*offsetp = offset;\r\nreturn 1;\r\n}\r\nstatic void\r\nxfs_dir2_sf_check(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_inode_t *dp;\r\nint i;\r\nint i8count;\r\nxfs_ino_t ino;\r\nint offset;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ndp = args->dp;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\noffset = XFS_DIR2_DATA_FIRST_OFFSET;\r\nino = xfs_dir2_sf_get_parent_ino(sfp);\r\ni8count = ino > XFS_DIR2_MAX_SHORT_INUM;\r\nfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp);\r\ni < sfp->count;\r\ni++, sfep = xfs_dir2_sf_nextentry(sfp, sfep)) {\r\nASSERT(xfs_dir2_sf_get_offset(sfep) >= offset);\r\nino = xfs_dir2_sfe_get_ino(sfp, sfep);\r\ni8count += ino > XFS_DIR2_MAX_SHORT_INUM;\r\noffset =\r\nxfs_dir2_sf_get_offset(sfep) +\r\nxfs_dir2_data_entsize(sfep->namelen);\r\n}\r\nASSERT(i8count == sfp->i8count);\r\nASSERT(XFS_BIG_INUMS || i8count == 0);\r\nASSERT((char *)sfep - (char *)sfp == dp->i_d.di_size);\r\nASSERT(offset +\r\n(sfp->count + 2) * (uint)sizeof(xfs_dir2_leaf_entry_t) +\r\n(uint)sizeof(xfs_dir2_block_tail_t) <=\r\ndp->i_mount->m_dirblksize);\r\n}\r\nint\r\nxfs_dir2_sf_create(\r\nxfs_da_args_t *args,\r\nxfs_ino_t pino)\r\n{\r\nxfs_inode_t *dp;\r\nint i8count;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nint size;\r\ntrace_xfs_dir2_sf_create(args);\r\ndp = args->dp;\r\nASSERT(dp != NULL);\r\nASSERT(dp->i_d.di_size == 0);\r\nif (dp->i_d.di_format == XFS_DINODE_FMT_EXTENTS) {\r\ndp->i_df.if_flags &= ~XFS_IFEXTENTS;\r\ndp->i_d.di_format = XFS_DINODE_FMT_LOCAL;\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE);\r\ndp->i_df.if_flags |= XFS_IFINLINE;\r\n}\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nASSERT(dp->i_df.if_bytes == 0);\r\ni8count = pino > XFS_DIR2_MAX_SHORT_INUM;\r\nsize = xfs_dir2_sf_hdr_size(i8count);\r\nxfs_idata_realloc(dp, size, XFS_DATA_FORK);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nsfp->i8count = i8count;\r\nxfs_dir2_sf_put_parent_ino(sfp, pino);\r\nsfp->count = 0;\r\ndp->i_d.di_size = size;\r\nxfs_dir2_sf_check(args);\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_sf_getdents(\r\nxfs_inode_t *dp,\r\nvoid *dirent,\r\nxfs_off_t *offset,\r\nfilldir_t filldir)\r\n{\r\nint i;\r\nxfs_mount_t *mp;\r\nxfs_dir2_dataptr_t off;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nxfs_dir2_dataptr_t dot_offset;\r\nxfs_dir2_dataptr_t dotdot_offset;\r\nxfs_ino_t ino;\r\nmp = dp->i_mount;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nif (dp->i_d.di_size < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(mp));\r\nreturn XFS_ERROR(EIO);\r\n}\r\nASSERT(dp->i_df.if_bytes == dp->i_d.di_size);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(dp->i_d.di_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\r\nif (xfs_dir2_dataptr_to_db(mp, *offset) > mp->m_dirdatablk)\r\nreturn 0;\r\ndot_offset = xfs_dir2_db_off_to_dataptr(mp, mp->m_dirdatablk,\r\nXFS_DIR2_DATA_DOT_OFFSET);\r\ndotdot_offset = xfs_dir2_db_off_to_dataptr(mp, mp->m_dirdatablk,\r\nXFS_DIR2_DATA_DOTDOT_OFFSET);\r\nif (*offset <= dot_offset) {\r\nif (filldir(dirent, ".", 1, dot_offset & 0x7fffffff, dp->i_ino, DT_DIR)) {\r\n*offset = dot_offset & 0x7fffffff;\r\nreturn 0;\r\n}\r\n}\r\nif (*offset <= dotdot_offset) {\r\nino = xfs_dir2_sf_get_parent_ino(sfp);\r\nif (filldir(dirent, "..", 2, dotdot_offset & 0x7fffffff, ino, DT_DIR)) {\r\n*offset = dotdot_offset & 0x7fffffff;\r\nreturn 0;\r\n}\r\n}\r\nsfep = xfs_dir2_sf_firstentry(sfp);\r\nfor (i = 0; i < sfp->count; i++) {\r\noff = xfs_dir2_db_off_to_dataptr(mp, mp->m_dirdatablk,\r\nxfs_dir2_sf_get_offset(sfep));\r\nif (*offset > off) {\r\nsfep = xfs_dir2_sf_nextentry(sfp, sfep);\r\ncontinue;\r\n}\r\nino = xfs_dir2_sfe_get_ino(sfp, sfep);\r\nif (filldir(dirent, (char *)sfep->name, sfep->namelen,\r\noff & 0x7fffffff, ino, DT_UNKNOWN)) {\r\n*offset = off & 0x7fffffff;\r\nreturn 0;\r\n}\r\nsfep = xfs_dir2_sf_nextentry(sfp, sfep);\r\n}\r\n*offset = xfs_dir2_db_off_to_dataptr(mp, mp->m_dirdatablk + 1, 0) &\r\n0x7fffffff;\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_sf_lookup(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_inode_t *dp;\r\nint i;\r\nint error;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\nenum xfs_dacmp cmp;\r\nxfs_dir2_sf_entry_t *ci_sfep;\r\ntrace_xfs_dir2_sf_lookup(args);\r\nxfs_dir2_sf_check(args);\r\ndp = args->dp;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nif (dp->i_d.di_size < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(dp->i_mount));\r\nreturn XFS_ERROR(EIO);\r\n}\r\nASSERT(dp->i_df.if_bytes == dp->i_d.di_size);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(dp->i_d.di_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\r\nif (args->namelen == 1 && args->name[0] == '.') {\r\nargs->inumber = dp->i_ino;\r\nargs->cmpresult = XFS_CMP_EXACT;\r\nreturn XFS_ERROR(EEXIST);\r\n}\r\nif (args->namelen == 2 &&\r\nargs->name[0] == '.' && args->name[1] == '.') {\r\nargs->inumber = xfs_dir2_sf_get_parent_ino(sfp);\r\nargs->cmpresult = XFS_CMP_EXACT;\r\nreturn XFS_ERROR(EEXIST);\r\n}\r\nci_sfep = NULL;\r\nfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp); i < sfp->count;\r\ni++, sfep = xfs_dir2_sf_nextentry(sfp, sfep)) {\r\ncmp = dp->i_mount->m_dirnameops->compname(args, sfep->name,\r\nsfep->namelen);\r\nif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\r\nargs->cmpresult = cmp;\r\nargs->inumber = xfs_dir2_sfe_get_ino(sfp, sfep);\r\nif (cmp == XFS_CMP_EXACT)\r\nreturn XFS_ERROR(EEXIST);\r\nci_sfep = sfep;\r\n}\r\n}\r\nASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\r\nif (!ci_sfep)\r\nreturn XFS_ERROR(ENOENT);\r\nerror = xfs_dir_cilookup_result(args, ci_sfep->name, ci_sfep->namelen);\r\nreturn XFS_ERROR(error);\r\n}\r\nint\r\nxfs_dir2_sf_removename(\r\nxfs_da_args_t *args)\r\n{\r\nint byteoff;\r\nxfs_inode_t *dp;\r\nint entsize;\r\nint i;\r\nint newsize;\r\nint oldsize;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ntrace_xfs_dir2_sf_removename(args);\r\ndp = args->dp;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\noldsize = (int)dp->i_d.di_size;\r\nif (oldsize < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(dp->i_mount));\r\nreturn XFS_ERROR(EIO);\r\n}\r\nASSERT(dp->i_df.if_bytes == oldsize);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(oldsize >= xfs_dir2_sf_hdr_size(sfp->i8count));\r\nfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp); i < sfp->count;\r\ni++, sfep = xfs_dir2_sf_nextentry(sfp, sfep)) {\r\nif (xfs_da_compname(args, sfep->name, sfep->namelen) ==\r\nXFS_CMP_EXACT) {\r\nASSERT(xfs_dir2_sfe_get_ino(sfp, sfep) ==\r\nargs->inumber);\r\nbreak;\r\n}\r\n}\r\nif (i == sfp->count)\r\nreturn XFS_ERROR(ENOENT);\r\nbyteoff = (int)((char *)sfep - (char *)sfp);\r\nentsize = xfs_dir2_sf_entsize(sfp, args->namelen);\r\nnewsize = oldsize - entsize;\r\nif (byteoff + entsize < oldsize)\r\nmemmove((char *)sfp + byteoff, (char *)sfp + byteoff + entsize,\r\noldsize - (byteoff + entsize));\r\nsfp->count--;\r\ndp->i_d.di_size = newsize;\r\nxfs_idata_realloc(dp, newsize - oldsize, XFS_DATA_FORK);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\n#if XFS_BIG_INUMS\r\nif (args->inumber > XFS_DIR2_MAX_SHORT_INUM) {\r\nif (sfp->i8count == 1)\r\nxfs_dir2_sf_toino4(args);\r\nelse\r\nsfp->i8count--;\r\n}\r\n#endif\r\nxfs_dir2_sf_check(args);\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_sf_replace(\r\nxfs_da_args_t *args)\r\n{\r\nxfs_inode_t *dp;\r\nint i;\r\n#if XFS_BIG_INUMS || defined(DEBUG)\r\nxfs_ino_t ino=0;\r\n#endif\r\n#if XFS_BIG_INUMS\r\nint i8elevated;\r\n#endif\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ntrace_xfs_dir2_sf_replace(args);\r\ndp = args->dp;\r\nASSERT(dp->i_df.if_flags & XFS_IFINLINE);\r\nif (dp->i_d.di_size < offsetof(xfs_dir2_sf_hdr_t, parent)) {\r\nASSERT(XFS_FORCED_SHUTDOWN(dp->i_mount));\r\nreturn XFS_ERROR(EIO);\r\n}\r\nASSERT(dp->i_df.if_bytes == dp->i_d.di_size);\r\nASSERT(dp->i_df.if_u1.if_data != NULL);\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(dp->i_d.di_size >= xfs_dir2_sf_hdr_size(sfp->i8count));\r\n#if XFS_BIG_INUMS\r\nif (args->inumber > XFS_DIR2_MAX_SHORT_INUM && sfp->i8count == 0) {\r\nint error;\r\nint newsize;\r\nnewsize =\r\ndp->i_df.if_bytes +\r\n(sfp->count + 1) *\r\n((uint)sizeof(xfs_dir2_ino8_t) -\r\n(uint)sizeof(xfs_dir2_ino4_t));\r\nif (newsize > XFS_IFORK_DSIZE(dp)) {\r\nerror = xfs_dir2_sf_to_block(args);\r\nif (error) {\r\nreturn error;\r\n}\r\nreturn xfs_dir2_block_replace(args);\r\n}\r\nxfs_dir2_sf_toino8(args);\r\ni8elevated = 1;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\n} else\r\ni8elevated = 0;\r\n#endif\r\nASSERT(args->namelen != 1 || args->name[0] != '.');\r\nif (args->namelen == 2 &&\r\nargs->name[0] == '.' && args->name[1] == '.') {\r\n#if XFS_BIG_INUMS || defined(DEBUG)\r\nino = xfs_dir2_sf_get_parent_ino(sfp);\r\nASSERT(args->inumber != ino);\r\n#endif\r\nxfs_dir2_sf_put_parent_ino(sfp, args->inumber);\r\n}\r\nelse {\r\nfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp);\r\ni < sfp->count;\r\ni++, sfep = xfs_dir2_sf_nextentry(sfp, sfep)) {\r\nif (xfs_da_compname(args, sfep->name, sfep->namelen) ==\r\nXFS_CMP_EXACT) {\r\n#if XFS_BIG_INUMS || defined(DEBUG)\r\nino = xfs_dir2_sfe_get_ino(sfp, sfep);\r\nASSERT(args->inumber != ino);\r\n#endif\r\nxfs_dir2_sfe_put_ino(sfp, sfep, args->inumber);\r\nbreak;\r\n}\r\n}\r\nif (i == sfp->count) {\r\nASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\r\n#if XFS_BIG_INUMS\r\nif (i8elevated)\r\nxfs_dir2_sf_toino4(args);\r\n#endif\r\nreturn XFS_ERROR(ENOENT);\r\n}\r\n}\r\n#if XFS_BIG_INUMS\r\nif (ino > XFS_DIR2_MAX_SHORT_INUM &&\r\nargs->inumber <= XFS_DIR2_MAX_SHORT_INUM) {\r\nif (sfp->i8count == 1)\r\nxfs_dir2_sf_toino4(args);\r\nelse\r\nsfp->i8count--;\r\n}\r\nif (ino <= XFS_DIR2_MAX_SHORT_INUM &&\r\nargs->inumber > XFS_DIR2_MAX_SHORT_INUM) {\r\nASSERT(sfp->i8count != 0);\r\nif (!i8elevated)\r\nsfp->i8count++;\r\n}\r\n#endif\r\nxfs_dir2_sf_check(args);\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_DDATA);\r\nreturn 0;\r\n}\r\nstatic void\r\nxfs_dir2_sf_toino4(\r\nxfs_da_args_t *args)\r\n{\r\nchar *buf;\r\nxfs_inode_t *dp;\r\nint i;\r\nint newsize;\r\nxfs_dir2_sf_entry_t *oldsfep;\r\nxfs_dir2_sf_hdr_t *oldsfp;\r\nint oldsize;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ntrace_xfs_dir2_sf_toino4(args);\r\ndp = args->dp;\r\noldsize = dp->i_df.if_bytes;\r\nbuf = kmem_alloc(oldsize, KM_SLEEP);\r\noldsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(oldsfp->i8count == 1);\r\nmemcpy(buf, oldsfp, oldsize);\r\nnewsize =\r\noldsize -\r\n(oldsfp->count + 1) *\r\n((uint)sizeof(xfs_dir2_ino8_t) - (uint)sizeof(xfs_dir2_ino4_t));\r\nxfs_idata_realloc(dp, -oldsize, XFS_DATA_FORK);\r\nxfs_idata_realloc(dp, newsize, XFS_DATA_FORK);\r\noldsfp = (xfs_dir2_sf_hdr_t *)buf;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nsfp->count = oldsfp->count;\r\nsfp->i8count = 0;\r\nxfs_dir2_sf_put_parent_ino(sfp, xfs_dir2_sf_get_parent_ino(oldsfp));\r\nfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp),\r\noldsfep = xfs_dir2_sf_firstentry(oldsfp);\r\ni < sfp->count;\r\ni++, sfep = xfs_dir2_sf_nextentry(sfp, sfep),\r\noldsfep = xfs_dir2_sf_nextentry(oldsfp, oldsfep)) {\r\nsfep->namelen = oldsfep->namelen;\r\nsfep->offset = oldsfep->offset;\r\nmemcpy(sfep->name, oldsfep->name, sfep->namelen);\r\nxfs_dir2_sfe_put_ino(sfp, sfep,\r\nxfs_dir2_sfe_get_ino(oldsfp, oldsfep));\r\n}\r\nkmem_free(buf);\r\ndp->i_d.di_size = newsize;\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\r\n}\r\nstatic void\r\nxfs_dir2_sf_toino8(\r\nxfs_da_args_t *args)\r\n{\r\nchar *buf;\r\nxfs_inode_t *dp;\r\nint i;\r\nint newsize;\r\nxfs_dir2_sf_entry_t *oldsfep;\r\nxfs_dir2_sf_hdr_t *oldsfp;\r\nint oldsize;\r\nxfs_dir2_sf_entry_t *sfep;\r\nxfs_dir2_sf_hdr_t *sfp;\r\ntrace_xfs_dir2_sf_toino8(args);\r\ndp = args->dp;\r\noldsize = dp->i_df.if_bytes;\r\nbuf = kmem_alloc(oldsize, KM_SLEEP);\r\noldsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nASSERT(oldsfp->i8count == 0);\r\nmemcpy(buf, oldsfp, oldsize);\r\nnewsize =\r\noldsize +\r\n(oldsfp->count + 1) *\r\n((uint)sizeof(xfs_dir2_ino8_t) - (uint)sizeof(xfs_dir2_ino4_t));\r\nxfs_idata_realloc(dp, -oldsize, XFS_DATA_FORK);\r\nxfs_idata_realloc(dp, newsize, XFS_DATA_FORK);\r\noldsfp = (xfs_dir2_sf_hdr_t *)buf;\r\nsfp = (xfs_dir2_sf_hdr_t *)dp->i_df.if_u1.if_data;\r\nsfp->count = oldsfp->count;\r\nsfp->i8count = 1;\r\nxfs_dir2_sf_put_parent_ino(sfp, xfs_dir2_sf_get_parent_ino(oldsfp));\r\nfor (i = 0, sfep = xfs_dir2_sf_firstentry(sfp),\r\noldsfep = xfs_dir2_sf_firstentry(oldsfp);\r\ni < sfp->count;\r\ni++, sfep = xfs_dir2_sf_nextentry(sfp, sfep),\r\noldsfep = xfs_dir2_sf_nextentry(oldsfp, oldsfep)) {\r\nsfep->namelen = oldsfep->namelen;\r\nsfep->offset = oldsfep->offset;\r\nmemcpy(sfep->name, oldsfep->name, sfep->namelen);\r\nxfs_dir2_sfe_put_ino(sfp, sfep,\r\nxfs_dir2_sfe_get_ino(oldsfp, oldsfep));\r\n}\r\nkmem_free(buf);\r\ndp->i_d.di_size = newsize;\r\nxfs_trans_log_inode(args->trans, dp, XFS_ILOG_CORE | XFS_ILOG_DDATA);\r\n}

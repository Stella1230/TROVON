void\r\nnouveau_irq_preinstall(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nnv_wr32(dev, NV03_PMC_INTR_EN_0, 0);\r\nINIT_LIST_HEAD(&dev_priv->vbl_waiting);\r\n}\r\nint\r\nnouveau_irq_postinstall(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nnv_wr32(dev, NV03_PMC_INTR_EN_0, NV_PMC_INTR_EN_0_MASTER_ENABLE);\r\nif (dev_priv->msi_enabled)\r\nnv_wr08(dev, 0x00088068, 0xff);\r\nreturn 0;\r\n}\r\nvoid\r\nnouveau_irq_uninstall(struct drm_device *dev)\r\n{\r\nnv_wr32(dev, NV03_PMC_INTR_EN_0, 0);\r\n}\r\nirqreturn_t\r\nnouveau_irq_handler(DRM_IRQ_ARGS)\r\n{\r\nstruct drm_device *dev = (struct drm_device *)arg;\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nunsigned long flags;\r\nu32 stat;\r\nint i;\r\nstat = nv_rd32(dev, NV03_PMC_INTR_0);\r\nif (stat == 0 || stat == ~0)\r\nreturn IRQ_NONE;\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\nfor (i = 0; i < 32 && stat; i++) {\r\nif (!(stat & (1 << i)) || !dev_priv->irq_handler[i])\r\ncontinue;\r\ndev_priv->irq_handler[i](dev);\r\nstat &= ~(1 << i);\r\n}\r\nif (dev_priv->msi_enabled)\r\nnv_wr08(dev, 0x00088068, 0xff);\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\nif (stat && nouveau_ratelimit())\r\nNV_ERROR(dev, "PMC - unhandled INTR 0x%08x\n", stat);\r\nreturn IRQ_HANDLED;\r\n}\r\nint\r\nnouveau_irq_init(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nint ret;\r\nif (nouveau_msi != 0 && dev_priv->card_type >= NV_50) {\r\nret = pci_enable_msi(dev->pdev);\r\nif (ret == 0) {\r\nNV_INFO(dev, "enabled MSI\n");\r\ndev_priv->msi_enabled = true;\r\n}\r\n}\r\nreturn drm_irq_install(dev);\r\n}\r\nvoid\r\nnouveau_irq_fini(struct drm_device *dev)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\ndrm_irq_uninstall(dev);\r\nif (dev_priv->msi_enabled)\r\npci_disable_msi(dev->pdev);\r\n}\r\nvoid\r\nnouveau_irq_register(struct drm_device *dev, int status_bit,\r\nvoid (*handler)(struct drm_device *))\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\ndev_priv->irq_handler[status_bit] = handler;\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\n}\r\nvoid\r\nnouveau_irq_unregister(struct drm_device *dev, int status_bit)\r\n{\r\nstruct drm_nouveau_private *dev_priv = dev->dev_private;\r\nunsigned long flags;\r\nspin_lock_irqsave(&dev_priv->context_switch_lock, flags);\r\ndev_priv->irq_handler[status_bit] = NULL;\r\nspin_unlock_irqrestore(&dev_priv->context_switch_lock, flags);\r\n}

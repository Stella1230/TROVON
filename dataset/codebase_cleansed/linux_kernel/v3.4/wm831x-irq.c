static inline int irq_data_to_status_reg(struct wm831x_irq_data *irq_data)\r\n{\r\nreturn WM831X_INTERRUPT_STATUS_1 - 1 + irq_data->reg;\r\n}\r\nstatic inline struct wm831x_irq_data *irq_to_wm831x_irq(struct wm831x *wm831x,\r\nint irq)\r\n{\r\nreturn &wm831x_irqs[irq - wm831x->irq_base];\r\n}\r\nstatic void wm831x_irq_lock(struct irq_data *data)\r\n{\r\nstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&wm831x->irq_lock);\r\n}\r\nstatic void wm831x_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x->gpio_update); i++) {\r\nif (wm831x->gpio_update[i]) {\r\nwm831x_set_bits(wm831x, WM831X_GPIO1_CONTROL + i,\r\nWM831X_GPN_INT_MODE | WM831X_GPN_POL,\r\nwm831x->gpio_update[i]);\r\nwm831x->gpio_update[i] = 0;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm831x->irq_masks_cur); i++) {\r\nif (wm831x->irq_masks_cur[i] != wm831x->irq_masks_cache[i]) {\r\ndev_dbg(wm831x->dev, "IRQ mask sync: %x = %x\n",\r\nWM831X_INTERRUPT_STATUS_1_MASK + i,\r\nwm831x->irq_masks_cur[i]);\r\nwm831x->irq_masks_cache[i] = wm831x->irq_masks_cur[i];\r\nwm831x_reg_write(wm831x,\r\nWM831X_INTERRUPT_STATUS_1_MASK + i,\r\nwm831x->irq_masks_cur[i]);\r\n}\r\n}\r\nmutex_unlock(&wm831x->irq_lock);\r\n}\r\nstatic void wm831x_irq_enable(struct irq_data *data)\r\n{\r\nstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\r\nstruct wm831x_irq_data *irq_data = irq_to_wm831x_irq(wm831x,\r\ndata->irq);\r\nwm831x->irq_masks_cur[irq_data->reg - 1] &= ~irq_data->mask;\r\n}\r\nstatic void wm831x_irq_disable(struct irq_data *data)\r\n{\r\nstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\r\nstruct wm831x_irq_data *irq_data = irq_to_wm831x_irq(wm831x,\r\ndata->irq);\r\nwm831x->irq_masks_cur[irq_data->reg - 1] |= irq_data->mask;\r\n}\r\nstatic int wm831x_irq_set_type(struct irq_data *data, unsigned int type)\r\n{\r\nstruct wm831x *wm831x = irq_data_get_irq_chip_data(data);\r\nint irq;\r\nirq = data->irq - wm831x->irq_base;\r\nif (irq < WM831X_IRQ_GPIO_1 || irq > WM831X_IRQ_GPIO_11) {\r\nif (irq >= 0 && irq < WM831X_NUM_IRQS)\r\nreturn 0;\r\nelse\r\nreturn -EINVAL;\r\n}\r\nirq -= WM831X_IRQ_GPIO_1;\r\nswitch (type) {\r\ncase IRQ_TYPE_EDGE_BOTH:\r\nwm831x->gpio_update[irq] = 0x10000 | WM831X_GPN_INT_MODE;\r\nwm831x->gpio_level[irq] = false;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_RISING:\r\nwm831x->gpio_update[irq] = 0x10000 | WM831X_GPN_POL;\r\nwm831x->gpio_level[irq] = false;\r\nbreak;\r\ncase IRQ_TYPE_EDGE_FALLING:\r\nwm831x->gpio_update[irq] = 0x10000;\r\nwm831x->gpio_level[irq] = false;\r\nbreak;\r\ncase IRQ_TYPE_LEVEL_HIGH:\r\nwm831x->gpio_update[irq] = 0x10000 | WM831X_GPN_POL;\r\nwm831x->gpio_level[irq] = true;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic irqreturn_t wm831x_irq_thread(int irq, void *data)\r\n{\r\nstruct wm831x *wm831x = data;\r\nunsigned int i;\r\nint primary, status_addr, ret;\r\nint status_regs[WM831X_NUM_IRQ_REGS] = { 0 };\r\nint read[WM831X_NUM_IRQ_REGS] = { 0 };\r\nint *status;\r\nprimary = wm831x_reg_read(wm831x, WM831X_SYSTEM_INTERRUPTS);\r\nif (primary < 0) {\r\ndev_err(wm831x->dev, "Failed to read system interrupt: %d\n",\r\nprimary);\r\ngoto out;\r\n}\r\nif (primary & WM831X_TCHPD_INT)\r\nhandle_nested_irq(wm831x->irq_base + WM831X_IRQ_TCHPD);\r\nif (primary & WM831X_TCHDATA_INT)\r\nhandle_nested_irq(wm831x->irq_base + WM831X_IRQ_TCHDATA);\r\nprimary &= ~(WM831X_TCHDATA_EINT | WM831X_TCHPD_EINT);\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_irqs); i++) {\r\nint offset = wm831x_irqs[i].reg - 1;\r\nif (!(primary & wm831x_irqs[i].primary))\r\ncontinue;\r\nstatus = &status_regs[offset];\r\nif (!read[offset]) {\r\nstatus_addr = irq_data_to_status_reg(&wm831x_irqs[i]);\r\n*status = wm831x_reg_read(wm831x, status_addr);\r\nif (*status < 0) {\r\ndev_err(wm831x->dev,\r\n"Failed to read IRQ status: %d\n",\r\n*status);\r\ngoto out;\r\n}\r\nread[offset] = 1;\r\n*status &= ~wm831x->irq_masks_cur[offset];\r\nwm831x_reg_write(wm831x, status_addr, *status);\r\n}\r\nif (*status & wm831x_irqs[i].mask)\r\nhandle_nested_irq(wm831x->irq_base + i);\r\nif (primary == WM831X_GP_INT &&\r\nwm831x->gpio_level[i - WM831X_IRQ_GPIO_1]) {\r\nret = wm831x_reg_read(wm831x, WM831X_GPIO_LEVEL);\r\nwhile (ret & 1 << (i - WM831X_IRQ_GPIO_1)) {\r\nhandle_nested_irq(wm831x->irq_base + i);\r\nret = wm831x_reg_read(wm831x,\r\nWM831X_GPIO_LEVEL);\r\n}\r\n}\r\n}\r\nout:\r\nreturn IRQ_HANDLED;\r\n}\r\nint wm831x_irq_init(struct wm831x *wm831x, int irq)\r\n{\r\nstruct wm831x_pdata *pdata = wm831x->dev->platform_data;\r\nint i, cur_irq, ret;\r\nmutex_init(&wm831x->irq_lock);\r\nfor (i = 0; i < ARRAY_SIZE(wm831x->irq_masks_cur); i++) {\r\nwm831x->irq_masks_cur[i] = 0xffff;\r\nwm831x->irq_masks_cache[i] = 0xffff;\r\nwm831x_reg_write(wm831x, WM831X_INTERRUPT_STATUS_1_MASK + i,\r\n0xffff);\r\n}\r\nif (!pdata || !pdata->irq_base)\r\nwm831x->irq_base = -1;\r\nelse\r\nwm831x->irq_base = pdata->irq_base;\r\nwm831x->irq_base = irq_alloc_descs(wm831x->irq_base, 0,\r\nWM831X_NUM_IRQS, 0);\r\nif (wm831x->irq_base < 0) {\r\ndev_warn(wm831x->dev, "Failed to allocate IRQs: %d\n",\r\nwm831x->irq_base);\r\nwm831x->irq_base = 0;\r\nreturn 0;\r\n}\r\nif (pdata && pdata->irq_cmos)\r\ni = 0;\r\nelse\r\ni = WM831X_IRQ_OD;\r\nwm831x_set_bits(wm831x, WM831X_IRQ_CONFIG,\r\nWM831X_IRQ_OD, i);\r\nret = enable_irq_wake(irq);\r\nif (ret != 0) {\r\ndev_warn(wm831x->dev, "Can't enable IRQ as wake source: %d\n",\r\nret);\r\n}\r\nwm831x->irq = irq;\r\nfor (cur_irq = wm831x->irq_base;\r\ncur_irq < ARRAY_SIZE(wm831x_irqs) + wm831x->irq_base;\r\ncur_irq++) {\r\nirq_set_chip_data(cur_irq, wm831x);\r\nirq_set_chip_and_handler(cur_irq, &wm831x_irq_chip,\r\nhandle_edge_irq);\r\nirq_set_nested_thread(cur_irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(cur_irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(cur_irq);\r\n#endif\r\n}\r\nif (irq) {\r\nret = request_threaded_irq(irq, NULL, wm831x_irq_thread,\r\nIRQF_TRIGGER_LOW | IRQF_ONESHOT,\r\n"wm831x", wm831x);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to request IRQ %d: %d\n",\r\nirq, ret);\r\nreturn ret;\r\n}\r\n} else {\r\ndev_warn(wm831x->dev,\r\n"No interrupt specified - functionality limited\n");\r\n}\r\nwm831x_reg_write(wm831x, WM831X_SYSTEM_INTERRUPTS_MASK, 0);\r\nreturn 0;\r\n}\r\nvoid wm831x_irq_exit(struct wm831x *wm831x)\r\n{\r\nif (wm831x->irq)\r\nfree_irq(wm831x->irq, wm831x);\r\n}

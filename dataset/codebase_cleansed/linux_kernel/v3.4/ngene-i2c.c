static int ngene_command_i2c_read(struct ngene *dev, u8 adr,\r\nu8 *out, u8 outlen, u8 *in, u8 inlen, int flag)\r\n{\r\nstruct ngene_command com;\r\ncom.cmd.hdr.Opcode = CMD_I2C_READ;\r\ncom.cmd.hdr.Length = outlen + 3;\r\ncom.cmd.I2CRead.Device = adr << 1;\r\nmemcpy(com.cmd.I2CRead.Data, out, outlen);\r\ncom.cmd.I2CRead.Data[outlen] = inlen;\r\ncom.cmd.I2CRead.Data[outlen + 1] = 0;\r\ncom.in_len = outlen + 3;\r\ncom.out_len = inlen + 1;\r\nif (ngene_command(dev, &com) < 0)\r\nreturn -EIO;\r\nif ((com.cmd.raw8[0] >> 1) != adr)\r\nreturn -EIO;\r\nif (flag)\r\nmemcpy(in, com.cmd.raw8, inlen + 1);\r\nelse\r\nmemcpy(in, com.cmd.raw8 + 1, inlen);\r\nreturn 0;\r\n}\r\nstatic int ngene_command_i2c_write(struct ngene *dev, u8 adr,\r\nu8 *out, u8 outlen)\r\n{\r\nstruct ngene_command com;\r\ncom.cmd.hdr.Opcode = CMD_I2C_WRITE;\r\ncom.cmd.hdr.Length = outlen + 1;\r\ncom.cmd.I2CRead.Device = adr << 1;\r\nmemcpy(com.cmd.I2CRead.Data, out, outlen);\r\ncom.in_len = outlen + 1;\r\ncom.out_len = 1;\r\nif (ngene_command(dev, &com) < 0)\r\nreturn -EIO;\r\nif (com.cmd.raw8[0] == 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic void ngene_i2c_set_bus(struct ngene *dev, int bus)\r\n{\r\nif (!(dev->card_info->i2c_access & 2))\r\nreturn;\r\nif (dev->i2c_current_bus == bus)\r\nreturn;\r\nswitch (bus) {\r\ncase 0:\r\nngene_command_gpio_set(dev, 3, 0);\r\nngene_command_gpio_set(dev, 2, 1);\r\nbreak;\r\ncase 1:\r\nngene_command_gpio_set(dev, 2, 0);\r\nngene_command_gpio_set(dev, 3, 1);\r\nbreak;\r\n}\r\ndev->i2c_current_bus = bus;\r\n}\r\nstatic int ngene_i2c_master_xfer(struct i2c_adapter *adapter,\r\nstruct i2c_msg msg[], int num)\r\n{\r\nstruct ngene_channel *chan =\r\n(struct ngene_channel *)i2c_get_adapdata(adapter);\r\nstruct ngene *dev = chan->dev;\r\ndown(&dev->i2c_switch_mutex);\r\nngene_i2c_set_bus(dev, chan->number);\r\nif (num == 2 && msg[1].flags & I2C_M_RD && !(msg[0].flags & I2C_M_RD))\r\nif (!ngene_command_i2c_read(dev, msg[0].addr,\r\nmsg[0].buf, msg[0].len,\r\nmsg[1].buf, msg[1].len, 0))\r\ngoto done;\r\nif (num == 1 && !(msg[0].flags & I2C_M_RD))\r\nif (!ngene_command_i2c_write(dev, msg[0].addr,\r\nmsg[0].buf, msg[0].len))\r\ngoto done;\r\nif (num == 1 && (msg[0].flags & I2C_M_RD))\r\nif (!ngene_command_i2c_read(dev, msg[0].addr, NULL, 0,\r\nmsg[0].buf, msg[0].len, 0))\r\ngoto done;\r\nup(&dev->i2c_switch_mutex);\r\nreturn -EIO;\r\ndone:\r\nup(&dev->i2c_switch_mutex);\r\nreturn num;\r\n}\r\nstatic u32 ngene_i2c_functionality(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_SMBUS_EMUL;\r\n}\r\nint ngene_i2c_init(struct ngene *dev, int dev_nr)\r\n{\r\nstruct i2c_adapter *adap = &(dev->channel[dev_nr].i2c_adapter);\r\ni2c_set_adapdata(adap, &(dev->channel[dev_nr]));\r\nstrcpy(adap->name, "nGene");\r\nadap->algo = &ngene_i2c_algo;\r\nadap->algo_data = (void *)&(dev->channel[dev_nr]);\r\nadap->dev.parent = &dev->pci_dev->dev;\r\nreturn i2c_add_adapter(adap);\r\n}

static u8 sis_ata133_get_base(ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu32 reg54 = 0;\r\npci_read_config_dword(dev, 0x54, &reg54);\r\nreturn ((reg54 & 0x40000000) ? 0x70 : 0x40) + drive->dn * 4;\r\n}\r\nstatic void sis_ata16_program_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu16 t1 = 0;\r\nu8 drive_pci = 0x40 + drive->dn * 2;\r\nconst u16 pio_timings[] = { 0x000, 0x607, 0x404, 0x303, 0x301 };\r\nconst u16 mwdma_timings[] = { 0x008, 0x302, 0x301 };\r\npci_read_config_word(dev, drive_pci, &t1);\r\nt1 &= ~0x070f;\r\nif (mode >= XFER_MW_DMA_0) {\r\nif (chipset_family > ATA_16)\r\nt1 &= ~0x8000;\r\nt1 |= mwdma_timings[mode - XFER_MW_DMA_0];\r\n} else\r\nt1 |= pio_timings[mode - XFER_PIO_0];\r\npci_write_config_word(dev, drive_pci, t1);\r\n}\r\nstatic void sis_ata100_program_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu8 t1, drive_pci = 0x40 + drive->dn * 2;\r\nconst u8 pio_timings[] = { 0x00, 0x67, 0x44, 0x33, 0x31 };\r\nconst u8 mwdma_timings[] = { 0x08, 0x32, 0x31 };\r\nif (mode >= XFER_MW_DMA_0) {\r\nu8 t2 = 0;\r\npci_read_config_byte(dev, drive_pci, &t2);\r\nt2 &= ~0x80;\r\npci_write_config_byte(dev, drive_pci, t2);\r\nt1 = mwdma_timings[mode - XFER_MW_DMA_0];\r\n} else\r\nt1 = pio_timings[mode - XFER_PIO_0];\r\npci_write_config_byte(dev, drive_pci + 1, t1);\r\n}\r\nstatic void sis_ata133_program_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu32 t1 = 0;\r\nu8 drive_pci = sis_ata133_get_base(drive), clk, idx;\r\npci_read_config_dword(dev, drive_pci, &t1);\r\nt1 &= 0xc0c00fff;\r\nclk = (t1 & 0x08) ? ATA_133 : ATA_100;\r\nif (mode >= XFER_MW_DMA_0) {\r\nt1 &= ~0x04;\r\nidx = mode - XFER_MW_DMA_0 + 5;\r\n} else\r\nidx = mode - XFER_PIO_0;\r\nt1 |= ini_time_value[clk][idx] << 12;\r\nt1 |= act_time_value[clk][idx] << 16;\r\nt1 |= rco_time_value[clk][idx] << 24;\r\npci_write_config_dword(dev, drive_pci, t1);\r\n}\r\nstatic void sis_program_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nif (chipset_family < ATA_100)\r\nsis_ata16_program_timings(drive, mode);\r\nelse if (chipset_family < ATA_133)\r\nsis_ata100_program_timings(drive, mode);\r\nelse\r\nsis_ata133_program_timings(drive, mode);\r\n}\r\nstatic void config_drive_art_rwp(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu8 reg4bh = 0;\r\nu8 rw_prefetch = 0;\r\npci_read_config_byte(dev, 0x4b, &reg4bh);\r\nrw_prefetch = reg4bh & ~(0x11 << drive->dn);\r\nif (drive->media == ide_disk)\r\nrw_prefetch |= 0x11 << drive->dn;\r\nif (reg4bh != rw_prefetch)\r\npci_write_config_byte(dev, 0x4b, rw_prefetch);\r\n}\r\nstatic void sis_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nconfig_drive_art_rwp(drive);\r\nsis_program_timings(drive, drive->pio_mode);\r\n}\r\nstatic void sis_ata133_program_udma_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu32 regdw = 0;\r\nu8 drive_pci = sis_ata133_get_base(drive), clk, idx;\r\npci_read_config_dword(dev, drive_pci, &regdw);\r\nregdw |= 0x04;\r\nregdw &= 0xfffff00f;\r\nclk = (regdw & 0x08) ? ATA_133 : ATA_100;\r\nidx = mode - XFER_UDMA_0;\r\nregdw |= cycle_time_value[clk][idx] << 4;\r\nregdw |= cvs_time_value[clk][idx] << 8;\r\npci_write_config_dword(dev, drive_pci, regdw);\r\n}\r\nstatic void sis_ata33_program_udma_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu8 drive_pci = 0x40 + drive->dn * 2, reg = 0, i = chipset_family;\r\npci_read_config_byte(dev, drive_pci + 1, &reg);\r\nreg |= 0x80;\r\nreg &= ~((0xff >> (8 - cycle_time_range[i])) << cycle_time_offset[i]);\r\nreg |= cycle_time_value[i][mode - XFER_UDMA_0] << cycle_time_offset[i];\r\npci_write_config_byte(dev, drive_pci + 1, reg);\r\n}\r\nstatic void sis_program_udma_timings(ide_drive_t *drive, const u8 mode)\r\n{\r\nif (chipset_family >= ATA_133)\r\nsis_ata133_program_udma_timings(drive, mode);\r\nelse\r\nsis_ata33_program_udma_timings(drive, mode);\r\n}\r\nstatic void sis_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nconst u8 speed = drive->dma_mode;\r\nif (speed >= XFER_UDMA_0)\r\nsis_program_udma_timings(drive, speed);\r\nelse\r\nsis_program_timings(drive, speed);\r\n}\r\nstatic u8 sis_ata133_udma_filter(ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(drive->hwif->dev);\r\nu32 regdw = 0;\r\nu8 drive_pci = sis_ata133_get_base(drive);\r\npci_read_config_dword(dev, drive_pci, &regdw);\r\nreturn (regdw & 0x08) ? ATA_UDMA6 : ATA_UDMA5;\r\n}\r\nstatic int __devinit sis_find_family(struct pci_dev *dev)\r\n{\r\nstruct pci_dev *host;\r\nint i = 0;\r\nchipset_family = 0;\r\nfor (i = 0; i < ARRAY_SIZE(SiSHostChipInfo) && !chipset_family; i++) {\r\nhost = pci_get_device(PCI_VENDOR_ID_SI, SiSHostChipInfo[i].host_id, NULL);\r\nif (!host)\r\ncontinue;\r\nchipset_family = SiSHostChipInfo[i].chipset_family;\r\nif (SiSHostChipInfo[i].host_id == PCI_DEVICE_ID_SI_630) {\r\nif (host->revision >= 0x30)\r\nchipset_family = ATA_100a;\r\n}\r\npci_dev_put(host);\r\nprintk(KERN_INFO DRV_NAME " %s: %s %s controller\n",\r\npci_name(dev), SiSHostChipInfo[i].name,\r\nchipset_capability[chipset_family]);\r\n}\r\nif (!chipset_family) {\r\nu32 idemisc;\r\nu16 trueid;\r\npci_read_config_dword(dev, 0x54, &idemisc);\r\npci_write_config_dword(dev, 0x54, (idemisc & 0x7fffffff));\r\npci_read_config_word(dev, PCI_DEVICE_ID, &trueid);\r\npci_write_config_dword(dev, 0x54, idemisc);\r\nif (trueid == 0x5518) {\r\nprintk(KERN_INFO DRV_NAME " %s: SiS 962/963 MuTIOL IDE UDMA133 controller\n",\r\npci_name(dev));\r\nchipset_family = ATA_133;\r\nif ((idemisc & 0x40000000) == 0) {\r\npci_write_config_dword(dev, 0x54, idemisc | 0x40000000);\r\nprintk(KERN_INFO DRV_NAME " %s: Switching to 5513 register mapping\n",\r\npci_name(dev));\r\n}\r\n}\r\n}\r\nif (!chipset_family) {\r\nstruct pci_dev *lpc_bridge;\r\nu16 trueid;\r\nu8 prefctl;\r\nu8 idecfg;\r\npci_read_config_byte(dev, 0x4a, &idecfg);\r\npci_write_config_byte(dev, 0x4a, idecfg | 0x10);\r\npci_read_config_word(dev, PCI_DEVICE_ID, &trueid);\r\npci_write_config_byte(dev, 0x4a, idecfg);\r\nif (trueid == 0x5517) {\r\nlpc_bridge = pci_get_slot(dev->bus, 0x10);\r\npci_read_config_byte(dev, 0x49, &prefctl);\r\npci_dev_put(lpc_bridge);\r\nif (lpc_bridge->revision == 0x10 && (prefctl & 0x80)) {\r\nprintk(KERN_INFO DRV_NAME " %s: SiS 961B MuTIOL IDE UDMA133 controller\n",\r\npci_name(dev));\r\nchipset_family = ATA_133a;\r\n} else {\r\nprintk(KERN_INFO DRV_NAME " %s: SiS 961 MuTIOL IDE UDMA100 controller\n",\r\npci_name(dev));\r\nchipset_family = ATA_100;\r\n}\r\n}\r\n}\r\nreturn chipset_family;\r\n}\r\nstatic int init_chipset_sis5513(struct pci_dev *dev)\r\n{\r\nu8 reg;\r\nu16 regw;\r\nswitch (chipset_family) {\r\ncase ATA_133:\r\npci_read_config_word(dev, 0x50, &regw);\r\nif (regw & 0x08)\r\npci_write_config_word(dev, 0x50, regw&0xfff7);\r\npci_read_config_word(dev, 0x52, &regw);\r\nif (regw & 0x08)\r\npci_write_config_word(dev, 0x52, regw&0xfff7);\r\nbreak;\r\ncase ATA_133a:\r\ncase ATA_100:\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, 0x80);\r\npci_read_config_byte(dev, 0x49, &reg);\r\nif (!(reg & 0x01))\r\npci_write_config_byte(dev, 0x49, reg|0x01);\r\nbreak;\r\ncase ATA_100a:\r\ncase ATA_66:\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, 0x10);\r\npci_read_config_byte(dev, 0x52, &reg);\r\nif (!(reg & 0x04))\r\npci_write_config_byte(dev, 0x52, reg|0x04);\r\nbreak;\r\ncase ATA_33:\r\npci_read_config_byte(dev, 0x09, &reg);\r\nif ((reg & 0x0f) != 0x00)\r\npci_write_config_byte(dev, 0x09, reg&0xf0);\r\ncase ATA_16:\r\npci_read_config_byte(dev, 0x52, &reg);\r\nif (!(reg & 0x08))\r\npci_write_config_byte(dev, 0x52, reg|0x08);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic u8 sis_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nconst struct sis_laptop *lap = &sis_laptop[0];\r\nu8 ata66 = 0;\r\nwhile (lap->device) {\r\nif (lap->device == pdev->device &&\r\nlap->subvendor == pdev->subsystem_vendor &&\r\nlap->subdevice == pdev->subsystem_device)\r\nreturn ATA_CBL_PATA40_SHORT;\r\nlap++;\r\n}\r\nif (chipset_family >= ATA_133) {\r\nu16 regw = 0;\r\nu16 reg_addr = hwif->channel ? 0x52: 0x50;\r\npci_read_config_word(pdev, reg_addr, &regw);\r\nata66 = (regw & 0x8000) ? 0 : 1;\r\n} else if (chipset_family >= ATA_66) {\r\nu8 reg48h = 0;\r\nu8 mask = hwif->channel ? 0x20 : 0x10;\r\npci_read_config_byte(pdev, 0x48, &reg48h);\r\nata66 = (reg48h & mask) ? 0 : 1;\r\n}\r\nreturn ata66 ? ATA_CBL_PATA80 : ATA_CBL_PATA40;\r\n}\r\nstatic int __devinit sis5513_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstruct ide_port_info d = sis5513_chipset;\r\nu8 udma_rates[] = { 0x00, 0x00, 0x07, 0x1f, 0x3f, 0x3f, 0x7f, 0x7f };\r\nint rc;\r\nrc = pci_enable_device(dev);\r\nif (rc)\r\nreturn rc;\r\nif (sis_find_family(dev) == 0)\r\nreturn -ENOTSUPP;\r\nif (chipset_family >= ATA_133)\r\nd.port_ops = &sis_ata133_port_ops;\r\nelse\r\nd.port_ops = &sis_port_ops;\r\nd.udma_mask = udma_rates[chipset_family];\r\nreturn ide_pci_init_one(dev, &d, NULL);\r\n}\r\nstatic void __devexit sis5513_remove(struct pci_dev *dev)\r\n{\r\nide_pci_remove(dev);\r\npci_disable_device(dev);\r\n}\r\nstatic int __init sis5513_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&sis5513_pci_driver);\r\n}\r\nstatic void __exit sis5513_ide_exit(void)\r\n{\r\npci_unregister_driver(&sis5513_pci_driver);\r\n}

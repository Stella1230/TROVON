void llc_add_pack(int type, void (*handler)(struct llc_sap *sap,\r\nstruct sk_buff *skb))\r\n{\r\nif (type == LLC_DEST_SAP || type == LLC_DEST_CONN)\r\nllc_type_handlers[type - 1] = handler;\r\n}\r\nvoid llc_remove_pack(int type)\r\n{\r\nif (type == LLC_DEST_SAP || type == LLC_DEST_CONN)\r\nllc_type_handlers[type - 1] = NULL;\r\n}\r\nvoid llc_set_station_handler(void (*handler)(struct sk_buff *skb))\r\n{\r\nllc_station_handler = handler;\r\n}\r\nstatic __inline__ int llc_pdu_type(struct sk_buff *skb)\r\n{\r\nint type = LLC_DEST_CONN;\r\nstruct llc_pdu_sn *pdu = llc_pdu_sn_hdr(skb);\r\nif ((pdu->ctrl_1 & LLC_PDU_TYPE_MASK) != LLC_PDU_TYPE_U)\r\ngoto out;\r\nswitch (LLC_U_PDU_CMD(pdu)) {\r\ncase LLC_1_PDU_CMD_XID:\r\ncase LLC_1_PDU_CMD_UI:\r\ncase LLC_1_PDU_CMD_TEST:\r\ntype = LLC_DEST_SAP;\r\nbreak;\r\ncase LLC_2_PDU_CMD_SABME:\r\ncase LLC_2_PDU_CMD_DISC:\r\ncase LLC_2_PDU_RSP_UA:\r\ncase LLC_2_PDU_RSP_DM:\r\ncase LLC_2_PDU_RSP_FRMR:\r\nbreak;\r\ndefault:\r\ntype = LLC_DEST_INVALID;\r\nbreak;\r\n}\r\nout:\r\nreturn type;\r\n}\r\nstatic inline int llc_fixup_skb(struct sk_buff *skb)\r\n{\r\nu8 llc_len = 2;\r\nstruct llc_pdu_un *pdu;\r\nif (unlikely(!pskb_may_pull(skb, sizeof(*pdu))))\r\nreturn 0;\r\npdu = (struct llc_pdu_un *)skb->data;\r\nif ((pdu->ctrl_1 & LLC_PDU_TYPE_MASK) == LLC_PDU_TYPE_U)\r\nllc_len = 1;\r\nllc_len += 2;\r\nif (unlikely(!pskb_may_pull(skb, llc_len)))\r\nreturn 0;\r\nskb->transport_header += llc_len;\r\nskb_pull(skb, llc_len);\r\nif (skb->protocol == htons(ETH_P_802_2)) {\r\n__be16 pdulen = eth_hdr(skb)->h_proto;\r\ns32 data_size = ntohs(pdulen) - llc_len;\r\nif (data_size < 0 ||\r\n!pskb_may_pull(skb, data_size))\r\nreturn 0;\r\nif (unlikely(pskb_trim_rcsum(skb, data_size)))\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nint llc_rcv(struct sk_buff *skb, struct net_device *dev,\r\nstruct packet_type *pt, struct net_device *orig_dev)\r\n{\r\nstruct llc_sap *sap;\r\nstruct llc_pdu_sn *pdu;\r\nint dest;\r\nint (*rcv)(struct sk_buff *, struct net_device *,\r\nstruct packet_type *, struct net_device *);\r\nif (!net_eq(dev_net(dev), &init_net))\r\ngoto drop;\r\nif (unlikely(skb->pkt_type == PACKET_OTHERHOST)) {\r\ndprintk("%s: PACKET_OTHERHOST\n", __func__);\r\ngoto drop;\r\n}\r\nskb = skb_share_check(skb, GFP_ATOMIC);\r\nif (unlikely(!skb))\r\ngoto out;\r\nif (unlikely(!llc_fixup_skb(skb)))\r\ngoto drop;\r\npdu = llc_pdu_sn_hdr(skb);\r\nif (unlikely(!pdu->dsap))\r\ngoto handle_station;\r\nsap = llc_sap_find(pdu->dsap);\r\nif (unlikely(!sap)) {\r\ndprintk("%s: llc_sap_find(%02X) failed!\n", __func__,\r\npdu->dsap);\r\ngoto drop;\r\n}\r\nrcv = rcu_dereference(sap->rcv_func);\r\ndest = llc_pdu_type(skb);\r\nif (unlikely(!dest || !llc_type_handlers[dest - 1])) {\r\nif (rcv)\r\nrcv(skb, dev, pt, orig_dev);\r\nelse\r\nkfree_skb(skb);\r\n} else {\r\nif (rcv) {\r\nstruct sk_buff *cskb = skb_clone(skb, GFP_ATOMIC);\r\nif (cskb)\r\nrcv(cskb, dev, pt, orig_dev);\r\n}\r\nllc_type_handlers[dest - 1](sap, skb);\r\n}\r\nllc_sap_put(sap);\r\nout:\r\nreturn 0;\r\ndrop:\r\nkfree_skb(skb);\r\ngoto out;\r\nhandle_station:\r\nif (!llc_station_handler)\r\ngoto drop;\r\nllc_station_handler(skb);\r\ngoto out;\r\n}

static int ad5791_spi_write(struct spi_device *spi, u8 addr, u32 val)\r\n{\r\nunion {\r\nu32 d32;\r\nu8 d8[4];\r\n} data;\r\ndata.d32 = cpu_to_be32(AD5791_CMD_WRITE |\r\nAD5791_ADDR(addr) |\r\n(val & AD5791_DAC_MASK));\r\nreturn spi_write(spi, &data.d8[1], 3);\r\n}\r\nstatic int ad5791_spi_read(struct spi_device *spi, u8 addr, u32 *val)\r\n{\r\nunion {\r\nu32 d32;\r\nu8 d8[4];\r\n} data[3];\r\nint ret;\r\nstruct spi_message msg;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = &data[0].d8[1],\r\n.bits_per_word = 8,\r\n.len = 3,\r\n.cs_change = 1,\r\n}, {\r\n.tx_buf = &data[1].d8[1],\r\n.rx_buf = &data[2].d8[1],\r\n.bits_per_word = 8,\r\n.len = 3,\r\n},\r\n};\r\ndata[0].d32 = cpu_to_be32(AD5791_CMD_READ |\r\nAD5791_ADDR(addr));\r\ndata[1].d32 = cpu_to_be32(AD5791_ADDR(AD5791_ADDR_NOOP));\r\nspi_message_init(&msg);\r\nspi_message_add_tail(&xfers[0], &msg);\r\nspi_message_add_tail(&xfers[1], &msg);\r\nret = spi_sync(spi, &msg);\r\n*val = be32_to_cpu(data[2].d32);\r\nreturn ret;\r\n}\r\nstatic ssize_t ad5791_read_powerdown_mode(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\nconst char mode[][14] = {"6kohm_to_gnd", "three_state"};\r\nreturn sprintf(buf, "%s\n", mode[st->pwr_down_mode]);\r\n}\r\nstatic ssize_t ad5791_write_powerdown_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\nint ret;\r\nif (sysfs_streq(buf, "6kohm_to_gnd"))\r\nst->pwr_down_mode = AD5791_DAC_PWRDN_6K;\r\nelse if (sysfs_streq(buf, "three_state"))\r\nst->pwr_down_mode = AD5791_DAC_PWRDN_3STATE;\r\nelse\r\nret = -EINVAL;\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ad5791_read_dac_powerdown(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\nreturn sprintf(buf, "%d\n", st->pwr_down);\r\n}\r\nstatic ssize_t ad5791_write_dac_powerdown(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nlong readin;\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\nret = strict_strtol(buf, 10, &readin);\r\nif (ret)\r\nreturn ret;\r\nif (readin == 0) {\r\nst->pwr_down = false;\r\nst->ctrl &= ~(AD5791_CTRL_OPGND | AD5791_CTRL_DACTRI);\r\n} else if (readin == 1) {\r\nst->pwr_down = true;\r\nif (st->pwr_down_mode == AD5791_DAC_PWRDN_6K)\r\nst->ctrl |= AD5791_CTRL_OPGND;\r\nelse if (st->pwr_down_mode == AD5791_DAC_PWRDN_3STATE)\r\nst->ctrl |= AD5791_CTRL_DACTRI;\r\n} else\r\nret = -EINVAL;\r\nret = ad5791_spi_write(st->spi, AD5791_ADDR_CTRL, st->ctrl);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ad5791_get_lin_comp(unsigned int span)\r\n{\r\nif (span <= 10000)\r\nreturn AD5791_LINCOMP_0_10;\r\nelse if (span <= 12000)\r\nreturn AD5791_LINCOMP_10_12;\r\nelse if (span <= 16000)\r\nreturn AD5791_LINCOMP_12_16;\r\nelse if (span <= 19000)\r\nreturn AD5791_LINCOMP_16_19;\r\nelse\r\nreturn AD5791_LINCOMP_19_20;\r\n}\r\nstatic int ad5780_get_lin_comp(unsigned int span)\r\n{\r\nif (span <= 10000)\r\nreturn AD5780_LINCOMP_0_10;\r\nelse\r\nreturn AD5780_LINCOMP_10_20;\r\n}\r\nstatic int ad5791_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\nu64 val64;\r\nint ret;\r\nswitch (m) {\r\ncase 0:\r\nret = ad5791_spi_read(st->spi, chan->address, val);\r\nif (ret)\r\nreturn ret;\r\n*val &= AD5791_DAC_MASK;\r\n*val >>= chan->scan_type.shift;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = 0;\r\n*val2 = (((u64)st->vref_mv) * 1000000ULL) >> chan->scan_type.realbits;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\ncase IIO_CHAN_INFO_OFFSET:\r\nval64 = (((u64)st->vref_neg_mv) << chan->scan_type.realbits);\r\ndo_div(val64, st->vref_mv);\r\n*val = -val64;\r\nreturn IIO_VAL_INT;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int ad5791_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\nswitch (mask) {\r\ncase 0:\r\nval &= AD5791_RES_MASK(chan->scan_type.realbits);\r\nval <<= chan->scan_type.shift;\r\nreturn ad5791_spi_write(st->spi, chan->address, val);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int __devinit ad5791_probe(struct spi_device *spi)\r\n{\r\nstruct ad5791_platform_data *pdata = spi->dev.platform_data;\r\nstruct iio_dev *indio_dev;\r\nstruct ad5791_state *st;\r\nint ret, pos_voltage_uv = 0, neg_voltage_uv = 0;\r\nindio_dev = iio_allocate_device(sizeof(*st));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nst = iio_priv(indio_dev);\r\nst->reg_vdd = regulator_get(&spi->dev, "vdd");\r\nif (!IS_ERR(st->reg_vdd)) {\r\nret = regulator_enable(st->reg_vdd);\r\nif (ret)\r\ngoto error_put_reg_pos;\r\npos_voltage_uv = regulator_get_voltage(st->reg_vdd);\r\n}\r\nst->reg_vss = regulator_get(&spi->dev, "vss");\r\nif (!IS_ERR(st->reg_vss)) {\r\nret = regulator_enable(st->reg_vss);\r\nif (ret)\r\ngoto error_put_reg_neg;\r\nneg_voltage_uv = regulator_get_voltage(st->reg_vss);\r\n}\r\nst->pwr_down = true;\r\nst->spi = spi;\r\nif (!IS_ERR(st->reg_vss) && !IS_ERR(st->reg_vdd)) {\r\nst->vref_mv = (pos_voltage_uv + neg_voltage_uv) / 1000;\r\nst->vref_neg_mv = neg_voltage_uv / 1000;\r\n} else if (pdata) {\r\nst->vref_mv = pdata->vref_pos_mv + pdata->vref_neg_mv;\r\nst->vref_neg_mv = pdata->vref_neg_mv;\r\n} else {\r\ndev_warn(&spi->dev, "reference voltage unspecified\n");\r\n}\r\nret = ad5791_spi_write(spi, AD5791_ADDR_SW_CTRL, AD5791_SWCTRL_RESET);\r\nif (ret)\r\ngoto error_disable_reg_neg;\r\nst->chip_info = &ad5791_chip_info_tbl[spi_get_device_id(spi)\r\n->driver_data];\r\nst->ctrl = AD5761_CTRL_LINCOMP(st->chip_info->get_lin_comp(st->vref_mv))\r\n| ((pdata && pdata->use_rbuf_gain2) ? 0 : AD5791_CTRL_RBUF) |\r\nAD5791_CTRL_BIN2SC;\r\nret = ad5791_spi_write(spi, AD5791_ADDR_CTRL, st->ctrl |\r\nAD5791_CTRL_OPGND | AD5791_CTRL_DACTRI);\r\nif (ret)\r\ngoto error_disable_reg_neg;\r\nspi_set_drvdata(spi, indio_dev);\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &ad5791_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels\r\n= &ad5791_channels[spi_get_device_id(spi)->driver_data];\r\nindio_dev->num_channels = 1;\r\nindio_dev->name = spi_get_device_id(st->spi)->name;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_disable_reg_neg;\r\nreturn 0;\r\nerror_disable_reg_neg:\r\nif (!IS_ERR(st->reg_vss))\r\nregulator_disable(st->reg_vss);\r\nerror_put_reg_neg:\r\nif (!IS_ERR(st->reg_vss))\r\nregulator_put(st->reg_vss);\r\nif (!IS_ERR(st->reg_vdd))\r\nregulator_disable(st->reg_vdd);\r\nerror_put_reg_pos:\r\nif (!IS_ERR(st->reg_vdd))\r\nregulator_put(st->reg_vdd);\r\niio_free_device(indio_dev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int __devexit ad5791_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\nstruct ad5791_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nif (!IS_ERR(st->reg_vdd)) {\r\nregulator_disable(st->reg_vdd);\r\nregulator_put(st->reg_vdd);\r\n}\r\nif (!IS_ERR(st->reg_vss)) {\r\nregulator_disable(st->reg_vss);\r\nregulator_put(st->reg_vss);\r\n}\r\niio_free_device(indio_dev);\r\nreturn 0;\r\n}

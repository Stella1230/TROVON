static inline struct page *\r\n__first_valid_page(unsigned long pfn, unsigned long nr_pages)\r\n{\r\nint i;\r\nfor (i = 0; i < nr_pages; i++)\r\nif (pfn_valid_within(pfn + i))\r\nbreak;\r\nif (unlikely(i == nr_pages))\r\nreturn NULL;\r\nreturn pfn_to_page(pfn + i);\r\n}\r\nint\r\nstart_isolate_page_range(unsigned long start_pfn, unsigned long end_pfn)\r\n{\r\nunsigned long pfn;\r\nunsigned long undo_pfn;\r\nstruct page *page;\r\nBUG_ON((start_pfn) & (pageblock_nr_pages - 1));\r\nBUG_ON((end_pfn) & (pageblock_nr_pages - 1));\r\nfor (pfn = start_pfn;\r\npfn < end_pfn;\r\npfn += pageblock_nr_pages) {\r\npage = __first_valid_page(pfn, pageblock_nr_pages);\r\nif (page && set_migratetype_isolate(page)) {\r\nundo_pfn = pfn;\r\ngoto undo;\r\n}\r\n}\r\nreturn 0;\r\nundo:\r\nfor (pfn = start_pfn;\r\npfn < undo_pfn;\r\npfn += pageblock_nr_pages)\r\nunset_migratetype_isolate(pfn_to_page(pfn));\r\nreturn -EBUSY;\r\n}\r\nint\r\nundo_isolate_page_range(unsigned long start_pfn, unsigned long end_pfn)\r\n{\r\nunsigned long pfn;\r\nstruct page *page;\r\nBUG_ON((start_pfn) & (pageblock_nr_pages - 1));\r\nBUG_ON((end_pfn) & (pageblock_nr_pages - 1));\r\nfor (pfn = start_pfn;\r\npfn < end_pfn;\r\npfn += pageblock_nr_pages) {\r\npage = __first_valid_page(pfn, pageblock_nr_pages);\r\nif (!page || get_pageblock_migratetype(page) != MIGRATE_ISOLATE)\r\ncontinue;\r\nunset_migratetype_isolate(page);\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\n__test_page_isolated_in_pageblock(unsigned long pfn, unsigned long end_pfn)\r\n{\r\nstruct page *page;\r\nwhile (pfn < end_pfn) {\r\nif (!pfn_valid_within(pfn)) {\r\npfn++;\r\ncontinue;\r\n}\r\npage = pfn_to_page(pfn);\r\nif (PageBuddy(page))\r\npfn += 1 << page_order(page);\r\nelse if (page_count(page) == 0 &&\r\npage_private(page) == MIGRATE_ISOLATE)\r\npfn += 1;\r\nelse\r\nbreak;\r\n}\r\nif (pfn < end_pfn)\r\nreturn 0;\r\nreturn 1;\r\n}\r\nint test_pages_isolated(unsigned long start_pfn, unsigned long end_pfn)\r\n{\r\nunsigned long pfn, flags;\r\nstruct page *page;\r\nstruct zone *zone;\r\nint ret;\r\nfor (pfn = start_pfn; pfn < end_pfn; pfn += pageblock_nr_pages) {\r\npage = __first_valid_page(pfn, pageblock_nr_pages);\r\nif (page && get_pageblock_migratetype(page) != MIGRATE_ISOLATE)\r\nbreak;\r\n}\r\npage = __first_valid_page(start_pfn, end_pfn - start_pfn);\r\nif ((pfn < end_pfn) || !page)\r\nreturn -EBUSY;\r\nzone = page_zone(page);\r\nspin_lock_irqsave(&zone->lock, flags);\r\nret = __test_page_isolated_in_pageblock(start_pfn, end_pfn);\r\nspin_unlock_irqrestore(&zone->lock, flags);\r\nreturn ret ? 0 : -EBUSY;\r\n}

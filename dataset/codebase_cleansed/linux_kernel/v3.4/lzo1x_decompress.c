int lzo1x_decompress_safe(const unsigned char *in, size_t in_len,\r\nunsigned char *out, size_t *out_len)\r\n{\r\nconst unsigned char * const ip_end = in + in_len;\r\nunsigned char * const op_end = out + *out_len;\r\nconst unsigned char *ip = in, *m_pos;\r\nunsigned char *op = out;\r\nsize_t t;\r\n*out_len = 0;\r\nif (*ip > 17) {\r\nt = *ip++ - 17;\r\nif (t < 4)\r\ngoto match_next;\r\nif (HAVE_OP(t, op_end, op))\r\ngoto output_overrun;\r\nif (HAVE_IP(t + 1, ip_end, ip))\r\ngoto input_overrun;\r\ndo {\r\n*op++ = *ip++;\r\n} while (--t > 0);\r\ngoto first_literal_run;\r\n}\r\nwhile ((ip < ip_end)) {\r\nt = *ip++;\r\nif (t >= 16)\r\ngoto match;\r\nif (t == 0) {\r\nif (HAVE_IP(1, ip_end, ip))\r\ngoto input_overrun;\r\nwhile (*ip == 0) {\r\nt += 255;\r\nip++;\r\nif (HAVE_IP(1, ip_end, ip))\r\ngoto input_overrun;\r\n}\r\nt += 15 + *ip++;\r\n}\r\nif (HAVE_OP(t + 3, op_end, op))\r\ngoto output_overrun;\r\nif (HAVE_IP(t + 4, ip_end, ip))\r\ngoto input_overrun;\r\nCOPY4(op, ip);\r\nop += 4;\r\nip += 4;\r\nif (--t > 0) {\r\nif (t >= 4) {\r\ndo {\r\nCOPY4(op, ip);\r\nop += 4;\r\nip += 4;\r\nt -= 4;\r\n} while (t >= 4);\r\nif (t > 0) {\r\ndo {\r\n*op++ = *ip++;\r\n} while (--t > 0);\r\n}\r\n} else {\r\ndo {\r\n*op++ = *ip++;\r\n} while (--t > 0);\r\n}\r\n}\r\nfirst_literal_run:\r\nt = *ip++;\r\nif (t >= 16)\r\ngoto match;\r\nm_pos = op - (1 + M2_MAX_OFFSET);\r\nm_pos -= t >> 2;\r\nm_pos -= *ip++ << 2;\r\nif (HAVE_LB(m_pos, out, op))\r\ngoto lookbehind_overrun;\r\nif (HAVE_OP(3, op_end, op))\r\ngoto output_overrun;\r\n*op++ = *m_pos++;\r\n*op++ = *m_pos++;\r\n*op++ = *m_pos;\r\ngoto match_done;\r\ndo {\r\nmatch:\r\nif (t >= 64) {\r\nm_pos = op - 1;\r\nm_pos -= (t >> 2) & 7;\r\nm_pos -= *ip++ << 3;\r\nt = (t >> 5) - 1;\r\nif (HAVE_LB(m_pos, out, op))\r\ngoto lookbehind_overrun;\r\nif (HAVE_OP(t + 3 - 1, op_end, op))\r\ngoto output_overrun;\r\ngoto copy_match;\r\n} else if (t >= 32) {\r\nt &= 31;\r\nif (t == 0) {\r\nif (HAVE_IP(1, ip_end, ip))\r\ngoto input_overrun;\r\nwhile (*ip == 0) {\r\nt += 255;\r\nip++;\r\nif (HAVE_IP(1, ip_end, ip))\r\ngoto input_overrun;\r\n}\r\nt += 31 + *ip++;\r\n}\r\nm_pos = op - 1;\r\nm_pos -= get_unaligned_le16(ip) >> 2;\r\nip += 2;\r\n} else if (t >= 16) {\r\nm_pos = op;\r\nm_pos -= (t & 8) << 11;\r\nt &= 7;\r\nif (t == 0) {\r\nif (HAVE_IP(1, ip_end, ip))\r\ngoto input_overrun;\r\nwhile (*ip == 0) {\r\nt += 255;\r\nip++;\r\nif (HAVE_IP(1, ip_end, ip))\r\ngoto input_overrun;\r\n}\r\nt += 7 + *ip++;\r\n}\r\nm_pos -= get_unaligned_le16(ip) >> 2;\r\nip += 2;\r\nif (m_pos == op)\r\ngoto eof_found;\r\nm_pos -= 0x4000;\r\n} else {\r\nm_pos = op - 1;\r\nm_pos -= t >> 2;\r\nm_pos -= *ip++ << 2;\r\nif (HAVE_LB(m_pos, out, op))\r\ngoto lookbehind_overrun;\r\nif (HAVE_OP(2, op_end, op))\r\ngoto output_overrun;\r\n*op++ = *m_pos++;\r\n*op++ = *m_pos;\r\ngoto match_done;\r\n}\r\nif (HAVE_LB(m_pos, out, op))\r\ngoto lookbehind_overrun;\r\nif (HAVE_OP(t + 3 - 1, op_end, op))\r\ngoto output_overrun;\r\nif (t >= 2 * 4 - (3 - 1) && (op - m_pos) >= 4) {\r\nCOPY4(op, m_pos);\r\nop += 4;\r\nm_pos += 4;\r\nt -= 4 - (3 - 1);\r\ndo {\r\nCOPY4(op, m_pos);\r\nop += 4;\r\nm_pos += 4;\r\nt -= 4;\r\n} while (t >= 4);\r\nif (t > 0)\r\ndo {\r\n*op++ = *m_pos++;\r\n} while (--t > 0);\r\n} else {\r\ncopy_match:\r\n*op++ = *m_pos++;\r\n*op++ = *m_pos++;\r\ndo {\r\n*op++ = *m_pos++;\r\n} while (--t > 0);\r\n}\r\nmatch_done:\r\nt = ip[-2] & 3;\r\nif (t == 0)\r\nbreak;\r\nmatch_next:\r\nif (HAVE_OP(t, op_end, op))\r\ngoto output_overrun;\r\nif (HAVE_IP(t + 1, ip_end, ip))\r\ngoto input_overrun;\r\n*op++ = *ip++;\r\nif (t > 1) {\r\n*op++ = *ip++;\r\nif (t > 2)\r\n*op++ = *ip++;\r\n}\r\nt = *ip++;\r\n} while (ip < ip_end);\r\n}\r\n*out_len = op - out;\r\nreturn LZO_E_EOF_NOT_FOUND;\r\neof_found:\r\n*out_len = op - out;\r\nreturn (ip == ip_end ? LZO_E_OK :\r\n(ip < ip_end ? LZO_E_INPUT_NOT_CONSUMED : LZO_E_INPUT_OVERRUN));\r\ninput_overrun:\r\n*out_len = op - out;\r\nreturn LZO_E_INPUT_OVERRUN;\r\noutput_overrun:\r\n*out_len = op - out;\r\nreturn LZO_E_OUTPUT_OVERRUN;\r\nlookbehind_overrun:\r\n*out_len = op - out;\r\nreturn LZO_E_LOOKBEHIND_OVERRUN;\r\n}

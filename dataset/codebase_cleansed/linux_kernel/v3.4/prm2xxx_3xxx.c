u32 omap2_prm_read_mod_reg(s16 module, u16 idx)\r\n{\r\nreturn __raw_readl(prm_base + module + idx);\r\n}\r\nvoid omap2_prm_write_mod_reg(u32 val, s16 module, u16 idx)\r\n{\r\n__raw_writel(val, prm_base + module + idx);\r\n}\r\nu32 omap2_prm_rmw_mod_reg_bits(u32 mask, u32 bits, s16 module, s16 idx)\r\n{\r\nu32 v;\r\nv = omap2_prm_read_mod_reg(module, idx);\r\nv &= ~mask;\r\nv |= bits;\r\nomap2_prm_write_mod_reg(v, module, idx);\r\nreturn v;\r\n}\r\nu32 omap2_prm_read_mod_bits_shift(s16 domain, s16 idx, u32 mask)\r\n{\r\nu32 v;\r\nv = omap2_prm_read_mod_reg(domain, idx);\r\nv &= mask;\r\nv >>= __ffs(mask);\r\nreturn v;\r\n}\r\nu32 omap2_prm_set_mod_reg_bits(u32 bits, s16 module, s16 idx)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(bits, bits, module, idx);\r\n}\r\nu32 omap2_prm_clear_mod_reg_bits(u32 bits, s16 module, s16 idx)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(bits, 0x0, module, idx);\r\n}\r\nint omap2_prm_is_hardreset_asserted(s16 prm_mod, u8 shift)\r\n{\r\nif (!(cpu_is_omap24xx() || cpu_is_omap34xx()))\r\nreturn -EINVAL;\r\nreturn omap2_prm_read_mod_bits_shift(prm_mod, OMAP2_RM_RSTCTRL,\r\n(1 << shift));\r\n}\r\nint omap2_prm_assert_hardreset(s16 prm_mod, u8 shift)\r\n{\r\nu32 mask;\r\nif (!(cpu_is_omap24xx() || cpu_is_omap34xx()))\r\nreturn -EINVAL;\r\nmask = 1 << shift;\r\nomap2_prm_rmw_mod_reg_bits(mask, mask, prm_mod, OMAP2_RM_RSTCTRL);\r\nreturn 0;\r\n}\r\nint omap2_prm_deassert_hardreset(s16 prm_mod, u8 rst_shift, u8 st_shift)\r\n{\r\nu32 rst, st;\r\nint c;\r\nif (!(cpu_is_omap24xx() || cpu_is_omap34xx()))\r\nreturn -EINVAL;\r\nrst = 1 << rst_shift;\r\nst = 1 << st_shift;\r\nif (omap2_prm_read_mod_bits_shift(prm_mod, OMAP2_RM_RSTCTRL, rst) == 0)\r\nreturn -EEXIST;\r\nomap2_prm_rmw_mod_reg_bits(0xffffffff, st, prm_mod, OMAP2_RM_RSTST);\r\nomap2_prm_rmw_mod_reg_bits(rst, 0, prm_mod, OMAP2_RM_RSTCTRL);\r\nomap_test_timeout(omap2_prm_read_mod_bits_shift(prm_mod, OMAP2_RM_RSTST,\r\nst),\r\nMAX_MODULE_HARDRESET_WAIT, c);\r\nreturn (c == MAX_MODULE_HARDRESET_WAIT) ? -EBUSY : 0;\r\n}\r\nu32 omap3_prm_vp_check_txdone(u8 vp_id)\r\n{\r\nstruct omap3_vp *vp = &omap3_vp[vp_id];\r\nu32 irqstatus;\r\nirqstatus = omap2_prm_read_mod_reg(OCP_MOD,\r\nOMAP3_PRM_IRQSTATUS_MPU_OFFSET);\r\nreturn irqstatus & vp->tranxdone_status;\r\n}\r\nvoid omap3_prm_vp_clear_txdone(u8 vp_id)\r\n{\r\nstruct omap3_vp *vp = &omap3_vp[vp_id];\r\nomap2_prm_write_mod_reg(vp->tranxdone_status,\r\nOCP_MOD, OMAP3_PRM_IRQSTATUS_MPU_OFFSET);\r\n}\r\nu32 omap3_prm_vcvp_read(u8 offset)\r\n{\r\nreturn omap2_prm_read_mod_reg(OMAP3430_GR_MOD, offset);\r\n}\r\nvoid omap3_prm_vcvp_write(u32 val, u8 offset)\r\n{\r\nomap2_prm_write_mod_reg(val, OMAP3430_GR_MOD, offset);\r\n}\r\nu32 omap3_prm_vcvp_rmw(u32 mask, u32 bits, u8 offset)\r\n{\r\nreturn omap2_prm_rmw_mod_reg_bits(mask, bits, OMAP3430_GR_MOD, offset);\r\n}\r\nvoid omap3xxx_prm_read_pending_irqs(unsigned long *events)\r\n{\r\nu32 mask, st;\r\nmask = omap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\nst = omap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_IRQSTATUS_MPU_OFFSET);\r\nevents[0] = mask & st;\r\n}\r\nvoid omap3xxx_prm_ocp_barrier(void)\r\n{\r\nomap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_REVISION_OFFSET);\r\n}\r\nvoid omap3xxx_prm_save_and_clear_irqen(u32 *saved_mask)\r\n{\r\nsaved_mask[0] = omap2_prm_read_mod_reg(OCP_MOD,\r\nOMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\nomap2_prm_write_mod_reg(0, OCP_MOD, OMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\nomap2_prm_read_mod_reg(OCP_MOD, OMAP3_PRM_REVISION_OFFSET);\r\n}\r\nvoid omap3xxx_prm_restore_irqen(u32 *saved_mask)\r\n{\r\nomap2_prm_write_mod_reg(saved_mask[0], OCP_MOD,\r\nOMAP3_PRM_IRQENABLE_MPU_OFFSET);\r\n}\r\nstatic int __init omap3xxx_prcm_init(void)\r\n{\r\nif (cpu_is_omap34xx())\r\nreturn omap_prcm_register_chain_handler(&omap3_prcm_irq_setup);\r\nreturn 0;\r\n}

static int uvc_mc_register_entity(struct uvc_video_chain *chain,\r\nstruct uvc_entity *entity)\r\n{\r\nconst u32 flags = MEDIA_LNK_FL_ENABLED | MEDIA_LNK_FL_IMMUTABLE;\r\nstruct media_entity *sink;\r\nunsigned int i;\r\nint ret;\r\nsink = (UVC_ENTITY_TYPE(entity) == UVC_TT_STREAMING)\r\n? (entity->vdev ? &entity->vdev->entity : NULL)\r\n: &entity->subdev.entity;\r\nif (sink == NULL)\r\nreturn 0;\r\nfor (i = 0; i < entity->num_pads; ++i) {\r\nstruct media_entity *source;\r\nstruct uvc_entity *remote;\r\nu8 remote_pad;\r\nif (!(entity->pads[i].flags & MEDIA_PAD_FL_SINK))\r\ncontinue;\r\nremote = uvc_entity_by_id(chain->dev, entity->baSourceID[i]);\r\nif (remote == NULL)\r\nreturn -EINVAL;\r\nsource = (UVC_ENTITY_TYPE(remote) == UVC_TT_STREAMING)\r\n? (remote->vdev ? &remote->vdev->entity : NULL)\r\n: &remote->subdev.entity;\r\nif (source == NULL)\r\ncontinue;\r\nremote_pad = remote->num_pads - 1;\r\nret = media_entity_create_link(source, remote_pad,\r\nsink, i, flags);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nif (UVC_ENTITY_TYPE(entity) == UVC_TT_STREAMING)\r\nreturn 0;\r\nreturn v4l2_device_register_subdev(&chain->dev->vdev, &entity->subdev);\r\n}\r\nvoid uvc_mc_cleanup_entity(struct uvc_entity *entity)\r\n{\r\nif (UVC_ENTITY_TYPE(entity) != UVC_TT_STREAMING)\r\nmedia_entity_cleanup(&entity->subdev.entity);\r\nelse if (entity->vdev != NULL)\r\nmedia_entity_cleanup(&entity->vdev->entity);\r\n}\r\nstatic int uvc_mc_init_entity(struct uvc_entity *entity)\r\n{\r\nint ret;\r\nif (UVC_ENTITY_TYPE(entity) != UVC_TT_STREAMING) {\r\nv4l2_subdev_init(&entity->subdev, &uvc_subdev_ops);\r\nstrlcpy(entity->subdev.name, entity->name,\r\nsizeof(entity->subdev.name));\r\nret = media_entity_init(&entity->subdev.entity,\r\nentity->num_pads, entity->pads, 0);\r\n} else if (entity->vdev != NULL) {\r\nret = media_entity_init(&entity->vdev->entity,\r\nentity->num_pads, entity->pads, 0);\r\n} else\r\nret = 0;\r\nreturn ret;\r\n}\r\nint uvc_mc_register_entities(struct uvc_video_chain *chain)\r\n{\r\nstruct uvc_entity *entity;\r\nint ret;\r\nlist_for_each_entry(entity, &chain->entities, chain) {\r\nret = uvc_mc_init_entity(entity);\r\nif (ret < 0) {\r\nuvc_printk(KERN_INFO, "Failed to initialize entity for "\r\n"entity %u\n", entity->id);\r\nreturn ret;\r\n}\r\n}\r\nlist_for_each_entry(entity, &chain->entities, chain) {\r\nret = uvc_mc_register_entity(chain, entity);\r\nif (ret < 0) {\r\nuvc_printk(KERN_INFO, "Failed to register entity for "\r\n"entity %u\n", entity->id);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}

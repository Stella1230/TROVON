int snd_gus_iwffff_put_sample(void *private_data, struct iwffff_wave *wave,\r\nchar __user *data, long len, int atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nstruct snd_gf1_mem_block *block;\r\nint err;\r\nif (wave->format & IWFFFF_WAVE_ROM)\r\nreturn 0;\r\nif (wave->format & IWFFFF_WAVE_STEREO)\r\nreturn -EINVAL;\r\nblock = snd_gf1_mem_alloc(&gus->gf1.mem_alloc,\r\nSNDRV_GF1_MEM_OWNER_WAVE_IWFFFF,\r\nNULL, wave->size,\r\nwave->format & IWFFFF_WAVE_16BIT, 1,\r\nwave->share_id);\r\nif (block == NULL)\r\nreturn -ENOMEM;\r\nerr = snd_gus_dram_write(gus, data,\r\nblock->ptr, wave->size);\r\nif (err < 0) {\r\nsnd_gf1_mem_lock(&gus->gf1.mem_alloc, 0);\r\nsnd_gf1_mem_xfree(&gus->gf1.mem_alloc, block);\r\nsnd_gf1_mem_lock(&gus->gf1.mem_alloc, 1);\r\nreturn err;\r\n}\r\nwave->address.memory = block->ptr;\r\nreturn 0;\r\n}\r\nint snd_gus_iwffff_get_sample(void *private_data, struct iwffff_wave *wave,\r\nchar __user *data, long len, int atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nreturn snd_gus_dram_read(gus, data, wave->address.memory, wave->size,\r\nwave->format & IWFFFF_WAVE_ROM ? 1 : 0);\r\n}\r\nint snd_gus_iwffff_remove_sample(void *private_data, struct iwffff_wave *wave,\r\nint atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nif (wave->format & IWFFFF_WAVE_ROM)\r\nreturn 0;\r\nreturn snd_gf1_mem_free(&gus->gf1.mem_alloc, wave->address.memory);\r\n}\r\nint snd_gus_gf1_put_sample(void *private_data, struct gf1_wave *wave,\r\nchar __user *data, long len, int atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nstruct snd_gf1_mem_block *block;\r\nint err;\r\nif (wave->format & GF1_WAVE_STEREO)\r\nreturn -EINVAL;\r\nblock = snd_gf1_mem_alloc(&gus->gf1.mem_alloc,\r\nSNDRV_GF1_MEM_OWNER_WAVE_GF1,\r\nNULL, wave->size,\r\nwave->format & GF1_WAVE_16BIT, 1,\r\nwave->share_id);\r\nif (block == NULL)\r\nreturn -ENOMEM;\r\nerr = snd_gus_dram_write(gus, data,\r\nblock->ptr, wave->size);\r\nif (err < 0) {\r\nsnd_gf1_mem_lock(&gus->gf1.mem_alloc, 0);\r\nsnd_gf1_mem_xfree(&gus->gf1.mem_alloc, block);\r\nsnd_gf1_mem_lock(&gus->gf1.mem_alloc, 1);\r\nreturn err;\r\n}\r\nwave->address.memory = block->ptr;\r\nreturn 0;\r\n}\r\nint snd_gus_gf1_get_sample(void *private_data, struct gf1_wave *wave,\r\nchar __user *data, long len, int atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nreturn snd_gus_dram_read(gus, data, wave->address.memory, wave->size, 0);\r\n}\r\nint snd_gus_gf1_remove_sample(void *private_data, struct gf1_wave *wave,\r\nint atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nreturn snd_gf1_mem_free(&gus->gf1.mem_alloc, wave->address.memory);\r\n}\r\nint snd_gus_simple_put_sample(void *private_data, struct simple_instrument *instr,\r\nchar __user *data, long len, int atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nstruct snd_gf1_mem_block *block;\r\nint err;\r\nif (instr->format & SIMPLE_WAVE_STEREO)\r\nreturn -EINVAL;\r\nblock = snd_gf1_mem_alloc(&gus->gf1.mem_alloc,\r\nSNDRV_GF1_MEM_OWNER_WAVE_SIMPLE,\r\nNULL, instr->size,\r\ninstr->format & SIMPLE_WAVE_16BIT, 1,\r\ninstr->share_id);\r\nif (block == NULL)\r\nreturn -ENOMEM;\r\nerr = snd_gus_dram_write(gus, data, block->ptr, instr->size);\r\nif (err < 0) {\r\nsnd_gf1_mem_lock(&gus->gf1.mem_alloc, 0);\r\nsnd_gf1_mem_xfree(&gus->gf1.mem_alloc, block);\r\nsnd_gf1_mem_lock(&gus->gf1.mem_alloc, 1);\r\nreturn err;\r\n}\r\ninstr->address.memory = block->ptr;\r\nreturn 0;\r\n}\r\nint snd_gus_simple_get_sample(void *private_data, struct simple_instrument *instr,\r\nchar __user *data, long len, int atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nreturn snd_gus_dram_read(gus, data, instr->address.memory, instr->size, 0);\r\n}\r\nint snd_gus_simple_remove_sample(void *private_data, struct simple_instrument *instr,\r\nint atomic)\r\n{\r\nstruct snd_gus_card *gus = private_data;\r\nreturn snd_gf1_mem_free(&gus->gf1.mem_alloc, instr->address.memory);\r\n}

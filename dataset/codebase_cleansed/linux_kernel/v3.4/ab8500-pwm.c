int pwm_config(struct pwm_device *pwm, int duty_ns, int period_ns)\r\n{\r\nint ret = 0;\r\nunsigned int higher_val, lower_val;\r\nu8 reg;\r\nlower_val = duty_ns & 0x00FF;\r\nhigher_val = ((duty_ns & 0x0300) >> 8);\r\nreg = AB8500_PWM_OUT_CTRL1_REG + ((pwm->pwm_id - 1) * 2);\r\nret = abx500_set_register_interruptible(pwm->dev, AB8500_MISC,\r\nreg, (u8)lower_val);\r\nif (ret < 0)\r\nreturn ret;\r\nret = abx500_set_register_interruptible(pwm->dev, AB8500_MISC,\r\n(reg + 1), (u8)higher_val);\r\nreturn ret;\r\n}\r\nint pwm_enable(struct pwm_device *pwm)\r\n{\r\nint ret;\r\nret = abx500_mask_and_set_register_interruptible(pwm->dev,\r\nAB8500_MISC, AB8500_PWM_OUT_CTRL7_REG,\r\n1 << (pwm->pwm_id-1), ENABLE_PWM);\r\nif (ret < 0)\r\ndev_err(pwm->dev, "%s: Failed to disable PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn ret;\r\n}\r\nvoid pwm_disable(struct pwm_device *pwm)\r\n{\r\nint ret;\r\nret = abx500_mask_and_set_register_interruptible(pwm->dev,\r\nAB8500_MISC, AB8500_PWM_OUT_CTRL7_REG,\r\n1 << (pwm->pwm_id-1), DISABLE_PWM);\r\nif (ret < 0)\r\ndev_err(pwm->dev, "%s: Failed to disable PWM, Error %d\n",\r\npwm->label, ret);\r\nreturn;\r\n}\r\nstruct pwm_device *pwm_request(int pwm_id, const char *label)\r\n{\r\nstruct pwm_device *pwm;\r\nlist_for_each_entry(pwm, &pwm_list, node) {\r\nif (pwm->pwm_id == pwm_id) {\r\npwm->label = label;\r\npwm->pwm_id = pwm_id;\r\nreturn pwm;\r\n}\r\n}\r\nreturn ERR_PTR(-ENOENT);\r\n}\r\nvoid pwm_free(struct pwm_device *pwm)\r\n{\r\npwm_disable(pwm);\r\n}\r\nstatic int __devinit ab8500_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct pwm_device *pwm;\r\npwm = kzalloc(sizeof(struct pwm_device), GFP_KERNEL);\r\nif (pwm == NULL) {\r\ndev_err(&pdev->dev, "failed to allocate memory\n");\r\nreturn -ENOMEM;\r\n}\r\npwm->dev = &pdev->dev;\r\npwm->pwm_id = pdev->id;\r\nlist_add_tail(&pwm->node, &pwm_list);\r\nplatform_set_drvdata(pdev, pwm);\r\ndev_dbg(pwm->dev, "pwm probe successful\n");\r\nreturn 0;\r\n}\r\nstatic int __devexit ab8500_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct pwm_device *pwm = platform_get_drvdata(pdev);\r\nlist_del(&pwm->node);\r\ndev_dbg(&pdev->dev, "pwm driver removed\n");\r\nkfree(pwm);\r\nreturn 0;\r\n}\r\nstatic int __init ab8500_pwm_init(void)\r\n{\r\nreturn platform_driver_register(&ab8500_pwm_driver);\r\n}\r\nstatic void __exit ab8500_pwm_exit(void)\r\n{\r\nplatform_driver_unregister(&ab8500_pwm_driver);\r\n}

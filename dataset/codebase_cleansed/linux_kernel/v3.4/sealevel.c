static inline struct slvl_device* dev_to_chan(struct net_device *dev)\r\n{\r\nreturn (struct slvl_device *)dev_to_hdlc(dev)->priv;\r\n}\r\nstatic void sealevel_input(struct z8530_channel *c, struct sk_buff *skb)\r\n{\r\nskb_trim(skb, skb->len - 2);\r\nskb->protocol = hdlc_type_trans(skb, c->netdevice);\r\nskb_reset_mac_header(skb);\r\nskb->dev = c->netdevice;\r\nnetif_rx(skb);\r\n}\r\nstatic int sealevel_open(struct net_device *d)\r\n{\r\nstruct slvl_device *slvl = dev_to_chan(d);\r\nint err = -1;\r\nint unit = slvl->channel;\r\nswitch (unit) {\r\ncase 0:\r\nerr = z8530_sync_dma_open(d, slvl->chan);\r\nbreak;\r\ncase 1:\r\nerr = z8530_sync_open(d, slvl->chan);\r\nbreak;\r\n}\r\nif (err)\r\nreturn err;\r\nerr = hdlc_open(d);\r\nif (err) {\r\nswitch (unit) {\r\ncase 0:\r\nz8530_sync_dma_close(d, slvl->chan);\r\nbreak;\r\ncase 1:\r\nz8530_sync_close(d, slvl->chan);\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nslvl->chan->rx_function = sealevel_input;\r\nnetif_start_queue(d);\r\nreturn 0;\r\n}\r\nstatic int sealevel_close(struct net_device *d)\r\n{\r\nstruct slvl_device *slvl = dev_to_chan(d);\r\nint unit = slvl->channel;\r\nslvl->chan->rx_function = z8530_null_rx;\r\nhdlc_close(d);\r\nnetif_stop_queue(d);\r\nswitch (unit) {\r\ncase 0:\r\nz8530_sync_dma_close(d, slvl->chan);\r\nbreak;\r\ncase 1:\r\nz8530_sync_close(d, slvl->chan);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sealevel_ioctl(struct net_device *d, struct ifreq *ifr, int cmd)\r\n{\r\nreturn hdlc_ioctl(d, ifr, cmd);\r\n}\r\nstatic netdev_tx_t sealevel_queue_xmit(struct sk_buff *skb,\r\nstruct net_device *d)\r\n{\r\nreturn z8530_queue_xmit(dev_to_chan(d)->chan, skb);\r\n}\r\nstatic int sealevel_attach(struct net_device *dev, unsigned short encoding,\r\nunsigned short parity)\r\n{\r\nif (encoding == ENCODING_NRZ && parity == PARITY_CRC16_PR1_CCITT)\r\nreturn 0;\r\nreturn -EINVAL;\r\n}\r\nstatic int slvl_setup(struct slvl_device *sv, int iobase, int irq)\r\n{\r\nstruct net_device *dev = alloc_hdlcdev(sv);\r\nif (!dev)\r\nreturn -1;\r\ndev_to_hdlc(dev)->attach = sealevel_attach;\r\ndev_to_hdlc(dev)->xmit = sealevel_queue_xmit;\r\ndev->netdev_ops = &sealevel_ops;\r\ndev->base_addr = iobase;\r\ndev->irq = irq;\r\nif (register_hdlc_device(dev)) {\r\npr_err("unable to register HDLC device\n");\r\nfree_netdev(dev);\r\nreturn -1;\r\n}\r\nsv->chan->netdevice = dev;\r\nreturn 0;\r\n}\r\nvoid __exit slvl_shutdown(struct slvl_board *b)\r\n{\r\nint u;\r\nz8530_shutdown(&b->board);\r\nfor (u = 0; u < 2; u++) {\r\nstruct net_device *d = b->dev[u].chan->netdevice;\r\nunregister_hdlc_device(d);\r\nfree_netdev(d);\r\n}\r\nfree_irq(b->board.irq, &b->board);\r\nfree_dma(b->board.chanA.rxdma);\r\nfree_dma(b->board.chanA.txdma);\r\noutb(0, b->iobase);\r\nrelease_region(b->iobase, 8);\r\nkfree(b);\r\n}\r\nstatic int __init slvl_init_module(void)\r\n{\r\nslvl_unit = slvl_init(io, irq, txdma, rxdma, slow);\r\nreturn slvl_unit ? 0 : -ENODEV;\r\n}\r\nstatic void __exit slvl_cleanup_module(void)\r\n{\r\nif (slvl_unit)\r\nslvl_shutdown(slvl_unit);\r\n}

static ssize_t ctcm_buffer_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ctcm_priv *priv = dev_get_drvdata(dev);\r\nif (!priv)\r\nreturn -ENODEV;\r\nreturn sprintf(buf, "%d\n", priv->buffer_size);\r\n}\r\nstatic ssize_t ctcm_buffer_write(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nstruct net_device *ndev;\r\nint bs1;\r\nstruct ctcm_priv *priv = dev_get_drvdata(dev);\r\nndev = priv->channel[CTCM_READ]->netdev;\r\nif (!(priv && priv->channel[CTCM_READ] && ndev)) {\r\nCTCM_DBF_TEXT(SETUP, CTC_DBF_ERROR, "bfnondev");\r\nreturn -ENODEV;\r\n}\r\nsscanf(buf, "%u", &bs1);\r\nif (bs1 > CTCM_BUFSIZE_LIMIT)\r\ngoto einval;\r\nif (bs1 < (576 + LL_HEADER_LENGTH + 2))\r\ngoto einval;\r\npriv->buffer_size = bs1;\r\nif ((ndev->flags & IFF_RUNNING) &&\r\n(bs1 < (ndev->mtu + LL_HEADER_LENGTH + 2)))\r\ngoto einval;\r\npriv->channel[CTCM_READ]->max_bufsize = bs1;\r\npriv->channel[CTCM_WRITE]->max_bufsize = bs1;\r\nif (!(ndev->flags & IFF_RUNNING))\r\nndev->mtu = bs1 - LL_HEADER_LENGTH - 2;\r\npriv->channel[CTCM_READ]->flags |= CHANNEL_FLAGS_BUFSIZE_CHANGED;\r\npriv->channel[CTCM_WRITE]->flags |= CHANNEL_FLAGS_BUFSIZE_CHANGED;\r\nCTCM_DBF_DEV(SETUP, ndev, buf);\r\nreturn count;\r\neinval:\r\nCTCM_DBF_DEV(SETUP, ndev, "buff_err");\r\nreturn -EINVAL;\r\n}\r\nstatic void ctcm_print_statistics(struct ctcm_priv *priv)\r\n{\r\nchar *sbuf;\r\nchar *p;\r\nif (!priv)\r\nreturn;\r\nsbuf = kmalloc(2048, GFP_KERNEL);\r\nif (sbuf == NULL)\r\nreturn;\r\np = sbuf;\r\np += sprintf(p, " Device FSM state: %s\n",\r\nfsm_getstate_str(priv->fsm));\r\np += sprintf(p, " RX channel FSM state: %s\n",\r\nfsm_getstate_str(priv->channel[CTCM_READ]->fsm));\r\np += sprintf(p, " TX channel FSM state: %s\n",\r\nfsm_getstate_str(priv->channel[CTCM_WRITE]->fsm));\r\np += sprintf(p, " Max. TX buffer used: %ld\n",\r\npriv->channel[WRITE]->prof.maxmulti);\r\np += sprintf(p, " Max. chained SKBs: %ld\n",\r\npriv->channel[WRITE]->prof.maxcqueue);\r\np += sprintf(p, " TX single write ops: %ld\n",\r\npriv->channel[WRITE]->prof.doios_single);\r\np += sprintf(p, " TX multi write ops: %ld\n",\r\npriv->channel[WRITE]->prof.doios_multi);\r\np += sprintf(p, " Netto bytes written: %ld\n",\r\npriv->channel[WRITE]->prof.txlen);\r\np += sprintf(p, " Max. TX IO-time: %ld\n",\r\npriv->channel[WRITE]->prof.tx_time);\r\nprintk(KERN_INFO "Statistics for %s:\n%s",\r\npriv->channel[CTCM_WRITE]->netdev->name, sbuf);\r\nkfree(sbuf);\r\nreturn;\r\n}\r\nstatic ssize_t stats_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ctcm_priv *priv = dev_get_drvdata(dev);\r\nif (!priv)\r\nreturn -ENODEV;\r\nctcm_print_statistics(priv);\r\nreturn sprintf(buf, "0\n");\r\n}\r\nstatic ssize_t stats_write(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct ctcm_priv *priv = dev_get_drvdata(dev);\r\nif (!priv)\r\nreturn -ENODEV;\r\nmemset(&priv->channel[WRITE]->prof, 0,\r\nsizeof(priv->channel[CTCM_WRITE]->prof));\r\nreturn count;\r\n}\r\nstatic ssize_t ctcm_proto_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ctcm_priv *priv = dev_get_drvdata(dev);\r\nif (!priv)\r\nreturn -ENODEV;\r\nreturn sprintf(buf, "%d\n", priv->protocol);\r\n}\r\nstatic ssize_t ctcm_proto_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t count)\r\n{\r\nint value;\r\nstruct ctcm_priv *priv = dev_get_drvdata(dev);\r\nif (!priv)\r\nreturn -ENODEV;\r\nsscanf(buf, "%u", &value);\r\nif (!((value == CTCM_PROTO_S390) ||\r\n(value == CTCM_PROTO_LINUX) ||\r\n(value == CTCM_PROTO_MPC) ||\r\n(value == CTCM_PROTO_OS390)))\r\nreturn -EINVAL;\r\npriv->protocol = value;\r\nCTCM_DBF_DEV(SETUP, dev, buf);\r\nreturn count;\r\n}\r\nstatic ssize_t ctcm_type_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct ccwgroup_device *cgdev;\r\ncgdev = to_ccwgroupdev(dev);\r\nif (!cgdev)\r\nreturn -ENODEV;\r\nreturn sprintf(buf, "%s\n",\r\nctcm_type[cgdev->cdev[0]->id.driver_info]);\r\n}\r\nint ctcm_add_attributes(struct device *dev)\r\n{\r\nint rc;\r\nrc = device_create_file(dev, &dev_attr_stats);\r\nreturn rc;\r\n}\r\nvoid ctcm_remove_attributes(struct device *dev)\r\n{\r\ndevice_remove_file(dev, &dev_attr_stats);\r\n}\r\nint ctcm_add_files(struct device *dev)\r\n{\r\nreturn sysfs_create_group(&dev->kobj, &ctcm_attr_group);\r\n}\r\nvoid ctcm_remove_files(struct device *dev)\r\n{\r\nsysfs_remove_group(&dev->kobj, &ctcm_attr_group);\r\n}

static int mc44s803_writereg(struct mc44s803_priv *priv, u32 val)\r\n{\r\nu8 buf[3];\r\nstruct i2c_msg msg = {\r\n.addr = priv->cfg->i2c_address, .flags = 0, .buf = buf, .len = 3\r\n};\r\nbuf[0] = (val & 0xff0000) >> 16;\r\nbuf[1] = (val & 0xff00) >> 8;\r\nbuf[2] = (val & 0xff);\r\nif (i2c_transfer(priv->i2c, &msg, 1) != 1) {\r\nmc_printk(KERN_WARNING, "I2C write failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mc44s803_readreg(struct mc44s803_priv *priv, u8 reg, u32 *val)\r\n{\r\nu32 wval;\r\nu8 buf[3];\r\nint ret;\r\nstruct i2c_msg msg[] = {\r\n{ .addr = priv->cfg->i2c_address, .flags = I2C_M_RD,\r\n.buf = buf, .len = 3 },\r\n};\r\nwval = MC44S803_REG_SM(MC44S803_REG_DATAREG, MC44S803_ADDR) |\r\nMC44S803_REG_SM(reg, MC44S803_D);\r\nret = mc44s803_writereg(priv, wval);\r\nif (ret)\r\nreturn ret;\r\nif (i2c_transfer(priv->i2c, msg, 1) != 1) {\r\nmc_printk(KERN_WARNING, "I2C read failed\n");\r\nreturn -EREMOTEIO;\r\n}\r\n*val = (buf[0] << 16) | (buf[1] << 8) | buf[2];\r\nreturn 0;\r\n}\r\nstatic int mc44s803_release(struct dvb_frontend *fe)\r\n{\r\nstruct mc44s803_priv *priv = fe->tuner_priv;\r\nfe->tuner_priv = NULL;\r\nkfree(priv);\r\nreturn 0;\r\n}\r\nstatic int mc44s803_init(struct dvb_frontend *fe)\r\n{\r\nstruct mc44s803_priv *priv = fe->tuner_priv;\r\nu32 val;\r\nint err;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nval = MC44S803_REG_SM(MC44S803_REG_RESET, MC44S803_ADDR) |\r\nMC44S803_REG_SM(1, MC44S803_RS);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_RESET, MC44S803_ADDR);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_REFOSC, MC44S803_ADDR) |\r\nMC44S803_REG_SM(0xC0, MC44S803_REFOSC) |\r\nMC44S803_REG_SM(1, MC44S803_OSCSEL);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_POWER, MC44S803_ADDR) |\r\nMC44S803_REG_SM(0x200, MC44S803_POWER);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nmsleep(10);\r\nval = MC44S803_REG_SM(MC44S803_REG_REFOSC, MC44S803_ADDR) |\r\nMC44S803_REG_SM(0x40, MC44S803_REFOSC) |\r\nMC44S803_REG_SM(1, MC44S803_OSCSEL);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nmsleep(20);\r\nval = MC44S803_REG_SM(MC44S803_REG_MIXER, MC44S803_ADDR) |\r\nMC44S803_REG_SM(1, MC44S803_TRI_STATE) |\r\nMC44S803_REG_SM(0x7F, MC44S803_MIXER_RES);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_CIRCADJ, MC44S803_ADDR) |\r\nMC44S803_REG_SM(1, MC44S803_G1) |\r\nMC44S803_REG_SM(1, MC44S803_G3) |\r\nMC44S803_REG_SM(0x3, MC44S803_CIRCADJ_RES) |\r\nMC44S803_REG_SM(1, MC44S803_G6) |\r\nMC44S803_REG_SM(priv->cfg->dig_out, MC44S803_S1) |\r\nMC44S803_REG_SM(0x3, MC44S803_LP) |\r\nMC44S803_REG_SM(1, MC44S803_CLRF) |\r\nMC44S803_REG_SM(1, MC44S803_CLIF);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_CIRCADJ, MC44S803_ADDR) |\r\nMC44S803_REG_SM(1, MC44S803_G1) |\r\nMC44S803_REG_SM(1, MC44S803_G3) |\r\nMC44S803_REG_SM(0x3, MC44S803_CIRCADJ_RES) |\r\nMC44S803_REG_SM(1, MC44S803_G6) |\r\nMC44S803_REG_SM(priv->cfg->dig_out, MC44S803_S1) |\r\nMC44S803_REG_SM(0x3, MC44S803_LP);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_DIGTUNE, MC44S803_ADDR) |\r\nMC44S803_REG_SM(3, MC44S803_XOD);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_LNAAGC, MC44S803_ADDR) |\r\nMC44S803_REG_SM(1, MC44S803_AT1) |\r\nMC44S803_REG_SM(1, MC44S803_AT2) |\r\nMC44S803_REG_SM(1, MC44S803_AGC_AN_DIG) |\r\nMC44S803_REG_SM(1, MC44S803_AGC_READ_EN) |\r\nMC44S803_REG_SM(1, MC44S803_LNA0);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nreturn 0;\r\nexit:\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nmc_printk(KERN_WARNING, "I/O Error\n");\r\nreturn err;\r\n}\r\nstatic int mc44s803_set_params(struct dvb_frontend *fe)\r\n{\r\nstruct mc44s803_priv *priv = fe->tuner_priv;\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nu32 r1, r2, n1, n2, lo1, lo2, freq, val;\r\nint err;\r\npriv->frequency = c->frequency;\r\nr1 = MC44S803_OSC / 1000000;\r\nr2 = MC44S803_OSC / 100000;\r\nn1 = (c->frequency + MC44S803_IF1 + 500000) / 1000000;\r\nfreq = MC44S803_OSC / r1 * n1;\r\nlo1 = ((60 * n1) + (r1 / 2)) / r1;\r\nfreq = freq - c->frequency;\r\nn2 = (freq - MC44S803_IF2 + 50000) / 100000;\r\nlo2 = ((60 * n2) + (r2 / 2)) / r2;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nval = MC44S803_REG_SM(MC44S803_REG_REFDIV, MC44S803_ADDR) |\r\nMC44S803_REG_SM(r1-1, MC44S803_R1) |\r\nMC44S803_REG_SM(r2-1, MC44S803_R2) |\r\nMC44S803_REG_SM(1, MC44S803_REFBUF_EN);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_LO1, MC44S803_ADDR) |\r\nMC44S803_REG_SM(n1-2, MC44S803_LO1);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_LO2, MC44S803_ADDR) |\r\nMC44S803_REG_SM(n2-2, MC44S803_LO2);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_DIGTUNE, MC44S803_ADDR) |\r\nMC44S803_REG_SM(1, MC44S803_DA) |\r\nMC44S803_REG_SM(lo1, MC44S803_LO_REF) |\r\nMC44S803_REG_SM(1, MC44S803_AT);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nval = MC44S803_REG_SM(MC44S803_REG_DIGTUNE, MC44S803_ADDR) |\r\nMC44S803_REG_SM(2, MC44S803_DA) |\r\nMC44S803_REG_SM(lo2, MC44S803_LO_REF) |\r\nMC44S803_REG_SM(1, MC44S803_AT);\r\nerr = mc44s803_writereg(priv, val);\r\nif (err)\r\ngoto exit;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nreturn 0;\r\nexit:\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nmc_printk(KERN_WARNING, "I/O Error\n");\r\nreturn err;\r\n}\r\nstatic int mc44s803_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct mc44s803_priv *priv = fe->tuner_priv;\r\n*frequency = priv->frequency;\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *mc44s803_attach(struct dvb_frontend *fe,\r\nstruct i2c_adapter *i2c, struct mc44s803_config *cfg)\r\n{\r\nstruct mc44s803_priv *priv;\r\nu32 reg;\r\nu8 id;\r\nint ret;\r\nreg = 0;\r\npriv = kzalloc(sizeof(struct mc44s803_priv), GFP_KERNEL);\r\nif (priv == NULL)\r\nreturn NULL;\r\npriv->cfg = cfg;\r\npriv->i2c = i2c;\r\npriv->fe = fe;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nret = mc44s803_readreg(priv, MC44S803_REG_ID, &reg);\r\nif (ret)\r\ngoto error;\r\nid = MC44S803_REG_MS(reg, MC44S803_ID);\r\nif (id != 0x14) {\r\nmc_printk(KERN_ERR, "unsupported ID "\r\n"(%x should be 0x14)\n", id);\r\ngoto error;\r\n}\r\nmc_printk(KERN_INFO, "successfully identified (ID = %x)\n", id);\r\nmemcpy(&fe->ops.tuner_ops, &mc44s803_tuner_ops,\r\nsizeof(struct dvb_tuner_ops));\r\nfe->tuner_priv = priv;\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nreturn fe;\r\nerror:\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\nkfree(priv);\r\nreturn NULL;\r\n}

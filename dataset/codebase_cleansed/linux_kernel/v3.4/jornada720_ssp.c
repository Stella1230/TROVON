u8 inline jornada_ssp_reverse(u8 byte)\r\n{\r\nreturn\r\n((0x80 & byte) >> 7) |\r\n((0x40 & byte) >> 5) |\r\n((0x20 & byte) >> 3) |\r\n((0x10 & byte) >> 1) |\r\n((0x08 & byte) << 1) |\r\n((0x04 & byte) << 3) |\r\n((0x02 & byte) << 5) |\r\n((0x01 & byte) << 7);\r\n}\r\nint jornada_ssp_byte(u8 byte)\r\n{\r\nint timeout = 400000;\r\nu16 ret;\r\nwhile ((GPLR & GPIO_GPIO10)) {\r\nif (!--timeout) {\r\nprintk(KERN_WARNING "SSP: timeout while waiting for transmit\n");\r\nreturn -ETIMEDOUT;\r\n}\r\ncpu_relax();\r\n}\r\nret = jornada_ssp_reverse(byte) << 8;\r\nssp_write_word(ret);\r\nssp_read_word(&ret);\r\nreturn jornada_ssp_reverse(ret);\r\n}\r\nint jornada_ssp_inout(u8 byte)\r\n{\r\nint ret, i;\r\nif (byte != TXDUMMY) {\r\nret = jornada_ssp_byte(byte);\r\nif (ret != TXDUMMY) {\r\nfor (i = 0; i < 256; i++)\r\nif (jornada_ssp_byte(TXDUMMY) == -1)\r\nbreak;\r\nreturn -ETIMEDOUT;\r\n}\r\n} else\r\nret = jornada_ssp_byte(TXDUMMY);\r\nreturn ret;\r\n}\r\nvoid jornada_ssp_start(void)\r\n{\r\nspin_lock_irqsave(&jornada_ssp_lock, jornada_ssp_flags);\r\nGPCR = GPIO_GPIO25;\r\nudelay(50);\r\nreturn;\r\n}\r\nvoid jornada_ssp_end(void)\r\n{\r\nGPSR = GPIO_GPIO25;\r\nspin_unlock_irqrestore(&jornada_ssp_lock, jornada_ssp_flags);\r\nreturn;\r\n}\r\nstatic int __devinit jornada_ssp_probe(struct platform_device *dev)\r\n{\r\nint ret;\r\nGPSR = GPIO_GPIO25;\r\nret = ssp_init();\r\nif (!ret) {\r\nprintk(KERN_INFO "SSP: device initialized with irq\n");\r\nreturn ret;\r\n}\r\nprintk(KERN_WARNING "SSP: initialization failed, trying non-irq solution \n");\r\nSer4MCCR0 = 0;\r\nSer4SSCR0 = 0x0387;\r\nSer4SSCR1 = 0x18;\r\nssp_flush();\r\njornada_ssp_start();\r\nret = jornada_ssp_inout(GETBRIGHTNESS);\r\nif (ret == TXDUMMY)\r\njornada_ssp_inout(TXDUMMY);\r\njornada_ssp_end();\r\nif (ret == -ETIMEDOUT) {\r\nprintk(KERN_WARNING "SSP: attempts failed, bailing\n");\r\nssp_exit();\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO "SSP: device initialized\n");\r\nreturn 0;\r\n}\r\nstatic int jornada_ssp_remove(struct platform_device *dev)\r\n{\r\nGPSR = GPIO_GPIO25;\r\nssp_exit();\r\nreturn 0;\r\n}\r\nstatic int __init jornada_ssp_init(void)\r\n{\r\nreturn platform_driver_register(&jornadassp_driver);\r\n}

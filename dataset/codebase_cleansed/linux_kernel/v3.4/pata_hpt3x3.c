static void hpt3x3_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu32 r1, r2;\r\nint dn = 2 * ap->port_no + adev->devno;\r\npci_read_config_dword(pdev, 0x44, &r1);\r\npci_read_config_dword(pdev, 0x48, &r2);\r\nr1 &= ~(7 << (3 * dn));\r\nr1 |= (adev->pio_mode - XFER_PIO_0) << (3 * dn);\r\nr2 &= ~(0x11 << dn);\r\npci_write_config_dword(pdev, 0x44, r1);\r\npci_write_config_dword(pdev, 0x48, r2);\r\n}\r\nstatic void hpt3x3_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu32 r1, r2;\r\nint dn = 2 * ap->port_no + adev->devno;\r\nint mode_num = adev->dma_mode & 0x0F;\r\npci_read_config_dword(pdev, 0x44, &r1);\r\npci_read_config_dword(pdev, 0x48, &r2);\r\nr1 &= ~(7 << (3 * dn));\r\nr1 |= (mode_num << (3 * dn));\r\nr2 &= ~(0x11 << dn);\r\nif (adev->dma_mode >= XFER_UDMA_0)\r\nr2 |= (0x01 << dn);\r\nelse\r\nr2 |= (0x10 << dn);\r\npci_write_config_dword(pdev, 0x44, r1);\r\npci_write_config_dword(pdev, 0x48, r2);\r\n}\r\nstatic void hpt3x3_freeze(struct ata_port *ap)\r\n{\r\nvoid __iomem *mmio = ap->ioaddr.bmdma_addr;\r\niowrite8(ioread8(mmio + ATA_DMA_CMD) & ~ ATA_DMA_START,\r\nmmio + ATA_DMA_CMD);\r\nata_sff_dma_pause(ap);\r\nata_sff_freeze(ap);\r\n}\r\nstatic void hpt3x3_bmdma_setup(struct ata_queued_cmd *qc)\r\n{\r\nstruct ata_port *ap = qc->ap;\r\nu8 r = ioread8(ap->ioaddr.bmdma_addr + ATA_DMA_STATUS);\r\nr |= ATA_DMA_INTR | ATA_DMA_ERR;\r\niowrite8(r, ap->ioaddr.bmdma_addr + ATA_DMA_STATUS);\r\nreturn ata_bmdma_setup(qc);\r\n}\r\nstatic int hpt3x3_atapi_dma(struct ata_queued_cmd *qc)\r\n{\r\nreturn 1;\r\n}\r\nstatic void hpt3x3_init_chipset(struct pci_dev *dev)\r\n{\r\nu16 cmd;\r\npci_write_config_word(dev, 0x80, 0x00);\r\npci_read_config_word(dev, PCI_COMMAND, &cmd);\r\nif (cmd & PCI_COMMAND_MEMORY)\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, 0xF0);\r\nelse\r\npci_write_config_byte(dev, PCI_LATENCY_TIMER, 0x20);\r\n}\r\nstatic int hpt3x3_init_one(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n#if defined(CONFIG_PATA_HPT3X3_DMA)\r\n.mwdma_mask = ATA_MWDMA2,\r\n.udma_mask = ATA_UDMA2,\r\n#endif\r\n.port_ops = &hpt3x3_port_ops\r\n};\r\nstatic const u8 offset_cmd[2] = { 0x20, 0x28 };\r\nstatic const u8 offset_ctl[2] = { 0x36, 0x3E };\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nstruct ata_host *host;\r\nint i, rc;\r\nvoid __iomem *base;\r\nhpt3x3_init_chipset(pdev);\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nhost = ata_host_alloc_pinfo(&pdev->dev, ppi, 2);\r\nif (!host)\r\nreturn -ENOMEM;\r\nrc = pcim_enable_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nrc = pcim_iomap_regions(pdev, 1 << 4, DRV_NAME);\r\nif (rc == -EBUSY)\r\npcim_pin_device(pdev);\r\nif (rc)\r\nreturn rc;\r\nhost->iomap = pcim_iomap_table(pdev);\r\nrc = pci_set_dma_mask(pdev, ATA_DMA_MASK);\r\nif (rc)\r\nreturn rc;\r\nrc = pci_set_consistent_dma_mask(pdev, ATA_DMA_MASK);\r\nif (rc)\r\nreturn rc;\r\nbase = host->iomap[4];\r\nfor (i = 0; i < host->n_ports; i++) {\r\nstruct ata_port *ap = host->ports[i];\r\nstruct ata_ioports *ioaddr = &ap->ioaddr;\r\nioaddr->cmd_addr = base + offset_cmd[i];\r\nioaddr->altstatus_addr =\r\nioaddr->ctl_addr = base + offset_ctl[i];\r\nioaddr->scr_addr = NULL;\r\nata_sff_std_ports(ioaddr);\r\nioaddr->bmdma_addr = base + 8 * i;\r\nata_port_pbar_desc(ap, 4, -1, "ioport");\r\nata_port_pbar_desc(ap, 4, offset_cmd[i], "cmd");\r\n}\r\npci_set_master(pdev);\r\nreturn ata_host_activate(host, pdev->irq, ata_bmdma_interrupt,\r\nIRQF_SHARED, &hpt3x3_sht);\r\n}\r\nstatic int hpt3x3_reinit_one(struct pci_dev *dev)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&dev->dev);\r\nint rc;\r\nrc = ata_pci_device_do_resume(dev);\r\nif (rc)\r\nreturn rc;\r\nhpt3x3_init_chipset(dev);\r\nata_host_resume(host);\r\nreturn 0;\r\n}\r\nstatic int __init hpt3x3_init(void)\r\n{\r\nreturn pci_register_driver(&hpt3x3_pci_driver);\r\n}\r\nstatic void __exit hpt3x3_exit(void)\r\n{\r\npci_unregister_driver(&hpt3x3_pci_driver);\r\n}

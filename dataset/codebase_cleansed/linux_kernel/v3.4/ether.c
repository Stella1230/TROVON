static inline bool has_rndis(void)\r\n{\r\n#ifdef USB_ETH_RNDIS\r\nreturn true;\r\n#else\r\nreturn false;\r\n#endif\r\n}\r\nstatic int __init rndis_do_config(struct usb_configuration *c)\r\n{\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nreturn rndis_bind_config(c, hostaddr);\r\n}\r\nstatic int __init eth_do_config(struct usb_configuration *c)\r\n{\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nif (use_eem)\r\nreturn eem_bind_config(c);\r\nelse if (can_support_ecm(c->cdev->gadget))\r\nreturn ecm_bind_config(c, hostaddr);\r\nelse\r\nreturn geth_bind_config(c, hostaddr);\r\n}\r\nstatic int __init eth_bind(struct usb_composite_dev *cdev)\r\n{\r\nint gcnum;\r\nstruct usb_gadget *gadget = cdev->gadget;\r\nint status;\r\nstatus = gether_setup(cdev->gadget, hostaddr);\r\nif (status < 0)\r\nreturn status;\r\nif (use_eem) {\r\neth_config_driver.label = "CDC Ethernet (EEM)";\r\ndevice_desc.idVendor = cpu_to_le16(EEM_VENDOR_NUM);\r\ndevice_desc.idProduct = cpu_to_le16(EEM_PRODUCT_NUM);\r\n} else if (can_support_ecm(cdev->gadget)) {\r\neth_config_driver.label = "CDC Ethernet (ECM)";\r\n} else {\r\neth_config_driver.label = "CDC Subset/SAFE";\r\ndevice_desc.idVendor = cpu_to_le16(SIMPLE_VENDOR_NUM);\r\ndevice_desc.idProduct = cpu_to_le16(SIMPLE_PRODUCT_NUM);\r\nif (!has_rndis())\r\ndevice_desc.bDeviceClass = USB_CLASS_VENDOR_SPEC;\r\n}\r\nif (has_rndis()) {\r\ndevice_desc.idVendor = cpu_to_le16(RNDIS_VENDOR_NUM);\r\ndevice_desc.idProduct = cpu_to_le16(RNDIS_PRODUCT_NUM);\r\ndevice_desc.bNumConfigurations = 2;\r\n}\r\ngcnum = usb_gadget_controller_number(gadget);\r\nif (gcnum >= 0)\r\ndevice_desc.bcdDevice = cpu_to_le16(0x0300 | gcnum);\r\nelse {\r\ndev_warn(&gadget->dev,\r\n"controller '%s' not recognized; trying %s\n",\r\ngadget->name,\r\neth_config_driver.label);\r\ndevice_desc.bcdDevice =\r\ncpu_to_le16(0x0300 | 0x0099);\r\n}\r\nsnprintf(manufacturer, sizeof manufacturer, "%s %s with %s",\r\ninit_utsname()->sysname, init_utsname()->release,\r\ngadget->name);\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\ngoto fail;\r\nstrings_dev[STRING_MANUFACTURER_IDX].id = status;\r\ndevice_desc.iManufacturer = status;\r\nstatus = usb_string_id(cdev);\r\nif (status < 0)\r\ngoto fail;\r\nstrings_dev[STRING_PRODUCT_IDX].id = status;\r\ndevice_desc.iProduct = status;\r\nif (has_rndis()) {\r\nstatus = usb_add_config(cdev, &rndis_config_driver,\r\nrndis_do_config);\r\nif (status < 0)\r\ngoto fail;\r\n}\r\nstatus = usb_add_config(cdev, &eth_config_driver, eth_do_config);\r\nif (status < 0)\r\ngoto fail;\r\ndev_info(&gadget->dev, "%s, version: " DRIVER_VERSION "\n",\r\nDRIVER_DESC);\r\nreturn 0;\r\nfail:\r\ngether_cleanup();\r\nreturn status;\r\n}\r\nstatic int __exit eth_unbind(struct usb_composite_dev *cdev)\r\n{\r\ngether_cleanup();\r\nreturn 0;\r\n}\r\nstatic int __init init(void)\r\n{\r\nreturn usb_composite_probe(&eth_driver, eth_bind);\r\n}\r\nstatic void __exit cleanup(void)\r\n{\r\nusb_composite_unregister(&eth_driver);\r\n}

static struct rr_priv *rr_priv(struct team *team)\r\n{\r\nreturn (struct rr_priv *) &team->mode_priv;\r\n}\r\nstatic struct team_port *__get_first_port_up(struct team *team,\r\nstruct team_port *port)\r\n{\r\nstruct team_port *cur;\r\nif (port->linkup)\r\nreturn port;\r\ncur = port;\r\nlist_for_each_entry_continue_rcu(cur, &team->port_list, list)\r\nif (cur->linkup)\r\nreturn cur;\r\nlist_for_each_entry_rcu(cur, &team->port_list, list) {\r\nif (cur == port)\r\nbreak;\r\nif (cur->linkup)\r\nreturn cur;\r\n}\r\nreturn NULL;\r\n}\r\nstatic bool rr_transmit(struct team *team, struct sk_buff *skb)\r\n{\r\nstruct team_port *port;\r\nint port_index;\r\nport_index = rr_priv(team)->sent_packets++ % team->port_count;\r\nport = team_get_port_by_index_rcu(team, port_index);\r\nport = __get_first_port_up(team, port);\r\nif (unlikely(!port))\r\ngoto drop;\r\nskb->dev = port->dev;\r\nif (dev_queue_xmit(skb))\r\nreturn false;\r\nreturn true;\r\ndrop:\r\ndev_kfree_skb_any(skb);\r\nreturn false;\r\n}\r\nstatic int rr_port_enter(struct team *team, struct team_port *port)\r\n{\r\nreturn team_port_set_team_mac(port);\r\n}\r\nstatic void rr_port_change_mac(struct team *team, struct team_port *port)\r\n{\r\nteam_port_set_team_mac(port);\r\n}\r\nstatic int __init rr_init_module(void)\r\n{\r\nreturn team_mode_register(&rr_mode);\r\n}\r\nstatic void __exit rr_cleanup_module(void)\r\n{\r\nteam_mode_unregister(&rr_mode);\r\n}

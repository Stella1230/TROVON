static int iwm_nonwifi_cmd_init(struct iwm_priv *iwm,\r\nstruct iwm_nonwifi_cmd *cmd,\r\nstruct iwm_udma_nonwifi_cmd *udma_cmd)\r\n{\r\nINIT_LIST_HEAD(&cmd->pending);\r\nspin_lock(&iwm->cmd_lock);\r\ncmd->resp_received = 0;\r\ncmd->seq_num = iwm->nonwifi_seq_num;\r\nudma_cmd->seq_num = cpu_to_le16(cmd->seq_num);\r\niwm->nonwifi_seq_num++;\r\niwm->nonwifi_seq_num %= UMAC_NONWIFI_SEQ_NUM_MAX;\r\nif (udma_cmd->resp)\r\nlist_add_tail(&cmd->pending, &iwm->nonwifi_pending_cmd);\r\nspin_unlock(&iwm->cmd_lock);\r\ncmd->buf.start = cmd->buf.payload;\r\ncmd->buf.len = 0;\r\nmemcpy(&cmd->udma_cmd, udma_cmd, sizeof(*udma_cmd));\r\nreturn cmd->seq_num;\r\n}\r\nu16 iwm_alloc_wifi_cmd_seq(struct iwm_priv *iwm)\r\n{\r\nu16 seq_num = iwm->wifi_seq_num;\r\niwm->wifi_seq_num++;\r\niwm->wifi_seq_num %= UMAC_WIFI_SEQ_NUM_MAX;\r\nreturn seq_num;\r\n}\r\nstatic void iwm_wifi_cmd_init(struct iwm_priv *iwm,\r\nstruct iwm_wifi_cmd *cmd,\r\nstruct iwm_udma_wifi_cmd *udma_cmd,\r\nstruct iwm_umac_cmd *umac_cmd,\r\nstruct iwm_lmac_cmd *lmac_cmd,\r\nu16 payload_size)\r\n{\r\nINIT_LIST_HEAD(&cmd->pending);\r\nspin_lock(&iwm->cmd_lock);\r\ncmd->seq_num = iwm_alloc_wifi_cmd_seq(iwm);\r\numac_cmd->seq_num = cpu_to_le16(cmd->seq_num);\r\nif (umac_cmd->resp)\r\nlist_add_tail(&cmd->pending, &iwm->wifi_pending_cmd);\r\nspin_unlock(&iwm->cmd_lock);\r\ncmd->buf.start = cmd->buf.payload;\r\ncmd->buf.len = 0;\r\nif (lmac_cmd) {\r\ncmd->buf.start -= sizeof(struct iwm_lmac_hdr);\r\nlmac_cmd->seq_num = cpu_to_le16(cmd->seq_num);\r\nlmac_cmd->count = cpu_to_le16(payload_size);\r\nmemcpy(&cmd->lmac_cmd, lmac_cmd, sizeof(*lmac_cmd));\r\numac_cmd->count = cpu_to_le16(sizeof(struct iwm_lmac_hdr));\r\n} else\r\numac_cmd->count = 0;\r\numac_cmd->count = cpu_to_le16(payload_size +\r\nle16_to_cpu(umac_cmd->count));\r\nudma_cmd->count = cpu_to_le16(sizeof(struct iwm_umac_fw_cmd_hdr) +\r\nle16_to_cpu(umac_cmd->count));\r\nmemcpy(&cmd->udma_cmd, udma_cmd, sizeof(*udma_cmd));\r\nmemcpy(&cmd->umac_cmd, umac_cmd, sizeof(*umac_cmd));\r\n}\r\nvoid iwm_cmd_flush(struct iwm_priv *iwm)\r\n{\r\nstruct iwm_wifi_cmd *wcmd, *wnext;\r\nstruct iwm_nonwifi_cmd *nwcmd, *nwnext;\r\nlist_for_each_entry_safe(wcmd, wnext, &iwm->wifi_pending_cmd, pending) {\r\nlist_del(&wcmd->pending);\r\nkfree(wcmd);\r\n}\r\nlist_for_each_entry_safe(nwcmd, nwnext, &iwm->nonwifi_pending_cmd,\r\npending) {\r\nlist_del(&nwcmd->pending);\r\nkfree(nwcmd);\r\n}\r\n}\r\nstruct iwm_wifi_cmd *iwm_get_pending_wifi_cmd(struct iwm_priv *iwm, u16 seq_num)\r\n{\r\nstruct iwm_wifi_cmd *cmd;\r\nlist_for_each_entry(cmd, &iwm->wifi_pending_cmd, pending)\r\nif (cmd->seq_num == seq_num) {\r\nlist_del(&cmd->pending);\r\nreturn cmd;\r\n}\r\nreturn NULL;\r\n}\r\nstruct iwm_nonwifi_cmd *iwm_get_pending_nonwifi_cmd(struct iwm_priv *iwm,\r\nu8 seq_num, u8 cmd_opcode)\r\n{\r\nstruct iwm_nonwifi_cmd *cmd;\r\nlist_for_each_entry(cmd, &iwm->nonwifi_pending_cmd, pending)\r\nif ((cmd->seq_num == seq_num) &&\r\n(cmd->udma_cmd.opcode == cmd_opcode) &&\r\n(cmd->resp_received)) {\r\nlist_del(&cmd->pending);\r\nreturn cmd;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void iwm_build_udma_nonwifi_hdr(struct iwm_priv *iwm,\r\nstruct iwm_udma_out_nonwifi_hdr *hdr,\r\nstruct iwm_udma_nonwifi_cmd *cmd)\r\n{\r\nmemset(hdr, 0, sizeof(*hdr));\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_OPCODE, cmd->opcode);\r\nSET_VAL32(hdr->cmd, UDMA_HDI_OUT_NW_CMD_RESP, cmd->resp);\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_EOT, 1);\r\nSET_VAL32(hdr->cmd, UDMA_HDI_OUT_NW_CMD_HANDLE_BY_HW,\r\ncmd->handle_by_hw);\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_SIGNATURE, UMAC_HDI_OUT_SIGNATURE);\r\nSET_VAL32(hdr->cmd, UDMA_HDI_OUT_CMD_NON_WIFI_HW_SEQ_NUM,\r\nle16_to_cpu(cmd->seq_num));\r\nhdr->addr = cmd->addr;\r\nhdr->op1_sz = cmd->op1_sz;\r\nhdr->op2 = cmd->op2;\r\n}\r\nstatic int iwm_send_udma_nonwifi_cmd(struct iwm_priv *iwm,\r\nstruct iwm_nonwifi_cmd *cmd)\r\n{\r\nstruct iwm_udma_out_nonwifi_hdr *udma_hdr;\r\nstruct iwm_nonwifi_cmd_buff *buf;\r\nstruct iwm_udma_nonwifi_cmd *udma_cmd = &cmd->udma_cmd;\r\nbuf = &cmd->buf;\r\nbuf->start -= sizeof(struct iwm_umac_nonwifi_out_hdr);\r\nbuf->len += sizeof(struct iwm_umac_nonwifi_out_hdr);\r\nudma_hdr = (struct iwm_udma_out_nonwifi_hdr *)(buf->start);\r\niwm_build_udma_nonwifi_hdr(iwm, udma_hdr, udma_cmd);\r\nIWM_DBG_CMD(iwm, DBG,\r\n"Send UDMA nonwifi cmd: opcode = 0x%x, resp = 0x%x, "\r\n"hw = 0x%x, seqnum = %d, addr = 0x%x, op1_sz = 0x%x, "\r\n"op2 = 0x%x\n", udma_cmd->opcode, udma_cmd->resp,\r\nudma_cmd->handle_by_hw, cmd->seq_num, udma_cmd->addr,\r\nudma_cmd->op1_sz, udma_cmd->op2);\r\ntrace_iwm_tx_nonwifi_cmd(iwm, udma_hdr);\r\nreturn iwm_bus_send_chunk(iwm, buf->start, buf->len);\r\n}\r\nvoid iwm_udma_wifi_hdr_set_eop(struct iwm_priv *iwm, u8 *buf, u8 eop)\r\n{\r\nstruct iwm_udma_out_wifi_hdr *hdr = (struct iwm_udma_out_wifi_hdr *)buf;\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_EOT, eop);\r\n}\r\nvoid iwm_build_udma_wifi_hdr(struct iwm_priv *iwm,\r\nstruct iwm_udma_out_wifi_hdr *hdr,\r\nstruct iwm_udma_wifi_cmd *cmd)\r\n{\r\nmemset(hdr, 0, sizeof(*hdr));\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_OPCODE, UMAC_HDI_OUT_OPCODE_WIFI);\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_EOT, cmd->eop);\r\nSET_VAL32(hdr->cmd, UMAC_HDI_OUT_CMD_SIGNATURE, UMAC_HDI_OUT_SIGNATURE);\r\nSET_VAL32(hdr->meta_data, UMAC_HDI_OUT_BYTE_COUNT,\r\nle16_to_cpu(cmd->count));\r\nSET_VAL32(hdr->meta_data, UMAC_HDI_OUT_CREDIT_GRP, cmd->credit_group);\r\nSET_VAL32(hdr->meta_data, UMAC_HDI_OUT_RATID, cmd->ra_tid);\r\nSET_VAL32(hdr->meta_data, UMAC_HDI_OUT_LMAC_OFFSET, cmd->lmac_offset);\r\n}\r\nvoid iwm_build_umac_hdr(struct iwm_priv *iwm,\r\nstruct iwm_umac_fw_cmd_hdr *hdr,\r\nstruct iwm_umac_cmd *cmd)\r\n{\r\nmemset(hdr, 0, sizeof(*hdr));\r\nSET_VAL32(hdr->meta_data, UMAC_FW_CMD_BYTE_COUNT,\r\nle16_to_cpu(cmd->count));\r\nSET_VAL32(hdr->meta_data, UMAC_FW_CMD_TX_STA_COLOR, cmd->color);\r\nSET_VAL8(hdr->cmd.flags, UMAC_DEV_CMD_FLAGS_RESP_REQ, cmd->resp);\r\nhdr->cmd.cmd = cmd->id;\r\nhdr->cmd.seq_num = cmd->seq_num;\r\n}\r\nstatic int iwm_send_udma_wifi_cmd(struct iwm_priv *iwm,\r\nstruct iwm_wifi_cmd *cmd)\r\n{\r\nstruct iwm_umac_wifi_out_hdr *umac_hdr;\r\nstruct iwm_wifi_cmd_buff *buf;\r\nstruct iwm_udma_wifi_cmd *udma_cmd = &cmd->udma_cmd;\r\nstruct iwm_umac_cmd *umac_cmd = &cmd->umac_cmd;\r\nint ret;\r\nbuf = &cmd->buf;\r\nbuf->start -= sizeof(struct iwm_umac_wifi_out_hdr);\r\nbuf->len += sizeof(struct iwm_umac_wifi_out_hdr);\r\numac_hdr = (struct iwm_umac_wifi_out_hdr *)(buf->start);\r\niwm_build_udma_wifi_hdr(iwm, &umac_hdr->hw_hdr, udma_cmd);\r\niwm_build_umac_hdr(iwm, &umac_hdr->sw_hdr, umac_cmd);\r\nIWM_DBG_CMD(iwm, DBG,\r\n"Send UDMA wifi cmd: opcode = 0x%x, UMAC opcode = 0x%x, "\r\n"eop = 0x%x, count = 0x%x, credit_group = 0x%x, "\r\n"ra_tid = 0x%x, lmac_offset = 0x%x, seqnum = %d\n",\r\nUMAC_HDI_OUT_OPCODE_WIFI, umac_cmd->id,\r\nudma_cmd->eop, udma_cmd->count, udma_cmd->credit_group,\r\nudma_cmd->ra_tid, udma_cmd->lmac_offset, cmd->seq_num);\r\nif (umac_cmd->id == UMAC_CMD_OPCODE_WIFI_PASS_THROUGH)\r\nIWM_DBG_CMD(iwm, DBG, "\tLMAC opcode: 0x%x\n",\r\ncmd->lmac_cmd.id);\r\nret = iwm_tx_credit_alloc(iwm, udma_cmd->credit_group, buf->len);\r\nif (ret && (umac_cmd->id != UMAC_CMD_OPCODE_RESET)) {\r\nIWM_DBG_TX(iwm, DBG, "Failed to alloc tx credit for cmd %d\n",\r\numac_cmd->id);\r\nreturn ret;\r\n}\r\ntrace_iwm_tx_wifi_cmd(iwm, umac_hdr);\r\nreturn iwm_bus_send_chunk(iwm, buf->start, buf->len);\r\n}\r\nint iwm_hal_send_target_cmd(struct iwm_priv *iwm,\r\nstruct iwm_udma_nonwifi_cmd *udma_cmd,\r\nconst void *payload)\r\n{\r\nstruct iwm_nonwifi_cmd *cmd;\r\nint ret, seq_num;\r\ncmd = kzalloc(sizeof(struct iwm_nonwifi_cmd), GFP_KERNEL);\r\nif (!cmd) {\r\nIWM_ERR(iwm, "Couldn't alloc memory for hal cmd\n");\r\nreturn -ENOMEM;\r\n}\r\nseq_num = iwm_nonwifi_cmd_init(iwm, cmd, udma_cmd);\r\nif (cmd->udma_cmd.opcode == UMAC_HDI_OUT_OPCODE_WRITE ||\r\ncmd->udma_cmd.opcode == UMAC_HDI_OUT_OPCODE_WRITE_PERSISTENT) {\r\ncmd->buf.len = le32_to_cpu(cmd->udma_cmd.op1_sz);\r\nmemcpy(&cmd->buf.payload, payload, cmd->buf.len);\r\n}\r\nret = iwm_send_udma_nonwifi_cmd(iwm, cmd);\r\nif (!udma_cmd->resp)\r\nkfree(cmd);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn seq_num;\r\n}\r\nstatic void iwm_build_lmac_hdr(struct iwm_priv *iwm, struct iwm_lmac_hdr *hdr,\r\nstruct iwm_lmac_cmd *cmd)\r\n{\r\nmemset(hdr, 0, sizeof(*hdr));\r\nhdr->id = cmd->id;\r\nhdr->flags = 0;\r\nhdr->seq_num = cmd->seq_num;\r\n}\r\nint iwm_hal_send_host_cmd(struct iwm_priv *iwm,\r\nstruct iwm_udma_wifi_cmd *udma_cmd,\r\nstruct iwm_umac_cmd *umac_cmd,\r\nstruct iwm_lmac_cmd *lmac_cmd,\r\nconst void *payload, u16 payload_size)\r\n{\r\nstruct iwm_wifi_cmd *cmd;\r\nstruct iwm_lmac_hdr *hdr;\r\nint lmac_hdr_len = 0;\r\nint ret;\r\ncmd = kzalloc(sizeof(struct iwm_wifi_cmd), GFP_KERNEL);\r\nif (!cmd) {\r\nIWM_ERR(iwm, "Couldn't alloc memory for wifi hal cmd\n");\r\nreturn -ENOMEM;\r\n}\r\niwm_wifi_cmd_init(iwm, cmd, udma_cmd, umac_cmd, lmac_cmd, payload_size);\r\nif (lmac_cmd) {\r\nhdr = (struct iwm_lmac_hdr *)(cmd->buf.start);\r\niwm_build_lmac_hdr(iwm, hdr, &cmd->lmac_cmd);\r\nlmac_hdr_len = sizeof(struct iwm_lmac_hdr);\r\n}\r\nmemcpy(cmd->buf.payload, payload, payload_size);\r\ncmd->buf.len = le16_to_cpu(umac_cmd->count);\r\nret = iwm_send_udma_wifi_cmd(iwm, cmd);\r\nif (!umac_cmd->resp)\r\nkfree(cmd);\r\nreturn ret;\r\n}\r\nint iwm_hal_send_umac_cmd(struct iwm_priv *iwm,\r\nstruct iwm_udma_wifi_cmd *udma_cmd,\r\nstruct iwm_umac_cmd *umac_cmd,\r\nconst void *payload, u16 payload_size)\r\n{\r\nreturn iwm_hal_send_host_cmd(iwm, udma_cmd, umac_cmd, NULL,\r\npayload, payload_size);\r\n}

static void davinci_vcif_start(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct davinci_vcif_dev *davinci_vcif_dev =\r\nsnd_soc_dai_get_drvdata(rtd->cpu_dai);\r\nstruct davinci_vc *davinci_vc = davinci_vcif_dev->davinci_vc;\r\nu32 w;\r\nw = readl(davinci_vc->base + DAVINCI_VC_CTRL);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RSTDAC, 0);\r\nelse\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RSTADC, 0);\r\nwritel(w, davinci_vc->base + DAVINCI_VC_CTRL);\r\n}\r\nstatic void davinci_vcif_stop(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct davinci_vcif_dev *davinci_vcif_dev =\r\nsnd_soc_dai_get_drvdata(rtd->cpu_dai);\r\nstruct davinci_vc *davinci_vc = davinci_vcif_dev->davinci_vc;\r\nu32 w;\r\nw = readl(davinci_vc->base + DAVINCI_VC_CTRL);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RSTDAC, 1);\r\nelse\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RSTADC, 1);\r\nwritel(w, davinci_vc->base + DAVINCI_VC_CTRL);\r\n}\r\nstatic int davinci_vcif_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct davinci_vcif_dev *davinci_vcif_dev = snd_soc_dai_get_drvdata(dai);\r\nstruct davinci_vc *davinci_vc = davinci_vcif_dev->davinci_vc;\r\nstruct davinci_pcm_dma_params *dma_params =\r\n&davinci_vcif_dev->dma_params[substream->stream];\r\nu32 w;\r\ndavinci_vcif_stop(substream);\r\ndavinci_vcif_start(substream);\r\nwritel(DAVINCI_VC_CTRL_MASK, davinci_vc->base + DAVINCI_VC_CTRL);\r\nwritel(DAVINCI_VC_INT_MASK, davinci_vc->base + DAVINCI_VC_INTCLR);\r\nwritel(DAVINCI_VC_INT_MASK, davinci_vc->base + DAVINCI_VC_INTEN);\r\nw = readl(davinci_vc->base + DAVINCI_VC_CTRL);\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_U8:\r\ndma_params->data_type = 0;\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RD_BITS_8 |\r\nDAVINCI_VC_CTRL_RD_UNSIGNED |\r\nDAVINCI_VC_CTRL_WD_BITS_8 |\r\nDAVINCI_VC_CTRL_WD_UNSIGNED, 1);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S8:\r\ndma_params->data_type = 1;\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RD_BITS_8 |\r\nDAVINCI_VC_CTRL_WD_BITS_8, 1);\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RD_UNSIGNED |\r\nDAVINCI_VC_CTRL_WD_UNSIGNED, 0);\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\ndma_params->data_type = 2;\r\nMOD_REG_BIT(w, DAVINCI_VC_CTRL_RD_BITS_8 |\r\nDAVINCI_VC_CTRL_RD_UNSIGNED |\r\nDAVINCI_VC_CTRL_WD_BITS_8 |\r\nDAVINCI_VC_CTRL_WD_UNSIGNED, 0);\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "davinci-vcif: unsupported PCM format");\r\nreturn -EINVAL;\r\n}\r\ndma_params->acnt = dma_params->data_type;\r\nwritel(w, davinci_vc->base + DAVINCI_VC_CTRL);\r\nreturn 0;\r\n}\r\nstatic int davinci_vcif_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nint ret = 0;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_RELEASE:\r\ndavinci_vcif_start(substream);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\ncase SNDRV_PCM_TRIGGER_PAUSE_PUSH:\r\ndavinci_vcif_stop(substream);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int davinci_vcif_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct davinci_vcif_dev *dev = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, dev->dma_params);\r\nreturn 0;\r\n}\r\nstatic int davinci_vcif_probe(struct platform_device *pdev)\r\n{\r\nstruct davinci_vc *davinci_vc = pdev->dev.platform_data;\r\nstruct davinci_vcif_dev *davinci_vcif_dev;\r\nint ret;\r\ndavinci_vcif_dev = devm_kzalloc(&pdev->dev,\r\nsizeof(struct davinci_vcif_dev),\r\nGFP_KERNEL);\r\nif (!davinci_vcif_dev) {\r\ndev_dbg(&pdev->dev,\r\n"could not allocate memory for private data\n");\r\nreturn -ENOMEM;\r\n}\r\ndavinci_vcif_dev->davinci_vc = davinci_vc;\r\ndavinci_vcif_dev->dma_params[SNDRV_PCM_STREAM_PLAYBACK].channel =\r\ndavinci_vc->davinci_vcif.dma_tx_channel;\r\ndavinci_vcif_dev->dma_params[SNDRV_PCM_STREAM_PLAYBACK].dma_addr =\r\ndavinci_vc->davinci_vcif.dma_tx_addr;\r\ndavinci_vcif_dev->dma_params[SNDRV_PCM_STREAM_CAPTURE].channel =\r\ndavinci_vc->davinci_vcif.dma_rx_channel;\r\ndavinci_vcif_dev->dma_params[SNDRV_PCM_STREAM_CAPTURE].dma_addr =\r\ndavinci_vc->davinci_vcif.dma_rx_addr;\r\ndev_set_drvdata(&pdev->dev, davinci_vcif_dev);\r\nret = snd_soc_register_dai(&pdev->dev, &davinci_vcif_dai);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "could not register dai\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int davinci_vcif_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nreturn 0;\r\n}

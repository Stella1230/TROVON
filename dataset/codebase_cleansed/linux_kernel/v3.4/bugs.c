static int __init no_halt(char *s)\r\n{\r\nWARN_ONCE(1, "\"no-hlt\" is deprecated, please use \"idle=poll\"\n");\r\nboot_cpu_data.hlt_works_ok = 0;\r\nreturn 1;\r\n}\r\nstatic int __init no_387(char *s)\r\n{\r\nboot_cpu_data.hard_math = 0;\r\nwrite_cr0(X86_CR0_TS | X86_CR0_EM | X86_CR0_MP | read_cr0());\r\nreturn 1;\r\n}\r\nstatic void __init check_fpu(void)\r\n{\r\ns32 fdiv_bug;\r\nif (!boot_cpu_data.hard_math) {\r\n#ifndef CONFIG_MATH_EMULATION\r\nprintk(KERN_EMERG "No coprocessor found and no math emulation present.\n");\r\nprintk(KERN_EMERG "Giving up.\n");\r\nfor (;;) ;\r\n#endif\r\nreturn;\r\n}\r\nkernel_fpu_begin();\r\n__asm__("fninit\n\t"\r\n"fldl %1\n\t"\r\n"fdivl %2\n\t"\r\n"fmull %2\n\t"\r\n"fldl %1\n\t"\r\n"fsubp %%st,%%st(1)\n\t"\r\n"fistpl %0\n\t"\r\n"fwait\n\t"\r\n"fninit"\r\n: "=m" (*&fdiv_bug)\r\n: "m" (*&x), "m" (*&y));\r\nkernel_fpu_end();\r\nboot_cpu_data.fdiv_bug = fdiv_bug;\r\nif (boot_cpu_data.fdiv_bug)\r\nprintk(KERN_WARNING "Hmm, FPU with FDIV bug.\n");\r\n}\r\nstatic void __init check_hlt(void)\r\n{\r\nif (boot_cpu_data.x86 >= 5 || paravirt_enabled())\r\nreturn;\r\nprintk(KERN_INFO "Checking 'hlt' instruction... ");\r\nif (!boot_cpu_data.hlt_works_ok) {\r\nprintk("disabled\n");\r\nreturn;\r\n}\r\nhalt();\r\nhalt();\r\nhalt();\r\nhalt();\r\nprintk(KERN_CONT "OK.\n");\r\n}\r\nstatic void __init check_popad(void)\r\n{\r\n#ifndef CONFIG_X86_POPAD_OK\r\nint res, inp = (int) &res;\r\nprintk(KERN_INFO "Checking for popad bug... ");\r\n__asm__ __volatile__(\r\n"movl $12345678,%%eax; movl $0,%%edi; pusha; popa; movl (%%edx,%%edi),%%ecx "\r\n: "=&a" (res)\r\n: "d" (inp)\r\n: "ecx", "edi");\r\nif (res != 12345678)\r\nprintk(KERN_CONT "Buggy.\n");\r\nelse\r\nprintk(KERN_CONT "OK.\n");\r\n#endif\r\n}\r\nstatic void __init check_config(void)\r\n{\r\n#if defined(CONFIG_X86_WP_WORKS_OK) || defined(CONFIG_X86_INVLPG) || \\r\ndefined(CONFIG_X86_BSWAP)\r\nif (boot_cpu_data.x86 == 3)\r\npanic("Kernel requires i486+ for 'invlpg' and other features");\r\n#endif\r\n}\r\nvoid __init check_bugs(void)\r\n{\r\nidentify_boot_cpu();\r\n#ifndef CONFIG_SMP\r\nprintk(KERN_INFO "CPU: ");\r\nprint_cpu_info(&boot_cpu_data);\r\n#endif\r\ncheck_config();\r\ncheck_fpu();\r\ncheck_hlt();\r\ncheck_popad();\r\ninit_utsname()->machine[1] =\r\n'0' + (boot_cpu_data.x86 > 6 ? 6 : boot_cpu_data.x86);\r\nalternative_instructions();\r\n}

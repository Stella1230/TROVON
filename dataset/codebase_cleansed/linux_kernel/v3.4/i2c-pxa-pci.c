static struct platform_device *add_i2c_device(struct pci_dev *dev, int bar)\r\n{\r\nstruct platform_device *pdev;\r\nstruct i2c_pxa_platform_data pdata;\r\nstruct resource res[2];\r\nstruct device_node *child;\r\nstatic int devnum;\r\nint ret;\r\nmemset(&pdata, 0, sizeof(struct i2c_pxa_platform_data));\r\nmemset(&res, 0, sizeof(res));\r\nres[0].flags = IORESOURCE_MEM;\r\nres[0].start = pci_resource_start(dev, bar);\r\nres[0].end = pci_resource_end(dev, bar);\r\nres[1].flags = IORESOURCE_IRQ;\r\nres[1].start = dev->irq;\r\nres[1].end = dev->irq;\r\nfor_each_child_of_node(dev->dev.of_node, child) {\r\nconst void *prop;\r\nstruct resource r;\r\nint ret;\r\nret = of_address_to_resource(child, 0, &r);\r\nif (ret < 0)\r\ncontinue;\r\nif (r.start != res[0].start)\r\ncontinue;\r\nif (r.end != res[0].end)\r\ncontinue;\r\nif (r.flags != res[0].flags)\r\ncontinue;\r\nprop = of_get_property(child, "fast-mode", NULL);\r\nif (prop)\r\npdata.fast_mode = 1;\r\nbreak;\r\n}\r\nif (!child) {\r\ndev_err(&dev->dev, "failed to match a DT node for bar %d.\n",\r\nbar);\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\npdev = platform_device_alloc("ce4100-i2c", devnum);\r\nif (!pdev) {\r\nof_node_put(child);\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\npdev->dev.parent = &dev->dev;\r\npdev->dev.of_node = child;\r\nret = platform_device_add_resources(pdev, res, ARRAY_SIZE(res));\r\nif (ret)\r\ngoto err;\r\nret = platform_device_add_data(pdev, &pdata, sizeof(pdata));\r\nif (ret)\r\ngoto err;\r\nret = platform_device_add(pdev);\r\nif (ret)\r\ngoto err;\r\ndevnum++;\r\nreturn pdev;\r\nerr:\r\nplatform_device_put(pdev);\r\nout:\r\nreturn ERR_PTR(ret);\r\n}\r\nstatic int __devinit ce4100_i2c_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint ret;\r\nint i;\r\nstruct ce4100_devices *sds;\r\nret = pci_enable_device_mem(dev);\r\nif (ret)\r\nreturn ret;\r\nif (!dev->dev.of_node) {\r\ndev_err(&dev->dev, "Missing device tree node.\n");\r\nreturn -EINVAL;\r\n}\r\nsds = kzalloc(sizeof(*sds), GFP_KERNEL);\r\nif (!sds) {\r\nret = -ENOMEM;\r\ngoto err_mem;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(sds->pdev); i++) {\r\nsds->pdev[i] = add_i2c_device(dev, i);\r\nif (IS_ERR(sds->pdev[i])) {\r\nret = PTR_ERR(sds->pdev[i]);\r\nwhile (--i >= 0)\r\nplatform_device_unregister(sds->pdev[i]);\r\ngoto err_dev_add;\r\n}\r\n}\r\npci_set_drvdata(dev, sds);\r\nreturn 0;\r\nerr_dev_add:\r\npci_set_drvdata(dev, NULL);\r\nkfree(sds);\r\nerr_mem:\r\npci_disable_device(dev);\r\nreturn ret;\r\n}\r\nstatic void __devexit ce4100_i2c_remove(struct pci_dev *dev)\r\n{\r\nstruct ce4100_devices *sds;\r\nunsigned int i;\r\nsds = pci_get_drvdata(dev);\r\npci_set_drvdata(dev, NULL);\r\nfor (i = 0; i < ARRAY_SIZE(sds->pdev); i++)\r\nplatform_device_unregister(sds->pdev[i]);\r\npci_disable_device(dev);\r\nkfree(sds);\r\n}\r\nstatic int __init ce4100_i2c_init(void)\r\n{\r\nreturn pci_register_driver(&ce4100_i2c_driver);\r\n}\r\nstatic void __exit ce4100_i2c_exit(void)\r\n{\r\npci_unregister_driver(&ce4100_i2c_driver);\r\n}

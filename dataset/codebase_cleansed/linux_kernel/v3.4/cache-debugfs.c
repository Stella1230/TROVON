static int cache_seq_show(struct seq_file *file, void *iter)\r\n{\r\nunsigned int cache_type = (unsigned int)file->private;\r\nstruct cache_info *cache;\r\nunsigned int waysize, way;\r\nunsigned long ccr;\r\nunsigned long addrstart = 0;\r\njump_to_uncached();\r\nccr = __raw_readl(CCR);\r\nif ((ccr & CCR_CACHE_ENABLE) == 0) {\r\nback_to_cached();\r\nseq_printf(file, "disabled\n");\r\nreturn 0;\r\n}\r\nif (cache_type == CACHE_TYPE_DCACHE) {\r\naddrstart = CACHE_OC_ADDRESS_ARRAY;\r\ncache = &current_cpu_data.dcache;\r\n} else {\r\naddrstart = CACHE_IC_ADDRESS_ARRAY;\r\ncache = &current_cpu_data.icache;\r\n}\r\nwaysize = cache->sets;\r\nif ((ccr & CCR_CACHE_ORA) && cache_type == CACHE_TYPE_DCACHE)\r\nwaysize >>= 1;\r\nwaysize <<= cache->entry_shift;\r\nfor (way = 0; way < cache->ways; way++) {\r\nunsigned long addr;\r\nunsigned int line;\r\nseq_printf(file, "-----------------------------------------\n");\r\nseq_printf(file, "Way %d\n", way);\r\nseq_printf(file, "-----------------------------------------\n");\r\nfor (addr = addrstart, line = 0;\r\naddr < addrstart + waysize;\r\naddr += cache->linesz, line++) {\r\nunsigned long data = __raw_readl(addr);\r\nif ((data & 1) == 0)\r\ncontinue;\r\nseq_printf(file, "%3d: %c 0x%lx\n",\r\nline, data & 2 ? 'U' : ' ',\r\ndata & 0x1ffffc00);\r\n}\r\naddrstart += cache->way_incr;\r\n}\r\nback_to_cached();\r\nreturn 0;\r\n}\r\nstatic int cache_debugfs_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, cache_seq_show, inode->i_private);\r\n}\r\nstatic int __init cache_debugfs_init(void)\r\n{\r\nstruct dentry *dcache_dentry, *icache_dentry;\r\ndcache_dentry = debugfs_create_file("dcache", S_IRUSR, arch_debugfs_dir,\r\n(unsigned int *)CACHE_TYPE_DCACHE,\r\n&cache_debugfs_fops);\r\nif (!dcache_dentry)\r\nreturn -ENOMEM;\r\nicache_dentry = debugfs_create_file("icache", S_IRUSR, arch_debugfs_dir,\r\n(unsigned int *)CACHE_TYPE_ICACHE,\r\n&cache_debugfs_fops);\r\nif (!icache_dentry) {\r\ndebugfs_remove(dcache_dentry);\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}

int as10x_cmd_turn_on(struct as10x_bus_adapter_t *adap)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *pcmd, *prsp;\r\nENTER();\r\npcmd = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(pcmd, (++adap->cmd_xid),\r\nsizeof(pcmd->body.turn_on.req));\r\npcmd->body.turn_on.req.proc_id = cpu_to_le16(CONTROL_PROC_TURNON);\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(adap, (uint8_t *) pcmd,\r\nsizeof(pcmd->body.turn_on.req) +\r\nHEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.turn_on.rsp) +\r\nHEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_TURNON_RSP);\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nint as10x_cmd_turn_off(struct as10x_bus_adapter_t *adap)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *pcmd, *prsp;\r\nENTER();\r\npcmd = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(pcmd, (++adap->cmd_xid),\r\nsizeof(pcmd->body.turn_off.req));\r\npcmd->body.turn_off.req.proc_id = cpu_to_le16(CONTROL_PROC_TURNOFF);\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(\r\nadap, (uint8_t *) pcmd,\r\nsizeof(pcmd->body.turn_off.req) + HEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.turn_off.rsp) + HEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_TURNOFF_RSP);\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nint as10x_cmd_set_tune(struct as10x_bus_adapter_t *adap,\r\nstruct as10x_tune_args *ptune)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *preq, *prsp;\r\nENTER();\r\npreq = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(preq, (++adap->cmd_xid),\r\nsizeof(preq->body.set_tune.req));\r\npreq->body.set_tune.req.proc_id = cpu_to_le16(CONTROL_PROC_SETTUNE);\r\npreq->body.set_tune.req.args.freq = cpu_to_le32(ptune->freq);\r\npreq->body.set_tune.req.args.bandwidth = ptune->bandwidth;\r\npreq->body.set_tune.req.args.hier_select = ptune->hier_select;\r\npreq->body.set_tune.req.args.modulation = ptune->modulation;\r\npreq->body.set_tune.req.args.hierarchy = ptune->hierarchy;\r\npreq->body.set_tune.req.args.interleaving_mode =\r\nptune->interleaving_mode;\r\npreq->body.set_tune.req.args.code_rate = ptune->code_rate;\r\npreq->body.set_tune.req.args.guard_interval = ptune->guard_interval;\r\npreq->body.set_tune.req.args.transmission_mode =\r\nptune->transmission_mode;\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(adap,\r\n(uint8_t *) preq,\r\nsizeof(preq->body.set_tune.req)\r\n+ HEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.set_tune.rsp)\r\n+ HEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_SETTUNE_RSP);\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nint as10x_cmd_get_tune_status(struct as10x_bus_adapter_t *adap,\r\nstruct as10x_tune_status *pstatus)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *preq, *prsp;\r\nENTER();\r\npreq = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(preq, (++adap->cmd_xid),\r\nsizeof(preq->body.get_tune_status.req));\r\npreq->body.get_tune_status.req.proc_id =\r\ncpu_to_le16(CONTROL_PROC_GETTUNESTAT);\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(\r\nadap,\r\n(uint8_t *) preq,\r\nsizeof(preq->body.get_tune_status.req) + HEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.get_tune_status.rsp) + HEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_GETTUNESTAT_RSP);\r\nif (error < 0)\r\ngoto out;\r\npstatus->tune_state = prsp->body.get_tune_status.rsp.sts.tune_state;\r\npstatus->signal_strength =\r\nle16_to_cpu(prsp->body.get_tune_status.rsp.sts.signal_strength);\r\npstatus->PER = le16_to_cpu(prsp->body.get_tune_status.rsp.sts.PER);\r\npstatus->BER = le16_to_cpu(prsp->body.get_tune_status.rsp.sts.BER);\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nint as10x_cmd_get_tps(struct as10x_bus_adapter_t *adap, struct as10x_tps *ptps)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *pcmd, *prsp;\r\nENTER();\r\npcmd = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(pcmd, (++adap->cmd_xid),\r\nsizeof(pcmd->body.get_tps.req));\r\npcmd->body.get_tune_status.req.proc_id =\r\ncpu_to_le16(CONTROL_PROC_GETTPS);\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(adap,\r\n(uint8_t *) pcmd,\r\nsizeof(pcmd->body.get_tps.req) +\r\nHEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.get_tps.rsp) +\r\nHEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_GETTPS_RSP);\r\nif (error < 0)\r\ngoto out;\r\nptps->modulation = prsp->body.get_tps.rsp.tps.modulation;\r\nptps->hierarchy = prsp->body.get_tps.rsp.tps.hierarchy;\r\nptps->interleaving_mode = prsp->body.get_tps.rsp.tps.interleaving_mode;\r\nptps->code_rate_HP = prsp->body.get_tps.rsp.tps.code_rate_HP;\r\nptps->code_rate_LP = prsp->body.get_tps.rsp.tps.code_rate_LP;\r\nptps->guard_interval = prsp->body.get_tps.rsp.tps.guard_interval;\r\nptps->transmission_mode = prsp->body.get_tps.rsp.tps.transmission_mode;\r\nptps->DVBH_mask_HP = prsp->body.get_tps.rsp.tps.DVBH_mask_HP;\r\nptps->DVBH_mask_LP = prsp->body.get_tps.rsp.tps.DVBH_mask_LP;\r\nptps->cell_ID = le16_to_cpu(prsp->body.get_tps.rsp.tps.cell_ID);\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nint as10x_cmd_get_demod_stats(struct as10x_bus_adapter_t *adap,\r\nstruct as10x_demod_stats *pdemod_stats)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *pcmd, *prsp;\r\nENTER();\r\npcmd = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(pcmd, (++adap->cmd_xid),\r\nsizeof(pcmd->body.get_demod_stats.req));\r\npcmd->body.get_demod_stats.req.proc_id =\r\ncpu_to_le16(CONTROL_PROC_GET_DEMOD_STATS);\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(adap,\r\n(uint8_t *) pcmd,\r\nsizeof(pcmd->body.get_demod_stats.req)\r\n+ HEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.get_demod_stats.rsp)\r\n+ HEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_GET_DEMOD_STATS_RSP);\r\nif (error < 0)\r\ngoto out;\r\npdemod_stats->frame_count =\r\nle32_to_cpu(prsp->body.get_demod_stats.rsp.stats.frame_count);\r\npdemod_stats->bad_frame_count =\r\nle32_to_cpu(prsp->body.get_demod_stats.rsp.stats.bad_frame_count);\r\npdemod_stats->bytes_fixed_by_rs =\r\nle32_to_cpu(prsp->body.get_demod_stats.rsp.stats.bytes_fixed_by_rs);\r\npdemod_stats->mer =\r\nle16_to_cpu(prsp->body.get_demod_stats.rsp.stats.mer);\r\npdemod_stats->has_started =\r\nprsp->body.get_demod_stats.rsp.stats.has_started;\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nint as10x_cmd_get_impulse_resp(struct as10x_bus_adapter_t *adap,\r\nuint8_t *is_ready)\r\n{\r\nint error;\r\nstruct as10x_cmd_t *pcmd, *prsp;\r\nENTER();\r\npcmd = adap->cmd;\r\nprsp = adap->rsp;\r\nas10x_cmd_build(pcmd, (++adap->cmd_xid),\r\nsizeof(pcmd->body.get_impulse_rsp.req));\r\npcmd->body.get_impulse_rsp.req.proc_id =\r\ncpu_to_le16(CONTROL_PROC_GET_IMPULSE_RESP);\r\nif (adap->ops->xfer_cmd) {\r\nerror = adap->ops->xfer_cmd(adap,\r\n(uint8_t *) pcmd,\r\nsizeof(pcmd->body.get_impulse_rsp.req)\r\n+ HEADER_SIZE,\r\n(uint8_t *) prsp,\r\nsizeof(prsp->body.get_impulse_rsp.rsp)\r\n+ HEADER_SIZE);\r\n} else {\r\nerror = AS10X_CMD_ERROR;\r\n}\r\nif (error < 0)\r\ngoto out;\r\nerror = as10x_rsp_parse(prsp, CONTROL_PROC_GET_IMPULSE_RESP_RSP);\r\nif (error < 0)\r\ngoto out;\r\n*is_ready = prsp->body.get_impulse_rsp.rsp.is_ready;\r\nout:\r\nLEAVE();\r\nreturn error;\r\n}\r\nvoid as10x_cmd_build(struct as10x_cmd_t *pcmd,\r\nuint16_t xid, uint16_t cmd_len)\r\n{\r\npcmd->header.req_id = cpu_to_le16(xid);\r\npcmd->header.prog = cpu_to_le16(SERVICE_PROG_ID);\r\npcmd->header.version = cpu_to_le16(SERVICE_PROG_VERSION);\r\npcmd->header.data_len = cpu_to_le16(cmd_len);\r\n}\r\nint as10x_rsp_parse(struct as10x_cmd_t *prsp, uint16_t proc_id)\r\n{\r\nint error;\r\nerror = prsp->body.common.rsp.error;\r\nif ((error == 0) &&\r\n(le16_to_cpu(prsp->body.common.rsp.proc_id) == proc_id)) {\r\nreturn 0;\r\n}\r\nreturn AS10X_CMD_ERROR;\r\n}

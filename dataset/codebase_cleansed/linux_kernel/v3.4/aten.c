static void aten_write_regr( PIA *pi, int cont, int regr, int val)\r\n{ int r;\r\nr = regr + cont_map[cont] + 0x80;\r\nw0(r); w2(0xe); w2(6); w0(val); w2(7); w2(6); w2(0xc);\r\n}\r\nstatic int aten_read_regr( PIA *pi, int cont, int regr )\r\n{ int a, b, r;\r\nr = regr + cont_map[cont] + 0x40;\r\nswitch (pi->mode) {\r\ncase 0: w0(r); w2(0xe); w2(6);\r\nw2(7); w2(6); w2(0);\r\na = r1(); w0(0x10); b = r1(); w2(0xc);\r\nreturn j44(a,b);\r\ncase 1: r |= 0x10;\r\nw0(r); w2(0xe); w2(6); w0(0xff);\r\nw2(0x27); w2(0x26); w2(0x20);\r\na = r0();\r\nw2(0x26); w2(0xc);\r\nreturn a;\r\n}\r\nreturn -1;\r\n}\r\nstatic void aten_read_block( PIA *pi, char * buf, int count )\r\n{ int k, a, b, c, d;\r\nswitch (pi->mode) {\r\ncase 0: w0(0x48); w2(0xe); w2(6);\r\nfor (k=0;k<count/2;k++) {\r\nw2(7); w2(6); w2(2);\r\na = r1(); w0(0x58); b = r1();\r\nw2(0); d = r1(); w0(0x48); c = r1();\r\nbuf[2*k] = j44(c,d);\r\nbuf[2*k+1] = j44(a,b);\r\n}\r\nw2(0xc);\r\nbreak;\r\ncase 1: w0(0x58); w2(0xe); w2(6);\r\nfor (k=0;k<count/2;k++) {\r\nw2(0x27); w2(0x26); w2(0x22);\r\na = r0(); w2(0x20); b = r0();\r\nbuf[2*k] = b; buf[2*k+1] = a;\r\n}\r\nw2(0x26); w2(0xc);\r\nbreak;\r\n}\r\n}\r\nstatic void aten_write_block( PIA *pi, char * buf, int count )\r\n{ int k;\r\nw0(0x88); w2(0xe); w2(6);\r\nfor (k=0;k<count/2;k++) {\r\nw0(buf[2*k+1]); w2(0xe); w2(6);\r\nw0(buf[2*k]); w2(7); w2(6);\r\n}\r\nw2(0xc);\r\n}\r\nstatic void aten_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(0xc);\r\n}\r\nstatic void aten_disconnect ( PIA *pi )\r\n{ w0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic void aten_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ char *mode_string[2] = {"4-bit","8-bit"};\r\nprintk("%s: aten %s, ATEN EH-100 at 0x%x, ",\r\npi->device,ATEN_VERSION,pi->port);\r\nprintk("mode %d (%s), delay %d\n",pi->mode,\r\nmode_string[pi->mode],pi->delay);\r\n}\r\nstatic int __init aten_init(void)\r\n{\r\nreturn paride_register(&aten);\r\n}\r\nstatic void __exit aten_exit(void)\r\n{\r\nparide_unregister( &aten );\r\n}

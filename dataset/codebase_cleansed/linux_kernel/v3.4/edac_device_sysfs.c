static ssize_t edac_device_ctl_log_ue_show(struct edac_device_ctl_info\r\n*ctl_info, char *data)\r\n{\r\nreturn sprintf(data, "%u\n", ctl_info->log_ue);\r\n}\r\nstatic ssize_t edac_device_ctl_log_ue_store(struct edac_device_ctl_info\r\n*ctl_info, const char *data,\r\nsize_t count)\r\n{\r\nctl_info->log_ue = (simple_strtoul(data, NULL, 0) != 0);\r\nreturn count;\r\n}\r\nstatic ssize_t edac_device_ctl_log_ce_show(struct edac_device_ctl_info\r\n*ctl_info, char *data)\r\n{\r\nreturn sprintf(data, "%u\n", ctl_info->log_ce);\r\n}\r\nstatic ssize_t edac_device_ctl_log_ce_store(struct edac_device_ctl_info\r\n*ctl_info, const char *data,\r\nsize_t count)\r\n{\r\nctl_info->log_ce = (simple_strtoul(data, NULL, 0) != 0);\r\nreturn count;\r\n}\r\nstatic ssize_t edac_device_ctl_panic_on_ue_show(struct edac_device_ctl_info\r\n*ctl_info, char *data)\r\n{\r\nreturn sprintf(data, "%u\n", ctl_info->panic_on_ue);\r\n}\r\nstatic ssize_t edac_device_ctl_panic_on_ue_store(struct edac_device_ctl_info\r\n*ctl_info, const char *data,\r\nsize_t count)\r\n{\r\nctl_info->panic_on_ue = (simple_strtoul(data, NULL, 0) != 0);\r\nreturn count;\r\n}\r\nstatic ssize_t edac_device_ctl_poll_msec_show(struct edac_device_ctl_info\r\n*ctl_info, char *data)\r\n{\r\nreturn sprintf(data, "%u\n", ctl_info->poll_msec);\r\n}\r\nstatic ssize_t edac_device_ctl_poll_msec_store(struct edac_device_ctl_info\r\n*ctl_info, const char *data,\r\nsize_t count)\r\n{\r\nunsigned long value;\r\nvalue = simple_strtoul(data, NULL, 0);\r\nedac_device_reset_delay_period(ctl_info, value);\r\nreturn count;\r\n}\r\nstatic ssize_t edac_dev_ctl_info_show(struct kobject *kobj,\r\nstruct attribute *attr, char *buffer)\r\n{\r\nstruct edac_device_ctl_info *edac_dev = to_ctl_info(kobj);\r\nstruct ctl_info_attribute *ctl_info_attr = to_ctl_info_attr(attr);\r\nif (ctl_info_attr->show)\r\nreturn ctl_info_attr->show(edac_dev, buffer);\r\nreturn -EIO;\r\n}\r\nstatic ssize_t edac_dev_ctl_info_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buffer, size_t count)\r\n{\r\nstruct edac_device_ctl_info *edac_dev = to_ctl_info(kobj);\r\nstruct ctl_info_attribute *ctl_info_attr = to_ctl_info_attr(attr);\r\nif (ctl_info_attr->store)\r\nreturn ctl_info_attr->store(edac_dev, buffer, count);\r\nreturn -EIO;\r\n}\r\nstatic void edac_device_ctrl_master_release(struct kobject *kobj)\r\n{\r\nstruct edac_device_ctl_info *edac_dev = to_edacdev(kobj);\r\ndebugf4("%s() control index=%d\n", __func__, edac_dev->dev_idx);\r\nmodule_put(edac_dev->owner);\r\nkfree(edac_dev);\r\n}\r\nint edac_device_register_sysfs_main_kobj(struct edac_device_ctl_info *edac_dev)\r\n{\r\nstruct bus_type *edac_subsys;\r\nint err;\r\ndebugf1("%s()\n", __func__);\r\nedac_subsys = edac_get_sysfs_subsys();\r\nif (edac_subsys == NULL) {\r\ndebugf1("%s() no edac_subsys error\n", __func__);\r\nerr = -ENODEV;\r\ngoto err_out;\r\n}\r\nedac_dev->edac_subsys = edac_subsys;\r\nmemset(&edac_dev->kobj, 0, sizeof(struct kobject));\r\nedac_dev->owner = THIS_MODULE;\r\nif (!try_module_get(edac_dev->owner)) {\r\nerr = -ENODEV;\r\ngoto err_mod_get;\r\n}\r\nerr = kobject_init_and_add(&edac_dev->kobj, &ktype_device_ctrl,\r\n&edac_subsys->dev_root->kobj,\r\n"%s", edac_dev->name);\r\nif (err) {\r\ndebugf1("%s()Failed to register '.../edac/%s'\n",\r\n__func__, edac_dev->name);\r\ngoto err_kobj_reg;\r\n}\r\nkobject_uevent(&edac_dev->kobj, KOBJ_ADD);\r\ndebugf4("%s() Registered '.../edac/%s' kobject\n",\r\n__func__, edac_dev->name);\r\nreturn 0;\r\nerr_kobj_reg:\r\nmodule_put(edac_dev->owner);\r\nerr_mod_get:\r\nedac_put_sysfs_subsys();\r\nerr_out:\r\nreturn err;\r\n}\r\nvoid edac_device_unregister_sysfs_main_kobj(struct edac_device_ctl_info *dev)\r\n{\r\ndebugf0("%s()\n", __func__);\r\ndebugf4("%s() name of kobject is: %s\n",\r\n__func__, kobject_name(&dev->kobj));\r\nkobject_put(&dev->kobj);\r\nedac_put_sysfs_subsys();\r\n}\r\nstatic ssize_t instance_ue_count_show(struct edac_device_instance *instance,\r\nchar *data)\r\n{\r\nreturn sprintf(data, "%u\n", instance->counters.ue_count);\r\n}\r\nstatic ssize_t instance_ce_count_show(struct edac_device_instance *instance,\r\nchar *data)\r\n{\r\nreturn sprintf(data, "%u\n", instance->counters.ce_count);\r\n}\r\nstatic void edac_device_ctrl_instance_release(struct kobject *kobj)\r\n{\r\nstruct edac_device_instance *instance;\r\ndebugf1("%s()\n", __func__);\r\ninstance = to_instance(kobj);\r\nkobject_put(&instance->ctl->kobj);\r\n}\r\nstatic ssize_t edac_dev_instance_show(struct kobject *kobj,\r\nstruct attribute *attr, char *buffer)\r\n{\r\nstruct edac_device_instance *instance = to_instance(kobj);\r\nstruct instance_attribute *instance_attr = to_instance_attr(attr);\r\nif (instance_attr->show)\r\nreturn instance_attr->show(instance, buffer);\r\nreturn -EIO;\r\n}\r\nstatic ssize_t edac_dev_instance_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buffer, size_t count)\r\n{\r\nstruct edac_device_instance *instance = to_instance(kobj);\r\nstruct instance_attribute *instance_attr = to_instance_attr(attr);\r\nif (instance_attr->store)\r\nreturn instance_attr->store(instance, buffer, count);\r\nreturn -EIO;\r\n}\r\nstatic ssize_t block_ue_count_show(struct kobject *kobj,\r\nstruct attribute *attr, char *data)\r\n{\r\nstruct edac_device_block *block = to_block(kobj);\r\nreturn sprintf(data, "%u\n", block->counters.ue_count);\r\n}\r\nstatic ssize_t block_ce_count_show(struct kobject *kobj,\r\nstruct attribute *attr, char *data)\r\n{\r\nstruct edac_device_block *block = to_block(kobj);\r\nreturn sprintf(data, "%u\n", block->counters.ce_count);\r\n}\r\nstatic void edac_device_ctrl_block_release(struct kobject *kobj)\r\n{\r\nstruct edac_device_block *block;\r\ndebugf1("%s()\n", __func__);\r\nblock = to_block(kobj);\r\nkobject_put(&block->instance->ctl->kobj);\r\n}\r\nstatic ssize_t edac_dev_block_show(struct kobject *kobj,\r\nstruct attribute *attr, char *buffer)\r\n{\r\nstruct edac_dev_sysfs_block_attribute *block_attr =\r\nto_block_attr(attr);\r\nif (block_attr->show)\r\nreturn block_attr->show(kobj, attr, buffer);\r\nreturn -EIO;\r\n}\r\nstatic ssize_t edac_dev_block_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buffer, size_t count)\r\n{\r\nstruct edac_dev_sysfs_block_attribute *block_attr;\r\nblock_attr = to_block_attr(attr);\r\nif (block_attr->store)\r\nreturn block_attr->store(kobj, attr, buffer, count);\r\nreturn -EIO;\r\n}\r\nstatic int edac_device_create_block(struct edac_device_ctl_info *edac_dev,\r\nstruct edac_device_instance *instance,\r\nstruct edac_device_block *block)\r\n{\r\nint i;\r\nint err;\r\nstruct edac_dev_sysfs_block_attribute *sysfs_attrib;\r\nstruct kobject *main_kobj;\r\ndebugf4("%s() Instance '%s' inst_p=%p block '%s' block_p=%p\n",\r\n__func__, instance->name, instance, block->name, block);\r\ndebugf4("%s() block kobj=%p block kobj->parent=%p\n",\r\n__func__, &block->kobj, &block->kobj.parent);\r\nmemset(&block->kobj, 0, sizeof(struct kobject));\r\nmain_kobj = kobject_get(&edac_dev->kobj);\r\nif (!main_kobj) {\r\nerr = -ENODEV;\r\ngoto err_out;\r\n}\r\nerr = kobject_init_and_add(&block->kobj, &ktype_block_ctrl,\r\n&instance->kobj,\r\n"%s", block->name);\r\nif (err) {\r\ndebugf1("%s() Failed to register instance '%s'\n",\r\n__func__, block->name);\r\nkobject_put(main_kobj);\r\nerr = -ENODEV;\r\ngoto err_out;\r\n}\r\nsysfs_attrib = block->block_attributes;\r\nif (sysfs_attrib && block->nr_attribs) {\r\nfor (i = 0; i < block->nr_attribs; i++, sysfs_attrib++) {\r\ndebugf4("%s() creating block attrib='%s' "\r\n"attrib->%p to kobj=%p\n",\r\n__func__,\r\nsysfs_attrib->attr.name,\r\nsysfs_attrib, &block->kobj);\r\nerr = sysfs_create_file(&block->kobj,\r\n&sysfs_attrib->attr);\r\nif (err)\r\ngoto err_on_attrib;\r\n}\r\n}\r\nkobject_uevent(&block->kobj, KOBJ_ADD);\r\nreturn 0;\r\nerr_on_attrib:\r\nkobject_put(&block->kobj);\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic void edac_device_delete_block(struct edac_device_ctl_info *edac_dev,\r\nstruct edac_device_block *block)\r\n{\r\nstruct edac_dev_sysfs_block_attribute *sysfs_attrib;\r\nint i;\r\nsysfs_attrib = block->block_attributes;\r\nif (sysfs_attrib && block->nr_attribs) {\r\nfor (i = 0; i < block->nr_attribs; i++, sysfs_attrib++) {\r\nsysfs_remove_file(&block->kobj,\r\n(struct attribute *) sysfs_attrib);\r\n}\r\n}\r\nkobject_put(&block->kobj);\r\n}\r\nstatic int edac_device_create_instance(struct edac_device_ctl_info *edac_dev,\r\nint idx)\r\n{\r\nint i, j;\r\nint err;\r\nstruct edac_device_instance *instance;\r\nstruct kobject *main_kobj;\r\ninstance = &edac_dev->instances[idx];\r\nmemset(&instance->kobj, 0, sizeof(struct kobject));\r\ninstance->ctl = edac_dev;\r\nmain_kobj = kobject_get(&edac_dev->kobj);\r\nif (!main_kobj) {\r\nerr = -ENODEV;\r\ngoto err_out;\r\n}\r\nerr = kobject_init_and_add(&instance->kobj, &ktype_instance_ctrl,\r\n&edac_dev->kobj, "%s", instance->name);\r\nif (err != 0) {\r\ndebugf2("%s() Failed to register instance '%s'\n",\r\n__func__, instance->name);\r\nkobject_put(main_kobj);\r\ngoto err_out;\r\n}\r\ndebugf4("%s() now register '%d' blocks for instance %d\n",\r\n__func__, instance->nr_blocks, idx);\r\nfor (i = 0; i < instance->nr_blocks; i++) {\r\nerr = edac_device_create_block(edac_dev, instance,\r\n&instance->blocks[i]);\r\nif (err) {\r\nfor (j = 0; j < i; j++)\r\nedac_device_delete_block(edac_dev,\r\n&instance->blocks[j]);\r\ngoto err_release_instance_kobj;\r\n}\r\n}\r\nkobject_uevent(&instance->kobj, KOBJ_ADD);\r\ndebugf4("%s() Registered instance %d '%s' kobject\n",\r\n__func__, idx, instance->name);\r\nreturn 0;\r\nerr_release_instance_kobj:\r\nkobject_put(&instance->kobj);\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic void edac_device_delete_instance(struct edac_device_ctl_info *edac_dev,\r\nint idx)\r\n{\r\nstruct edac_device_instance *instance;\r\nint i;\r\ninstance = &edac_dev->instances[idx];\r\nfor (i = 0; i < instance->nr_blocks; i++)\r\nedac_device_delete_block(edac_dev, &instance->blocks[i]);\r\nkobject_put(&instance->kobj);\r\n}\r\nstatic int edac_device_create_instances(struct edac_device_ctl_info *edac_dev)\r\n{\r\nint i, j;\r\nint err;\r\ndebugf0("%s()\n", __func__);\r\nfor (i = 0; i < edac_dev->nr_instances; i++) {\r\nerr = edac_device_create_instance(edac_dev, i);\r\nif (err) {\r\nfor (j = 0; j < i; j++)\r\nedac_device_delete_instance(edac_dev, j);\r\nreturn err;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void edac_device_delete_instances(struct edac_device_ctl_info *edac_dev)\r\n{\r\nint i;\r\nfor (i = 0; i < edac_dev->nr_instances; i++)\r\nedac_device_delete_instance(edac_dev, i);\r\n}\r\nstatic int edac_device_add_main_sysfs_attributes(\r\nstruct edac_device_ctl_info *edac_dev)\r\n{\r\nstruct edac_dev_sysfs_attribute *sysfs_attrib;\r\nint err = 0;\r\nsysfs_attrib = edac_dev->sysfs_attributes;\r\nif (sysfs_attrib) {\r\nwhile (sysfs_attrib->attr.name != NULL) {\r\nerr = sysfs_create_file(&edac_dev->kobj,\r\n(struct attribute*) sysfs_attrib);\r\nif (err)\r\ngoto err_out;\r\nsysfs_attrib++;\r\n}\r\n}\r\nerr_out:\r\nreturn err;\r\n}\r\nstatic void edac_device_remove_main_sysfs_attributes(\r\nstruct edac_device_ctl_info *edac_dev)\r\n{\r\nstruct edac_dev_sysfs_attribute *sysfs_attrib;\r\nsysfs_attrib = edac_dev->sysfs_attributes;\r\nif (sysfs_attrib) {\r\nwhile (sysfs_attrib->attr.name != NULL) {\r\nsysfs_remove_file(&edac_dev->kobj,\r\n(struct attribute *) sysfs_attrib);\r\nsysfs_attrib++;\r\n}\r\n}\r\n}\r\nint edac_device_create_sysfs(struct edac_device_ctl_info *edac_dev)\r\n{\r\nint err;\r\nstruct kobject *edac_kobj = &edac_dev->kobj;\r\ndebugf0("%s() idx=%d\n", __func__, edac_dev->dev_idx);\r\nerr = edac_device_add_main_sysfs_attributes(edac_dev);\r\nif (err) {\r\ndebugf0("%s() failed to add sysfs attribs\n", __func__);\r\ngoto err_out;\r\n}\r\nerr = sysfs_create_link(edac_kobj,\r\n&edac_dev->dev->kobj, EDAC_DEVICE_SYMLINK);\r\nif (err) {\r\ndebugf0("%s() sysfs_create_link() returned err= %d\n",\r\n__func__, err);\r\ngoto err_remove_main_attribs;\r\n}\r\nerr = edac_device_create_instances(edac_dev);\r\nif (err) {\r\ndebugf0("%s() edac_device_create_instances() "\r\n"returned err= %d\n", __func__, err);\r\ngoto err_remove_link;\r\n}\r\ndebugf4("%s() create-instances done, idx=%d\n",\r\n__func__, edac_dev->dev_idx);\r\nreturn 0;\r\nerr_remove_link:\r\nsysfs_remove_link(&edac_dev->kobj, EDAC_DEVICE_SYMLINK);\r\nerr_remove_main_attribs:\r\nedac_device_remove_main_sysfs_attributes(edac_dev);\r\nerr_out:\r\nreturn err;\r\n}\r\nvoid edac_device_remove_sysfs(struct edac_device_ctl_info *edac_dev)\r\n{\r\ndebugf0("%s()\n", __func__);\r\nedac_device_remove_main_sysfs_attributes(edac_dev);\r\nsysfs_remove_link(&edac_dev->kobj, EDAC_DEVICE_SYMLINK);\r\nedac_device_delete_instances(edac_dev);\r\n}

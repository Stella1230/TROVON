static int tda8261_read(struct tda8261_state *state, u8 *buf)\r\n{\r\nconst struct tda8261_config *config = state->config;\r\nint err = 0;\r\nstruct i2c_msg msg = { .addr = config->addr, .flags = I2C_M_RD,.buf = buf, .len = 1 };\r\nif ((err = i2c_transfer(state->i2c, &msg, 1)) != 1)\r\nprintk("%s: read error, err=%d\n", __func__, err);\r\nreturn err;\r\n}\r\nstatic int tda8261_write(struct tda8261_state *state, u8 *buf)\r\n{\r\nconst struct tda8261_config *config = state->config;\r\nint err = 0;\r\nstruct i2c_msg msg = { .addr = config->addr, .flags = 0, .buf = buf, .len = 4 };\r\nif ((err = i2c_transfer(state->i2c, &msg, 1)) != 1)\r\nprintk("%s: write error, err=%d\n", __func__, err);\r\nreturn err;\r\n}\r\nstatic int tda8261_get_status(struct dvb_frontend *fe, u32 *status)\r\n{\r\nstruct tda8261_state *state = fe->tuner_priv;\r\nu8 result = 0;\r\nint err = 0;\r\n*status = 0;\r\nif ((err = tda8261_read(state, &result)) < 0) {\r\nprintk("%s: I/O Error\n", __func__);\r\nreturn err;\r\n}\r\nif ((result >> 6) & 0x01) {\r\nprintk("%s: Tuner Phase Locked\n", __func__);\r\n*status = 1;\r\n}\r\nreturn err;\r\n}\r\nstatic int tda8261_get_state(struct dvb_frontend *fe,\r\nenum tuner_param param,\r\nstruct tuner_state *tstate)\r\n{\r\nstruct tda8261_state *state = fe->tuner_priv;\r\nint err = 0;\r\nswitch (param) {\r\ncase DVBFE_TUNER_FREQUENCY:\r\ntstate->frequency = state->frequency;\r\nbreak;\r\ncase DVBFE_TUNER_BANDWIDTH:\r\ntstate->bandwidth = 40000000;\r\nbreak;\r\ndefault:\r\nprintk("%s: Unknown parameter (param=%d)\n", __func__, param);\r\nerr = -EINVAL;\r\nbreak;\r\n}\r\nreturn err;\r\n}\r\nstatic int tda8261_set_state(struct dvb_frontend *fe,\r\nenum tuner_param param,\r\nstruct tuner_state *tstate)\r\n{\r\nstruct tda8261_state *state = fe->tuner_priv;\r\nconst struct tda8261_config *config = state->config;\r\nu32 frequency, N, status = 0;\r\nu8 buf[4];\r\nint err = 0;\r\nif (param & DVBFE_TUNER_FREQUENCY) {\r\nfrequency = tstate->frequency;\r\nif ((frequency < 950000) || (frequency > 2150000)) {\r\nprintk("%s: Frequency beyond limits, frequency=%d\n", __func__, frequency);\r\nreturn -EINVAL;\r\n}\r\nN = (frequency + (div_tab[config->step_size] - 1)) / div_tab[config->step_size];\r\nprintk("%s: Step size=%d, Divider=%d, PG=0x%02x (%d)\n",\r\n__func__, config->step_size, div_tab[config->step_size], N, N);\r\nbuf[0] = (N >> 8) & 0xff;\r\nbuf[1] = N & 0xff;\r\nbuf[2] = (0x01 << 7) | ((ref_div[config->step_size] & 0x07) << 1);\r\nif (frequency < 1450000)\r\nbuf[3] = 0x00;\r\nelse if (frequency < 2000000)\r\nbuf[3] = 0x40;\r\nelse if (frequency < 2150000)\r\nbuf[3] = 0x80;\r\nif ((err = tda8261_write(state, buf)) < 0) {\r\nprintk("%s: I/O Error\n", __func__);\r\nreturn err;\r\n}\r\nprintk("%s: Waiting to Phase LOCK\n", __func__);\r\nmsleep(20);\r\nif ((err = tda8261_get_status(fe, &status)) < 0) {\r\nprintk("%s: I/O Error\n", __func__);\r\nreturn err;\r\n}\r\nif (status == 1) {\r\nprintk("%s: Tuner Phase locked: status=%d\n", __func__, status);\r\nstate->frequency = frequency;\r\n} else {\r\nprintk("%s: No Phase lock: status=%d\n", __func__, status);\r\n}\r\n} else {\r\nprintk("%s: Unknown parameter (param=%d)\n", __func__, param);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tda8261_release(struct dvb_frontend *fe)\r\n{\r\nstruct tda8261_state *state = fe->tuner_priv;\r\nfe->tuner_priv = NULL;\r\nkfree(state);\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *tda8261_attach(struct dvb_frontend *fe,\r\nconst struct tda8261_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct tda8261_state *state = NULL;\r\nif ((state = kzalloc(sizeof (struct tda8261_state), GFP_KERNEL)) == NULL)\r\ngoto exit;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->fe = fe;\r\nfe->tuner_priv = state;\r\nfe->ops.tuner_ops = tda8261_ops;\r\nfe->ops.tuner_ops.info.frequency_step = div_tab[config->step_size];\r\nprintk("%s: Attaching TDA8261 8PSK/QPSK tuner\n", __func__);\r\nreturn fe;\r\nexit:\r\nkfree(state);\r\nreturn NULL;\r\n}

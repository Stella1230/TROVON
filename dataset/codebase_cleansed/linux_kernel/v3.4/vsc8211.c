static int vsc8211_reset(struct cphy *cphy, int wait)\r\n{\r\nreturn t3_phy_reset(cphy, MDIO_DEVAD_NONE, 0);\r\n}\r\nstatic int vsc8211_intr_enable(struct cphy *cphy)\r\n{\r\nreturn t3_mdio_write(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_ENABLE,\r\nINTR_MASK);\r\n}\r\nstatic int vsc8211_intr_disable(struct cphy *cphy)\r\n{\r\nreturn t3_mdio_write(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_ENABLE, 0);\r\n}\r\nstatic int vsc8211_intr_clear(struct cphy *cphy)\r\n{\r\nu32 val;\r\nreturn t3_mdio_read(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_STATUS, &val);\r\n}\r\nstatic int vsc8211_autoneg_enable(struct cphy *cphy)\r\n{\r\nreturn t3_mdio_change_bits(cphy, MDIO_DEVAD_NONE, MII_BMCR,\r\nBMCR_PDOWN | BMCR_ISOLATE,\r\nBMCR_ANENABLE | BMCR_ANRESTART);\r\n}\r\nstatic int vsc8211_autoneg_restart(struct cphy *cphy)\r\n{\r\nreturn t3_mdio_change_bits(cphy, MDIO_DEVAD_NONE, MII_BMCR,\r\nBMCR_PDOWN | BMCR_ISOLATE,\r\nBMCR_ANRESTART);\r\n}\r\nstatic int vsc8211_get_link_status(struct cphy *cphy, int *link_ok,\r\nint *speed, int *duplex, int *fc)\r\n{\r\nunsigned int bmcr, status, lpa, adv;\r\nint err, sp = -1, dplx = -1, pause = 0;\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMCR, &bmcr);\r\nif (!err)\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR, &status);\r\nif (err)\r\nreturn err;\r\nif (link_ok) {\r\nif (!(status & BMSR_LSTATUS))\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR,\r\n&status);\r\nif (err)\r\nreturn err;\r\n*link_ok = (status & BMSR_LSTATUS) != 0;\r\n}\r\nif (!(bmcr & BMCR_ANENABLE)) {\r\ndplx = (bmcr & BMCR_FULLDPLX) ? DUPLEX_FULL : DUPLEX_HALF;\r\nif (bmcr & BMCR_SPEED1000)\r\nsp = SPEED_1000;\r\nelse if (bmcr & BMCR_SPEED100)\r\nsp = SPEED_100;\r\nelse\r\nsp = SPEED_10;\r\n} else if (status & BMSR_ANEGCOMPLETE) {\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, VSC8211_AUX_CTRL_STAT,\r\n&status);\r\nif (err)\r\nreturn err;\r\ndplx = (status & F_ACSR_DUPLEX) ? DUPLEX_FULL : DUPLEX_HALF;\r\nsp = G_ACSR_SPEED(status);\r\nif (sp == 0)\r\nsp = SPEED_10;\r\nelse if (sp == 1)\r\nsp = SPEED_100;\r\nelse\r\nsp = SPEED_1000;\r\nif (fc && dplx == DUPLEX_FULL) {\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_LPA,\r\n&lpa);\r\nif (!err)\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE,\r\nMII_ADVERTISE, &adv);\r\nif (err)\r\nreturn err;\r\nif (lpa & adv & ADVERTISE_PAUSE_CAP)\r\npause = PAUSE_RX | PAUSE_TX;\r\nelse if ((lpa & ADVERTISE_PAUSE_CAP) &&\r\n(lpa & ADVERTISE_PAUSE_ASYM) &&\r\n(adv & ADVERTISE_PAUSE_ASYM))\r\npause = PAUSE_TX;\r\nelse if ((lpa & ADVERTISE_PAUSE_ASYM) &&\r\n(adv & ADVERTISE_PAUSE_CAP))\r\npause = PAUSE_RX;\r\n}\r\n}\r\nif (speed)\r\n*speed = sp;\r\nif (duplex)\r\n*duplex = dplx;\r\nif (fc)\r\n*fc = pause;\r\nreturn 0;\r\n}\r\nstatic int vsc8211_get_link_status_fiber(struct cphy *cphy, int *link_ok,\r\nint *speed, int *duplex, int *fc)\r\n{\r\nunsigned int bmcr, status, lpa, adv;\r\nint err, sp = -1, dplx = -1, pause = 0;\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMCR, &bmcr);\r\nif (!err)\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR, &status);\r\nif (err)\r\nreturn err;\r\nif (link_ok) {\r\nif (!(status & BMSR_LSTATUS))\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_BMSR,\r\n&status);\r\nif (err)\r\nreturn err;\r\n*link_ok = (status & BMSR_LSTATUS) != 0;\r\n}\r\nif (!(bmcr & BMCR_ANENABLE)) {\r\ndplx = (bmcr & BMCR_FULLDPLX) ? DUPLEX_FULL : DUPLEX_HALF;\r\nif (bmcr & BMCR_SPEED1000)\r\nsp = SPEED_1000;\r\nelse if (bmcr & BMCR_SPEED100)\r\nsp = SPEED_100;\r\nelse\r\nsp = SPEED_10;\r\n} else if (status & BMSR_ANEGCOMPLETE) {\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_LPA, &lpa);\r\nif (!err)\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, MII_ADVERTISE,\r\n&adv);\r\nif (err)\r\nreturn err;\r\nif (adv & lpa & ADVERTISE_1000XFULL) {\r\ndplx = DUPLEX_FULL;\r\nsp = SPEED_1000;\r\n} else if (adv & lpa & ADVERTISE_1000XHALF) {\r\ndplx = DUPLEX_HALF;\r\nsp = SPEED_1000;\r\n}\r\nif (fc && dplx == DUPLEX_FULL) {\r\nif (lpa & adv & ADVERTISE_1000XPAUSE)\r\npause = PAUSE_RX | PAUSE_TX;\r\nelse if ((lpa & ADVERTISE_1000XPAUSE) &&\r\n(adv & lpa & ADVERTISE_1000XPSE_ASYM))\r\npause = PAUSE_TX;\r\nelse if ((lpa & ADVERTISE_1000XPSE_ASYM) &&\r\n(adv & ADVERTISE_1000XPAUSE))\r\npause = PAUSE_RX;\r\n}\r\n}\r\nif (speed)\r\n*speed = sp;\r\nif (duplex)\r\n*duplex = dplx;\r\nif (fc)\r\n*fc = pause;\r\nreturn 0;\r\n}\r\nstatic int vsc8211_set_automdi(struct cphy *phy, int enable)\r\n{\r\nint err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 0x52b5);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, 18, 0x12);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, 17, enable ? 0x2803 : 0x3003);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, 16, 0x87fa);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 0);\r\nif (err)\r\nreturn err;\r\nreturn 0;\r\n}\r\nint vsc8211_set_speed_duplex(struct cphy *phy, int speed, int duplex)\r\n{\r\nint err;\r\nerr = t3_set_phy_speed_duplex(phy, speed, duplex);\r\nif (!err)\r\nerr = vsc8211_set_automdi(phy, 1);\r\nreturn err;\r\n}\r\nstatic int vsc8211_power_down(struct cphy *cphy, int enable)\r\n{\r\nreturn t3_mdio_change_bits(cphy, 0, MII_BMCR, BMCR_PDOWN,\r\nenable ? BMCR_PDOWN : 0);\r\n}\r\nstatic int vsc8211_intr_handler(struct cphy *cphy)\r\n{\r\nunsigned int cause;\r\nint err, cphy_cause = 0;\r\nerr = t3_mdio_read(cphy, MDIO_DEVAD_NONE, VSC8211_INTR_STATUS, &cause);\r\nif (err)\r\nreturn err;\r\ncause &= INTR_MASK;\r\nif (cause & CFG_CHG_INTR_MASK)\r\ncphy_cause |= cphy_cause_link_change;\r\nif (cause & (VSC_INTR_RX_FIFO | VSC_INTR_TX_FIFO))\r\ncphy_cause |= cphy_cause_fifo_error;\r\nreturn cphy_cause;\r\n}\r\nint t3_vsc8211_phy_prep(struct cphy *phy, struct adapter *adapter,\r\nint phy_addr, const struct mdio_ops *mdio_ops)\r\n{\r\nint err;\r\nunsigned int val;\r\ncphy_init(phy, adapter, phy_addr, &vsc8211_ops, mdio_ops,\r\nSUPPORTED_10baseT_Full | SUPPORTED_100baseT_Full |\r\nSUPPORTED_1000baseT_Full | SUPPORTED_Autoneg | SUPPORTED_MII |\r\nSUPPORTED_TP | SUPPORTED_IRQ, "10/100/1000BASE-T");\r\nmsleep(20);\r\nerr = t3_mdio_read(phy, MDIO_DEVAD_NONE, VSC8211_EXT_CTRL, &val);\r\nif (err)\r\nreturn err;\r\nif (val & VSC_CTRL_MEDIA_MODE_HI) {\r\nreturn t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_LED_CTRL,\r\n0x100);\r\n}\r\nphy->caps = SUPPORTED_1000baseT_Full | SUPPORTED_Autoneg |\r\nSUPPORTED_MII | SUPPORTED_FIBRE | SUPPORTED_IRQ;\r\nphy->desc = "1000BASE-X";\r\nphy->ops = &vsc8211_fiber_ops;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 1);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_SIGDET_CTRL, 1);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_PAGE_AXS, 0);\r\nif (err)\r\nreturn err;\r\nerr = t3_mdio_write(phy, MDIO_DEVAD_NONE, VSC8211_EXT_CTRL,\r\nval | VSC_CTRL_CLAUSE37_VIEW);\r\nif (err)\r\nreturn err;\r\nerr = vsc8211_reset(phy, 0);\r\nif (err)\r\nreturn err;\r\nudelay(5);\r\nreturn 0;\r\n}

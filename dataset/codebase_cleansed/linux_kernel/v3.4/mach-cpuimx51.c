static int initialize_otg_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = usb_base + MX5_USBOTHER_REGS_OFFSET;\r\nv = __raw_readl(usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\nv &= ~MX5_USB_UTMI_PHYCTRL1_PLLDIV_MASK;\r\nv |= MX51_USB_PLL_DIV_19_2_MHZ;\r\n__raw_writel(v, usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(0, MXC_EHCI_INTERNAL_PHY);\r\n}\r\nstatic int initialize_usbh1_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = usb_base + MX5_USBOTHER_REGS_OFFSET;\r\nv = __raw_readl(usbother_base + MX51_USB_CTRL_1_OFFSET);\r\n__raw_writel(v | MX51_USB_CTRL_UH1_EXT_CLK_EN, usbother_base + MX51_USB_CTRL_1_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(1, MXC_EHCI_POWER_PINS_ENABLED |\r\nMXC_EHCI_ITC_NO_THRESHOLD);\r\n}\r\nstatic int __init eukrea_cpuimx51_otg_mode(char *options)\r\n{\r\nif (!strcmp(options, "host"))\r\notg_mode_host = 1;\r\nelse if (!strcmp(options, "device"))\r\notg_mode_host = 0;\r\nelse\r\npr_info("otg_mode neither \"host\" nor \"device\". "\r\n"Defaulting to device\n");\r\nreturn 0;\r\n}\r\nstatic void __init eukrea_cpuimx51_init(void)\r\n{\r\nimx51_soc_init();\r\nmxc_iomux_v3_setup_multiple_pads(eukrea_cpuimx51_pads,\r\nARRAY_SIZE(eukrea_cpuimx51_pads));\r\nimx51_add_imx_uart(0, &uart_pdata);\r\nimx51_add_mxc_nand(&eukrea_cpuimx51_nand_board_info);\r\ngpio_request(CPUIMX51_QUARTA_GPIO, "quarta_irq");\r\ngpio_direction_input(CPUIMX51_QUARTA_GPIO);\r\ngpio_free(CPUIMX51_QUARTA_GPIO);\r\ngpio_request(CPUIMX51_QUARTB_GPIO, "quartb_irq");\r\ngpio_direction_input(CPUIMX51_QUARTB_GPIO);\r\ngpio_free(CPUIMX51_QUARTB_GPIO);\r\ngpio_request(CPUIMX51_QUARTC_GPIO, "quartc_irq");\r\ngpio_direction_input(CPUIMX51_QUARTC_GPIO);\r\ngpio_free(CPUIMX51_QUARTC_GPIO);\r\ngpio_request(CPUIMX51_QUARTD_GPIO, "quartd_irq");\r\ngpio_direction_input(CPUIMX51_QUARTD_GPIO);\r\ngpio_free(CPUIMX51_QUARTD_GPIO);\r\nimx51_add_fec(NULL);\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\nimx51_add_imx_i2c(1, &eukrea_cpuimx51_i2c_data);\r\ni2c_register_board_info(1, eukrea_cpuimx51_i2c_devices,\r\nARRAY_SIZE(eukrea_cpuimx51_i2c_devices));\r\nif (otg_mode_host)\r\nimx51_add_mxc_ehci_otg(&dr_utmi_config);\r\nelse {\r\ninitialize_otg_port(NULL);\r\nimx51_add_fsl_usb2_udc(&usb_pdata);\r\n}\r\nimx51_add_mxc_ehci_hs(1, &usbh1_config);\r\n#ifdef CONFIG_MACH_EUKREA_MBIMX51_BASEBOARD\r\neukrea_mbimx51_baseboard_init();\r\n#endif\r\n}\r\nstatic void __init eukrea_cpuimx51_timer_init(void)\r\n{\r\nmx51_clocks_init(32768, 24000000, 22579200, 0);\r\n}

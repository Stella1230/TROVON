static inline int\r\nxfs_ialloc_cluster_alignment(\r\nxfs_alloc_arg_t *args)\r\n{\r\nif (xfs_sb_version_hasalign(&args->mp->m_sb) &&\r\nargs->mp->m_sb.sb_inoalignmt >=\r\nXFS_B_TO_FSBT(args->mp, XFS_INODE_CLUSTER_SIZE(args->mp)))\r\nreturn args->mp->m_sb.sb_inoalignmt;\r\nreturn 1;\r\n}\r\nint\r\nxfs_inobt_lookup(\r\nstruct xfs_btree_cur *cur,\r\nxfs_agino_t ino,\r\nxfs_lookup_t dir,\r\nint *stat)\r\n{\r\ncur->bc_rec.i.ir_startino = ino;\r\ncur->bc_rec.i.ir_freecount = 0;\r\ncur->bc_rec.i.ir_free = 0;\r\nreturn xfs_btree_lookup(cur, dir, stat);\r\n}\r\nSTATIC int\r\nxfs_inobt_update(\r\nstruct xfs_btree_cur *cur,\r\nxfs_inobt_rec_incore_t *irec)\r\n{\r\nunion xfs_btree_rec rec;\r\nrec.inobt.ir_startino = cpu_to_be32(irec->ir_startino);\r\nrec.inobt.ir_freecount = cpu_to_be32(irec->ir_freecount);\r\nrec.inobt.ir_free = cpu_to_be64(irec->ir_free);\r\nreturn xfs_btree_update(cur, &rec);\r\n}\r\nint\r\nxfs_inobt_get_rec(\r\nstruct xfs_btree_cur *cur,\r\nxfs_inobt_rec_incore_t *irec,\r\nint *stat)\r\n{\r\nunion xfs_btree_rec *rec;\r\nint error;\r\nerror = xfs_btree_get_rec(cur, &rec, stat);\r\nif (!error && *stat == 1) {\r\nirec->ir_startino = be32_to_cpu(rec->inobt.ir_startino);\r\nirec->ir_freecount = be32_to_cpu(rec->inobt.ir_freecount);\r\nirec->ir_free = be64_to_cpu(rec->inobt.ir_free);\r\n}\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_check_agi_freecount(\r\nstruct xfs_btree_cur *cur,\r\nstruct xfs_agi *agi)\r\n{\r\nif (cur->bc_nlevels == 1) {\r\nxfs_inobt_rec_incore_t rec;\r\nint freecount = 0;\r\nint error;\r\nint i;\r\nerror = xfs_inobt_lookup(cur, 0, XFS_LOOKUP_GE, &i);\r\nif (error)\r\nreturn error;\r\ndo {\r\nerror = xfs_inobt_get_rec(cur, &rec, &i);\r\nif (error)\r\nreturn error;\r\nif (i) {\r\nfreecount += rec.ir_freecount;\r\nerror = xfs_btree_increment(cur, 0, &i);\r\nif (error)\r\nreturn error;\r\n}\r\n} while (i == 1);\r\nif (!XFS_FORCED_SHUTDOWN(cur->bc_mp))\r\nASSERT(freecount == be32_to_cpu(agi->agi_freecount));\r\n}\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_ialloc_inode_init(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nxfs_agnumber_t agno,\r\nxfs_agblock_t agbno,\r\nxfs_agblock_t length,\r\nunsigned int gen)\r\n{\r\nstruct xfs_buf *fbuf;\r\nstruct xfs_dinode *free;\r\nint blks_per_cluster, nbufs, ninodes;\r\nint version;\r\nint i, j;\r\nxfs_daddr_t d;\r\nif (mp->m_sb.sb_blocksize >= XFS_INODE_CLUSTER_SIZE(mp)) {\r\nblks_per_cluster = 1;\r\nnbufs = length;\r\nninodes = mp->m_sb.sb_inopblock;\r\n} else {\r\nblks_per_cluster = XFS_INODE_CLUSTER_SIZE(mp) /\r\nmp->m_sb.sb_blocksize;\r\nnbufs = length / blks_per_cluster;\r\nninodes = blks_per_cluster * mp->m_sb.sb_inopblock;\r\n}\r\nif (xfs_sb_version_hasnlink(&mp->m_sb))\r\nversion = 2;\r\nelse\r\nversion = 1;\r\nfor (j = 0; j < nbufs; j++) {\r\nd = XFS_AGB_TO_DADDR(mp, agno, agbno + (j * blks_per_cluster));\r\nfbuf = xfs_trans_get_buf(tp, mp->m_ddev_targp, d,\r\nmp->m_bsize * blks_per_cluster,\r\nXBF_LOCK);\r\nif (!fbuf)\r\nreturn ENOMEM;\r\nxfs_buf_zero(fbuf, 0, ninodes << mp->m_sb.sb_inodelog);\r\nfor (i = 0; i < ninodes; i++) {\r\nint ioffset = i << mp->m_sb.sb_inodelog;\r\nuint isize = sizeof(struct xfs_dinode);\r\nfree = xfs_make_iptr(mp, fbuf, i);\r\nfree->di_magic = cpu_to_be16(XFS_DINODE_MAGIC);\r\nfree->di_version = version;\r\nfree->di_gen = cpu_to_be32(gen);\r\nfree->di_next_unlinked = cpu_to_be32(NULLAGINO);\r\nxfs_trans_log_buf(tp, fbuf, ioffset, ioffset + isize - 1);\r\n}\r\nxfs_trans_inode_alloc_buf(tp, fbuf);\r\n}\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_ialloc_ag_alloc(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *agbp,\r\nint *alloc)\r\n{\r\nxfs_agi_t *agi;\r\nxfs_alloc_arg_t args;\r\nxfs_btree_cur_t *cur;\r\nxfs_agnumber_t agno;\r\nint error;\r\nint i;\r\nxfs_agino_t newino;\r\nxfs_agino_t newlen;\r\nxfs_agino_t thisino;\r\nint isaligned = 0;\r\nstruct xfs_perag *pag;\r\nargs.tp = tp;\r\nargs.mp = tp->t_mountp;\r\nnewlen = XFS_IALLOC_INODES(args.mp);\r\nif (args.mp->m_maxicount &&\r\nargs.mp->m_sb.sb_icount + newlen > args.mp->m_maxicount)\r\nreturn XFS_ERROR(ENOSPC);\r\nargs.minlen = args.maxlen = XFS_IALLOC_BLOCKS(args.mp);\r\nagi = XFS_BUF_TO_AGI(agbp);\r\nnewino = be32_to_cpu(agi->agi_newino);\r\nagno = be32_to_cpu(agi->agi_seqno);\r\nargs.agbno = XFS_AGINO_TO_AGBNO(args.mp, newino) +\r\nXFS_IALLOC_BLOCKS(args.mp);\r\nif (likely(newino != NULLAGINO &&\r\n(args.agbno < be32_to_cpu(agi->agi_length)))) {\r\nargs.fsbno = XFS_AGB_TO_FSB(args.mp, agno, args.agbno);\r\nargs.type = XFS_ALLOCTYPE_THIS_BNO;\r\nargs.mod = args.total = args.wasdel = args.isfl =\r\nargs.userdata = args.minalignslop = 0;\r\nargs.prod = 1;\r\nargs.alignment = 1;\r\nargs.minalignslop = xfs_ialloc_cluster_alignment(&args) - 1;\r\nargs.minleft = args.mp->m_in_maxlevels - 1;\r\nif ((error = xfs_alloc_vextent(&args)))\r\nreturn error;\r\n} else\r\nargs.fsbno = NULLFSBLOCK;\r\nif (unlikely(args.fsbno == NULLFSBLOCK)) {\r\nisaligned = 0;\r\nif (args.mp->m_sinoalign) {\r\nASSERT(!(args.mp->m_flags & XFS_MOUNT_NOALIGN));\r\nargs.alignment = args.mp->m_dalign;\r\nisaligned = 1;\r\n} else\r\nargs.alignment = xfs_ialloc_cluster_alignment(&args);\r\nargs.agbno = be32_to_cpu(agi->agi_root);\r\nargs.fsbno = XFS_AGB_TO_FSB(args.mp, agno, args.agbno);\r\nargs.type = XFS_ALLOCTYPE_NEAR_BNO;\r\nargs.mod = args.total = args.wasdel = args.isfl =\r\nargs.userdata = args.minalignslop = 0;\r\nargs.prod = 1;\r\nargs.minleft = args.mp->m_in_maxlevels - 1;\r\nif ((error = xfs_alloc_vextent(&args)))\r\nreturn error;\r\n}\r\nif (isaligned && args.fsbno == NULLFSBLOCK) {\r\nargs.type = XFS_ALLOCTYPE_NEAR_BNO;\r\nargs.agbno = be32_to_cpu(agi->agi_root);\r\nargs.fsbno = XFS_AGB_TO_FSB(args.mp, agno, args.agbno);\r\nargs.alignment = xfs_ialloc_cluster_alignment(&args);\r\nif ((error = xfs_alloc_vextent(&args)))\r\nreturn error;\r\n}\r\nif (args.fsbno == NULLFSBLOCK) {\r\n*alloc = 0;\r\nreturn 0;\r\n}\r\nASSERT(args.len == args.minlen);\r\nerror = xfs_ialloc_inode_init(args.mp, tp, agno, args.agbno,\r\nargs.len, random32());\r\nif (error)\r\nreturn error;\r\nnewino = XFS_OFFBNO_TO_AGINO(args.mp, args.agbno, 0);\r\nbe32_add_cpu(&agi->agi_count, newlen);\r\nbe32_add_cpu(&agi->agi_freecount, newlen);\r\npag = xfs_perag_get(args.mp, agno);\r\npag->pagi_freecount += newlen;\r\nxfs_perag_put(pag);\r\nagi->agi_newino = cpu_to_be32(newino);\r\ncur = xfs_inobt_init_cursor(args.mp, tp, agbp, agno);\r\nfor (thisino = newino;\r\nthisino < newino + newlen;\r\nthisino += XFS_INODES_PER_CHUNK) {\r\ncur->bc_rec.i.ir_startino = thisino;\r\ncur->bc_rec.i.ir_freecount = XFS_INODES_PER_CHUNK;\r\ncur->bc_rec.i.ir_free = XFS_INOBT_ALL_FREE;\r\nerror = xfs_btree_lookup(cur, XFS_LOOKUP_EQ, &i);\r\nif (error) {\r\nxfs_btree_del_cursor(cur, XFS_BTREE_ERROR);\r\nreturn error;\r\n}\r\nASSERT(i == 0);\r\nerror = xfs_btree_insert(cur, &i);\r\nif (error) {\r\nxfs_btree_del_cursor(cur, XFS_BTREE_ERROR);\r\nreturn error;\r\n}\r\nASSERT(i == 1);\r\n}\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\nxfs_ialloc_log_agi(tp, agbp,\r\nXFS_AGI_COUNT | XFS_AGI_FREECOUNT | XFS_AGI_NEWINO);\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_ICOUNT, (long)newlen);\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_IFREE, (long)newlen);\r\n*alloc = 1;\r\nreturn 0;\r\n}\r\nSTATIC xfs_agnumber_t\r\nxfs_ialloc_next_ag(\r\nxfs_mount_t *mp)\r\n{\r\nxfs_agnumber_t agno;\r\nspin_lock(&mp->m_agirotor_lock);\r\nagno = mp->m_agirotor;\r\nif (++mp->m_agirotor == mp->m_maxagi)\r\nmp->m_agirotor = 0;\r\nspin_unlock(&mp->m_agirotor_lock);\r\nreturn agno;\r\n}\r\nSTATIC xfs_buf_t *\r\nxfs_ialloc_ag_select(\r\nxfs_trans_t *tp,\r\nxfs_ino_t parent,\r\numode_t mode,\r\nint okalloc)\r\n{\r\nxfs_buf_t *agbp;\r\nxfs_agnumber_t agcount;\r\nxfs_agnumber_t agno;\r\nint flags;\r\nxfs_extlen_t ineed;\r\nxfs_extlen_t longest = 0;\r\nxfs_mount_t *mp;\r\nint needspace;\r\nxfs_perag_t *pag;\r\nxfs_agnumber_t pagno;\r\nneedspace = S_ISDIR(mode) || S_ISREG(mode) || S_ISLNK(mode);\r\nmp = tp->t_mountp;\r\nagcount = mp->m_maxagi;\r\nif (S_ISDIR(mode))\r\npagno = xfs_ialloc_next_ag(mp);\r\nelse {\r\npagno = XFS_INO_TO_AGNO(mp, parent);\r\nif (pagno >= agcount)\r\npagno = 0;\r\n}\r\nASSERT(pagno < agcount);\r\nagno = pagno;\r\nflags = XFS_ALLOC_FLAG_TRYLOCK;\r\nfor (;;) {\r\npag = xfs_perag_get(mp, agno);\r\nif (!pag->pagi_init) {\r\nif (xfs_ialloc_read_agi(mp, tp, agno, &agbp)) {\r\nagbp = NULL;\r\ngoto nextag;\r\n}\r\n} else\r\nagbp = NULL;\r\nif (!pag->pagi_inodeok) {\r\nxfs_ialloc_next_ag(mp);\r\ngoto unlock_nextag;\r\n}\r\nineed = pag->pagi_freecount ? 0 : XFS_IALLOC_BLOCKS(mp);\r\nif (ineed && !pag->pagf_init) {\r\nif (agbp == NULL &&\r\nxfs_ialloc_read_agi(mp, tp, agno, &agbp)) {\r\nagbp = NULL;\r\ngoto nextag;\r\n}\r\n(void)xfs_alloc_pagf_init(mp, tp, agno, flags);\r\n}\r\nif (!ineed || pag->pagf_init) {\r\nif (ineed && !(longest = pag->pagf_longest))\r\nlongest = pag->pagf_flcount > 0;\r\nif (!ineed ||\r\n(pag->pagf_freeblks >= needspace + ineed &&\r\nlongest >= ineed &&\r\nokalloc)) {\r\nif (agbp == NULL &&\r\nxfs_ialloc_read_agi(mp, tp, agno, &agbp)) {\r\nagbp = NULL;\r\ngoto nextag;\r\n}\r\nxfs_perag_put(pag);\r\nreturn agbp;\r\n}\r\n}\r\nunlock_nextag:\r\nif (agbp)\r\nxfs_trans_brelse(tp, agbp);\r\nnextag:\r\nxfs_perag_put(pag);\r\nif (XFS_FORCED_SHUTDOWN(mp))\r\nreturn NULL;\r\nagno++;\r\nif (agno >= agcount)\r\nagno = 0;\r\nif (agno == pagno) {\r\nif (flags == 0)\r\nreturn NULL;\r\nflags = 0;\r\n}\r\n}\r\n}\r\nSTATIC int\r\nxfs_ialloc_next_rec(\r\nstruct xfs_btree_cur *cur,\r\nxfs_inobt_rec_incore_t *rec,\r\nint *done,\r\nint left)\r\n{\r\nint error;\r\nint i;\r\nif (left)\r\nerror = xfs_btree_decrement(cur, 0, &i);\r\nelse\r\nerror = xfs_btree_increment(cur, 0, &i);\r\nif (error)\r\nreturn error;\r\n*done = !i;\r\nif (i) {\r\nerror = xfs_inobt_get_rec(cur, rec, &i);\r\nif (error)\r\nreturn error;\r\nXFS_WANT_CORRUPTED_RETURN(i == 1);\r\n}\r\nreturn 0;\r\n}\r\nSTATIC int\r\nxfs_ialloc_get_rec(\r\nstruct xfs_btree_cur *cur,\r\nxfs_agino_t agino,\r\nxfs_inobt_rec_incore_t *rec,\r\nint *done,\r\nint left)\r\n{\r\nint error;\r\nint i;\r\nerror = xfs_inobt_lookup(cur, agino, XFS_LOOKUP_EQ, &i);\r\nif (error)\r\nreturn error;\r\n*done = !i;\r\nif (i) {\r\nerror = xfs_inobt_get_rec(cur, rec, &i);\r\nif (error)\r\nreturn error;\r\nXFS_WANT_CORRUPTED_RETURN(i == 1);\r\n}\r\nreturn 0;\r\n}\r\nint\r\nxfs_dialloc(\r\nxfs_trans_t *tp,\r\nxfs_ino_t parent,\r\numode_t mode,\r\nint okalloc,\r\nxfs_buf_t **IO_agbp,\r\nboolean_t *alloc_done,\r\nxfs_ino_t *inop)\r\n{\r\nxfs_agnumber_t agcount;\r\nxfs_buf_t *agbp;\r\nxfs_agnumber_t agno;\r\nxfs_agi_t *agi;\r\nxfs_btree_cur_t *cur;\r\nint error;\r\nint i;\r\nint ialloced;\r\nint noroom = 0;\r\nxfs_ino_t ino;\r\nint j;\r\nxfs_mount_t *mp;\r\nint offset;\r\nxfs_agino_t pagino;\r\nxfs_agnumber_t pagno;\r\nxfs_inobt_rec_incore_t rec;\r\nxfs_agnumber_t tagno;\r\nxfs_btree_cur_t *tcur;\r\nxfs_inobt_rec_incore_t trec;\r\nstruct xfs_perag *pag;\r\nif (*IO_agbp == NULL) {\r\nagbp = xfs_ialloc_ag_select(tp, parent, mode, okalloc);\r\nif (!agbp) {\r\n*inop = NULLFSINO;\r\nreturn 0;\r\n}\r\nagi = XFS_BUF_TO_AGI(agbp);\r\nASSERT(agi->agi_magicnum == cpu_to_be32(XFS_AGI_MAGIC));\r\n} else {\r\nagbp = *IO_agbp;\r\nagi = XFS_BUF_TO_AGI(agbp);\r\nASSERT(agi->agi_magicnum == cpu_to_be32(XFS_AGI_MAGIC));\r\nASSERT(be32_to_cpu(agi->agi_freecount) > 0);\r\n}\r\nmp = tp->t_mountp;\r\nagcount = mp->m_sb.sb_agcount;\r\nagno = be32_to_cpu(agi->agi_seqno);\r\ntagno = agno;\r\npagno = XFS_INO_TO_AGNO(mp, parent);\r\npagino = XFS_INO_TO_AGINO(mp, parent);\r\nif (mp->m_maxicount &&\r\nmp->m_sb.sb_icount + XFS_IALLOC_INODES(mp) > mp->m_maxicount) {\r\nnoroom = 1;\r\nokalloc = 0;\r\n}\r\n*alloc_done = B_FALSE;\r\nwhile (!agi->agi_freecount) {\r\nif (okalloc) {\r\nif ((error = xfs_ialloc_ag_alloc(tp, agbp, &ialloced))) {\r\nxfs_trans_brelse(tp, agbp);\r\nif (error == ENOSPC) {\r\n*inop = NULLFSINO;\r\nreturn 0;\r\n} else\r\nreturn error;\r\n}\r\nif (ialloced) {\r\nASSERT(be32_to_cpu(agi->agi_freecount) > 0);\r\n*alloc_done = B_TRUE;\r\n*IO_agbp = agbp;\r\n*inop = NULLFSINO;\r\nreturn 0;\r\n}\r\n}\r\nxfs_trans_brelse(tp, agbp);\r\nnextag:\r\nif (++tagno == agcount)\r\ntagno = 0;\r\nif (tagno == agno) {\r\n*inop = NULLFSINO;\r\nreturn noroom ? ENOSPC : 0;\r\n}\r\npag = xfs_perag_get(mp, tagno);\r\nif (pag->pagi_inodeok == 0) {\r\nxfs_perag_put(pag);\r\ngoto nextag;\r\n}\r\nerror = xfs_ialloc_read_agi(mp, tp, tagno, &agbp);\r\nxfs_perag_put(pag);\r\nif (error)\r\ngoto nextag;\r\nagi = XFS_BUF_TO_AGI(agbp);\r\nASSERT(agi->agi_magicnum == cpu_to_be32(XFS_AGI_MAGIC));\r\n}\r\nagno = tagno;\r\n*IO_agbp = NULL;\r\npag = xfs_perag_get(mp, agno);\r\nrestart_pagno:\r\ncur = xfs_inobt_init_cursor(mp, tp, agbp, be32_to_cpu(agi->agi_seqno));\r\nif (!pagino)\r\npagino = be32_to_cpu(agi->agi_newino);\r\nerror = xfs_check_agi_freecount(cur, agi);\r\nif (error)\r\ngoto error0;\r\nif (pagno == agno) {\r\nint doneleft;\r\nint doneright;\r\nint searchdistance = 10;\r\nerror = xfs_inobt_lookup(cur, pagino, XFS_LOOKUP_LE, &i);\r\nif (error)\r\ngoto error0;\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\nerror = xfs_inobt_get_rec(cur, &rec, &j);\r\nif (error)\r\ngoto error0;\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\nif (rec.ir_freecount > 0) {\r\ngoto alloc_inode;\r\n}\r\nerror = xfs_btree_dup_cursor(cur, &tcur);\r\nif (error)\r\ngoto error0;\r\nif (pagino != NULLAGINO &&\r\npag->pagl_pagino == pagino &&\r\npag->pagl_leftrec != NULLAGINO &&\r\npag->pagl_rightrec != NULLAGINO) {\r\nerror = xfs_ialloc_get_rec(tcur, pag->pagl_leftrec,\r\n&trec, &doneleft, 1);\r\nif (error)\r\ngoto error1;\r\nerror = xfs_ialloc_get_rec(cur, pag->pagl_rightrec,\r\n&rec, &doneright, 0);\r\nif (error)\r\ngoto error1;\r\n} else {\r\nerror = xfs_ialloc_next_rec(tcur, &trec, &doneleft, 1);\r\nif (error)\r\ngoto error1;\r\nerror = xfs_ialloc_next_rec(cur, &rec, &doneright, 0);\r\nif (error)\r\ngoto error1;\r\n}\r\nwhile (!doneleft || !doneright) {\r\nint useleft;\r\nif (!--searchdistance) {\r\nxfs_btree_del_cursor(tcur, XFS_BTREE_NOERROR);\r\npag->pagl_leftrec = trec.ir_startino;\r\npag->pagl_rightrec = rec.ir_startino;\r\npag->pagl_pagino = pagino;\r\ngoto newino;\r\n}\r\nif (!doneleft && !doneright) {\r\nuseleft = pagino -\r\n(trec.ir_startino + XFS_INODES_PER_CHUNK - 1) <\r\nrec.ir_startino - pagino;\r\n} else {\r\nuseleft = !doneleft;\r\n}\r\nif (useleft && trec.ir_freecount) {\r\nrec = trec;\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\ncur = tcur;\r\npag->pagl_leftrec = trec.ir_startino;\r\npag->pagl_rightrec = rec.ir_startino;\r\npag->pagl_pagino = pagino;\r\ngoto alloc_inode;\r\n}\r\nif (!useleft && rec.ir_freecount) {\r\nxfs_btree_del_cursor(tcur, XFS_BTREE_NOERROR);\r\npag->pagl_leftrec = trec.ir_startino;\r\npag->pagl_rightrec = rec.ir_startino;\r\npag->pagl_pagino = pagino;\r\ngoto alloc_inode;\r\n}\r\nif (useleft) {\r\nerror = xfs_ialloc_next_rec(tcur, &trec,\r\n&doneleft, 1);\r\n} else {\r\nerror = xfs_ialloc_next_rec(cur, &rec,\r\n&doneright, 0);\r\n}\r\nif (error)\r\ngoto error1;\r\n}\r\npag->pagl_pagino = NULLAGINO;\r\npag->pagl_leftrec = NULLAGINO;\r\npag->pagl_rightrec = NULLAGINO;\r\nxfs_btree_del_cursor(tcur, XFS_BTREE_NOERROR);\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\ngoto restart_pagno;\r\n}\r\nnewino:\r\nif (agi->agi_newino != cpu_to_be32(NULLAGINO)) {\r\nerror = xfs_inobt_lookup(cur, be32_to_cpu(agi->agi_newino),\r\nXFS_LOOKUP_EQ, &i);\r\nif (error)\r\ngoto error0;\r\nif (i == 1) {\r\nerror = xfs_inobt_get_rec(cur, &rec, &j);\r\nif (error)\r\ngoto error0;\r\nif (j == 1 && rec.ir_freecount > 0) {\r\ngoto alloc_inode;\r\n}\r\n}\r\n}\r\nerror = xfs_inobt_lookup(cur, 0, XFS_LOOKUP_GE, &i);\r\nif (error)\r\ngoto error0;\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\nfor (;;) {\r\nerror = xfs_inobt_get_rec(cur, &rec, &i);\r\nif (error)\r\ngoto error0;\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\nif (rec.ir_freecount > 0)\r\nbreak;\r\nerror = xfs_btree_increment(cur, 0, &i);\r\nif (error)\r\ngoto error0;\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\n}\r\nalloc_inode:\r\noffset = xfs_ialloc_find_free(&rec.ir_free);\r\nASSERT(offset >= 0);\r\nASSERT(offset < XFS_INODES_PER_CHUNK);\r\nASSERT((XFS_AGINO_TO_OFFSET(mp, rec.ir_startino) %\r\nXFS_INODES_PER_CHUNK) == 0);\r\nino = XFS_AGINO_TO_INO(mp, agno, rec.ir_startino + offset);\r\nrec.ir_free &= ~XFS_INOBT_MASK(offset);\r\nrec.ir_freecount--;\r\nerror = xfs_inobt_update(cur, &rec);\r\nif (error)\r\ngoto error0;\r\nbe32_add_cpu(&agi->agi_freecount, -1);\r\nxfs_ialloc_log_agi(tp, agbp, XFS_AGI_FREECOUNT);\r\npag->pagi_freecount--;\r\nerror = xfs_check_agi_freecount(cur, agi);\r\nif (error)\r\ngoto error0;\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_IFREE, -1);\r\nxfs_perag_put(pag);\r\n*inop = ino;\r\nreturn 0;\r\nerror1:\r\nxfs_btree_del_cursor(tcur, XFS_BTREE_ERROR);\r\nerror0:\r\nxfs_btree_del_cursor(cur, XFS_BTREE_ERROR);\r\nxfs_perag_put(pag);\r\nreturn error;\r\n}\r\nint\r\nxfs_difree(\r\nxfs_trans_t *tp,\r\nxfs_ino_t inode,\r\nxfs_bmap_free_t *flist,\r\nint *delete,\r\nxfs_ino_t *first_ino)\r\n{\r\nxfs_agblock_t agbno;\r\nxfs_buf_t *agbp;\r\nxfs_agino_t agino;\r\nxfs_agnumber_t agno;\r\nxfs_agi_t *agi;\r\nxfs_btree_cur_t *cur;\r\nint error;\r\nint i;\r\nint ilen;\r\nxfs_mount_t *mp;\r\nint off;\r\nxfs_inobt_rec_incore_t rec;\r\nstruct xfs_perag *pag;\r\nmp = tp->t_mountp;\r\nagno = XFS_INO_TO_AGNO(mp, inode);\r\nif (agno >= mp->m_sb.sb_agcount) {\r\nxfs_warn(mp, "%s: agno >= mp->m_sb.sb_agcount (%d >= %d).",\r\n__func__, agno, mp->m_sb.sb_agcount);\r\nASSERT(0);\r\nreturn XFS_ERROR(EINVAL);\r\n}\r\nagino = XFS_INO_TO_AGINO(mp, inode);\r\nif (inode != XFS_AGINO_TO_INO(mp, agno, agino)) {\r\nxfs_warn(mp, "%s: inode != XFS_AGINO_TO_INO() (%llu != %llu).",\r\n__func__, (unsigned long long)inode,\r\n(unsigned long long)XFS_AGINO_TO_INO(mp, agno, agino));\r\nASSERT(0);\r\nreturn XFS_ERROR(EINVAL);\r\n}\r\nagbno = XFS_AGINO_TO_AGBNO(mp, agino);\r\nif (agbno >= mp->m_sb.sb_agblocks) {\r\nxfs_warn(mp, "%s: agbno >= mp->m_sb.sb_agblocks (%d >= %d).",\r\n__func__, agbno, mp->m_sb.sb_agblocks);\r\nASSERT(0);\r\nreturn XFS_ERROR(EINVAL);\r\n}\r\nerror = xfs_ialloc_read_agi(mp, tp, agno, &agbp);\r\nif (error) {\r\nxfs_warn(mp, "%s: xfs_ialloc_read_agi() returned error %d.",\r\n__func__, error);\r\nreturn error;\r\n}\r\nagi = XFS_BUF_TO_AGI(agbp);\r\nASSERT(agi->agi_magicnum == cpu_to_be32(XFS_AGI_MAGIC));\r\nASSERT(agbno < be32_to_cpu(agi->agi_length));\r\ncur = xfs_inobt_init_cursor(mp, tp, agbp, agno);\r\nerror = xfs_check_agi_freecount(cur, agi);\r\nif (error)\r\ngoto error0;\r\nif ((error = xfs_inobt_lookup(cur, agino, XFS_LOOKUP_LE, &i))) {\r\nxfs_warn(mp, "%s: xfs_inobt_lookup() returned error %d.",\r\n__func__, error);\r\ngoto error0;\r\n}\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\nerror = xfs_inobt_get_rec(cur, &rec, &i);\r\nif (error) {\r\nxfs_warn(mp, "%s: xfs_inobt_get_rec() returned error %d.",\r\n__func__, error);\r\ngoto error0;\r\n}\r\nXFS_WANT_CORRUPTED_GOTO(i == 1, error0);\r\noff = agino - rec.ir_startino;\r\nASSERT(off >= 0 && off < XFS_INODES_PER_CHUNK);\r\nASSERT(!(rec.ir_free & XFS_INOBT_MASK(off)));\r\nrec.ir_free |= XFS_INOBT_MASK(off);\r\nrec.ir_freecount++;\r\nif (!(mp->m_flags & XFS_MOUNT_IKEEP) &&\r\n(rec.ir_freecount == XFS_IALLOC_INODES(mp))) {\r\n*delete = 1;\r\n*first_ino = XFS_AGINO_TO_INO(mp, agno, rec.ir_startino);\r\nilen = XFS_IALLOC_INODES(mp);\r\nbe32_add_cpu(&agi->agi_count, -ilen);\r\nbe32_add_cpu(&agi->agi_freecount, -(ilen - 1));\r\nxfs_ialloc_log_agi(tp, agbp, XFS_AGI_COUNT | XFS_AGI_FREECOUNT);\r\npag = xfs_perag_get(mp, agno);\r\npag->pagi_freecount -= ilen - 1;\r\nxfs_perag_put(pag);\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_ICOUNT, -ilen);\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_IFREE, -(ilen - 1));\r\nif ((error = xfs_btree_delete(cur, &i))) {\r\nxfs_warn(mp, "%s: xfs_btree_delete returned error %d.",\r\n__func__, error);\r\ngoto error0;\r\n}\r\nxfs_bmap_add_free(XFS_AGB_TO_FSB(mp,\r\nagno, XFS_INO_TO_AGBNO(mp,rec.ir_startino)),\r\nXFS_IALLOC_BLOCKS(mp), flist, mp);\r\n} else {\r\n*delete = 0;\r\nerror = xfs_inobt_update(cur, &rec);\r\nif (error) {\r\nxfs_warn(mp, "%s: xfs_inobt_update returned error %d.",\r\n__func__, error);\r\ngoto error0;\r\n}\r\nbe32_add_cpu(&agi->agi_freecount, 1);\r\nxfs_ialloc_log_agi(tp, agbp, XFS_AGI_FREECOUNT);\r\npag = xfs_perag_get(mp, agno);\r\npag->pagi_freecount++;\r\nxfs_perag_put(pag);\r\nxfs_trans_mod_sb(tp, XFS_TRANS_SB_IFREE, 1);\r\n}\r\nerror = xfs_check_agi_freecount(cur, agi);\r\nif (error)\r\ngoto error0;\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\nreturn 0;\r\nerror0:\r\nxfs_btree_del_cursor(cur, XFS_BTREE_ERROR);\r\nreturn error;\r\n}\r\nSTATIC int\r\nxfs_imap_lookup(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nxfs_agnumber_t agno,\r\nxfs_agino_t agino,\r\nxfs_agblock_t agbno,\r\nxfs_agblock_t *chunk_agbno,\r\nxfs_agblock_t *offset_agbno,\r\nint flags)\r\n{\r\nstruct xfs_inobt_rec_incore rec;\r\nstruct xfs_btree_cur *cur;\r\nstruct xfs_buf *agbp;\r\nint error;\r\nint i;\r\nerror = xfs_ialloc_read_agi(mp, tp, agno, &agbp);\r\nif (error) {\r\nxfs_alert(mp,\r\n"%s: xfs_ialloc_read_agi() returned error %d, agno %d",\r\n__func__, error, agno);\r\nreturn error;\r\n}\r\ncur = xfs_inobt_init_cursor(mp, tp, agbp, agno);\r\nerror = xfs_inobt_lookup(cur, agino, XFS_LOOKUP_LE, &i);\r\nif (!error) {\r\nif (i)\r\nerror = xfs_inobt_get_rec(cur, &rec, &i);\r\nif (!error && i == 0)\r\nerror = EINVAL;\r\n}\r\nxfs_trans_brelse(tp, agbp);\r\nxfs_btree_del_cursor(cur, XFS_BTREE_NOERROR);\r\nif (error)\r\nreturn error;\r\nif (rec.ir_startino > agino ||\r\nrec.ir_startino + XFS_IALLOC_INODES(mp) <= agino)\r\nreturn EINVAL;\r\nif ((flags & XFS_IGET_UNTRUSTED) &&\r\n(rec.ir_free & XFS_INOBT_MASK(agino - rec.ir_startino)))\r\nreturn EINVAL;\r\n*chunk_agbno = XFS_AGINO_TO_AGBNO(mp, rec.ir_startino);\r\n*offset_agbno = agbno - *chunk_agbno;\r\nreturn 0;\r\n}\r\nint\r\nxfs_imap(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_ino_t ino,\r\nstruct xfs_imap *imap,\r\nuint flags)\r\n{\r\nxfs_agblock_t agbno;\r\nxfs_agino_t agino;\r\nxfs_agnumber_t agno;\r\nint blks_per_cluster;\r\nxfs_agblock_t chunk_agbno;\r\nxfs_agblock_t cluster_agbno;\r\nint error;\r\nint offset;\r\nint offset_agbno;\r\nASSERT(ino != NULLFSINO);\r\nagno = XFS_INO_TO_AGNO(mp, ino);\r\nagino = XFS_INO_TO_AGINO(mp, ino);\r\nagbno = XFS_AGINO_TO_AGBNO(mp, agino);\r\nif (agno >= mp->m_sb.sb_agcount || agbno >= mp->m_sb.sb_agblocks ||\r\nino != XFS_AGINO_TO_INO(mp, agno, agino)) {\r\n#ifdef DEBUG\r\nif (flags & XFS_IGET_UNTRUSTED)\r\nreturn XFS_ERROR(EINVAL);\r\nif (agno >= mp->m_sb.sb_agcount) {\r\nxfs_alert(mp,\r\n"%s: agno (%d) >= mp->m_sb.sb_agcount (%d)",\r\n__func__, agno, mp->m_sb.sb_agcount);\r\n}\r\nif (agbno >= mp->m_sb.sb_agblocks) {\r\nxfs_alert(mp,\r\n"%s: agbno (0x%llx) >= mp->m_sb.sb_agblocks (0x%lx)",\r\n__func__, (unsigned long long)agbno,\r\n(unsigned long)mp->m_sb.sb_agblocks);\r\n}\r\nif (ino != XFS_AGINO_TO_INO(mp, agno, agino)) {\r\nxfs_alert(mp,\r\n"%s: ino (0x%llx) != XFS_AGINO_TO_INO() (0x%llx)",\r\n__func__, ino,\r\nXFS_AGINO_TO_INO(mp, agno, agino));\r\n}\r\nxfs_stack_trace();\r\n#endif\r\nreturn XFS_ERROR(EINVAL);\r\n}\r\nblks_per_cluster = XFS_INODE_CLUSTER_SIZE(mp) >> mp->m_sb.sb_blocklog;\r\nif (flags & XFS_IGET_UNTRUSTED) {\r\nerror = xfs_imap_lookup(mp, tp, agno, agino, agbno,\r\n&chunk_agbno, &offset_agbno, flags);\r\nif (error)\r\nreturn error;\r\ngoto out_map;\r\n}\r\nif (XFS_INODE_CLUSTER_SIZE(mp) <= mp->m_sb.sb_blocksize) {\r\noffset = XFS_INO_TO_OFFSET(mp, ino);\r\nASSERT(offset < mp->m_sb.sb_inopblock);\r\nimap->im_blkno = XFS_AGB_TO_DADDR(mp, agno, agbno);\r\nimap->im_len = XFS_FSB_TO_BB(mp, 1);\r\nimap->im_boffset = (ushort)(offset << mp->m_sb.sb_inodelog);\r\nreturn 0;\r\n}\r\nif (mp->m_inoalign_mask) {\r\noffset_agbno = agbno & mp->m_inoalign_mask;\r\nchunk_agbno = agbno - offset_agbno;\r\n} else {\r\nerror = xfs_imap_lookup(mp, tp, agno, agino, agbno,\r\n&chunk_agbno, &offset_agbno, flags);\r\nif (error)\r\nreturn error;\r\n}\r\nout_map:\r\nASSERT(agbno >= chunk_agbno);\r\ncluster_agbno = chunk_agbno +\r\n((offset_agbno / blks_per_cluster) * blks_per_cluster);\r\noffset = ((agbno - cluster_agbno) * mp->m_sb.sb_inopblock) +\r\nXFS_INO_TO_OFFSET(mp, ino);\r\nimap->im_blkno = XFS_AGB_TO_DADDR(mp, agno, cluster_agbno);\r\nimap->im_len = XFS_FSB_TO_BB(mp, blks_per_cluster);\r\nimap->im_boffset = (ushort)(offset << mp->m_sb.sb_inodelog);\r\nif ((imap->im_blkno + imap->im_len) >\r\nXFS_FSB_TO_BB(mp, mp->m_sb.sb_dblocks)) {\r\nxfs_alert(mp,\r\n"%s: (im_blkno (0x%llx) + im_len (0x%llx)) > sb_dblocks (0x%llx)",\r\n__func__, (unsigned long long) imap->im_blkno,\r\n(unsigned long long) imap->im_len,\r\nXFS_FSB_TO_BB(mp, mp->m_sb.sb_dblocks));\r\nreturn XFS_ERROR(EINVAL);\r\n}\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_ialloc_compute_maxlevels(\r\nxfs_mount_t *mp)\r\n{\r\nint level;\r\nuint maxblocks;\r\nuint maxleafents;\r\nint minleafrecs;\r\nint minnoderecs;\r\nmaxleafents = (1LL << XFS_INO_AGINO_BITS(mp)) >>\r\nXFS_INODES_PER_CHUNK_LOG;\r\nminleafrecs = mp->m_alloc_mnr[0];\r\nminnoderecs = mp->m_alloc_mnr[1];\r\nmaxblocks = (maxleafents + minleafrecs - 1) / minleafrecs;\r\nfor (level = 1; maxblocks > 1; level++)\r\nmaxblocks = (maxblocks + minnoderecs - 1) / minnoderecs;\r\nmp->m_in_maxlevels = level;\r\n}\r\nvoid\r\nxfs_ialloc_log_agi(\r\nxfs_trans_t *tp,\r\nxfs_buf_t *bp,\r\nint fields)\r\n{\r\nint first;\r\nint last;\r\nstatic const short offsets[] = {\r\noffsetof(xfs_agi_t, agi_magicnum),\r\noffsetof(xfs_agi_t, agi_versionnum),\r\noffsetof(xfs_agi_t, agi_seqno),\r\noffsetof(xfs_agi_t, agi_length),\r\noffsetof(xfs_agi_t, agi_count),\r\noffsetof(xfs_agi_t, agi_root),\r\noffsetof(xfs_agi_t, agi_level),\r\noffsetof(xfs_agi_t, agi_freecount),\r\noffsetof(xfs_agi_t, agi_newino),\r\noffsetof(xfs_agi_t, agi_dirino),\r\noffsetof(xfs_agi_t, agi_unlinked),\r\nsizeof(xfs_agi_t)\r\n};\r\n#ifdef DEBUG\r\nxfs_agi_t *agi;\r\nagi = XFS_BUF_TO_AGI(bp);\r\nASSERT(agi->agi_magicnum == cpu_to_be32(XFS_AGI_MAGIC));\r\n#endif\r\nxfs_btree_offsets(fields, offsets, XFS_AGI_NUM_BITS, &first, &last);\r\nxfs_trans_log_buf(tp, bp, first, last);\r\n}\r\nSTATIC void\r\nxfs_check_agi_unlinked(\r\nstruct xfs_agi *agi)\r\n{\r\nint i;\r\nfor (i = 0; i < XFS_AGI_UNLINKED_BUCKETS; i++)\r\nASSERT(agi->agi_unlinked[i]);\r\n}\r\nint\r\nxfs_read_agi(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nxfs_agnumber_t agno,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_agi *agi;\r\nint agi_ok;\r\nint error;\r\nASSERT(agno != NULLAGNUMBER);\r\nerror = xfs_trans_read_buf(mp, tp, mp->m_ddev_targp,\r\nXFS_AG_DADDR(mp, agno, XFS_AGI_DADDR(mp)),\r\nXFS_FSS_TO_BB(mp, 1), 0, bpp);\r\nif (error)\r\nreturn error;\r\nASSERT(!xfs_buf_geterror(*bpp));\r\nagi = XFS_BUF_TO_AGI(*bpp);\r\nagi_ok = agi->agi_magicnum == cpu_to_be32(XFS_AGI_MAGIC) &&\r\nXFS_AGI_GOOD_VERSION(be32_to_cpu(agi->agi_versionnum)) &&\r\nbe32_to_cpu(agi->agi_seqno) == agno;\r\nif (unlikely(XFS_TEST_ERROR(!agi_ok, mp, XFS_ERRTAG_IALLOC_READ_AGI,\r\nXFS_RANDOM_IALLOC_READ_AGI))) {\r\nXFS_CORRUPTION_ERROR("xfs_read_agi", XFS_ERRLEVEL_LOW,\r\nmp, agi);\r\nxfs_trans_brelse(tp, *bpp);\r\nreturn XFS_ERROR(EFSCORRUPTED);\r\n}\r\nxfs_buf_set_ref(*bpp, XFS_AGI_REF);\r\nxfs_check_agi_unlinked(agi);\r\nreturn 0;\r\n}\r\nint\r\nxfs_ialloc_read_agi(\r\nstruct xfs_mount *mp,\r\nstruct xfs_trans *tp,\r\nxfs_agnumber_t agno,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_agi *agi;\r\nstruct xfs_perag *pag;\r\nint error;\r\nerror = xfs_read_agi(mp, tp, agno, bpp);\r\nif (error)\r\nreturn error;\r\nagi = XFS_BUF_TO_AGI(*bpp);\r\npag = xfs_perag_get(mp, agno);\r\nif (!pag->pagi_init) {\r\npag->pagi_freecount = be32_to_cpu(agi->agi_freecount);\r\npag->pagi_count = be32_to_cpu(agi->agi_count);\r\npag->pagi_init = 1;\r\n}\r\nASSERT(pag->pagi_freecount == be32_to_cpu(agi->agi_freecount) ||\r\nXFS_FORCED_SHUTDOWN(mp));\r\nxfs_perag_put(pag);\r\nreturn 0;\r\n}\r\nint\r\nxfs_ialloc_pagi_init(\r\nxfs_mount_t *mp,\r\nxfs_trans_t *tp,\r\nxfs_agnumber_t agno)\r\n{\r\nxfs_buf_t *bp = NULL;\r\nint error;\r\nerror = xfs_ialloc_read_agi(mp, tp, agno, &bp);\r\nif (error)\r\nreturn error;\r\nif (bp)\r\nxfs_trans_brelse(tp, bp);\r\nreturn 0;\r\n}

static int pci1723_reset(struct comedi_device *dev)\r\n{\r\nint i;\r\nDPRINTK("adv_pci1723 EDBG: BGN: pci1723_reset(...)\n");\r\noutw(0x01, dev->iobase + PCI1723_SYN_SET);\r\nfor (i = 0; i < 8; i++) {\r\ndevpriv->ao_data[i] = 0x8000;\r\noutw(devpriv->ao_data[i], dev->iobase + PCI1723_DA(i));\r\ndevpriv->da_range[i] = 0;\r\noutw(((devpriv->da_range[i] << 4) | i),\r\nPCI1723_RANGE_CALIBRATION_MODE);\r\n}\r\noutw(0, dev->iobase + PCI1723_CHANGE_CHA_OUTPUT_TYPE_STROBE);\r\noutw(0, dev->iobase + PCI1723_SYN_STROBE);\r\noutw(0, dev->iobase + PCI1723_SYN_SET);\r\nDPRINTK("adv_pci1723 EDBG: END: pci1723_reset(...)\n");\r\nreturn 0;\r\n}\r\nstatic int pci1723_insn_read_ao(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nDPRINTK(" adv_PCI1723 DEBUG: pci1723_insn_read_ao() -----\n");\r\nfor (n = 0; n < insn->n; n++)\r\ndata[n] = devpriv->ao_data[chan];\r\nreturn n;\r\n}\r\nstatic int pci1723_ao_write_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n, chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nDPRINTK("PCI1723: the pci1723_ao_write_winsn() ------\n");\r\nfor (n = 0; n < insn->n; n++) {\r\ndevpriv->ao_data[chan] = data[n];\r\noutw(data[n], dev->iobase + PCI1723_DA(chan));\r\n}\r\nreturn n;\r\n}\r\nstatic int pci1723_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int mask;\r\nunsigned int bits;\r\nunsigned short dio_mode;\r\nmask = 1 << CR_CHAN(insn->chanspec);\r\nif (mask & 0x00FF)\r\nbits = 0x00FF;\r\nelse\r\nbits = 0xFF00;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_INPUT:\r\ns->io_bits &= ~bits;\r\nbreak;\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ns->io_bits |= bits;\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] = (s->io_bits & bits) ? COMEDI_OUTPUT : COMEDI_INPUT;\r\nreturn insn->n;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndio_mode = 0x0000;\r\nif ((s->io_bits & 0x00FF) == 0)\r\ndio_mode |= 0x0001;\r\nif ((s->io_bits & 0xFF00) == 0)\r\ndio_mode |= 0x0002;\r\noutw(dio_mode, dev->iobase + PCI1723_DIGITAL_IO_PORT_SET);\r\nreturn 1;\r\n}\r\nstatic int pci1723_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nif (data[0]) {\r\ns->state &= ~data[0];\r\ns->state |= (data[0] & data[1]);\r\noutw(s->state, dev->iobase + PCI1723_WRITE_DIGITAL_OUTPUT_CMD);\r\n}\r\ndata[1] = inw(dev->iobase + PCI1723_READ_DIGITAL_INPUT_DATA);\r\nreturn 2;\r\n}\r\nstatic int pci1723_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct comedi_subdevice *s;\r\nint ret, subdev, n_subdevices;\r\nstruct pci_dev *pcidev;\r\nunsigned int iobase;\r\nunsigned char pci_bus, pci_slot, pci_func;\r\nint opt_bus, opt_slot;\r\nconst char *errstr;\r\nprintk(KERN_ERR "comedi%d: adv_pci1723: board=%s",\r\ndev->minor, this_board->name);\r\nopt_bus = it->options[0];\r\nopt_slot = it->options[1];\r\nret = alloc_private(dev, sizeof(struct pci1723_private));\r\nif (ret < 0) {\r\nprintk(" - Allocation failed!\n");\r\nreturn -ENOMEM;\r\n}\r\nerrstr = "not found!";\r\npcidev = NULL;\r\nwhile (NULL != (pcidev =\r\npci_get_device(PCI_VENDOR_ID_ADVANTECH,\r\nthis_board->device_id, pcidev))) {\r\nif (opt_bus || opt_slot) {\r\nif (opt_bus != pcidev->bus->number\r\n|| opt_slot != PCI_SLOT(pcidev->devfn))\r\ncontinue;\r\n}\r\nif (comedi_pci_enable(pcidev, "adv_pci1723")) {\r\nerrstr =\r\n"failed to enable PCI device and request regions!";\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\nif (!pcidev) {\r\nif (opt_bus || opt_slot) {\r\nprintk(KERN_ERR " - Card at b:s %d:%d %s\n",\r\nopt_bus, opt_slot, errstr);\r\n} else {\r\nprintk(KERN_ERR " - Card %s\n", errstr);\r\n}\r\nreturn -EIO;\r\n}\r\npci_bus = pcidev->bus->number;\r\npci_slot = PCI_SLOT(pcidev->devfn);\r\npci_func = PCI_FUNC(pcidev->devfn);\r\niobase = pci_resource_start(pcidev, 2);\r\nprintk(KERN_ERR ", b:s:f=%d:%d:%d, io=0x%4x",\r\npci_bus, pci_slot, pci_func, iobase);\r\ndev->iobase = iobase;\r\ndev->board_name = this_board->name;\r\ndevpriv->pcidev = pcidev;\r\nn_subdevices = 0;\r\nif (this_board->n_aochan)\r\nn_subdevices++;\r\nif (this_board->n_diochan)\r\nn_subdevices++;\r\nret = alloc_subdevices(dev, n_subdevices);\r\nif (ret < 0) {\r\nprintk(" - Allocation failed!\n");\r\nreturn ret;\r\n}\r\npci1723_reset(dev);\r\nsubdev = 0;\r\nif (this_board->n_aochan) {\r\ns = dev->subdevices + subdev;\r\ndev->write_subdev = s;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = this_board->n_aochan;\r\ns->maxdata = this_board->ao_maxdata;\r\ns->len_chanlist = this_board->n_aochan;\r\ns->range_table = this_board->rangelist_ao;\r\ns->insn_write = pci1723_ao_write_winsn;\r\ns->insn_read = pci1723_insn_read_ao;\r\nswitch (inw(dev->iobase + PCI1723_DIGITAL_IO_PORT_MODE)\r\n& 0x03) {\r\ncase 0x00:\r\ns->io_bits = 0xFFFF;\r\nbreak;\r\ncase 0x01:\r\ns->io_bits = 0xFF00;\r\nbreak;\r\ncase 0x02:\r\ns->io_bits = 0x00FF;\r\nbreak;\r\ncase 0x03:\r\ns->io_bits = 0x0000;\r\nbreak;\r\n}\r\ns->state = inw(dev->iobase + PCI1723_READ_DIGITAL_INPUT_DATA);\r\nsubdev++;\r\n}\r\nif (this_board->n_diochan) {\r\ns = dev->subdevices + subdev;\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags =\r\nSDF_READABLE | SDF_WRITABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = this_board->n_diochan;\r\ns->maxdata = 1;\r\ns->len_chanlist = this_board->n_diochan;\r\ns->range_table = &range_digital;\r\ns->insn_config = pci1723_dio_insn_config;\r\ns->insn_bits = pci1723_dio_insn_bits;\r\nsubdev++;\r\n}\r\ndevpriv->valid = 1;\r\npci1723_reset(dev);\r\nreturn 0;\r\n}\r\nstatic int pci1723_detach(struct comedi_device *dev)\r\n{\r\nprintk(KERN_ERR "comedi%d: pci1723: remove\n", dev->minor);\r\nif (dev->private) {\r\nif (devpriv->valid)\r\npci1723_reset(dev);\r\nif (devpriv->pcidev) {\r\nif (dev->iobase)\r\ncomedi_pci_disable(devpriv->pcidev);\r\npci_dev_put(devpriv->pcidev);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit driver_pci1723_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_pci1723.driver_name);\r\n}\r\nstatic void __devexit driver_pci1723_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_pci1723_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_pci1723);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_pci1723_pci_driver.name = (char *)driver_pci1723.driver_name;\r\nreturn pci_register_driver(&driver_pci1723_pci_driver);\r\n}\r\nstatic void __exit driver_pci1723_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_pci1723_pci_driver);\r\ncomedi_driver_unregister(&driver_pci1723);\r\n}

static inline struct panel_dvi_platform_data\r\n*get_pdata(const struct omap_dss_device *dssdev)\r\n{\r\nreturn dssdev->data;\r\n}\r\nstatic int panel_dvi_power_on(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_dvi_platform_data *pdata = get_pdata(dssdev);\r\nint r;\r\nif (dssdev->state == OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn 0;\r\nr = omapdss_dpi_display_enable(dssdev);\r\nif (r)\r\ngoto err0;\r\nif (pdata->platform_enable) {\r\nr = pdata->platform_enable(dssdev);\r\nif (r)\r\ngoto err1;\r\n}\r\nreturn 0;\r\nerr1:\r\nomapdss_dpi_display_disable(dssdev);\r\nerr0:\r\nreturn r;\r\n}\r\nstatic void panel_dvi_power_off(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_dvi_platform_data *pdata = get_pdata(dssdev);\r\nif (dssdev->state != OMAP_DSS_DISPLAY_ACTIVE)\r\nreturn;\r\nif (pdata->platform_disable)\r\npdata->platform_disable(dssdev);\r\nomapdss_dpi_display_disable(dssdev);\r\n}\r\nstatic int panel_dvi_probe(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata;\r\nddata = kzalloc(sizeof(*ddata), GFP_KERNEL);\r\nif (!ddata)\r\nreturn -ENOMEM;\r\ndssdev->panel.timings = panel_dvi_default_timings;\r\ndssdev->panel.config = OMAP_DSS_LCD_TFT;\r\nddata->dssdev = dssdev;\r\nmutex_init(&ddata->lock);\r\ndev_set_drvdata(&dssdev->dev, ddata);\r\nreturn 0;\r\n}\r\nstatic void __exit panel_dvi_remove(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\ndev_set_drvdata(&dssdev->dev, NULL);\r\nmutex_unlock(&ddata->lock);\r\nkfree(ddata);\r\n}\r\nstatic int panel_dvi_enable(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nr = panel_dvi_power_on(dssdev);\r\nif (r == 0)\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic void panel_dvi_disable(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\npanel_dvi_power_off(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_DISABLED;\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic int panel_dvi_suspend(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\npanel_dvi_power_off(dssdev);\r\ndssdev->state = OMAP_DSS_DISPLAY_SUSPENDED;\r\nmutex_unlock(&ddata->lock);\r\nreturn 0;\r\n}\r\nstatic int panel_dvi_resume(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nr = panel_dvi_power_on(dssdev);\r\nif (r == 0)\r\ndssdev->state = OMAP_DSS_DISPLAY_ACTIVE;\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic void panel_dvi_set_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\ndpi_set_timings(dssdev, timings);\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic void panel_dvi_get_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nmutex_lock(&ddata->lock);\r\n*timings = dssdev->panel.timings;\r\nmutex_unlock(&ddata->lock);\r\n}\r\nstatic int panel_dvi_check_timings(struct omap_dss_device *dssdev,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nr = dpi_check_timings(dssdev, timings);\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic int panel_dvi_ddc_read(struct i2c_adapter *adapter,\r\nunsigned char *buf, u16 count, u8 offset)\r\n{\r\nint r, retries;\r\nfor (retries = 3; retries > 0; retries--) {\r\nstruct i2c_msg msgs[] = {\r\n{\r\n.addr = DDC_ADDR,\r\n.flags = 0,\r\n.len = 1,\r\n.buf = &offset,\r\n}, {\r\n.addr = DDC_ADDR,\r\n.flags = I2C_M_RD,\r\n.len = count,\r\n.buf = buf,\r\n}\r\n};\r\nr = i2c_transfer(adapter, msgs, 2);\r\nif (r == 2)\r\nreturn 0;\r\nif (r != -EAGAIN)\r\nbreak;\r\n}\r\nreturn r < 0 ? r : -EIO;\r\n}\r\nstatic int panel_dvi_read_edid(struct omap_dss_device *dssdev,\r\nu8 *edid, int len)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nstruct panel_dvi_platform_data *pdata = get_pdata(dssdev);\r\nstruct i2c_adapter *adapter;\r\nint r, l, bytes_read;\r\nmutex_lock(&ddata->lock);\r\nif (pdata->i2c_bus_num == 0) {\r\nr = -ENODEV;\r\ngoto err;\r\n}\r\nadapter = i2c_get_adapter(pdata->i2c_bus_num);\r\nif (!adapter) {\r\ndev_err(&dssdev->dev, "Failed to get I2C adapter, bus %d\n",\r\npdata->i2c_bus_num);\r\nr = -EINVAL;\r\ngoto err;\r\n}\r\nl = min(EDID_LENGTH, len);\r\nr = panel_dvi_ddc_read(adapter, edid, l, 0);\r\nif (r)\r\ngoto err;\r\nbytes_read = l;\r\nif (len > EDID_LENGTH && edid[0x7e] > 0) {\r\nl = min(EDID_LENGTH, len - EDID_LENGTH);\r\nr = panel_dvi_ddc_read(adapter, edid + EDID_LENGTH,\r\nl, EDID_LENGTH);\r\nif (r)\r\ngoto err;\r\nbytes_read += l;\r\n}\r\nmutex_unlock(&ddata->lock);\r\nreturn bytes_read;\r\nerr:\r\nmutex_unlock(&ddata->lock);\r\nreturn r;\r\n}\r\nstatic bool panel_dvi_detect(struct omap_dss_device *dssdev)\r\n{\r\nstruct panel_drv_data *ddata = dev_get_drvdata(&dssdev->dev);\r\nstruct panel_dvi_platform_data *pdata = get_pdata(dssdev);\r\nstruct i2c_adapter *adapter;\r\nunsigned char out;\r\nint r;\r\nmutex_lock(&ddata->lock);\r\nif (pdata->i2c_bus_num == 0)\r\ngoto out;\r\nadapter = i2c_get_adapter(pdata->i2c_bus_num);\r\nif (!adapter)\r\ngoto out;\r\nr = panel_dvi_ddc_read(adapter, &out, 1, 0);\r\nmutex_unlock(&ddata->lock);\r\nreturn r == 0;\r\nout:\r\nmutex_unlock(&ddata->lock);\r\nreturn true;\r\n}\r\nstatic int __init panel_dvi_init(void)\r\n{\r\nreturn omap_dss_register_driver(&panel_dvi_driver);\r\n}\r\nstatic void __exit panel_dvi_exit(void)\r\n{\r\nomap_dss_unregister_driver(&panel_dvi_driver);\r\n}

static int pcidio_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nstruct pci_dev *pcidev = NULL;\r\nint index;\r\nint i;\r\nif (alloc_private(dev, sizeof(struct pcidio_private)) < 0)\r\nreturn -ENOMEM;\r\nfor_each_pci_dev(pcidev) {\r\nif (pcidev->vendor != PCI_VENDOR_ID_CB)\r\ncontinue;\r\nfor (index = 0; index < ARRAY_SIZE(pcidio_boards); index++) {\r\nif (pcidio_boards[index].dev_id != pcidev->device)\r\ncontinue;\r\nif (it->options[0] || it->options[1]) {\r\nif (pcidev->bus->number != it->options[0] ||\r\nPCI_SLOT(pcidev->devfn) != it->options[1]) {\r\ncontinue;\r\n}\r\n}\r\ndev->board_ptr = pcidio_boards + index;\r\ngoto found;\r\n}\r\n}\r\ndev_err(dev->hw_dev, "No supported ComputerBoards/MeasurementComputing card found on requested position\n");\r\nreturn -EIO;\r\nfound:\r\ndev->board_name = thisboard->name;\r\ndevpriv->pci_dev = pcidev;\r\ndev_dbg(dev->hw_dev, "Found %s on bus %i, slot %i\n", thisboard->name,\r\ndevpriv->pci_dev->bus->number,\r\nPCI_SLOT(devpriv->pci_dev->devfn));\r\nif (comedi_pci_enable(pcidev, thisboard->name))\r\nreturn -EIO;\r\ndevpriv->dio_reg_base\r\n=\r\npci_resource_start(devpriv->pci_dev,\r\npcidio_boards[index].dioregs_badrindex);\r\nif (alloc_subdevices(dev, thisboard->n_8255) < 0)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < thisboard->n_8255; i++) {\r\nsubdev_8255_init(dev, dev->subdevices + i,\r\nNULL, devpriv->dio_reg_base + i * 4);\r\ndev_dbg(dev->hw_dev, "subdev %d: base = 0x%lx\n", i,\r\ndevpriv->dio_reg_base + i * 4);\r\n}\r\nreturn 1;\r\n}\r\nstatic int pcidio_detach(struct comedi_device *dev)\r\n{\r\nif (devpriv) {\r\nif (devpriv->pci_dev) {\r\nif (devpriv->dio_reg_base)\r\ncomedi_pci_disable(devpriv->pci_dev);\r\npci_dev_put(devpriv->pci_dev);\r\n}\r\n}\r\nif (dev->subdevices) {\r\nint i;\r\nfor (i = 0; i < thisboard->n_8255; i++)\r\nsubdev_8255_cleanup(dev, dev->subdevices + i);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit driver_cb_pcidio_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *ent)\r\n{\r\nreturn comedi_pci_auto_config(dev, driver_cb_pcidio.driver_name);\r\n}\r\nstatic void __devexit driver_cb_pcidio_pci_remove(struct pci_dev *dev)\r\n{\r\ncomedi_pci_auto_unconfig(dev);\r\n}\r\nstatic int __init driver_cb_pcidio_init_module(void)\r\n{\r\nint retval;\r\nretval = comedi_driver_register(&driver_cb_pcidio);\r\nif (retval < 0)\r\nreturn retval;\r\ndriver_cb_pcidio_pci_driver.name = (char *)driver_cb_pcidio.driver_name;\r\nreturn pci_register_driver(&driver_cb_pcidio_pci_driver);\r\n}\r\nstatic void __exit driver_cb_pcidio_cleanup_module(void)\r\n{\r\npci_unregister_driver(&driver_cb_pcidio_pci_driver);\r\ncomedi_driver_unregister(&driver_cb_pcidio);\r\n}

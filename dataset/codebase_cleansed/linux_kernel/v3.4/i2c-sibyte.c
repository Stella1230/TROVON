static int smbus_xfer(struct i2c_adapter *i2c_adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size, union i2c_smbus_data * data)\r\n{\r\nstruct i2c_algo_sibyte_data *adap = i2c_adap->algo_data;\r\nint data_bytes = 0;\r\nint error;\r\nwhile (csr_in32(SMB_CSR(adap, R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nswitch (size) {\r\ncase I2C_SMBUS_QUICK:\r\ncsr_out32((V_SMB_ADDR(addr) |\r\n(read_write == I2C_SMBUS_READ ? M_SMB_QDATA : 0) |\r\nV_SMB_TT_QUICKCMD), SMB_CSR(adap, R_SMB_START));\r\nbreak;\r\ncase I2C_SMBUS_BYTE:\r\nif (read_write == I2C_SMBUS_READ) {\r\ncsr_out32((V_SMB_ADDR(addr) | V_SMB_TT_RD1BYTE),\r\nSMB_CSR(adap, R_SMB_START));\r\ndata_bytes = 1;\r\n} else {\r\ncsr_out32(V_SMB_CMD(command), SMB_CSR(adap, R_SMB_CMD));\r\ncsr_out32((V_SMB_ADDR(addr) | V_SMB_TT_WR1BYTE),\r\nSMB_CSR(adap, R_SMB_START));\r\n}\r\nbreak;\r\ncase I2C_SMBUS_BYTE_DATA:\r\ncsr_out32(V_SMB_CMD(command), SMB_CSR(adap, R_SMB_CMD));\r\nif (read_write == I2C_SMBUS_READ) {\r\ncsr_out32((V_SMB_ADDR(addr) | V_SMB_TT_CMD_RD1BYTE),\r\nSMB_CSR(adap, R_SMB_START));\r\ndata_bytes = 1;\r\n} else {\r\ncsr_out32(V_SMB_LB(data->byte),\r\nSMB_CSR(adap, R_SMB_DATA));\r\ncsr_out32((V_SMB_ADDR(addr) | V_SMB_TT_WR2BYTE),\r\nSMB_CSR(adap, R_SMB_START));\r\n}\r\nbreak;\r\ncase I2C_SMBUS_WORD_DATA:\r\ncsr_out32(V_SMB_CMD(command), SMB_CSR(adap, R_SMB_CMD));\r\nif (read_write == I2C_SMBUS_READ) {\r\ncsr_out32((V_SMB_ADDR(addr) | V_SMB_TT_CMD_RD2BYTE),\r\nSMB_CSR(adap, R_SMB_START));\r\ndata_bytes = 2;\r\n} else {\r\ncsr_out32(V_SMB_LB(data->word & 0xff),\r\nSMB_CSR(adap, R_SMB_DATA));\r\ncsr_out32(V_SMB_MB(data->word >> 8),\r\nSMB_CSR(adap, R_SMB_DATA));\r\ncsr_out32((V_SMB_ADDR(addr) | V_SMB_TT_WR2BYTE),\r\nSMB_CSR(adap, R_SMB_START));\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EOPNOTSUPP;\r\n}\r\nwhile (csr_in32(SMB_CSR(adap, R_SMB_STATUS)) & M_SMB_BUSY)\r\n;\r\nerror = csr_in32(SMB_CSR(adap, R_SMB_STATUS));\r\nif (error & M_SMB_ERROR) {\r\ncsr_out32(M_SMB_ERROR, SMB_CSR(adap, R_SMB_STATUS));\r\nreturn (error & M_SMB_ERROR_TYPE) ? -EIO : -ENXIO;\r\n}\r\nif (data_bytes == 1)\r\ndata->byte = csr_in32(SMB_CSR(adap, R_SMB_DATA)) & 0xff;\r\nif (data_bytes == 2)\r\ndata->word = csr_in32(SMB_CSR(adap, R_SMB_DATA)) & 0xffff;\r\nreturn 0;\r\n}\r\nstatic u32 bit_func(struct i2c_adapter *adap)\r\n{\r\nreturn (I2C_FUNC_SMBUS_QUICK | I2C_FUNC_SMBUS_BYTE |\r\nI2C_FUNC_SMBUS_BYTE_DATA | I2C_FUNC_SMBUS_WORD_DATA);\r\n}\r\nstatic int __init i2c_sibyte_add_bus(struct i2c_adapter *i2c_adap, int speed)\r\n{\r\nstruct i2c_algo_sibyte_data *adap = i2c_adap->algo_data;\r\ni2c_adap->algo = &i2c_sibyte_algo;\r\ncsr_out32(speed, SMB_CSR(adap,R_SMB_FREQ));\r\ncsr_out32(0, SMB_CSR(adap,R_SMB_CONTROL));\r\nreturn i2c_add_numbered_adapter(i2c_adap);\r\n}\r\nstatic int __init i2c_sibyte_init(void)\r\n{\r\npr_info("i2c-sibyte: i2c SMBus adapter module for SiByte board\n");\r\nif (i2c_sibyte_add_bus(&sibyte_board_adapter[0], K_SMB_FREQ_100KHZ) < 0)\r\nreturn -ENODEV;\r\nif (i2c_sibyte_add_bus(&sibyte_board_adapter[1],\r\nK_SMB_FREQ_400KHZ) < 0) {\r\ni2c_del_adapter(&sibyte_board_adapter[0]);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit i2c_sibyte_exit(void)\r\n{\r\ni2c_del_adapter(&sibyte_board_adapter[0]);\r\ni2c_del_adapter(&sibyte_board_adapter[1]);\r\n}

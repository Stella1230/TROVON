static int labpc_attach(struct comedi_device *dev, struct comedi_devconfig *it)\r\n{\r\nunsigned long iobase = 0;\r\nunsigned int irq = 0;\r\nstruct pcmcia_device *link;\r\nif (alloc_private(dev, sizeof(struct labpc_private)) < 0)\r\nreturn -ENOMEM;\r\nswitch (thisboard->bustype) {\r\ncase pcmcia_bustype:\r\nlink = pcmcia_cur_dev;\r\nif (!link)\r\nreturn -EIO;\r\niobase = link->resource[0]->start;\r\nirq = link->irq;\r\nbreak;\r\ndefault:\r\npr_err("bug! couldn't determine board type\n");\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nreturn labpc_common_attach(dev, iobase, irq, 0);\r\n}\r\nstatic int labpc_cs_attach(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local;\r\ndev_dbg(&link->dev, "labpc_cs_attach()\n");\r\nlocal = kzalloc(sizeof(struct local_info_t), GFP_KERNEL);\r\nif (!local)\r\nreturn -ENOMEM;\r\nlocal->link = link;\r\nlink->priv = local;\r\npcmcia_cur_dev = link;\r\nlabpc_config(link);\r\nreturn 0;\r\n}\r\nstatic void labpc_cs_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "labpc_cs_detach\n");\r\n((struct local_info_t *)link->priv)->stop = 1;\r\nlabpc_release(link);\r\nkfree(link->priv);\r\n}\r\nstatic int labpc_pcmcia_config_loop(struct pcmcia_device *p_dev,\r\nvoid *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic void labpc_config(struct pcmcia_device *link)\r\n{\r\nint ret;\r\ndev_dbg(&link->dev, "labpc_config\n");\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_ENABLE_PULSE_IRQ |\r\nCONF_AUTO_AUDIO | CONF_AUTO_SET_IO;\r\nret = pcmcia_loop_config(link, labpc_pcmcia_config_loop, NULL);\r\nif (ret) {\r\ndev_warn(&link->dev, "no configuration found\n");\r\ngoto failed;\r\n}\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nreturn;\r\nfailed:\r\nlabpc_release(link);\r\n}\r\nstatic void labpc_release(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "labpc_release\n");\r\npcmcia_disable_device(link);\r\n}\r\nstatic int labpc_cs_suspend(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local = link->priv;\r\nlocal->stop = 1;\r\nreturn 0;\r\n}\r\nstatic int labpc_cs_resume(struct pcmcia_device *link)\r\n{\r\nstruct local_info_t *local = link->priv;\r\nlocal->stop = 0;\r\nreturn 0;\r\n}\r\nstatic int __init init_labpc_cs(void)\r\n{\r\npcmcia_register_driver(&labpc_cs_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit exit_labpc_cs(void)\r\n{\r\npcmcia_unregister_driver(&labpc_cs_driver);\r\n}\r\nint __init labpc_init_module(void)\r\n{\r\nint ret;\r\nret = init_labpc_cs();\r\nif (ret < 0)\r\nreturn ret;\r\nreturn comedi_driver_register(&driver_labpc_cs);\r\n}\r\nvoid __exit labpc_exit_module(void)\r\n{\r\nexit_labpc_cs();\r\ncomedi_driver_unregister(&driver_labpc_cs);\r\n}

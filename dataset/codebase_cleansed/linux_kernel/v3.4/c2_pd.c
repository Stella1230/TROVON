int c2_pd_alloc(struct c2_dev *c2dev, int privileged, struct c2_pd *pd)\r\n{\r\nu32 obj;\r\nint ret = 0;\r\nspin_lock(&c2dev->pd_table.lock);\r\nobj = find_next_zero_bit(c2dev->pd_table.table, c2dev->pd_table.max,\r\nc2dev->pd_table.last);\r\nif (obj >= c2dev->pd_table.max)\r\nobj = find_first_zero_bit(c2dev->pd_table.table,\r\nc2dev->pd_table.max);\r\nif (obj < c2dev->pd_table.max) {\r\npd->pd_id = obj;\r\n__set_bit(obj, c2dev->pd_table.table);\r\nc2dev->pd_table.last = obj+1;\r\nif (c2dev->pd_table.last >= c2dev->pd_table.max)\r\nc2dev->pd_table.last = 0;\r\n} else\r\nret = -ENOMEM;\r\nspin_unlock(&c2dev->pd_table.lock);\r\nreturn ret;\r\n}\r\nvoid c2_pd_free(struct c2_dev *c2dev, struct c2_pd *pd)\r\n{\r\nspin_lock(&c2dev->pd_table.lock);\r\n__clear_bit(pd->pd_id, c2dev->pd_table.table);\r\nspin_unlock(&c2dev->pd_table.lock);\r\n}\r\nint __devinit c2_init_pd_table(struct c2_dev *c2dev)\r\n{\r\nc2dev->pd_table.last = 0;\r\nc2dev->pd_table.max = c2dev->props.max_pd;\r\nspin_lock_init(&c2dev->pd_table.lock);\r\nc2dev->pd_table.table = kmalloc(BITS_TO_LONGS(c2dev->props.max_pd) *\r\nsizeof(long), GFP_KERNEL);\r\nif (!c2dev->pd_table.table)\r\nreturn -ENOMEM;\r\nbitmap_zero(c2dev->pd_table.table, c2dev->props.max_pd);\r\nreturn 0;\r\n}\r\nvoid __devexit c2_cleanup_pd_table(struct c2_dev *c2dev)\r\n{\r\nkfree(c2dev->pd_table.table);\r\n}

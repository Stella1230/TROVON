static int i2c_writebytes (struct or51211_state* state, u8 reg, const u8 *buf,\r\nint len)\r\n{\r\nint err;\r\nstruct i2c_msg msg;\r\nmsg.addr = reg;\r\nmsg.flags = 0;\r\nmsg.len = len;\r\nmsg.buf = (u8 *)buf;\r\nif ((err = i2c_transfer (state->i2c, &msg, 1)) != 1) {\r\nprintk(KERN_WARNING "or51211: i2c_writebytes error "\r\n"(addr %02x, err == %i)\n", reg, err);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int i2c_readbytes(struct or51211_state *state, u8 reg, u8 *buf, int len)\r\n{\r\nint err;\r\nstruct i2c_msg msg;\r\nmsg.addr = reg;\r\nmsg.flags = I2C_M_RD;\r\nmsg.len = len;\r\nmsg.buf = buf;\r\nif ((err = i2c_transfer (state->i2c, &msg, 1)) != 1) {\r\nprintk(KERN_WARNING "or51211: i2c_readbytes error "\r\n"(addr %02x, err == %i)\n", reg, err);\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int or51211_load_firmware (struct dvb_frontend* fe,\r\nconst struct firmware *fw)\r\n{\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nu8 tudata[585];\r\nint i;\r\ndprintk("Firmware is %zd bytes\n",fw->size);\r\ntudata[0] = 17;\r\nif (i2c_writebytes(state,0x50,tudata,1)) {\r\nprintk(KERN_WARNING "or51211:load_firmware error eprom addr\n");\r\nreturn -1;\r\n}\r\nif (i2c_readbytes(state,0x50,&tudata[145],192)) {\r\nprintk(KERN_WARNING "or51211: load_firmware error eprom\n");\r\nreturn -1;\r\n}\r\nfor (i = 0; i < 145; i++)\r\ntudata[i] = fw->data[i];\r\nfor (i = 0; i < 248; i++)\r\ntudata[i+337] = fw->data[145+i];\r\nstate->config->reset(fe);\r\nif (i2c_writebytes(state,state->config->demod_address,tudata,585)) {\r\nprintk(KERN_WARNING "or51211: load_firmware error 1\n");\r\nreturn -1;\r\n}\r\nmsleep(1);\r\nif (i2c_writebytes(state,state->config->demod_address,\r\n&fw->data[393],8125)) {\r\nprintk(KERN_WARNING "or51211: load_firmware error 2\n");\r\nreturn -1;\r\n}\r\nmsleep(1);\r\nif (i2c_writebytes(state,state->config->demod_address,run_buf,2)) {\r\nprintk(KERN_WARNING "or51211: load_firmware error 3\n");\r\nreturn -1;\r\n}\r\nmsleep(10);\r\nif (i2c_writebytes(state,state->config->demod_address,run_buf,2)) {\r\nprintk(KERN_WARNING "or51211: load_firmware error 4\n");\r\nreturn -1;\r\n}\r\nmsleep(10);\r\nprintk("or51211: Done.\n");\r\nreturn 0;\r\n}\r\nstatic int or51211_setmode(struct dvb_frontend* fe, int mode)\r\n{\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nu8 rec_buf[14];\r\nstate->config->setmode(fe, mode);\r\nif (i2c_writebytes(state,state->config->demod_address,run_buf,2)) {\r\nprintk(KERN_WARNING "or51211: setmode error 1\n");\r\nreturn -1;\r\n}\r\nmsleep(10);\r\nif (i2c_writebytes(state,state->config->demod_address,run_buf,2)) {\r\nprintk(KERN_WARNING "or51211: setmode error 2\n");\r\nreturn -1;\r\n}\r\nmsleep(10);\r\nif (i2c_writebytes(state,state->config->demod_address,cmd_buf,3)) {\r\nprintk(KERN_WARNING "or51211: setmode error 3\n");\r\nreturn -1;\r\n}\r\nrec_buf[0] = 0x04;\r\nrec_buf[1] = 0x00;\r\nrec_buf[2] = 0x03;\r\nrec_buf[3] = 0x00;\r\nmsleep(20);\r\nif (i2c_writebytes(state,state->config->demod_address,rec_buf,3)) {\r\nprintk(KERN_WARNING "or51211: setmode error 5\n");\r\n}\r\nmsleep(3);\r\nif (i2c_readbytes(state,state->config->demod_address,&rec_buf[10],2)) {\r\nprintk(KERN_WARNING "or51211: setmode error 6");\r\nreturn -1;\r\n}\r\ndprintk("setmode rec status %02x %02x\n",rec_buf[10],rec_buf[11]);\r\nreturn 0;\r\n}\r\nstatic int or51211_set_parameters(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nif (state->current_frequency != p->frequency) {\r\nif (fe->ops.tuner_ops.set_params) {\r\nfe->ops.tuner_ops.set_params(fe);\r\nif (fe->ops.i2c_gate_ctrl) fe->ops.i2c_gate_ctrl(fe, 0);\r\n}\r\nor51211_setmode(fe,0);\r\nstate->current_frequency = p->frequency;\r\n}\r\nreturn 0;\r\n}\r\nstatic int or51211_read_status(struct dvb_frontend* fe, fe_status_t* status)\r\n{\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nunsigned char rec_buf[2];\r\nunsigned char snd_buf[] = {0x04,0x00,0x03,0x00};\r\n*status = 0;\r\nif (i2c_writebytes(state,state->config->demod_address,snd_buf,3)) {\r\nprintk(KERN_WARNING "or51132: read_status write error\n");\r\nreturn -1;\r\n}\r\nmsleep(3);\r\nif (i2c_readbytes(state,state->config->demod_address,rec_buf,2)) {\r\nprintk(KERN_WARNING "or51132: read_status read error\n");\r\nreturn -1;\r\n}\r\ndprintk("read_status %x %x\n",rec_buf[0],rec_buf[1]);\r\nif (rec_buf[0] & 0x01) {\r\n*status |= FE_HAS_SIGNAL;\r\n*status |= FE_HAS_CARRIER;\r\n*status |= FE_HAS_VITERBI;\r\n*status |= FE_HAS_SYNC;\r\n*status |= FE_HAS_LOCK;\r\n}\r\nreturn 0;\r\n}\r\nstatic u32 calculate_snr(u32 mse, u32 c)\r\n{\r\nif (mse == 0)\r\nreturn 0;\r\nmse = 2*intlog10(mse);\r\nif (mse > c) {\r\nreturn 0;\r\n}\r\nreturn 10*(c - mse);\r\n}\r\nstatic int or51211_read_snr(struct dvb_frontend* fe, u16* snr)\r\n{\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nu8 rec_buf[2];\r\nu8 snd_buf[3];\r\nsnd_buf[0] = 0x04;\r\nsnd_buf[1] = 0x00;\r\nsnd_buf[2] = 0x04;\r\nif (i2c_writebytes(state,state->config->demod_address,snd_buf,3)) {\r\nprintk(KERN_WARNING "%s: error writing snr reg\n",\r\n__func__);\r\nreturn -1;\r\n}\r\nif (i2c_readbytes(state,state->config->demod_address,rec_buf,2)) {\r\nprintk(KERN_WARNING "%s: read_status read error\n",\r\n__func__);\r\nreturn -1;\r\n}\r\nstate->snr = calculate_snr(rec_buf[0], 89599047);\r\n*snr = (state->snr) >> 16;\r\ndprintk("%s: noise = 0x%02x, snr = %d.%02d dB\n", __func__, rec_buf[0],\r\nstate->snr >> 24, (((state->snr>>8) & 0xffff) * 100) >> 16);\r\nreturn 0;\r\n}\r\nstatic int or51211_read_signal_strength(struct dvb_frontend* fe, u16* strength)\r\n{\r\nstruct or51211_state* state = (struct or51211_state*)fe->demodulator_priv;\r\nu16 snr;\r\nint ret;\r\nret = fe->ops.read_snr(fe, &snr);\r\nif (ret != 0)\r\nreturn ret;\r\nif (state->snr >= 8960 * 0x10000)\r\n*strength = 0xffff;\r\nelse\r\n*strength = state->snr / 8960;\r\nreturn 0;\r\n}\r\nstatic int or51211_read_ber(struct dvb_frontend* fe, u32* ber)\r\n{\r\n*ber = -ENOSYS;\r\nreturn 0;\r\n}\r\nstatic int or51211_read_ucblocks(struct dvb_frontend* fe, u32* ucblocks)\r\n{\r\n*ucblocks = -ENOSYS;\r\nreturn 0;\r\n}\r\nstatic int or51211_sleep(struct dvb_frontend* fe)\r\n{\r\nreturn 0;\r\n}\r\nstatic int or51211_init(struct dvb_frontend* fe)\r\n{\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nconst struct or51211_config* config = state->config;\r\nconst struct firmware* fw;\r\nunsigned char get_ver_buf[] = {0x04,0x00,0x30,0x00,0x00};\r\nunsigned char rec_buf[14];\r\nint ret,i;\r\nif (!state->initialized) {\r\nprintk(KERN_INFO "or51211: Waiting for firmware upload "\r\n"(%s)...\n", OR51211_DEFAULT_FIRMWARE);\r\nret = config->request_firmware(fe, &fw,\r\nOR51211_DEFAULT_FIRMWARE);\r\nprintk(KERN_INFO "or51211:Got Hotplug firmware\n");\r\nif (ret) {\r\nprintk(KERN_WARNING "or51211: No firmware uploaded "\r\n"(timeout or file not found?)\n");\r\nreturn ret;\r\n}\r\nret = or51211_load_firmware(fe, fw);\r\nrelease_firmware(fw);\r\nif (ret) {\r\nprintk(KERN_WARNING "or51211: Writing firmware to "\r\n"device failed!\n");\r\nreturn ret;\r\n}\r\nprintk(KERN_INFO "or51211: Firmware upload complete.\n");\r\nif (i2c_writebytes(state,state->config->demod_address,\r\ncmd_buf,3)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error 5\n");\r\nreturn -1;\r\n}\r\nrec_buf[0] = 0x04;\r\nrec_buf[1] = 0x00;\r\nrec_buf[2] = 0x03;\r\nrec_buf[3] = 0x00;\r\nmsleep(30);\r\nif (i2c_writebytes(state,state->config->demod_address,\r\nrec_buf,3)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error A\n");\r\nreturn -1;\r\n}\r\nmsleep(3);\r\nif (i2c_readbytes(state,state->config->demod_address,\r\n&rec_buf[10],2)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error B\n");\r\nreturn -1;\r\n}\r\nrec_buf[0] = 0x04;\r\nrec_buf[1] = 0x00;\r\nrec_buf[2] = 0x01;\r\nrec_buf[3] = 0x00;\r\nmsleep(20);\r\nif (i2c_writebytes(state,state->config->demod_address,\r\nrec_buf,3)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error C\n");\r\nreturn -1;\r\n}\r\nmsleep(3);\r\nif (i2c_readbytes(state,state->config->demod_address,\r\n&rec_buf[12],2)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error D\n");\r\nreturn -1;\r\n}\r\nfor (i = 0; i < 8; i++)\r\nrec_buf[i]=0xed;\r\nfor (i = 0; i < 5; i++) {\r\nmsleep(30);\r\nget_ver_buf[4] = i+1;\r\nif (i2c_writebytes(state,state->config->demod_address,\r\nget_ver_buf,5)) {\r\nprintk(KERN_WARNING "or51211:Load DVR Error 6"\r\n" - %d\n",i);\r\nreturn -1;\r\n}\r\nmsleep(3);\r\nif (i2c_readbytes(state,state->config->demod_address,\r\n&rec_buf[i*2],2)) {\r\nprintk(KERN_WARNING "or51211:Load DVR Error 7"\r\n" - %d\n",i);\r\nreturn -1;\r\n}\r\nif ((int)rec_buf[i*2+1]!=i+1){\r\ni--;\r\n}\r\n}\r\ndprintk("read_fwbits %x %x %x %x %x %x %x %x %x %x\n",\r\nrec_buf[0], rec_buf[1], rec_buf[2], rec_buf[3],\r\nrec_buf[4], rec_buf[5], rec_buf[6], rec_buf[7],\r\nrec_buf[8], rec_buf[9]);\r\nprintk(KERN_INFO "or51211: ver TU%02x%02x%02x VSB mode %02x"\r\n" Status %02x\n",\r\nrec_buf[2], rec_buf[4],rec_buf[6],\r\nrec_buf[12],rec_buf[10]);\r\nrec_buf[0] = 0x04;\r\nrec_buf[1] = 0x00;\r\nrec_buf[2] = 0x03;\r\nrec_buf[3] = 0x00;\r\nmsleep(20);\r\nif (i2c_writebytes(state,state->config->demod_address,\r\nrec_buf,3)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error 8\n");\r\nreturn -1;\r\n}\r\nmsleep(20);\r\nif (i2c_readbytes(state,state->config->demod_address,\r\n&rec_buf[8],2)) {\r\nprintk(KERN_WARNING "or51211: Load DVR Error 9\n");\r\nreturn -1;\r\n}\r\nstate->initialized = 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int or51211_get_tune_settings(struct dvb_frontend* fe,\r\nstruct dvb_frontend_tune_settings* fesettings)\r\n{\r\nfesettings->min_delay_ms = 500;\r\nfesettings->step_size = 0;\r\nfesettings->max_drift = 0;\r\nreturn 0;\r\n}\r\nstatic void or51211_release(struct dvb_frontend* fe)\r\n{\r\nstruct or51211_state* state = fe->demodulator_priv;\r\nstate->config->sleep(fe);\r\nkfree(state);\r\n}\r\nstruct dvb_frontend* or51211_attach(const struct or51211_config* config,\r\nstruct i2c_adapter* i2c)\r\n{\r\nstruct or51211_state* state = NULL;\r\nstate = kzalloc(sizeof(struct or51211_state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn NULL;\r\nstate->config = config;\r\nstate->i2c = i2c;\r\nstate->initialized = 0;\r\nstate->current_frequency = 0;\r\nmemcpy(&state->frontend.ops, &or51211_ops, sizeof(struct dvb_frontend_ops));\r\nstate->frontend.demodulator_priv = state;\r\nreturn &state->frontend;\r\n}

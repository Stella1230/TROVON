static int ce4100_i8042_detect(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic unsigned int mem_serial_in(struct uart_port *p, int offset)\r\n{\r\noffset = offset << p->regshift;\r\nreturn readl(p->membase + offset);\r\n}\r\nstatic unsigned int ce4100_mem_serial_in(struct uart_port *p, int offset)\r\n{\r\nunsigned int ret, ier, lsr;\r\nif (offset == UART_IIR) {\r\noffset = offset << p->regshift;\r\nret = readl(p->membase + offset);\r\nif (ret & UART_IIR_NO_INT) {\r\nier = mem_serial_in(p, UART_IER);\r\nif (ier & UART_IER_THRI) {\r\nlsr = mem_serial_in(p, UART_LSR);\r\nif (lsr & (UART_LSR_THRE | UART_LSR_TEMT))\r\nret &= ~UART_IIR_NO_INT;\r\n}\r\n}\r\n} else\r\nret = mem_serial_in(p, offset);\r\nreturn ret;\r\n}\r\nstatic void ce4100_mem_serial_out(struct uart_port *p, int offset, int value)\r\n{\r\noffset = offset << p->regshift;\r\nwritel(value, p->membase + offset);\r\n}\r\nstatic void ce4100_serial_fixup(int port, struct uart_port *up,\r\nunsigned short *capabilites)\r\n{\r\n#ifdef CONFIG_EARLY_PRINTK\r\nif (up->iotype != UPIO_MEM32) {\r\nup->uartclk = 14745600;\r\nup->mapbase = 0xdffe0200;\r\nset_fixmap_nocache(FIX_EARLYCON_MEM_BASE,\r\nup->mapbase & PAGE_MASK);\r\nup->membase =\r\n(void __iomem *)__fix_to_virt(FIX_EARLYCON_MEM_BASE);\r\nup->membase += up->mapbase & ~PAGE_MASK;\r\nup->iotype = UPIO_MEM32;\r\nup->regshift = 2;\r\n}\r\n#endif\r\nup->iobase = 0;\r\nup->serial_in = ce4100_mem_serial_in;\r\nup->serial_out = ce4100_mem_serial_out;\r\n*capabilites |= (1 << 12);\r\n}\r\nstatic __init void sdv_serial_fixup(void)\r\n{\r\nserial8250_set_isa_configurator(ce4100_serial_fixup);\r\n}\r\nstatic inline void sdv_serial_fixup(void) {}\r\nstatic void __init sdv_arch_setup(void)\r\n{\r\nsdv_serial_fixup();\r\n}\r\nstatic void __cpuinit sdv_pci_init(void)\r\n{\r\nx86_of_pci_init();\r\nlegacy_pic = &null_legacy_pic;\r\n}\r\nvoid __init x86_ce4100_early_setup(void)\r\n{\r\nx86_init.oem.arch_setup = sdv_arch_setup;\r\nx86_platform.i8042_detect = ce4100_i8042_detect;\r\nx86_init.resources.probe_roms = x86_init_noop;\r\nx86_init.mpparse.get_smp_config = x86_init_uint_noop;\r\nx86_init.mpparse.find_smp_config = x86_init_noop;\r\nx86_init.pci.init = ce4100_pci_init;\r\n#ifdef CONFIG_X86_IO_APIC\r\nx86_init.pci.init_irq = sdv_pci_init;\r\nx86_init.mpparse.setup_ioapic_ids = setup_ioapic_ids_from_mpc_nocheck;\r\n#endif\r\n}

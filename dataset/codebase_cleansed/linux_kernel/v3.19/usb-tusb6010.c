static int tusb_set_async_mode(unsigned sysclk_ps)\r\n{\r\nstruct gpmc_device_timings dev_t;\r\nstruct gpmc_timings t;\r\nunsigned t_acsnh_advnh = sysclk_ps + 3000;\r\nmemset(&dev_t, 0, sizeof(dev_t));\r\ndev_t.t_ceasu = 8 * 1000;\r\ndev_t.t_avdasu = t_acsnh_advnh - 7000;\r\ndev_t.t_ce_avd = 1000;\r\ndev_t.t_avdp_r = t_acsnh_advnh;\r\ndev_t.t_oeasu = t_acsnh_advnh + 1000;\r\ndev_t.t_oe = 300;\r\ndev_t.t_cez_r = 7000;\r\ndev_t.t_cez_w = dev_t.t_cez_r;\r\ndev_t.t_avdp_w = t_acsnh_advnh;\r\ndev_t.t_weasu = t_acsnh_advnh + 1000;\r\ndev_t.t_wpl = 300;\r\ndev_t.cyc_aavdh_we = 1;\r\ngpmc_calc_timings(&t, &tusb_async, &dev_t);\r\nreturn gpmc_cs_set_timings(async_cs, &t);\r\n}\r\nstatic int tusb_set_sync_mode(unsigned sysclk_ps)\r\n{\r\nstruct gpmc_device_timings dev_t;\r\nstruct gpmc_timings t;\r\nunsigned t_scsnh_advnh = sysclk_ps + 3000;\r\nmemset(&dev_t, 0, sizeof(dev_t));\r\ndev_t.clk = 11100;\r\ndev_t.t_bacc = 1000;\r\ndev_t.t_ces = 1000;\r\ndev_t.t_ceasu = 8 * 1000;\r\ndev_t.t_avdasu = t_scsnh_advnh - 7000;\r\ndev_t.t_ce_avd = 1000;\r\ndev_t.t_avdp_r = t_scsnh_advnh;\r\ndev_t.cyc_aavdh_oe = 3;\r\ndev_t.cyc_oe = 5;\r\ndev_t.t_ce_rdyz = 7000;\r\ndev_t.t_avdp_w = t_scsnh_advnh;\r\ndev_t.cyc_aavdh_we = 3;\r\ndev_t.cyc_wpl = 6;\r\ngpmc_calc_timings(&t, &tusb_sync, &dev_t);\r\nreturn gpmc_cs_set_timings(sync_cs, &t);\r\n}\r\nint tusb6010_platform_retime(unsigned is_refclk)\r\n{\r\nstatic const char error[] =\r\nKERN_ERR "tusb6010 %s retime error %d\n";\r\nunsigned sysclk_ps;\r\nint status;\r\nif (!refclk_psec)\r\nreturn -ENODEV;\r\nsysclk_ps = is_refclk ? refclk_psec : TUSB6010_OSCCLK_60;\r\nstatus = tusb_set_async_mode(sysclk_ps);\r\nif (status < 0) {\r\nprintk(error, "async", status);\r\ngoto done;\r\n}\r\nstatus = tusb_set_sync_mode(sysclk_ps);\r\nif (status < 0)\r\nprintk(error, "sync", status);\r\ndone:\r\nreturn status;\r\n}\r\nint __init\r\ntusb6010_setup_interface(struct musb_hdrc_platform_data *data,\r\nunsigned ps_refclk, unsigned waitpin,\r\nunsigned async, unsigned sync,\r\nunsigned irq, unsigned dmachan)\r\n{\r\nint status;\r\nstatic char error[] __initdata =\r\nKERN_ERR "tusb6010 init error %d, %d\n";\r\nstatus = gpmc_cs_request(async, SZ_16M, (unsigned long *)\r\n&tusb_resources[0].start);\r\nif (status < 0) {\r\nprintk(error, 1, status);\r\nreturn status;\r\n}\r\ntusb_resources[0].end = tusb_resources[0].start + 0x9ff;\r\ntusb_async.wait_pin = waitpin;\r\nasync_cs = async;\r\nstatus = gpmc_cs_program_settings(async_cs, &tusb_async);\r\nif (status < 0)\r\nreturn status;\r\nstatus = gpmc_cs_request(sync, SZ_16M, (unsigned long *)\r\n&tusb_resources[1].start);\r\nif (status < 0) {\r\nprintk(error, 2, status);\r\nreturn status;\r\n}\r\ntusb_resources[1].end = tusb_resources[1].start + 0x9ff;\r\ntusb_sync.wait_pin = waitpin;\r\nsync_cs = sync;\r\nstatus = gpmc_cs_program_settings(sync_cs, &tusb_sync);\r\nif (status < 0)\r\nreturn status;\r\nstatus = gpio_request_one(irq, GPIOF_IN, "TUSB6010 irq");\r\nif (status < 0) {\r\nprintk(error, 3, status);\r\nreturn status;\r\n}\r\ntusb_resources[2].start = gpio_to_irq(irq);\r\nif (!ps_refclk) {\r\nprintk(error, 4, status);\r\nreturn -ENODEV;\r\n}\r\nrefclk_psec = ps_refclk;\r\nstatus = tusb6010_platform_retime(1);\r\nif (status < 0) {\r\nprintk(error, 5, status);\r\nreturn status;\r\n}\r\nif (!data) {\r\nprintk(error, 6, status);\r\nreturn -ENODEV;\r\n}\r\ntusb_device.dev.platform_data = data;\r\nif (!dmachan)\r\ntusb_device.dev.dma_mask = NULL;\r\nelse {\r\nif (dmachan & (1 << 0))\r\nomap_mux_init_signal("sys_ndmareq0", 0);\r\nif (dmachan & (1 << 1))\r\nomap_mux_init_signal("sys_ndmareq1", 0);\r\nif (dmachan & (1 << 2))\r\nomap_mux_init_signal("sys_ndmareq2", 0);\r\nif (dmachan & (1 << 3))\r\nomap_mux_init_signal("sys_ndmareq3", 0);\r\nif (dmachan & (1 << 4))\r\nomap_mux_init_signal("sys_ndmareq4", 0);\r\nif (dmachan & (1 << 5))\r\nomap_mux_init_signal("sys_ndmareq5", 0);\r\n}\r\nstatus = platform_device_register(&tusb_device);\r\nif (status < 0) {\r\nprintk(error, 7, status);\r\nreturn status;\r\n}\r\nreturn 0;\r\n}

static int __init ext_uart_init(void)\r\n{\r\nif (!machine_is_voiceblue())\r\nreturn -ENODEV;\r\nvoiceblue_ports[0].irq = gpio_to_irq(12);\r\nvoiceblue_ports[1].irq = gpio_to_irq(13);\r\nvoiceblue_ports[2].irq = gpio_to_irq(14);\r\nvoiceblue_ports[3].irq = gpio_to_irq(15);\r\nserial_device.dev.platform_data = voiceblue_ports;\r\nreturn platform_device_register(&serial_device);\r\n}\r\nstatic int panic_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nif (test_and_set_bit(MACHINE_PANICED, &machine_state))\r\nreturn NOTIFY_DONE;\r\nomap_writeb(0x78, OMAP_LPG1_LCR);\r\nomap_writeb(0x01, OMAP_LPG1_PMR);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init voiceblue_setup(void)\r\n{\r\nif (!machine_is_voiceblue())\r\nreturn -ENODEV;\r\natomic_notifier_chain_register(&panic_notifier_list, &panic_block);\r\nreturn 0;\r\n}\r\nvoid voiceblue_wdt_enable(void)\r\n{\r\ngpio_direction_output(0, 0);\r\ngpio_set_value(0, 1);\r\ngpio_set_value(0, 0);\r\nwdt_gpio_state = 0;\r\n}\r\nvoid voiceblue_wdt_disable(void)\r\n{\r\ngpio_set_value(0, 0);\r\ngpio_set_value(0, 1);\r\ngpio_set_value(0, 0);\r\ngpio_direction_input(0);\r\n}\r\nvoid voiceblue_wdt_ping(void)\r\n{\r\nif (test_bit(MACHINE_REBOOT, &machine_state))\r\nreturn;\r\nwdt_gpio_state = !wdt_gpio_state;\r\ngpio_set_value(0, wdt_gpio_state);\r\n}\r\nstatic void voiceblue_restart(enum reboot_mode mode, const char *cmd)\r\n{\r\nif (cpu_is_omap5912()) {\r\nomap_writew(omap_readw(DPLL_CTL) & ~(1 << 4), DPLL_CTL);\r\nomap_writew(0x8, ARM_RSTCT1);\r\n}\r\nset_bit(MACHINE_REBOOT, &machine_state);\r\nvoiceblue_wdt_enable();\r\nwhile (1) ;\r\n}\r\nstatic void __init voiceblue_init(void)\r\n{\r\nomap_cfg_reg(UART1_TX);\r\nomap_cfg_reg(UART1_RTS);\r\nomap_cfg_reg(UART2_TX);\r\nomap_cfg_reg(UART2_RTS);\r\nomap_cfg_reg(UART3_TX);\r\nomap_cfg_reg(UART3_RX);\r\ngpio_request(0, "Watchdog");\r\ngpio_request(7, "SMC91x reset");\r\ngpio_direction_output(7, 1);\r\nudelay(2);\r\ngpio_set_value(7, 0);\r\nmdelay(50);\r\ngpio_request(8, "SMC91x irq");\r\ngpio_request(6, "16C554 reset");\r\ngpio_direction_output(6, 0);\r\ngpio_request(12, "16C554 irq");\r\ngpio_request(13, "16C554 irq");\r\ngpio_request(14, "16C554 irq");\r\ngpio_request(15, "16C554 irq");\r\nirq_set_irq_type(gpio_to_irq(12), IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(gpio_to_irq(13), IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(gpio_to_irq(14), IRQ_TYPE_EDGE_RISING);\r\nirq_set_irq_type(gpio_to_irq(15), IRQ_TYPE_EDGE_RISING);\r\nvoiceblue_smc91x_resources[1].start = gpio_to_irq(8);\r\nvoiceblue_smc91x_resources[1].end = gpio_to_irq(8);\r\nplatform_add_devices(voiceblue_devices, ARRAY_SIZE(voiceblue_devices));\r\nomap_serial_init();\r\nomap1_usb_init(&voiceblue_usb_config);\r\nomap_register_i2c_bus(1, 100, NULL, 0);\r\nomap_writeb(0x00, OMAP_LPG1_LCR);\r\nomap_writeb(0x00, OMAP_LPG1_PMR);\r\n}

static void cvm_oct_sgmii_poll(struct net_device *dev)\r\n{\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\ncvmx_helper_link_info_t link_info;\r\nlink_info = cvmx_helper_link_get(priv->port);\r\nif (link_info.u64 == priv->link_info)\r\nreturn;\r\nlink_info = cvmx_helper_link_autoconf(priv->port);\r\npriv->link_info = link_info.u64;\r\nif (link_info.s.link_up) {\r\nif (!netif_carrier_ok(dev))\r\nnetif_carrier_on(dev);\r\nif (priv->queue != -1)\r\nprintk_ratelimited\r\n("%s: %u Mbps %s duplex, port %2d, queue %2d\n",\r\ndev->name, link_info.s.speed,\r\n(link_info.s.full_duplex) ? "Full" : "Half",\r\npriv->port, priv->queue);\r\nelse\r\nprintk_ratelimited\r\n("%s: %u Mbps %s duplex, port %2d, POW\n",\r\ndev->name, link_info.s.speed,\r\n(link_info.s.full_duplex) ? "Full" : "Half",\r\npriv->port);\r\n} else {\r\nif (netif_carrier_ok(dev))\r\nnetif_carrier_off(dev);\r\nprintk_ratelimited("%s: Link down\n", dev->name);\r\n}\r\n}\r\nint cvm_oct_sgmii_open(struct net_device *dev)\r\n{\r\nunion cvmx_gmxx_prtx_cfg gmx_cfg;\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nint interface = INTERFACE(priv->port);\r\nint index = INDEX(priv->port);\r\ncvmx_helper_link_info_t link_info;\r\nint rv;\r\nrv = cvm_oct_phy_setup_device(dev);\r\nif (rv)\r\nreturn rv;\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\ngmx_cfg.s.en = 1;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmx_cfg.u64);\r\nif (octeon_is_simulation())\r\nreturn 0;\r\nif (priv->phydev) {\r\nint r = phy_read_status(priv->phydev);\r\nif (r == 0 && priv->phydev->link == 0)\r\nnetif_carrier_off(dev);\r\ncvm_oct_adjust_link(dev);\r\n} else {\r\nlink_info = cvmx_helper_link_get(priv->port);\r\nif (!link_info.s.link_up)\r\nnetif_carrier_off(dev);\r\npriv->poll = cvm_oct_sgmii_poll;\r\ncvm_oct_sgmii_poll(dev);\r\n}\r\nreturn 0;\r\n}\r\nint cvm_oct_sgmii_stop(struct net_device *dev)\r\n{\r\nunion cvmx_gmxx_prtx_cfg gmx_cfg;\r\nstruct octeon_ethernet *priv = netdev_priv(dev);\r\nint interface = INTERFACE(priv->port);\r\nint index = INDEX(priv->port);\r\ngmx_cfg.u64 = cvmx_read_csr(CVMX_GMXX_PRTX_CFG(index, interface));\r\ngmx_cfg.s.en = 0;\r\ncvmx_write_csr(CVMX_GMXX_PRTX_CFG(index, interface), gmx_cfg.u64);\r\nreturn cvm_oct_common_stop(dev);\r\n}\r\nint cvm_oct_sgmii_init(struct net_device *dev)\r\n{\r\ncvm_oct_common_init(dev);\r\ndev->netdev_ops->ndo_stop(dev);\r\nreturn 0;\r\n}\r\nvoid cvm_oct_sgmii_uninit(struct net_device *dev)\r\n{\r\ncvm_oct_common_uninit(dev);\r\n}

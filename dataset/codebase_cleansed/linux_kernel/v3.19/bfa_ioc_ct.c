void\r\nbfa_nw_ioc_set_ct_hwif(struct bfa_ioc *ioc)\r\n{\r\nioc->ioc_hwif = &nw_hwif_ct;\r\n}\r\nvoid\r\nbfa_nw_ioc_set_ct2_hwif(struct bfa_ioc *ioc)\r\n{\r\nioc->ioc_hwif = &nw_hwif_ct2;\r\n}\r\nstatic bool\r\nbfa_ioc_ct_firmware_lock(struct bfa_ioc *ioc)\r\n{\r\nenum bfi_ioc_state ioc_fwstate;\r\nu32 usecnt;\r\nstruct bfi_ioc_image_hdr fwhdr;\r\nif (bfa_cb_image_get_size(bfa_ioc_asic_gen(ioc)) <\r\nBFA_IOC_FWIMG_MINSZ)\r\nreturn true;\r\nbfa_nw_ioc_sem_get(ioc->ioc_regs.ioc_usage_sem_reg);\r\nusecnt = readl(ioc->ioc_regs.ioc_usage_reg);\r\nif (usecnt == 0) {\r\nwritel(1, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nwritel(0, ioc->ioc_regs.ioc_fail_sync);\r\nreturn true;\r\n}\r\nioc_fwstate = readl(ioc->ioc_regs.ioc_fwstate);\r\nBUG_ON(!(ioc_fwstate != BFI_IOC_UNINIT));\r\nbfa_nw_ioc_fwver_get(ioc, &fwhdr);\r\nif (!bfa_nw_ioc_fwver_cmp(ioc, &fwhdr)) {\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nreturn false;\r\n}\r\nusecnt++;\r\nwritel(usecnt, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nreturn true;\r\n}\r\nstatic void\r\nbfa_ioc_ct_firmware_unlock(struct bfa_ioc *ioc)\r\n{\r\nu32 usecnt;\r\nif (bfa_cb_image_get_size(bfa_ioc_asic_gen(ioc)) <\r\nBFA_IOC_FWIMG_MINSZ)\r\nreturn;\r\nbfa_nw_ioc_sem_get(ioc->ioc_regs.ioc_usage_sem_reg);\r\nusecnt = readl(ioc->ioc_regs.ioc_usage_reg);\r\nBUG_ON(!(usecnt > 0));\r\nusecnt--;\r\nwritel(usecnt, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\n}\r\nstatic void\r\nbfa_ioc_ct_notify_fail(struct bfa_ioc *ioc)\r\n{\r\nwritel(__FW_INIT_HALT_P, ioc->ioc_regs.ll_halt);\r\nwritel(__FW_INIT_HALT_P, ioc->ioc_regs.alt_ll_halt);\r\nreadl(ioc->ioc_regs.ll_halt);\r\nreadl(ioc->ioc_regs.alt_ll_halt);\r\n}\r\nstatic void\r\nbfa_ioc_ct_reg_init(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb;\r\nint pcifn = bfa_ioc_pcifn(ioc);\r\nrb = bfa_ioc_bar0(ioc);\r\nioc->ioc_regs.hfn_mbox = rb + ct_fnreg[pcifn].hfn_mbox;\r\nioc->ioc_regs.lpu_mbox = rb + ct_fnreg[pcifn].lpu_mbox;\r\nioc->ioc_regs.host_page_num_fn = rb + ct_fnreg[pcifn].hfn_pgn;\r\nif (ioc->port_id == 0) {\r\nioc->ioc_regs.heartbeat = rb + BFA_IOC0_HBEAT_REG;\r\nioc->ioc_regs.ioc_fwstate = rb + BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.alt_ioc_fwstate = rb + BFA_IOC1_STATE_REG;\r\nioc->ioc_regs.hfn_mbox_cmd = rb + ct_p0reg[pcifn].hfn;\r\nioc->ioc_regs.lpu_mbox_cmd = rb + ct_p0reg[pcifn].lpu;\r\nioc->ioc_regs.ll_halt = rb + FW_INIT_HALT_P0;\r\nioc->ioc_regs.alt_ll_halt = rb + FW_INIT_HALT_P1;\r\n} else {\r\nioc->ioc_regs.heartbeat = rb + BFA_IOC1_HBEAT_REG;\r\nioc->ioc_regs.ioc_fwstate = rb + BFA_IOC1_STATE_REG;\r\nioc->ioc_regs.alt_ioc_fwstate = rb + BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.hfn_mbox_cmd = rb + ct_p1reg[pcifn].hfn;\r\nioc->ioc_regs.lpu_mbox_cmd = rb + ct_p1reg[pcifn].lpu;\r\nioc->ioc_regs.ll_halt = rb + FW_INIT_HALT_P1;\r\nioc->ioc_regs.alt_ll_halt = rb + FW_INIT_HALT_P0;\r\n}\r\nioc->ioc_regs.pss_ctl_reg = rb + PSS_CTL_REG;\r\nioc->ioc_regs.pss_err_status_reg = rb + PSS_ERR_STATUS_REG;\r\nioc->ioc_regs.app_pll_fast_ctl_reg = rb + APP_PLL_LCLK_CTL_REG;\r\nioc->ioc_regs.app_pll_slow_ctl_reg = rb + APP_PLL_SCLK_CTL_REG;\r\nioc->ioc_regs.ioc_sem_reg = rb + HOST_SEM0_REG;\r\nioc->ioc_regs.ioc_usage_sem_reg = rb + HOST_SEM1_REG;\r\nioc->ioc_regs.ioc_init_sem_reg = rb + HOST_SEM2_REG;\r\nioc->ioc_regs.ioc_usage_reg = rb + BFA_FW_USE_COUNT;\r\nioc->ioc_regs.ioc_fail_sync = rb + BFA_IOC_FAIL_SYNC;\r\nioc->ioc_regs.smem_page_start = rb + PSS_SMEM_PAGE_START;\r\nioc->ioc_regs.smem_pg0 = BFI_IOC_SMEM_PG0_CT;\r\nioc->ioc_regs.err_set = (rb + ERR_SET_REG);\r\n}\r\nstatic void\r\nbfa_ioc_ct2_reg_init(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb;\r\nint port = bfa_ioc_portid(ioc);\r\nrb = bfa_ioc_bar0(ioc);\r\nioc->ioc_regs.hfn_mbox = rb + ct2_reg[port].hfn_mbox;\r\nioc->ioc_regs.lpu_mbox = rb + ct2_reg[port].lpu_mbox;\r\nioc->ioc_regs.host_page_num_fn = rb + ct2_reg[port].hfn_pgn;\r\nioc->ioc_regs.hfn_mbox_cmd = rb + ct2_reg[port].hfn;\r\nioc->ioc_regs.lpu_mbox_cmd = rb + ct2_reg[port].lpu;\r\nioc->ioc_regs.lpu_read_stat = rb + ct2_reg[port].lpu_read;\r\nif (port == 0) {\r\nioc->ioc_regs.heartbeat = rb + CT2_BFA_IOC0_HBEAT_REG;\r\nioc->ioc_regs.ioc_fwstate = rb + CT2_BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.alt_ioc_fwstate = rb + CT2_BFA_IOC1_STATE_REG;\r\nioc->ioc_regs.ll_halt = rb + FW_INIT_HALT_P0;\r\nioc->ioc_regs.alt_ll_halt = rb + FW_INIT_HALT_P1;\r\n} else {\r\nioc->ioc_regs.heartbeat = rb + CT2_BFA_IOC1_HBEAT_REG;\r\nioc->ioc_regs.ioc_fwstate = rb + CT2_BFA_IOC1_STATE_REG;\r\nioc->ioc_regs.alt_ioc_fwstate = rb + CT2_BFA_IOC0_STATE_REG;\r\nioc->ioc_regs.ll_halt = rb + FW_INIT_HALT_P1;\r\nioc->ioc_regs.alt_ll_halt = rb + FW_INIT_HALT_P0;\r\n}\r\nioc->ioc_regs.pss_ctl_reg = rb + PSS_CTL_REG;\r\nioc->ioc_regs.pss_err_status_reg = rb + PSS_ERR_STATUS_REG;\r\nioc->ioc_regs.app_pll_fast_ctl_reg = rb + CT2_APP_PLL_LCLK_CTL_REG;\r\nioc->ioc_regs.app_pll_slow_ctl_reg = rb + CT2_APP_PLL_SCLK_CTL_REG;\r\nioc->ioc_regs.ioc_sem_reg = rb + CT2_HOST_SEM0_REG;\r\nioc->ioc_regs.ioc_usage_sem_reg = rb + CT2_HOST_SEM1_REG;\r\nioc->ioc_regs.ioc_init_sem_reg = rb + CT2_HOST_SEM2_REG;\r\nioc->ioc_regs.ioc_usage_reg = rb + CT2_BFA_FW_USE_COUNT;\r\nioc->ioc_regs.ioc_fail_sync = rb + CT2_BFA_IOC_FAIL_SYNC;\r\nioc->ioc_regs.smem_page_start = rb + PSS_SMEM_PAGE_START;\r\nioc->ioc_regs.smem_pg0 = BFI_IOC_SMEM_PG0_CT;\r\nioc->ioc_regs.err_set = rb + ERR_SET_REG;\r\n}\r\nstatic void\r\nbfa_ioc_ct_map_port(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb = ioc->pcidev.pci_bar_kva;\r\nu32 r32;\r\nr32 = readl(rb + FNC_PERS_REG);\r\nr32 >>= FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc));\r\nioc->port_id = (r32 & __F0_PORT_MAP_MK) >> __F0_PORT_MAP_SH;\r\n}\r\nstatic void\r\nbfa_ioc_ct2_map_port(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb = ioc->pcidev.pci_bar_kva;\r\nu32 r32;\r\nr32 = readl(rb + CT2_HOSTFN_PERSONALITY0);\r\nioc->port_id = ((r32 & __FC_LL_PORT_MAP__MK) >> __FC_LL_PORT_MAP__SH);\r\n}\r\nstatic void\r\nbfa_ioc_ct_isr_mode_set(struct bfa_ioc *ioc, bool msix)\r\n{\r\nvoid __iomem *rb = ioc->pcidev.pci_bar_kva;\r\nu32 r32, mode;\r\nr32 = readl(rb + FNC_PERS_REG);\r\nmode = (r32 >> FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc))) &\r\n__F0_INTX_STATUS;\r\nif ((!msix && mode) || (msix && !mode))\r\nreturn;\r\nif (msix)\r\nmode = __F0_INTX_STATUS_MSIX;\r\nelse\r\nmode = __F0_INTX_STATUS_INTA;\r\nr32 &= ~(__F0_INTX_STATUS << FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc)));\r\nr32 |= (mode << FNC_PERS_FN_SHIFT(bfa_ioc_pcifn(ioc)));\r\nwritel(r32, rb + FNC_PERS_REG);\r\n}\r\nstatic bool\r\nbfa_ioc_ct2_lpu_read_stat(struct bfa_ioc *ioc)\r\n{\r\nu32 r32;\r\nr32 = readl(ioc->ioc_regs.lpu_read_stat);\r\nif (r32) {\r\nwritel(1, ioc->ioc_regs.lpu_read_stat);\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid\r\nbfa_nw_ioc_ct2_poweron(struct bfa_ioc *ioc)\r\n{\r\nvoid __iomem *rb = ioc->pcidev.pci_bar_kva;\r\nu32 r32;\r\nr32 = readl(rb + HOSTFN_MSIX_VT_OFST_NUMVT);\r\nif (r32 & __MSIX_VT_NUMVT__MK) {\r\nwritel(r32 & __MSIX_VT_OFST_,\r\nrb + HOSTFN_MSIX_VT_INDEX_MBOX_ERR);\r\nreturn;\r\n}\r\nwritel(__MSIX_VT_NUMVT_(HOSTFN_MSIX_DEFAULT - 1) |\r\nHOSTFN_MSIX_DEFAULT * bfa_ioc_pcifn(ioc),\r\nrb + HOSTFN_MSIX_VT_OFST_NUMVT);\r\nwritel(HOSTFN_MSIX_DEFAULT * bfa_ioc_pcifn(ioc),\r\nrb + HOSTFN_MSIX_VT_INDEX_MBOX_ERR);\r\n}\r\nstatic void\r\nbfa_ioc_ct_ownership_reset(struct bfa_ioc *ioc)\r\n{\r\nbfa_nw_ioc_sem_get(ioc->ioc_regs.ioc_usage_sem_reg);\r\nwritel(0, ioc->ioc_regs.ioc_usage_reg);\r\nbfa_nw_ioc_sem_release(ioc->ioc_regs.ioc_usage_sem_reg);\r\nreadl(ioc->ioc_regs.ioc_sem_reg);\r\nbfa_nw_ioc_hw_sem_release(ioc);\r\n}\r\nstatic bool\r\nbfa_ioc_ct_sync_start(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_reqd = bfa_ioc_ct_get_sync_reqd(r32);\r\nif (sync_reqd & bfa_ioc_ct_sync_pos(ioc)) {\r\nwritel(0, ioc->ioc_regs.ioc_fail_sync);\r\nwritel(1, ioc->ioc_regs.ioc_usage_reg);\r\nwritel(BFI_IOC_UNINIT, ioc->ioc_regs.ioc_fwstate);\r\nwritel(BFI_IOC_UNINIT, ioc->ioc_regs.alt_ioc_fwstate);\r\nreturn true;\r\n}\r\nreturn bfa_ioc_ct_sync_complete(ioc);\r\n}\r\nstatic void\r\nbfa_ioc_ct_sync_join(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_pos = bfa_ioc_ct_sync_reqd_pos(ioc);\r\nwritel((r32 | sync_pos), ioc->ioc_regs.ioc_fail_sync);\r\n}\r\nstatic void\r\nbfa_ioc_ct_sync_leave(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_msk = bfa_ioc_ct_sync_reqd_pos(ioc) |\r\nbfa_ioc_ct_sync_pos(ioc);\r\nwritel((r32 & ~sync_msk), ioc->ioc_regs.ioc_fail_sync);\r\n}\r\nstatic void\r\nbfa_ioc_ct_sync_ack(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nwritel((r32 | bfa_ioc_ct_sync_pos(ioc)), ioc->ioc_regs.ioc_fail_sync);\r\n}\r\nstatic bool\r\nbfa_ioc_ct_sync_complete(struct bfa_ioc *ioc)\r\n{\r\nu32 r32 = readl(ioc->ioc_regs.ioc_fail_sync);\r\nu32 sync_reqd = bfa_ioc_ct_get_sync_reqd(r32);\r\nu32 sync_ackd = bfa_ioc_ct_get_sync_ackd(r32);\r\nu32 tmp_ackd;\r\nif (sync_ackd == 0)\r\nreturn true;\r\ntmp_ackd = sync_ackd;\r\nif ((sync_reqd & bfa_ioc_ct_sync_pos(ioc)) &&\r\n!(sync_ackd & bfa_ioc_ct_sync_pos(ioc)))\r\nsync_ackd |= bfa_ioc_ct_sync_pos(ioc);\r\nif (sync_reqd == sync_ackd) {\r\nwritel(bfa_ioc_ct_clear_sync_ackd(r32),\r\nioc->ioc_regs.ioc_fail_sync);\r\nwritel(BFI_IOC_FAIL, ioc->ioc_regs.ioc_fwstate);\r\nwritel(BFI_IOC_FAIL, ioc->ioc_regs.alt_ioc_fwstate);\r\nreturn true;\r\n}\r\nif (tmp_ackd != sync_ackd)\r\nwritel((r32 | sync_ackd), ioc->ioc_regs.ioc_fail_sync);\r\nreturn false;\r\n}\r\nstatic void\r\nbfa_ioc_ct_set_cur_ioc_fwstate(struct bfa_ioc *ioc,\r\nenum bfi_ioc_state fwstate)\r\n{\r\nwritel(fwstate, ioc->ioc_regs.ioc_fwstate);\r\n}\r\nstatic enum bfi_ioc_state\r\nbfa_ioc_ct_get_cur_ioc_fwstate(struct bfa_ioc *ioc)\r\n{\r\nreturn (enum bfi_ioc_state)readl(ioc->ioc_regs.ioc_fwstate);\r\n}\r\nstatic void\r\nbfa_ioc_ct_set_alt_ioc_fwstate(struct bfa_ioc *ioc,\r\nenum bfi_ioc_state fwstate)\r\n{\r\nwritel(fwstate, ioc->ioc_regs.alt_ioc_fwstate);\r\n}\r\nstatic enum bfi_ioc_state\r\nbfa_ioc_ct_get_alt_ioc_fwstate(struct bfa_ioc *ioc)\r\n{\r\nreturn (enum bfi_ioc_state)readl(ioc->ioc_regs.alt_ioc_fwstate);\r\n}\r\nstatic enum bfa_status\r\nbfa_ioc_ct_pll_init(void __iomem *rb, enum bfi_asic_mode asic_mode)\r\n{\r\nu32 pll_sclk, pll_fclk, r32;\r\nbool fcmode = (asic_mode == BFI_ASIC_MODE_FC);\r\npll_sclk = __APP_PLL_SCLK_LRESETN | __APP_PLL_SCLK_ENARST |\r\n__APP_PLL_SCLK_RSEL200500 | __APP_PLL_SCLK_P0_1(3U) |\r\n__APP_PLL_SCLK_JITLMT0_1(3U) |\r\n__APP_PLL_SCLK_CNTLMT0_1(1U);\r\npll_fclk = __APP_PLL_LCLK_LRESETN | __APP_PLL_LCLK_ENARST |\r\n__APP_PLL_LCLK_RSEL200500 | __APP_PLL_LCLK_P0_1(3U) |\r\n__APP_PLL_LCLK_JITLMT0_1(3U) |\r\n__APP_PLL_LCLK_CNTLMT0_1(1U);\r\nif (fcmode) {\r\nwritel(0, (rb + OP_MODE));\r\nwritel(__APP_EMS_CMLCKSEL |\r\n__APP_EMS_REFCKBUFEN2 |\r\n__APP_EMS_CHANNEL_SEL,\r\n(rb + ETH_MAC_SER_REG));\r\n} else {\r\nwritel(__GLOBAL_FCOE_MODE, (rb + OP_MODE));\r\nwritel(__APP_EMS_REFCKBUFEN1,\r\n(rb + ETH_MAC_SER_REG));\r\n}\r\nwritel(BFI_IOC_UNINIT, (rb + BFA_IOC0_STATE_REG));\r\nwritel(BFI_IOC_UNINIT, (rb + BFA_IOC1_STATE_REG));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_MSK));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_MSK));\r\nwritel(pll_sclk |\r\n__APP_PLL_SCLK_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_SCLK_CTL_REG);\r\nwritel(pll_fclk |\r\n__APP_PLL_LCLK_LOGIC_SOFT_RESET,\r\nrb + APP_PLL_LCLK_CTL_REG);\r\nwritel(pll_sclk |\r\n__APP_PLL_SCLK_LOGIC_SOFT_RESET | __APP_PLL_SCLK_ENABLE,\r\nrb + APP_PLL_SCLK_CTL_REG);\r\nwritel(pll_fclk |\r\n__APP_PLL_LCLK_LOGIC_SOFT_RESET | __APP_PLL_LCLK_ENABLE,\r\nrb + APP_PLL_LCLK_CTL_REG);\r\nreadl(rb + HOSTFN0_INT_MSK);\r\nudelay(2000);\r\nwritel(0xffffffffU, (rb + HOSTFN0_INT_STATUS));\r\nwritel(0xffffffffU, (rb + HOSTFN1_INT_STATUS));\r\nwritel(pll_sclk |\r\n__APP_PLL_SCLK_ENABLE,\r\nrb + APP_PLL_SCLK_CTL_REG);\r\nwritel(pll_fclk |\r\n__APP_PLL_LCLK_ENABLE,\r\nrb + APP_PLL_LCLK_CTL_REG);\r\nif (!fcmode) {\r\nwritel(__PMM_1T_RESET_P, (rb + PMM_1T_RESET_REG_P0));\r\nwritel(__PMM_1T_RESET_P, (rb + PMM_1T_RESET_REG_P1));\r\n}\r\nr32 = readl((rb + PSS_CTL_REG));\r\nr32 &= ~__PSS_LMEM_RESET;\r\nwritel(r32, (rb + PSS_CTL_REG));\r\nudelay(1000);\r\nif (!fcmode) {\r\nwritel(0, (rb + PMM_1T_RESET_REG_P0));\r\nwritel(0, (rb + PMM_1T_RESET_REG_P1));\r\n}\r\nwritel(__EDRAM_BISTR_START, (rb + MBIST_CTL_REG));\r\nudelay(1000);\r\nr32 = readl((rb + MBIST_STAT_REG));\r\nwritel(0, (rb + MBIST_CTL_REG));\r\nreturn BFA_STATUS_OK;\r\n}\r\nstatic void\r\nbfa_ioc_ct2_sclk_init(void __iomem *rb)\r\n{\r\nu32 r32;\r\nr32 = readl((rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nr32 &= ~(__APP_PLL_SCLK_ENABLE | __APP_PLL_SCLK_LRESETN);\r\nr32 |= (__APP_PLL_SCLK_ENARST | __APP_PLL_SCLK_BYPASS |\r\n__APP_PLL_SCLK_LOGIC_SOFT_RESET);\r\nwritel(r32, (rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nr32 = readl((rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nr32 &= ~(__APP_PLL_SCLK_REFCLK_SEL | __APP_PLL_SCLK_CLK_DIV2);\r\nwritel(r32, (rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nr32 = readl((rb + CT2_CHIP_MISC_PRG));\r\nwritel((r32 | __ETH_CLK_ENABLE_PORT0),\r\n(rb + CT2_CHIP_MISC_PRG));\r\nr32 = readl((rb + CT2_PCIE_MISC_REG));\r\nwritel((r32 | __ETH_CLK_ENABLE_PORT1),\r\n(rb + CT2_PCIE_MISC_REG));\r\nr32 = readl((rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nr32 &= (__P_SCLK_PLL_LOCK | __APP_PLL_SCLK_REFCLK_SEL |\r\n__APP_PLL_SCLK_CLK_DIV2);\r\nwritel(r32 | 0x1061731b, (rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nudelay(1000);\r\n}\r\nstatic void\r\nbfa_ioc_ct2_lclk_init(void __iomem *rb)\r\n{\r\nu32 r32;\r\nr32 = readl((rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nr32 &= ~(__APP_PLL_LCLK_ENABLE | __APP_PLL_LCLK_LRESETN);\r\nr32 |= (__APP_PLL_LCLK_ENARST | __APP_PLL_LCLK_BYPASS |\r\n__APP_PLL_LCLK_LOGIC_SOFT_RESET);\r\nwritel(r32, (rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nr32 = readl((rb + CT2_CHIP_MISC_PRG));\r\nwritel(r32, (rb + CT2_CHIP_MISC_PRG));\r\nr32 = readl((rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nwritel(r32, (rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nr32 = readl((rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nr32 &= (__P_LCLK_PLL_LOCK | __APP_LPUCLK_HALFSPEED);\r\nr32 |= 0x20c1731b;\r\nwritel(r32, (rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nudelay(1000);\r\n}\r\nstatic void\r\nbfa_ioc_ct2_mem_init(void __iomem *rb)\r\n{\r\nu32 r32;\r\nr32 = readl((rb + PSS_CTL_REG));\r\nr32 &= ~__PSS_LMEM_RESET;\r\nwritel(r32, (rb + PSS_CTL_REG));\r\nudelay(1000);\r\nwritel(__EDRAM_BISTR_START, (rb + CT2_MBIST_CTL_REG));\r\nudelay(1000);\r\nwritel(0, (rb + CT2_MBIST_CTL_REG));\r\n}\r\nstatic void\r\nbfa_ioc_ct2_mac_reset(void __iomem *rb)\r\n{\r\nvolatile u32 r32;\r\nbfa_ioc_ct2_sclk_init(rb);\r\nbfa_ioc_ct2_lclk_init(rb);\r\nr32 = readl((rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nwritel((r32 & ~__APP_PLL_SCLK_LOGIC_SOFT_RESET),\r\n(rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nr32 = readl((rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nwritel((r32 & ~__APP_PLL_LCLK_LOGIC_SOFT_RESET),\r\n(rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nwritel((__CSI_MAC_RESET | __CSI_MAC_AHB_RESET),\r\n(rb + CT2_CSI_MAC_CONTROL_REG(0)));\r\nwritel((__CSI_MAC_RESET | __CSI_MAC_AHB_RESET),\r\n(rb + CT2_CSI_MAC_CONTROL_REG(1)));\r\n}\r\nstatic bool\r\nbfa_ioc_ct2_nfc_halted(void __iomem *rb)\r\n{\r\nvolatile u32 r32;\r\nr32 = readl(rb + CT2_NFC_CSR_SET_REG);\r\nif (r32 & __NFC_CONTROLLER_HALTED)\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic void\r\nbfa_ioc_ct2_nfc_resume(void __iomem *rb)\r\n{\r\nvolatile u32 r32;\r\nint i;\r\nwritel(__HALT_NFC_CONTROLLER, rb + CT2_NFC_CSR_CLR_REG);\r\nfor (i = 0; i < CT2_NFC_MAX_DELAY; i++) {\r\nr32 = readl(rb + CT2_NFC_CSR_SET_REG);\r\nif (!(r32 & __NFC_CONTROLLER_HALTED))\r\nreturn;\r\nudelay(1000);\r\n}\r\nBUG_ON(1);\r\n}\r\nstatic enum bfa_status\r\nbfa_ioc_ct2_pll_init(void __iomem *rb, enum bfi_asic_mode asic_mode)\r\n{\r\nvolatile u32 wgn, r32;\r\nu32 nfc_ver, i;\r\nwgn = readl(rb + CT2_WGN_STATUS);\r\nnfc_ver = readl(rb + CT2_RSC_GPR15_REG);\r\nif ((wgn == (__A2T_AHB_LOAD | __WGN_READY)) &&\r\n(nfc_ver >= CT2_NFC_VER_VALID)) {\r\nif (bfa_ioc_ct2_nfc_halted(rb))\r\nbfa_ioc_ct2_nfc_resume(rb);\r\nwritel(__RESET_AND_START_SCLK_LCLK_PLLS,\r\nrb + CT2_CSI_FW_CTL_SET_REG);\r\nfor (i = 0; i < BFA_IOC_PLL_POLL; i++) {\r\nr32 = readl(rb + CT2_APP_PLL_LCLK_CTL_REG);\r\nif (r32 & __RESET_AND_START_SCLK_LCLK_PLLS)\r\nbreak;\r\n}\r\nBUG_ON(!(r32 & __RESET_AND_START_SCLK_LCLK_PLLS));\r\nfor (i = 0; i < BFA_IOC_PLL_POLL; i++) {\r\nr32 = readl(rb + CT2_APP_PLL_LCLK_CTL_REG);\r\nif (!(r32 & __RESET_AND_START_SCLK_LCLK_PLLS))\r\nbreak;\r\n}\r\nBUG_ON(r32 & __RESET_AND_START_SCLK_LCLK_PLLS);\r\nudelay(1000);\r\nr32 = readl(rb + CT2_CSI_FW_CTL_REG);\r\nBUG_ON(r32 & __RESET_AND_START_SCLK_LCLK_PLLS);\r\n} else {\r\nwritel(__HALT_NFC_CONTROLLER, (rb + CT2_NFC_CSR_SET_REG));\r\nfor (i = 0; i < CT2_NFC_MAX_DELAY; i++) {\r\nr32 = readl(rb + CT2_NFC_CSR_SET_REG);\r\nif (r32 & __NFC_CONTROLLER_HALTED)\r\nbreak;\r\nudelay(1000);\r\n}\r\nbfa_ioc_ct2_mac_reset(rb);\r\nbfa_ioc_ct2_sclk_init(rb);\r\nbfa_ioc_ct2_lclk_init(rb);\r\nr32 = readl((rb + CT2_APP_PLL_SCLK_CTL_REG));\r\nwritel(r32 & ~__APP_PLL_SCLK_LOGIC_SOFT_RESET,\r\nrb + CT2_APP_PLL_SCLK_CTL_REG);\r\nr32 = readl((rb + CT2_APP_PLL_LCLK_CTL_REG));\r\nwritel(r32 & ~__APP_PLL_LCLK_LOGIC_SOFT_RESET,\r\nrb + CT2_APP_PLL_LCLK_CTL_REG);\r\n}\r\nif (wgn == (__WGN_READY | __GLBL_PF_VF_CFG_RDY)) {\r\nr32 = readl((rb + PSS_GPIO_OUT_REG));\r\nwritel(r32 & ~1, rb + PSS_GPIO_OUT_REG);\r\nr32 = readl((rb + PSS_GPIO_OE_REG));\r\nwritel(r32 | 1, rb + PSS_GPIO_OE_REG);\r\n}\r\nwritel(1, (rb + CT2_LPU0_HOSTFN_MBOX0_MSK));\r\nwritel(1, (rb + CT2_LPU1_HOSTFN_MBOX0_MSK));\r\nr32 = readl(rb + HOST_SEM5_REG);\r\nif (r32 & 0x1) {\r\nr32 = readl((rb + CT2_LPU0_HOSTFN_CMD_STAT));\r\nif (r32 == 1) {\r\nwritel(1, (rb + CT2_LPU0_HOSTFN_CMD_STAT));\r\nreadl((rb + CT2_LPU0_HOSTFN_CMD_STAT));\r\n}\r\nr32 = readl((rb + CT2_LPU1_HOSTFN_CMD_STAT));\r\nif (r32 == 1) {\r\nwritel(1, (rb + CT2_LPU1_HOSTFN_CMD_STAT));\r\nreadl((rb + CT2_LPU1_HOSTFN_CMD_STAT));\r\n}\r\n}\r\nbfa_ioc_ct2_mem_init(rb);\r\nwritel(BFI_IOC_UNINIT, (rb + CT2_BFA_IOC0_STATE_REG));\r\nwritel(BFI_IOC_UNINIT, (rb + CT2_BFA_IOC1_STATE_REG));\r\nreturn BFA_STATUS_OK;\r\n}

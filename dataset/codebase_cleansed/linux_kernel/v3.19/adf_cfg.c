static void *qat_dev_cfg_start(struct seq_file *sfile, loff_t *pos)\r\n{\r\nstruct adf_cfg_device_data *dev_cfg = sfile->private;\r\nmutex_lock(&qat_cfg_read_lock);\r\nreturn seq_list_start(&dev_cfg->sec_list, *pos);\r\n}\r\nstatic int qat_dev_cfg_show(struct seq_file *sfile, void *v)\r\n{\r\nstruct list_head *list;\r\nstruct adf_cfg_section *sec =\r\nlist_entry(v, struct adf_cfg_section, list);\r\nseq_printf(sfile, "[%s]\n", sec->name);\r\nlist_for_each(list, &sec->param_head) {\r\nstruct adf_cfg_key_val *ptr =\r\nlist_entry(list, struct adf_cfg_key_val, list);\r\nseq_printf(sfile, "%s = %s\n", ptr->key, ptr->val);\r\n}\r\nreturn 0;\r\n}\r\nstatic void *qat_dev_cfg_next(struct seq_file *sfile, void *v, loff_t *pos)\r\n{\r\nstruct adf_cfg_device_data *dev_cfg = sfile->private;\r\nreturn seq_list_next(v, &dev_cfg->sec_list, pos);\r\n}\r\nstatic void qat_dev_cfg_stop(struct seq_file *sfile, void *v)\r\n{\r\nmutex_unlock(&qat_cfg_read_lock);\r\n}\r\nstatic int qat_dev_cfg_open(struct inode *inode, struct file *file)\r\n{\r\nint ret = seq_open(file, &qat_dev_cfg_sops);\r\nif (!ret) {\r\nstruct seq_file *seq_f = file->private_data;\r\nseq_f->private = inode->i_private;\r\n}\r\nreturn ret;\r\n}\r\nint adf_cfg_dev_add(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_cfg_device_data *dev_cfg_data;\r\ndev_cfg_data = kzalloc(sizeof(*dev_cfg_data), GFP_KERNEL);\r\nif (!dev_cfg_data)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&dev_cfg_data->sec_list);\r\ninit_rwsem(&dev_cfg_data->lock);\r\naccel_dev->cfg = dev_cfg_data;\r\ndev_cfg_data->debug = debugfs_create_file("dev_cfg", S_IRUSR,\r\naccel_dev->debugfs_dir,\r\ndev_cfg_data,\r\n&qat_dev_cfg_fops);\r\nif (!dev_cfg_data->debug) {\r\npr_err("QAT: Failed to create qat cfg debugfs entry.\n");\r\nkfree(dev_cfg_data);\r\naccel_dev->cfg = NULL;\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nvoid adf_cfg_del_all(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_cfg_device_data *dev_cfg_data = accel_dev->cfg;\r\ndown_write(&dev_cfg_data->lock);\r\nadf_cfg_section_del_all(&dev_cfg_data->sec_list);\r\nup_write(&dev_cfg_data->lock);\r\n}\r\nvoid adf_cfg_dev_remove(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_cfg_device_data *dev_cfg_data = accel_dev->cfg;\r\ndown_write(&dev_cfg_data->lock);\r\nadf_cfg_section_del_all(&dev_cfg_data->sec_list);\r\nup_write(&dev_cfg_data->lock);\r\ndebugfs_remove(dev_cfg_data->debug);\r\nkfree(dev_cfg_data);\r\naccel_dev->cfg = NULL;\r\n}\r\nstatic void adf_cfg_keyval_add(struct adf_cfg_key_val *new,\r\nstruct adf_cfg_section *sec)\r\n{\r\nlist_add_tail(&new->list, &sec->param_head);\r\n}\r\nstatic void adf_cfg_keyval_del_all(struct list_head *head)\r\n{\r\nstruct list_head *list_ptr, *tmp;\r\nlist_for_each_prev_safe(list_ptr, tmp, head) {\r\nstruct adf_cfg_key_val *ptr =\r\nlist_entry(list_ptr, struct adf_cfg_key_val, list);\r\nlist_del(list_ptr);\r\nkfree(ptr);\r\n}\r\n}\r\nstatic void adf_cfg_section_del_all(struct list_head *head)\r\n{\r\nstruct adf_cfg_section *ptr;\r\nstruct list_head *list, *tmp;\r\nlist_for_each_prev_safe(list, tmp, head) {\r\nptr = list_entry(list, struct adf_cfg_section, list);\r\nadf_cfg_keyval_del_all(&ptr->param_head);\r\nlist_del(list);\r\nkfree(ptr);\r\n}\r\n}\r\nstatic struct adf_cfg_key_val *adf_cfg_key_value_find(struct adf_cfg_section *s,\r\nconst char *key)\r\n{\r\nstruct list_head *list;\r\nlist_for_each(list, &s->param_head) {\r\nstruct adf_cfg_key_val *ptr =\r\nlist_entry(list, struct adf_cfg_key_val, list);\r\nif (!strcmp(ptr->key, key))\r\nreturn ptr;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct adf_cfg_section *adf_cfg_sec_find(struct adf_accel_dev *accel_dev,\r\nconst char *sec_name)\r\n{\r\nstruct adf_cfg_device_data *cfg = accel_dev->cfg;\r\nstruct list_head *list;\r\nlist_for_each(list, &cfg->sec_list) {\r\nstruct adf_cfg_section *ptr =\r\nlist_entry(list, struct adf_cfg_section, list);\r\nif (!strcmp(ptr->name, sec_name))\r\nreturn ptr;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int adf_cfg_key_val_get(struct adf_accel_dev *accel_dev,\r\nconst char *sec_name,\r\nconst char *key_name,\r\nchar *val)\r\n{\r\nstruct adf_cfg_section *sec = adf_cfg_sec_find(accel_dev, sec_name);\r\nstruct adf_cfg_key_val *keyval = NULL;\r\nif (sec)\r\nkeyval = adf_cfg_key_value_find(sec, key_name);\r\nif (keyval) {\r\nmemcpy(val, keyval->val, ADF_CFG_MAX_VAL_LEN_IN_BYTES);\r\nreturn 0;\r\n}\r\nreturn -1;\r\n}\r\nint adf_cfg_add_key_value_param(struct adf_accel_dev *accel_dev,\r\nconst char *section_name,\r\nconst char *key, const void *val,\r\nenum adf_cfg_val_type type)\r\n{\r\nstruct adf_cfg_device_data *cfg = accel_dev->cfg;\r\nstruct adf_cfg_key_val *key_val;\r\nstruct adf_cfg_section *section = adf_cfg_sec_find(accel_dev,\r\nsection_name);\r\nif (!section)\r\nreturn -EFAULT;\r\nkey_val = kzalloc(sizeof(*key_val), GFP_KERNEL);\r\nif (!key_val)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&key_val->list);\r\nstrlcpy(key_val->key, key, sizeof(key_val->key));\r\nif (type == ADF_DEC) {\r\nsnprintf(key_val->val, ADF_CFG_MAX_VAL_LEN_IN_BYTES,\r\n"%ld", (*((long *)val)));\r\n} else if (type == ADF_STR) {\r\nstrlcpy(key_val->val, (char *)val, sizeof(key_val->val));\r\n} else if (type == ADF_HEX) {\r\nsnprintf(key_val->val, ADF_CFG_MAX_VAL_LEN_IN_BYTES,\r\n"0x%lx", (unsigned long)val);\r\n} else {\r\npr_err("QAT: Unknown type given.\n");\r\nkfree(key_val);\r\nreturn -1;\r\n}\r\nkey_val->type = type;\r\ndown_write(&cfg->lock);\r\nadf_cfg_keyval_add(key_val, section);\r\nup_write(&cfg->lock);\r\nreturn 0;\r\n}\r\nint adf_cfg_section_add(struct adf_accel_dev *accel_dev, const char *name)\r\n{\r\nstruct adf_cfg_device_data *cfg = accel_dev->cfg;\r\nstruct adf_cfg_section *sec = adf_cfg_sec_find(accel_dev, name);\r\nif (sec)\r\nreturn 0;\r\nsec = kzalloc(sizeof(*sec), GFP_KERNEL);\r\nif (!sec)\r\nreturn -ENOMEM;\r\nstrlcpy(sec->name, name, sizeof(sec->name));\r\nINIT_LIST_HEAD(&sec->param_head);\r\ndown_write(&cfg->lock);\r\nlist_add_tail(&sec->list, &cfg->sec_list);\r\nup_write(&cfg->lock);\r\nreturn 0;\r\n}\r\nint adf_cfg_get_param_value(struct adf_accel_dev *accel_dev,\r\nconst char *section, const char *name,\r\nchar *value)\r\n{\r\nstruct adf_cfg_device_data *cfg = accel_dev->cfg;\r\nint ret;\r\ndown_read(&cfg->lock);\r\nret = adf_cfg_key_val_get(accel_dev, section, name, value);\r\nup_read(&cfg->lock);\r\nreturn ret;\r\n}

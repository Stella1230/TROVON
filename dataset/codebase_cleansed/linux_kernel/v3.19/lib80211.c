int lib80211_crypt_info_init(struct lib80211_crypt_info *info, char *name,\r\nspinlock_t *lock)\r\n{\r\nmemset(info, 0, sizeof(*info));\r\ninfo->name = name;\r\ninfo->lock = lock;\r\nINIT_LIST_HEAD(&info->crypt_deinit_list);\r\nsetup_timer(&info->crypt_deinit_timer, lib80211_crypt_deinit_handler,\r\n(unsigned long)info);\r\nreturn 0;\r\n}\r\nvoid lib80211_crypt_info_free(struct lib80211_crypt_info *info)\r\n{\r\nint i;\r\nlib80211_crypt_quiescing(info);\r\ndel_timer_sync(&info->crypt_deinit_timer);\r\nlib80211_crypt_deinit_entries(info, 1);\r\nfor (i = 0; i < NUM_WEP_KEYS; i++) {\r\nstruct lib80211_crypt_data *crypt = info->crypt[i];\r\nif (crypt) {\r\nif (crypt->ops) {\r\ncrypt->ops->deinit(crypt->priv);\r\nmodule_put(crypt->ops->owner);\r\n}\r\nkfree(crypt);\r\ninfo->crypt[i] = NULL;\r\n}\r\n}\r\n}\r\nstatic void lib80211_crypt_deinit_entries(struct lib80211_crypt_info *info,\r\nint force)\r\n{\r\nstruct lib80211_crypt_data *entry, *next;\r\nunsigned long flags;\r\nspin_lock_irqsave(info->lock, flags);\r\nlist_for_each_entry_safe(entry, next, &info->crypt_deinit_list, list) {\r\nif (atomic_read(&entry->refcnt) != 0 && !force)\r\ncontinue;\r\nlist_del(&entry->list);\r\nif (entry->ops) {\r\nentry->ops->deinit(entry->priv);\r\nmodule_put(entry->ops->owner);\r\n}\r\nkfree(entry);\r\n}\r\nspin_unlock_irqrestore(info->lock, flags);\r\n}\r\nstatic void lib80211_crypt_quiescing(struct lib80211_crypt_info *info)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(info->lock, flags);\r\ninfo->crypt_quiesced = 1;\r\nspin_unlock_irqrestore(info->lock, flags);\r\n}\r\nstatic void lib80211_crypt_deinit_handler(unsigned long data)\r\n{\r\nstruct lib80211_crypt_info *info = (struct lib80211_crypt_info *)data;\r\nunsigned long flags;\r\nlib80211_crypt_deinit_entries(info, 0);\r\nspin_lock_irqsave(info->lock, flags);\r\nif (!list_empty(&info->crypt_deinit_list) && !info->crypt_quiesced) {\r\nprintk(KERN_DEBUG "%s: entries remaining in delayed crypt "\r\n"deletion list\n", info->name);\r\ninfo->crypt_deinit_timer.expires = jiffies + HZ;\r\nadd_timer(&info->crypt_deinit_timer);\r\n}\r\nspin_unlock_irqrestore(info->lock, flags);\r\n}\r\nvoid lib80211_crypt_delayed_deinit(struct lib80211_crypt_info *info,\r\nstruct lib80211_crypt_data **crypt)\r\n{\r\nstruct lib80211_crypt_data *tmp;\r\nunsigned long flags;\r\nif (*crypt == NULL)\r\nreturn;\r\ntmp = *crypt;\r\n*crypt = NULL;\r\nspin_lock_irqsave(info->lock, flags);\r\nif (!info->crypt_quiesced) {\r\nlist_add(&tmp->list, &info->crypt_deinit_list);\r\nif (!timer_pending(&info->crypt_deinit_timer)) {\r\ninfo->crypt_deinit_timer.expires = jiffies + HZ;\r\nadd_timer(&info->crypt_deinit_timer);\r\n}\r\n}\r\nspin_unlock_irqrestore(info->lock, flags);\r\n}\r\nint lib80211_register_crypto_ops(struct lib80211_crypto_ops *ops)\r\n{\r\nunsigned long flags;\r\nstruct lib80211_crypto_alg *alg;\r\nalg = kzalloc(sizeof(*alg), GFP_KERNEL);\r\nif (alg == NULL)\r\nreturn -ENOMEM;\r\nalg->ops = ops;\r\nspin_lock_irqsave(&lib80211_crypto_lock, flags);\r\nlist_add(&alg->list, &lib80211_crypto_algs);\r\nspin_unlock_irqrestore(&lib80211_crypto_lock, flags);\r\nprintk(KERN_DEBUG "lib80211_crypt: registered algorithm '%s'\n",\r\nops->name);\r\nreturn 0;\r\n}\r\nint lib80211_unregister_crypto_ops(struct lib80211_crypto_ops *ops)\r\n{\r\nstruct lib80211_crypto_alg *alg;\r\nunsigned long flags;\r\nspin_lock_irqsave(&lib80211_crypto_lock, flags);\r\nlist_for_each_entry(alg, &lib80211_crypto_algs, list) {\r\nif (alg->ops == ops)\r\ngoto found;\r\n}\r\nspin_unlock_irqrestore(&lib80211_crypto_lock, flags);\r\nreturn -EINVAL;\r\nfound:\r\nprintk(KERN_DEBUG "lib80211_crypt: unregistered algorithm '%s'\n",\r\nops->name);\r\nlist_del(&alg->list);\r\nspin_unlock_irqrestore(&lib80211_crypto_lock, flags);\r\nkfree(alg);\r\nreturn 0;\r\n}\r\nstruct lib80211_crypto_ops *lib80211_get_crypto_ops(const char *name)\r\n{\r\nstruct lib80211_crypto_alg *alg;\r\nunsigned long flags;\r\nspin_lock_irqsave(&lib80211_crypto_lock, flags);\r\nlist_for_each_entry(alg, &lib80211_crypto_algs, list) {\r\nif (strcmp(alg->ops->name, name) == 0)\r\ngoto found;\r\n}\r\nspin_unlock_irqrestore(&lib80211_crypto_lock, flags);\r\nreturn NULL;\r\nfound:\r\nspin_unlock_irqrestore(&lib80211_crypto_lock, flags);\r\nreturn alg->ops;\r\n}\r\nstatic void *lib80211_crypt_null_init(int keyidx)\r\n{\r\nreturn (void *)1;\r\n}\r\nstatic void lib80211_crypt_null_deinit(void *priv)\r\n{\r\n}\r\nstatic int __init lib80211_init(void)\r\n{\r\npr_info(DRV_DESCRIPTION "\n");\r\nreturn lib80211_register_crypto_ops(&lib80211_crypt_null);\r\n}\r\nstatic void __exit lib80211_exit(void)\r\n{\r\nlib80211_unregister_crypto_ops(&lib80211_crypt_null);\r\nBUG_ON(!list_empty(&lib80211_crypto_algs));\r\n}

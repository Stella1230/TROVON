int do_mathemu(struct pt_regs *regs, struct task_struct *fpt)\r\n{\r\nint i;\r\nint retcode = 0;\r\nunsigned long insn;\r\nperf_sw_event(PERF_COUNT_SW_EMULATION_FAULTS, 1, regs, 0);\r\n#ifdef DEBUG_MATHEMU\r\nprintk("In do_mathemu()... pc is %08lx\n", regs->pc);\r\nprintk("fpqdepth is %ld\n", fpt->thread.fpqdepth);\r\nfor (i = 0; i < fpt->thread.fpqdepth; i++)\r\nprintk("%d: %08lx at %08lx\n", i, fpt->thread.fpqueue[i].insn,\r\n(unsigned long)fpt->thread.fpqueue[i].insn_addr);\r\n#endif\r\nif (fpt->thread.fpqdepth == 0) {\r\n#ifdef DEBUG_MATHEMU\r\nprintk("precise trap at %08lx\n", regs->pc);\r\n#endif\r\nif (!get_user(insn, (u32 __user *) regs->pc)) {\r\nretcode = do_one_mathemu(insn, &fpt->thread.fsr, fpt->thread.float_regs);\r\nif (retcode) {\r\nregs->pc = regs->npc;\r\nregs->npc += 4;\r\n}\r\n}\r\nreturn retcode;\r\n}\r\nfor (i = 0; i < fpt->thread.fpqdepth; i++) {\r\nretcode = do_one_mathemu(fpt->thread.fpqueue[i].insn, &(fpt->thread.fsr), fpt->thread.float_regs);\r\nif (!retcode)\r\nbreak;\r\n}\r\nif (retcode)\r\nfpt->thread.fsr &= ~(0x3000 | FSR_CEXC_MASK);\r\nelse\r\nfpt->thread.fsr &= ~0x3000;\r\nfpt->thread.fpqdepth = 0;\r\nreturn retcode;\r\n}\r\nstatic inline int record_exception(unsigned long *pfsr, int eflag)\r\n{\r\nunsigned long fsr = *pfsr;\r\nint would_trap;\r\nwould_trap = (fsr & ((long)eflag << FSR_TEM_SHIFT)) != 0UL;\r\nif (would_trap != 0) {\r\neflag &= ((fsr & FSR_TEM_MASK) >> FSR_TEM_SHIFT);\r\nif ((eflag & (eflag - 1)) != 0) {\r\nif (eflag & FP_EX_INVALID)\r\neflag = FP_EX_INVALID;\r\nelse if (eflag & FP_EX_OVERFLOW)\r\neflag = FP_EX_OVERFLOW;\r\nelse if (eflag & FP_EX_UNDERFLOW)\r\neflag = FP_EX_UNDERFLOW;\r\nelse if (eflag & FP_EX_DIVZERO)\r\neflag = FP_EX_DIVZERO;\r\nelse if (eflag & FP_EX_INEXACT)\r\neflag = FP_EX_INEXACT;\r\n}\r\n}\r\nfsr &= ~(FSR_CEXC_MASK);\r\nfsr |= ((long)eflag << FSR_CEXC_SHIFT);\r\nif (would_trap == 0)\r\nfsr |= ((long)eflag << FSR_AEXC_SHIFT);\r\nif (would_trap != 0)\r\nfsr |= (1UL << 14);\r\n*pfsr = fsr;\r\nreturn (would_trap ? 0 : 1);\r\n}\r\nstatic int do_one_mathemu(u32 insn, unsigned long *pfsr, unsigned long *fregs)\r\n{\r\nint type = 0;\r\n#define TYPE(dummy, r, ru, b, bu, a, au) type = (au << 2) | (a << 0) | (bu << 5) | (b << 3) | (ru << 8) | (r << 6)\r\nint freg;\r\nargp rs1 = NULL, rs2 = NULL, rd = NULL;\r\nFP_DECL_EX;\r\nFP_DECL_S(SA); FP_DECL_S(SB); FP_DECL_S(SR);\r\nFP_DECL_D(DA); FP_DECL_D(DB); FP_DECL_D(DR);\r\nFP_DECL_Q(QA); FP_DECL_Q(QB); FP_DECL_Q(QR);\r\nint IR;\r\nlong fsr;\r\n#ifdef DEBUG_MATHEMU\r\nprintk("In do_mathemu(), emulating %08lx\n", insn);\r\n#endif\r\nif ((insn & 0xc1f80000) == 0x81a00000) {\r\nswitch ((insn >> 5) & 0x1ff) {\r\ncase FSQRTQ: TYPE(3,3,1,3,1,0,0); break;\r\ncase FADDQ:\r\ncase FSUBQ:\r\ncase FMULQ:\r\ncase FDIVQ: TYPE(3,3,1,3,1,3,1); break;\r\ncase FDMULQ: TYPE(3,3,1,2,1,2,1); break;\r\ncase FQTOS: TYPE(3,1,1,3,1,0,0); break;\r\ncase FQTOD: TYPE(3,2,1,3,1,0,0); break;\r\ncase FITOQ: TYPE(3,3,1,1,0,0,0); break;\r\ncase FSTOQ: TYPE(3,3,1,1,1,0,0); break;\r\ncase FDTOQ: TYPE(3,3,1,2,1,0,0); break;\r\ncase FQTOI: TYPE(3,1,0,3,1,0,0); break;\r\ncase FSQRTS: TYPE(2,1,1,1,1,0,0); break;\r\ncase FSQRTD: TYPE(2,2,1,2,1,0,0); break;\r\ncase FADDD:\r\ncase FSUBD:\r\ncase FMULD:\r\ncase FDIVD: TYPE(2,2,1,2,1,2,1); break;\r\ncase FADDS:\r\ncase FSUBS:\r\ncase FMULS:\r\ncase FDIVS: TYPE(2,1,1,1,1,1,1); break;\r\ncase FSMULD: TYPE(2,2,1,1,1,1,1); break;\r\ncase FDTOS: TYPE(2,1,1,2,1,0,0); break;\r\ncase FSTOD: TYPE(2,2,1,1,1,0,0); break;\r\ncase FSTOI: TYPE(2,1,0,1,1,0,0); break;\r\ncase FDTOI: TYPE(2,1,0,2,1,0,0); break;\r\ncase FITOS: TYPE(2,1,1,1,0,0,0); break;\r\ncase FITOD: TYPE(2,2,1,1,0,0,0); break;\r\ncase FMOVS:\r\ncase FABSS:\r\ncase FNEGS: TYPE(2,1,0,1,0,0,0); break;\r\n}\r\n} else if ((insn & 0xc1f80000) == 0x81a80000) {\r\nswitch ((insn >> 5) & 0x1ff) {\r\ncase FCMPS: TYPE(3,0,0,1,1,1,1); break;\r\ncase FCMPES: TYPE(3,0,0,1,1,1,1); break;\r\ncase FCMPD: TYPE(3,0,0,2,1,2,1); break;\r\ncase FCMPED: TYPE(3,0,0,2,1,2,1); break;\r\ncase FCMPQ: TYPE(3,0,0,3,1,3,1); break;\r\ncase FCMPEQ: TYPE(3,0,0,3,1,3,1); break;\r\n}\r\n}\r\nif (!type) {\r\n#ifdef DEBUG_MATHEMU\r\nprintk("attempt to emulate unrecognised FPop!\n");\r\n#endif\r\nreturn 0;\r\n}\r\nfreg = (*pfsr >> 14) & 0xf;\r\n*pfsr &= ~0x1c000;\r\nfreg = ((insn >> 14) & 0x1f);\r\nswitch (type & 0x3) {\r\ncase 3:\r\nif (freg & 3) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\ncase 2:\r\nif (freg & 1) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\n}\r\nrs1 = (argp)&fregs[freg];\r\nswitch (type & 0x7) {\r\ncase 7: FP_UNPACK_QP (QA, rs1); break;\r\ncase 6: FP_UNPACK_DP (DA, rs1); break;\r\ncase 5: FP_UNPACK_SP (SA, rs1); break;\r\n}\r\nfreg = (insn & 0x1f);\r\nswitch ((type >> 3) & 0x3) {\r\ncase 3:\r\nif (freg & 3) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\ncase 2:\r\nif (freg & 1) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\n}\r\nrs2 = (argp)&fregs[freg];\r\nswitch ((type >> 3) & 0x7) {\r\ncase 7: FP_UNPACK_QP (QB, rs2); break;\r\ncase 6: FP_UNPACK_DP (DB, rs2); break;\r\ncase 5: FP_UNPACK_SP (SB, rs2); break;\r\n}\r\nfreg = ((insn >> 25) & 0x1f);\r\nswitch ((type >> 6) & 0x3) {\r\ncase 0:\r\nif (freg) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\nbreak;\r\ncase 3:\r\nif (freg & 3) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\ncase 2:\r\nif (freg & 1) {\r\n*pfsr |= (6 << 14);\r\nreturn 0;\r\n}\r\ncase 1:\r\nrd = (void *)&fregs[freg];\r\nbreak;\r\n}\r\n#ifdef DEBUG_MATHEMU\r\nprintk("executing insn...\n");\r\n#endif\r\nswitch ((insn >> 5) & 0x1ff) {\r\ncase FADDS: FP_ADD_S (SR, SA, SB); break;\r\ncase FADDD: FP_ADD_D (DR, DA, DB); break;\r\ncase FADDQ: FP_ADD_Q (QR, QA, QB); break;\r\ncase FSUBS: FP_SUB_S (SR, SA, SB); break;\r\ncase FSUBD: FP_SUB_D (DR, DA, DB); break;\r\ncase FSUBQ: FP_SUB_Q (QR, QA, QB); break;\r\ncase FMULS: FP_MUL_S (SR, SA, SB); break;\r\ncase FSMULD: FP_CONV (D, S, 2, 1, DA, SA);\r\nFP_CONV (D, S, 2, 1, DB, SB);\r\ncase FMULD: FP_MUL_D (DR, DA, DB); break;\r\ncase FDMULQ: FP_CONV (Q, D, 4, 2, QA, DA);\r\nFP_CONV (Q, D, 4, 2, QB, DB);\r\ncase FMULQ: FP_MUL_Q (QR, QA, QB); break;\r\ncase FDIVS: FP_DIV_S (SR, SA, SB); break;\r\ncase FDIVD: FP_DIV_D (DR, DA, DB); break;\r\ncase FDIVQ: FP_DIV_Q (QR, QA, QB); break;\r\ncase FSQRTS: FP_SQRT_S (SR, SB); break;\r\ncase FSQRTD: FP_SQRT_D (DR, DB); break;\r\ncase FSQRTQ: FP_SQRT_Q (QR, QB); break;\r\ncase FMOVS: rd->s = rs2->s; break;\r\ncase FABSS: rd->s = rs2->s & 0x7fffffff; break;\r\ncase FNEGS: rd->s = rs2->s ^ 0x80000000; break;\r\ncase FSTOI: FP_TO_INT_S (IR, SB, 32, 1); break;\r\ncase FDTOI: FP_TO_INT_D (IR, DB, 32, 1); break;\r\ncase FQTOI: FP_TO_INT_Q (IR, QB, 32, 1); break;\r\ncase FITOS: IR = rs2->s; FP_FROM_INT_S (SR, IR, 32, int); break;\r\ncase FITOD: IR = rs2->s; FP_FROM_INT_D (DR, IR, 32, int); break;\r\ncase FITOQ: IR = rs2->s; FP_FROM_INT_Q (QR, IR, 32, int); break;\r\ncase FSTOD: FP_CONV (D, S, 2, 1, DR, SB); break;\r\ncase FSTOQ: FP_CONV (Q, S, 4, 1, QR, SB); break;\r\ncase FDTOQ: FP_CONV (Q, D, 4, 2, QR, DB); break;\r\ncase FDTOS: FP_CONV (S, D, 1, 2, SR, DB); break;\r\ncase FQTOS: FP_CONV (S, Q, 1, 4, SR, QB); break;\r\ncase FQTOD: FP_CONV (D, Q, 2, 4, DR, QB); break;\r\ncase FCMPS:\r\ncase FCMPES:\r\nFP_CMP_S(IR, SB, SA, 3);\r\nif (IR == 3 &&\r\n(((insn >> 5) & 0x1ff) == FCMPES ||\r\nFP_ISSIGNAN_S(SA) ||\r\nFP_ISSIGNAN_S(SB)))\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nbreak;\r\ncase FCMPD:\r\ncase FCMPED:\r\nFP_CMP_D(IR, DB, DA, 3);\r\nif (IR == 3 &&\r\n(((insn >> 5) & 0x1ff) == FCMPED ||\r\nFP_ISSIGNAN_D(DA) ||\r\nFP_ISSIGNAN_D(DB)))\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\nbreak;\r\ncase FCMPQ:\r\ncase FCMPEQ:\r\nFP_CMP_Q(IR, QB, QA, 3);\r\nif (IR == 3 &&\r\n(((insn >> 5) & 0x1ff) == FCMPEQ ||\r\nFP_ISSIGNAN_Q(QA) ||\r\nFP_ISSIGNAN_Q(QB)))\r\nFP_SET_EXCEPTION (FP_EX_INVALID);\r\n}\r\nif (!FP_INHIBIT_RESULTS) {\r\nswitch ((type >> 6) & 0x7) {\r\ncase 0: fsr = *pfsr;\r\nif (IR == -1) IR = 2;\r\nfsr &= ~0xc00; fsr |= (IR << 10);\r\n*pfsr = fsr;\r\nbreak;\r\ncase 1: rd->s = IR; break;\r\ncase 5: FP_PACK_SP (rd, SR); break;\r\ncase 6: FP_PACK_DP (rd, DR); break;\r\ncase 7: FP_PACK_QP (rd, QR); break;\r\n}\r\n}\r\nif (_fex == 0)\r\nreturn 1;\r\nreturn record_exception(pfsr, _fex);\r\n}

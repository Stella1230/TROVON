static int perf_flag_probe(void)\r\n{\r\nstruct perf_event_attr attr = {\r\n.type = PERF_TYPE_SOFTWARE,\r\n.config = PERF_COUNT_SW_CPU_CLOCK,\r\n.exclude_kernel = 1,\r\n};\r\nint fd;\r\nint err;\r\nint cpu;\r\npid_t pid = -1;\r\nchar sbuf[STRERR_BUFSIZE];\r\ncpu = sched_getcpu();\r\nif (cpu < 0)\r\ncpu = 0;\r\nwhile (1) {\r\nfd = sys_perf_event_open(&attr, pid, cpu, -1,\r\nPERF_FLAG_FD_CLOEXEC);\r\nif (fd < 0 && pid == -1 && errno == EACCES) {\r\npid = 0;\r\ncontinue;\r\n}\r\nbreak;\r\n}\r\nerr = errno;\r\nif (fd >= 0) {\r\nclose(fd);\r\nreturn 1;\r\n}\r\nWARN_ONCE(err != EINVAL && err != EBUSY,\r\n"perf_event_open(..., PERF_FLAG_FD_CLOEXEC) failed with unexpected error %d (%s)\n",\r\nerr, strerror_r(err, sbuf, sizeof(sbuf)));\r\nfd = sys_perf_event_open(&attr, pid, cpu, -1, 0);\r\nerr = errno;\r\nif (WARN_ONCE(fd < 0 && err != EBUSY,\r\n"perf_event_open(..., 0) failed unexpectedly with error %d (%s)\n",\r\nerr, strerror_r(err, sbuf, sizeof(sbuf))))\r\nreturn -1;\r\nclose(fd);\r\nreturn 0;\r\n}\r\nunsigned long perf_event_open_cloexec_flag(void)\r\n{\r\nstatic bool probed;\r\nif (!probed) {\r\nif (perf_flag_probe() <= 0)\r\nflag = 0;\r\nprobed = true;\r\n}\r\nreturn flag;\r\n}

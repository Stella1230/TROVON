int cfe_init(u64 handle, u64 ept)\r\n{\r\ncfe_dispfunc = NATIVE_FROM_XPTR(ept);\r\ncfe_handle = handle;\r\nreturn 0;\r\n}\r\nint cfe_iocb_dispatch(struct cfe_xiocb * xiocb)\r\n{\r\nif (!cfe_dispfunc)\r\nreturn -1;\r\nreturn (*cfe_dispfunc) ((intptr_t) cfe_handle, (intptr_t) xiocb);\r\n}\r\nint cfe_close(int handle)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_CLOSE;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = handle;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = 0;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_cpu_start(int cpu, void (*fn) (void), long sp, long gp, long a1)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_CPUCTL;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_cpuctl);\r\nxiocb.plist.xiocb_cpuctl.cpu_number = cpu;\r\nxiocb.plist.xiocb_cpuctl.cpu_command = CFE_CPU_CMD_START;\r\nxiocb.plist.xiocb_cpuctl.gp_val = gp;\r\nxiocb.plist.xiocb_cpuctl.sp_val = sp;\r\nxiocb.plist.xiocb_cpuctl.a1_val = a1;\r\nxiocb.plist.xiocb_cpuctl.start_addr = (long) fn;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_cpu_stop(int cpu)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_CPUCTL;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_cpuctl);\r\nxiocb.plist.xiocb_cpuctl.cpu_number = cpu;\r\nxiocb.plist.xiocb_cpuctl.cpu_command = CFE_CPU_CMD_STOP;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_enumenv(int idx, char *name, int namelen, char *val, int vallen)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_ENV_SET;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_envbuf);\r\nxiocb.plist.xiocb_envbuf.enum_idx = idx;\r\nxiocb.plist.xiocb_envbuf.name_ptr = XPTR_FROM_NATIVE(name);\r\nxiocb.plist.xiocb_envbuf.name_length = namelen;\r\nxiocb.plist.xiocb_envbuf.val_ptr = XPTR_FROM_NATIVE(val);\r\nxiocb.plist.xiocb_envbuf.val_length = vallen;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint\r\ncfe_enummem(int idx, int flags, u64 *start, u64 *length, u64 *type)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_MEMENUM;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = flags;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_meminfo);\r\nxiocb.plist.xiocb_meminfo.mi_idx = idx;\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\n*start = xiocb.plist.xiocb_meminfo.mi_addr;\r\n*length = xiocb.plist.xiocb_meminfo.mi_size;\r\n*type = xiocb.plist.xiocb_meminfo.mi_type;\r\nreturn 0;\r\n}\r\nint cfe_exit(int warm, int status)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_RESTART;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = warm ? CFE_FLG_WARMSTART : 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_exitstat);\r\nxiocb.plist.xiocb_exitstat.status = status;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_flushcache(int flg)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_FLUSHCACHE;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = flg;\r\nxiocb.xiocb_psize = 0;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_getdevinfo(char *name)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_GETINFO;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_buffer);\r\nxiocb.plist.xiocb_buffer.buf_offset = 0;\r\nxiocb.plist.xiocb_buffer.buf_ptr = XPTR_FROM_NATIVE(name);\r\nxiocb.plist.xiocb_buffer.buf_length = strlen(name);\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\nreturn xiocb.plist.xiocb_buffer.buf_ioctlcmd;\r\n}\r\nint cfe_getenv(char *name, char *dest, int destlen)\r\n{\r\nstruct cfe_xiocb xiocb;\r\n*dest = 0;\r\nxiocb.xiocb_fcode = CFE_CMD_ENV_GET;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_envbuf);\r\nxiocb.plist.xiocb_envbuf.enum_idx = 0;\r\nxiocb.plist.xiocb_envbuf.name_ptr = XPTR_FROM_NATIVE(name);\r\nxiocb.plist.xiocb_envbuf.name_length = strlen(name);\r\nxiocb.plist.xiocb_envbuf.val_ptr = XPTR_FROM_NATIVE(dest);\r\nxiocb.plist.xiocb_envbuf.val_length = destlen;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_getfwinfo(cfe_fwinfo_t * info)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_GETINFO;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_fwinfo);\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\ninfo->fwi_version = xiocb.plist.xiocb_fwinfo.fwi_version;\r\ninfo->fwi_totalmem = xiocb.plist.xiocb_fwinfo.fwi_totalmem;\r\ninfo->fwi_flags = xiocb.plist.xiocb_fwinfo.fwi_flags;\r\ninfo->fwi_boardid = xiocb.plist.xiocb_fwinfo.fwi_boardid;\r\ninfo->fwi_bootarea_va = xiocb.plist.xiocb_fwinfo.fwi_bootarea_va;\r\ninfo->fwi_bootarea_pa = xiocb.plist.xiocb_fwinfo.fwi_bootarea_pa;\r\ninfo->fwi_bootarea_size =\r\nxiocb.plist.xiocb_fwinfo.fwi_bootarea_size;\r\n#if 0\r\ninfo->fwi_reserved1 = xiocb.plist.xiocb_fwinfo.fwi_reserved1;\r\ninfo->fwi_reserved2 = xiocb.plist.xiocb_fwinfo.fwi_reserved2;\r\ninfo->fwi_reserved3 = xiocb.plist.xiocb_fwinfo.fwi_reserved3;\r\n#endif\r\nreturn 0;\r\n}\r\nint cfe_getstdhandle(int flg)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_GETHANDLE;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = flg;\r\nxiocb.xiocb_psize = 0;\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\nreturn xiocb.xiocb_handle;\r\n}\r\nint64_t\r\ncfe_getticks(void)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_FW_GETTIME;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_time);\r\nxiocb.plist.xiocb_time.ticks = 0;\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.plist.xiocb_time.ticks;\r\n}\r\nint cfe_inpstat(int handle)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_INPSTAT;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = handle;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_inpstat);\r\nxiocb.plist.xiocb_inpstat.inp_status = 0;\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\nreturn xiocb.plist.xiocb_inpstat.inp_status;\r\n}\r\nint\r\ncfe_ioctl(int handle, unsigned int ioctlnum, unsigned char *buffer,\r\nint length, int *retlen, u64 offset)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_IOCTL;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = handle;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_buffer);\r\nxiocb.plist.xiocb_buffer.buf_offset = offset;\r\nxiocb.plist.xiocb_buffer.buf_ioctlcmd = ioctlnum;\r\nxiocb.plist.xiocb_buffer.buf_ptr = XPTR_FROM_NATIVE(buffer);\r\nxiocb.plist.xiocb_buffer.buf_length = length;\r\ncfe_iocb_dispatch(&xiocb);\r\nif (retlen)\r\n*retlen = xiocb.plist.xiocb_buffer.buf_retlen;\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_open(char *name)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_OPEN;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_buffer);\r\nxiocb.plist.xiocb_buffer.buf_offset = 0;\r\nxiocb.plist.xiocb_buffer.buf_ptr = XPTR_FROM_NATIVE(name);\r\nxiocb.plist.xiocb_buffer.buf_length = strlen(name);\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\nreturn xiocb.xiocb_handle;\r\n}\r\nint cfe_read(int handle, unsigned char *buffer, int length)\r\n{\r\nreturn cfe_readblk(handle, 0, buffer, length);\r\n}\r\nint cfe_readblk(int handle, s64 offset, unsigned char *buffer, int length)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_READ;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = handle;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_buffer);\r\nxiocb.plist.xiocb_buffer.buf_offset = offset;\r\nxiocb.plist.xiocb_buffer.buf_ptr = XPTR_FROM_NATIVE(buffer);\r\nxiocb.plist.xiocb_buffer.buf_length = length;\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\nreturn xiocb.plist.xiocb_buffer.buf_retlen;\r\n}\r\nint cfe_setenv(char *name, char *val)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_ENV_SET;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = 0;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_envbuf);\r\nxiocb.plist.xiocb_envbuf.enum_idx = 0;\r\nxiocb.plist.xiocb_envbuf.name_ptr = XPTR_FROM_NATIVE(name);\r\nxiocb.plist.xiocb_envbuf.name_length = strlen(name);\r\nxiocb.plist.xiocb_envbuf.val_ptr = XPTR_FROM_NATIVE(val);\r\nxiocb.plist.xiocb_envbuf.val_length = strlen(val);\r\ncfe_iocb_dispatch(&xiocb);\r\nreturn xiocb.xiocb_status;\r\n}\r\nint cfe_write(int handle, const char *buffer, int length)\r\n{\r\nreturn cfe_writeblk(handle, 0, buffer, length);\r\n}\r\nint cfe_writeblk(int handle, s64 offset, const char *buffer, int length)\r\n{\r\nstruct cfe_xiocb xiocb;\r\nxiocb.xiocb_fcode = CFE_CMD_DEV_WRITE;\r\nxiocb.xiocb_status = 0;\r\nxiocb.xiocb_handle = handle;\r\nxiocb.xiocb_flags = 0;\r\nxiocb.xiocb_psize = sizeof(struct xiocb_buffer);\r\nxiocb.plist.xiocb_buffer.buf_offset = offset;\r\nxiocb.plist.xiocb_buffer.buf_ptr = XPTR_FROM_NATIVE(buffer);\r\nxiocb.plist.xiocb_buffer.buf_length = length;\r\ncfe_iocb_dispatch(&xiocb);\r\nif (xiocb.xiocb_status < 0)\r\nreturn xiocb.xiocb_status;\r\nreturn xiocb.plist.xiocb_buffer.buf_retlen;\r\n}

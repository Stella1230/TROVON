static void ath9k_wow_map_triggers(struct ath_softc *sc,\r\nstruct cfg80211_wowlan *wowlan,\r\nu32 *wow_triggers)\r\n{\r\nif (wowlan->disconnect)\r\n*wow_triggers |= AH_WOW_LINK_CHANGE |\r\nAH_WOW_BEACON_MISS;\r\nif (wowlan->magic_pkt)\r\n*wow_triggers |= AH_WOW_MAGIC_PATTERN_EN;\r\nif (wowlan->n_patterns)\r\n*wow_triggers |= AH_WOW_USER_PATTERN_EN;\r\nsc->wow_enabled = *wow_triggers;\r\n}\r\nstatic void ath9k_wow_add_disassoc_deauth_pattern(struct ath_softc *sc)\r\n{\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nint pattern_count = 0;\r\nint i, byte_cnt;\r\nu8 dis_deauth_pattern[MAX_PATTERN_SIZE];\r\nu8 dis_deauth_mask[MAX_PATTERN_SIZE];\r\nmemset(dis_deauth_pattern, 0, MAX_PATTERN_SIZE);\r\nmemset(dis_deauth_mask, 0, MAX_PATTERN_SIZE);\r\nbyte_cnt = 0;\r\nfor (i = 0; i < MAX_PATTERN_MASK_SIZE; i++)\r\ndis_deauth_mask[i] = 0xff;\r\ndis_deauth_pattern[byte_cnt] = 0xa0;\r\nbyte_cnt++;\r\nbyte_cnt += 3;\r\nbyte_cnt += 6;\r\nmemcpy((dis_deauth_pattern + byte_cnt), common->curbssid, ETH_ALEN);\r\nbyte_cnt += 6;\r\nmemcpy((dis_deauth_pattern + byte_cnt), common->curbssid, ETH_ALEN);\r\ndis_deauth_mask[0] = 0xfe;\r\ndis_deauth_mask[1] = 0x03;\r\ndis_deauth_mask[2] = 0xc0;\r\nath_dbg(common, WOW, "Adding disassoc/deauth patterns for WoW\n");\r\nath9k_hw_wow_apply_pattern(ah, dis_deauth_pattern, dis_deauth_mask,\r\npattern_count, byte_cnt);\r\npattern_count++;\r\ndis_deauth_pattern[0] = 0xC0;\r\nath9k_hw_wow_apply_pattern(ah, dis_deauth_pattern, dis_deauth_mask,\r\npattern_count, byte_cnt);\r\n}\r\nstatic void ath9k_wow_add_pattern(struct ath_softc *sc,\r\nstruct cfg80211_wowlan *wowlan)\r\n{\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath9k_wow_pattern *wow_pattern = NULL;\r\nstruct cfg80211_pkt_pattern *patterns = wowlan->patterns;\r\nint mask_len;\r\ns8 i = 0;\r\nif (!wowlan->n_patterns)\r\nreturn;\r\nfor (i = 0; i < wowlan->n_patterns; i++) {\r\nwow_pattern = kzalloc(sizeof(*wow_pattern), GFP_KERNEL);\r\nif (!wow_pattern)\r\nreturn;\r\nmask_len = DIV_ROUND_UP(wowlan->patterns[i].pattern_len, 8);\r\nmemset(wow_pattern->pattern_bytes, 0, MAX_PATTERN_SIZE);\r\nmemset(wow_pattern->mask_bytes, 0, MAX_PATTERN_SIZE);\r\nmemcpy(wow_pattern->pattern_bytes, patterns[i].pattern,\r\npatterns[i].pattern_len);\r\nmemcpy(wow_pattern->mask_bytes, patterns[i].mask, mask_len);\r\nwow_pattern->pattern_len = patterns[i].pattern_len;\r\nath9k_hw_wow_apply_pattern(ah, wow_pattern->pattern_bytes,\r\nwow_pattern->mask_bytes,\r\ni + 2,\r\nwow_pattern->pattern_len);\r\nkfree(wow_pattern);\r\n}\r\n}\r\nint ath9k_suspend(struct ieee80211_hw *hw,\r\nstruct cfg80211_wowlan *wowlan)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 wow_triggers_enabled = 0;\r\nint ret = 0;\r\nath9k_deinit_channel_context(sc);\r\nmutex_lock(&sc->mutex);\r\nath_cancel_work(sc);\r\nath_stop_ani(sc);\r\nif (test_bit(ATH_OP_INVALID, &common->op_flags)) {\r\nath_dbg(common, ANY, "Device not present\n");\r\nret = -EINVAL;\r\ngoto fail_wow;\r\n}\r\nif (WARN_ON(!wowlan)) {\r\nath_dbg(common, WOW, "None of the WoW triggers enabled\n");\r\nret = -EINVAL;\r\ngoto fail_wow;\r\n}\r\nif (!device_can_wakeup(sc->dev)) {\r\nath_dbg(common, WOW, "device_can_wakeup failed, WoW is not enabled\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\nif (!test_bit(ATH_OP_PRIM_STA_VIF, &common->op_flags)) {\r\nath_dbg(common, WOW, "None of the STA vifs are associated\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\nif (sc->cur_chan->nvifs > 1) {\r\nath_dbg(common, WOW, "WoW for multivif is not yet supported\n");\r\nret = 1;\r\ngoto fail_wow;\r\n}\r\nath9k_wow_map_triggers(sc, wowlan, &wow_triggers_enabled);\r\nath_dbg(common, WOW, "WoW triggers enabled 0x%x\n",\r\nwow_triggers_enabled);\r\nath9k_ps_wakeup(sc);\r\nath9k_stop_btcoex(sc);\r\nath9k_wow_add_disassoc_deauth_pattern(sc);\r\nif (wow_triggers_enabled & AH_WOW_USER_PATTERN_EN)\r\nath9k_wow_add_pattern(sc, wowlan);\r\nspin_lock_bh(&sc->sc_pcu_lock);\r\nsc->wow_intr_before_sleep = ah->imask;\r\nah->imask &= ~ATH9K_INT_GLOBAL;\r\nath9k_hw_disable_interrupts(ah);\r\nah->imask = ATH9K_INT_BMISS | ATH9K_INT_GLOBAL;\r\nath9k_hw_set_interrupts(ah);\r\nath9k_hw_enable_interrupts(ah);\r\nspin_unlock_bh(&sc->sc_pcu_lock);\r\nsynchronize_irq(sc->irq);\r\ntasklet_kill(&sc->intr_tq);\r\nath9k_hw_wow_enable(ah, wow_triggers_enabled);\r\nath9k_ps_restore(sc);\r\nath_dbg(common, ANY, "WoW enabled in ath9k\n");\r\natomic_inc(&sc->wow_sleep_proc_intr);\r\nfail_wow:\r\nmutex_unlock(&sc->mutex);\r\nreturn ret;\r\n}\r\nint ath9k_resume(struct ieee80211_hw *hw)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nstruct ath_hw *ah = sc->sc_ah;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 wow_status;\r\nmutex_lock(&sc->mutex);\r\nath9k_ps_wakeup(sc);\r\nspin_lock_bh(&sc->sc_pcu_lock);\r\nath9k_hw_disable_interrupts(ah);\r\nah->imask = sc->wow_intr_before_sleep;\r\nath9k_hw_set_interrupts(ah);\r\nath9k_hw_enable_interrupts(ah);\r\nspin_unlock_bh(&sc->sc_pcu_lock);\r\nwow_status = ath9k_hw_wow_wakeup(ah);\r\nif (atomic_read(&sc->wow_got_bmiss_intr) == 0) {\r\nwow_status |= AH_WOW_BEACON_MISS;\r\natomic_dec(&sc->wow_got_bmiss_intr);\r\nath_dbg(common, ANY, "Beacon miss interrupt picked up during WoW sleep\n");\r\n}\r\natomic_dec(&sc->wow_sleep_proc_intr);\r\nif (wow_status) {\r\nath_dbg(common, ANY, "Waking up due to WoW triggers %s with WoW status = %x\n",\r\nath9k_hw_wow_event_to_string(wow_status), wow_status);\r\n}\r\nath_restart_work(sc);\r\nath9k_start_btcoex(sc);\r\nath9k_ps_restore(sc);\r\nmutex_unlock(&sc->mutex);\r\nreturn 0;\r\n}\r\nvoid ath9k_set_wakeup(struct ieee80211_hw *hw, bool enabled)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nmutex_lock(&sc->mutex);\r\ndevice_init_wakeup(sc->dev, 1);\r\ndevice_set_wakeup_enable(sc->dev, enabled);\r\nmutex_unlock(&sc->mutex);\r\n}\r\nvoid ath9k_init_wow(struct ieee80211_hw *hw)\r\n{\r\nstruct ath_softc *sc = hw->priv;\r\nif ((sc->sc_ah->caps.hw_caps & ATH9K_HW_WOW_DEVICE_CAPABLE) &&\r\n(sc->driver_data & ATH9K_PCI_WOW) &&\r\ndevice_can_wakeup(sc->dev))\r\nhw->wiphy->wowlan = &ath9k_wowlan_support;\r\natomic_set(&sc->wow_sleep_proc_intr, -1);\r\natomic_set(&sc->wow_got_bmiss_intr, -1);\r\n}

static int\r\nnet_open(struct net_device *dev)\r\n{\r\nstruct in_device *in_dev;\r\nhysdn_card *card = dev->ml_priv;\r\nint i;\r\nnetif_start_queue(dev);\r\nif (!card->mac_addr[0]) {\r\nfor (i = 0; i < ETH_ALEN; i++)\r\ndev->dev_addr[i] = 0xfc;\r\nif ((in_dev = dev->ip_ptr) != NULL) {\r\nstruct in_ifaddr *ifa = in_dev->ifa_list;\r\nif (ifa != NULL)\r\nmemcpy(dev->dev_addr + (ETH_ALEN - sizeof(ifa->ifa_local)), &ifa->ifa_local, sizeof(ifa->ifa_local));\r\n}\r\n} else\r\nmemcpy(dev->dev_addr, card->mac_addr, ETH_ALEN);\r\nreturn (0);\r\n}\r\nstatic void\r\nflush_tx_buffers(struct net_local *nl)\r\n{\r\nwhile (nl->sk_count) {\r\ndev_kfree_skb(nl->skbs[nl->out_idx++]);\r\nif (nl->out_idx >= MAX_SKB_BUFFERS)\r\nnl->out_idx = 0;\r\nnl->sk_count--;\r\n}\r\n}\r\nstatic int\r\nnet_close(struct net_device *dev)\r\n{\r\nnetif_stop_queue(dev);\r\nflush_tx_buffers((struct net_local *) dev);\r\nreturn (0);\r\n}\r\nstatic netdev_tx_t\r\nnet_send_packet(struct sk_buff *skb, struct net_device *dev)\r\n{\r\nstruct net_local *lp = (struct net_local *) dev;\r\nspin_lock_irq(&lp->lock);\r\nlp->skbs[lp->in_idx++] = skb;\r\nif (lp->in_idx >= MAX_SKB_BUFFERS)\r\nlp->in_idx = 0;\r\nlp->sk_count++;\r\ndev->trans_start = jiffies;\r\nif (lp->sk_count >= MAX_SKB_BUFFERS)\r\nnetif_stop_queue(dev);\r\nspin_unlock_irq(&lp->lock);\r\nif (lp->sk_count <= 3) {\r\nschedule_work(&((hysdn_card *) dev->ml_priv)->irq_queue);\r\n}\r\nreturn NETDEV_TX_OK;\r\n}\r\nvoid\r\nhysdn_tx_netack(hysdn_card *card)\r\n{\r\nstruct net_local *lp = card->netif;\r\nif (!lp)\r\nreturn;\r\nif (!lp->sk_count)\r\nreturn;\r\nlp->dev->stats.tx_packets++;\r\nlp->dev->stats.tx_bytes += lp->skbs[lp->out_idx]->len;\r\ndev_kfree_skb(lp->skbs[lp->out_idx++]);\r\nif (lp->out_idx >= MAX_SKB_BUFFERS)\r\nlp->out_idx = 0;\r\nif (lp->sk_count-- == MAX_SKB_BUFFERS)\r\nnetif_start_queue((struct net_device *) lp);\r\n}\r\nvoid\r\nhysdn_rx_netpkt(hysdn_card *card, unsigned char *buf, unsigned short len)\r\n{\r\nstruct net_local *lp = card->netif;\r\nstruct net_device *dev;\r\nstruct sk_buff *skb;\r\nif (!lp)\r\nreturn;\r\ndev = lp->dev;\r\ndev->stats.rx_bytes += len;\r\nskb = dev_alloc_skb(len);\r\nif (skb == NULL) {\r\nprintk(KERN_NOTICE "%s: Memory squeeze, dropping packet.\n",\r\ndev->name);\r\ndev->stats.rx_dropped++;\r\nreturn;\r\n}\r\nmemcpy(skb_put(skb, len), buf, len);\r\nskb->protocol = eth_type_trans(skb, dev);\r\ndev->stats.rx_packets++;\r\nnetif_rx(skb);\r\n}\r\nstruct sk_buff *\r\nhysdn_tx_netget(hysdn_card *card)\r\n{\r\nstruct net_local *lp = card->netif;\r\nif (!lp)\r\nreturn (NULL);\r\nif (!lp->sk_count)\r\nreturn (NULL);\r\nreturn (lp->skbs[lp->out_idx]);\r\n}\r\nint\r\nhysdn_net_create(hysdn_card *card)\r\n{\r\nstruct net_device *dev;\r\nint i;\r\nstruct net_local *lp;\r\nif (!card) {\r\nprintk(KERN_WARNING "No card-pt in hysdn_net_create!\n");\r\nreturn (-ENOMEM);\r\n}\r\nhysdn_net_release(card);\r\ndev = alloc_etherdev(sizeof(struct net_local));\r\nif (!dev) {\r\nprintk(KERN_WARNING "HYSDN: unable to allocate mem\n");\r\nreturn (-ENOMEM);\r\n}\r\nlp = netdev_priv(dev);\r\nlp->dev = dev;\r\ndev->netdev_ops = &hysdn_netdev_ops;\r\nspin_lock_init(&((struct net_local *) dev)->lock);\r\ndev->base_addr = card->iobase;\r\ndev->irq = card->irq;\r\ndev->netdev_ops = &hysdn_netdev_ops;\r\nif ((i = register_netdev(dev))) {\r\nprintk(KERN_WARNING "HYSDN: unable to create network device\n");\r\nfree_netdev(dev);\r\nreturn (i);\r\n}\r\ndev->ml_priv = card;\r\ncard->netif = dev;\r\nif (card->debug_flags & LOG_NET_INIT)\r\nhysdn_addlog(card, "network device created");\r\nreturn (0);\r\n}\r\nint\r\nhysdn_net_release(hysdn_card *card)\r\n{\r\nstruct net_device *dev = card->netif;\r\nif (!dev)\r\nreturn (0);\r\ncard->netif = NULL;\r\nnet_close(dev);\r\nflush_tx_buffers((struct net_local *) dev);\r\nunregister_netdev(dev);\r\nfree_netdev(dev);\r\nif (card->debug_flags & LOG_NET_INIT)\r\nhysdn_addlog(card, "network device deleted");\r\nreturn (0);\r\n}\r\nchar *\r\nhysdn_net_getname(hysdn_card *card)\r\n{\r\nstruct net_device *dev = card->netif;\r\nif (!dev)\r\nreturn ("-");\r\nreturn (dev->name);\r\n}

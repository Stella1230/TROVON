static void set_data(char *field, char *data)\r\n{\r\nmemset(field, ' ', CPI_LENGTH_NAME);\r\nmemcpy(field, data, strlen(data));\r\nsclp_ascebc_str(field, CPI_LENGTH_NAME);\r\n}\r\nstatic void cpi_callback(struct sclp_req *req, void *data)\r\n{\r\nstruct completion *completion = data;\r\ncomplete(completion);\r\n}\r\nstatic struct sclp_req *cpi_prepare_req(void)\r\n{\r\nstruct sclp_req *req;\r\nstruct cpi_sccb *sccb;\r\nstruct cpi_evbuf *evb;\r\nreq = kzalloc(sizeof(struct sclp_req), GFP_KERNEL);\r\nif (!req)\r\nreturn ERR_PTR(-ENOMEM);\r\nsccb = (struct cpi_sccb *) get_zeroed_page(GFP_KERNEL | GFP_DMA);\r\nif (!sccb) {\r\nkfree(req);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\nsccb->header.length = sizeof(struct cpi_sccb);\r\nsccb->cpi_evbuf.header.length = sizeof(struct cpi_evbuf);\r\nsccb->cpi_evbuf.header.type = 0x0b;\r\nevb = &sccb->cpi_evbuf;\r\nset_data(evb->system_type, system_type);\r\nset_data(evb->system_name, system_name);\r\nevb->system_level = system_level;\r\nset_data(evb->sysplex_name, sysplex_name);\r\nreq->command = SCLP_CMDW_WRITE_EVENT_DATA;\r\nreq->sccb = sccb;\r\nreq->status = SCLP_REQ_FILLED;\r\nreq->callback = cpi_callback;\r\nreturn req;\r\n}\r\nstatic void cpi_free_req(struct sclp_req *req)\r\n{\r\nfree_page((unsigned long) req->sccb);\r\nkfree(req);\r\n}\r\nstatic int cpi_req(void)\r\n{\r\nstruct completion completion;\r\nstruct sclp_req *req;\r\nint rc;\r\nint response;\r\nrc = sclp_register(&sclp_cpi_event);\r\nif (rc)\r\ngoto out;\r\nif (!(sclp_cpi_event.sclp_receive_mask & EVTYP_CTLPROGIDENT_MASK)) {\r\nrc = -EOPNOTSUPP;\r\ngoto out_unregister;\r\n}\r\nreq = cpi_prepare_req();\r\nif (IS_ERR(req)) {\r\nrc = PTR_ERR(req);\r\ngoto out_unregister;\r\n}\r\ninit_completion(&completion);\r\nreq->callback_data = &completion;\r\nrc = sclp_add_request(req);\r\nif (rc)\r\ngoto out_free_req;\r\nwait_for_completion(&completion);\r\nif (req->status != SCLP_REQ_DONE) {\r\npr_warning("request failed (status=0x%02x)\n",\r\nreq->status);\r\nrc = -EIO;\r\ngoto out_free_req;\r\n}\r\nresponse = ((struct cpi_sccb *) req->sccb)->header.response_code;\r\nif (response != 0x0020) {\r\npr_warning("request failed with response code 0x%x\n",\r\nresponse);\r\nrc = -EIO;\r\n}\r\nout_free_req:\r\ncpi_free_req(req);\r\nout_unregister:\r\nsclp_unregister(&sclp_cpi_event);\r\nout:\r\nreturn rc;\r\n}\r\nstatic int check_string(const char *attr, const char *str)\r\n{\r\nsize_t len;\r\nsize_t i;\r\nlen = strlen(str);\r\nif ((len > 0) && (str[len - 1] == '\n'))\r\nlen--;\r\nif (len > CPI_LENGTH_NAME)\r\nreturn -EINVAL;\r\nfor (i = 0; i < len ; i++) {\r\nif (isalpha(str[i]) || isdigit(str[i]) ||\r\nstrchr("$@# ", str[i]))\r\ncontinue;\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void set_string(char *attr, const char *value)\r\n{\r\nsize_t len;\r\nsize_t i;\r\nlen = strlen(value);\r\nif ((len > 0) && (value[len - 1] == '\n'))\r\nlen--;\r\nfor (i = 0; i < CPI_LENGTH_NAME; i++) {\r\nif (i < len)\r\nattr[i] = toupper(value[i]);\r\nelse\r\nattr[i] = ' ';\r\n}\r\n}\r\nstatic ssize_t system_name_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *page)\r\n{\r\nint rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nrc = snprintf(page, PAGE_SIZE, "%s\n", system_name);\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn rc;\r\n}\r\nstatic ssize_t system_name_store(struct kobject *kobj,\r\nstruct kobj_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nint rc;\r\nrc = check_string("system_name", buf);\r\nif (rc)\r\nreturn rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nset_string(system_name, buf);\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn len;\r\n}\r\nstatic ssize_t sysplex_name_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *page)\r\n{\r\nint rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nrc = snprintf(page, PAGE_SIZE, "%s\n", sysplex_name);\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn rc;\r\n}\r\nstatic ssize_t sysplex_name_store(struct kobject *kobj,\r\nstruct kobj_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nint rc;\r\nrc = check_string("sysplex_name", buf);\r\nif (rc)\r\nreturn rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nset_string(sysplex_name, buf);\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn len;\r\n}\r\nstatic ssize_t system_type_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *page)\r\n{\r\nint rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nrc = snprintf(page, PAGE_SIZE, "%s\n", system_type);\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn rc;\r\n}\r\nstatic ssize_t system_type_store(struct kobject *kobj,\r\nstruct kobj_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nint rc;\r\nrc = check_string("system_type", buf);\r\nif (rc)\r\nreturn rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nset_string(system_type, buf);\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn len;\r\n}\r\nstatic ssize_t system_level_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *page)\r\n{\r\nunsigned long long level;\r\nmutex_lock(&sclp_cpi_mutex);\r\nlevel = system_level;\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn snprintf(page, PAGE_SIZE, "%#018llx\n", level);\r\n}\r\nstatic ssize_t system_level_store(struct kobject *kobj,\r\nstruct kobj_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nunsigned long long level;\r\nchar *endp;\r\nlevel = simple_strtoull(buf, &endp, 16);\r\nif (endp == buf)\r\nreturn -EINVAL;\r\nif (*endp == '\n')\r\nendp++;\r\nif (*endp)\r\nreturn -EINVAL;\r\nmutex_lock(&sclp_cpi_mutex);\r\nsystem_level = level;\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn len;\r\n}\r\nstatic ssize_t set_store(struct kobject *kobj,\r\nstruct kobj_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nint rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nrc = cpi_req();\r\nmutex_unlock(&sclp_cpi_mutex);\r\nif (rc)\r\nreturn rc;\r\nreturn len;\r\n}\r\nint sclp_cpi_set_data(const char *system, const char *sysplex, const char *type,\r\nconst u64 level)\r\n{\r\nint rc;\r\nrc = check_string("system_name", system);\r\nif (rc)\r\nreturn rc;\r\nrc = check_string("sysplex_name", sysplex);\r\nif (rc)\r\nreturn rc;\r\nrc = check_string("system_type", type);\r\nif (rc)\r\nreturn rc;\r\nmutex_lock(&sclp_cpi_mutex);\r\nset_string(system_name, system);\r\nset_string(sysplex_name, sysplex);\r\nset_string(system_type, type);\r\nsystem_level = level;\r\nrc = cpi_req();\r\nmutex_unlock(&sclp_cpi_mutex);\r\nreturn rc;\r\n}\r\nstatic int __init cpi_init(void)\r\n{\r\nint rc;\r\ncpi_kset = kset_create_and_add("cpi", NULL, firmware_kobj);\r\nif (!cpi_kset)\r\nreturn -ENOMEM;\r\nrc = sysfs_create_group(&cpi_kset->kobj, &cpi_attr_group);\r\nif (rc)\r\nkset_unregister(cpi_kset);\r\nreturn rc;\r\n}

int cpu_suspend(unsigned long arg, int (*fn)(unsigned long))\r\n{\r\nstruct mm_struct *mm = current->active_mm;\r\nu32 __mpidr = cpu_logical_map(smp_processor_id());\r\nint ret;\r\nif (!idmap_pgd)\r\nreturn -EINVAL;\r\nret = __cpu_suspend(arg, fn, __mpidr);\r\nif (ret == 0) {\r\ncpu_switch_mm(mm->pgd, mm);\r\nlocal_flush_bp_all();\r\nlocal_flush_tlb_all();\r\n}\r\nreturn ret;\r\n}\r\nint cpu_suspend(unsigned long arg, int (*fn)(unsigned long))\r\n{\r\nu32 __mpidr = cpu_logical_map(smp_processor_id());\r\nreturn __cpu_suspend(arg, fn, __mpidr);\r\n}\r\nvoid __cpu_suspend_save(u32 *ptr, u32 ptrsz, u32 sp, u32 *save_ptr)\r\n{\r\nu32 *ctx = ptr;\r\n*save_ptr = virt_to_phys(ptr);\r\n*ptr++ = virt_to_phys(idmap_pgd);\r\n*ptr++ = sp;\r\n*ptr++ = virt_to_phys(cpu_do_resume);\r\ncpu_do_suspend(ptr);\r\nflush_cache_louis();\r\n__cpuc_flush_dcache_area(ctx, ptrsz);\r\n__cpuc_flush_dcache_area(save_ptr, sizeof(*save_ptr));\r\nouter_clean_range(*save_ptr, *save_ptr + ptrsz);\r\nouter_clean_range(virt_to_phys(save_ptr),\r\nvirt_to_phys(save_ptr) + sizeof(*save_ptr));\r\n}\r\nstatic int cpu_suspend_alloc_sp(void)\r\n{\r\nvoid *ctx_ptr;\r\nctx_ptr = kcalloc(mpidr_hash_size(), sizeof(u32), GFP_KERNEL);\r\nif (WARN_ON(!ctx_ptr))\r\nreturn -ENOMEM;\r\nsleep_save_sp.save_ptr_stash = ctx_ptr;\r\nsleep_save_sp.save_ptr_stash_phys = virt_to_phys(ctx_ptr);\r\nsync_cache_w(&sleep_save_sp);\r\nreturn 0;\r\n}

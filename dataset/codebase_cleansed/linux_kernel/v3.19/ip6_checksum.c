__sum16 csum_ipv6_magic(const struct in6_addr *saddr,\r\nconst struct in6_addr *daddr,\r\n__u32 len, unsigned short proto,\r\n__wsum csum)\r\n{\r\nint carry;\r\n__u32 ulen;\r\n__u32 uproto;\r\n__u32 sum = (__force u32)csum;\r\nsum += (__force u32)saddr->s6_addr32[0];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[0]);\r\nsum += carry;\r\nsum += (__force u32)saddr->s6_addr32[1];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[1]);\r\nsum += carry;\r\nsum += (__force u32)saddr->s6_addr32[2];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[2]);\r\nsum += carry;\r\nsum += (__force u32)saddr->s6_addr32[3];\r\ncarry = (sum < (__force u32)saddr->s6_addr32[3]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[0];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[0]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[1];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[1]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[2];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[2]);\r\nsum += carry;\r\nsum += (__force u32)daddr->s6_addr32[3];\r\ncarry = (sum < (__force u32)daddr->s6_addr32[3]);\r\nsum += carry;\r\nulen = (__force u32)htonl((__u32) len);\r\nsum += ulen;\r\ncarry = (sum < ulen);\r\nsum += carry;\r\nuproto = (__force u32)htonl(proto);\r\nsum += uproto;\r\ncarry = (sum < uproto);\r\nsum += carry;\r\nreturn csum_fold((__force __wsum)sum);\r\n}\r\nint udp6_csum_init(struct sk_buff *skb, struct udphdr *uh, int proto)\r\n{\r\nint err;\r\nUDP_SKB_CB(skb)->partial_cov = 0;\r\nUDP_SKB_CB(skb)->cscov = skb->len;\r\nif (proto == IPPROTO_UDPLITE) {\r\nerr = udplite_checksum_init(skb, uh);\r\nif (err)\r\nreturn err;\r\n}\r\nreturn skb_checksum_init_zero_check(skb, proto, uh->check,\r\nip6_compute_pseudo);\r\n}\r\nvoid udp6_set_csum(bool nocheck, struct sk_buff *skb,\r\nconst struct in6_addr *saddr,\r\nconst struct in6_addr *daddr, int len)\r\n{\r\nstruct udphdr *uh = udp_hdr(skb);\r\nif (nocheck)\r\nuh->check = 0;\r\nelse if (skb_is_gso(skb))\r\nuh->check = ~udp_v6_check(len, saddr, daddr, 0);\r\nelse if (skb_dst(skb) && skb_dst(skb)->dev &&\r\n(skb_dst(skb)->dev->features & NETIF_F_IPV6_CSUM)) {\r\nBUG_ON(skb->ip_summed == CHECKSUM_PARTIAL);\r\nskb->ip_summed = CHECKSUM_PARTIAL;\r\nskb->csum_start = skb_transport_header(skb) - skb->head;\r\nskb->csum_offset = offsetof(struct udphdr, check);\r\nuh->check = ~udp_v6_check(len, saddr, daddr, 0);\r\n} else {\r\n__wsum csum;\r\nBUG_ON(skb->ip_summed == CHECKSUM_PARTIAL);\r\nuh->check = 0;\r\ncsum = skb_checksum(skb, 0, len, 0);\r\nuh->check = udp_v6_check(len, saddr, daddr, csum);\r\nif (uh->check == 0)\r\nuh->check = CSUM_MANGLED_0;\r\nskb->ip_summed = CHECKSUM_UNNECESSARY;\r\n}\r\n}

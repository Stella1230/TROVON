static\r\nu32 rproc_elf_get_boot_addr(struct rproc *rproc, const struct firmware *fw)\r\n{\r\nstruct elf32_hdr *ehdr = (struct elf32_hdr *)fw->data;\r\nreturn ehdr->e_entry;\r\n}\r\nstatic int\r\nrproc_elf_load_segments(struct rproc *rproc, const struct firmware *fw)\r\n{\r\nstruct device *dev = &rproc->dev;\r\nstruct elf32_hdr *ehdr;\r\nstruct elf32_phdr *phdr;\r\nint i, ret = 0;\r\nconst u8 *elf_data = fw->data;\r\nehdr = (struct elf32_hdr *)elf_data;\r\nphdr = (struct elf32_phdr *)(elf_data + ehdr->e_phoff);\r\nfor (i = 0; i < ehdr->e_phnum; i++, phdr++) {\r\nu32 da = phdr->p_paddr;\r\nu32 memsz = phdr->p_memsz;\r\nu32 filesz = phdr->p_filesz;\r\nu32 offset = phdr->p_offset;\r\nvoid *ptr;\r\nif (phdr->p_type != PT_LOAD)\r\ncontinue;\r\ndev_dbg(dev, "phdr: type %d da 0x%x memsz 0x%x filesz 0x%x\n",\r\nphdr->p_type, da, memsz, filesz);\r\nif (filesz > memsz) {\r\ndev_err(dev, "bad phdr filesz 0x%x memsz 0x%x\n",\r\nfilesz, memsz);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (offset + filesz > fw->size) {\r\ndev_err(dev, "truncated fw: need 0x%x avail 0x%zx\n",\r\noffset + filesz, fw->size);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nptr = rproc_da_to_va(rproc, da, memsz);\r\nif (!ptr) {\r\ndev_err(dev, "bad phdr da 0x%x mem 0x%x\n", da, memsz);\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nif (phdr->p_filesz)\r\nmemcpy(ptr, elf_data + phdr->p_offset, filesz);\r\nif (memsz > filesz)\r\nmemset(ptr + filesz, 0, memsz - filesz);\r\n}\r\nreturn ret;\r\n}\r\nstatic struct elf32_shdr *\r\nfind_table(struct device *dev, struct elf32_hdr *ehdr, size_t fw_size)\r\n{\r\nstruct elf32_shdr *shdr;\r\nint i;\r\nconst char *name_table;\r\nstruct resource_table *table = NULL;\r\nconst u8 *elf_data = (void *)ehdr;\r\nshdr = (struct elf32_shdr *)(elf_data + ehdr->e_shoff);\r\nname_table = elf_data + shdr[ehdr->e_shstrndx].sh_offset;\r\nfor (i = 0; i < ehdr->e_shnum; i++, shdr++) {\r\nu32 size = shdr->sh_size;\r\nu32 offset = shdr->sh_offset;\r\nif (strcmp(name_table + shdr->sh_name, ".resource_table"))\r\ncontinue;\r\ntable = (struct resource_table *)(elf_data + offset);\r\nif (offset + size > fw_size || offset + size < size) {\r\ndev_err(dev, "resource table truncated\n");\r\nreturn NULL;\r\n}\r\nif (sizeof(struct resource_table) > size) {\r\ndev_err(dev, "header-less resource table\n");\r\nreturn NULL;\r\n}\r\nif (table->ver != 1) {\r\ndev_err(dev, "unsupported fw ver: %d\n", table->ver);\r\nreturn NULL;\r\n}\r\nif (table->reserved[0] || table->reserved[1]) {\r\ndev_err(dev, "non zero reserved bytes\n");\r\nreturn NULL;\r\n}\r\nif (table->num * sizeof(table->offset[0]) +\r\nsizeof(struct resource_table) > size) {\r\ndev_err(dev, "resource table incomplete\n");\r\nreturn NULL;\r\n}\r\nreturn shdr;\r\n}\r\nreturn NULL;\r\n}\r\nstatic struct resource_table *\r\nrproc_elf_find_rsc_table(struct rproc *rproc, const struct firmware *fw,\r\nint *tablesz)\r\n{\r\nstruct elf32_hdr *ehdr;\r\nstruct elf32_shdr *shdr;\r\nstruct device *dev = &rproc->dev;\r\nstruct resource_table *table = NULL;\r\nconst u8 *elf_data = fw->data;\r\nehdr = (struct elf32_hdr *)elf_data;\r\nshdr = find_table(dev, ehdr, fw->size);\r\nif (!shdr)\r\nreturn NULL;\r\ntable = (struct resource_table *)(elf_data + shdr->sh_offset);\r\n*tablesz = shdr->sh_size;\r\nreturn table;\r\n}\r\nstatic struct resource_table *\r\nrproc_elf_find_loaded_rsc_table(struct rproc *rproc, const struct firmware *fw)\r\n{\r\nstruct elf32_hdr *ehdr = (struct elf32_hdr *)fw->data;\r\nstruct elf32_shdr *shdr;\r\nshdr = find_table(&rproc->dev, ehdr, fw->size);\r\nif (!shdr)\r\nreturn NULL;\r\nreturn rproc_da_to_va(rproc, shdr->sh_addr, shdr->sh_size);\r\n}

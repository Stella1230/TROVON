static inline void memblock_physmem_add(phys_addr_t start, phys_addr_t size)\r\n{\r\nmemblock_add_range(&memblock.memory, start, size, 0, 0);\r\nmemblock_add_range(&memblock.physmem, start, size, 0, 0);\r\n}\r\nvoid __init detect_memory_memblock(void)\r\n{\r\nunsigned long long memsize, rnmax, rzm;\r\nunsigned long addr, size;\r\nint type;\r\nrzm = sclp_get_rzm();\r\nrnmax = sclp_get_rnmax();\r\nmemsize = rzm * rnmax;\r\nif (!rzm)\r\nrzm = 1ULL << 17;\r\nif (IS_ENABLED(CONFIG_32BIT)) {\r\nrzm = min(ADDR2G, rzm);\r\nmemsize = min(ADDR2G, memsize);\r\n}\r\nmax_physmem_end = memsize;\r\naddr = 0;\r\nmemblock_set_bottom_up(true);\r\ndo {\r\nsize = 0;\r\ntype = tprot(addr);\r\ndo {\r\nsize += rzm;\r\nif (max_physmem_end && addr + size >= max_physmem_end)\r\nbreak;\r\n} while (type == tprot(addr + size));\r\nif (type == CHUNK_READ_WRITE || type == CHUNK_READ_ONLY) {\r\nif (max_physmem_end && (addr + size > max_physmem_end))\r\nsize = max_physmem_end - addr;\r\nmemblock_physmem_add(addr, size);\r\n}\r\naddr += size;\r\n} while (addr < max_physmem_end);\r\nmemblock_set_bottom_up(false);\r\nif (!max_physmem_end)\r\nmax_physmem_end = memblock_end_of_DRAM();\r\n}

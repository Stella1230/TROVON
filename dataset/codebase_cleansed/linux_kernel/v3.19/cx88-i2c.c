static void cx8800_bit_setscl(void *data, int state)\r\n{\r\nstruct cx88_core *core = data;\r\nif (state)\r\ncore->i2c_state |= 0x02;\r\nelse\r\ncore->i2c_state &= ~0x02;\r\ncx_write(MO_I2C, core->i2c_state);\r\ncx_read(MO_I2C);\r\n}\r\nstatic void cx8800_bit_setsda(void *data, int state)\r\n{\r\nstruct cx88_core *core = data;\r\nif (state)\r\ncore->i2c_state |= 0x01;\r\nelse\r\ncore->i2c_state &= ~0x01;\r\ncx_write(MO_I2C, core->i2c_state);\r\ncx_read(MO_I2C);\r\n}\r\nstatic int cx8800_bit_getscl(void *data)\r\n{\r\nstruct cx88_core *core = data;\r\nu32 state;\r\nstate = cx_read(MO_I2C);\r\nreturn state & 0x02 ? 1 : 0;\r\n}\r\nstatic int cx8800_bit_getsda(void *data)\r\n{\r\nstruct cx88_core *core = data;\r\nu32 state;\r\nstate = cx_read(MO_I2C);\r\nreturn state & 0x01;\r\n}\r\nstatic void do_i2c_scan(const char *name, struct i2c_client *c)\r\n{\r\nunsigned char buf;\r\nint i,rc;\r\nfor (i = 0; i < ARRAY_SIZE(i2c_devs); i++) {\r\nc->addr = i;\r\nrc = i2c_master_recv(c,&buf,0);\r\nif (rc < 0)\r\ncontinue;\r\nprintk("%s: i2c scan: found device @ 0x%x [%s]\n",\r\nname, i << 1, i2c_devs[i] ? i2c_devs[i] : "???");\r\n}\r\n}\r\nint cx88_i2c_init(struct cx88_core *core, struct pci_dev *pci)\r\n{\r\nif (i2c_udelay<5)\r\ni2c_udelay=5;\r\ncore->i2c_algo = cx8800_i2c_algo_template;\r\ncore->i2c_adap.dev.parent = &pci->dev;\r\nstrlcpy(core->i2c_adap.name,core->name,sizeof(core->i2c_adap.name));\r\ncore->i2c_adap.owner = THIS_MODULE;\r\ncore->i2c_algo.udelay = i2c_udelay;\r\ncore->i2c_algo.data = core;\r\ni2c_set_adapdata(&core->i2c_adap, &core->v4l2_dev);\r\ncore->i2c_adap.algo_data = &core->i2c_algo;\r\ncore->i2c_client.adapter = &core->i2c_adap;\r\nstrlcpy(core->i2c_client.name, "cx88xx internal", I2C_NAME_SIZE);\r\ncx8800_bit_setscl(core,1);\r\ncx8800_bit_setsda(core,1);\r\ncore->i2c_rc = i2c_bit_add_bus(&core->i2c_adap);\r\nif (0 == core->i2c_rc) {\r\nstatic u8 tuner_data[] =\r\n{ 0x0b, 0xdc, 0x86, 0x52 };\r\nstatic struct i2c_msg tuner_msg =\r\n{ .flags = 0, .addr = 0xc2 >> 1, .buf = tuner_data, .len = 4 };\r\ndprintk(1, "i2c register ok\n");\r\nswitch( core->boardnr ) {\r\ncase CX88_BOARD_HAUPPAUGE_HVR1300:\r\ncase CX88_BOARD_HAUPPAUGE_HVR3000:\r\ncase CX88_BOARD_HAUPPAUGE_HVR4000:\r\nprintk("%s: i2c init: enabling analog demod on HVR1300/3000/4000 tuner\n",\r\ncore->name);\r\ni2c_transfer(core->i2c_client.adapter, &tuner_msg, 1);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (i2c_scan)\r\ndo_i2c_scan(core->name,&core->i2c_client);\r\n} else\r\nprintk("%s: i2c register FAILED\n", core->name);\r\nreturn core->i2c_rc;\r\n}

static int dm_ulog_sendto_server(struct dm_ulog_request *tfr)\r\n{\r\nint r;\r\nstruct cn_msg *msg = prealloced_cn_msg;\r\nmemset(msg, 0, sizeof(struct cn_msg));\r\nmsg->id.idx = ulog_cn_id.idx;\r\nmsg->id.val = ulog_cn_id.val;\r\nmsg->ack = 0;\r\nmsg->seq = tfr->seq;\r\nmsg->len = sizeof(struct dm_ulog_request) + tfr->data_size;\r\nr = cn_netlink_send(msg, 0, 0, gfp_any());\r\nreturn r;\r\n}\r\nstatic int fill_pkg(struct cn_msg *msg, struct dm_ulog_request *tfr)\r\n{\r\nuint32_t rtn_seq = (msg) ? msg->seq : (tfr) ? tfr->seq : 0;\r\nstruct receiving_pkg *pkg;\r\nlist_for_each_entry(pkg, &receiving_list, list) {\r\nif (rtn_seq != pkg->seq)\r\ncontinue;\r\nif (msg) {\r\npkg->error = -msg->ack;\r\nif (pkg->error != -EAGAIN)\r\n*(pkg->data_size) = 0;\r\n} else if (tfr->data_size > *(pkg->data_size)) {\r\nDMERR("Insufficient space to receive package [%u] "\r\n"(%u vs %zu)", tfr->request_type,\r\ntfr->data_size, *(pkg->data_size));\r\n*(pkg->data_size) = 0;\r\npkg->error = -ENOSPC;\r\n} else {\r\npkg->error = tfr->error;\r\nmemcpy(pkg->data, tfr->data, tfr->data_size);\r\n*(pkg->data_size) = tfr->data_size;\r\n}\r\ncomplete(&pkg->complete);\r\nreturn 0;\r\n}\r\nreturn -ENOENT;\r\n}\r\nstatic void cn_ulog_callback(struct cn_msg *msg, struct netlink_skb_parms *nsp)\r\n{\r\nstruct dm_ulog_request *tfr = (struct dm_ulog_request *)(msg + 1);\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn;\r\nspin_lock(&receiving_list_lock);\r\nif (msg->len == 0)\r\nfill_pkg(msg, NULL);\r\nelse if (msg->len < sizeof(*tfr))\r\nDMERR("Incomplete message received (expected %u, got %u): [%u]",\r\n(unsigned)sizeof(*tfr), msg->len, msg->seq);\r\nelse\r\nfill_pkg(NULL, tfr);\r\nspin_unlock(&receiving_list_lock);\r\n}\r\nint dm_consult_userspace(const char *uuid, uint64_t luid, int request_type,\r\nchar *data, size_t data_size,\r\nchar *rdata, size_t *rdata_size)\r\n{\r\nint r = 0;\r\nsize_t dummy = 0;\r\nint overhead_size = sizeof(struct dm_ulog_request) + sizeof(struct cn_msg);\r\nstruct dm_ulog_request *tfr = prealloced_ulog_tfr;\r\nstruct receiving_pkg pkg;\r\nif (data_size > (DM_ULOG_PREALLOCED_SIZE - overhead_size)) {\r\nDMINFO("Size of tfr exceeds preallocated size");\r\nreturn -EINVAL;\r\n}\r\nif (!rdata_size)\r\nrdata_size = &dummy;\r\nresend:\r\nmutex_lock(&dm_ulog_lock);\r\nmemset(tfr, 0, DM_ULOG_PREALLOCED_SIZE - sizeof(struct cn_msg));\r\nmemcpy(tfr->uuid, uuid, DM_UUID_LEN);\r\ntfr->version = DM_ULOG_REQUEST_VERSION;\r\ntfr->luid = luid;\r\ntfr->seq = dm_ulog_seq++;\r\ntfr->request_type = request_type & DM_ULOG_REQUEST_MASK;\r\ntfr->data_size = data_size;\r\nif (data && data_size)\r\nmemcpy(tfr->data, data, data_size);\r\nmemset(&pkg, 0, sizeof(pkg));\r\ninit_completion(&pkg.complete);\r\npkg.seq = tfr->seq;\r\npkg.data_size = rdata_size;\r\npkg.data = rdata;\r\nspin_lock(&receiving_list_lock);\r\nlist_add(&(pkg.list), &receiving_list);\r\nspin_unlock(&receiving_list_lock);\r\nr = dm_ulog_sendto_server(tfr);\r\nmutex_unlock(&dm_ulog_lock);\r\nif (r) {\r\nDMERR("Unable to send log request [%u] to userspace: %d",\r\nrequest_type, r);\r\nspin_lock(&receiving_list_lock);\r\nlist_del_init(&(pkg.list));\r\nspin_unlock(&receiving_list_lock);\r\ngoto out;\r\n}\r\nr = wait_for_completion_timeout(&(pkg.complete), DM_ULOG_RETRY_TIMEOUT);\r\nspin_lock(&receiving_list_lock);\r\nlist_del_init(&(pkg.list));\r\nspin_unlock(&receiving_list_lock);\r\nif (!r) {\r\nDMWARN("[%s] Request timed out: [%u/%u] - retrying",\r\n(strlen(uuid) > 8) ?\r\n(uuid + (strlen(uuid) - 8)) : (uuid),\r\nrequest_type, pkg.seq);\r\ngoto resend;\r\n}\r\nr = pkg.error;\r\nif (r == -EAGAIN)\r\ngoto resend;\r\nout:\r\nreturn r;\r\n}\r\nint dm_ulog_tfr_init(void)\r\n{\r\nint r;\r\nvoid *prealloced;\r\nINIT_LIST_HEAD(&receiving_list);\r\nprealloced = kmalloc(DM_ULOG_PREALLOCED_SIZE, GFP_KERNEL);\r\nif (!prealloced)\r\nreturn -ENOMEM;\r\nprealloced_cn_msg = prealloced;\r\nprealloced_ulog_tfr = prealloced + sizeof(struct cn_msg);\r\nr = cn_add_callback(&ulog_cn_id, "dmlogusr", cn_ulog_callback);\r\nif (r) {\r\nkfree(prealloced_cn_msg);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nvoid dm_ulog_tfr_exit(void)\r\n{\r\ncn_del_callback(&ulog_cn_id);\r\nkfree(prealloced_cn_msg);\r\n}

static int snd_cs4231_match(struct device *dev, unsigned int n)\r\n{\r\nif (!enable[n])\r\nreturn 0;\r\nif (port[n] == SNDRV_AUTO_PORT) {\r\ndev_err(dev, "please specify port\n");\r\nreturn 0;\r\n}\r\nif (irq[n] == SNDRV_AUTO_IRQ) {\r\ndev_err(dev, "please specify irq\n");\r\nreturn 0;\r\n}\r\nif (dma1[n] == SNDRV_AUTO_DMA) {\r\ndev_err(dev, "please specify dma1\n");\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int snd_cs4231_probe(struct device *dev, unsigned int n)\r\n{\r\nstruct snd_card *card;\r\nstruct snd_wss *chip;\r\nstruct snd_pcm *pcm;\r\nint error;\r\nerror = snd_card_new(dev, index[n], id[n], THIS_MODULE, 0, &card);\r\nif (error < 0)\r\nreturn error;\r\nerror = snd_wss_create(card, port[n], -1, irq[n], dma1[n], dma2[n],\r\nWSS_HW_DETECT, 0, &chip);\r\nif (error < 0)\r\ngoto out;\r\ncard->private_data = chip;\r\nerror = snd_wss_pcm(chip, 0, &pcm);\r\nif (error < 0)\r\ngoto out;\r\nstrcpy(card->driver, "CS4231");\r\nstrcpy(card->shortname, pcm->name);\r\nsprintf(card->longname, "%s at 0x%lx, irq %d, dma %d",\r\npcm->name, chip->port, irq[n], dma1[n]);\r\nif (dma2[n] >= 0)\r\nsprintf(card->longname + strlen(card->longname), "&%d", dma2[n]);\r\nerror = snd_wss_mixer(chip);\r\nif (error < 0)\r\ngoto out;\r\nerror = snd_wss_timer(chip, 0, NULL);\r\nif (error < 0)\r\ngoto out;\r\nif (mpu_port[n] > 0 && mpu_port[n] != SNDRV_AUTO_PORT) {\r\nif (mpu_irq[n] == SNDRV_AUTO_IRQ)\r\nmpu_irq[n] = -1;\r\nif (snd_mpu401_uart_new(card, 0, MPU401_HW_CS4232,\r\nmpu_port[n], 0, mpu_irq[n],\r\nNULL) < 0)\r\ndev_warn(dev, "MPU401 not detected\n");\r\n}\r\nerror = snd_card_register(card);\r\nif (error < 0)\r\ngoto out;\r\ndev_set_drvdata(dev, card);\r\nreturn 0;\r\nout: snd_card_free(card);\r\nreturn error;\r\n}\r\nstatic int snd_cs4231_remove(struct device *dev, unsigned int n)\r\n{\r\nsnd_card_free(dev_get_drvdata(dev));\r\nreturn 0;\r\n}\r\nstatic int snd_cs4231_suspend(struct device *dev, unsigned int n, pm_message_t state)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_wss *chip = card->private_data;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nchip->suspend(chip);\r\nreturn 0;\r\n}\r\nstatic int snd_cs4231_resume(struct device *dev, unsigned int n)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct snd_wss *chip = card->private_data;\r\nchip->resume(chip);\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}\r\nstatic int __init alsa_card_cs4231_init(void)\r\n{\r\nreturn isa_register_driver(&snd_cs4231_driver, SNDRV_CARDS);\r\n}\r\nstatic void __exit alsa_card_cs4231_exit(void)\r\n{\r\nisa_unregister_driver(&snd_cs4231_driver);\r\n}

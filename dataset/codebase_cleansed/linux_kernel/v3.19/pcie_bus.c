void wil_disable_irq(struct wil6210_priv *wil)\r\n{\r\nint irq = wil->pdev->irq;\r\ndisable_irq(irq);\r\nif (wil->n_msi == 3) {\r\ndisable_irq(irq + 1);\r\ndisable_irq(irq + 2);\r\n}\r\n}\r\nvoid wil_enable_irq(struct wil6210_priv *wil)\r\n{\r\nint irq = wil->pdev->irq;\r\nenable_irq(irq);\r\nif (wil->n_msi == 3) {\r\nenable_irq(irq + 1);\r\nenable_irq(irq + 2);\r\n}\r\n}\r\nstatic int wil_if_pcie_enable(struct wil6210_priv *wil)\r\n{\r\nstruct pci_dev *pdev = wil->pdev;\r\nint rc;\r\nint msi_only = pdev->msi_enabled;\r\nwil_dbg_misc(wil, "%s()\n", __func__);\r\npdev->msi_enabled = 0;\r\npci_set_master(pdev);\r\nswitch (use_msi) {\r\ncase 3:\r\ncase 1:\r\nwil_dbg_misc(wil, "Setup %d MSI interrupts\n", use_msi);\r\nbreak;\r\ncase 0:\r\nwil_dbg_misc(wil, "MSI interrupts disabled, use INTx\n");\r\nbreak;\r\ndefault:\r\nwil_err(wil, "Invalid use_msi=%d, default to 1\n", use_msi);\r\nuse_msi = 1;\r\n}\r\nif (use_msi == 3 && pci_enable_msi_range(pdev, 3, 3) < 0) {\r\nwil_err(wil, "3 MSI mode failed, try 1 MSI\n");\r\nuse_msi = 1;\r\n}\r\nif (use_msi == 1 && pci_enable_msi(pdev)) {\r\nwil_err(wil, "pci_enable_msi failed, use INTx\n");\r\nuse_msi = 0;\r\n}\r\nwil->n_msi = use_msi;\r\nif ((wil->n_msi == 0) && msi_only) {\r\nwil_err(wil, "Interrupt pin not routed, unable to use INTx\n");\r\nrc = -ENODEV;\r\ngoto stop_master;\r\n}\r\nrc = wil6210_init_irq(wil, pdev->irq);\r\nif (rc)\r\ngoto stop_master;\r\nmutex_lock(&wil->mutex);\r\nrc = wil_reset(wil);\r\nmutex_unlock(&wil->mutex);\r\nif (debug_fw)\r\nrc = 0;\r\nif (rc)\r\ngoto release_irq;\r\nreturn 0;\r\nrelease_irq:\r\nwil6210_fini_irq(wil, pdev->irq);\r\npci_disable_msi(pdev);\r\nstop_master:\r\npci_clear_master(pdev);\r\nreturn rc;\r\n}\r\nstatic int wil_if_pcie_disable(struct wil6210_priv *wil)\r\n{\r\nstruct pci_dev *pdev = wil->pdev;\r\nwil_dbg_misc(wil, "%s()\n", __func__);\r\npci_clear_master(pdev);\r\nwil6210_fini_irq(wil, pdev->irq);\r\npci_disable_msi(pdev);\r\nreturn 0;\r\n}\r\nstatic int wil_pcie_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct wil6210_priv *wil;\r\nstruct device *dev = &pdev->dev;\r\nvoid __iomem *csr;\r\nstruct wil_board *board = (struct wil_board *)id->driver_data;\r\nint rc;\r\ndev_info(&pdev->dev, WIL_NAME\r\n" \"%s\" device found [%04x:%04x] (rev %x)\n", board->name,\r\n(int)pdev->vendor, (int)pdev->device, (int)pdev->revision);\r\nif (pci_resource_len(pdev, 0) != WIL6210_MEM_SIZE) {\r\ndev_err(&pdev->dev, "Not " WIL_NAME "? "\r\n"BAR0 size is %lu while expecting %lu\n",\r\n(ulong)pci_resource_len(pdev, 0), WIL6210_MEM_SIZE);\r\nreturn -ENODEV;\r\n}\r\nrc = pci_enable_device(pdev);\r\nif (rc) {\r\ndev_err(&pdev->dev,\r\n"pci_enable_device failed, retry with MSI only\n");\r\npdev->msi_enabled = 1;\r\nrc = pci_enable_device(pdev);\r\n}\r\nif (rc)\r\nreturn -ENODEV;\r\nrc = pci_request_region(pdev, 0, WIL_NAME);\r\nif (rc) {\r\ndev_err(&pdev->dev, "pci_request_region failed\n");\r\ngoto err_disable_pdev;\r\n}\r\ncsr = pci_ioremap_bar(pdev, 0);\r\nif (!csr) {\r\ndev_err(&pdev->dev, "pci_ioremap_bar failed\n");\r\nrc = -ENODEV;\r\ngoto err_release_reg;\r\n}\r\ndev_info(&pdev->dev, "CSR at %pR -> 0x%p\n", &pdev->resource[0], csr);\r\nwil = wil_if_alloc(dev, csr);\r\nif (IS_ERR(wil)) {\r\nrc = (int)PTR_ERR(wil);\r\ndev_err(dev, "wil_if_alloc failed: %d\n", rc);\r\ngoto err_iounmap;\r\n}\r\npci_set_drvdata(pdev, wil);\r\nwil->pdev = pdev;\r\nwil->board = board;\r\nwil6210_clear_irq(wil);\r\nwil->platform_handle =\r\nwil_platform_init(&pdev->dev, &wil->platform_ops);\r\nrc = wil_if_pcie_enable(wil);\r\nif (rc) {\r\nwil_err(wil, "Enable device failed\n");\r\ngoto if_free;\r\n}\r\nrc = wil_if_add(wil);\r\nif (rc) {\r\nwil_err(wil, "wil_if_add failed: %d\n", rc);\r\ngoto bus_disable;\r\n}\r\nwil6210_debugfs_init(wil);\r\nwmi_echo(wil);\r\nreturn 0;\r\nbus_disable:\r\nwil_if_pcie_disable(wil);\r\nif_free:\r\nif (wil->platform_ops.uninit)\r\nwil->platform_ops.uninit(wil->platform_handle);\r\nwil_if_free(wil);\r\nerr_iounmap:\r\npci_iounmap(pdev, csr);\r\nerr_release_reg:\r\npci_release_region(pdev, 0);\r\nerr_disable_pdev:\r\npci_disable_device(pdev);\r\nreturn rc;\r\n}\r\nstatic void wil_pcie_remove(struct pci_dev *pdev)\r\n{\r\nstruct wil6210_priv *wil = pci_get_drvdata(pdev);\r\nvoid __iomem *csr = wil->csr;\r\nwil_dbg_misc(wil, "%s()\n", __func__);\r\nwil6210_debugfs_remove(wil);\r\nwil_if_remove(wil);\r\nwil_if_pcie_disable(wil);\r\nif (wil->platform_ops.uninit)\r\nwil->platform_ops.uninit(wil->platform_handle);\r\nwil_if_free(wil);\r\npci_iounmap(pdev, csr);\r\npci_release_region(pdev, 0);\r\npci_disable_device(pdev);\r\n}

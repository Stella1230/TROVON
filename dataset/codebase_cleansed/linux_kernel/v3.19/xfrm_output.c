static int xfrm_skb_check_space(struct sk_buff *skb)\r\n{\r\nstruct dst_entry *dst = skb_dst(skb);\r\nint nhead = dst->header_len + LL_RESERVED_SPACE(dst->dev)\r\n- skb_headroom(skb);\r\nint ntail = dst->dev->needed_tailroom - skb_tailroom(skb);\r\nif (nhead <= 0) {\r\nif (ntail <= 0)\r\nreturn 0;\r\nnhead = 0;\r\n} else if (ntail < 0)\r\nntail = 0;\r\nreturn pskb_expand_head(skb, nhead, ntail, GFP_ATOMIC);\r\n}\r\nstatic int xfrm_output_one(struct sk_buff *skb, int err)\r\n{\r\nstruct dst_entry *dst = skb_dst(skb);\r\nstruct xfrm_state *x = dst->xfrm;\r\nstruct net *net = xs_net(x);\r\nif (err <= 0)\r\ngoto resume;\r\ndo {\r\nerr = xfrm_skb_check_space(skb);\r\nif (err) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTERROR);\r\ngoto error_nolock;\r\n}\r\nerr = x->outer_mode->output(x, skb);\r\nif (err) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTSTATEMODEERROR);\r\ngoto error_nolock;\r\n}\r\nspin_lock_bh(&x->lock);\r\nif (unlikely(x->km.state != XFRM_STATE_VALID)) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTSTATEINVALID);\r\nerr = -EINVAL;\r\ngoto error;\r\n}\r\nerr = xfrm_state_check_expire(x);\r\nif (err) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTSTATEEXPIRED);\r\ngoto error;\r\n}\r\nerr = x->repl->overflow(x, skb);\r\nif (err) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTSTATESEQERROR);\r\ngoto error;\r\n}\r\nx->curlft.bytes += skb->len;\r\nx->curlft.packets++;\r\nspin_unlock_bh(&x->lock);\r\nskb_dst_force(skb);\r\nerr = x->type->output(x, skb);\r\nif (err == -EINPROGRESS)\r\ngoto out;\r\nresume:\r\nif (err) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTSTATEPROTOERROR);\r\ngoto error_nolock;\r\n}\r\ndst = skb_dst_pop(skb);\r\nif (!dst) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTERROR);\r\nerr = -EHOSTUNREACH;\r\ngoto error_nolock;\r\n}\r\nskb_dst_set(skb, dst);\r\nx = dst->xfrm;\r\n} while (x && !(x->outer_mode->flags & XFRM_MODE_FLAG_TUNNEL));\r\nreturn 0;\r\nerror:\r\nspin_unlock_bh(&x->lock);\r\nerror_nolock:\r\nkfree_skb(skb);\r\nout:\r\nreturn err;\r\n}\r\nint xfrm_output_resume(struct sk_buff *skb, int err)\r\n{\r\nwhile (likely((err = xfrm_output_one(skb, err)) == 0)) {\r\nnf_reset(skb);\r\nerr = skb_dst(skb)->ops->local_out(skb);\r\nif (unlikely(err != 1))\r\ngoto out;\r\nif (!skb_dst(skb)->xfrm)\r\nreturn dst_output(skb);\r\nerr = nf_hook(skb_dst(skb)->ops->family,\r\nNF_INET_POST_ROUTING, skb,\r\nNULL, skb_dst(skb)->dev, xfrm_output2);\r\nif (unlikely(err != 1))\r\ngoto out;\r\n}\r\nif (err == -EINPROGRESS)\r\nerr = 0;\r\nout:\r\nreturn err;\r\n}\r\nstatic int xfrm_output2(struct sk_buff *skb)\r\n{\r\nreturn xfrm_output_resume(skb, 1);\r\n}\r\nstatic int xfrm_output_gso(struct sk_buff *skb)\r\n{\r\nstruct sk_buff *segs;\r\nsegs = skb_gso_segment(skb, 0);\r\nkfree_skb(skb);\r\nif (IS_ERR(segs))\r\nreturn PTR_ERR(segs);\r\nif (segs == NULL)\r\nreturn -EINVAL;\r\ndo {\r\nstruct sk_buff *nskb = segs->next;\r\nint err;\r\nsegs->next = NULL;\r\nerr = xfrm_output2(segs);\r\nif (unlikely(err)) {\r\nkfree_skb_list(nskb);\r\nreturn err;\r\n}\r\nsegs = nskb;\r\n} while (segs);\r\nreturn 0;\r\n}\r\nint xfrm_output(struct sk_buff *skb)\r\n{\r\nstruct net *net = dev_net(skb_dst(skb)->dev);\r\nint err;\r\nif (skb_is_gso(skb))\r\nreturn xfrm_output_gso(skb);\r\nif (skb->ip_summed == CHECKSUM_PARTIAL) {\r\nerr = skb_checksum_help(skb);\r\nif (err) {\r\nXFRM_INC_STATS(net, LINUX_MIB_XFRMOUTERROR);\r\nkfree_skb(skb);\r\nreturn err;\r\n}\r\n}\r\nreturn xfrm_output2(skb);\r\n}\r\nint xfrm_inner_extract_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct xfrm_mode *inner_mode;\r\nif (x->sel.family == AF_UNSPEC)\r\ninner_mode = xfrm_ip2inner_mode(x,\r\nxfrm_af2proto(skb_dst(skb)->ops->family));\r\nelse\r\ninner_mode = x->inner_mode;\r\nif (inner_mode == NULL)\r\nreturn -EAFNOSUPPORT;\r\nreturn inner_mode->afinfo->extract_output(x, skb);\r\n}\r\nvoid xfrm_local_error(struct sk_buff *skb, int mtu)\r\n{\r\nunsigned int proto;\r\nstruct xfrm_state_afinfo *afinfo;\r\nif (skb->protocol == htons(ETH_P_IP))\r\nproto = AF_INET;\r\nelse if (skb->protocol == htons(ETH_P_IPV6))\r\nproto = AF_INET6;\r\nelse\r\nreturn;\r\nafinfo = xfrm_state_get_afinfo(proto);\r\nif (!afinfo)\r\nreturn;\r\nafinfo->local_error(skb, mtu);\r\nxfrm_state_put_afinfo(afinfo);\r\n}

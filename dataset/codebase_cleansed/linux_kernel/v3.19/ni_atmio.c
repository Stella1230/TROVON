static int ni_isapnp_find_board(struct pnp_dev **dev)\r\n{\r\nstruct pnp_dev *isapnp_dev = NULL;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ni_boards); i++) {\r\nisapnp_dev = pnp_find_dev(NULL,\r\nISAPNP_VENDOR('N', 'I', 'C'),\r\nISAPNP_FUNCTION(ni_boards[i].\r\nisapnp_id), NULL);\r\nif (isapnp_dev == NULL || isapnp_dev->card == NULL)\r\ncontinue;\r\nif (pnp_device_attach(isapnp_dev) < 0)\r\ncontinue;\r\nif (pnp_activate_dev(isapnp_dev) < 0) {\r\npnp_device_detach(isapnp_dev);\r\nreturn -EAGAIN;\r\n}\r\nif (!pnp_port_valid(isapnp_dev, 0) ||\r\n!pnp_irq_valid(isapnp_dev, 0)) {\r\npnp_device_detach(isapnp_dev);\r\nreturn -ENOMEM;\r\n}\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(ni_boards))\r\nreturn -ENODEV;\r\n*dev = isapnp_dev;\r\nreturn 0;\r\n}\r\nstatic int ni_getboardtype(struct comedi_device *dev)\r\n{\r\nint device_id = ni_read_eeprom(dev, 511);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ni_boards); i++) {\r\nif (ni_boards[i].device_id == device_id)\r\nreturn i;\r\n}\r\nif (device_id == 255)\r\ndev_err(dev->class_dev, "can't find board\n");\r\nelse if (device_id == 0)\r\ndev_err(dev->class_dev,\r\n"EEPROM read error (?) or device not found\n");\r\nelse\r\ndev_err(dev->class_dev,\r\n"unknown device ID %d -- contact author\n", device_id);\r\nreturn -1;\r\n}\r\nstatic int ni_atmio_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nconst struct ni_board_struct *boardtype;\r\nstruct ni_private *devpriv;\r\nstruct pnp_dev *isapnp_dev;\r\nint ret;\r\nunsigned long iobase;\r\nint board;\r\nunsigned int irq;\r\nret = ni_alloc_private(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = dev->private;\r\niobase = it->options[0];\r\nirq = it->options[1];\r\nisapnp_dev = NULL;\r\nif (iobase == 0) {\r\nret = ni_isapnp_find_board(&isapnp_dev);\r\nif (ret < 0)\r\nreturn ret;\r\niobase = pnp_port_start(isapnp_dev, 0);\r\nirq = pnp_irq(isapnp_dev, 0);\r\ncomedi_set_hw_dev(dev, &isapnp_dev->dev);\r\n}\r\nret = comedi_request_region(dev, iobase, 0x20);\r\nif (ret)\r\nreturn ret;\r\nboard = ni_getboardtype(dev);\r\nif (board < 0)\r\nreturn -EIO;\r\ndev->board_ptr = ni_boards + board;\r\nboardtype = dev->board_ptr;\r\ndev->board_name = boardtype->name;\r\nif (irq != 0) {\r\nif (irq > 15 || ni_irqpin[irq] == -1)\r\nreturn -EINVAL;\r\nret = request_irq(irq, ni_E_interrupt, 0,\r\ndev->board_name, dev);\r\nif (ret < 0)\r\nreturn -EINVAL;\r\ndev->irq = irq;\r\n}\r\nret = ni_E_init(dev, ni_irqpin[dev->irq], 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic void ni_atmio_detach(struct comedi_device *dev)\r\n{\r\nstruct pnp_dev *isapnp_dev;\r\nmio_common_detach(dev);\r\ncomedi_legacy_detach(dev);\r\nisapnp_dev = dev->hw_dev ? to_pnp_dev(dev->hw_dev) : NULL;\r\nif (isapnp_dev)\r\npnp_device_detach(isapnp_dev);\r\n}

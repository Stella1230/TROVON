static int keystone_platform_notifier(struct notifier_block *nb,\r\nunsigned long event, void *data)\r\n{\r\nstruct device *dev = data;\r\nif (event != BUS_NOTIFY_ADD_DEVICE)\r\nreturn NOTIFY_DONE;\r\nif (!dev)\r\nreturn NOTIFY_BAD;\r\nif (!dev->of_node) {\r\ndev->dma_pfn_offset = keystone_dma_pfn_offset;\r\ndev_err(dev, "set dma_pfn_offset%08lx\n",\r\ndev->dma_pfn_offset);\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic void __init keystone_init(void)\r\n{\r\nkeystone_pm_runtime_init();\r\nif (platform_nb.notifier_call)\r\nbus_register_notifier(&platform_bus_type, &platform_nb);\r\nof_platform_populate(NULL, of_default_bus_match_table, NULL, NULL);\r\n}\r\nstatic phys_addr_t keystone_virt_to_idmap(unsigned long x)\r\n{\r\nreturn (phys_addr_t)(x) - CONFIG_PAGE_OFFSET + KEYSTONE_LOW_PHYS_START;\r\n}\r\nstatic void __init keystone_init_meminfo(void)\r\n{\r\nbool lpae = IS_ENABLED(CONFIG_ARM_LPAE);\r\nbool pvpatch = IS_ENABLED(CONFIG_ARM_PATCH_PHYS_VIRT);\r\nphys_addr_t offset = PHYS_OFFSET - KEYSTONE_LOW_PHYS_START;\r\nphys_addr_t mem_start, mem_end;\r\nmem_start = memblock_start_of_DRAM();\r\nmem_end = memblock_end_of_DRAM();\r\nif (mem_start >= KEYSTONE_LOW_PHYS_START &&\r\nmem_end <= KEYSTONE_LOW_PHYS_END)\r\nreturn;\r\nif (!lpae || !pvpatch) {\r\npr_crit("Enable %s%s%s to run outside 32-bit space\n",\r\n!lpae ? __stringify(CONFIG_ARM_LPAE) : "",\r\n(!lpae && !pvpatch) ? " and " : "",\r\n!pvpatch ? __stringify(CONFIG_ARM_PATCH_PHYS_VIRT) : "");\r\n}\r\nif (mem_start < KEYSTONE_HIGH_PHYS_START ||\r\nmem_end > KEYSTONE_HIGH_PHYS_END) {\r\npr_crit("Invalid address space for memory (%08llx-%08llx)\n",\r\n(u64)mem_start, (u64)mem_end);\r\n}\r\noffset += KEYSTONE_HIGH_PHYS_START;\r\n__pv_phys_pfn_offset = PFN_DOWN(offset);\r\n__pv_offset = (offset - PAGE_OFFSET);\r\narch_virt_to_idmap = keystone_virt_to_idmap;\r\nplatform_nb.notifier_call = keystone_platform_notifier;\r\nkeystone_dma_pfn_offset = PFN_DOWN(KEYSTONE_HIGH_PHYS_START -\r\nKEYSTONE_LOW_PHYS_START);\r\npr_info("Switching to high address space at 0x%llx\n", (u64)offset);\r\n}

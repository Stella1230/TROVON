void v4l2_fh_init(struct v4l2_fh *fh, struct video_device *vdev)\r\n{\r\nfh->vdev = vdev;\r\nfh->ctrl_handler = vdev->ctrl_handler;\r\nINIT_LIST_HEAD(&fh->list);\r\nset_bit(V4L2_FL_USES_V4L2_FH, &fh->vdev->flags);\r\nset_bit(_IOC_NR(VIDIOC_G_PRIORITY), vdev->valid_ioctls);\r\nset_bit(_IOC_NR(VIDIOC_S_PRIORITY), vdev->valid_ioctls);\r\nfh->prio = V4L2_PRIORITY_UNSET;\r\ninit_waitqueue_head(&fh->wait);\r\nINIT_LIST_HEAD(&fh->available);\r\nINIT_LIST_HEAD(&fh->subscribed);\r\nfh->sequence = -1;\r\n}\r\nvoid v4l2_fh_add(struct v4l2_fh *fh)\r\n{\r\nunsigned long flags;\r\nv4l2_prio_open(fh->vdev->prio, &fh->prio);\r\nspin_lock_irqsave(&fh->vdev->fh_lock, flags);\r\nlist_add(&fh->list, &fh->vdev->fh_list);\r\nspin_unlock_irqrestore(&fh->vdev->fh_lock, flags);\r\n}\r\nint v4l2_fh_open(struct file *filp)\r\n{\r\nstruct video_device *vdev = video_devdata(filp);\r\nstruct v4l2_fh *fh = kzalloc(sizeof(*fh), GFP_KERNEL);\r\nfilp->private_data = fh;\r\nif (fh == NULL)\r\nreturn -ENOMEM;\r\nv4l2_fh_init(fh, vdev);\r\nv4l2_fh_add(fh);\r\nreturn 0;\r\n}\r\nvoid v4l2_fh_del(struct v4l2_fh *fh)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&fh->vdev->fh_lock, flags);\r\nlist_del_init(&fh->list);\r\nspin_unlock_irqrestore(&fh->vdev->fh_lock, flags);\r\nv4l2_prio_close(fh->vdev->prio, fh->prio);\r\n}\r\nvoid v4l2_fh_exit(struct v4l2_fh *fh)\r\n{\r\nif (fh->vdev == NULL)\r\nreturn;\r\nv4l2_event_unsubscribe_all(fh);\r\nfh->vdev = NULL;\r\n}\r\nint v4l2_fh_release(struct file *filp)\r\n{\r\nstruct v4l2_fh *fh = filp->private_data;\r\nif (fh) {\r\nv4l2_fh_del(fh);\r\nv4l2_fh_exit(fh);\r\nkfree(fh);\r\n}\r\nreturn 0;\r\n}\r\nint v4l2_fh_is_singular(struct v4l2_fh *fh)\r\n{\r\nunsigned long flags;\r\nint is_singular;\r\nif (fh == NULL || fh->vdev == NULL)\r\nreturn 0;\r\nspin_lock_irqsave(&fh->vdev->fh_lock, flags);\r\nis_singular = list_is_singular(&fh->list);\r\nspin_unlock_irqrestore(&fh->vdev->fh_lock, flags);\r\nreturn is_singular;\r\n}

static u_long get_line_length(int xres_virtual, int bpp)\r\n{\r\nu_long length;\r\nlength = xres_virtual * bpp;\r\nlength = (length + 31) & ~31;\r\nlength >>= 3;\r\nreturn (length);\r\n}\r\nstatic int mc68x328fb_check_var(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nu_long line_length;\r\nif (var->vmode & FB_VMODE_CONUPDATE) {\r\nvar->vmode |= FB_VMODE_YWRAP;\r\nvar->xoffset = info->var.xoffset;\r\nvar->yoffset = info->var.yoffset;\r\n}\r\nif (!var->xres)\r\nvar->xres = 1;\r\nif (!var->yres)\r\nvar->yres = 1;\r\nif (var->xres > var->xres_virtual)\r\nvar->xres_virtual = var->xres;\r\nif (var->yres > var->yres_virtual)\r\nvar->yres_virtual = var->yres;\r\nif (var->bits_per_pixel <= 1)\r\nvar->bits_per_pixel = 1;\r\nelse if (var->bits_per_pixel <= 8)\r\nvar->bits_per_pixel = 8;\r\nelse if (var->bits_per_pixel <= 16)\r\nvar->bits_per_pixel = 16;\r\nelse if (var->bits_per_pixel <= 24)\r\nvar->bits_per_pixel = 24;\r\nelse if (var->bits_per_pixel <= 32)\r\nvar->bits_per_pixel = 32;\r\nelse\r\nreturn -EINVAL;\r\nif (var->xres_virtual < var->xoffset + var->xres)\r\nvar->xres_virtual = var->xoffset + var->xres;\r\nif (var->yres_virtual < var->yoffset + var->yres)\r\nvar->yres_virtual = var->yoffset + var->yres;\r\nline_length =\r\nget_line_length(var->xres_virtual, var->bits_per_pixel);\r\nif (line_length * var->yres_virtual > videomemorysize)\r\nreturn -ENOMEM;\r\nswitch (var->bits_per_pixel) {\r\ncase 1:\r\nvar->red.offset = 0;\r\nvar->red.length = 1;\r\nvar->green.offset = 0;\r\nvar->green.length = 1;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 1;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nbreak;\r\ncase 8:\r\nvar->red.offset = 0;\r\nvar->red.length = 8;\r\nvar->green.offset = 0;\r\nvar->green.length = 8;\r\nvar->blue.offset = 0;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nbreak;\r\ncase 16:\r\nif (var->transp.length) {\r\nvar->red.offset = 0;\r\nvar->red.length = 5;\r\nvar->green.offset = 5;\r\nvar->green.length = 5;\r\nvar->blue.offset = 10;\r\nvar->blue.length = 5;\r\nvar->transp.offset = 15;\r\nvar->transp.length = 1;\r\n} else {\r\nvar->red.offset = 0;\r\nvar->red.length = 5;\r\nvar->green.offset = 5;\r\nvar->green.length = 6;\r\nvar->blue.offset = 11;\r\nvar->blue.length = 5;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\n}\r\nbreak;\r\ncase 24:\r\nvar->red.offset = 0;\r\nvar->red.length = 8;\r\nvar->green.offset = 8;\r\nvar->green.length = 8;\r\nvar->blue.offset = 16;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 0;\r\nvar->transp.length = 0;\r\nbreak;\r\ncase 32:\r\nvar->red.offset = 0;\r\nvar->red.length = 8;\r\nvar->green.offset = 8;\r\nvar->green.length = 8;\r\nvar->blue.offset = 16;\r\nvar->blue.length = 8;\r\nvar->transp.offset = 24;\r\nvar->transp.length = 8;\r\nbreak;\r\n}\r\nvar->red.msb_right = 0;\r\nvar->green.msb_right = 0;\r\nvar->blue.msb_right = 0;\r\nvar->transp.msb_right = 0;\r\nreturn 0;\r\n}\r\nstatic int mc68x328fb_set_par(struct fb_info *info)\r\n{\r\ninfo->fix.line_length = get_line_length(info->var.xres_virtual,\r\ninfo->var.bits_per_pixel);\r\nreturn 0;\r\n}\r\nstatic int mc68x328fb_setcolreg(u_int regno, u_int red, u_int green, u_int blue,\r\nu_int transp, struct fb_info *info)\r\n{\r\nif (regno >= 256)\r\nreturn 1;\r\nif (info->var.grayscale) {\r\nred = green = blue =\r\n(red * 77 + green * 151 + blue * 28) >> 8;\r\n}\r\n#define CNVT_TOHW(val,width) ((((val)<<(width))+0x7FFF-(val))>>16)\r\nswitch (info->fix.visual) {\r\ncase FB_VISUAL_TRUECOLOR:\r\ncase FB_VISUAL_PSEUDOCOLOR:\r\nred = CNVT_TOHW(red, info->var.red.length);\r\ngreen = CNVT_TOHW(green, info->var.green.length);\r\nblue = CNVT_TOHW(blue, info->var.blue.length);\r\ntransp = CNVT_TOHW(transp, info->var.transp.length);\r\nbreak;\r\ncase FB_VISUAL_DIRECTCOLOR:\r\nred = CNVT_TOHW(red, 8);\r\ngreen = CNVT_TOHW(green, 8);\r\nblue = CNVT_TOHW(blue, 8);\r\ntransp = CNVT_TOHW(transp, 8);\r\nbreak;\r\n}\r\n#undef CNVT_TOHW\r\nif (info->fix.visual == FB_VISUAL_TRUECOLOR) {\r\nu32 v;\r\nif (regno >= 16)\r\nreturn 1;\r\nv = (red << info->var.red.offset) |\r\n(green << info->var.green.offset) |\r\n(blue << info->var.blue.offset) |\r\n(transp << info->var.transp.offset);\r\nswitch (info->var.bits_per_pixel) {\r\ncase 8:\r\nbreak;\r\ncase 16:\r\n((u32 *) (info->pseudo_palette))[regno] = v;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\n((u32 *) (info->pseudo_palette))[regno] = v;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mc68x328fb_pan_display(struct fb_var_screeninfo *var,\r\nstruct fb_info *info)\r\n{\r\nif (var->vmode & FB_VMODE_YWRAP) {\r\nif (var->yoffset < 0\r\n|| var->yoffset >= info->var.yres_virtual\r\n|| var->xoffset)\r\nreturn -EINVAL;\r\n} else {\r\nif (var->xoffset + info->var.xres > info->var.xres_virtual ||\r\nvar->yoffset + info->var.yres > info->var.yres_virtual)\r\nreturn -EINVAL;\r\n}\r\ninfo->var.xoffset = var->xoffset;\r\ninfo->var.yoffset = var->yoffset;\r\nif (var->vmode & FB_VMODE_YWRAP)\r\ninfo->var.vmode |= FB_VMODE_YWRAP;\r\nelse\r\ninfo->var.vmode &= ~FB_VMODE_YWRAP;\r\nreturn 0;\r\n}\r\nstatic int mc68x328fb_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\n#ifndef MMU\r\nvma->vm_flags |= VM_DONTEXPAND | VM_DONTDUMP;\r\nvma->vm_start = videomemory;\r\nreturn 0;\r\n#else\r\nreturn -EINVAL;\r\n#endif\r\n}\r\nint __init mc68x328fb_setup(char *options)\r\n{\r\n#if 0\r\nchar *this_opt;\r\n#endif\r\nif (!options || !*options)\r\nreturn 1;\r\n#if 0\r\nwhile ((this_opt = strsep(&options, ",")) != NULL) {\r\nif (!*this_opt)\r\ncontinue;\r\nif (!strncmp(this_opt, "disable", 7))\r\nmc68x328fb_enable = 0;\r\n}\r\n#endif\r\nreturn 1;\r\n}\r\nint __init mc68x328fb_init(void)\r\n{\r\n#ifndef MODULE\r\nchar *option = NULL;\r\nif (fb_get_options("68328fb", &option))\r\nreturn -ENODEV;\r\nmc68x328fb_setup(option);\r\n#endif\r\nmc68x328fb_default.xres = LXMAX;\r\nmc68x328fb_default.yres = LYMAX+1;\r\nmc68x328fb_default.xres_virtual = mc68x328fb_default.xres;\r\nmc68x328fb_default.yres_virtual = mc68x328fb_default.yres;\r\nmc68x328fb_default.bits_per_pixel = 1 + (LPICF & 0x01);\r\nvideomemory = LSSA;\r\nvideomemorysize = (mc68x328fb_default.xres_virtual+7) / 8 *\r\nmc68x328fb_default.yres_virtual * mc68x328fb_default.bits_per_pixel;\r\nfb_info.screen_base = (void *)videomemory;\r\nfb_info.fbops = &mc68x328fb_ops;\r\nfb_info.var = mc68x328fb_default;\r\nfb_info.fix = mc68x328fb_fix;\r\nfb_info.fix.smem_start = videomemory;\r\nfb_info.fix.smem_len = videomemorysize;\r\nfb_info.fix.line_length =\r\nget_line_length(mc68x328fb_default.xres_virtual, mc68x328fb_default.bits_per_pixel);\r\nfb_info.fix.visual = (mc68x328fb_default.bits_per_pixel) == 1 ?\r\nFB_VISUAL_MONO10 : FB_VISUAL_PSEUDOCOLOR;\r\nif (fb_info.var.bits_per_pixel == 1) {\r\nfb_info.var.red.length = fb_info.var.green.length = fb_info.var.blue.length = 1;\r\nfb_info.var.red.offset = fb_info.var.green.offset = fb_info.var.blue.offset = 0;\r\n}\r\nfb_info.pseudo_palette = &mc68x328fb_pseudo_palette;\r\nfb_info.flags = FBINFO_DEFAULT | FBINFO_HWACCEL_YPAN;\r\nif (fb_alloc_cmap(&fb_info.cmap, 256, 0))\r\nreturn -ENOMEM;\r\nif (register_framebuffer(&fb_info) < 0) {\r\nfb_dealloc_cmap(&fb_info.cmap);\r\nreturn -EINVAL;\r\n}\r\nfb_info(&fb_info, "%s frame buffer device\n", fb_info.fix.id);\r\nfb_info(&fb_info, "%dx%dx%d at 0x%08lx\n",\r\nmc68x328fb_default.xres_virtual,\r\nmc68x328fb_default.yres_virtual,\r\n1 << mc68x328fb_default.bits_per_pixel, videomemory);\r\nreturn 0;\r\n}\r\nstatic void __exit mc68x328fb_cleanup(void)\r\n{\r\nunregister_framebuffer(&fb_info);\r\nfb_dealloc_cmap(&fb_info.cmap);\r\n}

static u16 get_counter(struct atm_dev *dev, int counter)\r\n{\r\nu16 val;\r\nPUT(counter, CTRSEL);\r\nval = GET(CTRLO);\r\nval |= GET(CTRHI)<<8;\r\nreturn val;\r\n}\r\nstatic void idt77105_stats_timer_func(unsigned long dummy)\r\n{\r\nstruct idt77105_priv *walk;\r\nstruct atm_dev *dev;\r\nstruct idt77105_stats *stats;\r\nDPRINTK("IDT77105 gathering statistics\n");\r\nfor (walk = idt77105_all; walk; walk = walk->next) {\r\ndev = walk->dev;\r\nstats = &walk->stats;\r\nstats->symbol_errors += get_counter(dev, IDT77105_CTRSEL_SEC);\r\nstats->tx_cells += get_counter(dev, IDT77105_CTRSEL_TCC);\r\nstats->rx_cells += get_counter(dev, IDT77105_CTRSEL_RCC);\r\nstats->rx_hec_errors += get_counter(dev, IDT77105_CTRSEL_RHEC);\r\n}\r\nif (!start_timer) mod_timer(&stats_timer,jiffies+IDT77105_STATS_TIMER_PERIOD);\r\n}\r\nstatic void idt77105_restart_timer_func(unsigned long dummy)\r\n{\r\nstruct idt77105_priv *walk;\r\nstruct atm_dev *dev;\r\nunsigned char istat;\r\nDPRINTK("IDT77105 checking for cable re-insertion\n");\r\nfor (walk = idt77105_all; walk; walk = walk->next) {\r\ndev = walk->dev;\r\nif (dev->signal != ATM_PHY_SIG_LOST)\r\ncontinue;\r\nistat = GET(ISTAT);\r\nif (istat & IDT77105_ISTAT_GOODSIG) {\r\natm_dev_signal_change(dev, ATM_PHY_SIG_FOUND);\r\nprintk(KERN_NOTICE "%s(itf %d): signal detected again\n",\r\ndev->type,dev->number);\r\nPUT( GET(DIAG) | IDT77105_DIAG_RFLUSH, DIAG);\r\nPUT( walk->old_mcr ,MCR);\r\n}\r\n}\r\nif (!start_timer) mod_timer(&restart_timer,jiffies+IDT77105_RESTART_TIMER_PERIOD);\r\n}\r\nstatic int fetch_stats(struct atm_dev *dev,struct idt77105_stats __user *arg,int zero)\r\n{\r\nunsigned long flags;\r\nstruct idt77105_stats stats;\r\nspin_lock_irqsave(&idt77105_priv_lock, flags);\r\nmemcpy(&stats, &PRIV(dev)->stats, sizeof(struct idt77105_stats));\r\nif (zero)\r\nmemset(&PRIV(dev)->stats, 0, sizeof(struct idt77105_stats));\r\nspin_unlock_irqrestore(&idt77105_priv_lock, flags);\r\nif (arg == NULL)\r\nreturn 0;\r\nreturn copy_to_user(arg, &stats,\r\nsizeof(struct idt77105_stats)) ? -EFAULT : 0;\r\n}\r\nstatic int set_loopback(struct atm_dev *dev,int mode)\r\n{\r\nint diag;\r\ndiag = GET(DIAG) & ~IDT77105_DIAG_LCMASK;\r\nswitch (mode) {\r\ncase ATM_LM_NONE:\r\nbreak;\r\ncase ATM_LM_LOC_ATM:\r\ndiag |= IDT77105_DIAG_LC_PHY_LOOPBACK;\r\nbreak;\r\ncase ATM_LM_RMT_ATM:\r\ndiag |= IDT77105_DIAG_LC_LINE_LOOPBACK;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nPUT(diag,DIAG);\r\nprintk(KERN_NOTICE "%s(%d) Loopback mode is: %s\n", dev->type,\r\ndev->number,\r\n(mode == ATM_LM_NONE ? "NONE" :\r\n(mode == ATM_LM_LOC_ATM ? "DIAG (local)" :\r\n(mode == IDT77105_DIAG_LC_LINE_LOOPBACK ? "LOOP (remote)" :\r\n"unknown")))\r\n);\r\nPRIV(dev)->loop_mode = mode;\r\nreturn 0;\r\n}\r\nstatic int idt77105_ioctl(struct atm_dev *dev,unsigned int cmd,void __user *arg)\r\n{\r\nprintk(KERN_NOTICE "%s(%d) idt77105_ioctl() called\n",dev->type,dev->number);\r\nswitch (cmd) {\r\ncase IDT77105_GETSTATZ:\r\nif (!capable(CAP_NET_ADMIN)) return -EPERM;\r\ncase IDT77105_GETSTAT:\r\nreturn fetch_stats(dev, arg, cmd == IDT77105_GETSTATZ);\r\ncase ATM_SETLOOP:\r\nreturn set_loopback(dev,(int)(unsigned long) arg);\r\ncase ATM_GETLOOP:\r\nreturn put_user(PRIV(dev)->loop_mode,(int __user *)arg) ?\r\n-EFAULT : 0;\r\ncase ATM_QUERYLOOP:\r\nreturn put_user(ATM_LM_LOC_ATM | ATM_LM_RMT_ATM,\r\n(int __user *) arg) ? -EFAULT : 0;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}\r\nstatic void idt77105_int(struct atm_dev *dev)\r\n{\r\nunsigned char istat;\r\nistat = GET(ISTAT);\r\nDPRINTK("IDT77105 generated an interrupt, istat=%02x\n", (unsigned)istat);\r\nif (istat & IDT77105_ISTAT_RSCC) {\r\nif (istat & IDT77105_ISTAT_GOODSIG) {\r\natm_dev_signal_change(dev, ATM_PHY_SIG_FOUND);\r\n} else {\r\nPRIV(dev)->old_mcr = GET(MCR);\r\nPUT(\r\n(PRIV(dev)->old_mcr|\r\nIDT77105_MCR_DREC|\r\nIDT77105_MCR_DRIC|\r\nIDT77105_MCR_HALTTX\r\n) & ~IDT77105_MCR_EIP, MCR);\r\natm_dev_signal_change(dev, ATM_PHY_SIG_LOST);\r\nprintk(KERN_NOTICE "%s(itf %d): signal lost\n",\r\ndev->type,dev->number);\r\n}\r\n}\r\nif (istat & IDT77105_ISTAT_RFO) {\r\nPUT( GET(DIAG) | IDT77105_DIAG_RFLUSH, DIAG);\r\nprintk(KERN_NOTICE "%s(itf %d): receive FIFO overrun\n",\r\ndev->type,dev->number);\r\n}\r\n#ifdef GENERAL_DEBUG\r\nif (istat & (IDT77105_ISTAT_HECERR | IDT77105_ISTAT_SCR |\r\nIDT77105_ISTAT_RSE)) {\r\nprintk(KERN_NOTICE "%s(itf %d): received cell with error\n",\r\ndev->type,dev->number);\r\n}\r\n#endif\r\n}\r\nstatic int idt77105_start(struct atm_dev *dev)\r\n{\r\nunsigned long flags;\r\nif (!(dev->dev_data = kmalloc(sizeof(struct idt77105_priv),GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nPRIV(dev)->dev = dev;\r\nspin_lock_irqsave(&idt77105_priv_lock, flags);\r\nPRIV(dev)->next = idt77105_all;\r\nidt77105_all = PRIV(dev);\r\nspin_unlock_irqrestore(&idt77105_priv_lock, flags);\r\nmemset(&PRIV(dev)->stats,0,sizeof(struct idt77105_stats));\r\natm_dev_signal_change(dev,\r\nGET(ISTAT) & IDT77105_ISTAT_GOODSIG ?\r\nATM_PHY_SIG_FOUND : ATM_PHY_SIG_LOST);\r\nif (dev->signal == ATM_PHY_SIG_LOST)\r\nprintk(KERN_WARNING "%s(itf %d): no signal\n",dev->type,\r\ndev->number);\r\nswitch ( GET(DIAG) & IDT77105_DIAG_LCMASK ) {\r\ncase IDT77105_DIAG_LC_NORMAL:\r\nPRIV(dev)->loop_mode = ATM_LM_NONE;\r\nbreak;\r\ncase IDT77105_DIAG_LC_PHY_LOOPBACK:\r\nPRIV(dev)->loop_mode = ATM_LM_LOC_ATM;\r\nbreak;\r\ncase IDT77105_DIAG_LC_LINE_LOOPBACK:\r\nPRIV(dev)->loop_mode = ATM_LM_RMT_ATM;\r\nbreak;\r\n}\r\nPRIV(dev)->old_mcr = GET(MCR);\r\nif (dev->signal == ATM_PHY_SIG_FOUND) {\r\nPRIV(dev)->old_mcr |= IDT77105_MCR_EIP;\r\nPUT(PRIV(dev)->old_mcr, MCR);\r\n}\r\nidt77105_stats_timer_func(0);\r\n(void) fetch_stats(dev,NULL,1);\r\nspin_lock_irqsave(&idt77105_priv_lock, flags);\r\nif (start_timer) {\r\nstart_timer = 0;\r\ninit_timer(&stats_timer);\r\nstats_timer.expires = jiffies+IDT77105_STATS_TIMER_PERIOD;\r\nstats_timer.function = idt77105_stats_timer_func;\r\nadd_timer(&stats_timer);\r\ninit_timer(&restart_timer);\r\nrestart_timer.expires = jiffies+IDT77105_RESTART_TIMER_PERIOD;\r\nrestart_timer.function = idt77105_restart_timer_func;\r\nadd_timer(&restart_timer);\r\n}\r\nspin_unlock_irqrestore(&idt77105_priv_lock, flags);\r\nreturn 0;\r\n}\r\nstatic int idt77105_stop(struct atm_dev *dev)\r\n{\r\nstruct idt77105_priv *walk, *prev;\r\nDPRINTK("%s(itf %d): stopping IDT77105\n",dev->type,dev->number);\r\nPUT( GET(MCR) & ~IDT77105_MCR_EIP, MCR );\r\nfor (prev = NULL, walk = idt77105_all ;\r\nwalk != NULL;\r\nprev = walk, walk = walk->next) {\r\nif (walk->dev == dev) {\r\nif (prev != NULL)\r\nprev->next = walk->next;\r\nelse\r\nidt77105_all = walk->next;\r\ndev->phy = NULL;\r\ndev->dev_data = NULL;\r\nkfree(walk);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint idt77105_init(struct atm_dev *dev)\r\n{\r\ndev->phy = &idt77105_ops;\r\nreturn 0;\r\n}\r\nstatic void __exit idt77105_exit(void)\r\n{\r\ndel_timer_sync(&stats_timer);\r\ndel_timer_sync(&restart_timer);\r\n}

enum target_errno target__validate(struct target *target)\r\n{\r\nenum target_errno ret = TARGET_ERRNO__SUCCESS;\r\nif (target->pid)\r\ntarget->tid = target->pid;\r\nif (target->tid && target->cpu_list) {\r\ntarget->cpu_list = NULL;\r\nif (ret == TARGET_ERRNO__SUCCESS)\r\nret = TARGET_ERRNO__PID_OVERRIDE_CPU;\r\n}\r\nif (target->tid && target->uid_str) {\r\ntarget->uid_str = NULL;\r\nif (ret == TARGET_ERRNO__SUCCESS)\r\nret = TARGET_ERRNO__PID_OVERRIDE_UID;\r\n}\r\nif (target->uid_str && target->cpu_list) {\r\ntarget->cpu_list = NULL;\r\nif (ret == TARGET_ERRNO__SUCCESS)\r\nret = TARGET_ERRNO__UID_OVERRIDE_CPU;\r\n}\r\nif (target->tid && target->system_wide) {\r\ntarget->system_wide = false;\r\nif (ret == TARGET_ERRNO__SUCCESS)\r\nret = TARGET_ERRNO__PID_OVERRIDE_SYSTEM;\r\n}\r\nif (target->uid_str && target->system_wide) {\r\ntarget->system_wide = false;\r\nif (ret == TARGET_ERRNO__SUCCESS)\r\nret = TARGET_ERRNO__UID_OVERRIDE_SYSTEM;\r\n}\r\nif (target->per_thread && (target->system_wide || target->cpu_list)) {\r\ntarget->per_thread = false;\r\nif (ret == TARGET_ERRNO__SUCCESS)\r\nret = TARGET_ERRNO__SYSTEM_OVERRIDE_THREAD;\r\n}\r\nreturn ret;\r\n}\r\nenum target_errno target__parse_uid(struct target *target)\r\n{\r\nstruct passwd pwd, *result;\r\nchar buf[1024];\r\nconst char *str = target->uid_str;\r\ntarget->uid = UINT_MAX;\r\nif (str == NULL)\r\nreturn TARGET_ERRNO__SUCCESS;\r\ngetpwnam_r(str, &pwd, buf, sizeof(buf), &result);\r\nif (result == NULL) {\r\nchar *endptr;\r\nint uid = strtol(str, &endptr, 10);\r\nif (*endptr != '\0')\r\nreturn TARGET_ERRNO__INVALID_UID;\r\ngetpwuid_r(uid, &pwd, buf, sizeof(buf), &result);\r\nif (result == NULL)\r\nreturn TARGET_ERRNO__USER_NOT_FOUND;\r\n}\r\ntarget->uid = result->pw_uid;\r\nreturn TARGET_ERRNO__SUCCESS;\r\n}\r\nint target__strerror(struct target *target, int errnum,\r\nchar *buf, size_t buflen)\r\n{\r\nint idx;\r\nconst char *msg;\r\nBUG_ON(buflen == 0);\r\nif (errnum >= 0) {\r\nconst char *err = strerror_r(errnum, buf, buflen);\r\nif (err != buf) {\r\nsize_t len = strlen(err);\r\nmemcpy(buf, err, min(buflen - 1, len));\r\n*(buf + min(buflen - 1, len)) = '\0';\r\n}\r\nreturn 0;\r\n}\r\nif (errnum < __TARGET_ERRNO__START || errnum >= __TARGET_ERRNO__END)\r\nreturn -1;\r\nidx = errnum - __TARGET_ERRNO__START;\r\nmsg = target__error_str[idx];\r\nswitch (errnum) {\r\ncase TARGET_ERRNO__PID_OVERRIDE_CPU ...\r\nTARGET_ERRNO__SYSTEM_OVERRIDE_THREAD:\r\nsnprintf(buf, buflen, "%s", msg);\r\nbreak;\r\ncase TARGET_ERRNO__INVALID_UID:\r\ncase TARGET_ERRNO__USER_NOT_FOUND:\r\nsnprintf(buf, buflen, msg, target->uid_str);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}

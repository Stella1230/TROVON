void rose_loopback_init(void)\r\n{\r\nskb_queue_head_init(&loopback_queue);\r\ninit_timer(&loopback_timer);\r\n}\r\nstatic int rose_loopback_running(void)\r\n{\r\nreturn timer_pending(&loopback_timer);\r\n}\r\nint rose_loopback_queue(struct sk_buff *skb, struct rose_neigh *neigh)\r\n{\r\nstruct sk_buff *skbn;\r\nskbn = skb_clone(skb, GFP_ATOMIC);\r\nkfree_skb(skb);\r\nif (skbn != NULL) {\r\nskb_queue_tail(&loopback_queue, skbn);\r\nif (!rose_loopback_running())\r\nrose_set_loopback_timer();\r\n}\r\nreturn 1;\r\n}\r\nstatic void rose_set_loopback_timer(void)\r\n{\r\ndel_timer(&loopback_timer);\r\nloopback_timer.data = 0;\r\nloopback_timer.function = &rose_loopback_timer;\r\nloopback_timer.expires = jiffies + 10;\r\nadd_timer(&loopback_timer);\r\n}\r\nstatic void rose_loopback_timer(unsigned long param)\r\n{\r\nstruct sk_buff *skb;\r\nstruct net_device *dev;\r\nrose_address *dest;\r\nstruct sock *sk;\r\nunsigned short frametype;\r\nunsigned int lci_i, lci_o;\r\nwhile ((skb = skb_dequeue(&loopback_queue)) != NULL) {\r\nif (skb->len < ROSE_MIN_LEN) {\r\nkfree_skb(skb);\r\ncontinue;\r\n}\r\nlci_i = ((skb->data[0] << 8) & 0xF00) + ((skb->data[1] << 0) & 0x0FF);\r\nframetype = skb->data[2];\r\nif (frametype == ROSE_CALL_REQUEST &&\r\n(skb->len <= ROSE_CALL_REQ_FACILITIES_OFF ||\r\nskb->data[ROSE_CALL_REQ_ADDR_LEN_OFF] !=\r\nROSE_CALL_REQ_ADDR_LEN_VAL)) {\r\nkfree_skb(skb);\r\ncontinue;\r\n}\r\ndest = (rose_address *)(skb->data + ROSE_CALL_REQ_DEST_ADDR_OFF);\r\nlci_o = ROSE_DEFAULT_MAXVC + 1 - lci_i;\r\nskb_reset_transport_header(skb);\r\nsk = rose_find_socket(lci_o, rose_loopback_neigh);\r\nif (sk) {\r\nif (rose_process_rx_frame(sk, skb) == 0)\r\nkfree_skb(skb);\r\ncontinue;\r\n}\r\nif (frametype == ROSE_CALL_REQUEST) {\r\nif ((dev = rose_dev_get(dest)) != NULL) {\r\nif (rose_rx_call_request(skb, dev, rose_loopback_neigh, lci_o) == 0)\r\nkfree_skb(skb);\r\n} else {\r\nkfree_skb(skb);\r\n}\r\n} else {\r\nkfree_skb(skb);\r\n}\r\n}\r\n}\r\nvoid __exit rose_loopback_clear(void)\r\n{\r\nstruct sk_buff *skb;\r\ndel_timer(&loopback_timer);\r\nwhile ((skb = skb_dequeue(&loopback_queue)) != NULL) {\r\nskb->sk = NULL;\r\nkfree_skb(skb);\r\n}\r\n}

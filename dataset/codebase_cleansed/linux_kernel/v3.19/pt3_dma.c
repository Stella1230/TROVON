static u32 get_dma_base(int idx)\r\n{\r\nint i;\r\ni = (idx == 1 || idx == 2) ? 3 - idx : idx;\r\nreturn REG_DMA_BASE + 0x18 * i;\r\n}\r\nint pt3_stop_dma(struct pt3_adapter *adap)\r\n{\r\nstruct pt3_board *pt3 = adap->dvb_adap.priv;\r\nu32 base;\r\nu32 stat;\r\nint retry;\r\nbase = get_dma_base(adap->adap_idx);\r\nstat = ioread32(pt3->regs[0] + base + OFST_STATUS);\r\nif (!(stat & 0x01))\r\nreturn 0;\r\niowrite32(0x02, pt3->regs[0] + base + OFST_DMA_CTL);\r\nfor (retry = 0; retry < 5; retry++) {\r\nstat = ioread32(pt3->regs[0] + base + OFST_STATUS);\r\nif (!(stat & 0x01))\r\nreturn 0;\r\nmsleep(50);\r\n}\r\nreturn -EIO;\r\n}\r\nint pt3_start_dma(struct pt3_adapter *adap)\r\n{\r\nstruct pt3_board *pt3 = adap->dvb_adap.priv;\r\nu32 base = get_dma_base(adap->adap_idx);\r\niowrite32(0x02, pt3->regs[0] + base + OFST_DMA_CTL);\r\niowrite32(lower_32_bits(adap->desc_buf[0].b_addr),\r\npt3->regs[0] + base + OFST_DMA_DESC_L);\r\niowrite32(upper_32_bits(adap->desc_buf[0].b_addr),\r\npt3->regs[0] + base + OFST_DMA_DESC_H);\r\niowrite32(0x01, pt3->regs[0] + base + OFST_DMA_CTL);\r\nreturn 0;\r\n}\r\nstatic u8 *next_unit(struct pt3_adapter *adap, int *idx, int *ofs)\r\n{\r\n*ofs += PT3_ACCESS_UNIT;\r\nif (*ofs >= DATA_BUF_SZ) {\r\n*ofs -= DATA_BUF_SZ;\r\n(*idx)++;\r\nif (*idx == adap->num_bufs)\r\n*idx = 0;\r\n}\r\nreturn &adap->buffer[*idx].data[*ofs];\r\n}\r\nint pt3_proc_dma(struct pt3_adapter *adap)\r\n{\r\nint idx, ofs;\r\nidx = adap->buf_idx;\r\nofs = adap->buf_ofs;\r\nif (adap->buffer[idx].data[ofs] == PT3_BUF_CANARY)\r\nreturn 0;\r\nwhile (*next_unit(adap, &idx, &ofs) != PT3_BUF_CANARY) {\r\nu8 *p;\r\np = &adap->buffer[adap->buf_idx].data[adap->buf_ofs];\r\nif (adap->num_discard > 0)\r\nadap->num_discard--;\r\nelse if (adap->buf_ofs + PT3_ACCESS_UNIT > DATA_BUF_SZ) {\r\ndvb_dmx_swfilter_packets(&adap->demux, p,\r\n(DATA_BUF_SZ - adap->buf_ofs) / TS_PACKET_SZ);\r\ndvb_dmx_swfilter_packets(&adap->demux,\r\nadap->buffer[idx].data, ofs / TS_PACKET_SZ);\r\n} else\r\ndvb_dmx_swfilter_packets(&adap->demux, p,\r\nPT3_ACCESS_UNIT / TS_PACKET_SZ);\r\n*p = PT3_BUF_CANARY;\r\nadap->buf_idx = idx;\r\nadap->buf_ofs = ofs;\r\n}\r\nreturn 0;\r\n}\r\nvoid pt3_init_dmabuf(struct pt3_adapter *adap)\r\n{\r\nint idx, ofs;\r\nu8 *p;\r\nidx = 0;\r\nofs = 0;\r\np = adap->buffer[0].data;\r\nwhile (idx < adap->num_bufs) {\r\np[ofs] = PT3_BUF_CANARY;\r\nofs += PT3_ACCESS_UNIT;\r\nif (ofs >= DATA_BUF_SZ) {\r\nofs -= DATA_BUF_SZ;\r\nidx++;\r\np = adap->buffer[idx].data;\r\n}\r\n}\r\nadap->buf_idx = 0;\r\nadap->buf_ofs = 0;\r\n}\r\nvoid pt3_free_dmabuf(struct pt3_adapter *adap)\r\n{\r\nstruct pt3_board *pt3;\r\nint i;\r\npt3 = adap->dvb_adap.priv;\r\nfor (i = 0; i < adap->num_bufs; i++)\r\ndma_free_coherent(&pt3->pdev->dev, DATA_BUF_SZ,\r\nadap->buffer[i].data, adap->buffer[i].b_addr);\r\nadap->num_bufs = 0;\r\nfor (i = 0; i < adap->num_desc_bufs; i++)\r\ndma_free_coherent(&pt3->pdev->dev, PAGE_SIZE,\r\nadap->desc_buf[i].descs, adap->desc_buf[i].b_addr);\r\nadap->num_desc_bufs = 0;\r\n}\r\nint pt3_alloc_dmabuf(struct pt3_adapter *adap)\r\n{\r\nstruct pt3_board *pt3;\r\nvoid *p;\r\nint i, j;\r\nint idx, ofs;\r\nint num_desc_bufs;\r\ndma_addr_t data_addr, desc_addr;\r\nstruct xfer_desc *d;\r\npt3 = adap->dvb_adap.priv;\r\nadap->num_bufs = 0;\r\nadap->num_desc_bufs = 0;\r\nfor (i = 0; i < pt3->num_bufs; i++) {\r\np = dma_alloc_coherent(&pt3->pdev->dev, DATA_BUF_SZ,\r\n&adap->buffer[i].b_addr, GFP_KERNEL);\r\nif (p == NULL)\r\ngoto failed;\r\nadap->buffer[i].data = p;\r\nadap->num_bufs++;\r\n}\r\npt3_init_dmabuf(adap);\r\nidx = 0;\r\nofs = 0;\r\nnum_desc_bufs =\r\nDIV_ROUND_UP(adap->num_bufs * DATA_BUF_XFERS, DESCS_IN_PAGE);\r\nfor (i = 0; i < num_desc_bufs; i++) {\r\np = dma_alloc_coherent(&pt3->pdev->dev, PAGE_SIZE,\r\n&desc_addr, GFP_KERNEL);\r\nif (p == NULL)\r\ngoto failed;\r\nadap->num_desc_bufs++;\r\nadap->desc_buf[i].descs = p;\r\nadap->desc_buf[i].b_addr = desc_addr;\r\nif (i > 0) {\r\nd = &adap->desc_buf[i - 1].descs[DESCS_IN_PAGE - 1];\r\nd->next_l = lower_32_bits(desc_addr);\r\nd->next_h = upper_32_bits(desc_addr);\r\n}\r\nfor (j = 0; j < DESCS_IN_PAGE; j++) {\r\ndata_addr = adap->buffer[idx].b_addr + ofs;\r\nd = &adap->desc_buf[i].descs[j];\r\nd->addr_l = lower_32_bits(data_addr);\r\nd->addr_h = upper_32_bits(data_addr);\r\nd->size = DATA_XFER_SZ;\r\ndesc_addr += sizeof(struct xfer_desc);\r\nd->next_l = lower_32_bits(desc_addr);\r\nd->next_h = upper_32_bits(desc_addr);\r\nofs += DATA_XFER_SZ;\r\nif (ofs >= DATA_BUF_SZ) {\r\nofs -= DATA_BUF_SZ;\r\nidx++;\r\nif (idx >= adap->num_bufs) {\r\ndesc_addr = adap->desc_buf[0].b_addr;\r\nd->next_l = lower_32_bits(desc_addr);\r\nd->next_h = upper_32_bits(desc_addr);\r\nreturn 0;\r\n}\r\n}\r\n}\r\n}\r\nreturn 0;\r\nfailed:\r\npt3_free_dmabuf(adap);\r\nreturn -ENOMEM;\r\n}

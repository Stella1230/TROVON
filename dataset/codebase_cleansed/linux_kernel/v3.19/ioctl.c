int sc_ioctl(int card, scs_ioctl *data)\r\n{\r\nint status;\r\nRspMessage *rcvmsg;\r\nchar *spid;\r\nchar *dn;\r\nchar switchtype;\r\nchar speed;\r\nrcvmsg = kmalloc(sizeof(RspMessage), GFP_KERNEL);\r\nif (!rcvmsg)\r\nreturn -ENOMEM;\r\nswitch (data->command) {\r\ncase SCIOCRESET:\r\n{\r\npr_debug("%s: SCIOCRESET: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nsc_adapter[card]->StartOnReset = 0;\r\nkfree(rcvmsg);\r\nreturn reset(card);\r\n}\r\ncase SCIOCLOAD:\r\n{\r\nchar *srec;\r\nsrec = kmalloc(SCIOC_SRECSIZE, GFP_KERNEL);\r\nif (!srec) {\r\nkfree(rcvmsg);\r\nreturn -ENOMEM;\r\n}\r\npr_debug("%s: SCIOLOAD: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nif (sc_adapter[card]->EngineUp) {\r\npr_debug("%s: SCIOCLOAD: command failed, LoadProc while engine running.\n",\r\nsc_adapter[card]->devicename);\r\nkfree(rcvmsg);\r\nkfree(srec);\r\nreturn -1;\r\n}\r\nif (copy_from_user(srec, data->dataptr, SCIOC_SRECSIZE)) {\r\nkfree(rcvmsg);\r\nkfree(srec);\r\nreturn -EFAULT;\r\n}\r\nstatus = send_and_receive(card, CMPID, cmReqType2, cmReqClass0, cmReqLoadProc,\r\n0, SCIOC_SRECSIZE, srec, rcvmsg, SAR_TIMEOUT);\r\nkfree(rcvmsg);\r\nkfree(srec);\r\nif (status) {\r\npr_debug("%s: SCIOCLOAD: command failed, status = %d\n",\r\nsc_adapter[card]->devicename, status);\r\nreturn -1;\r\n}\r\nelse {\r\npr_debug("%s: SCIOCLOAD: command successful\n",\r\nsc_adapter[card]->devicename);\r\nreturn 0;\r\n}\r\n}\r\ncase SCIOCSTART:\r\n{\r\nkfree(rcvmsg);\r\npr_debug("%s: SCIOSTART: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nif (sc_adapter[card]->EngineUp) {\r\npr_debug("%s: SCIOCSTART: command failed, engine already running.\n",\r\nsc_adapter[card]->devicename);\r\nreturn -1;\r\n}\r\nsc_adapter[card]->StartOnReset = 1;\r\nstartproc(card);\r\nreturn 0;\r\n}\r\ncase SCIOCSETSWITCH:\r\n{\r\npr_debug("%s: SCIOSETSWITCH: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nif (copy_from_user(&switchtype, data->dataptr, sizeof(char))) {\r\nkfree(rcvmsg);\r\nreturn -EFAULT;\r\n}\r\npr_debug("%s: SCIOCSETSWITCH: setting switch type to %d\n",\r\nsc_adapter[card]->devicename,\r\nswitchtype);\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0, ceReqCallSetSwitchType,\r\n0, sizeof(char), &switchtype, rcvmsg, SAR_TIMEOUT);\r\nif (!status && !(rcvmsg->rsp_status)) {\r\npr_debug("%s: SCIOCSETSWITCH: command successful\n",\r\nsc_adapter[card]->devicename);\r\nkfree(rcvmsg);\r\nreturn 0;\r\n}\r\nelse {\r\npr_debug("%s: SCIOCSETSWITCH: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(rcvmsg);\r\nreturn status;\r\n}\r\n}\r\ncase SCIOCGETSWITCH:\r\n{\r\npr_debug("%s: SCIOGETSWITCH: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0,\r\nceReqCallGetSwitchType, 0, 0, NULL, rcvmsg, SAR_TIMEOUT);\r\nif (!status && !(rcvmsg->rsp_status)) {\r\npr_debug("%s: SCIOCGETSWITCH: command successful\n",\r\nsc_adapter[card]->devicename);\r\n}\r\nelse {\r\npr_debug("%s: SCIOCGETSWITCH: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(rcvmsg);\r\nreturn status;\r\n}\r\nswitchtype = rcvmsg->msg_data.byte_array[0];\r\nif (copy_to_user(data->dataptr, &switchtype,\r\nsizeof(char))) {\r\nkfree(rcvmsg);\r\nreturn -EFAULT;\r\n}\r\nkfree(rcvmsg);\r\nreturn 0;\r\n}\r\ncase SCIOCGETSPID:\r\n{\r\npr_debug("%s: SCIOGETSPID: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nspid = kzalloc(SCIOC_SPIDSIZE, GFP_KERNEL);\r\nif (!spid) {\r\nkfree(rcvmsg);\r\nreturn -ENOMEM;\r\n}\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0, ceReqCallGetSPID,\r\ndata->channel, 0, NULL, rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\npr_debug("%s: SCIOCGETSPID: command successful\n",\r\nsc_adapter[card]->devicename);\r\n} else {\r\npr_debug("%s: SCIOCGETSPID: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(spid);\r\nkfree(rcvmsg);\r\nreturn status;\r\n}\r\nstrlcpy(spid, rcvmsg->msg_data.byte_array, SCIOC_SPIDSIZE);\r\nif (copy_to_user(data->dataptr, spid, SCIOC_SPIDSIZE)) {\r\nkfree(spid);\r\nkfree(rcvmsg);\r\nreturn -EFAULT;\r\n}\r\nkfree(spid);\r\nkfree(rcvmsg);\r\nreturn 0;\r\n}\r\ncase SCIOCSETSPID:\r\n{\r\npr_debug("%s: DCBIOSETSPID: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nspid = memdup_user(data->dataptr, SCIOC_SPIDSIZE);\r\nif (IS_ERR(spid)) {\r\nkfree(rcvmsg);\r\nreturn PTR_ERR(spid);\r\n}\r\npr_debug("%s: SCIOCSETSPID: setting channel %d spid to %s\n",\r\nsc_adapter[card]->devicename, data->channel, spid);\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall,\r\nceReqClass0, ceReqCallSetSPID, data->channel,\r\nstrlen(spid), spid, rcvmsg, SAR_TIMEOUT);\r\nif (!status && !(rcvmsg->rsp_status)) {\r\npr_debug("%s: SCIOCSETSPID: command successful\n",\r\nsc_adapter[card]->devicename);\r\nkfree(rcvmsg);\r\nkfree(spid);\r\nreturn 0;\r\n}\r\nelse {\r\npr_debug("%s: SCIOCSETSPID: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(rcvmsg);\r\nkfree(spid);\r\nreturn status;\r\n}\r\n}\r\ncase SCIOCGETDN:\r\n{\r\npr_debug("%s: SCIOGETDN: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0, ceReqCallGetMyNumber,\r\ndata->channel, 0, NULL, rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\npr_debug("%s: SCIOCGETDN: command successful\n",\r\nsc_adapter[card]->devicename);\r\n}\r\nelse {\r\npr_debug("%s: SCIOCGETDN: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(rcvmsg);\r\nreturn status;\r\n}\r\ndn = kzalloc(SCIOC_DNSIZE, GFP_KERNEL);\r\nif (!dn) {\r\nkfree(rcvmsg);\r\nreturn -ENOMEM;\r\n}\r\nstrlcpy(dn, rcvmsg->msg_data.byte_array, SCIOC_DNSIZE);\r\nkfree(rcvmsg);\r\nif (copy_to_user(data->dataptr, dn, SCIOC_DNSIZE)) {\r\nkfree(dn);\r\nreturn -EFAULT;\r\n}\r\nkfree(dn);\r\nreturn 0;\r\n}\r\ncase SCIOCSETDN:\r\n{\r\npr_debug("%s: SCIOSETDN: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\ndn = memdup_user(data->dataptr, SCIOC_DNSIZE);\r\nif (IS_ERR(dn)) {\r\nkfree(rcvmsg);\r\nreturn PTR_ERR(dn);\r\n}\r\npr_debug("%s: SCIOCSETDN: setting channel %d dn to %s\n",\r\nsc_adapter[card]->devicename, data->channel, dn);\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall,\r\nceReqClass0, ceReqCallSetMyNumber, data->channel,\r\nstrlen(dn), dn, rcvmsg, SAR_TIMEOUT);\r\nif (!status && !(rcvmsg->rsp_status)) {\r\npr_debug("%s: SCIOCSETDN: command successful\n",\r\nsc_adapter[card]->devicename);\r\nkfree(rcvmsg);\r\nkfree(dn);\r\nreturn 0;\r\n}\r\nelse {\r\npr_debug("%s: SCIOCSETDN: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(rcvmsg);\r\nkfree(dn);\r\nreturn status;\r\n}\r\n}\r\ncase SCIOCTRACE:\r\npr_debug("%s: SCIOTRACE: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nbreak;\r\ncase SCIOCSTAT:\r\n{\r\nboardInfo *bi;\r\npr_debug("%s: SCIOSTAT: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nbi = kzalloc(sizeof(boardInfo), GFP_KERNEL);\r\nif (!bi) {\r\nkfree(rcvmsg);\r\nreturn -ENOMEM;\r\n}\r\nkfree(rcvmsg);\r\nGetStatus(card, bi);\r\nif (copy_to_user(data->dataptr, bi, sizeof(boardInfo))) {\r\nkfree(bi);\r\nreturn -EFAULT;\r\n}\r\nkfree(bi);\r\nreturn 0;\r\n}\r\ncase SCIOCGETSPEED:\r\n{\r\npr_debug("%s: SCIOGETSPEED: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0,\r\nceReqCallGetCallType, data->channel, 0, NULL, rcvmsg, SAR_TIMEOUT);\r\nif (!status && !(rcvmsg->rsp_status)) {\r\npr_debug("%s: SCIOCGETSPEED: command successful\n",\r\nsc_adapter[card]->devicename);\r\n}\r\nelse {\r\npr_debug("%s: SCIOCGETSPEED: command failed (status = %d)\n",\r\nsc_adapter[card]->devicename, status);\r\nkfree(rcvmsg);\r\nreturn status;\r\n}\r\nspeed = rcvmsg->msg_data.byte_array[0];\r\nkfree(rcvmsg);\r\nif (copy_to_user(data->dataptr, &speed, sizeof(char)))\r\nreturn -EFAULT;\r\nreturn 0;\r\n}\r\ncase SCIOCSETSPEED:\r\npr_debug("%s: SCIOCSETSPEED: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nbreak;\r\ncase SCIOCLOOPTST:\r\npr_debug("%s: SCIOCLOOPTST: ioctl received\n",\r\nsc_adapter[card]->devicename);\r\nbreak;\r\ndefault:\r\nkfree(rcvmsg);\r\nreturn -1;\r\n}\r\nkfree(rcvmsg);\r\nreturn 0;\r\n}\r\nstatic int GetStatus(int card, boardInfo *bi)\r\n{\r\nRspMessage rcvmsg;\r\nint i, status;\r\nbi->modelid = sc_adapter[card]->model;\r\nstrcpy(bi->serial_no, sc_adapter[card]->hwconfig.serial_no);\r\nstrcpy(bi->part_no, sc_adapter[card]->hwconfig.part_no);\r\nbi->iobase = sc_adapter[card]->iobase;\r\nbi->rambase = sc_adapter[card]->rambase;\r\nbi->irq = sc_adapter[card]->interrupt;\r\nbi->ramsize = sc_adapter[card]->hwconfig.ram_size;\r\nbi->interface = sc_adapter[card]->hwconfig.st_u_sense;\r\nstrcpy(bi->load_ver, sc_adapter[card]->load_ver);\r\nstrcpy(bi->proc_ver, sc_adapter[card]->proc_ver);\r\nstatus = send_and_receive(card, CEPID, ceReqTypePhy, ceReqClass2,\r\nceReqPhyStatus, 0, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nif (sc_adapter[card]->model < PRI_BOARD) {\r\nbi->l1_status = rcvmsg.msg_data.byte_array[2];\r\nfor (i = 0; i < BRI_CHANNELS; i++)\r\nbi->status.bristats[i].phy_stat =\r\nrcvmsg.msg_data.byte_array[i];\r\n}\r\nelse {\r\nbi->l1_status = rcvmsg.msg_data.byte_array[0];\r\nbi->l2_status = rcvmsg.msg_data.byte_array[1];\r\nfor (i = 0; i < PRI_CHANNELS; i++)\r\nbi->status.pristats[i].phy_stat =\r\nrcvmsg.msg_data.byte_array[i + 2];\r\n}\r\n}\r\nfor (i = 0; i < sc_adapter[card]->nChannels; i++) {\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0,\r\nceReqCallGetCallType, 0, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nif (sc_adapter[card]->model == PRI_BOARD) {\r\nbi->status.pristats[i].call_type =\r\nrcvmsg.msg_data.byte_array[0];\r\n}\r\nelse {\r\nbi->status.bristats[i].call_type =\r\nrcvmsg.msg_data.byte_array[0];\r\n}\r\n}\r\n}\r\nif (sc_adapter[card]->model == PRI_BOARD) {\r\nstatus = send_and_receive(card, CEPID, ceReqTypeStat, ceReqClass2,\r\nceReqPhyChCallState, 0, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nfor (i = 0; i < PRI_CHANNELS; i++)\r\nbi->status.pristats[i].call_state =\r\nrcvmsg.msg_data.byte_array[i];\r\n}\r\nstatus = send_and_receive(card, CEPID, ceReqTypeStat, ceReqClass2,\r\nceReqPhyChServState, 0, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nfor (i = 0; i < PRI_CHANNELS; i++)\r\nbi->status.pristats[i].serv_state =\r\nrcvmsg.msg_data.byte_array[i];\r\n}\r\nfor (i = 1; i <= PRI_CHANNELS; i++) {\r\nstatus = send_and_receive(card, CEPID, ceReqTypeLnk, ceReqClass0,\r\nceReqLnkGetStats, i, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nbi->status.pristats[i - 1].link_stats.tx_good =\r\n(unsigned long)rcvmsg.msg_data.byte_array[0];\r\nbi->status.pristats[i - 1].link_stats.tx_bad =\r\n(unsigned long)rcvmsg.msg_data.byte_array[4];\r\nbi->status.pristats[i - 1].link_stats.rx_good =\r\n(unsigned long)rcvmsg.msg_data.byte_array[8];\r\nbi->status.pristats[i - 1].link_stats.rx_bad =\r\n(unsigned long)rcvmsg.msg_data.byte_array[12];\r\n}\r\n}\r\nstatus = send_and_receive(card, CEPID, ceReqTypeLnk, ceReqClass0,\r\nceReqLnkGetStats, 0, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nbi->dch_stats.tx_good = (unsigned long)rcvmsg.msg_data.byte_array[0];\r\nbi->dch_stats.tx_bad = (unsigned long)rcvmsg.msg_data.byte_array[4];\r\nbi->dch_stats.rx_good = (unsigned long)rcvmsg.msg_data.byte_array[8];\r\nbi->dch_stats.rx_bad = (unsigned long)rcvmsg.msg_data.byte_array[12];\r\n}\r\nreturn 0;\r\n}\r\nstatus = send_and_receive(card, CEPID, ceReqTypeLnk, ceReqClass0,\r\nceReqLnkGetStats, 0, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status) {\r\nbi->dch_stats.tx_good = (unsigned long)rcvmsg.msg_data.byte_array[0];\r\nbi->dch_stats.tx_bad = (unsigned long)rcvmsg.msg_data.byte_array[4];\r\nbi->dch_stats.rx_good = (unsigned long)rcvmsg.msg_data.byte_array[8];\r\nbi->dch_stats.rx_bad = (unsigned long)rcvmsg.msg_data.byte_array[12];\r\nbi->status.bristats[0].link_stats.tx_good =\r\n(unsigned long)rcvmsg.msg_data.byte_array[16];\r\nbi->status.bristats[0].link_stats.tx_bad =\r\n(unsigned long)rcvmsg.msg_data.byte_array[20];\r\nbi->status.bristats[0].link_stats.rx_good =\r\n(unsigned long)rcvmsg.msg_data.byte_array[24];\r\nbi->status.bristats[0].link_stats.rx_bad =\r\n(unsigned long)rcvmsg.msg_data.byte_array[28];\r\nbi->status.bristats[1].link_stats.tx_good =\r\n(unsigned long)rcvmsg.msg_data.byte_array[32];\r\nbi->status.bristats[1].link_stats.tx_bad =\r\n(unsigned long)rcvmsg.msg_data.byte_array[36];\r\nbi->status.bristats[1].link_stats.rx_good =\r\n(unsigned long)rcvmsg.msg_data.byte_array[40];\r\nbi->status.bristats[1].link_stats.rx_bad =\r\n(unsigned long)rcvmsg.msg_data.byte_array[44];\r\n}\r\nfor (i = 0; i < BRI_CHANNELS; i++) {\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0,\r\nceReqCallGetSPID, i + 1, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status)\r\nstrcpy(bi->status.bristats[i].spid, rcvmsg.msg_data.byte_array);\r\n}\r\nfor (i = 0; i < BRI_CHANNELS; i++) {\r\nstatus = send_and_receive(card, CEPID, ceReqTypeCall, ceReqClass0,\r\nceReqCallGetMyNumber, i + 1, 0, NULL, &rcvmsg, SAR_TIMEOUT);\r\nif (!status)\r\nstrcpy(bi->status.bristats[i].dn, rcvmsg.msg_data.byte_array);\r\n}\r\nreturn 0;\r\n}

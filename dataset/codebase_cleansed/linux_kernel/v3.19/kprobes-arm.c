static void __kprobes\r\nemulate_ldrdstrd(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nunsigned long pc = regs->ARM_pc + 4;\r\nint rt = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rtv asm("r0") = regs->uregs[rt];\r\nregister unsigned long rt2v asm("r1") = regs->uregs[rt+1];\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? pc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rtv), "=r" (rt2v), "=r" (rnv)\r\n: "0" (rtv), "1" (rt2v), "2" (rnv), "r" (rmv),\r\n[fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rt] = rtv;\r\nregs->uregs[rt+1] = rt2v;\r\nif (is_writeback(insn))\r\nregs->uregs[rn] = rnv;\r\n}\r\nstatic void __kprobes\r\nemulate_ldr(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nunsigned long pc = regs->ARM_pc + 4;\r\nint rt = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rtv asm("r0");\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? pc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rtv), "=r" (rnv)\r\n: "1" (rnv), "r" (rmv), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nif (rt == 15)\r\nload_write_pc(rtv, regs);\r\nelse\r\nregs->uregs[rt] = rtv;\r\nif (is_writeback(insn))\r\nregs->uregs[rn] = rnv;\r\n}\r\nstatic void __kprobes\r\nemulate_str(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nunsigned long rtpc = regs->ARM_pc - 4 + str_pc_offset;\r\nunsigned long rnpc = regs->ARM_pc + 4;\r\nint rt = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rtv asm("r0") = (rt == 15) ? rtpc\r\n: regs->uregs[rt];\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? rnpc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rnv)\r\n: "r" (rtv), "0" (rnv), "r" (rmv), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nif (is_writeback(insn))\r\nregs->uregs[rn] = rnv;\r\n}\r\nstatic void __kprobes\r\nemulate_rd12rn16rm0rs8_rwflags(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nunsigned long pc = regs->ARM_pc + 4;\r\nint rd = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nint rs = (insn >> 8) & 0xf;\r\nregister unsigned long rdv asm("r0") = regs->uregs[rd];\r\nregister unsigned long rnv asm("r2") = (rn == 15) ? pc\r\n: regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = (rm == 15) ? pc\r\n: regs->uregs[rm];\r\nregister unsigned long rsv asm("r1") = regs->uregs[rs];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdv), [cpsr] "=r" (cpsr)\r\n: "0" (rdv), "r" (rnv), "r" (rmv), "r" (rsv),\r\n"1" (cpsr), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nif (rd == 15)\r\nalu_write_pc(rdv, regs);\r\nelse\r\nregs->uregs[rd] = rdv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes\r\nemulate_rd12rn16rm0_rwflags_nopc(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nint rd = (insn >> 12) & 0xf;\r\nint rn = (insn >> 16) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rdv asm("r0") = regs->uregs[rd];\r\nregister unsigned long rnv asm("r2") = regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdv), [cpsr] "=r" (cpsr)\r\n: "0" (rdv), "r" (rnv), "r" (rmv),\r\n"1" (cpsr), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rd] = rdv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes\r\nemulate_rd16rn12rm0rs8_rwflags_nopc(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi,\r\nstruct pt_regs *regs)\r\n{\r\nint rd = (insn >> 16) & 0xf;\r\nint rn = (insn >> 12) & 0xf;\r\nint rm = insn & 0xf;\r\nint rs = (insn >> 8) & 0xf;\r\nregister unsigned long rdv asm("r2") = regs->uregs[rd];\r\nregister unsigned long rnv asm("r0") = regs->uregs[rn];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\nregister unsigned long rsv asm("r1") = regs->uregs[rs];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdv), [cpsr] "=r" (cpsr)\r\n: "0" (rdv), "r" (rnv), "r" (rmv), "r" (rsv),\r\n"1" (cpsr), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rd] = rdv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}\r\nstatic void __kprobes\r\nemulate_rd12rm0_noflags_nopc(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi, struct pt_regs *regs)\r\n{\r\nint rd = (insn >> 12) & 0xf;\r\nint rm = insn & 0xf;\r\nregister unsigned long rdv asm("r0") = regs->uregs[rd];\r\nregister unsigned long rmv asm("r3") = regs->uregs[rm];\r\n__asm__ __volatile__ (\r\nBLX("%[fn]")\r\n: "=r" (rdv)\r\n: "0" (rdv), "r" (rmv), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rd] = rdv;\r\n}\r\nstatic void __kprobes\r\nemulate_rdlo12rdhi16rn0rm8_rwflags_nopc(probes_opcode_t insn,\r\nstruct arch_probes_insn *asi,\r\nstruct pt_regs *regs)\r\n{\r\nint rdlo = (insn >> 12) & 0xf;\r\nint rdhi = (insn >> 16) & 0xf;\r\nint rn = insn & 0xf;\r\nint rm = (insn >> 8) & 0xf;\r\nregister unsigned long rdlov asm("r0") = regs->uregs[rdlo];\r\nregister unsigned long rdhiv asm("r2") = regs->uregs[rdhi];\r\nregister unsigned long rnv asm("r3") = regs->uregs[rn];\r\nregister unsigned long rmv asm("r1") = regs->uregs[rm];\r\nunsigned long cpsr = regs->ARM_cpsr;\r\n__asm__ __volatile__ (\r\n"msr cpsr_fs, %[cpsr] \n\t"\r\nBLX("%[fn]")\r\n"mrs %[cpsr], cpsr \n\t"\r\n: "=r" (rdlov), "=r" (rdhiv), [cpsr] "=r" (cpsr)\r\n: "0" (rdlov), "1" (rdhiv), "r" (rnv), "r" (rmv),\r\n"2" (cpsr), [fn] "r" (asi->insn_fn)\r\n: "lr", "memory", "cc"\r\n);\r\nregs->uregs[rdlo] = rdlov;\r\nregs->uregs[rdhi] = rdhiv;\r\nregs->ARM_cpsr = (regs->ARM_cpsr & ~APSR_MASK) | (cpsr & APSR_MASK);\r\n}

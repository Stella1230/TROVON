int af9005_rc_decode(struct dvb_usb_device *d, u8 * data, int len, u32 * event,\r\nint *state)\r\n{\r\nu16 mark, space;\r\nu32 result;\r\nu8 cust, dat, invdat;\r\nint i;\r\nif (len >= 6) {\r\nmark = (u16) (data[0] << 8) + data[1];\r\nspace = (u16) (data[2] << 8) + data[3];\r\nif (space * 3 < mark) {\r\nfor (i = 0; i < ARRAY_SIZE(repeatable_keys); i++) {\r\nif (d->last_event == repeatable_keys[i]) {\r\n*state = REMOTE_KEY_REPEAT;\r\n*event = d->last_event;\r\ndeb_decode("repeat key, event %x\n",\r\n*event);\r\nreturn 0;\r\n}\r\n}\r\ndeb_decode("repeated key ignored (non repeatable)\n");\r\nreturn 0;\r\n} else if (len >= 33 * 4) {\r\nresult = 0;\r\nfor (i = 4; i < 4 + 32 * 4; i += 4) {\r\nresult <<= 1;\r\nmark = (u16) (data[i] << 8) + data[i + 1];\r\nmark >>= 1;\r\nspace = (u16) (data[i + 2] << 8) + data[i + 3];\r\nspace >>= 1;\r\nif (mark * 2 > space)\r\nresult += 1;\r\n}\r\ndeb_decode("key pressed, raw value %x\n", result);\r\nif ((result & 0xff000000) != 0xfe000000) {\r\ndeb_decode\r\n("doesn't start with 0xfe, ignored\n");\r\nreturn 0;\r\n}\r\ncust = (result >> 16) & 0xff;\r\ndat = (result >> 8) & 0xff;\r\ninvdat = (~result) & 0xff;\r\nif (dat != invdat) {\r\ndeb_decode("code != inverted code\n");\r\nreturn 0;\r\n}\r\nfor (i = 0; i < rc_map_af9005_table_size; i++) {\r\nif (rc5_custom(&rc_map_af9005_table[i]) == cust\r\n&& rc5_data(&rc_map_af9005_table[i]) == dat) {\r\n*event = rc_map_af9005_table[i].keycode;\r\n*state = REMOTE_KEY_PRESSED;\r\ndeb_decode\r\n("key pressed, event %x\n", *event);\r\nreturn 0;\r\n}\r\n}\r\ndeb_decode("not found in table\n");\r\n}\r\n}\r\nreturn 0;\r\n}

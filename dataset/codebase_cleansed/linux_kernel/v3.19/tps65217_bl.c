static int tps65217_bl_enable(struct tps65217_bl *tps65217_bl)\r\n{\r\nint rc;\r\nrc = tps65217_set_bits(tps65217_bl->tps, TPS65217_REG_WLEDCTRL1,\r\nTPS65217_WLEDCTRL1_ISINK_ENABLE,\r\nTPS65217_WLEDCTRL1_ISINK_ENABLE, TPS65217_PROTECT_NONE);\r\nif (rc) {\r\ndev_err(tps65217_bl->dev,\r\n"failed to enable backlight: %d\n", rc);\r\nreturn rc;\r\n}\r\ntps65217_bl->is_enabled = true;\r\ndev_dbg(tps65217_bl->dev, "backlight enabled\n");\r\nreturn 0;\r\n}\r\nstatic int tps65217_bl_disable(struct tps65217_bl *tps65217_bl)\r\n{\r\nint rc;\r\nrc = tps65217_clear_bits(tps65217_bl->tps,\r\nTPS65217_REG_WLEDCTRL1,\r\nTPS65217_WLEDCTRL1_ISINK_ENABLE,\r\nTPS65217_PROTECT_NONE);\r\nif (rc) {\r\ndev_err(tps65217_bl->dev,\r\n"failed to disable backlight: %d\n", rc);\r\nreturn rc;\r\n}\r\ntps65217_bl->is_enabled = false;\r\ndev_dbg(tps65217_bl->dev, "backlight disabled\n");\r\nreturn 0;\r\n}\r\nstatic int tps65217_bl_update_status(struct backlight_device *bl)\r\n{\r\nstruct tps65217_bl *tps65217_bl = bl_get_data(bl);\r\nint rc;\r\nint brightness = bl->props.brightness;\r\nif (bl->props.state & BL_CORE_SUSPENDED)\r\nbrightness = 0;\r\nif ((bl->props.power != FB_BLANK_UNBLANK) ||\r\n(bl->props.fb_blank != FB_BLANK_UNBLANK))\r\nbrightness = 0;\r\nif (brightness > 0) {\r\nrc = tps65217_reg_write(tps65217_bl->tps,\r\nTPS65217_REG_WLEDCTRL2,\r\nbrightness - 1,\r\nTPS65217_PROTECT_NONE);\r\nif (rc) {\r\ndev_err(tps65217_bl->dev,\r\n"failed to set brightness level: %d\n", rc);\r\nreturn rc;\r\n}\r\ndev_dbg(tps65217_bl->dev, "brightness set to %d\n", brightness);\r\nif (!tps65217_bl->is_enabled)\r\nrc = tps65217_bl_enable(tps65217_bl);\r\n} else {\r\nrc = tps65217_bl_disable(tps65217_bl);\r\n}\r\nreturn rc;\r\n}\r\nstatic int tps65217_bl_hw_init(struct tps65217_bl *tps65217_bl,\r\nstruct tps65217_bl_pdata *pdata)\r\n{\r\nint rc;\r\nrc = tps65217_bl_disable(tps65217_bl);\r\nif (rc)\r\nreturn rc;\r\nswitch (pdata->isel) {\r\ncase TPS65217_BL_ISET1:\r\nrc = tps65217_clear_bits(tps65217_bl->tps,\r\nTPS65217_REG_WLEDCTRL1,\r\nTPS65217_WLEDCTRL1_ISEL,\r\nTPS65217_PROTECT_NONE);\r\nif (rc) {\r\ndev_err(tps65217_bl->dev,\r\n"failed to select ISET1 current level: %d)\n",\r\nrc);\r\nreturn rc;\r\n}\r\ndev_dbg(tps65217_bl->dev, "selected ISET1 current level\n");\r\nbreak;\r\ncase TPS65217_BL_ISET2:\r\nrc = tps65217_set_bits(tps65217_bl->tps, TPS65217_REG_WLEDCTRL1,\r\nTPS65217_WLEDCTRL1_ISEL,\r\nTPS65217_WLEDCTRL1_ISEL, TPS65217_PROTECT_NONE);\r\nif (rc) {\r\ndev_err(tps65217_bl->dev,\r\n"failed to select ISET2 current level: %d\n",\r\nrc);\r\nreturn rc;\r\n}\r\ndev_dbg(tps65217_bl->dev, "selected ISET2 current level\n");\r\nbreak;\r\ndefault:\r\ndev_err(tps65217_bl->dev,\r\n"invalid value for current level: %d\n", pdata->isel);\r\nreturn -EINVAL;\r\n}\r\nrc = tps65217_set_bits(tps65217_bl->tps,\r\nTPS65217_REG_WLEDCTRL1,\r\nTPS65217_WLEDCTRL1_FDIM_MASK,\r\npdata->fdim,\r\nTPS65217_PROTECT_NONE);\r\nif (rc) {\r\ndev_err(tps65217_bl->dev,\r\n"failed to select PWM dimming frequency: %d\n",\r\nrc);\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic struct tps65217_bl_pdata *\r\ntps65217_bl_parse_dt(struct platform_device *pdev)\r\n{\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct device_node *node = of_node_get(tps->dev->of_node);\r\nstruct tps65217_bl_pdata *pdata, *err;\r\nu32 val;\r\nnode = of_find_node_by_name(node, "backlight");\r\nif (!node)\r\nreturn ERR_PTR(-ENODEV);\r\npdata = devm_kzalloc(&pdev->dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata) {\r\nerr = ERR_PTR(-ENOMEM);\r\ngoto err;\r\n}\r\npdata->isel = TPS65217_BL_ISET1;\r\nif (!of_property_read_u32(node, "isel", &val)) {\r\nif (val < TPS65217_BL_ISET1 ||\r\nval > TPS65217_BL_ISET2) {\r\ndev_err(&pdev->dev,\r\n"invalid 'isel' value in the device tree\n");\r\nerr = ERR_PTR(-EINVAL);\r\ngoto err;\r\n}\r\npdata->isel = val;\r\n}\r\npdata->fdim = TPS65217_BL_FDIM_200HZ;\r\nif (!of_property_read_u32(node, "fdim", &val)) {\r\nswitch (val) {\r\ncase 100:\r\npdata->fdim = TPS65217_BL_FDIM_100HZ;\r\nbreak;\r\ncase 200:\r\npdata->fdim = TPS65217_BL_FDIM_200HZ;\r\nbreak;\r\ncase 500:\r\npdata->fdim = TPS65217_BL_FDIM_500HZ;\r\nbreak;\r\ncase 1000:\r\npdata->fdim = TPS65217_BL_FDIM_1000HZ;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev,\r\n"invalid 'fdim' value in the device tree\n");\r\nerr = ERR_PTR(-EINVAL);\r\ngoto err;\r\n}\r\n}\r\nif (!of_property_read_u32(node, "default-brightness", &val)) {\r\nif (val < 0 ||\r\nval > 100) {\r\ndev_err(&pdev->dev,\r\n"invalid 'default-brightness' value in the device tree\n");\r\nerr = ERR_PTR(-EINVAL);\r\ngoto err;\r\n}\r\npdata->dft_brightness = val;\r\n}\r\nof_node_put(node);\r\nreturn pdata;\r\nerr:\r\nof_node_put(node);\r\nreturn err;\r\n}\r\nstatic struct tps65217_bl_pdata *\r\ntps65217_bl_parse_dt(struct platform_device *pdev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int tps65217_bl_probe(struct platform_device *pdev)\r\n{\r\nint rc;\r\nstruct tps65217 *tps = dev_get_drvdata(pdev->dev.parent);\r\nstruct tps65217_bl *tps65217_bl;\r\nstruct tps65217_bl_pdata *pdata;\r\nstruct backlight_properties bl_props;\r\nif (tps->dev->of_node) {\r\npdata = tps65217_bl_parse_dt(pdev);\r\nif (IS_ERR(pdata))\r\nreturn PTR_ERR(pdata);\r\n} else {\r\npdata = dev_get_platdata(&pdev->dev);\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "no platform data provided\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\ntps65217_bl = devm_kzalloc(&pdev->dev, sizeof(*tps65217_bl),\r\nGFP_KERNEL);\r\nif (tps65217_bl == NULL)\r\nreturn -ENOMEM;\r\ntps65217_bl->tps = tps;\r\ntps65217_bl->dev = &pdev->dev;\r\ntps65217_bl->is_enabled = false;\r\nrc = tps65217_bl_hw_init(tps65217_bl, pdata);\r\nif (rc)\r\nreturn rc;\r\nmemset(&bl_props, 0, sizeof(struct backlight_properties));\r\nbl_props.type = BACKLIGHT_RAW;\r\nbl_props.max_brightness = 100;\r\ntps65217_bl->bl = devm_backlight_device_register(&pdev->dev, pdev->name,\r\ntps65217_bl->dev, tps65217_bl,\r\n&tps65217_bl_ops, &bl_props);\r\nif (IS_ERR(tps65217_bl->bl)) {\r\ndev_err(tps65217_bl->dev,\r\n"registration of backlight device failed: %d\n", rc);\r\nreturn PTR_ERR(tps65217_bl->bl);\r\n}\r\ntps65217_bl->bl->props.brightness = pdata->dft_brightness;\r\nbacklight_update_status(tps65217_bl->bl);\r\nplatform_set_drvdata(pdev, tps65217_bl);\r\nreturn 0;\r\n}

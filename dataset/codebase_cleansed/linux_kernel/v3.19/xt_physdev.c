static bool\r\nphysdev_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nstatic const char nulldevname[IFNAMSIZ] __attribute__((aligned(sizeof(long))));\r\nconst struct xt_physdev_info *info = par->matchinfo;\r\nunsigned long ret;\r\nconst char *indev, *outdev;\r\nconst struct nf_bridge_info *nf_bridge;\r\nif (!(nf_bridge = skb->nf_bridge)) {\r\nif ((info->bitmask & XT_PHYSDEV_OP_BRIDGED) &&\r\n!(info->invert & XT_PHYSDEV_OP_BRIDGED))\r\nreturn false;\r\nif ((info->bitmask & XT_PHYSDEV_OP_ISIN) &&\r\n!(info->invert & XT_PHYSDEV_OP_ISIN))\r\nreturn false;\r\nif ((info->bitmask & XT_PHYSDEV_OP_ISOUT) &&\r\n!(info->invert & XT_PHYSDEV_OP_ISOUT))\r\nreturn false;\r\nif ((info->bitmask & XT_PHYSDEV_OP_IN) &&\r\n!(info->invert & XT_PHYSDEV_OP_IN))\r\nreturn false;\r\nif ((info->bitmask & XT_PHYSDEV_OP_OUT) &&\r\n!(info->invert & XT_PHYSDEV_OP_OUT))\r\nreturn false;\r\nreturn true;\r\n}\r\nif ((info->bitmask & XT_PHYSDEV_OP_BRIDGED) &&\r\n(!!(nf_bridge->mask & BRNF_BRIDGED) ^\r\n!(info->invert & XT_PHYSDEV_OP_BRIDGED)))\r\nreturn false;\r\nif ((info->bitmask & XT_PHYSDEV_OP_ISIN &&\r\n(!nf_bridge->physindev ^ !!(info->invert & XT_PHYSDEV_OP_ISIN))) ||\r\n(info->bitmask & XT_PHYSDEV_OP_ISOUT &&\r\n(!nf_bridge->physoutdev ^ !!(info->invert & XT_PHYSDEV_OP_ISOUT))))\r\nreturn false;\r\nif (!(info->bitmask & XT_PHYSDEV_OP_IN))\r\ngoto match_outdev;\r\nindev = nf_bridge->physindev ? nf_bridge->physindev->name : nulldevname;\r\nret = ifname_compare_aligned(indev, info->physindev, info->in_mask);\r\nif (!ret ^ !(info->invert & XT_PHYSDEV_OP_IN))\r\nreturn false;\r\nmatch_outdev:\r\nif (!(info->bitmask & XT_PHYSDEV_OP_OUT))\r\nreturn true;\r\noutdev = nf_bridge->physoutdev ?\r\nnf_bridge->physoutdev->name : nulldevname;\r\nret = ifname_compare_aligned(outdev, info->physoutdev, info->out_mask);\r\nreturn (!!ret ^ !(info->invert & XT_PHYSDEV_OP_OUT));\r\n}\r\nstatic int physdev_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nconst struct xt_physdev_info *info = par->matchinfo;\r\nbr_netfilter_enable();\r\nif (!(info->bitmask & XT_PHYSDEV_OP_MASK) ||\r\ninfo->bitmask & ~XT_PHYSDEV_OP_MASK)\r\nreturn -EINVAL;\r\nif (info->bitmask & XT_PHYSDEV_OP_OUT &&\r\n(!(info->bitmask & XT_PHYSDEV_OP_BRIDGED) ||\r\ninfo->invert & XT_PHYSDEV_OP_BRIDGED) &&\r\npar->hook_mask & ((1 << NF_INET_LOCAL_OUT) |\r\n(1 << NF_INET_FORWARD) | (1 << NF_INET_POST_ROUTING))) {\r\npr_info("using --physdev-out in the OUTPUT, FORWARD and "\r\n"POSTROUTING chains for non-bridged traffic is not "\r\n"supported anymore.\n");\r\nif (par->hook_mask & (1 << NF_INET_LOCAL_OUT))\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init physdev_mt_init(void)\r\n{\r\nreturn xt_register_match(&physdev_mt_reg);\r\n}\r\nstatic void __exit physdev_mt_exit(void)\r\n{\r\nxt_unregister_match(&physdev_mt_reg);\r\n}

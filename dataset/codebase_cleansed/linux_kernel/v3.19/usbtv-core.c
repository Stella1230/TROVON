int usbtv_set_regs(struct usbtv *usbtv, const u16 regs[][2], int size)\r\n{\r\nint ret;\r\nint pipe = usb_rcvctrlpipe(usbtv->udev, 0);\r\nint i;\r\nfor (i = 0; i < size; i++) {\r\nu16 index = regs[i][0];\r\nu16 value = regs[i][1];\r\nret = usb_control_msg(usbtv->udev, pipe, USBTV_REQUEST_REG,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, index, NULL, 0, 0);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int usbtv_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nint ret;\r\nint size;\r\nstruct device *dev = &intf->dev;\r\nstruct usbtv *usbtv;\r\nif (intf->num_altsetting != 2)\r\nreturn -ENODEV;\r\nif (intf->altsetting[1].desc.bNumEndpoints != 4)\r\nreturn -ENODEV;\r\nsize = usb_endpoint_maxp(&intf->altsetting[1].endpoint[0].desc);\r\nsize = (size & 0x07ff) * (((size & 0x1800) >> 11) + 1);\r\nusbtv = kzalloc(sizeof(struct usbtv), GFP_KERNEL);\r\nif (usbtv == NULL)\r\nreturn -ENOMEM;\r\nusbtv->dev = dev;\r\nusbtv->udev = usb_get_dev(interface_to_usbdev(intf));\r\nusbtv->iso_size = size;\r\nusb_set_intfdata(intf, usbtv);\r\nret = usbtv_video_init(usbtv);\r\nif (ret < 0)\r\ngoto usbtv_video_fail;\r\nret = usbtv_audio_init(usbtv);\r\nif (ret < 0)\r\ngoto usbtv_audio_fail;\r\nv4l2_device_get(&usbtv->v4l2_dev);\r\ndev_info(dev, "Fushicai USBTV007 Audio-Video Grabber\n");\r\nreturn 0;\r\nusbtv_audio_fail:\r\nusbtv_video_free(usbtv);\r\nusbtv_video_fail:\r\nusb_set_intfdata(intf, NULL);\r\nusb_put_dev(usbtv->udev);\r\nkfree(usbtv);\r\nreturn ret;\r\n}\r\nstatic void usbtv_disconnect(struct usb_interface *intf)\r\n{\r\nstruct usbtv *usbtv = usb_get_intfdata(intf);\r\nusb_set_intfdata(intf, NULL);\r\nif (!usbtv)\r\nreturn;\r\nusbtv_audio_free(usbtv);\r\nusbtv_video_free(usbtv);\r\nusb_put_dev(usbtv->udev);\r\nusbtv->udev = NULL;\r\nv4l2_device_put(&usbtv->v4l2_dev);\r\n}

void __irq_entry deferred_pcr_work_irq(int irq, struct pt_regs *regs)\r\n{\r\nstruct pt_regs *old_regs;\r\nclear_softint(1 << PIL_DEFERRED_PCR_WORK);\r\nold_regs = set_irq_regs(regs);\r\nirq_enter();\r\n#ifdef CONFIG_IRQ_WORK\r\nirq_work_run();\r\n#endif\r\nirq_exit();\r\nset_irq_regs(old_regs);\r\n}\r\nvoid arch_irq_work_raise(void)\r\n{\r\nset_softint(1 << PIL_DEFERRED_PCR_WORK);\r\n}\r\nstatic u64 direct_pcr_read(unsigned long reg_num)\r\n{\r\nu64 val;\r\nWARN_ON_ONCE(reg_num != 0);\r\n__asm__ __volatile__("rd %%pcr, %0" : "=r" (val));\r\nreturn val;\r\n}\r\nstatic void direct_pcr_write(unsigned long reg_num, u64 val)\r\n{\r\nWARN_ON_ONCE(reg_num != 0);\r\n__asm__ __volatile__("wr %0, 0x0, %%pcr" : : "r" (val));\r\n}\r\nstatic u64 direct_pic_read(unsigned long reg_num)\r\n{\r\nu64 val;\r\nWARN_ON_ONCE(reg_num != 0);\r\n__asm__ __volatile__("rd %%pic, %0" : "=r" (val));\r\nreturn val;\r\n}\r\nstatic void direct_pic_write(unsigned long reg_num, u64 val)\r\n{\r\nWARN_ON_ONCE(reg_num != 0);\r\n__asm__ __volatile__("ba,pt %%xcc, 99f\n\t"\r\n" nop\n\t"\r\n".align 64\n"\r\n"99:wr %0, 0x0, %%pic\n\t"\r\n"rd %%pic, %%g0" : : "r" (val));\r\n}\r\nstatic u64 direct_picl_value(unsigned int nmi_hz)\r\n{\r\nu32 delta = local_cpu_data().clock_tick / nmi_hz;\r\nreturn ((u64)((0 - delta) & 0xffffffff)) << 32;\r\n}\r\nstatic void n2_pcr_write(unsigned long reg_num, u64 val)\r\n{\r\nunsigned long ret;\r\nWARN_ON_ONCE(reg_num != 0);\r\nif (val & PCR_N2_HTRACE) {\r\nret = sun4v_niagara2_setperf(HV_N2_PERF_SPARC_CTL, val);\r\nif (ret != HV_EOK)\r\ndirect_pcr_write(reg_num, val);\r\n} else\r\ndirect_pcr_write(reg_num, val);\r\n}\r\nstatic u64 n2_picl_value(unsigned int nmi_hz)\r\n{\r\nu32 delta = local_cpu_data().clock_tick / (nmi_hz << 2);\r\nreturn ((u64)((0 - delta) & 0xffffffff)) << 32;\r\n}\r\nstatic u64 n4_pcr_read(unsigned long reg_num)\r\n{\r\nunsigned long val;\r\n(void) sun4v_vt_get_perfreg(reg_num, &val);\r\nreturn val;\r\n}\r\nstatic void n4_pcr_write(unsigned long reg_num, u64 val)\r\n{\r\n(void) sun4v_vt_set_perfreg(reg_num, val);\r\n}\r\nstatic u64 n4_pic_read(unsigned long reg_num)\r\n{\r\nunsigned long val;\r\n__asm__ __volatile__("ldxa [%1] %2, %0"\r\n: "=r" (val)\r\n: "r" (reg_num * 0x8UL), "i" (ASI_PIC));\r\nreturn val;\r\n}\r\nstatic void n4_pic_write(unsigned long reg_num, u64 val)\r\n{\r\n__asm__ __volatile__("stxa %0, [%1] %2"\r\n:\r\n: "r" (val), "r" (reg_num * 0x8UL), "i" (ASI_PIC));\r\n}\r\nstatic u64 n4_picl_value(unsigned int nmi_hz)\r\n{\r\nu32 delta = local_cpu_data().clock_tick / (nmi_hz << 2);\r\nreturn ((u64)((0 - delta) & 0xffffffff));\r\n}\r\nstatic u64 n5_pcr_read(unsigned long reg_num)\r\n{\r\nunsigned long val;\r\n(void) sun4v_t5_get_perfreg(reg_num, &val);\r\nreturn val;\r\n}\r\nstatic void n5_pcr_write(unsigned long reg_num, u64 val)\r\n{\r\n(void) sun4v_t5_set_perfreg(reg_num, val);\r\n}\r\nstatic int __init register_perf_hsvc(void)\r\n{\r\nunsigned long hverror;\r\nif (tlb_type == hypervisor) {\r\nswitch (sun4v_chip_type) {\r\ncase SUN4V_CHIP_NIAGARA1:\r\nperf_hsvc_group = HV_GRP_NIAG_PERF;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA2:\r\nperf_hsvc_group = HV_GRP_N2_CPU;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA3:\r\nperf_hsvc_group = HV_GRP_KT_CPU;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA4:\r\nperf_hsvc_group = HV_GRP_VT_CPU;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA5:\r\nperf_hsvc_group = HV_GRP_T5_CPU;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nperf_hsvc_major = 1;\r\nperf_hsvc_minor = 0;\r\nhverror = sun4v_hvapi_register(perf_hsvc_group,\r\nperf_hsvc_major,\r\n&perf_hsvc_minor);\r\nif (hverror) {\r\npr_err("perfmon: Could not register hvapi(0x%lx).\n",\r\nhverror);\r\nreturn -ENODEV;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init unregister_perf_hsvc(void)\r\n{\r\nif (tlb_type != hypervisor)\r\nreturn;\r\nsun4v_hvapi_unregister(perf_hsvc_group);\r\n}\r\nstatic int __init setup_sun4v_pcr_ops(void)\r\n{\r\nint ret = 0;\r\nswitch (sun4v_chip_type) {\r\ncase SUN4V_CHIP_NIAGARA1:\r\ncase SUN4V_CHIP_NIAGARA2:\r\ncase SUN4V_CHIP_NIAGARA3:\r\npcr_ops = &n2_pcr_ops;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA4:\r\npcr_ops = &n4_pcr_ops;\r\nbreak;\r\ncase SUN4V_CHIP_NIAGARA5:\r\npcr_ops = &n5_pcr_ops;\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nint __init pcr_arch_init(void)\r\n{\r\nint err = register_perf_hsvc();\r\nif (err)\r\nreturn err;\r\nswitch (tlb_type) {\r\ncase hypervisor:\r\nerr = setup_sun4v_pcr_ops();\r\nif (err)\r\ngoto out_unregister;\r\nbreak;\r\ncase cheetah:\r\ncase cheetah_plus:\r\npcr_ops = &direct_pcr_ops;\r\nbreak;\r\ncase spitfire:\r\ndefault:\r\nerr = -ENODEV;\r\ngoto out_unregister;\r\n}\r\nreturn nmi_init();\r\nout_unregister:\r\nunregister_perf_hsvc();\r\nreturn err;\r\n}

static int ehci_xilinx_port_handed_over(struct usb_hcd *hcd, int portnum)\r\n{\r\ndev_warn(hcd->self.controller, "port %d cannot be enabled\n", portnum);\r\nif (hcd->has_tt) {\r\ndev_warn(hcd->self.controller,\r\n"Maybe you have connected a low speed device?\n");\r\ndev_warn(hcd->self.controller,\r\n"We do not support low speed devices\n");\r\n} else {\r\ndev_warn(hcd->self.controller,\r\n"Maybe your device is not a high speed device?\n");\r\ndev_warn(hcd->self.controller,\r\n"The USB host controller does not support full speed "\r\n"nor low speed devices\n");\r\ndev_warn(hcd->self.controller,\r\n"You can reconfigure the host controller to have "\r\n"full speed support\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int ehci_hcd_xilinx_of_probe(struct platform_device *op)\r\n{\r\nstruct device_node *dn = op->dev.of_node;\r\nstruct usb_hcd *hcd;\r\nstruct ehci_hcd *ehci;\r\nstruct resource res;\r\nint irq;\r\nint rv;\r\nint *value;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\ndev_dbg(&op->dev, "initializing XILINX-OF USB Controller\n");\r\nrv = of_address_to_resource(dn, 0, &res);\r\nif (rv)\r\nreturn rv;\r\nhcd = usb_create_hcd(&ehci_xilinx_of_hc_driver, &op->dev,\r\n"XILINX-OF USB");\r\nif (!hcd)\r\nreturn -ENOMEM;\r\nhcd->rsrc_start = res.start;\r\nhcd->rsrc_len = resource_size(&res);\r\nirq = irq_of_parse_and_map(dn, 0);\r\nif (!irq) {\r\ndev_err(&op->dev, "%s: irq_of_parse_and_map failed\n",\r\n__FILE__);\r\nrv = -EBUSY;\r\ngoto err_irq;\r\n}\r\nhcd->regs = devm_ioremap_resource(&op->dev, &res);\r\nif (IS_ERR(hcd->regs)) {\r\nrv = PTR_ERR(hcd->regs);\r\ngoto err_irq;\r\n}\r\nehci = hcd_to_ehci(hcd);\r\nehci->big_endian_mmio = 1;\r\nehci->big_endian_desc = 1;\r\nvalue = (int *)of_get_property(dn, "xlnx,support-usb-fs", NULL);\r\nif (value && (*value == 1)) {\r\nehci_dbg(ehci, "USB host controller supports FS devices\n");\r\nhcd->has_tt = 1;\r\n} else {\r\nehci_dbg(ehci,\r\n"USB host controller is HS only\n");\r\nhcd->has_tt = 0;\r\n}\r\nehci->caps = hcd->regs + 0x100;\r\nrv = usb_add_hcd(hcd, irq, 0);\r\nif (rv == 0) {\r\ndevice_wakeup_enable(hcd->self.controller);\r\nreturn 0;\r\n}\r\nerr_irq:\r\nusb_put_hcd(hcd);\r\nreturn rv;\r\n}\r\nstatic int ehci_hcd_xilinx_of_remove(struct platform_device *op)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(op);\r\ndev_dbg(&op->dev, "stopping XILINX-OF USB Controller\n");\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}

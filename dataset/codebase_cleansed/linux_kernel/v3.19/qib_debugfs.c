static void *_opcode_stats_seq_start(struct seq_file *s, loff_t *pos)\r\n{\r\nstruct qib_opcode_stats_perctx *opstats;\r\nif (*pos >= ARRAY_SIZE(opstats->stats))\r\nreturn NULL;\r\nreturn pos;\r\n}\r\nstatic void *_opcode_stats_seq_next(struct seq_file *s, void *v, loff_t *pos)\r\n{\r\nstruct qib_opcode_stats_perctx *opstats;\r\n++*pos;\r\nif (*pos >= ARRAY_SIZE(opstats->stats))\r\nreturn NULL;\r\nreturn pos;\r\n}\r\nstatic void _opcode_stats_seq_stop(struct seq_file *s, void *v)\r\n{\r\n}\r\nstatic int _opcode_stats_seq_show(struct seq_file *s, void *v)\r\n{\r\nloff_t *spos = v;\r\nloff_t i = *spos, j;\r\nu64 n_packets = 0, n_bytes = 0;\r\nstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\r\nstruct qib_devdata *dd = dd_from_dev(ibd);\r\nfor (j = 0; j < dd->first_user_ctxt; j++) {\r\nif (!dd->rcd[j])\r\ncontinue;\r\nn_packets += dd->rcd[j]->opstats->stats[i].n_packets;\r\nn_bytes += dd->rcd[j]->opstats->stats[i].n_bytes;\r\n}\r\nif (!n_packets && !n_bytes)\r\nreturn SEQ_SKIP;\r\nseq_printf(s, "%02llx %llu/%llu\n", i,\r\n(unsigned long long) n_packets,\r\n(unsigned long long) n_bytes);\r\nreturn 0;\r\n}\r\nstatic void *_ctx_stats_seq_start(struct seq_file *s, loff_t *pos)\r\n{\r\nstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\r\nstruct qib_devdata *dd = dd_from_dev(ibd);\r\nif (!*pos)\r\nreturn SEQ_START_TOKEN;\r\nif (*pos >= dd->first_user_ctxt)\r\nreturn NULL;\r\nreturn pos;\r\n}\r\nstatic void *_ctx_stats_seq_next(struct seq_file *s, void *v, loff_t *pos)\r\n{\r\nstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\r\nstruct qib_devdata *dd = dd_from_dev(ibd);\r\nif (v == SEQ_START_TOKEN)\r\nreturn pos;\r\n++*pos;\r\nif (*pos >= dd->first_user_ctxt)\r\nreturn NULL;\r\nreturn pos;\r\n}\r\nstatic void _ctx_stats_seq_stop(struct seq_file *s, void *v)\r\n{\r\n}\r\nstatic int _ctx_stats_seq_show(struct seq_file *s, void *v)\r\n{\r\nloff_t *spos;\r\nloff_t i, j;\r\nu64 n_packets = 0;\r\nstruct qib_ibdev *ibd = (struct qib_ibdev *)s->private;\r\nstruct qib_devdata *dd = dd_from_dev(ibd);\r\nif (v == SEQ_START_TOKEN) {\r\nseq_puts(s, "Ctx:npkts\n");\r\nreturn 0;\r\n}\r\nspos = v;\r\ni = *spos;\r\nif (!dd->rcd[i])\r\nreturn SEQ_SKIP;\r\nfor (j = 0; j < ARRAY_SIZE(dd->rcd[i]->opstats->stats); j++)\r\nn_packets += dd->rcd[i]->opstats->stats[j].n_packets;\r\nif (!n_packets)\r\nreturn SEQ_SKIP;\r\nseq_printf(s, " %llu:%llu\n", i, n_packets);\r\nreturn 0;\r\n}\r\nstatic void *_qp_stats_seq_start(struct seq_file *s, loff_t *pos)\r\n{\r\nstruct qib_qp_iter *iter;\r\nloff_t n = *pos;\r\nrcu_read_lock();\r\niter = qib_qp_iter_init(s->private);\r\nif (!iter)\r\nreturn NULL;\r\nwhile (n--) {\r\nif (qib_qp_iter_next(iter)) {\r\nkfree(iter);\r\nreturn NULL;\r\n}\r\n}\r\nreturn iter;\r\n}\r\nstatic void *_qp_stats_seq_next(struct seq_file *s, void *iter_ptr,\r\nloff_t *pos)\r\n{\r\nstruct qib_qp_iter *iter = iter_ptr;\r\n(*pos)++;\r\nif (qib_qp_iter_next(iter)) {\r\nkfree(iter);\r\nreturn NULL;\r\n}\r\nreturn iter;\r\n}\r\nstatic void _qp_stats_seq_stop(struct seq_file *s, void *iter_ptr)\r\n{\r\nrcu_read_unlock();\r\n}\r\nstatic int _qp_stats_seq_show(struct seq_file *s, void *iter_ptr)\r\n{\r\nstruct qib_qp_iter *iter = iter_ptr;\r\nif (!iter)\r\nreturn 0;\r\nqib_qp_iter_print(s, iter);\r\nreturn 0;\r\n}\r\nvoid qib_dbg_ibdev_init(struct qib_ibdev *ibd)\r\n{\r\nchar name[10];\r\nsnprintf(name, sizeof(name), "qib%d", dd_from_dev(ibd)->unit);\r\nibd->qib_ibdev_dbg = debugfs_create_dir(name, qib_dbg_root);\r\nif (!ibd->qib_ibdev_dbg) {\r\npr_warn("create of %s failed\n", name);\r\nreturn;\r\n}\r\nDEBUGFS_FILE_CREATE(opcode_stats);\r\nDEBUGFS_FILE_CREATE(ctx_stats);\r\nDEBUGFS_FILE_CREATE(qp_stats);\r\nreturn;\r\n}\r\nvoid qib_dbg_ibdev_exit(struct qib_ibdev *ibd)\r\n{\r\nif (!qib_dbg_root)\r\ngoto out;\r\ndebugfs_remove_recursive(ibd->qib_ibdev_dbg);\r\nout:\r\nibd->qib_ibdev_dbg = NULL;\r\n}\r\nvoid qib_dbg_init(void)\r\n{\r\nqib_dbg_root = debugfs_create_dir(QIB_DRV_NAME, NULL);\r\nif (!qib_dbg_root)\r\npr_warn("init of debugfs failed\n");\r\n}\r\nvoid qib_dbg_exit(void)\r\n{\r\ndebugfs_remove_recursive(qib_dbg_root);\r\nqib_dbg_root = NULL;\r\n}

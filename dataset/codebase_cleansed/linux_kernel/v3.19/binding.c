static int iwl_mvm_binding_cmd(struct iwl_mvm *mvm, u32 action,\r\nstruct iwl_mvm_iface_iterator_data *data)\r\n{\r\nstruct iwl_binding_cmd cmd;\r\nstruct iwl_mvm_phy_ctxt *phyctxt = data->phyctxt;\r\nint i, ret;\r\nu32 status;\r\nmemset(&cmd, 0, sizeof(cmd));\r\ncmd.id_and_color = cpu_to_le32(FW_CMD_ID_AND_COLOR(phyctxt->id,\r\nphyctxt->color));\r\ncmd.action = cpu_to_le32(action);\r\ncmd.phy = cpu_to_le32(FW_CMD_ID_AND_COLOR(phyctxt->id,\r\nphyctxt->color));\r\nfor (i = 0; i < MAX_MACS_IN_BINDING; i++)\r\ncmd.macs[i] = cpu_to_le32(FW_CTXT_INVALID);\r\nfor (i = 0; i < data->idx; i++)\r\ncmd.macs[i] = cpu_to_le32(FW_CMD_ID_AND_COLOR(data->ids[i],\r\ndata->colors[i]));\r\nstatus = 0;\r\nret = iwl_mvm_send_cmd_pdu_status(mvm, BINDING_CONTEXT_CMD,\r\nsizeof(cmd), &cmd, &status);\r\nif (ret) {\r\nIWL_ERR(mvm, "Failed to send binding (action:%d): %d\n",\r\naction, ret);\r\nreturn ret;\r\n}\r\nif (status) {\r\nIWL_ERR(mvm, "Binding command failed: %u\n", status);\r\nret = -EIO;\r\n}\r\nreturn ret;\r\n}\r\nstatic void iwl_mvm_iface_iterator(void *_data, u8 *mac,\r\nstruct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_iface_iterator_data *data = _data;\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nif (vif == data->ignore_vif)\r\nreturn;\r\nif (mvmvif->phy_ctxt != data->phyctxt)\r\nreturn;\r\nif (WARN_ON_ONCE(data->idx >= MAX_MACS_IN_BINDING))\r\nreturn;\r\ndata->ids[data->idx] = mvmvif->id;\r\ndata->colors[data->idx] = mvmvif->color;\r\ndata->idx++;\r\n}\r\nstatic int iwl_mvm_binding_update(struct iwl_mvm *mvm,\r\nstruct ieee80211_vif *vif,\r\nstruct iwl_mvm_phy_ctxt *phyctxt,\r\nbool add)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nstruct iwl_mvm_iface_iterator_data data = {\r\n.ignore_vif = vif,\r\n.phyctxt = phyctxt,\r\n};\r\nu32 action = FW_CTXT_ACTION_MODIFY;\r\nlockdep_assert_held(&mvm->mutex);\r\nieee80211_iterate_active_interfaces_atomic(mvm->hw,\r\nIEEE80211_IFACE_ITER_NORMAL,\r\niwl_mvm_iface_iterator,\r\n&data);\r\nif (data.idx == 0) {\r\nif (add)\r\naction = FW_CTXT_ACTION_ADD;\r\nelse\r\naction = FW_CTXT_ACTION_REMOVE;\r\n}\r\nif (add) {\r\nif (WARN_ON_ONCE(data.idx >= MAX_MACS_IN_BINDING))\r\nreturn -EINVAL;\r\ndata.ids[data.idx] = mvmvif->id;\r\ndata.colors[data.idx] = mvmvif->color;\r\ndata.idx++;\r\n}\r\nreturn iwl_mvm_binding_cmd(mvm, action, &data);\r\n}\r\nint iwl_mvm_binding_add_vif(struct iwl_mvm *mvm, struct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nif (WARN_ON_ONCE(!mvmvif->phy_ctxt))\r\nreturn -EINVAL;\r\nif (iwl_mvm_sf_update(mvm, vif, false))\r\nreturn -EINVAL;\r\nreturn iwl_mvm_binding_update(mvm, vif, mvmvif->phy_ctxt, true);\r\n}\r\nint iwl_mvm_binding_remove_vif(struct iwl_mvm *mvm, struct ieee80211_vif *vif)\r\n{\r\nstruct iwl_mvm_vif *mvmvif = iwl_mvm_vif_from_mac80211(vif);\r\nint ret;\r\nif (WARN_ON_ONCE(!mvmvif->phy_ctxt))\r\nreturn -EINVAL;\r\nret = iwl_mvm_binding_update(mvm, vif, mvmvif->phy_ctxt, false);\r\nif (!ret)\r\nif (iwl_mvm_sf_update(mvm, vif, true))\r\nIWL_ERR(mvm, "Failed to update SF state\n");\r\nreturn ret;\r\n}

static int loongson_cu2_call(struct notifier_block *nfb, unsigned long action,\r\nvoid *data)\r\n{\r\nint fpu_owned;\r\nint fr = !test_thread_flag(TIF_32BIT_FPREGS);\r\nswitch (action) {\r\ncase CU2_EXCEPTION:\r\npreempt_disable();\r\nfpu_owned = __is_fpu_owner();\r\nif (!fr)\r\nset_c0_status(ST0_CU1 | ST0_CU2);\r\nelse\r\nset_c0_status(ST0_CU1 | ST0_CU2 | ST0_FR);\r\nenable_fpu_hazard();\r\nKSTK_STATUS(current) |= (ST0_CU1 | ST0_CU2);\r\nif (fr)\r\nKSTK_STATUS(current) |= ST0_FR;\r\nelse\r\nKSTK_STATUS(current) &= ~ST0_FR;\r\nif (!fpu_owned) {\r\nset_thread_flag(TIF_USEDFPU);\r\nif (!used_math()) {\r\n_init_fpu();\r\nset_used_math();\r\n} else\r\n_restore_fp(current);\r\n}\r\npreempt_enable();\r\nreturn NOTIFY_STOP;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __init loongson_cu2_setup(void)\r\n{\r\nreturn cu2_notifier(loongson_cu2_call, 0);\r\n}

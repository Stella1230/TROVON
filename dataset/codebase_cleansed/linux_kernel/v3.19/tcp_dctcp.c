static void dctcp_reset(const struct tcp_sock *tp, struct dctcp *ca)\r\n{\r\nca->next_seq = tp->snd_nxt;\r\nca->acked_bytes_ecn = 0;\r\nca->acked_bytes_total = 0;\r\n}\r\nstatic void dctcp_init(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nif ((tp->ecn_flags & TCP_ECN_OK) ||\r\n(sk->sk_state == TCP_LISTEN ||\r\nsk->sk_state == TCP_CLOSE)) {\r\nstruct dctcp *ca = inet_csk_ca(sk);\r\nca->prior_snd_una = tp->snd_una;\r\nca->prior_rcv_nxt = tp->rcv_nxt;\r\nca->dctcp_alpha = min(dctcp_alpha_on_init, DCTCP_MAX_ALPHA);\r\nca->delayed_ack_reserved = 0;\r\nca->ce_state = 0;\r\ndctcp_reset(tp, ca);\r\nreturn;\r\n}\r\ninet_csk(sk)->icsk_ca_ops = &dctcp_reno;\r\nINET_ECN_dontxmit(sk);\r\n}\r\nstatic u32 dctcp_ssthresh(struct sock *sk)\r\n{\r\nconst struct dctcp *ca = inet_csk_ca(sk);\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nreturn max(tp->snd_cwnd - ((tp->snd_cwnd * ca->dctcp_alpha) >> 11U), 2U);\r\n}\r\nstatic void dctcp_ce_state_0_to_1(struct sock *sk)\r\n{\r\nstruct dctcp *ca = inet_csk_ca(sk);\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nif (!ca->ce_state && ca->delayed_ack_reserved) {\r\nu32 tmp_rcv_nxt;\r\ntmp_rcv_nxt = tp->rcv_nxt;\r\ntp->ecn_flags &= ~TCP_ECN_DEMAND_CWR;\r\ntp->rcv_nxt = ca->prior_rcv_nxt;\r\ntcp_send_ack(sk);\r\ntp->rcv_nxt = tmp_rcv_nxt;\r\n}\r\nca->prior_rcv_nxt = tp->rcv_nxt;\r\nca->ce_state = 1;\r\ntp->ecn_flags |= TCP_ECN_DEMAND_CWR;\r\n}\r\nstatic void dctcp_ce_state_1_to_0(struct sock *sk)\r\n{\r\nstruct dctcp *ca = inet_csk_ca(sk);\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nif (ca->ce_state && ca->delayed_ack_reserved) {\r\nu32 tmp_rcv_nxt;\r\ntmp_rcv_nxt = tp->rcv_nxt;\r\ntp->ecn_flags |= TCP_ECN_DEMAND_CWR;\r\ntp->rcv_nxt = ca->prior_rcv_nxt;\r\ntcp_send_ack(sk);\r\ntp->rcv_nxt = tmp_rcv_nxt;\r\n}\r\nca->prior_rcv_nxt = tp->rcv_nxt;\r\nca->ce_state = 0;\r\ntp->ecn_flags &= ~TCP_ECN_DEMAND_CWR;\r\n}\r\nstatic void dctcp_update_alpha(struct sock *sk, u32 flags)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct dctcp *ca = inet_csk_ca(sk);\r\nu32 acked_bytes = tp->snd_una - ca->prior_snd_una;\r\nif (acked_bytes == 0 && !(flags & CA_ACK_WIN_UPDATE))\r\nacked_bytes = inet_csk(sk)->icsk_ack.rcv_mss;\r\nif (acked_bytes) {\r\nca->acked_bytes_total += acked_bytes;\r\nca->prior_snd_una = tp->snd_una;\r\nif (flags & CA_ACK_ECE)\r\nca->acked_bytes_ecn += acked_bytes;\r\n}\r\nif (!before(tp->snd_una, ca->next_seq)) {\r\nif (ca->acked_bytes_total == 0)\r\nca->acked_bytes_total = 1;\r\nca->dctcp_alpha = ca->dctcp_alpha -\r\n(ca->dctcp_alpha >> dctcp_shift_g) +\r\n(ca->acked_bytes_ecn << (10U - dctcp_shift_g)) /\r\nca->acked_bytes_total;\r\nif (ca->dctcp_alpha > DCTCP_MAX_ALPHA)\r\nca->dctcp_alpha = DCTCP_MAX_ALPHA;\r\ndctcp_reset(tp, ca);\r\n}\r\n}\r\nstatic void dctcp_state(struct sock *sk, u8 new_state)\r\n{\r\nif (dctcp_clamp_alpha_on_loss && new_state == TCP_CA_Loss) {\r\nstruct dctcp *ca = inet_csk_ca(sk);\r\nca->dctcp_alpha = DCTCP_MAX_ALPHA;\r\n}\r\n}\r\nstatic void dctcp_update_ack_reserved(struct sock *sk, enum tcp_ca_event ev)\r\n{\r\nstruct dctcp *ca = inet_csk_ca(sk);\r\nswitch (ev) {\r\ncase CA_EVENT_DELAYED_ACK:\r\nif (!ca->delayed_ack_reserved)\r\nca->delayed_ack_reserved = 1;\r\nbreak;\r\ncase CA_EVENT_NON_DELAYED_ACK:\r\nif (ca->delayed_ack_reserved)\r\nca->delayed_ack_reserved = 0;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void dctcp_cwnd_event(struct sock *sk, enum tcp_ca_event ev)\r\n{\r\nswitch (ev) {\r\ncase CA_EVENT_ECN_IS_CE:\r\ndctcp_ce_state_0_to_1(sk);\r\nbreak;\r\ncase CA_EVENT_ECN_NO_CE:\r\ndctcp_ce_state_1_to_0(sk);\r\nbreak;\r\ncase CA_EVENT_DELAYED_ACK:\r\ncase CA_EVENT_NON_DELAYED_ACK:\r\ndctcp_update_ack_reserved(sk, ev);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void dctcp_get_info(struct sock *sk, u32 ext, struct sk_buff *skb)\r\n{\r\nconst struct dctcp *ca = inet_csk_ca(sk);\r\nif (ext & (1 << (INET_DIAG_DCTCPINFO - 1)) ||\r\next & (1 << (INET_DIAG_VEGASINFO - 1))) {\r\nstruct tcp_dctcp_info info;\r\nmemset(&info, 0, sizeof(info));\r\nif (inet_csk(sk)->icsk_ca_ops != &dctcp_reno) {\r\ninfo.dctcp_enabled = 1;\r\ninfo.dctcp_ce_state = (u16) ca->ce_state;\r\ninfo.dctcp_alpha = ca->dctcp_alpha;\r\ninfo.dctcp_ab_ecn = ca->acked_bytes_ecn;\r\ninfo.dctcp_ab_tot = ca->acked_bytes_total;\r\n}\r\nnla_put(skb, INET_DIAG_DCTCPINFO, sizeof(info), &info);\r\n}\r\n}\r\nstatic int __init dctcp_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct dctcp) > ICSK_CA_PRIV_SIZE);\r\nreturn tcp_register_congestion_control(&dctcp);\r\n}\r\nstatic void __exit dctcp_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&dctcp);\r\n}

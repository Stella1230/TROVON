static void piix_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nint is_slave = drive->dn & 1;\r\nint master_port = hwif->channel ? 0x42 : 0x40;\r\nint slave_port = 0x44;\r\nunsigned long flags;\r\nu16 master_data;\r\nu8 slave_data;\r\nstatic DEFINE_SPINLOCK(tune_lock);\r\nint control = 0;\r\nconst u8 pio = drive->pio_mode - XFER_PIO_0;\r\nstatic const u8 timings[][2]= {\r\n{ 0, 0 },\r\n{ 0, 0 },\r\n{ 1, 0 },\r\n{ 2, 1 },\r\n{ 2, 3 }, };\r\nspin_lock_irqsave(&tune_lock, flags);\r\npci_read_config_word(dev, master_port, &master_data);\r\nif (pio > 1)\r\ncontrol |= 1;\r\nif (drive->media == ide_disk)\r\ncontrol |= 4;\r\nif (ide_pio_need_iordy(drive, pio))\r\ncontrol |= 2;\r\nif (is_slave) {\r\nmaster_data |= 0x4000;\r\nmaster_data &= ~0x0070;\r\nif (pio > 1) {\r\nmaster_data |= control << 4;\r\n}\r\npci_read_config_byte(dev, slave_port, &slave_data);\r\nslave_data &= hwif->channel ? 0x0f : 0xf0;\r\nslave_data |= ((timings[pio][0] << 2) | timings[pio][1]) <<\r\n(hwif->channel ? 4 : 0);\r\n} else {\r\nmaster_data &= ~0x3307;\r\nif (pio > 1) {\r\nmaster_data |= control;\r\n}\r\nmaster_data |= (timings[pio][0] << 12) | (timings[pio][1] << 8);\r\n}\r\npci_write_config_word(dev, master_port, master_data);\r\nif (is_slave)\r\npci_write_config_byte(dev, slave_port, slave_data);\r\nspin_unlock_irqrestore(&tune_lock, flags);\r\n}\r\nstatic void piix_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu8 maslave = hwif->channel ? 0x42 : 0x40;\r\nint a_speed = 3 << (drive->dn * 4);\r\nint u_flag = 1 << drive->dn;\r\nint v_flag = 0x01 << drive->dn;\r\nint w_flag = 0x10 << drive->dn;\r\nint u_speed = 0;\r\nint sitre;\r\nu16 reg4042, reg4a;\r\nu8 reg48, reg54, reg55;\r\nconst u8 speed = drive->dma_mode;\r\npci_read_config_word(dev, maslave, &reg4042);\r\nsitre = (reg4042 & 0x4000) ? 1 : 0;\r\npci_read_config_byte(dev, 0x48, &reg48);\r\npci_read_config_word(dev, 0x4a, &reg4a);\r\npci_read_config_byte(dev, 0x54, &reg54);\r\npci_read_config_byte(dev, 0x55, &reg55);\r\nif (speed >= XFER_UDMA_0) {\r\nu8 udma = speed - XFER_UDMA_0;\r\nu_speed = min_t(u8, 2 - (udma & 1), udma) << (drive->dn * 4);\r\nif (!(reg48 & u_flag))\r\npci_write_config_byte(dev, 0x48, reg48 | u_flag);\r\nif (speed == XFER_UDMA_5) {\r\npci_write_config_byte(dev, 0x55, (u8) reg55|w_flag);\r\n} else {\r\npci_write_config_byte(dev, 0x55, (u8) reg55 & ~w_flag);\r\n}\r\nif ((reg4a & a_speed) != u_speed)\r\npci_write_config_word(dev, 0x4a, (reg4a & ~a_speed) | u_speed);\r\nif (speed > XFER_UDMA_2) {\r\nif (!(reg54 & v_flag))\r\npci_write_config_byte(dev, 0x54, reg54 | v_flag);\r\n} else\r\npci_write_config_byte(dev, 0x54, reg54 & ~v_flag);\r\n} else {\r\nconst u8 mwdma_to_pio[] = { 0, 3, 4 };\r\nif (reg48 & u_flag)\r\npci_write_config_byte(dev, 0x48, reg48 & ~u_flag);\r\nif (reg4a & a_speed)\r\npci_write_config_word(dev, 0x4a, reg4a & ~a_speed);\r\nif (reg54 & v_flag)\r\npci_write_config_byte(dev, 0x54, reg54 & ~v_flag);\r\nif (reg55 & w_flag)\r\npci_write_config_byte(dev, 0x55, (u8) reg55 & ~w_flag);\r\nif (speed >= XFER_MW_DMA_0)\r\ndrive->pio_mode =\r\nmwdma_to_pio[speed - XFER_MW_DMA_0] + XFER_PIO_0;\r\nelse\r\ndrive->pio_mode = XFER_PIO_2;\r\npiix_set_pio_mode(hwif, drive);\r\n}\r\n}\r\nstatic int init_chipset_ich(struct pci_dev *dev)\r\n{\r\nu32 extra = 0;\r\npci_read_config_dword(dev, 0x54, &extra);\r\npci_write_config_dword(dev, 0x54, extra | 0x400);\r\nreturn 0;\r\n}\r\nstatic void ich_clear_irq(ide_drive_t *drive)\r\n{\r\nide_hwif_t *hwif = drive->hwif;\r\nu8 dma_stat;\r\nif (drive->waiting_for_dma || hwif->dma_base == 0)\r\nreturn;\r\ndma_stat = inb(hwif->dma_base + ATA_DMA_STATUS);\r\noutb(dma_stat, hwif->dma_base + ATA_DMA_STATUS);\r\n}\r\nstatic u8 piix_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(hwif->dev);\r\nconst struct ich_laptop *lap = &ich_laptop[0];\r\nu8 reg54h = 0, mask = hwif->channel ? 0xc0 : 0x30;\r\nwhile (lap->device) {\r\nif (lap->device == pdev->device &&\r\nlap->subvendor == pdev->subsystem_vendor &&\r\nlap->subdevice == pdev->subsystem_device) {\r\nreturn ATA_CBL_PATA40_SHORT;\r\n}\r\nlap++;\r\n}\r\npci_read_config_byte(pdev, 0x54, &reg54h);\r\nreturn (reg54h & mask) ? ATA_CBL_PATA80 : ATA_CBL_PATA40;\r\n}\r\nstatic void init_hwif_piix(ide_hwif_t *hwif)\r\n{\r\nif (!hwif->dma_base)\r\nreturn;\r\nif (no_piix_dma)\r\nhwif->ultra_mask = hwif->mwdma_mask = hwif->swdma_mask = 0;\r\n}\r\nstatic int piix_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nreturn ide_pci_init_one(dev, &piix_pci_info[id->driver_data], NULL);\r\n}\r\nstatic void piix_check_450nx(void)\r\n{\r\nstruct pci_dev *pdev = NULL;\r\nu16 cfg;\r\nwhile((pdev=pci_get_device(PCI_VENDOR_ID_INTEL, PCI_DEVICE_ID_INTEL_82454NX, pdev))!=NULL)\r\n{\r\npci_read_config_word(pdev, 0x41, &cfg);\r\nif (pdev->revision == 0x00)\r\nno_piix_dma = 1;\r\nelse if (cfg & (1<<14) && pdev->revision < 5)\r\nno_piix_dma = 2;\r\n}\r\nif(no_piix_dma)\r\nprintk(KERN_WARNING DRV_NAME ": 450NX errata present, disabling IDE DMA.\n");\r\nif(no_piix_dma == 2)\r\nprintk(KERN_WARNING DRV_NAME ": A BIOS update may resolve this.\n");\r\n}\r\nstatic int __init piix_ide_init(void)\r\n{\r\npiix_check_450nx();\r\nreturn ide_pci_register_driver(&piix_pci_driver);\r\n}\r\nstatic void __exit piix_ide_exit(void)\r\n{\r\npci_unregister_driver(&piix_pci_driver);\r\n}

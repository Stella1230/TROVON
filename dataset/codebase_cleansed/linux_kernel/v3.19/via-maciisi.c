static int\r\nmaciisi_probe(void)\r\n{\r\nif (macintosh_config->adb_type != MAC_ADB_IISI)\r\nreturn -ENODEV;\r\nvia = via1;\r\nreturn 0;\r\n}\r\nstatic int\r\nmaciisi_init(void)\r\n{\r\nint err;\r\nif (via == NULL)\r\nreturn -ENODEV;\r\nif ((err = maciisi_init_via())) {\r\nprintk(KERN_ERR "maciisi_init: maciisi_init_via() failed, code %d\n", err);\r\nvia = NULL;\r\nreturn err;\r\n}\r\nif (request_irq(IRQ_MAC_ADB, maciisi_interrupt, 0, "ADB",\r\nmaciisi_interrupt)) {\r\nprintk(KERN_ERR "maciisi_init: can't get irq %d\n", IRQ_MAC_ADB);\r\nreturn -EAGAIN;\r\n}\r\nprintk("adb: Mac IIsi driver v0.2 for Unified ADB.\n");\r\nreturn 0;\r\n}\r\nstatic void\r\nmaciisi_stfu(void)\r\n{\r\nint status = via[B] & (TIP|TREQ);\r\nif (status & TREQ) {\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk (KERN_DEBUG "maciisi_stfu called with TREQ high!\n");\r\n#endif\r\nreturn;\r\n}\r\nudelay(ADB_DELAY);\r\nvia[ACR] &= ~SR_OUT;\r\nvia[IER] = IER_CLR | SR_INT;\r\nudelay(ADB_DELAY);\r\nstatus = via[B] & (TIP|TREQ);\r\nif (!(status & TREQ))\r\n{\r\nvia[B] |= TIP;\r\nwhile(1)\r\n{\r\nint poll_timeout = ADB_DELAY * 5;\r\nwhile (!(via[IFR] & SR_INT) && poll_timeout-- > 0)\r\nstatus = via[B] & (TIP|TREQ);\r\ntmp = via[SR];\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "maciisi_stfu: status %x timeout %d data %x\n",\r\nstatus, poll_timeout, tmp);\r\n#endif\r\nif(via[B] & TREQ)\r\nbreak;\r\nvia[B] |= TACK;\r\nudelay(ADB_DELAY);\r\nvia[B] &= ~TACK;\r\n}\r\nvia[B] &= ~TIP;\r\nudelay(ADB_DELAY);\r\n}\r\nvia[IER] = IER_SET | SR_INT;\r\n}\r\nstatic int\r\nmaciisi_init_via(void)\r\n{\r\nint i;\r\nvia[DIRB] = (via[DIRB] | TACK | TIP) & ~TREQ;\r\nvia[ACR] = (via[ACR] & ~SR_CTRL) | SR_EXT;\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "maciisi_init_via: initial status %x\n", via[B] & (TIP|TREQ));\r\n#endif\r\ntmp = via[SR];\r\nvia[IER] = IER_SET | SR_INT;\r\nvia[B] &= ~(TACK|TIP);\r\nvia[IFR] = SR_INT;\r\nfor(i = 0; i < 60; i++) {\r\nudelay(ADB_DELAY);\r\nmaciisi_stfu();\r\nudelay(ADB_DELAY);\r\nif(via[B] & TREQ)\r\nbreak;\r\n}\r\nif (i == 60)\r\nprintk(KERN_ERR "maciisi_init_via: bus jam?\n");\r\nmaciisi_state = idle;\r\nneed_sync = 0;\r\nreturn 0;\r\n}\r\nstatic int\r\nmaciisi_send_request(struct adb_request* req, int sync)\r\n{\r\nint i;\r\n#ifdef DEBUG_MACIISI_ADB\r\nstatic int dump_packet = 0;\r\n#endif\r\nif (via == NULL) {\r\nreq->complete = 1;\r\nreturn -ENXIO;\r\n}\r\n#ifdef DEBUG_MACIISI_ADB\r\nif (dump_packet) {\r\nprintk(KERN_DEBUG "maciisi_send_request:");\r\nfor (i = 0; i < req->nbytes; i++) {\r\nprintk(" %.2x", req->data[i]);\r\n}\r\nprintk(" sync %d\n", sync);\r\n}\r\n#endif\r\nreq->reply_expected = 1;\r\ni = maciisi_write(req);\r\nif (i)\r\n{\r\nif(i == -EBUSY && sync)\r\nneed_sync = 1;\r\nelse\r\nneed_sync = 0;\r\nreturn i;\r\n}\r\nif(sync)\r\nmaciisi_sync(req);\r\nreturn 0;\r\n}\r\nstatic void maciisi_sync(struct adb_request *req)\r\n{\r\nint count = 0;\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "maciisi_sync called\n");\r\n#endif\r\nwhile (!req->complete && count++ < 50) {\r\nmaciisi_poll();\r\n}\r\nif (count > 50)\r\nprintk(KERN_ERR "maciisi_send_request: poll timed out!\n");\r\n}\r\nint\r\nmaciisi_request(struct adb_request *req, void (*done)(struct adb_request *),\r\nint nbytes, ...)\r\n{\r\nva_list list;\r\nint i;\r\nreq->nbytes = nbytes;\r\nreq->done = done;\r\nreq->reply_expected = 0;\r\nva_start(list, nbytes);\r\nfor (i = 0; i < nbytes; i++)\r\nreq->data[i++] = va_arg(list, int);\r\nva_end(list);\r\nreturn maciisi_send_request(req, 1);\r\n}\r\nstatic int\r\nmaciisi_write(struct adb_request* req)\r\n{\r\nunsigned long flags;\r\nint i;\r\nif (req->nbytes < 2 || req->data[0] > CUDA_PACKET) {\r\nprintk(KERN_ERR "maciisi_write: packet too small or not an ADB or CUDA packet\n");\r\nreq->complete = 1;\r\nreturn -EINVAL;\r\n}\r\nreq->next = NULL;\r\nreq->sent = 0;\r\nreq->complete = 0;\r\nreq->reply_len = 0;\r\nlocal_irq_save(flags);\r\nif (current_req) {\r\nlast_req->next = req;\r\nlast_req = req;\r\n} else {\r\ncurrent_req = req;\r\nlast_req = req;\r\n}\r\nif (maciisi_state == idle)\r\n{\r\ni = maciisi_start();\r\nif(i != 0)\r\n{\r\nlocal_irq_restore(flags);\r\nreturn i;\r\n}\r\n}\r\nelse\r\n{\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "maciisi_write: would start, but state is %d\n", maciisi_state);\r\n#endif\r\nlocal_irq_restore(flags);\r\nreturn -EBUSY;\r\n}\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int\r\nmaciisi_start(void)\r\n{\r\nstruct adb_request* req;\r\nint status;\r\n#ifdef DEBUG_MACIISI_ADB\r\nstatus = via[B] & (TIP | TREQ);\r\nprintk(KERN_DEBUG "maciisi_start called, state=%d, status=%x, ifr=%x\n", maciisi_state, status, via[IFR]);\r\n#endif\r\nif (maciisi_state != idle) {\r\nprintk(KERN_ERR "maciisi_start: maciisi_start called when driver busy!\n");\r\nreturn -EBUSY;\r\n}\r\nreq = current_req;\r\nif (req == NULL)\r\nreturn -EINVAL;\r\nstatus = via[B] & (TIP|TREQ);\r\nif (!(status & TREQ)) {\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "maciisi_start: bus busy - aborting\n");\r\n#endif\r\nreturn -EBUSY;\r\n}\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "maciisi_start: sending\n");\r\n#endif\r\nvia[B] |= TIP;\r\nvia[B] &= ~TACK;\r\nudelay(ADB_DELAY);\r\nvia[ACR] |= SR_OUT;\r\nvia[SR] = req->data[0];\r\ndata_index = 1;\r\nvia[B] |= TACK;\r\nmaciisi_state = sending;\r\nreturn 0;\r\n}\r\nvoid\r\nmaciisi_poll(void)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (via[IFR] & SR_INT) {\r\nmaciisi_interrupt(0, NULL);\r\n}\r\nelse\r\nudelay(ADB_DELAY);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic irqreturn_t\r\nmaciisi_interrupt(int irq, void* arg)\r\n{\r\nint status;\r\nstruct adb_request *req;\r\n#ifdef DEBUG_MACIISI_ADB\r\nstatic int dump_reply = 0;\r\n#endif\r\nint i;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nstatus = via[B] & (TIP|TREQ);\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "state %d status %x ifr %x\n", maciisi_state, status, via[IFR]);\r\n#endif\r\nif (!(via[IFR] & SR_INT)) {\r\nprintk(KERN_ERR "maciisi_interrupt: called without interrupt flag set\n");\r\nlocal_irq_restore(flags);\r\nreturn IRQ_NONE;\r\n}\r\nswitch_start:\r\nswitch (maciisi_state) {\r\ncase idle:\r\nif (status & TIP)\r\nprintk(KERN_ERR "maciisi_interrupt: state is idle but TIP asserted!\n");\r\nif(!reading_reply)\r\nudelay(ADB_DELAY);\r\nvia[ACR] &= ~SR_OUT;\r\nvia[B] |= TIP;\r\ntmp = via[SR];\r\nvia[B] |= TACK;\r\nudelay(ADB_DELAY);\r\nvia[B] &= ~TACK;\r\nreply_len = 0;\r\nmaciisi_state = reading;\r\nif (reading_reply) {\r\nreply_ptr = current_req->reply;\r\n} else {\r\nreply_ptr = maciisi_rbuf;\r\n}\r\nbreak;\r\ncase sending:\r\nvia[B] &= ~TACK;\r\nreq = current_req;\r\nif (!(status & TREQ)) {\r\nprintk(KERN_ERR "maciisi_interrupt: send collision\n");\r\nvia[ACR] &= ~SR_OUT;\r\ntmp = via[SR];\r\nvia[B] &= ~TIP;\r\nreading_reply = 0;\r\nreply_len = 0;\r\nmaciisi_state = idle;\r\nudelay(ADB_DELAY);\r\ngoto switch_start;\r\n}\r\nudelay(ADB_DELAY);\r\nif (data_index >= req->nbytes) {\r\nvia[ACR] &= ~SR_OUT;\r\ntmp = via[SR];\r\nvia[B] &= ~TIP;\r\nreq->sent = 1;\r\nmaciisi_state = idle;\r\nif (req->reply_expected) {\r\nreading_reply = 1;\r\n} else {\r\ncurrent_req = req->next;\r\nif (req->done)\r\n(*req->done)(req);\r\ni = maciisi_start();\r\nif(i == 0 && need_sync) {\r\nmaciisi_sync(current_req);\r\n}\r\nif(i != -EBUSY)\r\nneed_sync = 0;\r\n}\r\n} else {\r\nvia[ACR] |= SR_OUT;\r\nvia[SR] = req->data[data_index++];\r\nvia[B] |= TACK;\r\n}\r\nbreak;\r\ncase reading:\r\nif (reply_len++ > 16) {\r\nprintk(KERN_ERR "maciisi_interrupt: reply too long, aborting read\n");\r\nvia[B] |= TACK;\r\nudelay(ADB_DELAY);\r\nvia[B] &= ~(TACK|TIP);\r\nmaciisi_state = idle;\r\ni = maciisi_start();\r\nif(i == 0 && need_sync) {\r\nmaciisi_sync(current_req);\r\n}\r\nif(i != -EBUSY)\r\nneed_sync = 0;\r\nbreak;\r\n}\r\n*reply_ptr++ = via[SR];\r\nstatus = via[B] & (TIP|TREQ);\r\nvia[B] |= TACK;\r\nudelay(ADB_DELAY);\r\nvia[B] &= ~TACK;\r\nif (!(status & TREQ))\r\nbreak;\r\nvia[B] &= ~TIP;\r\ntmp = via[SR];\r\nudelay(ADB_DELAY);\r\nif (reading_reply) {\r\nreq = current_req;\r\nreq->reply_len = reply_ptr - req->reply;\r\nif (req->data[0] == ADB_PACKET) {\r\nif (req->reply_len <= 2 || (req->reply[1] & 2) != 0) {\r\nreq->reply_len = 0;\r\n} else {\r\nreq->reply_len -= 2;\r\nmemmove(req->reply, req->reply + 2, req->reply_len);\r\n}\r\n}\r\n#ifdef DEBUG_MACIISI_ADB\r\nif (dump_reply) {\r\nint i;\r\nprintk(KERN_DEBUG "maciisi_interrupt: reply is ");\r\nfor (i = 0; i < req->reply_len; ++i)\r\nprintk(" %.2x", req->reply[i]);\r\nprintk("\n");\r\n}\r\n#endif\r\nreq->complete = 1;\r\ncurrent_req = req->next;\r\nif (req->done)\r\n(*req->done)(req);\r\nreading_reply = 0;\r\n} else {\r\nmaciisi_input(maciisi_rbuf, reply_ptr - maciisi_rbuf);\r\n}\r\nmaciisi_state = idle;\r\nstatus = via[B] & (TIP|TREQ);\r\nif (!(status & TREQ)) {\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "extra data after packet: status %x ifr %x\n",\r\nstatus, via[IFR]);\r\n#endif\r\n#if 0\r\nudelay(ADB_DELAY);\r\nvia[B] |= TIP;\r\nmaciisi_state = reading;\r\nreading_reply = 0;\r\nreply_ptr = maciisi_rbuf;\r\n#else\r\nreading_reply = 0;\r\ngoto switch_start;\r\n#endif\r\n}\r\nelse {\r\ni = maciisi_start();\r\nif(i == 0 && need_sync) {\r\nmaciisi_sync(current_req);\r\n}\r\nif(i != -EBUSY)\r\nneed_sync = 0;\r\n}\r\nbreak;\r\ndefault:\r\nprintk("maciisi_interrupt: unknown maciisi_state %d?\n", maciisi_state);\r\n}\r\nlocal_irq_restore(flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nmaciisi_input(unsigned char *buf, int nb)\r\n{\r\n#ifdef DEBUG_MACIISI_ADB\r\nint i;\r\n#endif\r\nswitch (buf[0]) {\r\ncase ADB_PACKET:\r\nadb_input(buf+2, nb-2, buf[1] & 0x40);\r\nbreak;\r\ndefault:\r\n#ifdef DEBUG_MACIISI_ADB\r\nprintk(KERN_DEBUG "data from IIsi ADB (%d bytes):", nb);\r\nfor (i = 0; i < nb; ++i)\r\nprintk(" %.2x", buf[i]);\r\nprintk("\n");\r\n#endif\r\nbreak;\r\n}\r\n}

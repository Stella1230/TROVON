static int clk_ether_prepare(struct clk_hw *hw)\r\n{\r\nstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\r\nu32 val;\r\nval = readl_relaxed(clk->ctrl_reg);\r\nval |= clk->ctrl_clk_mask | clk->ctrl_rst_mask;\r\nwritel_relaxed(val, clk->ctrl_reg);\r\nval &= ~(clk->ctrl_rst_mask);\r\nwritel_relaxed(val, clk->ctrl_reg);\r\nval = readl_relaxed(clk->phy_reg);\r\nval |= clk->phy_clk_mask;\r\nval &= ~(clk->phy_rst_mask);\r\nwritel_relaxed(val, clk->phy_reg);\r\nmdelay(10);\r\nval &= ~(clk->phy_clk_mask);\r\nval |= clk->phy_rst_mask;\r\nwritel_relaxed(val, clk->phy_reg);\r\nmdelay(10);\r\nval |= clk->phy_clk_mask;\r\nval &= ~(clk->phy_rst_mask);\r\nwritel_relaxed(val, clk->phy_reg);\r\nmdelay(30);\r\nreturn 0;\r\n}\r\nstatic void clk_ether_unprepare(struct clk_hw *hw)\r\n{\r\nstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\r\nu32 val;\r\nval = readl_relaxed(clk->ctrl_reg);\r\nval &= ~(clk->ctrl_clk_mask);\r\nwritel_relaxed(val, clk->ctrl_reg);\r\n}\r\nstatic int clk_complex_enable(struct clk_hw *hw)\r\n{\r\nstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\r\nu32 val;\r\nval = readl_relaxed(clk->ctrl_reg);\r\nval |= clk->ctrl_clk_mask;\r\nval &= ~(clk->ctrl_rst_mask);\r\nwritel_relaxed(val, clk->ctrl_reg);\r\nval = readl_relaxed(clk->phy_reg);\r\nval |= clk->phy_clk_mask;\r\nval &= ~(clk->phy_rst_mask);\r\nwritel_relaxed(val, clk->phy_reg);\r\nreturn 0;\r\n}\r\nstatic void clk_complex_disable(struct clk_hw *hw)\r\n{\r\nstruct hix5hd2_clk_complex *clk = to_complex_clk(hw);\r\nu32 val;\r\nval = readl_relaxed(clk->ctrl_reg);\r\nval |= clk->ctrl_rst_mask;\r\nval &= ~(clk->ctrl_clk_mask);\r\nwritel_relaxed(val, clk->ctrl_reg);\r\nval = readl_relaxed(clk->phy_reg);\r\nval |= clk->phy_rst_mask;\r\nval &= ~(clk->phy_clk_mask);\r\nwritel_relaxed(val, clk->phy_reg);\r\n}\r\nvoid __init hix5hd2_clk_register_complex(struct hix5hd2_complex_clock *clks,\r\nint nums, struct hisi_clock_data *data)\r\n{\r\nvoid __iomem *base = data->base;\r\nint i;\r\nfor (i = 0; i < nums; i++) {\r\nstruct hix5hd2_clk_complex *p_clk;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\np_clk = kzalloc(sizeof(*p_clk), GFP_KERNEL);\r\nif (!p_clk)\r\nreturn;\r\ninit.name = clks[i].name;\r\nif (clks[i].type == TYPE_ETHER)\r\ninit.ops = &clk_ether_ops;\r\nelse\r\ninit.ops = &clk_complex_ops;\r\ninit.flags = CLK_IS_BASIC;\r\ninit.parent_names =\r\n(clks[i].parent_name ? &clks[i].parent_name : NULL);\r\ninit.num_parents = (clks[i].parent_name ? 1 : 0);\r\np_clk->ctrl_reg = base + clks[i].ctrl_reg;\r\np_clk->ctrl_clk_mask = clks[i].ctrl_clk_mask;\r\np_clk->ctrl_rst_mask = clks[i].ctrl_rst_mask;\r\np_clk->phy_reg = base + clks[i].phy_reg;\r\np_clk->phy_clk_mask = clks[i].phy_clk_mask;\r\np_clk->phy_rst_mask = clks[i].phy_rst_mask;\r\np_clk->hw.init = &init;\r\nclk = clk_register(NULL, &p_clk->hw);\r\nif (IS_ERR(clk)) {\r\nkfree(p_clk);\r\npr_err("%s: failed to register clock %s\n",\r\n__func__, clks[i].name);\r\ncontinue;\r\n}\r\ndata->clk_data.clks[clks[i].id] = clk;\r\n}\r\n}\r\nstatic void __init hix5hd2_clk_init(struct device_node *np)\r\n{\r\nstruct hisi_clock_data *clk_data;\r\nclk_data = hisi_clk_init(np, HIX5HD2_NR_CLKS);\r\nif (!clk_data)\r\nreturn;\r\nhisi_clk_register_fixed_rate(hix5hd2_fixed_rate_clks,\r\nARRAY_SIZE(hix5hd2_fixed_rate_clks),\r\nclk_data);\r\nhisi_clk_register_mux(hix5hd2_mux_clks, ARRAY_SIZE(hix5hd2_mux_clks),\r\nclk_data);\r\nhisi_clk_register_gate(hix5hd2_gate_clks,\r\nARRAY_SIZE(hix5hd2_gate_clks), clk_data);\r\nhix5hd2_clk_register_complex(hix5hd2_complex_clks,\r\nARRAY_SIZE(hix5hd2_complex_clks),\r\nclk_data);\r\n}

static void iommu_release_device(struct device *dev)\r\n{\r\nkfree(dev);\r\n}\r\nstatic int __init iommu_dev_init(void)\r\n{\r\nreturn class_register(&iommu_class);\r\n}\r\nstruct device *iommu_device_create(struct device *parent, void *drvdata,\r\nconst struct attribute_group **groups,\r\nconst char *fmt, ...)\r\n{\r\nstruct device *dev;\r\nva_list vargs;\r\nint ret;\r\ndev = kzalloc(sizeof(*dev), GFP_KERNEL);\r\nif (!dev)\r\nreturn ERR_PTR(-ENOMEM);\r\ndevice_initialize(dev);\r\ndev->class = &iommu_class;\r\ndev->parent = parent;\r\ndev->groups = groups;\r\ndev_set_drvdata(dev, drvdata);\r\nva_start(vargs, fmt);\r\nret = kobject_set_name_vargs(&dev->kobj, fmt, vargs);\r\nva_end(vargs);\r\nif (ret)\r\ngoto error;\r\nret = device_add(dev);\r\nif (ret)\r\ngoto error;\r\nreturn dev;\r\nerror:\r\nput_device(dev);\r\nreturn ERR_PTR(ret);\r\n}\r\nvoid iommu_device_destroy(struct device *dev)\r\n{\r\nif (!dev || IS_ERR(dev))\r\nreturn;\r\ndevice_unregister(dev);\r\n}\r\nint iommu_device_link(struct device *dev, struct device *link)\r\n{\r\nint ret;\r\nif (!dev || IS_ERR(dev))\r\nreturn -ENODEV;\r\nret = sysfs_add_link_to_group(&dev->kobj, "devices",\r\n&link->kobj, dev_name(link));\r\nif (ret)\r\nreturn ret;\r\nret = sysfs_create_link_nowarn(&link->kobj, &dev->kobj, "iommu");\r\nif (ret)\r\nsysfs_remove_link_from_group(&dev->kobj, "devices",\r\ndev_name(link));\r\nreturn ret;\r\n}\r\nvoid iommu_device_unlink(struct device *dev, struct device *link)\r\n{\r\nif (!dev || IS_ERR(dev))\r\nreturn;\r\nsysfs_remove_link(&link->kobj, "iommu");\r\nsysfs_remove_link_from_group(&dev->kobj, "devices", dev_name(link));\r\n}

static u32 bcm63xx_int_cfg_readl(u32 reg)\r\n{\r\nu32 tmp;\r\ntmp = reg & MPI_PCICFGCTL_CFGADDR_MASK;\r\ntmp |= MPI_PCICFGCTL_WRITEEN_MASK;\r\nbcm_mpi_writel(tmp, MPI_PCICFGCTL_REG);\r\niob();\r\nreturn bcm_mpi_readl(MPI_PCICFGDATA_REG);\r\n}\r\nstatic void bcm63xx_int_cfg_writel(u32 val, u32 reg)\r\n{\r\nu32 tmp;\r\ntmp = reg & MPI_PCICFGCTL_CFGADDR_MASK;\r\ntmp |= MPI_PCICFGCTL_WRITEEN_MASK;\r\nbcm_mpi_writel(tmp, MPI_PCICFGCTL_REG);\r\nbcm_mpi_writel(val, MPI_PCICFGDATA_REG);\r\n}\r\nstatic void __init bcm63xx_reset_pcie(void)\r\n{\r\nu32 val;\r\nu32 reg;\r\nif (BCMCPU_IS_6328())\r\nreg = MISC_SERDES_CTRL_6328_REG;\r\nelse\r\nreg = MISC_SERDES_CTRL_6362_REG;\r\nval = bcm_misc_readl(reg);\r\nval |= SERDES_PCIE_EN | SERDES_PCIE_EXD_EN;\r\nbcm_misc_writel(val, reg);\r\nbcm63xx_core_set_reset(BCM63XX_RESET_PCIE, 1);\r\nbcm63xx_core_set_reset(BCM63XX_RESET_PCIE_EXT, 1);\r\nmdelay(10);\r\nbcm63xx_core_set_reset(BCM63XX_RESET_PCIE, 0);\r\nmdelay(10);\r\nbcm63xx_core_set_reset(BCM63XX_RESET_PCIE_EXT, 0);\r\nmdelay(200);\r\n}\r\nstatic int __init bcm63xx_register_pcie(void)\r\n{\r\nu32 val;\r\npcie_clk = clk_get(NULL, "pcie");\r\nif (IS_ERR_OR_NULL(pcie_clk))\r\nreturn -ENODEV;\r\nclk_prepare_enable(pcie_clk);\r\nbcm63xx_reset_pcie();\r\nval = bcm_pcie_readl(PCIE_BRIDGE_OPT1_REG);\r\nval |= OPT1_RD_BE_OPT_EN;\r\nval |= OPT1_RD_REPLY_BE_FIX_EN;\r\nval |= OPT1_PCIE_BRIDGE_HOLE_DET_EN;\r\nval |= OPT1_L1_INT_STATUS_MASK_POL;\r\nbcm_pcie_writel(val, PCIE_BRIDGE_OPT1_REG);\r\nval = bcm_pcie_readl(PCIE_BRIDGE_RC_INT_MASK_REG);\r\nval |= PCIE_RC_INT_A | PCIE_RC_INT_B | PCIE_RC_INT_C | PCIE_RC_INT_D;\r\nbcm_pcie_writel(val, PCIE_BRIDGE_RC_INT_MASK_REG);\r\nval = bcm_pcie_readl(PCIE_BRIDGE_OPT2_REG);\r\nval |= OPT2_TX_CREDIT_CHK_EN;\r\nval |= OPT2_UBUS_UR_DECODE_DIS;\r\nval |= (PCIE_BUS_DEVICE << OPT2_CFG_TYPE1_BUS_NO_SHIFT);\r\nval |= OPT2_CFG_TYPE1_BD_SEL;\r\nbcm_pcie_writel(val, PCIE_BRIDGE_OPT2_REG);\r\nval = bcm_pcie_readl(PCIE_IDVAL3_REG);\r\nval &= ~IDVAL3_CLASS_CODE_MASK;\r\nval |= (PCI_CLASS_BRIDGE_PCI << IDVAL3_SUBCLASS_SHIFT);\r\nbcm_pcie_writel(val, PCIE_IDVAL3_REG);\r\nval = bcm_pcie_readl(PCIE_CONFIG2_REG);\r\nval &= ~CONFIG2_BAR1_SIZE_MASK;\r\nbcm_pcie_writel(val, PCIE_CONFIG2_REG);\r\nval = (BCM_PCIE_MEM_BASE_PA >> 20) << BASEMASK_BASE_SHIFT;\r\nval |= (BCM_PCIE_MEM_BASE_PA >> 20) << BASEMASK_MASK_SHIFT;\r\nval |= BASEMASK_REMAP_EN;\r\nbcm_pcie_writel(val, PCIE_BRIDGE_BAR0_BASEMASK_REG);\r\nval = (BCM_PCIE_MEM_BASE_PA >> 20) << REBASE_ADDR_BASE_SHIFT;\r\nbcm_pcie_writel(val, PCIE_BRIDGE_BAR0_REBASE_ADDR_REG);\r\nregister_pci_controller(&bcm63xx_pcie_controller);\r\nreturn 0;\r\n}\r\nstatic int __init bcm63xx_register_pci(void)\r\n{\r\nunsigned int mem_size;\r\nu32 val;\r\npci_iospace_start = ioremap_nocache(BCM_PCI_IO_BASE_PA, 4);\r\nif (!pci_iospace_start)\r\nreturn -ENOMEM;\r\nval = BCM_PCI_MEM_BASE_PA & MPI_L2P_BASE_MASK;\r\nbcm_mpi_writel(val, MPI_L2PMEMBASE1_REG);\r\nbcm_mpi_writel(~(BCM_PCI_MEM_SIZE - 1), MPI_L2PMEMRANGE1_REG);\r\nbcm_mpi_writel(val | MPI_L2PREMAP_ENABLED_MASK, MPI_L2PMEMREMAP1_REG);\r\nval = bcm_pcmcia_readl(PCMCIA_C1_REG);\r\nval &= ~PCMCIA_C1_CBIDSEL_MASK;\r\nval |= (CARDBUS_PCI_IDSEL << PCMCIA_C1_CBIDSEL_SHIFT);\r\nbcm_pcmcia_writel(val, PCMCIA_C1_REG);\r\n#ifdef CONFIG_CARDBUS\r\nval = BCM_CB_MEM_BASE_PA & MPI_L2P_BASE_MASK;\r\nbcm_mpi_writel(val, MPI_L2PMEMBASE2_REG);\r\nbcm_mpi_writel(~(BCM_CB_MEM_SIZE - 1), MPI_L2PMEMRANGE2_REG);\r\nval |= MPI_L2PREMAP_ENABLED_MASK | MPI_L2PREMAP_IS_CARDBUS_MASK;\r\nbcm_mpi_writel(val, MPI_L2PMEMREMAP2_REG);\r\n#else\r\nbcm_mpi_writel(0, MPI_L2PMEMREMAP2_REG);\r\n#endif\r\nval = BCM_PCI_IO_BASE_PA & MPI_L2P_BASE_MASK;\r\nbcm_mpi_writel(val, MPI_L2PIOBASE_REG);\r\nbcm_mpi_writel(~(BCM_PCI_IO_SIZE - 1), MPI_L2PIORANGE_REG);\r\nbcm_mpi_writel(val | MPI_L2PREMAP_ENABLED_MASK, MPI_L2PIOREMAP_REG);\r\nbcm_mpi_writel(MPI_LOCBUSCTL_EN_PCI_GPIO_MASK, MPI_LOCBUSCTL_REG);\r\nbcm63xx_int_cfg_writel(0, PCI_BASE_ADDRESS_3);\r\nif (BCMCPU_IS_3368() || BCMCPU_IS_6358() || BCMCPU_IS_6368())\r\nval = MPI_SP0_REMAP_ENABLE_MASK;\r\nelse\r\nval = 0;\r\nbcm_mpi_writel(val, MPI_SP0_REMAP_REG);\r\nbcm63xx_int_cfg_writel(0x0, PCI_BASE_ADDRESS_4);\r\nbcm_mpi_writel(0, MPI_SP1_REMAP_REG);\r\nmem_size = bcm63xx_get_memory_size();\r\nif (BCMCPU_IS_6348() && (bcm63xx_get_cpu_rev() & 0xf0) == 0xa0) {\r\nif (mem_size > (16 * 1024 * 1024))\r\nprintk(KERN_WARNING "bcm63xx: this CPU "\r\n"revision cannot handle more than 16MB "\r\n"of RAM for PCI bus mastering\n");\r\n} else {\r\nbcm_mpi_writel(~(mem_size - 1), MPI_SP0_RANGE_REG);\r\nbcm_mpi_writel(0, MPI_SP1_RANGE_REG);\r\n}\r\nval = bcm63xx_int_cfg_readl(BCMPCI_REG_TIMERS);\r\nval &= ~REG_TIMER_RETRY_MASK;\r\nbcm63xx_int_cfg_writel(val, BCMPCI_REG_TIMERS);\r\nval = bcm63xx_int_cfg_readl(PCI_COMMAND);\r\nval |= (PCI_COMMAND_MEMORY | PCI_COMMAND_MASTER);\r\nbcm63xx_int_cfg_writel(val, PCI_COMMAND);\r\nval = bcm_mpi_readl(MPI_PCIMODESEL_REG);\r\nval &= ~MPI_PCIMODESEL_BAR1_NOSWAP_MASK;\r\nval &= ~MPI_PCIMODESEL_BAR2_NOSWAP_MASK;\r\nval &= ~MPI_PCIMODESEL_PREFETCH_MASK;\r\nval |= (8 << MPI_PCIMODESEL_PREFETCH_SHIFT);\r\nbcm_mpi_writel(val, MPI_PCIMODESEL_REG);\r\nval = bcm_mpi_readl(MPI_LOCINT_REG);\r\nval |= MPI_LOCINT_MASK(MPI_LOCINT_EXT_PCI_INT);\r\nbcm_mpi_writel(val, MPI_LOCINT_REG);\r\nregister_pci_controller(&bcm63xx_controller);\r\n#ifdef CONFIG_CARDBUS\r\nregister_pci_controller(&bcm63xx_cb_controller);\r\n#endif\r\nrequest_mem_region(BCM_PCI_IO_BASE_PA, BCM_PCI_IO_SIZE,\r\n"bcm63xx PCI IO space");\r\nreturn 0;\r\n}\r\nstatic int __init bcm63xx_pci_init(void)\r\n{\r\nif (!bcm63xx_pci_enabled)\r\nreturn -ENODEV;\r\nswitch (bcm63xx_get_cpu_id()) {\r\ncase BCM6328_CPU_ID:\r\ncase BCM6362_CPU_ID:\r\nreturn bcm63xx_register_pcie();\r\ncase BCM3368_CPU_ID:\r\ncase BCM6348_CPU_ID:\r\ncase BCM6358_CPU_ID:\r\ncase BCM6368_CPU_ID:\r\nreturn bcm63xx_register_pci();\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\n}

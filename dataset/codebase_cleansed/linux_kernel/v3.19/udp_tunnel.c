int udp_sock_create4(struct net *net, struct udp_port_cfg *cfg,\r\nstruct socket **sockp)\r\n{\r\nint err;\r\nstruct socket *sock = NULL;\r\nstruct sockaddr_in udp_addr;\r\nerr = sock_create_kern(AF_INET, SOCK_DGRAM, 0, &sock);\r\nif (err < 0)\r\ngoto error;\r\nsk_change_net(sock->sk, net);\r\nudp_addr.sin_family = AF_INET;\r\nudp_addr.sin_addr = cfg->local_ip;\r\nudp_addr.sin_port = cfg->local_udp_port;\r\nerr = kernel_bind(sock, (struct sockaddr *)&udp_addr,\r\nsizeof(udp_addr));\r\nif (err < 0)\r\ngoto error;\r\nif (cfg->peer_udp_port) {\r\nudp_addr.sin_family = AF_INET;\r\nudp_addr.sin_addr = cfg->peer_ip;\r\nudp_addr.sin_port = cfg->peer_udp_port;\r\nerr = kernel_connect(sock, (struct sockaddr *)&udp_addr,\r\nsizeof(udp_addr), 0);\r\nif (err < 0)\r\ngoto error;\r\n}\r\nsock->sk->sk_no_check_tx = !cfg->use_udp_checksums;\r\n*sockp = sock;\r\nreturn 0;\r\nerror:\r\nif (sock) {\r\nkernel_sock_shutdown(sock, SHUT_RDWR);\r\nsk_release_kernel(sock->sk);\r\n}\r\n*sockp = NULL;\r\nreturn err;\r\n}\r\nvoid setup_udp_tunnel_sock(struct net *net, struct socket *sock,\r\nstruct udp_tunnel_sock_cfg *cfg)\r\n{\r\nstruct sock *sk = sock->sk;\r\ninet_sk(sk)->mc_loop = 0;\r\nudp_set_convert_csum(sk, true);\r\nrcu_assign_sk_user_data(sk, cfg->sk_user_data);\r\nudp_sk(sk)->encap_type = cfg->encap_type;\r\nudp_sk(sk)->encap_rcv = cfg->encap_rcv;\r\nudp_sk(sk)->encap_destroy = cfg->encap_destroy;\r\nudp_tunnel_encap_enable(sock);\r\n}\r\nint udp_tunnel_xmit_skb(struct socket *sock, struct rtable *rt,\r\nstruct sk_buff *skb, __be32 src, __be32 dst,\r\n__u8 tos, __u8 ttl, __be16 df, __be16 src_port,\r\n__be16 dst_port, bool xnet)\r\n{\r\nstruct udphdr *uh;\r\n__skb_push(skb, sizeof(*uh));\r\nskb_reset_transport_header(skb);\r\nuh = udp_hdr(skb);\r\nuh->dest = dst_port;\r\nuh->source = src_port;\r\nuh->len = htons(skb->len);\r\nudp_set_csum(sock->sk->sk_no_check_tx, skb, src, dst, skb->len);\r\nreturn iptunnel_xmit(sock->sk, rt, skb, src, dst, IPPROTO_UDP,\r\ntos, ttl, df, xnet);\r\n}\r\nvoid udp_tunnel_sock_release(struct socket *sock)\r\n{\r\nrcu_assign_sk_user_data(sock->sk, NULL);\r\nkernel_sock_shutdown(sock, SHUT_RDWR);\r\nsk_release_kernel(sock->sk);\r\n}

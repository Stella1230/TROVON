static int powr1220_read_adc(struct device *dev, int ch_num)\r\n{\r\nstruct powr1220_data *data = dev_get_drvdata(dev);\r\nint reading;\r\nint result;\r\nint adc_range = 0;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->adc_last_updated[ch_num] + HZ) ||\r\n!data->adc_valid[ch_num]) {\r\nif (data->adc_maxes[ch_num] > ADC_MAX_LOW_MEASUREMENT_MV ||\r\ndata->adc_maxes[ch_num] == 0)\r\nadc_range = 1 << 4;\r\nresult = i2c_smbus_write_byte_data(data->client, ADC_MUX,\r\nadc_range | ch_num);\r\nif (result)\r\ngoto exit;\r\nudelay(200);\r\nresult = i2c_smbus_read_byte_data(data->client, ADC_VALUE_LOW);\r\nif (result < 0)\r\ngoto exit;\r\nreading = result >> 4;\r\nresult = i2c_smbus_read_byte_data(data->client, ADC_VALUE_HIGH);\r\nif (result < 0)\r\ngoto exit;\r\nreading |= result << 4;\r\nreading *= ADC_STEP_MV;\r\ndata->adc_values[ch_num] = reading;\r\ndata->adc_valid[ch_num] = true;\r\ndata->adc_last_updated[ch_num] = jiffies;\r\nresult = reading;\r\nif (reading > data->adc_maxes[ch_num])\r\ndata->adc_maxes[ch_num] = reading;\r\n} else {\r\nresult = data->adc_values[ch_num];\r\n}\r\nexit:\r\nmutex_unlock(&data->update_lock);\r\nreturn result;\r\n}\r\nstatic ssize_t powr1220_show_voltage(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(dev_attr);\r\nint adc_val = powr1220_read_adc(dev, attr->index);\r\nif (adc_val < 0)\r\nreturn adc_val;\r\nreturn sprintf(buf, "%d\n", adc_val);\r\n}\r\nstatic ssize_t powr1220_show_max(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(dev_attr);\r\nstruct powr1220_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->adc_maxes[attr->index]);\r\n}\r\nstatic ssize_t powr1220_show_label(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(dev_attr);\r\nreturn sprintf(buf, "%s\n", input_names[attr->index]);\r\n}\r\nstatic int powr1220_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct powr1220_data *data;\r\nstruct device *hwmon_dev;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\ndata = devm_kzalloc(&client->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nmutex_init(&data->update_lock);\r\ndata->client = client;\r\nhwmon_dev = devm_hwmon_device_register_with_groups(&client->dev,\r\nclient->name, data, powr1220_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

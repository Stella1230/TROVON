int m5mols_do_scenemode(struct m5mols_info *info, u8 mode)\r\n{\r\nstruct v4l2_subdev *sd = &info->sd;\r\nstruct m5mols_scenemode scenemode = m5mols_default_scenemode[mode];\r\nint ret;\r\nif (mode > REG_SCENE_CANDLE)\r\nreturn -EINVAL;\r\nret = v4l2_ctrl_s_ctrl(info->lock_3a, 0);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_EV_PRESET_MONITOR, mode);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_EV_PRESET_CAPTURE, mode);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_MODE, scenemode.metering);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_INDEX, scenemode.ev_bias);\r\nif (!ret)\r\nret = m5mols_write(sd, AWB_MODE, scenemode.wb_mode);\r\nif (!ret)\r\nret = m5mols_write(sd, AWB_MANUAL, scenemode.wb_preset);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CHROMA_EN, scenemode.chroma_en);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CHROMA_LVL, scenemode.chroma_lvl);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_EDGE_EN, scenemode.edge_en);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_EDGE_LVL, scenemode.edge_lvl);\r\nif (!ret && is_available_af(info))\r\nret = m5mols_write(sd, AF_MODE, scenemode.af_range);\r\nif (!ret && is_available_af(info))\r\nret = m5mols_write(sd, FD_CTL, scenemode.fd_mode);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_TONE_CTL, scenemode.tone);\r\nif (!ret)\r\nret = m5mols_write(sd, AE_ISO, scenemode.iso);\r\nif (!ret)\r\nret = m5mols_set_mode(info, REG_CAPTURE);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_WDR_EN, scenemode.wdr);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_MCC_MODE, scenemode.mcc);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_LIGHT_CTRL, scenemode.light);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPP_FLASH_CTRL, scenemode.flash);\r\nif (!ret)\r\nret = m5mols_write(sd, CAPC_MODE, scenemode.capt_mode);\r\nif (!ret)\r\nret = m5mols_set_mode(info, REG_MONITOR);\r\nreturn ret;\r\n}\r\nstatic int m5mols_3a_lock(struct m5mols_info *info, struct v4l2_ctrl *ctrl)\r\n{\r\nbool af_lock = ctrl->val & V4L2_LOCK_FOCUS;\r\nint ret = 0;\r\nif ((ctrl->val ^ ctrl->cur.val) & V4L2_LOCK_EXPOSURE) {\r\nbool ae_lock = ctrl->val & V4L2_LOCK_EXPOSURE;\r\nret = m5mols_write(&info->sd, AE_LOCK, ae_lock ?\r\nREG_AE_LOCK : REG_AE_UNLOCK);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (((ctrl->val ^ ctrl->cur.val) & V4L2_LOCK_WHITE_BALANCE)\r\n&& info->auto_wb->val) {\r\nbool awb_lock = ctrl->val & V4L2_LOCK_WHITE_BALANCE;\r\nret = m5mols_write(&info->sd, AWB_LOCK, awb_lock ?\r\nREG_AWB_LOCK : REG_AWB_UNLOCK);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (!info->ver.af || !af_lock)\r\nreturn ret;\r\nif ((ctrl->val ^ ctrl->cur.val) & V4L2_LOCK_FOCUS)\r\nret = m5mols_write(&info->sd, AF_EXECUTE, REG_AF_STOP);\r\nreturn ret;\r\n}\r\nstatic int m5mols_set_metering_mode(struct m5mols_info *info, int mode)\r\n{\r\nunsigned int metering;\r\nswitch (mode) {\r\ncase V4L2_EXPOSURE_METERING_CENTER_WEIGHTED:\r\nmetering = REG_AE_CENTER;\r\nbreak;\r\ncase V4L2_EXPOSURE_METERING_SPOT:\r\nmetering = REG_AE_SPOT;\r\nbreak;\r\ndefault:\r\nmetering = REG_AE_ALL;\r\nbreak;\r\n}\r\nreturn m5mols_write(&info->sd, AE_MODE, metering);\r\n}\r\nstatic int m5mols_set_exposure(struct m5mols_info *info, int exposure)\r\n{\r\nstruct v4l2_subdev *sd = &info->sd;\r\nint ret = 0;\r\nif (exposure == V4L2_EXPOSURE_AUTO) {\r\ninfo->lock_3a->val &= ~V4L2_LOCK_EXPOSURE;\r\nm5mols_3a_lock(info, info->lock_3a);\r\nret = m5mols_set_metering_mode(info, info->metering->val);\r\nif (ret < 0)\r\nreturn ret;\r\nv4l2_dbg(1, m5mols_debug, sd,\r\n"%s: exposure bias: %#x, metering: %#x\n",\r\n__func__, info->exposure_bias->val,\r\ninfo->metering->val);\r\nreturn m5mols_write(sd, AE_INDEX, info->exposure_bias->val);\r\n}\r\nif (exposure == V4L2_EXPOSURE_MANUAL) {\r\nret = m5mols_write(sd, AE_MODE, REG_AE_OFF);\r\nif (ret == 0)\r\nret = m5mols_write(sd, AE_MAN_GAIN_MON,\r\ninfo->exposure->val);\r\nif (ret == 0)\r\nret = m5mols_write(sd, AE_MAN_GAIN_CAP,\r\ninfo->exposure->val);\r\nv4l2_dbg(1, m5mols_debug, sd, "%s: exposure: %#x\n",\r\n__func__, info->exposure->val);\r\n}\r\nreturn ret;\r\n}\r\nstatic int m5mols_set_white_balance(struct m5mols_info *info, int val)\r\n{\r\nstatic const unsigned short wb[][2] = {\r\n{ V4L2_WHITE_BALANCE_INCANDESCENT, REG_AWB_INCANDESCENT },\r\n{ V4L2_WHITE_BALANCE_FLUORESCENT, REG_AWB_FLUORESCENT_1 },\r\n{ V4L2_WHITE_BALANCE_FLUORESCENT_H, REG_AWB_FLUORESCENT_2 },\r\n{ V4L2_WHITE_BALANCE_HORIZON, REG_AWB_HORIZON },\r\n{ V4L2_WHITE_BALANCE_DAYLIGHT, REG_AWB_DAYLIGHT },\r\n{ V4L2_WHITE_BALANCE_FLASH, REG_AWB_LEDLIGHT },\r\n{ V4L2_WHITE_BALANCE_CLOUDY, REG_AWB_CLOUDY },\r\n{ V4L2_WHITE_BALANCE_SHADE, REG_AWB_SHADE },\r\n{ V4L2_WHITE_BALANCE_AUTO, REG_AWB_AUTO },\r\n};\r\nint i;\r\nstruct v4l2_subdev *sd = &info->sd;\r\nint ret = -EINVAL;\r\nfor (i = 0; i < ARRAY_SIZE(wb); i++) {\r\nint awb;\r\nif (wb[i][0] != val)\r\ncontinue;\r\nv4l2_dbg(1, m5mols_debug, sd,\r\n"Setting white balance to: %#x\n", wb[i][0]);\r\nawb = wb[i][0] == V4L2_WHITE_BALANCE_AUTO;\r\nret = m5mols_write(sd, AWB_MODE, awb ? REG_AWB_AUTO :\r\nREG_AWB_PRESET);\r\nif (ret < 0)\r\nreturn ret;\r\nif (!awb)\r\nret = m5mols_write(sd, AWB_MANUAL, wb[i][1]);\r\n}\r\nreturn ret;\r\n}\r\nstatic int m5mols_set_saturation(struct m5mols_info *info, int val)\r\n{\r\nint ret = m5mols_write(&info->sd, MON_CHROMA_LVL, val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn m5mols_write(&info->sd, MON_CHROMA_EN, REG_CHROMA_ON);\r\n}\r\nstatic int m5mols_set_color_effect(struct m5mols_info *info, int val)\r\n{\r\nunsigned int m_effect = REG_COLOR_EFFECT_OFF;\r\nunsigned int p_effect = REG_EFFECT_OFF;\r\nunsigned int cfix_r = 0, cfix_b = 0;\r\nstruct v4l2_subdev *sd = &info->sd;\r\nint ret = 0;\r\nswitch (val) {\r\ncase V4L2_COLORFX_BW:\r\nm_effect = REG_COLOR_EFFECT_ON;\r\nbreak;\r\ncase V4L2_COLORFX_NEGATIVE:\r\np_effect = REG_EFFECT_NEGA;\r\nbreak;\r\ncase V4L2_COLORFX_EMBOSS:\r\np_effect = REG_EFFECT_EMBOSS;\r\nbreak;\r\ncase V4L2_COLORFX_SEPIA:\r\nm_effect = REG_COLOR_EFFECT_ON;\r\ncfix_r = REG_CFIXR_SEPIA;\r\ncfix_b = REG_CFIXB_SEPIA;\r\nbreak;\r\n}\r\nret = m5mols_write(sd, PARM_EFFECT, p_effect);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_EFFECT, m_effect);\r\nif (ret == 0 && m_effect == REG_COLOR_EFFECT_ON) {\r\nret = m5mols_write(sd, MON_CFIXR, cfix_r);\r\nif (!ret)\r\nret = m5mols_write(sd, MON_CFIXB, cfix_b);\r\n}\r\nv4l2_dbg(1, m5mols_debug, sd,\r\n"p_effect: %#x, m_effect: %#x, r: %#x, b: %#x (%d)\n",\r\np_effect, m_effect, cfix_r, cfix_b, ret);\r\nreturn ret;\r\n}\r\nstatic int m5mols_set_iso(struct m5mols_info *info, int auto_iso)\r\n{\r\nu32 iso = auto_iso ? 0 : info->iso->val + 1;\r\nreturn m5mols_write(&info->sd, AE_ISO, iso);\r\n}\r\nstatic int m5mols_set_wdr(struct m5mols_info *info, int wdr)\r\n{\r\nint ret;\r\nret = m5mols_write(&info->sd, MON_TONE_CTL, wdr ? 9 : 5);\r\nif (ret < 0)\r\nreturn ret;\r\nret = m5mols_set_mode(info, REG_CAPTURE);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn m5mols_write(&info->sd, CAPP_WDR_EN, wdr);\r\n}\r\nstatic int m5mols_set_stabilization(struct m5mols_info *info, int val)\r\n{\r\nstruct v4l2_subdev *sd = &info->sd;\r\nunsigned int evp = val ? 0xe : 0x0;\r\nint ret;\r\nret = m5mols_write(sd, AE_EV_PRESET_MONITOR, evp);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn m5mols_write(sd, AE_EV_PRESET_CAPTURE, evp);\r\n}\r\nstatic int m5mols_g_volatile_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct v4l2_subdev *sd = to_sd(ctrl);\r\nstruct m5mols_info *info = to_m5mols(sd);\r\nint ret = 0;\r\nu8 status;\r\nv4l2_dbg(1, m5mols_debug, sd, "%s: ctrl: %s (%d)\n",\r\n__func__, ctrl->name, info->isp_ready);\r\nif (!info->isp_ready)\r\nreturn -EBUSY;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_ISO_SENSITIVITY_AUTO:\r\nret = m5mols_read_u8(sd, AE_ISO, &status);\r\nif (ret == 0)\r\nctrl->val = !status;\r\nif (status != REG_ISO_AUTO)\r\ninfo->iso->val = status - 1;\r\nbreak;\r\ncase V4L2_CID_3A_LOCK:\r\nctrl->val &= ~0x7;\r\nret = m5mols_read_u8(sd, AE_LOCK, &status);\r\nif (ret)\r\nreturn ret;\r\nif (status)\r\ninfo->lock_3a->val |= V4L2_LOCK_EXPOSURE;\r\nret = m5mols_read_u8(sd, AWB_LOCK, &status);\r\nif (ret)\r\nreturn ret;\r\nif (status)\r\ninfo->lock_3a->val |= V4L2_LOCK_EXPOSURE;\r\nret = m5mols_read_u8(sd, AF_EXECUTE, &status);\r\nif (!status)\r\ninfo->lock_3a->val |= V4L2_LOCK_EXPOSURE;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int m5mols_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nunsigned int ctrl_mode = m5mols_get_ctrl_mode(ctrl);\r\nstruct v4l2_subdev *sd = to_sd(ctrl);\r\nstruct m5mols_info *info = to_m5mols(sd);\r\nint last_mode = info->mode;\r\nint ret = 0;\r\nif (!info->isp_ready) {\r\ninfo->ctrl_sync = 0;\r\nreturn 0;\r\n}\r\nv4l2_dbg(1, m5mols_debug, sd, "%s: %s, val: %d, priv: %p\n",\r\n__func__, ctrl->name, ctrl->val, ctrl->priv);\r\nif (ctrl_mode && ctrl_mode != info->mode) {\r\nret = m5mols_set_mode(info, ctrl_mode);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_3A_LOCK:\r\nret = m5mols_3a_lock(info, ctrl);\r\nbreak;\r\ncase V4L2_CID_ZOOM_ABSOLUTE:\r\nret = m5mols_write(sd, MON_ZOOM, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_EXPOSURE_AUTO:\r\nret = m5mols_set_exposure(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_ISO_SENSITIVITY:\r\nret = m5mols_set_iso(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE:\r\nret = m5mols_set_white_balance(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\nret = m5mols_set_saturation(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_COLORFX:\r\nret = m5mols_set_color_effect(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_WIDE_DYNAMIC_RANGE:\r\nret = m5mols_set_wdr(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_IMAGE_STABILIZATION:\r\nret = m5mols_set_stabilization(info, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_JPEG_COMPRESSION_QUALITY:\r\nret = m5mols_write(sd, CAPP_JPEG_RATIO, ctrl->val);\r\nbreak;\r\n}\r\nif (ret == 0 && info->mode != last_mode)\r\nret = m5mols_set_mode(info, last_mode);\r\nreturn ret;\r\n}\r\nint m5mols_init_controls(struct v4l2_subdev *sd)\r\n{\r\nstruct m5mols_info *info = to_m5mols(sd);\r\nu16 exposure_max;\r\nu16 zoom_step;\r\nint ret;\r\nret = m5mols_read_u16(sd, AE_MAX_GAIN_MON, &exposure_max);\r\nif (ret < 0)\r\nreturn ret;\r\nzoom_step = is_manufacturer(info, REG_SAMSUNG_OPTICS) ? 31 : 1;\r\nv4l2_ctrl_handler_init(&info->handle, 20);\r\ninfo->auto_wb = v4l2_ctrl_new_std_menu(&info->handle,\r\n&m5mols_ctrl_ops, V4L2_CID_AUTO_N_PRESET_WHITE_BALANCE,\r\n9, ~0x3fe, V4L2_WHITE_BALANCE_AUTO);\r\ninfo->auto_exposure = v4l2_ctrl_new_std_menu(&info->handle,\r\n&m5mols_ctrl_ops, V4L2_CID_EXPOSURE_AUTO,\r\n1, ~0x03, V4L2_EXPOSURE_AUTO);\r\ninfo->exposure = v4l2_ctrl_new_std(&info->handle,\r\n&m5mols_ctrl_ops, V4L2_CID_EXPOSURE,\r\n0, exposure_max, 1, exposure_max / 2);\r\ninfo->exposure_bias = v4l2_ctrl_new_int_menu(&info->handle,\r\n&m5mols_ctrl_ops, V4L2_CID_AUTO_EXPOSURE_BIAS,\r\nARRAY_SIZE(ev_bias_qmenu) - 1,\r\nARRAY_SIZE(ev_bias_qmenu)/2 - 1,\r\nev_bias_qmenu);\r\ninfo->metering = v4l2_ctrl_new_std_menu(&info->handle,\r\n&m5mols_ctrl_ops, V4L2_CID_EXPOSURE_METERING,\r\n2, ~0x7, V4L2_EXPOSURE_METERING_AVERAGE);\r\ninfo->auto_iso = v4l2_ctrl_new_std_menu(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_ISO_SENSITIVITY_AUTO, 1, ~0x03, 1);\r\ninfo->iso = v4l2_ctrl_new_int_menu(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_ISO_SENSITIVITY, ARRAY_SIZE(iso_qmenu) - 1,\r\nARRAY_SIZE(iso_qmenu)/2 - 1, iso_qmenu);\r\ninfo->saturation = v4l2_ctrl_new_std(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_SATURATION, 1, 5, 1, 3);\r\ninfo->zoom = v4l2_ctrl_new_std(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_ZOOM_ABSOLUTE, 1, 70, zoom_step, 1);\r\ninfo->colorfx = v4l2_ctrl_new_std_menu(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_COLORFX, 4, 0, V4L2_COLORFX_NONE);\r\ninfo->wdr = v4l2_ctrl_new_std(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_WIDE_DYNAMIC_RANGE, 0, 1, 1, 0);\r\ninfo->stabilization = v4l2_ctrl_new_std(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_IMAGE_STABILIZATION, 0, 1, 1, 0);\r\ninfo->jpeg_quality = v4l2_ctrl_new_std(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_JPEG_COMPRESSION_QUALITY, 1, 100, 1, 80);\r\ninfo->lock_3a = v4l2_ctrl_new_std(&info->handle, &m5mols_ctrl_ops,\r\nV4L2_CID_3A_LOCK, 0, 0x7, 0, 0);\r\nif (info->handle.error) {\r\nint ret = info->handle.error;\r\nv4l2_err(sd, "Failed to initialize controls: %d\n", ret);\r\nv4l2_ctrl_handler_free(&info->handle);\r\nreturn ret;\r\n}\r\nv4l2_ctrl_auto_cluster(4, &info->auto_exposure, 1, false);\r\ninfo->auto_iso->flags |= V4L2_CTRL_FLAG_VOLATILE |\r\nV4L2_CTRL_FLAG_UPDATE;\r\nv4l2_ctrl_auto_cluster(2, &info->auto_iso, 0, false);\r\ninfo->lock_3a->flags |= V4L2_CTRL_FLAG_VOLATILE;\r\nm5mols_set_ctrl_mode(info->auto_exposure, REG_PARAMETER);\r\nm5mols_set_ctrl_mode(info->auto_wb, REG_PARAMETER);\r\nm5mols_set_ctrl_mode(info->colorfx, REG_MONITOR);\r\nsd->ctrl_handler = &info->handle;\r\nreturn 0;\r\n}

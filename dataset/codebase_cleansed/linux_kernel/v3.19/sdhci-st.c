static u32 sdhci_st_readl(struct sdhci_host *host, int reg)\r\n{\r\nu32 ret;\r\nswitch (reg) {\r\ncase SDHCI_CAPABILITIES:\r\nret = readl_relaxed(host->ioaddr + reg);\r\nret &= ~SDHCI_CAN_VDD_300;\r\nbreak;\r\ndefault:\r\nret = readl_relaxed(host->ioaddr + reg);\r\n}\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_probe(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host;\r\nstruct sdhci_pltfm_host *pltfm_host;\r\nstruct clk *clk;\r\nint ret = 0;\r\nu16 host_version;\r\nclk = devm_clk_get(&pdev->dev, "mmc");\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Peripheral clk not found\n");\r\nreturn PTR_ERR(clk);\r\n}\r\nhost = sdhci_pltfm_init(pdev, &sdhci_st_pdata, 0);\r\nif (IS_ERR(host)) {\r\ndev_err(&pdev->dev, "Failed sdhci_pltfm_init\n");\r\nreturn PTR_ERR(host);\r\n}\r\nret = mmc_of_parse(host->mmc);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed mmc_of_parse\n");\r\nreturn ret;\r\n}\r\nclk_prepare_enable(clk);\r\npltfm_host = sdhci_priv(host);\r\npltfm_host->clk = clk;\r\nret = sdhci_add_host(host);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed sdhci_add_host\n");\r\ngoto err_out;\r\n}\r\nplatform_set_drvdata(pdev, host);\r\nhost_version = readw_relaxed((host->ioaddr + SDHCI_HOST_VERSION));\r\ndev_info(&pdev->dev, "SDHCI ST Initialised: Host Version: 0x%x Vendor Version 0x%x\n",\r\n((host_version & SDHCI_SPEC_VER_MASK) >> SDHCI_SPEC_VER_SHIFT),\r\n((host_version & SDHCI_VENDOR_VER_MASK) >>\r\nSDHCI_VENDOR_VER_SHIFT));\r\nreturn 0;\r\nerr_out:\r\nclk_disable_unprepare(clk);\r\nsdhci_pltfm_free(pdev);\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_remove(struct platform_device *pdev)\r\n{\r\nstruct sdhci_host *host = platform_get_drvdata(pdev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nclk_disable_unprepare(pltfm_host->clk);\r\nreturn sdhci_pltfm_unregister(pdev);\r\n}\r\nstatic int sdhci_st_suspend(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nint ret = sdhci_suspend_host(host);\r\nif (ret)\r\ngoto out;\r\nclk_disable_unprepare(pltfm_host->clk);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int sdhci_st_resume(struct device *dev)\r\n{\r\nstruct sdhci_host *host = dev_get_drvdata(dev);\r\nstruct sdhci_pltfm_host *pltfm_host = sdhci_priv(host);\r\nclk_prepare_enable(pltfm_host->clk);\r\nreturn sdhci_resume_host(host);\r\n}

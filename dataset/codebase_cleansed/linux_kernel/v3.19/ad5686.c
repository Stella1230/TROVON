static int ad5686_spi_write(struct ad5686_state *st,\r\nu8 cmd, u8 addr, u16 val, u8 shift)\r\n{\r\nval <<= shift;\r\nst->data[0].d32 = cpu_to_be32(AD5686_CMD(cmd) |\r\nAD5686_ADDR(addr) |\r\nval);\r\nreturn spi_write(st->spi, &st->data[0].d8[1], 3);\r\n}\r\nstatic int ad5686_spi_read(struct ad5686_state *st, u8 addr)\r\n{\r\nstruct spi_transfer t[] = {\r\n{\r\n.tx_buf = &st->data[0].d8[1],\r\n.len = 3,\r\n.cs_change = 1,\r\n}, {\r\n.tx_buf = &st->data[1].d8[1],\r\n.rx_buf = &st->data[2].d8[1],\r\n.len = 3,\r\n},\r\n};\r\nint ret;\r\nst->data[0].d32 = cpu_to_be32(AD5686_CMD(AD5686_CMD_READBACK_ENABLE) |\r\nAD5686_ADDR(addr));\r\nst->data[1].d32 = cpu_to_be32(AD5686_CMD(AD5686_CMD_NOOP));\r\nret = spi_sync_transfer(st->spi, t, ARRAY_SIZE(t));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn be32_to_cpu(st->data[2].d32);\r\n}\r\nstatic int ad5686_get_powerdown_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\nreturn ((st->pwr_down_mode >> (chan->channel * 2)) & 0x3) - 1;\r\n}\r\nstatic int ad5686_set_powerdown_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int mode)\r\n{\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\nst->pwr_down_mode &= ~(0x3 << (chan->channel * 2));\r\nst->pwr_down_mode |= ((mode + 1) << (chan->channel * 2));\r\nreturn 0;\r\n}\r\nstatic ssize_t ad5686_read_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private, const struct iio_chan_spec *chan, char *buf)\r\n{\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\nreturn sprintf(buf, "%d\n", !!(st->pwr_down_mask &\r\n(0x3 << (chan->channel * 2))));\r\n}\r\nstatic ssize_t ad5686_write_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private, const struct iio_chan_spec *chan, const char *buf,\r\nsize_t len)\r\n{\r\nbool readin;\r\nint ret;\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\nret = strtobool(buf, &readin);\r\nif (ret)\r\nreturn ret;\r\nif (readin)\r\nst->pwr_down_mask |= (0x3 << (chan->channel * 2));\r\nelse\r\nst->pwr_down_mask &= ~(0x3 << (chan->channel * 2));\r\nret = ad5686_spi_write(st, AD5686_CMD_POWERDOWN_DAC, 0,\r\nst->pwr_down_mask & st->pwr_down_mode, 0);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ad5686_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong m)\r\n{\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\nint ret;\r\nswitch (m) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&indio_dev->mlock);\r\nret = ad5686_spi_read(st, chan->address);\r\nmutex_unlock(&indio_dev->mlock);\r\nif (ret < 0)\r\nreturn ret;\r\n*val = ret;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\n*val = st->vref_mv;\r\n*val2 = chan->scan_type.realbits;\r\nreturn IIO_VAL_FRACTIONAL_LOG2;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ad5686_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint val,\r\nint val2,\r\nlong mask)\r\n{\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\nint ret;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nif (val > (1 << chan->scan_type.realbits) || val < 0)\r\nreturn -EINVAL;\r\nmutex_lock(&indio_dev->mlock);\r\nret = ad5686_spi_write(st,\r\nAD5686_CMD_WRITE_INPUT_N_UPDATE_N,\r\nchan->address,\r\nval,\r\nchan->scan_type.shift);\r\nmutex_unlock(&indio_dev->mlock);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ad5686_probe(struct spi_device *spi)\r\n{\r\nstruct ad5686_state *st;\r\nstruct iio_dev *indio_dev;\r\nint ret, voltage_uv = 0;\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (indio_dev == NULL)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nst->reg = devm_regulator_get(&spi->dev, "vcc");\r\nif (!IS_ERR(st->reg)) {\r\nret = regulator_enable(st->reg);\r\nif (ret)\r\nreturn ret;\r\nret = regulator_get_voltage(st->reg);\r\nif (ret < 0)\r\ngoto error_disable_reg;\r\nvoltage_uv = ret;\r\n}\r\nst->chip_info =\r\n&ad5686_chip_info_tbl[spi_get_device_id(spi)->driver_data];\r\nif (voltage_uv)\r\nst->vref_mv = voltage_uv / 1000;\r\nelse\r\nst->vref_mv = st->chip_info->int_vref_mv;\r\nst->spi = spi;\r\nst->pwr_down_mode = 0x55;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->name = spi_get_device_id(spi)->name;\r\nindio_dev->info = &ad5686_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = st->chip_info->channel;\r\nindio_dev->num_channels = AD5686_DAC_CHANNELS;\r\nret = ad5686_spi_write(st, AD5686_CMD_INTERNAL_REFER_SETUP, 0,\r\n!!voltage_uv, 0);\r\nif (ret)\r\ngoto error_disable_reg;\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_disable_reg;\r\nreturn 0;\r\nerror_disable_reg:\r\nif (!IS_ERR(st->reg))\r\nregulator_disable(st->reg);\r\nreturn ret;\r\n}\r\nstatic int ad5686_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\nstruct ad5686_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nif (!IS_ERR(st->reg))\r\nregulator_disable(st->reg);\r\nreturn 0;\r\n}

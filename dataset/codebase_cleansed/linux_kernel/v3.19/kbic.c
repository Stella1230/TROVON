static int kbic_read_regr( PIA *pi, int cont, int regr )\r\n{ int a, b, s;\r\ns = cont_map[cont];\r\nswitch (pi->mode) {\r\ncase 0: w0(regr|0x18|s); w2(4); w2(6); w2(4); w2(1); w0(8);\r\na = r1(); w0(0x28); b = r1(); w2(4);\r\nreturn j44(a,b);\r\ncase 1: w0(regr|0x38|s); w2(4); w2(6); w2(4); w2(5); w0(8);\r\na = r12w(); w2(4);\r\nreturn j53(a);\r\ncase 2: w0(regr|0x08|s); w2(4); w2(6); w2(4); w2(0xa5); w2(0xa1);\r\na = r0(); w2(4);\r\nreturn a;\r\ncase 3:\r\ncase 4:\r\ncase 5: w0(0x20|s); w2(4); w2(6); w2(4); w3(regr);\r\na = r4(); b = r4(); w2(4); w2(0); w2(4);\r\nreturn a;\r\n}\r\nreturn -1;\r\n}\r\nstatic void kbic_write_regr( PIA *pi, int cont, int regr, int val)\r\n{ int s;\r\ns = cont_map[cont];\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1:\r\ncase 2: w0(regr|0x10|s); w2(4); w2(6); w2(4);\r\nw0(val); w2(5); w2(4);\r\nbreak;\r\ncase 3:\r\ncase 4:\r\ncase 5: w0(0x20|s); w2(4); w2(6); w2(4); w3(regr);\r\nw4(val); w4(val);\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void k951_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(4);\r\n}\r\nstatic void k951_disconnect ( PIA *pi )\r\n{ w0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic void k971_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nCCP(0x20);\r\nw2(4);\r\n}\r\nstatic void k971_disconnect ( PIA *pi )\r\n{ CCP(0x30);\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic void kbic_read_block( PIA *pi, char * buf, int count )\r\n{ int k, a, b;\r\nswitch (pi->mode) {\r\ncase 0: w0(0x98); w2(4); w2(6); w2(4);\r\nfor (k=0;k<count/2;k++) {\r\nw2(1); w0(8); a = r1();\r\nw0(0x28); b = r1();\r\nbuf[2*k] = j44(a,b);\r\nw2(5); b = r1();\r\nw0(8); a = r1();\r\nbuf[2*k+1] = j44(a,b);\r\nw2(4);\r\n}\r\nbreak;\r\ncase 1: w0(0xb8); w2(4); w2(6); w2(4);\r\nfor (k=0;k<count/4;k++) {\r\nw0(0xb8);\r\nw2(4); w2(5);\r\nw0(8); buf[4*k] = j53(r12w());\r\nw0(0xb8); buf[4*k+1] = j53(r12w());\r\nw2(4); w2(5);\r\nbuf[4*k+3] = j53(r12w());\r\nw0(8); buf[4*k+2] = j53(r12w());\r\n}\r\nw2(4);\r\nbreak;\r\ncase 2: w0(0x88); w2(4); w2(6); w2(4);\r\nfor (k=0;k<count/2;k++) {\r\nw2(0xa0); w2(0xa1); buf[2*k] = r0();\r\nw2(0xa5); buf[2*k+1] = r0();\r\n}\r\nw2(4);\r\nbreak;\r\ncase 3: w0(0xa0); w2(4); w2(6); w2(4); w3(0);\r\nfor (k=0;k<count;k++) buf[k] = r4();\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\ncase 4: w0(0xa0); w2(4); w2(6); w2(4); w3(0);\r\nfor (k=0;k<count/2;k++) ((u16 *)buf)[k] = r4w();\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\ncase 5: w0(0xa0); w2(4); w2(6); w2(4); w3(0);\r\nfor (k=0;k<count/4;k++) ((u32 *)buf)[k] = r4l();\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void kbic_write_block( PIA *pi, char * buf, int count )\r\n{ int k;\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1:\r\ncase 2: w0(0x90); w2(4); w2(6); w2(4);\r\nfor(k=0;k<count/2;k++) {\r\nw0(buf[2*k+1]); w2(0); w2(4);\r\nw0(buf[2*k]); w2(5); w2(4);\r\n}\r\nbreak;\r\ncase 3: w0(0xa0); w2(4); w2(6); w2(4); w3(0);\r\nfor(k=0;k<count/2;k++) {\r\nw4(buf[2*k+1]);\r\nw4(buf[2*k]);\r\n}\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\ncase 4: w0(0xa0); w2(4); w2(6); w2(4); w3(0);\r\nfor(k=0;k<count/2;k++) w4w(pi_swab16(buf,k));\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\ncase 5: w0(0xa0); w2(4); w2(6); w2(4); w3(0);\r\nfor(k=0;k<count/4;k++) w4l(pi_swab32(buf,k));\r\nw2(4); w2(0); w2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void kbic_log_adapter( PIA *pi, char * scratch,\r\nint verbose, char * chip )\r\n{ char *mode_string[6] = {"4-bit","5/3","8-bit",\r\n"EPP-8","EPP_16","EPP-32"};\r\nprintk("%s: kbic %s, KingByte %s at 0x%x, ",\r\npi->device,KBIC_VERSION,chip,pi->port);\r\nprintk("mode %d (%s), delay %d\n",pi->mode,\r\nmode_string[pi->mode],pi->delay);\r\n}\r\nstatic void k951_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ kbic_log_adapter(pi,scratch,verbose,"KBIC-951A");\r\n}\r\nstatic void k971_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ kbic_log_adapter(pi,scratch,verbose,"KBIC-971A");\r\n}\r\nstatic int __init kbic_init(void)\r\n{\r\nint rv;\r\nrv = paride_register(&k951);\r\nif (rv < 0)\r\nreturn rv;\r\nrv = paride_register(&k971);\r\nif (rv < 0)\r\nparide_unregister(&k951);\r\nreturn rv;\r\n}\r\nstatic void __exit kbic_exit(void)\r\n{\r\nparide_unregister(&k951);\r\nparide_unregister(&k971);\r\n}

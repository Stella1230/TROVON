void machine_restart(char *cmd)\r\n{\r\n#ifdef FASTBOOT_SELFTEST_SUPPORT\r\nif (ftc_bitmap) {\r\npdc_do_firm_test_reset(ftc_bitmap);\r\n}\r\n#endif\r\npdc_chassis_send_status(PDC_CHASSIS_DIRECT_SHUTDOWN);\r\npdc_do_reset();\r\ngsc_writel(CMD_RESET, COMMAND_GLOBAL);\r\nwhile (1) ;\r\n}\r\nvoid machine_halt(void)\r\n{\r\n}\r\nvoid machine_power_off(void)\r\n{\r\nif (chassis_power_off)\r\nchassis_power_off();\r\npdc_soft_power_button(0);\r\npdc_chassis_send_status(PDC_CHASSIS_DIRECT_SHUTDOWN);\r\nprintk(KERN_EMERG "System shut down completed.\n"\r\n"Please power this system off now.");\r\n}\r\nvoid exit_thread(void)\r\n{\r\n}\r\nvoid flush_thread(void)\r\n{\r\n}\r\nvoid release_thread(struct task_struct *dead_task)\r\n{\r\n}\r\nint dump_fpu (struct pt_regs * regs, elf_fpregset_t *r)\r\n{\r\nif (regs == NULL)\r\nreturn 0;\r\nmemcpy(r, regs->fr, sizeof *r);\r\nreturn 1;\r\n}\r\nint dump_task_fpu (struct task_struct *tsk, elf_fpregset_t *r)\r\n{\r\nmemcpy(r, tsk->thread.regs.fr, sizeof(*r));\r\nreturn 1;\r\n}\r\nint\r\ncopy_thread(unsigned long clone_flags, unsigned long usp,\r\nunsigned long arg, struct task_struct *p)\r\n{\r\nstruct pt_regs *cregs = &(p->thread.regs);\r\nvoid *stack = task_stack_page(p);\r\nextern void * const ret_from_kernel_thread;\r\nextern void * const child_return;\r\n#ifdef CONFIG_HPUX\r\nextern void * const hpux_child_return;\r\n#endif\r\nif (unlikely(p->flags & PF_KTHREAD)) {\r\nmemset(cregs, 0, sizeof(struct pt_regs));\r\nif (!usp)\r\nreturn 0;\r\ncregs->ksp = (unsigned long)stack + THREAD_SZ_ALGN + FRAME_SIZE;\r\ncregs->kpc = (unsigned long) &ret_from_kernel_thread;\r\n#ifdef CONFIG_64BIT\r\ncregs->gr[27] = ((unsigned long *)usp)[3];\r\ncregs->gr[26] = ((unsigned long *)usp)[2];\r\n#else\r\ncregs->gr[26] = usp;\r\n#endif\r\ncregs->gr[25] = arg;\r\n} else {\r\nif (usp) {\r\nusp = ALIGN(usp, 4);\r\nif (likely(usp))\r\ncregs->gr[30] = usp;\r\n}\r\ncregs->ksp = (unsigned long)stack + THREAD_SZ_ALGN + FRAME_SIZE;\r\nif (personality(p->personality) == PER_HPUX) {\r\n#ifdef CONFIG_HPUX\r\ncregs->kpc = (unsigned long) &hpux_child_return;\r\n#else\r\nBUG();\r\n#endif\r\n} else {\r\ncregs->kpc = (unsigned long) &child_return;\r\n}\r\nif (clone_flags & CLONE_SETTLS)\r\ncregs->cr27 = cregs->gr[23];\r\n}\r\nreturn 0;\r\n}\r\nunsigned long thread_saved_pc(struct task_struct *t)\r\n{\r\nreturn t->thread.regs.kpc;\r\n}\r\nunsigned long\r\nget_wchan(struct task_struct *p)\r\n{\r\nstruct unwind_frame_info info;\r\nunsigned long ip;\r\nint count = 0;\r\nif (!p || p == current || p->state == TASK_RUNNING)\r\nreturn 0;\r\nunwind_frame_init_from_blocked_task(&info, p);\r\ndo {\r\nif (unwind_once(&info) < 0)\r\nreturn 0;\r\nip = info.ip;\r\nif (!in_sched_functions(ip))\r\nreturn ip;\r\n} while (count++ < 16);\r\nreturn 0;\r\n}\r\nvoid *dereference_function_descriptor(void *ptr)\r\n{\r\nElf64_Fdesc *desc = ptr;\r\nvoid *p;\r\nif (!probe_kernel_address(&desc->addr, p))\r\nptr = p;\r\nreturn ptr;\r\n}\r\nstatic inline unsigned long brk_rnd(void)\r\n{\r\nif (is_32bit_task())\r\nreturn (get_random_int() & 0x7ffUL) << PAGE_SHIFT;\r\nelse\r\nreturn (get_random_int() & 0x3ffffUL) << PAGE_SHIFT;\r\n}\r\nunsigned long arch_randomize_brk(struct mm_struct *mm)\r\n{\r\nunsigned long ret = PAGE_ALIGN(mm->brk + brk_rnd());\r\nif (ret < mm->brk)\r\nreturn mm->brk;\r\nreturn ret;\r\n}

static void bcma_core_pcie2_cfg_write(struct bcma_drv_pcie2 *pcie2, u32 addr,\r\nu32 val)\r\n{\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, addr);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, val);\r\n}\r\nstatic u32 bcma_core_pcie2_war_delay_perst_enab(struct bcma_drv_pcie2 *pcie2,\r\nbool enable)\r\n{\r\nu32 val;\r\nval = pcie2_read32(pcie2, BCMA_CORE_PCIE2_CLK_CONTROL);\r\nval |= PCIE2_CLKC_DLYPERST;\r\nval &= ~PCIE2_CLKC_DISSPROMLD;\r\nif (enable) {\r\nval &= ~PCIE2_CLKC_DLYPERST;\r\nval |= PCIE2_CLKC_DISSPROMLD;\r\n}\r\npcie2_write32(pcie2, (BCMA_CORE_PCIE2_CLK_CONTROL), val);\r\nreturn pcie2_read32(pcie2, BCMA_CORE_PCIE2_CLK_CONTROL);\r\n}\r\nstatic void bcma_core_pcie2_set_ltr_vals(struct bcma_drv_pcie2 *pcie2)\r\n{\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, 0x844);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x883c883c);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, 0x848);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x88648864);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, 0x84C);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x90039003);\r\n}\r\nstatic void bcma_core_pcie2_hw_ltr_war(struct bcma_drv_pcie2 *pcie2)\r\n{\r\nu8 core_rev = pcie2->core->id.rev;\r\nu32 devstsctr2;\r\nif (core_rev < 2 || core_rev == 10 || core_rev > 13)\r\nreturn;\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\r\nPCIE2_CAP_DEVSTSCTRL2_OFFSET);\r\ndevstsctr2 = pcie2_read32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA);\r\nif (devstsctr2 & PCIE2_CAP_DEVSTSCTRL2_LTRENAB) {\r\nbcma_core_pcie2_set_ltr_vals(pcie2);\r\ndevstsctr2 |= PCIE2_CAP_DEVSTSCTRL2_LTRENAB;\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\r\nPCIE2_CAP_DEVSTSCTRL2_OFFSET);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, devstsctr2);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_LTR_STATE,\r\nPCIE2_LTR_ACTIVE);\r\nusleep_range(1000, 2000);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_LTR_STATE,\r\nPCIE2_LTR_SLEEP);\r\nusleep_range(1000, 2000);\r\n}\r\n}\r\nstatic void pciedev_crwlpciegen2(struct bcma_drv_pcie2 *pcie2)\r\n{\r\nu8 core_rev = pcie2->core->id.rev;\r\nbool pciewar160, pciewar162;\r\npciewar160 = core_rev == 7 || core_rev == 9 || core_rev == 11;\r\npciewar162 = core_rev == 5 || core_rev == 7 || core_rev == 8 ||\r\ncore_rev == 9 || core_rev == 11;\r\nif (!pciewar160 && !pciewar162)\r\nreturn;\r\n#if 0\r\npcie2_set32(pcie2, BCMA_CORE_PCIE2_CLK_CONTROL,\r\nPCIE_DISABLE_L1CLK_GATING);\r\n#if 0\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\r\nPCIEGEN2_COE_PVT_TL_CTRL_0);\r\npcie2_mask32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA,\r\n~(1 << COE_PVT_TL_CTRL_0_PM_DIS_L1_REENTRY_BIT));\r\n#endif\r\n#endif\r\n}\r\nstatic void pciedev_crwlpciegen2_180(struct bcma_drv_pcie2 *pcie2)\r\n{\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, PCIE2_PMCR_REFUP);\r\npcie2_set32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 0x1f);\r\n}\r\nstatic void pciedev_crwlpciegen2_182(struct bcma_drv_pcie2 *pcie2)\r\n{\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR, PCIE2_SBMBX);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, 1 << 0);\r\n}\r\nstatic void pciedev_reg_pm_clk_period(struct bcma_drv_pcie2 *pcie2)\r\n{\r\nstruct bcma_drv_cc *drv_cc = &pcie2->core->bus->drv_cc;\r\nu8 core_rev = pcie2->core->id.rev;\r\nu32 alp_khz, pm_value;\r\nif (core_rev <= 13) {\r\nalp_khz = bcma_pmu_get_alp_clock(drv_cc) / 1000;\r\npm_value = (1000000 * 2) / alp_khz;\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDADDR,\r\nPCIE2_PVT_REG_PM_CLK_PERIOD);\r\npcie2_write32(pcie2, BCMA_CORE_PCIE2_CONFIGINDDATA, pm_value);\r\n}\r\n}\r\nvoid bcma_core_pcie2_init(struct bcma_drv_pcie2 *pcie2)\r\n{\r\nstruct bcma_chipinfo *ci = &pcie2->core->bus->chipinfo;\r\nu32 tmp;\r\ntmp = pcie2_read32(pcie2, BCMA_CORE_PCIE2_SPROM(54));\r\nif ((tmp & 0xe) >> 1 == 2)\r\nbcma_core_pcie2_cfg_write(pcie2, 0x4e0, 0x17);\r\nif (ci->id == BCMA_CHIP_ID_BCM4360 && ci->rev > 3)\r\nbcma_core_pcie2_war_delay_perst_enab(pcie2, true);\r\nbcma_core_pcie2_hw_ltr_war(pcie2);\r\npciedev_crwlpciegen2(pcie2);\r\npciedev_reg_pm_clk_period(pcie2);\r\npciedev_crwlpciegen2_180(pcie2);\r\npciedev_crwlpciegen2_182(pcie2);\r\n}

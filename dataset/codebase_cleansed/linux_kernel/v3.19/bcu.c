unsigned long vr41xx_get_vtclock_frequency(void)\r\n{\r\nreturn vr41xx_vtclock;\r\n}\r\nunsigned long vr41xx_get_tclock_frequency(void)\r\n{\r\nreturn vr41xx_tclock;\r\n}\r\nstatic inline uint16_t read_clkspeed(void)\r\n{\r\nswitch (current_cpu_type()) {\r\ncase CPU_VR4111:\r\ncase CPU_VR4121: return readw(CLKSPEEDREG_TYPE1);\r\ncase CPU_VR4122:\r\ncase CPU_VR4131:\r\ncase CPU_VR4133: return readw(CLKSPEEDREG_TYPE2);\r\ndefault:\r\nprintk(KERN_INFO "Unexpected CPU of NEC VR4100 series\n");\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline unsigned long calculate_pclock(uint16_t clkspeed)\r\n{\r\nunsigned long pclock = 0;\r\nswitch (current_cpu_type()) {\r\ncase CPU_VR4111:\r\ncase CPU_VR4121:\r\npclock = 18432000 * 64;\r\npclock /= CLKSP(clkspeed);\r\nbreak;\r\ncase CPU_VR4122:\r\npclock = 18432000 * 98;\r\npclock /= CLKSP(clkspeed);\r\nbreak;\r\ncase CPU_VR4131:\r\npclock = 18432000 * 108;\r\npclock /= CLKSP(clkspeed);\r\nbreak;\r\ncase CPU_VR4133:\r\nswitch (CLKSP_VR4133(clkspeed)) {\r\ncase 0:\r\npclock = 133000000;\r\nbreak;\r\ncase 1:\r\npclock = 149000000;\r\nbreak;\r\ncase 2:\r\npclock = 165900000;\r\nbreak;\r\ncase 3:\r\npclock = 199100000;\r\nbreak;\r\ncase 4:\r\npclock = 265900000;\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unknown PClock speed for NEC VR4133\n");\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unexpected CPU of NEC VR4100 series\n");\r\nbreak;\r\n}\r\nprintk(KERN_INFO "PClock: %ldHz\n", pclock);\r\nreturn pclock;\r\n}\r\nstatic inline unsigned long calculate_vtclock(uint16_t clkspeed, unsigned long pclock)\r\n{\r\nunsigned long vtclock = 0;\r\nswitch (current_cpu_type()) {\r\ncase CPU_VR4111:\r\nbreak;\r\ncase CPU_VR4121:\r\nvtclock = pclock;\r\nif (DIVVT(clkspeed) == 9)\r\nvtclock = pclock * 6;\r\nelse if (DIVVT(clkspeed) == 10)\r\nvtclock = pclock * 4;\r\nvtclock /= DIVVT(clkspeed);\r\nprintk(KERN_INFO "VTClock: %ldHz\n", vtclock);\r\nbreak;\r\ncase CPU_VR4122:\r\nif(VTDIVMODE(clkspeed) == 7)\r\nvtclock = pclock / 1;\r\nelse if(VTDIVMODE(clkspeed) == 1)\r\nvtclock = pclock / 2;\r\nelse\r\nvtclock = pclock / VTDIVMODE(clkspeed);\r\nprintk(KERN_INFO "VTClock: %ldHz\n", vtclock);\r\nbreak;\r\ncase CPU_VR4131:\r\ncase CPU_VR4133:\r\nvtclock = pclock / VTDIVMODE(clkspeed);\r\nprintk(KERN_INFO "VTClock: %ldHz\n", vtclock);\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unexpected CPU of NEC VR4100 series\n");\r\nbreak;\r\n}\r\nreturn vtclock;\r\n}\r\nstatic inline unsigned long calculate_tclock(uint16_t clkspeed, unsigned long pclock,\r\nunsigned long vtclock)\r\n{\r\nunsigned long tclock = 0;\r\nswitch (current_cpu_type()) {\r\ncase CPU_VR4111:\r\nif (!(clkspeed & DIV2B))\r\ntclock = pclock / 2;\r\nelse if (!(clkspeed & DIV3B))\r\ntclock = pclock / 3;\r\nelse if (!(clkspeed & DIV4B))\r\ntclock = pclock / 4;\r\nbreak;\r\ncase CPU_VR4121:\r\ntclock = pclock / DIVT(clkspeed);\r\nbreak;\r\ncase CPU_VR4122:\r\ncase CPU_VR4131:\r\ncase CPU_VR4133:\r\ntclock = vtclock / TDIVMODE(clkspeed);\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unexpected CPU of NEC VR4100 series\n");\r\nbreak;\r\n}\r\nprintk(KERN_INFO "TClock: %ldHz\n", tclock);\r\nreturn tclock;\r\n}\r\nvoid vr41xx_calculate_clock_frequency(void)\r\n{\r\nunsigned long pclock;\r\nuint16_t clkspeed;\r\nclkspeed = read_clkspeed();\r\npclock = calculate_pclock(clkspeed);\r\nvr41xx_vtclock = calculate_vtclock(clkspeed, pclock);\r\nvr41xx_tclock = calculate_tclock(clkspeed, pclock, vr41xx_vtclock);\r\n}

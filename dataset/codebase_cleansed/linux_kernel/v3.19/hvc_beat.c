static int hvc_beat_get_chars(uint32_t vtermno, char *buf, int cnt)\r\n{\r\nstatic unsigned char q[sizeof(unsigned long) * 2]\r\n__attribute__((aligned(sizeof(unsigned long))));\r\nstatic int qlen = 0;\r\nu64 got;\r\nagain:\r\nif (qlen) {\r\nif (qlen > cnt) {\r\nmemcpy(buf, q, cnt);\r\nqlen -= cnt;\r\nmemmove(q + cnt, q, qlen);\r\nreturn cnt;\r\n} else {\r\nint r;\r\nmemcpy(buf, q, qlen);\r\nr = qlen;\r\nqlen = 0;\r\nreturn r;\r\n}\r\n}\r\nif (beat_get_term_char(vtermno, &got,\r\n((u64 *)q), ((u64 *)q) + 1) == 0) {\r\nqlen = got;\r\ngoto again;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hvc_beat_put_chars(uint32_t vtermno, const char *buf, int cnt)\r\n{\r\nunsigned long kb[2];\r\nint rest, nlen;\r\nfor (rest = cnt; rest > 0; rest -= nlen) {\r\nnlen = (rest > 16) ? 16 : rest;\r\nmemcpy(kb, buf, nlen);\r\nbeat_put_term_char(vtermno, nlen, kb[0], kb[1]);\r\nbuf += nlen;\r\n}\r\nreturn cnt;\r\n}\r\nstatic int hvc_beat_config(char *p)\r\n{\r\nhvc_beat_useit = simple_strtoul(p, NULL, 0);\r\nreturn 0;\r\n}\r\nstatic int __init hvc_beat_console_init(void)\r\n{\r\nif (hvc_beat_useit && of_machine_is_compatible("Beat")) {\r\nhvc_instantiate(0, 0, &hvc_beat_get_put_ops);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init hvc_beat_init(void)\r\n{\r\nstruct hvc_struct *hp;\r\nif (!firmware_has_feature(FW_FEATURE_BEAT))\r\nreturn -ENODEV;\r\nhp = hvc_alloc(0, 0, &hvc_beat_get_put_ops, 16);\r\nif (IS_ERR(hp))\r\nreturn PTR_ERR(hp);\r\nhvc_beat_dev = hp;\r\nreturn 0;\r\n}\r\nstatic void __exit hvc_beat_exit(void)\r\n{\r\nif (hvc_beat_dev)\r\nhvc_remove(hvc_beat_dev);\r\n}

struct bcom_task *\r\nbcom_fec_rx_init(int queue_len, phys_addr_t fifo, int maxbufsize)\r\n{\r\nstruct bcom_task *tsk;\r\nstruct bcom_fec_priv *priv;\r\ntsk = bcom_task_alloc(queue_len, sizeof(struct bcom_fec_bd),\r\nsizeof(struct bcom_fec_priv));\r\nif (!tsk)\r\nreturn NULL;\r\ntsk->flags = BCOM_FLAGS_NONE;\r\npriv = tsk->priv;\r\npriv->fifo = fifo;\r\npriv->maxbufsize = maxbufsize;\r\nif (bcom_fec_rx_reset(tsk)) {\r\nbcom_task_free(tsk);\r\nreturn NULL;\r\n}\r\nreturn tsk;\r\n}\r\nint\r\nbcom_fec_rx_reset(struct bcom_task *tsk)\r\n{\r\nstruct bcom_fec_priv *priv = tsk->priv;\r\nstruct bcom_fec_rx_var *var;\r\nstruct bcom_fec_rx_inc *inc;\r\nbcom_disable_task(tsk->tasknum);\r\nvar = (struct bcom_fec_rx_var *) bcom_task_var(tsk->tasknum);\r\ninc = (struct bcom_fec_rx_inc *) bcom_task_inc(tsk->tasknum);\r\nif (bcom_load_image(tsk->tasknum, bcom_fec_rx_task))\r\nreturn -1;\r\nvar->enable = bcom_eng->regs_base +\r\noffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\r\nvar->fifo = (u32) priv->fifo;\r\nvar->bd_base = tsk->bd_pa;\r\nvar->bd_last = tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\r\nvar->bd_start = tsk->bd_pa;\r\nvar->buffer_size = priv->maxbufsize;\r\ninc->incr_bytes = -(s16)sizeof(u32);\r\ninc->incr_dst = sizeof(u32);\r\ninc->incr_dst_ma= sizeof(u8);\r\ntsk->index = 0;\r\ntsk->outdex = 0;\r\nmemset(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\r\nbcom_set_task_pragma(tsk->tasknum, BCOM_FEC_RX_BD_PRAGMA);\r\nbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\r\nout_8(&bcom_eng->regs->ipr[BCOM_INITIATOR_FEC_RX], BCOM_IPR_FEC_RX);\r\nout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\r\nreturn 0;\r\n}\r\nvoid\r\nbcom_fec_rx_release(struct bcom_task *tsk)\r\n{\r\nbcom_task_free(tsk);\r\n}\r\nstatic u32 *self_modified_drd(int tasknum)\r\n{\r\nu32 *desc;\r\nint num_descs;\r\nint drd_count;\r\nint i;\r\nnum_descs = bcom_task_num_descs(tasknum);\r\ndesc = bcom_task_desc(tasknum) + num_descs - 1;\r\ndrd_count = 0;\r\nfor (i=0; i<num_descs; i++, desc--)\r\nif (bcom_desc_is_drd(*desc) && ++drd_count == 3)\r\nbreak;\r\nreturn desc;\r\n}\r\nstruct bcom_task *\r\nbcom_fec_tx_init(int queue_len, phys_addr_t fifo)\r\n{\r\nstruct bcom_task *tsk;\r\nstruct bcom_fec_priv *priv;\r\ntsk = bcom_task_alloc(queue_len, sizeof(struct bcom_fec_bd),\r\nsizeof(struct bcom_fec_priv));\r\nif (!tsk)\r\nreturn NULL;\r\ntsk->flags = BCOM_FLAGS_ENABLE_TASK;\r\npriv = tsk->priv;\r\npriv->fifo = fifo;\r\nif (bcom_fec_tx_reset(tsk)) {\r\nbcom_task_free(tsk);\r\nreturn NULL;\r\n}\r\nreturn tsk;\r\n}\r\nint\r\nbcom_fec_tx_reset(struct bcom_task *tsk)\r\n{\r\nstruct bcom_fec_priv *priv = tsk->priv;\r\nstruct bcom_fec_tx_var *var;\r\nstruct bcom_fec_tx_inc *inc;\r\nbcom_disable_task(tsk->tasknum);\r\nvar = (struct bcom_fec_tx_var *) bcom_task_var(tsk->tasknum);\r\ninc = (struct bcom_fec_tx_inc *) bcom_task_inc(tsk->tasknum);\r\nif (bcom_load_image(tsk->tasknum, bcom_fec_tx_task))\r\nreturn -1;\r\nvar->enable = bcom_eng->regs_base +\r\noffsetof(struct mpc52xx_sdma, tcr[tsk->tasknum]);\r\nvar->fifo = (u32) priv->fifo;\r\nvar->DRD = bcom_sram_va2pa(self_modified_drd(tsk->tasknum));\r\nvar->bd_base = tsk->bd_pa;\r\nvar->bd_last = tsk->bd_pa + ((tsk->num_bd-1) * tsk->bd_size);\r\nvar->bd_start = tsk->bd_pa;\r\ninc->incr_bytes = -(s16)sizeof(u32);\r\ninc->incr_src = sizeof(u32);\r\ninc->incr_src_ma= sizeof(u8);\r\ntsk->index = 0;\r\ntsk->outdex = 0;\r\nmemset(tsk->bd, 0x00, tsk->num_bd * tsk->bd_size);\r\nbcom_set_task_pragma(tsk->tasknum, BCOM_FEC_TX_BD_PRAGMA);\r\nbcom_set_task_auto_start(tsk->tasknum, tsk->tasknum);\r\nout_8(&bcom_eng->regs->ipr[BCOM_INITIATOR_FEC_TX], BCOM_IPR_FEC_TX);\r\nout_be32(&bcom_eng->regs->IntPend, 1<<tsk->tasknum);\r\nreturn 0;\r\n}\r\nvoid\r\nbcom_fec_tx_release(struct bcom_task *tsk)\r\n{\r\nbcom_task_free(tsk);\r\n}

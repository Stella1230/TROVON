static struct mdp4_kms *get_kms(struct drm_encoder *encoder)\r\n{\r\nstruct msm_drm_private *priv = encoder->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic void bs_init(struct mdp4_dtv_encoder *mdp4_dtv_encoder)\r\n{\r\nstruct drm_device *dev = mdp4_dtv_encoder->base.dev;\r\nstruct lcdc_platform_data *dtv_pdata = mdp4_find_pdata("dtv.0");\r\nif (!dtv_pdata) {\r\ndev_err(dev->dev, "could not find dtv pdata\n");\r\nreturn;\r\n}\r\nif (dtv_pdata->bus_scale_table) {\r\nmdp4_dtv_encoder->bsc = msm_bus_scale_register_client(\r\ndtv_pdata->bus_scale_table);\r\nDBG("bus scale client: %08x", mdp4_dtv_encoder->bsc);\r\nDBG("lcdc_power_save: %p", dtv_pdata->lcdc_power_save);\r\nif (dtv_pdata->lcdc_power_save)\r\ndtv_pdata->lcdc_power_save(1);\r\n}\r\n}\r\nstatic void bs_fini(struct mdp4_dtv_encoder *mdp4_dtv_encoder)\r\n{\r\nif (mdp4_dtv_encoder->bsc) {\r\nmsm_bus_scale_unregister_client(mdp4_dtv_encoder->bsc);\r\nmdp4_dtv_encoder->bsc = 0;\r\n}\r\n}\r\nstatic void bs_set(struct mdp4_dtv_encoder *mdp4_dtv_encoder, int idx)\r\n{\r\nif (mdp4_dtv_encoder->bsc) {\r\nDBG("set bus scaling: %d", idx);\r\nmsm_bus_scale_client_update_request(mdp4_dtv_encoder->bsc, idx);\r\n}\r\n}\r\nstatic void bs_init(struct mdp4_dtv_encoder *mdp4_dtv_encoder) {}\r\nstatic void bs_fini(struct mdp4_dtv_encoder *mdp4_dtv_encoder) {}\r\nstatic void bs_set(struct mdp4_dtv_encoder *mdp4_dtv_encoder, int idx) {}\r\nstatic void mdp4_dtv_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct mdp4_dtv_encoder *mdp4_dtv_encoder = to_mdp4_dtv_encoder(encoder);\r\nbs_fini(mdp4_dtv_encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(mdp4_dtv_encoder);\r\n}\r\nstatic void mdp4_dtv_encoder_dpms(struct drm_encoder *encoder, int mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct mdp4_dtv_encoder *mdp4_dtv_encoder = to_mdp4_dtv_encoder(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nbool enabled = (mode == DRM_MODE_DPMS_ON);\r\nDBG("mode=%d", mode);\r\nif (enabled == mdp4_dtv_encoder->enabled)\r\nreturn;\r\nif (enabled) {\r\nunsigned long pc = mdp4_dtv_encoder->pixclock;\r\nint ret;\r\nbs_set(mdp4_dtv_encoder, 1);\r\nDBG("setting src_clk=%lu", pc);\r\nret = clk_set_rate(mdp4_dtv_encoder->src_clk, pc);\r\nif (ret)\r\ndev_err(dev->dev, "failed to set src_clk to %lu: %d\n", pc, ret);\r\nclk_prepare_enable(mdp4_dtv_encoder->src_clk);\r\nret = clk_prepare_enable(mdp4_dtv_encoder->hdmi_clk);\r\nif (ret)\r\ndev_err(dev->dev, "failed to enable hdmi_clk: %d\n", ret);\r\nret = clk_prepare_enable(mdp4_dtv_encoder->mdp_clk);\r\nif (ret)\r\ndev_err(dev->dev, "failed to enabled mdp_clk: %d\n", ret);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_ENABLE, 1);\r\n} else {\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_ENABLE, 0);\r\nmdp_irq_wait(&mdp4_kms->base, MDP4_IRQ_EXTERNAL_VSYNC);\r\nclk_disable_unprepare(mdp4_dtv_encoder->src_clk);\r\nclk_disable_unprepare(mdp4_dtv_encoder->hdmi_clk);\r\nclk_disable_unprepare(mdp4_dtv_encoder->mdp_clk);\r\nbs_set(mdp4_dtv_encoder, 0);\r\n}\r\nmdp4_dtv_encoder->enabled = enabled;\r\n}\r\nstatic bool mdp4_dtv_encoder_mode_fixup(struct drm_encoder *encoder,\r\nconst struct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nreturn true;\r\n}\r\nstatic void mdp4_dtv_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct mdp4_dtv_encoder *mdp4_dtv_encoder = to_mdp4_dtv_encoder(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nuint32_t dtv_hsync_skew, vsync_period, vsync_len, ctrl_pol;\r\nuint32_t display_v_start, display_v_end;\r\nuint32_t hsync_start_x, hsync_end_x;\r\nmode = adjusted_mode;\r\nDBG("set mode: %d:\"%s\" %d %d %d %d %d %d %d %d %d %d 0x%x 0x%x",\r\nmode->base.id, mode->name,\r\nmode->vrefresh, mode->clock,\r\nmode->hdisplay, mode->hsync_start,\r\nmode->hsync_end, mode->htotal,\r\nmode->vdisplay, mode->vsync_start,\r\nmode->vsync_end, mode->vtotal,\r\nmode->type, mode->flags);\r\nmdp4_dtv_encoder->pixclock = mode->clock * 1000;\r\nDBG("pixclock=%lu", mdp4_dtv_encoder->pixclock);\r\nctrl_pol = 0;\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\nctrl_pol |= MDP4_DTV_CTRL_POLARITY_HSYNC_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\nctrl_pol |= MDP4_DTV_CTRL_POLARITY_VSYNC_LOW;\r\ndtv_hsync_skew = 0;\r\nhsync_start_x = (mode->htotal - mode->hsync_start);\r\nhsync_end_x = mode->htotal - (mode->hsync_start - mode->hdisplay) - 1;\r\nvsync_period = mode->vtotal * mode->htotal;\r\nvsync_len = (mode->vsync_end - mode->vsync_start) * mode->htotal;\r\ndisplay_v_start = (mode->vtotal - mode->vsync_start) * mode->htotal + dtv_hsync_skew;\r\ndisplay_v_end = vsync_period - ((mode->vsync_start - mode->vdisplay) * mode->htotal) + dtv_hsync_skew - 1;\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_HSYNC_CTRL,\r\nMDP4_DTV_HSYNC_CTRL_PULSEW(mode->hsync_end - mode->hsync_start) |\r\nMDP4_DTV_HSYNC_CTRL_PERIOD(mode->htotal));\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_VSYNC_PERIOD, vsync_period);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_VSYNC_LEN, vsync_len);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_DISPLAY_HCTRL,\r\nMDP4_DTV_DISPLAY_HCTRL_START(hsync_start_x) |\r\nMDP4_DTV_DISPLAY_HCTRL_END(hsync_end_x));\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_DISPLAY_VSTART, display_v_start);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_DISPLAY_VEND, display_v_end);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_BORDER_CLR, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_UNDERFLOW_CLR,\r\nMDP4_DTV_UNDERFLOW_CLR_ENABLE_RECOVERY |\r\nMDP4_DTV_UNDERFLOW_CLR_COLOR(0xff));\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_HSYNC_SKEW, dtv_hsync_skew);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_CTRL_POLARITY, ctrl_pol);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_ACTIVE_HCTL,\r\nMDP4_DTV_ACTIVE_HCTL_START(0) |\r\nMDP4_DTV_ACTIVE_HCTL_END(0));\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_ACTIVE_VSTART, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_DTV_ACTIVE_VEND, 0);\r\n}\r\nstatic void mdp4_dtv_encoder_prepare(struct drm_encoder *encoder)\r\n{\r\nmdp4_dtv_encoder_dpms(encoder, DRM_MODE_DPMS_OFF);\r\n}\r\nstatic void mdp4_dtv_encoder_commit(struct drm_encoder *encoder)\r\n{\r\nmdp4_crtc_set_config(encoder->crtc,\r\nMDP4_DMA_CONFIG_R_BPC(BPC8) |\r\nMDP4_DMA_CONFIG_G_BPC(BPC8) |\r\nMDP4_DMA_CONFIG_B_BPC(BPC8) |\r\nMDP4_DMA_CONFIG_PACK(0x21));\r\nmdp4_crtc_set_intf(encoder->crtc, INTF_LCDC_DTV, 1);\r\nmdp4_dtv_encoder_dpms(encoder, DRM_MODE_DPMS_ON);\r\n}\r\nlong mdp4_dtv_round_pixclk(struct drm_encoder *encoder, unsigned long rate)\r\n{\r\nstruct mdp4_dtv_encoder *mdp4_dtv_encoder = to_mdp4_dtv_encoder(encoder);\r\nreturn clk_round_rate(mdp4_dtv_encoder->src_clk, rate);\r\n}\r\nstruct drm_encoder *mdp4_dtv_encoder_init(struct drm_device *dev)\r\n{\r\nstruct drm_encoder *encoder = NULL;\r\nstruct mdp4_dtv_encoder *mdp4_dtv_encoder;\r\nint ret;\r\nmdp4_dtv_encoder = kzalloc(sizeof(*mdp4_dtv_encoder), GFP_KERNEL);\r\nif (!mdp4_dtv_encoder) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nencoder = &mdp4_dtv_encoder->base;\r\ndrm_encoder_init(dev, encoder, &mdp4_dtv_encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS);\r\ndrm_encoder_helper_add(encoder, &mdp4_dtv_encoder_helper_funcs);\r\nmdp4_dtv_encoder->src_clk = devm_clk_get(dev->dev, "src_clk");\r\nif (IS_ERR(mdp4_dtv_encoder->src_clk)) {\r\ndev_err(dev->dev, "failed to get src_clk\n");\r\nret = PTR_ERR(mdp4_dtv_encoder->src_clk);\r\ngoto fail;\r\n}\r\nmdp4_dtv_encoder->hdmi_clk = devm_clk_get(dev->dev, "hdmi_clk");\r\nif (IS_ERR(mdp4_dtv_encoder->hdmi_clk)) {\r\ndev_err(dev->dev, "failed to get hdmi_clk\n");\r\nret = PTR_ERR(mdp4_dtv_encoder->hdmi_clk);\r\ngoto fail;\r\n}\r\nmdp4_dtv_encoder->mdp_clk = devm_clk_get(dev->dev, "mdp_clk");\r\nif (IS_ERR(mdp4_dtv_encoder->mdp_clk)) {\r\ndev_err(dev->dev, "failed to get mdp_clk\n");\r\nret = PTR_ERR(mdp4_dtv_encoder->mdp_clk);\r\ngoto fail;\r\n}\r\nbs_init(mdp4_dtv_encoder);\r\nreturn encoder;\r\nfail:\r\nif (encoder)\r\nmdp4_dtv_encoder_destroy(encoder);\r\nreturn ERR_PTR(ret);\r\n}

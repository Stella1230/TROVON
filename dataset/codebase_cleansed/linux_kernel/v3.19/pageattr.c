static int change_page_range(pte_t *ptep, pgtable_t token, unsigned long addr,\r\nvoid *data)\r\n{\r\nstruct page_change_data *cdata = data;\r\npte_t pte = *ptep;\r\npte = clear_pte_bit(pte, cdata->clear_mask);\r\npte = set_pte_bit(pte, cdata->set_mask);\r\nset_pte(ptep, pte);\r\nreturn 0;\r\n}\r\nstatic int change_memory_common(unsigned long addr, int numpages,\r\npgprot_t set_mask, pgprot_t clear_mask)\r\n{\r\nunsigned long start = addr;\r\nunsigned long size = PAGE_SIZE*numpages;\r\nunsigned long end = start + size;\r\nint ret;\r\nstruct page_change_data data;\r\nif (!IS_ALIGNED(addr, PAGE_SIZE)) {\r\nstart &= PAGE_MASK;\r\nend = start + size;\r\nWARN_ON_ONCE(1);\r\n}\r\nif (!is_module_address(start) || !is_module_address(end - 1))\r\nreturn -EINVAL;\r\ndata.set_mask = set_mask;\r\ndata.clear_mask = clear_mask;\r\nret = apply_to_page_range(&init_mm, start, size, change_page_range,\r\n&data);\r\nflush_tlb_kernel_range(start, end);\r\nreturn ret;\r\n}\r\nint set_memory_ro(unsigned long addr, int numpages)\r\n{\r\nreturn change_memory_common(addr, numpages,\r\n__pgprot(PTE_RDONLY),\r\n__pgprot(PTE_WRITE));\r\n}\r\nint set_memory_rw(unsigned long addr, int numpages)\r\n{\r\nreturn change_memory_common(addr, numpages,\r\n__pgprot(PTE_WRITE),\r\n__pgprot(PTE_RDONLY));\r\n}\r\nint set_memory_nx(unsigned long addr, int numpages)\r\n{\r\nreturn change_memory_common(addr, numpages,\r\n__pgprot(PTE_PXN),\r\n__pgprot(0));\r\n}\r\nint set_memory_x(unsigned long addr, int numpages)\r\n{\r\nreturn change_memory_common(addr, numpages,\r\n__pgprot(0),\r\n__pgprot(PTE_PXN));\r\n}

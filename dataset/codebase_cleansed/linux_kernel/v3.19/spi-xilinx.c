static void xspi_write32(u32 val, void __iomem *addr)\r\n{\r\niowrite32(val, addr);\r\n}\r\nstatic unsigned int xspi_read32(void __iomem *addr)\r\n{\r\nreturn ioread32(addr);\r\n}\r\nstatic void xspi_write32_be(u32 val, void __iomem *addr)\r\n{\r\niowrite32be(val, addr);\r\n}\r\nstatic unsigned int xspi_read32_be(void __iomem *addr)\r\n{\r\nreturn ioread32be(addr);\r\n}\r\nstatic void xspi_tx8(struct xilinx_spi *xspi)\r\n{\r\nxspi->write_fn(*xspi->tx_ptr, xspi->regs + XSPI_TXD_OFFSET);\r\nxspi->tx_ptr++;\r\n}\r\nstatic void xspi_tx16(struct xilinx_spi *xspi)\r\n{\r\nxspi->write_fn(*(u16 *)(xspi->tx_ptr), xspi->regs + XSPI_TXD_OFFSET);\r\nxspi->tx_ptr += 2;\r\n}\r\nstatic void xspi_tx32(struct xilinx_spi *xspi)\r\n{\r\nxspi->write_fn(*(u32 *)(xspi->tx_ptr), xspi->regs + XSPI_TXD_OFFSET);\r\nxspi->tx_ptr += 4;\r\n}\r\nstatic void xspi_rx8(struct xilinx_spi *xspi)\r\n{\r\nu32 data = xspi->read_fn(xspi->regs + XSPI_RXD_OFFSET);\r\nif (xspi->rx_ptr) {\r\n*xspi->rx_ptr = data & 0xff;\r\nxspi->rx_ptr++;\r\n}\r\n}\r\nstatic void xspi_rx16(struct xilinx_spi *xspi)\r\n{\r\nu32 data = xspi->read_fn(xspi->regs + XSPI_RXD_OFFSET);\r\nif (xspi->rx_ptr) {\r\n*(u16 *)(xspi->rx_ptr) = data & 0xffff;\r\nxspi->rx_ptr += 2;\r\n}\r\n}\r\nstatic void xspi_rx32(struct xilinx_spi *xspi)\r\n{\r\nu32 data = xspi->read_fn(xspi->regs + XSPI_RXD_OFFSET);\r\nif (xspi->rx_ptr) {\r\n*(u32 *)(xspi->rx_ptr) = data;\r\nxspi->rx_ptr += 4;\r\n}\r\n}\r\nstatic void xspi_init_hw(struct xilinx_spi *xspi)\r\n{\r\nvoid __iomem *regs_base = xspi->regs;\r\nxspi->write_fn(XIPIF_V123B_RESET_MASK,\r\nregs_base + XIPIF_V123B_RESETR_OFFSET);\r\nxspi->write_fn(0, regs_base + XIPIF_V123B_IIER_OFFSET);\r\nxspi->write_fn(XIPIF_V123B_GINTR_ENABLE,\r\nregs_base + XIPIF_V123B_DGIER_OFFSET);\r\nxspi->write_fn(0xffff, regs_base + XSPI_SSR_OFFSET);\r\nxspi->write_fn(XSPI_CR_TRANS_INHIBIT | XSPI_CR_MANUAL_SSELECT |\r\nXSPI_CR_MASTER_MODE | XSPI_CR_ENABLE | XSPI_CR_TXFIFO_RESET |\r\nXSPI_CR_RXFIFO_RESET, regs_base + XSPI_CR_OFFSET);\r\n}\r\nstatic void xilinx_spi_chipselect(struct spi_device *spi, int is_on)\r\n{\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(spi->master);\r\nif (is_on == BITBANG_CS_INACTIVE) {\r\nxspi->write_fn(0xffff, xspi->regs + XSPI_SSR_OFFSET);\r\n} else if (is_on == BITBANG_CS_ACTIVE) {\r\nu16 cr = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET)\r\n& ~XSPI_CR_MODE_MASK;\r\nif (spi->mode & SPI_CPHA)\r\ncr |= XSPI_CR_CPHA;\r\nif (spi->mode & SPI_CPOL)\r\ncr |= XSPI_CR_CPOL;\r\nxspi->write_fn(cr, xspi->regs + XSPI_CR_OFFSET);\r\nxspi->write_fn(~(0x0001 << spi->chip_select),\r\nxspi->regs + XSPI_SSR_OFFSET);\r\n}\r\n}\r\nstatic int xilinx_spi_setup_transfer(struct spi_device *spi,\r\nstruct spi_transfer *t)\r\n{\r\nreturn 0;\r\n}\r\nstatic void xilinx_spi_fill_tx_fifo(struct xilinx_spi *xspi)\r\n{\r\nu8 sr;\r\nsr = xspi->read_fn(xspi->regs + XSPI_SR_OFFSET);\r\nwhile ((sr & XSPI_SR_TX_FULL_MASK) == 0 && xspi->remaining_bytes > 0) {\r\nif (xspi->tx_ptr)\r\nxspi->tx_fn(xspi);\r\nelse\r\nxspi->write_fn(0, xspi->regs + XSPI_TXD_OFFSET);\r\nxspi->remaining_bytes -= xspi->bits_per_word / 8;\r\nsr = xspi->read_fn(xspi->regs + XSPI_SR_OFFSET);\r\n}\r\n}\r\nstatic int xilinx_spi_txrx_bufs(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(spi->master);\r\nu32 ipif_ier;\r\nxspi->tx_ptr = t->tx_buf;\r\nxspi->rx_ptr = t->rx_buf;\r\nxspi->remaining_bytes = t->len;\r\nreinit_completion(&xspi->done);\r\nipif_ier = xspi->read_fn(xspi->regs + XIPIF_V123B_IIER_OFFSET);\r\nxspi->write_fn(ipif_ier | XSPI_INTR_TX_EMPTY,\r\nxspi->regs + XIPIF_V123B_IIER_OFFSET);\r\nfor (;;) {\r\nu16 cr;\r\nu8 sr;\r\nxilinx_spi_fill_tx_fifo(xspi);\r\ncr = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET) &\r\n~XSPI_CR_TRANS_INHIBIT;\r\nxspi->write_fn(cr, xspi->regs + XSPI_CR_OFFSET);\r\nwait_for_completion(&xspi->done);\r\ncr = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET);\r\nxspi->write_fn(cr | XSPI_CR_TRANS_INHIBIT,\r\nxspi->regs + XSPI_CR_OFFSET);\r\nsr = xspi->read_fn(xspi->regs + XSPI_SR_OFFSET);\r\nwhile ((sr & XSPI_SR_RX_EMPTY_MASK) == 0) {\r\nxspi->rx_fn(xspi);\r\nsr = xspi->read_fn(xspi->regs + XSPI_SR_OFFSET);\r\n}\r\nif (xspi->remaining_bytes <= 0)\r\nbreak;\r\n}\r\nxspi->write_fn(ipif_ier, xspi->regs + XIPIF_V123B_IIER_OFFSET);\r\nreturn t->len - xspi->remaining_bytes;\r\n}\r\nstatic irqreturn_t xilinx_spi_irq(int irq, void *dev_id)\r\n{\r\nstruct xilinx_spi *xspi = dev_id;\r\nu32 ipif_isr;\r\nipif_isr = xspi->read_fn(xspi->regs + XIPIF_V123B_IISR_OFFSET);\r\nxspi->write_fn(ipif_isr, xspi->regs + XIPIF_V123B_IISR_OFFSET);\r\nif (ipif_isr & XSPI_INTR_TX_EMPTY) {\r\ncomplete(&xspi->done);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int xilinx_spi_probe(struct platform_device *pdev)\r\n{\r\nstruct xilinx_spi *xspi;\r\nstruct xspi_platform_data *pdata;\r\nstruct resource *res;\r\nint ret, num_cs = 0, bits_per_word = 8;\r\nstruct spi_master *master;\r\nu32 tmp;\r\nu8 i;\r\npdata = dev_get_platdata(&pdev->dev);\r\nif (pdata) {\r\nnum_cs = pdata->num_chipselect;\r\nbits_per_word = pdata->bits_per_word;\r\n} else {\r\nof_property_read_u32(pdev->dev.of_node, "xlnx,num-ss-bits",\r\n&num_cs);\r\n}\r\nif (!num_cs) {\r\ndev_err(&pdev->dev,\r\n"Missing slave select configuration data\n");\r\nreturn -EINVAL;\r\n}\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(struct xilinx_spi));\r\nif (!master)\r\nreturn -ENODEV;\r\nmaster->mode_bits = SPI_CPOL | SPI_CPHA;\r\nxspi = spi_master_get_devdata(master);\r\nxspi->bitbang.master = master;\r\nxspi->bitbang.chipselect = xilinx_spi_chipselect;\r\nxspi->bitbang.setup_transfer = xilinx_spi_setup_transfer;\r\nxspi->bitbang.txrx_bufs = xilinx_spi_txrx_bufs;\r\ninit_completion(&xspi->done);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nxspi->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(xspi->regs)) {\r\nret = PTR_ERR(xspi->regs);\r\ngoto put_master;\r\n}\r\nmaster->bus_num = pdev->id;\r\nmaster->num_chipselect = num_cs;\r\nmaster->dev.of_node = pdev->dev.of_node;\r\nxspi->read_fn = xspi_read32;\r\nxspi->write_fn = xspi_write32;\r\nxspi->write_fn(XSPI_CR_LOOP, xspi->regs + XSPI_CR_OFFSET);\r\ntmp = xspi->read_fn(xspi->regs + XSPI_CR_OFFSET);\r\ntmp &= XSPI_CR_LOOP;\r\nif (tmp != XSPI_CR_LOOP) {\r\nxspi->read_fn = xspi_read32_be;\r\nxspi->write_fn = xspi_write32_be;\r\n}\r\nmaster->bits_per_word_mask = SPI_BPW_MASK(bits_per_word);\r\nxspi->bits_per_word = bits_per_word;\r\nif (xspi->bits_per_word == 8) {\r\nxspi->tx_fn = xspi_tx8;\r\nxspi->rx_fn = xspi_rx8;\r\n} else if (xspi->bits_per_word == 16) {\r\nxspi->tx_fn = xspi_tx16;\r\nxspi->rx_fn = xspi_rx16;\r\n} else if (xspi->bits_per_word == 32) {\r\nxspi->tx_fn = xspi_tx32;\r\nxspi->rx_fn = xspi_rx32;\r\n} else {\r\nret = -EINVAL;\r\ngoto put_master;\r\n}\r\nxspi_init_hw(xspi);\r\nxspi->irq = platform_get_irq(pdev, 0);\r\nif (xspi->irq < 0) {\r\nret = xspi->irq;\r\ngoto put_master;\r\n}\r\nret = devm_request_irq(&pdev->dev, xspi->irq, xilinx_spi_irq, 0,\r\ndev_name(&pdev->dev), xspi);\r\nif (ret)\r\ngoto put_master;\r\nret = spi_bitbang_start(&xspi->bitbang);\r\nif (ret) {\r\ndev_err(&pdev->dev, "spi_bitbang_start FAILED\n");\r\ngoto put_master;\r\n}\r\ndev_info(&pdev->dev, "at 0x%08llX mapped to 0x%p, irq=%d\n",\r\n(unsigned long long)res->start, xspi->regs, xspi->irq);\r\nif (pdata) {\r\nfor (i = 0; i < pdata->num_devices; i++)\r\nspi_new_device(master, pdata->devices + i);\r\n}\r\nplatform_set_drvdata(pdev, master);\r\nreturn 0;\r\nput_master:\r\nspi_master_put(master);\r\nreturn ret;\r\n}\r\nstatic int xilinx_spi_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct xilinx_spi *xspi = spi_master_get_devdata(master);\r\nvoid __iomem *regs_base = xspi->regs;\r\nspi_bitbang_stop(&xspi->bitbang);\r\nxspi->write_fn(0, regs_base + XIPIF_V123B_IIER_OFFSET);\r\nxspi->write_fn(0, regs_base + XIPIF_V123B_DGIER_OFFSET);\r\nspi_master_put(xspi->bitbang.master);\r\nreturn 0;\r\n}

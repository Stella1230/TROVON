void ieee80211_aes_ccm_encrypt(struct crypto_aead *tfm, u8 *b_0, u8 *aad,\r\nu8 *data, size_t data_len, u8 *mic)\r\n{\r\nstruct scatterlist assoc, pt, ct[2];\r\nchar aead_req_data[sizeof(struct aead_request) +\r\ncrypto_aead_reqsize(tfm)]\r\n__aligned(__alignof__(struct aead_request));\r\nstruct aead_request *aead_req = (void *) aead_req_data;\r\nmemset(aead_req, 0, sizeof(aead_req_data));\r\nsg_init_one(&pt, data, data_len);\r\nsg_init_one(&assoc, &aad[2], be16_to_cpup((__be16 *)aad));\r\nsg_init_table(ct, 2);\r\nsg_set_buf(&ct[0], data, data_len);\r\nsg_set_buf(&ct[1], mic, IEEE80211_CCMP_MIC_LEN);\r\naead_request_set_tfm(aead_req, tfm);\r\naead_request_set_assoc(aead_req, &assoc, assoc.length);\r\naead_request_set_crypt(aead_req, &pt, ct, data_len, b_0);\r\ncrypto_aead_encrypt(aead_req);\r\n}\r\nint ieee80211_aes_ccm_decrypt(struct crypto_aead *tfm, u8 *b_0, u8 *aad,\r\nu8 *data, size_t data_len, u8 *mic)\r\n{\r\nstruct scatterlist assoc, pt, ct[2];\r\nchar aead_req_data[sizeof(struct aead_request) +\r\ncrypto_aead_reqsize(tfm)]\r\n__aligned(__alignof__(struct aead_request));\r\nstruct aead_request *aead_req = (void *) aead_req_data;\r\nif (data_len == 0)\r\nreturn -EINVAL;\r\nmemset(aead_req, 0, sizeof(aead_req_data));\r\nsg_init_one(&pt, data, data_len);\r\nsg_init_one(&assoc, &aad[2], be16_to_cpup((__be16 *)aad));\r\nsg_init_table(ct, 2);\r\nsg_set_buf(&ct[0], data, data_len);\r\nsg_set_buf(&ct[1], mic, IEEE80211_CCMP_MIC_LEN);\r\naead_request_set_tfm(aead_req, tfm);\r\naead_request_set_assoc(aead_req, &assoc, assoc.length);\r\naead_request_set_crypt(aead_req, ct, &pt,\r\ndata_len + IEEE80211_CCMP_MIC_LEN, b_0);\r\nreturn crypto_aead_decrypt(aead_req);\r\n}\r\nstruct crypto_aead *ieee80211_aes_key_setup_encrypt(const u8 key[])\r\n{\r\nstruct crypto_aead *tfm;\r\nint err;\r\ntfm = crypto_alloc_aead("ccm(aes)", 0, CRYPTO_ALG_ASYNC);\r\nif (IS_ERR(tfm))\r\nreturn tfm;\r\nerr = crypto_aead_setkey(tfm, key, WLAN_KEY_LEN_CCMP);\r\nif (!err)\r\nerr = crypto_aead_setauthsize(tfm, IEEE80211_CCMP_MIC_LEN);\r\nif (!err)\r\nreturn tfm;\r\ncrypto_free_aead(tfm);\r\nreturn ERR_PTR(err);\r\n}\r\nvoid ieee80211_aes_key_free(struct crypto_aead *tfm)\r\n{\r\ncrypto_free_aead(tfm);\r\n}

static ssize_t\r\nnouveau_hwmon_show_temp(struct device *d, struct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nint temp = therm->temp_get(therm);\r\nif (temp < 0)\r\nreturn temp;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", temp * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_show_temp1_auto_point1_pwm(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", 100);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_temp1_auto_point1_temp(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_FAN_BOOST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_temp1_auto_point1_temp(struct device *d,\r\nstruct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_FAN_BOOST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_temp1_auto_point1_temp_hyst(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_FAN_BOOST_HYST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_temp1_auto_point1_temp_hyst(struct device *d,\r\nstruct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_FAN_BOOST_HYST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_max_temp(struct device *d, struct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_DOWN_CLK) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_max_temp(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_DOWN_CLK, value / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_max_temp_hyst(struct device *d, struct device_attribute *a,\r\nchar *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_DOWN_CLK_HYST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_max_temp_hyst(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_DOWN_CLK_HYST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_critical_temp(struct device *d, struct device_attribute *a,\r\nchar *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_CRITICAL) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_critical_temp(struct device *d, struct device_attribute *a,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_CRITICAL, value / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_critical_temp_hyst(struct device *d, struct device_attribute *a,\r\nchar *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_CRITICAL_HYST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_critical_temp_hyst(struct device *d,\r\nstruct device_attribute *a,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_CRITICAL_HYST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_emergency_temp(struct device *d, struct device_attribute *a,\r\nchar *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_SHUTDOWN) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_emergency_temp(struct device *d, struct device_attribute *a,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_SHUTDOWN, value / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_emergency_temp_hyst(struct device *d, struct device_attribute *a,\r\nchar *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ntherm->attr_get(therm, NOUVEAU_THERM_ATTR_THRS_SHUTDOWN_HYST) * 1000);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_emergency_temp_hyst(struct device *d,\r\nstruct device_attribute *a,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn count;\r\ntherm->attr_set(therm, NOUVEAU_THERM_ATTR_THRS_SHUTDOWN_HYST,\r\nvalue / 1000);\r\nreturn count;\r\n}\r\nstatic ssize_t nouveau_hwmon_show_name(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "nouveau\n");\r\n}\r\nstatic ssize_t nouveau_hwmon_show_update_rate(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "1000\n");\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_show_fan1_input(struct device *d, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", therm->fan_sense(therm));\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_get_pwm1_enable(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nint ret;\r\nret = therm->attr_get(therm, NOUVEAU_THERM_ATTR_FAN_MODE);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%i\n", ret);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_pwm1_enable(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nint ret;\r\nret = kstrtol(buf, 10, &value);\r\nif (ret)\r\nreturn ret;\r\nret = therm->attr_set(therm, NOUVEAU_THERM_ATTR_FAN_MODE, value);\r\nif (ret)\r\nreturn ret;\r\nelse\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_get_pwm1(struct device *d, struct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nint ret;\r\nret = therm->fan_get(therm);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%i\n", ret);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_pwm1(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nint ret = -ENODEV;\r\nlong value;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn -EINVAL;\r\nret = therm->fan_set(therm, value);\r\nif (ret)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_get_pwm1_min(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nint ret;\r\nret = therm->attr_get(therm, NOUVEAU_THERM_ATTR_FAN_MIN_DUTY);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%i\n", ret);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_pwm1_min(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nint ret;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn -EINVAL;\r\nret = therm->attr_set(therm, NOUVEAU_THERM_ATTR_FAN_MIN_DUTY, value);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_get_pwm1_max(struct device *d,\r\nstruct device_attribute *a, char *buf)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nint ret;\r\nret = therm->attr_get(therm, NOUVEAU_THERM_ATTR_FAN_MAX_DUTY);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn sprintf(buf, "%i\n", ret);\r\n}\r\nstatic ssize_t\r\nnouveau_hwmon_set_pwm1_max(struct device *d, struct device_attribute *a,\r\nconst char *buf, size_t count)\r\n{\r\nstruct drm_device *dev = dev_get_drvdata(d);\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nlong value;\r\nint ret;\r\nif (kstrtol(buf, 10, &value) == -EINVAL)\r\nreturn -EINVAL;\r\nret = therm->attr_set(therm, NOUVEAU_THERM_ATTR_FAN_MAX_DUTY, value);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn count;\r\n}\r\nint\r\nnouveau_hwmon_init(struct drm_device *dev)\r\n{\r\n#if defined(CONFIG_HWMON) || (defined(MODULE) && defined(CONFIG_HWMON_MODULE))\r\nstruct nouveau_drm *drm = nouveau_drm(dev);\r\nstruct nouveau_therm *therm = nvkm_therm(&drm->device);\r\nstruct nouveau_hwmon *hwmon;\r\nstruct device *hwmon_dev;\r\nint ret = 0;\r\nhwmon = drm->hwmon = kzalloc(sizeof(*hwmon), GFP_KERNEL);\r\nif (!hwmon)\r\nreturn -ENOMEM;\r\nhwmon->dev = dev;\r\nif (!therm || !therm->temp_get || !therm->attr_get || !therm->attr_set)\r\nreturn -ENODEV;\r\nhwmon_dev = hwmon_device_register(&dev->pdev->dev);\r\nif (IS_ERR(hwmon_dev)) {\r\nret = PTR_ERR(hwmon_dev);\r\nNV_ERROR(drm, "Unable to register hwmon device: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_set_drvdata(hwmon_dev, dev);\r\nret = sysfs_create_group(&hwmon_dev->kobj, &hwmon_default_attrgroup);\r\nif (ret)\r\ngoto error;\r\nif (therm->temp_get(therm) >= 0) {\r\nret = sysfs_create_group(&hwmon_dev->kobj, &hwmon_temp_attrgroup);\r\nif (ret)\r\ngoto error;\r\n}\r\nif (therm->fan_get && therm->fan_get(therm) >= 0) {\r\nret = sysfs_create_group(&hwmon_dev->kobj,\r\n&hwmon_pwm_fan_attrgroup);\r\nif (ret)\r\ngoto error;\r\n}\r\nif (therm->fan_sense(therm) >= 0) {\r\nret = sysfs_create_group(&hwmon_dev->kobj,\r\n&hwmon_fan_rpm_attrgroup);\r\nif (ret)\r\ngoto error;\r\n}\r\nhwmon->hwmon = hwmon_dev;\r\nreturn 0;\r\nerror:\r\nNV_ERROR(drm, "Unable to create some hwmon sysfs files: %d\n", ret);\r\nhwmon_device_unregister(hwmon_dev);\r\nhwmon->hwmon = NULL;\r\nreturn ret;\r\n#else\r\nreturn 0;\r\n#endif\r\n}\r\nvoid\r\nnouveau_hwmon_fini(struct drm_device *dev)\r\n{\r\n#if defined(CONFIG_HWMON) || (defined(MODULE) && defined(CONFIG_HWMON_MODULE))\r\nstruct nouveau_hwmon *hwmon = nouveau_hwmon(dev);\r\nif (hwmon->hwmon) {\r\nsysfs_remove_group(&hwmon->hwmon->kobj, &hwmon_default_attrgroup);\r\nsysfs_remove_group(&hwmon->hwmon->kobj, &hwmon_temp_attrgroup);\r\nsysfs_remove_group(&hwmon->hwmon->kobj, &hwmon_pwm_fan_attrgroup);\r\nsysfs_remove_group(&hwmon->hwmon->kobj, &hwmon_fan_rpm_attrgroup);\r\nhwmon_device_unregister(hwmon->hwmon);\r\n}\r\nnouveau_drm(dev)->hwmon = NULL;\r\nkfree(hwmon);\r\n#endif\r\n}

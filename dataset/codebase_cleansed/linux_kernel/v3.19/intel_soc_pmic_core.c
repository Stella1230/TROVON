static int intel_soc_pmic_find_gpio_irq(struct device *dev)\r\n{\r\nstruct gpio_desc *desc;\r\nint irq;\r\ndesc = devm_gpiod_get_index(dev, "intel_soc_pmic", 0);\r\nif (IS_ERR(desc))\r\nreturn -ENOENT;\r\nirq = gpiod_to_irq(desc);\r\nif (irq < 0)\r\ndev_warn(dev, "Can't get irq: %d\n", irq);\r\nreturn irq;\r\n}\r\nstatic int intel_soc_pmic_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *i2c_id)\r\n{\r\nstruct device *dev = &i2c->dev;\r\nconst struct acpi_device_id *id;\r\nstruct intel_soc_pmic_config *config;\r\nstruct intel_soc_pmic *pmic;\r\nint ret;\r\nint irq;\r\nid = acpi_match_device(dev->driver->acpi_match_table, dev);\r\nif (!id || !id->driver_data)\r\nreturn -ENODEV;\r\nconfig = (struct intel_soc_pmic_config *)id->driver_data;\r\npmic = devm_kzalloc(dev, sizeof(*pmic), GFP_KERNEL);\r\ndev_set_drvdata(dev, pmic);\r\npmic->regmap = devm_regmap_init_i2c(i2c, config->regmap_config);\r\nirq = intel_soc_pmic_find_gpio_irq(dev);\r\npmic->irq = (irq < 0) ? i2c->irq : irq;\r\nret = regmap_add_irq_chip(pmic->regmap, pmic->irq,\r\nconfig->irq_flags | IRQF_ONESHOT,\r\n0, config->irq_chip,\r\n&pmic->irq_chip_data);\r\nif (ret)\r\nreturn ret;\r\nret = enable_irq_wake(pmic->irq);\r\nif (ret)\r\ndev_warn(dev, "Can't enable IRQ as wake source: %d\n", ret);\r\nret = mfd_add_devices(dev, -1, config->cell_dev,\r\nconfig->n_cell_devs, NULL, 0,\r\nregmap_irq_get_domain(pmic->irq_chip_data));\r\nif (ret)\r\ngoto err_del_irq_chip;\r\nreturn 0;\r\nerr_del_irq_chip:\r\nregmap_del_irq_chip(pmic->irq, pmic->irq_chip_data);\r\nreturn ret;\r\n}\r\nstatic int intel_soc_pmic_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(&i2c->dev);\r\nregmap_del_irq_chip(pmic->irq, pmic->irq_chip_data);\r\nmfd_remove_devices(&i2c->dev);\r\nreturn 0;\r\n}\r\nstatic void intel_soc_pmic_shutdown(struct i2c_client *i2c)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(&i2c->dev);\r\ndisable_irq(pmic->irq);\r\nreturn;\r\n}\r\nstatic int intel_soc_pmic_suspend(struct device *dev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\ndisable_irq(pmic->irq);\r\nreturn 0;\r\n}\r\nstatic int intel_soc_pmic_resume(struct device *dev)\r\n{\r\nstruct intel_soc_pmic *pmic = dev_get_drvdata(dev);\r\nenable_irq(pmic->irq);\r\nreturn 0;\r\n}

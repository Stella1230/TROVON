static int dwc3_qcom_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *node = pdev->dev.of_node;\r\nstruct dwc3_qcom *qdwc;\r\nint ret;\r\nqdwc = devm_kzalloc(&pdev->dev, sizeof(*qdwc), GFP_KERNEL);\r\nif (!qdwc)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, qdwc);\r\nqdwc->dev = &pdev->dev;\r\nqdwc->core_clk = devm_clk_get(qdwc->dev, "core");\r\nif (IS_ERR(qdwc->core_clk)) {\r\ndev_err(qdwc->dev, "failed to get core clock\n");\r\nreturn PTR_ERR(qdwc->core_clk);\r\n}\r\nqdwc->iface_clk = devm_clk_get(qdwc->dev, "iface");\r\nif (IS_ERR(qdwc->iface_clk)) {\r\ndev_dbg(qdwc->dev, "failed to get optional iface clock\n");\r\nqdwc->iface_clk = NULL;\r\n}\r\nqdwc->sleep_clk = devm_clk_get(qdwc->dev, "sleep");\r\nif (IS_ERR(qdwc->sleep_clk)) {\r\ndev_dbg(qdwc->dev, "failed to get optional sleep clock\n");\r\nqdwc->sleep_clk = NULL;\r\n}\r\nret = clk_prepare_enable(qdwc->core_clk);\r\nif (ret) {\r\ndev_err(qdwc->dev, "failed to enable core clock\n");\r\ngoto err_core;\r\n}\r\nret = clk_prepare_enable(qdwc->iface_clk);\r\nif (ret) {\r\ndev_err(qdwc->dev, "failed to enable optional iface clock\n");\r\ngoto err_iface;\r\n}\r\nret = clk_prepare_enable(qdwc->sleep_clk);\r\nif (ret) {\r\ndev_err(qdwc->dev, "failed to enable optional sleep clock\n");\r\ngoto err_sleep;\r\n}\r\nret = of_platform_populate(node, NULL, NULL, qdwc->dev);\r\nif (ret) {\r\ndev_err(qdwc->dev, "failed to register core - %d\n", ret);\r\ngoto err_clks;\r\n}\r\nreturn 0;\r\nerr_clks:\r\nclk_disable_unprepare(qdwc->sleep_clk);\r\nerr_sleep:\r\nclk_disable_unprepare(qdwc->iface_clk);\r\nerr_iface:\r\nclk_disable_unprepare(qdwc->core_clk);\r\nerr_core:\r\nreturn ret;\r\n}\r\nstatic int dwc3_qcom_remove(struct platform_device *pdev)\r\n{\r\nstruct dwc3_qcom *qdwc = platform_get_drvdata(pdev);\r\nof_platform_depopulate(&pdev->dev);\r\nclk_disable_unprepare(qdwc->sleep_clk);\r\nclk_disable_unprepare(qdwc->iface_clk);\r\nclk_disable_unprepare(qdwc->core_clk);\r\nreturn 0;\r\n}

static int uni2char(const wchar_t uni,\r\nunsigned char *out, int boundlen)\r\n{\r\nif (boundlen <= 0)\r\nreturn -ENAMETOOLONG;\r\nif ((uni & 0xffaf) == 0x040e || (uni & 0xffce) == 0x254c) {\r\nif (uni == 0x040e)\r\nout[0] = 0xbe;\r\nelse if (uni == 0x045e)\r\nout[0] = 0xae;\r\nelse if (uni == 0x255d || uni == 0x256c)\r\nreturn 0;\r\nelse\r\nreturn p_nls->uni2char(uni, out, boundlen);\r\nreturn 1;\r\n}\r\nelse\r\nreturn p_nls->uni2char(uni, out, boundlen);\r\n}\r\nstatic int char2uni(const unsigned char *rawstring, int boundlen,\r\nwchar_t *uni)\r\n{\r\nint n;\r\nif ((*rawstring & 0xef) != 0xae) {\r\n*uni = (*rawstring & 0x10) ? 0x040e : 0x045e;\r\nreturn 1;\r\n}\r\nn = p_nls->char2uni(rawstring, boundlen, uni);\r\nreturn n;\r\n}\r\nstatic int __init init_nls_koi8_ru(void)\r\n{\r\np_nls = load_nls("koi8-u");\r\nif (p_nls) {\r\ntable.charset2upper = p_nls->charset2upper;\r\ntable.charset2lower = p_nls->charset2lower;\r\nreturn register_nls(&table);\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void __exit exit_nls_koi8_ru(void)\r\n{\r\nunregister_nls(&table);\r\nunload_nls(p_nls);\r\n}

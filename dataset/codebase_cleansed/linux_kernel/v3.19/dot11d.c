void Dot11d_Init(struct ieee80211_device *ieee)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(ieee);\r\npDot11dInfo->bEnabled = 0;\r\npDot11dInfo->State = DOT11D_STATE_NONE;\r\npDot11dInfo->CountryIeLen = 0;\r\nmemset(pDot11dInfo->channel_map, 0, MAX_CHANNEL_NUMBER+1);\r\nmemset(pDot11dInfo->MaxTxPwrDbmList, 0xFF, MAX_CHANNEL_NUMBER+1);\r\nRESET_CIE_WATCHDOG(ieee);\r\nnetdev_info(ieee->dev, "Dot11d_Init()\n");\r\n}\r\nvoid Dot11d_Reset(struct ieee80211_device *ieee)\r\n{\r\nu32 i;\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(ieee);\r\nmemset(pDot11dInfo->channel_map, 0, MAX_CHANNEL_NUMBER+1);\r\nmemset(pDot11dInfo->MaxTxPwrDbmList, 0xFF, MAX_CHANNEL_NUMBER+1);\r\nfor (i = 1; i <= 11; i++)\r\n(pDot11dInfo->channel_map)[i] = 1;\r\nfor (i = 12; i <= 14; i++)\r\n(pDot11dInfo->channel_map)[i] = 2;\r\npDot11dInfo->State = DOT11D_STATE_NONE;\r\npDot11dInfo->CountryIeLen = 0;\r\nRESET_CIE_WATCHDOG(ieee);\r\n}\r\nvoid Dot11d_UpdateCountryIe(struct ieee80211_device *dev, u8 *pTaddr,\r\nu16 CoutryIeLen, u8 *pCoutryIe)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nu8 i, j, NumTriples, MaxChnlNum;\r\nPCHNL_TXPOWER_TRIPLE pTriple;\r\nmemset(pDot11dInfo->channel_map, 0, MAX_CHANNEL_NUMBER+1);\r\nmemset(pDot11dInfo->MaxTxPwrDbmList, 0xFF, MAX_CHANNEL_NUMBER+1);\r\nMaxChnlNum = 0;\r\nNumTriples = (CoutryIeLen - 3) / 3;\r\npTriple = (PCHNL_TXPOWER_TRIPLE)(pCoutryIe + 3);\r\nfor (i = 0; i < NumTriples; i++) {\r\nif (MaxChnlNum >= pTriple->FirstChnl) {\r\nnetdev_err(dev->dev, "Dot11d_UpdateCountryIe(): Invalid country IE, skip it........1\n");\r\nreturn;\r\n}\r\nif (MAX_CHANNEL_NUMBER < (pTriple->FirstChnl + pTriple->NumChnls)) {\r\nnetdev_err(dev->dev, "Dot11d_UpdateCountryIe(): Invalid country IE, skip it........2\n");\r\nreturn;\r\n}\r\nfor (j = 0; j < pTriple->NumChnls; j++) {\r\npDot11dInfo->channel_map[pTriple->FirstChnl + j] = 1;\r\npDot11dInfo->MaxTxPwrDbmList[pTriple->FirstChnl + j] = pTriple->MaxTxPowerInDbm;\r\nMaxChnlNum = pTriple->FirstChnl + j;\r\n}\r\npTriple = (PCHNL_TXPOWER_TRIPLE)((u8 *)pTriple + 3);\r\n}\r\nnetdev_info(dev->dev, "Channel List:");\r\nfor (i = 1; i <= MAX_CHANNEL_NUMBER; i++)\r\nif (pDot11dInfo->channel_map[i] > 0)\r\nnetdev_info(dev->dev, " %d", i);\r\nnetdev_info(dev->dev, "\n");\r\nUPDATE_CIE_SRC(dev, pTaddr);\r\npDot11dInfo->CountryIeLen = CoutryIeLen;\r\nmemcpy(pDot11dInfo->CountryIeBuf, pCoutryIe, CoutryIeLen);\r\npDot11dInfo->State = DOT11D_STATE_LEARNED;\r\n}\r\nu8 DOT11D_GetMaxTxPwrInDbm(struct ieee80211_device *dev, u8 Channel)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nu8 MaxTxPwrInDbm = 255;\r\nif (MAX_CHANNEL_NUMBER < Channel) {\r\nnetdev_err(dev->dev, "DOT11D_GetMaxTxPwrInDbm(): Invalid Channel\n");\r\nreturn MaxTxPwrInDbm;\r\n}\r\nif (pDot11dInfo->channel_map[Channel])\r\nMaxTxPwrInDbm = pDot11dInfo->MaxTxPwrDbmList[Channel];\r\nreturn MaxTxPwrInDbm;\r\n}\r\nvoid DOT11D_ScanComplete(struct ieee80211_device *dev)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nswitch (pDot11dInfo->State) {\r\ncase DOT11D_STATE_LEARNED:\r\npDot11dInfo->State = DOT11D_STATE_DONE;\r\nbreak;\r\ncase DOT11D_STATE_DONE:\r\nif (GET_CIE_WATCHDOG(dev) == 0) {\r\nDot11d_Reset(dev);\r\n}\r\nbreak;\r\ncase DOT11D_STATE_NONE:\r\nbreak;\r\n}\r\n}\r\nint IsLegalChannel(struct ieee80211_device *dev, u8 channel)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nif (MAX_CHANNEL_NUMBER < channel) {\r\nnetdev_err(dev->dev, "IsLegalChannel(): Invalid Channel\n");\r\nreturn 0;\r\n}\r\nif (pDot11dInfo->channel_map[channel] > 0)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nint ToLegalChannel(struct ieee80211_device *dev, u8 channel)\r\n{\r\nPRT_DOT11D_INFO pDot11dInfo = GET_DOT11D_INFO(dev);\r\nu8 default_chn = 0;\r\nu32 i = 0;\r\nfor (i = 1; i <= MAX_CHANNEL_NUMBER; i++) {\r\nif (pDot11dInfo->channel_map[i] > 0) {\r\ndefault_chn = i;\r\nbreak;\r\n}\r\n}\r\nif (MAX_CHANNEL_NUMBER < channel) {\r\nnetdev_err(dev->dev, "IsLegalChannel(): Invalid Channel\n");\r\nreturn default_chn;\r\n}\r\nif (pDot11dInfo->channel_map[channel] > 0)\r\nreturn channel;\r\nreturn default_chn;\r\n}

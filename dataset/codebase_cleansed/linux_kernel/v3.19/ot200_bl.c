static int ot200_backlight_update_status(struct backlight_device *bl)\r\n{\r\nstruct ot200_backlight_data *data = bl_get_data(bl);\r\nint brightness = bl->props.brightness;\r\nif (bl->props.state & BL_CORE_FBBLANK)\r\nbrightness = 0;\r\nif (brightness == 0)\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_SETUP, 0);\r\nelse if (data->current_brightness == 0) {\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_COUNTER, 0);\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_SETUP,\r\nMFGPT_SETUP_CNTEN);\r\n}\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_CMP1,\r\nMAX_COMP2 - dim_table[brightness]);\r\ndata->current_brightness = brightness;\r\nreturn 0;\r\n}\r\nstatic int ot200_backlight_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct ot200_backlight_data *data = bl_get_data(bl);\r\nreturn data->current_brightness;\r\n}\r\nstatic int ot200_backlight_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl;\r\nstruct ot200_backlight_data *data;\r\nstruct backlight_properties props;\r\nint retval = 0;\r\nif (devm_gpio_request(&pdev->dev, GPIO_DIMM,\r\n"ot200 backlight dimmer") < 0) {\r\ndev_err(&pdev->dev, "failed to request GPIO %d\n", GPIO_DIMM);\r\nreturn -ENODEV;\r\n}\r\npwm_timer = cs5535_mfgpt_alloc_timer(7, MFGPT_DOMAIN_ANY);\r\nif (!pwm_timer) {\r\ndev_err(&pdev->dev, "MFGPT 7 not available\n");\r\nreturn -ENODEV;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data) {\r\nretval = -ENOMEM;\r\ngoto error_devm_kzalloc;\r\n}\r\ncs5535_gpio_set(GPIO_DIMM, GPIO_OUTPUT_ENABLE);\r\ncs5535_gpio_set(GPIO_DIMM, GPIO_OUTPUT_AUX1);\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_CMP1, 0);\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_CMP2, MAX_COMP2);\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_SETUP, PWM_SETUP);\r\ndata->current_brightness = 100;\r\nprops.max_brightness = 100;\r\nprops.brightness = 100;\r\nprops.type = BACKLIGHT_RAW;\r\nbl = devm_backlight_device_register(&pdev->dev, dev_name(&pdev->dev),\r\n&pdev->dev, data, &ot200_backlight_ops,\r\n&props);\r\nif (IS_ERR(bl)) {\r\ndev_err(&pdev->dev, "failed to register backlight\n");\r\nretval = PTR_ERR(bl);\r\ngoto error_devm_kzalloc;\r\n}\r\nplatform_set_drvdata(pdev, bl);\r\nreturn 0;\r\nerror_devm_kzalloc:\r\ncs5535_mfgpt_free_timer(pwm_timer);\r\nreturn retval;\r\n}\r\nstatic int ot200_backlight_remove(struct platform_device *pdev)\r\n{\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_COUNTER, 0);\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_SETUP, MFGPT_SETUP_CNTEN);\r\ncs5535_mfgpt_write(pwm_timer, MFGPT_REG_CMP1,\r\nMAX_COMP2 - dim_table[100]);\r\ncs5535_mfgpt_free_timer(pwm_timer);\r\nreturn 0;\r\n}

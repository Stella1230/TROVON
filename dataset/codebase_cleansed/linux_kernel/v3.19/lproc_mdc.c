static int mdc_max_rpcs_in_flight_seq_show(struct seq_file *m, void *v)\r\n{\r\nstruct obd_device *dev = m->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint rc;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\nrc = seq_printf(m, "%u\n", cli->cl_max_rpcs_in_flight);\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn rc;\r\n}\r\nstatic ssize_t mdc_max_rpcs_in_flight_seq_write(struct file *file,\r\nconst char *buffer,\r\nsize_t count,\r\nloff_t *off)\r\n{\r\nstruct obd_device *dev =\r\n((struct seq_file *)file->private_data)->private;\r\nstruct client_obd *cli = &dev->u.cli;\r\nint val, rc;\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nif (val < 1 || val > MDC_MAX_RIF_MAX)\r\nreturn -ERANGE;\r\nclient_obd_list_lock(&cli->cl_loi_list_lock);\r\ncli->cl_max_rpcs_in_flight = val;\r\nclient_obd_list_unlock(&cli->cl_loi_list_lock);\r\nreturn count;\r\n}\r\nstatic int mdc_kuc_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, NULL, PDE_DATA(inode));\r\n}\r\nstatic ssize_t mdc_kuc_write(struct file *file, const char *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct obd_device *obd =\r\n((struct seq_file *)file->private_data)->private;\r\nstruct kuc_hdr *lh;\r\nstruct hsm_action_list *hal;\r\nstruct hsm_action_item *hai;\r\nint len;\r\nint fd, rc;\r\nrc = lprocfs_write_helper(buffer, count, &fd);\r\nif (rc)\r\nreturn rc;\r\nif (fd < 0)\r\nreturn -ERANGE;\r\nCWARN("message to fd %d\n", fd);\r\nlen = sizeof(*lh) + sizeof(*hal) + MTI_NAME_MAXLEN +\r\n2 * cfs_size_round(sizeof(*hai));\r\nOBD_ALLOC(lh, len);\r\nlh->kuc_magic = KUC_MAGIC;\r\nlh->kuc_transport = KUC_TRANSPORT_HSM;\r\nlh->kuc_msgtype = HMT_ACTION_LIST;\r\nlh->kuc_msglen = len;\r\nhal = (struct hsm_action_list *)(lh + 1);\r\nhal->hal_version = HAL_VERSION;\r\nhal->hal_archive_id = 1;\r\nhal->hal_flags = 0;\r\nobd_uuid2fsname(hal->hal_fsname, obd->obd_name, MTI_NAME_MAXLEN);\r\nhal->hal_count = 2;\r\nhai = hai_zero(hal);\r\nhai->hai_action = HSMA_ARCHIVE;\r\nhai->hai_fid.f_oid = 5;\r\nhai->hai_len = sizeof(*hai);\r\nhai = hai_next(hai);\r\nhai->hai_action = HSMA_RESTORE;\r\nhai->hai_fid.f_oid = 10;\r\nhai->hai_len = sizeof(*hai);\r\nif (fd == 0) {\r\nrc = libcfs_kkuc_group_put(KUC_GRP_HSM, lh);\r\n} else {\r\nstruct file *fp = fget(fd);\r\nrc = libcfs_kkuc_msg_put(fp, lh);\r\nfput(fp);\r\n}\r\nOBD_FREE(lh, len);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn count;\r\n}\r\nstatic int mdc_obd_max_pages_per_rpc_seq_show(struct seq_file *m, void *v)\r\n{\r\nreturn lprocfs_obd_rd_max_pages_per_rpc(m, m->private);\r\n}\r\nvoid lprocfs_mdc_init_vars(struct lprocfs_static_vars *lvars)\r\n{\r\nlvars->module_vars = lprocfs_mdc_module_vars;\r\nlvars->obd_vars = lprocfs_mdc_obd_vars;\r\n}

static void *fm10k_dbg_desc_seq_start(struct seq_file *s, loff_t *pos)\r\n{\r\nstruct fm10k_ring *ring = s->private;\r\nreturn (*pos < ring->count) ? pos : NULL;\r\n}\r\nstatic void *fm10k_dbg_desc_seq_next(struct seq_file *s, void *v, loff_t *pos)\r\n{\r\nstruct fm10k_ring *ring = s->private;\r\nreturn (++(*pos) < ring->count) ? pos : NULL;\r\n}\r\nstatic void fm10k_dbg_desc_seq_stop(struct seq_file *s, void *v)\r\n{\r\n}\r\nstatic void fm10k_dbg_desc_break(struct seq_file *s, int i)\r\n{\r\nwhile (i--)\r\nseq_puts(s, "-");\r\nseq_puts(s, "\n");\r\n}\r\nstatic int fm10k_dbg_tx_desc_seq_show(struct seq_file *s, void *v)\r\n{\r\nstruct fm10k_ring *ring = s->private;\r\nint i = *(loff_t *)v;\r\nstatic const char tx_desc_hdr[] =\r\n"DES BUFFER_ADDRESS LENGTH VLAN MSS HDRLEN FLAGS\n";\r\nif (!i) {\r\nseq_printf(s, tx_desc_hdr);\r\nfm10k_dbg_desc_break(s, sizeof(tx_desc_hdr) - 1);\r\n}\r\nif (!ring->desc) {\r\nseq_printf(s, "%03X Descriptor ring not allocated.\n", i);\r\n} else {\r\nstruct fm10k_tx_desc *txd = FM10K_TX_DESC(ring, i);\r\nseq_printf(s, "%03X %#018llx %#06x %#06x %#06x %#06x %#04x\n",\r\ni, txd->buffer_addr, txd->buflen, txd->vlan,\r\ntxd->mss, txd->hdrlen, txd->flags);\r\n}\r\nreturn 0;\r\n}\r\nstatic int fm10k_dbg_rx_desc_seq_show(struct seq_file *s, void *v)\r\n{\r\nstruct fm10k_ring *ring = s->private;\r\nint i = *(loff_t *)v;\r\nstatic const char rx_desc_hdr[] =\r\n"DES DATA RSS STATERR LENGTH VLAN DGLORT SGLORT TIMESTAMP\n";\r\nif (!i) {\r\nseq_printf(s, rx_desc_hdr);\r\nfm10k_dbg_desc_break(s, sizeof(rx_desc_hdr) - 1);\r\n}\r\nif (!ring->desc) {\r\nseq_printf(s, "%03X Descriptor ring not allocated.\n", i);\r\n} else {\r\nunion fm10k_rx_desc *rxd = FM10K_RX_DESC(ring, i);\r\nseq_printf(s,\r\n"%03X %#010x %#010x %#010x %#06x %#06x %#06x %#06x %#018llx\n",\r\ni, rxd->d.data, rxd->d.rss, rxd->d.staterr,\r\nrxd->w.length, rxd->w.vlan, rxd->w.dglort,\r\nrxd->w.sglort, rxd->q.timestamp);\r\n}\r\nreturn 0;\r\n}\r\nstatic int fm10k_dbg_desc_open(struct inode *inode, struct file *filep)\r\n{\r\nstruct fm10k_ring *ring = inode->i_private;\r\nstruct fm10k_q_vector *q_vector = ring->q_vector;\r\nconst struct seq_operations *desc_seq_ops;\r\nint err;\r\nif (ring < q_vector->rx.ring)\r\ndesc_seq_ops = &fm10k_dbg_tx_desc_seq_ops;\r\nelse\r\ndesc_seq_ops = &fm10k_dbg_rx_desc_seq_ops;\r\nerr = seq_open(filep, desc_seq_ops);\r\nif (err)\r\nreturn err;\r\n((struct seq_file *)filep->private_data)->private = ring;\r\nreturn 0;\r\n}\r\nvoid fm10k_dbg_q_vector_init(struct fm10k_q_vector *q_vector)\r\n{\r\nstruct fm10k_intfc *interface = q_vector->interface;\r\nchar name[16];\r\nint i;\r\nif (!interface->dbg_intfc)\r\nreturn;\r\nsprintf(name, "q_vector.%03d", q_vector->v_idx);\r\nq_vector->dbg_q_vector = debugfs_create_dir(name, interface->dbg_intfc);\r\nif (!q_vector->dbg_q_vector)\r\nreturn;\r\nfor (i = 0; i < q_vector->tx.count; i++) {\r\nstruct fm10k_ring *ring = &q_vector->tx.ring[i];\r\nsprintf(name, "tx_ring.%03d", ring->queue_index);\r\ndebugfs_create_file(name, 0600,\r\nq_vector->dbg_q_vector, ring,\r\n&fm10k_dbg_desc_fops);\r\n}\r\nfor (i = 0; i < q_vector->rx.count; i++) {\r\nstruct fm10k_ring *ring = &q_vector->rx.ring[i];\r\nsprintf(name, "rx_ring.%03d", ring->queue_index);\r\ndebugfs_create_file(name, 0600,\r\nq_vector->dbg_q_vector, ring,\r\n&fm10k_dbg_desc_fops);\r\n}\r\n}\r\nvoid fm10k_dbg_q_vector_exit(struct fm10k_q_vector *q_vector)\r\n{\r\nstruct fm10k_intfc *interface = q_vector->interface;\r\nif (interface->dbg_intfc)\r\ndebugfs_remove_recursive(q_vector->dbg_q_vector);\r\nq_vector->dbg_q_vector = NULL;\r\n}\r\nvoid fm10k_dbg_intfc_init(struct fm10k_intfc *interface)\r\n{\r\nconst char *name = pci_name(interface->pdev);\r\nif (dbg_root)\r\ninterface->dbg_intfc = debugfs_create_dir(name, dbg_root);\r\n}\r\nvoid fm10k_dbg_intfc_exit(struct fm10k_intfc *interface)\r\n{\r\nif (dbg_root)\r\ndebugfs_remove_recursive(interface->dbg_intfc);\r\ninterface->dbg_intfc = NULL;\r\n}\r\nvoid fm10k_dbg_init(void)\r\n{\r\ndbg_root = debugfs_create_dir(fm10k_driver_name, NULL);\r\n}\r\nvoid fm10k_dbg_exit(void)\r\n{\r\ndebugfs_remove_recursive(dbg_root);\r\ndbg_root = NULL;\r\n}

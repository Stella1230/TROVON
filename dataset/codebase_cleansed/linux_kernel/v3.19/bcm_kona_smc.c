int __init bcm_kona_smc_init(void)\r\n{\r\nstruct device_node *node;\r\nconst __be32 *prop_val;\r\nu64 prop_size = 0;\r\nunsigned long buffer_size;\r\nu32 buffer_phys;\r\nnode = of_find_matching_node(NULL, bcm_kona_smc_ids);\r\nif (!node)\r\nreturn -ENODEV;\r\nprop_val = of_get_address(node, 0, &prop_size, NULL);\r\nif (!prop_val)\r\nreturn -EINVAL;\r\nif (prop_size < 4 * sizeof(u32) || prop_size > (u64)ULONG_MAX)\r\nreturn -EINVAL;\r\nbuffer_size = (unsigned long)prop_size;\r\nbuffer_phys = be32_to_cpup(prop_val);\r\nif (!buffer_phys)\r\nreturn -EINVAL;\r\nbcm_smc_buffer = ioremap(buffer_phys, buffer_size);\r\nif (!bcm_smc_buffer)\r\nreturn -ENOMEM;\r\nbcm_smc_buffer_phys = buffer_phys;\r\npr_info("Kona Secure API initialized\n");\r\nreturn 0;\r\n}\r\nstatic int bcm_kona_do_smc(u32 service_id, u32 buffer_phys)\r\n{\r\nregister u32 ip asm("ip");\r\nregister u32 r0 asm("r0");\r\nregister u32 r4 asm("r4");\r\nregister u32 r5 asm("r5");\r\nregister u32 r6 asm("r6");\r\nr4 = service_id;\r\nr5 = 0x3;\r\nr6 = buffer_phys;\r\nasm volatile (\r\n__asmeq("%0", "ip")\r\n__asmeq("%1", "r0")\r\n__asmeq("%2", "r4")\r\n__asmeq("%3", "r5")\r\n__asmeq("%4", "r6")\r\n#ifdef REQUIRES_SEC\r\n".arch_extension sec\n"\r\n#endif\r\n" smc #0\n"\r\n: "=r" (ip), "=r" (r0)\r\n: "r" (r4), "r" (r5), "r" (r6)\r\n: "r1", "r2", "r3", "r7", "lr");\r\nBUG_ON(ip != SEC_EXIT_NORMAL);\r\nreturn r0;\r\n}\r\nstatic void __bcm_kona_smc(void *info)\r\n{\r\nstruct bcm_kona_smc_data *data = info;\r\nu32 *args = bcm_smc_buffer;\r\nBUG_ON(smp_processor_id() != 0);\r\nBUG_ON(!args);\r\nwritel_relaxed(data->arg0, args++);\r\nwritel_relaxed(data->arg1, args++);\r\nwritel_relaxed(data->arg2, args++);\r\nwritel(data->arg3, args);\r\nflush_cache_all();\r\ndata->result = bcm_kona_do_smc(data->service_id, bcm_smc_buffer_phys);\r\n}\r\nunsigned bcm_kona_smc(unsigned service_id, unsigned arg0, unsigned arg1,\r\nunsigned arg2, unsigned arg3)\r\n{\r\nstruct bcm_kona_smc_data data;\r\ndata.service_id = service_id;\r\ndata.arg0 = arg0;\r\ndata.arg1 = arg1;\r\ndata.arg2 = arg2;\r\ndata.arg3 = arg3;\r\ndata.result = 0;\r\nsmp_call_function_single(0, __bcm_kona_smc, &data, 1);\r\nreturn data.result;\r\n}

static u32 dce6_endpoint_rreg(struct radeon_device *rdev,\r\nu32 block_offset, u32 reg)\r\n{\r\nunsigned long flags;\r\nu32 r;\r\nspin_lock_irqsave(&rdev->end_idx_lock, flags);\r\nWREG32(AZ_F0_CODEC_ENDPOINT_INDEX + block_offset, reg);\r\nr = RREG32(AZ_F0_CODEC_ENDPOINT_DATA + block_offset);\r\nspin_unlock_irqrestore(&rdev->end_idx_lock, flags);\r\nreturn r;\r\n}\r\nstatic void dce6_endpoint_wreg(struct radeon_device *rdev,\r\nu32 block_offset, u32 reg, u32 v)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&rdev->end_idx_lock, flags);\r\nif (ASIC_IS_DCE8(rdev))\r\nWREG32(AZ_F0_CODEC_ENDPOINT_INDEX + block_offset, reg);\r\nelse\r\nWREG32(AZ_F0_CODEC_ENDPOINT_INDEX + block_offset,\r\nAZ_ENDPOINT_REG_WRITE_EN | AZ_ENDPOINT_REG_INDEX(reg));\r\nWREG32(AZ_F0_CODEC_ENDPOINT_DATA + block_offset, v);\r\nspin_unlock_irqrestore(&rdev->end_idx_lock, flags);\r\n}\r\nstatic void dce6_afmt_get_connected_pins(struct radeon_device *rdev)\r\n{\r\nint i;\r\nu32 offset, tmp;\r\nfor (i = 0; i < rdev->audio.num_pins; i++) {\r\noffset = rdev->audio.pin[i].offset;\r\ntmp = RREG32_ENDPOINT(offset,\r\nAZ_F0_CODEC_PIN_CONTROL_RESPONSE_CONFIGURATION_DEFAULT);\r\nif (((tmp & PORT_CONNECTIVITY_MASK) >> PORT_CONNECTIVITY_SHIFT) == 1)\r\nrdev->audio.pin[i].connected = false;\r\nelse\r\nrdev->audio.pin[i].connected = true;\r\n}\r\n}\r\nstruct r600_audio_pin *dce6_audio_get_pin(struct radeon_device *rdev)\r\n{\r\nint i;\r\ndce6_afmt_get_connected_pins(rdev);\r\nfor (i = 0; i < rdev->audio.num_pins; i++) {\r\nif (rdev->audio.pin[i].connected)\r\nreturn &rdev->audio.pin[i];\r\n}\r\nDRM_ERROR("No connected audio pins found!\n");\r\nreturn NULL;\r\n}\r\nvoid dce6_afmt_select_pin(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nu32 offset;\r\nif (!dig || !dig->afmt || !dig->afmt->pin)\r\nreturn;\r\noffset = dig->afmt->offset;\r\nWREG32(AFMT_AUDIO_SRC_CONTROL + offset,\r\nAFMT_AUDIO_SRC_SELECT(dig->afmt->pin->id));\r\n}\r\nvoid dce6_afmt_write_latency_fields(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector = NULL;\r\nu32 tmp = 0, offset;\r\nif (!dig || !dig->afmt || !dig->afmt->pin)\r\nreturn;\r\noffset = dig->afmt->pin->offset;\r\nlist_for_each_entry(connector, &encoder->dev->mode_config.connector_list, head) {\r\nif (connector->encoder == encoder) {\r\nradeon_connector = to_radeon_connector(connector);\r\nbreak;\r\n}\r\n}\r\nif (!radeon_connector) {\r\nDRM_ERROR("Couldn't find encoder's connector\n");\r\nreturn;\r\n}\r\nif (mode->flags & DRM_MODE_FLAG_INTERLACE) {\r\nif (connector->latency_present[1])\r\ntmp = VIDEO_LIPSYNC(connector->video_latency[1]) |\r\nAUDIO_LIPSYNC(connector->audio_latency[1]);\r\nelse\r\ntmp = VIDEO_LIPSYNC(0) | AUDIO_LIPSYNC(0);\r\n} else {\r\nif (connector->latency_present[0])\r\ntmp = VIDEO_LIPSYNC(connector->video_latency[0]) |\r\nAUDIO_LIPSYNC(connector->audio_latency[0]);\r\nelse\r\ntmp = VIDEO_LIPSYNC(0) | AUDIO_LIPSYNC(0);\r\n}\r\nWREG32_ENDPOINT(offset, AZ_F0_CODEC_PIN_CONTROL_RESPONSE_LIPSYNC, tmp);\r\n}\r\nvoid dce6_afmt_write_speaker_allocation(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector = NULL;\r\nu32 offset, tmp;\r\nu8 *sadb = NULL;\r\nint sad_count;\r\nif (!dig || !dig->afmt || !dig->afmt->pin)\r\nreturn;\r\noffset = dig->afmt->pin->offset;\r\nlist_for_each_entry(connector, &encoder->dev->mode_config.connector_list, head) {\r\nif (connector->encoder == encoder) {\r\nradeon_connector = to_radeon_connector(connector);\r\nbreak;\r\n}\r\n}\r\nif (!radeon_connector) {\r\nDRM_ERROR("Couldn't find encoder's connector\n");\r\nreturn;\r\n}\r\nsad_count = drm_edid_to_speaker_allocation(radeon_connector_edid(connector), &sadb);\r\nif (sad_count < 0) {\r\nDRM_DEBUG("Couldn't read Speaker Allocation Data Block: %d\n", sad_count);\r\nsad_count = 0;\r\n}\r\ntmp = RREG32_ENDPOINT(offset, AZ_F0_CODEC_PIN_CONTROL_CHANNEL_SPEAKER);\r\ntmp &= ~(DP_CONNECTION | SPEAKER_ALLOCATION_MASK);\r\ntmp |= HDMI_CONNECTION;\r\nif (sad_count)\r\ntmp |= SPEAKER_ALLOCATION(sadb[0]);\r\nelse\r\ntmp |= SPEAKER_ALLOCATION(5);\r\nWREG32_ENDPOINT(offset, AZ_F0_CODEC_PIN_CONTROL_CHANNEL_SPEAKER, tmp);\r\nkfree(sadb);\r\n}\r\nvoid dce6_afmt_write_sad_regs(struct drm_encoder *encoder)\r\n{\r\nstruct radeon_device *rdev = encoder->dev->dev_private;\r\nstruct radeon_encoder *radeon_encoder = to_radeon_encoder(encoder);\r\nstruct radeon_encoder_atom_dig *dig = radeon_encoder->enc_priv;\r\nu32 offset;\r\nstruct drm_connector *connector;\r\nstruct radeon_connector *radeon_connector = NULL;\r\nstruct cea_sad *sads;\r\nint i, sad_count;\r\nstatic const u16 eld_reg_to_type[][2] = {\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR0, HDMI_AUDIO_CODING_TYPE_PCM },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR1, HDMI_AUDIO_CODING_TYPE_AC3 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR2, HDMI_AUDIO_CODING_TYPE_MPEG1 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR3, HDMI_AUDIO_CODING_TYPE_MP3 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR4, HDMI_AUDIO_CODING_TYPE_MPEG2 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR5, HDMI_AUDIO_CODING_TYPE_AAC_LC },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR6, HDMI_AUDIO_CODING_TYPE_DTS },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR7, HDMI_AUDIO_CODING_TYPE_ATRAC },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR9, HDMI_AUDIO_CODING_TYPE_EAC3 },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR10, HDMI_AUDIO_CODING_TYPE_DTS_HD },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR11, HDMI_AUDIO_CODING_TYPE_MLP },\r\n{ AZ_F0_CODEC_PIN_CONTROL_AUDIO_DESCRIPTOR13, HDMI_AUDIO_CODING_TYPE_WMA_PRO },\r\n};\r\nif (!dig || !dig->afmt || !dig->afmt->pin)\r\nreturn;\r\noffset = dig->afmt->pin->offset;\r\nlist_for_each_entry(connector, &encoder->dev->mode_config.connector_list, head) {\r\nif (connector->encoder == encoder) {\r\nradeon_connector = to_radeon_connector(connector);\r\nbreak;\r\n}\r\n}\r\nif (!radeon_connector) {\r\nDRM_ERROR("Couldn't find encoder's connector\n");\r\nreturn;\r\n}\r\nsad_count = drm_edid_to_sad(radeon_connector_edid(connector), &sads);\r\nif (sad_count <= 0) {\r\nDRM_ERROR("Couldn't read SADs: %d\n", sad_count);\r\nreturn;\r\n}\r\nBUG_ON(!sads);\r\nfor (i = 0; i < ARRAY_SIZE(eld_reg_to_type); i++) {\r\nu32 value = 0;\r\nu8 stereo_freqs = 0;\r\nint max_channels = -1;\r\nint j;\r\nfor (j = 0; j < sad_count; j++) {\r\nstruct cea_sad *sad = &sads[j];\r\nif (sad->format == eld_reg_to_type[i][1]) {\r\nif (sad->channels > max_channels) {\r\nvalue = MAX_CHANNELS(sad->channels) |\r\nDESCRIPTOR_BYTE_2(sad->byte2) |\r\nSUPPORTED_FREQUENCIES(sad->freq);\r\nmax_channels = sad->channels;\r\n}\r\nif (sad->format == HDMI_AUDIO_CODING_TYPE_PCM)\r\nstereo_freqs |= sad->freq;\r\nelse\r\nbreak;\r\n}\r\n}\r\nvalue |= SUPPORTED_FREQUENCIES_STEREO(stereo_freqs);\r\nWREG32_ENDPOINT(offset, eld_reg_to_type[i][0], value);\r\n}\r\nkfree(sads);\r\n}\r\nstatic int dce6_audio_chipset_supported(struct radeon_device *rdev)\r\n{\r\nreturn !ASIC_IS_NODCE(rdev);\r\n}\r\nvoid dce6_audio_enable(struct radeon_device *rdev,\r\nstruct r600_audio_pin *pin,\r\nu8 enable_mask)\r\n{\r\nif (!pin)\r\nreturn;\r\nWREG32_ENDPOINT(pin->offset, AZ_F0_CODEC_PIN_CONTROL_HOT_PLUG_CONTROL,\r\nenable_mask ? AUDIO_ENABLED : 0);\r\n}\r\nint dce6_audio_init(struct radeon_device *rdev)\r\n{\r\nint i;\r\nif (!radeon_audio || !dce6_audio_chipset_supported(rdev))\r\nreturn 0;\r\nrdev->audio.enabled = true;\r\nif (ASIC_IS_DCE81(rdev))\r\nrdev->audio.num_pins = 7;\r\nelse if (ASIC_IS_DCE83(rdev))\r\nrdev->audio.num_pins = 3;\r\nelse if (ASIC_IS_DCE8(rdev))\r\nrdev->audio.num_pins = 7;\r\nelse if (ASIC_IS_DCE61(rdev))\r\nrdev->audio.num_pins = 6;\r\nelse if (ASIC_IS_DCE64(rdev))\r\nrdev->audio.num_pins = 2;\r\nelse\r\nrdev->audio.num_pins = 6;\r\nfor (i = 0; i < rdev->audio.num_pins; i++) {\r\nrdev->audio.pin[i].channels = -1;\r\nrdev->audio.pin[i].rate = -1;\r\nrdev->audio.pin[i].bits_per_sample = -1;\r\nrdev->audio.pin[i].status_bits = 0;\r\nrdev->audio.pin[i].category_code = 0;\r\nrdev->audio.pin[i].connected = false;\r\nrdev->audio.pin[i].offset = pin_offsets[i];\r\nrdev->audio.pin[i].id = i;\r\ndce6_audio_enable(rdev, &rdev->audio.pin[i], false);\r\n}\r\nreturn 0;\r\n}\r\nvoid dce6_audio_fini(struct radeon_device *rdev)\r\n{\r\nint i;\r\nif (!rdev->audio.enabled)\r\nreturn;\r\nfor (i = 0; i < rdev->audio.num_pins; i++)\r\ndce6_audio_enable(rdev, &rdev->audio.pin[i], false);\r\nrdev->audio.enabled = false;\r\n}

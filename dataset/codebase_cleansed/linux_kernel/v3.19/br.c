static int br_device_event(struct notifier_block *unused, unsigned long event, void *ptr)\r\n{\r\nstruct net_device *dev = netdev_notifier_info_to_dev(ptr);\r\nstruct net_bridge_port *p;\r\nstruct net_bridge *br;\r\nbool changed_addr;\r\nint err;\r\nif ((dev->priv_flags & IFF_EBRIDGE) && event == NETDEV_REGISTER) {\r\nbr_sysfs_addbr(dev);\r\nreturn NOTIFY_DONE;\r\n}\r\np = br_port_get_rtnl(dev);\r\nif (!p)\r\nreturn NOTIFY_DONE;\r\nbr = p->br;\r\nswitch (event) {\r\ncase NETDEV_CHANGEMTU:\r\ndev_set_mtu(br->dev, br_min_mtu(br));\r\nbreak;\r\ncase NETDEV_CHANGEADDR:\r\nspin_lock_bh(&br->lock);\r\nbr_fdb_changeaddr(p, dev->dev_addr);\r\nchanged_addr = br_stp_recalculate_bridge_id(br);\r\nspin_unlock_bh(&br->lock);\r\nif (changed_addr)\r\ncall_netdevice_notifiers(NETDEV_CHANGEADDR, br->dev);\r\nbreak;\r\ncase NETDEV_CHANGE:\r\nbr_port_carrier_check(p);\r\nbreak;\r\ncase NETDEV_FEAT_CHANGE:\r\nnetdev_update_features(br->dev);\r\nbreak;\r\ncase NETDEV_DOWN:\r\nspin_lock_bh(&br->lock);\r\nif (br->dev->flags & IFF_UP)\r\nbr_stp_disable_port(p);\r\nspin_unlock_bh(&br->lock);\r\nbreak;\r\ncase NETDEV_UP:\r\nif (netif_running(br->dev) && netif_oper_up(dev)) {\r\nspin_lock_bh(&br->lock);\r\nbr_stp_enable_port(p);\r\nspin_unlock_bh(&br->lock);\r\n}\r\nbreak;\r\ncase NETDEV_UNREGISTER:\r\nbr_del_if(br, dev);\r\nbreak;\r\ncase NETDEV_CHANGENAME:\r\nerr = br_sysfs_renameif(p);\r\nif (err)\r\nreturn notifier_from_errno(err);\r\nbreak;\r\ncase NETDEV_PRE_TYPE_CHANGE:\r\nreturn NOTIFY_BAD;\r\ncase NETDEV_RESEND_IGMP:\r\ncall_netdevice_notifiers(event, br->dev);\r\nbreak;\r\n}\r\nif (event == NETDEV_CHANGEADDR || event == NETDEV_UP ||\r\nevent == NETDEV_CHANGE || event == NETDEV_DOWN)\r\nbr_ifinfo_notify(RTM_NEWLINK, p);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic void __net_exit br_net_exit(struct net *net)\r\n{\r\nstruct net_device *dev;\r\nLIST_HEAD(list);\r\nrtnl_lock();\r\nfor_each_netdev(net, dev)\r\nif (dev->priv_flags & IFF_EBRIDGE)\r\nbr_dev_delete(dev, &list);\r\nunregister_netdevice_many(&list);\r\nrtnl_unlock();\r\n}\r\nstatic int __init br_init(void)\r\n{\r\nint err;\r\nerr = stp_proto_register(&br_stp_proto);\r\nif (err < 0) {\r\npr_err("bridge: can't register sap for STP\n");\r\nreturn err;\r\n}\r\nerr = br_fdb_init();\r\nif (err)\r\ngoto err_out;\r\nerr = register_pernet_subsys(&br_net_ops);\r\nif (err)\r\ngoto err_out1;\r\nerr = br_nf_core_init();\r\nif (err)\r\ngoto err_out2;\r\nerr = register_netdevice_notifier(&br_device_notifier);\r\nif (err)\r\ngoto err_out3;\r\nerr = br_netlink_init();\r\nif (err)\r\ngoto err_out4;\r\nbrioctl_set(br_ioctl_deviceless_stub);\r\n#if IS_ENABLED(CONFIG_ATM_LANE)\r\nbr_fdb_test_addr_hook = br_fdb_test_addr;\r\n#endif\r\npr_info("bridge: automatic filtering via arp/ip/ip6tables has been "\r\n"deprecated. Update your scripts to load br_netfilter if you "\r\n"need this.\n");\r\nreturn 0;\r\nerr_out4:\r\nunregister_netdevice_notifier(&br_device_notifier);\r\nerr_out3:\r\nbr_nf_core_fini();\r\nerr_out2:\r\nunregister_pernet_subsys(&br_net_ops);\r\nerr_out1:\r\nbr_fdb_fini();\r\nerr_out:\r\nstp_proto_unregister(&br_stp_proto);\r\nreturn err;\r\n}\r\nstatic void __exit br_deinit(void)\r\n{\r\nstp_proto_unregister(&br_stp_proto);\r\nbr_netlink_fini();\r\nunregister_netdevice_notifier(&br_device_notifier);\r\nbrioctl_set(NULL);\r\nunregister_pernet_subsys(&br_net_ops);\r\nrcu_barrier();\r\nbr_nf_core_fini();\r\n#if IS_ENABLED(CONFIG_ATM_LANE)\r\nbr_fdb_test_addr_hook = NULL;\r\n#endif\r\nbr_fdb_fini();\r\n}

static ssize_t igb_hwmon_show_location(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nreturn sprintf(buf, "loc%u\n",\r\nigb_attr->sensor->location);\r\n}\r\nstatic ssize_t igb_hwmon_show_temp(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nunsigned int value;\r\nigb_attr->hw->mac.ops.get_thermal_sensor_data(igb_attr->hw);\r\nvalue = igb_attr->sensor->temp;\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%u\n", value);\r\n}\r\nstatic ssize_t igb_hwmon_show_cautionthresh(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nunsigned int value = igb_attr->sensor->caution_thresh;\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%u\n", value);\r\n}\r\nstatic ssize_t igb_hwmon_show_maxopthresh(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct hwmon_attr *igb_attr = container_of(attr, struct hwmon_attr,\r\ndev_attr);\r\nunsigned int value = igb_attr->sensor->max_op_thresh;\r\nvalue *= 1000;\r\nreturn sprintf(buf, "%u\n", value);\r\n}\r\nstatic int igb_add_hwmon_attr(struct igb_adapter *adapter,\r\nunsigned int offset, int type)\r\n{\r\nint rc;\r\nunsigned int n_attr;\r\nstruct hwmon_attr *igb_attr;\r\nn_attr = adapter->igb_hwmon_buff->n_hwmon;\r\nigb_attr = &adapter->igb_hwmon_buff->hwmon_list[n_attr];\r\nswitch (type) {\r\ncase IGB_HWMON_TYPE_LOC:\r\nigb_attr->dev_attr.show = igb_hwmon_show_location;\r\nsnprintf(igb_attr->name, sizeof(igb_attr->name),\r\n"temp%u_label", offset + 1);\r\nbreak;\r\ncase IGB_HWMON_TYPE_TEMP:\r\nigb_attr->dev_attr.show = igb_hwmon_show_temp;\r\nsnprintf(igb_attr->name, sizeof(igb_attr->name),\r\n"temp%u_input", offset + 1);\r\nbreak;\r\ncase IGB_HWMON_TYPE_CAUTION:\r\nigb_attr->dev_attr.show = igb_hwmon_show_cautionthresh;\r\nsnprintf(igb_attr->name, sizeof(igb_attr->name),\r\n"temp%u_max", offset + 1);\r\nbreak;\r\ncase IGB_HWMON_TYPE_MAX:\r\nigb_attr->dev_attr.show = igb_hwmon_show_maxopthresh;\r\nsnprintf(igb_attr->name, sizeof(igb_attr->name),\r\n"temp%u_crit", offset + 1);\r\nbreak;\r\ndefault:\r\nrc = -EPERM;\r\nreturn rc;\r\n}\r\nigb_attr->sensor =\r\n&adapter->hw.mac.thermal_sensor_data.sensor[offset];\r\nigb_attr->hw = &adapter->hw;\r\nigb_attr->dev_attr.store = NULL;\r\nigb_attr->dev_attr.attr.mode = S_IRUGO;\r\nigb_attr->dev_attr.attr.name = igb_attr->name;\r\nsysfs_attr_init(&igb_attr->dev_attr.attr);\r\nadapter->igb_hwmon_buff->attrs[n_attr] = &igb_attr->dev_attr.attr;\r\n++adapter->igb_hwmon_buff->n_hwmon;\r\nreturn 0;\r\n}\r\nstatic void igb_sysfs_del_adapter(struct igb_adapter *adapter)\r\n{\r\n}\r\nvoid igb_sysfs_exit(struct igb_adapter *adapter)\r\n{\r\nigb_sysfs_del_adapter(adapter);\r\n}\r\nint igb_sysfs_init(struct igb_adapter *adapter)\r\n{\r\nstruct hwmon_buff *igb_hwmon;\r\nstruct i2c_client *client;\r\nstruct device *hwmon_dev;\r\nunsigned int i;\r\nint rc = 0;\r\nif (adapter->hw.mac.ops.init_thermal_sensor_thresh == NULL)\r\ngoto exit;\r\nrc = (adapter->hw.mac.ops.init_thermal_sensor_thresh(&adapter->hw));\r\nif (rc)\r\ngoto exit;\r\nigb_hwmon = devm_kzalloc(&adapter->pdev->dev, sizeof(*igb_hwmon),\r\nGFP_KERNEL);\r\nif (!igb_hwmon) {\r\nrc = -ENOMEM;\r\ngoto exit;\r\n}\r\nadapter->igb_hwmon_buff = igb_hwmon;\r\nfor (i = 0; i < E1000_MAX_SENSORS; i++) {\r\nif (adapter->hw.mac.thermal_sensor_data.sensor[i].location == 0)\r\ncontinue;\r\nrc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_CAUTION);\r\nif (rc)\r\ngoto exit;\r\nrc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_LOC);\r\nif (rc)\r\ngoto exit;\r\nrc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_TEMP);\r\nif (rc)\r\ngoto exit;\r\nrc = igb_add_hwmon_attr(adapter, i, IGB_HWMON_TYPE_MAX);\r\nif (rc)\r\ngoto exit;\r\n}\r\nclient = i2c_new_device(&adapter->i2c_adap, &i350_sensor_info);\r\nif (client == NULL) {\r\ndev_info(&adapter->pdev->dev,\r\n"Failed to create new i2c device.\n");\r\nrc = -ENODEV;\r\ngoto exit;\r\n}\r\nadapter->i2c_client = client;\r\nigb_hwmon->groups[0] = &igb_hwmon->group;\r\nigb_hwmon->group.attrs = igb_hwmon->attrs;\r\nhwmon_dev = devm_hwmon_device_register_with_groups(&adapter->pdev->dev,\r\nclient->name,\r\nigb_hwmon,\r\nigb_hwmon->groups);\r\nif (IS_ERR(hwmon_dev)) {\r\nrc = PTR_ERR(hwmon_dev);\r\ngoto err;\r\n}\r\ngoto exit;\r\nerr:\r\nigb_sysfs_del_adapter(adapter);\r\nexit:\r\nreturn rc;\r\n}

static inline long bnx2x_hilo(u32 *hiref)\r\n{\r\nu32 lo = *(hiref + 1);\r\n#if (BITS_PER_LONG == 64)\r\nu32 hi = *hiref;\r\nreturn HILO_U64(hi, lo);\r\n#else\r\nreturn lo;\r\n#endif\r\n}\r\nstatic inline u16 bnx2x_get_port_stats_dma_len(struct bnx2x *bp)\r\n{\r\nu16 res = 0;\r\nif (SHMEM2_HAS(bp, sizeof_port_stats)) {\r\nu32 size = SHMEM2_RD(bp, sizeof_port_stats);\r\nif (size)\r\nres = size;\r\nif (res > sizeof(struct host_port_stats))\r\nres = sizeof(struct host_port_stats);\r\n}\r\nif (!res) {\r\nres = offsetof(struct host_port_stats, not_used) + 4;\r\nif (bp->flags & BC_SUPPORTS_PFC_STATS) {\r\nres += offsetof(struct host_port_stats,\r\npfc_frames_rx_lo) -\r\noffsetof(struct host_port_stats,\r\npfc_frames_tx_hi) + 4 ;\r\n}\r\n}\r\nres >>= 2;\r\nWARN_ON(res > 2 * DMAE_LEN32_RD_MAX);\r\nreturn res;\r\n}\r\nstatic void bnx2x_dp_stats(struct bnx2x *bp)\r\n{\r\nint i;\r\nDP(BNX2X_MSG_STATS, "dumping stats:\n"\r\n"fw_stats_req\n"\r\n" hdr\n"\r\n" cmd_num %d\n"\r\n" reserved0 %d\n"\r\n" drv_stats_counter %d\n"\r\n" reserved1 %d\n"\r\n" stats_counters_addrs %x %x\n",\r\nbp->fw_stats_req->hdr.cmd_num,\r\nbp->fw_stats_req->hdr.reserved0,\r\nbp->fw_stats_req->hdr.drv_stats_counter,\r\nbp->fw_stats_req->hdr.reserved1,\r\nbp->fw_stats_req->hdr.stats_counters_addrs.hi,\r\nbp->fw_stats_req->hdr.stats_counters_addrs.lo);\r\nfor (i = 0; i < bp->fw_stats_req->hdr.cmd_num; i++) {\r\nDP(BNX2X_MSG_STATS,\r\n"query[%d]\n"\r\n" kind %d\n"\r\n" index %d\n"\r\n" funcID %d\n"\r\n" reserved %d\n"\r\n" address %x %x\n",\r\ni, bp->fw_stats_req->query[i].kind,\r\nbp->fw_stats_req->query[i].index,\r\nbp->fw_stats_req->query[i].funcID,\r\nbp->fw_stats_req->query[i].reserved,\r\nbp->fw_stats_req->query[i].address.hi,\r\nbp->fw_stats_req->query[i].address.lo);\r\n}\r\n}\r\nstatic void bnx2x_storm_stats_post(struct bnx2x *bp)\r\n{\r\nif (!bp->stats_pending) {\r\nint rc;\r\nspin_lock_bh(&bp->stats_lock);\r\nif (bp->stats_pending) {\r\nspin_unlock_bh(&bp->stats_lock);\r\nreturn;\r\n}\r\nbp->fw_stats_req->hdr.drv_stats_counter =\r\ncpu_to_le16(bp->stats_counter++);\r\nDP(BNX2X_MSG_STATS, "Sending statistics ramrod %d\n",\r\nle16_to_cpu(bp->fw_stats_req->hdr.drv_stats_counter));\r\nbnx2x_iov_adjust_stats_req(bp);\r\nbnx2x_dp_stats(bp);\r\nrc = bnx2x_sp_post(bp, RAMROD_CMD_ID_COMMON_STAT_QUERY, 0,\r\nU64_HI(bp->fw_stats_req_mapping),\r\nU64_LO(bp->fw_stats_req_mapping),\r\nNONE_CONNECTION_TYPE);\r\nif (rc == 0)\r\nbp->stats_pending = 1;\r\nspin_unlock_bh(&bp->stats_lock);\r\n}\r\n}\r\nstatic void bnx2x_hw_stats_post(struct bnx2x *bp)\r\n{\r\nstruct dmae_command *dmae = &bp->stats_dmae;\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\n*stats_comp = DMAE_COMP_VAL;\r\nif (CHIP_REV_IS_SLOW(bp))\r\nreturn;\r\nif (bp->func_stx)\r\nmemcpy(bnx2x_sp(bp, func_stats), &bp->func_stats,\r\nsizeof(bp->func_stats));\r\nif (bp->executer_idx) {\r\nint loader_idx = PMF_DMAE_C(bp);\r\nu32 opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\r\ntrue, DMAE_COMP_GRC);\r\nopcode = bnx2x_dmae_opcode_clr_src_reset(opcode);\r\nmemset(dmae, 0, sizeof(struct dmae_command));\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, dmae[0]));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, dmae[0]));\r\ndmae->dst_addr_lo = (DMAE_REG_CMD_MEM +\r\nsizeof(struct dmae_command) *\r\n(loader_idx + 1)) >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = sizeof(struct dmae_command) >> 2;\r\nif (CHIP_IS_E1(bp))\r\ndmae->len--;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx + 1] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n*stats_comp = 0;\r\nbnx2x_post_dmae(bp, dmae, loader_idx);\r\n} else if (bp->func_stx) {\r\n*stats_comp = 0;\r\nbnx2x_issue_dmae_with_comp(bp, dmae, stats_comp);\r\n}\r\n}\r\nstatic void bnx2x_stats_comp(struct bnx2x *bp)\r\n{\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nint cnt = 10;\r\nmight_sleep();\r\nwhile (*stats_comp != DMAE_COMP_VAL) {\r\nif (!cnt) {\r\nBNX2X_ERR("timeout waiting for stats finished\n");\r\nbreak;\r\n}\r\ncnt--;\r\nusleep_range(1000, 2000);\r\n}\r\n}\r\nstatic void __bnx2x_stats_pmf_update(struct bnx2x *bp)\r\n{\r\nstruct dmae_command *dmae;\r\nu32 opcode;\r\nint loader_idx = PMF_DMAE_C(bp);\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nif (!bp->port.pmf || !bp->port.port_stx) {\r\nBNX2X_ERR("BUG!\n");\r\nreturn;\r\n}\r\nbp->executer_idx = 0;\r\nopcode = bnx2x_dmae_opcode(bp, DMAE_SRC_GRC, DMAE_DST_PCI, false, 0);\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = bnx2x_dmae_opcode_add_comp(opcode, DMAE_COMP_GRC);\r\ndmae->src_addr_lo = bp->port.port_stx >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->len = DMAE_LEN32_RD_MAX;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = bnx2x_dmae_opcode_add_comp(opcode, DMAE_COMP_PCI);\r\ndmae->src_addr_lo = (bp->port.port_stx >> 2) + DMAE_LEN32_RD_MAX;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats) +\r\nDMAE_LEN32_RD_MAX * 4);\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats) +\r\nDMAE_LEN32_RD_MAX * 4);\r\ndmae->len = bnx2x_get_port_stats_dma_len(bp) - DMAE_LEN32_RD_MAX;\r\ndmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_val = DMAE_COMP_VAL;\r\n*stats_comp = 0;\r\nbnx2x_hw_stats_post(bp);\r\nbnx2x_stats_comp(bp);\r\n}\r\nstatic void bnx2x_port_stats_init(struct bnx2x *bp)\r\n{\r\nstruct dmae_command *dmae;\r\nint port = BP_PORT(bp);\r\nu32 opcode;\r\nint loader_idx = PMF_DMAE_C(bp);\r\nu32 mac_addr;\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nif (!bp->link_vars.link_up || !bp->port.pmf) {\r\nBNX2X_ERR("BUG!\n");\r\nreturn;\r\n}\r\nbp->executer_idx = 0;\r\nopcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\r\ntrue, DMAE_COMP_GRC);\r\nif (bp->port.port_stx) {\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->dst_addr_lo = bp->port.port_stx >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = bnx2x_get_port_stats_dma_len(bp);\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n}\r\nif (bp->func_stx) {\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, func_stats));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, func_stats));\r\ndmae->dst_addr_lo = bp->func_stx >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = sizeof(struct host_func_stats) >> 2;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n}\r\nopcode = bnx2x_dmae_opcode(bp, DMAE_SRC_GRC, DMAE_DST_PCI,\r\ntrue, DMAE_COMP_GRC);\r\nif (bp->link_vars.mac_type == MAC_TYPE_EMAC) {\r\nmac_addr = (port ? GRCBASE_EMAC1 : GRCBASE_EMAC0);\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = (mac_addr +\r\nEMAC_REG_EMAC_RX_STAT_AC) >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats));\r\ndmae->len = EMAC_REG_EMAC_RX_STAT_AC_COUNT;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = (mac_addr +\r\nEMAC_REG_EMAC_RX_STAT_AC_28) >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats) +\r\noffsetof(struct emac_stats, rx_stat_falsecarriererrors));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats) +\r\noffsetof(struct emac_stats, rx_stat_falsecarriererrors));\r\ndmae->len = 1;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = (mac_addr +\r\nEMAC_REG_EMAC_TX_STAT_AC) >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats) +\r\noffsetof(struct emac_stats, tx_stat_ifhcoutoctets));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats) +\r\noffsetof(struct emac_stats, tx_stat_ifhcoutoctets));\r\ndmae->len = EMAC_REG_EMAC_TX_STAT_AC_COUNT;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n} else {\r\nu32 tx_src_addr_lo, rx_src_addr_lo;\r\nu16 rx_len, tx_len;\r\nswitch (bp->link_vars.mac_type) {\r\ncase MAC_TYPE_BMAC:\r\nmac_addr = (port ? NIG_REG_INGRESS_BMAC1_MEM :\r\nNIG_REG_INGRESS_BMAC0_MEM);\r\nif (CHIP_IS_E1x(bp)) {\r\ntx_src_addr_lo = (mac_addr +\r\nBIGMAC_REGISTER_TX_STAT_GTPKT) >> 2;\r\ntx_len = (8 + BIGMAC_REGISTER_TX_STAT_GTBYT -\r\nBIGMAC_REGISTER_TX_STAT_GTPKT) >> 2;\r\nrx_src_addr_lo = (mac_addr +\r\nBIGMAC_REGISTER_RX_STAT_GR64) >> 2;\r\nrx_len = (8 + BIGMAC_REGISTER_RX_STAT_GRIPJ -\r\nBIGMAC_REGISTER_RX_STAT_GR64) >> 2;\r\n} else {\r\ntx_src_addr_lo = (mac_addr +\r\nBIGMAC2_REGISTER_TX_STAT_GTPOK) >> 2;\r\ntx_len = (8 + BIGMAC2_REGISTER_TX_STAT_GTBYT -\r\nBIGMAC2_REGISTER_TX_STAT_GTPOK) >> 2;\r\nrx_src_addr_lo = (mac_addr +\r\nBIGMAC2_REGISTER_RX_STAT_GR64) >> 2;\r\nrx_len = (8 + BIGMAC2_REGISTER_RX_STAT_GRIPJ -\r\nBIGMAC2_REGISTER_RX_STAT_GR64) >> 2;\r\n}\r\nbreak;\r\ncase MAC_TYPE_UMAC:\r\ncase MAC_TYPE_XMAC:\r\ndefault:\r\nmac_addr = port ? GRCBASE_MSTAT1 : GRCBASE_MSTAT0;\r\ntx_src_addr_lo = (mac_addr +\r\nMSTAT_REG_TX_STAT_GTXPOK_LO) >> 2;\r\nrx_src_addr_lo = (mac_addr +\r\nMSTAT_REG_RX_STAT_GR64_LO) >> 2;\r\ntx_len = sizeof(bp->slowpath->\r\nmac_stats.mstat_stats.stats_tx) >> 2;\r\nrx_len = sizeof(bp->slowpath->\r\nmac_stats.mstat_stats.stats_rx) >> 2;\r\nbreak;\r\n}\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = tx_src_addr_lo;\r\ndmae->src_addr_hi = 0;\r\ndmae->len = tx_len;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, mac_stats));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, mac_stats));\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_hi = 0;\r\ndmae->src_addr_lo = rx_src_addr_lo;\r\ndmae->dst_addr_lo =\r\nU64_LO(bnx2x_sp_mapping(bp, mac_stats) + (tx_len << 2));\r\ndmae->dst_addr_hi =\r\nU64_HI(bnx2x_sp_mapping(bp, mac_stats) + (tx_len << 2));\r\ndmae->len = rx_len;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n}\r\nif (!CHIP_IS_E3(bp)) {\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = (port ? NIG_REG_STAT1_EGRESS_MAC_PKT0 :\r\nNIG_REG_STAT0_EGRESS_MAC_PKT0) >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, nig_stats) +\r\noffsetof(struct nig_stats, egress_mac_pkt0_lo));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, nig_stats) +\r\noffsetof(struct nig_stats, egress_mac_pkt0_lo));\r\ndmae->len = (2*sizeof(u32)) >> 2;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = opcode;\r\ndmae->src_addr_lo = (port ? NIG_REG_STAT1_EGRESS_MAC_PKT1 :\r\nNIG_REG_STAT0_EGRESS_MAC_PKT1) >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, nig_stats) +\r\noffsetof(struct nig_stats, egress_mac_pkt1_lo));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, nig_stats) +\r\noffsetof(struct nig_stats, egress_mac_pkt1_lo));\r\ndmae->len = (2*sizeof(u32)) >> 2;\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n}\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_GRC, DMAE_DST_PCI,\r\ntrue, DMAE_COMP_PCI);\r\ndmae->src_addr_lo = (port ? NIG_REG_STAT1_BRB_DISCARD :\r\nNIG_REG_STAT0_BRB_DISCARD) >> 2;\r\ndmae->src_addr_hi = 0;\r\ndmae->dst_addr_lo = U64_LO(bnx2x_sp_mapping(bp, nig_stats));\r\ndmae->dst_addr_hi = U64_HI(bnx2x_sp_mapping(bp, nig_stats));\r\ndmae->len = (sizeof(struct nig_stats) - 4*sizeof(u32)) >> 2;\r\ndmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_val = DMAE_COMP_VAL;\r\n*stats_comp = 0;\r\n}\r\nstatic void bnx2x_func_stats_init(struct bnx2x *bp)\r\n{\r\nstruct dmae_command *dmae = &bp->stats_dmae;\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nif (!bp->func_stx) {\r\nBNX2X_ERR("BUG!\n");\r\nreturn;\r\n}\r\nbp->executer_idx = 0;\r\nmemset(dmae, 0, sizeof(struct dmae_command));\r\ndmae->opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\r\ntrue, DMAE_COMP_PCI);\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, func_stats));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, func_stats));\r\ndmae->dst_addr_lo = bp->func_stx >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = sizeof(struct host_func_stats) >> 2;\r\ndmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_val = DMAE_COMP_VAL;\r\n*stats_comp = 0;\r\n}\r\nstatic void __bnx2x_stats_start(struct bnx2x *bp)\r\n{\r\nif (IS_PF(bp)) {\r\nif (bp->port.pmf)\r\nbnx2x_port_stats_init(bp);\r\nelse if (bp->func_stx)\r\nbnx2x_func_stats_init(bp);\r\nbnx2x_hw_stats_post(bp);\r\nbnx2x_storm_stats_post(bp);\r\n}\r\nbp->stats_started = true;\r\n}\r\nstatic void bnx2x_stats_start(struct bnx2x *bp)\r\n{\r\nif (down_timeout(&bp->stats_sema, HZ/10))\r\nBNX2X_ERR("Unable to acquire stats lock\n");\r\n__bnx2x_stats_start(bp);\r\nup(&bp->stats_sema);\r\n}\r\nstatic void bnx2x_stats_pmf_start(struct bnx2x *bp)\r\n{\r\nif (down_timeout(&bp->stats_sema, HZ/10))\r\nBNX2X_ERR("Unable to acquire stats lock\n");\r\nbnx2x_stats_comp(bp);\r\n__bnx2x_stats_pmf_update(bp);\r\n__bnx2x_stats_start(bp);\r\nup(&bp->stats_sema);\r\n}\r\nstatic void bnx2x_stats_pmf_update(struct bnx2x *bp)\r\n{\r\nif (down_timeout(&bp->stats_sema, HZ/10))\r\nBNX2X_ERR("Unable to acquire stats lock\n");\r\n__bnx2x_stats_pmf_update(bp);\r\nup(&bp->stats_sema);\r\n}\r\nstatic void bnx2x_stats_restart(struct bnx2x *bp)\r\n{\r\nif (IS_VF(bp))\r\nreturn;\r\nif (down_timeout(&bp->stats_sema, HZ/10))\r\nBNX2X_ERR("Unable to acquire stats lock\n");\r\nbnx2x_stats_comp(bp);\r\n__bnx2x_stats_start(bp);\r\nup(&bp->stats_sema);\r\n}\r\nstatic void bnx2x_bmac_stats_update(struct bnx2x *bp)\r\n{\r\nstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct {\r\nu32 lo;\r\nu32 hi;\r\n} diff;\r\nif (CHIP_IS_E1x(bp)) {\r\nstruct bmac1_stats *new = bnx2x_sp(bp, mac_stats.bmac1_stats);\r\nUPDATE_STAT64(rx_stat_grerb, rx_stat_ifhcinbadoctets);\r\nUPDATE_STAT64(rx_stat_grfcs, rx_stat_dot3statsfcserrors);\r\nUPDATE_STAT64(rx_stat_grund, rx_stat_etherstatsundersizepkts);\r\nUPDATE_STAT64(rx_stat_grovr, rx_stat_dot3statsframestoolong);\r\nUPDATE_STAT64(rx_stat_grfrg, rx_stat_etherstatsfragments);\r\nUPDATE_STAT64(rx_stat_grjbr, rx_stat_etherstatsjabbers);\r\nUPDATE_STAT64(rx_stat_grxcf, rx_stat_maccontrolframesreceived);\r\nUPDATE_STAT64(rx_stat_grxpf, rx_stat_xoffstateentered);\r\nUPDATE_STAT64(rx_stat_grxpf, rx_stat_mac_xpf);\r\nUPDATE_STAT64(tx_stat_gtxpf, tx_stat_outxoffsent);\r\nUPDATE_STAT64(tx_stat_gtxpf, tx_stat_flowcontroldone);\r\nUPDATE_STAT64(tx_stat_gt64, tx_stat_etherstatspkts64octets);\r\nUPDATE_STAT64(tx_stat_gt127,\r\ntx_stat_etherstatspkts65octetsto127octets);\r\nUPDATE_STAT64(tx_stat_gt255,\r\ntx_stat_etherstatspkts128octetsto255octets);\r\nUPDATE_STAT64(tx_stat_gt511,\r\ntx_stat_etherstatspkts256octetsto511octets);\r\nUPDATE_STAT64(tx_stat_gt1023,\r\ntx_stat_etherstatspkts512octetsto1023octets);\r\nUPDATE_STAT64(tx_stat_gt1518,\r\ntx_stat_etherstatspkts1024octetsto1522octets);\r\nUPDATE_STAT64(tx_stat_gt2047, tx_stat_mac_2047);\r\nUPDATE_STAT64(tx_stat_gt4095, tx_stat_mac_4095);\r\nUPDATE_STAT64(tx_stat_gt9216, tx_stat_mac_9216);\r\nUPDATE_STAT64(tx_stat_gt16383, tx_stat_mac_16383);\r\nUPDATE_STAT64(tx_stat_gterr,\r\ntx_stat_dot3statsinternalmactransmiterrors);\r\nUPDATE_STAT64(tx_stat_gtufl, tx_stat_mac_ufl);\r\n} else {\r\nstruct bmac2_stats *new = bnx2x_sp(bp, mac_stats.bmac2_stats);\r\nUPDATE_STAT64(rx_stat_grerb, rx_stat_ifhcinbadoctets);\r\nUPDATE_STAT64(rx_stat_grfcs, rx_stat_dot3statsfcserrors);\r\nUPDATE_STAT64(rx_stat_grund, rx_stat_etherstatsundersizepkts);\r\nUPDATE_STAT64(rx_stat_grovr, rx_stat_dot3statsframestoolong);\r\nUPDATE_STAT64(rx_stat_grfrg, rx_stat_etherstatsfragments);\r\nUPDATE_STAT64(rx_stat_grjbr, rx_stat_etherstatsjabbers);\r\nUPDATE_STAT64(rx_stat_grxcf, rx_stat_maccontrolframesreceived);\r\nUPDATE_STAT64(rx_stat_grxpf, rx_stat_xoffstateentered);\r\nUPDATE_STAT64(rx_stat_grxpf, rx_stat_mac_xpf);\r\nUPDATE_STAT64(tx_stat_gtxpf, tx_stat_outxoffsent);\r\nUPDATE_STAT64(tx_stat_gtxpf, tx_stat_flowcontroldone);\r\nUPDATE_STAT64(tx_stat_gt64, tx_stat_etherstatspkts64octets);\r\nUPDATE_STAT64(tx_stat_gt127,\r\ntx_stat_etherstatspkts65octetsto127octets);\r\nUPDATE_STAT64(tx_stat_gt255,\r\ntx_stat_etherstatspkts128octetsto255octets);\r\nUPDATE_STAT64(tx_stat_gt511,\r\ntx_stat_etherstatspkts256octetsto511octets);\r\nUPDATE_STAT64(tx_stat_gt1023,\r\ntx_stat_etherstatspkts512octetsto1023octets);\r\nUPDATE_STAT64(tx_stat_gt1518,\r\ntx_stat_etherstatspkts1024octetsto1522octets);\r\nUPDATE_STAT64(tx_stat_gt2047, tx_stat_mac_2047);\r\nUPDATE_STAT64(tx_stat_gt4095, tx_stat_mac_4095);\r\nUPDATE_STAT64(tx_stat_gt9216, tx_stat_mac_9216);\r\nUPDATE_STAT64(tx_stat_gt16383, tx_stat_mac_16383);\r\nUPDATE_STAT64(tx_stat_gterr,\r\ntx_stat_dot3statsinternalmactransmiterrors);\r\nUPDATE_STAT64(tx_stat_gtufl, tx_stat_mac_ufl);\r\npstats->pfc_frames_tx_hi = new->tx_stat_gtpp_hi;\r\npstats->pfc_frames_tx_lo = new->tx_stat_gtpp_lo;\r\npstats->pfc_frames_rx_hi = new->rx_stat_grpp_hi;\r\npstats->pfc_frames_rx_lo = new->rx_stat_grpp_lo;\r\n}\r\nestats->pause_frames_received_hi =\r\npstats->mac_stx[1].rx_stat_mac_xpf_hi;\r\nestats->pause_frames_received_lo =\r\npstats->mac_stx[1].rx_stat_mac_xpf_lo;\r\nestats->pause_frames_sent_hi =\r\npstats->mac_stx[1].tx_stat_outxoffsent_hi;\r\nestats->pause_frames_sent_lo =\r\npstats->mac_stx[1].tx_stat_outxoffsent_lo;\r\nestats->pfc_frames_received_hi =\r\npstats->pfc_frames_rx_hi;\r\nestats->pfc_frames_received_lo =\r\npstats->pfc_frames_rx_lo;\r\nestats->pfc_frames_sent_hi =\r\npstats->pfc_frames_tx_hi;\r\nestats->pfc_frames_sent_lo =\r\npstats->pfc_frames_tx_lo;\r\n}\r\nstatic void bnx2x_mstat_stats_update(struct bnx2x *bp)\r\n{\r\nstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct mstat_stats *new = bnx2x_sp(bp, mac_stats.mstat_stats);\r\nADD_STAT64(stats_rx.rx_grerb, rx_stat_ifhcinbadoctets);\r\nADD_STAT64(stats_rx.rx_grfcs, rx_stat_dot3statsfcserrors);\r\nADD_STAT64(stats_rx.rx_grund, rx_stat_etherstatsundersizepkts);\r\nADD_STAT64(stats_rx.rx_grovr, rx_stat_dot3statsframestoolong);\r\nADD_STAT64(stats_rx.rx_grfrg, rx_stat_etherstatsfragments);\r\nADD_STAT64(stats_rx.rx_grxcf, rx_stat_maccontrolframesreceived);\r\nADD_STAT64(stats_rx.rx_grxpf, rx_stat_xoffstateentered);\r\nADD_STAT64(stats_rx.rx_grxpf, rx_stat_mac_xpf);\r\nADD_STAT64(stats_tx.tx_gtxpf, tx_stat_outxoffsent);\r\nADD_STAT64(stats_tx.tx_gtxpf, tx_stat_flowcontroldone);\r\nADD_64(pstats->pfc_frames_tx_hi, new->stats_tx.tx_gtxpp_hi,\r\npstats->pfc_frames_tx_lo, new->stats_tx.tx_gtxpp_lo);\r\nADD_64(pstats->pfc_frames_rx_hi, new->stats_rx.rx_grxpp_hi,\r\npstats->pfc_frames_rx_lo, new->stats_rx.rx_grxpp_lo);\r\nADD_STAT64(stats_tx.tx_gt64, tx_stat_etherstatspkts64octets);\r\nADD_STAT64(stats_tx.tx_gt127,\r\ntx_stat_etherstatspkts65octetsto127octets);\r\nADD_STAT64(stats_tx.tx_gt255,\r\ntx_stat_etherstatspkts128octetsto255octets);\r\nADD_STAT64(stats_tx.tx_gt511,\r\ntx_stat_etherstatspkts256octetsto511octets);\r\nADD_STAT64(stats_tx.tx_gt1023,\r\ntx_stat_etherstatspkts512octetsto1023octets);\r\nADD_STAT64(stats_tx.tx_gt1518,\r\ntx_stat_etherstatspkts1024octetsto1522octets);\r\nADD_STAT64(stats_tx.tx_gt2047, tx_stat_mac_2047);\r\nADD_STAT64(stats_tx.tx_gt4095, tx_stat_mac_4095);\r\nADD_STAT64(stats_tx.tx_gt9216, tx_stat_mac_9216);\r\nADD_STAT64(stats_tx.tx_gt16383, tx_stat_mac_16383);\r\nADD_STAT64(stats_tx.tx_gterr,\r\ntx_stat_dot3statsinternalmactransmiterrors);\r\nADD_STAT64(stats_tx.tx_gtufl, tx_stat_mac_ufl);\r\nestats->etherstatspkts1024octetsto1522octets_hi =\r\npstats->mac_stx[1].tx_stat_etherstatspkts1024octetsto1522octets_hi;\r\nestats->etherstatspkts1024octetsto1522octets_lo =\r\npstats->mac_stx[1].tx_stat_etherstatspkts1024octetsto1522octets_lo;\r\nestats->etherstatspktsover1522octets_hi =\r\npstats->mac_stx[1].tx_stat_mac_2047_hi;\r\nestats->etherstatspktsover1522octets_lo =\r\npstats->mac_stx[1].tx_stat_mac_2047_lo;\r\nADD_64(estats->etherstatspktsover1522octets_hi,\r\npstats->mac_stx[1].tx_stat_mac_4095_hi,\r\nestats->etherstatspktsover1522octets_lo,\r\npstats->mac_stx[1].tx_stat_mac_4095_lo);\r\nADD_64(estats->etherstatspktsover1522octets_hi,\r\npstats->mac_stx[1].tx_stat_mac_9216_hi,\r\nestats->etherstatspktsover1522octets_lo,\r\npstats->mac_stx[1].tx_stat_mac_9216_lo);\r\nADD_64(estats->etherstatspktsover1522octets_hi,\r\npstats->mac_stx[1].tx_stat_mac_16383_hi,\r\nestats->etherstatspktsover1522octets_lo,\r\npstats->mac_stx[1].tx_stat_mac_16383_lo);\r\nestats->pause_frames_received_hi =\r\npstats->mac_stx[1].rx_stat_mac_xpf_hi;\r\nestats->pause_frames_received_lo =\r\npstats->mac_stx[1].rx_stat_mac_xpf_lo;\r\nestats->pause_frames_sent_hi =\r\npstats->mac_stx[1].tx_stat_outxoffsent_hi;\r\nestats->pause_frames_sent_lo =\r\npstats->mac_stx[1].tx_stat_outxoffsent_lo;\r\nestats->pfc_frames_received_hi =\r\npstats->pfc_frames_rx_hi;\r\nestats->pfc_frames_received_lo =\r\npstats->pfc_frames_rx_lo;\r\nestats->pfc_frames_sent_hi =\r\npstats->pfc_frames_tx_hi;\r\nestats->pfc_frames_sent_lo =\r\npstats->pfc_frames_tx_lo;\r\n}\r\nstatic void bnx2x_emac_stats_update(struct bnx2x *bp)\r\n{\r\nstruct emac_stats *new = bnx2x_sp(bp, mac_stats.emac_stats);\r\nstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nUPDATE_EXTEND_STAT(rx_stat_ifhcinbadoctets);\r\nUPDATE_EXTEND_STAT(tx_stat_ifhcoutbadoctets);\r\nUPDATE_EXTEND_STAT(rx_stat_dot3statsfcserrors);\r\nUPDATE_EXTEND_STAT(rx_stat_dot3statsalignmenterrors);\r\nUPDATE_EXTEND_STAT(rx_stat_dot3statscarriersenseerrors);\r\nUPDATE_EXTEND_STAT(rx_stat_falsecarriererrors);\r\nUPDATE_EXTEND_STAT(rx_stat_etherstatsundersizepkts);\r\nUPDATE_EXTEND_STAT(rx_stat_dot3statsframestoolong);\r\nUPDATE_EXTEND_STAT(rx_stat_etherstatsfragments);\r\nUPDATE_EXTEND_STAT(rx_stat_etherstatsjabbers);\r\nUPDATE_EXTEND_STAT(rx_stat_maccontrolframesreceived);\r\nUPDATE_EXTEND_STAT(rx_stat_xoffstateentered);\r\nUPDATE_EXTEND_STAT(rx_stat_xonpauseframesreceived);\r\nUPDATE_EXTEND_STAT(rx_stat_xoffpauseframesreceived);\r\nUPDATE_EXTEND_STAT(tx_stat_outxonsent);\r\nUPDATE_EXTEND_STAT(tx_stat_outxoffsent);\r\nUPDATE_EXTEND_STAT(tx_stat_flowcontroldone);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatscollisions);\r\nUPDATE_EXTEND_STAT(tx_stat_dot3statssinglecollisionframes);\r\nUPDATE_EXTEND_STAT(tx_stat_dot3statsmultiplecollisionframes);\r\nUPDATE_EXTEND_STAT(tx_stat_dot3statsdeferredtransmissions);\r\nUPDATE_EXTEND_STAT(tx_stat_dot3statsexcessivecollisions);\r\nUPDATE_EXTEND_STAT(tx_stat_dot3statslatecollisions);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspkts64octets);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspkts65octetsto127octets);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspkts128octetsto255octets);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspkts256octetsto511octets);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspkts512octetsto1023octets);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspkts1024octetsto1522octets);\r\nUPDATE_EXTEND_STAT(tx_stat_etherstatspktsover1522octets);\r\nUPDATE_EXTEND_STAT(tx_stat_dot3statsinternalmactransmiterrors);\r\nestats->pause_frames_received_hi =\r\npstats->mac_stx[1].rx_stat_xonpauseframesreceived_hi;\r\nestats->pause_frames_received_lo =\r\npstats->mac_stx[1].rx_stat_xonpauseframesreceived_lo;\r\nADD_64(estats->pause_frames_received_hi,\r\npstats->mac_stx[1].rx_stat_xoffpauseframesreceived_hi,\r\nestats->pause_frames_received_lo,\r\npstats->mac_stx[1].rx_stat_xoffpauseframesreceived_lo);\r\nestats->pause_frames_sent_hi =\r\npstats->mac_stx[1].tx_stat_outxonsent_hi;\r\nestats->pause_frames_sent_lo =\r\npstats->mac_stx[1].tx_stat_outxonsent_lo;\r\nADD_64(estats->pause_frames_sent_hi,\r\npstats->mac_stx[1].tx_stat_outxoffsent_hi,\r\nestats->pause_frames_sent_lo,\r\npstats->mac_stx[1].tx_stat_outxoffsent_lo);\r\n}\r\nstatic int bnx2x_hw_stats_update(struct bnx2x *bp)\r\n{\r\nstruct nig_stats *new = bnx2x_sp(bp, nig_stats);\r\nstruct nig_stats *old = &(bp->port.old_nig_stats);\r\nstruct host_port_stats *pstats = bnx2x_sp(bp, port_stats);\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct {\r\nu32 lo;\r\nu32 hi;\r\n} diff;\r\nswitch (bp->link_vars.mac_type) {\r\ncase MAC_TYPE_BMAC:\r\nbnx2x_bmac_stats_update(bp);\r\nbreak;\r\ncase MAC_TYPE_EMAC:\r\nbnx2x_emac_stats_update(bp);\r\nbreak;\r\ncase MAC_TYPE_UMAC:\r\ncase MAC_TYPE_XMAC:\r\nbnx2x_mstat_stats_update(bp);\r\nbreak;\r\ncase MAC_TYPE_NONE:\r\nDP(BNX2X_MSG_STATS,\r\n"stats updated by DMAE but no MAC active\n");\r\nreturn -1;\r\ndefault:\r\nBNX2X_ERR("Unknown MAC type\n");\r\n}\r\nADD_EXTEND_64(pstats->brb_drop_hi, pstats->brb_drop_lo,\r\nnew->brb_discard - old->brb_discard);\r\nADD_EXTEND_64(estats->brb_truncate_hi, estats->brb_truncate_lo,\r\nnew->brb_truncate - old->brb_truncate);\r\nif (!CHIP_IS_E3(bp)) {\r\nUPDATE_STAT64_NIG(egress_mac_pkt0,\r\netherstatspkts1024octetsto1522octets);\r\nUPDATE_STAT64_NIG(egress_mac_pkt1,\r\netherstatspktsover1522octets);\r\n}\r\nmemcpy(old, new, sizeof(struct nig_stats));\r\nmemcpy(&(estats->rx_stat_ifhcinbadoctets_hi), &(pstats->mac_stx[1]),\r\nsizeof(struct mac_stx));\r\nestats->brb_drop_hi = pstats->brb_drop_hi;\r\nestats->brb_drop_lo = pstats->brb_drop_lo;\r\npstats->host_port_stats_counter++;\r\nif (CHIP_IS_E3(bp)) {\r\nu32 lpi_reg = BP_PORT(bp) ? MISC_REG_CPMU_LP_SM_ENT_CNT_P1\r\n: MISC_REG_CPMU_LP_SM_ENT_CNT_P0;\r\nestats->eee_tx_lpi += REG_RD(bp, lpi_reg);\r\n}\r\nif (!BP_NOMCP(bp)) {\r\nu32 nig_timer_max =\r\nSHMEM_RD(bp, port_mb[BP_PORT(bp)].stat_nig_timer);\r\nif (nig_timer_max != estats->nig_timer_max) {\r\nestats->nig_timer_max = nig_timer_max;\r\nBNX2X_ERR("NIG timer max (%u)\n",\r\nestats->nig_timer_max);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int bnx2x_storm_stats_validate_counters(struct bnx2x *bp)\r\n{\r\nstruct stats_counter *counters = &bp->fw_stats_data->storm_counters;\r\nu16 cur_stats_counter;\r\ncur_stats_counter = bp->stats_counter - 1;\r\nif (le16_to_cpu(counters->xstats_counter) != cur_stats_counter) {\r\nDP(BNX2X_MSG_STATS,\r\n"stats not updated by xstorm xstorm counter (0x%x) != stats_counter (0x%x)\n",\r\nle16_to_cpu(counters->xstats_counter), bp->stats_counter);\r\nreturn -EAGAIN;\r\n}\r\nif (le16_to_cpu(counters->ustats_counter) != cur_stats_counter) {\r\nDP(BNX2X_MSG_STATS,\r\n"stats not updated by ustorm ustorm counter (0x%x) != stats_counter (0x%x)\n",\r\nle16_to_cpu(counters->ustats_counter), bp->stats_counter);\r\nreturn -EAGAIN;\r\n}\r\nif (le16_to_cpu(counters->cstats_counter) != cur_stats_counter) {\r\nDP(BNX2X_MSG_STATS,\r\n"stats not updated by cstorm cstorm counter (0x%x) != stats_counter (0x%x)\n",\r\nle16_to_cpu(counters->cstats_counter), bp->stats_counter);\r\nreturn -EAGAIN;\r\n}\r\nif (le16_to_cpu(counters->tstats_counter) != cur_stats_counter) {\r\nDP(BNX2X_MSG_STATS,\r\n"stats not updated by tstorm tstorm counter (0x%x) != stats_counter (0x%x)\n",\r\nle16_to_cpu(counters->tstats_counter), bp->stats_counter);\r\nreturn -EAGAIN;\r\n}\r\nreturn 0;\r\n}\r\nstatic int bnx2x_storm_stats_update(struct bnx2x *bp)\r\n{\r\nstruct tstorm_per_port_stats *tport =\r\n&bp->fw_stats_data->port.tstorm_port_statistics;\r\nstruct tstorm_per_pf_stats *tfunc =\r\n&bp->fw_stats_data->pf.tstorm_pf_statistics;\r\nstruct host_func_stats *fstats = &bp->func_stats;\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct bnx2x_eth_stats_old *estats_old = &bp->eth_stats_old;\r\nint i;\r\nif (IS_PF(bp) && bnx2x_storm_stats_validate_counters(bp))\r\nreturn -EAGAIN;\r\nestats->error_bytes_received_hi = 0;\r\nestats->error_bytes_received_lo = 0;\r\nfor_each_eth_queue(bp, i) {\r\nstruct bnx2x_fastpath *fp = &bp->fp[i];\r\nstruct tstorm_per_queue_stats *tclient =\r\n&bp->fw_stats_data->queue_stats[i].\r\ntstorm_queue_statistics;\r\nstruct tstorm_per_queue_stats *old_tclient =\r\n&bnx2x_fp_stats(bp, fp)->old_tclient;\r\nstruct ustorm_per_queue_stats *uclient =\r\n&bp->fw_stats_data->queue_stats[i].\r\nustorm_queue_statistics;\r\nstruct ustorm_per_queue_stats *old_uclient =\r\n&bnx2x_fp_stats(bp, fp)->old_uclient;\r\nstruct xstorm_per_queue_stats *xclient =\r\n&bp->fw_stats_data->queue_stats[i].\r\nxstorm_queue_statistics;\r\nstruct xstorm_per_queue_stats *old_xclient =\r\n&bnx2x_fp_stats(bp, fp)->old_xclient;\r\nstruct bnx2x_eth_q_stats *qstats =\r\n&bnx2x_fp_stats(bp, fp)->eth_q_stats;\r\nstruct bnx2x_eth_q_stats_old *qstats_old =\r\n&bnx2x_fp_stats(bp, fp)->eth_q_stats_old;\r\nu32 diff;\r\nDP(BNX2X_MSG_STATS, "queue[%d]: ucast_sent 0x%x, bcast_sent 0x%x mcast_sent 0x%x\n",\r\ni, xclient->ucast_pkts_sent,\r\nxclient->bcast_pkts_sent, xclient->mcast_pkts_sent);\r\nDP(BNX2X_MSG_STATS, "---------------\n");\r\nUPDATE_QSTAT(tclient->rcv_bcast_bytes,\r\ntotal_broadcast_bytes_received);\r\nUPDATE_QSTAT(tclient->rcv_mcast_bytes,\r\ntotal_multicast_bytes_received);\r\nUPDATE_QSTAT(tclient->rcv_ucast_bytes,\r\ntotal_unicast_bytes_received);\r\nqstats->total_bytes_received_hi =\r\nqstats->total_broadcast_bytes_received_hi;\r\nqstats->total_bytes_received_lo =\r\nqstats->total_broadcast_bytes_received_lo;\r\nADD_64(qstats->total_bytes_received_hi,\r\nqstats->total_multicast_bytes_received_hi,\r\nqstats->total_bytes_received_lo,\r\nqstats->total_multicast_bytes_received_lo);\r\nADD_64(qstats->total_bytes_received_hi,\r\nqstats->total_unicast_bytes_received_hi,\r\nqstats->total_bytes_received_lo,\r\nqstats->total_unicast_bytes_received_lo);\r\nqstats->valid_bytes_received_hi =\r\nqstats->total_bytes_received_hi;\r\nqstats->valid_bytes_received_lo =\r\nqstats->total_bytes_received_lo;\r\nUPDATE_EXTEND_TSTAT(rcv_ucast_pkts,\r\ntotal_unicast_packets_received);\r\nUPDATE_EXTEND_TSTAT(rcv_mcast_pkts,\r\ntotal_multicast_packets_received);\r\nUPDATE_EXTEND_TSTAT(rcv_bcast_pkts,\r\ntotal_broadcast_packets_received);\r\nUPDATE_EXTEND_E_TSTAT(pkts_too_big_discard,\r\netherstatsoverrsizepkts, 32);\r\nUPDATE_EXTEND_E_TSTAT(no_buff_discard, no_buff_discard, 16);\r\nSUB_EXTEND_USTAT(ucast_no_buff_pkts,\r\ntotal_unicast_packets_received);\r\nSUB_EXTEND_USTAT(mcast_no_buff_pkts,\r\ntotal_multicast_packets_received);\r\nSUB_EXTEND_USTAT(bcast_no_buff_pkts,\r\ntotal_broadcast_packets_received);\r\nUPDATE_EXTEND_E_USTAT(ucast_no_buff_pkts, no_buff_discard);\r\nUPDATE_EXTEND_E_USTAT(mcast_no_buff_pkts, no_buff_discard);\r\nUPDATE_EXTEND_E_USTAT(bcast_no_buff_pkts, no_buff_discard);\r\nUPDATE_QSTAT(xclient->bcast_bytes_sent,\r\ntotal_broadcast_bytes_transmitted);\r\nUPDATE_QSTAT(xclient->mcast_bytes_sent,\r\ntotal_multicast_bytes_transmitted);\r\nUPDATE_QSTAT(xclient->ucast_bytes_sent,\r\ntotal_unicast_bytes_transmitted);\r\nqstats->total_bytes_transmitted_hi =\r\nqstats->total_unicast_bytes_transmitted_hi;\r\nqstats->total_bytes_transmitted_lo =\r\nqstats->total_unicast_bytes_transmitted_lo;\r\nADD_64(qstats->total_bytes_transmitted_hi,\r\nqstats->total_broadcast_bytes_transmitted_hi,\r\nqstats->total_bytes_transmitted_lo,\r\nqstats->total_broadcast_bytes_transmitted_lo);\r\nADD_64(qstats->total_bytes_transmitted_hi,\r\nqstats->total_multicast_bytes_transmitted_hi,\r\nqstats->total_bytes_transmitted_lo,\r\nqstats->total_multicast_bytes_transmitted_lo);\r\nUPDATE_EXTEND_XSTAT(ucast_pkts_sent,\r\ntotal_unicast_packets_transmitted);\r\nUPDATE_EXTEND_XSTAT(mcast_pkts_sent,\r\ntotal_multicast_packets_transmitted);\r\nUPDATE_EXTEND_XSTAT(bcast_pkts_sent,\r\ntotal_broadcast_packets_transmitted);\r\nUPDATE_EXTEND_TSTAT(checksum_discard,\r\ntotal_packets_received_checksum_discarded);\r\nUPDATE_EXTEND_TSTAT(ttl0_discard,\r\ntotal_packets_received_ttl0_discarded);\r\nUPDATE_EXTEND_XSTAT(error_drop_pkts,\r\ntotal_transmitted_dropped_packets_error);\r\nUPDATE_EXTEND_E_USTAT(coalesced_events, total_tpa_aggregations);\r\nUPDATE_EXTEND_E_USTAT(coalesced_pkts,\r\ntotal_tpa_aggregated_frames);\r\nUPDATE_QSTAT(uclient->coalesced_bytes, total_tpa_bytes);\r\nUPDATE_ESTAT_QSTAT_64(total_tpa_bytes);\r\nUPDATE_FSTAT_QSTAT(total_bytes_received);\r\nUPDATE_FSTAT_QSTAT(total_bytes_transmitted);\r\nUPDATE_FSTAT_QSTAT(total_unicast_packets_received);\r\nUPDATE_FSTAT_QSTAT(total_multicast_packets_received);\r\nUPDATE_FSTAT_QSTAT(total_broadcast_packets_received);\r\nUPDATE_FSTAT_QSTAT(total_unicast_packets_transmitted);\r\nUPDATE_FSTAT_QSTAT(total_multicast_packets_transmitted);\r\nUPDATE_FSTAT_QSTAT(total_broadcast_packets_transmitted);\r\nUPDATE_FSTAT_QSTAT(valid_bytes_received);\r\n}\r\nADD_64(estats->total_bytes_received_hi,\r\nestats->rx_stat_ifhcinbadoctets_hi,\r\nestats->total_bytes_received_lo,\r\nestats->rx_stat_ifhcinbadoctets_lo);\r\nADD_64_LE(estats->total_bytes_received_hi,\r\ntfunc->rcv_error_bytes.hi,\r\nestats->total_bytes_received_lo,\r\ntfunc->rcv_error_bytes.lo);\r\nADD_64_LE(estats->error_bytes_received_hi,\r\ntfunc->rcv_error_bytes.hi,\r\nestats->error_bytes_received_lo,\r\ntfunc->rcv_error_bytes.lo);\r\nUPDATE_ESTAT(etherstatsoverrsizepkts, rx_stat_dot3statsframestoolong);\r\nADD_64(estats->error_bytes_received_hi,\r\nestats->rx_stat_ifhcinbadoctets_hi,\r\nestats->error_bytes_received_lo,\r\nestats->rx_stat_ifhcinbadoctets_lo);\r\nif (bp->port.pmf) {\r\nstruct bnx2x_fw_port_stats_old *fwstats = &bp->fw_stats_old;\r\nUPDATE_FW_STAT(mac_filter_discard);\r\nUPDATE_FW_STAT(mf_tag_discard);\r\nUPDATE_FW_STAT(brb_truncate_discard);\r\nUPDATE_FW_STAT(mac_discard);\r\n}\r\nfstats->host_func_stats_start = ++fstats->host_func_stats_end;\r\nbp->stats_pending = 0;\r\nreturn 0;\r\n}\r\nstatic void bnx2x_net_stats_update(struct bnx2x *bp)\r\n{\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct net_device_stats *nstats = &bp->dev->stats;\r\nunsigned long tmp;\r\nint i;\r\nnstats->rx_packets =\r\nbnx2x_hilo(&estats->total_unicast_packets_received_hi) +\r\nbnx2x_hilo(&estats->total_multicast_packets_received_hi) +\r\nbnx2x_hilo(&estats->total_broadcast_packets_received_hi);\r\nnstats->tx_packets =\r\nbnx2x_hilo(&estats->total_unicast_packets_transmitted_hi) +\r\nbnx2x_hilo(&estats->total_multicast_packets_transmitted_hi) +\r\nbnx2x_hilo(&estats->total_broadcast_packets_transmitted_hi);\r\nnstats->rx_bytes = bnx2x_hilo(&estats->total_bytes_received_hi);\r\nnstats->tx_bytes = bnx2x_hilo(&estats->total_bytes_transmitted_hi);\r\ntmp = estats->mac_discard;\r\nfor_each_rx_queue(bp, i) {\r\nstruct tstorm_per_queue_stats *old_tclient =\r\n&bp->fp_stats[i].old_tclient;\r\ntmp += le32_to_cpu(old_tclient->checksum_discard);\r\n}\r\nnstats->rx_dropped = tmp + bp->net_stats_old.rx_dropped;\r\nnstats->tx_dropped = 0;\r\nnstats->multicast =\r\nbnx2x_hilo(&estats->total_multicast_packets_received_hi);\r\nnstats->collisions =\r\nbnx2x_hilo(&estats->tx_stat_etherstatscollisions_hi);\r\nnstats->rx_length_errors =\r\nbnx2x_hilo(&estats->rx_stat_etherstatsundersizepkts_hi) +\r\nbnx2x_hilo(&estats->etherstatsoverrsizepkts_hi);\r\nnstats->rx_over_errors = bnx2x_hilo(&estats->brb_drop_hi) +\r\nbnx2x_hilo(&estats->brb_truncate_hi);\r\nnstats->rx_crc_errors =\r\nbnx2x_hilo(&estats->rx_stat_dot3statsfcserrors_hi);\r\nnstats->rx_frame_errors =\r\nbnx2x_hilo(&estats->rx_stat_dot3statsalignmenterrors_hi);\r\nnstats->rx_fifo_errors = bnx2x_hilo(&estats->no_buff_discard_hi);\r\nnstats->rx_missed_errors = 0;\r\nnstats->rx_errors = nstats->rx_length_errors +\r\nnstats->rx_over_errors +\r\nnstats->rx_crc_errors +\r\nnstats->rx_frame_errors +\r\nnstats->rx_fifo_errors +\r\nnstats->rx_missed_errors;\r\nnstats->tx_aborted_errors =\r\nbnx2x_hilo(&estats->tx_stat_dot3statslatecollisions_hi) +\r\nbnx2x_hilo(&estats->tx_stat_dot3statsexcessivecollisions_hi);\r\nnstats->tx_carrier_errors =\r\nbnx2x_hilo(&estats->rx_stat_dot3statscarriersenseerrors_hi);\r\nnstats->tx_fifo_errors = 0;\r\nnstats->tx_heartbeat_errors = 0;\r\nnstats->tx_window_errors = 0;\r\nnstats->tx_errors = nstats->tx_aborted_errors +\r\nnstats->tx_carrier_errors +\r\nbnx2x_hilo(&estats->tx_stat_dot3statsinternalmactransmiterrors_hi);\r\n}\r\nstatic void bnx2x_drv_stats_update(struct bnx2x *bp)\r\n{\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nint i;\r\nfor_each_queue(bp, i) {\r\nstruct bnx2x_eth_q_stats *qstats = &bp->fp_stats[i].eth_q_stats;\r\nstruct bnx2x_eth_q_stats_old *qstats_old =\r\n&bp->fp_stats[i].eth_q_stats_old;\r\nUPDATE_ESTAT_QSTAT(driver_xoff);\r\nUPDATE_ESTAT_QSTAT(rx_err_discard_pkt);\r\nUPDATE_ESTAT_QSTAT(rx_skb_alloc_failed);\r\nUPDATE_ESTAT_QSTAT(hw_csum_err);\r\nUPDATE_ESTAT_QSTAT(driver_filtered_tx_pkt);\r\n}\r\n}\r\nstatic bool bnx2x_edebug_stats_stopped(struct bnx2x *bp)\r\n{\r\nu32 val;\r\nif (SHMEM2_HAS(bp, edebug_driver_if[1])) {\r\nval = SHMEM2_RD(bp, edebug_driver_if[1]);\r\nif (val == EDEBUG_DRIVER_IF_OP_CODE_DISABLE_STAT)\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void bnx2x_stats_update(struct bnx2x *bp)\r\n{\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nif (down_trylock(&bp->stats_sema))\r\nreturn;\r\nif (bnx2x_edebug_stats_stopped(bp) || !bp->stats_started)\r\ngoto out;\r\nif (IS_PF(bp)) {\r\nif (*stats_comp != DMAE_COMP_VAL)\r\ngoto out;\r\nif (bp->port.pmf)\r\nbnx2x_hw_stats_update(bp);\r\nif (bnx2x_storm_stats_update(bp)) {\r\nif (bp->stats_pending++ == 3) {\r\nBNX2X_ERR("storm stats were not updated for 3 times\n");\r\nbnx2x_panic();\r\n}\r\ngoto out;\r\n}\r\n} else {\r\nbnx2x_storm_stats_update(bp);\r\n}\r\nbnx2x_net_stats_update(bp);\r\nbnx2x_drv_stats_update(bp);\r\nif (IS_VF(bp))\r\ngoto out;\r\nif (netif_msg_timer(bp)) {\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nnetdev_dbg(bp->dev, "brb drops %u brb truncate %u\n",\r\nestats->brb_drop_lo, estats->brb_truncate_lo);\r\n}\r\nbnx2x_hw_stats_post(bp);\r\nbnx2x_storm_stats_post(bp);\r\nout:\r\nup(&bp->stats_sema);\r\n}\r\nstatic void bnx2x_port_stats_stop(struct bnx2x *bp)\r\n{\r\nstruct dmae_command *dmae;\r\nu32 opcode;\r\nint loader_idx = PMF_DMAE_C(bp);\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nbp->executer_idx = 0;\r\nopcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC, false, 0);\r\nif (bp->port.port_stx) {\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\nif (bp->func_stx)\r\ndmae->opcode = bnx2x_dmae_opcode_add_comp(\r\nopcode, DMAE_COMP_GRC);\r\nelse\r\ndmae->opcode = bnx2x_dmae_opcode_add_comp(\r\nopcode, DMAE_COMP_PCI);\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->dst_addr_lo = bp->port.port_stx >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = bnx2x_get_port_stats_dma_len(bp);\r\nif (bp->func_stx) {\r\ndmae->comp_addr_lo = dmae_reg_go_c[loader_idx] >> 2;\r\ndmae->comp_addr_hi = 0;\r\ndmae->comp_val = 1;\r\n} else {\r\ndmae->comp_addr_lo =\r\nU64_LO(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_addr_hi =\r\nU64_HI(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_val = DMAE_COMP_VAL;\r\n*stats_comp = 0;\r\n}\r\n}\r\nif (bp->func_stx) {\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode =\r\nbnx2x_dmae_opcode_add_comp(opcode, DMAE_COMP_PCI);\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, func_stats));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, func_stats));\r\ndmae->dst_addr_lo = bp->func_stx >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = sizeof(struct host_func_stats) >> 2;\r\ndmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_val = DMAE_COMP_VAL;\r\n*stats_comp = 0;\r\n}\r\n}\r\nstatic void bnx2x_stats_stop(struct bnx2x *bp)\r\n{\r\nint update = 0;\r\nif (down_timeout(&bp->stats_sema, HZ/10))\r\nBNX2X_ERR("Unable to acquire stats lock\n");\r\nbp->stats_started = false;\r\nbnx2x_stats_comp(bp);\r\nif (bp->port.pmf)\r\nupdate = (bnx2x_hw_stats_update(bp) == 0);\r\nupdate |= (bnx2x_storm_stats_update(bp) == 0);\r\nif (update) {\r\nbnx2x_net_stats_update(bp);\r\nif (bp->port.pmf)\r\nbnx2x_port_stats_stop(bp);\r\nbnx2x_hw_stats_post(bp);\r\nbnx2x_stats_comp(bp);\r\n}\r\nup(&bp->stats_sema);\r\n}\r\nstatic void bnx2x_stats_do_nothing(struct bnx2x *bp)\r\n{\r\n}\r\nvoid bnx2x_stats_handle(struct bnx2x *bp, enum bnx2x_stats_event event)\r\n{\r\nenum bnx2x_stats_state state;\r\nvoid (*action)(struct bnx2x *bp);\r\nif (unlikely(bp->panic))\r\nreturn;\r\nspin_lock_bh(&bp->stats_lock);\r\nstate = bp->stats_state;\r\nbp->stats_state = bnx2x_stats_stm[state][event].next_state;\r\naction = bnx2x_stats_stm[state][event].action;\r\nspin_unlock_bh(&bp->stats_lock);\r\naction(bp);\r\nif ((event != STATS_EVENT_UPDATE) || netif_msg_timer(bp))\r\nDP(BNX2X_MSG_STATS, "state %d -> event %d -> state %d\n",\r\nstate, event, bp->stats_state);\r\n}\r\nstatic void bnx2x_port_stats_base_init(struct bnx2x *bp)\r\n{\r\nstruct dmae_command *dmae;\r\nu32 *stats_comp = bnx2x_sp(bp, stats_comp);\r\nif (!bp->port.pmf || !bp->port.port_stx) {\r\nBNX2X_ERR("BUG!\n");\r\nreturn;\r\n}\r\nbp->executer_idx = 0;\r\ndmae = bnx2x_sp(bp, dmae[bp->executer_idx++]);\r\ndmae->opcode = bnx2x_dmae_opcode(bp, DMAE_SRC_PCI, DMAE_DST_GRC,\r\ntrue, DMAE_COMP_PCI);\r\ndmae->src_addr_lo = U64_LO(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->src_addr_hi = U64_HI(bnx2x_sp_mapping(bp, port_stats));\r\ndmae->dst_addr_lo = bp->port.port_stx >> 2;\r\ndmae->dst_addr_hi = 0;\r\ndmae->len = bnx2x_get_port_stats_dma_len(bp);\r\ndmae->comp_addr_lo = U64_LO(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_addr_hi = U64_HI(bnx2x_sp_mapping(bp, stats_comp));\r\ndmae->comp_val = DMAE_COMP_VAL;\r\n*stats_comp = 0;\r\nbnx2x_hw_stats_post(bp);\r\nbnx2x_stats_comp(bp);\r\n}\r\nstatic void bnx2x_prep_fw_stats_req(struct bnx2x *bp)\r\n{\r\nint i;\r\nint first_queue_query_index;\r\nstruct stats_query_header *stats_hdr = &bp->fw_stats_req->hdr;\r\ndma_addr_t cur_data_offset;\r\nstruct stats_query_entry *cur_query_entry;\r\nstats_hdr->cmd_num = bp->fw_stats_num;\r\nstats_hdr->drv_stats_counter = 0;\r\ncur_data_offset = bp->fw_stats_data_mapping +\r\noffsetof(struct bnx2x_fw_stats_data, storm_counters);\r\nstats_hdr->stats_counters_addrs.hi =\r\ncpu_to_le32(U64_HI(cur_data_offset));\r\nstats_hdr->stats_counters_addrs.lo =\r\ncpu_to_le32(U64_LO(cur_data_offset));\r\nmemset(&bp->fw_stats_data->storm_counters, 0xff,\r\nsizeof(struct stats_counter));\r\ncur_data_offset = bp->fw_stats_data_mapping +\r\noffsetof(struct bnx2x_fw_stats_data, port);\r\ncur_query_entry = &bp->fw_stats_req->query[BNX2X_PORT_QUERY_IDX];\r\ncur_query_entry->kind = STATS_TYPE_PORT;\r\ncur_query_entry->index = BP_PORT(bp);\r\ncur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\r\ncur_query_entry->address.hi = cpu_to_le32(U64_HI(cur_data_offset));\r\ncur_query_entry->address.lo = cpu_to_le32(U64_LO(cur_data_offset));\r\ncur_data_offset = bp->fw_stats_data_mapping +\r\noffsetof(struct bnx2x_fw_stats_data, pf);\r\ncur_query_entry = &bp->fw_stats_req->query[BNX2X_PF_QUERY_IDX];\r\ncur_query_entry->kind = STATS_TYPE_PF;\r\ncur_query_entry->index = BP_PORT(bp);\r\ncur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\r\ncur_query_entry->address.hi = cpu_to_le32(U64_HI(cur_data_offset));\r\ncur_query_entry->address.lo = cpu_to_le32(U64_LO(cur_data_offset));\r\nif (!NO_FCOE(bp)) {\r\ncur_data_offset = bp->fw_stats_data_mapping +\r\noffsetof(struct bnx2x_fw_stats_data, fcoe);\r\ncur_query_entry =\r\n&bp->fw_stats_req->query[BNX2X_FCOE_QUERY_IDX];\r\ncur_query_entry->kind = STATS_TYPE_FCOE;\r\ncur_query_entry->index = BP_PORT(bp);\r\ncur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\r\ncur_query_entry->address.hi =\r\ncpu_to_le32(U64_HI(cur_data_offset));\r\ncur_query_entry->address.lo =\r\ncpu_to_le32(U64_LO(cur_data_offset));\r\n}\r\ncur_data_offset = bp->fw_stats_data_mapping +\r\noffsetof(struct bnx2x_fw_stats_data, queue_stats);\r\nif (!NO_FCOE(bp))\r\nfirst_queue_query_index = BNX2X_FIRST_QUEUE_QUERY_IDX;\r\nelse\r\nfirst_queue_query_index = BNX2X_FIRST_QUEUE_QUERY_IDX - 1;\r\nfor_each_eth_queue(bp, i) {\r\ncur_query_entry =\r\n&bp->fw_stats_req->\r\nquery[first_queue_query_index + i];\r\ncur_query_entry->kind = STATS_TYPE_QUEUE;\r\ncur_query_entry->index = bnx2x_stats_id(&bp->fp[i]);\r\ncur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\r\ncur_query_entry->address.hi =\r\ncpu_to_le32(U64_HI(cur_data_offset));\r\ncur_query_entry->address.lo =\r\ncpu_to_le32(U64_LO(cur_data_offset));\r\ncur_data_offset += sizeof(struct per_queue_stats);\r\n}\r\nif (!NO_FCOE(bp)) {\r\ncur_query_entry =\r\n&bp->fw_stats_req->\r\nquery[first_queue_query_index + i];\r\ncur_query_entry->kind = STATS_TYPE_QUEUE;\r\ncur_query_entry->index = bnx2x_stats_id(&bp->fp[FCOE_IDX(bp)]);\r\ncur_query_entry->funcID = cpu_to_le16(BP_FUNC(bp));\r\ncur_query_entry->address.hi =\r\ncpu_to_le32(U64_HI(cur_data_offset));\r\ncur_query_entry->address.lo =\r\ncpu_to_le32(U64_LO(cur_data_offset));\r\n}\r\n}\r\nvoid bnx2x_memset_stats(struct bnx2x *bp)\r\n{\r\nint i;\r\nfor_each_queue(bp, i) {\r\nstruct bnx2x_fp_stats *fp_stats = &bp->fp_stats[i];\r\nmemset(&fp_stats->old_tclient, 0,\r\nsizeof(fp_stats->old_tclient));\r\nmemset(&fp_stats->old_uclient, 0,\r\nsizeof(fp_stats->old_uclient));\r\nmemset(&fp_stats->old_xclient, 0,\r\nsizeof(fp_stats->old_xclient));\r\nif (bp->stats_init) {\r\nmemset(&fp_stats->eth_q_stats, 0,\r\nsizeof(fp_stats->eth_q_stats));\r\nmemset(&fp_stats->eth_q_stats_old, 0,\r\nsizeof(fp_stats->eth_q_stats_old));\r\n}\r\n}\r\nmemset(&bp->dev->stats, 0, sizeof(bp->dev->stats));\r\nif (bp->stats_init) {\r\nmemset(&bp->net_stats_old, 0, sizeof(bp->net_stats_old));\r\nmemset(&bp->fw_stats_old, 0, sizeof(bp->fw_stats_old));\r\nmemset(&bp->eth_stats_old, 0, sizeof(bp->eth_stats_old));\r\nmemset(&bp->eth_stats, 0, sizeof(bp->eth_stats));\r\nmemset(&bp->func_stats, 0, sizeof(bp->func_stats));\r\n}\r\nbp->stats_state = STATS_STATE_DISABLED;\r\nif (bp->port.pmf && bp->port.port_stx)\r\nbnx2x_port_stats_base_init(bp);\r\nbp->stats_init = false;\r\n}\r\nvoid bnx2x_stats_init(struct bnx2x *bp)\r\n{\r\nint port = BP_PORT(bp);\r\nint mb_idx = BP_FW_MB_IDX(bp);\r\nif (IS_VF(bp)) {\r\nbnx2x_memset_stats(bp);\r\nreturn;\r\n}\r\nbp->stats_pending = 0;\r\nbp->executer_idx = 0;\r\nbp->stats_counter = 0;\r\nif (!BP_NOMCP(bp)) {\r\nbp->port.port_stx = SHMEM_RD(bp, port_mb[port].port_stx);\r\nbp->func_stx = SHMEM_RD(bp, func_mb[mb_idx].fw_mb_param);\r\n} else {\r\nbp->port.port_stx = 0;\r\nbp->func_stx = 0;\r\n}\r\nDP(BNX2X_MSG_STATS, "port_stx 0x%x func_stx 0x%x\n",\r\nbp->port.port_stx, bp->func_stx);\r\nif (!bp->stats_init && bp->port.pmf && bp->port.port_stx)\r\nbnx2x_stats_handle(bp, STATS_EVENT_PMF);\r\nport = BP_PORT(bp);\r\nmemset(&(bp->port.old_nig_stats), 0, sizeof(struct nig_stats));\r\nbp->port.old_nig_stats.brb_discard =\r\nREG_RD(bp, NIG_REG_STAT0_BRB_DISCARD + port*0x38);\r\nbp->port.old_nig_stats.brb_truncate =\r\nREG_RD(bp, NIG_REG_STAT0_BRB_TRUNCATE + port*0x38);\r\nif (!CHIP_IS_E3(bp)) {\r\nREG_RD_DMAE(bp, NIG_REG_STAT0_EGRESS_MAC_PKT0 + port*0x50,\r\n&(bp->port.old_nig_stats.egress_mac_pkt0_lo), 2);\r\nREG_RD_DMAE(bp, NIG_REG_STAT0_EGRESS_MAC_PKT1 + port*0x50,\r\n&(bp->port.old_nig_stats.egress_mac_pkt1_lo), 2);\r\n}\r\nbnx2x_prep_fw_stats_req(bp);\r\nif (bp->stats_init) {\r\nif (bp->func_stx) {\r\nmemset(bnx2x_sp(bp, func_stats), 0,\r\nsizeof(struct host_func_stats));\r\nbnx2x_func_stats_init(bp);\r\nbnx2x_hw_stats_post(bp);\r\nbnx2x_stats_comp(bp);\r\n}\r\n}\r\nbnx2x_memset_stats(bp);\r\n}\r\nvoid bnx2x_save_statistics(struct bnx2x *bp)\r\n{\r\nint i;\r\nstruct net_device_stats *nstats = &bp->dev->stats;\r\nfor_each_eth_queue(bp, i) {\r\nstruct bnx2x_fastpath *fp = &bp->fp[i];\r\nstruct bnx2x_eth_q_stats *qstats =\r\n&bnx2x_fp_stats(bp, fp)->eth_q_stats;\r\nstruct bnx2x_eth_q_stats_old *qstats_old =\r\n&bnx2x_fp_stats(bp, fp)->eth_q_stats_old;\r\nUPDATE_QSTAT_OLD(total_unicast_bytes_received_hi);\r\nUPDATE_QSTAT_OLD(total_unicast_bytes_received_lo);\r\nUPDATE_QSTAT_OLD(total_broadcast_bytes_received_hi);\r\nUPDATE_QSTAT_OLD(total_broadcast_bytes_received_lo);\r\nUPDATE_QSTAT_OLD(total_multicast_bytes_received_hi);\r\nUPDATE_QSTAT_OLD(total_multicast_bytes_received_lo);\r\nUPDATE_QSTAT_OLD(total_unicast_bytes_transmitted_hi);\r\nUPDATE_QSTAT_OLD(total_unicast_bytes_transmitted_lo);\r\nUPDATE_QSTAT_OLD(total_broadcast_bytes_transmitted_hi);\r\nUPDATE_QSTAT_OLD(total_broadcast_bytes_transmitted_lo);\r\nUPDATE_QSTAT_OLD(total_multicast_bytes_transmitted_hi);\r\nUPDATE_QSTAT_OLD(total_multicast_bytes_transmitted_lo);\r\nUPDATE_QSTAT_OLD(total_tpa_bytes_hi);\r\nUPDATE_QSTAT_OLD(total_tpa_bytes_lo);\r\n}\r\nbp->net_stats_old.rx_dropped = nstats->rx_dropped;\r\nif (bp->port.pmf && IS_MF(bp)) {\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct bnx2x_fw_port_stats_old *fwstats = &bp->fw_stats_old;\r\nUPDATE_FW_STAT_OLD(mac_filter_discard);\r\nUPDATE_FW_STAT_OLD(mf_tag_discard);\r\nUPDATE_FW_STAT_OLD(brb_truncate_discard);\r\nUPDATE_FW_STAT_OLD(mac_discard);\r\n}\r\n}\r\nvoid bnx2x_afex_collect_stats(struct bnx2x *bp, void *void_afex_stats,\r\nu32 stats_type)\r\n{\r\nint i;\r\nstruct afex_stats *afex_stats = (struct afex_stats *)void_afex_stats;\r\nstruct bnx2x_eth_stats *estats = &bp->eth_stats;\r\nstruct per_queue_stats *fcoe_q_stats =\r\n&bp->fw_stats_data->queue_stats[FCOE_IDX(bp)];\r\nstruct tstorm_per_queue_stats *fcoe_q_tstorm_stats =\r\n&fcoe_q_stats->tstorm_queue_statistics;\r\nstruct ustorm_per_queue_stats *fcoe_q_ustorm_stats =\r\n&fcoe_q_stats->ustorm_queue_statistics;\r\nstruct xstorm_per_queue_stats *fcoe_q_xstorm_stats =\r\n&fcoe_q_stats->xstorm_queue_statistics;\r\nstruct fcoe_statistics_params *fw_fcoe_stat =\r\n&bp->fw_stats_data->fcoe;\r\nmemset(afex_stats, 0, sizeof(struct afex_stats));\r\nfor_each_eth_queue(bp, i) {\r\nstruct bnx2x_eth_q_stats *qstats = &bp->fp_stats[i].eth_q_stats;\r\nADD_64(afex_stats->rx_unicast_bytes_hi,\r\nqstats->total_unicast_bytes_received_hi,\r\nafex_stats->rx_unicast_bytes_lo,\r\nqstats->total_unicast_bytes_received_lo);\r\nADD_64(afex_stats->rx_broadcast_bytes_hi,\r\nqstats->total_broadcast_bytes_received_hi,\r\nafex_stats->rx_broadcast_bytes_lo,\r\nqstats->total_broadcast_bytes_received_lo);\r\nADD_64(afex_stats->rx_multicast_bytes_hi,\r\nqstats->total_multicast_bytes_received_hi,\r\nafex_stats->rx_multicast_bytes_lo,\r\nqstats->total_multicast_bytes_received_lo);\r\nADD_64(afex_stats->rx_unicast_frames_hi,\r\nqstats->total_unicast_packets_received_hi,\r\nafex_stats->rx_unicast_frames_lo,\r\nqstats->total_unicast_packets_received_lo);\r\nADD_64(afex_stats->rx_broadcast_frames_hi,\r\nqstats->total_broadcast_packets_received_hi,\r\nafex_stats->rx_broadcast_frames_lo,\r\nqstats->total_broadcast_packets_received_lo);\r\nADD_64(afex_stats->rx_multicast_frames_hi,\r\nqstats->total_multicast_packets_received_hi,\r\nafex_stats->rx_multicast_frames_lo,\r\nqstats->total_multicast_packets_received_lo);\r\nADD_64(afex_stats->rx_frames_discarded_hi,\r\nqstats->total_packets_received_checksum_discarded_hi,\r\nafex_stats->rx_frames_discarded_lo,\r\nqstats->total_packets_received_checksum_discarded_lo);\r\nADD_64(afex_stats->rx_frames_discarded_hi,\r\nqstats->total_packets_received_ttl0_discarded_hi,\r\nafex_stats->rx_frames_discarded_lo,\r\nqstats->total_packets_received_ttl0_discarded_lo);\r\nADD_64(afex_stats->rx_frames_discarded_hi,\r\nqstats->etherstatsoverrsizepkts_hi,\r\nafex_stats->rx_frames_discarded_lo,\r\nqstats->etherstatsoverrsizepkts_lo);\r\nADD_64(afex_stats->rx_frames_dropped_hi,\r\nqstats->no_buff_discard_hi,\r\nafex_stats->rx_frames_dropped_lo,\r\nqstats->no_buff_discard_lo);\r\nADD_64(afex_stats->tx_unicast_bytes_hi,\r\nqstats->total_unicast_bytes_transmitted_hi,\r\nafex_stats->tx_unicast_bytes_lo,\r\nqstats->total_unicast_bytes_transmitted_lo);\r\nADD_64(afex_stats->tx_broadcast_bytes_hi,\r\nqstats->total_broadcast_bytes_transmitted_hi,\r\nafex_stats->tx_broadcast_bytes_lo,\r\nqstats->total_broadcast_bytes_transmitted_lo);\r\nADD_64(afex_stats->tx_multicast_bytes_hi,\r\nqstats->total_multicast_bytes_transmitted_hi,\r\nafex_stats->tx_multicast_bytes_lo,\r\nqstats->total_multicast_bytes_transmitted_lo);\r\nADD_64(afex_stats->tx_unicast_frames_hi,\r\nqstats->total_unicast_packets_transmitted_hi,\r\nafex_stats->tx_unicast_frames_lo,\r\nqstats->total_unicast_packets_transmitted_lo);\r\nADD_64(afex_stats->tx_broadcast_frames_hi,\r\nqstats->total_broadcast_packets_transmitted_hi,\r\nafex_stats->tx_broadcast_frames_lo,\r\nqstats->total_broadcast_packets_transmitted_lo);\r\nADD_64(afex_stats->tx_multicast_frames_hi,\r\nqstats->total_multicast_packets_transmitted_hi,\r\nafex_stats->tx_multicast_frames_lo,\r\nqstats->total_multicast_packets_transmitted_lo);\r\nADD_64(afex_stats->tx_frames_dropped_hi,\r\nqstats->total_transmitted_dropped_packets_error_hi,\r\nafex_stats->tx_frames_dropped_lo,\r\nqstats->total_transmitted_dropped_packets_error_lo);\r\n}\r\nif (!NO_FCOE(bp)) {\r\nADD_64_LE(afex_stats->rx_unicast_bytes_hi,\r\nLE32_0,\r\nafex_stats->rx_unicast_bytes_lo,\r\nfw_fcoe_stat->rx_stat0.fcoe_rx_byte_cnt);\r\nADD_64_LE(afex_stats->rx_unicast_bytes_hi,\r\nfcoe_q_tstorm_stats->rcv_ucast_bytes.hi,\r\nafex_stats->rx_unicast_bytes_lo,\r\nfcoe_q_tstorm_stats->rcv_ucast_bytes.lo);\r\nADD_64_LE(afex_stats->rx_broadcast_bytes_hi,\r\nfcoe_q_tstorm_stats->rcv_bcast_bytes.hi,\r\nafex_stats->rx_broadcast_bytes_lo,\r\nfcoe_q_tstorm_stats->rcv_bcast_bytes.lo);\r\nADD_64_LE(afex_stats->rx_multicast_bytes_hi,\r\nfcoe_q_tstorm_stats->rcv_mcast_bytes.hi,\r\nafex_stats->rx_multicast_bytes_lo,\r\nfcoe_q_tstorm_stats->rcv_mcast_bytes.lo);\r\nADD_64_LE(afex_stats->rx_unicast_frames_hi,\r\nLE32_0,\r\nafex_stats->rx_unicast_frames_lo,\r\nfw_fcoe_stat->rx_stat0.fcoe_rx_pkt_cnt);\r\nADD_64_LE(afex_stats->rx_unicast_frames_hi,\r\nLE32_0,\r\nafex_stats->rx_unicast_frames_lo,\r\nfcoe_q_tstorm_stats->rcv_ucast_pkts);\r\nADD_64_LE(afex_stats->rx_broadcast_frames_hi,\r\nLE32_0,\r\nafex_stats->rx_broadcast_frames_lo,\r\nfcoe_q_tstorm_stats->rcv_bcast_pkts);\r\nADD_64_LE(afex_stats->rx_multicast_frames_hi,\r\nLE32_0,\r\nafex_stats->rx_multicast_frames_lo,\r\nfcoe_q_tstorm_stats->rcv_ucast_pkts);\r\nADD_64_LE(afex_stats->rx_frames_discarded_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_discarded_lo,\r\nfcoe_q_tstorm_stats->checksum_discard);\r\nADD_64_LE(afex_stats->rx_frames_discarded_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_discarded_lo,\r\nfcoe_q_tstorm_stats->pkts_too_big_discard);\r\nADD_64_LE(afex_stats->rx_frames_discarded_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_discarded_lo,\r\nfcoe_q_tstorm_stats->ttl0_discard);\r\nADD_64_LE16(afex_stats->rx_frames_dropped_hi,\r\nLE16_0,\r\nafex_stats->rx_frames_dropped_lo,\r\nfcoe_q_tstorm_stats->no_buff_discard);\r\nADD_64_LE(afex_stats->rx_frames_dropped_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_dropped_lo,\r\nfcoe_q_ustorm_stats->ucast_no_buff_pkts);\r\nADD_64_LE(afex_stats->rx_frames_dropped_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_dropped_lo,\r\nfcoe_q_ustorm_stats->mcast_no_buff_pkts);\r\nADD_64_LE(afex_stats->rx_frames_dropped_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_dropped_lo,\r\nfcoe_q_ustorm_stats->bcast_no_buff_pkts);\r\nADD_64_LE(afex_stats->rx_frames_dropped_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_dropped_lo,\r\nfw_fcoe_stat->rx_stat1.fcoe_rx_drop_pkt_cnt);\r\nADD_64_LE(afex_stats->rx_frames_dropped_hi,\r\nLE32_0,\r\nafex_stats->rx_frames_dropped_lo,\r\nfw_fcoe_stat->rx_stat2.fcoe_rx_drop_pkt_cnt);\r\nADD_64_LE(afex_stats->tx_unicast_bytes_hi,\r\nLE32_0,\r\nafex_stats->tx_unicast_bytes_lo,\r\nfw_fcoe_stat->tx_stat.fcoe_tx_byte_cnt);\r\nADD_64_LE(afex_stats->tx_unicast_bytes_hi,\r\nfcoe_q_xstorm_stats->ucast_bytes_sent.hi,\r\nafex_stats->tx_unicast_bytes_lo,\r\nfcoe_q_xstorm_stats->ucast_bytes_sent.lo);\r\nADD_64_LE(afex_stats->tx_broadcast_bytes_hi,\r\nfcoe_q_xstorm_stats->bcast_bytes_sent.hi,\r\nafex_stats->tx_broadcast_bytes_lo,\r\nfcoe_q_xstorm_stats->bcast_bytes_sent.lo);\r\nADD_64_LE(afex_stats->tx_multicast_bytes_hi,\r\nfcoe_q_xstorm_stats->mcast_bytes_sent.hi,\r\nafex_stats->tx_multicast_bytes_lo,\r\nfcoe_q_xstorm_stats->mcast_bytes_sent.lo);\r\nADD_64_LE(afex_stats->tx_unicast_frames_hi,\r\nLE32_0,\r\nafex_stats->tx_unicast_frames_lo,\r\nfw_fcoe_stat->tx_stat.fcoe_tx_pkt_cnt);\r\nADD_64_LE(afex_stats->tx_unicast_frames_hi,\r\nLE32_0,\r\nafex_stats->tx_unicast_frames_lo,\r\nfcoe_q_xstorm_stats->ucast_pkts_sent);\r\nADD_64_LE(afex_stats->tx_broadcast_frames_hi,\r\nLE32_0,\r\nafex_stats->tx_broadcast_frames_lo,\r\nfcoe_q_xstorm_stats->bcast_pkts_sent);\r\nADD_64_LE(afex_stats->tx_multicast_frames_hi,\r\nLE32_0,\r\nafex_stats->tx_multicast_frames_lo,\r\nfcoe_q_xstorm_stats->mcast_pkts_sent);\r\nADD_64_LE(afex_stats->tx_frames_dropped_hi,\r\nLE32_0,\r\nafex_stats->tx_frames_dropped_lo,\r\nfcoe_q_xstorm_stats->error_drop_pkts);\r\n}\r\nif ((bp->port.pmf) && (stats_type == VICSTATST_UIF_INDEX)) {\r\nADD_64(afex_stats->rx_frames_dropped_hi,\r\n0,\r\nafex_stats->rx_frames_dropped_lo,\r\nestats->mac_filter_discard);\r\nADD_64(afex_stats->rx_frames_dropped_hi,\r\n0,\r\nafex_stats->rx_frames_dropped_lo,\r\nestats->brb_truncate_discard);\r\nADD_64(afex_stats->rx_frames_discarded_hi,\r\n0,\r\nafex_stats->rx_frames_discarded_lo,\r\nestats->mac_discard);\r\n}\r\n}\r\nvoid bnx2x_stats_safe_exec(struct bnx2x *bp,\r\nvoid (func_to_exec)(void *cookie),\r\nvoid *cookie){\r\nif (down_timeout(&bp->stats_sema, HZ/10))\r\nBNX2X_ERR("Unable to acquire stats lock\n");\r\nbnx2x_stats_comp(bp);\r\nfunc_to_exec(cookie);\r\n__bnx2x_stats_start(bp);\r\nup(&bp->stats_sema);\r\n}

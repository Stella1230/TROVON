static ssize_t elog_id_show(struct elog_obj *elog_obj,\r\nstruct elog_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "0x%llx\n", elog_obj->id);\r\n}\r\nstatic const char *elog_type_to_string(uint64_t type)\r\n{\r\nswitch (type) {\r\ncase 0: return "PEL";\r\ndefault: return "unknown";\r\n}\r\n}\r\nstatic ssize_t elog_type_show(struct elog_obj *elog_obj,\r\nstruct elog_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "0x%llx %s\n",\r\nelog_obj->type,\r\nelog_type_to_string(elog_obj->type));\r\n}\r\nstatic ssize_t elog_ack_show(struct elog_obj *elog_obj,\r\nstruct elog_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "ack - acknowledge log message\n");\r\n}\r\nstatic ssize_t elog_ack_store(struct elog_obj *elog_obj,\r\nstruct elog_attribute *attr,\r\nconst char *buf,\r\nsize_t count)\r\n{\r\nopal_send_ack_elog(elog_obj->id);\r\nsysfs_remove_file_self(&elog_obj->kobj, &attr->attr);\r\nkobject_put(&elog_obj->kobj);\r\nreturn count;\r\n}\r\nstatic ssize_t elog_attr_show(struct kobject *kobj,\r\nstruct attribute *attr,\r\nchar *buf)\r\n{\r\nstruct elog_attribute *attribute;\r\nstruct elog_obj *elog;\r\nattribute = to_elog_attr(attr);\r\nelog = to_elog_obj(kobj);\r\nif (!attribute->show)\r\nreturn -EIO;\r\nreturn attribute->show(elog, attribute, buf);\r\n}\r\nstatic ssize_t elog_attr_store(struct kobject *kobj,\r\nstruct attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct elog_attribute *attribute;\r\nstruct elog_obj *elog;\r\nattribute = to_elog_attr(attr);\r\nelog = to_elog_obj(kobj);\r\nif (!attribute->store)\r\nreturn -EIO;\r\nreturn attribute->store(elog, attribute, buf, len);\r\n}\r\nstatic void elog_release(struct kobject *kobj)\r\n{\r\nstruct elog_obj *elog;\r\nelog = to_elog_obj(kobj);\r\nkfree(elog->buffer);\r\nkfree(elog);\r\n}\r\nstatic ssize_t raw_attr_read(struct file *filep, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buffer, loff_t pos, size_t count)\r\n{\r\nint opal_rc;\r\nstruct elog_obj *elog = to_elog_obj(kobj);\r\nif (!elog->buffer) {\r\nelog->buffer = kzalloc(elog->size, GFP_KERNEL);\r\nif (!elog->buffer)\r\nreturn -EIO;\r\nopal_rc = opal_read_elog(__pa(elog->buffer),\r\nelog->size, elog->id);\r\nif (opal_rc != OPAL_SUCCESS) {\r\npr_err("ELOG: log read failed for log-id=%llx\n",\r\nelog->id);\r\nkfree(elog->buffer);\r\nelog->buffer = NULL;\r\nreturn -EIO;\r\n}\r\n}\r\nmemcpy(buffer, elog->buffer + pos, count);\r\nreturn count;\r\n}\r\nstatic struct elog_obj *create_elog_obj(uint64_t id, size_t size, uint64_t type)\r\n{\r\nstruct elog_obj *elog;\r\nint rc;\r\nelog = kzalloc(sizeof(*elog), GFP_KERNEL);\r\nif (!elog)\r\nreturn NULL;\r\nelog->kobj.kset = elog_kset;\r\nkobject_init(&elog->kobj, &elog_ktype);\r\nsysfs_bin_attr_init(&elog->raw_attr);\r\nelog->raw_attr.attr.name = "raw";\r\nelog->raw_attr.attr.mode = 0400;\r\nelog->raw_attr.size = size;\r\nelog->raw_attr.read = raw_attr_read;\r\nelog->id = id;\r\nelog->size = size;\r\nelog->type = type;\r\nelog->buffer = kzalloc(elog->size, GFP_KERNEL);\r\nif (elog->buffer) {\r\nrc = opal_read_elog(__pa(elog->buffer),\r\nelog->size, elog->id);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err("ELOG: log read failed for log-id=%llx\n",\r\nelog->id);\r\nkfree(elog->buffer);\r\nelog->buffer = NULL;\r\n}\r\n}\r\nrc = kobject_add(&elog->kobj, NULL, "0x%llx", id);\r\nif (rc) {\r\nkobject_put(&elog->kobj);\r\nreturn NULL;\r\n}\r\nrc = sysfs_create_bin_file(&elog->kobj, &elog->raw_attr);\r\nif (rc) {\r\nkobject_put(&elog->kobj);\r\nreturn NULL;\r\n}\r\nkobject_uevent(&elog->kobj, KOBJ_ADD);\r\nreturn elog;\r\n}\r\nstatic void elog_work_fn(struct work_struct *work)\r\n{\r\n__be64 size;\r\n__be64 id;\r\n__be64 type;\r\nuint64_t elog_size;\r\nuint64_t log_id;\r\nuint64_t elog_type;\r\nint rc;\r\nchar name[2+16+1];\r\nrc = opal_get_elog_size(&id, &size, &type);\r\nif (rc != OPAL_SUCCESS) {\r\npr_err("ELOG: OPAL log info read failed\n");\r\nreturn;\r\n}\r\nelog_size = be64_to_cpu(size);\r\nlog_id = be64_to_cpu(id);\r\nelog_type = be64_to_cpu(type);\r\nWARN_ON(elog_size > OPAL_MAX_ERRLOG_SIZE);\r\nif (elog_size >= OPAL_MAX_ERRLOG_SIZE)\r\nelog_size = OPAL_MAX_ERRLOG_SIZE;\r\nsprintf(name, "0x%llx", log_id);\r\nif (kset_find_obj(elog_kset, name))\r\nreturn;\r\ncreate_elog_obj(log_id, elog_size, elog_type);\r\n}\r\nstatic int elog_event(struct notifier_block *nb,\r\nunsigned long events, void *change)\r\n{\r\nif (events & OPAL_EVENT_ERROR_LOG_AVAIL)\r\nschedule_work(&elog_work);\r\nreturn 0;\r\n}\r\nint __init opal_elog_init(void)\r\n{\r\nint rc = 0;\r\nif (!opal_check_token(OPAL_ELOG_READ))\r\nreturn -1;\r\nelog_kset = kset_create_and_add("elog", NULL, opal_kobj);\r\nif (!elog_kset) {\r\npr_warn("%s: failed to create elog kset\n", __func__);\r\nreturn -1;\r\n}\r\nrc = opal_notifier_register(&elog_nb);\r\nif (rc) {\r\npr_err("%s: Can't register OPAL event notifier (%d)\n",\r\n__func__, rc);\r\nreturn rc;\r\n}\r\nopal_resend_pending_logs();\r\nreturn 0;\r\n}

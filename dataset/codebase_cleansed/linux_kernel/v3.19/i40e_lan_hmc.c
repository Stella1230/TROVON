static u64 i40e_align_l2obj_base(u64 offset)\r\n{\r\nu64 aligned_offset = offset;\r\nif ((offset % I40E_HMC_L2OBJ_BASE_ALIGNMENT) > 0)\r\naligned_offset += (I40E_HMC_L2OBJ_BASE_ALIGNMENT -\r\n(offset % I40E_HMC_L2OBJ_BASE_ALIGNMENT));\r\nreturn aligned_offset;\r\n}\r\nstatic u64 i40e_calculate_l2fpm_size(u32 txq_num, u32 rxq_num,\r\nu32 fcoe_cntx_num, u32 fcoe_filt_num)\r\n{\r\nu64 fpm_size = 0;\r\nfpm_size = txq_num * I40E_HMC_OBJ_SIZE_TXQ;\r\nfpm_size = i40e_align_l2obj_base(fpm_size);\r\nfpm_size += (rxq_num * I40E_HMC_OBJ_SIZE_RXQ);\r\nfpm_size = i40e_align_l2obj_base(fpm_size);\r\nfpm_size += (fcoe_cntx_num * I40E_HMC_OBJ_SIZE_FCOE_CNTX);\r\nfpm_size = i40e_align_l2obj_base(fpm_size);\r\nfpm_size += (fcoe_filt_num * I40E_HMC_OBJ_SIZE_FCOE_FILT);\r\nfpm_size = i40e_align_l2obj_base(fpm_size);\r\nreturn fpm_size;\r\n}\r\ni40e_status i40e_init_lan_hmc(struct i40e_hw *hw, u32 txq_num,\r\nu32 rxq_num, u32 fcoe_cntx_num,\r\nu32 fcoe_filt_num)\r\n{\r\nstruct i40e_hmc_obj_info *obj, *full_obj;\r\ni40e_status ret_code = 0;\r\nu64 l2fpm_size;\r\nu32 size_exp;\r\nhw->hmc.signature = I40E_HMC_INFO_SIGNATURE;\r\nhw->hmc.hmc_fn_id = hw->pf_id;\r\nret_code = i40e_allocate_virt_mem(hw, &hw->hmc.hmc_obj_virt_mem,\r\nsizeof(struct i40e_hmc_obj_info) * I40E_HMC_LAN_MAX);\r\nif (ret_code)\r\ngoto init_lan_hmc_out;\r\nhw->hmc.hmc_obj = (struct i40e_hmc_obj_info *)\r\nhw->hmc.hmc_obj_virt_mem.va;\r\nfull_obj = &hw->hmc.hmc_obj[I40E_HMC_LAN_FULL];\r\nfull_obj->max_cnt = 0;\r\nfull_obj->cnt = 0;\r\nfull_obj->base = 0;\r\nfull_obj->size = 0;\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_TX];\r\nobj->max_cnt = rd32(hw, I40E_GLHMC_LANQMAX);\r\nobj->cnt = txq_num;\r\nobj->base = 0;\r\nsize_exp = rd32(hw, I40E_GLHMC_LANTXOBJSZ);\r\nobj->size = (u64)1 << size_exp;\r\nif (txq_num > obj->max_cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_COUNT;\r\nhw_dbg(hw, "i40e_init_lan_hmc: Tx context: asks for 0x%x but max allowed is 0x%x, returns error %d\n",\r\ntxq_num, obj->max_cnt, ret_code);\r\ngoto init_lan_hmc_out;\r\n}\r\nfull_obj->max_cnt += obj->max_cnt;\r\nfull_obj->cnt += obj->cnt;\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_RX];\r\nobj->max_cnt = rd32(hw, I40E_GLHMC_LANQMAX);\r\nobj->cnt = rxq_num;\r\nobj->base = hw->hmc.hmc_obj[I40E_HMC_LAN_TX].base +\r\n(hw->hmc.hmc_obj[I40E_HMC_LAN_TX].cnt *\r\nhw->hmc.hmc_obj[I40E_HMC_LAN_TX].size);\r\nobj->base = i40e_align_l2obj_base(obj->base);\r\nsize_exp = rd32(hw, I40E_GLHMC_LANRXOBJSZ);\r\nobj->size = (u64)1 << size_exp;\r\nif (rxq_num > obj->max_cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_COUNT;\r\nhw_dbg(hw, "i40e_init_lan_hmc: Rx context: asks for 0x%x but max allowed is 0x%x, returns error %d\n",\r\nrxq_num, obj->max_cnt, ret_code);\r\ngoto init_lan_hmc_out;\r\n}\r\nfull_obj->max_cnt += obj->max_cnt;\r\nfull_obj->cnt += obj->cnt;\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX];\r\nobj->max_cnt = rd32(hw, I40E_GLHMC_FCOEMAX);\r\nobj->cnt = fcoe_cntx_num;\r\nobj->base = hw->hmc.hmc_obj[I40E_HMC_LAN_RX].base +\r\n(hw->hmc.hmc_obj[I40E_HMC_LAN_RX].cnt *\r\nhw->hmc.hmc_obj[I40E_HMC_LAN_RX].size);\r\nobj->base = i40e_align_l2obj_base(obj->base);\r\nsize_exp = rd32(hw, I40E_GLHMC_FCOEDDPOBJSZ);\r\nobj->size = (u64)1 << size_exp;\r\nif (fcoe_cntx_num > obj->max_cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_COUNT;\r\nhw_dbg(hw, "i40e_init_lan_hmc: FCoE context: asks for 0x%x but max allowed is 0x%x, returns error %d\n",\r\nfcoe_cntx_num, obj->max_cnt, ret_code);\r\ngoto init_lan_hmc_out;\r\n}\r\nfull_obj->max_cnt += obj->max_cnt;\r\nfull_obj->cnt += obj->cnt;\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_FILT];\r\nobj->max_cnt = rd32(hw, I40E_GLHMC_FCOEFMAX);\r\nobj->cnt = fcoe_filt_num;\r\nobj->base = hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX].base +\r\n(hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX].cnt *\r\nhw->hmc.hmc_obj[I40E_HMC_FCOE_CTX].size);\r\nobj->base = i40e_align_l2obj_base(obj->base);\r\nsize_exp = rd32(hw, I40E_GLHMC_FCOEFOBJSZ);\r\nobj->size = (u64)1 << size_exp;\r\nif (fcoe_filt_num > obj->max_cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_COUNT;\r\nhw_dbg(hw, "i40e_init_lan_hmc: FCoE filter: asks for 0x%x but max allowed is 0x%x, returns error %d\n",\r\nfcoe_filt_num, obj->max_cnt, ret_code);\r\ngoto init_lan_hmc_out;\r\n}\r\nfull_obj->max_cnt += obj->max_cnt;\r\nfull_obj->cnt += obj->cnt;\r\nhw->hmc.first_sd_index = 0;\r\nhw->hmc.sd_table.ref_cnt = 0;\r\nl2fpm_size = i40e_calculate_l2fpm_size(txq_num, rxq_num, fcoe_cntx_num,\r\nfcoe_filt_num);\r\nif (NULL == hw->hmc.sd_table.sd_entry) {\r\nhw->hmc.sd_table.sd_cnt = (u32)\r\n(l2fpm_size + I40E_HMC_DIRECT_BP_SIZE - 1) /\r\nI40E_HMC_DIRECT_BP_SIZE;\r\nret_code = i40e_allocate_virt_mem(hw, &hw->hmc.sd_table.addr,\r\n(sizeof(struct i40e_hmc_sd_entry) *\r\nhw->hmc.sd_table.sd_cnt));\r\nif (ret_code)\r\ngoto init_lan_hmc_out;\r\nhw->hmc.sd_table.sd_entry =\r\n(struct i40e_hmc_sd_entry *)hw->hmc.sd_table.addr.va;\r\n}\r\nfull_obj->size = l2fpm_size;\r\ninit_lan_hmc_out:\r\nreturn ret_code;\r\n}\r\nstatic i40e_status i40e_remove_pd_page(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 idx)\r\n{\r\ni40e_status ret_code = 0;\r\nif (!i40e_prep_remove_pd_page(hmc_info, idx))\r\nret_code = i40e_remove_pd_page_new(hw, hmc_info, idx, true);\r\nreturn ret_code;\r\n}\r\nstatic i40e_status i40e_remove_sd_bp(struct i40e_hw *hw,\r\nstruct i40e_hmc_info *hmc_info,\r\nu32 idx)\r\n{\r\ni40e_status ret_code = 0;\r\nif (!i40e_prep_remove_sd_bp(hmc_info, idx))\r\nret_code = i40e_remove_sd_bp_new(hw, hmc_info, idx, true);\r\nreturn ret_code;\r\n}\r\nstatic i40e_status i40e_create_lan_hmc_object(struct i40e_hw *hw,\r\nstruct i40e_hmc_lan_create_obj_info *info)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nu32 pd_idx1 = 0, pd_lmt1 = 0;\r\nu32 pd_idx = 0, pd_lmt = 0;\r\nbool pd_error = false;\r\nu32 sd_idx, sd_lmt;\r\nu64 sd_size;\r\nu32 i, j;\r\nif (NULL == info) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_create_lan_hmc_object: bad info ptr\n");\r\ngoto exit;\r\n}\r\nif (NULL == info->hmc_info) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_create_lan_hmc_object: bad hmc_info ptr\n");\r\ngoto exit;\r\n}\r\nif (I40E_HMC_INFO_SIGNATURE != info->hmc_info->signature) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_create_lan_hmc_object: bad signature\n");\r\ngoto exit;\r\n}\r\nif (info->start_idx >= info->hmc_info->hmc_obj[info->rsrc_type].cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_INDEX;\r\nhw_dbg(hw, "i40e_create_lan_hmc_object: returns error %d\n",\r\nret_code);\r\ngoto exit;\r\n}\r\nif ((info->start_idx + info->count) >\r\ninfo->hmc_info->hmc_obj[info->rsrc_type].cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_COUNT;\r\nhw_dbg(hw, "i40e_create_lan_hmc_object: returns error %d\n",\r\nret_code);\r\ngoto exit;\r\n}\r\nI40E_FIND_SD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\r\ninfo->start_idx, info->count,\r\n&sd_idx, &sd_lmt);\r\nif (sd_idx >= info->hmc_info->sd_table.sd_cnt ||\r\nsd_lmt > info->hmc_info->sd_table.sd_cnt) {\r\nret_code = I40E_ERR_INVALID_SD_INDEX;\r\ngoto exit;\r\n}\r\nI40E_FIND_PD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\r\ninfo->start_idx, info->count, &pd_idx,\r\n&pd_lmt);\r\nif (info->direct_mode_sz == 0)\r\nsd_size = I40E_HMC_DIRECT_BP_SIZE;\r\nelse\r\nsd_size = info->direct_mode_sz;\r\nfor (j = sd_idx; j < sd_lmt; j++) {\r\nret_code = i40e_add_sd_table_entry(hw, info->hmc_info, j,\r\ninfo->entry_type,\r\nsd_size);\r\nif (ret_code)\r\ngoto exit_sd_error;\r\nsd_entry = &info->hmc_info->sd_table.sd_entry[j];\r\nif (I40E_SD_TYPE_PAGED == sd_entry->entry_type) {\r\npd_idx1 = max(pd_idx, (j * I40E_HMC_MAX_BP_COUNT));\r\npd_lmt1 = min(pd_lmt,\r\n((j + 1) * I40E_HMC_MAX_BP_COUNT));\r\nfor (i = pd_idx1; i < pd_lmt1; i++) {\r\nret_code = i40e_add_pd_table_entry(hw,\r\ninfo->hmc_info,\r\ni);\r\nif (ret_code) {\r\npd_error = true;\r\nbreak;\r\n}\r\n}\r\nif (pd_error) {\r\nwhile (i && (i > pd_idx1)) {\r\ni40e_remove_pd_bp(hw, info->hmc_info,\r\n(i - 1));\r\ni--;\r\n}\r\n}\r\n}\r\nif (!sd_entry->valid) {\r\nsd_entry->valid = true;\r\nswitch (sd_entry->entry_type) {\r\ncase I40E_SD_TYPE_PAGED:\r\nI40E_SET_PF_SD_ENTRY(hw,\r\nsd_entry->u.pd_table.pd_page_addr.pa,\r\nj, sd_entry->entry_type);\r\nbreak;\r\ncase I40E_SD_TYPE_DIRECT:\r\nI40E_SET_PF_SD_ENTRY(hw, sd_entry->u.bp.addr.pa,\r\nj, sd_entry->entry_type);\r\nbreak;\r\ndefault:\r\nret_code = I40E_ERR_INVALID_SD_TYPE;\r\ngoto exit;\r\n}\r\n}\r\n}\r\ngoto exit;\r\nexit_sd_error:\r\nwhile (j && (j > sd_idx)) {\r\nsd_entry = &info->hmc_info->sd_table.sd_entry[j - 1];\r\nswitch (sd_entry->entry_type) {\r\ncase I40E_SD_TYPE_PAGED:\r\npd_idx1 = max(pd_idx,\r\n((j - 1) * I40E_HMC_MAX_BP_COUNT));\r\npd_lmt1 = min(pd_lmt, (j * I40E_HMC_MAX_BP_COUNT));\r\nfor (i = pd_idx1; i < pd_lmt1; i++) {\r\ni40e_remove_pd_bp(hw, info->hmc_info, i);\r\n}\r\ni40e_remove_pd_page(hw, info->hmc_info, (j - 1));\r\nbreak;\r\ncase I40E_SD_TYPE_DIRECT:\r\ni40e_remove_sd_bp(hw, info->hmc_info, (j - 1));\r\nbreak;\r\ndefault:\r\nret_code = I40E_ERR_INVALID_SD_TYPE;\r\nbreak;\r\n}\r\nj--;\r\n}\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_configure_lan_hmc(struct i40e_hw *hw,\r\nenum i40e_hmc_model model)\r\n{\r\nstruct i40e_hmc_lan_create_obj_info info;\r\ni40e_status ret_code = 0;\r\nu8 hmc_fn_id = hw->hmc.hmc_fn_id;\r\nstruct i40e_hmc_obj_info *obj;\r\ninfo.hmc_info = &hw->hmc;\r\ninfo.rsrc_type = I40E_HMC_LAN_FULL;\r\ninfo.start_idx = 0;\r\ninfo.direct_mode_sz = hw->hmc.hmc_obj[I40E_HMC_LAN_FULL].size;\r\nswitch (model) {\r\ncase I40E_HMC_MODEL_DIRECT_PREFERRED:\r\ncase I40E_HMC_MODEL_DIRECT_ONLY:\r\ninfo.entry_type = I40E_SD_TYPE_DIRECT;\r\ninfo.count = 1;\r\nret_code = i40e_create_lan_hmc_object(hw, &info);\r\nif (ret_code && (model == I40E_HMC_MODEL_DIRECT_PREFERRED))\r\ngoto try_type_paged;\r\nelse if (ret_code)\r\ngoto configure_lan_hmc_out;\r\nbreak;\r\ncase I40E_HMC_MODEL_PAGED_ONLY:\r\ntry_type_paged:\r\ninfo.entry_type = I40E_SD_TYPE_PAGED;\r\ninfo.count = 1;\r\nret_code = i40e_create_lan_hmc_object(hw, &info);\r\nif (ret_code)\r\ngoto configure_lan_hmc_out;\r\nbreak;\r\ndefault:\r\nret_code = I40E_ERR_INVALID_SD_TYPE;\r\nhw_dbg(hw, "i40e_configure_lan_hmc: Unknown SD type: %d\n",\r\nret_code);\r\ngoto configure_lan_hmc_out;\r\n}\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_TX];\r\nwr32(hw, I40E_GLHMC_LANTXBASE(hmc_fn_id),\r\n(u32)((obj->base & I40E_GLHMC_LANTXBASE_FPMLANTXBASE_MASK) / 512));\r\nwr32(hw, I40E_GLHMC_LANTXCNT(hmc_fn_id), obj->cnt);\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_LAN_RX];\r\nwr32(hw, I40E_GLHMC_LANRXBASE(hmc_fn_id),\r\n(u32)((obj->base & I40E_GLHMC_LANRXBASE_FPMLANRXBASE_MASK) / 512));\r\nwr32(hw, I40E_GLHMC_LANRXCNT(hmc_fn_id), obj->cnt);\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_CTX];\r\nwr32(hw, I40E_GLHMC_FCOEDDPBASE(hmc_fn_id),\r\n(u32)((obj->base & I40E_GLHMC_FCOEDDPBASE_FPMFCOEDDPBASE_MASK) / 512));\r\nwr32(hw, I40E_GLHMC_FCOEDDPCNT(hmc_fn_id), obj->cnt);\r\nobj = &hw->hmc.hmc_obj[I40E_HMC_FCOE_FILT];\r\nwr32(hw, I40E_GLHMC_FCOEFBASE(hmc_fn_id),\r\n(u32)((obj->base & I40E_GLHMC_FCOEFBASE_FPMFCOEFBASE_MASK) / 512));\r\nwr32(hw, I40E_GLHMC_FCOEFCNT(hmc_fn_id), obj->cnt);\r\nconfigure_lan_hmc_out:\r\nreturn ret_code;\r\n}\r\nstatic i40e_status i40e_delete_lan_hmc_object(struct i40e_hw *hw,\r\nstruct i40e_hmc_lan_delete_obj_info *info)\r\n{\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_pd_table *pd_table;\r\nu32 pd_idx, pd_lmt, rel_pd_idx;\r\nu32 sd_idx, sd_lmt;\r\nu32 i, j;\r\nif (NULL == info) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_delete_hmc_object: bad info ptr\n");\r\ngoto exit;\r\n}\r\nif (NULL == info->hmc_info) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_delete_hmc_object: bad info->hmc_info ptr\n");\r\ngoto exit;\r\n}\r\nif (I40E_HMC_INFO_SIGNATURE != info->hmc_info->signature) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_delete_hmc_object: bad hmc_info->signature\n");\r\ngoto exit;\r\n}\r\nif (NULL == info->hmc_info->sd_table.sd_entry) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_delete_hmc_object: bad sd_entry\n");\r\ngoto exit;\r\n}\r\nif (NULL == info->hmc_info->hmc_obj) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_delete_hmc_object: bad hmc_info->hmc_obj\n");\r\ngoto exit;\r\n}\r\nif (info->start_idx >= info->hmc_info->hmc_obj[info->rsrc_type].cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_INDEX;\r\nhw_dbg(hw, "i40e_delete_hmc_object: returns error %d\n",\r\nret_code);\r\ngoto exit;\r\n}\r\nif ((info->start_idx + info->count) >\r\ninfo->hmc_info->hmc_obj[info->rsrc_type].cnt) {\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_COUNT;\r\nhw_dbg(hw, "i40e_delete_hmc_object: returns error %d\n",\r\nret_code);\r\ngoto exit;\r\n}\r\nI40E_FIND_PD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\r\ninfo->start_idx, info->count, &pd_idx,\r\n&pd_lmt);\r\nfor (j = pd_idx; j < pd_lmt; j++) {\r\nsd_idx = j / I40E_HMC_PD_CNT_IN_SD;\r\nif (I40E_SD_TYPE_PAGED !=\r\ninfo->hmc_info->sd_table.sd_entry[sd_idx].entry_type)\r\ncontinue;\r\nrel_pd_idx = j % I40E_HMC_PD_CNT_IN_SD;\r\npd_table =\r\n&info->hmc_info->sd_table.sd_entry[sd_idx].u.pd_table;\r\nif (pd_table->pd_entry[rel_pd_idx].valid) {\r\nret_code = i40e_remove_pd_bp(hw, info->hmc_info, j);\r\nif (ret_code)\r\ngoto exit;\r\n}\r\n}\r\nI40E_FIND_SD_INDEX_LIMIT(info->hmc_info, info->rsrc_type,\r\ninfo->start_idx, info->count,\r\n&sd_idx, &sd_lmt);\r\nif (sd_idx >= info->hmc_info->sd_table.sd_cnt ||\r\nsd_lmt > info->hmc_info->sd_table.sd_cnt) {\r\nret_code = I40E_ERR_INVALID_SD_INDEX;\r\ngoto exit;\r\n}\r\nfor (i = sd_idx; i < sd_lmt; i++) {\r\nif (!info->hmc_info->sd_table.sd_entry[i].valid)\r\ncontinue;\r\nswitch (info->hmc_info->sd_table.sd_entry[i].entry_type) {\r\ncase I40E_SD_TYPE_DIRECT:\r\nret_code = i40e_remove_sd_bp(hw, info->hmc_info, i);\r\nif (ret_code)\r\ngoto exit;\r\nbreak;\r\ncase I40E_SD_TYPE_PAGED:\r\nret_code = i40e_remove_pd_page(hw, info->hmc_info, i);\r\nif (ret_code)\r\ngoto exit;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_shutdown_lan_hmc(struct i40e_hw *hw)\r\n{\r\nstruct i40e_hmc_lan_delete_obj_info info;\r\ni40e_status ret_code;\r\ninfo.hmc_info = &hw->hmc;\r\ninfo.rsrc_type = I40E_HMC_LAN_FULL;\r\ninfo.start_idx = 0;\r\ninfo.count = 1;\r\nret_code = i40e_delete_lan_hmc_object(hw, &info);\r\ni40e_free_virt_mem(hw, &hw->hmc.sd_table.addr);\r\nhw->hmc.sd_table.sd_cnt = 0;\r\nhw->hmc.sd_table.sd_entry = NULL;\r\ni40e_free_virt_mem(hw, &hw->hmc.hmc_obj_virt_mem);\r\nhw->hmc.hmc_obj = NULL;\r\nreturn ret_code;\r\n}\r\nstatic void i40e_write_byte(u8 *hmc_bits,\r\nstruct i40e_context_ele *ce_info,\r\nu8 *src)\r\n{\r\nu8 src_byte, dest_byte, mask;\r\nu8 *from, *dest;\r\nu16 shift_width;\r\nfrom = src + ce_info->offset;\r\nshift_width = ce_info->lsb % 8;\r\nmask = ((u8)1 << ce_info->width) - 1;\r\nsrc_byte = *from;\r\nsrc_byte &= mask;\r\nmask <<= shift_width;\r\nsrc_byte <<= shift_width;\r\ndest = hmc_bits + (ce_info->lsb / 8);\r\nmemcpy(&dest_byte, dest, sizeof(dest_byte));\r\ndest_byte &= ~mask;\r\ndest_byte |= src_byte;\r\nmemcpy(dest, &dest_byte, sizeof(dest_byte));\r\n}\r\nstatic void i40e_write_word(u8 *hmc_bits,\r\nstruct i40e_context_ele *ce_info,\r\nu8 *src)\r\n{\r\nu16 src_word, mask;\r\nu8 *from, *dest;\r\nu16 shift_width;\r\n__le16 dest_word;\r\nfrom = src + ce_info->offset;\r\nshift_width = ce_info->lsb % 8;\r\nmask = ((u16)1 << ce_info->width) - 1;\r\nsrc_word = *(u16 *)from;\r\nsrc_word &= mask;\r\nmask <<= shift_width;\r\nsrc_word <<= shift_width;\r\ndest = hmc_bits + (ce_info->lsb / 8);\r\nmemcpy(&dest_word, dest, sizeof(dest_word));\r\ndest_word &= ~(cpu_to_le16(mask));\r\ndest_word |= cpu_to_le16(src_word);\r\nmemcpy(dest, &dest_word, sizeof(dest_word));\r\n}\r\nstatic void i40e_write_dword(u8 *hmc_bits,\r\nstruct i40e_context_ele *ce_info,\r\nu8 *src)\r\n{\r\nu32 src_dword, mask;\r\nu8 *from, *dest;\r\nu16 shift_width;\r\n__le32 dest_dword;\r\nfrom = src + ce_info->offset;\r\nshift_width = ce_info->lsb % 8;\r\nif (ce_info->width < 32)\r\nmask = ((u32)1 << ce_info->width) - 1;\r\nelse\r\nmask = 0xFFFFFFFF;\r\nsrc_dword = *(u32 *)from;\r\nsrc_dword &= mask;\r\nmask <<= shift_width;\r\nsrc_dword <<= shift_width;\r\ndest = hmc_bits + (ce_info->lsb / 8);\r\nmemcpy(&dest_dword, dest, sizeof(dest_dword));\r\ndest_dword &= ~(cpu_to_le32(mask));\r\ndest_dword |= cpu_to_le32(src_dword);\r\nmemcpy(dest, &dest_dword, sizeof(dest_dword));\r\n}\r\nstatic void i40e_write_qword(u8 *hmc_bits,\r\nstruct i40e_context_ele *ce_info,\r\nu8 *src)\r\n{\r\nu64 src_qword, mask;\r\nu8 *from, *dest;\r\nu16 shift_width;\r\n__le64 dest_qword;\r\nfrom = src + ce_info->offset;\r\nshift_width = ce_info->lsb % 8;\r\nif (ce_info->width < 64)\r\nmask = ((u64)1 << ce_info->width) - 1;\r\nelse\r\nmask = 0xFFFFFFFFFFFFFFFF;\r\nsrc_qword = *(u64 *)from;\r\nsrc_qword &= mask;\r\nmask <<= shift_width;\r\nsrc_qword <<= shift_width;\r\ndest = hmc_bits + (ce_info->lsb / 8);\r\nmemcpy(&dest_qword, dest, sizeof(dest_qword));\r\ndest_qword &= ~(cpu_to_le64(mask));\r\ndest_qword |= cpu_to_le64(src_qword);\r\nmemcpy(dest, &dest_qword, sizeof(dest_qword));\r\n}\r\nstatic i40e_status i40e_clear_hmc_context(struct i40e_hw *hw,\r\nu8 *context_bytes,\r\nenum i40e_hmc_lan_rsrc_type hmc_type)\r\n{\r\nmemset(context_bytes, 0, (u32)hw->hmc.hmc_obj[hmc_type].size);\r\nreturn 0;\r\n}\r\nstatic i40e_status i40e_set_hmc_context(u8 *context_bytes,\r\nstruct i40e_context_ele *ce_info,\r\nu8 *dest)\r\n{\r\nint f;\r\nfor (f = 0; ce_info[f].width != 0; f++) {\r\nswitch (ce_info[f].size_of) {\r\ncase 1:\r\ni40e_write_byte(context_bytes, &ce_info[f], dest);\r\nbreak;\r\ncase 2:\r\ni40e_write_word(context_bytes, &ce_info[f], dest);\r\nbreak;\r\ncase 4:\r\ni40e_write_dword(context_bytes, &ce_info[f], dest);\r\nbreak;\r\ncase 8:\r\ni40e_write_qword(context_bytes, &ce_info[f], dest);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic\r\ni40e_status i40e_hmc_get_object_va(struct i40e_hmc_info *hmc_info,\r\nu8 **object_base,\r\nenum i40e_hmc_lan_rsrc_type rsrc_type,\r\nu32 obj_idx)\r\n{\r\nu32 obj_offset_in_sd, obj_offset_in_pd;\r\ni40e_status ret_code = 0;\r\nstruct i40e_hmc_sd_entry *sd_entry;\r\nstruct i40e_hmc_pd_entry *pd_entry;\r\nu32 pd_idx, pd_lmt, rel_pd_idx;\r\nu64 obj_offset_in_fpm;\r\nu32 sd_idx, sd_lmt;\r\nif (NULL == hmc_info) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_hmc_get_object_va: bad hmc_info ptr\n");\r\ngoto exit;\r\n}\r\nif (NULL == hmc_info->hmc_obj) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_hmc_get_object_va: bad hmc_info->hmc_obj ptr\n");\r\ngoto exit;\r\n}\r\nif (NULL == object_base) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_hmc_get_object_va: bad object_base ptr\n");\r\ngoto exit;\r\n}\r\nif (I40E_HMC_INFO_SIGNATURE != hmc_info->signature) {\r\nret_code = I40E_ERR_BAD_PTR;\r\nhw_dbg(hw, "i40e_hmc_get_object_va: bad hmc_info->signature\n");\r\ngoto exit;\r\n}\r\nif (obj_idx >= hmc_info->hmc_obj[rsrc_type].cnt) {\r\nhw_dbg(hw, "i40e_hmc_get_object_va: returns error %d\n",\r\nret_code);\r\nret_code = I40E_ERR_INVALID_HMC_OBJ_INDEX;\r\ngoto exit;\r\n}\r\nI40E_FIND_SD_INDEX_LIMIT(hmc_info, rsrc_type, obj_idx, 1,\r\n&sd_idx, &sd_lmt);\r\nsd_entry = &hmc_info->sd_table.sd_entry[sd_idx];\r\nobj_offset_in_fpm = hmc_info->hmc_obj[rsrc_type].base +\r\nhmc_info->hmc_obj[rsrc_type].size * obj_idx;\r\nif (I40E_SD_TYPE_PAGED == sd_entry->entry_type) {\r\nI40E_FIND_PD_INDEX_LIMIT(hmc_info, rsrc_type, obj_idx, 1,\r\n&pd_idx, &pd_lmt);\r\nrel_pd_idx = pd_idx % I40E_HMC_PD_CNT_IN_SD;\r\npd_entry = &sd_entry->u.pd_table.pd_entry[rel_pd_idx];\r\nobj_offset_in_pd = (u32)(obj_offset_in_fpm %\r\nI40E_HMC_PAGED_BP_SIZE);\r\n*object_base = (u8 *)pd_entry->bp.addr.va + obj_offset_in_pd;\r\n} else {\r\nobj_offset_in_sd = (u32)(obj_offset_in_fpm %\r\nI40E_HMC_DIRECT_BP_SIZE);\r\n*object_base = (u8 *)sd_entry->u.bp.addr.va + obj_offset_in_sd;\r\n}\r\nexit:\r\nreturn ret_code;\r\n}\r\ni40e_status i40e_clear_lan_tx_queue_context(struct i40e_hw *hw,\r\nu16 queue)\r\n{\r\ni40e_status err;\r\nu8 *context_bytes;\r\nerr = i40e_hmc_get_object_va(&hw->hmc, &context_bytes,\r\nI40E_HMC_LAN_TX, queue);\r\nif (err < 0)\r\nreturn err;\r\nreturn i40e_clear_hmc_context(hw, context_bytes, I40E_HMC_LAN_TX);\r\n}\r\ni40e_status i40e_set_lan_tx_queue_context(struct i40e_hw *hw,\r\nu16 queue,\r\nstruct i40e_hmc_obj_txq *s)\r\n{\r\ni40e_status err;\r\nu8 *context_bytes;\r\nerr = i40e_hmc_get_object_va(&hw->hmc, &context_bytes,\r\nI40E_HMC_LAN_TX, queue);\r\nif (err < 0)\r\nreturn err;\r\nreturn i40e_set_hmc_context(context_bytes,\r\ni40e_hmc_txq_ce_info, (u8 *)s);\r\n}\r\ni40e_status i40e_clear_lan_rx_queue_context(struct i40e_hw *hw,\r\nu16 queue)\r\n{\r\ni40e_status err;\r\nu8 *context_bytes;\r\nerr = i40e_hmc_get_object_va(&hw->hmc, &context_bytes,\r\nI40E_HMC_LAN_RX, queue);\r\nif (err < 0)\r\nreturn err;\r\nreturn i40e_clear_hmc_context(hw, context_bytes, I40E_HMC_LAN_RX);\r\n}\r\ni40e_status i40e_set_lan_rx_queue_context(struct i40e_hw *hw,\r\nu16 queue,\r\nstruct i40e_hmc_obj_rxq *s)\r\n{\r\ni40e_status err;\r\nu8 *context_bytes;\r\nerr = i40e_hmc_get_object_va(&hw->hmc, &context_bytes,\r\nI40E_HMC_LAN_RX, queue);\r\nif (err < 0)\r\nreturn err;\r\nreturn i40e_set_hmc_context(context_bytes,\r\ni40e_hmc_rxq_ce_info, (u8 *)s);\r\n}

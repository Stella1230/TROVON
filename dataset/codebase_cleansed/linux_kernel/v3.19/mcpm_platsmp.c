static void cpu_to_pcpu(unsigned int cpu,\r\nunsigned int *pcpu, unsigned int *pcluster)\r\n{\r\nunsigned int mpidr;\r\nmpidr = cpu_logical_map(cpu);\r\n*pcpu = MPIDR_AFFINITY_LEVEL(mpidr, 0);\r\n*pcluster = MPIDR_AFFINITY_LEVEL(mpidr, 1);\r\n}\r\nstatic int mcpm_boot_secondary(unsigned int cpu, struct task_struct *idle)\r\n{\r\nunsigned int pcpu, pcluster, ret;\r\nextern void secondary_startup(void);\r\ncpu_to_pcpu(cpu, &pcpu, &pcluster);\r\npr_debug("%s: logical CPU %d is physical CPU %d cluster %d\n",\r\n__func__, cpu, pcpu, pcluster);\r\nmcpm_set_entry_vector(pcpu, pcluster, NULL);\r\nret = mcpm_cpu_power_up(pcpu, pcluster);\r\nif (ret)\r\nreturn ret;\r\nmcpm_set_entry_vector(pcpu, pcluster, secondary_startup);\r\narch_send_wakeup_ipi_mask(cpumask_of(cpu));\r\ndsb_sev();\r\nreturn 0;\r\n}\r\nstatic void mcpm_secondary_init(unsigned int cpu)\r\n{\r\nmcpm_cpu_powered_up();\r\n}\r\nstatic int mcpm_cpu_kill(unsigned int cpu)\r\n{\r\nunsigned int pcpu, pcluster;\r\ncpu_to_pcpu(cpu, &pcpu, &pcluster);\r\nreturn !mcpm_wait_for_cpu_powerdown(pcpu, pcluster);\r\n}\r\nstatic int mcpm_cpu_disable(unsigned int cpu)\r\n{\r\nreturn 0;\r\n}\r\nstatic void mcpm_cpu_die(unsigned int cpu)\r\n{\r\nunsigned int mpidr, pcpu, pcluster;\r\nmpidr = read_cpuid_mpidr();\r\npcpu = MPIDR_AFFINITY_LEVEL(mpidr, 0);\r\npcluster = MPIDR_AFFINITY_LEVEL(mpidr, 1);\r\nmcpm_set_entry_vector(pcpu, pcluster, NULL);\r\nmcpm_cpu_power_down();\r\n}\r\nvoid __init mcpm_smp_set_ops(void)\r\n{\r\nsmp_set_ops(&mcpm_smp_ops);\r\n}

static int max9768_get_gpio(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct max9768 *max9768 = snd_soc_codec_get_drvdata(codec);\r\nint val = gpio_get_value_cansleep(max9768->mute_gpio);\r\nucontrol->value.integer.value[0] = !val;\r\nreturn 0;\r\n}\r\nstatic int max9768_set_gpio(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_soc_codec *codec = snd_soc_kcontrol_codec(kcontrol);\r\nstruct max9768 *max9768 = snd_soc_codec_get_drvdata(codec);\r\ngpio_set_value_cansleep(max9768->mute_gpio, !ucontrol->value.integer.value[0]);\r\nreturn 0;\r\n}\r\nstatic int max9768_probe(struct snd_soc_codec *codec)\r\n{\r\nstruct max9768 *max9768 = snd_soc_codec_get_drvdata(codec);\r\nint ret;\r\nif (max9768->flags & MAX9768_FLAG_CLASSIC_PWM) {\r\nret = snd_soc_write(codec, MAX9768_CTRL, MAX9768_CTRL_PWM);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (gpio_is_valid(max9768->mute_gpio)) {\r\nret = snd_soc_add_codec_controls(codec, max9768_mute,\r\nARRAY_SIZE(max9768_mute));\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max9768_i2c_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max9768 *max9768;\r\nstruct max9768_pdata *pdata = client->dev.platform_data;\r\nint err;\r\nmax9768 = devm_kzalloc(&client->dev, sizeof(*max9768), GFP_KERNEL);\r\nif (!max9768)\r\nreturn -ENOMEM;\r\nif (pdata) {\r\nerr = gpio_request_one(pdata->mute_gpio, GPIOF_INIT_HIGH, "MAX9768 Mute");\r\nmax9768->mute_gpio = err ?: pdata->mute_gpio;\r\nerr = gpio_request_one(pdata->shdn_gpio, GPIOF_INIT_HIGH, "MAX9768 Shutdown");\r\nmax9768->shdn_gpio = err ?: pdata->shdn_gpio;\r\nmax9768->flags = pdata->flags;\r\n} else {\r\nmax9768->shdn_gpio = -EINVAL;\r\nmax9768->mute_gpio = -EINVAL;\r\n}\r\ni2c_set_clientdata(client, max9768);\r\nmax9768->regmap = devm_regmap_init_i2c(client, &max9768_i2c_regmap_config);\r\nif (IS_ERR(max9768->regmap)) {\r\nerr = PTR_ERR(max9768->regmap);\r\ngoto err_gpio_free;\r\n}\r\nerr = snd_soc_register_codec(&client->dev, &max9768_codec_driver, NULL, 0);\r\nif (err)\r\ngoto err_gpio_free;\r\nreturn 0;\r\nerr_gpio_free:\r\nif (gpio_is_valid(max9768->shdn_gpio))\r\ngpio_free(max9768->shdn_gpio);\r\nif (gpio_is_valid(max9768->mute_gpio))\r\ngpio_free(max9768->mute_gpio);\r\nreturn err;\r\n}\r\nstatic int max9768_i2c_remove(struct i2c_client *client)\r\n{\r\nstruct max9768 *max9768 = i2c_get_clientdata(client);\r\nsnd_soc_unregister_codec(&client->dev);\r\nif (gpio_is_valid(max9768->shdn_gpio))\r\ngpio_free(max9768->shdn_gpio);\r\nif (gpio_is_valid(max9768->mute_gpio))\r\ngpio_free(max9768->mute_gpio);\r\nreturn 0;\r\n}

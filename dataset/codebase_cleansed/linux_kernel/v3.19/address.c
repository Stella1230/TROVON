static\r\nint uwb_rc_dev_addr_mgmt(struct uwb_rc *rc,\r\nu8 bmOperationType, const u8 *baAddr,\r\nstruct uwb_rc_evt_dev_addr_mgmt *reply)\r\n{\r\nint result;\r\nstruct uwb_rc_cmd_dev_addr_mgmt *cmd;\r\nresult = -ENOMEM;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (cmd == NULL)\r\ngoto error_kzalloc;\r\ncmd->rccb.bCommandType = UWB_RC_CET_GENERAL;\r\ncmd->rccb.wCommand = cpu_to_le16(UWB_RC_CMD_DEV_ADDR_MGMT);\r\ncmd->bmOperationType = bmOperationType;\r\nif (baAddr) {\r\nsize_t size = 0;\r\nswitch (bmOperationType >> 1) {\r\ncase 0: size = 2; break;\r\ncase 1: size = 6; break;\r\ndefault: BUG();\r\n}\r\nmemcpy(cmd->baAddr, baAddr, size);\r\n}\r\nreply->rceb.bEventType = UWB_RC_CET_GENERAL;\r\nreply->rceb.wEvent = UWB_RC_CMD_DEV_ADDR_MGMT;\r\nresult = uwb_rc_cmd(rc, "DEV-ADDR-MGMT",\r\n&cmd->rccb, sizeof(*cmd),\r\n&reply->rceb, sizeof(*reply));\r\nif (result < 0)\r\ngoto error_cmd;\r\nif (result < sizeof(*reply)) {\r\ndev_err(&rc->uwb_dev.dev,\r\n"DEV-ADDR-MGMT: not enough data replied: "\r\n"%d vs %zu bytes needed\n", result, sizeof(*reply));\r\nresult = -ENOMSG;\r\n} else if (reply->bResultCode != UWB_RC_RES_SUCCESS) {\r\ndev_err(&rc->uwb_dev.dev,\r\n"DEV-ADDR-MGMT: command execution failed: %s (%d)\n",\r\nuwb_rc_strerror(reply->bResultCode),\r\nreply->bResultCode);\r\nresult = -EIO;\r\n} else\r\nresult = 0;\r\nerror_cmd:\r\nkfree(cmd);\r\nerror_kzalloc:\r\nreturn result;\r\n}\r\nstatic int uwb_rc_addr_set(struct uwb_rc *rc,\r\nconst void *_addr, enum uwb_addr_type type)\r\n{\r\nint result;\r\nu8 bmOperationType = 0x1;\r\nconst struct uwb_dev_addr *dev_addr = _addr;\r\nconst struct uwb_mac_addr *mac_addr = _addr;\r\nstruct uwb_rc_evt_dev_addr_mgmt reply;\r\nconst u8 *baAddr;\r\nresult = -EINVAL;\r\nswitch (type) {\r\ncase UWB_ADDR_DEV:\r\nbaAddr = dev_addr->data;\r\nbreak;\r\ncase UWB_ADDR_MAC:\r\nbaAddr = mac_addr->data;\r\nbmOperationType |= 0x2;\r\nbreak;\r\ndefault:\r\nreturn result;\r\n}\r\nreturn uwb_rc_dev_addr_mgmt(rc, bmOperationType, baAddr, &reply);\r\n}\r\nstatic int uwb_rc_addr_get(struct uwb_rc *rc,\r\nvoid *_addr, enum uwb_addr_type type)\r\n{\r\nint result;\r\nu8 bmOperationType = 0x0;\r\nstruct uwb_rc_evt_dev_addr_mgmt evt;\r\nstruct uwb_dev_addr *dev_addr = _addr;\r\nstruct uwb_mac_addr *mac_addr = _addr;\r\nu8 *baAddr;\r\nresult = -EINVAL;\r\nswitch (type) {\r\ncase UWB_ADDR_DEV:\r\nbaAddr = dev_addr->data;\r\nbreak;\r\ncase UWB_ADDR_MAC:\r\nbmOperationType |= 0x2;\r\nbaAddr = mac_addr->data;\r\nbreak;\r\ndefault:\r\nreturn result;\r\n}\r\nresult = uwb_rc_dev_addr_mgmt(rc, bmOperationType, baAddr, &evt);\r\nif (result == 0)\r\nswitch (type) {\r\ncase UWB_ADDR_DEV:\r\nmemcpy(&dev_addr->data, evt.baAddr,\r\nsizeof(dev_addr->data));\r\nbreak;\r\ncase UWB_ADDR_MAC:\r\nmemcpy(&mac_addr->data, evt.baAddr,\r\nsizeof(mac_addr->data));\r\nbreak;\r\ndefault:\r\nBUG();\r\n}\r\nreturn result;\r\n}\r\nint uwb_rc_mac_addr_get(struct uwb_rc *rc,\r\nstruct uwb_mac_addr *addr) {\r\nreturn uwb_rc_addr_get(rc, addr, UWB_ADDR_MAC);\r\n}\r\nint uwb_rc_dev_addr_get(struct uwb_rc *rc,\r\nstruct uwb_dev_addr *addr) {\r\nreturn uwb_rc_addr_get(rc, addr, UWB_ADDR_DEV);\r\n}\r\nint uwb_rc_mac_addr_set(struct uwb_rc *rc,\r\nconst struct uwb_mac_addr *addr)\r\n{\r\nint result = -EINVAL;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nresult = uwb_rc_addr_set(rc, addr, UWB_ADDR_MAC);\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\nreturn result;\r\n}\r\nint uwb_rc_dev_addr_set(struct uwb_rc *rc,\r\nconst struct uwb_dev_addr *addr)\r\n{\r\nint result = -EINVAL;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nresult = uwb_rc_addr_set(rc, addr, UWB_ADDR_DEV);\r\nrc->uwb_dev.dev_addr = *addr;\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\nreturn result;\r\n}\r\nint __uwb_mac_addr_assigned_check(struct device *dev, void *_addr)\r\n{\r\nstruct uwb_dev *uwb_dev = to_uwb_dev(dev);\r\nstruct uwb_mac_addr *addr = _addr;\r\nif (!uwb_mac_addr_cmp(addr, &uwb_dev->mac_addr))\r\nreturn !0;\r\nreturn 0;\r\n}\r\nint __uwb_dev_addr_assigned_check(struct device *dev, void *_addr)\r\n{\r\nstruct uwb_dev *uwb_dev = to_uwb_dev(dev);\r\nstruct uwb_dev_addr *addr = _addr;\r\nif (!uwb_dev_addr_cmp(addr, &uwb_dev->dev_addr))\r\nreturn !0;\r\nreturn 0;\r\n}\r\nint uwb_rc_dev_addr_assign(struct uwb_rc *rc)\r\n{\r\nstruct uwb_dev_addr new_addr;\r\ndo {\r\nget_random_bytes(new_addr.data, sizeof(new_addr.data));\r\n} while (new_addr.data[0] == 0x00 || new_addr.data[0] == 0xff\r\n|| __uwb_dev_addr_assigned(rc, &new_addr));\r\nreturn uwb_rc_dev_addr_set(rc, &new_addr);\r\n}\r\nint uwbd_evt_handle_rc_dev_addr_conflict(struct uwb_event *evt)\r\n{\r\nstruct uwb_rc *rc = evt->rc;\r\nreturn uwb_rc_dev_addr_assign(rc);\r\n}\r\nstatic ssize_t uwb_rc_mac_addr_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct uwb_dev *uwb_dev = to_uwb_dev(dev);\r\nstruct uwb_rc *rc = uwb_dev->rc;\r\nstruct uwb_mac_addr addr;\r\nssize_t result;\r\nmutex_lock(&rc->uwb_dev.mutex);\r\nresult = uwb_rc_addr_get(rc, &addr, UWB_ADDR_MAC);\r\nmutex_unlock(&rc->uwb_dev.mutex);\r\nif (result >= 0) {\r\nresult = uwb_mac_addr_print(buf, UWB_ADDR_STRSIZE, &addr);\r\nbuf[result++] = '\n';\r\n}\r\nreturn result;\r\n}\r\nstatic ssize_t uwb_rc_mac_addr_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct uwb_dev *uwb_dev = to_uwb_dev(dev);\r\nstruct uwb_rc *rc = uwb_dev->rc;\r\nstruct uwb_mac_addr addr;\r\nssize_t result;\r\nresult = sscanf(buf, "%hhx:%hhx:%hhx:%hhx:%hhx:%hhx\n",\r\n&addr.data[0], &addr.data[1], &addr.data[2],\r\n&addr.data[3], &addr.data[4], &addr.data[5]);\r\nif (result != 6) {\r\nresult = -EINVAL;\r\ngoto out;\r\n}\r\nif (is_multicast_ether_addr(addr.data)) {\r\ndev_err(&rc->uwb_dev.dev, "refusing to set multicast "\r\n"MAC address %s\n", buf);\r\nresult = -EINVAL;\r\ngoto out;\r\n}\r\nresult = uwb_rc_mac_addr_set(rc, &addr);\r\nif (result == 0)\r\nrc->uwb_dev.mac_addr = addr;\r\nout:\r\nreturn result < 0 ? result : size;\r\n}\r\nsize_t __uwb_addr_print(char *buf, size_t buf_size, const unsigned char *addr,\r\nint type)\r\n{\r\nsize_t result;\r\nif (type)\r\nresult = scnprintf(buf, buf_size, "%pM", addr);\r\nelse\r\nresult = scnprintf(buf, buf_size, "%02x:%02x",\r\naddr[1], addr[0]);\r\nreturn result;\r\n}

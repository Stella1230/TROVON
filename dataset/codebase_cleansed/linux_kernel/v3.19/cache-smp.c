void smp_cache_interrupt(void)\r\n{\r\nunsigned long opr_mask = smp_cache_mask;\r\nswitch ((enum smp_dcache_ops)(opr_mask & SMP_DCACHE_OP_MASK)) {\r\ncase SMP_DCACHE_NOP:\r\nbreak;\r\ncase SMP_DCACHE_INV:\r\nmn10300_local_dcache_inv();\r\nbreak;\r\ncase SMP_DCACHE_INV_RANGE:\r\nmn10300_local_dcache_inv_range(smp_cache_start, smp_cache_end);\r\nbreak;\r\ncase SMP_DCACHE_FLUSH:\r\nmn10300_local_dcache_flush();\r\nbreak;\r\ncase SMP_DCACHE_FLUSH_RANGE:\r\nmn10300_local_dcache_flush_range(smp_cache_start,\r\nsmp_cache_end);\r\nbreak;\r\ncase SMP_DCACHE_FLUSH_INV:\r\nmn10300_local_dcache_flush_inv();\r\nbreak;\r\ncase SMP_DCACHE_FLUSH_INV_RANGE:\r\nmn10300_local_dcache_flush_inv_range(smp_cache_start,\r\nsmp_cache_end);\r\nbreak;\r\n}\r\nswitch ((enum smp_icache_ops)(opr_mask & SMP_ICACHE_OP_MASK)) {\r\ncase SMP_ICACHE_NOP:\r\nbreak;\r\ncase SMP_ICACHE_INV:\r\nmn10300_local_icache_inv();\r\nbreak;\r\ncase SMP_ICACHE_INV_RANGE:\r\nmn10300_local_icache_inv_range(smp_cache_start, smp_cache_end);\r\nbreak;\r\n}\r\ncpumask_clear_cpu(smp_processor_id(), &smp_cache_ipi_map);\r\n}\r\nvoid smp_cache_call(unsigned long opr_mask,\r\nunsigned long start, unsigned long end)\r\n{\r\nsmp_cache_mask = opr_mask;\r\nsmp_cache_start = start;\r\nsmp_cache_end = end;\r\ncpumask_copy(&smp_cache_ipi_map, cpu_online_mask);\r\ncpumask_clear_cpu(smp_processor_id(), &smp_cache_ipi_map);\r\nsend_IPI_allbutself(FLUSH_CACHE_IPI);\r\nwhile (!cpumask_empty(&smp_cache_ipi_map))\r\nmb();\r\n}

static int go7007_i2c_xfer(struct go7007 *go, u16 addr, int read,\r\nu16 command, int flags, u8 *data)\r\n{\r\nint i, ret = -EIO;\r\nu16 val;\r\nif (go->status == STATUS_SHUTDOWN)\r\nreturn -ENODEV;\r\n#ifdef GO7007_I2C_DEBUG\r\nif (read)\r\ndev_dbg(go->dev, "go7007-i2c: reading 0x%02x on 0x%02x\n",\r\ncommand, addr);\r\nelse\r\ndev_dbg(go->dev,\r\n"go7007-i2c: writing 0x%02x to 0x%02x on 0x%02x\n",\r\n*data, command, addr);\r\n#endif\r\nmutex_lock(&go->hw_lock);\r\nif (go->board_id == GO7007_BOARDID_ADLINK_MPG24) {\r\nmutex_lock(&adlink_mpg24_i2c_lock);\r\ngo7007_write_addr(go, 0x3c82, 0x0020);\r\n}\r\nfor (i = 0; i < 10; ++i) {\r\nif (go7007_read_addr(go, STATUS_REG_ADDR, &val) < 0)\r\ngoto i2c_done;\r\nif (!(val & I2C_STATE_MASK))\r\nbreak;\r\nmsleep(100);\r\n}\r\nif (i == 10) {\r\ndev_err(go->dev, "go7007-i2c: I2C adapter is hung\n");\r\ngoto i2c_done;\r\n}\r\ngo7007_write_addr(go, I2C_CTRL_REG_ADDR, flags);\r\ngo7007_write_addr(go, I2C_LO_ADDR_REG_ADDR, command);\r\nif (!read) {\r\ngo7007_write_addr(go, I2C_DATA_REG_ADDR, *data);\r\ngo7007_write_addr(go, I2C_DEV_UP_ADDR_REG_ADDR,\r\n(addr << 9) | (command >> 8));\r\nret = 0;\r\ngoto i2c_done;\r\n}\r\nif (go7007_read_addr(go, I2C_DATA_REG_ADDR, &val) < 0)\r\ngoto i2c_done;\r\ngo7007_write_addr(go, I2C_DEV_UP_ADDR_REG_ADDR,\r\n(addr << 9) | 0x0100 | (command >> 8));\r\nfor (i = 0; i < 10; ++i) {\r\nif (go7007_read_addr(go, STATUS_REG_ADDR, &val) < 0)\r\ngoto i2c_done;\r\nif (val & I2C_READ_READY_MASK)\r\nbreak;\r\nmsleep(100);\r\n}\r\nif (i == 10) {\r\ndev_err(go->dev, "go7007-i2c: I2C adapter is hung\n");\r\ngoto i2c_done;\r\n}\r\nif (go7007_read_addr(go, I2C_DATA_REG_ADDR, &val) < 0)\r\ngoto i2c_done;\r\n*data = val;\r\nret = 0;\r\ni2c_done:\r\nif (go->board_id == GO7007_BOARDID_ADLINK_MPG24) {\r\ngo7007_write_addr(go, 0x3c82, 0x0000);\r\nmutex_unlock(&adlink_mpg24_i2c_lock);\r\n}\r\nmutex_unlock(&go->hw_lock);\r\nreturn ret;\r\n}\r\nstatic int go7007_smbus_xfer(struct i2c_adapter *adapter, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size, union i2c_smbus_data *data)\r\n{\r\nstruct go7007 *go = i2c_get_adapdata(adapter);\r\nif (size != I2C_SMBUS_BYTE_DATA)\r\nreturn -EIO;\r\nreturn go7007_i2c_xfer(go, addr, read_write == I2C_SMBUS_READ, command,\r\nflags & I2C_CLIENT_SCCB ? 0x10 : 0x00, &data->byte);\r\n}\r\nstatic int go7007_i2c_master_xfer(struct i2c_adapter *adapter,\r\nstruct i2c_msg msgs[], int num)\r\n{\r\nstruct go7007 *go = i2c_get_adapdata(adapter);\r\nint i;\r\nfor (i = 0; i < num; ++i) {\r\nif (msgs[i].len == 2) {\r\nif (i + 1 == num || msgs[i].addr != msgs[i + 1].addr ||\r\n(msgs[i].flags & I2C_M_RD) ||\r\n!(msgs[i + 1].flags & I2C_M_RD) ||\r\nmsgs[i + 1].len != 1)\r\nreturn -EIO;\r\nif (go7007_i2c_xfer(go, msgs[i].addr, 1,\r\n(msgs[i].buf[0] << 8) | msgs[i].buf[1],\r\n0x01, &msgs[i + 1].buf[0]) < 0)\r\nreturn -EIO;\r\n++i;\r\n} else if (msgs[i].len == 3) {\r\nif (msgs[i].flags & I2C_M_RD)\r\nreturn -EIO;\r\nif (msgs[i].len != 3)\r\nreturn -EIO;\r\nif (go7007_i2c_xfer(go, msgs[i].addr, 0,\r\n(msgs[i].buf[0] << 8) | msgs[i].buf[1],\r\n0x01, &msgs[i].buf[2]) < 0)\r\nreturn -EIO;\r\n} else\r\nreturn -EIO;\r\n}\r\nreturn num;\r\n}\r\nstatic u32 go7007_functionality(struct i2c_adapter *adapter)\r\n{\r\nreturn I2C_FUNC_SMBUS_BYTE_DATA;\r\n}\r\nint go7007_i2c_init(struct go7007 *go)\r\n{\r\nmemcpy(&go->i2c_adapter, &go7007_adap_templ,\r\nsizeof(go7007_adap_templ));\r\ngo->i2c_adapter.dev.parent = go->dev;\r\ni2c_set_adapdata(&go->i2c_adapter, go);\r\nif (i2c_add_adapter(&go->i2c_adapter) < 0) {\r\ndev_err(go->dev,\r\n"go7007-i2c: error: i2c_add_adapter failed\n");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}

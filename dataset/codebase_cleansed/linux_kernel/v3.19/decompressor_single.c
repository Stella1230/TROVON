void *squashfs_decompressor_create(struct squashfs_sb_info *msblk,\r\nvoid *comp_opts)\r\n{\r\nstruct squashfs_stream *stream;\r\nint err = -ENOMEM;\r\nstream = kmalloc(sizeof(*stream), GFP_KERNEL);\r\nif (stream == NULL)\r\ngoto out;\r\nstream->stream = msblk->decompressor->init(msblk, comp_opts);\r\nif (IS_ERR(stream->stream)) {\r\nerr = PTR_ERR(stream->stream);\r\ngoto out;\r\n}\r\nkfree(comp_opts);\r\nmutex_init(&stream->mutex);\r\nreturn stream;\r\nout:\r\nkfree(stream);\r\nreturn ERR_PTR(err);\r\n}\r\nvoid squashfs_decompressor_destroy(struct squashfs_sb_info *msblk)\r\n{\r\nstruct squashfs_stream *stream = msblk->stream;\r\nif (stream) {\r\nmsblk->decompressor->free(stream->stream);\r\nkfree(stream);\r\n}\r\n}\r\nint squashfs_decompress(struct squashfs_sb_info *msblk, struct buffer_head **bh,\r\nint b, int offset, int length, struct squashfs_page_actor *output)\r\n{\r\nint res;\r\nstruct squashfs_stream *stream = msblk->stream;\r\nmutex_lock(&stream->mutex);\r\nres = msblk->decompressor->decompress(msblk, stream->stream, bh, b,\r\noffset, length, output);\r\nmutex_unlock(&stream->mutex);\r\nif (res < 0)\r\nERROR("%s decompression failed, data probably corrupt\n",\r\nmsblk->decompressor->name);\r\nreturn res;\r\n}\r\nint squashfs_max_decompressors(void)\r\n{\r\nreturn 1;\r\n}

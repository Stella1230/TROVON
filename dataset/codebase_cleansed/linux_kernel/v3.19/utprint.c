static acpi_size\r\nacpi_ut_bound_string_length(const char *string, acpi_size count)\r\n{\r\nu32 length = 0;\r\nwhile (*string && count) {\r\nlength++;\r\nstring++;\r\ncount--;\r\n}\r\nreturn (length);\r\n}\r\nstatic char *acpi_ut_bound_string_output(char *string, const char *end, char c)\r\n{\r\nif (string < end) {\r\n*string = c;\r\n}\r\n++string;\r\nreturn (string);\r\n}\r\nstatic char *acpi_ut_put_number(char *string, u64 number, u8 base, u8 upper)\r\n{\r\nconst char *digits;\r\nu64 digit_index;\r\nchar *pos;\r\npos = string;\r\ndigits = upper ? acpi_gbl_upper_hex_digits : acpi_gbl_lower_hex_digits;\r\nif (number == 0) {\r\n*(pos++) = '0';\r\n} else {\r\nwhile (number) {\r\n(void)acpi_ut_divide(number, base, &number,\r\n&digit_index);\r\n*(pos++) = digits[digit_index];\r\n}\r\n}\r\nreturn (pos);\r\n}\r\nconst char *acpi_ut_scan_number(const char *string, u64 *number_ptr)\r\n{\r\nu64 number = 0;\r\nwhile (ACPI_IS_DIGIT(*string)) {\r\nnumber *= 10;\r\nnumber += *(string++) - '0';\r\n}\r\n*number_ptr = number;\r\nreturn (string);\r\n}\r\nconst char *acpi_ut_print_number(char *string, u64 number)\r\n{\r\nchar ascii_string[20];\r\nconst char *pos1;\r\nchar *pos2;\r\npos1 = acpi_ut_put_number(ascii_string, number, 10, FALSE);\r\npos2 = string;\r\nwhile (pos1 != ascii_string) {\r\n*(pos2++) = *(--pos1);\r\n}\r\n*pos2 = 0;\r\nreturn (string);\r\n}\r\nstatic char *acpi_ut_format_number(char *string,\r\nchar *end,\r\nu64 number,\r\nu8 base, s32 width, s32 precision, u8 type)\r\n{\r\nchar *pos;\r\nchar sign;\r\nchar zero;\r\nu8 need_prefix;\r\nu8 upper;\r\ns32 i;\r\nchar reversed_string[66];\r\nif (base < 2 || base > 16) {\r\nreturn (NULL);\r\n}\r\nif (type & ACPI_FORMAT_LEFT) {\r\ntype &= ~ACPI_FORMAT_ZERO;\r\n}\r\nneed_prefix = ((type & ACPI_FORMAT_PREFIX)\r\n&& base != 10) ? TRUE : FALSE;\r\nupper = (type & ACPI_FORMAT_UPPER) ? TRUE : FALSE;\r\nzero = (type & ACPI_FORMAT_ZERO) ? '0' : ' ';\r\nsign = '\0';\r\nif (type & ACPI_FORMAT_SIGN) {\r\nif ((s64) number < 0) {\r\nsign = '-';\r\nnumber = -(s64) number;\r\nwidth--;\r\n} else if (type & ACPI_FORMAT_SIGN_PLUS) {\r\nsign = '+';\r\nwidth--;\r\n} else if (type & ACPI_FORMAT_SIGN_PLUS_SPACE) {\r\nsign = ' ';\r\nwidth--;\r\n}\r\n}\r\nif (need_prefix) {\r\nwidth--;\r\nif (base == 16) {\r\nwidth--;\r\n}\r\n}\r\npos = acpi_ut_put_number(reversed_string, number, base, upper);\r\ni = ACPI_PTR_DIFF(pos, reversed_string);\r\nif (i > precision) {\r\nprecision = i;\r\n}\r\nwidth -= precision;\r\nif (!(type & (ACPI_FORMAT_ZERO | ACPI_FORMAT_LEFT))) {\r\nwhile (--width >= 0) {\r\nstring = acpi_ut_bound_string_output(string, end, ' ');\r\n}\r\n}\r\nif (sign) {\r\nstring = acpi_ut_bound_string_output(string, end, sign);\r\n}\r\nif (need_prefix) {\r\nstring = acpi_ut_bound_string_output(string, end, '0');\r\nif (base == 16) {\r\nstring = acpi_ut_bound_string_output(string, end,\r\nupper ? 'X' : 'x');\r\n}\r\n}\r\nif (!(type & ACPI_FORMAT_LEFT)) {\r\nwhile (--width >= 0) {\r\nstring = acpi_ut_bound_string_output(string, end, zero);\r\n}\r\n}\r\nwhile (i <= --precision) {\r\nstring = acpi_ut_bound_string_output(string, end, '0');\r\n}\r\nwhile (--i >= 0) {\r\nstring = acpi_ut_bound_string_output(string, end,\r\nreversed_string[i]);\r\n}\r\nwhile (--width >= 0) {\r\nstring = acpi_ut_bound_string_output(string, end, ' ');\r\n}\r\nreturn (string);\r\n}\r\nint\r\nacpi_ut_vsnprintf(char *string,\r\nacpi_size size, const char *format, va_list args)\r\n{\r\nu8 base = 10;\r\nu8 type = 0;\r\ns32 width = -1;\r\ns32 precision = -1;\r\nchar qualifier = 0;\r\nu64 number;\r\nchar *pos;\r\nchar *end;\r\nchar c;\r\nconst char *s;\r\nconst void *p;\r\ns32 length;\r\nint i;\r\npos = string;\r\nend = string + size;\r\nfor (; *format; ++format) {\r\nif (*format != '%') {\r\npos = acpi_ut_bound_string_output(pos, end, *format);\r\ncontinue;\r\n}\r\ndo {\r\n++format;\r\nif (*format == '#') {\r\ntype |= ACPI_FORMAT_PREFIX;\r\n} else if (*format == '0') {\r\ntype |= ACPI_FORMAT_ZERO;\r\n} else if (*format == '+') {\r\ntype |= ACPI_FORMAT_SIGN_PLUS;\r\n} else if (*format == ' ') {\r\ntype |= ACPI_FORMAT_SIGN_PLUS_SPACE;\r\n} else if (*format == '-') {\r\ntype |= ACPI_FORMAT_LEFT;\r\n} else {\r\nbreak;\r\n}\r\n} while (1);\r\nwidth = -1;\r\nif (ACPI_IS_DIGIT(*format)) {\r\nformat = acpi_ut_scan_number(format, &number);\r\nwidth = (s32) number;\r\n} else if (*format == '*') {\r\n++format;\r\nwidth = va_arg(args, int);\r\nif (width < 0) {\r\nwidth = -width;\r\ntype |= ACPI_FORMAT_LEFT;\r\n}\r\n}\r\nprecision = -1;\r\nif (*format == '.') {\r\n++format;\r\nif (ACPI_IS_DIGIT(*format)) {\r\nformat = acpi_ut_scan_number(format, &number);\r\nprecision = (s32) number;\r\n} else if (*format == '*') {\r\n++format;\r\nprecision = va_arg(args, int);\r\n}\r\nif (precision < 0) {\r\nprecision = 0;\r\n}\r\n}\r\nqualifier = -1;\r\nif (*format == 'h' || *format == 'l' || *format == 'L') {\r\nqualifier = *format;\r\n++format;\r\nif (qualifier == 'l' && *format == 'l') {\r\nqualifier = 'L';\r\n++format;\r\n}\r\n}\r\nswitch (*format) {\r\ncase '%':\r\npos = acpi_ut_bound_string_output(pos, end, '%');\r\ncontinue;\r\ncase 'c':\r\nif (!(type & ACPI_FORMAT_LEFT)) {\r\nwhile (--width > 0) {\r\npos =\r\nacpi_ut_bound_string_output(pos,\r\nend,\r\n' ');\r\n}\r\n}\r\nc = (char)va_arg(args, int);\r\npos = acpi_ut_bound_string_output(pos, end, c);\r\nwhile (--width > 0) {\r\npos =\r\nacpi_ut_bound_string_output(pos, end, ' ');\r\n}\r\ncontinue;\r\ncase 's':\r\ns = va_arg(args, char *);\r\nif (!s) {\r\ns = "<NULL>";\r\n}\r\nlength = acpi_ut_bound_string_length(s, precision);\r\nif (!(type & ACPI_FORMAT_LEFT)) {\r\nwhile (length < width--) {\r\npos =\r\nacpi_ut_bound_string_output(pos,\r\nend,\r\n' ');\r\n}\r\n}\r\nfor (i = 0; i < length; ++i) {\r\npos = acpi_ut_bound_string_output(pos, end, *s);\r\n++s;\r\n}\r\nwhile (length < width--) {\r\npos =\r\nacpi_ut_bound_string_output(pos, end, ' ');\r\n}\r\ncontinue;\r\ncase 'o':\r\nbase = 8;\r\nbreak;\r\ncase 'X':\r\ntype |= ACPI_FORMAT_UPPER;\r\ncase 'x':\r\nbase = 16;\r\nbreak;\r\ncase 'd':\r\ncase 'i':\r\ntype |= ACPI_FORMAT_SIGN;\r\ncase 'u':\r\nbreak;\r\ncase 'p':\r\nif (width == -1) {\r\nwidth = 2 * sizeof(void *);\r\ntype |= ACPI_FORMAT_ZERO;\r\n}\r\np = va_arg(args, void *);\r\npos = acpi_ut_format_number(pos, end,\r\nACPI_TO_INTEGER(p), 16,\r\nwidth, precision, type);\r\ncontinue;\r\ndefault:\r\npos = acpi_ut_bound_string_output(pos, end, '%');\r\nif (*format) {\r\npos =\r\nacpi_ut_bound_string_output(pos, end,\r\n*format);\r\n} else {\r\n--format;\r\n}\r\ncontinue;\r\n}\r\nif (qualifier == 'L') {\r\nnumber = va_arg(args, u64);\r\nif (type & ACPI_FORMAT_SIGN) {\r\nnumber = (s64) number;\r\n}\r\n} else if (qualifier == 'l') {\r\nnumber = va_arg(args, unsigned long);\r\nif (type & ACPI_FORMAT_SIGN) {\r\nnumber = (s32) number;\r\n}\r\n} else if (qualifier == 'h') {\r\nnumber = (u16)va_arg(args, int);\r\nif (type & ACPI_FORMAT_SIGN) {\r\nnumber = (s16) number;\r\n}\r\n} else {\r\nnumber = va_arg(args, unsigned int);\r\nif (type & ACPI_FORMAT_SIGN) {\r\nnumber = (signed int)number;\r\n}\r\n}\r\npos = acpi_ut_format_number(pos, end, number, base,\r\nwidth, precision, type);\r\n}\r\nif (size > 0) {\r\nif (pos < end) {\r\n*pos = '\0';\r\n} else {\r\nend[-1] = '\0';\r\n}\r\n}\r\nreturn (ACPI_PTR_DIFF(pos, string));\r\n}\r\nint acpi_ut_snprintf(char *string, acpi_size size, const char *format, ...)\r\n{\r\nva_list args;\r\nint length;\r\nva_start(args, format);\r\nlength = acpi_ut_vsnprintf(string, size, format, args);\r\nva_end(args);\r\nreturn (length);\r\n}\r\nint acpi_ut_file_vprintf(ACPI_FILE file, const char *format, va_list args)\r\n{\r\nacpi_cpu_flags flags;\r\nint length;\r\nflags = acpi_os_acquire_lock(acpi_gbl_print_lock);\r\nlength = acpi_ut_vsnprintf(acpi_gbl_print_buffer,\r\nsizeof(acpi_gbl_print_buffer), format, args);\r\n(void)acpi_os_write_file(file, acpi_gbl_print_buffer, length, 1);\r\nacpi_os_release_lock(acpi_gbl_print_lock, flags);\r\nreturn (length);\r\n}\r\nint acpi_ut_file_printf(ACPI_FILE file, const char *format, ...)\r\n{\r\nva_list args;\r\nint length;\r\nva_start(args, format);\r\nlength = acpi_ut_file_vprintf(file, format, args);\r\nva_end(args);\r\nreturn (length);\r\n}

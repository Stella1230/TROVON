static void pvc_reg_write(u32 val)\r\n{\r\n*picvue->reg = val;\r\n}\r\nstatic u32 pvc_reg_read(void)\r\n{\r\nu32 tmp = *picvue->reg;\r\nreturn tmp;\r\n}\r\nstatic void pvc_write_byte(u32 data, u8 byte)\r\n{\r\ndata |= picvue->e;\r\npvc_reg_write(data);\r\ndata &= ~picvue->data_mask;\r\ndata |= byte << picvue->data_shift;\r\npvc_reg_write(data);\r\nndelay(220);\r\npvc_reg_write(data & ~picvue->e);\r\nndelay(220);\r\n}\r\nstatic u8 pvc_read_byte(u32 data)\r\n{\r\nu8 byte;\r\ndata |= picvue->e;\r\npvc_reg_write(data);\r\nndelay(220);\r\nbyte = (pvc_reg_read() & picvue->data_mask) >> picvue->data_shift;\r\ndata &= ~picvue->e;\r\npvc_reg_write(data);\r\nndelay(220);\r\nreturn byte;\r\n}\r\nstatic u8 pvc_read_data(void)\r\n{\r\nu32 data = pvc_reg_read();\r\nu8 byte;\r\ndata |= picvue->rw;\r\ndata &= ~picvue->rs;\r\npvc_reg_write(data);\r\nndelay(40);\r\nbyte = pvc_read_byte(data);\r\ndata |= picvue->rs;\r\npvc_reg_write(data);\r\nreturn byte;\r\n}\r\nstatic int pvc_wait(void)\r\n{\r\nint i = TIMEOUT;\r\nint err = 0;\r\nwhile ((pvc_read_data() & PVC_BUSY) && i)\r\ni--;\r\nif (i == 0)\r\nerr = -ETIME;\r\nreturn err;\r\n}\r\nstatic void pvc_write(u8 byte, int mode)\r\n{\r\nu32 data = pvc_reg_read();\r\ndata &= ~picvue->rw;\r\nif (mode == MODE_DATA)\r\ndata |= picvue->rs;\r\nelse\r\ndata &= ~picvue->rs;\r\npvc_reg_write(data);\r\nndelay(40);\r\npvc_write_byte(data, byte);\r\nif (mode == MODE_DATA)\r\ndata &= ~picvue->rs;\r\nelse\r\ndata |= picvue->rs;\r\npvc_reg_write(data);\r\npvc_wait();\r\n}\r\nvoid pvc_write_string(const unsigned char *str, u8 addr, int line)\r\n{\r\nint i = 0;\r\nif (line > 0 && (PVC_NLINES > 1))\r\naddr += 0x40 * line;\r\npvc_write(0x80 | addr, MODE_INST);\r\nwhile (*str != 0 && i < PVC_LINELEN) {\r\npvc_write(*str++, MODE_DATA);\r\ni++;\r\n}\r\n}\r\nvoid pvc_write_string_centered(const unsigned char *str, int line)\r\n{\r\nint len = strlen(str);\r\nu8 addr;\r\nif (len > PVC_VISIBLE_CHARS)\r\naddr = 0;\r\nelse\r\naddr = (PVC_VISIBLE_CHARS - strlen(str))/2;\r\npvc_write_string(str, addr, line);\r\n}\r\nvoid pvc_dump_string(const unsigned char *str)\r\n{\r\nint len = strlen(str);\r\npvc_write_string(str, 0, 0);\r\nif (len > PVC_VISIBLE_CHARS)\r\npvc_write_string(&str[PVC_VISIBLE_CHARS], 0, 1);\r\n}\r\nint pvc_program_cg(int charnum, u8 bitmap[BM_SIZE])\r\n{\r\nint i;\r\nint addr;\r\nif (charnum > MAX_PROGRAMMABLE_CHARS)\r\nreturn -ENOENT;\r\naddr = charnum * 8;\r\npvc_write(0x40 | addr, MODE_INST);\r\nfor (i = 0; i < BM_SIZE; i++)\r\npvc_write(bitmap[i], MODE_DATA);\r\nreturn 0;\r\n}\r\nstatic void pvc_funcset(u8 cmd)\r\n{\r\npvc_write(FUNC_SET_CMD | (cmd & (EIGHT_BYTE|TWO_LINES|LARGE_FONT)),\r\nMODE_INST);\r\n}\r\nstatic void pvc_entrymode(u8 cmd)\r\n{\r\npvc_write(ENTRYMODE_CMD | (cmd & (AUTO_INC|CURSOR_FOLLOWS_DISP)),\r\nMODE_INST);\r\n}\r\nvoid pvc_dispcnt(u8 cmd)\r\n{\r\npvc_write(DISP_CNT_CMD | (cmd & (DISP_ON|CUR_ON|CUR_BLINK)), MODE_INST);\r\n}\r\nvoid pvc_move(u8 cmd)\r\n{\r\npvc_write(MOVE_CMD | (cmd & (DISPLAY|RIGHT)), MODE_INST);\r\n}\r\nvoid pvc_clear(void)\r\n{\r\npvc_write(CLEAR_CMD, MODE_INST);\r\n}\r\nvoid pvc_home(void)\r\n{\r\npvc_write(HOME_CMD, MODE_INST);\r\n}\r\nint pvc_init(void)\r\n{\r\nu8 cmd = EIGHT_BYTE;\r\nif (PVC_NLINES == 2)\r\ncmd |= (SMALL_FONT|TWO_LINES);\r\nelse\r\ncmd |= (LARGE_FONT|ONE_LINE);\r\npvc_funcset(cmd);\r\npvc_dispcnt(DISP_ON);\r\npvc_entrymode(AUTO_INC);\r\npvc_clear();\r\npvc_write_string_centered("Display", 0);\r\npvc_write_string_centered("Initialized", 1);\r\nreturn 0;\r\n}

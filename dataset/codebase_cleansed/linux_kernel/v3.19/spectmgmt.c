int ieee80211_parse_ch_switch_ie(struct ieee80211_sub_if_data *sdata,\r\nstruct ieee802_11_elems *elems,\r\nenum ieee80211_band current_band,\r\nu32 sta_flags, u8 *bssid,\r\nstruct ieee80211_csa_ie *csa_ie)\r\n{\r\nenum ieee80211_band new_band;\r\nint new_freq;\r\nu8 new_chan_no;\r\nstruct ieee80211_channel *new_chan;\r\nstruct cfg80211_chan_def new_vht_chandef = {};\r\nconst struct ieee80211_sec_chan_offs_ie *sec_chan_offs;\r\nconst struct ieee80211_wide_bw_chansw_ie *wide_bw_chansw_ie;\r\nconst struct ieee80211_ht_operation *ht_oper;\r\nint secondary_channel_offset = -1;\r\nsec_chan_offs = elems->sec_chan_offs;\r\nwide_bw_chansw_ie = elems->wide_bw_chansw_ie;\r\nht_oper = elems->ht_operation;\r\nif (sta_flags & (IEEE80211_STA_DISABLE_HT |\r\nIEEE80211_STA_DISABLE_40MHZ)) {\r\nsec_chan_offs = NULL;\r\nwide_bw_chansw_ie = NULL;\r\nht_oper = NULL;\r\n}\r\nif (sta_flags & IEEE80211_STA_DISABLE_VHT)\r\nwide_bw_chansw_ie = NULL;\r\nif (elems->ext_chansw_ie) {\r\nif (!ieee80211_operating_class_to_band(\r\nelems->ext_chansw_ie->new_operating_class,\r\n&new_band)) {\r\nsdata_info(sdata,\r\n"cannot understand ECSA IE operating class %d, disconnecting\n",\r\nelems->ext_chansw_ie->new_operating_class);\r\nreturn -EINVAL;\r\n}\r\nnew_chan_no = elems->ext_chansw_ie->new_ch_num;\r\ncsa_ie->count = elems->ext_chansw_ie->count;\r\ncsa_ie->mode = elems->ext_chansw_ie->mode;\r\n} else if (elems->ch_switch_ie) {\r\nnew_band = current_band;\r\nnew_chan_no = elems->ch_switch_ie->new_ch_num;\r\ncsa_ie->count = elems->ch_switch_ie->count;\r\ncsa_ie->mode = elems->ch_switch_ie->mode;\r\n} else {\r\nreturn 1;\r\n}\r\nif (elems->mesh_chansw_params_ie) {\r\ncsa_ie->ttl = elems->mesh_chansw_params_ie->mesh_ttl;\r\ncsa_ie->mode = elems->mesh_chansw_params_ie->mesh_flags;\r\ncsa_ie->pre_value = le16_to_cpu(\r\nelems->mesh_chansw_params_ie->mesh_pre_value);\r\n}\r\nnew_freq = ieee80211_channel_to_frequency(new_chan_no, new_band);\r\nnew_chan = ieee80211_get_channel(sdata->local->hw.wiphy, new_freq);\r\nif (!new_chan || new_chan->flags & IEEE80211_CHAN_DISABLED) {\r\nsdata_info(sdata,\r\n"BSS %pM switches to unsupported channel (%d MHz), disconnecting\n",\r\nbssid, new_freq);\r\nreturn -EINVAL;\r\n}\r\nif (sec_chan_offs) {\r\nsecondary_channel_offset = sec_chan_offs->sec_chan_offs;\r\n} else if (!(sta_flags & IEEE80211_STA_DISABLE_HT)) {\r\nsecondary_channel_offset = IEEE80211_HT_PARAM_CHA_SEC_NONE;\r\n}\r\nswitch (secondary_channel_offset) {\r\ndefault:\r\ncase IEEE80211_HT_PARAM_CHA_SEC_NONE:\r\ncfg80211_chandef_create(&csa_ie->chandef, new_chan,\r\nNL80211_CHAN_HT20);\r\nbreak;\r\ncase IEEE80211_HT_PARAM_CHA_SEC_ABOVE:\r\ncfg80211_chandef_create(&csa_ie->chandef, new_chan,\r\nNL80211_CHAN_HT40PLUS);\r\nbreak;\r\ncase IEEE80211_HT_PARAM_CHA_SEC_BELOW:\r\ncfg80211_chandef_create(&csa_ie->chandef, new_chan,\r\nNL80211_CHAN_HT40MINUS);\r\nbreak;\r\ncase -1:\r\ncfg80211_chandef_create(&csa_ie->chandef, new_chan,\r\nNL80211_CHAN_NO_HT);\r\nswitch (sdata->vif.bss_conf.chandef.width) {\r\ncase NL80211_CHAN_WIDTH_5:\r\ncase NL80211_CHAN_WIDTH_10:\r\ncsa_ie->chandef.width =\r\nsdata->vif.bss_conf.chandef.width;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nif (wide_bw_chansw_ie) {\r\nnew_vht_chandef.chan = new_chan;\r\nnew_vht_chandef.center_freq1 =\r\nieee80211_channel_to_frequency(\r\nwide_bw_chansw_ie->new_center_freq_seg0,\r\nnew_band);\r\nswitch (wide_bw_chansw_ie->new_channel_width) {\r\ndefault:\r\ncase IEEE80211_VHT_CHANWIDTH_USE_HT:\r\nnew_vht_chandef.chan = NULL;\r\nbreak;\r\ncase IEEE80211_VHT_CHANWIDTH_80MHZ:\r\nnew_vht_chandef.width = NL80211_CHAN_WIDTH_80;\r\nbreak;\r\ncase IEEE80211_VHT_CHANWIDTH_160MHZ:\r\nnew_vht_chandef.width = NL80211_CHAN_WIDTH_160;\r\nbreak;\r\ncase IEEE80211_VHT_CHANWIDTH_80P80MHZ:\r\nnew_vht_chandef.center_freq2 =\r\nieee80211_channel_to_frequency(\r\nwide_bw_chansw_ie->new_center_freq_seg1,\r\nnew_band);\r\nnew_vht_chandef.width = NL80211_CHAN_WIDTH_80P80;\r\nbreak;\r\n}\r\nif (sta_flags & IEEE80211_STA_DISABLE_80P80MHZ &&\r\nnew_vht_chandef.width == NL80211_CHAN_WIDTH_80P80)\r\nieee80211_chandef_downgrade(&new_vht_chandef);\r\nif (sta_flags & IEEE80211_STA_DISABLE_160MHZ &&\r\nnew_vht_chandef.width == NL80211_CHAN_WIDTH_160)\r\nieee80211_chandef_downgrade(&new_vht_chandef);\r\nif (sta_flags & IEEE80211_STA_DISABLE_40MHZ &&\r\nnew_vht_chandef.width > NL80211_CHAN_WIDTH_20)\r\nieee80211_chandef_downgrade(&new_vht_chandef);\r\n}\r\nif (new_vht_chandef.chan) {\r\nif (!cfg80211_chandef_compatible(&new_vht_chandef,\r\n&csa_ie->chandef)) {\r\nsdata_info(sdata,\r\n"BSS %pM: CSA has inconsistent channel data, disconnecting\n",\r\nbssid);\r\nreturn -EINVAL;\r\n}\r\ncsa_ie->chandef = new_vht_chandef;\r\n}\r\nreturn 0;\r\n}\r\nstatic void ieee80211_send_refuse_measurement_request(struct ieee80211_sub_if_data *sdata,\r\nstruct ieee80211_msrment_ie *request_ie,\r\nconst u8 *da, const u8 *bssid,\r\nu8 dialog_token)\r\n{\r\nstruct ieee80211_local *local = sdata->local;\r\nstruct sk_buff *skb;\r\nstruct ieee80211_mgmt *msr_report;\r\nskb = dev_alloc_skb(sizeof(*msr_report) + local->hw.extra_tx_headroom +\r\nsizeof(struct ieee80211_msrment_ie));\r\nif (!skb)\r\nreturn;\r\nskb_reserve(skb, local->hw.extra_tx_headroom);\r\nmsr_report = (struct ieee80211_mgmt *)skb_put(skb, 24);\r\nmemset(msr_report, 0, 24);\r\nmemcpy(msr_report->da, da, ETH_ALEN);\r\nmemcpy(msr_report->sa, sdata->vif.addr, ETH_ALEN);\r\nmemcpy(msr_report->bssid, bssid, ETH_ALEN);\r\nmsr_report->frame_control = cpu_to_le16(IEEE80211_FTYPE_MGMT |\r\nIEEE80211_STYPE_ACTION);\r\nskb_put(skb, 1 + sizeof(msr_report->u.action.u.measurement));\r\nmsr_report->u.action.category = WLAN_CATEGORY_SPECTRUM_MGMT;\r\nmsr_report->u.action.u.measurement.action_code =\r\nWLAN_ACTION_SPCT_MSR_RPRT;\r\nmsr_report->u.action.u.measurement.dialog_token = dialog_token;\r\nmsr_report->u.action.u.measurement.element_id = WLAN_EID_MEASURE_REPORT;\r\nmsr_report->u.action.u.measurement.length =\r\nsizeof(struct ieee80211_msrment_ie);\r\nmemset(&msr_report->u.action.u.measurement.msr_elem, 0,\r\nsizeof(struct ieee80211_msrment_ie));\r\nmsr_report->u.action.u.measurement.msr_elem.token = request_ie->token;\r\nmsr_report->u.action.u.measurement.msr_elem.mode |=\r\nIEEE80211_SPCT_MSR_RPRT_MODE_REFUSED;\r\nmsr_report->u.action.u.measurement.msr_elem.type = request_ie->type;\r\nieee80211_tx_skb(sdata, skb);\r\n}\r\nvoid ieee80211_process_measurement_req(struct ieee80211_sub_if_data *sdata,\r\nstruct ieee80211_mgmt *mgmt,\r\nsize_t len)\r\n{\r\nieee80211_send_refuse_measurement_request(sdata,\r\n&mgmt->u.action.u.measurement.msr_elem,\r\nmgmt->sa, mgmt->bssid,\r\nmgmt->u.action.u.measurement.dialog_token);\r\n}

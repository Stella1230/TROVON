static void pin_free_rcu(struct rcu_head *head)\r\n{\r\nkfree(container_of(head, struct fs_pin, rcu));\r\n}\r\nvoid pin_put(struct fs_pin *p)\r\n{\r\nif (atomic_long_dec_and_test(&p->count))\r\ncall_rcu(&p->rcu, pin_free_rcu);\r\n}\r\nvoid pin_remove(struct fs_pin *pin)\r\n{\r\nspin_lock(&pin_lock);\r\nhlist_del(&pin->m_list);\r\nhlist_del(&pin->s_list);\r\nspin_unlock(&pin_lock);\r\n}\r\nvoid pin_insert(struct fs_pin *pin, struct vfsmount *m)\r\n{\r\nspin_lock(&pin_lock);\r\nhlist_add_head(&pin->s_list, &m->mnt_sb->s_pins);\r\nhlist_add_head(&pin->m_list, &real_mount(m)->mnt_pins);\r\nspin_unlock(&pin_lock);\r\n}\r\nvoid mnt_pin_kill(struct mount *m)\r\n{\r\nwhile (1) {\r\nstruct hlist_node *p;\r\nstruct fs_pin *pin;\r\nrcu_read_lock();\r\np = ACCESS_ONCE(m->mnt_pins.first);\r\nif (!p) {\r\nrcu_read_unlock();\r\nbreak;\r\n}\r\npin = hlist_entry(p, struct fs_pin, m_list);\r\nif (!atomic_long_inc_not_zero(&pin->count)) {\r\nrcu_read_unlock();\r\ncpu_relax();\r\ncontinue;\r\n}\r\nrcu_read_unlock();\r\npin->kill(pin);\r\n}\r\n}\r\nvoid sb_pin_kill(struct super_block *sb)\r\n{\r\nwhile (1) {\r\nstruct hlist_node *p;\r\nstruct fs_pin *pin;\r\nrcu_read_lock();\r\np = ACCESS_ONCE(sb->s_pins.first);\r\nif (!p) {\r\nrcu_read_unlock();\r\nbreak;\r\n}\r\npin = hlist_entry(p, struct fs_pin, s_list);\r\nif (!atomic_long_inc_not_zero(&pin->count)) {\r\nrcu_read_unlock();\r\ncpu_relax();\r\ncontinue;\r\n}\r\nrcu_read_unlock();\r\npin->kill(pin);\r\n}\r\n}

static inline u32 htcp_cong_time(const struct htcp *ca)\r\n{\r\nreturn jiffies - ca->last_cong;\r\n}\r\nstatic inline u32 htcp_ccount(const struct htcp *ca)\r\n{\r\nreturn htcp_cong_time(ca) / ca->minRTT;\r\n}\r\nstatic inline void htcp_reset(struct htcp *ca)\r\n{\r\nca->undo_last_cong = ca->last_cong;\r\nca->undo_maxRTT = ca->maxRTT;\r\nca->undo_old_maxB = ca->old_maxB;\r\nca->last_cong = jiffies;\r\n}\r\nstatic u32 htcp_cwnd_undo(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nif (ca->undo_last_cong) {\r\nca->last_cong = ca->undo_last_cong;\r\nca->maxRTT = ca->undo_maxRTT;\r\nca->old_maxB = ca->undo_old_maxB;\r\nca->undo_last_cong = 0;\r\n}\r\nreturn max(tp->snd_cwnd, (tp->snd_ssthresh << 7) / ca->beta);\r\n}\r\nstatic inline void measure_rtt(struct sock *sk, u32 srtt)\r\n{\r\nconst struct inet_connection_sock *icsk = inet_csk(sk);\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nif (ca->minRTT > srtt || !ca->minRTT)\r\nca->minRTT = srtt;\r\nif (icsk->icsk_ca_state == TCP_CA_Open) {\r\nif (ca->maxRTT < ca->minRTT)\r\nca->maxRTT = ca->minRTT;\r\nif (ca->maxRTT < srtt &&\r\nsrtt <= ca->maxRTT + msecs_to_jiffies(20))\r\nca->maxRTT = srtt;\r\n}\r\n}\r\nstatic void measure_achieved_throughput(struct sock *sk,\r\nu32 pkts_acked, s32 rtt)\r\n{\r\nconst struct inet_connection_sock *icsk = inet_csk(sk);\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nu32 now = tcp_time_stamp;\r\nif (icsk->icsk_ca_state == TCP_CA_Open)\r\nca->pkts_acked = pkts_acked;\r\nif (rtt > 0)\r\nmeasure_rtt(sk, usecs_to_jiffies(rtt));\r\nif (!use_bandwidth_switch)\r\nreturn;\r\nif (!((1 << icsk->icsk_ca_state) & (TCPF_CA_Open | TCPF_CA_Disorder))) {\r\nca->packetcount = 0;\r\nca->lasttime = now;\r\nreturn;\r\n}\r\nca->packetcount += pkts_acked;\r\nif (ca->packetcount >= tp->snd_cwnd - (ca->alpha >> 7 ? : 1) &&\r\nnow - ca->lasttime >= ca->minRTT &&\r\nca->minRTT > 0) {\r\n__u32 cur_Bi = ca->packetcount * HZ / (now - ca->lasttime);\r\nif (htcp_ccount(ca) <= 3) {\r\nca->minB = ca->maxB = ca->Bi = cur_Bi;\r\n} else {\r\nca->Bi = (3 * ca->Bi + cur_Bi) / 4;\r\nif (ca->Bi > ca->maxB)\r\nca->maxB = ca->Bi;\r\nif (ca->minB > ca->maxB)\r\nca->minB = ca->maxB;\r\n}\r\nca->packetcount = 0;\r\nca->lasttime = now;\r\n}\r\n}\r\nstatic inline void htcp_beta_update(struct htcp *ca, u32 minRTT, u32 maxRTT)\r\n{\r\nif (use_bandwidth_switch) {\r\nu32 maxB = ca->maxB;\r\nu32 old_maxB = ca->old_maxB;\r\nca->old_maxB = ca->maxB;\r\nif (!between(5 * maxB, 4 * old_maxB, 6 * old_maxB)) {\r\nca->beta = BETA_MIN;\r\nca->modeswitch = 0;\r\nreturn;\r\n}\r\n}\r\nif (ca->modeswitch && minRTT > msecs_to_jiffies(10) && maxRTT) {\r\nca->beta = (minRTT << 7) / maxRTT;\r\nif (ca->beta < BETA_MIN)\r\nca->beta = BETA_MIN;\r\nelse if (ca->beta > BETA_MAX)\r\nca->beta = BETA_MAX;\r\n} else {\r\nca->beta = BETA_MIN;\r\nca->modeswitch = 1;\r\n}\r\n}\r\nstatic inline void htcp_alpha_update(struct htcp *ca)\r\n{\r\nu32 minRTT = ca->minRTT;\r\nu32 factor = 1;\r\nu32 diff = htcp_cong_time(ca);\r\nif (diff > HZ) {\r\ndiff -= HZ;\r\nfactor = 1 + (10 * diff + ((diff / 2) * (diff / 2) / HZ)) / HZ;\r\n}\r\nif (use_rtt_scaling && minRTT) {\r\nu32 scale = (HZ << 3) / (10 * minRTT);\r\nscale = min(max(scale, 1U << 2), 10U << 3);\r\nfactor = (factor << 3) / scale;\r\nif (!factor)\r\nfactor = 1;\r\n}\r\nca->alpha = 2 * factor * ((1 << 7) - ca->beta);\r\nif (!ca->alpha)\r\nca->alpha = ALPHA_BASE;\r\n}\r\nstatic void htcp_param_update(struct sock *sk)\r\n{\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nu32 minRTT = ca->minRTT;\r\nu32 maxRTT = ca->maxRTT;\r\nhtcp_beta_update(ca, minRTT, maxRTT);\r\nhtcp_alpha_update(ca);\r\nif (minRTT > 0 && maxRTT > minRTT)\r\nca->maxRTT = minRTT + ((maxRTT - minRTT) * 95) / 100;\r\n}\r\nstatic u32 htcp_recalc_ssthresh(struct sock *sk)\r\n{\r\nconst struct tcp_sock *tp = tcp_sk(sk);\r\nconst struct htcp *ca = inet_csk_ca(sk);\r\nhtcp_param_update(sk);\r\nreturn max((tp->snd_cwnd * ca->beta) >> 7, 2U);\r\n}\r\nstatic void htcp_cong_avoid(struct sock *sk, u32 ack, u32 acked)\r\n{\r\nstruct tcp_sock *tp = tcp_sk(sk);\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nif (!tcp_is_cwnd_limited(sk))\r\nreturn;\r\nif (tp->snd_cwnd <= tp->snd_ssthresh)\r\ntcp_slow_start(tp, acked);\r\nelse {\r\nif ((tp->snd_cwnd_cnt * ca->alpha)>>7 >= tp->snd_cwnd) {\r\nif (tp->snd_cwnd < tp->snd_cwnd_clamp)\r\ntp->snd_cwnd++;\r\ntp->snd_cwnd_cnt = 0;\r\nhtcp_alpha_update(ca);\r\n} else\r\ntp->snd_cwnd_cnt += ca->pkts_acked;\r\nca->pkts_acked = 1;\r\n}\r\n}\r\nstatic void htcp_init(struct sock *sk)\r\n{\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nmemset(ca, 0, sizeof(struct htcp));\r\nca->alpha = ALPHA_BASE;\r\nca->beta = BETA_MIN;\r\nca->pkts_acked = 1;\r\nca->last_cong = jiffies;\r\n}\r\nstatic void htcp_state(struct sock *sk, u8 new_state)\r\n{\r\nswitch (new_state) {\r\ncase TCP_CA_Open:\r\n{\r\nstruct htcp *ca = inet_csk_ca(sk);\r\nif (ca->undo_last_cong) {\r\nca->last_cong = jiffies;\r\nca->undo_last_cong = 0;\r\n}\r\n}\r\nbreak;\r\ncase TCP_CA_CWR:\r\ncase TCP_CA_Recovery:\r\ncase TCP_CA_Loss:\r\nhtcp_reset(inet_csk_ca(sk));\r\nbreak;\r\n}\r\n}\r\nstatic int __init htcp_register(void)\r\n{\r\nBUILD_BUG_ON(sizeof(struct htcp) > ICSK_CA_PRIV_SIZE);\r\nBUILD_BUG_ON(BETA_MIN >= BETA_MAX);\r\nreturn tcp_register_congestion_control(&htcp);\r\n}\r\nstatic void __exit htcp_unregister(void)\r\n{\r\ntcp_unregister_congestion_control(&htcp);\r\n}

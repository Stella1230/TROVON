static unsigned int cb_pcidda_serial_in(struct comedi_device *dev)\r\n{\r\nstruct cb_pcidda_private *devpriv = dev->private;\r\nunsigned int value = 0;\r\nint i;\r\nconst int value_width = 16;\r\nfor (i = 1; i <= value_width; i++) {\r\nif (inw_p(devpriv->daqio + DACALIBRATION1) & SERIAL_OUT_BIT)\r\nvalue |= 1 << (value_width - i);\r\n}\r\nreturn value;\r\n}\r\nstatic void cb_pcidda_serial_out(struct comedi_device *dev, unsigned int value,\r\nunsigned int num_bits)\r\n{\r\nstruct cb_pcidda_private *devpriv = dev->private;\r\nint i;\r\nfor (i = 1; i <= num_bits; i++) {\r\nif (value & (1 << (num_bits - i)))\r\ndevpriv->dac_cal1_bits |= SERIAL_IN_BIT;\r\nelse\r\ndevpriv->dac_cal1_bits &= ~SERIAL_IN_BIT;\r\noutw_p(devpriv->dac_cal1_bits, devpriv->daqio + DACALIBRATION1);\r\n}\r\n}\r\nstatic unsigned int cb_pcidda_read_eeprom(struct comedi_device *dev,\r\nunsigned int address)\r\n{\r\nstruct cb_pcidda_private *devpriv = dev->private;\r\nunsigned int i;\r\nunsigned int cal2_bits;\r\nunsigned int value;\r\nconst int max_num_caldacs = 4;\r\nconst int read_instruction = 0x6;\r\nconst int instruction_length = 3;\r\nconst int address_length = 8;\r\ncal2_bits = SELECT_EEPROM_BIT | DESELECT_REF_DAC_BIT | DUMMY_BIT;\r\nfor (i = 0; i < max_num_caldacs; i++)\r\ncal2_bits |= DESELECT_CALDAC_BIT(i);\r\noutw_p(cal2_bits, devpriv->daqio + DACALIBRATION2);\r\ncb_pcidda_serial_out(dev, read_instruction, instruction_length);\r\ncb_pcidda_serial_out(dev, address, address_length);\r\nvalue = cb_pcidda_serial_in(dev);\r\ncal2_bits &= ~SELECT_EEPROM_BIT;\r\noutw_p(cal2_bits, devpriv->daqio + DACALIBRATION2);\r\nreturn value;\r\n}\r\nstatic void cb_pcidda_write_caldac(struct comedi_device *dev,\r\nunsigned int caldac, unsigned int channel,\r\nunsigned int value)\r\n{\r\nstruct cb_pcidda_private *devpriv = dev->private;\r\nunsigned int cal2_bits;\r\nunsigned int i;\r\nconst int num_channel_bits = 3;\r\nconst int num_caldac_bits = 8;\r\nconst int max_num_caldacs = 4;\r\ncb_pcidda_serial_out(dev, channel, num_channel_bits);\r\ncb_pcidda_serial_out(dev, value, num_caldac_bits);\r\ncal2_bits = DESELECT_REF_DAC_BIT | DUMMY_BIT;\r\nfor (i = 0; i < max_num_caldacs; i++)\r\ncal2_bits |= DESELECT_CALDAC_BIT(i);\r\ncal2_bits &= ~DESELECT_CALDAC_BIT(caldac);\r\noutw_p(cal2_bits, devpriv->daqio + DACALIBRATION2);\r\ncal2_bits |= DESELECT_CALDAC_BIT(caldac);\r\noutw_p(cal2_bits, devpriv->daqio + DACALIBRATION2);\r\n}\r\nstatic void cb_pcidda_calibrate(struct comedi_device *dev, unsigned int channel,\r\nunsigned int range)\r\n{\r\nstruct cb_pcidda_private *devpriv = dev->private;\r\nunsigned int caldac = channel / 2;\r\nunsigned int chan = 4 * (channel % 2);\r\nunsigned int index = 2 * range + 12 * channel;\r\nunsigned int offset;\r\nunsigned int gain;\r\ndevpriv->ao_range[channel] = range;\r\noffset = devpriv->eeprom_data[0x7 + index];\r\ngain = devpriv->eeprom_data[0x8 + index];\r\ncb_pcidda_write_caldac(dev, caldac, chan + CB_DDA_CALDAC_COURSE_OFFSET,\r\n(offset >> 8) & 0xff);\r\ncb_pcidda_write_caldac(dev, caldac, chan + CB_DDA_CALDAC_FINE_OFFSET,\r\noffset & 0xff);\r\ncb_pcidda_write_caldac(dev, caldac, chan + CB_DDA_CALDAC_COURSE_GAIN,\r\n(gain >> 8) & 0xff);\r\ncb_pcidda_write_caldac(dev, caldac, chan + CB_DDA_CALDAC_FINE_GAIN,\r\ngain & 0xff);\r\n}\r\nstatic int cb_pcidda_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct cb_pcidda_private *devpriv = dev->private;\r\nunsigned int channel = CR_CHAN(insn->chanspec);\r\nunsigned int range = CR_RANGE(insn->chanspec);\r\nunsigned int ctrl;\r\nif (range != devpriv->ao_range[channel])\r\ncb_pcidda_calibrate(dev, channel, range);\r\nctrl = CB_DDA_DA_CTRL_EN | CB_DDA_DA_CTRL_DAC(channel);\r\nswitch (range) {\r\ncase 0:\r\ncase 3:\r\nctrl |= CB_DDA_DA_CTRL_RANGE10V;\r\nbreak;\r\ncase 1:\r\ncase 4:\r\nctrl |= CB_DDA_DA_CTRL_RANGE5V;\r\nbreak;\r\ncase 2:\r\ncase 5:\r\nctrl |= CB_DDA_DA_CTRL_RANGE2V5;\r\nbreak;\r\n}\r\nif (range > 2)\r\nctrl |= CB_DDA_DA_CTRL_UNIP;\r\noutw(ctrl, devpriv->daqio + CB_DDA_DA_CTRL_REG);\r\noutw(data[0], devpriv->daqio + CB_DDA_DA_DATA_REG(channel));\r\nreturn insn->n;\r\n}\r\nstatic int cb_pcidda_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct cb_pcidda_board *thisboard = NULL;\r\nstruct cb_pcidda_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint i;\r\nint ret;\r\nif (context < ARRAY_SIZE(cb_pcidda_boards))\r\nthisboard = &cb_pcidda_boards[context];\r\nif (!thisboard)\r\nreturn -ENODEV;\r\ndev->board_ptr = thisboard;\r\ndev->board_name = thisboard->name;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndev->iobase = pci_resource_start(pcidev, 2);\r\ndevpriv->daqio = pci_resource_start(pcidev, 3);\r\nret = comedi_alloc_subdevices(dev, 3);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->ao_chans;\r\ns->maxdata = (1 << thisboard->ao_bits) - 1;\r\ns->range_table = &cb_pcidda_ranges;\r\ns->insn_write = cb_pcidda_ao_insn_write;\r\nfor (i = 0; i < 2; i++) {\r\ns = &dev->subdevices[1 + i];\r\nret = subdev_8255_init(dev, s, NULL, i * I8255_SIZE);\r\nif (ret)\r\nreturn ret;\r\n}\r\nfor (i = 0; i < EEPROM_SIZE; i++)\r\ndevpriv->eeprom_data[i] = cb_pcidda_read_eeprom(dev, i);\r\nfor (i = 0; i < thisboard->ao_chans; i++)\r\ncb_pcidda_calibrate(dev, i, devpriv->ao_range[i]);\r\nreturn 0;\r\n}\r\nstatic int cb_pcidda_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &cb_pcidda_driver,\r\nid->driver_data);\r\n}

static int si470x_set_band(struct si470x_device *radio, int band)\r\n{\r\nif (radio->band == band)\r\nreturn 0;\r\nradio->band = band;\r\nradio->registers[SYSCONFIG2] &= ~SYSCONFIG2_BAND;\r\nradio->registers[SYSCONFIG2] |= radio->band << 6;\r\nreturn si470x_set_register(radio, SYSCONFIG2);\r\n}\r\nstatic int si470x_set_chan(struct si470x_device *radio, unsigned short chan)\r\n{\r\nint retval;\r\nbool timed_out = false;\r\nradio->registers[CHANNEL] &= ~CHANNEL_CHAN;\r\nradio->registers[CHANNEL] |= CHANNEL_TUNE | chan;\r\nretval = si470x_set_register(radio, CHANNEL);\r\nif (retval < 0)\r\ngoto done;\r\nreinit_completion(&radio->completion);\r\nretval = wait_for_completion_timeout(&radio->completion,\r\nmsecs_to_jiffies(tune_timeout));\r\nif (!retval)\r\ntimed_out = true;\r\nif ((radio->registers[STATUSRSSI] & STATUSRSSI_STC) == 0)\r\ndev_warn(&radio->videodev.dev, "tune does not complete\n");\r\nif (timed_out)\r\ndev_warn(&radio->videodev.dev,\r\n"tune timed out after %u ms\n", tune_timeout);\r\nradio->registers[CHANNEL] &= ~CHANNEL_TUNE;\r\nretval = si470x_set_register(radio, CHANNEL);\r\ndone:\r\nreturn retval;\r\n}\r\nstatic unsigned int si470x_get_step(struct si470x_device *radio)\r\n{\r\nswitch ((radio->registers[SYSCONFIG2] & SYSCONFIG2_SPACE) >> 4) {\r\ncase 0:\r\nreturn 200 * 16;\r\ncase 1:\r\nreturn 100 * 16;\r\ndefault:\r\nreturn 50 * 16;\r\n}\r\n}\r\nstatic int si470x_get_freq(struct si470x_device *radio, unsigned int *freq)\r\n{\r\nint chan, retval;\r\nretval = si470x_get_register(radio, READCHAN);\r\nchan = radio->registers[READCHAN] & READCHAN_READCHAN;\r\n*freq = chan * si470x_get_step(radio) + bands[radio->band].rangelow;\r\nreturn retval;\r\n}\r\nint si470x_set_freq(struct si470x_device *radio, unsigned int freq)\r\n{\r\nunsigned short chan;\r\nfreq = clamp(freq, bands[radio->band].rangelow,\r\nbands[radio->band].rangehigh);\r\nchan = (freq - bands[radio->band].rangelow) / si470x_get_step(radio);\r\nreturn si470x_set_chan(radio, chan);\r\n}\r\nstatic int si470x_set_seek(struct si470x_device *radio,\r\nconst struct v4l2_hw_freq_seek *seek)\r\n{\r\nint band, retval;\r\nunsigned int freq;\r\nbool timed_out = false;\r\nif (seek->rangelow || seek->rangehigh) {\r\nfor (band = 0; band < ARRAY_SIZE(bands); band++) {\r\nif (bands[band].rangelow == seek->rangelow &&\r\nbands[band].rangehigh == seek->rangehigh)\r\nbreak;\r\n}\r\nif (band == ARRAY_SIZE(bands))\r\nreturn -EINVAL;\r\n} else\r\nband = 1;\r\nif (radio->band != band) {\r\nretval = si470x_get_freq(radio, &freq);\r\nif (retval)\r\nreturn retval;\r\nretval = si470x_set_band(radio, band);\r\nif (retval)\r\nreturn retval;\r\nretval = si470x_set_freq(radio, freq);\r\nif (retval)\r\nreturn retval;\r\n}\r\nradio->registers[POWERCFG] |= POWERCFG_SEEK;\r\nif (seek->wrap_around)\r\nradio->registers[POWERCFG] &= ~POWERCFG_SKMODE;\r\nelse\r\nradio->registers[POWERCFG] |= POWERCFG_SKMODE;\r\nif (seek->seek_upward)\r\nradio->registers[POWERCFG] |= POWERCFG_SEEKUP;\r\nelse\r\nradio->registers[POWERCFG] &= ~POWERCFG_SEEKUP;\r\nretval = si470x_set_register(radio, POWERCFG);\r\nif (retval < 0)\r\nreturn retval;\r\nreinit_completion(&radio->completion);\r\nretval = wait_for_completion_timeout(&radio->completion,\r\nmsecs_to_jiffies(seek_timeout));\r\nif (!retval)\r\ntimed_out = true;\r\nif ((radio->registers[STATUSRSSI] & STATUSRSSI_STC) == 0)\r\ndev_warn(&radio->videodev.dev, "seek does not complete\n");\r\nif (radio->registers[STATUSRSSI] & STATUSRSSI_SF)\r\ndev_warn(&radio->videodev.dev,\r\n"seek failed / band limit reached\n");\r\nradio->registers[POWERCFG] &= ~POWERCFG_SEEK;\r\nretval = si470x_set_register(radio, POWERCFG);\r\nif (retval == 0 && timed_out)\r\nreturn -ENODATA;\r\nreturn retval;\r\n}\r\nint si470x_start(struct si470x_device *radio)\r\n{\r\nint retval;\r\nradio->registers[POWERCFG] =\r\nPOWERCFG_DMUTE | POWERCFG_ENABLE | POWERCFG_RDSM;\r\nretval = si470x_set_register(radio, POWERCFG);\r\nif (retval < 0)\r\ngoto done;\r\nradio->registers[SYSCONFIG1] =\r\n(de << 11) & SYSCONFIG1_DE;\r\nretval = si470x_set_register(radio, SYSCONFIG1);\r\nif (retval < 0)\r\ngoto done;\r\nradio->registers[SYSCONFIG2] =\r\n(0x1f << 8) |\r\n((radio->band << 6) & SYSCONFIG2_BAND) |\r\n((space << 4) & SYSCONFIG2_SPACE) |\r\n15;\r\nretval = si470x_set_register(radio, SYSCONFIG2);\r\nif (retval < 0)\r\ngoto done;\r\nretval = si470x_set_chan(radio,\r\nradio->registers[CHANNEL] & CHANNEL_CHAN);\r\ndone:\r\nreturn retval;\r\n}\r\nint si470x_stop(struct si470x_device *radio)\r\n{\r\nint retval;\r\nradio->registers[SYSCONFIG1] &= ~SYSCONFIG1_RDS;\r\nretval = si470x_set_register(radio, SYSCONFIG1);\r\nif (retval < 0)\r\ngoto done;\r\nradio->registers[POWERCFG] &= ~POWERCFG_DMUTE;\r\nradio->registers[POWERCFG] |= POWERCFG_ENABLE | POWERCFG_DISABLE;\r\nretval = si470x_set_register(radio, POWERCFG);\r\ndone:\r\nreturn retval;\r\n}\r\nstatic int si470x_rds_on(struct si470x_device *radio)\r\n{\r\nint retval;\r\nradio->registers[SYSCONFIG1] |= SYSCONFIG1_RDS;\r\nretval = si470x_set_register(radio, SYSCONFIG1);\r\nif (retval < 0)\r\nradio->registers[SYSCONFIG1] &= ~SYSCONFIG1_RDS;\r\nreturn retval;\r\n}\r\nstatic ssize_t si470x_fops_read(struct file *file, char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nunsigned int block_count = 0;\r\nif ((radio->registers[SYSCONFIG1] & SYSCONFIG1_RDS) == 0)\r\nsi470x_rds_on(radio);\r\nwhile (radio->wr_index == radio->rd_index) {\r\nif (file->f_flags & O_NONBLOCK) {\r\nretval = -EWOULDBLOCK;\r\ngoto done;\r\n}\r\nif (wait_event_interruptible(radio->read_queue,\r\nradio->wr_index != radio->rd_index) < 0) {\r\nretval = -EINTR;\r\ngoto done;\r\n}\r\n}\r\ncount /= 3;\r\nwhile (block_count < count) {\r\nif (radio->rd_index == radio->wr_index)\r\nbreak;\r\nif (copy_to_user(buf, &radio->buffer[radio->rd_index], 3))\r\nbreak;\r\nradio->rd_index += 3;\r\nif (radio->rd_index >= radio->buf_size)\r\nradio->rd_index = 0;\r\nblock_count++;\r\nbuf += 3;\r\nretval += 3;\r\n}\r\ndone:\r\nreturn retval;\r\n}\r\nstatic unsigned int si470x_fops_poll(struct file *file,\r\nstruct poll_table_struct *pts)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nunsigned long req_events = poll_requested_events(pts);\r\nint retval = v4l2_ctrl_poll(file, pts);\r\nif (req_events & (POLLIN | POLLRDNORM)) {\r\nif ((radio->registers[SYSCONFIG1] & SYSCONFIG1_RDS) == 0)\r\nsi470x_rds_on(radio);\r\npoll_wait(file, &radio->read_queue, pts);\r\nif (radio->rd_index != radio->wr_index)\r\nretval |= POLLIN | POLLRDNORM;\r\n}\r\nreturn retval;\r\n}\r\nstatic int si470x_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct si470x_device *radio =\r\ncontainer_of(ctrl->handler, struct si470x_device, hdl);\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_AUDIO_VOLUME:\r\nradio->registers[SYSCONFIG2] &= ~SYSCONFIG2_VOLUME;\r\nradio->registers[SYSCONFIG2] |= ctrl->val;\r\nreturn si470x_set_register(radio, SYSCONFIG2);\r\ncase V4L2_CID_AUDIO_MUTE:\r\nif (ctrl->val)\r\nradio->registers[POWERCFG] &= ~POWERCFG_DMUTE;\r\nelse\r\nradio->registers[POWERCFG] |= POWERCFG_DMUTE;\r\nreturn si470x_set_register(radio, POWERCFG);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int si470x_vidioc_g_tuner(struct file *file, void *priv,\r\nstruct v4l2_tuner *tuner)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval = 0;\r\nif (tuner->index != 0)\r\nreturn -EINVAL;\r\nif (!radio->status_rssi_auto_update) {\r\nretval = si470x_get_register(radio, STATUSRSSI);\r\nif (retval < 0)\r\nreturn retval;\r\n}\r\nstrcpy(tuner->name, "FM");\r\ntuner->type = V4L2_TUNER_RADIO;\r\ntuner->capability = V4L2_TUNER_CAP_LOW | V4L2_TUNER_CAP_STEREO |\r\nV4L2_TUNER_CAP_RDS | V4L2_TUNER_CAP_RDS_BLOCK_IO |\r\nV4L2_TUNER_CAP_HWSEEK_BOUNDED |\r\nV4L2_TUNER_CAP_HWSEEK_WRAP;\r\ntuner->rangelow = 76 * FREQ_MUL;\r\ntuner->rangehigh = 108 * FREQ_MUL;\r\nif ((radio->registers[STATUSRSSI] & STATUSRSSI_ST) == 0)\r\ntuner->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nelse\r\ntuner->rxsubchans = V4L2_TUNER_SUB_STEREO;\r\ntuner->rxsubchans |= V4L2_TUNER_SUB_RDS;\r\nif ((radio->registers[POWERCFG] & POWERCFG_MONO) == 0)\r\ntuner->audmode = V4L2_TUNER_MODE_STEREO;\r\nelse\r\ntuner->audmode = V4L2_TUNER_MODE_MONO;\r\ntuner->signal = (radio->registers[STATUSRSSI] & STATUSRSSI_RSSI);\r\ntuner->signal = (tuner->signal * 873) + (8 * tuner->signal / 10);\r\nif (tuner->signal > 0xffff)\r\ntuner->signal = 0xffff;\r\ntuner->afc = (radio->registers[STATUSRSSI] & STATUSRSSI_AFCRL) ? 1 : 0;\r\nreturn retval;\r\n}\r\nstatic int si470x_vidioc_s_tuner(struct file *file, void *priv,\r\nconst struct v4l2_tuner *tuner)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nif (tuner->index != 0)\r\nreturn -EINVAL;\r\nswitch (tuner->audmode) {\r\ncase V4L2_TUNER_MODE_MONO:\r\nradio->registers[POWERCFG] |= POWERCFG_MONO;\r\nbreak;\r\ncase V4L2_TUNER_MODE_STEREO:\r\ndefault:\r\nradio->registers[POWERCFG] &= ~POWERCFG_MONO;\r\nbreak;\r\n}\r\nreturn si470x_set_register(radio, POWERCFG);\r\n}\r\nstatic int si470x_vidioc_g_frequency(struct file *file, void *priv,\r\nstruct v4l2_frequency *freq)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nif (freq->tuner != 0)\r\nreturn -EINVAL;\r\nfreq->type = V4L2_TUNER_RADIO;\r\nreturn si470x_get_freq(radio, &freq->frequency);\r\n}\r\nstatic int si470x_vidioc_s_frequency(struct file *file, void *priv,\r\nconst struct v4l2_frequency *freq)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nint retval;\r\nif (freq->tuner != 0)\r\nreturn -EINVAL;\r\nif (freq->frequency < bands[radio->band].rangelow ||\r\nfreq->frequency > bands[radio->band].rangehigh) {\r\nretval = si470x_set_band(radio, 1);\r\nif (retval)\r\nreturn retval;\r\n}\r\nreturn si470x_set_freq(radio, freq->frequency);\r\n}\r\nstatic int si470x_vidioc_s_hw_freq_seek(struct file *file, void *priv,\r\nconst struct v4l2_hw_freq_seek *seek)\r\n{\r\nstruct si470x_device *radio = video_drvdata(file);\r\nif (seek->tuner != 0)\r\nreturn -EINVAL;\r\nif (file->f_flags & O_NONBLOCK)\r\nreturn -EWOULDBLOCK;\r\nreturn si470x_set_seek(radio, seek);\r\n}\r\nstatic int si470x_vidioc_enum_freq_bands(struct file *file, void *priv,\r\nstruct v4l2_frequency_band *band)\r\n{\r\nif (band->tuner != 0)\r\nreturn -EINVAL;\r\nif (band->index >= ARRAY_SIZE(bands))\r\nreturn -EINVAL;\r\n*band = bands[band->index];\r\nreturn 0;\r\n}

static void adf_service_add(struct service_hndl *service)\r\n{\r\nmutex_lock(&service_lock);\r\nlist_add(&service->list, &service_table);\r\nmutex_unlock(&service_lock);\r\n}\r\nint adf_service_register(struct service_hndl *service)\r\n{\r\nservice->init_status = 0;\r\nservice->start_status = 0;\r\nadf_service_add(service);\r\nreturn 0;\r\n}\r\nstatic void adf_service_remove(struct service_hndl *service)\r\n{\r\nmutex_lock(&service_lock);\r\nlist_del(&service->list);\r\nmutex_unlock(&service_lock);\r\n}\r\nint adf_service_unregister(struct service_hndl *service)\r\n{\r\nif (service->init_status || service->start_status) {\r\npr_err("QAT: Could not remove active service\n");\r\nreturn -EFAULT;\r\n}\r\nadf_service_remove(service);\r\nreturn 0;\r\n}\r\nint adf_dev_start(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct service_hndl *service;\r\nstruct list_head *list_itr;\r\nstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\r\nif (!test_bit(ADF_STATUS_CONFIGURED, &accel_dev->status)) {\r\npr_info("QAT: Device not configured\n");\r\nreturn -EFAULT;\r\n}\r\nset_bit(ADF_STATUS_STARTING, &accel_dev->status);\r\nif (adf_ae_init(accel_dev)) {\r\npr_err("QAT: Failed to initialise Acceleration Engine\n");\r\nreturn -EFAULT;\r\n}\r\nset_bit(ADF_STATUS_AE_INITIALISED, &accel_dev->status);\r\nif (adf_ae_fw_load(accel_dev)) {\r\npr_err("QAT: Failed to load acceleration FW\n");\r\nadf_ae_fw_release(accel_dev);\r\nreturn -EFAULT;\r\n}\r\nset_bit(ADF_STATUS_AE_UCODE_LOADED, &accel_dev->status);\r\nif (hw_data->alloc_irq(accel_dev)) {\r\npr_err("QAT: Failed to allocate interrupts\n");\r\nreturn -EFAULT;\r\n}\r\nset_bit(ADF_STATUS_IRQ_ALLOCATED, &accel_dev->status);\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (!service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_INIT)) {\r\npr_err("QAT: Failed to initialise service %s\n",\r\nservice->name);\r\nreturn -EFAULT;\r\n}\r\nset_bit(accel_dev->accel_id, &service->init_status);\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_INIT)) {\r\npr_err("QAT: Failed to initialise service %s\n",\r\nservice->name);\r\nreturn -EFAULT;\r\n}\r\nset_bit(accel_dev->accel_id, &service->init_status);\r\n}\r\nhw_data->enable_error_correction(accel_dev);\r\nif (adf_ae_start(accel_dev)) {\r\npr_err("QAT: AE Start Failed\n");\r\nreturn -EFAULT;\r\n}\r\nset_bit(ADF_STATUS_AE_STARTED, &accel_dev->status);\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (!service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_START)) {\r\npr_err("QAT: Failed to start service %s\n",\r\nservice->name);\r\nreturn -EFAULT;\r\n}\r\nset_bit(accel_dev->accel_id, &service->start_status);\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_START)) {\r\npr_err("QAT: Failed to start service %s\n",\r\nservice->name);\r\nreturn -EFAULT;\r\n}\r\nset_bit(accel_dev->accel_id, &service->start_status);\r\n}\r\nclear_bit(ADF_STATUS_STARTING, &accel_dev->status);\r\nset_bit(ADF_STATUS_STARTED, &accel_dev->status);\r\nif (qat_algs_register()) {\r\npr_err("QAT: Failed to register crypto algs\n");\r\nset_bit(ADF_STATUS_STARTING, &accel_dev->status);\r\nclear_bit(ADF_STATUS_STARTED, &accel_dev->status);\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nint adf_dev_stop(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_hw_device_data *hw_data = accel_dev->hw_device;\r\nstruct service_hndl *service;\r\nstruct list_head *list_itr;\r\nint ret, wait = 0;\r\nif (!adf_dev_started(accel_dev) &&\r\n!test_bit(ADF_STATUS_STARTING, &accel_dev->status)) {\r\nreturn 0;\r\n}\r\nclear_bit(ADF_STATUS_CONFIGURED, &accel_dev->status);\r\nclear_bit(ADF_STATUS_STARTING, &accel_dev->status);\r\nclear_bit(ADF_STATUS_STARTED, &accel_dev->status);\r\nif (qat_algs_unregister())\r\npr_err("QAT: Failed to unregister crypto algs\n");\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (service->admin)\r\ncontinue;\r\nif (!test_bit(accel_dev->accel_id, &service->start_status))\r\ncontinue;\r\nret = service->event_hld(accel_dev, ADF_EVENT_STOP);\r\nif (!ret) {\r\nclear_bit(accel_dev->accel_id, &service->start_status);\r\n} else if (ret == -EAGAIN) {\r\nwait = 1;\r\nclear_bit(accel_dev->accel_id, &service->start_status);\r\n}\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (!service->admin)\r\ncontinue;\r\nif (!test_bit(accel_dev->accel_id, &service->start_status))\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_STOP))\r\npr_err("QAT: Failed to shutdown service %s\n",\r\nservice->name);\r\nelse\r\nclear_bit(accel_dev->accel_id, &service->start_status);\r\n}\r\nif (wait)\r\nmsleep(100);\r\nif (adf_dev_started(accel_dev)) {\r\nif (adf_ae_stop(accel_dev))\r\npr_err("QAT: failed to stop AE\n");\r\nelse\r\nclear_bit(ADF_STATUS_AE_STARTED, &accel_dev->status);\r\n}\r\nif (test_bit(ADF_STATUS_AE_UCODE_LOADED, &accel_dev->status)) {\r\nif (adf_ae_fw_release(accel_dev))\r\npr_err("QAT: Failed to release the ucode\n");\r\nelse\r\nclear_bit(ADF_STATUS_AE_UCODE_LOADED,\r\n&accel_dev->status);\r\n}\r\nif (test_bit(ADF_STATUS_AE_INITIALISED, &accel_dev->status)) {\r\nif (adf_ae_shutdown(accel_dev))\r\npr_err("QAT: Failed to shutdown Accel Engine\n");\r\nelse\r\nclear_bit(ADF_STATUS_AE_INITIALISED,\r\n&accel_dev->status);\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (service->admin)\r\ncontinue;\r\nif (!test_bit(accel_dev->accel_id, &service->init_status))\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_SHUTDOWN))\r\npr_err("QAT: Failed to shutdown service %s\n",\r\nservice->name);\r\nelse\r\nclear_bit(accel_dev->accel_id, &service->init_status);\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (!service->admin)\r\ncontinue;\r\nif (!test_bit(accel_dev->accel_id, &service->init_status))\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_SHUTDOWN))\r\npr_err("QAT: Failed to shutdown service %s\n",\r\nservice->name);\r\nelse\r\nclear_bit(accel_dev->accel_id, &service->init_status);\r\n}\r\nif (test_bit(ADF_STATUS_IRQ_ALLOCATED, &accel_dev->status)) {\r\nhw_data->free_irq(accel_dev);\r\nclear_bit(ADF_STATUS_IRQ_ALLOCATED, &accel_dev->status);\r\n}\r\nif (!test_bit(ADF_STATUS_RESTARTING, &accel_dev->status))\r\nadf_cfg_del_all(accel_dev);\r\nreturn 0;\r\n}\r\nint adf_dev_restarting_notify(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct service_hndl *service;\r\nstruct list_head *list_itr;\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_RESTARTING))\r\npr_err("QAT: Failed to restart service %s.\n",\r\nservice->name);\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (!service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_RESTARTING))\r\npr_err("QAT: Failed to restart service %s.\n",\r\nservice->name);\r\n}\r\nreturn 0;\r\n}\r\nint adf_dev_restarted_notify(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct service_hndl *service;\r\nstruct list_head *list_itr;\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_RESTARTED))\r\npr_err("QAT: Failed to restart service %s.\n",\r\nservice->name);\r\n}\r\nlist_for_each(list_itr, &service_table) {\r\nservice = list_entry(list_itr, struct service_hndl, list);\r\nif (!service->admin)\r\ncontinue;\r\nif (service->event_hld(accel_dev, ADF_EVENT_RESTARTED))\r\npr_err("QAT: Failed to restart service %s.\n",\r\nservice->name);\r\n}\r\nreturn 0;\r\n}

static ssize_t lua_sysfs_read(struct file *fp, struct kobject *kobj,\r\nchar *buf, loff_t off, size_t count,\r\nsize_t real_size, uint command)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct lua_device *lua = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off >= real_size)\r\nreturn 0;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&lua->lua_lock);\r\nretval = roccat_common2_receive(usb_dev, command, buf, real_size);\r\nmutex_unlock(&lua->lua_lock);\r\nreturn retval ? retval : real_size;\r\n}\r\nstatic ssize_t lua_sysfs_write(struct file *fp, struct kobject *kobj,\r\nvoid const *buf, loff_t off, size_t count,\r\nsize_t real_size, uint command)\r\n{\r\nstruct device *dev = container_of(kobj, struct device, kobj);\r\nstruct lua_device *lua = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval;\r\nif (off != 0 || count != real_size)\r\nreturn -EINVAL;\r\nmutex_lock(&lua->lua_lock);\r\nretval = roccat_common2_send(usb_dev, command, buf, real_size);\r\nmutex_unlock(&lua->lua_lock);\r\nreturn retval ? retval : real_size;\r\n}\r\nstatic int lua_create_sysfs_attributes(struct usb_interface *intf)\r\n{\r\nreturn sysfs_create_bin_file(&intf->dev.kobj, &lua_control_attr);\r\n}\r\nstatic void lua_remove_sysfs_attributes(struct usb_interface *intf)\r\n{\r\nsysfs_remove_bin_file(&intf->dev.kobj, &lua_control_attr);\r\n}\r\nstatic int lua_init_lua_device_struct(struct usb_device *usb_dev,\r\nstruct lua_device *lua)\r\n{\r\nmutex_init(&lua->lua_lock);\r\nreturn 0;\r\n}\r\nstatic int lua_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct lua_device *lua;\r\nint retval;\r\nlua = kzalloc(sizeof(*lua), GFP_KERNEL);\r\nif (!lua) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, lua);\r\nretval = lua_init_lua_device_struct(usb_dev, lua);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init struct lua_device\n");\r\ngoto exit;\r\n}\r\nretval = lua_create_sysfs_attributes(intf);\r\nif (retval) {\r\nhid_err(hdev, "cannot create sysfs files\n");\r\ngoto exit;\r\n}\r\nreturn 0;\r\nexit:\r\nkfree(lua);\r\nreturn retval;\r\n}\r\nstatic void lua_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct lua_device *lua;\r\nlua_remove_sysfs_attributes(intf);\r\nlua = hid_get_drvdata(hdev);\r\nkfree(lua);\r\n}\r\nstatic int lua_probe(struct hid_device *hdev,\r\nconst struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = lua_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void lua_remove(struct hid_device *hdev)\r\n{\r\nlua_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}

static void hdmi_write_command(struct oxygen *chip, u8 command,\r\nunsigned int count, const u8 *params)\r\n{\r\nunsigned int i;\r\nu8 checksum;\r\noxygen_write_uart(chip, 0xfb);\r\noxygen_write_uart(chip, 0xef);\r\noxygen_write_uart(chip, command);\r\noxygen_write_uart(chip, count);\r\nfor (i = 0; i < count; ++i)\r\noxygen_write_uart(chip, params[i]);\r\nchecksum = 0xfb + 0xef + command + count;\r\nfor (i = 0; i < count; ++i)\r\nchecksum += params[i];\r\noxygen_write_uart(chip, checksum);\r\n}\r\nstatic void xonar_hdmi_init_commands(struct oxygen *chip,\r\nstruct xonar_hdmi *hdmi)\r\n{\r\nu8 param;\r\noxygen_reset_uart(chip);\r\nparam = 0;\r\nhdmi_write_command(chip, 0x61, 1, &param);\r\nparam = 1;\r\nhdmi_write_command(chip, 0x74, 1, &param);\r\nhdmi_write_command(chip, 0x54, 5, hdmi->params);\r\n}\r\nvoid xonar_hdmi_init(struct oxygen *chip, struct xonar_hdmi *hdmi)\r\n{\r\nhdmi->params[1] = IEC958_AES3_CON_FS_48000;\r\nhdmi->params[4] = 1;\r\nxonar_hdmi_init_commands(chip, hdmi);\r\n}\r\nvoid xonar_hdmi_cleanup(struct oxygen *chip)\r\n{\r\nu8 param = 0;\r\nhdmi_write_command(chip, 0x74, 1, &param);\r\n}\r\nvoid xonar_hdmi_resume(struct oxygen *chip, struct xonar_hdmi *hdmi)\r\n{\r\nxonar_hdmi_init_commands(chip, hdmi);\r\n}\r\nvoid xonar_hdmi_pcm_hardware_filter(unsigned int channel,\r\nstruct snd_pcm_hardware *hardware)\r\n{\r\nif (channel == PCM_MULTICH) {\r\nhardware->rates = SNDRV_PCM_RATE_44100 |\r\nSNDRV_PCM_RATE_48000 |\r\nSNDRV_PCM_RATE_96000 |\r\nSNDRV_PCM_RATE_192000;\r\nhardware->rate_min = 44100;\r\n}\r\n}\r\nvoid xonar_set_hdmi_params(struct oxygen *chip, struct xonar_hdmi *hdmi,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nhdmi->params[0] = 0;\r\nswitch (params_rate(params)) {\r\ncase 44100:\r\nhdmi->params[1] = IEC958_AES3_CON_FS_44100;\r\nbreak;\r\ncase 48000:\r\nhdmi->params[1] = IEC958_AES3_CON_FS_48000;\r\nbreak;\r\ndefault:\r\nhdmi->params[1] = IEC958_AES3_CON_FS_96000;\r\nbreak;\r\ncase 192000:\r\nhdmi->params[1] = IEC958_AES3_CON_FS_192000;\r\nbreak;\r\n}\r\nhdmi->params[2] = params_channels(params) / 2 - 1;\r\nif (params_format(params) == SNDRV_PCM_FORMAT_S16_LE)\r\nhdmi->params[3] = 0;\r\nelse\r\nhdmi->params[3] = 0xc0;\r\nhdmi->params[4] = 1;\r\nhdmi_write_command(chip, 0x54, 5, hdmi->params);\r\n}\r\nvoid xonar_hdmi_uart_input(struct oxygen *chip)\r\n{\r\nif (chip->uart_input_count >= 2 &&\r\nchip->uart_input[chip->uart_input_count - 2] == 'O' &&\r\nchip->uart_input[chip->uart_input_count - 1] == 'K') {\r\ndev_dbg(chip->card->dev, "message from HDMI chip received:\n");\r\nprint_hex_dump_bytes("", DUMP_PREFIX_OFFSET,\r\nchip->uart_input, chip->uart_input_count);\r\nchip->uart_input_count = 0;\r\n}\r\n}

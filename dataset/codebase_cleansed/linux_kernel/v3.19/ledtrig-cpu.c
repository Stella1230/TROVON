void ledtrig_cpu(enum cpu_led_event ledevt)\r\n{\r\nstruct led_trigger_cpu *trig = this_cpu_ptr(&cpu_trig);\r\nswitch (ledevt) {\r\ncase CPU_LED_IDLE_END:\r\ncase CPU_LED_START:\r\nled_trigger_event(trig->_trig, LED_FULL);\r\nbreak;\r\ncase CPU_LED_IDLE_START:\r\ncase CPU_LED_STOP:\r\ncase CPU_LED_HALTED:\r\nled_trigger_event(trig->_trig, LED_OFF);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int ledtrig_cpu_syscore_suspend(void)\r\n{\r\nledtrig_cpu(CPU_LED_STOP);\r\nreturn 0;\r\n}\r\nstatic void ledtrig_cpu_syscore_resume(void)\r\n{\r\nledtrig_cpu(CPU_LED_START);\r\n}\r\nstatic void ledtrig_cpu_syscore_shutdown(void)\r\n{\r\nledtrig_cpu(CPU_LED_HALTED);\r\n}\r\nstatic int ledtrig_cpu_notify(struct notifier_block *self,\r\nunsigned long action, void *hcpu)\r\n{\r\nswitch (action & ~CPU_TASKS_FROZEN) {\r\ncase CPU_STARTING:\r\nledtrig_cpu(CPU_LED_START);\r\nbreak;\r\ncase CPU_DYING:\r\nledtrig_cpu(CPU_LED_STOP);\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __init ledtrig_cpu_init(void)\r\n{\r\nint cpu;\r\nBUILD_BUG_ON(CONFIG_NR_CPUS > 9999);\r\nfor_each_possible_cpu(cpu) {\r\nstruct led_trigger_cpu *trig = &per_cpu(cpu_trig, cpu);\r\nsnprintf(trig->name, MAX_NAME_LEN, "cpu%d", cpu);\r\nled_trigger_register_simple(trig->name, &trig->_trig);\r\n}\r\nregister_syscore_ops(&ledtrig_cpu_syscore_ops);\r\nregister_cpu_notifier(&ledtrig_cpu_nb);\r\npr_info("ledtrig-cpu: registered to indicate activity on CPUs\n");\r\nreturn 0;\r\n}\r\nstatic void __exit ledtrig_cpu_exit(void)\r\n{\r\nint cpu;\r\nunregister_cpu_notifier(&ledtrig_cpu_nb);\r\nfor_each_possible_cpu(cpu) {\r\nstruct led_trigger_cpu *trig = &per_cpu(cpu_trig, cpu);\r\nled_trigger_unregister_simple(trig->_trig);\r\ntrig->_trig = NULL;\r\nmemset(trig->name, 0, MAX_NAME_LEN);\r\n}\r\nunregister_syscore_ops(&ledtrig_cpu_syscore_ops);\r\n}

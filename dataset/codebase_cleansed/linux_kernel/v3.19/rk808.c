static bool rk808_is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase RK808_SECONDS_REG ... RK808_WEEKS_REG:\r\ncase RK808_RTC_STATUS_REG:\r\ncase RK808_VB_MON_REG:\r\ncase RK808_THERMAL_REG:\r\ncase RK808_DCDC_UV_STS_REG:\r\ncase RK808_LDO_UV_STS_REG:\r\ncase RK808_DCDC_PG_REG:\r\ncase RK808_LDO_PG_REG:\r\ncase RK808_DEVCTRL_REG:\r\ncase RK808_INT_STS_REG1:\r\ncase RK808_INT_STS_REG2:\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nstatic void rk808_device_shutdown(void)\r\n{\r\nint ret;\r\nstruct rk808 *rk808 = i2c_get_clientdata(rk808_i2c_client);\r\nif (!rk808) {\r\ndev_warn(&rk808_i2c_client->dev,\r\n"have no rk808, so do nothing here\n");\r\nreturn;\r\n}\r\nret = regmap_update_bits(rk808->regmap,\r\nRK808_DEVCTRL_REG,\r\nDEV_OFF_RST, DEV_OFF_RST);\r\nif (ret)\r\ndev_err(&rk808_i2c_client->dev, "power off error!\n");\r\n}\r\nstatic int rk808_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device_node *np = client->dev.of_node;\r\nstruct rk808 *rk808;\r\nint pm_off = 0;\r\nint ret;\r\nint i;\r\nif (!client->irq) {\r\ndev_err(&client->dev, "No interrupt support, no core IRQ\n");\r\nreturn -EINVAL;\r\n}\r\nrk808 = devm_kzalloc(&client->dev, sizeof(*rk808), GFP_KERNEL);\r\nif (!rk808)\r\nreturn -ENOMEM;\r\nrk808->regmap = devm_regmap_init_i2c(client, &rk808_regmap_config);\r\nif (IS_ERR(rk808->regmap)) {\r\ndev_err(&client->dev, "regmap initialization failed\n");\r\nreturn PTR_ERR(rk808->regmap);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(pre_init_reg); i++) {\r\nret = regmap_update_bits(rk808->regmap, pre_init_reg[i].addr,\r\npre_init_reg[i].mask,\r\npre_init_reg[i].value);\r\nif (ret) {\r\ndev_err(&client->dev,\r\n"0x%x write err\n", pre_init_reg[i].addr);\r\nreturn ret;\r\n}\r\n}\r\nret = regmap_add_irq_chip(rk808->regmap, client->irq,\r\nIRQF_ONESHOT, -1,\r\n&rk808_irq_chip, &rk808->irq_data);\r\nif (ret) {\r\ndev_err(&client->dev, "Failed to add irq_chip %d\n", ret);\r\nreturn ret;\r\n}\r\nrk808->i2c = client;\r\ni2c_set_clientdata(client, rk808);\r\nret = mfd_add_devices(&client->dev, -1,\r\nrk808s, ARRAY_SIZE(rk808s),\r\nNULL, 0, regmap_irq_get_domain(rk808->irq_data));\r\nif (ret) {\r\ndev_err(&client->dev, "failed to add MFD devices %d\n", ret);\r\ngoto err_irq;\r\n}\r\npm_off = of_property_read_bool(np,\r\n"rockchip,system-power-controller");\r\nif (pm_off && !pm_power_off) {\r\nrk808_i2c_client = client;\r\npm_power_off = rk808_device_shutdown;\r\n}\r\nreturn 0;\r\nerr_irq:\r\nregmap_del_irq_chip(client->irq, rk808->irq_data);\r\nreturn ret;\r\n}\r\nstatic int rk808_remove(struct i2c_client *client)\r\n{\r\nstruct rk808 *rk808 = i2c_get_clientdata(client);\r\nregmap_del_irq_chip(client->irq, rk808->irq_data);\r\nmfd_remove_devices(&client->dev);\r\npm_power_off = NULL;\r\nreturn 0;\r\n}

static struct drm_file *drm_find_file(struct drm_master *master, drm_magic_t magic)\r\n{\r\nstruct drm_file *retval = NULL;\r\nstruct drm_magic_entry *pt;\r\nstruct drm_hash_item *hash;\r\nstruct drm_device *dev = master->minor->dev;\r\nmutex_lock(&dev->struct_mutex);\r\nif (!drm_ht_find_item(&master->magiclist, (unsigned long)magic, &hash)) {\r\npt = drm_hash_entry(hash, struct drm_magic_entry, hash_item);\r\nretval = pt->priv;\r\n}\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn retval;\r\n}\r\nstatic int drm_add_magic(struct drm_master *master, struct drm_file *priv,\r\ndrm_magic_t magic)\r\n{\r\nstruct drm_magic_entry *entry;\r\nstruct drm_device *dev = master->minor->dev;\r\nDRM_DEBUG("%d\n", magic);\r\nentry = kzalloc(sizeof(*entry), GFP_KERNEL);\r\nif (!entry)\r\nreturn -ENOMEM;\r\nentry->priv = priv;\r\nentry->hash_item.key = (unsigned long)magic;\r\nmutex_lock(&dev->struct_mutex);\r\ndrm_ht_insert_item(&master->magiclist, &entry->hash_item);\r\nlist_add_tail(&entry->head, &master->magicfree);\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn 0;\r\n}\r\nint drm_remove_magic(struct drm_master *master, drm_magic_t magic)\r\n{\r\nstruct drm_magic_entry *pt;\r\nstruct drm_hash_item *hash;\r\nstruct drm_device *dev = master->minor->dev;\r\nDRM_DEBUG("%d\n", magic);\r\nmutex_lock(&dev->struct_mutex);\r\nif (drm_ht_find_item(&master->magiclist, (unsigned long)magic, &hash)) {\r\nmutex_unlock(&dev->struct_mutex);\r\nreturn -EINVAL;\r\n}\r\npt = drm_hash_entry(hash, struct drm_magic_entry, hash_item);\r\ndrm_ht_remove_item(&master->magiclist, hash);\r\nlist_del(&pt->head);\r\nmutex_unlock(&dev->struct_mutex);\r\nkfree(pt);\r\nreturn 0;\r\n}\r\nint drm_getmagic(struct drm_device *dev, void *data, struct drm_file *file_priv)\r\n{\r\nstatic drm_magic_t sequence = 0;\r\nstatic DEFINE_SPINLOCK(lock);\r\nstruct drm_auth *auth = data;\r\nif (file_priv->magic) {\r\nauth->magic = file_priv->magic;\r\n} else {\r\ndo {\r\nspin_lock(&lock);\r\nif (!sequence)\r\n++sequence;\r\nauth->magic = sequence++;\r\nspin_unlock(&lock);\r\n} while (drm_find_file(file_priv->master, auth->magic));\r\nfile_priv->magic = auth->magic;\r\ndrm_add_magic(file_priv->master, file_priv, auth->magic);\r\n}\r\nDRM_DEBUG("%u\n", auth->magic);\r\nreturn 0;\r\n}\r\nint drm_authmagic(struct drm_device *dev, void *data,\r\nstruct drm_file *file_priv)\r\n{\r\nstruct drm_auth *auth = data;\r\nstruct drm_file *file;\r\nDRM_DEBUG("%u\n", auth->magic);\r\nif ((file = drm_find_file(file_priv->master, auth->magic))) {\r\nfile->authenticated = 1;\r\ndrm_remove_magic(file_priv->master, auth->magic);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}

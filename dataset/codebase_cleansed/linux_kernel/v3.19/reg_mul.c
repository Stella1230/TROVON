int FPU_mul(FPU_REG const *b, u_char tagb, int deststnr, int control_w)\r\n{\r\nFPU_REG *a = &st(deststnr);\r\nFPU_REG *dest = a;\r\nu_char taga = FPU_gettagi(deststnr);\r\nu_char saved_sign = getsign(dest);\r\nu_char sign = (getsign(a) ^ getsign(b));\r\nint tag;\r\nif (!(taga | tagb)) {\r\ntag =\r\nFPU_u_mul(a, b, dest, control_w, sign,\r\nexponent(a) + exponent(b));\r\nif (tag < 0) {\r\nsetsign(dest, saved_sign);\r\nreturn tag;\r\n}\r\nFPU_settagi(deststnr, tag);\r\nreturn tag;\r\n}\r\nif (taga == TAG_Special)\r\ntaga = FPU_Special(a);\r\nif (tagb == TAG_Special)\r\ntagb = FPU_Special(b);\r\nif (((taga == TAG_Valid) && (tagb == TW_Denormal))\r\n|| ((taga == TW_Denormal) && (tagb == TAG_Valid))\r\n|| ((taga == TW_Denormal) && (tagb == TW_Denormal))) {\r\nFPU_REG x, y;\r\nif (denormal_operand() < 0)\r\nreturn FPU_Exception;\r\nFPU_to_exp16(a, &x);\r\nFPU_to_exp16(b, &y);\r\ntag = FPU_u_mul(&x, &y, dest, control_w, sign,\r\nexponent16(&x) + exponent16(&y));\r\nif (tag < 0) {\r\nsetsign(dest, saved_sign);\r\nreturn tag;\r\n}\r\nFPU_settagi(deststnr, tag);\r\nreturn tag;\r\n} else if ((taga <= TW_Denormal) && (tagb <= TW_Denormal)) {\r\nif (((tagb == TW_Denormal) || (taga == TW_Denormal))\r\n&& (denormal_operand() < 0))\r\nreturn FPU_Exception;\r\nFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\r\nsetsign(dest, sign);\r\nreturn TAG_Zero;\r\n}\r\nelse if ((taga == TW_NaN) || (tagb == TW_NaN)) {\r\nreturn real_2op_NaN(b, tagb, deststnr, &st(0));\r\n} else if (((taga == TW_Infinity) && (tagb == TAG_Zero))\r\n|| ((tagb == TW_Infinity) && (taga == TAG_Zero))) {\r\nreturn arith_invalid(deststnr);\r\n} else if (((taga == TW_Denormal) || (tagb == TW_Denormal))\r\n&& (denormal_operand() < 0)) {\r\nreturn FPU_Exception;\r\n} else if (taga == TW_Infinity) {\r\nFPU_copy_to_regi(a, TAG_Special, deststnr);\r\nsetsign(dest, sign);\r\nreturn TAG_Special;\r\n} else if (tagb == TW_Infinity) {\r\nFPU_copy_to_regi(b, TAG_Special, deststnr);\r\nsetsign(dest, sign);\r\nreturn TAG_Special;\r\n}\r\n#ifdef PARANOID\r\nelse {\r\nEXCEPTION(EX_INTERNAL | 0x102);\r\nreturn FPU_Exception;\r\n}\r\n#endif\r\nreturn 0;\r\n}

static void adf_cleanup_accel(struct adf_accel_dev *accel_dev)\r\n{\r\nstruct adf_accel_pci *accel_pci_dev = &accel_dev->accel_pci_dev;\r\nint i;\r\nadf_exit_admin_comms(accel_dev);\r\nadf_exit_arb(accel_dev);\r\nadf_cleanup_etr_data(accel_dev);\r\nfor (i = 0; i < ADF_PCI_MAX_BARS; i++) {\r\nstruct adf_bar *bar = &accel_pci_dev->pci_bars[i];\r\nif (bar->virt_addr)\r\npci_iounmap(accel_pci_dev->pci_dev, bar->virt_addr);\r\n}\r\nif (accel_dev->hw_device) {\r\nswitch (accel_dev->hw_device->pci_dev_id) {\r\ncase ADF_DH895XCC_PCI_DEVICE_ID:\r\nadf_clean_hw_data_dh895xcc(accel_dev->hw_device);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nkfree(accel_dev->hw_device);\r\n}\r\nadf_cfg_dev_remove(accel_dev);\r\ndebugfs_remove(accel_dev->debugfs_dir);\r\nadf_devmgr_rm_dev(accel_dev);\r\npci_release_regions(accel_pci_dev->pci_dev);\r\npci_disable_device(accel_pci_dev->pci_dev);\r\nkfree(accel_dev);\r\n}\r\nstatic int qat_dev_start(struct adf_accel_dev *accel_dev)\r\n{\r\nint cpus = num_online_cpus();\r\nint banks = GET_MAX_BANKS(accel_dev);\r\nint instances = min(cpus, banks);\r\nchar key[ADF_CFG_MAX_KEY_LEN_IN_BYTES];\r\nint i;\r\nunsigned long val;\r\nif (adf_cfg_section_add(accel_dev, ADF_KERNEL_SEC))\r\ngoto err;\r\nif (adf_cfg_section_add(accel_dev, "Accelerator0"))\r\ngoto err;\r\nfor (i = 0; i < instances; i++) {\r\nval = i;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_BANK_NUM, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_ETRMGR_CORE_AFFINITY,\r\ni);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_ASYM_SIZE, i);\r\nval = 128;\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 512;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_SYM_SIZE, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 0;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_ASYM_TX, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 2;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_SYM_TX, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 4;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_RND_TX, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 8;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_ASYM_RX, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 10;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_SYM_RX, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = 12;\r\nsnprintf(key, sizeof(key), ADF_CY "%d" ADF_RING_RND_RX, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\nval = ADF_COALESCING_DEF_TIME;\r\nsnprintf(key, sizeof(key), ADF_ETRMGR_COALESCE_TIMER_FORMAT, i);\r\nif (adf_cfg_add_key_value_param(accel_dev, "Accelerator0",\r\nkey, (void *)&val, ADF_DEC))\r\ngoto err;\r\n}\r\nval = i;\r\nif (adf_cfg_add_key_value_param(accel_dev, ADF_KERNEL_SEC,\r\nADF_NUM_CY, (void *)&val, ADF_DEC))\r\ngoto err;\r\nset_bit(ADF_STATUS_CONFIGURED, &accel_dev->status);\r\nreturn adf_dev_start(accel_dev);\r\nerr:\r\ndev_err(&GET_DEV(accel_dev), "Failed to start QAT accel dev\n");\r\nreturn -EINVAL;\r\n}\r\nstatic int adf_probe(struct pci_dev *pdev, const struct pci_device_id *ent)\r\n{\r\nstruct adf_accel_dev *accel_dev;\r\nstruct adf_accel_pci *accel_pci_dev;\r\nstruct adf_hw_device_data *hw_data;\r\nvoid __iomem *pmisc_bar_addr = NULL;\r\nchar name[ADF_DEVICE_NAME_LENGTH];\r\nunsigned int i, bar_nr;\r\nint ret;\r\nswitch (ent->device) {\r\ncase ADF_DH895XCC_PCI_DEVICE_ID:\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "Invalid device 0x%x.\n", ent->device);\r\nreturn -ENODEV;\r\n}\r\nif (num_possible_nodes() > 1 && dev_to_node(&pdev->dev) < 0) {\r\ndev_err(&pdev->dev, "Invalid NUMA configuration.\n");\r\nreturn -EINVAL;\r\n}\r\naccel_dev = kzalloc_node(sizeof(*accel_dev), GFP_KERNEL,\r\ndev_to_node(&pdev->dev));\r\nif (!accel_dev)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&accel_dev->crypto_list);\r\nif (adf_devmgr_add_dev(accel_dev)) {\r\ndev_err(&pdev->dev, "Failed to add new accelerator device.\n");\r\nkfree(accel_dev);\r\nreturn -EFAULT;\r\n}\r\naccel_dev->owner = THIS_MODULE;\r\nhw_data = kzalloc_node(sizeof(*hw_data), GFP_KERNEL,\r\ndev_to_node(&pdev->dev));\r\nif (!hw_data) {\r\nret = -ENOMEM;\r\ngoto out_err;\r\n}\r\naccel_dev->hw_device = hw_data;\r\nswitch (ent->device) {\r\ncase ADF_DH895XCC_PCI_DEVICE_ID:\r\nadf_init_hw_data_dh895xcc(accel_dev->hw_device);\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\naccel_pci_dev = &accel_dev->accel_pci_dev;\r\npci_read_config_byte(pdev, PCI_REVISION_ID, &accel_pci_dev->revid);\r\npci_read_config_dword(pdev, ADF_DH895XCC_FUSECTL_OFFSET,\r\n&hw_data->fuses);\r\nhw_data->accel_mask = hw_data->get_accel_mask(hw_data->fuses);\r\nhw_data->ae_mask = hw_data->get_ae_mask(hw_data->fuses);\r\naccel_pci_dev->sku = hw_data->get_sku(hw_data);\r\naccel_pci_dev->pci_dev = pdev;\r\nif (!hw_data->accel_mask || !hw_data->ae_mask ||\r\n((~hw_data->ae_mask) & 0x01)) {\r\ndev_err(&pdev->dev, "No acceleration units found");\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nsnprintf(name, sizeof(name), "%s%s_dev%d", ADF_DEVICE_NAME_PREFIX,\r\nhw_data->dev_class->name, hw_data->instance_id);\r\naccel_dev->debugfs_dir = debugfs_create_dir(name, NULL);\r\nif (!accel_dev->debugfs_dir) {\r\ndev_err(&pdev->dev, "Could not create debugfs dir\n");\r\nret = -EINVAL;\r\ngoto out_err;\r\n}\r\nret = adf_cfg_dev_add(accel_dev);\r\nif (ret)\r\ngoto out_err;\r\nif (pci_enable_device(pdev)) {\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (pci_set_dma_mask(pdev, DMA_BIT_MASK(64))) {\r\nif ((pci_set_dma_mask(pdev, DMA_BIT_MASK(32)))) {\r\ndev_err(&pdev->dev, "No usable DMA configuration\n");\r\nret = -EFAULT;\r\ngoto out_err;\r\n} else {\r\npci_set_consistent_dma_mask(pdev, DMA_BIT_MASK(32));\r\n}\r\n} else {\r\npci_set_consistent_dma_mask(pdev, DMA_BIT_MASK(64));\r\n}\r\nif (pci_request_regions(pdev, adf_driver_name)) {\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\npci_read_config_dword(pdev, ADF_DH895XCC_LEGFUSE_OFFSET,\r\n&hw_data->accel_capabilities_mask);\r\nfor (i = 0; i < ADF_PCI_MAX_BARS; i++) {\r\nstruct adf_bar *bar = &accel_pci_dev->pci_bars[i];\r\nbar_nr = i * 2;\r\nbar->base_addr = pci_resource_start(pdev, bar_nr);\r\nif (!bar->base_addr)\r\nbreak;\r\nbar->size = pci_resource_len(pdev, bar_nr);\r\nbar->virt_addr = pci_iomap(accel_pci_dev->pci_dev, bar_nr, 0);\r\nif (!bar->virt_addr) {\r\ndev_err(&pdev->dev, "Failed to map BAR %d\n", i);\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (i == ADF_DH895XCC_PMISC_BAR)\r\npmisc_bar_addr = bar->virt_addr;\r\n}\r\npci_set_master(pdev);\r\nif (adf_enable_aer(accel_dev, &adf_driver)) {\r\ndev_err(&pdev->dev, "Failed to enable aer\n");\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (adf_init_etr_data(accel_dev)) {\r\ndev_err(&pdev->dev, "Failed initialize etr\n");\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (adf_init_admin_comms(accel_dev)) {\r\ndev_err(&pdev->dev, "Failed initialize admin comms\n");\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (adf_init_arb(accel_dev)) {\r\ndev_err(&pdev->dev, "Failed initialize hw arbiter\n");\r\nret = -EFAULT;\r\ngoto out_err;\r\n}\r\nif (pci_save_state(pdev)) {\r\ndev_err(&pdev->dev, "Failed to save pci state\n");\r\nret = -ENOMEM;\r\ngoto out_err;\r\n}\r\nADF_CSR_WR(pmisc_bar_addr, ADF_DH895XCC_SMIAPF0_MASK_OFFSET,\r\nADF_DH895XCC_SMIA0_MASK);\r\nADF_CSR_WR(pmisc_bar_addr, ADF_DH895XCC_SMIAPF1_MASK_OFFSET,\r\nADF_DH895XCC_SMIA1_MASK);\r\nret = qat_dev_start(accel_dev);\r\nif (ret) {\r\nadf_dev_stop(accel_dev);\r\ngoto out_err;\r\n}\r\nreturn 0;\r\nout_err:\r\nadf_cleanup_accel(accel_dev);\r\nreturn ret;\r\n}\r\nstatic void __exit adf_remove(struct pci_dev *pdev)\r\n{\r\nstruct adf_accel_dev *accel_dev = adf_devmgr_pci_to_accel_dev(pdev);\r\nif (!accel_dev) {\r\npr_err("QAT: Driver removal failed\n");\r\nreturn;\r\n}\r\nif (adf_dev_stop(accel_dev))\r\ndev_err(&GET_DEV(accel_dev), "Failed to stop QAT accel dev\n");\r\nadf_disable_aer(accel_dev);\r\nadf_cleanup_accel(accel_dev);\r\n}\r\nstatic int __init adfdrv_init(void)\r\n{\r\nrequest_module("intel_qat");\r\nif (qat_admin_register())\r\nreturn -EFAULT;\r\nif (pci_register_driver(&adf_driver)) {\r\npr_err("QAT: Driver initialization failed\n");\r\nreturn -EFAULT;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit adfdrv_release(void)\r\n{\r\npci_unregister_driver(&adf_driver);\r\nqat_admin_unregister();\r\n}

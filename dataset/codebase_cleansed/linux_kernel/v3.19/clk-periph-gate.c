static int clk_periph_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph_gate *gate = to_clk_periph_gate(hw);\r\nint state = 1;\r\nif (!(read_enb(gate) & periph_clk_to_bit(gate)))\r\nstate = 0;\r\nif (!(gate->flags & TEGRA_PERIPH_NO_RESET))\r\nif (read_rst(gate) & periph_clk_to_bit(gate))\r\nstate = 0;\r\nreturn state;\r\n}\r\nstatic int clk_periph_enable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph_gate *gate = to_clk_periph_gate(hw);\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&periph_ref_lock, flags);\r\ngate->enable_refcnt[gate->clk_num]++;\r\nif (gate->enable_refcnt[gate->clk_num] > 1) {\r\nspin_unlock_irqrestore(&periph_ref_lock, flags);\r\nreturn 0;\r\n}\r\nwrite_enb_set(periph_clk_to_bit(gate), gate);\r\nudelay(2);\r\nif (!(gate->flags & TEGRA_PERIPH_NO_RESET) &&\r\n!(gate->flags & TEGRA_PERIPH_MANUAL_RESET)) {\r\nif (read_rst(gate) & periph_clk_to_bit(gate)) {\r\nudelay(5);\r\nwrite_rst_clr(periph_clk_to_bit(gate), gate);\r\n}\r\n}\r\nif (gate->flags & TEGRA_PERIPH_WAR_1005168) {\r\nwritel_relaxed(0, gate->clk_base + LVL2_CLK_GATE_OVRE);\r\nwritel_relaxed(BIT(22), gate->clk_base + LVL2_CLK_GATE_OVRE);\r\nudelay(1);\r\nwritel_relaxed(0, gate->clk_base + LVL2_CLK_GATE_OVRE);\r\n}\r\nspin_unlock_irqrestore(&periph_ref_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void clk_periph_disable(struct clk_hw *hw)\r\n{\r\nstruct tegra_clk_periph_gate *gate = to_clk_periph_gate(hw);\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&periph_ref_lock, flags);\r\ngate->enable_refcnt[gate->clk_num]--;\r\nif (gate->enable_refcnt[gate->clk_num] > 0) {\r\nspin_unlock_irqrestore(&periph_ref_lock, flags);\r\nreturn;\r\n}\r\nif (gate->flags & TEGRA_PERIPH_ON_APB)\r\ntegra_read_chipid();\r\nwrite_enb_clr(periph_clk_to_bit(gate), gate);\r\nspin_unlock_irqrestore(&periph_ref_lock, flags);\r\n}\r\nstruct clk *tegra_clk_register_periph_gate(const char *name,\r\nconst char *parent_name, u8 gate_flags, void __iomem *clk_base,\r\nunsigned long flags, int clk_num, int *enable_refcnt)\r\n{\r\nstruct tegra_clk_periph_gate *gate;\r\nstruct clk *clk;\r\nstruct clk_init_data init;\r\nstruct tegra_clk_periph_regs *pregs;\r\npregs = get_reg_bank(clk_num);\r\nif (!pregs)\r\nreturn ERR_PTR(-EINVAL);\r\ngate = kzalloc(sizeof(*gate), GFP_KERNEL);\r\nif (!gate) {\r\npr_err("%s: could not allocate periph gate clk\n", __func__);\r\nreturn ERR_PTR(-ENOMEM);\r\n}\r\ninit.name = name;\r\ninit.flags = flags;\r\ninit.parent_names = parent_name ? &parent_name : NULL;\r\ninit.num_parents = parent_name ? 1 : 0;\r\ninit.ops = &tegra_clk_periph_gate_ops;\r\ngate->magic = TEGRA_CLK_PERIPH_GATE_MAGIC;\r\ngate->clk_base = clk_base;\r\ngate->clk_num = clk_num;\r\ngate->flags = gate_flags;\r\ngate->enable_refcnt = enable_refcnt;\r\ngate->regs = pregs;\r\ngate->hw.init = &init;\r\nclk = clk_register(NULL, &gate->hw);\r\nif (IS_ERR(clk))\r\nkfree(gate);\r\nreturn clk;\r\n}

static int cw1200_spi_memcpy_fromio(struct hwbus_priv *self,\r\nunsigned int addr,\r\nvoid *dst, int count)\r\n{\r\nint ret, i;\r\nu16 regaddr;\r\nstruct spi_message m;\r\nstruct spi_transfer t_addr = {\r\n.tx_buf = &regaddr,\r\n.len = sizeof(regaddr),\r\n};\r\nstruct spi_transfer t_msg = {\r\n.rx_buf = dst,\r\n.len = count,\r\n};\r\nregaddr = (SDIO_TO_SPI_ADDR(addr))<<12;\r\nregaddr |= SET_READ;\r\nregaddr |= (count>>1);\r\n#ifdef SPI_DEBUG\r\npr_info("READ : %04d from 0x%02x (%04x)\n", count, addr, regaddr);\r\n#endif\r\nregaddr = cpu_to_le16(regaddr);\r\n#if defined(__LITTLE_ENDIAN)\r\nif (self->func->bits_per_word == 8)\r\n#endif\r\nregaddr = swab16(regaddr);\r\nspi_message_init(&m);\r\nspi_message_add_tail(&t_addr, &m);\r\nspi_message_add_tail(&t_msg, &m);\r\nret = spi_sync(self->func, &m);\r\n#ifdef SPI_DEBUG\r\npr_info("READ : ");\r\nfor (i = 0; i < t_addr.len; i++)\r\nprintk("%02x ", ((u8 *)t_addr.tx_buf)[i]);\r\nprintk(" : ");\r\nfor (i = 0; i < t_msg.len; i++)\r\nprintk("%02x ", ((u8 *)t_msg.rx_buf)[i]);\r\nprintk("\n");\r\n#endif\r\n#if defined(__LITTLE_ENDIAN)\r\nif (self->func->bits_per_word == 8)\r\n#endif\r\n{\r\nuint16_t *buf = (uint16_t *)dst;\r\nfor (i = 0; i < ((count + 1) >> 1); i++)\r\nbuf[i] = swab16(buf[i]);\r\n}\r\nreturn ret;\r\n}\r\nstatic int cw1200_spi_memcpy_toio(struct hwbus_priv *self,\r\nunsigned int addr,\r\nconst void *src, int count)\r\n{\r\nint rval, i;\r\nu16 regaddr;\r\nstruct spi_transfer t_addr = {\r\n.tx_buf = &regaddr,\r\n.len = sizeof(regaddr),\r\n};\r\nstruct spi_transfer t_msg = {\r\n.tx_buf = src,\r\n.len = count,\r\n};\r\nstruct spi_message m;\r\nregaddr = (SDIO_TO_SPI_ADDR(addr))<<12;\r\nregaddr &= SET_WRITE;\r\nregaddr |= (count>>1);\r\n#ifdef SPI_DEBUG\r\npr_info("WRITE: %04d to 0x%02x (%04x)\n", count, addr, regaddr);\r\n#endif\r\nregaddr = cpu_to_le16(regaddr);\r\n#if defined(__LITTLE_ENDIAN)\r\nif (self->func->bits_per_word == 8)\r\n#endif\r\n{\r\nuint16_t *buf = (uint16_t *)src;\r\nregaddr = swab16(regaddr);\r\nfor (i = 0; i < ((count + 1) >> 1); i++)\r\nbuf[i] = swab16(buf[i]);\r\n}\r\n#ifdef SPI_DEBUG\r\npr_info("WRITE: ");\r\nfor (i = 0; i < t_addr.len; i++)\r\nprintk("%02x ", ((u8 *)t_addr.tx_buf)[i]);\r\nprintk(" : ");\r\nfor (i = 0; i < t_msg.len; i++)\r\nprintk("%02x ", ((u8 *)t_msg.tx_buf)[i]);\r\nprintk("\n");\r\n#endif\r\nspi_message_init(&m);\r\nspi_message_add_tail(&t_addr, &m);\r\nspi_message_add_tail(&t_msg, &m);\r\nrval = spi_sync(self->func, &m);\r\n#ifdef SPI_DEBUG\r\npr_info("WROTE: %d\n", m.actual_length);\r\n#endif\r\n#if defined(__LITTLE_ENDIAN)\r\nif (self->func->bits_per_word == 8)\r\n#endif\r\n{\r\nuint16_t *buf = (uint16_t *)src;\r\nfor (i = 0; i < ((count + 1) >> 1); i++)\r\nbuf[i] = swab16(buf[i]);\r\n}\r\nreturn rval;\r\n}\r\nstatic void cw1200_spi_lock(struct hwbus_priv *self)\r\n{\r\nunsigned long flags;\r\nDECLARE_WAITQUEUE(wait, current);\r\nmight_sleep();\r\nadd_wait_queue(&self->wq, &wait);\r\nspin_lock_irqsave(&self->lock, flags);\r\nwhile (1) {\r\nset_current_state(TASK_UNINTERRUPTIBLE);\r\nif (!self->claimed)\r\nbreak;\r\nspin_unlock_irqrestore(&self->lock, flags);\r\nschedule();\r\nspin_lock_irqsave(&self->lock, flags);\r\n}\r\nset_current_state(TASK_RUNNING);\r\nself->claimed = 1;\r\nspin_unlock_irqrestore(&self->lock, flags);\r\nremove_wait_queue(&self->wq, &wait);\r\nreturn;\r\n}\r\nstatic void cw1200_spi_unlock(struct hwbus_priv *self)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&self->lock, flags);\r\nself->claimed = 0;\r\nspin_unlock_irqrestore(&self->lock, flags);\r\nwake_up(&self->wq);\r\nreturn;\r\n}\r\nstatic irqreturn_t cw1200_spi_irq_handler(int irq, void *dev_id)\r\n{\r\nstruct hwbus_priv *self = dev_id;\r\nif (self->core) {\r\ncw1200_spi_lock(self);\r\ncw1200_irq_handler(self->core);\r\ncw1200_spi_unlock(self);\r\nreturn IRQ_HANDLED;\r\n} else {\r\nreturn IRQ_NONE;\r\n}\r\n}\r\nstatic int cw1200_spi_irq_subscribe(struct hwbus_priv *self)\r\n{\r\nint ret;\r\npr_debug("SW IRQ subscribe\n");\r\nret = request_threaded_irq(self->func->irq, NULL,\r\ncw1200_spi_irq_handler,\r\nIRQF_TRIGGER_HIGH | IRQF_ONESHOT,\r\n"cw1200_wlan_irq", self);\r\nif (WARN_ON(ret < 0))\r\ngoto exit;\r\nret = enable_irq_wake(self->func->irq);\r\nif (WARN_ON(ret))\r\ngoto free_irq;\r\nreturn 0;\r\nfree_irq:\r\nfree_irq(self->func->irq, self);\r\nexit:\r\nreturn ret;\r\n}\r\nstatic int cw1200_spi_irq_unsubscribe(struct hwbus_priv *self)\r\n{\r\nint ret = 0;\r\npr_debug("SW IRQ unsubscribe\n");\r\ndisable_irq_wake(self->func->irq);\r\nfree_irq(self->func->irq, self);\r\nreturn ret;\r\n}\r\nstatic int cw1200_spi_off(const struct cw1200_platform_data_spi *pdata)\r\n{\r\nif (pdata->reset) {\r\ngpio_set_value(pdata->reset, 0);\r\nmsleep(30);\r\ngpio_free(pdata->reset);\r\n}\r\nif (pdata->power_ctrl)\r\npdata->power_ctrl(pdata, false);\r\nif (pdata->clk_ctrl)\r\npdata->clk_ctrl(pdata, false);\r\nreturn 0;\r\n}\r\nstatic int cw1200_spi_on(const struct cw1200_platform_data_spi *pdata)\r\n{\r\nif (pdata->reset) {\r\ngpio_request(pdata->reset, "cw1200_wlan_reset");\r\ngpio_direction_output(pdata->reset, 0);\r\n}\r\nif (pdata->powerup) {\r\ngpio_request(pdata->powerup, "cw1200_wlan_powerup");\r\ngpio_direction_output(pdata->powerup, 0);\r\n}\r\nif (pdata->reset || pdata->powerup)\r\nmsleep(10);\r\nif (pdata->power_ctrl) {\r\nif (pdata->power_ctrl(pdata, true)) {\r\npr_err("power_ctrl() failed!\n");\r\nreturn -1;\r\n}\r\n}\r\nif (pdata->clk_ctrl) {\r\nif (pdata->clk_ctrl(pdata, true)) {\r\npr_err("clk_ctrl() failed!\n");\r\nreturn -1;\r\n}\r\nmsleep(10);\r\n}\r\nif (pdata->powerup) {\r\ngpio_set_value(pdata->powerup, 1);\r\nmsleep(250);\r\n}\r\nif (pdata->reset) {\r\ngpio_set_value(pdata->reset, 1);\r\nmsleep(50);\r\n}\r\nreturn 0;\r\n}\r\nstatic size_t cw1200_spi_align_size(struct hwbus_priv *self, size_t size)\r\n{\r\nreturn size & 1 ? size + 1 : size;\r\n}\r\nstatic int cw1200_spi_pm(struct hwbus_priv *self, bool suspend)\r\n{\r\nreturn irq_set_irq_wake(self->func->irq, suspend);\r\n}\r\nstatic int cw1200_spi_probe(struct spi_device *func)\r\n{\r\nconst struct cw1200_platform_data_spi *plat_data =\r\ndev_get_platdata(&func->dev);\r\nstruct hwbus_priv *self;\r\nint status;\r\nif (func->max_speed_hz > 52000000)\r\nfunc->max_speed_hz = 52000000;\r\nif (func->max_speed_hz < 1000000)\r\nfunc->max_speed_hz = 1000000;\r\nif (plat_data->spi_bits_per_word)\r\nfunc->bits_per_word = plat_data->spi_bits_per_word;\r\nif (!func->bits_per_word)\r\nfunc->bits_per_word = 16;\r\nfunc->mode = SPI_MODE_0;\r\npr_info("cw1200_wlan_spi: Probe called (CS %d M %d BPW %d CLK %d)\n",\r\nfunc->chip_select, func->mode, func->bits_per_word,\r\nfunc->max_speed_hz);\r\nif (cw1200_spi_on(plat_data)) {\r\npr_err("spi_on() failed!\n");\r\nreturn -1;\r\n}\r\nif (spi_setup(func)) {\r\npr_err("spi_setup() failed!\n");\r\nreturn -1;\r\n}\r\nself = devm_kzalloc(&func->dev, sizeof(*self), GFP_KERNEL);\r\nif (!self) {\r\npr_err("Can't allocate SPI hwbus_priv.");\r\nreturn -ENOMEM;\r\n}\r\nself->pdata = plat_data;\r\nself->func = func;\r\nspin_lock_init(&self->lock);\r\nspi_set_drvdata(func, self);\r\ninit_waitqueue_head(&self->wq);\r\nstatus = cw1200_spi_irq_subscribe(self);\r\nstatus = cw1200_core_probe(&cw1200_spi_hwbus_ops,\r\nself, &func->dev, &self->core,\r\nself->pdata->ref_clk,\r\nself->pdata->macaddr,\r\nself->pdata->sdd_file,\r\nself->pdata->have_5ghz);\r\nif (status) {\r\ncw1200_spi_irq_unsubscribe(self);\r\ncw1200_spi_off(plat_data);\r\n}\r\nreturn status;\r\n}\r\nstatic int cw1200_spi_disconnect(struct spi_device *func)\r\n{\r\nstruct hwbus_priv *self = spi_get_drvdata(func);\r\nif (self) {\r\ncw1200_spi_irq_unsubscribe(self);\r\nif (self->core) {\r\ncw1200_core_release(self->core);\r\nself->core = NULL;\r\n}\r\n}\r\ncw1200_spi_off(dev_get_platdata(&func->dev));\r\nreturn 0;\r\n}\r\nstatic int cw1200_spi_suspend(struct device *dev, pm_message_t state)\r\n{\r\nstruct hwbus_priv *self = spi_get_drvdata(to_spi_device(dev));\r\nif (!cw1200_can_suspend(self->core))\r\nreturn -EAGAIN;\r\nreturn 0;\r\n}\r\nstatic int cw1200_spi_resume(struct device *dev)\r\n{\r\nreturn 0;\r\n}

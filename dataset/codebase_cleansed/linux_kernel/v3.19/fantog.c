static void\r\nnouveau_fantog_update(struct nouveau_fantog_priv *priv, int percent)\r\n{\r\nstruct nouveau_therm_priv *tpriv = (void *)priv->base.parent;\r\nstruct nouveau_timer *ptimer = nouveau_timer(tpriv);\r\nstruct nouveau_gpio *gpio = nouveau_gpio(tpriv);\r\nunsigned long flags;\r\nint duty;\r\nspin_lock_irqsave(&priv->lock, flags);\r\nif (percent < 0)\r\npercent = priv->percent;\r\npriv->percent = percent;\r\nduty = !gpio->get(gpio, 0, DCB_GPIO_FAN, 0xff);\r\ngpio->set(gpio, 0, DCB_GPIO_FAN, 0xff, duty);\r\nif (list_empty(&priv->alarm.head) && percent != (duty * 100)) {\r\nu64 next_change = (percent * priv->period_us) / 100;\r\nif (!duty)\r\nnext_change = priv->period_us - next_change;\r\nptimer->alarm(ptimer, next_change * 1000, &priv->alarm);\r\n}\r\nspin_unlock_irqrestore(&priv->lock, flags);\r\n}\r\nstatic void\r\nnouveau_fantog_alarm(struct nouveau_alarm *alarm)\r\n{\r\nstruct nouveau_fantog_priv *priv =\r\ncontainer_of(alarm, struct nouveau_fantog_priv, alarm);\r\nnouveau_fantog_update(priv, -1);\r\n}\r\nstatic int\r\nnouveau_fantog_get(struct nouveau_therm *therm)\r\n{\r\nstruct nouveau_therm_priv *tpriv = (void *)therm;\r\nstruct nouveau_fantog_priv *priv = (void *)tpriv->fan;\r\nreturn priv->percent;\r\n}\r\nstatic int\r\nnouveau_fantog_set(struct nouveau_therm *therm, int percent)\r\n{\r\nstruct nouveau_therm_priv *tpriv = (void *)therm;\r\nstruct nouveau_fantog_priv *priv = (void *)tpriv->fan;\r\nif (therm->pwm_ctrl)\r\ntherm->pwm_ctrl(therm, priv->func.line, false);\r\nnouveau_fantog_update(priv, percent);\r\nreturn 0;\r\n}\r\nint\r\nnouveau_fantog_create(struct nouveau_therm *therm, struct dcb_gpio_func *func)\r\n{\r\nstruct nouveau_therm_priv *tpriv = (void *)therm;\r\nstruct nouveau_fantog_priv *priv;\r\nint ret;\r\nif (therm->pwm_ctrl) {\r\nret = therm->pwm_ctrl(therm, func->line, false);\r\nif (ret)\r\nreturn ret;\r\n}\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\ntpriv->fan = &priv->base;\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->base.type = "toggle";\r\npriv->base.get = nouveau_fantog_get;\r\npriv->base.set = nouveau_fantog_set;\r\nnouveau_alarm_init(&priv->alarm, nouveau_fantog_alarm);\r\npriv->period_us = 100000;\r\npriv->percent = 100;\r\npriv->func = *func;\r\nspin_lock_init(&priv->lock);\r\nreturn 0;\r\n}

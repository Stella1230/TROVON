static int do_mod_firmware_load(const char *fn, char **fp)\r\n{\r\nstruct file* filp;\r\nlong l;\r\nchar *dp;\r\nloff_t pos;\r\nfilp = filp_open(fn, 0, 0);\r\nif (IS_ERR(filp))\r\n{\r\nprintk(KERN_INFO "Unable to load '%s'.\n", fn);\r\nreturn 0;\r\n}\r\nl = i_size_read(file_inode(filp));\r\nif (l <= 0 || l > 131072)\r\n{\r\nprintk(KERN_INFO "Invalid firmware '%s'\n", fn);\r\nfput(filp);\r\nreturn 0;\r\n}\r\ndp = vmalloc(l);\r\nif (dp == NULL)\r\n{\r\nprintk(KERN_INFO "Out of memory loading '%s'.\n", fn);\r\nfput(filp);\r\nreturn 0;\r\n}\r\npos = 0;\r\nif (vfs_read(filp, dp, l, &pos) != l)\r\n{\r\nprintk(KERN_INFO "Failed to read '%s'.\n", fn);\r\nvfree(dp);\r\nfput(filp);\r\nreturn 0;\r\n}\r\nfput(filp);\r\n*fp = dp;\r\nreturn (int) l;\r\n}\r\nint mod_firmware_load(const char *fn, char **fp)\r\n{\r\nint r;\r\nmm_segment_t fs = get_fs();\r\nset_fs(get_ds());\r\nr = do_mod_firmware_load(fn, fp);\r\nset_fs(fs);\r\nreturn r;\r\n}

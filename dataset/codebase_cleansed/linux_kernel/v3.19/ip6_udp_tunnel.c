int udp_sock_create6(struct net *net, struct udp_port_cfg *cfg,\r\nstruct socket **sockp)\r\n{\r\nstruct sockaddr_in6 udp6_addr;\r\nint err;\r\nstruct socket *sock = NULL;\r\nerr = sock_create_kern(AF_INET6, SOCK_DGRAM, 0, &sock);\r\nif (err < 0)\r\ngoto error;\r\nsk_change_net(sock->sk, net);\r\nudp6_addr.sin6_family = AF_INET6;\r\nmemcpy(&udp6_addr.sin6_addr, &cfg->local_ip6,\r\nsizeof(udp6_addr.sin6_addr));\r\nudp6_addr.sin6_port = cfg->local_udp_port;\r\nerr = kernel_bind(sock, (struct sockaddr *)&udp6_addr,\r\nsizeof(udp6_addr));\r\nif (err < 0)\r\ngoto error;\r\nif (cfg->peer_udp_port) {\r\nudp6_addr.sin6_family = AF_INET6;\r\nmemcpy(&udp6_addr.sin6_addr, &cfg->peer_ip6,\r\nsizeof(udp6_addr.sin6_addr));\r\nudp6_addr.sin6_port = cfg->peer_udp_port;\r\nerr = kernel_connect(sock,\r\n(struct sockaddr *)&udp6_addr,\r\nsizeof(udp6_addr), 0);\r\n}\r\nif (err < 0)\r\ngoto error;\r\nudp_set_no_check6_tx(sock->sk, !cfg->use_udp6_tx_checksums);\r\nudp_set_no_check6_rx(sock->sk, !cfg->use_udp6_rx_checksums);\r\n*sockp = sock;\r\nreturn 0;\r\nerror:\r\nif (sock) {\r\nkernel_sock_shutdown(sock, SHUT_RDWR);\r\nsk_release_kernel(sock->sk);\r\n}\r\n*sockp = NULL;\r\nreturn err;\r\n}\r\nint udp_tunnel6_xmit_skb(struct socket *sock, struct dst_entry *dst,\r\nstruct sk_buff *skb, struct net_device *dev,\r\nstruct in6_addr *saddr, struct in6_addr *daddr,\r\n__u8 prio, __u8 ttl, __be16 src_port, __be16 dst_port)\r\n{\r\nstruct udphdr *uh;\r\nstruct ipv6hdr *ip6h;\r\nstruct sock *sk = sock->sk;\r\n__skb_push(skb, sizeof(*uh));\r\nskb_reset_transport_header(skb);\r\nuh = udp_hdr(skb);\r\nuh->dest = dst_port;\r\nuh->source = src_port;\r\nuh->len = htons(skb->len);\r\nmemset(&(IPCB(skb)->opt), 0, sizeof(IPCB(skb)->opt));\r\nIPCB(skb)->flags &= ~(IPSKB_XFRM_TUNNEL_SIZE | IPSKB_XFRM_TRANSFORMED\r\n| IPSKB_REROUTED);\r\nskb_dst_set(skb, dst);\r\nudp6_set_csum(udp_get_no_check6_tx(sk), skb, saddr, daddr, skb->len);\r\n__skb_push(skb, sizeof(*ip6h));\r\nskb_reset_network_header(skb);\r\nip6h = ipv6_hdr(skb);\r\nip6_flow_hdr(ip6h, prio, htonl(0));\r\nip6h->payload_len = htons(skb->len);\r\nip6h->nexthdr = IPPROTO_UDP;\r\nip6h->hop_limit = ttl;\r\nip6h->daddr = *daddr;\r\nip6h->saddr = *saddr;\r\nip6tunnel_xmit(skb, dev);\r\nreturn 0;\r\n}

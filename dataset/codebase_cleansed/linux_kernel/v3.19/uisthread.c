int\r\nuisthread_start(struct uisthread_info *thrinfo,\r\nint (*threadfn)(void *), void *thrcontext, char *name)\r\n{\r\nthrinfo->should_stop = 0;\r\ninit_completion(&thrinfo->has_stopped);\r\nthrinfo->task = kthread_create(threadfn, thrcontext, name, NULL);\r\nif (IS_ERR(thrinfo->task)) {\r\nthrinfo->id = 0;\r\nreturn 0;\r\n}\r\nthrinfo->id = thrinfo->task->pid;\r\nwake_up_process(thrinfo->task);\r\nLOGINF("started thread pid:%d\n", thrinfo->id);\r\nreturn 1;\r\n}\r\nvoid\r\nuisthread_stop(struct uisthread_info *thrinfo)\r\n{\r\nint ret;\r\nint stopped = 0;\r\nif (thrinfo->id == 0)\r\nreturn;\r\nLOGINF("uisthread_stop stopping id:%d\n", thrinfo->id);\r\nthrinfo->should_stop = 1;\r\nret = KILL(thrinfo->id, SIGHUP, 1);\r\nif (ret) {\r\nLOGERR("unable to signal thread %d\n", ret);\r\n} else {\r\nif (wait_for_completion_timeout(&thrinfo->has_stopped, 60 * HZ))\r\nstopped = 1;\r\nelse\r\nLOGERR("timed out trying to signal thread\n");\r\n}\r\nif (stopped) {\r\nLOGINF("uisthread_stop stopped id:%d\n", thrinfo->id);\r\nthrinfo->id = 0;\r\n}\r\n}

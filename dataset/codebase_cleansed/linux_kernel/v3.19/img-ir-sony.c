static int img_ir_sony_scancode(int len, u64 raw, enum rc_type *protocol,\r\nu32 *scancode, u64 enabled_protocols)\r\n{\r\nunsigned int dev, subdev, func;\r\nswitch (len) {\r\ncase 12:\r\nif (!(enabled_protocols & RC_BIT_SONY12))\r\nreturn -EINVAL;\r\nfunc = raw & 0x7f;\r\nraw >>= 7;\r\ndev = raw & 0x1f;\r\nsubdev = 0;\r\n*protocol = RC_TYPE_SONY12;\r\nbreak;\r\ncase 15:\r\nif (!(enabled_protocols & RC_BIT_SONY15))\r\nreturn -EINVAL;\r\nfunc = raw & 0x7f;\r\nraw >>= 7;\r\ndev = raw & 0xff;\r\nsubdev = 0;\r\n*protocol = RC_TYPE_SONY15;\r\nbreak;\r\ncase 20:\r\nif (!(enabled_protocols & RC_BIT_SONY20))\r\nreturn -EINVAL;\r\nfunc = raw & 0x7f;\r\nraw >>= 7;\r\ndev = raw & 0x1f;\r\nraw >>= 5;\r\nsubdev = raw & 0xff;\r\n*protocol = RC_TYPE_SONY20;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n*scancode = dev << 16 | subdev << 8 | func;\r\nreturn IMG_IR_SCANCODE;\r\n}\r\nstatic int img_ir_sony_filter(const struct rc_scancode_filter *in,\r\nstruct img_ir_filter *out, u64 protocols)\r\n{\r\nunsigned int dev, subdev, func;\r\nunsigned int dev_m, subdev_m, func_m;\r\nunsigned int len = 0;\r\ndev = (in->data >> 16) & 0xff;\r\ndev_m = (in->mask >> 16) & 0xff;\r\nsubdev = (in->data >> 8) & 0xff;\r\nsubdev_m = (in->mask >> 8) & 0xff;\r\nfunc = (in->data >> 0) & 0x7f;\r\nfunc_m = (in->mask >> 0) & 0x7f;\r\nif (subdev & subdev_m) {\r\nif (dev & dev_m & 0xe0)\r\nreturn -EINVAL;\r\nif (!(protocols & RC_BIT_SONY20))\r\nreturn -EINVAL;\r\nlen = 20;\r\ndev_m &= 0x1f;\r\n} else if (dev & dev_m & 0xe0) {\r\nif (!(protocols & RC_BIT_SONY15))\r\nreturn -EINVAL;\r\nlen = 15;\r\nsubdev_m = 0;\r\n} else {\r\nsubdev_m &= (dev_m >> 5) | 0xf8;\r\ndev_m &= 0x1f;\r\n}\r\ndev &= dev_m;\r\nsubdev &= subdev_m;\r\nout->data = func |\r\ndev << 7 |\r\nsubdev << 15;\r\nout->mask = func_m |\r\ndev_m << 7 |\r\nsubdev_m << 15;\r\nif (len) {\r\nout->minlen = len;\r\nout->maxlen = len;\r\n}\r\nreturn 0;\r\n}

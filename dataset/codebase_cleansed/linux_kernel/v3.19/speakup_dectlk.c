static inline int synth_full(void)\r\n{\r\nreturn xoff;\r\n}\r\nstatic int is_indnum(u_char *ch)\r\n{\r\nif ((*ch >= '0') && (*ch <= '9')) {\r\n*ch = *ch - '0';\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned char get_index(void)\r\n{\r\nu_char rv;\r\nrv = lastind;\r\nlastind = 0;\r\nreturn rv;\r\n}\r\nstatic void read_buff_add(u_char c)\r\n{\r\nstatic int ind = -1;\r\nif (c == 0x01) {\r\nunsigned long flags;\r\nspin_lock_irqsave(&flush_lock, flags);\r\nis_flushing = 0;\r\nwake_up_interruptible(&flush);\r\nspin_unlock_irqrestore(&flush_lock, flags);\r\n} else if (c == 0x13) {\r\nxoff = 1;\r\n} else if (c == 0x11) {\r\nxoff = 0;\r\n} else if (is_indnum(&c)) {\r\nif (ind == -1)\r\nind = c;\r\nelse\r\nind = ind * 10 + c;\r\n} else if ((c > 31) && (c < 127)) {\r\nif (ind != -1)\r\nlastind = (u_char)ind;\r\nind = -1;\r\n}\r\n}\r\nstatic void do_catch_up(struct spk_synth *synth)\r\n{\r\nint synth_full_val = 0;\r\nstatic u_char ch;\r\nstatic u_char last = '\0';\r\nunsigned long flags;\r\nunsigned long jiff_max;\r\nunsigned long timeout = msecs_to_jiffies(4000);\r\nDEFINE_WAIT(wait);\r\nstruct var_t *jiffy_delta;\r\nstruct var_t *delay_time;\r\nint jiffy_delta_val;\r\nint delay_time_val;\r\njiffy_delta = spk_get_var(JIFFY);\r\ndelay_time = spk_get_var(DELAY);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\njiffy_delta_val = jiffy_delta->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\njiff_max = jiffies + jiffy_delta_val;\r\nwhile (!kthread_should_stop()) {\r\nspin_lock_irqsave(&flush_lock, flags);\r\nwhile (is_flushing && timeout) {\r\nprepare_to_wait(&flush, &wait, TASK_INTERRUPTIBLE);\r\nspin_unlock_irqrestore(&flush_lock, flags);\r\ntimeout = schedule_timeout(timeout);\r\nspin_lock_irqsave(&flush_lock, flags);\r\n}\r\nfinish_wait(&flush, &wait);\r\nis_flushing = 0;\r\nspin_unlock_irqrestore(&flush_lock, flags);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nif (speakup_info.flushing) {\r\nspeakup_info.flushing = 0;\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nsynth->flush(synth);\r\ncontinue;\r\n}\r\nif (synth_buffer_empty()) {\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nbreak;\r\n}\r\nch = synth_buffer_peek();\r\nset_current_state(TASK_INTERRUPTIBLE);\r\ndelay_time_val = delay_time->u.n.value;\r\nsynth_full_val = synth_full();\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nif (ch == '\n')\r\nch = 0x0D;\r\nif (synth_full_val || !spk_serial_out(ch)) {\r\nschedule_timeout(msecs_to_jiffies(delay_time_val));\r\ncontinue;\r\n}\r\nset_current_state(TASK_RUNNING);\r\nspin_lock_irqsave(&speakup_info.spinlock, flags);\r\nsynth_buffer_getc();\r\nspin_unlock_irqrestore(&speakup_info.spinlock, flags);\r\nif (ch == '[')\r\nin_escape = 1;\r\nelse if (ch == ']')\r\nin_escape = 0;\r\nelse if (ch <= SPACE) {\r\nif (!in_escape && strchr(",.!?;:", last))\r\nspk_serial_out(PROCSPEECH);\r\nif (time_after_eq(jiffies, jiff_max)) {\r\nif (!in_escape)\r\nspk_serial_out(PROCSPEECH);\r\nspin_lock_irqsave(&speakup_info.spinlock,\r\nflags);\r\njiffy_delta_val = jiffy_delta->u.n.value;\r\ndelay_time_val = delay_time->u.n.value;\r\nspin_unlock_irqrestore(&speakup_info.spinlock,\r\nflags);\r\nschedule_timeout(msecs_to_jiffies\r\n(delay_time_val));\r\njiff_max = jiffies + jiffy_delta_val;\r\n}\r\n}\r\nlast = ch;\r\n}\r\nif (!in_escape)\r\nspk_serial_out(PROCSPEECH);\r\n}\r\nstatic void synth_flush(struct spk_synth *synth)\r\n{\r\nif (in_escape) {\r\nspk_serial_out(']');\r\n}\r\nin_escape = 0;\r\nis_flushing = 1;\r\nspk_serial_out(SYNTH_CLEAR);\r\n}\r\nstatic int __init dectlk_init(void)\r\n{\r\nreturn synth_add(&synth_dectlk);\r\n}\r\nstatic void __exit dectlk_exit(void)\r\n{\r\nsynth_remove(&synth_dectlk);\r\n}

static ssize_t version_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "0x%04x\n", boot_params.hdr.version);\r\n}\r\nstatic ssize_t boot_params_data_read(struct file *fp, struct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf, loff_t off, size_t count)\r\n{\r\nmemcpy(buf, (void *)&boot_params + off, count);\r\nreturn count;\r\n}\r\nstatic int kobj_to_setup_data_nr(struct kobject *kobj, int *nr)\r\n{\r\nconst char *name;\r\nname = kobject_name(kobj);\r\nreturn kstrtoint(name, 10, nr);\r\n}\r\nstatic int get_setup_data_paddr(int nr, u64 *paddr)\r\n{\r\nint i = 0;\r\nstruct setup_data *data;\r\nu64 pa_data = boot_params.hdr.setup_data;\r\nwhile (pa_data) {\r\nif (nr == i) {\r\n*paddr = pa_data;\r\nreturn 0;\r\n}\r\ndata = ioremap_cache(pa_data, sizeof(*data));\r\nif (!data)\r\nreturn -ENOMEM;\r\npa_data = data->next;\r\niounmap(data);\r\ni++;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int __init get_setup_data_size(int nr, size_t *size)\r\n{\r\nint i = 0;\r\nstruct setup_data *data;\r\nu64 pa_data = boot_params.hdr.setup_data;\r\nwhile (pa_data) {\r\ndata = ioremap_cache(pa_data, sizeof(*data));\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (nr == i) {\r\n*size = data->len;\r\niounmap(data);\r\nreturn 0;\r\n}\r\npa_data = data->next;\r\niounmap(data);\r\ni++;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t type_show(struct kobject *kobj,\r\nstruct kobj_attribute *attr, char *buf)\r\n{\r\nint nr, ret;\r\nu64 paddr;\r\nstruct setup_data *data;\r\nret = kobj_to_setup_data_nr(kobj, &nr);\r\nif (ret)\r\nreturn ret;\r\nret = get_setup_data_paddr(nr, &paddr);\r\nif (ret)\r\nreturn ret;\r\ndata = ioremap_cache(paddr, sizeof(*data));\r\nif (!data)\r\nreturn -ENOMEM;\r\nret = sprintf(buf, "0x%x\n", data->type);\r\niounmap(data);\r\nreturn ret;\r\n}\r\nstatic ssize_t setup_data_data_read(struct file *fp,\r\nstruct kobject *kobj,\r\nstruct bin_attribute *bin_attr,\r\nchar *buf,\r\nloff_t off, size_t count)\r\n{\r\nint nr, ret = 0;\r\nu64 paddr;\r\nstruct setup_data *data;\r\nvoid *p;\r\nret = kobj_to_setup_data_nr(kobj, &nr);\r\nif (ret)\r\nreturn ret;\r\nret = get_setup_data_paddr(nr, &paddr);\r\nif (ret)\r\nreturn ret;\r\ndata = ioremap_cache(paddr, sizeof(*data));\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (off > data->len) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nif (count > data->len - off)\r\ncount = data->len - off;\r\nif (!count)\r\ngoto out;\r\nret = count;\r\np = ioremap_cache(paddr + sizeof(*data), data->len);\r\nif (!p) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nmemcpy(buf, p + off, count);\r\niounmap(p);\r\nout:\r\niounmap(data);\r\nreturn ret;\r\n}\r\nstatic int __init create_setup_data_node(struct kobject *parent,\r\nstruct kobject **kobjp, int nr)\r\n{\r\nint ret = 0;\r\nsize_t size;\r\nstruct kobject *kobj;\r\nchar name[16];\r\nsnprintf(name, 16, "%d", nr);\r\nkobj = kobject_create_and_add(name, parent);\r\nif (!kobj)\r\nreturn -ENOMEM;\r\nret = get_setup_data_size(nr, &size);\r\nif (ret)\r\ngoto out_kobj;\r\ndata_attr.size = size;\r\nret = sysfs_create_group(kobj, &setup_data_attr_group);\r\nif (ret)\r\ngoto out_kobj;\r\n*kobjp = kobj;\r\nreturn 0;\r\nout_kobj:\r\nkobject_put(kobj);\r\nreturn ret;\r\n}\r\nstatic void __init cleanup_setup_data_node(struct kobject *kobj)\r\n{\r\nsysfs_remove_group(kobj, &setup_data_attr_group);\r\nkobject_put(kobj);\r\n}\r\nstatic int __init get_setup_data_total_num(u64 pa_data, int *nr)\r\n{\r\nint ret = 0;\r\nstruct setup_data *data;\r\n*nr = 0;\r\nwhile (pa_data) {\r\n*nr += 1;\r\ndata = ioremap_cache(pa_data, sizeof(*data));\r\nif (!data) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\npa_data = data->next;\r\niounmap(data);\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __init create_setup_data_nodes(struct kobject *parent)\r\n{\r\nstruct kobject *setup_data_kobj, **kobjp;\r\nu64 pa_data;\r\nint i, j, nr, ret = 0;\r\npa_data = boot_params.hdr.setup_data;\r\nif (!pa_data)\r\nreturn 0;\r\nsetup_data_kobj = kobject_create_and_add("setup_data", parent);\r\nif (!setup_data_kobj) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nret = get_setup_data_total_num(pa_data, &nr);\r\nif (ret)\r\ngoto out_setup_data_kobj;\r\nkobjp = kmalloc(sizeof(*kobjp) * nr, GFP_KERNEL);\r\nif (!kobjp) {\r\nret = -ENOMEM;\r\ngoto out_setup_data_kobj;\r\n}\r\nfor (i = 0; i < nr; i++) {\r\nret = create_setup_data_node(setup_data_kobj, kobjp + i, i);\r\nif (ret)\r\ngoto out_clean_nodes;\r\n}\r\nkfree(kobjp);\r\nreturn 0;\r\nout_clean_nodes:\r\nfor (j = i - 1; j > 0; j--)\r\ncleanup_setup_data_node(*(kobjp + j));\r\nkfree(kobjp);\r\nout_setup_data_kobj:\r\nkobject_put(setup_data_kobj);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int __init boot_params_ksysfs_init(void)\r\n{\r\nint ret;\r\nstruct kobject *boot_params_kobj;\r\nboot_params_kobj = kobject_create_and_add("boot_params",\r\nkernel_kobj);\r\nif (!boot_params_kobj) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nret = sysfs_create_group(boot_params_kobj, &boot_params_attr_group);\r\nif (ret)\r\ngoto out_boot_params_kobj;\r\nret = create_setup_data_nodes(boot_params_kobj);\r\nif (ret)\r\ngoto out_create_group;\r\nreturn 0;\r\nout_create_group:\r\nsysfs_remove_group(boot_params_kobj, &boot_params_attr_group);\r\nout_boot_params_kobj:\r\nkobject_put(boot_params_kobj);\r\nout:\r\nreturn ret;\r\n}

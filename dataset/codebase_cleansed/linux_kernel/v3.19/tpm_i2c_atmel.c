static int i2c_atmel_send(struct tpm_chip *chip, u8 *buf, size_t len)\r\n{\r\nstruct priv_data *priv = chip->vendor.priv;\r\nstruct i2c_client *client = to_i2c_client(chip->dev);\r\ns32 status;\r\npriv->len = 0;\r\nif (len <= 2)\r\nreturn -EIO;\r\nstatus = i2c_master_send(client, buf, len);\r\ndev_dbg(chip->dev,\r\n"%s(buf=%*ph len=%0zx) -> sts=%d\n", __func__,\r\n(int)min_t(size_t, 64, len), buf, len, status);\r\nreturn status;\r\n}\r\nstatic int i2c_atmel_recv(struct tpm_chip *chip, u8 *buf, size_t count)\r\n{\r\nstruct priv_data *priv = chip->vendor.priv;\r\nstruct i2c_client *client = to_i2c_client(chip->dev);\r\nstruct tpm_output_header *hdr =\r\n(struct tpm_output_header *)priv->buffer;\r\nu32 expected_len;\r\nint rc;\r\nif (priv->len == 0)\r\nreturn -EIO;\r\nexpected_len = be32_to_cpu(hdr->length);\r\nif (expected_len > count)\r\nreturn -ENOMEM;\r\nif (priv->len >= expected_len) {\r\ndev_dbg(chip->dev,\r\n"%s early(buf=%*ph count=%0zx) -> ret=%d\n", __func__,\r\n(int)min_t(size_t, 64, expected_len), buf, count,\r\nexpected_len);\r\nmemcpy(buf, priv->buffer, expected_len);\r\nreturn expected_len;\r\n}\r\nrc = i2c_master_recv(client, buf, expected_len);\r\ndev_dbg(chip->dev,\r\n"%s reread(buf=%*ph count=%0zx) -> ret=%d\n", __func__,\r\n(int)min_t(size_t, 64, expected_len), buf, count,\r\nexpected_len);\r\nreturn rc;\r\n}\r\nstatic void i2c_atmel_cancel(struct tpm_chip *chip)\r\n{\r\ndev_err(chip->dev, "TPM operation cancellation was requested, but is not supported");\r\n}\r\nstatic u8 i2c_atmel_read_status(struct tpm_chip *chip)\r\n{\r\nstruct priv_data *priv = chip->vendor.priv;\r\nstruct i2c_client *client = to_i2c_client(chip->dev);\r\nint rc;\r\npriv->len = 0;\r\nmemset(priv->buffer, 0, sizeof(priv->buffer));\r\nrc = i2c_master_recv(client, priv->buffer, sizeof(priv->buffer));\r\ndev_dbg(chip->dev,\r\n"%s: sts=%d", __func__, rc);\r\nif (rc <= 0)\r\nreturn 0;\r\npriv->len = rc;\r\nreturn ATMEL_STS_OK;\r\n}\r\nstatic bool i2c_atmel_req_canceled(struct tpm_chip *chip, u8 status)\r\n{\r\nreturn false;\r\n}\r\nstatic int i2c_atmel_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nint rc;\r\nstruct tpm_chip *chip;\r\nstruct device *dev = &client->dev;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_I2C))\r\nreturn -ENODEV;\r\nchip = tpm_register_hardware(dev, &i2c_atmel);\r\nif (!chip) {\r\ndev_err(dev, "%s() error in tpm_register_hardware\n", __func__);\r\nreturn -ENODEV;\r\n}\r\nchip->vendor.priv = devm_kzalloc(dev, sizeof(struct priv_data),\r\nGFP_KERNEL);\r\nchip->vendor.timeout_a = msecs_to_jiffies(TPM_I2C_SHORT_TIMEOUT);\r\nchip->vendor.timeout_b = msecs_to_jiffies(TPM_I2C_LONG_TIMEOUT);\r\nchip->vendor.timeout_c = msecs_to_jiffies(TPM_I2C_SHORT_TIMEOUT);\r\nchip->vendor.timeout_d = msecs_to_jiffies(TPM_I2C_SHORT_TIMEOUT);\r\nchip->vendor.irq = 0;\r\nif (tpm_get_timeouts(chip)) {\r\nrc = -ENODEV;\r\ngoto out_err;\r\n}\r\nif (tpm_do_selftest(chip)) {\r\nrc = -ENODEV;\r\ngoto out_err;\r\n}\r\nreturn 0;\r\nout_err:\r\ntpm_dev_vendor_release(chip);\r\ntpm_remove_hardware(chip->dev);\r\nreturn rc;\r\n}\r\nstatic int i2c_atmel_remove(struct i2c_client *client)\r\n{\r\nstruct device *dev = &(client->dev);\r\nstruct tpm_chip *chip = dev_get_drvdata(dev);\r\nif (chip)\r\ntpm_dev_vendor_release(chip);\r\ntpm_remove_hardware(dev);\r\nkfree(chip);\r\nreturn 0;\r\n}

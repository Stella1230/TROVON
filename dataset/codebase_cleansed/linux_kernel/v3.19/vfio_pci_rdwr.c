static ssize_t do_io_rw(void __iomem *io, char __user *buf,\r\nloff_t off, size_t count, size_t x_start,\r\nsize_t x_end, bool iswrite)\r\n{\r\nssize_t done = 0;\r\nwhile (count) {\r\nsize_t fillable, filled;\r\nif (off < x_start)\r\nfillable = min(count, (size_t)(x_start - off));\r\nelse if (off >= x_end)\r\nfillable = count;\r\nelse\r\nfillable = 0;\r\nif (fillable >= 4 && !(off % 4)) {\r\n__le32 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 4))\r\nreturn -EFAULT;\r\niowrite32(le32_to_cpu(val), io + off);\r\n} else {\r\nval = cpu_to_le32(ioread32(io + off));\r\nif (copy_to_user(buf, &val, 4))\r\nreturn -EFAULT;\r\n}\r\nfilled = 4;\r\n} else if (fillable >= 2 && !(off % 2)) {\r\n__le16 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 2))\r\nreturn -EFAULT;\r\niowrite16(le16_to_cpu(val), io + off);\r\n} else {\r\nval = cpu_to_le16(ioread16(io + off));\r\nif (copy_to_user(buf, &val, 2))\r\nreturn -EFAULT;\r\n}\r\nfilled = 2;\r\n} else if (fillable) {\r\nu8 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 1))\r\nreturn -EFAULT;\r\niowrite8(val, io + off);\r\n} else {\r\nval = ioread8(io + off);\r\nif (copy_to_user(buf, &val, 1))\r\nreturn -EFAULT;\r\n}\r\nfilled = 1;\r\n} else {\r\nfilled = min(count, (size_t)(x_end - off));\r\nif (!iswrite) {\r\nu8 val = 0xFF;\r\nsize_t i;\r\nfor (i = 0; i < filled; i++)\r\nif (copy_to_user(buf + i, &val, 1))\r\nreturn -EFAULT;\r\n}\r\n}\r\ncount -= filled;\r\ndone += filled;\r\noff += filled;\r\nbuf += filled;\r\n}\r\nreturn done;\r\n}\r\nssize_t vfio_pci_bar_rw(struct vfio_pci_device *vdev, char __user *buf,\r\nsize_t count, loff_t *ppos, bool iswrite)\r\n{\r\nstruct pci_dev *pdev = vdev->pdev;\r\nloff_t pos = *ppos & VFIO_PCI_OFFSET_MASK;\r\nint bar = VFIO_PCI_OFFSET_TO_INDEX(*ppos);\r\nsize_t x_start = 0, x_end = 0;\r\nresource_size_t end;\r\nvoid __iomem *io;\r\nssize_t done;\r\nif (!pci_resource_start(pdev, bar))\r\nreturn -EINVAL;\r\nend = pci_resource_len(pdev, bar);\r\nif (pos >= end)\r\nreturn -EINVAL;\r\ncount = min(count, (size_t)(end - pos));\r\nif (bar == PCI_ROM_RESOURCE) {\r\nio = pci_map_rom(pdev, &x_start);\r\nif (!io)\r\nreturn -ENOMEM;\r\nx_end = end;\r\n} else if (!vdev->barmap[bar]) {\r\nint ret;\r\nret = pci_request_selected_regions(pdev, 1 << bar, "vfio");\r\nif (ret)\r\nreturn ret;\r\nio = pci_iomap(pdev, bar, 0);\r\nif (!io) {\r\npci_release_selected_regions(pdev, 1 << bar);\r\nreturn -ENOMEM;\r\n}\r\nvdev->barmap[bar] = io;\r\n} else\r\nio = vdev->barmap[bar];\r\nif (bar == vdev->msix_bar) {\r\nx_start = vdev->msix_offset;\r\nx_end = vdev->msix_offset + vdev->msix_size;\r\n}\r\ndone = do_io_rw(io, buf, pos, count, x_start, x_end, iswrite);\r\nif (done >= 0)\r\n*ppos += done;\r\nif (bar == PCI_ROM_RESOURCE)\r\npci_unmap_rom(pdev, io);\r\nreturn done;\r\n}\r\nssize_t vfio_pci_vga_rw(struct vfio_pci_device *vdev, char __user *buf,\r\nsize_t count, loff_t *ppos, bool iswrite)\r\n{\r\nint ret;\r\nloff_t off, pos = *ppos & VFIO_PCI_OFFSET_MASK;\r\nvoid __iomem *iomem = NULL;\r\nunsigned int rsrc;\r\nbool is_ioport;\r\nssize_t done;\r\nif (!vdev->has_vga)\r\nreturn -EINVAL;\r\nswitch (pos) {\r\ncase 0xa0000 ... 0xbffff:\r\ncount = min(count, (size_t)(0xc0000 - pos));\r\niomem = ioremap_nocache(0xa0000, 0xbffff - 0xa0000 + 1);\r\noff = pos - 0xa0000;\r\nrsrc = VGA_RSRC_LEGACY_MEM;\r\nis_ioport = false;\r\nbreak;\r\ncase 0x3b0 ... 0x3bb:\r\ncount = min(count, (size_t)(0x3bc - pos));\r\niomem = ioport_map(0x3b0, 0x3bb - 0x3b0 + 1);\r\noff = pos - 0x3b0;\r\nrsrc = VGA_RSRC_LEGACY_IO;\r\nis_ioport = true;\r\nbreak;\r\ncase 0x3c0 ... 0x3df:\r\ncount = min(count, (size_t)(0x3e0 - pos));\r\niomem = ioport_map(0x3c0, 0x3df - 0x3c0 + 1);\r\noff = pos - 0x3c0;\r\nrsrc = VGA_RSRC_LEGACY_IO;\r\nis_ioport = true;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (!iomem)\r\nreturn -ENOMEM;\r\nret = vga_get_interruptible(vdev->pdev, rsrc);\r\nif (ret) {\r\nis_ioport ? ioport_unmap(iomem) : iounmap(iomem);\r\nreturn ret;\r\n}\r\ndone = do_io_rw(iomem, buf, off, count, 0, 0, iswrite);\r\nvga_put(vdev->pdev, rsrc);\r\nis_ioport ? ioport_unmap(iomem) : iounmap(iomem);\r\nif (done >= 0)\r\n*ppos += done;\r\nreturn done;\r\n}

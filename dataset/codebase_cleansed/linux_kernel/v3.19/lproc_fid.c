static int lprocfs_fid_write_common(const char __user *buffer, size_t count,\r\nstruct lu_seq_range *range)\r\n{\r\nstruct lu_seq_range tmp;\r\nint rc;\r\nchar kernbuf[MAX_FID_RANGE_STRLEN];\r\nLASSERT(range != NULL);\r\nif (count >= sizeof(kernbuf))\r\nreturn -EINVAL;\r\nif (copy_from_user(kernbuf, buffer, count))\r\nreturn -EFAULT;\r\nkernbuf[count] = 0;\r\nif (count == 5 && strcmp(kernbuf, "clear") == 0) {\r\nmemset(range, 0, sizeof(*range));\r\nreturn count;\r\n}\r\nrc = sscanf(kernbuf, "[%llx - %llx]\n",\r\n(unsigned long long *)&tmp.lsr_start,\r\n(unsigned long long *)&tmp.lsr_end);\r\nif (!range_is_sane(&tmp) || range_is_zero(&tmp) ||\r\ntmp.lsr_start < range->lsr_start || tmp.lsr_end > range->lsr_end)\r\nreturn -EINVAL;\r\n*range = tmp;\r\nreturn count;\r\n}\r\nstatic ssize_t lprocfs_fid_space_seq_write(struct file *file,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct lu_client_seq *seq;\r\nint rc;\r\nseq = ((struct seq_file *)file->private_data)->private;\r\nLASSERT(seq != NULL);\r\nmutex_lock(&seq->lcs_mutex);\r\nrc = lprocfs_fid_write_common(buffer, count, &seq->lcs_space);\r\nif (rc == 0) {\r\nCDEBUG(D_INFO, "%s: Space: "DRANGE"\n",\r\nseq->lcs_name, PRANGE(&seq->lcs_space));\r\n}\r\nmutex_unlock(&seq->lcs_mutex);\r\nreturn count;\r\n}\r\nstatic int\r\nlprocfs_fid_space_seq_show(struct seq_file *m, void *unused)\r\n{\r\nstruct lu_client_seq *seq = (struct lu_client_seq *)m->private;\r\nint rc;\r\nLASSERT(seq != NULL);\r\nmutex_lock(&seq->lcs_mutex);\r\nrc = seq_printf(m, "[%#llx - %#llx]:%x:%s\n", PRANGE(&seq->lcs_space));\r\nmutex_unlock(&seq->lcs_mutex);\r\nreturn rc;\r\n}\r\nstatic ssize_t lprocfs_fid_width_seq_write(struct file *file,\r\nconst char __user *buffer,\r\nsize_t count, loff_t *off)\r\n{\r\nstruct lu_client_seq *seq;\r\n__u64 max;\r\nint rc, val;\r\nseq = ((struct seq_file *)file->private_data)->private;\r\nLASSERT(seq != NULL);\r\nrc = lprocfs_write_helper(buffer, count, &val);\r\nif (rc)\r\nreturn rc;\r\nmutex_lock(&seq->lcs_mutex);\r\nif (seq->lcs_type == LUSTRE_SEQ_DATA)\r\nmax = LUSTRE_DATA_SEQ_MAX_WIDTH;\r\nelse\r\nmax = LUSTRE_METADATA_SEQ_MAX_WIDTH;\r\nif (val <= max && val > 0) {\r\nseq->lcs_width = val;\r\nif (rc == 0) {\r\nCDEBUG(D_INFO, "%s: Sequence size: %llu\n",\r\nseq->lcs_name, seq->lcs_width);\r\n}\r\n}\r\nmutex_unlock(&seq->lcs_mutex);\r\nreturn count;\r\n}\r\nstatic int\r\nlprocfs_fid_width_seq_show(struct seq_file *m, void *unused)\r\n{\r\nstruct lu_client_seq *seq = (struct lu_client_seq *)m->private;\r\nint rc;\r\nLASSERT(seq != NULL);\r\nmutex_lock(&seq->lcs_mutex);\r\nrc = seq_printf(m, "%llu\n", seq->lcs_width);\r\nmutex_unlock(&seq->lcs_mutex);\r\nreturn rc;\r\n}\r\nstatic int\r\nlprocfs_fid_fid_seq_show(struct seq_file *m, void *unused)\r\n{\r\nstruct lu_client_seq *seq = (struct lu_client_seq *)m->private;\r\nint rc;\r\nLASSERT(seq != NULL);\r\nmutex_lock(&seq->lcs_mutex);\r\nrc = seq_printf(m, DFID"\n", PFID(&seq->lcs_fid));\r\nmutex_unlock(&seq->lcs_mutex);\r\nreturn rc;\r\n}\r\nstatic int\r\nlprocfs_fid_server_seq_show(struct seq_file *m, void *unused)\r\n{\r\nstruct lu_client_seq *seq = (struct lu_client_seq *)m->private;\r\nstruct client_obd *cli;\r\nint rc;\r\nLASSERT(seq != NULL);\r\nif (seq->lcs_exp != NULL) {\r\ncli = &seq->lcs_exp->exp_obd->u.cli;\r\nrc = seq_printf(m, "%s\n", cli->cl_target_uuid.uuid);\r\n} else {\r\nrc = seq_printf(m, "%s\n", seq->lcs_srv->lss_name);\r\n}\r\nreturn rc;\r\n}

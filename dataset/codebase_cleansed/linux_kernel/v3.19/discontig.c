static void __init mem_prof_init(void)\r\n{\r\nunsigned long start_pfn, holes, free_pfn;\r\nconst unsigned long zone_alignment = 1UL << (MAX_ORDER - 1);\r\nunsigned long ul;\r\nmem_prof_t *mp;\r\nmp = &mem_prof[0];\r\nmp->start_pfn = PFN_UP(CONFIG_MEMORY_START);\r\nmp->pages = PFN_DOWN(memory_end - memory_start);\r\nmp->holes = 0;\r\nmp->free_pfn = PFN_UP(__pa(_end));\r\nmp = &mem_prof[1];\r\nstart_pfn = free_pfn = PFN_UP(CONFIG_IRAM_START);\r\nholes = 0;\r\nif (start_pfn & (zone_alignment - 1)) {\r\nul = zone_alignment;\r\nwhile (start_pfn >= ul)\r\nul += zone_alignment;\r\nstart_pfn = ul - zone_alignment;\r\nholes = free_pfn - start_pfn;\r\n}\r\nmp->start_pfn = start_pfn;\r\nmp->pages = PFN_DOWN(CONFIG_IRAM_SIZE) + holes;\r\nmp->holes = holes;\r\nmp->free_pfn = PFN_UP(CONFIG_IRAM_START);\r\n}\r\nunsigned long __init setup_memory(void)\r\n{\r\nunsigned long bootmap_size;\r\nunsigned long min_pfn;\r\nint nid;\r\nmem_prof_t *mp;\r\nmax_low_pfn = 0;\r\nmin_low_pfn = -1;\r\nmem_prof_init();\r\nfor_each_online_node(nid) {\r\nmp = &mem_prof[nid];\r\nNODE_DATA(nid)=(pg_data_t *)&m32r_node_data[nid];\r\nNODE_DATA(nid)->bdata = &bootmem_node_data[nid];\r\nmin_pfn = mp->start_pfn;\r\nmax_pfn = mp->start_pfn + mp->pages;\r\nbootmap_size = init_bootmem_node(NODE_DATA(nid), mp->free_pfn,\r\nmp->start_pfn, max_pfn);\r\nfree_bootmem_node(NODE_DATA(nid), PFN_PHYS(mp->start_pfn),\r\nPFN_PHYS(mp->pages));\r\nreserve_bootmem_node(NODE_DATA(nid), PFN_PHYS(mp->start_pfn),\r\nPFN_PHYS(mp->free_pfn - mp->start_pfn) + bootmap_size,\r\nBOOTMEM_DEFAULT);\r\nif (max_low_pfn < max_pfn)\r\nmax_low_pfn = max_pfn;\r\nif (min_low_pfn > min_pfn)\r\nmin_low_pfn = min_pfn;\r\n}\r\n#ifdef CONFIG_BLK_DEV_INITRD\r\nif (LOADER_TYPE && INITRD_START) {\r\nif (INITRD_START + INITRD_SIZE <= PFN_PHYS(max_low_pfn)) {\r\nreserve_bootmem_node(NODE_DATA(0), INITRD_START,\r\nINITRD_SIZE, BOOTMEM_DEFAULT);\r\ninitrd_start = INITRD_START + PAGE_OFFSET;\r\ninitrd_end = initrd_start + INITRD_SIZE;\r\nprintk("initrd:start[%08lx],size[%08lx]\n",\r\ninitrd_start, INITRD_SIZE);\r\n} else {\r\nprintk("initrd extends beyond end of memory "\r\n"(0x%08lx > 0x%08llx)\ndisabling initrd\n",\r\nINITRD_START + INITRD_SIZE,\r\n(unsigned long long)PFN_PHYS(max_low_pfn));\r\ninitrd_start = 0;\r\n}\r\n}\r\n#endif\r\nreturn max_low_pfn;\r\n}\r\nvoid __init zone_sizes_init(void)\r\n{\r\nunsigned long zones_size[MAX_NR_ZONES], zholes_size[MAX_NR_ZONES];\r\nunsigned long low, start_pfn;\r\nint nid, i;\r\nmem_prof_t *mp;\r\nfor_each_online_node(nid) {\r\nmp = &mem_prof[nid];\r\nfor (i = 0 ; i < MAX_NR_ZONES ; i++) {\r\nzones_size[i] = 0;\r\nzholes_size[i] = 0;\r\n}\r\nstart_pfn = START_PFN(nid);\r\nlow = MAX_LOW_PFN(nid);\r\nzones_size[ZONE_DMA] = low - start_pfn;\r\nzholes_size[ZONE_DMA] = mp->holes;\r\nnode_set_state(nid, N_NORMAL_MEMORY);\r\nfree_area_init_node(nid, zones_size, start_pfn, zholes_size);\r\n}\r\nNODE_DATA(1)->node_zones->watermark[WMARK_MIN] = 0;\r\nNODE_DATA(1)->node_zones->watermark[WMARK_LOW] = 0;\r\nNODE_DATA(1)->node_zones->watermark[WMARK_HIGH] = 0;\r\n}

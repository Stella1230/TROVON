int perf_read_tsc_conversion(const struct perf_event_mmap_page *pc,\r\nstruct perf_tsc_conversion *tc)\r\n{\r\nbool cap_user_time_zero;\r\nu32 seq;\r\nint i = 0;\r\nwhile (1) {\r\nseq = pc->lock;\r\nrmb();\r\ntc->time_mult = pc->time_mult;\r\ntc->time_shift = pc->time_shift;\r\ntc->time_zero = pc->time_zero;\r\ncap_user_time_zero = pc->cap_user_time_zero;\r\nrmb();\r\nif (pc->lock == seq && !(seq & 1))\r\nbreak;\r\nif (++i > 10000) {\r\npr_debug("failed to get perf_event_mmap_page lock\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\nif (!cap_user_time_zero)\r\nreturn -EOPNOTSUPP;\r\nreturn 0;\r\n}\r\nu64 rdtsc(void)\r\n{\r\nunsigned int low, high;\r\nasm volatile("rdtsc" : "=a" (low), "=d" (high));\r\nreturn low | ((u64)high) << 32;\r\n}

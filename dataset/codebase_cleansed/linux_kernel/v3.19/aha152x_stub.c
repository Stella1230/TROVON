static int aha152x_probe(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info;\r\ndev_dbg(&link->dev, "aha152x_attach()\n");\r\ninfo = kzalloc(sizeof(*info), GFP_KERNEL);\r\nif (!info) return -ENOMEM;\r\ninfo->p_dev = link;\r\nlink->priv = info;\r\nlink->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\nlink->config_regs = PRESENT_OPTION;\r\nreturn aha152x_config_cs(link);\r\n}\r\nstatic void aha152x_detach(struct pcmcia_device *link)\r\n{\r\ndev_dbg(&link->dev, "aha152x_detach\n");\r\naha152x_release_cs(link);\r\nkfree(link->priv);\r\n}\r\nstatic int aha152x_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->io_lines = 10;\r\nif ((p_dev->resource[0]->end < 0x20) &&\r\n(p_dev->resource[1]->end >= 0x20))\r\np_dev->resource[0]->start = p_dev->resource[1]->start;\r\nif (p_dev->resource[0]->start >= 0xffff)\r\nreturn -EINVAL;\r\np_dev->resource[1]->start = p_dev->resource[1]->end = 0;\r\np_dev->resource[0]->end = 0x20;\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_AUTO;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int aha152x_config_cs(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\nstruct aha152x_setup s;\r\nint ret;\r\nstruct Scsi_Host *host;\r\ndev_dbg(&link->dev, "aha152x_config\n");\r\nret = pcmcia_loop_config(link, aha152x_config_check, NULL);\r\nif (ret)\r\ngoto failed;\r\nif (!link->irq)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nmemset(&s, 0, sizeof(s));\r\ns.conf = "PCMCIA setup";\r\ns.io_port = link->resource[0]->start;\r\ns.irq = link->irq;\r\ns.scsiid = host_id;\r\ns.reconnect = reconnect;\r\ns.parity = parity;\r\ns.synchronous = synchronous;\r\ns.delay = reset_delay;\r\nif (ext_trans)\r\ns.ext_trans = ext_trans;\r\nhost = aha152x_probe_one(&s);\r\nif (host == NULL) {\r\nprintk(KERN_INFO "aha152x_cs: no SCSI devices found\n");\r\ngoto failed;\r\n}\r\ninfo->host = host;\r\nreturn 0;\r\nfailed:\r\naha152x_release_cs(link);\r\nreturn -ENODEV;\r\n}\r\nstatic void aha152x_release_cs(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\naha152x_release(info->host);\r\npcmcia_disable_device(link);\r\n}\r\nstatic int aha152x_resume(struct pcmcia_device *link)\r\n{\r\nscsi_info_t *info = link->priv;\r\naha152x_host_reset_host(info->host);\r\nreturn 0;\r\n}\r\nstatic int __init init_aha152x_cs(void)\r\n{\r\nreturn pcmcia_register_driver(&aha152x_cs_driver);\r\n}\r\nstatic void __exit exit_aha152x_cs(void)\r\n{\r\npcmcia_unregister_driver(&aha152x_cs_driver);\r\n}

u16\r\nnvbios_fan_table(struct nouveau_bios *bios, u8 *ver, u8 *hdr, u8 *cnt, u8 *len)\r\n{\r\nstruct bit_entry bit_P;\r\nu16 fan = 0x0000;\r\nif (!bit_entry(bios, 'P', &bit_P)) {\r\nif (bit_P.version == 2 && bit_P.length >= 0x5a)\r\nfan = nv_ro16(bios, bit_P.offset + 0x58);\r\nif (fan) {\r\n*ver = nv_ro08(bios, fan + 0);\r\nswitch (*ver) {\r\ncase 0x10:\r\n*hdr = nv_ro08(bios, fan + 1);\r\n*len = nv_ro08(bios, fan + 2);\r\n*cnt = nv_ro08(bios, fan + 3);\r\nreturn fan;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn 0x0000;\r\n}\r\nu16\r\nnvbios_fan_entry(struct nouveau_bios *bios, int idx, u8 *ver, u8 *hdr,\r\nu8 *cnt, u8 *len)\r\n{\r\nu16 data = nvbios_fan_table(bios, ver, hdr, cnt, len);\r\nif (data && idx < *cnt)\r\nreturn data + *hdr + (idx * (*len));\r\nreturn 0x0000;\r\n}\r\nu16\r\nnvbios_fan_parse(struct nouveau_bios *bios, struct nvbios_therm_fan *fan)\r\n{\r\nu8 ver, hdr, cnt, len;\r\nu16 data = nvbios_fan_entry(bios, 0, &ver, &hdr, &cnt, &len);\r\nif (data) {\r\nu8 type = nv_ro08(bios, data + 0x00);\r\nswitch (type) {\r\ncase 0:\r\nfan->type = NVBIOS_THERM_FAN_TOGGLE;\r\nbreak;\r\ncase 1:\r\ncase 2:\r\nfan->type = NVBIOS_THERM_FAN_PWM;\r\nbreak;\r\ndefault:\r\nfan->type = NVBIOS_THERM_FAN_UNK;\r\n}\r\nfan->min_duty = nv_ro08(bios, data + 0x02);\r\nfan->max_duty = nv_ro08(bios, data + 0x03);\r\nfan->pwm_freq = nv_ro32(bios, data + 0x0b) & 0xffffff;\r\n}\r\nreturn data;\r\n}

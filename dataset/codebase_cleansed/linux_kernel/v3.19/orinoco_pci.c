static int orinoco_pci_cor_reset(struct orinoco_private *priv)\r\n{\r\nstruct hermes *hw = &priv->hw;\r\nunsigned long timeout;\r\nu16 reg;\r\nhermes_write_regn(hw, PCI_COR, HERMES_PCI_COR_MASK);\r\nmdelay(HERMES_PCI_COR_ONT);\r\nhermes_write_regn(hw, PCI_COR, 0x0000);\r\nmdelay(HERMES_PCI_COR_OFFT);\r\ntimeout = jiffies + (HERMES_PCI_COR_BUSYT * HZ / 1000);\r\nreg = hermes_read_regn(hw, CMD);\r\nwhile (time_before(jiffies, timeout) && (reg & HERMES_CMD_BUSY)) {\r\nmdelay(1);\r\nreg = hermes_read_regn(hw, CMD);\r\n}\r\nif (reg & HERMES_CMD_BUSY) {\r\nprintk(KERN_ERR PFX "Busy timeout\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int orinoco_pci_init_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nint err;\r\nstruct orinoco_private *priv;\r\nstruct orinoco_pci_card *card;\r\nvoid __iomem *hermes_io;\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot enable PCI device\n");\r\nreturn err;\r\n}\r\nerr = pci_request_regions(pdev, DRIVER_NAME);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot obtain PCI resources\n");\r\ngoto fail_resources;\r\n}\r\nhermes_io = pci_iomap(pdev, 0, 0);\r\nif (!hermes_io) {\r\nprintk(KERN_ERR PFX "Cannot remap chipset registers\n");\r\nerr = -EIO;\r\ngoto fail_map_hermes;\r\n}\r\npriv = alloc_orinocodev(sizeof(*card), &pdev->dev,\r\norinoco_pci_cor_reset, NULL);\r\nif (!priv) {\r\nprintk(KERN_ERR PFX "Cannot allocate network device\n");\r\nerr = -ENOMEM;\r\ngoto fail_alloc;\r\n}\r\ncard = priv->card;\r\nhermes_struct_init(&priv->hw, hermes_io, HERMES_32BIT_REGSPACING);\r\nerr = request_irq(pdev->irq, orinoco_interrupt, IRQF_SHARED,\r\nDRIVER_NAME, priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Cannot allocate IRQ %d\n", pdev->irq);\r\nerr = -EBUSY;\r\ngoto fail_irq;\r\n}\r\nerr = orinoco_pci_cor_reset(priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "Initial reset failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_init(priv);\r\nif (err) {\r\nprintk(KERN_ERR PFX "orinoco_init() failed\n");\r\ngoto fail;\r\n}\r\nerr = orinoco_if_add(priv, 0, 0, NULL);\r\nif (err) {\r\nprintk(KERN_ERR PFX "orinoco_if_add() failed\n");\r\ngoto fail;\r\n}\r\npci_set_drvdata(pdev, priv);\r\nreturn 0;\r\nfail:\r\nfree_irq(pdev->irq, priv);\r\nfail_irq:\r\nfree_orinocodev(priv);\r\nfail_alloc:\r\npci_iounmap(pdev, hermes_io);\r\nfail_map_hermes:\r\npci_release_regions(pdev);\r\nfail_resources:\r\npci_disable_device(pdev);\r\nreturn err;\r\n}\r\nstatic void orinoco_pci_remove_one(struct pci_dev *pdev)\r\n{\r\nstruct orinoco_private *priv = pci_get_drvdata(pdev);\r\norinoco_if_del(priv);\r\nfree_irq(pdev->irq, priv);\r\nfree_orinocodev(priv);\r\npci_iounmap(pdev, priv->hw.iobase);\r\npci_release_regions(pdev);\r\npci_disable_device(pdev);\r\n}\r\nstatic int __init orinoco_pci_init(void)\r\n{\r\nprintk(KERN_DEBUG "%s\n", version);\r\nreturn pci_register_driver(&orinoco_pci_driver);\r\n}\r\nstatic void __exit orinoco_pci_exit(void)\r\n{\r\npci_unregister_driver(&orinoco_pci_driver);\r\n}

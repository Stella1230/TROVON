static inline int battery_scale(int log)\r\n{\r\nint scale = 1;\r\nwhile (log--)\r\nscale *= 10;\r\nreturn scale;\r\n}\r\nstatic inline int acpi_battery_vscale(struct acpi_battery *battery)\r\n{\r\nreturn battery_scale((battery->spec & 0x0f00) >> 8);\r\n}\r\nstatic inline int acpi_battery_ipscale(struct acpi_battery *battery)\r\n{\r\nreturn battery_scale((battery->spec & 0xf000) >> 12);\r\n}\r\nstatic inline int acpi_battery_mode(struct acpi_battery *battery)\r\n{\r\nreturn (battery->mode & 0x8000);\r\n}\r\nstatic inline int acpi_battery_scale(struct acpi_battery *battery)\r\n{\r\nreturn (acpi_battery_mode(battery) ? 10 : 1) *\r\nacpi_battery_ipscale(battery);\r\n}\r\nstatic int sbs_get_ac_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct acpi_sbs *sbs = to_acpi_sbs(psy);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nval->intval = sbs->charger_present;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acpi_battery_technology(struct acpi_battery *battery)\r\n{\r\nif (!strcasecmp("NiCd", battery->device_chemistry))\r\nreturn POWER_SUPPLY_TECHNOLOGY_NiCd;\r\nif (!strcasecmp("NiMH", battery->device_chemistry))\r\nreturn POWER_SUPPLY_TECHNOLOGY_NiMH;\r\nif (!strcasecmp("LION", battery->device_chemistry))\r\nreturn POWER_SUPPLY_TECHNOLOGY_LION;\r\nif (!strcasecmp("LiP", battery->device_chemistry))\r\nreturn POWER_SUPPLY_TECHNOLOGY_LIPO;\r\nreturn POWER_SUPPLY_TECHNOLOGY_UNKNOWN;\r\n}\r\nstatic int acpi_sbs_battery_get_property(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct acpi_battery *battery = to_acpi_battery(psy);\r\nif ((!battery->present) && psp != POWER_SUPPLY_PROP_PRESENT)\r\nreturn -ENODEV;\r\nacpi_battery_get_state(battery);\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nif (battery->rate_now < 0)\r\nval->intval = POWER_SUPPLY_STATUS_DISCHARGING;\r\nelse if (battery->rate_now > 0)\r\nval->intval = POWER_SUPPLY_STATUS_CHARGING;\r\nelse\r\nval->intval = POWER_SUPPLY_STATUS_FULL;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_PRESENT:\r\nval->intval = battery->present;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = acpi_battery_technology(battery);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CYCLE_COUNT:\r\nval->intval = battery->cycle_count;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_MIN_DESIGN:\r\nval->intval = battery->design_voltage *\r\nacpi_battery_vscale(battery) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nval->intval = battery->voltage_now *\r\nacpi_battery_vscale(battery) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_NOW:\r\ncase POWER_SUPPLY_PROP_POWER_NOW:\r\nval->intval = abs(battery->rate_now) *\r\nacpi_battery_ipscale(battery) * 1000;\r\nval->intval *= (acpi_battery_mode(battery)) ?\r\n(battery->voltage_now *\r\nacpi_battery_vscale(battery) / 1000) : 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CURRENT_AVG:\r\ncase POWER_SUPPLY_PROP_POWER_AVG:\r\nval->intval = abs(battery->rate_avg) *\r\nacpi_battery_ipscale(battery) * 1000;\r\nval->intval *= (acpi_battery_mode(battery)) ?\r\n(battery->voltage_now *\r\nacpi_battery_vscale(battery) / 1000) : 1;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CAPACITY:\r\nval->intval = battery->state_of_charge;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL_DESIGN:\r\ncase POWER_SUPPLY_PROP_ENERGY_FULL_DESIGN:\r\nval->intval = battery->design_capacity *\r\nacpi_battery_scale(battery) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_FULL:\r\ncase POWER_SUPPLY_PROP_ENERGY_FULL:\r\nval->intval = battery->full_charge_capacity *\r\nacpi_battery_scale(battery) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_NOW:\r\ncase POWER_SUPPLY_PROP_ENERGY_NOW:\r\nval->intval = battery->capacity_now *\r\nacpi_battery_scale(battery) * 1000;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TEMP:\r\nval->intval = battery->temp_now - 2730;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = battery->device_name;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = battery->manufacturer_name;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acpi_manager_get_info(struct acpi_sbs *sbs)\r\n{\r\nint result = 0;\r\nu16 battery_system_info;\r\nresult = acpi_smbus_read(sbs->hc, SMBUS_READ_WORD, ACPI_SBS_MANAGER,\r\n0x04, (u8 *)&battery_system_info);\r\nif (!result)\r\nsbs->batteries_supported = battery_system_info & 0x000f;\r\nreturn result;\r\n}\r\nstatic int acpi_battery_get_info(struct acpi_battery *battery)\r\n{\r\nint i, result = 0;\r\nfor (i = 0; i < ARRAY_SIZE(info_readers); ++i) {\r\nresult = acpi_smbus_read(battery->sbs->hc,\r\ninfo_readers[i].mode,\r\nACPI_SBS_BATTERY,\r\ninfo_readers[i].command,\r\n(u8 *) battery +\r\ninfo_readers[i].offset);\r\nif (result)\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nstatic int acpi_battery_get_state(struct acpi_battery *battery)\r\n{\r\nint i, result = 0;\r\nif (battery->update_time &&\r\ntime_before(jiffies, battery->update_time +\r\nmsecs_to_jiffies(cache_time)))\r\nreturn 0;\r\nfor (i = 0; i < ARRAY_SIZE(state_readers); ++i) {\r\nresult = acpi_smbus_read(battery->sbs->hc,\r\nstate_readers[i].mode,\r\nACPI_SBS_BATTERY,\r\nstate_readers[i].command,\r\n(u8 *)battery +\r\nstate_readers[i].offset);\r\nif (result)\r\ngoto end;\r\n}\r\nend:\r\nbattery->update_time = jiffies;\r\nreturn result;\r\n}\r\nstatic int acpi_battery_get_alarm(struct acpi_battery *battery)\r\n{\r\nreturn acpi_smbus_read(battery->sbs->hc, SMBUS_READ_WORD,\r\nACPI_SBS_BATTERY, 0x01,\r\n(u8 *)&battery->alarm_capacity);\r\n}\r\nstatic int acpi_battery_set_alarm(struct acpi_battery *battery)\r\n{\r\nstruct acpi_sbs *sbs = battery->sbs;\r\nu16 value, sel = 1 << (battery->id + 12);\r\nint ret;\r\nif (sbs->manager_present) {\r\nret = acpi_smbus_read(sbs->hc, SMBUS_READ_WORD, ACPI_SBS_MANAGER,\r\n0x01, (u8 *)&value);\r\nif (ret)\r\ngoto end;\r\nif ((value & 0xf000) != sel) {\r\nvalue &= 0x0fff;\r\nvalue |= sel;\r\nret = acpi_smbus_write(sbs->hc, SMBUS_WRITE_WORD,\r\nACPI_SBS_MANAGER,\r\n0x01, (u8 *)&value, 2);\r\nif (ret)\r\ngoto end;\r\n}\r\n}\r\nret = acpi_smbus_write(sbs->hc, SMBUS_WRITE_WORD, ACPI_SBS_BATTERY,\r\n0x01, (u8 *)&battery->alarm_capacity, 2);\r\nend:\r\nreturn ret;\r\n}\r\nstatic int acpi_ac_get_present(struct acpi_sbs *sbs)\r\n{\r\nint result;\r\nu16 status;\r\nresult = acpi_smbus_read(sbs->hc, SMBUS_READ_WORD, ACPI_SBS_CHARGER,\r\n0x13, (u8 *) & status);\r\nif (result)\r\nreturn result;\r\nif (!((status >> 4) & 0x1))\r\nreturn -ENODEV;\r\nsbs->charger_present = (status >> 15) & 0x1;\r\nreturn 0;\r\n}\r\nstatic ssize_t acpi_battery_alarm_show(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct acpi_battery *battery = to_acpi_battery(dev_get_drvdata(dev));\r\nacpi_battery_get_alarm(battery);\r\nreturn sprintf(buf, "%d\n", battery->alarm_capacity *\r\nacpi_battery_scale(battery) * 1000);\r\n}\r\nstatic ssize_t acpi_battery_alarm_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nunsigned long x;\r\nstruct acpi_battery *battery = to_acpi_battery(dev_get_drvdata(dev));\r\nif (sscanf(buf, "%lu\n", &x) == 1)\r\nbattery->alarm_capacity = x /\r\n(1000 * acpi_battery_scale(battery));\r\nif (battery->present)\r\nacpi_battery_set_alarm(battery);\r\nreturn count;\r\n}\r\nstatic int acpi_battery_read(struct acpi_battery *battery)\r\n{\r\nint result = 0, saved_present = battery->present;\r\nu16 state;\r\nif (battery->sbs->manager_present) {\r\nresult = acpi_smbus_read(battery->sbs->hc, SMBUS_READ_WORD,\r\nACPI_SBS_MANAGER, 0x01, (u8 *)&state);\r\nif (!result)\r\nbattery->present = state & (1 << battery->id);\r\nstate &= 0x0fff;\r\nstate |= 1 << (battery->id + 12);\r\nacpi_smbus_write(battery->sbs->hc, SMBUS_WRITE_WORD,\r\nACPI_SBS_MANAGER, 0x01, (u8 *)&state, 2);\r\n} else if (battery->id == 0)\r\nbattery->present = 1;\r\nif (result || !battery->present)\r\nreturn result;\r\nif (saved_present != battery->present) {\r\nbattery->update_time = 0;\r\nresult = acpi_battery_get_info(battery);\r\nif (result) {\r\nbattery->present = 0;\r\nreturn result;\r\n}\r\n}\r\nresult = acpi_battery_get_state(battery);\r\nif (result)\r\nbattery->present = 0;\r\nreturn result;\r\n}\r\nstatic int acpi_battery_add(struct acpi_sbs *sbs, int id)\r\n{\r\nstruct acpi_battery *battery = &sbs->battery[id];\r\nint result;\r\nbattery->id = id;\r\nbattery->sbs = sbs;\r\nresult = acpi_battery_read(battery);\r\nif (result)\r\nreturn result;\r\nsprintf(battery->name, ACPI_BATTERY_DIR_NAME, id);\r\nbattery->bat.name = battery->name;\r\nbattery->bat.type = POWER_SUPPLY_TYPE_BATTERY;\r\nif (!acpi_battery_mode(battery)) {\r\nbattery->bat.properties = sbs_charge_battery_props;\r\nbattery->bat.num_properties =\r\nARRAY_SIZE(sbs_charge_battery_props);\r\n} else {\r\nbattery->bat.properties = sbs_energy_battery_props;\r\nbattery->bat.num_properties =\r\nARRAY_SIZE(sbs_energy_battery_props);\r\n}\r\nbattery->bat.get_property = acpi_sbs_battery_get_property;\r\nresult = power_supply_register(&sbs->device->dev, &battery->bat);\r\nif (result)\r\ngoto end;\r\nresult = device_create_file(battery->bat.dev, &alarm_attr);\r\nif (result)\r\ngoto end;\r\nbattery->have_sysfs_alarm = 1;\r\nend:\r\nprintk(KERN_INFO PREFIX "%s [%s]: Battery Slot [%s] (battery %s)\n",\r\nACPI_SBS_DEVICE_NAME, acpi_device_bid(sbs->device),\r\nbattery->name, battery->present ? "present" : "absent");\r\nreturn result;\r\n}\r\nstatic void acpi_battery_remove(struct acpi_sbs *sbs, int id)\r\n{\r\nstruct acpi_battery *battery = &sbs->battery[id];\r\nif (battery->bat.dev) {\r\nif (battery->have_sysfs_alarm)\r\ndevice_remove_file(battery->bat.dev, &alarm_attr);\r\npower_supply_unregister(&battery->bat);\r\n}\r\n}\r\nstatic int acpi_charger_add(struct acpi_sbs *sbs)\r\n{\r\nint result;\r\nresult = acpi_ac_get_present(sbs);\r\nif (result)\r\ngoto end;\r\nsbs->charger_exists = 1;\r\nsbs->charger.name = "sbs-charger";\r\nsbs->charger.type = POWER_SUPPLY_TYPE_MAINS;\r\nsbs->charger.properties = sbs_ac_props;\r\nsbs->charger.num_properties = ARRAY_SIZE(sbs_ac_props);\r\nsbs->charger.get_property = sbs_get_ac_property;\r\npower_supply_register(&sbs->device->dev, &sbs->charger);\r\nprintk(KERN_INFO PREFIX "%s [%s]: AC Adapter [%s] (%s)\n",\r\nACPI_SBS_DEVICE_NAME, acpi_device_bid(sbs->device),\r\nACPI_AC_DIR_NAME, sbs->charger_present ? "on-line" : "off-line");\r\nend:\r\nreturn result;\r\n}\r\nstatic void acpi_charger_remove(struct acpi_sbs *sbs)\r\n{\r\nif (sbs->charger.dev)\r\npower_supply_unregister(&sbs->charger);\r\n}\r\nstatic void acpi_sbs_callback(void *context)\r\n{\r\nint id;\r\nstruct acpi_sbs *sbs = context;\r\nstruct acpi_battery *bat;\r\nu8 saved_charger_state = sbs->charger_present;\r\nu8 saved_battery_state;\r\nif (sbs->charger_exists) {\r\nacpi_ac_get_present(sbs);\r\nif (sbs->charger_present != saved_charger_state)\r\nkobject_uevent(&sbs->charger.dev->kobj, KOBJ_CHANGE);\r\n}\r\nif (sbs->manager_present) {\r\nfor (id = 0; id < MAX_SBS_BAT; ++id) {\r\nif (!(sbs->batteries_supported & (1 << id)))\r\ncontinue;\r\nbat = &sbs->battery[id];\r\nsaved_battery_state = bat->present;\r\nacpi_battery_read(bat);\r\nif (saved_battery_state == bat->present)\r\ncontinue;\r\nkobject_uevent(&bat->bat.dev->kobj, KOBJ_CHANGE);\r\n}\r\n}\r\n}\r\nstatic int disable_sbs_manager(const struct dmi_system_id *d)\r\n{\r\nsbs_manager_broken = true;\r\nreturn 0;\r\n}\r\nstatic int acpi_sbs_add(struct acpi_device *device)\r\n{\r\nstruct acpi_sbs *sbs;\r\nint result = 0;\r\nint id;\r\ndmi_check_system(acpi_sbs_dmi_table);\r\nsbs = kzalloc(sizeof(struct acpi_sbs), GFP_KERNEL);\r\nif (!sbs) {\r\nresult = -ENOMEM;\r\ngoto end;\r\n}\r\nmutex_init(&sbs->lock);\r\nsbs->hc = acpi_driver_data(device->parent);\r\nsbs->device = device;\r\nstrcpy(acpi_device_name(device), ACPI_SBS_DEVICE_NAME);\r\nstrcpy(acpi_device_class(device), ACPI_SBS_CLASS);\r\ndevice->driver_data = sbs;\r\nresult = acpi_charger_add(sbs);\r\nif (result && result != -ENODEV)\r\ngoto end;\r\nresult = 0;\r\nif (!sbs_manager_broken) {\r\nresult = acpi_manager_get_info(sbs);\r\nif (!result) {\r\nsbs->manager_present = 0;\r\nfor (id = 0; id < MAX_SBS_BAT; ++id)\r\nif ((sbs->batteries_supported & (1 << id)))\r\nacpi_battery_add(sbs, id);\r\n}\r\n}\r\nif (!sbs->manager_present)\r\nacpi_battery_add(sbs, 0);\r\nacpi_smbus_register_callback(sbs->hc, acpi_sbs_callback, sbs);\r\nend:\r\nif (result)\r\nacpi_sbs_remove(device);\r\nreturn result;\r\n}\r\nstatic int acpi_sbs_remove(struct acpi_device *device)\r\n{\r\nstruct acpi_sbs *sbs;\r\nint id;\r\nif (!device)\r\nreturn -EINVAL;\r\nsbs = acpi_driver_data(device);\r\nif (!sbs)\r\nreturn -EINVAL;\r\nmutex_lock(&sbs->lock);\r\nacpi_smbus_unregister_callback(sbs->hc);\r\nfor (id = 0; id < MAX_SBS_BAT; ++id)\r\nacpi_battery_remove(sbs, id);\r\nacpi_charger_remove(sbs);\r\nmutex_unlock(&sbs->lock);\r\nmutex_destroy(&sbs->lock);\r\nkfree(sbs);\r\nreturn 0;\r\n}\r\nstatic int acpi_sbs_resume(struct device *dev)\r\n{\r\nstruct acpi_sbs *sbs;\r\nif (!dev)\r\nreturn -EINVAL;\r\nsbs = to_acpi_device(dev)->driver_data;\r\nacpi_sbs_callback(sbs);\r\nreturn 0;\r\n}\r\nstatic int __init acpi_sbs_init(void)\r\n{\r\nint result = 0;\r\nif (acpi_disabled)\r\nreturn -ENODEV;\r\nresult = acpi_bus_register_driver(&acpi_sbs_driver);\r\nif (result < 0)\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic void __exit acpi_sbs_exit(void)\r\n{\r\nacpi_bus_unregister_driver(&acpi_sbs_driver);\r\nreturn;\r\n}

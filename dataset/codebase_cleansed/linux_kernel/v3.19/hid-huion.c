static __u8 *huion_report_fixup(struct hid_device *hdev, __u8 *rdesc,\r\nunsigned int *rsize)\r\n{\r\nstruct huion_drvdata *drvdata = hid_get_drvdata(hdev);\r\nswitch (hdev->product) {\r\ncase USB_DEVICE_ID_HUION_TABLET:\r\nif (drvdata->rdesc != NULL) {\r\nrdesc = drvdata->rdesc;\r\n*rsize = drvdata->rsize;\r\n}\r\nbreak;\r\n}\r\nreturn rdesc;\r\n}\r\nstatic int huion_tablet_enable(struct hid_device *hdev)\r\n{\r\nint rc;\r\nstruct usb_device *usb_dev = hid_to_usb_dev(hdev);\r\nstruct huion_drvdata *drvdata = hid_get_drvdata(hdev);\r\n__le16 *buf = NULL;\r\nsize_t len;\r\ns32 params[HUION_PH_ID_NUM];\r\ns32 resolution;\r\n__u8 *p;\r\ns32 v;\r\nlen = HUION_PRM_NUM * sizeof(*buf);\r\nbuf = kmalloc(len, GFP_KERNEL);\r\nif (buf == NULL) {\r\nhid_err(hdev, "failed to allocate parameter buffer\n");\r\nrc = -ENOMEM;\r\ngoto cleanup;\r\n}\r\nrc = usb_control_msg(usb_dev, usb_rcvctrlpipe(usb_dev, 0),\r\nUSB_REQ_GET_DESCRIPTOR, USB_DIR_IN,\r\n(USB_DT_STRING << 8) + 0x64,\r\n0x0409, buf, len,\r\nUSB_CTRL_GET_TIMEOUT);\r\nif (rc == -EPIPE) {\r\nhid_err(hdev, "device parameters not found\n");\r\nrc = -ENODEV;\r\ngoto cleanup;\r\n} else if (rc < 0) {\r\nhid_err(hdev, "failed to get device parameters: %d\n", rc);\r\nrc = -ENODEV;\r\ngoto cleanup;\r\n} else if (rc != len) {\r\nhid_err(hdev, "invalid device parameters\n");\r\nrc = -ENODEV;\r\ngoto cleanup;\r\n}\r\nparams[HUION_PH_ID_X_LM] = le16_to_cpu(buf[HUION_PRM_X_LM]);\r\nparams[HUION_PH_ID_Y_LM] = le16_to_cpu(buf[HUION_PRM_Y_LM]);\r\nparams[HUION_PH_ID_PRESSURE_LM] =\r\nle16_to_cpu(buf[HUION_PRM_PRESSURE_LM]);\r\nresolution = le16_to_cpu(buf[HUION_PRM_RESOLUTION]);\r\nif (resolution == 0) {\r\nparams[HUION_PH_ID_X_PM] = 0;\r\nparams[HUION_PH_ID_Y_PM] = 0;\r\n} else {\r\nparams[HUION_PH_ID_X_PM] = params[HUION_PH_ID_X_LM] *\r\n1000 / resolution;\r\nparams[HUION_PH_ID_Y_PM] = params[HUION_PH_ID_Y_LM] *\r\n1000 / resolution;\r\n}\r\ndrvdata->rdesc = devm_kmalloc(&hdev->dev,\r\nsizeof(huion_tablet_rdesc_template),\r\nGFP_KERNEL);\r\nif (drvdata->rdesc == NULL) {\r\nhid_err(hdev, "failed to allocate fixed rdesc\n");\r\nrc = -ENOMEM;\r\ngoto cleanup;\r\n}\r\ndrvdata->rsize = sizeof(huion_tablet_rdesc_template);\r\nmemcpy(drvdata->rdesc, huion_tablet_rdesc_template,\r\ndrvdata->rsize);\r\nfor (p = drvdata->rdesc;\r\np <= drvdata->rdesc + drvdata->rsize - 4;) {\r\nif (p[0] == 0xFE && p[1] == 0xED && p[2] == 0x1D &&\r\np[3] < sizeof(params)) {\r\nv = params[p[3]];\r\nput_unaligned(cpu_to_le32(v), (s32 *)p);\r\np += 4;\r\n} else {\r\np++;\r\n}\r\n}\r\nrc = 0;\r\ncleanup:\r\nkfree(buf);\r\nreturn rc;\r\n}\r\nstatic int huion_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nint rc;\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct huion_drvdata *drvdata;\r\ndrvdata = devm_kzalloc(&hdev->dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (drvdata == NULL) {\r\nhid_err(hdev, "failed to allocate driver data\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, drvdata);\r\nswitch (id->product) {\r\ncase USB_DEVICE_ID_HUION_TABLET:\r\nif (intf->cur_altsetting->desc.bInterfaceNumber == 0) {\r\nrc = huion_tablet_enable(hdev);\r\nif (rc) {\r\nhid_err(hdev, "tablet enabling failed\n");\r\nreturn rc;\r\n}\r\n}\r\nbreak;\r\n}\r\nrc = hid_parse(hdev);\r\nif (rc) {\r\nhid_err(hdev, "parse failed\n");\r\nreturn rc;\r\n}\r\nrc = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (rc) {\r\nhid_err(hdev, "hw start failed\n");\r\nreturn rc;\r\n}\r\nreturn 0;\r\n}\r\nstatic int huion_raw_event(struct hid_device *hdev, struct hid_report *report,\r\nu8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nif (intf->cur_altsetting->desc.bInterfaceNumber == 0 &&\r\nreport->type == HID_INPUT_REPORT &&\r\nreport->id == 0x07 && size >= 2)\r\ndata[1] ^= 0x40;\r\nreturn 0;\r\n}

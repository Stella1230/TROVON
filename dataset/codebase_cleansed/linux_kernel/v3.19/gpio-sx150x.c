static s32 sx150x_i2c_write(struct i2c_client *client, u8 reg, u8 val)\r\n{\r\ns32 err = i2c_smbus_write_byte_data(client, reg, val);\r\nif (err < 0)\r\ndev_warn(&client->dev,\r\n"i2c write fail: can't write %02x to %02x: %d\n",\r\nval, reg, err);\r\nreturn err;\r\n}\r\nstatic s32 sx150x_i2c_read(struct i2c_client *client, u8 reg, u8 *val)\r\n{\r\ns32 err = i2c_smbus_read_byte_data(client, reg);\r\nif (err >= 0)\r\n*val = err;\r\nelse\r\ndev_warn(&client->dev,\r\n"i2c read fail: can't read from %02x: %d\n",\r\nreg, err);\r\nreturn err;\r\n}\r\nstatic inline bool offset_is_oscio(struct sx150x_chip *chip, unsigned offset)\r\n{\r\nreturn (chip->dev_cfg->ngpios == offset);\r\n}\r\nstatic inline void sx150x_find_cfg(u8 offset, u8 width,\r\nu8 *reg, u8 *mask, u8 *shift)\r\n{\r\n*reg -= offset * width / 8;\r\n*mask = (1 << width) - 1;\r\n*shift = (offset * width) % 8;\r\n*mask <<= *shift;\r\n}\r\nstatic s32 sx150x_write_cfg(struct sx150x_chip *chip,\r\nu8 offset, u8 width, u8 reg, u8 val)\r\n{\r\nu8 mask;\r\nu8 data;\r\nu8 shift;\r\ns32 err;\r\nsx150x_find_cfg(offset, width, &reg, &mask, &shift);\r\nerr = sx150x_i2c_read(chip->client, reg, &data);\r\nif (err < 0)\r\nreturn err;\r\ndata &= ~mask;\r\ndata |= (val << shift) & mask;\r\nreturn sx150x_i2c_write(chip->client, reg, data);\r\n}\r\nstatic int sx150x_get_io(struct sx150x_chip *chip, unsigned offset)\r\n{\r\nu8 reg = chip->dev_cfg->reg_data;\r\nu8 mask;\r\nu8 data;\r\nu8 shift;\r\ns32 err;\r\nsx150x_find_cfg(offset, 1, &reg, &mask, &shift);\r\nerr = sx150x_i2c_read(chip->client, reg, &data);\r\nif (err >= 0)\r\nerr = (data & mask) != 0 ? 1 : 0;\r\nreturn err;\r\n}\r\nstatic void sx150x_set_oscio(struct sx150x_chip *chip, int val)\r\n{\r\nsx150x_i2c_write(chip->client,\r\nchip->dev_cfg->reg_clock,\r\n(val ? 0x1f : 0x10));\r\n}\r\nstatic void sx150x_set_io(struct sx150x_chip *chip, unsigned offset, int val)\r\n{\r\nsx150x_write_cfg(chip,\r\noffset,\r\n1,\r\nchip->dev_cfg->reg_data,\r\n(val ? 1 : 0));\r\n}\r\nstatic int sx150x_io_input(struct sx150x_chip *chip, unsigned offset)\r\n{\r\nreturn sx150x_write_cfg(chip,\r\noffset,\r\n1,\r\nchip->dev_cfg->reg_dir,\r\n1);\r\n}\r\nstatic int sx150x_io_output(struct sx150x_chip *chip, unsigned offset, int val)\r\n{\r\nint err;\r\nerr = sx150x_write_cfg(chip,\r\noffset,\r\n1,\r\nchip->dev_cfg->reg_data,\r\n(val ? 1 : 0));\r\nif (err >= 0)\r\nerr = sx150x_write_cfg(chip,\r\noffset,\r\n1,\r\nchip->dev_cfg->reg_dir,\r\n0);\r\nreturn err;\r\n}\r\nstatic int sx150x_gpio_get(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct sx150x_chip *chip;\r\nint status = -EINVAL;\r\nchip = container_of(gc, struct sx150x_chip, gpio_chip);\r\nif (!offset_is_oscio(chip, offset)) {\r\nmutex_lock(&chip->lock);\r\nstatus = sx150x_get_io(chip, offset);\r\nmutex_unlock(&chip->lock);\r\n}\r\nreturn status;\r\n}\r\nstatic void sx150x_gpio_set(struct gpio_chip *gc, unsigned offset, int val)\r\n{\r\nstruct sx150x_chip *chip;\r\nchip = container_of(gc, struct sx150x_chip, gpio_chip);\r\nmutex_lock(&chip->lock);\r\nif (offset_is_oscio(chip, offset))\r\nsx150x_set_oscio(chip, val);\r\nelse\r\nsx150x_set_io(chip, offset, val);\r\nmutex_unlock(&chip->lock);\r\n}\r\nstatic int sx150x_gpio_direction_input(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct sx150x_chip *chip;\r\nint status = -EINVAL;\r\nchip = container_of(gc, struct sx150x_chip, gpio_chip);\r\nif (!offset_is_oscio(chip, offset)) {\r\nmutex_lock(&chip->lock);\r\nstatus = sx150x_io_input(chip, offset);\r\nmutex_unlock(&chip->lock);\r\n}\r\nreturn status;\r\n}\r\nstatic int sx150x_gpio_direction_output(struct gpio_chip *gc,\r\nunsigned offset,\r\nint val)\r\n{\r\nstruct sx150x_chip *chip;\r\nint status = 0;\r\nchip = container_of(gc, struct sx150x_chip, gpio_chip);\r\nif (!offset_is_oscio(chip, offset)) {\r\nmutex_lock(&chip->lock);\r\nstatus = sx150x_io_output(chip, offset, val);\r\nmutex_unlock(&chip->lock);\r\n}\r\nreturn status;\r\n}\r\nstatic int sx150x_gpio_to_irq(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct sx150x_chip *chip;\r\nchip = container_of(gc, struct sx150x_chip, gpio_chip);\r\nif (offset >= chip->dev_cfg->ngpios)\r\nreturn -EINVAL;\r\nif (chip->irq_base < 0)\r\nreturn -EINVAL;\r\nreturn chip->irq_base + offset;\r\n}\r\nstatic void sx150x_irq_mask(struct irq_data *d)\r\n{\r\nstruct sx150x_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned n;\r\nn = d->irq - chip->irq_base;\r\nchip->irq_masked |= (1 << n);\r\nchip->irq_update = n;\r\n}\r\nstatic void sx150x_irq_unmask(struct irq_data *d)\r\n{\r\nstruct sx150x_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned n;\r\nn = d->irq - chip->irq_base;\r\nchip->irq_masked &= ~(1 << n);\r\nchip->irq_update = n;\r\n}\r\nstatic int sx150x_irq_set_type(struct irq_data *d, unsigned int flow_type)\r\n{\r\nstruct sx150x_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned n, val = 0;\r\nif (flow_type & (IRQ_TYPE_LEVEL_HIGH | IRQ_TYPE_LEVEL_LOW))\r\nreturn -EINVAL;\r\nn = d->irq - chip->irq_base;\r\nif (flow_type & IRQ_TYPE_EDGE_RISING)\r\nval |= 0x1;\r\nif (flow_type & IRQ_TYPE_EDGE_FALLING)\r\nval |= 0x2;\r\nchip->irq_sense &= ~(3UL << (n * 2));\r\nchip->irq_sense |= val << (n * 2);\r\nchip->irq_update = n;\r\nreturn 0;\r\n}\r\nstatic irqreturn_t sx150x_irq_thread_fn(int irq, void *dev_id)\r\n{\r\nstruct sx150x_chip *chip = (struct sx150x_chip *)dev_id;\r\nunsigned nhandled = 0;\r\nunsigned sub_irq;\r\nunsigned n;\r\ns32 err;\r\nu8 val;\r\nint i;\r\nfor (i = (chip->dev_cfg->ngpios / 8) - 1; i >= 0; --i) {\r\nerr = sx150x_i2c_read(chip->client,\r\nchip->dev_cfg->reg_irq_src - i,\r\n&val);\r\nif (err < 0)\r\ncontinue;\r\nsx150x_i2c_write(chip->client,\r\nchip->dev_cfg->reg_irq_src - i,\r\nval);\r\nfor (n = 0; n < 8; ++n) {\r\nif (val & (1 << n)) {\r\nsub_irq = chip->irq_base + (i * 8) + n;\r\nhandle_nested_irq(sub_irq);\r\n++nhandled;\r\n}\r\n}\r\n}\r\nreturn (nhandled > 0 ? IRQ_HANDLED : IRQ_NONE);\r\n}\r\nstatic void sx150x_irq_bus_lock(struct irq_data *d)\r\n{\r\nstruct sx150x_chip *chip = irq_data_get_irq_chip_data(d);\r\nmutex_lock(&chip->lock);\r\n}\r\nstatic void sx150x_irq_bus_sync_unlock(struct irq_data *d)\r\n{\r\nstruct sx150x_chip *chip = irq_data_get_irq_chip_data(d);\r\nunsigned n;\r\nif (chip->irq_update == NO_UPDATE_PENDING)\r\ngoto out;\r\nn = chip->irq_update;\r\nchip->irq_update = NO_UPDATE_PENDING;\r\nif (chip->dev_sense == chip->irq_sense &&\r\nchip->dev_sense == chip->irq_masked)\r\ngoto out;\r\nchip->dev_sense = chip->irq_sense;\r\nchip->dev_masked = chip->irq_masked;\r\nif (chip->irq_masked & (1 << n)) {\r\nsx150x_write_cfg(chip, n, 1, chip->dev_cfg->reg_irq_mask, 1);\r\nsx150x_write_cfg(chip, n, 2, chip->dev_cfg->reg_sense, 0);\r\n} else {\r\nsx150x_write_cfg(chip, n, 1, chip->dev_cfg->reg_irq_mask, 0);\r\nsx150x_write_cfg(chip, n, 2, chip->dev_cfg->reg_sense,\r\nchip->irq_sense >> (n * 2));\r\n}\r\nout:\r\nmutex_unlock(&chip->lock);\r\n}\r\nstatic void sx150x_init_chip(struct sx150x_chip *chip,\r\nstruct i2c_client *client,\r\nkernel_ulong_t driver_data,\r\nstruct sx150x_platform_data *pdata)\r\n{\r\nmutex_init(&chip->lock);\r\nchip->client = client;\r\nchip->dev_cfg = &sx150x_devices[driver_data];\r\nchip->gpio_chip.label = client->name;\r\nchip->gpio_chip.direction_input = sx150x_gpio_direction_input;\r\nchip->gpio_chip.direction_output = sx150x_gpio_direction_output;\r\nchip->gpio_chip.get = sx150x_gpio_get;\r\nchip->gpio_chip.set = sx150x_gpio_set;\r\nchip->gpio_chip.to_irq = sx150x_gpio_to_irq;\r\nchip->gpio_chip.base = pdata->gpio_base;\r\nchip->gpio_chip.can_sleep = true;\r\nchip->gpio_chip.ngpio = chip->dev_cfg->ngpios;\r\nif (pdata->oscio_is_gpo)\r\n++chip->gpio_chip.ngpio;\r\nchip->irq_chip.name = client->name;\r\nchip->irq_chip.irq_mask = sx150x_irq_mask;\r\nchip->irq_chip.irq_unmask = sx150x_irq_unmask;\r\nchip->irq_chip.irq_set_type = sx150x_irq_set_type;\r\nchip->irq_chip.irq_bus_lock = sx150x_irq_bus_lock;\r\nchip->irq_chip.irq_bus_sync_unlock = sx150x_irq_bus_sync_unlock;\r\nchip->irq_summary = -1;\r\nchip->irq_base = -1;\r\nchip->irq_masked = ~0;\r\nchip->irq_sense = 0;\r\nchip->dev_masked = ~0;\r\nchip->dev_sense = 0;\r\nchip->irq_update = NO_UPDATE_PENDING;\r\n}\r\nstatic int sx150x_init_io(struct sx150x_chip *chip, u8 base, u16 cfg)\r\n{\r\nint err = 0;\r\nunsigned n;\r\nfor (n = 0; err >= 0 && n < (chip->dev_cfg->ngpios / 8); ++n)\r\nerr = sx150x_i2c_write(chip->client, base - n, cfg >> (n * 8));\r\nreturn err;\r\n}\r\nstatic int sx150x_reset(struct sx150x_chip *chip)\r\n{\r\nint err;\r\nerr = i2c_smbus_write_byte_data(chip->client,\r\nchip->dev_cfg->reg_reset,\r\n0x12);\r\nif (err < 0)\r\nreturn err;\r\nerr = i2c_smbus_write_byte_data(chip->client,\r\nchip->dev_cfg->reg_reset,\r\n0x34);\r\nreturn err;\r\n}\r\nstatic int sx150x_init_hw(struct sx150x_chip *chip,\r\nstruct sx150x_platform_data *pdata)\r\n{\r\nint err = 0;\r\nif (pdata->reset_during_probe) {\r\nerr = sx150x_reset(chip);\r\nif (err < 0)\r\nreturn err;\r\n}\r\nerr = sx150x_i2c_write(chip->client,\r\nchip->dev_cfg->reg_misc,\r\n0x01);\r\nif (err < 0)\r\nreturn err;\r\nerr = sx150x_init_io(chip, chip->dev_cfg->reg_pullup,\r\npdata->io_pullup_ena);\r\nif (err < 0)\r\nreturn err;\r\nerr = sx150x_init_io(chip, chip->dev_cfg->reg_pulldn,\r\npdata->io_pulldn_ena);\r\nif (err < 0)\r\nreturn err;\r\nerr = sx150x_init_io(chip, chip->dev_cfg->reg_drain,\r\npdata->io_open_drain_ena);\r\nif (err < 0)\r\nreturn err;\r\nerr = sx150x_init_io(chip, chip->dev_cfg->reg_polarity,\r\npdata->io_polarity);\r\nif (err < 0)\r\nreturn err;\r\nif (pdata->oscio_is_gpo)\r\nsx150x_set_oscio(chip, 0);\r\nreturn err;\r\n}\r\nstatic int sx150x_install_irq_chip(struct sx150x_chip *chip,\r\nint irq_summary,\r\nint irq_base)\r\n{\r\nint err;\r\nunsigned n;\r\nunsigned irq;\r\nchip->irq_summary = irq_summary;\r\nchip->irq_base = irq_base;\r\nfor (n = 0; n < chip->dev_cfg->ngpios; ++n) {\r\nirq = irq_base + n;\r\nirq_set_chip_data(irq, chip);\r\nirq_set_chip_and_handler(irq, &chip->irq_chip, handle_edge_irq);\r\nirq_set_nested_thread(irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(irq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(irq);\r\n#endif\r\n}\r\nerr = devm_request_threaded_irq(&chip->client->dev,\r\nirq_summary,\r\nNULL,\r\nsx150x_irq_thread_fn,\r\nIRQF_SHARED | IRQF_TRIGGER_FALLING,\r\nchip->irq_chip.name,\r\nchip);\r\nif (err < 0) {\r\nchip->irq_summary = -1;\r\nchip->irq_base = -1;\r\n}\r\nreturn err;\r\n}\r\nstatic void sx150x_remove_irq_chip(struct sx150x_chip *chip)\r\n{\r\nunsigned n;\r\nunsigned irq;\r\nfor (n = 0; n < chip->dev_cfg->ngpios; ++n) {\r\nirq = chip->irq_base + n;\r\nirq_set_chip_and_handler(irq, NULL, NULL);\r\n}\r\n}\r\nstatic int sx150x_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstatic const u32 i2c_funcs = I2C_FUNC_SMBUS_BYTE_DATA |\r\nI2C_FUNC_SMBUS_WRITE_WORD_DATA;\r\nstruct sx150x_platform_data *pdata;\r\nstruct sx150x_chip *chip;\r\nint rc;\r\npdata = dev_get_platdata(&client->dev);\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (!i2c_check_functionality(client->adapter, i2c_funcs))\r\nreturn -ENOSYS;\r\nchip = devm_kzalloc(&client->dev,\r\nsizeof(struct sx150x_chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nsx150x_init_chip(chip, client, id->driver_data, pdata);\r\nrc = sx150x_init_hw(chip, pdata);\r\nif (rc < 0)\r\nreturn rc;\r\nrc = gpiochip_add(&chip->gpio_chip);\r\nif (rc)\r\nreturn rc;\r\nif (pdata->irq_summary >= 0) {\r\nrc = sx150x_install_irq_chip(chip,\r\npdata->irq_summary,\r\npdata->irq_base);\r\nif (rc < 0)\r\ngoto probe_fail_post_gpiochip_add;\r\n}\r\ni2c_set_clientdata(client, chip);\r\nreturn 0;\r\nprobe_fail_post_gpiochip_add:\r\ngpiochip_remove(&chip->gpio_chip);\r\nreturn rc;\r\n}\r\nstatic int sx150x_remove(struct i2c_client *client)\r\n{\r\nstruct sx150x_chip *chip;\r\nchip = i2c_get_clientdata(client);\r\ngpiochip_remove(&chip->gpio_chip);\r\nif (chip->irq_summary >= 0)\r\nsx150x_remove_irq_chip(chip);\r\nreturn 0;\r\n}\r\nstatic int __init sx150x_init(void)\r\n{\r\nreturn i2c_add_driver(&sx150x_driver);\r\n}\r\nstatic void __exit sx150x_exit(void)\r\n{\r\nreturn i2c_del_driver(&sx150x_driver);\r\n}

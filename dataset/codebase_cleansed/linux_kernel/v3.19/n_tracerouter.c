static int n_tracerouter_open(struct tty_struct *tty)\r\n{\r\nint retval = -EEXIST;\r\nmutex_lock(&routelock);\r\nif (tr_data->opencalled == 0) {\r\ntr_data->kref_tty = tty_kref_get(tty);\r\nif (tr_data->kref_tty == NULL) {\r\nretval = -EFAULT;\r\n} else {\r\ntr_data->opencalled = 1;\r\ntty->disc_data = tr_data;\r\ntty->receive_room = RECEIVE_ROOM;\r\ntty_driver_flush_buffer(tty);\r\nretval = 0;\r\n}\r\n}\r\nmutex_unlock(&routelock);\r\nreturn retval;\r\n}\r\nstatic void n_tracerouter_close(struct tty_struct *tty)\r\n{\r\nstruct tracerouter_data *tptr = tty->disc_data;\r\nmutex_lock(&routelock);\r\nWARN_ON(tptr->kref_tty != tr_data->kref_tty);\r\ntty_driver_flush_buffer(tty);\r\ntty_kref_put(tr_data->kref_tty);\r\ntr_data->kref_tty = NULL;\r\ntr_data->opencalled = 0;\r\ntty->disc_data = NULL;\r\nmutex_unlock(&routelock);\r\n}\r\nstatic ssize_t n_tracerouter_read(struct tty_struct *tty, struct file *file,\r\nunsigned char __user *buf, size_t nr) {\r\nreturn -EINVAL;\r\n}\r\nstatic ssize_t n_tracerouter_write(struct tty_struct *tty, struct file *file,\r\nconst unsigned char *buf, size_t nr) {\r\nreturn -EINVAL;\r\n}\r\nstatic void n_tracerouter_receivebuf(struct tty_struct *tty,\r\nconst unsigned char *cp,\r\nchar *fp, int count)\r\n{\r\nmutex_lock(&routelock);\r\nn_tracesink_datadrain((u8 *) cp, count);\r\nmutex_unlock(&routelock);\r\n}\r\nstatic int __init n_tracerouter_init(void)\r\n{\r\nint retval;\r\ntr_data = kzalloc(sizeof(struct tracerouter_data), GFP_KERNEL);\r\nif (tr_data == NULL)\r\nreturn -ENOMEM;\r\nretval = tty_register_ldisc(N_TRACEROUTER, &tty_ptirouter_ldisc);\r\nif (retval < 0) {\r\npr_err("%s: Registration failed: %d\n", __func__, retval);\r\nkfree(tr_data);\r\n}\r\nreturn retval;\r\n}\r\nstatic void __exit n_tracerouter_exit(void)\r\n{\r\nint retval = tty_unregister_ldisc(N_TRACEROUTER);\r\nif (retval < 0)\r\npr_err("%s: Unregistration failed: %d\n", __func__, retval);\r\nelse\r\nkfree(tr_data);\r\n}

int dev_pm_opp_init_cpufreq_table(struct device *dev,\r\nstruct cpufreq_frequency_table **table)\r\n{\r\nstruct dev_pm_opp *opp;\r\nstruct cpufreq_frequency_table *freq_table = NULL;\r\nint i, max_opps, ret = 0;\r\nunsigned long rate;\r\nrcu_read_lock();\r\nmax_opps = dev_pm_opp_get_opp_count(dev);\r\nif (max_opps <= 0) {\r\nret = max_opps ? max_opps : -ENODATA;\r\ngoto out;\r\n}\r\nfreq_table = kcalloc((max_opps + 1), sizeof(*freq_table), GFP_ATOMIC);\r\nif (!freq_table) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nfor (i = 0, rate = 0; i < max_opps; i++, rate++) {\r\nopp = dev_pm_opp_find_freq_ceil(dev, &rate);\r\nif (IS_ERR(opp)) {\r\nret = PTR_ERR(opp);\r\ngoto out;\r\n}\r\nfreq_table[i].driver_data = i;\r\nfreq_table[i].frequency = rate / 1000;\r\n}\r\nfreq_table[i].driver_data = i;\r\nfreq_table[i].frequency = CPUFREQ_TABLE_END;\r\n*table = &freq_table[0];\r\nout:\r\nrcu_read_unlock();\r\nif (ret)\r\nkfree(freq_table);\r\nreturn ret;\r\n}\r\nvoid dev_pm_opp_free_cpufreq_table(struct device *dev,\r\nstruct cpufreq_frequency_table **table)\r\n{\r\nif (!table)\r\nreturn;\r\nkfree(*table);\r\n*table = NULL;\r\n}

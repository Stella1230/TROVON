static inline unsigned int msm6242_read(struct msm6242_priv *priv,\r\nunsigned int reg)\r\n{\r\nreturn __raw_readl(&priv->regs[reg]) & 0xf;\r\n}\r\nstatic inline void msm6242_write(struct msm6242_priv *priv, unsigned int val,\r\nunsigned int reg)\r\n{\r\n__raw_writel(val, &priv->regs[reg]);\r\n}\r\nstatic inline void msm6242_set(struct msm6242_priv *priv, unsigned int val,\r\nunsigned int reg)\r\n{\r\nmsm6242_write(priv, msm6242_read(priv, reg) | val, reg);\r\n}\r\nstatic inline void msm6242_clear(struct msm6242_priv *priv, unsigned int val,\r\nunsigned int reg)\r\n{\r\nmsm6242_write(priv, msm6242_read(priv, reg) & ~val, reg);\r\n}\r\nstatic void msm6242_lock(struct msm6242_priv *priv)\r\n{\r\nint cnt = 5;\r\nmsm6242_set(priv, MSM6242_CD_HOLD, MSM6242_CD);\r\nwhile ((msm6242_read(priv, MSM6242_CD) & MSM6242_CD_BUSY) && cnt) {\r\nmsm6242_clear(priv, MSM6242_CD_HOLD, MSM6242_CD);\r\nudelay(70);\r\nmsm6242_set(priv, MSM6242_CD_HOLD, MSM6242_CD);\r\ncnt--;\r\n}\r\nif (!cnt)\r\npr_warning("msm6242: timed out waiting for RTC (0x%x)\n",\r\nmsm6242_read(priv, MSM6242_CD));\r\n}\r\nstatic void msm6242_unlock(struct msm6242_priv *priv)\r\n{\r\nmsm6242_clear(priv, MSM6242_CD_HOLD, MSM6242_CD);\r\n}\r\nstatic int msm6242_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct msm6242_priv *priv = dev_get_drvdata(dev);\r\nmsm6242_lock(priv);\r\ntm->tm_sec = msm6242_read(priv, MSM6242_SECOND10) * 10 +\r\nmsm6242_read(priv, MSM6242_SECOND1);\r\ntm->tm_min = msm6242_read(priv, MSM6242_MINUTE10) * 10 +\r\nmsm6242_read(priv, MSM6242_MINUTE1);\r\ntm->tm_hour = (msm6242_read(priv, MSM6242_HOUR10 & 3)) * 10 +\r\nmsm6242_read(priv, MSM6242_HOUR1);\r\ntm->tm_mday = msm6242_read(priv, MSM6242_DAY10) * 10 +\r\nmsm6242_read(priv, MSM6242_DAY1);\r\ntm->tm_wday = msm6242_read(priv, MSM6242_WEEK);\r\ntm->tm_mon = msm6242_read(priv, MSM6242_MONTH10) * 10 +\r\nmsm6242_read(priv, MSM6242_MONTH1) - 1;\r\ntm->tm_year = msm6242_read(priv, MSM6242_YEAR10) * 10 +\r\nmsm6242_read(priv, MSM6242_YEAR1);\r\nif (tm->tm_year <= 69)\r\ntm->tm_year += 100;\r\nif (!(msm6242_read(priv, MSM6242_CF) & MSM6242_CF_24H)) {\r\nunsigned int pm = msm6242_read(priv, MSM6242_HOUR10) &\r\nMSM6242_HOUR10_PM;\r\nif (!pm && tm->tm_hour == 12)\r\ntm->tm_hour = 0;\r\nelse if (pm && tm->tm_hour != 12)\r\ntm->tm_hour += 12;\r\n}\r\nmsm6242_unlock(priv);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int msm6242_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct msm6242_priv *priv = dev_get_drvdata(dev);\r\nmsm6242_lock(priv);\r\nmsm6242_write(priv, tm->tm_sec / 10, MSM6242_SECOND10);\r\nmsm6242_write(priv, tm->tm_sec % 10, MSM6242_SECOND1);\r\nmsm6242_write(priv, tm->tm_min / 10, MSM6242_MINUTE10);\r\nmsm6242_write(priv, tm->tm_min % 10, MSM6242_MINUTE1);\r\nif (msm6242_read(priv, MSM6242_CF) & MSM6242_CF_24H)\r\nmsm6242_write(priv, tm->tm_hour / 10, MSM6242_HOUR10);\r\nelse if (tm->tm_hour >= 12)\r\nmsm6242_write(priv, MSM6242_HOUR10_PM + (tm->tm_hour - 12) / 10,\r\nMSM6242_HOUR10);\r\nelse\r\nmsm6242_write(priv, tm->tm_hour / 10, MSM6242_HOUR10);\r\nmsm6242_write(priv, tm->tm_hour % 10, MSM6242_HOUR1);\r\nmsm6242_write(priv, tm->tm_mday / 10, MSM6242_DAY10);\r\nmsm6242_write(priv, tm->tm_mday % 10, MSM6242_DAY1);\r\nif (tm->tm_wday != -1)\r\nmsm6242_write(priv, tm->tm_wday, MSM6242_WEEK);\r\nmsm6242_write(priv, (tm->tm_mon + 1) / 10, MSM6242_MONTH10);\r\nmsm6242_write(priv, (tm->tm_mon + 1) % 10, MSM6242_MONTH1);\r\nif (tm->tm_year >= 100)\r\ntm->tm_year -= 100;\r\nmsm6242_write(priv, tm->tm_year / 10, MSM6242_YEAR10);\r\nmsm6242_write(priv, tm->tm_year % 10, MSM6242_YEAR1);\r\nmsm6242_unlock(priv);\r\nreturn 0;\r\n}\r\nstatic int __init msm6242_rtc_probe(struct platform_device *dev)\r\n{\r\nstruct resource *res;\r\nstruct msm6242_priv *priv;\r\nstruct rtc_device *rtc;\r\nint error;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\npriv->regs = ioremap(res->start, resource_size(res));\r\nif (!priv->regs) {\r\nerror = -ENOMEM;\r\ngoto out_free_priv;\r\n}\r\nplatform_set_drvdata(dev, priv);\r\nrtc = rtc_device_register("rtc-msm6242", &dev->dev, &msm6242_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nerror = PTR_ERR(rtc);\r\ngoto out_unmap;\r\n}\r\npriv->rtc = rtc;\r\nreturn 0;\r\nout_unmap:\r\nplatform_set_drvdata(dev, NULL);\r\niounmap(priv->regs);\r\nout_free_priv:\r\nkfree(priv);\r\nreturn error;\r\n}\r\nstatic int __exit msm6242_rtc_remove(struct platform_device *dev)\r\n{\r\nstruct msm6242_priv *priv = platform_get_drvdata(dev);\r\nrtc_device_unregister(priv->rtc);\r\niounmap(priv->regs);\r\nkfree(priv);\r\nreturn 0;\r\n}\r\nstatic int __init msm6242_rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&msm6242_rtc_driver, msm6242_rtc_probe);\r\n}\r\nstatic void __exit msm6242_rtc_fini(void)\r\n{\r\nplatform_driver_unregister(&msm6242_rtc_driver);\r\n}

ssize_t vfio_pci_io_readwrite(struct vfio_pci_device *vdev, char __user *buf,\r\nsize_t count, loff_t *ppos, bool iswrite)\r\n{\r\nstruct pci_dev *pdev = vdev->pdev;\r\nloff_t pos = *ppos & VFIO_PCI_OFFSET_MASK;\r\nint bar = VFIO_PCI_OFFSET_TO_INDEX(*ppos);\r\nvoid __iomem *io;\r\nsize_t done = 0;\r\nif (!pci_resource_start(pdev, bar))\r\nreturn -EINVAL;\r\nif (pos + count > pci_resource_len(pdev, bar))\r\nreturn -EINVAL;\r\nif (!vdev->barmap[bar]) {\r\nint ret;\r\nret = pci_request_selected_regions(pdev, 1 << bar, "vfio");\r\nif (ret)\r\nreturn ret;\r\nvdev->barmap[bar] = pci_iomap(pdev, bar, 0);\r\nif (!vdev->barmap[bar]) {\r\npci_release_selected_regions(pdev, 1 << bar);\r\nreturn -EINVAL;\r\n}\r\n}\r\nio = vdev->barmap[bar];\r\nwhile (count) {\r\nint filled;\r\nif (count >= 3 && !(pos % 4)) {\r\n__le32 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 4))\r\nreturn -EFAULT;\r\niowrite32(le32_to_cpu(val), io + pos);\r\n} else {\r\nval = cpu_to_le32(ioread32(io + pos));\r\nif (copy_to_user(buf, &val, 4))\r\nreturn -EFAULT;\r\n}\r\nfilled = 4;\r\n} else if ((pos % 2) == 0 && count >= 2) {\r\n__le16 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 2))\r\nreturn -EFAULT;\r\niowrite16(le16_to_cpu(val), io + pos);\r\n} else {\r\nval = cpu_to_le16(ioread16(io + pos));\r\nif (copy_to_user(buf, &val, 2))\r\nreturn -EFAULT;\r\n}\r\nfilled = 2;\r\n} else {\r\nu8 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 1))\r\nreturn -EFAULT;\r\niowrite8(val, io + pos);\r\n} else {\r\nval = ioread8(io + pos);\r\nif (copy_to_user(buf, &val, 1))\r\nreturn -EFAULT;\r\n}\r\nfilled = 1;\r\n}\r\ncount -= filled;\r\ndone += filled;\r\nbuf += filled;\r\npos += filled;\r\n}\r\n*ppos += done;\r\nreturn done;\r\n}\r\nssize_t vfio_pci_mem_readwrite(struct vfio_pci_device *vdev, char __user *buf,\r\nsize_t count, loff_t *ppos, bool iswrite)\r\n{\r\nstruct pci_dev *pdev = vdev->pdev;\r\nloff_t pos = *ppos & VFIO_PCI_OFFSET_MASK;\r\nint bar = VFIO_PCI_OFFSET_TO_INDEX(*ppos);\r\nvoid __iomem *io;\r\nresource_size_t end;\r\nsize_t done = 0;\r\nsize_t x_start = 0, x_end = 0;\r\nif (!pci_resource_start(pdev, bar))\r\nreturn -EINVAL;\r\nend = pci_resource_len(pdev, bar);\r\nif (pos > end)\r\nreturn -EINVAL;\r\nif (pos == end)\r\nreturn 0;\r\nif (pos + count > end)\r\ncount = end - pos;\r\nif (bar == PCI_ROM_RESOURCE) {\r\nio = pci_map_rom(pdev, &x_start);\r\nx_end = end;\r\n} else {\r\nif (!vdev->barmap[bar]) {\r\nint ret;\r\nret = pci_request_selected_regions(pdev, 1 << bar,\r\n"vfio");\r\nif (ret)\r\nreturn ret;\r\nvdev->barmap[bar] = pci_iomap(pdev, bar, 0);\r\nif (!vdev->barmap[bar]) {\r\npci_release_selected_regions(pdev, 1 << bar);\r\nreturn -EINVAL;\r\n}\r\n}\r\nio = vdev->barmap[bar];\r\nif (bar == vdev->msix_bar) {\r\nx_start = vdev->msix_offset;\r\nx_end = vdev->msix_offset + vdev->msix_size;\r\n}\r\n}\r\nif (!io)\r\nreturn -EINVAL;\r\nwhile (count) {\r\nsize_t fillable, filled;\r\nif (pos < x_start)\r\nfillable = x_start - pos;\r\nelse if (pos >= x_end)\r\nfillable = end - pos;\r\nelse\r\nfillable = 0;\r\nif (fillable >= 4 && !(pos % 4) && (count >= 4)) {\r\n__le32 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 4))\r\ngoto out;\r\niowrite32(le32_to_cpu(val), io + pos);\r\n} else {\r\nval = cpu_to_le32(ioread32(io + pos));\r\nif (copy_to_user(buf, &val, 4))\r\ngoto out;\r\n}\r\nfilled = 4;\r\n} else if (fillable >= 2 && !(pos % 2) && (count >= 2)) {\r\n__le16 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 2))\r\ngoto out;\r\niowrite16(le16_to_cpu(val), io + pos);\r\n} else {\r\nval = cpu_to_le16(ioread16(io + pos));\r\nif (copy_to_user(buf, &val, 2))\r\ngoto out;\r\n}\r\nfilled = 2;\r\n} else if (fillable) {\r\nu8 val;\r\nif (iswrite) {\r\nif (copy_from_user(&val, buf, 1))\r\ngoto out;\r\niowrite8(val, io + pos);\r\n} else {\r\nval = ioread8(io + pos);\r\nif (copy_to_user(buf, &val, 1))\r\ngoto out;\r\n}\r\nfilled = 1;\r\n} else {\r\nif (!iswrite) {\r\nchar val = 0xFF;\r\nsize_t i;\r\nfor (i = 0; i < x_end - pos; i++) {\r\nif (put_user(val, buf + i))\r\ngoto out;\r\n}\r\n}\r\nfilled = x_end - pos;\r\n}\r\ncount -= filled;\r\ndone += filled;\r\nbuf += filled;\r\npos += filled;\r\n}\r\n*ppos += done;\r\nout:\r\nif (bar == PCI_ROM_RESOURCE)\r\npci_unmap_rom(pdev, io);\r\nreturn count ? -EFAULT : done;\r\n}

static int ack_ready(struct sdio_func *func)\r\n{\r\nunsigned long start = jiffies;\r\nu8 val;\r\nint ret;\r\nwhile ((jiffies - start) < HZ) {\r\nval = sdio_readb(func, 0x13, &ret);\r\nif (val & 0x01)\r\nreturn 1;\r\nschedule();\r\n}\r\nreturn 0;\r\n}\r\nstatic int download_image(struct sdio_func *func, char *img_name)\r\n{\r\nint ret = 0, len, size, pno;\r\nstruct file *filp = NULL;\r\nstruct inode *inode = NULL;\r\nu8 *buf = tx_buf;\r\nloff_t pos = 0;\r\nfilp = filp_open(img_name, O_RDONLY | O_LARGEFILE, 0);\r\nif (IS_ERR(filp)) {\r\nprintk(KERN_ERR "Can't find %s.\n", img_name);\r\nreturn -ENOENT;\r\n}\r\ninode = filp->f_dentry->d_inode;\r\nif (!S_ISREG(inode->i_mode)) {\r\nprintk(KERN_ERR "Invalid file type: %s\n", img_name);\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nsize = i_size_read(inode->i_mapping->host);\r\nif (size <= 0) {\r\nprintk(KERN_ERR "Unable to find file size: %s\n", img_name);\r\nret = size;\r\ngoto out;\r\n}\r\npno = 0;\r\nwhile ((len = filp->f_op->read(filp, buf + TYPE_A_HEADER_SIZE,\r\nDOWNLOAD_SIZE, &pos))) {\r\nif (len < 0) {\r\nret = -1;\r\ngoto out;\r\n}\r\nbuf[0] = len & 0xff;\r\nbuf[1] = (len >> 8) & 0xff;\r\nbuf[2] = (len >> 16) & 0xff;\r\nif (pos >= size)\r\nbuf[3] = 2;\r\nelse\r\nbuf[3] = 0;\r\nret = sdio_memcpy_toio(func, 0, buf, len + TYPE_A_HEADER_SIZE);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "gdmwm: send image error: "\r\n"packet number = %d ret = %d\n", pno, ret);\r\ngoto out;\r\n}\r\nif (buf[3] == 2)\r\nbreak;\r\nif (!ack_ready(func)) {\r\nret = -EIO;\r\nprintk(KERN_ERR "gdmwm: Ack is not ready.\n");\r\ngoto out;\r\n}\r\nret = sdio_memcpy_fromio(func, buf, 0, TYPE_A_LOOKAHEAD_SIZE);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "gdmwm: receive ack error: "\r\n"packet number = %d ret = %d\n", pno, ret);\r\ngoto out;\r\n}\r\nsdio_writeb(func, 0x01, 0x13, &ret);\r\nsdio_writeb(func, 0x00, 0x10, &ret);\r\npno++;\r\n}\r\nout:\r\nfilp_close(filp, NULL);\r\nreturn ret;\r\n}\r\nint sdio_boot(struct sdio_func *func)\r\n{\r\nstatic mm_segment_t fs;\r\nint ret;\r\ntx_buf = kmalloc(YMEM0_SIZE, GFP_KERNEL);\r\nif (tx_buf == NULL) {\r\nprintk(KERN_ERR "Error: kmalloc: %s %d\n", __func__, __LINE__);\r\nreturn -ENOMEM;\r\n}\r\nfs = get_fs();\r\nset_fs(get_ds());\r\nret = download_image(func, KRN_PATH);\r\nif (ret)\r\ngoto restore_fs;\r\nprintk(KERN_INFO "GCT: Kernel download success.\n");\r\nret = download_image(func, RFS_PATH);\r\nif (ret)\r\ngoto restore_fs;\r\nprintk(KERN_INFO "GCT: Filesystem download success.\n");\r\nrestore_fs:\r\nset_fs(fs);\r\nkfree(tx_buf);\r\nreturn ret;\r\n}

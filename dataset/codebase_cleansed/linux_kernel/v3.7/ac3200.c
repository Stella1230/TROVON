static int __init do_ac3200_probe(struct net_device *dev)\r\n{\r\nunsigned short ioaddr = dev->base_addr;\r\nint irq = dev->irq;\r\nint mem_start = dev->mem_start;\r\nif (ioaddr > 0x1ff)\r\nreturn ac_probe1(ioaddr, dev);\r\nelse if (ioaddr > 0)\r\nreturn -ENXIO;\r\nif ( ! EISA_bus)\r\nreturn -ENXIO;\r\nfor (ioaddr = 0x1000; ioaddr < 0x9000; ioaddr += 0x1000) {\r\nif (ac_probe1(ioaddr, dev) == 0)\r\nreturn 0;\r\ndev->irq = irq;\r\ndev->mem_start = mem_start;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstruct net_device * __init ac3200_probe(int unit)\r\n{\r\nstruct net_device *dev = alloc_ei_netdev();\r\nint err;\r\nif (!dev)\r\nreturn ERR_PTR(-ENOMEM);\r\nsprintf(dev->name, "eth%d", unit);\r\nnetdev_boot_setup_check(dev);\r\nerr = do_ac3200_probe(dev);\r\nif (err)\r\ngoto out;\r\nreturn dev;\r\nout:\r\nfree_netdev(dev);\r\nreturn ERR_PTR(err);\r\n}\r\nstatic int __init ac_probe1(int ioaddr, struct net_device *dev)\r\n{\r\nint i, retval;\r\nif (!request_region(ioaddr, AC_IO_EXTENT, DRV_NAME))\r\nreturn -EBUSY;\r\nif (inb_p(ioaddr + AC_ID_PORT) == 0xff) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\nif (inl(ioaddr + AC_ID_PORT) != AC_EISA_ID) {\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\n#ifndef final_version\r\nprintk(KERN_DEBUG "AC3200 ethercard configuration register is %#02x,"\r\n" EISA ID %02x %02x %02x %02x.\n", inb(ioaddr + AC_CONFIG),\r\ninb(ioaddr + AC_ID_PORT + 0), inb(ioaddr + AC_ID_PORT + 1),\r\ninb(ioaddr + AC_ID_PORT + 2), inb(ioaddr + AC_ID_PORT + 3));\r\n#endif\r\nfor (i = 0; i < 6; i++)\r\ndev->dev_addr[i] = inb(ioaddr + AC_SA_PROM + i);\r\nprintk(KERN_DEBUG "AC3200 in EISA slot %d, node %pM",\r\nioaddr/0x1000, dev->dev_addr);\r\n#if 0\r\nif (inb(ioaddr + AC_SA_PROM + 0) != AC_ADDR0\r\n|| inb(ioaddr + AC_SA_PROM + 1) != AC_ADDR1\r\n|| inb(ioaddr + AC_SA_PROM + 2) != AC_ADDR2 ) {\r\nprintk(", not found (invalid prefix).\n");\r\nretval = -ENODEV;\r\ngoto out;\r\n}\r\n#endif\r\nif (dev->irq == 0) {\r\ndev->irq = config2irq(inb(ioaddr + AC_CONFIG));\r\nprintk(", using");\r\n} else {\r\ndev->irq = irq_canonicalize(dev->irq);\r\nprintk(", assigning");\r\n}\r\nretval = request_irq(dev->irq, ei_interrupt, 0, DRV_NAME, dev);\r\nif (retval) {\r\nprintk (" nothing! Unable to get IRQ %d.\n", dev->irq);\r\ngoto out;\r\n}\r\nprintk(" IRQ %d, %s port\n", dev->irq, port_name[dev->if_port]);\r\ndev->base_addr = ioaddr;\r\n#ifdef notyet\r\nif (dev->mem_start) {\r\nfor (i = 0; i < 7; i++)\r\nif (addrmap[i] == dev->mem_start)\r\nbreak;\r\nif (i >= 7)\r\ni = 0;\r\noutb((inb(ioaddr + AC_CONFIG) & ~7) | i, ioaddr + AC_CONFIG);\r\n}\r\n#endif\r\ndev->if_port = inb(ioaddr + AC_CONFIG) >> 6;\r\ndev->mem_start = config2mem(inb(ioaddr + AC_CONFIG));\r\nprintk("%s: AC3200 at %#3x with %dkB memory at physical address %#lx.\n",\r\ndev->name, ioaddr, AC_STOP_PG/4, dev->mem_start);\r\nei_status.mem = ioremap(dev->mem_start, AC_STOP_PG*0x100);\r\nif (!ei_status.mem) {\r\nprintk(KERN_ERR "ac3200.c: Unable to remap card memory above 1MB !!\n");\r\nprintk(KERN_ERR "ac3200.c: Try using EISA SCU to set memory below 1MB.\n");\r\nprintk(KERN_ERR "ac3200.c: Driver NOT installed.\n");\r\nretval = -EINVAL;\r\ngoto out1;\r\n}\r\nprintk("ac3200.c: remapped %dkB card memory to virtual address %p\n",\r\nAC_STOP_PG/4, ei_status.mem);\r\ndev->mem_start = (unsigned long)ei_status.mem;\r\ndev->mem_end = dev->mem_start + (AC_STOP_PG - AC_START_PG)*256;\r\nei_status.name = "AC3200";\r\nei_status.tx_start_page = AC_START_PG;\r\nei_status.rx_start_page = AC_START_PG + TX_PAGES;\r\nei_status.stop_page = AC_STOP_PG;\r\nei_status.word16 = 1;\r\nif (ei_debug > 0)\r\nprintk(version);\r\nei_status.reset_8390 = &ac_reset_8390;\r\nei_status.block_input = &ac_block_input;\r\nei_status.block_output = &ac_block_output;\r\nei_status.get_8390_hdr = &ac_get_8390_hdr;\r\ndev->netdev_ops = &ac_netdev_ops;\r\nNS8390_init(dev, 0);\r\nretval = register_netdev(dev);\r\nif (retval)\r\ngoto out2;\r\nreturn 0;\r\nout2:\r\nif (ei_status.reg0)\r\niounmap(ei_status.mem);\r\nout1:\r\nfree_irq(dev->irq, dev);\r\nout:\r\nrelease_region(ioaddr, AC_IO_EXTENT);\r\nreturn retval;\r\n}\r\nstatic int ac_open(struct net_device *dev)\r\n{\r\n#ifdef notyet\r\nint ioaddr = dev->base_addr;\r\n#endif\r\nei_open(dev);\r\nreturn 0;\r\n}\r\nstatic void ac_reset_8390(struct net_device *dev)\r\n{\r\nushort ioaddr = dev->base_addr;\r\noutb(AC_RESET, ioaddr + AC_RESET_PORT);\r\nif (ei_debug > 1) printk("resetting AC3200, t=%ld...", jiffies);\r\nei_status.txing = 0;\r\noutb(AC_ENABLE, ioaddr + AC_RESET_PORT);\r\nif (ei_debug > 1) printk("reset done\n");\r\n}\r\nstatic void\r\nac_get_8390_hdr(struct net_device *dev, struct e8390_pkt_hdr *hdr, int ring_page)\r\n{\r\nvoid __iomem *hdr_start = ei_status.mem + ((ring_page - AC_START_PG)<<8);\r\nmemcpy_fromio(hdr, hdr_start, sizeof(struct e8390_pkt_hdr));\r\n}\r\nstatic void ac_block_input(struct net_device *dev, int count, struct sk_buff *skb,\r\nint ring_offset)\r\n{\r\nvoid __iomem *start = ei_status.mem + ring_offset - AC_START_PG*256;\r\nif (ring_offset + count > AC_STOP_PG*256) {\r\nint semi_count = AC_STOP_PG*256 - ring_offset;\r\nmemcpy_fromio(skb->data, start, semi_count);\r\ncount -= semi_count;\r\nmemcpy_fromio(skb->data + semi_count,\r\nei_status.mem + TX_PAGES*256, count);\r\n} else {\r\nmemcpy_fromio(skb->data, start, count);\r\n}\r\n}\r\nstatic void ac_block_output(struct net_device *dev, int count,\r\nconst unsigned char *buf, int start_page)\r\n{\r\nvoid __iomem *shmem = ei_status.mem + ((start_page - AC_START_PG)<<8);\r\nmemcpy_toio(shmem, buf, count);\r\n}\r\nstatic int ac_close_card(struct net_device *dev)\r\n{\r\nif (ei_debug > 1)\r\nprintk("%s: Shutting down ethercard.\n", dev->name);\r\n#ifdef notyet\r\noutb(0x00, ioaddr + 6);\r\nfree_irq(dev->irq, dev);\r\n#endif\r\nei_close(dev);\r\nreturn 0;\r\n}\r\nstatic int __init ac3200_module_init(void)\r\n{\r\nstruct net_device *dev;\r\nint this_dev, found = 0;\r\nfor (this_dev = 0; this_dev < MAX_AC32_CARDS; this_dev++) {\r\nif (io[this_dev] == 0 && this_dev != 0)\r\nbreak;\r\ndev = alloc_ei_netdev();\r\nif (!dev)\r\nbreak;\r\ndev->irq = irq[this_dev];\r\ndev->base_addr = io[this_dev];\r\ndev->mem_start = mem[this_dev];\r\nif (do_ac3200_probe(dev) == 0) {\r\ndev_ac32[found++] = dev;\r\ncontinue;\r\n}\r\nfree_netdev(dev);\r\nprintk(KERN_WARNING "ac3200.c: No ac3200 card found (i/o = 0x%x).\n", io[this_dev]);\r\nbreak;\r\n}\r\nif (found)\r\nreturn 0;\r\nreturn -ENXIO;\r\n}\r\nstatic void cleanup_card(struct net_device *dev)\r\n{\r\nfree_irq(dev->irq, dev);\r\nrelease_region(dev->base_addr, AC_IO_EXTENT);\r\niounmap(ei_status.mem);\r\n}\r\nstatic void __exit ac3200_module_exit(void)\r\n{\r\nint this_dev;\r\nfor (this_dev = 0; this_dev < MAX_AC32_CARDS; this_dev++) {\r\nstruct net_device *dev = dev_ac32[this_dev];\r\nif (dev) {\r\nunregister_netdev(dev);\r\ncleanup_card(dev);\r\nfree_netdev(dev);\r\n}\r\n}\r\n}

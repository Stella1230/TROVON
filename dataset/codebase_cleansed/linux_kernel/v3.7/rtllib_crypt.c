void rtllib_crypt_deinit_entries(struct lib80211_crypt_info *info,\r\nint force)\r\n{\r\nstruct list_head *ptr, *n;\r\nstruct lib80211_crypt_data *entry;\r\nfor (ptr = info->crypt_deinit_list.next, n = ptr->next;\r\nptr != &info->crypt_deinit_list; ptr = n, n = ptr->next) {\r\nentry = list_entry(ptr, struct lib80211_crypt_data, list);\r\nif (atomic_read(&entry->refcnt) != 0 && !force)\r\ncontinue;\r\nlist_del(ptr);\r\nif (entry->ops)\r\nentry->ops->deinit(entry->priv);\r\nkfree(entry);\r\n}\r\n}\r\nvoid rtllib_crypt_deinit_handler(unsigned long data)\r\n{\r\nstruct lib80211_crypt_info *info = (struct lib80211_crypt_info *)data;\r\nunsigned long flags;\r\nspin_lock_irqsave(info->lock, flags);\r\nrtllib_crypt_deinit_entries(info, 0);\r\nif (!list_empty(&info->crypt_deinit_list)) {\r\nprintk(KERN_DEBUG "%s: entries remaining in delayed crypt "\r\n"deletion list\n", info->name);\r\ninfo->crypt_deinit_timer.expires = jiffies + HZ;\r\nadd_timer(&info->crypt_deinit_timer);\r\n}\r\nspin_unlock_irqrestore(info->lock, flags);\r\n}\r\nvoid rtllib_crypt_delayed_deinit(struct lib80211_crypt_info *info,\r\nstruct lib80211_crypt_data **crypt)\r\n{\r\nstruct lib80211_crypt_data *tmp;\r\nunsigned long flags;\r\nif (*crypt == NULL)\r\nreturn;\r\ntmp = *crypt;\r\n*crypt = NULL;\r\nspin_lock_irqsave(info->lock, flags);\r\nlist_add(&tmp->list, &info->crypt_deinit_list);\r\nif (!timer_pending(&info->crypt_deinit_timer)) {\r\ninfo->crypt_deinit_timer.expires = jiffies + HZ;\r\nadd_timer(&info->crypt_deinit_timer);\r\n}\r\nspin_unlock_irqrestore(info->lock, flags);\r\n}\r\nint rtllib_register_crypto_ops(struct lib80211_crypto_ops *ops)\r\n{\r\nunsigned long flags;\r\nstruct rtllib_crypto_alg *alg;\r\nif (hcrypt == NULL)\r\nreturn -1;\r\nalg = kzalloc(sizeof(*alg), GFP_KERNEL);\r\nif (alg == NULL)\r\nreturn -ENOMEM;\r\nalg->ops = ops;\r\nspin_lock_irqsave(&hcrypt->lock, flags);\r\nlist_add(&alg->list, &hcrypt->algs);\r\nspin_unlock_irqrestore(&hcrypt->lock, flags);\r\nprintk(KERN_DEBUG "rtllib_crypt: registered algorithm '%s'\n",\r\nops->name);\r\nreturn 0;\r\n}\r\nint rtllib_unregister_crypto_ops(struct lib80211_crypto_ops *ops)\r\n{\r\nunsigned long flags;\r\nstruct list_head *ptr;\r\nstruct rtllib_crypto_alg *del_alg = NULL;\r\nif (hcrypt == NULL)\r\nreturn -1;\r\nspin_lock_irqsave(&hcrypt->lock, flags);\r\nfor (ptr = hcrypt->algs.next; ptr != &hcrypt->algs; ptr = ptr->next) {\r\nstruct rtllib_crypto_alg *alg =\r\n(struct rtllib_crypto_alg *) ptr;\r\nif (alg->ops == ops) {\r\nlist_del(&alg->list);\r\ndel_alg = alg;\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&hcrypt->lock, flags);\r\nif (del_alg) {\r\nprintk(KERN_DEBUG "rtllib_crypt: unregistered algorithm "\r\n"'%s'\n", ops->name);\r\nkfree(del_alg);\r\n}\r\nreturn del_alg ? 0 : -1;\r\n}\r\nstruct lib80211_crypto_ops *rtllib_get_crypto_ops(const char *name)\r\n{\r\nunsigned long flags;\r\nstruct list_head *ptr;\r\nstruct rtllib_crypto_alg *found_alg = NULL;\r\nif (hcrypt == NULL)\r\nreturn NULL;\r\nspin_lock_irqsave(&hcrypt->lock, flags);\r\nfor (ptr = hcrypt->algs.next; ptr != &hcrypt->algs; ptr = ptr->next) {\r\nstruct rtllib_crypto_alg *alg =\r\n(struct rtllib_crypto_alg *) ptr;\r\nif (strcmp(alg->ops->name, name) == 0) {\r\nfound_alg = alg;\r\nbreak;\r\n}\r\n}\r\nspin_unlock_irqrestore(&hcrypt->lock, flags);\r\nif (found_alg)\r\nreturn found_alg->ops;\r\nelse\r\nreturn NULL;\r\n}\r\nstatic void * rtllib_crypt_null_init(int keyidx) { return (void *) 1; }\r\nstatic void rtllib_crypt_null_deinit(void *priv) {}\r\nint __init rtllib_crypto_init(void)\r\n{\r\nint ret = -ENOMEM;\r\nhcrypt = kzalloc(sizeof(*hcrypt), GFP_KERNEL);\r\nif (!hcrypt)\r\ngoto out;\r\nINIT_LIST_HEAD(&hcrypt->algs);\r\nspin_lock_init(&hcrypt->lock);\r\nret = lib80211_register_crypto_ops(&rtllib_crypt_null);\r\nif (ret < 0) {\r\nkfree(hcrypt);\r\nhcrypt = NULL;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nvoid __exit rtllib_crypto_deinit(void)\r\n{\r\nstruct list_head *ptr, *n;\r\nif (hcrypt == NULL)\r\nreturn;\r\nfor (ptr = hcrypt->algs.next, n = ptr->next; ptr != &hcrypt->algs;\r\nptr = n, n = ptr->next) {\r\nstruct rtllib_crypto_alg *alg =\r\n(struct rtllib_crypto_alg *) ptr;\r\nlist_del(ptr);\r\nprintk(KERN_DEBUG "rtllib_crypt: unregistered algorithm "\r\n"'%s' (deinit)\n", alg->ops->name);\r\nkfree(alg);\r\n}\r\nkfree(hcrypt);\r\n}

static int adp5520_bl_set(struct backlight_device *bl, int brightness)\r\n{\r\nstruct adp5520_bl *data = bl_get_data(bl);\r\nstruct device *master = data->master;\r\nint ret = 0;\r\nif (data->pdata->en_ambl_sens) {\r\nif ((brightness > 0) && (brightness < ADP5020_MAX_BRIGHTNESS)) {\r\nret |= adp5520_clr_bits(master, ADP5520_BL_CONTROL,\r\nADP5520_BL_AUTO_ADJ);\r\nret |= adp5520_write(master, ADP5520_DAYLIGHT_MAX,\r\nbrightness);\r\n} else {\r\nret |= adp5520_write(master, ADP5520_DAYLIGHT_MAX,\r\ndata->cached_daylight_max);\r\nret |= adp5520_set_bits(master, ADP5520_BL_CONTROL,\r\nADP5520_BL_AUTO_ADJ);\r\n}\r\n} else {\r\nret |= adp5520_write(master, ADP5520_DAYLIGHT_MAX, brightness);\r\n}\r\nif (data->current_brightness && brightness == 0)\r\nret |= adp5520_set_bits(master,\r\nADP5520_MODE_STATUS, ADP5520_DIM_EN);\r\nelse if (data->current_brightness == 0 && brightness)\r\nret |= adp5520_clr_bits(master,\r\nADP5520_MODE_STATUS, ADP5520_DIM_EN);\r\nif (!ret)\r\ndata->current_brightness = brightness;\r\nreturn ret;\r\n}\r\nstatic int adp5520_bl_update_status(struct backlight_device *bl)\r\n{\r\nint brightness = bl->props.brightness;\r\nif (bl->props.power != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nif (bl->props.fb_blank != FB_BLANK_UNBLANK)\r\nbrightness = 0;\r\nreturn adp5520_bl_set(bl, brightness);\r\n}\r\nstatic int adp5520_bl_get_brightness(struct backlight_device *bl)\r\n{\r\nstruct adp5520_bl *data = bl_get_data(bl);\r\nint error;\r\nuint8_t reg_val;\r\nerror = adp5520_read(data->master, ADP5520_BL_VALUE, &reg_val);\r\nreturn error ? data->current_brightness : reg_val;\r\n}\r\nstatic int adp5520_bl_setup(struct backlight_device *bl)\r\n{\r\nstruct adp5520_bl *data = bl_get_data(bl);\r\nstruct device *master = data->master;\r\nstruct adp5520_backlight_platform_data *pdata = data->pdata;\r\nint ret = 0;\r\nret |= adp5520_write(master, ADP5520_DAYLIGHT_MAX,\r\npdata->l1_daylight_max);\r\nret |= adp5520_write(master, ADP5520_DAYLIGHT_DIM,\r\npdata->l1_daylight_dim);\r\nif (pdata->en_ambl_sens) {\r\ndata->cached_daylight_max = pdata->l1_daylight_max;\r\nret |= adp5520_write(master, ADP5520_OFFICE_MAX,\r\npdata->l2_office_max);\r\nret |= adp5520_write(master, ADP5520_OFFICE_DIM,\r\npdata->l2_office_dim);\r\nret |= adp5520_write(master, ADP5520_DARK_MAX,\r\npdata->l3_dark_max);\r\nret |= adp5520_write(master, ADP5520_DARK_DIM,\r\npdata->l3_dark_dim);\r\nret |= adp5520_write(master, ADP5520_L2_TRIP,\r\npdata->l2_trip);\r\nret |= adp5520_write(master, ADP5520_L2_HYS,\r\npdata->l2_hyst);\r\nret |= adp5520_write(master, ADP5520_L3_TRIP,\r\npdata->l3_trip);\r\nret |= adp5520_write(master, ADP5520_L3_HYS,\r\npdata->l3_hyst);\r\nret |= adp5520_write(master, ADP5520_ALS_CMPR_CFG,\r\nALS_CMPR_CFG_VAL(pdata->abml_filt,\r\nADP5520_L3_EN));\r\n}\r\nret |= adp5520_write(master, ADP5520_BL_CONTROL,\r\nBL_CTRL_VAL(pdata->fade_led_law,\r\npdata->en_ambl_sens));\r\nret |= adp5520_write(master, ADP5520_BL_FADE, FADE_VAL(pdata->fade_in,\r\npdata->fade_out));\r\nret |= adp5520_set_bits(master, ADP5520_MODE_STATUS,\r\nADP5520_BL_EN | ADP5520_DIM_EN);\r\nreturn ret;\r\n}\r\nstatic ssize_t adp5520_show(struct device *dev, char *buf, int reg)\r\n{\r\nstruct adp5520_bl *data = dev_get_drvdata(dev);\r\nint error;\r\nuint8_t reg_val;\r\nmutex_lock(&data->lock);\r\nerror = adp5520_read(data->master, reg, &reg_val);\r\nmutex_unlock(&data->lock);\r\nreturn sprintf(buf, "%u\n", reg_val);\r\n}\r\nstatic ssize_t adp5520_store(struct device *dev, const char *buf,\r\nsize_t count, int reg)\r\n{\r\nstruct adp5520_bl *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint ret;\r\nret = kstrtoul(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&data->lock);\r\nadp5520_write(data->master, reg, val);\r\nmutex_unlock(&data->lock);\r\nreturn count;\r\n}\r\nstatic ssize_t adp5520_bl_dark_max_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn adp5520_show(dev, buf, ADP5520_DARK_MAX);\r\n}\r\nstatic ssize_t adp5520_bl_dark_max_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn adp5520_store(dev, buf, count, ADP5520_DARK_MAX);\r\n}\r\nstatic ssize_t adp5520_bl_office_max_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn adp5520_show(dev, buf, ADP5520_OFFICE_MAX);\r\n}\r\nstatic ssize_t adp5520_bl_office_max_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn adp5520_store(dev, buf, count, ADP5520_OFFICE_MAX);\r\n}\r\nstatic ssize_t adp5520_bl_daylight_max_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn adp5520_show(dev, buf, ADP5520_DAYLIGHT_MAX);\r\n}\r\nstatic ssize_t adp5520_bl_daylight_max_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct adp5520_bl *data = dev_get_drvdata(dev);\r\nint ret;\r\nret = kstrtoul(buf, 10, &data->cached_daylight_max);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn adp5520_store(dev, buf, count, ADP5520_DAYLIGHT_MAX);\r\n}\r\nstatic ssize_t adp5520_bl_dark_dim_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn adp5520_show(dev, buf, ADP5520_DARK_DIM);\r\n}\r\nstatic ssize_t adp5520_bl_dark_dim_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn adp5520_store(dev, buf, count, ADP5520_DARK_DIM);\r\n}\r\nstatic ssize_t adp5520_bl_office_dim_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn adp5520_show(dev, buf, ADP5520_OFFICE_DIM);\r\n}\r\nstatic ssize_t adp5520_bl_office_dim_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn adp5520_store(dev, buf, count, ADP5520_OFFICE_DIM);\r\n}\r\nstatic ssize_t adp5520_bl_daylight_dim_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn adp5520_show(dev, buf, ADP5520_DAYLIGHT_DIM);\r\n}\r\nstatic ssize_t adp5520_bl_daylight_dim_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nreturn adp5520_store(dev, buf, count, ADP5520_DAYLIGHT_DIM);\r\n}\r\nstatic int __devinit adp5520_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bl;\r\nstruct adp5520_bl *data;\r\nint ret = 0;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (data == NULL)\r\nreturn -ENOMEM;\r\ndata->master = pdev->dev.parent;\r\ndata->pdata = pdev->dev.platform_data;\r\nif (data->pdata == NULL) {\r\ndev_err(&pdev->dev, "missing platform data\n");\r\nreturn -ENODEV;\r\n}\r\ndata->id = pdev->id;\r\ndata->current_brightness = 0;\r\nmutex_init(&data->lock);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = ADP5020_MAX_BRIGHTNESS;\r\nbl = backlight_device_register(pdev->name, data->master, data,\r\n&adp5520_bl_ops, &props);\r\nif (IS_ERR(bl)) {\r\ndev_err(&pdev->dev, "failed to register backlight\n");\r\nreturn PTR_ERR(bl);\r\n}\r\nbl->props.brightness = ADP5020_MAX_BRIGHTNESS;\r\nif (data->pdata->en_ambl_sens)\r\nret = sysfs_create_group(&bl->dev.kobj,\r\n&adp5520_bl_attr_group);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to register sysfs\n");\r\nbacklight_device_unregister(bl);\r\n}\r\nplatform_set_drvdata(pdev, bl);\r\nret |= adp5520_bl_setup(bl);\r\nbacklight_update_status(bl);\r\nreturn ret;\r\n}\r\nstatic int __devexit adp5520_bl_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nstruct adp5520_bl *data = bl_get_data(bl);\r\nadp5520_clr_bits(data->master, ADP5520_MODE_STATUS, ADP5520_BL_EN);\r\nif (data->pdata->en_ambl_sens)\r\nsysfs_remove_group(&bl->dev.kobj,\r\n&adp5520_bl_attr_group);\r\nbacklight_device_unregister(bl);\r\nreturn 0;\r\n}\r\nstatic int adp5520_bl_suspend(struct platform_device *pdev,\r\npm_message_t state)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nreturn adp5520_bl_set(bl, 0);\r\n}\r\nstatic int adp5520_bl_resume(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bl = platform_get_drvdata(pdev);\r\nbacklight_update_status(bl);\r\nreturn 0;\r\n}

static int spi_reg_read(struct stmpe *stmpe, u8 reg)\r\n{\r\nstruct spi_device *spi = stmpe->client;\r\nint status = spi_w8r16(spi, reg | READ_CMD);\r\nreturn (status < 0) ? status : status >> 8;\r\n}\r\nstatic int spi_reg_write(struct stmpe *stmpe, u8 reg, u8 val)\r\n{\r\nstruct spi_device *spi = stmpe->client;\r\nu16 cmd = (val << 8) | reg;\r\nreturn spi_write(spi, (const u8 *)&cmd, 2);\r\n}\r\nstatic int spi_block_read(struct stmpe *stmpe, u8 reg, u8 length, u8 *values)\r\n{\r\nint ret, i;\r\nfor (i = 0; i < length; i++) {\r\nret = spi_reg_read(stmpe, reg + i);\r\nif (ret < 0)\r\nreturn ret;\r\n*(values + i) = ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int spi_block_write(struct stmpe *stmpe, u8 reg, u8 length,\r\nconst u8 *values)\r\n{\r\nint ret = 0, i;\r\nfor (i = length; i > 0; i--, reg++) {\r\nret = spi_reg_write(stmpe, reg, *(values + i - 1));\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic void spi_init(struct stmpe *stmpe)\r\n{\r\nstruct spi_device *spi = stmpe->client;\r\nspi->bits_per_word = 8;\r\nif (stmpe->variant->id_val == 0x0811)\r\nspi_reg_write(stmpe, STMPE811_REG_SPI_CFG, spi->mode);\r\nif (spi_setup(spi) < 0)\r\ndev_dbg(&spi->dev, "spi_setup failed\n");\r\n}\r\nstatic int __devinit\r\nstmpe_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nif (spi->max_speed_hz > 1000000) {\r\ndev_dbg(&spi->dev, "f(sample) %d KHz?\n",\r\n(spi->max_speed_hz/1000));\r\nreturn -EINVAL;\r\n}\r\nspi_ci.irq = spi->irq;\r\nspi_ci.client = spi;\r\nspi_ci.dev = &spi->dev;\r\nreturn stmpe_probe(&spi_ci, id->driver_data);\r\n}\r\nstatic int __devexit stmpe_spi_remove(struct spi_device *spi)\r\n{\r\nstruct stmpe *stmpe = dev_get_drvdata(&spi->dev);\r\nreturn stmpe_remove(stmpe);\r\n}\r\nstatic int __init stmpe_init(void)\r\n{\r\nreturn spi_register_driver(&stmpe_spi_driver);\r\n}\r\nstatic void __exit stmpe_exit(void)\r\n{\r\nspi_unregister_driver(&stmpe_spi_driver);\r\n}

static int p9100_setcolreg(unsigned regno,\r\nunsigned red, unsigned green, unsigned blue,\r\nunsigned transp, struct fb_info *info)\r\n{\r\nstruct p9100_par *par = (struct p9100_par *) info->par;\r\nstruct p9100_regs __iomem *regs = par->regs;\r\nunsigned long flags;\r\nif (regno >= 256)\r\nreturn 1;\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\nspin_lock_irqsave(&par->lock, flags);\r\nsbus_writel((regno << 16), &regs->ramdac_cmap_wridx);\r\nsbus_writel((red << 16), &regs->ramdac_palette_data);\r\nsbus_writel((green << 16), &regs->ramdac_palette_data);\r\nsbus_writel((blue << 16), &regs->ramdac_palette_data);\r\nspin_unlock_irqrestore(&par->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int\r\np9100_blank(int blank, struct fb_info *info)\r\n{\r\nstruct p9100_par *par = (struct p9100_par *) info->par;\r\nstruct p9100_regs __iomem *regs = par->regs;\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&par->lock, flags);\r\nswitch (blank) {\r\ncase FB_BLANK_UNBLANK:\r\nval = sbus_readl(&regs->vid_screenpaint_timectl1);\r\nval |= SCREENPAINT_TIMECTL1_ENABLE_VIDEO;\r\nsbus_writel(val, &regs->vid_screenpaint_timectl1);\r\npar->flags &= ~P9100_FLAG_BLANKED;\r\nbreak;\r\ncase FB_BLANK_NORMAL:\r\ncase FB_BLANK_VSYNC_SUSPEND:\r\ncase FB_BLANK_HSYNC_SUSPEND:\r\ncase FB_BLANK_POWERDOWN:\r\nval = sbus_readl(&regs->vid_screenpaint_timectl1);\r\nval &= ~SCREENPAINT_TIMECTL1_ENABLE_VIDEO;\r\nsbus_writel(val, &regs->vid_screenpaint_timectl1);\r\npar->flags |= P9100_FLAG_BLANKED;\r\nbreak;\r\n}\r\nspin_unlock_irqrestore(&par->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int p9100_mmap(struct fb_info *info, struct vm_area_struct *vma)\r\n{\r\nstruct p9100_par *par = (struct p9100_par *)info->par;\r\nreturn sbusfb_mmap_helper(p9100_mmap_map,\r\ninfo->fix.smem_start, info->fix.smem_len,\r\npar->which_io, vma);\r\n}\r\nstatic int p9100_ioctl(struct fb_info *info, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nreturn sbusfb_ioctl_helper(cmd, arg, info,\r\nFBTYPE_SUN3COLOR, 8, info->fix.smem_len);\r\n}\r\nstatic void p9100_init_fix(struct fb_info *info, int linebytes, struct device_node *dp)\r\n{\r\nstrlcpy(info->fix.id, dp->name, sizeof(info->fix.id));\r\ninfo->fix.type = FB_TYPE_PACKED_PIXELS;\r\ninfo->fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\ninfo->fix.line_length = linebytes;\r\ninfo->fix.accel = FB_ACCEL_SUN_CGTHREE;\r\n}\r\nstatic int __devinit p9100_probe(struct platform_device *op)\r\n{\r\nstruct device_node *dp = op->dev.of_node;\r\nstruct fb_info *info;\r\nstruct p9100_par *par;\r\nint linebytes, err;\r\ninfo = framebuffer_alloc(sizeof(struct p9100_par), &op->dev);\r\nerr = -ENOMEM;\r\nif (!info)\r\ngoto out_err;\r\npar = info->par;\r\nspin_lock_init(&par->lock);\r\ninfo->fix.smem_start = op->resource[2].start;\r\npar->which_io = op->resource[2].flags & IORESOURCE_BITS;\r\nsbusfb_fill_var(&info->var, dp, 8);\r\ninfo->var.red.length = 8;\r\ninfo->var.green.length = 8;\r\ninfo->var.blue.length = 8;\r\nlinebytes = of_getintprop_default(dp, "linebytes", info->var.xres);\r\ninfo->fix.smem_len = PAGE_ALIGN(linebytes * info->var.yres);\r\npar->regs = of_ioremap(&op->resource[0], 0,\r\nsizeof(struct p9100_regs), "p9100 regs");\r\nif (!par->regs)\r\ngoto out_release_fb;\r\ninfo->flags = FBINFO_DEFAULT;\r\ninfo->fbops = &p9100_ops;\r\ninfo->screen_base = of_ioremap(&op->resource[2], 0,\r\ninfo->fix.smem_len, "p9100 ram");\r\nif (!info->screen_base)\r\ngoto out_unmap_regs;\r\np9100_blank(FB_BLANK_UNBLANK, info);\r\nif (fb_alloc_cmap(&info->cmap, 256, 0))\r\ngoto out_unmap_screen;\r\np9100_init_fix(info, linebytes, dp);\r\nerr = register_framebuffer(info);\r\nif (err < 0)\r\ngoto out_dealloc_cmap;\r\nfb_set_cmap(&info->cmap, info);\r\ndev_set_drvdata(&op->dev, info);\r\nprintk(KERN_INFO "%s: p9100 at %lx:%lx\n",\r\ndp->full_name,\r\npar->which_io, info->fix.smem_start);\r\nreturn 0;\r\nout_dealloc_cmap:\r\nfb_dealloc_cmap(&info->cmap);\r\nout_unmap_screen:\r\nof_iounmap(&op->resource[2], info->screen_base, info->fix.smem_len);\r\nout_unmap_regs:\r\nof_iounmap(&op->resource[0], par->regs, sizeof(struct p9100_regs));\r\nout_release_fb:\r\nframebuffer_release(info);\r\nout_err:\r\nreturn err;\r\n}\r\nstatic int __devexit p9100_remove(struct platform_device *op)\r\n{\r\nstruct fb_info *info = dev_get_drvdata(&op->dev);\r\nstruct p9100_par *par = info->par;\r\nunregister_framebuffer(info);\r\nfb_dealloc_cmap(&info->cmap);\r\nof_iounmap(&op->resource[0], par->regs, sizeof(struct p9100_regs));\r\nof_iounmap(&op->resource[2], info->screen_base, info->fix.smem_len);\r\nframebuffer_release(info);\r\ndev_set_drvdata(&op->dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init p9100_init(void)\r\n{\r\nif (fb_get_options("p9100fb", NULL))\r\nreturn -ENODEV;\r\nreturn platform_driver_register(&p9100_driver);\r\n}\r\nstatic void __exit p9100_exit(void)\r\n{\r\nplatform_driver_unregister(&p9100_driver);\r\n}

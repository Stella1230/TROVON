static int nuc900_checkready(void)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nif (!(AUDIO_READ(nuc900_audio->mmio + ACTL_ACIS0) & CODEC_READY))\r\nreturn -EPERM;\r\nreturn 0;\r\n}\r\nstatic unsigned short nuc900_ac97_read(struct snd_ac97 *ac97,\r\nunsigned short reg)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nunsigned long timeout = 0x10000, val;\r\nmutex_lock(&ac97_mutex);\r\nval = nuc900_checkready();\r\nif (val) {\r\ndev_err(nuc900_audio->dev, "AC97 codec is not ready\n");\r\ngoto out;\r\n}\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS1, R_WB | reg);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_ACOS0);\r\nval |= (VALID_FRAME | SLOT1_VALID);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS0, val);\r\nudelay(100);\r\nwhile (!(AUDIO_READ(nuc900_audio->mmio + ACTL_ACCON) & AC_R_FINISH)\r\n&& timeout--)\r\nmdelay(1);\r\nif (!timeout) {\r\ndev_err(nuc900_audio->dev, "AC97 read register time out !\n");\r\nval = -EPERM;\r\ngoto out;\r\n}\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_ACOS0) ;\r\nval &= ~SLOT1_VALID;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS0, val);\r\nif (AUDIO_READ(nuc900_audio->mmio + ACTL_ACIS1) >> 2 != reg) {\r\ndev_err(nuc900_audio->dev,\r\n"R_INDEX of REG_ACTL_ACIS1 not match!\n");\r\n}\r\nudelay(100);\r\nval = (AUDIO_READ(nuc900_audio->mmio + ACTL_ACIS2) & 0xFFFF);\r\nout:\r\nmutex_unlock(&ac97_mutex);\r\nreturn val;\r\n}\r\nstatic void nuc900_ac97_write(struct snd_ac97 *ac97, unsigned short reg,\r\nunsigned short val)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nunsigned long tmp, timeout = 0x10000;\r\nmutex_lock(&ac97_mutex);\r\ntmp = nuc900_checkready();\r\nif (tmp)\r\ndev_err(nuc900_audio->dev, "AC97 codec is not ready\n");\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS1, reg);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS2, val);\r\ntmp = AUDIO_READ(nuc900_audio->mmio + ACTL_ACOS0);\r\ntmp |= SLOT1_VALID | SLOT2_VALID | VALID_FRAME;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS0, tmp);\r\nudelay(100);\r\nwhile ((AUDIO_READ(nuc900_audio->mmio + ACTL_ACCON) & AC_W_FINISH)\r\n&& timeout--)\r\nmdelay(1);\r\nif (!timeout)\r\ndev_err(nuc900_audio->dev, "AC97 write register time out !\n");\r\ntmp = AUDIO_READ(nuc900_audio->mmio + ACTL_ACOS0);\r\ntmp &= ~(SLOT1_VALID | SLOT2_VALID);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS0, tmp);\r\nmutex_unlock(&ac97_mutex);\r\n}\r\nstatic void nuc900_ac97_warm_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nunsigned long val;\r\nmutex_lock(&ac97_mutex);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_ACCON);\r\nval |= AC_W_RES;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACCON, val);\r\nudelay(100);\r\nval = nuc900_checkready();\r\nif (val)\r\ndev_err(nuc900_audio->dev, "AC97 codec is not ready\n");\r\nmutex_unlock(&ac97_mutex);\r\n}\r\nstatic void nuc900_ac97_cold_reset(struct snd_ac97 *ac97)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nunsigned long val;\r\nmutex_lock(&ac97_mutex);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nval |= ACTL_RESET_BIT;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nval &= (~ACTL_RESET_BIT);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nval |= AC_RESET;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nval &= ~AC_RESET;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_ACCON);\r\nval |= AC_C_RES;\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACCON, val);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_ACCON);\r\nval &= (~AC_C_RES);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACCON, val);\r\nudelay(100);\r\nmutex_unlock(&ac97_mutex);\r\n}\r\nstatic int nuc900_ac97_trigger(struct snd_pcm_substream *substream,\r\nint cmd, struct snd_soc_dai *dai)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nint ret;\r\nunsigned long val, tmp;\r\nret = 0;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\ntmp = AUDIO_READ(nuc900_audio->mmio + ACTL_ACOS0);\r\ntmp |= (SLOT3_VALID | SLOT4_VALID | VALID_FRAME);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS0, tmp);\r\ntmp = AUDIO_READ(nuc900_audio->mmio + ACTL_PSR);\r\ntmp |= (P_DMA_END_IRQ | P_DMA_MIDDLE_IRQ);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_PSR, tmp);\r\nval |= AC_PLAY;\r\n} else {\r\ntmp = AUDIO_READ(nuc900_audio->mmio + ACTL_RSR);\r\ntmp |= (R_DMA_END_IRQ | R_DMA_MIDDLE_IRQ);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RSR, tmp);\r\nval |= AC_RECORD;\r\n}\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_RESET);\r\nif (substream->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\ntmp = AUDIO_READ(nuc900_audio->mmio + ACTL_ACOS0);\r\ntmp &= ~(SLOT3_VALID | SLOT4_VALID);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_ACOS0, tmp);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_PSR, RESET_PRSR);\r\nval &= ~AC_PLAY;\r\n} else {\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RSR, RESET_PRSR);\r\nval &= ~AC_RECORD;\r\n}\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_RESET, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int nuc900_ac97_probe(struct snd_soc_dai *dai)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nunsigned long val;\r\nmutex_lock(&ac97_mutex);\r\nclk_enable(nuc900_audio->clk);\r\nval = AUDIO_READ(nuc900_audio->mmio + ACTL_CON);\r\nval |= (IIS_AC_PIN_SEL | ACLINK_EN);\r\nAUDIO_WRITE(nuc900_audio->mmio + ACTL_CON, val);\r\nmutex_unlock(&ac97_mutex);\r\nreturn 0;\r\n}\r\nstatic int nuc900_ac97_remove(struct snd_soc_dai *dai)\r\n{\r\nstruct nuc900_audio *nuc900_audio = nuc900_ac97_data;\r\nclk_disable(nuc900_audio->clk);\r\nreturn 0;\r\n}\r\nstatic int __devinit nuc900_ac97_drvprobe(struct platform_device *pdev)\r\n{\r\nstruct nuc900_audio *nuc900_audio;\r\nint ret;\r\nif (nuc900_ac97_data)\r\nreturn -EBUSY;\r\nnuc900_audio = kzalloc(sizeof(struct nuc900_audio), GFP_KERNEL);\r\nif (!nuc900_audio)\r\nreturn -ENOMEM;\r\nspin_lock_init(&nuc900_audio->lock);\r\nnuc900_audio->res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!nuc900_audio->res) {\r\nret = -ENODEV;\r\ngoto out0;\r\n}\r\nif (!request_mem_region(nuc900_audio->res->start,\r\nresource_size(nuc900_audio->res), pdev->name)) {\r\nret = -EBUSY;\r\ngoto out0;\r\n}\r\nnuc900_audio->mmio = ioremap(nuc900_audio->res->start,\r\nresource_size(nuc900_audio->res));\r\nif (!nuc900_audio->mmio) {\r\nret = -ENOMEM;\r\ngoto out1;\r\n}\r\nnuc900_audio->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(nuc900_audio->clk)) {\r\nret = PTR_ERR(nuc900_audio->clk);\r\ngoto out2;\r\n}\r\nnuc900_audio->irq_num = platform_get_irq(pdev, 0);\r\nif (!nuc900_audio->irq_num) {\r\nret = -EBUSY;\r\ngoto out3;\r\n}\r\nnuc900_ac97_data = nuc900_audio;\r\nret = snd_soc_register_dai(&pdev->dev, &nuc900_ac97_dai);\r\nif (ret)\r\ngoto out3;\r\nmfp_set_groupg(nuc900_audio->dev, NULL);\r\nreturn 0;\r\nout3:\r\nclk_put(nuc900_audio->clk);\r\nout2:\r\niounmap(nuc900_audio->mmio);\r\nout1:\r\nrelease_mem_region(nuc900_audio->res->start,\r\nresource_size(nuc900_audio->res));\r\nout0:\r\nkfree(nuc900_audio);\r\nreturn ret;\r\n}\r\nstatic int __devexit nuc900_ac97_drvremove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nclk_put(nuc900_ac97_data->clk);\r\niounmap(nuc900_ac97_data->mmio);\r\nrelease_mem_region(nuc900_ac97_data->res->start,\r\nresource_size(nuc900_ac97_data->res));\r\nkfree(nuc900_ac97_data);\r\nnuc900_ac97_data = NULL;\r\nreturn 0;\r\n}

static inline u_char readreg(unsigned int ale, unsigned int adr, u_char off)\r\n{\r\nregister u_char ret;\r\nbyteout(ale, off);\r\nret = bytein(adr);\r\nreturn ret;\r\n}\r\nstatic inline void readfifo(unsigned int ale, unsigned int adr, u_char off,\r\nu_char *data, int size)\r\n{\r\nbyteout(ale, off);\r\ninsb(adr, data, size);\r\n}\r\nstatic inline void writereg(unsigned int ale, unsigned int adr, u_char off,\r\nu_char data)\r\n{\r\nbyteout(ale, off);\r\nbyteout(adr, data);\r\n}\r\nstatic inline void writefifo(unsigned int ale, unsigned int adr, u_char off,\r\nu_char *data, int size)\r\n{\r\nbyteout(ale, off);\r\noutsb(adr, data, size);\r\n}\r\nstatic u_char ReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn readreg(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, offset);\r\n}\r\nstatic void WriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, offset, value);\r\n}\r\nstatic void ReadISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nreadfifo(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, 0, data, size);\r\n}\r\nstatic void WriteISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nwritefifo(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, 0, data, size);\r\n}\r\nstatic u_char ReadHSCX(struct IsdnCardState *cs, int hscx, u_char offset)\r\n{\r\nreturn readreg(cs->hw.niccy.hscx_ale,\r\ncs->hw.niccy.hscx, offset + (hscx ? 0x40 : 0));\r\n}\r\nstatic void WriteHSCX(struct IsdnCardState *cs, int hscx, u_char offset,\r\nu_char value)\r\n{\r\nwritereg(cs->hw.niccy.hscx_ale,\r\ncs->hw.niccy.hscx, offset + (hscx ? 0x40 : 0), value);\r\n}\r\nstatic irqreturn_t niccy_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nif (cs->subtyp == NICCY_PCI) {\r\nint ival;\r\nival = inl(cs->hw.niccy.cfg_reg + PCI_IRQ_CTRL_REG);\r\nif (!(ival & PCI_IRQ_ASSERT)) {\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_NONE;\r\n}\r\noutl(ival, cs->hw.niccy.cfg_reg + PCI_IRQ_CTRL_REG);\r\n}\r\nval = readreg(cs->hw.niccy.hscx_ale, cs->hw.niccy.hscx,\r\nHSCX_ISTA + 0x40);\r\nStart_HSCX:\r\nif (val)\r\nhscx_int_main(cs, val);\r\nval = readreg(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, ISAC_ISTA);\r\nStart_ISAC:\r\nif (val)\r\nisac_interrupt(cs, val);\r\nval = readreg(cs->hw.niccy.hscx_ale, cs->hw.niccy.hscx,\r\nHSCX_ISTA + 0x40);\r\nif (val) {\r\nif (cs->debug & L1_DEB_HSCX)\r\ndebugl1(cs, "HSCX IntStat after IntRoutine");\r\ngoto Start_HSCX;\r\n}\r\nval = readreg(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, ISAC_ISTA);\r\nif (val) {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "ISAC IntStat after IntRoutine");\r\ngoto Start_ISAC;\r\n}\r\nwritereg(cs->hw.niccy.hscx_ale, cs->hw.niccy.hscx, HSCX_MASK, 0xFF);\r\nwritereg(cs->hw.niccy.hscx_ale, cs->hw.niccy.hscx, HSCX_MASK + 0x40,\r\n0xFF);\r\nwritereg(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, ISAC_MASK, 0xFF);\r\nwritereg(cs->hw.niccy.isac_ale, cs->hw.niccy.isac, ISAC_MASK, 0);\r\nwritereg(cs->hw.niccy.hscx_ale, cs->hw.niccy.hscx, HSCX_MASK, 0);\r\nwritereg(cs->hw.niccy.hscx_ale, cs->hw.niccy.hscx, HSCX_MASK + 0x40, 0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void release_io_niccy(struct IsdnCardState *cs)\r\n{\r\nif (cs->subtyp == NICCY_PCI) {\r\nint val;\r\nval = inl(cs->hw.niccy.cfg_reg + PCI_IRQ_CTRL_REG);\r\nval &= PCI_IRQ_DISABLE;\r\noutl(val, cs->hw.niccy.cfg_reg + PCI_IRQ_CTRL_REG);\r\nrelease_region(cs->hw.niccy.cfg_reg, 0x40);\r\nrelease_region(cs->hw.niccy.isac, 4);\r\n} else {\r\nrelease_region(cs->hw.niccy.isac, 2);\r\nrelease_region(cs->hw.niccy.isac_ale, 2);\r\n}\r\n}\r\nstatic void niccy_reset(struct IsdnCardState *cs)\r\n{\r\nif (cs->subtyp == NICCY_PCI) {\r\nint val;\r\nval = inl(cs->hw.niccy.cfg_reg + PCI_IRQ_CTRL_REG);\r\nval |= PCI_IRQ_ENABLE;\r\noutl(val, cs->hw.niccy.cfg_reg + PCI_IRQ_CTRL_REG);\r\n}\r\ninithscxisac(cs, 3);\r\n}\r\nstatic int niccy_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nniccy_reset(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn 0;\r\ncase CARD_RELEASE:\r\nrelease_io_niccy(cs);\r\nreturn 0;\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nniccy_reset(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn 0;\r\ncase CARD_TEST:\r\nreturn 0;\r\n}\r\nreturn 0;\r\n}\r\nint __devinit setup_niccy(struct IsdnCard *card)\r\n{\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, niccy_revision);\r\nprintk(KERN_INFO "HiSax: Niccy driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_NICCY)\r\nreturn 0;\r\n#ifdef __ISAPNP__\r\nif (!card->para[1] && isapnp_present()) {\r\nstruct pnp_dev *pnp_d = NULL;\r\nint err;\r\npnp_c = pnp_find_card(ISAPNP_VENDOR('S', 'D', 'A'),\r\nISAPNP_FUNCTION(0x0150), pnp_c);\r\nif (pnp_c) {\r\npnp_d = pnp_find_dev(pnp_c,\r\nISAPNP_VENDOR('S', 'D', 'A'),\r\nISAPNP_FUNCTION(0x0150), pnp_d);\r\nif (!pnp_d) {\r\nprintk(KERN_ERR "NiccyPnP: PnP error card "\r\n"found, no device\n");\r\nreturn 0;\r\n}\r\npnp_disable_dev(pnp_d);\r\nerr = pnp_activate_dev(pnp_d);\r\nif (err < 0) {\r\nprintk(KERN_WARNING "%s: pnp_activate_dev "\r\n"ret(%d)\n", __func__, err);\r\nreturn 0;\r\n}\r\ncard->para[1] = pnp_port_start(pnp_d, 0);\r\ncard->para[2] = pnp_port_start(pnp_d, 1);\r\ncard->para[0] = pnp_irq(pnp_d, 0);\r\nif (!card->para[0] || !card->para[1] ||\r\n!card->para[2]) {\r\nprintk(KERN_ERR "NiccyPnP:some resources are "\r\n"missing %ld/%lx/%lx\n",\r\ncard->para[0], card->para[1],\r\ncard->para[2]);\r\npnp_disable_dev(pnp_d);\r\nreturn 0;\r\n}\r\n} else\r\nprintk(KERN_INFO "NiccyPnP: no ISAPnP card found\n");\r\n}\r\n#endif\r\nif (card->para[1]) {\r\ncs->hw.niccy.isac = card->para[1] + ISAC_PNP;\r\ncs->hw.niccy.hscx = card->para[1] + HSCX_PNP;\r\ncs->hw.niccy.isac_ale = card->para[2] + ISAC_PNP;\r\ncs->hw.niccy.hscx_ale = card->para[2] + HSCX_PNP;\r\ncs->hw.niccy.cfg_reg = 0;\r\ncs->subtyp = NICCY_PNP;\r\ncs->irq = card->para[0];\r\nif (!request_region(cs->hw.niccy.isac, 2, "niccy data")) {\r\nprintk(KERN_WARNING "HiSax: NICCY data port %x-%x "\r\n"already in use\n",\r\ncs->hw.niccy.isac, cs->hw.niccy.isac + 1);\r\nreturn 0;\r\n}\r\nif (!request_region(cs->hw.niccy.isac_ale, 2, "niccy addr")) {\r\nprintk(KERN_WARNING "HiSax: NICCY address port %x-%x "\r\n"already in use\n",\r\ncs->hw.niccy.isac_ale,\r\ncs->hw.niccy.isac_ale + 1);\r\nrelease_region(cs->hw.niccy.isac, 2);\r\nreturn 0;\r\n}\r\n} else {\r\n#ifdef CONFIG_PCI\r\nstatic struct pci_dev *niccy_dev __devinitdata;\r\nu_int pci_ioaddr;\r\ncs->subtyp = 0;\r\nif ((niccy_dev = hisax_find_pci_device(PCI_VENDOR_ID_SATSAGEM,\r\nPCI_DEVICE_ID_SATSAGEM_NICCY,\r\nniccy_dev))) {\r\nif (pci_enable_device(niccy_dev))\r\nreturn 0;\r\nif (!niccy_dev->irq) {\r\nprintk(KERN_WARNING\r\n"Niccy: No IRQ for PCI card found\n");\r\nreturn 0;\r\n}\r\ncs->irq = niccy_dev->irq;\r\ncs->hw.niccy.cfg_reg = pci_resource_start(niccy_dev, 0);\r\nif (!cs->hw.niccy.cfg_reg) {\r\nprintk(KERN_WARNING\r\n"Niccy: No IO-Adr for PCI cfg found\n");\r\nreturn 0;\r\n}\r\npci_ioaddr = pci_resource_start(niccy_dev, 1);\r\nif (!pci_ioaddr) {\r\nprintk(KERN_WARNING\r\n"Niccy: No IO-Adr for PCI card found\n");\r\nreturn 0;\r\n}\r\ncs->subtyp = NICCY_PCI;\r\n} else {\r\nprintk(KERN_WARNING "Niccy: No PCI card found\n");\r\nreturn 0;\r\n}\r\ncs->irq_flags |= IRQF_SHARED;\r\ncs->hw.niccy.isac = pci_ioaddr + ISAC_PCI_DATA;\r\ncs->hw.niccy.isac_ale = pci_ioaddr + ISAC_PCI_ADDR;\r\ncs->hw.niccy.hscx = pci_ioaddr + HSCX_PCI_DATA;\r\ncs->hw.niccy.hscx_ale = pci_ioaddr + HSCX_PCI_ADDR;\r\nif (!request_region(cs->hw.niccy.isac, 4, "niccy")) {\r\nprintk(KERN_WARNING\r\n"HiSax: NICCY data port %x-%x already in use\n",\r\ncs->hw.niccy.isac, cs->hw.niccy.isac + 4);\r\nreturn 0;\r\n}\r\nif (!request_region(cs->hw.niccy.cfg_reg, 0x40, "niccy pci")) {\r\nprintk(KERN_WARNING\r\n"HiSax: NICCY pci port %x-%x already in use\n",\r\ncs->hw.niccy.cfg_reg,\r\ncs->hw.niccy.cfg_reg + 0x40);\r\nrelease_region(cs->hw.niccy.isac, 4);\r\nreturn 0;\r\n}\r\n#else\r\nprintk(KERN_WARNING "Niccy: io0 0 and NO_PCI_BIOS\n");\r\nprintk(KERN_WARNING "Niccy: unable to config NICCY PCI\n");\r\nreturn 0;\r\n#endif\r\n}\r\nprintk(KERN_INFO "HiSax: NICCY %s config irq:%d data:0x%X ale:0x%X\n",\r\n(cs->subtyp == 1) ? "PnP" : "PCI",\r\ncs->irq, cs->hw.niccy.isac, cs->hw.niccy.isac_ale);\r\nsetup_isac(cs);\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHSCX;\r\ncs->BC_Write_Reg = &WriteHSCX;\r\ncs->BC_Send_Data = &hscx_fill_fifo;\r\ncs->cardmsg = &niccy_card_msg;\r\ncs->irq_func = &niccy_interrupt;\r\nISACVersion(cs, "Niccy:");\r\nif (HscxVersion(cs, "Niccy:")) {\r\nprintk(KERN_WARNING "Niccy: wrong HSCX versions check IO "\r\n"address\n");\r\nrelease_io_niccy(cs);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}

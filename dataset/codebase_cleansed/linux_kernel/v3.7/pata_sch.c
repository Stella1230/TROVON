static void sch_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nunsigned int pio = adev->pio_mode - XFER_PIO_0;\r\nstruct pci_dev *dev = to_pci_dev(ap->host->dev);\r\nunsigned int port = adev->devno ? D1TIM : D0TIM;\r\nunsigned int data;\r\npci_read_config_dword(dev, port, &data);\r\ndata &= ~(PM | PPE);\r\ndata |= pio;\r\nif (adev->class == ATA_DEV_ATA)\r\ndata |= PPE;\r\npci_write_config_dword(dev, port, data);\r\n}\r\nstatic void sch_set_dmamode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\nunsigned int dma_mode = adev->dma_mode;\r\nstruct pci_dev *dev = to_pci_dev(ap->host->dev);\r\nunsigned int port = adev->devno ? D1TIM : D0TIM;\r\nunsigned int data;\r\npci_read_config_dword(dev, port, &data);\r\nif (dma_mode >= XFER_UDMA_0) {\r\ndata |= USD;\r\ndata &= ~UDM;\r\ndata |= (dma_mode - XFER_UDMA_0) << 16;\r\n} else {\r\ndata &= ~(USD | MDM);\r\ndata |= (dma_mode - XFER_MW_DMA_0) << 8;\r\n}\r\npci_write_config_dword(dev, port, data);\r\n}\r\nstatic int __devinit sch_init_one(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nconst struct ata_port_info *ppi[] = { &sch_port_info, NULL };\r\nata_print_version_once(&pdev->dev, DRV_VERSION);\r\nreturn ata_pci_bmdma_init_one(pdev, ppi, &sch_sht, NULL, 0);\r\n}

void planetcore_prepare_table(char *table)\r\n{\r\ndo {\r\nif (*table == '\n')\r\n*table = 0;\r\ntable++;\r\n} while (*(table - 1) || *table != '\n');\r\n*table = 0;\r\n}\r\nconst char *planetcore_get_key(const char *table, const char *key)\r\n{\r\nint keylen = strlen(key);\r\ndo {\r\nif (!strncmp(table, key, keylen) && table[keylen] == '=')\r\nreturn table + keylen + 1;\r\ntable += strlen(table) + 1;\r\n} while (strlen(table) != 0);\r\nreturn NULL;\r\n}\r\nint planetcore_get_decimal(const char *table, const char *key, u64 *val)\r\n{\r\nconst char *str = planetcore_get_key(table, key);\r\nif (!str)\r\nreturn 0;\r\n*val = strtoull(str, NULL, 10);\r\nreturn 1;\r\n}\r\nint planetcore_get_hex(const char *table, const char *key, u64 *val)\r\n{\r\nconst char *str = planetcore_get_key(table, key);\r\nif (!str)\r\nreturn 0;\r\n*val = strtoull(str, NULL, 16);\r\nreturn 1;\r\n}\r\nvoid planetcore_set_mac_addrs(const char *table)\r\n{\r\nu8 addr[4][6];\r\nu64 int_addr;\r\nu32 i;\r\nint j;\r\nif (!planetcore_get_hex(table, PLANETCORE_KEY_MAC_ADDR, &int_addr))\r\nreturn;\r\nfor (i = 0; i < 4; i++) {\r\nu64 this_dev_addr = (int_addr & ~0x000000c00000) |\r\nmac_table[i];\r\nfor (j = 5; j >= 0; j--) {\r\naddr[i][j] = this_dev_addr & 0xff;\r\nthis_dev_addr >>= 8;\r\n}\r\ndt_fixup_mac_address(i, addr[i]);\r\n}\r\n}\r\nvoid planetcore_set_stdout_path(const char *table)\r\n{\r\nchar *path;\r\nconst char *label;\r\nvoid *node, *chosen;\r\nlabel = planetcore_get_key(table, PLANETCORE_KEY_SERIAL_PORT);\r\nif (!label)\r\nreturn;\r\nnode = find_node_by_prop_value_str(NULL, "linux,planetcore-label",\r\nlabel);\r\nif (!node)\r\nreturn;\r\npath = get_path(node, prop_buf, MAX_PROP_LEN);\r\nif (!path)\r\nreturn;\r\nchosen = finddevice("/chosen");\r\nif (!chosen)\r\nchosen = create_node(NULL, "chosen");\r\nif (!chosen)\r\nreturn;\r\nsetprop_str(chosen, "linux,stdout-path", path);\r\n}\r\nvoid planetcore_set_serial_speed(const char *table)\r\n{\r\nvoid *chosen, *stdout;\r\nu64 baud;\r\nu32 baud32;\r\nint len;\r\nchosen = finddevice("/chosen");\r\nif (!chosen)\r\nreturn;\r\nlen = getprop(chosen, "linux,stdout-path", prop_buf, MAX_PROP_LEN);\r\nif (len <= 0)\r\nreturn;\r\nstdout = finddevice(prop_buf);\r\nif (!stdout) {\r\nprintf("planetcore_set_serial_speed: "\r\n"Bad /chosen/linux,stdout-path.\r\n");\r\nreturn;\r\n}\r\nif (!planetcore_get_decimal(table, PLANETCORE_KEY_SERIAL_BAUD,\r\n&baud)) {\r\nprintf("planetcore_set_serial_speed: No SB tag.\r\n");\r\nreturn;\r\n}\r\nbaud32 = baud;\r\nsetprop(stdout, "current-speed", &baud32, 4);\r\n}

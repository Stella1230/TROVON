static void bfin_set_vlev(unsigned int vlev)\r\n{\r\nunsigned pll_lcnt;\r\npll_lcnt = bfin_read_PLL_LOCKCNT();\r\nbfin_write_PLL_LOCKCNT(1);\r\nbfin_write_VR_CTL((bfin_read_VR_CTL() & ~VLEV) | vlev);\r\nbfin_write_PLL_LOCKCNT(pll_lcnt);\r\n}\r\nstatic unsigned int bfin_get_vlev(unsigned int freq)\r\n{\r\nint i;\r\nif (!pdata)\r\ngoto err_out;\r\nfreq >>= 16;\r\nfor (i = 0; i < pdata->tabsize; i++)\r\nif (freq <= (pdata->tuple_tab[i] & 0xFFFF))\r\nreturn pdata->tuple_tab[i] >> 16;\r\nerr_out:\r\nprintk(KERN_WARNING "DPMC: No suitable CCLK VDDINT voltage pair found\n");\r\nreturn VLEV_120;\r\n}\r\nstatic void bfin_idle_this_cpu(void *info)\r\n{\r\nunsigned long flags = 0;\r\nunsigned long iwr0, iwr1, iwr2;\r\nunsigned int cpu = smp_processor_id();\r\nlocal_irq_save_hw(flags);\r\nbfin_iwr_set_sup0(&iwr0, &iwr1, &iwr2);\r\nplatform_clear_ipi(cpu, IRQ_SUPPLE_0);\r\nSSYNC();\r\nasm("IDLE;");\r\nbfin_iwr_restore(iwr0, iwr1, iwr2);\r\nlocal_irq_restore_hw(flags);\r\n}\r\nstatic void bfin_idle_cpu(void)\r\n{\r\nsmp_call_function(bfin_idle_this_cpu, NULL, 0);\r\n}\r\nstatic void bfin_wakeup_cpu(void)\r\n{\r\nunsigned int cpu;\r\nunsigned int this_cpu = smp_processor_id();\r\ncpumask_t mask;\r\ncpumask_copy(&mask, cpu_online_mask);\r\ncpumask_clear_cpu(this_cpu, &mask);\r\nfor_each_cpu(cpu, &mask)\r\nplatform_send_ipi_cpu(cpu, IRQ_SUPPLE_0);\r\n}\r\nstatic void bfin_idle_cpu(void) {}\r\nstatic void bfin_wakeup_cpu(void) {}\r\nstatic int\r\nvreg_cpufreq_notifier(struct notifier_block *nb, unsigned long val, void *data)\r\n{\r\nstruct cpufreq_freqs *freq = data;\r\nif (freq->cpu != CPUFREQ_CPU)\r\nreturn 0;\r\nif (val == CPUFREQ_PRECHANGE && freq->old < freq->new) {\r\nbfin_idle_cpu();\r\nbfin_set_vlev(bfin_get_vlev(freq->new));\r\nudelay(pdata->vr_settling_time);\r\nbfin_wakeup_cpu();\r\n} else if (val == CPUFREQ_POSTCHANGE && freq->old > freq->new) {\r\nbfin_idle_cpu();\r\nbfin_set_vlev(bfin_get_vlev(freq->new));\r\nbfin_wakeup_cpu();\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit bfin_dpmc_probe(struct platform_device *pdev)\r\n{\r\nif (pdev->dev.platform_data)\r\npdata = pdev->dev.platform_data;\r\nelse\r\nreturn -EINVAL;\r\nreturn cpufreq_register_notifier(&vreg_cpufreq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\n}\r\nstatic int __devexit bfin_dpmc_remove(struct platform_device *pdev)\r\n{\r\npdata = NULL;\r\nreturn cpufreq_unregister_notifier(&vreg_cpufreq_notifier_block,\r\nCPUFREQ_TRANSITION_NOTIFIER);\r\n}\r\nstatic int __init bfin_dpmc_init(void)\r\n{\r\nreturn platform_driver_register(&bfin_dpmc_device_driver);\r\n}\r\nstatic void __exit bfin_dpmc_exit(void)\r\n{\r\nplatform_driver_unregister(&bfin_dpmc_device_driver);\r\n}

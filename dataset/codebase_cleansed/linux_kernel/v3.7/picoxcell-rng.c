static inline u32 picoxcell_trng_read_csr(void)\r\n{\r\nreturn __raw_readl(rng_base + CSR_REG_OFFSET);\r\n}\r\nstatic inline bool picoxcell_trng_is_empty(void)\r\n{\r\nreturn picoxcell_trng_read_csr() & CSR_OUT_EMPTY_MASK;\r\n}\r\nstatic void picoxcell_trng_start(void)\r\n{\r\n__raw_writel(0, rng_base + TAI_REG_OFFSET);\r\n__raw_writel(0, rng_base + CSR_REG_OFFSET);\r\n}\r\nstatic void picoxcell_trng_reset(void)\r\n{\r\n__raw_writel(TRNG_BLOCK_RESET_MASK, rng_base + CSR_REG_OFFSET);\r\n__raw_writel(TRNG_BLOCK_RESET_MASK, rng_base + TAI_REG_OFFSET);\r\npicoxcell_trng_start();\r\n}\r\nstatic int picoxcell_trng_read(struct hwrng *rng, void *buf, size_t max,\r\nbool wait)\r\n{\r\nint i;\r\nfor (i = 0; i < PICO_TRNG_TIMEOUT && picoxcell_trng_is_empty(); ++i) {\r\nif (!wait)\r\nreturn 0;\r\nudelay(1);\r\n}\r\nif (picoxcell_trng_read_csr() & CSR_FAULT_MASK) {\r\ndev_err(rng_dev, "fault detected, resetting TRNG\n");\r\npicoxcell_trng_reset();\r\nreturn -EIO;\r\n}\r\nif (i == PICO_TRNG_TIMEOUT)\r\nreturn 0;\r\n*(u32 *)buf = __raw_readl(rng_base + DATA_REG_OFFSET);\r\nreturn sizeof(u32);\r\n}\r\nstatic int picoxcell_trng_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct resource *mem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem) {\r\ndev_warn(&pdev->dev, "no memory resource\n");\r\nreturn -ENOMEM;\r\n}\r\nif (!devm_request_mem_region(&pdev->dev, mem->start, resource_size(mem),\r\n"picoxcell_trng")) {\r\ndev_warn(&pdev->dev, "unable to request io mem\n");\r\nreturn -EBUSY;\r\n}\r\nrng_base = devm_ioremap(&pdev->dev, mem->start, resource_size(mem));\r\nif (!rng_base) {\r\ndev_warn(&pdev->dev, "unable to remap io mem\n");\r\nreturn -ENOMEM;\r\n}\r\nrng_clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(rng_clk)) {\r\ndev_warn(&pdev->dev, "no clk\n");\r\nreturn PTR_ERR(rng_clk);\r\n}\r\nret = clk_enable(rng_clk);\r\nif (ret) {\r\ndev_warn(&pdev->dev, "unable to enable clk\n");\r\ngoto err_enable;\r\n}\r\npicoxcell_trng_start();\r\nret = hwrng_register(&picoxcell_trng);\r\nif (ret)\r\ngoto err_register;\r\nrng_dev = &pdev->dev;\r\ndev_info(&pdev->dev, "pixoxcell random number generator active\n");\r\nreturn 0;\r\nerr_register:\r\nclk_disable(rng_clk);\r\nerr_enable:\r\nclk_put(rng_clk);\r\nreturn ret;\r\n}\r\nstatic int __devexit picoxcell_trng_remove(struct platform_device *pdev)\r\n{\r\nhwrng_unregister(&picoxcell_trng);\r\nclk_disable(rng_clk);\r\nclk_put(rng_clk);\r\nreturn 0;\r\n}\r\nstatic int picoxcell_trng_suspend(struct device *dev)\r\n{\r\nclk_disable(rng_clk);\r\nreturn 0;\r\n}\r\nstatic int picoxcell_trng_resume(struct device *dev)\r\n{\r\nreturn clk_enable(rng_clk);\r\n}

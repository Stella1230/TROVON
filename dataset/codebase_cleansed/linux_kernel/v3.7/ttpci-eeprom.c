static int check_mac_tt(u8 *buf)\r\n{\r\nint i;\r\nu16 tmp = 0xffff;\r\nfor (i = 0; i < 8; i++) {\r\ntmp = (tmp << 8) | ((tmp >> 8) ^ buf[i]);\r\ntmp ^= (tmp >> 4) & 0x0f;\r\ntmp ^= (tmp << 12) ^ ((tmp & 0xff) << 5);\r\n}\r\ntmp ^= 0xffff;\r\nreturn (((tmp >> 8) ^ buf[8]) | ((tmp & 0xff) ^ buf[9]));\r\n}\r\nstatic int getmac_tt(u8 * decodedMAC, u8 * encodedMAC)\r\n{\r\nu8 xor[20] = { 0x72, 0x23, 0x68, 0x19, 0x5c, 0xa8, 0x71, 0x2c,\r\n0x54, 0xd3, 0x7b, 0xf1, 0x9E, 0x23, 0x16, 0xf6,\r\n0x1d, 0x36, 0x64, 0x78};\r\nu8 data[20];\r\nint i;\r\nmemcpy(data, encodedMAC, 20);\r\nfor (i = 0; i < 20; i++)\r\ndata[i] ^= xor[i];\r\nfor (i = 0; i < 10; i++)\r\ndata[i] = ((data[2 * i + 1] << 8) | data[2 * i])\r\n>> ((data[2 * i + 1] >> 6) & 3);\r\nif (check_mac_tt(data))\r\nreturn -ENODEV;\r\ndecodedMAC[0] = data[2]; decodedMAC[1] = data[1]; decodedMAC[2] = data[0];\r\ndecodedMAC[3] = data[6]; decodedMAC[4] = data[5]; decodedMAC[5] = data[4];\r\nreturn 0;\r\n}\r\nint ttpci_eeprom_decode_mac(u8 *decodedMAC, u8 *encodedMAC)\r\n{\r\nu8 xor[20] = { 0x72, 0x23, 0x68, 0x19, 0x5c, 0xa8, 0x71, 0x2c,\r\n0x54, 0xd3, 0x7b, 0xf1, 0x9E, 0x23, 0x16, 0xf6,\r\n0x1d, 0x36, 0x64, 0x78};\r\nu8 data[20];\r\nint i;\r\nmemcpy(data, encodedMAC, 20);\r\nfor (i = 0; i < 20; i++)\r\ndata[i] ^= xor[i];\r\nfor (i = 0; i < 10; i++)\r\ndata[i] = ((data[2 * i + 1] << 8) | data[2 * i])\r\n>> ((data[2 * i + 1] >> 6) & 3);\r\nif (check_mac_tt(data))\r\nreturn -ENODEV;\r\ndecodedMAC[0] = data[2];\r\ndecodedMAC[1] = data[1];\r\ndecodedMAC[2] = data[0];\r\ndecodedMAC[3] = data[6];\r\ndecodedMAC[4] = data[5];\r\ndecodedMAC[5] = data[4];\r\nreturn 0;\r\n}\r\nstatic int ttpci_eeprom_read_encodedMAC(struct i2c_adapter *adapter, u8 * encodedMAC)\r\n{\r\nint ret;\r\nu8 b0[] = { 0xcc };\r\nstruct i2c_msg msg[] = {\r\n{ .addr = 0x50, .flags = 0, .buf = b0, .len = 1 },\r\n{ .addr = 0x50, .flags = I2C_M_RD, .buf = encodedMAC, .len = 20 }\r\n};\r\nret = i2c_transfer(adapter, msg, 2);\r\nif (ret != 2)\r\nreturn (-ENODEV);\r\nreturn 0;\r\n}\r\nint ttpci_eeprom_parse_mac(struct i2c_adapter *adapter, u8 *proposed_mac)\r\n{\r\nint ret, i;\r\nu8 encodedMAC[20];\r\nu8 decodedMAC[6];\r\nret = ttpci_eeprom_read_encodedMAC(adapter, encodedMAC);\r\nif (ret != 0) {\r\ndprintk("Couldn't read from EEPROM: not there?\n");\r\nmemset(proposed_mac, 0, 6);\r\nreturn ret;\r\n}\r\nret = getmac_tt(decodedMAC, encodedMAC);\r\nif( ret != 0 ) {\r\ndprintk("adapter failed MAC signature check\n");\r\ndprintk("encoded MAC from EEPROM was " );\r\nfor(i=0; i<19; i++) {\r\ndprintk( "%.2x:", encodedMAC[i]);\r\n}\r\ndprintk("%.2x\n", encodedMAC[19]);\r\nmemset(proposed_mac, 0, 6);\r\nreturn ret;\r\n}\r\nmemcpy(proposed_mac, decodedMAC, 6);\r\ndprintk("adapter has MAC addr = %.2x:%.2x:%.2x:%.2x:%.2x:%.2x\n",\r\ndecodedMAC[0], decodedMAC[1], decodedMAC[2],\r\ndecodedMAC[3], decodedMAC[4], decodedMAC[5]);\r\nreturn 0;\r\n}

void apei_mce_report_mem_error(int corrected, struct cper_sec_mem_err *mem_err)\r\n{\r\nstruct mce m;\r\nif (!corrected || !(mem_err->validation_bits &\r\nCPER_MEM_VALID_PHYSICAL_ADDRESS))\r\nreturn;\r\nmce_setup(&m);\r\nm.bank = 1;\r\nm.status = MCI_STATUS_VAL | MCI_STATUS_EN | MCI_STATUS_ADDRV | 0x9f;\r\nm.addr = mem_err->physical_addr;\r\nmce_log(&m);\r\nmce_notify_irq();\r\n}\r\nint apei_write_mce(struct mce *m)\r\n{\r\nstruct cper_mce_record rcd;\r\nmemset(&rcd, 0, sizeof(rcd));\r\nmemcpy(rcd.hdr.signature, CPER_SIG_RECORD, CPER_SIG_SIZE);\r\nrcd.hdr.revision = CPER_RECORD_REV;\r\nrcd.hdr.signature_end = CPER_SIG_END;\r\nrcd.hdr.section_count = 1;\r\nrcd.hdr.error_severity = CPER_SEV_FATAL;\r\nrcd.hdr.validation_bits = 0;\r\nrcd.hdr.record_length = sizeof(rcd);\r\nrcd.hdr.creator_id = CPER_CREATOR_MCE;\r\nrcd.hdr.notification_type = CPER_NOTIFY_MCE;\r\nrcd.hdr.record_id = cper_next_record_id();\r\nrcd.hdr.flags = CPER_HW_ERROR_FLAGS_PREVERR;\r\nrcd.sec_hdr.section_offset = (void *)&rcd.mce - (void *)&rcd;\r\nrcd.sec_hdr.section_length = sizeof(rcd.mce);\r\nrcd.sec_hdr.revision = CPER_SEC_REV;\r\nrcd.sec_hdr.validation_bits = 0;\r\nrcd.sec_hdr.flags = CPER_SEC_PRIMARY;\r\nrcd.sec_hdr.section_type = CPER_SECTION_TYPE_MCE;\r\nrcd.sec_hdr.section_severity = CPER_SEV_FATAL;\r\nmemcpy(&rcd.mce, m, sizeof(*m));\r\nreturn erst_write(&rcd.hdr);\r\n}\r\nssize_t apei_read_mce(struct mce *m, u64 *record_id)\r\n{\r\nstruct cper_mce_record rcd;\r\nint rc, pos;\r\nrc = erst_get_record_id_begin(&pos);\r\nif (rc)\r\nreturn rc;\r\nretry:\r\nrc = erst_get_record_id_next(&pos, record_id);\r\nif (rc)\r\ngoto out;\r\nif (*record_id == APEI_ERST_INVALID_RECORD_ID)\r\ngoto out;\r\nrc = erst_read(*record_id, &rcd.hdr, sizeof(rcd));\r\nif (rc == -ENOENT)\r\ngoto retry;\r\nelse if (rc < 0)\r\ngoto out;\r\nelse if (rc != sizeof(rcd) ||\r\nuuid_le_cmp(rcd.hdr.creator_id, CPER_CREATOR_MCE))\r\ngoto retry;\r\nmemcpy(m, &rcd.mce, sizeof(*m));\r\nrc = sizeof(*m);\r\nout:\r\nerst_get_record_id_end();\r\nreturn rc;\r\n}\r\nint apei_check_mce(void)\r\n{\r\nreturn erst_get_record_count();\r\n}\r\nint apei_clear_mce(u64 record_id)\r\n{\r\nreturn erst_clear(record_id);\r\n}

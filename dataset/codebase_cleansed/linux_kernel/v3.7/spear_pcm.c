static int spear_pcm_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nsnd_pcm_set_runtime_buffer(substream, &substream->dma_buffer);\r\nreturn 0;\r\n}\r\nstatic int spear_pcm_hw_free(struct snd_pcm_substream *substream)\r\n{\r\nsnd_pcm_set_runtime_buffer(substream, NULL);\r\nreturn 0;\r\n}\r\nstatic int spear_pcm_open(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct spear_dma_data *dma_data = (struct spear_dma_data *)\r\nsnd_soc_dai_get_dma_data(rtd->cpu_dai, substream);\r\nint ret;\r\nret = snd_soc_set_runtime_hwparams(substream, &spear_pcm_hardware);\r\nif (ret)\r\nreturn ret;\r\nret = snd_dmaengine_pcm_open(substream, dma_data->filter, dma_data);\r\nif (ret)\r\nreturn ret;\r\nsnd_dmaengine_pcm_set_data(substream, dma_data);\r\nreturn 0;\r\n}\r\nstatic int spear_pcm_close(struct snd_pcm_substream *substream)\r\n{\r\nsnd_dmaengine_pcm_close(substream);\r\nreturn 0;\r\n}\r\nstatic int spear_pcm_mmap(struct snd_pcm_substream *substream,\r\nstruct vm_area_struct *vma)\r\n{\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nreturn dma_mmap_writecombine(substream->pcm->card->dev, vma,\r\nruntime->dma_area, runtime->dma_addr,\r\nruntime->dma_bytes);\r\n}\r\nstatic int\r\nspear_pcm_preallocate_dma_buffer(struct snd_pcm *pcm, int stream,\r\nsize_t size)\r\n{\r\nstruct snd_pcm_substream *substream = pcm->streams[stream].substream;\r\nstruct snd_dma_buffer *buf = &substream->dma_buffer;\r\nbuf->dev.type = SNDRV_DMA_TYPE_DEV;\r\nbuf->dev.dev = pcm->card->dev;\r\nbuf->private_data = NULL;\r\nbuf->area = dma_alloc_writecombine(pcm->card->dev, size,\r\n&buf->addr, GFP_KERNEL);\r\nif (!buf->area)\r\nreturn -ENOMEM;\r\ndev_info(buf->dev.dev,\r\n" preallocate_dma_buffer: area=%p, addr=%p, size=%d\n",\r\n(void *)buf->area, (void *)buf->addr, size);\r\nbuf->bytes = size;\r\nreturn 0;\r\n}\r\nstatic void spear_pcm_free(struct snd_pcm *pcm)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nstruct snd_dma_buffer *buf;\r\nint stream;\r\nfor (stream = 0; stream < 2; stream++) {\r\nsubstream = pcm->streams[stream].substream;\r\nif (!substream)\r\ncontinue;\r\nbuf = &substream->dma_buffer;\r\nif (!buf || !buf->area)\r\ncontinue;\r\ndma_free_writecombine(pcm->card->dev, buf->bytes,\r\nbuf->area, buf->addr);\r\nbuf->area = NULL;\r\n}\r\n}\r\nstatic int spear_pcm_new(struct snd_card *card,\r\nstruct snd_soc_dai *dai, struct snd_pcm *pcm)\r\n{\r\nint ret;\r\nif (!card->dev->dma_mask)\r\ncard->dev->dma_mask = &spear_pcm_dmamask;\r\nif (!card->dev->coherent_dma_mask)\r\ncard->dev->coherent_dma_mask = DMA_BIT_MASK(32);\r\nif (dai->driver->playback.channels_min) {\r\nret = spear_pcm_preallocate_dma_buffer(pcm,\r\nSNDRV_PCM_STREAM_PLAYBACK,\r\nspear_pcm_hardware.buffer_bytes_max);\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (dai->driver->capture.channels_min) {\r\nret = spear_pcm_preallocate_dma_buffer(pcm,\r\nSNDRV_PCM_STREAM_CAPTURE,\r\nspear_pcm_hardware.buffer_bytes_max);\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit spear_soc_platform_probe(struct platform_device *pdev)\r\n{\r\nreturn snd_soc_register_platform(&pdev->dev, &spear_soc_platform);\r\n}\r\nstatic int __devexit spear_soc_platform_remove(struct platform_device *pdev)\r\n{\r\nsnd_soc_unregister_platform(&pdev->dev);\r\nreturn 0;\r\n}

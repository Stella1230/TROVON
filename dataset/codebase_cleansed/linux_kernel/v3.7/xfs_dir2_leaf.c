int\r\nxfs_dir2_block_to_leaf(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *dbp)\r\n{\r\n__be16 *bestsp;\r\nxfs_dablk_t blkno;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_leaf_entry_t *blp;\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_inode_t *dp;\r\nint error;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_db_t ldb;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_block_to_leaf(args);\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nif ((error = xfs_da_grow_inode(args, &blkno))) {\r\nreturn error;\r\n}\r\nldb = xfs_dir2_da_to_db(mp, blkno);\r\nASSERT(ldb == XFS_DIR2_LEAF_FIRSTDB(mp));\r\nif ((error = xfs_dir2_leaf_init(args, ldb, &lbp, XFS_DIR2_LEAF1_MAGIC))) {\r\nreturn error;\r\n}\r\nASSERT(lbp != NULL);\r\nleaf = lbp->b_addr;\r\nhdr = dbp->b_addr;\r\nxfs_dir2_data_check(dp, dbp);\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nblp = xfs_dir2_block_leaf_p(btp);\r\nleaf->hdr.count = cpu_to_be16(be32_to_cpu(btp->count));\r\nleaf->hdr.stale = cpu_to_be16(be32_to_cpu(btp->stale));\r\nmemcpy(leaf->ents, blp, be32_to_cpu(btp->count) * sizeof(xfs_dir2_leaf_entry_t));\r\nxfs_dir2_leaf_log_ents(tp, lbp, 0, be16_to_cpu(leaf->hdr.count) - 1);\r\nneedscan = 0;\r\nneedlog = 1;\r\nxfs_dir2_data_make_free(tp, dbp,\r\n(xfs_dir2_data_aoff_t)((char *)blp - (char *)hdr),\r\n(xfs_dir2_data_aoff_t)((char *)hdr + mp->m_dirblksize -\r\n(char *)blp),\r\n&needlog, &needscan);\r\nhdr->magic = cpu_to_be32(XFS_DIR2_DATA_MAGIC);\r\nif (needscan)\r\nxfs_dir2_data_freescan(mp, hdr, &needlog);\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nltp->bestcount = cpu_to_be32(1);\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nbestsp[0] = hdr->bestfree[0].length;\r\nif (needlog)\r\nxfs_dir2_data_log_header(tp, dbp);\r\nxfs_dir2_leaf_check(dp, lbp);\r\nxfs_dir2_data_check(dp, dbp);\r\nxfs_dir2_leaf_log_bests(tp, lbp, 0, 0);\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_dir2_leaf_find_stale(\r\nstruct xfs_dir2_leaf *leaf,\r\nint index,\r\nint *lowstale,\r\nint *highstale)\r\n{\r\nfor (*lowstale = index - 1; *lowstale >= 0; --*lowstale) {\r\nif (leaf->ents[*lowstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nbreak;\r\n}\r\nfor (*highstale = index;\r\n*highstale < be16_to_cpu(leaf->hdr.count);\r\n++*highstale) {\r\nif (leaf->ents[*highstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nbreak;\r\nif (*lowstale >= 0 && index - *lowstale <= *highstale - index)\r\nbreak;\r\n}\r\n}\r\nstruct xfs_dir2_leaf_entry *\r\nxfs_dir2_leaf_find_entry(\r\nxfs_dir2_leaf_t *leaf,\r\nint index,\r\nint compact,\r\nint lowstale,\r\nint highstale,\r\nint *lfloglow,\r\nint *lfloghigh)\r\n{\r\nif (!leaf->hdr.stale) {\r\nxfs_dir2_leaf_entry_t *lep;\r\nlep = &leaf->ents[index];\r\nif (index < be16_to_cpu(leaf->hdr.count))\r\nmemmove(lep + 1, lep,\r\n(be16_to_cpu(leaf->hdr.count) - index) *\r\nsizeof(*lep));\r\n*lfloglow = index;\r\n*lfloghigh = be16_to_cpu(leaf->hdr.count);\r\nbe16_add_cpu(&leaf->hdr.count, 1);\r\nreturn lep;\r\n}\r\nif (compact == 0)\r\nxfs_dir2_leaf_find_stale(leaf, index, &lowstale, &highstale);\r\nif (lowstale >= 0 &&\r\n(highstale == be16_to_cpu(leaf->hdr.count) ||\r\nindex - lowstale - 1 < highstale - index)) {\r\nASSERT(index - lowstale - 1 >= 0);\r\nASSERT(leaf->ents[lowstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR));\r\nif (index - lowstale - 1 > 0) {\r\nmemmove(&leaf->ents[lowstale],\r\n&leaf->ents[lowstale + 1],\r\n(index - lowstale - 1) *\r\nsizeof(xfs_dir2_leaf_entry_t));\r\n}\r\n*lfloglow = MIN(lowstale, *lfloglow);\r\n*lfloghigh = MAX(index - 1, *lfloghigh);\r\nbe16_add_cpu(&leaf->hdr.stale, -1);\r\nreturn &leaf->ents[index - 1];\r\n}\r\nASSERT(highstale - index >= 0);\r\nASSERT(leaf->ents[highstale].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR));\r\nif (highstale - index > 0) {\r\nmemmove(&leaf->ents[index + 1],\r\n&leaf->ents[index],\r\n(highstale - index) * sizeof(xfs_dir2_leaf_entry_t));\r\n}\r\n*lfloglow = MIN(index, *lfloglow);\r\n*lfloghigh = MAX(highstale, *lfloghigh);\r\nbe16_add_cpu(&leaf->hdr.stale, -1);\r\nreturn &leaf->ents[index];\r\n}\r\nint\r\nxfs_dir2_leaf_addname(\r\nxfs_da_args_t *args)\r\n{\r\n__be16 *bestsp;\r\nint compact;\r\nxfs_dir2_data_hdr_t *hdr;\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nint error;\r\nint grown;\r\nint highstale;\r\nint i;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nint length;\r\nxfs_dir2_leaf_entry_t *lep;\r\nint lfloglow;\r\nint lfloghigh;\r\nint lowstale;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needbytes;\r\nint needlog;\r\nint needscan;\r\n__be16 *tagp;\r\nxfs_trans_t *tp;\r\nxfs_dir2_db_t use_block;\r\ntrace_xfs_dir2_leaf_addname(args);\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nerror = xfs_da_read_buf(tp, dp, mp->m_dirleafblk, -1, &lbp,\r\nXFS_DATA_FORK);\r\nif (error) {\r\nreturn error;\r\n}\r\nASSERT(lbp != NULL);\r\nindex = xfs_dir2_leaf_search_hash(args, lbp);\r\nleaf = lbp->b_addr;\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nlength = xfs_dir2_data_entsize(args->namelen);\r\nfor (use_block = -1, lep = &leaf->ents[index];\r\nindex < be16_to_cpu(leaf->hdr.count) && be32_to_cpu(lep->hashval) == args->hashval;\r\nindex++, lep++) {\r\nif (be32_to_cpu(lep->address) == XFS_DIR2_NULL_DATAPTR)\r\ncontinue;\r\ni = xfs_dir2_dataptr_to_db(mp, be32_to_cpu(lep->address));\r\nASSERT(i < be32_to_cpu(ltp->bestcount));\r\nASSERT(bestsp[i] != cpu_to_be16(NULLDATAOFF));\r\nif (be16_to_cpu(bestsp[i]) >= length) {\r\nuse_block = i;\r\nbreak;\r\n}\r\n}\r\nif (use_block == -1) {\r\nfor (i = 0; i < be32_to_cpu(ltp->bestcount); i++) {\r\nif (bestsp[i] == cpu_to_be16(NULLDATAOFF) &&\r\nuse_block == -1)\r\nuse_block = i;\r\nelse if (be16_to_cpu(bestsp[i]) >= length) {\r\nuse_block = i;\r\nbreak;\r\n}\r\n}\r\n}\r\nneedbytes = 0;\r\nif (!leaf->hdr.stale)\r\nneedbytes += sizeof(xfs_dir2_leaf_entry_t);\r\nif (use_block == -1)\r\nneedbytes += sizeof(xfs_dir2_data_off_t);\r\nif (use_block != -1 && bestsp[use_block] == cpu_to_be16(NULLDATAOFF))\r\nuse_block = -1;\r\nif ((char *)bestsp - (char *)&leaf->ents[be16_to_cpu(leaf->hdr.count)] <\r\nneedbytes && be16_to_cpu(leaf->hdr.stale) > 1) {\r\ncompact = 1;\r\n}\r\nelse if ((char *)bestsp - (char *)&leaf->ents[be16_to_cpu(\r\nleaf->hdr.count)] < needbytes) {\r\nif ((args->op_flags & XFS_DA_OP_JUSTCHECK) ||\r\nargs->total == 0) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(ENOSPC);\r\n}\r\nerror = xfs_dir2_leaf_to_node(args, lbp);\r\nif (error)\r\nreturn error;\r\nreturn xfs_dir2_node_addname(args);\r\n}\r\nelse\r\ncompact = 0;\r\nif (args->op_flags & XFS_DA_OP_JUSTCHECK) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn use_block == -1 ? XFS_ERROR(ENOSPC) : 0;\r\n}\r\nif (args->total == 0 && use_block == -1) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(ENOSPC);\r\n}\r\nif (compact) {\r\nxfs_dir2_leaf_compact_x1(lbp, &index, &lowstale, &highstale,\r\n&lfloglow, &lfloghigh);\r\n}\r\nelse if (be16_to_cpu(leaf->hdr.stale)) {\r\nlfloglow = be16_to_cpu(leaf->hdr.count);\r\nlfloghigh = -1;\r\n}\r\nif (use_block == -1) {\r\nif ((error = xfs_dir2_grow_inode(args, XFS_DIR2_DATA_SPACE,\r\n&use_block))) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nif ((error = xfs_dir2_data_init(args, use_block, &dbp))) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nif (use_block >= be32_to_cpu(ltp->bestcount)) {\r\nbestsp--;\r\nmemmove(&bestsp[0], &bestsp[1],\r\nbe32_to_cpu(ltp->bestcount) * sizeof(bestsp[0]));\r\nbe32_add_cpu(&ltp->bestcount, 1);\r\nxfs_dir2_leaf_log_tail(tp, lbp);\r\nxfs_dir2_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\n}\r\nelse\r\nxfs_dir2_leaf_log_bests(tp, lbp, use_block, use_block);\r\nhdr = dbp->b_addr;\r\nbestsp[use_block] = hdr->bestfree[0].length;\r\ngrown = 1;\r\n}\r\nelse {\r\nif ((error =\r\nxfs_da_read_buf(tp, dp, xfs_dir2_db_to_da(mp, use_block),\r\n-1, &dbp, XFS_DATA_FORK))) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nhdr = dbp->b_addr;\r\ngrown = 0;\r\n}\r\nxfs_dir2_data_check(dp, dbp);\r\ndup = (xfs_dir2_data_unused_t *)\r\n((char *)hdr + be16_to_cpu(hdr->bestfree[0].offset));\r\nASSERT(be16_to_cpu(dup->length) >= length);\r\nneedscan = needlog = 0;\r\nxfs_dir2_data_use_free(tp, dbp, dup,\r\n(xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr), length,\r\n&needlog, &needscan);\r\ndep = (xfs_dir2_data_entry_t *)dup;\r\ndep->inumber = cpu_to_be64(args->inumber);\r\ndep->namelen = args->namelen;\r\nmemcpy(dep->name, args->name, dep->namelen);\r\ntagp = xfs_dir2_data_entry_tag_p(dep);\r\n*tagp = cpu_to_be16((char *)dep - (char *)hdr);\r\nif (needscan)\r\nxfs_dir2_data_freescan(mp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(tp, dbp);\r\nxfs_dir2_data_log_entry(tp, dbp, dep);\r\nif (be16_to_cpu(bestsp[use_block]) != be16_to_cpu(hdr->bestfree[0].length)) {\r\nbestsp[use_block] = hdr->bestfree[0].length;\r\nif (!grown)\r\nxfs_dir2_leaf_log_bests(tp, lbp, use_block, use_block);\r\n}\r\nlep = xfs_dir2_leaf_find_entry(leaf, index, compact, lowstale,\r\nhighstale, &lfloglow, &lfloghigh);\r\nlep->hashval = cpu_to_be32(args->hashval);\r\nlep->address = cpu_to_be32(xfs_dir2_db_off_to_dataptr(mp, use_block,\r\nbe16_to_cpu(*tagp)));\r\nxfs_dir2_leaf_log_header(tp, lbp);\r\nxfs_dir2_leaf_log_ents(tp, lbp, lfloglow, lfloghigh);\r\nxfs_dir2_leaf_check(dp, lbp);\r\nxfs_dir2_data_check(dp, dbp);\r\nreturn 0;\r\n}\r\nSTATIC void\r\nxfs_dir2_leaf_check(\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf *bp)\r\n{\r\nint i;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint stale;\r\nleaf = bp->b_addr;\r\nmp = dp->i_mount;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC));\r\nASSERT(be16_to_cpu(leaf->hdr.count) <= xfs_dir2_max_leaf_ents(mp));\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nASSERT((char *)&leaf->ents[be16_to_cpu(leaf->hdr.count)] <=\r\n(char *)xfs_dir2_leaf_bests_p(ltp));\r\nfor (i = stale = 0; i < be16_to_cpu(leaf->hdr.count); i++) {\r\nif (i + 1 < be16_to_cpu(leaf->hdr.count))\r\nASSERT(be32_to_cpu(leaf->ents[i].hashval) <=\r\nbe32_to_cpu(leaf->ents[i + 1].hashval));\r\nif (leaf->ents[i].address == cpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nstale++;\r\n}\r\nASSERT(be16_to_cpu(leaf->hdr.stale) == stale);\r\n}\r\nvoid\r\nxfs_dir2_leaf_compact(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *bp)\r\n{\r\nint from;\r\nxfs_dir2_leaf_t *leaf;\r\nint loglow;\r\nint to;\r\nleaf = bp->b_addr;\r\nif (!leaf->hdr.stale) {\r\nreturn;\r\n}\r\nfor (from = to = 0, loglow = -1; from < be16_to_cpu(leaf->hdr.count); from++) {\r\nif (leaf->ents[from].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\ncontinue;\r\nif (from > to) {\r\nif (loglow == -1)\r\nloglow = to;\r\nleaf->ents[to] = leaf->ents[from];\r\n}\r\nto++;\r\n}\r\nASSERT(be16_to_cpu(leaf->hdr.stale) == from - to);\r\nbe16_add_cpu(&leaf->hdr.count, -(be16_to_cpu(leaf->hdr.stale)));\r\nleaf->hdr.stale = 0;\r\nxfs_dir2_leaf_log_header(args->trans, bp);\r\nif (loglow != -1)\r\nxfs_dir2_leaf_log_ents(args->trans, bp, loglow, to - 1);\r\n}\r\nvoid\r\nxfs_dir2_leaf_compact_x1(\r\nstruct xfs_buf *bp,\r\nint *indexp,\r\nint *lowstalep,\r\nint *highstalep,\r\nint *lowlogp,\r\nint *highlogp)\r\n{\r\nint from;\r\nint highstale;\r\nint index;\r\nint keepstale;\r\nxfs_dir2_leaf_t *leaf;\r\nint lowstale;\r\nint newindex=0;\r\nint to;\r\nleaf = bp->b_addr;\r\nASSERT(be16_to_cpu(leaf->hdr.stale) > 1);\r\nindex = *indexp;\r\nxfs_dir2_leaf_find_stale(leaf, index, &lowstale, &highstale);\r\nif (lowstale >= 0 &&\r\n(highstale == be16_to_cpu(leaf->hdr.count) ||\r\nindex - lowstale <= highstale - index))\r\nkeepstale = lowstale;\r\nelse\r\nkeepstale = highstale;\r\nfor (from = to = 0; from < be16_to_cpu(leaf->hdr.count); from++) {\r\nif (index == from)\r\nnewindex = to;\r\nif (from != keepstale &&\r\nleaf->ents[from].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR)) {\r\nif (from == to)\r\n*lowlogp = to;\r\ncontinue;\r\n}\r\nif (from == keepstale)\r\nlowstale = highstale = to;\r\nif (from > to)\r\nleaf->ents[to] = leaf->ents[from];\r\nto++;\r\n}\r\nASSERT(from > to);\r\nif (index == from)\r\nnewindex = to;\r\n*indexp = newindex;\r\nbe16_add_cpu(&leaf->hdr.count, -(from - to));\r\nleaf->hdr.stale = cpu_to_be16(1);\r\nif (lowstale >= newindex)\r\nlowstale = -1;\r\nelse\r\nhighstale = be16_to_cpu(leaf->hdr.count);\r\n*highlogp = be16_to_cpu(leaf->hdr.count) - 1;\r\n*lowstalep = lowstale;\r\n*highstalep = highstale;\r\n}\r\nSTATIC int\r\nxfs_dir2_leaf_readbuf(\r\nstruct xfs_inode *dp,\r\nsize_t bufsize,\r\nstruct xfs_dir2_leaf_map_info *mip,\r\nxfs_dir2_off_t *curoff,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_mount *mp = dp->i_mount;\r\nstruct xfs_buf *bp = *bpp;\r\nstruct xfs_bmbt_irec *map = mip->map;\r\nint error = 0;\r\nint length;\r\nint i;\r\nint j;\r\nif (bp) {\r\nxfs_trans_brelse(NULL, bp);\r\nbp = NULL;\r\nmip->map_blocks -= mp->m_dirblkfsbs;\r\nfor (i = mp->m_dirblkfsbs; i > 0; ) {\r\nj = min_t(int, map->br_blockcount, i);\r\nmap->br_blockcount -= j;\r\nmap->br_startblock += j;\r\nmap->br_startoff += j;\r\nif (!map->br_blockcount && --mip->map_valid)\r\nmemmove(&map[0], &map[1],\r\nsizeof(map[0]) * mip->map_valid);\r\ni -= j;\r\n}\r\n}\r\nmip->ra_want = howmany(bufsize + mp->m_dirblksize,\r\nmp->m_sb.sb_blocksize) - 1;\r\nASSERT(mip->ra_want >= 0);\r\nif (1 + mip->ra_want > mip->map_blocks &&\r\nmip->map_off < xfs_dir2_byte_to_da(mp, XFS_DIR2_LEAF_OFFSET)) {\r\nmip->nmap = mip->map_size - mip->map_valid;\r\nerror = xfs_bmapi_read(dp, mip->map_off,\r\nxfs_dir2_byte_to_da(mp, XFS_DIR2_LEAF_OFFSET) -\r\nmip->map_off,\r\n&map[mip->map_valid], &mip->nmap, 0);\r\nif (error)\r\ngoto out;\r\nif (mip->nmap == mip->map_size - mip->map_valid) {\r\ni = mip->map_valid + mip->nmap - 1;\r\nmip->map_off = map[i].br_startoff + map[i].br_blockcount;\r\n} else\r\nmip->map_off = xfs_dir2_byte_to_da(mp,\r\nXFS_DIR2_LEAF_OFFSET);\r\nfor (i = mip->map_valid; i < mip->map_valid + mip->nmap; ) {\r\nif (map[i].br_startblock == HOLESTARTBLOCK) {\r\nmip->nmap--;\r\nlength = mip->map_valid + mip->nmap - i;\r\nif (length)\r\nmemmove(&map[i], &map[i + 1],\r\nsizeof(map[i]) * length);\r\n} else {\r\nmip->map_blocks += map[i].br_blockcount;\r\ni++;\r\n}\r\n}\r\nmip->map_valid += mip->nmap;\r\n}\r\nif (!mip->map_valid) {\r\n*curoff = xfs_dir2_da_to_byte(mp, mip->map_off);\r\ngoto out;\r\n}\r\nmip->curdb = xfs_dir2_da_to_db(mp, map->br_startoff);\r\nerror = xfs_da_read_buf(NULL, dp, map->br_startoff,\r\nmap->br_blockcount >= mp->m_dirblkfsbs ?\r\nXFS_FSB_TO_DADDR(mp, map->br_startblock) : -1,\r\n&bp, XFS_DATA_FORK);\r\nif (error)\r\ngoto out;\r\nif (mip->ra_current)\r\nmip->ra_current -= mp->m_dirblkfsbs;\r\nfor (mip->ra_index = mip->ra_offset = i = 0;\r\nmip->ra_want > mip->ra_current && i < mip->map_blocks;\r\ni += mp->m_dirblkfsbs) {\r\nASSERT(mip->ra_index < mip->map_valid);\r\nif (i > mip->ra_current &&\r\nmap[mip->ra_index].br_blockcount >= mp->m_dirblkfsbs) {\r\nxfs_buf_readahead(mp->m_ddev_targp,\r\nXFS_FSB_TO_DADDR(mp,\r\nmap[mip->ra_index].br_startblock +\r\nmip->ra_offset),\r\n(int)BTOBB(mp->m_dirblksize));\r\nmip->ra_current = i;\r\n}\r\nelse if (i > mip->ra_current) {\r\nxfs_da_reada_buf(NULL, dp,\r\nmap[mip->ra_index].br_startoff +\r\nmip->ra_offset,\r\nXFS_DATA_FORK);\r\nmip->ra_current = i;\r\n}\r\nfor (j = 0; j < mp->m_dirblkfsbs; j++) {\r\nlength = min_t(int, mp->m_dirblkfsbs,\r\nmap[mip->ra_index].br_blockcount -\r\nmip->ra_offset);\r\nj += length;\r\nmip->ra_offset += length;\r\nif (mip->ra_offset == map[mip->ra_index].br_blockcount) {\r\nmip->ra_offset = 0;\r\nmip->ra_index++;\r\n}\r\n}\r\n}\r\nout:\r\n*bpp = bp;\r\nreturn error;\r\n}\r\nint\r\nxfs_dir2_leaf_getdents(\r\nxfs_inode_t *dp,\r\nvoid *dirent,\r\nsize_t bufsize,\r\nxfs_off_t *offset,\r\nfilldir_t filldir)\r\n{\r\nstruct xfs_buf *bp = NULL;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nint error = 0;\r\nint length;\r\nxfs_mount_t *mp;\r\nint byteoff;\r\nxfs_dir2_off_t curoff;\r\nxfs_dir2_off_t newoff;\r\nchar *ptr = NULL;\r\nstruct xfs_dir2_leaf_map_info *map_info;\r\nif (*offset >= XFS_DIR2_MAX_DATAPTR)\r\nreturn 0;\r\nmp = dp->i_mount;\r\nlength = howmany(bufsize + mp->m_dirblksize,\r\nmp->m_sb.sb_blocksize);\r\nmap_info = kmem_zalloc(offsetof(struct xfs_dir2_leaf_map_info, map) +\r\n(length * sizeof(struct xfs_bmbt_irec)),\r\nKM_SLEEP);\r\nmap_info->map_size = length;\r\ncuroff = xfs_dir2_dataptr_to_byte(mp, *offset);\r\nmap_info->map_off = xfs_dir2_db_to_da(mp,\r\nxfs_dir2_byte_to_db(mp, curoff));\r\nwhile (curoff < XFS_DIR2_LEAF_OFFSET) {\r\nif (!bp || ptr >= (char *)bp->b_addr + mp->m_dirblksize) {\r\nerror = xfs_dir2_leaf_readbuf(dp, bufsize, map_info,\r\n&curoff, &bp);\r\nif (error || !map_info->map_valid)\r\nbreak;\r\nnewoff = xfs_dir2_db_off_to_byte(mp, map_info->curdb, 0);\r\nif (curoff < newoff)\r\ncuroff = newoff;\r\nelse if (curoff > newoff)\r\nASSERT(xfs_dir2_byte_to_db(mp, curoff) ==\r\nmap_info->curdb);\r\nhdr = bp->b_addr;\r\nxfs_dir2_data_check(dp, bp);\r\nptr = (char *)(hdr + 1);\r\nbyteoff = xfs_dir2_byte_to_off(mp, curoff);\r\nif (byteoff == 0)\r\ncuroff += (uint)sizeof(*hdr);\r\nelse {\r\nwhile ((char *)ptr - (char *)hdr < byteoff) {\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag)\r\n== XFS_DIR2_DATA_FREE_TAG) {\r\nlength = be16_to_cpu(dup->length);\r\nptr += length;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nlength =\r\nxfs_dir2_data_entsize(dep->namelen);\r\nptr += length;\r\n}\r\ncuroff =\r\nxfs_dir2_db_off_to_byte(mp,\r\nxfs_dir2_byte_to_db(mp, curoff),\r\n(char *)ptr - (char *)hdr);\r\nif (ptr >= (char *)hdr + mp->m_dirblksize) {\r\ncontinue;\r\n}\r\n}\r\n}\r\ndup = (xfs_dir2_data_unused_t *)ptr;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nlength = be16_to_cpu(dup->length);\r\nptr += length;\r\ncuroff += length;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)ptr;\r\nlength = xfs_dir2_data_entsize(dep->namelen);\r\nif (filldir(dirent, (char *)dep->name, dep->namelen,\r\nxfs_dir2_byte_to_dataptr(mp, curoff) & 0x7fffffff,\r\nbe64_to_cpu(dep->inumber), DT_UNKNOWN))\r\nbreak;\r\nptr += length;\r\ncuroff += length;\r\nbufsize = bufsize > length ? bufsize - length : 0;\r\n}\r\nif (curoff > xfs_dir2_dataptr_to_byte(mp, XFS_DIR2_MAX_DATAPTR))\r\n*offset = XFS_DIR2_MAX_DATAPTR & 0x7fffffff;\r\nelse\r\n*offset = xfs_dir2_byte_to_dataptr(mp, curoff) & 0x7fffffff;\r\nkmem_free(map_info);\r\nif (bp)\r\nxfs_trans_brelse(NULL, bp);\r\nreturn error;\r\n}\r\nint\r\nxfs_dir2_leaf_init(\r\nxfs_da_args_t *args,\r\nxfs_dir2_db_t bno,\r\nstruct xfs_buf **bpp,\r\nint magic)\r\n{\r\nstruct xfs_buf *bp;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\ndp = args->dp;\r\nASSERT(dp != NULL);\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nASSERT(bno >= XFS_DIR2_LEAF_FIRSTDB(mp) &&\r\nbno < XFS_DIR2_FREE_FIRSTDB(mp));\r\nerror = xfs_da_get_buf(tp, dp, xfs_dir2_db_to_da(mp, bno), -1, &bp,\r\nXFS_DATA_FORK);\r\nif (error) {\r\nreturn error;\r\n}\r\nASSERT(bp != NULL);\r\nleaf = bp->b_addr;\r\nleaf->hdr.info.magic = cpu_to_be16(magic);\r\nleaf->hdr.info.forw = 0;\r\nleaf->hdr.info.back = 0;\r\nleaf->hdr.count = 0;\r\nleaf->hdr.stale = 0;\r\nxfs_dir2_leaf_log_header(tp, bp);\r\nif (magic == XFS_DIR2_LEAF1_MAGIC) {\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nltp->bestcount = 0;\r\nxfs_dir2_leaf_log_tail(tp, bp);\r\n}\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nstatic void\r\nxfs_dir2_leaf_log_bests(\r\nxfs_trans_t *tp,\r\nstruct xfs_buf *bp,\r\nint first,\r\nint last)\r\n{\r\n__be16 *firstb;\r\n__be16 *lastb;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nleaf = bp->b_addr;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC));\r\nltp = xfs_dir2_leaf_tail_p(tp->t_mountp, leaf);\r\nfirstb = xfs_dir2_leaf_bests_p(ltp) + first;\r\nlastb = xfs_dir2_leaf_bests_p(ltp) + last;\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)firstb - (char *)leaf),\r\n(uint)((char *)lastb - (char *)leaf + sizeof(*lastb) - 1));\r\n}\r\nvoid\r\nxfs_dir2_leaf_log_ents(\r\nxfs_trans_t *tp,\r\nstruct xfs_buf *bp,\r\nint first,\r\nint last)\r\n{\r\nxfs_dir2_leaf_entry_t *firstlep;\r\nxfs_dir2_leaf_entry_t *lastlep;\r\nxfs_dir2_leaf_t *leaf;\r\nleaf = bp->b_addr;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC));\r\nfirstlep = &leaf->ents[first];\r\nlastlep = &leaf->ents[last];\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)firstlep - (char *)leaf),\r\n(uint)((char *)lastlep - (char *)leaf + sizeof(*lastlep) - 1));\r\n}\r\nvoid\r\nxfs_dir2_leaf_log_header(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_dir2_leaf_t *leaf;\r\nleaf = bp->b_addr;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC) ||\r\nleaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC));\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)&leaf->hdr - (char *)leaf),\r\n(uint)(sizeof(leaf->hdr) - 1));\r\n}\r\nSTATIC void\r\nxfs_dir2_leaf_log_tail(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nmp = tp->t_mountp;\r\nleaf = bp->b_addr;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAF1_MAGIC));\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)ltp - (char *)leaf),\r\n(uint)(mp->m_dirblksize - 1));\r\n}\r\nint\r\nxfs_dir2_leaf_lookup(\r\nxfs_da_args_t *args)\r\n{\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_leaf_lookup(args);\r\nif ((error = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp))) {\r\nreturn error;\r\n}\r\ntp = args->trans;\r\ndp = args->dp;\r\nxfs_dir2_leaf_check(dp, lbp);\r\nleaf = lbp->b_addr;\r\nlep = &leaf->ents[index];\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)dbp->b_addr +\r\nxfs_dir2_dataptr_to_off(dp->i_mount, be32_to_cpu(lep->address)));\r\nargs->inumber = be64_to_cpu(dep->inumber);\r\nerror = xfs_dir_cilookup_result(args, dep->name, dep->namelen);\r\nxfs_trans_brelse(tp, dbp);\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(error);\r\n}\r\nstatic int\r\nxfs_dir2_leaf_lookup_int(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf **lbpp,\r\nint *indexp,\r\nstruct xfs_buf **dbpp)\r\n{\r\nxfs_dir2_db_t curdb = -1;\r\nstruct xfs_buf *dbp = NULL;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_mount_t *mp;\r\nxfs_dir2_db_t newdb;\r\nxfs_trans_t *tp;\r\nxfs_dir2_db_t cidb = -1;\r\nenum xfs_dacmp cmp;\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nerror = xfs_da_read_buf(tp, dp, mp->m_dirleafblk, -1, &lbp,\r\nXFS_DATA_FORK);\r\nif (error)\r\nreturn error;\r\n*lbpp = lbp;\r\nleaf = lbp->b_addr;\r\nxfs_dir2_leaf_check(dp, lbp);\r\nindex = xfs_dir2_leaf_search_hash(args, lbp);\r\nfor (lep = &leaf->ents[index]; index < be16_to_cpu(leaf->hdr.count) &&\r\nbe32_to_cpu(lep->hashval) == args->hashval;\r\nlep++, index++) {\r\nif (be32_to_cpu(lep->address) == XFS_DIR2_NULL_DATAPTR)\r\ncontinue;\r\nnewdb = xfs_dir2_dataptr_to_db(mp, be32_to_cpu(lep->address));\r\nif (newdb != curdb) {\r\nif (dbp)\r\nxfs_trans_brelse(tp, dbp);\r\nerror = xfs_da_read_buf(tp, dp,\r\nxfs_dir2_db_to_da(mp, newdb),\r\n-1, &dbp, XFS_DATA_FORK);\r\nif (error) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\nxfs_dir2_data_check(dp, dbp);\r\ncurdb = newdb;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)((char *)dbp->b_addr +\r\nxfs_dir2_dataptr_to_off(mp, be32_to_cpu(lep->address)));\r\ncmp = mp->m_dirnameops->compname(args, dep->name, dep->namelen);\r\nif (cmp != XFS_CMP_DIFFERENT && cmp != args->cmpresult) {\r\nargs->cmpresult = cmp;\r\n*indexp = index;\r\nif (cmp == XFS_CMP_EXACT) {\r\n*dbpp = dbp;\r\nreturn 0;\r\n}\r\ncidb = curdb;\r\n}\r\n}\r\nASSERT(args->op_flags & XFS_DA_OP_OKNOENT);\r\nif (args->cmpresult == XFS_CMP_CASE) {\r\nASSERT(cidb != -1);\r\nif (cidb != curdb) {\r\nxfs_trans_brelse(tp, dbp);\r\nerror = xfs_da_read_buf(tp, dp,\r\nxfs_dir2_db_to_da(mp, cidb),\r\n-1, &dbp, XFS_DATA_FORK);\r\nif (error) {\r\nxfs_trans_brelse(tp, lbp);\r\nreturn error;\r\n}\r\n}\r\n*dbpp = dbp;\r\nreturn 0;\r\n}\r\nASSERT(cidb == -1);\r\nif (dbp)\r\nxfs_trans_brelse(tp, dbp);\r\nxfs_trans_brelse(tp, lbp);\r\nreturn XFS_ERROR(ENOENT);\r\n}\r\nint\r\nxfs_dir2_leaf_removename(\r\nxfs_da_args_t *args)\r\n{\r\n__be16 *bestsp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_db_t db;\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_dir2_db_t i;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nint needlog;\r\nint needscan;\r\nxfs_dir2_data_off_t oldbest;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_leaf_removename(args);\r\nif ((error = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp))) {\r\nreturn error;\r\n}\r\ndp = args->dp;\r\ntp = args->trans;\r\nmp = dp->i_mount;\r\nleaf = lbp->b_addr;\r\nhdr = dbp->b_addr;\r\nxfs_dir2_data_check(dp, dbp);\r\nlep = &leaf->ents[index];\r\ndb = xfs_dir2_dataptr_to_db(mp, be32_to_cpu(lep->address));\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)hdr + xfs_dir2_dataptr_to_off(mp, be32_to_cpu(lep->address)));\r\nneedscan = needlog = 0;\r\noldbest = be16_to_cpu(hdr->bestfree[0].length);\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nASSERT(be16_to_cpu(bestsp[db]) == oldbest);\r\nxfs_dir2_data_make_free(tp, dbp,\r\n(xfs_dir2_data_aoff_t)((char *)dep - (char *)hdr),\r\nxfs_dir2_data_entsize(dep->namelen), &needlog, &needscan);\r\nbe16_add_cpu(&leaf->hdr.stale, 1);\r\nxfs_dir2_leaf_log_header(tp, lbp);\r\nlep->address = cpu_to_be32(XFS_DIR2_NULL_DATAPTR);\r\nxfs_dir2_leaf_log_ents(tp, lbp, index, index);\r\nif (needscan)\r\nxfs_dir2_data_freescan(mp, hdr, &needlog);\r\nif (needlog)\r\nxfs_dir2_data_log_header(tp, dbp);\r\nif (be16_to_cpu(hdr->bestfree[0].length) != oldbest) {\r\nbestsp[db] = hdr->bestfree[0].length;\r\nxfs_dir2_leaf_log_bests(tp, lbp, db, db);\r\n}\r\nxfs_dir2_data_check(dp, dbp);\r\nif (be16_to_cpu(hdr->bestfree[0].length) ==\r\nmp->m_dirblksize - (uint)sizeof(*hdr)) {\r\nASSERT(db != mp->m_dirdatablk);\r\nif ((error = xfs_dir2_shrink_inode(args, db, dbp))) {\r\nif (error == ENOSPC && args->total == 0)\r\nerror = 0;\r\nxfs_dir2_leaf_check(dp, lbp);\r\nreturn error;\r\n}\r\ndbp = NULL;\r\nif (db == be32_to_cpu(ltp->bestcount) - 1) {\r\nfor (i = db - 1; i > 0; i--) {\r\nif (bestsp[i] != cpu_to_be16(NULLDATAOFF))\r\nbreak;\r\n}\r\nmemmove(&bestsp[db - i], bestsp,\r\n(be32_to_cpu(ltp->bestcount) - (db - i)) * sizeof(*bestsp));\r\nbe32_add_cpu(&ltp->bestcount, -(db - i));\r\nxfs_dir2_leaf_log_tail(tp, lbp);\r\nxfs_dir2_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\n} else\r\nbestsp[db] = cpu_to_be16(NULLDATAOFF);\r\n}\r\nelse if (db != mp->m_dirdatablk)\r\ndbp = NULL;\r\nxfs_dir2_leaf_check(dp, lbp);\r\nreturn xfs_dir2_leaf_to_block(args, lbp, dbp);\r\n}\r\nint\r\nxfs_dir2_leaf_replace(\r\nxfs_da_args_t *args)\r\n{\r\nstruct xfs_buf *dbp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_inode_t *dp;\r\nint error;\r\nint index;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nxfs_trans_t *tp;\r\ntrace_xfs_dir2_leaf_replace(args);\r\nif ((error = xfs_dir2_leaf_lookup_int(args, &lbp, &index, &dbp))) {\r\nreturn error;\r\n}\r\ndp = args->dp;\r\nleaf = lbp->b_addr;\r\nlep = &leaf->ents[index];\r\ndep = (xfs_dir2_data_entry_t *)\r\n((char *)dbp->b_addr +\r\nxfs_dir2_dataptr_to_off(dp->i_mount, be32_to_cpu(lep->address)));\r\nASSERT(args->inumber != be64_to_cpu(dep->inumber));\r\ndep->inumber = cpu_to_be64(args->inumber);\r\ntp = args->trans;\r\nxfs_dir2_data_log_entry(tp, dbp, dep);\r\nxfs_dir2_leaf_check(dp, lbp);\r\nxfs_trans_brelse(tp, lbp);\r\nreturn 0;\r\n}\r\nint\r\nxfs_dir2_leaf_search_hash(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *lbp)\r\n{\r\nxfs_dahash_t hash=0;\r\nxfs_dahash_t hashwant;\r\nint high;\r\nint low;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_entry_t *lep;\r\nint mid=0;\r\nleaf = lbp->b_addr;\r\n#ifndef __KERNEL__\r\nif (!leaf->hdr.count)\r\nreturn 0;\r\n#endif\r\nfor (lep = leaf->ents, low = 0, high = be16_to_cpu(leaf->hdr.count) - 1,\r\nhashwant = args->hashval;\r\nlow <= high; ) {\r\nmid = (low + high) >> 1;\r\nif ((hash = be32_to_cpu(lep[mid].hashval)) == hashwant)\r\nbreak;\r\nif (hash < hashwant)\r\nlow = mid + 1;\r\nelse\r\nhigh = mid - 1;\r\n}\r\nif (hash == hashwant) {\r\nwhile (mid > 0 && be32_to_cpu(lep[mid - 1].hashval) == hashwant) {\r\nmid--;\r\n}\r\n}\r\nelse if (hash < hashwant)\r\nmid++;\r\nreturn mid;\r\n}\r\nint\r\nxfs_dir2_leaf_trim_data(\r\nxfs_da_args_t *args,\r\nstruct xfs_buf *lbp,\r\nxfs_dir2_db_t db)\r\n{\r\n__be16 *bestsp;\r\nstruct xfs_buf *dbp;\r\nxfs_inode_t *dp;\r\nint error;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nif ((error = xfs_da_read_buf(tp, dp, xfs_dir2_db_to_da(mp, db), -1, &dbp,\r\nXFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nleaf = lbp->b_addr;\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\n#ifdef DEBUG\r\n{\r\nstruct xfs_dir2_data_hdr *hdr = dbp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC));\r\nASSERT(be16_to_cpu(hdr->bestfree[0].length) ==\r\nmp->m_dirblksize - (uint)sizeof(*hdr));\r\nASSERT(db == be32_to_cpu(ltp->bestcount) - 1);\r\n}\r\n#endif\r\nif ((error = xfs_dir2_shrink_inode(args, db, dbp))) {\r\nASSERT(error != ENOSPC);\r\nxfs_trans_brelse(tp, dbp);\r\nreturn error;\r\n}\r\nbestsp = xfs_dir2_leaf_bests_p(ltp);\r\nbe32_add_cpu(&ltp->bestcount, -1);\r\nmemmove(&bestsp[1], &bestsp[0], be32_to_cpu(ltp->bestcount) * sizeof(*bestsp));\r\nxfs_dir2_leaf_log_tail(tp, lbp);\r\nxfs_dir2_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\nreturn 0;\r\n}\r\nstatic inline size_t\r\nxfs_dir2_leaf_size(\r\nstruct xfs_dir2_leaf_hdr *hdr,\r\nint counts)\r\n{\r\nint entries;\r\nentries = be16_to_cpu(hdr->count) - be16_to_cpu(hdr->stale);\r\nreturn sizeof(xfs_dir2_leaf_hdr_t) +\r\nentries * sizeof(xfs_dir2_leaf_entry_t) +\r\ncounts * sizeof(xfs_dir2_data_off_t) +\r\nsizeof(xfs_dir2_leaf_tail_t);\r\n}\r\nint\r\nxfs_dir2_node_to_leaf(\r\nxfs_da_state_t *state)\r\n{\r\nxfs_da_args_t *args;\r\nxfs_inode_t *dp;\r\nint error;\r\nstruct xfs_buf *fbp;\r\nxfs_fileoff_t fo;\r\nxfs_dir2_free_t *free;\r\nstruct xfs_buf *lbp;\r\nxfs_dir2_leaf_tail_t *ltp;\r\nxfs_dir2_leaf_t *leaf;\r\nxfs_mount_t *mp;\r\nint rval;\r\nxfs_trans_t *tp;\r\nif (state->path.active > 1)\r\nreturn 0;\r\nargs = state->args;\r\ntrace_xfs_dir2_node_to_leaf(args);\r\nmp = state->mp;\r\ndp = args->dp;\r\ntp = args->trans;\r\nif ((error = xfs_bmap_last_offset(tp, dp, &fo, XFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nfo -= mp->m_dirblkfsbs;\r\nwhile (fo > mp->m_dirfreeblk) {\r\nif ((error = xfs_dir2_node_trim_free(args, fo, &rval))) {\r\nreturn error;\r\n}\r\nif (rval)\r\nfo -= mp->m_dirblkfsbs;\r\nelse\r\nreturn 0;\r\n}\r\nif ((error = xfs_bmap_last_before(tp, dp, &fo, XFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nif (XFS_FSB_TO_B(mp, fo) > XFS_DIR2_LEAF_OFFSET + mp->m_dirblksize)\r\nreturn 0;\r\nlbp = state->path.blk[0].bp;\r\nleaf = lbp->b_addr;\r\nASSERT(leaf->hdr.info.magic == cpu_to_be16(XFS_DIR2_LEAFN_MAGIC));\r\nif ((error = xfs_da_read_buf(tp, dp, mp->m_dirfreeblk, -1, &fbp,\r\nXFS_DATA_FORK))) {\r\nreturn error;\r\n}\r\nfree = fbp->b_addr;\r\nASSERT(free->hdr.magic == cpu_to_be32(XFS_DIR2_FREE_MAGIC));\r\nASSERT(!free->hdr.firstdb);\r\nif (xfs_dir2_leaf_size(&leaf->hdr, be32_to_cpu(free->hdr.nvalid)) >\r\nmp->m_dirblksize) {\r\nxfs_trans_brelse(tp, fbp);\r\nreturn 0;\r\n}\r\nif (be16_to_cpu(leaf->hdr.stale))\r\nxfs_dir2_leaf_compact(args, lbp);\r\nelse\r\nxfs_dir2_leaf_log_header(tp, lbp);\r\nleaf->hdr.info.magic = cpu_to_be16(XFS_DIR2_LEAF1_MAGIC);\r\nltp = xfs_dir2_leaf_tail_p(mp, leaf);\r\nltp->bestcount = free->hdr.nvalid;\r\nmemcpy(xfs_dir2_leaf_bests_p(ltp), free->bests,\r\nbe32_to_cpu(ltp->bestcount) * sizeof(xfs_dir2_data_off_t));\r\nxfs_dir2_leaf_log_bests(tp, lbp, 0, be32_to_cpu(ltp->bestcount) - 1);\r\nxfs_dir2_leaf_log_tail(tp, lbp);\r\nxfs_dir2_leaf_check(dp, lbp);\r\nerror = xfs_dir2_shrink_inode(args, XFS_DIR2_FREE_FIRSTDB(mp), fbp);\r\nif (error) {\r\nASSERT(error != ENOSPC);\r\nreturn error;\r\n}\r\nfbp = NULL;\r\nerror = xfs_dir2_leaf_to_block(args, lbp, NULL);\r\nstate->path.blk[0].bp = NULL;\r\nreturn error;\r\n}

static enum ta_frame_identity ta_detect_protocol(card_t *card, CsrWifiRouterCtrlProtocolDirection direction,\r\nconst bulk_data_desc_t *data,\r\nconst u8 *saddr,\r\nconst u8 *sta_macaddr)\r\n{\r\nta_data_t *tad = &card->ta_sampling;\r\nu16 proto;\r\nu16 source_port, dest_port;\r\nCsrWifiMacAddress srcAddress;\r\nu32 snap_hdr, oui_hdr;\r\nif (data->data_length < TA_LLC_HEADER_SIZE)\r\n{\r\nreturn TA_FRAME_UNKNOWN;\r\n}\r\nsnap_hdr = (((u32)data->os_data_ptr[0]) << 24) |\r\n(((u32)data->os_data_ptr[1]) << 16) |\r\n(((u32)data->os_data_ptr[2]) << 8);\r\nif (snap_hdr != snap_802_2)\r\n{\r\nreturn TA_FRAME_UNKNOWN;\r\n}\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_CUSTOM)\r\n{\r\n}\r\noui_hdr = (((u32)data->os_data_ptr[3]) << 24) |\r\n(((u32)data->os_data_ptr[4]) << 16) |\r\n(((u32)data->os_data_ptr[5]) << 8);\r\nif ((oui_hdr == oui_rfc1042) || (oui_hdr == oui_8021h))\r\n{\r\nproto = (data->os_data_ptr[TA_ETHERNET_TYPE_OFFSET] * 256) +\r\ndata->os_data_ptr[TA_ETHERNET_TYPE_OFFSET + 1];\r\nif (proto == TA_PROTO_TYPE_IP)\r\n{\r\nif (data->data_length > TA_IP_TYPE_OFFSET)\r\n{\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_CUSTOM)\r\n{\r\nta_l4stats_t *ta_l4stats = &tad->ta_l4stats;\r\nu8 l4proto = data->os_data_ptr[TA_IP_TYPE_OFFSET];\r\nif (l4proto == TA_IP_TYPE_TCP)\r\n{\r\nif (direction == CSR_WIFI_ROUTER_CTRL_PROTOCOL_DIRECTION_TX)\r\n{\r\nta_l4stats->txTcpBytesCount += data->data_length;\r\n}\r\nelse\r\n{\r\nta_l4stats->rxTcpBytesCount += data->data_length;\r\n}\r\n}\r\nelse if (l4proto == TA_IP_TYPE_UDP)\r\n{\r\nif (direction == CSR_WIFI_ROUTER_CTRL_PROTOCOL_DIRECTION_TX)\r\n{\r\nta_l4stats->txUdpBytesCount += data->data_length;\r\n}\r\nelse\r\n{\r\nta_l4stats->rxUdpBytesCount += data->data_length;\r\n}\r\n}\r\n}\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_DHCP)\r\n{\r\nif (data->os_data_ptr[TA_IP_TYPE_OFFSET] == TA_IP_TYPE_UDP)\r\n{\r\nif (data->data_length > TA_UDP_DEST_PORT_OFFSET)\r\n{\r\nsource_port = (data->os_data_ptr[TA_UDP_SOURCE_PORT_OFFSET] * 256) +\r\ndata->os_data_ptr[TA_UDP_SOURCE_PORT_OFFSET + 1];\r\ndest_port = (data->os_data_ptr[TA_UDP_DEST_PORT_OFFSET] * 256) +\r\ndata->os_data_ptr[TA_UDP_DEST_PORT_OFFSET + 1];\r\nif (((source_port == TA_UDP_PORT_BOOTPC) && (dest_port == TA_UDP_PORT_BOOTPS)) ||\r\n((source_port == TA_UDP_PORT_BOOTPS) && (dest_port == TA_UDP_PORT_BOOTPC)))\r\n{\r\nif (data->data_length > TA_DHCP_MESSAGE_TYPE_OFFSET + 6)\r\n{\r\nUNIFI_MAC_ADDRESS_COPY(srcAddress.a, saddr);\r\nif (direction == CSR_WIFI_ROUTER_CTRL_PROTOCOL_DIRECTION_TX)\r\n{\r\nunifi_ta_indicate_protocol(card->ospriv,\r\nCSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_DHCP,\r\ndirection,\r\n&srcAddress);\r\nreturn TA_FRAME_ETHERNET_UNINTERESTING;\r\n}\r\nif (UNIFI_MAC_ADDRESS_CMP(data->os_data_ptr + TA_BOOTP_CLIENT_MAC_ADDR_OFFSET, sta_macaddr) == TRUE)\r\n{\r\nif (data->os_data_ptr[TA_DHCP_MESSAGE_TYPE_OFFSET] == TA_DHCP_MESSAGE_TYPE_ACK)\r\n{\r\nunifi_ta_indicate_protocol(card->ospriv,\r\nCSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_DHCP_ACK,\r\ndirection,\r\n&srcAddress);\r\n}\r\nelse\r\n{\r\nunifi_ta_indicate_protocol(card->ospriv,\r\nCSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_DHCP,\r\ndirection,\r\n&srcAddress);\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\n}\r\nreturn TA_FRAME_ETHERNET_INTERESTING;\r\n}\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_EAPOL)\r\n{\r\nif (TA_PROTO_TYPE_EAP == proto || TA_PROTO_TYPE_WAI == proto)\r\n{\r\nif ((TA_PROTO_TYPE_WAI == proto) || (direction != CSR_WIFI_ROUTER_CTRL_PROTOCOL_DIRECTION_TX) ||\r\n(data->os_data_ptr[TA_EAPOL_TYPE_OFFSET] == TA_EAPOL_TYPE_START))\r\n{\r\nUNIFI_MAC_ADDRESS_COPY(srcAddress.a, saddr);\r\nunifi_ta_indicate_protocol(card->ospriv,\r\nCSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_EAPOL,\r\ndirection, &srcAddress);\r\n}\r\nreturn TA_FRAME_ETHERNET_UNINTERESTING;\r\n}\r\n}\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_ARP)\r\n{\r\nif (proto == TA_PROTO_TYPE_ARP)\r\n{\r\nUNIFI_MAC_ADDRESS_COPY(srcAddress.a, saddr);\r\nunifi_ta_indicate_protocol(card->ospriv,\r\nCSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_ARP,\r\ndirection, &srcAddress);\r\nreturn TA_FRAME_ETHERNET_UNINTERESTING;\r\n}\r\n}\r\nreturn TA_FRAME_ETHERNET_INTERESTING;\r\n}\r\nelse if (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_AIRONET)\r\n{\r\nif (!memcmp(data->os_data_ptr + 3, aironet_snap, 5))\r\n{\r\nUNIFI_MAC_ADDRESS_COPY(srcAddress.a, saddr);\r\nunifi_ta_indicate_protocol(card->ospriv, CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_AIRONET,\r\ndirection, &srcAddress);\r\n}\r\n}\r\nreturn TA_FRAME_ETHERNET_UNINTERESTING;\r\n}\r\nstatic void tas_reset_data(ta_data_t *tad)\r\n{\r\ns16 i;\r\nfor (i = 0; i < (TA_INTERVALS_NUM + 1); i++)\r\n{\r\ntad->stats.intervals[i] = 0;\r\n}\r\ntad->stats.rxFramesNum = 0;\r\ntad->stats.txFramesNum = 0;\r\ntad->stats.rxBytesCount = 0;\r\ntad->stats.txBytesCount = 0;\r\ntad->stats.rxMeanRate = 0;\r\ntad->rx_sum_rate = 0;\r\ntad->ta_l4stats.rxTcpBytesCount = 0;\r\ntad->ta_l4stats.txTcpBytesCount = 0;\r\ntad->ta_l4stats.rxUdpBytesCount = 0;\r\ntad->ta_l4stats.txUdpBytesCount = 0;\r\n}\r\nvoid unifi_ta_sampling_init(card_t *card)\r\n{\r\n(void)unifi_ta_configure(card, CSR_WIFI_ROUTER_CTRL_TRAFFIC_CONFIG_TYPE_RESET, NULL);\r\ncard->ta_sampling.packet_filter = CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_NONE;\r\ncard->ta_sampling.traffic_type = CSR_WIFI_ROUTER_CTRL_TRAFFIC_TYPE_OCCASIONAL;\r\n}\r\nvoid unifi_ta_sample(card_t *card,\r\nCsrWifiRouterCtrlProtocolDirection direction,\r\nconst bulk_data_desc_t *data,\r\nconst u8 *saddr,\r\nconst u8 *sta_macaddr,\r\nu32 timestamp,\r\nu16 rate)\r\n{\r\nta_data_t *tad = &card->ta_sampling;\r\nenum ta_frame_identity identity;\r\nu32 time_delta;\r\nif (tad->packet_filter != CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_NONE)\r\n{\r\nidentity = ta_detect_protocol(card, direction, data, saddr, sta_macaddr);\r\n}\r\nelse\r\n{\r\nidentity = TA_FRAME_ETHERNET_INTERESTING;\r\n}\r\nif (direction == CSR_WIFI_ROUTER_CTRL_PROTOCOL_DIRECTION_RX)\r\n{\r\ntad->stats.rxFramesNum++;\r\ntad->stats.rxBytesCount += data->data_length;\r\ntad->rx_sum_rate += rate;\r\n}\r\nelse\r\n{\r\nif (identity == TA_FRAME_ETHERNET_INTERESTING)\r\n{\r\nif (tad->stats.txFramesNum < TA_MAX_INTERVALS_IN_C1)\r\n{\r\nu32 interval;\r\nu32 index_in_intervals;\r\ninterval = timestamp - tad->tx_last_ts;\r\ntad->tx_last_ts = timestamp;\r\nindex_in_intervals = (interval + TA_INTERVALS_STEP / 2 - 1) / TA_INTERVALS_STEP;\r\nif (index_in_intervals <= TA_INTERVALS_NUM)\r\n{\r\nunifi_trace(card->ospriv, UDBG5,\r\n"unifi_ta_sample: TX interval=%d index=%d\n",\r\ninterval, index_in_intervals);\r\ntad->stats.intervals[index_in_intervals]++;\r\n}\r\n}\r\n}\r\ntad->stats.txFramesNum++;\r\ntad->stats.txBytesCount += data->data_length;\r\n}\r\ntime_delta = timestamp - tad->last_indication_time;\r\nif (time_delta >= 1000)\r\n{\r\nu32 temp_rxFramesNum;\r\ntemp_rxFramesNum = tad->stats.rxFramesNum;\r\nif (temp_rxFramesNum)\r\n{\r\ntad->stats.rxMeanRate = tad->rx_sum_rate / temp_rxFramesNum;\r\n}\r\nunifi_trace(card->ospriv, UDBG5,\r\n"unifi_ta_sample: RX fr=%lu, r=%u, sum=%lu, av=%lu\n",\r\ntad->stats.rxFramesNum, rate,\r\ntad->rx_sum_rate, tad->stats.rxMeanRate);\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_CUSTOM)\r\n{\r\nu32 rxTcpThroughput = tad->ta_l4stats.rxTcpBytesCount / time_delta;\r\nu32 txTcpThroughput = tad->ta_l4stats.txTcpBytesCount / time_delta;\r\nu32 rxUdpThroughput = tad->ta_l4stats.rxUdpBytesCount / time_delta;\r\nu32 txUdpThroughput = tad->ta_l4stats.txUdpBytesCount / time_delta;\r\nunifi_ta_indicate_l4stats(card->ospriv,\r\nrxTcpThroughput,\r\ntxTcpThroughput,\r\nrxUdpThroughput,\r\ntxUdpThroughput\r\n);\r\n}\r\nunifi_ta_indicate_sampling(card->ospriv, &tad->stats);\r\ntas_reset_data(tad);\r\ntad->last_indication_time = timestamp;\r\n}\r\n}\r\nCsrResult unifi_ta_configure(card_t *card,\r\nCsrWifiRouterCtrlTrafficConfigType config_type,\r\nconst CsrWifiRouterCtrlTrafficConfig *config)\r\n{\r\nta_data_t *tad = &card->ta_sampling;\r\nif (config_type == CSR_WIFI_ROUTER_CTRL_TRAFFIC_CONFIG_TYPE_RESET)\r\n{\r\ntas_reset_data(tad);\r\ntad->tx_last_ts = 0;\r\ntad->last_indication_time = 0;\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nif (config_type == CSR_WIFI_ROUTER_CTRL_TRAFFIC_CONFIG_TYPE_FILTER)\r\n{\r\ntad->packet_filter = config->packetFilter;\r\nif (tad->packet_filter & CSR_WIFI_ROUTER_CTRL_TRAFFIC_PACKET_TYPE_CUSTOM)\r\n{\r\ntad->custom_filter = config->customFilter;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nreturn CSR_RESULT_SUCCESS;\r\n}\r\nvoid unifi_ta_classification(card_t *card,\r\nCsrWifiRouterCtrlTrafficType traffic_type,\r\nu16 period)\r\n{\r\nunifi_trace(card->ospriv, UDBG3,\r\n"Changed current ta classification to: %d\n", traffic_type);\r\ncard->ta_sampling.traffic_type = traffic_type;\r\n}

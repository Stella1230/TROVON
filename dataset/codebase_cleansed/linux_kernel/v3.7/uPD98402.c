static int fetch_stats(struct atm_dev *dev,struct sonet_stats __user *arg,int zero)\r\n{\r\nstruct sonet_stats tmp;\r\nint error = 0;\r\natomic_add(GET(HECCT),&PRIV(dev)->sonet_stats.uncorr_hcs);\r\nsonet_copy_stats(&PRIV(dev)->sonet_stats,&tmp);\r\nif (arg) error = copy_to_user(arg,&tmp,sizeof(tmp));\r\nif (zero && !error) {\r\ntmp.corr_hcs = tmp.tx_cells = tmp.rx_cells = 0;\r\nsonet_subtract_stats(&PRIV(dev)->sonet_stats,&tmp);\r\n}\r\nreturn error ? -EFAULT : 0;\r\n}\r\nstatic int set_framing(struct atm_dev *dev,unsigned char framing)\r\n{\r\nstatic const unsigned char sonet[] = { 1,2,3,0 };\r\nstatic const unsigned char sdh[] = { 1,0,0,2 };\r\nconst char *set;\r\nunsigned long flags;\r\nswitch (framing) {\r\ncase SONET_FRAME_SONET:\r\nset = sonet;\r\nbreak;\r\ncase SONET_FRAME_SDH:\r\nset = sdh;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irqsave(&PRIV(dev)->lock, flags);\r\nPUT(set[0],C11T);\r\nPUT(set[1],C12T);\r\nPUT(set[2],C13T);\r\nPUT((GET(MDR) & ~uPD98402_MDR_SS_MASK) | (set[3] <<\r\nuPD98402_MDR_SS_SHIFT),MDR);\r\nspin_unlock_irqrestore(&PRIV(dev)->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int get_sense(struct atm_dev *dev,u8 __user *arg)\r\n{\r\nunsigned long flags;\r\nunsigned char s[3];\r\nspin_lock_irqsave(&PRIV(dev)->lock, flags);\r\ns[0] = GET(C11R);\r\ns[1] = GET(C12R);\r\ns[2] = GET(C13R);\r\nspin_unlock_irqrestore(&PRIV(dev)->lock, flags);\r\nreturn (put_user(s[0], arg) || put_user(s[1], arg+1) ||\r\nput_user(s[2], arg+2) || put_user(0xff, arg+3) ||\r\nput_user(0xff, arg+4) || put_user(0xff, arg+5)) ? -EFAULT : 0;\r\n}\r\nstatic int set_loopback(struct atm_dev *dev,int mode)\r\n{\r\nunsigned char mode_reg;\r\nmode_reg = GET(MDR) & ~(uPD98402_MDR_TPLP | uPD98402_MDR_ALP |\r\nuPD98402_MDR_RPLP);\r\nswitch (__ATM_LM_XTLOC(mode)) {\r\ncase __ATM_LM_NONE:\r\nbreak;\r\ncase __ATM_LM_PHY:\r\nmode_reg |= uPD98402_MDR_TPLP;\r\nbreak;\r\ncase __ATM_LM_ATM:\r\nmode_reg |= uPD98402_MDR_ALP;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (__ATM_LM_XTRMT(mode)) {\r\ncase __ATM_LM_NONE:\r\nbreak;\r\ncase __ATM_LM_PHY:\r\nmode_reg |= uPD98402_MDR_RPLP;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nPUT(mode_reg,MDR);\r\nPRIV(dev)->loop_mode = mode;\r\nreturn 0;\r\n}\r\nstatic int uPD98402_ioctl(struct atm_dev *dev,unsigned int cmd,void __user *arg)\r\n{\r\nswitch (cmd) {\r\ncase SONET_GETSTATZ:\r\ncase SONET_GETSTAT:\r\nreturn fetch_stats(dev,arg, cmd == SONET_GETSTATZ);\r\ncase SONET_SETFRAMING:\r\nreturn set_framing(dev, (int)(unsigned long)arg);\r\ncase SONET_GETFRAMING:\r\nreturn put_user(PRIV(dev)->framing,(int __user *)arg) ?\r\n-EFAULT : 0;\r\ncase SONET_GETFRSENSE:\r\nreturn get_sense(dev,arg);\r\ncase ATM_SETLOOP:\r\nreturn set_loopback(dev, (int)(unsigned long)arg);\r\ncase ATM_GETLOOP:\r\nreturn put_user(PRIV(dev)->loop_mode,(int __user *)arg) ?\r\n-EFAULT : 0;\r\ncase ATM_QUERYLOOP:\r\nreturn put_user(ATM_LM_LOC_PHY | ATM_LM_LOC_ATM |\r\nATM_LM_RMT_PHY,(int __user *)arg) ? -EFAULT : 0;\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}\r\nstatic void stat_event(struct atm_dev *dev)\r\n{\r\nunsigned char events;\r\nevents = GET(PCR);\r\nif (events & uPD98402_PFM_PFEB) ADD_LIMITED(path_febe,PFECB);\r\nif (events & uPD98402_PFM_LFEB) ADD_LIMITED(line_febe,LECCT);\r\nif (events & uPD98402_PFM_B3E) ADD_LIMITED(path_bip,B3ECT);\r\nif (events & uPD98402_PFM_B2E) ADD_LIMITED(line_bip,B2ECT);\r\nif (events & uPD98402_PFM_B1E) ADD_LIMITED(section_bip,B1ECT);\r\n}\r\nstatic void uPD98402_int(struct atm_dev *dev)\r\n{\r\nstatic unsigned long silence = 0;\r\nunsigned char reason;\r\nwhile ((reason = GET(PICR))) {\r\nif (reason & uPD98402_INT_LOS)\r\nprintk(KERN_NOTICE "%s(itf %d): signal lost\n",\r\ndev->type,dev->number);\r\nif (reason & uPD98402_INT_PFM) stat_event(dev);\r\nif (reason & uPD98402_INT_PCO) {\r\n(void) GET(PCOCR);\r\natomic_add(GET(HECCT),\r\n&PRIV(dev)->sonet_stats.uncorr_hcs);\r\n}\r\nif ((reason & uPD98402_INT_RFO) &&\r\n(time_after(jiffies, silence) || silence == 0)) {\r\nprintk(KERN_WARNING "%s(itf %d): uPD98402 receive "\r\n"FIFO overflow\n",dev->type,dev->number);\r\nsilence = (jiffies+HZ/2)|1;\r\n}\r\n}\r\n}\r\nstatic int uPD98402_start(struct atm_dev *dev)\r\n{\r\nDPRINTK("phy_start\n");\r\nif (!(dev->dev_data = kmalloc(sizeof(struct uPD98402_priv),GFP_KERNEL)))\r\nreturn -ENOMEM;\r\nspin_lock_init(&PRIV(dev)->lock);\r\nmemset(&PRIV(dev)->sonet_stats,0,sizeof(struct k_sonet_stats));\r\n(void) GET(PCR);\r\nPUT(uPD98402_PFM_FJ,PCMR);\r\n(void) GET(PCOCR);\r\nPUT(~uPD98402_PCO_HECC,PCOMR);\r\n(void) GET(PICR);\r\nPUT(~(uPD98402_INT_PFM | uPD98402_INT_ALM | uPD98402_INT_RFO |\r\nuPD98402_INT_LOS),PIMR);\r\n(void) fetch_stats(dev,NULL,1);\r\natomic_set(&PRIV(dev)->sonet_stats.corr_hcs,-1);\r\natomic_set(&PRIV(dev)->sonet_stats.tx_cells,-1);\r\natomic_set(&PRIV(dev)->sonet_stats.rx_cells,-1);\r\nreturn 0;\r\n}\r\nstatic int uPD98402_stop(struct atm_dev *dev)\r\n{\r\nkfree(PRIV(dev));\r\nreturn 0;\r\n}\r\nint uPD98402_init(struct atm_dev *dev)\r\n{\r\nDPRINTK("phy_init\n");\r\ndev->phy = &uPD98402_ops;\r\nreturn 0;\r\n}\r\nstatic __init int uPD98402_module_init(void)\r\n{\r\nreturn 0;\r\n}

static void random_recv_done(struct virtqueue *vq)\r\n{\r\nif (!virtqueue_get_buf(vq, &data_avail))\r\nreturn;\r\ncomplete(&have_data);\r\n}\r\nstatic void register_buffer(u8 *buf, size_t size)\r\n{\r\nstruct scatterlist sg;\r\nsg_init_one(&sg, buf, size);\r\nif (virtqueue_add_buf(vq, &sg, 0, 1, buf, GFP_KERNEL) < 0)\r\nBUG();\r\nvirtqueue_kick(vq);\r\n}\r\nstatic int virtio_read(struct hwrng *rng, void *buf, size_t size, bool wait)\r\n{\r\nint ret;\r\nif (!busy) {\r\nbusy = true;\r\ninit_completion(&have_data);\r\nregister_buffer(buf, size);\r\n}\r\nif (!wait)\r\nreturn 0;\r\nret = wait_for_completion_killable(&have_data);\r\nif (ret < 0)\r\nreturn ret;\r\nbusy = false;\r\nreturn data_avail;\r\n}\r\nstatic void virtio_cleanup(struct hwrng *rng)\r\n{\r\nif (busy)\r\nwait_for_completion(&have_data);\r\n}\r\nstatic int probe_common(struct virtio_device *vdev)\r\n{\r\nint err;\r\nvq = virtio_find_single_vq(vdev, random_recv_done, "input");\r\nif (IS_ERR(vq))\r\nreturn PTR_ERR(vq);\r\nerr = hwrng_register(&virtio_hwrng);\r\nif (err) {\r\nvdev->config->del_vqs(vdev);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void remove_common(struct virtio_device *vdev)\r\n{\r\nvdev->config->reset(vdev);\r\nbusy = false;\r\nhwrng_unregister(&virtio_hwrng);\r\nvdev->config->del_vqs(vdev);\r\n}\r\nstatic int virtrng_probe(struct virtio_device *vdev)\r\n{\r\nreturn probe_common(vdev);\r\n}\r\nstatic void __devexit virtrng_remove(struct virtio_device *vdev)\r\n{\r\nremove_common(vdev);\r\n}\r\nstatic int virtrng_freeze(struct virtio_device *vdev)\r\n{\r\nremove_common(vdev);\r\nreturn 0;\r\n}\r\nstatic int virtrng_restore(struct virtio_device *vdev)\r\n{\r\nreturn probe_common(vdev);\r\n}\r\nstatic int __init init(void)\r\n{\r\nreturn register_virtio_driver(&virtio_rng_driver);\r\n}\r\nstatic void __exit fini(void)\r\n{\r\nunregister_virtio_driver(&virtio_rng_driver);\r\n}

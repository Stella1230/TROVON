static int tps6507x_i2c_read_device(struct tps6507x_dev *tps6507x, char reg,\r\nint bytes, void *dest)\r\n{\r\nstruct i2c_client *i2c = tps6507x->i2c_client;\r\nstruct i2c_msg xfer[2];\r\nint ret;\r\nxfer[0].addr = i2c->addr;\r\nxfer[0].flags = 0;\r\nxfer[0].len = 1;\r\nxfer[0].buf = &reg;\r\nxfer[1].addr = i2c->addr;\r\nxfer[1].flags = I2C_M_RD;\r\nxfer[1].len = bytes;\r\nxfer[1].buf = dest;\r\nret = i2c_transfer(i2c->adapter, xfer, 2);\r\nif (ret == 2)\r\nret = 0;\r\nelse if (ret >= 0)\r\nret = -EIO;\r\nreturn ret;\r\n}\r\nstatic int tps6507x_i2c_write_device(struct tps6507x_dev *tps6507x, char reg,\r\nint bytes, void *src)\r\n{\r\nstruct i2c_client *i2c = tps6507x->i2c_client;\r\nu8 msg[TPS6507X_MAX_REGISTER + 1];\r\nint ret;\r\nif (bytes > TPS6507X_MAX_REGISTER)\r\nreturn -EINVAL;\r\nmsg[0] = reg;\r\nmemcpy(&msg[1], src, bytes);\r\nret = i2c_master_send(i2c, msg, bytes + 1);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret != bytes + 1)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nstatic int tps6507x_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tps6507x_dev *tps6507x;\r\nint ret = 0;\r\ntps6507x = kzalloc(sizeof(struct tps6507x_dev), GFP_KERNEL);\r\nif (tps6507x == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, tps6507x);\r\ntps6507x->dev = &i2c->dev;\r\ntps6507x->i2c_client = i2c;\r\ntps6507x->read_dev = tps6507x_i2c_read_device;\r\ntps6507x->write_dev = tps6507x_i2c_write_device;\r\nret = mfd_add_devices(tps6507x->dev, -1,\r\ntps6507x_devs, ARRAY_SIZE(tps6507x_devs),\r\nNULL, 0, NULL);\r\nif (ret < 0)\r\ngoto err;\r\nreturn ret;\r\nerr:\r\nmfd_remove_devices(tps6507x->dev);\r\nkfree(tps6507x);\r\nreturn ret;\r\n}\r\nstatic int tps6507x_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct tps6507x_dev *tps6507x = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(tps6507x->dev);\r\nkfree(tps6507x);\r\nreturn 0;\r\n}\r\nstatic int __init tps6507x_i2c_init(void)\r\n{\r\nreturn i2c_add_driver(&tps6507x_i2c_driver);\r\n}\r\nstatic void __exit tps6507x_i2c_exit(void)\r\n{\r\ni2c_del_driver(&tps6507x_i2c_driver);\r\n}

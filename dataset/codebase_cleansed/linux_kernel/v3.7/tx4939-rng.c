static void rng_io_start(void)\r\n{\r\n#ifndef CONFIG_64BIT\r\nlocal_irq_disable();\r\n#endif\r\n}\r\nstatic void rng_io_end(void)\r\n{\r\n#ifndef CONFIG_64BIT\r\nlocal_irq_enable();\r\n#endif\r\n}\r\nstatic u64 read_rng(void __iomem *base, unsigned int offset)\r\n{\r\nreturn ____raw_readq(base + offset);\r\n}\r\nstatic void write_rng(u64 val, void __iomem *base, unsigned int offset)\r\n{\r\nreturn ____raw_writeq(val, base + offset);\r\n}\r\nstatic int tx4939_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nstruct tx4939_rng *rngdev = container_of(rng, struct tx4939_rng, rng);\r\nint i;\r\nif (rngdev->data_avail)\r\nreturn rngdev->data_avail;\r\nfor (i = 0; i < 20; i++) {\r\nrng_io_start();\r\nif (!(read_rng(rngdev->base, TX4939_RNG_RCSR)\r\n& TX4939_RNG_RCSR_ST)) {\r\nrngdev->databuf[0] =\r\nread_rng(rngdev->base, TX4939_RNG_ROR(0));\r\nrngdev->databuf[1] =\r\nread_rng(rngdev->base, TX4939_RNG_ROR(1));\r\nrngdev->databuf[2] =\r\nread_rng(rngdev->base, TX4939_RNG_ROR(2));\r\nrngdev->data_avail =\r\nsizeof(rngdev->databuf) / sizeof(u32);\r\nwrite_rng(TX4939_RNG_RCSR_ST,\r\nrngdev->base, TX4939_RNG_RCSR);\r\nwait = 0;\r\n}\r\nrng_io_end();\r\nif (!wait)\r\nbreak;\r\nndelay(90 * 5);\r\n}\r\nreturn rngdev->data_avail;\r\n}\r\nstatic int tx4939_rng_data_read(struct hwrng *rng, u32 *buffer)\r\n{\r\nstruct tx4939_rng *rngdev = container_of(rng, struct tx4939_rng, rng);\r\nrngdev->data_avail--;\r\n*buffer = *((u32 *)&rngdev->databuf + rngdev->data_avail);\r\nreturn sizeof(u32);\r\n}\r\nstatic int __init tx4939_rng_probe(struct platform_device *dev)\r\n{\r\nstruct tx4939_rng *rngdev;\r\nstruct resource *r;\r\nint i;\r\nr = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!r)\r\nreturn -EBUSY;\r\nrngdev = devm_kzalloc(&dev->dev, sizeof(*rngdev), GFP_KERNEL);\r\nif (!rngdev)\r\nreturn -ENOMEM;\r\nrngdev->base = devm_request_and_ioremap(&dev->dev, r);\r\nif (!rngdev->base)\r\nreturn -EBUSY;\r\nrngdev->rng.name = dev_name(&dev->dev);\r\nrngdev->rng.data_present = tx4939_rng_data_present;\r\nrngdev->rng.data_read = tx4939_rng_data_read;\r\nrng_io_start();\r\nwrite_rng(TX4939_RNG_RCSR_RST, rngdev->base, TX4939_RNG_RCSR);\r\nwrite_rng(0, rngdev->base, TX4939_RNG_RCSR);\r\nwrite_rng(TX4939_RNG_RCSR_ST, rngdev->base, TX4939_RNG_RCSR);\r\nrng_io_end();\r\nfor (i = 0; i < 2; i++) {\r\nrngdev->data_avail = 0;\r\nif (!tx4939_rng_data_present(&rngdev->rng, 1))\r\nreturn -EIO;\r\n}\r\nplatform_set_drvdata(dev, rngdev);\r\nreturn hwrng_register(&rngdev->rng);\r\n}\r\nstatic int __exit tx4939_rng_remove(struct platform_device *dev)\r\n{\r\nstruct tx4939_rng *rngdev = platform_get_drvdata(dev);\r\nhwrng_unregister(&rngdev->rng);\r\nplatform_set_drvdata(dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init tx4939rng_init(void)\r\n{\r\nreturn platform_driver_probe(&tx4939_rng_driver, tx4939_rng_probe);\r\n}\r\nstatic void __exit tx4939rng_exit(void)\r\n{\r\nplatform_driver_unregister(&tx4939_rng_driver);\r\n}

static inline struct hdmiphy_ctx *sd_to_ctx(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct hdmiphy_ctx, sd);\r\n}\r\nstatic unsigned long hdmiphy_preset_to_pixclk(u32 preset)\r\n{\r\nstatic const unsigned long pixclk[] = {\r\n[V4L2_DV_480P59_94] = 27000000,\r\n[V4L2_DV_576P50] = 27000000,\r\n[V4L2_DV_720P59_94] = 74176000,\r\n[V4L2_DV_720P50] = 74250000,\r\n[V4L2_DV_720P60] = 74250000,\r\n[V4L2_DV_1080P24] = 74250000,\r\n[V4L2_DV_1080P30] = 74250000,\r\n[V4L2_DV_1080I50] = 74250000,\r\n[V4L2_DV_1080I60] = 74250000,\r\n[V4L2_DV_1080P50] = 148500000,\r\n[V4L2_DV_1080P60] = 148500000,\r\n};\r\nif (preset < ARRAY_SIZE(pixclk))\r\nreturn pixclk[preset];\r\nelse\r\nreturn 0;\r\n}\r\nstatic const u8 *hdmiphy_find_conf(u32 preset, const struct hdmiphy_conf *conf)\r\n{\r\nunsigned long pixclk;\r\npixclk = hdmiphy_preset_to_pixclk(preset);\r\nif (!pixclk)\r\nreturn NULL;\r\nfor (; conf->pixclk; ++conf)\r\nif (conf->pixclk == pixclk)\r\nreturn conf->data;\r\nreturn NULL;\r\n}\r\nstatic int hdmiphy_s_power(struct v4l2_subdev *sd, int on)\r\n{\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_s_dv_preset(struct v4l2_subdev *sd,\r\nstruct v4l2_dv_preset *preset)\r\n{\r\nconst u8 *data;\r\nu8 buffer[32];\r\nint ret;\r\nstruct hdmiphy_ctx *ctx = sd_to_ctx(sd);\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nstruct device *dev = &client->dev;\r\ndev_info(dev, "s_dv_preset(preset = %d)\n", preset->preset);\r\ndata = hdmiphy_find_conf(preset->preset, ctx->conf_tab);\r\nif (!data) {\r\ndev_err(dev, "format not supported\n");\r\nreturn -EINVAL;\r\n}\r\nmemcpy(buffer, data, 32);\r\nret = i2c_master_send(client, buffer, 32);\r\nif (ret != 32) {\r\ndev_err(dev, "failed to configure HDMIPHY via I2C\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmiphy_s_stream(struct v4l2_subdev *sd, int enable)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nstruct device *dev = &client->dev;\r\nu8 buffer[2];\r\nint ret;\r\ndev_info(dev, "s_stream(%d)\n", enable);\r\nbuffer[0] = 0x1f;\r\nbuffer[1] = enable ? 0x80 : 0x00;\r\nret = i2c_master_send(client, buffer, 2);\r\nif (ret != 2) {\r\ndev_err(dev, "stream (%d) failed\n", enable);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit hdmiphy_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct hdmiphy_ctx *ctx;\r\nctx = kzalloc(sizeof *ctx, GFP_KERNEL);\r\nif (!ctx)\r\nreturn -ENOMEM;\r\nctx->conf_tab = (struct hdmiphy_conf *)id->driver_data;\r\nv4l2_i2c_subdev_init(&ctx->sd, client, &hdmiphy_ops);\r\ndev_info(&client->dev, "probe successful\n");\r\nreturn 0;\r\n}\r\nstatic int __devexit hdmiphy_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nstruct hdmiphy_ctx *ctx = sd_to_ctx(sd);\r\nkfree(ctx);\r\ndev_info(&client->dev, "remove successful\n");\r\nreturn 0;\r\n}

static int m48t86_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char reg;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct m48t86_ops *ops = pdev->dev.platform_data;\r\nreg = ops->readbyte(M48T86_REG_B);\r\nif (reg & M48T86_REG_B_DM) {\r\ntm->tm_sec = ops->readbyte(M48T86_REG_SEC);\r\ntm->tm_min = ops->readbyte(M48T86_REG_MIN);\r\ntm->tm_hour = ops->readbyte(M48T86_REG_HOUR) & 0x3F;\r\ntm->tm_mday = ops->readbyte(M48T86_REG_DOM);\r\ntm->tm_mon = ops->readbyte(M48T86_REG_MONTH) - 1;\r\ntm->tm_year = ops->readbyte(M48T86_REG_YEAR) + 100;\r\ntm->tm_wday = ops->readbyte(M48T86_REG_DOW);\r\n} else {\r\ntm->tm_sec = bcd2bin(ops->readbyte(M48T86_REG_SEC));\r\ntm->tm_min = bcd2bin(ops->readbyte(M48T86_REG_MIN));\r\ntm->tm_hour = bcd2bin(ops->readbyte(M48T86_REG_HOUR) & 0x3F);\r\ntm->tm_mday = bcd2bin(ops->readbyte(M48T86_REG_DOM));\r\ntm->tm_mon = bcd2bin(ops->readbyte(M48T86_REG_MONTH)) - 1;\r\ntm->tm_year = bcd2bin(ops->readbyte(M48T86_REG_YEAR)) + 100;\r\ntm->tm_wday = bcd2bin(ops->readbyte(M48T86_REG_DOW));\r\n}\r\nif (!(reg & M48T86_REG_B_H24))\r\nif (ops->readbyte(M48T86_REG_HOUR) & 0x80)\r\ntm->tm_hour += 12;\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int m48t86_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned char reg;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct m48t86_ops *ops = pdev->dev.platform_data;\r\nreg = ops->readbyte(M48T86_REG_B);\r\nreg |= M48T86_REG_B_SET | M48T86_REG_B_H24;\r\nops->writebyte(reg, M48T86_REG_B);\r\nif (reg & M48T86_REG_B_DM) {\r\nops->writebyte(tm->tm_sec, M48T86_REG_SEC);\r\nops->writebyte(tm->tm_min, M48T86_REG_MIN);\r\nops->writebyte(tm->tm_hour, M48T86_REG_HOUR);\r\nops->writebyte(tm->tm_mday, M48T86_REG_DOM);\r\nops->writebyte(tm->tm_mon + 1, M48T86_REG_MONTH);\r\nops->writebyte(tm->tm_year % 100, M48T86_REG_YEAR);\r\nops->writebyte(tm->tm_wday, M48T86_REG_DOW);\r\n} else {\r\nops->writebyte(bin2bcd(tm->tm_sec), M48T86_REG_SEC);\r\nops->writebyte(bin2bcd(tm->tm_min), M48T86_REG_MIN);\r\nops->writebyte(bin2bcd(tm->tm_hour), M48T86_REG_HOUR);\r\nops->writebyte(bin2bcd(tm->tm_mday), M48T86_REG_DOM);\r\nops->writebyte(bin2bcd(tm->tm_mon + 1), M48T86_REG_MONTH);\r\nops->writebyte(bin2bcd(tm->tm_year % 100), M48T86_REG_YEAR);\r\nops->writebyte(bin2bcd(tm->tm_wday), M48T86_REG_DOW);\r\n}\r\nreg &= ~M48T86_REG_B_SET;\r\nops->writebyte(reg, M48T86_REG_B);\r\nreturn 0;\r\n}\r\nstatic int m48t86_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nunsigned char reg;\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct m48t86_ops *ops = pdev->dev.platform_data;\r\nreg = ops->readbyte(M48T86_REG_B);\r\nseq_printf(seq, "mode\t\t: %s\n",\r\n(reg & M48T86_REG_B_DM) ? "binary" : "bcd");\r\nreg = ops->readbyte(M48T86_REG_D);\r\nseq_printf(seq, "battery\t\t: %s\n",\r\n(reg & M48T86_REG_D_VRT) ? "ok" : "exhausted");\r\nreturn 0;\r\n}\r\nstatic int __devinit m48t86_rtc_probe(struct platform_device *dev)\r\n{\r\nunsigned char reg;\r\nstruct m48t86_ops *ops = dev->dev.platform_data;\r\nstruct rtc_device *rtc = rtc_device_register("m48t86",\r\n&dev->dev, &m48t86_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nplatform_set_drvdata(dev, rtc);\r\nreg = ops->readbyte(M48T86_REG_D);\r\ndev_info(&dev->dev, "battery %s\n",\r\n(reg & M48T86_REG_D_VRT) ? "ok" : "exhausted");\r\nreturn 0;\r\n}\r\nstatic int __devexit m48t86_rtc_remove(struct platform_device *dev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(dev);\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nplatform_set_drvdata(dev, NULL);\r\nreturn 0;\r\n}

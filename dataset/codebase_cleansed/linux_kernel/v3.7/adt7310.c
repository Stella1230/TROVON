static int adt7310_spi_read_word(struct adt7310_chip_info *chip, u8 reg, u16 *data)\r\n{\r\nstruct spi_device *spi_dev = chip->spi_dev;\r\nu8 command = (reg << ADT7310_CMD_REG_OFFSET) & ADT7310_CMD_REG_MASK;\r\nint ret = 0;\r\ncommand |= ADT7310_CMD_READ;\r\nret = spi_write(spi_dev, &command, sizeof(command));\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI write command error\n");\r\nreturn ret;\r\n}\r\nret = spi_read(spi_dev, (u8 *)data, sizeof(*data));\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI read word error\n");\r\nreturn ret;\r\n}\r\n*data = be16_to_cpu(*data);\r\nreturn 0;\r\n}\r\nstatic int adt7310_spi_write_word(struct adt7310_chip_info *chip, u8 reg, u16 data)\r\n{\r\nstruct spi_device *spi_dev = chip->spi_dev;\r\nu8 buf[3];\r\nint ret = 0;\r\nbuf[0] = (reg << ADT7310_CMD_REG_OFFSET) & ADT7310_CMD_REG_MASK;\r\nbuf[1] = (u8)(data >> 8);\r\nbuf[2] = (u8)(data & 0xFF);\r\nret = spi_write(spi_dev, buf, 3);\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI write word error\n");\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic int adt7310_spi_read_byte(struct adt7310_chip_info *chip, u8 reg, u8 *data)\r\n{\r\nstruct spi_device *spi_dev = chip->spi_dev;\r\nu8 command = (reg << ADT7310_CMD_REG_OFFSET) & ADT7310_CMD_REG_MASK;\r\nint ret = 0;\r\ncommand |= ADT7310_CMD_READ;\r\nret = spi_write(spi_dev, &command, sizeof(command));\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI write command error\n");\r\nreturn ret;\r\n}\r\nret = spi_read(spi_dev, data, sizeof(*data));\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI read byte error\n");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int adt7310_spi_write_byte(struct adt7310_chip_info *chip, u8 reg, u8 data)\r\n{\r\nstruct spi_device *spi_dev = chip->spi_dev;\r\nu8 buf[2];\r\nint ret = 0;\r\nbuf[0] = (reg << ADT7310_CMD_REG_OFFSET) & ADT7310_CMD_REG_MASK;\r\nbuf[1] = data;\r\nret = spi_write(spi_dev, buf, 2);\r\nif (ret < 0) {\r\ndev_err(&spi_dev->dev, "SPI write byte error\n");\r\nreturn ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic ssize_t adt7310_show_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nu8 config;\r\nconfig = chip->config & ADT7310_MODE_MASK;\r\nswitch (config) {\r\ncase ADT7310_PD:\r\nreturn sprintf(buf, "power-down\n");\r\ncase ADT7310_ONESHOT:\r\nreturn sprintf(buf, "one-shot\n");\r\ncase ADT7310_SPS:\r\nreturn sprintf(buf, "sps\n");\r\ndefault:\r\nreturn sprintf(buf, "full\n");\r\n}\r\n}\r\nstatic ssize_t adt7310_store_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nu16 config;\r\nint ret;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nconfig = chip->config & (~ADT7310_MODE_MASK);\r\nif (strcmp(buf, "power-down"))\r\nconfig |= ADT7310_PD;\r\nelse if (strcmp(buf, "one-shot"))\r\nconfig |= ADT7310_ONESHOT;\r\nelse if (strcmp(buf, "sps"))\r\nconfig |= ADT7310_SPS;\r\nret = adt7310_spi_write_byte(chip, ADT7310_CONFIG, config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config = config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7310_show_available_modes(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "full\none-shot\nsps\npower-down\n");\r\n}\r\nstatic ssize_t adt7310_show_resolution(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nint ret;\r\nint bits;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nif (chip->config & ADT7310_RESOLUTION)\r\nbits = 16;\r\nelse\r\nbits = 13;\r\nreturn sprintf(buf, "%d bits\n", bits);\r\n}\r\nstatic ssize_t adt7310_store_resolution(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nunsigned long data;\r\nu16 config;\r\nint ret;\r\nret = strict_strtoul(buf, 10, &data);\r\nif (ret)\r\nreturn -EINVAL;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nconfig = chip->config & (~ADT7310_RESOLUTION);\r\nif (data)\r\nconfig |= ADT7310_RESOLUTION;\r\nret = adt7310_spi_write_byte(chip, ADT7310_CONFIG, config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config = config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7310_show_id(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nu8 id;\r\nint ret;\r\nret = adt7310_spi_read_byte(chip, ADT7310_ID, &id);\r\nif (ret)\r\nreturn -EIO;\r\nreturn sprintf(buf, "device id: 0x%x\nmanufactory id: 0x%x\n",\r\nid & ADT7310_DEVICE_ID_MASK,\r\n(id & ADT7310_MANUFACTORY_ID_MASK) >> ADT7310_MANUFACTORY_ID_OFFSET);\r\n}\r\nstatic ssize_t adt7310_convert_temperature(struct adt7310_chip_info *chip,\r\nu16 data, char *buf)\r\n{\r\nchar sign = ' ';\r\nif (chip->config & ADT7310_RESOLUTION) {\r\nif (data & ADT7310_T16_VALUE_SIGN) {\r\ndata = (u16)((ADT7310_T16_VALUE_SIGN << 1) - (u32)data);\r\nsign = '-';\r\n}\r\nreturn sprintf(buf, "%c%d.%.7d\n", sign,\r\n(data >> ADT7310_T16_VALUE_FLOAT_OFFSET),\r\n(data & ADT7310_T16_VALUE_FLOAT_MASK) * 78125);\r\n} else {\r\nif (data & ADT7310_T13_VALUE_SIGN) {\r\ndata >>= ADT7310_T13_VALUE_OFFSET;\r\ndata = (ADT7310_T13_VALUE_SIGN << 1) - data;\r\nsign = '-';\r\n}\r\nreturn sprintf(buf, "%c%d.%.4d\n", sign,\r\n(data >> ADT7310_T13_VALUE_FLOAT_OFFSET),\r\n(data & ADT7310_T13_VALUE_FLOAT_MASK) * 625);\r\n}\r\n}\r\nstatic ssize_t adt7310_show_value(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nu8 status;\r\nu16 data;\r\nint ret, i = 0;\r\ndo {\r\nret = adt7310_spi_read_byte(chip, ADT7310_STATUS, &status);\r\nif (ret)\r\nreturn -EIO;\r\ni++;\r\nif (i == 10000)\r\nreturn -EIO;\r\n} while (status & ADT7310_STAT_NOT_RDY);\r\nret = adt7310_spi_read_word(chip, ADT7310_TEMPERATURE, &data);\r\nif (ret)\r\nreturn -EIO;\r\nreturn adt7310_convert_temperature(chip, data, buf);\r\n}\r\nstatic irqreturn_t adt7310_event_handler(int irq, void *private)\r\n{\r\nstruct iio_dev *indio_dev = private;\r\nstruct adt7310_chip_info *chip = iio_priv(indio_dev);\r\ns64 timestamp = iio_get_time_ns();\r\nu8 status;\r\nint ret;\r\nret = adt7310_spi_read_byte(chip, ADT7310_STATUS, &status);\r\nif (ret)\r\ngoto done;\r\nif (status & ADT7310_STAT_T_HIGH)\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_RISING),\r\ntimestamp);\r\nif (status & ADT7310_STAT_T_LOW)\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_FALLING),\r\ntimestamp);\r\nif (status & ADT7310_STAT_T_CRIT)\r\niio_push_event(indio_dev,\r\nIIO_UNMOD_EVENT_CODE(IIO_TEMP, 0,\r\nIIO_EV_TYPE_THRESH,\r\nIIO_EV_DIR_RISING),\r\ntimestamp);\r\ndone:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic ssize_t adt7310_show_event_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nint ret;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nif (chip->config & ADT7310_EVENT_MODE)\r\nreturn sprintf(buf, "interrupt\n");\r\nelse\r\nreturn sprintf(buf, "comparator\n");\r\n}\r\nstatic ssize_t adt7310_set_event_mode(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nu16 config;\r\nint ret;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nconfig = chip->config &= ~ADT7310_EVENT_MODE;\r\nif (strcmp(buf, "comparator") != 0)\r\nconfig |= ADT7310_EVENT_MODE;\r\nret = adt7310_spi_write_byte(chip, ADT7310_CONFIG, config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config = config;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7310_show_available_event_modes(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn sprintf(buf, "comparator\ninterrupt\n");\r\n}\r\nstatic ssize_t adt7310_show_fault_queue(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nint ret;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nreturn sprintf(buf, "%d\n", chip->config & ADT7310_FAULT_QUEUE_MASK);\r\n}\r\nstatic ssize_t adt7310_set_fault_queue(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nunsigned long data;\r\nint ret;\r\nu8 config;\r\nret = strict_strtoul(buf, 10, &data);\r\nif (ret || data > 3)\r\nreturn -EINVAL;\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret)\r\nreturn -EIO;\r\nconfig = chip->config & ~ADT7310_FAULT_QUEUE_MASK;\r\nconfig |= data;\r\nret = adt7310_spi_write_byte(chip, ADT7310_CONFIG, config);\r\nif (ret)\r\nreturn -EIO;\r\nchip->config = config;\r\nreturn len;\r\n}\r\nstatic inline ssize_t adt7310_show_t_bound(struct device *dev,\r\nstruct device_attribute *attr,\r\nu8 bound_reg,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nu16 data;\r\nint ret;\r\nret = adt7310_spi_read_word(chip, bound_reg, &data);\r\nif (ret)\r\nreturn -EIO;\r\nreturn adt7310_convert_temperature(chip, data, buf);\r\n}\r\nstatic inline ssize_t adt7310_set_t_bound(struct device *dev,\r\nstruct device_attribute *attr,\r\nu8 bound_reg,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nlong tmp1, tmp2;\r\nu16 data;\r\nchar *pos;\r\nint ret;\r\npos = strchr(buf, '.');\r\nret = strict_strtol(buf, 10, &tmp1);\r\nif (ret || tmp1 > 127 || tmp1 < -128)\r\nreturn -EINVAL;\r\nif (pos) {\r\nlen = strlen(pos);\r\nif (chip->config & ADT7310_RESOLUTION) {\r\nif (len > ADT7310_T16_VALUE_FLOAT_OFFSET)\r\nlen = ADT7310_T16_VALUE_FLOAT_OFFSET;\r\npos[len] = 0;\r\nret = strict_strtol(pos, 10, &tmp2);\r\nif (!ret)\r\ntmp2 = (tmp2 / 78125) * 78125;\r\n} else {\r\nif (len > ADT7310_T13_VALUE_FLOAT_OFFSET)\r\nlen = ADT7310_T13_VALUE_FLOAT_OFFSET;\r\npos[len] = 0;\r\nret = strict_strtol(pos, 10, &tmp2);\r\nif (!ret)\r\ntmp2 = (tmp2 / 625) * 625;\r\n}\r\n}\r\nif (tmp1 < 0)\r\ndata = (u16)(-tmp1);\r\nelse\r\ndata = (u16)tmp1;\r\nif (chip->config & ADT7310_RESOLUTION) {\r\ndata = (data << ADT7310_T16_VALUE_FLOAT_OFFSET) |\r\n(tmp2 & ADT7310_T16_VALUE_FLOAT_MASK);\r\nif (tmp1 < 0)\r\ndata = (u16)((ADT7310_T16_VALUE_SIGN << 1) - (u32)data);\r\n} else {\r\ndata = (data << ADT7310_T13_VALUE_FLOAT_OFFSET) |\r\n(tmp2 & ADT7310_T13_VALUE_FLOAT_MASK);\r\nif (tmp1 < 0)\r\ndata = (ADT7310_T13_VALUE_SIGN << 1) - data;\r\ndata <<= ADT7310_T13_VALUE_OFFSET;\r\n}\r\nret = adt7310_spi_write_word(chip, bound_reg, data);\r\nif (ret)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic ssize_t adt7310_show_t_alarm_high(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn adt7310_show_t_bound(dev, attr,\r\nADT7310_T_ALARM_HIGH, buf);\r\n}\r\nstatic inline ssize_t adt7310_set_t_alarm_high(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nreturn adt7310_set_t_bound(dev, attr,\r\nADT7310_T_ALARM_HIGH, buf, len);\r\n}\r\nstatic ssize_t adt7310_show_t_alarm_low(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn adt7310_show_t_bound(dev, attr,\r\nADT7310_T_ALARM_LOW, buf);\r\n}\r\nstatic inline ssize_t adt7310_set_t_alarm_low(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nreturn adt7310_set_t_bound(dev, attr,\r\nADT7310_T_ALARM_LOW, buf, len);\r\n}\r\nstatic ssize_t adt7310_show_t_crit(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nreturn adt7310_show_t_bound(dev, attr,\r\nADT7310_T_CRIT, buf);\r\n}\r\nstatic inline ssize_t adt7310_set_t_crit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nreturn adt7310_set_t_bound(dev, attr,\r\nADT7310_T_CRIT, buf, len);\r\n}\r\nstatic ssize_t adt7310_show_t_hyst(struct device *dev,\r\nstruct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nint ret;\r\nu8 t_hyst;\r\nret = adt7310_spi_read_byte(chip, ADT7310_T_HYST, &t_hyst);\r\nif (ret)\r\nreturn -EIO;\r\nreturn sprintf(buf, "%d\n", t_hyst & ADT7310_T_HYST_MASK);\r\n}\r\nstatic inline ssize_t adt7310_set_t_hyst(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf,\r\nsize_t len)\r\n{\r\nstruct iio_dev *dev_info = dev_to_iio_dev(dev);\r\nstruct adt7310_chip_info *chip = iio_priv(dev_info);\r\nint ret;\r\nunsigned long data;\r\nu8 t_hyst;\r\nret = strict_strtol(buf, 10, &data);\r\nif (ret || data > ADT7310_T_HYST_MASK)\r\nreturn -EINVAL;\r\nt_hyst = (u8)data;\r\nret = adt7310_spi_write_byte(chip, ADT7310_T_HYST, t_hyst);\r\nif (ret)\r\nreturn -EIO;\r\nreturn len;\r\n}\r\nstatic int __devinit adt7310_probe(struct spi_device *spi_dev)\r\n{\r\nstruct adt7310_chip_info *chip;\r\nstruct iio_dev *indio_dev;\r\nint ret = 0;\r\nunsigned long *adt7310_platform_data = spi_dev->dev.platform_data;\r\nunsigned long irq_flags;\r\nindio_dev = iio_device_alloc(sizeof(*chip));\r\nif (indio_dev == NULL) {\r\nret = -ENOMEM;\r\ngoto error_ret;\r\n}\r\nchip = iio_priv(indio_dev);\r\ndev_set_drvdata(&spi_dev->dev, indio_dev);\r\nchip->spi_dev = spi_dev;\r\nindio_dev->dev.parent = &spi_dev->dev;\r\nindio_dev->name = spi_get_device_id(spi_dev)->name;\r\nindio_dev->info = &adt7310_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nif (spi_dev->irq) {\r\nif (adt7310_platform_data[2])\r\nirq_flags = adt7310_platform_data[2];\r\nelse\r\nirq_flags = IRQF_TRIGGER_LOW;\r\nret = request_threaded_irq(spi_dev->irq,\r\nNULL,\r\n&adt7310_event_handler,\r\nirq_flags | IRQF_ONESHOT,\r\nindio_dev->name,\r\nindio_dev);\r\nif (ret)\r\ngoto error_free_dev;\r\n}\r\nif (adt7310_platform_data[0]) {\r\nret = request_threaded_irq(adt7310_platform_data[0],\r\nNULL,\r\n&adt7310_event_handler,\r\nadt7310_platform_data[1] |\r\nIRQF_ONESHOT,\r\nindio_dev->name,\r\nindio_dev);\r\nif (ret)\r\ngoto error_unreg_ct_irq;\r\n}\r\nif (spi_dev->irq && adt7310_platform_data[0]) {\r\nret = adt7310_spi_read_byte(chip, ADT7310_CONFIG, &chip->config);\r\nif (ret) {\r\nret = -EIO;\r\ngoto error_unreg_int_irq;\r\n}\r\nchip->config &= ~ADT7310_CT_POLARITY;\r\nif (adt7310_platform_data[1] & IRQF_TRIGGER_HIGH)\r\nchip->config |= ADT7310_INT_POLARITY;\r\nelse\r\nchip->config &= ~ADT7310_INT_POLARITY;\r\nret = adt7310_spi_write_byte(chip, ADT7310_CONFIG, chip->config);\r\nif (ret) {\r\nret = -EIO;\r\ngoto error_unreg_int_irq;\r\n}\r\n}\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_unreg_int_irq;\r\ndev_info(&spi_dev->dev, "%s temperature sensor registered.\n",\r\nindio_dev->name);\r\nreturn 0;\r\nerror_unreg_int_irq:\r\nfree_irq(adt7310_platform_data[0], indio_dev);\r\nerror_unreg_ct_irq:\r\nfree_irq(spi_dev->irq, indio_dev);\r\nerror_free_dev:\r\niio_device_free(indio_dev);\r\nerror_ret:\r\nreturn ret;\r\n}\r\nstatic int __devexit adt7310_remove(struct spi_device *spi_dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(&spi_dev->dev);\r\nunsigned long *adt7310_platform_data = spi_dev->dev.platform_data;\r\niio_device_unregister(indio_dev);\r\ndev_set_drvdata(&spi_dev->dev, NULL);\r\nif (adt7310_platform_data[0])\r\nfree_irq(adt7310_platform_data[0], indio_dev);\r\nif (spi_dev->irq)\r\nfree_irq(spi_dev->irq, indio_dev);\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}

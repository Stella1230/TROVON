static int\r\ntsi500_route_add_entry(struct rio_mport *mport, u16 destid, u8 hopcount, u16 table, u16 route_destid, u8 route_port)\r\n{\r\nint i;\r\nu32 offset = 0x10000 + 0xa00 + ((route_destid / 2)&~0x3);\r\nu32 result;\r\nif (table == 0xff) {\r\nrio_mport_read_config_32(mport, destid, hopcount, offset, &result);\r\nresult &= ~(0xf << (4*(route_destid & 0x7)));\r\nfor (i=0;i<4;i++)\r\nrio_mport_write_config_32(mport, destid, hopcount, offset + (0x20000*i), result | (route_port << (4*(route_destid & 0x7))));\r\n}\r\nelse {\r\nrio_mport_read_config_32(mport, destid, hopcount, offset + (0x20000*table), &result);\r\nresult &= ~(0xf << (4*(route_destid & 0x7)));\r\nrio_mport_write_config_32(mport, destid, hopcount, offset + (0x20000*table), result | (route_port << (4*(route_destid & 0x7))));\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\ntsi500_route_get_entry(struct rio_mport *mport, u16 destid, u8 hopcount, u16 table, u16 route_destid, u8 *route_port)\r\n{\r\nint ret = 0;\r\nu32 offset = 0x10000 + 0xa00 + ((route_destid / 2)&~0x3);\r\nu32 result;\r\nif (table == 0xff)\r\nrio_mport_read_config_32(mport, destid, hopcount, offset, &result);\r\nelse\r\nrio_mport_read_config_32(mport, destid, hopcount, offset + (0x20000*table), &result);\r\nresult &= 0xf << (4*(route_destid & 0x7));\r\n*route_port = result >> (4*(route_destid & 0x7));\r\nif (*route_port > 3)\r\nret = -1;\r\nreturn ret;\r\n}\r\nstatic int tsi500_switch_init(struct rio_dev *rdev, int do_enum)\r\n{\r\npr_debug("RIO: %s for %s\n", __func__, rio_name(rdev));\r\nrdev->rswitch->add_entry = tsi500_route_add_entry;\r\nrdev->rswitch->get_entry = tsi500_route_get_entry;\r\nrdev->rswitch->clr_table = NULL;\r\nrdev->rswitch->set_domain = NULL;\r\nrdev->rswitch->get_domain = NULL;\r\nrdev->rswitch->em_init = NULL;\r\nrdev->rswitch->em_handle = NULL;\r\nreturn 0;\r\n}

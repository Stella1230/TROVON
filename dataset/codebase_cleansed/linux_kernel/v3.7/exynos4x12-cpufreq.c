static void exynos4x12_set_clkdiv(unsigned int div_index)\r\n{\r\nunsigned int tmp;\r\nunsigned int stat_cpu1;\r\ntmp = exynos4x12_clkdiv_table[div_index].clkdiv;\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_CPU);\r\nwhile (__raw_readl(EXYNOS4_CLKDIV_STATCPU) & 0x11111111)\r\ncpu_relax();\r\ntmp = exynos4x12_clkdiv_table[div_index].clkdiv1;\r\n__raw_writel(tmp, EXYNOS4_CLKDIV_CPU1);\r\nif (soc_is_exynos4212())\r\nstat_cpu1 = 0x11;\r\nelse\r\nstat_cpu1 = 0x111;\r\nwhile (__raw_readl(EXYNOS4_CLKDIV_STATCPU1) & stat_cpu1)\r\ncpu_relax();\r\n}\r\nstatic void exynos4x12_set_apll(unsigned int index)\r\n{\r\nunsigned int tmp, pdiv;\r\nclk_set_parent(moutcore, mout_mpll);\r\ndo {\r\ncpu_relax();\r\ntmp = (__raw_readl(EXYNOS4_CLKMUX_STATCPU)\r\n>> EXYNOS4_CLKSRC_CPU_MUXCORE_SHIFT);\r\ntmp &= 0x7;\r\n} while (tmp != 0x2);\r\npdiv = ((exynos4x12_apll_pms_table[index] >> 8) & 0x3f);\r\n__raw_writel((pdiv * 250), EXYNOS4_APLL_LOCK);\r\ntmp = __raw_readl(EXYNOS4_APLL_CON0);\r\ntmp &= ~((0x3ff << 16) | (0x3f << 8) | (0x7 << 0));\r\ntmp |= exynos4x12_apll_pms_table[index];\r\n__raw_writel(tmp, EXYNOS4_APLL_CON0);\r\ndo {\r\ncpu_relax();\r\ntmp = __raw_readl(EXYNOS4_APLL_CON0);\r\n} while (!(tmp & (0x1 << EXYNOS4_APLLCON0_LOCKED_SHIFT)));\r\nclk_set_parent(moutcore, mout_apll);\r\ndo {\r\ncpu_relax();\r\ntmp = __raw_readl(EXYNOS4_CLKMUX_STATCPU);\r\ntmp &= EXYNOS4_CLKMUX_STATCPU_MUXCORE_MASK;\r\n} while (tmp != (0x1 << EXYNOS4_CLKSRC_CPU_MUXCORE_SHIFT));\r\n}\r\nbool exynos4x12_pms_change(unsigned int old_index, unsigned int new_index)\r\n{\r\nunsigned int old_pm = exynos4x12_apll_pms_table[old_index] >> 8;\r\nunsigned int new_pm = exynos4x12_apll_pms_table[new_index] >> 8;\r\nreturn (old_pm == new_pm) ? 0 : 1;\r\n}\r\nstatic void exynos4x12_set_frequency(unsigned int old_index,\r\nunsigned int new_index)\r\n{\r\nunsigned int tmp;\r\nif (old_index > new_index) {\r\nif (!exynos4x12_pms_change(old_index, new_index)) {\r\nexynos4x12_set_clkdiv(new_index);\r\ntmp = __raw_readl(EXYNOS4_APLL_CON0);\r\ntmp &= ~(0x7 << 0);\r\ntmp |= (exynos4x12_apll_pms_table[new_index] & 0x7);\r\n__raw_writel(tmp, EXYNOS4_APLL_CON0);\r\n} else {\r\nexynos4x12_set_clkdiv(new_index);\r\nexynos4x12_set_apll(new_index);\r\n}\r\n} else if (old_index < new_index) {\r\nif (!exynos4x12_pms_change(old_index, new_index)) {\r\ntmp = __raw_readl(EXYNOS4_APLL_CON0);\r\ntmp &= ~(0x7 << 0);\r\ntmp |= (exynos4x12_apll_pms_table[new_index] & 0x7);\r\n__raw_writel(tmp, EXYNOS4_APLL_CON0);\r\nexynos4x12_set_clkdiv(new_index);\r\n} else {\r\nexynos4x12_set_apll(new_index);\r\nexynos4x12_set_clkdiv(new_index);\r\n}\r\n}\r\n}\r\nstatic void __init set_volt_table(void)\r\n{\r\nunsigned int i;\r\nmax_support_idx = L1;\r\nexynos4x12_freq_table[L0].frequency = CPUFREQ_ENTRY_INVALID;\r\nfor (i = 0 ; i < CPUFREQ_LEVEL_END ; i++)\r\nexynos4x12_volt_table[i] = asv_voltage_4x12[i];\r\n}\r\nint exynos4x12_cpufreq_init(struct exynos_dvfs_info *info)\r\n{\r\nint i;\r\nunsigned int tmp;\r\nunsigned long rate;\r\nset_volt_table();\r\ncpu_clk = clk_get(NULL, "armclk");\r\nif (IS_ERR(cpu_clk))\r\nreturn PTR_ERR(cpu_clk);\r\nmoutcore = clk_get(NULL, "moutcore");\r\nif (IS_ERR(moutcore))\r\ngoto err_moutcore;\r\nmout_mpll = clk_get(NULL, "mout_mpll");\r\nif (IS_ERR(mout_mpll))\r\ngoto err_mout_mpll;\r\nrate = clk_get_rate(mout_mpll) / 1000;\r\nmout_apll = clk_get(NULL, "mout_apll");\r\nif (IS_ERR(mout_apll))\r\ngoto err_mout_apll;\r\nfor (i = L0; i < CPUFREQ_LEVEL_END; i++) {\r\nexynos4x12_clkdiv_table[i].index = i;\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_CPU);\r\ntmp &= ~(EXYNOS4_CLKDIV_CPU0_CORE_MASK |\r\nEXYNOS4_CLKDIV_CPU0_COREM0_MASK |\r\nEXYNOS4_CLKDIV_CPU0_COREM1_MASK |\r\nEXYNOS4_CLKDIV_CPU0_PERIPH_MASK |\r\nEXYNOS4_CLKDIV_CPU0_ATB_MASK |\r\nEXYNOS4_CLKDIV_CPU0_PCLKDBG_MASK |\r\nEXYNOS4_CLKDIV_CPU0_APLL_MASK);\r\nif (soc_is_exynos4212()) {\r\ntmp |= ((clkdiv_cpu0_4212[i][0] << EXYNOS4_CLKDIV_CPU0_CORE_SHIFT) |\r\n(clkdiv_cpu0_4212[i][1] << EXYNOS4_CLKDIV_CPU0_COREM0_SHIFT) |\r\n(clkdiv_cpu0_4212[i][2] << EXYNOS4_CLKDIV_CPU0_COREM1_SHIFT) |\r\n(clkdiv_cpu0_4212[i][3] << EXYNOS4_CLKDIV_CPU0_PERIPH_SHIFT) |\r\n(clkdiv_cpu0_4212[i][4] << EXYNOS4_CLKDIV_CPU0_ATB_SHIFT) |\r\n(clkdiv_cpu0_4212[i][5] << EXYNOS4_CLKDIV_CPU0_PCLKDBG_SHIFT) |\r\n(clkdiv_cpu0_4212[i][6] << EXYNOS4_CLKDIV_CPU0_APLL_SHIFT));\r\n} else {\r\ntmp &= ~EXYNOS4_CLKDIV_CPU0_CORE2_MASK;\r\ntmp |= ((clkdiv_cpu0_4412[i][0] << EXYNOS4_CLKDIV_CPU0_CORE_SHIFT) |\r\n(clkdiv_cpu0_4412[i][1] << EXYNOS4_CLKDIV_CPU0_COREM0_SHIFT) |\r\n(clkdiv_cpu0_4412[i][2] << EXYNOS4_CLKDIV_CPU0_COREM1_SHIFT) |\r\n(clkdiv_cpu0_4412[i][3] << EXYNOS4_CLKDIV_CPU0_PERIPH_SHIFT) |\r\n(clkdiv_cpu0_4412[i][4] << EXYNOS4_CLKDIV_CPU0_ATB_SHIFT) |\r\n(clkdiv_cpu0_4412[i][5] << EXYNOS4_CLKDIV_CPU0_PCLKDBG_SHIFT) |\r\n(clkdiv_cpu0_4412[i][6] << EXYNOS4_CLKDIV_CPU0_APLL_SHIFT) |\r\n(clkdiv_cpu0_4412[i][7] << EXYNOS4_CLKDIV_CPU0_CORE2_SHIFT));\r\n}\r\nexynos4x12_clkdiv_table[i].clkdiv = tmp;\r\ntmp = __raw_readl(EXYNOS4_CLKDIV_CPU1);\r\nif (soc_is_exynos4212()) {\r\ntmp &= ~(EXYNOS4_CLKDIV_CPU1_COPY_MASK |\r\nEXYNOS4_CLKDIV_CPU1_HPM_MASK);\r\ntmp |= ((clkdiv_cpu1_4212[i][0] << EXYNOS4_CLKDIV_CPU1_COPY_SHIFT) |\r\n(clkdiv_cpu1_4212[i][1] << EXYNOS4_CLKDIV_CPU1_HPM_SHIFT));\r\n} else {\r\ntmp &= ~(EXYNOS4_CLKDIV_CPU1_COPY_MASK |\r\nEXYNOS4_CLKDIV_CPU1_HPM_MASK |\r\nEXYNOS4_CLKDIV_CPU1_CORES_MASK);\r\ntmp |= ((clkdiv_cpu1_4412[i][0] << EXYNOS4_CLKDIV_CPU1_COPY_SHIFT) |\r\n(clkdiv_cpu1_4412[i][1] << EXYNOS4_CLKDIV_CPU1_HPM_SHIFT) |\r\n(clkdiv_cpu1_4412[i][2] << EXYNOS4_CLKDIV_CPU1_CORES_SHIFT));\r\n}\r\nexynos4x12_clkdiv_table[i].clkdiv1 = tmp;\r\n}\r\ninfo->mpll_freq_khz = rate;\r\ninfo->pm_lock_idx = L5;\r\ninfo->pll_safe_idx = L7;\r\ninfo->max_support_idx = max_support_idx;\r\ninfo->min_support_idx = min_support_idx;\r\ninfo->cpu_clk = cpu_clk;\r\ninfo->volt_table = exynos4x12_volt_table;\r\ninfo->freq_table = exynos4x12_freq_table;\r\ninfo->set_freq = exynos4x12_set_frequency;\r\ninfo->need_apll_change = exynos4x12_pms_change;\r\nreturn 0;\r\nerr_mout_apll:\r\nclk_put(mout_mpll);\r\nerr_mout_mpll:\r\nclk_put(moutcore);\r\nerr_moutcore:\r\nclk_put(cpu_clk);\r\npr_debug("%s: failed initialization\n", __func__);\r\nreturn -EINVAL;\r\n}

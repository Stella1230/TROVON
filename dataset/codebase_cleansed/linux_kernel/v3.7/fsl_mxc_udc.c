int fsl_udc_clk_init(struct platform_device *pdev)\r\n{\r\nstruct fsl_usb2_platform_data *pdata;\r\nunsigned long freq;\r\nint ret;\r\npdata = pdev->dev.platform_data;\r\nmxc_ipg_clk = devm_clk_get(&pdev->dev, "ipg");\r\nif (IS_ERR(mxc_ipg_clk)) {\r\ndev_err(&pdev->dev, "clk_get(\"ipg\") failed\n");\r\nreturn PTR_ERR(mxc_ipg_clk);\r\n}\r\nmxc_ahb_clk = devm_clk_get(&pdev->dev, "ahb");\r\nif (IS_ERR(mxc_ahb_clk)) {\r\ndev_err(&pdev->dev, "clk_get(\"ahb\") failed\n");\r\nreturn PTR_ERR(mxc_ahb_clk);\r\n}\r\nmxc_per_clk = devm_clk_get(&pdev->dev, "per");\r\nif (IS_ERR(mxc_per_clk)) {\r\ndev_err(&pdev->dev, "clk_get(\"per\") failed\n");\r\nreturn PTR_ERR(mxc_per_clk);\r\n}\r\nclk_prepare_enable(mxc_ipg_clk);\r\nclk_prepare_enable(mxc_ahb_clk);\r\nclk_prepare_enable(mxc_per_clk);\r\nif (!cpu_is_mx51()) {\r\nfreq = clk_get_rate(mxc_per_clk);\r\nif (pdata->phy_mode != FSL_USB2_PHY_ULPI &&\r\n(freq < 59999000 || freq > 60001000)) {\r\ndev_err(&pdev->dev, "USB_CLK=%lu, should be 60MHz\n", freq);\r\nret = -EINVAL;\r\ngoto eclkrate;\r\n}\r\n}\r\nreturn 0;\r\neclkrate:\r\nclk_disable_unprepare(mxc_ipg_clk);\r\nclk_disable_unprepare(mxc_ahb_clk);\r\nclk_disable_unprepare(mxc_per_clk);\r\nmxc_per_clk = NULL;\r\nreturn ret;\r\n}\r\nvoid fsl_udc_clk_finalize(struct platform_device *pdev)\r\n{\r\nstruct fsl_usb2_platform_data *pdata = pdev->dev.platform_data;\r\nif (cpu_is_mx35()) {\r\nunsigned int v;\r\nif (pdata->workaround & FLS_USB2_WORKAROUND_ENGCM09152) {\r\nv = readl(MX35_IO_ADDRESS(MX35_USB_BASE_ADDR +\r\nUSBPHYCTRL_OTGBASE_OFFSET));\r\nwritel(v | USBPHYCTRL_EVDO,\r\nMX35_IO_ADDRESS(MX35_USB_BASE_ADDR +\r\nUSBPHYCTRL_OTGBASE_OFFSET));\r\n}\r\n}\r\nif (pdata->phy_mode == FSL_USB2_PHY_ULPI) {\r\nclk_disable_unprepare(mxc_per_clk);\r\nmxc_per_clk = NULL;\r\n}\r\n}\r\nvoid fsl_udc_clk_release(void)\r\n{\r\nif (mxc_per_clk)\r\nclk_disable_unprepare(mxc_per_clk);\r\nclk_disable_unprepare(mxc_ahb_clk);\r\nclk_disable_unprepare(mxc_ipg_clk);\r\n}

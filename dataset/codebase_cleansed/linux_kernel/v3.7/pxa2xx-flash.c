static void pxa2xx_map_inval_cache(struct map_info *map, unsigned long from,\r\nssize_t len)\r\n{\r\nunsigned long start = (unsigned long)map->cached + from;\r\nunsigned long end = start + len;\r\nstart &= ~(CACHELINESIZE - 1);\r\nwhile (start < end) {\r\nasm volatile ("mcr p15, 0, %0, c7, c6, 1" : : "r" (start));\r\nstart += CACHELINESIZE;\r\n}\r\n}\r\nstatic int __devinit pxa2xx_flash_probe(struct platform_device *pdev)\r\n{\r\nstruct flash_platform_data *flash = pdev->dev.platform_data;\r\nstruct pxa2xx_flash_info *info;\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\ninfo = kzalloc(sizeof(struct pxa2xx_flash_info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\ninfo->map.name = (char *) flash->name;\r\ninfo->map.bankwidth = flash->width;\r\ninfo->map.phys = res->start;\r\ninfo->map.size = resource_size(res);\r\ninfo->map.virt = ioremap(info->map.phys, info->map.size);\r\nif (!info->map.virt) {\r\nprintk(KERN_WARNING "Failed to ioremap %s\n",\r\ninfo->map.name);\r\nreturn -ENOMEM;\r\n}\r\ninfo->map.cached =\r\nioremap_cached(info->map.phys, info->map.size);\r\nif (!info->map.cached)\r\nprintk(KERN_WARNING "Failed to ioremap cached %s\n",\r\ninfo->map.name);\r\ninfo->map.inval_cache = pxa2xx_map_inval_cache;\r\nsimple_map_init(&info->map);\r\nprintk(KERN_NOTICE\r\n"Probing %s at physical address 0x%08lx"\r\n" (%d-bit bankwidth)\n",\r\ninfo->map.name, (unsigned long)info->map.phys,\r\ninfo->map.bankwidth * 8);\r\ninfo->mtd = do_map_probe(flash->map_name, &info->map);\r\nif (!info->mtd) {\r\niounmap((void *)info->map.virt);\r\nif (info->map.cached)\r\niounmap(info->map.cached);\r\nreturn -EIO;\r\n}\r\ninfo->mtd->owner = THIS_MODULE;\r\nmtd_device_parse_register(info->mtd, probes, NULL, flash->parts,\r\nflash->nr_parts);\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\n}\r\nstatic int __devexit pxa2xx_flash_remove(struct platform_device *dev)\r\n{\r\nstruct pxa2xx_flash_info *info = platform_get_drvdata(dev);\r\nplatform_set_drvdata(dev, NULL);\r\nmtd_device_unregister(info->mtd);\r\nmap_destroy(info->mtd);\r\niounmap(info->map.virt);\r\nif (info->map.cached)\r\niounmap(info->map.cached);\r\nkfree(info);\r\nreturn 0;\r\n}\r\nstatic void pxa2xx_flash_shutdown(struct platform_device *dev)\r\n{\r\nstruct pxa2xx_flash_info *info = platform_get_drvdata(dev);\r\nif (info && mtd_suspend(info->mtd) == 0)\r\nmtd_resume(info->mtd);\r\n}

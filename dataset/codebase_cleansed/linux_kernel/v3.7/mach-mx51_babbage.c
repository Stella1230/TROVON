static int gpio_usbh1_active(void)\r\n{\r\niomux_v3_cfg_t usbh1stp_gpio = MX51_PAD_USBH1_STP__GPIO1_27;\r\nint ret;\r\nmxc_iomux_v3_setup_pad(usbh1stp_gpio);\r\nret = gpio_request_array(mx51_babbage_usbh1_gpios,\r\nARRAY_SIZE(mx51_babbage_usbh1_gpios));\r\nif (ret) {\r\npr_debug("failed to get USBH1 pins: %d\n", ret);\r\nreturn ret;\r\n}\r\nmsleep(100);\r\ngpio_set_value(BABBAGE_USBH1_STP, 1);\r\ngpio_set_value(BABBAGE_USB_PHY_RESET, 1);\r\ngpio_free_array(mx51_babbage_usbh1_gpios,\r\nARRAY_SIZE(mx51_babbage_usbh1_gpios));\r\nreturn 0;\r\n}\r\nstatic inline void babbage_usbhub_reset(void)\r\n{\r\nint ret;\r\nret = gpio_request_one(BABBAGE_USB_HUB_RESET,\r\nGPIOF_OUT_INIT_LOW, "GPIO1_7");\r\nif (ret) {\r\nprintk(KERN_ERR"failed to get GPIO_USB_HUB_RESET: %d\n", ret);\r\nreturn;\r\n}\r\nmsleep(2);\r\ngpio_set_value(BABBAGE_USB_HUB_RESET, 1);\r\n}\r\nstatic inline void babbage_fec_reset(void)\r\n{\r\nint ret;\r\nret = gpio_request_one(BABBAGE_FEC_PHY_RESET,\r\nGPIOF_OUT_INIT_LOW, "fec-phy-reset");\r\nif (ret) {\r\nprintk(KERN_ERR"failed to get GPIO_FEC_PHY_RESET: %d\n", ret);\r\nreturn;\r\n}\r\nmsleep(1);\r\ngpio_set_value(BABBAGE_FEC_PHY_RESET, 1);\r\n}\r\nstatic int initialize_otg_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = usb_base + MX5_USBOTHER_REGS_OFFSET;\r\nv = __raw_readl(usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\nv &= ~MX5_USB_UTMI_PHYCTRL1_PLLDIV_MASK;\r\nv |= MX51_USB_PLL_DIV_19_2_MHZ;\r\n__raw_writel(v, usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(0, MXC_EHCI_INTERNAL_PHY);\r\n}\r\nstatic int initialize_usbh1_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = usb_base + MX5_USBOTHER_REGS_OFFSET;\r\nv = __raw_readl(usbother_base + MX51_USB_CTRL_1_OFFSET);\r\n__raw_writel(v | MX51_USB_CTRL_UH1_EXT_CLK_EN, usbother_base + MX51_USB_CTRL_1_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(1, MXC_EHCI_POWER_PINS_ENABLED |\r\nMXC_EHCI_ITC_NO_THRESHOLD);\r\n}\r\nstatic int __init babbage_otg_mode(char *options)\r\n{\r\nif (!strcmp(options, "host"))\r\notg_mode_host = true;\r\nelse if (!strcmp(options, "device"))\r\notg_mode_host = false;\r\nelse\r\npr_info("otg_mode neither \"host\" nor \"device\". "\r\n"Defaulting to device\n");\r\nreturn 1;\r\n}\r\nvoid __init imx51_babbage_common_init(void)\r\n{\r\nmxc_iomux_v3_setup_multiple_pads(mx51babbage_pads,\r\nARRAY_SIZE(mx51babbage_pads));\r\n}\r\nstatic void __init mx51_babbage_init(void)\r\n{\r\niomux_v3_cfg_t usbh1stp = MX51_PAD_USBH1_STP__USBH1_STP;\r\niomux_v3_cfg_t power_key = NEW_PAD_CTRL(MX51_PAD_EIM_A27__GPIO2_21,\r\nPAD_CTL_SRE_FAST | PAD_CTL_DSE_HIGH);\r\nimx51_soc_init();\r\n#if defined(CONFIG_CPU_FREQ_IMX)\r\nget_cpu_op = mx51_get_cpu_op;\r\n#endif\r\nimx51_babbage_common_init();\r\nimx51_add_imx_uart(0, &uart_pdata);\r\nimx51_add_imx_uart(1, NULL);\r\nimx51_add_imx_uart(2, &uart_pdata);\r\nbabbage_fec_reset();\r\nimx51_add_fec(NULL);\r\nmxc_iomux_v3_setup_pad(power_key);\r\nimx_add_gpio_keys(&imx_button_data);\r\nimx51_add_imx_i2c(0, &babbage_i2c_data);\r\nimx51_add_imx_i2c(1, &babbage_i2c_data);\r\nimx51_add_hsi2c(&babbage_hsi2c_data);\r\nif (otg_mode_host)\r\nimx51_add_mxc_ehci_otg(&dr_utmi_config);\r\nelse {\r\ninitialize_otg_port(NULL);\r\nimx51_add_fsl_usb2_udc(&usb_pdata);\r\n}\r\ngpio_usbh1_active();\r\nimx51_add_mxc_ehci_hs(1, &usbh1_config);\r\nmxc_iomux_v3_setup_pad(usbh1stp);\r\nbabbage_usbhub_reset();\r\nimx51_add_sdhci_esdhc_imx(0, &mx51_babbage_sd1_data);\r\nimx51_add_sdhci_esdhc_imx(1, &mx51_babbage_sd2_data);\r\nspi_register_board_info(mx51_babbage_spi_board_info,\r\nARRAY_SIZE(mx51_babbage_spi_board_info));\r\nimx51_add_ecspi(0, &mx51_babbage_spi_pdata);\r\nimx51_add_imx2_wdt(0);\r\n}\r\nstatic void __init mx51_babbage_timer_init(void)\r\n{\r\nmx51_clocks_init(32768, 24000000, 22579200, 0);\r\n}

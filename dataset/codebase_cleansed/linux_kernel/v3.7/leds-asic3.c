static void brightness_set(struct led_classdev *cdev,\r\nenum led_brightness value)\r\n{\r\nstruct platform_device *pdev = to_platform_device(cdev->dev->parent);\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nstruct asic3 *asic = dev_get_drvdata(pdev->dev.parent);\r\nu32 timebase;\r\nunsigned int base;\r\ntimebase = (value == LED_OFF) ? 0 : (LED_EN|0x4);\r\nbase = led_n_base[cell->id];\r\nasic3_write_register(asic, (base + ASIC3_LED_PeriodTime), 32);\r\nasic3_write_register(asic, (base + ASIC3_LED_DutyTime), 32);\r\nasic3_write_register(asic, (base + ASIC3_LED_AutoStopCount), 0);\r\nasic3_write_register(asic, (base + ASIC3_LED_TimeBase), timebase);\r\n}\r\nstatic int blink_set(struct led_classdev *cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nstruct platform_device *pdev = to_platform_device(cdev->dev->parent);\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nstruct asic3 *asic = dev_get_drvdata(pdev->dev.parent);\r\nu32 on;\r\nu32 off;\r\nunsigned int base;\r\nif (*delay_on > MAX_MS || *delay_off > MAX_MS)\r\nreturn -EINVAL;\r\nif (*delay_on == 0 && *delay_off == 0) {\r\non = MS_TO_CLK(500);\r\noff = MS_TO_CLK(500);\r\n} else {\r\non = MS_TO_CLK(*delay_on);\r\noff = MS_TO_CLK(*delay_off);\r\nif ((on + off) > MAX_CLK)\r\nreturn -EINVAL;\r\n}\r\nbase = led_n_base[cell->id];\r\nasic3_write_register(asic, (base + ASIC3_LED_PeriodTime), (on + off));\r\nasic3_write_register(asic, (base + ASIC3_LED_DutyTime), on);\r\nasic3_write_register(asic, (base + ASIC3_LED_AutoStopCount), 0);\r\nasic3_write_register(asic, (base + ASIC3_LED_TimeBase), (LED_EN|0x4));\r\n*delay_on = CLK_TO_MS(on);\r\n*delay_off = CLK_TO_MS(off);\r\nreturn 0;\r\n}\r\nstatic int __devinit asic3_led_probe(struct platform_device *pdev)\r\n{\r\nstruct asic3_led *led = pdev->dev.platform_data;\r\nint ret;\r\nret = mfd_cell_enable(pdev);\r\nif (ret < 0)\r\nreturn ret;\r\nled->cdev = devm_kzalloc(&pdev->dev, sizeof(struct led_classdev),\r\nGFP_KERNEL);\r\nif (!led->cdev) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nled->cdev->name = led->name;\r\nled->cdev->flags = LED_CORE_SUSPENDRESUME;\r\nled->cdev->brightness_set = brightness_set;\r\nled->cdev->blink_set = blink_set;\r\nled->cdev->default_trigger = led->default_trigger;\r\nret = led_classdev_register(&pdev->dev, led->cdev);\r\nif (ret < 0)\r\ngoto out;\r\nreturn 0;\r\nout:\r\n(void) mfd_cell_disable(pdev);\r\nreturn ret;\r\n}\r\nstatic int __devexit asic3_led_remove(struct platform_device *pdev)\r\n{\r\nstruct asic3_led *led = pdev->dev.platform_data;\r\nled_classdev_unregister(led->cdev);\r\nreturn mfd_cell_disable(pdev);\r\n}\r\nstatic int asic3_led_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nint ret;\r\nret = 0;\r\nif (cell->suspend)\r\nret = (*cell->suspend)(pdev);\r\nreturn ret;\r\n}\r\nstatic int asic3_led_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nint ret;\r\nret = 0;\r\nif (cell->resume)\r\nret = (*cell->resume)(pdev);\r\nreturn ret;\r\n}

void atari_microwire_cmd (int cmd)\r\n{\r\ntt_microwire.mask = 0x7ff;\r\ntt_microwire.data = MW_LM1992_ADDR | cmd;\r\nwhile( tt_microwire.mask != 0x7ff)\r\n;\r\n}\r\nvoid atari_mksound (unsigned int hz, unsigned int ticks)\r\n{\r\nunsigned long flags;\r\nunsigned char tmp;\r\nint period;\r\nlocal_irq_save(flags);\r\nsound_ym.rd_data_reg_sel = 7;\r\ntmp = sound_ym.rd_data_reg_sel;\r\ntmp |= 011;\r\nsound_ym.wd_data = tmp;\r\nif (hz) {\r\nperiod = PSG_FREQ / hz;\r\nif (period > 0xfff) period = 0xfff;\r\nsound_ym.rd_data_reg_sel = 0;\r\nsound_ym.wd_data = period & 0xff;\r\nsound_ym.rd_data_reg_sel = 1;\r\nsound_ym.wd_data = (period >> 8) & 0xf;\r\nif (ticks) {\r\nint length = (ticks * PSG_ENV_FREQ_10) / HZ / 10;\r\nif (length > 0xffff) length = 0xffff;\r\nsound_ym.rd_data_reg_sel = 11;\r\nsound_ym.wd_data = length & 0xff;\r\nsound_ym.rd_data_reg_sel = 12;\r\nsound_ym.wd_data = length >> 8;\r\nsound_ym.rd_data_reg_sel = 13;\r\nsound_ym.wd_data = 0;\r\nsound_ym.rd_data_reg_sel = 8;\r\nsound_ym.wd_data = 0x10;\r\n} else {\r\nsound_ym.rd_data_reg_sel = 8;\r\nsound_ym.wd_data = 15;\r\n}\r\nsound_ym.rd_data_reg_sel = 7;\r\ntmp &= ~1;\r\nsound_ym.wd_data = tmp;\r\n}\r\nlocal_irq_restore(flags);\r\n}

static void profile_activated(struct pyra_device *pyra,\r\nunsigned int new_profile)\r\n{\r\npyra->actual_profile = new_profile;\r\npyra->actual_cpi = pyra->profile_settings[pyra->actual_profile].y_cpi;\r\n}\r\nstatic int pyra_send_control(struct usb_device *usb_dev, int value,\r\nenum pyra_control_requests request)\r\n{\r\nstruct roccat_common2_control control;\r\nif ((request == PYRA_CONTROL_REQUEST_PROFILE_SETTINGS ||\r\nrequest == PYRA_CONTROL_REQUEST_PROFILE_BUTTONS) &&\r\n(value < 0 || value > 4))\r\nreturn -EINVAL;\r\ncontrol.command = ROCCAT_COMMON_COMMAND_CONTROL;\r\ncontrol.value = value;\r\ncontrol.request = request;\r\nreturn roccat_common2_send(usb_dev, ROCCAT_COMMON_COMMAND_CONTROL,\r\n&control, sizeof(struct roccat_common2_control));\r\n}\r\nstatic int pyra_get_profile_settings(struct usb_device *usb_dev,\r\nstruct pyra_profile_settings *buf, int number)\r\n{\r\nint retval;\r\nretval = pyra_send_control(usb_dev, number,\r\nPYRA_CONTROL_REQUEST_PROFILE_SETTINGS);\r\nif (retval)\r\nreturn retval;\r\nreturn roccat_common2_receive(usb_dev, PYRA_COMMAND_PROFILE_SETTINGS,\r\nbuf, sizeof(struct pyra_profile_settings));\r\n}\r\nstatic int pyra_get_profile_buttons(struct usb_device *usb_dev,\r\nstruct pyra_profile_buttons *buf, int number)\r\n{\r\nint retval;\r\nretval = pyra_send_control(usb_dev, number,\r\nPYRA_CONTROL_REQUEST_PROFILE_BUTTONS);\r\nif (retval)\r\nreturn retval;\r\nreturn roccat_common2_receive(usb_dev, PYRA_COMMAND_PROFILE_BUTTONS,\r\nbuf, sizeof(struct pyra_profile_buttons));\r\n}\r\nstatic int pyra_get_settings(struct usb_device *usb_dev,\r\nstruct pyra_settings *buf)\r\n{\r\nreturn roccat_common2_receive(usb_dev, PYRA_COMMAND_SETTINGS,\r\nbuf, sizeof(struct pyra_settings));\r\n}\r\nstatic int pyra_get_info(struct usb_device *usb_dev, struct pyra_info *buf)\r\n{\r\nreturn roccat_common2_receive(usb_dev, PYRA_COMMAND_INFO,\r\nbuf, sizeof(struct pyra_info));\r\n}\r\nstatic int pyra_set_profile_settings(struct usb_device *usb_dev,\r\nstruct pyra_profile_settings const *settings)\r\n{\r\nreturn roccat_common2_send_with_status(usb_dev,\r\nPYRA_COMMAND_PROFILE_SETTINGS, settings,\r\nsizeof(struct pyra_profile_settings));\r\n}\r\nstatic int pyra_set_profile_buttons(struct usb_device *usb_dev,\r\nstruct pyra_profile_buttons const *buttons)\r\n{\r\nreturn roccat_common2_send_with_status(usb_dev,\r\nPYRA_COMMAND_PROFILE_BUTTONS, buttons,\r\nsizeof(struct pyra_profile_buttons));\r\n}\r\nstatic int pyra_set_settings(struct usb_device *usb_dev,\r\nstruct pyra_settings const *settings)\r\n{\r\nreturn roccat_common2_send_with_status(usb_dev,\r\nPYRA_COMMAND_SETTINGS, settings,\r\nsizeof(struct pyra_settings));\r\n}\r\nstatic ssize_t pyra_sysfs_read_profilex_settings(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct pyra_device *pyra = hid_get_drvdata(dev_get_drvdata(dev));\r\nif (off >= sizeof(struct pyra_profile_settings))\r\nreturn 0;\r\nif (off + count > sizeof(struct pyra_profile_settings))\r\ncount = sizeof(struct pyra_profile_settings) - off;\r\nmutex_lock(&pyra->pyra_lock);\r\nmemcpy(buf, ((char const *)&pyra->profile_settings[*(uint *)(attr->private)]) + off,\r\ncount);\r\nmutex_unlock(&pyra->pyra_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t pyra_sysfs_read_profilex_buttons(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct pyra_device *pyra = hid_get_drvdata(dev_get_drvdata(dev));\r\nif (off >= sizeof(struct pyra_profile_buttons))\r\nreturn 0;\r\nif (off + count > sizeof(struct pyra_profile_buttons))\r\ncount = sizeof(struct pyra_profile_buttons) - off;\r\nmutex_lock(&pyra->pyra_lock);\r\nmemcpy(buf, ((char const *)&pyra->profile_buttons[*(uint *)(attr->private)]) + off,\r\ncount);\r\nmutex_unlock(&pyra->pyra_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t pyra_sysfs_write_profile_settings(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct pyra_device *pyra = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval = 0;\r\nint difference;\r\nint profile_number;\r\nstruct pyra_profile_settings *profile_settings;\r\nif (off != 0 || count != sizeof(struct pyra_profile_settings))\r\nreturn -EINVAL;\r\nprofile_number = ((struct pyra_profile_settings const *)buf)->number;\r\nprofile_settings = &pyra->profile_settings[profile_number];\r\nmutex_lock(&pyra->pyra_lock);\r\ndifference = memcmp(buf, profile_settings,\r\nsizeof(struct pyra_profile_settings));\r\nif (difference) {\r\nretval = pyra_set_profile_settings(usb_dev,\r\n(struct pyra_profile_settings const *)buf);\r\nif (!retval)\r\nmemcpy(profile_settings, buf,\r\nsizeof(struct pyra_profile_settings));\r\n}\r\nmutex_unlock(&pyra->pyra_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn sizeof(struct pyra_profile_settings);\r\n}\r\nstatic ssize_t pyra_sysfs_write_profile_buttons(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct pyra_device *pyra = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval = 0;\r\nint difference;\r\nint profile_number;\r\nstruct pyra_profile_buttons *profile_buttons;\r\nif (off != 0 || count != sizeof(struct pyra_profile_buttons))\r\nreturn -EINVAL;\r\nprofile_number = ((struct pyra_profile_buttons const *)buf)->number;\r\nprofile_buttons = &pyra->profile_buttons[profile_number];\r\nmutex_lock(&pyra->pyra_lock);\r\ndifference = memcmp(buf, profile_buttons,\r\nsizeof(struct pyra_profile_buttons));\r\nif (difference) {\r\nretval = pyra_set_profile_buttons(usb_dev,\r\n(struct pyra_profile_buttons const *)buf);\r\nif (!retval)\r\nmemcpy(profile_buttons, buf,\r\nsizeof(struct pyra_profile_buttons));\r\n}\r\nmutex_unlock(&pyra->pyra_lock);\r\nif (retval)\r\nreturn retval;\r\nreturn sizeof(struct pyra_profile_buttons);\r\n}\r\nstatic ssize_t pyra_sysfs_read_settings(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct pyra_device *pyra = hid_get_drvdata(dev_get_drvdata(dev));\r\nif (off >= sizeof(struct pyra_settings))\r\nreturn 0;\r\nif (off + count > sizeof(struct pyra_settings))\r\ncount = sizeof(struct pyra_settings) - off;\r\nmutex_lock(&pyra->pyra_lock);\r\nmemcpy(buf, ((char const *)&pyra->settings) + off, count);\r\nmutex_unlock(&pyra->pyra_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t pyra_sysfs_write_settings(struct file *fp,\r\nstruct kobject *kobj, struct bin_attribute *attr, char *buf,\r\nloff_t off, size_t count)\r\n{\r\nstruct device *dev =\r\ncontainer_of(kobj, struct device, kobj)->parent->parent;\r\nstruct pyra_device *pyra = hid_get_drvdata(dev_get_drvdata(dev));\r\nstruct usb_device *usb_dev = interface_to_usbdev(to_usb_interface(dev));\r\nint retval = 0;\r\nint difference;\r\nstruct pyra_roccat_report roccat_report;\r\nif (off != 0 || count != sizeof(struct pyra_settings))\r\nreturn -EINVAL;\r\nmutex_lock(&pyra->pyra_lock);\r\ndifference = memcmp(buf, &pyra->settings, sizeof(struct pyra_settings));\r\nif (difference) {\r\nretval = pyra_set_settings(usb_dev,\r\n(struct pyra_settings const *)buf);\r\nif (retval) {\r\nmutex_unlock(&pyra->pyra_lock);\r\nreturn retval;\r\n}\r\nmemcpy(&pyra->settings, buf,\r\nsizeof(struct pyra_settings));\r\nprofile_activated(pyra, pyra->settings.startup_profile);\r\nroccat_report.type = PYRA_MOUSE_EVENT_BUTTON_TYPE_PROFILE_2;\r\nroccat_report.value = pyra->settings.startup_profile + 1;\r\nroccat_report.key = 0;\r\nroccat_report_event(pyra->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\n}\r\nmutex_unlock(&pyra->pyra_lock);\r\nreturn sizeof(struct pyra_settings);\r\n}\r\nstatic ssize_t pyra_sysfs_show_actual_cpi(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pyra_device *pyra =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", pyra->actual_cpi);\r\n}\r\nstatic ssize_t pyra_sysfs_show_actual_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pyra_device *pyra =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", pyra->actual_profile);\r\n}\r\nstatic ssize_t pyra_sysfs_show_firmware_version(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pyra_device *pyra =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", pyra->firmware_version);\r\n}\r\nstatic ssize_t pyra_sysfs_show_startup_profile(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pyra_device *pyra =\r\nhid_get_drvdata(dev_get_drvdata(dev->parent->parent));\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", pyra->settings.startup_profile);\r\n}\r\nstatic int pyra_init_pyra_device_struct(struct usb_device *usb_dev,\r\nstruct pyra_device *pyra)\r\n{\r\nstruct pyra_info info;\r\nint retval, i;\r\nmutex_init(&pyra->pyra_lock);\r\nretval = pyra_get_info(usb_dev, &info);\r\nif (retval)\r\nreturn retval;\r\npyra->firmware_version = info.firmware_version;\r\nretval = pyra_get_settings(usb_dev, &pyra->settings);\r\nif (retval)\r\nreturn retval;\r\nfor (i = 0; i < 5; ++i) {\r\nretval = pyra_get_profile_settings(usb_dev,\r\n&pyra->profile_settings[i], i);\r\nif (retval)\r\nreturn retval;\r\nretval = pyra_get_profile_buttons(usb_dev,\r\n&pyra->profile_buttons[i], i);\r\nif (retval)\r\nreturn retval;\r\n}\r\nprofile_activated(pyra, pyra->settings.startup_profile);\r\nreturn 0;\r\n}\r\nstatic int pyra_init_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct usb_device *usb_dev = interface_to_usbdev(intf);\r\nstruct pyra_device *pyra;\r\nint retval;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\npyra = kzalloc(sizeof(*pyra), GFP_KERNEL);\r\nif (!pyra) {\r\nhid_err(hdev, "can't alloc device descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\nhid_set_drvdata(hdev, pyra);\r\nretval = pyra_init_pyra_device_struct(usb_dev, pyra);\r\nif (retval) {\r\nhid_err(hdev, "couldn't init struct pyra_device\n");\r\ngoto exit_free;\r\n}\r\nretval = roccat_connect(pyra_class, hdev,\r\nsizeof(struct pyra_roccat_report));\r\nif (retval < 0) {\r\nhid_err(hdev, "couldn't init char dev\n");\r\n} else {\r\npyra->chrdev_minor = retval;\r\npyra->roccat_claimed = 1;\r\n}\r\n} else {\r\nhid_set_drvdata(hdev, NULL);\r\n}\r\nreturn 0;\r\nexit_free:\r\nkfree(pyra);\r\nreturn retval;\r\n}\r\nstatic void pyra_remove_specials(struct hid_device *hdev)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct pyra_device *pyra;\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n== USB_INTERFACE_PROTOCOL_MOUSE) {\r\npyra = hid_get_drvdata(hdev);\r\nif (pyra->roccat_claimed)\r\nroccat_disconnect(pyra->chrdev_minor);\r\nkfree(hid_get_drvdata(hdev));\r\n}\r\n}\r\nstatic int pyra_probe(struct hid_device *hdev, const struct hid_device_id *id)\r\n{\r\nint retval;\r\nretval = hid_parse(hdev);\r\nif (retval) {\r\nhid_err(hdev, "parse failed\n");\r\ngoto exit;\r\n}\r\nretval = hid_hw_start(hdev, HID_CONNECT_DEFAULT);\r\nif (retval) {\r\nhid_err(hdev, "hw start failed\n");\r\ngoto exit;\r\n}\r\nretval = pyra_init_specials(hdev);\r\nif (retval) {\r\nhid_err(hdev, "couldn't install mouse\n");\r\ngoto exit_stop;\r\n}\r\nreturn 0;\r\nexit_stop:\r\nhid_hw_stop(hdev);\r\nexit:\r\nreturn retval;\r\n}\r\nstatic void pyra_remove(struct hid_device *hdev)\r\n{\r\npyra_remove_specials(hdev);\r\nhid_hw_stop(hdev);\r\n}\r\nstatic void pyra_keep_values_up_to_date(struct pyra_device *pyra,\r\nu8 const *data)\r\n{\r\nstruct pyra_mouse_event_button const *button_event;\r\nswitch (data[0]) {\r\ncase PYRA_MOUSE_REPORT_NUMBER_BUTTON:\r\nbutton_event = (struct pyra_mouse_event_button const *)data;\r\nswitch (button_event->type) {\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_PROFILE_2:\r\nprofile_activated(pyra, button_event->data1 - 1);\r\nbreak;\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_CPI:\r\npyra->actual_cpi = button_event->data1;\r\nbreak;\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic void pyra_report_to_chrdev(struct pyra_device const *pyra,\r\nu8 const *data)\r\n{\r\nstruct pyra_roccat_report roccat_report;\r\nstruct pyra_mouse_event_button const *button_event;\r\nif (data[0] != PYRA_MOUSE_REPORT_NUMBER_BUTTON)\r\nreturn;\r\nbutton_event = (struct pyra_mouse_event_button const *)data;\r\nswitch (button_event->type) {\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_PROFILE_2:\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_CPI:\r\nroccat_report.type = button_event->type;\r\nroccat_report.value = button_event->data1;\r\nroccat_report.key = 0;\r\nroccat_report_event(pyra->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\nbreak;\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_MACRO:\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_SHORTCUT:\r\ncase PYRA_MOUSE_EVENT_BUTTON_TYPE_QUICKLAUNCH:\r\nif (button_event->data2 == PYRA_MOUSE_EVENT_BUTTON_PRESS) {\r\nroccat_report.type = button_event->type;\r\nroccat_report.key = button_event->data1;\r\nroccat_report.value = pyra->actual_profile + 1;\r\nroccat_report_event(pyra->chrdev_minor,\r\n(uint8_t const *)&roccat_report);\r\n}\r\nbreak;\r\n}\r\n}\r\nstatic int pyra_raw_event(struct hid_device *hdev, struct hid_report *report,\r\nu8 *data, int size)\r\n{\r\nstruct usb_interface *intf = to_usb_interface(hdev->dev.parent);\r\nstruct pyra_device *pyra = hid_get_drvdata(hdev);\r\nif (intf->cur_altsetting->desc.bInterfaceProtocol\r\n!= USB_INTERFACE_PROTOCOL_MOUSE)\r\nreturn 0;\r\nif (pyra == NULL)\r\nreturn 0;\r\npyra_keep_values_up_to_date(pyra, data);\r\nif (pyra->roccat_claimed)\r\npyra_report_to_chrdev(pyra, data);\r\nreturn 0;\r\n}\r\nstatic int __init pyra_init(void)\r\n{\r\nint retval;\r\npyra_class = class_create(THIS_MODULE, "pyra");\r\nif (IS_ERR(pyra_class))\r\nreturn PTR_ERR(pyra_class);\r\npyra_class->dev_attrs = pyra_attributes;\r\npyra_class->dev_bin_attrs = pyra_bin_attributes;\r\nretval = hid_register_driver(&pyra_driver);\r\nif (retval)\r\nclass_destroy(pyra_class);\r\nreturn retval;\r\n}\r\nstatic void __exit pyra_exit(void)\r\n{\r\nhid_unregister_driver(&pyra_driver);\r\nclass_destroy(pyra_class);\r\n}

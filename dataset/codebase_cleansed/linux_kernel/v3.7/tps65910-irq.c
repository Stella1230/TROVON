static irqreturn_t tps65910_irq(int irq, void *irq_data)\r\n{\r\nstruct tps65910 *tps65910 = irq_data;\r\nunsigned int reg;\r\nu32 irq_sts;\r\nu32 irq_mask;\r\nint i;\r\ntps65910_reg_read(tps65910, TPS65910_INT_STS, &reg);\r\nirq_sts = reg;\r\ntps65910_reg_read(tps65910, TPS65910_INT_STS2, &reg);\r\nirq_sts |= reg << 8;\r\nswitch (tps65910_chip_id(tps65910)) {\r\ncase TPS65911:\r\ntps65910_reg_read(tps65910, TPS65910_INT_STS3, &reg);\r\nirq_sts |= reg << 16;\r\n}\r\ntps65910_reg_read(tps65910, TPS65910_INT_MSK, &reg);\r\nirq_mask = reg;\r\ntps65910_reg_read(tps65910, TPS65910_INT_MSK2, &reg);\r\nirq_mask |= reg << 8;\r\nswitch (tps65910_chip_id(tps65910)) {\r\ncase TPS65911:\r\ntps65910_reg_read(tps65910, TPS65910_INT_MSK3, &reg);\r\nirq_mask |= reg << 16;\r\n}\r\nirq_sts &= ~irq_mask;\r\nif (!irq_sts)\r\nreturn IRQ_NONE;\r\nfor (i = 0; i < tps65910->irq_num; i++) {\r\nif (!(irq_sts & (1 << i)))\r\ncontinue;\r\nhandle_nested_irq(irq_find_mapping(tps65910->domain, i));\r\n}\r\nreg = irq_sts & 0xFF;\r\nirq_sts >>= 8;\r\ntps65910_reg_write(tps65910, TPS65910_INT_STS, reg);\r\nreg = irq_sts & 0xFF;\r\ntps65910_reg_write(tps65910, TPS65910_INT_STS2, reg);\r\nswitch (tps65910_chip_id(tps65910)) {\r\ncase TPS65911:\r\nreg = irq_sts >> 8;\r\ntps65910_reg_write(tps65910, TPS65910_INT_STS3, reg);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void tps65910_irq_lock(struct irq_data *data)\r\n{\r\nstruct tps65910 *tps65910 = irq_data_get_irq_chip_data(data);\r\nmutex_lock(&tps65910->irq_lock);\r\n}\r\nstatic void tps65910_irq_sync_unlock(struct irq_data *data)\r\n{\r\nstruct tps65910 *tps65910 = irq_data_get_irq_chip_data(data);\r\nu32 reg_mask;\r\nunsigned int reg;\r\ntps65910_reg_read(tps65910, TPS65910_INT_MSK, &reg);\r\nreg_mask = reg;\r\ntps65910_reg_read(tps65910, TPS65910_INT_MSK2, &reg);\r\nreg_mask |= reg << 8;\r\nswitch (tps65910_chip_id(tps65910)) {\r\ncase TPS65911:\r\ntps65910_reg_read(tps65910, TPS65910_INT_MSK3, &reg);\r\nreg_mask |= reg << 16;\r\n}\r\nif (tps65910->irq_mask != reg_mask) {\r\nreg = tps65910->irq_mask & 0xFF;\r\ntps65910_reg_write(tps65910, TPS65910_INT_MSK, reg);\r\nreg = tps65910->irq_mask >> 8 & 0xFF;\r\ntps65910_reg_write(tps65910, TPS65910_INT_MSK2, reg);\r\nswitch (tps65910_chip_id(tps65910)) {\r\ncase TPS65911:\r\nreg = tps65910->irq_mask >> 16;\r\ntps65910_reg_write(tps65910, TPS65910_INT_MSK3, reg);\r\n}\r\n}\r\nmutex_unlock(&tps65910->irq_lock);\r\n}\r\nstatic void tps65910_irq_enable(struct irq_data *data)\r\n{\r\nstruct tps65910 *tps65910 = irq_data_get_irq_chip_data(data);\r\ntps65910->irq_mask &= ~(1 << data->hwirq);\r\n}\r\nstatic void tps65910_irq_disable(struct irq_data *data)\r\n{\r\nstruct tps65910 *tps65910 = irq_data_get_irq_chip_data(data);\r\ntps65910->irq_mask |= (1 << data->hwirq);\r\n}\r\nstatic int tps65910_irq_set_wake(struct irq_data *data, unsigned int enable)\r\n{\r\nstruct tps65910 *tps65910 = irq_data_get_irq_chip_data(data);\r\nreturn irq_set_irq_wake(tps65910->chip_irq, enable);\r\n}\r\nstatic int tps65910_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct tps65910 *tps65910 = h->host_data;\r\nirq_set_chip_data(virq, tps65910);\r\nirq_set_chip_and_handler(virq, &tps65910_irq_chip, handle_edge_irq);\r\nirq_set_nested_thread(virq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(virq, IRQF_VALID);\r\n#else\r\nirq_set_noprobe(virq);\r\n#endif\r\nreturn 0;\r\n}\r\nint tps65910_irq_init(struct tps65910 *tps65910, int irq,\r\nstruct tps65910_platform_data *pdata)\r\n{\r\nint ret;\r\nint flags = IRQF_ONESHOT;\r\nif (!irq) {\r\ndev_warn(tps65910->dev, "No interrupt support, no core IRQ\n");\r\nreturn -EINVAL;\r\n}\r\nif (!pdata) {\r\ndev_warn(tps65910->dev, "No interrupt support, no pdata\n");\r\nreturn -EINVAL;\r\n}\r\nswitch (tps65910_chip_id(tps65910)) {\r\ncase TPS65910:\r\ntps65910->irq_num = TPS65910_NUM_IRQ;\r\nbreak;\r\ncase TPS65911:\r\ntps65910->irq_num = TPS65911_NUM_IRQ;\r\nbreak;\r\n}\r\nif (pdata->irq_base > 0) {\r\npdata->irq_base = irq_alloc_descs(pdata->irq_base, 0,\r\ntps65910->irq_num, -1);\r\nif (pdata->irq_base < 0) {\r\ndev_warn(tps65910->dev, "Failed to alloc IRQs: %d\n",\r\npdata->irq_base);\r\nreturn pdata->irq_base;\r\n}\r\n}\r\ntps65910->irq_mask = 0xFFFFFF;\r\nmutex_init(&tps65910->irq_lock);\r\ntps65910->chip_irq = irq;\r\ntps65910->irq_base = pdata->irq_base;\r\nif (pdata->irq_base > 0)\r\ntps65910->domain = irq_domain_add_legacy(tps65910->dev->of_node,\r\ntps65910->irq_num,\r\npdata->irq_base,\r\n0,\r\n&tps65910_domain_ops, tps65910);\r\nelse\r\ntps65910->domain = irq_domain_add_linear(tps65910->dev->of_node,\r\ntps65910->irq_num,\r\n&tps65910_domain_ops, tps65910);\r\nif (!tps65910->domain) {\r\ndev_err(tps65910->dev, "Failed to create IRQ domain\n");\r\nreturn -ENOMEM;\r\n}\r\nret = request_threaded_irq(irq, NULL, tps65910_irq, flags,\r\n"tps65910", tps65910);\r\nirq_set_irq_type(irq, IRQ_TYPE_LEVEL_LOW);\r\nif (ret != 0)\r\ndev_err(tps65910->dev, "Failed to request IRQ: %d\n", ret);\r\nreturn ret;\r\n}\r\nint tps65910_irq_exit(struct tps65910 *tps65910)\r\n{\r\nif (tps65910->chip_irq)\r\nfree_irq(tps65910->chip_irq, tps65910);\r\nreturn 0;\r\n}

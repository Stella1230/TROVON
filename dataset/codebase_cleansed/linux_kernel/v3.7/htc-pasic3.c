void pasic3_write_register(struct device *dev, u32 reg, u8 val)\r\n{\r\nstruct pasic3_data *asic = dev_get_drvdata(dev);\r\nint bus_shift = asic->bus_shift;\r\nvoid __iomem *addr = asic->mapping + (REG_ADDR << bus_shift);\r\nvoid __iomem *data = asic->mapping + (REG_DATA << bus_shift);\r\n__raw_writeb(~READ_MODE & reg, addr);\r\n__raw_writeb(val, data);\r\n}\r\nu8 pasic3_read_register(struct device *dev, u32 reg)\r\n{\r\nstruct pasic3_data *asic = dev_get_drvdata(dev);\r\nint bus_shift = asic->bus_shift;\r\nvoid __iomem *addr = asic->mapping + (REG_ADDR << bus_shift);\r\nvoid __iomem *data = asic->mapping + (REG_DATA << bus_shift);\r\n__raw_writeb(READ_MODE | reg, addr);\r\nreturn __raw_readb(data);\r\n}\r\nstatic int ds1wm_enable(struct platform_device *pdev)\r\n{\r\nstruct device *dev = pdev->dev.parent;\r\nint c;\r\nc = pasic3_read_register(dev, 0x28);\r\npasic3_write_register(dev, 0x28, c & 0x7f);\r\ndev_dbg(dev, "DS1WM OWM_EN low (active) %02x\n", c & 0x7f);\r\nreturn 0;\r\n}\r\nstatic int ds1wm_disable(struct platform_device *pdev)\r\n{\r\nstruct device *dev = pdev->dev.parent;\r\nint c;\r\nc = pasic3_read_register(dev, 0x28);\r\npasic3_write_register(dev, 0x28, c | 0x80);\r\ndev_dbg(dev, "DS1WM OWM_EN high (inactive) %02x\n", c | 0x80);\r\nreturn 0;\r\n}\r\nstatic int __init pasic3_probe(struct platform_device *pdev)\r\n{\r\nstruct pasic3_platform_data *pdata = pdev->dev.platform_data;\r\nstruct device *dev = &pdev->dev;\r\nstruct pasic3_data *asic;\r\nstruct resource *r;\r\nint ret;\r\nint irq = 0;\r\nr = platform_get_resource(pdev, IORESOURCE_IRQ, 0);\r\nif (r) {\r\nds1wm_resources[1].flags = IORESOURCE_IRQ | (r->flags &\r\n(IORESOURCE_IRQ_HIGHEDGE | IORESOURCE_IRQ_LOWEDGE));\r\nirq = r->start;\r\n}\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!r)\r\nreturn -ENXIO;\r\nif (!request_mem_region(r->start, resource_size(r), "pasic3"))\r\nreturn -EBUSY;\r\nasic = kzalloc(sizeof(struct pasic3_data), GFP_KERNEL);\r\nif (!asic)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, asic);\r\nasic->mapping = ioremap(r->start, resource_size(r));\r\nif (!asic->mapping) {\r\ndev_err(dev, "couldn't ioremap PASIC3\n");\r\nkfree(asic);\r\nreturn -ENOMEM;\r\n}\r\nasic->bus_shift = (resource_size(r) - 5) >> 3;\r\nif (pdata && pdata->clock_rate) {\r\nds1wm_pdata.clock_rate = pdata->clock_rate;\r\nds1wm_resources[0].end = (5 << asic->bus_shift) - 1;\r\nret = mfd_add_devices(&pdev->dev, pdev->id,\r\n&ds1wm_cell, 1, r, irq, NULL);\r\nif (ret < 0)\r\ndev_warn(dev, "failed to register DS1WM\n");\r\n}\r\nif (pdata && pdata->led_pdata) {\r\nled_cell.platform_data = pdata->led_pdata;\r\nled_cell.pdata_size = sizeof(struct pasic3_leds_machinfo);\r\nret = mfd_add_devices(&pdev->dev, pdev->id, &led_cell, 1, r,\r\n0, NULL);\r\nif (ret < 0)\r\ndev_warn(dev, "failed to register LED device\n");\r\n}\r\nreturn 0;\r\n}\r\nstatic int pasic3_remove(struct platform_device *pdev)\r\n{\r\nstruct pasic3_data *asic = platform_get_drvdata(pdev);\r\nstruct resource *r;\r\nmfd_remove_devices(&pdev->dev);\r\niounmap(asic->mapping);\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrelease_mem_region(r->start, resource_size(r));\r\nkfree(asic);\r\nreturn 0;\r\n}\r\nstatic int __init pasic3_base_init(void)\r\n{\r\nreturn platform_driver_probe(&pasic3_driver, pasic3_probe);\r\n}\r\nstatic void __exit pasic3_base_exit(void)\r\n{\r\nplatform_driver_unregister(&pasic3_driver);\r\n}

static void reg_r(struct gspca_dev *gspca_dev,\r\n__u16 req,\r\n__u16 index,\r\n__u16 length)\r\n{\r\nusb_control_msg(gspca_dev->dev,\r\nusb_rcvctrlpipe(gspca_dev->dev, 0),\r\nreq,\r\nUSB_DIR_IN | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\n0,\r\nindex, gspca_dev->usb_buf, length,\r\n500);\r\n}\r\nstatic void reg_w(struct usb_device *dev,\r\n__u16 req,\r\n__u16 value,\r\n__u16 index)\r\n{\r\nusb_control_msg(dev,\r\nusb_sndctrlpipe(dev, 0),\r\nreq,\r\nUSB_DIR_OUT | USB_TYPE_VENDOR | USB_RECIP_DEVICE,\r\nvalue, index,\r\nNULL, 0, 500);\r\n}\r\nstatic void spca506_Initi2c(struct gspca_dev *gspca_dev)\r\n{\r\nreg_w(gspca_dev->dev, 0x07, SAA7113_I2C_BASE_WRITE, 0x0004);\r\n}\r\nstatic void spca506_WriteI2c(struct gspca_dev *gspca_dev, __u16 valeur,\r\n__u16 reg)\r\n{\r\nint retry = 60;\r\nreg_w(gspca_dev->dev, 0x07, reg, 0x0001);\r\nreg_w(gspca_dev->dev, 0x07, valeur, 0x0000);\r\nwhile (retry--) {\r\nreg_r(gspca_dev, 0x07, 0x0003, 2);\r\nif ((gspca_dev->usb_buf[0] | gspca_dev->usb_buf[1]) == 0x00)\r\nbreak;\r\n}\r\n}\r\nstatic void spca506_SetNormeInput(struct gspca_dev *gspca_dev,\r\n__u16 norme,\r\n__u16 channel)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n__u8 setbit0 = 0x00;\r\n__u8 setbit1 = 0x00;\r\n__u8 videomask = 0x00;\r\nPDEBUG(D_STREAM, "** Open Set Norme **");\r\nspca506_Initi2c(gspca_dev);\r\nif (norme & V4L2_STD_NTSC)\r\nsetbit0 = 0x01;\r\nif (channel == 4 || channel == 5 || channel > 9)\r\nchannel = 0;\r\nif (channel < 4)\r\nsetbit1 = 0x02;\r\nvideomask = (0x48 | setbit0 | setbit1);\r\nreg_w(gspca_dev->dev, 0x08, videomask, 0x0000);\r\nspca506_WriteI2c(gspca_dev, (0xc0 | (channel & 0x0F)), 0x02);\r\nif (norme & V4L2_STD_NTSC)\r\nspca506_WriteI2c(gspca_dev, 0x33, 0x0e);\r\nelse if (norme & V4L2_STD_SECAM)\r\nspca506_WriteI2c(gspca_dev, 0x53, 0x0e);\r\nelse\r\nspca506_WriteI2c(gspca_dev, 0x03, 0x0e);\r\nsd->norme = norme;\r\nsd->channel = channel;\r\nPDEBUG(D_STREAM, "Set Video Byte to 0x%2x", videomask);\r\nPDEBUG(D_STREAM, "Set Norme: %08x Channel %d", norme, channel);\r\n}\r\nstatic void spca506_GetNormeInput(struct gspca_dev *gspca_dev,\r\n__u16 *norme, __u16 *channel)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\n*norme = sd->norme;\r\n*channel = sd->channel;\r\nPDEBUG(D_STREAM, "Get Norme: %d Channel %d", *norme, *channel);\r\n}\r\nstatic void spca506_Setsize(struct gspca_dev *gspca_dev, __u16 code,\r\n__u16 xmult, __u16 ymult)\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nPDEBUG(D_STREAM, "** SetSize **");\r\nreg_w(dev, 0x04, (0x18 | (code & 0x07)), 0x0000);\r\nreg_w(dev, 0x04, 0x41, 0x0001);\r\nreg_w(dev, 0x04, 0x00, 0x0002);\r\nreg_w(dev, 0x04, 0x00, 0x0003);\r\nreg_w(dev, 0x04, 0x00, 0x0004);\r\nreg_w(dev, 0x04, 0x01, 0x0005);\r\nreg_w(dev, 0x04, xmult, 0x0006);\r\nreg_w(dev, 0x04, ymult, 0x0007);\r\nreg_w(dev, 0x04, 0x00, 0x0008);\r\nreg_w(dev, 0x04, 0x00, 0x0009);\r\nreg_w(dev, 0x04, 0x21, 0x000a);\r\nreg_w(dev, 0x04, 0x00, 0x000b);\r\n}\r\nstatic int sd_config(struct gspca_dev *gspca_dev,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct cam *cam;\r\ncam = &gspca_dev->cam;\r\ncam->cam_mode = vga_mode;\r\ncam->nmodes = ARRAY_SIZE(vga_mode);\r\nreturn 0;\r\n}\r\nstatic int sd_init(struct gspca_dev *gspca_dev)\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nreg_w(dev, 0x03, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0xFF, 0x0003);\r\nreg_w(dev, 0x03, 0x00, 0x0000);\r\nreg_w(dev, 0x03, 0x1c, 0x0001);\r\nreg_w(dev, 0x03, 0x18, 0x0001);\r\nspca506_SetNormeInput(gspca_dev, 0, 0);\r\nreg_w(dev, 0x03, 0x1c, 0x0001);\r\nreg_w(dev, 0x03, 0x18, 0x0001);\r\nreg_w(dev, 0x05, 0x00, 0x0000);\r\nreg_w(dev, 0x05, 0xef, 0x0001);\r\nreg_w(dev, 0x05, 0x00, 0x00c1);\r\nreg_w(dev, 0x05, 0x00, 0x00c2);\r\nreg_w(dev, 0x06, 0x18, 0x0002);\r\nreg_w(dev, 0x06, 0xf5, 0x0011);\r\nreg_w(dev, 0x06, 0x02, 0x0012);\r\nreg_w(dev, 0x06, 0xfb, 0x0013);\r\nreg_w(dev, 0x06, 0x00, 0x0014);\r\nreg_w(dev, 0x06, 0xa4, 0x0051);\r\nreg_w(dev, 0x06, 0x40, 0x0052);\r\nreg_w(dev, 0x06, 0x71, 0x0053);\r\nreg_w(dev, 0x06, 0x40, 0x0054);\r\nreg_w(dev, 0x03, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0x00, 0x0003);\r\nreg_w(dev, 0x03, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0xFF, 0x0003);\r\nreg_w(dev, 0x02, 0x00, 0x0000);\r\nreg_w(dev, 0x03, 0x60, 0x0000);\r\nreg_w(dev, 0x03, 0x18, 0x0001);\r\nspca506_Initi2c(gspca_dev);\r\nspca506_WriteI2c(gspca_dev, 0x08, 0x01);\r\nspca506_WriteI2c(gspca_dev, 0xc0, 0x02);\r\nspca506_WriteI2c(gspca_dev, 0x33, 0x03);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x04);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x05);\r\nspca506_WriteI2c(gspca_dev, 0x0d, 0x06);\r\nspca506_WriteI2c(gspca_dev, 0xf0, 0x07);\r\nspca506_WriteI2c(gspca_dev, 0x98, 0x08);\r\nspca506_WriteI2c(gspca_dev, 0x03, 0x09);\r\nspca506_WriteI2c(gspca_dev, 0x80, 0x0a);\r\nspca506_WriteI2c(gspca_dev, 0x47, 0x0b);\r\nspca506_WriteI2c(gspca_dev, 0x48, 0x0c);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x0d);\r\nspca506_WriteI2c(gspca_dev, 0x03, 0x0e);\r\nspca506_WriteI2c(gspca_dev, 0x2a, 0x0f);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x10);\r\nspca506_WriteI2c(gspca_dev, 0x0c, 0x11);\r\nspca506_WriteI2c(gspca_dev, 0xb8, 0x12);\r\nspca506_WriteI2c(gspca_dev, 0x01, 0x13);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x14);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x15);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x16);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x17);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x18);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x19);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1a);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1b);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1c);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1d);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1e);\r\nspca506_WriteI2c(gspca_dev, 0xa1, 0x1f);\r\nspca506_WriteI2c(gspca_dev, 0x02, 0x40);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x41);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x42);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x43);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x44);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x45);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x46);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x47);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x48);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x49);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4a);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4b);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4c);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4d);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4e);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4f);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x50);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x51);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x52);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x53);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x54);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x55);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x56);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x57);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x58);\r\nspca506_WriteI2c(gspca_dev, 0x54, 0x59);\r\nspca506_WriteI2c(gspca_dev, 0x07, 0x5a);\r\nspca506_WriteI2c(gspca_dev, 0x83, 0x5b);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5c);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5d);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5e);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5f);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x60);\r\nspca506_WriteI2c(gspca_dev, 0x05, 0x61);\r\nspca506_WriteI2c(gspca_dev, 0x9f, 0x62);\r\nPDEBUG(D_STREAM, "** Close Init *");\r\nreturn 0;\r\n}\r\nstatic int sd_start(struct gspca_dev *gspca_dev)\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\n__u16 norme;\r\n__u16 channel;\r\nreg_w(dev, 0x03, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0x00, 0x0003);\r\nreg_w(dev, 0x03, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0xFF, 0x0003);\r\nreg_w(dev, 0x02, 0x00, 0x0000);\r\nreg_w(dev, 0x03, 0x60, 0x0000);\r\nreg_w(dev, 0x03, 0x18, 0x0001);\r\nspca506_Initi2c(gspca_dev);\r\nspca506_WriteI2c(gspca_dev, 0x08, 0x01);\r\nspca506_WriteI2c(gspca_dev, 0x33, 0x03);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x04);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x05);\r\nspca506_WriteI2c(gspca_dev, 0x0d, 0x06);\r\nspca506_WriteI2c(gspca_dev, 0xf0, 0x07);\r\nspca506_WriteI2c(gspca_dev, 0x98, 0x08);\r\nspca506_WriteI2c(gspca_dev, 0x03, 0x09);\r\nspca506_WriteI2c(gspca_dev, 0x80, 0x0a);\r\nspca506_WriteI2c(gspca_dev, 0x47, 0x0b);\r\nspca506_WriteI2c(gspca_dev, 0x48, 0x0c);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x0d);\r\nspca506_WriteI2c(gspca_dev, 0x2a, 0x0f);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x10);\r\nspca506_WriteI2c(gspca_dev, 0x0c, 0x11);\r\nspca506_WriteI2c(gspca_dev, 0xb8, 0x12);\r\nspca506_WriteI2c(gspca_dev, 0x01, 0x13);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x14);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x15);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x16);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x17);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x18);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x19);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1a);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1b);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1c);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1d);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x1e);\r\nspca506_WriteI2c(gspca_dev, 0xa1, 0x1f);\r\nspca506_WriteI2c(gspca_dev, 0x02, 0x40);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x41);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x42);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x43);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x44);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x45);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x46);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x47);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x48);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x49);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4a);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4b);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4c);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4d);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4e);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x4f);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x50);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x51);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x52);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x53);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x54);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x55);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x56);\r\nspca506_WriteI2c(gspca_dev, 0xff, 0x57);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x58);\r\nspca506_WriteI2c(gspca_dev, 0x54, 0x59);\r\nspca506_WriteI2c(gspca_dev, 0x07, 0x5a);\r\nspca506_WriteI2c(gspca_dev, 0x83, 0x5b);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5c);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5d);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5e);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x5f);\r\nspca506_WriteI2c(gspca_dev, 0x00, 0x60);\r\nspca506_WriteI2c(gspca_dev, 0x05, 0x61);\r\nspca506_WriteI2c(gspca_dev, 0x9f, 0x62);\r\nreg_w(dev, 0x05, 0x00, 0x0003);\r\nreg_w(dev, 0x05, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0x10, 0x0001);\r\nreg_w(dev, 0x03, 0x78, 0x0000);\r\nswitch (gspca_dev->cam.cam_mode[(int) gspca_dev->curr_mode].priv) {\r\ncase 0:\r\nspca506_Setsize(gspca_dev, 0, 0x10, 0x10);\r\nbreak;\r\ncase 1:\r\nspca506_Setsize(gspca_dev, 1, 0x1a, 0x1a);\r\nbreak;\r\ncase 2:\r\nspca506_Setsize(gspca_dev, 2, 0x1c, 0x1c);\r\nbreak;\r\ncase 4:\r\nspca506_Setsize(gspca_dev, 4, 0x34, 0x34);\r\nbreak;\r\ndefault:\r\nspca506_Setsize(gspca_dev, 5, 0x40, 0x40);\r\nbreak;\r\n}\r\nreg_w(dev, 0x02, 0x01, 0x0000);\r\nreg_w(dev, 0x03, 0x12, 0x0000);\r\nreg_r(gspca_dev, 0x04, 0x0001, 2);\r\nPDEBUG(D_STREAM, "webcam started");\r\nspca506_GetNormeInput(gspca_dev, &norme, &channel);\r\nspca506_SetNormeInput(gspca_dev, norme, channel);\r\nreturn 0;\r\n}\r\nstatic void sd_stopN(struct gspca_dev *gspca_dev)\r\n{\r\nstruct usb_device *dev = gspca_dev->dev;\r\nreg_w(dev, 0x02, 0x00, 0x0000);\r\nreg_w(dev, 0x03, 0x00, 0x0004);\r\nreg_w(dev, 0x03, 0x00, 0x0003);\r\n}\r\nstatic void sd_pkt_scan(struct gspca_dev *gspca_dev,\r\nu8 *data,\r\nint len)\r\n{\r\nswitch (data[0]) {\r\ncase 0:\r\ngspca_frame_add(gspca_dev, LAST_PACKET, NULL, 0);\r\ndata += SPCA50X_OFFSET_DATA;\r\nlen -= SPCA50X_OFFSET_DATA;\r\ngspca_frame_add(gspca_dev, FIRST_PACKET, data, len);\r\nbreak;\r\ncase 0xff:\r\nbreak;\r\ndefault:\r\ndata += 1;\r\nlen -= 1;\r\ngspca_frame_add(gspca_dev, INTER_PACKET, data, len);\r\nbreak;\r\n}\r\n}\r\nstatic void setbrightness(struct gspca_dev *gspca_dev, s32 val)\r\n{\r\nspca506_Initi2c(gspca_dev);\r\nspca506_WriteI2c(gspca_dev, val, SAA7113_bright);\r\nspca506_WriteI2c(gspca_dev, 0x01, 0x09);\r\n}\r\nstatic void setcontrast(struct gspca_dev *gspca_dev, s32 val)\r\n{\r\nspca506_Initi2c(gspca_dev);\r\nspca506_WriteI2c(gspca_dev, val, SAA7113_contrast);\r\nspca506_WriteI2c(gspca_dev, 0x01, 0x09);\r\n}\r\nstatic void setcolors(struct gspca_dev *gspca_dev, s32 val)\r\n{\r\nspca506_Initi2c(gspca_dev);\r\nspca506_WriteI2c(gspca_dev, val, SAA7113_saturation);\r\nspca506_WriteI2c(gspca_dev, 0x01, 0x09);\r\n}\r\nstatic void sethue(struct gspca_dev *gspca_dev, s32 val)\r\n{\r\nspca506_Initi2c(gspca_dev);\r\nspca506_WriteI2c(gspca_dev, val, SAA7113_hue);\r\nspca506_WriteI2c(gspca_dev, 0x01, 0x09);\r\n}\r\nstatic int sd_s_ctrl(struct v4l2_ctrl *ctrl)\r\n{\r\nstruct gspca_dev *gspca_dev =\r\ncontainer_of(ctrl->handler, struct gspca_dev, ctrl_handler);\r\ngspca_dev->usb_err = 0;\r\nif (!gspca_dev->streaming)\r\nreturn 0;\r\nswitch (ctrl->id) {\r\ncase V4L2_CID_BRIGHTNESS:\r\nsetbrightness(gspca_dev, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_CONTRAST:\r\nsetcontrast(gspca_dev, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_SATURATION:\r\nsetcolors(gspca_dev, ctrl->val);\r\nbreak;\r\ncase V4L2_CID_HUE:\r\nsethue(gspca_dev, ctrl->val);\r\nbreak;\r\n}\r\nreturn gspca_dev->usb_err;\r\n}\r\nstatic int sd_init_controls(struct gspca_dev *gspca_dev)\r\n{\r\nstruct v4l2_ctrl_handler *hdl = &gspca_dev->ctrl_handler;\r\ngspca_dev->vdev.ctrl_handler = hdl;\r\nv4l2_ctrl_handler_init(hdl, 4);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_BRIGHTNESS, 0, 255, 1, 128);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_CONTRAST, 0, 255, 1, 0x47);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_SATURATION, 0, 255, 1, 0x40);\r\nv4l2_ctrl_new_std(hdl, &sd_ctrl_ops,\r\nV4L2_CID_HUE, 0, 255, 1, 0);\r\nif (hdl->error) {\r\npr_err("Could not initialize controls\n");\r\nreturn hdl->error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit sd_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nreturn gspca_dev_probe(intf, id, &sd_desc, sizeof(struct sd),\r\nTHIS_MODULE);\r\n}

int max8997_read_reg(struct i2c_client *i2c, u8 reg, u8 *dest)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nmutex_unlock(&max8997->iolock);\r\nif (ret < 0)\r\nreturn ret;\r\nret &= 0xff;\r\n*dest = ret;\r\nreturn 0;\r\n}\r\nint max8997_bulk_read(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_read_i2c_block_data(i2c, reg, count, buf);\r\nmutex_unlock(&max8997->iolock);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint max8997_write_reg(struct i2c_client *i2c, u8 reg, u8 value)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_write_byte_data(i2c, reg, value);\r\nmutex_unlock(&max8997->iolock);\r\nreturn ret;\r\n}\r\nint max8997_bulk_write(struct i2c_client *i2c, u8 reg, int count, u8 *buf)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_write_i2c_block_data(i2c, reg, count, buf);\r\nmutex_unlock(&max8997->iolock);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint max8997_update_reg(struct i2c_client *i2c, u8 reg, u8 val, u8 mask)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&max8997->iolock);\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nif (ret >= 0) {\r\nu8 old_val = ret & 0xff;\r\nu8 new_val = (val & mask) | (old_val & (~mask));\r\nret = i2c_smbus_write_byte_data(i2c, reg, new_val);\r\n}\r\nmutex_unlock(&max8997->iolock);\r\nreturn ret;\r\n}\r\nstatic int max8997_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8997_dev *max8997;\r\nstruct max8997_platform_data *pdata = i2c->dev.platform_data;\r\nint ret = 0;\r\nmax8997 = kzalloc(sizeof(struct max8997_dev), GFP_KERNEL);\r\nif (max8997 == NULL)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(i2c, max8997);\r\nmax8997->dev = &i2c->dev;\r\nmax8997->i2c = i2c;\r\nmax8997->type = id->driver_data;\r\nmax8997->irq = i2c->irq;\r\nif (!pdata)\r\ngoto err;\r\nmax8997->ono = pdata->ono;\r\nmutex_init(&max8997->iolock);\r\nmax8997->rtc = i2c_new_dummy(i2c->adapter, I2C_ADDR_RTC);\r\ni2c_set_clientdata(max8997->rtc, max8997);\r\nmax8997->haptic = i2c_new_dummy(i2c->adapter, I2C_ADDR_HAPTIC);\r\ni2c_set_clientdata(max8997->haptic, max8997);\r\nmax8997->muic = i2c_new_dummy(i2c->adapter, I2C_ADDR_MUIC);\r\ni2c_set_clientdata(max8997->muic, max8997);\r\npm_runtime_set_active(max8997->dev);\r\nmax8997_irq_init(max8997);\r\nmfd_add_devices(max8997->dev, -1, max8997_devs,\r\nARRAY_SIZE(max8997_devs),\r\nNULL, 0, NULL);\r\nif (ret < 0)\r\ngoto err_mfd;\r\ndevice_init_wakeup(max8997->dev, pdata->wakeup);\r\nreturn ret;\r\nerr_mfd:\r\nmfd_remove_devices(max8997->dev);\r\ni2c_unregister_device(max8997->muic);\r\ni2c_unregister_device(max8997->haptic);\r\ni2c_unregister_device(max8997->rtc);\r\nerr:\r\nkfree(max8997);\r\nreturn ret;\r\n}\r\nstatic int max8997_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nmfd_remove_devices(max8997->dev);\r\ni2c_unregister_device(max8997->muic);\r\ni2c_unregister_device(max8997->haptic);\r\ni2c_unregister_device(max8997->rtc);\r\nkfree(max8997);\r\nreturn 0;\r\n}\r\nstatic int max8997_freeze(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = container_of(dev, struct i2c_client, dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_pmic); i++)\r\nmax8997_read_reg(i2c, max8997_dumpaddr_pmic[i],\r\n&max8997->reg_dump[i]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_muic); i++)\r\nmax8997_read_reg(i2c, max8997_dumpaddr_muic[i],\r\n&max8997->reg_dump[i + MAX8997_REG_PMIC_END]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_haptic); i++)\r\nmax8997_read_reg(i2c, max8997_dumpaddr_haptic[i],\r\n&max8997->reg_dump[i + MAX8997_REG_PMIC_END +\r\nMAX8997_MUIC_REG_END]);\r\nreturn 0;\r\n}\r\nstatic int max8997_restore(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = container_of(dev, struct i2c_client, dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_pmic); i++)\r\nmax8997_write_reg(i2c, max8997_dumpaddr_pmic[i],\r\nmax8997->reg_dump[i]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_muic); i++)\r\nmax8997_write_reg(i2c, max8997_dumpaddr_muic[i],\r\nmax8997->reg_dump[i + MAX8997_REG_PMIC_END]);\r\nfor (i = 0; i < ARRAY_SIZE(max8997_dumpaddr_haptic); i++)\r\nmax8997_write_reg(i2c, max8997_dumpaddr_haptic[i],\r\nmax8997->reg_dump[i + MAX8997_REG_PMIC_END +\r\nMAX8997_MUIC_REG_END]);\r\nreturn 0;\r\n}\r\nstatic int max8997_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = container_of(dev, struct i2c_client, dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nirq_set_irq_wake(max8997->irq, 1);\r\nreturn 0;\r\n}\r\nstatic int max8997_resume(struct device *dev)\r\n{\r\nstruct i2c_client *i2c = container_of(dev, struct i2c_client, dev);\r\nstruct max8997_dev *max8997 = i2c_get_clientdata(i2c);\r\nif (device_may_wakeup(dev))\r\nirq_set_irq_wake(max8997->irq, 0);\r\nreturn max8997_irq_resume(max8997);\r\n}\r\nstatic int __init max8997_i2c_init(void)\r\n{\r\nreturn i2c_add_driver(&max8997_i2c_driver);\r\n}\r\nstatic void __exit max8997_i2c_exit(void)\r\n{\r\ni2c_del_driver(&max8997_i2c_driver);\r\n}

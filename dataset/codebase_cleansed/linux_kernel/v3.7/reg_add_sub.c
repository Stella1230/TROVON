int FPU_add(FPU_REG const *b, u_char tagb, int deststnr, int control_w)\r\n{\r\nFPU_REG *a = &st(0);\r\nFPU_REG *dest = &st(deststnr);\r\nu_char signb = getsign(b);\r\nu_char taga = FPU_gettag0();\r\nu_char signa = getsign(a);\r\nu_char saved_sign = getsign(dest);\r\nint diff, tag, expa, expb;\r\nif (!(taga | tagb)) {\r\nexpa = exponent(a);\r\nexpb = exponent(b);\r\nvalid_add:\r\nif (!(signa ^ signb)) {\r\ntag =\r\nFPU_u_add(a, b, dest, control_w, signa, expa, expb);\r\n} else {\r\ndiff = expa - expb;\r\nif (!diff) {\r\ndiff = a->sigh - b->sigh;\r\nif (!diff) {\r\ndiff = a->sigl > b->sigl;\r\nif (!diff)\r\ndiff = -(a->sigl < b->sigl);\r\n}\r\n}\r\nif (diff > 0) {\r\ntag =\r\nFPU_u_sub(a, b, dest, control_w, signa,\r\nexpa, expb);\r\n} else if (diff < 0) {\r\ntag =\r\nFPU_u_sub(b, a, dest, control_w, signb,\r\nexpb, expa);\r\n} else {\r\nFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\r\nsetsign(dest, ((control_w & CW_RC) != RC_DOWN)\r\n? SIGN_POS : SIGN_NEG);\r\nreturn TAG_Zero;\r\n}\r\n}\r\nif (tag < 0) {\r\nsetsign(dest, saved_sign);\r\nreturn tag;\r\n}\r\nFPU_settagi(deststnr, tag);\r\nreturn tag;\r\n}\r\nif (taga == TAG_Special)\r\ntaga = FPU_Special(a);\r\nif (tagb == TAG_Special)\r\ntagb = FPU_Special(b);\r\nif (((taga == TAG_Valid) && (tagb == TW_Denormal))\r\n|| ((taga == TW_Denormal) && (tagb == TAG_Valid))\r\n|| ((taga == TW_Denormal) && (tagb == TW_Denormal))) {\r\nFPU_REG x, y;\r\nif (denormal_operand() < 0)\r\nreturn FPU_Exception;\r\nFPU_to_exp16(a, &x);\r\nFPU_to_exp16(b, &y);\r\na = &x;\r\nb = &y;\r\nexpa = exponent16(a);\r\nexpb = exponent16(b);\r\ngoto valid_add;\r\n}\r\nif ((taga == TW_NaN) || (tagb == TW_NaN)) {\r\nif (deststnr == 0)\r\nreturn real_2op_NaN(b, tagb, deststnr, a);\r\nelse\r\nreturn real_2op_NaN(a, taga, deststnr, a);\r\n}\r\nreturn add_sub_specials(a, taga, signa, b, tagb, signb,\r\ndest, deststnr, control_w);\r\n}\r\nint FPU_sub(int flags, int rm, int control_w)\r\n{\r\nFPU_REG const *a, *b;\r\nFPU_REG *dest;\r\nu_char taga, tagb, signa, signb, saved_sign, sign;\r\nint diff, tag = 0, expa, expb, deststnr;\r\na = &st(0);\r\ntaga = FPU_gettag0();\r\ndeststnr = 0;\r\nif (flags & LOADED) {\r\nb = (FPU_REG *) rm;\r\ntagb = flags & 0x0f;\r\n} else {\r\nb = &st(rm);\r\ntagb = FPU_gettagi(rm);\r\nif (flags & DEST_RM)\r\ndeststnr = rm;\r\n}\r\nsigna = getsign(a);\r\nsignb = getsign(b);\r\nif (flags & REV) {\r\nsigna ^= SIGN_NEG;\r\nsignb ^= SIGN_NEG;\r\n}\r\ndest = &st(deststnr);\r\nsaved_sign = getsign(dest);\r\nif (!(taga | tagb)) {\r\nexpa = exponent(a);\r\nexpb = exponent(b);\r\nvalid_subtract:\r\ndiff = expa - expb;\r\nif (!diff) {\r\ndiff = a->sigh - b->sigh;\r\nif (!diff) {\r\ndiff = a->sigl > b->sigl;\r\nif (!diff)\r\ndiff = -(a->sigl < b->sigl);\r\n}\r\n}\r\nswitch ((((int)signa) * 2 + signb) / SIGN_NEG) {\r\ncase 0:\r\ncase 3:\r\nif (diff > 0) {\r\ntag =\r\nFPU_u_sub(a, b, dest, control_w, signa,\r\nexpa, expb);\r\n} else if (diff == 0) {\r\nFPU_copy_to_regi(&CONST_Z, TAG_Zero, deststnr);\r\nsetsign(dest, ((control_w & CW_RC) != RC_DOWN)\r\n? SIGN_POS : SIGN_NEG);\r\nreturn TAG_Zero;\r\n} else {\r\nsign = signa ^ SIGN_NEG;\r\ntag =\r\nFPU_u_sub(b, a, dest, control_w, sign, expb,\r\nexpa);\r\n}\r\nbreak;\r\ncase 1:\r\ntag =\r\nFPU_u_add(a, b, dest, control_w, SIGN_POS, expa,\r\nexpb);\r\nbreak;\r\ncase 2:\r\ntag =\r\nFPU_u_add(a, b, dest, control_w, SIGN_NEG, expa,\r\nexpb);\r\nbreak;\r\n#ifdef PARANOID\r\ndefault:\r\nEXCEPTION(EX_INTERNAL | 0x111);\r\nreturn -1;\r\n#endif\r\n}\r\nif (tag < 0) {\r\nsetsign(dest, saved_sign);\r\nreturn tag;\r\n}\r\nFPU_settagi(deststnr, tag);\r\nreturn tag;\r\n}\r\nif (taga == TAG_Special)\r\ntaga = FPU_Special(a);\r\nif (tagb == TAG_Special)\r\ntagb = FPU_Special(b);\r\nif (((taga == TAG_Valid) && (tagb == TW_Denormal))\r\n|| ((taga == TW_Denormal) && (tagb == TAG_Valid))\r\n|| ((taga == TW_Denormal) && (tagb == TW_Denormal))) {\r\nFPU_REG x, y;\r\nif (denormal_operand() < 0)\r\nreturn FPU_Exception;\r\nFPU_to_exp16(a, &x);\r\nFPU_to_exp16(b, &y);\r\na = &x;\r\nb = &y;\r\nexpa = exponent16(a);\r\nexpb = exponent16(b);\r\ngoto valid_subtract;\r\n}\r\nif ((taga == TW_NaN) || (tagb == TW_NaN)) {\r\nFPU_REG const *d1, *d2;\r\nif (flags & REV) {\r\nd1 = b;\r\nd2 = a;\r\n} else {\r\nd1 = a;\r\nd2 = b;\r\n}\r\nif (flags & LOADED)\r\nreturn real_2op_NaN(b, tagb, deststnr, d1);\r\nif (flags & DEST_RM)\r\nreturn real_2op_NaN(a, taga, deststnr, d2);\r\nelse\r\nreturn real_2op_NaN(b, tagb, deststnr, d2);\r\n}\r\nreturn add_sub_specials(a, taga, signa, b, tagb, signb ^ SIGN_NEG,\r\ndest, deststnr, control_w);\r\n}\r\nstatic\r\nint add_sub_specials(FPU_REG const *a, u_char taga, u_char signa,\r\nFPU_REG const *b, u_char tagb, u_char signb,\r\nFPU_REG * dest, int deststnr, int control_w)\r\n{\r\nif (((taga == TW_Denormal) || (tagb == TW_Denormal))\r\n&& (denormal_operand() < 0))\r\nreturn FPU_Exception;\r\nif (taga == TAG_Zero) {\r\nif (tagb == TAG_Zero) {\r\nu_char different_signs = signa ^ signb;\r\nFPU_copy_to_regi(a, TAG_Zero, deststnr);\r\nif (different_signs) {\r\nsetsign(dest, ((control_w & CW_RC) != RC_DOWN)\r\n? SIGN_POS : SIGN_NEG);\r\n} else\r\nsetsign(dest, signa);\r\nreturn TAG_Zero;\r\n} else {\r\nreg_copy(b, dest);\r\nif ((tagb == TW_Denormal) && (b->sigh & 0x80000000)) {\r\naddexponent(dest, 1);\r\ntagb = TAG_Valid;\r\n} else if (tagb > TAG_Empty)\r\ntagb = TAG_Special;\r\nsetsign(dest, signb);\r\nFPU_settagi(deststnr, tagb);\r\nreturn tagb;\r\n}\r\n} else if (tagb == TAG_Zero) {\r\nreg_copy(a, dest);\r\nif ((taga == TW_Denormal) && (a->sigh & 0x80000000)) {\r\naddexponent(dest, 1);\r\ntaga = TAG_Valid;\r\n} else if (taga > TAG_Empty)\r\ntaga = TAG_Special;\r\nsetsign(dest, signa);\r\nFPU_settagi(deststnr, taga);\r\nreturn taga;\r\n} else if (taga == TW_Infinity) {\r\nif ((tagb != TW_Infinity) || (signa == signb)) {\r\nFPU_copy_to_regi(a, TAG_Special, deststnr);\r\nsetsign(dest, signa);\r\nreturn taga;\r\n}\r\nreturn arith_invalid(deststnr);\r\n} else if (tagb == TW_Infinity) {\r\nFPU_copy_to_regi(b, TAG_Special, deststnr);\r\nsetsign(dest, signb);\r\nreturn tagb;\r\n}\r\n#ifdef PARANOID\r\nEXCEPTION(EX_INTERNAL | 0x101);\r\n#endif\r\nreturn FPU_Exception;\r\n}

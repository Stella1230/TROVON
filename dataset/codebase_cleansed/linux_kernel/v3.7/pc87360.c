static inline void superio_outb(int sioaddr, int reg, int val)\r\n{\r\noutb(reg, sioaddr);\r\noutb(val, sioaddr + 1);\r\n}\r\nstatic inline int superio_inb(int sioaddr, int reg)\r\n{\r\noutb(reg, sioaddr);\r\nreturn inb(sioaddr + 1);\r\n}\r\nstatic inline void superio_exit(int sioaddr)\r\n{\r\noutb(0x02, sioaddr);\r\noutb(0x02, sioaddr + 1);\r\n}\r\nstatic inline u8 PWM_TO_REG(int val, int inv)\r\n{\r\nif (inv)\r\nval = 255 - val;\r\nif (val < 0)\r\nreturn 0;\r\nif (val > 255)\r\nreturn 255;\r\nreturn val;\r\n}\r\nstatic ssize_t show_fan_input(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", FAN_FROM_REG(data->fan[attr->index],\r\nFAN_DIV_FROM_REG(data->fan_status[attr->index])));\r\n}\r\nstatic ssize_t show_fan_min(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", FAN_FROM_REG(data->fan_min[attr->index],\r\nFAN_DIV_FROM_REG(data->fan_status[attr->index])));\r\n}\r\nstatic ssize_t show_fan_div(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n",\r\nFAN_DIV_FROM_REG(data->fan_status[attr->index]));\r\n}\r\nstatic ssize_t show_fan_status(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n",\r\nFAN_STATUS_FROM_REG(data->fan_status[attr->index]));\r\n}\r\nstatic ssize_t set_fan_min(struct device *dev,\r\nstruct device_attribute *devattr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong fan_min;\r\nint err;\r\nerr = kstrtol(buf, 10, &fan_min);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nfan_min = FAN_TO_REG(fan_min,\r\nFAN_DIV_FROM_REG(data->fan_status[attr->index]));\r\nwhile (fan_min > 255\r\n&& (data->fan_status[attr->index] & 0x60) != 0x60) {\r\nfan_min >>= 1;\r\ndata->fan[attr->index] >>= 1;\r\ndata->fan_status[attr->index] += 0x20;\r\n}\r\ndata->fan_min[attr->index] = fan_min > 255 ? 255 : fan_min;\r\npc87360_write_value(data, LD_FAN, NO_BANK,\r\nPC87360_REG_FAN_MIN(attr->index),\r\ndata->fan_min[attr->index]);\r\npc87360_write_value(data, LD_FAN, NO_BANK,\r\nPC87360_REG_FAN_STATUS(attr->index),\r\ndata->fan_status[attr->index] & 0xF9);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_pwm(struct device *dev, struct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n",\r\nPWM_FROM_REG(data->pwm[attr->index],\r\nFAN_CONFIG_INVERT(data->fan_conf,\r\nattr->index)));\r\n}\r\nstatic ssize_t set_pwm(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->pwm[attr->index] = PWM_TO_REG(val,\r\nFAN_CONFIG_INVERT(data->fan_conf, attr->index));\r\npc87360_write_value(data, LD_FAN, NO_BANK, PC87360_REG_PWM(attr->index),\r\ndata->pwm[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_in_input(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in[attr->index],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_in_min(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_min[attr->index],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_in_max(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_max[attr->index],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_in_status(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", data->in_status[attr->index]);\r\n}\r\nstatic ssize_t set_in_min(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[attr->index] = IN_TO_REG(val, data->in_vref);\r\npc87360_write_value(data, LD_IN, attr->index, PC87365_REG_IN_MIN,\r\ndata->in_min[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_in_max(struct device *dev, struct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[attr->index] = IN_TO_REG(val,\r\ndata->in_vref);\r\npc87360_write_value(data, LD_IN, attr->index, PC87365_REG_IN_MAX,\r\ndata->in_max[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_in_min_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->in_status[nr] & CHAN_ALM_MIN));\r\n}\r\nstatic ssize_t show_in_max_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->in_status[nr] & CHAN_ALM_MAX));\r\n}\r\nstatic ssize_t show_vid(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", vid_from_reg(data->vid, data->vrm));\r\n}\r\nstatic ssize_t show_vrm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%u\n", data->vrm);\r\n}\r\nstatic ssize_t set_vrm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\ndata->vrm = val;\r\nreturn count;\r\n}\r\nstatic ssize_t show_in_alarms(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", data->in_alarms);\r\n}\r\nstatic ssize_t show_therm_input(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in[attr->index],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_therm_min(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_min[attr->index],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_therm_max(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_max[attr->index],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_therm_crit(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_crit[attr->index-11],\r\ndata->in_vref));\r\n}\r\nstatic ssize_t show_therm_status(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", data->in_status[attr->index]);\r\n}\r\nstatic ssize_t set_therm_min(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[attr->index] = IN_TO_REG(val, data->in_vref);\r\npc87360_write_value(data, LD_IN, attr->index, PC87365_REG_TEMP_MIN,\r\ndata->in_min[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_therm_max(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[attr->index] = IN_TO_REG(val, data->in_vref);\r\npc87360_write_value(data, LD_IN, attr->index, PC87365_REG_TEMP_MAX,\r\ndata->in_max[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_therm_crit(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_crit[attr->index-11] = IN_TO_REG(val, data->in_vref);\r\npc87360_write_value(data, LD_IN, attr->index, PC87365_REG_TEMP_CRIT,\r\ndata->in_crit[attr->index-11]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_therm_min_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->in_status[nr] & CHAN_ALM_MIN));\r\n}\r\nstatic ssize_t show_therm_max_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->in_status[nr] & CHAN_ALM_MAX));\r\n}\r\nstatic ssize_t show_therm_crit_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->in_status[nr] & TEMP_ALM_CRIT));\r\n}\r\nstatic ssize_t show_temp_input(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp[attr->index]));\r\n}\r\nstatic ssize_t show_temp_min(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_min[attr->index]));\r\n}\r\nstatic ssize_t show_temp_max(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_max[attr->index]));\r\n}\r\nstatic ssize_t show_temp_crit(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%d\n",\r\nTEMP_FROM_REG(data->temp_crit[attr->index]));\r\n}\r\nstatic ssize_t show_temp_status(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->temp_status[attr->index]);\r\n}\r\nstatic ssize_t set_temp_min(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_min[attr->index] = TEMP_TO_REG(val);\r\npc87360_write_value(data, LD_TEMP, attr->index, PC87365_REG_TEMP_MIN,\r\ndata->temp_min[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_temp_max(struct device *dev,\r\nstruct device_attribute *devattr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_max[attr->index] = TEMP_TO_REG(val);\r\npc87360_write_value(data, LD_TEMP, attr->index, PC87365_REG_TEMP_MAX,\r\ndata->temp_max[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_temp_crit(struct device *dev,\r\nstruct device_attribute *devattr, const char *buf,\r\nsize_t count)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_crit[attr->index] = TEMP_TO_REG(val);\r\npc87360_write_value(data, LD_TEMP, attr->index, PC87365_REG_TEMP_CRIT,\r\ndata->temp_crit[attr->index]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp_alarms(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nreturn sprintf(buf, "%u\n", data->temp_alarms);\r\n}\r\nstatic ssize_t show_temp_min_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->temp_status[nr] & CHAN_ALM_MIN));\r\n}\r\nstatic ssize_t show_temp_max_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->temp_status[nr] & CHAN_ALM_MAX));\r\n}\r\nstatic ssize_t show_temp_crit_alarm(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->temp_status[nr] & TEMP_ALM_CRIT));\r\n}\r\nstatic ssize_t show_temp_fault(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = pc87360_update_device(dev);\r\nunsigned nr = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%u\n", !!(data->temp_status[nr] & TEMP_FAULT));\r\n}\r\nstatic ssize_t show_name(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%s\n", data->name);\r\n}\r\nstatic int __init pc87360_find(int sioaddr, u8 *devid,\r\nunsigned short *addresses)\r\n{\r\nu16 val;\r\nint i;\r\nint nrdev;\r\nval = force_id ? force_id : superio_inb(sioaddr, DEVID);\r\nswitch (val) {\r\ncase 0xE1:\r\ncase 0xE8:\r\ncase 0xE4:\r\nnrdev = 1;\r\nbreak;\r\ncase 0xE5:\r\ncase 0xE9:\r\nnrdev = 3;\r\nbreak;\r\ndefault:\r\nsuperio_exit(sioaddr);\r\nreturn -ENODEV;\r\n}\r\n*devid = val;\r\nfor (i = 0; i < nrdev; i++) {\r\nsuperio_outb(sioaddr, DEV, logdev[i]);\r\nval = superio_inb(sioaddr, ACT);\r\nif (!(val & 0x01)) {\r\npr_info("Device 0x%02x not activated\n", logdev[i]);\r\ncontinue;\r\n}\r\nval = (superio_inb(sioaddr, BASE) << 8)\r\n| superio_inb(sioaddr, BASE + 1);\r\nif (!val) {\r\npr_info("Base address not set for device 0x%02x\n",\r\nlogdev[i]);\r\ncontinue;\r\n}\r\naddresses[i] = val;\r\nif (i == 0) {\r\nconfreg[0] = superio_inb(sioaddr, 0xF0);\r\nconfreg[1] = superio_inb(sioaddr, 0xF1);\r\npr_debug("Fan %d: mon=%d ctrl=%d inv=%d\n", 1,\r\n(confreg[0] >> 2) & 1, (confreg[0] >> 3) & 1,\r\n(confreg[0] >> 4) & 1);\r\npr_debug("Fan %d: mon=%d ctrl=%d inv=%d\n", 2,\r\n(confreg[0] >> 5) & 1, (confreg[0] >> 6) & 1,\r\n(confreg[0] >> 7) & 1);\r\npr_debug("Fan %d: mon=%d ctrl=%d inv=%d\n", 3,\r\nconfreg[1] & 1, (confreg[1] >> 1) & 1,\r\n(confreg[1] >> 2) & 1);\r\n} else if (i == 1) {\r\nif (*devid == 0xE9) {\r\nconfreg[2] = superio_inb(sioaddr, 0x2B);\r\nconfreg[3] = superio_inb(sioaddr, 0x25);\r\nif (confreg[2] & 0x40) {\r\npr_info("Using thermistors for "\r\n"temperature monitoring\n");\r\n}\r\nif (confreg[3] & 0xE0) {\r\npr_info("VID inputs routed (mode %u)\n",\r\nconfreg[3] >> 5);\r\n}\r\n}\r\n}\r\n}\r\nsuperio_exit(sioaddr);\r\nreturn 0;\r\n}\r\nstatic void pc87360_remove_files(struct device *dev)\r\n{\r\nint i;\r\ndevice_remove_file(dev, &dev_attr_name);\r\ndevice_remove_file(dev, &dev_attr_alarms_temp);\r\nfor (i = 0; i < ARRAY_SIZE(pc8736x_temp_attr_group); i++)\r\nsysfs_remove_group(&dev->kobj, &pc8736x_temp_attr_group[i]);\r\nfor (i = 0; i < ARRAY_SIZE(pc8736x_fan_attr_group); i++) {\r\nsysfs_remove_group(&pdev->dev.kobj, &pc8736x_fan_attr_group[i]);\r\ndevice_remove_file(dev, &pwm[i].dev_attr);\r\n}\r\nsysfs_remove_group(&dev->kobj, &pc8736x_therm_group);\r\nsysfs_remove_group(&dev->kobj, &pc8736x_vin_group);\r\n}\r\nstatic int __devinit pc87360_probe(struct platform_device *pdev)\r\n{\r\nint i;\r\nstruct pc87360_data *data;\r\nint err = 0;\r\nconst char *name = "pc87360";\r\nint use_thermistors = 0;\r\nstruct device *dev = &pdev->dev;\r\ndata = devm_kzalloc(dev, sizeof(struct pc87360_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ndata->fannr = 2;\r\ndata->innr = 0;\r\ndata->tempnr = 0;\r\nswitch (devid) {\r\ncase 0xe8:\r\nname = "pc87363";\r\nbreak;\r\ncase 0xe4:\r\nname = "pc87364";\r\ndata->fannr = 3;\r\nbreak;\r\ncase 0xe5:\r\nname = "pc87365";\r\ndata->fannr = extra_isa[0] ? 3 : 0;\r\ndata->innr = extra_isa[1] ? 11 : 0;\r\ndata->tempnr = extra_isa[2] ? 2 : 0;\r\nbreak;\r\ncase 0xe9:\r\nname = "pc87366";\r\ndata->fannr = extra_isa[0] ? 3 : 0;\r\ndata->innr = extra_isa[1] ? 14 : 0;\r\ndata->tempnr = extra_isa[2] ? 3 : 0;\r\nbreak;\r\n}\r\ndata->name = name;\r\ndata->valid = 0;\r\nmutex_init(&data->lock);\r\nmutex_init(&data->update_lock);\r\nplatform_set_drvdata(pdev, data);\r\nfor (i = 0; i < LDNI_MAX; i++) {\r\ndata->address[i] = extra_isa[i];\r\nif (data->address[i]\r\n&& !devm_request_region(dev, extra_isa[i], PC87360_EXTENT,\r\npc87360_driver.driver.name)) {\r\ndev_err(dev, "Region 0x%x-0x%x already "\r\n"in use!\n", extra_isa[i],\r\nextra_isa[i]+PC87360_EXTENT-1);\r\nreturn -EBUSY;\r\n}\r\n}\r\nif (data->fannr)\r\ndata->fan_conf = confreg[0] | (confreg[1] << 8);\r\nif (data->innr) {\r\ni = pc87360_read_value(data, LD_IN, NO_BANK,\r\nPC87365_REG_IN_CONFIG);\r\nif (data->tempnr) {\r\ni &= pc87360_read_value(data, LD_TEMP, NO_BANK,\r\nPC87365_REG_TEMP_CONFIG);\r\n}\r\ndata->in_vref = (i&0x02) ? 3025 : 2966;\r\ndev_dbg(dev, "Using %s reference voltage\n",\r\n(i&0x02) ? "external" : "internal");\r\ndata->vid_conf = confreg[3];\r\ndata->vrm = vid_which_vrm();\r\n}\r\nfor (i = 0; i < data->fannr; i++) {\r\nif (FAN_CONFIG_MONITOR(data->fan_conf, i))\r\ndata->fan_status[i] = pc87360_read_value(data,\r\nLD_FAN, NO_BANK,\r\nPC87360_REG_FAN_STATUS(i));\r\n}\r\nif (init > 0) {\r\nif (devid == 0xe9 && data->address[1])\r\nuse_thermistors = confreg[2] & 0x40;\r\npc87360_init_device(pdev, use_thermistors);\r\n}\r\nif (data->innr) {\r\nerr = sysfs_create_group(&dev->kobj, &pc8736x_vin_group);\r\nif (err)\r\ngoto error;\r\n}\r\nif (data->innr == 14) {\r\nerr = sysfs_create_group(&dev->kobj, &pc8736x_therm_group);\r\nif (err)\r\ngoto error;\r\n}\r\nif (data->tempnr) {\r\nfor (i = 0; i < data->tempnr; i++) {\r\nerr = sysfs_create_group(&dev->kobj,\r\n&pc8736x_temp_attr_group[i]);\r\nif (err)\r\ngoto error;\r\n}\r\nerr = device_create_file(dev, &dev_attr_alarms_temp);\r\nif (err)\r\ngoto error;\r\n}\r\nfor (i = 0; i < data->fannr; i++) {\r\nif (FAN_CONFIG_MONITOR(data->fan_conf, i)) {\r\nerr = sysfs_create_group(&dev->kobj,\r\n&pc8736x_fan_attr_group[i]);\r\nif (err)\r\ngoto error;\r\n}\r\nif (FAN_CONFIG_CONTROL(data->fan_conf, i)) {\r\nerr = device_create_file(dev, &pwm[i].dev_attr);\r\nif (err)\r\ngoto error;\r\n}\r\n}\r\nerr = device_create_file(dev, &dev_attr_name);\r\nif (err)\r\ngoto error;\r\ndata->hwmon_dev = hwmon_device_register(dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\npc87360_remove_files(dev);\r\nreturn err;\r\n}\r\nstatic int __devexit pc87360_remove(struct platform_device *pdev)\r\n{\r\nstruct pc87360_data *data = platform_get_drvdata(pdev);\r\nhwmon_device_unregister(data->hwmon_dev);\r\npc87360_remove_files(&pdev->dev);\r\nreturn 0;\r\n}\r\nstatic int pc87360_read_value(struct pc87360_data *data, u8 ldi, u8 bank,\r\nu8 reg)\r\n{\r\nint res;\r\nmutex_lock(&(data->lock));\r\nif (bank != NO_BANK)\r\noutb_p(bank, data->address[ldi] + PC87365_REG_BANK);\r\nres = inb_p(data->address[ldi] + reg);\r\nmutex_unlock(&(data->lock));\r\nreturn res;\r\n}\r\nstatic void pc87360_write_value(struct pc87360_data *data, u8 ldi, u8 bank,\r\nu8 reg, u8 value)\r\n{\r\nmutex_lock(&(data->lock));\r\nif (bank != NO_BANK)\r\noutb_p(bank, data->address[ldi] + PC87365_REG_BANK);\r\noutb_p(value, data->address[ldi] + reg);\r\nmutex_unlock(&(data->lock));\r\n}\r\nstatic void pc87360_init_device(struct platform_device *pdev,\r\nint use_thermistors)\r\n{\r\nstruct pc87360_data *data = platform_get_drvdata(pdev);\r\nint i, nr;\r\nconst u8 init_in[14] = { 2, 2, 2, 2, 2, 2, 2, 1, 1, 3, 1, 2, 2, 2 };\r\nconst u8 init_temp[3] = { 2, 2, 1 };\r\nu8 reg;\r\nif (init >= 2 && data->innr) {\r\nreg = pc87360_read_value(data, LD_IN, NO_BANK,\r\nPC87365_REG_IN_CONVRATE);\r\ndev_info(&pdev->dev, "VLM conversion set to "\r\n"1s period, 160us delay\n");\r\npc87360_write_value(data, LD_IN, NO_BANK,\r\nPC87365_REG_IN_CONVRATE,\r\n(reg & 0xC0) | 0x11);\r\n}\r\nnr = data->innr < 11 ? data->innr : 11;\r\nfor (i = 0; i < nr; i++) {\r\nreg = pc87360_read_value(data, LD_IN, i,\r\nPC87365_REG_IN_STATUS);\r\ndev_dbg(&pdev->dev, "bios in%d status:0x%02x\n", i, reg);\r\nif (init >= init_in[i]) {\r\nif (!(reg & CHAN_ENA)) {\r\ndev_dbg(&pdev->dev, "Forcibly "\r\n"enabling in%d\n", i);\r\npc87360_write_value(data, LD_IN, i,\r\nPC87365_REG_IN_STATUS,\r\n(reg & 0x68) | 0x87);\r\n}\r\n}\r\n}\r\ndev_dbg(&pdev->dev, "bios thermistors:%d\n", use_thermistors);\r\nfor (i = 11; i < data->innr; i++) {\r\nreg = pc87360_read_value(data, LD_IN, i,\r\nPC87365_REG_TEMP_STATUS);\r\nuse_thermistors = use_thermistors || (reg & CHAN_ENA);\r\ndev_dbg(&pdev->dev, "bios temp%d_status:0x%02x\n", i-7, reg);\r\n}\r\ndev_dbg(&pdev->dev, "using thermistors:%d\n", use_thermistors);\r\ni = use_thermistors ? 2 : 0;\r\nfor (; i < data->tempnr; i++) {\r\nreg = pc87360_read_value(data, LD_TEMP, i,\r\nPC87365_REG_TEMP_STATUS);\r\ndev_dbg(&pdev->dev, "bios temp%d_status:0x%02x\n", i + 1, reg);\r\nif (init >= init_temp[i]) {\r\nif (!(reg & CHAN_ENA)) {\r\ndev_dbg(&pdev->dev,\r\n"Forcibly enabling temp%d\n", i + 1);\r\npc87360_write_value(data, LD_TEMP, i,\r\nPC87365_REG_TEMP_STATUS,\r\n0xCF);\r\n}\r\n}\r\n}\r\nif (use_thermistors) {\r\nfor (i = 11; i < data->innr; i++) {\r\nif (init >= init_in[i]) {\r\nreg = pc87360_read_value(data, LD_TEMP,\r\n(i - 11) / 2, PC87365_REG_TEMP_STATUS);\r\nif (reg & CHAN_ENA) {\r\ndev_dbg(&pdev->dev,\r\n"Skipping temp%d, pin already in use by temp%d\n",\r\ni - 7, (i - 11) / 2);\r\ncontinue;\r\n}\r\nreg = pc87360_read_value(data, LD_IN, i,\r\nPC87365_REG_IN_STATUS);\r\nif (!(reg & CHAN_ENA)) {\r\ndev_dbg(&pdev->dev,\r\n"Forcibly enabling temp%d\n",\r\ni - 7);\r\npc87360_write_value(data, LD_IN, i,\r\nPC87365_REG_TEMP_STATUS,\r\n(reg & 0x60) | 0x8F);\r\n}\r\n}\r\n}\r\n}\r\nif (data->innr) {\r\nreg = pc87360_read_value(data, LD_IN, NO_BANK,\r\nPC87365_REG_IN_CONFIG);\r\ndev_dbg(&pdev->dev, "bios vin-cfg:0x%02x\n", reg);\r\nif (reg & CHAN_ENA) {\r\ndev_dbg(&pdev->dev,\r\n"Forcibly enabling monitoring (VLM)\n");\r\npc87360_write_value(data, LD_IN, NO_BANK,\r\nPC87365_REG_IN_CONFIG,\r\nreg & 0xFE);\r\n}\r\n}\r\nif (data->tempnr) {\r\nreg = pc87360_read_value(data, LD_TEMP, NO_BANK,\r\nPC87365_REG_TEMP_CONFIG);\r\ndev_dbg(&pdev->dev, "bios temp-cfg:0x%02x\n", reg);\r\nif (reg & CHAN_ENA) {\r\ndev_dbg(&pdev->dev,\r\n"Forcibly enabling monitoring (TMS)\n");\r\npc87360_write_value(data, LD_TEMP, NO_BANK,\r\nPC87365_REG_TEMP_CONFIG,\r\nreg & 0xFE);\r\n}\r\nif (init >= 2) {\r\npc87360_write_value(data, LD_TEMP, 0xF, 0xA, 0x08);\r\npc87360_write_value(data, LD_TEMP, NO_BANK, 0xB, 0x04);\r\npc87360_write_value(data, LD_TEMP, NO_BANK, 0xC, 0x35);\r\npc87360_write_value(data, LD_TEMP, NO_BANK, 0xD, 0x05);\r\npc87360_write_value(data, LD_TEMP, NO_BANK, 0xE, 0x05);\r\n}\r\n}\r\n}\r\nstatic void pc87360_autodiv(struct device *dev, int nr)\r\n{\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nu8 old_min = data->fan_min[nr];\r\nif ((data->fan_status[nr] & 0x04)\r\n|| (data->fan[nr] >= 224)) {\r\nif ((data->fan_status[nr] & 0x60) != 0x60) {\r\ndata->fan_status[nr] += 0x20;\r\ndata->fan_min[nr] >>= 1;\r\ndata->fan[nr] >>= 1;\r\ndev_dbg(dev, "Increasing "\r\n"clock divider to %d for fan %d\n",\r\nFAN_DIV_FROM_REG(data->fan_status[nr]), nr + 1);\r\n}\r\n} else {\r\nwhile (!(data->fan_min[nr] & 0x80)\r\n&& data->fan[nr] < 85\r\n&& (data->fan_status[nr] & 0x60) != 0x00) {\r\ndata->fan_status[nr] -= 0x20;\r\ndata->fan_min[nr] <<= 1;\r\ndata->fan[nr] <<= 1;\r\ndev_dbg(dev, "Decreasing "\r\n"clock divider to %d for fan %d\n",\r\nFAN_DIV_FROM_REG(data->fan_status[nr]),\r\nnr + 1);\r\n}\r\n}\r\nif (old_min != data->fan_min[nr]) {\r\npc87360_write_value(data, LD_FAN, NO_BANK,\r\nPC87360_REG_FAN_MIN(nr),\r\ndata->fan_min[nr]);\r\n}\r\n}\r\nstatic struct pc87360_data *pc87360_update_device(struct device *dev)\r\n{\r\nstruct pc87360_data *data = dev_get_drvdata(dev);\r\nu8 i;\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ * 2) || !data->valid) {\r\ndev_dbg(dev, "Data update\n");\r\nfor (i = 0; i < data->fannr; i++) {\r\nif (FAN_CONFIG_MONITOR(data->fan_conf, i)) {\r\ndata->fan_status[i] =\r\npc87360_read_value(data, LD_FAN,\r\nNO_BANK, PC87360_REG_FAN_STATUS(i));\r\ndata->fan[i] = pc87360_read_value(data, LD_FAN,\r\nNO_BANK, PC87360_REG_FAN(i));\r\ndata->fan_min[i] = pc87360_read_value(data,\r\nLD_FAN, NO_BANK,\r\nPC87360_REG_FAN_MIN(i));\r\npc87360_autodiv(dev, i);\r\npc87360_write_value(data, LD_FAN, NO_BANK,\r\nPC87360_REG_FAN_STATUS(i),\r\ndata->fan_status[i]);\r\n}\r\nif (FAN_CONFIG_CONTROL(data->fan_conf, i))\r\ndata->pwm[i] = pc87360_read_value(data, LD_FAN,\r\nNO_BANK, PC87360_REG_PWM(i));\r\n}\r\nfor (i = 0; i < data->innr; i++) {\r\ndata->in_status[i] = pc87360_read_value(data, LD_IN, i,\r\nPC87365_REG_IN_STATUS);\r\npc87360_write_value(data, LD_IN, i,\r\nPC87365_REG_IN_STATUS,\r\ndata->in_status[i]);\r\nif ((data->in_status[i] & CHAN_READY) == CHAN_READY) {\r\ndata->in[i] = pc87360_read_value(data, LD_IN,\r\ni, PC87365_REG_IN);\r\n}\r\nif (data->in_status[i] & CHAN_ENA) {\r\ndata->in_min[i] = pc87360_read_value(data,\r\nLD_IN, i,\r\nPC87365_REG_IN_MIN);\r\ndata->in_max[i] = pc87360_read_value(data,\r\nLD_IN, i,\r\nPC87365_REG_IN_MAX);\r\nif (i >= 11)\r\ndata->in_crit[i-11] =\r\npc87360_read_value(data, LD_IN,\r\ni, PC87365_REG_TEMP_CRIT);\r\n}\r\n}\r\nif (data->innr) {\r\ndata->in_alarms = pc87360_read_value(data, LD_IN,\r\nNO_BANK, PC87365_REG_IN_ALARMS1)\r\n| ((pc87360_read_value(data, LD_IN,\r\nNO_BANK, PC87365_REG_IN_ALARMS2)\r\n& 0x07) << 8);\r\ndata->vid = (data->vid_conf & 0xE0) ?\r\npc87360_read_value(data, LD_IN,\r\nNO_BANK, PC87365_REG_VID) : 0x1F;\r\n}\r\nfor (i = 0; i < data->tempnr; i++) {\r\ndata->temp_status[i] = pc87360_read_value(data,\r\nLD_TEMP, i,\r\nPC87365_REG_TEMP_STATUS);\r\npc87360_write_value(data, LD_TEMP, i,\r\nPC87365_REG_TEMP_STATUS,\r\ndata->temp_status[i]);\r\nif ((data->temp_status[i] & CHAN_READY) == CHAN_READY) {\r\ndata->temp[i] = pc87360_read_value(data,\r\nLD_TEMP, i,\r\nPC87365_REG_TEMP);\r\n}\r\nif (data->temp_status[i] & CHAN_ENA) {\r\ndata->temp_min[i] = pc87360_read_value(data,\r\nLD_TEMP, i,\r\nPC87365_REG_TEMP_MIN);\r\ndata->temp_max[i] = pc87360_read_value(data,\r\nLD_TEMP, i,\r\nPC87365_REG_TEMP_MAX);\r\ndata->temp_crit[i] = pc87360_read_value(data,\r\nLD_TEMP, i,\r\nPC87365_REG_TEMP_CRIT);\r\n}\r\n}\r\nif (data->tempnr) {\r\ndata->temp_alarms = pc87360_read_value(data, LD_TEMP,\r\nNO_BANK, PC87365_REG_TEMP_ALARMS)\r\n& 0x3F;\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic int __init pc87360_device_add(unsigned short address)\r\n{\r\nstruct resource res[3];\r\nint err, i, res_count;\r\npdev = platform_device_alloc("pc87360", address);\r\nif (!pdev) {\r\nerr = -ENOMEM;\r\npr_err("Device allocation failed\n");\r\ngoto exit;\r\n}\r\nmemset(res, 0, 3 * sizeof(struct resource));\r\nres_count = 0;\r\nfor (i = 0; i < 3; i++) {\r\nif (!extra_isa[i])\r\ncontinue;\r\nres[res_count].start = extra_isa[i];\r\nres[res_count].end = extra_isa[i] + PC87360_EXTENT - 1;\r\nres[res_count].name = "pc87360",\r\nres[res_count].flags = IORESOURCE_IO,\r\nerr = acpi_check_resource_conflict(&res[res_count]);\r\nif (err)\r\ngoto exit_device_put;\r\nres_count++;\r\n}\r\nerr = platform_device_add_resources(pdev, res, res_count);\r\nif (err) {\r\npr_err("Device resources addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nerr = platform_device_add(pdev);\r\nif (err) {\r\npr_err("Device addition failed (%d)\n", err);\r\ngoto exit_device_put;\r\n}\r\nreturn 0;\r\nexit_device_put:\r\nplatform_device_put(pdev);\r\nexit:\r\nreturn err;\r\n}\r\nstatic int __init pc87360_init(void)\r\n{\r\nint err, i;\r\nunsigned short address = 0;\r\nif (pc87360_find(0x2e, &devid, extra_isa)\r\n&& pc87360_find(0x4e, &devid, extra_isa)) {\r\npr_warn("PC8736x not detected, module not inserted\n");\r\nreturn -ENODEV;\r\n}\r\nfor (i = 0; i < 3; i++) {\r\nif (extra_isa[i] != 0x0000) {\r\naddress = extra_isa[i];\r\nbreak;\r\n}\r\n}\r\nif (address == 0x0000) {\r\npr_warn("No active logical device, module not inserted\n");\r\nreturn -ENODEV;\r\n}\r\nerr = platform_driver_register(&pc87360_driver);\r\nif (err)\r\ngoto exit;\r\nerr = pc87360_device_add(address);\r\nif (err)\r\ngoto exit_driver;\r\nreturn 0;\r\nexit_driver:\r\nplatform_driver_unregister(&pc87360_driver);\r\nexit:\r\nreturn err;\r\n}\r\nstatic void __exit pc87360_exit(void)\r\n{\r\nplatform_device_unregister(pdev);\r\nplatform_driver_unregister(&pc87360_driver);\r\n}

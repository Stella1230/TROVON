static void\r\nbrcms_c_antsel_init_cfg(struct antsel_info *asi, struct brcms_antselcfg *antsel,\r\nbool auto_sel)\r\n{\r\nif (asi->antsel_type == ANTSEL_2x3) {\r\nu8 antcfg_def = ANT_SELCFG_DEF_2x3 |\r\n((asi->antsel_avail && auto_sel) ? ANT_SELCFG_AUTO : 0);\r\nantsel->ant_config[ANT_SELCFG_TX_DEF] = antcfg_def;\r\nantsel->ant_config[ANT_SELCFG_TX_UNICAST] = antcfg_def;\r\nantsel->ant_config[ANT_SELCFG_RX_DEF] = antcfg_def;\r\nantsel->ant_config[ANT_SELCFG_RX_UNICAST] = antcfg_def;\r\nantsel->num_antcfg = ANT_SELCFG_NUM_2x3;\r\n} else if (asi->antsel_type == ANTSEL_2x4) {\r\nantsel->ant_config[ANT_SELCFG_TX_DEF] = ANT_SELCFG_DEF_2x4;\r\nantsel->ant_config[ANT_SELCFG_TX_UNICAST] = ANT_SELCFG_DEF_2x4;\r\nantsel->ant_config[ANT_SELCFG_RX_DEF] = ANT_SELCFG_DEF_2x4;\r\nantsel->ant_config[ANT_SELCFG_RX_UNICAST] = ANT_SELCFG_DEF_2x4;\r\nantsel->num_antcfg = ANT_SELCFG_NUM_2x4;\r\n} else {\r\nantsel->ant_config[ANT_SELCFG_TX_DEF] = ANT_SELCFG_DEF_2x2;\r\nantsel->ant_config[ANT_SELCFG_TX_UNICAST] = ANT_SELCFG_DEF_2x2;\r\nantsel->ant_config[ANT_SELCFG_RX_DEF] = ANT_SELCFG_DEF_2x2;\r\nantsel->ant_config[ANT_SELCFG_RX_UNICAST] = ANT_SELCFG_DEF_2x2;\r\nantsel->num_antcfg = 0;\r\n}\r\n}\r\nstruct antsel_info *brcms_c_antsel_attach(struct brcms_c_info *wlc)\r\n{\r\nstruct antsel_info *asi;\r\nstruct ssb_sprom *sprom = &wlc->hw->d11core->bus->sprom;\r\nasi = kzalloc(sizeof(struct antsel_info), GFP_ATOMIC);\r\nif (!asi)\r\nreturn NULL;\r\nasi->wlc = wlc;\r\nasi->pub = wlc->pub;\r\nasi->antsel_type = ANTSEL_NA;\r\nasi->antsel_avail = false;\r\nasi->antsel_antswitch = sprom->antswitch;\r\nif ((asi->pub->sromrev >= 4) && (asi->antsel_antswitch != 0)) {\r\nswitch (asi->antsel_antswitch) {\r\ncase ANTSWITCH_TYPE_1:\r\ncase ANTSWITCH_TYPE_2:\r\ncase ANTSWITCH_TYPE_3:\r\nasi->antsel_type = ANTSEL_2x3;\r\nif ((sprom->ant_available_bg == 7) ||\r\n(sprom->ant_available_a == 7)) {\r\nasi->antsel_avail = true;\r\n} else if (\r\nsprom->ant_available_bg == 3 ||\r\nsprom->ant_available_a == 3) {\r\nasi->antsel_avail = false;\r\n} else {\r\nasi->antsel_avail = false;\r\nwiphy_err(wlc->wiphy, "antsel_attach: 2o3 "\r\n"board cfg invalid\n");\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n} else if ((asi->pub->sromrev == 4) &&\r\n(sprom->ant_available_bg == 7) &&\r\n(sprom->ant_available_a == 0)) {\r\nasi->antsel_type = ANTSEL_2x3;\r\nasi->antsel_avail = true;\r\n} else if (asi->pub->boardflags2 & BFL2_2X4_DIV) {\r\nasi->antsel_type = ANTSEL_2x4;\r\nasi->antsel_avail = true;\r\n}\r\nbrcms_b_antsel_type_set(wlc->hw, asi->antsel_type);\r\nbrcms_c_antsel_init_cfg(asi, &asi->antcfg_11n, true);\r\nbrcms_c_antsel_init_cfg(asi, &asi->antcfg_cur, true);\r\nreturn asi;\r\n}\r\nvoid brcms_c_antsel_detach(struct antsel_info *asi)\r\n{\r\nkfree(asi);\r\n}\r\nstatic u16 brcms_c_antsel_antcfg2antsel(struct antsel_info *asi, u8 ant_cfg)\r\n{\r\nu8 idx = BRCMS_ANTIDX_11N(BRCMS_ANTSEL_11N(ant_cfg));\r\nu16 mimo_antsel = 0;\r\nif (asi->antsel_type == ANTSEL_2x4) {\r\nmimo_antsel = (mimo_2x4_div_antselpat_tbl[idx] & 0xf);\r\nreturn mimo_antsel;\r\n} else if (asi->antsel_type == ANTSEL_2x3) {\r\nmimo_antsel = (mimo_2x3_div_antselpat_tbl[idx] & 0xf);\r\nreturn mimo_antsel;\r\n}\r\nreturn mimo_antsel;\r\n}\r\nstatic int brcms_c_antsel_cfgupd(struct antsel_info *asi,\r\nstruct brcms_antselcfg *antsel)\r\n{\r\nstruct brcms_c_info *wlc = asi->wlc;\r\nu8 ant_cfg;\r\nu16 mimo_antsel;\r\nant_cfg = antsel->ant_config[ANT_SELCFG_TX_DEF];\r\nmimo_antsel = brcms_c_antsel_antcfg2antsel(asi, ant_cfg);\r\nbrcms_b_write_shm(wlc->hw, M_MIMO_ANTSEL_TXDFLT, mimo_antsel);\r\nasi->antcfg_cur.ant_config[ANT_SELCFG_TX_DEF] = ant_cfg;\r\nant_cfg = antsel->ant_config[ANT_SELCFG_RX_DEF];\r\nmimo_antsel = brcms_c_antsel_antcfg2antsel(asi, ant_cfg);\r\nbrcms_b_write_shm(wlc->hw, M_MIMO_ANTSEL_RXDFLT, mimo_antsel);\r\nasi->antcfg_cur.ant_config[ANT_SELCFG_RX_DEF] = ant_cfg;\r\nreturn 0;\r\n}\r\nvoid brcms_c_antsel_init(struct antsel_info *asi)\r\n{\r\nif ((asi->antsel_type == ANTSEL_2x3) ||\r\n(asi->antsel_type == ANTSEL_2x4))\r\nbrcms_c_antsel_cfgupd(asi, &asi->antcfg_11n);\r\n}\r\nstatic u8 brcms_c_antsel_id2antcfg(struct antsel_info *asi, u8 id)\r\n{\r\nu8 antcfg = ANT_SELCFG_DEF_2x2;\r\nif (asi->antsel_type == ANTSEL_2x4) {\r\nantcfg = (((id & 0x2) << 3) | ((id & 0x1) + 2));\r\nreturn antcfg;\r\n} else if (asi->antsel_type == ANTSEL_2x3) {\r\nantcfg = (((id & 0x02) << 4) | ((id & 0x1) + 1));\r\nreturn antcfg;\r\n}\r\nreturn antcfg;\r\n}\r\nvoid\r\nbrcms_c_antsel_antcfg_get(struct antsel_info *asi, bool usedef, bool sel,\r\nu8 antselid, u8 fbantselid, u8 *antcfg,\r\nu8 *fbantcfg)\r\n{\r\nu8 ant;\r\nif (usedef) {\r\n*antcfg = asi->antcfg_11n.ant_config[ANT_SELCFG_TX_DEF];\r\n*fbantcfg = *antcfg;\r\nreturn;\r\n}\r\nif (!sel) {\r\n*antcfg = asi->antcfg_11n.ant_config[ANT_SELCFG_TX_UNICAST];\r\n*fbantcfg = *antcfg;\r\n} else {\r\nant = asi->antcfg_11n.ant_config[ANT_SELCFG_TX_UNICAST];\r\nif ((ant & ANT_SELCFG_AUTO) == ANT_SELCFG_AUTO) {\r\n*antcfg = brcms_c_antsel_id2antcfg(asi, antselid);\r\n*fbantcfg = brcms_c_antsel_id2antcfg(asi, fbantselid);\r\n} else {\r\n*antcfg =\r\nasi->antcfg_11n.ant_config[ANT_SELCFG_TX_UNICAST];\r\n*fbantcfg = *antcfg;\r\n}\r\n}\r\nreturn;\r\n}\r\nu8 brcms_c_antsel_antsel2id(struct antsel_info *asi, u16 antsel)\r\n{\r\nu8 antselid = 0;\r\nif (asi->antsel_type == ANTSEL_2x4) {\r\nantselid = mimo_2x4_div_antselid_tbl[(antsel & 0xf)];\r\nreturn antselid;\r\n} else if (asi->antsel_type == ANTSEL_2x3) {\r\nantselid = mimo_2x3_div_antselid_tbl[(antsel & 0xf)];\r\nreturn antselid;\r\n}\r\nreturn antselid;\r\n}

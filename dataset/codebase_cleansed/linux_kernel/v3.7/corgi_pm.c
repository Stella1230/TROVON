static void corgi_charger_init(void)\r\n{\r\ngpio_request_array(ARRAY_AND_SIZE(charger_gpios));\r\n}\r\nstatic void corgi_measure_temp(int on)\r\n{\r\ngpio_set_value(CORGI_GPIO_ADC_TEMP_ON, on);\r\n}\r\nstatic void corgi_charge(int on)\r\n{\r\nif (on) {\r\nif (machine_is_corgi() && (sharpsl_pm.flags & SHARPSL_SUSPENDED)) {\r\ngpio_set_value(CORGI_GPIO_CHRG_ON, 0);\r\ngpio_set_value(CORGI_GPIO_CHRG_UKN, 1);\r\n} else {\r\ngpio_set_value(CORGI_GPIO_CHRG_ON, 1);\r\ngpio_set_value(CORGI_GPIO_CHRG_UKN, 0);\r\n}\r\n} else {\r\ngpio_set_value(CORGI_GPIO_CHRG_ON, 0);\r\ngpio_set_value(CORGI_GPIO_CHRG_UKN, 0);\r\n}\r\n}\r\nstatic void corgi_discharge(int on)\r\n{\r\ngpio_set_value(CORGI_GPIO_DISCHARGE_ON, on);\r\n}\r\nstatic void corgi_presuspend(void)\r\n{\r\n}\r\nstatic void corgi_postsuspend(void)\r\n{\r\n}\r\nstatic int corgi_should_wakeup(unsigned int resume_on_alarm)\r\n{\r\nint is_resume = 0;\r\ndev_dbg(sharpsl_pm.dev, "PEDR = %x, GPIO_AC_IN = %d, "\r\n"GPIO_CHRG_FULL = %d, GPIO_KEY_INT = %d, GPIO_WAKEUP = %d\n",\r\nPEDR, gpio_get_value(CORGI_GPIO_AC_IN),\r\ngpio_get_value(CORGI_GPIO_CHRG_FULL),\r\ngpio_get_value(CORGI_GPIO_KEY_INT),\r\ngpio_get_value(CORGI_GPIO_WAKEUP));\r\nif ((PEDR & GPIO_bit(CORGI_GPIO_AC_IN))) {\r\nif (sharpsl_pm.machinfo->read_devdata(SHARPSL_STATUS_ACIN)) {\r\ndev_dbg(sharpsl_pm.dev, "ac insert\n");\r\nsharpsl_pm.flags |= SHARPSL_DO_OFFLINE_CHRG;\r\n} else {\r\ndev_dbg(sharpsl_pm.dev, "ac remove\n");\r\nsharpsl_pm_led(SHARPSL_LED_OFF);\r\nsharpsl_pm.machinfo->charge(0);\r\nsharpsl_pm.charge_mode = CHRG_OFF;\r\n}\r\n}\r\nif ((PEDR & GPIO_bit(CORGI_GPIO_CHRG_FULL)))\r\ndev_dbg(sharpsl_pm.dev, "Charge full interrupt\n");\r\nif (PEDR & GPIO_bit(CORGI_GPIO_KEY_INT))\r\nis_resume |= GPIO_bit(CORGI_GPIO_KEY_INT);\r\nif (PEDR & GPIO_bit(CORGI_GPIO_WAKEUP))\r\nis_resume |= GPIO_bit(CORGI_GPIO_WAKEUP);\r\nif (resume_on_alarm && (PEDR & PWER_RTC))\r\nis_resume |= PWER_RTC;\r\ndev_dbg(sharpsl_pm.dev, "is_resume: %x\n",is_resume);\r\nreturn is_resume;\r\n}\r\nstatic unsigned long corgi_charger_wakeup(void)\r\n{\r\nunsigned long ret;\r\nret = (!gpio_get_value(CORGI_GPIO_AC_IN) << GPIO_bit(CORGI_GPIO_AC_IN))\r\n| (!gpio_get_value(CORGI_GPIO_KEY_INT)\r\n<< GPIO_bit(CORGI_GPIO_KEY_INT))\r\n| (!gpio_get_value(CORGI_GPIO_WAKEUP)\r\n<< GPIO_bit(CORGI_GPIO_WAKEUP));\r\nreturn ret;\r\n}\r\nunsigned long corgipm_read_devdata(int type)\r\n{\r\nswitch(type) {\r\ncase SHARPSL_STATUS_ACIN:\r\nreturn !gpio_get_value(CORGI_GPIO_AC_IN);\r\ncase SHARPSL_STATUS_LOCK:\r\nreturn gpio_get_value(sharpsl_pm.machinfo->gpio_batlock);\r\ncase SHARPSL_STATUS_CHRGFULL:\r\nreturn gpio_get_value(sharpsl_pm.machinfo->gpio_batfull);\r\ncase SHARPSL_STATUS_FATAL:\r\nreturn gpio_get_value(sharpsl_pm.machinfo->gpio_fatal);\r\ncase SHARPSL_ACIN_VOLT:\r\nreturn sharpsl_pm_pxa_read_max1111(MAX1111_ACIN_VOLT);\r\ncase SHARPSL_BATT_TEMP:\r\nreturn sharpsl_pm_pxa_read_max1111(MAX1111_BATT_TEMP);\r\ncase SHARPSL_BATT_VOLT:\r\ndefault:\r\nreturn sharpsl_pm_pxa_read_max1111(MAX1111_BATT_VOLT);\r\n}\r\n}\r\nstatic int __devinit corgipm_init(void)\r\n{\r\nint ret;\r\nif (!machine_is_corgi() && !machine_is_shepherd()\r\n&& !machine_is_husky())\r\nreturn -ENODEV;\r\ncorgipm_device = platform_device_alloc("sharpsl-pm", -1);\r\nif (!corgipm_device)\r\nreturn -ENOMEM;\r\nif (!machine_is_corgi())\r\ncorgi_pm_machinfo.batfull_irq = 1;\r\ncorgipm_device->dev.platform_data = &corgi_pm_machinfo;\r\nret = platform_device_add(corgipm_device);\r\nif (ret)\r\nplatform_device_put(corgipm_device);\r\nreturn ret;\r\n}\r\nstatic void corgipm_exit(void)\r\n{\r\nplatform_device_unregister(corgipm_device);\r\n}

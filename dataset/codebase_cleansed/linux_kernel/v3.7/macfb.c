static int dafb_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nstatic int lastreg = -1;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (regno != lastreg + 1) {\r\nint i;\r\nnubus_writel(0, &dafb_cmap_regs->reset);\r\nnop();\r\nfor (i = 0; i < regno; i++) {\r\nnubus_writeb(info->cmap.red[i] >> 8,\r\n&dafb_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(info->cmap.green[i] >> 8,\r\n&dafb_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(info->cmap.blue[i] >> 8,\r\n&dafb_cmap_regs->lut);\r\nnop();\r\n}\r\n}\r\nnubus_writeb(red, &dafb_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &dafb_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &dafb_cmap_regs->lut);\r\nlocal_irq_restore(flags);\r\nlastreg = regno;\r\nreturn 0;\r\n}\r\nstatic int v8_brazil_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nunsigned int bpp = info->var.bits_per_pixel;\r\nunsigned long flags;\r\nif (bpp > 8)\r\nreturn 1;\r\nlocal_irq_save(flags);\r\nregno = (regno << (8 - bpp)) | (0xFF >> bpp);\r\nnubus_writeb(regno, &v8_brazil_cmap_regs->addr);\r\nnop();\r\nnubus_writeb(red, &v8_brazil_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &v8_brazil_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &v8_brazil_cmap_regs->lut);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int rbv_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nunsigned long flags;\r\nif (info->var.bits_per_pixel > 8)\r\nreturn 1;\r\nlocal_irq_save(flags);\r\nregno += 256 - (1 << info->var.bits_per_pixel);\r\nnubus_writeb(0xFF, &rbv_cmap_regs->cntl);\r\nnop();\r\nnubus_writeb(regno, &rbv_cmap_regs->addr);\r\nnop();\r\nnubus_writeb(red, &rbv_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &rbv_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &rbv_cmap_regs->lut);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int mdc_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nstruct mdc_cmap_regs *cmap_regs = slot_addr;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nnubus_writeb(regno, &cmap_regs->addr);\r\nnop();\r\nnubus_writeb(red, &cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &cmap_regs->lut);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int toby_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nstruct toby_cmap_regs *cmap_regs = slot_addr;\r\nunsigned int bpp = info->var.bits_per_pixel;\r\nunsigned long flags;\r\nred = ~red;\r\ngreen = ~green;\r\nblue = ~blue;\r\nregno = (regno << (8 - bpp)) | (0xFF >> bpp);\r\nlocal_irq_save(flags);\r\nnubus_writeb(regno, &cmap_regs->addr);\r\nnop();\r\nnubus_writeb(red, &cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &cmap_regs->lut);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int jet_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nstruct jet_cmap_regs *cmap_regs = slot_addr;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nnubus_writeb(regno, &cmap_regs->addr);\r\nnop();\r\nnubus_writeb(red, &cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &cmap_regs->lut);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int civic_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nunsigned long flags;\r\nint clut_status;\r\nif (info->var.bits_per_pixel > 8)\r\nreturn 1;\r\nlocal_irq_save(flags);\r\nnubus_writeb(regno, &civic_cmap_regs->addr);\r\nnop();\r\nclut_status = nubus_readb(&civic_cmap_regs->status2);\r\nif ((clut_status & 0x0008) == 0)\r\n{\r\n#if 0\r\nif ((clut_status & 0x000D) != 0)\r\n{\r\nnubus_writeb(0x00, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(0x00, &civic_cmap_regs->lut);\r\nnop();\r\n}\r\n#endif\r\nnubus_writeb(red, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(0x00, &civic_cmap_regs->lut);\r\n}\r\nelse\r\n{\r\nunsigned char junk;\r\njunk = nubus_readb(&civic_cmap_regs->lut);\r\nnop();\r\njunk = nubus_readb(&civic_cmap_regs->lut);\r\nnop();\r\njunk = nubus_readb(&civic_cmap_regs->lut);\r\nnop();\r\njunk = nubus_readb(&civic_cmap_regs->lut);\r\nnop();\r\nif ((clut_status & 0x000D) != 0)\r\n{\r\nnubus_writeb(0x00, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(0x00, &civic_cmap_regs->lut);\r\nnop();\r\n}\r\nnubus_writeb(red, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(green, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(blue, &civic_cmap_regs->lut);\r\nnop();\r\nnubus_writeb(junk, &civic_cmap_regs->lut);\r\n}\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int csc_setpalette(unsigned int regno, unsigned int red,\r\nunsigned int green, unsigned int blue,\r\nstruct fb_info *info)\r\n{\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nudelay(1);\r\nnubus_writeb(regno, &csc_cmap_regs->clut_waddr);\r\nnubus_writeb(red, &csc_cmap_regs->clut_data);\r\nnubus_writeb(green, &csc_cmap_regs->clut_data);\r\nnubus_writeb(blue, &csc_cmap_regs->clut_data);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int macfb_setcolreg(unsigned regno, unsigned red, unsigned green,\r\nunsigned blue, unsigned transp,\r\nstruct fb_info *fb_info)\r\n{\r\nif (regno >= fb_info->cmap.len)\r\nreturn 1;\r\nif (fb_info->var.bits_per_pixel <= 8) {\r\nswitch (fb_info->var.bits_per_pixel) {\r\ncase 1:\r\nbreak;\r\ncase 2:\r\ncase 4:\r\ncase 8:\r\nif (macfb_setpalette)\r\nmacfb_setpalette(regno, red >> 8, green >> 8,\r\nblue >> 8, fb_info);\r\nelse\r\nreturn 1;\r\nbreak;\r\n}\r\n} else if (regno < 16) {\r\nswitch (fb_info->var.bits_per_pixel) {\r\ncase 16:\r\nif (fb_info->var.red.offset == 10) {\r\n((u32*) (fb_info->pseudo_palette))[regno] =\r\n((red & 0xf800) >> 1) |\r\n((green & 0xf800) >> 6) |\r\n((blue & 0xf800) >> 11) |\r\n((transp != 0) << 15);\r\n} else {\r\n((u32*) (fb_info->pseudo_palette))[regno] =\r\n((red & 0xf800) >> 0) |\r\n((green & 0xfc00) >> 5) |\r\n((blue & 0xf800) >> 11);\r\n}\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nred >>= 8;\r\ngreen >>= 8;\r\nblue >>= 8;\r\n((u32 *)(fb_info->pseudo_palette))[regno] =\r\n(red << fb_info->var.red.offset) |\r\n(green << fb_info->var.green.offset) |\r\n(blue << fb_info->var.blue.offset);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void __init macfb_setup(char *options)\r\n{\r\nchar *this_opt;\r\nif (!options || !*options)\r\nreturn;\r\nwhile ((this_opt = strsep(&options, ",")) != NULL) {\r\nif (!*this_opt)\r\ncontinue;\r\nif (!strcmp(this_opt, "inverse"))\r\ninverse = 1;\r\nelse\r\nif (!strcmp(this_opt, "vidtest"))\r\nvidtest = 1;\r\n}\r\n}\r\nstatic void __init iounmap_macfb(void)\r\n{\r\nif (dafb_cmap_regs)\r\niounmap(dafb_cmap_regs);\r\nif (v8_brazil_cmap_regs)\r\niounmap(v8_brazil_cmap_regs);\r\nif (rbv_cmap_regs)\r\niounmap(rbv_cmap_regs);\r\nif (civic_cmap_regs)\r\niounmap(civic_cmap_regs);\r\nif (csc_cmap_regs)\r\niounmap(csc_cmap_regs);\r\n}\r\nstatic int __init macfb_init(void)\r\n{\r\nint video_cmap_len, video_is_nubus = 0;\r\nstruct nubus_dev* ndev = NULL;\r\nchar *option = NULL;\r\nint err;\r\nif (fb_get_options("macfb", &option))\r\nreturn -ENODEV;\r\nmacfb_setup(option);\r\nif (!MACH_IS_MAC)\r\nreturn -ENODEV;\r\nif (mac_bi_data.id == MAC_MODEL_Q630 ||\r\nmac_bi_data.id == MAC_MODEL_P588)\r\nreturn -ENODEV;\r\nmacfb_defined.xres = mac_bi_data.dimensions & 0xFFFF;\r\nmacfb_defined.yres = mac_bi_data.dimensions >> 16;\r\nmacfb_defined.bits_per_pixel = mac_bi_data.videodepth;\r\nmacfb_fix.line_length = mac_bi_data.videorow;\r\nmacfb_fix.smem_len = macfb_fix.line_length * macfb_defined.yres;\r\nmacfb_fix.smem_start = mac_bi_data.videoaddr;\r\nfb_info.screen_base = ioremap(mac_bi_data.videoaddr,\r\nmacfb_fix.smem_len);\r\nif (!fb_info.screen_base)\r\nreturn -ENODEV;\r\npr_info("macfb: framebuffer at 0x%08lx, mapped to 0x%p, size %dk\n",\r\nmacfb_fix.smem_start, fb_info.screen_base,\r\nmacfb_fix.smem_len / 1024);\r\npr_info("macfb: mode is %dx%dx%d, linelength=%d\n",\r\nmacfb_defined.xres, macfb_defined.yres,\r\nmacfb_defined.bits_per_pixel, macfb_fix.line_length);\r\nmacfb_defined.xres_virtual = macfb_defined.xres;\r\nmacfb_defined.yres_virtual = macfb_defined.yres;\r\nmacfb_defined.height = PIXEL_TO_MM(macfb_defined.yres);\r\nmacfb_defined.width = PIXEL_TO_MM(macfb_defined.xres);\r\nmacfb_defined.pixclock = 10000000 / macfb_defined.xres *\r\n1000 / macfb_defined.yres;\r\nmacfb_defined.left_margin = (macfb_defined.xres / 8) & 0xf8;\r\nmacfb_defined.hsync_len = (macfb_defined.xres / 8) & 0xf8;\r\nswitch (macfb_defined.bits_per_pixel) {\r\ncase 1:\r\nmacfb_defined.red.length = macfb_defined.bits_per_pixel;\r\nmacfb_defined.green.length = macfb_defined.bits_per_pixel;\r\nmacfb_defined.blue.length = macfb_defined.bits_per_pixel;\r\nvideo_cmap_len = 2;\r\nmacfb_fix.visual = FB_VISUAL_MONO01;\r\nbreak;\r\ncase 2:\r\ncase 4:\r\ncase 8:\r\nmacfb_defined.red.length = macfb_defined.bits_per_pixel;\r\nmacfb_defined.green.length = macfb_defined.bits_per_pixel;\r\nmacfb_defined.blue.length = macfb_defined.bits_per_pixel;\r\nvideo_cmap_len = 1 << macfb_defined.bits_per_pixel;\r\nmacfb_fix.visual = FB_VISUAL_PSEUDOCOLOR;\r\nbreak;\r\ncase 16:\r\nmacfb_defined.transp.offset = 15;\r\nmacfb_defined.transp.length = 1;\r\nmacfb_defined.red.offset = 10;\r\nmacfb_defined.red.length = 5;\r\nmacfb_defined.green.offset = 5;\r\nmacfb_defined.green.length = 5;\r\nmacfb_defined.blue.offset = 0;\r\nmacfb_defined.blue.length = 5;\r\nvideo_cmap_len = 16;\r\nmacfb_fix.visual = FB_VISUAL_TRUECOLOR;\r\nbreak;\r\ncase 24:\r\ncase 32:\r\nmacfb_defined.red.offset = 16;\r\nmacfb_defined.red.length = 8;\r\nmacfb_defined.green.offset = 8;\r\nmacfb_defined.green.length = 8;\r\nmacfb_defined.blue.offset = 0;\r\nmacfb_defined.blue.length = 8;\r\nvideo_cmap_len = 16;\r\nmacfb_fix.visual = FB_VISUAL_TRUECOLOR;\r\nbreak;\r\ndefault:\r\npr_err("macfb: unknown or unsupported bit depth: %d\n",\r\nmacfb_defined.bits_per_pixel);\r\nerr = -EINVAL;\r\ngoto fail_unmap;\r\n}\r\nwhile ((ndev = nubus_find_type(NUBUS_CAT_DISPLAY,\r\nNUBUS_TYPE_VIDEO, ndev)))\r\n{\r\nunsigned long base = ndev->board->slot_addr;\r\nif (mac_bi_data.videoaddr < base ||\r\nmac_bi_data.videoaddr - base > 0xFFFFFF)\r\ncontinue;\r\nvideo_is_nubus = 1;\r\nslot_addr = (unsigned char *)base;\r\nswitch(ndev->dr_hw) {\r\ncase NUBUS_DRHW_APPLE_MDC:\r\nstrcpy(macfb_fix.id, "Mac Disp. Card");\r\nmacfb_setpalette = mdc_setpalette;\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase NUBUS_DRHW_APPLE_TFB:\r\nstrcpy(macfb_fix.id, "Toby");\r\nmacfb_setpalette = toby_setpalette;\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase NUBUS_DRHW_APPLE_JET:\r\nstrcpy(macfb_fix.id, "Jet");\r\nmacfb_setpalette = jet_setpalette;\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ndefault:\r\nstrcpy(macfb_fix.id, "Generic NuBus");\r\nbreak;\r\n}\r\n}\r\nif (!video_is_nubus)\r\nswitch (mac_bi_data.id) {\r\ncase MAC_MODEL_P475:\r\ncase MAC_MODEL_P475F:\r\ncase MAC_MODEL_P575:\r\ncase MAC_MODEL_Q605:\r\ncase MAC_MODEL_Q800:\r\ncase MAC_MODEL_Q650:\r\ncase MAC_MODEL_Q610:\r\ncase MAC_MODEL_C650:\r\ncase MAC_MODEL_C610:\r\ncase MAC_MODEL_Q700:\r\ncase MAC_MODEL_Q900:\r\ncase MAC_MODEL_Q950:\r\nstrcpy(macfb_fix.id, "DAFB");\r\nmacfb_setpalette = dafb_setpalette;\r\ndafb_cmap_regs = ioremap(DAFB_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase MAC_MODEL_LCII:\r\nstrcpy(macfb_fix.id, "V8");\r\nmacfb_setpalette = v8_brazil_setpalette;\r\nv8_brazil_cmap_regs = ioremap(DAC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase MAC_MODEL_IIVI:\r\ncase MAC_MODEL_IIVX:\r\ncase MAC_MODEL_P600:\r\nstrcpy(macfb_fix.id, "Brazil");\r\nmacfb_setpalette = v8_brazil_setpalette;\r\nv8_brazil_cmap_regs = ioremap(DAC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase MAC_MODEL_LCIII:\r\ncase MAC_MODEL_P520:\r\ncase MAC_MODEL_P550:\r\ncase MAC_MODEL_P460:\r\nstrcpy(macfb_fix.id, "Sonora");\r\nmacfb_setpalette = v8_brazil_setpalette;\r\nv8_brazil_cmap_regs = ioremap(DAC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase MAC_MODEL_IICI:\r\ncase MAC_MODEL_IISI:\r\nstrcpy(macfb_fix.id, "RBV");\r\nmacfb_setpalette = rbv_setpalette;\r\nrbv_cmap_regs = ioremap(DAC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase MAC_MODEL_Q840:\r\ncase MAC_MODEL_C660:\r\nstrcpy(macfb_fix.id, "Civic");\r\nmacfb_setpalette = civic_setpalette;\r\ncivic_cmap_regs = ioremap(CIVIC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ncase MAC_MODEL_LC:\r\nstrcpy(macfb_fix.id, "LC");\r\nif (vidtest) {\r\nmacfb_setpalette = v8_brazil_setpalette;\r\nv8_brazil_cmap_regs =\r\nioremap(DAC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\n}\r\nbreak;\r\ncase MAC_MODEL_CCL:\r\nstrcpy(macfb_fix.id, "Color Classic");\r\nif (vidtest) {\r\nmacfb_setpalette = v8_brazil_setpalette;\r\nv8_brazil_cmap_regs =\r\nioremap(DAC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\n}\r\nbreak;\r\ncase MAC_MODEL_TV:\r\nstrcpy(macfb_fix.id, "Mac TV");\r\nbreak;\r\ncase MAC_MODEL_SE30:\r\ncase MAC_MODEL_CLII:\r\nstrcpy(macfb_fix.id, "Monochrome");\r\nbreak;\r\ncase MAC_MODEL_PB140:\r\ncase MAC_MODEL_PB145:\r\ncase MAC_MODEL_PB170:\r\nstrcpy(macfb_fix.id, "DDC");\r\nbreak;\r\ncase MAC_MODEL_PB150:\r\ncase MAC_MODEL_PB160:\r\ncase MAC_MODEL_PB165:\r\ncase MAC_MODEL_PB180:\r\ncase MAC_MODEL_PB210:\r\ncase MAC_MODEL_PB230:\r\nstrcpy(macfb_fix.id, "GSC");\r\nbreak;\r\ncase MAC_MODEL_PB165C:\r\ncase MAC_MODEL_PB180C:\r\nstrcpy(macfb_fix.id, "TIM");\r\nbreak;\r\ncase MAC_MODEL_PB190:\r\ncase MAC_MODEL_PB520:\r\ncase MAC_MODEL_PB250:\r\ncase MAC_MODEL_PB270C:\r\ncase MAC_MODEL_PB280:\r\ncase MAC_MODEL_PB280C:\r\nstrcpy(macfb_fix.id, "CSC");\r\nmacfb_setpalette = csc_setpalette;\r\ncsc_cmap_regs = ioremap(CSC_BASE, 0x1000);\r\nmacfb_defined.activate = FB_ACTIVATE_NOW;\r\nbreak;\r\ndefault:\r\nstrcpy(macfb_fix.id, "Unknown");\r\nbreak;\r\n}\r\nfb_info.fbops = &macfb_ops;\r\nfb_info.var = macfb_defined;\r\nfb_info.fix = macfb_fix;\r\nfb_info.pseudo_palette = pseudo_palette;\r\nfb_info.flags = FBINFO_DEFAULT;\r\nerr = fb_alloc_cmap(&fb_info.cmap, video_cmap_len, 0);\r\nif (err)\r\ngoto fail_unmap;\r\nerr = register_framebuffer(&fb_info);\r\nif (err)\r\ngoto fail_dealloc;\r\npr_info("fb%d: %s frame buffer device\n",\r\nfb_info.node, fb_info.fix.id);\r\nreturn 0;\r\nfail_dealloc:\r\nfb_dealloc_cmap(&fb_info.cmap);\r\nfail_unmap:\r\niounmap(fb_info.screen_base);\r\niounmap_macfb();\r\nreturn err;\r\n}

static int hwpoison_inject(void *data, u64 val)\r\n{\r\nunsigned long pfn = val;\r\nstruct page *p;\r\nstruct page *hpage;\r\nint err;\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nif (!hwpoison_filter_enable)\r\ngoto inject;\r\nif (!pfn_valid(pfn))\r\nreturn -ENXIO;\r\np = pfn_to_page(pfn);\r\nhpage = compound_head(p);\r\nif (!get_page_unless_zero(hpage))\r\nreturn 0;\r\nif (!PageLRU(p) && !PageHuge(p))\r\nshake_page(p, 0);\r\nif (!PageLRU(p) && !PageHuge(p))\r\nreturn 0;\r\nlock_page(hpage);\r\nerr = hwpoison_filter(hpage);\r\nunlock_page(hpage);\r\nif (err)\r\nreturn 0;\r\ninject:\r\nprintk(KERN_INFO "Injecting memory failure at pfn %lx\n", pfn);\r\nreturn memory_failure(pfn, 18, MF_COUNT_INCREASED);\r\n}\r\nstatic int hwpoison_unpoison(void *data, u64 val)\r\n{\r\nif (!capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nreturn unpoison_memory(val);\r\n}\r\nstatic void pfn_inject_exit(void)\r\n{\r\nif (hwpoison_dir)\r\ndebugfs_remove_recursive(hwpoison_dir);\r\n}\r\nstatic int pfn_inject_init(void)\r\n{\r\nstruct dentry *dentry;\r\nhwpoison_dir = debugfs_create_dir("hwpoison", NULL);\r\nif (hwpoison_dir == NULL)\r\nreturn -ENOMEM;\r\ndentry = debugfs_create_file("corrupt-pfn", 0600, hwpoison_dir,\r\nNULL, &hwpoison_fops);\r\nif (!dentry)\r\ngoto fail;\r\ndentry = debugfs_create_file("unpoison-pfn", 0600, hwpoison_dir,\r\nNULL, &unpoison_fops);\r\nif (!dentry)\r\ngoto fail;\r\ndentry = debugfs_create_u32("corrupt-filter-enable", 0600,\r\nhwpoison_dir, &hwpoison_filter_enable);\r\nif (!dentry)\r\ngoto fail;\r\ndentry = debugfs_create_u32("corrupt-filter-dev-major", 0600,\r\nhwpoison_dir, &hwpoison_filter_dev_major);\r\nif (!dentry)\r\ngoto fail;\r\ndentry = debugfs_create_u32("corrupt-filter-dev-minor", 0600,\r\nhwpoison_dir, &hwpoison_filter_dev_minor);\r\nif (!dentry)\r\ngoto fail;\r\ndentry = debugfs_create_u64("corrupt-filter-flags-mask", 0600,\r\nhwpoison_dir, &hwpoison_filter_flags_mask);\r\nif (!dentry)\r\ngoto fail;\r\ndentry = debugfs_create_u64("corrupt-filter-flags-value", 0600,\r\nhwpoison_dir, &hwpoison_filter_flags_value);\r\nif (!dentry)\r\ngoto fail;\r\n#ifdef CONFIG_MEMCG_SWAP\r\ndentry = debugfs_create_u64("corrupt-filter-memcg", 0600,\r\nhwpoison_dir, &hwpoison_filter_memcg);\r\nif (!dentry)\r\ngoto fail;\r\n#endif\r\nreturn 0;\r\nfail:\r\npfn_inject_exit();\r\nreturn -ENOMEM;\r\n}

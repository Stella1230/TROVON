static void prep_cmdline(void *chosen)\r\n{\r\nif (cmdline[0] == '\0')\r\ngetprop(chosen, "bootargs", cmdline, COMMAND_LINE_SIZE-1);\r\nelse\r\nsetprop_str(chosen, "bootargs", cmdline);\r\nprintf("cmdline: '%s'\n", cmdline);\r\n}\r\nstatic void ps3_console_write(const char *buf, int len)\r\n{\r\n}\r\nstatic void ps3_exit(void)\r\n{\r\nprintf("ps3_exit\n");\r\nlv1_panic(0);\r\nwhile (1);\r\n}\r\nstatic int ps3_repository_read_rm_size(u64 *rm_size)\r\n{\r\nint result;\r\nu64 lpar_id;\r\nu64 ppe_id;\r\nu64 v2;\r\nresult = lv1_get_logical_partition_id(&lpar_id);\r\nif (result)\r\nreturn -1;\r\nresult = lv1_get_logical_ppe_id(&ppe_id);\r\nif (result)\r\nreturn -1;\r\nresult = lv1_get_repository_node_value(lpar_id, 0x0000000062690000ULL,\r\n0x7075000000000000ULL, ppe_id, 0x726d5f73697a6500ULL, rm_size,\r\n&v2);\r\nprintf("%s:%d: ppe_id %lu \n", __func__, __LINE__,\r\n(unsigned long)ppe_id);\r\nprintf("%s:%d: lpar_id %lu \n", __func__, __LINE__,\r\n(unsigned long)lpar_id);\r\nprintf("%s:%d: rm_size %llxh \n", __func__, __LINE__, *rm_size);\r\nreturn result ? -1 : 0;\r\n}\r\nvoid ps3_copy_vectors(void)\r\n{\r\nextern char __system_reset_kernel[];\r\nmemcpy((void *)0x100, __system_reset_kernel, 512);\r\nflush_cache((void *)0x100, 512);\r\n}\r\nvoid platform_init(unsigned long null_check)\r\n{\r\nconst u32 heapsize = 0x1000000 - (u32)_end;\r\nvoid *chosen;\r\nunsigned long ft_addr;\r\nu64 rm_size;\r\nunsigned long val;\r\nconsole_ops.write = ps3_console_write;\r\nplatform_ops.exit = ps3_exit;\r\nprintf("\n-- PS3 bootwrapper --\n");\r\nsimple_alloc_init(_end, heapsize, 32, 64);\r\nfdt_init(_dtb_start);\r\nchosen = finddevice("/chosen");\r\nps3_repository_read_rm_size(&rm_size);\r\ndt_fixup_memory(0, rm_size);\r\nif (_initrd_end > _initrd_start) {\r\nsetprop_val(chosen, "linux,initrd-start", (u32)(_initrd_start));\r\nsetprop_val(chosen, "linux,initrd-end", (u32)(_initrd_end));\r\n}\r\nprep_cmdline(chosen);\r\nft_addr = dt_ops.finalize();\r\nps3_copy_vectors();\r\nprintf(" flat tree at 0x%lx\n\r", ft_addr);\r\nval = *(unsigned long *)0;\r\nif (val != null_check)\r\nprintf("null check failed: %lx != %lx\n\r", val, null_check);\r\n((kernel_entry_t)0)(ft_addr, 0, NULL);\r\nps3_exit();\r\n}

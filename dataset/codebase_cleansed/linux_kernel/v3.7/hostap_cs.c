static inline void hfa384x_outb_debug(struct net_device *dev, int a, u8 v)\r\n{\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nspin_lock_irqsave(&local->lock, flags);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_OUTB, a, v);\r\noutb(v, dev->base_addr + a);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\n}\r\nstatic inline u8 hfa384x_inb_debug(struct net_device *dev, int a)\r\n{\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\nu8 v;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nspin_lock_irqsave(&local->lock, flags);\r\nv = inb(dev->base_addr + a);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_INB, a, v);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\nreturn v;\r\n}\r\nstatic inline void hfa384x_outw_debug(struct net_device *dev, int a, u16 v)\r\n{\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nspin_lock_irqsave(&local->lock, flags);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_OUTW, a, v);\r\noutw(v, dev->base_addr + a);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\n}\r\nstatic inline u16 hfa384x_inw_debug(struct net_device *dev, int a)\r\n{\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\nu16 v;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nspin_lock_irqsave(&local->lock, flags);\r\nv = inw(dev->base_addr + a);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_INW, a, v);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\nreturn v;\r\n}\r\nstatic inline void hfa384x_outsw_debug(struct net_device *dev, int a,\r\nu8 *buf, int wc)\r\n{\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nspin_lock_irqsave(&local->lock, flags);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_OUTSW, a, wc);\r\noutsw(dev->base_addr + a, buf, wc);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\n}\r\nstatic inline void hfa384x_insw_debug(struct net_device *dev, int a,\r\nu8 *buf, int wc)\r\n{\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nunsigned long flags;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nspin_lock_irqsave(&local->lock, flags);\r\nprism2_io_debug_add(dev, PRISM2_IO_DEBUG_CMD_INSW, a, wc);\r\ninsw(dev->base_addr + a, buf, wc);\r\nspin_unlock_irqrestore(&local->lock, flags);\r\n}\r\nstatic int hfa384x_from_bap(struct net_device *dev, u16 bap, void *buf,\r\nint len)\r\n{\r\nu16 d_off;\r\nu16 *pos;\r\nd_off = (bap == 1) ? HFA384X_DATA1_OFF : HFA384X_DATA0_OFF;\r\npos = (u16 *) buf;\r\nif (len / 2)\r\nHFA384X_INSW(d_off, buf, len / 2);\r\npos += len / 2;\r\nif (len & 1)\r\n*((char *) pos) = HFA384X_INB(d_off);\r\nreturn 0;\r\n}\r\nstatic int hfa384x_to_bap(struct net_device *dev, u16 bap, void *buf, int len)\r\n{\r\nu16 d_off;\r\nu16 *pos;\r\nd_off = (bap == 1) ? HFA384X_DATA1_OFF : HFA384X_DATA0_OFF;\r\npos = (u16 *) buf;\r\nif (len / 2)\r\nHFA384X_OUTSW(d_off, buf, len / 2);\r\npos += len / 2;\r\nif (len & 1)\r\nHFA384X_OUTB(*((char *) pos), d_off);\r\nreturn 0;\r\n}\r\nstatic int prism2_pccard_card_present(local_info_t *local)\r\n{\r\nstruct hostap_cs_priv *hw_priv = local->hw_priv;\r\nif (hw_priv != NULL && hw_priv->link != NULL && pcmcia_dev_present(hw_priv->link))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void sandisk_set_iobase(local_info_t *local)\r\n{\r\nint res;\r\nstruct hostap_cs_priv *hw_priv = local->hw_priv;\r\nres = pcmcia_write_config_byte(hw_priv->link, 0x10,\r\nhw_priv->link->resource[0]->start & 0x00ff);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "Prism3 SanDisk - failed to set I/O base 0 -"\r\n" res=%d\n", res);\r\n}\r\nudelay(10);\r\nres = pcmcia_write_config_byte(hw_priv->link, 0x12,\r\n(hw_priv->link->resource[0]->start >> 8) & 0x00ff);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "Prism3 SanDisk - failed to set I/O base 1 -"\r\n" res=%d\n", res);\r\n}\r\n}\r\nstatic void sandisk_write_hcr(local_info_t *local, int hcr)\r\n{\r\nstruct net_device *dev = local->dev;\r\nint i;\r\nHFA384X_OUTB(0x80, SANDISK_WLAN_ACTIVATION_OFF);\r\nudelay(50);\r\nfor (i = 0; i < 10; i++) {\r\nHFA384X_OUTB(hcr, SANDISK_HCR_OFF);\r\n}\r\nudelay(55);\r\nHFA384X_OUTB(0x45, SANDISK_WLAN_ACTIVATION_OFF);\r\n}\r\nstatic int sandisk_enable_wireless(struct net_device *dev)\r\n{\r\nint res, ret = 0;\r\nstruct hostap_interface *iface = netdev_priv(dev);\r\nlocal_info_t *local = iface->local;\r\nstruct hostap_cs_priv *hw_priv = local->hw_priv;\r\nif (resource_size(hw_priv->link->resource[0]) < 0x42) {\r\nret = -ENODEV;\r\ngoto done;\r\n}\r\nif (hw_priv->link->manf_id != 0xd601 || hw_priv->link->card_id != 0x0101) {\r\nret = -ENODEV;\r\ngoto done;\r\n}\r\nif (hw_priv->link->socket->functions < 2) {\r\nret = -ENODEV;\r\ngoto done;\r\n}\r\nprintk(KERN_DEBUG "%s: Multi-function SanDisk ConnectPlus detected"\r\n" - using vendor-specific initialization\n", dev->name);\r\nhw_priv->sandisk_connectplus = 1;\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_COR,\r\nCOR_SOFT_RESET);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "%s: SanDisk - COR sreset failed (%d)\n",\r\ndev->name, res);\r\ngoto done;\r\n}\r\nmdelay(5);\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_COR,\r\n(COR_LEVEL_REQ | 0x8 | COR_ADDR_DECODE |\r\nCOR_FUNC_ENA));\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "%s: SanDisk - COR sreset failed (%d)\n",\r\ndev->name, res);\r\ngoto done;\r\n}\r\nmdelay(5);\r\nsandisk_set_iobase(local);\r\nHFA384X_OUTB(0xc5, SANDISK_WLAN_ACTIVATION_OFF);\r\nudelay(10);\r\nHFA384X_OUTB(0x4b, SANDISK_WLAN_ACTIVATION_OFF);\r\nudelay(10);\r\ndone:\r\nreturn ret;\r\n}\r\nstatic void prism2_pccard_cor_sreset(local_info_t *local)\r\n{\r\nint res;\r\nu8 val;\r\nstruct hostap_cs_priv *hw_priv = local->hw_priv;\r\nif (!prism2_pccard_card_present(local))\r\nreturn;\r\nres = pcmcia_read_config_byte(hw_priv->link, CISREG_COR, &val);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_cor_sreset failed 1 (%d)\n",\r\nres);\r\nreturn;\r\n}\r\nprintk(KERN_DEBUG "prism2_pccard_cor_sreset: original COR %02x\n",\r\nval);\r\nval |= COR_SOFT_RESET;\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_COR, val);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_cor_sreset failed 2 (%d)\n",\r\nres);\r\nreturn;\r\n}\r\nmdelay(hw_priv->sandisk_connectplus ? 5 : 2);\r\nval &= ~COR_SOFT_RESET;\r\nif (hw_priv->sandisk_connectplus)\r\nval |= COR_IREQ_ENA;\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_COR, val);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_cor_sreset failed 3 (%d)\n",\r\nres);\r\nreturn;\r\n}\r\nmdelay(hw_priv->sandisk_connectplus ? 5 : 2);\r\nif (hw_priv->sandisk_connectplus)\r\nsandisk_set_iobase(local);\r\n}\r\nstatic void prism2_pccard_genesis_reset(local_info_t *local, int hcr)\r\n{\r\nint res;\r\nu8 old_cor;\r\nstruct hostap_cs_priv *hw_priv = local->hw_priv;\r\nif (!prism2_pccard_card_present(local))\r\nreturn;\r\nif (hw_priv->sandisk_connectplus) {\r\nsandisk_write_hcr(local, hcr);\r\nreturn;\r\n}\r\nres = pcmcia_read_config_byte(hw_priv->link, CISREG_COR, &old_cor);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_genesis_sreset failed 1 "\r\n"(%d)\n", res);\r\nreturn;\r\n}\r\nprintk(KERN_DEBUG "prism2_pccard_genesis_sreset: original COR %02x\n",\r\nold_cor);\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_COR,\r\nold_cor | COR_SOFT_RESET);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_genesis_sreset failed 2 "\r\n"(%d)\n", res);\r\nreturn;\r\n}\r\nmdelay(10);\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_CCSR, hcr);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_genesis_sreset failed 3 "\r\n"(%d)\n", res);\r\nreturn;\r\n}\r\nmdelay(10);\r\nres = pcmcia_write_config_byte(hw_priv->link, CISREG_COR,\r\nold_cor & ~COR_SOFT_RESET);\r\nif (res != 0) {\r\nprintk(KERN_DEBUG "prism2_pccard_genesis_sreset failed 4 "\r\n"(%d)\n", res);\r\nreturn;\r\n}\r\nmdelay(10);\r\n}\r\nstatic int hostap_cs_probe(struct pcmcia_device *p_dev)\r\n{\r\nint ret;\r\nPDEBUG(DEBUG_HW, "%s: setting Vcc=33 (constant)\n", dev_info);\r\nret = prism2_config(p_dev);\r\nif (ret) {\r\nPDEBUG(DEBUG_EXTRA, "prism2_config() failed\n");\r\n}\r\nreturn ret;\r\n}\r\nstatic void prism2_detach(struct pcmcia_device *link)\r\n{\r\nPDEBUG(DEBUG_FLOW, "prism2_detach\n");\r\nprism2_release((u_long)link);\r\nif (link->priv) {\r\nstruct hostap_cs_priv *hw_priv;\r\nstruct net_device *dev;\r\nstruct hostap_interface *iface;\r\ndev = link->priv;\r\niface = netdev_priv(dev);\r\nhw_priv = iface->local->hw_priv;\r\nprism2_free_local_data(dev);\r\nkfree(hw_priv);\r\n}\r\n}\r\nstatic int prism2_config_check(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\nif (p_dev->config_index == 0)\r\nreturn -EINVAL;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int prism2_config(struct pcmcia_device *link)\r\n{\r\nstruct net_device *dev;\r\nstruct hostap_interface *iface;\r\nlocal_info_t *local;\r\nint ret = 1;\r\nstruct hostap_cs_priv *hw_priv;\r\nunsigned long flags;\r\nPDEBUG(DEBUG_FLOW, "prism2_config()\n");\r\nhw_priv = kzalloc(sizeof(*hw_priv), GFP_KERNEL);\r\nif (hw_priv == NULL) {\r\nret = -ENOMEM;\r\ngoto failed;\r\n}\r\nlink->config_flags |= CONF_AUTO_SET_VPP | CONF_AUTO_AUDIO |\r\nCONF_AUTO_CHECK_VCC | CONF_AUTO_SET_IO | CONF_ENABLE_IRQ;\r\nif (ignore_cis_vcc)\r\nlink->config_flags &= ~CONF_AUTO_CHECK_VCC;\r\nret = pcmcia_loop_config(link, prism2_config_check, NULL);\r\nif (ret) {\r\nif (!ignore_cis_vcc)\r\nprintk(KERN_ERR "GetNextTuple(): No matching "\r\n"CIS configuration. Maybe you need the "\r\n"ignore_cis_vcc=1 parameter.\n");\r\ngoto failed;\r\n}\r\ndev = prism2_init_local_data(&prism2_pccard_funcs, 0,\r\n&link->dev);\r\nif (dev == NULL)\r\ngoto failed;\r\nlink->priv = dev;\r\niface = netdev_priv(dev);\r\nlocal = iface->local;\r\nlocal->hw_priv = hw_priv;\r\nhw_priv->link = link;\r\nret = pcmcia_request_irq(link, prism2_interrupt);\r\nif (ret)\r\ngoto failed;\r\nret = pcmcia_enable_device(link);\r\nif (ret)\r\ngoto failed;\r\nspin_lock_irqsave(&local->irq_init_lock, flags);\r\ndev->irq = link->irq;\r\ndev->base_addr = link->resource[0]->start;\r\nspin_unlock_irqrestore(&local->irq_init_lock, flags);\r\nlocal->shutdown = 0;\r\nsandisk_enable_wireless(dev);\r\nret = prism2_hw_config(dev, 1);\r\nif (!ret)\r\nret = hostap_hw_ready(dev);\r\nreturn ret;\r\nfailed:\r\nkfree(hw_priv);\r\nprism2_release((u_long)link);\r\nreturn ret;\r\n}\r\nstatic void prism2_release(u_long arg)\r\n{\r\nstruct pcmcia_device *link = (struct pcmcia_device *)arg;\r\nPDEBUG(DEBUG_FLOW, "prism2_release\n");\r\nif (link->priv) {\r\nstruct net_device *dev = link->priv;\r\nstruct hostap_interface *iface;\r\niface = netdev_priv(dev);\r\nprism2_hw_shutdown(dev, 0);\r\niface->local->shutdown = 1;\r\n}\r\npcmcia_disable_device(link);\r\nPDEBUG(DEBUG_FLOW, "release - done\n");\r\n}\r\nstatic int hostap_cs_suspend(struct pcmcia_device *link)\r\n{\r\nstruct net_device *dev = (struct net_device *) link->priv;\r\nint dev_open = 0;\r\nstruct hostap_interface *iface = NULL;\r\nif (!dev)\r\nreturn -ENODEV;\r\niface = netdev_priv(dev);\r\nPDEBUG(DEBUG_EXTRA, "%s: CS_EVENT_PM_SUSPEND\n", dev_info);\r\nif (iface && iface->local)\r\ndev_open = iface->local->num_dev_open > 0;\r\nif (dev_open) {\r\nnetif_stop_queue(dev);\r\nnetif_device_detach(dev);\r\n}\r\nprism2_suspend(dev);\r\nreturn 0;\r\n}\r\nstatic int hostap_cs_resume(struct pcmcia_device *link)\r\n{\r\nstruct net_device *dev = (struct net_device *) link->priv;\r\nint dev_open = 0;\r\nstruct hostap_interface *iface = NULL;\r\nif (!dev)\r\nreturn -ENODEV;\r\niface = netdev_priv(dev);\r\nPDEBUG(DEBUG_EXTRA, "%s: CS_EVENT_PM_RESUME\n", dev_info);\r\nif (iface && iface->local)\r\ndev_open = iface->local->num_dev_open > 0;\r\nprism2_hw_shutdown(dev, 1);\r\nprism2_hw_config(dev, dev_open ? 0 : 1);\r\nif (dev_open) {\r\nnetif_device_attach(dev);\r\nnetif_start_queue(dev);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init init_prism2_pccard(void)\r\n{\r\nreturn pcmcia_register_driver(&hostap_driver);\r\n}\r\nstatic void __exit exit_prism2_pccard(void)\r\n{\r\npcmcia_unregister_driver(&hostap_driver);\r\n}

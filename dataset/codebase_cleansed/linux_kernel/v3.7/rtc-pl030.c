static irqreturn_t pl030_interrupt(int irq, void *dev_id)\r\n{\r\nstruct pl030_rtc *rtc = dev_id;\r\nwritel(0, rtc->base + RTC_EOI);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int pl030_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct pl030_rtc *rtc = dev_get_drvdata(dev);\r\nrtc_time_to_tm(readl(rtc->base + RTC_MR), &alrm->time);\r\nreturn 0;\r\n}\r\nstatic int pl030_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct pl030_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long time;\r\nint ret;\r\nret = rtc_valid_tm(&alrm->time);\r\nif (ret == 0)\r\nret = rtc_tm_to_time(&alrm->time, &time);\r\nif (ret == 0)\r\nwritel(time, rtc->base + RTC_MR);\r\nreturn ret;\r\n}\r\nstatic int pl030_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct pl030_rtc *rtc = dev_get_drvdata(dev);\r\nrtc_time_to_tm(readl(rtc->base + RTC_DR), tm);\r\nreturn 0;\r\n}\r\nstatic int pl030_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct pl030_rtc *rtc = dev_get_drvdata(dev);\r\nunsigned long time;\r\nint ret;\r\nret = rtc_tm_to_time(tm, &time);\r\nif (ret == 0)\r\nwritel(time + 1, rtc->base + RTC_LR);\r\nreturn ret;\r\n}\r\nstatic int pl030_probe(struct amba_device *dev, const struct amba_id *id)\r\n{\r\nstruct pl030_rtc *rtc;\r\nint ret;\r\nret = amba_request_regions(dev, NULL);\r\nif (ret)\r\ngoto err_req;\r\nrtc = kmalloc(sizeof(*rtc), GFP_KERNEL);\r\nif (!rtc) {\r\nret = -ENOMEM;\r\ngoto err_rtc;\r\n}\r\nrtc->base = ioremap(dev->res.start, resource_size(&dev->res));\r\nif (!rtc->base) {\r\nret = -ENOMEM;\r\ngoto err_map;\r\n}\r\n__raw_writel(0, rtc->base + RTC_CR);\r\n__raw_writel(0, rtc->base + RTC_EOI);\r\namba_set_drvdata(dev, rtc);\r\nret = request_irq(dev->irq[0], pl030_interrupt, 0,\r\n"rtc-pl030", rtc);\r\nif (ret)\r\ngoto err_irq;\r\nrtc->rtc = rtc_device_register("pl030", &dev->dev, &pl030_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(rtc->rtc)) {\r\nret = PTR_ERR(rtc->rtc);\r\ngoto err_reg;\r\n}\r\nreturn 0;\r\nerr_reg:\r\nfree_irq(dev->irq[0], rtc);\r\nerr_irq:\r\niounmap(rtc->base);\r\nerr_map:\r\nkfree(rtc);\r\nerr_rtc:\r\namba_release_regions(dev);\r\nerr_req:\r\nreturn ret;\r\n}\r\nstatic int pl030_remove(struct amba_device *dev)\r\n{\r\nstruct pl030_rtc *rtc = amba_get_drvdata(dev);\r\namba_set_drvdata(dev, NULL);\r\nwritel(0, rtc->base + RTC_CR);\r\nfree_irq(dev->irq[0], rtc);\r\nrtc_device_unregister(rtc->rtc);\r\niounmap(rtc->base);\r\nkfree(rtc);\r\namba_release_regions(dev);\r\nreturn 0;\r\n}

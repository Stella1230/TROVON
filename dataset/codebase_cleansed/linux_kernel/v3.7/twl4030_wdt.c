static int twl4030_wdt_write(unsigned char val)\r\n{\r\nreturn twl_i2c_write_u8(TWL4030_MODULE_PM_RECEIVER, val,\r\nTWL4030_WATCHDOG_CFG_REG_OFFS);\r\n}\r\nstatic int twl4030_wdt_enable(struct twl4030_wdt *wdt)\r\n{\r\nreturn twl4030_wdt_write(wdt->timer_margin + 1);\r\n}\r\nstatic int twl4030_wdt_disable(struct twl4030_wdt *wdt)\r\n{\r\nreturn twl4030_wdt_write(0);\r\n}\r\nstatic int twl4030_wdt_set_timeout(struct twl4030_wdt *wdt, int timeout)\r\n{\r\nif (timeout < 0 || timeout > 30) {\r\ndev_warn(wdt->miscdev.parent,\r\n"Timeout can only be in the range [0-30] seconds");\r\nreturn -EINVAL;\r\n}\r\nwdt->timer_margin = timeout;\r\nreturn twl4030_wdt_enable(wdt);\r\n}\r\nstatic ssize_t twl4030_wdt_write_fop(struct file *file,\r\nconst char __user *data, size_t len, loff_t *ppos)\r\n{\r\nstruct twl4030_wdt *wdt = file->private_data;\r\nif (len)\r\ntwl4030_wdt_enable(wdt);\r\nreturn len;\r\n}\r\nstatic long twl4030_wdt_ioctl(struct file *file,\r\nunsigned int cmd, unsigned long arg)\r\n{\r\nvoid __user *argp = (void __user *)arg;\r\nint __user *p = argp;\r\nint new_margin;\r\nstruct twl4030_wdt *wdt = file->private_data;\r\nstatic const struct watchdog_info twl4030_wd_ident = {\r\n.identity = "TWL4030 Watchdog",\r\n.options = WDIOF_SETTIMEOUT,\r\n.firmware_version = 0,\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nreturn copy_to_user(argp, &twl4030_wd_ident,\r\nsizeof(twl4030_wd_ident)) ? -EFAULT : 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, p);\r\ncase WDIOC_KEEPALIVE:\r\ntwl4030_wdt_enable(wdt);\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nif (get_user(new_margin, p))\r\nreturn -EFAULT;\r\nif (twl4030_wdt_set_timeout(wdt, new_margin))\r\nreturn -EINVAL;\r\nreturn put_user(wdt->timer_margin, p);\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(wdt->timer_margin, p);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\nreturn 0;\r\n}\r\nstatic int twl4030_wdt_open(struct inode *inode, struct file *file)\r\n{\r\nstruct twl4030_wdt *wdt = platform_get_drvdata(twl4030_wdt_dev);\r\nif (test_and_set_bit(0, &wdt->state))\r\nreturn -EBUSY;\r\nwdt->state |= TWL4030_WDT_STATE_ACTIVE;\r\nfile->private_data = (void *) wdt;\r\ntwl4030_wdt_enable(wdt);\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int twl4030_wdt_release(struct inode *inode, struct file *file)\r\n{\r\nstruct twl4030_wdt *wdt = file->private_data;\r\nif (nowayout) {\r\ndev_alert(wdt->miscdev.parent,\r\n"Unexpected close, watchdog still running!\n");\r\ntwl4030_wdt_enable(wdt);\r\n} else {\r\nif (twl4030_wdt_disable(wdt))\r\nreturn -EFAULT;\r\nwdt->state &= ~TWL4030_WDT_STATE_ACTIVE;\r\n}\r\nclear_bit(0, &wdt->state);\r\nreturn 0;\r\n}\r\nstatic int __devinit twl4030_wdt_probe(struct platform_device *pdev)\r\n{\r\nint ret = 0;\r\nstruct twl4030_wdt *wdt;\r\nwdt = kzalloc(sizeof(struct twl4030_wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nwdt->state = 0;\r\nwdt->timer_margin = 30;\r\nwdt->miscdev.parent = &pdev->dev;\r\nwdt->miscdev.fops = &twl4030_wdt_fops;\r\nwdt->miscdev.minor = WATCHDOG_MINOR;\r\nwdt->miscdev.name = "watchdog";\r\nplatform_set_drvdata(pdev, wdt);\r\ntwl4030_wdt_dev = pdev;\r\ntwl4030_wdt_disable(wdt);\r\nret = misc_register(&wdt->miscdev);\r\nif (ret) {\r\ndev_err(wdt->miscdev.parent,\r\n"Failed to register misc device\n");\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(wdt);\r\ntwl4030_wdt_dev = NULL;\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devexit twl4030_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct twl4030_wdt *wdt = platform_get_drvdata(pdev);\r\nif (wdt->state & TWL4030_WDT_STATE_ACTIVE)\r\nif (twl4030_wdt_disable(wdt))\r\nreturn -EFAULT;\r\nwdt->state &= ~TWL4030_WDT_STATE_ACTIVE;\r\nmisc_deregister(&wdt->miscdev);\r\nplatform_set_drvdata(pdev, NULL);\r\nkfree(wdt);\r\ntwl4030_wdt_dev = NULL;\r\nreturn 0;\r\n}\r\nstatic int twl4030_wdt_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct twl4030_wdt *wdt = platform_get_drvdata(pdev);\r\nif (wdt->state & TWL4030_WDT_STATE_ACTIVE)\r\nreturn twl4030_wdt_disable(wdt);\r\nreturn 0;\r\n}\r\nstatic int twl4030_wdt_resume(struct platform_device *pdev)\r\n{\r\nstruct twl4030_wdt *wdt = platform_get_drvdata(pdev);\r\nif (wdt->state & TWL4030_WDT_STATE_ACTIVE)\r\nreturn twl4030_wdt_enable(wdt);\r\nreturn 0;\r\n}

int of_get_dma_window(struct device_node *dn, const char *prefix, int index,\r\nunsigned long *busno, dma_addr_t *addr, size_t *size)\r\n{\r\nconst __be32 *dma_window, *end;\r\nint bytes, cur_index = 0;\r\nchar propname[NAME_MAX], addrname[NAME_MAX], sizename[NAME_MAX];\r\nif (!dn || !addr || !size)\r\nreturn -EINVAL;\r\nif (!prefix)\r\nprefix = "";\r\nsnprintf(propname, sizeof(propname), "%sdma-window", prefix);\r\nsnprintf(addrname, sizeof(addrname), "%s#dma-address-cells", prefix);\r\nsnprintf(sizename, sizeof(sizename), "%s#dma-size-cells", prefix);\r\ndma_window = of_get_property(dn, propname, &bytes);\r\nif (!dma_window)\r\nreturn -ENODEV;\r\nend = dma_window + bytes / sizeof(*dma_window);\r\nwhile (dma_window < end) {\r\nu32 cells;\r\nconst void *prop;\r\nif (busno)\r\n*busno = be32_to_cpup(dma_window++);\r\nprop = of_get_property(dn, addrname, NULL);\r\nif (!prop)\r\nprop = of_get_property(dn, "#address-cells", NULL);\r\ncells = prop ? be32_to_cpup(prop) : of_n_addr_cells(dn);\r\nif (!cells)\r\nreturn -EINVAL;\r\n*addr = of_read_number(dma_window, cells);\r\ndma_window += cells;\r\nprop = of_get_property(dn, sizename, NULL);\r\ncells = prop ? be32_to_cpup(prop) : of_n_size_cells(dn);\r\nif (!cells)\r\nreturn -EINVAL;\r\n*size = of_read_number(dma_window, cells);\r\ndma_window += cells;\r\nif (cur_index++ == index)\r\nbreak;\r\n}\r\nreturn 0;\r\n}

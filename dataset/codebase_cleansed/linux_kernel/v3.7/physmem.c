int __init init_maps(unsigned long physmem, unsigned long iomem,\r\nunsigned long highmem)\r\n{\r\nstruct page *p, *map;\r\nunsigned long phys_len, phys_pages, highmem_len, highmem_pages;\r\nunsigned long iomem_len, iomem_pages, total_len, total_pages;\r\nint i;\r\nphys_pages = physmem >> PAGE_SHIFT;\r\nphys_len = phys_pages * sizeof(struct page);\r\niomem_pages = iomem >> PAGE_SHIFT;\r\niomem_len = iomem_pages * sizeof(struct page);\r\nhighmem_pages = highmem >> PAGE_SHIFT;\r\nhighmem_len = highmem_pages * sizeof(struct page);\r\ntotal_pages = phys_pages + iomem_pages + highmem_pages;\r\ntotal_len = phys_len + iomem_len + highmem_len;\r\nmap = alloc_bootmem_low_pages(total_len);\r\nif (map == NULL)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < total_pages; i++) {\r\np = &map[i];\r\nmemset(p, 0, sizeof(struct page));\r\nSetPageReserved(p);\r\nINIT_LIST_HEAD(&p->lru);\r\n}\r\nmax_mapnr = total_pages;\r\nreturn 0;\r\n}\r\nvoid map_memory(unsigned long virt, unsigned long phys, unsigned long len,\r\nint r, int w, int x)\r\n{\r\n__u64 offset;\r\nint fd, err;\r\nfd = phys_mapping(phys, &offset);\r\nerr = os_map_memory((void *) virt, fd, offset, len, r, w, x);\r\nif (err) {\r\nif (err == -ENOMEM)\r\nprintk(KERN_ERR "try increasing the host's "\r\n"/proc/sys/vm/max_map_count to <physical "\r\n"memory size>/4096\n");\r\npanic("map_memory(0x%lx, %d, 0x%llx, %ld, %d, %d, %d) failed, "\r\n"err = %d\n", virt, fd, offset, len, r, w, x, err);\r\n}\r\n}\r\nvoid __init setup_physmem(unsigned long start, unsigned long reserve_end,\r\nunsigned long len, unsigned long long highmem)\r\n{\r\nunsigned long reserve = reserve_end - start;\r\nint pfn = PFN_UP(__pa(reserve_end));\r\nint delta = (len - reserve) >> PAGE_SHIFT;\r\nint err, offset, bootmap_size;\r\nphysmem_fd = create_mem_file(len + highmem);\r\noffset = uml_reserved - uml_physmem;\r\nerr = os_map_memory((void *) uml_reserved, physmem_fd, offset,\r\nlen - offset, 1, 1, 1);\r\nif (err < 0) {\r\nprintf("setup_physmem - mapping %ld bytes of memory at 0x%p "\r\n"failed - errno = %d\n", len - offset,\r\n(void *) uml_reserved, err);\r\nexit(1);\r\n}\r\nos_seek_file(physmem_fd, __pa(&__syscall_stub_start));\r\nos_write_file(physmem_fd, &__syscall_stub_start, PAGE_SIZE);\r\nbootmap_size = init_bootmem(pfn, pfn + delta);\r\nfree_bootmem(__pa(reserve_end) + bootmap_size,\r\nlen - bootmap_size - reserve);\r\n}\r\nint phys_mapping(unsigned long phys, unsigned long long *offset_out)\r\n{\r\nint fd = -1;\r\nif (phys < physmem_size) {\r\nfd = physmem_fd;\r\n*offset_out = phys;\r\n}\r\nelse if (phys < __pa(end_iomem)) {\r\nstruct iomem_region *region = iomem_regions;\r\nwhile (region != NULL) {\r\nif ((phys >= region->phys) &&\r\n(phys < region->phys + region->size)) {\r\nfd = region->fd;\r\n*offset_out = phys - region->phys;\r\nbreak;\r\n}\r\nregion = region->next;\r\n}\r\n}\r\nelse if (phys < __pa(end_iomem) + highmem) {\r\nfd = physmem_fd;\r\n*offset_out = phys - iomem_size;\r\n}\r\nreturn fd;\r\n}\r\nstatic int __init uml_mem_setup(char *line, int *add)\r\n{\r\nchar *retptr;\r\nphysmem_size = memparse(line,&retptr);\r\nreturn 0;\r\n}\r\nunsigned long find_iomem(char *driver, unsigned long *len_out)\r\n{\r\nstruct iomem_region *region = iomem_regions;\r\nwhile (region != NULL) {\r\nif (!strcmp(region->driver, driver)) {\r\n*len_out = region->size;\r\nreturn region->virt;\r\n}\r\nregion = region->next;\r\n}\r\nreturn 0;\r\n}\r\nstatic int setup_iomem(void)\r\n{\r\nstruct iomem_region *region = iomem_regions;\r\nunsigned long iomem_start = high_physmem + PAGE_SIZE;\r\nint err;\r\nwhile (region != NULL) {\r\nerr = os_map_memory((void *) iomem_start, region->fd, 0,\r\nregion->size, 1, 1, 0);\r\nif (err)\r\nprintk(KERN_ERR "Mapping iomem region for driver '%s' "\r\n"failed, errno = %d\n", region->driver, -err);\r\nelse {\r\nregion->virt = iomem_start;\r\nregion->phys = __pa(region->virt);\r\n}\r\niomem_start += region->size + PAGE_SIZE;\r\nregion = region->next;\r\n}\r\nreturn 0;\r\n}

static void __init register_alix(void)\r\n{\r\nplatform_add_devices(alix_devs, ARRAY_SIZE(alix_devs));\r\n}\r\nstatic bool __init alix_present(unsigned long bios_phys,\r\nconst char *alix_sig,\r\nsize_t alix_sig_len)\r\n{\r\nconst size_t bios_len = BIOS_REGION_SIZE;\r\nconst char *bios_virt;\r\nconst char *scan_end;\r\nconst char *p;\r\nchar name[64];\r\nif (force) {\r\nprintk(KERN_NOTICE "%s: forced to skip BIOS test, "\r\n"assume system is ALIX.2/ALIX.3\n",\r\nKBUILD_MODNAME);\r\nreturn true;\r\n}\r\nbios_virt = phys_to_virt(bios_phys);\r\nscan_end = bios_virt + bios_len - (alix_sig_len + 2);\r\nfor (p = bios_virt; p < scan_end; p++) {\r\nconst char *tail;\r\nchar *a;\r\nif (memcmp(p, alix_sig, alix_sig_len) != 0)\r\ncontinue;\r\nmemcpy(name, p, sizeof(name));\r\na = strchr(name, '\0');\r\nif (a)\r\n*a = ' ';\r\na = strchr(name, '\r');\r\nif (a)\r\n*a = '\0';\r\ntail = p + alix_sig_len;\r\nif ((tail[0] == '2' || tail[0] == '3' || tail[0] == '6')) {\r\nprintk(KERN_INFO\r\n"%s: system is recognized as \"%s\"\n",\r\nKBUILD_MODNAME, name);\r\nreturn true;\r\n}\r\n}\r\nreturn false;\r\n}\r\nstatic bool __init alix_present_dmi(void)\r\n{\r\nconst char *vendor, *product;\r\nvendor = dmi_get_system_info(DMI_SYS_VENDOR);\r\nif (!vendor || strcmp(vendor, "PC Engines"))\r\nreturn false;\r\nproduct = dmi_get_system_info(DMI_PRODUCT_NAME);\r\nif (!product || (strcmp(product, "ALIX.2D") && strcmp(product, "ALIX.6")))\r\nreturn false;\r\nprintk(KERN_INFO "%s: system is recognized as \"%s %s\"\n",\r\nKBUILD_MODNAME, vendor, product);\r\nreturn true;\r\n}\r\nstatic int __init alix_init(void)\r\n{\r\nconst char tinybios_sig[] = "PC Engines ALIX.";\r\nconst char coreboot_sig[] = "PC Engines\0ALIX.";\r\nif (!is_geode())\r\nreturn 0;\r\nif (alix_present(BIOS_SIGNATURE_TINYBIOS, tinybios_sig, sizeof(tinybios_sig) - 1) ||\r\nalix_present(BIOS_SIGNATURE_COREBOOT, coreboot_sig, sizeof(coreboot_sig) - 1) ||\r\nalix_present_dmi())\r\nregister_alix();\r\nreturn 0;\r\n}

void snd_pcm_timer_resolution_change(struct snd_pcm_substream *substream)\r\n{\r\nunsigned long rate, mult, fsize, l, post;\r\nstruct snd_pcm_runtime *runtime = substream->runtime;\r\nmult = 1000000000;\r\nrate = runtime->rate;\r\nif (snd_BUG_ON(!rate))\r\nreturn;\r\nl = gcd(mult, rate);\r\nmult /= l;\r\nrate /= l;\r\nfsize = runtime->period_size;\r\nif (snd_BUG_ON(!fsize))\r\nreturn;\r\nl = gcd(rate, fsize);\r\nrate /= l;\r\nfsize /= l;\r\npost = 1;\r\nwhile ((mult * fsize) / fsize != mult) {\r\nmult /= 2;\r\npost *= 2;\r\n}\r\nif (rate == 0) {\r\nsnd_printk(KERN_ERR "pcm timer resolution out of range (rate = %u, period_size = %lu)\n", runtime->rate, runtime->period_size);\r\nruntime->timer_resolution = -1;\r\nreturn;\r\n}\r\nruntime->timer_resolution = (mult * fsize / rate) * post;\r\n}\r\nstatic unsigned long snd_pcm_timer_resolution(struct snd_timer * timer)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nsubstream = timer->private_data;\r\nreturn substream->runtime ? substream->runtime->timer_resolution : 0;\r\n}\r\nstatic int snd_pcm_timer_start(struct snd_timer * timer)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nsubstream = snd_timer_chip(timer);\r\nsubstream->timer_running = 1;\r\nreturn 0;\r\n}\r\nstatic int snd_pcm_timer_stop(struct snd_timer * timer)\r\n{\r\nstruct snd_pcm_substream *substream;\r\nsubstream = snd_timer_chip(timer);\r\nsubstream->timer_running = 0;\r\nreturn 0;\r\n}\r\nstatic void snd_pcm_timer_free(struct snd_timer *timer)\r\n{\r\nstruct snd_pcm_substream *substream = timer->private_data;\r\nsubstream->timer = NULL;\r\n}\r\nvoid snd_pcm_timer_init(struct snd_pcm_substream *substream)\r\n{\r\nstruct snd_timer_id tid;\r\nstruct snd_timer *timer;\r\ntid.dev_sclass = SNDRV_TIMER_SCLASS_NONE;\r\ntid.dev_class = SNDRV_TIMER_CLASS_PCM;\r\ntid.card = substream->pcm->card->number;\r\ntid.device = substream->pcm->device;\r\ntid.subdevice = (substream->number << 1) | (substream->stream & 1);\r\nif (snd_timer_new(substream->pcm->card, "PCM", &tid, &timer) < 0)\r\nreturn;\r\nsprintf(timer->name, "PCM %s %i-%i-%i",\r\nsubstream->stream == SNDRV_PCM_STREAM_CAPTURE ?\r\n"capture" : "playback",\r\ntid.card, tid.device, tid.subdevice);\r\ntimer->hw = snd_pcm_timer;\r\nif (snd_device_register(timer->card, timer) < 0) {\r\nsnd_device_free(timer->card, timer);\r\nreturn;\r\n}\r\ntimer->private_data = substream;\r\ntimer->private_free = snd_pcm_timer_free;\r\nsubstream->timer = timer;\r\n}\r\nvoid snd_pcm_timer_done(struct snd_pcm_substream *substream)\r\n{\r\nif (substream->timer) {\r\nsnd_device_free(substream->pcm->card, substream->timer);\r\nsubstream->timer = NULL;\r\n}\r\n}

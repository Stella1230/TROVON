static inline bool ar724x_pci_check_link(void)\r\n{\r\nu32 reset;\r\nreset = __raw_readl(ar724x_pci_ctrl_base + AR724X_PCI_REG_RESET);\r\nreturn reset & AR724X_PCI_RESET_LINK_UP;\r\n}\r\nstatic int ar724x_pci_read(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, uint32_t *value)\r\n{\r\nunsigned long flags;\r\nvoid __iomem *base;\r\nu32 data;\r\nif (!ar724x_pci_link_up)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (devfn)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nbase = ar724x_pci_devcfg_base;\r\nspin_lock_irqsave(&ar724x_pci_lock, flags);\r\ndata = __raw_readl(base + (where & ~3));\r\nswitch (size) {\r\ncase 1:\r\nif (where & 1)\r\ndata >>= 8;\r\nif (where & 2)\r\ndata >>= 16;\r\ndata &= 0xff;\r\nbreak;\r\ncase 2:\r\nif (where & 2)\r\ndata >>= 16;\r\ndata &= 0xffff;\r\nbreak;\r\ncase 4:\r\nbreak;\r\ndefault:\r\nspin_unlock_irqrestore(&ar724x_pci_lock, flags);\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\n}\r\nspin_unlock_irqrestore(&ar724x_pci_lock, flags);\r\nif (where == PCI_BASE_ADDRESS_0 && size == 4 &&\r\nar724x_pci_bar0_is_cached) {\r\n*value = ar724x_pci_bar0_value;\r\n} else {\r\n*value = data;\r\n}\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int ar724x_pci_write(struct pci_bus *bus, unsigned int devfn, int where,\r\nint size, uint32_t value)\r\n{\r\nunsigned long flags;\r\nvoid __iomem *base;\r\nu32 data;\r\nint s;\r\nif (!ar724x_pci_link_up)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (devfn)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\nif (soc_is_ar7240() && where == PCI_BASE_ADDRESS_0 && size == 4) {\r\nif (value != 0xffffffff) {\r\nar724x_pci_bar0_is_cached = true;\r\nar724x_pci_bar0_value = value;\r\nvalue = AR7240_BAR0_WAR_VALUE;\r\n} else {\r\nar724x_pci_bar0_is_cached = false;\r\n}\r\n}\r\nbase = ar724x_pci_devcfg_base;\r\nspin_lock_irqsave(&ar724x_pci_lock, flags);\r\ndata = __raw_readl(base + (where & ~3));\r\nswitch (size) {\r\ncase 1:\r\ns = ((where & 3) * 8);\r\ndata &= ~(0xff << s);\r\ndata |= ((value & 0xff) << s);\r\nbreak;\r\ncase 2:\r\ns = ((where & 2) * 8);\r\ndata &= ~(0xffff << s);\r\ndata |= ((value & 0xffff) << s);\r\nbreak;\r\ncase 4:\r\ndata = value;\r\nbreak;\r\ndefault:\r\nspin_unlock_irqrestore(&ar724x_pci_lock, flags);\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\n}\r\n__raw_writel(data, base + (where & ~3));\r\n__raw_readl(base + (where & ~3));\r\nspin_unlock_irqrestore(&ar724x_pci_lock, flags);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic void ar724x_pci_irq_handler(unsigned int irq, struct irq_desc *desc)\r\n{\r\nvoid __iomem *base;\r\nu32 pending;\r\nbase = ar724x_pci_ctrl_base;\r\npending = __raw_readl(base + AR724X_PCI_REG_INT_STATUS) &\r\n__raw_readl(base + AR724X_PCI_REG_INT_MASK);\r\nif (pending & AR724X_PCI_INT_DEV0)\r\ngeneric_handle_irq(ATH79_PCI_IRQ(0));\r\nelse\r\nspurious_interrupt();\r\n}\r\nstatic void ar724x_pci_irq_unmask(struct irq_data *d)\r\n{\r\nvoid __iomem *base;\r\nu32 t;\r\nbase = ar724x_pci_ctrl_base;\r\nswitch (d->irq) {\r\ncase ATH79_PCI_IRQ(0):\r\nt = __raw_readl(base + AR724X_PCI_REG_INT_MASK);\r\n__raw_writel(t | AR724X_PCI_INT_DEV0,\r\nbase + AR724X_PCI_REG_INT_MASK);\r\n__raw_readl(base + AR724X_PCI_REG_INT_MASK);\r\n}\r\n}\r\nstatic void ar724x_pci_irq_mask(struct irq_data *d)\r\n{\r\nvoid __iomem *base;\r\nu32 t;\r\nbase = ar724x_pci_ctrl_base;\r\nswitch (d->irq) {\r\ncase ATH79_PCI_IRQ(0):\r\nt = __raw_readl(base + AR724X_PCI_REG_INT_MASK);\r\n__raw_writel(t & ~AR724X_PCI_INT_DEV0,\r\nbase + AR724X_PCI_REG_INT_MASK);\r\n__raw_readl(base + AR724X_PCI_REG_INT_MASK);\r\nt = __raw_readl(base + AR724X_PCI_REG_INT_STATUS);\r\n__raw_writel(t | AR724X_PCI_INT_DEV0,\r\nbase + AR724X_PCI_REG_INT_STATUS);\r\n__raw_readl(base + AR724X_PCI_REG_INT_STATUS);\r\n}\r\n}\r\nstatic void __init ar724x_pci_irq_init(int irq)\r\n{\r\nvoid __iomem *base;\r\nint i;\r\nbase = ar724x_pci_ctrl_base;\r\n__raw_writel(0, base + AR724X_PCI_REG_INT_MASK);\r\n__raw_writel(0, base + AR724X_PCI_REG_INT_STATUS);\r\nBUILD_BUG_ON(ATH79_PCI_IRQ_COUNT < AR724X_PCI_IRQ_COUNT);\r\nfor (i = ATH79_PCI_IRQ_BASE;\r\ni < ATH79_PCI_IRQ_BASE + AR724X_PCI_IRQ_COUNT; i++)\r\nirq_set_chip_and_handler(i, &ar724x_pci_irq_chip,\r\nhandle_level_irq);\r\nirq_set_chained_handler(irq, ar724x_pci_irq_handler);\r\n}\r\nint __init ar724x_pcibios_init(int irq)\r\n{\r\nint ret;\r\nret = -ENOMEM;\r\nar724x_pci_devcfg_base = ioremap(AR724X_PCI_CFG_BASE,\r\nAR724X_PCI_CFG_SIZE);\r\nif (ar724x_pci_devcfg_base == NULL)\r\ngoto err;\r\nar724x_pci_ctrl_base = ioremap(AR724X_PCI_CTRL_BASE,\r\nAR724X_PCI_CTRL_SIZE);\r\nif (ar724x_pci_ctrl_base == NULL)\r\ngoto err_unmap_devcfg;\r\nar724x_pci_link_up = ar724x_pci_check_link();\r\nif (!ar724x_pci_link_up)\r\npr_warn("ar724x: PCIe link is down\n");\r\nar724x_pci_irq_init(irq);\r\nregister_pci_controller(&ar724x_pci_controller);\r\nreturn PCIBIOS_SUCCESSFUL;\r\nerr_unmap_devcfg:\r\niounmap(ar724x_pci_devcfg_base);\r\nerr:\r\nreturn ret;\r\n}

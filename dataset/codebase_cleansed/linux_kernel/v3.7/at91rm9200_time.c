static inline unsigned long read_CRTR(void)\r\n{\r\nunsigned long x1, x2;\r\nx1 = at91_st_read(AT91_ST_CRTR);\r\ndo {\r\nx2 = at91_st_read(AT91_ST_CRTR);\r\nif (x1 == x2)\r\nbreak;\r\nx1 = x2;\r\n} while (1);\r\nreturn x1;\r\n}\r\nstatic irqreturn_t at91rm9200_timer_interrupt(int irq, void *dev_id)\r\n{\r\nu32 sr = at91_st_read(AT91_ST_SR) & irqmask;\r\nWARN_ON_ONCE(!irqs_disabled());\r\nif (sr & AT91_ST_ALMS) {\r\nclkevt.event_handler(&clkevt);\r\nreturn IRQ_HANDLED;\r\n}\r\nif (sr & AT91_ST_PITS) {\r\nu32 crtr = read_CRTR();\r\nwhile (((crtr - last_crtr) & AT91_ST_CRTV) >= RM9200_TIMER_LATCH) {\r\nlast_crtr += RM9200_TIMER_LATCH;\r\nclkevt.event_handler(&clkevt);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic cycle_t read_clk32k(struct clocksource *cs)\r\n{\r\nreturn read_CRTR();\r\n}\r\nstatic void\r\nclkevt32k_mode(enum clock_event_mode mode, struct clock_event_device *dev)\r\n{\r\nat91_st_write(AT91_ST_IDR, AT91_ST_PITS | AT91_ST_ALMS);\r\nat91_st_read(AT91_ST_SR);\r\nlast_crtr = read_CRTR();\r\nswitch (mode) {\r\ncase CLOCK_EVT_MODE_PERIODIC:\r\nirqmask = AT91_ST_PITS;\r\nat91_st_write(AT91_ST_PIMR, RM9200_TIMER_LATCH);\r\nbreak;\r\ncase CLOCK_EVT_MODE_ONESHOT:\r\nirqmask = AT91_ST_ALMS;\r\nat91_st_write(AT91_ST_RTAR, last_crtr);\r\nbreak;\r\ncase CLOCK_EVT_MODE_SHUTDOWN:\r\ncase CLOCK_EVT_MODE_UNUSED:\r\ncase CLOCK_EVT_MODE_RESUME:\r\nirqmask = 0;\r\nbreak;\r\n}\r\nat91_st_write(AT91_ST_IER, irqmask);\r\n}\r\nstatic int\r\nclkevt32k_next_event(unsigned long delta, struct clock_event_device *dev)\r\n{\r\nu32 alm;\r\nint status = 0;\r\nBUG_ON(delta < 2);\r\nalm = read_CRTR();\r\nat91_st_write(AT91_ST_RTAR, alm);\r\nat91_st_read(AT91_ST_SR);\r\nalm += delta;\r\nat91_st_write(AT91_ST_RTAR, alm);\r\nreturn status;\r\n}\r\nvoid __init at91rm9200_ioremap_st(u32 addr)\r\n{\r\nat91_st_base = ioremap(addr, 256);\r\nif (!at91_st_base)\r\npanic("Impossible to ioremap ST\n");\r\n}\r\nvoid __init at91rm9200_timer_init(void)\r\n{\r\nat91_st_write(AT91_ST_IDR,\r\nAT91_ST_PITS | AT91_ST_WDOVF | AT91_ST_RTTINC | AT91_ST_ALMS);\r\nat91_st_read(AT91_ST_SR);\r\nsetup_irq(NR_IRQS_LEGACY + AT91_ID_SYS, &at91rm9200_timer_irq);\r\nat91_st_write(AT91_ST_RTMR, 1);\r\nclkevt.mult = div_sc(AT91_SLOW_CLOCK, NSEC_PER_SEC, clkevt.shift);\r\nclkevt.max_delta_ns = clockevent_delta2ns(AT91_ST_ALMV, &clkevt);\r\nclkevt.min_delta_ns = clockevent_delta2ns(2, &clkevt) + 1;\r\nclkevt.cpumask = cpumask_of(0);\r\nclockevents_register_device(&clkevt);\r\nclocksource_register_hz(&clk32k, AT91_SLOW_CLOCK);\r\n}

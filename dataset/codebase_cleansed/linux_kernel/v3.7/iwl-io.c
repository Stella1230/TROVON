static inline void __iwl_set_bit(struct iwl_trans *trans, u32 reg, u32 mask)\r\n{\r\niwl_write32(trans, reg, iwl_read32(trans, reg) | mask);\r\n}\r\nstatic inline void __iwl_clear_bit(struct iwl_trans *trans, u32 reg, u32 mask)\r\n{\r\niwl_write32(trans, reg, iwl_read32(trans, reg) & ~mask);\r\n}\r\nvoid iwl_set_bit(struct iwl_trans *trans, u32 reg, u32 mask)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\n__iwl_set_bit(trans, reg, mask);\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nvoid iwl_clear_bit(struct iwl_trans *trans, u32 reg, u32 mask)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\n__iwl_clear_bit(trans, reg, mask);\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nvoid iwl_set_bits_mask(struct iwl_trans *trans, u32 reg, u32 mask, u32 value)\r\n{\r\nunsigned long flags;\r\nu32 v;\r\n#ifdef CONFIG_IWLWIFI_DEBUG\r\nWARN_ON_ONCE(value & ~mask);\r\n#endif\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nv = iwl_read32(trans, reg);\r\nv &= ~mask;\r\nv |= value;\r\niwl_write32(trans, reg, v);\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nint iwl_poll_bit(struct iwl_trans *trans, u32 addr,\r\nu32 bits, u32 mask, int timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read32(trans, addr) & mask) == (bits & mask))\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nint iwl_grab_nic_access_silent(struct iwl_trans *trans)\r\n{\r\nint ret;\r\nlockdep_assert_held(&trans->reg_lock);\r\n__iwl_set_bit(trans, CSR_GP_CNTRL,\r\nCSR_GP_CNTRL_REG_FLAG_MAC_ACCESS_REQ);\r\nret = iwl_poll_bit(trans, CSR_GP_CNTRL,\r\nCSR_GP_CNTRL_REG_VAL_MAC_ACCESS_EN,\r\n(CSR_GP_CNTRL_REG_FLAG_MAC_CLOCK_READY |\r\nCSR_GP_CNTRL_REG_FLAG_GOING_TO_SLEEP), 15000);\r\nif (ret < 0) {\r\niwl_write32(trans, CSR_RESET, CSR_RESET_REG_FLAG_FORCE_NMI);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nbool iwl_grab_nic_access(struct iwl_trans *trans)\r\n{\r\nint ret = iwl_grab_nic_access_silent(trans);\r\nif (unlikely(ret)) {\r\nu32 val = iwl_read32(trans, CSR_GP_CNTRL);\r\nWARN_ONCE(1, "Timeout waiting for hardware access "\r\n"(CSR_GP_CNTRL 0x%08x)\n", val);\r\nreturn false;\r\n}\r\nreturn true;\r\n}\r\nvoid iwl_release_nic_access(struct iwl_trans *trans)\r\n{\r\nlockdep_assert_held(&trans->reg_lock);\r\n__iwl_clear_bit(trans, CSR_GP_CNTRL,\r\nCSR_GP_CNTRL_REG_FLAG_MAC_ACCESS_REQ);\r\nmmiowb();\r\n}\r\nu32 iwl_read_direct32(struct iwl_trans *trans, u32 reg)\r\n{\r\nu32 value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\niwl_grab_nic_access(trans);\r\nvalue = iwl_read32(trans, reg);\r\niwl_release_nic_access(trans);\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\nreturn value;\r\n}\r\nvoid iwl_write_direct32(struct iwl_trans *trans, u32 reg, u32 value)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\niwl_write32(trans, reg, value);\r\niwl_release_nic_access(trans);\r\n}\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nint iwl_poll_direct_bit(struct iwl_trans *trans, u32 addr, u32 mask,\r\nint timeout)\r\n{\r\nint t = 0;\r\ndo {\r\nif ((iwl_read_direct32(trans, addr) & mask) == mask)\r\nreturn t;\r\nudelay(IWL_POLL_INTERVAL);\r\nt += IWL_POLL_INTERVAL;\r\n} while (t < timeout);\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic inline u32 __iwl_read_prph(struct iwl_trans *trans, u32 reg)\r\n{\r\niwl_write32(trans, HBUS_TARG_PRPH_RADDR, reg | (3 << 24));\r\nreturn iwl_read32(trans, HBUS_TARG_PRPH_RDAT);\r\n}\r\nstatic inline void __iwl_write_prph(struct iwl_trans *trans, u32 addr, u32 val)\r\n{\r\niwl_write32(trans, HBUS_TARG_PRPH_WADDR,\r\n((addr & 0x0000FFFF) | (3 << 24)));\r\niwl_write32(trans, HBUS_TARG_PRPH_WDAT, val);\r\n}\r\nu32 iwl_read_prph(struct iwl_trans *trans, u32 reg)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\niwl_grab_nic_access(trans);\r\nval = __iwl_read_prph(trans, reg);\r\niwl_release_nic_access(trans);\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\nreturn val;\r\n}\r\nvoid iwl_write_prph(struct iwl_trans *trans, u32 addr, u32 val)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\n__iwl_write_prph(trans, addr, val);\r\niwl_release_nic_access(trans);\r\n}\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nvoid iwl_set_bits_prph(struct iwl_trans *trans, u32 reg, u32 mask)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\n__iwl_write_prph(trans, reg,\r\n__iwl_read_prph(trans, reg) | mask);\r\niwl_release_nic_access(trans);\r\n}\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nvoid iwl_set_bits_mask_prph(struct iwl_trans *trans, u32 reg,\r\nu32 bits, u32 mask)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\n__iwl_write_prph(trans, reg,\r\n(__iwl_read_prph(trans, reg) & mask) | bits);\r\niwl_release_nic_access(trans);\r\n}\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nvoid iwl_clear_bits_prph(struct iwl_trans *trans, u32 reg, u32 mask)\r\n{\r\nunsigned long flags;\r\nu32 val;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\nval = __iwl_read_prph(trans, reg);\r\n__iwl_write_prph(trans, reg, (val & ~mask));\r\niwl_release_nic_access(trans);\r\n}\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nvoid _iwl_read_targ_mem_dwords(struct iwl_trans *trans, u32 addr,\r\nvoid *buf, int dwords)\r\n{\r\nunsigned long flags;\r\nint offs;\r\nu32 *vals = buf;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\niwl_write32(trans, HBUS_TARG_MEM_RADDR, addr);\r\nfor (offs = 0; offs < dwords; offs++)\r\nvals[offs] = iwl_read32(trans, HBUS_TARG_MEM_RDAT);\r\niwl_release_nic_access(trans);\r\n}\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\n}\r\nu32 iwl_read_targ_mem(struct iwl_trans *trans, u32 addr)\r\n{\r\nu32 value;\r\n_iwl_read_targ_mem_dwords(trans, addr, &value, 1);\r\nreturn value;\r\n}\r\nint _iwl_write_targ_mem_dwords(struct iwl_trans *trans, u32 addr,\r\nvoid *buf, int dwords)\r\n{\r\nunsigned long flags;\r\nint offs, result = 0;\r\nu32 *vals = buf;\r\nspin_lock_irqsave(&trans->reg_lock, flags);\r\nif (likely(iwl_grab_nic_access(trans))) {\r\niwl_write32(trans, HBUS_TARG_MEM_WADDR, addr);\r\nfor (offs = 0; offs < dwords; offs++)\r\niwl_write32(trans, HBUS_TARG_MEM_WDAT, vals[offs]);\r\niwl_release_nic_access(trans);\r\n} else\r\nresult = -EBUSY;\r\nspin_unlock_irqrestore(&trans->reg_lock, flags);\r\nreturn result;\r\n}\r\nint iwl_write_targ_mem(struct iwl_trans *trans, u32 addr, u32 val)\r\n{\r\nreturn _iwl_write_targ_mem_dwords(trans, addr, &val, 1);\r\n}

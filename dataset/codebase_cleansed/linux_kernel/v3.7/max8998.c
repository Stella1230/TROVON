static int max8998_get_enable_register(struct regulator_dev *rdev,\r\nint *reg, int *shift)\r\n{\r\nint ldo = rdev_get_id(rdev);\r\nswitch (ldo) {\r\ncase MAX8998_LDO2 ... MAX8998_LDO5:\r\n*reg = MAX8998_REG_ONOFF1;\r\n*shift = 3 - (ldo - MAX8998_LDO2);\r\nbreak;\r\ncase MAX8998_LDO6 ... MAX8998_LDO13:\r\n*reg = MAX8998_REG_ONOFF2;\r\n*shift = 7 - (ldo - MAX8998_LDO6);\r\nbreak;\r\ncase MAX8998_LDO14 ... MAX8998_LDO17:\r\n*reg = MAX8998_REG_ONOFF3;\r\n*shift = 7 - (ldo - MAX8998_LDO14);\r\nbreak;\r\ncase MAX8998_BUCK1 ... MAX8998_BUCK4:\r\n*reg = MAX8998_REG_ONOFF1;\r\n*shift = 7 - (ldo - MAX8998_BUCK1);\r\nbreak;\r\ncase MAX8998_EN32KHZ_AP ... MAX8998_ENVICHG:\r\n*reg = MAX8998_REG_ONOFF4;\r\n*shift = 7 - (ldo - MAX8998_EN32KHZ_AP);\r\nbreak;\r\ncase MAX8998_ESAFEOUT1 ... MAX8998_ESAFEOUT2:\r\n*reg = MAX8998_REG_CHGR2;\r\n*shift = 7 - (ldo - MAX8998_ESAFEOUT1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8998_ldo_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint ret, reg, shift = 8;\r\nu8 val;\r\nret = max8998_get_enable_register(rdev, &reg, &shift);\r\nif (ret)\r\nreturn ret;\r\nret = max8998_read_reg(i2c, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn val & (1 << shift);\r\n}\r\nstatic int max8998_ldo_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint reg, shift = 8, ret;\r\nret = max8998_get_enable_register(rdev, &reg, &shift);\r\nif (ret)\r\nreturn ret;\r\nreturn max8998_update_reg(i2c, reg, 1<<shift, 1<<shift);\r\n}\r\nstatic int max8998_ldo_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint reg, shift = 8, ret;\r\nret = max8998_get_enable_register(rdev, &reg, &shift);\r\nif (ret)\r\nreturn ret;\r\nreturn max8998_update_reg(i2c, reg, 0, 1<<shift);\r\n}\r\nstatic int max8998_get_voltage_register(struct regulator_dev *rdev,\r\nint *_reg, int *_shift, int *_mask)\r\n{\r\nint ldo = rdev_get_id(rdev);\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nint reg, shift = 0, mask = 0xff;\r\nswitch (ldo) {\r\ncase MAX8998_LDO2 ... MAX8998_LDO3:\r\nreg = MAX8998_REG_LDO2_LDO3;\r\nmask = 0xf;\r\nif (ldo == MAX8998_LDO2)\r\nshift = 4;\r\nelse\r\nshift = 0;\r\nbreak;\r\ncase MAX8998_LDO4 ... MAX8998_LDO7:\r\nreg = MAX8998_REG_LDO4 + (ldo - MAX8998_LDO4);\r\nbreak;\r\ncase MAX8998_LDO8 ... MAX8998_LDO9:\r\nreg = MAX8998_REG_LDO8_LDO9;\r\nmask = 0xf;\r\nif (ldo == MAX8998_LDO8)\r\nshift = 4;\r\nelse\r\nshift = 0;\r\nbreak;\r\ncase MAX8998_LDO10 ... MAX8998_LDO11:\r\nreg = MAX8998_REG_LDO10_LDO11;\r\nif (ldo == MAX8998_LDO10) {\r\nshift = 5;\r\nmask = 0x7;\r\n} else {\r\nshift = 0;\r\nmask = 0x1f;\r\n}\r\nbreak;\r\ncase MAX8998_LDO12 ... MAX8998_LDO17:\r\nreg = MAX8998_REG_LDO12 + (ldo - MAX8998_LDO12);\r\nbreak;\r\ncase MAX8998_BUCK1:\r\nreg = MAX8998_REG_BUCK1_VOLTAGE1 + max8998->buck1_idx;\r\nbreak;\r\ncase MAX8998_BUCK2:\r\nreg = MAX8998_REG_BUCK2_VOLTAGE1 + max8998->buck2_idx;\r\nbreak;\r\ncase MAX8998_BUCK3:\r\nreg = MAX8998_REG_BUCK3;\r\nbreak;\r\ncase MAX8998_BUCK4:\r\nreg = MAX8998_REG_BUCK4;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n*_reg = reg;\r\n*_shift = shift;\r\n*_mask = mask;\r\nreturn 0;\r\n}\r\nstatic int max8998_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint reg, shift = 0, mask, ret;\r\nu8 val;\r\nret = max8998_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nret = max8998_read_reg(i2c, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nval >>= shift;\r\nval &= mask;\r\nreturn val;\r\n}\r\nstatic int max8998_set_voltage_ldo_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint reg, shift = 0, mask, ret;\r\nret = max8998_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nret = max8998_update_reg(i2c, reg, selector<<shift, mask<<shift);\r\nreturn ret;\r\n}\r\nstatic inline void buck1_gpio_set(int gpio1, int gpio2, int v)\r\n{\r\ngpio_set_value(gpio1, v & 0x1);\r\ngpio_set_value(gpio2, (v >> 1) & 0x1);\r\n}\r\nstatic inline void buck2_gpio_set(int gpio, int v)\r\n{\r\ngpio_set_value(gpio, v & 0x1);\r\n}\r\nstatic int max8998_set_voltage_buck_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct max8998_platform_data *pdata =\r\ndev_get_platdata(max8998->iodev->dev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nint buck = rdev_get_id(rdev);\r\nint reg, shift = 0, mask, ret;\r\nint j, previous_sel;\r\nstatic u8 buck1_last_val;\r\nret = max8998_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nprevious_sel = max8998_get_voltage_sel(rdev);\r\nif (previous_sel == selector) {\r\ndev_dbg(max8998->dev, "No voltage change, old:%d, new:%d\n",\r\nregulator_list_voltage_linear(rdev, previous_sel),\r\nregulator_list_voltage_linear(rdev, selector));\r\nreturn ret;\r\n}\r\nswitch (buck) {\r\ncase MAX8998_BUCK1:\r\ndev_dbg(max8998->dev,\r\n"BUCK1, selector:%d, buck1_vol1:%d, buck1_vol2:%d\n"\r\n"buck1_vol3:%d, buck1_vol4:%d\n",\r\nselector, max8998->buck1_vol[0], max8998->buck1_vol[1],\r\nmax8998->buck1_vol[2], max8998->buck1_vol[3]);\r\nif (gpio_is_valid(pdata->buck1_set1) &&\r\ngpio_is_valid(pdata->buck1_set2)) {\r\nfor (j = 0; j < ARRAY_SIZE(max8998->buck1_vol); j++) {\r\nif (max8998->buck1_vol[j] == selector) {\r\nmax8998->buck1_idx = j;\r\nbuck1_gpio_set(pdata->buck1_set1,\r\npdata->buck1_set2, j);\r\ngoto buck1_exit;\r\n}\r\n}\r\nif (pdata->buck_voltage_lock)\r\nreturn -EINVAL;\r\nmax8998->buck1_idx = (buck1_last_val % 2) + 2;\r\ndev_dbg(max8998->dev, "max8998->buck1_idx:%d\n",\r\nmax8998->buck1_idx);\r\nmax8998->buck1_vol[max8998->buck1_idx] = selector;\r\nret = max8998_get_voltage_register(rdev, &reg,\r\n&shift,\r\n&mask);\r\nret = max8998_write_reg(i2c, reg, selector);\r\nbuck1_gpio_set(pdata->buck1_set1,\r\npdata->buck1_set2, max8998->buck1_idx);\r\nbuck1_last_val++;\r\nbuck1_exit:\r\ndev_dbg(max8998->dev, "%s: SET1:%d, SET2:%d\n",\r\ni2c->name, gpio_get_value(pdata->buck1_set1),\r\ngpio_get_value(pdata->buck1_set2));\r\nbreak;\r\n} else {\r\nret = max8998_write_reg(i2c, reg, selector);\r\n}\r\nbreak;\r\ncase MAX8998_BUCK2:\r\ndev_dbg(max8998->dev,\r\n"BUCK2, selector:%d buck2_vol1:%d, buck2_vol2:%d\n",\r\nselector, max8998->buck2_vol[0], max8998->buck2_vol[1]);\r\nif (gpio_is_valid(pdata->buck2_set3)) {\r\nfor (j = 0; j < ARRAY_SIZE(max8998->buck2_vol); j++) {\r\nif (max8998->buck2_vol[j] == selector) {\r\nmax8998->buck2_idx = j;\r\nbuck2_gpio_set(pdata->buck2_set3, j);\r\ngoto buck2_exit;\r\n}\r\n}\r\nif (pdata->buck_voltage_lock)\r\nreturn -EINVAL;\r\nmax8998_get_voltage_register(rdev,\r\n&reg, &shift, &mask);\r\nret = max8998_write_reg(i2c, reg, selector);\r\nmax8998->buck2_vol[max8998->buck2_idx] = selector;\r\nbuck2_gpio_set(pdata->buck2_set3, max8998->buck2_idx);\r\nbuck2_exit:\r\ndev_dbg(max8998->dev, "%s: SET3:%d\n", i2c->name,\r\ngpio_get_value(pdata->buck2_set3));\r\n} else {\r\nret = max8998_write_reg(i2c, reg, selector);\r\n}\r\nbreak;\r\ncase MAX8998_BUCK3:\r\ncase MAX8998_BUCK4:\r\nret = max8998_update_reg(i2c, reg, selector<<shift,\r\nmask<<shift);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int max8998_set_voltage_buck_time_sel(struct regulator_dev *rdev,\r\nunsigned int old_selector,\r\nunsigned int new_selector)\r\n{\r\nstruct max8998_data *max8998 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8998->iodev->i2c;\r\nconst struct voltage_map_desc *desc;\r\nint buck = rdev_get_id(rdev);\r\nu8 val = 0;\r\nint difference, ret;\r\nif (buck < MAX8998_BUCK1 || buck > MAX8998_BUCK4)\r\nreturn -EINVAL;\r\ndesc = ldo_voltage_map[buck];\r\nret = max8998_read_reg(i2c, MAX8998_REG_ONOFF4, &val);\r\nif (ret)\r\nreturn ret;\r\nif (max8998->iodev->type == TYPE_MAX8998 && !(val & MAX8998_ENRAMP))\r\nreturn 0;\r\ndifference = (new_selector - old_selector) * desc->step;\r\nif (difference > 0)\r\nreturn difference / ((val & 0x0f) + 1);\r\nreturn 0;\r\n}\r\nstatic __devinit int max8998_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct max8998_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8998_platform_data *pdata = dev_get_platdata(iodev->dev);\r\nstruct regulator_config config = { };\r\nstruct regulator_dev **rdev;\r\nstruct max8998_data *max8998;\r\nstruct i2c_client *i2c;\r\nint i, ret, size;\r\nif (!pdata) {\r\ndev_err(pdev->dev.parent, "No platform init data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nmax8998 = devm_kzalloc(&pdev->dev, sizeof(struct max8998_data),\r\nGFP_KERNEL);\r\nif (!max8998)\r\nreturn -ENOMEM;\r\nsize = sizeof(struct regulator_dev *) * pdata->num_regulators;\r\nmax8998->rdev = devm_kzalloc(&pdev->dev, size, GFP_KERNEL);\r\nif (!max8998->rdev)\r\nreturn -ENOMEM;\r\nrdev = max8998->rdev;\r\nmax8998->dev = &pdev->dev;\r\nmax8998->iodev = iodev;\r\nmax8998->num_regulators = pdata->num_regulators;\r\nplatform_set_drvdata(pdev, max8998);\r\ni2c = max8998->iodev->i2c;\r\nmax8998->buck1_idx = pdata->buck1_default_idx;\r\nmax8998->buck2_idx = pdata->buck2_default_idx;\r\nif (gpio_is_valid(pdata->buck1_set1) &&\r\ngpio_is_valid(pdata->buck1_set2)) {\r\nif (!pdata->buck1_set1) {\r\nprintk(KERN_ERR "MAX8998 SET1 GPIO defined as 0 !\n");\r\nWARN_ON(!pdata->buck1_set1);\r\nret = -EIO;\r\ngoto err_out;\r\n}\r\nif (!pdata->buck1_set2) {\r\nprintk(KERN_ERR "MAX8998 SET2 GPIO defined as 0 !\n");\r\nWARN_ON(!pdata->buck1_set2);\r\nret = -EIO;\r\ngoto err_out;\r\n}\r\ngpio_request(pdata->buck1_set1, "MAX8998 BUCK1_SET1");\r\ngpio_direction_output(pdata->buck1_set1,\r\nmax8998->buck1_idx & 0x1);\r\ngpio_request(pdata->buck1_set2, "MAX8998 BUCK1_SET2");\r\ngpio_direction_output(pdata->buck1_set2,\r\n(max8998->buck1_idx >> 1) & 0x1);\r\ni = 0;\r\nwhile (buck12_voltage_map_desc.min +\r\nbuck12_voltage_map_desc.step*i\r\n< (pdata->buck1_voltage1 / 1000))\r\ni++;\r\nmax8998->buck1_vol[0] = i;\r\nret = max8998_write_reg(i2c, MAX8998_REG_BUCK1_VOLTAGE1, i);\r\nif (ret)\r\ngoto err_out;\r\ni = 0;\r\nwhile (buck12_voltage_map_desc.min +\r\nbuck12_voltage_map_desc.step*i\r\n< (pdata->buck1_voltage2 / 1000))\r\ni++;\r\nmax8998->buck1_vol[1] = i;\r\nret = max8998_write_reg(i2c, MAX8998_REG_BUCK1_VOLTAGE2, i);\r\nif (ret)\r\ngoto err_out;\r\ni = 0;\r\nwhile (buck12_voltage_map_desc.min +\r\nbuck12_voltage_map_desc.step*i\r\n< (pdata->buck1_voltage3 / 1000))\r\ni++;\r\nmax8998->buck1_vol[2] = i;\r\nret = max8998_write_reg(i2c, MAX8998_REG_BUCK1_VOLTAGE3, i);\r\nif (ret)\r\ngoto err_out;\r\ni = 0;\r\nwhile (buck12_voltage_map_desc.min +\r\nbuck12_voltage_map_desc.step*i\r\n< (pdata->buck1_voltage4 / 1000))\r\ni++;\r\nmax8998->buck1_vol[3] = i;\r\nret = max8998_write_reg(i2c, MAX8998_REG_BUCK1_VOLTAGE4, i);\r\nif (ret)\r\ngoto err_out;\r\n}\r\nif (gpio_is_valid(pdata->buck2_set3)) {\r\nif (!pdata->buck2_set3) {\r\nprintk(KERN_ERR "MAX8998 SET3 GPIO defined as 0 !\n");\r\nWARN_ON(!pdata->buck2_set3);\r\nret = -EIO;\r\ngoto err_out;\r\n}\r\ngpio_request(pdata->buck2_set3, "MAX8998 BUCK2_SET3");\r\ngpio_direction_output(pdata->buck2_set3,\r\nmax8998->buck2_idx & 0x1);\r\ni = 0;\r\nwhile (buck12_voltage_map_desc.min +\r\nbuck12_voltage_map_desc.step*i\r\n< (pdata->buck2_voltage1 / 1000))\r\ni++;\r\nmax8998->buck2_vol[0] = i;\r\nret = max8998_write_reg(i2c, MAX8998_REG_BUCK2_VOLTAGE1, i);\r\nif (ret)\r\ngoto err_out;\r\ni = 0;\r\nwhile (buck12_voltage_map_desc.min +\r\nbuck12_voltage_map_desc.step*i\r\n< (pdata->buck2_voltage2 / 1000))\r\ni++;\r\nmax8998->buck2_vol[1] = i;\r\nret = max8998_write_reg(i2c, MAX8998_REG_BUCK2_VOLTAGE2, i);\r\nif (ret)\r\ngoto err_out;\r\n}\r\nfor (i = 0; i < pdata->num_regulators; i++) {\r\nconst struct voltage_map_desc *desc;\r\nint id = pdata->regulators[i].id;\r\nint index = id - MAX8998_LDO2;\r\ndesc = ldo_voltage_map[id];\r\nif (desc && regulators[index].ops != &max8998_others_ops) {\r\nint count = (desc->max - desc->min) / desc->step + 1;\r\nregulators[index].n_voltages = count;\r\nregulators[index].min_uV = desc->min * 1000;\r\nregulators[index].uV_step = desc->step * 1000;\r\n}\r\nconfig.dev = max8998->dev;\r\nconfig.init_data = pdata->regulators[i].initdata;\r\nconfig.driver_data = max8998;\r\nrdev[i] = regulator_register(&regulators[index], &config);\r\nif (IS_ERR(rdev[i])) {\r\nret = PTR_ERR(rdev[i]);\r\ndev_err(max8998->dev, "regulator init failed\n");\r\nrdev[i] = NULL;\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\nwhile (--i >= 0)\r\nregulator_unregister(rdev[i]);\r\nerr_out:\r\nreturn ret;\r\n}\r\nstatic int __devexit max8998_pmic_remove(struct platform_device *pdev)\r\n{\r\nstruct max8998_data *max8998 = platform_get_drvdata(pdev);\r\nstruct regulator_dev **rdev = max8998->rdev;\r\nint i;\r\nfor (i = 0; i < max8998->num_regulators; i++)\r\nregulator_unregister(rdev[i]);\r\nreturn 0;\r\n}\r\nstatic int __init max8998_pmic_init(void)\r\n{\r\nreturn platform_driver_register(&max8998_pmic_driver);\r\n}\r\nstatic void __exit max8998_pmic_cleanup(void)\r\n{\r\nplatform_driver_unregister(&max8998_pmic_driver);\r\n}

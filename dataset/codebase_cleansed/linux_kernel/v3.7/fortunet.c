static char * __init get_string_option(char *dest,int dest_size,char *sor)\r\n{\r\nif(!dest_size)\r\nreturn sor;\r\ndest_size--;\r\nwhile(*sor)\r\n{\r\nif(*sor==',')\r\n{\r\nsor++;\r\nbreak;\r\n}\r\nelse if(*sor=='\"')\r\n{\r\nsor++;\r\nwhile(*sor)\r\n{\r\nif(*sor=='\"')\r\n{\r\nsor++;\r\nbreak;\r\n}\r\n*dest = *sor;\r\ndest++;\r\nsor++;\r\ndest_size--;\r\nif(!dest_size)\r\n{\r\n*dest = 0;\r\nreturn sor;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\n*dest = *sor;\r\ndest++;\r\nsor++;\r\ndest_size--;\r\nif(!dest_size)\r\n{\r\n*dest = 0;\r\nreturn sor;\r\n}\r\n}\r\n}\r\n*dest = 0;\r\nreturn sor;\r\n}\r\nstatic int __init MTD_New_Region(char *line)\r\n{\r\nchar string[MAX_NAME_SIZE];\r\nint params[6];\r\nget_options (get_string_option(string,sizeof(string),line),6,params);\r\nif(params[0]<1)\r\n{\r\nprintk(MTD_FORTUNET_PK "Bad parameters for MTD Region "\r\n" name,region-number[,base,size,bankwidth,altbankwidth]\n");\r\nreturn 1;\r\n}\r\nif((params[1]<0)||(params[1]>=MAX_NUM_REGIONS))\r\n{\r\nprintk(MTD_FORTUNET_PK "Bad region index of %d only have 0..%u regions\n",\r\nparams[1],MAX_NUM_REGIONS-1);\r\nreturn 1;\r\n}\r\nmemset(&map_regions[params[1]],0,sizeof(map_regions[params[1]]));\r\nmemcpy(&map_regions[params[1]].map_info,\r\n&default_map,sizeof(map_regions[params[1]].map_info));\r\nmap_regions_set[params[1]] = 1;\r\nmap_regions[params[1]].window_addr_physical = DEF_WINDOW_ADDR_PHY;\r\nmap_regions[params[1]].altbankwidth = 2;\r\nmap_regions[params[1]].mymtd = NULL;\r\nmap_regions[params[1]].map_info.name = map_regions[params[1]].map_name;\r\nstrcpy(map_regions[params[1]].map_info.name,string);\r\nif(params[0]>1)\r\n{\r\nmap_regions[params[1]].window_addr_physical = params[2];\r\n}\r\nif(params[0]>2)\r\n{\r\nmap_regions[params[1]].map_info.size = params[3];\r\n}\r\nif(params[0]>3)\r\n{\r\nmap_regions[params[1]].map_info.bankwidth = params[4];\r\n}\r\nif(params[0]>4)\r\n{\r\nmap_regions[params[1]].altbankwidth = params[5];\r\n}\r\nreturn 1;\r\n}\r\nstatic int __init MTD_New_Partition(char *line)\r\n{\r\nchar string[MAX_NAME_SIZE];\r\nint params[4];\r\nget_options (get_string_option(string,sizeof(string),line),4,params);\r\nif(params[0]<3)\r\n{\r\nprintk(MTD_FORTUNET_PK "Bad parameters for MTD Partition "\r\n" name,region-number,size,offset\n");\r\nreturn 1;\r\n}\r\nif((params[1]<0)||(params[1]>=MAX_NUM_REGIONS))\r\n{\r\nprintk(MTD_FORTUNET_PK "Bad region index of %d only have 0..%u regions\n",\r\nparams[1],MAX_NUM_REGIONS-1);\r\nreturn 1;\r\n}\r\nif(map_regions_parts[params[1]]>=MAX_NUM_PARTITIONS)\r\n{\r\nprintk(MTD_FORTUNET_PK "Out of space for partition in this region\n");\r\nreturn 1;\r\n}\r\nmap_regions[params[1]].parts[map_regions_parts[params[1]]].name =\r\nmap_regions[params[1]]. parts_name[map_regions_parts[params[1]]];\r\nstrcpy(map_regions[params[1]].parts[map_regions_parts[params[1]]].name,string);\r\nmap_regions[params[1]].parts[map_regions_parts[params[1]]].size =\r\nparams[2];\r\nmap_regions[params[1]].parts[map_regions_parts[params[1]]].offset =\r\nparams[3];\r\nmap_regions[params[1]].parts[map_regions_parts[params[1]]].mask_flags = 0;\r\nmap_regions_parts[params[1]]++;\r\nreturn 1;\r\n}\r\nstatic int __init init_fortunet(void)\r\n{\r\nint ix,iy;\r\nfor(iy=ix=0;ix<MAX_NUM_REGIONS;ix++)\r\n{\r\nif(map_regions_parts[ix]&&(!map_regions_set[ix]))\r\n{\r\nprintk(MTD_FORTUNET_PK "Region %d is not setup (Setting to default)\n",\r\nix);\r\nmemset(&map_regions[ix],0,sizeof(map_regions[ix]));\r\nmemcpy(&map_regions[ix].map_info,&default_map,\r\nsizeof(map_regions[ix].map_info));\r\nmap_regions_set[ix] = 1;\r\nmap_regions[ix].window_addr_physical = DEF_WINDOW_ADDR_PHY;\r\nmap_regions[ix].altbankwidth = 2;\r\nmap_regions[ix].mymtd = NULL;\r\nmap_regions[ix].map_info.name = map_regions[ix].map_name;\r\nstrcpy(map_regions[ix].map_info.name,"FORTUNET");\r\n}\r\nif(map_regions_set[ix])\r\n{\r\niy++;\r\nprintk(KERN_NOTICE MTD_FORTUNET_PK "%s flash device at physically "\r\n" address %x size %x\n",\r\nmap_regions[ix].map_info.name,\r\nmap_regions[ix].window_addr_physical,\r\nmap_regions[ix].map_info.size);\r\nmap_regions[ix].map_info.phys = map_regions[ix].window_addr_physical,\r\nmap_regions[ix].map_info.virt =\r\nioremap_nocache(\r\nmap_regions[ix].window_addr_physical,\r\nmap_regions[ix].map_info.size);\r\nif(!map_regions[ix].map_info.virt)\r\n{\r\nint j = 0;\r\nprintk(MTD_FORTUNET_PK "%s flash failed to ioremap!\n",\r\nmap_regions[ix].map_info.name);\r\nfor (j = 0 ; j < ix; j++)\r\niounmap(map_regions[j].map_info.virt);\r\nreturn -ENXIO;\r\n}\r\nsimple_map_init(&map_regions[ix].map_info);\r\nprintk(KERN_NOTICE MTD_FORTUNET_PK "%s flash is virtually at: %x\n",\r\nmap_regions[ix].map_info.name,\r\nmap_regions[ix].map_info.virt);\r\nmap_regions[ix].mymtd = do_map_probe("cfi_probe",\r\n&map_regions[ix].map_info);\r\nif((!map_regions[ix].mymtd)&&(\r\nmap_regions[ix].altbankwidth!=map_regions[ix].map_info.bankwidth))\r\n{\r\nprintk(KERN_NOTICE MTD_FORTUNET_PK "Trying alternate bankwidth "\r\n"for %s flash.\n",\r\nmap_regions[ix].map_info.name);\r\nmap_regions[ix].map_info.bankwidth =\r\nmap_regions[ix].altbankwidth;\r\nmap_regions[ix].mymtd = do_map_probe("cfi_probe",\r\n&map_regions[ix].map_info);\r\n}\r\nmap_regions[ix].mymtd->owner = THIS_MODULE;\r\nmtd_device_register(map_regions[ix].mymtd,\r\nmap_regions[ix].parts,\r\nmap_regions_parts[ix]);\r\n}\r\n}\r\nif(iy)\r\nreturn 0;\r\nreturn -ENXIO;\r\n}\r\nstatic void __exit cleanup_fortunet(void)\r\n{\r\nint ix;\r\nfor(ix=0;ix<MAX_NUM_REGIONS;ix++)\r\n{\r\nif(map_regions_set[ix])\r\n{\r\nif( map_regions[ix].mymtd )\r\n{\r\nmtd_device_unregister(map_regions[ix].mymtd);\r\nmap_destroy( map_regions[ix].mymtd );\r\n}\r\niounmap((void *)map_regions[ix].map_info.virt);\r\n}\r\n}\r\n}

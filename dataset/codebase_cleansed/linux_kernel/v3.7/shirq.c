static void shirq_irq_mask(struct irq_data *d)\r\n{\r\nstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\r\nu32 val, id = d->irq - shirq->dev_config[0].virq;\r\nunsigned long flags;\r\nif ((shirq->regs.enb_reg == -1) || shirq->dev_config[id].enb_mask == -1)\r\nreturn;\r\nspin_lock_irqsave(&lock, flags);\r\nval = readl(shirq->regs.base + shirq->regs.enb_reg);\r\nif (shirq->regs.reset_to_enb)\r\nval |= shirq->dev_config[id].enb_mask;\r\nelse\r\nval &= ~(shirq->dev_config[id].enb_mask);\r\nwritel(val, shirq->regs.base + shirq->regs.enb_reg);\r\nspin_unlock_irqrestore(&lock, flags);\r\n}\r\nstatic void shirq_irq_unmask(struct irq_data *d)\r\n{\r\nstruct spear_shirq *shirq = irq_data_get_irq_chip_data(d);\r\nu32 val, id = d->irq - shirq->dev_config[0].virq;\r\nunsigned long flags;\r\nif ((shirq->regs.enb_reg == -1) || shirq->dev_config[id].enb_mask == -1)\r\nreturn;\r\nspin_lock_irqsave(&lock, flags);\r\nval = readl(shirq->regs.base + shirq->regs.enb_reg);\r\nif (shirq->regs.reset_to_enb)\r\nval &= ~(shirq->dev_config[id].enb_mask);\r\nelse\r\nval |= shirq->dev_config[id].enb_mask;\r\nwritel(val, shirq->regs.base + shirq->regs.enb_reg);\r\nspin_unlock_irqrestore(&lock, flags);\r\n}\r\nstatic void shirq_handler(unsigned irq, struct irq_desc *desc)\r\n{\r\nu32 i, val, mask;\r\nstruct spear_shirq *shirq = irq_get_handler_data(irq);\r\ndesc->irq_data.chip->irq_ack(&desc->irq_data);\r\nwhile ((val = readl(shirq->regs.base + shirq->regs.status_reg) &\r\nshirq->regs.status_reg_mask)) {\r\nfor (i = 0; (i < shirq->dev_count) && val; i++) {\r\nif (!(shirq->dev_config[i].status_mask & val))\r\ncontinue;\r\ngeneric_handle_irq(shirq->dev_config[i].virq);\r\nval &= ~shirq->dev_config[i].status_mask;\r\nif ((shirq->regs.clear_reg == -1) ||\r\nshirq->dev_config[i].clear_mask == -1)\r\ncontinue;\r\nmask = readl(shirq->regs.base + shirq->regs.clear_reg);\r\nif (shirq->regs.reset_to_clear)\r\nmask &= ~shirq->dev_config[i].clear_mask;\r\nelse\r\nmask |= shirq->dev_config[i].clear_mask;\r\nwritel(mask, shirq->regs.base + shirq->regs.clear_reg);\r\n}\r\n}\r\ndesc->irq_data.chip->irq_unmask(&desc->irq_data);\r\n}\r\nint spear_shirq_register(struct spear_shirq *shirq)\r\n{\r\nint i;\r\nif (!shirq || !shirq->dev_config || !shirq->regs.base)\r\nreturn -EFAULT;\r\nif (!shirq->dev_count)\r\nreturn -EINVAL;\r\nirq_set_chained_handler(shirq->irq, shirq_handler);\r\nfor (i = 0; i < shirq->dev_count; i++) {\r\nirq_set_chip_and_handler(shirq->dev_config[i].virq,\r\n&shirq_chip, handle_simple_irq);\r\nset_irq_flags(shirq->dev_config[i].virq, IRQF_VALID);\r\nirq_set_chip_data(shirq->dev_config[i].virq, shirq);\r\n}\r\nirq_set_handler_data(shirq->irq, shirq);\r\nreturn 0;\r\n}

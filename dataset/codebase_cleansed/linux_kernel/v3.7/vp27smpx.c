static inline struct vp27smpx_state *to_state(struct v4l2_subdev *sd)\r\n{\r\nreturn container_of(sd, struct vp27smpx_state, sd);\r\n}\r\nstatic void vp27smpx_set_audmode(struct v4l2_subdev *sd, u32 audmode)\r\n{\r\nstruct vp27smpx_state *state = to_state(sd);\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nu8 data[3] = { 0x00, 0x00, 0x04 };\r\nswitch (audmode) {\r\ncase V4L2_TUNER_MODE_MONO:\r\ncase V4L2_TUNER_MODE_LANG1:\r\nbreak;\r\ncase V4L2_TUNER_MODE_STEREO:\r\ncase V4L2_TUNER_MODE_LANG1_LANG2:\r\ndata[1] = 0x01;\r\nbreak;\r\ncase V4L2_TUNER_MODE_LANG2:\r\ndata[1] = 0x02;\r\nbreak;\r\n}\r\nif (i2c_master_send(client, data, sizeof(data)) != sizeof(data))\r\nv4l2_err(sd, "I/O error setting audmode\n");\r\nelse\r\nstate->audmode = audmode;\r\n}\r\nstatic int vp27smpx_s_radio(struct v4l2_subdev *sd)\r\n{\r\nstruct vp27smpx_state *state = to_state(sd);\r\nstate->radio = 1;\r\nreturn 0;\r\n}\r\nstatic int vp27smpx_s_std(struct v4l2_subdev *sd, v4l2_std_id norm)\r\n{\r\nstruct vp27smpx_state *state = to_state(sd);\r\nstate->radio = 0;\r\nreturn 0;\r\n}\r\nstatic int vp27smpx_s_tuner(struct v4l2_subdev *sd, struct v4l2_tuner *vt)\r\n{\r\nstruct vp27smpx_state *state = to_state(sd);\r\nif (!state->radio)\r\nvp27smpx_set_audmode(sd, vt->audmode);\r\nreturn 0;\r\n}\r\nstatic int vp27smpx_g_tuner(struct v4l2_subdev *sd, struct v4l2_tuner *vt)\r\n{\r\nstruct vp27smpx_state *state = to_state(sd);\r\nif (state->radio)\r\nreturn 0;\r\nvt->audmode = state->audmode;\r\nvt->capability = V4L2_TUNER_CAP_STEREO |\r\nV4L2_TUNER_CAP_LANG1 | V4L2_TUNER_CAP_LANG2;\r\nvt->rxsubchans = V4L2_TUNER_SUB_MONO;\r\nreturn 0;\r\n}\r\nstatic int vp27smpx_g_chip_ident(struct v4l2_subdev *sd, struct v4l2_dbg_chip_ident *chip)\r\n{\r\nstruct i2c_client *client = v4l2_get_subdevdata(sd);\r\nreturn v4l2_chip_ident_i2c_client(client, chip, V4L2_IDENT_VP27SMPX, 0);\r\n}\r\nstatic int vp27smpx_log_status(struct v4l2_subdev *sd)\r\n{\r\nstruct vp27smpx_state *state = to_state(sd);\r\nv4l2_info(sd, "Audio Mode: %u%s\n", state->audmode,\r\nstate->radio ? " (Radio)" : "");\r\nreturn 0;\r\n}\r\nstatic int vp27smpx_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct vp27smpx_state *state;\r\nstruct v4l2_subdev *sd;\r\nif (!i2c_check_functionality(client->adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -EIO;\r\nv4l_info(client, "chip found @ 0x%x (%s)\n",\r\nclient->addr << 1, client->adapter->name);\r\nstate = kzalloc(sizeof(struct vp27smpx_state), GFP_KERNEL);\r\nif (state == NULL)\r\nreturn -ENOMEM;\r\nsd = &state->sd;\r\nv4l2_i2c_subdev_init(sd, client, &vp27smpx_ops);\r\nstate->audmode = V4L2_TUNER_MODE_STEREO;\r\nvp27smpx_set_audmode(sd, state->audmode);\r\nreturn 0;\r\n}\r\nstatic int vp27smpx_remove(struct i2c_client *client)\r\n{\r\nstruct v4l2_subdev *sd = i2c_get_clientdata(client);\r\nv4l2_device_unregister_subdev(sd);\r\nkfree(to_state(sd));\r\nreturn 0;\r\n}

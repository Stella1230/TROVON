static int tsc2007_get_pendown_state(void)\r\n{\r\nif (mx51_revision() < IMX_CHIP_REVISION_3_0)\r\nreturn !gpio_get_value(TSC2007_IRQGPIO_REV2);\r\nelse\r\nreturn !gpio_get_value(TSC2007_IRQGPIO_REV3);\r\n}\r\nstatic int initialize_otg_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = usb_base + MX5_USBOTHER_REGS_OFFSET;\r\nv = __raw_readl(usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\nv &= ~MX5_USB_UTMI_PHYCTRL1_PLLDIV_MASK;\r\nv |= MX51_USB_PLL_DIV_19_2_MHZ;\r\n__raw_writel(v, usbother_base + MXC_USB_PHY_CTR_FUNC2_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(0, MXC_EHCI_INTERNAL_PHY);\r\n}\r\nstatic int initialize_usbh1_port(struct platform_device *pdev)\r\n{\r\nu32 v;\r\nvoid __iomem *usb_base;\r\nvoid __iomem *usbother_base;\r\nusb_base = ioremap(MX51_USB_OTG_BASE_ADDR, SZ_4K);\r\nif (!usb_base)\r\nreturn -ENOMEM;\r\nusbother_base = usb_base + MX5_USBOTHER_REGS_OFFSET;\r\nv = __raw_readl(usbother_base + MX51_USB_CTRL_1_OFFSET);\r\n__raw_writel(v | MX51_USB_CTRL_UH1_EXT_CLK_EN,\r\nusbother_base + MX51_USB_CTRL_1_OFFSET);\r\niounmap(usb_base);\r\nmdelay(10);\r\nreturn mx51_initialize_usb_hw(1, MXC_EHCI_POWER_PINS_ENABLED |\r\nMXC_EHCI_ITC_NO_THRESHOLD);\r\n}\r\nstatic int __init eukrea_cpuimx51sd_otg_mode(char *options)\r\n{\r\nif (!strcmp(options, "host"))\r\notg_mode_host = true;\r\nelse if (!strcmp(options, "device"))\r\notg_mode_host = false;\r\nelse\r\npr_info("otg_mode neither \"host\" nor \"device\". "\r\n"Defaulting to device\n");\r\nreturn 1;\r\n}\r\nstatic void __init eukrea_cpuimx51sd_init(void)\r\n{\r\nimx51_soc_init();\r\nmxc_iomux_v3_setup_multiple_pads(eukrea_cpuimx51sd_pads,\r\nARRAY_SIZE(eukrea_cpuimx51sd_pads));\r\n#if defined(CONFIG_CPU_FREQ_IMX)\r\nget_cpu_op = mx51_get_cpu_op;\r\n#endif\r\nimx51_add_imx_uart(0, &uart_pdata);\r\nimx51_add_mxc_nand(&eukrea_cpuimx51sd_nand_board_info);\r\nimx51_add_imx2_wdt(0);\r\ngpio_request(ETH_RST, "eth_rst");\r\ngpio_set_value(ETH_RST, 1);\r\nimx51_add_fec(NULL);\r\ngpio_request(CAN_IRQGPIO, "can_irq");\r\ngpio_direction_input(CAN_IRQGPIO);\r\ngpio_free(CAN_IRQGPIO);\r\ngpio_request(CAN_NCS, "can_ncs");\r\ngpio_direction_output(CAN_NCS, 1);\r\ngpio_free(CAN_NCS);\r\ngpio_request(CAN_RST, "can_rst");\r\ngpio_direction_output(CAN_RST, 0);\r\nmsleep(20);\r\ngpio_set_value(CAN_RST, 1);\r\nimx51_add_ecspi(0, &cpuimx51sd_ecspi1_pdata);\r\ncpuimx51sd_spi_device[0].irq = gpio_to_irq(CAN_IRQGPIO);\r\nspi_register_board_info(cpuimx51sd_spi_device,\r\nARRAY_SIZE(cpuimx51sd_spi_device));\r\nif (mx51_revision() < IMX_CHIP_REVISION_3_0) {\r\neukrea_cpuimx51sd_i2c_devices[1].irq =\r\ngpio_to_irq(TSC2007_IRQGPIO_REV2),\r\nplatform_add_devices(rev2_platform_devices,\r\nARRAY_SIZE(rev2_platform_devices));\r\ngpio_request(TSC2007_IRQGPIO_REV2, "tsc2007_irq");\r\ngpio_direction_input(TSC2007_IRQGPIO_REV2);\r\ngpio_free(TSC2007_IRQGPIO_REV2);\r\n} else {\r\neukrea_cpuimx51sd_i2c_devices[1].irq =\r\ngpio_to_irq(TSC2007_IRQGPIO_REV3),\r\nimx51_add_imx_i2c(0, &cpuimx51sd_i2c_data);\r\ngpio_request(TSC2007_IRQGPIO_REV3, "tsc2007_irq");\r\ngpio_direction_input(TSC2007_IRQGPIO_REV3);\r\ngpio_free(TSC2007_IRQGPIO_REV3);\r\n}\r\ni2c_register_board_info(0, eukrea_cpuimx51sd_i2c_devices,\r\nARRAY_SIZE(eukrea_cpuimx51sd_i2c_devices));\r\nif (otg_mode_host)\r\nimx51_add_mxc_ehci_otg(&dr_utmi_config);\r\nelse {\r\ninitialize_otg_port(NULL);\r\nimx51_add_fsl_usb2_udc(&usb_pdata);\r\n}\r\ngpio_request(USBH1_RST, "usb_rst");\r\ngpio_direction_output(USBH1_RST, 0);\r\nmsleep(20);\r\ngpio_set_value(USBH1_RST, 1);\r\nimx51_add_mxc_ehci_hs(1, &usbh1_config);\r\n#ifdef CONFIG_MACH_EUKREA_MBIMXSD51_BASEBOARD\r\neukrea_mbimxsd51_baseboard_init();\r\n#endif\r\n}\r\nstatic void __init eukrea_cpuimx51sd_timer_init(void)\r\n{\r\nmx51_clocks_init(32768, 24000000, 22579200, 0);\r\n}

static void\r\n__xfrm6_init_tempsel(struct xfrm_selector *sel, const struct flowi *fl)\r\n{\r\nconst struct flowi6 *fl6 = &fl->u.ip6;\r\n*(struct in6_addr *)&sel->daddr = fl6->daddr;\r\n*(struct in6_addr *)&sel->saddr = fl6->saddr;\r\nsel->dport = xfrm_flowi_dport(fl, &fl6->uli);\r\nsel->dport_mask = htons(0xffff);\r\nsel->sport = xfrm_flowi_sport(fl, &fl6->uli);\r\nsel->sport_mask = htons(0xffff);\r\nsel->family = AF_INET6;\r\nsel->prefixlen_d = 128;\r\nsel->prefixlen_s = 128;\r\nsel->proto = fl6->flowi6_proto;\r\nsel->ifindex = fl6->flowi6_oif;\r\n}\r\nstatic void\r\nxfrm6_init_temprop(struct xfrm_state *x, const struct xfrm_tmpl *tmpl,\r\nconst xfrm_address_t *daddr, const xfrm_address_t *saddr)\r\n{\r\nx->id = tmpl->id;\r\nif (ipv6_addr_any((struct in6_addr*)&x->id.daddr))\r\nmemcpy(&x->id.daddr, daddr, sizeof(x->sel.daddr));\r\nmemcpy(&x->props.saddr, &tmpl->saddr, sizeof(x->props.saddr));\r\nif (ipv6_addr_any((struct in6_addr*)&x->props.saddr))\r\nmemcpy(&x->props.saddr, saddr, sizeof(x->props.saddr));\r\nx->props.mode = tmpl->mode;\r\nx->props.reqid = tmpl->reqid;\r\nx->props.family = AF_INET6;\r\n}\r\nstatic int\r\n__xfrm6_sort(void **dst, void **src, int n, int (*cmp)(void *p), int maxclass)\r\n{\r\nint i;\r\nint class[XFRM_MAX_DEPTH];\r\nint count[maxclass];\r\nmemset(count, 0, sizeof(count));\r\nfor (i = 0; i < n; i++) {\r\nint c;\r\nclass[i] = c = cmp(src[i]);\r\ncount[c]++;\r\n}\r\nfor (i = 2; i < maxclass; i++)\r\ncount[i] += count[i - 1];\r\nfor (i = 0; i < n; i++) {\r\ndst[count[class[i] - 1]++] = src[i];\r\nsrc[i] = NULL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __xfrm6_state_sort_cmp(void *p)\r\n{\r\nstruct xfrm_state *v = p;\r\nswitch (v->props.mode) {\r\ncase XFRM_MODE_TRANSPORT:\r\nif (v->id.proto != IPPROTO_AH)\r\nreturn 1;\r\nelse\r\nreturn 3;\r\n#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)\r\ncase XFRM_MODE_ROUTEOPTIMIZATION:\r\ncase XFRM_MODE_IN_TRIGGER:\r\nreturn 2;\r\n#endif\r\ncase XFRM_MODE_TUNNEL:\r\ncase XFRM_MODE_BEET:\r\nreturn 4;\r\n}\r\nreturn 5;\r\n}\r\nstatic int\r\n__xfrm6_state_sort(struct xfrm_state **dst, struct xfrm_state **src, int n)\r\n{\r\nreturn __xfrm6_sort((void **)dst, (void **)src, n,\r\n__xfrm6_state_sort_cmp, 6);\r\n}\r\nstatic int __xfrm6_tmpl_sort_cmp(void *p)\r\n{\r\nstruct xfrm_tmpl *v = p;\r\nswitch (v->mode) {\r\ncase XFRM_MODE_TRANSPORT:\r\nreturn 1;\r\n#if defined(CONFIG_IPV6_MIP6) || defined(CONFIG_IPV6_MIP6_MODULE)\r\ncase XFRM_MODE_ROUTEOPTIMIZATION:\r\ncase XFRM_MODE_IN_TRIGGER:\r\nreturn 2;\r\n#endif\r\ncase XFRM_MODE_TUNNEL:\r\ncase XFRM_MODE_BEET:\r\nreturn 3;\r\n}\r\nreturn 4;\r\n}\r\nstatic int\r\n__xfrm6_tmpl_sort(struct xfrm_tmpl **dst, struct xfrm_tmpl **src, int n)\r\n{\r\nreturn __xfrm6_sort((void **)dst, (void **)src, n,\r\n__xfrm6_tmpl_sort_cmp, 5);\r\n}\r\nint xfrm6_extract_header(struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr *iph = ipv6_hdr(skb);\r\nXFRM_MODE_SKB_CB(skb)->ihl = sizeof(*iph);\r\nXFRM_MODE_SKB_CB(skb)->id = 0;\r\nXFRM_MODE_SKB_CB(skb)->frag_off = htons(IP_DF);\r\nXFRM_MODE_SKB_CB(skb)->tos = ipv6_get_dsfield(iph);\r\nXFRM_MODE_SKB_CB(skb)->ttl = iph->hop_limit;\r\nXFRM_MODE_SKB_CB(skb)->optlen = 0;\r\nmemcpy(XFRM_MODE_SKB_CB(skb)->flow_lbl, iph->flow_lbl,\r\nsizeof(XFRM_MODE_SKB_CB(skb)->flow_lbl));\r\nreturn 0;\r\n}\r\nint __init xfrm6_state_init(void)\r\n{\r\nreturn xfrm_state_register_afinfo(&xfrm6_state_afinfo);\r\n}\r\nvoid xfrm6_state_fini(void)\r\n{\r\nxfrm_state_unregister_afinfo(&xfrm6_state_afinfo);\r\n}

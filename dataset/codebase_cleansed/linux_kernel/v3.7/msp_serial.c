static void msp_serial_out(struct uart_port *p, int offset, int value)\r\n{\r\nstruct msp_uart_data *d = p->private_data;\r\nif (offset == UART_LCR)\r\nd->last_lcr = value;\r\noffset <<= p->regshift;\r\nwriteb(value, p->membase + offset);\r\n}\r\nstatic unsigned int msp_serial_in(struct uart_port *p, int offset)\r\n{\r\noffset <<= p->regshift;\r\nreturn readb(p->membase + offset);\r\n}\r\nstatic int msp_serial_handle_irq(struct uart_port *p)\r\n{\r\nstruct msp_uart_data *d = p->private_data;\r\nunsigned int iir = readb(p->membase + (UART_IIR << p->regshift));\r\nif (serial8250_handle_irq(p, iir)) {\r\nreturn 1;\r\n} else if ((iir & UART_IIR_BUSY) == UART_IIR_BUSY) {\r\n(void)readb(p->membase + 0xc0);\r\nwriteb(d->last_lcr, p->membase + (UART_LCR << p->regshift));\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid __init msp_serial_setup(void)\r\n{\r\nchar *s;\r\nchar *endp;\r\nstruct uart_port up;\r\nunsigned int uartclk;\r\nmemset(&up, 0, sizeof(up));\r\ns = prom_getenv("uartfreqhz");\r\nif(!(s && *s && (uartclk = simple_strtoul(s, &endp, 10)) && *endp == 0))\r\nuartclk = MSP_BASE_BAUD;\r\nppfinit("UART clock set to %d\n", uartclk);\r\nup.mapbase = MSP_UART0_BASE;\r\nup.membase = ioremap_nocache(up.mapbase, MSP_UART_REG_LEN);\r\nup.irq = MSP_INT_UART0;\r\nup.uartclk = uartclk;\r\nup.regshift = 2;\r\nup.iotype = UPIO_MEM;\r\nup.flags = ASYNC_BOOT_AUTOCONF | ASYNC_SKIP_TEST;\r\nup.type = PORT_16550A;\r\nup.line = 0;\r\nup.serial_out = msp_serial_out;\r\nup.serial_in = msp_serial_in;\r\nup.handle_irq = msp_serial_handle_irq;\r\nup.private_data = kzalloc(sizeof(struct msp_uart_data), GFP_KERNEL);\r\nif (!up.private_data) {\r\npr_err("failed to allocate uart private data\n");\r\nreturn;\r\n}\r\nif (early_serial_setup(&up)) {\r\nkfree(up.private_data);\r\npr_err("Early serial init of port 0 failed\n");\r\n}\r\nswitch (mips_machtype) {\r\ncase MACH_MSP4200_EVAL:\r\ncase MACH_MSP4200_GW:\r\ncase MACH_MSP4200_FPGA:\r\ncase MACH_MSP7120_EVAL:\r\ncase MACH_MSP7120_GW:\r\ncase MACH_MSP7120_FPGA:\r\n*GPIO_CFG2_REG = 0x00002299;\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nup.mapbase = MSP_UART1_BASE;\r\nup.membase = ioremap_nocache(up.mapbase, MSP_UART_REG_LEN);\r\nup.irq = MSP_INT_UART1;\r\nup.line = 1;\r\nup.private_data = (void*)UART1_STATUS_REG;\r\nif (early_serial_setup(&up)) {\r\nkfree(up.private_data);\r\npr_err("Early serial init of port 1 failed\n");\r\n}\r\n}

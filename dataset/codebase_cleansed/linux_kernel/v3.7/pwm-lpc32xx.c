static int lpc32xx_pwm_config(struct pwm_chip *chip, struct pwm_device *pwm,\r\nint duty_ns, int period_ns)\r\n{\r\nstruct lpc32xx_pwm_chip *lpc32xx = to_lpc32xx_pwm_chip(chip);\r\nunsigned long long c;\r\nint period_cycles, duty_cycles;\r\nc = clk_get_rate(lpc32xx->clk) / 256;\r\nc = c * period_ns;\r\ndo_div(c, NSEC_PER_SEC);\r\nif (c == 0)\r\nc = 1;\r\nif (c > 255)\r\nc = 0;\r\nperiod_cycles = c;\r\nc = 256 * duty_ns;\r\ndo_div(c, period_ns);\r\nduty_cycles = c;\r\nwritel(PWM_ENABLE | PWM_RELOADV(period_cycles) | PWM_DUTY(duty_cycles),\r\nlpc32xx->base + (pwm->hwpwm << 2));\r\nreturn 0;\r\n}\r\nstatic int lpc32xx_pwm_enable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct lpc32xx_pwm_chip *lpc32xx = to_lpc32xx_pwm_chip(chip);\r\nreturn clk_enable(lpc32xx->clk);\r\n}\r\nstatic void lpc32xx_pwm_disable(struct pwm_chip *chip, struct pwm_device *pwm)\r\n{\r\nstruct lpc32xx_pwm_chip *lpc32xx = to_lpc32xx_pwm_chip(chip);\r\nwritel(0, lpc32xx->base + (pwm->hwpwm << 2));\r\nclk_disable(lpc32xx->clk);\r\n}\r\nstatic int lpc32xx_pwm_probe(struct platform_device *pdev)\r\n{\r\nstruct lpc32xx_pwm_chip *lpc32xx;\r\nstruct resource *res;\r\nint ret;\r\nlpc32xx = devm_kzalloc(&pdev->dev, sizeof(*lpc32xx), GFP_KERNEL);\r\nif (!lpc32xx)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -EINVAL;\r\nlpc32xx->base = devm_request_and_ioremap(&pdev->dev, res);\r\nif (!lpc32xx->base)\r\nreturn -EADDRNOTAVAIL;\r\nlpc32xx->clk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(lpc32xx->clk))\r\nreturn PTR_ERR(lpc32xx->clk);\r\nlpc32xx->chip.dev = &pdev->dev;\r\nlpc32xx->chip.ops = &lpc32xx_pwm_ops;\r\nlpc32xx->chip.npwm = 2;\r\nret = pwmchip_add(&lpc32xx->chip);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to add PWM chip, error %d\n", ret);\r\nreturn ret;\r\n}\r\nplatform_set_drvdata(pdev, lpc32xx);\r\nreturn 0;\r\n}\r\nstatic int __devexit lpc32xx_pwm_remove(struct platform_device *pdev)\r\n{\r\nstruct lpc32xx_pwm_chip *lpc32xx = platform_get_drvdata(pdev);\r\nclk_disable(lpc32xx->clk);\r\nreturn pwmchip_remove(&lpc32xx->chip);\r\n}

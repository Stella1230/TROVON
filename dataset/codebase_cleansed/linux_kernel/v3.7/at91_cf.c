static inline int at91_cf_present(struct at91_cf_socket *cf)\r\n{\r\nreturn !gpio_get_value(cf->board->det_pin);\r\n}\r\nstatic int at91_cf_ss_init(struct pcmcia_socket *s)\r\n{\r\nreturn 0;\r\n}\r\nstatic irqreturn_t at91_cf_irq(int irq, void *_cf)\r\n{\r\nstruct at91_cf_socket *cf = _cf;\r\nif (irq == gpio_to_irq(cf->board->det_pin)) {\r\nunsigned present = at91_cf_present(cf);\r\nif (present != cf->present) {\r\ncf->present = present;\r\npr_debug("%s: card %s\n", driver_name,\r\npresent ? "present" : "gone");\r\npcmcia_parse_events(&cf->socket, SS_DETECT);\r\n}\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int at91_cf_get_status(struct pcmcia_socket *s, u_int *sp)\r\n{\r\nstruct at91_cf_socket *cf;\r\nif (!sp)\r\nreturn -EINVAL;\r\ncf = container_of(s, struct at91_cf_socket, socket);\r\nif (at91_cf_present(cf)) {\r\nint rdy = gpio_is_valid(cf->board->irq_pin);\r\nint vcc = gpio_is_valid(cf->board->vcc_pin);\r\n*sp = SS_DETECT | SS_3VCARD;\r\nif (!rdy || gpio_get_value(rdy))\r\n*sp |= SS_READY;\r\nif (!vcc || gpio_get_value(vcc))\r\n*sp |= SS_POWERON;\r\n} else\r\n*sp = 0;\r\nreturn 0;\r\n}\r\nstatic int\r\nat91_cf_set_socket(struct pcmcia_socket *sock, struct socket_state_t *s)\r\n{\r\nstruct at91_cf_socket *cf;\r\ncf = container_of(sock, struct at91_cf_socket, socket);\r\nif (gpio_is_valid(cf->board->vcc_pin)) {\r\nswitch (s->Vcc) {\r\ncase 0:\r\ngpio_set_value(cf->board->vcc_pin, 0);\r\nbreak;\r\ncase 33:\r\ngpio_set_value(cf->board->vcc_pin, 1);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\ngpio_set_value(cf->board->rst_pin, s->flags & SS_RESET);\r\npr_debug("%s: Vcc %d, io_irq %d, flags %04x csc %04x\n",\r\ndriver_name, s->Vcc, s->io_irq, s->flags, s->csc_mask);\r\nreturn 0;\r\n}\r\nstatic int at91_cf_ss_suspend(struct pcmcia_socket *s)\r\n{\r\nreturn at91_cf_set_socket(s, &dead_socket);\r\n}\r\nstatic int at91_cf_set_io_map(struct pcmcia_socket *s, struct pccard_io_map *io)\r\n{\r\nstruct at91_cf_socket *cf;\r\nu32 csr;\r\ncf = container_of(s, struct at91_cf_socket, socket);\r\nio->flags &= (MAP_ACTIVE | MAP_16BIT | MAP_AUTOSZ);\r\ncsr = at91_ramc_read(0, AT91_SMC_CSR(cf->board->chipselect)) & ~AT91_SMC_DBW;\r\nif (!(io->flags & (MAP_16BIT | MAP_AUTOSZ))) {\r\ncsr |= AT91_SMC_DBW_8;\r\npr_debug("%s: 8bit i/o bus\n", driver_name);\r\n} else {\r\ncsr |= AT91_SMC_DBW_16;\r\npr_debug("%s: 16bit i/o bus\n", driver_name);\r\n}\r\nat91_ramc_write(0, AT91_SMC_CSR(cf->board->chipselect), csr);\r\nio->start = cf->socket.io_offset;\r\nio->stop = io->start + SZ_2K - 1;\r\nreturn 0;\r\n}\r\nstatic int\r\nat91_cf_set_mem_map(struct pcmcia_socket *s, struct pccard_mem_map *map)\r\n{\r\nstruct at91_cf_socket *cf;\r\nif (map->card_start)\r\nreturn -EINVAL;\r\ncf = container_of(s, struct at91_cf_socket, socket);\r\nmap->flags &= (MAP_ACTIVE | MAP_ATTRIB | MAP_16BIT);\r\nif (map->flags & MAP_ATTRIB)\r\nmap->static_start = cf->phys_baseaddr + CF_ATTR_PHYS;\r\nelse\r\nmap->static_start = cf->phys_baseaddr + CF_MEM_PHYS;\r\nreturn 0;\r\n}\r\nstatic int __init at91_cf_probe(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_socket *cf;\r\nstruct at91_cf_data *board = pdev->dev.platform_data;\r\nstruct resource *io;\r\nint status;\r\nif (!board || !gpio_is_valid(board->det_pin) || !gpio_is_valid(board->rst_pin))\r\nreturn -ENODEV;\r\nio = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!io)\r\nreturn -ENODEV;\r\ncf = kzalloc(sizeof *cf, GFP_KERNEL);\r\nif (!cf)\r\nreturn -ENOMEM;\r\ncf->board = board;\r\ncf->pdev = pdev;\r\ncf->phys_baseaddr = io->start;\r\nplatform_set_drvdata(pdev, cf);\r\nstatus = gpio_request(board->det_pin, "cf_det");\r\nif (status < 0)\r\ngoto fail0;\r\nstatus = request_irq(gpio_to_irq(board->det_pin), at91_cf_irq, 0, driver_name, cf);\r\nif (status < 0)\r\ngoto fail00;\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nstatus = gpio_request(board->rst_pin, "cf_rst");\r\nif (status < 0)\r\ngoto fail0a;\r\nif (gpio_is_valid(board->vcc_pin)) {\r\nstatus = gpio_request(board->vcc_pin, "cf_vcc");\r\nif (status < 0)\r\ngoto fail0b;\r\n}\r\nif (gpio_is_valid(board->irq_pin)) {\r\nstatus = gpio_request(board->irq_pin, "cf_irq");\r\nif (status < 0)\r\ngoto fail0c;\r\nstatus = request_irq(gpio_to_irq(board->irq_pin), at91_cf_irq,\r\nIRQF_SHARED, driver_name, cf);\r\nif (status < 0)\r\ngoto fail0d;\r\ncf->socket.pci_irq = gpio_to_irq(board->irq_pin);\r\n} else\r\ncf->socket.pci_irq = nr_irqs + 1;\r\ncf->socket.io_offset = (unsigned long)\r\nioremap(cf->phys_baseaddr + CF_IO_PHYS, SZ_2K);\r\nif (!cf->socket.io_offset) {\r\nstatus = -ENXIO;\r\ngoto fail1;\r\n}\r\nif (!request_mem_region(io->start, resource_size(io), driver_name)) {\r\nstatus = -ENXIO;\r\ngoto fail1;\r\n}\r\npr_info("%s: irqs det #%d, io #%d\n", driver_name,\r\ngpio_to_irq(board->det_pin), gpio_to_irq(board->irq_pin));\r\ncf->socket.owner = THIS_MODULE;\r\ncf->socket.dev.parent = &pdev->dev;\r\ncf->socket.ops = &at91_cf_ops;\r\ncf->socket.resource_ops = &pccard_static_ops;\r\ncf->socket.features = SS_CAP_PCCARD | SS_CAP_STATIC_MAP\r\n| SS_CAP_MEM_ALIGN;\r\ncf->socket.map_size = SZ_2K;\r\ncf->socket.io[0].res = io;\r\nstatus = pcmcia_register_socket(&cf->socket);\r\nif (status < 0)\r\ngoto fail2;\r\nreturn 0;\r\nfail2:\r\nrelease_mem_region(io->start, resource_size(io));\r\nfail1:\r\nif (cf->socket.io_offset)\r\niounmap((void __iomem *) cf->socket.io_offset);\r\nif (gpio_is_valid(board->irq_pin)) {\r\nfree_irq(gpio_to_irq(board->irq_pin), cf);\r\nfail0d:\r\ngpio_free(board->irq_pin);\r\n}\r\nfail0c:\r\nif (gpio_is_valid(board->vcc_pin))\r\ngpio_free(board->vcc_pin);\r\nfail0b:\r\ngpio_free(board->rst_pin);\r\nfail0a:\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nfree_irq(gpio_to_irq(board->det_pin), cf);\r\nfail00:\r\ngpio_free(board->det_pin);\r\nfail0:\r\nkfree(cf);\r\nreturn status;\r\n}\r\nstatic int __exit at91_cf_remove(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_socket *cf = platform_get_drvdata(pdev);\r\nstruct at91_cf_data *board = cf->board;\r\nstruct resource *io = cf->socket.io[0].res;\r\npcmcia_unregister_socket(&cf->socket);\r\nrelease_mem_region(io->start, resource_size(io));\r\niounmap((void __iomem *) cf->socket.io_offset);\r\nif (gpio_is_valid(board->irq_pin)) {\r\nfree_irq(gpio_to_irq(board->irq_pin), cf);\r\ngpio_free(board->irq_pin);\r\n}\r\nif (gpio_is_valid(board->vcc_pin))\r\ngpio_free(board->vcc_pin);\r\ngpio_free(board->rst_pin);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\nfree_irq(gpio_to_irq(board->det_pin), cf);\r\ngpio_free(board->det_pin);\r\nkfree(cf);\r\nreturn 0;\r\n}\r\nstatic int at91_cf_suspend(struct platform_device *pdev, pm_message_t mesg)\r\n{\r\nstruct at91_cf_socket *cf = platform_get_drvdata(pdev);\r\nstruct at91_cf_data *board = cf->board;\r\nif (device_may_wakeup(&pdev->dev)) {\r\nenable_irq_wake(gpio_to_irq(board->det_pin));\r\nif (gpio_is_valid(board->irq_pin))\r\nenable_irq_wake(gpio_to_irq(board->irq_pin));\r\n}\r\nreturn 0;\r\n}\r\nstatic int at91_cf_resume(struct platform_device *pdev)\r\n{\r\nstruct at91_cf_socket *cf = platform_get_drvdata(pdev);\r\nstruct at91_cf_data *board = cf->board;\r\nif (device_may_wakeup(&pdev->dev)) {\r\ndisable_irq_wake(gpio_to_irq(board->det_pin));\r\nif (gpio_is_valid(board->irq_pin))\r\ndisable_irq_wake(gpio_to_irq(board->irq_pin));\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init at91_cf_init(void)\r\n{\r\nreturn platform_driver_probe(&at91_cf_driver, at91_cf_probe);\r\n}\r\nstatic void __exit at91_cf_exit(void)\r\n{\r\nplatform_driver_unregister(&at91_cf_driver);\r\n}

static void spear_start_ehci(struct spear_ehci *ehci)\r\n{\r\nclk_prepare_enable(ehci->clk);\r\n}\r\nstatic void spear_stop_ehci(struct spear_ehci *ehci)\r\n{\r\nclk_disable_unprepare(ehci->clk);\r\n}\r\nstatic int ehci_spear_setup(struct usb_hcd *hcd)\r\n{\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nint retval = 0;\r\nehci->caps = hcd->regs;\r\nretval = ehci_setup(hcd);\r\nif (retval)\r\nreturn retval;\r\nehci_port_power(ehci, 0);\r\nreturn retval;\r\n}\r\nstatic int ehci_spear_drv_suspend(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nbool do_wakeup = device_may_wakeup(dev);\r\nreturn ehci_suspend(hcd, do_wakeup);\r\n}\r\nstatic int ehci_spear_drv_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nehci_resume(hcd, false);\r\nreturn 0;\r\n}\r\nstatic int spear_ehci_hcd_drv_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd ;\r\nstruct spear_ehci *ehci;\r\nstruct resource *res;\r\nstruct clk *usbh_clk;\r\nconst struct hc_driver *driver = &ehci_spear_hc_driver;\r\nint irq, retval;\r\nchar clk_name[20] = "usbh_clk";\r\nstatic int instance = -1;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nretval = irq;\r\ngoto fail_irq_get;\r\n}\r\nif (!pdev->dev.dma_mask)\r\npdev->dev.dma_mask = &spear_ehci_dma_mask;\r\nif (pdev->id < 0)\r\ninstance++;\r\nelse\r\ninstance = pdev->id;\r\nsprintf(clk_name, "usbh.%01d_clk", instance);\r\nusbh_clk = clk_get(NULL, clk_name);\r\nif (IS_ERR(usbh_clk)) {\r\ndev_err(&pdev->dev, "Error getting interface clock\n");\r\nretval = PTR_ERR(usbh_clk);\r\ngoto fail_get_usbh_clk;\r\n}\r\nhcd = usb_create_hcd(driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\nretval = -ENOMEM;\r\ngoto fail_create_hcd;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\nretval = -ENODEV;\r\ngoto fail_request_resource;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len,\r\ndriver->description)) {\r\nretval = -EBUSY;\r\ngoto fail_request_resource;\r\n}\r\nhcd->regs = ioremap(hcd->rsrc_start, hcd->rsrc_len);\r\nif (hcd->regs == NULL) {\r\ndev_dbg(&pdev->dev, "error mapping memory\n");\r\nretval = -ENOMEM;\r\ngoto fail_ioremap;\r\n}\r\nehci = (struct spear_ehci *)hcd_to_ehci(hcd);\r\nehci->clk = usbh_clk;\r\nspear_start_ehci(ehci);\r\nretval = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (retval)\r\ngoto fail_add_hcd;\r\nreturn retval;\r\nfail_add_hcd:\r\nspear_stop_ehci(ehci);\r\niounmap(hcd->regs);\r\nfail_ioremap:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nfail_request_resource:\r\nusb_put_hcd(hcd);\r\nfail_create_hcd:\r\nclk_put(usbh_clk);\r\nfail_get_usbh_clk:\r\nfail_irq_get:\r\ndev_err(&pdev->dev, "init fail, %d\n", retval);\r\nreturn retval ;\r\n}\r\nstatic int spear_ehci_hcd_drv_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\nstruct spear_ehci *ehci_p = to_spear_ehci(hcd);\r\nif (!hcd)\r\nreturn 0;\r\nif (in_interrupt())\r\nBUG();\r\nusb_remove_hcd(hcd);\r\nif (ehci_p->clk)\r\nspear_stop_ehci(ehci_p);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nif (ehci_p->clk)\r\nclk_put(ehci_p->clk);\r\nreturn 0;\r\n}

static inline unsigned long flash_bank_setup(struct map_info *map, unsigned long ofs)\r\n{\r\nunsigned long (*set_bank)(unsigned long) =\r\n(unsigned long(*)(unsigned long))map->map_priv_2;\r\nreturn (set_bank ? set_bank(ofs) : ofs);\r\n}\r\nstatic inline unsigned long address_fix8_write(unsigned long addr)\r\n{\r\nif (erratum44_workaround) {\r\nreturn (addr ^ 3);\r\n}\r\nreturn addr;\r\n}\r\nstatic map_word ixp2000_flash_read8(struct map_info *map, unsigned long ofs)\r\n{\r\nmap_word val;\r\nval.x[0] = *((u8 *)(map->map_priv_1 + flash_bank_setup(map, ofs)));\r\nreturn val;\r\n}\r\nstatic void ixp2000_flash_copy_from(struct map_info *map, void *to,\r\nunsigned long from, ssize_t len)\r\n{\r\nfrom = flash_bank_setup(map, from);\r\nwhile(len--)\r\n*(__u8 *) to++ = *(__u8 *)(map->map_priv_1 + from++);\r\n}\r\nstatic void ixp2000_flash_write8(struct map_info *map, map_word d, unsigned long ofs)\r\n{\r\n*(__u8 *) (address_fix8_write(map->map_priv_1 +\r\nflash_bank_setup(map, ofs))) = d.x[0];\r\n}\r\nstatic void ixp2000_flash_copy_to(struct map_info *map, unsigned long to,\r\nconst void *from, ssize_t len)\r\n{\r\nto = flash_bank_setup(map, to);\r\nwhile(len--) {\r\nunsigned long tmp = address_fix8_write(map->map_priv_1 + to++);\r\n*(__u8 *)(tmp) = *(__u8 *)(from++);\r\n}\r\n}\r\nstatic int ixp2000_flash_remove(struct platform_device *dev)\r\n{\r\nstruct flash_platform_data *plat = dev->dev.platform_data;\r\nstruct ixp2000_flash_info *info = platform_get_drvdata(dev);\r\nplatform_set_drvdata(dev, NULL);\r\nif(!info)\r\nreturn 0;\r\nif (info->mtd) {\r\nmtd_device_unregister(info->mtd);\r\nmap_destroy(info->mtd);\r\n}\r\nif (info->map.map_priv_1)\r\niounmap((void *) info->map.map_priv_1);\r\nif (info->res) {\r\nrelease_resource(info->res);\r\nkfree(info->res);\r\n}\r\nif (plat->exit)\r\nplat->exit();\r\nreturn 0;\r\n}\r\nstatic int ixp2000_flash_probe(struct platform_device *dev)\r\n{\r\nstatic const char *probes[] = { "RedBoot", "cmdlinepart", NULL };\r\nstruct ixp2000_flash_data *ixp_data = dev->dev.platform_data;\r\nstruct flash_platform_data *plat;\r\nstruct ixp2000_flash_info *info;\r\nunsigned long window_size;\r\nint err = -1;\r\nif (!ixp_data)\r\nreturn -ENODEV;\r\nplat = ixp_data->platform_data;\r\nif (!plat)\r\nreturn -ENODEV;\r\nwindow_size = resource_size(dev->resource);\r\ndev_info(&dev->dev, "Probe of IXP2000 flash(%d banks x %dMiB)\n",\r\nixp_data->nr_banks, ((u32)window_size >> 20));\r\nif (plat->width != 1) {\r\ndev_err(&dev->dev, "IXP2000 MTD map only supports 8-bit mode, asking for %d\n",\r\nplat->width * 8);\r\nreturn -EIO;\r\n}\r\ninfo = kzalloc(sizeof(struct ixp2000_flash_info), GFP_KERNEL);\r\nif(!info) {\r\nerr = -ENOMEM;\r\ngoto Error;\r\n}\r\nplatform_set_drvdata(dev, info);\r\ninfo->map.phys = NO_XIP;\r\ninfo->map.size = ixp_data->nr_banks * window_size;\r\ninfo->map.bankwidth = 1;\r\ninfo->map.map_priv_2 = (unsigned long) ixp_data->bank_setup;\r\ninfo->map.name = dev_name(&dev->dev);\r\ninfo->map.read = ixp2000_flash_read8;\r\ninfo->map.write = ixp2000_flash_write8;\r\ninfo->map.copy_from = ixp2000_flash_copy_from;\r\ninfo->map.copy_to = ixp2000_flash_copy_to;\r\ninfo->res = request_mem_region(dev->resource->start,\r\nresource_size(dev->resource),\r\ndev_name(&dev->dev));\r\nif (!info->res) {\r\ndev_err(&dev->dev, "Could not reserve memory region\n");\r\nerr = -ENOMEM;\r\ngoto Error;\r\n}\r\ninfo->map.map_priv_1 =\r\n(unsigned long)ioremap(dev->resource->start,\r\nresource_size(dev->resource));\r\nif (!info->map.map_priv_1) {\r\ndev_err(&dev->dev, "Failed to ioremap flash region\n");\r\nerr = -EIO;\r\ngoto Error;\r\n}\r\n#if defined(__ARMEB__)\r\nerratum44_workaround = ixp2000_has_broken_slowport();\r\ndev_info(&dev->dev, "Erratum 44 workaround %s\n",\r\nerratum44_workaround ? "enabled" : "disabled");\r\n#endif\r\ninfo->mtd = do_map_probe(plat->map_name, &info->map);\r\nif (!info->mtd) {\r\ndev_err(&dev->dev, "map_probe failed\n");\r\nerr = -ENXIO;\r\ngoto Error;\r\n}\r\ninfo->mtd->owner = THIS_MODULE;\r\nerr = mtd_device_parse_register(info->mtd, probes, NULL, NULL, 0);\r\nif (err)\r\ngoto Error;\r\nreturn 0;\r\nError:\r\nixp2000_flash_remove(dev);\r\nreturn err;\r\n}

static int scsi_dev_type_suspend(struct device *dev, pm_message_t msg)\r\n{\r\nstruct device_driver *drv;\r\nint err;\r\nerr = scsi_device_quiesce(to_scsi_device(dev));\r\nif (err == 0) {\r\ndrv = dev->driver;\r\nif (drv && drv->suspend) {\r\nerr = drv->suspend(dev, msg);\r\nif (err)\r\nscsi_device_resume(to_scsi_device(dev));\r\n}\r\n}\r\ndev_dbg(dev, "scsi suspend: %d\n", err);\r\nreturn err;\r\n}\r\nstatic int scsi_dev_type_resume(struct device *dev)\r\n{\r\nstruct device_driver *drv;\r\nint err = 0;\r\ndrv = dev->driver;\r\nif (drv && drv->resume)\r\nerr = drv->resume(dev);\r\nscsi_device_resume(to_scsi_device(dev));\r\ndev_dbg(dev, "scsi resume: %d\n", err);\r\nreturn err;\r\n}\r\nstatic int scsi_bus_suspend_common(struct device *dev, pm_message_t msg)\r\n{\r\nint err = 0;\r\nif (scsi_is_sdev_device(dev)) {\r\nif (pm_runtime_suspended(dev)) {\r\nif (msg.event == PM_EVENT_SUSPEND ||\r\nmsg.event == PM_EVENT_HIBERNATE)\r\nreturn 0;\r\npm_runtime_resume(dev);\r\n}\r\nerr = scsi_dev_type_suspend(dev, msg);\r\n}\r\nreturn err;\r\n}\r\nstatic int scsi_bus_resume_common(struct device *dev)\r\n{\r\nint err = 0;\r\npm_runtime_get_sync(dev->parent);\r\nif (scsi_is_sdev_device(dev))\r\nerr = scsi_dev_type_resume(dev);\r\nif (err == 0) {\r\npm_runtime_disable(dev);\r\npm_runtime_set_active(dev);\r\npm_runtime_enable(dev);\r\n}\r\npm_runtime_put_sync(dev->parent);\r\nreturn err;\r\n}\r\nstatic int scsi_bus_prepare(struct device *dev)\r\n{\r\nif (scsi_is_sdev_device(dev)) {\r\nasync_synchronize_full_domain(&scsi_sd_probe_domain);\r\n} else if (scsi_is_host_device(dev)) {\r\nscsi_complete_async_scans();\r\n}\r\nreturn 0;\r\n}\r\nstatic int scsi_bus_suspend(struct device *dev)\r\n{\r\nreturn scsi_bus_suspend_common(dev, PMSG_SUSPEND);\r\n}\r\nstatic int scsi_bus_freeze(struct device *dev)\r\n{\r\nreturn scsi_bus_suspend_common(dev, PMSG_FREEZE);\r\n}\r\nstatic int scsi_bus_poweroff(struct device *dev)\r\n{\r\nreturn scsi_bus_suspend_common(dev, PMSG_HIBERNATE);\r\n}\r\nstatic int scsi_runtime_suspend(struct device *dev)\r\n{\r\nint err = 0;\r\ndev_dbg(dev, "scsi_runtime_suspend\n");\r\nif (scsi_is_sdev_device(dev)) {\r\nerr = scsi_dev_type_suspend(dev, PMSG_AUTO_SUSPEND);\r\nif (err == -EAGAIN)\r\npm_schedule_suspend(dev, jiffies_to_msecs(\r\nround_jiffies_up_relative(HZ/10)));\r\n}\r\nreturn err;\r\n}\r\nstatic int scsi_runtime_resume(struct device *dev)\r\n{\r\nint err = 0;\r\ndev_dbg(dev, "scsi_runtime_resume\n");\r\nif (scsi_is_sdev_device(dev))\r\nerr = scsi_dev_type_resume(dev);\r\nreturn err;\r\n}\r\nstatic int scsi_runtime_idle(struct device *dev)\r\n{\r\nint err;\r\ndev_dbg(dev, "scsi_runtime_idle\n");\r\nif (scsi_is_sdev_device(dev))\r\nerr = pm_schedule_suspend(dev, 100);\r\nelse\r\nerr = pm_runtime_suspend(dev);\r\nreturn err;\r\n}\r\nint scsi_autopm_get_device(struct scsi_device *sdev)\r\n{\r\nint err;\r\nerr = pm_runtime_get_sync(&sdev->sdev_gendev);\r\nif (err < 0 && err !=-EACCES)\r\npm_runtime_put_sync(&sdev->sdev_gendev);\r\nelse\r\nerr = 0;\r\nreturn err;\r\n}\r\nvoid scsi_autopm_put_device(struct scsi_device *sdev)\r\n{\r\npm_runtime_put_sync(&sdev->sdev_gendev);\r\n}\r\nvoid scsi_autopm_get_target(struct scsi_target *starget)\r\n{\r\npm_runtime_get_sync(&starget->dev);\r\n}\r\nvoid scsi_autopm_put_target(struct scsi_target *starget)\r\n{\r\npm_runtime_put_sync(&starget->dev);\r\n}\r\nint scsi_autopm_get_host(struct Scsi_Host *shost)\r\n{\r\nint err;\r\nerr = pm_runtime_get_sync(&shost->shost_gendev);\r\nif (err < 0 && err !=-EACCES)\r\npm_runtime_put_sync(&shost->shost_gendev);\r\nelse\r\nerr = 0;\r\nreturn err;\r\n}\r\nvoid scsi_autopm_put_host(struct Scsi_Host *shost)\r\n{\r\npm_runtime_put_sync(&shost->shost_gendev);\r\n}

CsrMsgConvPrimEntry *CsrMsgConvFind(u16 primType)\r\n{\r\nCsrMsgConvPrimEntry *ptr = NULL;\r\nif (converter)\r\n{\r\nptr = converter->profile_converters;\r\nwhile (ptr)\r\n{\r\nif (ptr->primType == primType)\r\n{\r\nbreak;\r\n}\r\nelse\r\n{\r\nptr = ptr->next;\r\n}\r\n}\r\n}\r\nreturn ptr;\r\n}\r\nstatic const CsrMsgConvMsgEntry *find_msg_converter(CsrMsgConvPrimEntry *ptr, u16 msgType)\r\n{\r\nconst CsrMsgConvMsgEntry *cv = ptr->conv;\r\nif (ptr->lookupFunc)\r\n{\r\nreturn (const CsrMsgConvMsgEntry *) ptr->lookupFunc((CsrMsgConvMsgEntry *) cv, msgType);\r\n}\r\nwhile (cv)\r\n{\r\nif (cv->serFunc == NULL)\r\n{\r\ncv = NULL;\r\nbreak;\r\n}\r\nif (cv->msgType == msgType)\r\n{\r\nbreak;\r\n}\r\nelse\r\n{\r\ncv++;\r\n}\r\n}\r\nreturn cv;\r\n}\r\nstatic void *deserialize_data(u16 primType,\r\nsize_t length,\r\nu8 *data)\r\n{\r\nCsrMsgConvPrimEntry *ptr;\r\nu8 *ret;\r\nptr = CsrMsgConvFind(primType);\r\nif (ptr)\r\n{\r\nconst CsrMsgConvMsgEntry *cv;\r\nu16 msgId = 0;\r\nsize_t offset = 0;\r\nCsrUint16Des(&msgId, data, &offset);\r\ncv = find_msg_converter(ptr, msgId);\r\nif (cv)\r\n{\r\nret = cv->deserFunc(data, length);\r\n}\r\nelse\r\n{\r\nret = NULL;\r\n}\r\n}\r\nelse\r\n{\r\nret = NULL;\r\n}\r\nreturn ret;\r\n}\r\nstatic size_t sizeof_message(u16 primType, void *msg)\r\n{\r\nCsrMsgConvPrimEntry *ptr = CsrMsgConvFind(primType);\r\nsize_t ret;\r\nif (ptr)\r\n{\r\nconst CsrMsgConvMsgEntry *cv;\r\nu16 msgId = *(u16 *) msg;\r\ncv = find_msg_converter(ptr, msgId);\r\nif (cv)\r\n{\r\nret = cv->sizeofFunc(msg);\r\n}\r\nelse\r\n{\r\nret = 0;\r\n}\r\n}\r\nelse\r\n{\r\nret = 0;\r\n}\r\nreturn ret;\r\n}\r\nstatic u8 free_message(u16 primType, u8 *data)\r\n{\r\nCsrMsgConvPrimEntry *ptr;\r\nu8 ret;\r\nptr = CsrMsgConvFind(primType);\r\nif (ptr)\r\n{\r\nconst CsrMsgConvMsgEntry *cv;\r\nu16 msgId = *(u16 *) data;\r\ncv = find_msg_converter(ptr, msgId);\r\nif (cv)\r\n{\r\ncv->freeFunc(data);\r\nret = TRUE;\r\n}\r\nelse\r\n{\r\nret = FALSE;\r\n}\r\n}\r\nelse\r\n{\r\nret = FALSE;\r\n}\r\nreturn ret;\r\n}\r\nstatic u8 *serialize_message(u16 primType,\r\nvoid *msg,\r\nsize_t *length,\r\nu8 *buffer)\r\n{\r\nCsrMsgConvPrimEntry *ptr;\r\nu8 *ret;\r\nptr = CsrMsgConvFind(primType);\r\n*length = 0;\r\nif (ptr)\r\n{\r\nconst CsrMsgConvMsgEntry *cv;\r\ncv = find_msg_converter(ptr, *(u16 *) msg);\r\nif (cv)\r\n{\r\nret = cv->serFunc(buffer, length, msg);\r\n}\r\nelse\r\n{\r\nret = NULL;\r\n}\r\n}\r\nelse\r\n{\r\nret = NULL;\r\n}\r\nreturn ret;\r\n}\r\nsize_t CsrMsgConvSizeof(u16 primType, void *msg)\r\n{\r\nreturn sizeof_message(primType, msg);\r\n}\r\nu8 *CsrMsgConvSerialize(u8 *buffer, size_t maxBufferOffset, size_t *offset, u16 primType, void *msg)\r\n{\r\nif (converter)\r\n{\r\nsize_t serializedLength;\r\nu8 *bufSerialized;\r\nu8 *bufOffset = &buffer[*offset];\r\nbufSerialized = converter->serialize_message(primType, msg, &serializedLength, bufOffset);\r\n*offset += serializedLength;\r\nreturn bufSerialized;\r\n}\r\nelse\r\n{\r\nreturn NULL;\r\n}\r\n}\r\nvoid CsrMsgConvInsert(u16 primType, const CsrMsgConvMsgEntry *ce)\r\n{\r\nCsrMsgConvPrimEntry *pc;\r\npc = CsrMsgConvFind(primType);\r\nif (pc)\r\n{\r\n}\r\nelse\r\n{\r\npc = kmalloc(sizeof(*pc), GFP_KERNEL);\r\npc->primType = primType;\r\npc->conv = ce;\r\npc->lookupFunc = NULL;\r\npc->next = converter->profile_converters;\r\nconverter->profile_converters = pc;\r\n}\r\n}\r\nCsrMsgConvMsgEntry *CsrMsgConvFindEntry(u16 primType, u16 msgType)\r\n{\r\nCsrMsgConvPrimEntry *ptr = CsrMsgConvFind(primType);\r\nif (ptr)\r\n{\r\nreturn (CsrMsgConvMsgEntry *) find_msg_converter(ptr, msgType);\r\n}\r\nreturn NULL;\r\n}\r\nCsrMsgConvMsgEntry *CsrMsgConvFindEntryByMsg(u16 primType, const void *msg)\r\n{\r\nCsrMsgConvPrimEntry *ptr = CsrMsgConvFind(primType);\r\nif (ptr && msg)\r\n{\r\nu16 msgType = *((u16 *) msg);\r\nreturn (CsrMsgConvMsgEntry *) find_msg_converter(ptr, msgType);\r\n}\r\nreturn NULL;\r\n}\r\nvoid CsrMsgConvCustomLookupRegister(u16 primType, CsrMsgCustomLookupFunc *lookupFunc)\r\n{\r\nCsrMsgConvPrimEntry *ptr = CsrMsgConvFind(primType);\r\nif (ptr)\r\n{\r\nptr->lookupFunc = lookupFunc;\r\n}\r\n}\r\nCsrMsgConvEntry *CsrMsgConvInit(void)\r\n{\r\nif (!converter)\r\n{\r\nconverter = kmalloc(sizeof(CsrMsgConvEntry), GFP_KERNEL);\r\nconverter->profile_converters = NULL;\r\nconverter->free_message = free_message;\r\nconverter->sizeof_message = sizeof_message;\r\nconverter->serialize_message = serialize_message;\r\nconverter->deserialize_data = deserialize_data;\r\n}\r\nreturn converter;\r\n}

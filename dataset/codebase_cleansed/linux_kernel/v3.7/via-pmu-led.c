static void pmu_req_done(struct adb_request * req)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pmu_blink_lock, flags);\r\nif (requested_change != -1 && !pmu_sys_suspended)\r\npmu_request(&pmu_blink_req, NULL, 4, 0xee, 4, 0, requested_change);\r\nrequested_change = -1;\r\nspin_unlock_irqrestore(&pmu_blink_lock, flags);\r\n}\r\nstatic void pmu_led_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&pmu_blink_lock, flags);\r\nswitch (brightness) {\r\ncase LED_OFF:\r\nrequested_change = 0;\r\nbreak;\r\ncase LED_FULL:\r\nrequested_change = 1;\r\nbreak;\r\ndefault:\r\ngoto out;\r\nbreak;\r\n}\r\nif (pmu_blink_req.complete && !pmu_sys_suspended)\r\npmu_request(&pmu_blink_req, NULL, 4, 0xee, 4, 0, requested_change);\r\nout:\r\nspin_unlock_irqrestore(&pmu_blink_lock, flags);\r\n}\r\nstatic int __init via_pmu_led_init(void)\r\n{\r\nstruct device_node *dt;\r\nconst char *model;\r\nif (pmu_get_model() != PMU_KEYLARGO_BASED)\r\nreturn -ENODEV;\r\ndt = of_find_node_by_path("/");\r\nif (dt == NULL)\r\nreturn -ENODEV;\r\nmodel = of_get_property(dt, "model", NULL);\r\nif (model == NULL) {\r\nof_node_put(dt);\r\nreturn -ENODEV;\r\n}\r\nif (strncmp(model, "PowerBook", strlen("PowerBook")) != 0 &&\r\nstrncmp(model, "iBook", strlen("iBook")) != 0 &&\r\nstrcmp(model, "PowerMac7,2") != 0 &&\r\nstrcmp(model, "PowerMac7,3") != 0) {\r\nof_node_put(dt);\r\nreturn -ENODEV;\r\n}\r\nof_node_put(dt);\r\nspin_lock_init(&pmu_blink_lock);\r\npmu_blink_req.complete = 1;\r\npmu_blink_req.done = pmu_req_done;\r\nreturn led_classdev_register(NULL, &pmu_led);\r\n}

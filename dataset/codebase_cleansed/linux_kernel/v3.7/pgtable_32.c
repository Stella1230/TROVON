void set_pte_vaddr(unsigned long vaddr, pte_t pteval)\r\n{\r\npgd_t *pgd;\r\npud_t *pud;\r\npmd_t *pmd;\r\npte_t *pte;\r\npgd = swapper_pg_dir + pgd_index(vaddr);\r\nif (pgd_none(*pgd)) {\r\nBUG();\r\nreturn;\r\n}\r\npud = pud_offset(pgd, vaddr);\r\nif (pud_none(*pud)) {\r\nBUG();\r\nreturn;\r\n}\r\npmd = pmd_offset(pud, vaddr);\r\nif (pmd_none(*pmd)) {\r\nBUG();\r\nreturn;\r\n}\r\npte = pte_offset_kernel(pmd, vaddr);\r\nif (pte_val(pteval))\r\nset_pte_at(&init_mm, vaddr, pte, pteval);\r\nelse\r\npte_clear(&init_mm, vaddr, pte);\r\n__flush_tlb_one(vaddr);\r\n}\r\nvoid set_pmd_pfn(unsigned long vaddr, unsigned long pfn, pgprot_t flags)\r\n{\r\npgd_t *pgd;\r\npud_t *pud;\r\npmd_t *pmd;\r\nif (vaddr & (PMD_SIZE-1)) {\r\nprintk(KERN_WARNING "set_pmd_pfn: vaddr misaligned\n");\r\nreturn;\r\n}\r\nif (pfn & (PTRS_PER_PTE-1)) {\r\nprintk(KERN_WARNING "set_pmd_pfn: pfn misaligned\n");\r\nreturn;\r\n}\r\npgd = swapper_pg_dir + pgd_index(vaddr);\r\nif (pgd_none(*pgd)) {\r\nprintk(KERN_WARNING "set_pmd_pfn: pgd_none\n");\r\nreturn;\r\n}\r\npud = pud_offset(pgd, vaddr);\r\npmd = pmd_offset(pud, vaddr);\r\nset_pmd(pmd, pfn_pmd(pfn, flags));\r\n__flush_tlb_one(vaddr);\r\n}\r\nstatic int __init parse_vmalloc(char *arg)\r\n{\r\nif (!arg)\r\nreturn -EINVAL;\r\n__VMALLOC_RESERVE = memparse(arg, &arg) + VMALLOC_OFFSET;\r\nreturn 0;\r\n}\r\nstatic int __init parse_reservetop(char *arg)\r\n{\r\nunsigned long address;\r\nif (!arg)\r\nreturn -EINVAL;\r\naddress = memparse(arg, &arg);\r\nreserve_top_address(address);\r\nfixup_early_ioremap();\r\nreturn 0;\r\n}

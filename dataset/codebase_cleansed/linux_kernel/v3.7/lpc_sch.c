static int __devinit lpc_sch_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nunsigned int base_addr_cfg;\r\nunsigned short base_addr;\r\nint i;\r\nint ret;\r\npci_read_config_dword(dev, SMBASE, &base_addr_cfg);\r\nif (!(base_addr_cfg & (1 << 31))) {\r\ndev_err(&dev->dev, "Decode of the SMBus I/O range disabled\n");\r\nreturn -ENODEV;\r\n}\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0) {\r\ndev_err(&dev->dev, "I/O space for SMBus uninitialized\n");\r\nreturn -ENODEV;\r\n}\r\nsmbus_sch_resource.start = base_addr;\r\nsmbus_sch_resource.end = base_addr + SMBUS_IO_SIZE - 1;\r\npci_read_config_dword(dev, GPIOBASE, &base_addr_cfg);\r\nif (!(base_addr_cfg & (1 << 31))) {\r\ndev_err(&dev->dev, "Decode of the GPIO I/O range disabled\n");\r\nreturn -ENODEV;\r\n}\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0) {\r\ndev_err(&dev->dev, "I/O space for GPIO uninitialized\n");\r\nreturn -ENODEV;\r\n}\r\ngpio_sch_resource.start = base_addr;\r\nif (id->device == PCI_DEVICE_ID_INTEL_CENTERTON_ILB)\r\ngpio_sch_resource.end = base_addr + GPIO_IO_SIZE_CENTERTON - 1;\r\nelse\r\ngpio_sch_resource.end = base_addr + GPIO_IO_SIZE - 1;\r\nfor (i=0; i < ARRAY_SIZE(lpc_sch_cells); i++)\r\nlpc_sch_cells[i].id = id->device;\r\nret = mfd_add_devices(&dev->dev, 0,\r\nlpc_sch_cells, ARRAY_SIZE(lpc_sch_cells), NULL,\r\n0, NULL);\r\nif (ret)\r\ngoto out_dev;\r\nif (id->device == PCI_DEVICE_ID_INTEL_ITC_LPC\r\n|| id->device == PCI_DEVICE_ID_INTEL_CENTERTON_ILB) {\r\npci_read_config_dword(dev, WDTBASE, &base_addr_cfg);\r\nif (!(base_addr_cfg & (1 << 31))) {\r\ndev_err(&dev->dev, "Decode of the WDT I/O range disabled\n");\r\nret = -ENODEV;\r\ngoto out_dev;\r\n}\r\nbase_addr = (unsigned short)base_addr_cfg;\r\nif (base_addr == 0) {\r\ndev_err(&dev->dev, "I/O space for WDT uninitialized\n");\r\nret = -ENODEV;\r\ngoto out_dev;\r\n}\r\nwdt_sch_resource.start = base_addr;\r\nwdt_sch_resource.end = base_addr + WDT_IO_SIZE - 1;\r\nfor (i = 0; i < ARRAY_SIZE(tunnelcreek_cells); i++)\r\ntunnelcreek_cells[i].id = id->device;\r\nret = mfd_add_devices(&dev->dev, 0, tunnelcreek_cells,\r\nARRAY_SIZE(tunnelcreek_cells), NULL,\r\n0, NULL);\r\n}\r\nreturn ret;\r\nout_dev:\r\nmfd_remove_devices(&dev->dev);\r\nreturn ret;\r\n}\r\nstatic void __devexit lpc_sch_remove(struct pci_dev *dev)\r\n{\r\nmfd_remove_devices(&dev->dev);\r\n}

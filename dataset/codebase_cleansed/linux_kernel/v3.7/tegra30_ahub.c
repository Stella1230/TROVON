static inline void tegra30_apbif_write(u32 reg, u32 val)\r\n{\r\nregmap_write(ahub->regmap_apbif, reg, val);\r\n}\r\nstatic inline u32 tegra30_apbif_read(u32 reg)\r\n{\r\nu32 val;\r\nregmap_read(ahub->regmap_apbif, reg, &val);\r\nreturn val;\r\n}\r\nstatic inline void tegra30_audio_write(u32 reg, u32 val)\r\n{\r\nregmap_write(ahub->regmap_ahub, reg, val);\r\n}\r\nstatic int tegra30_ahub_runtime_suspend(struct device *dev)\r\n{\r\nregcache_cache_only(ahub->regmap_apbif, true);\r\nregcache_cache_only(ahub->regmap_ahub, true);\r\nclk_disable_unprepare(ahub->clk_apbif);\r\nclk_disable_unprepare(ahub->clk_d_audio);\r\nreturn 0;\r\n}\r\nstatic int tegra30_ahub_runtime_resume(struct device *dev)\r\n{\r\nint ret;\r\nret = clk_prepare_enable(ahub->clk_d_audio);\r\nif (ret) {\r\ndev_err(dev, "clk_enable d_audio failed: %d\n", ret);\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(ahub->clk_apbif);\r\nif (ret) {\r\ndev_err(dev, "clk_enable apbif failed: %d\n", ret);\r\nclk_disable(ahub->clk_d_audio);\r\nreturn ret;\r\n}\r\nregcache_cache_only(ahub->regmap_apbif, false);\r\nregcache_cache_only(ahub->regmap_ahub, false);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_allocate_rx_fifo(enum tegra30_ahub_rxcif *rxcif,\r\nunsigned long *fiforeg,\r\nunsigned long *reqsel)\r\n{\r\nint channel;\r\nu32 reg, val;\r\nchannel = find_first_zero_bit(ahub->rx_usage,\r\nTEGRA30_AHUB_CHANNEL_CTRL_COUNT);\r\nif (channel >= TEGRA30_AHUB_CHANNEL_CTRL_COUNT)\r\nreturn -EBUSY;\r\n__set_bit(channel, ahub->rx_usage);\r\n*rxcif = TEGRA30_AHUB_RXCIF_APBIF_RX0 + channel;\r\n*fiforeg = ahub->apbif_addr + TEGRA30_AHUB_CHANNEL_RXFIFO +\r\n(channel * TEGRA30_AHUB_CHANNEL_RXFIFO_STRIDE);\r\n*reqsel = ahub->dma_sel + channel;\r\nreg = TEGRA30_AHUB_CHANNEL_CTRL +\r\n(channel * TEGRA30_AHUB_CHANNEL_CTRL_STRIDE);\r\nval = tegra30_apbif_read(reg);\r\nval &= ~(TEGRA30_AHUB_CHANNEL_CTRL_RX_THRESHOLD_MASK |\r\nTEGRA30_AHUB_CHANNEL_CTRL_RX_PACK_MASK);\r\nval |= (7 << TEGRA30_AHUB_CHANNEL_CTRL_RX_THRESHOLD_SHIFT) |\r\nTEGRA30_AHUB_CHANNEL_CTRL_RX_PACK_EN |\r\nTEGRA30_AHUB_CHANNEL_CTRL_RX_PACK_16;\r\ntegra30_apbif_write(reg, val);\r\nreg = TEGRA30_AHUB_CIF_RX_CTRL +\r\n(channel * TEGRA30_AHUB_CIF_RX_CTRL_STRIDE);\r\nval = (0 << TEGRA30_AUDIOCIF_CTRL_FIFO_THRESHOLD_SHIFT) |\r\n(1 << TEGRA30_AUDIOCIF_CTRL_AUDIO_CHANNELS_SHIFT) |\r\n(1 << TEGRA30_AUDIOCIF_CTRL_CLIENT_CHANNELS_SHIFT) |\r\nTEGRA30_AUDIOCIF_CTRL_AUDIO_BITS_16 |\r\nTEGRA30_AUDIOCIF_CTRL_CLIENT_BITS_16 |\r\nTEGRA30_AUDIOCIF_CTRL_DIRECTION_RX;\r\ntegra30_apbif_write(reg, val);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_enable_rx_fifo(enum tegra30_ahub_rxcif rxcif)\r\n{\r\nint channel = rxcif - TEGRA30_AHUB_RXCIF_APBIF_RX0;\r\nint reg, val;\r\nreg = TEGRA30_AHUB_CHANNEL_CTRL +\r\n(channel * TEGRA30_AHUB_CHANNEL_CTRL_STRIDE);\r\nval = tegra30_apbif_read(reg);\r\nval |= TEGRA30_AHUB_CHANNEL_CTRL_RX_EN;\r\ntegra30_apbif_write(reg, val);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_disable_rx_fifo(enum tegra30_ahub_rxcif rxcif)\r\n{\r\nint channel = rxcif - TEGRA30_AHUB_RXCIF_APBIF_RX0;\r\nint reg, val;\r\nreg = TEGRA30_AHUB_CHANNEL_CTRL +\r\n(channel * TEGRA30_AHUB_CHANNEL_CTRL_STRIDE);\r\nval = tegra30_apbif_read(reg);\r\nval &= ~TEGRA30_AHUB_CHANNEL_CTRL_RX_EN;\r\ntegra30_apbif_write(reg, val);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_free_rx_fifo(enum tegra30_ahub_rxcif rxcif)\r\n{\r\nint channel = rxcif - TEGRA30_AHUB_RXCIF_APBIF_RX0;\r\n__clear_bit(channel, ahub->rx_usage);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_allocate_tx_fifo(enum tegra30_ahub_txcif *txcif,\r\nunsigned long *fiforeg,\r\nunsigned long *reqsel)\r\n{\r\nint channel;\r\nu32 reg, val;\r\nchannel = find_first_zero_bit(ahub->tx_usage,\r\nTEGRA30_AHUB_CHANNEL_CTRL_COUNT);\r\nif (channel >= TEGRA30_AHUB_CHANNEL_CTRL_COUNT)\r\nreturn -EBUSY;\r\n__set_bit(channel, ahub->tx_usage);\r\n*txcif = TEGRA30_AHUB_TXCIF_APBIF_TX0 + channel;\r\n*fiforeg = ahub->apbif_addr + TEGRA30_AHUB_CHANNEL_TXFIFO +\r\n(channel * TEGRA30_AHUB_CHANNEL_TXFIFO_STRIDE);\r\n*reqsel = ahub->dma_sel + channel;\r\nreg = TEGRA30_AHUB_CHANNEL_CTRL +\r\n(channel * TEGRA30_AHUB_CHANNEL_CTRL_STRIDE);\r\nval = tegra30_apbif_read(reg);\r\nval &= ~(TEGRA30_AHUB_CHANNEL_CTRL_TX_THRESHOLD_MASK |\r\nTEGRA30_AHUB_CHANNEL_CTRL_TX_PACK_MASK);\r\nval |= (7 << TEGRA30_AHUB_CHANNEL_CTRL_TX_THRESHOLD_SHIFT) |\r\nTEGRA30_AHUB_CHANNEL_CTRL_TX_PACK_EN |\r\nTEGRA30_AHUB_CHANNEL_CTRL_TX_PACK_16;\r\ntegra30_apbif_write(reg, val);\r\nreg = TEGRA30_AHUB_CIF_TX_CTRL +\r\n(channel * TEGRA30_AHUB_CIF_TX_CTRL_STRIDE);\r\nval = (0 << TEGRA30_AUDIOCIF_CTRL_FIFO_THRESHOLD_SHIFT) |\r\n(1 << TEGRA30_AUDIOCIF_CTRL_AUDIO_CHANNELS_SHIFT) |\r\n(1 << TEGRA30_AUDIOCIF_CTRL_CLIENT_CHANNELS_SHIFT) |\r\nTEGRA30_AUDIOCIF_CTRL_AUDIO_BITS_16 |\r\nTEGRA30_AUDIOCIF_CTRL_CLIENT_BITS_16 |\r\nTEGRA30_AUDIOCIF_CTRL_DIRECTION_TX;\r\ntegra30_apbif_write(reg, val);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_enable_tx_fifo(enum tegra30_ahub_txcif txcif)\r\n{\r\nint channel = txcif - TEGRA30_AHUB_TXCIF_APBIF_TX0;\r\nint reg, val;\r\nreg = TEGRA30_AHUB_CHANNEL_CTRL +\r\n(channel * TEGRA30_AHUB_CHANNEL_CTRL_STRIDE);\r\nval = tegra30_apbif_read(reg);\r\nval |= TEGRA30_AHUB_CHANNEL_CTRL_TX_EN;\r\ntegra30_apbif_write(reg, val);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_disable_tx_fifo(enum tegra30_ahub_txcif txcif)\r\n{\r\nint channel = txcif - TEGRA30_AHUB_TXCIF_APBIF_TX0;\r\nint reg, val;\r\nreg = TEGRA30_AHUB_CHANNEL_CTRL +\r\n(channel * TEGRA30_AHUB_CHANNEL_CTRL_STRIDE);\r\nval = tegra30_apbif_read(reg);\r\nval &= ~TEGRA30_AHUB_CHANNEL_CTRL_TX_EN;\r\ntegra30_apbif_write(reg, val);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_free_tx_fifo(enum tegra30_ahub_txcif txcif)\r\n{\r\nint channel = txcif - TEGRA30_AHUB_TXCIF_APBIF_TX0;\r\n__clear_bit(channel, ahub->tx_usage);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_set_rx_cif_source(enum tegra30_ahub_rxcif rxcif,\r\nenum tegra30_ahub_txcif txcif)\r\n{\r\nint channel = rxcif - TEGRA30_AHUB_RXCIF_APBIF_RX0;\r\nint reg;\r\nreg = TEGRA30_AHUB_AUDIO_RX +\r\n(channel * TEGRA30_AHUB_AUDIO_RX_STRIDE);\r\ntegra30_audio_write(reg, 1 << txcif);\r\nreturn 0;\r\n}\r\nint tegra30_ahub_unset_rx_cif_source(enum tegra30_ahub_rxcif rxcif)\r\n{\r\nint channel = rxcif - TEGRA30_AHUB_RXCIF_APBIF_RX0;\r\nint reg;\r\nreg = TEGRA30_AHUB_AUDIO_RX +\r\n(channel * TEGRA30_AHUB_AUDIO_RX_STRIDE);\r\ntegra30_audio_write(reg, 0);\r\nreturn 0;\r\n}\r\nstatic bool tegra30_ahub_apbif_wr_rd_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TEGRA30_AHUB_CONFIG_LINK_CTRL:\r\ncase TEGRA30_AHUB_MISC_CTRL:\r\ncase TEGRA30_AHUB_APBDMA_LIVE_STATUS:\r\ncase TEGRA30_AHUB_I2S_LIVE_STATUS:\r\ncase TEGRA30_AHUB_SPDIF_LIVE_STATUS:\r\ncase TEGRA30_AHUB_I2S_INT_MASK:\r\ncase TEGRA30_AHUB_DAM_INT_MASK:\r\ncase TEGRA30_AHUB_SPDIF_INT_MASK:\r\ncase TEGRA30_AHUB_APBIF_INT_MASK:\r\ncase TEGRA30_AHUB_I2S_INT_STATUS:\r\ncase TEGRA30_AHUB_DAM_INT_STATUS:\r\ncase TEGRA30_AHUB_SPDIF_INT_STATUS:\r\ncase TEGRA30_AHUB_APBIF_INT_STATUS:\r\ncase TEGRA30_AHUB_I2S_INT_SOURCE:\r\ncase TEGRA30_AHUB_DAM_INT_SOURCE:\r\ncase TEGRA30_AHUB_SPDIF_INT_SOURCE:\r\ncase TEGRA30_AHUB_APBIF_INT_SOURCE:\r\ncase TEGRA30_AHUB_I2S_INT_SET:\r\ncase TEGRA30_AHUB_DAM_INT_SET:\r\ncase TEGRA30_AHUB_SPDIF_INT_SET:\r\ncase TEGRA30_AHUB_APBIF_INT_SET:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n};\r\nif (REG_IN_ARRAY(reg, CHANNEL_CTRL) ||\r\nREG_IN_ARRAY(reg, CHANNEL_CLEAR) ||\r\nREG_IN_ARRAY(reg, CHANNEL_STATUS) ||\r\nREG_IN_ARRAY(reg, CHANNEL_TXFIFO) ||\r\nREG_IN_ARRAY(reg, CHANNEL_RXFIFO) ||\r\nREG_IN_ARRAY(reg, CIF_TX_CTRL) ||\r\nREG_IN_ARRAY(reg, CIF_RX_CTRL) ||\r\nREG_IN_ARRAY(reg, DAM_LIVE_STATUS))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool tegra30_ahub_apbif_volatile_reg(struct device *dev,\r\nunsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TEGRA30_AHUB_CONFIG_LINK_CTRL:\r\ncase TEGRA30_AHUB_MISC_CTRL:\r\ncase TEGRA30_AHUB_APBDMA_LIVE_STATUS:\r\ncase TEGRA30_AHUB_I2S_LIVE_STATUS:\r\ncase TEGRA30_AHUB_SPDIF_LIVE_STATUS:\r\ncase TEGRA30_AHUB_I2S_INT_STATUS:\r\ncase TEGRA30_AHUB_DAM_INT_STATUS:\r\ncase TEGRA30_AHUB_SPDIF_INT_STATUS:\r\ncase TEGRA30_AHUB_APBIF_INT_STATUS:\r\ncase TEGRA30_AHUB_I2S_INT_SET:\r\ncase TEGRA30_AHUB_DAM_INT_SET:\r\ncase TEGRA30_AHUB_SPDIF_INT_SET:\r\ncase TEGRA30_AHUB_APBIF_INT_SET:\r\nreturn true;\r\ndefault:\r\nbreak;\r\n};\r\nif (REG_IN_ARRAY(reg, CHANNEL_CLEAR) ||\r\nREG_IN_ARRAY(reg, CHANNEL_STATUS) ||\r\nREG_IN_ARRAY(reg, CHANNEL_TXFIFO) ||\r\nREG_IN_ARRAY(reg, CHANNEL_RXFIFO) ||\r\nREG_IN_ARRAY(reg, DAM_LIVE_STATUS))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool tegra30_ahub_apbif_precious_reg(struct device *dev,\r\nunsigned int reg)\r\n{\r\nif (REG_IN_ARRAY(reg, CHANNEL_TXFIFO) ||\r\nREG_IN_ARRAY(reg, CHANNEL_RXFIFO))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic bool tegra30_ahub_ahub_wr_rd_reg(struct device *dev, unsigned int reg)\r\n{\r\nif (REG_IN_ARRAY(reg, AUDIO_RX))\r\nreturn true;\r\nreturn false;\r\n}\r\nstatic int __devinit tegra30_ahub_probe(struct platform_device *pdev)\r\n{\r\nstruct clk *clk;\r\nint i;\r\nstruct resource *res0, *res1, *region;\r\nu32 of_dma[2];\r\nvoid __iomem *regs_apbif, *regs_ahub;\r\nint ret = 0;\r\nif (ahub)\r\nreturn -ENODEV;\r\nfor (i = 0; i < ARRAY_SIZE(configlink_clocks); i++) {\r\nclk = clk_get_sys(NULL, configlink_clocks[i]);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Can't get clock %s\n",\r\nconfiglink_clocks[i]);\r\nret = PTR_ERR(clk);\r\ngoto err;\r\n}\r\ntegra_periph_reset_deassert(clk);\r\nclk_put(clk);\r\n}\r\nahub = devm_kzalloc(&pdev->dev, sizeof(struct tegra30_ahub),\r\nGFP_KERNEL);\r\nif (!ahub) {\r\ndev_err(&pdev->dev, "Can't allocate tegra30_ahub\n");\r\nret = -ENOMEM;\r\ngoto err;\r\n}\r\ndev_set_drvdata(&pdev->dev, ahub);\r\nahub->dev = &pdev->dev;\r\nahub->clk_d_audio = clk_get(&pdev->dev, "d_audio");\r\nif (IS_ERR(ahub->clk_d_audio)) {\r\ndev_err(&pdev->dev, "Can't retrieve ahub d_audio clock\n");\r\nret = PTR_ERR(ahub->clk_d_audio);\r\ngoto err;\r\n}\r\nahub->clk_apbif = clk_get(&pdev->dev, "apbif");\r\nif (IS_ERR(ahub->clk_apbif)) {\r\ndev_err(&pdev->dev, "Can't retrieve ahub apbif clock\n");\r\nret = PTR_ERR(ahub->clk_apbif);\r\ngoto err_clk_put_d_audio;\r\n}\r\nif (of_property_read_u32_array(pdev->dev.of_node,\r\n"nvidia,dma-request-selector",\r\nof_dma, 2) < 0) {\r\ndev_err(&pdev->dev,\r\n"Missing property nvidia,dma-request-selector\n");\r\nret = -ENODEV;\r\ngoto err_clk_put_d_audio;\r\n}\r\nahub->dma_sel = of_dma[1];\r\nres0 = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res0) {\r\ndev_err(&pdev->dev, "No apbif memory resource\n");\r\nret = -ENODEV;\r\ngoto err_clk_put_apbif;\r\n}\r\nregion = devm_request_mem_region(&pdev->dev, res0->start,\r\nresource_size(res0), DRV_NAME);\r\nif (!region) {\r\ndev_err(&pdev->dev, "request region apbif failed\n");\r\nret = -EBUSY;\r\ngoto err_clk_put_apbif;\r\n}\r\nahub->apbif_addr = res0->start;\r\nregs_apbif = devm_ioremap(&pdev->dev, res0->start,\r\nresource_size(res0));\r\nif (!regs_apbif) {\r\ndev_err(&pdev->dev, "ioremap apbif failed\n");\r\nret = -ENOMEM;\r\ngoto err_clk_put_apbif;\r\n}\r\nahub->regmap_apbif = devm_regmap_init_mmio(&pdev->dev, regs_apbif,\r\n&tegra30_ahub_apbif_regmap_config);\r\nif (IS_ERR(ahub->regmap_apbif)) {\r\ndev_err(&pdev->dev, "apbif regmap init failed\n");\r\nret = PTR_ERR(ahub->regmap_apbif);\r\ngoto err_clk_put_apbif;\r\n}\r\nregcache_cache_only(ahub->regmap_apbif, true);\r\nres1 = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res1) {\r\ndev_err(&pdev->dev, "No ahub memory resource\n");\r\nret = -ENODEV;\r\ngoto err_clk_put_apbif;\r\n}\r\nregion = devm_request_mem_region(&pdev->dev, res1->start,\r\nresource_size(res1), DRV_NAME);\r\nif (!region) {\r\ndev_err(&pdev->dev, "request region ahub failed\n");\r\nret = -EBUSY;\r\ngoto err_clk_put_apbif;\r\n}\r\nregs_ahub = devm_ioremap(&pdev->dev, res1->start,\r\nresource_size(res1));\r\nif (!regs_ahub) {\r\ndev_err(&pdev->dev, "ioremap ahub failed\n");\r\nret = -ENOMEM;\r\ngoto err_clk_put_apbif;\r\n}\r\nahub->regmap_ahub = devm_regmap_init_mmio(&pdev->dev, regs_ahub,\r\n&tegra30_ahub_ahub_regmap_config);\r\nif (IS_ERR(ahub->regmap_ahub)) {\r\ndev_err(&pdev->dev, "ahub regmap init failed\n");\r\nret = PTR_ERR(ahub->regmap_ahub);\r\ngoto err_clk_put_apbif;\r\n}\r\nregcache_cache_only(ahub->regmap_ahub, true);\r\npm_runtime_enable(&pdev->dev);\r\nif (!pm_runtime_enabled(&pdev->dev)) {\r\nret = tegra30_ahub_runtime_resume(&pdev->dev);\r\nif (ret)\r\ngoto err_pm_disable;\r\n}\r\nof_platform_populate(pdev->dev.of_node, NULL, ahub_auxdata,\r\n&pdev->dev);\r\nreturn 0;\r\nerr_pm_disable:\r\npm_runtime_disable(&pdev->dev);\r\nerr_clk_put_apbif:\r\nclk_put(ahub->clk_apbif);\r\nerr_clk_put_d_audio:\r\nclk_put(ahub->clk_d_audio);\r\nahub = 0;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int __devexit tegra30_ahub_remove(struct platform_device *pdev)\r\n{\r\nif (!ahub)\r\nreturn -ENODEV;\r\npm_runtime_disable(&pdev->dev);\r\nif (!pm_runtime_status_suspended(&pdev->dev))\r\ntegra30_ahub_runtime_suspend(&pdev->dev);\r\nclk_put(ahub->clk_apbif);\r\nclk_put(ahub->clk_d_audio);\r\nahub = 0;\r\nreturn 0;\r\n}

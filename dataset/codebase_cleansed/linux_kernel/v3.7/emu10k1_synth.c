static int snd_emu10k1_synth_new_device(struct snd_seq_device *dev)\r\n{\r\nstruct snd_emux *emux;\r\nstruct snd_emu10k1 *hw;\r\nstruct snd_emu10k1_synth_arg *arg;\r\nunsigned long flags;\r\narg = SNDRV_SEQ_DEVICE_ARGPTR(dev);\r\nif (arg == NULL)\r\nreturn -EINVAL;\r\nif (arg->seq_ports <= 0)\r\nreturn 0;\r\nif (arg->max_voices < 1)\r\narg->max_voices = 1;\r\nelse if (arg->max_voices > 64)\r\narg->max_voices = 64;\r\nif (snd_emux_new(&emux) < 0)\r\nreturn -ENOMEM;\r\nsnd_emu10k1_ops_setup(emux);\r\nhw = arg->hwptr;\r\nemux->hw = hw;\r\nemux->max_voices = arg->max_voices;\r\nemux->num_ports = arg->seq_ports;\r\nemux->pitch_shift = -501;\r\nemux->memhdr = hw->memhdr;\r\nemux->midi_ports = arg->seq_ports < 2 ? arg->seq_ports : 2;\r\nemux->midi_devidx = hw->audigy ? 2 : 1;\r\nemux->linear_panning = 0;\r\nemux->hwdep_idx = 2;\r\nif (snd_emux_register(emux, dev->card, arg->index, "Emu10k1") < 0) {\r\nsnd_emux_free(emux);\r\nreturn -ENOMEM;\r\n}\r\nspin_lock_irqsave(&hw->voice_lock, flags);\r\nhw->synth = emux;\r\nhw->get_synth_voice = snd_emu10k1_synth_get_voice;\r\nspin_unlock_irqrestore(&hw->voice_lock, flags);\r\ndev->driver_data = emux;\r\nreturn 0;\r\n}\r\nstatic int snd_emu10k1_synth_delete_device(struct snd_seq_device *dev)\r\n{\r\nstruct snd_emux *emux;\r\nstruct snd_emu10k1 *hw;\r\nunsigned long flags;\r\nif (dev->driver_data == NULL)\r\nreturn 0;\r\nemux = dev->driver_data;\r\nhw = emux->hw;\r\nspin_lock_irqsave(&hw->voice_lock, flags);\r\nhw->synth = NULL;\r\nhw->get_synth_voice = NULL;\r\nspin_unlock_irqrestore(&hw->voice_lock, flags);\r\nsnd_emux_free(emux);\r\nreturn 0;\r\n}\r\nstatic int __init alsa_emu10k1_synth_init(void)\r\n{\r\nstatic struct snd_seq_dev_ops ops = {\r\nsnd_emu10k1_synth_new_device,\r\nsnd_emu10k1_synth_delete_device,\r\n};\r\nreturn snd_seq_device_register_driver(SNDRV_SEQ_DEV_ID_EMU10K1_SYNTH, &ops,\r\nsizeof(struct snd_emu10k1_synth_arg));\r\n}\r\nstatic void __exit alsa_emu10k1_synth_exit(void)\r\n{\r\nsnd_seq_device_unregister_driver(SNDRV_SEQ_DEV_ID_EMU10K1_SYNTH);\r\n}

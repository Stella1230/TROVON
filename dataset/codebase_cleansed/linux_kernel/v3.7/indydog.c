static void indydog_start(void)\r\n{\r\nu32 mc_ctrl0;\r\nspin_lock(&indydog_lock);\r\nmc_ctrl0 = sgimc->cpuctrl0;\r\nmc_ctrl0 = sgimc->cpuctrl0 | SGIMC_CCTRL0_WDOG;\r\nsgimc->cpuctrl0 = mc_ctrl0;\r\nspin_unlock(&indydog_lock);\r\n}\r\nstatic void indydog_stop(void)\r\n{\r\nu32 mc_ctrl0;\r\nspin_lock(&indydog_lock);\r\nmc_ctrl0 = sgimc->cpuctrl0;\r\nmc_ctrl0 &= ~SGIMC_CCTRL0_WDOG;\r\nsgimc->cpuctrl0 = mc_ctrl0;\r\nspin_unlock(&indydog_lock);\r\npr_info("Stopped watchdog timer\n");\r\n}\r\nstatic void indydog_ping(void)\r\n{\r\nsgimc->watchdogt = 0;\r\n}\r\nstatic int indydog_open(struct inode *inode, struct file *file)\r\n{\r\nif (test_and_set_bit(0, &indydog_alive))\r\nreturn -EBUSY;\r\nif (nowayout)\r\n__module_get(THIS_MODULE);\r\nindydog_start();\r\nindydog_ping();\r\npr_info("Started watchdog timer\n");\r\nreturn nonseekable_open(inode, file);\r\n}\r\nstatic int indydog_release(struct inode *inode, struct file *file)\r\n{\r\nif (!nowayout)\r\nindydog_stop();\r\nclear_bit(0, &indydog_alive);\r\nreturn 0;\r\n}\r\nstatic ssize_t indydog_write(struct file *file, const char *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len)\r\nindydog_ping();\r\nreturn len;\r\n}\r\nstatic long indydog_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint options, retval = -EINVAL;\r\nstatic const struct watchdog_info ident = {\r\n.options = WDIOF_KEEPALIVEPING,\r\n.firmware_version = 0,\r\n.identity = "Hardware Watchdog for SGI IP22",\r\n};\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user((struct watchdog_info *)arg,\r\n&ident, sizeof(ident)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, (int *)arg);\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nif (get_user(options, (int *)arg))\r\nreturn -EFAULT;\r\nif (options & WDIOS_DISABLECARD) {\r\nindydog_stop();\r\nretval = 0;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\nindydog_start();\r\nretval = 0;\r\n}\r\nreturn retval;\r\n}\r\ncase WDIOC_KEEPALIVE:\r\nindydog_ping();\r\nreturn 0;\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(WATCHDOG_TIMEOUT, (int *)arg);\r\ndefault:\r\nreturn -ENOTTY;\r\n}\r\n}\r\nstatic int indydog_notify_sys(struct notifier_block *this,\r\nunsigned long code, void *unused)\r\n{\r\nif (code == SYS_DOWN || code == SYS_HALT)\r\nindydog_stop();\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint ret;\r\nret = register_reboot_notifier(&indydog_notifier);\r\nif (ret) {\r\npr_err("cannot register reboot notifier (err=%d)\n", ret);\r\nreturn ret;\r\n}\r\nret = misc_register(&indydog_miscdev);\r\nif (ret) {\r\npr_err("cannot register miscdev on minor=%d (err=%d)\n",\r\nWATCHDOG_MINOR, ret);\r\nunregister_reboot_notifier(&indydog_notifier);\r\nreturn ret;\r\n}\r\npr_info("Hardware Watchdog Timer for SGI IP22: 0.3\n");\r\nreturn 0;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nmisc_deregister(&indydog_miscdev);\r\nunregister_reboot_notifier(&indydog_notifier);\r\n}

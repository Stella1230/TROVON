static int at91sam9g20ek_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nint ret;\r\nret = snd_soc_dai_set_fmt(codec_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, SND_SOC_DAIFMT_I2S |\r\nSND_SOC_DAIFMT_NB_NF | SND_SOC_DAIFMT_CBM_CFM);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int at91sam9g20ek_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nstatic int mclk_on;\r\nint ret = 0;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\ncase SND_SOC_BIAS_PREPARE:\r\nif (!mclk_on)\r\nret = clk_enable(mclk);\r\nif (ret == 0)\r\nmclk_on = 1;\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (mclk_on)\r\nclk_disable(mclk);\r\nmclk_on = 0;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int at91sam9g20ek_wm8731_init(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_soc_codec *codec = rtd->codec;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dapm_context *dapm = &codec->dapm;\r\nint ret;\r\nprintk(KERN_DEBUG\r\n"at91sam9g20ek_wm8731 "\r\n": at91sam9g20ek_wm8731_init() called\n");\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8731_SYSCLK_MCLK,\r\nMCLK_RATE, SND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\nprintk(KERN_ERR "Failed to set WM8731 SYSCLK: %d\n", ret);\r\nreturn ret;\r\n}\r\nsnd_soc_dapm_new_controls(dapm, at91sam9g20ek_dapm_widgets,\r\nARRAY_SIZE(at91sam9g20ek_dapm_widgets));\r\nsnd_soc_dapm_add_routes(dapm, intercon, ARRAY_SIZE(intercon));\r\nsnd_soc_dapm_nc_pin(dapm, "RLINEIN");\r\nsnd_soc_dapm_nc_pin(dapm, "LLINEIN");\r\n#ifdef ENABLE_MIC_INPUT\r\nsnd_soc_dapm_enable_pin(dapm, "Int Mic");\r\n#else\r\nsnd_soc_dapm_nc_pin(dapm, "Int Mic");\r\n#endif\r\nsnd_soc_dapm_enable_pin(dapm, "Ext Spk");\r\nreturn 0;\r\n}\r\nstatic int __init at91sam9g20ek_init(void)\r\n{\r\nstruct clk *pllb;\r\nint ret;\r\nif (!(machine_is_at91sam9g20ek() || machine_is_at91sam9g20ek_2mmc()))\r\nreturn -ENODEV;\r\nret = atmel_ssc_set_audio(0);\r\nif (ret != 0) {\r\npr_err("Failed to set SSC 0 for audio: %d\n", ret);\r\nreturn ret;\r\n}\r\nmclk = clk_get(NULL, "pck0");\r\nif (IS_ERR(mclk)) {\r\nprintk(KERN_ERR "ASoC: Failed to get MCLK\n");\r\nret = PTR_ERR(mclk);\r\ngoto err;\r\n}\r\npllb = clk_get(NULL, "pllb");\r\nif (IS_ERR(pllb)) {\r\nprintk(KERN_ERR "ASoC: Failed to get PLLB\n");\r\nret = PTR_ERR(pllb);\r\ngoto err_mclk;\r\n}\r\nret = clk_set_parent(mclk, pllb);\r\nclk_put(pllb);\r\nif (ret != 0) {\r\nprintk(KERN_ERR "ASoC: Failed to set MCLK parent\n");\r\ngoto err_mclk;\r\n}\r\nclk_set_rate(mclk, MCLK_RATE);\r\nat91sam9g20ek_snd_device = platform_device_alloc("soc-audio", -1);\r\nif (!at91sam9g20ek_snd_device) {\r\nprintk(KERN_ERR "ASoC: Platform device allocation failed\n");\r\nret = -ENOMEM;\r\ngoto err_mclk;\r\n}\r\nplatform_set_drvdata(at91sam9g20ek_snd_device,\r\n&snd_soc_at91sam9g20ek);\r\nret = platform_device_add(at91sam9g20ek_snd_device);\r\nif (ret) {\r\nprintk(KERN_ERR "ASoC: Platform device allocation failed\n");\r\ngoto err_device_add;\r\n}\r\nreturn ret;\r\nerr_device_add:\r\nplatform_device_put(at91sam9g20ek_snd_device);\r\nerr_mclk:\r\nclk_put(mclk);\r\nmclk = NULL;\r\nerr:\r\nreturn ret;\r\n}\r\nstatic void __exit at91sam9g20ek_exit(void)\r\n{\r\nplatform_device_unregister(at91sam9g20ek_snd_device);\r\nat91sam9g20ek_snd_device = NULL;\r\nclk_put(mclk);\r\nmclk = NULL;\r\n}

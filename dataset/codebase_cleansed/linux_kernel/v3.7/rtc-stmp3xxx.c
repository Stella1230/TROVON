static void stmp3xxx_wait_time(struct stmp3xxx_rtc_data *rtc_data)\r\n{\r\nwhile (readl(rtc_data->io + STMP3XXX_RTC_STAT) &\r\n(0x80 << STMP3XXX_RTC_STAT_STALE_SHIFT))\r\ncpu_relax();\r\n}\r\nstatic int stmp3xxx_rtc_gettime(struct device *dev, struct rtc_time *rtc_tm)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nstmp3xxx_wait_time(rtc_data);\r\nrtc_time_to_tm(readl(rtc_data->io + STMP3XXX_RTC_SECONDS), rtc_tm);\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_rtc_set_mmss(struct device *dev, unsigned long t)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nwritel(t, rtc_data->io + STMP3XXX_RTC_SECONDS);\r\nstmp3xxx_wait_time(rtc_data);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t stmp3xxx_rtc_interrupt(int irq, void *dev_id)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = dev_get_drvdata(dev_id);\r\nu32 status = readl(rtc_data->io + STMP3XXX_RTC_CTRL);\r\nif (status & STMP3XXX_RTC_CTRL_ALARM_IRQ) {\r\nwritel(STMP3XXX_RTC_CTRL_ALARM_IRQ,\r\nrtc_data->io + STMP3XXX_RTC_CTRL_CLR);\r\nrtc_update_irq(rtc_data->rtc, 1, RTC_AF | RTC_IRQF);\r\nreturn IRQ_HANDLED;\r\n}\r\nreturn IRQ_NONE;\r\n}\r\nstatic int stmp3xxx_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nif (enabled) {\r\nwritel(STMP3XXX_RTC_PERSISTENT0_ALARM_EN |\r\nSTMP3XXX_RTC_PERSISTENT0_ALARM_WAKE_EN,\r\nrtc_data->io + STMP3XXX_RTC_PERSISTENT0_SET);\r\nwritel(STMP3XXX_RTC_CTRL_ALARM_IRQ_EN,\r\nrtc_data->io + STMP3XXX_RTC_CTRL_SET);\r\n} else {\r\nwritel(STMP3XXX_RTC_PERSISTENT0_ALARM_EN |\r\nSTMP3XXX_RTC_PERSISTENT0_ALARM_WAKE_EN,\r\nrtc_data->io + STMP3XXX_RTC_PERSISTENT0_CLR);\r\nwritel(STMP3XXX_RTC_CTRL_ALARM_IRQ_EN,\r\nrtc_data->io + STMP3XXX_RTC_CTRL_CLR);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nrtc_time_to_tm(readl(rtc_data->io + STMP3XXX_RTC_ALARM), &alm->time);\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alm)\r\n{\r\nunsigned long t;\r\nstruct stmp3xxx_rtc_data *rtc_data = dev_get_drvdata(dev);\r\nrtc_tm_to_time(&alm->time, &t);\r\nwritel(t, rtc_data->io + STMP3XXX_RTC_ALARM);\r\nstmp3xxx_alarm_irq_enable(dev, alm->enabled);\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = platform_get_drvdata(pdev);\r\nif (!rtc_data)\r\nreturn 0;\r\nwritel(STMP3XXX_RTC_CTRL_ALARM_IRQ_EN,\r\nrtc_data->io + STMP3XXX_RTC_CTRL_CLR);\r\nfree_irq(rtc_data->irq_alarm, &pdev->dev);\r\nrtc_device_unregister(rtc_data->rtc);\r\nplatform_set_drvdata(pdev, NULL);\r\niounmap(rtc_data->io);\r\nkfree(rtc_data);\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data;\r\nstruct resource *r;\r\nint err;\r\nrtc_data = kzalloc(sizeof *rtc_data, GFP_KERNEL);\r\nif (!rtc_data)\r\nreturn -ENOMEM;\r\nr = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!r) {\r\ndev_err(&pdev->dev, "failed to get resource\n");\r\nerr = -ENXIO;\r\ngoto out_free;\r\n}\r\nrtc_data->io = ioremap(r->start, resource_size(r));\r\nif (!rtc_data->io) {\r\ndev_err(&pdev->dev, "ioremap failed\n");\r\nerr = -EIO;\r\ngoto out_free;\r\n}\r\nrtc_data->irq_alarm = platform_get_irq(pdev, 0);\r\nif (!(readl(STMP3XXX_RTC_STAT + rtc_data->io) &\r\nSTMP3XXX_RTC_STAT_RTC_PRESENT)) {\r\ndev_err(&pdev->dev, "no device onboard\n");\r\nerr = -ENODEV;\r\ngoto out_remap;\r\n}\r\nplatform_set_drvdata(pdev, rtc_data);\r\nmxs_reset_block(rtc_data->io);\r\nwritel(STMP3XXX_RTC_PERSISTENT0_ALARM_EN |\r\nSTMP3XXX_RTC_PERSISTENT0_ALARM_WAKE_EN |\r\nSTMP3XXX_RTC_PERSISTENT0_ALARM_WAKE,\r\nrtc_data->io + STMP3XXX_RTC_PERSISTENT0_CLR);\r\nwritel(STMP3XXX_RTC_CTRL_ONEMSEC_IRQ_EN |\r\nSTMP3XXX_RTC_CTRL_ALARM_IRQ_EN,\r\nrtc_data->io + STMP3XXX_RTC_CTRL_CLR);\r\nrtc_data->rtc = rtc_device_register(pdev->name, &pdev->dev,\r\n&stmp3xxx_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc_data->rtc)) {\r\nerr = PTR_ERR(rtc_data->rtc);\r\ngoto out_remap;\r\n}\r\nerr = request_irq(rtc_data->irq_alarm, stmp3xxx_rtc_interrupt, 0,\r\n"RTC alarm", &pdev->dev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Cannot claim IRQ%d\n",\r\nrtc_data->irq_alarm);\r\ngoto out_irq_alarm;\r\n}\r\nreturn 0;\r\nout_irq_alarm:\r\nrtc_device_unregister(rtc_data->rtc);\r\nout_remap:\r\nplatform_set_drvdata(pdev, NULL);\r\niounmap(rtc_data->io);\r\nout_free:\r\nkfree(rtc_data);\r\nreturn err;\r\n}\r\nstatic int stmp3xxx_rtc_suspend(struct platform_device *dev, pm_message_t state)\r\n{\r\nreturn 0;\r\n}\r\nstatic int stmp3xxx_rtc_resume(struct platform_device *dev)\r\n{\r\nstruct stmp3xxx_rtc_data *rtc_data = platform_get_drvdata(dev);\r\nmxs_reset_block(rtc_data->io);\r\nwritel(STMP3XXX_RTC_PERSISTENT0_ALARM_EN |\r\nSTMP3XXX_RTC_PERSISTENT0_ALARM_WAKE_EN |\r\nSTMP3XXX_RTC_PERSISTENT0_ALARM_WAKE,\r\nrtc_data->io + STMP3XXX_RTC_PERSISTENT0_CLR);\r\nreturn 0;\r\n}

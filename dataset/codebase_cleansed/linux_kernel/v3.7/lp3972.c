static int lp3972_i2c_read(struct i2c_client *i2c, char reg, int count,\r\nu16 *dest)\r\n{\r\nint ret;\r\nif (count != 1)\r\nreturn -EIO;\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nif (ret < 0)\r\nreturn ret;\r\n*dest = ret;\r\nreturn 0;\r\n}\r\nstatic int lp3972_i2c_write(struct i2c_client *i2c, char reg, int count,\r\nconst u16 *src)\r\n{\r\nif (count != 1)\r\nreturn -EIO;\r\nreturn i2c_smbus_write_byte_data(i2c, reg, *src);\r\n}\r\nstatic u8 lp3972_reg_read(struct lp3972 *lp3972, u8 reg)\r\n{\r\nu16 val = 0;\r\nmutex_lock(&lp3972->io_lock);\r\nlp3972_i2c_read(lp3972->i2c, reg, 1, &val);\r\ndev_dbg(lp3972->dev, "reg read 0x%02x -> 0x%02x\n", (int)reg,\r\n(unsigned)val & 0xff);\r\nmutex_unlock(&lp3972->io_lock);\r\nreturn val & 0xff;\r\n}\r\nstatic int lp3972_set_bits(struct lp3972 *lp3972, u8 reg, u16 mask, u16 val)\r\n{\r\nu16 tmp;\r\nint ret;\r\nmutex_lock(&lp3972->io_lock);\r\nret = lp3972_i2c_read(lp3972->i2c, reg, 1, &tmp);\r\ntmp = (tmp & ~mask) | val;\r\nif (ret == 0) {\r\nret = lp3972_i2c_write(lp3972->i2c, reg, 1, &tmp);\r\ndev_dbg(lp3972->dev, "reg write 0x%02x -> 0x%02x\n", (int)reg,\r\n(unsigned)val & 0xff);\r\n}\r\nmutex_unlock(&lp3972->io_lock);\r\nreturn ret;\r\n}\r\nstatic int lp3972_ldo_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3972_LDO1;\r\nu16 mask = LP3972_LDO_OUTPUT_ENABLE_MASK(ldo);\r\nu16 val;\r\nval = lp3972_reg_read(lp3972, LP3972_LDO_OUTPUT_ENABLE_REG(ldo));\r\nreturn !!(val & mask);\r\n}\r\nstatic int lp3972_ldo_enable(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3972_LDO1;\r\nu16 mask = LP3972_LDO_OUTPUT_ENABLE_MASK(ldo);\r\nreturn lp3972_set_bits(lp3972, LP3972_LDO_OUTPUT_ENABLE_REG(ldo),\r\nmask, mask);\r\n}\r\nstatic int lp3972_ldo_disable(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3972_LDO1;\r\nu16 mask = LP3972_LDO_OUTPUT_ENABLE_MASK(ldo);\r\nreturn lp3972_set_bits(lp3972, LP3972_LDO_OUTPUT_ENABLE_REG(ldo),\r\nmask, 0);\r\n}\r\nstatic int lp3972_ldo_get_voltage(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3972_LDO1;\r\nu16 mask = LP3972_LDO_VOL_MASK(ldo);\r\nu16 val, reg;\r\nreg = lp3972_reg_read(lp3972, LP3972_LDO_VOL_CONTR_REG(ldo));\r\nval = (reg >> LP3972_LDO_VOL_CONTR_SHIFT(ldo)) & mask;\r\nreturn dev->desc->volt_table[val];\r\n}\r\nstatic int lp3972_ldo_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned int selector)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint ldo = rdev_get_id(dev) - LP3972_LDO1;\r\nint shift, ret;\r\nshift = LP3972_LDO_VOL_CONTR_SHIFT(ldo);\r\nret = lp3972_set_bits(lp3972, LP3972_LDO_VOL_CONTR_REG(ldo),\r\nLP3972_LDO_VOL_MASK(ldo) << shift, selector << shift);\r\nif (ret)\r\nreturn ret;\r\nswitch (ldo) {\r\ncase LP3972_LDO1:\r\ncase LP3972_LDO5:\r\nshift = LP3972_LDO_VOL_CHANGE_SHIFT(ldo);\r\nret = lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\r\nLP3972_VOL_CHANGE_FLAG_MASK << shift,\r\nLP3972_VOL_CHANGE_FLAG_GO << shift);\r\nif (ret)\r\nreturn ret;\r\nret = lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\r\nLP3972_VOL_CHANGE_FLAG_MASK << shift, 0);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int lp3972_dcdc_is_enabled(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3972_DCDC1;\r\nu16 mask = 1 << (buck * 2);\r\nu16 val;\r\nval = lp3972_reg_read(lp3972, LP3972_BUCK_VOL_ENABLE_REG(buck));\r\nreturn !!(val & mask);\r\n}\r\nstatic int lp3972_dcdc_enable(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3972_DCDC1;\r\nu16 mask = 1 << (buck * 2);\r\nu16 val;\r\nval = lp3972_set_bits(lp3972, LP3972_BUCK_VOL_ENABLE_REG(buck),\r\nmask, mask);\r\nreturn val;\r\n}\r\nstatic int lp3972_dcdc_disable(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3972_DCDC1;\r\nu16 mask = 1 << (buck * 2);\r\nu16 val;\r\nval = lp3972_set_bits(lp3972, LP3972_BUCK_VOL_ENABLE_REG(buck),\r\nmask, 0);\r\nreturn val;\r\n}\r\nstatic int lp3972_dcdc_get_voltage(struct regulator_dev *dev)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3972_DCDC1;\r\nu16 reg;\r\nint val;\r\nreg = lp3972_reg_read(lp3972, LP3972_BUCK_VOL1_REG(buck));\r\nreg &= LP3972_BUCK_VOL_MASK;\r\nif (reg <= LP3972_BUCK_VOL_MAX_IDX(buck))\r\nval = dev->desc->volt_table[reg];\r\nelse {\r\nval = 0;\r\ndev_warn(&dev->dev, "chip reported incorrect voltage value."\r\n" reg = %d\n", reg);\r\n}\r\nreturn val;\r\n}\r\nstatic int lp3972_dcdc_set_voltage_sel(struct regulator_dev *dev,\r\nunsigned int selector)\r\n{\r\nstruct lp3972 *lp3972 = rdev_get_drvdata(dev);\r\nint buck = rdev_get_id(dev) - LP3972_DCDC1;\r\nint ret;\r\nret = lp3972_set_bits(lp3972, LP3972_BUCK_VOL1_REG(buck),\r\nLP3972_BUCK_VOL_MASK, selector);\r\nif (ret)\r\nreturn ret;\r\nif (buck != 0)\r\nreturn ret;\r\nret = lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\r\nLP3972_VOL_CHANGE_FLAG_MASK, LP3972_VOL_CHANGE_FLAG_GO);\r\nif (ret)\r\nreturn ret;\r\nreturn lp3972_set_bits(lp3972, LP3972_VOL_CHANGE_REG,\r\nLP3972_VOL_CHANGE_FLAG_MASK, 0);\r\n}\r\nstatic int __devinit setup_regulators(struct lp3972 *lp3972,\r\nstruct lp3972_platform_data *pdata)\r\n{\r\nint i, err;\r\nlp3972->num_regulators = pdata->num_regulators;\r\nlp3972->rdev = kcalloc(pdata->num_regulators,\r\nsizeof(struct regulator_dev *), GFP_KERNEL);\r\nif (!lp3972->rdev) {\r\nerr = -ENOMEM;\r\ngoto err_nomem;\r\n}\r\nfor (i = 0; i < pdata->num_regulators; i++) {\r\nstruct lp3972_regulator_subdev *reg = &pdata->regulators[i];\r\nstruct regulator_config config = { };\r\nconfig.dev = lp3972->dev;\r\nconfig.init_data = reg->initdata;\r\nconfig.driver_data = lp3972;\r\nlp3972->rdev[i] = regulator_register(&regulators[reg->id],\r\n&config);\r\nif (IS_ERR(lp3972->rdev[i])) {\r\nerr = PTR_ERR(lp3972->rdev[i]);\r\ndev_err(lp3972->dev, "regulator init failed: %d\n",\r\nerr);\r\ngoto error;\r\n}\r\n}\r\nreturn 0;\r\nerror:\r\nwhile (--i >= 0)\r\nregulator_unregister(lp3972->rdev[i]);\r\nkfree(lp3972->rdev);\r\nlp3972->rdev = NULL;\r\nerr_nomem:\r\nreturn err;\r\n}\r\nstatic int __devinit lp3972_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct lp3972 *lp3972;\r\nstruct lp3972_platform_data *pdata = i2c->dev.platform_data;\r\nint ret;\r\nu16 val;\r\nif (!pdata) {\r\ndev_dbg(&i2c->dev, "No platform init data supplied\n");\r\nreturn -ENODEV;\r\n}\r\nlp3972 = kzalloc(sizeof(struct lp3972), GFP_KERNEL);\r\nif (!lp3972)\r\nreturn -ENOMEM;\r\nlp3972->i2c = i2c;\r\nlp3972->dev = &i2c->dev;\r\nmutex_init(&lp3972->io_lock);\r\nret = lp3972_i2c_read(i2c, LP3972_SYS_CONTROL1_REG, 1, &val);\r\nif (ret == 0 &&\r\n(val & SYS_CONTROL1_INIT_MASK) != SYS_CONTROL1_INIT_VAL) {\r\nret = -ENODEV;\r\ndev_err(&i2c->dev, "chip reported: val = 0x%x\n", val);\r\n}\r\nif (ret < 0) {\r\ndev_err(&i2c->dev, "failed to detect device. ret = %d\n", ret);\r\ngoto err_detect;\r\n}\r\nret = setup_regulators(lp3972, pdata);\r\nif (ret < 0)\r\ngoto err_detect;\r\ni2c_set_clientdata(i2c, lp3972);\r\nreturn 0;\r\nerr_detect:\r\nkfree(lp3972);\r\nreturn ret;\r\n}\r\nstatic int __devexit lp3972_i2c_remove(struct i2c_client *i2c)\r\n{\r\nstruct lp3972 *lp3972 = i2c_get_clientdata(i2c);\r\nint i;\r\nfor (i = 0; i < lp3972->num_regulators; i++)\r\nregulator_unregister(lp3972->rdev[i]);\r\nkfree(lp3972->rdev);\r\nkfree(lp3972);\r\nreturn 0;\r\n}\r\nstatic int __init lp3972_module_init(void)\r\n{\r\nreturn i2c_add_driver(&lp3972_i2c_driver);\r\n}\r\nstatic void __exit lp3972_module_exit(void)\r\n{\r\ni2c_del_driver(&lp3972_i2c_driver);\r\n}

__wsum csum_and_copy_from_user(const void __user *src, void *dst,\r\nint len, __wsum sum, int *err_ptr)\r\n{\r\nunsigned int csum;\r\nmight_sleep();\r\n*err_ptr = 0;\r\nif (!len) {\r\ncsum = 0;\r\ngoto out;\r\n}\r\nif (unlikely((len < 0) || !access_ok(VERIFY_READ, src, len))) {\r\n*err_ptr = -EFAULT;\r\ncsum = (__force unsigned int)sum;\r\ngoto out;\r\n}\r\ncsum = csum_partial_copy_generic((void __force *)src, dst,\r\nlen, sum, err_ptr, NULL);\r\nif (unlikely(*err_ptr)) {\r\nint missing = __copy_from_user(dst, src, len);\r\nif (missing) {\r\nmemset(dst + len - missing, 0, missing);\r\n*err_ptr = -EFAULT;\r\n} else {\r\n*err_ptr = 0;\r\n}\r\ncsum = csum_partial(dst, len, sum);\r\n}\r\nout:\r\nreturn (__force __wsum)csum;\r\n}\r\n__wsum csum_and_copy_to_user(const void *src, void __user *dst, int len,\r\n__wsum sum, int *err_ptr)\r\n{\r\nunsigned int csum;\r\nmight_sleep();\r\n*err_ptr = 0;\r\nif (!len) {\r\ncsum = 0;\r\ngoto out;\r\n}\r\nif (unlikely((len < 0) || !access_ok(VERIFY_WRITE, dst, len))) {\r\n*err_ptr = -EFAULT;\r\ncsum = -1;\r\ngoto out;\r\n}\r\ncsum = csum_partial_copy_generic(src, (void __force *)dst,\r\nlen, sum, NULL, err_ptr);\r\nif (unlikely(*err_ptr)) {\r\ncsum = csum_partial(src, len, sum);\r\nif (copy_to_user(dst, src, len)) {\r\n*err_ptr = -EFAULT;\r\ncsum = -1;\r\n}\r\n}\r\nout:\r\nreturn (__force __wsum)csum;\r\n}

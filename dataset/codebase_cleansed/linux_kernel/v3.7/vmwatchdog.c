static int __diag288(enum vmwdt_func func, unsigned int timeout,\r\nchar *cmd, size_t len)\r\n{\r\nregister unsigned long __func asm("2") = func;\r\nregister unsigned long __timeout asm("3") = timeout;\r\nregister unsigned long __cmdp asm("4") = virt_to_phys(cmd);\r\nregister unsigned long __cmdl asm("5") = len;\r\nint err;\r\nerr = -EINVAL;\r\nasm volatile(\r\n" diag %1,%3,0x288\n"\r\n"0: la %0,0\n"\r\n"1:\n"\r\nEX_TABLE(0b,1b)\r\n: "+d" (err) : "d"(__func), "d"(__timeout),\r\n"d"(__cmdp), "d"(__cmdl) : "1", "cc");\r\nreturn err;\r\n}\r\nstatic int vmwdt_keepalive(void)\r\n{\r\nstatic char *ebc_cmd;\r\nsize_t len;\r\nint ret;\r\nunsigned int func;\r\nebc_cmd = kmalloc(MAX_CMDLEN, GFP_KERNEL);\r\nif (!ebc_cmd)\r\nreturn -ENOMEM;\r\nlen = strlcpy(ebc_cmd, vmwdt_cmd, MAX_CMDLEN);\r\nASCEBC(ebc_cmd, MAX_CMDLEN);\r\nEBC_TOUPPER(ebc_cmd, MAX_CMDLEN);\r\nfunc = vmwdt_conceal ? (wdt_init | wdt_conceal) : wdt_init;\r\nset_bit(VMWDT_RUNNING, &vmwdt_is_open);\r\nret = __diag288(func, vmwdt_interval, ebc_cmd, len);\r\nWARN_ON(ret != 0);\r\nkfree(ebc_cmd);\r\nreturn ret;\r\n}\r\nstatic int vmwdt_disable(void)\r\n{\r\nint ret = __diag288(wdt_cancel, 0, "", 0);\r\nWARN_ON(ret != 0);\r\nclear_bit(VMWDT_RUNNING, &vmwdt_is_open);\r\nreturn ret;\r\n}\r\nstatic int __init vmwdt_probe(void)\r\n{\r\nstatic char __initdata ebc_begin[] = {\r\n194, 197, 199, 201, 213\r\n};\r\nif (__diag288(wdt_init, 15, ebc_begin, sizeof(ebc_begin)) != 0)\r\nreturn -EINVAL;\r\nreturn vmwdt_disable();\r\n}\r\nstatic int vmwdt_open(struct inode *i, struct file *f)\r\n{\r\nint ret;\r\nif (test_and_set_bit(VMWDT_OPEN, &vmwdt_is_open))\r\nreturn -EBUSY;\r\nret = vmwdt_keepalive();\r\nif (ret)\r\nclear_bit(VMWDT_OPEN, &vmwdt_is_open);\r\nreturn ret ? ret : nonseekable_open(i, f);\r\n}\r\nstatic int vmwdt_close(struct inode *i, struct file *f)\r\n{\r\nif (vmwdt_expect_close == 42)\r\nvmwdt_disable();\r\nvmwdt_expect_close = 0;\r\nclear_bit(VMWDT_OPEN, &vmwdt_is_open);\r\nreturn 0;\r\n}\r\nstatic int __vmwdt_ioctl(unsigned int cmd, unsigned long arg)\r\n{\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nif (copy_to_user((void __user *)arg, &vmwdt_info,\r\nsizeof(vmwdt_info)))\r\nreturn -EFAULT;\r\nreturn 0;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nreturn put_user(0, (int __user *)arg);\r\ncase WDIOC_GETTEMP:\r\nreturn -EINVAL;\r\ncase WDIOC_SETOPTIONS:\r\n{\r\nint options, ret;\r\nif (get_user(options, (int __user *)arg))\r\nreturn -EFAULT;\r\nret = -EINVAL;\r\nif (options & WDIOS_DISABLECARD) {\r\nret = vmwdt_disable();\r\nif (ret)\r\nreturn ret;\r\n}\r\nif (options & WDIOS_ENABLECARD) {\r\nret = vmwdt_keepalive();\r\n}\r\nreturn ret;\r\n}\r\ncase WDIOC_GETTIMEOUT:\r\nreturn put_user(vmwdt_interval, (int __user *)arg);\r\ncase WDIOC_SETTIMEOUT:\r\n{\r\nint interval;\r\nif (get_user(interval, (int __user *)arg))\r\nreturn -EFAULT;\r\nif (interval < MIN_INTERVAL)\r\nreturn -EINVAL;\r\nvmwdt_interval = interval;\r\n}\r\nreturn vmwdt_keepalive();\r\ncase WDIOC_KEEPALIVE:\r\nreturn vmwdt_keepalive();\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic long vmwdt_ioctl(struct file *f, unsigned int cmd, unsigned long arg)\r\n{\r\nint rc;\r\nmutex_lock(&vmwdt_mutex);\r\nrc = __vmwdt_ioctl(cmd, arg);\r\nmutex_unlock(&vmwdt_mutex);\r\nreturn (long) rc;\r\n}\r\nstatic ssize_t vmwdt_write(struct file *f, const char __user *buf,\r\nsize_t count, loff_t *ppos)\r\n{\r\nif(count) {\r\nif (!vmwdt_nowayout) {\r\nsize_t i;\r\nvmwdt_expect_close = 0;\r\nfor (i = 0; i != count; i++) {\r\nchar c;\r\nif (get_user(c, buf+i))\r\nreturn -EFAULT;\r\nif (c == 'V')\r\nvmwdt_expect_close = 42;\r\n}\r\n}\r\nvmwdt_keepalive();\r\n}\r\nreturn count;\r\n}\r\nstatic int vmwdt_resume(void)\r\n{\r\nclear_bit(VMWDT_OPEN, &vmwdt_is_open);\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int vmwdt_suspend(void)\r\n{\r\nif (test_and_set_bit(VMWDT_OPEN, &vmwdt_is_open)) {\r\npr_err("The system cannot be suspended while the watchdog"\r\n" is in use\n");\r\nreturn notifier_from_errno(-EBUSY);\r\n}\r\nif (test_bit(VMWDT_RUNNING, &vmwdt_is_open)) {\r\nclear_bit(VMWDT_OPEN, &vmwdt_is_open);\r\npr_err("The system cannot be suspended while the watchdog"\r\n" is running\n");\r\nreturn notifier_from_errno(-EBUSY);\r\n}\r\nreturn NOTIFY_DONE;\r\n}\r\nstatic int vmwdt_power_event(struct notifier_block *this, unsigned long event,\r\nvoid *ptr)\r\n{\r\nswitch (event) {\r\ncase PM_POST_HIBERNATION:\r\ncase PM_POST_SUSPEND:\r\nreturn vmwdt_resume();\r\ncase PM_HIBERNATION_PREPARE:\r\ncase PM_SUSPEND_PREPARE:\r\nreturn vmwdt_suspend();\r\ndefault:\r\nreturn NOTIFY_DONE;\r\n}\r\n}\r\nstatic int __init vmwdt_init(void)\r\n{\r\nint ret;\r\nret = vmwdt_probe();\r\nif (ret)\r\nreturn ret;\r\nret = register_pm_notifier(&vmwdt_power_notifier);\r\nif (ret)\r\nreturn ret;\r\nret = misc_register(&vmwdt_dev);\r\nif (ret) {\r\nunregister_pm_notifier(&vmwdt_power_notifier);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit vmwdt_exit(void)\r\n{\r\nunregister_pm_notifier(&vmwdt_power_notifier);\r\nmisc_deregister(&vmwdt_dev);\r\n}

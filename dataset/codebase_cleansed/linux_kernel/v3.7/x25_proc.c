static void *x25_seq_route_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(x25_route_list_lock)\r\n{\r\nread_lock_bh(&x25_route_list_lock);\r\nreturn seq_list_start_head(&x25_route_list, *pos);\r\n}\r\nstatic void *x25_seq_route_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_list_next(v, &x25_route_list, pos);\r\n}\r\nstatic void x25_seq_route_stop(struct seq_file *seq, void *v)\r\n__releases(x25_route_list_lock)\r\n{\r\nread_unlock_bh(&x25_route_list_lock);\r\n}\r\nstatic int x25_seq_route_show(struct seq_file *seq, void *v)\r\n{\r\nstruct x25_route *rt = list_entry(v, struct x25_route, node);\r\nif (v == &x25_route_list) {\r\nseq_puts(seq, "Address Digits Device\n");\r\ngoto out;\r\n}\r\nrt = v;\r\nseq_printf(seq, "%-15s %-6d %-5s\n",\r\nrt->address.x25_addr, rt->sigdigits,\r\nrt->dev ? rt->dev->name : "???");\r\nout:\r\nreturn 0;\r\n}\r\nstatic void *x25_seq_socket_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(x25_list_lock)\r\n{\r\nread_lock_bh(&x25_list_lock);\r\nreturn seq_hlist_start_head(&x25_list, *pos);\r\n}\r\nstatic void *x25_seq_socket_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_hlist_next(v, &x25_list, pos);\r\n}\r\nstatic void x25_seq_socket_stop(struct seq_file *seq, void *v)\r\n__releases(x25_list_lock)\r\n{\r\nread_unlock_bh(&x25_list_lock);\r\n}\r\nstatic int x25_seq_socket_show(struct seq_file *seq, void *v)\r\n{\r\nstruct sock *s;\r\nstruct x25_sock *x25;\r\nstruct net_device *dev;\r\nconst char *devname;\r\nif (v == SEQ_START_TOKEN) {\r\nseq_printf(seq, "dest_addr src_addr dev lci st vs vr "\r\n"va t t2 t21 t22 t23 Snd-Q Rcv-Q inode\n");\r\ngoto out;\r\n}\r\ns = sk_entry(v);\r\nx25 = x25_sk(s);\r\nif (!x25->neighbour || (dev = x25->neighbour->dev) == NULL)\r\ndevname = "???";\r\nelse\r\ndevname = x25->neighbour->dev->name;\r\nseq_printf(seq, "%-10s %-10s %-5s %3.3X %d %d %d %d %3lu %3lu "\r\n"%3lu %3lu %3lu %5d %5d %ld\n",\r\n!x25->dest_addr.x25_addr[0] ? "*" : x25->dest_addr.x25_addr,\r\n!x25->source_addr.x25_addr[0] ? "*" : x25->source_addr.x25_addr,\r\ndevname, x25->lci & 0x0FFF, x25->state, x25->vs, x25->vr,\r\nx25->va, x25_display_timer(s) / HZ, x25->t2 / HZ,\r\nx25->t21 / HZ, x25->t22 / HZ, x25->t23 / HZ,\r\nsk_wmem_alloc_get(s),\r\nsk_rmem_alloc_get(s),\r\ns->sk_socket ? SOCK_INODE(s->sk_socket)->i_ino : 0L);\r\nout:\r\nreturn 0;\r\n}\r\nstatic void *x25_seq_forward_start(struct seq_file *seq, loff_t *pos)\r\n__acquires(x25_forward_list_lock)\r\n{\r\nread_lock_bh(&x25_forward_list_lock);\r\nreturn seq_list_start_head(&x25_forward_list, *pos);\r\n}\r\nstatic void *x25_seq_forward_next(struct seq_file *seq, void *v, loff_t *pos)\r\n{\r\nreturn seq_list_next(v, &x25_forward_list, pos);\r\n}\r\nstatic void x25_seq_forward_stop(struct seq_file *seq, void *v)\r\n__releases(x25_forward_list_lock)\r\n{\r\nread_unlock_bh(&x25_forward_list_lock);\r\n}\r\nstatic int x25_seq_forward_show(struct seq_file *seq, void *v)\r\n{\r\nstruct x25_forward *f = list_entry(v, struct x25_forward, node);\r\nif (v == &x25_forward_list) {\r\nseq_printf(seq, "lci dev1 dev2\n");\r\ngoto out;\r\n}\r\nf = v;\r\nseq_printf(seq, "%d %-10s %-10s\n",\r\nf->lci, f->dev1->name, f->dev2->name);\r\nout:\r\nreturn 0;\r\n}\r\nstatic int x25_seq_socket_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &x25_seq_socket_ops);\r\n}\r\nstatic int x25_seq_route_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &x25_seq_route_ops);\r\n}\r\nstatic int x25_seq_forward_open(struct inode *inode, struct file *file)\r\n{\r\nreturn seq_open(file, &x25_seq_forward_ops);\r\n}\r\nint __init x25_proc_init(void)\r\n{\r\nstruct proc_dir_entry *p;\r\nint rc = -ENOMEM;\r\nx25_proc_dir = proc_mkdir("x25", init_net.proc_net);\r\nif (!x25_proc_dir)\r\ngoto out;\r\np = proc_create("route", S_IRUGO, x25_proc_dir, &x25_seq_route_fops);\r\nif (!p)\r\ngoto out_route;\r\np = proc_create("socket", S_IRUGO, x25_proc_dir, &x25_seq_socket_fops);\r\nif (!p)\r\ngoto out_socket;\r\np = proc_create("forward", S_IRUGO, x25_proc_dir,\r\n&x25_seq_forward_fops);\r\nif (!p)\r\ngoto out_forward;\r\nrc = 0;\r\nout:\r\nreturn rc;\r\nout_forward:\r\nremove_proc_entry("socket", x25_proc_dir);\r\nout_socket:\r\nremove_proc_entry("route", x25_proc_dir);\r\nout_route:\r\nremove_proc_entry("x25", init_net.proc_net);\r\ngoto out;\r\n}\r\nvoid __exit x25_proc_exit(void)\r\n{\r\nremove_proc_entry("forward", x25_proc_dir);\r\nremove_proc_entry("route", x25_proc_dir);\r\nremove_proc_entry("socket", x25_proc_dir);\r\nremove_proc_entry("x25", init_net.proc_net);\r\n}\r\nint __init x25_proc_init(void)\r\n{\r\nreturn 0;\r\n}\r\nvoid __exit x25_proc_exit(void)\r\n{\r\n}

int bit_map_string_get(struct bit_map *t, int len, int align)\r\n{\r\nint offset, count;\r\nint off_new;\r\nint align1;\r\nint i, color;\r\nif (t->num_colors) {\r\ncolor = align;\r\nalign = t->num_colors;\r\n} else {\r\ncolor = 0;\r\nif (align == 0)\r\nalign = 1;\r\n}\r\nalign1 = align - 1;\r\nif ((align & align1) != 0)\r\nBUG();\r\nif (align < 0 || align >= t->size)\r\nBUG();\r\nif (len <= 0 || len > t->size)\r\nBUG();\r\ncolor &= align1;\r\nspin_lock(&t->lock);\r\nif (len < t->last_size)\r\noffset = t->first_free;\r\nelse\r\noffset = t->last_off & ~align1;\r\ncount = 0;\r\nfor (;;) {\r\noff_new = find_next_zero_bit(t->map, t->size, offset);\r\noff_new = ((off_new + align1) & ~align1) + color;\r\ncount += off_new - offset;\r\noffset = off_new;\r\nif (offset >= t->size)\r\noffset = 0;\r\nif (count + len > t->size) {\r\nspin_unlock(&t->lock);\r\nprintk(KERN_ERR\r\n"bitmap out: size %d used %d off %d len %d align %d count %d\n",\r\nt->size, t->used, offset, len, align, count);\r\nreturn -1;\r\n}\r\nif (offset + len > t->size) {\r\ncount += t->size - offset;\r\noffset = 0;\r\ncontinue;\r\n}\r\ni = 0;\r\nwhile (test_bit(offset + i, t->map) == 0) {\r\ni++;\r\nif (i == len) {\r\nbitmap_set(t->map, offset, len);\r\nif (offset == t->first_free)\r\nt->first_free = find_next_zero_bit\r\n(t->map, t->size,\r\nt->first_free + len);\r\nif ((t->last_off = offset + len) >= t->size)\r\nt->last_off = 0;\r\nt->used += len;\r\nt->last_size = len;\r\nspin_unlock(&t->lock);\r\nreturn offset;\r\n}\r\n}\r\ncount += i + 1;\r\nif ((offset += i + 1) >= t->size)\r\noffset = 0;\r\n}\r\n}\r\nvoid bit_map_clear(struct bit_map *t, int offset, int len)\r\n{\r\nint i;\r\nif (t->used < len)\r\nBUG();\r\nspin_lock(&t->lock);\r\nfor (i = 0; i < len; i++) {\r\nif (test_bit(offset + i, t->map) == 0)\r\nBUG();\r\n__clear_bit(offset + i, t->map);\r\n}\r\nif (offset < t->first_free)\r\nt->first_free = offset;\r\nt->used -= len;\r\nspin_unlock(&t->lock);\r\n}\r\nvoid bit_map_init(struct bit_map *t, unsigned long *map, int size)\r\n{\r\nif ((size & 07) != 0)\r\nBUG();\r\nmemset(map, 0, size>>3);\r\nmemset(t, 0, sizeof *t);\r\nspin_lock_init(&t->lock);\r\nt->map = map;\r\nt->size = size;\r\n}

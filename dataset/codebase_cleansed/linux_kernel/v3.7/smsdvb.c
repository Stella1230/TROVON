static void sms_board_dvb3_event(struct smsdvb_client_t *client,\r\nenum SMS_DVB3_EVENTS event) {\r\nstruct smscore_device_t *coredev = client->coredev;\r\nswitch (event) {\r\ncase DVB3_EVENT_INIT:\r\nsms_debug("DVB3_EVENT_INIT");\r\nsms_board_event(coredev, BOARD_EVENT_BIND);\r\nbreak;\r\ncase DVB3_EVENT_SLEEP:\r\nsms_debug("DVB3_EVENT_SLEEP");\r\nsms_board_event(coredev, BOARD_EVENT_POWER_SUSPEND);\r\nbreak;\r\ncase DVB3_EVENT_HOTPLUG:\r\nsms_debug("DVB3_EVENT_HOTPLUG");\r\nsms_board_event(coredev, BOARD_EVENT_POWER_INIT);\r\nbreak;\r\ncase DVB3_EVENT_FE_LOCK:\r\nif (client->event_fe_state != DVB3_EVENT_FE_LOCK) {\r\nclient->event_fe_state = DVB3_EVENT_FE_LOCK;\r\nsms_debug("DVB3_EVENT_FE_LOCK");\r\nsms_board_event(coredev, BOARD_EVENT_FE_LOCK);\r\n}\r\nbreak;\r\ncase DVB3_EVENT_FE_UNLOCK:\r\nif (client->event_fe_state != DVB3_EVENT_FE_UNLOCK) {\r\nclient->event_fe_state = DVB3_EVENT_FE_UNLOCK;\r\nsms_debug("DVB3_EVENT_FE_UNLOCK");\r\nsms_board_event(coredev, BOARD_EVENT_FE_UNLOCK);\r\n}\r\nbreak;\r\ncase DVB3_EVENT_UNC_OK:\r\nif (client->event_unc_state != DVB3_EVENT_UNC_OK) {\r\nclient->event_unc_state = DVB3_EVENT_UNC_OK;\r\nsms_debug("DVB3_EVENT_UNC_OK");\r\nsms_board_event(coredev, BOARD_EVENT_MULTIPLEX_OK);\r\n}\r\nbreak;\r\ncase DVB3_EVENT_UNC_ERR:\r\nif (client->event_unc_state != DVB3_EVENT_UNC_ERR) {\r\nclient->event_unc_state = DVB3_EVENT_UNC_ERR;\r\nsms_debug("DVB3_EVENT_UNC_ERR");\r\nsms_board_event(coredev, BOARD_EVENT_MULTIPLEX_ERRORS);\r\n}\r\nbreak;\r\ndefault:\r\nsms_err("Unknown dvb3 api event");\r\nbreak;\r\n}\r\n}\r\nstatic void smsdvb_update_dvb_stats(struct RECEPTION_STATISTICS_S *pReceptionData,\r\nstruct SMSHOSTLIB_STATISTICS_ST *p)\r\n{\r\nif (sms_dbg & 2) {\r\nprintk(KERN_DEBUG "Reserved = %d", p->Reserved);\r\nprintk(KERN_DEBUG "IsRfLocked = %d", p->IsRfLocked);\r\nprintk(KERN_DEBUG "IsDemodLocked = %d", p->IsDemodLocked);\r\nprintk(KERN_DEBUG "IsExternalLNAOn = %d", p->IsExternalLNAOn);\r\nprintk(KERN_DEBUG "SNR = %d", p->SNR);\r\nprintk(KERN_DEBUG "BER = %d", p->BER);\r\nprintk(KERN_DEBUG "FIB_CRC = %d", p->FIB_CRC);\r\nprintk(KERN_DEBUG "TS_PER = %d", p->TS_PER);\r\nprintk(KERN_DEBUG "MFER = %d", p->MFER);\r\nprintk(KERN_DEBUG "RSSI = %d", p->RSSI);\r\nprintk(KERN_DEBUG "InBandPwr = %d", p->InBandPwr);\r\nprintk(KERN_DEBUG "CarrierOffset = %d", p->CarrierOffset);\r\nprintk(KERN_DEBUG "Frequency = %d", p->Frequency);\r\nprintk(KERN_DEBUG "Bandwidth = %d", p->Bandwidth);\r\nprintk(KERN_DEBUG "TransmissionMode = %d", p->TransmissionMode);\r\nprintk(KERN_DEBUG "ModemState = %d", p->ModemState);\r\nprintk(KERN_DEBUG "GuardInterval = %d", p->GuardInterval);\r\nprintk(KERN_DEBUG "CodeRate = %d", p->CodeRate);\r\nprintk(KERN_DEBUG "LPCodeRate = %d", p->LPCodeRate);\r\nprintk(KERN_DEBUG "Hierarchy = %d", p->Hierarchy);\r\nprintk(KERN_DEBUG "Constellation = %d", p->Constellation);\r\nprintk(KERN_DEBUG "BurstSize = %d", p->BurstSize);\r\nprintk(KERN_DEBUG "BurstDuration = %d", p->BurstDuration);\r\nprintk(KERN_DEBUG "BurstCycleTime = %d", p->BurstCycleTime);\r\nprintk(KERN_DEBUG "CalculatedBurstCycleTime = %d", p->CalculatedBurstCycleTime);\r\nprintk(KERN_DEBUG "NumOfRows = %d", p->NumOfRows);\r\nprintk(KERN_DEBUG "NumOfPaddCols = %d", p->NumOfPaddCols);\r\nprintk(KERN_DEBUG "NumOfPunctCols = %d", p->NumOfPunctCols);\r\nprintk(KERN_DEBUG "ErrorTSPackets = %d", p->ErrorTSPackets);\r\nprintk(KERN_DEBUG "TotalTSPackets = %d", p->TotalTSPackets);\r\nprintk(KERN_DEBUG "NumOfValidMpeTlbs = %d", p->NumOfValidMpeTlbs);\r\nprintk(KERN_DEBUG "NumOfInvalidMpeTlbs = %d", p->NumOfInvalidMpeTlbs);\r\nprintk(KERN_DEBUG "NumOfCorrectedMpeTlbs = %d", p->NumOfCorrectedMpeTlbs);\r\nprintk(KERN_DEBUG "BERErrorCount = %d", p->BERErrorCount);\r\nprintk(KERN_DEBUG "BERBitCount = %d", p->BERBitCount);\r\nprintk(KERN_DEBUG "SmsToHostTxErrors = %d", p->SmsToHostTxErrors);\r\nprintk(KERN_DEBUG "PreBER = %d", p->PreBER);\r\nprintk(KERN_DEBUG "CellId = %d", p->CellId);\r\nprintk(KERN_DEBUG "DvbhSrvIndHP = %d", p->DvbhSrvIndHP);\r\nprintk(KERN_DEBUG "DvbhSrvIndLP = %d", p->DvbhSrvIndLP);\r\nprintk(KERN_DEBUG "NumMPEReceived = %d", p->NumMPEReceived);\r\n}\r\npReceptionData->IsDemodLocked = p->IsDemodLocked;\r\npReceptionData->SNR = p->SNR;\r\npReceptionData->BER = p->BER;\r\npReceptionData->BERErrorCount = p->BERErrorCount;\r\npReceptionData->InBandPwr = p->InBandPwr;\r\npReceptionData->ErrorTSPackets = p->ErrorTSPackets;\r\n}\r\nstatic void smsdvb_update_isdbt_stats(struct RECEPTION_STATISTICS_S *pReceptionData,\r\nstruct SMSHOSTLIB_STATISTICS_ISDBT_ST *p)\r\n{\r\nint i;\r\nif (sms_dbg & 2) {\r\nprintk(KERN_DEBUG "IsRfLocked = %d", p->IsRfLocked);\r\nprintk(KERN_DEBUG "IsDemodLocked = %d", p->IsDemodLocked);\r\nprintk(KERN_DEBUG "IsExternalLNAOn = %d", p->IsExternalLNAOn);\r\nprintk(KERN_DEBUG "SNR = %d", p->SNR);\r\nprintk(KERN_DEBUG "RSSI = %d", p->RSSI);\r\nprintk(KERN_DEBUG "InBandPwr = %d", p->InBandPwr);\r\nprintk(KERN_DEBUG "CarrierOffset = %d", p->CarrierOffset);\r\nprintk(KERN_DEBUG "Frequency = %d", p->Frequency);\r\nprintk(KERN_DEBUG "Bandwidth = %d", p->Bandwidth);\r\nprintk(KERN_DEBUG "TransmissionMode = %d", p->TransmissionMode);\r\nprintk(KERN_DEBUG "ModemState = %d", p->ModemState);\r\nprintk(KERN_DEBUG "GuardInterval = %d", p->GuardInterval);\r\nprintk(KERN_DEBUG "SystemType = %d", p->SystemType);\r\nprintk(KERN_DEBUG "PartialReception = %d", p->PartialReception);\r\nprintk(KERN_DEBUG "NumOfLayers = %d", p->NumOfLayers);\r\nprintk(KERN_DEBUG "SmsToHostTxErrors = %d", p->SmsToHostTxErrors);\r\nfor (i = 0; i < 3; i++) {\r\nprintk(KERN_DEBUG "%d: CodeRate = %d", i, p->LayerInfo[i].CodeRate);\r\nprintk(KERN_DEBUG "%d: Constellation = %d", i, p->LayerInfo[i].Constellation);\r\nprintk(KERN_DEBUG "%d: BER = %d", i, p->LayerInfo[i].BER);\r\nprintk(KERN_DEBUG "%d: BERErrorCount = %d", i, p->LayerInfo[i].BERErrorCount);\r\nprintk(KERN_DEBUG "%d: BERBitCount = %d", i, p->LayerInfo[i].BERBitCount);\r\nprintk(KERN_DEBUG "%d: PreBER = %d", i, p->LayerInfo[i].PreBER);\r\nprintk(KERN_DEBUG "%d: TS_PER = %d", i, p->LayerInfo[i].TS_PER);\r\nprintk(KERN_DEBUG "%d: ErrorTSPackets = %d", i, p->LayerInfo[i].ErrorTSPackets);\r\nprintk(KERN_DEBUG "%d: TotalTSPackets = %d", i, p->LayerInfo[i].TotalTSPackets);\r\nprintk(KERN_DEBUG "%d: TILdepthI = %d", i, p->LayerInfo[i].TILdepthI);\r\nprintk(KERN_DEBUG "%d: NumberOfSegments = %d", i, p->LayerInfo[i].NumberOfSegments);\r\nprintk(KERN_DEBUG "%d: TMCCErrors = %d", i, p->LayerInfo[i].TMCCErrors);\r\n}\r\n}\r\npReceptionData->IsDemodLocked = p->IsDemodLocked;\r\npReceptionData->SNR = p->SNR;\r\npReceptionData->InBandPwr = p->InBandPwr;\r\npReceptionData->ErrorTSPackets = 0;\r\npReceptionData->BER = 0;\r\npReceptionData->BERErrorCount = 0;\r\nfor (i = 0; i < 3; i++) {\r\npReceptionData->BER += p->LayerInfo[i].BER;\r\npReceptionData->BERErrorCount += p->LayerInfo[i].BERErrorCount;\r\npReceptionData->ErrorTSPackets += p->LayerInfo[i].ErrorTSPackets;\r\n}\r\n}\r\nstatic int smsdvb_onresponse(void *context, struct smscore_buffer_t *cb)\r\n{\r\nstruct smsdvb_client_t *client = (struct smsdvb_client_t *) context;\r\nstruct SmsMsgHdr_ST *phdr = (struct SmsMsgHdr_ST *) (((u8 *) cb->p)\r\n+ cb->offset);\r\nu32 *pMsgData = (u32 *) phdr + 1;\r\nbool is_status_update = false;\r\nsmsendian_handle_rx_message((struct SmsMsgData_ST *) phdr);\r\nswitch (phdr->msgType) {\r\ncase MSG_SMS_DVBT_BDA_DATA:\r\ndvb_dmx_swfilter(&client->demux, (u8 *)(phdr + 1),\r\ncb->size - sizeof(struct SmsMsgHdr_ST));\r\nbreak;\r\ncase MSG_SMS_RF_TUNE_RES:\r\ncase MSG_SMS_ISDBT_TUNE_RES:\r\ncomplete(&client->tune_done);\r\nbreak;\r\ncase MSG_SMS_SIGNAL_DETECTED_IND:\r\nsms_info("MSG_SMS_SIGNAL_DETECTED_IND");\r\nclient->sms_stat_dvb.TransmissionData.IsDemodLocked = true;\r\nis_status_update = true;\r\nbreak;\r\ncase MSG_SMS_NO_SIGNAL_IND:\r\nsms_info("MSG_SMS_NO_SIGNAL_IND");\r\nclient->sms_stat_dvb.TransmissionData.IsDemodLocked = false;\r\nis_status_update = true;\r\nbreak;\r\ncase MSG_SMS_TRANSMISSION_IND: {\r\nsms_info("MSG_SMS_TRANSMISSION_IND");\r\npMsgData++;\r\nmemcpy(&client->sms_stat_dvb.TransmissionData, pMsgData,\r\nsizeof(struct TRANSMISSION_STATISTICS_S));\r\nCORRECT_STAT_BANDWIDTH(client->sms_stat_dvb.TransmissionData);\r\nCORRECT_STAT_TRANSMISSON_MODE(\r\nclient->sms_stat_dvb.TransmissionData);\r\nis_status_update = true;\r\nbreak;\r\n}\r\ncase MSG_SMS_HO_PER_SLICES_IND: {\r\nstruct RECEPTION_STATISTICS_S *pReceptionData =\r\n&client->sms_stat_dvb.ReceptionData;\r\nstruct SRVM_SIGNAL_STATUS_S SignalStatusData;\r\npMsgData++;\r\nSignalStatusData.result = pMsgData[0];\r\nSignalStatusData.snr = pMsgData[1];\r\nSignalStatusData.inBandPower = (s32) pMsgData[2];\r\nSignalStatusData.tsPackets = pMsgData[3];\r\nSignalStatusData.etsPackets = pMsgData[4];\r\nSignalStatusData.constellation = pMsgData[5];\r\nSignalStatusData.hpCode = pMsgData[6];\r\nSignalStatusData.tpsSrvIndLP = pMsgData[7] & 0x03;\r\nSignalStatusData.tpsSrvIndHP = pMsgData[8] & 0x03;\r\nSignalStatusData.cellId = pMsgData[9] & 0xFFFF;\r\nSignalStatusData.reason = pMsgData[10];\r\nSignalStatusData.requestId = pMsgData[11];\r\npReceptionData->IsRfLocked = pMsgData[16];\r\npReceptionData->IsDemodLocked = pMsgData[17];\r\npReceptionData->ModemState = pMsgData[12];\r\npReceptionData->SNR = pMsgData[1];\r\npReceptionData->BER = pMsgData[13];\r\npReceptionData->RSSI = pMsgData[14];\r\nCORRECT_STAT_RSSI(client->sms_stat_dvb.ReceptionData);\r\npReceptionData->InBandPwr = (s32) pMsgData[2];\r\npReceptionData->CarrierOffset = (s32) pMsgData[15];\r\npReceptionData->TotalTSPackets = pMsgData[3];\r\npReceptionData->ErrorTSPackets = pMsgData[4];\r\nif ((SignalStatusData.tsPackets + SignalStatusData.etsPackets)\r\n> 0) {\r\npReceptionData->TS_PER = (SignalStatusData.etsPackets\r\n* 100) / (SignalStatusData.tsPackets\r\n+ SignalStatusData.etsPackets);\r\n} else {\r\npReceptionData->TS_PER = 0;\r\n}\r\npReceptionData->BERBitCount = pMsgData[18];\r\npReceptionData->BERErrorCount = pMsgData[19];\r\npReceptionData->MRC_SNR = pMsgData[20];\r\npReceptionData->MRC_InBandPwr = pMsgData[21];\r\npReceptionData->MRC_RSSI = pMsgData[22];\r\nis_status_update = true;\r\nbreak;\r\n}\r\ncase MSG_SMS_GET_STATISTICS_RES: {\r\nunion {\r\nstruct SMSHOSTLIB_STATISTICS_ISDBT_ST isdbt;\r\nstruct SmsMsgStatisticsInfo_ST dvb;\r\n} *p = (void *) (phdr + 1);\r\nstruct RECEPTION_STATISTICS_S *pReceptionData =\r\n&client->sms_stat_dvb.ReceptionData;\r\nsms_info("MSG_SMS_GET_STATISTICS_RES");\r\nis_status_update = true;\r\nswitch (smscore_get_device_mode(client->coredev)) {\r\ncase DEVICE_MODE_ISDBT:\r\ncase DEVICE_MODE_ISDBT_BDA:\r\nsmsdvb_update_isdbt_stats(pReceptionData, &p->isdbt);\r\nbreak;\r\ndefault:\r\nsmsdvb_update_dvb_stats(pReceptionData, &p->dvb.Stat);\r\n}\r\nif (!pReceptionData->IsDemodLocked) {\r\npReceptionData->SNR = 0;\r\npReceptionData->BER = 0;\r\npReceptionData->BERErrorCount = 0;\r\npReceptionData->InBandPwr = 0;\r\npReceptionData->ErrorTSPackets = 0;\r\n}\r\ncomplete(&client->tune_done);\r\nbreak;\r\n}\r\ndefault:\r\nsms_info("Unhandled message %d", phdr->msgType);\r\n}\r\nsmscore_putbuffer(client->coredev, cb);\r\nif (is_status_update) {\r\nif (client->sms_stat_dvb.ReceptionData.IsDemodLocked) {\r\nclient->fe_status = FE_HAS_SIGNAL | FE_HAS_CARRIER\r\n| FE_HAS_VITERBI | FE_HAS_SYNC | FE_HAS_LOCK;\r\nsms_board_dvb3_event(client, DVB3_EVENT_FE_LOCK);\r\nif (client->sms_stat_dvb.ReceptionData.ErrorTSPackets\r\n== 0)\r\nsms_board_dvb3_event(client, DVB3_EVENT_UNC_OK);\r\nelse\r\nsms_board_dvb3_event(client,\r\nDVB3_EVENT_UNC_ERR);\r\n} else {\r\nif (client->sms_stat_dvb.ReceptionData.IsRfLocked)\r\nclient->fe_status = FE_HAS_SIGNAL | FE_HAS_CARRIER;\r\nelse\r\nclient->fe_status = 0;\r\nsms_board_dvb3_event(client, DVB3_EVENT_FE_UNLOCK);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void smsdvb_unregister_client(struct smsdvb_client_t *client)\r\n{\r\nlist_del(&client->entry);\r\nsmscore_unregister_client(client->smsclient);\r\ndvb_unregister_frontend(&client->frontend);\r\ndvb_dmxdev_release(&client->dmxdev);\r\ndvb_dmx_release(&client->demux);\r\ndvb_unregister_adapter(&client->adapter);\r\nkfree(client);\r\n}\r\nstatic void smsdvb_onremove(void *context)\r\n{\r\nkmutex_lock(&g_smsdvb_clientslock);\r\nsmsdvb_unregister_client((struct smsdvb_client_t *) context);\r\nkmutex_unlock(&g_smsdvb_clientslock);\r\n}\r\nstatic int smsdvb_start_feed(struct dvb_demux_feed *feed)\r\n{\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(feed->demux, struct smsdvb_client_t, demux);\r\nstruct SmsMsgData_ST PidMsg;\r\nsms_debug("add pid %d(%x)",\r\nfeed->pid, feed->pid);\r\nPidMsg.xMsgHeader.msgSrcId = DVBT_BDA_CONTROL_MSG_ID;\r\nPidMsg.xMsgHeader.msgDstId = HIF_TASK;\r\nPidMsg.xMsgHeader.msgFlags = 0;\r\nPidMsg.xMsgHeader.msgType = MSG_SMS_ADD_PID_FILTER_REQ;\r\nPidMsg.xMsgHeader.msgLength = sizeof(PidMsg);\r\nPidMsg.msgData[0] = feed->pid;\r\nsmsendian_handle_tx_message((struct SmsMsgHdr_ST *)&PidMsg);\r\nreturn smsclient_sendrequest(client->smsclient,\r\n&PidMsg, sizeof(PidMsg));\r\n}\r\nstatic int smsdvb_stop_feed(struct dvb_demux_feed *feed)\r\n{\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(feed->demux, struct smsdvb_client_t, demux);\r\nstruct SmsMsgData_ST PidMsg;\r\nsms_debug("remove pid %d(%x)",\r\nfeed->pid, feed->pid);\r\nPidMsg.xMsgHeader.msgSrcId = DVBT_BDA_CONTROL_MSG_ID;\r\nPidMsg.xMsgHeader.msgDstId = HIF_TASK;\r\nPidMsg.xMsgHeader.msgFlags = 0;\r\nPidMsg.xMsgHeader.msgType = MSG_SMS_REMOVE_PID_FILTER_REQ;\r\nPidMsg.xMsgHeader.msgLength = sizeof(PidMsg);\r\nPidMsg.msgData[0] = feed->pid;\r\nsmsendian_handle_tx_message((struct SmsMsgHdr_ST *)&PidMsg);\r\nreturn smsclient_sendrequest(client->smsclient,\r\n&PidMsg, sizeof(PidMsg));\r\n}\r\nstatic int smsdvb_sendrequest_and_wait(struct smsdvb_client_t *client,\r\nvoid *buffer, size_t size,\r\nstruct completion *completion)\r\n{\r\nint rc;\r\nsmsendian_handle_tx_message((struct SmsMsgHdr_ST *)buffer);\r\nrc = smsclient_sendrequest(client->smsclient, buffer, size);\r\nif (rc < 0)\r\nreturn rc;\r\nreturn wait_for_completion_timeout(completion,\r\nmsecs_to_jiffies(2000)) ?\r\n0 : -ETIME;\r\n}\r\nstatic int smsdvb_send_statistics_request(struct smsdvb_client_t *client)\r\n{\r\nint rc;\r\nstruct SmsMsgHdr_ST Msg = { MSG_SMS_GET_STATISTICS_REQ,\r\nDVBT_BDA_CONTROL_MSG_ID,\r\nHIF_TASK,\r\nsizeof(struct SmsMsgHdr_ST), 0 };\r\nrc = smsdvb_sendrequest_and_wait(client, &Msg, sizeof(Msg),\r\n&client->tune_done);\r\nreturn rc;\r\n}\r\nstatic inline int led_feedback(struct smsdvb_client_t *client)\r\n{\r\nif (client->fe_status & FE_HAS_LOCK)\r\nreturn sms_board_led_feedback(client->coredev,\r\n(client->sms_stat_dvb.ReceptionData.BER\r\n== 0) ? SMS_LED_HI : SMS_LED_LO);\r\nelse\r\nreturn sms_board_led_feedback(client->coredev, SMS_LED_OFF);\r\n}\r\nstatic int smsdvb_read_status(struct dvb_frontend *fe, fe_status_t *stat)\r\n{\r\nint rc;\r\nstruct smsdvb_client_t *client;\r\nclient = container_of(fe, struct smsdvb_client_t, frontend);\r\nrc = smsdvb_send_statistics_request(client);\r\n*stat = client->fe_status;\r\nled_feedback(client);\r\nreturn rc;\r\n}\r\nstatic int smsdvb_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nint rc;\r\nstruct smsdvb_client_t *client;\r\nclient = container_of(fe, struct smsdvb_client_t, frontend);\r\nrc = smsdvb_send_statistics_request(client);\r\n*ber = client->sms_stat_dvb.ReceptionData.BER;\r\nled_feedback(client);\r\nreturn rc;\r\n}\r\nstatic int smsdvb_read_signal_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nint rc;\r\nstruct smsdvb_client_t *client;\r\nclient = container_of(fe, struct smsdvb_client_t, frontend);\r\nrc = smsdvb_send_statistics_request(client);\r\nif (client->sms_stat_dvb.ReceptionData.InBandPwr < -95)\r\n*strength = 0;\r\nelse if (client->sms_stat_dvb.ReceptionData.InBandPwr > -29)\r\n*strength = 100;\r\nelse\r\n*strength =\r\n(client->sms_stat_dvb.ReceptionData.InBandPwr\r\n+ 95) * 3 / 2;\r\nled_feedback(client);\r\nreturn rc;\r\n}\r\nstatic int smsdvb_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nint rc;\r\nstruct smsdvb_client_t *client;\r\nclient = container_of(fe, struct smsdvb_client_t, frontend);\r\nrc = smsdvb_send_statistics_request(client);\r\n*snr = client->sms_stat_dvb.ReceptionData.SNR;\r\nled_feedback(client);\r\nreturn rc;\r\n}\r\nstatic int smsdvb_read_ucblocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nint rc;\r\nstruct smsdvb_client_t *client;\r\nclient = container_of(fe, struct smsdvb_client_t, frontend);\r\nrc = smsdvb_send_statistics_request(client);\r\n*ucblocks = client->sms_stat_dvb.ReceptionData.ErrorTSPackets;\r\nled_feedback(client);\r\nreturn rc;\r\n}\r\nstatic int smsdvb_get_tune_settings(struct dvb_frontend *fe,\r\nstruct dvb_frontend_tune_settings *tune)\r\n{\r\nsms_debug("");\r\ntune->min_delay_ms = 400;\r\ntune->step_size = 250000;\r\ntune->max_drift = 0;\r\nreturn 0;\r\n}\r\nstatic int smsdvb_dvbt_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(fe, struct smsdvb_client_t, frontend);\r\nstruct {\r\nstruct SmsMsgHdr_ST Msg;\r\nu32 Data[3];\r\n} Msg;\r\nint ret;\r\nclient->fe_status = FE_HAS_SIGNAL;\r\nclient->event_fe_state = -1;\r\nclient->event_unc_state = -1;\r\nfe->dtv_property_cache.delivery_system = SYS_DVBT;\r\nMsg.Msg.msgSrcId = DVBT_BDA_CONTROL_MSG_ID;\r\nMsg.Msg.msgDstId = HIF_TASK;\r\nMsg.Msg.msgFlags = 0;\r\nMsg.Msg.msgType = MSG_SMS_RF_TUNE_REQ;\r\nMsg.Msg.msgLength = sizeof(Msg);\r\nMsg.Data[0] = c->frequency;\r\nMsg.Data[2] = 12000000;\r\nsms_info("%s: freq %d band %d", __func__, c->frequency,\r\nc->bandwidth_hz);\r\nswitch (c->bandwidth_hz / 1000000) {\r\ncase 8:\r\nMsg.Data[1] = BW_8_MHZ;\r\nbreak;\r\ncase 7:\r\nMsg.Data[1] = BW_7_MHZ;\r\nbreak;\r\ncase 6:\r\nMsg.Data[1] = BW_6_MHZ;\r\nbreak;\r\ncase 0:\r\nreturn -EOPNOTSUPP;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nret = sms_board_lna_control(client->coredev, 0);\r\nif (ret == 0) {\r\nfe_status_t status;\r\nret = smsdvb_sendrequest_and_wait(client, &Msg, sizeof(Msg),\r\n&client->tune_done);\r\nsmsdvb_read_status(fe, &status);\r\nif (status & FE_HAS_LOCK)\r\nreturn ret;\r\nsms_board_lna_control(client->coredev, 1);\r\n}\r\nreturn smsdvb_sendrequest_and_wait(client, &Msg, sizeof(Msg),\r\n&client->tune_done);\r\n}\r\nstatic int smsdvb_isdbt_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *c = &fe->dtv_property_cache;\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(fe, struct smsdvb_client_t, frontend);\r\nstruct {\r\nstruct SmsMsgHdr_ST Msg;\r\nu32 Data[4];\r\n} Msg;\r\nfe->dtv_property_cache.delivery_system = SYS_ISDBT;\r\nMsg.Msg.msgSrcId = DVBT_BDA_CONTROL_MSG_ID;\r\nMsg.Msg.msgDstId = HIF_TASK;\r\nMsg.Msg.msgFlags = 0;\r\nMsg.Msg.msgType = MSG_SMS_ISDBT_TUNE_REQ;\r\nMsg.Msg.msgLength = sizeof(Msg);\r\nif (c->isdbt_sb_segment_idx == -1)\r\nc->isdbt_sb_segment_idx = 0;\r\nswitch (c->isdbt_sb_segment_count) {\r\ncase 3:\r\nMsg.Data[1] = BW_ISDBT_3SEG;\r\nbreak;\r\ncase 1:\r\nMsg.Data[1] = BW_ISDBT_1SEG;\r\nbreak;\r\ncase 0:\r\nswitch (c->bandwidth_hz / 1000000) {\r\ncase 8:\r\ncase 7:\r\nc->isdbt_sb_segment_count = 3;\r\nMsg.Data[1] = BW_ISDBT_3SEG;\r\nbreak;\r\ncase 6:\r\nc->isdbt_sb_segment_count = 1;\r\nMsg.Data[1] = BW_ISDBT_1SEG;\r\nbreak;\r\ndefault:\r\nc->isdbt_sb_segment_count = 1;\r\nc->bandwidth_hz = 6000;\r\nMsg.Data[1] = BW_ISDBT_1SEG;\r\nbreak;\r\n}\r\nbreak;\r\ndefault:\r\nsms_info("Segment count %d not supported", c->isdbt_sb_segment_count);\r\nreturn -EINVAL;\r\n}\r\nMsg.Data[0] = c->frequency;\r\nMsg.Data[2] = 12000000;\r\nMsg.Data[3] = c->isdbt_sb_segment_idx;\r\nsms_info("%s: freq %d segwidth %d segindex %d\n", __func__,\r\nc->frequency, c->isdbt_sb_segment_count,\r\nc->isdbt_sb_segment_idx);\r\nreturn smsdvb_sendrequest_and_wait(client, &Msg, sizeof(Msg),\r\n&client->tune_done);\r\n}\r\nstatic int smsdvb_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(fe, struct smsdvb_client_t, frontend);\r\nstruct smscore_device_t *coredev = client->coredev;\r\nswitch (smscore_get_device_mode(coredev)) {\r\ncase DEVICE_MODE_DVBT:\r\ncase DEVICE_MODE_DVBT_BDA:\r\nreturn smsdvb_dvbt_set_frontend(fe);\r\ncase DEVICE_MODE_ISDBT:\r\ncase DEVICE_MODE_ISDBT_BDA:\r\nreturn smsdvb_isdbt_set_frontend(fe);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nstatic int smsdvb_get_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *fep = &fe->dtv_property_cache;\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(fe, struct smsdvb_client_t, frontend);\r\nstruct smscore_device_t *coredev = client->coredev;\r\nstruct TRANSMISSION_STATISTICS_S *td =\r\n&client->sms_stat_dvb.TransmissionData;\r\nswitch (smscore_get_device_mode(coredev)) {\r\ncase DEVICE_MODE_DVBT:\r\ncase DEVICE_MODE_DVBT_BDA:\r\nfep->frequency = td->Frequency;\r\nswitch (td->Bandwidth) {\r\ncase 6:\r\nfep->bandwidth_hz = 6000000;\r\nbreak;\r\ncase 7:\r\nfep->bandwidth_hz = 7000000;\r\nbreak;\r\ncase 8:\r\nfep->bandwidth_hz = 8000000;\r\nbreak;\r\n}\r\nswitch (td->TransmissionMode) {\r\ncase 2:\r\nfep->transmission_mode = TRANSMISSION_MODE_2K;\r\nbreak;\r\ncase 8:\r\nfep->transmission_mode = TRANSMISSION_MODE_8K;\r\n}\r\nswitch (td->GuardInterval) {\r\ncase 0:\r\nfep->guard_interval = GUARD_INTERVAL_1_32;\r\nbreak;\r\ncase 1:\r\nfep->guard_interval = GUARD_INTERVAL_1_16;\r\nbreak;\r\ncase 2:\r\nfep->guard_interval = GUARD_INTERVAL_1_8;\r\nbreak;\r\ncase 3:\r\nfep->guard_interval = GUARD_INTERVAL_1_4;\r\nbreak;\r\n}\r\nswitch (td->CodeRate) {\r\ncase 0:\r\nfep->code_rate_HP = FEC_1_2;\r\nbreak;\r\ncase 1:\r\nfep->code_rate_HP = FEC_2_3;\r\nbreak;\r\ncase 2:\r\nfep->code_rate_HP = FEC_3_4;\r\nbreak;\r\ncase 3:\r\nfep->code_rate_HP = FEC_5_6;\r\nbreak;\r\ncase 4:\r\nfep->code_rate_HP = FEC_7_8;\r\nbreak;\r\n}\r\nswitch (td->LPCodeRate) {\r\ncase 0:\r\nfep->code_rate_LP = FEC_1_2;\r\nbreak;\r\ncase 1:\r\nfep->code_rate_LP = FEC_2_3;\r\nbreak;\r\ncase 2:\r\nfep->code_rate_LP = FEC_3_4;\r\nbreak;\r\ncase 3:\r\nfep->code_rate_LP = FEC_5_6;\r\nbreak;\r\ncase 4:\r\nfep->code_rate_LP = FEC_7_8;\r\nbreak;\r\n}\r\nswitch (td->Constellation) {\r\ncase 0:\r\nfep->modulation = QPSK;\r\nbreak;\r\ncase 1:\r\nfep->modulation = QAM_16;\r\nbreak;\r\ncase 2:\r\nfep->modulation = QAM_64;\r\nbreak;\r\n}\r\nswitch (td->Hierarchy) {\r\ncase 0:\r\nfep->hierarchy = HIERARCHY_NONE;\r\nbreak;\r\ncase 1:\r\nfep->hierarchy = HIERARCHY_1;\r\nbreak;\r\ncase 2:\r\nfep->hierarchy = HIERARCHY_2;\r\nbreak;\r\ncase 3:\r\nfep->hierarchy = HIERARCHY_4;\r\nbreak;\r\n}\r\nfep->inversion = INVERSION_AUTO;\r\nbreak;\r\ncase DEVICE_MODE_ISDBT:\r\ncase DEVICE_MODE_ISDBT_BDA:\r\nfep->frequency = td->Frequency;\r\nfep->bandwidth_hz = 6000000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int smsdvb_init(struct dvb_frontend *fe)\r\n{\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(fe, struct smsdvb_client_t, frontend);\r\nsms_board_power(client->coredev, 1);\r\nsms_board_dvb3_event(client, DVB3_EVENT_INIT);\r\nreturn 0;\r\n}\r\nstatic int smsdvb_sleep(struct dvb_frontend *fe)\r\n{\r\nstruct smsdvb_client_t *client =\r\ncontainer_of(fe, struct smsdvb_client_t, frontend);\r\nsms_board_led_feedback(client->coredev, SMS_LED_OFF);\r\nsms_board_power(client->coredev, 0);\r\nsms_board_dvb3_event(client, DVB3_EVENT_SLEEP);\r\nreturn 0;\r\n}\r\nstatic void smsdvb_release(struct dvb_frontend *fe)\r\n{\r\n}\r\nstatic int smsdvb_hotplug(struct smscore_device_t *coredev,\r\nstruct device *device, int arrival)\r\n{\r\nstruct smsclient_params_t params;\r\nstruct smsdvb_client_t *client;\r\nint rc;\r\nif (!arrival)\r\nreturn 0;\r\nclient = kzalloc(sizeof(struct smsdvb_client_t), GFP_KERNEL);\r\nif (!client) {\r\nsms_err("kmalloc() failed");\r\nreturn -ENOMEM;\r\n}\r\nrc = dvb_register_adapter(&client->adapter,\r\nsms_get_board(\r\nsmscore_get_board_id(coredev))->name,\r\nTHIS_MODULE, device, adapter_nr);\r\nif (rc < 0) {\r\nsms_err("dvb_register_adapter() failed %d", rc);\r\ngoto adapter_error;\r\n}\r\nclient->demux.dmx.capabilities = DMX_TS_FILTERING;\r\nclient->demux.filternum = 32;\r\nclient->demux.feednum = 32;\r\nclient->demux.start_feed = smsdvb_start_feed;\r\nclient->demux.stop_feed = smsdvb_stop_feed;\r\nrc = dvb_dmx_init(&client->demux);\r\nif (rc < 0) {\r\nsms_err("dvb_dmx_init failed %d", rc);\r\ngoto dvbdmx_error;\r\n}\r\nclient->dmxdev.filternum = 32;\r\nclient->dmxdev.demux = &client->demux.dmx;\r\nclient->dmxdev.capabilities = 0;\r\nrc = dvb_dmxdev_init(&client->dmxdev, &client->adapter);\r\nif (rc < 0) {\r\nsms_err("dvb_dmxdev_init failed %d", rc);\r\ngoto dmxdev_error;\r\n}\r\nmemcpy(&client->frontend.ops, &smsdvb_fe_ops,\r\nsizeof(struct dvb_frontend_ops));\r\nswitch (smscore_get_device_mode(coredev)) {\r\ncase DEVICE_MODE_DVBT:\r\ncase DEVICE_MODE_DVBT_BDA:\r\nclient->frontend.ops.delsys[0] = SYS_DVBT;\r\nbreak;\r\ncase DEVICE_MODE_ISDBT:\r\ncase DEVICE_MODE_ISDBT_BDA:\r\nclient->frontend.ops.delsys[0] = SYS_ISDBT;\r\nbreak;\r\n}\r\nrc = dvb_register_frontend(&client->adapter, &client->frontend);\r\nif (rc < 0) {\r\nsms_err("frontend registration failed %d", rc);\r\ngoto frontend_error;\r\n}\r\nparams.initial_id = 1;\r\nparams.data_type = MSG_SMS_DVBT_BDA_DATA;\r\nparams.onresponse_handler = smsdvb_onresponse;\r\nparams.onremove_handler = smsdvb_onremove;\r\nparams.context = client;\r\nrc = smscore_register_client(coredev, &params, &client->smsclient);\r\nif (rc < 0) {\r\nsms_err("smscore_register_client() failed %d", rc);\r\ngoto client_error;\r\n}\r\nclient->coredev = coredev;\r\ninit_completion(&client->tune_done);\r\nkmutex_lock(&g_smsdvb_clientslock);\r\nlist_add(&client->entry, &g_smsdvb_clients);\r\nkmutex_unlock(&g_smsdvb_clientslock);\r\nclient->event_fe_state = -1;\r\nclient->event_unc_state = -1;\r\nsms_board_dvb3_event(client, DVB3_EVENT_HOTPLUG);\r\nsms_info("success");\r\nsms_board_setup(coredev);\r\nreturn 0;\r\nclient_error:\r\ndvb_unregister_frontend(&client->frontend);\r\nfrontend_error:\r\ndvb_dmxdev_release(&client->dmxdev);\r\ndmxdev_error:\r\ndvb_dmx_release(&client->demux);\r\ndvbdmx_error:\r\ndvb_unregister_adapter(&client->adapter);\r\nadapter_error:\r\nkfree(client);\r\nreturn rc;\r\n}\r\nstatic int __init smsdvb_module_init(void)\r\n{\r\nint rc;\r\nINIT_LIST_HEAD(&g_smsdvb_clients);\r\nkmutex_init(&g_smsdvb_clientslock);\r\nrc = smscore_register_hotplug(smsdvb_hotplug);\r\nsms_debug("");\r\nreturn rc;\r\n}\r\nstatic void __exit smsdvb_module_exit(void)\r\n{\r\nsmscore_unregister_hotplug(smsdvb_hotplug);\r\nkmutex_lock(&g_smsdvb_clientslock);\r\nwhile (!list_empty(&g_smsdvb_clients))\r\nsmsdvb_unregister_client(\r\n(struct smsdvb_client_t *) g_smsdvb_clients.next);\r\nkmutex_unlock(&g_smsdvb_clientslock);\r\n}

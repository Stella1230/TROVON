static size_t copy_from_user_mvcos(size_t size, const void __user *ptr, void *x)\r\n{\r\nregister unsigned long reg0 asm("0") = 0x81UL;\r\nunsigned long tmp1, tmp2;\r\ntmp1 = -4096UL;\r\nasm volatile(\r\n"0: .insn ss,0xc80000000000,0(%0,%2),0(%1),0\n"\r\n"9: jz 7f\n"\r\n"1:"ALR" %0,%3\n"\r\n" "SLR" %1,%3\n"\r\n" "SLR" %2,%3\n"\r\n" j 0b\n"\r\n"2: la %4,4095(%1)\n"\r\n" nr %4,%3\n"\r\n" "SLR" %4,%1\n"\r\n" "CLR" %0,%4\n"\r\n" jnh 4f\n"\r\n"3: .insn ss,0xc80000000000,0(%4,%2),0(%1),0\n"\r\n"10:"SLR" %0,%4\n"\r\n" "ALR" %2,%4\n"\r\n"4:"LHI" %4,-1\n"\r\n" "ALR" %4,%0\n"\r\n" bras %3,6f\n"\r\n" xc 0(1,%2),0(%2)\n"\r\n"5: xc 0(256,%2),0(%2)\n"\r\n" la %2,256(%2)\n"\r\n"6:"AHI" %4,-256\n"\r\n" jnm 5b\n"\r\n" ex %4,0(%3)\n"\r\n" j 8f\n"\r\n"7:"SLR" %0,%0\n"\r\n"8: \n"\r\nEX_TABLE(0b,2b) EX_TABLE(3b,4b) EX_TABLE(9b,2b) EX_TABLE(10b,4b)\r\n: "+a" (size), "+a" (ptr), "+a" (x), "+a" (tmp1), "=a" (tmp2)\r\n: "d" (reg0) : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t copy_from_user_mvcos_check(size_t size, const void __user *ptr, void *x)\r\n{\r\nif (size <= 256)\r\nreturn copy_from_user_std(size, ptr, x);\r\nreturn copy_from_user_mvcos(size, ptr, x);\r\n}\r\nstatic size_t copy_to_user_mvcos(size_t size, void __user *ptr, const void *x)\r\n{\r\nregister unsigned long reg0 asm("0") = 0x810000UL;\r\nunsigned long tmp1, tmp2;\r\ntmp1 = -4096UL;\r\nasm volatile(\r\n"0: .insn ss,0xc80000000000,0(%0,%1),0(%2),0\n"\r\n"6: jz 4f\n"\r\n"1:"ALR" %0,%3\n"\r\n" "SLR" %1,%3\n"\r\n" "SLR" %2,%3\n"\r\n" j 0b\n"\r\n"2: la %4,4095(%1)\n"\r\n" nr %4,%3\n"\r\n" "SLR" %4,%1\n"\r\n" "CLR" %0,%4\n"\r\n" jnh 5f\n"\r\n"3: .insn ss,0xc80000000000,0(%4,%1),0(%2),0\n"\r\n"7:"SLR" %0,%4\n"\r\n" j 5f\n"\r\n"4:"SLR" %0,%0\n"\r\n"5: \n"\r\nEX_TABLE(0b,2b) EX_TABLE(3b,5b) EX_TABLE(6b,2b) EX_TABLE(7b,5b)\r\n: "+a" (size), "+a" (ptr), "+a" (x), "+a" (tmp1), "=a" (tmp2)\r\n: "d" (reg0) : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t copy_to_user_mvcos_check(size_t size, void __user *ptr,\r\nconst void *x)\r\n{\r\nif (size <= 256)\r\nreturn copy_to_user_std(size, ptr, x);\r\nreturn copy_to_user_mvcos(size, ptr, x);\r\n}\r\nstatic size_t copy_in_user_mvcos(size_t size, void __user *to,\r\nconst void __user *from)\r\n{\r\nregister unsigned long reg0 asm("0") = 0x810081UL;\r\nunsigned long tmp1, tmp2;\r\ntmp1 = -4096UL;\r\nasm volatile(\r\n"0: .insn ss,0xc80000000000,0(%0,%1),0(%2),0\n"\r\n" jz 2f\n"\r\n"1:"ALR" %0,%3\n"\r\n" "SLR" %1,%3\n"\r\n" "SLR" %2,%3\n"\r\n" j 0b\n"\r\n"2:"SLR" %0,%0\n"\r\n"3: \n"\r\nEX_TABLE(0b,3b)\r\n: "+a" (size), "+a" (to), "+a" (from), "+a" (tmp1), "=a" (tmp2)\r\n: "d" (reg0) : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t clear_user_mvcos(size_t size, void __user *to)\r\n{\r\nregister unsigned long reg0 asm("0") = 0x810000UL;\r\nunsigned long tmp1, tmp2;\r\ntmp1 = -4096UL;\r\nasm volatile(\r\n"0: .insn ss,0xc80000000000,0(%0,%1),0(%4),0\n"\r\n" jz 4f\n"\r\n"1:"ALR" %0,%2\n"\r\n" "SLR" %1,%2\n"\r\n" j 0b\n"\r\n"2: la %3,4095(%1)\n"\r\n" nr %3,%2\n"\r\n" "SLR" %3,%1\n"\r\n" "CLR" %0,%3\n"\r\n" jnh 5f\n"\r\n"3: .insn ss,0xc80000000000,0(%3,%1),0(%4),0\n"\r\n" "SLR" %0,%3\n"\r\n" j 5f\n"\r\n"4:"SLR" %0,%0\n"\r\n"5: \n"\r\nEX_TABLE(0b,2b) EX_TABLE(3b,5b)\r\n: "+a" (size), "+a" (to), "+a" (tmp1), "=a" (tmp2)\r\n: "a" (empty_zero_page), "d" (reg0) : "cc", "memory");\r\nreturn size;\r\n}\r\nstatic size_t strnlen_user_mvcos(size_t count, const char __user *src)\r\n{\r\nchar buf[256];\r\nint rc;\r\nsize_t done, len, len_str;\r\ndone = 0;\r\ndo {\r\nlen = min(count - done, (size_t) 256);\r\nrc = uaccess.copy_from_user(len, src + done, buf);\r\nif (unlikely(rc == len))\r\nreturn 0;\r\nlen -= rc;\r\nlen_str = strnlen(buf, len);\r\ndone += len_str;\r\n} while ((len_str == len) && (done < count));\r\nreturn done + 1;\r\n}\r\nstatic size_t strncpy_from_user_mvcos(size_t count, const char __user *src,\r\nchar *dst)\r\n{\r\nint rc;\r\nsize_t done, len, len_str;\r\ndone = 0;\r\ndo {\r\nlen = min(count - done, (size_t) 4096);\r\nrc = uaccess.copy_from_user(len, src + done, dst);\r\nif (unlikely(rc == len))\r\nreturn -EFAULT;\r\nlen -= rc;\r\nlen_str = strnlen(dst, len);\r\ndone += len_str;\r\n} while ((len_str == len) && (done < count));\r\nreturn done;\r\n}

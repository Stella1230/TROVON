static irqreturn_t htcpen_interrupt(int irq, void *handle)\r\n{\r\nstruct input_dev *htcpen_dev = handle;\r\nunsigned short x, y, xy;\r\noutb_p(TOUCH_INDEX, HTCPEN_PORT_INDEX);\r\nif (inb_p(HTCPEN_PORT_DATA)) {\r\ninput_report_key(htcpen_dev, BTN_TOUCH, 0);\r\n} else {\r\noutb_p(X_INDEX, HTCPEN_PORT_INDEX);\r\nx = inb_p(HTCPEN_PORT_DATA);\r\noutb_p(Y_INDEX, HTCPEN_PORT_INDEX);\r\ny = inb_p(HTCPEN_PORT_DATA);\r\noutb_p(LSB_XY_INDEX, HTCPEN_PORT_INDEX);\r\nxy = inb_p(HTCPEN_PORT_DATA);\r\nx = X_AXIS_MAX - ((x * 8) + ((xy >> 4) & 0xf));\r\ny = (y * 8) + (xy & 0xf);\r\nif (invert_x)\r\nx = X_AXIS_MAX - x;\r\nif (invert_y)\r\ny = Y_AXIS_MAX - y;\r\nif (x != X_AXIS_MAX && x != 0) {\r\ninput_report_key(htcpen_dev, BTN_TOUCH, 1);\r\ninput_report_abs(htcpen_dev, ABS_X, x);\r\ninput_report_abs(htcpen_dev, ABS_Y, y);\r\n}\r\n}\r\ninput_sync(htcpen_dev);\r\ninb_p(HTCPEN_PORT_IRQ_CLEAR);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int htcpen_open(struct input_dev *dev)\r\n{\r\noutb_p(DEVICE_ENABLE, HTCPEN_PORT_INIT);\r\nreturn 0;\r\n}\r\nstatic void htcpen_close(struct input_dev *dev)\r\n{\r\noutb_p(DEVICE_DISABLE, HTCPEN_PORT_INIT);\r\nsynchronize_irq(HTCPEN_IRQ);\r\n}\r\nstatic int __devinit htcpen_isa_probe(struct device *dev, unsigned int id)\r\n{\r\nstruct input_dev *htcpen_dev;\r\nint err = -EBUSY;\r\nif (!request_region(HTCPEN_PORT_IRQ_CLEAR, 1, "htcpen")) {\r\nprintk(KERN_ERR "htcpen: unable to get IO region 0x%x\n",\r\nHTCPEN_PORT_IRQ_CLEAR);\r\ngoto request_region1_failed;\r\n}\r\nif (!request_region(HTCPEN_PORT_INIT, 1, "htcpen")) {\r\nprintk(KERN_ERR "htcpen: unable to get IO region 0x%x\n",\r\nHTCPEN_PORT_INIT);\r\ngoto request_region2_failed;\r\n}\r\nif (!request_region(HTCPEN_PORT_INDEX, 2, "htcpen")) {\r\nprintk(KERN_ERR "htcpen: unable to get IO region 0x%x\n",\r\nHTCPEN_PORT_INDEX);\r\ngoto request_region3_failed;\r\n}\r\nhtcpen_dev = input_allocate_device();\r\nif (!htcpen_dev) {\r\nprintk(KERN_ERR "htcpen: can't allocate device\n");\r\nerr = -ENOMEM;\r\ngoto input_alloc_failed;\r\n}\r\nhtcpen_dev->name = "HTC Shift EC TouchScreen";\r\nhtcpen_dev->id.bustype = BUS_ISA;\r\nhtcpen_dev->evbit[0] = BIT_MASK(EV_ABS) | BIT_MASK(EV_KEY);\r\nhtcpen_dev->keybit[BIT_WORD(BTN_TOUCH)] = BIT_MASK(BTN_TOUCH);\r\ninput_set_abs_params(htcpen_dev, ABS_X, 0, X_AXIS_MAX, 0, 0);\r\ninput_set_abs_params(htcpen_dev, ABS_Y, 0, Y_AXIS_MAX, 0, 0);\r\nhtcpen_dev->open = htcpen_open;\r\nhtcpen_dev->close = htcpen_close;\r\nerr = request_irq(HTCPEN_IRQ, htcpen_interrupt, 0, "htcpen",\r\nhtcpen_dev);\r\nif (err) {\r\nprintk(KERN_ERR "htcpen: irq busy\n");\r\ngoto request_irq_failed;\r\n}\r\ninb_p(HTCPEN_PORT_IRQ_CLEAR);\r\nerr = input_register_device(htcpen_dev);\r\nif (err)\r\ngoto input_register_failed;\r\ndev_set_drvdata(dev, htcpen_dev);\r\nreturn 0;\r\ninput_register_failed:\r\nfree_irq(HTCPEN_IRQ, htcpen_dev);\r\nrequest_irq_failed:\r\ninput_free_device(htcpen_dev);\r\ninput_alloc_failed:\r\nrelease_region(HTCPEN_PORT_INDEX, 2);\r\nrequest_region3_failed:\r\nrelease_region(HTCPEN_PORT_INIT, 1);\r\nrequest_region2_failed:\r\nrelease_region(HTCPEN_PORT_IRQ_CLEAR, 1);\r\nrequest_region1_failed:\r\nreturn err;\r\n}\r\nstatic int __devexit htcpen_isa_remove(struct device *dev, unsigned int id)\r\n{\r\nstruct input_dev *htcpen_dev = dev_get_drvdata(dev);\r\ninput_unregister_device(htcpen_dev);\r\nfree_irq(HTCPEN_IRQ, htcpen_dev);\r\nrelease_region(HTCPEN_PORT_INDEX, 2);\r\nrelease_region(HTCPEN_PORT_INIT, 1);\r\nrelease_region(HTCPEN_PORT_IRQ_CLEAR, 1);\r\ndev_set_drvdata(dev, NULL);\r\nreturn 0;\r\n}\r\nstatic int htcpen_isa_suspend(struct device *dev, unsigned int n,\r\npm_message_t state)\r\n{\r\noutb_p(DEVICE_DISABLE, HTCPEN_PORT_INIT);\r\nreturn 0;\r\n}\r\nstatic int htcpen_isa_resume(struct device *dev, unsigned int n)\r\n{\r\noutb_p(DEVICE_ENABLE, HTCPEN_PORT_INIT);\r\nreturn 0;\r\n}\r\nstatic int __init htcpen_isa_init(void)\r\n{\r\nif (!dmi_check_system(htcshift_dmi_table))\r\nreturn -ENODEV;\r\nreturn isa_register_driver(&htcpen_isa_driver, 1);\r\n}\r\nstatic void __exit htcpen_isa_exit(void)\r\n{\r\nisa_unregister_driver(&htcpen_isa_driver);\r\n}

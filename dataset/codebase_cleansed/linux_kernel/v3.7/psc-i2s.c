static int au1xpsc_i2s_set_fmt(struct snd_soc_dai *cpu_dai,\r\nunsigned int fmt)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(cpu_dai);\r\nunsigned long ct;\r\nint ret;\r\nret = -EINVAL;\r\nct = pscdata->cfg;\r\nct &= ~(PSC_I2SCFG_XM | PSC_I2SCFG_MLJ);\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\nct |= PSC_I2SCFG_XM;\r\nbreak;\r\ncase SND_SOC_DAIFMT_MSB:\r\nbreak;\r\ncase SND_SOC_DAIFMT_LSB:\r\nct |= PSC_I2SCFG_MLJ;\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nct &= ~(PSC_I2SCFG_BI | PSC_I2SCFG_WI);\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\nct |= PSC_I2SCFG_BI | PSC_I2SCFG_WI;\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\nct |= PSC_I2SCFG_BI;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\nct |= PSC_I2SCFG_WI;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_IF:\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBM_CFM:\r\nct |= PSC_I2SCFG_MS;\r\nbreak;\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nct &= ~PSC_I2SCFG_MS;\r\nbreak;\r\ndefault:\r\ngoto out;\r\n}\r\npscdata->cfg = ct;\r\nret = 0;\r\nout:\r\nreturn ret;\r\n}\r\nstatic int au1xpsc_i2s_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(dai);\r\nint cfgbits;\r\nunsigned long stat;\r\nstat = au_readl(I2S_STAT(pscdata));\r\nif (stat & (PSC_I2SSTAT_TB | PSC_I2SSTAT_RB)) {\r\ncfgbits = au_readl(I2S_CFG(pscdata));\r\nif ((PSC_I2SCFG_GET_LEN(cfgbits) != params->msbits) ||\r\n(params_rate(params) != pscdata->rate))\r\nreturn -EINVAL;\r\n} else {\r\npscdata->cfg &= ~(0x1f << 4);\r\npscdata->cfg |= PSC_I2SCFG_SET_LEN(params->msbits);\r\npscdata->rate = params_rate(params);\r\n}\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_i2s_configure(struct au1xpsc_audio_data *pscdata)\r\n{\r\nunsigned long tmo;\r\nau_writel(PSC_CTRL_ENABLE, PSC_CTRL(pscdata));\r\nau_sync();\r\ntmo = 1000000;\r\nwhile (!(au_readl(I2S_STAT(pscdata)) & PSC_I2SSTAT_SR) && tmo)\r\ntmo--;\r\nif (!tmo)\r\ngoto psc_err;\r\nau_writel(0, I2S_CFG(pscdata));\r\nau_sync();\r\nau_writel(pscdata->cfg | PSC_I2SCFG_DE_ENABLE, I2S_CFG(pscdata));\r\nau_sync();\r\ntmo = 1000000;\r\nwhile (!(au_readl(I2S_STAT(pscdata)) & PSC_I2SSTAT_DR) && tmo)\r\ntmo--;\r\nif (tmo)\r\nreturn 0;\r\npsc_err:\r\nau_writel(0, I2S_CFG(pscdata));\r\nau_writel(PSC_CTRL_SUSPEND, PSC_CTRL(pscdata));\r\nau_sync();\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic int au1xpsc_i2s_start(struct au1xpsc_audio_data *pscdata, int stype)\r\n{\r\nunsigned long tmo, stat;\r\nint ret;\r\nret = 0;\r\nstat = au_readl(I2S_STAT(pscdata));\r\nif (!(stat & (PSC_I2SSTAT_TB | PSC_I2SSTAT_RB))) {\r\nret = au1xpsc_i2s_configure(pscdata);\r\nif (ret)\r\ngoto out;\r\n}\r\nau_writel(I2SPCR_CLRFIFO(stype), I2S_PCR(pscdata));\r\nau_sync();\r\nau_writel(I2SPCR_START(stype), I2S_PCR(pscdata));\r\nau_sync();\r\ntmo = 1000000;\r\nwhile (!(au_readl(I2S_STAT(pscdata)) & I2SSTAT_BUSY(stype)) && tmo)\r\ntmo--;\r\nif (!tmo) {\r\nau_writel(I2SPCR_STOP(stype), I2S_PCR(pscdata));\r\nau_sync();\r\nret = -ETIMEDOUT;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic int au1xpsc_i2s_stop(struct au1xpsc_audio_data *pscdata, int stype)\r\n{\r\nunsigned long tmo, stat;\r\nau_writel(I2SPCR_STOP(stype), I2S_PCR(pscdata));\r\nau_sync();\r\ntmo = 1000000;\r\nwhile ((au_readl(I2S_STAT(pscdata)) & I2SSTAT_BUSY(stype)) && tmo)\r\ntmo--;\r\nstat = au_readl(I2S_STAT(pscdata));\r\nif (!(stat & (PSC_I2SSTAT_TB | PSC_I2SSTAT_RB))) {\r\nau_writel(0, I2S_CFG(pscdata));\r\nau_sync();\r\nau_writel(PSC_CTRL_SUSPEND, PSC_CTRL(pscdata));\r\nau_sync();\r\n}\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_i2s_trigger(struct snd_pcm_substream *substream, int cmd,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(dai);\r\nint ret, stype = substream->stream;\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\ncase SNDRV_PCM_TRIGGER_RESUME:\r\nret = au1xpsc_i2s_start(pscdata, stype);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\ncase SNDRV_PCM_TRIGGER_SUSPEND:\r\nret = au1xpsc_i2s_stop(pscdata, stype);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int au1xpsc_i2s_startup(struct snd_pcm_substream *substream,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct au1xpsc_audio_data *pscdata = snd_soc_dai_get_drvdata(dai);\r\nsnd_soc_dai_set_dma_data(dai, substream, &pscdata->dmaids[0]);\r\nreturn 0;\r\n}\r\nstatic int __devinit au1xpsc_i2s_drvprobe(struct platform_device *pdev)\r\n{\r\nstruct resource *iores, *dmares;\r\nunsigned long sel;\r\nint ret;\r\nstruct au1xpsc_audio_data *wd;\r\nwd = devm_kzalloc(&pdev->dev, sizeof(struct au1xpsc_audio_data),\r\nGFP_KERNEL);\r\nif (!wd)\r\nreturn -ENOMEM;\r\niores = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!iores)\r\nreturn -ENODEV;\r\nret = -EBUSY;\r\nif (!devm_request_mem_region(&pdev->dev, iores->start,\r\nresource_size(iores),\r\npdev->name))\r\nreturn -EBUSY;\r\nwd->mmio = devm_ioremap(&pdev->dev, iores->start,\r\nresource_size(iores));\r\nif (!wd->mmio)\r\nreturn -EBUSY;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 0);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nwd->dmaids[SNDRV_PCM_STREAM_PLAYBACK] = dmares->start;\r\ndmares = platform_get_resource(pdev, IORESOURCE_DMA, 1);\r\nif (!dmares)\r\nreturn -EBUSY;\r\nwd->dmaids[SNDRV_PCM_STREAM_CAPTURE] = dmares->start;\r\nsel = au_readl(PSC_SEL(wd)) & PSC_SEL_CLK_MASK;\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nau_writel(PSC_SEL_PS_I2SMODE | sel, PSC_SEL(wd));\r\nau_writel(0, I2S_CFG(wd));\r\nau_sync();\r\nwd->cfg |= PSC_I2SCFG_RT_FIFO8 | PSC_I2SCFG_TT_FIFO8;\r\nmemcpy(&wd->dai_drv, &au1xpsc_i2s_dai_template,\r\nsizeof(struct snd_soc_dai_driver));\r\nwd->dai_drv.name = dev_name(&pdev->dev);\r\nplatform_set_drvdata(pdev, wd);\r\nreturn snd_soc_register_dai(&pdev->dev, &wd->dai_drv);\r\n}\r\nstatic int __devexit au1xpsc_i2s_drvremove(struct platform_device *pdev)\r\n{\r\nstruct au1xpsc_audio_data *wd = platform_get_drvdata(pdev);\r\nsnd_soc_unregister_dai(&pdev->dev);\r\nau_writel(0, I2S_CFG(wd));\r\nau_sync();\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_i2s_drvsuspend(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *wd = dev_get_drvdata(dev);\r\nwd->pm[0] = au_readl(PSC_SEL(wd));\r\nau_writel(0, I2S_CFG(wd));\r\nau_sync();\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nreturn 0;\r\n}\r\nstatic int au1xpsc_i2s_drvresume(struct device *dev)\r\n{\r\nstruct au1xpsc_audio_data *wd = dev_get_drvdata(dev);\r\nau_writel(PSC_CTRL_DISABLE, PSC_CTRL(wd));\r\nau_sync();\r\nau_writel(0, PSC_SEL(wd));\r\nau_sync();\r\nau_writel(wd->pm[0], PSC_SEL(wd));\r\nau_sync();\r\nreturn 0;\r\n}

static int triflex_prereset(struct ata_link *link, unsigned long deadline)\r\n{\r\nstatic const struct pci_bits triflex_enable_bits[] = {\r\n{ 0x80, 1, 0x01, 0x01 },\r\n{ 0x80, 1, 0x02, 0x02 }\r\n};\r\nstruct ata_port *ap = link->ap;\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nif (!pci_test_config_bits(pdev, &triflex_enable_bits[ap->port_no]))\r\nreturn -ENOENT;\r\nreturn ata_sff_prereset(link, deadline);\r\n}\r\nstatic void triflex_load_timing(struct ata_port *ap, struct ata_device *adev, int speed)\r\n{\r\nstruct pci_dev *pdev = to_pci_dev(ap->host->dev);\r\nu32 timing = 0;\r\nu32 triflex_timing, old_triflex_timing;\r\nint channel_offset = ap->port_no ? 0x74: 0x70;\r\nunsigned int is_slave = (adev->devno != 0);\r\npci_read_config_dword(pdev, channel_offset, &old_triflex_timing);\r\ntriflex_timing = old_triflex_timing;\r\nswitch(speed)\r\n{\r\ncase XFER_MW_DMA_2:\r\ntiming = 0x0103;break;\r\ncase XFER_MW_DMA_1:\r\ntiming = 0x0203;break;\r\ncase XFER_MW_DMA_0:\r\ntiming = 0x0808;break;\r\ncase XFER_SW_DMA_2:\r\ncase XFER_SW_DMA_1:\r\ncase XFER_SW_DMA_0:\r\ntiming = 0x0F0F;break;\r\ncase XFER_PIO_4:\r\ntiming = 0x0202;break;\r\ncase XFER_PIO_3:\r\ntiming = 0x0204;break;\r\ncase XFER_PIO_2:\r\ntiming = 0x0404;break;\r\ncase XFER_PIO_1:\r\ntiming = 0x0508;break;\r\ncase XFER_PIO_0:\r\ntiming = 0x0808;break;\r\ndefault:\r\nBUG();\r\n}\r\ntriflex_timing &= ~ (0xFFFF << (16 * is_slave));\r\ntriflex_timing |= (timing << (16 * is_slave));\r\nif (triflex_timing != old_triflex_timing)\r\npci_write_config_dword(pdev, channel_offset, triflex_timing);\r\n}\r\nstatic void triflex_set_piomode(struct ata_port *ap, struct ata_device *adev)\r\n{\r\ntriflex_load_timing(ap, adev, adev->pio_mode);\r\n}\r\nstatic void triflex_bmdma_start(struct ata_queued_cmd *qc)\r\n{\r\ntriflex_load_timing(qc->ap, qc->dev, qc->dev->dma_mode);\r\nata_bmdma_start(qc);\r\n}\r\nstatic void triflex_bmdma_stop(struct ata_queued_cmd *qc)\r\n{\r\nata_bmdma_stop(qc);\r\ntriflex_load_timing(qc->ap, qc->dev, qc->dev->pio_mode);\r\n}\r\nstatic int triflex_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nstatic const struct ata_port_info info = {\r\n.flags = ATA_FLAG_SLAVE_POSS,\r\n.pio_mask = ATA_PIO4,\r\n.mwdma_mask = ATA_MWDMA2,\r\n.port_ops = &triflex_port_ops\r\n};\r\nconst struct ata_port_info *ppi[] = { &info, NULL };\r\nata_print_version_once(&dev->dev, DRV_VERSION);\r\nreturn ata_pci_bmdma_init_one(dev, ppi, &triflex_sht, NULL, 0);\r\n}\r\nstatic int triflex_ata_pci_device_suspend(struct pci_dev *pdev, pm_message_t mesg)\r\n{\r\nstruct ata_host *host = dev_get_drvdata(&pdev->dev);\r\nint rc = 0;\r\nrc = ata_host_suspend(host, mesg);\r\nif (rc)\r\nreturn rc;\r\npci_save_state(pdev);\r\nreturn 0;\r\n}

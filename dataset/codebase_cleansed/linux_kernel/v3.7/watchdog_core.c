int watchdog_register_device(struct watchdog_device *wdd)\r\n{\r\nint ret, id, devno;\r\nif (wdd == NULL || wdd->info == NULL || wdd->ops == NULL)\r\nreturn -EINVAL;\r\nif (wdd->ops->start == NULL || wdd->ops->stop == NULL)\r\nreturn -EINVAL;\r\nif (wdd->min_timeout > wdd->max_timeout) {\r\npr_info("Invalid min and max timeout values, resetting to 0!\n");\r\nwdd->min_timeout = 0;\r\nwdd->max_timeout = 0;\r\n}\r\nmutex_init(&wdd->lock);\r\nid = ida_simple_get(&watchdog_ida, 0, MAX_DOGS, GFP_KERNEL);\r\nif (id < 0)\r\nreturn id;\r\nwdd->id = id;\r\nret = watchdog_dev_register(wdd);\r\nif (ret) {\r\nida_simple_remove(&watchdog_ida, id);\r\nif (!(id == 0 && ret == -EBUSY))\r\nreturn ret;\r\nid = ida_simple_get(&watchdog_ida, 1, MAX_DOGS, GFP_KERNEL);\r\nif (id < 0)\r\nreturn id;\r\nwdd->id = id;\r\nret = watchdog_dev_register(wdd);\r\nif (ret) {\r\nida_simple_remove(&watchdog_ida, id);\r\nreturn ret;\r\n}\r\n}\r\ndevno = wdd->cdev.dev;\r\nwdd->dev = device_create(watchdog_class, wdd->parent, devno,\r\nNULL, "watchdog%d", wdd->id);\r\nif (IS_ERR(wdd->dev)) {\r\nwatchdog_dev_unregister(wdd);\r\nida_simple_remove(&watchdog_ida, id);\r\nret = PTR_ERR(wdd->dev);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid watchdog_unregister_device(struct watchdog_device *wdd)\r\n{\r\nint ret;\r\nint devno;\r\nif (wdd == NULL)\r\nreturn;\r\ndevno = wdd->cdev.dev;\r\nret = watchdog_dev_unregister(wdd);\r\nif (ret)\r\npr_err("error unregistering /dev/watchdog (err=%d)\n", ret);\r\ndevice_destroy(watchdog_class, devno);\r\nida_simple_remove(&watchdog_ida, wdd->id);\r\nwdd->dev = NULL;\r\n}\r\nstatic int __init watchdog_init(void)\r\n{\r\nint err;\r\nwatchdog_class = class_create(THIS_MODULE, "watchdog");\r\nif (IS_ERR(watchdog_class)) {\r\npr_err("couldn't create class\n");\r\nreturn PTR_ERR(watchdog_class);\r\n}\r\nerr = watchdog_dev_init();\r\nif (err < 0) {\r\nclass_destroy(watchdog_class);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit watchdog_exit(void)\r\n{\r\nwatchdog_dev_exit();\r\nclass_destroy(watchdog_class);\r\nida_destroy(&watchdog_ida);\r\n}

int\r\nl1oip_law_to_4bit(u8 *data, int len, u8 *result, u32 *state)\r\n{\r\nint ii, i = 0, o = 0;\r\nif (!len)\r\nreturn 0;\r\nif (*state) {\r\n*result++ = table_com[(((*state) << 8) & 0xff00) | (*data++)];\r\nlen--;\r\no++;\r\n}\r\nii = len >> 1;\r\nwhile (i < ii) {\r\n*result++ = table_com[(data[0]<<8) | (data[1])];\r\ndata += 2;\r\ni++;\r\no++;\r\n}\r\nif (len & 1)\r\n*state = 0x100 + *data;\r\nelse\r\n*state = 0;\r\nreturn o;\r\n}\r\nint\r\nl1oip_4bit_to_law(u8 *data, int len, u8 *result)\r\n{\r\nint i = 0;\r\nu16 r;\r\nwhile (i < len) {\r\nr = table_dec[*data++];\r\n*result++ = r >> 8;\r\n*result++ = r;\r\ni++;\r\n}\r\nreturn len << 1;\r\n}\r\nint\r\nl1oip_alaw_to_ulaw(u8 *data, int len, u8 *result)\r\n{\r\nint i = 0;\r\nwhile (i < len) {\r\n*result++ = alaw_to_ulaw[*data++];\r\ni++;\r\n}\r\nreturn len;\r\n}\r\nint\r\nl1oip_ulaw_to_alaw(u8 *data, int len, u8 *result)\r\n{\r\nint i = 0;\r\nwhile (i < len) {\r\n*result++ = ulaw_to_alaw[*data++];\r\ni++;\r\n}\r\nreturn len;\r\n}\r\nvoid\r\nl1oip_4bit_free(void)\r\n{\r\nif (table_dec)\r\nvfree(table_dec);\r\nif (table_com)\r\nvfree(table_com);\r\ntable_com = NULL;\r\ntable_dec = NULL;\r\n}\r\nint\r\nl1oip_4bit_alloc(int ulaw)\r\n{\r\nint i1, i2, c, sample;\r\nif (table_dec)\r\nreturn 0;\r\ntable_com = vzalloc(65536);\r\ntable_dec = vzalloc(512);\r\nif (!table_com || !table_dec) {\r\nl1oip_4bit_free();\r\nreturn -ENOMEM;\r\n}\r\ni1 = 0;\r\nwhile (i1 < 256) {\r\nif (ulaw)\r\nc = ulaw_to_4bit[i1];\r\nelse\r\nc = alaw_to_4bit[i1];\r\ni2 = 0;\r\nwhile (i2 < 256) {\r\ntable_com[(i1 << 8) | i2] |= (c << 4);\r\ntable_com[(i2 << 8) | i1] |= c;\r\ni2++;\r\n}\r\ni1++;\r\n}\r\ni1 = 0;\r\nwhile (i1 < 16) {\r\nif (ulaw)\r\nsample = _4bit_to_ulaw[i1];\r\nelse\r\nsample = _4bit_to_alaw[i1];\r\ni2 = 0;\r\nwhile (i2 < 16) {\r\ntable_dec[(i1 << 4) | i2] |= (sample << 8);\r\ntable_dec[(i2 << 4) | i1] |= sample;\r\ni2++;\r\n}\r\ni1++;\r\n}\r\nreturn 0;\r\n}

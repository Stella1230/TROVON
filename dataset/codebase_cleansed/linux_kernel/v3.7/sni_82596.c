static inline void ca(struct net_device *dev)\r\n{\r\nstruct i596_private *lp = netdev_priv(dev);\r\nwritel(0, lp->ca);\r\n}\r\nstatic void mpu_port(struct net_device *dev, int c, dma_addr_t x)\r\n{\r\nstruct i596_private *lp = netdev_priv(dev);\r\nu32 v = (u32) (c) | (u32) (x);\r\nif (lp->options & OPT_MPU_16BIT) {\r\nwritew(v & 0xffff, lp->mpu_port);\r\nwmb();\r\nudelay(1);\r\nwritew(v >> 16, lp->mpu_port);\r\n} else {\r\nwritel(v, lp->mpu_port);\r\nwmb();\r\nudelay(1);\r\nwritel(v, lp->mpu_port);\r\n}\r\n}\r\nstatic int __devinit sni_82596_probe(struct platform_device *dev)\r\n{\r\nstruct net_device *netdevice;\r\nstruct i596_private *lp;\r\nstruct resource *res, *ca, *idprom, *options;\r\nint retval = -ENOMEM;\r\nvoid __iomem *mpu_addr;\r\nvoid __iomem *ca_addr;\r\nu8 __iomem *eth_addr;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nca = platform_get_resource(dev, IORESOURCE_MEM, 1);\r\noptions = platform_get_resource(dev, 0, 0);\r\nidprom = platform_get_resource(dev, IORESOURCE_MEM, 2);\r\nif (!res || !ca || !options || !idprom)\r\nreturn -ENODEV;\r\nmpu_addr = ioremap_nocache(res->start, 4);\r\nif (!mpu_addr)\r\nreturn -ENOMEM;\r\nca_addr = ioremap_nocache(ca->start, 4);\r\nif (!ca_addr)\r\ngoto probe_failed_free_mpu;\r\nprintk(KERN_INFO "Found i82596 at 0x%x\n", res->start);\r\nnetdevice = alloc_etherdev(sizeof(struct i596_private));\r\nif (!netdevice)\r\ngoto probe_failed_free_ca;\r\nSET_NETDEV_DEV(netdevice, &dev->dev);\r\nplatform_set_drvdata (dev, netdevice);\r\nnetdevice->base_addr = res->start;\r\nnetdevice->irq = platform_get_irq(dev, 0);\r\neth_addr = ioremap_nocache(idprom->start, 0x10);\r\nif (!eth_addr)\r\ngoto probe_failed;\r\nnetdevice->dev_addr[0] = readb(eth_addr + 0x0b);\r\nnetdevice->dev_addr[1] = readb(eth_addr + 0x0a);\r\nnetdevice->dev_addr[2] = readb(eth_addr + 0x09);\r\nnetdevice->dev_addr[3] = readb(eth_addr + 0x08);\r\nnetdevice->dev_addr[4] = readb(eth_addr + 0x07);\r\nnetdevice->dev_addr[5] = readb(eth_addr + 0x06);\r\niounmap(eth_addr);\r\nif (!netdevice->irq) {\r\nprintk(KERN_ERR "%s: IRQ not found for i82596 at 0x%lx\n",\r\n__FILE__, netdevice->base_addr);\r\ngoto probe_failed;\r\n}\r\nlp = netdev_priv(netdevice);\r\nlp->options = options->flags & IORESOURCE_BITS;\r\nlp->ca = ca_addr;\r\nlp->mpu_port = mpu_addr;\r\nretval = i82596_probe(netdevice);\r\nif (retval == 0)\r\nreturn 0;\r\nprobe_failed:\r\nfree_netdev(netdevice);\r\nprobe_failed_free_ca:\r\niounmap(ca_addr);\r\nprobe_failed_free_mpu:\r\niounmap(mpu_addr);\r\nreturn retval;\r\n}\r\nstatic int __devexit sni_82596_driver_remove(struct platform_device *pdev)\r\n{\r\nstruct net_device *dev = platform_get_drvdata(pdev);\r\nstruct i596_private *lp = netdev_priv(dev);\r\nunregister_netdev(dev);\r\nDMA_FREE(dev->dev.parent, sizeof(struct i596_private),\r\nlp->dma, lp->dma_addr);\r\niounmap(lp->ca);\r\niounmap(lp->mpu_port);\r\nfree_netdev (dev);\r\nreturn 0;\r\n}\r\nstatic int __devinit sni_82596_init(void)\r\n{\r\nprintk(KERN_INFO SNI_82596_DRIVER_VERSION "\n");\r\nreturn platform_driver_register(&sni_82596_driver);\r\n}\r\nstatic void __exit sni_82596_exit(void)\r\n{\r\nplatform_driver_unregister(&sni_82596_driver);\r\n}

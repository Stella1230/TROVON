int cx25821_sram_channel_setup_upstream_audio(struct cx25821_dev *dev,\r\nstruct sram_channel *ch,\r\nunsigned int bpl, u32 risc)\r\n{\r\nunsigned int i, lines;\r\nu32 cdt;\r\nif (ch->cmds_start == 0) {\r\ncx_write(ch->ptr1_reg, 0);\r\ncx_write(ch->ptr2_reg, 0);\r\ncx_write(ch->cnt2_reg, 0);\r\ncx_write(ch->cnt1_reg, 0);\r\nreturn 0;\r\n}\r\nbpl = (bpl + 7) & ~7;\r\ncdt = ch->cdt;\r\nlines = ch->fifo_size / bpl;\r\nif (lines > 3)\r\nlines = 3;\r\nBUG_ON(lines < 2);\r\nfor (i = 0; i < lines; i++) {\r\ncx_write(cdt + 16 * i, ch->fifo_start + bpl * i);\r\ncx_write(cdt + 16 * i + 4, 0);\r\ncx_write(cdt + 16 * i + 8, 0);\r\ncx_write(cdt + 16 * i + 12, 0);\r\n}\r\ncx_write(ch->cmds_start + 0, risc);\r\ncx_write(ch->cmds_start + 4, 0);\r\ncx_write(ch->cmds_start + 8, cdt);\r\ncx_write(ch->cmds_start + 12, AUDIO_CDT_SIZE_QW);\r\ncx_write(ch->cmds_start + 16, ch->ctrl_start);\r\ncx_write(ch->cmds_start + 20, AUDIO_IQ_SIZE_DW);\r\nfor (i = 24; i < 80; i += 4)\r\ncx_write(ch->cmds_start + i, 0);\r\ncx_write(ch->ptr1_reg, ch->fifo_start);\r\ncx_write(ch->ptr2_reg, cdt);\r\ncx_write(ch->cnt2_reg, AUDIO_CDT_SIZE_QW);\r\ncx_write(ch->cnt1_reg, AUDIO_CLUSTER_SIZE_QW - 1);\r\nreturn 0;\r\n}\r\nstatic __le32 *cx25821_risc_field_upstream_audio(struct cx25821_dev *dev,\r\n__le32 *rp,\r\ndma_addr_t databuf_phys_addr,\r\nunsigned int bpl,\r\nint fifo_enable)\r\n{\r\nunsigned int line;\r\nstruct sram_channel *sram_ch =\r\ndev->channels[dev->_audio_upstream_channel].sram_channels;\r\nint offset = 0;\r\nfor (line = 0; line < LINES_PER_AUDIO_BUFFER; line++) {\r\n*(rp++) = cpu_to_le32(RISC_READ | RISC_SOL | RISC_EOL | bpl);\r\n*(rp++) = cpu_to_le32(databuf_phys_addr + offset);\r\n*(rp++) = cpu_to_le32(0);\r\nif (fifo_enable && line == 2) {\r\n*(rp++) = RISC_WRITECR;\r\n*(rp++) = sram_ch->dma_ctl;\r\n*(rp++) = sram_ch->fld_aud_fifo_en;\r\n*(rp++) = 0x00000020;\r\n}\r\noffset += AUDIO_LINE_SIZE;\r\n}\r\nreturn rp;\r\n}\r\nint cx25821_risc_buffer_upstream_audio(struct cx25821_dev *dev,\r\nstruct pci_dev *pci,\r\nunsigned int bpl, unsigned int lines)\r\n{\r\n__le32 *rp;\r\nint fifo_enable = 0;\r\nint frame = 0, i = 0;\r\nint frame_size = AUDIO_DATA_BUF_SZ;\r\nint databuf_offset = 0;\r\nint risc_flag = RISC_CNT_INC;\r\ndma_addr_t risc_phys_jump_addr;\r\nrp = dev->_risc_virt_addr;\r\n*(rp++) = cpu_to_le32(RISC_RESYNC | AUDIO_SYNC_LINE);\r\nfor (frame = 0; frame < NUM_AUDIO_FRAMES; frame++) {\r\ndatabuf_offset = frame_size * frame;\r\nif (frame == 0) {\r\nfifo_enable = 1;\r\nrisc_flag = RISC_CNT_RESET;\r\n} else {\r\nfifo_enable = 0;\r\nrisc_flag = RISC_CNT_INC;\r\n}\r\nif ((frame + 1) == NUM_AUDIO_FRAMES) {\r\nrisc_phys_jump_addr =\r\ndev->_risc_phys_start_addr +\r\nRISC_SYNC_INSTRUCTION_SIZE;\r\n} else {\r\nrisc_phys_jump_addr =\r\ndev->_risc_phys_start_addr +\r\nRISC_SYNC_INSTRUCTION_SIZE +\r\nAUDIO_RISC_DMA_BUF_SIZE * (frame + 1);\r\n}\r\nrp = cx25821_risc_field_upstream_audio(dev, rp,\r\ndev->_audiodata_buf_phys_addr + databuf_offset,\r\nbpl, fifo_enable);\r\nif (USE_RISC_NOOP_AUDIO) {\r\nfor (i = 0; i < NUM_NO_OPS; i++)\r\n*(rp++) = cpu_to_le32(RISC_NOOP);\r\n}\r\n*(rp++) = cpu_to_le32(RISC_JUMP | RISC_IRQ1 | risc_flag);\r\n*(rp++) = cpu_to_le32(risc_phys_jump_addr);\r\n*(rp++) = cpu_to_le32(0);\r\nrp = dev->_risc_virt_addr + RISC_SYNC_INSTRUCTION_SIZE / 4 +\r\n(AUDIO_RISC_DMA_BUF_SIZE * (frame + 1) / 4);\r\n}\r\nreturn 0;\r\n}\r\nvoid cx25821_free_memory_audio(struct cx25821_dev *dev)\r\n{\r\nif (dev->_risc_virt_addr) {\r\npci_free_consistent(dev->pci, dev->_audiorisc_size,\r\ndev->_risc_virt_addr, dev->_risc_phys_addr);\r\ndev->_risc_virt_addr = NULL;\r\n}\r\nif (dev->_audiodata_buf_virt_addr) {\r\npci_free_consistent(dev->pci, dev->_audiodata_buf_size,\r\ndev->_audiodata_buf_virt_addr,\r\ndev->_audiodata_buf_phys_addr);\r\ndev->_audiodata_buf_virt_addr = NULL;\r\n}\r\n}\r\nvoid cx25821_stop_upstream_audio(struct cx25821_dev *dev)\r\n{\r\nstruct sram_channel *sram_ch =\r\ndev->channels[AUDIO_UPSTREAM_SRAM_CHANNEL_B].sram_channels;\r\nu32 tmp = 0;\r\nif (!dev->_audio_is_running) {\r\nprintk(KERN_DEBUG\r\npr_fmt("No audio file is currently running so return!\n"));\r\nreturn;\r\n}\r\ncx_write(sram_ch->int_msk, 0);\r\ntmp = cx_read(sram_ch->dma_ctl);\r\ncx_write(sram_ch->dma_ctl,\r\ntmp & ~(sram_ch->fld_aud_fifo_en | sram_ch->fld_aud_risc_en));\r\nif (dev->_audiodata_buf_virt_addr)\r\nmemset(dev->_audiodata_buf_virt_addr, 0,\r\ndev->_audiodata_buf_size);\r\ndev->_audio_is_running = 0;\r\ndev->_is_first_audio_frame = 0;\r\ndev->_audioframe_count = 0;\r\ndev->_audiofile_status = END_OF_FILE;\r\nkfree(dev->_irq_audio_queues);\r\ndev->_irq_audio_queues = NULL;\r\nkfree(dev->_audiofilename);\r\n}\r\nvoid cx25821_free_mem_upstream_audio(struct cx25821_dev *dev)\r\n{\r\nif (dev->_audio_is_running)\r\ncx25821_stop_upstream_audio(dev);\r\ncx25821_free_memory_audio(dev);\r\n}\r\nint cx25821_get_audio_data(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch)\r\n{\r\nstruct file *myfile;\r\nint frame_index_temp = dev->_audioframe_index;\r\nint i = 0;\r\nint line_size = AUDIO_LINE_SIZE;\r\nint frame_size = AUDIO_DATA_BUF_SZ;\r\nint frame_offset = frame_size * frame_index_temp;\r\nssize_t vfs_read_retval = 0;\r\nchar mybuf[line_size];\r\nloff_t file_offset = dev->_audioframe_count * frame_size;\r\nloff_t pos;\r\nmm_segment_t old_fs;\r\nif (dev->_audiofile_status == END_OF_FILE)\r\nreturn 0;\r\nmyfile = filp_open(dev->_audiofilename, O_RDONLY | O_LARGEFILE, 0);\r\nif (IS_ERR(myfile)) {\r\nconst int open_errno = -PTR_ERR(myfile);\r\npr_err("%s(): ERROR opening file(%s) with errno = %d!\n",\r\n__func__, dev->_audiofilename, open_errno);\r\nreturn PTR_ERR(myfile);\r\n} else {\r\nif (!(myfile->f_op)) {\r\npr_err("%s(): File has no file operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\nif (!myfile->f_op->read) {\r\npr_err("%s(): File has no READ operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\npos = myfile->f_pos;\r\nold_fs = get_fs();\r\nset_fs(KERNEL_DS);\r\nfor (i = 0; i < dev->_audio_lines_count; i++) {\r\npos = file_offset;\r\nvfs_read_retval = vfs_read(myfile, mybuf, line_size,\r\n&pos);\r\nif (vfs_read_retval > 0 && vfs_read_retval == line_size\r\n&& dev->_audiodata_buf_virt_addr != NULL) {\r\nmemcpy((void *)(dev->_audiodata_buf_virt_addr +\r\nframe_offset / 4), mybuf,\r\nvfs_read_retval);\r\n}\r\nfile_offset += vfs_read_retval;\r\nframe_offset += vfs_read_retval;\r\nif (vfs_read_retval < line_size) {\r\npr_info("Done: exit %s() since no more bytes to read from Audio file\n",\r\n__func__);\r\nbreak;\r\n}\r\n}\r\nif (i > 0)\r\ndev->_audioframe_count++;\r\ndev->_audiofile_status = (vfs_read_retval == line_size) ?\r\nIN_PROGRESS : END_OF_FILE;\r\nset_fs(old_fs);\r\nfilp_close(myfile, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic void cx25821_audioups_handler(struct work_struct *work)\r\n{\r\nstruct cx25821_dev *dev = container_of(work, struct cx25821_dev,\r\n_audio_work_entry);\r\nif (!dev) {\r\npr_err("ERROR %s(): since container_of(work_struct) FAILED!\n",\r\n__func__);\r\nreturn;\r\n}\r\ncx25821_get_audio_data(dev, dev->channels[dev->_audio_upstream_channel].\r\nsram_channels);\r\n}\r\nint cx25821_openfile_audio(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch)\r\n{\r\nstruct file *myfile;\r\nint i = 0, j = 0;\r\nint line_size = AUDIO_LINE_SIZE;\r\nssize_t vfs_read_retval = 0;\r\nchar mybuf[line_size];\r\nloff_t pos;\r\nloff_t offset = (unsigned long)0;\r\nmm_segment_t old_fs;\r\nmyfile = filp_open(dev->_audiofilename, O_RDONLY | O_LARGEFILE, 0);\r\nif (IS_ERR(myfile)) {\r\nconst int open_errno = -PTR_ERR(myfile);\r\npr_err("%s(): ERROR opening file(%s) with errno = %d!\n",\r\n__func__, dev->_audiofilename, open_errno);\r\nreturn PTR_ERR(myfile);\r\n} else {\r\nif (!(myfile->f_op)) {\r\npr_err("%s(): File has no file operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\nif (!myfile->f_op->read) {\r\npr_err("%s(): File has no READ operations registered!\n",\r\n__func__);\r\nfilp_close(myfile, NULL);\r\nreturn -EIO;\r\n}\r\npos = myfile->f_pos;\r\nold_fs = get_fs();\r\nset_fs(KERNEL_DS);\r\nfor (j = 0; j < NUM_AUDIO_FRAMES; j++) {\r\nfor (i = 0; i < dev->_audio_lines_count; i++) {\r\npos = offset;\r\nvfs_read_retval = vfs_read(myfile, mybuf,\r\nline_size, &pos);\r\nif (vfs_read_retval > 0 &&\r\nvfs_read_retval == line_size &&\r\ndev->_audiodata_buf_virt_addr != NULL) {\r\nmemcpy((void *)(dev->\r\n_audiodata_buf_virt_addr\r\n+ offset / 4), mybuf,\r\nvfs_read_retval);\r\n}\r\noffset += vfs_read_retval;\r\nif (vfs_read_retval < line_size) {\r\npr_info("Done: exit %s() since no more bytes to read from Audio file\n",\r\n__func__);\r\nbreak;\r\n}\r\n}\r\nif (i > 0)\r\ndev->_audioframe_count++;\r\nif (vfs_read_retval < line_size)\r\nbreak;\r\n}\r\ndev->_audiofile_status = (vfs_read_retval == line_size) ?\r\nIN_PROGRESS : END_OF_FILE;\r\nset_fs(old_fs);\r\nmyfile->f_pos = 0;\r\nfilp_close(myfile, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic int cx25821_audio_upstream_buffer_prepare(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch,\r\nint bpl)\r\n{\r\nint ret = 0;\r\ndma_addr_t dma_addr;\r\ndma_addr_t data_dma_addr;\r\ncx25821_free_memory_audio(dev);\r\ndev->_risc_virt_addr = pci_alloc_consistent(dev->pci,\r\ndev->audio_upstream_riscbuf_size, &dma_addr);\r\ndev->_risc_virt_start_addr = dev->_risc_virt_addr;\r\ndev->_risc_phys_start_addr = dma_addr;\r\ndev->_risc_phys_addr = dma_addr;\r\ndev->_audiorisc_size = dev->audio_upstream_riscbuf_size;\r\nif (!dev->_risc_virt_addr) {\r\nprintk(KERN_DEBUG\r\npr_fmt("ERROR: pci_alloc_consistent() FAILED to allocate memory for RISC program! Returning\n"));\r\nreturn -ENOMEM;\r\n}\r\nmemset(dev->_risc_virt_addr, 0, dev->_audiorisc_size);\r\ndev->_audiodata_buf_virt_addr = pci_alloc_consistent(dev->pci,\r\ndev->audio_upstream_databuf_size, &data_dma_addr);\r\ndev->_audiodata_buf_phys_addr = data_dma_addr;\r\ndev->_audiodata_buf_size = dev->audio_upstream_databuf_size;\r\nif (!dev->_audiodata_buf_virt_addr) {\r\nprintk(KERN_DEBUG\r\npr_fmt("ERROR: pci_alloc_consistent() FAILED to allocate memory for data buffer! Returning\n"));\r\nreturn -ENOMEM;\r\n}\r\nmemset(dev->_audiodata_buf_virt_addr, 0, dev->_audiodata_buf_size);\r\nret = cx25821_openfile_audio(dev, sram_ch);\r\nif (ret < 0)\r\nreturn ret;\r\nret = cx25821_risc_buffer_upstream_audio(dev, dev->pci, bpl,\r\ndev->_audio_lines_count);\r\nif (ret < 0) {\r\nprintk(KERN_DEBUG\r\npr_fmt("ERROR creating audio upstream RISC programs!\n"));\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nreturn ret;\r\n}\r\nint cx25821_audio_upstream_irq(struct cx25821_dev *dev, int chan_num,\r\nu32 status)\r\n{\r\nint i = 0;\r\nu32 int_msk_tmp;\r\nstruct sram_channel *channel = dev->channels[chan_num].sram_channels;\r\ndma_addr_t risc_phys_jump_addr;\r\n__le32 *rp;\r\nif (status & FLD_AUD_SRC_RISCI1) {\r\nu32 prog_cnt = cx_read(channel->gpcnt);\r\ncx_write(channel->int_msk, 0);\r\ncx_write(channel->int_stat, cx_read(channel->int_stat));\r\nspin_lock(&dev->slock);\r\nwhile (prog_cnt != dev->_last_index_irq) {\r\nif (dev->_last_index_irq < (NUMBER_OF_PROGRAMS - 1))\r\ndev->_last_index_irq++;\r\nelse\r\ndev->_last_index_irq = 0;\r\ndev->_audioframe_index = dev->_last_index_irq;\r\nqueue_work(dev->_irq_audio_queues,\r\n&dev->_audio_work_entry);\r\n}\r\nif (dev->_is_first_audio_frame) {\r\ndev->_is_first_audio_frame = 0;\r\nif (dev->_risc_virt_start_addr != NULL) {\r\nrisc_phys_jump_addr =\r\ndev->_risc_phys_start_addr +\r\nRISC_SYNC_INSTRUCTION_SIZE +\r\nAUDIO_RISC_DMA_BUF_SIZE;\r\nrp = cx25821_risc_field_upstream_audio(dev,\r\ndev->_risc_virt_start_addr + 1,\r\ndev->_audiodata_buf_phys_addr,\r\nAUDIO_LINE_SIZE, FIFO_DISABLE);\r\nif (USE_RISC_NOOP_AUDIO) {\r\nfor (i = 0; i < NUM_NO_OPS; i++) {\r\n*(rp++) =\r\ncpu_to_le32(RISC_NOOP);\r\n}\r\n}\r\n*(rp++) = cpu_to_le32(RISC_JUMP | RISC_IRQ1 |\r\nRISC_CNT_RESET);\r\n*(rp++) = cpu_to_le32(risc_phys_jump_addr);\r\n*(rp++) = cpu_to_le32(0);\r\n}\r\n}\r\nspin_unlock(&dev->slock);\r\n} else {\r\nif (status & FLD_AUD_SRC_OF)\r\npr_warn("%s(): Audio Received Overflow Error Interrupt!\n",\r\n__func__);\r\nif (status & FLD_AUD_SRC_SYNC)\r\npr_warn("%s(): Audio Received Sync Error Interrupt!\n",\r\n__func__);\r\nif (status & FLD_AUD_SRC_OPC_ERR)\r\npr_warn("%s(): Audio Received OpCode Error Interrupt!\n",\r\n__func__);\r\ncx_write(channel->int_stat, cx_read(channel->int_stat));\r\n}\r\nif (dev->_audiofile_status == END_OF_FILE) {\r\npr_warn("EOF Channel Audio Framecount = %d\n",\r\ndev->_audioframe_count);\r\nreturn -1;\r\n}\r\nint_msk_tmp = cx_read(channel->int_msk);\r\ncx_write(channel->int_msk, int_msk_tmp |= _intr_msk);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t cx25821_upstream_irq_audio(int irq, void *dev_id)\r\n{\r\nstruct cx25821_dev *dev = dev_id;\r\nu32 audio_status;\r\nint handled = 0;\r\nstruct sram_channel *sram_ch;\r\nif (!dev)\r\nreturn -1;\r\nsram_ch = dev->channels[dev->_audio_upstream_channel].sram_channels;\r\naudio_status = cx_read(sram_ch->int_stat);\r\nif (audio_status) {\r\nhandled = cx25821_audio_upstream_irq(dev,\r\ndev->_audio_upstream_channel, audio_status);\r\n}\r\nif (handled < 0)\r\ncx25821_stop_upstream_audio(dev);\r\nelse\r\nhandled += handled;\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void cx25821_wait_fifo_enable(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch)\r\n{\r\nint count = 0;\r\nu32 tmp;\r\ndo {\r\nudelay(10);\r\ntmp = cx_read(sram_ch->dma_ctl);\r\nif (count++ > 1000) {\r\npr_err("ERROR: %s() fifo is NOT turned on. Timeout!\n",\r\n__func__);\r\nreturn;\r\n}\r\n} while (!(tmp & sram_ch->fld_aud_fifo_en));\r\n}\r\nint cx25821_start_audio_dma_upstream(struct cx25821_dev *dev,\r\nstruct sram_channel *sram_ch)\r\n{\r\nu32 tmp = 0;\r\nint err = 0;\r\ncx_write(sram_ch->cmds_start + 0, dev->_risc_phys_addr);\r\ncx_write(sram_ch->cmds_start + 4, 0);\r\ncx_write(sram_ch->gpcnt_ctl, 3);\r\ncx_write(sram_ch->aud_length, AUDIO_LINE_SIZE & FLD_AUD_DST_LN_LNGTH);\r\ntmp = cx_read(sram_ch->aud_cfg);\r\ntmp |= FLD_AUD_SRC_ENABLE | FLD_AUD_DST_PK_MODE | FLD_AUD_CLK_ENABLE |\r\nFLD_AUD_MASTER_MODE | FLD_AUD_CLK_SELECT_PLL_D |\r\nFLD_AUD_SONY_MODE;\r\ncx_write(sram_ch->aud_cfg, tmp);\r\ntmp = cx_read(sram_ch->int_stat);\r\ncx_write(sram_ch->int_stat, tmp);\r\ncx_write(sram_ch->int_stat, _intr_msk);\r\ncx_set(PCI_INT_MSK, cx_read(PCI_INT_MSK) | (1 << sram_ch->irq_bit));\r\ntmp = cx_read(sram_ch->int_msk);\r\ncx_write(sram_ch->int_msk, tmp |= _intr_msk);\r\nerr = request_irq(dev->pci->irq, cx25821_upstream_irq_audio,\r\nIRQF_SHARED, dev->name, dev);\r\nif (err < 0) {\r\npr_err("%s: can't get upstream IRQ %d\n", dev->name,\r\ndev->pci->irq);\r\ngoto fail_irq;\r\n}\r\ntmp = cx_read(sram_ch->dma_ctl);\r\ncx_set(sram_ch->dma_ctl, tmp | sram_ch->fld_aud_risc_en);\r\ndev->_audio_is_running = 1;\r\ndev->_is_first_audio_frame = 1;\r\ncx25821_wait_fifo_enable(dev, sram_ch);\r\nreturn 0;\r\nfail_irq:\r\ncx25821_dev_unregister(dev);\r\nreturn err;\r\n}\r\nint cx25821_audio_upstream_init(struct cx25821_dev *dev, int channel_select)\r\n{\r\nstruct sram_channel *sram_ch;\r\nint retval = 0;\r\nint err = 0;\r\nint str_length = 0;\r\nif (dev->_audio_is_running) {\r\npr_warn("Audio Channel is still running so return!\n");\r\nreturn 0;\r\n}\r\ndev->_audio_upstream_channel = channel_select;\r\nsram_ch = dev->channels[channel_select].sram_channels;\r\nINIT_WORK(&dev->_audio_work_entry, cx25821_audioups_handler);\r\ndev->_irq_audio_queues =\r\ncreate_singlethread_workqueue("cx25821_audioworkqueue");\r\nif (!dev->_irq_audio_queues) {\r\nprintk(KERN_DEBUG\r\npr_fmt("ERROR: create_singlethread_workqueue() for Audio FAILED!\n"));\r\nreturn -ENOMEM;\r\n}\r\ndev->_last_index_irq = 0;\r\ndev->_audio_is_running = 0;\r\ndev->_audioframe_count = 0;\r\ndev->_audiofile_status = RESET_STATUS;\r\ndev->_audio_lines_count = LINES_PER_AUDIO_BUFFER;\r\n_line_size = AUDIO_LINE_SIZE;\r\nif (dev->input_audiofilename) {\r\nstr_length = strlen(dev->input_audiofilename);\r\ndev->_audiofilename = kmemdup(dev->input_audiofilename,\r\nstr_length + 1, GFP_KERNEL);\r\nif (!dev->_audiofilename)\r\ngoto error;\r\nif (strcmp(dev->input_audiofilename, "") == 0)\r\ndev->_audiofilename = "/root/audioGOOD.wav";\r\n} else {\r\nstr_length = strlen(_defaultAudioName);\r\ndev->_audiofilename = kmemdup(_defaultAudioName,\r\nstr_length + 1, GFP_KERNEL);\r\nif (!dev->_audiofilename)\r\ngoto error;\r\n}\r\nretval = cx25821_sram_channel_setup_upstream_audio(dev, sram_ch,\r\n_line_size, 0);\r\ndev->audio_upstream_riscbuf_size =\r\nAUDIO_RISC_DMA_BUF_SIZE * NUM_AUDIO_PROGS +\r\nRISC_SYNC_INSTRUCTION_SIZE;\r\ndev->audio_upstream_databuf_size = AUDIO_DATA_BUF_SZ * NUM_AUDIO_PROGS;\r\nretval = cx25821_audio_upstream_buffer_prepare(dev, sram_ch,\r\n_line_size);\r\nif (retval < 0) {\r\npr_err("%s: Failed to set up Audio upstream buffers!\n",\r\ndev->name);\r\ngoto error;\r\n}\r\ncx25821_start_audio_dma_upstream(dev, sram_ch);\r\nreturn 0;\r\nerror:\r\ncx25821_dev_unregister(dev);\r\nreturn err;\r\n}

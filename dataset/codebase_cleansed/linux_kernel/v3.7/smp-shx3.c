static irqreturn_t ipi_interrupt_handler(int irq, void *arg)\r\n{\r\nunsigned int message = (unsigned int)(long)arg;\r\nunsigned int cpu = hard_smp_processor_id();\r\nunsigned int offs = 4 * cpu;\r\nunsigned int x;\r\nx = __raw_readl(0xfe410070 + offs);\r\nx &= (1 << (message << 2));\r\n__raw_writel(x, 0xfe410080 + offs);\r\nsmp_message_recv(message);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void shx3_smp_setup(void)\r\n{\r\nunsigned int cpu = 0;\r\nint i, num;\r\ninit_cpu_possible(cpumask_of(cpu));\r\n__raw_writel(__raw_readl(STBCR_REG(cpu)) | STBCR_LTSLP, STBCR_REG(cpu));\r\n__cpu_number_map[0] = 0;\r\n__cpu_logical_map[0] = 0;\r\nfor (i = 1, num = 0; i < NR_CPUS; i++) {\r\nset_cpu_possible(i, true);\r\n__cpu_number_map[i] = ++num;\r\n__cpu_logical_map[num] = i;\r\n}\r\nprintk(KERN_INFO "Detected %i available secondary CPU(s)\n", num);\r\n}\r\nstatic void shx3_prepare_cpus(unsigned int max_cpus)\r\n{\r\nint i;\r\nlocal_timer_setup(0);\r\nBUILD_BUG_ON(SMP_MSG_NR >= 8);\r\nfor (i = 0; i < SMP_MSG_NR; i++)\r\nrequest_irq(104 + i, ipi_interrupt_handler,\r\nIRQF_PERCPU, "IPI", (void *)(long)i);\r\nfor (i = 0; i < max_cpus; i++)\r\nset_cpu_present(i, true);\r\n}\r\nstatic void shx3_start_cpu(unsigned int cpu, unsigned long entry_point)\r\n{\r\nif (__in_29bit_mode())\r\n__raw_writel(entry_point, RESET_REG(cpu));\r\nelse\r\n__raw_writel(virt_to_phys(entry_point), RESET_REG(cpu));\r\nif (!(__raw_readl(STBCR_REG(cpu)) & STBCR_MSTP))\r\n__raw_writel(STBCR_MSTP, STBCR_REG(cpu));\r\nwhile (!(__raw_readl(STBCR_REG(cpu)) & STBCR_MSTP))\r\ncpu_relax();\r\n__raw_writel(STBCR_RESET | STBCR_LTSLP, STBCR_REG(cpu));\r\n}\r\nstatic unsigned int shx3_smp_processor_id(void)\r\n{\r\nreturn __raw_readl(0xff000048);\r\n}\r\nstatic void shx3_send_ipi(unsigned int cpu, unsigned int message)\r\n{\r\nunsigned long addr = 0xfe410070 + (cpu * 4);\r\nBUG_ON(cpu >= 4);\r\n__raw_writel(1 << (message << 2), addr);\r\n}\r\nstatic void shx3_update_boot_vector(unsigned int cpu)\r\n{\r\n__raw_writel(STBCR_MSTP, STBCR_REG(cpu));\r\nwhile (!(__raw_readl(STBCR_REG(cpu)) & STBCR_MSTP))\r\ncpu_relax();\r\n__raw_writel(STBCR_RESET, STBCR_REG(cpu));\r\n}\r\nstatic int __cpuinit\r\nshx3_cpu_callback(struct notifier_block *nfb, unsigned long action, void *hcpu)\r\n{\r\nunsigned int cpu = (unsigned int)hcpu;\r\nswitch (action) {\r\ncase CPU_UP_PREPARE:\r\nshx3_update_boot_vector(cpu);\r\nbreak;\r\ncase CPU_ONLINE:\r\npr_info("CPU %u is now online\n", cpu);\r\nbreak;\r\ncase CPU_DEAD:\r\nbreak;\r\n}\r\nreturn NOTIFY_OK;\r\n}\r\nstatic int __cpuinit register_shx3_cpu_notifier(void)\r\n{\r\nregister_hotcpu_notifier(&shx3_cpu_notifier);\r\nreturn 0;\r\n}

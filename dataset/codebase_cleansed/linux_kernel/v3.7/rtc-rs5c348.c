static int\r\nrs5c348_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct rs5c348_plat_data *pdata = spi->dev.platform_data;\r\nu8 txbuf[5+7], *txp;\r\nint ret;\r\ntxp = txbuf;\r\ntxbuf[0] = RS5C348_CMD_R(RS5C348_REG_CTL2);\r\ntxbuf[1] = 0;\r\ntxbuf[2] = RS5C348_CMD_R(RS5C348_REG_CTL2);\r\ntxbuf[3] = 0;\r\ntxbuf[4] = RS5C348_CMD_MW(RS5C348_REG_SECS);\r\ntxp = &txbuf[5];\r\ntxp[RS5C348_REG_SECS] = bin2bcd(tm->tm_sec);\r\ntxp[RS5C348_REG_MINS] = bin2bcd(tm->tm_min);\r\nif (pdata->rtc_24h) {\r\ntxp[RS5C348_REG_HOURS] = bin2bcd(tm->tm_hour);\r\n} else {\r\ntxp[RS5C348_REG_HOURS] = bin2bcd((tm->tm_hour + 11) % 12 + 1) |\r\n(tm->tm_hour >= 12 ? RS5C348_BIT_PM : 0);\r\n}\r\ntxp[RS5C348_REG_WDAY] = bin2bcd(tm->tm_wday);\r\ntxp[RS5C348_REG_DAY] = bin2bcd(tm->tm_mday);\r\ntxp[RS5C348_REG_MONTH] = bin2bcd(tm->tm_mon + 1) |\r\n(tm->tm_year >= 100 ? RS5C348_BIT_Y2K : 0);\r\ntxp[RS5C348_REG_YEAR] = bin2bcd(tm->tm_year % 100);\r\nret = spi_write_then_read(spi, txbuf, sizeof(txbuf), NULL, 0);\r\nudelay(62);\r\nreturn ret;\r\n}\r\nstatic int\r\nrs5c348_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nstruct rs5c348_plat_data *pdata = spi->dev.platform_data;\r\nu8 txbuf[5], rxbuf[7];\r\nint ret;\r\ntxbuf[0] = RS5C348_CMD_R(RS5C348_REG_CTL2);\r\ntxbuf[1] = 0;\r\ntxbuf[2] = RS5C348_CMD_R(RS5C348_REG_CTL2);\r\ntxbuf[3] = 0;\r\ntxbuf[4] = RS5C348_CMD_MR(RS5C348_REG_SECS);\r\nret = spi_write_then_read(spi, txbuf, sizeof(txbuf),\r\nrxbuf, sizeof(rxbuf));\r\nudelay(62);\r\nif (ret < 0)\r\nreturn ret;\r\ntm->tm_sec = bcd2bin(rxbuf[RS5C348_REG_SECS] & RS5C348_SECS_MASK);\r\ntm->tm_min = bcd2bin(rxbuf[RS5C348_REG_MINS] & RS5C348_MINS_MASK);\r\ntm->tm_hour = bcd2bin(rxbuf[RS5C348_REG_HOURS] & RS5C348_HOURS_MASK);\r\nif (!pdata->rtc_24h) {\r\nif (rxbuf[RS5C348_REG_HOURS] & RS5C348_BIT_PM) {\r\ntm->tm_hour -= 20;\r\ntm->tm_hour %= 12;\r\ntm->tm_hour += 12;\r\n} else\r\ntm->tm_hour %= 12;\r\n}\r\ntm->tm_wday = bcd2bin(rxbuf[RS5C348_REG_WDAY] & RS5C348_WDAY_MASK);\r\ntm->tm_mday = bcd2bin(rxbuf[RS5C348_REG_DAY] & RS5C348_DAY_MASK);\r\ntm->tm_mon =\r\nbcd2bin(rxbuf[RS5C348_REG_MONTH] & RS5C348_MONTH_MASK) - 1;\r\ntm->tm_year = bcd2bin(rxbuf[RS5C348_REG_YEAR]) +\r\n((rxbuf[RS5C348_REG_MONTH] & RS5C348_BIT_Y2K) ? 100 : 0);\r\nif (rtc_valid_tm(tm) < 0) {\r\ndev_err(&spi->dev, "retrieved date/time is not valid.\n");\r\nrtc_time_to_tm(0, tm);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit rs5c348_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct rtc_device *rtc;\r\nstruct rs5c348_plat_data *pdata;\r\npdata = kzalloc(sizeof(struct rs5c348_plat_data), GFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nspi->dev.platform_data = pdata;\r\nret = spi_w8r8(spi, RS5C348_CMD_R(RS5C348_REG_SECS));\r\nif (ret < 0 || (ret & 0x80)) {\r\ndev_err(&spi->dev, "not found.\n");\r\ngoto kfree_exit;\r\n}\r\ndev_info(&spi->dev, "chip found, driver version " DRV_VERSION "\n");\r\ndev_info(&spi->dev, "spiclk %u KHz.\n",\r\n(spi->max_speed_hz + 500) / 1000);\r\nret = spi_w8r8(spi, RS5C348_CMD_R(RS5C348_REG_CTL2));\r\nif (ret < 0)\r\ngoto kfree_exit;\r\nif (ret & (RS5C348_BIT_XSTP | RS5C348_BIT_VDET)) {\r\nu8 buf[2];\r\nstruct rtc_time tm;\r\nif (ret & RS5C348_BIT_VDET)\r\ndev_warn(&spi->dev, "voltage-low detected.\n");\r\nif (ret & RS5C348_BIT_XSTP)\r\ndev_warn(&spi->dev, "oscillator-stop detected.\n");\r\nrtc_time_to_tm(0, &tm);\r\nret = rs5c348_rtc_set_time(&spi->dev, &tm);\r\nif (ret < 0)\r\ngoto kfree_exit;\r\nbuf[0] = RS5C348_CMD_W(RS5C348_REG_CTL2);\r\nbuf[1] = 0;\r\nret = spi_write_then_read(spi, buf, sizeof(buf), NULL, 0);\r\nif (ret < 0)\r\ngoto kfree_exit;\r\n}\r\nret = spi_w8r8(spi, RS5C348_CMD_R(RS5C348_REG_CTL1));\r\nif (ret < 0)\r\ngoto kfree_exit;\r\nif (ret & RS5C348_BIT_24H)\r\npdata->rtc_24h = 1;\r\nrtc = rtc_device_register(rs5c348_driver.driver.name, &spi->dev,\r\n&rs5c348_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nret = PTR_ERR(rtc);\r\ngoto kfree_exit;\r\n}\r\npdata->rtc = rtc;\r\nreturn 0;\r\nkfree_exit:\r\nkfree(pdata);\r\nreturn ret;\r\n}\r\nstatic int __devexit rs5c348_remove(struct spi_device *spi)\r\n{\r\nstruct rs5c348_plat_data *pdata = spi->dev.platform_data;\r\nstruct rtc_device *rtc = pdata->rtc;\r\nif (rtc)\r\nrtc_device_unregister(rtc);\r\nkfree(pdata);\r\nreturn 0;\r\n}

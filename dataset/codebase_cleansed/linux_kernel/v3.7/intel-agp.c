static int intel_fetch_size(void)\r\n{\r\nint i;\r\nu16 temp;\r\nstruct aper_size_info_16 *values;\r\npci_read_config_word(agp_bridge->dev, INTEL_APSIZE, &temp);\r\nvalues = A_SIZE_16(agp_bridge->driver->aperture_sizes);\r\nfor (i = 0; i < agp_bridge->driver->num_aperture_sizes; i++) {\r\nif (temp == values[i].size_value) {\r\nagp_bridge->previous_size = agp_bridge->current_size = (void *) (values + i);\r\nagp_bridge->aperture_size_idx = i;\r\nreturn values[i].size;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __intel_8xx_fetch_size(u8 temp)\r\n{\r\nint i;\r\nstruct aper_size_info_8 *values;\r\nvalues = A_SIZE_8(agp_bridge->driver->aperture_sizes);\r\nfor (i = 0; i < agp_bridge->driver->num_aperture_sizes; i++) {\r\nif (temp == values[i].size_value) {\r\nagp_bridge->previous_size =\r\nagp_bridge->current_size = (void *) (values + i);\r\nagp_bridge->aperture_size_idx = i;\r\nreturn values[i].size;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int intel_8xx_fetch_size(void)\r\n{\r\nu8 temp;\r\npci_read_config_byte(agp_bridge->dev, INTEL_APSIZE, &temp);\r\nreturn __intel_8xx_fetch_size(temp);\r\n}\r\nstatic int intel_815_fetch_size(void)\r\n{\r\nu8 temp;\r\npci_read_config_byte(agp_bridge->dev, INTEL_APSIZE, &temp);\r\ntemp &= (1 << 3);\r\nreturn __intel_8xx_fetch_size(temp);\r\n}\r\nstatic void intel_tlbflush(struct agp_memory *mem)\r\n{\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x2200);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x2280);\r\n}\r\nstatic void intel_8xx_tlbflush(struct agp_memory *mem)\r\n{\r\nu32 temp;\r\npci_read_config_dword(agp_bridge->dev, INTEL_AGPCTRL, &temp);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, temp & ~(1 << 7));\r\npci_read_config_dword(agp_bridge->dev, INTEL_AGPCTRL, &temp);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, temp | (1 << 7));\r\n}\r\nstatic void intel_cleanup(void)\r\n{\r\nu16 temp;\r\nstruct aper_size_info_16 *previous_size;\r\nprevious_size = A_SIZE_16(agp_bridge->previous_size);\r\npci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp);\r\npci_write_config_word(agp_bridge->dev, INTEL_NBXCFG, temp & ~(1 << 9));\r\npci_write_config_word(agp_bridge->dev, INTEL_APSIZE, previous_size->size_value);\r\n}\r\nstatic void intel_8xx_cleanup(void)\r\n{\r\nu16 temp;\r\nstruct aper_size_info_8 *previous_size;\r\nprevious_size = A_SIZE_8(agp_bridge->previous_size);\r\npci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp);\r\npci_write_config_word(agp_bridge->dev, INTEL_NBXCFG, temp & ~(1 << 9));\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, previous_size->size_value);\r\n}\r\nstatic int intel_configure(void)\r\n{\r\nu32 temp;\r\nu16 temp2;\r\nstruct aper_size_info_16 *current_size;\r\ncurrent_size = A_SIZE_16(agp_bridge->current_size);\r\npci_write_config_word(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x2280);\r\npci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp2);\r\npci_write_config_word(agp_bridge->dev, INTEL_NBXCFG,\r\n(temp2 & ~(1 << 10)) | (1 << 9));\r\npci_write_config_byte(agp_bridge->dev, INTEL_ERRSTS + 1, 7);\r\nreturn 0;\r\n}\r\nstatic int intel_815_configure(void)\r\n{\r\nu32 temp, addr;\r\nu8 temp2;\r\nstruct aper_size_info_8 *current_size;\r\nif (agp_bridge->gatt_bus_addr & INTEL_815_ATTBASE_MASK) {\r\ndev_emerg(&agp_bridge->dev->dev, "gatt bus addr too high");\r\nreturn -EINVAL;\r\n}\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE,\r\ncurrent_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_read_config_dword(agp_bridge->dev, INTEL_ATTBASE, &addr);\r\naddr &= INTEL_815_ATTBASE_MASK;\r\naddr |= agp_bridge->gatt_bus_addr;\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_byte(agp_bridge->dev, INTEL_815_APCONT, &temp2);\r\npci_write_config_byte(agp_bridge->dev, INTEL_815_APCONT, temp2 | (1 << 1));\r\nreturn 0;\r\n}\r\nstatic void intel_820_tlbflush(struct agp_memory *mem)\r\n{\r\nreturn;\r\n}\r\nstatic void intel_820_cleanup(void)\r\n{\r\nu8 temp;\r\nstruct aper_size_info_8 *previous_size;\r\nprevious_size = A_SIZE_8(agp_bridge->previous_size);\r\npci_read_config_byte(agp_bridge->dev, INTEL_I820_RDCR, &temp);\r\npci_write_config_byte(agp_bridge->dev, INTEL_I820_RDCR,\r\ntemp & ~(1 << 1));\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE,\r\nprevious_size->size_value);\r\n}\r\nstatic int intel_820_configure(void)\r\n{\r\nu32 temp;\r\nu8 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_byte(agp_bridge->dev, INTEL_I820_RDCR, &temp2);\r\npci_write_config_byte(agp_bridge->dev, INTEL_I820_RDCR, temp2 | (1 << 1));\r\npci_write_config_word(agp_bridge->dev, INTEL_I820_ERRSTS, 0x001c);\r\nreturn 0;\r\n}\r\nstatic int intel_840_configure(void)\r\n{\r\nu32 temp;\r\nu16 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_word(agp_bridge->dev, INTEL_I840_MCHCFG, &temp2);\r\npci_write_config_word(agp_bridge->dev, INTEL_I840_MCHCFG, temp2 | (1 << 9));\r\npci_write_config_word(agp_bridge->dev, INTEL_I840_ERRSTS, 0xc000);\r\nreturn 0;\r\n}\r\nstatic int intel_845_configure(void)\r\n{\r\nu32 temp;\r\nu8 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\nif (agp_bridge->apbase_config != 0) {\r\npci_write_config_dword(agp_bridge->dev, AGP_APBASE,\r\nagp_bridge->apbase_config);\r\n} else {\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\nagp_bridge->apbase_config = temp;\r\n}\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_byte(agp_bridge->dev, INTEL_I845_AGPM, &temp2);\r\npci_write_config_byte(agp_bridge->dev, INTEL_I845_AGPM, temp2 | (1 << 1));\r\npci_write_config_word(agp_bridge->dev, INTEL_I845_ERRSTS, 0x001c);\r\nreturn 0;\r\n}\r\nstatic int intel_850_configure(void)\r\n{\r\nu32 temp;\r\nu16 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_word(agp_bridge->dev, INTEL_I850_MCHCFG, &temp2);\r\npci_write_config_word(agp_bridge->dev, INTEL_I850_MCHCFG, temp2 | (1 << 9));\r\npci_write_config_word(agp_bridge->dev, INTEL_I850_ERRSTS, 0x001c);\r\nreturn 0;\r\n}\r\nstatic int intel_860_configure(void)\r\n{\r\nu32 temp;\r\nu16 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_word(agp_bridge->dev, INTEL_I860_MCHCFG, &temp2);\r\npci_write_config_word(agp_bridge->dev, INTEL_I860_MCHCFG, temp2 | (1 << 9));\r\npci_write_config_word(agp_bridge->dev, INTEL_I860_ERRSTS, 0xf700);\r\nreturn 0;\r\n}\r\nstatic int intel_830mp_configure(void)\r\n{\r\nu32 temp;\r\nu16 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_word(agp_bridge->dev, INTEL_NBXCFG, &temp2);\r\npci_write_config_word(agp_bridge->dev, INTEL_NBXCFG, temp2 | (1 << 9));\r\npci_write_config_word(agp_bridge->dev, INTEL_I830_ERRSTS, 0x1c);\r\nreturn 0;\r\n}\r\nstatic int intel_7505_configure(void)\r\n{\r\nu32 temp;\r\nu16 temp2;\r\nstruct aper_size_info_8 *current_size;\r\ncurrent_size = A_SIZE_8(agp_bridge->current_size);\r\npci_write_config_byte(agp_bridge->dev, INTEL_APSIZE, current_size->size_value);\r\npci_read_config_dword(agp_bridge->dev, AGP_APBASE, &temp);\r\nagp_bridge->gart_bus_addr = (temp & PCI_BASE_ADDRESS_MEM_MASK);\r\npci_write_config_dword(agp_bridge->dev, INTEL_ATTBASE, agp_bridge->gatt_bus_addr);\r\npci_write_config_dword(agp_bridge->dev, INTEL_AGPCTRL, 0x0000);\r\npci_read_config_word(agp_bridge->dev, INTEL_I7505_MCHCFG, &temp2);\r\npci_write_config_word(agp_bridge->dev, INTEL_I7505_MCHCFG, temp2 | (1 << 9));\r\nreturn 0;\r\n}\r\nstatic int __devinit agp_intel_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct agp_bridge_data *bridge;\r\nu8 cap_ptr = 0;\r\nstruct resource *r;\r\nint i, err;\r\ncap_ptr = pci_find_capability(pdev, PCI_CAP_ID_AGP);\r\nbridge = agp_alloc_bridge();\r\nif (!bridge)\r\nreturn -ENOMEM;\r\nbridge->capndx = cap_ptr;\r\nif (intel_gmch_probe(pdev, NULL, bridge))\r\ngoto found_gmch;\r\nfor (i = 0; intel_agp_chipsets[i].name != NULL; i++) {\r\nif (pdev->device == intel_agp_chipsets[i].chip_id) {\r\nbridge->driver = intel_agp_chipsets[i].driver;\r\nbreak;\r\n}\r\n}\r\nif (!bridge->driver) {\r\nif (cap_ptr)\r\ndev_warn(&pdev->dev, "unsupported Intel chipset [%04x/%04x]\n",\r\npdev->vendor, pdev->device);\r\nagp_put_bridge(bridge);\r\nreturn -ENODEV;\r\n}\r\nbridge->dev = pdev;\r\nbridge->dev_private_data = NULL;\r\ndev_info(&pdev->dev, "Intel %s Chipset\n", intel_agp_chipsets[i].name);\r\nr = &pdev->resource[0];\r\nif (!r->start && r->end) {\r\nif (pci_assign_resource(pdev, 0)) {\r\ndev_err(&pdev->dev, "can't assign resource 0\n");\r\nagp_put_bridge(bridge);\r\nreturn -ENODEV;\r\n}\r\n}\r\nif (pci_enable_device(pdev)) {\r\ndev_err(&pdev->dev, "can't enable PCI device\n");\r\nagp_put_bridge(bridge);\r\nreturn -ENODEV;\r\n}\r\nif (cap_ptr) {\r\npci_read_config_dword(pdev,\r\nbridge->capndx+PCI_AGP_STATUS,\r\n&bridge->mode);\r\n}\r\nfound_gmch:\r\npci_set_drvdata(pdev, bridge);\r\nerr = agp_add_bridge(bridge);\r\nif (!err)\r\nintel_agp_enabled = 1;\r\nreturn err;\r\n}\r\nstatic void __devexit agp_intel_remove(struct pci_dev *pdev)\r\n{\r\nstruct agp_bridge_data *bridge = pci_get_drvdata(pdev);\r\nagp_remove_bridge(bridge);\r\nintel_gmch_remove();\r\nagp_put_bridge(bridge);\r\n}\r\nstatic int agp_intel_resume(struct pci_dev *pdev)\r\n{\r\nstruct agp_bridge_data *bridge = pci_get_drvdata(pdev);\r\nbridge->driver->configure();\r\nreturn 0;\r\n}\r\nstatic int __init agp_intel_init(void)\r\n{\r\nif (agp_off)\r\nreturn -EINVAL;\r\nreturn pci_register_driver(&agp_intel_pci_driver);\r\n}\r\nstatic void __exit agp_intel_cleanup(void)\r\n{\r\npci_unregister_driver(&agp_intel_pci_driver);\r\n}

static int dbell2prio(ulong param)\r\n{\r\nint msg = param & PPC_DBELL_TYPE_MASK;\r\nint prio = -1;\r\nswitch (msg) {\r\ncase PPC_DBELL_TYPE(PPC_DBELL):\r\nprio = BOOKE_IRQPRIO_DBELL;\r\nbreak;\r\ncase PPC_DBELL_TYPE(PPC_DBELL_CRIT):\r\nprio = BOOKE_IRQPRIO_DBELL_CRIT;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn prio;\r\n}\r\nstatic int kvmppc_e500_emul_msgclr(struct kvm_vcpu *vcpu, int rb)\r\n{\r\nulong param = vcpu->arch.gpr[rb];\r\nint prio = dbell2prio(param);\r\nif (prio < 0)\r\nreturn EMULATE_FAIL;\r\nclear_bit(prio, &vcpu->arch.pending_exceptions);\r\nreturn EMULATE_DONE;\r\n}\r\nstatic int kvmppc_e500_emul_msgsnd(struct kvm_vcpu *vcpu, int rb)\r\n{\r\nulong param = vcpu->arch.gpr[rb];\r\nint prio = dbell2prio(rb);\r\nint pir = param & PPC_DBELL_PIR_MASK;\r\nint i;\r\nstruct kvm_vcpu *cvcpu;\r\nif (prio < 0)\r\nreturn EMULATE_FAIL;\r\nkvm_for_each_vcpu(i, cvcpu, vcpu->kvm) {\r\nint cpir = cvcpu->arch.shared->pir;\r\nif ((param & PPC_DBELL_MSG_BRDCAST) || (cpir == pir)) {\r\nset_bit(prio, &cvcpu->arch.pending_exceptions);\r\nkvm_vcpu_kick(cvcpu);\r\n}\r\n}\r\nreturn EMULATE_DONE;\r\n}\r\nint kvmppc_core_emulate_op(struct kvm_run *run, struct kvm_vcpu *vcpu,\r\nunsigned int inst, int *advance)\r\n{\r\nint emulated = EMULATE_DONE;\r\nint ra = get_ra(inst);\r\nint rb = get_rb(inst);\r\nint rt = get_rt(inst);\r\nswitch (get_op(inst)) {\r\ncase 31:\r\nswitch (get_xop(inst)) {\r\n#ifdef CONFIG_KVM_E500MC\r\ncase XOP_MSGSND:\r\nemulated = kvmppc_e500_emul_msgsnd(vcpu, rb);\r\nbreak;\r\ncase XOP_MSGCLR:\r\nemulated = kvmppc_e500_emul_msgclr(vcpu, rb);\r\nbreak;\r\n#endif\r\ncase XOP_TLBRE:\r\nemulated = kvmppc_e500_emul_tlbre(vcpu);\r\nbreak;\r\ncase XOP_TLBWE:\r\nemulated = kvmppc_e500_emul_tlbwe(vcpu);\r\nbreak;\r\ncase XOP_TLBSX:\r\nemulated = kvmppc_e500_emul_tlbsx(vcpu,rb);\r\nbreak;\r\ncase XOP_TLBILX:\r\nemulated = kvmppc_e500_emul_tlbilx(vcpu, rt, ra, rb);\r\nbreak;\r\ncase XOP_TLBIVAX:\r\nemulated = kvmppc_e500_emul_tlbivax(vcpu, ra, rb);\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nbreak;\r\ndefault:\r\nemulated = EMULATE_FAIL;\r\n}\r\nif (emulated == EMULATE_FAIL)\r\nemulated = kvmppc_booke_emulate_op(run, vcpu, inst, advance);\r\nreturn emulated;\r\n}\r\nint kvmppc_core_emulate_mtspr(struct kvm_vcpu *vcpu, int sprn, ulong spr_val)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\n#ifndef CONFIG_KVM_BOOKE_HV\r\ncase SPRN_PID:\r\nkvmppc_set_pid(vcpu, spr_val);\r\nbreak;\r\ncase SPRN_PID1:\r\nif (spr_val != 0)\r\nreturn EMULATE_FAIL;\r\nvcpu_e500->pid[1] = spr_val;\r\nbreak;\r\ncase SPRN_PID2:\r\nif (spr_val != 0)\r\nreturn EMULATE_FAIL;\r\nvcpu_e500->pid[2] = spr_val;\r\nbreak;\r\ncase SPRN_MAS0:\r\nvcpu->arch.shared->mas0 = spr_val;\r\nbreak;\r\ncase SPRN_MAS1:\r\nvcpu->arch.shared->mas1 = spr_val;\r\nbreak;\r\ncase SPRN_MAS2:\r\nvcpu->arch.shared->mas2 = spr_val;\r\nbreak;\r\ncase SPRN_MAS3:\r\nvcpu->arch.shared->mas7_3 &= ~(u64)0xffffffff;\r\nvcpu->arch.shared->mas7_3 |= spr_val;\r\nbreak;\r\ncase SPRN_MAS4:\r\nvcpu->arch.shared->mas4 = spr_val;\r\nbreak;\r\ncase SPRN_MAS6:\r\nvcpu->arch.shared->mas6 = spr_val;\r\nbreak;\r\ncase SPRN_MAS7:\r\nvcpu->arch.shared->mas7_3 &= (u64)0xffffffff;\r\nvcpu->arch.shared->mas7_3 |= (u64)spr_val << 32;\r\nbreak;\r\n#endif\r\ncase SPRN_L1CSR0:\r\nvcpu_e500->l1csr0 = spr_val;\r\nvcpu_e500->l1csr0 &= ~(L1CSR0_DCFI | L1CSR0_CLFC);\r\nbreak;\r\ncase SPRN_L1CSR1:\r\nvcpu_e500->l1csr1 = spr_val;\r\nbreak;\r\ncase SPRN_HID0:\r\nvcpu_e500->hid0 = spr_val;\r\nbreak;\r\ncase SPRN_HID1:\r\nvcpu_e500->hid1 = spr_val;\r\nbreak;\r\ncase SPRN_MMUCSR0:\r\nemulated = kvmppc_e500_emul_mt_mmucsr0(vcpu_e500,\r\nspr_val);\r\nbreak;\r\ncase SPRN_IVOR32:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR33:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_DATA] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR34:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_ROUND] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR35:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR] = spr_val;\r\nbreak;\r\n#ifdef CONFIG_KVM_BOOKE_HV\r\ncase SPRN_IVOR36:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DBELL] = spr_val;\r\nbreak;\r\ncase SPRN_IVOR37:\r\nvcpu->arch.ivor[BOOKE_IRQPRIO_DBELL_CRIT] = spr_val;\r\nbreak;\r\n#endif\r\ndefault:\r\nemulated = kvmppc_booke_emulate_mtspr(vcpu, sprn, spr_val);\r\n}\r\nreturn emulated;\r\n}\r\nint kvmppc_core_emulate_mfspr(struct kvm_vcpu *vcpu, int sprn, ulong *spr_val)\r\n{\r\nstruct kvmppc_vcpu_e500 *vcpu_e500 = to_e500(vcpu);\r\nint emulated = EMULATE_DONE;\r\nswitch (sprn) {\r\n#ifndef CONFIG_KVM_BOOKE_HV\r\ncase SPRN_PID:\r\n*spr_val = vcpu_e500->pid[0];\r\nbreak;\r\ncase SPRN_PID1:\r\n*spr_val = vcpu_e500->pid[1];\r\nbreak;\r\ncase SPRN_PID2:\r\n*spr_val = vcpu_e500->pid[2];\r\nbreak;\r\ncase SPRN_MAS0:\r\n*spr_val = vcpu->arch.shared->mas0;\r\nbreak;\r\ncase SPRN_MAS1:\r\n*spr_val = vcpu->arch.shared->mas1;\r\nbreak;\r\ncase SPRN_MAS2:\r\n*spr_val = vcpu->arch.shared->mas2;\r\nbreak;\r\ncase SPRN_MAS3:\r\n*spr_val = (u32)vcpu->arch.shared->mas7_3;\r\nbreak;\r\ncase SPRN_MAS4:\r\n*spr_val = vcpu->arch.shared->mas4;\r\nbreak;\r\ncase SPRN_MAS6:\r\n*spr_val = vcpu->arch.shared->mas6;\r\nbreak;\r\ncase SPRN_MAS7:\r\n*spr_val = vcpu->arch.shared->mas7_3 >> 32;\r\nbreak;\r\n#endif\r\ncase SPRN_DECAR:\r\n*spr_val = vcpu->arch.decar;\r\nbreak;\r\ncase SPRN_TLB0CFG:\r\n*spr_val = vcpu->arch.tlbcfg[0];\r\nbreak;\r\ncase SPRN_TLB1CFG:\r\n*spr_val = vcpu->arch.tlbcfg[1];\r\nbreak;\r\ncase SPRN_L1CSR0:\r\n*spr_val = vcpu_e500->l1csr0;\r\nbreak;\r\ncase SPRN_L1CSR1:\r\n*spr_val = vcpu_e500->l1csr1;\r\nbreak;\r\ncase SPRN_HID0:\r\n*spr_val = vcpu_e500->hid0;\r\nbreak;\r\ncase SPRN_HID1:\r\n*spr_val = vcpu_e500->hid1;\r\nbreak;\r\ncase SPRN_SVR:\r\n*spr_val = vcpu_e500->svr;\r\nbreak;\r\ncase SPRN_MMUCSR0:\r\n*spr_val = 0;\r\nbreak;\r\ncase SPRN_MMUCFG:\r\n*spr_val = vcpu->arch.mmucfg;\r\nbreak;\r\ncase SPRN_IVOR32:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_UNAVAIL];\r\nbreak;\r\ncase SPRN_IVOR33:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_DATA];\r\nbreak;\r\ncase SPRN_IVOR34:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_SPE_FP_ROUND];\r\nbreak;\r\ncase SPRN_IVOR35:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_PERFORMANCE_MONITOR];\r\nbreak;\r\n#ifdef CONFIG_KVM_BOOKE_HV\r\ncase SPRN_IVOR36:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_DBELL];\r\nbreak;\r\ncase SPRN_IVOR37:\r\n*spr_val = vcpu->arch.ivor[BOOKE_IRQPRIO_DBELL_CRIT];\r\nbreak;\r\n#endif\r\ndefault:\r\nemulated = kvmppc_booke_emulate_mfspr(vcpu, sprn, spr_val);\r\n}\r\nreturn emulated;\r\n}

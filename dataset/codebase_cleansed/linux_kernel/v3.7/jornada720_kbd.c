static irqreturn_t jornada720_kbd_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct jornadakbd *jornadakbd = platform_get_drvdata(pdev);\r\nstruct input_dev *input = jornadakbd->input;\r\nu8 count, kbd_data, scan_code;\r\njornada_ssp_start();\r\nif (jornada_ssp_inout(GETSCANKEYCODE) != TXDUMMY) {\r\nprintk(KERN_DEBUG\r\n"jornada720_kbd: "\r\n"GetKeycode command failed with ETIMEDOUT, "\r\n"flushed bus\n");\r\n} else {\r\ncount = jornada_ssp_byte(TXDUMMY);\r\nwhile (count--) {\r\nkbd_data = jornada_ssp_byte(TXDUMMY);\r\nscan_code = kbd_data & 0x7f;\r\ninput_event(input, EV_MSC, MSC_SCAN, scan_code);\r\ninput_report_key(input, jornadakbd->keymap[scan_code],\r\n!(kbd_data & 0x80));\r\ninput_sync(input);\r\n}\r\n}\r\njornada_ssp_end();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit jornada720_kbd_probe(struct platform_device *pdev)\r\n{\r\nstruct jornadakbd *jornadakbd;\r\nstruct input_dev *input_dev;\r\nint i, err;\r\njornadakbd = kzalloc(sizeof(struct jornadakbd), GFP_KERNEL);\r\ninput_dev = input_allocate_device();\r\nif (!jornadakbd || !input_dev) {\r\nerr = -ENOMEM;\r\ngoto fail1;\r\n}\r\nplatform_set_drvdata(pdev, jornadakbd);\r\nmemcpy(jornadakbd->keymap, jornada_std_keymap,\r\nsizeof(jornada_std_keymap));\r\njornadakbd->input = input_dev;\r\ninput_dev->evbit[0] = BIT(EV_KEY) | BIT(EV_REP);\r\ninput_dev->name = "HP Jornada 720 keyboard";\r\ninput_dev->phys = "jornadakbd/input0";\r\ninput_dev->keycode = jornadakbd->keymap;\r\ninput_dev->keycodesize = sizeof(unsigned short);\r\ninput_dev->keycodemax = ARRAY_SIZE(jornada_std_keymap);\r\ninput_dev->id.bustype = BUS_HOST;\r\ninput_dev->dev.parent = &pdev->dev;\r\nfor (i = 0; i < ARRAY_SIZE(jornadakbd->keymap); i++)\r\n__set_bit(jornadakbd->keymap[i], input_dev->keybit);\r\n__clear_bit(KEY_RESERVED, input_dev->keybit);\r\ninput_set_capability(input_dev, EV_MSC, MSC_SCAN);\r\nerr = request_irq(IRQ_GPIO0,\r\njornada720_kbd_interrupt,\r\nIRQF_TRIGGER_FALLING,\r\n"jornadakbd", pdev);\r\nif (err) {\r\nprintk(KERN_INFO "jornadakbd720_kbd: Unable to grab IRQ\n");\r\ngoto fail1;\r\n}\r\nerr = input_register_device(jornadakbd->input);\r\nif (err)\r\ngoto fail2;\r\nreturn 0;\r\nfail2:\r\nfree_irq(IRQ_GPIO0, pdev);\r\nfail1:\r\nplatform_set_drvdata(pdev, NULL);\r\ninput_free_device(input_dev);\r\nkfree(jornadakbd);\r\nreturn err;\r\n}\r\nstatic int __devexit jornada720_kbd_remove(struct platform_device *pdev)\r\n{\r\nstruct jornadakbd *jornadakbd = platform_get_drvdata(pdev);\r\nfree_irq(IRQ_GPIO0, pdev);\r\nplatform_set_drvdata(pdev, NULL);\r\ninput_unregister_device(jornadakbd->input);\r\nkfree(jornadakbd);\r\nreturn 0;\r\n}

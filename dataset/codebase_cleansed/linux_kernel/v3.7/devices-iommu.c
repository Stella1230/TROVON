static int __init msm8x60_iommu_init(void)\r\n{\r\nint ret, i;\r\nret = platform_device_register(&msm_root_iommu_dev);\r\nif (ret != 0) {\r\npr_err("Failed to register root IOMMU device!\n");\r\ngoto failure;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(msm_iommu_devs); i++) {\r\nret = platform_device_add_data(msm_iommu_devs[i],\r\nmsm_iommu_data[i],\r\nsizeof(struct msm_iommu_dev));\r\nif (ret != 0) {\r\npr_err("platform_device_add_data failed, "\r\n"i = %d\n", i);\r\ngoto failure_unwind;\r\n}\r\nret = platform_device_register(msm_iommu_devs[i]);\r\nif (ret != 0) {\r\npr_err("platform_device_register iommu failed, "\r\n"i = %d\n", i);\r\ngoto failure_unwind;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(msm_iommu_ctx_devs); i++) {\r\nret = platform_device_add_data(msm_iommu_ctx_devs[i],\r\nmsm_iommu_ctx_data[i],\r\nsizeof(*msm_iommu_ctx_devs[i]));\r\nif (ret != 0) {\r\npr_err("platform_device_add_data iommu failed, "\r\n"i = %d\n", i);\r\ngoto failure_unwind2;\r\n}\r\nret = platform_device_register(msm_iommu_ctx_devs[i]);\r\nif (ret != 0) {\r\npr_err("platform_device_register ctx failed, "\r\n"i = %d\n", i);\r\ngoto failure_unwind2;\r\n}\r\n}\r\nreturn 0;\r\nfailure_unwind2:\r\nwhile (--i >= 0)\r\nplatform_device_unregister(msm_iommu_ctx_devs[i]);\r\nfailure_unwind:\r\nwhile (--i >= 0)\r\nplatform_device_unregister(msm_iommu_devs[i]);\r\nplatform_device_unregister(&msm_root_iommu_dev);\r\nfailure:\r\nreturn ret;\r\n}\r\nstatic void __exit msm8x60_iommu_exit(void)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(msm_iommu_ctx_devs); i++)\r\nplatform_device_unregister(msm_iommu_ctx_devs[i]);\r\nfor (i = 0; i < ARRAY_SIZE(msm_iommu_devs); ++i)\r\nplatform_device_unregister(msm_iommu_devs[i]);\r\nplatform_device_unregister(&msm_root_iommu_dev);\r\n}

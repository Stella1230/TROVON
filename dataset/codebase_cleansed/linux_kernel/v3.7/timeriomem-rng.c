static int timeriomem_rng_data_present(struct hwrng *rng, int wait)\r\n{\r\nif (rng->priv == 0)\r\nreturn 1;\r\nif (!wait || timeriomem_rng_data->present)\r\nreturn timeriomem_rng_data->present;\r\nwait_for_completion(&timeriomem_rng_data->completion);\r\nreturn 1;\r\n}\r\nstatic int timeriomem_rng_data_read(struct hwrng *rng, u32 *data)\r\n{\r\nunsigned long cur;\r\ns32 delay;\r\n*data = readl(timeriomem_rng_data->address);\r\nif (rng->priv != 0) {\r\ncur = jiffies;\r\ndelay = cur - timeriomem_rng_timer.expires;\r\ndelay = rng->priv - (delay % rng->priv);\r\ntimeriomem_rng_timer.expires = cur + delay;\r\ntimeriomem_rng_data->present = 0;\r\ninit_completion(&timeriomem_rng_data->completion);\r\nadd_timer(&timeriomem_rng_timer);\r\n}\r\nreturn 4;\r\n}\r\nstatic void timeriomem_rng_trigger(unsigned long dummy)\r\n{\r\ntimeriomem_rng_data->present = 1;\r\ncomplete(&timeriomem_rng_data->completion);\r\n}\r\nstatic int __devinit timeriomem_rng_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENOENT;\r\ntimeriomem_rng_data = pdev->dev.platform_data;\r\ntimeriomem_rng_data->address = ioremap(res->start, resource_size(res));\r\nif (!timeriomem_rng_data->address)\r\nreturn -EIO;\r\nif (timeriomem_rng_data->period != 0\r\n&& usecs_to_jiffies(timeriomem_rng_data->period) > 0) {\r\ntimeriomem_rng_timer.expires = jiffies;\r\ntimeriomem_rng_ops.priv = usecs_to_jiffies(\r\ntimeriomem_rng_data->period);\r\n}\r\ntimeriomem_rng_data->present = 1;\r\nret = hwrng_register(&timeriomem_rng_ops);\r\nif (ret)\r\ngoto failed;\r\ndev_info(&pdev->dev, "32bits from 0x%p @ %dus\n",\r\ntimeriomem_rng_data->address,\r\ntimeriomem_rng_data->period);\r\nreturn 0;\r\nfailed:\r\ndev_err(&pdev->dev, "problem registering\n");\r\niounmap(timeriomem_rng_data->address);\r\nreturn ret;\r\n}\r\nstatic int __devexit timeriomem_rng_remove(struct platform_device *pdev)\r\n{\r\ndel_timer_sync(&timeriomem_rng_timer);\r\nhwrng_unregister(&timeriomem_rng_ops);\r\niounmap(timeriomem_rng_data->address);\r\nreturn 0;\r\n}

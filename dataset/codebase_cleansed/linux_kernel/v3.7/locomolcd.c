static void locomolcd_on(int comadj)\r\n{\r\nlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHA_ON, 0);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHA_ON, 1);\r\nmdelay(2);\r\nlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHD_ON, 0);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHD_ON, 1);\r\nmdelay(2);\r\nlocomo_m62332_senddata(locomolcd_dev, comadj, 0);\r\nmdelay(5);\r\nlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VEE_ON, 0);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VEE_ON, 1);\r\nmdelay(10);\r\nlocomo_writel(0x01, locomolcd_dev->mapbase + LOCOMO_TC);\r\nlocomo_writel(6, locomolcd_dev->mapbase + LOCOMO_CPSD);\r\nlocomo_writel((0x04 | 0x01), locomolcd_dev->mapbase + LOCOMO_TC);\r\nmdelay(10);\r\nlocomo_gpio_set_dir(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_MOD, 0);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_MOD, 1);\r\n}\r\nstatic void locomolcd_off(int comadj)\r\n{\r\nlocomo_writel(0x06, locomolcd_dev->mapbase + LOCOMO_TC);\r\nmdelay(1);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHA_ON, 0);\r\nmdelay(110);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VEE_ON, 0);\r\nmdelay(700);\r\nlocomo_writel(0, locomolcd_dev->mapbase + LOCOMO_TC);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_MOD, 0);\r\nlocomo_gpio_write(locomolcd_dev->dev.parent, LOCOMO_GPIO_LCD_VSHD_ON, 0);\r\n}\r\nvoid locomolcd_power(int on)\r\n{\r\nint comadj = sharpsl_param.comadj;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nif (!locomolcd_dev) {\r\nlocal_irq_restore(flags);\r\nreturn;\r\n}\r\nif (comadj == -1 && machine_is_collie())\r\ncomadj = 128;\r\nif (comadj == -1 && machine_is_poodle())\r\ncomadj = 118;\r\nif (on)\r\nlocomolcd_on(comadj);\r\nelse\r\nlocomolcd_off(comadj);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int locomolcd_set_intensity(struct backlight_device *bd)\r\n{\r\nint intensity = bd->props.brightness;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.fb_blank != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (locomolcd_flags & LOCOMOLCD_SUSPENDED)\r\nintensity = 0;\r\nswitch (intensity) {\r\ncase 0: locomo_frontlight_set(locomolcd_dev, 0, 0, 161); break;\r\ncase 1: locomo_frontlight_set(locomolcd_dev, 117, 0, 161); break;\r\ncase 2: locomo_frontlight_set(locomolcd_dev, 163, 0, 148); break;\r\ncase 3: locomo_frontlight_set(locomolcd_dev, 194, 0, 161); break;\r\ncase 4: locomo_frontlight_set(locomolcd_dev, 194, 1, 161); break;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\ncurrent_intensity = intensity;\r\nreturn 0;\r\n}\r\nstatic int locomolcd_get_intensity(struct backlight_device *bd)\r\n{\r\nreturn current_intensity;\r\n}\r\nstatic int locomolcd_suspend(struct locomo_dev *dev, pm_message_t state)\r\n{\r\nlocomolcd_flags |= LOCOMOLCD_SUSPENDED;\r\nlocomolcd_set_intensity(locomolcd_bl_device);\r\nreturn 0;\r\n}\r\nstatic int locomolcd_resume(struct locomo_dev *dev)\r\n{\r\nlocomolcd_flags &= ~LOCOMOLCD_SUSPENDED;\r\nlocomolcd_set_intensity(locomolcd_bl_device);\r\nreturn 0;\r\n}\r\nstatic int locomolcd_probe(struct locomo_dev *ldev)\r\n{\r\nstruct backlight_properties props;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\nlocomolcd_dev = ldev;\r\nlocomo_gpio_set_dir(ldev->dev.parent, LOCOMO_GPIO_FL_VR, 0);\r\nif (machine_is_poodle())\r\nlocomolcd_power(1);\r\nlocal_irq_restore(flags);\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = 4;\r\nlocomolcd_bl_device = backlight_device_register("locomo-bl",\r\n&ldev->dev, NULL,\r\n&locomobl_data, &props);\r\nif (IS_ERR (locomolcd_bl_device))\r\nreturn PTR_ERR (locomolcd_bl_device);\r\nlocomolcd_bl_device->props.brightness = 2;\r\nlocomolcd_set_intensity(locomolcd_bl_device);\r\nreturn 0;\r\n}\r\nstatic int locomolcd_remove(struct locomo_dev *dev)\r\n{\r\nunsigned long flags;\r\nlocomolcd_bl_device->props.brightness = 0;\r\nlocomolcd_bl_device->props.power = 0;\r\nlocomolcd_set_intensity(locomolcd_bl_device);\r\nbacklight_device_unregister(locomolcd_bl_device);\r\nlocal_irq_save(flags);\r\nlocomolcd_dev = NULL;\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int __init locomolcd_init(void)\r\n{\r\nreturn locomo_driver_register(&poodle_lcd_driver);\r\n}\r\nstatic void __exit locomolcd_exit(void)\r\n{\r\nlocomo_driver_unregister(&poodle_lcd_driver);\r\n}

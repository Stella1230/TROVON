void\r\nxfs_dir2_data_check(\r\nstruct xfs_inode *dp,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_dir2_dataptr_t addr;\r\nxfs_dir2_data_free_t *bf;\r\nxfs_dir2_block_tail_t *btp=NULL;\r\nint count;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_free_t *dfp;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *endp;\r\nint freeseen;\r\nxfs_dahash_t hash;\r\nint i;\r\nint lastfree;\r\nxfs_dir2_leaf_entry_t *lep=NULL;\r\nxfs_mount_t *mp;\r\nchar *p;\r\nint stale;\r\nstruct xfs_name name;\r\nmp = dp->i_mount;\r\nhdr = bp->b_addr;\r\nbf = hdr->bestfree;\r\np = (char *)(hdr + 1);\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC)) {\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nlep = xfs_dir2_block_leaf_p(btp);\r\nendp = (char *)lep;\r\n} else {\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC));\r\nendp = (char *)hdr + mp->m_dirblksize;\r\n}\r\ncount = lastfree = freeseen = 0;\r\nif (!bf[0].length) {\r\nASSERT(!bf[0].offset);\r\nfreeseen |= 1 << 0;\r\n}\r\nif (!bf[1].length) {\r\nASSERT(!bf[1].offset);\r\nfreeseen |= 1 << 1;\r\n}\r\nif (!bf[2].length) {\r\nASSERT(!bf[2].offset);\r\nfreeseen |= 1 << 2;\r\n}\r\nASSERT(be16_to_cpu(bf[0].length) >= be16_to_cpu(bf[1].length));\r\nASSERT(be16_to_cpu(bf[1].length) >= be16_to_cpu(bf[2].length));\r\nwhile (p < endp) {\r\ndup = (xfs_dir2_data_unused_t *)p;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nASSERT(lastfree == 0);\r\nASSERT(be16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)) ==\r\n(char *)dup - (char *)hdr);\r\ndfp = xfs_dir2_data_freefind(hdr, dup);\r\nif (dfp) {\r\ni = (int)(dfp - bf);\r\nASSERT((freeseen & (1 << i)) == 0);\r\nfreeseen |= 1 << i;\r\n} else {\r\nASSERT(be16_to_cpu(dup->length) <=\r\nbe16_to_cpu(bf[2].length));\r\n}\r\np += be16_to_cpu(dup->length);\r\nlastfree = 1;\r\ncontinue;\r\n}\r\ndep = (xfs_dir2_data_entry_t *)p;\r\nASSERT(dep->namelen != 0);\r\nASSERT(xfs_dir_ino_validate(mp, be64_to_cpu(dep->inumber)) == 0);\r\nASSERT(be16_to_cpu(*xfs_dir2_data_entry_tag_p(dep)) ==\r\n(char *)dep - (char *)hdr);\r\ncount++;\r\nlastfree = 0;\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC)) {\r\naddr = xfs_dir2_db_off_to_dataptr(mp, mp->m_dirdatablk,\r\n(xfs_dir2_data_aoff_t)\r\n((char *)dep - (char *)hdr));\r\nname.name = dep->name;\r\nname.len = dep->namelen;\r\nhash = mp->m_dirnameops->hashname(&name);\r\nfor (i = 0; i < be32_to_cpu(btp->count); i++) {\r\nif (be32_to_cpu(lep[i].address) == addr &&\r\nbe32_to_cpu(lep[i].hashval) == hash)\r\nbreak;\r\n}\r\nASSERT(i < be32_to_cpu(btp->count));\r\n}\r\np += xfs_dir2_data_entsize(dep->namelen);\r\n}\r\nASSERT(freeseen == 7);\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC)) {\r\nfor (i = stale = 0; i < be32_to_cpu(btp->count); i++) {\r\nif (lep[i].address ==\r\ncpu_to_be32(XFS_DIR2_NULL_DATAPTR))\r\nstale++;\r\nif (i > 0)\r\nASSERT(be32_to_cpu(lep[i].hashval) >= be32_to_cpu(lep[i - 1].hashval));\r\n}\r\nASSERT(count == be32_to_cpu(btp->count) - be32_to_cpu(btp->stale));\r\nASSERT(stale == be32_to_cpu(btp->stale));\r\n}\r\n}\r\nSTATIC xfs_dir2_data_free_t *\r\nxfs_dir2_data_freefind(\r\nxfs_dir2_data_hdr_t *hdr,\r\nxfs_dir2_data_unused_t *dup)\r\n{\r\nxfs_dir2_data_free_t *dfp;\r\nxfs_dir2_data_aoff_t off;\r\n#if defined(DEBUG) && defined(__KERNEL__)\r\nint matched;\r\nint seenzero;\r\n#endif\r\noff = (xfs_dir2_data_aoff_t)((char *)dup - (char *)hdr);\r\n#if defined(DEBUG) && defined(__KERNEL__)\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\nfor (dfp = &hdr->bestfree[0], seenzero = matched = 0;\r\ndfp < &hdr->bestfree[XFS_DIR2_DATA_FD_COUNT];\r\ndfp++) {\r\nif (!dfp->offset) {\r\nASSERT(!dfp->length);\r\nseenzero = 1;\r\ncontinue;\r\n}\r\nASSERT(seenzero == 0);\r\nif (be16_to_cpu(dfp->offset) == off) {\r\nmatched = 1;\r\nASSERT(dfp->length == dup->length);\r\n} else if (off < be16_to_cpu(dfp->offset))\r\nASSERT(off + be16_to_cpu(dup->length) <= be16_to_cpu(dfp->offset));\r\nelse\r\nASSERT(be16_to_cpu(dfp->offset) + be16_to_cpu(dfp->length) <= off);\r\nASSERT(matched || be16_to_cpu(dfp->length) >= be16_to_cpu(dup->length));\r\nif (dfp > &hdr->bestfree[0])\r\nASSERT(be16_to_cpu(dfp[-1].length) >= be16_to_cpu(dfp[0].length));\r\n}\r\n#endif\r\nif (be16_to_cpu(dup->length) <\r\nbe16_to_cpu(hdr->bestfree[XFS_DIR2_DATA_FD_COUNT - 1].length))\r\nreturn NULL;\r\nfor (dfp = &hdr->bestfree[0];\r\ndfp < &hdr->bestfree[XFS_DIR2_DATA_FD_COUNT];\r\ndfp++) {\r\nif (!dfp->offset)\r\nreturn NULL;\r\nif (be16_to_cpu(dfp->offset) == off)\r\nreturn dfp;\r\n}\r\nreturn NULL;\r\n}\r\nxfs_dir2_data_free_t *\r\nxfs_dir2_data_freeinsert(\r\nxfs_dir2_data_hdr_t *hdr,\r\nxfs_dir2_data_unused_t *dup,\r\nint *loghead)\r\n{\r\nxfs_dir2_data_free_t *dfp;\r\nxfs_dir2_data_free_t new;\r\n#ifdef __KERNEL__\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\n#endif\r\ndfp = hdr->bestfree;\r\nnew.length = dup->length;\r\nnew.offset = cpu_to_be16((char *)dup - (char *)hdr);\r\nif (be16_to_cpu(new.length) > be16_to_cpu(dfp[0].length)) {\r\ndfp[2] = dfp[1];\r\ndfp[1] = dfp[0];\r\ndfp[0] = new;\r\n*loghead = 1;\r\nreturn &dfp[0];\r\n}\r\nif (be16_to_cpu(new.length) > be16_to_cpu(dfp[1].length)) {\r\ndfp[2] = dfp[1];\r\ndfp[1] = new;\r\n*loghead = 1;\r\nreturn &dfp[1];\r\n}\r\nif (be16_to_cpu(new.length) > be16_to_cpu(dfp[2].length)) {\r\ndfp[2] = new;\r\n*loghead = 1;\r\nreturn &dfp[2];\r\n}\r\nreturn NULL;\r\n}\r\nSTATIC void\r\nxfs_dir2_data_freeremove(\r\nxfs_dir2_data_hdr_t *hdr,\r\nxfs_dir2_data_free_t *dfp,\r\nint *loghead)\r\n{\r\n#ifdef __KERNEL__\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\n#endif\r\nif (dfp == &hdr->bestfree[0]) {\r\nhdr->bestfree[0] = hdr->bestfree[1];\r\nhdr->bestfree[1] = hdr->bestfree[2];\r\n}\r\nelse if (dfp == &hdr->bestfree[1])\r\nhdr->bestfree[1] = hdr->bestfree[2];\r\nelse\r\nASSERT(dfp == &hdr->bestfree[2]);\r\nhdr->bestfree[2].length = 0;\r\nhdr->bestfree[2].offset = 0;\r\n*loghead = 1;\r\n}\r\nvoid\r\nxfs_dir2_data_freescan(\r\nxfs_mount_t *mp,\r\nxfs_dir2_data_hdr_t *hdr,\r\nint *loghead)\r\n{\r\nxfs_dir2_block_tail_t *btp;\r\nxfs_dir2_data_entry_t *dep;\r\nxfs_dir2_data_unused_t *dup;\r\nchar *endp;\r\nchar *p;\r\n#ifdef __KERNEL__\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\n#endif\r\nmemset(hdr->bestfree, 0, sizeof(hdr->bestfree));\r\n*loghead = 1;\r\np = (char *)(hdr + 1);\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC)) {\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nendp = (char *)xfs_dir2_block_leaf_p(btp);\r\n} else\r\nendp = (char *)hdr + mp->m_dirblksize;\r\nwhile (p < endp) {\r\ndup = (xfs_dir2_data_unused_t *)p;\r\nif (be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG) {\r\nASSERT((char *)dup - (char *)hdr ==\r\nbe16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)));\r\nxfs_dir2_data_freeinsert(hdr, dup, loghead);\r\np += be16_to_cpu(dup->length);\r\n}\r\nelse {\r\ndep = (xfs_dir2_data_entry_t *)p;\r\nASSERT((char *)dep - (char *)hdr ==\r\nbe16_to_cpu(*xfs_dir2_data_entry_tag_p(dep)));\r\np += xfs_dir2_data_entsize(dep->namelen);\r\n}\r\n}\r\n}\r\nint\r\nxfs_dir2_data_init(\r\nxfs_da_args_t *args,\r\nxfs_dir2_db_t blkno,\r\nstruct xfs_buf **bpp)\r\n{\r\nstruct xfs_buf *bp;\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_inode_t *dp;\r\nxfs_dir2_data_unused_t *dup;\r\nint error;\r\nint i;\r\nxfs_mount_t *mp;\r\nxfs_trans_t *tp;\r\nint t;\r\ndp = args->dp;\r\nmp = dp->i_mount;\r\ntp = args->trans;\r\nerror = xfs_da_get_buf(tp, dp, xfs_dir2_db_to_da(mp, blkno), -1, &bp,\r\nXFS_DATA_FORK);\r\nif (error) {\r\nreturn error;\r\n}\r\nASSERT(bp != NULL);\r\nhdr = bp->b_addr;\r\nhdr->magic = cpu_to_be32(XFS_DIR2_DATA_MAGIC);\r\nhdr->bestfree[0].offset = cpu_to_be16(sizeof(*hdr));\r\nfor (i = 1; i < XFS_DIR2_DATA_FD_COUNT; i++) {\r\nhdr->bestfree[i].length = 0;\r\nhdr->bestfree[i].offset = 0;\r\n}\r\ndup = (xfs_dir2_data_unused_t *)(hdr + 1);\r\ndup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nt = mp->m_dirblksize - (uint)sizeof(*hdr);\r\nhdr->bestfree[0].length = cpu_to_be16(t);\r\ndup->length = cpu_to_be16(t);\r\n*xfs_dir2_data_unused_tag_p(dup) = cpu_to_be16((char *)dup - (char *)hdr);\r\nxfs_dir2_data_log_header(tp, bp);\r\nxfs_dir2_data_log_unused(tp, bp, dup);\r\n*bpp = bp;\r\nreturn 0;\r\n}\r\nvoid\r\nxfs_dir2_data_log_entry(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_entry_t *dep)\r\n{\r\nxfs_dir2_data_hdr_t *hdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)dep - (char *)hdr),\r\n(uint)((char *)(xfs_dir2_data_entry_tag_p(dep) + 1) -\r\n(char *)hdr - 1));\r\n}\r\nvoid\r\nxfs_dir2_data_log_header(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\nxfs_trans_log_buf(tp, bp, 0, sizeof(*hdr) - 1);\r\n}\r\nvoid\r\nxfs_dir2_data_log_unused(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_unused_t *dup)\r\n{\r\nxfs_dir2_data_hdr_t *hdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\nxfs_trans_log_buf(tp, bp, (uint)((char *)dup - (char *)hdr),\r\n(uint)((char *)&dup->length + sizeof(dup->length) -\r\n1 - (char *)hdr));\r\nxfs_trans_log_buf(tp, bp,\r\n(uint)((char *)xfs_dir2_data_unused_tag_p(dup) - (char *)hdr),\r\n(uint)((char *)xfs_dir2_data_unused_tag_p(dup) - (char *)hdr +\r\nsizeof(xfs_dir2_data_off_t) - 1));\r\n}\r\nvoid\r\nxfs_dir2_data_make_free(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_aoff_t offset,\r\nxfs_dir2_data_aoff_t len,\r\nint *needlogp,\r\nint *needscanp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_free_t *dfp;\r\nchar *endptr;\r\nxfs_mount_t *mp;\r\nint needscan;\r\nxfs_dir2_data_unused_t *newdup;\r\nxfs_dir2_data_unused_t *postdup;\r\nxfs_dir2_data_unused_t *prevdup;\r\nmp = tp->t_mountp;\r\nhdr = bp->b_addr;\r\nif (hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC))\r\nendptr = (char *)hdr + mp->m_dirblksize;\r\nelse {\r\nxfs_dir2_block_tail_t *btp;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\nbtp = xfs_dir2_block_tail_p(mp, hdr);\r\nendptr = (char *)xfs_dir2_block_leaf_p(btp);\r\n}\r\nif (offset > sizeof(*hdr)) {\r\n__be16 *tagp;\r\ntagp = (__be16 *)((char *)hdr + offset) - 1;\r\nprevdup = (xfs_dir2_data_unused_t *)((char *)hdr + be16_to_cpu(*tagp));\r\nif (be16_to_cpu(prevdup->freetag) != XFS_DIR2_DATA_FREE_TAG)\r\nprevdup = NULL;\r\n} else\r\nprevdup = NULL;\r\nif ((char *)hdr + offset + len < endptr) {\r\npostdup =\r\n(xfs_dir2_data_unused_t *)((char *)hdr + offset + len);\r\nif (be16_to_cpu(postdup->freetag) != XFS_DIR2_DATA_FREE_TAG)\r\npostdup = NULL;\r\n} else\r\npostdup = NULL;\r\nASSERT(*needscanp == 0);\r\nneedscan = 0;\r\nif (prevdup && postdup) {\r\nxfs_dir2_data_free_t *dfp2;\r\ndfp = xfs_dir2_data_freefind(hdr, prevdup);\r\ndfp2 = xfs_dir2_data_freefind(hdr, postdup);\r\nneedscan = (hdr->bestfree[2].length != 0);\r\nbe16_add_cpu(&prevdup->length, len + be16_to_cpu(postdup->length));\r\n*xfs_dir2_data_unused_tag_p(prevdup) =\r\ncpu_to_be16((char *)prevdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, prevdup);\r\nif (!needscan) {\r\nASSERT(dfp && dfp2);\r\nif (dfp == &hdr->bestfree[1]) {\r\ndfp = &hdr->bestfree[0];\r\nASSERT(dfp2 == dfp);\r\ndfp2 = &hdr->bestfree[1];\r\n}\r\nxfs_dir2_data_freeremove(hdr, dfp2, needlogp);\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\ndfp = xfs_dir2_data_freeinsert(hdr, prevdup, needlogp);\r\nASSERT(dfp == &hdr->bestfree[0]);\r\nASSERT(dfp->length == prevdup->length);\r\nASSERT(!dfp[1].length);\r\nASSERT(!dfp[2].length);\r\n}\r\n}\r\nelse if (prevdup) {\r\ndfp = xfs_dir2_data_freefind(hdr, prevdup);\r\nbe16_add_cpu(&prevdup->length, len);\r\n*xfs_dir2_data_unused_tag_p(prevdup) =\r\ncpu_to_be16((char *)prevdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, prevdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\nxfs_dir2_data_freeinsert(hdr, prevdup, needlogp);\r\n}\r\nelse {\r\nneedscan = be16_to_cpu(prevdup->length) >\r\nbe16_to_cpu(hdr->bestfree[2].length);\r\n}\r\n}\r\nelse if (postdup) {\r\ndfp = xfs_dir2_data_freefind(hdr, postdup);\r\nnewdup = (xfs_dir2_data_unused_t *)((char *)hdr + offset);\r\nnewdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup->length = cpu_to_be16(len + be16_to_cpu(postdup->length));\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, newdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\nxfs_dir2_data_freeinsert(hdr, newdup, needlogp);\r\n}\r\nelse {\r\nneedscan = be16_to_cpu(newdup->length) >\r\nbe16_to_cpu(hdr->bestfree[2].length);\r\n}\r\n}\r\nelse {\r\nnewdup = (xfs_dir2_data_unused_t *)((char *)hdr + offset);\r\nnewdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup->length = cpu_to_be16(len);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, newdup);\r\nxfs_dir2_data_freeinsert(hdr, newdup, needlogp);\r\n}\r\n*needscanp = needscan;\r\n}\r\nvoid\r\nxfs_dir2_data_use_free(\r\nstruct xfs_trans *tp,\r\nstruct xfs_buf *bp,\r\nxfs_dir2_data_unused_t *dup,\r\nxfs_dir2_data_aoff_t offset,\r\nxfs_dir2_data_aoff_t len,\r\nint *needlogp,\r\nint *needscanp)\r\n{\r\nxfs_dir2_data_hdr_t *hdr;\r\nxfs_dir2_data_free_t *dfp;\r\nint matchback;\r\nint matchfront;\r\nint needscan;\r\nxfs_dir2_data_unused_t *newdup;\r\nxfs_dir2_data_unused_t *newdup2;\r\nint oldlen;\r\nhdr = bp->b_addr;\r\nASSERT(hdr->magic == cpu_to_be32(XFS_DIR2_DATA_MAGIC) ||\r\nhdr->magic == cpu_to_be32(XFS_DIR2_BLOCK_MAGIC));\r\nASSERT(be16_to_cpu(dup->freetag) == XFS_DIR2_DATA_FREE_TAG);\r\nASSERT(offset >= (char *)dup - (char *)hdr);\r\nASSERT(offset + len <= (char *)dup + be16_to_cpu(dup->length) - (char *)hdr);\r\nASSERT((char *)dup - (char *)hdr == be16_to_cpu(*xfs_dir2_data_unused_tag_p(dup)));\r\ndfp = xfs_dir2_data_freefind(hdr, dup);\r\noldlen = be16_to_cpu(dup->length);\r\nASSERT(dfp || oldlen <= be16_to_cpu(hdr->bestfree[2].length));\r\nmatchfront = (char *)dup - (char *)hdr == offset;\r\nmatchback = (char *)dup + oldlen - (char *)hdr == offset + len;\r\nASSERT(*needscanp == 0);\r\nneedscan = 0;\r\nif (matchfront && matchback) {\r\nif (dfp) {\r\nneedscan = (hdr->bestfree[2].offset != 0);\r\nif (!needscan)\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\n}\r\n}\r\nelse if (matchfront) {\r\nnewdup = (xfs_dir2_data_unused_t *)((char *)hdr + offset + len);\r\nnewdup->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup->length = cpu_to_be16(oldlen - len);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, newdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\ndfp = xfs_dir2_data_freeinsert(hdr, newdup, needlogp);\r\nASSERT(dfp != NULL);\r\nASSERT(dfp->length == newdup->length);\r\nASSERT(be16_to_cpu(dfp->offset) == (char *)newdup - (char *)hdr);\r\nneedscan = dfp == &hdr->bestfree[2];\r\n}\r\n}\r\nelse if (matchback) {\r\nnewdup = dup;\r\nnewdup->length = cpu_to_be16(((char *)hdr + offset) - (char *)newdup);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, newdup);\r\nif (dfp) {\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\ndfp = xfs_dir2_data_freeinsert(hdr, newdup, needlogp);\r\nASSERT(dfp != NULL);\r\nASSERT(dfp->length == newdup->length);\r\nASSERT(be16_to_cpu(dfp->offset) == (char *)newdup - (char *)hdr);\r\nneedscan = dfp == &hdr->bestfree[2];\r\n}\r\n}\r\nelse {\r\nnewdup = dup;\r\nnewdup->length = cpu_to_be16(((char *)hdr + offset) - (char *)newdup);\r\n*xfs_dir2_data_unused_tag_p(newdup) =\r\ncpu_to_be16((char *)newdup - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, newdup);\r\nnewdup2 = (xfs_dir2_data_unused_t *)((char *)hdr + offset + len);\r\nnewdup2->freetag = cpu_to_be16(XFS_DIR2_DATA_FREE_TAG);\r\nnewdup2->length = cpu_to_be16(oldlen - len - be16_to_cpu(newdup->length));\r\n*xfs_dir2_data_unused_tag_p(newdup2) =\r\ncpu_to_be16((char *)newdup2 - (char *)hdr);\r\nxfs_dir2_data_log_unused(tp, bp, newdup2);\r\nif (dfp) {\r\nneedscan = (hdr->bestfree[2].length != 0);\r\nif (!needscan) {\r\nxfs_dir2_data_freeremove(hdr, dfp, needlogp);\r\nxfs_dir2_data_freeinsert(hdr, newdup, needlogp);\r\nxfs_dir2_data_freeinsert(hdr, newdup2,\r\nneedlogp);\r\n}\r\n}\r\n}\r\n*needscanp = needscan;\r\n}

void cvmx_helper_qlm_jtag_init(void)\r\n{\r\nunion cvmx_ciu_qlm_jtgc jtgc;\r\nuint32_t clock_div = 0;\r\nuint32_t divisor = cvmx_sysinfo_get()->cpu_clock_hz / (25 * 1000000);\r\ndivisor = (divisor - 1) >> 2;\r\nwhile (divisor) {\r\nclock_div++;\r\ndivisor = divisor >> 1;\r\n}\r\njtgc.u64 = 0;\r\njtgc.s.clk_div = clock_div;\r\njtgc.s.mux_sel = 0;\r\nif (OCTEON_IS_MODEL(OCTEON_CN52XX))\r\njtgc.s.bypass = 0x3;\r\nelse\r\njtgc.s.bypass = 0xf;\r\ncvmx_write_csr(CVMX_CIU_QLM_JTGC, jtgc.u64);\r\ncvmx_read_csr(CVMX_CIU_QLM_JTGC);\r\n}\r\nuint32_t cvmx_helper_qlm_jtag_shift(int qlm, int bits, uint32_t data)\r\n{\r\nunion cvmx_ciu_qlm_jtgd jtgd;\r\njtgd.u64 = 0;\r\njtgd.s.shift = 1;\r\njtgd.s.shft_cnt = bits - 1;\r\njtgd.s.shft_reg = data;\r\nif (!OCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_X))\r\njtgd.s.select = 1 << qlm;\r\ncvmx_write_csr(CVMX_CIU_QLM_JTGD, jtgd.u64);\r\ndo {\r\njtgd.u64 = cvmx_read_csr(CVMX_CIU_QLM_JTGD);\r\n} while (jtgd.s.shift);\r\nreturn jtgd.s.shft_reg >> (32 - bits);\r\n}\r\nvoid cvmx_helper_qlm_jtag_shift_zeros(int qlm, int bits)\r\n{\r\nwhile (bits > 0) {\r\nint n = bits;\r\nif (n > 32)\r\nn = 32;\r\ncvmx_helper_qlm_jtag_shift(qlm, n, 0);\r\nbits -= n;\r\n}\r\n}\r\nvoid cvmx_helper_qlm_jtag_update(int qlm)\r\n{\r\nunion cvmx_ciu_qlm_jtgd jtgd;\r\njtgd.u64 = 0;\r\njtgd.s.update = 1;\r\nif (!OCTEON_IS_MODEL(OCTEON_CN56XX_PASS1_X))\r\njtgd.s.select = 1 << qlm;\r\ncvmx_write_csr(CVMX_CIU_QLM_JTGD, jtgd.u64);\r\ndo {\r\njtgd.u64 = cvmx_read_csr(CVMX_CIU_QLM_JTGD);\r\n} while (jtgd.s.update);\r\n}

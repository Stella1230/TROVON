static\r\nint stv0367_writeregs(struct stv0367_state *state, u16 reg, u8 *data, int len)\r\n{\r\nu8 buf[len + 2];\r\nstruct i2c_msg msg = {\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = len + 2\r\n};\r\nint ret;\r\nbuf[0] = MSB(reg);\r\nbuf[1] = LSB(reg);\r\nmemcpy(buf + 2, data, len);\r\nif (i2cdebug)\r\nprintk(KERN_DEBUG "%s: %02x: %02x\n", __func__, reg, buf[2]);\r\nret = i2c_transfer(state->i2c, &msg, 1);\r\nif (ret != 1)\r\nprintk(KERN_ERR "%s: i2c write error!\n", __func__);\r\nreturn (ret != 1) ? -EREMOTEIO : 0;\r\n}\r\nstatic int stv0367_writereg(struct stv0367_state *state, u16 reg, u8 data)\r\n{\r\nreturn stv0367_writeregs(state, reg, &data, 1);\r\n}\r\nstatic u8 stv0367_readreg(struct stv0367_state *state, u16 reg)\r\n{\r\nu8 b0[] = { 0, 0 };\r\nu8 b1[] = { 0 };\r\nstruct i2c_msg msg[] = {\r\n{\r\n.addr = state->config->demod_address,\r\n.flags = 0,\r\n.buf = b0,\r\n.len = 2\r\n}, {\r\n.addr = state->config->demod_address,\r\n.flags = I2C_M_RD,\r\n.buf = b1,\r\n.len = 1\r\n}\r\n};\r\nint ret;\r\nb0[0] = MSB(reg);\r\nb0[1] = LSB(reg);\r\nret = i2c_transfer(state->i2c, msg, 2);\r\nif (ret != 2)\r\nprintk(KERN_ERR "%s: i2c read error\n", __func__);\r\nif (i2cdebug)\r\nprintk(KERN_DEBUG "%s: %02x: %02x\n", __func__, reg, b1[0]);\r\nreturn b1[0];\r\n}\r\nstatic void extract_mask_pos(u32 label, u8 *mask, u8 *pos)\r\n{\r\nu8 position = 0, i = 0;\r\n(*mask) = label & 0xff;\r\nwhile ((position == 0) && (i < 8)) {\r\nposition = ((*mask) >> i) & 0x01;\r\ni++;\r\n}\r\n(*pos) = (i - 1);\r\n}\r\nstatic void stv0367_writebits(struct stv0367_state *state, u32 label, u8 val)\r\n{\r\nu8 reg, mask, pos;\r\nreg = stv0367_readreg(state, (label >> 16) & 0xffff);\r\nextract_mask_pos(label, &mask, &pos);\r\nval = mask & (val << pos);\r\nreg = (reg & (~mask)) | val;\r\nstv0367_writereg(state, (label >> 16) & 0xffff, reg);\r\n}\r\nstatic void stv0367_setbits(u8 *reg, u32 label, u8 val)\r\n{\r\nu8 mask, pos;\r\nextract_mask_pos(label, &mask, &pos);\r\nval = mask & (val << pos);\r\n(*reg) = ((*reg) & (~mask)) | val;\r\n}\r\nstatic u8 stv0367_readbits(struct stv0367_state *state, u32 label)\r\n{\r\nu8 val = 0xff;\r\nu8 mask, pos;\r\nextract_mask_pos(label, &mask, &pos);\r\nval = stv0367_readreg(state, label >> 16);\r\nval = (val & mask) >> pos;\r\nreturn val;\r\n}\r\nu8 stv0367_getbits(u8 reg, u32 label)\r\n{\r\nu8 mask, pos;\r\nextract_mask_pos(label, &mask, &pos);\r\nreturn (reg & mask) >> pos;\r\n}\r\nstatic int stv0367ter_gate_ctrl(struct dvb_frontend *fe, int enable)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nu8 tmp = stv0367_readreg(state, R367TER_I2CRPT);\r\ndprintk("%s:\n", __func__);\r\nif (enable) {\r\nstv0367_setbits(&tmp, F367TER_STOP_ENABLE, 0);\r\nstv0367_setbits(&tmp, F367TER_I2CT_ON, 1);\r\n} else {\r\nstv0367_setbits(&tmp, F367TER_STOP_ENABLE, 1);\r\nstv0367_setbits(&tmp, F367TER_I2CT_ON, 0);\r\n}\r\nstv0367_writereg(state, R367TER_I2CRPT, tmp);\r\nreturn 0;\r\n}\r\nstatic u32 stv0367_get_tuner_freq(struct dvb_frontend *fe)\r\n{\r\nstruct dvb_frontend_ops *frontend_ops = NULL;\r\nstruct dvb_tuner_ops *tuner_ops = NULL;\r\nu32 freq = 0;\r\nint err = 0;\r\ndprintk("%s:\n", __func__);\r\nif (&fe->ops)\r\nfrontend_ops = &fe->ops;\r\nif (&frontend_ops->tuner_ops)\r\ntuner_ops = &frontend_ops->tuner_ops;\r\nif (tuner_ops->get_frequency) {\r\nerr = tuner_ops->get_frequency(fe, &freq);\r\nif (err < 0) {\r\nprintk(KERN_ERR "%s: Invalid parameter\n", __func__);\r\nreturn err;\r\n}\r\ndprintk("%s: frequency=%d\n", __func__, freq);\r\n} else\r\nreturn -1;\r\nreturn freq;\r\n}\r\nstatic u32 stv0367ter_get_mclk(struct stv0367_state *state, u32 ExtClk_Hz)\r\n{\r\nu32 mclk_Hz = 0;\r\nu32 m, n, p;\r\ndprintk("%s:\n", __func__);\r\nif (stv0367_readbits(state, F367TER_BYPASS_PLLXN) == 0) {\r\nn = (u32)stv0367_readbits(state, F367TER_PLL_NDIV);\r\nif (n == 0)\r\nn = n + 1;\r\nm = (u32)stv0367_readbits(state, F367TER_PLL_MDIV);\r\nif (m == 0)\r\nm = m + 1;\r\np = (u32)stv0367_readbits(state, F367TER_PLL_PDIV);\r\nif (p > 5)\r\np = 5;\r\nmclk_Hz = ((ExtClk_Hz / 2) * n) / (m * (1 << p));\r\ndprintk("N=%d M=%d P=%d mclk_Hz=%d ExtClk_Hz=%d\n",\r\nn, m, p, mclk_Hz, ExtClk_Hz);\r\n} else\r\nmclk_Hz = ExtClk_Hz;\r\ndprintk("%s: mclk_Hz=%d\n", __func__, mclk_Hz);\r\nreturn mclk_Hz;\r\n}\r\nstatic int stv0367ter_filt_coeff_init(struct stv0367_state *state,\r\nu16 CellsCoeffs[3][6][5], u32 DemodXtal)\r\n{\r\nint i, j, k, freq;\r\ndprintk("%s:\n", __func__);\r\nfreq = stv0367ter_get_mclk(state, DemodXtal);\r\nif (freq == 53125000)\r\nk = 1;\r\nelse if (freq == 54000000)\r\nk = 0;\r\nelse if (freq == 52500000)\r\nk = 2;\r\nelse\r\nreturn 0;\r\nfor (i = 1; i <= 6; i++) {\r\nstv0367_writebits(state, F367TER_IIR_CELL_NB, i - 1);\r\nfor (j = 1; j <= 5; j++) {\r\nstv0367_writereg(state,\r\n(R367TER_IIRCX_COEFF1_MSB + 2 * (j - 1)),\r\nMSB(CellsCoeffs[k][i-1][j-1]));\r\nstv0367_writereg(state,\r\n(R367TER_IIRCX_COEFF1_LSB + 2 * (j - 1)),\r\nLSB(CellsCoeffs[k][i-1][j-1]));\r\n}\r\n}\r\nreturn 1;\r\n}\r\nstatic void stv0367ter_agc_iir_lock_detect_set(struct stv0367_state *state)\r\n{\r\ndprintk("%s:\n", __func__);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_LSB, 0x00);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_CHOICE, 0x00);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_MSB, 0x06);\r\nstv0367_writebits(state, F367TER_AUT_AGC_TARGET_LSB, 0x04);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_CHOICE, 0x01);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_MSB, 0x06);\r\nstv0367_writebits(state, F367TER_AUT_AGC_TARGET_LSB, 0x04);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_CHOICE, 0x02);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_MSB, 0x01);\r\nstv0367_writebits(state, F367TER_AUT_AGC_TARGET_LSB, 0x00);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_CHOICE, 0x03);\r\nstv0367_writebits(state, F367TER_LOCK_DETECT_MSB, 0x01);\r\nstv0367_writebits(state, F367TER_AUT_AGC_TARGET_LSB, 0x00);\r\n}\r\nstatic int stv0367_iir_filt_init(struct stv0367_state *state, u8 Bandwidth,\r\nu32 DemodXtalValue)\r\n{\r\ndprintk("%s:\n", __func__);\r\nstv0367_writebits(state, F367TER_NRST_IIR, 0);\r\nswitch (Bandwidth) {\r\ncase 6:\r\nif (!stv0367ter_filt_coeff_init(state,\r\nCellsCoeffs_6MHz_367cofdm,\r\nDemodXtalValue))\r\nreturn 0;\r\nbreak;\r\ncase 7:\r\nif (!stv0367ter_filt_coeff_init(state,\r\nCellsCoeffs_7MHz_367cofdm,\r\nDemodXtalValue))\r\nreturn 0;\r\nbreak;\r\ncase 8:\r\nif (!stv0367ter_filt_coeff_init(state,\r\nCellsCoeffs_8MHz_367cofdm,\r\nDemodXtalValue))\r\nreturn 0;\r\nbreak;\r\ndefault:\r\nreturn 0;\r\n}\r\nstv0367_writebits(state, F367TER_NRST_IIR, 1);\r\nreturn 1;\r\n}\r\nstatic void stv0367ter_agc_iir_rst(struct stv0367_state *state)\r\n{\r\nu8 com_n;\r\ndprintk("%s:\n", __func__);\r\ncom_n = stv0367_readbits(state, F367TER_COM_N);\r\nstv0367_writebits(state, F367TER_COM_N, 0x07);\r\nstv0367_writebits(state, F367TER_COM_SOFT_RSTN, 0x00);\r\nstv0367_writebits(state, F367TER_COM_AGC_ON, 0x00);\r\nstv0367_writebits(state, F367TER_COM_SOFT_RSTN, 0x01);\r\nstv0367_writebits(state, F367TER_COM_AGC_ON, 0x01);\r\nstv0367_writebits(state, F367TER_COM_N, com_n);\r\n}\r\nstatic int stv0367ter_duration(s32 mode, int tempo1, int tempo2, int tempo3)\r\n{\r\nint local_tempo = 0;\r\nswitch (mode) {\r\ncase 0:\r\nlocal_tempo = tempo1;\r\nbreak;\r\ncase 1:\r\nlocal_tempo = tempo2;\r\nbreak ;\r\ncase 2:\r\nlocal_tempo = tempo3;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn local_tempo;\r\n}\r\nstatic enum\r\nstv0367_ter_signal_type stv0367ter_check_syr(struct stv0367_state *state)\r\n{\r\nint wd = 100;\r\nunsigned short int SYR_var;\r\ns32 SYRStatus;\r\ndprintk("%s:\n", __func__);\r\nSYR_var = stv0367_readbits(state, F367TER_SYR_LOCK);\r\nwhile ((!SYR_var) && (wd > 0)) {\r\nusleep_range(2000, 3000);\r\nwd -= 2;\r\nSYR_var = stv0367_readbits(state, F367TER_SYR_LOCK);\r\n}\r\nif (!SYR_var)\r\nSYRStatus = FE_TER_NOSYMBOL;\r\nelse\r\nSYRStatus = FE_TER_SYMBOLOK;\r\ndprintk("stv0367ter_check_syr SYRStatus %s\n",\r\nSYR_var == 0 ? "No Symbol" : "OK");\r\nreturn SYRStatus;\r\n}\r\nstatic enum\r\nstv0367_ter_signal_type stv0367ter_check_cpamp(struct stv0367_state *state,\r\ns32 FFTmode)\r\n{\r\ns32 CPAMPvalue = 0, CPAMPStatus, CPAMPMin;\r\nint wd = 0;\r\ndprintk("%s:\n", __func__);\r\nswitch (FFTmode) {\r\ncase 0:\r\nCPAMPMin = 20;\r\nwd = 10;\r\nbreak;\r\ncase 1:\r\nCPAMPMin = 80;\r\nwd = 55;\r\nbreak;\r\ncase 2:\r\nCPAMPMin = 40;\r\nwd = 30;\r\nbreak;\r\ndefault:\r\nCPAMPMin = 0xffff;\r\nbreak;\r\n}\r\ndprintk("%s: CPAMPMin=%d wd=%d\n", __func__, CPAMPMin, wd);\r\nCPAMPvalue = stv0367_readbits(state, F367TER_PPM_CPAMP_DIRECT);\r\nwhile ((CPAMPvalue < CPAMPMin) && (wd > 0)) {\r\nusleep_range(1000, 2000);\r\nwd -= 1;\r\nCPAMPvalue = stv0367_readbits(state, F367TER_PPM_CPAMP_DIRECT);\r\n}\r\ndprintk("******last CPAMPvalue= %d at wd=%d\n", CPAMPvalue, wd);\r\nif (CPAMPvalue < CPAMPMin) {\r\nCPAMPStatus = FE_TER_NOCPAMP;\r\nprintk(KERN_ERR "CPAMP failed\n");\r\n} else {\r\nprintk(KERN_ERR "CPAMP OK !\n");\r\nCPAMPStatus = FE_TER_CPAMPOK;\r\n}\r\nreturn CPAMPStatus;\r\n}\r\nenum\r\nstv0367_ter_signal_type stv0367ter_lock_algo(struct stv0367_state *state)\r\n{\r\nenum stv0367_ter_signal_type ret_flag;\r\nshort int wd, tempo;\r\nu8 try, u_var1 = 0, u_var2 = 0, u_var3 = 0, u_var4 = 0, mode, guard;\r\nu8 tmp, tmp2;\r\ndprintk("%s:\n", __func__);\r\nif (state == NULL)\r\nreturn FE_TER_SWNOK;\r\ntry = 0;\r\ndo {\r\nret_flag = FE_TER_LOCKOK;\r\nstv0367_writebits(state, F367TER_CORE_ACTIVE, 0);\r\nif (state->config->if_iq_mode != 0)\r\nstv0367_writebits(state, F367TER_COM_N, 0x07);\r\nstv0367_writebits(state, F367TER_GUARD, 3);\r\nstv0367_writebits(state, F367TER_MODE, 0);\r\nstv0367_writebits(state, F367TER_SYR_TR_DIS, 0);\r\nusleep_range(5000, 10000);\r\nstv0367_writebits(state, F367TER_CORE_ACTIVE, 1);\r\nif (stv0367ter_check_syr(state) == FE_TER_NOSYMBOL)\r\nreturn FE_TER_NOSYMBOL;\r\nelse {\r\nmode = stv0367_readbits(state, F367TER_SYR_MODE);\r\nif (stv0367ter_check_cpamp(state, mode) ==\r\nFE_TER_NOCPAMP) {\r\nif (try == 0)\r\nret_flag = FE_TER_NOCPAMP;\r\n}\r\n}\r\ntry++;\r\n} while ((try < 10) && (ret_flag != FE_TER_LOCKOK));\r\ntmp = stv0367_readreg(state, R367TER_SYR_STAT);\r\ntmp2 = stv0367_readreg(state, R367TER_STATUS);\r\ndprintk("state=%p\n", state);\r\ndprintk("LOCK OK! mode=%d SYR_STAT=0x%x R367TER_STATUS=0x%x\n",\r\nmode, tmp, tmp2);\r\ntmp = stv0367_readreg(state, R367TER_PRVIT);\r\ntmp2 = stv0367_readreg(state, R367TER_I2CRPT);\r\ndprintk("PRVIT=0x%x I2CRPT=0x%x\n", tmp, tmp2);\r\ntmp = stv0367_readreg(state, R367TER_GAIN_SRC1);\r\ndprintk("GAIN_SRC1=0x%x\n", tmp);\r\nif ((mode != 0) && (mode != 1) && (mode != 2))\r\nreturn FE_TER_SWNOK;\r\n#if 0\r\nswitch (guard) {\r\ncase 0:\r\ncase 1:\r\nstv0367_writebits(state, F367TER_AUTO_LE_EN, 0);\r\nstv0367_writereg(state, R367TER_CHC_CTL, 0x01);\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nstv0367_writebits(state, F367TER_AUTO_LE_EN, 1);\r\nstv0367_writereg(state, R367TER_CHC_CTL, 0x11);\r\nbreak;\r\ndefault:\r\nreturn FE_TER_SWNOK;\r\n}\r\n#endif\r\nstv0367_writebits(state, F367TER_RST_SFEC, 1);\r\nstv0367_writebits(state, F367TER_RST_REEDSOLO, 1);\r\nusleep_range(1000, 2000);\r\nstv0367_writebits(state, F367TER_RST_SFEC, 0);\r\nstv0367_writebits(state, F367TER_RST_REEDSOLO, 0);\r\nu_var1 = stv0367_readbits(state, F367TER_LK);\r\nu_var2 = stv0367_readbits(state, F367TER_PRF);\r\nu_var3 = stv0367_readbits(state, F367TER_TPS_LOCK);\r\nwd = stv0367ter_duration(mode, 125, 500, 250);\r\ntempo = stv0367ter_duration(mode, 4, 16, 8);\r\nwhile (((!u_var1) || (!u_var2) || (!u_var3)) && (wd >= 0)) {\r\nusleep_range(1000 * tempo, 1000 * (tempo + 1));\r\nwd -= tempo;\r\nu_var1 = stv0367_readbits(state, F367TER_LK);\r\nu_var2 = stv0367_readbits(state, F367TER_PRF);\r\nu_var3 = stv0367_readbits(state, F367TER_TPS_LOCK);\r\n}\r\nif (!u_var1)\r\nreturn FE_TER_NOLOCK;\r\nif (!u_var2)\r\nreturn FE_TER_NOPRFOUND;\r\nif (!u_var3)\r\nreturn FE_TER_NOTPS;\r\nguard = stv0367_readbits(state, F367TER_SYR_GUARD);\r\nstv0367_writereg(state, R367TER_CHC_CTL, 0x11);\r\nswitch (guard) {\r\ncase 0:\r\ncase 1:\r\nstv0367_writebits(state, F367TER_AUTO_LE_EN, 0);\r\nstv0367_writebits(state, F367TER_SYR_FILTER, 0);\r\nbreak;\r\ncase 2:\r\ncase 3:\r\nstv0367_writebits(state, F367TER_AUTO_LE_EN, 1);\r\nstv0367_writebits(state, F367TER_SYR_FILTER, 1);\r\nbreak;\r\ndefault:\r\nreturn FE_TER_SWNOK;\r\n}\r\nif ((stv0367_readbits(state, F367TER_TPS_CONST) == 2) &&\r\n(mode == 1) &&\r\n(stv0367_readbits(state, F367TER_TPS_HPCODE) != 0)) {\r\nstv0367_writereg(state, R367TER_SFDLYSETH, 0xc0);\r\nstv0367_writereg(state, R367TER_SFDLYSETM, 0x60);\r\nstv0367_writereg(state, R367TER_SFDLYSETL, 0x0);\r\n} else\r\nstv0367_writereg(state, R367TER_SFDLYSETH, 0x0);\r\nwd = stv0367ter_duration(mode, 125, 500, 250);\r\nu_var4 = stv0367_readbits(state, F367TER_TSFIFO_LINEOK);\r\nwhile ((!u_var4) && (wd >= 0)) {\r\nusleep_range(1000 * tempo, 1000 * (tempo + 1));\r\nwd -= tempo;\r\nu_var4 = stv0367_readbits(state, F367TER_TSFIFO_LINEOK);\r\n}\r\nif (!u_var4)\r\nreturn FE_TER_NOLOCK;\r\nstv0367_writebits(state, F367TER_SYR_TR_DIS, 1);\r\ndprintk("FE_TER_LOCKOK !!!\n");\r\nreturn FE_TER_LOCKOK;\r\n}\r\nstatic void stv0367ter_set_ts_mode(struct stv0367_state *state,\r\nenum stv0367_ts_mode PathTS)\r\n{\r\ndprintk("%s:\n", __func__);\r\nif (state == NULL)\r\nreturn;\r\nstv0367_writebits(state, F367TER_TS_DIS, 0);\r\nswitch (PathTS) {\r\ndefault:\r\ncase STV0367_PARALLEL_PUNCT_CLOCK:\r\nstv0367_writebits(state, F367TER_TSFIFO_SERIAL, 0);\r\nstv0367_writebits(state, F367TER_TSFIFO_DVBCI, 0);\r\nbreak;\r\ncase STV0367_SERIAL_PUNCT_CLOCK:\r\nstv0367_writebits(state, F367TER_TSFIFO_SERIAL, 1);\r\nstv0367_writebits(state, F367TER_TSFIFO_DVBCI, 1);\r\nbreak;\r\n}\r\n}\r\nstatic void stv0367ter_set_clk_pol(struct stv0367_state *state,\r\nenum stv0367_clk_pol clock)\r\n{\r\ndprintk("%s:\n", __func__);\r\nif (state == NULL)\r\nreturn;\r\nswitch (clock) {\r\ncase STV0367_RISINGEDGE_CLOCK:\r\nstv0367_writebits(state, F367TER_TS_BYTE_CLK_INV, 1);\r\nbreak;\r\ncase STV0367_FALLINGEDGE_CLOCK:\r\nstv0367_writebits(state, F367TER_TS_BYTE_CLK_INV, 0);\r\nbreak;\r\ndefault:\r\nstv0367_writebits(state, F367TER_TS_BYTE_CLK_INV, 0);\r\nbreak;\r\n}\r\n}\r\nstatic int stv0367ter_standby(struct dvb_frontend *fe, u8 standby_on)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\ndprintk("%s:\n", __func__);\r\nif (standby_on) {\r\nstv0367_writebits(state, F367TER_STDBY, 1);\r\nstv0367_writebits(state, F367TER_STDBY_FEC, 1);\r\nstv0367_writebits(state, F367TER_STDBY_CORE, 1);\r\n} else {\r\nstv0367_writebits(state, F367TER_STDBY, 0);\r\nstv0367_writebits(state, F367TER_STDBY_FEC, 0);\r\nstv0367_writebits(state, F367TER_STDBY_CORE, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_sleep(struct dvb_frontend *fe)\r\n{\r\nreturn stv0367ter_standby(fe, 1);\r\n}\r\nint stv0367ter_init(struct dvb_frontend *fe)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367ter_state *ter_state = state->ter_state;\r\nint i;\r\ndprintk("%s:\n", __func__);\r\nter_state->pBER = 0;\r\nfor (i = 0; i < STV0367TER_NBREGS; i++)\r\nstv0367_writereg(state, def0367ter[i].addr,\r\ndef0367ter[i].value);\r\nswitch (state->config->xtal) {\r\ncase 25000000:\r\nstv0367_writereg(state, R367TER_PLLMDIV, 0xa);\r\nstv0367_writereg(state, R367TER_PLLNDIV, 0x55);\r\nstv0367_writereg(state, R367TER_PLLSETUP, 0x18);\r\nbreak;\r\ndefault:\r\ncase 27000000:\r\ndprintk("FE_STV0367TER_SetCLKgen for 27Mhz\n");\r\nstv0367_writereg(state, R367TER_PLLMDIV, 0x1);\r\nstv0367_writereg(state, R367TER_PLLNDIV, 0x8);\r\nstv0367_writereg(state, R367TER_PLLSETUP, 0x18);\r\nbreak;\r\ncase 30000000:\r\nstv0367_writereg(state, R367TER_PLLMDIV, 0xc);\r\nstv0367_writereg(state, R367TER_PLLNDIV, 0x55);\r\nstv0367_writereg(state, R367TER_PLLSETUP, 0x18);\r\nbreak;\r\n}\r\nstv0367_writereg(state, R367TER_I2CRPT, 0xa0);\r\nstv0367_writereg(state, R367TER_ANACTRL, 0x00);\r\nstv0367ter_set_ts_mode(state, state->config->ts_mode);\r\nstv0367ter_set_clk_pol(state, state->config->clk_pol);\r\nstate->chip_id = stv0367_readreg(state, R367TER_ID);\r\nter_state->first_lock = 0;\r\nter_state->unlock_counter = 2;\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_algo(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367ter_state *ter_state = state->ter_state;\r\nint offset = 0, tempo = 0;\r\nu8 u_var;\r\nu8 counter;\r\ns8 step;\r\ns32 timing_offset = 0;\r\nu32 trl_nomrate = 0, InternalFreq = 0, temp = 0;\r\ndprintk("%s:\n", __func__);\r\nter_state->frequency = p->frequency;\r\nter_state->force = FE_TER_FORCENONE\r\n+ stv0367_readbits(state, F367TER_FORCE) * 2;\r\nter_state->if_iq_mode = state->config->if_iq_mode;\r\nswitch (state->config->if_iq_mode) {\r\ncase FE_TER_NORMAL_IF_TUNER:\r\ndprintk("ALGO: FE_TER_NORMAL_IF_TUNER selected\n");\r\nstv0367_writebits(state, F367TER_TUNER_BB, 0);\r\nstv0367_writebits(state, F367TER_LONGPATH_IF, 0);\r\nstv0367_writebits(state, F367TER_DEMUX_SWAP, 0);\r\nbreak;\r\ncase FE_TER_LONGPATH_IF_TUNER:\r\ndprintk("ALGO: FE_TER_LONGPATH_IF_TUNER selected\n");\r\nstv0367_writebits(state, F367TER_TUNER_BB, 0);\r\nstv0367_writebits(state, F367TER_LONGPATH_IF, 1);\r\nstv0367_writebits(state, F367TER_DEMUX_SWAP, 1);\r\nbreak;\r\ncase FE_TER_IQ_TUNER:\r\ndprintk("ALGO: FE_TER_IQ_TUNER selected\n");\r\nstv0367_writebits(state, F367TER_TUNER_BB, 1);\r\nstv0367_writebits(state, F367TER_PPM_INVSEL, 0);\r\nbreak;\r\ndefault:\r\nprintk(KERN_ERR "ALGO: wrong TUNER type selected\n");\r\nreturn -EINVAL;\r\n}\r\nusleep_range(5000, 7000);\r\nswitch (p->inversion) {\r\ncase INVERSION_AUTO:\r\ndefault:\r\ndprintk("%s: inversion AUTO\n", __func__);\r\nif (ter_state->if_iq_mode == FE_TER_IQ_TUNER)\r\nstv0367_writebits(state, F367TER_IQ_INVERT,\r\nter_state->sense);\r\nelse\r\nstv0367_writebits(state, F367TER_INV_SPECTR,\r\nter_state->sense);\r\nbreak;\r\ncase INVERSION_ON:\r\ncase INVERSION_OFF:\r\nif (ter_state->if_iq_mode == FE_TER_IQ_TUNER)\r\nstv0367_writebits(state, F367TER_IQ_INVERT,\r\np->inversion);\r\nelse\r\nstv0367_writebits(state, F367TER_INV_SPECTR,\r\np->inversion);\r\nbreak;\r\n}\r\nif ((ter_state->if_iq_mode != FE_TER_NORMAL_IF_TUNER) &&\r\n(ter_state->pBW != ter_state->bw)) {\r\nstv0367ter_agc_iir_lock_detect_set(state);\r\nstv0367_writebits(state, F367TER_SEL_IQNTAR, 1);\r\nstv0367_writebits(state, F367TER_AUT_AGC_TARGET_MSB, 0xB);\r\nstv0367_writebits(state, F367TER_SEL_IQNTAR, 0);\r\nstv0367_writebits(state, F367TER_AUT_AGC_TARGET_MSB, 0xB);\r\nif (!stv0367_iir_filt_init(state, ter_state->bw,\r\nstate->config->xtal))\r\nreturn -EINVAL;\r\nter_state->pBW = ter_state->bw;\r\nstv0367ter_agc_iir_rst(state);\r\n}\r\nif (ter_state->hierarchy == FE_TER_HIER_LOW_PRIO)\r\nstv0367_writebits(state, F367TER_BDI_LPSEL, 0x01);\r\nelse\r\nstv0367_writebits(state, F367TER_BDI_LPSEL, 0x00);\r\nInternalFreq = stv0367ter_get_mclk(state, state->config->xtal) / 1000;\r\ntemp = (int)\r\n((((ter_state->bw * 64 * (1 << 15) * 100)\r\n/ (InternalFreq)) * 10) / 7);\r\nstv0367_writebits(state, F367TER_TRL_NOMRATE_LSB, temp % 2);\r\ntemp = temp / 2;\r\nstv0367_writebits(state, F367TER_TRL_NOMRATE_HI, temp / 256);\r\nstv0367_writebits(state, F367TER_TRL_NOMRATE_LO, temp % 256);\r\ntemp = stv0367_readbits(state, F367TER_TRL_NOMRATE_HI) * 512 +\r\nstv0367_readbits(state, F367TER_TRL_NOMRATE_LO) * 2 +\r\nstv0367_readbits(state, F367TER_TRL_NOMRATE_LSB);\r\ntemp = (int)(((1 << 17) * ter_state->bw * 1000) / (7 * (InternalFreq)));\r\nstv0367_writebits(state, F367TER_GAIN_SRC_HI, temp / 256);\r\nstv0367_writebits(state, F367TER_GAIN_SRC_LO, temp % 256);\r\ntemp = stv0367_readbits(state, F367TER_GAIN_SRC_HI) * 256 +\r\nstv0367_readbits(state, F367TER_GAIN_SRC_LO);\r\ntemp = (int)\r\n((InternalFreq - state->config->if_khz) * (1 << 16)\r\n/ (InternalFreq));\r\ndprintk("DEROT temp=0x%x\n", temp);\r\nstv0367_writebits(state, F367TER_INC_DEROT_HI, temp / 256);\r\nstv0367_writebits(state, F367TER_INC_DEROT_LO, temp % 256);\r\nter_state->echo_pos = 0;\r\nter_state->ucblocks = 0;\r\nter_state->pBER = 0;\r\nstv0367_writebits(state, F367TER_LONG_ECHO, ter_state->echo_pos);\r\nif (stv0367ter_lock_algo(state) != FE_TER_LOCKOK)\r\nreturn 0;\r\nter_state->state = FE_TER_LOCKOK;\r\nter_state->mode = stv0367_readbits(state, F367TER_SYR_MODE);\r\nter_state->guard = stv0367_readbits(state, F367TER_SYR_GUARD);\r\nter_state->first_lock = 1;\r\nter_state->agc_val =\r\n(stv0367_readbits(state, F367TER_AGC1_VAL_LO) << 16) +\r\n(stv0367_readbits(state, F367TER_AGC1_VAL_HI) << 24) +\r\nstv0367_readbits(state, F367TER_AGC2_VAL_LO) +\r\n(stv0367_readbits(state, F367TER_AGC2_VAL_HI) << 8);\r\nstv0367_writebits(state, F367TER_FREEZE, 1);\r\noffset = (stv0367_readbits(state, F367TER_CRL_FOFFSET_VHI) << 16) ;\r\noffset += (stv0367_readbits(state, F367TER_CRL_FOFFSET_HI) << 8);\r\noffset += (stv0367_readbits(state, F367TER_CRL_FOFFSET_LO));\r\nstv0367_writebits(state, F367TER_FREEZE, 0);\r\nif (offset > 8388607)\r\noffset -= 16777216;\r\noffset = offset * 2 / 16384;\r\nif (ter_state->mode == FE_TER_MODE_2K)\r\noffset = (offset * 4464) / 1000;\r\nelse if (ter_state->mode == FE_TER_MODE_4K)\r\noffset = (offset * 223) / 100;\r\nelse if (ter_state->mode == FE_TER_MODE_8K)\r\noffset = (offset * 111) / 100;\r\nif (stv0367_readbits(state, F367TER_PPM_INVSEL) == 1) {\r\nif ((stv0367_readbits(state, F367TER_INV_SPECTR) ==\r\n(stv0367_readbits(state,\r\nF367TER_STATUS_INV_SPECRUM) == 1)))\r\noffset = offset * -1;\r\n}\r\nif (ter_state->bw == 6)\r\noffset = (offset * 6) / 8;\r\nelse if (ter_state->bw == 7)\r\noffset = (offset * 7) / 8;\r\nter_state->frequency += offset;\r\ntempo = 10;\r\nwhile ((timing_offset == 0) && (tempo > 0)) {\r\nusleep_range(10000, 20000);\r\ntiming_offset = stv0367_readbits(state, F367TER_TRL_TOFFSET_LO)\r\n+ 256 * stv0367_readbits(state,\r\nF367TER_TRL_TOFFSET_HI);\r\nif (timing_offset >= 32768)\r\ntiming_offset -= 65536;\r\ntrl_nomrate = (512 * stv0367_readbits(state,\r\nF367TER_TRL_NOMRATE_HI)\r\n+ stv0367_readbits(state, F367TER_TRL_NOMRATE_LO) * 2\r\n+ stv0367_readbits(state, F367TER_TRL_NOMRATE_LSB));\r\ntiming_offset = ((signed)(1000000 / trl_nomrate) *\r\ntiming_offset) / 2048;\r\ntempo--;\r\n}\r\nif (timing_offset <= 0) {\r\ntiming_offset = (timing_offset - 11) / 22;\r\nstep = -1;\r\n} else {\r\ntiming_offset = (timing_offset + 11) / 22;\r\nstep = 1;\r\n}\r\nfor (counter = 0; counter < abs(timing_offset); counter++) {\r\ntrl_nomrate += step;\r\nstv0367_writebits(state, F367TER_TRL_NOMRATE_LSB,\r\ntrl_nomrate % 2);\r\nstv0367_writebits(state, F367TER_TRL_NOMRATE_LO,\r\ntrl_nomrate / 2);\r\nusleep_range(1000, 2000);\r\n}\r\nusleep_range(5000, 6000);\r\nu_var = stv0367_readbits(state, F367TER_LK);\r\nif (!u_var) {\r\nstv0367_writebits(state, F367TER_CORE_ACTIVE, 0);\r\nmsleep(20);\r\nstv0367_writebits(state, F367TER_CORE_ACTIVE, 1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367ter_state *ter_state = state->ter_state;\r\ns8 num_trials, index;\r\nu8 SenseTrials[] = { INVERSION_ON, INVERSION_OFF };\r\nstv0367ter_init(fe);\r\nif (fe->ops.tuner_ops.set_params) {\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nfe->ops.tuner_ops.set_params(fe);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\n}\r\nswitch (p->transmission_mode) {\r\ndefault:\r\ncase TRANSMISSION_MODE_AUTO:\r\ncase TRANSMISSION_MODE_2K:\r\nter_state->mode = FE_TER_MODE_2K;\r\nbreak;\r\ncase TRANSMISSION_MODE_8K:\r\nter_state->mode = FE_TER_MODE_8K;\r\nbreak;\r\n}\r\nswitch (p->guard_interval) {\r\ndefault:\r\ncase GUARD_INTERVAL_1_32:\r\ncase GUARD_INTERVAL_1_16:\r\ncase GUARD_INTERVAL_1_8:\r\ncase GUARD_INTERVAL_1_4:\r\nter_state->guard = p->guard_interval;\r\nbreak;\r\ncase GUARD_INTERVAL_AUTO:\r\nter_state->guard = GUARD_INTERVAL_1_32;\r\nbreak;\r\n}\r\nswitch (p->bandwidth_hz) {\r\ncase 6000000:\r\nter_state->bw = FE_TER_CHAN_BW_6M;\r\nbreak;\r\ncase 7000000:\r\nter_state->bw = FE_TER_CHAN_BW_7M;\r\nbreak;\r\ncase 8000000:\r\ndefault:\r\nter_state->bw = FE_TER_CHAN_BW_8M;\r\n}\r\nter_state->hierarchy = FE_TER_HIER_NONE;\r\nswitch (p->inversion) {\r\ncase INVERSION_OFF:\r\ncase INVERSION_ON:\r\nnum_trials = 1;\r\nbreak;\r\ndefault:\r\nnum_trials = 2;\r\nif (ter_state->first_lock)\r\nnum_trials = 1;\r\nbreak;\r\n}\r\nter_state->state = FE_TER_NOLOCK;\r\nindex = 0;\r\nwhile (((index) < num_trials) && (ter_state->state != FE_TER_LOCKOK)) {\r\nif (!ter_state->first_lock) {\r\nif (p->inversion == INVERSION_AUTO)\r\nter_state->sense = SenseTrials[index];\r\n}\r\nstv0367ter_algo(fe);\r\nif ((ter_state->state == FE_TER_LOCKOK) &&\r\n(p->inversion == INVERSION_AUTO) &&\r\n(index == 1)) {\r\nSenseTrials[index] = SenseTrials[0];\r\nSenseTrials[(index + 1) % 2] = (SenseTrials[1] + 1) % 2;\r\n}\r\nindex++;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_read_ucblocks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367ter_state *ter_state = state->ter_state;\r\nu32 errs = 0;\r\nif (stv0367_readbits(state, F367TER_SFERRC_OLDVALUE) == 0) {\r\nerrs =\r\n((u32)stv0367_readbits(state, F367TER_ERR_CNT1)\r\n* (1 << 16))\r\n+ ((u32)stv0367_readbits(state, F367TER_ERR_CNT1_HI)\r\n* (1 << 8))\r\n+ ((u32)stv0367_readbits(state, F367TER_ERR_CNT1_LO));\r\nter_state->ucblocks = errs;\r\n}\r\n(*ucblocks) = ter_state->ucblocks;\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_get_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367ter_state *ter_state = state->ter_state;\r\nint error = 0;\r\nenum stv0367_ter_mode mode;\r\nint constell = 0, Data = 0;\r\np->frequency = stv0367_get_tuner_freq(fe);\r\nif ((int)p->frequency < 0)\r\np->frequency = -p->frequency;\r\nconstell = stv0367_readbits(state, F367TER_TPS_CONST);\r\nif (constell == 0)\r\np->modulation = QPSK;\r\nelse if (constell == 1)\r\np->modulation = QAM_16;\r\nelse\r\np->modulation = QAM_64;\r\np->inversion = stv0367_readbits(state, F367TER_INV_SPECTR);\r\nData = stv0367_readbits(state, F367TER_TPS_HIERMODE);\r\nswitch (Data) {\r\ncase 0:\r\np->hierarchy = HIERARCHY_NONE;\r\nbreak;\r\ncase 1:\r\np->hierarchy = HIERARCHY_1;\r\nbreak;\r\ncase 2:\r\np->hierarchy = HIERARCHY_2;\r\nbreak;\r\ncase 3:\r\np->hierarchy = HIERARCHY_4;\r\nbreak;\r\ndefault:\r\np->hierarchy = HIERARCHY_AUTO;\r\nbreak;\r\n}\r\nif (ter_state->hierarchy == FE_TER_HIER_LOW_PRIO)\r\nData = stv0367_readbits(state, F367TER_TPS_LPCODE);\r\nelse\r\nData = stv0367_readbits(state, F367TER_TPS_HPCODE);\r\nswitch (Data) {\r\ncase 0:\r\np->code_rate_HP = FEC_1_2;\r\nbreak;\r\ncase 1:\r\np->code_rate_HP = FEC_2_3;\r\nbreak;\r\ncase 2:\r\np->code_rate_HP = FEC_3_4;\r\nbreak;\r\ncase 3:\r\np->code_rate_HP = FEC_5_6;\r\nbreak;\r\ncase 4:\r\np->code_rate_HP = FEC_7_8;\r\nbreak;\r\ndefault:\r\np->code_rate_HP = FEC_AUTO;\r\nbreak;\r\n}\r\nmode = stv0367_readbits(state, F367TER_SYR_MODE);\r\nswitch (mode) {\r\ncase FE_TER_MODE_2K:\r\np->transmission_mode = TRANSMISSION_MODE_2K;\r\nbreak;\r\ncase FE_TER_MODE_8K:\r\np->transmission_mode = TRANSMISSION_MODE_8K;\r\nbreak;\r\ndefault:\r\np->transmission_mode = TRANSMISSION_MODE_AUTO;\r\n}\r\np->guard_interval = stv0367_readbits(state, F367TER_SYR_GUARD);\r\nreturn error;\r\n}\r\nstatic int stv0367ter_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nu32 snru32 = 0;\r\nint cpt = 0;\r\nu8 cut = stv0367_readbits(state, F367TER_IDENTIFICATIONREG);\r\nwhile (cpt < 10) {\r\nusleep_range(2000, 3000);\r\nif (cut == 0x50)\r\nsnru32 += stv0367_readbits(state, F367TER_CHCSNR) / 4;\r\nelse\r\nsnru32 += 125 * stv0367_readbits(state, F367TER_CHCSNR);\r\ncpt++;\r\n}\r\nsnru32 /= 10;\r\n*snr = snru32 / 1000;\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\ndprintk("%s:\n", __func__);\r\n*status = 0;\r\nif (stv0367_readbits(state, F367TER_LK)) {\r\n*status |= FE_HAS_LOCK;\r\ndprintk("%s: stv0367 has locked\n", __func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv0367ter_read_ber(struct dvb_frontend *fe, u32 *ber)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367ter_state *ter_state = state->ter_state;\r\nu32 Errors = 0, tber = 0, temporary = 0;\r\nint abc = 0, def = 0;\r\nif (stv0367_readbits(state, F367TER_SFERRC_OLDVALUE) == 0)\r\nErrors = ((u32)stv0367_readbits(state, F367TER_SFEC_ERR_CNT)\r\n* (1 << 16))\r\n+ ((u32)stv0367_readbits(state, F367TER_SFEC_ERR_CNT_HI)\r\n* (1 << 8))\r\n+ ((u32)stv0367_readbits(state,\r\nF367TER_SFEC_ERR_CNT_LO));\r\nelse {\r\ntber = ter_state->pBER;\r\nreturn 0;\r\n}\r\nabc = stv0367_readbits(state, F367TER_SFEC_ERR_SOURCE);\r\ndef = stv0367_readbits(state, F367TER_SFEC_NUM_EVENT);\r\nif (Errors == 0) {\r\ntber = 0;\r\n} else if (abc == 0x7) {\r\nif (Errors <= 4) {\r\ntemporary = (Errors * 1000000000) / (8 * (1 << 14));\r\ntemporary = temporary;\r\n} else if (Errors <= 42) {\r\ntemporary = (Errors * 100000000) / (8 * (1 << 14));\r\ntemporary = temporary * 10;\r\n} else if (Errors <= 429) {\r\ntemporary = (Errors * 10000000) / (8 * (1 << 14));\r\ntemporary = temporary * 100;\r\n} else if (Errors <= 4294) {\r\ntemporary = (Errors * 1000000) / (8 * (1 << 14));\r\ntemporary = temporary * 1000;\r\n} else if (Errors <= 42949) {\r\ntemporary = (Errors * 100000) / (8 * (1 << 14));\r\ntemporary = temporary * 10000;\r\n} else if (Errors <= 429496) {\r\ntemporary = (Errors * 10000) / (8 * (1 << 14));\r\ntemporary = temporary * 100000;\r\n} else {\r\ntemporary = (Errors * 1000) / (8 * (1 << 14));\r\ntemporary = temporary * 100000;\r\n}\r\nif (def == 2)\r\ntber = temporary;\r\nelse if (def == 3)\r\ntber = temporary / 4;\r\nelse if (def == 4)\r\ntber = temporary / 16;\r\nelse if (def == 5)\r\ntber = temporary / 64;\r\nelse if (def == 6)\r\ntber = temporary / 256;\r\nelse\r\ntber = 0;\r\nif ((Errors < 4294967) && (Errors > 429496))\r\ntber *= 10;\r\n}\r\nter_state->pBER = tber;\r\n(*ber) = tber;\r\nreturn 0;\r\n}\r\nstatic int stv0367_get_tune_settings(struct dvb_frontend *fe,\r\nstruct dvb_frontend_tune_settings\r\n*fe_tune_settings)\r\n{\r\nfe_tune_settings->min_delay_ms = 1000;\r\nfe_tune_settings->step_size = 0;\r\nfe_tune_settings->max_drift = 0;\r\nreturn 0;\r\n}\r\nstatic void stv0367_release(struct dvb_frontend *fe)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nkfree(state->ter_state);\r\nkfree(state->cab_state);\r\nkfree(state);\r\n}\r\nstruct dvb_frontend *stv0367ter_attach(const struct stv0367_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct stv0367_state *state = NULL;\r\nstruct stv0367ter_state *ter_state = NULL;\r\nstate = kzalloc(sizeof(struct stv0367_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\nter_state = kzalloc(sizeof(struct stv0367ter_state), GFP_KERNEL);\r\nif (ter_state == NULL)\r\ngoto error;\r\nstate->i2c = i2c;\r\nstate->config = config;\r\nstate->ter_state = ter_state;\r\nstate->fe.ops = stv0367ter_ops;\r\nstate->fe.demodulator_priv = state;\r\nstate->chip_id = stv0367_readreg(state, 0xf000);\r\ndprintk("%s: chip_id = 0x%x\n", __func__, state->chip_id);\r\nif ((state->chip_id != 0x50) && (state->chip_id != 0x60))\r\ngoto error;\r\nreturn &state->fe;\r\nerror:\r\nkfree(ter_state);\r\nkfree(state);\r\nreturn NULL;\r\n}\r\nstatic int stv0367cab_gate_ctrl(struct dvb_frontend *fe, int enable)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\ndprintk("%s:\n", __func__);\r\nstv0367_writebits(state, F367CAB_I2CT_ON, (enable > 0) ? 1 : 0);\r\nreturn 0;\r\n}\r\nstatic u32 stv0367cab_get_mclk(struct dvb_frontend *fe, u32 ExtClk_Hz)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nu32 mclk_Hz = 0;\r\nu32 M, N, P;\r\nif (stv0367_readbits(state, F367CAB_BYPASS_PLLXN) == 0) {\r\nN = (u32)stv0367_readbits(state, F367CAB_PLL_NDIV);\r\nif (N == 0)\r\nN = N + 1;\r\nM = (u32)stv0367_readbits(state, F367CAB_PLL_MDIV);\r\nif (M == 0)\r\nM = M + 1;\r\nP = (u32)stv0367_readbits(state, F367CAB_PLL_PDIV);\r\nif (P > 5)\r\nP = 5;\r\nmclk_Hz = ((ExtClk_Hz / 2) * N) / (M * (1 << P));\r\ndprintk("stv0367cab_get_mclk BYPASS_PLLXN mclk_Hz=%d\n",\r\nmclk_Hz);\r\n} else\r\nmclk_Hz = ExtClk_Hz;\r\ndprintk("stv0367cab_get_mclk final mclk_Hz=%d\n", mclk_Hz);\r\nreturn mclk_Hz;\r\n}\r\nstatic u32 stv0367cab_get_adc_freq(struct dvb_frontend *fe, u32 ExtClk_Hz)\r\n{\r\nu32 ADCClk_Hz = ExtClk_Hz;\r\nADCClk_Hz = stv0367cab_get_mclk(fe, ExtClk_Hz);\r\nreturn ADCClk_Hz;\r\n}\r\nenum stv0367cab_mod stv0367cab_SetQamSize(struct stv0367_state *state,\r\nu32 SymbolRate,\r\nenum stv0367cab_mod QAMSize)\r\n{\r\nstv0367_writebits(state, F367CAB_QAM_MODE, QAMSize);\r\nswitch (QAMSize) {\r\ncase FE_CAB_MOD_QAM4:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x00);\r\nbreak;\r\ncase FE_CAB_MOD_QAM16:\r\nstv0367_writereg(state, R367CAB_AGC_PWR_REF_L, 0x64);\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x00);\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0x90);\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xc1);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa7);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LD_SEN, 0x95);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LIMITER, 0x40);\r\nstv0367_writereg(state, R367CAB_EQU_PNT_GAIN, 0x8a);\r\nbreak;\r\ncase FE_CAB_MOD_QAM32:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x00);\r\nstv0367_writereg(state, R367CAB_AGC_PWR_REF_L, 0x6e);\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0xb0);\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xc1);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xb7);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LD_SEN, 0x9d);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LIMITER, 0x7f);\r\nstv0367_writereg(state, R367CAB_EQU_PNT_GAIN, 0xa7);\r\nbreak;\r\ncase FE_CAB_MOD_QAM64:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x82);\r\nstv0367_writereg(state, R367CAB_AGC_PWR_REF_L, 0x5a);\r\nif (SymbolRate > 45000000) {\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0xb0);\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xc1);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa5);\r\n} else if (SymbolRate > 25000000) {\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0xa0);\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xc1);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa6);\r\n} else {\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0xa0);\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xd1);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa7);\r\n}\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LD_SEN, 0x95);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LIMITER, 0x40);\r\nstv0367_writereg(state, R367CAB_EQU_PNT_GAIN, 0x99);\r\nbreak;\r\ncase FE_CAB_MOD_QAM128:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x00);\r\nstv0367_writereg(state, R367CAB_AGC_PWR_REF_L, 0x76);\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0x90);\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xb1);\r\nif (SymbolRate > 45000000)\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa7);\r\nelse if (SymbolRate > 25000000)\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa6);\r\nelse\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0x97);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LD_SEN, 0x8e);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LIMITER, 0x7f);\r\nstv0367_writereg(state, R367CAB_EQU_PNT_GAIN, 0xa7);\r\nbreak;\r\ncase FE_CAB_MOD_QAM256:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x94);\r\nstv0367_writereg(state, R367CAB_AGC_PWR_REF_L, 0x5a);\r\nstv0367_writereg(state, R367CAB_FSM_STATE, 0xa0);\r\nif (SymbolRate > 45000000)\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xc1);\r\nelse if (SymbolRate > 25000000)\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xc1);\r\nelse\r\nstv0367_writereg(state, R367CAB_EQU_CTR_LPF_GAIN, 0xd1);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LPF_GAIN, 0xa7);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LD_SEN, 0x85);\r\nstv0367_writereg(state, R367CAB_EQU_CRL_LIMITER, 0x40);\r\nstv0367_writereg(state, R367CAB_EQU_PNT_GAIN, 0xa7);\r\nbreak;\r\ncase FE_CAB_MOD_QAM512:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x00);\r\nbreak;\r\ncase FE_CAB_MOD_QAM1024:\r\nstv0367_writereg(state, R367CAB_IQDEM_ADJ_AGC_REF, 0x00);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn QAMSize;\r\n}\r\nstatic u32 stv0367cab_set_derot_freq(struct stv0367_state *state,\r\nu32 adc_hz, s32 derot_hz)\r\n{\r\nu32 sampled_if = 0;\r\nu32 adc_khz;\r\nadc_khz = adc_hz / 1000;\r\ndprintk("%s: adc_hz=%d derot_hz=%d\n", __func__, adc_hz, derot_hz);\r\nif (adc_khz != 0) {\r\nif (derot_hz < 1000000)\r\nderot_hz = adc_hz / 4;\r\nif (derot_hz > adc_hz)\r\nderot_hz = derot_hz - adc_hz;\r\nsampled_if = (u32)derot_hz / 1000;\r\nsampled_if *= 32768;\r\nsampled_if /= adc_khz;\r\nsampled_if *= 256;\r\n}\r\nif (sampled_if > 8388607)\r\nsampled_if = 8388607;\r\ndprintk("%s: sampled_if=0x%x\n", __func__, sampled_if);\r\nstv0367_writereg(state, R367CAB_MIX_NCO_LL, sampled_if);\r\nstv0367_writereg(state, R367CAB_MIX_NCO_HL, (sampled_if >> 8));\r\nstv0367_writebits(state, F367CAB_MIX_NCO_INC_HH, (sampled_if >> 16));\r\nreturn derot_hz;\r\n}\r\nstatic u32 stv0367cab_get_derot_freq(struct stv0367_state *state, u32 adc_hz)\r\n{\r\nu32 sampled_if;\r\nsampled_if = stv0367_readbits(state, F367CAB_MIX_NCO_INC_LL) +\r\n(stv0367_readbits(state, F367CAB_MIX_NCO_INC_HL) << 8) +\r\n(stv0367_readbits(state, F367CAB_MIX_NCO_INC_HH) << 16);\r\nsampled_if /= 256;\r\nsampled_if *= (adc_hz / 1000);\r\nsampled_if += 1;\r\nsampled_if /= 32768;\r\nreturn sampled_if;\r\n}\r\nstatic u32 stv0367cab_set_srate(struct stv0367_state *state, u32 adc_hz,\r\nu32 mclk_hz, u32 SymbolRate,\r\nenum stv0367cab_mod QAMSize)\r\n{\r\nu32 QamSizeCorr = 0;\r\nu32 u32_tmp = 0, u32_tmp1 = 0;\r\nu32 adp_khz;\r\ndprintk("%s:\n", __func__);\r\nswitch (QAMSize) {\r\ncase FE_CAB_MOD_QAM4:\r\nQamSizeCorr = 1110;\r\nbreak;\r\ncase FE_CAB_MOD_QAM16:\r\nQamSizeCorr = 1032;\r\nbreak;\r\ncase FE_CAB_MOD_QAM32:\r\nQamSizeCorr = 954;\r\nbreak;\r\ncase FE_CAB_MOD_QAM64:\r\nQamSizeCorr = 983;\r\nbreak;\r\ncase FE_CAB_MOD_QAM128:\r\nQamSizeCorr = 957;\r\nbreak;\r\ncase FE_CAB_MOD_QAM256:\r\nQamSizeCorr = 948;\r\nbreak;\r\ncase FE_CAB_MOD_QAM512:\r\nQamSizeCorr = 0;\r\nbreak;\r\ncase FE_CAB_MOD_QAM1024:\r\nQamSizeCorr = 944;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (adc_hz != 0) {\r\nu32_tmp = 256 * SymbolRate;\r\nu32_tmp = u32_tmp / adc_hz;\r\n}\r\nstv0367_writereg(state, R367CAB_EQU_CRL_TFR, (u8)u32_tmp);\r\nadp_khz = (mclk_hz >> 1) / 1000;\r\nif (adp_khz != 0) {\r\nu32_tmp = SymbolRate;\r\nu32_tmp1 = SymbolRate;\r\nif (u32_tmp < 2097152) {\r\nu32_tmp *= 2048;\r\nu32_tmp = u32_tmp / adp_khz;\r\nu32_tmp = u32_tmp * 16384;\r\nu32_tmp /= 125 ;\r\nu32_tmp = u32_tmp * 8;\r\nu32_tmp1 *= 2048;\r\nu32_tmp1 /= 439;\r\nu32_tmp1 *= 256;\r\nu32_tmp1 = u32_tmp1 / adp_khz;\r\nu32_tmp1 *= QamSizeCorr * 9;\r\nu32_tmp1 = u32_tmp1 / 10000000;\r\n} else if (u32_tmp < 4194304) {\r\nu32_tmp *= 1024 ;\r\nu32_tmp = u32_tmp / adp_khz;\r\nu32_tmp = u32_tmp * 16384;\r\nu32_tmp /= 125 ;\r\nu32_tmp = u32_tmp * 16;\r\nu32_tmp1 *= 1024;\r\nu32_tmp1 /= 439;\r\nu32_tmp1 *= 256;\r\nu32_tmp1 = u32_tmp1 / adp_khz;\r\nu32_tmp1 *= QamSizeCorr * 9;\r\nu32_tmp1 = u32_tmp1 / 5000000;\r\n} else if (u32_tmp < 8388607) {\r\nu32_tmp *= 512 ;\r\nu32_tmp = u32_tmp / adp_khz;\r\nu32_tmp = u32_tmp * 16384;\r\nu32_tmp /= 125 ;\r\nu32_tmp = u32_tmp * 32;\r\nu32_tmp1 *= 512;\r\nu32_tmp1 /= 439;\r\nu32_tmp1 *= 256;\r\nu32_tmp1 = u32_tmp1 / adp_khz;\r\nu32_tmp1 *= QamSizeCorr * 9;\r\nu32_tmp1 = u32_tmp1 / 2500000;\r\n} else {\r\nu32_tmp *= 256 ;\r\nu32_tmp = u32_tmp / adp_khz;\r\nu32_tmp = u32_tmp * 16384;\r\nu32_tmp /= 125 ;\r\nu32_tmp = u32_tmp * 64;\r\nu32_tmp1 *= 256;\r\nu32_tmp1 /= 439;\r\nu32_tmp1 *= 256;\r\nu32_tmp1 = u32_tmp1 / adp_khz;\r\nu32_tmp1 *= QamSizeCorr * 9;\r\nu32_tmp1 = u32_tmp1 / 1250000;\r\n}\r\n}\r\n#if 0\r\nif (stv0367_readbits(state, F367CAB_ADJ_EN)) {\r\nstv0367cab_SetIirAdjacentcoefficient(state, mclk_hz,\r\nSymbolRate);\r\nstv0367_writebits(state, F367CAB_ALLPASSFILT_EN, 1);\r\nstv0367cab_SetAllPasscoefficient(state, mclk_hz, SymbolRate);\r\n} else\r\n#endif\r\nstv0367_writebits(state, F367CAB_ALLPASSFILT_EN, 0);\r\nstv0367_writereg(state, R367CAB_SRC_NCO_LL, u32_tmp);\r\nstv0367_writereg(state, R367CAB_SRC_NCO_LH, (u32_tmp >> 8));\r\nstv0367_writereg(state, R367CAB_SRC_NCO_HL, (u32_tmp >> 16));\r\nstv0367_writereg(state, R367CAB_SRC_NCO_HH, (u32_tmp >> 24));\r\nstv0367_writereg(state, R367CAB_IQDEM_GAIN_SRC_L, u32_tmp1 & 0x00ff);\r\nstv0367_writebits(state, F367CAB_GAIN_SRC_HI, (u32_tmp1 >> 8) & 0x00ff);\r\nreturn SymbolRate ;\r\n}\r\nstatic u32 stv0367cab_GetSymbolRate(struct stv0367_state *state, u32 mclk_hz)\r\n{\r\nu32 regsym;\r\nu32 adp_khz;\r\nregsym = stv0367_readreg(state, R367CAB_SRC_NCO_LL) +\r\n(stv0367_readreg(state, R367CAB_SRC_NCO_LH) << 8) +\r\n(stv0367_readreg(state, R367CAB_SRC_NCO_HL) << 16) +\r\n(stv0367_readreg(state, R367CAB_SRC_NCO_HH) << 24);\r\nadp_khz = (mclk_hz >> 1) / 1000;\r\nif (regsym < 134217728) {\r\nregsym = regsym * 32;\r\nregsym = regsym / 32768;\r\nregsym = adp_khz * regsym;\r\nregsym = regsym / 128;\r\nregsym *= 125 ;\r\nregsym /= 2048 ;\r\n} else if (regsym < 268435456) {\r\nregsym = regsym * 16;\r\nregsym = regsym / 32768;\r\nregsym = adp_khz * regsym;\r\nregsym = regsym / 128;\r\nregsym *= 125 ;\r\nregsym /= 1024 ;\r\n} else if (regsym < 536870912) {\r\nregsym = regsym * 8;\r\nregsym = regsym / 32768;\r\nregsym = adp_khz * regsym;\r\nregsym = regsym / 128;\r\nregsym *= 125 ;\r\nregsym /= 512 ;\r\n} else {\r\nregsym = regsym * 4;\r\nregsym = regsym / 32768;\r\nregsym = adp_khz * regsym;\r\nregsym = regsym / 128;\r\nregsym *= 125 ;\r\nregsym /= 256 ;\r\n}\r\nreturn regsym;\r\n}\r\nstatic int stv0367cab_read_status(struct dvb_frontend *fe, fe_status_t *status)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\ndprintk("%s:\n", __func__);\r\n*status = 0;\r\nif (stv0367_readbits(state, F367CAB_QAMFEC_LOCK)) {\r\n*status |= FE_HAS_LOCK;\r\ndprintk("%s: stv0367 has locked\n", __func__);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv0367cab_standby(struct dvb_frontend *fe, u8 standby_on)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\ndprintk("%s:\n", __func__);\r\nif (standby_on) {\r\nstv0367_writebits(state, F367CAB_BYPASS_PLLXN, 0x03);\r\nstv0367_writebits(state, F367CAB_STDBY_PLLXN, 0x01);\r\nstv0367_writebits(state, F367CAB_STDBY, 1);\r\nstv0367_writebits(state, F367CAB_STDBY_CORE, 1);\r\nstv0367_writebits(state, F367CAB_EN_BUFFER_I, 0);\r\nstv0367_writebits(state, F367CAB_EN_BUFFER_Q, 0);\r\nstv0367_writebits(state, F367CAB_POFFQ, 1);\r\nstv0367_writebits(state, F367CAB_POFFI, 1);\r\n} else {\r\nstv0367_writebits(state, F367CAB_STDBY_PLLXN, 0x00);\r\nstv0367_writebits(state, F367CAB_BYPASS_PLLXN, 0x00);\r\nstv0367_writebits(state, F367CAB_STDBY, 0);\r\nstv0367_writebits(state, F367CAB_STDBY_CORE, 0);\r\nstv0367_writebits(state, F367CAB_EN_BUFFER_I, 1);\r\nstv0367_writebits(state, F367CAB_EN_BUFFER_Q, 1);\r\nstv0367_writebits(state, F367CAB_POFFQ, 0);\r\nstv0367_writebits(state, F367CAB_POFFI, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv0367cab_sleep(struct dvb_frontend *fe)\r\n{\r\nreturn stv0367cab_standby(fe, 1);\r\n}\r\nint stv0367cab_init(struct dvb_frontend *fe)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367cab_state *cab_state = state->cab_state;\r\nint i;\r\ndprintk("%s:\n", __func__);\r\nfor (i = 0; i < STV0367CAB_NBREGS; i++)\r\nstv0367_writereg(state, def0367cab[i].addr,\r\ndef0367cab[i].value);\r\nswitch (state->config->ts_mode) {\r\ncase STV0367_DVBCI_CLOCK:\r\ndprintk("Setting TSMode = STV0367_DVBCI_CLOCK\n");\r\nstv0367_writebits(state, F367CAB_OUTFORMAT, 0x03);\r\nbreak;\r\ncase STV0367_SERIAL_PUNCT_CLOCK:\r\ncase STV0367_SERIAL_CONT_CLOCK:\r\nstv0367_writebits(state, F367CAB_OUTFORMAT, 0x01);\r\nbreak;\r\ncase STV0367_PARALLEL_PUNCT_CLOCK:\r\ncase STV0367_OUTPUTMODE_DEFAULT:\r\nstv0367_writebits(state, F367CAB_OUTFORMAT, 0x00);\r\nbreak;\r\n}\r\nswitch (state->config->clk_pol) {\r\ncase STV0367_RISINGEDGE_CLOCK:\r\nstv0367_writebits(state, F367CAB_CLK_POLARITY, 0x00);\r\nbreak;\r\ncase STV0367_FALLINGEDGE_CLOCK:\r\ncase STV0367_CLOCKPOLARITY_DEFAULT:\r\nstv0367_writebits(state, F367CAB_CLK_POLARITY, 0x01);\r\nbreak;\r\n}\r\nstv0367_writebits(state, F367CAB_SYNC_STRIP, 0x00);\r\nstv0367_writebits(state, F367CAB_CT_NBST, 0x01);\r\nstv0367_writebits(state, F367CAB_TS_SWAP, 0x01);\r\nstv0367_writebits(state, F367CAB_FIFO_BYPASS, 0x00);\r\nstv0367_writereg(state, R367CAB_ANACTRL, 0x00);\r\ncab_state->mclk = stv0367cab_get_mclk(fe, state->config->xtal);\r\ncab_state->adc_clk = stv0367cab_get_adc_freq(fe, state->config->xtal);\r\nreturn 0;\r\n}\r\nstatic\r\nenum stv0367_cab_signal_type stv0367cab_algo(struct stv0367_state *state,\r\nstruct dtv_frontend_properties *p)\r\n{\r\nstruct stv0367cab_state *cab_state = state->cab_state;\r\nenum stv0367_cab_signal_type signalType = FE_CAB_NOAGC;\r\nu32 QAMFEC_Lock, QAM_Lock, u32_tmp,\r\nLockTime, TRLTimeOut, AGCTimeOut, CRLSymbols,\r\nCRLTimeOut, EQLTimeOut, DemodTimeOut, FECTimeOut;\r\nu8 TrackAGCAccum;\r\ns32 tmp;\r\ndprintk("%s:\n", __func__);\r\nAGCTimeOut = 25;\r\nTRLTimeOut = 100000000 / p->symbol_rate;\r\nswitch (p->modulation) {\r\ncase QAM_16:\r\nCRLSymbols = 150000;\r\nEQLTimeOut = 100;\r\nbreak;\r\ncase QAM_32:\r\nCRLSymbols = 250000;\r\nEQLTimeOut = 100;\r\nbreak;\r\ncase QAM_64:\r\nCRLSymbols = 200000;\r\nEQLTimeOut = 100;\r\nbreak;\r\ncase QAM_128:\r\nCRLSymbols = 250000;\r\nEQLTimeOut = 100;\r\nbreak;\r\ncase QAM_256:\r\nCRLSymbols = 250000;\r\nEQLTimeOut = 100;\r\nbreak;\r\ndefault:\r\nCRLSymbols = 200000;\r\nEQLTimeOut = 100;\r\nbreak;\r\n}\r\n#if 0\r\nif (pIntParams->search_range < 0) {\r\nCRLTimeOut = (25 * CRLSymbols *\r\n(-pIntParams->search_range / 1000)) /\r\n(pIntParams->symbol_rate / 1000);\r\n} else\r\n#endif\r\nCRLTimeOut = (25 * CRLSymbols * (cab_state->search_range / 1000)) /\r\n(p->symbol_rate / 1000);\r\nCRLTimeOut = (1000 * CRLTimeOut) / p->symbol_rate;\r\nif (CRLTimeOut < 50)\r\nCRLTimeOut = 50;\r\nFECTimeOut = 20;\r\nDemodTimeOut = AGCTimeOut + TRLTimeOut + CRLTimeOut + EQLTimeOut;\r\ndprintk("%s: DemodTimeOut=%d\n", __func__, DemodTimeOut);\r\nstv0367_writereg(state, R367CAB_CTRL_1, 0x04);\r\nTrackAGCAccum = stv0367_readbits(state, F367CAB_AGC_ACCUMRSTSEL);\r\nstv0367_writebits(state, F367CAB_AGC_ACCUMRSTSEL, 0x0);\r\nstv0367_writebits(state, F367CAB_MODULUSMAP_EN, 0);\r\nstv0367_writebits(state, F367CAB_SWEEP_EN, 0);\r\nstv0367cab_set_derot_freq(state, cab_state->adc_clk,\r\n(1000 * (s32)state->config->if_khz + cab_state->derot_offset));\r\nif ((p->symbol_rate > 10800000) | (p->symbol_rate < 1800000)) {\r\nstv0367_writebits(state, F367CAB_ADJ_EN, 0);\r\nstv0367_writebits(state, F367CAB_ALLPASSFILT_EN, 0);\r\n}\r\n#if 0\r\ntuner_lock = stv0367cab_tuner_get_status(fe);\r\nif (tuner_lock == 0)\r\nreturn FE_367CAB_NOTUNER;\r\n#endif\r\nLockTime = 0;\r\nstv0367_writereg(state, R367CAB_CTRL_1, 0x00);\r\ndo {\r\nQAM_Lock = stv0367_readbits(state, F367CAB_FSM_STATUS);\r\nif ((LockTime >= (DemodTimeOut - EQLTimeOut)) &&\r\n(QAM_Lock == 0x04))\r\nLockTime = DemodTimeOut;\r\nelse if ((LockTime >= (AGCTimeOut + TRLTimeOut)) &&\r\n(QAM_Lock == 0x02))\r\n{\r\nLockTime = DemodTimeOut;\r\nu32_tmp = stv0367_readbits(state,\r\nF367CAB_AGC_PWR_WORD_LO) +\r\n(stv0367_readbits(state,\r\nF367CAB_AGC_PWR_WORD_ME) << 8) +\r\n(stv0367_readbits(state,\r\nF367CAB_AGC_PWR_WORD_HI) << 16);\r\nif (u32_tmp >= 131072)\r\nu32_tmp = 262144 - u32_tmp;\r\nu32_tmp = u32_tmp / (1 << (11 - stv0367_readbits(state,\r\nF367CAB_AGC_IF_BWSEL)));\r\nif (u32_tmp < stv0367_readbits(state,\r\nF367CAB_AGC_PWRREF_LO) +\r\n256 * stv0367_readbits(state,\r\nF367CAB_AGC_PWRREF_HI) - 10)\r\nQAM_Lock = 0x0f;\r\n} else {\r\nusleep_range(10000, 20000);\r\nLockTime += 10;\r\n}\r\ndprintk("QAM_Lock=0x%x LockTime=%d\n", QAM_Lock, LockTime);\r\ntmp = stv0367_readreg(state, R367CAB_IT_STATUS1);\r\ndprintk("R367CAB_IT_STATUS1=0x%x\n", tmp);\r\n} while (((QAM_Lock != 0x0c) && (QAM_Lock != 0x0b)) &&\r\n(LockTime < DemodTimeOut));\r\ndprintk("QAM_Lock=0x%x\n", QAM_Lock);\r\ntmp = stv0367_readreg(state, R367CAB_IT_STATUS1);\r\ndprintk("R367CAB_IT_STATUS1=0x%x\n", tmp);\r\ntmp = stv0367_readreg(state, R367CAB_IT_STATUS2);\r\ndprintk("R367CAB_IT_STATUS2=0x%x\n", tmp);\r\ntmp = stv0367cab_get_derot_freq(state, cab_state->adc_clk);\r\ndprintk("stv0367cab_get_derot_freq=0x%x\n", tmp);\r\nif ((QAM_Lock == 0x0c) || (QAM_Lock == 0x0b)) {\r\nLockTime = 0;\r\ndo {\r\nusleep_range(5000, 7000);\r\nLockTime += 5;\r\nQAMFEC_Lock = stv0367_readbits(state,\r\nF367CAB_QAMFEC_LOCK);\r\n} while (!QAMFEC_Lock && (LockTime < FECTimeOut));\r\n} else\r\nQAMFEC_Lock = 0;\r\nif (QAMFEC_Lock) {\r\nsignalType = FE_CAB_DATAOK;\r\ncab_state->modulation = p->modulation;\r\ncab_state->spect_inv = stv0367_readbits(state,\r\nF367CAB_QUAD_INV);\r\n#if 0\r\nif (state->config->if_khz != 0) {\r\nif (state->config->if_khz > cab_state->adc_clk / 1000) {\r\ncab_state->freq_khz =\r\nFE_Cab_TunerGetFrequency(pIntParams->hTuner)\r\n- stv0367cab_get_derot_freq(state, cab_state->adc_clk)\r\n- cab_state->adc_clk / 1000 + state->config->if_khz;\r\n} else {\r\ncab_state->freq_khz =\r\nFE_Cab_TunerGetFrequency(pIntParams->hTuner)\r\n- stv0367cab_get_derot_freq(state, cab_state->adc_clk)\r\n+ state->config->if_khz;\r\n}\r\n} else {\r\ncab_state->freq_khz =\r\nFE_Cab_TunerGetFrequency(pIntParams->hTuner) +\r\nstv0367cab_get_derot_freq(state,\r\ncab_state->adc_clk) -\r\ncab_state->adc_clk / 4000;\r\n}\r\n#endif\r\ncab_state->symbol_rate = stv0367cab_GetSymbolRate(state,\r\ncab_state->mclk);\r\ncab_state->locked = 1;\r\n} else {\r\nswitch (QAM_Lock) {\r\ncase 1:\r\nsignalType = FE_CAB_NOAGC;\r\nbreak;\r\ncase 2:\r\nsignalType = FE_CAB_NOTIMING;\r\nbreak;\r\ncase 3:\r\nsignalType = FE_CAB_TIMINGOK;\r\nbreak;\r\ncase 4:\r\nsignalType = FE_CAB_NOCARRIER;\r\nbreak;\r\ncase 5:\r\nsignalType = FE_CAB_CARRIEROK;\r\nbreak;\r\ncase 7:\r\nsignalType = FE_CAB_NOBLIND;\r\nbreak;\r\ncase 8:\r\nsignalType = FE_CAB_BLINDOK;\r\nbreak;\r\ncase 10:\r\nsignalType = FE_CAB_NODEMOD;\r\nbreak;\r\ncase 11:\r\nsignalType = FE_CAB_DEMODOK;\r\nbreak;\r\ncase 12:\r\nsignalType = FE_CAB_DEMODOK;\r\nbreak;\r\ncase 13:\r\nsignalType = FE_CAB_NODEMOD;\r\nbreak;\r\ncase 14:\r\nsignalType = FE_CAB_NOBLIND;\r\nbreak;\r\ncase 15:\r\nsignalType = FE_CAB_NOSIGNAL;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstv0367_writebits(state, F367CAB_AGC_ACCUMRSTSEL, TrackAGCAccum);\r\nreturn signalType;\r\n}\r\nstatic int stv0367cab_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367cab_state *cab_state = state->cab_state;\r\nenum stv0367cab_mod QAMSize = 0;\r\ndprintk("%s: freq = %d, srate = %d\n", __func__,\r\np->frequency, p->symbol_rate);\r\ncab_state->derot_offset = 0;\r\nswitch (p->modulation) {\r\ncase QAM_16:\r\nQAMSize = FE_CAB_MOD_QAM16;\r\nbreak;\r\ncase QAM_32:\r\nQAMSize = FE_CAB_MOD_QAM32;\r\nbreak;\r\ncase QAM_64:\r\nQAMSize = FE_CAB_MOD_QAM64;\r\nbreak;\r\ncase QAM_128:\r\nQAMSize = FE_CAB_MOD_QAM128;\r\nbreak;\r\ncase QAM_256:\r\nQAMSize = FE_CAB_MOD_QAM256;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nstv0367cab_init(fe);\r\nif (fe->ops.tuner_ops.set_params) {\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 1);\r\nfe->ops.tuner_ops.set_params(fe);\r\nif (fe->ops.i2c_gate_ctrl)\r\nfe->ops.i2c_gate_ctrl(fe, 0);\r\n}\r\nstv0367cab_SetQamSize(\r\nstate,\r\np->symbol_rate,\r\nQAMSize);\r\nstv0367cab_set_srate(state,\r\ncab_state->adc_clk,\r\ncab_state->mclk,\r\np->symbol_rate,\r\nQAMSize);\r\ncab_state->state = stv0367cab_algo(state, p);\r\nreturn 0;\r\n}\r\nstatic int stv0367cab_get_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *p = &fe->dtv_property_cache;\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nstruct stv0367cab_state *cab_state = state->cab_state;\r\nenum stv0367cab_mod QAMSize;\r\ndprintk("%s:\n", __func__);\r\np->symbol_rate = stv0367cab_GetSymbolRate(state, cab_state->mclk);\r\nQAMSize = stv0367_readbits(state, F367CAB_QAM_MODE);\r\nswitch (QAMSize) {\r\ncase FE_CAB_MOD_QAM16:\r\np->modulation = QAM_16;\r\nbreak;\r\ncase FE_CAB_MOD_QAM32:\r\np->modulation = QAM_32;\r\nbreak;\r\ncase FE_CAB_MOD_QAM64:\r\np->modulation = QAM_64;\r\nbreak;\r\ncase FE_CAB_MOD_QAM128:\r\np->modulation = QAM_128;\r\nbreak;\r\ncase QAM_256:\r\np->modulation = QAM_256;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\np->frequency = stv0367_get_tuner_freq(fe);\r\ndprintk("%s: tuner frequency = %d\n", __func__, p->frequency);\r\nif (state->config->if_khz == 0) {\r\np->frequency +=\r\n(stv0367cab_get_derot_freq(state, cab_state->adc_clk) -\r\ncab_state->adc_clk / 4000);\r\nreturn 0;\r\n}\r\nif (state->config->if_khz > cab_state->adc_clk / 1000)\r\np->frequency += (state->config->if_khz\r\n- stv0367cab_get_derot_freq(state, cab_state->adc_clk)\r\n- cab_state->adc_clk / 1000);\r\nelse\r\np->frequency += (state->config->if_khz\r\n- stv0367cab_get_derot_freq(state, cab_state->adc_clk));\r\nreturn 0;\r\n}\r\nstatic s32 stv0367cab_get_rf_lvl(struct stv0367_state *state)\r\n{\r\ns32 rfLevel = 0;\r\ns32 RfAgcPwm = 0, IfAgcPwm = 0;\r\nu8 i;\r\nstv0367_writebits(state, F367CAB_STDBY_ADCGP, 0x0);\r\nRfAgcPwm =\r\n(stv0367_readbits(state, F367CAB_RF_AGC1_LEVEL_LO) & 0x03) +\r\n(stv0367_readbits(state, F367CAB_RF_AGC1_LEVEL_HI) << 2);\r\nRfAgcPwm = 100 * RfAgcPwm / 1023;\r\nIfAgcPwm =\r\nstv0367_readbits(state, F367CAB_AGC_IF_PWMCMD_LO) +\r\n(stv0367_readbits(state, F367CAB_AGC_IF_PWMCMD_HI) << 8);\r\nif (IfAgcPwm >= 2048)\r\nIfAgcPwm -= 2048;\r\nelse\r\nIfAgcPwm += 2048;\r\nIfAgcPwm = 100 * IfAgcPwm / 4095;\r\nif (RfAgcPwm < 90 && IfAgcPwm < 28) {\r\nfor (i = 0; i < RF_LOOKUP_TABLE_SIZE; i++) {\r\nif (RfAgcPwm <= stv0367cab_RF_LookUp1[0][i]) {\r\nrfLevel = (-1) * stv0367cab_RF_LookUp1[1][i];\r\nbreak;\r\n}\r\n}\r\nif (i == RF_LOOKUP_TABLE_SIZE)\r\nrfLevel = -56;\r\n} else {\r\nfor (i = 0; i < RF_LOOKUP_TABLE2_SIZE; i++) {\r\nif (IfAgcPwm <= stv0367cab_RF_LookUp2[0][i]) {\r\nrfLevel = (-1) * stv0367cab_RF_LookUp2[1][i];\r\nbreak;\r\n}\r\n}\r\nif (i == RF_LOOKUP_TABLE2_SIZE)\r\nrfLevel = -72;\r\n}\r\nreturn rfLevel;\r\n}\r\nstatic int stv0367cab_read_strength(struct dvb_frontend *fe, u16 *strength)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\ns32 signal = stv0367cab_get_rf_lvl(state);\r\ndprintk("%s: signal=%d dBm\n", __func__, signal);\r\nif (signal <= -72)\r\n*strength = 65535;\r\nelse\r\n*strength = (22 + signal) * (-1311);\r\ndprintk("%s: strength=%d\n", __func__, (*strength));\r\nreturn 0;\r\n}\r\nstatic int stv0367cab_read_snr(struct dvb_frontend *fe, u16 *snr)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nu32 noisepercentage;\r\nenum stv0367cab_mod QAMSize;\r\nu32 regval = 0, temp = 0;\r\nint power, i;\r\nQAMSize = stv0367_readbits(state, F367CAB_QAM_MODE);\r\nswitch (QAMSize) {\r\ncase FE_CAB_MOD_QAM4:\r\npower = 21904;\r\nbreak;\r\ncase FE_CAB_MOD_QAM16:\r\npower = 20480;\r\nbreak;\r\ncase FE_CAB_MOD_QAM32:\r\npower = 23040;\r\nbreak;\r\ncase FE_CAB_MOD_QAM64:\r\npower = 21504;\r\nbreak;\r\ncase FE_CAB_MOD_QAM128:\r\npower = 23616;\r\nbreak;\r\ncase FE_CAB_MOD_QAM256:\r\npower = 21760;\r\nbreak;\r\ncase FE_CAB_MOD_QAM512:\r\npower = 1;\r\nbreak;\r\ncase FE_CAB_MOD_QAM1024:\r\npower = 21280;\r\nbreak;\r\ndefault:\r\npower = 1;\r\nbreak;\r\n}\r\nfor (i = 0; i < 10; i++) {\r\nregval += (stv0367_readbits(state, F367CAB_SNR_LO)\r\n+ 256 * stv0367_readbits(state, F367CAB_SNR_HI));\r\n}\r\nregval /= 10;\r\nif (regval != 0) {\r\ntemp = power\r\n* (1 << (3 + stv0367_readbits(state, F367CAB_SNR_PER)));\r\ntemp /= regval;\r\n}\r\nif (temp >= 5012)\r\nnoisepercentage = 100;\r\nelse if (temp >= 3981)\r\nnoisepercentage = 93;\r\nelse if (temp >= 3162)\r\nnoisepercentage = 86;\r\nelse if (temp >= 2512)\r\nnoisepercentage = 79;\r\nelse if (temp >= 1995)\r\nnoisepercentage = 72;\r\nelse if (temp >= 1585)\r\nnoisepercentage = 65;\r\nelse if (temp >= 1259)\r\nnoisepercentage = 58;\r\nelse if (temp >= 1000)\r\nnoisepercentage = 50;\r\nelse if (temp >= 794)\r\nnoisepercentage = 43;\r\nelse if (temp >= 501)\r\nnoisepercentage = 36;\r\nelse if (temp >= 316)\r\nnoisepercentage = 29;\r\nelse if (temp >= 200)\r\nnoisepercentage = 22;\r\nelse if (temp >= 158)\r\nnoisepercentage = 14;\r\nelse if (temp >= 126)\r\nnoisepercentage = 7;\r\nelse\r\nnoisepercentage = 0;\r\ndprintk("%s: noisepercentage=%d\n", __func__, noisepercentage);\r\n*snr = (noisepercentage * 65535) / 100;\r\nreturn 0;\r\n}\r\nstatic int stv0367cab_read_ucblcks(struct dvb_frontend *fe, u32 *ucblocks)\r\n{\r\nstruct stv0367_state *state = fe->demodulator_priv;\r\nint corrected, tscount;\r\n*ucblocks = (stv0367_readreg(state, R367CAB_RS_COUNTER_5) << 8)\r\n| stv0367_readreg(state, R367CAB_RS_COUNTER_4);\r\ncorrected = (stv0367_readreg(state, R367CAB_RS_COUNTER_3) << 8)\r\n| stv0367_readreg(state, R367CAB_RS_COUNTER_2);\r\ntscount = (stv0367_readreg(state, R367CAB_RS_COUNTER_2) << 8)\r\n| stv0367_readreg(state, R367CAB_RS_COUNTER_1);\r\ndprintk("%s: uncorrected blocks=%d corrected blocks=%d tscount=%d\n",\r\n__func__, *ucblocks, corrected, tscount);\r\nreturn 0;\r\n}\r\nstruct dvb_frontend *stv0367cab_attach(const struct stv0367_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct stv0367_state *state = NULL;\r\nstruct stv0367cab_state *cab_state = NULL;\r\nstate = kzalloc(sizeof(struct stv0367_state), GFP_KERNEL);\r\nif (state == NULL)\r\ngoto error;\r\ncab_state = kzalloc(sizeof(struct stv0367cab_state), GFP_KERNEL);\r\nif (cab_state == NULL)\r\ngoto error;\r\nstate->i2c = i2c;\r\nstate->config = config;\r\ncab_state->search_range = 280000;\r\nstate->cab_state = cab_state;\r\nstate->fe.ops = stv0367cab_ops;\r\nstate->fe.demodulator_priv = state;\r\nstate->chip_id = stv0367_readreg(state, 0xf000);\r\ndprintk("%s: chip_id = 0x%x\n", __func__, state->chip_id);\r\nif ((state->chip_id != 0x50) && (state->chip_id != 0x60))\r\ngoto error;\r\nreturn &state->fe;\r\nerror:\r\nkfree(cab_state);\r\nkfree(state);\r\nreturn NULL;\r\n}

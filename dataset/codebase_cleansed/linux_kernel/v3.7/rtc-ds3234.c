static int ds3234_set_reg(struct device *dev, unsigned char address,\r\nunsigned char data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char buf[2];\r\nbuf[0] = address | 0x80;\r\nbuf[1] = data;\r\nreturn spi_write_then_read(spi, buf, 2, NULL, 0);\r\n}\r\nstatic int ds3234_get_reg(struct device *dev, unsigned char address,\r\nunsigned char *data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\n*data = address & 0x7f;\r\nreturn spi_write_then_read(spi, data, 1, data, 1);\r\n}\r\nstatic int ds3234_read_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nint err;\r\nunsigned char buf[8];\r\nstruct spi_device *spi = to_spi_device(dev);\r\nbuf[0] = 0x00;\r\nerr = spi_write_then_read(spi, buf, 1, buf, 8);\r\nif (err != 0)\r\nreturn err;\r\ndt->tm_sec = bcd2bin(buf[0]);\r\ndt->tm_min = bcd2bin(buf[1]);\r\ndt->tm_hour = bcd2bin(buf[2] & 0x3f);\r\ndt->tm_wday = bcd2bin(buf[3]) - 1;\r\ndt->tm_mday = bcd2bin(buf[4]);\r\ndt->tm_mon = bcd2bin(buf[5] & 0x1f) - 1;\r\ndt->tm_year = bcd2bin(buf[6] & 0xff) + 100;\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int ds3234_set_time(struct device *dev, struct rtc_time *dt)\r\n{\r\nds3234_set_reg(dev, DS3234_REG_SECONDS, bin2bcd(dt->tm_sec));\r\nds3234_set_reg(dev, DS3234_REG_MINUTES, bin2bcd(dt->tm_min));\r\nds3234_set_reg(dev, DS3234_REG_HOURS, bin2bcd(dt->tm_hour) & 0x3f);\r\nds3234_set_reg(dev, DS3234_REG_DAY, bin2bcd(dt->tm_wday + 1));\r\nds3234_set_reg(dev, DS3234_REG_DATE, bin2bcd(dt->tm_mday));\r\nds3234_set_reg(dev, DS3234_REG_MONTH, bin2bcd(dt->tm_mon + 1));\r\nif (dt->tm_year > 100)\r\ndt->tm_year -= 100;\r\nds3234_set_reg(dev, DS3234_REG_YEAR, bin2bcd(dt->tm_year));\r\nreturn 0;\r\n}\r\nstatic int __devinit ds3234_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nunsigned char tmp;\r\nint res;\r\nspi->mode = SPI_MODE_3;\r\nspi->bits_per_word = 8;\r\nspi_setup(spi);\r\nres = ds3234_get_reg(&spi->dev, DS3234_REG_SECONDS, &tmp);\r\nif (res != 0)\r\nreturn res;\r\nds3234_get_reg(&spi->dev, DS3234_REG_CONTROL, &tmp);\r\nds3234_set_reg(&spi->dev, DS3234_REG_CONTROL, tmp & 0x1c);\r\nds3234_get_reg(&spi->dev, DS3234_REG_CONT_STAT, &tmp);\r\nds3234_set_reg(&spi->dev, DS3234_REG_CONT_STAT, tmp & 0x88);\r\nds3234_get_reg(&spi->dev, DS3234_REG_CONTROL, &tmp);\r\ndev_info(&spi->dev, "Control Reg: 0x%02x\n", tmp);\r\nds3234_get_reg(&spi->dev, DS3234_REG_CONT_STAT, &tmp);\r\ndev_info(&spi->dev, "Ctrl/Stat Reg: 0x%02x\n", tmp);\r\nrtc = rtc_device_register("ds3234",\r\n&spi->dev, &ds3234_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ndev_set_drvdata(&spi->dev, rtc);\r\nreturn 0;\r\n}\r\nstatic int __devexit ds3234_remove(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc = spi_get_drvdata(spi);\r\nrtc_device_unregister(rtc);\r\nreturn 0;\r\n}

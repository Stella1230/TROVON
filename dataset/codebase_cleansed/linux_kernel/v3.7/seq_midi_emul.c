void\r\nsnd_midi_process_event(struct snd_midi_op *ops,\r\nstruct snd_seq_event *ev,\r\nstruct snd_midi_channel_set *chanset)\r\n{\r\nstruct snd_midi_channel *chan;\r\nvoid *drv;\r\nint dest_channel = 0;\r\nif (ev == NULL || chanset == NULL) {\r\nsnd_printd("ev or chanbase NULL (snd_midi_process_event)\n");\r\nreturn;\r\n}\r\nif (chanset->channels == NULL)\r\nreturn;\r\nif (snd_seq_ev_is_channel_type(ev)) {\r\ndest_channel = ev->data.note.channel;\r\nif (dest_channel >= chanset->max_channels) {\r\nsnd_printd("dest channel is %d, max is %d\n",\r\ndest_channel, chanset->max_channels);\r\nreturn;\r\n}\r\n}\r\nchan = chanset->channels + dest_channel;\r\ndrv = chanset->private_data;\r\nif (ev->type == SNDRV_SEQ_EVENT_NOTE)\r\nreturn;\r\nif (ev->type == SNDRV_SEQ_EVENT_NOTEON && ev->data.note.velocity == 0)\r\nev->type = SNDRV_SEQ_EVENT_NOTEOFF;\r\nif (ev->type == SNDRV_SEQ_EVENT_NOTEON ||\r\nev->type == SNDRV_SEQ_EVENT_NOTEOFF ||\r\nev->type == SNDRV_SEQ_EVENT_KEYPRESS) {\r\nif (ev->data.note.note >= 128)\r\nreturn;\r\n}\r\nswitch (ev->type) {\r\ncase SNDRV_SEQ_EVENT_NOTEON:\r\nif (chan->note[ev->data.note.note] & SNDRV_MIDI_NOTE_ON) {\r\nif (ops->note_off)\r\nops->note_off(drv, ev->data.note.note, 0, chan);\r\n}\r\nchan->note[ev->data.note.note] = SNDRV_MIDI_NOTE_ON;\r\nif (ops->note_on)\r\nops->note_on(drv, ev->data.note.note, ev->data.note.velocity, chan);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_NOTEOFF:\r\nif (! (chan->note[ev->data.note.note] & SNDRV_MIDI_NOTE_ON))\r\nbreak;\r\nif (ops->note_off)\r\nnote_off(ops, drv, chan, ev->data.note.note, ev->data.note.velocity);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_KEYPRESS:\r\nif (ops->key_press)\r\nops->key_press(drv, ev->data.note.note, ev->data.note.velocity, chan);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_CONTROLLER:\r\ndo_control(ops, drv, chanset, chan,\r\nev->data.control.param, ev->data.control.value);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_PGMCHANGE:\r\nchan->midi_program = ev->data.control.value;\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_PITCHBEND:\r\nchan->midi_pitchbend = ev->data.control.value;\r\nif (ops->control)\r\nops->control(drv, MIDI_CTL_PITCHBEND, chan);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_CHANPRESS:\r\nchan->midi_pressure = ev->data.control.value;\r\nif (ops->control)\r\nops->control(drv, MIDI_CTL_CHAN_PRESSURE, chan);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_CONTROL14:\r\nif (ev->data.control.param < 32) {\r\nchan->control[ev->data.control.param + 32] =\r\nev->data.control.value & 0x7f;\r\ndo_control(ops, drv, chanset, chan,\r\nev->data.control.param,\r\n((ev->data.control.value>>7) & 0x7f));\r\n} else\r\ndo_control(ops, drv, chanset, chan,\r\nev->data.control.param,\r\nev->data.control.value);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_NONREGPARAM:\r\nchan->param_type = SNDRV_MIDI_PARAM_TYPE_NONREGISTERED;\r\nchan->control[MIDI_CTL_MSB_DATA_ENTRY]\r\n= (ev->data.control.value >> 7) & 0x7f;\r\nchan->control[MIDI_CTL_LSB_DATA_ENTRY]\r\n= ev->data.control.value & 0x7f;\r\nchan->control[MIDI_CTL_NONREG_PARM_NUM_MSB]\r\n= (ev->data.control.param >> 7) & 0x7f;\r\nchan->control[MIDI_CTL_NONREG_PARM_NUM_LSB]\r\n= ev->data.control.param & 0x7f;\r\nnrpn(ops, drv, chan, chanset);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_REGPARAM:\r\nchan->param_type = SNDRV_MIDI_PARAM_TYPE_REGISTERED;\r\nchan->control[MIDI_CTL_MSB_DATA_ENTRY]\r\n= (ev->data.control.value >> 7) & 0x7f;\r\nchan->control[MIDI_CTL_LSB_DATA_ENTRY]\r\n= ev->data.control.value & 0x7f;\r\nchan->control[MIDI_CTL_REGIST_PARM_NUM_MSB]\r\n= (ev->data.control.param >> 7) & 0x7f;\r\nchan->control[MIDI_CTL_REGIST_PARM_NUM_LSB]\r\n= ev->data.control.param & 0x7f;\r\nrpn(ops, drv, chan, chanset);\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_SYSEX:\r\nif ((ev->flags & SNDRV_SEQ_EVENT_LENGTH_MASK) == SNDRV_SEQ_EVENT_LENGTH_VARIABLE) {\r\nunsigned char sysexbuf[64];\r\nint len;\r\nlen = snd_seq_expand_var_event(ev, sizeof(sysexbuf), sysexbuf, 1, 0);\r\nif (len > 0)\r\nsysex(ops, drv, sysexbuf, len, chanset);\r\n}\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_SONGPOS:\r\ncase SNDRV_SEQ_EVENT_SONGSEL:\r\ncase SNDRV_SEQ_EVENT_CLOCK:\r\ncase SNDRV_SEQ_EVENT_START:\r\ncase SNDRV_SEQ_EVENT_CONTINUE:\r\ncase SNDRV_SEQ_EVENT_STOP:\r\ncase SNDRV_SEQ_EVENT_QFRAME:\r\ncase SNDRV_SEQ_EVENT_TEMPO:\r\ncase SNDRV_SEQ_EVENT_TIMESIGN:\r\ncase SNDRV_SEQ_EVENT_KEYSIGN:\r\ngoto not_yet;\r\ncase SNDRV_SEQ_EVENT_SENSING:\r\nbreak;\r\ncase SNDRV_SEQ_EVENT_CLIENT_START:\r\ncase SNDRV_SEQ_EVENT_CLIENT_EXIT:\r\ncase SNDRV_SEQ_EVENT_CLIENT_CHANGE:\r\ncase SNDRV_SEQ_EVENT_PORT_START:\r\ncase SNDRV_SEQ_EVENT_PORT_EXIT:\r\ncase SNDRV_SEQ_EVENT_PORT_CHANGE:\r\ncase SNDRV_SEQ_EVENT_ECHO:\r\nnot_yet:\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void\r\nnote_off(struct snd_midi_op *ops, void *drv, struct snd_midi_channel *chan,\r\nint note, int vel)\r\n{\r\nif (chan->gm_hold) {\r\nchan->note[note] |= SNDRV_MIDI_NOTE_RELEASED;\r\n} else if (chan->note[note] & SNDRV_MIDI_NOTE_SOSTENUTO) {\r\nchan->note[note] |= SNDRV_MIDI_NOTE_RELEASED;\r\n} else {\r\nchan->note[note] = 0;\r\nif (ops->note_off)\r\nops->note_off(drv, note, vel, chan);\r\n}\r\n}\r\nstatic void\r\ndo_control(struct snd_midi_op *ops, void *drv, struct snd_midi_channel_set *chset,\r\nstruct snd_midi_channel *chan, int control, int value)\r\n{\r\nint i;\r\nif ((control >=64 && control <=69) || (control >= 80 && control <= 83)) {\r\nvalue = (value >= 64)? 127: 0;\r\n}\r\nchan->control[control] = value;\r\nswitch (control) {\r\ncase MIDI_CTL_SUSTAIN:\r\nif (value == 0) {\r\nfor (i = 0; i < 128; i++) {\r\nif (chan->note[i] & SNDRV_MIDI_NOTE_RELEASED) {\r\nchan->note[i] = SNDRV_MIDI_NOTE_OFF;\r\nif (ops->note_off)\r\nops->note_off(drv, i, 0, chan);\r\n}\r\n}\r\n}\r\nbreak;\r\ncase MIDI_CTL_PORTAMENTO:\r\nbreak;\r\ncase MIDI_CTL_SOSTENUTO:\r\nif (value) {\r\nfor (i = 0; i < 128; i++) {\r\nif (chan->note[i] & SNDRV_MIDI_NOTE_ON)\r\nchan->note[i] |= SNDRV_MIDI_NOTE_SOSTENUTO;\r\n}\r\n} else {\r\nfor (i = 0; i < 128; i++) {\r\nif (chan->note[i] & SNDRV_MIDI_NOTE_SOSTENUTO) {\r\nchan->note[i] &= ~SNDRV_MIDI_NOTE_SOSTENUTO;\r\nif (chan->note[i] & SNDRV_MIDI_NOTE_RELEASED) {\r\nchan->note[i] = SNDRV_MIDI_NOTE_OFF;\r\nif (ops->note_off)\r\nops->note_off(drv, i, 0, chan);\r\n}\r\n}\r\n}\r\n}\r\nbreak;\r\ncase MIDI_CTL_MSB_DATA_ENTRY:\r\nchan->control[MIDI_CTL_LSB_DATA_ENTRY] = 0;\r\ncase MIDI_CTL_LSB_DATA_ENTRY:\r\nif (chan->param_type == SNDRV_MIDI_PARAM_TYPE_REGISTERED)\r\nrpn(ops, drv, chan, chset);\r\nelse\r\nnrpn(ops, drv, chan, chset);\r\nbreak;\r\ncase MIDI_CTL_REGIST_PARM_NUM_LSB:\r\ncase MIDI_CTL_REGIST_PARM_NUM_MSB:\r\nchan->param_type = SNDRV_MIDI_PARAM_TYPE_REGISTERED;\r\nbreak;\r\ncase MIDI_CTL_NONREG_PARM_NUM_LSB:\r\ncase MIDI_CTL_NONREG_PARM_NUM_MSB:\r\nchan->param_type = SNDRV_MIDI_PARAM_TYPE_NONREGISTERED;\r\nbreak;\r\ncase MIDI_CTL_ALL_SOUNDS_OFF:\r\nall_sounds_off(ops, drv, chan);\r\nbreak;\r\ncase MIDI_CTL_ALL_NOTES_OFF:\r\nall_notes_off(ops, drv, chan);\r\nbreak;\r\ncase MIDI_CTL_MSB_BANK:\r\nif (chset->midi_mode == SNDRV_MIDI_MODE_XG) {\r\nif (value == 127)\r\nchan->drum_channel = 1;\r\nelse\r\nchan->drum_channel = 0;\r\n}\r\nbreak;\r\ncase MIDI_CTL_LSB_BANK:\r\nbreak;\r\ncase MIDI_CTL_RESET_CONTROLLERS:\r\nsnd_midi_reset_controllers(chan);\r\nbreak;\r\ncase MIDI_CTL_SOFT_PEDAL:\r\ncase MIDI_CTL_LEGATO_FOOTSWITCH:\r\ncase MIDI_CTL_HOLD2:\r\ncase MIDI_CTL_SC1_SOUND_VARIATION:\r\ncase MIDI_CTL_SC2_TIMBRE:\r\ncase MIDI_CTL_SC3_RELEASE_TIME:\r\ncase MIDI_CTL_SC4_ATTACK_TIME:\r\ncase MIDI_CTL_SC5_BRIGHTNESS:\r\ncase MIDI_CTL_E1_REVERB_DEPTH:\r\ncase MIDI_CTL_E2_TREMOLO_DEPTH:\r\ncase MIDI_CTL_E3_CHORUS_DEPTH:\r\ncase MIDI_CTL_E4_DETUNE_DEPTH:\r\ncase MIDI_CTL_E5_PHASER_DEPTH:\r\ngoto notyet;\r\nnotyet:\r\ndefault:\r\nif (ops->control)\r\nops->control(drv, control, chan);\r\nbreak;\r\n}\r\n}\r\nvoid\r\nsnd_midi_channel_set_clear(struct snd_midi_channel_set *chset)\r\n{\r\nint i;\r\nchset->midi_mode = SNDRV_MIDI_MODE_GM;\r\nchset->gs_master_volume = 127;\r\nfor (i = 0; i < chset->max_channels; i++) {\r\nstruct snd_midi_channel *chan = chset->channels + i;\r\nmemset(chan->note, 0, sizeof(chan->note));\r\nchan->midi_aftertouch = 0;\r\nchan->midi_pressure = 0;\r\nchan->midi_program = 0;\r\nchan->midi_pitchbend = 0;\r\nsnd_midi_reset_controllers(chan);\r\nchan->gm_rpn_pitch_bend_range = 256;\r\nchan->gm_rpn_fine_tuning = 0;\r\nchan->gm_rpn_coarse_tuning = 0;\r\nif (i == 9)\r\nchan->drum_channel = 1;\r\nelse\r\nchan->drum_channel = 0;\r\n}\r\n}\r\nstatic void\r\nrpn(struct snd_midi_op *ops, void *drv, struct snd_midi_channel *chan,\r\nstruct snd_midi_channel_set *chset)\r\n{\r\nint type;\r\nint val;\r\nif (chset->midi_mode != SNDRV_MIDI_MODE_NONE) {\r\ntype = (chan->control[MIDI_CTL_REGIST_PARM_NUM_MSB] << 8) |\r\nchan->control[MIDI_CTL_REGIST_PARM_NUM_LSB];\r\nval = (chan->control[MIDI_CTL_MSB_DATA_ENTRY] << 7) |\r\nchan->control[MIDI_CTL_LSB_DATA_ENTRY];\r\nswitch (type) {\r\ncase 0x0000:\r\nchan->gm_rpn_pitch_bend_range = val;\r\nbreak;\r\ncase 0x0001:\r\nchan->gm_rpn_fine_tuning = val - 8192;\r\nbreak;\r\ncase 0x0002:\r\nchan->gm_rpn_coarse_tuning = val - 8192;\r\nbreak;\r\ncase 0x7F7F:\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void\r\nnrpn(struct snd_midi_op *ops, void *drv, struct snd_midi_channel *chan,\r\nstruct snd_midi_channel_set *chset)\r\n{\r\nif (ops->nrpn)\r\nops->nrpn(drv, chan, chset);\r\n}\r\nstatic int\r\nget_channel(unsigned char cmd)\r\n{\r\nint p = cmd & 0x0f;\r\nif (p == 0)\r\np = 9;\r\nelse if (p < 10)\r\np--;\r\nreturn p;\r\n}\r\nstatic void\r\nsysex(struct snd_midi_op *ops, void *private, unsigned char *buf, int len,\r\nstruct snd_midi_channel_set *chset)\r\n{\r\nstatic unsigned char gm_on_macro[] = {\r\n0x7e,0x7f,0x09,0x01,\r\n};\r\nstatic unsigned char xg_on_macro[] = {\r\n0x43,0x10,0x4c,0x00,0x00,0x7e,0x00,\r\n};\r\nstatic unsigned char gs_pfx_macro[] = {\r\n0x41,0x10,0x42,0x12,0x40,\r\n};\r\nint parsed = SNDRV_MIDI_SYSEX_NOT_PARSED;\r\nif (len <= 0 || buf[0] != 0xf0)\r\nreturn;\r\nbuf++;\r\nlen--;\r\nif (len >= (int)sizeof(gm_on_macro) &&\r\nmemcmp(buf, gm_on_macro, sizeof(gm_on_macro)) == 0) {\r\nif (chset->midi_mode != SNDRV_MIDI_MODE_GS &&\r\nchset->midi_mode != SNDRV_MIDI_MODE_XG) {\r\nchset->midi_mode = SNDRV_MIDI_MODE_GM;\r\nreset_all_channels(chset);\r\nparsed = SNDRV_MIDI_SYSEX_GM_ON;\r\n}\r\n}\r\nelse if (len >= 8 &&\r\nmemcmp(buf, gs_pfx_macro, sizeof(gs_pfx_macro)) == 0) {\r\nif (chset->midi_mode != SNDRV_MIDI_MODE_GS &&\r\nchset->midi_mode != SNDRV_MIDI_MODE_XG)\r\nchset->midi_mode = SNDRV_MIDI_MODE_GS;\r\nif (buf[5] == 0x00 && buf[6] == 0x7f && buf[7] == 0x00) {\r\nparsed = SNDRV_MIDI_SYSEX_GS_RESET;\r\nreset_all_channels(chset);\r\n}\r\nelse if ((buf[5] & 0xf0) == 0x10 && buf[6] == 0x15) {\r\nint p = get_channel(buf[5]);\r\nif (p < chset->max_channels) {\r\nparsed = SNDRV_MIDI_SYSEX_GS_DRUM_CHANNEL;\r\nif (buf[7])\r\nchset->channels[p].drum_channel = 1;\r\nelse\r\nchset->channels[p].drum_channel = 0;\r\n}\r\n} else if ((buf[5] & 0xf0) == 0x10 && buf[6] == 0x21) {\r\nint p = get_channel(buf[5]);\r\nif (p < chset->max_channels &&\r\n! chset->channels[p].drum_channel) {\r\nparsed = SNDRV_MIDI_SYSEX_GS_DRUM_CHANNEL;\r\nchset->channels[p].midi_program = buf[7];\r\n}\r\n} else if (buf[5] == 0x01 && buf[6] == 0x30) {\r\nparsed = SNDRV_MIDI_SYSEX_GS_REVERB_MODE;\r\nchset->gs_reverb_mode = buf[7];\r\n} else if (buf[5] == 0x01 && buf[6] == 0x38) {\r\nparsed = SNDRV_MIDI_SYSEX_GS_CHORUS_MODE;\r\nchset->gs_chorus_mode = buf[7];\r\n} else if (buf[5] == 0x00 && buf[6] == 0x04) {\r\nparsed = SNDRV_MIDI_SYSEX_GS_MASTER_VOLUME;\r\nchset->gs_master_volume = buf[7];\r\n}\r\n}\r\nelse if (len >= (int)sizeof(xg_on_macro) &&\r\nmemcmp(buf, xg_on_macro, sizeof(xg_on_macro)) == 0) {\r\nint i;\r\nchset->midi_mode = SNDRV_MIDI_MODE_XG;\r\nparsed = SNDRV_MIDI_SYSEX_XG_ON;\r\nfor (i = 0; i < chset->max_channels; i++) {\r\nif (chset->channels[i].drum_channel)\r\nchset->channels[i].control[MIDI_CTL_MSB_BANK] = 127;\r\nelse\r\nchset->channels[i].control[MIDI_CTL_MSB_BANK] = 0;\r\n}\r\n}\r\nif (ops->sysex)\r\nops->sysex(private, buf - 1, len + 1, parsed, chset);\r\n}\r\nstatic void\r\nall_sounds_off(struct snd_midi_op *ops, void *drv, struct snd_midi_channel *chan)\r\n{\r\nint n;\r\nif (! ops->note_terminate)\r\nreturn;\r\nfor (n = 0; n < 128; n++) {\r\nif (chan->note[n]) {\r\nops->note_terminate(drv, n, chan);\r\nchan->note[n] = 0;\r\n}\r\n}\r\n}\r\nstatic void\r\nall_notes_off(struct snd_midi_op *ops, void *drv, struct snd_midi_channel *chan)\r\n{\r\nint n;\r\nif (! ops->note_off)\r\nreturn;\r\nfor (n = 0; n < 128; n++) {\r\nif (chan->note[n] == SNDRV_MIDI_NOTE_ON)\r\nnote_off(ops, drv, chan, n, 0);\r\n}\r\n}\r\nstatic void snd_midi_channel_init(struct snd_midi_channel *p, int n)\r\n{\r\nif (p == NULL)\r\nreturn;\r\nmemset(p, 0, sizeof(struct snd_midi_channel));\r\np->private = NULL;\r\np->number = n;\r\nsnd_midi_reset_controllers(p);\r\np->gm_rpn_pitch_bend_range = 256;\r\np->gm_rpn_fine_tuning = 0;\r\np->gm_rpn_coarse_tuning = 0;\r\nif (n == 9)\r\np->drum_channel = 1;\r\n}\r\nstatic struct snd_midi_channel *snd_midi_channel_init_set(int n)\r\n{\r\nstruct snd_midi_channel *chan;\r\nint i;\r\nchan = kmalloc(n * sizeof(struct snd_midi_channel), GFP_KERNEL);\r\nif (chan) {\r\nfor (i = 0; i < n; i++)\r\nsnd_midi_channel_init(chan+i, i);\r\n}\r\nreturn chan;\r\n}\r\nstatic void\r\nreset_all_channels(struct snd_midi_channel_set *chset)\r\n{\r\nint ch;\r\nfor (ch = 0; ch < chset->max_channels; ch++) {\r\nstruct snd_midi_channel *chan = chset->channels + ch;\r\nsnd_midi_reset_controllers(chan);\r\nchan->gm_rpn_pitch_bend_range = 256;\r\nchan->gm_rpn_fine_tuning = 0;\r\nchan->gm_rpn_coarse_tuning = 0;\r\nif (ch == 9)\r\nchan->drum_channel = 1;\r\nelse\r\nchan->drum_channel = 0;\r\n}\r\n}\r\nstruct snd_midi_channel_set *snd_midi_channel_alloc_set(int n)\r\n{\r\nstruct snd_midi_channel_set *chset;\r\nchset = kmalloc(sizeof(*chset), GFP_KERNEL);\r\nif (chset) {\r\nchset->channels = snd_midi_channel_init_set(n);\r\nchset->private_data = NULL;\r\nchset->max_channels = n;\r\n}\r\nreturn chset;\r\n}\r\nstatic void snd_midi_reset_controllers(struct snd_midi_channel *chan)\r\n{\r\nmemset(chan->control, 0, sizeof(chan->control));\r\nchan->gm_volume = 127;\r\nchan->gm_expression = 127;\r\nchan->gm_pan = 64;\r\n}\r\nvoid snd_midi_channel_free_set(struct snd_midi_channel_set *chset)\r\n{\r\nif (chset == NULL)\r\nreturn;\r\nkfree(chset->channels);\r\nkfree(chset);\r\n}\r\nstatic int __init alsa_seq_midi_emul_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit alsa_seq_midi_emul_exit(void)\r\n{\r\n}

static int avmcs_probe(struct pcmcia_device *p_dev)\r\n{\r\np_dev->config_flags |= CONF_ENABLE_IRQ | CONF_AUTO_SET_IO;\r\np_dev->config_index = 1;\r\np_dev->config_regs = PRESENT_OPTION;\r\nreturn avmcs_config(p_dev);\r\n}\r\nstatic void avmcs_detach(struct pcmcia_device *link)\r\n{\r\navmcs_release(link);\r\n}\r\nstatic int avmcs_configcheck(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\np_dev->resource[0]->end = 16;\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_8;\r\nreturn pcmcia_request_io(p_dev);\r\n}\r\nstatic int avmcs_config(struct pcmcia_device *link)\r\n{\r\nint i = -1;\r\nchar devname[128];\r\nint cardtype;\r\nint (*addcard)(unsigned int port, unsigned irq);\r\ndevname[0] = 0;\r\nif (link->prod_id[1])\r\nstrlcpy(devname, link->prod_id[1], sizeof(devname));\r\nif (pcmcia_loop_config(link, avmcs_configcheck, NULL))\r\nreturn -ENODEV;\r\ndo {\r\nif (!link->irq) {\r\npcmcia_disable_device(link);\r\nbreak;\r\n}\r\ni = pcmcia_enable_device(link);\r\nif (i != 0) {\r\npcmcia_disable_device(link);\r\nbreak;\r\n}\r\n} while (0);\r\nif (devname[0]) {\r\nchar *s = strrchr(devname, ' ');\r\nif (!s)\r\ns = devname;\r\nelse s++;\r\nif (strcmp("M1", s) == 0) {\r\ncardtype = AVM_CARDTYPE_M1;\r\n} else if (strcmp("M2", s) == 0) {\r\ncardtype = AVM_CARDTYPE_M2;\r\n} else {\r\ncardtype = AVM_CARDTYPE_B1;\r\n}\r\n} else\r\ncardtype = AVM_CARDTYPE_B1;\r\nif (i != 0) {\r\navmcs_release(link);\r\nreturn -ENODEV;\r\n}\r\nswitch (cardtype) {\r\ncase AVM_CARDTYPE_M1: addcard = b1pcmcia_addcard_m1; break;\r\ncase AVM_CARDTYPE_M2: addcard = b1pcmcia_addcard_m2; break;\r\ndefault:\r\ncase AVM_CARDTYPE_B1: addcard = b1pcmcia_addcard_b1; break;\r\n}\r\nif ((i = (*addcard)(link->resource[0]->start, link->irq)) < 0) {\r\ndev_err(&link->dev,\r\n"avm_cs: failed to add AVM-Controller at i/o %#x, irq %d\n",\r\n(unsigned int) link->resource[0]->start, link->irq);\r\navmcs_release(link);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void avmcs_release(struct pcmcia_device *link)\r\n{\r\nb1pcmcia_delcard(link->resource[0]->start, link->irq);\r\npcmcia_disable_device(link);\r\n}\r\nstatic int __init avmcs_init(void)\r\n{\r\nreturn pcmcia_register_driver(&avmcs_driver);\r\n}\r\nstatic void __exit avmcs_exit(void)\r\n{\r\npcmcia_unregister_driver(&avmcs_driver);\r\n}

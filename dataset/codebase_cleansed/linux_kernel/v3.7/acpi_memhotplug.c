static acpi_status\r\nacpi_memory_get_resource(struct acpi_resource *resource, void *context)\r\n{\r\nstruct acpi_memory_device *mem_device = context;\r\nstruct acpi_resource_address64 address64;\r\nstruct acpi_memory_info *info, *new;\r\nacpi_status status;\r\nstatus = acpi_resource_to_address64(resource, &address64);\r\nif (ACPI_FAILURE(status) ||\r\n(address64.resource_type != ACPI_MEMORY_RANGE))\r\nreturn AE_OK;\r\nlist_for_each_entry(info, &mem_device->res_list, list) {\r\nif ((info->caching == address64.info.mem.caching) &&\r\n(info->write_protect == address64.info.mem.write_protect) &&\r\n(info->start_addr + info->length == address64.minimum)) {\r\ninfo->length += address64.address_length;\r\nreturn AE_OK;\r\n}\r\n}\r\nnew = kzalloc(sizeof(struct acpi_memory_info), GFP_KERNEL);\r\nif (!new)\r\nreturn AE_ERROR;\r\nINIT_LIST_HEAD(&new->list);\r\nnew->caching = address64.info.mem.caching;\r\nnew->write_protect = address64.info.mem.write_protect;\r\nnew->start_addr = address64.minimum;\r\nnew->length = address64.address_length;\r\nlist_add_tail(&new->list, &mem_device->res_list);\r\nreturn AE_OK;\r\n}\r\nstatic int\r\nacpi_memory_get_device_resources(struct acpi_memory_device *mem_device)\r\n{\r\nacpi_status status;\r\nstruct acpi_memory_info *info, *n;\r\nif (!list_empty(&mem_device->res_list))\r\nreturn 0;\r\nstatus = acpi_walk_resources(mem_device->device->handle, METHOD_NAME__CRS,\r\nacpi_memory_get_resource, mem_device);\r\nif (ACPI_FAILURE(status)) {\r\nlist_for_each_entry_safe(info, n, &mem_device->res_list, list)\r\nkfree(info);\r\nINIT_LIST_HEAD(&mem_device->res_list);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int\r\nacpi_memory_get_device(acpi_handle handle,\r\nstruct acpi_memory_device **mem_device)\r\n{\r\nacpi_status status;\r\nacpi_handle phandle;\r\nstruct acpi_device *device = NULL;\r\nstruct acpi_device *pdevice = NULL;\r\nint result;\r\nif (!acpi_bus_get_device(handle, &device) && device)\r\ngoto end;\r\nstatus = acpi_get_parent(handle, &phandle);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status, "Cannot find acpi parent"));\r\nreturn -EINVAL;\r\n}\r\nresult = acpi_bus_get_device(phandle, &pdevice);\r\nif (result) {\r\nprintk(KERN_WARNING PREFIX "Cannot get acpi bus device");\r\nreturn -EINVAL;\r\n}\r\nresult = acpi_bus_add(&device, pdevice, handle, ACPI_BUS_TYPE_DEVICE);\r\nif (result) {\r\nprintk(KERN_WARNING PREFIX "Cannot add acpi bus");\r\nreturn -EINVAL;\r\n}\r\nend:\r\n*mem_device = acpi_driver_data(device);\r\nif (!(*mem_device)) {\r\nprintk(KERN_ERR "\n driver data not found");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acpi_memory_check_device(struct acpi_memory_device *mem_device)\r\n{\r\nunsigned long long current_status;\r\nif (ACPI_FAILURE(acpi_evaluate_integer(mem_device->device->handle, "_STA",\r\nNULL, &current_status)))\r\nreturn -ENODEV;\r\nif (!((current_status & ACPI_STA_DEVICE_PRESENT)\r\n&& (current_status & ACPI_STA_DEVICE_ENABLED)\r\n&& (current_status & ACPI_STA_DEVICE_FUNCTIONING)))\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int acpi_memory_enable_device(struct acpi_memory_device *mem_device)\r\n{\r\nint result, num_enabled = 0;\r\nstruct acpi_memory_info *info;\r\nint node;\r\nresult = acpi_memory_get_device_resources(mem_device);\r\nif (result) {\r\nprintk(KERN_ERR PREFIX "get_device_resources failed\n");\r\nmem_device->state = MEMORY_INVALID_STATE;\r\nreturn result;\r\n}\r\nnode = acpi_get_node(mem_device->device->handle);\r\nlist_for_each_entry(info, &mem_device->res_list, list) {\r\nif (info->enabled) {\r\nnum_enabled++;\r\ncontinue;\r\n}\r\nif (!info->length)\r\ncontinue;\r\nif (node < 0)\r\nnode = memory_add_physaddr_to_nid(info->start_addr);\r\nresult = add_memory(node, info->start_addr, info->length);\r\nif (result)\r\ncontinue;\r\ninfo->enabled = 1;\r\nnum_enabled++;\r\n}\r\nif (!num_enabled) {\r\nprintk(KERN_ERR PREFIX "add_memory failed\n");\r\nmem_device->state = MEMORY_INVALID_STATE;\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int acpi_memory_powerdown_device(struct acpi_memory_device *mem_device)\r\n{\r\nacpi_status status;\r\nstruct acpi_object_list arg_list;\r\nunion acpi_object arg;\r\nunsigned long long current_status;\r\narg_list.count = 1;\r\narg_list.pointer = &arg;\r\narg.type = ACPI_TYPE_INTEGER;\r\narg.integer.value = 1;\r\nstatus = acpi_evaluate_object(mem_device->device->handle,\r\n"_EJ0", &arg_list, NULL);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status, "_EJ0 failed"));\r\nreturn -ENODEV;\r\n}\r\nstatus = acpi_evaluate_integer(mem_device->device->handle, "_STA",\r\nNULL, &current_status);\r\nif (ACPI_FAILURE(status))\r\nreturn -ENODEV;\r\nif (current_status & ACPI_STA_DEVICE_ENABLED)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int acpi_memory_disable_device(struct acpi_memory_device *mem_device)\r\n{\r\nint result;\r\nstruct acpi_memory_info *info, *n;\r\nlist_for_each_entry_safe(info, n, &mem_device->res_list, list) {\r\nif (info->enabled) {\r\nresult = remove_memory(info->start_addr, info->length);\r\nif (result)\r\nreturn result;\r\n}\r\nkfree(info);\r\n}\r\nresult = acpi_memory_powerdown_device(mem_device);\r\nif (result) {\r\nmem_device->state = MEMORY_INVALID_STATE;\r\nreturn result;\r\n}\r\nmem_device->state = MEMORY_POWER_OFF_STATE;\r\nreturn result;\r\n}\r\nstatic void acpi_memory_device_notify(acpi_handle handle, u32 event, void *data)\r\n{\r\nstruct acpi_memory_device *mem_device;\r\nstruct acpi_device *device;\r\nu32 ost_code = ACPI_OST_SC_NON_SPECIFIC_FAILURE;\r\nswitch (event) {\r\ncase ACPI_NOTIFY_BUS_CHECK:\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"\nReceived BUS CHECK notification for device\n"));\r\ncase ACPI_NOTIFY_DEVICE_CHECK:\r\nif (event == ACPI_NOTIFY_DEVICE_CHECK)\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"\nReceived DEVICE CHECK notification for device\n"));\r\nif (acpi_memory_get_device(handle, &mem_device)) {\r\nprintk(KERN_ERR PREFIX "Cannot find driver data\n");\r\nbreak;\r\n}\r\nif (acpi_memory_check_device(mem_device))\r\nbreak;\r\nif (acpi_memory_enable_device(mem_device)) {\r\nprintk(KERN_ERR PREFIX "Cannot enable memory device\n");\r\nbreak;\r\n}\r\nost_code = ACPI_OST_SC_SUCCESS;\r\nbreak;\r\ncase ACPI_NOTIFY_EJECT_REQUEST:\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"\nReceived EJECT REQUEST notification for device\n"));\r\nif (acpi_bus_get_device(handle, &device)) {\r\nprintk(KERN_ERR PREFIX "Device doesn't exist\n");\r\nbreak;\r\n}\r\nmem_device = acpi_driver_data(device);\r\nif (!mem_device) {\r\nprintk(KERN_ERR PREFIX "Driver Data is NULL\n");\r\nbreak;\r\n}\r\nif (acpi_memory_disable_device(mem_device)) {\r\nprintk(KERN_ERR PREFIX "Disable memory device\n");\r\nif (mem_device->state == MEMORY_INVALID_STATE)\r\nreturn;\r\nbreak;\r\n}\r\nreturn;\r\ndefault:\r\nACPI_DEBUG_PRINT((ACPI_DB_INFO,\r\n"Unsupported event [0x%x]\n", event));\r\nreturn;\r\n}\r\n(void) acpi_evaluate_hotplug_ost(handle, event, ost_code, NULL);\r\nreturn;\r\n}\r\nstatic int acpi_memory_device_add(struct acpi_device *device)\r\n{\r\nint result;\r\nstruct acpi_memory_device *mem_device = NULL;\r\nif (!device)\r\nreturn -EINVAL;\r\nmem_device = kzalloc(sizeof(struct acpi_memory_device), GFP_KERNEL);\r\nif (!mem_device)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&mem_device->res_list);\r\nmem_device->device = device;\r\nsprintf(acpi_device_name(device), "%s", ACPI_MEMORY_DEVICE_NAME);\r\nsprintf(acpi_device_class(device), "%s", ACPI_MEMORY_DEVICE_CLASS);\r\ndevice->driver_data = mem_device;\r\nresult = acpi_memory_get_device_resources(mem_device);\r\nif (result) {\r\nkfree(mem_device);\r\nreturn result;\r\n}\r\nmem_device->state = MEMORY_POWER_ON_STATE;\r\nprintk(KERN_DEBUG "%s \n", acpi_device_name(device));\r\nif (!acpi_hotmem_initialized)\r\nreturn 0;\r\nif (!acpi_memory_check_device(mem_device)) {\r\nresult = acpi_memory_enable_device(mem_device);\r\nif (result)\r\nprintk(KERN_ERR PREFIX\r\n"Error in acpi_memory_enable_device\n");\r\n}\r\nreturn result;\r\n}\r\nstatic int acpi_memory_device_remove(struct acpi_device *device, int type)\r\n{\r\nstruct acpi_memory_device *mem_device = NULL;\r\nif (!device || !acpi_driver_data(device))\r\nreturn -EINVAL;\r\nmem_device = acpi_driver_data(device);\r\nkfree(mem_device);\r\nreturn 0;\r\n}\r\nstatic acpi_status is_memory_device(acpi_handle handle)\r\n{\r\nchar *hardware_id;\r\nacpi_status status;\r\nstruct acpi_device_info *info;\r\nstatus = acpi_get_object_info(handle, &info);\r\nif (ACPI_FAILURE(status))\r\nreturn status;\r\nif (!(info->valid & ACPI_VALID_HID)) {\r\nkfree(info);\r\nreturn AE_ERROR;\r\n}\r\nhardware_id = info->hardware_id.string;\r\nif ((hardware_id == NULL) ||\r\n(strcmp(hardware_id, ACPI_MEMORY_DEVICE_HID)))\r\nstatus = AE_ERROR;\r\nkfree(info);\r\nreturn status;\r\n}\r\nstatic acpi_status\r\nacpi_memory_register_notify_handler(acpi_handle handle,\r\nu32 level, void *ctxt, void **retv)\r\n{\r\nacpi_status status;\r\nstatus = is_memory_device(handle);\r\nif (ACPI_FAILURE(status))\r\nreturn AE_OK;\r\nstatus = acpi_install_notify_handler(handle, ACPI_SYSTEM_NOTIFY,\r\nacpi_memory_device_notify, NULL);\r\nreturn AE_OK;\r\n}\r\nstatic acpi_status\r\nacpi_memory_deregister_notify_handler(acpi_handle handle,\r\nu32 level, void *ctxt, void **retv)\r\n{\r\nacpi_status status;\r\nstatus = is_memory_device(handle);\r\nif (ACPI_FAILURE(status))\r\nreturn AE_OK;\r\nstatus = acpi_remove_notify_handler(handle,\r\nACPI_SYSTEM_NOTIFY,\r\nacpi_memory_device_notify);\r\nreturn AE_OK;\r\n}\r\nstatic int __init acpi_memory_device_init(void)\r\n{\r\nint result;\r\nacpi_status status;\r\nresult = acpi_bus_register_driver(&acpi_memory_device_driver);\r\nif (result < 0)\r\nreturn -ENODEV;\r\nstatus = acpi_walk_namespace(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX,\r\nacpi_memory_register_notify_handler, NULL,\r\nNULL, NULL);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status, "walk_namespace failed"));\r\nacpi_bus_unregister_driver(&acpi_memory_device_driver);\r\nreturn -ENODEV;\r\n}\r\nacpi_hotmem_initialized = 1;\r\nreturn 0;\r\n}\r\nstatic void __exit acpi_memory_device_exit(void)\r\n{\r\nacpi_status status;\r\nstatus = acpi_walk_namespace(ACPI_TYPE_DEVICE, ACPI_ROOT_OBJECT,\r\nACPI_UINT32_MAX,\r\nacpi_memory_deregister_notify_handler, NULL,\r\nNULL, NULL);\r\nif (ACPI_FAILURE(status))\r\nACPI_EXCEPTION((AE_INFO, status, "walk_namespace failed"));\r\nacpi_bus_unregister_driver(&acpi_memory_device_driver);\r\nreturn;\r\n}

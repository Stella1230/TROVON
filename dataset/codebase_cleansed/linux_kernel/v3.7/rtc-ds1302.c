static inline int ds1302_hw_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void ds1302_reset(void)\r\n{\r\nset_dp(get_dp() & ~(RTC_RESET | RTC_IODATA | RTC_SCLK));\r\n}\r\nstatic inline void ds1302_clock(void)\r\n{\r\nset_dp(get_dp() | RTC_SCLK);\r\nset_dp(get_dp() & ~RTC_SCLK);\r\n}\r\nstatic inline void ds1302_start(void)\r\n{\r\nset_dp(get_dp() | RTC_RESET);\r\n}\r\nstatic inline void ds1302_stop(void)\r\n{\r\nset_dp(get_dp() & ~RTC_RESET);\r\n}\r\nstatic inline void ds1302_txbit(int bit)\r\n{\r\nset_dp((get_dp() & ~RTC_IODATA) | (bit ? RTC_IODATA : 0));\r\n}\r\nstatic inline int ds1302_rxbit(void)\r\n{\r\nreturn !!(get_dp() & RTC_IODATA);\r\n}\r\nstatic void ds1302_sendbits(unsigned int val)\r\n{\r\nint i;\r\nds1302_set_tx();\r\nfor (i = 8; (i); i--, val >>= 1) {\r\nds1302_txbit(val & 0x1);\r\nds1302_clock();\r\n}\r\n}\r\nstatic unsigned int ds1302_recvbits(void)\r\n{\r\nunsigned int val;\r\nint i;\r\nds1302_set_rx();\r\nfor (i = 0, val = 0; (i < 8); i++) {\r\nval |= (ds1302_rxbit() << i);\r\nds1302_clock();\r\n}\r\nreturn val;\r\n}\r\nstatic unsigned int ds1302_readbyte(unsigned int addr)\r\n{\r\nunsigned int val;\r\nds1302_reset();\r\nds1302_start();\r\nds1302_sendbits(((addr & 0x3f) << 1) | RTC_CMD_READ);\r\nval = ds1302_recvbits();\r\nds1302_stop();\r\nreturn val;\r\n}\r\nstatic void ds1302_writebyte(unsigned int addr, unsigned int val)\r\n{\r\nds1302_reset();\r\nds1302_start();\r\nds1302_sendbits(((addr & 0x3f) << 1) | RTC_CMD_WRITE);\r\nds1302_sendbits(val);\r\nds1302_stop();\r\n}\r\nstatic int ds1302_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\ntm->tm_sec = bcd2bin(ds1302_readbyte(RTC_ADDR_SEC));\r\ntm->tm_min = bcd2bin(ds1302_readbyte(RTC_ADDR_MIN));\r\ntm->tm_hour = bcd2bin(ds1302_readbyte(RTC_ADDR_HOUR));\r\ntm->tm_wday = bcd2bin(ds1302_readbyte(RTC_ADDR_DAY));\r\ntm->tm_mday = bcd2bin(ds1302_readbyte(RTC_ADDR_DATE));\r\ntm->tm_mon = bcd2bin(ds1302_readbyte(RTC_ADDR_MON)) - 1;\r\ntm->tm_year = bcd2bin(ds1302_readbyte(RTC_ADDR_YEAR));\r\nif (tm->tm_year < 70)\r\ntm->tm_year += 100;\r\ndev_dbg(dev, "%s: tm is secs=%d, mins=%d, hours=%d, "\r\n"mday=%d, mon=%d, year=%d, wday=%d\n",\r\n__func__,\r\ntm->tm_sec, tm->tm_min, tm->tm_hour,\r\ntm->tm_mday, tm->tm_mon + 1, tm->tm_year, tm->tm_wday);\r\nreturn rtc_valid_tm(tm);\r\n}\r\nstatic int ds1302_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nds1302_writebyte(RTC_ADDR_SEC, ds1302_readbyte(RTC_ADDR_SEC) | 0x80);\r\nds1302_writebyte(RTC_ADDR_SEC, bin2bcd(tm->tm_sec));\r\nds1302_writebyte(RTC_ADDR_MIN, bin2bcd(tm->tm_min));\r\nds1302_writebyte(RTC_ADDR_HOUR, bin2bcd(tm->tm_hour));\r\nds1302_writebyte(RTC_ADDR_DAY, bin2bcd(tm->tm_wday));\r\nds1302_writebyte(RTC_ADDR_DATE, bin2bcd(tm->tm_mday));\r\nds1302_writebyte(RTC_ADDR_MON, bin2bcd(tm->tm_mon + 1));\r\nds1302_writebyte(RTC_ADDR_YEAR, bin2bcd(tm->tm_year % 100));\r\nds1302_writebyte(RTC_ADDR_SEC, ds1302_readbyte(RTC_ADDR_SEC) & ~0x80);\r\nreturn 0;\r\n}\r\nstatic int ds1302_rtc_ioctl(struct device *dev, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nswitch (cmd) {\r\n#ifdef RTC_SET_CHARGE\r\ncase RTC_SET_CHARGE:\r\n{\r\nint tcs_val;\r\nif (copy_from_user(&tcs_val, (int __user *)arg, sizeof(int)))\r\nreturn -EFAULT;\r\nds1302_writebyte(RTC_ADDR_TCR, (0xa0 | tcs_val * 0xf));\r\nreturn 0;\r\n}\r\n#endif\r\n}\r\nreturn -ENOIOCTLCMD;\r\n}\r\nstatic int __init ds1302_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nif (ds1302_hw_init()) {\r\ndev_err(&pdev->dev, "Failed to init communication channel");\r\nreturn -EINVAL;\r\n}\r\nds1302_reset();\r\nds1302_writebyte(RTC_ADDR_RAM0, 0x42);\r\nif (ds1302_readbyte(RTC_ADDR_RAM0) != 0x42) {\r\ndev_err(&pdev->dev, "Failed to probe");\r\nreturn -ENODEV;\r\n}\r\nrtc = rtc_device_register("ds1302", &pdev->dev,\r\n&ds1302_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\nplatform_set_drvdata(pdev, rtc);\r\nreturn 0;\r\n}\r\nstatic int __devexit ds1302_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nrtc_device_unregister(rtc);\r\nplatform_set_drvdata(pdev, NULL);\r\nreturn 0;\r\n}\r\nstatic int __init ds1302_rtc_init(void)\r\n{\r\nreturn platform_driver_probe(&ds1302_platform_driver, ds1302_rtc_probe);\r\n}\r\nstatic void __exit ds1302_rtc_exit(void)\r\n{\r\nplatform_driver_unregister(&ds1302_platform_driver);\r\n}

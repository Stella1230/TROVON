void line6_dump_started(struct line6_dump_request *l6dr, int dest)\r\n{\r\nl6dr->in_progress = dest;\r\n}\r\nvoid line6_invalidate_current(struct line6_dump_request *l6dr)\r\n{\r\nline6_dump_started(l6dr, LINE6_DUMP_CURRENT);\r\n}\r\nvoid line6_dump_finished(struct line6_dump_request *l6dr)\r\n{\r\nl6dr->in_progress = LINE6_DUMP_NONE;\r\nwake_up(&l6dr->wait);\r\n}\r\nint line6_dump_request_async(struct line6_dump_request *l6dr,\r\nstruct usb_line6 *line6, int num, int dest)\r\n{\r\nint ret;\r\nline6_dump_started(l6dr, dest);\r\nret = line6_send_raw_message_async(line6, l6dr->reqbufs[num].buffer,\r\nl6dr->reqbufs[num].length);\r\nif (ret < 0)\r\nline6_dump_finished(l6dr);\r\nreturn ret;\r\n}\r\nint line6_dump_wait_interruptible(struct line6_dump_request *l6dr)\r\n{\r\nreturn wait_event_interruptible(l6dr->wait,\r\nl6dr->in_progress == LINE6_DUMP_NONE);\r\n}\r\nvoid line6_dump_wait(struct line6_dump_request *l6dr)\r\n{\r\nwait_event(l6dr->wait, l6dr->in_progress == LINE6_DUMP_NONE);\r\n}\r\nint line6_dump_wait_timeout(struct line6_dump_request *l6dr, long timeout)\r\n{\r\nreturn wait_event_timeout(l6dr->wait,\r\nl6dr->in_progress == LINE6_DUMP_NONE,\r\ntimeout);\r\n}\r\nint line6_dumpreq_initbuf(struct line6_dump_request *l6dr, const void *buf,\r\nsize_t len, int num)\r\n{\r\nl6dr->reqbufs[num].buffer = kmemdup(buf, len, GFP_KERNEL);\r\nif (l6dr->reqbufs[num].buffer == NULL)\r\nreturn -ENOMEM;\r\nl6dr->reqbufs[num].length = len;\r\nreturn 0;\r\n}\r\nint line6_dumpreq_init(struct line6_dump_request *l6dr, const void *buf,\r\nsize_t len)\r\n{\r\nint ret;\r\nret = line6_dumpreq_initbuf(l6dr, buf, len, 0);\r\nif (ret < 0)\r\nreturn ret;\r\ninit_waitqueue_head(&l6dr->wait);\r\nreturn 0;\r\n}\r\nvoid line6_dumpreq_destructbuf(struct line6_dump_request *l6dr, int num)\r\n{\r\nif (l6dr == NULL)\r\nreturn;\r\nif (l6dr->reqbufs[num].buffer == NULL)\r\nreturn;\r\nkfree(l6dr->reqbufs[num].buffer);\r\nl6dr->reqbufs[num].buffer = NULL;\r\n}\r\nvoid line6_dumpreq_destruct(struct line6_dump_request *l6dr)\r\n{\r\nif (l6dr->reqbufs[0].buffer == NULL)\r\nreturn;\r\nline6_dumpreq_destructbuf(l6dr, 0);\r\n}

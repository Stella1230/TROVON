static inline void hdmi_write_reg(void __iomem *base_addr,\r\nconst u16 idx, u32 val)\r\n{\r\n__raw_writel(val, base_addr + idx);\r\n}\r\nstatic inline u32 hdmi_read_reg(void __iomem *base_addr,\r\nconst u16 idx)\r\n{\r\nreturn __raw_readl(base_addr + idx);\r\n}\r\nstatic inline void __iomem *hdmi_wp_base(struct hdmi_ip_data *ip_data)\r\n{\r\nreturn ip_data->base_wp;\r\n}\r\nstatic inline void __iomem *hdmi_phy_base(struct hdmi_ip_data *ip_data)\r\n{\r\nreturn ip_data->base_wp + ip_data->phy_offset;\r\n}\r\nstatic inline void __iomem *hdmi_pll_base(struct hdmi_ip_data *ip_data)\r\n{\r\nreturn ip_data->base_wp + ip_data->pll_offset;\r\n}\r\nstatic inline void __iomem *hdmi_av_base(struct hdmi_ip_data *ip_data)\r\n{\r\nreturn ip_data->base_wp + ip_data->core_av_offset;\r\n}\r\nstatic inline void __iomem *hdmi_core_sys_base(struct hdmi_ip_data *ip_data)\r\n{\r\nreturn ip_data->base_wp + ip_data->core_sys_offset;\r\n}\r\nstatic inline int hdmi_wait_for_bit_change(void __iomem *base_addr,\r\nconst u16 idx,\r\nint b2, int b1, u32 val)\r\n{\r\nu32 t = 0;\r\nwhile (val != REG_GET(base_addr, idx, b2, b1)) {\r\nudelay(1);\r\nif (t++ > 10000)\r\nreturn !val;\r\n}\r\nreturn val;\r\n}\r\nstatic int hdmi_pll_init(struct hdmi_ip_data *ip_data)\r\n{\r\nu32 r;\r\nvoid __iomem *pll_base = hdmi_pll_base(ip_data);\r\nstruct hdmi_pll_info *fmt = &ip_data->pll_data;\r\nREG_FLD_MOD(pll_base, PLLCTRL_PLL_CONTROL, 0x0, 0, 0);\r\nr = hdmi_read_reg(pll_base, PLLCTRL_CFG1);\r\nr = FLD_MOD(r, fmt->regm, 20, 9);\r\nr = FLD_MOD(r, fmt->regn - 1, 8, 1);\r\nhdmi_write_reg(pll_base, PLLCTRL_CFG1, r);\r\nr = hdmi_read_reg(pll_base, PLLCTRL_CFG2);\r\nr = FLD_MOD(r, 0x0, 12, 12);\r\nr = FLD_MOD(r, 0x1, 13, 13);\r\nr = FLD_MOD(r, 0x0, 14, 14);\r\nr = FLD_MOD(r, fmt->refsel, 22, 21);\r\nif (fmt->dcofreq) {\r\nREG_FLD_MOD(pll_base, PLLCTRL_CFG3, fmt->regsd, 17, 10);\r\nr = FLD_MOD(r, 0x4, 3, 1);\r\n} else {\r\nr = FLD_MOD(r, 0x2, 3, 1);\r\n}\r\nhdmi_write_reg(pll_base, PLLCTRL_CFG2, r);\r\nr = hdmi_read_reg(pll_base, PLLCTRL_CFG4);\r\nr = FLD_MOD(r, fmt->regm2, 24, 18);\r\nr = FLD_MOD(r, fmt->regmf, 17, 0);\r\nhdmi_write_reg(pll_base, PLLCTRL_CFG4, r);\r\nREG_FLD_MOD(pll_base, PLLCTRL_PLL_GO, 0x1, 0, 0);\r\nif (hdmi_wait_for_bit_change(pll_base, PLLCTRL_PLL_GO,\r\n0, 0, 1) != 1) {\r\npr_err("PLL GO bit not set\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (hdmi_wait_for_bit_change(pll_base,\r\nPLLCTRL_PLL_STATUS, 1, 1, 1) != 1) {\r\npr_err("cannot lock PLL\n");\r\npr_err("CFG1 0x%x\n",\r\nhdmi_read_reg(pll_base, PLLCTRL_CFG1));\r\npr_err("CFG2 0x%x\n",\r\nhdmi_read_reg(pll_base, PLLCTRL_CFG2));\r\npr_err("CFG4 0x%x\n",\r\nhdmi_read_reg(pll_base, PLLCTRL_CFG4));\r\nreturn -ETIMEDOUT;\r\n}\r\npr_debug("PLL locked!\n");\r\nreturn 0;\r\n}\r\nstatic int hdmi_set_phy_pwr(struct hdmi_ip_data *ip_data, enum hdmi_phy_pwr val)\r\n{\r\nif (REG_GET(hdmi_wp_base(ip_data), HDMI_WP_PWR_CTRL, 5, 4) == val)\r\nreturn 0;\r\nREG_FLD_MOD(hdmi_wp_base(ip_data), HDMI_WP_PWR_CTRL, val, 7, 6);\r\nif (hdmi_wait_for_bit_change(hdmi_wp_base(ip_data),\r\nHDMI_WP_PWR_CTRL, 5, 4, val) != val) {\r\npr_err("Failed to set PHY power mode to %d\n", val);\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmi_set_pll_pwr(struct hdmi_ip_data *ip_data, enum hdmi_pll_pwr val)\r\n{\r\nREG_FLD_MOD(hdmi_wp_base(ip_data), HDMI_WP_PWR_CTRL, val, 3, 2);\r\nif (hdmi_wait_for_bit_change(hdmi_wp_base(ip_data), HDMI_WP_PWR_CTRL,\r\n1, 0, val) != val) {\r\npr_err("Failed to set PLL_PWR_STATUS\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmi_pll_reset(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_pll_base(ip_data), PLLCTRL_PLL_CONTROL, 0x0, 3, 3);\r\nif (hdmi_wait_for_bit_change(hdmi_pll_base(ip_data),\r\nPLLCTRL_PLL_STATUS, 0, 0, 1) != 1) {\r\npr_err("Failed to sysreset PLL\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nint ti_hdmi_4xxx_pll_enable(struct hdmi_ip_data *ip_data)\r\n{\r\nu16 r = 0;\r\nr = hdmi_set_pll_pwr(ip_data, HDMI_PLLPWRCMD_ALLOFF);\r\nif (r)\r\nreturn r;\r\nr = hdmi_set_pll_pwr(ip_data, HDMI_PLLPWRCMD_BOTHON_ALLCLKS);\r\nif (r)\r\nreturn r;\r\nr = hdmi_pll_reset(ip_data);\r\nif (r)\r\nreturn r;\r\nr = hdmi_pll_init(ip_data);\r\nif (r)\r\nreturn r;\r\nreturn 0;\r\n}\r\nvoid ti_hdmi_4xxx_pll_disable(struct hdmi_ip_data *ip_data)\r\n{\r\nhdmi_set_pll_pwr(ip_data, HDMI_PLLPWRCMD_ALLOFF);\r\n}\r\nstatic int hdmi_check_hpd_state(struct hdmi_ip_data *ip_data)\r\n{\r\nbool hpd;\r\nint r;\r\nmutex_lock(&ip_data->lock);\r\nhpd = gpio_get_value(ip_data->hpd_gpio);\r\nif (hpd)\r\nr = hdmi_set_phy_pwr(ip_data, HDMI_PHYPWRCMD_TXON);\r\nelse\r\nr = hdmi_set_phy_pwr(ip_data, HDMI_PHYPWRCMD_LDOON);\r\nif (r) {\r\nDSSERR("Failed to %s PHY TX power\n",\r\nhpd ? "enable" : "disable");\r\ngoto err;\r\n}\r\nerr:\r\nmutex_unlock(&ip_data->lock);\r\nreturn r;\r\n}\r\nstatic irqreturn_t hpd_irq_handler(int irq, void *data)\r\n{\r\nstruct hdmi_ip_data *ip_data = data;\r\nhdmi_check_hpd_state(ip_data);\r\nreturn IRQ_HANDLED;\r\n}\r\nint ti_hdmi_4xxx_phy_enable(struct hdmi_ip_data *ip_data)\r\n{\r\nu16 r = 0;\r\nvoid __iomem *phy_base = hdmi_phy_base(ip_data);\r\nr = hdmi_set_phy_pwr(ip_data, HDMI_PHYPWRCMD_LDOON);\r\nif (r)\r\nreturn r;\r\nhdmi_read_reg(phy_base, HDMI_TXPHY_TX_CTRL);\r\nREG_FLD_MOD(phy_base, HDMI_TXPHY_TX_CTRL, 0x1, 31, 30);\r\nhdmi_write_reg(phy_base, HDMI_TXPHY_DIGITAL_CTRL, 0xF0000000);\r\nREG_FLD_MOD(phy_base, HDMI_TXPHY_POWER_CTRL, 0xB, 3, 0);\r\nREG_FLD_MOD(phy_base, HDMI_TXPHY_PAD_CFG_CTRL, 0x1, 27, 27);\r\nr = request_threaded_irq(gpio_to_irq(ip_data->hpd_gpio),\r\nNULL, hpd_irq_handler,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING |\r\nIRQF_ONESHOT, "hpd", ip_data);\r\nif (r) {\r\nDSSERR("HPD IRQ request failed\n");\r\nhdmi_set_phy_pwr(ip_data, HDMI_PHYPWRCMD_OFF);\r\nreturn r;\r\n}\r\nr = hdmi_check_hpd_state(ip_data);\r\nif (r) {\r\nfree_irq(gpio_to_irq(ip_data->hpd_gpio), ip_data);\r\nhdmi_set_phy_pwr(ip_data, HDMI_PHYPWRCMD_OFF);\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nvoid ti_hdmi_4xxx_phy_disable(struct hdmi_ip_data *ip_data)\r\n{\r\nfree_irq(gpio_to_irq(ip_data->hpd_gpio), ip_data);\r\nhdmi_set_phy_pwr(ip_data, HDMI_PHYPWRCMD_OFF);\r\n}\r\nstatic int hdmi_core_ddc_init(struct hdmi_ip_data *ip_data)\r\n{\r\nvoid __iomem *base = hdmi_core_sys_base(ip_data);\r\nREG_FLD_MOD(base, HDMI_CORE_AV_DPD, 0x7, 2, 0);\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 4, 4) == 1) {\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0xf, 3, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout aborting DDC transaction\n");\r\nreturn -ETIMEDOUT;\r\n}\r\n}\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0xA, 3, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout starting SCL clock\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0x9, 3, 0);\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout clearing DDC fifo\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int hdmi_core_ddc_edid(struct hdmi_ip_data *ip_data,\r\nu8 *pedid, int ext)\r\n{\r\nvoid __iomem *base = hdmi_core_sys_base(ip_data);\r\nu32 i;\r\nchar checksum;\r\nu32 offset = 0;\r\nif (hdmi_wait_for_bit_change(base, HDMI_CORE_DDC_STATUS,\r\n4, 4, 0) != 0) {\r\nDSSERR("Timeout waiting DDC to be ready\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (ext % 2 != 0)\r\noffset = 0x80;\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_SEGM, ext / 2, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_ADDR, 0xA0 >> 1, 7, 1);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_OFFSET, offset, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_COUNT1, 0x80, 7, 0);\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_COUNT2, 0x0, 1, 0);\r\nif (ext)\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0x4, 3, 0);\r\nelse\r\nREG_FLD_MOD(base, HDMI_CORE_DDC_CMD, 0x2, 3, 0);\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 6, 6) == 1) {\r\npr_err("I2C Bus Low?\n");\r\nreturn -EIO;\r\n}\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 5, 5) == 1) {\r\npr_err("I2C No Ack\n");\r\nreturn -EIO;\r\n}\r\nfor (i = 0; i < 0x80; ++i) {\r\nint t;\r\nif (REG_GET(base, HDMI_CORE_DDC_STATUS, 4, 4) == 0) {\r\nDSSERR("operation stopped when reading edid\n");\r\nreturn -EIO;\r\n}\r\nt = 0;\r\nwhile (REG_GET(base, HDMI_CORE_DDC_STATUS, 2, 2) == 1) {\r\nif (t++ > 10000) {\r\nDSSERR("timeout reading edid\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nudelay(1);\r\n}\r\npedid[i] = REG_GET(base, HDMI_CORE_DDC_DATA, 7, 0);\r\n}\r\nchecksum = 0;\r\nfor (i = 0; i < 0x80; ++i)\r\nchecksum += pedid[i];\r\nif (checksum != 0) {\r\npr_err("E-EDID checksum failed!!\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nint ti_hdmi_4xxx_read_edid(struct hdmi_ip_data *ip_data,\r\nu8 *edid, int len)\r\n{\r\nint r, l;\r\nif (len < 128)\r\nreturn -EINVAL;\r\nr = hdmi_core_ddc_init(ip_data);\r\nif (r)\r\nreturn r;\r\nr = hdmi_core_ddc_edid(ip_data, edid, 0);\r\nif (r)\r\nreturn r;\r\nl = 128;\r\nif (len >= 128 * 2 && edid[0x7e] > 0) {\r\nr = hdmi_core_ddc_edid(ip_data, edid + 0x80, 1);\r\nif (r)\r\nreturn r;\r\nl += 128;\r\n}\r\nreturn l;\r\n}\r\nbool ti_hdmi_4xxx_detect(struct hdmi_ip_data *ip_data)\r\n{\r\nreturn gpio_get_value(ip_data->hpd_gpio);\r\n}\r\nstatic void hdmi_core_init(struct hdmi_core_video_config *video_cfg,\r\nstruct hdmi_core_infoframe_avi *avi_cfg,\r\nstruct hdmi_core_packet_enable_repeat *repeat_cfg)\r\n{\r\npr_debug("Enter hdmi_core_init\n");\r\nvideo_cfg->ip_bus_width = HDMI_INPUT_8BIT;\r\nvideo_cfg->op_dither_truc = HDMI_OUTPUTTRUNCATION_8BIT;\r\nvideo_cfg->deep_color_pkt = HDMI_DEEPCOLORPACKECTDISABLE;\r\nvideo_cfg->pkt_mode = HDMI_PACKETMODERESERVEDVALUE;\r\nvideo_cfg->hdmi_dvi = HDMI_DVI;\r\nvideo_cfg->tclk_sel_clkmult = HDMI_FPLL10IDCK;\r\navi_cfg->db1_format = 0;\r\navi_cfg->db1_active_info = 0;\r\navi_cfg->db1_bar_info_dv = 0;\r\navi_cfg->db1_scan_info = 0;\r\navi_cfg->db2_colorimetry = 0;\r\navi_cfg->db2_aspect_ratio = 0;\r\navi_cfg->db2_active_fmt_ar = 0;\r\navi_cfg->db3_itc = 0;\r\navi_cfg->db3_ec = 0;\r\navi_cfg->db3_q_range = 0;\r\navi_cfg->db3_nup_scaling = 0;\r\navi_cfg->db4_videocode = 0;\r\navi_cfg->db5_pixel_repeat = 0;\r\navi_cfg->db6_7_line_eoftop = 0 ;\r\navi_cfg->db8_9_line_sofbottom = 0;\r\navi_cfg->db10_11_pixel_eofleft = 0;\r\navi_cfg->db12_13_pixel_sofright = 0;\r\nrepeat_cfg->audio_pkt = 0;\r\nrepeat_cfg->audio_pkt_repeat = 0;\r\nrepeat_cfg->avi_infoframe = 0;\r\nrepeat_cfg->avi_infoframe_repeat = 0;\r\nrepeat_cfg->gen_cntrl_pkt = 0;\r\nrepeat_cfg->gen_cntrl_pkt_repeat = 0;\r\nrepeat_cfg->generic_pkt = 0;\r\nrepeat_cfg->generic_pkt_repeat = 0;\r\n}\r\nstatic void hdmi_core_powerdown_disable(struct hdmi_ip_data *ip_data)\r\n{\r\npr_debug("Enter hdmi_core_powerdown_disable\n");\r\nREG_FLD_MOD(hdmi_core_sys_base(ip_data), HDMI_CORE_CTRL1, 0x0, 0, 0);\r\n}\r\nstatic void hdmi_core_swreset_release(struct hdmi_ip_data *ip_data)\r\n{\r\npr_debug("Enter hdmi_core_swreset_release\n");\r\nREG_FLD_MOD(hdmi_core_sys_base(ip_data), HDMI_CORE_SYS_SRST, 0x0, 0, 0);\r\n}\r\nstatic void hdmi_core_swreset_assert(struct hdmi_ip_data *ip_data)\r\n{\r\npr_debug("Enter hdmi_core_swreset_assert\n");\r\nREG_FLD_MOD(hdmi_core_sys_base(ip_data), HDMI_CORE_SYS_SRST, 0x1, 0, 0);\r\n}\r\nstatic void hdmi_core_video_config(struct hdmi_ip_data *ip_data,\r\nstruct hdmi_core_video_config *cfg)\r\n{\r\nu32 r = 0;\r\nvoid __iomem *core_sys_base = hdmi_core_sys_base(ip_data);\r\nr = hdmi_read_reg(core_sys_base, HDMI_CORE_CTRL1);\r\nr = FLD_MOD(r, HDMI_CORE_CTRL1_VEN_FOLLOWVSYNC, 5, 5);\r\nr = FLD_MOD(r, HDMI_CORE_CTRL1_HEN_FOLLOWHSYNC, 4, 4);\r\nr = FLD_MOD(r, HDMI_CORE_CTRL1_BSEL_24BITBUS, 2, 2);\r\nr = FLD_MOD(r, HDMI_CORE_CTRL1_EDGE_RISINGEDGE, 1, 1);\r\nhdmi_write_reg(core_sys_base, HDMI_CORE_CTRL1, r);\r\nREG_FLD_MOD(core_sys_base,\r\nHDMI_CORE_SYS_VID_ACEN, cfg->ip_bus_width, 7, 6);\r\nr = hdmi_read_reg(core_sys_base, HDMI_CORE_SYS_VID_MODE);\r\nif (cfg->op_dither_truc > HDMI_OUTPUTTRUNCATION_12BIT) {\r\nr = FLD_MOD(r, cfg->op_dither_truc - 3, 7, 6);\r\nr = FLD_MOD(r, 1, 5, 5);\r\n} else {\r\nr = FLD_MOD(r, cfg->op_dither_truc, 7, 6);\r\nr = FLD_MOD(r, 0, 5, 5);\r\n}\r\nhdmi_write_reg(core_sys_base, HDMI_CORE_SYS_VID_MODE, r);\r\nr = hdmi_read_reg(hdmi_av_base(ip_data), HDMI_CORE_AV_HDMI_CTRL);\r\nr = FLD_MOD(r, cfg->deep_color_pkt, 6, 6);\r\nr = FLD_MOD(r, cfg->pkt_mode, 5, 3);\r\nr = FLD_MOD(r, cfg->hdmi_dvi, 0, 0);\r\nhdmi_write_reg(hdmi_av_base(ip_data), HDMI_CORE_AV_HDMI_CTRL, r);\r\nREG_FLD_MOD(core_sys_base,\r\nHDMI_CORE_SYS_TMDS_CTRL, cfg->tclk_sel_clkmult, 6, 5);\r\n}\r\nstatic void hdmi_core_aux_infoframe_avi_config(struct hdmi_ip_data *ip_data)\r\n{\r\nu32 val;\r\nchar sum = 0, checksum = 0;\r\nvoid __iomem *av_base = hdmi_av_base(ip_data);\r\nstruct hdmi_core_infoframe_avi info_avi = ip_data->avi_cfg;\r\nsum += 0x82 + 0x002 + 0x00D;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_TYPE, 0x082);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_VERS, 0x002);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_LEN, 0x00D);\r\nval = (info_avi.db1_format << 5) |\r\n(info_avi.db1_active_info << 4) |\r\n(info_avi.db1_bar_info_dv << 2) |\r\n(info_avi.db1_scan_info);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(0), val);\r\nsum += val;\r\nval = (info_avi.db2_colorimetry << 6) |\r\n(info_avi.db2_aspect_ratio << 4) |\r\n(info_avi.db2_active_fmt_ar);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(1), val);\r\nsum += val;\r\nval = (info_avi.db3_itc << 7) |\r\n(info_avi.db3_ec << 4) |\r\n(info_avi.db3_q_range << 2) |\r\n(info_avi.db3_nup_scaling);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(2), val);\r\nsum += val;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(3),\r\ninfo_avi.db4_videocode);\r\nsum += info_avi.db4_videocode;\r\nval = info_avi.db5_pixel_repeat;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(4), val);\r\nsum += val;\r\nval = info_avi.db6_7_line_eoftop & 0x00FF;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(5), val);\r\nsum += val;\r\nval = ((info_avi.db6_7_line_eoftop >> 8) & 0x00FF);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(6), val);\r\nsum += val;\r\nval = info_avi.db8_9_line_sofbottom & 0x00FF;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(7), val);\r\nsum += val;\r\nval = ((info_avi.db8_9_line_sofbottom >> 8) & 0x00FF);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(8), val);\r\nsum += val;\r\nval = info_avi.db10_11_pixel_eofleft & 0x00FF;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(9), val);\r\nsum += val;\r\nval = ((info_avi.db10_11_pixel_eofleft >> 8) & 0x00FF);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(10), val);\r\nsum += val;\r\nval = info_avi.db12_13_pixel_sofright & 0x00FF;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(11), val);\r\nsum += val;\r\nval = ((info_avi.db12_13_pixel_sofright >> 8) & 0x00FF);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_DBYTE(12), val);\r\nsum += val;\r\nchecksum = 0x100 - sum;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AVI_CHSUM, checksum);\r\n}\r\nstatic void hdmi_core_av_packet_config(struct hdmi_ip_data *ip_data,\r\nstruct hdmi_core_packet_enable_repeat repeat_cfg)\r\n{\r\nhdmi_write_reg(hdmi_av_base(ip_data), HDMI_CORE_AV_PB_CTRL1,\r\n(repeat_cfg.audio_pkt << 5) |\r\n(repeat_cfg.audio_pkt_repeat << 4) |\r\n(repeat_cfg.avi_infoframe << 1) |\r\n(repeat_cfg.avi_infoframe_repeat));\r\nhdmi_write_reg(hdmi_av_base(ip_data), HDMI_CORE_AV_PB_CTRL2,\r\n(repeat_cfg.gen_cntrl_pkt << 3) |\r\n(repeat_cfg.gen_cntrl_pkt_repeat << 2) |\r\n(repeat_cfg.generic_pkt << 1) |\r\n(repeat_cfg.generic_pkt_repeat));\r\n}\r\nstatic void hdmi_wp_init(struct omap_video_timings *timings,\r\nstruct hdmi_video_format *video_fmt)\r\n{\r\npr_debug("Enter hdmi_wp_init\n");\r\ntimings->hbp = 0;\r\ntimings->hfp = 0;\r\ntimings->hsw = 0;\r\ntimings->vbp = 0;\r\ntimings->vfp = 0;\r\ntimings->vsw = 0;\r\nvideo_fmt->packing_mode = HDMI_PACK_10b_RGB_YUV444;\r\nvideo_fmt->y_res = 0;\r\nvideo_fmt->x_res = 0;\r\n}\r\nint ti_hdmi_4xxx_wp_video_start(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_CFG, true, 31, 31);\r\nreturn 0;\r\n}\r\nvoid ti_hdmi_4xxx_wp_video_stop(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_CFG, false, 31, 31);\r\n}\r\nstatic void hdmi_wp_video_init_format(struct hdmi_video_format *video_fmt,\r\nstruct omap_video_timings *timings, struct hdmi_config *param)\r\n{\r\npr_debug("Enter hdmi_wp_video_init_format\n");\r\nvideo_fmt->y_res = param->timings.y_res;\r\nvideo_fmt->x_res = param->timings.x_res;\r\ntimings->hbp = param->timings.hbp;\r\ntimings->hfp = param->timings.hfp;\r\ntimings->hsw = param->timings.hsw;\r\ntimings->vbp = param->timings.vbp;\r\ntimings->vfp = param->timings.vfp;\r\ntimings->vsw = param->timings.vsw;\r\n}\r\nstatic void hdmi_wp_video_config_format(struct hdmi_ip_data *ip_data,\r\nstruct hdmi_video_format *video_fmt)\r\n{\r\nu32 l = 0;\r\nREG_FLD_MOD(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_CFG,\r\nvideo_fmt->packing_mode, 10, 8);\r\nl |= FLD_VAL(video_fmt->y_res, 31, 16);\r\nl |= FLD_VAL(video_fmt->x_res, 15, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_SIZE, l);\r\n}\r\nstatic void hdmi_wp_video_config_interface(struct hdmi_ip_data *ip_data)\r\n{\r\nu32 r;\r\nbool vsync_pol, hsync_pol;\r\npr_debug("Enter hdmi_wp_video_config_interface\n");\r\nvsync_pol = ip_data->cfg.timings.vsync_level == OMAPDSS_SIG_ACTIVE_HIGH;\r\nhsync_pol = ip_data->cfg.timings.hsync_level == OMAPDSS_SIG_ACTIVE_HIGH;\r\nr = hdmi_read_reg(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_CFG);\r\nr = FLD_MOD(r, vsync_pol, 7, 7);\r\nr = FLD_MOD(r, hsync_pol, 6, 6);\r\nr = FLD_MOD(r, ip_data->cfg.timings.interlace, 3, 3);\r\nr = FLD_MOD(r, 1, 1, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_CFG, r);\r\n}\r\nstatic void hdmi_wp_video_config_timing(struct hdmi_ip_data *ip_data,\r\nstruct omap_video_timings *timings)\r\n{\r\nu32 timing_h = 0;\r\nu32 timing_v = 0;\r\npr_debug("Enter hdmi_wp_video_config_timing\n");\r\ntiming_h |= FLD_VAL(timings->hbp, 31, 20);\r\ntiming_h |= FLD_VAL(timings->hfp, 19, 8);\r\ntiming_h |= FLD_VAL(timings->hsw, 7, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_TIMING_H, timing_h);\r\ntiming_v |= FLD_VAL(timings->vbp, 31, 20);\r\ntiming_v |= FLD_VAL(timings->vfp, 19, 8);\r\ntiming_v |= FLD_VAL(timings->vsw, 7, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_VIDEO_TIMING_V, timing_v);\r\n}\r\nvoid ti_hdmi_4xxx_basic_configure(struct hdmi_ip_data *ip_data)\r\n{\r\nstruct omap_video_timings video_timing;\r\nstruct hdmi_video_format video_format;\r\nstruct hdmi_core_infoframe_avi avi_cfg = ip_data->avi_cfg;\r\nstruct hdmi_core_video_config v_core_cfg;\r\nstruct hdmi_core_packet_enable_repeat repeat_cfg;\r\nstruct hdmi_config *cfg = &ip_data->cfg;\r\nhdmi_wp_init(&video_timing, &video_format);\r\nhdmi_core_init(&v_core_cfg,\r\n&avi_cfg,\r\n&repeat_cfg);\r\nhdmi_wp_video_init_format(&video_format, &video_timing, cfg);\r\nhdmi_wp_video_config_timing(ip_data, &video_timing);\r\nvideo_format.packing_mode = HDMI_PACK_24b_RGB_YUV444_YUV422;\r\nhdmi_wp_video_config_format(ip_data, &video_format);\r\nhdmi_wp_video_config_interface(ip_data);\r\nhdmi_core_swreset_assert(ip_data);\r\nhdmi_core_powerdown_disable(ip_data);\r\nv_core_cfg.pkt_mode = HDMI_PACKETMODE24BITPERPIXEL;\r\nv_core_cfg.hdmi_dvi = cfg->cm.mode;\r\nhdmi_core_video_config(ip_data, &v_core_cfg);\r\nhdmi_core_swreset_release(ip_data);\r\navi_cfg.db1_format = HDMI_INFOFRAME_AVI_DB1Y_RGB;\r\navi_cfg.db1_active_info =\r\nHDMI_INFOFRAME_AVI_DB1A_ACTIVE_FORMAT_OFF;\r\navi_cfg.db1_bar_info_dv = HDMI_INFOFRAME_AVI_DB1B_NO;\r\navi_cfg.db1_scan_info = HDMI_INFOFRAME_AVI_DB1S_0;\r\navi_cfg.db2_colorimetry = HDMI_INFOFRAME_AVI_DB2C_NO;\r\navi_cfg.db2_aspect_ratio = HDMI_INFOFRAME_AVI_DB2M_NO;\r\navi_cfg.db2_active_fmt_ar = HDMI_INFOFRAME_AVI_DB2R_SAME;\r\navi_cfg.db3_itc = HDMI_INFOFRAME_AVI_DB3ITC_NO;\r\navi_cfg.db3_ec = HDMI_INFOFRAME_AVI_DB3EC_XVYUV601;\r\navi_cfg.db3_q_range = HDMI_INFOFRAME_AVI_DB3Q_DEFAULT;\r\navi_cfg.db3_nup_scaling = HDMI_INFOFRAME_AVI_DB3SC_NO;\r\navi_cfg.db4_videocode = cfg->cm.code;\r\navi_cfg.db5_pixel_repeat = HDMI_INFOFRAME_AVI_DB5PR_NO;\r\navi_cfg.db6_7_line_eoftop = 0;\r\navi_cfg.db8_9_line_sofbottom = 0;\r\navi_cfg.db10_11_pixel_eofleft = 0;\r\navi_cfg.db12_13_pixel_sofright = 0;\r\nhdmi_core_aux_infoframe_avi_config(ip_data);\r\nrepeat_cfg.avi_infoframe = HDMI_PACKETENABLE;\r\nrepeat_cfg.avi_infoframe_repeat = HDMI_PACKETREPEATON;\r\nrepeat_cfg.audio_pkt = HDMI_PACKETENABLE;\r\nrepeat_cfg.audio_pkt_repeat = HDMI_PACKETREPEATON;\r\nhdmi_core_av_packet_config(ip_data, repeat_cfg);\r\n}\r\nvoid ti_hdmi_4xxx_wp_dump(struct hdmi_ip_data *ip_data, struct seq_file *s)\r\n{\r\n#define DUMPREG(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(hdmi_wp_base(ip_data), r))\r\nDUMPREG(HDMI_WP_REVISION);\r\nDUMPREG(HDMI_WP_SYSCONFIG);\r\nDUMPREG(HDMI_WP_IRQSTATUS_RAW);\r\nDUMPREG(HDMI_WP_IRQSTATUS);\r\nDUMPREG(HDMI_WP_PWR_CTRL);\r\nDUMPREG(HDMI_WP_IRQENABLE_SET);\r\nDUMPREG(HDMI_WP_VIDEO_CFG);\r\nDUMPREG(HDMI_WP_VIDEO_SIZE);\r\nDUMPREG(HDMI_WP_VIDEO_TIMING_H);\r\nDUMPREG(HDMI_WP_VIDEO_TIMING_V);\r\nDUMPREG(HDMI_WP_WP_CLK);\r\nDUMPREG(HDMI_WP_AUDIO_CFG);\r\nDUMPREG(HDMI_WP_AUDIO_CFG2);\r\nDUMPREG(HDMI_WP_AUDIO_CTRL);\r\nDUMPREG(HDMI_WP_AUDIO_DATA);\r\n}\r\nvoid ti_hdmi_4xxx_pll_dump(struct hdmi_ip_data *ip_data, struct seq_file *s)\r\n{\r\n#define DUMPPLL(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(hdmi_pll_base(ip_data), r))\r\nDUMPPLL(PLLCTRL_PLL_CONTROL);\r\nDUMPPLL(PLLCTRL_PLL_STATUS);\r\nDUMPPLL(PLLCTRL_PLL_GO);\r\nDUMPPLL(PLLCTRL_CFG1);\r\nDUMPPLL(PLLCTRL_CFG2);\r\nDUMPPLL(PLLCTRL_CFG3);\r\nDUMPPLL(PLLCTRL_CFG4);\r\n}\r\nvoid ti_hdmi_4xxx_core_dump(struct hdmi_ip_data *ip_data, struct seq_file *s)\r\n{\r\nint i;\r\n#define CORE_REG(i, name) name(i)\r\n#define DUMPCORE(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(hdmi_core_sys_base(ip_data), r))\r\n#define DUMPCOREAV(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(hdmi_av_base(ip_data), r))\r\n#define DUMPCOREAV2(i, r) seq_printf(s, "%s[%d]%*s %08x\n", #r, i, \\r\n(i < 10) ? 32 - strlen(#r) : 31 - strlen(#r), " ", \\r\nhdmi_read_reg(hdmi_av_base(ip_data), CORE_REG(i, r)))\r\nDUMPCORE(HDMI_CORE_SYS_VND_IDL);\r\nDUMPCORE(HDMI_CORE_SYS_DEV_IDL);\r\nDUMPCORE(HDMI_CORE_SYS_DEV_IDH);\r\nDUMPCORE(HDMI_CORE_SYS_DEV_REV);\r\nDUMPCORE(HDMI_CORE_SYS_SRST);\r\nDUMPCORE(HDMI_CORE_CTRL1);\r\nDUMPCORE(HDMI_CORE_SYS_SYS_STAT);\r\nDUMPCORE(HDMI_CORE_SYS_DE_DLY);\r\nDUMPCORE(HDMI_CORE_SYS_DE_CTRL);\r\nDUMPCORE(HDMI_CORE_SYS_DE_TOP);\r\nDUMPCORE(HDMI_CORE_SYS_DE_CNTL);\r\nDUMPCORE(HDMI_CORE_SYS_DE_CNTH);\r\nDUMPCORE(HDMI_CORE_SYS_DE_LINL);\r\nDUMPCORE(HDMI_CORE_SYS_DE_LINH_1);\r\nDUMPCORE(HDMI_CORE_SYS_VID_ACEN);\r\nDUMPCORE(HDMI_CORE_SYS_VID_MODE);\r\nDUMPCORE(HDMI_CORE_SYS_INTR_STATE);\r\nDUMPCORE(HDMI_CORE_SYS_INTR1);\r\nDUMPCORE(HDMI_CORE_SYS_INTR2);\r\nDUMPCORE(HDMI_CORE_SYS_INTR3);\r\nDUMPCORE(HDMI_CORE_SYS_INTR4);\r\nDUMPCORE(HDMI_CORE_SYS_UMASK1);\r\nDUMPCORE(HDMI_CORE_SYS_TMDS_CTRL);\r\nDUMPCORE(HDMI_CORE_DDC_ADDR);\r\nDUMPCORE(HDMI_CORE_DDC_SEGM);\r\nDUMPCORE(HDMI_CORE_DDC_OFFSET);\r\nDUMPCORE(HDMI_CORE_DDC_COUNT1);\r\nDUMPCORE(HDMI_CORE_DDC_COUNT2);\r\nDUMPCORE(HDMI_CORE_DDC_STATUS);\r\nDUMPCORE(HDMI_CORE_DDC_CMD);\r\nDUMPCORE(HDMI_CORE_DDC_DATA);\r\nDUMPCOREAV(HDMI_CORE_AV_ACR_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_FREQ_SVAL);\r\nDUMPCOREAV(HDMI_CORE_AV_N_SVAL1);\r\nDUMPCOREAV(HDMI_CORE_AV_N_SVAL2);\r\nDUMPCOREAV(HDMI_CORE_AV_N_SVAL3);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_SVAL1);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_SVAL2);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_SVAL3);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_HVAL1);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_HVAL2);\r\nDUMPCOREAV(HDMI_CORE_AV_CTS_HVAL3);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_MODE);\r\nDUMPCOREAV(HDMI_CORE_AV_SPDIF_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_HW_SPDIF_FS);\r\nDUMPCOREAV(HDMI_CORE_AV_SWAP_I2S);\r\nDUMPCOREAV(HDMI_CORE_AV_SPDIF_ERTH);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_IN_MAP);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_IN_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST0);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST1);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST2);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST4);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_CHST5);\r\nDUMPCOREAV(HDMI_CORE_AV_ASRC);\r\nDUMPCOREAV(HDMI_CORE_AV_I2S_IN_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_HDMI_CTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDO_TXSTAT);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_PAR_BUSCLK_1);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_PAR_BUSCLK_2);\r\nDUMPCOREAV(HDMI_CORE_AV_AUD_PAR_BUSCLK_3);\r\nDUMPCOREAV(HDMI_CORE_AV_TEST_TXCTRL);\r\nDUMPCOREAV(HDMI_CORE_AV_DPD);\r\nDUMPCOREAV(HDMI_CORE_AV_PB_CTRL1);\r\nDUMPCOREAV(HDMI_CORE_AV_PB_CTRL2);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_AVI_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_AVI_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_AVI_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_SPD_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_SPD_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_SPD_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_AUDIO_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_AUD_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_AUD_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_TYPE);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_VERS);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_LEN);\r\nDUMPCOREAV(HDMI_CORE_AV_MPEG_CHSUM);\r\nfor (i = 0; i < HDMI_CORE_AV_MPEG_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_MPEG_DBYTE);\r\nfor (i = 0; i < HDMI_CORE_AV_GEN_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_GEN_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_CP_BYTE1);\r\nfor (i = 0; i < HDMI_CORE_AV_GEN2_DBYTE_NELEMS; i++)\r\nDUMPCOREAV2(i, HDMI_CORE_AV_GEN2_DBYTE);\r\nDUMPCOREAV(HDMI_CORE_AV_CEC_ADDR_ID);\r\n}\r\nvoid ti_hdmi_4xxx_phy_dump(struct hdmi_ip_data *ip_data, struct seq_file *s)\r\n{\r\n#define DUMPPHY(r) seq_printf(s, "%-35s %08x\n", #r,\\r\nhdmi_read_reg(hdmi_phy_base(ip_data), r))\r\nDUMPPHY(HDMI_TXPHY_TX_CTRL);\r\nDUMPPHY(HDMI_TXPHY_DIGITAL_CTRL);\r\nDUMPPHY(HDMI_TXPHY_POWER_CTRL);\r\nDUMPPHY(HDMI_TXPHY_PAD_CFG_CTRL);\r\n}\r\nstatic void ti_hdmi_4xxx_wp_audio_config_format(struct hdmi_ip_data *ip_data,\r\nstruct hdmi_audio_format *aud_fmt)\r\n{\r\nu32 r;\r\nDSSDBG("Enter hdmi_wp_audio_config_format\n");\r\nr = hdmi_read_reg(hdmi_wp_base(ip_data), HDMI_WP_AUDIO_CFG);\r\nr = FLD_MOD(r, aud_fmt->stereo_channels, 26, 24);\r\nr = FLD_MOD(r, aud_fmt->active_chnnls_msk, 23, 16);\r\nr = FLD_MOD(r, aud_fmt->en_sig_blk_strt_end, 5, 5);\r\nr = FLD_MOD(r, aud_fmt->type, 4, 4);\r\nr = FLD_MOD(r, aud_fmt->justification, 3, 3);\r\nr = FLD_MOD(r, aud_fmt->sample_order, 2, 2);\r\nr = FLD_MOD(r, aud_fmt->samples_per_word, 1, 1);\r\nr = FLD_MOD(r, aud_fmt->sample_size, 0, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_AUDIO_CFG, r);\r\n}\r\nstatic void ti_hdmi_4xxx_wp_audio_config_dma(struct hdmi_ip_data *ip_data,\r\nstruct hdmi_audio_dma *aud_dma)\r\n{\r\nu32 r;\r\nDSSDBG("Enter hdmi_wp_audio_config_dma\n");\r\nr = hdmi_read_reg(hdmi_wp_base(ip_data), HDMI_WP_AUDIO_CFG2);\r\nr = FLD_MOD(r, aud_dma->transfer_size, 15, 8);\r\nr = FLD_MOD(r, aud_dma->block_size, 7, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_AUDIO_CFG2, r);\r\nr = hdmi_read_reg(hdmi_wp_base(ip_data), HDMI_WP_AUDIO_CTRL);\r\nr = FLD_MOD(r, aud_dma->mode, 9, 9);\r\nr = FLD_MOD(r, aud_dma->fifo_threshold, 8, 0);\r\nhdmi_write_reg(hdmi_wp_base(ip_data), HDMI_WP_AUDIO_CTRL, r);\r\n}\r\nstatic void ti_hdmi_4xxx_core_audio_config(struct hdmi_ip_data *ip_data,\r\nstruct hdmi_core_audio_config *cfg)\r\n{\r\nu32 r;\r\nvoid __iomem *av_base = hdmi_av_base(ip_data);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_N_SVAL1, cfg->n, 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_N_SVAL2, cfg->n >> 8, 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_N_SVAL3, cfg->n >> 16, 7, 0);\r\nif (cfg->cts_mode == HDMI_AUDIO_CTS_MODE_SW) {\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_CTS_SVAL1, cfg->cts, 7, 0);\r\nREG_FLD_MOD(av_base,\r\nHDMI_CORE_AV_CTS_SVAL2, cfg->cts >> 8, 7, 0);\r\nREG_FLD_MOD(av_base,\r\nHDMI_CORE_AV_CTS_SVAL3, cfg->cts >> 16, 7, 0);\r\n} else {\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_AUD_PAR_BUSCLK_1,\r\ncfg->aud_par_busclk, 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_AUD_PAR_BUSCLK_2,\r\n(cfg->aud_par_busclk >> 8), 7, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_AUD_PAR_BUSCLK_3,\r\n(cfg->aud_par_busclk >> 16), 7, 0);\r\n}\r\nREG_FLD_MOD(av_base,\r\nHDMI_CORE_AV_FREQ_SVAL, cfg->mclk_mode, 2, 0);\r\nr = hdmi_read_reg(av_base, HDMI_CORE_AV_ACR_CTRL);\r\nr = FLD_MOD(r, 0, 2, 2);\r\nr = FLD_MOD(r, cfg->en_acr_pkt, 1, 1);\r\nr = FLD_MOD(r, cfg->cts_mode, 0, 0);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_ACR_CTRL, r);\r\nif (cfg->use_mclk)\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_ACR_CTRL, 1, 2, 2);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_SPDIF_CTRL,\r\ncfg->fs_override, 1, 1);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST0,\r\ncfg->iec60958_cfg->status[0]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST1,\r\ncfg->iec60958_cfg->status[1]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST2,\r\ncfg->iec60958_cfg->status[2]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST4,\r\ncfg->iec60958_cfg->status[3]);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_CHST5,\r\ncfg->iec60958_cfg->status[4]);\r\nr = hdmi_read_reg(av_base, HDMI_CORE_AV_I2S_IN_CTRL);\r\nr = FLD_MOD(r, cfg->i2s_cfg.sck_edge_mode, 6, 6);\r\nr = FLD_MOD(r, cfg->i2s_cfg.vbit, 4, 4);\r\nr = FLD_MOD(r, cfg->i2s_cfg.justification, 2, 2);\r\nr = FLD_MOD(r, cfg->i2s_cfg.direction, 1, 1);\r\nr = FLD_MOD(r, cfg->i2s_cfg.shift, 0, 0);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_IN_CTRL, r);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_I2S_IN_LEN,\r\ncfg->i2s_cfg.in_length_bits, 3, 0);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_HDMI_CTRL, cfg->layout, 2, 1);\r\nr = hdmi_read_reg(av_base, HDMI_CORE_AV_AUD_MODE);\r\nr = FLD_MOD(r, cfg->i2s_cfg.active_sds, 7, 4);\r\nr = FLD_MOD(r, cfg->en_dsd_audio, 3, 3);\r\nr = FLD_MOD(r, cfg->en_parallel_aud_input, 2, 2);\r\nr = FLD_MOD(r, cfg->en_spdif, 1, 1);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_MODE, r);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_I2S_IN_MAP, 0x78);\r\nREG_FLD_MOD(av_base, HDMI_CORE_AV_SWAP_I2S, 1, 5, 5);\r\n}\r\nstatic void ti_hdmi_4xxx_core_audio_infoframe_cfg(struct hdmi_ip_data *ip_data,\r\nstruct snd_cea_861_aud_if *info_aud)\r\n{\r\nu8 sum = 0, checksum = 0;\r\nvoid __iomem *av_base = hdmi_av_base(ip_data);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUDIO_TYPE, 0x84);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUDIO_VERS, 0x01);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUDIO_LEN, 0x0a);\r\nsum += 0x84 + 0x001 + 0x00a;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(0),\r\ninfo_aud->db1_ct_cc);\r\nsum += info_aud->db1_ct_cc;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(1),\r\ninfo_aud->db2_sf_ss);\r\nsum += info_aud->db2_sf_ss;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(2), info_aud->db3);\r\nsum += info_aud->db3;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(3), info_aud->db4_ca);\r\nsum += info_aud->db4_ca;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(4),\r\ninfo_aud->db5_dminh_lsv);\r\nsum += info_aud->db5_dminh_lsv;\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(5), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(6), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(7), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(8), 0x00);\r\nhdmi_write_reg(av_base, HDMI_CORE_AV_AUD_DBYTE(9), 0x00);\r\nchecksum = 0x100 - sum;\r\nhdmi_write_reg(av_base,\r\nHDMI_CORE_AV_AUDIO_CHSUM, checksum);\r\n}\r\nint ti_hdmi_4xxx_audio_config(struct hdmi_ip_data *ip_data,\r\nstruct omap_dss_audio *audio)\r\n{\r\nstruct hdmi_audio_format audio_format;\r\nstruct hdmi_audio_dma audio_dma;\r\nstruct hdmi_core_audio_config core;\r\nint err, n, cts, channel_count;\r\nunsigned int fs_nr;\r\nbool word_length_16b = false;\r\nif (!audio || !audio->iec || !audio->cea || !ip_data)\r\nreturn -EINVAL;\r\ncore.iec60958_cfg = audio->iec;\r\nif (!(audio->iec->status[4] & IEC958_AES4_CON_MAX_WORDLEN_24))\r\nif (audio->iec->status[4] & IEC958_AES4_CON_WORDLEN_20_16)\r\nword_length_16b = true;\r\nif (word_length_16b)\r\ncore.i2s_cfg.justification = HDMI_AUDIO_JUSTIFY_LEFT;\r\nelse\r\ncore.i2s_cfg.justification = HDMI_AUDIO_JUSTIFY_RIGHT;\r\ncore.i2s_cfg.in_length_bits = audio->iec->status[4]\r\n& IEC958_AES4_CON_WORDLEN;\r\nif (audio->iec->status[4] & IEC958_AES4_CON_MAX_WORDLEN_24)\r\ncore.i2s_cfg.in_length_bits++;\r\ncore.i2s_cfg.sck_edge_mode = HDMI_AUDIO_I2S_SCK_EDGE_RISING;\r\ncore.i2s_cfg.vbit = HDMI_AUDIO_I2S_VBIT_FOR_PCM;\r\ncore.i2s_cfg.direction = HDMI_AUDIO_I2S_MSB_SHIFTED_FIRST;\r\ncore.i2s_cfg.shift = HDMI_AUDIO_I2S_FIRST_BIT_SHIFT;\r\nswitch (audio->iec->status[3] & IEC958_AES3_CON_FS) {\r\ncase IEC958_AES3_CON_FS_32000:\r\nfs_nr = 32000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_44100:\r\nfs_nr = 44100;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_48000:\r\nfs_nr = 48000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_88200:\r\nfs_nr = 88200;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_96000:\r\nfs_nr = 96000;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_176400:\r\nfs_nr = 176400;\r\nbreak;\r\ncase IEC958_AES3_CON_FS_192000:\r\nfs_nr = 192000;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerr = hdmi_compute_acr(fs_nr, &n, &cts);\r\ncore.n = n;\r\ncore.cts = cts;\r\nif (dss_has_feature(FEAT_HDMI_CTS_SWMODE)) {\r\ncore.aud_par_busclk = 0;\r\ncore.cts_mode = HDMI_AUDIO_CTS_MODE_SW;\r\ncore.use_mclk = dss_has_feature(FEAT_HDMI_AUDIO_USE_MCLK);\r\n} else {\r\ncore.aud_par_busclk = (((128 * 31) - 1) << 8);\r\ncore.cts_mode = HDMI_AUDIO_CTS_MODE_HW;\r\ncore.use_mclk = true;\r\n}\r\nif (core.use_mclk)\r\ncore.mclk_mode = HDMI_AUDIO_MCLK_128FS;\r\nchannel_count = (audio->cea->db1_ct_cc &\r\nCEA861_AUDIO_INFOFRAME_DB1CC) + 1;\r\nswitch (channel_count) {\r\ncase 2:\r\naudio_format.active_chnnls_msk = 0x03;\r\nbreak;\r\ncase 3:\r\naudio_format.active_chnnls_msk = 0x07;\r\nbreak;\r\ncase 4:\r\naudio_format.active_chnnls_msk = 0x0f;\r\nbreak;\r\ncase 5:\r\naudio_format.active_chnnls_msk = 0x1f;\r\nbreak;\r\ncase 6:\r\naudio_format.active_chnnls_msk = 0x3f;\r\nbreak;\r\ncase 7:\r\naudio_format.active_chnnls_msk = 0x7f;\r\nbreak;\r\ncase 8:\r\naudio_format.active_chnnls_msk = 0xff;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (channel_count == 2) {\r\naudio_format.stereo_channels = HDMI_AUDIO_STEREO_ONECHANNEL;\r\ncore.i2s_cfg.active_sds = HDMI_AUDIO_I2S_SD0_EN;\r\ncore.layout = HDMI_AUDIO_LAYOUT_2CH;\r\n} else {\r\naudio_format.stereo_channels = HDMI_AUDIO_STEREO_FOURCHANNELS;\r\ncore.i2s_cfg.active_sds = HDMI_AUDIO_I2S_SD0_EN |\r\nHDMI_AUDIO_I2S_SD1_EN | HDMI_AUDIO_I2S_SD2_EN |\r\nHDMI_AUDIO_I2S_SD3_EN;\r\ncore.layout = HDMI_AUDIO_LAYOUT_8CH;\r\n}\r\ncore.en_spdif = false;\r\ncore.fs_override = true;\r\ncore.en_acr_pkt = true;\r\ncore.en_dsd_audio = false;\r\ncore.en_parallel_aud_input = true;\r\nif (word_length_16b)\r\naudio_dma.transfer_size = 0x10;\r\nelse\r\naudio_dma.transfer_size = 0x20;\r\naudio_dma.block_size = 0xC0;\r\naudio_dma.mode = HDMI_AUDIO_TRANSF_DMA;\r\naudio_dma.fifo_threshold = 0x20;\r\nif (word_length_16b) {\r\naudio_format.samples_per_word = HDMI_AUDIO_ONEWORD_TWOSAMPLES;\r\naudio_format.sample_size = HDMI_AUDIO_SAMPLE_16BITS;\r\naudio_format.justification = HDMI_AUDIO_JUSTIFY_LEFT;\r\n} else {\r\naudio_format.samples_per_word = HDMI_AUDIO_ONEWORD_ONESAMPLE;\r\naudio_format.sample_size = HDMI_AUDIO_SAMPLE_24BITS;\r\naudio_format.justification = HDMI_AUDIO_JUSTIFY_RIGHT;\r\n}\r\naudio_format.type = HDMI_AUDIO_TYPE_LPCM;\r\naudio_format.sample_order = HDMI_AUDIO_SAMPLE_LEFT_FIRST;\r\naudio_format.en_sig_blk_strt_end = HDMI_AUDIO_BLOCK_SIG_STARTEND_ON;\r\nti_hdmi_4xxx_wp_audio_config_dma(ip_data, &audio_dma);\r\nti_hdmi_4xxx_wp_audio_config_format(ip_data, &audio_format);\r\nti_hdmi_4xxx_core_audio_config(ip_data, &core);\r\nti_hdmi_4xxx_core_audio_infoframe_cfg(ip_data, audio->cea);\r\nreturn 0;\r\n}\r\nint ti_hdmi_4xxx_wp_audio_enable(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_wp_base(ip_data),\r\nHDMI_WP_AUDIO_CTRL, true, 31, 31);\r\nreturn 0;\r\n}\r\nvoid ti_hdmi_4xxx_wp_audio_disable(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_wp_base(ip_data),\r\nHDMI_WP_AUDIO_CTRL, false, 31, 31);\r\n}\r\nint ti_hdmi_4xxx_audio_start(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_av_base(ip_data),\r\nHDMI_CORE_AV_AUD_MODE, true, 0, 0);\r\nREG_FLD_MOD(hdmi_wp_base(ip_data),\r\nHDMI_WP_AUDIO_CTRL, true, 30, 30);\r\nreturn 0;\r\n}\r\nvoid ti_hdmi_4xxx_audio_stop(struct hdmi_ip_data *ip_data)\r\n{\r\nREG_FLD_MOD(hdmi_av_base(ip_data),\r\nHDMI_CORE_AV_AUD_MODE, false, 0, 0);\r\nREG_FLD_MOD(hdmi_wp_base(ip_data),\r\nHDMI_WP_AUDIO_CTRL, false, 30, 30);\r\n}

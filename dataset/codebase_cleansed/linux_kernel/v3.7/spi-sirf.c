static void spi_sirfsoc_rx_word_u8(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data;\r\nu8 *rx = sspi->rx;\r\ndata = readl(sspi->base + SIRFSOC_SPI_RXFIFO_DATA);\r\nif (rx) {\r\n*rx++ = (u8) data;\r\nsspi->rx = rx;\r\n}\r\nsspi->left_rx_cnt--;\r\n}\r\nstatic void spi_sirfsoc_tx_word_u8(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data = 0;\r\nconst u8 *tx = sspi->tx;\r\nif (tx) {\r\ndata = *tx++;\r\nsspi->tx = tx;\r\n}\r\nwritel(data, sspi->base + SIRFSOC_SPI_TXFIFO_DATA);\r\nsspi->left_tx_cnt--;\r\n}\r\nstatic void spi_sirfsoc_rx_word_u16(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data;\r\nu16 *rx = sspi->rx;\r\ndata = readl(sspi->base + SIRFSOC_SPI_RXFIFO_DATA);\r\nif (rx) {\r\n*rx++ = (u16) data;\r\nsspi->rx = rx;\r\n}\r\nsspi->left_rx_cnt--;\r\n}\r\nstatic void spi_sirfsoc_tx_word_u16(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data = 0;\r\nconst u16 *tx = sspi->tx;\r\nif (tx) {\r\ndata = *tx++;\r\nsspi->tx = tx;\r\n}\r\nwritel(data, sspi->base + SIRFSOC_SPI_TXFIFO_DATA);\r\nsspi->left_tx_cnt--;\r\n}\r\nstatic void spi_sirfsoc_rx_word_u32(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data;\r\nu32 *rx = sspi->rx;\r\ndata = readl(sspi->base + SIRFSOC_SPI_RXFIFO_DATA);\r\nif (rx) {\r\n*rx++ = (u32) data;\r\nsspi->rx = rx;\r\n}\r\nsspi->left_rx_cnt--;\r\n}\r\nstatic void spi_sirfsoc_tx_word_u32(struct sirfsoc_spi *sspi)\r\n{\r\nu32 data = 0;\r\nconst u32 *tx = sspi->tx;\r\nif (tx) {\r\ndata = *tx++;\r\nsspi->tx = tx;\r\n}\r\nwritel(data, sspi->base + SIRFSOC_SPI_TXFIFO_DATA);\r\nsspi->left_tx_cnt--;\r\n}\r\nstatic void spi_sirfsoc_tasklet_tx(unsigned long arg)\r\n{\r\nstruct sirfsoc_spi *sspi = (struct sirfsoc_spi *)arg;\r\nwhile (!((readl(sspi->base + SIRFSOC_SPI_TXFIFO_STATUS) &\r\nSIRFSOC_SPI_FIFO_FULL)) &&\r\nsspi->left_tx_cnt)\r\nsspi->tx_word(sspi);\r\n}\r\nstatic irqreturn_t spi_sirfsoc_irq(int irq, void *dev_id)\r\n{\r\nstruct sirfsoc_spi *sspi = dev_id;\r\nu32 spi_stat = readl(sspi->base + SIRFSOC_SPI_INT_STATUS);\r\nwritel(spi_stat, sspi->base + SIRFSOC_SPI_INT_STATUS);\r\nif (spi_stat & SIRFSOC_SPI_RX_OFLOW ||\r\nspi_stat & SIRFSOC_SPI_TX_UFLOW) {\r\ncomplete(&sspi->done);\r\nwritel(0x0, sspi->base + SIRFSOC_SPI_INT_EN);\r\n}\r\nif (spi_stat & SIRFSOC_SPI_FRM_END) {\r\nwhile (!((readl(sspi->base + SIRFSOC_SPI_RXFIFO_STATUS)\r\n& SIRFSOC_SPI_FIFO_EMPTY)) &&\r\nsspi->left_rx_cnt)\r\nsspi->rx_word(sspi);\r\nif ((sspi->left_rx_cnt == 0) && (sspi->left_tx_cnt == 0)) {\r\ncomplete(&sspi->done);\r\nwritel(0x0, sspi->base + SIRFSOC_SPI_INT_EN);\r\n}\r\n}\r\nif (spi_stat & SIRFSOC_SPI_RXFIFO_THD_REACH ||\r\nspi_stat & SIRFSOC_SPI_TXFIFO_THD_REACH ||\r\nspi_stat & SIRFSOC_SPI_RX_FIFO_FULL ||\r\nspi_stat & SIRFSOC_SPI_TXFIFO_EMPTY)\r\ntasklet_schedule(&sspi->tasklet_tx);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int spi_sirfsoc_transfer(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nint timeout = t->len * 10;\r\nsspi = spi_master_get_devdata(spi->master);\r\nsspi->tx = t->tx_buf;\r\nsspi->rx = t->rx_buf;\r\nsspi->left_tx_cnt = sspi->left_rx_cnt = t->len;\r\nINIT_COMPLETION(sspi->done);\r\nwritel(SIRFSOC_SPI_INT_MASK_ALL, sspi->base + SIRFSOC_SPI_INT_STATUS);\r\nif (t->len == 1) {\r\nwritel(readl(sspi->base + SIRFSOC_SPI_CTRL) |\r\nSIRFSOC_SPI_ENA_AUTO_CLR,\r\nsspi->base + SIRFSOC_SPI_CTRL);\r\nwritel(0, sspi->base + SIRFSOC_SPI_TX_DMA_IO_LEN);\r\nwritel(0, sspi->base + SIRFSOC_SPI_RX_DMA_IO_LEN);\r\n} else if ((t->len > 1) && (t->len < SIRFSOC_SPI_DAT_FRM_LEN_MAX)) {\r\nwritel(readl(sspi->base + SIRFSOC_SPI_CTRL) |\r\nSIRFSOC_SPI_MUL_DAT_MODE |\r\nSIRFSOC_SPI_ENA_AUTO_CLR,\r\nsspi->base + SIRFSOC_SPI_CTRL);\r\nwritel(t->len - 1, sspi->base + SIRFSOC_SPI_TX_DMA_IO_LEN);\r\nwritel(t->len - 1, sspi->base + SIRFSOC_SPI_RX_DMA_IO_LEN);\r\n} else {\r\nwritel(readl(sspi->base + SIRFSOC_SPI_CTRL),\r\nsspi->base + SIRFSOC_SPI_CTRL);\r\nwritel(0, sspi->base + SIRFSOC_SPI_TX_DMA_IO_LEN);\r\nwritel(0, sspi->base + SIRFSOC_SPI_RX_DMA_IO_LEN);\r\n}\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nsspi->tx_word(sspi);\r\nwritel(SIRFSOC_SPI_RX_OFLOW_INT_EN | SIRFSOC_SPI_TX_UFLOW_INT_EN |\r\nSIRFSOC_SPI_RXFIFO_THD_INT_EN | SIRFSOC_SPI_TXFIFO_THD_INT_EN |\r\nSIRFSOC_SPI_FRM_END_INT_EN | SIRFSOC_SPI_RXFIFO_FULL_INT_EN |\r\nSIRFSOC_SPI_TXFIFO_EMPTY_INT_EN, sspi->base + SIRFSOC_SPI_INT_EN);\r\nwritel(SIRFSOC_SPI_RX_EN | SIRFSOC_SPI_TX_EN, sspi->base + SIRFSOC_SPI_TX_RX_EN);\r\nif (wait_for_completion_timeout(&sspi->done, timeout) == 0)\r\ndev_err(&spi->dev, "transfer timeout\n");\r\nwritel(0, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(0, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nwritel(0, sspi->base + SIRFSOC_SPI_TX_RX_EN);\r\nwritel(0, sspi->base + SIRFSOC_SPI_INT_EN);\r\nreturn t->len - sspi->left_rx_cnt;\r\n}\r\nstatic void spi_sirfsoc_chipselect(struct spi_device *spi, int value)\r\n{\r\nstruct sirfsoc_spi *sspi = spi_master_get_devdata(spi->master);\r\nif (sspi->chipselect[spi->chip_select] == 0) {\r\nu32 regval = readl(sspi->base + SIRFSOC_SPI_CTRL);\r\nregval |= SIRFSOC_SPI_CS_IO_OUT;\r\nswitch (value) {\r\ncase BITBANG_CS_ACTIVE:\r\nif (spi->mode & SPI_CS_HIGH)\r\nregval |= SIRFSOC_SPI_CS_IO_OUT;\r\nelse\r\nregval &= ~SIRFSOC_SPI_CS_IO_OUT;\r\nbreak;\r\ncase BITBANG_CS_INACTIVE:\r\nif (spi->mode & SPI_CS_HIGH)\r\nregval &= ~SIRFSOC_SPI_CS_IO_OUT;\r\nelse\r\nregval |= SIRFSOC_SPI_CS_IO_OUT;\r\nbreak;\r\n}\r\nwritel(regval, sspi->base + SIRFSOC_SPI_CTRL);\r\n} else {\r\nint gpio = sspi->chipselect[spi->chip_select];\r\ngpio_direction_output(gpio, spi->mode & SPI_CS_HIGH ? 0 : 1);\r\n}\r\n}\r\nstatic int\r\nspi_sirfsoc_setup_transfer(struct spi_device *spi, struct spi_transfer *t)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nu8 bits_per_word = 0;\r\nint hz = 0;\r\nu32 regval;\r\nu32 txfifo_ctrl, rxfifo_ctrl;\r\nu32 fifo_size = SIRFSOC_SPI_FIFO_SIZE / 4;\r\nsspi = spi_master_get_devdata(spi->master);\r\nbits_per_word = t && t->bits_per_word ? t->bits_per_word :\r\nspi->bits_per_word;\r\nhz = t && t->speed_hz ? t->speed_hz : spi->max_speed_hz;\r\nwritel(SIRFSOC_SPI_IO_MODE_SEL, sspi->base + SIRFSOC_SPI_TX_DMA_IO_CTRL);\r\nwritel(SIRFSOC_SPI_IO_MODE_SEL, sspi->base + SIRFSOC_SPI_RX_DMA_IO_CTRL);\r\nregval = (sspi->ctrl_freq / (2 * hz)) - 1;\r\nif (regval > 0xFFFF || regval < 0) {\r\ndev_err(&spi->dev, "Speed %d not supported\n", hz);\r\nreturn -EINVAL;\r\n}\r\nswitch (bits_per_word) {\r\ncase 8:\r\nregval |= SIRFSOC_SPI_TRAN_DAT_FORMAT_8;\r\nsspi->rx_word = spi_sirfsoc_rx_word_u8;\r\nsspi->tx_word = spi_sirfsoc_tx_word_u8;\r\ntxfifo_ctrl = SIRFSOC_SPI_FIFO_THD(SIRFSOC_SPI_FIFO_SIZE / 2) |\r\nSIRFSOC_SPI_FIFO_WIDTH_BYTE;\r\nrxfifo_ctrl = SIRFSOC_SPI_FIFO_THD(SIRFSOC_SPI_FIFO_SIZE / 2) |\r\nSIRFSOC_SPI_FIFO_WIDTH_BYTE;\r\nbreak;\r\ncase 12:\r\ncase 16:\r\nregval |= (bits_per_word == 12) ? SIRFSOC_SPI_TRAN_DAT_FORMAT_12 :\r\nSIRFSOC_SPI_TRAN_DAT_FORMAT_16;\r\nsspi->rx_word = spi_sirfsoc_rx_word_u16;\r\nsspi->tx_word = spi_sirfsoc_tx_word_u16;\r\ntxfifo_ctrl = SIRFSOC_SPI_FIFO_THD(SIRFSOC_SPI_FIFO_SIZE / 2) |\r\nSIRFSOC_SPI_FIFO_WIDTH_WORD;\r\nrxfifo_ctrl = SIRFSOC_SPI_FIFO_THD(SIRFSOC_SPI_FIFO_SIZE / 2) |\r\nSIRFSOC_SPI_FIFO_WIDTH_WORD;\r\nbreak;\r\ncase 32:\r\nregval |= SIRFSOC_SPI_TRAN_DAT_FORMAT_32;\r\nsspi->rx_word = spi_sirfsoc_rx_word_u32;\r\nsspi->tx_word = spi_sirfsoc_tx_word_u32;\r\ntxfifo_ctrl = SIRFSOC_SPI_FIFO_THD(SIRFSOC_SPI_FIFO_SIZE / 2) |\r\nSIRFSOC_SPI_FIFO_WIDTH_DWORD;\r\nrxfifo_ctrl = SIRFSOC_SPI_FIFO_THD(SIRFSOC_SPI_FIFO_SIZE / 2) |\r\nSIRFSOC_SPI_FIFO_WIDTH_DWORD;\r\nbreak;\r\ndefault:\r\ndev_err(&spi->dev, "Bits per word %d not supported\n",\r\nbits_per_word);\r\nreturn -EINVAL;\r\n}\r\nif (!(spi->mode & SPI_CS_HIGH))\r\nregval |= SIRFSOC_SPI_CS_IDLE_STAT;\r\nif (!(spi->mode & SPI_LSB_FIRST))\r\nregval |= SIRFSOC_SPI_TRAN_MSB;\r\nif (spi->mode & SPI_CPOL)\r\nregval |= SIRFSOC_SPI_CLK_IDLE_STAT;\r\nif (((spi->mode & SPI_CPOL) && (spi->mode & SPI_CPHA)) ||\r\n(!(spi->mode & SPI_CPOL) && !(spi->mode & SPI_CPHA)))\r\nregval &= ~SIRFSOC_SPI_DRV_POS_EDGE;\r\nelse\r\nregval |= SIRFSOC_SPI_DRV_POS_EDGE;\r\nwritel(SIRFSOC_SPI_FIFO_SC(fifo_size - 2) |\r\nSIRFSOC_SPI_FIFO_LC(fifo_size / 2) |\r\nSIRFSOC_SPI_FIFO_HC(2),\r\nsspi->base + SIRFSOC_SPI_TXFIFO_LEVEL_CHK);\r\nwritel(SIRFSOC_SPI_FIFO_SC(2) |\r\nSIRFSOC_SPI_FIFO_LC(fifo_size / 2) |\r\nSIRFSOC_SPI_FIFO_HC(fifo_size - 2),\r\nsspi->base + SIRFSOC_SPI_RXFIFO_LEVEL_CHK);\r\nwritel(txfifo_ctrl, sspi->base + SIRFSOC_SPI_TXFIFO_CTRL);\r\nwritel(rxfifo_ctrl, sspi->base + SIRFSOC_SPI_RXFIFO_CTRL);\r\nwritel(regval, sspi->base + SIRFSOC_SPI_CTRL);\r\nreturn 0;\r\n}\r\nstatic int spi_sirfsoc_setup(struct spi_device *spi)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nif (!spi->max_speed_hz)\r\nreturn -EINVAL;\r\nsspi = spi_master_get_devdata(spi->master);\r\nif (!spi->bits_per_word)\r\nspi->bits_per_word = 8;\r\nreturn spi_sirfsoc_setup_transfer(spi, NULL);\r\n}\r\nstatic int __devinit spi_sirfsoc_probe(struct platform_device *pdev)\r\n{\r\nstruct sirfsoc_spi *sspi;\r\nstruct spi_master *master;\r\nstruct resource *mem_res;\r\nint num_cs, cs_gpio, irq;\r\nint i;\r\nint ret;\r\nret = of_property_read_u32(pdev->dev.of_node,\r\n"sirf,spi-num-chipselects", &num_cs);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Unable to get chip select number\n");\r\ngoto err_cs;\r\n}\r\nmaster = spi_alloc_master(&pdev->dev, sizeof(*sspi) + sizeof(int) * num_cs);\r\nif (!master) {\r\ndev_err(&pdev->dev, "Unable to allocate SPI master\n");\r\nreturn -ENOMEM;\r\n}\r\nplatform_set_drvdata(pdev, master);\r\nsspi = spi_master_get_devdata(master);\r\nmem_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!mem_res) {\r\ndev_err(&pdev->dev, "Unable to get IO resource\n");\r\nret = -ENODEV;\r\ngoto free_master;\r\n}\r\nmaster->num_chipselect = num_cs;\r\nfor (i = 0; i < master->num_chipselect; i++) {\r\ncs_gpio = of_get_named_gpio(pdev->dev.of_node, "cs-gpios", i);\r\nif (cs_gpio < 0) {\r\ndev_err(&pdev->dev, "can't get cs gpio from DT\n");\r\nret = -ENODEV;\r\ngoto free_master;\r\n}\r\nsspi->chipselect[i] = cs_gpio;\r\nif (cs_gpio == 0)\r\ncontinue;\r\nret = gpio_request(cs_gpio, DRIVER_NAME);\r\nif (ret) {\r\nwhile (i > 0) {\r\ni--;\r\nif (sspi->chipselect[i] > 0)\r\ngpio_free(sspi->chipselect[i]);\r\n}\r\ndev_err(&pdev->dev, "fail to request cs gpios\n");\r\ngoto free_master;\r\n}\r\n}\r\nsspi->base = devm_request_and_ioremap(&pdev->dev, mem_res);\r\nif (!sspi->base) {\r\ndev_err(&pdev->dev, "IO remap failed!\n");\r\nret = -ENOMEM;\r\ngoto free_master;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nret = -ENXIO;\r\ngoto free_master;\r\n}\r\nret = devm_request_irq(&pdev->dev, irq, spi_sirfsoc_irq, 0,\r\nDRIVER_NAME, sspi);\r\nif (ret)\r\ngoto free_master;\r\nsspi->bitbang.master = spi_master_get(master);\r\nsspi->bitbang.chipselect = spi_sirfsoc_chipselect;\r\nsspi->bitbang.setup_transfer = spi_sirfsoc_setup_transfer;\r\nsspi->bitbang.txrx_bufs = spi_sirfsoc_transfer;\r\nsspi->bitbang.master->setup = spi_sirfsoc_setup;\r\nmaster->bus_num = pdev->id;\r\nsspi->bitbang.master->dev.of_node = pdev->dev.of_node;\r\nsspi->p = pinctrl_get_select_default(&pdev->dev);\r\nret = IS_ERR(sspi->p);\r\nif (ret)\r\ngoto free_master;\r\nsspi->clk = clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sspi->clk)) {\r\nret = -EINVAL;\r\ngoto free_pin;\r\n}\r\nclk_enable(sspi->clk);\r\nsspi->ctrl_freq = clk_get_rate(sspi->clk);\r\ninit_completion(&sspi->done);\r\ntasklet_init(&sspi->tasklet_tx, spi_sirfsoc_tasklet_tx,\r\n(unsigned long)sspi);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nwritel(0, sspi->base + SIRFSOC_SPI_DUMMY_DELAY_CTL);\r\nret = spi_bitbang_start(&sspi->bitbang);\r\nif (ret)\r\ngoto free_clk;\r\ndev_info(&pdev->dev, "registerred, bus number = %d\n", master->bus_num);\r\nreturn 0;\r\nfree_clk:\r\nclk_disable(sspi->clk);\r\nclk_put(sspi->clk);\r\nfree_pin:\r\npinctrl_put(sspi->p);\r\nfree_master:\r\nspi_master_put(master);\r\nerr_cs:\r\nreturn ret;\r\n}\r\nstatic int __devexit spi_sirfsoc_remove(struct platform_device *pdev)\r\n{\r\nstruct spi_master *master;\r\nstruct sirfsoc_spi *sspi;\r\nint i;\r\nmaster = platform_get_drvdata(pdev);\r\nsspi = spi_master_get_devdata(master);\r\nspi_bitbang_stop(&sspi->bitbang);\r\nfor (i = 0; i < master->num_chipselect; i++) {\r\nif (sspi->chipselect[i] > 0)\r\ngpio_free(sspi->chipselect[i]);\r\n}\r\nclk_disable(sspi->clk);\r\nclk_put(sspi->clk);\r\npinctrl_put(sspi->p);\r\nspi_master_put(master);\r\nreturn 0;\r\n}\r\nstatic int spi_sirfsoc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct sirfsoc_spi *sspi = spi_master_get_devdata(master);\r\nclk_disable(sspi->clk);\r\nreturn 0;\r\n}\r\nstatic int spi_sirfsoc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct spi_master *master = platform_get_drvdata(pdev);\r\nstruct sirfsoc_spi *sspi = spi_master_get_devdata(master);\r\nclk_enable(sspi->clk);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_RESET, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + SIRFSOC_SPI_RXFIFO_OP);\r\nwritel(SIRFSOC_SPI_FIFO_START, sspi->base + SIRFSOC_SPI_TXFIFO_OP);\r\nreturn 0;\r\n}

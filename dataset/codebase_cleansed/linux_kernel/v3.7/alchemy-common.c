static inline void __au1300_usb_phyctl(void __iomem *base, int enable)\r\n{\r\nunsigned long r, s;\r\nr = __raw_readl(base + USB_DWC_CTRL2);\r\ns = __raw_readl(base + USB_DWC_CTRL3);\r\ns &= USB_DWC_CTRL3_OHCI1_CKEN | USB_DWC_CTRL3_OHCI0_CKEN |\r\nUSB_DWC_CTRL3_EHCI0_CKEN | USB_DWC_CTRL3_OTG0_CKEN;\r\nif (enable) {\r\nr |= USB_DWC_CTRL2_PHY1RS | USB_DWC_CTRL2_PHY0RS |\r\nUSB_DWC_CTRL2_PHYRS;\r\n__raw_writel(r, base + USB_DWC_CTRL2);\r\nwmb();\r\n} else if (!s) {\r\nr &= ~(USB_DWC_CTRL2_PHY1RS | USB_DWC_CTRL2_PHY0RS |\r\nUSB_DWC_CTRL2_PHYRS);\r\n__raw_writel(r, base + USB_DWC_CTRL2);\r\nwmb();\r\n}\r\n}\r\nstatic inline void __au1300_ohci_control(void __iomem *base, int enable, int id)\r\n{\r\nunsigned long r;\r\nif (enable) {\r\n__raw_writel(1, base + USB_DWC_CTRL7);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL3);\r\nr |= (id == 0) ? USB_DWC_CTRL3_OHCI0_CKEN\r\n: USB_DWC_CTRL3_OHCI1_CKEN;\r\n__raw_writel(r, base + USB_DWC_CTRL3);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\nr = __raw_readl(base + USB_INT_ENABLE);\r\nr |= (id == 0) ? USB_INTEN_OHCI0 : USB_INTEN_OHCI1;\r\n__raw_writel(r, base + USB_INT_ENABLE);\r\nwmb();\r\n__raw_writel(0, base + USB_DWC_CTRL7);\r\nwmb();\r\n} else {\r\nr = __raw_readl(base + USB_INT_ENABLE);\r\nr &= ~((id == 0) ? USB_INTEN_OHCI0 : USB_INTEN_OHCI1);\r\n__raw_writel(r, base + USB_INT_ENABLE);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL3);\r\nr &= ~((id == 0) ? USB_DWC_CTRL3_OHCI0_CKEN\r\n: USB_DWC_CTRL3_OHCI1_CKEN);\r\n__raw_writel(r, base + USB_DWC_CTRL3);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\n}\r\n}\r\nstatic inline void __au1300_ehci_control(void __iomem *base, int enable)\r\n{\r\nunsigned long r;\r\nif (enable) {\r\nr = __raw_readl(base + USB_DWC_CTRL3);\r\nr |= USB_DWC_CTRL3_EHCI0_CKEN;\r\n__raw_writel(r, base + USB_DWC_CTRL3);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL1);\r\nr |= USB_DWC_CTRL1_HSTRS;\r\n__raw_writel(r, base + USB_DWC_CTRL1);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\nr = __raw_readl(base + USB_INT_ENABLE);\r\nr |= USB_INTEN_EHCI;\r\n__raw_writel(r, base + USB_INT_ENABLE);\r\nwmb();\r\n} else {\r\nr = __raw_readl(base + USB_INT_ENABLE);\r\nr &= ~USB_INTEN_EHCI;\r\n__raw_writel(r, base + USB_INT_ENABLE);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL1);\r\nr &= ~USB_DWC_CTRL1_HSTRS;\r\n__raw_writel(r, base + USB_DWC_CTRL1);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL3);\r\nr &= ~USB_DWC_CTRL3_EHCI0_CKEN;\r\n__raw_writel(r, base + USB_DWC_CTRL3);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\n}\r\n}\r\nstatic inline void __au1300_udc_control(void __iomem *base, int enable)\r\n{\r\nunsigned long r;\r\nif (enable) {\r\nr = __raw_readl(base + USB_DWC_CTRL1);\r\nr |= USB_DWC_CTRL1_DCRS;\r\n__raw_writel(r, base + USB_DWC_CTRL1);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\nr = __raw_readl(base + USB_INT_ENABLE);\r\nr |= USB_INTEN_UDC;\r\n__raw_writel(r, base + USB_INT_ENABLE);\r\nwmb();\r\n} else {\r\nr = __raw_readl(base + USB_INT_ENABLE);\r\nr &= ~USB_INTEN_UDC;\r\n__raw_writel(r, base + USB_INT_ENABLE);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL1);\r\nr &= ~USB_DWC_CTRL1_DCRS;\r\n__raw_writel(r, base + USB_DWC_CTRL1);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\n}\r\n}\r\nstatic inline void __au1300_otg_control(void __iomem *base, int enable)\r\n{\r\nunsigned long r;\r\nif (enable) {\r\nr = __raw_readl(base + USB_DWC_CTRL3);\r\nr |= USB_DWC_CTRL3_OTG0_CKEN;\r\n__raw_writel(r, base + USB_DWC_CTRL3);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL1);\r\nr &= ~USB_DWC_CTRL1_OTGD;\r\n__raw_writel(r, base + USB_DWC_CTRL1);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\n} else {\r\nr = __raw_readl(base + USB_DWC_CTRL1);\r\nr |= USB_DWC_CTRL1_OTGD;\r\n__raw_writel(r, base + USB_DWC_CTRL1);\r\nwmb();\r\nr = __raw_readl(base + USB_DWC_CTRL3);\r\nr &= ~USB_DWC_CTRL3_OTG0_CKEN;\r\n__raw_writel(r, base + USB_DWC_CTRL3);\r\nwmb();\r\n__au1300_usb_phyctl(base, enable);\r\n}\r\n}\r\nstatic inline int au1300_usb_control(int block, int enable)\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1300_USB_CTL_PHYS_ADDR);\r\nint ret = 0;\r\nswitch (block) {\r\ncase ALCHEMY_USB_OHCI0:\r\n__au1300_ohci_control(base, enable, 0);\r\nbreak;\r\ncase ALCHEMY_USB_OHCI1:\r\n__au1300_ohci_control(base, enable, 1);\r\nbreak;\r\ncase ALCHEMY_USB_EHCI0:\r\n__au1300_ehci_control(base, enable);\r\nbreak;\r\ncase ALCHEMY_USB_UDC0:\r\n__au1300_udc_control(base, enable);\r\nbreak;\r\ncase ALCHEMY_USB_OTG0:\r\n__au1300_otg_control(base, enable);\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline void au1300_usb_init(void)\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1300_USB_CTL_PHYS_ADDR);\r\n__raw_writel(0, base + USB_INT_ENABLE);\r\nwmb();\r\n__raw_writel(0, base + USB_DWC_CTRL3);\r\nwmb();\r\n__raw_writel(~0, base + USB_MSR_ERR);\r\nwmb();\r\n__raw_writel(~0, base + USB_INT_STATUS);\r\nwmb();\r\n__raw_writel(USB_SBUS_CTRL_SBCA, base + USB_SBUS_CTRL);\r\nwmb();\r\n}\r\nstatic inline void __au1200_ohci_control(void __iomem *base, int enable)\r\n{\r\nunsigned long r = __raw_readl(base + AU1200_USBCFG);\r\nif (enable) {\r\n__raw_writel(r | USBCFG_OCE, base + AU1200_USBCFG);\r\nwmb();\r\nudelay(2000);\r\n} else {\r\n__raw_writel(r & ~USBCFG_OCE, base + AU1200_USBCFG);\r\nwmb();\r\nudelay(1000);\r\n}\r\n}\r\nstatic inline void __au1200_ehci_control(void __iomem *base, int enable)\r\n{\r\nunsigned long r = __raw_readl(base + AU1200_USBCFG);\r\nif (enable) {\r\n__raw_writel(r | USBCFG_ECE | USBCFG_PPE, base + AU1200_USBCFG);\r\nwmb();\r\nudelay(1000);\r\n} else {\r\nif (!(r & USBCFG_UCE))\r\nr &= ~USBCFG_PPE;\r\n__raw_writel(r & ~USBCFG_ECE, base + AU1200_USBCFG);\r\nwmb();\r\nudelay(1000);\r\n}\r\n}\r\nstatic inline void __au1200_udc_control(void __iomem *base, int enable)\r\n{\r\nunsigned long r = __raw_readl(base + AU1200_USBCFG);\r\nif (enable) {\r\n__raw_writel(r | USBCFG_UCE | USBCFG_PPE, base + AU1200_USBCFG);\r\nwmb();\r\n} else {\r\nif (!(r & USBCFG_ECE))\r\nr &= ~USBCFG_PPE;\r\n__raw_writel(r & ~USBCFG_UCE, base + AU1200_USBCFG);\r\nwmb();\r\n}\r\n}\r\nstatic inline int au1200_coherency_bug(void)\r\n{\r\n#if defined(CONFIG_DMA_COHERENT)\r\nif (!(read_c0_prid() & 0xff)) {\r\nprintk(KERN_INFO "Au1200 USB: this is chip revision AB !!\n");\r\nprintk(KERN_INFO "Au1200 USB: update your board or re-configure"\r\n" the kernel\n");\r\nreturn -ENODEV;\r\n}\r\n#endif\r\nreturn 0;\r\n}\r\nstatic inline int au1200_usb_control(int block, int enable)\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1200_USB_CTL_PHYS_ADDR);\r\nint ret = 0;\r\nswitch (block) {\r\ncase ALCHEMY_USB_OHCI0:\r\nret = au1200_coherency_bug();\r\nif (ret && enable)\r\ngoto out;\r\n__au1200_ohci_control(base, enable);\r\nbreak;\r\ncase ALCHEMY_USB_UDC0:\r\n__au1200_udc_control(base, enable);\r\nbreak;\r\ncase ALCHEMY_USB_EHCI0:\r\nret = au1200_coherency_bug();\r\nif (ret && enable)\r\ngoto out;\r\n__au1200_ehci_control(base, enable);\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\n}\r\nout:\r\nreturn ret;\r\n}\r\nstatic inline void au1200_usb_init(void)\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1200_USB_CTL_PHYS_ADDR);\r\n__raw_writel(USBCFG_INIT_AU1200, base + AU1200_USBCFG);\r\nwmb();\r\nudelay(1000);\r\n}\r\nstatic inline void au1000_usb_init(unsigned long rb, int reg)\r\n{\r\nvoid __iomem *base = (void __iomem *)KSEG1ADDR(rb + reg);\r\nunsigned long r = __raw_readl(base);\r\n#if defined(__BIG_ENDIAN)\r\nr |= USBHEN_BE;\r\n#endif\r\nr |= USBHEN_C;\r\n__raw_writel(r, base);\r\nwmb();\r\nudelay(1000);\r\n}\r\nstatic inline void __au1xx0_ohci_control(int enable, unsigned long rb, int creg)\r\n{\r\nvoid __iomem *base = (void __iomem *)KSEG1ADDR(rb);\r\nunsigned long r = __raw_readl(base + creg);\r\nif (enable) {\r\n__raw_writel(r | USBHEN_CE, base + creg);\r\nwmb();\r\nudelay(1000);\r\n__raw_writel(r | USBHEN_CE | USBHEN_E, base + creg);\r\nwmb();\r\nudelay(1000);\r\nwhile (__raw_readl(base + creg),\r\n!(__raw_readl(base + creg) & USBHEN_RD))\r\nudelay(1000);\r\n} else {\r\n__raw_writel(r & ~(USBHEN_CE | USBHEN_E), base + creg);\r\nwmb();\r\n}\r\n}\r\nstatic inline int au1000_usb_control(int block, int enable, unsigned long rb,\r\nint creg)\r\n{\r\nint ret = 0;\r\nswitch (block) {\r\ncase ALCHEMY_USB_OHCI0:\r\n__au1xx0_ohci_control(enable, rb, creg);\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\n}\r\nreturn ret;\r\n}\r\nint alchemy_usb_control(int block, int enable)\r\n{\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&alchemy_usb_lock, flags);\r\nswitch (alchemy_get_cputype()) {\r\ncase ALCHEMY_CPU_AU1000:\r\ncase ALCHEMY_CPU_AU1500:\r\ncase ALCHEMY_CPU_AU1100:\r\nret = au1000_usb_control(block, enable,\r\nAU1000_USB_OHCI_PHYS_ADDR, AU1000_OHCICFG);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1550:\r\nret = au1000_usb_control(block, enable,\r\nAU1550_USB_OHCI_PHYS_ADDR, AU1550_OHCICFG);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1200:\r\nret = au1200_usb_control(block, enable);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1300:\r\nret = au1300_usb_control(block, enable);\r\nbreak;\r\ndefault:\r\nret = -ENODEV;\r\n}\r\nspin_unlock_irqrestore(&alchemy_usb_lock, flags);\r\nreturn ret;\r\n}\r\nstatic void au1000_usb_pm(unsigned long br, int creg, int susp)\r\n{\r\nvoid __iomem *base = (void __iomem *)KSEG1ADDR(br);\r\nif (susp) {\r\nalchemy_usb_pmdata[0] = __raw_readl(base + creg);\r\n__raw_writel(0, base + 0x04);\r\nwmb();\r\n__raw_writel(0, base + creg);\r\nwmb();\r\n} else {\r\n__raw_writel(alchemy_usb_pmdata[0], base + creg);\r\nwmb();\r\n}\r\n}\r\nstatic void au1200_usb_pm(int susp)\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1200_USB_OTG_PHYS_ADDR);\r\nif (susp) {\r\nalchemy_usb_pmdata[0] = __raw_readl(base + 0x00);\r\nalchemy_usb_pmdata[1] = __raw_readl(base + 0x04);\r\n} else {\r\nau1200_usb_init();\r\n__raw_writel(alchemy_usb_pmdata[0], base + 0x00);\r\n__raw_writel(alchemy_usb_pmdata[1], base + 0x04);\r\nwmb();\r\n}\r\n}\r\nstatic void au1300_usb_pm(int susp)\r\n{\r\nvoid __iomem *base =\r\n(void __iomem *)KSEG1ADDR(AU1300_USB_CTL_PHYS_ADDR);\r\nif (susp) {\r\nalchemy_usb_pmdata[0] = __raw_readl(base + USB_DWC_CTRL4);\r\n} else {\r\nau1300_usb_init();\r\n__raw_writel(alchemy_usb_pmdata[0], base + USB_DWC_CTRL4);\r\nwmb();\r\n}\r\n}\r\nstatic void alchemy_usb_pm(int susp)\r\n{\r\nswitch (alchemy_get_cputype()) {\r\ncase ALCHEMY_CPU_AU1000:\r\ncase ALCHEMY_CPU_AU1500:\r\ncase ALCHEMY_CPU_AU1100:\r\nau1000_usb_pm(AU1000_USB_OHCI_PHYS_ADDR, AU1000_OHCICFG, susp);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1550:\r\nau1000_usb_pm(AU1550_USB_OHCI_PHYS_ADDR, AU1550_OHCICFG, susp);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1200:\r\nau1200_usb_pm(susp);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1300:\r\nau1300_usb_pm(susp);\r\nbreak;\r\n}\r\n}\r\nstatic int alchemy_usb_suspend(void)\r\n{\r\nalchemy_usb_pm(1);\r\nreturn 0;\r\n}\r\nstatic void alchemy_usb_resume(void)\r\n{\r\nalchemy_usb_pm(0);\r\n}\r\nstatic int __init alchemy_usb_init(void)\r\n{\r\nswitch (alchemy_get_cputype()) {\r\ncase ALCHEMY_CPU_AU1000:\r\ncase ALCHEMY_CPU_AU1500:\r\ncase ALCHEMY_CPU_AU1100:\r\nau1000_usb_init(AU1000_USB_OHCI_PHYS_ADDR, AU1000_OHCICFG);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1550:\r\nau1000_usb_init(AU1550_USB_OHCI_PHYS_ADDR, AU1550_OHCICFG);\r\nbreak;\r\ncase ALCHEMY_CPU_AU1200:\r\nau1200_usb_init();\r\nbreak;\r\ncase ALCHEMY_CPU_AU1300:\r\nau1300_usb_init();\r\nbreak;\r\n}\r\nregister_syscore_ops(&alchemy_usb_pm_ops);\r\nreturn 0;\r\n}

CsrResult unifi_coredump_request_at_next_reset(card_t *card, s8 enable)\r\n{\r\nCsrResult r;\r\nfunc_enter();\r\nif (enable)\r\n{\r\nunifi_trace(card->ospriv, UDBG2, "Mini-coredump requested after reset\n");\r\n}\r\nif (card == NULL)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nelse\r\n{\r\ncard->request_coredump_on_reset = enable?1 : 0;\r\nr = CSR_RESULT_SUCCESS;\r\n}\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nCsrResult unifi_coredump_handle_request(card_t *card)\r\n{\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\nfunc_enter();\r\nif (card == NULL)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\n}\r\nelse\r\n{\r\nif (card->request_coredump_on_reset == 1)\r\n{\r\ncard->request_coredump_on_reset = 0;\r\nr = unifi_coredump_capture(card, NULL);\r\n}\r\n}\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nCsrResult unifi_coredump_capture(card_t *card, struct unifi_coredump_req *req)\r\n{\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\nstatic u16 dump_seq_no = 1;\r\nCsrTime time_of_capture;\r\nfunc_enter();\r\nif (card->dump_next_write == NULL)\r\n{\r\nr = CSR_RESULT_SUCCESS;\r\ngoto done;\r\n}\r\nif (card->helper == NULL)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\ngoto done;\r\n}\r\ntime_of_capture = CsrTimeGet(NULL);\r\nunifi_info(card->ospriv, "Mini-coredump capture at t=%u\n", time_of_capture);\r\nr = unifi_set_host_state(card, UNIFI_HOST_STATE_AWAKE);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to wake UniFi\n");\r\ngoto done;\r\n}\r\nCsrThreadSleep(20);\r\nunifi_trace(card->ospriv, UDBG4, "Stopping XAPs for coredump capture\n");\r\nr = unifi_card_stop_processor(card, UNIFI_PROC_BOTH);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to stop UniFi XAPs\n");\r\ngoto done;\r\n}\r\nr = unifi_coredump_from_sdio(card, card->dump_next_write);\r\nif (r == CSR_RESULT_SUCCESS)\r\n{\r\ncard->dump_next_write->requestor = (req?1 : 0);\r\ncard->dump_next_write->timestamp = time_of_capture;\r\ncard->dump_next_write->count = dump_seq_no++;\r\ncard->dump_cur_read = card->dump_next_write;\r\ncard->dump_next_write = card->dump_next_write->next;\r\nif (dump_seq_no == 0)\r\n{\r\ndump_seq_no = 1;\r\n}\r\nunifi_trace(card->ospriv, UDBG3,\r\n"Coredump (%p), SeqNo=%d, cur_read=%p, next_write=%p\n",\r\nreq,\r\ncard->dump_cur_read->count,\r\ncard->dump_cur_read, card->dump_next_write);\r\n}\r\nunifi_trace(card->ospriv, UDBG4, "Restart XAPs after coredump\n");\r\nr = card_start_processor(card, UNIFI_PROC_BOTH);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Failed to start UniFi XAPs\n");\r\ngoto done;\r\n}\r\ndone:\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nstatic s32 get_value_from_coredump(const coredump_buffer *coreDump,\r\nconst unifi_coredump_space_t space,\r\nconst u16 offset_in_space)\r\n{\r\ns32 r = -1;\r\nu16 offset_in_zone;\r\nu32 zone_end_offset;\r\ns32 i;\r\nconst struct coredump_zone *def = &zonedef_table[0];\r\nfor (i = 0; i < HIP_CDUMP_NUM_ZONES; i++, def++)\r\n{\r\nif (space == def->space)\r\n{\r\nzone_end_offset = def->offset + def->length;\r\nif (offset_in_space < zone_end_offset &&\r\noffset_in_space >= def->offset)\r\n{\r\noffset_in_zone = offset_in_space - def->offset;\r\nr = (s32) * (coreDump->zone[i] + offset_in_zone);\r\nunifi_trace(NULL, UDBG6,\r\n"sp %d, offs 0x%04x = 0x%04x (in z%d 0x%04x->0x%04x)\n",\r\nspace, offset_in_space, r,\r\ni, def->offset, zone_end_offset - 1);\r\nbreak;\r\n}\r\n}\r\n}\r\nreturn r;\r\n}\r\nCsrResult unifi_coredump_get_value(card_t *card, struct unifi_coredump_req *req)\r\n{\r\nCsrResult r;\r\ns32 i = 0;\r\ncoredump_buffer *find_dump = NULL;\r\nfunc_enter();\r\nif (req == NULL || card == NULL)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\ngoto done;\r\n}\r\nreq->value = -1;\r\nif (card->dump_buf == NULL)\r\n{\r\nunifi_trace(card->ospriv, UDBG2, "No coredump buffers\n");\r\nr = CSR_WIFI_HIP_RESULT_NOT_FOUND;\r\ngoto done;\r\n}\r\nif (card->dump_cur_read == NULL)\r\n{\r\nunifi_trace(card->ospriv, UDBG4, "No coredumps captured\n");\r\nr = CSR_WIFI_HIP_RESULT_NOT_FOUND;\r\ngoto done;\r\n}\r\nswitch (req->index)\r\n{\r\ncase 0:\r\nfind_dump = card->dump_cur_read;\r\nbreak;\r\ncase -1:\r\nfor (find_dump = card->dump_cur_read->next;\r\n(find_dump->count == 0) && (find_dump != card->dump_cur_read);\r\nfind_dump = card->dump_cur_read->next)\r\n{\r\n}\r\nbreak;\r\ndefault:\r\nfor (i = 0, find_dump = card->dump_cur_read;\r\ni < req->index;\r\ni++, find_dump = find_dump->prev)\r\n{\r\nunifi_trace(card->ospriv, UDBG6,\r\n"%d: %d, @%p, p=%p, n=%p, cr=%p, h=%p\n",\r\ni, find_dump->count, find_dump, find_dump->prev,\r\nfind_dump->next, card->dump_cur_read, card->dump_buf);\r\nif (find_dump->prev == card->dump_cur_read)\r\n{\r\nif (i != req->index)\r\n{\r\nunifi_trace(card->ospriv, UDBG6,\r\n"Dump index %d not found %d\n", req->index, i);\r\nr = CSR_WIFI_HIP_RESULT_NOT_FOUND;\r\ngoto done;\r\n}\r\nbreak;\r\n}\r\n}\r\nbreak;\r\n}\r\nif (find_dump->count == 0)\r\n{\r\nunifi_trace(card->ospriv, UDBG4, "Not captured %d\n", req->index);\r\nr = CSR_WIFI_HIP_RESULT_NOT_FOUND;\r\ngoto done;\r\n}\r\nunifi_trace(card->ospriv, UDBG6, "Req index %d, found seq %d at step %d\n",\r\nreq->index, find_dump->count, i);\r\nreq->value = get_value_from_coredump(find_dump, req->space, (u16)req->offset);\r\nif (req->value < 0)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_RANGE;\r\nunifi_trace(card->ospriv, UDBG4,\r\n"Can't read space %d, reg 0x%x from coredump buffer %d\n",\r\nreq->space, req->offset, req->index);\r\n}\r\nelse\r\n{\r\nr = CSR_RESULT_SUCCESS;\r\n}\r\nreq->chip_ver = find_dump->chip_ver;\r\nreq->fw_ver = find_dump->fw_ver;\r\nreq->timestamp = find_dump->timestamp;\r\nreq->requestor = find_dump->requestor;\r\nreq->serial = find_dump->count;\r\ndone:\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nstatic CsrResult unifi_coredump_read_zone(card_t *card, u16 *zonebuf, const struct coredump_zone *def)\r\n{\r\nCsrResult r;\r\nfunc_enter();\r\nif (zonebuf == NULL || def == NULL)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\ngoto done;\r\n}\r\nif (def->cpu != UNIFI_PROC_INVALID)\r\n{\r\nif (def->cpu != UNIFI_PROC_MAC && def->cpu != UNIFI_PROC_PHY)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\ngoto done;\r\n}\r\nr = unifi_set_proc_select(card, def->cpu);\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\ngoto done;\r\n}\r\n}\r\nunifi_trace(card->ospriv, UDBG4,\r\n"Dump sp %d, offs 0x%04x, 0x%04x words @GP=%08x CPU %d\n",\r\ndef->space, def->offset, def->length, def->gp, def->cpu);\r\nr = unifi_card_readn(card, def->gp, zonebuf, (u16)(def->length * 2));\r\nif (r == CSR_WIFI_HIP_RESULT_NO_DEVICE)\r\n{\r\ngoto done;\r\n}\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Can't read UniFi shared data area\n");\r\ngoto done;\r\n}\r\ndone:\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nstatic CsrResult unifi_coredump_read_zones(card_t *card, coredump_buffer *dump_buf)\r\n{\r\nCsrResult r = CSR_RESULT_SUCCESS;\r\ns32 i;\r\nfunc_enter();\r\nfor (i = 0;\r\n(i < HIP_CDUMP_NUM_ZONES) && (r == 0);\r\ni++)\r\n{\r\nr = unifi_coredump_read_zone(card, dump_buf->zone[i], &zonedef_table[i]);\r\n}\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nstatic CsrResult unifi_coredump_from_sdio(card_t *card, coredump_buffer *dump_buf)\r\n{\r\nu16 val;\r\nCsrResult r;\r\nu32 sdio_addr;\r\nfunc_enter();\r\nif (dump_buf == NULL)\r\n{\r\nr = CSR_WIFI_HIP_RESULT_INVALID_VALUE;\r\ngoto done;\r\n}\r\nunifi_trace(card->ospriv, UDBG4, "Get chip version\n");\r\nsdio_addr = 2 * ChipHelper_GBL_CHIP_VERSION(card->helper);\r\nif (sdio_addr != 0)\r\n{\r\nr = unifi_read_direct16(card, sdio_addr, &val);\r\nif (r == CSR_WIFI_HIP_RESULT_NO_DEVICE)\r\n{\r\ngoto done;\r\n}\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Can't read GBL_CHIP_VERSION\n");\r\ngoto done;\r\n}\r\n}\r\ndump_buf->chip_ver = val;\r\ndump_buf->fw_ver = card->build_id;\r\nunifi_trace(card->ospriv, UDBG4, "chip_ver 0x%04x, fw_ver %u\n",\r\ndump_buf->chip_ver, dump_buf->fw_ver);\r\nr = unifi_coredump_read_zones(card, dump_buf);\r\nif (r == CSR_WIFI_HIP_RESULT_NO_DEVICE)\r\n{\r\ngoto done;\r\n}\r\nif (r != CSR_RESULT_SUCCESS)\r\n{\r\nunifi_error(card->ospriv, "Can't read UniFi memory areas\n");\r\ngoto done;\r\n}\r\ndone:\r\nfunc_exit_r(r);\r\nreturn r;\r\n}\r\nstatic\r\ncoredump_buffer* new_coredump_node(void *ospriv, coredump_buffer *prevnode)\r\n{\r\ncoredump_buffer *newnode = NULL;\r\nu16 *newzone = NULL;\r\ns32 i;\r\nu32 zone_size;\r\nnewnode = kzalloc(sizeof(coredump_buffer), GFP_KERNEL);\r\nif (newnode == NULL)\r\n{\r\nreturn NULL;\r\n}\r\nfor (i = 0; i < HIP_CDUMP_NUM_ZONES; i++)\r\n{\r\nzone_size = sizeof(u16) * zonedef_table[i].length;\r\nnewzone = kzalloc(zone_size, GFP_KERNEL);\r\nnewnode->zone[i] = newzone;\r\nif (newzone == NULL)\r\n{\r\nunifi_error(ospriv, "Out of memory on coredump zone %d (%d words)\n",\r\ni, zonedef_table[i].length);\r\nbreak;\r\n}\r\n}\r\nif (newzone == NULL)\r\n{\r\nfor (i = 0; newnode->zone[i] != NULL; i++)\r\n{\r\nkfree(newnode->zone[i]);\r\nnewnode->zone[i] = NULL;\r\n}\r\n}\r\nnewnode->prev = prevnode;\r\nif (prevnode)\r\n{\r\nprevnode->next = newnode;\r\n}\r\nnewnode->next = NULL;\r\nreturn newnode;\r\n}\r\nCsrResult unifi_coredump_init(card_t *card, u16 num_dump_buffers)\r\n{\r\n#ifndef UNIFI_DISABLE_COREDUMP\r\nvoid *ospriv = card->ospriv;\r\ncoredump_buffer *prev = NULL;\r\ncoredump_buffer *newnode = NULL;\r\nu32 i = 0;\r\n#endif\r\nfunc_enter();\r\ncard->request_coredump_on_reset = 0;\r\ncard->dump_next_write = NULL;\r\ncard->dump_cur_read = NULL;\r\ncard->dump_buf = NULL;\r\n#ifndef UNIFI_DISABLE_COREDUMP\r\nunifi_trace(ospriv, UDBG1,\r\n"Allocate buffers for %d core dumps\n", num_dump_buffers);\r\nif (num_dump_buffers == 0)\r\n{\r\ngoto done;\r\n}\r\ncard->dump_buf = new_coredump_node(ospriv, NULL);\r\nif (card->dump_buf == NULL)\r\n{\r\ngoto fail;\r\n}\r\nprev = card->dump_buf;\r\nnewnode = card->dump_buf;\r\nfor (i = 1; i < num_dump_buffers; i++)\r\n{\r\nnewnode = new_coredump_node(ospriv, prev);\r\nif (newnode == NULL)\r\n{\r\ngoto fail;\r\n}\r\nprev = newnode;\r\n}\r\ncard->dump_buf->prev = newnode;\r\nnewnode->next = card->dump_buf;\r\ncard->dump_next_write = card->dump_buf;\r\ncard->dump_cur_read = NULL;\r\nunifi_trace(ospriv, UDBG2, "Core dump configured (%d dumps max)\n", i);\r\ndone:\r\n#endif\r\nfunc_exit();\r\nreturn CSR_RESULT_SUCCESS;\r\n#ifndef UNIFI_DISABLE_COREDUMP\r\nfail:\r\nunifi_error(ospriv, "Out of memory allocating core dump node %d\n", i);\r\nunifi_coredump_free(card);\r\nfunc_exit();\r\nreturn CSR_WIFI_HIP_RESULT_NO_MEMORY;\r\n#endif\r\n}\r\nvoid unifi_coredump_free(card_t *card)\r\n{\r\nvoid *ospriv = card->ospriv;\r\ncoredump_buffer *node, *del_node;\r\ns16 i = 0;\r\ns16 j;\r\nfunc_enter();\r\nunifi_trace(ospriv, UDBG2, "Core dump de-configured\n");\r\nif (card->dump_buf == NULL)\r\n{\r\nreturn;\r\n}\r\nnode = card->dump_buf;\r\ndo\r\n{\r\nfor (j = 0; j < HIP_CDUMP_NUM_ZONES; j++)\r\n{\r\nkfree(node->zone[j]);\r\nnode->zone[j] = NULL;\r\n}\r\ndel_node = node;\r\nnode = node->next;\r\nkfree(del_node);\r\ni++;\r\n} while ((node != NULL) && (node != card->dump_buf));\r\nunifi_trace(ospriv, UDBG3, "Freed %d coredump buffers\n", i);\r\ncard->dump_buf = NULL;\r\ncard->dump_next_write = NULL;\r\ncard->dump_cur_read = NULL;\r\nfunc_exit();\r\n}

void ov2640_init_settings(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->vcur.backlight = 32;\r\nsd->vcur.brightness = 0;\r\nsd->vcur.sharpness = 6;\r\nsd->vcur.contrast = 0;\r\nsd->vcur.gamma = 32;\r\nsd->vcur.hue = 0;\r\nsd->vcur.saturation = 128;\r\nsd->vcur.whitebal = 64;\r\nsd->vcur.mirror = 0;\r\nsd->vcur.flip = 0;\r\nsd->vmax.backlight = 64;\r\nsd->vmax.brightness = 255;\r\nsd->vmax.sharpness = 31;\r\nsd->vmax.contrast = 255;\r\nsd->vmax.gamma = 64;\r\nsd->vmax.hue = 254 + 2;\r\nsd->vmax.saturation = 255;\r\nsd->vmax.whitebal = 128;\r\nsd->vmax.mirror = 1;\r\nsd->vmax.flip = 1;\r\nsd->vmax.AC50Hz = 0;\r\nsd->dev_camera_settings = ov2640_camera_settings;\r\nsd->dev_init_at_startup = ov2640_init_at_startup;\r\nsd->dev_configure_alt = ov2640_configure_alt;\r\nsd->dev_init_pre_alt = ov2640_init_pre_alt;\r\nsd->dev_post_unset_alt = ov2640_post_unset_alt;\r\n}\r\nstatic void common(struct gspca_dev *gspca_dev)\r\n{\r\nfetch_validx(gspca_dev, tbl_common, ARRAY_SIZE(tbl_common));\r\n}\r\nstatic int ov2640_init_at_startup(struct gspca_dev *gspca_dev)\r\n{\r\nfetch_validx(gspca_dev, tbl_init_at_startup,\r\nARRAY_SIZE(tbl_init_at_startup));\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, dat_init1);\r\ncommon(gspca_dev);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x0000, 0x0006, 1, c61);\r\nctrl_out(gspca_dev, 0x40, 1, 0x00ef, 0x0006, 0, NULL);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x0000, 0x0000, 1, c51);\r\nctrl_out(gspca_dev, 0x40, 1, 0x0051, 0x0000, 0, NULL);\r\nreturn 0;\r\n}\r\nstatic int ov2640_init_pre_alt(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\nsd->mirrorMask = 0;\r\nsd->vold.backlight = -1;\r\nsd->vold.brightness = -1;\r\nsd->vold.sharpness = -1;\r\nsd->vold.contrast = -1;\r\nsd->vold.saturation = -1;\r\nsd->vold.gamma = -1;\r\nsd->vold.hue = -1;\r\nsd->vold.whitebal = -1;\r\nsd->vold.mirror = -1;\r\nsd->vold.flip = -1;\r\nov2640_init_post_alt(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int ov2640_init_post_alt(struct gspca_dev *gspca_dev)\r\n{\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\ns32 n;\r\nctrl_out(gspca_dev, 0x40, 5, 0x0001, 0x0000, 0, NULL);\r\nn = fetch_validx(gspca_dev, tbl_sensor_settings_common1,\r\nARRAY_SIZE(tbl_sensor_settings_common1));\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, dat_post);\r\ncommon(gspca_dev);\r\nkeep_on_fetching_validx(gspca_dev, tbl_sensor_settings_common1,\r\nARRAY_SIZE(tbl_sensor_settings_common1), n);\r\nswitch (reso) {\r\ncase IMAGE_640:\r\nn = fetch_validx(gspca_dev, tbl_640, ARRAY_SIZE(tbl_640));\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, dat_640);\r\nbreak;\r\ncase IMAGE_800:\r\nn = fetch_validx(gspca_dev, tbl_800, ARRAY_SIZE(tbl_800));\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200, 12, dat_800);\r\nbreak;\r\ncase IMAGE_1600:\r\ncase IMAGE_1280:\r\nn = fetch_validx(gspca_dev, tbl_big1, ARRAY_SIZE(tbl_big1));\r\nif (reso == IMAGE_1280) {\r\nn = fetch_validx(gspca_dev, tbl_big2,\r\nARRAY_SIZE(tbl_big2));\r\n} else {\r\nctrl_out(gspca_dev, 0x40, 1, 0x601d, 0x0086, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001, 0x00d7, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6082, 0x00d3, 0, NULL);\r\n}\r\nn = fetch_validx(gspca_dev, tbl_big3, ARRAY_SIZE(tbl_big3));\r\nif (reso == IMAGE_1280) {\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001, 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200,\r\n12, dat_1280);\r\n} else {\r\nctrl_out(gspca_dev, 0x40, 1, 0x6020, 0x008c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001, 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6076, 0x0018, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 3, 0x0000, 0x0200,\r\n12, dat_1600);\r\n}\r\nbreak;\r\n}\r\nn = fetch_validx(gspca_dev, tbl_sensor_settings_common2,\r\nARRAY_SIZE(tbl_sensor_settings_common2));\r\nov2640_camera_settings(gspca_dev);\r\nreturn 0;\r\n}\r\nstatic int ov2640_configure_alt(struct gspca_dev *gspca_dev)\r\n{\r\ns32 reso = gspca_dev->cam.cam_mode[(s32) gspca_dev->curr_mode].priv;\r\nswitch (reso) {\r\ncase IMAGE_640:\r\ngspca_dev->alt = 3 + 1;\r\nbreak;\r\ncase IMAGE_800:\r\ncase IMAGE_1280:\r\ncase IMAGE_1600:\r\ngspca_dev->alt = 1 + 1;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ov2640_camera_settings(struct gspca_dev *gspca_dev)\r\n{\r\nstruct sd *sd = (struct sd *) gspca_dev;\r\ns32 backlight = sd->vcur.backlight;\r\ns32 bright = sd->vcur.brightness;\r\ns32 sharp = sd->vcur.sharpness;\r\ns32 gam = sd->vcur.gamma;\r\ns32 cntr = sd->vcur.contrast;\r\ns32 sat = sd->vcur.saturation;\r\ns32 hue = sd->vcur.hue;\r\ns32 wbal = sd->vcur.whitebal;\r\ns32 mirror = (((sd->vcur.mirror > 0) ^ sd->mirrorMask) == 0);\r\ns32 flip = (((sd->vcur.flip > 0) ^ sd->mirrorMask) == 0);\r\nif (backlight != sd->vold.backlight) {\r\nif (backlight < 0 || backlight > sd->vmax.backlight)\r\nbacklight = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001 , 0x00ff,\r\n0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x601e + backlight , 0x0024,\r\n0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x601e + backlight - 10, 0x0025,\r\n0, NULL);\r\n}\r\nif (bright != sd->vold.brightness) {\r\nsd->vold.brightness = bright;\r\nif (bright < 0 || bright > sd->vmax.brightness)\r\nbright = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6009 , 0x007c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 + bright, 0x007d, 0, NULL);\r\n}\r\nif (wbal != sd->vold.whitebal) {\r\nsd->vold.whitebal = wbal;\r\nif (wbal < 0 || wbal > sd->vmax.whitebal)\r\nwbal = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6003 , 0x007c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 + wbal, 0x007d, 0, NULL);\r\n}\r\nif (cntr != sd->vold.contrast) {\r\nsd->vold.contrast = cntr;\r\nif (cntr < 0 || cntr > sd->vmax.contrast)\r\ncntr = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6007 , 0x007c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 + cntr, 0x007d, 0, NULL);\r\n}\r\nif (sat != sd->vold.saturation) {\r\nsd->vold.saturation = sat;\r\nif (sat < 0 || sat > sd->vmax.saturation)\r\nsat = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001 , 0x007c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 + sat, 0x007d, 0, NULL);\r\n}\r\nif (sharp != sd->vold.sharpness) {\r\nsd->vold.sharpness = sharp;\r\nif (sharp < 0 || sharp > sd->vmax.sharpness)\r\nsharp = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001 , 0x0092, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x60c0 + sharp, 0x0093, 0, NULL);\r\n}\r\nif (hue != sd->vold.hue) {\r\nsd->vold.hue = hue;\r\nif (hue < 0 || hue > sd->vmax.hue)\r\nhue = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6002 , 0x007c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 + hue * (hue < 255), 0x007d,\r\n0, NULL);\r\nif (hue >= 255)\r\nsd->swapRB = 1;\r\nelse\r\nsd->swapRB = 0;\r\n}\r\nif (gam != sd->vold.gamma) {\r\nsd->vold.gamma = gam;\r\nif (gam < 0 || gam > sd->vmax.gamma)\r\ngam = 0;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 , 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6008 , 0x007c, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000 + gam, 0x007d, 0, NULL);\r\n}\r\nif (mirror != sd->vold.mirror || flip != sd->vold.flip) {\r\nsd->vold.mirror = mirror;\r\nsd->vold.flip = flip;\r\nmirror = 0x80 * mirror;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001, 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000, 0x8004, 0, NULL);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x6000, 0x8004, 1, c28);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6028 + mirror, 0x0004, 0, NULL);\r\nflip = 0x50 * flip + mirror;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001, 0x00ff, 0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6000, 0x8004, 0, NULL);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x6000, 0x8004, 1, ca8);\r\nctrl_out(gspca_dev, 0x40, 1, 0x6028 + flip, 0x0004, 0, NULL);\r\nctrl_in(gspca_dev, 0xc0, 2, 0x0000, 0x0000, 1, c50);\r\n}\r\nif (backlight != sd->vold.backlight) {\r\nsd->vold.backlight = backlight;\r\nctrl_out(gspca_dev, 0x40, 1, 0x6001 , 0x00ff,\r\n0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x601e + backlight , 0x0024,\r\n0, NULL);\r\nctrl_out(gspca_dev, 0x40, 1, 0x601e + backlight - 10, 0x0025,\r\n0, NULL);\r\n}\r\nreturn 0;\r\n}\r\nstatic void ov2640_post_unset_alt(struct gspca_dev *gspca_dev)\r\n{\r\nctrl_out(gspca_dev, 0x40, 5, 0x0000, 0x0000, 0, NULL);\r\nmsleep(20);\r\nfetch_validx(gspca_dev, tbl_post_unset_alt,\r\nARRAY_SIZE(tbl_post_unset_alt));\r\n}

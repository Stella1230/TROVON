static unsigned char atohx(unsigned char *dst, char *src)\r\n{\r\nunsigned char value = 0;\r\nchar msb = tolower(*src) - '0';\r\nchar lsb = tolower(*(src + 1)) - '0';\r\nif (msb > 9)\r\nmsb -= 7;\r\nif (lsb > 9)\r\nlsb -= 7;\r\n*dst = value = ((msb & 0xF) << 4) | (lsb & 0xF);\r\nreturn value;\r\n}\r\nstatic int parse_hex_line(unsigned char *fw_data, unsigned char *addr,\r\nunsigned char *data, int *dataLength,\r\nunsigned char *addr_has_changed) {\r\nint count = 0;\r\nunsigned char *src, dst;\r\nif (*fw_data++ != ':') {\r\npr_err("invalid firmware file\n");\r\nreturn -EFAULT;\r\n}\r\nfor (src = fw_data; *src != '\n'; src += 2) {\r\natohx(&dst, src);\r\nswitch (count) {\r\ncase 0:\r\n*dataLength = dst;\r\nbreak;\r\ncase 1:\r\naddr[2] = dst;\r\nbreak;\r\ncase 2:\r\naddr[3] = dst;\r\nbreak;\r\ncase 3:\r\nif (dst == 0x04)\r\n*addr_has_changed = 1;\r\nelse\r\n*addr_has_changed = 0;\r\nbreak;\r\ncase 4:\r\ncase 5:\r\nif (*addr_has_changed)\r\naddr[(count - 4)] = dst;\r\nelse\r\ndata[(count - 4)] = dst;\r\nbreak;\r\ndefault:\r\ndata[(count - 4)] = dst;\r\nbreak;\r\n}\r\ncount++;\r\n}\r\nreturn (count * 2) + 2;\r\n}\r\nstatic int as102_firmware_upload(struct as10x_bus_adapter_t *bus_adap,\r\nunsigned char *cmd,\r\nconst struct firmware *firmware) {\r\nstruct as10x_fw_pkt_t fw_pkt;\r\nint total_read_bytes = 0, errno = 0;\r\nunsigned char addr_has_changed = 0;\r\nENTER();\r\nfor (total_read_bytes = 0; total_read_bytes < firmware->size; ) {\r\nint read_bytes = 0, data_len = 0;\r\nread_bytes = parse_hex_line(\r\n(u8 *) (firmware->data + total_read_bytes),\r\nfw_pkt.raw.address,\r\nfw_pkt.raw.data,\r\n&data_len,\r\n&addr_has_changed);\r\nif (read_bytes <= 0)\r\ngoto error;\r\ntotal_read_bytes += read_bytes;\r\nif (total_read_bytes == firmware->size) {\r\nfw_pkt.u.request[0] = 0x00;\r\nfw_pkt.u.request[1] = 0x03;\r\nerrno = bus_adap->ops->upload_fw_pkt(bus_adap,\r\n(uint8_t *)\r\n&fw_pkt, 2, 0);\r\nif (errno < 0)\r\ngoto error;\r\n} else {\r\nif (!addr_has_changed) {\r\nfw_pkt.u.request[0] = 0x00;\r\nfw_pkt.u.request[1] = 0x01;\r\ndata_len += sizeof(fw_pkt.u.request);\r\ndata_len += sizeof(fw_pkt.raw.address);\r\nerrno = bus_adap->ops->upload_fw_pkt(bus_adap,\r\n(uint8_t *)\r\n&fw_pkt,\r\ndata_len,\r\n0);\r\nif (errno < 0)\r\ngoto error;\r\n}\r\n}\r\n}\r\nerror:\r\nLEAVE();\r\nreturn (errno == 0) ? total_read_bytes : errno;\r\n}\r\nint as102_fw_upload(struct as10x_bus_adapter_t *bus_adap)\r\n{\r\nint errno = -EFAULT;\r\nconst struct firmware *firmware = NULL;\r\nunsigned char *cmd_buf = NULL;\r\nchar *fw1, *fw2;\r\nstruct usb_device *dev = bus_adap->usb_dev;\r\nENTER();\r\nif (dual_tuner) {\r\nfw1 = as102_dt_fw1;\r\nfw2 = as102_dt_fw2;\r\n} else {\r\nfw1 = as102_st_fw1;\r\nfw2 = as102_st_fw2;\r\n}\r\ncmd_buf = kzalloc(MAX_FW_PKT_SIZE, GFP_KERNEL);\r\nif (cmd_buf == NULL) {\r\nerrno = -ENOMEM;\r\ngoto error;\r\n}\r\nerrno = request_firmware(&firmware, fw1, &dev->dev);\r\nif (errno < 0) {\r\npr_err("%s: unable to locate firmware file: %s\n",\r\nDRIVER_NAME, fw1);\r\ngoto error;\r\n}\r\nerrno = as102_firmware_upload(bus_adap, cmd_buf, firmware);\r\nif (errno < 0) {\r\npr_err("%s: error during firmware upload part1\n",\r\nDRIVER_NAME);\r\ngoto error;\r\n}\r\npr_info("%s: firmware: %s loaded with success\n",\r\nDRIVER_NAME, fw1);\r\nrelease_firmware(firmware);\r\nmdelay(100);\r\nerrno = request_firmware(&firmware, fw2, &dev->dev);\r\nif (errno < 0) {\r\npr_err("%s: unable to locate firmware file: %s\n",\r\nDRIVER_NAME, fw2);\r\ngoto error;\r\n}\r\nerrno = as102_firmware_upload(bus_adap, cmd_buf, firmware);\r\nif (errno < 0) {\r\npr_err("%s: error during firmware upload part2\n",\r\nDRIVER_NAME);\r\ngoto error;\r\n}\r\npr_info("%s: firmware: %s loaded with success\n",\r\nDRIVER_NAME, fw2);\r\nerror:\r\nkfree(cmd_buf);\r\nrelease_firmware(firmware);\r\nLEAVE();\r\nreturn errno;\r\n}

static void solo_capture_config(struct solo_dev *solo_dev)\r\n{\r\nint i, j;\r\nunsigned long height;\r\nunsigned long width;\r\nunsigned char *buf;\r\nsolo_reg_write(solo_dev, SOLO_CAP_BASE,\r\nSOLO_CAP_MAX_PAGE(SOLO_CAP_EXT_MAX_PAGE *\r\nsolo_dev->nr_chans) |\r\nSOLO_CAP_BASE_ADDR(SOLO_CAP_EXT_ADDR(solo_dev) >> 16));\r\nsolo_reg_write(solo_dev, SOLO_CAP_BTW,\r\n(1 << 17) | SOLO_CAP_PROG_BANDWIDTH(2) |\r\nSOLO_CAP_MAX_BANDWIDTH(CAPTURE_MAX_BANDWIDTH));\r\nwidth = solo_dev->video_hsize;\r\nheight = solo_dev->video_vsize;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE1,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 2;\r\nheight = solo_dev->video_vsize;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE2,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 2;\r\nheight = solo_dev->video_vsize / 2;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE3,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 3;\r\nheight = solo_dev->video_vsize / 3;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE4,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = solo_dev->video_hsize / 4;\r\nheight = solo_dev->video_vsize / 2;\r\nsolo_reg_write(solo_dev, SOLO_DIM_SCALE5,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 8) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nwidth = VI_PROG_HSIZE;\r\nheight = VI_PROG_VSIZE;\r\nsolo_reg_write(solo_dev, SOLO_DIM_PROG,\r\nSOLO_DIM_H_MB_NUM(width / 16) |\r\nSOLO_DIM_V_MB_NUM_FRAME(height / 16) |\r\nSOLO_DIM_V_MB_NUM_FIELD(height / 16));\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CH, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_BASE, SOLO_EOSD_EXT_ADDR >> 16);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CLR,\r\n0xF0 << 16 | 0x80 << 8 | 0x80);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_OPT, 0);\r\nbuf = kzalloc(OSG_BUFFER_SIZE, GFP_KERNEL);\r\nif (!buf)\r\nreturn;\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nfor (j = 0; j < SOLO_EOSD_EXT_SIZE; j += OSG_BUFFER_SIZE) {\r\nsolo_p2m_dma(solo_dev, SOLO_P2M_DMA_ID_MP4E, 1, buf,\r\nSOLO_EOSD_EXT_ADDR +\r\n(i * SOLO_EOSD_EXT_SIZE) + j,\r\nOSG_BUFFER_SIZE);\r\n}\r\n}\r\nkfree(buf);\r\n}\r\nint solo_osd_print(struct solo_enc_dev *solo_enc)\r\n{\r\nstruct solo_dev *solo_dev = solo_enc->solo_dev;\r\nchar *str = solo_enc->osd_text;\r\nu8 *buf;\r\nu32 reg = solo_reg_read(solo_dev, SOLO_VE_OSD_CH);\r\nint len = strlen(str);\r\nint i, j;\r\nint x = 1, y = 1;\r\nif (len == 0) {\r\nreg &= ~(1 << solo_enc->ch);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CH, reg);\r\nreturn 0;\r\n}\r\nbuf = kzalloc(SOLO_EOSD_EXT_SIZE, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < len; i++) {\r\nfor (j = 0; j < 16; j++) {\r\nbuf[(j*2) + (i%2) + ((x + (i/2)) * 32) + (y * 2048)] =\r\n(solo_osd_font[(str[i] * 4) + (j / 4)]\r\n>> ((3 - (j % 4)) * 8)) & 0xff;\r\n}\r\n}\r\nsolo_p2m_dma(solo_dev, 0, 1, buf, SOLO_EOSD_EXT_ADDR +\r\n(solo_enc->ch * SOLO_EOSD_EXT_SIZE), SOLO_EOSD_EXT_SIZE);\r\nreg |= (1 << solo_enc->ch);\r\nsolo_reg_write(solo_dev, SOLO_VE_OSD_CH, reg);\r\nkfree(buf);\r\nreturn 0;\r\n}\r\nstatic void solo_jpeg_config(struct solo_dev *solo_dev)\r\n{\r\nu32 reg;\r\nif (solo_dev->flags & FLAGS_6110)\r\nreg = (4 << 24) | (3 << 16) | (2 << 8) | (1 << 0);\r\nelse\r\nreg = (2 << 24) | (2 << 16) | (2 << 8) | (2 << 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_TBL, reg);\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_CH_L, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_QP_CH_H, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_CFG,\r\n(SOLO_JPEG_EXT_SIZE(solo_dev) & 0xffff0000) |\r\n((SOLO_JPEG_EXT_ADDR(solo_dev) >> 16) & 0x0000ffff));\r\nsolo_reg_write(solo_dev, SOLO_VE_JPEG_CTRL, 0xffffffff);\r\nsolo_reg_write(solo_dev, 0x0688, (0 << 16) | (30 << 8) | 60);\r\n}\r\nstatic void solo_mp4e_config(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nu32 reg;\r\nsolo_reg_write(solo_dev, SOLO_VE_CFG0,\r\nSOLO_VE_INTR_CTRL(0) |\r\nSOLO_VE_BLOCK_SIZE(SOLO_MP4E_EXT_SIZE(solo_dev) >> 16) |\r\nSOLO_VE_BLOCK_BASE(SOLO_MP4E_EXT_ADDR(solo_dev) >> 16));\r\nsolo_reg_write(solo_dev, SOLO_VE_CFG1,\r\nSOLO_VE_INSERT_INDEX | SOLO_VE_MOTION_MODE(0));\r\nsolo_reg_write(solo_dev, SOLO_VE_WMRK_POLY, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_VMRK_INIT_KEY, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_WMRK_STRL, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_ENCRYP_POLY, 0);\r\nsolo_reg_write(solo_dev, SOLO_VE_ENCRYP_INIT, 0);\r\nreg = SOLO_VE_LITTLE_ENDIAN | SOLO_COMP_ATTR_FCODE(1) |\r\nSOLO_COMP_TIME_INC(0) | SOLO_COMP_TIME_WIDTH(15);\r\nif (solo_dev->flags & FLAGS_6110)\r\nreg |= SOLO_DCT_INTERVAL(10);\r\nelse\r\nreg |= SOLO_DCT_INTERVAL(36 / 4);\r\nsolo_reg_write(solo_dev, SOLO_VE_ATTR, reg);\r\nfor (i = 0; i < solo_dev->nr_chans; i++)\r\nsolo_reg_write(solo_dev, SOLO_VE_CH_REF_BASE(i),\r\n(SOLO_EREF_EXT_ADDR(solo_dev) +\r\n(i * SOLO_EREF_EXT_SIZE)) >> 16);\r\nif (solo_dev->flags & FLAGS_6110)\r\nsolo_reg_write(solo_dev, 0x0634, 0x00040008);\r\n}\r\nint solo_enc_init(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nsolo_capture_config(solo_dev);\r\nsolo_mp4e_config(solo_dev);\r\nsolo_jpeg_config(solo_dev);\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_SCALE(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_COMP_ENA_E(i), 0);\r\n}\r\nsolo_irq_on(solo_dev, SOLO_IRQ_ENCODER);\r\nreturn 0;\r\n}\r\nvoid solo_enc_exit(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nsolo_irq_off(solo_dev, SOLO_IRQ_ENCODER);\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_SCALE(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_CAP_CH_COMP_ENA_E(i), 0);\r\n}\r\n}

static void snd_ca0106_proc_dump_iec958( struct snd_info_buffer *buffer, u32 value)\r\n{\r\nint i;\r\nu32 status[4];\r\nstatus[0] = value & 0xff;\r\nstatus[1] = (value >> 8) & 0xff;\r\nstatus[2] = (value >> 16) & 0xff;\r\nstatus[3] = (value >> 24) & 0xff;\r\nif (! (status[0] & IEC958_AES0_PROFESSIONAL)) {\r\nsnd_iprintf(buffer, "Mode: consumer\n");\r\nsnd_iprintf(buffer, "Data: ");\r\nif (!(status[0] & IEC958_AES0_NONAUDIO)) {\r\nsnd_iprintf(buffer, "audio\n");\r\n} else {\r\nsnd_iprintf(buffer, "non-audio\n");\r\n}\r\nsnd_iprintf(buffer, "Rate: ");\r\nswitch (status[3] & IEC958_AES3_CON_FS) {\r\ncase IEC958_AES3_CON_FS_44100:\r\nsnd_iprintf(buffer, "44100 Hz\n");\r\nbreak;\r\ncase IEC958_AES3_CON_FS_48000:\r\nsnd_iprintf(buffer, "48000 Hz\n");\r\nbreak;\r\ncase IEC958_AES3_CON_FS_32000:\r\nsnd_iprintf(buffer, "32000 Hz\n");\r\nbreak;\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\nsnd_iprintf(buffer, "Copyright: ");\r\nif (status[0] & IEC958_AES0_CON_NOT_COPYRIGHT) {\r\nsnd_iprintf(buffer, "permitted\n");\r\n} else {\r\nsnd_iprintf(buffer, "protected\n");\r\n}\r\nsnd_iprintf(buffer, "Emphasis: ");\r\nif ((status[0] & IEC958_AES0_CON_EMPHASIS) != IEC958_AES0_CON_EMPHASIS_5015) {\r\nsnd_iprintf(buffer, "none\n");\r\n} else {\r\nsnd_iprintf(buffer, "50/15us\n");\r\n}\r\nsnd_iprintf(buffer, "Category: ");\r\nfor (i = 0; i < ARRAY_SIZE(snd_ca0106_con_category); i++) {\r\nif ((status[1] & IEC958_AES1_CON_CATEGORY) == snd_ca0106_con_category[i].val) {\r\nsnd_iprintf(buffer, "%s\n", snd_ca0106_con_category[i].name);\r\nbreak;\r\n}\r\n}\r\nif (i >= ARRAY_SIZE(snd_ca0106_con_category)) {\r\nsnd_iprintf(buffer, "unknown 0x%x\n", status[1] & IEC958_AES1_CON_CATEGORY);\r\n}\r\nsnd_iprintf(buffer, "Original: ");\r\nif (status[1] & IEC958_AES1_CON_ORIGINAL) {\r\nsnd_iprintf(buffer, "original\n");\r\n} else {\r\nsnd_iprintf(buffer, "1st generation\n");\r\n}\r\nsnd_iprintf(buffer, "Clock: ");\r\nswitch (status[3] & IEC958_AES3_CON_CLOCK) {\r\ncase IEC958_AES3_CON_CLOCK_1000PPM:\r\nsnd_iprintf(buffer, "1000 ppm\n");\r\nbreak;\r\ncase IEC958_AES3_CON_CLOCK_50PPM:\r\nsnd_iprintf(buffer, "50 ppm\n");\r\nbreak;\r\ncase IEC958_AES3_CON_CLOCK_VARIABLE:\r\nsnd_iprintf(buffer, "variable pitch\n");\r\nbreak;\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\n} else {\r\nsnd_iprintf(buffer, "Mode: professional\n");\r\nsnd_iprintf(buffer, "Data: ");\r\nif (!(status[0] & IEC958_AES0_NONAUDIO)) {\r\nsnd_iprintf(buffer, "audio\n");\r\n} else {\r\nsnd_iprintf(buffer, "non-audio\n");\r\n}\r\nsnd_iprintf(buffer, "Rate: ");\r\nswitch (status[0] & IEC958_AES0_PRO_FS) {\r\ncase IEC958_AES0_PRO_FS_44100:\r\nsnd_iprintf(buffer, "44100 Hz\n");\r\nbreak;\r\ncase IEC958_AES0_PRO_FS_48000:\r\nsnd_iprintf(buffer, "48000 Hz\n");\r\nbreak;\r\ncase IEC958_AES0_PRO_FS_32000:\r\nsnd_iprintf(buffer, "32000 Hz\n");\r\nbreak;\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\nsnd_iprintf(buffer, "Rate Locked: ");\r\nif (status[0] & IEC958_AES0_PRO_FREQ_UNLOCKED)\r\nsnd_iprintf(buffer, "no\n");\r\nelse\r\nsnd_iprintf(buffer, "yes\n");\r\nsnd_iprintf(buffer, "Emphasis: ");\r\nswitch (status[0] & IEC958_AES0_PRO_EMPHASIS) {\r\ncase IEC958_AES0_PRO_EMPHASIS_CCITT:\r\nsnd_iprintf(buffer, "CCITT J.17\n");\r\nbreak;\r\ncase IEC958_AES0_PRO_EMPHASIS_NONE:\r\nsnd_iprintf(buffer, "none\n");\r\nbreak;\r\ncase IEC958_AES0_PRO_EMPHASIS_5015:\r\nsnd_iprintf(buffer, "50/15us\n");\r\nbreak;\r\ncase IEC958_AES0_PRO_EMPHASIS_NOTID:\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\nsnd_iprintf(buffer, "Stereophonic: ");\r\nif ((status[1] & IEC958_AES1_PRO_MODE) == IEC958_AES1_PRO_MODE_STEREOPHONIC) {\r\nsnd_iprintf(buffer, "stereo\n");\r\n} else {\r\nsnd_iprintf(buffer, "not indicated\n");\r\n}\r\nsnd_iprintf(buffer, "Userbits: ");\r\nswitch (status[1] & IEC958_AES1_PRO_USERBITS) {\r\ncase IEC958_AES1_PRO_USERBITS_192:\r\nsnd_iprintf(buffer, "192bit\n");\r\nbreak;\r\ncase IEC958_AES1_PRO_USERBITS_UDEF:\r\nsnd_iprintf(buffer, "user-defined\n");\r\nbreak;\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\nsnd_iprintf(buffer, "Sample Bits: ");\r\nswitch (status[2] & IEC958_AES2_PRO_SBITS) {\r\ncase IEC958_AES2_PRO_SBITS_20:\r\nsnd_iprintf(buffer, "20 bit\n");\r\nbreak;\r\ncase IEC958_AES2_PRO_SBITS_24:\r\nsnd_iprintf(buffer, "24 bit\n");\r\nbreak;\r\ncase IEC958_AES2_PRO_SBITS_UDEF:\r\nsnd_iprintf(buffer, "user defined\n");\r\nbreak;\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\nsnd_iprintf(buffer, "Word Length: ");\r\nswitch (status[2] & IEC958_AES2_PRO_WORDLEN) {\r\ncase IEC958_AES2_PRO_WORDLEN_22_18:\r\nsnd_iprintf(buffer, "22 bit or 18 bit\n");\r\nbreak;\r\ncase IEC958_AES2_PRO_WORDLEN_23_19:\r\nsnd_iprintf(buffer, "23 bit or 19 bit\n");\r\nbreak;\r\ncase IEC958_AES2_PRO_WORDLEN_24_20:\r\nsnd_iprintf(buffer, "24 bit or 20 bit\n");\r\nbreak;\r\ncase IEC958_AES2_PRO_WORDLEN_20_16:\r\nsnd_iprintf(buffer, "20 bit or 16 bit\n");\r\nbreak;\r\ndefault:\r\nsnd_iprintf(buffer, "unknown\n");\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void snd_ca0106_proc_iec958(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nu32 value;\r\nvalue = snd_ca0106_ptr_read(emu, SAMPLE_RATE_TRACKER_STATUS, 0);\r\nsnd_iprintf(buffer, "Status: %s, %s, %s\n",\r\n(value & 0x100000) ? "Rate Locked" : "Not Rate Locked",\r\n(value & 0x200000) ? "SPDIF Locked" : "No SPDIF Lock",\r\n(value & 0x400000) ? "Audio Valid" : "No valid audio" );\r\nsnd_iprintf(buffer, "Estimated sample rate: %u\n",\r\n((value & 0xfffff) * 48000) / 0x8000 );\r\nif (value & 0x200000) {\r\nsnd_iprintf(buffer, "IEC958/SPDIF input status:\n");\r\nvalue = snd_ca0106_ptr_read(emu, SPDIF_INPUT_STATUS, 0);\r\nsnd_ca0106_proc_dump_iec958(buffer, value);\r\n}\r\nsnd_iprintf(buffer, "\n");\r\n}\r\nstatic void snd_ca0106_proc_reg_write32(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nunsigned long flags;\r\nchar line[64];\r\nu32 reg, val;\r\nwhile (!snd_info_get_line(buffer, line, sizeof(line))) {\r\nif (sscanf(line, "%x %x", &reg, &val) != 2)\r\ncontinue;\r\nif (reg < 0x40 && val <= 0xffffffff) {\r\nspin_lock_irqsave(&emu->emu_lock, flags);\r\noutl(val, emu->port + (reg & 0xfffffffc));\r\nspin_unlock_irqrestore(&emu->emu_lock, flags);\r\n}\r\n}\r\n}\r\nstatic void snd_ca0106_proc_reg_read32(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nunsigned long value;\r\nunsigned long flags;\r\nint i;\r\nsnd_iprintf(buffer, "Registers:\n\n");\r\nfor(i = 0; i < 0x20; i+=4) {\r\nspin_lock_irqsave(&emu->emu_lock, flags);\r\nvalue = inl(emu->port + i);\r\nspin_unlock_irqrestore(&emu->emu_lock, flags);\r\nsnd_iprintf(buffer, "Register %02X: %08lX\n", i, value);\r\n}\r\n}\r\nstatic void snd_ca0106_proc_reg_read16(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nunsigned int value;\r\nunsigned long flags;\r\nint i;\r\nsnd_iprintf(buffer, "Registers:\n\n");\r\nfor(i = 0; i < 0x20; i+=2) {\r\nspin_lock_irqsave(&emu->emu_lock, flags);\r\nvalue = inw(emu->port + i);\r\nspin_unlock_irqrestore(&emu->emu_lock, flags);\r\nsnd_iprintf(buffer, "Register %02X: %04X\n", i, value);\r\n}\r\n}\r\nstatic void snd_ca0106_proc_reg_read8(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nunsigned int value;\r\nunsigned long flags;\r\nint i;\r\nsnd_iprintf(buffer, "Registers:\n\n");\r\nfor(i = 0; i < 0x20; i+=1) {\r\nspin_lock_irqsave(&emu->emu_lock, flags);\r\nvalue = inb(emu->port + i);\r\nspin_unlock_irqrestore(&emu->emu_lock, flags);\r\nsnd_iprintf(buffer, "Register %02X: %02X\n", i, value);\r\n}\r\n}\r\nstatic void snd_ca0106_proc_reg_read1(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nunsigned long value;\r\nint i,j;\r\nsnd_iprintf(buffer, "Registers\n");\r\nfor(i = 0; i < 0x40; i++) {\r\nsnd_iprintf(buffer, "%02X: ",i);\r\nfor (j = 0; j < 4; j++) {\r\nvalue = snd_ca0106_ptr_read(emu, i, j);\r\nsnd_iprintf(buffer, "%08lX ", value);\r\n}\r\nsnd_iprintf(buffer, "\n");\r\n}\r\n}\r\nstatic void snd_ca0106_proc_reg_read2(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nunsigned long value;\r\nint i,j;\r\nsnd_iprintf(buffer, "Registers\n");\r\nfor(i = 0x40; i < 0x80; i++) {\r\nsnd_iprintf(buffer, "%02X: ",i);\r\nfor (j = 0; j < 4; j++) {\r\nvalue = snd_ca0106_ptr_read(emu, i, j);\r\nsnd_iprintf(buffer, "%08lX ", value);\r\n}\r\nsnd_iprintf(buffer, "\n");\r\n}\r\n}\r\nstatic void snd_ca0106_proc_reg_write(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nchar line[64];\r\nunsigned int reg, channel_id , val;\r\nwhile (!snd_info_get_line(buffer, line, sizeof(line))) {\r\nif (sscanf(line, "%x %x %x", &reg, &channel_id, &val) != 3)\r\ncontinue;\r\nif (reg < 0x80 && val <= 0xffffffff && channel_id <= 3)\r\nsnd_ca0106_ptr_write(emu, reg, channel_id, val);\r\n}\r\n}\r\nstatic void snd_ca0106_proc_i2c_write(struct snd_info_entry *entry,\r\nstruct snd_info_buffer *buffer)\r\n{\r\nstruct snd_ca0106 *emu = entry->private_data;\r\nchar line[64];\r\nunsigned int reg, val;\r\nwhile (!snd_info_get_line(buffer, line, sizeof(line))) {\r\nif (sscanf(line, "%x %x", &reg, &val) != 2)\r\ncontinue;\r\nif ((reg <= 0x7f) || (val <= 0x1ff)) {\r\nsnd_ca0106_i2c_write(emu, reg, val);\r\n}\r\n}\r\n}\r\nint __devinit snd_ca0106_proc_init(struct snd_ca0106 * emu)\r\n{\r\nstruct snd_info_entry *entry;\r\nif(! snd_card_proc_new(emu->card, "iec958", &entry))\r\nsnd_info_set_text_ops(entry, emu, snd_ca0106_proc_iec958);\r\nif(! snd_card_proc_new(emu->card, "ca0106_reg32", &entry)) {\r\nsnd_info_set_text_ops(entry, emu, snd_ca0106_proc_reg_read32);\r\nentry->c.text.write = snd_ca0106_proc_reg_write32;\r\nentry->mode |= S_IWUSR;\r\n}\r\nif(! snd_card_proc_new(emu->card, "ca0106_reg16", &entry))\r\nsnd_info_set_text_ops(entry, emu, snd_ca0106_proc_reg_read16);\r\nif(! snd_card_proc_new(emu->card, "ca0106_reg8", &entry))\r\nsnd_info_set_text_ops(entry, emu, snd_ca0106_proc_reg_read8);\r\nif(! snd_card_proc_new(emu->card, "ca0106_regs1", &entry)) {\r\nsnd_info_set_text_ops(entry, emu, snd_ca0106_proc_reg_read1);\r\nentry->c.text.write = snd_ca0106_proc_reg_write;\r\nentry->mode |= S_IWUSR;\r\n}\r\nif(! snd_card_proc_new(emu->card, "ca0106_i2c", &entry)) {\r\nentry->c.text.write = snd_ca0106_proc_i2c_write;\r\nentry->private_data = emu;\r\nentry->mode |= S_IWUSR;\r\n}\r\nif(! snd_card_proc_new(emu->card, "ca0106_regs2", &entry))\r\nsnd_info_set_text_ops(entry, emu, snd_ca0106_proc_reg_read2);\r\nreturn 0;\r\n}

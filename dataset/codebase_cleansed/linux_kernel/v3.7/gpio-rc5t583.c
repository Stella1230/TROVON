static inline struct rc5t583_gpio *to_rc5t583_gpio(struct gpio_chip *chip)\r\n{\r\nreturn container_of(chip, struct rc5t583_gpio, gpio_chip);\r\n}\r\nstatic int rc5t583_gpio_get(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = to_rc5t583_gpio(gc);\r\nstruct device *parent = rc5t583_gpio->rc5t583->dev;\r\nuint8_t val = 0;\r\nint ret;\r\nret = rc5t583_read(parent, RC5T583_GPIO_MON_IOIN, &val);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn !!(val & BIT(offset));\r\n}\r\nstatic void rc5t583_gpio_set(struct gpio_chip *gc, unsigned int offset, int val)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = to_rc5t583_gpio(gc);\r\nstruct device *parent = rc5t583_gpio->rc5t583->dev;\r\nif (val)\r\nrc5t583_set_bits(parent, RC5T583_GPIO_IOOUT, BIT(offset));\r\nelse\r\nrc5t583_clear_bits(parent, RC5T583_GPIO_IOOUT, BIT(offset));\r\n}\r\nstatic int rc5t583_gpio_dir_input(struct gpio_chip *gc, unsigned int offset)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = to_rc5t583_gpio(gc);\r\nstruct device *parent = rc5t583_gpio->rc5t583->dev;\r\nint ret;\r\nret = rc5t583_clear_bits(parent, RC5T583_GPIO_IOSEL, BIT(offset));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn rc5t583_clear_bits(parent, RC5T583_GPIO_PGSEL, BIT(offset));\r\n}\r\nstatic int rc5t583_gpio_dir_output(struct gpio_chip *gc, unsigned offset,\r\nint value)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = to_rc5t583_gpio(gc);\r\nstruct device *parent = rc5t583_gpio->rc5t583->dev;\r\nint ret;\r\nrc5t583_gpio_set(gc, offset, value);\r\nret = rc5t583_set_bits(parent, RC5T583_GPIO_IOSEL, BIT(offset));\r\nif (ret < 0)\r\nreturn ret;\r\nreturn rc5t583_clear_bits(parent, RC5T583_GPIO_PGSEL, BIT(offset));\r\n}\r\nstatic int rc5t583_gpio_to_irq(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = to_rc5t583_gpio(gc);\r\nif ((offset >= 0) && (offset < 8))\r\nreturn rc5t583_gpio->rc5t583->irq_base +\r\nRC5T583_IRQ_GPIO0 + offset;\r\nreturn -EINVAL;\r\n}\r\nstatic void rc5t583_gpio_free(struct gpio_chip *gc, unsigned offset)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = to_rc5t583_gpio(gc);\r\nstruct device *parent = rc5t583_gpio->rc5t583->dev;\r\nrc5t583_set_bits(parent, RC5T583_GPIO_PGSEL, BIT(offset));\r\n}\r\nstatic int __devinit rc5t583_gpio_probe(struct platform_device *pdev)\r\n{\r\nstruct rc5t583 *rc5t583 = dev_get_drvdata(pdev->dev.parent);\r\nstruct rc5t583_platform_data *pdata = dev_get_platdata(rc5t583->dev);\r\nstruct rc5t583_gpio *rc5t583_gpio;\r\nrc5t583_gpio = devm_kzalloc(&pdev->dev, sizeof(*rc5t583_gpio),\r\nGFP_KERNEL);\r\nif (!rc5t583_gpio) {\r\ndev_warn(&pdev->dev, "Mem allocation for rc5t583_gpio failed");\r\nreturn -ENOMEM;\r\n}\r\nrc5t583_gpio->gpio_chip.label = "gpio-rc5t583",\r\nrc5t583_gpio->gpio_chip.owner = THIS_MODULE,\r\nrc5t583_gpio->gpio_chip.free = rc5t583_gpio_free,\r\nrc5t583_gpio->gpio_chip.direction_input = rc5t583_gpio_dir_input,\r\nrc5t583_gpio->gpio_chip.direction_output = rc5t583_gpio_dir_output,\r\nrc5t583_gpio->gpio_chip.set = rc5t583_gpio_set,\r\nrc5t583_gpio->gpio_chip.get = rc5t583_gpio_get,\r\nrc5t583_gpio->gpio_chip.to_irq = rc5t583_gpio_to_irq,\r\nrc5t583_gpio->gpio_chip.ngpio = RC5T583_MAX_GPIO,\r\nrc5t583_gpio->gpio_chip.can_sleep = 1,\r\nrc5t583_gpio->gpio_chip.dev = &pdev->dev;\r\nrc5t583_gpio->gpio_chip.base = -1;\r\nrc5t583_gpio->rc5t583 = rc5t583;\r\nif (pdata && pdata->gpio_base)\r\nrc5t583_gpio->gpio_chip.base = pdata->gpio_base;\r\nplatform_set_drvdata(pdev, rc5t583_gpio);\r\nreturn gpiochip_add(&rc5t583_gpio->gpio_chip);\r\n}\r\nstatic int __devexit rc5t583_gpio_remove(struct platform_device *pdev)\r\n{\r\nstruct rc5t583_gpio *rc5t583_gpio = platform_get_drvdata(pdev);\r\nreturn gpiochip_remove(&rc5t583_gpio->gpio_chip);\r\n}\r\nstatic int __init rc5t583_gpio_init(void)\r\n{\r\nreturn platform_driver_register(&rc5t583_gpio_driver);\r\n}\r\nstatic void __exit rc5t583_gpio_exit(void)\r\n{\r\nplatform_driver_unregister(&rc5t583_gpio_driver);\r\n}

static ssize_t ad5380_read_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private, const struct iio_chan_spec *chan, char *buf)\r\n{\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nreturn sprintf(buf, "%d\n", st->pwr_down);\r\n}\r\nstatic ssize_t ad5380_write_dac_powerdown(struct iio_dev *indio_dev,\r\nuintptr_t private, const struct iio_chan_spec *chan, const char *buf,\r\nsize_t len)\r\n{\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nbool pwr_down;\r\nint ret;\r\nret = strtobool(buf, &pwr_down);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&indio_dev->mlock);\r\nif (pwr_down)\r\nret = regmap_write(st->regmap, AD5380_REG_SF_PWR_DOWN, 0);\r\nelse\r\nret = regmap_write(st->regmap, AD5380_REG_SF_PWR_UP, 0);\r\nst->pwr_down = pwr_down;\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ad5380_get_powerdown_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan)\r\n{\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nunsigned int mode;\r\nint ret;\r\nret = regmap_read(st->regmap, AD5380_REG_SF_CTRL, &mode);\r\nif (ret)\r\nreturn ret;\r\nmode = (mode >> AD5380_CTRL_PWR_DOWN_MODE_OFFSET) & 1;\r\nreturn mode;\r\n}\r\nstatic int ad5380_set_powerdown_mode(struct iio_dev *indio_dev,\r\nconst struct iio_chan_spec *chan, unsigned int mode)\r\n{\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nint ret;\r\nret = regmap_update_bits(st->regmap, AD5380_REG_SF_CTRL,\r\n1 << AD5380_CTRL_PWR_DOWN_MODE_OFFSET,\r\nmode << AD5380_CTRL_PWR_DOWN_MODE_OFFSET);\r\nreturn ret;\r\n}\r\nstatic unsigned int ad5380_info_to_reg(struct iio_chan_spec const *chan,\r\nlong info)\r\n{\r\nswitch (info) {\r\ncase 0:\r\nreturn AD5380_REG_DATA(chan->address);\r\ncase IIO_CHAN_INFO_CALIBBIAS:\r\nreturn AD5380_REG_OFFSET(chan->address);\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\nreturn AD5380_REG_GAIN(chan->address);\r\ndefault:\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ad5380_write_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int val, int val2, long info)\r\n{\r\nconst unsigned int max_val = (1 << chan->scan_type.realbits);\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nswitch (info) {\r\ncase IIO_CHAN_INFO_RAW:\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\nif (val >= max_val || val < 0)\r\nreturn -EINVAL;\r\nreturn regmap_write(st->regmap,\r\nad5380_info_to_reg(chan, info),\r\nval << chan->scan_type.shift);\r\ncase IIO_CHAN_INFO_CALIBBIAS:\r\nval += (1 << chan->scan_type.realbits) / 2;\r\nif (val >= max_val || val < 0)\r\nreturn -EINVAL;\r\nreturn regmap_write(st->regmap,\r\nAD5380_REG_OFFSET(chan->address),\r\nval << chan->scan_type.shift);\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int ad5380_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan, int *val, int *val2, long info)\r\n{\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nunsigned long scale_uv;\r\nint ret;\r\nswitch (info) {\r\ncase IIO_CHAN_INFO_RAW:\r\ncase IIO_CHAN_INFO_CALIBSCALE:\r\nret = regmap_read(st->regmap, ad5380_info_to_reg(chan, info),\r\nval);\r\nif (ret)\r\nreturn ret;\r\n*val >>= chan->scan_type.shift;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_CALIBBIAS:\r\nret = regmap_read(st->regmap, AD5380_REG_OFFSET(chan->address),\r\nval);\r\nif (ret)\r\nreturn ret;\r\n*val >>= chan->scan_type.shift;\r\nval -= (1 << chan->scan_type.realbits) / 2;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\nscale_uv = ((2 * st->vref) >> chan->scan_type.realbits) * 100;\r\n*val = scale_uv / 100000;\r\n*val2 = (scale_uv % 100000) * 10;\r\nreturn IIO_VAL_INT_PLUS_MICRO;\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int __devinit ad5380_alloc_channels(struct iio_dev *indio_dev)\r\n{\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\nstruct iio_chan_spec *channels;\r\nunsigned int i;\r\nchannels = kcalloc(st->chip_info->num_channels,\r\nsizeof(struct iio_chan_spec), GFP_KERNEL);\r\nif (!channels)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < st->chip_info->num_channels; ++i) {\r\nchannels[i] = st->chip_info->channel_template;\r\nchannels[i].channel = i;\r\nchannels[i].address = i;\r\n}\r\nindio_dev->channels = channels;\r\nreturn 0;\r\n}\r\nstatic int __devinit ad5380_probe(struct device *dev, struct regmap *regmap,\r\nenum ad5380_type type, const char *name)\r\n{\r\nstruct iio_dev *indio_dev;\r\nstruct ad5380_state *st;\r\nunsigned int ctrl = 0;\r\nint ret;\r\nindio_dev = iio_device_alloc(sizeof(*st));\r\nif (indio_dev == NULL) {\r\ndev_err(dev, "Failed to allocate iio device\n");\r\nret = -ENOMEM;\r\ngoto error_out;\r\n}\r\nst = iio_priv(indio_dev);\r\ndev_set_drvdata(dev, indio_dev);\r\nst->chip_info = &ad5380_chip_info_tbl[type];\r\nst->regmap = regmap;\r\nindio_dev->dev.parent = dev;\r\nindio_dev->name = name;\r\nindio_dev->info = &ad5380_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->num_channels = st->chip_info->num_channels;\r\nret = ad5380_alloc_channels(indio_dev);\r\nif (ret) {\r\ndev_err(dev, "Failed to allocate channel spec: %d\n", ret);\r\ngoto error_free;\r\n}\r\nif (st->chip_info->int_vref == 2500000)\r\nctrl |= AD5380_CTRL_INT_VREF_2V5;\r\nst->vref_reg = regulator_get(dev, "vref");\r\nif (!IS_ERR(st->vref_reg)) {\r\nret = regulator_enable(st->vref_reg);\r\nif (ret) {\r\ndev_err(dev, "Failed to enable vref regulators: %d\n",\r\nret);\r\ngoto error_free_reg;\r\n}\r\nst->vref = regulator_get_voltage(st->vref_reg);\r\n} else {\r\nst->vref = st->chip_info->int_vref;\r\nctrl |= AD5380_CTRL_INT_VREF_EN;\r\n}\r\nret = regmap_write(st->regmap, AD5380_REG_SF_CTRL, ctrl);\r\nif (ret) {\r\ndev_err(dev, "Failed to write to device: %d\n", ret);\r\ngoto error_disable_reg;\r\n}\r\nret = iio_device_register(indio_dev);\r\nif (ret) {\r\ndev_err(dev, "Failed to register iio device: %d\n", ret);\r\ngoto error_disable_reg;\r\n}\r\nreturn 0;\r\nerror_disable_reg:\r\nif (!IS_ERR(st->vref_reg))\r\nregulator_disable(st->vref_reg);\r\nerror_free_reg:\r\nif (!IS_ERR(st->vref_reg))\r\nregulator_put(st->vref_reg);\r\nkfree(indio_dev->channels);\r\nerror_free:\r\niio_device_free(indio_dev);\r\nerror_out:\r\nreturn ret;\r\n}\r\nstatic int __devexit ad5380_remove(struct device *dev)\r\n{\r\nstruct iio_dev *indio_dev = dev_get_drvdata(dev);\r\nstruct ad5380_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nkfree(indio_dev->channels);\r\nif (!IS_ERR(st->vref_reg)) {\r\nregulator_disable(st->vref_reg);\r\nregulator_put(st->vref_reg);\r\n}\r\niio_device_free(indio_dev);\r\nreturn 0;\r\n}\r\nstatic bool ad5380_reg_false(struct device *dev, unsigned int reg)\r\n{\r\nreturn false;\r\n}\r\nstatic int __devinit ad5380_spi_probe(struct spi_device *spi)\r\n{\r\nconst struct spi_device_id *id = spi_get_device_id(spi);\r\nstruct regmap *regmap;\r\nregmap = devm_regmap_init_spi(spi, &ad5380_regmap_config);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nreturn ad5380_probe(&spi->dev, regmap, id->driver_data, id->name);\r\n}\r\nstatic int __devexit ad5380_spi_remove(struct spi_device *spi)\r\n{\r\nreturn ad5380_remove(&spi->dev);\r\n}\r\nstatic inline int ad5380_spi_register_driver(void)\r\n{\r\nreturn spi_register_driver(&ad5380_spi_driver);\r\n}\r\nstatic inline void ad5380_spi_unregister_driver(void)\r\n{\r\nspi_unregister_driver(&ad5380_spi_driver);\r\n}\r\nstatic inline int ad5380_spi_register_driver(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void ad5380_spi_unregister_driver(void)\r\n{\r\n}\r\nstatic int __devinit ad5380_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct regmap *regmap;\r\nregmap = devm_regmap_init_i2c(i2c, &ad5380_regmap_config);\r\nif (IS_ERR(regmap))\r\nreturn PTR_ERR(regmap);\r\nreturn ad5380_probe(&i2c->dev, regmap, id->driver_data, id->name);\r\n}\r\nstatic int __devexit ad5380_i2c_remove(struct i2c_client *i2c)\r\n{\r\nreturn ad5380_remove(&i2c->dev);\r\n}\r\nstatic inline int ad5380_i2c_register_driver(void)\r\n{\r\nreturn i2c_add_driver(&ad5380_i2c_driver);\r\n}\r\nstatic inline void ad5380_i2c_unregister_driver(void)\r\n{\r\ni2c_del_driver(&ad5380_i2c_driver);\r\n}\r\nstatic inline int ad5380_i2c_register_driver(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline void ad5380_i2c_unregister_driver(void)\r\n{\r\n}\r\nstatic int __init ad5380_spi_init(void)\r\n{\r\nint ret;\r\nret = ad5380_spi_register_driver();\r\nif (ret)\r\nreturn ret;\r\nret = ad5380_i2c_register_driver();\r\nif (ret) {\r\nad5380_spi_unregister_driver();\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit ad5380_spi_exit(void)\r\n{\r\nad5380_i2c_unregister_driver();\r\nad5380_spi_unregister_driver();\r\n}

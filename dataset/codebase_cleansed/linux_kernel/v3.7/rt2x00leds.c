void rt2x00leds_led_quality(struct rt2x00_dev *rt2x00dev, int rssi)\r\n{\r\nstruct rt2x00_led *led = &rt2x00dev->led_qual;\r\nunsigned int brightness;\r\nif ((led->type != LED_TYPE_QUALITY) || !(led->flags & LED_REGISTERED))\r\nreturn;\r\nrssi += rt2x00dev->rssi_offset;\r\nif (rssi <= 30)\r\nrssi = 0;\r\nelse if (rssi <= 39)\r\nrssi = 1;\r\nelse if (rssi <= 49)\r\nrssi = 2;\r\nelse if (rssi <= 53)\r\nrssi = 3;\r\nelse if (rssi <= 63)\r\nrssi = 4;\r\nelse\r\nrssi = 5;\r\nbrightness = ((LED_FULL / 6) * rssi) + 1;\r\nif (brightness != led->led_dev.brightness) {\r\nled->led_dev.brightness_set(&led->led_dev, brightness);\r\nled->led_dev.brightness = brightness;\r\n}\r\n}\r\nstatic void rt2x00led_led_simple(struct rt2x00_led *led, bool enabled)\r\n{\r\nunsigned int brightness = enabled ? LED_FULL : LED_OFF;\r\nif (!(led->flags & LED_REGISTERED))\r\nreturn;\r\nled->led_dev.brightness_set(&led->led_dev, brightness);\r\nled->led_dev.brightness = brightness;\r\n}\r\nvoid rt2x00led_led_activity(struct rt2x00_dev *rt2x00dev, bool enabled)\r\n{\r\nif (rt2x00dev->led_qual.type == LED_TYPE_ACTIVITY)\r\nrt2x00led_led_simple(&rt2x00dev->led_qual, enabled);\r\n}\r\nvoid rt2x00leds_led_assoc(struct rt2x00_dev *rt2x00dev, bool enabled)\r\n{\r\nif (rt2x00dev->led_assoc.type == LED_TYPE_ASSOC)\r\nrt2x00led_led_simple(&rt2x00dev->led_assoc, enabled);\r\n}\r\nvoid rt2x00leds_led_radio(struct rt2x00_dev *rt2x00dev, bool enabled)\r\n{\r\nif (rt2x00dev->led_radio.type == LED_TYPE_RADIO)\r\nrt2x00led_led_simple(&rt2x00dev->led_radio, enabled);\r\n}\r\nstatic int rt2x00leds_register_led(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00_led *led,\r\nconst char *name)\r\n{\r\nstruct device *device = wiphy_dev(rt2x00dev->hw->wiphy);\r\nint retval;\r\nled->led_dev.name = name;\r\nled->led_dev.brightness = LED_OFF;\r\nretval = led_classdev_register(device, &led->led_dev);\r\nif (retval) {\r\nERROR(rt2x00dev, "Failed to register led handler.\n");\r\nreturn retval;\r\n}\r\nled->flags |= LED_REGISTERED;\r\nreturn 0;\r\n}\r\nvoid rt2x00leds_register(struct rt2x00_dev *rt2x00dev)\r\n{\r\nchar name[36];\r\nint retval;\r\nunsigned long on_period;\r\nunsigned long off_period;\r\nconst char *phy_name = wiphy_name(rt2x00dev->hw->wiphy);\r\nif (rt2x00dev->led_radio.flags & LED_INITIALIZED) {\r\nsnprintf(name, sizeof(name), "%s-%s::radio",\r\nrt2x00dev->ops->name, phy_name);\r\nretval = rt2x00leds_register_led(rt2x00dev,\r\n&rt2x00dev->led_radio,\r\nname);\r\nif (retval)\r\ngoto exit_fail;\r\n}\r\nif (rt2x00dev->led_assoc.flags & LED_INITIALIZED) {\r\nsnprintf(name, sizeof(name), "%s-%s::assoc",\r\nrt2x00dev->ops->name, phy_name);\r\nretval = rt2x00leds_register_led(rt2x00dev,\r\n&rt2x00dev->led_assoc,\r\nname);\r\nif (retval)\r\ngoto exit_fail;\r\n}\r\nif (rt2x00dev->led_qual.flags & LED_INITIALIZED) {\r\nsnprintf(name, sizeof(name), "%s-%s::quality",\r\nrt2x00dev->ops->name, phy_name);\r\nretval = rt2x00leds_register_led(rt2x00dev,\r\n&rt2x00dev->led_qual,\r\nname);\r\nif (retval)\r\ngoto exit_fail;\r\n}\r\nif (rt2x00dev->led_radio.led_dev.blink_set) {\r\non_period = 70;\r\noff_period = 30;\r\nrt2x00dev->led_radio.led_dev.blink_set(\r\n&rt2x00dev->led_radio.led_dev, &on_period, &off_period);\r\n}\r\nreturn;\r\nexit_fail:\r\nrt2x00leds_unregister(rt2x00dev);\r\n}\r\nstatic void rt2x00leds_unregister_led(struct rt2x00_led *led)\r\n{\r\nled_classdev_unregister(&led->led_dev);\r\nif (!(led->led_dev.flags & LED_SUSPENDED))\r\nled->led_dev.brightness_set(&led->led_dev, LED_OFF);\r\nled->flags &= ~LED_REGISTERED;\r\n}\r\nvoid rt2x00leds_unregister(struct rt2x00_dev *rt2x00dev)\r\n{\r\nif (rt2x00dev->led_qual.flags & LED_REGISTERED)\r\nrt2x00leds_unregister_led(&rt2x00dev->led_qual);\r\nif (rt2x00dev->led_assoc.flags & LED_REGISTERED)\r\nrt2x00leds_unregister_led(&rt2x00dev->led_assoc);\r\nif (rt2x00dev->led_radio.flags & LED_REGISTERED)\r\nrt2x00leds_unregister_led(&rt2x00dev->led_radio);\r\n}\r\nstatic inline void rt2x00leds_suspend_led(struct rt2x00_led *led)\r\n{\r\nled_classdev_suspend(&led->led_dev);\r\nled->led_dev.brightness_set(&led->led_dev, LED_OFF);\r\nled->led_dev.brightness = LED_OFF;\r\n}\r\nvoid rt2x00leds_suspend(struct rt2x00_dev *rt2x00dev)\r\n{\r\nif (rt2x00dev->led_qual.flags & LED_REGISTERED)\r\nrt2x00leds_suspend_led(&rt2x00dev->led_qual);\r\nif (rt2x00dev->led_assoc.flags & LED_REGISTERED)\r\nrt2x00leds_suspend_led(&rt2x00dev->led_assoc);\r\nif (rt2x00dev->led_radio.flags & LED_REGISTERED)\r\nrt2x00leds_suspend_led(&rt2x00dev->led_radio);\r\n}\r\nstatic inline void rt2x00leds_resume_led(struct rt2x00_led *led)\r\n{\r\nled_classdev_resume(&led->led_dev);\r\nled->led_dev.brightness_set(&led->led_dev, LED_OFF);\r\nled->led_dev.brightness = LED_OFF;\r\n}\r\nvoid rt2x00leds_resume(struct rt2x00_dev *rt2x00dev)\r\n{\r\nif (rt2x00dev->led_radio.flags & LED_REGISTERED)\r\nrt2x00leds_resume_led(&rt2x00dev->led_radio);\r\nif (rt2x00dev->led_assoc.flags & LED_REGISTERED)\r\nrt2x00leds_resume_led(&rt2x00dev->led_assoc);\r\nif (rt2x00dev->led_qual.flags & LED_REGISTERED)\r\nrt2x00leds_resume_led(&rt2x00dev->led_qual);\r\n}

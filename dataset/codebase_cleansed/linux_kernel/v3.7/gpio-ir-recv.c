static irqreturn_t gpio_ir_recv_irq(int irq, void *dev_id)\r\n{\r\nstruct gpio_rc_dev *gpio_dev = dev_id;\r\nint gval;\r\nint rc = 0;\r\nenum raw_event_type type = IR_SPACE;\r\ngval = gpio_get_value_cansleep(gpio_dev->gpio_nr);\r\nif (gval < 0)\r\ngoto err_get_value;\r\nif (gpio_dev->active_low)\r\ngval = !gval;\r\nif (gval == 1)\r\ntype = IR_PULSE;\r\nrc = ir_raw_event_store_edge(gpio_dev->rcdev, type);\r\nif (rc < 0)\r\ngoto err_get_value;\r\nir_raw_event_handle(gpio_dev->rcdev);\r\nerr_get_value:\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __devinit gpio_ir_recv_probe(struct platform_device *pdev)\r\n{\r\nstruct gpio_rc_dev *gpio_dev;\r\nstruct rc_dev *rcdev;\r\nconst struct gpio_ir_recv_platform_data *pdata =\r\npdev->dev.platform_data;\r\nint rc;\r\nif (!pdata)\r\nreturn -EINVAL;\r\nif (pdata->gpio_nr < 0)\r\nreturn -EINVAL;\r\ngpio_dev = kzalloc(sizeof(struct gpio_rc_dev), GFP_KERNEL);\r\nif (!gpio_dev)\r\nreturn -ENOMEM;\r\nrcdev = rc_allocate_device();\r\nif (!rcdev) {\r\nrc = -ENOMEM;\r\ngoto err_allocate_device;\r\n}\r\nrcdev->priv = gpio_dev;\r\nrcdev->driver_type = RC_DRIVER_IR_RAW;\r\nrcdev->input_name = GPIO_IR_DEVICE_NAME;\r\nrcdev->input_phys = GPIO_IR_DEVICE_NAME "/input0";\r\nrcdev->input_id.bustype = BUS_HOST;\r\nrcdev->input_id.vendor = 0x0001;\r\nrcdev->input_id.product = 0x0001;\r\nrcdev->input_id.version = 0x0100;\r\nrcdev->dev.parent = &pdev->dev;\r\nrcdev->driver_name = GPIO_IR_DRIVER_NAME;\r\nif (pdata->allowed_protos)\r\nrcdev->allowed_protos = pdata->allowed_protos;\r\nelse\r\nrcdev->allowed_protos = RC_TYPE_ALL;\r\nrcdev->map_name = pdata->map_name ?: RC_MAP_EMPTY;\r\ngpio_dev->rcdev = rcdev;\r\ngpio_dev->gpio_nr = pdata->gpio_nr;\r\ngpio_dev->active_low = pdata->active_low;\r\nrc = gpio_request(pdata->gpio_nr, "gpio-ir-recv");\r\nif (rc < 0)\r\ngoto err_gpio_request;\r\nrc = gpio_direction_input(pdata->gpio_nr);\r\nif (rc < 0)\r\ngoto err_gpio_direction_input;\r\nrc = rc_register_device(rcdev);\r\nif (rc < 0) {\r\ndev_err(&pdev->dev, "failed to register rc device\n");\r\ngoto err_register_rc_device;\r\n}\r\nplatform_set_drvdata(pdev, gpio_dev);\r\nrc = request_any_context_irq(gpio_to_irq(pdata->gpio_nr),\r\ngpio_ir_recv_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING,\r\n"gpio-ir-recv-irq", gpio_dev);\r\nif (rc < 0)\r\ngoto err_request_irq;\r\nreturn 0;\r\nerr_request_irq:\r\nplatform_set_drvdata(pdev, NULL);\r\nrc_unregister_device(rcdev);\r\nerr_register_rc_device:\r\nerr_gpio_direction_input:\r\ngpio_free(pdata->gpio_nr);\r\nerr_gpio_request:\r\nrc_free_device(rcdev);\r\nrcdev = NULL;\r\nerr_allocate_device:\r\nkfree(gpio_dev);\r\nreturn rc;\r\n}\r\nstatic int __devexit gpio_ir_recv_remove(struct platform_device *pdev)\r\n{\r\nstruct gpio_rc_dev *gpio_dev = platform_get_drvdata(pdev);\r\nfree_irq(gpio_to_irq(gpio_dev->gpio_nr), gpio_dev);\r\nplatform_set_drvdata(pdev, NULL);\r\nrc_unregister_device(gpio_dev->rcdev);\r\ngpio_free(gpio_dev->gpio_nr);\r\nrc_free_device(gpio_dev->rcdev);\r\nkfree(gpio_dev);\r\nreturn 0;\r\n}\r\nstatic int gpio_ir_recv_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct gpio_rc_dev *gpio_dev = platform_get_drvdata(pdev);\r\nif (device_may_wakeup(dev))\r\nenable_irq_wake(gpio_to_irq(gpio_dev->gpio_nr));\r\nelse\r\ndisable_irq(gpio_to_irq(gpio_dev->gpio_nr));\r\nreturn 0;\r\n}\r\nstatic int gpio_ir_recv_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct gpio_rc_dev *gpio_dev = platform_get_drvdata(pdev);\r\nif (device_may_wakeup(dev))\r\ndisable_irq_wake(gpio_to_irq(gpio_dev->gpio_nr));\r\nelse\r\nenable_irq(gpio_to_irq(gpio_dev->gpio_nr));\r\nreturn 0;\r\n}

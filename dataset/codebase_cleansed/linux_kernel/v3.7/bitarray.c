static void batadv_bitmap_shift_left(unsigned long *seq_bits, int32_t n)\r\n{\r\nif (n <= 0 || n >= BATADV_TQ_LOCAL_WINDOW_SIZE)\r\nreturn;\r\nbitmap_shift_left(seq_bits, seq_bits, n, BATADV_TQ_LOCAL_WINDOW_SIZE);\r\n}\r\nint batadv_bit_get_packet(void *priv, unsigned long *seq_bits,\r\nint32_t seq_num_diff, int set_mark)\r\n{\r\nstruct batadv_priv *bat_priv = priv;\r\nif (seq_num_diff <= 0 && seq_num_diff > -BATADV_TQ_LOCAL_WINDOW_SIZE) {\r\nif (set_mark)\r\nbatadv_set_bit(seq_bits, -seq_num_diff);\r\nreturn 0;\r\n}\r\nif (seq_num_diff > 0 && seq_num_diff < BATADV_TQ_LOCAL_WINDOW_SIZE) {\r\nbatadv_bitmap_shift_left(seq_bits, seq_num_diff);\r\nif (set_mark)\r\nbatadv_set_bit(seq_bits, 0);\r\nreturn 1;\r\n}\r\nif (seq_num_diff >= BATADV_TQ_LOCAL_WINDOW_SIZE &&\r\nseq_num_diff < BATADV_EXPECTED_SEQNO_RANGE) {\r\nbatadv_dbg(BATADV_DBG_BATMAN, bat_priv,\r\n"We missed a lot of packets (%i) !\n",\r\nseq_num_diff - 1);\r\nbitmap_zero(seq_bits, BATADV_TQ_LOCAL_WINDOW_SIZE);\r\nif (set_mark)\r\nbatadv_set_bit(seq_bits, 0);\r\nreturn 1;\r\n}\r\nif (seq_num_diff <= -BATADV_TQ_LOCAL_WINDOW_SIZE ||\r\nseq_num_diff >= BATADV_EXPECTED_SEQNO_RANGE) {\r\nbatadv_dbg(BATADV_DBG_BATMAN, bat_priv,\r\n"Other host probably restarted!\n");\r\nbitmap_zero(seq_bits, BATADV_TQ_LOCAL_WINDOW_SIZE);\r\nif (set_mark)\r\nbatadv_set_bit(seq_bits, 0);\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}

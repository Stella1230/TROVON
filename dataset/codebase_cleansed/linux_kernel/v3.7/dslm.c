static int check_powermode(int fd)\r\n{\r\nunsigned char args[4] = {WIN_CHECKPOWERMODE1,0,0,0};\r\nint state;\r\nif (ioctl(fd, HDIO_DRIVE_CMD, &args)\r\n&& (args[0] = WIN_CHECKPOWERMODE2)\r\n&& ioctl(fd, HDIO_DRIVE_CMD, &args)) {\r\nif (errno != EIO || args[0] != 0 || args[1] != 0) {\r\nstate = -1;\r\n} else\r\nstate = 0;\r\n} else {\r\nstate = (args[2] == 255) ? 1 : 0;\r\n}\r\nD(printf(" drive state is: %d\n", state));\r\nreturn state;\r\n}\r\nstatic char *state_name(int i)\r\n{\r\nif (i == -1) return "unknown";\r\nif (i == 0) return "sleeping";\r\nif (i == 1) return "active";\r\nreturn "internal error";\r\n}\r\nstatic char *myctime(time_t time)\r\n{\r\nchar *ts = ctime(&time);\r\nts[strlen(ts) - 1] = 0;\r\nreturn ts;\r\n}\r\nstatic void measure(int fd)\r\n{\r\ntime_t start_time;\r\nint last_state;\r\ntime_t last_time;\r\nint curr_state;\r\ntime_t curr_time = 0;\r\ntime_t time_diff;\r\ntime_t active_time = 0;\r\ntime_t sleep_time = 0;\r\ntime_t unknown_time = 0;\r\ntime_t total_time = 0;\r\nint changes = 0;\r\nfloat tmp;\r\nprintf("Starting measurements\n");\r\nlast_state = check_powermode(fd);\r\nstart_time = last_time = time(0);\r\nprintf(" System is in state %s\n\n", state_name(last_state));\r\nwhile(!endit) {\r\nsleep(1);\r\ncurr_state = check_powermode(fd);\r\nif (curr_state != last_state || endit) {\r\nchanges++;\r\ncurr_time = time(0);\r\ntime_diff = curr_time - last_time;\r\nif (last_state == 1) active_time += time_diff;\r\nelse if (last_state == 0) sleep_time += time_diff;\r\nelse unknown_time += time_diff;\r\nlast_state = curr_state;\r\nlast_time = curr_time;\r\nprintf("%s: State-change to %s\n", myctime(curr_time),\r\nstate_name(curr_state));\r\n}\r\n}\r\nchanges--;\r\ntotal_time = time(0) - start_time;\r\nprintf("\nTotal running time: %lus\n", curr_time - start_time);\r\nprintf(" State changed %d times\n", changes);\r\ntmp = (float)sleep_time / (float)total_time * 100;\r\nprintf(" Time in sleep state: %lus (%.2f%%)\n", sleep_time, tmp);\r\ntmp = (float)active_time / (float)total_time * 100;\r\nprintf(" Time in active state: %lus (%.2f%%)\n", active_time, tmp);\r\ntmp = (float)unknown_time / (float)total_time * 100;\r\nprintf(" Time in unknown state: %lus (%.2f%%)\n", unknown_time, tmp);\r\n}\r\nstatic void ender(int s)\r\n{\r\nendit = 1;\r\n}\r\nstatic void usage(void)\r\n{\r\nputs("usage: dslm [-w <time>] <disk>");\r\nexit(0);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nint fd;\r\nchar *disk = 0;\r\nint settle_time = 60;\r\nif (argc == 2)\r\ndisk = argv[1];\r\nelse if (argc == 4) {\r\nsettle_time = atoi(argv[2]);\r\ndisk = argv[3];\r\n} else\r\nusage();\r\nif (!(fd = open(disk, O_RDONLY|O_NONBLOCK))) {\r\nprintf("Can't open %s, because: %s\n", disk, strerror(errno));\r\nexit(-1);\r\n}\r\nif (settle_time) {\r\nprintf("Waiting %d seconds for the system to settle down to "\r\n"'normal'\n", settle_time);\r\nsleep(settle_time);\r\n} else\r\nputs("Not waiting for system to settle down");\r\nsignal(SIGINT, ender);\r\nmeasure(fd);\r\nclose(fd);\r\nreturn 0;\r\n}

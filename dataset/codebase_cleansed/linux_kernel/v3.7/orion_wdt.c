static int orion_wdt_ping(struct watchdog_device *wdt_dev)\r\n{\r\nspin_lock(&wdt_lock);\r\nwritel(wdt_tclk * wdt_dev->timeout, wdt_reg + WDT_VAL);\r\nspin_unlock(&wdt_lock);\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nu32 reg;\r\nspin_lock(&wdt_lock);\r\nwritel(wdt_tclk * wdt_dev->timeout, wdt_reg + WDT_VAL);\r\nreg = readl(BRIDGE_CAUSE);\r\nreg &= ~WDT_INT_REQ;\r\nwritel(reg, BRIDGE_CAUSE);\r\nreg = readl(wdt_reg + TIMER_CTRL);\r\nreg |= WDT_EN;\r\nwritel(reg, wdt_reg + TIMER_CTRL);\r\nreg = readl(RSTOUTn_MASK);\r\nreg |= WDT_RESET_OUT_EN;\r\nwritel(reg, RSTOUTn_MASK);\r\nspin_unlock(&wdt_lock);\r\nreturn 0;\r\n}\r\nstatic int orion_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nu32 reg;\r\nspin_lock(&wdt_lock);\r\nreg = readl(RSTOUTn_MASK);\r\nreg &= ~WDT_RESET_OUT_EN;\r\nwritel(reg, RSTOUTn_MASK);\r\nreg = readl(wdt_reg + TIMER_CTRL);\r\nreg &= ~WDT_EN;\r\nwritel(reg, wdt_reg + TIMER_CTRL);\r\nspin_unlock(&wdt_lock);\r\nreturn 0;\r\n}\r\nstatic unsigned int orion_wdt_get_timeleft(struct watchdog_device *wdt_dev)\r\n{\r\nunsigned int time_left;\r\nspin_lock(&wdt_lock);\r\ntime_left = readl(wdt_reg + WDT_VAL) / wdt_tclk;\r\nspin_unlock(&wdt_lock);\r\nreturn time_left;\r\n}\r\nstatic int orion_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int timeout)\r\n{\r\nwdt_dev->timeout = timeout;\r\nreturn 0;\r\n}\r\nstatic int __devinit orion_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nint ret;\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Orion Watchdog missing clock\n");\r\nreturn -ENODEV;\r\n}\r\nclk_prepare_enable(clk);\r\nwdt_tclk = clk_get_rate(clk);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nwdt_reg = devm_ioremap(&pdev->dev, res->start, resource_size(res));\r\nif (!wdt_reg)\r\nreturn -ENOMEM;\r\nwdt_max_duration = WDT_MAX_CYCLE_COUNT / wdt_tclk;\r\nif ((heartbeat < 1) || (heartbeat > wdt_max_duration))\r\nheartbeat = wdt_max_duration;\r\norion_wdt.timeout = heartbeat;\r\norion_wdt.min_timeout = 1;\r\norion_wdt.max_timeout = wdt_max_duration;\r\nwatchdog_set_nowayout(&orion_wdt, nowayout);\r\nret = watchdog_register_device(&orion_wdt);\r\nif (ret) {\r\nclk_disable_unprepare(clk);\r\nreturn ret;\r\n}\r\npr_info("Initial timeout %d sec%s\n",\r\nheartbeat, nowayout ? ", nowayout" : "");\r\nreturn 0;\r\n}\r\nstatic int __devexit orion_wdt_remove(struct platform_device *pdev)\r\n{\r\nwatchdog_unregister_device(&orion_wdt);\r\nclk_disable_unprepare(clk);\r\nreturn 0;\r\n}\r\nstatic void orion_wdt_shutdown(struct platform_device *pdev)\r\n{\r\norion_wdt_stop(&orion_wdt);\r\n}

static int mxs_sgtl5000_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nstruct snd_soc_dai *cpu_dai = rtd->cpu_dai;\r\nunsigned int rate = params_rate(params);\r\nu32 dai_format, mclk;\r\nint ret;\r\nswitch (rate) {\r\ncase 96000:\r\nmclk = 256 * rate;\r\nbreak;\r\ndefault:\r\nmclk = 512 * rate;\r\nbreak;\r\n}\r\nif (mclk < 8000000 || mclk > 27000000)\r\nreturn -EINVAL;\r\nret = snd_soc_dai_set_sysclk(codec_dai, SGTL5000_SYSCLK, mclk, 0);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dai_set_sysclk(cpu_dai, MXS_SAIF_MCLK, mclk, 0);\r\nif (ret)\r\nreturn ret;\r\ndai_format = SND_SOC_DAIFMT_I2S | SND_SOC_DAIFMT_NB_NF |\r\nSND_SOC_DAIFMT_CBS_CFS;\r\nret = snd_soc_dai_set_fmt(codec_dai, dai_format);\r\nif (ret)\r\nreturn ret;\r\nret = snd_soc_dai_set_fmt(cpu_dai, dai_format);\r\nif (ret)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int __devinit mxs_sgtl5000_probe_dt(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *saif_np[2], *codec_np;\r\nint i, ret = 0;\r\nif (!np)\r\nreturn 1;\r\nsaif_np[0] = of_parse_phandle(np, "saif-controllers", 0);\r\nsaif_np[1] = of_parse_phandle(np, "saif-controllers", 1);\r\ncodec_np = of_parse_phandle(np, "audio-codec", 0);\r\nif (!saif_np[0] || !saif_np[1] || !codec_np) {\r\ndev_err(&pdev->dev, "phandle missing or invalid\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nmxs_sgtl5000_dai[i].codec_name = NULL;\r\nmxs_sgtl5000_dai[i].codec_of_node = codec_np;\r\nmxs_sgtl5000_dai[i].cpu_dai_name = NULL;\r\nmxs_sgtl5000_dai[i].cpu_of_node = saif_np[i];\r\nmxs_sgtl5000_dai[i].platform_name = NULL;\r\nmxs_sgtl5000_dai[i].platform_of_node = saif_np[i];\r\n}\r\nof_node_put(codec_np);\r\nof_node_put(saif_np[0]);\r\nof_node_put(saif_np[1]);\r\nreturn ret;\r\n}\r\nstatic int __devinit mxs_sgtl5000_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &mxs_sgtl5000;\r\nint ret;\r\nret = mxs_sgtl5000_probe_dt(pdev);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mxs_saif_get_mclk(0, 44100 * 256, 44100);\r\nif (ret)\r\nreturn ret;\r\ncard->dev = &pdev->dev;\r\nplatform_set_drvdata(pdev, card);\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed (%d)\n",\r\nret);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devexit mxs_sgtl5000_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nmxs_saif_put_mclk(0);\r\nsnd_soc_unregister_card(card);\r\nreturn 0;\r\n}

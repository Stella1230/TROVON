static int jornada_bl_get_brightness(struct backlight_device *bd)\r\n{\r\nint ret;\r\nif (!(PPSR & PPC_LDD1))\r\nreturn 0;\r\njornada_ssp_start();\r\nret = jornada_ssp_byte(GETBRIGHTNESS);\r\nif (jornada_ssp_byte(GETBRIGHTNESS) != TXDUMMY) {\r\npr_err("get brightness timeout\n");\r\njornada_ssp_end();\r\nreturn -ETIMEDOUT;\r\n} else\r\nret = jornada_ssp_byte(TXDUMMY);\r\njornada_ssp_end();\r\nreturn (BL_MAX_BRIGHT - ret);\r\n}\r\nstatic int jornada_bl_update_status(struct backlight_device *bd)\r\n{\r\nint ret = 0;\r\njornada_ssp_start();\r\nif ((bd->props.power != FB_BLANK_UNBLANK) || (bd->props.fb_blank != FB_BLANK_UNBLANK)) {\r\nret = jornada_ssp_byte(BRIGHTNESSOFF);\r\nif (ret != TXDUMMY) {\r\npr_info("brightness off timeout\n");\r\nPPSR &= ~PPC_LDD1;\r\nPPDR |= PPC_LDD1;\r\nret = -ETIMEDOUT;\r\n}\r\n} else\r\nPPSR |= PPC_LDD1;\r\nif (jornada_ssp_byte(SETBRIGHTNESS) != TXDUMMY) {\r\npr_info("failed to set brightness\n");\r\nret = -ETIMEDOUT;\r\ngoto out;\r\n}\r\nif (jornada_ssp_byte(BL_MAX_BRIGHT - bd->props.brightness) != TXDUMMY) {\r\npr_err("set brightness failed\n");\r\nret = -ETIMEDOUT;\r\n}\r\nout:\r\njornada_ssp_end();\r\nreturn ret;\r\n}\r\nstatic int jornada_bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nint ret;\r\nstruct backlight_device *bd;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = BL_MAX_BRIGHT;\r\nbd = backlight_device_register(S1D_DEVICENAME, &pdev->dev, NULL,\r\n&jornada_bl_ops, &props);\r\nif (IS_ERR(bd)) {\r\nret = PTR_ERR(bd);\r\npr_err("failed to register device, err=%x\n", ret);\r\nreturn ret;\r\n}\r\nbd->props.power = FB_BLANK_UNBLANK;\r\nbd->props.brightness = BL_DEF_BRIGHT;\r\njornada_bl_update_status(bd);\r\nplatform_set_drvdata(pdev, bd);\r\npr_info("HP Jornada 700 series backlight driver\n");\r\nreturn 0;\r\n}\r\nstatic int jornada_bl_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nbacklight_device_unregister(bd);\r\nreturn 0;\r\n}

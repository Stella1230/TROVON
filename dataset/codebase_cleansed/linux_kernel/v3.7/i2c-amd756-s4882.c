static s32 amd756_access_virt0(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data * data)\r\n{\r\nint error;\r\nif (addr == 0x4c || (addr & 0xfc) == 0x50 || (addr & 0xfc) == 0x30\r\n|| addr == 0x18)\r\nreturn -ENXIO;\r\nmutex_lock(&amd756_lock);\r\nerror = amd756_smbus.algo->smbus_xfer(adap, addr, flags, read_write,\r\ncommand, size, data);\r\nmutex_unlock(&amd756_lock);\r\nreturn error;\r\n}\r\nstatic inline s32 amd756_access_channel(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data * data,\r\nu8 channels)\r\n{\r\nint error;\r\nif (addr != 0x4c && (addr & 0xfc) != 0x50 && (addr & 0xfc) != 0x30)\r\nreturn -ENXIO;\r\nmutex_lock(&amd756_lock);\r\nif (last_channels != channels) {\r\nunion i2c_smbus_data mplxdata;\r\nmplxdata.byte = channels;\r\nerror = amd756_smbus.algo->smbus_xfer(adap, 0x18, 0,\r\nI2C_SMBUS_WRITE, 0x01,\r\nI2C_SMBUS_BYTE_DATA,\r\n&mplxdata);\r\nif (error)\r\ngoto UNLOCK;\r\nlast_channels = channels;\r\n}\r\nerror = amd756_smbus.algo->smbus_xfer(adap, addr, flags, read_write,\r\ncommand, size, data);\r\nUNLOCK:\r\nmutex_unlock(&amd756_lock);\r\nreturn error;\r\n}\r\nstatic s32 amd756_access_virt1(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data * data)\r\n{\r\nreturn amd756_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x03);\r\n}\r\nstatic s32 amd756_access_virt2(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data * data)\r\n{\r\nreturn amd756_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x24);\r\n}\r\nstatic s32 amd756_access_virt3(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data * data)\r\n{\r\nreturn amd756_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x48);\r\n}\r\nstatic s32 amd756_access_virt4(struct i2c_adapter * adap, u16 addr,\r\nunsigned short flags, char read_write,\r\nu8 command, int size,\r\nunion i2c_smbus_data * data)\r\n{\r\nreturn amd756_access_channel(adap, addr, flags, read_write, command,\r\nsize, data, 0x90);\r\n}\r\nstatic int __init amd756_s4882_init(void)\r\n{\r\nint i, error;\r\nunion i2c_smbus_data ioconfig;\r\nif (!amd756_smbus.dev.parent)\r\nreturn -ENODEV;\r\nioconfig.byte = 0x00;\r\nerror = i2c_smbus_xfer(&amd756_smbus, 0x18, 0, I2C_SMBUS_WRITE, 0x03,\r\nI2C_SMBUS_BYTE_DATA, &ioconfig);\r\nif (error) {\r\ndev_err(&amd756_smbus.dev, "PCA9556 configuration failed\n");\r\nerror = -EIO;\r\ngoto ERROR0;\r\n}\r\nerror = i2c_del_adapter(&amd756_smbus);\r\nif (error) {\r\ndev_err(&amd756_smbus.dev, "Physical bus removal failed\n");\r\ngoto ERROR0;\r\n}\r\nprintk(KERN_INFO "Enabling SMBus multiplexing for Tyan S4882\n");\r\nif (!(s4882_adapter = kzalloc(5 * sizeof(struct i2c_adapter),\r\nGFP_KERNEL))) {\r\nerror = -ENOMEM;\r\ngoto ERROR1;\r\n}\r\nif (!(s4882_algo = kzalloc(5 * sizeof(struct i2c_algorithm),\r\nGFP_KERNEL))) {\r\nerror = -ENOMEM;\r\ngoto ERROR2;\r\n}\r\ns4882_algo[0] = *(amd756_smbus.algo);\r\ns4882_algo[0].smbus_xfer = amd756_access_virt0;\r\ns4882_adapter[0] = amd756_smbus;\r\ns4882_adapter[0].algo = s4882_algo;\r\ns4882_adapter[0].dev.parent = amd756_smbus.dev.parent;\r\nfor (i = 1; i < 5; i++) {\r\ns4882_algo[i] = *(amd756_smbus.algo);\r\ns4882_adapter[i] = amd756_smbus;\r\nsnprintf(s4882_adapter[i].name, sizeof(s4882_adapter[i].name),\r\n"SMBus 8111 adapter (CPU%d)", i-1);\r\ns4882_adapter[i].algo = s4882_algo+i;\r\ns4882_adapter[i].dev.parent = amd756_smbus.dev.parent;\r\n}\r\ns4882_algo[1].smbus_xfer = amd756_access_virt1;\r\ns4882_algo[2].smbus_xfer = amd756_access_virt2;\r\ns4882_algo[3].smbus_xfer = amd756_access_virt3;\r\ns4882_algo[4].smbus_xfer = amd756_access_virt4;\r\nfor (i = 0; i < 5; i++) {\r\nerror = i2c_add_adapter(s4882_adapter+i);\r\nif (error) {\r\nprintk(KERN_ERR "i2c-amd756-s4882: "\r\n"Virtual adapter %d registration "\r\n"failed, module not inserted\n", i);\r\nfor (i--; i >= 0; i--)\r\ni2c_del_adapter(s4882_adapter+i);\r\ngoto ERROR3;\r\n}\r\n}\r\nreturn 0;\r\nERROR3:\r\nkfree(s4882_algo);\r\ns4882_algo = NULL;\r\nERROR2:\r\nkfree(s4882_adapter);\r\ns4882_adapter = NULL;\r\nERROR1:\r\ni2c_add_adapter(&amd756_smbus);\r\nERROR0:\r\nreturn error;\r\n}\r\nstatic void __exit amd756_s4882_exit(void)\r\n{\r\nif (s4882_adapter) {\r\nint i;\r\nfor (i = 0; i < 5; i++)\r\ni2c_del_adapter(s4882_adapter+i);\r\nkfree(s4882_adapter);\r\ns4882_adapter = NULL;\r\n}\r\nkfree(s4882_algo);\r\ns4882_algo = NULL;\r\nif (i2c_add_adapter(&amd756_smbus))\r\nprintk(KERN_ERR "i2c-amd756-s4882: "\r\n"Physical bus restoration failed\n");\r\n}

static inline void davinci_irq_writel(unsigned long value, int offset)\r\n{\r\n__raw_writel(value, davinci_intc_base + offset);\r\n}\r\nstatic __init void\r\ndavinci_alloc_gc(void __iomem *base, unsigned int irq_start, unsigned int num)\r\n{\r\nstruct irq_chip_generic *gc;\r\nstruct irq_chip_type *ct;\r\ngc = irq_alloc_generic_chip("AINTC", 1, irq_start, base, handle_edge_irq);\r\nif (!gc) {\r\npr_err("%s: irq_alloc_generic_chip for IRQ %u failed\n",\r\n__func__, irq_start);\r\nreturn;\r\n}\r\nct = gc->chip_types;\r\nct->chip.irq_ack = irq_gc_ack_set_bit;\r\nct->chip.irq_mask = irq_gc_mask_clr_bit;\r\nct->chip.irq_unmask = irq_gc_mask_set_bit;\r\nct->regs.ack = IRQ_REG0_OFFSET;\r\nct->regs.mask = IRQ_ENT_REG0_OFFSET;\r\nirq_setup_generic_chip(gc, IRQ_MSK(num), IRQ_GC_INIT_MASK_CACHE,\r\nIRQ_NOREQUEST | IRQ_NOPROBE, 0);\r\n}\r\nvoid __init davinci_irq_init(void)\r\n{\r\nunsigned i, j;\r\nconst u8 *davinci_def_priorities = davinci_soc_info.intc_irq_prios;\r\ndavinci_intc_type = DAVINCI_INTC_TYPE_AINTC;\r\ndavinci_intc_base = ioremap(davinci_soc_info.intc_base, SZ_4K);\r\nif (WARN_ON(!davinci_intc_base))\r\nreturn;\r\ndavinci_irq_writel(~0x0, FIQ_REG0_OFFSET);\r\ndavinci_irq_writel(~0x0, FIQ_REG1_OFFSET);\r\ndavinci_irq_writel(~0x0, IRQ_REG0_OFFSET);\r\ndavinci_irq_writel(~0x0, IRQ_REG1_OFFSET);\r\ndavinci_irq_writel(0x0, IRQ_ENT_REG0_OFFSET);\r\ndavinci_irq_writel(0x0, IRQ_ENT_REG1_OFFSET);\r\ndavinci_irq_writel(0x0, IRQ_INCTL_REG_OFFSET);\r\ndavinci_irq_writel(0, IRQ_EABASE_REG_OFFSET);\r\ndavinci_irq_writel(~0x0, FIQ_REG0_OFFSET);\r\ndavinci_irq_writel(~0x0, FIQ_REG1_OFFSET);\r\ndavinci_irq_writel(~0x0, IRQ_REG0_OFFSET);\r\ndavinci_irq_writel(~0x0, IRQ_REG1_OFFSET);\r\nfor (i = IRQ_INTPRI0_REG_OFFSET; i <= IRQ_INTPRI7_REG_OFFSET; i += 4) {\r\nu32 pri;\r\nfor (j = 0, pri = 0; j < 32; j += 4, davinci_def_priorities++)\r\npri |= (*davinci_def_priorities & 0x07) << j;\r\ndavinci_irq_writel(pri, i);\r\n}\r\nfor (i = 0, j = 0; i < davinci_soc_info.intc_irq_num; i += 32, j += 0x04)\r\ndavinci_alloc_gc(davinci_intc_base + j, i, 32);\r\nirq_set_handler(IRQ_TINT1_TINT34, handle_level_irq);\r\n}

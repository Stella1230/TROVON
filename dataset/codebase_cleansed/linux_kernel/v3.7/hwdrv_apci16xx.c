int i_APCI16XX_InsnConfigInitTTLIO(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = insn->n;\r\nunsigned char b_Command = 0;\r\nunsigned char b_Cpt = 0;\r\nunsigned char b_NumberOfPort =\r\n(unsigned char) (this_board->i_NbrTTLChannel / 8);\r\nif (insn->n >= 1) {\r\nb_Command = (unsigned char) data[0];\r\nif ((b_Command == APCI16XX_TTL_INIT) ||\r\n(b_Command == APCI16XX_TTL_INITDIRECTION) ||\r\n(b_Command == APCI16XX_TTL_OUTPUTMEMORY)) {\r\nif ((b_Command == APCI16XX_TTL_INITDIRECTION)\r\n&& ((unsigned char) (insn->n - 1) != b_NumberOfPort)) {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\nif ((b_Command == APCI16XX_TTL_OUTPUTMEMORY)\r\n&& ((unsigned char) (insn->n) != 2)) {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\n} else {\r\nprintk("\nCommand selection error");\r\ni_ReturnValue = -100;\r\n}\r\n} else {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\nif ((i_ReturnValue >= 0) && (b_Command == APCI16XX_TTL_INITDIRECTION)) {\r\nmemset(devpriv->ul_TTLPortConfiguration, 0,\r\nsizeof(devpriv->ul_TTLPortConfiguration));\r\nfor (b_Cpt = 1;\r\n(b_Cpt <= b_NumberOfPort) && (i_ReturnValue >= 0);\r\nb_Cpt++) {\r\nif ((data[b_Cpt] != 0) && (data[b_Cpt] != 0xFF)) {\r\nprintk("\nPort %d direction selection error",\r\n(int) b_Cpt);\r\ni_ReturnValue = -(int) b_Cpt;\r\n}\r\ndevpriv->ul_TTLPortConfiguration[(b_Cpt - 1) / 4] =\r\ndevpriv->ul_TTLPortConfiguration[(b_Cpt -\r\n1) / 4] | (data[b_Cpt] << (8 * ((b_Cpt -\r\n1) % 4)));\r\n}\r\n}\r\nif (i_ReturnValue >= 0) {\r\nif ((b_Command == APCI16XX_TTL_INIT)\r\n|| (b_Command == APCI16XX_TTL_INITDIRECTION)) {\r\nfor (b_Cpt = 0; b_Cpt <= b_NumberOfPort; b_Cpt++) {\r\nif ((b_Cpt % 4) == 0) {\r\noutl(devpriv->\r\nul_TTLPortConfiguration[b_Cpt /\r\n4],\r\ndevpriv->iobase + 32 + b_Cpt);\r\n}\r\n}\r\n}\r\n}\r\nif (b_Command == APCI16XX_TTL_OUTPUTMEMORY) {\r\nif (data[1]) {\r\ndevpriv->b_OutputMemoryStatus = ADDIDATA_ENABLE;\r\n} else {\r\ndevpriv->b_OutputMemoryStatus = ADDIDATA_DISABLE;\r\n}\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI16XX_InsnBitsReadTTLIO(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = insn->n;\r\nunsigned char b_Command = 0;\r\nunsigned char b_NumberOfPort =\r\n(unsigned char) (this_board->i_NbrTTLChannel / 8);\r\nunsigned char b_SelectedPort = CR_RANGE(insn->chanspec);\r\nunsigned char b_InputChannel = CR_CHAN(insn->chanspec);\r\nunsigned char *pb_Status;\r\nunsigned int dw_Status;\r\nif (insn->n >= 1) {\r\nb_Command = (unsigned char) data[0];\r\nif ((b_Command == APCI16XX_TTL_READCHANNEL)\r\n|| (b_Command == APCI16XX_TTL_READPORT)) {\r\nif (b_SelectedPort < b_NumberOfPort) {\r\nif (((devpriv->ul_TTLPortConfiguration\r\n[b_SelectedPort /\r\n4] >> (8 *\r\n(b_SelectedPort\r\n%\r\n4))) &\r\n0xFF) == 0) {\r\nif ((b_Command ==\r\nAPCI16XX_TTL_READCHANNEL)\r\n&& (b_InputChannel > 7)) {\r\nprintk("\nChannel selection error");\r\ni_ReturnValue = -103;\r\n}\r\n} else {\r\nprintk("\nPort selection error");\r\ni_ReturnValue = -102;\r\n}\r\n} else {\r\nprintk("\nPort selection error");\r\ni_ReturnValue = -102;\r\n}\r\n} else {\r\nprintk("\nCommand selection error");\r\ni_ReturnValue = -100;\r\n}\r\n} else {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\nif (i_ReturnValue >= 0) {\r\npb_Status = (unsigned char *) &data[0];\r\ndw_Status =\r\ninl(devpriv->iobase + 8 + ((b_SelectedPort / 4) * 4));\r\ndw_Status = (dw_Status >> (8 * (b_SelectedPort % 4))) & 0xFF;\r\n*pb_Status = (unsigned char) dw_Status;\r\nif (b_Command == APCI16XX_TTL_READCHANNEL) {\r\n*pb_Status = (*pb_Status >> b_InputChannel) & 1;\r\n}\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI16XX_InsnReadTTLIOAllPortValue(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned char b_Command = (unsigned char) CR_AREF(insn->chanspec);\r\nint i_ReturnValue = insn->n;\r\nunsigned char b_Cpt = 0;\r\nunsigned char b_NumberOfPort = 0;\r\nunsigned int *pls_ReadData = data;\r\nif ((b_Command == APCI16XX_TTL_READ_ALL_INPUTS)\r\n|| (b_Command == APCI16XX_TTL_READ_ALL_OUTPUTS)) {\r\nb_NumberOfPort =\r\n(unsigned char) (this_board->i_NbrTTLChannel / 32);\r\nif ((b_NumberOfPort * 32) <\r\nthis_board->i_NbrTTLChannel) {\r\nb_NumberOfPort = b_NumberOfPort + 1;\r\n}\r\nif (insn->n >= b_NumberOfPort) {\r\nif (b_Command == APCI16XX_TTL_READ_ALL_INPUTS) {\r\nfor (b_Cpt = 0; b_Cpt < b_NumberOfPort; b_Cpt++) {\r\npls_ReadData[b_Cpt] =\r\ninl(devpriv->iobase + 8 +\r\n(b_Cpt * 4));\r\npls_ReadData[b_Cpt] =\r\npls_ReadData[b_Cpt] &\r\n(~devpriv->\r\nul_TTLPortConfiguration[b_Cpt]);\r\n}\r\n} else {\r\nfor (b_Cpt = 0; b_Cpt < b_NumberOfPort; b_Cpt++) {\r\npls_ReadData[b_Cpt] =\r\ninl(devpriv->iobase + 20 +\r\n(b_Cpt * 4));\r\npls_ReadData[b_Cpt] =\r\npls_ReadData[b_Cpt] & devpriv->\r\nul_TTLPortConfiguration[b_Cpt];\r\n}\r\n}\r\n} else {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\n} else {\r\nprintk("\nCommand selection error");\r\ni_ReturnValue = -100;\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI16XX_InsnBitsWriteTTLIO(struct comedi_device *dev,\r\nstruct comedi_subdevice *s, struct comedi_insn *insn, unsigned int *data)\r\n{\r\nint i_ReturnValue = insn->n;\r\nunsigned char b_Command = 0;\r\nunsigned char b_NumberOfPort =\r\n(unsigned char) (this_board->i_NbrTTLChannel / 8);\r\nunsigned char b_SelectedPort = CR_RANGE(insn->chanspec);\r\nunsigned char b_OutputChannel = CR_CHAN(insn->chanspec);\r\nunsigned int dw_Status = 0;\r\nif (insn->n >= 1) {\r\nb_Command = (unsigned char) data[0];\r\nif ((b_Command == APCI16XX_TTL_WRITECHANNEL_ON) ||\r\n(b_Command == APCI16XX_TTL_WRITEPORT_ON) ||\r\n(b_Command == APCI16XX_TTL_WRITECHANNEL_OFF) ||\r\n(b_Command == APCI16XX_TTL_WRITEPORT_OFF)) {\r\nif (b_SelectedPort < b_NumberOfPort) {\r\nif (((devpriv->ul_TTLPortConfiguration\r\n[b_SelectedPort /\r\n4] >> (8 *\r\n(b_SelectedPort\r\n%\r\n4))) &\r\n0xFF) == 0xFF) {\r\nif (((b_Command == APCI16XX_TTL_WRITECHANNEL_ON) || (b_Command == APCI16XX_TTL_WRITECHANNEL_OFF)) && (b_OutputChannel > 7)) {\r\nprintk("\nChannel selection error");\r\ni_ReturnValue = -103;\r\n}\r\nif (((b_Command == APCI16XX_TTL_WRITECHANNEL_OFF) || (b_Command == APCI16XX_TTL_WRITEPORT_OFF)) && (devpriv->b_OutputMemoryStatus == ADDIDATA_DISABLE)) {\r\nprintk("\nOutput memory disabled");\r\ni_ReturnValue = -104;\r\n}\r\nif (((b_Command == APCI16XX_TTL_WRITEPORT_ON) || (b_Command == APCI16XX_TTL_WRITEPORT_OFF)) && (insn->n < 2)) {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\n} else {\r\nprintk("\nPort selection error %lX",\r\n(unsigned long)devpriv->\r\nul_TTLPortConfiguration[0]);\r\ni_ReturnValue = -102;\r\n}\r\n} else {\r\nprintk("\nPort selection error %d %d",\r\nb_SelectedPort, b_NumberOfPort);\r\ni_ReturnValue = -102;\r\n}\r\n} else {\r\nprintk("\nCommand selection error");\r\ni_ReturnValue = -100;\r\n}\r\n} else {\r\nprintk("\nBuffer size error");\r\ni_ReturnValue = -101;\r\n}\r\nif (i_ReturnValue >= 0) {\r\ndw_Status =\r\ninl(devpriv->iobase + 20 + ((b_SelectedPort / 4) * 4));\r\nif (devpriv->b_OutputMemoryStatus == ADDIDATA_DISABLE) {\r\ndw_Status =\r\ndw_Status & (0xFFFFFFFFUL -\r\n(0xFFUL << (8 * (b_SelectedPort % 4))));\r\n}\r\nif (b_Command == APCI16XX_TTL_WRITECHANNEL_ON) {\r\ndw_Status =\r\ndw_Status | (1UL << ((8 * (b_SelectedPort %\r\n4)) + b_OutputChannel));\r\n}\r\nif (b_Command == APCI16XX_TTL_WRITEPORT_ON) {\r\ndw_Status =\r\ndw_Status | ((data[1] & 0xFF) << (8 *\r\n(b_SelectedPort % 4)));\r\n}\r\nif (b_Command == APCI16XX_TTL_WRITECHANNEL_OFF) {\r\ndw_Status =\r\ndw_Status & (0xFFFFFFFFUL -\r\n(1UL << ((8 * (b_SelectedPort % 4)) +\r\nb_OutputChannel)));\r\n}\r\nif (b_Command == APCI16XX_TTL_WRITEPORT_OFF) {\r\ndw_Status =\r\ndw_Status & (0xFFFFFFFFUL -\r\n((data[1] & 0xFF) << (8 * (b_SelectedPort %\r\n4))));\r\n}\r\noutl(dw_Status,\r\ndevpriv->iobase + 20 + ((b_SelectedPort / 4) * 4));\r\n}\r\nreturn i_ReturnValue;\r\n}\r\nint i_APCI16XX_Reset(struct comedi_device *dev)\r\n{\r\nreturn 0;\r\n}

static int __devinit\r\nscb2_fixup_mtd(struct mtd_info *mtd)\r\n{\r\nint i;\r\nint done = 0;\r\nstruct map_info *map = mtd->priv;\r\nstruct cfi_private *cfi = map->fldrv_priv;\r\nif (cfi->cfiq->InterfaceDesc != CFI_INTERFACE_X16_ASYNC) {\r\nprintk(KERN_ERR MODNAME ": unsupported InterfaceDesc: %#x\n",\r\ncfi->cfiq->InterfaceDesc);\r\nreturn -1;\r\n}\r\nmtd->size = map->size;\r\nmtd->erasesize /= 2;\r\nfor (i = 0; i < mtd->numeraseregions; i++) {\r\nstruct mtd_erase_region_info *region = &mtd->eraseregions[i];\r\nregion->erasesize /= 2;\r\n}\r\nfor (i = 0; !done && i < mtd->numeraseregions; i++) {\r\nstruct mtd_erase_region_info *region = &mtd->eraseregions[i];\r\nif (region->numblocks * region->erasesize > mtd->size) {\r\nregion->numblocks = ((unsigned long)mtd->size /\r\nregion->erasesize);\r\ndone = 1;\r\n} else {\r\nregion->numblocks = 0;\r\n}\r\nregion->offset = 0;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __devinit\r\nscb2_flash_probe(struct pci_dev *dev, const struct pci_device_id *ent)\r\n{\r\nu8 reg;\r\npci_read_config_byte(dev, CSB5_FCR, &reg);\r\npci_write_config_byte(dev, CSB5_FCR, reg | CSB5_FCR_DECODE_ALL);\r\nif (!request_mem_region(SCB2_ADDR, SCB2_WINDOW, scb2_map.name)) {\r\nprintk(KERN_WARNING MODNAME\r\n": warning - can't reserve rom window, continuing\n");\r\nregion_fail = 1;\r\n}\r\nscb2_ioaddr = ioremap_nocache(SCB2_ADDR, SCB2_WINDOW);\r\nif (!scb2_ioaddr) {\r\nprintk(KERN_ERR MODNAME ": Failed to ioremap window!\n");\r\nif (!region_fail)\r\nrelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\r\nreturn -ENOMEM;\r\n}\r\nscb2_map.phys = SCB2_ADDR;\r\nscb2_map.virt = scb2_ioaddr;\r\nscb2_map.size = SCB2_WINDOW;\r\nsimple_map_init(&scb2_map);\r\nscb2_mtd = do_map_probe("cfi_probe", &scb2_map);\r\nif (!scb2_mtd) {\r\nprintk(KERN_ERR MODNAME ": flash probe failed!\n");\r\niounmap(scb2_ioaddr);\r\nif (!region_fail)\r\nrelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\r\nreturn -ENODEV;\r\n}\r\nscb2_mtd->owner = THIS_MODULE;\r\nif (scb2_fixup_mtd(scb2_mtd) < 0) {\r\nmtd_device_unregister(scb2_mtd);\r\nmap_destroy(scb2_mtd);\r\niounmap(scb2_ioaddr);\r\nif (!region_fail)\r\nrelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_NOTICE MODNAME ": chip size 0x%llx at offset 0x%llx\n",\r\n(unsigned long long)scb2_mtd->size,\r\n(unsigned long long)(SCB2_WINDOW - scb2_mtd->size));\r\nmtd_device_register(scb2_mtd, NULL, 0);\r\nreturn 0;\r\n}\r\nstatic void __devexit\r\nscb2_flash_remove(struct pci_dev *dev)\r\n{\r\nif (!scb2_mtd)\r\nreturn;\r\nmtd_lock(scb2_mtd, 0, scb2_mtd->size);\r\nmtd_device_unregister(scb2_mtd);\r\nmap_destroy(scb2_mtd);\r\niounmap(scb2_ioaddr);\r\nscb2_ioaddr = NULL;\r\nif (!region_fail)\r\nrelease_mem_region(SCB2_ADDR, SCB2_WINDOW);\r\npci_set_drvdata(dev, NULL);\r\n}

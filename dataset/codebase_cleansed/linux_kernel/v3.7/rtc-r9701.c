static int write_reg(struct device *dev, int address, unsigned char data)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nunsigned char buf[2];\r\nbuf[0] = address & 0x7f;\r\nbuf[1] = data;\r\nreturn spi_write(spi, buf, ARRAY_SIZE(buf));\r\n}\r\nstatic int read_regs(struct device *dev, unsigned char *regs, int no_regs)\r\n{\r\nstruct spi_device *spi = to_spi_device(dev);\r\nu8 txbuf[1], rxbuf[1];\r\nint k, ret;\r\nret = 0;\r\nfor (k = 0; ret == 0 && k < no_regs; k++) {\r\ntxbuf[0] = 0x80 | regs[k];\r\nret = spi_write_then_read(spi, txbuf, 1, rxbuf, 1);\r\nregs[k] = rxbuf[0];\r\n}\r\nreturn ret;\r\n}\r\nstatic int r9701_get_datetime(struct device *dev, struct rtc_time *dt)\r\n{\r\nint ret;\r\nunsigned char buf[] = { RSECCNT, RMINCNT, RHRCNT,\r\nRDAYCNT, RMONCNT, RYRCNT };\r\nret = read_regs(dev, buf, ARRAY_SIZE(buf));\r\nif (ret)\r\nreturn ret;\r\nmemset(dt, 0, sizeof(*dt));\r\ndt->tm_sec = bcd2bin(buf[0]);\r\ndt->tm_min = bcd2bin(buf[1]);\r\ndt->tm_hour = bcd2bin(buf[2]);\r\ndt->tm_mday = bcd2bin(buf[3]);\r\ndt->tm_mon = bcd2bin(buf[4]) - 1;\r\ndt->tm_year = bcd2bin(buf[5]) + 100;\r\nreturn rtc_valid_tm(dt);\r\n}\r\nstatic int r9701_set_datetime(struct device *dev, struct rtc_time *dt)\r\n{\r\nint ret, year;\r\nyear = dt->tm_year + 1900;\r\nif (year >= 2100 || year < 2000)\r\nreturn -EINVAL;\r\nret = write_reg(dev, RHRCNT, bin2bcd(dt->tm_hour));\r\nret = ret ? ret : write_reg(dev, RMINCNT, bin2bcd(dt->tm_min));\r\nret = ret ? ret : write_reg(dev, RSECCNT, bin2bcd(dt->tm_sec));\r\nret = ret ? ret : write_reg(dev, RDAYCNT, bin2bcd(dt->tm_mday));\r\nret = ret ? ret : write_reg(dev, RMONCNT, bin2bcd(dt->tm_mon + 1));\r\nret = ret ? ret : write_reg(dev, RYRCNT, bin2bcd(dt->tm_year - 100));\r\nret = ret ? ret : write_reg(dev, RWKCNT, 1 << dt->tm_wday);\r\nreturn ret;\r\n}\r\nstatic int __devinit r9701_probe(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct rtc_time dt;\r\nunsigned char tmp;\r\nint res;\r\ntmp = R100CNT;\r\nres = read_regs(&spi->dev, &tmp, 1);\r\nif (res || tmp != 0x20) {\r\ndev_err(&spi->dev, "cannot read RTC register\n");\r\nreturn -ENODEV;\r\n}\r\nif (r9701_get_datetime(&spi->dev, &dt)) {\r\ndev_info(&spi->dev, "trying to repair invalid date/time\n");\r\ndt.tm_sec = 0;\r\ndt.tm_min = 0;\r\ndt.tm_hour = 0;\r\ndt.tm_mday = 1;\r\ndt.tm_mon = 0;\r\ndt.tm_year = 100;\r\nif (r9701_set_datetime(&spi->dev, &dt) ||\r\nr9701_get_datetime(&spi->dev, &dt)) {\r\ndev_err(&spi->dev, "cannot repair RTC register\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\nrtc = rtc_device_register("r9701",\r\n&spi->dev, &r9701_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc))\r\nreturn PTR_ERR(rtc);\r\ndev_set_drvdata(&spi->dev, rtc);\r\nreturn 0;\r\n}\r\nstatic int __devexit r9701_remove(struct spi_device *spi)\r\n{\r\nstruct rtc_device *rtc = dev_get_drvdata(&spi->dev);\r\nrtc_device_unregister(rtc);\r\nreturn 0;\r\n}

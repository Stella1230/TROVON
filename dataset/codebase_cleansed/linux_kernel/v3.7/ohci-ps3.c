static int ps3_ohci_hc_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nohci->flags |= OHCI_QUIRK_BE_MMIO;\r\nohci_hcd_init(ohci);\r\nreturn ohci_init(ohci);\r\n}\r\nstatic int __devinit ps3_ohci_hc_start(struct usb_hcd *hcd)\r\n{\r\nint result;\r\nstruct ohci_hcd *ohci = hcd_to_ohci(hcd);\r\nohci_writel(ohci, 0x7f000000 | RH_A_PSM | RH_A_OCPM,\r\n&ohci->regs->roothub.a);\r\nohci_writel(ohci, 0x00060000, &ohci->regs->roothub.b);\r\nresult = ohci_run(ohci);\r\nif (result < 0) {\r\ndev_err(hcd->self.controller, "can't start %s\n",\r\nhcd->self.bus_name);\r\nohci_stop(hcd);\r\n}\r\nreturn result;\r\n}\r\nstatic int __devinit ps3_ohci_probe(struct ps3_system_bus_device *dev)\r\n{\r\nint result;\r\nstruct usb_hcd *hcd;\r\nunsigned int virq;\r\nstatic u64 dummy_mask = DMA_BIT_MASK(32);\r\nif (usb_disabled()) {\r\nresult = -ENODEV;\r\ngoto fail_start;\r\n}\r\nresult = ps3_open_hv_device(dev);\r\nif (result) {\r\ndev_dbg(&dev->core, "%s:%d: ps3_open_hv_device failed: %s\n",\r\n__func__, __LINE__, ps3_result(result));\r\nresult = -EPERM;\r\ngoto fail_open;\r\n}\r\nresult = ps3_dma_region_create(dev->d_region);\r\nif (result) {\r\ndev_dbg(&dev->core, "%s:%d: ps3_dma_region_create failed: "\r\n"(%d)\n", __func__, __LINE__, result);\r\nBUG_ON("check region type");\r\ngoto fail_dma_region;\r\n}\r\nresult = ps3_mmio_region_create(dev->m_region);\r\nif (result) {\r\ndev_dbg(&dev->core, "%s:%d: ps3_map_mmio_region failed\n",\r\n__func__, __LINE__);\r\nresult = -EPERM;\r\ngoto fail_mmio_region;\r\n}\r\ndev_dbg(&dev->core, "%s:%d: mmio mapped_addr %lxh\n", __func__,\r\n__LINE__, dev->m_region->lpar_addr);\r\nresult = ps3_io_irq_setup(PS3_BINDING_CPU_ANY, dev->interrupt_id, &virq);\r\nif (result) {\r\ndev_dbg(&dev->core, "%s:%d: ps3_construct_io_irq(%d) failed.\n",\r\n__func__, __LINE__, virq);\r\nresult = -EPERM;\r\ngoto fail_irq;\r\n}\r\ndev->core.dma_mask = &dummy_mask;\r\nhcd = usb_create_hcd(&ps3_ohci_hc_driver, &dev->core, dev_name(&dev->core));\r\nif (!hcd) {\r\ndev_dbg(&dev->core, "%s:%d: usb_create_hcd failed\n", __func__,\r\n__LINE__);\r\nresult = -ENOMEM;\r\ngoto fail_create_hcd;\r\n}\r\nhcd->rsrc_start = dev->m_region->lpar_addr;\r\nhcd->rsrc_len = dev->m_region->len;\r\nif (!request_mem_region(hcd->rsrc_start, hcd->rsrc_len, hcd_name))\r\ndev_dbg(&dev->core, "%s:%d: request_mem_region failed\n",\r\n__func__, __LINE__);\r\nhcd->regs = ioremap(dev->m_region->lpar_addr, dev->m_region->len);\r\nif (!hcd->regs) {\r\ndev_dbg(&dev->core, "%s:%d: ioremap failed\n", __func__,\r\n__LINE__);\r\nresult = -EPERM;\r\ngoto fail_ioremap;\r\n}\r\ndev_dbg(&dev->core, "%s:%d: hcd->rsrc_start %lxh\n", __func__, __LINE__,\r\n(unsigned long)hcd->rsrc_start);\r\ndev_dbg(&dev->core, "%s:%d: hcd->rsrc_len %lxh\n", __func__, __LINE__,\r\n(unsigned long)hcd->rsrc_len);\r\ndev_dbg(&dev->core, "%s:%d: hcd->regs %lxh\n", __func__, __LINE__,\r\n(unsigned long)hcd->regs);\r\ndev_dbg(&dev->core, "%s:%d: virq %lu\n", __func__, __LINE__,\r\n(unsigned long)virq);\r\nps3_system_bus_set_drvdata(dev, hcd);\r\nresult = usb_add_hcd(hcd, virq, 0);\r\nif (result) {\r\ndev_dbg(&dev->core, "%s:%d: usb_add_hcd failed (%d)\n",\r\n__func__, __LINE__, result);\r\ngoto fail_add_hcd;\r\n}\r\nreturn result;\r\nfail_add_hcd:\r\niounmap(hcd->regs);\r\nfail_ioremap:\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nfail_create_hcd:\r\nps3_io_irq_destroy(virq);\r\nfail_irq:\r\nps3_free_mmio_region(dev->m_region);\r\nfail_mmio_region:\r\nps3_dma_region_free(dev->d_region);\r\nfail_dma_region:\r\nps3_close_hv_device(dev);\r\nfail_open:\r\nfail_start:\r\nreturn result;\r\n}\r\nstatic int ps3_ohci_remove(struct ps3_system_bus_device *dev)\r\n{\r\nunsigned int tmp;\r\nstruct usb_hcd *hcd = ps3_system_bus_get_drvdata(dev);\r\nBUG_ON(!hcd);\r\ndev_dbg(&dev->core, "%s:%d: regs %p\n", __func__, __LINE__, hcd->regs);\r\ndev_dbg(&dev->core, "%s:%d: irq %u\n", __func__, __LINE__, hcd->irq);\r\ntmp = hcd->irq;\r\nohci_shutdown(hcd);\r\nusb_remove_hcd(hcd);\r\nps3_system_bus_set_drvdata(dev, NULL);\r\nBUG_ON(!hcd->regs);\r\niounmap(hcd->regs);\r\nrelease_mem_region(hcd->rsrc_start, hcd->rsrc_len);\r\nusb_put_hcd(hcd);\r\nps3_io_irq_destroy(tmp);\r\nps3_free_mmio_region(dev->m_region);\r\nps3_dma_region_free(dev->d_region);\r\nps3_close_hv_device(dev);\r\nreturn 0;\r\n}\r\nstatic int __init ps3_ohci_driver_register(struct ps3_system_bus_driver *drv)\r\n{\r\nreturn firmware_has_feature(FW_FEATURE_PS3_LV1)\r\n? ps3_system_bus_driver_register(drv)\r\n: 0;\r\n}\r\nstatic void ps3_ohci_driver_unregister(struct ps3_system_bus_driver *drv)\r\n{\r\nif (firmware_has_feature(FW_FEATURE_PS3_LV1))\r\nps3_system_bus_driver_unregister(drv);\r\n}

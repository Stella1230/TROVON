static inline const char *i8k_get_dmi_data(int field)\r\n{\r\nconst char *dmi_data = dmi_get_system_info(field);\r\nreturn dmi_data && *dmi_data ? dmi_data : "?";\r\n}\r\nstatic int i8k_smm(struct smm_regs *regs)\r\n{\r\nint rc;\r\nint eax = regs->eax;\r\n#if defined(CONFIG_X86_64)\r\nasm volatile("pushq %%rax\n\t"\r\n"movl 0(%%rax),%%edx\n\t"\r\n"pushq %%rdx\n\t"\r\n"movl 4(%%rax),%%ebx\n\t"\r\n"movl 8(%%rax),%%ecx\n\t"\r\n"movl 12(%%rax),%%edx\n\t"\r\n"movl 16(%%rax),%%esi\n\t"\r\n"movl 20(%%rax),%%edi\n\t"\r\n"popq %%rax\n\t"\r\n"out %%al,$0xb2\n\t"\r\n"out %%al,$0x84\n\t"\r\n"xchgq %%rax,(%%rsp)\n\t"\r\n"movl %%ebx,4(%%rax)\n\t"\r\n"movl %%ecx,8(%%rax)\n\t"\r\n"movl %%edx,12(%%rax)\n\t"\r\n"movl %%esi,16(%%rax)\n\t"\r\n"movl %%edi,20(%%rax)\n\t"\r\n"popq %%rdx\n\t"\r\n"movl %%edx,0(%%rax)\n\t"\r\n"pushfq\n\t"\r\n"popq %%rax\n\t"\r\n"andl $1,%%eax\n"\r\n:"=a"(rc)\r\n: "a"(regs)\r\n: "%ebx", "%ecx", "%edx", "%esi", "%edi", "memory");\r\n#else\r\nasm volatile("pushl %%eax\n\t"\r\n"movl 0(%%eax),%%edx\n\t"\r\n"push %%edx\n\t"\r\n"movl 4(%%eax),%%ebx\n\t"\r\n"movl 8(%%eax),%%ecx\n\t"\r\n"movl 12(%%eax),%%edx\n\t"\r\n"movl 16(%%eax),%%esi\n\t"\r\n"movl 20(%%eax),%%edi\n\t"\r\n"popl %%eax\n\t"\r\n"out %%al,$0xb2\n\t"\r\n"out %%al,$0x84\n\t"\r\n"xchgl %%eax,(%%esp)\n\t"\r\n"movl %%ebx,4(%%eax)\n\t"\r\n"movl %%ecx,8(%%eax)\n\t"\r\n"movl %%edx,12(%%eax)\n\t"\r\n"movl %%esi,16(%%eax)\n\t"\r\n"movl %%edi,20(%%eax)\n\t"\r\n"popl %%edx\n\t"\r\n"movl %%edx,0(%%eax)\n\t"\r\n"lahf\n\t"\r\n"shrl $8,%%eax\n\t"\r\n"andl $1,%%eax\n"\r\n:"=a"(rc)\r\n: "a"(regs)\r\n: "%ebx", "%ecx", "%edx", "%esi", "%edi", "memory");\r\n#endif\r\nif (rc != 0 || (regs->eax & 0xffff) == 0xffff || regs->eax == eax)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic int i8k_get_bios_version(void)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_BIOS_VERSION, };\r\nreturn i8k_smm(&regs) ? : regs.eax;\r\n}\r\nstatic int i8k_get_fn_status(void)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_FN_STATUS, };\r\nint rc;\r\nif ((rc = i8k_smm(&regs)) < 0)\r\nreturn rc;\r\nswitch ((regs.eax >> I8K_FN_SHIFT) & I8K_FN_MASK) {\r\ncase I8K_FN_UP:\r\nreturn I8K_VOL_UP;\r\ncase I8K_FN_DOWN:\r\nreturn I8K_VOL_DOWN;\r\ncase I8K_FN_MUTE:\r\nreturn I8K_VOL_MUTE;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic int i8k_get_power_status(void)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_POWER_STATUS, };\r\nint rc;\r\nif ((rc = i8k_smm(&regs)) < 0)\r\nreturn rc;\r\nreturn (regs.eax & 0xff) == I8K_POWER_AC ? I8K_AC : I8K_BATTERY;\r\n}\r\nstatic int i8k_get_fan_status(int fan)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_FAN, };\r\nregs.ebx = fan & 0xff;\r\nreturn i8k_smm(&regs) ? : regs.eax & 0xff;\r\n}\r\nstatic int i8k_get_fan_speed(int fan)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_SPEED, };\r\nregs.ebx = fan & 0xff;\r\nreturn i8k_smm(&regs) ? : (regs.eax & 0xffff) * fan_mult;\r\n}\r\nstatic int i8k_set_fan(int fan, int speed)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_SET_FAN, };\r\nspeed = (speed < 0) ? 0 : ((speed > I8K_FAN_MAX) ? I8K_FAN_MAX : speed);\r\nregs.ebx = (fan & 0xff) | (speed << 8);\r\nreturn i8k_smm(&regs) ? : i8k_get_fan_status(fan);\r\n}\r\nstatic int i8k_get_temp(int sensor)\r\n{\r\nstruct smm_regs regs = { .eax = I8K_SMM_GET_TEMP, };\r\nint rc;\r\nint temp;\r\n#ifdef I8K_TEMPERATURE_BUG\r\nstatic int prev;\r\n#endif\r\nregs.ebx = sensor & 0xff;\r\nif ((rc = i8k_smm(&regs)) < 0)\r\nreturn rc;\r\ntemp = regs.eax & 0xff;\r\n#ifdef I8K_TEMPERATURE_BUG\r\nif (temp > I8K_MAX_TEMP) {\r\ntemp = prev;\r\nprev = I8K_MAX_TEMP;\r\n} else {\r\nprev = temp;\r\n}\r\n#endif\r\nreturn temp;\r\n}\r\nstatic int i8k_get_dell_signature(int req_fn)\r\n{\r\nstruct smm_regs regs = { .eax = req_fn, };\r\nint rc;\r\nif ((rc = i8k_smm(&regs)) < 0)\r\nreturn rc;\r\nreturn regs.eax == 1145651527 && regs.edx == 1145392204 ? 0 : -1;\r\n}\r\nstatic int\r\ni8k_ioctl_unlocked(struct file *fp, unsigned int cmd, unsigned long arg)\r\n{\r\nint val = 0;\r\nint speed;\r\nunsigned char buff[16];\r\nint __user *argp = (int __user *)arg;\r\nif (!argp)\r\nreturn -EINVAL;\r\nswitch (cmd) {\r\ncase I8K_BIOS_VERSION:\r\nval = i8k_get_bios_version();\r\nbreak;\r\ncase I8K_MACHINE_ID:\r\nmemset(buff, 0, 16);\r\nstrlcpy(buff, i8k_get_dmi_data(DMI_PRODUCT_SERIAL), sizeof(buff));\r\nbreak;\r\ncase I8K_FN_STATUS:\r\nval = i8k_get_fn_status();\r\nbreak;\r\ncase I8K_POWER_STATUS:\r\nval = i8k_get_power_status();\r\nbreak;\r\ncase I8K_GET_TEMP:\r\nval = i8k_get_temp(0);\r\nbreak;\r\ncase I8K_GET_SPEED:\r\nif (copy_from_user(&val, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nval = i8k_get_fan_speed(val);\r\nbreak;\r\ncase I8K_GET_FAN:\r\nif (copy_from_user(&val, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nval = i8k_get_fan_status(val);\r\nbreak;\r\ncase I8K_SET_FAN:\r\nif (restricted && !capable(CAP_SYS_ADMIN))\r\nreturn -EPERM;\r\nif (copy_from_user(&val, argp, sizeof(int)))\r\nreturn -EFAULT;\r\nif (copy_from_user(&speed, argp + 1, sizeof(int)))\r\nreturn -EFAULT;\r\nval = i8k_set_fan(val, speed);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nif (val < 0)\r\nreturn val;\r\nswitch (cmd) {\r\ncase I8K_BIOS_VERSION:\r\nif (copy_to_user(argp, &val, 4))\r\nreturn -EFAULT;\r\nbreak;\r\ncase I8K_MACHINE_ID:\r\nif (copy_to_user(argp, buff, 16))\r\nreturn -EFAULT;\r\nbreak;\r\ndefault:\r\nif (copy_to_user(argp, &val, sizeof(int)))\r\nreturn -EFAULT;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic long i8k_ioctl(struct file *fp, unsigned int cmd, unsigned long arg)\r\n{\r\nlong ret;\r\nmutex_lock(&i8k_mutex);\r\nret = i8k_ioctl_unlocked(fp, cmd, arg);\r\nmutex_unlock(&i8k_mutex);\r\nreturn ret;\r\n}\r\nstatic int i8k_proc_show(struct seq_file *seq, void *offset)\r\n{\r\nint fn_key, cpu_temp, ac_power;\r\nint left_fan, right_fan, left_speed, right_speed;\r\ncpu_temp = i8k_get_temp(0);\r\nleft_fan = i8k_get_fan_status(I8K_FAN_LEFT);\r\nright_fan = i8k_get_fan_status(I8K_FAN_RIGHT);\r\nleft_speed = i8k_get_fan_speed(I8K_FAN_LEFT);\r\nright_speed = i8k_get_fan_speed(I8K_FAN_RIGHT);\r\nfn_key = i8k_get_fn_status();\r\nif (power_status)\r\nac_power = i8k_get_power_status();\r\nelse\r\nac_power = -1;\r\nreturn seq_printf(seq, "%s %s %s %d %d %d %d %d %d %d\n",\r\nI8K_PROC_FMT,\r\nbios_version,\r\ni8k_get_dmi_data(DMI_PRODUCT_SERIAL),\r\ncpu_temp,\r\nleft_fan, right_fan, left_speed, right_speed,\r\nac_power, fn_key);\r\n}\r\nstatic int i8k_open_fs(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, i8k_proc_show, NULL);\r\n}\r\nstatic ssize_t i8k_hwmon_show_temp(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint cpu_temp;\r\ncpu_temp = i8k_get_temp(0);\r\nif (cpu_temp < 0)\r\nreturn cpu_temp;\r\nreturn sprintf(buf, "%d\n", cpu_temp * 1000);\r\n}\r\nstatic ssize_t i8k_hwmon_show_fan(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nint fan_speed;\r\nfan_speed = i8k_get_fan_speed(index);\r\nif (fan_speed < 0)\r\nreturn fan_speed;\r\nreturn sprintf(buf, "%d\n", fan_speed);\r\n}\r\nstatic ssize_t i8k_hwmon_show_label(struct device *dev,\r\nstruct device_attribute *devattr,\r\nchar *buf)\r\n{\r\nstatic const char *labels[4] = {\r\n"i8k",\r\n"CPU",\r\n"Left Fan",\r\n"Right Fan",\r\n};\r\nint index = to_sensor_dev_attr(devattr)->index;\r\nreturn sprintf(buf, "%s\n", labels[index]);\r\n}\r\nstatic void i8k_hwmon_remove_files(struct device *dev)\r\n{\r\ndevice_remove_file(dev, &dev_attr_temp1_input);\r\ndevice_remove_file(dev, &sensor_dev_attr_fan1_input.dev_attr);\r\ndevice_remove_file(dev, &sensor_dev_attr_fan2_input.dev_attr);\r\ndevice_remove_file(dev, &sensor_dev_attr_temp1_label.dev_attr);\r\ndevice_remove_file(dev, &sensor_dev_attr_fan1_label.dev_attr);\r\ndevice_remove_file(dev, &sensor_dev_attr_fan2_label.dev_attr);\r\ndevice_remove_file(dev, &sensor_dev_attr_name.dev_attr);\r\n}\r\nstatic int __init i8k_init_hwmon(void)\r\n{\r\nint err;\r\ni8k_hwmon_dev = hwmon_device_register(NULL);\r\nif (IS_ERR(i8k_hwmon_dev)) {\r\nerr = PTR_ERR(i8k_hwmon_dev);\r\ni8k_hwmon_dev = NULL;\r\nprintk(KERN_ERR "i8k: hwmon registration failed (%d)\n", err);\r\nreturn err;\r\n}\r\nerr = device_create_file(i8k_hwmon_dev,\r\n&sensor_dev_attr_name.dev_attr);\r\nif (err)\r\ngoto exit_unregister;\r\nerr = i8k_get_temp(0);\r\nif (err < 0) {\r\ndev_dbg(i8k_hwmon_dev,\r\n"Not creating temperature attributes (%d)\n", err);\r\n} else {\r\nerr = device_create_file(i8k_hwmon_dev, &dev_attr_temp1_input);\r\nif (err)\r\ngoto exit_remove_files;\r\nerr = device_create_file(i8k_hwmon_dev,\r\n&sensor_dev_attr_temp1_label.dev_attr);\r\nif (err)\r\ngoto exit_remove_files;\r\n}\r\nerr = i8k_get_fan_status(I8K_FAN_LEFT);\r\nif (err < 0) {\r\ndev_dbg(i8k_hwmon_dev,\r\n"Not creating %s fan attributes (%d)\n", "left", err);\r\n} else {\r\nerr = device_create_file(i8k_hwmon_dev,\r\n&sensor_dev_attr_fan1_input.dev_attr);\r\nif (err)\r\ngoto exit_remove_files;\r\nerr = device_create_file(i8k_hwmon_dev,\r\n&sensor_dev_attr_fan1_label.dev_attr);\r\nif (err)\r\ngoto exit_remove_files;\r\n}\r\nerr = i8k_get_fan_status(I8K_FAN_RIGHT);\r\nif (err < 0) {\r\ndev_dbg(i8k_hwmon_dev,\r\n"Not creating %s fan attributes (%d)\n", "right", err);\r\n} else {\r\nerr = device_create_file(i8k_hwmon_dev,\r\n&sensor_dev_attr_fan2_input.dev_attr);\r\nif (err)\r\ngoto exit_remove_files;\r\nerr = device_create_file(i8k_hwmon_dev,\r\n&sensor_dev_attr_fan2_label.dev_attr);\r\nif (err)\r\ngoto exit_remove_files;\r\n}\r\nreturn 0;\r\nexit_remove_files:\r\ni8k_hwmon_remove_files(i8k_hwmon_dev);\r\nexit_unregister:\r\nhwmon_device_unregister(i8k_hwmon_dev);\r\nreturn err;\r\n}\r\nstatic void __exit i8k_exit_hwmon(void)\r\n{\r\ni8k_hwmon_remove_files(i8k_hwmon_dev);\r\nhwmon_device_unregister(i8k_hwmon_dev);\r\n}\r\nstatic int __init i8k_probe(void)\r\n{\r\nchar buff[4];\r\nint version;\r\nif (!dmi_check_system(i8k_dmi_table)) {\r\nif (!ignore_dmi && !force)\r\nreturn -ENODEV;\r\nprintk(KERN_INFO "i8k: not running on a supported Dell system.\n");\r\nprintk(KERN_INFO "i8k: vendor=%s, model=%s, version=%s\n",\r\ni8k_get_dmi_data(DMI_SYS_VENDOR),\r\ni8k_get_dmi_data(DMI_PRODUCT_NAME),\r\ni8k_get_dmi_data(DMI_BIOS_VERSION));\r\n}\r\nstrlcpy(bios_version, i8k_get_dmi_data(DMI_BIOS_VERSION), sizeof(bios_version));\r\nif (i8k_get_dell_signature(I8K_SMM_GET_DELL_SIG1) &&\r\ni8k_get_dell_signature(I8K_SMM_GET_DELL_SIG2)) {\r\nprintk(KERN_ERR "i8k: unable to get SMM Dell signature\n");\r\nif (!force)\r\nreturn -ENODEV;\r\n}\r\nversion = i8k_get_bios_version();\r\nif (version <= 0) {\r\nprintk(KERN_WARNING "i8k: unable to get SMM BIOS version\n");\r\n} else {\r\nbuff[0] = (version >> 16) & 0xff;\r\nbuff[1] = (version >> 8) & 0xff;\r\nbuff[2] = (version) & 0xff;\r\nbuff[3] = '\0';\r\nif (!dmi_get_system_info(DMI_BIOS_VERSION))\r\nstrlcpy(bios_version, buff, sizeof(bios_version));\r\nif (strncmp(buff, bios_version, sizeof(bios_version)) != 0)\r\nprintk(KERN_WARNING "i8k: BIOS version mismatch: %s != %s\n",\r\nbuff, bios_version);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init i8k_init(void)\r\n{\r\nstruct proc_dir_entry *proc_i8k;\r\nint err;\r\nif (i8k_probe())\r\nreturn -ENODEV;\r\nproc_i8k = proc_create("i8k", 0, NULL, &i8k_fops);\r\nif (!proc_i8k)\r\nreturn -ENOENT;\r\nerr = i8k_init_hwmon();\r\nif (err)\r\ngoto exit_remove_proc;\r\nprintk(KERN_INFO\r\n"Dell laptop SMM driver v%s Massimo Dal Zotto (dz@debian.org)\n",\r\nI8K_VERSION);\r\nreturn 0;\r\nexit_remove_proc:\r\nremove_proc_entry("i8k", NULL);\r\nreturn err;\r\n}\r\nstatic void __exit i8k_exit(void)\r\n{\r\ni8k_exit_hwmon();\r\nremove_proc_entry("i8k", NULL);\r\n}

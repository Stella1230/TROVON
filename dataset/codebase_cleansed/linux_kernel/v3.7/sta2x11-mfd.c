static struct sta2x11_mfd *sta2x11_mfd_find(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_instance *instance;\r\nstruct sta2x11_mfd *mfd;\r\nif (!pdev && !list_empty(&sta2x11_mfd_list)) {\r\npr_warning("%s: Unspecified device, "\r\n"using first instance\n", __func__);\r\nreturn list_entry(sta2x11_mfd_list.next,\r\nstruct sta2x11_mfd, list);\r\n}\r\ninstance = sta2x11_get_instance(pdev);\r\nif (!instance)\r\nreturn NULL;\r\nlist_for_each_entry(mfd, &sta2x11_mfd_list, list) {\r\nif (mfd->instance == instance)\r\nreturn mfd;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int __devinit sta2x11_mfd_add(struct pci_dev *pdev, gfp_t flags)\r\n{\r\nstruct sta2x11_mfd *mfd = sta2x11_mfd_find(pdev);\r\nstruct sta2x11_instance *instance;\r\nif (mfd)\r\nreturn -EBUSY;\r\ninstance = sta2x11_get_instance(pdev);\r\nif (!instance)\r\nreturn -EINVAL;\r\nmfd = kzalloc(sizeof(*mfd), flags);\r\nif (!mfd)\r\nreturn -ENOMEM;\r\nINIT_LIST_HEAD(&mfd->list);\r\nspin_lock_init(&mfd->lock);\r\nmfd->instance = instance;\r\nlist_add(&mfd->list, &sta2x11_mfd_list);\r\nreturn 0;\r\n}\r\nstatic int __devexit mfd_remove(struct pci_dev *pdev)\r\n{\r\nstruct sta2x11_mfd *mfd = sta2x11_mfd_find(pdev);\r\nif (!mfd)\r\nreturn -ENODEV;\r\nlist_del(&mfd->list);\r\nkfree(mfd);\r\nreturn 0;\r\n}\r\nu32 sta2x11_sctl_mask(struct pci_dev *pdev, u32 reg, u32 mask, u32 val)\r\n{\r\nstruct sta2x11_mfd *mfd = sta2x11_mfd_find(pdev);\r\nu32 r;\r\nunsigned long flags;\r\nif (!mfd) {\r\ndev_warn(&pdev->dev, ": can't access sctl regs\n");\r\nreturn 0;\r\n}\r\nif (!mfd->sctl_regs) {\r\ndev_warn(&pdev->dev, ": system ctl not initialized\n");\r\nreturn 0;\r\n}\r\nspin_lock_irqsave(&mfd->lock, flags);\r\nr = readl(mfd->sctl_regs + reg);\r\nr &= ~mask;\r\nr |= val;\r\nif (mask)\r\nwritel(r, mfd->sctl_regs + reg);\r\nspin_unlock_irqrestore(&mfd->lock, flags);\r\nreturn r;\r\n}\r\nu32 sta2x11_apbreg_mask(struct pci_dev *pdev, u32 reg, u32 mask, u32 val)\r\n{\r\nstruct sta2x11_mfd *mfd = sta2x11_mfd_find(pdev);\r\nu32 r;\r\nunsigned long flags;\r\nif (!mfd) {\r\ndev_warn(&pdev->dev, ": can't access apb regs\n");\r\nreturn 0;\r\n}\r\nif (!mfd->apbreg_regs) {\r\ndev_warn(&pdev->dev, ": apb bridge not initialized\n");\r\nreturn 0;\r\n}\r\nspin_lock_irqsave(&mfd->lock, flags);\r\nr = readl(mfd->apbreg_regs + reg);\r\nr &= ~mask;\r\nr |= val;\r\nif (mask)\r\nwritel(r, mfd->apbreg_regs + reg);\r\nspin_unlock_irqrestore(&mfd->lock, flags);\r\nreturn r;\r\n}\r\nstatic int sta2x11_sctl_probe(struct platform_device *dev)\r\n{\r\nstruct pci_dev **pdev;\r\nstruct sta2x11_mfd *mfd;\r\nstruct resource *res;\r\npdev = dev->dev.platform_data;\r\nmfd = sta2x11_mfd_find(*pdev);\r\nif (!mfd)\r\nreturn -ENODEV;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENOMEM;\r\nif (!request_mem_region(res->start, resource_size(res),\r\n"sta2x11-sctl"))\r\nreturn -EBUSY;\r\nmfd->sctl_regs = ioremap(res->start, resource_size(res));\r\nif (!mfd->sctl_regs) {\r\nrelease_mem_region(res->start, resource_size(res));\r\nreturn -ENOMEM;\r\n}\r\nsctl_regset.base = mfd->sctl_regs;\r\nsta2x11_sctl_debugfs = debugfs_create_regset32("sta2x11-sctl",\r\nS_IFREG | S_IRUGO,\r\nNULL, &sctl_regset);\r\nreturn 0;\r\n}\r\nstatic int sta2x11_apbreg_probe(struct platform_device *dev)\r\n{\r\nstruct pci_dev **pdev;\r\nstruct sta2x11_mfd *mfd;\r\nstruct resource *res;\r\npdev = dev->dev.platform_data;\r\ndev_dbg(&dev->dev, "%s: pdata is %p\n", __func__, pdev);\r\ndev_dbg(&dev->dev, "%s: *pdata is %p\n", __func__, *pdev);\r\nmfd = sta2x11_mfd_find(*pdev);\r\nif (!mfd)\r\nreturn -ENODEV;\r\nres = platform_get_resource(dev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENOMEM;\r\nif (!request_mem_region(res->start, resource_size(res),\r\n"sta2x11-apbreg"))\r\nreturn -EBUSY;\r\nmfd->apbreg_regs = ioremap(res->start, resource_size(res));\r\nif (!mfd->apbreg_regs) {\r\nrelease_mem_region(res->start, resource_size(res));\r\nreturn -ENOMEM;\r\n}\r\ndev_dbg(&dev->dev, "%s: regbase %p\n", __func__, mfd->apbreg_regs);\r\napbreg_regset.base = mfd->apbreg_regs;\r\nsta2x11_apbreg_debugfs = debugfs_create_regset32("sta2x11-apbreg",\r\nS_IFREG | S_IRUGO,\r\nNULL, &apbreg_regset);\r\nreturn 0;\r\n}\r\nstatic int __init sta2x11_sctl_init(void)\r\n{\r\npr_info("%s\n", __func__);\r\nreturn platform_driver_register(&sta2x11_sctl_platform_driver);\r\n}\r\nstatic int __init sta2x11_apbreg_init(void)\r\n{\r\npr_info("%s\n", __func__);\r\nreturn platform_driver_register(&sta2x11_platform_driver);\r\n}\r\nstatic int sta2x11_mfd_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_set_power_state(pdev, pci_choose_state(pdev, state));\r\nreturn 0;\r\n}\r\nstatic int sta2x11_mfd_resume(struct pci_dev *pdev)\r\n{\r\nint err;\r\npci_set_power_state(pdev, 0);\r\nerr = pci_enable_device(pdev);\r\nif (err)\r\nreturn err;\r\npci_restore_state(pdev);\r\nreturn 0;\r\n}\r\nstatic int __devinit sta2x11_mfd_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nint err, i;\r\nstruct sta2x11_gpio_pdata *gpio_data;\r\ndev_info(&pdev->dev, "%s\n", __func__);\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Can't enable device.\n");\r\nreturn err;\r\n}\r\nerr = pci_enable_msi(pdev);\r\nif (err)\r\ndev_info(&pdev->dev, "Enable msi failed\n");\r\ngpio_data = dev_get_platdata(&pdev->dev);\r\nif (!gpio_data)\r\ndev_warn(&pdev->dev, "no gpio configuration\n");\r\ndev_dbg(&pdev->dev, "%s, gpio_data = %p (%p)\n", __func__,\r\ngpio_data, &gpio_data);\r\ndev_dbg(&pdev->dev, "%s, pdev = %p (%p)\n", __func__,\r\npdev, &pdev);\r\nfor (i = 0; i < ARRAY_SIZE(sta2x11_mfd_bar0); i++) {\r\nsta2x11_mfd_bar0[i].pdata_size = sizeof(pdev);\r\nsta2x11_mfd_bar0[i].platform_data = &pdev;\r\n}\r\nsta2x11_mfd_bar1[0].pdata_size = sizeof(pdev);\r\nsta2x11_mfd_bar1[0].platform_data = &pdev;\r\nsta2x11_mfd_add(pdev, GFP_ATOMIC);\r\nerr = mfd_add_devices(&pdev->dev, -1,\r\nsta2x11_mfd_bar0,\r\nARRAY_SIZE(sta2x11_mfd_bar0),\r\n&pdev->resource[0],\r\n0, NULL);\r\nif (err) {\r\ndev_err(&pdev->dev, "mfd_add_devices[0] failed: %d\n", err);\r\ngoto err_disable;\r\n}\r\nerr = mfd_add_devices(&pdev->dev, -1,\r\nsta2x11_mfd_bar1,\r\nARRAY_SIZE(sta2x11_mfd_bar1),\r\n&pdev->resource[1],\r\n0, NULL);\r\nif (err) {\r\ndev_err(&pdev->dev, "mfd_add_devices[1] failed: %d\n", err);\r\ngoto err_disable;\r\n}\r\nreturn 0;\r\nerr_disable:\r\nmfd_remove_devices(&pdev->dev);\r\npci_disable_device(pdev);\r\npci_disable_msi(pdev);\r\nreturn err;\r\n}\r\nstatic int __init sta2x11_mfd_init(void)\r\n{\r\npr_info("%s\n", __func__);\r\nreturn pci_register_driver(&sta2x11_mfd_driver);\r\n}

void rt2x00lib_config_intf(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00_intf *intf,\r\nenum nl80211_iftype type,\r\nconst u8 *mac, const u8 *bssid)\r\n{\r\nstruct rt2x00intf_conf conf;\r\nunsigned int flags = 0;\r\nconf.type = type;\r\nswitch (type) {\r\ncase NL80211_IFTYPE_ADHOC:\r\nconf.sync = TSF_SYNC_ADHOC;\r\nbreak;\r\ncase NL80211_IFTYPE_AP:\r\ncase NL80211_IFTYPE_MESH_POINT:\r\ncase NL80211_IFTYPE_WDS:\r\nconf.sync = TSF_SYNC_AP_NONE;\r\nbreak;\r\ncase NL80211_IFTYPE_STATION:\r\nconf.sync = TSF_SYNC_INFRA;\r\nbreak;\r\ndefault:\r\nconf.sync = TSF_SYNC_NONE;\r\nbreak;\r\n}\r\nmemset(conf.mac, 0, sizeof(conf.mac));\r\nif (mac)\r\nmemcpy(conf.mac, mac, ETH_ALEN);\r\nmemset(conf.bssid, 0, sizeof(conf.bssid));\r\nif (bssid)\r\nmemcpy(conf.bssid, bssid, ETH_ALEN);\r\nflags |= CONFIG_UPDATE_TYPE;\r\nif (mac || (!rt2x00dev->intf_ap_count && !rt2x00dev->intf_sta_count))\r\nflags |= CONFIG_UPDATE_MAC;\r\nif (bssid || (!rt2x00dev->intf_ap_count && !rt2x00dev->intf_sta_count))\r\nflags |= CONFIG_UPDATE_BSSID;\r\nrt2x00dev->ops->lib->config_intf(rt2x00dev, intf, &conf, flags);\r\n}\r\nvoid rt2x00lib_config_erp(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00_intf *intf,\r\nstruct ieee80211_bss_conf *bss_conf,\r\nu32 changed)\r\n{\r\nstruct rt2x00lib_erp erp;\r\nmemset(&erp, 0, sizeof(erp));\r\nerp.short_preamble = bss_conf->use_short_preamble;\r\nerp.cts_protection = bss_conf->use_cts_prot;\r\nerp.slot_time = bss_conf->use_short_slot ? SHORT_SLOT_TIME : SLOT_TIME;\r\nerp.sifs = SIFS;\r\nerp.pifs = bss_conf->use_short_slot ? SHORT_PIFS : PIFS;\r\nerp.difs = bss_conf->use_short_slot ? SHORT_DIFS : DIFS;\r\nerp.eifs = bss_conf->use_short_slot ? SHORT_EIFS : EIFS;\r\nerp.basic_rates = bss_conf->basic_rates;\r\nerp.beacon_int = bss_conf->beacon_int;\r\nrt2x00dev->aid = bss_conf->assoc ? bss_conf->aid : 0;\r\nrt2x00dev->last_beacon = bss_conf->sync_tsf;\r\nrt2x00dev->beacon_int = bss_conf->beacon_int;\r\nif (changed & BSS_CHANGED_HT)\r\nerp.ht_opmode = bss_conf->ht_operation_mode;\r\nrt2x00dev->ops->lib->config_erp(rt2x00dev, &erp, changed);\r\n}\r\nvoid rt2x00lib_config_antenna(struct rt2x00_dev *rt2x00dev,\r\nstruct antenna_setup config)\r\n{\r\nstruct link_ant *ant = &rt2x00dev->link.ant;\r\nstruct antenna_setup *def = &rt2x00dev->default_ant;\r\nstruct antenna_setup *active = &rt2x00dev->link.ant.active;\r\nif (!(ant->flags & ANTENNA_RX_DIVERSITY)) {\r\nif (config.rx == ANTENNA_SW_DIVERSITY) {\r\nant->flags |= ANTENNA_RX_DIVERSITY;\r\nif (def->rx == ANTENNA_SW_DIVERSITY)\r\nconfig.rx = ANTENNA_B;\r\nelse\r\nconfig.rx = def->rx;\r\n}\r\n} else if (config.rx == ANTENNA_SW_DIVERSITY)\r\nconfig.rx = active->rx;\r\nif (!(ant->flags & ANTENNA_TX_DIVERSITY)) {\r\nif (config.tx == ANTENNA_SW_DIVERSITY) {\r\nant->flags |= ANTENNA_TX_DIVERSITY;\r\nif (def->tx == ANTENNA_SW_DIVERSITY)\r\nconfig.tx = ANTENNA_B;\r\nelse\r\nconfig.tx = def->tx;\r\n}\r\n} else if (config.tx == ANTENNA_SW_DIVERSITY)\r\nconfig.tx = active->tx;\r\nif (test_bit(DEVICE_STATE_ENABLED_RADIO, &rt2x00dev->flags))\r\nrt2x00queue_stop_queue(rt2x00dev->rx);\r\nrt2x00dev->ops->lib->config_ant(rt2x00dev, &config);\r\nrt2x00link_reset_tuner(rt2x00dev, true);\r\nmemcpy(active, &config, sizeof(config));\r\nif (test_bit(DEVICE_STATE_ENABLED_RADIO, &rt2x00dev->flags))\r\nrt2x00queue_start_queue(rt2x00dev->rx);\r\n}\r\nstatic u16 rt2x00ht_center_channel(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf)\r\n{\r\nstruct hw_mode_spec *spec = &rt2x00dev->spec;\r\nint center_channel;\r\nu16 i;\r\ncenter_channel = spec->channels[conf->channel->hw_value].channel;\r\nif (conf_is_ht40_plus(conf))\r\ncenter_channel += 2;\r\nelse if (conf_is_ht40_minus(conf))\r\ncenter_channel -= (center_channel == 14) ? 1 : 2;\r\nfor (i = 0; i < spec->num_channels; i++)\r\nif (spec->channels[i].channel == center_channel)\r\nreturn i;\r\nWARN_ON(1);\r\nreturn conf->channel->hw_value;\r\n}\r\nvoid rt2x00lib_config(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nunsigned int ieee80211_flags)\r\n{\r\nstruct rt2x00lib_conf libconf;\r\nu16 hw_value;\r\nu16 autowake_timeout;\r\nu16 beacon_int;\r\nu16 beacon_diff;\r\nmemset(&libconf, 0, sizeof(libconf));\r\nlibconf.conf = conf;\r\nif (ieee80211_flags & IEEE80211_CONF_CHANGE_CHANNEL) {\r\nif (!conf_is_ht(conf))\r\nset_bit(CONFIG_HT_DISABLED, &rt2x00dev->flags);\r\nelse\r\nclear_bit(CONFIG_HT_DISABLED, &rt2x00dev->flags);\r\nif (conf_is_ht40(conf)) {\r\nset_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags);\r\nhw_value = rt2x00ht_center_channel(rt2x00dev, conf);\r\n} else {\r\nclear_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags);\r\nhw_value = conf->channel->hw_value;\r\n}\r\nmemcpy(&libconf.rf,\r\n&rt2x00dev->spec.channels[hw_value],\r\nsizeof(libconf.rf));\r\nmemcpy(&libconf.channel,\r\n&rt2x00dev->spec.channels_info[hw_value],\r\nsizeof(libconf.channel));\r\nrt2x00dev->rf_channel = libconf.rf.channel;\r\n}\r\nif (test_bit(REQUIRE_PS_AUTOWAKE, &rt2x00dev->cap_flags) &&\r\n(ieee80211_flags & IEEE80211_CONF_CHANGE_PS))\r\ncancel_delayed_work_sync(&rt2x00dev->autowakeup_work);\r\nrt2x00dev->ops->lib->config(rt2x00dev, &libconf, ieee80211_flags);\r\nif (ieee80211_flags & IEEE80211_CONF_CHANGE_CHANNEL)\r\nrt2x00link_reset_tuner(rt2x00dev, false);\r\nif (test_bit(DEVICE_STATE_PRESENT, &rt2x00dev->flags) &&\r\ntest_bit(REQUIRE_PS_AUTOWAKE, &rt2x00dev->cap_flags) &&\r\n(ieee80211_flags & IEEE80211_CONF_CHANGE_PS) &&\r\n(conf->flags & IEEE80211_CONF_PS)) {\r\nbeacon_diff = (long)jiffies - (long)rt2x00dev->last_beacon;\r\nbeacon_int = msecs_to_jiffies(rt2x00dev->beacon_int);\r\nif (beacon_diff > beacon_int)\r\nbeacon_diff = 0;\r\nautowake_timeout = (conf->max_sleep_period * beacon_int) - beacon_diff;\r\nqueue_delayed_work(rt2x00dev->workqueue,\r\n&rt2x00dev->autowakeup_work,\r\nautowake_timeout - 15);\r\n}\r\nif (conf->flags & IEEE80211_CONF_PS)\r\nset_bit(CONFIG_POWERSAVING, &rt2x00dev->flags);\r\nelse\r\nclear_bit(CONFIG_POWERSAVING, &rt2x00dev->flags);\r\nrt2x00dev->curr_band = conf->channel->band;\r\nrt2x00dev->curr_freq = conf->channel->center_freq;\r\nrt2x00dev->tx_power = conf->power_level;\r\nrt2x00dev->short_retry = conf->short_frame_max_tx_count;\r\nrt2x00dev->long_retry = conf->long_frame_max_tx_count;\r\n}

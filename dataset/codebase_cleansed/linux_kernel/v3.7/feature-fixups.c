static unsigned int *calc_addr(struct fixup_entry *fcur, long offset)\r\n{\r\nreturn (unsigned int *)((unsigned long)fcur + offset);\r\n}\r\nstatic int patch_alt_instruction(unsigned int *src, unsigned int *dest,\r\nunsigned int *alt_start, unsigned int *alt_end)\r\n{\r\nunsigned int instr;\r\ninstr = *src;\r\nif (instr_is_relative_branch(*src)) {\r\nunsigned int *target = (unsigned int *)branch_target(src);\r\nif (target < alt_start || target >= alt_end) {\r\ninstr = translate_branch(dest, src);\r\nif (!instr)\r\nreturn 1;\r\n}\r\n}\r\npatch_instruction(dest, instr);\r\nreturn 0;\r\n}\r\nstatic int patch_feature_section(unsigned long value, struct fixup_entry *fcur)\r\n{\r\nunsigned int *start, *end, *alt_start, *alt_end, *src, *dest;\r\nstart = calc_addr(fcur, fcur->start_off);\r\nend = calc_addr(fcur, fcur->end_off);\r\nalt_start = calc_addr(fcur, fcur->alt_start_off);\r\nalt_end = calc_addr(fcur, fcur->alt_end_off);\r\nif ((alt_end - alt_start) > (end - start))\r\nreturn 1;\r\nif ((value & fcur->mask) == fcur->value)\r\nreturn 0;\r\nsrc = alt_start;\r\ndest = start;\r\nfor (; src < alt_end; src++, dest++) {\r\nif (patch_alt_instruction(src, dest, alt_start, alt_end))\r\nreturn 1;\r\n}\r\nfor (; dest < end; dest++)\r\npatch_instruction(dest, PPC_INST_NOP);\r\nreturn 0;\r\n}\r\nvoid do_feature_fixups(unsigned long value, void *fixup_start, void *fixup_end)\r\n{\r\nstruct fixup_entry *fcur, *fend;\r\nfcur = fixup_start;\r\nfend = fixup_end;\r\nfor (; fcur < fend; fcur++) {\r\nif (patch_feature_section(value, fcur)) {\r\nWARN_ON(1);\r\nprintk("Unable to patch feature section at %p - %p" \\r\n" with %p - %p\n",\r\ncalc_addr(fcur, fcur->start_off),\r\ncalc_addr(fcur, fcur->end_off),\r\ncalc_addr(fcur, fcur->alt_start_off),\r\ncalc_addr(fcur, fcur->alt_end_off));\r\n}\r\n}\r\n}\r\nvoid do_lwsync_fixups(unsigned long value, void *fixup_start, void *fixup_end)\r\n{\r\nlong *start, *end;\r\nunsigned int *dest;\r\nif (!(value & CPU_FTR_LWSYNC))\r\nreturn ;\r\nstart = fixup_start;\r\nend = fixup_end;\r\nfor (; start < end; start++) {\r\ndest = (void *)start + *start;\r\npatch_instruction(dest, PPC_INST_LWSYNC);\r\n}\r\n}\r\nvoid do_final_fixups(void)\r\n{\r\n#if defined(CONFIG_PPC64) && defined(CONFIG_RELOCATABLE)\r\nint *src, *dest;\r\nunsigned long length;\r\nif (PHYSICAL_START == 0)\r\nreturn;\r\nsrc = (int *)(KERNELBASE + PHYSICAL_START);\r\ndest = (int *)KERNELBASE;\r\nlength = (__end_interrupts - _stext) / sizeof(int);\r\nwhile (length--) {\r\npatch_instruction(dest, *src);\r\nsrc++;\r\ndest++;\r\n}\r\n#endif\r\n}\r\nstatic long calc_offset(struct fixup_entry *entry, unsigned int *p)\r\n{\r\nreturn (unsigned long)p - (unsigned long)entry;\r\n}\r\nvoid test_basic_patching(void)\r\n{\r\nextern unsigned int ftr_fixup_test1;\r\nextern unsigned int end_ftr_fixup_test1;\r\nextern unsigned int ftr_fixup_test1_orig;\r\nextern unsigned int ftr_fixup_test1_expected;\r\nint size = &end_ftr_fixup_test1 - &ftr_fixup_test1;\r\nfixup.value = fixup.mask = 8;\r\nfixup.start_off = calc_offset(&fixup, &ftr_fixup_test1 + 1);\r\nfixup.end_off = calc_offset(&fixup, &ftr_fixup_test1 + 2);\r\nfixup.alt_start_off = fixup.alt_end_off = 0;\r\ncheck(memcmp(&ftr_fixup_test1, &ftr_fixup_test1_orig, size) == 0);\r\npatch_feature_section(8, &fixup);\r\ncheck(memcmp(&ftr_fixup_test1, &ftr_fixup_test1_orig, size) == 0);\r\npatch_feature_section(0, &fixup);\r\ncheck(memcmp(&ftr_fixup_test1, &ftr_fixup_test1_expected, size) == 0);\r\nmemcpy(&ftr_fixup_test1, &ftr_fixup_test1_orig, size);\r\ncheck(memcmp(&ftr_fixup_test1, &ftr_fixup_test1_orig, size) == 0);\r\npatch_feature_section(~8, &fixup);\r\ncheck(memcmp(&ftr_fixup_test1, &ftr_fixup_test1_expected, size) == 0);\r\n}\r\nstatic void test_alternative_patching(void)\r\n{\r\nextern unsigned int ftr_fixup_test2;\r\nextern unsigned int end_ftr_fixup_test2;\r\nextern unsigned int ftr_fixup_test2_orig;\r\nextern unsigned int ftr_fixup_test2_alt;\r\nextern unsigned int ftr_fixup_test2_expected;\r\nint size = &end_ftr_fixup_test2 - &ftr_fixup_test2;\r\nfixup.value = fixup.mask = 0xF;\r\nfixup.start_off = calc_offset(&fixup, &ftr_fixup_test2 + 1);\r\nfixup.end_off = calc_offset(&fixup, &ftr_fixup_test2 + 2);\r\nfixup.alt_start_off = calc_offset(&fixup, &ftr_fixup_test2_alt);\r\nfixup.alt_end_off = calc_offset(&fixup, &ftr_fixup_test2_alt + 1);\r\ncheck(memcmp(&ftr_fixup_test2, &ftr_fixup_test2_orig, size) == 0);\r\npatch_feature_section(0xF, &fixup);\r\ncheck(memcmp(&ftr_fixup_test2, &ftr_fixup_test2_orig, size) == 0);\r\npatch_feature_section(0, &fixup);\r\ncheck(memcmp(&ftr_fixup_test2, &ftr_fixup_test2_expected, size) == 0);\r\nmemcpy(&ftr_fixup_test2, &ftr_fixup_test2_orig, size);\r\ncheck(memcmp(&ftr_fixup_test2, &ftr_fixup_test2_orig, size) == 0);\r\npatch_feature_section(~0xF, &fixup);\r\ncheck(memcmp(&ftr_fixup_test2, &ftr_fixup_test2_expected, size) == 0);\r\n}\r\nstatic void test_alternative_case_too_big(void)\r\n{\r\nextern unsigned int ftr_fixup_test3;\r\nextern unsigned int end_ftr_fixup_test3;\r\nextern unsigned int ftr_fixup_test3_orig;\r\nextern unsigned int ftr_fixup_test3_alt;\r\nint size = &end_ftr_fixup_test3 - &ftr_fixup_test3;\r\nfixup.value = fixup.mask = 0xC;\r\nfixup.start_off = calc_offset(&fixup, &ftr_fixup_test3 + 1);\r\nfixup.end_off = calc_offset(&fixup, &ftr_fixup_test3 + 2);\r\nfixup.alt_start_off = calc_offset(&fixup, &ftr_fixup_test3_alt);\r\nfixup.alt_end_off = calc_offset(&fixup, &ftr_fixup_test3_alt + 2);\r\ncheck(memcmp(&ftr_fixup_test3, &ftr_fixup_test3_orig, size) == 0);\r\ncheck(patch_feature_section(0xF, &fixup) == 1);\r\ncheck(memcmp(&ftr_fixup_test3, &ftr_fixup_test3_orig, size) == 0);\r\ncheck(patch_feature_section(0, &fixup) == 1);\r\ncheck(memcmp(&ftr_fixup_test3, &ftr_fixup_test3_orig, size) == 0);\r\ncheck(patch_feature_section(~0xF, &fixup) == 1);\r\ncheck(memcmp(&ftr_fixup_test3, &ftr_fixup_test3_orig, size) == 0);\r\n}\r\nstatic void test_alternative_case_too_small(void)\r\n{\r\nextern unsigned int ftr_fixup_test4;\r\nextern unsigned int end_ftr_fixup_test4;\r\nextern unsigned int ftr_fixup_test4_orig;\r\nextern unsigned int ftr_fixup_test4_alt;\r\nextern unsigned int ftr_fixup_test4_expected;\r\nint size = &end_ftr_fixup_test4 - &ftr_fixup_test4;\r\nunsigned long flag;\r\nflag = 1UL << ((sizeof(unsigned long) - 1) * 8);\r\nfixup.value = fixup.mask = flag;\r\nfixup.start_off = calc_offset(&fixup, &ftr_fixup_test4 + 1);\r\nfixup.end_off = calc_offset(&fixup, &ftr_fixup_test4 + 5);\r\nfixup.alt_start_off = calc_offset(&fixup, &ftr_fixup_test4_alt);\r\nfixup.alt_end_off = calc_offset(&fixup, &ftr_fixup_test4_alt + 2);\r\ncheck(memcmp(&ftr_fixup_test4, &ftr_fixup_test4_orig, size) == 0);\r\npatch_feature_section(flag, &fixup);\r\ncheck(memcmp(&ftr_fixup_test4, &ftr_fixup_test4_orig, size) == 0);\r\npatch_feature_section(0, &fixup);\r\ncheck(memcmp(&ftr_fixup_test4, &ftr_fixup_test4_expected, size) == 0);\r\nmemcpy(&ftr_fixup_test4, &ftr_fixup_test4_orig, size);\r\ncheck(memcmp(&ftr_fixup_test4, &ftr_fixup_test4_orig, size) == 0);\r\npatch_feature_section(~flag, &fixup);\r\ncheck(memcmp(&ftr_fixup_test4, &ftr_fixup_test4_expected, size) == 0);\r\n}\r\nstatic void test_alternative_case_with_branch(void)\r\n{\r\nextern unsigned int ftr_fixup_test5;\r\nextern unsigned int end_ftr_fixup_test5;\r\nextern unsigned int ftr_fixup_test5_expected;\r\nint size = &end_ftr_fixup_test5 - &ftr_fixup_test5;\r\ncheck(memcmp(&ftr_fixup_test5, &ftr_fixup_test5_expected, size) == 0);\r\n}\r\nstatic void test_alternative_case_with_external_branch(void)\r\n{\r\nextern unsigned int ftr_fixup_test6;\r\nextern unsigned int end_ftr_fixup_test6;\r\nextern unsigned int ftr_fixup_test6_expected;\r\nint size = &end_ftr_fixup_test6 - &ftr_fixup_test6;\r\ncheck(memcmp(&ftr_fixup_test6, &ftr_fixup_test6_expected, size) == 0);\r\n}\r\nstatic void test_cpu_macros(void)\r\n{\r\nextern u8 ftr_fixup_test_FTR_macros;\r\nextern u8 ftr_fixup_test_FTR_macros_expected;\r\nunsigned long size = &ftr_fixup_test_FTR_macros_expected -\r\n&ftr_fixup_test_FTR_macros;\r\ncheck(memcmp(&ftr_fixup_test_FTR_macros,\r\n&ftr_fixup_test_FTR_macros_expected, size) == 0);\r\n}\r\nstatic void test_fw_macros(void)\r\n{\r\n#ifdef CONFIG_PPC64\r\nextern u8 ftr_fixup_test_FW_FTR_macros;\r\nextern u8 ftr_fixup_test_FW_FTR_macros_expected;\r\nunsigned long size = &ftr_fixup_test_FW_FTR_macros_expected -\r\n&ftr_fixup_test_FW_FTR_macros;\r\ncheck(memcmp(&ftr_fixup_test_FW_FTR_macros,\r\n&ftr_fixup_test_FW_FTR_macros_expected, size) == 0);\r\n#endif\r\n}\r\nstatic void test_lwsync_macros(void)\r\n{\r\nextern u8 lwsync_fixup_test;\r\nextern u8 end_lwsync_fixup_test;\r\nextern u8 lwsync_fixup_test_expected_LWSYNC;\r\nextern u8 lwsync_fixup_test_expected_SYNC;\r\nunsigned long size = &end_lwsync_fixup_test -\r\n&lwsync_fixup_test;\r\nif (cur_cpu_spec->cpu_features & CPU_FTR_LWSYNC) {\r\ncheck(memcmp(&lwsync_fixup_test,\r\n&lwsync_fixup_test_expected_LWSYNC, size) == 0);\r\n} else {\r\ncheck(memcmp(&lwsync_fixup_test,\r\n&lwsync_fixup_test_expected_SYNC, size) == 0);\r\n}\r\n}\r\nstatic int __init test_feature_fixups(void)\r\n{\r\nprintk(KERN_DEBUG "Running feature fixup self-tests ...\n");\r\ntest_basic_patching();\r\ntest_alternative_patching();\r\ntest_alternative_case_too_big();\r\ntest_alternative_case_too_small();\r\ntest_alternative_case_with_branch();\r\ntest_alternative_case_with_external_branch();\r\ntest_cpu_macros();\r\ntest_fw_macros();\r\ntest_lwsync_macros();\r\nreturn 0;\r\n}

static ssize_t show_temp(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu32 regval;\r\npci_read_config_dword(to_pci_dev(dev),\r\nREG_REPORTED_TEMPERATURE, &regval);\r\nreturn sprintf(buf, "%u\n", (regval >> 21) * 125);\r\n}\r\nstatic ssize_t show_temp_max(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "%d\n", 70 * 1000);\r\n}\r\nstatic ssize_t show_temp_crit(struct device *dev,\r\nstruct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nint show_hyst = attr->index;\r\nu32 regval;\r\nint value;\r\npci_read_config_dword(to_pci_dev(dev),\r\nREG_HARDWARE_THERMAL_CONTROL, &regval);\r\nvalue = ((regval >> 16) & 0x7f) * 500 + 52000;\r\nif (show_hyst)\r\nvalue -= ((regval >> 24) & 0xf) * 500;\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic ssize_t show_name(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nreturn sprintf(buf, "k10temp\n");\r\n}\r\nstatic bool __devinit has_erratum_319(struct pci_dev *pdev)\r\n{\r\nu32 pkg_type, reg_dram_cfg;\r\nif (boot_cpu_data.x86 != 0x10)\r\nreturn false;\r\npkg_type = cpuid_ebx(0x80000001) & CPUID_PKGTYPE_MASK;\r\nif (pkg_type == CPUID_PKGTYPE_F)\r\nreturn true;\r\nif (pkg_type != CPUID_PKGTYPE_AM2R2_AM3)\r\nreturn false;\r\npci_bus_read_config_dword(pdev->bus,\r\nPCI_DEVFN(PCI_SLOT(pdev->devfn), 2),\r\nREG_DCT0_CONFIG_HIGH, &reg_dram_cfg);\r\nif (reg_dram_cfg & DDR3_MODE)\r\nreturn false;\r\nreturn boot_cpu_data.x86_model < 4 ||\r\n(boot_cpu_data.x86_model == 4 && boot_cpu_data.x86_mask <= 2);\r\n}\r\nstatic int __devinit k10temp_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nstruct device *hwmon_dev;\r\nu32 reg_caps, reg_htc;\r\nint unreliable = has_erratum_319(pdev);\r\nint err;\r\nif (unreliable && !force) {\r\ndev_err(&pdev->dev,\r\n"unreliable CPU thermal sensor; monitoring disabled\n");\r\nerr = -ENODEV;\r\ngoto exit;\r\n}\r\nerr = device_create_file(&pdev->dev, &dev_attr_temp1_input);\r\nif (err)\r\ngoto exit;\r\nerr = device_create_file(&pdev->dev, &dev_attr_temp1_max);\r\nif (err)\r\ngoto exit_remove;\r\npci_read_config_dword(pdev, REG_NORTHBRIDGE_CAPABILITIES, &reg_caps);\r\npci_read_config_dword(pdev, REG_HARDWARE_THERMAL_CONTROL, &reg_htc);\r\nif ((reg_caps & NB_CAP_HTC) && (reg_htc & HTC_ENABLE)) {\r\nerr = device_create_file(&pdev->dev,\r\n&sensor_dev_attr_temp1_crit.dev_attr);\r\nif (err)\r\ngoto exit_remove;\r\nerr = device_create_file(&pdev->dev,\r\n&sensor_dev_attr_temp1_crit_hyst.dev_attr);\r\nif (err)\r\ngoto exit_remove;\r\n}\r\nerr = device_create_file(&pdev->dev, &dev_attr_name);\r\nif (err)\r\ngoto exit_remove;\r\nhwmon_dev = hwmon_device_register(&pdev->dev);\r\nif (IS_ERR(hwmon_dev)) {\r\nerr = PTR_ERR(hwmon_dev);\r\ngoto exit_remove;\r\n}\r\npci_set_drvdata(pdev, hwmon_dev);\r\nif (unreliable && force)\r\ndev_warn(&pdev->dev,\r\n"unreliable CPU thermal sensor; check erratum 319\n");\r\nreturn 0;\r\nexit_remove:\r\ndevice_remove_file(&pdev->dev, &dev_attr_name);\r\ndevice_remove_file(&pdev->dev, &dev_attr_temp1_input);\r\ndevice_remove_file(&pdev->dev, &dev_attr_temp1_max);\r\ndevice_remove_file(&pdev->dev,\r\n&sensor_dev_attr_temp1_crit.dev_attr);\r\ndevice_remove_file(&pdev->dev,\r\n&sensor_dev_attr_temp1_crit_hyst.dev_attr);\r\nexit:\r\nreturn err;\r\n}\r\nstatic void __devexit k10temp_remove(struct pci_dev *pdev)\r\n{\r\nhwmon_device_unregister(pci_get_drvdata(pdev));\r\ndevice_remove_file(&pdev->dev, &dev_attr_name);\r\ndevice_remove_file(&pdev->dev, &dev_attr_temp1_input);\r\ndevice_remove_file(&pdev->dev, &dev_attr_temp1_max);\r\ndevice_remove_file(&pdev->dev,\r\n&sensor_dev_attr_temp1_crit.dev_attr);\r\ndevice_remove_file(&pdev->dev,\r\n&sensor_dev_attr_temp1_crit_hyst.dev_attr);\r\npci_set_drvdata(pdev, NULL);\r\n}

int EEPROMRead(unsigned int pos, unsigned char *data, int len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++)\r\n*data++ = at93c_read(pos++);\r\nreturn 0;\r\n}\r\nint EEPROMWrite(unsigned int pos, unsigned char *data, int len)\r\n{\r\nint i;\r\nfor (i = 0; i < len; i++)\r\nat93c_write(pos++, *data++);\r\nreturn 0;\r\n}\r\nstatic void init_flash_sizes(void)\r\n{\r\nunsigned long *lb = lasat_board_info.li_flashpart_base;\r\nunsigned long *ls = lasat_board_info.li_flashpart_size;\r\nint i;\r\nls[LASAT_MTD_BOOTLOADER] = 0x40000;\r\nls[LASAT_MTD_SERVICE] = 0xC0000;\r\nls[LASAT_MTD_NORMAL] = 0x100000;\r\nif (!IS_LASAT_200()) {\r\nlasat_board_info.li_flash_base = 0x1e000000;\r\nlb[LASAT_MTD_BOOTLOADER] = 0x1e400000;\r\nif (lasat_board_info.li_flash_size > 0x200000) {\r\nls[LASAT_MTD_CONFIG] = 0x100000;\r\nls[LASAT_MTD_FS] = 0x500000;\r\n}\r\n} else {\r\nlasat_board_info.li_flash_base = 0x10000000;\r\nif (lasat_board_info.li_flash_size < 0x1000000) {\r\nlb[LASAT_MTD_BOOTLOADER] = 0x10000000;\r\nls[LASAT_MTD_CONFIG] = 0x100000;\r\nif (lasat_board_info.li_flash_size >= 0x400000)\r\nls[LASAT_MTD_FS] =\r\nlasat_board_info.li_flash_size - 0x300000;\r\n}\r\n}\r\nfor (i = 1; i < LASAT_MTD_LAST; i++)\r\nlb[i] = lb[i-1] + ls[i-1];\r\n}\r\nint lasat_init_board_info(void)\r\n{\r\nint c;\r\nunsigned long crc;\r\nunsigned long cfg0, cfg1;\r\nconst struct product_info *ppi;\r\nint i_n_base_models = N_BASE_MODELS;\r\nconst char * const * i_txt_base_models = txt_base_models;\r\nint i_n_prids = N_PRIDS;\r\nmemset(&lasat_board_info, 0, sizeof(lasat_board_info));\r\nEEPROMRead(0, (unsigned char *)&lasat_board_info.li_eeprom_info,\r\nsizeof(struct lasat_eeprom_struct));\r\ncrc = EEPROM_CRC((unsigned char *)(&lasat_board_info.li_eeprom_info),\r\nsizeof(struct lasat_eeprom_struct) - 4);\r\nif (crc != lasat_board_info.li_eeprom_info.crc32) {\r\nprintk(KERN_WARNING "WARNING...\nWARNING...\nEEPROM CRC does "\r\n"not match calculated, attempting to soldier on...\n");\r\n}\r\nif (lasat_board_info.li_eeprom_info.version != LASAT_EEPROM_VERSION) {\r\nprintk(KERN_WARNING "WARNING...\nWARNING...\nEEPROM version "\r\n"%d, wanted version %d, attempting to soldier on...\n",\r\n(unsigned int)lasat_board_info.li_eeprom_info.version,\r\nLASAT_EEPROM_VERSION);\r\n}\r\ncfg0 = lasat_board_info.li_eeprom_info.cfg[0];\r\ncfg1 = lasat_board_info.li_eeprom_info.cfg[1];\r\nif (LASAT_W0_DSCTYPE(cfg0) != 1) {\r\nprintk(KERN_WARNING "WARNING...\nWARNING...\n"\r\n"Invalid configuration read from EEPROM, attempting to "\r\n"soldier on...");\r\n}\r\nswitch (LASAT_W0_SDRAMBANKSZ(cfg0)) {\r\ncase 0:\r\nlasat_board_info.li_memsize = 0x0800000;\r\nbreak;\r\ncase 1:\r\nlasat_board_info.li_memsize = 0x1000000;\r\nbreak;\r\ncase 2:\r\nlasat_board_info.li_memsize = 0x2000000;\r\nbreak;\r\ncase 3:\r\nlasat_board_info.li_memsize = 0x4000000;\r\nbreak;\r\ncase 4:\r\nlasat_board_info.li_memsize = 0x8000000;\r\nbreak;\r\ndefault:\r\nlasat_board_info.li_memsize = 0;\r\n}\r\nswitch (LASAT_W0_SDRAMBANKS(cfg0)) {\r\ncase 0:\r\nbreak;\r\ncase 1:\r\nlasat_board_info.li_memsize *= 2;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (LASAT_W0_BUSSPEED(cfg0)) {\r\ncase 0x0:\r\nlasat_board_info.li_bus_hz = 60000000;\r\nbreak;\r\ncase 0x1:\r\nlasat_board_info.li_bus_hz = 66000000;\r\nbreak;\r\ncase 0x2:\r\nlasat_board_info.li_bus_hz = 66666667;\r\nbreak;\r\ncase 0x3:\r\nlasat_board_info.li_bus_hz = 80000000;\r\nbreak;\r\ncase 0x4:\r\nlasat_board_info.li_bus_hz = 83333333;\r\nbreak;\r\ncase 0x5:\r\nlasat_board_info.li_bus_hz = 100000000;\r\nbreak;\r\n}\r\nswitch (LASAT_W0_CPUCLK(cfg0)) {\r\ncase 0x0:\r\nlasat_board_info.li_cpu_hz =\r\nlasat_board_info.li_bus_hz;\r\nbreak;\r\ncase 0x1:\r\nlasat_board_info.li_cpu_hz =\r\nlasat_board_info.li_bus_hz +\r\n(lasat_board_info.li_bus_hz >> 1);\r\nbreak;\r\ncase 0x2:\r\nlasat_board_info.li_cpu_hz =\r\nlasat_board_info.li_bus_hz +\r\nlasat_board_info.li_bus_hz;\r\nbreak;\r\ncase 0x3:\r\nlasat_board_info.li_cpu_hz =\r\nlasat_board_info.li_bus_hz +\r\nlasat_board_info.li_bus_hz +\r\n(lasat_board_info.li_bus_hz >> 1);\r\nbreak;\r\ncase 0x4:\r\nlasat_board_info.li_cpu_hz =\r\nlasat_board_info.li_bus_hz +\r\nlasat_board_info.li_bus_hz +\r\nlasat_board_info.li_bus_hz;\r\nbreak;\r\n}\r\nswitch (LASAT_W1_FLASHSIZE(cfg1)) {\r\ncase 0:\r\nlasat_board_info.li_flash_size = 0x200000;\r\nbreak;\r\ncase 1:\r\nlasat_board_info.li_flash_size = 0x400000;\r\nbreak;\r\ncase 2:\r\nlasat_board_info.li_flash_size = 0x800000;\r\nbreak;\r\ncase 3:\r\nlasat_board_info.li_flash_size = 0x1000000;\r\nbreak;\r\ncase 4:\r\nlasat_board_info.li_flash_size = 0x2000000;\r\nbreak;\r\n}\r\ninit_flash_sizes();\r\nlasat_board_info.li_bmid = LASAT_W0_BMID(cfg0);\r\nlasat_board_info.li_prid = lasat_board_info.li_eeprom_info.prid;\r\nif (lasat_board_info.li_prid == 0xffff || lasat_board_info.li_prid == 0)\r\nlasat_board_info.li_prid = lasat_board_info.li_bmid;\r\nif (lasat_board_info.li_bmid > i_n_base_models)\r\nlasat_board_info.li_bmid = i_n_base_models;\r\nstrcpy(lasat_board_info.li_bmstr,\r\ni_txt_base_models[lasat_board_info.li_bmid]);\r\nc = lasat_board_info.li_prid;\r\nif (c >= i_n_prids) {\r\nstrcpy(lasat_board_info.li_namestr, "Unknown Model");\r\nstrcpy(lasat_board_info.li_typestr, "Unknown Type");\r\n} else {\r\nppi = &vendor_info_table[0].vi_product_info[c];\r\nstrcpy(lasat_board_info.li_namestr, ppi->pi_name);\r\nif (ppi->pi_type)\r\nstrcpy(lasat_board_info.li_typestr, ppi->pi_type);\r\nelse\r\nsprintf(lasat_board_info.li_typestr, "%d", 10 * c);\r\n}\r\nreturn 0;\r\n}\r\nvoid lasat_write_eeprom_info(void)\r\n{\r\nunsigned long crc;\r\nmutex_lock(&lasat_eeprom_mutex);\r\ncrc = EEPROM_CRC((unsigned char *)(&lasat_board_info.li_eeprom_info),\r\nsizeof(struct lasat_eeprom_struct) - 4);\r\nlasat_board_info.li_eeprom_info.crc32 = crc;\r\nEEPROMWrite(0, (unsigned char *)&lasat_board_info.li_eeprom_info,\r\nsizeof(struct lasat_eeprom_struct));\r\nmutex_unlock(&lasat_eeprom_mutex);\r\n}

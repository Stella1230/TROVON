void __init ioremap_fixed_init(void)\r\n{\r\nstruct ioremap_map *map;\r\nint i;\r\nfor (i = 0; i < FIX_N_IOREMAPS; i++) {\r\nmap = &ioremap_maps[i];\r\nmap->fixmap_addr = __fix_to_virt(FIX_IOREMAP_BEGIN + i);\r\n}\r\n}\r\nvoid __init __iomem *\r\nioremap_fixed(phys_addr_t phys_addr, unsigned long size, pgprot_t prot)\r\n{\r\nenum fixed_addresses idx0, idx;\r\nstruct ioremap_map *map;\r\nunsigned int nrpages;\r\nunsigned long offset;\r\nint i, slot;\r\noffset = phys_addr & ~PAGE_MASK;\r\nphys_addr &= PAGE_MASK;\r\nsize = PAGE_ALIGN(phys_addr + size) - phys_addr;\r\nslot = -1;\r\nfor (i = 0; i < FIX_N_IOREMAPS; i++) {\r\nmap = &ioremap_maps[i];\r\nif (!map->addr) {\r\nmap->size = size;\r\nslot = i;\r\nbreak;\r\n}\r\n}\r\nif (slot < 0)\r\nreturn NULL;\r\nnrpages = size >> PAGE_SHIFT;\r\nif (nrpages > FIX_N_IOREMAPS)\r\nreturn NULL;\r\nidx0 = FIX_IOREMAP_BEGIN + slot;\r\nidx = idx0;\r\nwhile (nrpages > 0) {\r\npgprot_val(prot) |= _PAGE_WIRED;\r\n__set_fixmap(idx, phys_addr, prot);\r\nphys_addr += PAGE_SIZE;\r\nidx++;\r\n--nrpages;\r\n}\r\nmap->addr = (void __iomem *)(offset + map->fixmap_addr);\r\nreturn map->addr;\r\n}\r\nint iounmap_fixed(void __iomem *addr)\r\n{\r\nenum fixed_addresses idx;\r\nstruct ioremap_map *map;\r\nunsigned int nrpages;\r\nint i, slot;\r\nslot = -1;\r\nfor (i = 0; i < FIX_N_IOREMAPS; i++) {\r\nmap = &ioremap_maps[i];\r\nif (map->addr == addr) {\r\nslot = i;\r\nbreak;\r\n}\r\n}\r\nif (slot < 0)\r\nreturn -EINVAL;\r\nnrpages = map->size >> PAGE_SHIFT;\r\nidx = FIX_IOREMAP_BEGIN + slot + nrpages - 1;\r\nwhile (nrpages > 0) {\r\n__clear_fixmap(idx, __pgprot(_PAGE_WIRED));\r\n--idx;\r\n--nrpages;\r\n}\r\nmap->size = 0;\r\nmap->addr = NULL;\r\nreturn 0;\r\n}

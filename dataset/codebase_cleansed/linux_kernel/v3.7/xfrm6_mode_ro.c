static int xfrm6_ro_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct ipv6hdr *iph;\r\nu8 *prevhdr;\r\nint hdr_len;\r\niph = ipv6_hdr(skb);\r\nhdr_len = x->type->hdr_offset(x, skb, &prevhdr);\r\nskb_set_mac_header(skb, (prevhdr - x->props.header_len) - skb->data);\r\nskb_set_network_header(skb, -x->props.header_len);\r\nskb->transport_header = skb->network_header + hdr_len;\r\n__skb_pull(skb, hdr_len);\r\nmemmove(ipv6_hdr(skb), iph, hdr_len);\r\nx->lastused = get_seconds();\r\nreturn 0;\r\n}\r\nstatic int __init xfrm6_ro_init(void)\r\n{\r\nreturn xfrm_register_mode(&xfrm6_ro_mode, AF_INET6);\r\n}\r\nstatic void __exit xfrm6_ro_exit(void)\r\n{\r\nint err;\r\nerr = xfrm_unregister_mode(&xfrm6_ro_mode, AF_INET6);\r\nBUG_ON(err);\r\n}

struct tape_class_device *register_tape_dev(\r\nstruct device * device,\r\ndev_t dev,\r\nconst struct file_operations *fops,\r\nchar * device_name,\r\nchar * mode_name)\r\n{\r\nstruct tape_class_device * tcd;\r\nint rc;\r\nchar * s;\r\ntcd = kzalloc(sizeof(struct tape_class_device), GFP_KERNEL);\r\nif (!tcd)\r\nreturn ERR_PTR(-ENOMEM);\r\nstrncpy(tcd->device_name, device_name, TAPECLASS_NAME_LEN);\r\nfor (s = strchr(tcd->device_name, '/'); s; s = strchr(s, '/'))\r\n*s = '!';\r\nstrncpy(tcd->mode_name, mode_name, TAPECLASS_NAME_LEN);\r\nfor (s = strchr(tcd->mode_name, '/'); s; s = strchr(s, '/'))\r\n*s = '!';\r\ntcd->char_device = cdev_alloc();\r\nif (!tcd->char_device) {\r\nrc = -ENOMEM;\r\ngoto fail_with_tcd;\r\n}\r\ntcd->char_device->owner = fops->owner;\r\ntcd->char_device->ops = fops;\r\ntcd->char_device->dev = dev;\r\nrc = cdev_add(tcd->char_device, tcd->char_device->dev, 1);\r\nif (rc)\r\ngoto fail_with_cdev;\r\ntcd->class_device = device_create(tape_class, device,\r\ntcd->char_device->dev, NULL,\r\n"%s", tcd->device_name);\r\nrc = IS_ERR(tcd->class_device) ? PTR_ERR(tcd->class_device) : 0;\r\nif (rc)\r\ngoto fail_with_cdev;\r\nrc = sysfs_create_link(\r\n&device->kobj,\r\n&tcd->class_device->kobj,\r\ntcd->mode_name\r\n);\r\nif (rc)\r\ngoto fail_with_class_device;\r\nreturn tcd;\r\nfail_with_class_device:\r\ndevice_destroy(tape_class, tcd->char_device->dev);\r\nfail_with_cdev:\r\ncdev_del(tcd->char_device);\r\nfail_with_tcd:\r\nkfree(tcd);\r\nreturn ERR_PTR(rc);\r\n}\r\nvoid unregister_tape_dev(struct device *device, struct tape_class_device *tcd)\r\n{\r\nif (tcd != NULL && !IS_ERR(tcd)) {\r\nsysfs_remove_link(&device->kobj, tcd->mode_name);\r\ndevice_destroy(tape_class, tcd->char_device->dev);\r\ncdev_del(tcd->char_device);\r\nkfree(tcd);\r\n}\r\n}\r\nstatic int __init tape_init(void)\r\n{\r\ntape_class = class_create(THIS_MODULE, "tape390");\r\nreturn 0;\r\n}\r\nstatic void __exit tape_exit(void)\r\n{\r\nclass_destroy(tape_class);\r\ntape_class = NULL;\r\n}

void __init paging_init(void)\r\n{\r\nunsigned long end_mem = memory_end & PAGE_MASK;\r\nunsigned long zones_size[MAX_NR_ZONES] = {0, };\r\nempty_zero_page = alloc_bootmem_pages(PAGE_SIZE);\r\nmemset(empty_zero_page, 0, PAGE_SIZE);\r\nset_fs (USER_DS);\r\nzones_size[ZONE_DMA] = (end_mem - PAGE_OFFSET) >> PAGE_SHIFT;\r\nfree_area_init(zones_size);\r\n}\r\nvoid __init mem_init(void)\r\n{\r\nint codek = 0, datak = 0, initk = 0;\r\nunsigned long tmp;\r\nunsigned long len = _ramend - _rambase;\r\nunsigned long start_mem = memory_start;\r\nunsigned long end_mem = memory_end;\r\npr_debug("Mem_init: start=%lx, end=%lx\n", start_mem, end_mem);\r\nend_mem &= PAGE_MASK;\r\nhigh_memory = (void *) end_mem;\r\nstart_mem = PAGE_ALIGN(start_mem);\r\nmax_mapnr = num_physpages = (((unsigned long) high_memory) - PAGE_OFFSET) >> PAGE_SHIFT;\r\ntotalram_pages = free_all_bootmem();\r\ncodek = (_etext - _stext) >> 10;\r\ndatak = (__bss_stop - _sdata) >> 10;\r\ninitk = (__init_begin - __init_end) >> 10;\r\ntmp = nr_free_pages() << PAGE_SHIFT;\r\nprintk(KERN_INFO "Memory available: %luk/%luk RAM, (%dk kernel code, %dk data)\n",\r\ntmp >> 10,\r\nlen >> 10,\r\ncodek,\r\ndatak\r\n);\r\n}\r\nvoid free_initrd_mem(unsigned long start, unsigned long end)\r\n{\r\nint pages = 0;\r\nfor (; start < end; start += PAGE_SIZE) {\r\nClearPageReserved(virt_to_page(start));\r\ninit_page_count(virt_to_page(start));\r\nfree_page(start);\r\ntotalram_pages++;\r\npages++;\r\n}\r\npr_notice("Freeing initrd memory: %luk freed\n",\r\npages * (PAGE_SIZE / 1024));\r\n}\r\nvoid free_initmem(void)\r\n{\r\n#ifdef CONFIG_RAMKERNEL\r\nunsigned long addr;\r\naddr = PAGE_ALIGN((unsigned long) __init_begin);\r\nfor (; addr + PAGE_SIZE < ((unsigned long) __init_end); addr += PAGE_SIZE) {\r\nClearPageReserved(virt_to_page(addr));\r\ninit_page_count(virt_to_page(addr));\r\nfree_page(addr);\r\ntotalram_pages++;\r\n}\r\npr_notice("Freeing unused kernel memory: %luk freed (0x%x - 0x%x)\n",\r\n(addr - PAGE_ALIGN((unsigned long) __init_begin)) >> 10,\r\n(int)(PAGE_ALIGN((unsigned long) __init_begin)),\r\n(int)(addr - PAGE_SIZE));\r\n#endif\r\n}

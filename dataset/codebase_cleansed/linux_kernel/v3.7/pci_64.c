static int __init pcibios_init(void)\r\n{\r\nstruct pci_controller *hose, *tmp;\r\nprintk(KERN_INFO "PCI: Probing PCI hardware\n");\r\nppc_md.phys_mem_access_prot = pci_phys_mem_access_prot;\r\npci_add_flags(PCI_ENABLE_PROC_DOMAINS | PCI_COMPAT_DOMAIN_0);\r\nlist_for_each_entry_safe(hose, tmp, &hose_list, list_node) {\r\npcibios_scan_phb(hose);\r\npci_bus_add_devices(hose->bus);\r\n}\r\npcibios_resource_survey();\r\nprintk(KERN_DEBUG "PCI: Probing PCI hardware done\n");\r\nreturn 0;\r\n}\r\nint pcibios_unmap_io_space(struct pci_bus *bus)\r\n{\r\nstruct pci_controller *hose;\r\nWARN_ON(bus == NULL);\r\nif (bus->self) {\r\n#ifdef CONFIG_PPC_STD_MMU_64\r\nstruct resource *res = bus->resource[0];\r\n#endif\r\npr_debug("IO unmapping for PCI-PCI bridge %s\n",\r\npci_name(bus->self));\r\n#ifdef CONFIG_PPC_STD_MMU_64\r\n__flush_hash_table_range(&init_mm, res->start + _IO_BASE,\r\nres->end + _IO_BASE + 1);\r\n#endif\r\nreturn 0;\r\n}\r\nhose = pci_bus_to_host(bus);\r\nif (hose->io_base_alloc == 0)\r\nreturn 0;\r\npr_debug("IO unmapping for PHB %s\n", hose->dn->full_name);\r\npr_debug(" alloc=0x%p\n", hose->io_base_alloc);\r\nvunmap(hose->io_base_alloc);\r\nreturn 0;\r\n}\r\nstatic int __devinit pcibios_map_phb_io_space(struct pci_controller *hose)\r\n{\r\nstruct vm_struct *area;\r\nunsigned long phys_page;\r\nunsigned long size_page;\r\nunsigned long io_virt_offset;\r\nphys_page = _ALIGN_DOWN(hose->io_base_phys, PAGE_SIZE);\r\nsize_page = _ALIGN_UP(hose->pci_io_size, PAGE_SIZE);\r\nhose->io_base_alloc = NULL;\r\nif (hose->pci_io_size == 0 || hose->io_base_phys == 0)\r\nreturn 0;\r\narea = __get_vm_area(size_page, 0, PHB_IO_BASE, PHB_IO_END);\r\nif (area == NULL)\r\nreturn -ENOMEM;\r\nhose->io_base_alloc = area->addr;\r\nhose->io_base_virt = (void __iomem *)(area->addr +\r\nhose->io_base_phys - phys_page);\r\npr_debug("IO mapping for PHB %s\n", hose->dn->full_name);\r\npr_debug(" phys=0x%016llx, virt=0x%p (alloc=0x%p)\n",\r\nhose->io_base_phys, hose->io_base_virt, hose->io_base_alloc);\r\npr_debug(" size=0x%016llx (alloc=0x%016lx)\n",\r\nhose->pci_io_size, size_page);\r\nif (__ioremap_at(phys_page, area->addr, size_page,\r\n_PAGE_NO_CACHE | _PAGE_GUARDED) == NULL)\r\nreturn -ENOMEM;\r\nio_virt_offset = pcibios_io_space_offset(hose);\r\nhose->io_resource.start += io_virt_offset;\r\nhose->io_resource.end += io_virt_offset;\r\npr_debug(" hose->io_resource=%pR\n", &hose->io_resource);\r\nreturn 0;\r\n}\r\nint __devinit pcibios_map_io_space(struct pci_bus *bus)\r\n{\r\nWARN_ON(bus == NULL);\r\nif (bus->self) {\r\npr_debug("IO mapping for PCI-PCI bridge %s\n",\r\npci_name(bus->self));\r\npr_debug(" virt=0x%016llx...0x%016llx\n",\r\nbus->resource[0]->start + _IO_BASE,\r\nbus->resource[0]->end + _IO_BASE);\r\nreturn 0;\r\n}\r\nreturn pcibios_map_phb_io_space(pci_bus_to_host(bus));\r\n}\r\nvoid __devinit pcibios_setup_phb_io_space(struct pci_controller *hose)\r\n{\r\npcibios_map_phb_io_space(hose);\r\n}\r\nlong sys_pciconfig_iobase(long which, unsigned long in_bus,\r\nunsigned long in_devfn)\r\n{\r\nstruct pci_controller* hose;\r\nstruct list_head *ln;\r\nstruct pci_bus *bus = NULL;\r\nstruct device_node *hose_node;\r\nif (in_bus == 0 && of_machine_is_compatible("MacRISC4")) {\r\nstruct device_node *agp;\r\nagp = of_find_compatible_node(NULL, NULL, "u3-agp");\r\nif (agp)\r\nin_bus = 0xf0;\r\nof_node_put(agp);\r\n}\r\nfor (ln = pci_root_buses.next; ln != &pci_root_buses; ln = ln->next) {\r\nbus = pci_bus_b(ln);\r\nif (in_bus >= bus->number && in_bus <= bus->busn_res.end)\r\nbreak;\r\nbus = NULL;\r\n}\r\nif (bus == NULL || bus->dev.of_node == NULL)\r\nreturn -ENODEV;\r\nhose_node = bus->dev.of_node;\r\nhose = PCI_DN(hose_node)->phb;\r\nswitch (which) {\r\ncase IOBASE_BRIDGE_NUMBER:\r\nreturn (long)hose->first_busno;\r\ncase IOBASE_MEMORY:\r\nreturn (long)hose->pci_mem_offset;\r\ncase IOBASE_IO:\r\nreturn (long)hose->io_base_phys;\r\ncase IOBASE_ISA_IO:\r\nreturn (long)isa_io_base;\r\ncase IOBASE_ISA_MEM:\r\nreturn -EINVAL;\r\n}\r\nreturn -EOPNOTSUPP;\r\n}\r\nint pcibus_to_node(struct pci_bus *bus)\r\n{\r\nstruct pci_controller *phb = pci_bus_to_host(bus);\r\nreturn phb->node;\r\n}

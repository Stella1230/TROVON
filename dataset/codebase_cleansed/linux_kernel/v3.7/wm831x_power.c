static int wm831x_power_check_online(struct wm831x *wm831x, int supply,\r\nunion power_supply_propval *val)\r\n{\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_SYSTEM_STATUS);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & supply)\r\nval->intval = 1;\r\nelse\r\nval->intval = 0;\r\nreturn 0;\r\n}\r\nstatic int wm831x_power_read_voltage(struct wm831x *wm831x,\r\nenum wm831x_auxadc src,\r\nunion power_supply_propval *val)\r\n{\r\nint ret;\r\nret = wm831x_auxadc_read_uv(wm831x, src);\r\nif (ret >= 0)\r\nval->intval = ret;\r\nreturn ret;\r\n}\r\nstatic int wm831x_wall_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm831x_power *wm831x_power = dev_get_drvdata(psy->dev->parent);\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = wm831x_power_check_online(wm831x, WM831X_PWR_WALL, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = wm831x_power_read_voltage(wm831x, WM831X_AUX_WALL, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int wm831x_usb_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm831x_power *wm831x_power = dev_get_drvdata(psy->dev->parent);\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = wm831x_power_check_online(wm831x, WM831X_PWR_USB, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = wm831x_power_read_voltage(wm831x, WM831X_AUX_USB, val);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic void wm831x_battey_apply_config(struct wm831x *wm831x,\r\nstruct chg_map *map, int count, int val,\r\nint *reg, const char *name,\r\nconst char *units)\r\n{\r\nint i;\r\nfor (i = 0; i < count; i++)\r\nif (val == map[i].val)\r\nbreak;\r\nif (i == count) {\r\ndev_err(wm831x->dev, "Invalid %s %d%s\n",\r\nname, val, units);\r\n} else {\r\n*reg |= map[i].reg_val;\r\ndev_dbg(wm831x->dev, "Set %s of %d%s\n", name, val, units);\r\n}\r\n}\r\nstatic void wm831x_config_battery(struct wm831x *wm831x)\r\n{\r\nstruct wm831x_pdata *wm831x_pdata = wm831x->dev->platform_data;\r\nstruct wm831x_battery_pdata *pdata;\r\nint ret, reg1, reg2;\r\nif (!wm831x_pdata || !wm831x_pdata->battery) {\r\ndev_warn(wm831x->dev,\r\n"No battery charger configuration\n");\r\nreturn;\r\n}\r\npdata = wm831x_pdata->battery;\r\nreg1 = 0;\r\nreg2 = 0;\r\nif (!pdata->enable) {\r\ndev_info(wm831x->dev, "Battery charger disabled\n");\r\nreturn;\r\n}\r\nreg1 |= WM831X_CHG_ENA;\r\nif (pdata->off_mask)\r\nreg2 |= WM831X_CHG_OFF_MSK;\r\nif (pdata->fast_enable)\r\nreg1 |= WM831X_CHG_FAST;\r\nwm831x_battey_apply_config(wm831x, trickle_ilims,\r\nARRAY_SIZE(trickle_ilims),\r\npdata->trickle_ilim, &reg2,\r\n"trickle charge current limit", "mA");\r\nwm831x_battey_apply_config(wm831x, vsels, ARRAY_SIZE(vsels),\r\npdata->vsel, &reg2,\r\n"target voltage", "mV");\r\nwm831x_battey_apply_config(wm831x, fast_ilims, ARRAY_SIZE(fast_ilims),\r\npdata->fast_ilim, &reg2,\r\n"fast charge current limit", "mA");\r\nwm831x_battey_apply_config(wm831x, eoc_iterms, ARRAY_SIZE(eoc_iterms),\r\npdata->eoc_iterm, &reg1,\r\n"end of charge current threshold", "mA");\r\nwm831x_battey_apply_config(wm831x, chg_times, ARRAY_SIZE(chg_times),\r\npdata->timeout, &reg2,\r\n"charger timeout", "min");\r\nret = wm831x_reg_unlock(wm831x);\r\nif (ret != 0) {\r\ndev_err(wm831x->dev, "Failed to unlock registers: %d\n", ret);\r\nreturn;\r\n}\r\nret = wm831x_set_bits(wm831x, WM831X_CHARGER_CONTROL_1,\r\nWM831X_CHG_ENA_MASK |\r\nWM831X_CHG_FAST_MASK |\r\nWM831X_CHG_ITERM_MASK,\r\nreg1);\r\nif (ret != 0)\r\ndev_err(wm831x->dev, "Failed to set charger control 1: %d\n",\r\nret);\r\nret = wm831x_set_bits(wm831x, WM831X_CHARGER_CONTROL_2,\r\nWM831X_CHG_OFF_MSK |\r\nWM831X_CHG_TIME_MASK |\r\nWM831X_CHG_FAST_ILIM_MASK |\r\nWM831X_CHG_TRKL_ILIM_MASK |\r\nWM831X_CHG_VSEL_MASK,\r\nreg2);\r\nif (ret != 0)\r\ndev_err(wm831x->dev, "Failed to set charger control 2: %d\n",\r\nret);\r\nwm831x_reg_lock(wm831x);\r\n}\r\nstatic int wm831x_bat_check_status(struct wm831x *wm831x, int *status)\r\n{\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_SYSTEM_STATUS);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & WM831X_PWR_SRC_BATT) {\r\n*status = POWER_SUPPLY_STATUS_DISCHARGING;\r\nreturn 0;\r\n}\r\nret = wm831x_reg_read(wm831x, WM831X_CHARGER_STATUS);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (ret & WM831X_CHG_STATE_MASK) {\r\ncase WM831X_CHG_STATE_OFF:\r\n*status = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\nbreak;\r\ncase WM831X_CHG_STATE_TRICKLE:\r\ncase WM831X_CHG_STATE_FAST:\r\n*status = POWER_SUPPLY_STATUS_CHARGING;\r\nbreak;\r\ndefault:\r\n*status = POWER_SUPPLY_STATUS_UNKNOWN;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_bat_check_type(struct wm831x *wm831x, int *type)\r\n{\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_CHARGER_STATUS);\r\nif (ret < 0)\r\nreturn ret;\r\nswitch (ret & WM831X_CHG_STATE_MASK) {\r\ncase WM831X_CHG_STATE_TRICKLE:\r\ncase WM831X_CHG_STATE_TRICKLE_OT:\r\n*type = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nbreak;\r\ncase WM831X_CHG_STATE_FAST:\r\ncase WM831X_CHG_STATE_FAST_OT:\r\n*type = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nbreak;\r\ndefault:\r\n*type = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_bat_check_health(struct wm831x *wm831x, int *health)\r\n{\r\nint ret;\r\nret = wm831x_reg_read(wm831x, WM831X_CHARGER_STATUS);\r\nif (ret < 0)\r\nreturn ret;\r\nif (ret & WM831X_BATT_HOT_STS) {\r\n*health = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nreturn 0;\r\n}\r\nif (ret & WM831X_BATT_COLD_STS) {\r\n*health = POWER_SUPPLY_HEALTH_COLD;\r\nreturn 0;\r\n}\r\nif (ret & WM831X_BATT_OV_STS) {\r\n*health = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\nreturn 0;\r\n}\r\nswitch (ret & WM831X_CHG_STATE_MASK) {\r\ncase WM831X_CHG_STATE_TRICKLE_OT:\r\ncase WM831X_CHG_STATE_FAST_OT:\r\n*health = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nbreak;\r\ncase WM831X_CHG_STATE_DEFECTIVE:\r\n*health = POWER_SUPPLY_HEALTH_UNSPEC_FAILURE;\r\nbreak;\r\ndefault:\r\n*health = POWER_SUPPLY_HEALTH_GOOD;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wm831x_bat_get_prop(struct power_supply *psy,\r\nenum power_supply_property psp,\r\nunion power_supply_propval *val)\r\n{\r\nstruct wm831x_power *wm831x_power = dev_get_drvdata(psy->dev->parent);\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\nint ret = 0;\r\nswitch (psp) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = wm831x_bat_check_status(wm831x, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_ONLINE:\r\nret = wm831x_power_check_online(wm831x, WM831X_PWR_SRC_BATT,\r\nval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_VOLTAGE_NOW:\r\nret = wm831x_power_read_voltage(wm831x, WM831X_AUX_BATT, val);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = wm831x_bat_check_health(wm831x, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = wm831x_bat_check_type(wm831x, &val->intval);\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t wm831x_bat_irq(int irq, void *data)\r\n{\r\nstruct wm831x_power *wm831x_power = data;\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\ndev_dbg(wm831x->dev, "Battery status changed: %d\n", irq);\r\nif (wm831x_power->have_battery)\r\npower_supply_changed(&wm831x_power->battery);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wm831x_syslo_irq(int irq, void *data)\r\n{\r\nstruct wm831x_power *wm831x_power = data;\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\ndev_crit(wm831x->dev, "SYSVDD under voltage\n");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t wm831x_pwr_src_irq(int irq, void *data)\r\n{\r\nstruct wm831x_power *wm831x_power = data;\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\ndev_dbg(wm831x->dev, "Power source changed\n");\r\nif (wm831x_power->have_battery)\r\npower_supply_changed(&wm831x_power->battery);\r\npower_supply_changed(&wm831x_power->usb);\r\npower_supply_changed(&wm831x_power->wall);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic __devinit int wm831x_power_probe(struct platform_device *pdev)\r\n{\r\nstruct wm831x *wm831x = dev_get_drvdata(pdev->dev.parent);\r\nstruct wm831x_pdata *wm831x_pdata = wm831x->dev->platform_data;\r\nstruct wm831x_power *power;\r\nstruct power_supply *usb;\r\nstruct power_supply *battery;\r\nstruct power_supply *wall;\r\nint ret, irq, i;\r\npower = kzalloc(sizeof(struct wm831x_power), GFP_KERNEL);\r\nif (power == NULL)\r\nreturn -ENOMEM;\r\npower->wm831x = wm831x;\r\nplatform_set_drvdata(pdev, power);\r\nusb = &power->usb;\r\nbattery = &power->battery;\r\nwall = &power->wall;\r\nif (wm831x_pdata && wm831x_pdata->wm831x_num) {\r\nsnprintf(power->wall_name, sizeof(power->wall_name),\r\n"wm831x-wall.%d", wm831x_pdata->wm831x_num);\r\nsnprintf(power->battery_name, sizeof(power->wall_name),\r\n"wm831x-battery.%d", wm831x_pdata->wm831x_num);\r\nsnprintf(power->usb_name, sizeof(power->wall_name),\r\n"wm831x-usb.%d", wm831x_pdata->wm831x_num);\r\n} else {\r\nsnprintf(power->wall_name, sizeof(power->wall_name),\r\n"wm831x-wall");\r\nsnprintf(power->battery_name, sizeof(power->wall_name),\r\n"wm831x-battery");\r\nsnprintf(power->usb_name, sizeof(power->wall_name),\r\n"wm831x-usb");\r\n}\r\nwm831x_config_battery(wm831x);\r\nwall->name = power->wall_name;\r\nwall->type = POWER_SUPPLY_TYPE_MAINS;\r\nwall->properties = wm831x_wall_props;\r\nwall->num_properties = ARRAY_SIZE(wm831x_wall_props);\r\nwall->get_property = wm831x_wall_get_prop;\r\nret = power_supply_register(&pdev->dev, wall);\r\nif (ret)\r\ngoto err_kmalloc;\r\nusb->name = power->usb_name,\r\nusb->type = POWER_SUPPLY_TYPE_USB;\r\nusb->properties = wm831x_usb_props;\r\nusb->num_properties = ARRAY_SIZE(wm831x_usb_props);\r\nusb->get_property = wm831x_usb_get_prop;\r\nret = power_supply_register(&pdev->dev, usb);\r\nif (ret)\r\ngoto err_wall;\r\nret = wm831x_reg_read(wm831x, WM831X_CHARGER_CONTROL_1);\r\nif (ret < 0)\r\ngoto err_wall;\r\npower->have_battery = ret & WM831X_CHG_ENA;\r\nif (power->have_battery) {\r\nbattery->name = power->battery_name;\r\nbattery->properties = wm831x_bat_props;\r\nbattery->num_properties = ARRAY_SIZE(wm831x_bat_props);\r\nbattery->get_property = wm831x_bat_get_prop;\r\nbattery->use_for_apm = 1;\r\nret = power_supply_register(&pdev->dev, battery);\r\nif (ret)\r\ngoto err_usb;\r\n}\r\nirq = wm831x_irq(wm831x, platform_get_irq_byname(pdev, "SYSLO"));\r\nret = request_threaded_irq(irq, NULL, wm831x_syslo_irq,\r\nIRQF_TRIGGER_RISING, "System power low",\r\npower);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request SYSLO IRQ %d: %d\n",\r\nirq, ret);\r\ngoto err_battery;\r\n}\r\nirq = wm831x_irq(wm831x, platform_get_irq_byname(pdev, "PWR SRC"));\r\nret = request_threaded_irq(irq, NULL, wm831x_pwr_src_irq,\r\nIRQF_TRIGGER_RISING, "Power source",\r\npower);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to request PWR SRC IRQ %d: %d\n",\r\nirq, ret);\r\ngoto err_syslo;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_bat_irqs); i++) {\r\nirq = wm831x_irq(wm831x,\r\nplatform_get_irq_byname(pdev,\r\nwm831x_bat_irqs[i]));\r\nret = request_threaded_irq(irq, NULL, wm831x_bat_irq,\r\nIRQF_TRIGGER_RISING,\r\nwm831x_bat_irqs[i],\r\npower);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev,\r\n"Failed to request %s IRQ %d: %d\n",\r\nwm831x_bat_irqs[i], irq, ret);\r\ngoto err_bat_irq;\r\n}\r\n}\r\nreturn ret;\r\nerr_bat_irq:\r\nfor (; i >= 0; i--) {\r\nirq = platform_get_irq_byname(pdev, wm831x_bat_irqs[i]);\r\nfree_irq(irq, power);\r\n}\r\nirq = wm831x_irq(wm831x, platform_get_irq_byname(pdev, "PWR SRC"));\r\nfree_irq(irq, power);\r\nerr_syslo:\r\nirq = wm831x_irq(wm831x, platform_get_irq_byname(pdev, "SYSLO"));\r\nfree_irq(irq, power);\r\nerr_battery:\r\nif (power->have_battery)\r\npower_supply_unregister(battery);\r\nerr_usb:\r\npower_supply_unregister(usb);\r\nerr_wall:\r\npower_supply_unregister(wall);\r\nerr_kmalloc:\r\nkfree(power);\r\nreturn ret;\r\n}\r\nstatic __devexit int wm831x_power_remove(struct platform_device *pdev)\r\n{\r\nstruct wm831x_power *wm831x_power = platform_get_drvdata(pdev);\r\nstruct wm831x *wm831x = wm831x_power->wm831x;\r\nint irq, i;\r\nfor (i = 0; i < ARRAY_SIZE(wm831x_bat_irqs); i++) {\r\nirq = wm831x_irq(wm831x,\r\nplatform_get_irq_byname(pdev,\r\nwm831x_bat_irqs[i]));\r\nfree_irq(irq, wm831x_power);\r\n}\r\nirq = wm831x_irq(wm831x, platform_get_irq_byname(pdev, "PWR SRC"));\r\nfree_irq(irq, wm831x_power);\r\nirq = wm831x_irq(wm831x, platform_get_irq_byname(pdev, "SYSLO"));\r\nfree_irq(irq, wm831x_power);\r\nif (wm831x_power->have_battery)\r\npower_supply_unregister(&wm831x_power->battery);\r\npower_supply_unregister(&wm831x_power->wall);\r\npower_supply_unregister(&wm831x_power->usb);\r\nkfree(wm831x_power);\r\nreturn 0;\r\n}

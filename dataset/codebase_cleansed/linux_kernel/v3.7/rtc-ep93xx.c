static int ep93xx_rtc_get_swcomp(struct device *dev, unsigned short *preload,\r\nunsigned short *delete)\r\n{\r\nstruct ep93xx_rtc *ep93xx_rtc = dev->platform_data;\r\nunsigned long comp;\r\ncomp = __raw_readl(ep93xx_rtc->mmio_base + EP93XX_RTC_SWCOMP);\r\nif (preload)\r\n*preload = (comp & EP93XX_RTC_SWCOMP_INT_MASK)\r\n>> EP93XX_RTC_SWCOMP_INT_SHIFT;\r\nif (delete)\r\n*delete = (comp & EP93XX_RTC_SWCOMP_DEL_MASK)\r\n>> EP93XX_RTC_SWCOMP_DEL_SHIFT;\r\nreturn 0;\r\n}\r\nstatic int ep93xx_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct ep93xx_rtc *ep93xx_rtc = dev->platform_data;\r\nunsigned long time;\r\ntime = __raw_readl(ep93xx_rtc->mmio_base + EP93XX_RTC_DATA);\r\nrtc_time_to_tm(time, tm);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_rtc_set_mmss(struct device *dev, unsigned long secs)\r\n{\r\nstruct ep93xx_rtc *ep93xx_rtc = dev->platform_data;\r\n__raw_writel(secs + 1, ep93xx_rtc->mmio_base + EP93XX_RTC_LOAD);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nunsigned short preload, delete;\r\nep93xx_rtc_get_swcomp(dev, &preload, &delete);\r\nseq_printf(seq, "preload\t\t: %d\n", preload);\r\nseq_printf(seq, "delete\t\t: %d\n", delete);\r\nreturn 0;\r\n}\r\nstatic ssize_t ep93xx_rtc_show_comp_preload(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned short preload;\r\nep93xx_rtc_get_swcomp(dev, &preload, NULL);\r\nreturn sprintf(buf, "%d\n", preload);\r\n}\r\nstatic ssize_t ep93xx_rtc_show_comp_delete(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nunsigned short delete;\r\nep93xx_rtc_get_swcomp(dev, NULL, &delete);\r\nreturn sprintf(buf, "%d\n", delete);\r\n}\r\nstatic int __devinit ep93xx_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_rtc *ep93xx_rtc;\r\nstruct resource *res;\r\nint err;\r\nep93xx_rtc = devm_kzalloc(&pdev->dev, sizeof(*ep93xx_rtc), GFP_KERNEL);\r\nif (!ep93xx_rtc)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENXIO;\r\nif (!devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), pdev->name))\r\nreturn -EBUSY;\r\nep93xx_rtc->mmio_base = devm_ioremap(&pdev->dev, res->start,\r\nresource_size(res));\r\nif (!ep93xx_rtc->mmio_base)\r\nreturn -ENXIO;\r\npdev->dev.platform_data = ep93xx_rtc;\r\nplatform_set_drvdata(pdev, ep93xx_rtc);\r\nep93xx_rtc->rtc = rtc_device_register(pdev->name,\r\n&pdev->dev, &ep93xx_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(ep93xx_rtc->rtc)) {\r\nerr = PTR_ERR(ep93xx_rtc->rtc);\r\ngoto exit;\r\n}\r\nerr = sysfs_create_group(&pdev->dev.kobj, &ep93xx_rtc_sysfs_files);\r\nif (err)\r\ngoto fail;\r\nreturn 0;\r\nfail:\r\nrtc_device_unregister(ep93xx_rtc->rtc);\r\nexit:\r\nplatform_set_drvdata(pdev, NULL);\r\npdev->dev.platform_data = NULL;\r\nreturn err;\r\n}\r\nstatic int __devexit ep93xx_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct ep93xx_rtc *ep93xx_rtc = platform_get_drvdata(pdev);\r\nsysfs_remove_group(&pdev->dev.kobj, &ep93xx_rtc_sysfs_files);\r\nplatform_set_drvdata(pdev, NULL);\r\nrtc_device_unregister(ep93xx_rtc->rtc);\r\npdev->dev.platform_data = NULL;\r\nreturn 0;\r\n}

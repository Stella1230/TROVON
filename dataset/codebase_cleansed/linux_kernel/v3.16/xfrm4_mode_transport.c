static int xfrm4_transport_output(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nstruct iphdr *iph = ip_hdr(skb);\r\nint ihl = iph->ihl * 4;\r\nskb_set_network_header(skb, -x->props.header_len);\r\nskb->mac_header = skb->network_header +\r\noffsetof(struct iphdr, protocol);\r\nskb->transport_header = skb->network_header + ihl;\r\n__skb_pull(skb, ihl);\r\nmemmove(skb_network_header(skb), iph, ihl);\r\nreturn 0;\r\n}\r\nstatic int xfrm4_transport_input(struct xfrm_state *x, struct sk_buff *skb)\r\n{\r\nint ihl = skb->data - skb_transport_header(skb);\r\nif (skb->transport_header != skb->network_header) {\r\nmemmove(skb_transport_header(skb),\r\nskb_network_header(skb), ihl);\r\nskb->network_header = skb->transport_header;\r\n}\r\nip_hdr(skb)->tot_len = htons(skb->len + ihl);\r\nskb_reset_transport_header(skb);\r\nreturn 0;\r\n}\r\nstatic int __init xfrm4_transport_init(void)\r\n{\r\nreturn xfrm_register_mode(&xfrm4_transport_mode, AF_INET);\r\n}\r\nstatic void __exit xfrm4_transport_exit(void)\r\n{\r\nint err;\r\nerr = xfrm_unregister_mode(&xfrm4_transport_mode, AF_INET);\r\nBUG_ON(err);\r\n}

static int fb_notifier_callback(struct notifier_block *p,\r\nunsigned long event, void *data)\r\n{\r\nstruct bl_trig_notifier *n = container_of(p,\r\nstruct bl_trig_notifier, notifier);\r\nstruct led_classdev *led = n->led;\r\nstruct fb_event *fb_event = data;\r\nint *blank;\r\nint new_status;\r\nif (event != FB_EVENT_BLANK)\r\nreturn 0;\r\nblank = fb_event->data;\r\nnew_status = *blank ? BLANK : UNBLANK;\r\nif (new_status == n->old_status)\r\nreturn 0;\r\nif ((n->old_status == UNBLANK) ^ n->invert) {\r\nn->brightness = led->brightness;\r\n__led_set_brightness(led, LED_OFF);\r\n} else {\r\n__led_set_brightness(led, n->brightness);\r\n}\r\nn->old_status = new_status;\r\nreturn 0;\r\n}\r\nstatic ssize_t bl_trig_invert_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct bl_trig_notifier *n = led->trigger_data;\r\nreturn sprintf(buf, "%u\n", n->invert);\r\n}\r\nstatic ssize_t bl_trig_invert_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t num)\r\n{\r\nstruct led_classdev *led = dev_get_drvdata(dev);\r\nstruct bl_trig_notifier *n = led->trigger_data;\r\nunsigned long invert;\r\nint ret;\r\nret = kstrtoul(buf, 10, &invert);\r\nif (ret < 0)\r\nreturn ret;\r\nif (invert > 1)\r\nreturn -EINVAL;\r\nn->invert = invert;\r\nif ((n->old_status == BLANK) ^ n->invert)\r\n__led_set_brightness(led, LED_OFF);\r\nelse\r\n__led_set_brightness(led, n->brightness);\r\nreturn num;\r\n}\r\nstatic void bl_trig_activate(struct led_classdev *led)\r\n{\r\nint ret;\r\nstruct bl_trig_notifier *n;\r\nn = kzalloc(sizeof(struct bl_trig_notifier), GFP_KERNEL);\r\nled->trigger_data = n;\r\nif (!n) {\r\ndev_err(led->dev, "unable to allocate backlight trigger\n");\r\nreturn;\r\n}\r\nret = device_create_file(led->dev, &dev_attr_inverted);\r\nif (ret)\r\ngoto err_invert;\r\nn->led = led;\r\nn->brightness = led->brightness;\r\nn->old_status = UNBLANK;\r\nn->notifier.notifier_call = fb_notifier_callback;\r\nret = fb_register_client(&n->notifier);\r\nif (ret)\r\ndev_err(led->dev, "unable to register backlight trigger\n");\r\nled->activated = true;\r\nreturn;\r\nerr_invert:\r\nled->trigger_data = NULL;\r\nkfree(n);\r\n}\r\nstatic void bl_trig_deactivate(struct led_classdev *led)\r\n{\r\nstruct bl_trig_notifier *n =\r\n(struct bl_trig_notifier *) led->trigger_data;\r\nif (led->activated) {\r\ndevice_remove_file(led->dev, &dev_attr_inverted);\r\nfb_unregister_client(&n->notifier);\r\nkfree(n);\r\nled->activated = false;\r\n}\r\n}\r\nstatic int __init bl_trig_init(void)\r\n{\r\nreturn led_trigger_register(&bl_led_trigger);\r\n}\r\nstatic void __exit bl_trig_exit(void)\r\n{\r\nled_trigger_unregister(&bl_led_trigger);\r\n}

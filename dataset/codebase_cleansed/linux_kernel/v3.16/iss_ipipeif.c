static void ipipeif_print_status(struct iss_ipipeif_device *ipipeif)\r\n{\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\ndev_dbg(iss->dev, "-------------IPIPEIF Register dump-------------\n");\r\nIPIPEIF_PRINT_REGISTER(iss, CFG1);\r\nIPIPEIF_PRINT_REGISTER(iss, CFG2);\r\nISIF_PRINT_REGISTER(iss, SYNCEN);\r\nISIF_PRINT_REGISTER(iss, CADU);\r\nISIF_PRINT_REGISTER(iss, CADL);\r\nISIF_PRINT_REGISTER(iss, MODESET);\r\nISIF_PRINT_REGISTER(iss, CCOLP);\r\nISIF_PRINT_REGISTER(iss, SPH);\r\nISIF_PRINT_REGISTER(iss, LNH);\r\nISIF_PRINT_REGISTER(iss, LNV);\r\nISIF_PRINT_REGISTER(iss, VDINT(0));\r\nISIF_PRINT_REGISTER(iss, HSIZE);\r\nISP5_PRINT_REGISTER(iss, SYSCONFIG);\r\nISP5_PRINT_REGISTER(iss, CTRL);\r\nISP5_PRINT_REGISTER(iss, IRQSTATUS(0));\r\nISP5_PRINT_REGISTER(iss, IRQENABLE_SET(0));\r\nISP5_PRINT_REGISTER(iss, IRQENABLE_CLR(0));\r\ndev_dbg(iss->dev, "-----------------------------------------------\n");\r\n}\r\nstatic void ipipeif_write_enable(struct iss_ipipeif_device *ipipeif, u8 enable)\r\n{\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_SYNCEN,\r\nISIF_SYNCEN_DWEN, enable ? ISIF_SYNCEN_DWEN : 0);\r\n}\r\nstatic void ipipeif_enable(struct iss_ipipeif_device *ipipeif, u8 enable)\r\n{\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_SYNCEN,\r\nISIF_SYNCEN_SYEN, enable ? ISIF_SYNCEN_SYEN : 0);\r\n}\r\nstatic void ipipeif_set_outaddr(struct iss_ipipeif_device *ipipeif, u32 addr)\r\n{\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_CADU,\r\n(addr >> (16 + 5)) & ISIF_CADU_MASK);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_CADL,\r\n(addr >> 5) & ISIF_CADL_MASK);\r\n}\r\nstatic void ipipeif_configure(struct iss_ipipeif_device *ipipeif)\r\n{\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\nconst struct iss_format_info *info;\r\nstruct v4l2_mbus_framefmt *format;\r\nu32 isif_ccolp = 0;\r\nomap4iss_configure_bridge(iss, ipipeif->input);\r\nformat = &ipipeif->formats[IPIPEIF_PAD_SINK];\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_IPIPEIF, IPIPEIF_CFG1,\r\nIPIPEIF_CFG1_INPSRC1_MASK | IPIPEIF_CFG1_INPSRC2_MASK);\r\nswitch (format->code) {\r\ncase V4L2_MBUS_FMT_UYVY8_1X16:\r\ncase V4L2_MBUS_FMT_YUYV8_1X16:\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_MODESET,\r\nISIF_MODESET_CCDMD | ISIF_MODESET_INPMOD_MASK |\r\nISIF_MODESET_CCDW_MASK,\r\nISIF_MODESET_INPMOD_YCBCR16);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_IPIPEIF, IPIPEIF_CFG2,\r\nIPIPEIF_CFG2_YUV8, IPIPEIF_CFG2_YUV16);\r\nbreak;\r\ncase V4L2_MBUS_FMT_SGRBG10_1X10:\r\nisif_ccolp = ISIF_CCOLP_CP0_F0_GR |\r\nISIF_CCOLP_CP1_F0_R |\r\nISIF_CCOLP_CP2_F0_B |\r\nISIF_CCOLP_CP3_F0_GB;\r\ngoto cont_raw;\r\ncase V4L2_MBUS_FMT_SRGGB10_1X10:\r\nisif_ccolp = ISIF_CCOLP_CP0_F0_R |\r\nISIF_CCOLP_CP1_F0_GR |\r\nISIF_CCOLP_CP2_F0_GB |\r\nISIF_CCOLP_CP3_F0_B;\r\ngoto cont_raw;\r\ncase V4L2_MBUS_FMT_SBGGR10_1X10:\r\nisif_ccolp = ISIF_CCOLP_CP0_F0_B |\r\nISIF_CCOLP_CP1_F0_GB |\r\nISIF_CCOLP_CP2_F0_GR |\r\nISIF_CCOLP_CP3_F0_R;\r\ngoto cont_raw;\r\ncase V4L2_MBUS_FMT_SGBRG10_1X10:\r\nisif_ccolp = ISIF_CCOLP_CP0_F0_GB |\r\nISIF_CCOLP_CP1_F0_B |\r\nISIF_CCOLP_CP2_F0_R |\r\nISIF_CCOLP_CP3_F0_GR;\r\ncont_raw:\r\niss_reg_clr(iss, OMAP4_ISS_MEM_ISP_IPIPEIF, IPIPEIF_CFG2,\r\nIPIPEIF_CFG2_YUV16);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_MODESET,\r\nISIF_MODESET_CCDMD | ISIF_MODESET_INPMOD_MASK |\r\nISIF_MODESET_CCDW_MASK, ISIF_MODESET_INPMOD_RAW |\r\nISIF_MODESET_CCDW_2BIT);\r\ninfo = omap4iss_video_format_info(format->code);\r\niss_reg_update(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_CGAMMAWD,\r\nISIF_CGAMMAWD_GWDI_MASK,\r\nISIF_CGAMMAWD_GWDI(info->bpp));\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_CCOLP,\r\nisif_ccolp);\r\nbreak;\r\n}\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_SPH, 0 & ISIF_SPH_MASK);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_LNH,\r\n(format->width - 1) & ISIF_LNH_MASK);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_LNV,\r\n(format->height - 1) & ISIF_LNV_MASK);\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_VDINT(0),\r\nformat->height - 1);\r\nformat = &ipipeif->formats[IPIPEIF_PAD_SOURCE_ISIF_SF];\r\niss_reg_write(iss, OMAP4_ISS_MEM_ISP_ISIF, ISIF_HSIZE,\r\n(ipipeif->video_out.bpl_value >> 5) &\r\nISIF_HSIZE_HSIZE_MASK);\r\n}\r\nstatic void ipipeif_isr_buffer(struct iss_ipipeif_device *ipipeif)\r\n{\r\nstruct iss_buffer *buffer;\r\nif (list_empty(&ipipeif->video_out.dmaqueue))\r\nreturn;\r\nipipeif_write_enable(ipipeif, 0);\r\nbuffer = omap4iss_video_buffer_next(&ipipeif->video_out);\r\nif (buffer == NULL)\r\nreturn;\r\nipipeif_set_outaddr(ipipeif, buffer->iss_addr);\r\nipipeif_write_enable(ipipeif, 1);\r\n}\r\nstatic void ipipeif_isif0_isr(struct iss_ipipeif_device *ipipeif)\r\n{\r\nstruct iss_pipeline *pipe =\r\nto_iss_pipeline(&ipipeif->subdev.entity);\r\nif (pipe->do_propagation)\r\natomic_inc(&pipe->frame_number);\r\nif (ipipeif->output & IPIPEIF_OUTPUT_MEMORY)\r\nipipeif_isr_buffer(ipipeif);\r\n}\r\nvoid omap4iss_ipipeif_isr(struct iss_ipipeif_device *ipipeif, u32 events)\r\n{\r\nif (omap4iss_module_sync_is_stopping(&ipipeif->wait,\r\n&ipipeif->stopping))\r\nreturn;\r\nif (events & ISP5_IRQ_ISIF_INT(0))\r\nipipeif_isif0_isr(ipipeif);\r\n}\r\nstatic int ipipeif_video_queue(struct iss_video *video,\r\nstruct iss_buffer *buffer)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = container_of(video,\r\nstruct iss_ipipeif_device, video_out);\r\nif (!(ipipeif->output & IPIPEIF_OUTPUT_MEMORY))\r\nreturn -ENODEV;\r\nipipeif_set_outaddr(ipipeif, buffer->iss_addr);\r\nif (video->dmaqueue_flags & ISS_VIDEO_DMAQUEUE_UNDERRUN) {\r\nif (ipipeif->output & IPIPEIF_OUTPUT_MEMORY)\r\nipipeif_write_enable(ipipeif, 1);\r\nipipeif_enable(ipipeif, 1);\r\niss_video_dmaqueue_flags_clr(video);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ipipeif_set_stream(struct v4l2_subdev *sd, int enable)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = v4l2_get_subdevdata(sd);\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\nstruct iss_video *video_out = &ipipeif->video_out;\r\nint ret = 0;\r\nif (ipipeif->state == ISS_PIPELINE_STREAM_STOPPED) {\r\nif (enable == ISS_PIPELINE_STREAM_STOPPED)\r\nreturn 0;\r\nomap4iss_isp_subclk_enable(iss, IPIPEIF_DRV_SUBCLK_MASK);\r\n}\r\nswitch (enable) {\r\ncase ISS_PIPELINE_STREAM_CONTINUOUS:\r\nipipeif_configure(ipipeif);\r\nipipeif_print_status(ipipeif);\r\nif (ipipeif->output & IPIPEIF_OUTPUT_MEMORY &&\r\n!(video_out->dmaqueue_flags & ISS_VIDEO_DMAQUEUE_QUEUED))\r\nbreak;\r\natomic_set(&ipipeif->stopping, 0);\r\nif (ipipeif->output & IPIPEIF_OUTPUT_MEMORY)\r\nipipeif_write_enable(ipipeif, 1);\r\nipipeif_enable(ipipeif, 1);\r\niss_video_dmaqueue_flags_clr(video_out);\r\nbreak;\r\ncase ISS_PIPELINE_STREAM_STOPPED:\r\nif (ipipeif->state == ISS_PIPELINE_STREAM_STOPPED)\r\nreturn 0;\r\nif (omap4iss_module_sync_idle(&sd->entity, &ipipeif->wait,\r\n&ipipeif->stopping))\r\nret = -ETIMEDOUT;\r\nif (ipipeif->output & IPIPEIF_OUTPUT_MEMORY)\r\nipipeif_write_enable(ipipeif, 0);\r\nipipeif_enable(ipipeif, 0);\r\nomap4iss_isp_subclk_disable(iss, IPIPEIF_DRV_SUBCLK_MASK);\r\niss_video_dmaqueue_flags_clr(video_out);\r\nbreak;\r\n}\r\nipipeif->state = enable;\r\nreturn ret;\r\n}\r\nstatic struct v4l2_mbus_framefmt *\r\n__ipipeif_get_format(struct iss_ipipeif_device *ipipeif,\r\nstruct v4l2_subdev_fh *fh, unsigned int pad,\r\nenum v4l2_subdev_format_whence which)\r\n{\r\nif (which == V4L2_SUBDEV_FORMAT_TRY)\r\nreturn v4l2_subdev_get_try_format(fh, pad);\r\nelse\r\nreturn &ipipeif->formats[pad];\r\n}\r\nstatic void\r\nipipeif_try_format(struct iss_ipipeif_device *ipipeif,\r\nstruct v4l2_subdev_fh *fh, unsigned int pad,\r\nstruct v4l2_mbus_framefmt *fmt,\r\nenum v4l2_subdev_format_whence which)\r\n{\r\nstruct v4l2_mbus_framefmt *format;\r\nunsigned int width = fmt->width;\r\nunsigned int height = fmt->height;\r\nunsigned int i;\r\nswitch (pad) {\r\ncase IPIPEIF_PAD_SINK:\r\nfor (i = 0; i < ARRAY_SIZE(ipipeif_fmts); i++) {\r\nif (fmt->code == ipipeif_fmts[i])\r\nbreak;\r\n}\r\nif (i >= ARRAY_SIZE(ipipeif_fmts))\r\nfmt->code = V4L2_MBUS_FMT_SGRBG10_1X10;\r\nfmt->width = clamp_t(u32, width, 1, 8192);\r\nfmt->height = clamp_t(u32, height, 1, 8192);\r\nbreak;\r\ncase IPIPEIF_PAD_SOURCE_ISIF_SF:\r\nformat = __ipipeif_get_format(ipipeif, fh, IPIPEIF_PAD_SINK,\r\nwhich);\r\nmemcpy(fmt, format, sizeof(*fmt));\r\nfmt->width = clamp_t(u32, width, 32, (fmt->width + 15) & ~15);\r\nfmt->width &= ~15;\r\nfmt->height = clamp_t(u32, height, 32, fmt->height);\r\nbreak;\r\ncase IPIPEIF_PAD_SOURCE_VP:\r\nformat = __ipipeif_get_format(ipipeif, fh, IPIPEIF_PAD_SINK,\r\nwhich);\r\nmemcpy(fmt, format, sizeof(*fmt));\r\nfmt->width = clamp_t(u32, width, 32, fmt->width);\r\nfmt->height = clamp_t(u32, height, 32, fmt->height);\r\nbreak;\r\n}\r\nfmt->colorspace = V4L2_COLORSPACE_SRGB;\r\nfmt->field = V4L2_FIELD_NONE;\r\n}\r\nstatic int ipipeif_enum_mbus_code(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_mbus_code_enum *code)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *format;\r\nswitch (code->pad) {\r\ncase IPIPEIF_PAD_SINK:\r\nif (code->index >= ARRAY_SIZE(ipipeif_fmts))\r\nreturn -EINVAL;\r\ncode->code = ipipeif_fmts[code->index];\r\nbreak;\r\ncase IPIPEIF_PAD_SOURCE_ISIF_SF:\r\ncase IPIPEIF_PAD_SOURCE_VP:\r\nif (code->index != 0)\r\nreturn -EINVAL;\r\nformat = __ipipeif_get_format(ipipeif, fh, IPIPEIF_PAD_SINK,\r\nV4L2_SUBDEV_FORMAT_TRY);\r\ncode->code = format->code;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ipipeif_enum_frame_size(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_frame_size_enum *fse)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt format;\r\nif (fse->index != 0)\r\nreturn -EINVAL;\r\nformat.code = fse->code;\r\nformat.width = 1;\r\nformat.height = 1;\r\nipipeif_try_format(ipipeif, fh, fse->pad, &format,\r\nV4L2_SUBDEV_FORMAT_TRY);\r\nfse->min_width = format.width;\r\nfse->min_height = format.height;\r\nif (format.code != fse->code)\r\nreturn -EINVAL;\r\nformat.code = fse->code;\r\nformat.width = -1;\r\nformat.height = -1;\r\nipipeif_try_format(ipipeif, fh, fse->pad, &format,\r\nV4L2_SUBDEV_FORMAT_TRY);\r\nfse->max_width = format.width;\r\nfse->max_height = format.height;\r\nreturn 0;\r\n}\r\nstatic int ipipeif_get_format(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = __ipipeif_get_format(ipipeif, fh, fmt->pad, fmt->which);\r\nif (format == NULL)\r\nreturn -EINVAL;\r\nfmt->format = *format;\r\nreturn 0;\r\n}\r\nstatic int ipipeif_set_format(struct v4l2_subdev *sd, struct v4l2_subdev_fh *fh,\r\nstruct v4l2_subdev_format *fmt)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = v4l2_get_subdevdata(sd);\r\nstruct v4l2_mbus_framefmt *format;\r\nformat = __ipipeif_get_format(ipipeif, fh, fmt->pad, fmt->which);\r\nif (format == NULL)\r\nreturn -EINVAL;\r\nipipeif_try_format(ipipeif, fh, fmt->pad, &fmt->format, fmt->which);\r\n*format = fmt->format;\r\nif (fmt->pad == IPIPEIF_PAD_SINK) {\r\nformat = __ipipeif_get_format(ipipeif, fh,\r\nIPIPEIF_PAD_SOURCE_ISIF_SF,\r\nfmt->which);\r\n*format = fmt->format;\r\nipipeif_try_format(ipipeif, fh, IPIPEIF_PAD_SOURCE_ISIF_SF,\r\nformat, fmt->which);\r\nformat = __ipipeif_get_format(ipipeif, fh,\r\nIPIPEIF_PAD_SOURCE_VP,\r\nfmt->which);\r\n*format = fmt->format;\r\nipipeif_try_format(ipipeif, fh, IPIPEIF_PAD_SOURCE_VP, format,\r\nfmt->which);\r\n}\r\nreturn 0;\r\n}\r\nstatic int ipipeif_link_validate(struct v4l2_subdev *sd,\r\nstruct media_link *link,\r\nstruct v4l2_subdev_format *source_fmt,\r\nstruct v4l2_subdev_format *sink_fmt)\r\n{\r\nif (source_fmt->format.width != sink_fmt->format.width ||\r\nsource_fmt->format.height != sink_fmt->format.height)\r\nreturn -EPIPE;\r\nif (source_fmt->format.code != sink_fmt->format.code)\r\nreturn -EPIPE;\r\nreturn 0;\r\n}\r\nstatic int ipipeif_init_formats(struct v4l2_subdev *sd,\r\nstruct v4l2_subdev_fh *fh)\r\n{\r\nstruct v4l2_subdev_format format;\r\nmemset(&format, 0, sizeof(format));\r\nformat.pad = IPIPEIF_PAD_SINK;\r\nformat.which = fh ? V4L2_SUBDEV_FORMAT_TRY : V4L2_SUBDEV_FORMAT_ACTIVE;\r\nformat.format.code = V4L2_MBUS_FMT_SGRBG10_1X10;\r\nformat.format.width = 4096;\r\nformat.format.height = 4096;\r\nipipeif_set_format(sd, fh, &format);\r\nreturn 0;\r\n}\r\nstatic int ipipeif_link_setup(struct media_entity *entity,\r\nconst struct media_pad *local,\r\nconst struct media_pad *remote, u32 flags)\r\n{\r\nstruct v4l2_subdev *sd = media_entity_to_v4l2_subdev(entity);\r\nstruct iss_ipipeif_device *ipipeif = v4l2_get_subdevdata(sd);\r\nstruct iss_device *iss = to_iss_device(ipipeif);\r\nswitch (local->index | media_entity_type(remote->entity)) {\r\ncase IPIPEIF_PAD_SINK | MEDIA_ENT_T_V4L2_SUBDEV:\r\nif (!(flags & MEDIA_LNK_FL_ENABLED)) {\r\nipipeif->input = IPIPEIF_INPUT_NONE;\r\nbreak;\r\n}\r\nif (ipipeif->input != IPIPEIF_INPUT_NONE)\r\nreturn -EBUSY;\r\nif (remote->entity == &iss->csi2a.subdev.entity)\r\nipipeif->input = IPIPEIF_INPUT_CSI2A;\r\nelse if (remote->entity == &iss->csi2b.subdev.entity)\r\nipipeif->input = IPIPEIF_INPUT_CSI2B;\r\nbreak;\r\ncase IPIPEIF_PAD_SOURCE_ISIF_SF | MEDIA_ENT_T_DEVNODE:\r\nif (flags & MEDIA_LNK_FL_ENABLED) {\r\nif (ipipeif->output & ~IPIPEIF_OUTPUT_MEMORY)\r\nreturn -EBUSY;\r\nipipeif->output |= IPIPEIF_OUTPUT_MEMORY;\r\n} else {\r\nipipeif->output &= ~IPIPEIF_OUTPUT_MEMORY;\r\n}\r\nbreak;\r\ncase IPIPEIF_PAD_SOURCE_VP | MEDIA_ENT_T_V4L2_SUBDEV:\r\nif (flags & MEDIA_LNK_FL_ENABLED) {\r\nif (ipipeif->output & ~IPIPEIF_OUTPUT_VP)\r\nreturn -EBUSY;\r\nipipeif->output |= IPIPEIF_OUTPUT_VP;\r\n} else {\r\nipipeif->output &= ~IPIPEIF_OUTPUT_VP;\r\n}\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int ipipeif_init_entities(struct iss_ipipeif_device *ipipeif)\r\n{\r\nstruct v4l2_subdev *sd = &ipipeif->subdev;\r\nstruct media_pad *pads = ipipeif->pads;\r\nstruct media_entity *me = &sd->entity;\r\nint ret;\r\nipipeif->input = IPIPEIF_INPUT_NONE;\r\nv4l2_subdev_init(sd, &ipipeif_v4l2_ops);\r\nsd->internal_ops = &ipipeif_v4l2_internal_ops;\r\nstrlcpy(sd->name, "OMAP4 ISS ISP IPIPEIF", sizeof(sd->name));\r\nsd->grp_id = 1 << 16;\r\nv4l2_set_subdevdata(sd, ipipeif);\r\nsd->flags |= V4L2_SUBDEV_FL_HAS_DEVNODE;\r\npads[IPIPEIF_PAD_SINK].flags = MEDIA_PAD_FL_SINK;\r\npads[IPIPEIF_PAD_SOURCE_ISIF_SF].flags = MEDIA_PAD_FL_SOURCE;\r\npads[IPIPEIF_PAD_SOURCE_VP].flags = MEDIA_PAD_FL_SOURCE;\r\nme->ops = &ipipeif_media_ops;\r\nret = media_entity_init(me, IPIPEIF_PADS_NUM, pads, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nipipeif_init_formats(sd, NULL);\r\nipipeif->video_out.type = V4L2_BUF_TYPE_VIDEO_CAPTURE;\r\nipipeif->video_out.ops = &ipipeif_video_ops;\r\nipipeif->video_out.iss = to_iss_device(ipipeif);\r\nipipeif->video_out.capture_mem = PAGE_ALIGN(4096 * 4096) * 3;\r\nipipeif->video_out.bpl_alignment = 32;\r\nipipeif->video_out.bpl_zero_padding = 1;\r\nipipeif->video_out.bpl_max = 0x1ffe0;\r\nret = omap4iss_video_init(&ipipeif->video_out, "ISP IPIPEIF");\r\nif (ret < 0)\r\nreturn ret;\r\nret = media_entity_create_link(&ipipeif->subdev.entity,\r\nIPIPEIF_PAD_SOURCE_ISIF_SF,\r\n&ipipeif->video_out.video.entity, 0, 0);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nvoid omap4iss_ipipeif_unregister_entities(struct iss_ipipeif_device *ipipeif)\r\n{\r\nmedia_entity_cleanup(&ipipeif->subdev.entity);\r\nv4l2_device_unregister_subdev(&ipipeif->subdev);\r\nomap4iss_video_unregister(&ipipeif->video_out);\r\n}\r\nint omap4iss_ipipeif_register_entities(struct iss_ipipeif_device *ipipeif,\r\nstruct v4l2_device *vdev)\r\n{\r\nint ret;\r\nret = v4l2_device_register_subdev(vdev, &ipipeif->subdev);\r\nif (ret < 0)\r\ngoto error;\r\nret = omap4iss_video_register(&ipipeif->video_out, vdev);\r\nif (ret < 0)\r\ngoto error;\r\nreturn 0;\r\nerror:\r\nomap4iss_ipipeif_unregister_entities(ipipeif);\r\nreturn ret;\r\n}\r\nint omap4iss_ipipeif_init(struct iss_device *iss)\r\n{\r\nstruct iss_ipipeif_device *ipipeif = &iss->ipipeif;\r\nipipeif->state = ISS_PIPELINE_STREAM_STOPPED;\r\ninit_waitqueue_head(&ipipeif->wait);\r\nreturn ipipeif_init_entities(ipipeif);\r\n}\r\nvoid omap4iss_ipipeif_cleanup(struct iss_device *iss)\r\n{\r\n}

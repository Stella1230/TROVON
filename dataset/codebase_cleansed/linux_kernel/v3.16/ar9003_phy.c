static int ar9003_hw_set_channel(struct ath_hw *ah, struct ath9k_channel *chan)\r\n{\r\nu16 bMode, fracMode = 0, aModeRefSel = 0;\r\nu32 freq, chan_frac, div, channelSel = 0, reg32 = 0;\r\nstruct chan_centers centers;\r\nint loadSynthChannel;\r\nath9k_hw_get_channel_centers(ah, chan, &centers);\r\nfreq = centers.synth_center;\r\nif (freq < 4800) {\r\nif (AR_SREV_9330(ah)) {\r\nif (ah->is_clk_25mhz)\r\ndiv = 75;\r\nelse\r\ndiv = 120;\r\nchannelSel = (freq * 4) / div;\r\nchan_frac = (((freq * 4) % div) * 0x20000) / div;\r\nchannelSel = (channelSel << 17) | chan_frac;\r\n} else if (AR_SREV_9485(ah) || AR_SREV_9565(ah)) {\r\nchannelSel = (freq * 4) / 120;\r\nchan_frac = (((freq * 4) % 120) * 0x20000) / 120;\r\nchannelSel = (channelSel << 17) | chan_frac;\r\n} else if (AR_SREV_9340(ah)) {\r\nif (ah->is_clk_25mhz) {\r\nchannelSel = (freq * 2) / 75;\r\nchan_frac = (((freq * 2) % 75) * 0x20000) / 75;\r\nchannelSel = (channelSel << 17) | chan_frac;\r\n} else {\r\nchannelSel = CHANSEL_2G(freq) >> 1;\r\n}\r\n} else if (AR_SREV_9550(ah) || AR_SREV_9531(ah)) {\r\nif (ah->is_clk_25mhz)\r\ndiv = 75;\r\nelse\r\ndiv = 120;\r\nchannelSel = (freq * 4) / div;\r\nchan_frac = (((freq * 4) % div) * 0x20000) / div;\r\nchannelSel = (channelSel << 17) | chan_frac;\r\n} else {\r\nchannelSel = CHANSEL_2G(freq);\r\n}\r\nbMode = 1;\r\n} else {\r\nif ((AR_SREV_9340(ah) || AR_SREV_9550(ah) || AR_SREV_9531(ah)) &&\r\nah->is_clk_25mhz) {\r\nchannelSel = freq / 75;\r\nchan_frac = ((freq % 75) * 0x20000) / 75;\r\nchannelSel = (channelSel << 17) | chan_frac;\r\n} else {\r\nchannelSel = CHANSEL_5G(freq);\r\nchannelSel >>= 1;\r\n}\r\nbMode = 0;\r\n}\r\nfracMode = 1;\r\naModeRefSel = 0;\r\nloadSynthChannel = 0;\r\nreg32 = (bMode << 29);\r\nREG_WRITE(ah, AR_PHY_SYNTH_CONTROL, reg32);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_SYNTH4,\r\nAR_PHY_SYNTH4_LONG_SHIFT_SELECT, 1);\r\nreg32 = (channelSel << 2) | (fracMode << 30) |\r\n(aModeRefSel << 28) | (loadSynthChannel << 31);\r\nREG_WRITE(ah, AR_PHY_65NM_CH0_SYNTH7, reg32);\r\nloadSynthChannel = 1;\r\nreg32 = (channelSel << 2) | (fracMode << 30) |\r\n(aModeRefSel << 28) | (loadSynthChannel << 31);\r\nREG_WRITE(ah, AR_PHY_65NM_CH0_SYNTH7, reg32);\r\nah->curchan = chan;\r\nreturn 0;\r\n}\r\nstatic void ar9003_hw_spur_mitigate_mrc_cck(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nstatic const u32 spur_freq[4] = { 2420, 2440, 2464, 2480 };\r\nint cur_bb_spur, negative = 0, cck_spur_freq;\r\nint i;\r\nint range, max_spur_cnts, synth_freq;\r\nu8 *spur_fbin_ptr = ar9003_get_spur_chan_ptr(ah, IS_CHAN_2GHZ(chan));\r\nif (AR_SREV_9485(ah) || AR_SREV_9340(ah) || AR_SREV_9330(ah) ||\r\nAR_SREV_9550(ah)) {\r\nif (spur_fbin_ptr[0] == 0)\r\nreturn;\r\nmax_spur_cnts = 5;\r\nif (IS_CHAN_HT40(chan)) {\r\nrange = 19;\r\nif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\r\nAR_PHY_GC_DYN2040_PRI_CH) == 0)\r\nsynth_freq = chan->channel + 10;\r\nelse\r\nsynth_freq = chan->channel - 10;\r\n} else {\r\nrange = 10;\r\nsynth_freq = chan->channel;\r\n}\r\n} else {\r\nrange = AR_SREV_9462(ah) ? 5 : 10;\r\nmax_spur_cnts = 4;\r\nsynth_freq = chan->channel;\r\n}\r\nfor (i = 0; i < max_spur_cnts; i++) {\r\nif (AR_SREV_9462(ah) && (i == 0 || i == 3))\r\ncontinue;\r\nnegative = 0;\r\nif (AR_SREV_9485(ah) || AR_SREV_9340(ah) || AR_SREV_9330(ah) ||\r\nAR_SREV_9550(ah))\r\ncur_bb_spur = ath9k_hw_fbin2freq(spur_fbin_ptr[i],\r\nIS_CHAN_2GHZ(chan));\r\nelse\r\ncur_bb_spur = spur_freq[i];\r\ncur_bb_spur -= synth_freq;\r\nif (cur_bb_spur < 0) {\r\nnegative = 1;\r\ncur_bb_spur = -cur_bb_spur;\r\n}\r\nif (cur_bb_spur < range) {\r\ncck_spur_freq = (int)((cur_bb_spur << 19) / 11);\r\nif (negative == 1)\r\ncck_spur_freq = -cck_spur_freq;\r\ncck_spur_freq = cck_spur_freq & 0xfffff;\r\nREG_RMW_FIELD(ah, AR_PHY_AGC_CONTROL,\r\nAR_PHY_AGC_CONTROL_YCOK_MAX, 0x7);\r\nREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\r\nAR_PHY_CCK_SPUR_MIT_SPUR_RSSI_THR, 0x7f);\r\nREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\r\nAR_PHY_CCK_SPUR_MIT_SPUR_FILTER_TYPE,\r\n0x2);\r\nREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\r\nAR_PHY_CCK_SPUR_MIT_USE_CCK_SPUR_MIT,\r\n0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\r\nAR_PHY_CCK_SPUR_MIT_CCK_SPUR_FREQ,\r\ncck_spur_freq);\r\nreturn;\r\n}\r\n}\r\nREG_RMW_FIELD(ah, AR_PHY_AGC_CONTROL,\r\nAR_PHY_AGC_CONTROL_YCOK_MAX, 0x5);\r\nREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\r\nAR_PHY_CCK_SPUR_MIT_USE_CCK_SPUR_MIT, 0x0);\r\nREG_RMW_FIELD(ah, AR_PHY_CCK_SPUR_MIT,\r\nAR_PHY_CCK_SPUR_MIT_CCK_SPUR_FREQ, 0x0);\r\n}\r\nstatic void ar9003_hw_spur_ofdm_clear(struct ath_hw *ah)\r\n{\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_SPUR_FILTER, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_SPUR_FREQ_SD, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_SPUR_DELTA_PHASE, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_SPUR_SUBCHANNEL_SD, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_USE_SPUR_FILTER_IN_AGC, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_USE_SPUR_FILTER_IN_SELFCOR, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_SPUR_RSSI, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_EN_VIT_SPUR_RSSI, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_ENABLE_NF_RSSI_SPUR_MIT, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_ENABLE_MASK_PPM, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_PILOT_MASK, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_CHAN_MASK, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\r\nAR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_A, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A,\r\nAR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\r\nAR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_A, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\r\nAR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_A, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\r\nAR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_A, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A,\r\nAR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A, 0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_MASK_RATE_CNTL, 0);\r\n}\r\nstatic void ar9003_hw_spur_ofdm(struct ath_hw *ah,\r\nint freq_offset,\r\nint spur_freq_sd,\r\nint spur_delta_phase,\r\nint spur_subchannel_sd,\r\nint range,\r\nint synth_freq)\r\n{\r\nint mask_index = 0;\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_SPUR_FILTER, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_SPUR_FREQ_SD, spur_freq_sd);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_SPUR_DELTA_PHASE, spur_delta_phase);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_SPUR_SUBCHANNEL_SD, spur_subchannel_sd);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_USE_SPUR_FILTER_IN_AGC, 0x1);\r\nif (!(AR_SREV_9565(ah) && range == 10 && synth_freq == 2437))\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING11,\r\nAR_PHY_TIMING11_USE_SPUR_FILTER_IN_SELFCOR, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_SPUR_RSSI, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_SPUR_RSSI_THRESH, 34);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_EN_VIT_SPUR_RSSI, 1);\r\nif (!AR_SREV_9340(ah) &&\r\nREG_READ_FIELD(ah, AR_PHY_MODE,\r\nAR_PHY_MODE_DYNAMIC) == 0x1)\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_ENABLE_NF_RSSI_SPUR_MIT, 1);\r\nmask_index = (freq_offset << 4) / 5;\r\nif (mask_index < 0)\r\nmask_index = mask_index - 1;\r\nmask_index = mask_index & 0x7f;\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_ENABLE_MASK_PPM, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_PILOT_MASK, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING4,\r\nAR_PHY_TIMING4_ENABLE_CHAN_MASK, 0x1);\r\nREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\r\nAR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_A, mask_index);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A,\r\nAR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A, mask_index);\r\nREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\r\nAR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_A, mask_index);\r\nREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\r\nAR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_A, 0xc);\r\nREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\r\nAR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_A, 0xc);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_A,\r\nAR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A, 0xa0);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_REG,\r\nAR_PHY_SPUR_REG_MASK_RATE_CNTL, 0xff);\r\n}\r\nstatic void ar9003_hw_spur_ofdm_9565(struct ath_hw *ah,\r\nint freq_offset)\r\n{\r\nint mask_index = 0;\r\nmask_index = (freq_offset << 4) / 5;\r\nif (mask_index < 0)\r\nmask_index = mask_index - 1;\r\nmask_index = mask_index & 0x7f;\r\nREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\r\nAR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_IDX_B,\r\nmask_index);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_B,\r\nAR_PHY_SPUR_MASK_A_CF_PUNC_MASK_IDX_A,\r\nmask_index);\r\nREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\r\nAR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_IDX_B,\r\nmask_index);\r\nREG_RMW_FIELD(ah, AR_PHY_PILOT_SPUR_MASK,\r\nAR_PHY_PILOT_SPUR_MASK_CF_PILOT_MASK_B, 0xe);\r\nREG_RMW_FIELD(ah, AR_PHY_CHAN_SPUR_MASK,\r\nAR_PHY_CHAN_SPUR_MASK_CF_CHAN_MASK_B, 0xe);\r\nREG_RMW_FIELD(ah, AR_PHY_SPUR_MASK_B,\r\nAR_PHY_SPUR_MASK_A_CF_PUNC_MASK_A, 0xa0);\r\n}\r\nstatic void ar9003_hw_spur_ofdm_work(struct ath_hw *ah,\r\nstruct ath9k_channel *chan,\r\nint freq_offset,\r\nint range,\r\nint synth_freq)\r\n{\r\nint spur_freq_sd = 0;\r\nint spur_subchannel_sd = 0;\r\nint spur_delta_phase = 0;\r\nif (IS_CHAN_HT40(chan)) {\r\nif (freq_offset < 0) {\r\nif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\r\nAR_PHY_GC_DYN2040_PRI_CH) == 0x0)\r\nspur_subchannel_sd = 1;\r\nelse\r\nspur_subchannel_sd = 0;\r\nspur_freq_sd = ((freq_offset + 10) << 9) / 11;\r\n} else {\r\nif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\r\nAR_PHY_GC_DYN2040_PRI_CH) == 0x0)\r\nspur_subchannel_sd = 0;\r\nelse\r\nspur_subchannel_sd = 1;\r\nspur_freq_sd = ((freq_offset - 10) << 9) / 11;\r\n}\r\nspur_delta_phase = (freq_offset << 17) / 5;\r\n} else {\r\nspur_subchannel_sd = 0;\r\nspur_freq_sd = (freq_offset << 9) /11;\r\nspur_delta_phase = (freq_offset << 18) / 5;\r\n}\r\nspur_freq_sd = spur_freq_sd & 0x3ff;\r\nspur_delta_phase = spur_delta_phase & 0xfffff;\r\nar9003_hw_spur_ofdm(ah,\r\nfreq_offset,\r\nspur_freq_sd,\r\nspur_delta_phase,\r\nspur_subchannel_sd,\r\nrange, synth_freq);\r\n}\r\nstatic void ar9003_hw_spur_mitigate_ofdm(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nint synth_freq;\r\nint range = 10;\r\nint freq_offset = 0;\r\nint mode;\r\nu8* spurChansPtr;\r\nunsigned int i;\r\nstruct ar9300_eeprom *eep = &ah->eeprom.ar9300_eep;\r\nif (IS_CHAN_5GHZ(chan)) {\r\nspurChansPtr = &(eep->modalHeader5G.spurChans[0]);\r\nmode = 0;\r\n}\r\nelse {\r\nspurChansPtr = &(eep->modalHeader2G.spurChans[0]);\r\nmode = 1;\r\n}\r\nif (spurChansPtr[0] == 0)\r\nreturn;\r\nif (IS_CHAN_HT40(chan)) {\r\nrange = 19;\r\nif (REG_READ_FIELD(ah, AR_PHY_GEN_CTRL,\r\nAR_PHY_GC_DYN2040_PRI_CH) == 0x0)\r\nsynth_freq = chan->channel - 10;\r\nelse\r\nsynth_freq = chan->channel + 10;\r\n} else {\r\nrange = 10;\r\nsynth_freq = chan->channel;\r\n}\r\nar9003_hw_spur_ofdm_clear(ah);\r\nfor (i = 0; i < AR_EEPROM_MODAL_SPURS && spurChansPtr[i]; i++) {\r\nfreq_offset = ath9k_hw_fbin2freq(spurChansPtr[i], mode);\r\nfreq_offset -= synth_freq;\r\nif (abs(freq_offset) < range) {\r\nar9003_hw_spur_ofdm_work(ah, chan, freq_offset,\r\nrange, synth_freq);\r\nif (AR_SREV_9565(ah) && (i < 4)) {\r\nfreq_offset = ath9k_hw_fbin2freq(spurChansPtr[i + 1],\r\nmode);\r\nfreq_offset -= synth_freq;\r\nif (abs(freq_offset) < range)\r\nar9003_hw_spur_ofdm_9565(ah, freq_offset);\r\n}\r\nbreak;\r\n}\r\n}\r\n}\r\nstatic void ar9003_hw_spur_mitigate(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nif (!AR_SREV_9565(ah))\r\nar9003_hw_spur_mitigate_mrc_cck(ah, chan);\r\nar9003_hw_spur_mitigate_ofdm(ah, chan);\r\n}\r\nstatic u32 ar9003_hw_compute_pll_control(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 pll;\r\npll = SM(0x5, AR_RTC_9300_PLL_REFDIV);\r\nif (chan && IS_CHAN_HALF_RATE(chan))\r\npll |= SM(0x1, AR_RTC_9300_PLL_CLKSEL);\r\nelse if (chan && IS_CHAN_QUARTER_RATE(chan))\r\npll |= SM(0x2, AR_RTC_9300_PLL_CLKSEL);\r\npll |= SM(0x2c, AR_RTC_9300_PLL_DIV);\r\nreturn pll;\r\n}\r\nstatic void ar9003_hw_set_channel_regs(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 phymode;\r\nu32 enableDacFifo = 0;\r\nenableDacFifo =\r\n(REG_READ(ah, AR_PHY_GEN_CTRL) & AR_PHY_GC_ENABLE_DAC_FIFO);\r\nphymode = AR_PHY_GC_HT_EN | AR_PHY_GC_SINGLE_HT_LTF1 |\r\nAR_PHY_GC_SHORT_GI_40 | enableDacFifo;\r\nif (IS_CHAN_HT40(chan)) {\r\nphymode |= AR_PHY_GC_DYN2040_EN;\r\nif (IS_CHAN_HT40PLUS(chan))\r\nphymode |= AR_PHY_GC_DYN2040_PRI_CH;\r\n}\r\nphymode |= REG_READ(ah, AR_PHY_GEN_CTRL);\r\nphymode &= ~AR_PHY_GC_GF_DETECT_EN;\r\nREG_WRITE(ah, AR_PHY_GEN_CTRL, phymode);\r\nath9k_hw_set11nmac2040(ah, chan);\r\nREG_WRITE(ah, AR_GTXTO, 25 << AR_GTXTO_TIMEOUT_LIMIT_S);\r\nREG_WRITE(ah, AR_CST, 0xF << AR_CST_TIMEOUT_LIMIT_S);\r\n}\r\nstatic void ar9003_hw_init_bb(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 synthDelay;\r\nsynthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\r\nREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_EN);\r\nath9k_hw_synth_delay(ah, chan, synthDelay);\r\n}\r\nvoid ar9003_hw_set_chain_masks(struct ath_hw *ah, u8 rx, u8 tx)\r\n{\r\nif (ah->caps.tx_chainmask == 5 || ah->caps.rx_chainmask == 5)\r\nREG_SET_BIT(ah, AR_PHY_ANALOG_SWAP,\r\nAR_PHY_SWAP_ALT_CHAIN);\r\nREG_WRITE(ah, AR_PHY_RX_CHAINMASK, rx);\r\nREG_WRITE(ah, AR_PHY_CAL_CHAINMASK, rx);\r\nif ((ah->caps.hw_caps & ATH9K_HW_CAP_APM) && (tx == 0x7))\r\ntx = 3;\r\nREG_WRITE(ah, AR_SELFGEN_MASK, tx);\r\n}\r\nstatic void ar9003_hw_override_ini(struct ath_hw *ah)\r\n{\r\nu32 val;\r\nREG_SET_BIT(ah, AR_DIAG_SW, (AR_DIAG_RX_DIS | AR_DIAG_RX_ABORT));\r\nval = REG_READ(ah, AR_PCU_MISC_MODE2) & (~AR_ADHOC_MCAST_KEYID_ENABLE);\r\nval |= AR_AGG_WEP_ENABLE_FIX |\r\nAR_AGG_WEP_ENABLE |\r\nAR_PCU_MISC_MODE2_CFP_IGNORE;\r\nREG_WRITE(ah, AR_PCU_MISC_MODE2, val);\r\nif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\r\nREG_WRITE(ah, AR_GLB_SWREG_DISCONT_MODE,\r\nAR_GLB_SWREG_DISCONT_EN_BT_WLAN);\r\nif (REG_READ_FIELD(ah, AR_PHY_TX_IQCAL_CONTROL_0,\r\nAR_PHY_TX_IQCAL_CONTROL_0_ENABLE_TXIQ_CAL))\r\nah->enabled_cals |= TX_IQ_CAL;\r\nelse\r\nah->enabled_cals &= ~TX_IQ_CAL;\r\n}\r\nif (REG_READ(ah, AR_PHY_CL_CAL_CTL) & AR_PHY_CL_CAL_ENABLE)\r\nah->enabled_cals |= TX_CL_CAL;\r\nelse\r\nah->enabled_cals &= ~TX_CL_CAL;\r\n}\r\nstatic void ar9003_hw_prog_ini(struct ath_hw *ah,\r\nstruct ar5416IniArray *iniArr,\r\nint column)\r\n{\r\nunsigned int i, regWrites = 0;\r\nif (!iniArr->ia_array)\r\nreturn;\r\nif (column >= iniArr->ia_columns)\r\ncolumn = 1;\r\nfor (i = 0; i < iniArr->ia_rows; i++) {\r\nu32 reg = INI_RA(iniArr, i, 0);\r\nu32 val = INI_RA(iniArr, i, column);\r\nREG_WRITE(ah, reg, val);\r\nDO_DELAY(regWrites);\r\n}\r\n}\r\nstatic int ar9550_hw_get_modes_txgain_index(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nint ret;\r\nif (IS_CHAN_2GHZ(chan)) {\r\nif (IS_CHAN_HT40(chan))\r\nreturn 7;\r\nelse\r\nreturn 8;\r\n}\r\nif (chan->channel <= 5350)\r\nret = 1;\r\nelse if ((chan->channel > 5350) && (chan->channel <= 5600))\r\nret = 3;\r\nelse\r\nret = 5;\r\nif (IS_CHAN_HT40(chan))\r\nret++;\r\nreturn ret;\r\n}\r\nstatic void ar9003_doubler_fix(struct ath_hw *ah)\r\n{\r\nif (AR_SREV_9300(ah) || AR_SREV_9580(ah) || AR_SREV_9550(ah)) {\r\nREG_RMW(ah, AR_PHY_65NM_CH0_RXTX2,\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S, 0);\r\nREG_RMW(ah, AR_PHY_65NM_CH1_RXTX2,\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S, 0);\r\nREG_RMW(ah, AR_PHY_65NM_CH2_RXTX2,\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S, 0);\r\nudelay(200);\r\nREG_CLR_BIT(ah, AR_PHY_65NM_CH0_RXTX2,\r\nAR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK);\r\nREG_CLR_BIT(ah, AR_PHY_65NM_CH1_RXTX2,\r\nAR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK);\r\nREG_CLR_BIT(ah, AR_PHY_65NM_CH2_RXTX2,\r\nAR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK);\r\nudelay(1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_RXTX2,\r\nAR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK, 1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_CH1_RXTX2,\r\nAR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK, 1);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_CH2_RXTX2,\r\nAR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK, 1);\r\nudelay(200);\r\nREG_RMW_FIELD(ah, AR_PHY_65NM_CH0_SYNTH12,\r\nAR_PHY_65NM_CH0_SYNTH12_VREFMUL3, 0xf);\r\nREG_RMW(ah, AR_PHY_65NM_CH0_RXTX2, 0,\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S);\r\nREG_RMW(ah, AR_PHY_65NM_CH1_RXTX2, 0,\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S);\r\nREG_RMW(ah, AR_PHY_65NM_CH2_RXTX2, 0,\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHON_MASK_S |\r\n1 << AR_PHY_65NM_CH0_RXTX2_SYNTHOVR_MASK_S);\r\n}\r\n}\r\nstatic int ar9003_hw_process_ini(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nunsigned int regWrites = 0, i;\r\nu32 modesIndex;\r\nif (IS_CHAN_5GHZ(chan))\r\nmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\r\nelse\r\nmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\r\nfor (i = 0; i < ATH_INI_NUM_SPLIT; i++) {\r\nar9003_hw_prog_ini(ah, &ah->iniSOC[i], modesIndex);\r\nar9003_hw_prog_ini(ah, &ah->iniMac[i], modesIndex);\r\nar9003_hw_prog_ini(ah, &ah->iniBB[i], modesIndex);\r\nar9003_hw_prog_ini(ah, &ah->iniRadio[i], modesIndex);\r\nif (i == ATH_INI_POST && AR_SREV_9462_20_OR_LATER(ah))\r\nar9003_hw_prog_ini(ah,\r\n&ah->ini_radio_post_sys2ant,\r\nmodesIndex);\r\n}\r\nar9003_doubler_fix(ah);\r\nREG_WRITE_ARRAY(&ah->iniModesRxGain, 1, regWrites);\r\nif (AR_SREV_9462_20_OR_LATER(ah)) {\r\nif (ar9003_hw_get_rx_gain_idx(ah) == 2) {\r\nREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_core,\r\n1, regWrites);\r\nREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_postamble,\r\nmodesIndex, regWrites);\r\n}\r\nif ((ar9003_hw_get_rx_gain_idx(ah) == 2) ||\r\n(ar9003_hw_get_rx_gain_idx(ah) == 3)) {\r\nREG_WRITE_ARRAY(&ah->ini_modes_rxgain_5g_xlna,\r\nmodesIndex, regWrites);\r\n}\r\n}\r\nif (AR_SREV_9550(ah))\r\nREG_WRITE_ARRAY(&ah->ini_modes_rx_gain_bounds, modesIndex,\r\nregWrites);\r\nif (AR_SREV_9550(ah) || AR_SREV_9531(ah)) {\r\nint modes_txgain_index = 1;\r\nif (AR_SREV_9550(ah))\r\nmodes_txgain_index = ar9550_hw_get_modes_txgain_index(ah, chan);\r\nif (modes_txgain_index < 0)\r\nreturn -EINVAL;\r\nREG_WRITE_ARRAY(&ah->iniModesTxGain, modes_txgain_index,\r\nregWrites);\r\n} else {\r\nREG_WRITE_ARRAY(&ah->iniModesTxGain, modesIndex, regWrites);\r\n}\r\nif (IS_CHAN_A_FAST_CLOCK(ah, chan))\r\nREG_WRITE_ARRAY(&ah->iniModesFastClock,\r\nmodesIndex, regWrites);\r\nREG_WRITE_ARRAY(&ah->iniAdditional, 1, regWrites);\r\nif (chan->channel == 2484)\r\nar9003_hw_prog_ini(ah, &ah->iniCckfirJapan2484, 1);\r\nah->modes_index = modesIndex;\r\nar9003_hw_override_ini(ah);\r\nar9003_hw_set_channel_regs(ah, chan);\r\nar9003_hw_set_chain_masks(ah, ah->rxchainmask, ah->txchainmask);\r\nath9k_hw_apply_txpower(ah, chan, false);\r\nreturn 0;\r\n}\r\nstatic void ar9003_hw_set_rfmode(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 rfMode = 0;\r\nif (chan == NULL)\r\nreturn;\r\nif (IS_CHAN_2GHZ(chan))\r\nrfMode |= AR_PHY_MODE_DYNAMIC;\r\nelse\r\nrfMode |= AR_PHY_MODE_OFDM;\r\nif (IS_CHAN_A_FAST_CLOCK(ah, chan))\r\nrfMode |= (AR_PHY_MODE_DYNAMIC | AR_PHY_MODE_DYN_CCK_DISABLE);\r\nif (rfMode & (AR_PHY_MODE_QUARTER | AR_PHY_MODE_HALF))\r\nREG_RMW_FIELD(ah, AR_PHY_FRAME_CTL,\r\nAR_PHY_FRAME_CTL_CF_OVERLAP_WINDOW, 3);\r\nREG_WRITE(ah, AR_PHY_MODE, rfMode);\r\n}\r\nstatic void ar9003_hw_mark_phy_inactive(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_PHY_ACTIVE, AR_PHY_ACTIVE_DIS);\r\n}\r\nstatic void ar9003_hw_set_delta_slope(struct ath_hw *ah,\r\nstruct ath9k_channel *chan)\r\n{\r\nu32 coef_scaled, ds_coef_exp, ds_coef_man;\r\nu32 clockMhzScaled = 0x64000000;\r\nstruct chan_centers centers;\r\nif (IS_CHAN_HALF_RATE(chan))\r\nclockMhzScaled = clockMhzScaled >> 1;\r\nelse if (IS_CHAN_QUARTER_RATE(chan))\r\nclockMhzScaled = clockMhzScaled >> 2;\r\nath9k_hw_get_channel_centers(ah, chan, &centers);\r\ncoef_scaled = clockMhzScaled / centers.synth_center;\r\nath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\r\n&ds_coef_exp);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING3,\r\nAR_PHY_TIMING3_DSC_MAN, ds_coef_man);\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING3,\r\nAR_PHY_TIMING3_DSC_EXP, ds_coef_exp);\r\ncoef_scaled = (9 * coef_scaled) / 10;\r\nath9k_hw_get_delta_slope_vals(ah, coef_scaled, &ds_coef_man,\r\n&ds_coef_exp);\r\nREG_RMW_FIELD(ah, AR_PHY_SGI_DELTA,\r\nAR_PHY_SGI_DSC_MAN, ds_coef_man);\r\nREG_RMW_FIELD(ah, AR_PHY_SGI_DELTA,\r\nAR_PHY_SGI_DSC_EXP, ds_coef_exp);\r\n}\r\nstatic bool ar9003_hw_rfbus_req(struct ath_hw *ah)\r\n{\r\nREG_WRITE(ah, AR_PHY_RFBUS_REQ, AR_PHY_RFBUS_REQ_EN);\r\nreturn ath9k_hw_wait(ah, AR_PHY_RFBUS_GRANT, AR_PHY_RFBUS_GRANT_EN,\r\nAR_PHY_RFBUS_GRANT_EN, AH_WAIT_TIMEOUT);\r\n}\r\nstatic void ar9003_hw_rfbus_done(struct ath_hw *ah)\r\n{\r\nu32 synthDelay = REG_READ(ah, AR_PHY_RX_DELAY) & AR_PHY_RX_DELAY_DELAY;\r\nath9k_hw_synth_delay(ah, ah->curchan, synthDelay);\r\nREG_WRITE(ah, AR_PHY_RFBUS_REQ, 0);\r\n}\r\nstatic bool ar9003_hw_ani_control(struct ath_hw *ah,\r\nenum ath9k_ani_cmd cmd, int param)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ar5416AniState *aniState = &ah->ani;\r\nint m1ThreshLow, m2ThreshLow;\r\nint m1Thresh, m2Thresh;\r\nint m2CountThr, m2CountThrLow;\r\nint m1ThreshLowExt, m2ThreshLowExt;\r\nint m1ThreshExt, m2ThreshExt;\r\ns32 value, value2;\r\nswitch (cmd & ah->ani_function) {\r\ncase ATH9K_ANI_OFDM_WEAK_SIGNAL_DETECTION:{\r\nu32 on = param ? 1 : 0;\r\nif (AR_SREV_9462(ah) || AR_SREV_9565(ah))\r\ngoto skip_ws_det;\r\nm1ThreshLow = on ?\r\naniState->iniDef.m1ThreshLow : m1ThreshLow_off;\r\nm2ThreshLow = on ?\r\naniState->iniDef.m2ThreshLow : m2ThreshLow_off;\r\nm1Thresh = on ?\r\naniState->iniDef.m1Thresh : m1Thresh_off;\r\nm2Thresh = on ?\r\naniState->iniDef.m2Thresh : m2Thresh_off;\r\nm2CountThr = on ?\r\naniState->iniDef.m2CountThr : m2CountThr_off;\r\nm2CountThrLow = on ?\r\naniState->iniDef.m2CountThrLow : m2CountThrLow_off;\r\nm1ThreshLowExt = on ?\r\naniState->iniDef.m1ThreshLowExt : m1ThreshLowExt_off;\r\nm2ThreshLowExt = on ?\r\naniState->iniDef.m2ThreshLowExt : m2ThreshLowExt_off;\r\nm1ThreshExt = on ?\r\naniState->iniDef.m1ThreshExt : m1ThreshExt_off;\r\nm2ThreshExt = on ?\r\naniState->iniDef.m2ThreshExt : m2ThreshExt_off;\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_M1_THRESH_LOW,\r\nm1ThreshLow);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_M2_THRESH_LOW,\r\nm2ThreshLow);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR,\r\nAR_PHY_SFCORR_M1_THRESH,\r\nm1Thresh);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR,\r\nAR_PHY_SFCORR_M2_THRESH,\r\nm2Thresh);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR,\r\nAR_PHY_SFCORR_M2COUNT_THR,\r\nm2CountThr);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_M2COUNT_THR_LOW,\r\nm2CountThrLow);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M1_THRESH_LOW,\r\nm1ThreshLowExt);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M2_THRESH_LOW,\r\nm2ThreshLowExt);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M1_THRESH,\r\nm1ThreshExt);\r\nREG_RMW_FIELD(ah, AR_PHY_SFCORR_EXT,\r\nAR_PHY_SFCORR_EXT_M2_THRESH,\r\nm2ThreshExt);\r\nskip_ws_det:\r\nif (on)\r\nREG_SET_BIT(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\r\nelse\r\nREG_CLR_BIT(ah, AR_PHY_SFCORR_LOW,\r\nAR_PHY_SFCORR_LOW_USE_SELF_CORR_LOW);\r\nif (on != aniState->ofdmWeakSigDetect) {\r\nath_dbg(common, ANI,\r\n"** ch %d: ofdm weak signal: %s=>%s\n",\r\nchan->channel,\r\naniState->ofdmWeakSigDetect ?\r\n"on" : "off",\r\non ? "on" : "off");\r\nif (on)\r\nah->stats.ast_ani_ofdmon++;\r\nelse\r\nah->stats.ast_ani_ofdmoff++;\r\naniState->ofdmWeakSigDetect = on;\r\n}\r\nbreak;\r\n}\r\ncase ATH9K_ANI_FIRSTEP_LEVEL:{\r\nu32 level = param;\r\nif (level >= ARRAY_SIZE(firstep_table)) {\r\nath_dbg(common, ANI,\r\n"ATH9K_ANI_FIRSTEP_LEVEL: level out of range (%u > %zu)\n",\r\nlevel, ARRAY_SIZE(firstep_table));\r\nreturn false;\r\n}\r\nvalue = firstep_table[level] -\r\nfirstep_table[ATH9K_ANI_FIRSTEP_LVL] +\r\naniState->iniDef.firstep;\r\nif (value < ATH9K_SIG_FIRSTEP_SETTING_MIN)\r\nvalue = ATH9K_SIG_FIRSTEP_SETTING_MIN;\r\nif (value > ATH9K_SIG_FIRSTEP_SETTING_MAX)\r\nvalue = ATH9K_SIG_FIRSTEP_SETTING_MAX;\r\nREG_RMW_FIELD(ah, AR_PHY_FIND_SIG,\r\nAR_PHY_FIND_SIG_FIRSTEP,\r\nvalue);\r\nvalue2 = firstep_table[level] -\r\nfirstep_table[ATH9K_ANI_FIRSTEP_LVL] +\r\naniState->iniDef.firstepLow;\r\nif (value2 < ATH9K_SIG_FIRSTEP_SETTING_MIN)\r\nvalue2 = ATH9K_SIG_FIRSTEP_SETTING_MIN;\r\nif (value2 > ATH9K_SIG_FIRSTEP_SETTING_MAX)\r\nvalue2 = ATH9K_SIG_FIRSTEP_SETTING_MAX;\r\nREG_RMW_FIELD(ah, AR_PHY_FIND_SIG_LOW,\r\nAR_PHY_FIND_SIG_LOW_FIRSTEP_LOW, value2);\r\nif (level != aniState->firstepLevel) {\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] firstep[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->firstepLevel,\r\nlevel,\r\nATH9K_ANI_FIRSTEP_LVL,\r\nvalue,\r\naniState->iniDef.firstep);\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] firstep_low[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->firstepLevel,\r\nlevel,\r\nATH9K_ANI_FIRSTEP_LVL,\r\nvalue2,\r\naniState->iniDef.firstepLow);\r\nif (level > aniState->firstepLevel)\r\nah->stats.ast_ani_stepup++;\r\nelse if (level < aniState->firstepLevel)\r\nah->stats.ast_ani_stepdown++;\r\naniState->firstepLevel = level;\r\n}\r\nbreak;\r\n}\r\ncase ATH9K_ANI_SPUR_IMMUNITY_LEVEL:{\r\nu32 level = param;\r\nif (level >= ARRAY_SIZE(cycpwrThr1_table)) {\r\nath_dbg(common, ANI,\r\n"ATH9K_ANI_SPUR_IMMUNITY_LEVEL: level out of range (%u > %zu)\n",\r\nlevel, ARRAY_SIZE(cycpwrThr1_table));\r\nreturn false;\r\n}\r\nvalue = cycpwrThr1_table[level] -\r\ncycpwrThr1_table[ATH9K_ANI_SPUR_IMMUNE_LVL] +\r\naniState->iniDef.cycpwrThr1;\r\nif (value < ATH9K_SIG_SPUR_IMM_SETTING_MIN)\r\nvalue = ATH9K_SIG_SPUR_IMM_SETTING_MIN;\r\nif (value > ATH9K_SIG_SPUR_IMM_SETTING_MAX)\r\nvalue = ATH9K_SIG_SPUR_IMM_SETTING_MAX;\r\nREG_RMW_FIELD(ah, AR_PHY_TIMING5,\r\nAR_PHY_TIMING5_CYCPWR_THR1,\r\nvalue);\r\nvalue2 = cycpwrThr1_table[level] -\r\ncycpwrThr1_table[ATH9K_ANI_SPUR_IMMUNE_LVL] +\r\naniState->iniDef.cycpwrThr1Ext;\r\nif (value2 < ATH9K_SIG_SPUR_IMM_SETTING_MIN)\r\nvalue2 = ATH9K_SIG_SPUR_IMM_SETTING_MIN;\r\nif (value2 > ATH9K_SIG_SPUR_IMM_SETTING_MAX)\r\nvalue2 = ATH9K_SIG_SPUR_IMM_SETTING_MAX;\r\nREG_RMW_FIELD(ah, AR_PHY_EXT_CCA,\r\nAR_PHY_EXT_CYCPWR_THR1, value2);\r\nif (level != aniState->spurImmunityLevel) {\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] cycpwrThr1[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->spurImmunityLevel,\r\nlevel,\r\nATH9K_ANI_SPUR_IMMUNE_LVL,\r\nvalue,\r\naniState->iniDef.cycpwrThr1);\r\nath_dbg(common, ANI,\r\n"** ch %d: level %d=>%d[def:%d] cycpwrThr1Ext[level]=%d ini=%d\n",\r\nchan->channel,\r\naniState->spurImmunityLevel,\r\nlevel,\r\nATH9K_ANI_SPUR_IMMUNE_LVL,\r\nvalue2,\r\naniState->iniDef.cycpwrThr1Ext);\r\nif (level > aniState->spurImmunityLevel)\r\nah->stats.ast_ani_spurup++;\r\nelse if (level < aniState->spurImmunityLevel)\r\nah->stats.ast_ani_spurdown++;\r\naniState->spurImmunityLevel = level;\r\n}\r\nbreak;\r\n}\r\ncase ATH9K_ANI_MRC_CCK:{\r\nbool is_on = param ? 1 : 0;\r\nif (ah->caps.rx_chainmask == 1)\r\nbreak;\r\nREG_RMW_FIELD(ah, AR_PHY_MRC_CCK_CTRL,\r\nAR_PHY_MRC_CCK_ENABLE, is_on);\r\nREG_RMW_FIELD(ah, AR_PHY_MRC_CCK_CTRL,\r\nAR_PHY_MRC_CCK_MUX_REG, is_on);\r\nif (is_on != aniState->mrcCCK) {\r\nath_dbg(common, ANI, "** ch %d: MRC CCK: %s=>%s\n",\r\nchan->channel,\r\naniState->mrcCCK ? "on" : "off",\r\nis_on ? "on" : "off");\r\nif (is_on)\r\nah->stats.ast_ani_ccklow++;\r\nelse\r\nah->stats.ast_ani_cckhigh++;\r\naniState->mrcCCK = is_on;\r\n}\r\nbreak;\r\n}\r\ndefault:\r\nath_dbg(common, ANI, "invalid cmd %u\n", cmd);\r\nreturn false;\r\n}\r\nath_dbg(common, ANI,\r\n"ANI parameters: SI=%d, ofdmWS=%s FS=%d MRCcck=%s listenTime=%d ofdmErrs=%d cckErrs=%d\n",\r\naniState->spurImmunityLevel,\r\naniState->ofdmWeakSigDetect ? "on" : "off",\r\naniState->firstepLevel,\r\naniState->mrcCCK ? "on" : "off",\r\naniState->listenTime,\r\naniState->ofdmPhyErrCount,\r\naniState->cckPhyErrCount);\r\nreturn true;\r\n}\r\nstatic void ar9003_hw_do_getnf(struct ath_hw *ah,\r\nint16_t nfarray[NUM_NF_READINGS])\r\n{\r\n#define AR_PHY_CH_MINCCA_PWR 0x1FF00000\r\n#define AR_PHY_CH_MINCCA_PWR_S 20\r\n#define AR_PHY_CH_EXT_MINCCA_PWR 0x01FF0000\r\n#define AR_PHY_CH_EXT_MINCCA_PWR_S 16\r\nint16_t nf;\r\nint i;\r\nfor (i = 0; i < AR9300_MAX_CHAINS; i++) {\r\nif (ah->rxchainmask & BIT(i)) {\r\nnf = MS(REG_READ(ah, ah->nf_regs[i]),\r\nAR_PHY_CH_MINCCA_PWR);\r\nnfarray[i] = sign_extend32(nf, 8);\r\nif (IS_CHAN_HT40(ah->curchan)) {\r\nu8 ext_idx = AR9300_MAX_CHAINS + i;\r\nnf = MS(REG_READ(ah, ah->nf_regs[ext_idx]),\r\nAR_PHY_CH_EXT_MINCCA_PWR);\r\nnfarray[ext_idx] = sign_extend32(nf, 8);\r\n}\r\n}\r\n}\r\n}\r\nstatic void ar9003_hw_set_nf_limits(struct ath_hw *ah)\r\n{\r\nah->nf_2g.max = AR_PHY_CCA_MAX_GOOD_VAL_9300_2GHZ;\r\nah->nf_2g.min = AR_PHY_CCA_MIN_GOOD_VAL_9300_2GHZ;\r\nah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_9300_2GHZ;\r\nah->nf_5g.max = AR_PHY_CCA_MAX_GOOD_VAL_9300_5GHZ;\r\nah->nf_5g.min = AR_PHY_CCA_MIN_GOOD_VAL_9300_5GHZ;\r\nah->nf_5g.nominal = AR_PHY_CCA_NOM_VAL_9300_5GHZ;\r\nif (AR_SREV_9330(ah))\r\nah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_9330_2GHZ;\r\nif (AR_SREV_9462(ah) || AR_SREV_9565(ah)) {\r\nah->nf_2g.min = AR_PHY_CCA_MIN_GOOD_VAL_9462_2GHZ;\r\nah->nf_2g.nominal = AR_PHY_CCA_NOM_VAL_9462_2GHZ;\r\nah->nf_5g.min = AR_PHY_CCA_MIN_GOOD_VAL_9462_5GHZ;\r\nah->nf_5g.nominal = AR_PHY_CCA_NOM_VAL_9462_5GHZ;\r\n}\r\n}\r\nstatic void ar9003_hw_ani_cache_ini_regs(struct ath_hw *ah)\r\n{\r\nstruct ar5416AniState *aniState;\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nstruct ath9k_channel *chan = ah->curchan;\r\nstruct ath9k_ani_default *iniDef;\r\nu32 val;\r\naniState = &ah->ani;\r\niniDef = &aniState->iniDef;\r\nath_dbg(common, ANI, "ver %d.%d opmode %u chan %d Mhz\n",\r\nah->hw_version.macVersion,\r\nah->hw_version.macRev,\r\nah->opmode,\r\nchan->channel);\r\nval = REG_READ(ah, AR_PHY_SFCORR);\r\niniDef->m1Thresh = MS(val, AR_PHY_SFCORR_M1_THRESH);\r\niniDef->m2Thresh = MS(val, AR_PHY_SFCORR_M2_THRESH);\r\niniDef->m2CountThr = MS(val, AR_PHY_SFCORR_M2COUNT_THR);\r\nval = REG_READ(ah, AR_PHY_SFCORR_LOW);\r\niniDef->m1ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M1_THRESH_LOW);\r\niniDef->m2ThreshLow = MS(val, AR_PHY_SFCORR_LOW_M2_THRESH_LOW);\r\niniDef->m2CountThrLow = MS(val, AR_PHY_SFCORR_LOW_M2COUNT_THR_LOW);\r\nval = REG_READ(ah, AR_PHY_SFCORR_EXT);\r\niniDef->m1ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH);\r\niniDef->m2ThreshExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH);\r\niniDef->m1ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M1_THRESH_LOW);\r\niniDef->m2ThreshLowExt = MS(val, AR_PHY_SFCORR_EXT_M2_THRESH_LOW);\r\niniDef->firstep = REG_READ_FIELD(ah,\r\nAR_PHY_FIND_SIG,\r\nAR_PHY_FIND_SIG_FIRSTEP);\r\niniDef->firstepLow = REG_READ_FIELD(ah,\r\nAR_PHY_FIND_SIG_LOW,\r\nAR_PHY_FIND_SIG_LOW_FIRSTEP_LOW);\r\niniDef->cycpwrThr1 = REG_READ_FIELD(ah,\r\nAR_PHY_TIMING5,\r\nAR_PHY_TIMING5_CYCPWR_THR1);\r\niniDef->cycpwrThr1Ext = REG_READ_FIELD(ah,\r\nAR_PHY_EXT_CCA,\r\nAR_PHY_EXT_CYCPWR_THR1);\r\naniState->spurImmunityLevel = ATH9K_ANI_SPUR_IMMUNE_LVL;\r\naniState->firstepLevel = ATH9K_ANI_FIRSTEP_LVL;\r\naniState->ofdmWeakSigDetect = true;\r\naniState->mrcCCK = true;\r\n}\r\nstatic void ar9003_hw_set_radar_params(struct ath_hw *ah,\r\nstruct ath_hw_radar_conf *conf)\r\n{\r\nunsigned int regWrites = 0;\r\nu32 radar_0 = 0, radar_1 = 0;\r\nif (!conf) {\r\nREG_CLR_BIT(ah, AR_PHY_RADAR_0, AR_PHY_RADAR_0_ENA);\r\nreturn;\r\n}\r\nradar_0 |= AR_PHY_RADAR_0_ENA | AR_PHY_RADAR_0_FFT_ENA;\r\nradar_0 |= SM(conf->fir_power, AR_PHY_RADAR_0_FIRPWR);\r\nradar_0 |= SM(conf->radar_rssi, AR_PHY_RADAR_0_RRSSI);\r\nradar_0 |= SM(conf->pulse_height, AR_PHY_RADAR_0_HEIGHT);\r\nradar_0 |= SM(conf->pulse_rssi, AR_PHY_RADAR_0_PRSSI);\r\nradar_0 |= SM(conf->pulse_inband, AR_PHY_RADAR_0_INBAND);\r\nradar_1 |= AR_PHY_RADAR_1_MAX_RRSSI;\r\nradar_1 |= AR_PHY_RADAR_1_BLOCK_CHECK;\r\nradar_1 |= SM(conf->pulse_maxlen, AR_PHY_RADAR_1_MAXLEN);\r\nradar_1 |= SM(conf->pulse_inband_step, AR_PHY_RADAR_1_RELSTEP_THRESH);\r\nradar_1 |= SM(conf->radar_inband, AR_PHY_RADAR_1_RELPWR_THRESH);\r\nREG_WRITE(ah, AR_PHY_RADAR_0, radar_0);\r\nREG_WRITE(ah, AR_PHY_RADAR_1, radar_1);\r\nif (conf->ext_channel)\r\nREG_SET_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\r\nelse\r\nREG_CLR_BIT(ah, AR_PHY_RADAR_EXT, AR_PHY_RADAR_EXT_ENA);\r\nif (AR_SREV_9300(ah) || AR_SREV_9340(ah) || AR_SREV_9580(ah)) {\r\nREG_WRITE_ARRAY(&ah->ini_dfs,\r\nIS_CHAN_HT40(ah->curchan) ? 2 : 1, regWrites);\r\n}\r\n}\r\nstatic void ar9003_hw_set_radar_conf(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_radar_conf *conf = &ah->radar_conf;\r\nconf->fir_power = -28;\r\nconf->radar_rssi = 0;\r\nconf->pulse_height = 10;\r\nconf->pulse_rssi = 24;\r\nconf->pulse_inband = 8;\r\nconf->pulse_maxlen = 255;\r\nconf->pulse_inband_step = 12;\r\nconf->radar_inband = 8;\r\n}\r\nstatic void ar9003_hw_antdiv_comb_conf_get(struct ath_hw *ah,\r\nstruct ath_hw_antcomb_conf *antconf)\r\n{\r\nu32 regval;\r\nregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\r\nantconf->main_lna_conf = (regval & AR_PHY_ANT_DIV_MAIN_LNACONF) >>\r\nAR_PHY_ANT_DIV_MAIN_LNACONF_S;\r\nantconf->alt_lna_conf = (regval & AR_PHY_ANT_DIV_ALT_LNACONF) >>\r\nAR_PHY_ANT_DIV_ALT_LNACONF_S;\r\nantconf->fast_div_bias = (regval & AR_PHY_ANT_FAST_DIV_BIAS) >>\r\nAR_PHY_ANT_FAST_DIV_BIAS_S;\r\nif (AR_SREV_9330_11(ah)) {\r\nantconf->lna1_lna2_switch_delta = -1;\r\nantconf->lna1_lna2_delta = -9;\r\nantconf->div_group = 1;\r\n} else if (AR_SREV_9485(ah)) {\r\nantconf->lna1_lna2_switch_delta = -1;\r\nantconf->lna1_lna2_delta = -9;\r\nantconf->div_group = 2;\r\n} else if (AR_SREV_9565(ah)) {\r\nantconf->lna1_lna2_switch_delta = 3;\r\nantconf->lna1_lna2_delta = -9;\r\nantconf->div_group = 3;\r\n} else {\r\nantconf->lna1_lna2_switch_delta = -1;\r\nantconf->lna1_lna2_delta = -3;\r\nantconf->div_group = 0;\r\n}\r\n}\r\nstatic void ar9003_hw_antdiv_comb_conf_set(struct ath_hw *ah,\r\nstruct ath_hw_antcomb_conf *antconf)\r\n{\r\nu32 regval;\r\nregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\r\nregval &= ~(AR_PHY_ANT_DIV_MAIN_LNACONF |\r\nAR_PHY_ANT_DIV_ALT_LNACONF |\r\nAR_PHY_ANT_FAST_DIV_BIAS |\r\nAR_PHY_ANT_DIV_MAIN_GAINTB |\r\nAR_PHY_ANT_DIV_ALT_GAINTB);\r\nregval |= ((antconf->main_lna_conf << AR_PHY_ANT_DIV_MAIN_LNACONF_S)\r\n& AR_PHY_ANT_DIV_MAIN_LNACONF);\r\nregval |= ((antconf->alt_lna_conf << AR_PHY_ANT_DIV_ALT_LNACONF_S)\r\n& AR_PHY_ANT_DIV_ALT_LNACONF);\r\nregval |= ((antconf->fast_div_bias << AR_PHY_ANT_FAST_DIV_BIAS_S)\r\n& AR_PHY_ANT_FAST_DIV_BIAS);\r\nregval |= ((antconf->main_gaintb << AR_PHY_ANT_DIV_MAIN_GAINTB_S)\r\n& AR_PHY_ANT_DIV_MAIN_GAINTB);\r\nregval |= ((antconf->alt_gaintb << AR_PHY_ANT_DIV_ALT_GAINTB_S)\r\n& AR_PHY_ANT_DIV_ALT_GAINTB);\r\nREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\r\n}\r\nstatic void ar9003_hw_set_bt_ant_diversity(struct ath_hw *ah, bool enable)\r\n{\r\nstruct ath9k_hw_capabilities *pCap = &ah->caps;\r\nu8 ant_div_ctl1;\r\nu32 regval;\r\nif (!AR_SREV_9485(ah) && !AR_SREV_9565(ah))\r\nreturn;\r\nif (AR_SREV_9485(ah)) {\r\nregval = ar9003_hw_ant_ctrl_common_2_get(ah,\r\nIS_CHAN_2GHZ(ah->curchan));\r\nif (enable) {\r\nregval &= ~AR_SWITCH_TABLE_COM2_ALL;\r\nregval |= ah->config.ant_ctrl_comm2g_switch_enable;\r\n}\r\nREG_RMW_FIELD(ah, AR_PHY_SWITCH_COM_2,\r\nAR_SWITCH_TABLE_COM2_ALL, regval);\r\n}\r\nant_div_ctl1 = ah->eep_ops->get_eeprom(ah, EEP_ANT_DIV_CTL1);\r\nregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\r\nregval &= (~AR_ANT_DIV_CTRL_ALL);\r\nregval |= (ant_div_ctl1 & 0x3f) << AR_ANT_DIV_CTRL_ALL_S;\r\nREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\r\nif (AR_SREV_9485_11_OR_LATER(ah)) {\r\nregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\r\nregval &= ~AR_PHY_ANT_DIV_LNADIV;\r\nregval |= ((ant_div_ctl1 >> 6) & 0x1) << AR_PHY_ANT_DIV_LNADIV_S;\r\nif (enable)\r\nregval |= AR_ANT_DIV_ENABLE;\r\nREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\r\nregval = REG_READ(ah, AR_PHY_CCK_DETECT);\r\nregval &= ~AR_FAST_DIV_ENABLE;\r\nregval |= ((ant_div_ctl1 >> 7) & 0x1) << AR_FAST_DIV_ENABLE_S;\r\nif (enable)\r\nregval |= AR_FAST_DIV_ENABLE;\r\nREG_WRITE(ah, AR_PHY_CCK_DETECT, regval);\r\nif (pCap->hw_caps & ATH9K_HW_CAP_ANT_DIV_COMB) {\r\nregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\r\nregval &= (~(AR_PHY_ANT_DIV_MAIN_LNACONF |\r\nAR_PHY_ANT_DIV_ALT_LNACONF |\r\nAR_PHY_ANT_DIV_ALT_GAINTB |\r\nAR_PHY_ANT_DIV_MAIN_GAINTB));\r\nregval |= (ATH_ANT_DIV_COMB_LNA1 <<\r\nAR_PHY_ANT_DIV_MAIN_LNACONF_S);\r\nregval |= (ATH_ANT_DIV_COMB_LNA2 <<\r\nAR_PHY_ANT_DIV_ALT_LNACONF_S);\r\nREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\r\n}\r\n} else if (AR_SREV_9565(ah)) {\r\nif (enable) {\r\nREG_SET_BIT(ah, AR_PHY_MC_GAIN_CTRL,\r\nAR_ANT_DIV_ENABLE);\r\nREG_SET_BIT(ah, AR_PHY_MC_GAIN_CTRL,\r\n(1 << AR_PHY_ANT_SW_RX_PROT_S));\r\nREG_SET_BIT(ah, AR_PHY_CCK_DETECT,\r\nAR_FAST_DIV_ENABLE);\r\nREG_SET_BIT(ah, AR_PHY_RESTART,\r\nAR_PHY_RESTART_ENABLE_DIV_M2FLAG);\r\nREG_SET_BIT(ah, AR_BTCOEX_WL_LNADIV,\r\nAR_BTCOEX_WL_LNADIV_FORCE_ON);\r\n} else {\r\nREG_CLR_BIT(ah, AR_PHY_MC_GAIN_CTRL,\r\nAR_ANT_DIV_ENABLE);\r\nREG_CLR_BIT(ah, AR_PHY_MC_GAIN_CTRL,\r\n(1 << AR_PHY_ANT_SW_RX_PROT_S));\r\nREG_CLR_BIT(ah, AR_PHY_CCK_DETECT,\r\nAR_FAST_DIV_ENABLE);\r\nREG_CLR_BIT(ah, AR_PHY_RESTART,\r\nAR_PHY_RESTART_ENABLE_DIV_M2FLAG);\r\nREG_CLR_BIT(ah, AR_BTCOEX_WL_LNADIV,\r\nAR_BTCOEX_WL_LNADIV_FORCE_ON);\r\nregval = REG_READ(ah, AR_PHY_MC_GAIN_CTRL);\r\nregval &= ~(AR_PHY_ANT_DIV_MAIN_LNACONF |\r\nAR_PHY_ANT_DIV_ALT_LNACONF |\r\nAR_PHY_ANT_DIV_MAIN_GAINTB |\r\nAR_PHY_ANT_DIV_ALT_GAINTB);\r\nregval |= (ATH_ANT_DIV_COMB_LNA1 <<\r\nAR_PHY_ANT_DIV_MAIN_LNACONF_S);\r\nregval |= (ATH_ANT_DIV_COMB_LNA2 <<\r\nAR_PHY_ANT_DIV_ALT_LNACONF_S);\r\nREG_WRITE(ah, AR_PHY_MC_GAIN_CTRL, regval);\r\n}\r\n}\r\n}\r\nstatic int ar9003_hw_fast_chan_change(struct ath_hw *ah,\r\nstruct ath9k_channel *chan,\r\nu8 *ini_reloaded)\r\n{\r\nunsigned int regWrites = 0;\r\nu32 modesIndex;\r\nif (IS_CHAN_5GHZ(chan))\r\nmodesIndex = IS_CHAN_HT40(chan) ? 2 : 1;\r\nelse\r\nmodesIndex = IS_CHAN_HT40(chan) ? 3 : 4;\r\nif (modesIndex == ah->modes_index) {\r\n*ini_reloaded = false;\r\ngoto set_rfmode;\r\n}\r\nar9003_hw_prog_ini(ah, &ah->iniSOC[ATH_INI_POST], modesIndex);\r\nar9003_hw_prog_ini(ah, &ah->iniMac[ATH_INI_POST], modesIndex);\r\nar9003_hw_prog_ini(ah, &ah->iniBB[ATH_INI_POST], modesIndex);\r\nar9003_hw_prog_ini(ah, &ah->iniRadio[ATH_INI_POST], modesIndex);\r\nif (AR_SREV_9462_20_OR_LATER(ah))\r\nar9003_hw_prog_ini(ah, &ah->ini_radio_post_sys2ant,\r\nmodesIndex);\r\nREG_WRITE_ARRAY(&ah->iniModesTxGain, modesIndex, regWrites);\r\nif (AR_SREV_9462_20_OR_LATER(ah)) {\r\nif (ar9003_hw_get_rx_gain_idx(ah) == 2) {\r\nREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_core,\r\n1, regWrites);\r\nREG_WRITE_ARRAY(&ah->ini_modes_rxgain_bb_postamble,\r\nmodesIndex, regWrites);\r\n}\r\n}\r\nif (IS_CHAN_A_FAST_CLOCK(ah, chan))\r\nREG_WRITE_ARRAY(&ah->iniModesFastClock, modesIndex, regWrites);\r\nif (AR_SREV_9565(ah))\r\nREG_WRITE_ARRAY(&ah->iniModesFastClock, 1, regWrites);\r\nif (chan->channel == 2484)\r\nar9003_hw_prog_ini(ah, &ah->iniCckfirJapan2484, 1);\r\nah->modes_index = modesIndex;\r\n*ini_reloaded = true;\r\nset_rfmode:\r\nar9003_hw_set_rfmode(ah, chan);\r\nreturn 0;\r\n}\r\nstatic void ar9003_hw_spectral_scan_config(struct ath_hw *ah,\r\nstruct ath_spec_scan *param)\r\n{\r\nu8 count;\r\nif (!param->enabled) {\r\nREG_CLR_BIT(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_ENABLE);\r\nreturn;\r\n}\r\nREG_SET_BIT(ah, AR_PHY_RADAR_0, AR_PHY_RADAR_0_FFT_ENA);\r\nREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN, AR_PHY_SPECTRAL_SCAN_ENABLE);\r\ncount = param->count;\r\nif (param->endless)\r\ncount = 0;\r\nelse if (param->count == 0)\r\ncount = 1;\r\nif (param->short_repeat)\r\nREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_SHORT_REPEAT);\r\nelse\r\nREG_CLR_BIT(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_SHORT_REPEAT);\r\nREG_RMW_FIELD(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_COUNT, count);\r\nREG_RMW_FIELD(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_PERIOD, param->period);\r\nREG_RMW_FIELD(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_FFT_PERIOD, param->fft_period);\r\nreturn;\r\n}\r\nstatic void ar9003_hw_spectral_scan_trigger(struct ath_hw *ah)\r\n{\r\nREG_SET_BIT(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_ACTIVE);\r\n}\r\nstatic void ar9003_hw_spectral_scan_wait(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nif (!ath9k_hw_wait(ah, AR_PHY_SPECTRAL_SCAN,\r\nAR_PHY_SPECTRAL_SCAN_ACTIVE,\r\n0, AH_WAIT_TIMEOUT)) {\r\nath_err(common, "spectral scan wait failed\n");\r\nreturn;\r\n}\r\n}\r\nstatic void ar9003_hw_tx99_start(struct ath_hw *ah, u32 qnum)\r\n{\r\nREG_SET_BIT(ah, AR_PHY_TEST, PHY_AGC_CLR);\r\nREG_SET_BIT(ah, 0x9864, 0x7f000);\r\nREG_SET_BIT(ah, 0x9924, 0x7f00fe);\r\nREG_CLR_BIT(ah, AR_DIAG_SW, AR_DIAG_RX_DIS);\r\nREG_WRITE(ah, AR_CR, AR_CR_RXD);\r\nREG_WRITE(ah, AR_DLCL_IFS(qnum), 0);\r\nREG_WRITE(ah, AR_D_GBL_IFS_SIFS, 20);\r\nREG_WRITE(ah, AR_D_GBL_IFS_EIFS, 20);\r\nREG_WRITE(ah, AR_TIME_OUT, 0x00000400);\r\nREG_WRITE(ah, AR_DRETRY_LIMIT(qnum), 0xffffffff);\r\nREG_SET_BIT(ah, AR_QMISC(qnum), AR_Q_MISC_DCU_EARLY_TERM_REQ);\r\n}\r\nstatic void ar9003_hw_tx99_stop(struct ath_hw *ah)\r\n{\r\nREG_CLR_BIT(ah, AR_PHY_TEST, PHY_AGC_CLR);\r\nREG_SET_BIT(ah, AR_DIAG_SW, AR_DIAG_RX_DIS);\r\n}\r\nstatic void ar9003_hw_tx99_set_txpower(struct ath_hw *ah, u8 txpower)\r\n{\r\nstatic s16 p_pwr_array[ar9300RateSize] = { 0 };\r\nunsigned int i;\r\nif (txpower <= MAX_RATE_POWER) {\r\nfor (i = 0; i < ar9300RateSize; i++)\r\np_pwr_array[i] = txpower;\r\n} else {\r\nfor (i = 0; i < ar9300RateSize; i++)\r\np_pwr_array[i] = MAX_RATE_POWER;\r\n}\r\nREG_WRITE(ah, 0xa458, 0);\r\nREG_WRITE(ah, 0xa3c0,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_6_24], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_6_24], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_6_24], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_6_24], 0));\r\nREG_WRITE(ah, 0xa3c4,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_54], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_48], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_36], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_6_24], 0));\r\nREG_WRITE(ah, 0xa3c8,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_1L_5L], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_1L_5L], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_1L_5L], 0));\r\nREG_WRITE(ah, 0xa3cc,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_11S], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_11L], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_5S], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_LEGACY_1L_5L], 0));\r\nREG_WRITE(ah, 0xa3d0,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_5], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_4], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_1_3_9_11_17_19], 8)|\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_0_8_16], 0));\r\nREG_WRITE(ah, 0xa3d4,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_13], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_12], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_7], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_6], 0));\r\nREG_WRITE(ah, 0xa3e4,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_21], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_20], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_15], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_14], 0));\r\nREG_WRITE(ah, 0xa3e8,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_23], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_22], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_23], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT20_22], 0));\r\nREG_WRITE(ah, 0xa3d8,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_5], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_4], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_1_3_9_11_17_19], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_0_8_16], 0));\r\nREG_WRITE(ah, 0xa3dc,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_13], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_12], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_7], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_6], 0));\r\nREG_WRITE(ah, 0xa3ec,\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_21], 24) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_20], 16) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_15], 8) |\r\nATH9K_POW_SM(p_pwr_array[ALL_TARGET_HT40_14], 0));\r\n}\r\nvoid ar9003_hw_attach_phy_ops(struct ath_hw *ah)\r\n{\r\nstruct ath_hw_private_ops *priv_ops = ath9k_hw_private_ops(ah);\r\nstruct ath_hw_ops *ops = ath9k_hw_ops(ah);\r\nstatic const u32 ar9300_cca_regs[6] = {\r\nAR_PHY_CCA_0,\r\nAR_PHY_CCA_1,\r\nAR_PHY_CCA_2,\r\nAR_PHY_EXT_CCA,\r\nAR_PHY_EXT_CCA_1,\r\nAR_PHY_EXT_CCA_2,\r\n};\r\npriv_ops->rf_set_freq = ar9003_hw_set_channel;\r\npriv_ops->spur_mitigate_freq = ar9003_hw_spur_mitigate;\r\npriv_ops->compute_pll_control = ar9003_hw_compute_pll_control;\r\npriv_ops->set_channel_regs = ar9003_hw_set_channel_regs;\r\npriv_ops->init_bb = ar9003_hw_init_bb;\r\npriv_ops->process_ini = ar9003_hw_process_ini;\r\npriv_ops->set_rfmode = ar9003_hw_set_rfmode;\r\npriv_ops->mark_phy_inactive = ar9003_hw_mark_phy_inactive;\r\npriv_ops->set_delta_slope = ar9003_hw_set_delta_slope;\r\npriv_ops->rfbus_req = ar9003_hw_rfbus_req;\r\npriv_ops->rfbus_done = ar9003_hw_rfbus_done;\r\npriv_ops->ani_control = ar9003_hw_ani_control;\r\npriv_ops->do_getnf = ar9003_hw_do_getnf;\r\npriv_ops->ani_cache_ini_regs = ar9003_hw_ani_cache_ini_regs;\r\npriv_ops->set_radar_params = ar9003_hw_set_radar_params;\r\npriv_ops->fast_chan_change = ar9003_hw_fast_chan_change;\r\nops->antdiv_comb_conf_get = ar9003_hw_antdiv_comb_conf_get;\r\nops->antdiv_comb_conf_set = ar9003_hw_antdiv_comb_conf_set;\r\nops->spectral_scan_config = ar9003_hw_spectral_scan_config;\r\nops->spectral_scan_trigger = ar9003_hw_spectral_scan_trigger;\r\nops->spectral_scan_wait = ar9003_hw_spectral_scan_wait;\r\n#ifdef CONFIG_ATH9K_BTCOEX_SUPPORT\r\nops->set_bt_ant_diversity = ar9003_hw_set_bt_ant_diversity;\r\n#endif\r\nops->tx99_start = ar9003_hw_tx99_start;\r\nops->tx99_stop = ar9003_hw_tx99_stop;\r\nops->tx99_set_txpower = ar9003_hw_tx99_set_txpower;\r\nar9003_hw_set_nf_limits(ah);\r\nar9003_hw_set_radar_conf(ah);\r\nmemcpy(ah->nf_regs, ar9300_cca_regs, sizeof(ah->nf_regs));\r\n}\r\nbool ar9003_hw_bb_watchdog_check(struct ath_hw *ah)\r\n{\r\nu32 val;\r\nswitch(ah->bb_watchdog_last_status) {\r\ncase 0x04000539:\r\nval = REG_READ(ah, AR_PHY_RADAR_0);\r\nval &= (~AR_PHY_RADAR_0_FIRPWR);\r\nval |= SM(0x7f, AR_PHY_RADAR_0_FIRPWR);\r\nREG_WRITE(ah, AR_PHY_RADAR_0, val);\r\nudelay(1);\r\nval = REG_READ(ah, AR_PHY_RADAR_0);\r\nval &= ~AR_PHY_RADAR_0_FIRPWR;\r\nval |= SM(AR9300_DFS_FIRPWR, AR_PHY_RADAR_0_FIRPWR);\r\nREG_WRITE(ah, AR_PHY_RADAR_0, val);\r\nreturn false;\r\ncase 0x1300000a:\r\nreturn false;\r\ncase 0x0400000a:\r\ncase 0x04000b09:\r\nreturn true;\r\ncase 0x04000409:\r\nif (AR_SREV_9340(ah) || AR_SREV_9531(ah))\r\nreturn false;\r\nelse\r\nreturn true;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nvoid ar9003_hw_bb_watchdog_config(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 idle_tmo_ms = ah->bb_watchdog_timeout_ms;\r\nu32 val, idle_count;\r\nif (!idle_tmo_ms) {\r\nREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_2,\r\nREG_READ(ah, AR_PHY_WATCHDOG_CTL_2) &\r\n~(AR_PHY_WATCHDOG_RST_ENABLE |\r\nAR_PHY_WATCHDOG_IRQ_ENABLE));\r\nREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_1,\r\nREG_READ(ah, AR_PHY_WATCHDOG_CTL_1) &\r\n~(AR_PHY_WATCHDOG_NON_IDLE_ENABLE |\r\nAR_PHY_WATCHDOG_IDLE_ENABLE));\r\nath_dbg(common, RESET, "Disabled BB Watchdog\n");\r\nreturn;\r\n}\r\nval = REG_READ(ah, AR_PHY_WATCHDOG_CTL_2) & AR_PHY_WATCHDOG_CNTL2_MASK;\r\nREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_2,\r\n(val | AR_PHY_WATCHDOG_IRQ_ENABLE) &\r\n~AR_PHY_WATCHDOG_RST_ENABLE);\r\nif (idle_tmo_ms > 10000)\r\nidle_tmo_ms = 10000;\r\nidle_count = (100 * idle_tmo_ms) / 74;\r\nif (ah->curchan && IS_CHAN_HT40(ah->curchan))\r\nidle_count = (100 * idle_tmo_ms) / 37;\r\nREG_WRITE(ah, AR_PHY_WATCHDOG_CTL_1,\r\nAR_PHY_WATCHDOG_NON_IDLE_ENABLE |\r\nAR_PHY_WATCHDOG_IDLE_MASK |\r\n(AR_PHY_WATCHDOG_NON_IDLE_MASK & (idle_count << 2)));\r\nath_dbg(common, RESET, "Enabled BB Watchdog timeout (%u ms)\n",\r\nidle_tmo_ms);\r\n}\r\nvoid ar9003_hw_bb_watchdog_read(struct ath_hw *ah)\r\n{\r\nah->bb_watchdog_last_status = REG_READ(ah, AR_PHY_WATCHDOG_STATUS);\r\nREG_WRITE(ah, AR_PHY_WATCHDOG_STATUS,\r\nah->bb_watchdog_last_status & ~AR_PHY_WATCHDOG_STATUS_CLR);\r\n}\r\nvoid ar9003_hw_bb_watchdog_dbg_info(struct ath_hw *ah)\r\n{\r\nstruct ath_common *common = ath9k_hw_common(ah);\r\nu32 status;\r\nif (likely(!(common->debug_mask & ATH_DBG_RESET)))\r\nreturn;\r\nstatus = ah->bb_watchdog_last_status;\r\nath_dbg(common, RESET,\r\n"\n==== BB update: BB status=0x%08x ====\n", status);\r\nath_dbg(common, RESET,\r\n"** BB state: wd=%u det=%u rdar=%u rOFDM=%d rCCK=%u tOFDM=%u tCCK=%u agc=%u src=%u **\n",\r\nMS(status, AR_PHY_WATCHDOG_INFO),\r\nMS(status, AR_PHY_WATCHDOG_DET_HANG),\r\nMS(status, AR_PHY_WATCHDOG_RADAR_SM),\r\nMS(status, AR_PHY_WATCHDOG_RX_OFDM_SM),\r\nMS(status, AR_PHY_WATCHDOG_RX_CCK_SM),\r\nMS(status, AR_PHY_WATCHDOG_TX_OFDM_SM),\r\nMS(status, AR_PHY_WATCHDOG_TX_CCK_SM),\r\nMS(status, AR_PHY_WATCHDOG_AGC_SM),\r\nMS(status, AR_PHY_WATCHDOG_SRCH_SM));\r\nath_dbg(common, RESET, "** BB WD cntl: cntl1=0x%08x cntl2=0x%08x **\n",\r\nREG_READ(ah, AR_PHY_WATCHDOG_CTL_1),\r\nREG_READ(ah, AR_PHY_WATCHDOG_CTL_2));\r\nath_dbg(common, RESET, "** BB mode: BB_gen_controls=0x%08x **\n",\r\nREG_READ(ah, AR_PHY_GEN_CTRL));\r\n#define PCT(_field) (common->cc_survey._field * 100 / common->cc_survey.cycles)\r\nif (common->cc_survey.cycles)\r\nath_dbg(common, RESET,\r\n"** BB busy times: rx_clear=%d%%, rx_frame=%d%%, tx_frame=%d%% **\n",\r\nPCT(rx_busy), PCT(rx_frame), PCT(tx_frame));\r\nath_dbg(common, RESET, "==== BB update: done ====\n\n");\r\n}\r\nvoid ar9003_hw_disable_phy_restart(struct ath_hw *ah)\r\n{\r\nu8 result;\r\nu32 val;\r\nresult = MS(ah->bb_watchdog_last_status, AR_PHY_WATCHDOG_RX_OFDM_SM);\r\nif ((result == 0xb) || ah->bb_hang_rx_ofdm) {\r\nah->bb_hang_rx_ofdm = true;\r\nval = REG_READ(ah, AR_PHY_RESTART);\r\nval &= ~AR_PHY_RESTART_ENA;\r\nREG_WRITE(ah, AR_PHY_RESTART, val);\r\n}\r\n}

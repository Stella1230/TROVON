static int wm8728_mute(struct snd_soc_dai *dai, int mute)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nu16 mute_reg = snd_soc_read(codec, WM8728_DACCTL);\r\nif (mute)\r\nsnd_soc_write(codec, WM8728_DACCTL, mute_reg | 1);\r\nelse\r\nsnd_soc_write(codec, WM8728_DACCTL, mute_reg & ~1);\r\nreturn 0;\r\n}\r\nstatic int wm8728_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params,\r\nstruct snd_soc_dai *dai)\r\n{\r\nstruct snd_soc_codec *codec = dai->codec;\r\nu16 dac = snd_soc_read(codec, WM8728_DACCTL);\r\ndac &= ~0x18;\r\nswitch (params_format(params)) {\r\ncase SNDRV_PCM_FORMAT_S16_LE:\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S20_3LE:\r\ndac |= 0x10;\r\nbreak;\r\ncase SNDRV_PCM_FORMAT_S24_LE:\r\ndac |= 0x08;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_write(codec, WM8728_DACCTL, dac);\r\nreturn 0;\r\n}\r\nstatic int wm8728_set_dai_fmt(struct snd_soc_dai *codec_dai,\r\nunsigned int fmt)\r\n{\r\nstruct snd_soc_codec *codec = codec_dai->codec;\r\nu16 iface = snd_soc_read(codec, WM8728_IFCTL);\r\nswitch (fmt & SND_SOC_DAIFMT_FORMAT_MASK) {\r\ncase SND_SOC_DAIFMT_I2S:\r\niface |= 1;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_MASTER_MASK) {\r\ncase SND_SOC_DAIFMT_CBS_CFS:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nswitch (fmt & SND_SOC_DAIFMT_INV_MASK) {\r\ncase SND_SOC_DAIFMT_NB_NF:\r\niface &= ~0x22;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_NF:\r\niface |= 0x20;\r\niface &= ~0x02;\r\nbreak;\r\ncase SND_SOC_DAIFMT_NB_IF:\r\niface |= 0x02;\r\niface &= ~0x20;\r\nbreak;\r\ncase SND_SOC_DAIFMT_IB_IF:\r\niface |= 0x22;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nsnd_soc_write(codec, WM8728_IFCTL, iface);\r\nreturn 0;\r\n}\r\nstatic int wm8728_set_bias_level(struct snd_soc_codec *codec,\r\nenum snd_soc_bias_level level)\r\n{\r\nstruct wm8728_priv *wm8728 = snd_soc_codec_get_drvdata(codec);\r\nu16 reg;\r\nswitch (level) {\r\ncase SND_SOC_BIAS_ON:\r\ncase SND_SOC_BIAS_PREPARE:\r\ncase SND_SOC_BIAS_STANDBY:\r\nif (codec->dapm.bias_level == SND_SOC_BIAS_OFF) {\r\nreg = snd_soc_read(codec, WM8728_DACCTL);\r\nsnd_soc_write(codec, WM8728_DACCTL, reg & ~0x4);\r\nregcache_sync(wm8728->regmap);\r\n}\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nreg = snd_soc_read(codec, WM8728_DACCTL);\r\nsnd_soc_write(codec, WM8728_DACCTL, reg | 0x4);\r\nbreak;\r\n}\r\ncodec->dapm.bias_level = level;\r\nreturn 0;\r\n}\r\nstatic int wm8728_suspend(struct snd_soc_codec *codec)\r\n{\r\nwm8728_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic int wm8728_resume(struct snd_soc_codec *codec)\r\n{\r\nwm8728_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\nreturn 0;\r\n}\r\nstatic int wm8728_probe(struct snd_soc_codec *codec)\r\n{\r\nwm8728_set_bias_level(codec, SND_SOC_BIAS_STANDBY);\r\nreturn 0;\r\n}\r\nstatic int wm8728_remove(struct snd_soc_codec *codec)\r\n{\r\nwm8728_set_bias_level(codec, SND_SOC_BIAS_OFF);\r\nreturn 0;\r\n}\r\nstatic int wm8728_spi_probe(struct spi_device *spi)\r\n{\r\nstruct wm8728_priv *wm8728;\r\nint ret;\r\nwm8728 = devm_kzalloc(&spi->dev, sizeof(struct wm8728_priv),\r\nGFP_KERNEL);\r\nif (wm8728 == NULL)\r\nreturn -ENOMEM;\r\nwm8728->regmap = devm_regmap_init_spi(spi, &wm8728_regmap);\r\nif (IS_ERR(wm8728->regmap))\r\nreturn PTR_ERR(wm8728->regmap);\r\nspi_set_drvdata(spi, wm8728);\r\nret = snd_soc_register_codec(&spi->dev,\r\n&soc_codec_dev_wm8728, &wm8728_dai, 1);\r\nreturn ret;\r\n}\r\nstatic int wm8728_spi_remove(struct spi_device *spi)\r\n{\r\nsnd_soc_unregister_codec(&spi->dev);\r\nreturn 0;\r\n}\r\nstatic int wm8728_i2c_probe(struct i2c_client *i2c,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wm8728_priv *wm8728;\r\nint ret;\r\nwm8728 = devm_kzalloc(&i2c->dev, sizeof(struct wm8728_priv),\r\nGFP_KERNEL);\r\nif (wm8728 == NULL)\r\nreturn -ENOMEM;\r\nwm8728->regmap = devm_regmap_init_i2c(i2c, &wm8728_regmap);\r\nif (IS_ERR(wm8728->regmap))\r\nreturn PTR_ERR(wm8728->regmap);\r\ni2c_set_clientdata(i2c, wm8728);\r\nret = snd_soc_register_codec(&i2c->dev,\r\n&soc_codec_dev_wm8728, &wm8728_dai, 1);\r\nreturn ret;\r\n}\r\nstatic int wm8728_i2c_remove(struct i2c_client *client)\r\n{\r\nsnd_soc_unregister_codec(&client->dev);\r\nreturn 0;\r\n}\r\nstatic int __init wm8728_modinit(void)\r\n{\r\nint ret = 0;\r\n#if IS_ENABLED(CONFIG_I2C)\r\nret = i2c_add_driver(&wm8728_i2c_driver);\r\nif (ret != 0) {\r\nprintk(KERN_ERR "Failed to register wm8728 I2C driver: %d\n",\r\nret);\r\n}\r\n#endif\r\n#if defined(CONFIG_SPI_MASTER)\r\nret = spi_register_driver(&wm8728_spi_driver);\r\nif (ret != 0) {\r\nprintk(KERN_ERR "Failed to register wm8728 SPI driver: %d\n",\r\nret);\r\n}\r\n#endif\r\nreturn ret;\r\n}\r\nstatic void __exit wm8728_exit(void)\r\n{\r\n#if IS_ENABLED(CONFIG_I2C)\r\ni2c_del_driver(&wm8728_i2c_driver);\r\n#endif\r\n#if defined(CONFIG_SPI_MASTER)\r\nspi_unregister_driver(&wm8728_spi_driver);\r\n#endif\r\n}

static inline int lm87_read_value(struct i2c_client *client, u8 reg)\r\n{\r\nreturn i2c_smbus_read_byte_data(client, reg);\r\n}\r\nstatic inline int lm87_write_value(struct i2c_client *client, u8 reg, u8 value)\r\n{\r\nreturn i2c_smbus_write_byte_data(client, reg, value);\r\n}\r\nstatic struct lm87_data *lm87_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ) || !data->valid) {\r\nint i, j;\r\ndev_dbg(&client->dev, "Updating data.\n");\r\ni = (data->channel & CHAN_TEMP3) ? 1 : 0;\r\nj = (data->channel & CHAN_TEMP3) ? 5 : 6;\r\nfor (; i < j; i++) {\r\ndata->in[i] = lm87_read_value(client,\r\nLM87_REG_IN(i));\r\ndata->in_min[i] = lm87_read_value(client,\r\nLM87_REG_IN_MIN(i));\r\ndata->in_max[i] = lm87_read_value(client,\r\nLM87_REG_IN_MAX(i));\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nif (data->channel & CHAN_NO_FAN(i)) {\r\ndata->in[6+i] = lm87_read_value(client,\r\nLM87_REG_AIN(i));\r\ndata->in_max[6+i] = lm87_read_value(client,\r\nLM87_REG_AIN_MAX(i));\r\ndata->in_min[6+i] = lm87_read_value(client,\r\nLM87_REG_AIN_MIN(i));\r\n} else {\r\ndata->fan[i] = lm87_read_value(client,\r\nLM87_REG_FAN(i));\r\ndata->fan_min[i] = lm87_read_value(client,\r\nLM87_REG_FAN_MIN(i));\r\n}\r\n}\r\nj = (data->channel & CHAN_TEMP3) ? 3 : 2;\r\nfor (i = 0 ; i < j; i++) {\r\ndata->temp[i] = lm87_read_value(client,\r\nLM87_REG_TEMP[i]);\r\ndata->temp_high[i] = lm87_read_value(client,\r\nLM87_REG_TEMP_HIGH[i]);\r\ndata->temp_low[i] = lm87_read_value(client,\r\nLM87_REG_TEMP_LOW[i]);\r\n}\r\ni = lm87_read_value(client, LM87_REG_TEMP_HW_INT_LOCK);\r\nj = lm87_read_value(client, LM87_REG_TEMP_HW_INT);\r\ndata->temp_crit_int = min(i, j);\r\ni = lm87_read_value(client, LM87_REG_TEMP_HW_EXT_LOCK);\r\nj = lm87_read_value(client, LM87_REG_TEMP_HW_EXT);\r\ndata->temp_crit_ext = min(i, j);\r\ni = lm87_read_value(client, LM87_REG_VID_FAN_DIV);\r\ndata->fan_div[0] = (i >> 4) & 0x03;\r\ndata->fan_div[1] = (i >> 6) & 0x03;\r\ndata->vid = (i & 0x0F)\r\n| (lm87_read_value(client, LM87_REG_VID4) & 0x01)\r\n<< 4;\r\ndata->alarms = lm87_read_value(client, LM87_REG_ALARMS1)\r\n| (lm87_read_value(client, LM87_REG_ALARMS2)\r\n<< 8);\r\ndata->aout = lm87_read_value(client, LM87_REG_AOUT);\r\ndata->last_updated = jiffies;\r\ndata->valid = 1;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic ssize_t show_in_input(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in[nr],\r\ndata->in_scale[nr]));\r\n}\r\nstatic ssize_t show_in_min(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_min[nr],\r\ndata->in_scale[nr]));\r\n}\r\nstatic ssize_t show_in_max(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u\n", IN_FROM_REG(data->in_max[nr],\r\ndata->in_scale[nr]));\r\n}\r\nstatic ssize_t set_in_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_min[nr] = IN_TO_REG(val, data->in_scale[nr]);\r\nlm87_write_value(client, nr < 6 ? LM87_REG_IN_MIN(nr) :\r\nLM87_REG_AIN_MIN(nr - 6), data->in_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_in_max(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->in_max[nr] = IN_TO_REG(val, data->in_scale[nr]);\r\nlm87_write_value(client, nr < 6 ? LM87_REG_IN_MAX(nr) :\r\nLM87_REG_AIN_MAX(nr - 6), data->in_max[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp_input(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp[nr]));\r\n}\r\nstatic ssize_t show_temp_low(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%d\n",\r\nTEMP_FROM_REG(data->temp_low[nr]));\r\n}\r\nstatic ssize_t show_temp_high(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%d\n",\r\nTEMP_FROM_REG(data->temp_high[nr]));\r\n}\r\nstatic ssize_t set_temp_low(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_low[nr] = TEMP_TO_REG(val);\r\nlm87_write_value(client, LM87_REG_TEMP_LOW[nr], data->temp_low[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_temp_high(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->temp_high[nr] = TEMP_TO_REG(val);\r\nlm87_write_value(client, LM87_REG_TEMP_HIGH[nr], data->temp_high[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_temp_crit_int(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_crit_int));\r\n}\r\nstatic ssize_t show_temp_crit_ext(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nreturn sprintf(buf, "%d\n", TEMP_FROM_REG(data->temp_crit_ext));\r\n}\r\nstatic ssize_t show_fan_input(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%d\n", FAN_FROM_REG(data->fan[nr],\r\nFAN_DIV_FROM_REG(data->fan_div[nr])));\r\n}\r\nstatic ssize_t show_fan_min(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%d\n", FAN_FROM_REG(data->fan_min[nr],\r\nFAN_DIV_FROM_REG(data->fan_div[nr])));\r\n}\r\nstatic ssize_t show_fan_div(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%d\n",\r\nFAN_DIV_FROM_REG(data->fan_div[nr]));\r\n}\r\nstatic ssize_t set_fan_min(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->fan_min[nr] = FAN_TO_REG(val,\r\nFAN_DIV_FROM_REG(data->fan_div[nr]));\r\nlm87_write_value(client, LM87_REG_FAN_MIN(nr), data->fan_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t set_fan_div(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nint nr = to_sensor_dev_attr(attr)->index;\r\nlong val;\r\nint err;\r\nunsigned long min;\r\nu8 reg;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\nmin = FAN_FROM_REG(data->fan_min[nr],\r\nFAN_DIV_FROM_REG(data->fan_div[nr]));\r\nswitch (val) {\r\ncase 1:\r\ndata->fan_div[nr] = 0;\r\nbreak;\r\ncase 2:\r\ndata->fan_div[nr] = 1;\r\nbreak;\r\ncase 4:\r\ndata->fan_div[nr] = 2;\r\nbreak;\r\ncase 8:\r\ndata->fan_div[nr] = 3;\r\nbreak;\r\ndefault:\r\nmutex_unlock(&data->update_lock);\r\nreturn -EINVAL;\r\n}\r\nreg = lm87_read_value(client, LM87_REG_VID_FAN_DIV);\r\nswitch (nr) {\r\ncase 0:\r\nreg = (reg & 0xCF) | (data->fan_div[0] << 4);\r\nbreak;\r\ncase 1:\r\nreg = (reg & 0x3F) | (data->fan_div[1] << 6);\r\nbreak;\r\n}\r\nlm87_write_value(client, LM87_REG_VID_FAN_DIV, reg);\r\ndata->fan_min[nr] = FAN_TO_REG(min, val);\r\nlm87_write_value(client, LM87_REG_FAN_MIN(nr),\r\ndata->fan_min[nr]);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_alarms(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nreturn sprintf(buf, "%d\n", data->alarms);\r\n}\r\nstatic ssize_t show_vid(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nreturn sprintf(buf, "%d\n", vid_from_reg(data->vid, data->vrm));\r\n}\r\nstatic ssize_t show_vrm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct lm87_data *data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", data->vrm);\r\n}\r\nstatic ssize_t set_vrm(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct lm87_data *data = dev_get_drvdata(dev);\r\nunsigned long val;\r\nint err;\r\nerr = kstrtoul(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\ndata->vrm = val;\r\nreturn count;\r\n}\r\nstatic ssize_t show_aout(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nreturn sprintf(buf, "%d\n", AOUT_FROM_REG(data->aout));\r\n}\r\nstatic ssize_t set_aout(struct device *dev, struct device_attribute *attr,\r\nconst char *buf, size_t count)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nlong val;\r\nint err;\r\nerr = kstrtol(buf, 10, &val);\r\nif (err)\r\nreturn err;\r\nmutex_lock(&data->update_lock);\r\ndata->aout = AOUT_TO_REG(val);\r\nlm87_write_value(client, LM87_REG_AOUT, data->aout);\r\nmutex_unlock(&data->update_lock);\r\nreturn count;\r\n}\r\nstatic ssize_t show_alarm(struct device *dev, struct device_attribute *attr,\r\nchar *buf)\r\n{\r\nstruct lm87_data *data = lm87_update_device(dev);\r\nint bitnr = to_sensor_dev_attr(attr)->index;\r\nreturn sprintf(buf, "%u\n", (data->alarms >> bitnr) & 1);\r\n}\r\nstatic int lm87_detect(struct i2c_client *client, struct i2c_board_info *info)\r\n{\r\nstruct i2c_adapter *adapter = client->adapter;\r\nconst char *name;\r\nu8 cid, rev;\r\nif (!i2c_check_functionality(adapter, I2C_FUNC_SMBUS_BYTE_DATA))\r\nreturn -ENODEV;\r\nif (lm87_read_value(client, LM87_REG_CONFIG) & 0x80)\r\nreturn -ENODEV;\r\ncid = lm87_read_value(client, LM87_REG_COMPANY_ID);\r\nrev = lm87_read_value(client, LM87_REG_REVISION);\r\nif (cid == 0x02\r\n&& (rev >= 0x01 && rev <= 0x08))\r\nname = "lm87";\r\nelse if (cid == 0x41\r\n&& (rev & 0xf0) == 0x10)\r\nname = "adm1024";\r\nelse {\r\ndev_dbg(&adapter->dev, "LM87 detection failed at 0x%02x\n",\r\nclient->addr);\r\nreturn -ENODEV;\r\n}\r\nstrlcpy(info->type, name, I2C_NAME_SIZE);\r\nreturn 0;\r\n}\r\nstatic void lm87_remove_files(struct i2c_client *client)\r\n{\r\nstruct device *dev = &client->dev;\r\nsysfs_remove_group(&dev->kobj, &lm87_group);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_in6);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_fan1);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_in7);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_fan2);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_temp3);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_in0_5);\r\nsysfs_remove_group(&dev->kobj, &lm87_group_vid);\r\n}\r\nstatic void lm87_init_client(struct i2c_client *client)\r\n{\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nif (dev_get_platdata(&client->dev)) {\r\ndata->channel = *(u8 *)dev_get_platdata(&client->dev);\r\nlm87_write_value(client,\r\nLM87_REG_CHANNEL_MODE, data->channel);\r\n} else {\r\ndata->channel = lm87_read_value(client, LM87_REG_CHANNEL_MODE);\r\n}\r\ndata->config = lm87_read_value(client, LM87_REG_CONFIG) & 0x6F;\r\nif (!(data->config & 0x01)) {\r\nint i;\r\nfor (i = 1; i < 6; i++) {\r\nlm87_write_value(client, LM87_REG_IN_MIN(i), 0x00);\r\nlm87_write_value(client, LM87_REG_IN_MAX(i), 0xFF);\r\n}\r\nfor (i = 0; i < 2; i++) {\r\nlm87_write_value(client, LM87_REG_TEMP_HIGH[i], 0x7F);\r\nlm87_write_value(client, LM87_REG_TEMP_LOW[i], 0x00);\r\nlm87_write_value(client, LM87_REG_AIN_MIN(i), 0x00);\r\nlm87_write_value(client, LM87_REG_AIN_MAX(i), 0xFF);\r\n}\r\nif (data->channel & CHAN_TEMP3) {\r\nlm87_write_value(client, LM87_REG_TEMP_HIGH[2], 0x7F);\r\nlm87_write_value(client, LM87_REG_TEMP_LOW[2], 0x00);\r\n} else {\r\nlm87_write_value(client, LM87_REG_IN_MIN(0), 0x00);\r\nlm87_write_value(client, LM87_REG_IN_MAX(0), 0xFF);\r\n}\r\n}\r\nif ((data->config & 0x09) != 0x01)\r\nlm87_write_value(client, LM87_REG_CONFIG,\r\n(data->config & 0x77) | 0x01);\r\n}\r\nstatic int lm87_probe(struct i2c_client *client, const struct i2c_device_id *id)\r\n{\r\nstruct lm87_data *data;\r\nint err;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct lm87_data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\nlm87_init_client(client);\r\ndata->in_scale[0] = 2500;\r\ndata->in_scale[1] = 2700;\r\ndata->in_scale[2] = (data->channel & CHAN_VCC_5V) ? 5000 : 3300;\r\ndata->in_scale[3] = 5000;\r\ndata->in_scale[4] = 12000;\r\ndata->in_scale[5] = 2700;\r\ndata->in_scale[6] = 1875;\r\ndata->in_scale[7] = 1875;\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group);\r\nif (err)\r\ngoto exit_stop;\r\nif (data->channel & CHAN_NO_FAN(0)) {\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_in6);\r\nif (err)\r\ngoto exit_remove;\r\n} else {\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_fan1);\r\nif (err)\r\ngoto exit_remove;\r\n}\r\nif (data->channel & CHAN_NO_FAN(1)) {\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_in7);\r\nif (err)\r\ngoto exit_remove;\r\n} else {\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_fan2);\r\nif (err)\r\ngoto exit_remove;\r\n}\r\nif (data->channel & CHAN_TEMP3) {\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_temp3);\r\nif (err)\r\ngoto exit_remove;\r\n} else {\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_in0_5);\r\nif (err)\r\ngoto exit_remove;\r\n}\r\nif (!(data->channel & CHAN_NO_VID)) {\r\ndata->vrm = vid_which_vrm();\r\nerr = sysfs_create_group(&client->dev.kobj, &lm87_group_vid);\r\nif (err)\r\ngoto exit_remove;\r\n}\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto exit_remove;\r\n}\r\nreturn 0;\r\nexit_remove:\r\nlm87_remove_files(client);\r\nexit_stop:\r\nlm87_write_value(client, LM87_REG_CONFIG, data->config);\r\nreturn err;\r\n}\r\nstatic int lm87_remove(struct i2c_client *client)\r\n{\r\nstruct lm87_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nlm87_remove_files(client);\r\nlm87_write_value(client, LM87_REG_CONFIG, data->config);\r\nreturn 0;\r\n}

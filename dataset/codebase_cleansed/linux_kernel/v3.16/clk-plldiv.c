static unsigned long clk_plldiv_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_plldiv *plldiv = to_clk_plldiv(hw);\r\nstruct at91_pmc *pmc = plldiv->pmc;\r\nif (pmc_read(pmc, AT91_PMC_MCKR) & AT91_PMC_PLLADIV2)\r\nreturn parent_rate / 2;\r\nreturn parent_rate;\r\n}\r\nstatic long clk_plldiv_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nunsigned long div;\r\nif (rate > *parent_rate)\r\nreturn *parent_rate;\r\ndiv = *parent_rate / 2;\r\nif (rate < div)\r\nreturn div;\r\nif (rate - div < *parent_rate - rate)\r\nreturn div;\r\nreturn *parent_rate;\r\n}\r\nstatic int clk_plldiv_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_plldiv *plldiv = to_clk_plldiv(hw);\r\nstruct at91_pmc *pmc = plldiv->pmc;\r\nu32 tmp;\r\nif (parent_rate != rate && (parent_rate / 2) != rate)\r\nreturn -EINVAL;\r\npmc_lock(pmc);\r\ntmp = pmc_read(pmc, AT91_PMC_MCKR) & ~AT91_PMC_PLLADIV2;\r\nif ((parent_rate / 2) == rate)\r\ntmp |= AT91_PMC_PLLADIV2;\r\npmc_write(pmc, AT91_PMC_MCKR, tmp);\r\npmc_unlock(pmc);\r\nreturn 0;\r\n}\r\nstatic struct clk * __init\r\nat91_clk_register_plldiv(struct at91_pmc *pmc, const char *name,\r\nconst char *parent_name)\r\n{\r\nstruct clk_plldiv *plldiv;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nplldiv = kzalloc(sizeof(*plldiv), GFP_KERNEL);\r\nif (!plldiv)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &plldiv_ops;\r\ninit.parent_names = parent_name ? &parent_name : NULL;\r\ninit.num_parents = parent_name ? 1 : 0;\r\ninit.flags = CLK_SET_RATE_GATE;\r\nplldiv->hw.init = &init;\r\nplldiv->pmc = pmc;\r\nclk = clk_register(NULL, &plldiv->hw);\r\nif (IS_ERR(clk))\r\nkfree(plldiv);\r\nreturn clk;\r\n}\r\nstatic void __init\r\nof_at91_clk_plldiv_setup(struct device_node *np, struct at91_pmc *pmc)\r\n{\r\nstruct clk *clk;\r\nconst char *parent_name;\r\nconst char *name = np->name;\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nof_property_read_string(np, "clock-output-names", &name);\r\nclk = at91_clk_register_plldiv(pmc, name, parent_name);\r\nif (IS_ERR(clk))\r\nreturn;\r\nof_clk_add_provider(np, of_clk_src_simple_get, clk);\r\nreturn;\r\n}\r\nvoid __init of_at91sam9x5_clk_plldiv_setup(struct device_node *np,\r\nstruct at91_pmc *pmc)\r\n{\r\nof_at91_clk_plldiv_setup(np, pmc);\r\n}

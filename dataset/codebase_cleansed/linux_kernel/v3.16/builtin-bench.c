static void dump_benchmarks(struct collection *coll)\r\n{\r\nstruct bench *bench;\r\nprintf("\n # List of available benchmarks for collection '%s':\n\n", coll->name);\r\nfor_each_bench(coll, bench)\r\nprintf("%14s: %s\n", bench->name, bench->summary);\r\nprintf("\n");\r\n}\r\nstatic void print_usage(void)\r\n{\r\nstruct collection *coll;\r\nint i;\r\nprintf("Usage: \n");\r\nfor (i = 0; bench_usage[i]; i++)\r\nprintf("\t%s\n", bench_usage[i]);\r\nprintf("\n");\r\nprintf(" # List of all available benchmark collections:\n\n");\r\nfor_each_collection(coll)\r\nprintf("%14s: %s\n", coll->name, coll->summary);\r\nprintf("\n");\r\n}\r\nstatic int bench_str2int(const char *str)\r\n{\r\nif (!str)\r\nreturn BENCH_FORMAT_DEFAULT;\r\nif (!strcmp(str, BENCH_FORMAT_DEFAULT_STR))\r\nreturn BENCH_FORMAT_DEFAULT;\r\nelse if (!strcmp(str, BENCH_FORMAT_SIMPLE_STR))\r\nreturn BENCH_FORMAT_SIMPLE;\r\nreturn BENCH_FORMAT_UNKNOWN;\r\n}\r\nstatic int run_bench(const char *coll_name, const char *bench_name, bench_fn_t fn,\r\nint argc, const char **argv, const char *prefix)\r\n{\r\nint size;\r\nchar *name;\r\nint ret;\r\nsize = strlen(coll_name) + 1 + strlen(bench_name) + 1;\r\nname = zalloc(size);\r\nBUG_ON(!name);\r\nscnprintf(name, size, "%s-%s", coll_name, bench_name);\r\nprctl(PR_SET_NAME, name);\r\nargv[0] = name;\r\nret = fn(argc, argv, prefix);\r\nfree(name);\r\nreturn ret;\r\n}\r\nstatic void run_collection(struct collection *coll)\r\n{\r\nstruct bench *bench;\r\nconst char *argv[2];\r\nargv[1] = NULL;\r\nfor_each_bench(coll, bench) {\r\nif (!bench->fn)\r\nbreak;\r\nprintf("# Running %s/%s benchmark...\n", coll->name, bench->name);\r\nfflush(stdout);\r\nargv[1] = bench->name;\r\nrun_bench(coll->name, bench->name, bench->fn, 1, argv, NULL);\r\nprintf("\n");\r\n}\r\n}\r\nstatic void run_all_collections(void)\r\n{\r\nstruct collection *coll;\r\nfor_each_collection(coll)\r\nrun_collection(coll);\r\n}\r\nint cmd_bench(int argc, const char **argv, const char *prefix __maybe_unused)\r\n{\r\nstruct collection *coll;\r\nint ret = 0;\r\nif (argc < 2) {\r\nprint_usage();\r\ngoto end;\r\n}\r\nargc = parse_options(argc, argv, bench_options, bench_usage,\r\nPARSE_OPT_STOP_AT_NON_OPTION);\r\nbench_format = bench_str2int(bench_format_str);\r\nif (bench_format == BENCH_FORMAT_UNKNOWN) {\r\nprintf("Unknown format descriptor: '%s'\n", bench_format_str);\r\ngoto end;\r\n}\r\nif (argc < 1) {\r\nprint_usage();\r\ngoto end;\r\n}\r\nif (!strcmp(argv[0], "all")) {\r\nrun_all_collections();\r\ngoto end;\r\n}\r\nfor_each_collection(coll) {\r\nstruct bench *bench;\r\nif (strcmp(coll->name, argv[0]))\r\ncontinue;\r\nif (argc < 2) {\r\ndump_benchmarks(coll);\r\ngoto end;\r\n}\r\nif (!strcmp(argv[1], "all")) {\r\nrun_collection(coll);\r\ngoto end;\r\n}\r\nfor_each_bench(coll, bench) {\r\nif (strcmp(bench->name, argv[1]))\r\ncontinue;\r\nif (bench_format == BENCH_FORMAT_DEFAULT)\r\nprintf("# Running '%s/%s' benchmark:\n", coll->name, bench->name);\r\nfflush(stdout);\r\nret = run_bench(coll->name, bench->name, bench->fn, argc-1, argv+1, prefix);\r\ngoto end;\r\n}\r\nif (!strcmp(argv[1], "-h") || !strcmp(argv[1], "--help")) {\r\ndump_benchmarks(coll);\r\ngoto end;\r\n}\r\nprintf("Unknown benchmark: '%s' for collection '%s'\n", argv[1], argv[0]);\r\nret = 1;\r\ngoto end;\r\n}\r\nprintf("Unknown collection: '%s'\n", argv[0]);\r\nret = 1;\r\nend:\r\nreturn ret;\r\n}

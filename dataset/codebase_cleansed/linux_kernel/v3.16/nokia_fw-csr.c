void hci_h4p_bc4_parse_fw_event(struct hci_h4p_info *info, struct sk_buff *skb)\r\n{\r\nif (skb->data[0] != 0xff) {\r\nhci_recv_frame(info->hdev, skb);\r\nreturn;\r\n}\r\nif (skb->data[11] || skb->data[12]) {\r\ndev_err(info->dev, "Firmware sending command failed\n");\r\ninfo->fw_error = -EPROTO;\r\n}\r\nkfree_skb(skb);\r\ncomplete(&info->fw_completion);\r\n}\r\nint hci_h4p_bc4_send_fw(struct hci_h4p_info *info,\r\nstruct sk_buff_head *fw_queue)\r\n{\r\nstatic const u8 nokia_oui[3] = {0x00, 0x19, 0x4F};\r\nstruct sk_buff *skb;\r\nunsigned int offset;\r\nint retries, count, i, not_valid;\r\nunsigned long flags;\r\ninfo->fw_error = 0;\r\nBT_DBG("Sending firmware");\r\nskb = skb_dequeue(fw_queue);\r\nif (!skb)\r\nreturn -ENOMSG;\r\nif (skb->data[15] == 0x01 && skb->data[16] == 0x00) {\r\noffset = 21;\r\nskb->data[offset + 1] = 0x00;\r\nskb->data[offset + 5] = 0x00;\r\nnot_valid = 1;\r\nfor (i = 0; i < 6; i++) {\r\nif (info->bd_addr[i] != 0x00) {\r\nnot_valid = 0;\r\nbreak;\r\n}\r\n}\r\nif (not_valid) {\r\ndev_info(info->dev, "Valid bluetooth address not found, setting some random\n");\r\nmemcpy(info->bd_addr, nokia_oui, 3);\r\nget_random_bytes(info->bd_addr + 3, 3);\r\n}\r\nskb->data[offset + 7] = info->bd_addr[0];\r\nskb->data[offset + 6] = info->bd_addr[1];\r\nskb->data[offset + 4] = info->bd_addr[2];\r\nskb->data[offset + 0] = info->bd_addr[3];\r\nskb->data[offset + 3] = info->bd_addr[4];\r\nskb->data[offset + 2] = info->bd_addr[5];\r\n}\r\nfor (count = 1; ; count++) {\r\nBT_DBG("Sending firmware command %d", count);\r\ninit_completion(&info->fw_completion);\r\nskb_queue_tail(&info->txq, skb);\r\nspin_lock_irqsave(&info->lock, flags);\r\nhci_h4p_outb(info, UART_IER, hci_h4p_inb(info, UART_IER) |\r\nUART_IER_THRI);\r\nspin_unlock_irqrestore(&info->lock, flags);\r\nskb = skb_dequeue(fw_queue);\r\nif (!skb)\r\nbreak;\r\nif (!wait_for_completion_timeout(&info->fw_completion,\r\nmsecs_to_jiffies(1000))) {\r\ndev_err(info->dev, "No reply to fw command\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (info->fw_error) {\r\ndev_err(info->dev, "FW error\n");\r\nreturn -EPROTO;\r\n}\r\n};\r\nretries = 100;\r\nwhile ((!skb_queue_empty(&info->txq) ||\r\n!(hci_h4p_inb(info, UART_LSR) & UART_LSR_TEMT)) &&\r\nretries--) {\r\nmsleep(10);\r\n}\r\nif (!retries) {\r\ndev_err(info->dev, "Transmitter not empty\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nhci_h4p_change_speed(info, BC4_MAX_BAUD_RATE);\r\nif (hci_h4p_wait_for_cts(info, 1, 100)) {\r\ndev_err(info->dev, "cts didn't deassert after final speed\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nretries = 100;\r\ndo {\r\ninit_completion(&info->init_completion);\r\nhci_h4p_send_alive_packet(info);\r\nretries--;\r\n} while (!wait_for_completion_timeout(&info->init_completion, 100) &&\r\nretries > 0);\r\nif (!retries) {\r\ndev_err(info->dev, "No alive reply after speed change\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nreturn 0;\r\n}

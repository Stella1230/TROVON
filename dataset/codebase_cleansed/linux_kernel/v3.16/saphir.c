static inline u_char\r\nreadreg(unsigned int ale, unsigned int adr, u_char off)\r\n{\r\nregister u_char ret;\r\nbyteout(ale, off);\r\nret = bytein(adr);\r\nreturn (ret);\r\n}\r\nstatic inline void\r\nreadfifo(unsigned int ale, unsigned int adr, u_char off, u_char *data, int size)\r\n{\r\nbyteout(ale, off);\r\ninsb(adr, data, size);\r\n}\r\nstatic inline void\r\nwritereg(unsigned int ale, unsigned int adr, u_char off, u_char data)\r\n{\r\nbyteout(ale, off);\r\nbyteout(adr, data);\r\n}\r\nstatic inline void\r\nwritefifo(unsigned int ale, unsigned int adr, u_char off, u_char *data, int size)\r\n{\r\nbyteout(ale, off);\r\noutsb(adr, data, size);\r\n}\r\nstatic u_char\r\nReadISAC(struct IsdnCardState *cs, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.saphir.ale, cs->hw.saphir.isac, offset));\r\n}\r\nstatic void\r\nWriteISAC(struct IsdnCardState *cs, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.isac, offset, value);\r\n}\r\nstatic void\r\nReadISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nreadfifo(cs->hw.saphir.ale, cs->hw.saphir.isac, 0, data, size);\r\n}\r\nstatic void\r\nWriteISACfifo(struct IsdnCardState *cs, u_char *data, int size)\r\n{\r\nwritefifo(cs->hw.saphir.ale, cs->hw.saphir.isac, 0, data, size);\r\n}\r\nstatic u_char\r\nReadHSCX(struct IsdnCardState *cs, int hscx, u_char offset)\r\n{\r\nreturn (readreg(cs->hw.saphir.ale, cs->hw.saphir.hscx,\r\noffset + (hscx ? 0x40 : 0)));\r\n}\r\nstatic void\r\nWriteHSCX(struct IsdnCardState *cs, int hscx, u_char offset, u_char value)\r\n{\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.hscx,\r\noffset + (hscx ? 0x40 : 0), value);\r\n}\r\nstatic irqreturn_t\r\nsaphir_interrupt(int intno, void *dev_id)\r\n{\r\nstruct IsdnCardState *cs = dev_id;\r\nu_char val;\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\nval = readreg(cs->hw.saphir.ale, cs->hw.saphir.hscx, HSCX_ISTA + 0x40);\r\nStart_HSCX:\r\nif (val)\r\nhscx_int_main(cs, val);\r\nval = readreg(cs->hw.saphir.ale, cs->hw.saphir.isac, ISAC_ISTA);\r\nStart_ISAC:\r\nif (val)\r\nisac_interrupt(cs, val);\r\nval = readreg(cs->hw.saphir.ale, cs->hw.saphir.hscx, HSCX_ISTA + 0x40);\r\nif (val) {\r\nif (cs->debug & L1_DEB_HSCX)\r\ndebugl1(cs, "HSCX IntStat after IntRoutine");\r\ngoto Start_HSCX;\r\n}\r\nval = readreg(cs->hw.saphir.ale, cs->hw.saphir.isac, ISAC_ISTA);\r\nif (val) {\r\nif (cs->debug & L1_DEB_ISAC)\r\ndebugl1(cs, "ISAC IntStat after IntRoutine");\r\ngoto Start_ISAC;\r\n}\r\nif (cs->hw.saphir.timer.function)\r\nmod_timer(&cs->hw.saphir.timer, jiffies + 1 * HZ);\r\nelse\r\nprintk(KERN_WARNING "saphir: Spurious timer!\n");\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.hscx, HSCX_MASK, 0xFF);\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.hscx, HSCX_MASK + 0x40, 0xFF);\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.isac, ISAC_MASK, 0xFF);\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.isac, ISAC_MASK, 0);\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.hscx, HSCX_MASK, 0);\r\nwritereg(cs->hw.saphir.ale, cs->hw.saphir.hscx, HSCX_MASK + 0x40, 0);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void\r\nSaphirWatchDog(struct IsdnCardState *cs)\r\n{\r\nu_long flags;\r\nspin_lock_irqsave(&cs->lock, flags);\r\ncs->readisac(cs, ISAC_RBCH);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nmod_timer(&cs->hw.saphir.timer, jiffies + 1 * HZ);\r\n}\r\nstatic void\r\nrelease_io_saphir(struct IsdnCardState *cs)\r\n{\r\nbyteout(cs->hw.saphir.cfg_reg + IRQ_REG, 0xff);\r\ndel_timer(&cs->hw.saphir.timer);\r\ncs->hw.saphir.timer.function = NULL;\r\nif (cs->hw.saphir.cfg_reg)\r\nrelease_region(cs->hw.saphir.cfg_reg, 6);\r\n}\r\nstatic int\r\nsaphir_reset(struct IsdnCardState *cs)\r\n{\r\nu_char irq_val;\r\nswitch (cs->irq) {\r\ncase 5: irq_val = 0;\r\nbreak;\r\ncase 3: irq_val = 1;\r\nbreak;\r\ncase 11:\r\nirq_val = 2;\r\nbreak;\r\ncase 12:\r\nirq_val = 3;\r\nbreak;\r\ncase 15:\r\nirq_val = 4;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "HiSax: saphir wrong IRQ %d\n",\r\ncs->irq);\r\nreturn (1);\r\n}\r\nbyteout(cs->hw.saphir.cfg_reg + IRQ_REG, irq_val);\r\nbyteout(cs->hw.saphir.cfg_reg + RESET_REG, 1);\r\nmdelay(10);\r\nbyteout(cs->hw.saphir.cfg_reg + RESET_REG, 0);\r\nmdelay(10);\r\nbyteout(cs->hw.saphir.cfg_reg + IRQ_REG, irq_val);\r\nbyteout(cs->hw.saphir.cfg_reg + SPARE_REG, 0x02);\r\nreturn (0);\r\n}\r\nstatic int\r\nsaphir_card_msg(struct IsdnCardState *cs, int mt, void *arg)\r\n{\r\nu_long flags;\r\nswitch (mt) {\r\ncase CARD_RESET:\r\nspin_lock_irqsave(&cs->lock, flags);\r\nsaphir_reset(cs);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_RELEASE:\r\nrelease_io_saphir(cs);\r\nreturn (0);\r\ncase CARD_INIT:\r\nspin_lock_irqsave(&cs->lock, flags);\r\ninithscxisac(cs, 3);\r\nspin_unlock_irqrestore(&cs->lock, flags);\r\nreturn (0);\r\ncase CARD_TEST:\r\nreturn (0);\r\n}\r\nreturn (0);\r\n}\r\nint setup_saphir(struct IsdnCard *card)\r\n{\r\nstruct IsdnCardState *cs = card->cs;\r\nchar tmp[64];\r\nstrcpy(tmp, saphir_rev);\r\nprintk(KERN_INFO "HiSax: HST Saphir driver Rev. %s\n", HiSax_getrev(tmp));\r\nif (cs->typ != ISDN_CTYPE_HSTSAPHIR)\r\nreturn (0);\r\ncs->hw.saphir.cfg_reg = card->para[1];\r\ncs->hw.saphir.isac = card->para[1] + ISAC_DATA;\r\ncs->hw.saphir.hscx = card->para[1] + HSCX_DATA;\r\ncs->hw.saphir.ale = card->para[1] + ADDRESS_REG;\r\ncs->irq = card->para[0];\r\nif (!request_region(cs->hw.saphir.cfg_reg, 6, "saphir")) {\r\nprintk(KERN_WARNING\r\n"HiSax: HST Saphir config port %x-%x already in use\n",\r\ncs->hw.saphir.cfg_reg,\r\ncs->hw.saphir.cfg_reg + 5);\r\nreturn (0);\r\n}\r\nprintk(KERN_INFO "HiSax: HST Saphir config irq:%d io:0x%X\n",\r\ncs->irq, cs->hw.saphir.cfg_reg);\r\nsetup_isac(cs);\r\ncs->hw.saphir.timer.function = (void *) SaphirWatchDog;\r\ncs->hw.saphir.timer.data = (long) cs;\r\ninit_timer(&cs->hw.saphir.timer);\r\ncs->hw.saphir.timer.expires = jiffies + 4 * HZ;\r\nadd_timer(&cs->hw.saphir.timer);\r\nif (saphir_reset(cs)) {\r\nrelease_io_saphir(cs);\r\nreturn (0);\r\n}\r\ncs->readisac = &ReadISAC;\r\ncs->writeisac = &WriteISAC;\r\ncs->readisacfifo = &ReadISACfifo;\r\ncs->writeisacfifo = &WriteISACfifo;\r\ncs->BC_Read_Reg = &ReadHSCX;\r\ncs->BC_Write_Reg = &WriteHSCX;\r\ncs->BC_Send_Data = &hscx_fill_fifo;\r\ncs->cardmsg = &saphir_card_msg;\r\ncs->irq_func = &saphir_interrupt;\r\nISACVersion(cs, "saphir:");\r\nif (HscxVersion(cs, "saphir:")) {\r\nprintk(KERN_WARNING\r\n"saphir: wrong HSCX versions check IO address\n");\r\nrelease_io_saphir(cs);\r\nreturn (0);\r\n}\r\nreturn (1);\r\n}

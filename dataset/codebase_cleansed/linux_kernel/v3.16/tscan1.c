static u8 tscan1_read(const struct sja1000_priv *priv, int reg)\r\n{\r\nreturn inb((unsigned long)priv->reg_base + reg);\r\n}\r\nstatic void tscan1_write(const struct sja1000_priv *priv, int reg, u8 val)\r\n{\r\noutb(val, (unsigned long)priv->reg_base + reg);\r\n}\r\nstatic int tscan1_probe(struct device *dev, unsigned id)\r\n{\r\nstruct net_device *netdev;\r\nstruct sja1000_priv *priv;\r\nunsigned long pld_base, sja1000_base;\r\nint irq, i;\r\npld_base = TSCAN1_PLD_ADDRESS + id * TSCAN1_PLD_SIZE;\r\nif (!request_region(pld_base, TSCAN1_PLD_SIZE, dev_name(dev)))\r\nreturn -EBUSY;\r\nif (inb(pld_base + TSCAN1_ID1) != TSCAN1_ID1_VALUE ||\r\ninb(pld_base + TSCAN1_ID2) != TSCAN1_ID2_VALUE) {\r\nrelease_region(pld_base, TSCAN1_PLD_SIZE);\r\nreturn -ENODEV;\r\n}\r\nswitch (inb(pld_base + TSCAN1_JUMPERS) & (TSCAN1_JP4 | TSCAN1_JP5)) {\r\ncase TSCAN1_JP4:\r\nirq = 6;\r\nbreak;\r\ncase TSCAN1_JP5:\r\nirq = 7;\r\nbreak;\r\ncase TSCAN1_JP4 | TSCAN1_JP5:\r\nirq = 5;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid JP4:JP5 setting (no IRQ)\n");\r\nrelease_region(pld_base, TSCAN1_PLD_SIZE);\r\nreturn -EINVAL;\r\n}\r\nnetdev = alloc_sja1000dev(0);\r\nif (!netdev) {\r\nrelease_region(pld_base, TSCAN1_PLD_SIZE);\r\nreturn -ENOMEM;\r\n}\r\ndev_set_drvdata(dev, netdev);\r\nSET_NETDEV_DEV(netdev, dev);\r\nnetdev->base_addr = pld_base;\r\nnetdev->irq = irq;\r\npriv = netdev_priv(netdev);\r\npriv->read_reg = tscan1_read;\r\npriv->write_reg = tscan1_write;\r\npriv->can.clock.freq = TSCAN1_SJA1000_XTAL / 2;\r\npriv->cdr = CDR_CBP | CDR_CLK_OFF;\r\npriv->ocr = OCR_TX0_PUSHPULL;\r\nfor (i = 0; i < ARRAY_SIZE(tscan1_sja1000_addresses); i++) {\r\nsja1000_base = tscan1_sja1000_addresses[i];\r\nif (!request_region(sja1000_base, TSCAN1_SJA1000_SIZE,\r\ndev_name(dev)))\r\ncontinue;\r\noutb(TSCAN1_MODE_ENABLE | i, pld_base + TSCAN1_MODE);\r\npriv->reg_base = (void __iomem *)sja1000_base;\r\nif (!register_sja1000dev(netdev)) {\r\noutb(0, pld_base + TSCAN1_LED);\r\nnetdev_info(netdev, "TS-CAN1 at 0x%lx 0x%lx irq %d\n",\r\npld_base, sja1000_base, irq);\r\nreturn 0;\r\n}\r\noutb(0, pld_base + TSCAN1_MODE);\r\nrelease_region(sja1000_base, TSCAN1_SJA1000_SIZE);\r\n}\r\ndev_err(dev, "failed to assign SJA1000 IO address\n");\r\ndev_set_drvdata(dev, NULL);\r\nfree_sja1000dev(netdev);\r\nrelease_region(pld_base, TSCAN1_PLD_SIZE);\r\nreturn -ENXIO;\r\n}\r\nstatic int tscan1_remove(struct device *dev, unsigned id )\r\n{\r\nstruct net_device *netdev;\r\nstruct sja1000_priv *priv;\r\nunsigned long pld_base, sja1000_base;\r\nnetdev = dev_get_drvdata(dev);\r\nunregister_sja1000dev(netdev);\r\ndev_set_drvdata(dev, NULL);\r\npriv = netdev_priv(netdev);\r\npld_base = netdev->base_addr;\r\nsja1000_base = (unsigned long)priv->reg_base;\r\noutb(0, pld_base + TSCAN1_MODE);\r\nrelease_region(sja1000_base, TSCAN1_SJA1000_SIZE);\r\nrelease_region(pld_base, TSCAN1_PLD_SIZE);\r\nfree_sja1000dev(netdev);\r\nreturn 0;\r\n}\r\nstatic int __init tscan1_init(void)\r\n{\r\nreturn isa_register_driver(&tscan1_isa_driver, TSCAN1_MAXDEV);\r\n}\r\nstatic void __exit tscan1_exit(void)\r\n{\r\nisa_unregister_driver(&tscan1_isa_driver);\r\n}

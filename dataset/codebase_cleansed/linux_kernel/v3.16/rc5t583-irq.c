static void rc5t583_irq_lock(struct irq_data *irq_data)\r\n{\r\nstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\r\nmutex_lock(&rc5t583->irq_lock);\r\n}\r\nstatic void rc5t583_irq_unmask(struct irq_data *irq_data)\r\n{\r\nstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\r\nunsigned int __irq = irq_data->irq - rc5t583->irq_base;\r\nconst struct rc5t583_irq_data *data = &rc5t583_irqs[__irq];\r\nrc5t583->group_irq_en[data->grp_index] |= 1 << data->grp_index;\r\nrc5t583->intc_inten_reg |= 1 << data->master_bit;\r\nrc5t583->irq_en_reg[data->mask_reg_index] |= 1 << data->int_en_bit;\r\n}\r\nstatic void rc5t583_irq_mask(struct irq_data *irq_data)\r\n{\r\nstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\r\nunsigned int __irq = irq_data->irq - rc5t583->irq_base;\r\nconst struct rc5t583_irq_data *data = &rc5t583_irqs[__irq];\r\nrc5t583->group_irq_en[data->grp_index] &= ~(1 << data->grp_index);\r\nif (!rc5t583->group_irq_en[data->grp_index])\r\nrc5t583->intc_inten_reg &= ~(1 << data->master_bit);\r\nrc5t583->irq_en_reg[data->mask_reg_index] &= ~(1 << data->int_en_bit);\r\n}\r\nstatic int rc5t583_irq_set_type(struct irq_data *irq_data, unsigned int type)\r\n{\r\nstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\r\nunsigned int __irq = irq_data->irq - rc5t583->irq_base;\r\nconst struct rc5t583_irq_data *data = &rc5t583_irqs[__irq];\r\nint val = 0;\r\nint gpedge_index;\r\nint gpedge_bit_pos;\r\nif ((data->int_type & GPIO_INT) && (type & IRQ_TYPE_EDGE_BOTH)) {\r\ngpedge_index = data->int_en_bit / 4;\r\ngpedge_bit_pos = data->int_en_bit % 4;\r\nif (type & IRQ_TYPE_EDGE_FALLING)\r\nval |= 0x2;\r\nif (type & IRQ_TYPE_EDGE_RISING)\r\nval |= 0x1;\r\nrc5t583->gpedge_reg[gpedge_index] &= ~(3 << gpedge_bit_pos);\r\nrc5t583->gpedge_reg[gpedge_index] |= (val << gpedge_bit_pos);\r\nrc5t583_irq_unmask(irq_data);\r\nreturn 0;\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic void rc5t583_irq_sync_unlock(struct irq_data *irq_data)\r\n{\r\nstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\r\nint i;\r\nint ret;\r\nfor (i = 0; i < ARRAY_SIZE(rc5t583->gpedge_reg); i++) {\r\nret = rc5t583_write(rc5t583->dev, gpedge_add[i],\r\nrc5t583->gpedge_reg[i]);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\ngpedge_add[i], ret);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(rc5t583->irq_en_reg); i++) {\r\nret = rc5t583_write(rc5t583->dev, irq_en_add[i],\r\nrc5t583->irq_en_reg[i]);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\nirq_en_add[i], ret);\r\n}\r\nret = rc5t583_write(rc5t583->dev, RC5T583_INTC_INTEN,\r\nrc5t583->intc_inten_reg);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\nRC5T583_INTC_INTEN, ret);\r\nmutex_unlock(&rc5t583->irq_lock);\r\n}\r\nstatic int rc5t583_irq_set_wake(struct irq_data *irq_data, unsigned int on)\r\n{\r\nstruct rc5t583 *rc5t583 = irq_data_get_irq_chip_data(irq_data);\r\nreturn irq_set_irq_wake(rc5t583->chip_irq, on);\r\n}\r\nstatic irqreturn_t rc5t583_irq(int irq, void *data)\r\n{\r\nstruct rc5t583 *rc5t583 = data;\r\nuint8_t int_sts[RC5T583_MAX_INTERRUPT_MASK_REGS];\r\nuint8_t master_int = 0;\r\nint i;\r\nint ret;\r\nunsigned int rtc_int_sts = 0;\r\nfor (i = 0; i < RC5T583_MAX_INTERRUPT_MASK_REGS; i++)\r\nint_sts[i] = 0;\r\nret = rc5t583_read(rc5t583->dev, RC5T583_INTC_INTMON, &master_int);\r\nif (ret < 0) {\r\ndev_err(rc5t583->dev,\r\n"Error in reading reg 0x%02x error: %d\n",\r\nRC5T583_INTC_INTMON, ret);\r\nreturn IRQ_HANDLED;\r\n}\r\nfor (i = 0; i < RC5T583_MAX_INTERRUPT_MASK_REGS; ++i) {\r\nif (!(master_int & main_int_type[i]))\r\ncontinue;\r\nret = rc5t583_read(rc5t583->dev, irq_mon_add[i], &int_sts[i]);\r\nif (ret < 0) {\r\ndev_warn(rc5t583->dev,\r\n"Error in reading reg 0x%02x error: %d\n",\r\nirq_mon_add[i], ret);\r\nint_sts[i] = 0;\r\ncontinue;\r\n}\r\nif (main_int_type[i] & RTC_INT) {\r\nrtc_int_sts = 0;\r\nif (int_sts[i] & 0x1)\r\nrtc_int_sts |= BIT(6);\r\nif (int_sts[i] & 0x2)\r\nrtc_int_sts |= BIT(7);\r\nif (int_sts[i] & 0x4)\r\nrtc_int_sts |= BIT(0);\r\nif (int_sts[i] & 0x8)\r\nrtc_int_sts |= BIT(5);\r\n}\r\nret = rc5t583_write(rc5t583->dev, irq_clr_add[i],\r\n~int_sts[i]);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in reading reg 0x%02x error: %d\n",\r\nirq_clr_add[i], ret);\r\nif (main_int_type[i] & RTC_INT)\r\nint_sts[i] = rtc_int_sts;\r\n}\r\nint_sts[7] |= int_sts[8];\r\nfor (i = 0; i < RC5T583_MAX_IRQS; ++i) {\r\nconst struct rc5t583_irq_data *data = &rc5t583_irqs[i];\r\nif ((int_sts[data->mask_reg_index] & (1 << data->int_en_bit)) &&\r\n(rc5t583->group_irq_en[data->master_bit] &\r\n(1 << data->grp_index)))\r\nhandle_nested_irq(rc5t583->irq_base + i);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nint rc5t583_irq_init(struct rc5t583 *rc5t583, int irq, int irq_base)\r\n{\r\nint i, ret;\r\nif (!irq_base) {\r\ndev_warn(rc5t583->dev, "No interrupt support on IRQ base\n");\r\nreturn -EINVAL;\r\n}\r\nmutex_init(&rc5t583->irq_lock);\r\nfor (i = 0; i < RC5T583_MAX_INTERRUPT_EN_REGS; i++) {\r\nret = rc5t583_write(rc5t583->dev, irq_en_add[i],\r\nrc5t583->irq_en_reg[i]);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\nirq_en_add[i], ret);\r\n}\r\nfor (i = 0; i < RC5T583_MAX_GPEDGE_REG; i++) {\r\nret = rc5t583_write(rc5t583->dev, gpedge_add[i],\r\nrc5t583->gpedge_reg[i]);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\ngpedge_add[i], ret);\r\n}\r\nret = rc5t583_write(rc5t583->dev, RC5T583_INTC_INTEN, 0x0);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\nRC5T583_INTC_INTEN, ret);\r\nfor (i = 0; i < RC5T583_MAX_INTERRUPT_MASK_REGS; i++) {\r\nret = rc5t583_write(rc5t583->dev, irq_clr_add[i], 0);\r\nif (ret < 0)\r\ndev_warn(rc5t583->dev,\r\n"Error in writing reg 0x%02x error: %d\n",\r\nirq_clr_add[i], ret);\r\n}\r\nrc5t583->irq_base = irq_base;\r\nrc5t583->chip_irq = irq;\r\nfor (i = 0; i < RC5T583_MAX_IRQS; i++) {\r\nint __irq = i + rc5t583->irq_base;\r\nirq_set_chip_data(__irq, rc5t583);\r\nirq_set_chip_and_handler(__irq, &rc5t583_irq_chip,\r\nhandle_simple_irq);\r\nirq_set_nested_thread(__irq, 1);\r\n#ifdef CONFIG_ARM\r\nset_irq_flags(__irq, IRQF_VALID);\r\n#endif\r\n}\r\nret = request_threaded_irq(irq, NULL, rc5t583_irq, IRQF_ONESHOT,\r\n"rc5t583", rc5t583);\r\nif (ret < 0)\r\ndev_err(rc5t583->dev,\r\n"Error in registering interrupt error: %d\n", ret);\r\nreturn ret;\r\n}\r\nint rc5t583_irq_exit(struct rc5t583 *rc5t583)\r\n{\r\nif (rc5t583->chip_irq)\r\nfree_irq(rc5t583->chip_irq, rc5t583);\r\nreturn 0;\r\n}

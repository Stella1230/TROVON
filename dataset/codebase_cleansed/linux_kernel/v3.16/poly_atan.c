void poly_atan(FPU_REG *st0_ptr, u_char st0_tag,\r\nFPU_REG *st1_ptr, u_char st1_tag)\r\n{\r\nu_char transformed, inverted, sign1, sign2;\r\nint exponent;\r\nlong int dummy_exp;\r\nXsig accumulator, Numer, Denom, accumulatore, argSignif, argSq, argSqSq;\r\nu_char tag;\r\nsign1 = getsign(st0_ptr);\r\nsign2 = getsign(st1_ptr);\r\nif (st0_tag == TAG_Valid) {\r\nexponent = exponent(st0_ptr);\r\n} else {\r\nFPU_to_exp16(st0_ptr, st0_ptr);\r\nexponent = exponent16(st0_ptr);\r\n}\r\nif (st1_tag == TAG_Valid) {\r\nexponent -= exponent(st1_ptr);\r\n} else {\r\nFPU_to_exp16(st1_ptr, st1_ptr);\r\nexponent -= exponent16(st1_ptr);\r\n}\r\nif ((exponent < 0) || ((exponent == 0) &&\r\n((st0_ptr->sigh < st1_ptr->sigh) ||\r\n((st0_ptr->sigh == st1_ptr->sigh) &&\r\n(st0_ptr->sigl < st1_ptr->sigl))))) {\r\ninverted = 1;\r\nNumer.lsw = Denom.lsw = 0;\r\nXSIG_LL(Numer) = significand(st0_ptr);\r\nXSIG_LL(Denom) = significand(st1_ptr);\r\n} else {\r\ninverted = 0;\r\nexponent = -exponent;\r\nNumer.lsw = Denom.lsw = 0;\r\nXSIG_LL(Numer) = significand(st1_ptr);\r\nXSIG_LL(Denom) = significand(st0_ptr);\r\n}\r\ndiv_Xsig(&Numer, &Denom, &argSignif);\r\nexponent += norm_Xsig(&argSignif);\r\nif ((exponent >= -1)\r\n|| ((exponent == -2) && (argSignif.msw > 0xd413ccd0))) {\r\ntransformed = 1;\r\nif (exponent >= 0) {\r\n#ifdef PARANOID\r\nif (!((exponent == 0) &&\r\n(argSignif.lsw == 0) && (argSignif.midw == 0) &&\r\n(argSignif.msw == 0x80000000))) {\r\nEXCEPTION(EX_INTERNAL | 0x104);\r\nreturn;\r\n}\r\n#endif\r\nargSignif.msw = 0;\r\n} else {\r\nNumer.lsw = Denom.lsw = argSignif.lsw;\r\nXSIG_LL(Numer) = XSIG_LL(Denom) = XSIG_LL(argSignif);\r\nif (exponent < -1)\r\nshr_Xsig(&Numer, -1 - exponent);\r\nnegate_Xsig(&Numer);\r\nshr_Xsig(&Denom, -exponent);\r\nDenom.msw |= 0x80000000;\r\ndiv_Xsig(&Numer, &Denom, &argSignif);\r\nexponent = -1 + norm_Xsig(&argSignif);\r\n}\r\n} else {\r\ntransformed = 0;\r\n}\r\nargSq.lsw = argSignif.lsw;\r\nargSq.midw = argSignif.midw;\r\nargSq.msw = argSignif.msw;\r\nmul_Xsig_Xsig(&argSq, &argSq);\r\nargSqSq.lsw = argSq.lsw;\r\nargSqSq.midw = argSq.midw;\r\nargSqSq.msw = argSq.msw;\r\nmul_Xsig_Xsig(&argSqSq, &argSqSq);\r\naccumulatore.lsw = argSq.lsw;\r\nXSIG_LL(accumulatore) = XSIG_LL(argSq);\r\nshr_Xsig(&argSq, 2 * (-1 - exponent - 1));\r\nshr_Xsig(&argSqSq, 4 * (-1 - exponent - 1));\r\naccumulator.msw = accumulator.midw = accumulator.lsw = 0;\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argSqSq),\r\noddplterms, HIPOWERop - 1);\r\nmul64_Xsig(&accumulator, &XSIG_LL(argSq));\r\nnegate_Xsig(&accumulator);\r\npolynomial_Xsig(&accumulator, &XSIG_LL(argSqSq), oddnegterms,\r\nHIPOWERon - 1);\r\nnegate_Xsig(&accumulator);\r\nadd_two_Xsig(&accumulator, &fixedpterm, &dummy_exp);\r\nmul64_Xsig(&accumulatore, &denomterm);\r\nshr_Xsig(&accumulatore, 1 + 2 * (-1 - exponent));\r\naccumulatore.msw |= 0x80000000;\r\ndiv_Xsig(&accumulator, &accumulatore, &accumulator);\r\nmul_Xsig_Xsig(&accumulator, &argSignif);\r\nmul_Xsig_Xsig(&accumulator, &argSq);\r\nshr_Xsig(&accumulator, 3);\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &argSignif);\r\nif (transformed) {\r\nshr_Xsig(&accumulator, -1 - exponent);\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &pi_signif);\r\nexponent = -1;\r\n}\r\nif (inverted) {\r\nshr_Xsig(&accumulator, -exponent);\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &pi_signif);\r\nexponent = 0;\r\n}\r\nif (sign1) {\r\nshr_Xsig(&accumulator, 1 - exponent);\r\nnegate_Xsig(&accumulator);\r\nadd_Xsig_Xsig(&accumulator, &pi_signif);\r\nexponent = 1;\r\n}\r\nexponent += round_Xsig(&accumulator);\r\nsignificand(st1_ptr) = XSIG_LL(accumulator);\r\nsetexponent16(st1_ptr, exponent);\r\ntag = FPU_round(st1_ptr, 1, 0, FULL_PRECISION, sign2);\r\nFPU_settagi(1, tag);\r\nset_precision_flag_up();\r\n}

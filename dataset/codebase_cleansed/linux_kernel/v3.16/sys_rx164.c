static inline void\r\nrx164_update_irq_hw(unsigned long mask)\r\n{\r\nvolatile unsigned int *irq_mask;\r\nirq_mask = (void *)(POLARIS_DENSE_CONFIG_BASE + 0x74);\r\n*irq_mask = mask;\r\nmb();\r\n*irq_mask;\r\n}\r\nstatic inline void\r\nrx164_enable_irq(struct irq_data *d)\r\n{\r\nrx164_update_irq_hw(cached_irq_mask |= 1UL << (d->irq - 16));\r\n}\r\nstatic void\r\nrx164_disable_irq(struct irq_data *d)\r\n{\r\nrx164_update_irq_hw(cached_irq_mask &= ~(1UL << (d->irq - 16)));\r\n}\r\nstatic void\r\nrx164_device_interrupt(unsigned long vector)\r\n{\r\nunsigned long pld;\r\nvolatile unsigned int *dirr;\r\nlong i;\r\ndirr = (void *)(POLARIS_DENSE_CONFIG_BASE + 0x84);\r\npld = *dirr;\r\nwhile (pld) {\r\ni = ffz(~pld);\r\npld &= pld - 1;\r\nif (i == 20) {\r\nisa_no_iack_sc_device_interrupt(vector);\r\n} else {\r\nhandle_irq(16+i);\r\n}\r\n}\r\n}\r\nstatic void __init\r\nrx164_init_irq(void)\r\n{\r\nlong i;\r\nrx164_update_irq_hw(0);\r\nfor (i = 16; i < 40; ++i) {\r\nirq_set_chip_and_handler(i, &rx164_irq_type, handle_level_irq);\r\nirq_set_status_flags(i, IRQ_LEVEL);\r\n}\r\ninit_i8259a_irqs();\r\ncommon_init_isa_dma();\r\nsetup_irq(16+20, &isa_cascade_irqaction);\r\n}\r\nstatic int __init\r\nrx164_map_irq(const struct pci_dev *dev, u8 slot, u8 pin)\r\n{\r\n#if 0\r\nstatic char irq_tab_pass1[6][5] __initdata = {\r\n{ 16+3, 16+3, 16+8, 16+13, 16+18},\r\n{ 16+5, 16+5, 16+10, 16+15, 16+20},\r\n{ 16+4, 16+4, 16+9, 16+14, 16+19},\r\n{ -1, -1, -1, -1, -1},\r\n{ 16+2, 16+2, 16+7, 16+12, 16+17},\r\n{ 16+1, 16+1, 16+6, 16+11, 16+16},\r\n};\r\n#else\r\nstatic char irq_tab[6][5] __initdata = {\r\n{ 16+0, 16+0, 16+6, 16+11, 16+16},\r\n{ 16+1, 16+1, 16+7, 16+12, 16+17},\r\n{ -1, -1, -1, -1, -1},\r\n{ 16+2, 16+2, 16+8, 16+13, 16+18},\r\n{ 16+3, 16+3, 16+9, 16+14, 16+19},\r\n{ 16+4, 16+4, 16+10, 16+15, 16+5},\r\n};\r\n#endif\r\nconst long min_idsel = 5, max_idsel = 10, irqs_per_slot = 5;\r\nreturn COMMON_TABLE_LOOKUP;\r\n}

static inline unsigned int ioready(void)\r\n{\r\nreturn readl(bus_status) & 1;\r\n}\r\nstatic inline void wait_ioready(void)\r\n{\r\ndo { } while (!ioready());\r\n}\r\nstatic inline void wait_ioclear(void)\r\n{\r\ndo { } while (ioready());\r\n}\r\nstatic inline void check_ioclear(void)\r\n{\r\nif (ioready()) {\r\npr_debug("ioclear: initially busy\n");\r\ndo {\r\n(void) readl(bus_xfer);\r\nDELAY();\r\n} while (ioready());\r\npr_debug("ioclear: cleared busy\n");\r\n}\r\n}\r\nu32 pic32_bus_readl(u32 reg)\r\n{\r\nunsigned long flags;\r\nu32 status, val;\r\nspin_lock_irqsave(&pic32_bus_lock, flags);\r\ncheck_ioclear();\r\nwritel((PIC32_RD << 24) | (reg & 0x00ffffff), bus_xfer);\r\nDELAY();\r\nwait_ioready();\r\nstatus = readl(bus_xfer);\r\nDELAY();\r\nval = readl(bus_xfer);\r\nwait_ioclear();\r\npr_debug("pic32_bus_readl: *%x -> %x (status=%x)\n", reg, val, status);\r\nspin_unlock_irqrestore(&pic32_bus_lock, flags);\r\nreturn val;\r\n}\r\nvoid pic32_bus_writel(u32 val, u32 reg)\r\n{\r\nunsigned long flags;\r\nu32 status;\r\nspin_lock_irqsave(&pic32_bus_lock, flags);\r\ncheck_ioclear();\r\nwritel((PIC32_WR << 24) | (reg & 0x00ffffff), bus_xfer);\r\nDELAY();\r\nwritel(val, bus_xfer);\r\nDELAY();\r\nwait_ioready();\r\nstatus = readl(bus_xfer);\r\nwait_ioclear();\r\npr_debug("pic32_bus_writel: *%x <- %x (status=%x)\n", reg, val, status);\r\nspin_unlock_irqrestore(&pic32_bus_lock, flags);\r\n}

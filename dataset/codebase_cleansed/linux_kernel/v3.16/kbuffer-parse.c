static void *zmalloc(size_t size)\r\n{\r\nreturn calloc(1, size);\r\n}\r\nstatic int host_is_bigendian(void)\r\n{\r\nunsigned char str[] = { 0x1, 0x2, 0x3, 0x4 };\r\nunsigned int *ptr;\r\nptr = (unsigned int *)str;\r\nreturn *ptr == 0x01020304;\r\n}\r\nstatic int do_swap(struct kbuffer *kbuf)\r\n{\r\nreturn ((kbuf->flags & KBUFFER_FL_HOST_BIG_ENDIAN) + kbuf->flags) &\r\nENDIAN_MASK;\r\n}\r\nstatic unsigned long long __read_8(void *ptr)\r\n{\r\nunsigned long long data = *(unsigned long long *)ptr;\r\nreturn data;\r\n}\r\nstatic unsigned long long __read_8_sw(void *ptr)\r\n{\r\nunsigned long long data = *(unsigned long long *)ptr;\r\nunsigned long long swap;\r\nswap = ((data & 0xffULL) << 56) |\r\n((data & (0xffULL << 8)) << 40) |\r\n((data & (0xffULL << 16)) << 24) |\r\n((data & (0xffULL << 24)) << 8) |\r\n((data & (0xffULL << 32)) >> 8) |\r\n((data & (0xffULL << 40)) >> 24) |\r\n((data & (0xffULL << 48)) >> 40) |\r\n((data & (0xffULL << 56)) >> 56);\r\nreturn swap;\r\n}\r\nstatic unsigned int __read_4(void *ptr)\r\n{\r\nunsigned int data = *(unsigned int *)ptr;\r\nreturn data;\r\n}\r\nstatic unsigned int __read_4_sw(void *ptr)\r\n{\r\nunsigned int data = *(unsigned int *)ptr;\r\nunsigned int swap;\r\nswap = ((data & 0xffULL) << 24) |\r\n((data & (0xffULL << 8)) << 8) |\r\n((data & (0xffULL << 16)) >> 8) |\r\n((data & (0xffULL << 24)) >> 24);\r\nreturn swap;\r\n}\r\nstatic unsigned long long read_8(struct kbuffer *kbuf, void *ptr)\r\n{\r\nreturn kbuf->read_8(ptr);\r\n}\r\nstatic unsigned int read_4(struct kbuffer *kbuf, void *ptr)\r\n{\r\nreturn kbuf->read_4(ptr);\r\n}\r\nstatic unsigned long long __read_long_8(struct kbuffer *kbuf, void *ptr)\r\n{\r\nreturn kbuf->read_8(ptr);\r\n}\r\nstatic unsigned long long __read_long_4(struct kbuffer *kbuf, void *ptr)\r\n{\r\nreturn kbuf->read_4(ptr);\r\n}\r\nstatic unsigned long long read_long(struct kbuffer *kbuf, void *ptr)\r\n{\r\nreturn kbuf->read_long(kbuf, ptr);\r\n}\r\nstatic int calc_index(struct kbuffer *kbuf, void *ptr)\r\n{\r\nreturn (unsigned long)ptr - (unsigned long)kbuf->data;\r\n}\r\nstruct kbuffer *\r\nkbuffer_alloc(enum kbuffer_long_size size, enum kbuffer_endian endian)\r\n{\r\nstruct kbuffer *kbuf;\r\nint flags = 0;\r\nswitch (size) {\r\ncase KBUFFER_LSIZE_4:\r\nbreak;\r\ncase KBUFFER_LSIZE_8:\r\nflags |= KBUFFER_FL_LONG_8;\r\nbreak;\r\ndefault:\r\nreturn NULL;\r\n}\r\nswitch (endian) {\r\ncase KBUFFER_ENDIAN_LITTLE:\r\nbreak;\r\ncase KBUFFER_ENDIAN_BIG:\r\nflags |= KBUFFER_FL_BIG_ENDIAN;\r\nbreak;\r\ndefault:\r\nreturn NULL;\r\n}\r\nkbuf = zmalloc(sizeof(*kbuf));\r\nif (!kbuf)\r\nreturn NULL;\r\nkbuf->flags = flags;\r\nif (host_is_bigendian())\r\nkbuf->flags |= KBUFFER_FL_HOST_BIG_ENDIAN;\r\nif (do_swap(kbuf)) {\r\nkbuf->read_8 = __read_8_sw;\r\nkbuf->read_4 = __read_4_sw;\r\n} else {\r\nkbuf->read_8 = __read_8;\r\nkbuf->read_4 = __read_4;\r\n}\r\nif (kbuf->flags & KBUFFER_FL_LONG_8)\r\nkbuf->read_long = __read_long_8;\r\nelse\r\nkbuf->read_long = __read_long_4;\r\nkbuf->next_event = __next_event;\r\nreturn kbuf;\r\n}\r\nvoid kbuffer_free(struct kbuffer *kbuf)\r\n{\r\nfree(kbuf);\r\n}\r\nstatic unsigned int type4host(struct kbuffer *kbuf,\r\nunsigned int type_len_ts)\r\n{\r\nif (kbuf->flags & KBUFFER_FL_BIG_ENDIAN)\r\nreturn (type_len_ts >> 29) & 3;\r\nelse\r\nreturn type_len_ts & 3;\r\n}\r\nstatic unsigned int len4host(struct kbuffer *kbuf,\r\nunsigned int type_len_ts)\r\n{\r\nif (kbuf->flags & KBUFFER_FL_BIG_ENDIAN)\r\nreturn (type_len_ts >> 27) & 7;\r\nelse\r\nreturn (type_len_ts >> 2) & 7;\r\n}\r\nstatic unsigned int type_len4host(struct kbuffer *kbuf,\r\nunsigned int type_len_ts)\r\n{\r\nif (kbuf->flags & KBUFFER_FL_BIG_ENDIAN)\r\nreturn (type_len_ts >> 27) & ((1 << 5) - 1);\r\nelse\r\nreturn type_len_ts & ((1 << 5) - 1);\r\n}\r\nstatic unsigned int ts4host(struct kbuffer *kbuf,\r\nunsigned int type_len_ts)\r\n{\r\nif (kbuf->flags & KBUFFER_FL_BIG_ENDIAN)\r\nreturn type_len_ts & ((1 << 27) - 1);\r\nelse\r\nreturn type_len_ts >> 5;\r\n}\r\nstatic unsigned int old_update_pointers(struct kbuffer *kbuf)\r\n{\r\nunsigned long long extend;\r\nunsigned int type_len_ts;\r\nunsigned int type;\r\nunsigned int len;\r\nunsigned int delta;\r\nunsigned int length;\r\nvoid *ptr = kbuf->data + kbuf->curr;\r\ntype_len_ts = read_4(kbuf, ptr);\r\nptr += 4;\r\ntype = type4host(kbuf, type_len_ts);\r\nlen = len4host(kbuf, type_len_ts);\r\ndelta = ts4host(kbuf, type_len_ts);\r\nswitch (type) {\r\ncase OLD_RINGBUF_TYPE_PADDING:\r\nkbuf->next = kbuf->size;\r\nreturn 0;\r\ncase OLD_RINGBUF_TYPE_TIME_EXTEND:\r\nextend = read_4(kbuf, ptr);\r\nextend <<= TS_SHIFT;\r\nextend += delta;\r\ndelta = extend;\r\nptr += 4;\r\nbreak;\r\ncase OLD_RINGBUF_TYPE_TIME_STAMP:\r\nkbuf->curr = kbuf->size;\r\nkbuf->next = kbuf->size;\r\nkbuf->index = kbuf->size;\r\nreturn -1;\r\ndefault:\r\nif (len)\r\nlength = len * 4;\r\nelse {\r\nlength = read_4(kbuf, ptr);\r\nlength -= 4;\r\nptr += 4;\r\n}\r\nbreak;\r\n}\r\nkbuf->timestamp += delta;\r\nkbuf->index = calc_index(kbuf, ptr);\r\nkbuf->next = kbuf->index + length;\r\nreturn type;\r\n}\r\nstatic int __old_next_event(struct kbuffer *kbuf)\r\n{\r\nint type;\r\ndo {\r\nkbuf->curr = kbuf->next;\r\nif (kbuf->next >= kbuf->size)\r\nreturn -1;\r\ntype = old_update_pointers(kbuf);\r\n} while (type == OLD_RINGBUF_TYPE_TIME_EXTEND || type == OLD_RINGBUF_TYPE_PADDING);\r\nreturn 0;\r\n}\r\nstatic unsigned int\r\ntranslate_data(struct kbuffer *kbuf, void *data, void **rptr,\r\nunsigned long long *delta, int *length)\r\n{\r\nunsigned long long extend;\r\nunsigned int type_len_ts;\r\nunsigned int type_len;\r\ntype_len_ts = read_4(kbuf, data);\r\ndata += 4;\r\ntype_len = type_len4host(kbuf, type_len_ts);\r\n*delta = ts4host(kbuf, type_len_ts);\r\nswitch (type_len) {\r\ncase KBUFFER_TYPE_PADDING:\r\n*length = read_4(kbuf, data);\r\ndata += *length;\r\nbreak;\r\ncase KBUFFER_TYPE_TIME_EXTEND:\r\nextend = read_4(kbuf, data);\r\ndata += 4;\r\nextend <<= TS_SHIFT;\r\nextend += *delta;\r\n*delta = extend;\r\n*length = 0;\r\nbreak;\r\ncase KBUFFER_TYPE_TIME_STAMP:\r\ndata += 12;\r\n*length = 0;\r\nbreak;\r\ncase 0:\r\n*length = read_4(kbuf, data) - 4;\r\n*length = (*length + 3) & ~3;\r\ndata += 4;\r\nbreak;\r\ndefault:\r\n*length = type_len * 4;\r\nbreak;\r\n}\r\n*rptr = data;\r\nreturn type_len;\r\n}\r\nstatic unsigned int update_pointers(struct kbuffer *kbuf)\r\n{\r\nunsigned long long delta;\r\nunsigned int type_len;\r\nint length;\r\nvoid *ptr = kbuf->data + kbuf->curr;\r\ntype_len = translate_data(kbuf, ptr, &ptr, &delta, &length);\r\nkbuf->timestamp += delta;\r\nkbuf->index = calc_index(kbuf, ptr);\r\nkbuf->next = kbuf->index + length;\r\nreturn type_len;\r\n}\r\nvoid *kbuffer_translate_data(int swap, void *data, unsigned int *size)\r\n{\r\nunsigned long long delta;\r\nstruct kbuffer kbuf;\r\nint type_len;\r\nint length;\r\nvoid *ptr;\r\nif (swap) {\r\nkbuf.read_8 = __read_8_sw;\r\nkbuf.read_4 = __read_4_sw;\r\nkbuf.flags = host_is_bigendian() ? 0 : KBUFFER_FL_BIG_ENDIAN;\r\n} else {\r\nkbuf.read_8 = __read_8;\r\nkbuf.read_4 = __read_4;\r\nkbuf.flags = host_is_bigendian() ? KBUFFER_FL_BIG_ENDIAN: 0;\r\n}\r\ntype_len = translate_data(&kbuf, data, &ptr, &delta, &length);\r\nswitch (type_len) {\r\ncase KBUFFER_TYPE_PADDING:\r\ncase KBUFFER_TYPE_TIME_EXTEND:\r\ncase KBUFFER_TYPE_TIME_STAMP:\r\nreturn NULL;\r\n};\r\n*size = length;\r\nreturn ptr;\r\n}\r\nstatic int __next_event(struct kbuffer *kbuf)\r\n{\r\nint type;\r\ndo {\r\nkbuf->curr = kbuf->next;\r\nif (kbuf->next >= kbuf->size)\r\nreturn -1;\r\ntype = update_pointers(kbuf);\r\n} while (type == KBUFFER_TYPE_TIME_EXTEND || type == KBUFFER_TYPE_PADDING);\r\nreturn 0;\r\n}\r\nstatic int next_event(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->next_event(kbuf);\r\n}\r\nvoid *kbuffer_next_event(struct kbuffer *kbuf, unsigned long long *ts)\r\n{\r\nint ret;\r\nif (!kbuf || !kbuf->subbuffer)\r\nreturn NULL;\r\nret = next_event(kbuf);\r\nif (ret < 0)\r\nreturn NULL;\r\nif (ts)\r\n*ts = kbuf->timestamp;\r\nreturn kbuf->data + kbuf->index;\r\n}\r\nint kbuffer_load_subbuffer(struct kbuffer *kbuf, void *subbuffer)\r\n{\r\nunsigned long long flags;\r\nvoid *ptr = subbuffer;\r\nif (!kbuf || !subbuffer)\r\nreturn -1;\r\nkbuf->subbuffer = subbuffer;\r\nkbuf->timestamp = read_8(kbuf, ptr);\r\nptr += 8;\r\nkbuf->curr = 0;\r\nif (kbuf->flags & KBUFFER_FL_LONG_8)\r\nkbuf->start = 16;\r\nelse\r\nkbuf->start = 12;\r\nkbuf->data = subbuffer + kbuf->start;\r\nflags = read_long(kbuf, ptr);\r\nkbuf->size = (unsigned int)flags & COMMIT_MASK;\r\nif (flags & MISSING_EVENTS) {\r\nif (flags & MISSING_STORED) {\r\nptr = kbuf->data + kbuf->size;\r\nkbuf->lost_events = read_long(kbuf, ptr);\r\n} else\r\nkbuf->lost_events = -1;\r\n} else\r\nkbuf->lost_events = 0;\r\nkbuf->index = 0;\r\nkbuf->next = 0;\r\nnext_event(kbuf);\r\nreturn 0;\r\n}\r\nvoid *kbuffer_read_event(struct kbuffer *kbuf, unsigned long long *ts)\r\n{\r\nif (!kbuf || !kbuf->subbuffer)\r\nreturn NULL;\r\nif (kbuf->curr >= kbuf->size)\r\nreturn NULL;\r\nif (ts)\r\n*ts = kbuf->timestamp;\r\nreturn kbuf->data + kbuf->index;\r\n}\r\nunsigned long long kbuffer_timestamp(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->timestamp;\r\n}\r\nvoid *kbuffer_read_at_offset(struct kbuffer *kbuf, int offset,\r\nunsigned long long *ts)\r\n{\r\nvoid *data;\r\nif (offset < kbuf->start)\r\noffset = 0;\r\nelse\r\noffset -= kbuf->start;\r\nkbuffer_load_subbuffer(kbuf, kbuf->subbuffer);\r\nwhile (kbuf->curr < offset) {\r\ndata = kbuffer_next_event(kbuf, ts);\r\nif (!data)\r\nbreak;\r\n}\r\nreturn data;\r\n}\r\nint kbuffer_subbuffer_size(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->size;\r\n}\r\nint kbuffer_curr_index(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->curr;\r\n}\r\nint kbuffer_curr_offset(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->curr + kbuf->start;\r\n}\r\nint kbuffer_event_size(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->next - kbuf->index;\r\n}\r\nint kbuffer_curr_size(struct kbuffer *kbuf)\r\n{\r\nreturn kbuf->next - kbuf->curr;\r\n}\r\nint kbuffer_missed_events(struct kbuffer *kbuf)\r\n{\r\nif (kbuf->curr)\r\nreturn 0;\r\nreturn kbuf->lost_events;\r\n}\r\nvoid kbuffer_set_old_format(struct kbuffer *kbuf)\r\n{\r\nkbuf->flags |= KBUFFER_FL_OLD_FORMAT;\r\nkbuf->next_event = __old_next_event;\r\n}

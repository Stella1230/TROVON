static int __init efifb_set_system(const struct dmi_system_id *id)\r\n{\r\nstruct efifb_dmi_info *info = id->driver_data;\r\nif (info->base == 0 && info->height == 0 && info->width == 0 &&\r\ninfo->stride == 0)\r\nreturn 0;\r\nif (screen_info.lfb_base == 0) {\r\n#if defined(CONFIG_PCI)\r\nstruct pci_dev *dev = NULL;\r\nint found_bar = 0;\r\n#endif\r\nif (info->base) {\r\nscreen_info.lfb_base = choose_value(info->base,\r\nscreen_info.lfb_base, OVERRIDE_BASE,\r\ninfo->flags);\r\n#if defined(CONFIG_PCI)\r\nfor_each_pci_dev(dev) {\r\nint i;\r\nif ((dev->class >> 8) != PCI_CLASS_DISPLAY_VGA)\r\ncontinue;\r\nfor (i = 0; i < DEVICE_COUNT_RESOURCE; i++) {\r\nresource_size_t start, end;\r\nstart = pci_resource_start(dev, i);\r\nif (start == 0)\r\nbreak;\r\nend = pci_resource_end(dev, i);\r\nif (screen_info.lfb_base >= start &&\r\nscreen_info.lfb_base < end) {\r\nfound_bar = 1;\r\n}\r\n}\r\n}\r\nif (!found_bar)\r\nscreen_info.lfb_base = 0;\r\n#endif\r\n}\r\n}\r\nif (screen_info.lfb_base) {\r\nscreen_info.lfb_linelength = choose_value(info->stride,\r\nscreen_info.lfb_linelength, OVERRIDE_STRIDE,\r\ninfo->flags);\r\nscreen_info.lfb_width = choose_value(info->width,\r\nscreen_info.lfb_width, OVERRIDE_WIDTH,\r\ninfo->flags);\r\nscreen_info.lfb_height = choose_value(info->height,\r\nscreen_info.lfb_height, OVERRIDE_HEIGHT,\r\ninfo->flags);\r\nif (screen_info.orig_video_isVGA == 0)\r\nscreen_info.orig_video_isVGA = VIDEO_TYPE_EFI;\r\n} else {\r\nscreen_info.lfb_linelength = 0;\r\nscreen_info.lfb_width = 0;\r\nscreen_info.lfb_height = 0;\r\nscreen_info.orig_video_isVGA = 0;\r\nreturn 0;\r\n}\r\nprintk(KERN_INFO "efifb: dmi detected %s - framebuffer at 0x%08x "\r\n"(%dx%d, stride %d)\n", id->ident,\r\nscreen_info.lfb_base, screen_info.lfb_width,\r\nscreen_info.lfb_height, screen_info.lfb_linelength);\r\nreturn 1;\r\n}\r\n__init void sysfb_apply_efi_quirks(void)\r\n{\r\nif (screen_info.orig_video_isVGA != VIDEO_TYPE_EFI ||\r\n!(screen_info.capabilities & VIDEO_CAPABILITY_SKIP_QUIRKS))\r\ndmi_check_system(efifb_dmi_system_table);\r\n}

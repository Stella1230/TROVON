static void pmc_start_ctrs(void)\r\n{\r\nu32 mmcr0 = mfspr(SPRN_MMCR0);\r\nmmcr0 &= ~(MMCR0_FC | MMCR0_FCM0);\r\nmmcr0 |= (MMCR0_FCECE | MMCR0_PMC1CE | MMCR0_PMCnCE | MMCR0_PMXE);\r\nmtspr(SPRN_MMCR0, mmcr0);\r\n}\r\nstatic void pmc_stop_ctrs(void)\r\n{\r\nu32 mmcr0 = mfspr(SPRN_MMCR0);\r\nmmcr0 |= MMCR0_FC;\r\nmmcr0 &= ~(MMCR0_FCECE | MMCR0_PMC1CE | MMCR0_PMCnCE | MMCR0_PMXE);\r\nmtspr(SPRN_MMCR0, mmcr0);\r\n}\r\nstatic int fsl7450_cpu_setup(struct op_counter_config *ctr)\r\n{\r\npmc_stop_ctrs();\r\nmtspr(SPRN_MMCR0, mmcr0_val);\r\nmtspr(SPRN_MMCR1, mmcr1_val);\r\nif (num_pmcs > 4)\r\nmtspr(SPRN_MMCR2, mmcr2_val);\r\nreturn 0;\r\n}\r\nstatic int fsl7450_reg_setup(struct op_counter_config *ctr,\r\nstruct op_system_config *sys,\r\nint num_ctrs)\r\n{\r\nint i;\r\nnum_pmcs = num_ctrs;\r\nfor (i = 0; i < num_ctrs; ++i)\r\nreset_value[i] = 0x80000000UL - ctr[i].count;\r\nmmcr0_val = MMCR0_INIT | mmcr0_event1(ctr[0].event)\r\n| mmcr0_event2(ctr[1].event);\r\nif (sys->enable_kernel)\r\nmmcr0_val &= ~(MMCR0_FCS);\r\nif (sys->enable_user)\r\nmmcr0_val &= ~(MMCR0_FCP);\r\nmmcr1_val = mmcr1_event3(ctr[2].event)\r\n| mmcr1_event4(ctr[3].event);\r\nif (num_ctrs > 4)\r\nmmcr1_val |= mmcr1_event5(ctr[4].event)\r\n| mmcr1_event6(ctr[5].event);\r\nmmcr2_val = 0;\r\nreturn 0;\r\n}\r\nstatic int fsl7450_start(struct op_counter_config *ctr)\r\n{\r\nint i;\r\nmtmsr(mfmsr() | MSR_PMM);\r\nfor (i = 0; i < num_pmcs; ++i) {\r\nif (ctr[i].enabled)\r\nclassic_ctr_write(i, reset_value[i]);\r\nelse\r\nclassic_ctr_write(i, 0);\r\n}\r\npmc_start_ctrs();\r\noprofile_running = 1;\r\nreturn 0;\r\n}\r\nstatic void fsl7450_stop(void)\r\n{\r\npmc_stop_ctrs();\r\noprofile_running = 0;\r\nmb();\r\n}\r\nstatic void fsl7450_handle_interrupt(struct pt_regs *regs,\r\nstruct op_counter_config *ctr)\r\n{\r\nunsigned long pc;\r\nint is_kernel;\r\nint val;\r\nint i;\r\nmtmsr(mfmsr() | MSR_PMM);\r\npc = mfspr(SPRN_SIAR);\r\nis_kernel = is_kernel_addr(pc);\r\nfor (i = 0; i < num_pmcs; ++i) {\r\nval = classic_ctr_read(i);\r\nif (val < 0) {\r\nif (oprofile_running && ctr[i].enabled) {\r\noprofile_add_ext_sample(pc, regs, i, is_kernel);\r\nclassic_ctr_write(i, reset_value[i]);\r\n} else {\r\nclassic_ctr_write(i, 0);\r\n}\r\n}\r\n}\r\npmc_start_ctrs();\r\n}

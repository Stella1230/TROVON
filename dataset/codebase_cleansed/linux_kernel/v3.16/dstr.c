static int dstr_read_regr( PIA *pi, int cont, int regr )\r\n{ int a, b, r;\r\nr = regr + cont_map[cont];\r\nw0(0x81); P1;\r\nif (pi->mode) { w0(0x11); } else { w0(1); }\r\nP2; w0(r); P1;\r\nswitch (pi->mode) {\r\ncase 0: w2(6); a = r1(); w2(4); w2(6); b = r1(); w2(4);\r\nreturn j44(a,b);\r\ncase 1: w0(0); w2(0x26); a = r0(); w2(4);\r\nreturn a;\r\ncase 2:\r\ncase 3:\r\ncase 4: w2(0x24); a = r4(); w2(4);\r\nreturn a;\r\n}\r\nreturn -1;\r\n}\r\nstatic void dstr_write_regr( PIA *pi, int cont, int regr, int val )\r\n{ int r;\r\nr = regr + cont_map[cont];\r\nw0(0x81); P1;\r\nif (pi->mode >= 2) { w0(0x11); } else { w0(1); }\r\nP2; w0(r); P1;\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1: w0(val); w2(5); w2(7); w2(5); w2(4);\r\nbreak;\r\ncase 2:\r\ncase 3:\r\ncase 4: w4(val);\r\nbreak;\r\n}\r\n}\r\nstatic void dstr_connect ( PIA *pi )\r\n{ pi->saved_r0 = r0();\r\npi->saved_r2 = r2();\r\nw2(4); CCP(0xe0); w0(0xff);\r\n}\r\nstatic void dstr_disconnect ( PIA *pi )\r\n{ CCP(0x30);\r\nw0(pi->saved_r0);\r\nw2(pi->saved_r2);\r\n}\r\nstatic void dstr_read_block( PIA *pi, char * buf, int count )\r\n{ int k, a, b;\r\nw0(0x81); P1;\r\nif (pi->mode) { w0(0x19); } else { w0(9); }\r\nP2; w0(0x82); P1; P3; w0(0x20); P1;\r\nswitch (pi->mode) {\r\ncase 0: for (k=0;k<count;k++) {\r\nw2(6); a = r1(); w2(4);\r\nw2(6); b = r1(); w2(4);\r\nbuf[k] = j44(a,b);\r\n}\r\nbreak;\r\ncase 1: w0(0);\r\nfor (k=0;k<count;k++) {\r\nw2(0x26); buf[k] = r0(); w2(0x24);\r\n}\r\nw2(4);\r\nbreak;\r\ncase 2: w2(0x24);\r\nfor (k=0;k<count;k++) buf[k] = r4();\r\nw2(4);\r\nbreak;\r\ncase 3: w2(0x24);\r\nfor (k=0;k<count/2;k++) ((u16 *)buf)[k] = r4w();\r\nw2(4);\r\nbreak;\r\ncase 4: w2(0x24);\r\nfor (k=0;k<count/4;k++) ((u32 *)buf)[k] = r4l();\r\nw2(4);\r\nbreak;\r\n}\r\n}\r\nstatic void dstr_write_block( PIA *pi, char * buf, int count )\r\n{ int k;\r\nw0(0x81); P1;\r\nif (pi->mode) { w0(0x19); } else { w0(9); }\r\nP2; w0(0x82); P1; P3; w0(0x20); P1;\r\nswitch (pi->mode) {\r\ncase 0:\r\ncase 1: for (k=0;k<count;k++) {\r\nw2(5); w0(buf[k]); w2(7);\r\n}\r\nw2(5); w2(4);\r\nbreak;\r\ncase 2: w2(0xc5);\r\nfor (k=0;k<count;k++) w4(buf[k]);\r\nw2(0xc4);\r\nbreak;\r\ncase 3: w2(0xc5);\r\nfor (k=0;k<count/2;k++) w4w(((u16 *)buf)[k]);\r\nw2(0xc4);\r\nbreak;\r\ncase 4: w2(0xc5);\r\nfor (k=0;k<count/4;k++) w4l(((u32 *)buf)[k]);\r\nw2(0xc4);\r\nbreak;\r\n}\r\n}\r\nstatic void dstr_log_adapter( PIA *pi, char * scratch, int verbose )\r\n{ char *mode_string[5] = {"4-bit","8-bit","EPP-8",\r\n"EPP-16","EPP-32"};\r\nprintk("%s: dstr %s, DataStor EP2000 at 0x%x, ",\r\npi->device,DSTR_VERSION,pi->port);\r\nprintk("mode %d (%s), delay %d\n",pi->mode,\r\nmode_string[pi->mode],pi->delay);\r\n}\r\nstatic int __init dstr_init(void)\r\n{\r\nreturn paride_register(&dstr);\r\n}\r\nstatic void __exit dstr_exit(void)\r\n{\r\nparide_unregister(&dstr);\r\n}

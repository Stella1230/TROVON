static void hp680bl_send_intensity(struct backlight_device *bd)\r\n{\r\nunsigned long flags;\r\nu16 v;\r\nint intensity = bd->props.brightness;\r\nif (bd->props.power != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (bd->props.fb_blank != FB_BLANK_UNBLANK)\r\nintensity = 0;\r\nif (hp680bl_suspended)\r\nintensity = 0;\r\nspin_lock_irqsave(&bl_lock, flags);\r\nif (intensity && current_intensity == 0) {\r\nsh_dac_enable(DAC_LCD_BRIGHTNESS);\r\nv = inw(HD64461_GPBDR);\r\nv &= ~HD64461_GPBDR_LCDOFF;\r\noutw(v, HD64461_GPBDR);\r\nsh_dac_output(255-(u8)intensity, DAC_LCD_BRIGHTNESS);\r\n} else if (intensity == 0 && current_intensity != 0) {\r\nsh_dac_output(255-(u8)intensity, DAC_LCD_BRIGHTNESS);\r\nsh_dac_disable(DAC_LCD_BRIGHTNESS);\r\nv = inw(HD64461_GPBDR);\r\nv |= HD64461_GPBDR_LCDOFF;\r\noutw(v, HD64461_GPBDR);\r\n} else if (intensity) {\r\nsh_dac_output(255-(u8)intensity, DAC_LCD_BRIGHTNESS);\r\n}\r\nspin_unlock_irqrestore(&bl_lock, flags);\r\ncurrent_intensity = intensity;\r\n}\r\nstatic int hp680bl_suspend(struct device *dev)\r\n{\r\nstruct backlight_device *bd = dev_get_drvdata(dev);\r\nhp680bl_suspended = 1;\r\nhp680bl_send_intensity(bd);\r\nreturn 0;\r\n}\r\nstatic int hp680bl_resume(struct device *dev)\r\n{\r\nstruct backlight_device *bd = dev_get_drvdata(dev);\r\nhp680bl_suspended = 0;\r\nhp680bl_send_intensity(bd);\r\nreturn 0;\r\n}\r\nstatic int hp680bl_set_intensity(struct backlight_device *bd)\r\n{\r\nhp680bl_send_intensity(bd);\r\nreturn 0;\r\n}\r\nstatic int hp680bl_get_intensity(struct backlight_device *bd)\r\n{\r\nreturn current_intensity;\r\n}\r\nstatic int hp680bl_probe(struct platform_device *pdev)\r\n{\r\nstruct backlight_properties props;\r\nstruct backlight_device *bd;\r\nmemset(&props, 0, sizeof(struct backlight_properties));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = HP680_MAX_INTENSITY;\r\nbd = devm_backlight_device_register(&pdev->dev, "hp680-bl", &pdev->dev,\r\nNULL, &hp680bl_ops, &props);\r\nif (IS_ERR(bd))\r\nreturn PTR_ERR(bd);\r\nplatform_set_drvdata(pdev, bd);\r\nbd->props.brightness = HP680_DEFAULT_INTENSITY;\r\nhp680bl_send_intensity(bd);\r\nreturn 0;\r\n}\r\nstatic int hp680bl_remove(struct platform_device *pdev)\r\n{\r\nstruct backlight_device *bd = platform_get_drvdata(pdev);\r\nbd->props.brightness = 0;\r\nbd->props.power = 0;\r\nhp680bl_send_intensity(bd);\r\nreturn 0;\r\n}\r\nstatic int __init hp680bl_init(void)\r\n{\r\nint ret;\r\nret = platform_driver_register(&hp680bl_driver);\r\nif (ret)\r\nreturn ret;\r\nhp680bl_device = platform_device_register_simple("hp680-bl", -1,\r\nNULL, 0);\r\nif (IS_ERR(hp680bl_device)) {\r\nplatform_driver_unregister(&hp680bl_driver);\r\nreturn PTR_ERR(hp680bl_device);\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit hp680bl_exit(void)\r\n{\r\nplatform_device_unregister(hp680bl_device);\r\nplatform_driver_unregister(&hp680bl_driver);\r\n}

static void __init hdmi_init_pm_clock(void)\r\n{\r\nstruct clk *hdmi_ick = clk_get(&hdmi_device.dev, "ick");\r\nint ret;\r\nlong rate;\r\nif (IS_ERR(hdmi_ick)) {\r\nret = PTR_ERR(hdmi_ick);\r\npr_err("Cannot get HDMI ICK: %d\n", ret);\r\ngoto out;\r\n}\r\nret = clk_set_parent(&sh7372_pllc2_clk, &sh7372_dv_clki_div2_clk);\r\nif (ret < 0) {\r\npr_err("Cannot set PLLC2 parent: %d, %d users\n",\r\nret, sh7372_pllc2_clk.usecount);\r\ngoto out;\r\n}\r\npr_debug("PLLC2 initial frequency %lu\n",\r\nclk_get_rate(&sh7372_pllc2_clk));\r\nrate = clk_round_rate(&sh7372_pllc2_clk, 594000000);\r\nif (rate <= 0) {\r\npr_err("Cannot get suitable rate: %ld\n", rate);\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = clk_set_rate(&sh7372_pllc2_clk, rate);\r\nif (ret < 0) {\r\npr_err("Cannot set rate %ld: %d\n", rate, ret);\r\ngoto out;\r\n}\r\npr_debug("PLLC2 set frequency %lu\n", rate);\r\nret = clk_set_parent(hdmi_ick, &sh7372_pllc2_clk);\r\nif (ret < 0)\r\npr_err("Cannot set HDMI parent: %d\n", ret);\r\nout:\r\nif (!IS_ERR(hdmi_ick))\r\nclk_put(hdmi_ick);\r\n}\r\nstatic int usbhs_get_vbus(struct platform_device *pdev)\r\n{\r\nreturn usbhs_is_connected(usbhs_get_priv(pdev));\r\n}\r\nstatic int usbhs_phy_reset(struct platform_device *pdev)\r\n{\r\nstruct usbhs_private *priv = usbhs_get_priv(pdev);\r\n__raw_writew(0x8a0a, priv->usbcrcaddr);\r\nreturn 0;\r\n}\r\nstatic int usbhs0_get_id(struct platform_device *pdev)\r\n{\r\nreturn USBHS_GADGET;\r\n}\r\nstatic void usbhs0_work_function(struct work_struct *work)\r\n{\r\nstruct usbhs_private *priv = container_of(work, struct usbhs_private,\r\nwork.work);\r\nrenesas_usbhs_call_notify_hotplug(priv->pdev);\r\nschedule_delayed_work(&priv->work, USBHS0_POLL_INTERVAL);\r\n}\r\nstatic int usbhs0_hardware_init(struct platform_device *pdev)\r\n{\r\nstruct usbhs_private *priv = usbhs_get_priv(pdev);\r\npriv->pdev = pdev;\r\nINIT_DELAYED_WORK(&priv->work, usbhs0_work_function);\r\nschedule_delayed_work(&priv->work, USBHS0_POLL_INTERVAL);\r\nreturn 0;\r\n}\r\nstatic int usbhs0_hardware_exit(struct platform_device *pdev)\r\n{\r\nstruct usbhs_private *priv = usbhs_get_priv(pdev);\r\ncancel_delayed_work_sync(&priv->work);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t usbhs1_interrupt(int irq, void *data)\r\n{\r\nstruct platform_device *pdev = data;\r\nstruct usbhs_private *priv = usbhs_get_priv(pdev);\r\ndev_dbg(&pdev->dev, "%s\n", __func__);\r\nrenesas_usbhs_call_notify_hotplug(pdev);\r\n__raw_writew(__raw_readw(priv->usbphyaddr) | USB_PHY_INT_CLR,\r\npriv->usbphyaddr);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int usbhs1_hardware_init(struct platform_device *pdev)\r\n{\r\nstruct usbhs_private *priv = usbhs_get_priv(pdev);\r\nint ret;\r\n__raw_writew(USB_PHY_MODE | USB_PHY_INT_CLR, priv->usbphyaddr);\r\nret = request_irq(IRQ8, usbhs1_interrupt, IRQF_TRIGGER_HIGH,\r\ndev_name(&pdev->dev), pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "request_irq err\n");\r\nreturn ret;\r\n}\r\n__raw_writew(USB_PHY_MODE | USB_PHY_INT_EN, priv->usbphyaddr);\r\nreturn 0;\r\n}\r\nstatic int usbhs1_hardware_exit(struct platform_device *pdev)\r\n{\r\nstruct usbhs_private *priv = usbhs_get_priv(pdev);\r\n__raw_writew(USB_PHY_MODE | USB_PHY_INT_CLR, priv->usbphyaddr);\r\nfree_irq(IRQ8, pdev);\r\nreturn 0;\r\n}\r\nstatic int usbhs1_get_id(struct platform_device *pdev)\r\n{\r\nreturn USBHS_HOST;\r\n}\r\nstatic int camera_set_capture(struct soc_camera_platform_info *info,\r\nint enable)\r\n{\r\nreturn 0;\r\n}\r\nstatic void mackerel_camera_release(struct device *dev)\r\n{\r\nsoc_camera_platform_release(&camera_device);\r\n}\r\nstatic int mackerel_camera_add(struct soc_camera_device *icd)\r\n{\r\nreturn soc_camera_platform_add(icd, &camera_device, &camera_link,\r\nmackerel_camera_release, 0);\r\n}\r\nstatic void mackerel_camera_del(struct soc_camera_device *icd)\r\n{\r\nsoc_camera_platform_del(icd, camera_device, &camera_link);\r\n}\r\nstatic void __init mackerel_init(void)\r\n{\r\nstruct pm_domain_device domain_devices[] = {\r\n{ "A4LC", &lcdc_device, },\r\n{ "A4LC", &hdmi_lcdc_device, },\r\n{ "A4LC", &meram_device, },\r\n{ "A4MP", &fsi_device, },\r\n{ "A3SP", &usbhs0_device, },\r\n{ "A3SP", &usbhs1_device, },\r\n{ "A3SP", &nand_flash_device, },\r\n{ "A3SP", &sdhi0_device, },\r\n#if !IS_ENABLED(CONFIG_MMC_SH_MMCIF)\r\n{ "A3SP", &sdhi1_device, },\r\n#else\r\n{ "A3SP", &sh_mmcif_device, },\r\n#endif\r\n{ "A3SP", &sdhi2_device, },\r\n{ "A4R", &ceu_device, },\r\n};\r\nu32 srcr4;\r\nstruct clk *clk;\r\nregulator_register_always_on(0, "fixed-1.8V", fixed1v8_power_consumers,\r\nARRAY_SIZE(fixed1v8_power_consumers), 1800000);\r\nregulator_register_always_on(1, "fixed-3.3V", fixed3v3_power_consumers,\r\nARRAY_SIZE(fixed3v3_power_consumers), 3300000);\r\nregulator_register_fixed(2, dummy_supplies, ARRAY_SIZE(dummy_supplies));\r\nclk_set_rate(&sh7372_dv_clki_clk, 27000000);\r\npinctrl_register_mappings(mackerel_pinctrl_map,\r\nARRAY_SIZE(mackerel_pinctrl_map));\r\nsh7372_pinmux_init();\r\ngpio_request_one(151, GPIOF_OUT_INIT_HIGH, NULL);\r\ngpio_request_one(161, GPIOF_OUT_INIT_LOW, NULL);\r\ngpio_request(9, NULL);\r\ngpio_request(10, NULL);\r\ngpio_direction_none(GPIO_PORT9CR);\r\ngpio_direction_none(GPIO_PORT10CR);\r\nintc_set_priority(IRQ_FSI, 3);\r\n__raw_writew(__raw_readw(USCCR1) & ~(1 << 6), USCCR1);\r\nclk = clk_get(NULL, "spu_clk");\r\nif (!IS_ERR(clk)) {\r\nclk_set_rate(clk, clk_round_rate(clk, 119600000));\r\nclk_put(clk);\r\n}\r\nirq_set_irq_type(IRQ9, IRQ_TYPE_LEVEL_HIGH);\r\nirq_set_irq_type(IRQ7, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(IRQ21, IRQ_TYPE_LEVEL_HIGH);\r\nsrcr4 = __raw_readl(SRCR4);\r\n__raw_writel(srcr4 | (1 << 13), SRCR4);\r\nudelay(50);\r\n__raw_writel(srcr4 & ~(1 << 13), SRCR4);\r\ni2c_register_board_info(0, i2c0_devices,\r\nARRAY_SIZE(i2c0_devices));\r\ni2c_register_board_info(1, i2c1_devices,\r\nARRAY_SIZE(i2c1_devices));\r\nsh7372_add_standard_devices();\r\nplatform_add_devices(mackerel_devices, ARRAY_SIZE(mackerel_devices));\r\nrmobile_add_devices_to_domains(domain_devices,\r\nARRAY_SIZE(domain_devices));\r\nhdmi_init_pm_clock();\r\nsh7372_pm_init();\r\npm_clk_add(&fsi_device.dev, "spu2");\r\npm_clk_add(&hdmi_lcdc_device.dev, "hdmi");\r\n}

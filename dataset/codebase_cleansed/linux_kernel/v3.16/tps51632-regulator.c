static int tps51632_dcdc_set_ramp_delay(struct regulator_dev *rdev,\r\nint ramp_delay)\r\n{\r\nstruct tps51632_chip *tps = rdev_get_drvdata(rdev);\r\nint bit = ramp_delay/6000;\r\nint ret;\r\nif (bit)\r\nbit--;\r\nret = regmap_write(tps->regmap, TPS51632_SLEW_REGS, BIT(bit));\r\nif (ret < 0)\r\ndev_err(tps->dev, "SLEW reg write failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic int tps51632_init_dcdc(struct tps51632_chip *tps,\r\nstruct tps51632_regulator_platform_data *pdata)\r\n{\r\nint ret;\r\nuint8_t control = 0;\r\nint vsel;\r\nif (!pdata->enable_pwm_dvfs)\r\ngoto skip_pwm_config;\r\ncontrol |= TPS51632_DVFS_PWMEN;\r\nvsel = TPS51632_VOLT_VSEL(pdata->base_voltage_uV);\r\nret = regmap_write(tps->regmap, TPS51632_VOLTAGE_BASE_REG, vsel);\r\nif (ret < 0) {\r\ndev_err(tps->dev, "BASE reg write failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nif (pdata->dvfs_step_20mV)\r\ncontrol |= TPS51632_DVFS_STEP_20;\r\nif (pdata->max_voltage_uV) {\r\nunsigned int vmax;\r\nret = regmap_read(tps->regmap, TPS51632_VMAX_REG, &vmax);\r\nif (ret < 0) {\r\ndev_err(tps->dev, "VMAX read failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nif (!(vmax & TPS51632_VMAX_LOCK)) {\r\nvsel = TPS51632_VOLT_VSEL(pdata->max_voltage_uV);\r\nret = regmap_write(tps->regmap, TPS51632_VMAX_REG,\r\nvsel);\r\nif (ret < 0) {\r\ndev_err(tps->dev,\r\n"VMAX write failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\n}\r\n}\r\nskip_pwm_config:\r\nret = regmap_write(tps->regmap, TPS51632_DVFS_CONTROL_REG, control);\r\nif (ret < 0)\r\ndev_err(tps->dev, "DVFS reg write failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic bool is_volatile_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TPS51632_OFFSET_REG:\r\ncase TPS51632_FAULT_REG:\r\ncase TPS51632_IMON_REG:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic bool is_read_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase 0x08 ... 0x0F:\r\nreturn false;\r\ndefault:\r\nreturn true;\r\n}\r\n}\r\nstatic bool is_write_reg(struct device *dev, unsigned int reg)\r\n{\r\nswitch (reg) {\r\ncase TPS51632_VOLTAGE_SELECT_REG:\r\ncase TPS51632_VOLTAGE_BASE_REG:\r\ncase TPS51632_VMAX_REG:\r\ncase TPS51632_DVFS_CONTROL_REG:\r\ncase TPS51632_POWER_STATE_REG:\r\ncase TPS51632_SLEW_REGS:\r\nreturn true;\r\ndefault:\r\nreturn false;\r\n}\r\n}\r\nstatic struct tps51632_regulator_platform_data *\r\nof_get_tps51632_platform_data(struct device *dev)\r\n{\r\nstruct tps51632_regulator_platform_data *pdata;\r\nstruct device_node *np = dev->of_node;\r\npdata = devm_kzalloc(dev, sizeof(*pdata), GFP_KERNEL);\r\nif (!pdata)\r\nreturn NULL;\r\npdata->reg_init_data = of_get_regulator_init_data(dev, dev->of_node);\r\nif (!pdata->reg_init_data) {\r\ndev_err(dev, "Not able to get OF regulator init data\n");\r\nreturn NULL;\r\n}\r\npdata->enable_pwm_dvfs =\r\nof_property_read_bool(np, "ti,enable-pwm-dvfs");\r\npdata->dvfs_step_20mV = of_property_read_bool(np, "ti,dvfs-step-20mV");\r\npdata->base_voltage_uV = pdata->reg_init_data->constraints.min_uV ? :\r\nTPS51632_MIN_VOLTAGE;\r\npdata->max_voltage_uV = pdata->reg_init_data->constraints.max_uV ? :\r\nTPS51632_MAX_VOLTAGE;\r\nreturn pdata;\r\n}\r\nstatic struct tps51632_regulator_platform_data *\r\nof_get_tps51632_platform_data(struct device *dev)\r\n{\r\nreturn NULL;\r\n}\r\nstatic int tps51632_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct tps51632_regulator_platform_data *pdata;\r\nstruct regulator_dev *rdev;\r\nstruct tps51632_chip *tps;\r\nint ret;\r\nstruct regulator_config config = { };\r\nif (client->dev.of_node) {\r\nconst struct of_device_id *match;\r\nmatch = of_match_device(of_match_ptr(tps51632_of_match),\r\n&client->dev);\r\nif (!match) {\r\ndev_err(&client->dev, "Error: No device match found\n");\r\nreturn -ENODEV;\r\n}\r\n}\r\npdata = dev_get_platdata(&client->dev);\r\nif (!pdata && client->dev.of_node)\r\npdata = of_get_tps51632_platform_data(&client->dev);\r\nif (!pdata) {\r\ndev_err(&client->dev, "No Platform data\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->enable_pwm_dvfs) {\r\nif ((pdata->base_voltage_uV < TPS51632_MIN_VOLTAGE) ||\r\n(pdata->base_voltage_uV > TPS51632_MAX_VOLTAGE)) {\r\ndev_err(&client->dev, "Invalid base_voltage_uV setting\n");\r\nreturn -EINVAL;\r\n}\r\nif ((pdata->max_voltage_uV) &&\r\n((pdata->max_voltage_uV < TPS51632_MIN_VOLTAGE) ||\r\n(pdata->max_voltage_uV > TPS51632_MAX_VOLTAGE))) {\r\ndev_err(&client->dev, "Invalid max_voltage_uV setting\n");\r\nreturn -EINVAL;\r\n}\r\n}\r\ntps = devm_kzalloc(&client->dev, sizeof(*tps), GFP_KERNEL);\r\nif (!tps)\r\nreturn -ENOMEM;\r\ntps->dev = &client->dev;\r\ntps->desc.name = client->name;\r\ntps->desc.id = 0;\r\ntps->desc.ramp_delay = TPS51632_DEFAULT_RAMP_DELAY;\r\ntps->desc.min_uV = TPS51632_MIN_VOLTAGE;\r\ntps->desc.uV_step = TPS51632_VOLTAGE_STEP_10mV;\r\ntps->desc.linear_min_sel = TPS51632_MIN_VSEL;\r\ntps->desc.n_voltages = TPS51632_MAX_VSEL + 1;\r\ntps->desc.ops = &tps51632_dcdc_ops;\r\ntps->desc.type = REGULATOR_VOLTAGE;\r\ntps->desc.owner = THIS_MODULE;\r\nif (pdata->enable_pwm_dvfs)\r\ntps->desc.vsel_reg = TPS51632_VOLTAGE_BASE_REG;\r\nelse\r\ntps->desc.vsel_reg = TPS51632_VOLTAGE_SELECT_REG;\r\ntps->desc.vsel_mask = TPS51632_VOUT_MASK;\r\ntps->regmap = devm_regmap_init_i2c(client, &tps51632_regmap_config);\r\nif (IS_ERR(tps->regmap)) {\r\nret = PTR_ERR(tps->regmap);\r\ndev_err(&client->dev, "regmap init failed, err %d\n", ret);\r\nreturn ret;\r\n}\r\ni2c_set_clientdata(client, tps);\r\nret = tps51632_init_dcdc(tps, pdata);\r\nif (ret < 0) {\r\ndev_err(tps->dev, "Init failed, err = %d\n", ret);\r\nreturn ret;\r\n}\r\nconfig.dev = &client->dev;\r\nconfig.init_data = pdata->reg_init_data;\r\nconfig.driver_data = tps;\r\nconfig.regmap = tps->regmap;\r\nconfig.of_node = client->dev.of_node;\r\nrdev = devm_regulator_register(&client->dev, &tps->desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(tps->dev, "regulator register failed\n");\r\nreturn PTR_ERR(rdev);\r\n}\r\ntps->rdev = rdev;\r\nreturn 0;\r\n}\r\nstatic int __init tps51632_init(void)\r\n{\r\nreturn i2c_add_driver(&tps51632_i2c_driver);\r\n}\r\nstatic void __exit tps51632_cleanup(void)\r\n{\r\ni2c_del_driver(&tps51632_i2c_driver);\r\n}

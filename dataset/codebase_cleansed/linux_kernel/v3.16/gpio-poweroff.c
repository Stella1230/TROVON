static void gpio_poweroff_do_poweroff(void)\r\n{\r\nBUG_ON(!gpio_is_valid(gpio_num));\r\ngpio_direction_output(gpio_num, !gpio_active_low);\r\nmdelay(100);\r\ngpio_set_value(gpio_num, gpio_active_low);\r\nmdelay(100);\r\ngpio_set_value(gpio_num, !gpio_active_low);\r\nmdelay(3000);\r\nWARN_ON(1);\r\n}\r\nstatic int gpio_poweroff_probe(struct platform_device *pdev)\r\n{\r\nenum of_gpio_flags flags;\r\nbool input = false;\r\nint ret;\r\nif (pm_power_off != NULL) {\r\npr_err("%s: pm_power_off function already registered",\r\n__func__);\r\nreturn -EBUSY;\r\n}\r\ngpio_num = of_get_gpio_flags(pdev->dev.of_node, 0, &flags);\r\nif (!gpio_is_valid(gpio_num))\r\nreturn gpio_num;\r\ngpio_active_low = flags & OF_GPIO_ACTIVE_LOW;\r\ninput = of_property_read_bool(pdev->dev.of_node, "input");\r\nret = gpio_request(gpio_num, "poweroff-gpio");\r\nif (ret) {\r\npr_err("%s: Could not get GPIO %d", __func__, gpio_num);\r\nreturn ret;\r\n}\r\nif (input) {\r\nif (gpio_direction_input(gpio_num)) {\r\npr_err("Could not set direction of GPIO %d to input",\r\ngpio_num);\r\ngoto err;\r\n}\r\n} else {\r\nif (gpio_direction_output(gpio_num, gpio_active_low)) {\r\npr_err("Could not set direction of GPIO %d", gpio_num);\r\ngoto err;\r\n}\r\n}\r\npm_power_off = &gpio_poweroff_do_poweroff;\r\nreturn 0;\r\nerr:\r\ngpio_free(gpio_num);\r\nreturn -ENODEV;\r\n}\r\nstatic int gpio_poweroff_remove(struct platform_device *pdev)\r\n{\r\ngpio_free(gpio_num);\r\nif (pm_power_off == &gpio_poweroff_do_poweroff)\r\npm_power_off = NULL;\r\nreturn 0;\r\n}

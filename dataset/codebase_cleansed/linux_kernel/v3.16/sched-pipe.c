static void *worker_thread(void *__tdata)\r\n{\r\nstruct thread_data *td = __tdata;\r\nint m = 0, i;\r\nint ret;\r\nfor (i = 0; i < loops; i++) {\r\nif (!td->nr) {\r\nret = read(td->pipe_read, &m, sizeof(int));\r\nBUG_ON(ret != sizeof(int));\r\nret = write(td->pipe_write, &m, sizeof(int));\r\nBUG_ON(ret != sizeof(int));\r\n} else {\r\nret = write(td->pipe_write, &m, sizeof(int));\r\nBUG_ON(ret != sizeof(int));\r\nret = read(td->pipe_read, &m, sizeof(int));\r\nBUG_ON(ret != sizeof(int));\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nint bench_sched_pipe(int argc, const char **argv, const char *prefix __maybe_unused)\r\n{\r\nstruct thread_data threads[2], *td;\r\nint pipe_1[2], pipe_2[2];\r\nstruct timeval start, stop, diff;\r\nunsigned long long result_usec = 0;\r\nint nr_threads = 2;\r\nint t;\r\nint __maybe_unused ret, wait_stat;\r\npid_t pid, retpid __maybe_unused;\r\nargc = parse_options(argc, argv, options, bench_sched_pipe_usage, 0);\r\nBUG_ON(pipe(pipe_1));\r\nBUG_ON(pipe(pipe_2));\r\ngettimeofday(&start, NULL);\r\nfor (t = 0; t < nr_threads; t++) {\r\ntd = threads + t;\r\ntd->nr = t;\r\nif (t == 0) {\r\ntd->pipe_read = pipe_1[0];\r\ntd->pipe_write = pipe_2[1];\r\n} else {\r\ntd->pipe_write = pipe_1[1];\r\ntd->pipe_read = pipe_2[0];\r\n}\r\n}\r\nif (threaded) {\r\nfor (t = 0; t < nr_threads; t++) {\r\ntd = threads + t;\r\nret = pthread_create(&td->pthread, NULL, worker_thread, td);\r\nBUG_ON(ret);\r\n}\r\nfor (t = 0; t < nr_threads; t++) {\r\ntd = threads + t;\r\nret = pthread_join(td->pthread, NULL);\r\nBUG_ON(ret);\r\n}\r\n} else {\r\npid = fork();\r\nassert(pid >= 0);\r\nif (!pid) {\r\nworker_thread(threads + 0);\r\nexit(0);\r\n} else {\r\nworker_thread(threads + 1);\r\n}\r\nretpid = waitpid(pid, &wait_stat, 0);\r\nassert((retpid == pid) && WIFEXITED(wait_stat));\r\n}\r\ngettimeofday(&stop, NULL);\r\ntimersub(&stop, &start, &diff);\r\nswitch (bench_format) {\r\ncase BENCH_FORMAT_DEFAULT:\r\nprintf("# Executed %d pipe operations between two %s\n\n",\r\nloops, threaded ? "threads" : "processes");\r\nresult_usec = diff.tv_sec * 1000000;\r\nresult_usec += diff.tv_usec;\r\nprintf(" %14s: %lu.%03lu [sec]\n\n", "Total time",\r\ndiff.tv_sec,\r\n(unsigned long) (diff.tv_usec/1000));\r\nprintf(" %14lf usecs/op\n",\r\n(double)result_usec / (double)loops);\r\nprintf(" %14d ops/sec\n",\r\n(int)((double)loops /\r\n((double)result_usec / (double)1000000)));\r\nbreak;\r\ncase BENCH_FORMAT_SIMPLE:\r\nprintf("%lu.%03lu\n",\r\ndiff.tv_sec,\r\n(unsigned long) (diff.tv_usec / 1000));\r\nbreak;\r\ndefault:\r\nfprintf(stderr, "Unknown format:%d\n", bench_format);\r\nexit(1);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

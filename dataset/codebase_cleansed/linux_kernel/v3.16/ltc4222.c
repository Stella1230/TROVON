static int ltc4222_get_value(struct device *dev, u8 reg)\r\n{\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nunsigned int val;\r\nu8 buf[2];\r\nint ret;\r\nret = regmap_bulk_read(regmap, reg, buf, 2);\r\nif (ret < 0)\r\nreturn ret;\r\nval = ((buf[0] << 8) + buf[1]) >> 6;\r\nswitch (reg) {\r\ncase LTC4222_ADIN1:\r\ncase LTC4222_ADIN2:\r\nval = DIV_ROUND_CLOSEST(val * 5, 4);\r\nbreak;\r\ncase LTC4222_SOURCE1:\r\ncase LTC4222_SOURCE2:\r\nval = DIV_ROUND_CLOSEST(val * 125, 4);\r\nbreak;\r\ncase LTC4222_SENSE1:\r\ncase LTC4222_SENSE2:\r\nval = DIV_ROUND_CLOSEST(val * 125, 2);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn val;\r\n}\r\nstatic ssize_t ltc4222_show_value(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nint value;\r\nvalue = ltc4222_get_value(dev, attr->index);\r\nif (value < 0)\r\nreturn value;\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", value);\r\n}\r\nstatic ssize_t ltc4222_show_bool(struct device *dev,\r\nstruct device_attribute *da, char *buf)\r\n{\r\nstruct sensor_device_attribute_2 *attr = to_sensor_dev_attr_2(da);\r\nstruct regmap *regmap = dev_get_drvdata(dev);\r\nunsigned int fault;\r\nint ret;\r\nret = regmap_read(regmap, attr->nr, &fault);\r\nif (ret < 0)\r\nreturn ret;\r\nfault &= attr->index;\r\nif (fault)\r\nregmap_update_bits(regmap, attr->nr, attr->index, 0);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n", !!fault);\r\n}\r\nstatic int ltc4222_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct device *hwmon_dev;\r\nstruct regmap *regmap;\r\nregmap = devm_regmap_init_i2c(client, &ltc4222_regmap_config);\r\nif (IS_ERR(regmap)) {\r\ndev_err(dev, "failed to allocate register map\n");\r\nreturn PTR_ERR(regmap);\r\n}\r\nregmap_write(regmap, LTC4222_FAULT1, 0x00);\r\nregmap_write(regmap, LTC4222_FAULT2, 0x00);\r\nhwmon_dev = devm_hwmon_device_register_with_groups(dev, client->name,\r\nregmap,\r\nltc4222_groups);\r\nreturn PTR_ERR_OR_ZERO(hwmon_dev);\r\n}

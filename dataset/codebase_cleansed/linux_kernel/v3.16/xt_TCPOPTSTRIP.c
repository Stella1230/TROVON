static inline unsigned int optlen(const u_int8_t *opt, unsigned int offset)\r\n{\r\nif (opt[offset] <= TCPOPT_NOP || opt[offset+1] == 0)\r\nreturn 1;\r\nelse\r\nreturn opt[offset+1];\r\n}\r\nstatic unsigned int\r\ntcpoptstrip_mangle_packet(struct sk_buff *skb,\r\nconst struct xt_action_param *par,\r\nunsigned int tcphoff, unsigned int minlen)\r\n{\r\nconst struct xt_tcpoptstrip_target_info *info = par->targinfo;\r\nunsigned int optl, i, j;\r\nstruct tcphdr *tcph;\r\nu_int16_t n, o;\r\nu_int8_t *opt;\r\nint len, tcp_hdrlen;\r\nif (par->fragoff != 0)\r\nreturn XT_CONTINUE;\r\nif (!skb_make_writable(skb, skb->len))\r\nreturn NF_DROP;\r\nlen = skb->len - tcphoff;\r\nif (len < (int)sizeof(struct tcphdr))\r\nreturn NF_DROP;\r\ntcph = (struct tcphdr *)(skb_network_header(skb) + tcphoff);\r\ntcp_hdrlen = tcph->doff * 4;\r\nif (len < tcp_hdrlen)\r\nreturn NF_DROP;\r\nopt = (u_int8_t *)tcph;\r\nfor (i = sizeof(struct tcphdr); i < tcp_hdrlen - 1; i += optl) {\r\noptl = optlen(opt, i);\r\nif (i + optl > tcp_hdrlen)\r\nbreak;\r\nif (!tcpoptstrip_test_bit(info->strip_bmap, opt[i]))\r\ncontinue;\r\nfor (j = 0; j < optl; ++j) {\r\no = opt[i+j];\r\nn = TCPOPT_NOP;\r\nif ((i + j) % 2 == 0) {\r\no <<= 8;\r\nn <<= 8;\r\n}\r\ninet_proto_csum_replace2(&tcph->check, skb, htons(o),\r\nhtons(n), 0);\r\n}\r\nmemset(opt + i, TCPOPT_NOP, optl);\r\n}\r\nreturn XT_CONTINUE;\r\n}\r\nstatic unsigned int\r\ntcpoptstrip_tg4(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nreturn tcpoptstrip_mangle_packet(skb, par, ip_hdrlen(skb),\r\nsizeof(struct iphdr) + sizeof(struct tcphdr));\r\n}\r\nstatic unsigned int\r\ntcpoptstrip_tg6(struct sk_buff *skb, const struct xt_action_param *par)\r\n{\r\nstruct ipv6hdr *ipv6h = ipv6_hdr(skb);\r\nint tcphoff;\r\nu_int8_t nexthdr;\r\n__be16 frag_off;\r\nnexthdr = ipv6h->nexthdr;\r\ntcphoff = ipv6_skip_exthdr(skb, sizeof(*ipv6h), &nexthdr, &frag_off);\r\nif (tcphoff < 0)\r\nreturn NF_DROP;\r\nreturn tcpoptstrip_mangle_packet(skb, par, tcphoff,\r\nsizeof(*ipv6h) + sizeof(struct tcphdr));\r\n}\r\nstatic int __init tcpoptstrip_tg_init(void)\r\n{\r\nreturn xt_register_targets(tcpoptstrip_tg_reg,\r\nARRAY_SIZE(tcpoptstrip_tg_reg));\r\n}\r\nstatic void __exit tcpoptstrip_tg_exit(void)\r\n{\r\nxt_unregister_targets(tcpoptstrip_tg_reg,\r\nARRAY_SIZE(tcpoptstrip_tg_reg));\r\n}

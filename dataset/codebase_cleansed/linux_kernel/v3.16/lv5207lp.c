static int lv5207lp_write(struct lv5207lp *lv, u8 reg, u8 data)\r\n{\r\nreturn i2c_smbus_write_byte_data(lv->client, reg, data);\r\n}\r\nstatic int lv5207lp_backlight_update_status(struct backlight_device *backlight)\r\n{\r\nstruct lv5207lp *lv = bl_get_data(backlight);\r\nint brightness = backlight->props.brightness;\r\nif (backlight->props.power != FB_BLANK_UNBLANK ||\r\nbacklight->props.fb_blank != FB_BLANK_UNBLANK ||\r\nbacklight->props.state & (BL_CORE_SUSPENDED | BL_CORE_FBBLANK))\r\nbrightness = 0;\r\nif (brightness) {\r\nlv5207lp_write(lv, LV5207LP_CTRL1,\r\nLV5207LP_CPSW | LV5207LP_C10 | LV5207LP_CKSW);\r\nlv5207lp_write(lv, LV5207LP_CTRL2,\r\nLV5207LP_MSW | LV5207LP_MLED4 |\r\n(brightness - 1));\r\n} else {\r\nlv5207lp_write(lv, LV5207LP_CTRL1, 0);\r\nlv5207lp_write(lv, LV5207LP_CTRL2, 0);\r\n}\r\nreturn 0;\r\n}\r\nstatic int lv5207lp_backlight_get_brightness(struct backlight_device *backlight)\r\n{\r\nreturn backlight->props.brightness;\r\n}\r\nstatic int lv5207lp_backlight_check_fb(struct backlight_device *backlight,\r\nstruct fb_info *info)\r\n{\r\nstruct lv5207lp *lv = bl_get_data(backlight);\r\nreturn lv->pdata->fbdev == NULL || lv->pdata->fbdev == info->dev;\r\n}\r\nstatic int lv5207lp_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct lv5207lp_platform_data *pdata = dev_get_platdata(&client->dev);\r\nstruct backlight_device *backlight;\r\nstruct backlight_properties props;\r\nstruct lv5207lp *lv;\r\nif (pdata == NULL) {\r\ndev_err(&client->dev, "No platform data supplied\n");\r\nreturn -EINVAL;\r\n}\r\nif (!i2c_check_functionality(client->adapter,\r\nI2C_FUNC_SMBUS_BYTE_DATA)) {\r\ndev_warn(&client->dev,\r\n"I2C adapter doesn't support I2C_FUNC_SMBUS_BYTE\n");\r\nreturn -EIO;\r\n}\r\nlv = devm_kzalloc(&client->dev, sizeof(*lv), GFP_KERNEL);\r\nif (!lv)\r\nreturn -ENOMEM;\r\nlv->client = client;\r\nlv->pdata = pdata;\r\nmemset(&props, 0, sizeof(props));\r\nprops.type = BACKLIGHT_RAW;\r\nprops.max_brightness = min_t(unsigned int, pdata->max_value,\r\nLV5207LP_MAX_BRIGHTNESS);\r\nprops.brightness = clamp_t(unsigned int, pdata->def_value, 0,\r\nprops.max_brightness);\r\nbacklight = devm_backlight_device_register(&client->dev,\r\ndev_name(&client->dev), &lv->client->dev,\r\nlv, &lv5207lp_backlight_ops, &props);\r\nif (IS_ERR(backlight)) {\r\ndev_err(&client->dev, "failed to register backlight\n");\r\nreturn PTR_ERR(backlight);\r\n}\r\nbacklight_update_status(backlight);\r\ni2c_set_clientdata(client, backlight);\r\nreturn 0;\r\n}\r\nstatic int lv5207lp_remove(struct i2c_client *client)\r\n{\r\nstruct backlight_device *backlight = i2c_get_clientdata(client);\r\nbacklight->props.brightness = 0;\r\nbacklight_update_status(backlight);\r\nreturn 0;\r\n}

static void mic_reset(struct mic_device *mdev)\r\n{\r\nint i;\r\n#define MIC_RESET_TO (45)\r\nreinit_completion(&mdev->reset_wait);\r\nmdev->ops->reset_fw_ready(mdev);\r\nmdev->ops->reset(mdev);\r\nfor (i = 0; i < MIC_RESET_TO; i++) {\r\nif (mdev->ops->is_fw_ready(mdev))\r\ngoto done;\r\nmsleep(1000);\r\n}\r\nmic_set_state(mdev, MIC_RESET_FAILED);\r\ndone:\r\ncomplete_all(&mdev->reset_wait);\r\n}\r\nvoid mic_bootparam_init(struct mic_device *mdev)\r\n{\r\nstruct mic_bootparam *bootparam = mdev->dp;\r\nbootparam->magic = cpu_to_le32(MIC_MAGIC);\r\nbootparam->c2h_shutdown_db = mdev->shutdown_db;\r\nbootparam->h2c_shutdown_db = -1;\r\nbootparam->h2c_config_db = -1;\r\nbootparam->shutdown_status = 0;\r\nbootparam->shutdown_card = 0;\r\n}\r\nint mic_start(struct mic_device *mdev, const char *buf)\r\n{\r\nint rc;\r\nmutex_lock(&mdev->mic_mutex);\r\nretry:\r\nif (MIC_OFFLINE != mdev->state) {\r\nrc = -EINVAL;\r\ngoto unlock_ret;\r\n}\r\nif (!mdev->ops->is_fw_ready(mdev)) {\r\nmic_reset(mdev);\r\ngoto retry;\r\n}\r\nrc = mdev->ops->load_mic_fw(mdev, buf);\r\nif (rc)\r\ngoto unlock_ret;\r\nmic_smpt_restore(mdev);\r\nmic_intr_restore(mdev);\r\nmdev->intr_ops->enable_interrupts(mdev);\r\nmdev->ops->write_spad(mdev, MIC_DPLO_SPAD, mdev->dp_dma_addr);\r\nmdev->ops->write_spad(mdev, MIC_DPHI_SPAD, mdev->dp_dma_addr >> 32);\r\nmdev->ops->send_firmware_intr(mdev);\r\nmic_set_state(mdev, MIC_ONLINE);\r\nunlock_ret:\r\nmutex_unlock(&mdev->mic_mutex);\r\nreturn rc;\r\n}\r\nvoid mic_stop(struct mic_device *mdev, bool force)\r\n{\r\nmutex_lock(&mdev->mic_mutex);\r\nif (MIC_OFFLINE != mdev->state || force) {\r\nmic_virtio_reset_devices(mdev);\r\nmic_bootparam_init(mdev);\r\nmic_reset(mdev);\r\nif (MIC_RESET_FAILED == mdev->state)\r\ngoto unlock;\r\nmic_set_shutdown_status(mdev, MIC_NOP);\r\nif (MIC_SUSPENDED != mdev->state)\r\nmic_set_state(mdev, MIC_OFFLINE);\r\n}\r\nunlock:\r\nmutex_unlock(&mdev->mic_mutex);\r\n}\r\nvoid mic_shutdown(struct mic_device *mdev)\r\n{\r\nstruct mic_bootparam *bootparam = mdev->dp;\r\ns8 db = bootparam->h2c_shutdown_db;\r\nmutex_lock(&mdev->mic_mutex);\r\nif (MIC_ONLINE == mdev->state && db != -1) {\r\nbootparam->shutdown_card = 1;\r\nmdev->ops->send_intr(mdev, db);\r\nmic_set_state(mdev, MIC_SHUTTING_DOWN);\r\n}\r\nmutex_unlock(&mdev->mic_mutex);\r\n}\r\nvoid mic_shutdown_work(struct work_struct *work)\r\n{\r\nstruct mic_device *mdev = container_of(work, struct mic_device,\r\nshutdown_work);\r\nstruct mic_bootparam *bootparam = mdev->dp;\r\nmutex_lock(&mdev->mic_mutex);\r\nmic_set_shutdown_status(mdev, bootparam->shutdown_status);\r\nbootparam->shutdown_status = 0;\r\nif (MIC_SHUTTING_DOWN != mdev->state &&\r\nMIC_SUSPENDED != mdev->state)\r\nmic_set_state(mdev, MIC_SHUTTING_DOWN);\r\nmutex_unlock(&mdev->mic_mutex);\r\n}\r\nvoid mic_reset_trigger_work(struct work_struct *work)\r\n{\r\nstruct mic_device *mdev = container_of(work, struct mic_device,\r\nreset_trigger_work);\r\nmic_stop(mdev, false);\r\n}\r\nvoid mic_complete_resume(struct mic_device *mdev)\r\n{\r\nif (mdev->state != MIC_SUSPENDED) {\r\ndev_warn(mdev->sdev->parent, "state %d should be %d\n",\r\nmdev->state, MIC_SUSPENDED);\r\nreturn;\r\n}\r\nif (!mdev->ops->is_fw_ready(mdev))\r\nmic_stop(mdev, true);\r\nmutex_lock(&mdev->mic_mutex);\r\nmic_set_state(mdev, MIC_OFFLINE);\r\nmutex_unlock(&mdev->mic_mutex);\r\n}\r\nvoid mic_prepare_suspend(struct mic_device *mdev)\r\n{\r\nint rc;\r\n#define MIC_SUSPEND_TIMEOUT (60 * HZ)\r\nmutex_lock(&mdev->mic_mutex);\r\nswitch (mdev->state) {\r\ncase MIC_OFFLINE:\r\nmic_set_state(mdev, MIC_SUSPENDED);\r\nmutex_unlock(&mdev->mic_mutex);\r\nbreak;\r\ncase MIC_ONLINE:\r\nmic_set_state(mdev, MIC_SUSPENDING);\r\nmutex_unlock(&mdev->mic_mutex);\r\nrc = wait_for_completion_timeout(&mdev->reset_wait,\r\nMIC_SUSPEND_TIMEOUT);\r\nif (!rc) {\r\nmutex_lock(&mdev->mic_mutex);\r\nmic_set_state(mdev, MIC_SUSPENDED);\r\nmutex_unlock(&mdev->mic_mutex);\r\nmic_stop(mdev, true);\r\n}\r\nbreak;\r\ncase MIC_SHUTTING_DOWN:\r\nmic_set_state(mdev, MIC_SUSPENDED);\r\nmutex_unlock(&mdev->mic_mutex);\r\nrc = wait_for_completion_timeout(&mdev->reset_wait,\r\nMIC_SUSPEND_TIMEOUT);\r\nif (!rc)\r\nmic_stop(mdev, true);\r\nbreak;\r\ndefault:\r\nmutex_unlock(&mdev->mic_mutex);\r\nbreak;\r\n}\r\n}\r\nvoid mic_suspend(struct mic_device *mdev)\r\n{\r\nstruct mic_bootparam *bootparam = mdev->dp;\r\ns8 db = bootparam->h2c_shutdown_db;\r\nmutex_lock(&mdev->mic_mutex);\r\nif (MIC_SUSPENDING == mdev->state && db != -1) {\r\nbootparam->shutdown_card = 1;\r\nmdev->ops->send_intr(mdev, db);\r\nmic_set_state(mdev, MIC_SUSPENDED);\r\n}\r\nmutex_unlock(&mdev->mic_mutex);\r\n}

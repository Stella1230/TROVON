static unsigned int obfuscate_tx_buffer(const __u8 * buf_cleartext,\r\nunsigned int len_cleartext,\r\n__u8 * buf_xoredtext,\r\nunsigned int len_maxbuf)\r\n{\r\nunsigned int len_xoredtext;\r\nlen_xoredtext = ((len_cleartext + 7) & ~0x7) + 0x10;\r\nif (len_xoredtext <= len_maxbuf) {\r\nstatic const __u8 lookup_string[] = "wangshuofei19710";\r\n__u8 xor_mask;\r\nmemset(buf_xoredtext, 0, len_xoredtext);\r\nxor_mask = lookup_string[(len_cleartext & 0x0f) ^ 0x06] ^ 0x55;\r\nwhile (len_cleartext-- > 0) {\r\n*buf_xoredtext++ = *buf_cleartext++ ^ xor_mask;\r\n}\r\n} else {\r\nlen_xoredtext = 0;\r\n}\r\nreturn len_xoredtext;\r\n}\r\nstatic void ks959_speed_irq(struct urb *urb)\r\n{\r\nif (urb->status != 0) {\r\ndev_err(&urb->dev->dev,\r\n"ks959_speed_irq: urb asynchronously failed - %d\n",\r\nurb->status);\r\n}\r\n}\r\nstatic int ks959_change_speed(struct ks959_cb *kingsun, unsigned speed)\r\n{\r\nstatic unsigned int supported_speeds[] = { 2400, 9600, 19200, 38400,\r\n57600, 115200, 576000, 1152000, 4000000, 0\r\n};\r\nint err;\r\nunsigned int i;\r\nif (kingsun->speed_setuprequest == NULL || kingsun->speed_urb == NULL)\r\nreturn -ENOMEM;\r\nfor (i = 0; supported_speeds[i] && supported_speeds[i] != speed; i++) ;\r\nif (supported_speeds[i] == 0)\r\nreturn -EOPNOTSUPP;\r\nmemset(&(kingsun->speedparams), 0, sizeof(struct ks959_speedparams));\r\nkingsun->speedparams.baudrate = cpu_to_le32(speed);\r\nkingsun->speedparams.flags = KS_DATA_8_BITS;\r\nusb_fill_control_urb(kingsun->speed_urb, kingsun->usbdev,\r\nusb_sndctrlpipe(kingsun->usbdev, 0),\r\n(unsigned char *)kingsun->speed_setuprequest,\r\n&(kingsun->speedparams),\r\nsizeof(struct ks959_speedparams), ks959_speed_irq,\r\nkingsun);\r\nkingsun->speed_urb->status = 0;\r\nerr = usb_submit_urb(kingsun->speed_urb, GFP_ATOMIC);\r\nreturn err;\r\n}\r\nstatic int ks959_submit_tx_fragment(struct ks959_cb *kingsun)\r\n{\r\nunsigned int padlen;\r\nunsigned int wraplen;\r\nint ret;\r\nwraplen = (KINGSUN_SND_PACKET_SIZE & ~0x7) - 0x10;\r\nif (wraplen > kingsun->tx_buf_clear_used)\r\nwraplen = kingsun->tx_buf_clear_used;\r\npadlen = obfuscate_tx_buffer(kingsun->tx_buf_clear, wraplen,\r\nkingsun->tx_buf_xored,\r\nKINGSUN_SND_PACKET_SIZE);\r\nkingsun->tx_setuprequest->wValue = cpu_to_le16(wraplen);\r\nkingsun->tx_setuprequest->wLength = cpu_to_le16(padlen);\r\nusb_fill_control_urb(kingsun->tx_urb, kingsun->usbdev,\r\nusb_sndctrlpipe(kingsun->usbdev, 0),\r\n(unsigned char *)kingsun->tx_setuprequest,\r\nkingsun->tx_buf_xored, padlen,\r\nks959_send_irq, kingsun);\r\nkingsun->tx_urb->status = 0;\r\nret = usb_submit_urb(kingsun->tx_urb, GFP_ATOMIC);\r\nkingsun->tx_buf_clear_sent = (ret == 0) ? wraplen : 0;\r\nreturn ret;\r\n}\r\nstatic void ks959_send_irq(struct urb *urb)\r\n{\r\nstruct ks959_cb *kingsun = urb->context;\r\nstruct net_device *netdev = kingsun->netdev;\r\nint ret = 0;\r\nif (!netif_running(kingsun->netdev)) {\r\ndev_err(&kingsun->usbdev->dev,\r\n"ks959_send_irq: Network not running!\n");\r\nreturn;\r\n}\r\nif (urb->status != 0) {\r\ndev_err(&kingsun->usbdev->dev,\r\n"ks959_send_irq: urb asynchronously failed - %d\n",\r\nurb->status);\r\nreturn;\r\n}\r\nif (kingsun->tx_buf_clear_used > 0) {\r\nif (kingsun->tx_buf_clear_sent < kingsun->tx_buf_clear_used) {\r\nmemmove(kingsun->tx_buf_clear,\r\nkingsun->tx_buf_clear +\r\nkingsun->tx_buf_clear_sent,\r\nkingsun->tx_buf_clear_used -\r\nkingsun->tx_buf_clear_sent);\r\n}\r\nkingsun->tx_buf_clear_used -= kingsun->tx_buf_clear_sent;\r\nkingsun->tx_buf_clear_sent = 0;\r\nif (kingsun->tx_buf_clear_used > 0) {\r\nif ((ret = ks959_submit_tx_fragment(kingsun)) != 0) {\r\ndev_err(&kingsun->usbdev->dev,\r\n"ks959_send_irq: failed tx_urb submit: %d\n",\r\nret);\r\nswitch (ret) {\r\ncase -ENODEV:\r\ncase -EPIPE:\r\nbreak;\r\ndefault:\r\nnetdev->stats.tx_errors++;\r\nnetif_start_queue(netdev);\r\n}\r\n}\r\n} else {\r\nif (kingsun->new_speed != -1 &&\r\ncpu_to_le32(kingsun->new_speed) !=\r\nkingsun->speedparams.baudrate)\r\nks959_change_speed(kingsun, kingsun->new_speed);\r\nnetif_wake_queue(netdev);\r\n}\r\n}\r\n}\r\nstatic netdev_tx_t ks959_hard_xmit(struct sk_buff *skb,\r\nstruct net_device *netdev)\r\n{\r\nstruct ks959_cb *kingsun;\r\nunsigned int wraplen;\r\nint ret = 0;\r\nnetif_stop_queue(netdev);\r\nSKB_LINEAR_ASSERT(skb);\r\nkingsun = netdev_priv(netdev);\r\nspin_lock(&kingsun->lock);\r\nkingsun->new_speed = irda_get_next_speed(skb);\r\nwraplen =\r\nasync_wrap_skb(skb, kingsun->tx_buf_clear, KINGSUN_SND_FIFO_SIZE);\r\nkingsun->tx_buf_clear_used = wraplen;\r\nif ((ret = ks959_submit_tx_fragment(kingsun)) != 0) {\r\ndev_err(&kingsun->usbdev->dev,\r\n"ks959_hard_xmit: failed tx_urb submit: %d\n", ret);\r\nswitch (ret) {\r\ncase -ENODEV:\r\ncase -EPIPE:\r\nbreak;\r\ndefault:\r\nnetdev->stats.tx_errors++;\r\nnetif_start_queue(netdev);\r\n}\r\n} else {\r\nnetdev->stats.tx_packets++;\r\nnetdev->stats.tx_bytes += skb->len;\r\n}\r\ndev_kfree_skb(skb);\r\nspin_unlock(&kingsun->lock);\r\nreturn NETDEV_TX_OK;\r\n}\r\nstatic void ks959_rcv_irq(struct urb *urb)\r\n{\r\nstruct ks959_cb *kingsun = urb->context;\r\nint ret;\r\nif (!netif_running(kingsun->netdev)) {\r\nkingsun->receiving = 0;\r\nreturn;\r\n}\r\nif (urb->status != 0) {\r\ndev_err(&kingsun->usbdev->dev,\r\n"kingsun_rcv_irq: urb asynchronously failed - %d\n",\r\nurb->status);\r\nkingsun->receiving = 0;\r\nreturn;\r\n}\r\nif (urb->actual_length > 0) {\r\n__u8 *bytes = urb->transfer_buffer;\r\nunsigned int i;\r\nfor (i = 0; i < urb->actual_length; i++) {\r\nkingsun->rx_variable_xormask++;\r\nbytes[i] =\r\nbytes[i] ^ kingsun->rx_variable_xormask ^ 0x55u;\r\nif (kingsun->rx_variable_xormask != 0) {\r\nasync_unwrap_char(kingsun->netdev,\r\n&kingsun->netdev->stats,\r\n&kingsun->rx_unwrap_buff,\r\nbytes[i]);\r\n}\r\n}\r\ndo_gettimeofday(&kingsun->rx_time);\r\nkingsun->receiving =\r\n(kingsun->rx_unwrap_buff.state != OUTSIDE_FRAME) ? 1 : 0;\r\n}\r\nurb->status = 0;\r\nret = usb_submit_urb(urb, GFP_ATOMIC);\r\n}\r\nstatic int ks959_net_open(struct net_device *netdev)\r\n{\r\nstruct ks959_cb *kingsun = netdev_priv(netdev);\r\nint err = -ENOMEM;\r\nchar hwname[16];\r\nkingsun->receiving = 0;\r\nkingsun->rx_unwrap_buff.in_frame = FALSE;\r\nkingsun->rx_unwrap_buff.state = OUTSIDE_FRAME;\r\nkingsun->rx_unwrap_buff.truesize = IRDA_SKB_MAX_MTU;\r\nkingsun->rx_unwrap_buff.skb = dev_alloc_skb(IRDA_SKB_MAX_MTU);\r\nif (!kingsun->rx_unwrap_buff.skb)\r\ngoto free_mem;\r\nskb_reserve(kingsun->rx_unwrap_buff.skb, 1);\r\nkingsun->rx_unwrap_buff.head = kingsun->rx_unwrap_buff.skb->data;\r\ndo_gettimeofday(&kingsun->rx_time);\r\nkingsun->rx_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!kingsun->rx_urb)\r\ngoto free_mem;\r\nkingsun->tx_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!kingsun->tx_urb)\r\ngoto free_mem;\r\nkingsun->speed_urb = usb_alloc_urb(0, GFP_KERNEL);\r\nif (!kingsun->speed_urb)\r\ngoto free_mem;\r\nkingsun->new_speed = 9600;\r\nerr = ks959_change_speed(kingsun, 9600);\r\nif (err < 0)\r\ngoto free_mem;\r\nsprintf(hwname, "usb#%d", kingsun->usbdev->devnum);\r\nkingsun->irlap = irlap_open(netdev, &kingsun->qos, hwname);\r\nif (!kingsun->irlap) {\r\nerr = -ENOMEM;\r\ndev_err(&kingsun->usbdev->dev, "irlap_open failed\n");\r\ngoto free_mem;\r\n}\r\nusb_fill_control_urb(kingsun->rx_urb, kingsun->usbdev,\r\nusb_rcvctrlpipe(kingsun->usbdev, 0),\r\n(unsigned char *)kingsun->rx_setuprequest,\r\nkingsun->rx_buf, KINGSUN_RCV_FIFO_SIZE,\r\nks959_rcv_irq, kingsun);\r\nkingsun->rx_urb->status = 0;\r\nerr = usb_submit_urb(kingsun->rx_urb, GFP_KERNEL);\r\nif (err) {\r\ndev_err(&kingsun->usbdev->dev,\r\n"first urb-submit failed: %d\n", err);\r\ngoto close_irlap;\r\n}\r\nnetif_start_queue(netdev);\r\nreturn 0;\r\nclose_irlap:\r\nirlap_close(kingsun->irlap);\r\nfree_mem:\r\nusb_free_urb(kingsun->speed_urb);\r\nkingsun->speed_urb = NULL;\r\nusb_free_urb(kingsun->tx_urb);\r\nkingsun->tx_urb = NULL;\r\nusb_free_urb(kingsun->rx_urb);\r\nkingsun->rx_urb = NULL;\r\nif (kingsun->rx_unwrap_buff.skb) {\r\nkfree_skb(kingsun->rx_unwrap_buff.skb);\r\nkingsun->rx_unwrap_buff.skb = NULL;\r\nkingsun->rx_unwrap_buff.head = NULL;\r\n}\r\nreturn err;\r\n}\r\nstatic int ks959_net_close(struct net_device *netdev)\r\n{\r\nstruct ks959_cb *kingsun = netdev_priv(netdev);\r\nnetif_stop_queue(netdev);\r\nusb_kill_urb(kingsun->tx_urb);\r\nusb_free_urb(kingsun->tx_urb);\r\nkingsun->tx_urb = NULL;\r\nusb_kill_urb(kingsun->speed_urb);\r\nusb_free_urb(kingsun->speed_urb);\r\nkingsun->speed_urb = NULL;\r\nusb_kill_urb(kingsun->rx_urb);\r\nusb_free_urb(kingsun->rx_urb);\r\nkingsun->rx_urb = NULL;\r\nkfree_skb(kingsun->rx_unwrap_buff.skb);\r\nkingsun->rx_unwrap_buff.skb = NULL;\r\nkingsun->rx_unwrap_buff.head = NULL;\r\nkingsun->rx_unwrap_buff.in_frame = FALSE;\r\nkingsun->rx_unwrap_buff.state = OUTSIDE_FRAME;\r\nkingsun->receiving = 0;\r\nif (kingsun->irlap)\r\nirlap_close(kingsun->irlap);\r\nkingsun->irlap = NULL;\r\nreturn 0;\r\n}\r\nstatic int ks959_net_ioctl(struct net_device *netdev, struct ifreq *rq, int cmd)\r\n{\r\nstruct if_irda_req *irq = (struct if_irda_req *)rq;\r\nstruct ks959_cb *kingsun = netdev_priv(netdev);\r\nint ret = 0;\r\nswitch (cmd) {\r\ncase SIOCSBANDWIDTH:\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (netif_device_present(kingsun->netdev))\r\nreturn ks959_change_speed(kingsun, irq->ifr_baudrate);\r\nbreak;\r\ncase SIOCSMEDIABUSY:\r\nif (!capable(CAP_NET_ADMIN))\r\nreturn -EPERM;\r\nif (netif_running(kingsun->netdev))\r\nirda_device_set_media_busy(kingsun->netdev, TRUE);\r\nbreak;\r\ncase SIOCGRECEIVING:\r\nirq->ifr_receiving = kingsun->receiving;\r\nbreak;\r\ndefault:\r\nret = -EOPNOTSUPP;\r\n}\r\nreturn ret;\r\n}\r\nstatic int ks959_probe(struct usb_interface *intf,\r\nconst struct usb_device_id *id)\r\n{\r\nstruct usb_device *dev = interface_to_usbdev(intf);\r\nstruct ks959_cb *kingsun = NULL;\r\nstruct net_device *net = NULL;\r\nint ret = -ENOMEM;\r\nnet = alloc_irdadev(sizeof(*kingsun));\r\nif (!net)\r\ngoto err_out1;\r\nSET_NETDEV_DEV(net, &intf->dev);\r\nkingsun = netdev_priv(net);\r\nkingsun->netdev = net;\r\nkingsun->usbdev = dev;\r\nkingsun->irlap = NULL;\r\nkingsun->tx_setuprequest = NULL;\r\nkingsun->tx_urb = NULL;\r\nkingsun->tx_buf_clear = NULL;\r\nkingsun->tx_buf_xored = NULL;\r\nkingsun->tx_buf_clear_used = 0;\r\nkingsun->tx_buf_clear_sent = 0;\r\nkingsun->rx_setuprequest = NULL;\r\nkingsun->rx_urb = NULL;\r\nkingsun->rx_buf = NULL;\r\nkingsun->rx_variable_xormask = 0;\r\nkingsun->rx_unwrap_buff.in_frame = FALSE;\r\nkingsun->rx_unwrap_buff.state = OUTSIDE_FRAME;\r\nkingsun->rx_unwrap_buff.skb = NULL;\r\nkingsun->receiving = 0;\r\nspin_lock_init(&kingsun->lock);\r\nkingsun->speed_setuprequest = NULL;\r\nkingsun->speed_urb = NULL;\r\nkingsun->speedparams.baudrate = 0;\r\nkingsun->rx_buf = kmalloc(KINGSUN_RCV_FIFO_SIZE, GFP_KERNEL);\r\nif (!kingsun->rx_buf)\r\ngoto free_mem;\r\nkingsun->rx_setuprequest =\r\nkmalloc(sizeof(struct usb_ctrlrequest), GFP_KERNEL);\r\nif (!kingsun->rx_setuprequest)\r\ngoto free_mem;\r\nkingsun->rx_setuprequest->bRequestType =\r\nUSB_DIR_IN | USB_TYPE_CLASS | USB_RECIP_INTERFACE;\r\nkingsun->rx_setuprequest->bRequest = KINGSUN_REQ_RECV;\r\nkingsun->rx_setuprequest->wValue = cpu_to_le16(0x0200);\r\nkingsun->rx_setuprequest->wIndex = 0;\r\nkingsun->rx_setuprequest->wLength = cpu_to_le16(KINGSUN_RCV_FIFO_SIZE);\r\nkingsun->tx_buf_clear = kmalloc(KINGSUN_SND_FIFO_SIZE, GFP_KERNEL);\r\nif (!kingsun->tx_buf_clear)\r\ngoto free_mem;\r\nkingsun->tx_buf_xored = kmalloc(KINGSUN_SND_PACKET_SIZE, GFP_KERNEL);\r\nif (!kingsun->tx_buf_xored)\r\ngoto free_mem;\r\nkingsun->tx_setuprequest =\r\nkmalloc(sizeof(struct usb_ctrlrequest), GFP_KERNEL);\r\nif (!kingsun->tx_setuprequest)\r\ngoto free_mem;\r\nkingsun->tx_setuprequest->bRequestType =\r\nUSB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE;\r\nkingsun->tx_setuprequest->bRequest = KINGSUN_REQ_SEND;\r\nkingsun->tx_setuprequest->wValue = 0;\r\nkingsun->tx_setuprequest->wIndex = 0;\r\nkingsun->tx_setuprequest->wLength = 0;\r\nkingsun->speed_setuprequest =\r\nkmalloc(sizeof(struct usb_ctrlrequest), GFP_KERNEL);\r\nif (!kingsun->speed_setuprequest)\r\ngoto free_mem;\r\nkingsun->speed_setuprequest->bRequestType =\r\nUSB_DIR_OUT | USB_TYPE_CLASS | USB_RECIP_INTERFACE;\r\nkingsun->speed_setuprequest->bRequest = KINGSUN_REQ_SEND;\r\nkingsun->speed_setuprequest->wValue = cpu_to_le16(0x0200);\r\nkingsun->speed_setuprequest->wIndex = cpu_to_le16(0x0001);\r\nkingsun->speed_setuprequest->wLength =\r\ncpu_to_le16(sizeof(struct ks959_speedparams));\r\nprintk(KERN_INFO "KingSun KS-959 IRDA/USB found at address %d, "\r\n"Vendor: %x, Product: %x\n",\r\ndev->devnum, le16_to_cpu(dev->descriptor.idVendor),\r\nle16_to_cpu(dev->descriptor.idProduct));\r\nirda_init_max_qos_capabilies(&kingsun->qos);\r\nkingsun->qos.baud_rate.bits =\r\nIR_2400 | IR_9600 | IR_19200 | IR_38400 | IR_57600;\r\nkingsun->qos.min_turn_time.bits &= KINGSUN_MTT;\r\nirda_qos_bits_to_value(&kingsun->qos);\r\nnet->netdev_ops = &ks959_ops;\r\nret = register_netdev(net);\r\nif (ret != 0)\r\ngoto free_mem;\r\ndev_info(&net->dev, "IrDA: Registered KingSun KS-959 device %s\n",\r\nnet->name);\r\nusb_set_intfdata(intf, kingsun);\r\nreturn 0;\r\nfree_mem:\r\nkfree(kingsun->speed_setuprequest);\r\nkfree(kingsun->tx_setuprequest);\r\nkfree(kingsun->tx_buf_xored);\r\nkfree(kingsun->tx_buf_clear);\r\nkfree(kingsun->rx_setuprequest);\r\nkfree(kingsun->rx_buf);\r\nfree_netdev(net);\r\nerr_out1:\r\nreturn ret;\r\n}\r\nstatic void ks959_disconnect(struct usb_interface *intf)\r\n{\r\nstruct ks959_cb *kingsun = usb_get_intfdata(intf);\r\nif (!kingsun)\r\nreturn;\r\nunregister_netdev(kingsun->netdev);\r\nif (kingsun->speed_urb != NULL) {\r\nusb_kill_urb(kingsun->speed_urb);\r\nusb_free_urb(kingsun->speed_urb);\r\nkingsun->speed_urb = NULL;\r\n}\r\nif (kingsun->tx_urb != NULL) {\r\nusb_kill_urb(kingsun->tx_urb);\r\nusb_free_urb(kingsun->tx_urb);\r\nkingsun->tx_urb = NULL;\r\n}\r\nif (kingsun->rx_urb != NULL) {\r\nusb_kill_urb(kingsun->rx_urb);\r\nusb_free_urb(kingsun->rx_urb);\r\nkingsun->rx_urb = NULL;\r\n}\r\nkfree(kingsun->speed_setuprequest);\r\nkfree(kingsun->tx_setuprequest);\r\nkfree(kingsun->tx_buf_xored);\r\nkfree(kingsun->tx_buf_clear);\r\nkfree(kingsun->rx_setuprequest);\r\nkfree(kingsun->rx_buf);\r\nfree_netdev(kingsun->netdev);\r\nusb_set_intfdata(intf, NULL);\r\n}\r\nstatic int ks959_suspend(struct usb_interface *intf, pm_message_t message)\r\n{\r\nstruct ks959_cb *kingsun = usb_get_intfdata(intf);\r\nnetif_device_detach(kingsun->netdev);\r\nif (kingsun->speed_urb != NULL)\r\nusb_kill_urb(kingsun->speed_urb);\r\nif (kingsun->tx_urb != NULL)\r\nusb_kill_urb(kingsun->tx_urb);\r\nif (kingsun->rx_urb != NULL)\r\nusb_kill_urb(kingsun->rx_urb);\r\nreturn 0;\r\n}\r\nstatic int ks959_resume(struct usb_interface *intf)\r\n{\r\nstruct ks959_cb *kingsun = usb_get_intfdata(intf);\r\nif (kingsun->rx_urb != NULL) {\r\nusb_submit_urb(kingsun->rx_urb, GFP_KERNEL);\r\n}\r\nnetif_device_attach(kingsun->netdev);\r\nreturn 0;\r\n}

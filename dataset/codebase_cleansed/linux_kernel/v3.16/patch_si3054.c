static int si3054_switch_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uvalue)\r\n{\r\nstruct hda_codec *codec = snd_kcontrol_chip(kcontrol);\r\nu16 reg = PRIVATE_REG(kcontrol->private_value);\r\nu16 mask = PRIVATE_MASK(kcontrol->private_value);\r\nuvalue->value.integer.value[0] = (GET_REG(codec, reg)) & mask ? 1 : 0 ;\r\nreturn 0;\r\n}\r\nstatic int si3054_switch_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *uvalue)\r\n{\r\nstruct hda_codec *codec = snd_kcontrol_chip(kcontrol);\r\nu16 reg = PRIVATE_REG(kcontrol->private_value);\r\nu16 mask = PRIVATE_MASK(kcontrol->private_value);\r\nif (uvalue->value.integer.value[0])\r\nSET_REG_CACHE(codec, reg, (GET_REG(codec, reg)) | mask);\r\nelse\r\nSET_REG_CACHE(codec, reg, (GET_REG(codec, reg)) & ~mask);\r\nreturn 0;\r\n}\r\nstatic int si3054_build_controls(struct hda_codec *codec)\r\n{\r\nreturn snd_hda_add_new_ctls(codec, si3054_modem_mixer);\r\n}\r\nstatic int si3054_pcm_prepare(struct hda_pcm_stream *hinfo,\r\nstruct hda_codec *codec,\r\nunsigned int stream_tag,\r\nunsigned int format,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nu16 val;\r\nSET_REG(codec, SI3054_LINE_RATE, substream->runtime->rate);\r\nval = GET_REG(codec, SI3054_LINE_LEVEL);\r\nval &= 0xff << (8 * (substream->stream != SNDRV_PCM_STREAM_PLAYBACK));\r\nval |= ((stream_tag & 0xf) << 4) << (8 * (substream->stream == SNDRV_PCM_STREAM_PLAYBACK));\r\nSET_REG(codec, SI3054_LINE_LEVEL, val);\r\nsnd_hda_codec_setup_stream(codec, hinfo->nid,\r\nstream_tag, 0, format);\r\nreturn 0;\r\n}\r\nstatic int si3054_pcm_open(struct hda_pcm_stream *hinfo,\r\nstruct hda_codec *codec,\r\nstruct snd_pcm_substream *substream)\r\n{\r\nstatic unsigned int rates[] = { 8000, 9600, 16000 };\r\nstatic struct snd_pcm_hw_constraint_list hw_constraints_rates = {\r\n.count = ARRAY_SIZE(rates),\r\n.list = rates,\r\n.mask = 0,\r\n};\r\nsubstream->runtime->hw.period_bytes_min = 80;\r\nreturn snd_pcm_hw_constraint_list(substream->runtime, 0,\r\nSNDRV_PCM_HW_PARAM_RATE, &hw_constraints_rates);\r\n}\r\nstatic int si3054_build_pcms(struct hda_codec *codec)\r\n{\r\nstruct si3054_spec *spec = codec->spec;\r\nstruct hda_pcm *info = &spec->pcm;\r\ncodec->num_pcms = 1;\r\ncodec->pcm_info = info;\r\ninfo->name = "Si3054 Modem";\r\ninfo->stream[SNDRV_PCM_STREAM_PLAYBACK] = si3054_pcm;\r\ninfo->stream[SNDRV_PCM_STREAM_CAPTURE] = si3054_pcm;\r\ninfo->stream[SNDRV_PCM_STREAM_PLAYBACK].nid = codec->mfg;\r\ninfo->stream[SNDRV_PCM_STREAM_CAPTURE].nid = codec->mfg;\r\ninfo->pcm_type = HDA_PCM_TYPE_MODEM;\r\nreturn 0;\r\n}\r\nstatic int si3054_init(struct hda_codec *codec)\r\n{\r\nstruct si3054_spec *spec = codec->spec;\r\nunsigned wait_count;\r\nu16 val;\r\nsnd_hda_codec_write(codec, AC_NODE_ROOT, 0, AC_VERB_SET_CODEC_RESET, 0);\r\nsnd_hda_codec_write(codec, codec->mfg, 0, AC_VERB_SET_STREAM_FORMAT, 0);\r\nSET_REG(codec, SI3054_LINE_RATE, 9600);\r\nSET_REG(codec, SI3054_LINE_LEVEL, SI3054_DTAG_MASK|SI3054_ATAG_MASK);\r\nSET_REG(codec, SI3054_EXTENDED_MID, 0);\r\nwait_count = 10;\r\ndo {\r\nmsleep(2);\r\nval = GET_REG(codec, SI3054_EXTENDED_MID);\r\n} while ((val & SI3054_MEI_READY) != SI3054_MEI_READY && wait_count--);\r\nif((val&SI3054_MEI_READY) != SI3054_MEI_READY) {\r\ncodec_err(codec, "si3054: cannot initialize. EXT MID = %04x\n", val);\r\n}\r\nSET_REG(codec, SI3054_GPIO_POLARITY, 0xffff);\r\nSET_REG(codec, SI3054_GPIO_CFG, 0x0);\r\nSET_REG(codec, SI3054_MISC_AFE, 0);\r\nSET_REG(codec, SI3054_LINE_CFG1,0x200);\r\nif((GET_REG(codec,SI3054_LINE_STATUS) & (1<<6)) == 0) {\r\ncodec_dbg(codec,\r\n"Link Frame Detect(FDT) is not ready (line status: %04x)\n",\r\nGET_REG(codec,SI3054_LINE_STATUS));\r\n}\r\nspec->international = GET_REG(codec, SI3054_CHIPID) & SI3054_CHIPID_INTERNATIONAL;\r\nreturn 0;\r\n}\r\nstatic void si3054_free(struct hda_codec *codec)\r\n{\r\nkfree(codec->spec);\r\n}\r\nstatic int patch_si3054(struct hda_codec *codec)\r\n{\r\nstruct si3054_spec *spec = kzalloc(sizeof(*spec), GFP_KERNEL);\r\nif (spec == NULL)\r\nreturn -ENOMEM;\r\ncodec->spec = spec;\r\ncodec->patch_ops = si3054_patch_ops;\r\nreturn 0;\r\n}\r\nstatic int __init patch_si3054_init(void)\r\n{\r\nreturn snd_hda_add_codec_preset(&si3054_list);\r\n}\r\nstatic void __exit patch_si3054_exit(void)\r\n{\r\nsnd_hda_delete_codec_preset(&si3054_list);\r\n}

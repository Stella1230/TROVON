int cx25821_sram_channel_setup_upstream(struct cx25821_dev *dev,\r\nconst struct sram_channel *ch,\r\nunsigned int bpl, u32 risc)\r\n{\r\nunsigned int i, lines;\r\nu32 cdt;\r\nif (ch->cmds_start == 0) {\r\ncx_write(ch->ptr1_reg, 0);\r\ncx_write(ch->ptr2_reg, 0);\r\ncx_write(ch->cnt2_reg, 0);\r\ncx_write(ch->cnt1_reg, 0);\r\nreturn 0;\r\n}\r\nbpl = (bpl + 7) & ~7;\r\ncdt = ch->cdt;\r\nlines = ch->fifo_size / bpl;\r\nif (lines > 4)\r\nlines = 4;\r\nBUG_ON(lines < 2);\r\nfor (i = 0; i < lines; i++) {\r\ncx_write(cdt + 16 * i, ch->fifo_start + bpl * i);\r\ncx_write(cdt + 16 * i + 4, 0);\r\ncx_write(cdt + 16 * i + 8, 0);\r\ncx_write(cdt + 16 * i + 12, 0);\r\n}\r\ncx_write(ch->cmds_start + 0, risc);\r\ncx_write(ch->cmds_start + 4, 0);\r\ncx_write(ch->cmds_start + 8, cdt);\r\ncx_write(ch->cmds_start + 12, (lines * 16) >> 3);\r\ncx_write(ch->cmds_start + 16, ch->ctrl_start);\r\ncx_write(ch->cmds_start + 20, VID_IQ_SIZE_DW);\r\nfor (i = 24; i < 80; i += 4)\r\ncx_write(ch->cmds_start + i, 0);\r\ncx_write(ch->ptr1_reg, ch->fifo_start);\r\ncx_write(ch->ptr2_reg, cdt);\r\ncx_write(ch->cnt2_reg, (lines * 16) >> 3);\r\ncx_write(ch->cnt1_reg, (bpl >> 3) - 1);\r\nreturn 0;\r\n}\r\nstatic __le32 *cx25821_update_riscprogram(struct cx25821_channel *chan,\r\n__le32 *rp, unsigned int offset,\r\nunsigned int bpl, u32 sync_line,\r\nunsigned int lines, int fifo_enable,\r\nint field_type)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nunsigned int line, i;\r\nint dist_betwn_starts = bpl * 2;\r\n*(rp++) = cpu_to_le32(RISC_RESYNC | sync_line);\r\nif (USE_RISC_NOOP_VIDEO) {\r\nfor (i = 0; i < NUM_NO_OPS; i++)\r\n*(rp++) = cpu_to_le32(RISC_NOOP);\r\n}\r\nfor (line = 0; line < lines; line++) {\r\n*(rp++) = cpu_to_le32(RISC_READ | RISC_SOL | RISC_EOL | bpl);\r\n*(rp++) = cpu_to_le32(out->_data_buf_phys_addr + offset);\r\n*(rp++) = cpu_to_le32(0);\r\nif ((lines <= NTSC_FIELD_HEIGHT)\r\n|| (line < (NTSC_FIELD_HEIGHT - 1)) || !(out->is_60hz)) {\r\noffset += dist_betwn_starts;\r\n}\r\n}\r\nreturn rp;\r\n}\r\nstatic __le32 *cx25821_risc_field_upstream(struct cx25821_channel *chan, __le32 *rp,\r\ndma_addr_t databuf_phys_addr,\r\nunsigned int offset, u32 sync_line,\r\nunsigned int bpl, unsigned int lines,\r\nint fifo_enable, int field_type)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nunsigned int line, i;\r\nconst struct sram_channel *sram_ch = chan->sram_channels;\r\nint dist_betwn_starts = bpl * 2;\r\nif (sync_line != NO_SYNC_LINE)\r\n*(rp++) = cpu_to_le32(RISC_RESYNC | sync_line);\r\nif (USE_RISC_NOOP_VIDEO) {\r\nfor (i = 0; i < NUM_NO_OPS; i++)\r\n*(rp++) = cpu_to_le32(RISC_NOOP);\r\n}\r\nfor (line = 0; line < lines; line++) {\r\n*(rp++) = cpu_to_le32(RISC_READ | RISC_SOL | RISC_EOL | bpl);\r\n*(rp++) = cpu_to_le32(databuf_phys_addr + offset);\r\n*(rp++) = cpu_to_le32(0);\r\nif ((lines <= NTSC_FIELD_HEIGHT)\r\n|| (line < (NTSC_FIELD_HEIGHT - 1)) || !(out->is_60hz))\r\noffset += dist_betwn_starts;\r\nif (fifo_enable && line == 3) {\r\n*(rp++) = cpu_to_le32(RISC_WRITECR);\r\n*(rp++) = cpu_to_le32(sram_ch->dma_ctl);\r\n*(rp++) = cpu_to_le32(FLD_VID_FIFO_EN);\r\n*(rp++) = cpu_to_le32(0x00000001);\r\n}\r\n}\r\nreturn rp;\r\n}\r\nstatic int cx25821_risc_buffer_upstream(struct cx25821_channel *chan,\r\nstruct pci_dev *pci,\r\nunsigned int top_offset,\r\nunsigned int bpl, unsigned int lines)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\n__le32 *rp;\r\nint fifo_enable = 0;\r\nint singlefield_lines = lines >> 1;\r\nint odd_num_lines = singlefield_lines;\r\nint frame = 0;\r\nint frame_size = 0;\r\nint databuf_offset = 0;\r\nint risc_program_size = 0;\r\nint risc_flag = RISC_CNT_RESET;\r\nunsigned int bottom_offset = bpl;\r\ndma_addr_t risc_phys_jump_addr;\r\nif (out->is_60hz) {\r\nodd_num_lines = singlefield_lines + 1;\r\nrisc_program_size = FRAME1_VID_PROG_SIZE;\r\nframe_size = (bpl == Y411_LINE_SZ) ?\r\nFRAME_SIZE_NTSC_Y411 : FRAME_SIZE_NTSC_Y422;\r\n} else {\r\nrisc_program_size = PAL_VID_PROG_SIZE;\r\nframe_size = (bpl == Y411_LINE_SZ) ?\r\nFRAME_SIZE_PAL_Y411 : FRAME_SIZE_PAL_Y422;\r\n}\r\nrp = out->_dma_virt_addr;\r\nfor (frame = 0; frame < NUM_FRAMES; frame++) {\r\ndatabuf_offset = frame_size * frame;\r\nif (UNSET != top_offset) {\r\nfifo_enable = (frame == 0) ? FIFO_ENABLE : FIFO_DISABLE;\r\nrp = cx25821_risc_field_upstream(chan, rp,\r\nout->_data_buf_phys_addr +\r\ndatabuf_offset, top_offset, 0, bpl,\r\nodd_num_lines, fifo_enable, ODD_FIELD);\r\n}\r\nfifo_enable = FIFO_DISABLE;\r\nrp = cx25821_risc_field_upstream(chan, rp,\r\nout->_data_buf_phys_addr +\r\ndatabuf_offset, bottom_offset,\r\n0x200, bpl, singlefield_lines,\r\nfifo_enable, EVEN_FIELD);\r\nif (frame == 0) {\r\nrisc_flag = RISC_CNT_RESET;\r\nrisc_phys_jump_addr = out->_dma_phys_start_addr +\r\nrisc_program_size;\r\n} else {\r\nrisc_phys_jump_addr = out->_dma_phys_start_addr;\r\nrisc_flag = RISC_CNT_INC;\r\n}\r\n*(rp++) = cpu_to_le32(RISC_JUMP | RISC_IRQ1 | risc_flag);\r\n*(rp++) = cpu_to_le32(risc_phys_jump_addr);\r\n*(rp++) = cpu_to_le32(0);\r\n}\r\nreturn 0;\r\n}\r\nvoid cx25821_stop_upstream_video(struct cx25821_channel *chan)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nconst struct sram_channel *sram_ch = chan->sram_channels;\r\nu32 tmp = 0;\r\nif (!out->_is_running) {\r\npr_info("No video file is currently running so return!\n");\r\nreturn;\r\n}\r\ncx_set(PCI_INT_MSK, cx_read(PCI_INT_MSK) & ~(1 << sram_ch->irq_bit));\r\ntmp = cx_read(sram_ch->int_msk);\r\ncx_write(sram_ch->int_msk, tmp & ~_intr_msk);\r\ntmp = cx_read(sram_ch->dma_ctl);\r\ncx_write(sram_ch->dma_ctl, tmp & ~(FLD_VID_FIFO_EN | FLD_VID_RISC_EN));\r\nfree_irq(dev->pci->irq, chan);\r\nif (out->_data_buf_virt_addr)\r\nmemset(out->_data_buf_virt_addr, 0, out->_data_buf_size);\r\nout->_is_running = 0;\r\nout->_is_first_frame = 0;\r\nout->_frame_count = 0;\r\nout->_file_status = END_OF_FILE;\r\ntmp = cx_read(VID_CH_MODE_SEL);\r\ncx_write(VID_CH_MODE_SEL, tmp & 0xFFFFFE00);\r\n}\r\nvoid cx25821_free_mem_upstream(struct cx25821_channel *chan)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nif (out->_is_running)\r\ncx25821_stop_upstream_video(chan);\r\nif (out->_dma_virt_addr) {\r\npci_free_consistent(dev->pci, out->_risc_size,\r\nout->_dma_virt_addr, out->_dma_phys_addr);\r\nout->_dma_virt_addr = NULL;\r\n}\r\nif (out->_data_buf_virt_addr) {\r\npci_free_consistent(dev->pci, out->_data_buf_size,\r\nout->_data_buf_virt_addr,\r\nout->_data_buf_phys_addr);\r\nout->_data_buf_virt_addr = NULL;\r\n}\r\n}\r\nint cx25821_write_frame(struct cx25821_channel *chan,\r\nconst char __user *data, size_t count)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nint line_size = (out->_pixel_format == PIXEL_FRMT_411) ?\r\nY411_LINE_SZ : Y422_LINE_SZ;\r\nint frame_size = 0;\r\nint frame_offset = 0;\r\nint curpos = out->curpos;\r\nif (out->is_60hz)\r\nframe_size = (line_size == Y411_LINE_SZ) ?\r\nFRAME_SIZE_NTSC_Y411 : FRAME_SIZE_NTSC_Y422;\r\nelse\r\nframe_size = (line_size == Y411_LINE_SZ) ?\r\nFRAME_SIZE_PAL_Y411 : FRAME_SIZE_PAL_Y422;\r\nif (curpos == 0) {\r\nout->cur_frame_index = out->_frame_index;\r\nif (wait_event_interruptible(out->waitq, out->cur_frame_index != out->_frame_index))\r\nreturn -EINTR;\r\nout->cur_frame_index = out->_frame_index;\r\n}\r\nframe_offset = out->cur_frame_index ? frame_size : 0;\r\nif (frame_size - curpos < count)\r\ncount = frame_size - curpos;\r\nmemcpy((char *)out->_data_buf_virt_addr + frame_offset + curpos,\r\ndata, count);\r\ncurpos += count;\r\nif (curpos == frame_size) {\r\nout->_frame_count++;\r\ncurpos = 0;\r\n}\r\nout->curpos = curpos;\r\nreturn count;\r\n}\r\nstatic int cx25821_upstream_buffer_prepare(struct cx25821_channel *chan,\r\nconst struct sram_channel *sram_ch,\r\nint bpl)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nint ret = 0;\r\ndma_addr_t dma_addr;\r\ndma_addr_t data_dma_addr;\r\nif (out->_dma_virt_addr != NULL)\r\npci_free_consistent(dev->pci, out->upstream_riscbuf_size,\r\nout->_dma_virt_addr, out->_dma_phys_addr);\r\nout->_dma_virt_addr = pci_alloc_consistent(dev->pci,\r\nout->upstream_riscbuf_size, &dma_addr);\r\nout->_dma_virt_start_addr = out->_dma_virt_addr;\r\nout->_dma_phys_start_addr = dma_addr;\r\nout->_dma_phys_addr = dma_addr;\r\nout->_risc_size = out->upstream_riscbuf_size;\r\nif (!out->_dma_virt_addr) {\r\npr_err("FAILED to allocate memory for Risc buffer! Returning\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(out->_dma_virt_addr, 0, out->_risc_size);\r\nif (out->_data_buf_virt_addr != NULL)\r\npci_free_consistent(dev->pci, out->upstream_databuf_size,\r\nout->_data_buf_virt_addr,\r\nout->_data_buf_phys_addr);\r\nout->_data_buf_virt_addr = pci_alloc_consistent(dev->pci,\r\nout->upstream_databuf_size, &data_dma_addr);\r\nout->_data_buf_phys_addr = data_dma_addr;\r\nout->_data_buf_size = out->upstream_databuf_size;\r\nif (!out->_data_buf_virt_addr) {\r\npr_err("FAILED to allocate memory for data buffer! Returning\n");\r\nreturn -ENOMEM;\r\n}\r\nmemset(out->_data_buf_virt_addr, 0, out->_data_buf_size);\r\nret = cx25821_risc_buffer_upstream(chan, dev->pci, 0, bpl,\r\nout->_lines_count);\r\nif (ret < 0) {\r\npr_info("Failed creating Video Upstream Risc programs!\n");\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nreturn ret;\r\n}\r\nstatic int cx25821_video_upstream_irq(struct cx25821_channel *chan, u32 status)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nu32 int_msk_tmp;\r\nconst struct sram_channel *channel = chan->sram_channels;\r\nint singlefield_lines = NTSC_FIELD_HEIGHT;\r\nint line_size_in_bytes = Y422_LINE_SZ;\r\nint odd_risc_prog_size = 0;\r\ndma_addr_t risc_phys_jump_addr;\r\n__le32 *rp;\r\nif (status & FLD_VID_SRC_RISC1) {\r\nu32 prog_cnt = cx_read(channel->gpcnt);\r\nint_msk_tmp = cx_read(channel->int_msk);\r\ncx_write(channel->int_msk, int_msk_tmp & ~_intr_msk);\r\ncx_write(channel->int_stat, _intr_msk);\r\nwake_up(&out->waitq);\r\nspin_lock(&dev->slock);\r\nout->_frame_index = prog_cnt;\r\nif (out->_is_first_frame) {\r\nout->_is_first_frame = 0;\r\nif (out->is_60hz) {\r\nsinglefield_lines += 1;\r\nodd_risc_prog_size = ODD_FLD_NTSC_PROG_SIZE;\r\n} else {\r\nsinglefield_lines = PAL_FIELD_HEIGHT;\r\nodd_risc_prog_size = ODD_FLD_PAL_PROG_SIZE;\r\n}\r\nif (out->_dma_virt_start_addr != NULL) {\r\nline_size_in_bytes =\r\n(out->_pixel_format ==\r\nPIXEL_FRMT_411) ? Y411_LINE_SZ :\r\nY422_LINE_SZ;\r\nrisc_phys_jump_addr =\r\nout->_dma_phys_start_addr +\r\nodd_risc_prog_size;\r\nrp = cx25821_update_riscprogram(chan,\r\nout->_dma_virt_start_addr, TOP_OFFSET,\r\nline_size_in_bytes, 0x0,\r\nsinglefield_lines, FIFO_DISABLE,\r\nODD_FIELD);\r\n*(rp++) = cpu_to_le32(RISC_JUMP);\r\n*(rp++) = cpu_to_le32(risc_phys_jump_addr);\r\n*(rp++) = cpu_to_le32(0);\r\n}\r\n}\r\nspin_unlock(&dev->slock);\r\n} else {\r\nif (status & FLD_VID_SRC_UF)\r\npr_err("%s(): Video Received Underflow Error Interrupt!\n",\r\n__func__);\r\nif (status & FLD_VID_SRC_SYNC)\r\npr_err("%s(): Video Received Sync Error Interrupt!\n",\r\n__func__);\r\nif (status & FLD_VID_SRC_OPC_ERR)\r\npr_err("%s(): Video Received OpCode Error Interrupt!\n",\r\n__func__);\r\n}\r\nif (out->_file_status == END_OF_FILE) {\r\npr_err("EOF Channel 1 Framecount = %d\n", out->_frame_count);\r\nreturn -1;\r\n}\r\nint_msk_tmp = cx_read(channel->int_msk);\r\ncx_write(channel->int_msk, int_msk_tmp |= _intr_msk);\r\nreturn 0;\r\n}\r\nstatic irqreturn_t cx25821_upstream_irq(int irq, void *dev_id)\r\n{\r\nstruct cx25821_channel *chan = dev_id;\r\nstruct cx25821_dev *dev = chan->dev;\r\nu32 vid_status;\r\nint handled = 0;\r\nconst struct sram_channel *sram_ch;\r\nif (!dev)\r\nreturn -1;\r\nsram_ch = chan->sram_channels;\r\nvid_status = cx_read(sram_ch->int_stat);\r\nif (vid_status)\r\nhandled = cx25821_video_upstream_irq(chan, vid_status);\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic void cx25821_set_pixelengine(struct cx25821_channel *chan,\r\nconst struct sram_channel *ch,\r\nint pix_format)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nint width = WIDTH_D1;\r\nint height = out->_lines_count;\r\nint num_lines, odd_num_lines;\r\nu32 value;\r\nint vip_mode = OUTPUT_FRMT_656;\r\nvalue = ((pix_format & 0x3) << 12) | (vip_mode & 0x7);\r\nvalue &= 0xFFFFFFEF;\r\nvalue |= out->is_60hz ? 0 : 0x10;\r\ncx_write(ch->vid_fmt_ctl, value);\r\ncx_write(ch->vid_active_ctl1, width);\r\nnum_lines = (height / 2) & 0x3FF;\r\nodd_num_lines = num_lines;\r\nif (out->is_60hz)\r\nodd_num_lines += 1;\r\nvalue = (num_lines << 16) | odd_num_lines;\r\ncx_write(ch->vid_active_ctl2, value);\r\ncx_write(ch->vid_cdt_size, VID_CDT_SIZE >> 3);\r\n}\r\nstatic int cx25821_start_video_dma_upstream(struct cx25821_channel *chan,\r\nconst struct sram_channel *sram_ch)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nu32 tmp = 0;\r\nint err = 0;\r\ntmp = cx_read(VID_CH_MODE_SEL);\r\ncx_write(VID_CH_MODE_SEL, tmp | 0x1B0001FF);\r\ncx_write(sram_ch->cmds_start + 0, out->_dma_phys_addr);\r\ncx_write(sram_ch->cmds_start + 4, 0);\r\ncx_write(sram_ch->gpcnt_ctl, 3);\r\ncx_write(sram_ch->int_stat, _intr_msk);\r\ncx_set(PCI_INT_MSK, cx_read(PCI_INT_MSK) | (1 << sram_ch->irq_bit));\r\ntmp = cx_read(sram_ch->int_msk);\r\ncx_write(sram_ch->int_msk, tmp |= _intr_msk);\r\nerr = request_irq(dev->pci->irq, cx25821_upstream_irq,\r\nIRQF_SHARED, dev->name, chan);\r\nif (err < 0) {\r\npr_err("%s: can't get upstream IRQ %d\n",\r\ndev->name, dev->pci->irq);\r\ngoto fail_irq;\r\n}\r\ntmp = cx_read(sram_ch->dma_ctl);\r\ncx_set(sram_ch->dma_ctl, tmp | FLD_VID_RISC_EN);\r\nout->_is_running = 1;\r\nout->_is_first_frame = 1;\r\nreturn 0;\r\nfail_irq:\r\ncx25821_dev_unregister(dev);\r\nreturn err;\r\n}\r\nint cx25821_vidupstream_init(struct cx25821_channel *chan,\r\nint pixel_format)\r\n{\r\nstruct cx25821_video_out_data *out = chan->out;\r\nstruct cx25821_dev *dev = chan->dev;\r\nconst struct sram_channel *sram_ch;\r\nu32 tmp;\r\nint err = 0;\r\nint data_frame_size = 0;\r\nint risc_buffer_size = 0;\r\nif (out->_is_running) {\r\npr_info("Video Channel is still running so return!\n");\r\nreturn 0;\r\n}\r\nsram_ch = chan->sram_channels;\r\nout->is_60hz = dev->tvnorm & V4L2_STD_525_60;\r\ntmp = cx_read(VID_CH_MODE_SEL);\r\ncx_write(VID_CH_MODE_SEL, tmp | 0x1B0001FF);\r\nout->_is_running = 0;\r\nout->_frame_count = 0;\r\nout->_file_status = RESET_STATUS;\r\nout->_lines_count = out->is_60hz ? 480 : 576;\r\nout->_pixel_format = pixel_format;\r\nout->_line_size = (out->_pixel_format == PIXEL_FRMT_422) ?\r\n(WIDTH_D1 * 2) : (WIDTH_D1 * 3) / 2;\r\ndata_frame_size = out->is_60hz ? NTSC_DATA_BUF_SZ : PAL_DATA_BUF_SZ;\r\nrisc_buffer_size = out->is_60hz ?\r\nNTSC_RISC_BUF_SIZE : PAL_RISC_BUF_SIZE;\r\nout->_is_running = 0;\r\nout->_frame_count = 0;\r\nout->_file_status = RESET_STATUS;\r\nout->_lines_count = out->is_60hz ? 480 : 576;\r\nout->_pixel_format = pixel_format;\r\nout->_line_size = (out->_pixel_format == PIXEL_FRMT_422) ?\r\n(WIDTH_D1 * 2) : (WIDTH_D1 * 3) / 2;\r\nout->curpos = 0;\r\ninit_waitqueue_head(&out->waitq);\r\nerr = cx25821_sram_channel_setup_upstream(dev, sram_ch,\r\nout->_line_size, 0);\r\ncx25821_set_pixelengine(chan, sram_ch, out->_pixel_format);\r\nout->upstream_riscbuf_size = risc_buffer_size * 2;\r\nout->upstream_databuf_size = data_frame_size * 2;\r\nerr = cx25821_upstream_buffer_prepare(chan, sram_ch, out->_line_size);\r\nif (err < 0) {\r\npr_err("%s: Failed to set up Video upstream buffers!\n",\r\ndev->name);\r\ngoto error;\r\n}\r\ncx25821_start_video_dma_upstream(chan, sram_ch);\r\nreturn 0;\r\nerror:\r\ncx25821_dev_unregister(dev);\r\nreturn err;\r\n}

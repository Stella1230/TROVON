static inline void xiic_setreg8(struct xiic_i2c *i2c, int reg, u8 value)\r\n{\r\niowrite8(value, i2c->base + reg);\r\n}\r\nstatic inline u8 xiic_getreg8(struct xiic_i2c *i2c, int reg)\r\n{\r\nreturn ioread8(i2c->base + reg);\r\n}\r\nstatic inline void xiic_setreg16(struct xiic_i2c *i2c, int reg, u16 value)\r\n{\r\niowrite16(value, i2c->base + reg);\r\n}\r\nstatic inline void xiic_setreg32(struct xiic_i2c *i2c, int reg, int value)\r\n{\r\niowrite32(value, i2c->base + reg);\r\n}\r\nstatic inline int xiic_getreg32(struct xiic_i2c *i2c, int reg)\r\n{\r\nreturn ioread32(i2c->base + reg);\r\n}\r\nstatic inline void xiic_irq_dis(struct xiic_i2c *i2c, u32 mask)\r\n{\r\nu32 ier = xiic_getreg32(i2c, XIIC_IIER_OFFSET);\r\nxiic_setreg32(i2c, XIIC_IIER_OFFSET, ier & ~mask);\r\n}\r\nstatic inline void xiic_irq_en(struct xiic_i2c *i2c, u32 mask)\r\n{\r\nu32 ier = xiic_getreg32(i2c, XIIC_IIER_OFFSET);\r\nxiic_setreg32(i2c, XIIC_IIER_OFFSET, ier | mask);\r\n}\r\nstatic inline void xiic_irq_clr(struct xiic_i2c *i2c, u32 mask)\r\n{\r\nu32 isr = xiic_getreg32(i2c, XIIC_IISR_OFFSET);\r\nxiic_setreg32(i2c, XIIC_IISR_OFFSET, isr & mask);\r\n}\r\nstatic inline void xiic_irq_clr_en(struct xiic_i2c *i2c, u32 mask)\r\n{\r\nxiic_irq_clr(i2c, mask);\r\nxiic_irq_en(i2c, mask);\r\n}\r\nstatic void xiic_clear_rx_fifo(struct xiic_i2c *i2c)\r\n{\r\nu8 sr;\r\nfor (sr = xiic_getreg8(i2c, XIIC_SR_REG_OFFSET);\r\n!(sr & XIIC_SR_RX_FIFO_EMPTY_MASK);\r\nsr = xiic_getreg8(i2c, XIIC_SR_REG_OFFSET))\r\nxiic_getreg8(i2c, XIIC_DRR_REG_OFFSET);\r\n}\r\nstatic void xiic_reinit(struct xiic_i2c *i2c)\r\n{\r\nxiic_setreg32(i2c, XIIC_RESETR_OFFSET, XIIC_RESET_MASK);\r\nxiic_setreg8(i2c, XIIC_RFD_REG_OFFSET, IIC_RX_FIFO_DEPTH - 1);\r\nxiic_setreg8(i2c, XIIC_CR_REG_OFFSET, XIIC_CR_TX_FIFO_RESET_MASK);\r\nxiic_setreg8(i2c, XIIC_CR_REG_OFFSET, XIIC_CR_ENABLE_DEVICE_MASK);\r\nxiic_clear_rx_fifo(i2c);\r\nxiic_setreg32(i2c, XIIC_DGIER_OFFSET, XIIC_GINTR_ENABLE_MASK);\r\nxiic_irq_clr_en(i2c, XIIC_INTR_AAS_MASK | XIIC_INTR_ARB_LOST_MASK);\r\n}\r\nstatic void xiic_deinit(struct xiic_i2c *i2c)\r\n{\r\nu8 cr;\r\nxiic_setreg32(i2c, XIIC_RESETR_OFFSET, XIIC_RESET_MASK);\r\ncr = xiic_getreg8(i2c, XIIC_CR_REG_OFFSET);\r\nxiic_setreg8(i2c, XIIC_CR_REG_OFFSET, cr & ~XIIC_CR_ENABLE_DEVICE_MASK);\r\n}\r\nstatic void xiic_read_rx(struct xiic_i2c *i2c)\r\n{\r\nu8 bytes_in_fifo;\r\nint i;\r\nbytes_in_fifo = xiic_getreg8(i2c, XIIC_RFO_REG_OFFSET) + 1;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s entry, bytes in fifo: %d, msg: %d, SR: 0x%x, CR: 0x%x\n",\r\n__func__, bytes_in_fifo, xiic_rx_space(i2c),\r\nxiic_getreg8(i2c, XIIC_SR_REG_OFFSET),\r\nxiic_getreg8(i2c, XIIC_CR_REG_OFFSET));\r\nif (bytes_in_fifo > xiic_rx_space(i2c))\r\nbytes_in_fifo = xiic_rx_space(i2c);\r\nfor (i = 0; i < bytes_in_fifo; i++)\r\ni2c->rx_msg->buf[i2c->rx_pos++] =\r\nxiic_getreg8(i2c, XIIC_DRR_REG_OFFSET);\r\nxiic_setreg8(i2c, XIIC_RFD_REG_OFFSET,\r\n(xiic_rx_space(i2c) > IIC_RX_FIFO_DEPTH) ?\r\nIIC_RX_FIFO_DEPTH - 1 : xiic_rx_space(i2c) - 1);\r\n}\r\nstatic int xiic_tx_fifo_space(struct xiic_i2c *i2c)\r\n{\r\nreturn IIC_TX_FIFO_DEPTH - xiic_getreg8(i2c, XIIC_TFO_REG_OFFSET) - 1;\r\n}\r\nstatic void xiic_fill_tx_fifo(struct xiic_i2c *i2c)\r\n{\r\nu8 fifo_space = xiic_tx_fifo_space(i2c);\r\nint len = xiic_tx_space(i2c);\r\nlen = (len > fifo_space) ? fifo_space : len;\r\ndev_dbg(i2c->adap.dev.parent, "%s entry, len: %d, fifo space: %d\n",\r\n__func__, len, fifo_space);\r\nwhile (len--) {\r\nu16 data = i2c->tx_msg->buf[i2c->tx_pos++];\r\nif ((xiic_tx_space(i2c) == 0) && (i2c->nmsgs == 1)) {\r\ndata |= XIIC_TX_DYN_STOP_MASK;\r\ndev_dbg(i2c->adap.dev.parent, "%s TX STOP\n", __func__);\r\n}\r\nxiic_setreg16(i2c, XIIC_DTR_REG_OFFSET, data);\r\n}\r\n}\r\nstatic void xiic_wakeup(struct xiic_i2c *i2c, int code)\r\n{\r\ni2c->tx_msg = NULL;\r\ni2c->rx_msg = NULL;\r\ni2c->nmsgs = 0;\r\ni2c->state = code;\r\nwake_up(&i2c->wait);\r\n}\r\nstatic void xiic_process(struct xiic_i2c *i2c)\r\n{\r\nu32 pend, isr, ier;\r\nu32 clr = 0;\r\nisr = xiic_getreg32(i2c, XIIC_IISR_OFFSET);\r\nier = xiic_getreg32(i2c, XIIC_IIER_OFFSET);\r\npend = isr & ier;\r\ndev_dbg(i2c->adap.dev.parent, "%s: IER: 0x%x, ISR: 0x%x, pend: 0x%x\n",\r\n__func__, ier, isr, pend);\r\ndev_dbg(i2c->adap.dev.parent, "%s: SR: 0x%x, msg: %p, nmsgs: %d\n",\r\n__func__, xiic_getreg8(i2c, XIIC_SR_REG_OFFSET),\r\ni2c->tx_msg, i2c->nmsgs);\r\nif (!pend)\r\nreturn;\r\nif ((pend & XIIC_INTR_ARB_LOST_MASK) ||\r\n((pend & XIIC_INTR_TX_ERROR_MASK) &&\r\n!(pend & XIIC_INTR_RX_FULL_MASK))) {\r\ndev_dbg(i2c->adap.dev.parent, "%s error\n", __func__);\r\nxiic_reinit(i2c);\r\nif (i2c->tx_msg)\r\nxiic_wakeup(i2c, STATE_ERROR);\r\n} else if (pend & XIIC_INTR_RX_FULL_MASK) {\r\nclr = XIIC_INTR_RX_FULL_MASK;\r\nif (!i2c->rx_msg) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s unexpexted RX IRQ\n", __func__);\r\nxiic_clear_rx_fifo(i2c);\r\ngoto out;\r\n}\r\nxiic_read_rx(i2c);\r\nif (xiic_rx_space(i2c) == 0) {\r\ni2c->rx_msg = NULL;\r\nclr |= (isr & XIIC_INTR_TX_ERROR_MASK);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s end of message, nmsgs: %d\n",\r\n__func__, i2c->nmsgs);\r\nif (i2c->nmsgs > 1) {\r\ni2c->nmsgs--;\r\ni2c->tx_msg++;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s will start next...\n", __func__);\r\n__xiic_start_xfer(i2c);\r\n}\r\n}\r\n} else if (pend & XIIC_INTR_BNB_MASK) {\r\nclr = XIIC_INTR_BNB_MASK;\r\nxiic_irq_dis(i2c, XIIC_INTR_BNB_MASK);\r\nif (!i2c->tx_msg)\r\ngoto out;\r\nif ((i2c->nmsgs == 1) && !i2c->rx_msg &&\r\nxiic_tx_space(i2c) == 0)\r\nxiic_wakeup(i2c, STATE_DONE);\r\nelse\r\nxiic_wakeup(i2c, STATE_ERROR);\r\n} else if (pend & (XIIC_INTR_TX_EMPTY_MASK | XIIC_INTR_TX_HALF_MASK)) {\r\nclr = pend &\r\n(XIIC_INTR_TX_EMPTY_MASK | XIIC_INTR_TX_HALF_MASK);\r\nif (!i2c->tx_msg) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s unexpexted TX IRQ\n", __func__);\r\ngoto out;\r\n}\r\nxiic_fill_tx_fifo(i2c);\r\nif (!xiic_tx_space(i2c) && xiic_tx_fifo_space(i2c) >= 2) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s end of message sent, nmsgs: %d\n",\r\n__func__, i2c->nmsgs);\r\nif (i2c->nmsgs > 1) {\r\ni2c->nmsgs--;\r\ni2c->tx_msg++;\r\n__xiic_start_xfer(i2c);\r\n} else {\r\nxiic_irq_dis(i2c, XIIC_INTR_TX_HALF_MASK);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s Got TX IRQ but no more to do...\n",\r\n__func__);\r\n}\r\n} else if (!xiic_tx_space(i2c) && (i2c->nmsgs == 1))\r\nxiic_irq_dis(i2c, XIIC_INTR_TX_HALF_MASK);\r\n} else {\r\ndev_err(i2c->adap.dev.parent, "%s Got unexpected IRQ\n",\r\n__func__);\r\nclr = pend;\r\n}\r\nout:\r\ndev_dbg(i2c->adap.dev.parent, "%s clr: 0x%x\n", __func__, clr);\r\nxiic_setreg32(i2c, XIIC_IISR_OFFSET, clr);\r\n}\r\nstatic int xiic_bus_busy(struct xiic_i2c *i2c)\r\n{\r\nu8 sr = xiic_getreg8(i2c, XIIC_SR_REG_OFFSET);\r\nreturn (sr & XIIC_SR_BUS_BUSY_MASK) ? -EBUSY : 0;\r\n}\r\nstatic int xiic_busy(struct xiic_i2c *i2c)\r\n{\r\nint tries = 3;\r\nint err;\r\nif (i2c->tx_msg)\r\nreturn -EBUSY;\r\nerr = xiic_bus_busy(i2c);\r\nwhile (err && tries--) {\r\nmdelay(1);\r\nerr = xiic_bus_busy(i2c);\r\n}\r\nreturn err;\r\n}\r\nstatic void xiic_start_recv(struct xiic_i2c *i2c)\r\n{\r\nu8 rx_watermark;\r\nstruct i2c_msg *msg = i2c->rx_msg = i2c->tx_msg;\r\nxiic_irq_clr_en(i2c, XIIC_INTR_RX_FULL_MASK | XIIC_INTR_TX_ERROR_MASK);\r\nrx_watermark = msg->len;\r\nif (rx_watermark > IIC_RX_FIFO_DEPTH)\r\nrx_watermark = IIC_RX_FIFO_DEPTH;\r\nxiic_setreg8(i2c, XIIC_RFD_REG_OFFSET, rx_watermark - 1);\r\nif (!(msg->flags & I2C_M_NOSTART))\r\nxiic_setreg16(i2c, XIIC_DTR_REG_OFFSET,\r\n(msg->addr << 1) | XIIC_READ_OPERATION |\r\nXIIC_TX_DYN_START_MASK);\r\nxiic_irq_clr_en(i2c, XIIC_INTR_BNB_MASK);\r\nxiic_setreg16(i2c, XIIC_DTR_REG_OFFSET,\r\nmsg->len | ((i2c->nmsgs == 1) ? XIIC_TX_DYN_STOP_MASK : 0));\r\nif (i2c->nmsgs == 1)\r\nxiic_irq_clr_en(i2c, XIIC_INTR_BNB_MASK);\r\ni2c->tx_pos = msg->len;\r\n}\r\nstatic void xiic_start_send(struct xiic_i2c *i2c)\r\n{\r\nstruct i2c_msg *msg = i2c->tx_msg;\r\nxiic_irq_clr(i2c, XIIC_INTR_TX_ERROR_MASK);\r\ndev_dbg(i2c->adap.dev.parent, "%s entry, msg: %p, len: %d",\r\n__func__, msg, msg->len);\r\ndev_dbg(i2c->adap.dev.parent, "%s entry, ISR: 0x%x, CR: 0x%x\n",\r\n__func__, xiic_getreg32(i2c, XIIC_IISR_OFFSET),\r\nxiic_getreg8(i2c, XIIC_CR_REG_OFFSET));\r\nif (!(msg->flags & I2C_M_NOSTART)) {\r\nu16 data = ((msg->addr << 1) & 0xfe) | XIIC_WRITE_OPERATION |\r\nXIIC_TX_DYN_START_MASK;\r\nif ((i2c->nmsgs == 1) && msg->len == 0)\r\ndata |= XIIC_TX_DYN_STOP_MASK;\r\nxiic_setreg16(i2c, XIIC_DTR_REG_OFFSET, data);\r\n}\r\nxiic_fill_tx_fifo(i2c);\r\nxiic_irq_clr_en(i2c, XIIC_INTR_TX_EMPTY_MASK | XIIC_INTR_TX_ERROR_MASK |\r\nXIIC_INTR_BNB_MASK);\r\n}\r\nstatic irqreturn_t xiic_isr(int irq, void *dev_id)\r\n{\r\nstruct xiic_i2c *i2c = dev_id;\r\nspin_lock(&i2c->lock);\r\nxiic_setreg32(i2c, XIIC_DGIER_OFFSET, 0);\r\ndev_dbg(i2c->adap.dev.parent, "%s entry\n", __func__);\r\nxiic_process(i2c);\r\nxiic_setreg32(i2c, XIIC_DGIER_OFFSET, XIIC_GINTR_ENABLE_MASK);\r\nspin_unlock(&i2c->lock);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void __xiic_start_xfer(struct xiic_i2c *i2c)\r\n{\r\nint first = 1;\r\nint fifo_space = xiic_tx_fifo_space(i2c);\r\ndev_dbg(i2c->adap.dev.parent, "%s entry, msg: %p, fifos space: %d\n",\r\n__func__, i2c->tx_msg, fifo_space);\r\nif (!i2c->tx_msg)\r\nreturn;\r\ni2c->rx_pos = 0;\r\ni2c->tx_pos = 0;\r\ni2c->state = STATE_START;\r\nwhile ((fifo_space >= 2) && (first || (i2c->nmsgs > 1))) {\r\nif (!first) {\r\ni2c->nmsgs--;\r\ni2c->tx_msg++;\r\ni2c->tx_pos = 0;\r\n} else\r\nfirst = 0;\r\nif (i2c->tx_msg->flags & I2C_M_RD) {\r\nxiic_start_recv(i2c);\r\nreturn;\r\n} else {\r\nxiic_start_send(i2c);\r\nif (xiic_tx_space(i2c) != 0) {\r\nbreak;\r\n}\r\n}\r\nfifo_space = xiic_tx_fifo_space(i2c);\r\n}\r\nif (i2c->nmsgs > 1 || xiic_tx_space(i2c))\r\nxiic_irq_clr_en(i2c, XIIC_INTR_TX_HALF_MASK);\r\n}\r\nstatic void xiic_start_xfer(struct xiic_i2c *i2c)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c->lock, flags);\r\nxiic_reinit(i2c);\r\nxiic_setreg32(i2c, XIIC_DGIER_OFFSET, 0);\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\n__xiic_start_xfer(i2c);\r\nxiic_setreg32(i2c, XIIC_DGIER_OFFSET, XIIC_GINTR_ENABLE_MASK);\r\n}\r\nstatic int xiic_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs, int num)\r\n{\r\nstruct xiic_i2c *i2c = i2c_get_adapdata(adap);\r\nint err;\r\ndev_dbg(adap->dev.parent, "%s entry SR: 0x%x\n", __func__,\r\nxiic_getreg8(i2c, XIIC_SR_REG_OFFSET));\r\nerr = xiic_busy(i2c);\r\nif (err)\r\nreturn err;\r\ni2c->tx_msg = msgs;\r\ni2c->nmsgs = num;\r\nxiic_start_xfer(i2c);\r\nif (wait_event_timeout(i2c->wait, (i2c->state == STATE_ERROR) ||\r\n(i2c->state == STATE_DONE), HZ))\r\nreturn (i2c->state == STATE_DONE) ? num : -EIO;\r\nelse {\r\ni2c->tx_msg = NULL;\r\ni2c->rx_msg = NULL;\r\ni2c->nmsgs = 0;\r\nreturn -ETIMEDOUT;\r\n}\r\n}\r\nstatic u32 xiic_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int xiic_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct xiic_i2c *i2c;\r\nstruct xiic_i2c_platform_data *pdata;\r\nstruct resource *res;\r\nint ret, irq;\r\nu8 i;\r\ni2c = devm_kzalloc(&pdev->dev, sizeof(*i2c), GFP_KERNEL);\r\nif (!i2c)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ni2c->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(i2c->base))\r\nreturn PTR_ERR(i2c->base);\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn irq;\r\npdata = dev_get_platdata(&pdev->dev);\r\nplatform_set_drvdata(pdev, i2c);\r\ni2c->adap = xiic_adapter;\r\ni2c_set_adapdata(&i2c->adap, i2c);\r\ni2c->adap.dev.parent = &pdev->dev;\r\ni2c->adap.dev.of_node = pdev->dev.of_node;\r\nspin_lock_init(&i2c->lock);\r\ninit_waitqueue_head(&i2c->wait);\r\nret = devm_request_irq(&pdev->dev, irq, xiic_isr, 0, pdev->name, i2c);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Cannot claim IRQ\n");\r\nreturn ret;\r\n}\r\nxiic_reinit(i2c);\r\nret = i2c_add_adapter(&i2c->adap);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to add adapter\n");\r\nxiic_deinit(i2c);\r\nreturn ret;\r\n}\r\nif (pdata) {\r\nfor (i = 0; i < pdata->num_devices; i++)\r\ni2c_new_device(&i2c->adap, pdata->devices + i);\r\n}\r\nreturn 0;\r\n}\r\nstatic int xiic_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct xiic_i2c *i2c = platform_get_drvdata(pdev);\r\ni2c_del_adapter(&i2c->adap);\r\nxiic_deinit(i2c);\r\nreturn 0;\r\n}

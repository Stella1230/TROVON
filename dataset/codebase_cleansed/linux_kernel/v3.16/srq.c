void mlx5_srq_event(struct mlx5_core_dev *dev, u32 srqn, int event_type)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_core_srq *srq;\r\nspin_lock(&table->lock);\r\nsrq = radix_tree_lookup(&table->tree, srqn);\r\nif (srq)\r\natomic_inc(&srq->refcount);\r\nspin_unlock(&table->lock);\r\nif (!srq) {\r\nmlx5_core_warn(dev, "Async event for bogus SRQ 0x%08x\n", srqn);\r\nreturn;\r\n}\r\nsrq->event(srq, event_type);\r\nif (atomic_dec_and_test(&srq->refcount))\r\ncomplete(&srq->free);\r\n}\r\nstruct mlx5_core_srq *mlx5_core_get_srq(struct mlx5_core_dev *dev, u32 srqn)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_core_srq *srq;\r\nspin_lock(&table->lock);\r\nsrq = radix_tree_lookup(&table->tree, srqn);\r\nif (srq)\r\natomic_inc(&srq->refcount);\r\nspin_unlock(&table->lock);\r\nreturn srq;\r\n}\r\nint mlx5_core_create_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_create_srq_mbox_in *in, int inlen)\r\n{\r\nstruct mlx5_create_srq_mbox_out out;\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_destroy_srq_mbox_in din;\r\nstruct mlx5_destroy_srq_mbox_out dout;\r\nint err;\r\nmemset(&out, 0, sizeof(out));\r\nin->hdr.opcode = cpu_to_be16(MLX5_CMD_OP_CREATE_SRQ);\r\nerr = mlx5_cmd_exec(dev, in, inlen, &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nif (out.hdr.status)\r\nreturn mlx5_cmd_status_to_err(&out.hdr);\r\nsrq->srqn = be32_to_cpu(out.srqn) & 0xffffff;\r\natomic_set(&srq->refcount, 1);\r\ninit_completion(&srq->free);\r\nspin_lock_irq(&table->lock);\r\nerr = radix_tree_insert(&table->tree, srq->srqn, srq);\r\nspin_unlock_irq(&table->lock);\r\nif (err) {\r\nmlx5_core_warn(dev, "err %d, srqn 0x%x\n", err, srq->srqn);\r\ngoto err_cmd;\r\n}\r\nreturn 0;\r\nerr_cmd:\r\nmemset(&din, 0, sizeof(din));\r\nmemset(&dout, 0, sizeof(dout));\r\ndin.srqn = cpu_to_be32(srq->srqn);\r\ndin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DESTROY_SRQ);\r\nmlx5_cmd_exec(dev, &din, sizeof(din), &dout, sizeof(dout));\r\nreturn err;\r\n}\r\nint mlx5_core_destroy_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq)\r\n{\r\nstruct mlx5_destroy_srq_mbox_in in;\r\nstruct mlx5_destroy_srq_mbox_out out;\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nstruct mlx5_core_srq *tmp;\r\nint err;\r\nspin_lock_irq(&table->lock);\r\ntmp = radix_tree_delete(&table->tree, srq->srqn);\r\nspin_unlock_irq(&table->lock);\r\nif (!tmp) {\r\nmlx5_core_warn(dev, "srq 0x%x not found in tree\n", srq->srqn);\r\nreturn -EINVAL;\r\n}\r\nif (tmp != srq) {\r\nmlx5_core_warn(dev, "corruption on srqn 0x%x\n", srq->srqn);\r\nreturn -EINVAL;\r\n}\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_DESTROY_SRQ);\r\nin.srqn = cpu_to_be32(srq->srqn);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nif (out.hdr.status)\r\nreturn mlx5_cmd_status_to_err(&out.hdr);\r\nif (atomic_dec_and_test(&srq->refcount))\r\ncomplete(&srq->free);\r\nwait_for_completion(&srq->free);\r\nreturn 0;\r\n}\r\nint mlx5_core_query_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nstruct mlx5_query_srq_mbox_out *out)\r\n{\r\nstruct mlx5_query_srq_mbox_in in;\r\nint err;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(out, 0, sizeof(*out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_QUERY_SRQ);\r\nin.srqn = cpu_to_be32(srq->srqn);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), out, sizeof(*out));\r\nif (err)\r\nreturn err;\r\nif (out->hdr.status)\r\nreturn mlx5_cmd_status_to_err(&out->hdr);\r\nreturn err;\r\n}\r\nint mlx5_core_arm_srq(struct mlx5_core_dev *dev, struct mlx5_core_srq *srq,\r\nu16 lwm, int is_srq)\r\n{\r\nstruct mlx5_arm_srq_mbox_in in;\r\nstruct mlx5_arm_srq_mbox_out out;\r\nint err;\r\nmemset(&in, 0, sizeof(in));\r\nmemset(&out, 0, sizeof(out));\r\nin.hdr.opcode = cpu_to_be16(MLX5_CMD_OP_ARM_RQ);\r\nin.hdr.opmod = cpu_to_be16(!!is_srq);\r\nin.srqn = cpu_to_be32(srq->srqn);\r\nin.lwm = cpu_to_be16(lwm);\r\nerr = mlx5_cmd_exec(dev, &in, sizeof(in), &out, sizeof(out));\r\nif (err)\r\nreturn err;\r\nif (out.hdr.status)\r\nreturn mlx5_cmd_status_to_err(&out.hdr);\r\nreturn err;\r\n}\r\nvoid mlx5_init_srq_table(struct mlx5_core_dev *dev)\r\n{\r\nstruct mlx5_srq_table *table = &dev->priv.srq_table;\r\nspin_lock_init(&table->lock);\r\nINIT_RADIX_TREE(&table->tree, GFP_ATOMIC);\r\n}\r\nvoid mlx5_cleanup_srq_table(struct mlx5_core_dev *dev)\r\n{\r\n}

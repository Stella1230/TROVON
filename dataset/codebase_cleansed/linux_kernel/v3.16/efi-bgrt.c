void __init efi_bgrt_init(void)\r\n{\r\nacpi_status status;\r\nvoid __iomem *image;\r\nbool ioremapped = false;\r\nstruct bmp_header bmp_header;\r\nif (acpi_disabled)\r\nreturn;\r\nstatus = acpi_get_table("BGRT", 0,\r\n(struct acpi_table_header **)&bgrt_tab);\r\nif (ACPI_FAILURE(status))\r\nreturn;\r\nif (bgrt_tab->header.length < sizeof(*bgrt_tab))\r\nreturn;\r\nif (bgrt_tab->version != 1 || bgrt_tab->status != 1)\r\nreturn;\r\nif (bgrt_tab->image_type != 0 || !bgrt_tab->image_address)\r\nreturn;\r\nimage = efi_lookup_mapped_addr(bgrt_tab->image_address);\r\nif (!image) {\r\nimage = early_memremap(bgrt_tab->image_address,\r\nsizeof(bmp_header));\r\nioremapped = true;\r\nif (!image)\r\nreturn;\r\n}\r\nmemcpy_fromio(&bmp_header, image, sizeof(bmp_header));\r\nif (ioremapped)\r\nearly_iounmap(image, sizeof(bmp_header));\r\nbgrt_image_size = bmp_header.size;\r\nbgrt_image = kmalloc(bgrt_image_size, GFP_KERNEL);\r\nif (!bgrt_image)\r\nreturn;\r\nif (ioremapped) {\r\nimage = early_memremap(bgrt_tab->image_address,\r\nbmp_header.size);\r\nif (!image) {\r\nkfree(bgrt_image);\r\nbgrt_image = NULL;\r\nreturn;\r\n}\r\n}\r\nmemcpy_fromio(bgrt_image, image, bgrt_image_size);\r\nif (ioremapped)\r\nearly_iounmap(image, bmp_header.size);\r\n}

static unsigned int classify(const struct sk_buff *skb)\r\n{\r\nif (likely(skb->dev && skb->dev->phydev &&\r\nskb->dev->phydev->drv))\r\nreturn ptp_classify_raw(skb);\r\nelse\r\nreturn PTP_CLASS_NONE;\r\n}\r\nvoid skb_clone_tx_timestamp(struct sk_buff *skb)\r\n{\r\nstruct phy_device *phydev;\r\nstruct sk_buff *clone;\r\nstruct sock *sk = skb->sk;\r\nunsigned int type;\r\nif (!sk)\r\nreturn;\r\ntype = classify(skb);\r\nswitch (type) {\r\ncase PTP_CLASS_V1_IPV4:\r\ncase PTP_CLASS_V1_IPV6:\r\ncase PTP_CLASS_V2_IPV4:\r\ncase PTP_CLASS_V2_IPV6:\r\ncase PTP_CLASS_V2_L2:\r\ncase PTP_CLASS_V2_VLAN:\r\nphydev = skb->dev->phydev;\r\nif (likely(phydev->drv->txtstamp)) {\r\nif (!atomic_inc_not_zero(&sk->sk_refcnt))\r\nreturn;\r\nclone = skb_clone(skb, GFP_ATOMIC);\r\nif (!clone) {\r\nsock_put(sk);\r\nreturn;\r\n}\r\nclone->sk = sk;\r\nphydev->drv->txtstamp(phydev, clone, type);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid skb_complete_tx_timestamp(struct sk_buff *skb,\r\nstruct skb_shared_hwtstamps *hwtstamps)\r\n{\r\nstruct sock *sk = skb->sk;\r\nstruct sock_exterr_skb *serr;\r\nint err;\r\nif (!hwtstamps) {\r\nsock_put(sk);\r\nkfree_skb(skb);\r\nreturn;\r\n}\r\n*skb_hwtstamps(skb) = *hwtstamps;\r\nserr = SKB_EXT_ERR(skb);\r\nmemset(serr, 0, sizeof(*serr));\r\nserr->ee.ee_errno = ENOMSG;\r\nserr->ee.ee_origin = SO_EE_ORIGIN_TIMESTAMPING;\r\nskb->sk = NULL;\r\nerr = sock_queue_err_skb(sk, skb);\r\nsock_put(sk);\r\nif (err)\r\nkfree_skb(skb);\r\n}\r\nbool skb_defer_rx_timestamp(struct sk_buff *skb)\r\n{\r\nstruct phy_device *phydev;\r\nunsigned int type;\r\nif (skb_headroom(skb) < ETH_HLEN)\r\nreturn false;\r\n__skb_push(skb, ETH_HLEN);\r\ntype = classify(skb);\r\n__skb_pull(skb, ETH_HLEN);\r\nswitch (type) {\r\ncase PTP_CLASS_V1_IPV4:\r\ncase PTP_CLASS_V1_IPV6:\r\ncase PTP_CLASS_V2_IPV4:\r\ncase PTP_CLASS_V2_IPV6:\r\ncase PTP_CLASS_V2_L2:\r\ncase PTP_CLASS_V2_VLAN:\r\nphydev = skb->dev->phydev;\r\nif (likely(phydev->drv->rxtstamp))\r\nreturn phydev->drv->rxtstamp(phydev, skb, type);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn false;\r\n}

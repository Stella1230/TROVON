static void cs5535_set_speed(ide_drive_t *drive, const u8 speed)\r\n{\r\nu32 reg = 0, dummy;\r\nu8 unit = drive->dn & 1;\r\nif (speed < XFER_SW_DMA_0) {\r\nide_drive_t *pair = ide_get_pair_dev(drive);\r\nu8 cmd, pioa;\r\ncmd = pioa = speed - XFER_PIO_0;\r\nif (pair) {\r\nu8 piob = pair->pio_mode - XFER_PIO_0;\r\nif (piob < cmd)\r\ncmd = piob;\r\n}\r\nreg = (cs5535_pio_cmd_timings[cmd] << 16) |\r\ncs5535_pio_dta_timings[pioa];\r\nwrmsr(unit ? ATAC_CH0D1_PIO : ATAC_CH0D0_PIO, reg, 0);\r\nrdmsr(unit ? ATAC_CH0D0_PIO : ATAC_CH0D1_PIO, reg, dummy);\r\nif (((reg >> 16) & cs5535_pio_cmd_timings[cmd]) !=\r\ncs5535_pio_cmd_timings[cmd]) {\r\nreg &= 0x0000FFFF;\r\nreg |= cs5535_pio_cmd_timings[cmd] << 16;\r\nwrmsr(unit ? ATAC_CH0D0_PIO : ATAC_CH0D1_PIO, reg, 0);\r\n}\r\nrdmsr(unit ? ATAC_CH0D1_DMA : ATAC_CH0D0_DMA, reg, dummy);\r\nwrmsr(unit ? ATAC_CH0D1_DMA : ATAC_CH0D0_DMA,\r\nreg | 0x80000000UL, 0);\r\n} else {\r\nrdmsr(unit ? ATAC_CH0D1_DMA : ATAC_CH0D0_DMA, reg, dummy);\r\nreg &= 0x80000000UL;\r\nif (speed >= XFER_UDMA_0 && speed <= XFER_UDMA_4)\r\nreg |= cs5535_udma_timings[speed - XFER_UDMA_0];\r\nelse if (speed >= XFER_MW_DMA_0 && speed <= XFER_MW_DMA_2)\r\nreg |= cs5535_mwdma_timings[speed - XFER_MW_DMA_0];\r\nelse\r\nreturn;\r\nwrmsr(unit ? ATAC_CH0D1_DMA : ATAC_CH0D0_DMA, reg, 0);\r\n}\r\n}\r\nstatic void cs5535_set_dma_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ncs5535_set_speed(drive, drive->dma_mode);\r\n}\r\nstatic void cs5535_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\ncs5535_set_speed(drive, drive->pio_mode);\r\n}\r\nstatic u8 cs5535_cable_detect(ide_hwif_t *hwif)\r\n{\r\nstruct pci_dev *dev = to_pci_dev(hwif->dev);\r\nu8 bit;\r\npci_read_config_byte(dev, CS5535_CABLE_DETECT, &bit);\r\nreturn (bit & 1) ? ATA_CBL_PATA80 : ATA_CBL_PATA40;\r\n}\r\nstatic int cs5535_init_one(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nreturn ide_pci_init_one(dev, &cs5535_chipset, NULL);\r\n}\r\nstatic int __init cs5535_ide_init(void)\r\n{\r\nreturn ide_pci_register_driver(&cs5535_pci_driver);\r\n}\r\nstatic void __exit cs5535_ide_exit(void)\r\n{\r\npci_unregister_driver(&cs5535_pci_driver);\r\n}

static struct omap_dss_device *to_dss_device_sysfs(struct device *dev)\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nfor_each_dss_dev(dssdev) {\r\nif (dssdev->dev == dev) {\r\nomap_dss_put_device(dssdev);\r\nreturn dssdev;\r\n}\r\n}\r\nreturn NULL;\r\n}\r\nstatic ssize_t display_name_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%s\n",\r\ndssdev->name ?\r\ndssdev->name : "");\r\n}\r\nstatic ssize_t display_enabled_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\nomapdss_device_is_enabled(dssdev));\r\n}\r\nstatic ssize_t display_enabled_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nint r;\r\nbool enable;\r\nr = strtobool(buf, &enable);\r\nif (r)\r\nreturn r;\r\nif (enable == omapdss_device_is_enabled(dssdev))\r\nreturn size;\r\nif (omapdss_device_is_connected(dssdev) == false)\r\nreturn -ENODEV;\r\nif (enable) {\r\nr = dssdev->driver->enable(dssdev);\r\nif (r)\r\nreturn r;\r\n} else {\r\ndssdev->driver->disable(dssdev);\r\n}\r\nreturn size;\r\n}\r\nstatic ssize_t display_tear_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nreturn snprintf(buf, PAGE_SIZE, "%d\n",\r\ndssdev->driver->get_te ?\r\ndssdev->driver->get_te(dssdev) : 0);\r\n}\r\nstatic ssize_t display_tear_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nint r;\r\nbool te;\r\nif (!dssdev->driver->enable_te || !dssdev->driver->get_te)\r\nreturn -ENOENT;\r\nr = strtobool(buf, &te);\r\nif (r)\r\nreturn r;\r\nr = dssdev->driver->enable_te(dssdev, te);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t display_timings_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nstruct omap_video_timings t;\r\nif (!dssdev->driver->get_timings)\r\nreturn -ENOENT;\r\ndssdev->driver->get_timings(dssdev, &t);\r\nreturn snprintf(buf, PAGE_SIZE, "%u,%u/%u/%u/%u,%u/%u/%u/%u\n",\r\nt.pixelclock,\r\nt.x_res, t.hfp, t.hbp, t.hsw,\r\nt.y_res, t.vfp, t.vbp, t.vsw);\r\n}\r\nstatic ssize_t display_timings_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nstruct omap_video_timings t = dssdev->panel.timings;\r\nint r, found;\r\nif (!dssdev->driver->set_timings || !dssdev->driver->check_timings)\r\nreturn -ENOENT;\r\nfound = 0;\r\n#ifdef CONFIG_OMAP2_DSS_VENC\r\nif (strncmp("pal", buf, 3) == 0) {\r\nt = omap_dss_pal_timings;\r\nfound = 1;\r\n} else if (strncmp("ntsc", buf, 4) == 0) {\r\nt = omap_dss_ntsc_timings;\r\nfound = 1;\r\n}\r\n#endif\r\nif (!found && sscanf(buf, "%u,%hu/%hu/%hu/%hu,%hu/%hu/%hu/%hu",\r\n&t.pixelclock,\r\n&t.x_res, &t.hfp, &t.hbp, &t.hsw,\r\n&t.y_res, &t.vfp, &t.vbp, &t.vsw) != 9)\r\nreturn -EINVAL;\r\nr = dssdev->driver->check_timings(dssdev, &t);\r\nif (r)\r\nreturn r;\r\ndssdev->driver->disable(dssdev);\r\ndssdev->driver->set_timings(dssdev, &t);\r\nr = dssdev->driver->enable(dssdev);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t display_rotate_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nint rotate;\r\nif (!dssdev->driver->get_rotate)\r\nreturn -ENOENT;\r\nrotate = dssdev->driver->get_rotate(dssdev);\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", rotate);\r\n}\r\nstatic ssize_t display_rotate_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nint rot, r;\r\nif (!dssdev->driver->set_rotate || !dssdev->driver->get_rotate)\r\nreturn -ENOENT;\r\nr = kstrtoint(buf, 0, &rot);\r\nif (r)\r\nreturn r;\r\nr = dssdev->driver->set_rotate(dssdev, rot);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t display_mirror_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nint mirror;\r\nif (!dssdev->driver->get_mirror)\r\nreturn -ENOENT;\r\nmirror = dssdev->driver->get_mirror(dssdev);\r\nreturn snprintf(buf, PAGE_SIZE, "%u\n", mirror);\r\n}\r\nstatic ssize_t display_mirror_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nint r;\r\nbool mirror;\r\nif (!dssdev->driver->set_mirror || !dssdev->driver->get_mirror)\r\nreturn -ENOENT;\r\nr = strtobool(buf, &mirror);\r\nif (r)\r\nreturn r;\r\nr = dssdev->driver->set_mirror(dssdev, mirror);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nstatic ssize_t display_wss_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nunsigned int wss;\r\nif (!dssdev->driver->get_wss)\r\nreturn -ENOENT;\r\nwss = dssdev->driver->get_wss(dssdev);\r\nreturn snprintf(buf, PAGE_SIZE, "0x%05x\n", wss);\r\n}\r\nstatic ssize_t display_wss_store(struct device *dev,\r\nstruct device_attribute *attr, const char *buf, size_t size)\r\n{\r\nstruct omap_dss_device *dssdev = to_dss_device_sysfs(dev);\r\nu32 wss;\r\nint r;\r\nif (!dssdev->driver->get_wss || !dssdev->driver->set_wss)\r\nreturn -ENOENT;\r\nr = kstrtou32(buf, 0, &wss);\r\nif (r)\r\nreturn r;\r\nif (wss > 0xfffff)\r\nreturn -EINVAL;\r\nr = dssdev->driver->set_wss(dssdev, wss);\r\nif (r)\r\nreturn r;\r\nreturn size;\r\n}\r\nint display_init_sysfs(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nint r;\r\nfor_each_dss_dev(dssdev) {\r\nstruct kobject *kobj = &dssdev->dev->kobj;\r\nr = sysfs_create_files(kobj, display_sysfs_attrs);\r\nif (r) {\r\nDSSERR("failed to create sysfs files\n");\r\ngoto err;\r\n}\r\nr = sysfs_create_link(&pdev->dev.kobj, kobj, dssdev->alias);\r\nif (r) {\r\nsysfs_remove_files(kobj, display_sysfs_attrs);\r\nDSSERR("failed to create sysfs display link\n");\r\ngoto err;\r\n}\r\n}\r\nreturn 0;\r\nerr:\r\ndisplay_uninit_sysfs(pdev);\r\nreturn r;\r\n}\r\nvoid display_uninit_sysfs(struct platform_device *pdev)\r\n{\r\nstruct omap_dss_device *dssdev = NULL;\r\nfor_each_dss_dev(dssdev) {\r\nsysfs_remove_link(&pdev->dev.kobj, dssdev->alias);\r\nsysfs_remove_files(&dssdev->dev->kobj,\r\ndisplay_sysfs_attrs);\r\n}\r\n}

const char *get_system_type(void)\r\n{\r\nreturn "GPR";\r\n}\r\nvoid __init prom_init(void)\r\n{\r\nunsigned char *memsize_str;\r\nunsigned long memsize;\r\nprom_argc = fw_arg0;\r\nprom_argv = (char **)fw_arg1;\r\nprom_envp = (char **)fw_arg2;\r\nprom_init_cmdline();\r\nmemsize_str = prom_getenv("memsize");\r\nif (!memsize_str || kstrtoul(memsize_str, 0, &memsize))\r\nmemsize = 0x04000000;\r\nadd_memory_region(0, memsize, BOOT_MEM_RAM);\r\n}\r\nvoid prom_putchar(unsigned char c)\r\n{\r\nalchemy_uart_putchar(AU1000_UART0_PHYS_ADDR, c);\r\n}\r\nstatic void gpr_reset(char *c)\r\n{\r\nalchemy_gpio_direction_output(4, 0);\r\nalchemy_gpio_direction_output(5, 0);\r\nprintk(KERN_EMERG "Triggering watchdog soft reset...\n");\r\nraw_local_irq_disable();\r\nalchemy_gpio_direction_output(1, 0);\r\nudelay(1);\r\nalchemy_gpio_set_value(1, 1);\r\nwhile (1)\r\ncpu_wait();\r\n}\r\nstatic void gpr_power_off(void)\r\n{\r\nwhile (1)\r\ncpu_wait();\r\n}\r\nvoid __init board_setup(void)\r\n{\r\nprintk(KERN_INFO "Trapeze ITS GPR board\n");\r\npm_power_off = gpr_power_off;\r\n_machine_halt = gpr_power_off;\r\n_machine_restart = gpr_reset;\r\nalchemy_uart_enable(AU1000_UART3_PHYS_ADDR);\r\nalchemy_uart_enable(AU1000_UART1_PHYS_ADDR);\r\nalchemy_gpio_direction_output(215, 1);\r\n}\r\nstatic int gpr_map_pci_irq(const struct pci_dev *d, u8 slot, u8 pin)\r\n{\r\nif ((slot == 0) && (pin == 1))\r\nreturn AU1550_PCI_INTA;\r\nelse if ((slot == 0) && (pin == 2))\r\nreturn AU1550_PCI_INTB;\r\nreturn 0xff;\r\n}\r\nstatic int __init gpr_pci_init(void)\r\n{\r\nreturn platform_device_register(&gpr_pci_host_dev);\r\n}\r\nstatic int __init gpr_dev_init(void)\r\n{\r\ni2c_register_board_info(0, gpr_i2c_info, ARRAY_SIZE(gpr_i2c_info));\r\nreturn platform_add_devices(gpr_devices, ARRAY_SIZE(gpr_devices));\r\n}

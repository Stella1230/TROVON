static void mio_cs_win_out(struct comedi_device *dev, uint16_t data, int addr)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nunsigned long flags;\r\nspin_lock_irqsave(&devpriv->window_lock, flags);\r\nif (addr < 8) {\r\nni_writew(data, addr * 2);\r\n} else {\r\nni_writew(addr, Window_Address);\r\nni_writew(data, Window_Data);\r\n}\r\nspin_unlock_irqrestore(&devpriv->window_lock, flags);\r\n}\r\nstatic uint16_t mio_cs_win_in(struct comedi_device *dev, int addr)\r\n{\r\nstruct ni_private *devpriv = dev->private;\r\nunsigned long flags;\r\nuint16_t ret;\r\nspin_lock_irqsave(&devpriv->window_lock, flags);\r\nif (addr < 8) {\r\nret = ni_readw(addr * 2);\r\n} else {\r\nni_writew(addr, Window_Address);\r\nret = ni_readw(Window_Data);\r\n}\r\nspin_unlock_irqrestore(&devpriv->window_lock, flags);\r\nreturn ret;\r\n}\r\nstatic const void *ni_getboardtype(struct comedi_device *dev,\r\nstruct pcmcia_device *link)\r\n{\r\nstatic const struct ni_board_struct *board;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(ni_boards); i++) {\r\nboard = &ni_boards[i];\r\nif (board->device_id == link->card_id)\r\nreturn board;\r\n}\r\nreturn NULL;\r\n}\r\nstatic int mio_pcmcia_config_loop(struct pcmcia_device *p_dev, void *priv_data)\r\n{\r\nint base, ret;\r\np_dev->resource[0]->flags &= ~IO_DATA_PATH_WIDTH;\r\np_dev->resource[0]->flags |= IO_DATA_PATH_WIDTH_16;\r\nfor (base = 0x000; base < 0x400; base += 0x20) {\r\np_dev->resource[0]->start = base;\r\nret = pcmcia_request_io(p_dev);\r\nif (!ret)\r\nreturn 0;\r\n}\r\nreturn -ENODEV;\r\n}\r\nstatic int mio_cs_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pcmcia_device *link = comedi_to_pcmcia_dev(dev);\r\nstatic const struct ni_board_struct *board;\r\nstruct ni_private *devpriv;\r\nint ret;\r\nboard = ni_getboardtype(dev, link);\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\nlink->config_flags |= CONF_AUTO_SET_IO | CONF_ENABLE_IRQ;\r\nret = comedi_pcmcia_enable(dev, mio_pcmcia_config_loop);\r\nif (ret)\r\nreturn ret;\r\ndev->iobase = link->resource[0]->start;\r\nlink->priv = dev;\r\nret = pcmcia_request_irq(link, ni_E_interrupt);\r\nif (ret)\r\nreturn ret;\r\ndev->irq = link->irq;\r\nret = ni_alloc_private(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = dev->private;\r\ndevpriv->stc_writew = mio_cs_win_out;\r\ndevpriv->stc_readw = mio_cs_win_in;\r\ndevpriv->stc_writel = win_out2;\r\ndevpriv->stc_readl = win_in2;\r\nreturn ni_E_init(dev);\r\n}\r\nstatic void mio_cs_detach(struct comedi_device *dev)\r\n{\r\nmio_common_detach(dev);\r\ncomedi_pcmcia_disable(dev);\r\n}\r\nstatic int cs_attach(struct pcmcia_device *link)\r\n{\r\nreturn comedi_pcmcia_auto_config(link, &driver_ni_mio_cs);\r\n}

void\r\ncfs_percpt_free(void *vars)\r\n{\r\nstruct cfs_var_array *arr;\r\nint i;\r\narr = container_of(vars, struct cfs_var_array, va_ptrs[0]);\r\nfor (i = 0; i < arr->va_count; i++) {\r\nif (arr->va_ptrs[i] != NULL)\r\nLIBCFS_FREE(arr->va_ptrs[i], arr->va_size);\r\n}\r\nLIBCFS_FREE(arr, offsetof(struct cfs_var_array,\r\nva_ptrs[arr->va_count]));\r\n}\r\nvoid *\r\ncfs_percpt_alloc(struct cfs_cpt_table *cptab, unsigned int size)\r\n{\r\nstruct cfs_var_array *arr;\r\nint count;\r\nint i;\r\ncount = cfs_cpt_number(cptab);\r\nLIBCFS_ALLOC(arr, offsetof(struct cfs_var_array, va_ptrs[count]));\r\nif (arr == NULL)\r\nreturn NULL;\r\narr->va_size = size = L1_CACHE_ALIGN(size);\r\narr->va_count = count;\r\narr->va_cptab = cptab;\r\nfor (i = 0; i < count; i++) {\r\nLIBCFS_CPT_ALLOC(arr->va_ptrs[i], cptab, i, size);\r\nif (arr->va_ptrs[i] == NULL) {\r\ncfs_percpt_free((void *)&arr->va_ptrs[0]);\r\nreturn NULL;\r\n}\r\n}\r\nreturn (void *)&arr->va_ptrs[0];\r\n}\r\nint\r\ncfs_percpt_number(void *vars)\r\n{\r\nstruct cfs_var_array *arr;\r\narr = container_of(vars, struct cfs_var_array, va_ptrs[0]);\r\nreturn arr->va_count;\r\n}\r\nvoid *\r\ncfs_percpt_current(void *vars)\r\n{\r\nstruct cfs_var_array *arr;\r\nint cpt;\r\narr = container_of(vars, struct cfs_var_array, va_ptrs[0]);\r\ncpt = cfs_cpt_current(arr->va_cptab, 0);\r\nif (cpt < 0)\r\nreturn NULL;\r\nreturn arr->va_ptrs[cpt];\r\n}\r\nvoid *\r\ncfs_percpt_index(void *vars, int idx)\r\n{\r\nstruct cfs_var_array *arr;\r\narr = container_of(vars, struct cfs_var_array, va_ptrs[0]);\r\nLASSERT(idx >= 0 && idx < arr->va_count);\r\nreturn arr->va_ptrs[idx];\r\n}\r\nvoid\r\ncfs_array_free(void *vars)\r\n{\r\nstruct cfs_var_array *arr;\r\nint i;\r\narr = container_of(vars, struct cfs_var_array, va_ptrs[0]);\r\nfor (i = 0; i < arr->va_count; i++) {\r\nif (arr->va_ptrs[i] == NULL)\r\ncontinue;\r\nLIBCFS_FREE(arr->va_ptrs[i], arr->va_size);\r\n}\r\nLIBCFS_FREE(arr, offsetof(struct cfs_var_array,\r\nva_ptrs[arr->va_count]));\r\n}\r\nvoid *\r\ncfs_array_alloc(int count, unsigned int size)\r\n{\r\nstruct cfs_var_array *arr;\r\nint i;\r\nLIBCFS_ALLOC(arr, offsetof(struct cfs_var_array, va_ptrs[count]));\r\nif (arr == NULL)\r\nreturn NULL;\r\narr->va_count = count;\r\narr->va_size = size;\r\nfor (i = 0; i < count; i++) {\r\nLIBCFS_ALLOC(arr->va_ptrs[i], size);\r\nif (arr->va_ptrs[i] == NULL) {\r\ncfs_array_free((void *)&arr->va_ptrs[0]);\r\nreturn NULL;\r\n}\r\n}\r\nreturn (void *)&arr->va_ptrs[0];\r\n}

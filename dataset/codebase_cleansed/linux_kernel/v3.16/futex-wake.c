static void *workerfn(void *arg __maybe_unused)\r\n{\r\npthread_mutex_lock(&thread_lock);\r\nthreads_starting--;\r\nif (!threads_starting)\r\npthread_cond_signal(&thread_parent);\r\npthread_cond_wait(&thread_worker, &thread_lock);\r\npthread_mutex_unlock(&thread_lock);\r\nfutex_wait(&futex1, 0, NULL, FUTEX_PRIVATE_FLAG);\r\nreturn NULL;\r\n}\r\nstatic void print_summary(void)\r\n{\r\ndouble waketime_avg = avg_stats(&waketime_stats);\r\ndouble waketime_stddev = stddev_stats(&waketime_stats);\r\nunsigned int wakeup_avg = avg_stats(&wakeup_stats);\r\nprintf("Wokeup %d of %d threads in %.4f ms (+-%.2f%%)\n",\r\nwakeup_avg,\r\nnthreads,\r\nwaketime_avg/1e3,\r\nrel_stddev_stats(waketime_stddev, waketime_avg));\r\n}\r\nstatic void block_threads(pthread_t *w,\r\npthread_attr_t thread_attr)\r\n{\r\ncpu_set_t cpu;\r\nunsigned int i;\r\nthreads_starting = nthreads;\r\nfor (i = 0; i < nthreads; i++) {\r\nCPU_ZERO(&cpu);\r\nCPU_SET(i % ncpus, &cpu);\r\nif (pthread_attr_setaffinity_np(&thread_attr, sizeof(cpu_set_t), &cpu))\r\nerr(EXIT_FAILURE, "pthread_attr_setaffinity_np");\r\nif (pthread_create(&w[i], &thread_attr, workerfn, NULL))\r\nerr(EXIT_FAILURE, "pthread_create");\r\n}\r\n}\r\nstatic void toggle_done(int sig __maybe_unused,\r\nsiginfo_t *info __maybe_unused,\r\nvoid *uc __maybe_unused)\r\n{\r\ndone = true;\r\n}\r\nint bench_futex_wake(int argc, const char **argv,\r\nconst char *prefix __maybe_unused)\r\n{\r\nint ret = 0;\r\nunsigned int i, j;\r\nstruct sigaction act;\r\npthread_attr_t thread_attr;\r\nargc = parse_options(argc, argv, options, bench_futex_wake_usage, 0);\r\nif (argc) {\r\nusage_with_options(bench_futex_wake_usage, options);\r\nexit(EXIT_FAILURE);\r\n}\r\nncpus = sysconf(_SC_NPROCESSORS_ONLN);\r\nsigfillset(&act.sa_mask);\r\nact.sa_sigaction = toggle_done;\r\nsigaction(SIGINT, &act, NULL);\r\nif (!nthreads)\r\nnthreads = ncpus;\r\nworker = calloc(nthreads, sizeof(*worker));\r\nif (!worker)\r\nerr(EXIT_FAILURE, "calloc");\r\nprintf("Run summary [PID %d]: blocking on %d threads (at futex %p), "\r\n"waking up %d at a time.\n\n",\r\ngetpid(), nthreads, &futex1, nwakes);\r\ninit_stats(&wakeup_stats);\r\ninit_stats(&waketime_stats);\r\npthread_attr_init(&thread_attr);\r\npthread_mutex_init(&thread_lock, NULL);\r\npthread_cond_init(&thread_parent, NULL);\r\npthread_cond_init(&thread_worker, NULL);\r\nfor (j = 0; j < repeat && !done; j++) {\r\nunsigned int nwoken = 0;\r\nstruct timeval start, end, runtime;\r\nblock_threads(worker, thread_attr);\r\npthread_mutex_lock(&thread_lock);\r\nwhile (threads_starting)\r\npthread_cond_wait(&thread_parent, &thread_lock);\r\npthread_cond_broadcast(&thread_worker);\r\npthread_mutex_unlock(&thread_lock);\r\nusleep(100000);\r\ngettimeofday(&start, NULL);\r\nwhile (nwoken != nthreads)\r\nnwoken += futex_wake(&futex1, nwakes, FUTEX_PRIVATE_FLAG);\r\ngettimeofday(&end, NULL);\r\ntimersub(&end, &start, &runtime);\r\nupdate_stats(&wakeup_stats, nwoken);\r\nupdate_stats(&waketime_stats, runtime.tv_usec);\r\nif (!silent) {\r\nprintf("[Run %d]: Wokeup %d of %d threads in %.4f ms\n",\r\nj + 1, nwoken, nthreads, runtime.tv_usec/1e3);\r\n}\r\nfor (i = 0; i < nthreads; i++) {\r\nret = pthread_join(worker[i], NULL);\r\nif (ret)\r\nerr(EXIT_FAILURE, "pthread_join");\r\n}\r\n}\r\npthread_cond_destroy(&thread_parent);\r\npthread_cond_destroy(&thread_worker);\r\npthread_mutex_destroy(&thread_lock);\r\npthread_attr_destroy(&thread_attr);\r\nprint_summary();\r\nfree(worker);\r\nreturn ret;\r\n}

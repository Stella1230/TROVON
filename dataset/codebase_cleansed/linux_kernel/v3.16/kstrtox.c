const char *_parse_integer_fixup_radix(const char *s, unsigned int *base)\r\n{\r\nif (*base == 0) {\r\nif (s[0] == '0') {\r\nif (_tolower(s[1]) == 'x' && isxdigit(s[2]))\r\n*base = 16;\r\nelse\r\n*base = 8;\r\n} else\r\n*base = 10;\r\n}\r\nif (*base == 16 && s[0] == '0' && _tolower(s[1]) == 'x')\r\ns += 2;\r\nreturn s;\r\n}\r\nunsigned int _parse_integer(const char *s, unsigned int base, unsigned long long *p)\r\n{\r\nunsigned long long res;\r\nunsigned int rv;\r\nint overflow;\r\nres = 0;\r\nrv = 0;\r\noverflow = 0;\r\nwhile (*s) {\r\nunsigned int val;\r\nif ('0' <= *s && *s <= '9')\r\nval = *s - '0';\r\nelse if ('a' <= _tolower(*s) && _tolower(*s) <= 'f')\r\nval = _tolower(*s) - 'a' + 10;\r\nelse\r\nbreak;\r\nif (val >= base)\r\nbreak;\r\nif (unlikely(res & (~0ull << 60))) {\r\nif (res > div_u64(ULLONG_MAX - val, base))\r\noverflow = 1;\r\n}\r\nres = res * base + val;\r\nrv++;\r\ns++;\r\n}\r\n*p = res;\r\nif (overflow)\r\nrv |= KSTRTOX_OVERFLOW;\r\nreturn rv;\r\n}\r\nstatic int _kstrtoull(const char *s, unsigned int base, unsigned long long *res)\r\n{\r\nunsigned long long _res;\r\nunsigned int rv;\r\ns = _parse_integer_fixup_radix(s, &base);\r\nrv = _parse_integer(s, base, &_res);\r\nif (rv & KSTRTOX_OVERFLOW)\r\nreturn -ERANGE;\r\nif (rv == 0)\r\nreturn -EINVAL;\r\ns += rv;\r\nif (*s == '\n')\r\ns++;\r\nif (*s)\r\nreturn -EINVAL;\r\n*res = _res;\r\nreturn 0;\r\n}\r\nint kstrtoull(const char *s, unsigned int base, unsigned long long *res)\r\n{\r\nif (s[0] == '+')\r\ns++;\r\nreturn _kstrtoull(s, base, res);\r\n}\r\nint kstrtoll(const char *s, unsigned int base, long long *res)\r\n{\r\nunsigned long long tmp;\r\nint rv;\r\nif (s[0] == '-') {\r\nrv = _kstrtoull(s + 1, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif ((long long)(-tmp) >= 0)\r\nreturn -ERANGE;\r\n*res = -tmp;\r\n} else {\r\nrv = kstrtoull(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif ((long long)tmp < 0)\r\nreturn -ERANGE;\r\n*res = tmp;\r\n}\r\nreturn 0;\r\n}\r\nint _kstrtoul(const char *s, unsigned int base, unsigned long *res)\r\n{\r\nunsigned long long tmp;\r\nint rv;\r\nrv = kstrtoull(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (unsigned long long)(unsigned long)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint _kstrtol(const char *s, unsigned int base, long *res)\r\n{\r\nlong long tmp;\r\nint rv;\r\nrv = kstrtoll(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (long long)(long)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint kstrtouint(const char *s, unsigned int base, unsigned int *res)\r\n{\r\nunsigned long long tmp;\r\nint rv;\r\nrv = kstrtoull(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (unsigned long long)(unsigned int)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint kstrtoint(const char *s, unsigned int base, int *res)\r\n{\r\nlong long tmp;\r\nint rv;\r\nrv = kstrtoll(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (long long)(int)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint kstrtou16(const char *s, unsigned int base, u16 *res)\r\n{\r\nunsigned long long tmp;\r\nint rv;\r\nrv = kstrtoull(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (unsigned long long)(u16)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint kstrtos16(const char *s, unsigned int base, s16 *res)\r\n{\r\nlong long tmp;\r\nint rv;\r\nrv = kstrtoll(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (long long)(s16)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint kstrtou8(const char *s, unsigned int base, u8 *res)\r\n{\r\nunsigned long long tmp;\r\nint rv;\r\nrv = kstrtoull(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (unsigned long long)(u8)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}\r\nint kstrtos8(const char *s, unsigned int base, s8 *res)\r\n{\r\nlong long tmp;\r\nint rv;\r\nrv = kstrtoll(s, base, &tmp);\r\nif (rv < 0)\r\nreturn rv;\r\nif (tmp != (long long)(s8)tmp)\r\nreturn -ERANGE;\r\n*res = tmp;\r\nreturn 0;\r\n}

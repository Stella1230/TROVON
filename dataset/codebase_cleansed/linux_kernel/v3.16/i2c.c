void\r\ni2c_start(void)\r\n{\r\ni2c_dir_out();\r\ni2c_delay(CLOCK_HIGH_TIME/6);\r\ni2c_data(I2C_DATA_HIGH);\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME);\r\ni2c_data(I2C_DATA_LOW);\r\ni2c_delay(START_CONDITION_HOLD_TIME);\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_delay(CLOCK_LOW_TIME);\r\n}\r\nvoid\r\ni2c_stop(void)\r\n{\r\ni2c_dir_out();\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_data(I2C_DATA_LOW);\r\ni2c_delay(CLOCK_LOW_TIME*2);\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME*2);\r\ni2c_data(I2C_DATA_HIGH);\r\ni2c_delay(STOP_CONDITION_HOLD_TIME);\r\ni2c_dir_in();\r\n}\r\nvoid\r\ni2c_outbyte(unsigned char x)\r\n{\r\nint i;\r\ni2c_dir_out();\r\nfor (i = 0; i < 8; i++) {\r\nif (x & 0x80) {\r\ni2c_data(I2C_DATA_HIGH);\r\n} else {\r\ni2c_data(I2C_DATA_LOW);\r\n}\r\ni2c_delay(CLOCK_LOW_TIME/2);\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME);\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_delay(CLOCK_LOW_TIME/2);\r\nx <<= 1;\r\n}\r\ni2c_data(I2C_DATA_LOW);\r\ni2c_delay(CLOCK_LOW_TIME/2);\r\ni2c_dir_in();\r\n}\r\nunsigned char\r\ni2c_inbyte(void)\r\n{\r\nunsigned char aBitByte = 0;\r\nint i;\r\ni2c_disable();\r\ni2c_dir_in();\r\ni2c_delay(CLOCK_HIGH_TIME/2);\r\naBitByte |= i2c_getbit();\r\ni2c_enable();\r\ni2c_delay(CLOCK_LOW_TIME/2);\r\nfor (i = 1; i < 8; i++) {\r\naBitByte <<= 1;\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME);\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_delay(CLOCK_LOW_TIME);\r\ni2c_disable();\r\ni2c_dir_in();\r\ni2c_delay(CLOCK_HIGH_TIME/2);\r\naBitByte |= i2c_getbit();\r\ni2c_enable();\r\ni2c_delay(CLOCK_LOW_TIME/2);\r\n}\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME);\r\ni2c_clk(I2C_CLOCK_LOW);\r\nreturn aBitByte;\r\n}\r\nint\r\ni2c_getack(void)\r\n{\r\nint ack = 1;\r\ni2c_dir_out();\r\ni2c_data(I2C_DATA_HIGH);\r\ni2c_dir_in();\r\ni2c_delay(CLOCK_HIGH_TIME/4);\r\ni2c_clk(I2C_CLOCK_HIGH);\r\n#if 0\r\ni2c_clk(1);\r\ni2c_data(1);\r\ni2c_data(1);\r\ni2c_disable();\r\ni2c_dir_in();\r\n#endif\r\ni2c_delay(CLOCK_HIGH_TIME/2);\r\nif (i2c_getbit())\r\nack = 0;\r\ni2c_delay(CLOCK_HIGH_TIME/2);\r\nif (!ack) {\r\nif (!i2c_getbit())\r\nack = 1;\r\ni2c_delay(CLOCK_HIGH_TIME/2);\r\n}\r\n#if 0\r\ni2c_data(I2C_DATA_LOW);\r\ni2c_enable();\r\ni2c_dir_out();\r\n#endif\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_delay(CLOCK_HIGH_TIME/4);\r\ni2c_dir_out();\r\ni2c_data(I2C_DATA_HIGH);\r\ni2c_delay(CLOCK_LOW_TIME/2);\r\nreturn ack;\r\n}\r\nvoid\r\ni2c_sendack(void)\r\n{\r\ni2c_delay(CLOCK_LOW_TIME);\r\ni2c_dir_out();\r\ni2c_data(I2C_DATA_LOW);\r\ni2c_delay(CLOCK_HIGH_TIME/6);\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME);\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_delay(CLOCK_LOW_TIME/6);\r\ni2c_data(I2C_DATA_HIGH);\r\ni2c_delay(CLOCK_LOW_TIME);\r\ni2c_dir_in();\r\n}\r\nvoid\r\ni2c_sendnack(void)\r\n{\r\ni2c_delay(CLOCK_LOW_TIME);\r\ni2c_dir_out();\r\ni2c_data(I2C_DATA_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME/6);\r\ni2c_clk(I2C_CLOCK_HIGH);\r\ni2c_delay(CLOCK_HIGH_TIME);\r\ni2c_clk(I2C_CLOCK_LOW);\r\ni2c_delay(CLOCK_LOW_TIME);\r\ni2c_dir_in();\r\n}\r\nint\r\ni2c_write(unsigned char theSlave, void *data, size_t nbytes)\r\n{\r\nint error, cntr = 3;\r\nunsigned char bytes_wrote = 0;\r\nunsigned char value;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c_lock, flags);\r\ndo {\r\nerror = 0;\r\ni2c_start();\r\ni2c_outbyte((theSlave & 0xfe));\r\nif (!i2c_getack())\r\nerror = 1;\r\nfor (bytes_wrote = 0; bytes_wrote < nbytes; bytes_wrote++) {\r\nmemcpy(&value, data + bytes_wrote, sizeof value);\r\ni2c_outbyte(value);\r\nif (!i2c_getack())\r\nerror |= 4;\r\n}\r\ni2c_stop();\r\n} while (error && cntr--);\r\ni2c_delay(CLOCK_LOW_TIME);\r\nspin_unlock_irqrestore(&i2c_lock, flags);\r\nreturn -error;\r\n}\r\nint\r\ni2c_read(unsigned char theSlave, void *data, size_t nbytes)\r\n{\r\nunsigned char b = 0;\r\nunsigned char bytes_read = 0;\r\nint error, cntr = 3;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c_lock, flags);\r\ndo {\r\nerror = 0;\r\nmemset(data, 0, nbytes);\r\ni2c_start();\r\ni2c_outbyte((theSlave | 0x01));\r\nif (!i2c_getack())\r\nerror = 1;\r\nfor (bytes_read = 0; bytes_read < nbytes; bytes_read++) {\r\nb = i2c_inbyte();\r\nmemcpy(data + bytes_read, &b, sizeof b);\r\nif (bytes_read < (nbytes - 1))\r\ni2c_sendack();\r\n}\r\ni2c_sendnack();\r\ni2c_stop();\r\n} while (error && cntr--);\r\nspin_unlock_irqrestore(&i2c_lock, flags);\r\nreturn -error;\r\n}\r\nint\r\ni2c_writereg(unsigned char theSlave, unsigned char theReg,\r\nunsigned char theValue)\r\n{\r\nint error, cntr = 3;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c_lock, flags);\r\ndo {\r\nerror = 0;\r\ni2c_start();\r\ni2c_outbyte((theSlave & 0xfe));\r\nif(!i2c_getack())\r\nerror = 1;\r\ni2c_dir_out();\r\ni2c_outbyte(theReg);\r\nif(!i2c_getack())\r\nerror |= 2;\r\ni2c_outbyte(theValue);\r\nif(!i2c_getack())\r\nerror |= 4;\r\ni2c_stop();\r\n} while(error && cntr--);\r\ni2c_delay(CLOCK_LOW_TIME);\r\nspin_unlock_irqrestore(&i2c_lock, flags);\r\nreturn -error;\r\n}\r\nunsigned char\r\ni2c_readreg(unsigned char theSlave, unsigned char theReg)\r\n{\r\nunsigned char b = 0;\r\nint error, cntr = 3;\r\nunsigned long flags;\r\nspin_lock_irqsave(&i2c_lock, flags);\r\ndo {\r\nerror = 0;\r\ni2c_start();\r\ni2c_outbyte((theSlave & 0xfe));\r\nif(!i2c_getack())\r\nerror = 1;\r\ni2c_dir_out();\r\ni2c_outbyte(theReg);\r\nif(!i2c_getack())\r\nerror |= 2;\r\ni2c_delay(CLOCK_LOW_TIME);\r\ni2c_start();\r\ni2c_outbyte(theSlave | 0x01);\r\nif(!i2c_getack())\r\nerror |= 4;\r\nb = i2c_inbyte();\r\ni2c_sendnack();\r\ni2c_stop();\r\n} while(error && cntr--);\r\nspin_unlock_irqrestore(&i2c_lock, flags);\r\nreturn b;\r\n}\r\nstatic int\r\ni2c_open(struct inode *inode, struct file *filp)\r\n{\r\nreturn 0;\r\n}\r\nstatic int\r\ni2c_release(struct inode *inode, struct file *filp)\r\n{\r\nreturn 0;\r\n}\r\nstatic long\r\ni2c_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nint ret;\r\nif(_IOC_TYPE(cmd) != ETRAXI2C_IOCTYPE) {\r\nreturn -ENOTTY;\r\n}\r\nswitch (_IOC_NR(cmd)) {\r\ncase I2C_WRITEREG:\r\nD(printk("i2cw %d %d %d\n",\r\nI2C_ARGSLAVE(arg),\r\nI2C_ARGREG(arg),\r\nI2C_ARGVALUE(arg)));\r\nmutex_lock(&i2c_mutex);\r\nret = i2c_writereg(I2C_ARGSLAVE(arg),\r\nI2C_ARGREG(arg),\r\nI2C_ARGVALUE(arg));\r\nmutex_unlock(&i2c_mutex);\r\nreturn ret;\r\ncase I2C_READREG:\r\n{\r\nunsigned char val;\r\nD(printk("i2cr %d %d ",\r\nI2C_ARGSLAVE(arg),\r\nI2C_ARGREG(arg)));\r\nmutex_lock(&i2c_mutex);\r\nval = i2c_readreg(I2C_ARGSLAVE(arg), I2C_ARGREG(arg));\r\nmutex_unlock(&i2c_mutex);\r\nD(printk("= %d\n", val));\r\nreturn val;\r\n}\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init i2c_init(void)\r\n{\r\nstatic int res;\r\nstatic int first = 1;\r\nif (!first)\r\nreturn res;\r\nfirst = 0;\r\nres = crisv32_io_get_name(&cris_i2c_data,\r\nCONFIG_ETRAX_V32_I2C_DATA_PORT);\r\nif (res < 0)\r\nreturn res;\r\nres = crisv32_io_get_name(&cris_i2c_clk, CONFIG_ETRAX_V32_I2C_CLK_PORT);\r\ncrisv32_io_set_dir(&cris_i2c_clk, crisv32_io_dir_out);\r\nreturn res;\r\n}\r\nstatic int __init i2c_register(void)\r\n{\r\nint res;\r\nres = i2c_init();\r\nif (res < 0)\r\nreturn res;\r\nres = register_chrdev(I2C_MAJOR, i2c_name, &i2c_fops);\r\nif (res < 0) {\r\nprintk(KERN_ERR "i2c: couldn't get a major number.\n");\r\nreturn res;\r\n}\r\nprintk(KERN_INFO\r\n"I2C driver v2.2, (c) 1999-2007 Axis Communications AB\n");\r\nreturn 0;\r\n}

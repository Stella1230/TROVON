static int setup_freqs_table(struct cpufreq_policy *policy,\r\nstruct pxa3xx_freq_info *freqs, int num)\r\n{\r\nstruct cpufreq_frequency_table *table;\r\nint i;\r\ntable = kzalloc((num + 1) * sizeof(*table), GFP_KERNEL);\r\nif (table == NULL)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < num; i++) {\r\ntable[i].driver_data = i;\r\ntable[i].frequency = freqs[i].cpufreq_mhz * 1000;\r\n}\r\ntable[num].driver_data = i;\r\ntable[num].frequency = CPUFREQ_TABLE_END;\r\npxa3xx_freqs = freqs;\r\npxa3xx_freqs_num = num;\r\npxa3xx_freqs_table = table;\r\nreturn cpufreq_table_validate_and_show(policy, table);\r\n}\r\nstatic void __update_core_freq(struct pxa3xx_freq_info *info)\r\n{\r\nuint32_t mask = ACCR_XN_MASK | ACCR_XL_MASK;\r\nuint32_t accr = ACCR;\r\nuint32_t xclkcfg;\r\naccr &= ~(ACCR_XN_MASK | ACCR_XL_MASK | ACCR_XSPCLK_MASK);\r\naccr |= ACCR_XN(info->core_xn) | ACCR_XL(info->core_xl);\r\naccr |= ACCR_XSPCLK(XSPCLK_NONE);\r\nxclkcfg = (info->core_xn == 2) ? 0x3 : 0x2;\r\nACCR = accr;\r\n__asm__("mcr p14, 0, %0, c6, c0, 0\n" : : "r"(xclkcfg));\r\nwhile ((ACSR & mask) != (accr & mask))\r\ncpu_relax();\r\n}\r\nstatic void __update_bus_freq(struct pxa3xx_freq_info *info)\r\n{\r\nuint32_t mask;\r\nuint32_t accr = ACCR;\r\nmask = ACCR_SMCFS_MASK | ACCR_SFLFS_MASK | ACCR_HSS_MASK |\r\nACCR_DMCFS_MASK;\r\naccr &= ~mask;\r\naccr |= ACCR_SMCFS(info->smcfs) | ACCR_SFLFS(info->sflfs) |\r\nACCR_HSS(info->hss) | ACCR_DMCFS(info->dmcfs);\r\nACCR = accr;\r\nwhile ((ACSR & mask) != (accr & mask))\r\ncpu_relax();\r\n}\r\nstatic unsigned int pxa3xx_cpufreq_get(unsigned int cpu)\r\n{\r\nreturn pxa3xx_get_clk_frequency_khz(0);\r\n}\r\nstatic int pxa3xx_cpufreq_set(struct cpufreq_policy *policy, unsigned int index)\r\n{\r\nstruct pxa3xx_freq_info *next;\r\nunsigned long flags;\r\nif (policy->cpu != 0)\r\nreturn -EINVAL;\r\nnext = &pxa3xx_freqs[index];\r\nlocal_irq_save(flags);\r\n__update_core_freq(next);\r\n__update_bus_freq(next);\r\nlocal_irq_restore(flags);\r\nreturn 0;\r\n}\r\nstatic int pxa3xx_cpufreq_init(struct cpufreq_policy *policy)\r\n{\r\nint ret = -EINVAL;\r\npolicy->min = policy->cpuinfo.min_freq = 104000;\r\npolicy->max = policy->cpuinfo.max_freq =\r\n(cpu_is_pxa320()) ? 806000 : 624000;\r\npolicy->cpuinfo.transition_latency = 1000;\r\nif (cpu_is_pxa300() || cpu_is_pxa310())\r\nret = setup_freqs_table(policy, pxa300_freqs,\r\nARRAY_SIZE(pxa300_freqs));\r\nif (cpu_is_pxa320())\r\nret = setup_freqs_table(policy, pxa320_freqs,\r\nARRAY_SIZE(pxa320_freqs));\r\nif (ret) {\r\npr_err("failed to setup frequency table\n");\r\nreturn ret;\r\n}\r\npr_info("CPUFREQ support for PXA3xx initialized\n");\r\nreturn 0;\r\n}\r\nstatic int __init cpufreq_init(void)\r\n{\r\nif (cpu_is_pxa3xx())\r\nreturn cpufreq_register_driver(&pxa3xx_cpufreq_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit cpufreq_exit(void)\r\n{\r\ncpufreq_unregister_driver(&pxa3xx_cpufreq_driver);\r\n}

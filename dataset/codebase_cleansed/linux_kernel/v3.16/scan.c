static int wl1271_get_scan_channels(struct wl1271 *wl,\r\nstruct cfg80211_scan_request *req,\r\nstruct basic_scan_channel_params *channels,\r\nenum ieee80211_band band, bool passive)\r\n{\r\nstruct conf_scan_settings *c = &wl->conf.scan;\r\nint i, j;\r\nu32 flags;\r\nfor (i = 0, j = 0;\r\ni < req->n_channels && j < WL1271_SCAN_MAX_CHANNELS;\r\ni++) {\r\nflags = req->channels[i]->flags;\r\nif (!test_bit(i, wl->scan.scanned_ch) &&\r\n!(flags & IEEE80211_CHAN_DISABLED) &&\r\n(req->channels[i]->band == band) &&\r\n(passive || !(flags & IEEE80211_CHAN_NO_IR))) {\r\nwl1271_debug(DEBUG_SCAN, "band %d, center_freq %d ",\r\nreq->channels[i]->band,\r\nreq->channels[i]->center_freq);\r\nwl1271_debug(DEBUG_SCAN, "hw_value %d, flags %X",\r\nreq->channels[i]->hw_value,\r\nreq->channels[i]->flags);\r\nwl1271_debug(DEBUG_SCAN,\r\n"max_antenna_gain %d, max_power %d",\r\nreq->channels[i]->max_antenna_gain,\r\nreq->channels[i]->max_power);\r\nwl1271_debug(DEBUG_SCAN, "beacon_found %d",\r\nreq->channels[i]->beacon_found);\r\nif (!passive) {\r\nchannels[j].min_duration =\r\ncpu_to_le32(c->min_dwell_time_active);\r\nchannels[j].max_duration =\r\ncpu_to_le32(c->max_dwell_time_active);\r\n} else {\r\nchannels[j].min_duration =\r\ncpu_to_le32(c->dwell_time_passive);\r\nchannels[j].max_duration =\r\ncpu_to_le32(c->dwell_time_passive);\r\n}\r\nchannels[j].early_termination = 0;\r\nchannels[j].tx_power_att = req->channels[i]->max_power;\r\nchannels[j].channel = req->channels[i]->hw_value;\r\nmemset(&channels[j].bssid_lsb, 0xff, 4);\r\nmemset(&channels[j].bssid_msb, 0xff, 2);\r\nset_bit(i, wl->scan.scanned_ch);\r\nj++;\r\n}\r\n}\r\nreturn j;\r\n}\r\nstatic int wl1271_scan_send(struct wl1271 *wl, struct wl12xx_vif *wlvif,\r\nenum ieee80211_band band,\r\nbool passive, u32 basic_rate)\r\n{\r\nstruct ieee80211_vif *vif = wl12xx_wlvif_to_vif(wlvif);\r\nstruct wl1271_cmd_scan *cmd;\r\nstruct wl1271_cmd_trigger_scan_to *trigger;\r\nint ret;\r\nu16 scan_options = 0;\r\nif (!passive && wl->scan.req->n_ssids == 0)\r\nreturn WL1271_NOTHING_TO_SCAN;\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\ntrigger = kzalloc(sizeof(*trigger), GFP_KERNEL);\r\nif (!cmd || !trigger) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nif (wl->conf.scan.split_scan_timeout)\r\nscan_options |= WL1271_SCAN_OPT_SPLIT_SCAN;\r\nif (passive)\r\nscan_options |= WL1271_SCAN_OPT_PASSIVE;\r\ncmd->params.role_id = wlvif->role_id;\r\nif (WARN_ON(cmd->params.role_id == WL12XX_INVALID_ROLE_ID)) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\ncmd->params.scan_options = cpu_to_le16(scan_options);\r\ncmd->params.n_ch = wl1271_get_scan_channels(wl, wl->scan.req,\r\ncmd->channels,\r\nband, passive);\r\nif (cmd->params.n_ch == 0) {\r\nret = WL1271_NOTHING_TO_SCAN;\r\ngoto out;\r\n}\r\ncmd->params.tx_rate = cpu_to_le32(basic_rate);\r\ncmd->params.n_probe_reqs = wl->conf.scan.num_probe_reqs;\r\ncmd->params.tid_trigger = CONF_TX_AC_ANY_TID;\r\ncmd->params.scan_tag = WL1271_SCAN_DEFAULT_TAG;\r\nif (band == IEEE80211_BAND_2GHZ)\r\ncmd->params.band = WL1271_SCAN_BAND_2_4_GHZ;\r\nelse\r\ncmd->params.band = WL1271_SCAN_BAND_5_GHZ;\r\nif (wl->scan.ssid_len && wl->scan.ssid) {\r\ncmd->params.ssid_len = wl->scan.ssid_len;\r\nmemcpy(cmd->params.ssid, wl->scan.ssid, wl->scan.ssid_len);\r\n}\r\nmemcpy(cmd->addr, vif->addr, ETH_ALEN);\r\nret = wl12xx_cmd_build_probe_req(wl, wlvif,\r\ncmd->params.role_id, band,\r\nwl->scan.ssid, wl->scan.ssid_len,\r\nwl->scan.req->ie,\r\nwl->scan.req->ie_len, false);\r\nif (ret < 0) {\r\nwl1271_error("PROBE request template failed");\r\ngoto out;\r\n}\r\ntrigger->timeout = cpu_to_le32(wl->conf.scan.split_scan_timeout);\r\nret = wl1271_cmd_send(wl, CMD_TRIGGER_SCAN_TO, trigger,\r\nsizeof(*trigger), 0);\r\nif (ret < 0) {\r\nwl1271_error("trigger scan to failed for hw scan");\r\ngoto out;\r\n}\r\nwl1271_dump(DEBUG_SCAN, "SCAN: ", cmd, sizeof(*cmd));\r\nret = wl1271_cmd_send(wl, CMD_SCAN, cmd, sizeof(*cmd), 0);\r\nif (ret < 0) {\r\nwl1271_error("SCAN failed");\r\ngoto out;\r\n}\r\nout:\r\nkfree(cmd);\r\nkfree(trigger);\r\nreturn ret;\r\n}\r\nint wl12xx_scan_stop(struct wl1271 *wl, struct wl12xx_vif *wlvif)\r\n{\r\nstruct wl1271_cmd_header *cmd = NULL;\r\nint ret = 0;\r\nif (WARN_ON(wl->scan.state == WL1271_SCAN_STATE_IDLE))\r\nreturn -EINVAL;\r\nwl1271_debug(DEBUG_CMD, "cmd scan stop");\r\ncmd = kzalloc(sizeof(*cmd), GFP_KERNEL);\r\nif (!cmd) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nret = wl1271_cmd_send(wl, CMD_STOP_SCAN, cmd,\r\nsizeof(*cmd), 0);\r\nif (ret < 0) {\r\nwl1271_error("cmd stop_scan failed");\r\ngoto out;\r\n}\r\nout:\r\nkfree(cmd);\r\nreturn ret;\r\n}\r\nvoid wl1271_scan_stm(struct wl1271 *wl, struct wl12xx_vif *wlvif)\r\n{\r\nint ret = 0;\r\nenum ieee80211_band band;\r\nu32 rate, mask;\r\nswitch (wl->scan.state) {\r\ncase WL1271_SCAN_STATE_IDLE:\r\nbreak;\r\ncase WL1271_SCAN_STATE_2GHZ_ACTIVE:\r\nband = IEEE80211_BAND_2GHZ;\r\nmask = wlvif->bitrate_masks[band];\r\nif (wl->scan.req->no_cck) {\r\nmask &= ~CONF_TX_CCK_RATES;\r\nif (!mask)\r\nmask = CONF_TX_RATE_MASK_BASIC_P2P;\r\n}\r\nrate = wl1271_tx_min_rate_get(wl, mask);\r\nret = wl1271_scan_send(wl, wlvif, band, false, rate);\r\nif (ret == WL1271_NOTHING_TO_SCAN) {\r\nwl->scan.state = WL1271_SCAN_STATE_2GHZ_PASSIVE;\r\nwl1271_scan_stm(wl, wlvif);\r\n}\r\nbreak;\r\ncase WL1271_SCAN_STATE_2GHZ_PASSIVE:\r\nband = IEEE80211_BAND_2GHZ;\r\nmask = wlvif->bitrate_masks[band];\r\nif (wl->scan.req->no_cck) {\r\nmask &= ~CONF_TX_CCK_RATES;\r\nif (!mask)\r\nmask = CONF_TX_RATE_MASK_BASIC_P2P;\r\n}\r\nrate = wl1271_tx_min_rate_get(wl, mask);\r\nret = wl1271_scan_send(wl, wlvif, band, true, rate);\r\nif (ret == WL1271_NOTHING_TO_SCAN) {\r\nif (wl->enable_11a)\r\nwl->scan.state = WL1271_SCAN_STATE_5GHZ_ACTIVE;\r\nelse\r\nwl->scan.state = WL1271_SCAN_STATE_DONE;\r\nwl1271_scan_stm(wl, wlvif);\r\n}\r\nbreak;\r\ncase WL1271_SCAN_STATE_5GHZ_ACTIVE:\r\nband = IEEE80211_BAND_5GHZ;\r\nrate = wl1271_tx_min_rate_get(wl, wlvif->bitrate_masks[band]);\r\nret = wl1271_scan_send(wl, wlvif, band, false, rate);\r\nif (ret == WL1271_NOTHING_TO_SCAN) {\r\nwl->scan.state = WL1271_SCAN_STATE_5GHZ_PASSIVE;\r\nwl1271_scan_stm(wl, wlvif);\r\n}\r\nbreak;\r\ncase WL1271_SCAN_STATE_5GHZ_PASSIVE:\r\nband = IEEE80211_BAND_5GHZ;\r\nrate = wl1271_tx_min_rate_get(wl, wlvif->bitrate_masks[band]);\r\nret = wl1271_scan_send(wl, wlvif, band, true, rate);\r\nif (ret == WL1271_NOTHING_TO_SCAN) {\r\nwl->scan.state = WL1271_SCAN_STATE_DONE;\r\nwl1271_scan_stm(wl, wlvif);\r\n}\r\nbreak;\r\ncase WL1271_SCAN_STATE_DONE:\r\nwl->scan.failed = false;\r\ncancel_delayed_work(&wl->scan_complete_work);\r\nieee80211_queue_delayed_work(wl->hw, &wl->scan_complete_work,\r\nmsecs_to_jiffies(0));\r\nbreak;\r\ndefault:\r\nwl1271_error("invalid scan state");\r\nbreak;\r\n}\r\nif (ret < 0) {\r\ncancel_delayed_work(&wl->scan_complete_work);\r\nieee80211_queue_delayed_work(wl->hw, &wl->scan_complete_work,\r\nmsecs_to_jiffies(0));\r\n}\r\n}\r\nstatic void wl12xx_adjust_channels(struct wl1271_cmd_sched_scan_config *cmd,\r\nstruct wlcore_scan_channels *cmd_channels)\r\n{\r\nmemcpy(cmd->passive, cmd_channels->passive, sizeof(cmd->passive));\r\nmemcpy(cmd->active, cmd_channels->active, sizeof(cmd->active));\r\ncmd->dfs = cmd_channels->dfs;\r\ncmd->n_pactive_ch = cmd_channels->passive_active;\r\nmemcpy(cmd->channels_2, cmd_channels->channels_2,\r\nsizeof(cmd->channels_2));\r\nmemcpy(cmd->channels_5, cmd_channels->channels_5,\r\nsizeof(cmd->channels_5));\r\n}\r\nint wl1271_scan_sched_scan_config(struct wl1271 *wl,\r\nstruct wl12xx_vif *wlvif,\r\nstruct cfg80211_sched_scan_request *req,\r\nstruct ieee80211_sched_scan_ies *ies)\r\n{\r\nstruct wl1271_cmd_sched_scan_config *cfg = NULL;\r\nstruct wlcore_scan_channels *cfg_channels = NULL;\r\nstruct conf_sched_scan_settings *c = &wl->conf.sched_scan;\r\nint i, ret;\r\nbool force_passive = !req->n_ssids;\r\nwl1271_debug(DEBUG_CMD, "cmd sched_scan scan config");\r\ncfg = kzalloc(sizeof(*cfg), GFP_KERNEL);\r\nif (!cfg)\r\nreturn -ENOMEM;\r\ncfg->role_id = wlvif->role_id;\r\ncfg->rssi_threshold = c->rssi_threshold;\r\ncfg->snr_threshold = c->snr_threshold;\r\ncfg->n_probe_reqs = c->num_probe_reqs;\r\ncfg->cycles = 0;\r\ncfg->report_after = 1;\r\ncfg->terminate = 0;\r\ncfg->tag = WL1271_SCAN_DEFAULT_TAG;\r\ncfg->bss_type = SCAN_BSS_TYPE_ANY;\r\nfor (i = 0; i < SCAN_MAX_CYCLE_INTERVALS; i++)\r\ncfg->intervals[i] = cpu_to_le32(req->interval);\r\ncfg->ssid_len = 0;\r\nret = wlcore_scan_sched_scan_ssid_list(wl, wlvif, req);\r\nif (ret < 0)\r\ngoto out;\r\ncfg->filter_type = ret;\r\nwl1271_debug(DEBUG_SCAN, "filter_type = %d", cfg->filter_type);\r\ncfg_channels = kzalloc(sizeof(*cfg_channels), GFP_KERNEL);\r\nif (!cfg_channels) {\r\nret = -ENOMEM;\r\ngoto out;\r\n}\r\nif (!wlcore_set_scan_chan_params(wl, cfg_channels, req->channels,\r\nreq->n_channels, req->n_ssids,\r\nSCAN_TYPE_PERIODIC)) {\r\nwl1271_error("scan channel list is empty");\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nwl12xx_adjust_channels(cfg, cfg_channels);\r\nif (!force_passive && cfg->active[0]) {\r\nu8 band = IEEE80211_BAND_2GHZ;\r\nret = wl12xx_cmd_build_probe_req(wl, wlvif,\r\nwlvif->role_id, band,\r\nreq->ssids[0].ssid,\r\nreq->ssids[0].ssid_len,\r\nies->ie[band],\r\nies->len[band], true);\r\nif (ret < 0) {\r\nwl1271_error("2.4GHz PROBE request template failed");\r\ngoto out;\r\n}\r\n}\r\nif (!force_passive && cfg->active[1]) {\r\nu8 band = IEEE80211_BAND_5GHZ;\r\nret = wl12xx_cmd_build_probe_req(wl, wlvif,\r\nwlvif->role_id, band,\r\nreq->ssids[0].ssid,\r\nreq->ssids[0].ssid_len,\r\nies->ie[band],\r\nies->len[band], true);\r\nif (ret < 0) {\r\nwl1271_error("5GHz PROBE request template failed");\r\ngoto out;\r\n}\r\n}\r\nwl1271_dump(DEBUG_SCAN, "SCAN_CFG: ", cfg, sizeof(*cfg));\r\nret = wl1271_cmd_send(wl, CMD_CONNECTION_SCAN_CFG, cfg,\r\nsizeof(*cfg), 0);\r\nif (ret < 0) {\r\nwl1271_error("SCAN configuration failed");\r\ngoto out;\r\n}\r\nout:\r\nkfree(cfg_channels);\r\nkfree(cfg);\r\nreturn ret;\r\n}\r\nint wl1271_scan_sched_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif)\r\n{\r\nstruct wl1271_cmd_sched_scan_start *start;\r\nint ret = 0;\r\nwl1271_debug(DEBUG_CMD, "cmd periodic scan start");\r\nif (wlvif->bss_type != BSS_TYPE_STA_BSS)\r\nreturn -EOPNOTSUPP;\r\nif ((wl->quirks & WLCORE_QUIRK_NO_SCHED_SCAN_WHILE_CONN) &&\r\ntest_bit(WLVIF_FLAG_IN_USE, &wlvif->flags))\r\nreturn -EBUSY;\r\nstart = kzalloc(sizeof(*start), GFP_KERNEL);\r\nif (!start)\r\nreturn -ENOMEM;\r\nstart->role_id = wlvif->role_id;\r\nstart->tag = WL1271_SCAN_DEFAULT_TAG;\r\nret = wl1271_cmd_send(wl, CMD_START_PERIODIC_SCAN, start,\r\nsizeof(*start), 0);\r\nif (ret < 0) {\r\nwl1271_error("failed to send scan start command");\r\ngoto out_free;\r\n}\r\nout_free:\r\nkfree(start);\r\nreturn ret;\r\n}\r\nint wl12xx_sched_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif,\r\nstruct cfg80211_sched_scan_request *req,\r\nstruct ieee80211_sched_scan_ies *ies)\r\n{\r\nint ret;\r\nret = wl1271_scan_sched_scan_config(wl, wlvif, req, ies);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn wl1271_scan_sched_scan_start(wl, wlvif);\r\n}\r\nvoid wl12xx_scan_sched_scan_stop(struct wl1271 *wl, struct wl12xx_vif *wlvif)\r\n{\r\nstruct wl1271_cmd_sched_scan_stop *stop;\r\nint ret = 0;\r\nwl1271_debug(DEBUG_CMD, "cmd periodic scan stop");\r\nstop = kzalloc(sizeof(*stop), GFP_KERNEL);\r\nif (!stop) {\r\nwl1271_error("failed to alloc memory to send sched scan stop");\r\nreturn;\r\n}\r\nstop->role_id = wlvif->role_id;\r\nstop->tag = WL1271_SCAN_DEFAULT_TAG;\r\nret = wl1271_cmd_send(wl, CMD_STOP_PERIODIC_SCAN, stop,\r\nsizeof(*stop), 0);\r\nif (ret < 0) {\r\nwl1271_error("failed to send sched scan stop command");\r\ngoto out_free;\r\n}\r\nout_free:\r\nkfree(stop);\r\n}\r\nint wl12xx_scan_start(struct wl1271 *wl, struct wl12xx_vif *wlvif,\r\nstruct cfg80211_scan_request *req)\r\n{\r\nwl1271_scan_stm(wl, wlvif);\r\nreturn 0;\r\n}\r\nvoid wl12xx_scan_completed(struct wl1271 *wl, struct wl12xx_vif *wlvif)\r\n{\r\nwl1271_scan_stm(wl, wlvif);\r\n}

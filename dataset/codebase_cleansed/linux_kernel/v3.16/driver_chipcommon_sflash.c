static void ssb_sflash_cmd(struct ssb_chipcommon *cc, u32 opcode)\r\n{\r\nint i;\r\nchipco_write32(cc, SSB_CHIPCO_FLASHCTL,\r\nSSB_CHIPCO_FLASHCTL_START | opcode);\r\nfor (i = 0; i < 1000; i++) {\r\nif (!(chipco_read32(cc, SSB_CHIPCO_FLASHCTL) &\r\nSSB_CHIPCO_FLASHCTL_BUSY))\r\nreturn;\r\ncpu_relax();\r\n}\r\npr_err("SFLASH control command failed (timeout)!\n");\r\n}\r\nint ssb_sflash_init(struct ssb_chipcommon *cc)\r\n{\r\nstruct ssb_sflash *sflash = &cc->dev->bus->mipscore.sflash;\r\nconst struct ssb_sflash_tbl_e *e;\r\nu32 id, id2;\r\nswitch (cc->capabilities & SSB_CHIPCO_CAP_FLASHT) {\r\ncase SSB_CHIPCO_FLASHT_STSER:\r\nssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_ST_DP);\r\nchipco_write32(cc, SSB_CHIPCO_FLASHADDR, 0);\r\nssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_ST_RES);\r\nid = chipco_read32(cc, SSB_CHIPCO_FLASHDATA);\r\nchipco_write32(cc, SSB_CHIPCO_FLASHADDR, 1);\r\nssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_ST_RES);\r\nid2 = chipco_read32(cc, SSB_CHIPCO_FLASHDATA);\r\nswitch (id) {\r\ncase 0xbf:\r\nfor (e = ssb_sflash_sst_tbl; e->name; e++) {\r\nif (e->id == id2)\r\nbreak;\r\n}\r\nbreak;\r\ncase 0x13:\r\nreturn -ENOTSUPP;\r\ndefault:\r\nfor (e = ssb_sflash_st_tbl; e->name; e++) {\r\nif (e->id == id)\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nif (!e->name) {\r\npr_err("Unsupported ST serial flash (id: 0x%X, id2: 0x%X)\n",\r\nid, id2);\r\nreturn -ENOTSUPP;\r\n}\r\nbreak;\r\ncase SSB_CHIPCO_FLASHT_ATSER:\r\nssb_sflash_cmd(cc, SSB_CHIPCO_FLASHCTL_AT_STATUS);\r\nid = chipco_read32(cc, SSB_CHIPCO_FLASHDATA) & 0x3c;\r\nfor (e = ssb_sflash_at_tbl; e->name; e++) {\r\nif (e->id == id)\r\nbreak;\r\n}\r\nif (!e->name) {\r\npr_err("Unsupported Atmel serial flash (id: 0x%X)\n",\r\nid);\r\nreturn -ENOTSUPP;\r\n}\r\nbreak;\r\ndefault:\r\npr_err("Unsupported flash type\n");\r\nreturn -ENOTSUPP;\r\n}\r\nsflash->window = SSB_FLASH2;\r\nsflash->blocksize = e->blocksize;\r\nsflash->numblocks = e->numblocks;\r\nsflash->size = sflash->blocksize * sflash->numblocks;\r\nsflash->present = true;\r\npr_info("Found %s serial flash (size: %dKiB, blocksize: 0x%X, blocks: %d)\n",\r\ne->name, sflash->size / 1024, e->blocksize, e->numblocks);\r\nssb_sflash_dev.resource[0].end = ssb_sflash_dev.resource[0].start +\r\nsflash->size;\r\nssb_sflash_dev.dev.platform_data = sflash;\r\nreturn 0;\r\n}

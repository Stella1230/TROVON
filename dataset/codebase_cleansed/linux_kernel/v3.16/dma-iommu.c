static void *dma_iommu_alloc_coherent(struct device *dev, size_t size,\r\ndma_addr_t *dma_handle, gfp_t flag,\r\nstruct dma_attrs *attrs)\r\n{\r\nreturn iommu_alloc_coherent(dev, get_iommu_table_base(dev), size,\r\ndma_handle, dev->coherent_dma_mask, flag,\r\ndev_to_node(dev));\r\n}\r\nstatic void dma_iommu_free_coherent(struct device *dev, size_t size,\r\nvoid *vaddr, dma_addr_t dma_handle,\r\nstruct dma_attrs *attrs)\r\n{\r\niommu_free_coherent(get_iommu_table_base(dev), size, vaddr, dma_handle);\r\n}\r\nstatic dma_addr_t dma_iommu_map_page(struct device *dev, struct page *page,\r\nunsigned long offset, size_t size,\r\nenum dma_data_direction direction,\r\nstruct dma_attrs *attrs)\r\n{\r\nreturn iommu_map_page(dev, get_iommu_table_base(dev), page, offset,\r\nsize, device_to_mask(dev), direction, attrs);\r\n}\r\nstatic void dma_iommu_unmap_page(struct device *dev, dma_addr_t dma_handle,\r\nsize_t size, enum dma_data_direction direction,\r\nstruct dma_attrs *attrs)\r\n{\r\niommu_unmap_page(get_iommu_table_base(dev), dma_handle, size, direction,\r\nattrs);\r\n}\r\nstatic int dma_iommu_map_sg(struct device *dev, struct scatterlist *sglist,\r\nint nelems, enum dma_data_direction direction,\r\nstruct dma_attrs *attrs)\r\n{\r\nreturn iommu_map_sg(dev, get_iommu_table_base(dev), sglist, nelems,\r\ndevice_to_mask(dev), direction, attrs);\r\n}\r\nstatic void dma_iommu_unmap_sg(struct device *dev, struct scatterlist *sglist,\r\nint nelems, enum dma_data_direction direction,\r\nstruct dma_attrs *attrs)\r\n{\r\niommu_unmap_sg(get_iommu_table_base(dev), sglist, nelems, direction,\r\nattrs);\r\n}\r\nstatic int dma_iommu_dma_supported(struct device *dev, u64 mask)\r\n{\r\nstruct iommu_table *tbl = get_iommu_table_base(dev);\r\nif (!tbl) {\r\ndev_info(dev, "Warning: IOMMU dma not supported: mask 0x%08llx"\r\n", table unavailable\n", mask);\r\nreturn 0;\r\n}\r\nif (tbl->it_offset > (mask >> tbl->it_page_shift)) {\r\ndev_info(dev, "Warning: IOMMU offset too big for device mask\n");\r\ndev_info(dev, "mask: 0x%08llx, table offset: 0x%08lx\n",\r\nmask, tbl->it_offset << tbl->it_page_shift);\r\nreturn 0;\r\n} else\r\nreturn 1;\r\n}\r\nstatic u64 dma_iommu_get_required_mask(struct device *dev)\r\n{\r\nstruct iommu_table *tbl = get_iommu_table_base(dev);\r\nu64 mask;\r\nif (!tbl)\r\nreturn 0;\r\nmask = 1ULL < (fls_long(tbl->it_offset + tbl->it_size) - 1);\r\nmask += mask - 1;\r\nreturn mask;\r\n}

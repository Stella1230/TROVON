static unsigned long at91sam9x5_clk_usb_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nu32 tmp;\r\nu8 usbdiv;\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\ntmp = pmc_read(pmc, AT91_PMC_USB);\r\nusbdiv = (tmp & AT91_PMC_OHCIUSBDIV) >> SAM9X5_USB_DIV_SHIFT;\r\nreturn parent_rate / (usbdiv + 1);\r\n}\r\nstatic long at91sam9x5_clk_usb_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nunsigned long div;\r\nunsigned long bestrate;\r\nunsigned long tmp;\r\nif (rate >= *parent_rate)\r\nreturn *parent_rate;\r\ndiv = *parent_rate / rate;\r\nif (div >= SAM9X5_USB_MAX_DIV)\r\nreturn *parent_rate / (SAM9X5_USB_MAX_DIV + 1);\r\nbestrate = *parent_rate / div;\r\ntmp = *parent_rate / (div + 1);\r\nif (bestrate - rate > rate - tmp)\r\nbestrate = tmp;\r\nreturn bestrate;\r\n}\r\nstatic int at91sam9x5_clk_usb_set_parent(struct clk_hw *hw, u8 index)\r\n{\r\nu32 tmp;\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\nif (index > 1)\r\nreturn -EINVAL;\r\ntmp = pmc_read(pmc, AT91_PMC_USB) & ~AT91_PMC_USBS;\r\nif (index)\r\ntmp |= AT91_PMC_USBS;\r\npmc_write(pmc, AT91_PMC_USB, tmp);\r\nreturn 0;\r\n}\r\nstatic u8 at91sam9x5_clk_usb_get_parent(struct clk_hw *hw)\r\n{\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\nreturn pmc_read(pmc, AT91_PMC_USB) & AT91_PMC_USBS;\r\n}\r\nstatic int at91sam9x5_clk_usb_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nu32 tmp;\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\nunsigned long div = parent_rate / rate;\r\nif (parent_rate % rate || div < 1 || div >= SAM9X5_USB_MAX_DIV)\r\nreturn -EINVAL;\r\ntmp = pmc_read(pmc, AT91_PMC_USB) & ~AT91_PMC_OHCIUSBDIV;\r\ntmp |= (div - 1) << SAM9X5_USB_DIV_SHIFT;\r\npmc_write(pmc, AT91_PMC_USB, tmp);\r\nreturn 0;\r\n}\r\nstatic int at91sam9n12_clk_usb_enable(struct clk_hw *hw)\r\n{\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\npmc_write(pmc, AT91_PMC_USB,\r\npmc_read(pmc, AT91_PMC_USB) | AT91_PMC_USBS);\r\nreturn 0;\r\n}\r\nstatic void at91sam9n12_clk_usb_disable(struct clk_hw *hw)\r\n{\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\npmc_write(pmc, AT91_PMC_USB,\r\npmc_read(pmc, AT91_PMC_USB) & ~AT91_PMC_USBS);\r\n}\r\nstatic int at91sam9n12_clk_usb_is_enabled(struct clk_hw *hw)\r\n{\r\nstruct at91sam9x5_clk_usb *usb = to_at91sam9x5_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\nreturn !!(pmc_read(pmc, AT91_PMC_USB) & AT91_PMC_USBS);\r\n}\r\nstatic struct clk * __init\r\nat91sam9x5_clk_register_usb(struct at91_pmc *pmc, const char *name,\r\nconst char **parent_names, u8 num_parents)\r\n{\r\nstruct at91sam9x5_clk_usb *usb;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nusb = kzalloc(sizeof(*usb), GFP_KERNEL);\r\nif (!usb)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &at91sam9x5_usb_ops;\r\ninit.parent_names = parent_names;\r\ninit.num_parents = num_parents;\r\ninit.flags = CLK_SET_RATE_GATE | CLK_SET_PARENT_GATE;\r\nusb->hw.init = &init;\r\nusb->pmc = pmc;\r\nclk = clk_register(NULL, &usb->hw);\r\nif (IS_ERR(clk))\r\nkfree(usb);\r\nreturn clk;\r\n}\r\nstatic struct clk * __init\r\nat91sam9n12_clk_register_usb(struct at91_pmc *pmc, const char *name,\r\nconst char *parent_name)\r\n{\r\nstruct at91sam9x5_clk_usb *usb;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nusb = kzalloc(sizeof(*usb), GFP_KERNEL);\r\nif (!usb)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &at91sam9n12_usb_ops;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\ninit.flags = CLK_SET_RATE_GATE;\r\nusb->hw.init = &init;\r\nusb->pmc = pmc;\r\nclk = clk_register(NULL, &usb->hw);\r\nif (IS_ERR(clk))\r\nkfree(usb);\r\nreturn clk;\r\n}\r\nstatic unsigned long at91rm9200_clk_usb_recalc_rate(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct at91rm9200_clk_usb *usb = to_at91rm9200_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\nu32 tmp;\r\nu8 usbdiv;\r\ntmp = pmc_read(pmc, AT91_CKGR_PLLBR);\r\nusbdiv = (tmp & AT91_PMC_USBDIV) >> RM9200_USB_DIV_SHIFT;\r\nif (usb->divisors[usbdiv])\r\nreturn parent_rate / usb->divisors[usbdiv];\r\nreturn 0;\r\n}\r\nstatic long at91rm9200_clk_usb_round_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct at91rm9200_clk_usb *usb = to_at91rm9200_clk_usb(hw);\r\nunsigned long bestrate = 0;\r\nint bestdiff = -1;\r\nunsigned long tmprate;\r\nint tmpdiff;\r\nint i = 0;\r\nfor (i = 0; i < 4; i++) {\r\nif (!usb->divisors[i])\r\ncontinue;\r\ntmprate = *parent_rate / usb->divisors[i];\r\nif (tmprate < rate)\r\ntmpdiff = rate - tmprate;\r\nelse\r\ntmpdiff = tmprate - rate;\r\nif (bestdiff < 0 || bestdiff > tmpdiff) {\r\nbestrate = tmprate;\r\nbestdiff = tmpdiff;\r\n}\r\nif (!bestdiff)\r\nbreak;\r\n}\r\nreturn bestrate;\r\n}\r\nstatic int at91rm9200_clk_usb_set_rate(struct clk_hw *hw, unsigned long rate,\r\nunsigned long parent_rate)\r\n{\r\nu32 tmp;\r\nint i;\r\nstruct at91rm9200_clk_usb *usb = to_at91rm9200_clk_usb(hw);\r\nstruct at91_pmc *pmc = usb->pmc;\r\nunsigned long div = parent_rate / rate;\r\nif (parent_rate % rate)\r\nreturn -EINVAL;\r\nfor (i = 0; i < RM9200_USB_DIV_TAB_SIZE; i++) {\r\nif (usb->divisors[i] == div) {\r\ntmp = pmc_read(pmc, AT91_CKGR_PLLBR) &\r\n~AT91_PMC_USBDIV;\r\ntmp |= i << RM9200_USB_DIV_SHIFT;\r\npmc_write(pmc, AT91_CKGR_PLLBR, tmp);\r\nreturn 0;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic struct clk * __init\r\nat91rm9200_clk_register_usb(struct at91_pmc *pmc, const char *name,\r\nconst char *parent_name, const u32 *divisors)\r\n{\r\nstruct at91rm9200_clk_usb *usb;\r\nstruct clk *clk = NULL;\r\nstruct clk_init_data init;\r\nusb = kzalloc(sizeof(*usb), GFP_KERNEL);\r\nif (!usb)\r\nreturn ERR_PTR(-ENOMEM);\r\ninit.name = name;\r\ninit.ops = &at91rm9200_usb_ops;\r\ninit.parent_names = &parent_name;\r\ninit.num_parents = 1;\r\ninit.flags = 0;\r\nusb->hw.init = &init;\r\nusb->pmc = pmc;\r\nmemcpy(usb->divisors, divisors, sizeof(usb->divisors));\r\nclk = clk_register(NULL, &usb->hw);\r\nif (IS_ERR(clk))\r\nkfree(usb);\r\nreturn clk;\r\n}\r\nvoid __init of_at91sam9x5_clk_usb_setup(struct device_node *np,\r\nstruct at91_pmc *pmc)\r\n{\r\nstruct clk *clk;\r\nint i;\r\nint num_parents;\r\nconst char *parent_names[USB_SOURCE_MAX];\r\nconst char *name = np->name;\r\nnum_parents = of_count_phandle_with_args(np, "clocks", "#clock-cells");\r\nif (num_parents <= 0 || num_parents > USB_SOURCE_MAX)\r\nreturn;\r\nfor (i = 0; i < num_parents; i++) {\r\nparent_names[i] = of_clk_get_parent_name(np, i);\r\nif (!parent_names[i])\r\nreturn;\r\n}\r\nof_property_read_string(np, "clock-output-names", &name);\r\nclk = at91sam9x5_clk_register_usb(pmc, name, parent_names, num_parents);\r\nif (IS_ERR(clk))\r\nreturn;\r\nof_clk_add_provider(np, of_clk_src_simple_get, clk);\r\n}\r\nvoid __init of_at91sam9n12_clk_usb_setup(struct device_node *np,\r\nstruct at91_pmc *pmc)\r\n{\r\nstruct clk *clk;\r\nconst char *parent_name;\r\nconst char *name = np->name;\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nif (!parent_name)\r\nreturn;\r\nof_property_read_string(np, "clock-output-names", &name);\r\nclk = at91sam9n12_clk_register_usb(pmc, name, parent_name);\r\nif (IS_ERR(clk))\r\nreturn;\r\nof_clk_add_provider(np, of_clk_src_simple_get, clk);\r\n}\r\nvoid __init of_at91rm9200_clk_usb_setup(struct device_node *np,\r\nstruct at91_pmc *pmc)\r\n{\r\nstruct clk *clk;\r\nconst char *parent_name;\r\nconst char *name = np->name;\r\nu32 divisors[4] = {0, 0, 0, 0};\r\nparent_name = of_clk_get_parent_name(np, 0);\r\nif (!parent_name)\r\nreturn;\r\nof_property_read_u32_array(np, "atmel,clk-divisors", divisors, 4);\r\nif (!divisors[0])\r\nreturn;\r\nof_property_read_string(np, "clock-output-names", &name);\r\nclk = at91rm9200_clk_register_usb(pmc, name, parent_name, divisors);\r\nif (IS_ERR(clk))\r\nreturn;\r\nof_clk_add_provider(np, of_clk_src_simple_get, clk);\r\n}

static void isci_task_refuse(struct isci_host *ihost, struct sas_task *task,\r\nenum service_response response,\r\nenum exec_status status)\r\n{\r\nunsigned long flags;\r\ndev_dbg(&ihost->pdev->dev, "%s: task = %p, response=%d, status=%d\n",\r\n__func__, task, response, status);\r\nspin_lock_irqsave(&task->task_state_lock, flags);\r\ntask->task_status.resp = response;\r\ntask->task_status.stat = status;\r\ntask->task_state_flags |= SAS_TASK_STATE_DONE;\r\ntask->task_state_flags &= ~(SAS_TASK_AT_INITIATOR |\r\nSAS_TASK_STATE_PENDING);\r\ntask->lldd_task = NULL;\r\nspin_unlock_irqrestore(&task->task_state_lock, flags);\r\ntask->task_done(task);\r\n}\r\nstatic inline int isci_device_io_ready(struct isci_remote_device *idev,\r\nstruct sas_task *task)\r\n{\r\nreturn idev ? test_bit(IDEV_IO_READY, &idev->flags) ||\r\n(test_bit(IDEV_IO_NCQERROR, &idev->flags) &&\r\nisci_task_is_ncq_recovery(task))\r\n: 0;\r\n}\r\nint isci_task_execute_task(struct sas_task *task, int num, gfp_t gfp_flags)\r\n{\r\nstruct isci_host *ihost = dev_to_ihost(task->dev);\r\nstruct isci_remote_device *idev;\r\nunsigned long flags;\r\nbool io_ready;\r\nu16 tag;\r\ndev_dbg(&ihost->pdev->dev, "%s: num=%d\n", __func__, num);\r\nfor_each_sas_task(num, task) {\r\nenum sci_status status = SCI_FAILURE;\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nidev = isci_lookup_device(task->dev);\r\nio_ready = isci_device_io_ready(idev, task);\r\ntag = isci_alloc_tag(ihost);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\ndev_dbg(&ihost->pdev->dev,\r\n"task: %p, num: %d dev: %p idev: %p:%#lx cmd = %p\n",\r\ntask, num, task->dev, idev, idev ? idev->flags : 0,\r\ntask->uldd_task);\r\nif (!idev) {\r\nisci_task_refuse(ihost, task, SAS_TASK_UNDELIVERED,\r\nSAS_DEVICE_UNKNOWN);\r\n} else if (!io_ready || tag == SCI_CONTROLLER_INVALID_IO_TAG) {\r\nisci_task_refuse(ihost, task, SAS_TASK_COMPLETE,\r\nSAS_QUEUE_FULL);\r\n} else {\r\nspin_lock_irqsave(&task->task_state_lock, flags);\r\nif (task->task_state_flags & SAS_TASK_STATE_ABORTED) {\r\nspin_unlock_irqrestore(&task->task_state_lock,\r\nflags);\r\nisci_task_refuse(ihost, task,\r\nSAS_TASK_UNDELIVERED,\r\nSAM_STAT_TASK_ABORTED);\r\n} else {\r\ntask->task_state_flags |= SAS_TASK_AT_INITIATOR;\r\nspin_unlock_irqrestore(&task->task_state_lock, flags);\r\nstatus = isci_request_execute(ihost, idev, task, tag);\r\nif (status != SCI_SUCCESS) {\r\nspin_lock_irqsave(&task->task_state_lock, flags);\r\ntask->task_state_flags &= ~SAS_TASK_AT_INITIATOR;\r\nspin_unlock_irqrestore(&task->task_state_lock, flags);\r\nif (test_bit(IDEV_GONE, &idev->flags)) {\r\nisci_task_refuse(ihost, task,\r\nSAS_TASK_UNDELIVERED,\r\nSAS_DEVICE_UNKNOWN);\r\n} else {\r\nisci_task_refuse(ihost, task,\r\nSAS_TASK_COMPLETE,\r\nSAS_QUEUE_FULL);\r\n}\r\n}\r\n}\r\n}\r\nif (status != SCI_SUCCESS && tag != SCI_CONTROLLER_INVALID_IO_TAG) {\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nisci_tci_free(ihost, ISCI_TAG_TCI(tag));\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\n}\r\nisci_put_device(idev);\r\n}\r\nreturn 0;\r\n}\r\nstatic struct isci_request *isci_task_request_build(struct isci_host *ihost,\r\nstruct isci_remote_device *idev,\r\nu16 tag, struct isci_tmf *isci_tmf)\r\n{\r\nenum sci_status status = SCI_FAILURE;\r\nstruct isci_request *ireq = NULL;\r\nstruct domain_device *dev;\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: isci_tmf = %p\n", __func__, isci_tmf);\r\ndev = idev->domain_dev;\r\nireq = isci_tmf_request_from_tag(ihost, isci_tmf, tag);\r\nif (!ireq)\r\nreturn NULL;\r\nstatus = sci_task_request_construct(ihost, idev, tag,\r\nireq);\r\nif (status != SCI_SUCCESS) {\r\ndev_warn(&ihost->pdev->dev,\r\n"%s: sci_task_request_construct failed - "\r\n"status = 0x%x\n",\r\n__func__,\r\nstatus);\r\nreturn NULL;\r\n}\r\nif (dev->dev_type == SAS_END_DEVICE) {\r\nisci_tmf->proto = SAS_PROTOCOL_SSP;\r\nstatus = sci_task_request_construct_ssp(ireq);\r\nif (status != SCI_SUCCESS)\r\nreturn NULL;\r\n}\r\nreturn ireq;\r\n}\r\nstatic int isci_task_execute_tmf(struct isci_host *ihost,\r\nstruct isci_remote_device *idev,\r\nstruct isci_tmf *tmf, unsigned long timeout_ms)\r\n{\r\nDECLARE_COMPLETION_ONSTACK(completion);\r\nenum sci_task_status status = SCI_TASK_FAILURE;\r\nstruct isci_request *ireq;\r\nint ret = TMF_RESP_FUNC_FAILED;\r\nunsigned long flags;\r\nunsigned long timeleft;\r\nu16 tag;\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\ntag = isci_alloc_tag(ihost);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\nif (tag == SCI_CONTROLLER_INVALID_IO_TAG)\r\nreturn ret;\r\nif (!idev ||\r\n(!test_bit(IDEV_IO_READY, &idev->flags) &&\r\n!test_bit(IDEV_IO_NCQERROR, &idev->flags))) {\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: idev = %p not ready (%#lx)\n",\r\n__func__,\r\nidev, idev ? idev->flags : 0);\r\ngoto err_tci;\r\n} else\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: idev = %p\n",\r\n__func__, idev);\r\ntmf->complete = &completion;\r\ntmf->status = SCI_FAILURE_TIMEOUT;\r\nireq = isci_task_request_build(ihost, idev, tag, tmf);\r\nif (!ireq)\r\ngoto err_tci;\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nstatus = sci_controller_start_task(ihost, idev, ireq);\r\nif (status != SCI_TASK_SUCCESS) {\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: start_io failed - status = 0x%x, request = %p\n",\r\n__func__,\r\nstatus,\r\nireq);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\ngoto err_tci;\r\n}\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\nisci_remote_device_resume_from_abort(ihost, idev);\r\ntimeleft = wait_for_completion_timeout(&completion,\r\nmsecs_to_jiffies(timeout_ms));\r\nif (timeleft == 0) {\r\nisci_remote_device_suspend_terminate(ihost, idev, ireq);\r\n}\r\nisci_print_tmf(ihost, tmf);\r\nif (tmf->status == SCI_SUCCESS)\r\nret = TMF_RESP_FUNC_COMPLETE;\r\nelse if (tmf->status == SCI_FAILURE_IO_RESPONSE_VALID) {\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: tmf.status == "\r\n"SCI_FAILURE_IO_RESPONSE_VALID\n",\r\n__func__);\r\nret = TMF_RESP_FUNC_COMPLETE;\r\n}\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: completed request = %p\n",\r\n__func__,\r\nireq);\r\nreturn ret;\r\nerr_tci:\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nisci_tci_free(ihost, ISCI_TAG_TCI(tag));\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\nreturn ret;\r\n}\r\nstatic void isci_task_build_tmf(struct isci_tmf *tmf,\r\nenum isci_tmf_function_codes code)\r\n{\r\nmemset(tmf, 0, sizeof(*tmf));\r\ntmf->tmf_code = code;\r\n}\r\nstatic void isci_task_build_abort_task_tmf(struct isci_tmf *tmf,\r\nenum isci_tmf_function_codes code,\r\nstruct isci_request *old_request)\r\n{\r\nisci_task_build_tmf(tmf, code);\r\ntmf->io_tag = old_request->io_tag;\r\n}\r\nstatic int isci_task_send_lu_reset_sas(\r\nstruct isci_host *isci_host,\r\nstruct isci_remote_device *isci_device,\r\nu8 *lun)\r\n{\r\nstruct isci_tmf tmf;\r\nint ret = TMF_RESP_FUNC_FAILED;\r\ndev_dbg(&isci_host->pdev->dev,\r\n"%s: isci_host = %p, isci_device = %p\n",\r\n__func__, isci_host, isci_device);\r\nisci_task_build_tmf(&tmf, isci_tmf_ssp_lun_reset);\r\n#define ISCI_LU_RESET_TIMEOUT_MS 2000\r\nret = isci_task_execute_tmf(isci_host, isci_device, &tmf, ISCI_LU_RESET_TIMEOUT_MS);\r\nif (ret == TMF_RESP_FUNC_COMPLETE)\r\ndev_dbg(&isci_host->pdev->dev,\r\n"%s: %p: TMF_LU_RESET passed\n",\r\n__func__, isci_device);\r\nelse\r\ndev_dbg(&isci_host->pdev->dev,\r\n"%s: %p: TMF_LU_RESET failed (%x)\n",\r\n__func__, isci_device, ret);\r\nreturn ret;\r\n}\r\nint isci_task_lu_reset(struct domain_device *dev, u8 *lun)\r\n{\r\nstruct isci_host *ihost = dev_to_ihost(dev);\r\nstruct isci_remote_device *idev;\r\nunsigned long flags;\r\nint ret = TMF_RESP_FUNC_COMPLETE;\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nidev = isci_get_device(dev->lldd_dev);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: domain_device=%p, isci_host=%p; isci_device=%p\n",\r\n__func__, dev, ihost, idev);\r\nif (!idev) {\r\ndev_dbg(&ihost->pdev->dev, "%s: No dev\n", __func__);\r\nret = TMF_RESP_FUNC_FAILED;\r\ngoto out;\r\n}\r\nif (isci_remote_device_suspend_terminate(ihost, idev, NULL)\r\n!= SCI_SUCCESS) {\r\nret = TMF_RESP_FUNC_FAILED;\r\ngoto out;\r\n}\r\nif (!test_bit(IDEV_GONE, &idev->flags)) {\r\nif (dev_is_sata(dev))\r\nsas_ata_schedule_reset(dev);\r\nelse\r\nret = isci_task_send_lu_reset_sas(ihost, idev, lun);\r\n}\r\nout:\r\nisci_put_device(idev);\r\nreturn ret;\r\n}\r\nint isci_task_clear_nexus_port(struct asd_sas_port *port)\r\n{\r\nreturn TMF_RESP_FUNC_FAILED;\r\n}\r\nint isci_task_clear_nexus_ha(struct sas_ha_struct *ha)\r\n{\r\nreturn TMF_RESP_FUNC_FAILED;\r\n}\r\nint isci_task_abort_task(struct sas_task *task)\r\n{\r\nstruct isci_host *ihost = dev_to_ihost(task->dev);\r\nDECLARE_COMPLETION_ONSTACK(aborted_io_completion);\r\nstruct isci_request *old_request = NULL;\r\nstruct isci_remote_device *idev = NULL;\r\nstruct isci_tmf tmf;\r\nint ret = TMF_RESP_FUNC_FAILED;\r\nunsigned long flags;\r\nint target_done_already = 0;\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nspin_lock(&task->task_state_lock);\r\nold_request = task->lldd_task;\r\nif (!(task->task_state_flags & SAS_TASK_STATE_DONE) &&\r\n(task->task_state_flags & SAS_TASK_AT_INITIATOR) &&\r\nold_request) {\r\nidev = isci_get_device(task->dev->lldd_dev);\r\ntarget_done_already = test_bit(IREQ_COMPLETE_IN_TARGET,\r\n&old_request->flags);\r\n}\r\nspin_unlock(&task->task_state_lock);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\ndev_warn(&ihost->pdev->dev,\r\n"%s: dev = %p (%s%s), task = %p, old_request == %p\n",\r\n__func__, idev,\r\n(dev_is_sata(task->dev) ? "STP/SATA"\r\n: ((dev_is_expander(task->dev))\r\n? "SMP"\r\n: "SSP")),\r\n((idev) ? ((test_bit(IDEV_GONE, &idev->flags))\r\n? " IDEV_GONE"\r\n: "")\r\n: " <NULL>"),\r\ntask, old_request);\r\nif (!idev || !old_request) {\r\nspin_lock_irqsave(&task->task_state_lock, flags);\r\ntask->task_state_flags |= SAS_TASK_STATE_DONE;\r\ntask->task_state_flags &= ~(SAS_TASK_AT_INITIATOR |\r\nSAS_TASK_STATE_PENDING);\r\nspin_unlock_irqrestore(&task->task_state_lock, flags);\r\nret = TMF_RESP_FUNC_COMPLETE;\r\ndev_warn(&ihost->pdev->dev,\r\n"%s: abort task not needed for %p\n",\r\n__func__, task);\r\ngoto out;\r\n}\r\nif (isci_remote_device_suspend_terminate(ihost, idev, old_request)\r\n!= SCI_SUCCESS) {\r\ndev_warn(&ihost->pdev->dev,\r\n"%s: isci_remote_device_reset_terminate(dev=%p, "\r\n"req=%p, task=%p) failed\n",\r\n__func__, idev, old_request, task);\r\nret = TMF_RESP_FUNC_FAILED;\r\ngoto out;\r\n}\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nif (task->task_proto == SAS_PROTOCOL_SMP ||\r\nsas_protocol_ata(task->task_proto) ||\r\ntarget_done_already ||\r\ntest_bit(IDEV_GONE, &idev->flags)) {\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\nisci_remote_device_resume_from_abort(ihost, idev);\r\ndev_warn(&ihost->pdev->dev,\r\n"%s: %s request"\r\n" or complete_in_target (%d), "\r\n"or IDEV_GONE (%d), thus no TMF\n",\r\n__func__,\r\n((task->task_proto == SAS_PROTOCOL_SMP)\r\n? "SMP"\r\n: (sas_protocol_ata(task->task_proto)\r\n? "SATA/STP"\r\n: "<other>")\r\n),\r\ntest_bit(IREQ_COMPLETE_IN_TARGET,\r\n&old_request->flags),\r\ntest_bit(IDEV_GONE, &idev->flags));\r\nspin_lock_irqsave(&task->task_state_lock, flags);\r\ntask->task_state_flags &= ~(SAS_TASK_AT_INITIATOR |\r\nSAS_TASK_STATE_PENDING);\r\ntask->task_state_flags |= SAS_TASK_STATE_DONE;\r\nspin_unlock_irqrestore(&task->task_state_lock, flags);\r\nret = TMF_RESP_FUNC_COMPLETE;\r\n} else {\r\nisci_task_build_abort_task_tmf(&tmf, isci_tmf_ssp_task_abort,\r\nold_request);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\n#define ISCI_ABORT_TASK_TIMEOUT_MS 500\r\nret = isci_task_execute_tmf(ihost, idev, &tmf,\r\nISCI_ABORT_TASK_TIMEOUT_MS);\r\n}\r\nout:\r\ndev_warn(&ihost->pdev->dev,\r\n"%s: Done; dev = %p, task = %p , old_request == %p\n",\r\n__func__, idev, task, old_request);\r\nisci_put_device(idev);\r\nreturn ret;\r\n}\r\nint isci_task_abort_task_set(\r\nstruct domain_device *d_device,\r\nu8 *lun)\r\n{\r\nreturn TMF_RESP_FUNC_FAILED;\r\n}\r\nint isci_task_clear_aca(\r\nstruct domain_device *d_device,\r\nu8 *lun)\r\n{\r\nreturn TMF_RESP_FUNC_FAILED;\r\n}\r\nint isci_task_clear_task_set(\r\nstruct domain_device *d_device,\r\nu8 *lun)\r\n{\r\nreturn TMF_RESP_FUNC_FAILED;\r\n}\r\nint isci_task_query_task(\r\nstruct sas_task *task)\r\n{\r\nif (task->task_state_flags & SAS_TASK_NEED_DEV_RESET)\r\nreturn TMF_RESP_FUNC_FAILED;\r\nelse\r\nreturn TMF_RESP_FUNC_SUCC;\r\n}\r\nvoid\r\nisci_task_request_complete(struct isci_host *ihost,\r\nstruct isci_request *ireq,\r\nenum sci_task_status completion_status)\r\n{\r\nstruct isci_tmf *tmf = isci_request_access_tmf(ireq);\r\nstruct completion *tmf_complete = NULL;\r\ndev_dbg(&ihost->pdev->dev,\r\n"%s: request = %p, status=%d\n",\r\n__func__, ireq, completion_status);\r\nset_bit(IREQ_COMPLETE_IN_TARGET, &ireq->flags);\r\nif (tmf) {\r\ntmf->status = completion_status;\r\nif (tmf->proto == SAS_PROTOCOL_SSP) {\r\nmemcpy(&tmf->resp.resp_iu,\r\n&ireq->ssp.rsp,\r\nSSP_RESP_IU_MAX_SIZE);\r\n} else if (tmf->proto == SAS_PROTOCOL_SATA) {\r\nmemcpy(&tmf->resp.d2h_fis,\r\n&ireq->stp.rsp,\r\nsizeof(struct dev_to_host_fis));\r\n}\r\ntmf_complete = tmf->complete;\r\n}\r\nsci_controller_complete_io(ihost, ireq->target_device, ireq);\r\nset_bit(IREQ_TERMINATED, &ireq->flags);\r\nif (test_and_clear_bit(IREQ_ABORT_PATH_ACTIVE, &ireq->flags))\r\nwake_up_all(&ihost->eventq);\r\nif (!test_bit(IREQ_NO_AUTO_FREE_TAG, &ireq->flags))\r\nisci_free_tag(ihost, ireq->io_tag);\r\nif (tmf_complete)\r\ncomplete(tmf_complete);\r\n}\r\nstatic int isci_reset_device(struct isci_host *ihost,\r\nstruct domain_device *dev,\r\nstruct isci_remote_device *idev)\r\n{\r\nint rc = TMF_RESP_FUNC_COMPLETE, reset_stat = -1;\r\nstruct sas_phy *phy = sas_get_local_phy(dev);\r\nstruct isci_port *iport = dev->port->lldd_port;\r\ndev_dbg(&ihost->pdev->dev, "%s: idev %p\n", __func__, idev);\r\nif (isci_remote_device_suspend_terminate(ihost, idev, NULL)\r\n!= SCI_SUCCESS) {\r\nrc = TMF_RESP_FUNC_FAILED;\r\ngoto out;\r\n}\r\nif (!test_bit(IDEV_GONE, &idev->flags)) {\r\nif (scsi_is_sas_phy_local(phy)) {\r\nstruct isci_phy *iphy = &ihost->phys[phy->number];\r\nreset_stat = isci_port_perform_hard_reset(ihost, iport,\r\niphy);\r\n} else\r\nreset_stat = sas_phy_reset(phy, !dev_is_sata(dev));\r\n}\r\nisci_remote_device_resume_from_abort(ihost, idev);\r\ndev_dbg(&ihost->pdev->dev, "%s: idev %p complete, reset_stat=%d.\n",\r\n__func__, idev, reset_stat);\r\nout:\r\nsas_put_local_phy(phy);\r\nreturn rc;\r\n}\r\nint isci_task_I_T_nexus_reset(struct domain_device *dev)\r\n{\r\nstruct isci_host *ihost = dev_to_ihost(dev);\r\nstruct isci_remote_device *idev;\r\nunsigned long flags;\r\nint ret;\r\nspin_lock_irqsave(&ihost->scic_lock, flags);\r\nidev = isci_get_device(dev->lldd_dev);\r\nspin_unlock_irqrestore(&ihost->scic_lock, flags);\r\nif (!idev) {\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nret = isci_reset_device(ihost, dev, idev);\r\nout:\r\nisci_put_device(idev);\r\nreturn ret;\r\n}

static int adis16130_spi_read(struct iio_dev *indio_dev, u8 reg_addr, u32 *val)\r\n{\r\nint ret;\r\nstruct adis16130_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfer = {\r\n.tx_buf = st->buf,\r\n.rx_buf = st->buf,\r\n.len = 4,\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->buf[0] = ADIS16130_CON_RD | reg_addr;\r\nst->buf[1] = st->buf[2] = st->buf[3] = 0;\r\nret = spi_sync_transfer(st->us, &xfer, 1);\r\nif (ret == 0)\r\n*val = (st->buf[1] << 16) | (st->buf[2] << 8) | st->buf[3];\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int adis16130_read_raw(struct iio_dev *indio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val, int *val2,\r\nlong mask)\r\n{\r\nint ret;\r\nu32 temp;\r\nswitch (mask) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&indio_dev->mlock);\r\nret = adis16130_spi_read(indio_dev, chan->address, &temp);\r\nmutex_unlock(&indio_dev->mlock);\r\nif (ret)\r\nreturn ret;\r\n*val = temp;\r\nreturn IIO_VAL_INT;\r\ncase IIO_CHAN_INFO_SCALE:\r\nswitch (chan->type) {\r\ncase IIO_ANGL_VEL:\r\n*val = 250;\r\n*val2 = 336440817;\r\nreturn IIO_VAL_FRACTIONAL;\r\ncase IIO_TEMP:\r\n*val = 105000;\r\n*val2 = 9516048 - 8036283;\r\nreturn IIO_VAL_FRACTIONAL;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ncase IIO_CHAN_INFO_OFFSET:\r\nswitch (chan->type) {\r\ncase IIO_ANGL_VEL:\r\n*val = -8388608;\r\nreturn IIO_VAL_INT;\r\ncase IIO_TEMP:\r\n*val = -8036283;\r\nreturn IIO_VAL_INT;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n}\r\nreturn -EINVAL;\r\n}\r\nstatic int adis16130_probe(struct spi_device *spi)\r\n{\r\nstruct adis16130_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nst->us = spi;\r\nmutex_init(&st->buf_lock);\r\nindio_dev->name = spi->dev.driver->name;\r\nindio_dev->channels = adis16130_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(adis16130_channels);\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &adis16130_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nreturn devm_iio_device_register(&spi->dev, indio_dev);\r\n}

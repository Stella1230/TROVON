static int set_config_address(unsigned int busno, unsigned int devfn, int reg)\r\n{\r\nif ((devfn > 255) || (reg > 255))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\nif (busno == 0 && devfn >= PCI_DEVFN(8, 0))\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n*(volatile u32 *)PCIMT_CONFIG_ADDRESS =\r\n((busno & 0xff) << 16) |\r\n((devfn & 0xff) << 8) |\r\n(reg & 0xfc);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int pcimt_read(struct pci_bus *bus, unsigned int devfn, int reg,\r\nint size, u32 * val)\r\n{\r\nint res;\r\nif ((res = set_config_address(bus->number, devfn, reg)))\r\nreturn res;\r\nswitch (size) {\r\ncase 1:\r\n*val = inb(PCIMT_CONFIG_DATA + (reg & 3));\r\nbreak;\r\ncase 2:\r\n*val = inw(PCIMT_CONFIG_DATA + (reg & 2));\r\nbreak;\r\ncase 4:\r\n*val = inl(PCIMT_CONFIG_DATA);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pcimt_write(struct pci_bus *bus, unsigned int devfn, int reg,\r\nint size, u32 val)\r\n{\r\nint res;\r\nif ((res = set_config_address(bus->number, devfn, reg)))\r\nreturn res;\r\nswitch (size) {\r\ncase 1:\r\noutb(val, PCIMT_CONFIG_DATA + (reg & 3));\r\nbreak;\r\ncase 2:\r\noutw(val, PCIMT_CONFIG_DATA + (reg & 2));\r\nbreak;\r\ncase 4:\r\noutl(val, PCIMT_CONFIG_DATA);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pcit_set_config_address(unsigned int busno, unsigned int devfn, int reg)\r\n{\r\nif ((devfn > 255) || (reg > 255) || (busno > 255))\r\nreturn PCIBIOS_BAD_REGISTER_NUMBER;\r\noutl((1 << 31) | ((busno & 0xff) << 16) | ((devfn & 0xff) << 8) | (reg & 0xfc), 0xcf8);\r\nreturn PCIBIOS_SUCCESSFUL;\r\n}\r\nstatic int pcit_read(struct pci_bus *bus, unsigned int devfn, int reg,\r\nint size, u32 * val)\r\n{\r\nint res;\r\nif (bus->number == 0) {\r\npcit_set_config_address(0, 0, 0x68);\r\noutl(inl(0xcfc) | 0xc0000000, 0xcfc);\r\nif ((res = pcit_set_config_address(0, devfn, 0)))\r\nreturn res;\r\noutl(0xffffffff, 0xcfc);\r\npcit_set_config_address(0, 0, 0x68);\r\nif (inl(0xcfc) & 0x100000)\r\nreturn PCIBIOS_DEVICE_NOT_FOUND;\r\n}\r\nif ((res = pcit_set_config_address(bus->number, devfn, reg)))\r\nreturn res;\r\nswitch (size) {\r\ncase 1:\r\n*val = inb(PCIMT_CONFIG_DATA + (reg & 3));\r\nbreak;\r\ncase 2:\r\n*val = inw(PCIMT_CONFIG_DATA + (reg & 2));\r\nbreak;\r\ncase 4:\r\n*val = inl(PCIMT_CONFIG_DATA);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int pcit_write(struct pci_bus *bus, unsigned int devfn, int reg,\r\nint size, u32 val)\r\n{\r\nint res;\r\nif ((res = pcit_set_config_address(bus->number, devfn, reg)))\r\nreturn res;\r\nswitch (size) {\r\ncase 1:\r\noutb(val, PCIMT_CONFIG_DATA + (reg & 3));\r\nbreak;\r\ncase 2:\r\noutw(val, PCIMT_CONFIG_DATA + (reg & 2));\r\nbreak;\r\ncase 4:\r\noutl(val, PCIMT_CONFIG_DATA);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

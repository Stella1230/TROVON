static void nft_counter_eval(const struct nft_expr *expr,\r\nstruct nft_data data[NFT_REG_MAX + 1],\r\nconst struct nft_pktinfo *pkt)\r\n{\r\nstruct nft_counter *priv = nft_expr_priv(expr);\r\nwrite_seqlock_bh(&priv->lock);\r\npriv->bytes += pkt->skb->len;\r\npriv->packets++;\r\nwrite_sequnlock_bh(&priv->lock);\r\n}\r\nstatic int nft_counter_dump(struct sk_buff *skb, const struct nft_expr *expr)\r\n{\r\nstruct nft_counter *priv = nft_expr_priv(expr);\r\nunsigned int seq;\r\nu64 bytes;\r\nu64 packets;\r\ndo {\r\nseq = read_seqbegin(&priv->lock);\r\nbytes = priv->bytes;\r\npackets = priv->packets;\r\n} while (read_seqretry(&priv->lock, seq));\r\nif (nla_put_be64(skb, NFTA_COUNTER_BYTES, cpu_to_be64(bytes)))\r\ngoto nla_put_failure;\r\nif (nla_put_be64(skb, NFTA_COUNTER_PACKETS, cpu_to_be64(packets)))\r\ngoto nla_put_failure;\r\nreturn 0;\r\nnla_put_failure:\r\nreturn -1;\r\n}\r\nstatic int nft_counter_init(const struct nft_ctx *ctx,\r\nconst struct nft_expr *expr,\r\nconst struct nlattr * const tb[])\r\n{\r\nstruct nft_counter *priv = nft_expr_priv(expr);\r\nif (tb[NFTA_COUNTER_PACKETS])\r\npriv->packets = be64_to_cpu(nla_get_be64(tb[NFTA_COUNTER_PACKETS]));\r\nif (tb[NFTA_COUNTER_BYTES])\r\npriv->bytes = be64_to_cpu(nla_get_be64(tb[NFTA_COUNTER_BYTES]));\r\nseqlock_init(&priv->lock);\r\nreturn 0;\r\n}\r\nstatic int __init nft_counter_module_init(void)\r\n{\r\nreturn nft_register_expr(&nft_counter_type);\r\n}\r\nstatic void __exit nft_counter_module_exit(void)\r\n{\r\nnft_unregister_expr(&nft_counter_type);\r\n}

int radeon_semaphore_create(struct radeon_device *rdev,\r\nstruct radeon_semaphore **semaphore)\r\n{\r\nuint32_t *cpu_addr;\r\nint i, r;\r\n*semaphore = kmalloc(sizeof(struct radeon_semaphore), GFP_KERNEL);\r\nif (*semaphore == NULL) {\r\nreturn -ENOMEM;\r\n}\r\nr = radeon_sa_bo_new(rdev, &rdev->ring_tmp_bo, &(*semaphore)->sa_bo,\r\n8 * RADEON_NUM_SYNCS, 8);\r\nif (r) {\r\nkfree(*semaphore);\r\n*semaphore = NULL;\r\nreturn r;\r\n}\r\n(*semaphore)->waiters = 0;\r\n(*semaphore)->gpu_addr = radeon_sa_bo_gpu_addr((*semaphore)->sa_bo);\r\ncpu_addr = radeon_sa_bo_cpu_addr((*semaphore)->sa_bo);\r\nfor (i = 0; i < RADEON_NUM_SYNCS; ++i)\r\ncpu_addr[i] = 0;\r\nfor (i = 0; i < RADEON_NUM_RINGS; ++i)\r\n(*semaphore)->sync_to[i] = NULL;\r\nreturn 0;\r\n}\r\nbool radeon_semaphore_emit_signal(struct radeon_device *rdev, int ridx,\r\nstruct radeon_semaphore *semaphore)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[ridx];\r\ntrace_radeon_semaphore_signale(ridx, semaphore);\r\nif (radeon_semaphore_ring_emit(rdev, ridx, ring, semaphore, false)) {\r\n--semaphore->waiters;\r\nring->last_semaphore_signal_addr = semaphore->gpu_addr;\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nbool radeon_semaphore_emit_wait(struct radeon_device *rdev, int ridx,\r\nstruct radeon_semaphore *semaphore)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[ridx];\r\ntrace_radeon_semaphore_wait(ridx, semaphore);\r\nif (radeon_semaphore_ring_emit(rdev, ridx, ring, semaphore, true)) {\r\n++semaphore->waiters;\r\nring->last_semaphore_wait_addr = semaphore->gpu_addr;\r\nreturn true;\r\n}\r\nreturn false;\r\n}\r\nvoid radeon_semaphore_sync_to(struct radeon_semaphore *semaphore,\r\nstruct radeon_fence *fence)\r\n{\r\nstruct radeon_fence *other;\r\nif (!fence)\r\nreturn;\r\nother = semaphore->sync_to[fence->ring];\r\nsemaphore->sync_to[fence->ring] = radeon_fence_later(fence, other);\r\n}\r\nint radeon_semaphore_sync_rings(struct radeon_device *rdev,\r\nstruct radeon_semaphore *semaphore,\r\nint ring)\r\n{\r\nunsigned count = 0;\r\nint i, r;\r\nfor (i = 0; i < RADEON_NUM_RINGS; ++i) {\r\nstruct radeon_fence *fence = semaphore->sync_to[i];\r\nif (!radeon_fence_need_sync(fence, ring))\r\ncontinue;\r\nif (!rdev->ring[i].ready) {\r\ndev_err(rdev->dev, "Syncing to a disabled ring!");\r\nreturn -EINVAL;\r\n}\r\nif (++count > RADEON_NUM_SYNCS) {\r\nr = radeon_fence_wait(fence, false);\r\nif (r)\r\nreturn r;\r\ncontinue;\r\n}\r\nr = radeon_ring_alloc(rdev, &rdev->ring[i], 16);\r\nif (r) {\r\nreturn r;\r\n}\r\nif (!radeon_semaphore_emit_signal(rdev, i, semaphore)) {\r\nradeon_ring_undo(&rdev->ring[i]);\r\nr = radeon_fence_wait(fence, false);\r\nif (r)\r\nreturn r;\r\ncontinue;\r\n}\r\nif (!radeon_semaphore_emit_wait(rdev, ring, semaphore)) {\r\nradeon_ring_undo(&rdev->ring[i]);\r\nr = radeon_fence_wait(fence, false);\r\nif (r)\r\nreturn r;\r\ncontinue;\r\n}\r\nradeon_ring_commit(rdev, &rdev->ring[i]);\r\nradeon_fence_note_sync(fence, ring);\r\nsemaphore->gpu_addr += 8;\r\n}\r\nreturn 0;\r\n}\r\nvoid radeon_semaphore_free(struct radeon_device *rdev,\r\nstruct radeon_semaphore **semaphore,\r\nstruct radeon_fence *fence)\r\n{\r\nif (semaphore == NULL || *semaphore == NULL) {\r\nreturn;\r\n}\r\nif ((*semaphore)->waiters > 0) {\r\ndev_err(rdev->dev, "semaphore %p has more waiters than signalers,"\r\n" hardware lockup imminent!\n", *semaphore);\r\n}\r\nradeon_sa_bo_free(rdev, &(*semaphore)->sa_bo, fence);\r\nkfree(*semaphore);\r\n*semaphore = NULL;\r\n}

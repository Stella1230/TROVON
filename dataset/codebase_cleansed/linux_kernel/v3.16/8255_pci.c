static int pci_8255_mite_init(struct pci_dev *pcidev)\r\n{\r\nvoid __iomem *mite_base;\r\nu32 main_phys_addr;\r\nmite_base = pci_ioremap_bar(pcidev, 0);\r\nif (!mite_base)\r\nreturn -ENOMEM;\r\nmain_phys_addr = pci_resource_start(pcidev, 1);\r\nwritel(main_phys_addr | WENAB, mite_base + MITE_IODWBSR);\r\niounmap(mite_base);\r\nreturn 0;\r\n}\r\nstatic int pci_8255_mmio(int dir, int port, int data, unsigned long iobase)\r\n{\r\nvoid __iomem *mmio_base = (void __iomem *)iobase;\r\nif (dir) {\r\nwriteb(data, mmio_base + port);\r\nreturn 0;\r\n} else {\r\nreturn readb(mmio_base + port);\r\n}\r\n}\r\nstatic int pci_8255_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct pci_8255_boardinfo *board = NULL;\r\nstruct pci_8255_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nbool is_mmio;\r\nint ret;\r\nint i;\r\nif (context < ARRAY_SIZE(pci_8255_boards))\r\nboard = &pci_8255_boards[context];\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\nif (board->has_mite) {\r\nret = pci_8255_mite_init(pcidev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nis_mmio = (pci_resource_flags(pcidev, board->dio_badr) &\r\nIORESOURCE_MEM) != 0;\r\nif (is_mmio) {\r\ndevpriv->mmio_base = pci_ioremap_bar(pcidev, board->dio_badr);\r\nif (!devpriv->mmio_base)\r\nreturn -ENOMEM;\r\n} else {\r\ndev->iobase = pci_resource_start(pcidev, board->dio_badr);\r\n}\r\nret = comedi_alloc_subdevices(dev, board->n_8255);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < board->n_8255; i++) {\r\nunsigned long iobase;\r\ns = &dev->subdevices[i];\r\nif (is_mmio) {\r\niobase = (unsigned long)(devpriv->mmio_base + (i * 4));\r\nret = subdev_8255_init(dev, s, pci_8255_mmio, iobase);\r\n} else {\r\niobase = dev->iobase + (i * 4);\r\nret = subdev_8255_init(dev, s, NULL, iobase);\r\n}\r\nif (ret)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic void pci_8255_detach(struct comedi_device *dev)\r\n{\r\nstruct pci_8255_private *devpriv = dev->private;\r\nif (devpriv && devpriv->mmio_base)\r\niounmap(devpriv->mmio_base);\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int pci_8255_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &pci_8255_driver, id->driver_data);\r\n}

static void umcast_init(struct net_device *dev, void *data)\r\n{\r\nstruct uml_net_private *pri;\r\nstruct umcast_data *dpri;\r\nstruct umcast_init *init = data;\r\npri = netdev_priv(dev);\r\ndpri = (struct umcast_data *) pri->user;\r\ndpri->addr = init->addr;\r\ndpri->lport = init->lport;\r\ndpri->rport = init->rport;\r\ndpri->unicast = init->unicast;\r\ndpri->ttl = init->ttl;\r\ndpri->dev = dev;\r\nif (dpri->unicast) {\r\nprintk(KERN_INFO "ucast backend address: %s:%u listen port: "\r\n"%u\n", dpri->addr, dpri->rport, dpri->lport);\r\n} else {\r\nprintk(KERN_INFO "mcast backend multicast address: %s:%u, "\r\n"TTL:%u\n", dpri->addr, dpri->lport, dpri->ttl);\r\n}\r\n}\r\nstatic int umcast_read(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nreturn net_recvfrom(fd, skb_mac_header(skb),\r\nskb->dev->mtu + ETH_HEADER_OTHER);\r\n}\r\nstatic int umcast_write(int fd, struct sk_buff *skb, struct uml_net_private *lp)\r\n{\r\nreturn umcast_user_write(fd, skb->data, skb->len,\r\n(struct umcast_data *) &lp->user);\r\n}\r\nstatic int mcast_setup(char *str, char **mac_out, void *data)\r\n{\r\nstruct umcast_init *init = data;\r\nchar *port_str = NULL, *ttl_str = NULL, *remain;\r\nchar *last;\r\n*init = ((struct umcast_init)\r\n{ .addr = "239.192.168.1",\r\n.lport = 1102,\r\n.ttl = 1 });\r\nremain = split_if_spec(str, mac_out, &init->addr, &port_str, &ttl_str,\r\nNULL);\r\nif (remain != NULL) {\r\nprintk(KERN_ERR "mcast_setup - Extra garbage on "\r\n"specification : '%s'\n", remain);\r\nreturn 0;\r\n}\r\nif (port_str != NULL) {\r\ninit->lport = simple_strtoul(port_str, &last, 10);\r\nif ((*last != '\0') || (last == port_str)) {\r\nprintk(KERN_ERR "mcast_setup - Bad port : '%s'\n",\r\nport_str);\r\nreturn 0;\r\n}\r\n}\r\nif (ttl_str != NULL) {\r\ninit->ttl = simple_strtoul(ttl_str, &last, 10);\r\nif ((*last != '\0') || (last == ttl_str)) {\r\nprintk(KERN_ERR "mcast_setup - Bad ttl : '%s'\n",\r\nttl_str);\r\nreturn 0;\r\n}\r\n}\r\ninit->unicast = false;\r\ninit->rport = init->lport;\r\nprintk(KERN_INFO "Configured mcast device: %s:%u-%u\n", init->addr,\r\ninit->lport, init->ttl);\r\nreturn 1;\r\n}\r\nstatic int ucast_setup(char *str, char **mac_out, void *data)\r\n{\r\nstruct umcast_init *init = data;\r\nchar *lport_str = NULL, *rport_str = NULL, *remain;\r\nchar *last;\r\n*init = ((struct umcast_init)\r\n{ .addr = "",\r\n.lport = 1102,\r\n.rport = 1102 });\r\nremain = split_if_spec(str, mac_out, &init->addr,\r\n&lport_str, &rport_str, NULL);\r\nif (remain != NULL) {\r\nprintk(KERN_ERR "ucast_setup - Extra garbage on "\r\n"specification : '%s'\n", remain);\r\nreturn 0;\r\n}\r\nif (lport_str != NULL) {\r\ninit->lport = simple_strtoul(lport_str, &last, 10);\r\nif ((*last != '\0') || (last == lport_str)) {\r\nprintk(KERN_ERR "ucast_setup - Bad listen port : "\r\n"'%s'\n", lport_str);\r\nreturn 0;\r\n}\r\n}\r\nif (rport_str != NULL) {\r\ninit->rport = simple_strtoul(rport_str, &last, 10);\r\nif ((*last != '\0') || (last == rport_str)) {\r\nprintk(KERN_ERR "ucast_setup - Bad remote port : "\r\n"'%s'\n", rport_str);\r\nreturn 0;\r\n}\r\n}\r\ninit->unicast = true;\r\nprintk(KERN_INFO "Configured ucast device: :%u -> %s:%u\n",\r\ninit->lport, init->addr, init->rport);\r\nreturn 1;\r\n}\r\nstatic int register_umcast(void)\r\n{\r\nregister_transport(&mcast_transport);\r\nregister_transport(&ucast_transport);\r\nreturn 0;\r\n}

static u32 pmc_read(unsigned long reg)\r\n{\r\nreturn readl(pmc + reg);\r\n}\r\nstatic void pmc_write(u32 val, unsigned long reg)\r\n{\r\nwritel(val, pmc + reg);\r\n}\r\nstatic int tegra_powergate_set(int id, bool new_state)\r\n{\r\nbool status;\r\nunsigned long flags;\r\nspin_lock_irqsave(&tegra_powergate_lock, flags);\r\nstatus = pmc_read(PWRGATE_STATUS) & (1 << id);\r\nif (status == new_state) {\r\nspin_unlock_irqrestore(&tegra_powergate_lock, flags);\r\nreturn 0;\r\n}\r\npmc_write(PWRGATE_TOGGLE_START | id, PWRGATE_TOGGLE);\r\nspin_unlock_irqrestore(&tegra_powergate_lock, flags);\r\nreturn 0;\r\n}\r\nint tegra_powergate_power_on(int id)\r\n{\r\nif (id < 0 || id >= tegra_num_powerdomains)\r\nreturn -EINVAL;\r\nreturn tegra_powergate_set(id, true);\r\n}\r\nint tegra_powergate_power_off(int id)\r\n{\r\nif (id < 0 || id >= tegra_num_powerdomains)\r\nreturn -EINVAL;\r\nreturn tegra_powergate_set(id, false);\r\n}\r\nint tegra_powergate_is_powered(int id)\r\n{\r\nu32 status;\r\nif (id < 0 || id >= tegra_num_powerdomains)\r\nreturn -EINVAL;\r\nstatus = pmc_read(PWRGATE_STATUS) & (1 << id);\r\nreturn !!status;\r\n}\r\nint tegra_powergate_remove_clamping(int id)\r\n{\r\nu32 mask;\r\nif (id < 0 || id >= tegra_num_powerdomains)\r\nreturn -EINVAL;\r\nif (tegra_chip_id == TEGRA124) {\r\nif (id == TEGRA_POWERGATE_3D) {\r\npmc_write(0, GPU_RG_CNTRL);\r\nreturn 0;\r\n}\r\n}\r\nif (id == TEGRA_POWERGATE_VDEC)\r\nmask = (1 << TEGRA_POWERGATE_PCIE);\r\nelse if (id == TEGRA_POWERGATE_PCIE)\r\nmask = (1 << TEGRA_POWERGATE_VDEC);\r\nelse\r\nmask = (1 << id);\r\npmc_write(mask, REMOVE_CLAMPING);\r\nreturn 0;\r\n}\r\nint tegra_powergate_sequence_power_up(int id, struct clk *clk,\r\nstruct reset_control *rst)\r\n{\r\nint ret;\r\nreset_control_assert(rst);\r\nret = tegra_powergate_power_on(id);\r\nif (ret)\r\ngoto err_power;\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\ngoto err_clk;\r\nudelay(10);\r\nret = tegra_powergate_remove_clamping(id);\r\nif (ret)\r\ngoto err_clamp;\r\nudelay(10);\r\nreset_control_deassert(rst);\r\nreturn 0;\r\nerr_clamp:\r\nclk_disable_unprepare(clk);\r\nerr_clk:\r\ntegra_powergate_power_off(id);\r\nerr_power:\r\nreturn ret;\r\n}\r\nint tegra_cpu_powergate_id(int cpuid)\r\n{\r\nif (cpuid > 0 && cpuid < tegra_num_cpu_domains)\r\nreturn tegra_cpu_domains[cpuid];\r\nreturn -EINVAL;\r\n}\r\nint __init tegra_powergate_init(void)\r\n{\r\nswitch (tegra_chip_id) {\r\ncase TEGRA20:\r\ntegra_num_powerdomains = 7;\r\nbreak;\r\ncase TEGRA30:\r\ntegra_num_powerdomains = 14;\r\ntegra_num_cpu_domains = 4;\r\ntegra_cpu_domains = tegra30_cpu_domains;\r\nbreak;\r\ncase TEGRA114:\r\ntegra_num_powerdomains = 23;\r\ntegra_num_cpu_domains = 4;\r\ntegra_cpu_domains = tegra114_cpu_domains;\r\nbreak;\r\ncase TEGRA124:\r\ntegra_num_powerdomains = 25;\r\ntegra_num_cpu_domains = 4;\r\ntegra_cpu_domains = tegra124_cpu_domains;\r\nbreak;\r\ndefault:\r\ntegra_num_powerdomains = 0;\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int powergate_show(struct seq_file *s, void *data)\r\n{\r\nint i;\r\nseq_printf(s, " powergate powered\n");\r\nseq_printf(s, "------------------\n");\r\nfor (i = 0; i < tegra_num_powerdomains; i++) {\r\nif (!powergate_name[i])\r\ncontinue;\r\nseq_printf(s, " %9s %7s\n", powergate_name[i],\r\ntegra_powergate_is_powered(i) ? "yes" : "no");\r\n}\r\nreturn 0;\r\n}\r\nstatic int powergate_open(struct inode *inode, struct file *file)\r\n{\r\nreturn single_open(file, powergate_show, inode->i_private);\r\n}\r\nint __init tegra_powergate_debugfs_init(void)\r\n{\r\nstruct dentry *d;\r\nswitch (tegra_chip_id) {\r\ncase TEGRA20:\r\npowergate_name = powergate_name_t20;\r\nbreak;\r\ncase TEGRA30:\r\npowergate_name = powergate_name_t30;\r\nbreak;\r\ncase TEGRA114:\r\npowergate_name = powergate_name_t114;\r\nbreak;\r\ncase TEGRA124:\r\npowergate_name = powergate_name_t124;\r\nbreak;\r\n}\r\nif (powergate_name) {\r\nd = debugfs_create_file("powergate", S_IRUGO, NULL, NULL,\r\n&powergate_fops);\r\nif (!d)\r\nreturn -ENOMEM;\r\n}\r\nreturn 0;\r\n}\r\nstatic int tegra_io_rail_prepare(int id, unsigned long *request,\r\nunsigned long *status, unsigned int *bit)\r\n{\r\nunsigned long rate, value;\r\nstruct clk *clk;\r\n*bit = id % 32;\r\nif (id > 63 || *bit == 30 || *bit == 31)\r\nreturn -EINVAL;\r\nif (id < 32) {\r\n*status = IO_DPD_STATUS;\r\n*request = IO_DPD_REQ;\r\n} else {\r\n*status = IO_DPD2_STATUS;\r\n*request = IO_DPD2_REQ;\r\n}\r\nclk = clk_get_sys(NULL, "pclk");\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nrate = clk_get_rate(clk);\r\nclk_put(clk);\r\npmc_write(DPD_SAMPLE_ENABLE, DPD_SAMPLE);\r\nvalue = DIV_ROUND_UP(1000000000, rate);\r\nvalue = DIV_ROUND_UP(200, value);\r\npmc_write(value, SEL_DPD_TIM);\r\nreturn 0;\r\n}\r\nstatic int tegra_io_rail_poll(unsigned long offset, unsigned long mask,\r\nunsigned long val, unsigned long timeout)\r\n{\r\nunsigned long value;\r\ntimeout = jiffies + msecs_to_jiffies(timeout);\r\nwhile (time_after(timeout, jiffies)) {\r\nvalue = pmc_read(offset);\r\nif ((value & mask) == val)\r\nreturn 0;\r\nusleep_range(250, 1000);\r\n}\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void tegra_io_rail_unprepare(void)\r\n{\r\npmc_write(DPD_SAMPLE_DISABLE, DPD_SAMPLE);\r\n}\r\nint tegra_io_rail_power_on(int id)\r\n{\r\nunsigned long request, status, value;\r\nunsigned int bit, mask;\r\nint err;\r\nerr = tegra_io_rail_prepare(id, &request, &status, &bit);\r\nif (err < 0)\r\nreturn err;\r\nmask = 1 << bit;\r\nvalue = pmc_read(request);\r\nvalue |= mask;\r\nvalue &= ~IO_DPD_REQ_CODE_MASK;\r\nvalue |= IO_DPD_REQ_CODE_OFF;\r\npmc_write(value, request);\r\nerr = tegra_io_rail_poll(status, mask, 0, 250);\r\nif (err < 0)\r\nreturn err;\r\ntegra_io_rail_unprepare();\r\nreturn 0;\r\n}\r\nint tegra_io_rail_power_off(int id)\r\n{\r\nunsigned long request, status, value;\r\nunsigned int bit, mask;\r\nint err;\r\nerr = tegra_io_rail_prepare(id, &request, &status, &bit);\r\nif (err < 0)\r\nreturn err;\r\nmask = 1 << bit;\r\nvalue = pmc_read(request);\r\nvalue |= mask;\r\nvalue &= ~IO_DPD_REQ_CODE_MASK;\r\nvalue |= IO_DPD_REQ_CODE_ON;\r\npmc_write(value, request);\r\nerr = tegra_io_rail_poll(status, mask, mask, 250);\r\nif (err < 0)\r\nreturn err;\r\ntegra_io_rail_unprepare();\r\nreturn 0;\r\n}

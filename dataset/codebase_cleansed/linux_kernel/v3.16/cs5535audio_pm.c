static void snd_cs5535audio_stop_hardware(struct cs5535audio *cs5535au)\r\n{\r\ncs_writel(cs5535au, ACC_CODEC_CNTL, ACC_CODEC_CNTL_LNK_SHUTDOWN);\r\n}\r\nstatic int snd_cs5535audio_suspend(struct device *dev)\r\n{\r\nstruct pci_dev *pci = to_pci_dev(dev);\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct cs5535audio *cs5535au = card->private_data;\r\nint i;\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D3hot);\r\nsnd_pcm_suspend_all(cs5535au->pcm);\r\nsnd_ac97_suspend(cs5535au->ac97);\r\nfor (i = 0; i < NUM_CS5535AUDIO_DMAS; i++) {\r\nstruct cs5535audio_dma *dma = &cs5535au->dmas[i];\r\nif (dma && dma->substream)\r\ndma->saved_prd = dma->ops->read_prd(cs5535au);\r\n}\r\nsnd_cs5535audio_stop_hardware(cs5535au);\r\nif (pci_save_state(pci)) {\r\ndev_err(dev, "pci_save_state failed!\n");\r\nreturn -EIO;\r\n}\r\npci_disable_device(pci);\r\npci_set_power_state(pci, PCI_D3hot);\r\nreturn 0;\r\n}\r\nstatic int snd_cs5535audio_resume(struct device *dev)\r\n{\r\nstruct pci_dev *pci = to_pci_dev(dev);\r\nstruct snd_card *card = dev_get_drvdata(dev);\r\nstruct cs5535audio *cs5535au = card->private_data;\r\nu32 tmp;\r\nint timeout;\r\nint i;\r\npci_set_power_state(pci, PCI_D0);\r\npci_restore_state(pci);\r\nif (pci_enable_device(pci) < 0) {\r\ndev_err(dev, "pci_enable_device failed, disabling device\n");\r\nsnd_card_disconnect(card);\r\nreturn -EIO;\r\n}\r\npci_set_master(pci);\r\ncs_writel(cs5535au, ACC_CODEC_CNTL, ACC_CODEC_CNTL_LNK_WRM_RST);\r\ntimeout = 50;\r\ndo {\r\ntmp = cs_readl(cs5535au, ACC_CODEC_STATUS);\r\nif (tmp & PRM_RDY_STS)\r\nbreak;\r\nudelay(1);\r\n} while (--timeout);\r\nif (!timeout)\r\ndev_err(cs5535au->card->dev, "Failure getting AC Link ready\n");\r\nfor (i = 0; i < NUM_CS5535AUDIO_DMAS; i++) {\r\nstruct cs5535audio_dma *dma = &cs5535au->dmas[i];\r\nif (dma && dma->substream) {\r\ndma->substream->ops->prepare(dma->substream);\r\ndma->ops->setup_prd(cs5535au, dma->saved_prd);\r\n}\r\n}\r\nsnd_ac97_resume(cs5535au->ac97);\r\nsnd_power_change_state(card, SNDRV_CTL_POWER_D0);\r\nreturn 0;\r\n}

VOID\r\nhalbtc8723a1ant_Reg0x550Bit3(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bSet\r\n)\r\n{\r\nu1Byte u1tmp=0;\r\nu1tmp = pBtCoexist->btc_read_1byte(pBtCoexist, 0x550);\r\nif(bSet)\r\n{\r\nu1tmp |= BIT3;\r\n}\r\nelse\r\n{\r\nu1tmp &= ~BIT3;\r\n}\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x550, u1tmp);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], set 0x550[3]=%d\n", (bSet? 1:0)));\r\n}\r\nVOID\r\nhalbtc8723a1ant_NotifyFwScan(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte scanType\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\nif(BTC_SCAN_START == scanType)\r\nH2C_Parameter[0] = 0x1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], Notify FW for wifi scan, write 0x3b=0x%x\n",\r\nH2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x3b, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8723a1ant_QueryBtInfo(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\npCoexSta->bC2hBtInfoReqSent = true;\r\nH2C_Parameter[0] |= BIT0;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], Query Bt Info, FW write 0x38=0x%x\n",\r\nH2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x38, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8723a1ant_SetSwRfRxLpfCorner(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bRxRfShrinkOn\r\n)\r\n{\r\nif(bRxRfShrinkOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Shrink RF Rx LPF corner!!\n"));\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x1e, 0xfffff, 0xf0ff7);\r\n}\r\nelse\r\n{\r\nif(pBtCoexist->initilized)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Resume RF Rx LPF corner!!\n"));\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x1e, 0xfffff, pCoexDm->btRf0x1eBackup);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8723a1ant_RfShrink(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bRxRfShrinkOn\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn Rx RF Shrink = %s\n",\r\n(bForceExec? "force to":""), ((bRxRfShrinkOn)? "ON":"OFF")));\r\npCoexDm->bCurRfRxLpfShrink = bRxRfShrinkOn;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreRfRxLpfShrink=%d, bCurRfRxLpfShrink=%d\n",\r\npCoexDm->bPreRfRxLpfShrink, pCoexDm->bCurRfRxLpfShrink));\r\nif(pCoexDm->bPreRfRxLpfShrink == pCoexDm->bCurRfRxLpfShrink)\r\nreturn;\r\n}\r\nhalbtc8723a1ant_SetSwRfRxLpfCorner(pBtCoexist, pCoexDm->bCurRfRxLpfShrink);\r\npCoexDm->bPreRfRxLpfShrink = pCoexDm->bCurRfRxLpfShrink;\r\n}\r\nVOID\r\nhalbtc8723a1ant_SetSwPenaltyTxRateAdaptive(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bLowPenaltyRa\r\n)\r\n{\r\nu1Byte tmpU1;\r\ntmpU1 = pBtCoexist->btc_read_1byte(pBtCoexist, 0x4fd);\r\ntmpU1 |= BIT0;\r\nif(bLowPenaltyRa)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Tx rate adaptive, set low penalty!!\n"));\r\ntmpU1 &= ~BIT2;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Tx rate adaptive, set normal!!\n"));\r\ntmpU1 |= BIT2;\r\n}\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x4fd, tmpU1);\r\n}\r\nVOID\r\nhalbtc8723a1ant_LowPenaltyRa(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bLowPenaltyRa\r\n)\r\n{\r\nreturn;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn LowPenaltyRA = %s\n",\r\n(bForceExec? "force to":""), ((bLowPenaltyRa)? "ON":"OFF")));\r\npCoexDm->bCurLowPenaltyRa = bLowPenaltyRa;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreLowPenaltyRa=%d, bCurLowPenaltyRa=%d\n",\r\npCoexDm->bPreLowPenaltyRa, pCoexDm->bCurLowPenaltyRa));\r\nif(pCoexDm->bPreLowPenaltyRa == pCoexDm->bCurLowPenaltyRa)\r\nreturn;\r\n}\r\nhalbtc8723a1ant_SetSwPenaltyTxRateAdaptive(pBtCoexist, pCoexDm->bCurLowPenaltyRa);\r\npCoexDm->bPreLowPenaltyRa = pCoexDm->bCurLowPenaltyRa;\r\n}\r\nVOID\r\nhalbtc8723a1ant_SetCoexTable(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u4Byte val0x6c0,\r\nIN u4Byte val0x6c8,\r\nIN u1Byte val0x6cc\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c0=0x%x\n", val0x6c0));\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c0, val0x6c0);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c8=0x%x\n", val0x6c8));\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c8, val0x6c8);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6cc=0x%x\n", val0x6cc));\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x6cc, val0x6cc);\r\n}\r\nVOID\r\nhalbtc8723a1ant_CoexTable(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u4Byte val0x6c0,\r\nIN u4Byte val0x6c8,\r\nIN u1Byte val0x6cc\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s write Coex Table 0x6c0=0x%x, 0x6c8=0x%x, 0x6cc=0x%x\n",\r\n(bForceExec? "force to":""), val0x6c0, val0x6c8, val0x6cc));\r\npCoexDm->curVal0x6c0 = val0x6c0;\r\npCoexDm->curVal0x6c8 = val0x6c8;\r\npCoexDm->curVal0x6cc = val0x6cc;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], preVal0x6c0=0x%x, preVal0x6c8=0x%x, preVal0x6cc=0x%x !!\n",\r\npCoexDm->preVal0x6c0, pCoexDm->preVal0x6c8, pCoexDm->preVal0x6cc));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], curVal0x6c0=0x%x, curVal0x6c8=0x%x, curVal0x6cc=0x%x !!\n",\r\npCoexDm->curVal0x6c0, pCoexDm->curVal0x6c8, pCoexDm->curVal0x6cc));\r\nif( (pCoexDm->preVal0x6c0 == pCoexDm->curVal0x6c0) &&\r\n(pCoexDm->preVal0x6c8 == pCoexDm->curVal0x6c8) &&\r\n(pCoexDm->preVal0x6cc == pCoexDm->curVal0x6cc) )\r\nreturn;\r\n}\r\nhalbtc8723a1ant_SetCoexTable(pBtCoexist, val0x6c0, val0x6c8, val0x6cc);\r\npCoexDm->preVal0x6c0 = pCoexDm->curVal0x6c0;\r\npCoexDm->preVal0x6c8 = pCoexDm->curVal0x6c8;\r\npCoexDm->preVal0x6cc = pCoexDm->curVal0x6cc;\r\n}\r\nVOID\r\nhalbtc8723a1ant_SetFwIgnoreWlanAct(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bEnable\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\nif(bEnable)\r\n{\r\nH2C_Parameter[0] |= BIT0;\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], set FW for BT Ignore Wlan_Act, FW write 0x25=0x%x\n",\r\nH2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x25, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8723a1ant_IgnoreWlanAct(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bEnable\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s turn Ignore WlanAct %s\n",\r\n(bForceExec? "force to":""), (bEnable? "ON":"OFF")));\r\npCoexDm->bCurIgnoreWlanAct = bEnable;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreIgnoreWlanAct = %d, bCurIgnoreWlanAct = %d!!\n",\r\npCoexDm->bPreIgnoreWlanAct, pCoexDm->bCurIgnoreWlanAct));\r\nif(pCoexDm->bPreIgnoreWlanAct == pCoexDm->bCurIgnoreWlanAct)\r\nreturn;\r\n}\r\nhalbtc8723a1ant_SetFwIgnoreWlanAct(pBtCoexist, bEnable);\r\npCoexDm->bPreIgnoreWlanAct = pCoexDm->bCurIgnoreWlanAct;\r\n}\r\nVOID\r\nhalbtc8723a1ant_SetFwPstdma(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type,\r\nIN u1Byte byte1,\r\nIN u1Byte byte2,\r\nIN u1Byte byte3,\r\nIN u1Byte byte4,\r\nIN u1Byte byte5\r\n)\r\n{\r\nu1Byte H2C_Parameter[5] ={0};\r\nu1Byte realByte1=byte1, realByte5=byte5;\r\nBOOLEAN bApEnable=FALSE;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_AP_MODE_ENABLE, &bApEnable);\r\nif(byte1)\r\n{\r\nif(bApEnable)\r\n{\r\nif(type != 5 && type != 12)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], FW for 1Ant AP mode\n"));\r\nrealByte1 &= ~BIT4;\r\nrealByte1 |= BIT5;\r\nrealByte5 |= BIT5;\r\nrealByte5 &= ~BIT6;\r\n}\r\n}\r\n}\r\nH2C_Parameter[0] = realByte1;\r\nH2C_Parameter[1] = byte2;\r\nH2C_Parameter[2] = byte3;\r\nH2C_Parameter[3] = byte4;\r\nH2C_Parameter[4] = realByte5;\r\npCoexDm->psTdmaPara[0] = realByte1;\r\npCoexDm->psTdmaPara[1] = byte2;\r\npCoexDm->psTdmaPara[2] = byte3;\r\npCoexDm->psTdmaPara[3] = byte4;\r\npCoexDm->psTdmaPara[4] = realByte5;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], FW write 0x3a(5bytes)=0x%x%08x\n",\r\nH2C_Parameter[0],\r\nH2C_Parameter[1]<<24|H2C_Parameter[2]<<16|H2C_Parameter[3]<<8|H2C_Parameter[4]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x3a, 5, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8723a1ant_PsTdma(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bTurnOn,\r\nIN u1Byte type\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s turn %s PS TDMA, type=%d\n",\r\n(bForceExec? "force to":""), (bTurnOn? "ON":"OFF"), type));\r\npCoexDm->bCurPsTdmaOn = bTurnOn;\r\npCoexDm->curPsTdma = type;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPrePsTdmaOn = %d, bCurPsTdmaOn = %d!!\n",\r\npCoexDm->bPrePsTdmaOn, pCoexDm->bCurPsTdmaOn));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], prePsTdma = %d, curPsTdma = %d!!\n",\r\npCoexDm->prePsTdma, pCoexDm->curPsTdma));\r\nif( (pCoexDm->bPrePsTdmaOn == pCoexDm->bCurPsTdmaOn) &&\r\n(pCoexDm->prePsTdma == pCoexDm->curPsTdma) )\r\nreturn;\r\n}\r\nif(pCoexDm->bCurPsTdmaOn)\r\n{\r\nswitch(pCoexDm->curPsTdma)\r\n{\r\ncase 1:\r\ndefault:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x1a, 0x1a, 0x0, 0x40);\r\nbreak;\r\ncase 2:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x12, 0x12, 0x0, 0x40);\r\nbreak;\r\ncase 3:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x93, 0x3f, 0x3, 0x10, 0x40);\r\nbreak;\r\ncase 4:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x93, 0x15, 0x3, 0x10, 0x0);\r\nbreak;\r\ncase 5:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0xa9, 0x15, 0x3, 0x35, 0xc0);\r\nbreak;\r\ncase 8:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nbreak;\r\ncase 9:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0xa, 0xa, 0x0, 0x40);\r\nbreak;\r\ncase 10:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0xa, 0xa, 0x0, 0x40);\r\nbreak;\r\ncase 11:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x5, 0x5, 0x0, 0x40);\r\nbreak;\r\ncase 12:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0xa9, 0xa, 0x3, 0x15, 0xc0);\r\nbreak;\r\ncase 18:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nbreak;\r\ncase 20:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x2a, 0x2a, 0x0, 0x0);\r\nbreak;\r\ncase 21:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x93, 0x20, 0x3, 0x10, 0x40);\r\nbreak;\r\ncase 22:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x1a, 0x1a, 0x2, 0x40);\r\nbreak;\r\ncase 23:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x12, 0x12, 0x2, 0x40);\r\nbreak;\r\ncase 24:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0xa, 0xa, 0x2, 0x40);\r\nbreak;\r\ncase 25:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x5, 0x5, 0x2, 0x40);\r\nbreak;\r\ncase 26:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nbreak;\r\ncase 27:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x13, 0x5, 0x5, 0x2, 0x40);\r\nbreak;\r\ncase 28:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x3, 0x2f, 0x2f, 0x0, 0x0);\r\nbreak;\r\n}\r\n}\r\nelse\r\n{\r\nswitch(pCoexDm->curPsTdma)\r\n{\r\ncase 8:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x8, 0x0, 0x0, 0x0, 0x0);\r\nbreak;\r\ncase 0:\r\ndefault:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x0, 0x0, 0x0, 0x0, 0x0);\r\npBtCoexist->btc_write_2byte(pBtCoexist, 0x860, 0x210);\r\nbreak;\r\ncase 9:\r\nhalbtc8723a1ant_SetFwPstdma(pBtCoexist, type, 0x0, 0x0, 0x0, 0x0, 0x0);\r\npBtCoexist->btc_write_2byte(pBtCoexist, 0x860, 0x110);\r\nbreak;\r\n}\r\n}\r\npCoexDm->bPrePsTdmaOn = pCoexDm->bCurPsTdmaOn;\r\npCoexDm->prePsTdma = pCoexDm->curPsTdma;\r\n}\r\nVOID\r\nhalbtc8723a1ant_CoexAllOff(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8723a1ant_IgnoreWlanAct(pBtCoexist, NORMAL_EXEC, FALSE);\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8723a1ant_LowPenaltyRa(pBtCoexist, NORMAL_EXEC, FALSE);\r\nhalbtc8723a1ant_RfShrink(pBtCoexist, NORMAL_EXEC, FALSE);\r\nhalbtc8723a1ant_CoexTable(pBtCoexist, NORMAL_EXEC, 0x55555555, 0xffff, 0x3);\r\n}\r\nVOID\r\nhalbtc8723a1ant_InitCoexDm(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8723a1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, FALSE);\r\n}\r\nVOID\r\nhalbtc8723a1ant_BtEnableAction(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8723a1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, FALSE);\r\n}\r\nVOID\r\nhalbtc8723a1ant_MonitorBtCtr(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu4Byte regHPTxRx, regLPTxRx, u4Tmp;\r\nu4Byte regHPTx=0, regHPRx=0, regLPTx=0, regLPRx=0;\r\nu1Byte u1Tmp;\r\nregHPTxRx = 0x770;\r\nregLPTxRx = 0x774;\r\nu4Tmp = pBtCoexist->btc_read_4byte(pBtCoexist, regHPTxRx);\r\nregHPTx = u4Tmp & MASKLWORD;\r\nregHPRx = (u4Tmp & MASKHWORD)>>16;\r\nu4Tmp = pBtCoexist->btc_read_4byte(pBtCoexist, regLPTxRx);\r\nregLPTx = u4Tmp & MASKLWORD;\r\nregLPRx = (u4Tmp & MASKHWORD)>>16;\r\npCoexSta->highPriorityTx = regHPTx;\r\npCoexSta->highPriorityRx = regHPRx;\r\npCoexSta->lowPriorityTx = regLPTx;\r\npCoexSta->lowPriorityRx = regLPRx;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], High Priority Tx/Rx (reg 0x%x)=0x%x(%d)/0x%x(%d)\n",\r\nregHPTxRx, regHPTx, regHPTx, regHPRx, regHPRx));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], Low Priority Tx/Rx (reg 0x%x)=0x%x(%d)/0x%x(%d)\n",\r\nregLPTxRx, regLPTx, regLPTx, regLPRx, regLPRx));\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x76e, 0xc);\r\n}\r\nVOID\r\nhalbtc8723a1ant_MonitorBtEnableDisable(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstatic BOOLEAN bPreBtDisabled=FALSE;\r\nstatic u4Byte btDisableCnt=0;\r\nBOOLEAN bBtActive=true, bBtDisabled=FALSE;\r\nif( pCoexSta->highPriorityTx == 0 &&\r\npCoexSta->highPriorityRx == 0 &&\r\npCoexSta->lowPriorityTx == 0 &&\r\npCoexSta->lowPriorityRx == 0)\r\n{\r\nbBtActive = FALSE;\r\n}\r\nif( pCoexSta->highPriorityTx == 0xffff &&\r\npCoexSta->highPriorityRx == 0xffff &&\r\npCoexSta->lowPriorityTx == 0xffff &&\r\npCoexSta->lowPriorityRx == 0xffff)\r\n{\r\nbBtActive = FALSE;\r\n}\r\nif(bBtActive)\r\n{\r\nbtDisableCnt = 0;\r\nbBtDisabled = FALSE;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_DISABLE, &bBtDisabled);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is enabled !!\n"));\r\n}\r\nelse\r\n{\r\nbtDisableCnt++;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], bt all counters=0, %d times!!\n",\r\nbtDisableCnt));\r\nif(btDisableCnt >= 2)\r\n{\r\nbBtDisabled = true;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_DISABLE, &bBtDisabled);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is disabled !!\n"));\r\n}\r\n}\r\nif(bPreBtDisabled != bBtDisabled)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is from %s to %s!!\n",\r\n(bPreBtDisabled ? "disabled":"enabled"),\r\n(bBtDisabled ? "disabled":"enabled")));\r\nbPreBtDisabled = bBtDisabled;\r\nif(!bBtDisabled)\r\n{\r\nhalbtc8723a1ant_BtEnableAction(pBtCoexist);\r\n}\r\nelse\r\n{\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_NORMAL_LPS, NULL);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8723a1ant_TdmaDurationAdjust(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstatic s4Byte up,dn,m,n,WaitCount;\r\ns4Byte result;\r\nu1Byte retryCount=0;\r\nu1Byte btState;\r\nBOOLEAN bScan=FALSE, bLink=FALSE, bRoam=FALSE;\r\nu4Byte wifiBw;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nbtState = pCoexDm->btStatus;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], TdmaDurationAdjust()\n"));\r\nif(pCoexDm->psTdmaGlobalCnt != pCoexDm->psTdmaMonitorCnt)\r\n{\r\npCoexDm->psTdmaMonitorCnt = 0;\r\npCoexDm->psTdmaGlobalCnt = 0;\r\n}\r\nif(pCoexDm->psTdmaMonitorCnt == 0)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], first run BT A2DP + WiFi busy state!!\n"));\r\nif(btState == BT_STATE_8723A_1ANT_ACL_ONLY_BUSY)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 1);\r\npCoexDm->psTdmaDuAdjType = 1;\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 22);\r\npCoexDm->psTdmaDuAdjType = 22;\r\n}\r\nup = 0;\r\ndn = 0;\r\nm = 1;\r\nn= 3;\r\nresult = 0;\r\nWaitCount = 0;\r\n}\r\nelse\r\n{\r\nretryCount = pCoexSta->btRetryCnt;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], retryCount = %d\n", retryCount));\r\nresult = 0;\r\nWaitCount++;\r\nif(retryCount == 0)\r\n{\r\nup++;\r\ndn--;\r\nif (dn <= 0)\r\ndn = 0;\r\nif(up >= n)\r\n{\r\nWaitCount = 0;\r\nn = 3;\r\nup = 0;\r\ndn = 0;\r\nresult = 1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Increase wifi duration!!\n"));\r\n}\r\n}\r\nelse if (retryCount <= 3)\r\n{\r\nup--;\r\ndn++;\r\nif (up <= 0)\r\nup = 0;\r\nif (dn == 2)\r\n{\r\nif (WaitCount <= 2)\r\nm++;\r\nelse\r\nm = 1;\r\nif ( m >= 20)\r\nm = 20;\r\nn = 3*m;\r\nup = 0;\r\ndn = 0;\r\nWaitCount = 0;\r\nresult = -1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Decrease wifi duration for retryCounter<3!!\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif (WaitCount == 1)\r\nm++;\r\nelse\r\nm = 1;\r\nif ( m >= 20)\r\nm = 20;\r\nn = 3*m;\r\nup = 0;\r\ndn = 0;\r\nWaitCount = 0;\r\nresult = -1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Decrease wifi duration for retryCounter>3!!\n"));\r\n}\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BT TxRx counter H+L <= 1200\n"));\r\nif(btState != BT_STATE_8723A_1ANT_ACL_ONLY_BUSY)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], NOT ACL only busy!\n"));\r\nif(BTC_WIFI_BW_HT40 != wifiBw)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], 20MHz\n"));\r\nif(result == -1)\r\n{\r\nif(pCoexDm->curPsTdma == 22)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 23);\r\npCoexDm->psTdmaDuAdjType = 23;\r\n}\r\nelse if(pCoexDm->curPsTdma == 23)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 24);\r\npCoexDm->psTdmaDuAdjType = 24;\r\n}\r\nelse if(pCoexDm->curPsTdma == 24)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 25);\r\npCoexDm->psTdmaDuAdjType = 25;\r\n}\r\n}\r\nelse if (result == 1)\r\n{\r\nif(pCoexDm->curPsTdma == 25)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 24);\r\npCoexDm->psTdmaDuAdjType = 24;\r\n}\r\nelse if(pCoexDm->curPsTdma == 24)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 23);\r\npCoexDm->psTdmaDuAdjType = 23;\r\n}\r\nelse if(pCoexDm->curPsTdma == 23)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 22);\r\npCoexDm->psTdmaDuAdjType = 22;\r\n}\r\n}\r\nif( (pCoexDm->psTdmaDuAdjType != 22) &&\r\n(pCoexDm->psTdmaDuAdjType != 23) &&\r\n(pCoexDm->psTdmaDuAdjType != 24) &&\r\n(pCoexDm->psTdmaDuAdjType != 25) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], duration case out of handle!!\n"));\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 23);\r\npCoexDm->psTdmaDuAdjType = 23;\r\n}\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], 40MHz\n"));\r\nif(result == -1)\r\n{\r\nif(pCoexDm->curPsTdma == 23)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 24);\r\npCoexDm->psTdmaDuAdjType = 24;\r\n}\r\nelse if(pCoexDm->curPsTdma == 24)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 25);\r\npCoexDm->psTdmaDuAdjType = 25;\r\n}\r\nelse if(pCoexDm->curPsTdma == 25)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 27);\r\npCoexDm->psTdmaDuAdjType = 27;\r\n}\r\n}\r\nelse if (result == 1)\r\n{\r\nif(pCoexDm->curPsTdma == 27)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 25);\r\npCoexDm->psTdmaDuAdjType = 25;\r\n}\r\nelse if(pCoexDm->curPsTdma == 25)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 24);\r\npCoexDm->psTdmaDuAdjType = 24;\r\n}\r\nelse if(pCoexDm->curPsTdma == 24)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 23);\r\npCoexDm->psTdmaDuAdjType = 23;\r\n}\r\n}\r\nif( (pCoexDm->psTdmaDuAdjType != 23) &&\r\n(pCoexDm->psTdmaDuAdjType != 24) &&\r\n(pCoexDm->psTdmaDuAdjType != 25) &&\r\n(pCoexDm->psTdmaDuAdjType != 27) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], duration case out of handle!!\n"));\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 24);\r\npCoexDm->psTdmaDuAdjType = 24;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], ACL only busy\n"));\r\nif (result == -1)\r\n{\r\nif(pCoexDm->curPsTdma == 1)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\r\npCoexDm->psTdmaDuAdjType = 2;\r\n}\r\nelse if(pCoexDm->curPsTdma == 2)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\n}\r\nelse if(pCoexDm->curPsTdma == 9)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 11);\r\npCoexDm->psTdmaDuAdjType = 11;\r\n}\r\n}\r\nelse if (result == 1)\r\n{\r\nif(pCoexDm->curPsTdma == 11)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\n}\r\nelse if(pCoexDm->curPsTdma == 9)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\r\npCoexDm->psTdmaDuAdjType = 2;\r\n}\r\nelse if(pCoexDm->curPsTdma == 2)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 1);\r\npCoexDm->psTdmaDuAdjType = 1;\r\n}\r\n}\r\nif( (pCoexDm->psTdmaDuAdjType != 1) &&\r\n(pCoexDm->psTdmaDuAdjType != 2) &&\r\n(pCoexDm->psTdmaDuAdjType != 9) &&\r\n(pCoexDm->psTdmaDuAdjType != 11) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], duration case out of handle!!\n"));\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\r\npCoexDm->psTdmaDuAdjType = 2;\r\n}\r\n}\r\n}\r\n}\r\nif(pCoexDm->curPsTdma != pCoexDm->psTdmaDuAdjType)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], PsTdma type dismatch!!!, curPsTdma=%d, recordPsTdma=%d\n",\r\npCoexDm->curPsTdma, pCoexDm->psTdmaDuAdjType));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\r\nif( !bScan && !bLink && !bRoam)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, pCoexDm->psTdmaDuAdjType);\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], roaming/link/scan is under progress, will adjust next time!!!\n"));\r\n}\r\n}\r\npCoexDm->psTdmaMonitorCnt++;\r\n}\r\nVOID\r\nhalbtc8723a1ant_CoexForWifiConnect(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBOOLEAN bWifiConnected=FALSE, bWifiBusy=FALSE;\r\nu1Byte btState, btInfoOriginal=0;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nbtState = pCoexDm->btStatus;\r\nbtInfoOriginal = pCoexSta->btInfoC2h[BT_INFO_SRC_8723A_1ANT_BT_RSP][0];\r\nif(bWifiConnected)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi connected!!\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\r\nif( !bWifiBusy &&\r\n((BT_STATE_8723A_1ANT_NO_CONNECTION == btState) ||\r\n(BT_STATE_8723A_1ANT_CONNECT_IDLE == btState)) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], [Wifi is idle] or [Bt is non connected idle or Bt is connected idle]!!\n"));\r\nif(BT_STATE_8723A_1ANT_NO_CONNECTION == btState)\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\nelse if(BT_STATE_8723A_1ANT_CONNECT_IDLE == btState)\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\npBtCoexist->btc_setBbReg(pBtCoexist, 0x880, 0xff000000, 0xc0);\r\n}\r\nelse\r\n{\r\nif( (BT_STATE_8723A_1ANT_SCO_ONLY_BUSY == btState) ||\r\n(BT_STATE_8723A_1ANT_ACL_SCO_BUSY == btState) ||\r\n(BT_STATE_8723A_1ANT_HID_BUSY == btState) ||\r\n(BT_STATE_8723A_1ANT_HID_SCO_BUSY == btState) )\r\n{\r\npBtCoexist->btc_setBbReg(pBtCoexist, 0x880, 0xff000000, 0x60);\r\n}\r\nelse\r\n{\r\npBtCoexist->btc_setBbReg(pBtCoexist, 0x880, 0xff000000, 0xc0);\r\n}\r\nswitch(btState)\r\n{\r\ncase BT_STATE_8723A_1ANT_NO_CONNECTION:\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 5);\r\nbreak;\r\ncase BT_STATE_8723A_1ANT_CONNECT_IDLE:\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 12);\r\nbreak;\r\ncase BT_STATE_8723A_1ANT_INQ_OR_PAG:\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 10);\r\nbreak;\r\ncase BT_STATE_8723A_1ANT_SCO_ONLY_BUSY:\r\ncase BT_STATE_8723A_1ANT_ACL_SCO_BUSY:\r\ncase BT_STATE_8723A_1ANT_HID_BUSY:\r\ncase BT_STATE_8723A_1ANT_HID_SCO_BUSY:\r\nhalbtc8723a1ant_TdmaDurationAdjust(pBtCoexist);\r\nbreak;\r\ncase BT_STATE_8723A_1ANT_ACL_ONLY_BUSY:\r\nif (btInfoOriginal&BT_INFO_8723A_1ANT_B_A2DP)\r\n{\r\nhalbtc8723a1ant_TdmaDurationAdjust(pBtCoexist);\r\n}\r\nelse if(btInfoOriginal&BT_INFO_8723A_1ANT_B_FTP)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 1);\r\n}\r\nelse if( (btInfoOriginal&BT_INFO_8723A_1ANT_B_A2DP) &&\r\n(btInfoOriginal&BT_INFO_8723A_1ANT_B_FTP) )\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 6);\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 1);\r\n}\r\nbreak;\r\ndefault:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], error!!!, undefined case in halbtc8723a1ant_CoexForWifiConnect()!!\n"));\r\nbreak;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi is disconnected!!\n"));\r\n}\r\npCoexDm->psTdmaGlobalCnt++;\r\n}\r\nVOID\r\nwa_halbtc8723a1ant_MonitorC2h(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte tmp1b=0x0;\r\nu4Byte curC2hTotalCnt=0x0;\r\nstatic u4Byte preC2hTotalCnt=0x0, sameCntPollingTime=0x0;\r\ncurC2hTotalCnt+=pCoexSta->btInfoC2hCnt[BT_INFO_SRC_8723A_1ANT_BT_RSP];\r\nif(curC2hTotalCnt == preC2hTotalCnt)\r\n{\r\nsameCntPollingTime++;\r\n}\r\nelse\r\n{\r\npreC2hTotalCnt = curC2hTotalCnt;\r\nsameCntPollingTime = 0;\r\n}\r\nif(sameCntPollingTime >= 2)\r\n{\r\ntmp1b = pBtCoexist->btc_read_1byte(pBtCoexist, 0x1af);\r\nif(tmp1b != 0x0)\r\n{\r\npCoexSta->c2hHangDetectCnt++;\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x1af, 0x0);\r\n}\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_InitHwConfig(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], 1Ant Init HW Config!!\n"));\r\npCoexDm->btRf0x1eBackup =\r\npBtCoexist->btc_get_rf_reg(pBtCoexist, BTC_RF_A, 0x1e, 0xfffff);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x40, 0x20);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x76e, 0x4);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x6cc, 0x0);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c8, 0xffff);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c4, 0x55555555);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x858, 0xaaaaaaaa);\r\npBtCoexist->btc_write_2byte(pBtCoexist, 0x860, 0x210);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x870, 0x300);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x874, 0x22804000);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x778, 0x1);\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_InitCoexDm(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], Coex Mechanism Init!!\n"));\r\nhalbtc8723a1ant_InitCoexDm(pBtCoexist);\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_DisplayCoexInfo(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstruct btc_board_info * pBoardInfo=&pBtCoexist->board_info;\r\nPBTC_STACK_INFO pStackInfo=&pBtCoexist->stack_info;\r\npu1Byte cliBuf=pBtCoexist->cli_buf;\r\nu1Byte u1Tmp[4], i, btInfoExt, psTdmaCase=0;\r\nu4Byte u4Tmp[4];\r\nBOOLEAN bRoam=FALSE, bScan=FALSE, bLink=FALSE, bWifiUnder5G=FALSE;\r\nBOOLEAN bBtHsOn=FALSE, bWifiBusy=FALSE;\r\ns4Byte wifiRssi=0, btHsRssi=0;\r\nu4Byte wifiBw, wifiTrafficDir;\r\nu1Byte wifiDot11Chnl, wifiHsChnl;\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n ============[BT Coexist info]============");\r\nCL_PRINTF(cliBuf);\r\nif(!pBoardInfo->bt_exist)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n BT not exists !!!");\r\nCL_PRINTF(cliBuf);\r\nreturn;\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d ", "Ant PG number/ Ant mechanism:", \\r\npBoardInfo->pg_ant_num, pBoardInfo->btdm_ant_num);\r\nCL_PRINTF(cliBuf);\r\nif(pBtCoexist->manual_control)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "[Action Manual control]!!");\r\nCL_PRINTF(cliBuf);\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s / %d", "BT stack/ hci ext ver", \\r\n((pStackInfo->bProfileNotified)? "Yes":"No"), pStackInfo->hciVersion);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U1_WIFI_DOT11_CHNL, &wifiDot11Chnl);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U1_WIFI_HS_CHNL, &wifiHsChnl);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d / %d(%d)", "Dot11 channel / HsChnl(HsMode)", \\r\nwifiDot11Chnl, wifiHsChnl, bBtHsOn);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x ", "H2C Wifi inform bt chnl Info", \\r\npCoexDm->wifiChnlInfo[0], pCoexDm->wifiChnlInfo[1],\r\npCoexDm->wifiChnlInfo[2]);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_S4_WIFI_RSSI, &wifiRssi);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_S4_HS_RSSI, &btHsRssi);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "Wifi rssi/ HS rssi", \\r\nwifiRssi, btHsRssi);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d ", "Wifi bLink/ bRoam/ bScan", \\r\nbLink, bRoam, bScan);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_UNDER_5G, &bWifiUnder5G);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_TRAFFIC_DIRECTION, &wifiTrafficDir);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s / %s/ %s ", "Wifi status", \\r\n(bWifiUnder5G? "5G":"2.4G"),\r\n((BTC_WIFI_BW_LEGACY==wifiBw)? "Legacy": (((BTC_WIFI_BW_HT40==wifiBw)? "HT40":"HT20"))),\r\n((!bWifiBusy)? "idle": ((BTC_WIFI_TRAFFIC_TX==wifiTrafficDir)? "uplink":"downlink")));\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = [%s/ %d/ %d] ", "BT [status/ rssi/ retryCnt]", \\r\n((pCoexSta->bC2hBtInquiryPage)?("inquiry/page scan"):((BT_8723A_1ANT_BT_STATUS_IDLE == pCoexDm->btStatus)? "idle":( (BT_8723A_1ANT_BT_STATUS_CONNECTED_IDLE == pCoexDm->btStatus)? "connected-idle":"busy"))),\r\npCoexSta->btRssi, pCoexSta->btRetryCnt);\r\nCL_PRINTF(cliBuf);\r\nif(pStackInfo->bProfileNotified)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d / %d / %d / %d", "SCO/HID/PAN/A2DP", \\r\npStackInfo->bScoExist, pStackInfo->bHidExist, pStackInfo->bPanExist, pStackInfo->bA2dpExist);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_disp_dbg_msg(pBtCoexist, BTC_DBG_DISP_BT_LINK_INFO);\r\n}\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s", "BT Info A2DP rate", \\r\n(btInfoExt&BIT0)? "Basic rate":"EDR rate");\r\nCL_PRINTF(cliBuf);\r\nfor(i=0; i<BT_INFO_SRC_8723A_1ANT_MAX; i++)\r\n{\r\nif(pCoexSta->btInfoC2hCnt[i])\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x %02x %02x %02x %02x(%d)", GLBtInfoSrc8723a1Ant[i], \\r\npCoexSta->btInfoC2h[i][0], pCoexSta->btInfoC2h[i][1],\r\npCoexSta->btInfoC2h[i][2], pCoexSta->btInfoC2h[i][3],\r\npCoexSta->btInfoC2h[i][4], pCoexSta->btInfoC2h[i][5],\r\npCoexSta->btInfoC2h[i][6], pCoexSta->btInfoC2hCnt[i]);\r\nCL_PRINTF(cliBuf);\r\n}\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d", "write 0x1af=0x0 num", \\r\npCoexSta->c2hHangDetectCnt);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Sw mechanism]============");\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d", "SM1[ShRf/ LpRA/ LimDig]", \\r\npCoexDm->bCurRfRxLpfShrink, pCoexDm->bCurLowPenaltyRa, pCoexDm->limited_dig);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Fw mechanism]============");\r\nCL_PRINTF(cliBuf);\r\nif(!pBtCoexist->manual_control)\r\n{\r\npsTdmaCase = pCoexDm->curPsTdma;\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x %02x %02x case-%d", "PS TDMA", \\r\npCoexDm->psTdmaPara[0], pCoexDm->psTdmaPara[1],\r\npCoexDm->psTdmaPara[2], pCoexDm->psTdmaPara[3],\r\npCoexDm->psTdmaPara[4], psTdmaCase);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d ", "IgnWlanAct", \\r\npCoexDm->bCurIgnoreWlanAct);\r\nCL_PRINTF(cliBuf);\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Hw setting]============");\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "RF-A, 0x1e initVal", \\r\npCoexDm->btRf0x1eBackup);\r\nCL_PRINTF(cliBuf);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x778);\r\nu1Tmp[1] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x783);\r\nu1Tmp[2] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x796);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x/ 0x%x", "0x778/ 0x783/ 0x796", \\r\nu1Tmp[0], u1Tmp[1], u1Tmp[2]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x880);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0x880", \\r\nu4Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x40);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0x40", \\r\nu1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x550);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x522);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x550(bcn ctrl)/0x522", \\r\nu4Tmp[0], u1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x484);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0x484(rate adaptive)", \\r\nu4Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xc50);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0xc50(dig)", \\r\nu4Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xda0);\r\nu4Tmp[1] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xda4);\r\nu4Tmp[2] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xda8);\r\nu4Tmp[3] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xdac);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x/ 0x%x/ 0x%x", "0xda0/0xda4/0xda8/0xdac(FA cnt)", \\r\nu4Tmp[0], u4Tmp[1], u4Tmp[2], u4Tmp[3]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x6c0);\r\nu4Tmp[1] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x6c4);\r\nu4Tmp[2] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x6c8);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x6cc);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x/ 0x%x/ 0x%x", "0x6c0/0x6c4/0x6c8/0x6cc(coexTable)", \\r\nu4Tmp[0], u4Tmp[1], u4Tmp[2], u1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "0x770 (hp rx[31:16]/tx[15:0])", \\r\npCoexSta->highPriorityRx, pCoexSta->highPriorityTx);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "0x774(lp rx[31:16]/tx[15:0])", \\r\npCoexSta->lowPriorityRx, pCoexSta->lowPriorityTx);\r\nCL_PRINTF(cliBuf);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x41b);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0x41b (mgntQ hang chk == 0xf)", \\r\nu1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_disp_dbg_msg(pBtCoexist, BTC_DBG_DISP_COEX_STATISTICS);\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_IpsNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(BTC_IPS_ENTER == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], IPS ENTER notify\n"));\r\nhalbtc8723a1ant_CoexAllOff(pBtCoexist);\r\n}\r\nelse if(BTC_IPS_LEAVE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], IPS LEAVE notify\n"));\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_LpsNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(BTC_LPS_ENABLE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], LPS ENABLE notify\n"));\r\n}\r\nelse if(BTC_LPS_DISABLE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], LPS DISABLE notify\n"));\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_ScanNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nBOOLEAN bWifiConnected=FALSE;\r\nhalbtc8723a1ant_NotifyFwScan(pBtCoexist, type);\r\nif(pBtCoexist->btInfo.bBtDisabled)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\n}\r\nelse\r\n{\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(BTC_SCAN_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], SCAN START notify\n"));\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8723a1ant_Reg0x550Bit3(pBtCoexist, true);\r\n}\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 4);\r\n}\r\nelse if(BTC_SCAN_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], SCAN FINISH notify\n"));\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_CoexForWifiConnect(pBtCoexist);\r\n}\r\n}\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_ConnectNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nBOOLEAN bWifiConnected=FALSE;\r\nif(pBtCoexist->btInfo.bBtDisabled)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\n}\r\nelse\r\n{\r\nif(BTC_ASSOCIATE_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], CONNECT START notify\n"));\r\nhalbtc8723a1ant_Reg0x550Bit3(pBtCoexist, true);\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 8);\r\n}\r\nelse if(BTC_ASSOCIATE_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], CONNECT FINISH notify\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_CoexForWifiConnect(pBtCoexist);\r\n}\r\n}\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_MediaStatusNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(BTC_MEDIA_CONNECT == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], MEDIA connect notify\n"));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], MEDIA disconnect notify\n"));\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_SpecialPacketNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(type == BTC_PACKET_DHCP)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], DHCP Packet notify\n"));\r\nif(pBtCoexist->btInfo.bBtDisabled)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 18);\r\n}\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_BtInfoNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN pu1Byte tmpBuf,\r\nIN u1Byte length\r\n)\r\n{\r\nu1Byte btInfo=0;\r\nu1Byte i, rspSource=0;\r\nBOOLEAN bBtHsOn=FALSE, bBtBusy=FALSE, bForceLps=FALSE;\r\npCoexSta->bC2hBtInfoReqSent = FALSE;\r\nrspSource = BT_INFO_SRC_8723A_1ANT_BT_RSP;\r\npCoexSta->btInfoC2hCnt[rspSource]++;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Bt info[%d], length=%d, hex data=[", rspSource, length));\r\nfor(i=0; i<length; i++)\r\n{\r\npCoexSta->btInfoC2h[rspSource][i] = tmpBuf[i];\r\nif(i == 0)\r\nbtInfo = tmpBuf[i];\r\nif(i == length-1)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("0x%02x]\n", tmpBuf[i]));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("0x%02x, ", tmpBuf[i]));\r\n}\r\n}\r\nif(BT_INFO_SRC_8723A_1ANT_WIFI_FW != rspSource)\r\n{\r\npCoexSta->btRetryCnt =\r\npCoexSta->btInfoC2h[rspSource][1];\r\npCoexSta->btRssi =\r\npCoexSta->btInfoC2h[rspSource][2]*2+10;\r\npCoexSta->btInfoExt =\r\npCoexSta->btInfoC2h[rspSource][3];\r\n}\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(btInfo & BT_INFO_8723A_1ANT_B_INQ_PAGE)\r\n{\r\npCoexSta->bC2hBtInquiryPage = true;\r\n}\r\nelse\r\n{\r\npCoexSta->bC2hBtInquiryPage = FALSE;\r\n}\r\nbtInfo &= ~BIT2;\r\nif(!(btInfo & BIT0))\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_NO_CONNECTION;\r\nbForceLps = FALSE;\r\n}\r\nelse\r\n{\r\nbForceLps = true;\r\nif(btInfo == 0x1)\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_CONNECT_IDLE;\r\n}\r\nelse if(btInfo == 0x9)\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_ACL_ONLY_BUSY;\r\nbBtBusy = true;\r\n}\r\nelse if(btInfo == 0x13)\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_SCO_ONLY_BUSY;\r\nbBtBusy = true;\r\n}\r\nelse if(btInfo == 0x1b)\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_ACL_SCO_BUSY;\r\nbBtBusy = true;\r\n}\r\nelse if(btInfo == 0x29)\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_HID_BUSY;\r\nbBtBusy = true;\r\n}\r\nelse if(btInfo == 0x3b)\r\n{\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_HID_SCO_BUSY;\r\nbBtBusy = true;\r\n}\r\n}\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bBtBusy);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_LIMITED_DIG, &bBtBusy);\r\nif(bForceLps)\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nelse\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_NORMAL_LPS, NULL);\r\nif( (BT_STATE_8723A_1ANT_NO_CONNECTION == pCoexDm->btStatus) ||\r\n(BT_STATE_8723A_1ANT_CONNECT_IDLE == pCoexDm->btStatus) )\r\n{\r\nif(pCoexSta->bC2hBtInquiryPage)\r\npCoexDm->btStatus = BT_STATE_8723A_1ANT_INQ_OR_PAG;\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_StackOperationNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(BTC_STACK_OP_INQ_PAGE_PAIR_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], StackOP Inquiry/page/pair start notify\n"));\r\n}\r\nelse if(BTC_STACK_OP_INQ_PAGE_PAIR_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], StackOP Inquiry/page/pair finish notify\n"));\r\n}\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_HaltNotify(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, FORCE_EXEC, FALSE, 0);\r\nhalbtc8723a1ant_LowPenaltyRa(pBtCoexist, FORCE_EXEC, FALSE);\r\nhalbtc8723a1ant_RfShrink(pBtCoexist, FORCE_EXEC, FALSE);\r\nhalbtc8723a1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, true);\r\nEXhalbtc8723a1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_DISCONNECT);\r\n}\r\nVOID\r\nEXhalbtc8723a1ant_Periodical(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBOOLEAN bScan=FALSE, bLink=FALSE, bRoam=FALSE, bWifiConnected=FALSE;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], 1Ant Periodical!!\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nwa_halbtc8723a1ant_MonitorC2h(pBtCoexist);\r\nhalbtc8723a1ant_QueryBtInfo(pBtCoexist);\r\nhalbtc8723a1ant_MonitorBtCtr(pBtCoexist);\r\nhalbtc8723a1ant_MonitorBtEnableDisable(pBtCoexist);\r\nif(bScan)\r\nreturn;\r\nif(bLink)\r\nreturn;\r\nif(bWifiConnected)\r\n{\r\nif(pBtCoexist->btInfo.bBtDisabled)\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\nhalbtc8723a1ant_LowPenaltyRa(pBtCoexist, NORMAL_EXEC, FALSE);\r\nhalbtc8723a1ant_RfShrink(pBtCoexist, NORMAL_EXEC, FALSE);\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_LowPenaltyRa(pBtCoexist, NORMAL_EXEC, true);\r\nhalbtc8723a1ant_RfShrink(pBtCoexist, NORMAL_EXEC, FALSE);\r\nhalbtc8723a1ant_CoexForWifiConnect(pBtCoexist);\r\n}\r\n}\r\nelse\r\n{\r\nhalbtc8723a1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8723a1ant_LowPenaltyRa(pBtCoexist, NORMAL_EXEC, FALSE);\r\nhalbtc8723a1ant_RfShrink(pBtCoexist, NORMAL_EXEC, FALSE);\r\n}\r\n}

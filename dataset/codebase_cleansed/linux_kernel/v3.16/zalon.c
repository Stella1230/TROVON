static int __init\r\nzalon_probe(struct parisc_device *dev)\r\n{\r\nstruct gsc_irq gsc_irq;\r\nu32 zalon_vers;\r\nint error = -ENODEV;\r\nvoid __iomem *zalon = ioremap_nocache(dev->hpa.start, 4096);\r\nvoid __iomem *io_port = zalon + GSC_SCSI_ZALON_OFFSET;\r\nstatic int unit = 0;\r\nstruct Scsi_Host *host;\r\nstruct ncr_device device;\r\n__raw_writel(CMD_RESET, zalon + IO_MODULE_IO_COMMAND);\r\nwhile (!(__raw_readl(zalon + IO_MODULE_IO_STATUS) & IOSTATUS_RY))\r\ncpu_relax();\r\n__raw_writel(IOIIDATA_MINT5EN | IOIIDATA_PACKEN | IOIIDATA_PREFETCHEN,\r\nzalon + IO_MODULE_II_CDATA);\r\nzalon_vers = (__raw_readl(zalon + IO_MODULE_II_CDATA) >> 24) & 0x07;\r\ndev->irq = gsc_alloc_irq(&gsc_irq);\r\nprintk(KERN_INFO "%s: Zalon version %d, IRQ %d\n", __func__,\r\nzalon_vers, dev->irq);\r\n__raw_writel(gsc_irq.txn_addr | gsc_irq.txn_data, zalon + IO_MODULE_EIM);\r\nif (zalon_vers == 0)\r\nprintk(KERN_WARNING "%s: Zalon 1.1 or earlier\n", __func__);\r\nmemset(&device, 0, sizeof(struct ncr_device));\r\n__raw_writeb(0x20, io_port + 0x38);\r\n__raw_writeb(0x04, io_port + 0x1b);\r\n__raw_writeb(0x80, io_port + 0x22);\r\ndevice.chip = zalon720_chip;\r\ndevice.host_id = 7;\r\ndevice.dev = &dev->dev;\r\ndevice.slot.base = dev->hpa.start + GSC_SCSI_ZALON_OFFSET;\r\ndevice.slot.base_v = io_port;\r\ndevice.slot.irq = dev->irq;\r\ndevice.differential = 2;\r\nhost = ncr_attach(&zalon7xx_template, unit, &device);\r\nif (!host)\r\nreturn -ENODEV;\r\nif (request_irq(dev->irq, ncr53c8xx_intr, IRQF_SHARED, "zalon", host)) {\r\ndev_printk(KERN_ERR, &dev->dev, "irq problem with %d, detaching\n ",\r\ndev->irq);\r\ngoto fail;\r\n}\r\nunit++;\r\ndev_set_drvdata(&dev->dev, host);\r\nerror = scsi_add_host(host, &dev->dev);\r\nif (error)\r\ngoto fail_free_irq;\r\nscsi_scan_host(host);\r\nreturn 0;\r\nfail_free_irq:\r\nfree_irq(dev->irq, host);\r\nfail:\r\nncr53c8xx_release(host);\r\nreturn error;\r\n}\r\nstatic int __exit zalon_remove(struct parisc_device *dev)\r\n{\r\nstruct Scsi_Host *host = dev_get_drvdata(&dev->dev);\r\nscsi_remove_host(host);\r\nncr53c8xx_release(host);\r\nfree_irq(dev->irq, host);\r\nreturn 0;\r\n}\r\nstatic int __init zalon7xx_init(void)\r\n{\r\nint ret = ncr53c8xx_init();\r\nif (!ret)\r\nret = register_parisc_driver(&zalon_driver);\r\nif (ret)\r\nncr53c8xx_exit();\r\nreturn ret;\r\n}\r\nstatic void __exit zalon7xx_exit(void)\r\n{\r\nunregister_parisc_driver(&zalon_driver);\r\nncr53c8xx_exit();\r\n}

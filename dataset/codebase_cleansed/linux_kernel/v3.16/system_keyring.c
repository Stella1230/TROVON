static __init int system_trusted_keyring_init(void)\r\n{\r\npr_notice("Initialise system trusted keyring\n");\r\nsystem_trusted_keyring =\r\nkeyring_alloc(".system_keyring",\r\nKUIDT_INIT(0), KGIDT_INIT(0), current_cred(),\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ | KEY_USR_SEARCH),\r\nKEY_ALLOC_NOT_IN_QUOTA, NULL);\r\nif (IS_ERR(system_trusted_keyring))\r\npanic("Can't allocate system trusted keyring\n");\r\nset_bit(KEY_FLAG_TRUSTED_ONLY, &system_trusted_keyring->flags);\r\nreturn 0;\r\n}\r\nstatic __init int load_system_certificate_list(void)\r\n{\r\nkey_ref_t key;\r\nconst u8 *p, *end;\r\nsize_t plen;\r\npr_notice("Loading compiled-in X.509 certificates\n");\r\np = system_certificate_list;\r\nend = p + system_certificate_list_size;\r\nwhile (p < end) {\r\nif (end - p < 4)\r\ngoto dodgy_cert;\r\nif (p[0] != 0x30 &&\r\np[1] != 0x82)\r\ngoto dodgy_cert;\r\nplen = (p[2] << 8) | p[3];\r\nplen += 4;\r\nif (plen > end - p)\r\ngoto dodgy_cert;\r\nkey = key_create_or_update(make_key_ref(system_trusted_keyring, 1),\r\n"asymmetric",\r\nNULL,\r\np,\r\nplen,\r\n((KEY_POS_ALL & ~KEY_POS_SETATTR) |\r\nKEY_USR_VIEW | KEY_USR_READ),\r\nKEY_ALLOC_NOT_IN_QUOTA |\r\nKEY_ALLOC_TRUSTED);\r\nif (IS_ERR(key)) {\r\npr_err("Problem loading in-kernel X.509 certificate (%ld)\n",\r\nPTR_ERR(key));\r\n} else {\r\npr_notice("Loaded X.509 cert '%s'\n",\r\nkey_ref_to_ptr(key)->description);\r\nkey_ref_put(key);\r\n}\r\np += plen;\r\n}\r\nreturn 0;\r\ndodgy_cert:\r\npr_err("Problem parsing in-kernel X.509 certificate list\n");\r\nreturn 0;\r\n}

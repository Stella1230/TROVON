static void mioa701_lcd_power(int on, struct fb_var_screeninfo *si)\r\n{\r\ngpio_set_value(GPIO87_LCD_POWER, on);\r\n}\r\nstatic int is_gsm_on(void)\r\n{\r\nint is_on;\r\nis_on = !!gpio_get_value(GPIO25_GSM_MOD_ON_STATE);\r\nreturn is_on;\r\n}\r\nirqreturn_t gsm_on_irq(int irq, void *p)\r\n{\r\nprintk(KERN_DEBUG "Mioa701: GSM status changed to %s\n",\r\nis_gsm_on() ? "on" : "off");\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init gsm_init(void)\r\n{\r\nint rc;\r\nrc = gpio_request_array(ARRAY_AND_SIZE(gsm_gpios));\r\nif (rc)\r\ngoto err_gpio;\r\nrc = request_irq(gpio_to_irq(GPIO25_GSM_MOD_ON_STATE), gsm_on_irq,\r\nIRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING,\r\n"GSM XS200 Power Irq", NULL);\r\nif (rc)\r\ngoto err_irq;\r\ngpio_set_wake(GPIO113_GSM_EVENT, 1);\r\nreturn 0;\r\nerr_irq:\r\nprintk(KERN_ERR "Mioa701: Can't request GSM_ON irq\n");\r\ngpio_free_array(ARRAY_AND_SIZE(gsm_gpios));\r\nerr_gpio:\r\nprintk(KERN_ERR "Mioa701: gsm not available\n");\r\nreturn rc;\r\n}\r\nstatic void gsm_exit(void)\r\n{\r\nfree_irq(gpio_to_irq(GPIO25_GSM_MOD_ON_STATE), NULL);\r\ngpio_free_array(ARRAY_AND_SIZE(gsm_gpios));\r\n}\r\nstatic int is_usb_connected(void)\r\n{\r\nreturn !gpio_get_value(GPIO13_nUSB_DETECT);\r\n}\r\nstatic void install_bootstrap(void)\r\n{\r\nint i;\r\nu32 *rom_bootstrap = phys_to_virt(RESUME_VECTOR_ADDR);\r\nu32 *src = &mioa701_bootstrap;\r\nfor (i = 0; i < BOOTSTRAP_WORDS; i++)\r\nrom_bootstrap[i] = src[i];\r\n}\r\nstatic int mioa701_sys_suspend(void)\r\n{\r\nint i = 0, is_bt_on;\r\nu32 *mem_resume_vector = phys_to_virt(RESUME_VECTOR_ADDR);\r\nu32 *mem_resume_enabler = phys_to_virt(RESUME_ENABLE_ADDR);\r\nu32 *mem_resume_bt = phys_to_virt(RESUME_BT_ADDR);\r\nu32 *mem_resume_unknown = phys_to_virt(RESUME_UNKNOWN_ADDR);\r\nis_bt_on = !!gpio_get_value(GPIO83_BT_ON);\r\npxa2xx_mfp_set_lpm(GPIO83_BT_ON,\r\nis_bt_on ? MFP_LPM_DRIVE_HIGH : MFP_LPM_DRIVE_LOW);\r\nfor (i = 0; i < BOOTSTRAP_WORDS; i++)\r\nsave_buffer[i] = mem_resume_vector[i];\r\nsave_buffer[i++] = *mem_resume_enabler;\r\nsave_buffer[i++] = *mem_resume_bt;\r\nsave_buffer[i++] = *mem_resume_unknown;\r\n*mem_resume_enabler = RESUME_ENABLE_VAL;\r\n*mem_resume_bt = is_bt_on;\r\ninstall_bootstrap();\r\nreturn 0;\r\n}\r\nstatic void mioa701_sys_resume(void)\r\n{\r\nint i = 0;\r\nu32 *mem_resume_vector = phys_to_virt(RESUME_VECTOR_ADDR);\r\nu32 *mem_resume_enabler = phys_to_virt(RESUME_ENABLE_ADDR);\r\nu32 *mem_resume_bt = phys_to_virt(RESUME_BT_ADDR);\r\nu32 *mem_resume_unknown = phys_to_virt(RESUME_UNKNOWN_ADDR);\r\nfor (i = 0; i < BOOTSTRAP_WORDS; i++)\r\nmem_resume_vector[i] = save_buffer[i];\r\n*mem_resume_enabler = save_buffer[i++];\r\n*mem_resume_bt = save_buffer[i++];\r\n*mem_resume_unknown = save_buffer[i++];\r\n}\r\nstatic int __init bootstrap_init(void)\r\n{\r\nint save_size = mioa701_bootstrap_lg + (sizeof(u32) * 3);\r\nregister_syscore_ops(&mioa701_syscore_ops);\r\nsave_buffer = kmalloc(save_size, GFP_KERNEL);\r\nif (!save_buffer)\r\nreturn -ENOMEM;\r\nprintk(KERN_INFO "MioA701: allocated %d bytes for bootstrap\n",\r\nsave_size);\r\nreturn 0;\r\n}\r\nstatic void bootstrap_exit(void)\r\n{\r\nkfree(save_buffer);\r\nunregister_syscore_ops(&mioa701_syscore_ops);\r\nprintk(KERN_CRIT "Unregistering mioa701 suspend will hang next"\r\n"resume !!!\n");\r\n}\r\nstatic int is_ac_connected(void)\r\n{\r\nreturn gpio_get_value(GPIO96_AC_DETECT);\r\n}\r\nstatic void mioa701_set_charge(int flags)\r\n{\r\ngpio_set_value(GPIO9_CHARGE_EN, (flags == PDA_POWER_CHARGE_USB));\r\n}\r\nstatic void mioa701_poweroff(void)\r\n{\r\nmioa701_machine_exit();\r\npxa_restart(REBOOT_SOFT, NULL);\r\n}\r\nstatic void mioa701_restart(enum reboot_mode c, const char *cmd)\r\n{\r\nmioa701_machine_exit();\r\npxa_restart(REBOOT_SOFT, cmd);\r\n}\r\nstatic void __init mioa701_machine_init(void)\r\n{\r\nint rc;\r\nPSLR = 0xff100000;\r\nPCFR = PCFR_DC_EN | PCFR_GPR_EN | PCFR_OPDE;\r\nRTTR = 32768 - 1;\r\nUP2OCR = UP2OCR_HXOE;\r\n__raw_writel(0x7ff02dd8, MSC0);\r\n__raw_writel(0x0001c391, MCMEM0);\r\n__raw_writel(0x0001c391, MCATT0);\r\n__raw_writel(0x0001c391, MCIO0);\r\npxa2xx_mfp_config(ARRAY_AND_SIZE(mioa701_pin_config));\r\npxa_set_ffuart_info(NULL);\r\npxa_set_btuart_info(NULL);\r\npxa_set_stuart_info(NULL);\r\nrc = gpio_request_array(ARRAY_AND_SIZE(global_gpios));\r\nif (rc)\r\npr_err("MioA701: Failed to request GPIOs: %d", rc);\r\nbootstrap_init();\r\npxa_set_fb_info(NULL, &mioa701_pxafb_info);\r\npxa_set_mci_info(&mioa701_mci_info);\r\npxa_set_keypad_info(&mioa701_keypad_info);\r\npxa_set_udc_info(&mioa701_udc_info);\r\npxa_set_ac97_info(&mioa701_ac97_info);\r\npm_power_off = mioa701_poweroff;\r\nplatform_add_devices(devices, ARRAY_SIZE(devices));\r\ngsm_init();\r\ni2c_register_board_info(1, ARRAY_AND_SIZE(mioa701_pi2c_devices));\r\npxa_set_i2c_info(&i2c_pdata);\r\npxa27x_set_i2c_power_info(NULL);\r\npxa_set_camera_info(&mioa701_pxacamera_platform_data);\r\nregulator_register_always_on(0, "fixed-5.0V", fixed_5v0_consumers,\r\nARRAY_SIZE(fixed_5v0_consumers),\r\n5000000);\r\n}\r\nstatic void mioa701_machine_exit(void)\r\n{\r\nbootstrap_exit();\r\ngsm_exit();\r\n}

struct fileIdentDesc *udf_fileident_read(struct inode *dir, loff_t *nf_pos,\r\nstruct udf_fileident_bh *fibh,\r\nstruct fileIdentDesc *cfi,\r\nstruct extent_position *epos,\r\nstruct kernel_lb_addr *eloc, uint32_t *elen,\r\nsector_t *offset)\r\n{\r\nstruct fileIdentDesc *fi;\r\nint i, num, block;\r\nstruct buffer_head *tmp, *bha[16];\r\nstruct udf_inode_info *iinfo = UDF_I(dir);\r\nfibh->soffset = fibh->eoffset;\r\nif (iinfo->i_alloc_type == ICBTAG_FLAG_AD_IN_ICB) {\r\nfi = udf_get_fileident(iinfo->i_ext.i_data -\r\n(iinfo->i_efe ?\r\nsizeof(struct extendedFileEntry) :\r\nsizeof(struct fileEntry)),\r\ndir->i_sb->s_blocksize,\r\n&(fibh->eoffset));\r\nif (!fi)\r\nreturn NULL;\r\n*nf_pos += fibh->eoffset - fibh->soffset;\r\nmemcpy((uint8_t *)cfi, (uint8_t *)fi,\r\nsizeof(struct fileIdentDesc));\r\nreturn fi;\r\n}\r\nif (fibh->eoffset == dir->i_sb->s_blocksize) {\r\nint lextoffset = epos->offset;\r\nunsigned char blocksize_bits = dir->i_sb->s_blocksize_bits;\r\nif (udf_next_aext(dir, epos, eloc, elen, 1) !=\r\n(EXT_RECORDED_ALLOCATED >> 30))\r\nreturn NULL;\r\nblock = udf_get_lb_pblock(dir->i_sb, eloc, *offset);\r\n(*offset)++;\r\nif ((*offset << blocksize_bits) >= *elen)\r\n*offset = 0;\r\nelse\r\nepos->offset = lextoffset;\r\nbrelse(fibh->sbh);\r\nfibh->sbh = fibh->ebh = udf_tread(dir->i_sb, block);\r\nif (!fibh->sbh)\r\nreturn NULL;\r\nfibh->soffset = fibh->eoffset = 0;\r\nif (!(*offset & ((16 >> (blocksize_bits - 9)) - 1))) {\r\ni = 16 >> (blocksize_bits - 9);\r\nif (i + *offset > (*elen >> blocksize_bits))\r\ni = (*elen >> blocksize_bits)-*offset;\r\nfor (num = 0; i > 0; i--) {\r\nblock = udf_get_lb_pblock(dir->i_sb, eloc,\r\n*offset + i);\r\ntmp = udf_tgetblk(dir->i_sb, block);\r\nif (tmp && !buffer_uptodate(tmp) &&\r\n!buffer_locked(tmp))\r\nbha[num++] = tmp;\r\nelse\r\nbrelse(tmp);\r\n}\r\nif (num) {\r\nll_rw_block(READA, num, bha);\r\nfor (i = 0; i < num; i++)\r\nbrelse(bha[i]);\r\n}\r\n}\r\n} else if (fibh->sbh != fibh->ebh) {\r\nbrelse(fibh->sbh);\r\nfibh->sbh = fibh->ebh;\r\n}\r\nfi = udf_get_fileident(fibh->sbh->b_data, dir->i_sb->s_blocksize,\r\n&(fibh->eoffset));\r\nif (!fi)\r\nreturn NULL;\r\n*nf_pos += fibh->eoffset - fibh->soffset;\r\nif (fibh->eoffset <= dir->i_sb->s_blocksize) {\r\nmemcpy((uint8_t *)cfi, (uint8_t *)fi,\r\nsizeof(struct fileIdentDesc));\r\n} else if (fibh->eoffset > dir->i_sb->s_blocksize) {\r\nint lextoffset = epos->offset;\r\nif (udf_next_aext(dir, epos, eloc, elen, 1) !=\r\n(EXT_RECORDED_ALLOCATED >> 30))\r\nreturn NULL;\r\nblock = udf_get_lb_pblock(dir->i_sb, eloc, *offset);\r\n(*offset)++;\r\nif ((*offset << dir->i_sb->s_blocksize_bits) >= *elen)\r\n*offset = 0;\r\nelse\r\nepos->offset = lextoffset;\r\nfibh->soffset -= dir->i_sb->s_blocksize;\r\nfibh->eoffset -= dir->i_sb->s_blocksize;\r\nfibh->ebh = udf_tread(dir->i_sb, block);\r\nif (!fibh->ebh)\r\nreturn NULL;\r\nif (sizeof(struct fileIdentDesc) > -fibh->soffset) {\r\nint fi_len;\r\nmemcpy((uint8_t *)cfi, (uint8_t *)fi, -fibh->soffset);\r\nmemcpy((uint8_t *)cfi - fibh->soffset,\r\nfibh->ebh->b_data,\r\nsizeof(struct fileIdentDesc) + fibh->soffset);\r\nfi_len = (sizeof(struct fileIdentDesc) +\r\ncfi->lengthFileIdent +\r\nle16_to_cpu(cfi->lengthOfImpUse) + 3) & ~3;\r\n*nf_pos += fi_len - (fibh->eoffset - fibh->soffset);\r\nfibh->eoffset = fibh->soffset + fi_len;\r\n} else {\r\nmemcpy((uint8_t *)cfi, (uint8_t *)fi,\r\nsizeof(struct fileIdentDesc));\r\n}\r\n}\r\nreturn fi;\r\n}\r\nstruct fileIdentDesc *udf_get_fileident(void *buffer, int bufsize, int *offset)\r\n{\r\nstruct fileIdentDesc *fi;\r\nint lengthThisIdent;\r\nuint8_t *ptr;\r\nint padlen;\r\nif ((!buffer) || (!offset)) {\r\nudf_debug("invalidparms, buffer=%p, offset=%p\n",\r\nbuffer, offset);\r\nreturn NULL;\r\n}\r\nptr = buffer;\r\nif ((*offset > 0) && (*offset < bufsize))\r\nptr += *offset;\r\nfi = (struct fileIdentDesc *)ptr;\r\nif (fi->descTag.tagIdent != cpu_to_le16(TAG_IDENT_FID)) {\r\nudf_debug("0x%x != TAG_IDENT_FID\n",\r\nle16_to_cpu(fi->descTag.tagIdent));\r\nudf_debug("offset: %u sizeof: %lu bufsize: %u\n",\r\n*offset, (unsigned long)sizeof(struct fileIdentDesc),\r\nbufsize);\r\nreturn NULL;\r\n}\r\nif ((*offset + sizeof(struct fileIdentDesc)) > bufsize)\r\nlengthThisIdent = sizeof(struct fileIdentDesc);\r\nelse\r\nlengthThisIdent = sizeof(struct fileIdentDesc) +\r\nfi->lengthFileIdent + le16_to_cpu(fi->lengthOfImpUse);\r\npadlen = lengthThisIdent % UDF_NAME_PAD;\r\nif (padlen)\r\nlengthThisIdent += (UDF_NAME_PAD - padlen);\r\n*offset = *offset + lengthThisIdent;\r\nreturn fi;\r\n}\r\nstruct short_ad *udf_get_fileshortad(uint8_t *ptr, int maxoffset, uint32_t *offset,\r\nint inc)\r\n{\r\nstruct short_ad *sa;\r\nif ((!ptr) || (!offset)) {\r\npr_err("%s: invalidparms\n", __func__);\r\nreturn NULL;\r\n}\r\nif ((*offset + sizeof(struct short_ad)) > maxoffset)\r\nreturn NULL;\r\nelse {\r\nsa = (struct short_ad *)ptr;\r\nif (sa->extLength == 0)\r\nreturn NULL;\r\n}\r\nif (inc)\r\n*offset += sizeof(struct short_ad);\r\nreturn sa;\r\n}\r\nstruct long_ad *udf_get_filelongad(uint8_t *ptr, int maxoffset, uint32_t *offset, int inc)\r\n{\r\nstruct long_ad *la;\r\nif ((!ptr) || (!offset)) {\r\npr_err("%s: invalidparms\n", __func__);\r\nreturn NULL;\r\n}\r\nif ((*offset + sizeof(struct long_ad)) > maxoffset)\r\nreturn NULL;\r\nelse {\r\nla = (struct long_ad *)ptr;\r\nif (la->extLength == 0)\r\nreturn NULL;\r\n}\r\nif (inc)\r\n*offset += sizeof(struct long_ad);\r\nreturn la;\r\n}

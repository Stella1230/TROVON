static int multiq3_ai_status(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inw(dev->iobase + MULTIQ3_STATUS);\r\nif (status & context)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int multiq3_ai_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nint n;\r\nint chan;\r\nunsigned int hi, lo;\r\nint ret;\r\nchan = CR_CHAN(insn->chanspec);\r\noutw(MULTIQ3_CONTROL_MUST | MULTIQ3_AD_MUX_EN | (chan << 3),\r\ndev->iobase + MULTIQ3_CONTROL);\r\nret = comedi_timeout(dev, s, insn, multiq3_ai_status,\r\nMULTIQ3_STATUS_EOC);\r\nif (ret)\r\nreturn ret;\r\nfor (n = 0; n < insn->n; n++) {\r\noutw(0, dev->iobase + MULTIQ3_AD_CS);\r\nret = comedi_timeout(dev, s, insn, multiq3_ai_status,\r\nMULTIQ3_STATUS_EOC_I);\r\nif (ret)\r\nreturn ret;\r\nhi = inb(dev->iobase + MULTIQ3_AD_CS);\r\nlo = inb(dev->iobase + MULTIQ3_AD_CS);\r\ndata[n] = (((hi << 8) | lo) + 0x1000) & 0x1fff;\r\n}\r\nreturn n;\r\n}\r\nstatic int multiq3_ao_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct multiq3_private *devpriv = dev->private;\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int multiq3_ao_insn_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct multiq3_private *devpriv = dev->private;\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\noutw(MULTIQ3_CONTROL_MUST | MULTIQ3_DA_LOAD | chan,\r\ndev->iobase + MULTIQ3_CONTROL);\r\noutw(data[i], dev->iobase + MULTIQ3_DAC_DATA);\r\noutw(MULTIQ3_CONTROL_MUST, dev->iobase + MULTIQ3_CONTROL);\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn i;\r\n}\r\nstatic int multiq3_di_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[1] = inw(dev->iobase + MULTIQ3_DIGIN_PORT);\r\nreturn insn->n;\r\n}\r\nstatic int multiq3_do_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nif (comedi_dio_update_state(s, data))\r\noutw(s->state, dev->iobase + MULTIQ3_DIGOUT_PORT);\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int multiq3_encoder_insn_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nint n;\r\nint chan = CR_CHAN(insn->chanspec);\r\nint control = MULTIQ3_CONTROL_MUST | MULTIQ3_AD_MUX_EN | (chan << 3);\r\nfor (n = 0; n < insn->n; n++) {\r\nint value;\r\noutw(control, dev->iobase + MULTIQ3_CONTROL);\r\noutb(MULTIQ3_BP_RESET, dev->iobase + MULTIQ3_ENC_CONTROL);\r\noutb(MULTIQ3_TRSFRCNTR_OL, dev->iobase + MULTIQ3_ENC_CONTROL);\r\nvalue = inb(dev->iobase + MULTIQ3_ENC_DATA);\r\nvalue |= (inb(dev->iobase + MULTIQ3_ENC_DATA) << 8);\r\nvalue |= (inb(dev->iobase + MULTIQ3_ENC_DATA) << 16);\r\ndata[n] = (value + 0x800000) & 0xffffff;\r\n}\r\nreturn n;\r\n}\r\nstatic void encoder_reset(struct comedi_device *dev)\r\n{\r\nstruct comedi_subdevice *s = &dev->subdevices[4];\r\nint chan;\r\nfor (chan = 0; chan < s->n_chan; chan++) {\r\nint control =\r\nMULTIQ3_CONTROL_MUST | MULTIQ3_AD_MUX_EN | (chan << 3);\r\noutw(control, dev->iobase + MULTIQ3_CONTROL);\r\noutb(MULTIQ3_EFLAG_RESET, dev->iobase + MULTIQ3_ENC_CONTROL);\r\noutb(MULTIQ3_BP_RESET, dev->iobase + MULTIQ3_ENC_CONTROL);\r\noutb(MULTIQ3_CLOCK_DATA, dev->iobase + MULTIQ3_ENC_DATA);\r\noutb(MULTIQ3_CLOCK_SETUP, dev->iobase + MULTIQ3_ENC_CONTROL);\r\noutb(MULTIQ3_INPUT_SETUP, dev->iobase + MULTIQ3_ENC_CONTROL);\r\noutb(MULTIQ3_QUAD_X4, dev->iobase + MULTIQ3_ENC_CONTROL);\r\noutb(MULTIQ3_CNTR_RESET, dev->iobase + MULTIQ3_ENC_CONTROL);\r\n}\r\n}\r\nstatic int multiq3_attach(struct comedi_device *dev,\r\nstruct comedi_devconfig *it)\r\n{\r\nstruct multiq3_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nret = comedi_request_region(dev, it->options[0], MULTIQ3_SIZE);\r\nif (ret)\r\nreturn ret;\r\nret = comedi_alloc_subdevices(dev, 5);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 8;\r\ns->insn_read = multiq3_ai_insn_read;\r\ns->maxdata = 0x1fff;\r\ns->range_table = &range_bipolar5;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 8;\r\ns->insn_read = multiq3_ao_insn_read;\r\ns->insn_write = multiq3_ao_insn_write;\r\ns->maxdata = 0xfff;\r\ns->range_table = &range_bipolar5;\r\ns = &dev->subdevices[2];\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = 16;\r\ns->insn_bits = multiq3_di_insn_bits;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns = &dev->subdevices[3];\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 16;\r\ns->insn_bits = multiq3_do_insn_bits;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->state = 0;\r\ns = &dev->subdevices[4];\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_LSAMPL;\r\ns->n_chan = it->options[2] * 2;\r\ns->insn_read = multiq3_encoder_insn_read;\r\ns->maxdata = 0xffffff;\r\ns->range_table = &range_unknown;\r\nencoder_reset(dev);\r\nreturn 0;\r\n}

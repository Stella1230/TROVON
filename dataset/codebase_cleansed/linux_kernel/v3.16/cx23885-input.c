static void cx23885_input_process_measurements(struct cx23885_dev *dev,\r\nbool overrun)\r\n{\r\nstruct cx23885_kernel_ir *kernel_ir = dev->kernel_ir;\r\nssize_t num;\r\nint count, i;\r\nbool handle = false;\r\nstruct ir_raw_event ir_core_event[64];\r\ndo {\r\nnum = 0;\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_read, (u8 *) ir_core_event,\r\nsizeof(ir_core_event), &num);\r\ncount = num / sizeof(struct ir_raw_event);\r\nfor (i = 0; i < count; i++) {\r\nir_raw_event_store(kernel_ir->rc,\r\n&ir_core_event[i]);\r\nhandle = true;\r\n}\r\n} while (num != 0);\r\nif (overrun)\r\nir_raw_event_reset(kernel_ir->rc);\r\nelse if (handle)\r\nir_raw_event_handle(kernel_ir->rc);\r\n}\r\nvoid cx23885_input_rx_work_handler(struct cx23885_dev *dev, u32 events)\r\n{\r\nstruct v4l2_subdev_ir_parameters params;\r\nint overrun, data_available;\r\nif (dev->sd_ir == NULL || events == 0)\r\nreturn;\r\nswitch (dev->board) {\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1270:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1850:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1290:\r\ncase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\r\ncase CX23885_BOARD_TEVII_S470:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1250:\r\ncase CX23885_BOARD_MYGICA_X8507:\r\ncase CX23885_BOARD_TBS_6980:\r\ncase CX23885_BOARD_TBS_6981:\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\noverrun = events & (V4L2_SUBDEV_IR_RX_SW_FIFO_OVERRUN |\r\nV4L2_SUBDEV_IR_RX_HW_FIFO_OVERRUN);\r\ndata_available = events & (V4L2_SUBDEV_IR_RX_END_OF_RX_DETECTED |\r\nV4L2_SUBDEV_IR_RX_FIFO_SERVICE_REQ);\r\nif (overrun) {\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\r\nparams.enable = false;\r\nparams.shutdown = atomic_read(&dev->ir_input_stopping);\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\r\n}\r\nif (data_available)\r\ncx23885_input_process_measurements(dev, overrun);\r\nif (overrun) {\r\nparams.enable = true;\r\nparams.shutdown = atomic_read(&dev->ir_input_stopping);\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\r\n}\r\n}\r\nstatic int cx23885_input_ir_start(struct cx23885_dev *dev)\r\n{\r\nstruct v4l2_subdev_ir_parameters params;\r\nif (dev->sd_ir == NULL)\r\nreturn -ENODEV;\r\natomic_set(&dev->ir_input_stopping, 0);\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\r\nswitch (dev->board) {\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1270:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1850:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1290:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1250:\r\ncase CX23885_BOARD_MYGICA_X8507:\r\nparams.mode = V4L2_SUBDEV_IR_MODE_PULSE_WIDTH;\r\nparams.enable = true;\r\nparams.interrupt_enable = true;\r\nparams.shutdown = false;\r\nparams.modulation = false;\r\nparams.max_pulse_width = 3333333;\r\nparams.noise_filter_min_width = 333333;\r\nparams.invert_level = true;\r\nbreak;\r\ncase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\r\ncase CX23885_BOARD_TEVII_S470:\r\ncase CX23885_BOARD_TBS_6980:\r\ncase CX23885_BOARD_TBS_6981:\r\nparams.mode = V4L2_SUBDEV_IR_MODE_PULSE_WIDTH;\r\nparams.enable = true;\r\nparams.interrupt_enable = true;\r\nparams.shutdown = false;\r\nparams.carrier_freq = 37917;\r\nparams.carrier_range_lower = 33000;\r\nparams.carrier_range_upper = 43000;\r\nparams.duty_cycle = 33;\r\nparams.max_pulse_width = 12378022;\r\nparams.noise_filter_min_width = 351648;\r\nparams.modulation = false;\r\nparams.invert_level = true;\r\nbreak;\r\n}\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\r\nreturn 0;\r\n}\r\nstatic int cx23885_input_ir_open(struct rc_dev *rc)\r\n{\r\nstruct cx23885_kernel_ir *kernel_ir = rc->priv;\r\nif (kernel_ir->cx == NULL)\r\nreturn -ENODEV;\r\nreturn cx23885_input_ir_start(kernel_ir->cx);\r\n}\r\nstatic void cx23885_input_ir_stop(struct cx23885_dev *dev)\r\n{\r\nstruct v4l2_subdev_ir_parameters params;\r\nif (dev->sd_ir == NULL)\r\nreturn;\r\natomic_set(&dev->ir_input_stopping, 1);\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\r\nwhile (params.shutdown == false) {\r\nparams.enable = false;\r\nparams.interrupt_enable = false;\r\nparams.shutdown = true;\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_s_parameters, &params);\r\nv4l2_subdev_call(dev->sd_ir, ir, rx_g_parameters, &params);\r\n}\r\nflush_work(&dev->cx25840_work);\r\nflush_work(&dev->ir_rx_work);\r\nflush_work(&dev->ir_tx_work);\r\n}\r\nstatic void cx23885_input_ir_close(struct rc_dev *rc)\r\n{\r\nstruct cx23885_kernel_ir *kernel_ir = rc->priv;\r\nif (kernel_ir->cx != NULL)\r\ncx23885_input_ir_stop(kernel_ir->cx);\r\n}\r\nint cx23885_input_init(struct cx23885_dev *dev)\r\n{\r\nstruct cx23885_kernel_ir *kernel_ir;\r\nstruct rc_dev *rc;\r\nchar *rc_map;\r\nenum rc_driver_type driver_type;\r\nunsigned long allowed_protos;\r\nint ret;\r\nif (dev->sd_ir == NULL)\r\nreturn -ENODEV;\r\nswitch (dev->board) {\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1270:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1850:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1290:\r\ncase CX23885_BOARD_HAUPPAUGE_HVR1250:\r\ndriver_type = RC_DRIVER_IR_RAW;\r\nallowed_protos = RC_BIT_ALL;\r\nrc_map = RC_MAP_HAUPPAUGE;\r\nbreak;\r\ncase CX23885_BOARD_TERRATEC_CINERGY_T_PCIE_DUAL:\r\ndriver_type = RC_DRIVER_IR_RAW;\r\nallowed_protos = RC_BIT_NEC;\r\nrc_map = RC_MAP_NEC_TERRATEC_CINERGY_XS;\r\nbreak;\r\ncase CX23885_BOARD_TEVII_S470:\r\ndriver_type = RC_DRIVER_IR_RAW;\r\nallowed_protos = RC_BIT_ALL;\r\nrc_map = RC_MAP_TEVII_NEC;\r\nbreak;\r\ncase CX23885_BOARD_MYGICA_X8507:\r\ndriver_type = RC_DRIVER_IR_RAW;\r\nallowed_protos = RC_BIT_ALL;\r\nrc_map = RC_MAP_TOTAL_MEDIA_IN_HAND_02;\r\nbreak;\r\ncase CX23885_BOARD_TBS_6980:\r\ncase CX23885_BOARD_TBS_6981:\r\ndriver_type = RC_DRIVER_IR_RAW;\r\nallowed_protos = RC_BIT_ALL;\r\nrc_map = RC_MAP_TBS_NEC;\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\nkernel_ir = kzalloc(sizeof(struct cx23885_kernel_ir), GFP_KERNEL);\r\nif (kernel_ir == NULL)\r\nreturn -ENOMEM;\r\nkernel_ir->cx = dev;\r\nkernel_ir->name = kasprintf(GFP_KERNEL, "cx23885 IR (%s)",\r\ncx23885_boards[dev->board].name);\r\nkernel_ir->phys = kasprintf(GFP_KERNEL, "pci-%s/ir0",\r\npci_name(dev->pci));\r\nrc = rc_allocate_device();\r\nif (!rc) {\r\nret = -ENOMEM;\r\ngoto err_out_free;\r\n}\r\nkernel_ir->rc = rc;\r\nrc->input_name = kernel_ir->name;\r\nrc->input_phys = kernel_ir->phys;\r\nrc->input_id.bustype = BUS_PCI;\r\nrc->input_id.version = 1;\r\nif (dev->pci->subsystem_vendor) {\r\nrc->input_id.vendor = dev->pci->subsystem_vendor;\r\nrc->input_id.product = dev->pci->subsystem_device;\r\n} else {\r\nrc->input_id.vendor = dev->pci->vendor;\r\nrc->input_id.product = dev->pci->device;\r\n}\r\nrc->dev.parent = &dev->pci->dev;\r\nrc->driver_type = driver_type;\r\nrc_set_allowed_protocols(rc, allowed_protos);\r\nrc->priv = kernel_ir;\r\nrc->open = cx23885_input_ir_open;\r\nrc->close = cx23885_input_ir_close;\r\nrc->map_name = rc_map;\r\nrc->driver_name = MODULE_NAME;\r\ndev->kernel_ir = kernel_ir;\r\nret = rc_register_device(rc);\r\nif (ret)\r\ngoto err_out_stop;\r\nreturn 0;\r\nerr_out_stop:\r\ncx23885_input_ir_stop(dev);\r\ndev->kernel_ir = NULL;\r\nrc_free_device(rc);\r\nerr_out_free:\r\nkfree(kernel_ir->phys);\r\nkfree(kernel_ir->name);\r\nkfree(kernel_ir);\r\nreturn ret;\r\n}\r\nvoid cx23885_input_fini(struct cx23885_dev *dev)\r\n{\r\ncx23885_input_ir_stop(dev);\r\nif (dev->kernel_ir == NULL)\r\nreturn;\r\nrc_unregister_device(dev->kernel_ir->rc);\r\nkfree(dev->kernel_ir->phys);\r\nkfree(dev->kernel_ir->name);\r\nkfree(dev->kernel_ir);\r\ndev->kernel_ir = NULL;\r\n}

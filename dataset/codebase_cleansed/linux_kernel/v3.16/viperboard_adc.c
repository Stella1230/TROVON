static int vprbrd_iio_read_raw(struct iio_dev *iio_dev,\r\nstruct iio_chan_spec const *chan,\r\nint *val,\r\nint *val2,\r\nlong info)\r\n{\r\nint ret, error = 0;\r\nstruct vprbrd_adc *adc = iio_priv(iio_dev);\r\nstruct vprbrd *vb = adc->vb;\r\nstruct vprbrd_adc_msg *admsg = (struct vprbrd_adc_msg *)vb->buf;\r\nswitch (info) {\r\ncase IIO_CHAN_INFO_RAW:\r\nmutex_lock(&vb->lock);\r\nadmsg->cmd = VPRBRD_ADC_CMD_GET;\r\nadmsg->chan = chan->channel;\r\nadmsg->val = 0x00;\r\nret = usb_control_msg(vb->usb_dev,\r\nusb_sndctrlpipe(vb->usb_dev, 0), VPRBRD_USB_REQUEST_ADC,\r\nVPRBRD_USB_TYPE_OUT, 0x0000, 0x0000, admsg,\r\nsizeof(struct vprbrd_adc_msg), VPRBRD_USB_TIMEOUT_MS);\r\nif (ret != sizeof(struct vprbrd_adc_msg)) {\r\ndev_err(&iio_dev->dev, "usb send error on adc read\n");\r\nerror = -EREMOTEIO;\r\n}\r\nret = usb_control_msg(vb->usb_dev,\r\nusb_rcvctrlpipe(vb->usb_dev, 0), VPRBRD_USB_REQUEST_ADC,\r\nVPRBRD_USB_TYPE_IN, 0x0000, 0x0000, admsg,\r\nsizeof(struct vprbrd_adc_msg), VPRBRD_USB_TIMEOUT_MS);\r\n*val = admsg->val;\r\nmutex_unlock(&vb->lock);\r\nif (ret != sizeof(struct vprbrd_adc_msg)) {\r\ndev_err(&iio_dev->dev, "usb recv error on adc read\n");\r\nerror = -EREMOTEIO;\r\n}\r\nif (error)\r\ngoto error;\r\nreturn IIO_VAL_INT;\r\ndefault:\r\nerror = -EINVAL;\r\nbreak;\r\n}\r\nerror:\r\nreturn error;\r\n}\r\nstatic int vprbrd_adc_probe(struct platform_device *pdev)\r\n{\r\nstruct vprbrd *vb = dev_get_drvdata(pdev->dev.parent);\r\nstruct vprbrd_adc *adc;\r\nstruct iio_dev *indio_dev;\r\nint ret;\r\nindio_dev = devm_iio_device_alloc(&pdev->dev, sizeof(*adc));\r\nif (!indio_dev) {\r\ndev_err(&pdev->dev, "failed allocating iio device\n");\r\nreturn -ENOMEM;\r\n}\r\nadc = iio_priv(indio_dev);\r\nadc->vb = vb;\r\nindio_dev->name = "viperboard adc";\r\nindio_dev->dev.parent = &pdev->dev;\r\nindio_dev->info = &vprbrd_adc_iio_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = vprbrd_adc_iio_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(vprbrd_adc_iio_channels);\r\nret = devm_iio_device_register(&pdev->dev, indio_dev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "could not register iio (adc)");\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}

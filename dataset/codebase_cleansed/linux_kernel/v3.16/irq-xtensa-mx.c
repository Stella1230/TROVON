static int xtensa_mx_irq_map(struct irq_domain *d, unsigned int irq,\r\nirq_hw_number_t hw)\r\n{\r\nif (hw < HW_IRQ_IPI_COUNT) {\r\nstruct irq_chip *irq_chip = d->host_data;\r\nirq_set_chip_and_handler_name(irq, irq_chip,\r\nhandle_percpu_irq, "ipi");\r\nirq_set_status_flags(irq, IRQ_LEVEL);\r\nreturn 0;\r\n}\r\nreturn xtensa_irq_map(d, irq, hw);\r\n}\r\nstatic int xtensa_mx_irq_domain_xlate(struct irq_domain *d,\r\nstruct device_node *ctrlr,\r\nconst u32 *intspec, unsigned int intsize,\r\nunsigned long *out_hwirq, unsigned int *out_type)\r\n{\r\nreturn xtensa_irq_domain_xlate(intspec, intsize,\r\nintspec[0], intspec[0] + HW_IRQ_EXTERN_BASE,\r\nout_hwirq, out_type);\r\n}\r\nvoid secondary_init_irq(void)\r\n{\r\n__this_cpu_write(cached_irq_mask,\r\nXCHAL_INTTYPE_MASK_EXTERN_EDGE |\r\nXCHAL_INTTYPE_MASK_EXTERN_LEVEL);\r\nset_sr(XCHAL_INTTYPE_MASK_EXTERN_EDGE |\r\nXCHAL_INTTYPE_MASK_EXTERN_LEVEL, intenable);\r\n}\r\nstatic void xtensa_mx_irq_mask(struct irq_data *d)\r\n{\r\nunsigned int mask = 1u << d->hwirq;\r\nif (mask & (XCHAL_INTTYPE_MASK_EXTERN_EDGE |\r\nXCHAL_INTTYPE_MASK_EXTERN_LEVEL)) {\r\nset_er(1u << (xtensa_get_ext_irq_no(d->hwirq) -\r\nHW_IRQ_MX_BASE), MIENG);\r\n} else {\r\nmask = __this_cpu_read(cached_irq_mask) & ~mask;\r\n__this_cpu_write(cached_irq_mask, mask);\r\nset_sr(mask, intenable);\r\n}\r\n}\r\nstatic void xtensa_mx_irq_unmask(struct irq_data *d)\r\n{\r\nunsigned int mask = 1u << d->hwirq;\r\nif (mask & (XCHAL_INTTYPE_MASK_EXTERN_EDGE |\r\nXCHAL_INTTYPE_MASK_EXTERN_LEVEL)) {\r\nset_er(1u << (xtensa_get_ext_irq_no(d->hwirq) -\r\nHW_IRQ_MX_BASE), MIENGSET);\r\n} else {\r\nmask |= __this_cpu_read(cached_irq_mask);\r\n__this_cpu_write(cached_irq_mask, mask);\r\nset_sr(mask, intenable);\r\n}\r\n}\r\nstatic void xtensa_mx_irq_enable(struct irq_data *d)\r\n{\r\nvariant_irq_enable(d->hwirq);\r\nxtensa_mx_irq_unmask(d);\r\n}\r\nstatic void xtensa_mx_irq_disable(struct irq_data *d)\r\n{\r\nxtensa_mx_irq_mask(d);\r\nvariant_irq_disable(d->hwirq);\r\n}\r\nstatic void xtensa_mx_irq_ack(struct irq_data *d)\r\n{\r\nset_sr(1 << d->hwirq, intclear);\r\n}\r\nstatic int xtensa_mx_irq_retrigger(struct irq_data *d)\r\n{\r\nset_sr(1 << d->hwirq, intset);\r\nreturn 1;\r\n}\r\nstatic int xtensa_mx_irq_set_affinity(struct irq_data *d,\r\nconst struct cpumask *dest, bool force)\r\n{\r\nunsigned mask = 1u << cpumask_any_and(dest, cpu_online_mask);\r\nset_er(mask, MIROUT(d->hwirq - HW_IRQ_MX_BASE));\r\nreturn 0;\r\n}\r\nint __init xtensa_mx_init_legacy(struct device_node *interrupt_parent)\r\n{\r\nstruct irq_domain *root_domain =\r\nirq_domain_add_legacy(NULL, NR_IRQS, 0, 0,\r\n&xtensa_mx_irq_domain_ops,\r\n&xtensa_mx_irq_chip);\r\nirq_set_default_host(root_domain);\r\nsecondary_init_irq();\r\nreturn 0;\r\n}\r\nstatic int __init xtensa_mx_init(struct device_node *np,\r\nstruct device_node *interrupt_parent)\r\n{\r\nstruct irq_domain *root_domain =\r\nirq_domain_add_linear(np, NR_IRQS, &xtensa_mx_irq_domain_ops,\r\n&xtensa_mx_irq_chip);\r\nirq_set_default_host(root_domain);\r\nsecondary_init_irq();\r\nreturn 0;\r\n}

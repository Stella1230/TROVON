static void\r\nmemx_out(struct nouveau_memx *memx)\r\n{\r\nstruct nouveau_pwr *ppwr = memx->ppwr;\r\nint i;\r\nif (memx->c.size) {\r\nnv_wr32(ppwr, 0x10a1c4, (memx->c.size << 16) | memx->c.mthd);\r\nfor (i = 0; i < memx->c.size; i++)\r\nnv_wr32(ppwr, 0x10a1c4, memx->c.data[i]);\r\nmemx->c.size = 0;\r\n}\r\n}\r\nstatic void\r\nmemx_cmd(struct nouveau_memx *memx, u32 mthd, u32 size, u32 data[])\r\n{\r\nif ((memx->c.size + size >= ARRAY_SIZE(memx->c.data)) ||\r\n(memx->c.size && memx->c.mthd != mthd))\r\nmemx_out(memx);\r\nmemcpy(&memx->c.data[memx->c.size], data, size * sizeof(data[0]));\r\nmemx->c.size += size;\r\nmemx->c.mthd = mthd;\r\n}\r\nint\r\nnouveau_memx_init(struct nouveau_pwr *ppwr, struct nouveau_memx **pmemx)\r\n{\r\nstruct nouveau_memx *memx;\r\nu32 reply[2];\r\nint ret;\r\nret = ppwr->message(ppwr, reply, PROC_MEMX, MEMX_MSG_INFO, 0, 0);\r\nif (ret)\r\nreturn ret;\r\nmemx = *pmemx = kzalloc(sizeof(*memx), GFP_KERNEL);\r\nif (!memx)\r\nreturn -ENOMEM;\r\nmemx->ppwr = ppwr;\r\nmemx->base = reply[0];\r\nmemx->size = reply[1];\r\ndo {\r\nnv_wr32(ppwr, 0x10a580, 0x00000003);\r\n} while (nv_rd32(ppwr, 0x10a580) != 0x00000003);\r\nnv_wr32(ppwr, 0x10a1c0, 0x01000000 | memx->base);\r\nnv_wr32(ppwr, 0x10a1c4, 0x00010000 | MEMX_ENTER);\r\nnv_wr32(ppwr, 0x10a1c4, 0x00000000);\r\nreturn 0;\r\n}\r\nint\r\nnouveau_memx_fini(struct nouveau_memx **pmemx, bool exec)\r\n{\r\nstruct nouveau_memx *memx = *pmemx;\r\nstruct nouveau_pwr *ppwr = memx->ppwr;\r\nu32 finish, reply[2];\r\nmemx_out(memx);\r\nnv_wr32(ppwr, 0x10a1c4, 0x00000000 | MEMX_LEAVE);\r\nfinish = nv_rd32(ppwr, 0x10a1c0) & 0x00ffffff;\r\nnv_wr32(ppwr, 0x10a580, 0x00000000);\r\nif (exec) {\r\nppwr->message(ppwr, reply, PROC_MEMX, MEMX_MSG_EXEC,\r\nmemx->base, finish);\r\n}\r\nkfree(memx);\r\nreturn 0;\r\n}\r\nvoid\r\nnouveau_memx_wr32(struct nouveau_memx *memx, u32 addr, u32 data)\r\n{\r\nnv_debug(memx->ppwr, "R[%06x] = 0x%08x\n", addr, data);\r\nmemx_cmd(memx, MEMX_WR32, 2, (u32[]){ addr, data });\r\n}\r\nvoid\r\nnouveau_memx_wait(struct nouveau_memx *memx,\r\nu32 addr, u32 mask, u32 data, u32 nsec)\r\n{\r\nnv_debug(memx->ppwr, "R[%06x] & 0x%08x == 0x%08x, %d us\n",\r\naddr, mask, data, nsec);\r\nmemx_cmd(memx, MEMX_WAIT, 4, (u32[]){ addr, ~mask, data, nsec });\r\nmemx_out(memx);\r\n}\r\nvoid\r\nnouveau_memx_nsec(struct nouveau_memx *memx, u32 nsec)\r\n{\r\nnv_debug(memx->ppwr, " DELAY = %d ns\n", nsec);\r\nmemx_cmd(memx, MEMX_DELAY, 1, (u32[]){ nsec });\r\nmemx_out(memx);\r\n}

static void\r\nhwsq_cmd(struct nouveau_hwsq *hwsq, int size, u8 data[])\r\n{\r\nmemcpy(&hwsq->c.data[hwsq->c.size], data, size * sizeof(data[0]));\r\nhwsq->c.size += size;\r\n}\r\nint\r\nnouveau_hwsq_init(struct nouveau_bus *pbus, struct nouveau_hwsq **phwsq)\r\n{\r\nstruct nouveau_hwsq *hwsq;\r\nhwsq = *phwsq = kmalloc(sizeof(*hwsq), GFP_KERNEL);\r\nif (hwsq) {\r\nhwsq->pbus = pbus;\r\nhwsq->addr = ~0;\r\nhwsq->data = ~0;\r\nmemset(hwsq->c.data, 0x7f, sizeof(hwsq->c.data));\r\nhwsq->c.size = 0;\r\n}\r\nreturn hwsq ? 0 : -ENOMEM;\r\n}\r\nint\r\nnouveau_hwsq_fini(struct nouveau_hwsq **phwsq, bool exec)\r\n{\r\nstruct nouveau_hwsq *hwsq = *phwsq;\r\nint ret = 0, i;\r\nif (hwsq) {\r\nstruct nouveau_bus *pbus = hwsq->pbus;\r\nhwsq->c.size = (hwsq->c.size + 4) / 4;\r\nif (hwsq->c.size <= pbus->hwsq_size) {\r\nif (exec)\r\nret = pbus->hwsq_exec(pbus, (u32 *)hwsq->c.data,\r\nhwsq->c.size);\r\nif (ret)\r\nnv_error(pbus, "hwsq exec failed: %d\n", ret);\r\n} else {\r\nnv_error(pbus, "hwsq ucode too large\n");\r\nret = -ENOSPC;\r\n}\r\nfor (i = 0; ret && i < hwsq->c.size; i++)\r\nnv_error(pbus, "\t0x%08x\n", ((u32 *)hwsq->c.data)[i]);\r\n*phwsq = NULL;\r\nkfree(hwsq);\r\n}\r\nreturn ret;\r\n}\r\nvoid\r\nnouveau_hwsq_wr32(struct nouveau_hwsq *hwsq, u32 addr, u32 data)\r\n{\r\nnv_debug(hwsq->pbus, "R[%06x] = 0x%08x\n", addr, data);\r\nif (hwsq->data != data) {\r\nif ((data & 0xffff0000) != (hwsq->data & 0xffff0000)) {\r\nhwsq_cmd(hwsq, 5, (u8[]){ 0xe2, data, data >> 8,\r\ndata >> 16, data >> 24 });\r\n} else {\r\nhwsq_cmd(hwsq, 3, (u8[]){ 0x42, data, data >> 8 });\r\n}\r\n}\r\nif ((addr & 0xffff0000) != (hwsq->addr & 0xffff0000)) {\r\nhwsq_cmd(hwsq, 5, (u8[]){ 0xe0, addr, addr >> 8,\r\naddr >> 16, addr >> 24 });\r\n} else {\r\nhwsq_cmd(hwsq, 3, (u8[]){ 0x40, addr, addr >> 8 });\r\n}\r\nhwsq->addr = addr;\r\nhwsq->data = data;\r\n}\r\nvoid\r\nnouveau_hwsq_setf(struct nouveau_hwsq *hwsq, u8 flag, int data)\r\n{\r\nnv_debug(hwsq->pbus, " FLAG[%02x] = %d\n", flag, data);\r\nflag += 0x80;\r\nif (data >= 0)\r\nflag += 0x20;\r\nif (data >= 1)\r\nflag += 0x20;\r\nhwsq_cmd(hwsq, 1, (u8[]){ flag });\r\n}\r\nvoid\r\nnouveau_hwsq_wait(struct nouveau_hwsq *hwsq, u8 flag, u8 data)\r\n{\r\nnv_debug(hwsq->pbus, " WAIT[%02x] = %d\n", flag, data);\r\nhwsq_cmd(hwsq, 3, (u8[]){ 0x5f, flag, data });\r\n}\r\nvoid\r\nnouveau_hwsq_nsec(struct nouveau_hwsq *hwsq, u32 nsec)\r\n{\r\nu8 shift = 0, usec = nsec / 1000;\r\nwhile (usec & ~3) {\r\nusec >>= 2;\r\nshift++;\r\n}\r\nnv_debug(hwsq->pbus, " DELAY = %d ns\n", nsec);\r\nhwsq_cmd(hwsq, 1, (u8[]){ 0x00 | (shift << 2) | usec });\r\n}

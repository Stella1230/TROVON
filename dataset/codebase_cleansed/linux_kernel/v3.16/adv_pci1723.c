static int pci1723_reset(struct comedi_device *dev)\r\n{\r\nstruct pci1723_private *devpriv = dev->private;\r\nint i;\r\noutw(0x01, dev->iobase + PCI1723_SYN_SET);\r\nfor (i = 0; i < 8; i++) {\r\ndevpriv->ao_data[i] = 0x8000;\r\noutw(devpriv->ao_data[i], dev->iobase + PCI1723_DA(i));\r\ndevpriv->da_range[i] = 0;\r\noutw(((devpriv->da_range[i] << 4) | i),\r\nPCI1723_RANGE_CALIBRATION_MODE);\r\n}\r\noutw(0, dev->iobase + PCI1723_CHANGE_CHA_OUTPUT_TYPE_STROBE);\r\noutw(0, dev->iobase + PCI1723_SYN_STROBE);\r\noutw(0, dev->iobase + PCI1723_SYN_SET);\r\nreturn 0;\r\n}\r\nstatic int pci1723_insn_read_ao(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct pci1723_private *devpriv = dev->private;\r\nint n, chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++)\r\ndata[n] = devpriv->ao_data[chan];\r\nreturn n;\r\n}\r\nstatic int pci1723_ao_write_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct pci1723_private *devpriv = dev->private;\r\nint n, chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++) {\r\ndevpriv->ao_data[chan] = data[n];\r\noutw(data[n], dev->iobase + PCI1723_DA(chan));\r\n}\r\nreturn n;\r\n}\r\nstatic int pci1723_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nunsigned int mask;\r\nunsigned short mode;\r\nint ret;\r\nif (chan < 8)\r\nmask = 0x00ff;\r\nelse\r\nmask = 0xff00;\r\nret = comedi_dio_insn_config(dev, s, insn, data, mask);\r\nif (ret)\r\nreturn ret;\r\nmode = 0x0000;\r\nif (!(s->io_bits & 0x00ff))\r\nmode |= 0x0001;\r\nif (!(s->io_bits & 0xff00))\r\nmode |= 0x0002;\r\noutw(mode, dev->iobase + PCI1723_DIGITAL_IO_PORT_SET);\r\nreturn insn->n;\r\n}\r\nstatic int pci1723_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nif (comedi_dio_update_state(s, data))\r\noutw(s->state, dev->iobase + PCI1723_WRITE_DIGITAL_OUTPUT_CMD);\r\ndata[1] = inw(dev->iobase + PCI1723_READ_DIGITAL_INPUT_DATA);\r\nreturn insn->n;\r\n}\r\nstatic int pci1723_auto_attach(struct comedi_device *dev,\r\nunsigned long context_unused)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nstruct pci1723_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndev->iobase = pci_resource_start(pcidev, 2);\r\nret = comedi_alloc_subdevices(dev, 2);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ndev->write_subdev = s;\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITEABLE | SDF_GROUND | SDF_COMMON;\r\ns->n_chan = 8;\r\ns->maxdata = 0xffff;\r\ns->len_chanlist = 8;\r\ns->range_table = &range_bipolar10;\r\ns->insn_write = pci1723_ao_write_winsn;\r\ns->insn_read = pci1723_insn_read_ao;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 16;\r\ns->maxdata = 1;\r\ns->len_chanlist = 16;\r\ns->range_table = &range_digital;\r\ns->insn_config = pci1723_dio_insn_config;\r\ns->insn_bits = pci1723_dio_insn_bits;\r\nswitch (inw(dev->iobase + PCI1723_DIGITAL_IO_PORT_MODE) & 0x03) {\r\ncase 0x00:\r\ns->io_bits = 0xFFFF;\r\nbreak;\r\ncase 0x01:\r\ns->io_bits = 0xFF00;\r\nbreak;\r\ncase 0x02:\r\ns->io_bits = 0x00FF;\r\nbreak;\r\ncase 0x03:\r\ns->io_bits = 0x0000;\r\nbreak;\r\n}\r\ns->state = inw(dev->iobase + PCI1723_READ_DIGITAL_INPUT_DATA);\r\npci1723_reset(dev);\r\nreturn 0;\r\n}\r\nstatic void pci1723_detach(struct comedi_device *dev)\r\n{\r\nif (dev->iobase)\r\npci1723_reset(dev);\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int adv_pci1723_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &adv_pci1723_driver,\r\nid->driver_data);\r\n}

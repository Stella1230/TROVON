static void __init db1550_hw_setup(void)\r\n{\r\nvoid __iomem *base;\r\nbase = (void __iomem *)SYS_CLKSRC;\r\n__raw_writel(__raw_readl(base) | 0x000001e0, base);\r\nbase = (void __iomem *)SYS_PINFUNC;\r\n__raw_writel(__raw_readl(base) | 1 | SYS_PF_PSC1_S1, base);\r\nwmb();\r\nbase = (void __iomem *)KSEG1ADDR(AU1550_PSC1_PHYS_ADDR);\r\n__raw_writel(PSC_SEL_CLK_SERCLK | PSC_SEL_PS_AC97MODE,\r\nbase + PSC_SEL_OFFSET);\r\n__raw_writel(PSC_CTRL_DISABLE, base + PSC_CTRL_OFFSET);\r\nwmb();\r\n__raw_writel(PSC_AC97RST_RST, base + PSC_AC97RST_OFFSET);\r\nwmb();\r\n}\r\nint __init db1550_board_setup(void)\r\n{\r\nunsigned short whoami;\r\nbcsr_init(DB1550_BCSR_PHYS_ADDR,\r\nDB1550_BCSR_PHYS_ADDR + DB1550_BCSR_HEXLED_OFS);\r\nwhoami = bcsr_read(BCSR_WHOAMI);\r\nswitch (BCSR_WHOAMI_BOARD(whoami)) {\r\ncase BCSR_WHOAMI_PB1550_SDR:\r\ncase BCSR_WHOAMI_PB1550_DDR:\r\nbcsr_init(PB1550_BCSR_PHYS_ADDR,\r\nPB1550_BCSR_PHYS_ADDR + PB1550_BCSR_HEXLED_OFS);\r\ncase BCSR_WHOAMI_DB1550:\r\nbreak;\r\ndefault:\r\nreturn -ENODEV;\r\n}\r\npr_info("Alchemy/AMD %s Board, CPLD Rev %d Board-ID %d " \\r\n"Daughtercard ID %d\n", get_system_type(),\r\n(whoami >> 4) & 0xf, (whoami >> 8) & 0xf, whoami & 0xf);\r\ndb1550_hw_setup();\r\nreturn 0;\r\n}\r\nstatic void au1550_nand_cmd_ctrl(struct mtd_info *mtd, int cmd,\r\nunsigned int ctrl)\r\n{\r\nstruct nand_chip *this = mtd->priv;\r\nunsigned long ioaddr = (unsigned long)this->IO_ADDR_W;\r\nioaddr &= 0xffffff00;\r\nif (ctrl & NAND_CLE) {\r\nioaddr += MEM_STNAND_CMD;\r\n} else if (ctrl & NAND_ALE) {\r\nioaddr += MEM_STNAND_ADDR;\r\n} else {\r\nioaddr += MEM_STNAND_DATA;\r\n}\r\nthis->IO_ADDR_R = this->IO_ADDR_W = (void __iomem *)ioaddr;\r\nif (cmd != NAND_CMD_NONE) {\r\n__raw_writeb(cmd, this->IO_ADDR_W);\r\nwmb();\r\n}\r\n}\r\nstatic int au1550_nand_device_ready(struct mtd_info *mtd)\r\n{\r\nreturn __raw_readl((void __iomem *)MEM_STSTAT) & 1;\r\n}\r\nstatic void __init pb1550_nand_setup(void)\r\n{\r\nint boot_swapboot = (au_readl(MEM_STSTAT) & (0x7 << 1)) |\r\n((bcsr_read(BCSR_STATUS) >> 6) & 0x1);\r\ngpio_direction_input(206);\r\nswitch (boot_swapboot) {\r\ncase 0: case 2: case 8: case 0xC: case 0xD:\r\npb1550_nand_pd.devwidth = 1;\r\ncase 1: case 3: case 9: case 0xE: case 0xF:\r\nplatform_device_register(&pb1550_nand_dev);\r\n}\r\n}\r\nstatic void db1550_spi_cs_en(struct au1550_spi_info *spi, int cs, int pol)\r\n{\r\nif (cs)\r\nbcsr_mod(BCSR_BOARD, 0, BCSR_BOARD_SPISEL);\r\nelse\r\nbcsr_mod(BCSR_BOARD, BCSR_BOARD_SPISEL, 0);\r\n}\r\nstatic int db1550_map_pci_irq(const struct pci_dev *d, u8 slot, u8 pin)\r\n{\r\nif ((slot < 11) || (slot > 13) || pin == 0)\r\nreturn -1;\r\nif (slot == 11)\r\nreturn (pin == 1) ? AU1550_PCI_INTC : 0xff;\r\nif (slot == 12) {\r\nswitch (pin) {\r\ncase 1: return AU1550_PCI_INTB;\r\ncase 2: return AU1550_PCI_INTC;\r\ncase 3: return AU1550_PCI_INTD;\r\ncase 4: return AU1550_PCI_INTA;\r\n}\r\n}\r\nif (slot == 13) {\r\nswitch (pin) {\r\ncase 1: return AU1550_PCI_INTA;\r\ncase 2: return AU1550_PCI_INTB;\r\ncase 3: return AU1550_PCI_INTC;\r\ncase 4: return AU1550_PCI_INTD;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nstatic int pb1550_map_pci_irq(const struct pci_dev *d, u8 slot, u8 pin)\r\n{\r\nif ((slot < 12) || (slot > 13) || pin == 0)\r\nreturn -1;\r\nif (slot == 12) {\r\nswitch (pin) {\r\ncase 1: return AU1500_PCI_INTB;\r\ncase 2: return AU1500_PCI_INTC;\r\ncase 3: return AU1500_PCI_INTD;\r\ncase 4: return AU1500_PCI_INTA;\r\n}\r\n}\r\nif (slot == 13) {\r\nswitch (pin) {\r\ncase 1: return AU1500_PCI_INTA;\r\ncase 2: return AU1500_PCI_INTB;\r\ncase 3: return AU1500_PCI_INTC;\r\ncase 4: return AU1500_PCI_INTD;\r\n}\r\n}\r\nreturn -1;\r\n}\r\nint __init db1550_pci_setup(int id)\r\n{\r\nif (id)\r\ndb1550_pci_pd.board_map_irq = pb1550_map_pci_irq;\r\nreturn platform_device_register(&db1550_pci_host_dev);\r\n}\r\nstatic void __init db1550_devices(void)\r\n{\r\nalchemy_gpio_direction_output(203, 0);\r\nirq_set_irq_type(AU1550_GPIO0_INT, IRQ_TYPE_EDGE_BOTH);\r\nirq_set_irq_type(AU1550_GPIO1_INT, IRQ_TYPE_EDGE_BOTH);\r\nirq_set_irq_type(AU1550_GPIO3_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1550_GPIO5_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1550_GPIO21_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1550_GPIO22_INT, IRQ_TYPE_LEVEL_LOW);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x000010000 - 1,\r\nAU1550_GPIO3_INT, AU1550_GPIO0_INT,\r\n0, 0, 0);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x004000000,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x004400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x004000000,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x004400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x004000000,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x004010000 - 1,\r\nAU1550_GPIO5_INT, AU1550_GPIO1_INT,\r\n0, 0, 1);\r\nplatform_device_register(&db1550_nand_dev);\r\nalchemy_gpio_direction_output(202, 0);\r\n}\r\nstatic void __init pb1550_devices(void)\r\n{\r\nirq_set_irq_type(AU1550_GPIO0_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1550_GPIO1_INT, IRQ_TYPE_LEVEL_LOW);\r\nirq_set_irq_type(AU1550_GPIO201_205_INT, IRQ_TYPE_LEVEL_HIGH);\r\nalchemy_gpio2_enable_int(201);\r\nalchemy_gpio2_enable_int(202);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x000400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x000010000 - 1,\r\nAU1550_GPIO201_205_INT, AU1550_GPIO0_INT, 0, 0, 0);\r\ndb1x_register_pcmcia_socket(\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x008000000,\r\nAU1000_PCMCIA_ATTR_PHYS_ADDR + 0x008400000 - 1,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x008000000,\r\nAU1000_PCMCIA_MEM_PHYS_ADDR + 0x008400000 - 1,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x008000000,\r\nAU1000_PCMCIA_IO_PHYS_ADDR + 0x008010000 - 1,\r\nAU1550_GPIO201_205_INT, AU1550_GPIO1_INT, 0, 0, 1);\r\npb1550_nand_setup();\r\n}\r\nint __init db1550_dev_setup(void)\r\n{\r\nint swapped, id;\r\nid = (BCSR_WHOAMI_BOARD(bcsr_read(BCSR_WHOAMI)) != BCSR_WHOAMI_DB1550);\r\ni2c_register_board_info(0, db1550_i2c_devs,\r\nARRAY_SIZE(db1550_i2c_devs));\r\nspi_register_board_info(db1550_spi_devs,\r\nARRAY_SIZE(db1550_i2c_devs));\r\n__raw_writel(PSC_SEL_CLK_SERCLK,\r\n(void __iomem *)KSEG1ADDR(AU1550_PSC1_PHYS_ADDR) + PSC_SEL_OFFSET);\r\nwmb();\r\n__raw_writel(PSC_SEL_CLK_SERCLK,\r\n(void __iomem *)KSEG1ADDR(AU1550_PSC3_PHYS_ADDR) + PSC_SEL_OFFSET);\r\nwmb();\r\n__raw_writel(PSC_SEL_CLK_INTCLK,\r\n(void __iomem *)KSEG1ADDR(AU1550_PSC0_PHYS_ADDR) + PSC_SEL_OFFSET);\r\nwmb();\r\n__raw_writel(PSC_SEL_CLK_INTCLK,\r\n(void __iomem *)KSEG1ADDR(AU1550_PSC2_PHYS_ADDR) + PSC_SEL_OFFSET);\r\nwmb();\r\nid ? pb1550_devices() : db1550_devices();\r\nswapped = bcsr_read(BCSR_STATUS) &\r\n(id ? BCSR_STATUS_PB1550_SWAPBOOT : BCSR_STATUS_DB1000_SWAPBOOT);\r\ndb1x_register_norflash(128 << 20, 4, swapped);\r\nreturn platform_add_devices(db1550_devs, ARRAY_SIZE(db1550_devs));\r\n}

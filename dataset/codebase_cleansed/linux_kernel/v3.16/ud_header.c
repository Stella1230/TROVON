void ib_ud_header_init(int payload_bytes,\r\nint lrh_present,\r\nint eth_present,\r\nint vlan_present,\r\nint grh_present,\r\nint immediate_present,\r\nstruct ib_ud_header *header)\r\n{\r\nmemset(header, 0, sizeof *header);\r\nif (lrh_present) {\r\nu16 packet_length;\r\nheader->lrh.link_version = 0;\r\nheader->lrh.link_next_header =\r\ngrh_present ? IB_LNH_IBA_GLOBAL : IB_LNH_IBA_LOCAL;\r\npacket_length = (IB_LRH_BYTES +\r\nIB_BTH_BYTES +\r\nIB_DETH_BYTES +\r\n(grh_present ? IB_GRH_BYTES : 0) +\r\npayload_bytes +\r\n4 +\r\n3) / 4;\r\nheader->lrh.packet_length = cpu_to_be16(packet_length);\r\n}\r\nif (vlan_present)\r\nheader->eth.type = cpu_to_be16(ETH_P_8021Q);\r\nif (grh_present) {\r\nheader->grh.ip_version = 6;\r\nheader->grh.payload_length =\r\ncpu_to_be16((IB_BTH_BYTES +\r\nIB_DETH_BYTES +\r\npayload_bytes +\r\n4 +\r\n3) & ~3);\r\nheader->grh.next_header = 0x1b;\r\n}\r\nif (immediate_present)\r\nheader->bth.opcode = IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE;\r\nelse\r\nheader->bth.opcode = IB_OPCODE_UD_SEND_ONLY;\r\nheader->bth.pad_count = (4 - payload_bytes) & 3;\r\nheader->bth.transport_header_version = 0;\r\nheader->lrh_present = lrh_present;\r\nheader->eth_present = eth_present;\r\nheader->vlan_present = vlan_present;\r\nheader->grh_present = grh_present;\r\nheader->immediate_present = immediate_present;\r\n}\r\nint ib_ud_header_pack(struct ib_ud_header *header,\r\nvoid *buf)\r\n{\r\nint len = 0;\r\nif (header->lrh_present) {\r\nib_pack(lrh_table, ARRAY_SIZE(lrh_table),\r\n&header->lrh, buf + len);\r\nlen += IB_LRH_BYTES;\r\n}\r\nif (header->eth_present) {\r\nib_pack(eth_table, ARRAY_SIZE(eth_table),\r\n&header->eth, buf + len);\r\nlen += IB_ETH_BYTES;\r\n}\r\nif (header->vlan_present) {\r\nib_pack(vlan_table, ARRAY_SIZE(vlan_table),\r\n&header->vlan, buf + len);\r\nlen += IB_VLAN_BYTES;\r\n}\r\nif (header->grh_present) {\r\nib_pack(grh_table, ARRAY_SIZE(grh_table),\r\n&header->grh, buf + len);\r\nlen += IB_GRH_BYTES;\r\n}\r\nib_pack(bth_table, ARRAY_SIZE(bth_table),\r\n&header->bth, buf + len);\r\nlen += IB_BTH_BYTES;\r\nib_pack(deth_table, ARRAY_SIZE(deth_table),\r\n&header->deth, buf + len);\r\nlen += IB_DETH_BYTES;\r\nif (header->immediate_present) {\r\nmemcpy(buf + len, &header->immediate_data, sizeof header->immediate_data);\r\nlen += sizeof header->immediate_data;\r\n}\r\nreturn len;\r\n}\r\nint ib_ud_header_unpack(void *buf,\r\nstruct ib_ud_header *header)\r\n{\r\nib_unpack(lrh_table, ARRAY_SIZE(lrh_table),\r\nbuf, &header->lrh);\r\nbuf += IB_LRH_BYTES;\r\nif (header->lrh.link_version != 0) {\r\nprintk(KERN_WARNING "Invalid LRH.link_version %d\n",\r\nheader->lrh.link_version);\r\nreturn -EINVAL;\r\n}\r\nswitch (header->lrh.link_next_header) {\r\ncase IB_LNH_IBA_LOCAL:\r\nheader->grh_present = 0;\r\nbreak;\r\ncase IB_LNH_IBA_GLOBAL:\r\nheader->grh_present = 1;\r\nib_unpack(grh_table, ARRAY_SIZE(grh_table),\r\nbuf, &header->grh);\r\nbuf += IB_GRH_BYTES;\r\nif (header->grh.ip_version != 6) {\r\nprintk(KERN_WARNING "Invalid GRH.ip_version %d\n",\r\nheader->grh.ip_version);\r\nreturn -EINVAL;\r\n}\r\nif (header->grh.next_header != 0x1b) {\r\nprintk(KERN_WARNING "Invalid GRH.next_header 0x%02x\n",\r\nheader->grh.next_header);\r\nreturn -EINVAL;\r\n}\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "Invalid LRH.link_next_header %d\n",\r\nheader->lrh.link_next_header);\r\nreturn -EINVAL;\r\n}\r\nib_unpack(bth_table, ARRAY_SIZE(bth_table),\r\nbuf, &header->bth);\r\nbuf += IB_BTH_BYTES;\r\nswitch (header->bth.opcode) {\r\ncase IB_OPCODE_UD_SEND_ONLY:\r\nheader->immediate_present = 0;\r\nbreak;\r\ncase IB_OPCODE_UD_SEND_ONLY_WITH_IMMEDIATE:\r\nheader->immediate_present = 1;\r\nbreak;\r\ndefault:\r\nprintk(KERN_WARNING "Invalid BTH.opcode 0x%02x\n",\r\nheader->bth.opcode);\r\nreturn -EINVAL;\r\n}\r\nif (header->bth.transport_header_version != 0) {\r\nprintk(KERN_WARNING "Invalid BTH.transport_header_version %d\n",\r\nheader->bth.transport_header_version);\r\nreturn -EINVAL;\r\n}\r\nib_unpack(deth_table, ARRAY_SIZE(deth_table),\r\nbuf, &header->deth);\r\nbuf += IB_DETH_BYTES;\r\nif (header->immediate_present)\r\nmemcpy(&header->immediate_data, buf, sizeof header->immediate_data);\r\nreturn 0;\r\n}

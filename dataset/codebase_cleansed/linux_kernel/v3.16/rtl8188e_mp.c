s32 Hal_SetPowerTracking(struct adapter *padapter, u8 enable)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(padapter);\r\nstruct odm_dm_struct *pDM_Odm = &(pHalData->odmpriv);\r\nif (!netif_running(padapter->pnetdev)) {\r\nRT_TRACE(_module_mp_, _drv_warning_,\r\n("SetPowerTracking! Fail: interface not opened!\n"));\r\nreturn _FAIL;\r\n}\r\nif (!check_fwstate(&padapter->mlmepriv, WIFI_MP_STATE)) {\r\nRT_TRACE(_module_mp_, _drv_warning_,\r\n("SetPowerTracking! Fail: not in MP mode!\n"));\r\nreturn _FAIL;\r\n}\r\nif (enable)\r\npDM_Odm->RFCalibrateInfo.bTXPowerTracking = true;\r\nelse\r\npDM_Odm->RFCalibrateInfo.bTXPowerTrackingInit = false;\r\nreturn _SUCCESS;\r\n}\r\nvoid Hal_GetPowerTracking(struct adapter *padapter, u8 *enable)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(padapter);\r\nstruct odm_dm_struct *pDM_Odm = &(pHalData->odmpriv);\r\n*enable = pDM_Odm->RFCalibrateInfo.TxPowerTrackControl;\r\n}\r\nvoid Hal_mpt_SwitchRfSetting(struct adapter *pAdapter)\r\n{\r\nstruct mp_priv *pmp = &pAdapter->mppriv;\r\npmp->MptCtx.backup0x52_RF_A = (u8)PHY_QueryRFReg(pAdapter, RF_PATH_A, RF_0x52, 0x000F0);\r\npmp->MptCtx.backup0x52_RF_B = (u8)PHY_QueryRFReg(pAdapter, RF_PATH_B, RF_0x52, 0x000F0);\r\nPHY_SetRFReg(pAdapter, RF_PATH_A, RF_0x52, 0x000F0, 0xD);\r\nPHY_SetRFReg(pAdapter, RF_PATH_B, RF_0x52, 0x000F0, 0xD);\r\nreturn;\r\n}\r\nvoid Hal_MPT_CCKTxPowerAdjust(struct adapter *Adapter, bool bInCH14)\r\n{\r\nu32 TempVal = 0, TempVal2 = 0, TempVal3 = 0;\r\nu32 CurrCCKSwingVal = 0, CCKSwingIndex = 12;\r\nu8 i;\r\nCurrCCKSwingVal = read_bbreg(Adapter, rCCK0_TxFilter1, bMaskHWord);\r\nif (!bInCH14) {\r\nfor (i = 0; i < CCK_TABLE_SIZE; i++) {\r\nif (((CurrCCKSwingVal&0xff) == (u32)CCKSwingTable_Ch1_Ch13[i][0]) &&\r\n(((CurrCCKSwingVal&0xff00)>>8) == (u32)CCKSwingTable_Ch1_Ch13[i][1])) {\r\nCCKSwingIndex = i;\r\nbreak;\r\n}\r\n}\r\nTempVal = CCKSwingTable_Ch1_Ch13[CCKSwingIndex][0] +\r\n(CCKSwingTable_Ch1_Ch13[CCKSwingIndex][1]<<8);\r\nTempVal2 = CCKSwingTable_Ch1_Ch13[CCKSwingIndex][2] +\r\n(CCKSwingTable_Ch1_Ch13[CCKSwingIndex][3]<<8) +\r\n(CCKSwingTable_Ch1_Ch13[CCKSwingIndex][4]<<16)+\r\n(CCKSwingTable_Ch1_Ch13[CCKSwingIndex][5]<<24);\r\nTempVal3 = CCKSwingTable_Ch1_Ch13[CCKSwingIndex][6] +\r\n(CCKSwingTable_Ch1_Ch13[CCKSwingIndex][7]<<8);\r\n} else {\r\nfor (i = 0; i < CCK_TABLE_SIZE; i++) {\r\nif (((CurrCCKSwingVal&0xff) == (u32)CCKSwingTable_Ch14[i][0]) &&\r\n(((CurrCCKSwingVal&0xff00)>>8) == (u32)CCKSwingTable_Ch14[i][1])) {\r\nCCKSwingIndex = i;\r\nbreak;\r\n}\r\n}\r\nTempVal = CCKSwingTable_Ch14[CCKSwingIndex][0] +\r\n(CCKSwingTable_Ch14[CCKSwingIndex][1]<<8);\r\nTempVal2 = CCKSwingTable_Ch14[CCKSwingIndex][2] +\r\n(CCKSwingTable_Ch14[CCKSwingIndex][3]<<8) +\r\n(CCKSwingTable_Ch14[CCKSwingIndex][4]<<16)+\r\n(CCKSwingTable_Ch14[CCKSwingIndex][5]<<24);\r\nTempVal3 = CCKSwingTable_Ch14[CCKSwingIndex][6] +\r\n(CCKSwingTable_Ch14[CCKSwingIndex][7]<<8);\r\n}\r\nwrite_bbreg(Adapter, rCCK0_TxFilter1, bMaskHWord, TempVal);\r\nwrite_bbreg(Adapter, rCCK0_TxFilter2, bMaskDWord, TempVal2);\r\nwrite_bbreg(Adapter, rCCK0_DebugPort, bMaskLWord, TempVal3);\r\n}\r\nvoid Hal_MPT_CCKTxPowerAdjustbyIndex(struct adapter *pAdapter, bool beven)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nstruct mpt_context *pMptCtx = &pAdapter->mppriv.MptCtx;\r\nstruct odm_dm_struct *pDM_Odm = &(pHalData->odmpriv);\r\ns32 TempCCk;\r\nu8 CCK_index, CCK_index_old = 0;\r\nu8 Action = 0;\r\ns32 i = 0;\r\nif (!IS_92C_SERIAL(pHalData->VersionID))\r\nreturn;\r\nif (beven && !pMptCtx->bMptIndexEven) {\r\nAction = 2;\r\npMptCtx->bMptIndexEven = true;\r\n} else if (!beven && pMptCtx->bMptIndexEven) {\r\nAction = 1;\r\npMptCtx->bMptIndexEven = false;\r\n}\r\nif (Action != 0) {\r\nTempCCk = read_bbreg(pAdapter, rCCK0_TxFilter2, bMaskDWord) & bMaskCCK;\r\nfor (i = 0; i < CCK_TABLE_SIZE; i++) {\r\nif (pDM_Odm->RFCalibrateInfo.bCCKinCH14) {\r\nif (!memcmp((void *)&TempCCk, (void *)&CCKSwingTable_Ch14[i][2], 4)) {\r\nCCK_index_old = (u8)i;\r\nbreak;\r\n}\r\n} else {\r\nif (!memcmp((void *)&TempCCk, (void *)&CCKSwingTable_Ch1_Ch13[i][2], 4)) {\r\nCCK_index_old = (u8)i;\r\nbreak;\r\n}\r\n}\r\n}\r\nif (Action == 1)\r\nCCK_index = CCK_index_old - 1;\r\nelse\r\nCCK_index = CCK_index_old + 1;\r\nif (CCK_index > 32)\r\nCCK_index = 32;\r\nif (!pDM_Odm->RFCalibrateInfo.bCCKinCH14) {\r\nrtw_write8(pAdapter, 0xa22, CCKSwingTable_Ch1_Ch13[CCK_index][0]);\r\nrtw_write8(pAdapter, 0xa23, CCKSwingTable_Ch1_Ch13[CCK_index][1]);\r\nrtw_write8(pAdapter, 0xa24, CCKSwingTable_Ch1_Ch13[CCK_index][2]);\r\nrtw_write8(pAdapter, 0xa25, CCKSwingTable_Ch1_Ch13[CCK_index][3]);\r\nrtw_write8(pAdapter, 0xa26, CCKSwingTable_Ch1_Ch13[CCK_index][4]);\r\nrtw_write8(pAdapter, 0xa27, CCKSwingTable_Ch1_Ch13[CCK_index][5]);\r\nrtw_write8(pAdapter, 0xa28, CCKSwingTable_Ch1_Ch13[CCK_index][6]);\r\nrtw_write8(pAdapter, 0xa29, CCKSwingTable_Ch1_Ch13[CCK_index][7]);\r\n} else {\r\nrtw_write8(pAdapter, 0xa22, CCKSwingTable_Ch14[CCK_index][0]);\r\nrtw_write8(pAdapter, 0xa23, CCKSwingTable_Ch14[CCK_index][1]);\r\nrtw_write8(pAdapter, 0xa24, CCKSwingTable_Ch14[CCK_index][2]);\r\nrtw_write8(pAdapter, 0xa25, CCKSwingTable_Ch14[CCK_index][3]);\r\nrtw_write8(pAdapter, 0xa26, CCKSwingTable_Ch14[CCK_index][4]);\r\nrtw_write8(pAdapter, 0xa27, CCKSwingTable_Ch14[CCK_index][5]);\r\nrtw_write8(pAdapter, 0xa28, CCKSwingTable_Ch14[CCK_index][6]);\r\nrtw_write8(pAdapter, 0xa29, CCKSwingTable_Ch14[CCK_index][7]);\r\n}\r\n}\r\n}\r\nvoid Hal_SetChannel(struct adapter *pAdapter)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nstruct mp_priv *pmp = &pAdapter->mppriv;\r\nstruct odm_dm_struct *pDM_Odm = &(pHalData->odmpriv);\r\nu8 eRFPath;\r\nu8 channel = pmp->channel;\r\nfor (eRFPath = 0; eRFPath < pHalData->NumTotalRFPath; eRFPath++)\r\n_write_rfreg(pAdapter, eRFPath, ODM_CHANNEL, 0x3FF, channel);\r\nHal_mpt_SwitchRfSetting(pAdapter);\r\nSelectChannel(pAdapter, channel);\r\nif (pHalData->CurrentChannel == 14 && !pDM_Odm->RFCalibrateInfo.bCCKinCH14) {\r\npDM_Odm->RFCalibrateInfo.bCCKinCH14 = true;\r\nHal_MPT_CCKTxPowerAdjust(pAdapter, pDM_Odm->RFCalibrateInfo.bCCKinCH14);\r\n} else if (pHalData->CurrentChannel != 14 && pDM_Odm->RFCalibrateInfo.bCCKinCH14) {\r\npDM_Odm->RFCalibrateInfo.bCCKinCH14 = false;\r\nHal_MPT_CCKTxPowerAdjust(pAdapter, pDM_Odm->RFCalibrateInfo.bCCKinCH14);\r\n}\r\n}\r\nvoid Hal_SetBandwidth(struct adapter *pAdapter)\r\n{\r\nstruct mp_priv *pmp = &pAdapter->mppriv;\r\nSetBWMode(pAdapter, pmp->bandwidth, pmp->prime_channel_offset);\r\nHal_mpt_SwitchRfSetting(pAdapter);\r\n}\r\nvoid Hal_SetCCKTxPower(struct adapter *pAdapter, u8 *TxPower)\r\n{\r\nu32 tmpval = 0;\r\nwrite_bbreg(pAdapter, rTxAGC_A_CCK1_Mcs32, bMaskByte1, TxPower[RF_PATH_A]);\r\ntmpval = (TxPower[RF_PATH_A]<<16) | (TxPower[RF_PATH_A]<<8) | TxPower[RF_PATH_A];\r\nwrite_bbreg(pAdapter, rTxAGC_B_CCK11_A_CCK2_11, 0xffffff00, tmpval);\r\nwrite_bbreg(pAdapter, rTxAGC_B_CCK11_A_CCK2_11, bMaskByte0, TxPower[RF_PATH_B]);\r\ntmpval = (TxPower[RF_PATH_B]<<16) | (TxPower[RF_PATH_B]<<8) | TxPower[RF_PATH_B];\r\nwrite_bbreg(pAdapter, rTxAGC_B_CCK1_55_Mcs32, 0xffffff00, tmpval);\r\nRT_TRACE(_module_mp_, _drv_notice_,\r\n("-SetCCKTxPower: A[0x%02x] B[0x%02x]\n",\r\nTxPower[RF_PATH_A], TxPower[RF_PATH_B]));\r\n}\r\nvoid Hal_SetOFDMTxPower(struct adapter *pAdapter, u8 *TxPower)\r\n{\r\nu32 TxAGC = 0;\r\nu8 tmpval = 0;\r\ntmpval = TxPower[RF_PATH_A];\r\nTxAGC = (tmpval<<24) | (tmpval<<16) | (tmpval<<8) | tmpval;\r\nwrite_bbreg(pAdapter, rTxAGC_A_Rate18_06, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_A_Rate54_24, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_A_Mcs03_Mcs00, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_A_Mcs07_Mcs04, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_A_Mcs11_Mcs08, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_A_Mcs15_Mcs12, bMaskDWord, TxAGC);\r\ntmpval = TxPower[RF_PATH_B];\r\nTxAGC = (tmpval<<24) | (tmpval<<16) | (tmpval<<8) | tmpval;\r\nwrite_bbreg(pAdapter, rTxAGC_B_Rate18_06, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_B_Rate54_24, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_B_Mcs03_Mcs00, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_B_Mcs07_Mcs04, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_B_Mcs11_Mcs08, bMaskDWord, TxAGC);\r\nwrite_bbreg(pAdapter, rTxAGC_B_Mcs15_Mcs12, bMaskDWord, TxAGC);\r\n}\r\nvoid Hal_SetAntennaPathPower(struct adapter *pAdapter)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nu8 TxPowerLevel[MAX_RF_PATH_NUMS];\r\nu8 rfPath;\r\nTxPowerLevel[RF_PATH_A] = pAdapter->mppriv.txpoweridx;\r\nTxPowerLevel[RF_PATH_B] = pAdapter->mppriv.txpoweridx_b;\r\nswitch (pAdapter->mppriv.antenna_tx) {\r\ncase ANTENNA_A:\r\ndefault:\r\nrfPath = RF_PATH_A;\r\nbreak;\r\ncase ANTENNA_B:\r\nrfPath = RF_PATH_B;\r\nbreak;\r\ncase ANTENNA_C:\r\nrfPath = RF_PATH_C;\r\nbreak;\r\n}\r\nswitch (pHalData->rf_chip) {\r\ncase RF_8225:\r\ncase RF_8256:\r\ncase RF_6052:\r\nHal_SetCCKTxPower(pAdapter, TxPowerLevel);\r\nif (pAdapter->mppriv.rateidx < MPT_RATE_6M)\r\nHal_MPT_CCKTxPowerAdjustbyIndex(pAdapter, TxPowerLevel[rfPath]%2 == 0);\r\nHal_SetOFDMTxPower(pAdapter, TxPowerLevel);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid Hal_SetTxPower(struct adapter *pAdapter)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nu8 TxPower = pAdapter->mppriv.txpoweridx;\r\nu8 TxPowerLevel[MAX_RF_PATH_NUMS];\r\nu8 rf, rfPath;\r\nfor (rf = 0; rf < MAX_RF_PATH_NUMS; rf++)\r\nTxPowerLevel[rf] = TxPower;\r\nswitch (pAdapter->mppriv.antenna_tx) {\r\ncase ANTENNA_A:\r\ndefault:\r\nrfPath = RF_PATH_A;\r\nbreak;\r\ncase ANTENNA_B:\r\nrfPath = RF_PATH_B;\r\nbreak;\r\ncase ANTENNA_C:\r\nrfPath = RF_PATH_C;\r\nbreak;\r\n}\r\nswitch (pHalData->rf_chip) {\r\ncase RF_8225:\r\ncase RF_8256:\r\ncase RF_6052:\r\nHal_SetCCKTxPower(pAdapter, TxPowerLevel);\r\nif (pAdapter->mppriv.rateidx < MPT_RATE_6M)\r\nHal_MPT_CCKTxPowerAdjustbyIndex(pAdapter, TxPowerLevel[rfPath]%2 == 0);\r\nHal_SetOFDMTxPower(pAdapter, TxPowerLevel);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nvoid Hal_SetDataRate(struct adapter *pAdapter)\r\n{\r\nHal_mpt_SwitchRfSetting(pAdapter);\r\n}\r\nvoid Hal_SetAntenna(struct adapter *pAdapter)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nstruct ant_sel_ofdm *p_ofdm_tx;\r\nstruct ant_sel_cck *p_cck_txrx;\r\nu8 r_rx_antenna_ofdm = 0, r_ant_select_cck_val = 0;\r\nu8 chgTx = 0, chgRx = 0;\r\nu32 r_ant_select_ofdm_val = 0, r_ofdm_tx_en_val = 0;\r\np_ofdm_tx = (struct ant_sel_ofdm *)&r_ant_select_ofdm_val;\r\np_cck_txrx = (struct ant_sel_cck *)&r_ant_select_cck_val;\r\np_ofdm_tx->r_ant_ht1 = 0x1;\r\np_ofdm_tx->r_ant_ht2 = 0x2;\r\np_ofdm_tx->r_ant_non_ht = 0x3;\r\nswitch (pAdapter->mppriv.antenna_tx) {\r\ncase ANTENNA_A:\r\np_ofdm_tx->r_tx_antenna = 0x1;\r\nr_ofdm_tx_en_val = 0x1;\r\np_ofdm_tx->r_ant_l = 0x1;\r\np_ofdm_tx->r_ant_ht_s1 = 0x1;\r\np_ofdm_tx->r_ant_non_ht_s1 = 0x1;\r\np_cck_txrx->r_ccktx_enable = 0x8;\r\nchgTx = 1;\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 2);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 1);\r\nr_ofdm_tx_en_val = 0x3;\r\nif (pHalData->rf_type == RF_2T2R) {\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFInterfaceSW, BIT10, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFInterfaceSW, BIT26, 1);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XB_RFInterfaceOE, BIT10, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFParameter, BIT1, 1);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFParameter, BIT17, 0);\r\n}\r\nbreak;\r\ncase ANTENNA_B:\r\np_ofdm_tx->r_tx_antenna = 0x2;\r\nr_ofdm_tx_en_val = 0x2;\r\np_ofdm_tx->r_ant_l = 0x2;\r\np_ofdm_tx->r_ant_ht_s1 = 0x2;\r\np_ofdm_tx->r_ant_non_ht_s1 = 0x2;\r\np_cck_txrx->r_ccktx_enable = 0x4;\r\nchgTx = 1;\r\nPHY_SetBBReg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 1);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 2);\r\nif (pHalData->rf_type == RF_2T2R || pHalData->rf_type == RF_1T2R) {\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFInterfaceSW, BIT10, 1);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XA_RFInterfaceOE, BIT10, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFInterfaceSW, BIT26, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFParameter, BIT1, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFParameter, BIT17, 1);\r\n}\r\nbreak;\r\ncase ANTENNA_AB:\r\np_ofdm_tx->r_tx_antenna = 0x3;\r\nr_ofdm_tx_en_val = 0x3;\r\np_ofdm_tx->r_ant_l = 0x3;\r\np_ofdm_tx->r_ant_ht_s1 = 0x3;\r\np_ofdm_tx->r_ant_non_ht_s1 = 0x3;\r\np_cck_txrx->r_ccktx_enable = 0xC;\r\nchgTx = 1;\r\nPHY_SetBBReg(pAdapter, rFPGA0_XA_HSSIParameter2, 0xe, 2);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XB_HSSIParameter2, 0xe, 2);\r\nif (pHalData->rf_type == RF_2T2R) {\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFInterfaceSW, BIT10, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFInterfaceSW, BIT26, 0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFParameter, BIT1, 1);\r\nPHY_SetBBReg(pAdapter, rFPGA0_XAB_RFParameter, BIT17, 1);\r\n}\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nswitch (pAdapter->mppriv.antenna_rx) {\r\ncase ANTENNA_A:\r\nr_rx_antenna_ofdm = 0x1;\r\np_cck_txrx->r_cckrx_enable = 0x0;\r\np_cck_txrx->r_cckrx_enable_2 = 0x0;\r\nchgRx = 1;\r\nbreak;\r\ncase ANTENNA_B:\r\nr_rx_antenna_ofdm = 0x2;\r\np_cck_txrx->r_cckrx_enable = 0x1;\r\np_cck_txrx->r_cckrx_enable_2 = 0x1;\r\nchgRx = 1;\r\nbreak;\r\ncase ANTENNA_AB:\r\nr_rx_antenna_ofdm = 0x3;\r\np_cck_txrx->r_cckrx_enable = 0x0;\r\np_cck_txrx->r_cckrx_enable_2 = 0x1;\r\nchgRx = 1;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nif (chgTx && chgRx) {\r\nswitch (pHalData->rf_chip) {\r\ncase RF_8225:\r\ncase RF_8256:\r\ncase RF_6052:\r\nPHY_SetBBReg(pAdapter, rFPGA1_TxInfo, 0x7fffffff, r_ant_select_ofdm_val);\r\nPHY_SetBBReg(pAdapter, rFPGA0_TxInfo, 0x0000000f, r_ofdm_tx_en_val);\r\nPHY_SetBBReg(pAdapter, rOFDM0_TRxPathEnable, 0x0000000f, r_rx_antenna_ofdm);\r\nPHY_SetBBReg(pAdapter, rOFDM1_TRxPathEnable, 0x0000000f, r_rx_antenna_ofdm);\r\nPHY_SetBBReg(pAdapter, rCCK0_AFESetting, bMaskByte3, r_ant_select_cck_val);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nRT_TRACE(_module_mp_, _drv_notice_, ("-SwitchAntenna: finished\n"));\r\n}\r\ns32 Hal_SetThermalMeter(struct adapter *pAdapter, u8 target_ther)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nif (!netif_running(pAdapter->pnetdev)) {\r\nRT_TRACE(_module_mp_, _drv_warning_, ("SetThermalMeter! Fail: interface not opened!\n"));\r\nreturn _FAIL;\r\n}\r\nif (check_fwstate(&pAdapter->mlmepriv, WIFI_MP_STATE) == false) {\r\nRT_TRACE(_module_mp_, _drv_warning_, ("SetThermalMeter: Fail! not in MP mode!\n"));\r\nreturn _FAIL;\r\n}\r\ntarget_ther &= 0xff;\r\nif (target_ther < 0x07)\r\ntarget_ther = 0x07;\r\nelse if (target_ther > 0x1d)\r\ntarget_ther = 0x1d;\r\npHalData->EEPROMThermalMeter = target_ther;\r\nreturn _SUCCESS;\r\n}\r\nvoid Hal_TriggerRFThermalMeter(struct adapter *pAdapter)\r\n{\r\n_write_rfreg(pAdapter, RF_PATH_A , RF_T_METER_88E , BIT17 | BIT16 , 0x03);\r\n}\r\nu8 Hal_ReadRFThermalMeter(struct adapter *pAdapter)\r\n{\r\nu32 ThermalValue = 0;\r\nThermalValue = _read_rfreg(pAdapter, RF_PATH_A, RF_T_METER_88E, 0xfc00);\r\nreturn (u8)ThermalValue;\r\n}\r\nvoid Hal_GetThermalMeter(struct adapter *pAdapter, u8 *value)\r\n{\r\nHal_TriggerRFThermalMeter(pAdapter);\r\nmsleep(1000);\r\n*value = Hal_ReadRFThermalMeter(pAdapter);\r\n}\r\nvoid Hal_SetSingleCarrierTx(struct adapter *pAdapter, u8 bStart)\r\n{\r\npAdapter->mppriv.MptCtx.bSingleCarrier = bStart;\r\nif (bStart) {\r\nRT_TRACE(_module_mp_, _drv_alert_, ("SetSingleCarrierTx: test start\n"));\r\nif (!read_bbreg(pAdapter, rFPGA0_RFMOD, bOFDMEn))\r\nwrite_bbreg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKBBMode, bDisable);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bEnable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000500);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000500);\r\n} else {\r\nRT_TRACE(_module_mp_, _drv_alert_, ("SetSingleCarrierTx: test stop\n"));\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nmsleep(10);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000100);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000100);\r\n}\r\n}\r\nvoid Hal_SetSingleToneTx(struct adapter *pAdapter, u8 bStart)\r\n{\r\nstruct hal_data_8188e *pHalData = GET_HAL_DATA(pAdapter);\r\nbool is92C = IS_92C_SERIAL(pHalData->VersionID);\r\nu8 rfPath;\r\nu32 reg58 = 0x0;\r\nswitch (pAdapter->mppriv.antenna_tx) {\r\ncase ANTENNA_A:\r\ndefault:\r\nrfPath = RF_PATH_A;\r\nbreak;\r\ncase ANTENNA_B:\r\nrfPath = RF_PATH_B;\r\nbreak;\r\ncase ANTENNA_C:\r\nrfPath = RF_PATH_C;\r\nbreak;\r\n}\r\npAdapter->mppriv.MptCtx.bSingleTone = bStart;\r\nif (bStart) {\r\nRT_TRACE(_module_mp_, _drv_alert_, ("SetSingleToneTx: test start\n"));\r\nreg58 = PHY_QueryRFReg(pAdapter, RF_PATH_A, LNA_Low_Gain_3, bRFRegOffsetMask);\r\nreg58 &= 0xFFFFFFF0;\r\nreg58 += 2;\r\nPHY_SetRFReg(pAdapter, RF_PATH_A, LNA_Low_Gain_3, bRFRegOffsetMask, reg58);\r\nPHY_SetBBReg(pAdapter, rFPGA0_RFMOD, bCCKEn, 0x0);\r\nPHY_SetBBReg(pAdapter, rFPGA0_RFMOD, bOFDMEn, 0x0);\r\nif (is92C) {\r\n_write_rfreg(pAdapter, RF_PATH_A, 0x21, BIT19, 0x01);\r\nmsleep(1);\r\nif (rfPath == RF_PATH_A)\r\nwrite_rfreg(pAdapter, RF_PATH_B, 0x00, 0x10000);\r\nelse if (rfPath == RF_PATH_B)\r\nwrite_rfreg(pAdapter, RF_PATH_A, 0x00, 0x10000);\r\nwrite_rfreg(pAdapter, rfPath, 0x00, 0x2001f);\r\nmsleep(1);\r\n} else {\r\nwrite_rfreg(pAdapter, rfPath, 0x21, 0xd4000);\r\nmsleep(1);\r\nwrite_rfreg(pAdapter, rfPath, 0x00, 0x2001f);\r\nmsleep(1);\r\n}\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000500);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000500);\r\n} else {\r\nRT_TRACE(_module_mp_, _drv_alert_, ("SetSingleToneTx: test stop\n"));\r\nreg58 = PHY_QueryRFReg(pAdapter, RF_PATH_A, LNA_Low_Gain_3, bRFRegOffsetMask);\r\nreg58 &= 0xFFFFFFF0;\r\nPHY_SetRFReg(pAdapter, RF_PATH_A, LNA_Low_Gain_3, bRFRegOffsetMask, reg58);\r\nwrite_bbreg(pAdapter, rFPGA0_RFMOD, bCCKEn, 0x1);\r\nwrite_bbreg(pAdapter, rFPGA0_RFMOD, bOFDMEn, 0x1);\r\nif (is92C) {\r\n_write_rfreg(pAdapter, RF_PATH_A, 0x21, BIT19, 0x00);\r\nmsleep(1);\r\nwrite_rfreg(pAdapter, RF_PATH_A, 0x00, 0x32d75);\r\nwrite_rfreg(pAdapter, RF_PATH_B, 0x00, 0x32d75);\r\nmsleep(1);\r\n} else {\r\nwrite_rfreg(pAdapter, rfPath, 0x21, 0x54000);\r\nmsleep(1);\r\nwrite_rfreg(pAdapter, rfPath, 0x00, 0x30000);\r\nmsleep(1);\r\n}\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000100);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000100);\r\n}\r\n}\r\nvoid Hal_SetCarrierSuppressionTx(struct adapter *pAdapter, u8 bStart)\r\n{\r\npAdapter->mppriv.MptCtx.bCarrierSuppression = bStart;\r\nif (bStart) {\r\nRT_TRACE(_module_mp_, _drv_alert_, ("SetCarrierSuppressionTx: test start\n"));\r\nif (pAdapter->mppriv.rateidx <= MPT_RATE_11M) {\r\nif (!read_bbreg(pAdapter, rFPGA0_RFMOD, bCCKEn))\r\nwrite_bbreg(pAdapter, rFPGA0_RFMOD, bCCKEn, bEnable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKBBMode, 0x2);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKScramble, 0x0);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKTxRate, 0x0);\r\n}\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000500);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000500);\r\n} else {\r\nRT_TRACE(_module_mp_, _drv_alert_, ("SetCarrierSuppressionTx: test stop\n"));\r\nif (pAdapter->mppriv.rateidx <= MPT_RATE_11M) {\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKBBMode, 0x0);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKScramble, 0x1);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\n}\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000100);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000100);\r\n}\r\n}\r\nvoid Hal_SetCCKContinuousTx(struct adapter *pAdapter, u8 bStart)\r\n{\r\nu32 cckrate;\r\nif (bStart) {\r\nRT_TRACE(_module_mp_, _drv_alert_,\r\n("SetCCKContinuousTx: test start\n"));\r\nif (!read_bbreg(pAdapter, rFPGA0_RFMOD, bCCKEn))\r\nwrite_bbreg(pAdapter, rFPGA0_RFMOD, bCCKEn, bEnable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\ncckrate = pAdapter->mppriv.rateidx;\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKTxRate, cckrate);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKBBMode, 0x2);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000500);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000500);\r\n} else {\r\nRT_TRACE(_module_mp_, _drv_info_,\r\n("SetCCKContinuousTx: test stop\n"));\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKBBMode, 0x0);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000100);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000100);\r\n}\r\npAdapter->mppriv.MptCtx.bCckContTx = bStart;\r\npAdapter->mppriv.MptCtx.bOfdmContTx = false;\r\n}\r\nvoid Hal_SetOFDMContinuousTx(struct adapter *pAdapter, u8 bStart)\r\n{\r\nif (bStart) {\r\nRT_TRACE(_module_mp_, _drv_info_, ("SetOFDMContinuousTx: test start\n"));\r\nif (!read_bbreg(pAdapter, rFPGA0_RFMOD, bOFDMEn))\r\nwrite_bbreg(pAdapter, rFPGA0_RFMOD, bOFDMEn, bEnable);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKBBMode, bDisable);\r\nwrite_bbreg(pAdapter, rCCK0_System, bCCKScramble, bEnable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bEnable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000500);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000500);\r\n} else {\r\nRT_TRACE(_module_mp_, _drv_info_, ("SetOFDMContinuousTx: test stop\n"));\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMContinueTx, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleCarrier, bDisable);\r\nwrite_bbreg(pAdapter, rOFDM1_LSTF, bOFDMSingleTone, bDisable);\r\nmsleep(10);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x0);\r\nwrite_bbreg(pAdapter, rPMAC_Reset, bBBResetB, 0x1);\r\nwrite_bbreg(pAdapter, rFPGA0_XA_HSSIParameter1, bMaskDWord, 0x01000100);\r\nwrite_bbreg(pAdapter, rFPGA0_XB_HSSIParameter1, bMaskDWord, 0x01000100);\r\n}\r\npAdapter->mppriv.MptCtx.bCckContTx = false;\r\npAdapter->mppriv.MptCtx.bOfdmContTx = bStart;\r\n}\r\nvoid Hal_SetContinuousTx(struct adapter *pAdapter, u8 bStart)\r\n{\r\nRT_TRACE(_module_mp_, _drv_info_,\r\n("SetContinuousTx: rate:%d\n", pAdapter->mppriv.rateidx));\r\npAdapter->mppriv.MptCtx.bStartContTx = bStart;\r\nif (pAdapter->mppriv.rateidx <= MPT_RATE_11M)\r\nHal_SetCCKContinuousTx(pAdapter, bStart);\r\nelse if ((pAdapter->mppriv.rateidx >= MPT_RATE_6M) &&\r\n(pAdapter->mppriv.rateidx <= MPT_RATE_MCS15))\r\nHal_SetOFDMContinuousTx(pAdapter, bStart);\r\n}

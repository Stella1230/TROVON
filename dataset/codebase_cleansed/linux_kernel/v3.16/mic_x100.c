u32 mic_read_spad(struct mic_device *mdev, unsigned int idx)\r\n{\r\nreturn mic_mmio_read(&mdev->mmio,\r\nMIC_X100_SBOX_BASE_ADDRESS +\r\nMIC_X100_SBOX_SPAD0 + idx * 4);\r\n}\r\nvoid mic_send_intr(struct mic_device *mdev, int doorbell)\r\n{\r\nstruct mic_mw *mw = &mdev->mmio;\r\nif (doorbell > MIC_X100_MAX_DOORBELL_IDX)\r\nreturn;\r\nwmb();\r\nmic_mmio_write(mw, MIC_X100_SBOX_SDBIC0_DBREQ_BIT,\r\nMIC_X100_SBOX_BASE_ADDRESS +\r\n(MIC_X100_SBOX_SDBIC0 + (4 * doorbell)));\r\n}\r\nu32 mic_ack_interrupt(struct mic_device *mdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic inline int mic_get_sbox_irq(int db)\r\n{\r\nreturn MIC_X100_IRQ_BASE + db;\r\n}\r\nstatic inline int mic_get_rdmasr_irq(int index)\r\n{\r\nreturn MIC_X100_RDMASR_IRQ_BASE + index;\r\n}\r\nvoid mic_hw_intr_init(struct mic_driver *mdrv)\r\n{\r\nmdrv->intr_info.num_intr = MIC_X100_NUM_SBOX_IRQ +\r\nMIC_X100_NUM_RDMASR_IRQ;\r\n}\r\nint mic_db_to_irq(struct mic_driver *mdrv, int db)\r\n{\r\nint rdmasr_index;\r\nif (db < MIC_X100_NUM_SBOX_IRQ) {\r\nreturn mic_get_sbox_irq(db);\r\n} else {\r\nrdmasr_index = db - MIC_X100_NUM_SBOX_IRQ +\r\nMIC_X100_RDMASR_IRQ_BASE;\r\nreturn mic_get_rdmasr_irq(rdmasr_index);\r\n}\r\n}\r\nvoid __iomem *\r\nmic_card_map(struct mic_device *mdev, dma_addr_t addr, size_t size)\r\n{\r\nreturn ioremap(addr, size);\r\n}\r\nvoid mic_card_unmap(struct mic_device *mdev, void __iomem *addr)\r\n{\r\niounmap(addr);\r\n}\r\nstatic int __init mic_probe(struct platform_device *pdev)\r\n{\r\nstruct mic_driver *mdrv = &g_drv;\r\nstruct mic_device *mdev = &mdrv->mdev;\r\nint rc = 0;\r\nmdrv->dev = &pdev->dev;\r\nsnprintf(mdrv->name, sizeof(mic_driver_name), mic_driver_name);\r\nmdev->mmio.pa = MIC_X100_MMIO_BASE;\r\nmdev->mmio.len = MIC_X100_MMIO_LEN;\r\nmdev->mmio.va = ioremap(MIC_X100_MMIO_BASE, MIC_X100_MMIO_LEN);\r\nif (!mdev->mmio.va) {\r\ndev_err(&pdev->dev, "Cannot remap MMIO BAR\n");\r\nrc = -EIO;\r\ngoto done;\r\n}\r\nmic_hw_intr_init(mdrv);\r\nrc = mic_driver_init(mdrv);\r\nif (rc) {\r\ndev_err(&pdev->dev, "mic_driver_init failed rc %d\n", rc);\r\ngoto iounmap;\r\n}\r\ndone:\r\nreturn rc;\r\niounmap:\r\niounmap(mdev->mmio.va);\r\nreturn rc;\r\n}\r\nstatic int mic_remove(struct platform_device *pdev)\r\n{\r\nstruct mic_driver *mdrv = &g_drv;\r\nstruct mic_device *mdev = &mdrv->mdev;\r\nmic_driver_uninit(mdrv);\r\niounmap(mdev->mmio.va);\r\nreturn 0;\r\n}\r\nstatic void mic_platform_shutdown(struct platform_device *pdev)\r\n{\r\nmic_remove(pdev);\r\n}\r\nstatic int __init mic_init(void)\r\n{\r\nint ret;\r\nstruct cpuinfo_x86 *c = &cpu_data(0);\r\nif (!(c->x86 == 11 && c->x86_model == 1)) {\r\nret = -ENODEV;\r\npr_err("%s not running on X100 ret %d\n", __func__, ret);\r\ngoto done;\r\n}\r\nmic_init_card_debugfs();\r\nret = platform_device_register(&mic_platform_dev);\r\nif (ret) {\r\npr_err("platform_device_register ret %d\n", ret);\r\ngoto cleanup_debugfs;\r\n}\r\nret = platform_driver_register(&mic_platform_driver);\r\nif (ret) {\r\npr_err("platform_driver_register ret %d\n", ret);\r\ngoto device_unregister;\r\n}\r\nreturn ret;\r\ndevice_unregister:\r\nplatform_device_unregister(&mic_platform_dev);\r\ncleanup_debugfs:\r\nmic_exit_card_debugfs();\r\ndone:\r\nreturn ret;\r\n}\r\nstatic void __exit mic_exit(void)\r\n{\r\nplatform_driver_unregister(&mic_platform_driver);\r\nplatform_device_unregister(&mic_platform_dev);\r\nmic_exit_card_debugfs();\r\n}

u1Byte\r\nhalbtc8192e1ant_BtRssiState(\r\nu1Byte levelNum,\r\nu1Byte rssiThresh,\r\nu1Byte rssiThresh1\r\n)\r\n{\r\ns4Byte btRssi=0;\r\nu1Byte btRssiState=pCoexSta->preBtRssiState;\r\nbtRssi = pCoexSta->btRssi;\r\nif(levelNum == 2)\r\n{\r\nif( (pCoexSta->preBtRssiState == BTC_RSSI_STATE_LOW) ||\r\n(pCoexSta->preBtRssiState == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(btRssi >= (rssiThresh+BTC_RSSI_COEX_THRESH_TOL_8192E_1ANT))\r\n{\r\nbtRssiState = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to High\n"));\r\n}\r\nelse\r\n{\r\nbtRssiState = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at Low\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(btRssi < rssiThresh)\r\n{\r\nbtRssiState = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nbtRssiState = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at High\n"));\r\n}\r\n}\r\n}\r\nelse if(levelNum == 3)\r\n{\r\nif(rssiThresh > rssiThresh1)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi thresh error!!\n"));\r\nreturn pCoexSta->preBtRssiState;\r\n}\r\nif( (pCoexSta->preBtRssiState == BTC_RSSI_STATE_LOW) ||\r\n(pCoexSta->preBtRssiState == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(btRssi >= (rssiThresh+BTC_RSSI_COEX_THRESH_TOL_8192E_1ANT))\r\n{\r\nbtRssiState = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nbtRssiState = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at Low\n"));\r\n}\r\n}\r\nelse if( (pCoexSta->preBtRssiState == BTC_RSSI_STATE_MEDIUM) ||\r\n(pCoexSta->preBtRssiState == BTC_RSSI_STATE_STAY_MEDIUM))\r\n{\r\nif(btRssi >= (rssiThresh1+BTC_RSSI_COEX_THRESH_TOL_8192E_1ANT))\r\n{\r\nbtRssiState = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to High\n"));\r\n}\r\nelse if(btRssi < rssiThresh)\r\n{\r\nbtRssiState = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nbtRssiState = BTC_RSSI_STATE_STAY_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at Medium\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(btRssi < rssiThresh1)\r\n{\r\nbtRssiState = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nbtRssiState = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at High\n"));\r\n}\r\n}\r\n}\r\npCoexSta->preBtRssiState = btRssiState;\r\nreturn btRssiState;\r\n}\r\nu1Byte\r\nhalbtc8192e1ant_WifiRssiState(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte index,\r\nIN u1Byte levelNum,\r\nIN u1Byte rssiThresh,\r\nIN u1Byte rssiThresh1\r\n)\r\n{\r\ns4Byte wifiRssi=0;\r\nu1Byte wifiRssiState=pCoexSta->preWifiRssiState[index];\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_S4_WIFI_RSSI, &wifiRssi);\r\nif(levelNum == 2)\r\n{\r\nif( (pCoexSta->preWifiRssiState[index] == BTC_RSSI_STATE_LOW) ||\r\n(pCoexSta->preWifiRssiState[index] == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(wifiRssi >= (rssiThresh+BTC_RSSI_COEX_THRESH_TOL_8192E_1ANT))\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to High\n"));\r\n}\r\nelse\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at Low\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(wifiRssi < rssiThresh)\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at High\n"));\r\n}\r\n}\r\n}\r\nelse if(levelNum == 3)\r\n{\r\nif(rssiThresh > rssiThresh1)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI thresh error!!\n"));\r\nreturn pCoexSta->preWifiRssiState[index];\r\n}\r\nif( (pCoexSta->preWifiRssiState[index] == BTC_RSSI_STATE_LOW) ||\r\n(pCoexSta->preWifiRssiState[index] == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(wifiRssi >= (rssiThresh+BTC_RSSI_COEX_THRESH_TOL_8192E_1ANT))\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at Low\n"));\r\n}\r\n}\r\nelse if( (pCoexSta->preWifiRssiState[index] == BTC_RSSI_STATE_MEDIUM) ||\r\n(pCoexSta->preWifiRssiState[index] == BTC_RSSI_STATE_STAY_MEDIUM))\r\n{\r\nif(wifiRssi >= (rssiThresh1+BTC_RSSI_COEX_THRESH_TOL_8192E_1ANT))\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to High\n"));\r\n}\r\nelse if(wifiRssi < rssiThresh)\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_STAY_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at Medium\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(wifiRssi < rssiThresh1)\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nwifiRssiState = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at High\n"));\r\n}\r\n}\r\n}\r\npCoexSta->preWifiRssiState[index] = wifiRssiState;\r\nreturn wifiRssiState;\r\n}\r\nVOID\r\nhalbtc8192e1ant_Updatera_mask(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte type,\r\nIN u4Byte rateMask\r\n)\r\n{\r\nif(BTC_RATE_DISABLE == type)\r\n{\r\npCoexDm->curra_mask |= rateMask;\r\n}\r\nelse if(BTC_RATE_ENABLE == type)\r\n{\r\npCoexDm->curra_mask &= ~rateMask;\r\n}\r\nif( bForceExec || (pCoexDm->prera_mask != pCoexDm->curra_mask))\r\n{\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_UPDATE_ra_mask, &pCoexDm->curra_mask);\r\n}\r\npCoexDm->prera_mask = pCoexDm->curra_mask;\r\n}\r\nVOID\r\nhalbtc8192e1ant_MonitorBtCtr(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu4Byte regHPTxRx, regLPTxRx, u4Tmp;\r\nu4Byte regHPTx=0, regHPRx=0, regLPTx=0, regLPRx=0;\r\nu1Byte u1Tmp;\r\nregHPTxRx = 0x770;\r\nregLPTxRx = 0x774;\r\nu4Tmp = pBtCoexist->btc_read_4byte(pBtCoexist, regHPTxRx);\r\nregHPTx = u4Tmp & MASKLWORD;\r\nregHPRx = (u4Tmp & MASKHWORD)>>16;\r\nu4Tmp = pBtCoexist->btc_read_4byte(pBtCoexist, regLPTxRx);\r\nregLPTx = u4Tmp & MASKLWORD;\r\nregLPRx = (u4Tmp & MASKHWORD)>>16;\r\npCoexSta->highPriorityTx = regHPTx;\r\npCoexSta->highPriorityRx = regHPRx;\r\npCoexSta->lowPriorityTx = regLPTx;\r\npCoexSta->lowPriorityRx = regLPRx;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], High Priority Tx/Rx (reg 0x%x)=0x%x(%d)/0x%x(%d)\n",\r\nregHPTxRx, regHPTx, regHPTx, regHPRx, regHPRx));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], Low Priority Tx/Rx (reg 0x%x)=0x%x(%d)/0x%x(%d)\n",\r\nregLPTxRx, regLPTx, regLPTx, regLPRx, regLPRx));\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x76e, 0xc);\r\n}\r\nVOID\r\nhalbtc8192e1ant_QueryBtInfo(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\npCoexSta->bC2hBtInfoReqSent = true;\r\nH2C_Parameter[0] |= BIT0;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], Query Bt Info, FW write 0x61=0x%x\n",\r\nH2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x61, 1, H2C_Parameter);\r\n}\r\nBOOLEAN\r\nhalbtc8192e1ant_IsWifiStatusChanged(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstatic BOOLEAN bPreWifiBusy=FALSE, bPreUnder4way=FALSE, bPreBtHsOn=FALSE;\r\nBOOLEAN bWifiBusy=FALSE, bUnder4way=FALSE, bBtHsOn=FALSE;\r\nBOOLEAN bWifiConnected=FALSE;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS, &bUnder4way);\r\nif(bWifiConnected)\r\n{\r\nif(bWifiBusy != bPreWifiBusy)\r\n{\r\nbPreWifiBusy = bWifiBusy;\r\nreturn true;\r\n}\r\nif(bUnder4way != bPreUnder4way)\r\n{\r\nbPreUnder4way = bUnder4way;\r\nreturn true;\r\n}\r\nif(bBtHsOn != bPreBtHsOn)\r\n{\r\nbPreBtHsOn = bBtHsOn;\r\nreturn true;\r\n}\r\n}\r\nreturn FALSE;\r\n}\r\nVOID\r\nhalbtc8192e1ant_UpdateBtLinkInfo(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\npBtLinkInfo->bBtLinkExist = pCoexSta->bBtLinkExist;\r\npBtLinkInfo->bScoExist = pCoexSta->bScoExist;\r\npBtLinkInfo->bA2dpExist = pCoexSta->bA2dpExist;\r\npBtLinkInfo->bPanExist = pCoexSta->bPanExist;\r\npBtLinkInfo->bHidExist = pCoexSta->bHidExist;\r\nif( pBtLinkInfo->bScoExist &&\r\n!pBtLinkInfo->bA2dpExist &&\r\n!pBtLinkInfo->bPanExist &&\r\n!pBtLinkInfo->bHidExist )\r\npBtLinkInfo->bScoOnly = true;\r\nelse\r\npBtLinkInfo->bScoOnly = FALSE;\r\nif( !pBtLinkInfo->bScoExist &&\r\npBtLinkInfo->bA2dpExist &&\r\n!pBtLinkInfo->bPanExist &&\r\n!pBtLinkInfo->bHidExist )\r\npBtLinkInfo->bA2dpOnly = true;\r\nelse\r\npBtLinkInfo->bA2dpOnly = FALSE;\r\nif( !pBtLinkInfo->bScoExist &&\r\n!pBtLinkInfo->bA2dpExist &&\r\npBtLinkInfo->bPanExist &&\r\n!pBtLinkInfo->bHidExist )\r\npBtLinkInfo->bPanOnly = true;\r\nelse\r\npBtLinkInfo->bPanOnly = FALSE;\r\nif( !pBtLinkInfo->bScoExist &&\r\n!pBtLinkInfo->bA2dpExist &&\r\n!pBtLinkInfo->bPanExist &&\r\npBtLinkInfo->bHidExist )\r\npBtLinkInfo->bHidOnly = true;\r\nelse\r\npBtLinkInfo->bHidOnly = FALSE;\r\n}\r\nu1Byte\r\nhalbtc8192e1ant_ActionAlgorithm(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nBOOLEAN bBtHsOn=FALSE;\r\nu1Byte algorithm=BT_8192E_1ANT_COEX_ALGO_UNDEFINED;\r\nu1Byte numOfDiffProfile=0;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(!pBtLinkInfo->bBtLinkExist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], No BT link exists!!!\n"));\r\nreturn algorithm;\r\n}\r\nif(pBtLinkInfo->bScoExist)\r\nnumOfDiffProfile++;\r\nif(pBtLinkInfo->bHidExist)\r\nnumOfDiffProfile++;\r\nif(pBtLinkInfo->bPanExist)\r\nnumOfDiffProfile++;\r\nif(pBtLinkInfo->bA2dpExist)\r\nnumOfDiffProfile++;\r\nif(numOfDiffProfile == 1)\r\n{\r\nif(pBtLinkInfo->bScoExist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO only\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse\r\n{\r\nif(pBtLinkInfo->bHidExist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID only\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID;\r\n}\r\nelse if(pBtLinkInfo->bA2dpExist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], A2DP only\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_A2DP;\r\n}\r\nelse if(pBtLinkInfo->bPanExist)\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], PAN(HS) only\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANHS;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], PAN(EDR) only\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR;\r\n}\r\n}\r\n}\r\n}\r\nelse if(numOfDiffProfile == 2)\r\n{\r\nif(pBtLinkInfo->bScoExist)\r\n{\r\nif(pBtLinkInfo->bHidExist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID;\r\n}\r\nelse if(pBtLinkInfo->bA2dpExist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + A2DP ==> SCO\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse if(pBtLinkInfo->bPanExist)\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + PAN(HS)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + PAN(EDR)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif( pBtLinkInfo->bHidExist &&\r\npBtLinkInfo->bA2dpExist )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + A2DP\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse if( pBtLinkInfo->bHidExist &&\r\npBtLinkInfo->bPanExist )\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + PAN(HS)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + PAN(EDR)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\nelse if( pBtLinkInfo->bPanExist &&\r\npBtLinkInfo->bA2dpExist )\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], A2DP + PAN(HS)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_A2DP_PANHS;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], A2DP + PAN(EDR)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR_A2DP;\r\n}\r\n}\r\n}\r\n}\r\nelse if(numOfDiffProfile == 3)\r\n{\r\nif(pBtLinkInfo->bScoExist)\r\n{\r\nif( pBtLinkInfo->bHidExist &&\r\npBtLinkInfo->bA2dpExist )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + A2DP ==> HID\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID;\r\n}\r\nelse if( pBtLinkInfo->bHidExist &&\r\npBtLinkInfo->bPanExist )\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + PAN(HS)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + PAN(EDR)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\nelse if( pBtLinkInfo->bPanExist &&\r\npBtLinkInfo->bA2dpExist )\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + A2DP + PAN(HS)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + A2DP + PAN(EDR) ==> HID\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif( pBtLinkInfo->bHidExist &&\r\npBtLinkInfo->bPanExist &&\r\npBtLinkInfo->bA2dpExist )\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + A2DP + PAN(HS)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + A2DP + PAN(EDR)\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_HID_A2DP_PANEDR;\r\n}\r\n}\r\n}\r\n}\r\nelse if(numOfDiffProfile >= 3)\r\n{\r\nif(pBtLinkInfo->bScoExist)\r\n{\r\nif( pBtLinkInfo->bHidExist &&\r\npBtLinkInfo->bPanExist &&\r\npBtLinkInfo->bA2dpExist )\r\n{\r\nif(bBtHsOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Error!!! SCO + HID + A2DP + PAN(HS)\n"));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + A2DP + PAN(EDR)==>PAN(EDR)+HID\n"));\r\nalgorithm = BT_8192E_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\n}\r\n}\r\nreturn algorithm;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetFwDacSwingLevel(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte dacSwingLvl\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\nH2C_Parameter[0] = dacSwingLvl;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], Set Dac Swing Level=0x%x\n", dacSwingLvl));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], FW write 0x64=0x%x\n", H2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x64, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetFwDecBtPwr(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte decBtPwrLvl\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\nH2C_Parameter[0] = decBtPwrLvl;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], decrease Bt Power level = %d, FW write 0x62=0x%x\n",\r\ndecBtPwrLvl, H2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x62, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_DecBtPwr(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte decBtPwrLvl\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s Dec BT power level = %d\n",\r\n(bForceExec? "force to":""), decBtPwrLvl));\r\npCoexDm->curBtDecPwrLvl = decBtPwrLvl;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], BtDecPwrLvl=%d, curBtDecPwrLvl=%d\n",\r\npCoexDm->preBtDecPwrLvl, pCoexDm->curBtDecPwrLvl));\r\nif(pCoexDm->preBtDecPwrLvl == pCoexDm->curBtDecPwrLvl)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetFwDecBtPwr(pBtCoexist, pCoexDm->curBtDecPwrLvl);\r\npCoexDm->preBtDecPwrLvl = pCoexDm->curBtDecPwrLvl;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetFwBtLnaConstrain(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bBtLnaConsOn\r\n)\r\n{\r\nu1Byte H2C_Parameter[2] ={0};\r\nH2C_Parameter[0] = 0x3;\r\nif(bBtLnaConsOn)\r\n{\r\nH2C_Parameter[1] |= BIT0;\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], set BT LNA Constrain: %s, FW write 0x69=0x%x\n",\r\n(bBtLnaConsOn? "ON!!":"OFF!!"),\r\nH2C_Parameter[0]<<8|H2C_Parameter[1]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x69, 2, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetBtLnaConstrain(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bBtLnaConsOn\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s BT Constrain = %s\n",\r\n(bForceExec? "force":""), ((bBtLnaConsOn)? "ON":"OFF")));\r\npCoexDm->bCurBtLnaConstrain = bBtLnaConsOn;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreBtLnaConstrain=%d, bCurBtLnaConstrain=%d\n",\r\npCoexDm->bPreBtLnaConstrain, pCoexDm->bCurBtLnaConstrain));\r\nif(pCoexDm->bPreBtLnaConstrain == pCoexDm->bCurBtLnaConstrain)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetFwBtLnaConstrain(pBtCoexist, pCoexDm->bCurBtLnaConstrain);\r\npCoexDm->bPreBtLnaConstrain = pCoexDm->bCurBtLnaConstrain;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetFwBtPsdMode(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte btPsdMode\r\n)\r\n{\r\nu1Byte H2C_Parameter[2] ={0};\r\nH2C_Parameter[0] = 0x2;\r\nH2C_Parameter[1] = btPsdMode;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], set BT PSD mode=0x%x, FW write 0x69=0x%x\n",\r\nH2C_Parameter[1],\r\nH2C_Parameter[0]<<8|H2C_Parameter[1]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x69, 2, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetBtPsdMode(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte btPsdMode\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s BT PSD mode = 0x%x\n",\r\n(bForceExec? "force":""), btPsdMode));\r\npCoexDm->bCurBtPsdMode = btPsdMode;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreBtPsdMode=0x%x, bCurBtPsdMode=0x%x\n",\r\npCoexDm->bPreBtPsdMode, pCoexDm->bCurBtPsdMode));\r\nif(pCoexDm->bPreBtPsdMode == pCoexDm->bCurBtPsdMode)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetFwBtPsdMode(pBtCoexist, pCoexDm->bCurBtPsdMode);\r\npCoexDm->bPreBtPsdMode = pCoexDm->bCurBtPsdMode;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetBtAutoReport(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bEnableAutoReport\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\nH2C_Parameter[0] = 0;\r\nif(bEnableAutoReport)\r\n{\r\nH2C_Parameter[0] |= BIT0;\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], BT FW auto report : %s, FW write 0x68=0x%x\n",\r\n(bEnableAutoReport? "Enabled!!":"Disabled!!"), H2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x68, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_BtAutoReport(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bEnableAutoReport\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s BT Auto report = %s\n",\r\n(bForceExec? "force to":""), ((bEnableAutoReport)? "Enabled":"Disabled")));\r\npCoexDm->bCurBtAutoReport = bEnableAutoReport;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreBtAutoReport=%d, bCurBtAutoReport=%d\n",\r\npCoexDm->bPreBtAutoReport, pCoexDm->bCurBtAutoReport));\r\nif(pCoexDm->bPreBtAutoReport == pCoexDm->bCurBtAutoReport)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetBtAutoReport(pBtCoexist, pCoexDm->bCurBtAutoReport);\r\npCoexDm->bPreBtAutoReport = pCoexDm->bCurBtAutoReport;\r\n}\r\nVOID\r\nhalbtc8192e1ant_FwDacSwingLvl(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte fwDacSwingLvl\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s set FW Dac Swing level = %d\n",\r\n(bForceExec? "force to":""), fwDacSwingLvl));\r\npCoexDm->curFwDacSwingLvl = fwDacSwingLvl;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], preFwDacSwingLvl=%d, curFwDacSwingLvl=%d\n",\r\npCoexDm->preFwDacSwingLvl, pCoexDm->curFwDacSwingLvl));\r\nif(pCoexDm->preFwDacSwingLvl == pCoexDm->curFwDacSwingLvl)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetFwDacSwingLevel(pBtCoexist, pCoexDm->curFwDacSwingLvl);\r\npCoexDm->preFwDacSwingLvl = pCoexDm->curFwDacSwingLvl;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetSwRfRxLpfCorner(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bRxRfShrinkOn\r\n)\r\n{\r\nif(bRxRfShrinkOn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Shrink RF Rx LPF corner!!\n"));\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x1e, 0xfffff, 0xf0ff7);\r\n}\r\nelse\r\n{\r\nif(pBtCoexist->initilized)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Resume RF Rx LPF corner!!\n"));\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x1e, 0xfffff, pCoexDm->btRf0x1eBackup);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_RfShrink(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bRxRfShrinkOn\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn Rx RF Shrink = %s\n",\r\n(bForceExec? "force to":""), ((bRxRfShrinkOn)? "ON":"OFF")));\r\npCoexDm->bCurRfRxLpfShrink = bRxRfShrinkOn;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreRfRxLpfShrink=%d, bCurRfRxLpfShrink=%d\n",\r\npCoexDm->bPreRfRxLpfShrink, pCoexDm->bCurRfRxLpfShrink));\r\nif(pCoexDm->bPreRfRxLpfShrink == pCoexDm->bCurRfRxLpfShrink)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetSwRfRxLpfCorner(pBtCoexist, pCoexDm->bCurRfRxLpfShrink);\r\npCoexDm->bPreRfRxLpfShrink = pCoexDm->bCurRfRxLpfShrink;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetSwPenaltyTxRateAdaptive(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bLowPenaltyRa\r\n)\r\n{\r\nu1Byte tmpU1;\r\ntmpU1 = pBtCoexist->btc_read_1byte(pBtCoexist, 0x4fd);\r\ntmpU1 |= BIT0;\r\nif(bLowPenaltyRa)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Tx rate adaptive, set low penalty!!\n"));\r\ntmpU1 &= ~BIT2;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Tx rate adaptive, set normal!!\n"));\r\ntmpU1 |= BIT2;\r\n}\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x4fd, tmpU1);\r\n}\r\nVOID\r\nhalbtc8192e1ant_LowPenaltyRa(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bLowPenaltyRa\r\n)\r\n{\r\nreturn;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn LowPenaltyRA = %s\n",\r\n(bForceExec? "force to":""), ((bLowPenaltyRa)? "ON":"OFF")));\r\npCoexDm->bCurLowPenaltyRa = bLowPenaltyRa;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreLowPenaltyRa=%d, bCurLowPenaltyRa=%d\n",\r\npCoexDm->bPreLowPenaltyRa, pCoexDm->bCurLowPenaltyRa));\r\nif(pCoexDm->bPreLowPenaltyRa == pCoexDm->bCurLowPenaltyRa)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetSwPenaltyTxRateAdaptive(pBtCoexist, pCoexDm->bCurLowPenaltyRa);\r\npCoexDm->bPreLowPenaltyRa = pCoexDm->bCurLowPenaltyRa;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetDacSwingReg(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u4Byte level\r\n)\r\n{\r\nu1Byte val=(u1Byte)level;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Write SwDacSwing = 0x%x\n", level));\r\npBtCoexist->btc_write_1byte_bitmask(pBtCoexist, 0x883, 0x3e, val);\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetSwFullTimeDacSwing(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bSwDacSwingOn,\r\nIN u4Byte swDacSwingLvl\r\n)\r\n{\r\nif(bSwDacSwingOn)\r\n{\r\nhalbtc8192e1ant_SetDacSwingReg(pBtCoexist, swDacSwingLvl);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SetDacSwingReg(pBtCoexist, 0x18);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_DacSwing(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bDacSwingOn,\r\nIN u4Byte dacSwingLvl\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn DacSwing=%s, dacSwingLvl=0x%x\n",\r\n(bForceExec? "force to":""), ((bDacSwingOn)? "ON":"OFF"), dacSwingLvl));\r\npCoexDm->bCurDacSwingOn = bDacSwingOn;\r\npCoexDm->curDacSwingLvl = dacSwingLvl;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreDacSwingOn=%d, preDacSwingLvl=0x%x, bCurDacSwingOn=%d, curDacSwingLvl=0x%x\n",\r\npCoexDm->bPreDacSwingOn, pCoexDm->preDacSwingLvl,\r\npCoexDm->bCurDacSwingOn, pCoexDm->curDacSwingLvl));\r\nif( (pCoexDm->bPreDacSwingOn == pCoexDm->bCurDacSwingOn) &&\r\n(pCoexDm->preDacSwingLvl == pCoexDm->curDacSwingLvl) )\r\nreturn;\r\n}\r\nmdelay(30);\r\nhalbtc8192e1ant_SetSwFullTimeDacSwing(pBtCoexist, bDacSwingOn, dacSwingLvl);\r\npCoexDm->bPreDacSwingOn = pCoexDm->bCurDacSwingOn;\r\npCoexDm->preDacSwingLvl = pCoexDm->curDacSwingLvl;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetAdcBackOff(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bAdcBackOff\r\n)\r\n{\r\nif(bAdcBackOff)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], BB BackOff Level On!\n"));\r\npBtCoexist->btc_write_1byte_bitmask(pBtCoexist, 0x8db, 0x60, 0x3);\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], BB BackOff Level Off!\n"));\r\npBtCoexist->btc_write_1byte_bitmask(pBtCoexist, 0x8db, 0x60, 0x1);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_AdcBackOff(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bAdcBackOff\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn AdcBackOff = %s\n",\r\n(bForceExec? "force to":""), ((bAdcBackOff)? "ON":"OFF")));\r\npCoexDm->bCurAdcBackOff = bAdcBackOff;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreAdcBackOff=%d, bCurAdcBackOff=%d\n",\r\npCoexDm->bPreAdcBackOff, pCoexDm->bCurAdcBackOff));\r\nif(pCoexDm->bPreAdcBackOff == pCoexDm->bCurAdcBackOff)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetAdcBackOff(pBtCoexist, pCoexDm->bCurAdcBackOff);\r\npCoexDm->bPreAdcBackOff = pCoexDm->bCurAdcBackOff;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetAgcTable(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bAgcTableEn\r\n)\r\n{\r\nu1Byte rssiAdjustVal=0;\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0xef, 0xfffff, 0x02000);\r\nif(bAgcTableEn)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Agc Table On!\n"));\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x3b, 0xfffff, 0x3fa58);\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x3b, 0xfffff, 0x37a58);\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x3b, 0xfffff, 0x2fa58);\r\nrssiAdjustVal = 8;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Agc Table Off!\n"));\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x3b, 0xfffff, 0x39258);\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x3b, 0xfffff, 0x31258);\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0x3b, 0xfffff, 0x29258);\r\n}\r\npBtCoexist->btc_set_rf_reg(pBtCoexist, BTC_RF_A, 0xef, 0xfffff, 0x0);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_U1_RSSI_ADJ_VAL_FOR_AGC_TABLE_ON, &rssiAdjustVal);\r\n}\r\nVOID\r\nhalbtc8192e1ant_AgcTable(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bAgcTableEn\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s %s Agc Table\n",\r\n(bForceExec? "force to":""), ((bAgcTableEn)? "Enable":"Disable")));\r\npCoexDm->bCurAgcTableEn = bAgcTableEn;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], bPreAgcTableEn=%d, bCurAgcTableEn=%d\n",\r\npCoexDm->bPreAgcTableEn, pCoexDm->bCurAgcTableEn));\r\nif(pCoexDm->bPreAgcTableEn == pCoexDm->bCurAgcTableEn)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetAgcTable(pBtCoexist, bAgcTableEn);\r\npCoexDm->bPreAgcTableEn = pCoexDm->bCurAgcTableEn;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetCoexTable(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u4Byte val0x6c0,\r\nIN u4Byte val0x6c4,\r\nIN u4Byte val0x6c8,\r\nIN u1Byte val0x6cc\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c0=0x%x\n", val0x6c0));\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c0, val0x6c0);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c4=0x%x\n", val0x6c4));\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c4, val0x6c4);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c8=0x%x\n", val0x6c8));\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x6c8, val0x6c8);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6cc=0x%x\n", val0x6cc));\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x6cc, val0x6cc);\r\n}\r\nVOID\r\nhalbtc8192e1ant_CoexTable(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u4Byte val0x6c0,\r\nIN u4Byte val0x6c4,\r\nIN u4Byte val0x6c8,\r\nIN u1Byte val0x6cc\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s write Coex Table 0x6c0=0x%x, 0x6c4=0x%x, 0x6c8=0x%x, 0x6cc=0x%x\n",\r\n(bForceExec? "force to":""), val0x6c0, val0x6c4, val0x6c8, val0x6cc));\r\npCoexDm->curVal0x6c0 = val0x6c0;\r\npCoexDm->curVal0x6c4 = val0x6c4;\r\npCoexDm->curVal0x6c8 = val0x6c8;\r\npCoexDm->curVal0x6cc = val0x6cc;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], preVal0x6c0=0x%x, preVal0x6c4=0x%x, preVal0x6c8=0x%x, preVal0x6cc=0x%x !!\n",\r\npCoexDm->preVal0x6c0, pCoexDm->preVal0x6c4, pCoexDm->preVal0x6c8, pCoexDm->preVal0x6cc));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], curVal0x6c0=0x%x, curVal0x6c4=0x%x, curVal0x6c8=0x%x, curVal0x6cc=0x%x !!\n",\r\npCoexDm->curVal0x6c0, pCoexDm->curVal0x6c4, pCoexDm->curVal0x6c8, pCoexDm->curVal0x6cc));\r\nif( (pCoexDm->preVal0x6c0 == pCoexDm->curVal0x6c0) &&\r\n(pCoexDm->preVal0x6c4 == pCoexDm->curVal0x6c4) &&\r\n(pCoexDm->preVal0x6c8 == pCoexDm->curVal0x6c8) &&\r\n(pCoexDm->preVal0x6cc == pCoexDm->curVal0x6cc) )\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetCoexTable(pBtCoexist, val0x6c0, val0x6c4, val0x6c8, val0x6cc);\r\npCoexDm->preVal0x6c0 = pCoexDm->curVal0x6c0;\r\npCoexDm->preVal0x6c4 = pCoexDm->curVal0x6c4;\r\npCoexDm->preVal0x6c8 = pCoexDm->curVal0x6c8;\r\npCoexDm->preVal0x6cc = pCoexDm->curVal0x6cc;\r\n}\r\nVOID\r\nhalbtc8192e1ant_CoexTableWithType(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte type\r\n)\r\n{\r\nswitch(type)\r\n{\r\ncase 0:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x55555555, 0x55555555, 0xffffff, 0x3);\r\nbreak;\r\ncase 1:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x55555555, 0x5a5a5a5a, 0xffffff, 0x3);\r\nbreak;\r\ncase 2:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x5a5a5a5a, 0x5a5a5a5a, 0xffffff, 0x3);\r\nbreak;\r\ncase 3:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0xaaaaaaaa, 0xaaaaaaaa, 0xffffff, 0x3);\r\nbreak;\r\ncase 4:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0xffffffff, 0xffffffff, 0xffffff, 0x3);\r\nbreak;\r\ncase 5:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x5fff5fff, 0x5fff5fff, 0xffffff, 0x3);\r\nbreak;\r\ncase 6:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x55ff55ff, 0x5a5a5a5a, 0xffffff, 0x3);\r\nbreak;\r\ncase 7:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0xddffddff, 0xddffddff, 0xffffff, 0x3);\r\nbreak;\r\ncase 8:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x55ff55ff, 0x5afa5afa, 0xffffff, 0x3);\r\nbreak;\r\ncase 9:\r\nhalbtc8192e1ant_CoexTable(pBtCoexist, bForceExec, 0x5f5f5f5f, 0x5f5f5f5f, 0xffffff, 0x3);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetFwIgnoreWlanAct(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bEnable\r\n)\r\n{\r\nu1Byte H2C_Parameter[1] ={0};\r\nif(bEnable)\r\n{\r\nH2C_Parameter[0] |= BIT0;\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], set FW for BT Ignore Wlan_Act, FW write 0x63=0x%x\n",\r\nH2C_Parameter[0]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x63, 1, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_IgnoreWlanAct(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bEnable\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s turn Ignore WlanAct %s\n",\r\n(bForceExec? "force to":""), (bEnable? "ON":"OFF")));\r\npCoexDm->bCurIgnoreWlanAct = bEnable;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreIgnoreWlanAct = %d, bCurIgnoreWlanAct = %d!!\n",\r\npCoexDm->bPreIgnoreWlanAct, pCoexDm->bCurIgnoreWlanAct));\r\nif(pCoexDm->bPreIgnoreWlanAct == pCoexDm->bCurIgnoreWlanAct)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetFwIgnoreWlanAct(pBtCoexist, bEnable);\r\npCoexDm->bPreIgnoreWlanAct = pCoexDm->bCurIgnoreWlanAct;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetFwPstdma(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte byte1,\r\nIN u1Byte byte2,\r\nIN u1Byte byte3,\r\nIN u1Byte byte4,\r\nIN u1Byte byte5\r\n)\r\n{\r\nu1Byte H2C_Parameter[5] ={0};\r\nH2C_Parameter[0] = byte1;\r\nH2C_Parameter[1] = byte2;\r\nH2C_Parameter[2] = byte3;\r\nH2C_Parameter[3] = byte4;\r\nH2C_Parameter[4] = byte5;\r\npCoexDm->psTdmaPara[0] = byte1;\r\npCoexDm->psTdmaPara[1] = byte2;\r\npCoexDm->psTdmaPara[2] = byte3;\r\npCoexDm->psTdmaPara[3] = byte4;\r\npCoexDm->psTdmaPara[4] = byte5;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], FW write 0x60(5bytes)=0x%x%08x\n",\r\nH2C_Parameter[0],\r\nH2C_Parameter[1]<<24|H2C_Parameter[2]<<16|H2C_Parameter[3]<<8|H2C_Parameter[4]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x60, 5, H2C_Parameter);\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetLpsRpwm(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte lpsVal,\r\nIN u1Byte rpwmVal\r\n)\r\n{\r\nu1Byte lps=lpsVal;\r\nu1Byte rpwm=rpwmVal;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_U1_1ANT_LPS, &lps);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_U1_1ANT_RPWM, &rpwm);\r\n}\r\nVOID\r\nhalbtc8192e1ant_LpsRpwm(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte lpsVal,\r\nIN u1Byte rpwmVal\r\n)\r\n{\r\nBOOLEAN bForceExecPwrCmd=FALSE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s set lps/rpwm=0x%x/0x%x \n",\r\n(bForceExec? "force to":""), lpsVal, rpwmVal));\r\npCoexDm->curLps = lpsVal;\r\npCoexDm->curRpwm = rpwmVal;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], preLps/curLps=0x%x/0x%x, preRpwm/curRpwm=0x%x/0x%x!!\n",\r\npCoexDm->preLps, pCoexDm->curLps, pCoexDm->preRpwm, pCoexDm->curRpwm));\r\nif( (pCoexDm->preLps == pCoexDm->curLps) &&\r\n(pCoexDm->preRpwm == pCoexDm->curRpwm) )\r\n{\r\nreturn;\r\n}\r\n}\r\nhalbtc8192e1ant_SetLpsRpwm(pBtCoexist, lpsVal, rpwmVal);\r\npCoexDm->preLps = pCoexDm->curLps;\r\npCoexDm->preRpwm = pCoexDm->curRpwm;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SwMechanism1(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bShrinkRxLPF,\r\nIN BOOLEAN bLowPenaltyRA,\r\nIN BOOLEAN limited_dig,\r\nIN BOOLEAN bBTLNAConstrain\r\n)\r\n{\r\n}\r\nVOID\r\nhalbtc8192e1ant_SwMechanism2(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bAGCTableShift,\r\nIN BOOLEAN bADCBackOff,\r\nIN BOOLEAN bSWDACSwing,\r\nIN u4Byte dacSwingLvl\r\n)\r\n{\r\n}\r\nVOID\r\nhalbtc8192e1ant_PsTdma(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN BOOLEAN bTurnOn,\r\nIN u1Byte type\r\n)\r\n{\r\nBOOLEAN bTurnOnByCnt=FALSE;\r\nu1Byte psTdmaTypeByCnt=0, rssiAdjustVal=0;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s turn %s PS TDMA, type=%d\n",\r\n(bForceExec? "force to":""), (bTurnOn? "ON":"OFF"), type));\r\npCoexDm->bCurPsTdmaOn = bTurnOn;\r\npCoexDm->curPsTdma = type;\r\nif(!bForceExec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPrePsTdmaOn = %d, bCurPsTdmaOn = %d!!\n",\r\npCoexDm->bPrePsTdmaOn, pCoexDm->bCurPsTdmaOn));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], prePsTdma = %d, curPsTdma = %d!!\n",\r\npCoexDm->prePsTdma, pCoexDm->curPsTdma));\r\nif( (pCoexDm->bPrePsTdmaOn == pCoexDm->bCurPsTdmaOn) &&\r\n(pCoexDm->prePsTdma == pCoexDm->curPsTdma) )\r\nreturn;\r\n}\r\nif(bTurnOn)\r\n{\r\nswitch(type)\r\n{\r\ndefault:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x53, 0x2c, 0x03, 0x10, 0x50);\r\nbreak;\r\ncase 1:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x53, 0x2c, 0x03, 0x10, 0x50);\r\nrssiAdjustVal = 11;\r\nbreak;\r\ncase 2:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x53, 0x25, 0x03, 0x10, 0x50);\r\nrssiAdjustVal = 14;\r\nbreak;\r\ncase 3:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x25, 0x3, 0x10, 0x40);\r\nbreak;\r\ncase 4:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x15, 0x3, 0x14, 0x0);\r\nrssiAdjustVal = 17;\r\nbreak;\r\ncase 5:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x61, 0x15, 0x3, 0x31, 0x0);\r\nbreak;\r\ncase 6:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x13, 0xa, 0x3, 0x0, 0x0);\r\nbreak;\r\ncase 7:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x13, 0xc, 0x5, 0x0, 0x0);\r\nbreak;\r\ncase 8:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nbreak;\r\ncase 9:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x53, 0x1e, 0x03, 0x10, 0x50);\r\nrssiAdjustVal = 18;\r\nbreak;\r\ncase 10:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x13, 0xa, 0xa, 0x0, 0x40);\r\nbreak;\r\ncase 11:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x53, 0x12, 0x03, 0x10, 0x50);\r\nrssiAdjustVal = 20;\r\nbreak;\r\ncase 12:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xeb, 0xa, 0x3, 0x31, 0x18);\r\nbreak;\r\ncase 15:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x13, 0xa, 0x3, 0x8, 0x0);\r\nbreak;\r\ncase 16:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x15, 0x3, 0x10, 0x0);\r\nrssiAdjustVal = 18;\r\nbreak;\r\ncase 18:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nrssiAdjustVal = 14;\r\nbreak;\r\ncase 20:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x13, 0x25, 0x25, 0x0, 0x0);\r\nbreak;\r\ncase 21:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x20, 0x3, 0x10, 0x40);\r\nbreak;\r\ncase 22:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x13, 0x8, 0x8, 0x0, 0x40);\r\nbreak;\r\ncase 23:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0x25, 0x3, 0x31, 0x18);\r\nrssiAdjustVal = 22;\r\nbreak;\r\ncase 24:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0x15, 0x3, 0x31, 0x18);\r\nrssiAdjustVal = 22;\r\nbreak;\r\ncase 25:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0xa, 0x3, 0x31, 0x18);\r\nrssiAdjustVal = 22;\r\nbreak;\r\ncase 26:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0xa, 0x3, 0x31, 0x18);\r\nrssiAdjustVal = 22;\r\nbreak;\r\ncase 27:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0x25, 0x3, 0x31, 0x98);\r\nrssiAdjustVal = 22;\r\nbreak;\r\ncase 28:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x69, 0x25, 0x3, 0x31, 0x0);\r\nbreak;\r\ncase 29:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xab, 0x1a, 0x1a, 0x1, 0x10);\r\nbreak;\r\ncase 30:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x93, 0x15, 0x3, 0x14, 0x0);\r\nbreak;\r\ncase 31:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xd3, 0x1a, 0x1a, 0, 0x58);\r\nbreak;\r\ncase 32:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xab, 0xa, 0x3, 0x31, 0x90);\r\nbreak;\r\ncase 33:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xa3, 0x25, 0x3, 0x30, 0x90);\r\nbreak;\r\ncase 34:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xd3, 0x1a, 0x1a, 0x0, 0x10);\r\nbreak;\r\ncase 35:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0x1a, 0x1a, 0x0, 0x10);\r\nbreak;\r\ncase 36:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xd3, 0x12, 0x3, 0x14, 0x50);\r\nbreak;\r\ncase 37:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x53, 0x25, 0x3, 0x10, 0x50);\r\nbreak;\r\ncase 38:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0xe3, 0x12, 0x12, 0xe1, 0x90);\r\nbreak;\r\n}\r\n}\r\nelse\r\n{\r\nswitch(type)\r\n{\r\ncase 8:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x8, 0x0, 0x0, 0x0, 0x0);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x92c, 0x4);\r\nbreak;\r\ncase 0:\r\ndefault:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x0, 0x0, 0x0, 0x0, 0x0);\r\nmdelay(5);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x92c, 0x20);\r\nbreak;\r\ncase 9:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x0, 0x0, 0x0, 0x0, 0x0);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x92c, 0x4);\r\nbreak;\r\ncase 10:\r\nhalbtc8192e1ant_SetFwPstdma(pBtCoexist, 0x0, 0x0, 0x0, 0x8, 0x0);\r\nmdelay(5);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x92c, 0x20);\r\nbreak;\r\n}\r\n}\r\nrssiAdjustVal =0;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_U1_RSSI_ADJ_VAL_FOR_1ANT_COEX_TYPE, &rssiAdjustVal);\r\npCoexDm->bPrePsTdmaOn = pCoexDm->bCurPsTdmaOn;\r\npCoexDm->prePsTdma = pCoexDm->curPsTdma;\r\n}\r\nVOID\r\nhalbtc8192e1ant_SetSwitchSsType(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte ssType\r\n)\r\n{\r\nu1Byte mimoPs=BTC_MIMO_PS_DYNAMIC;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], REAL set SS Type = %d\n", ssType));\r\nif(ssType == 1)\r\n{\r\nhalbtc8192e1ant_Updatera_mask(pBtCoexist, FORCE_EXEC, BTC_RATE_DISABLE, 0xfff00000);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, FORCE_EXEC, FALSE, 0);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0xc04, 0x11);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0xd04, 0x1);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x90c, 0x81111111);\r\npBtCoexist->btc_write_1byte_bitmask(pBtCoexist, 0xe77, 0x4, 0x1);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0xa07, 0x81);\r\nmimoPs=BTC_MIMO_PS_STATIC;\r\n}\r\nelse if(ssType == 2)\r\n{\r\nhalbtc8192e1ant_Updatera_mask(pBtCoexist, FORCE_EXEC, BTC_RATE_ENABLE, 0xfff00000);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, FORCE_EXEC, FALSE, 8);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0xc04, 0x33);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0xd04, 0x3);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x90c, 0x81121313);\r\npBtCoexist->btc_write_1byte_bitmask(pBtCoexist, 0xe77, 0x4, 0x0);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0xa07, 0x41);\r\nmimoPs=BTC_MIMO_PS_DYNAMIC;\r\n}\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_SEND_MIMO_PS, &mimoPs);\r\n}\r\nVOID\r\nhalbtc8192e1ant_SwitchSsType(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bForceExec,\r\nIN u1Byte newSsType\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], %s Switch SS Type = %d\n",\r\n(bForceExec? "force to":""), newSsType));\r\npCoexDm->curSsType = newSsType;\r\nif(!bForceExec)\r\n{\r\nif(pCoexDm->preSsType == pCoexDm->curSsType)\r\nreturn;\r\n}\r\nhalbtc8192e1ant_SetSwitchSsType(pBtCoexist, pCoexDm->curSsType);\r\npCoexDm->preSsType = pCoexDm->curSsType;\r\n}\r\nVOID\r\nhalbtc8192e1ant_CoexAllOff(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,FALSE,FALSE,FALSE,FALSE);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nBOOLEAN\r\nhalbtc8192e1ant_IsCommonAction(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBOOLEAN bCommon=FALSE, bWifiConnected=FALSE, bWifiBusy=FALSE;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\r\nif(!bWifiConnected &&\r\nBT_8192E_1ANT_BT_STATUS_NON_CONNECTED_IDLE == pCoexDm->btStatus)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi non connected-idle + BT non connected-idle!!\n"));\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,FALSE,FALSE,FALSE,FALSE);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nbCommon = true;\r\n}\r\nelse if(bWifiConnected &&\r\n(BT_8192E_1ANT_BT_STATUS_NON_CONNECTED_IDLE == pCoexDm->btStatus) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi connected + BT non connected-idle!!\n"));\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,FALSE,FALSE,FALSE,FALSE);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nbCommon = true;\r\n}\r\nelse if(!bWifiConnected &&\r\n(BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE == pCoexDm->btStatus) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi non connected-idle + BT connected-idle!!\n"));\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,FALSE,FALSE,FALSE,FALSE);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nbCommon = true;\r\n}\r\nelse if(bWifiConnected &&\r\n(BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE == pCoexDm->btStatus) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi connected + BT connected-idle!!\n"));\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,true,true,true,true);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nbCommon = true;\r\n}\r\nelse if(!bWifiConnected &&\r\n(BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE != pCoexDm->btStatus) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi non connected-idle + BT Busy!!\n"));\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,FALSE,FALSE,FALSE,FALSE);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nbCommon = true;\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,true,true,true,true);\r\nbCommon = FALSE;\r\n}\r\nreturn bCommon;\r\n}\r\nVOID\r\nhalbtc8192e1ant_TdmaDurationAdjustForAcl(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte wifiStatus\r\n)\r\n{\r\nstatic s4Byte up,dn,m,n,WaitCount;\r\ns4Byte result;\r\nu1Byte retryCount=0, btInfoExt;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], TdmaDurationAdjustForAcl()\n"));\r\nif( (BT_8192E_1ANT_WIFI_STATUS_NON_CONNECTED_ASSO_AUTH_SCAN == wifiStatus) ||\r\n(BT_8192E_1ANT_WIFI_STATUS_CONNECTED_SCAN == wifiStatus) ||\r\n(BT_8192E_1ANT_WIFI_STATUS_CONNECTED_SPECIAL_PKT == wifiStatus) )\r\n{\r\nif( pCoexDm->curPsTdma != 1 &&\r\npCoexDm->curPsTdma != 2 &&\r\npCoexDm->curPsTdma != 3 &&\r\npCoexDm->curPsTdma != 9 )\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\nup = 0;\r\ndn = 0;\r\nm = 1;\r\nn= 3;\r\nresult = 0;\r\nWaitCount = 0;\r\n}\r\nreturn;\r\n}\r\nif(!pCoexDm->bAutoTdmaAdjust)\r\n{\r\npCoexDm->bAutoTdmaAdjust = true;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], first run TdmaDurationAdjust()!!\n"));\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\r\npCoexDm->psTdmaDuAdjType = 2;\r\nup = 0;\r\ndn = 0;\r\nm = 1;\r\nn= 3;\r\nresult = 0;\r\nWaitCount = 0;\r\n}\r\nelse\r\n{\r\nretryCount = pCoexSta->btRetryCnt;\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], retryCount = %d\n", retryCount));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], up=%d, dn=%d, m=%d, n=%d, WaitCount=%d\n",\r\nup, dn, m, n, WaitCount));\r\nresult = 0;\r\nWaitCount++;\r\nif(retryCount == 0)\r\n{\r\nup++;\r\ndn--;\r\nif (dn <= 0)\r\ndn = 0;\r\nif(up >= n)\r\n{\r\nWaitCount = 0;\r\nn = 3;\r\nup = 0;\r\ndn = 0;\r\nresult = 1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], Increase wifi duration!!\n"));\r\n}\r\n}\r\nelse if (retryCount <= 3)\r\n{\r\nup--;\r\ndn++;\r\nif (up <= 0)\r\nup = 0;\r\nif (dn == 2)\r\n{\r\nif (WaitCount <= 2)\r\nm++;\r\nelse\r\nm = 1;\r\nif ( m >= 20)\r\nm = 20;\r\nn = 3*m;\r\nup = 0;\r\ndn = 0;\r\nWaitCount = 0;\r\nresult = -1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], Decrease wifi duration for retryCounter<3!!\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif (WaitCount == 1)\r\nm++;\r\nelse\r\nm = 1;\r\nif ( m >= 20)\r\nm = 20;\r\nn = 3*m;\r\nup = 0;\r\ndn = 0;\r\nWaitCount = 0;\r\nresult = -1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], Decrease wifi duration for retryCounter>3!!\n"));\r\n}\r\nif(result == -1)\r\n{\r\nif( (BT_INFO_8192E_1ANT_A2DP_BASIC_RATE(btInfoExt)) &&\r\n((pCoexDm->curPsTdma == 1) ||(pCoexDm->curPsTdma == 2)) )\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\n}\r\nelse if(pCoexDm->curPsTdma == 1)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\r\npCoexDm->psTdmaDuAdjType = 2;\r\n}\r\nelse if(pCoexDm->curPsTdma == 2)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\n}\r\nelse if(pCoexDm->curPsTdma == 9)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 11);\r\npCoexDm->psTdmaDuAdjType = 11;\r\n}\r\n}\r\nelse if(result == 1)\r\n{\r\nif( (BT_INFO_8192E_1ANT_A2DP_BASIC_RATE(btInfoExt)) &&\r\n((pCoexDm->curPsTdma == 1) ||(pCoexDm->curPsTdma == 2)) )\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\n}\r\nelse if(pCoexDm->curPsTdma == 11)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\npCoexDm->psTdmaDuAdjType = 9;\r\n}\r\nelse if(pCoexDm->curPsTdma == 9)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 2);\r\npCoexDm->psTdmaDuAdjType = 2;\r\n}\r\nelse if(pCoexDm->curPsTdma == 2)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 1);\r\npCoexDm->psTdmaDuAdjType = 1;\r\n}\r\n}\r\nif( pCoexDm->curPsTdma != 1 &&\r\npCoexDm->curPsTdma != 2 &&\r\npCoexDm->curPsTdma != 9 &&\r\npCoexDm->curPsTdma != 11 )\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, pCoexDm->psTdmaDuAdjType);\r\n}\r\n}\r\n}\r\nu1Byte\r\nhalbtc8192e1ant_PsTdmaTypeByWifiRssi(\r\nIN s4Byte wifiRssi,\r\nIN s4Byte preWifiRssi,\r\nIN u1Byte wifiRssiThresh\r\n)\r\n{\r\nu1Byte psTdmaType=0;\r\nif(wifiRssi > preWifiRssi)\r\n{\r\nif(wifiRssi > (wifiRssiThresh+5))\r\n{\r\npsTdmaType = 26;\r\n}\r\nelse\r\n{\r\npsTdmaType = 25;\r\n}\r\n}\r\nelse\r\n{\r\nif(wifiRssi > wifiRssiThresh)\r\n{\r\npsTdmaType = 26;\r\n}\r\nelse\r\n{\r\npsTdmaType = 25;\r\n}\r\n}\r\nreturn psTdmaType;\r\n}\r\nVOID\r\nhalbtc8192e1ant_PsTdmaCheckForPowerSaveState(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN BOOLEAN bNewPsState\r\n)\r\n{\r\nu1Byte lpsMode=0x0;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U1_LPS_MODE, &lpsMode);\r\nif(lpsMode)\r\n{\r\nif(bNewPsState)\r\n{\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\n}\r\n}\r\nelse\r\n{\r\nif(bNewPsState)\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\n}\r\nelse\r\n{\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_PowerSaveState(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte psType,\r\nIN u1Byte lpsVal,\r\nIN u1Byte rpwmVal\r\n)\r\n{\r\nBOOLEAN bLowPwrDisable=FALSE;\r\nswitch(psType)\r\n{\r\ncase BTC_PS_WIFI_NATIVE:\r\nbLowPwrDisable = FALSE;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_DISABLE_LOW_POWER, &bLowPwrDisable);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_NORMAL_LPS, NULL);\r\nbreak;\r\ncase BTC_PS_LPS_ON:\r\nhalbtc8192e1ant_PsTdmaCheckForPowerSaveState(pBtCoexist, true);\r\nhalbtc8192e1ant_LpsRpwm(pBtCoexist, NORMAL_EXEC, lpsVal, rpwmVal);\r\nbLowPwrDisable = true;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_DISABLE_LOW_POWER, &bLowPwrDisable);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nbreak;\r\ncase BTC_PS_LPS_OFF:\r\nhalbtc8192e1ant_PsTdmaCheckForPowerSaveState(pBtCoexist, FALSE);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiOnly(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\n}\r\nVOID\r\nhalbtc8192e1ant_MonitorBtEnableDisable(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstatic BOOLEAN bPreBtDisabled=FALSE;\r\nstatic u4Byte btDisableCnt=0;\r\nBOOLEAN bBtActive=true, bBtDisabled=FALSE;\r\nif( pCoexSta->highPriorityTx == 0 &&\r\npCoexSta->highPriorityRx == 0 &&\r\npCoexSta->lowPriorityTx == 0 &&\r\npCoexSta->lowPriorityRx == 0)\r\n{\r\nbBtActive = FALSE;\r\n}\r\nif( pCoexSta->highPriorityTx == 0xffff &&\r\npCoexSta->highPriorityRx == 0xffff &&\r\npCoexSta->lowPriorityTx == 0xffff &&\r\npCoexSta->lowPriorityRx == 0xffff)\r\n{\r\nbBtActive = FALSE;\r\n}\r\nif(bBtActive)\r\n{\r\nbtDisableCnt = 0;\r\nbBtDisabled = FALSE;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_DISABLE, &bBtDisabled);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is enabled !!\n"));\r\n}\r\nelse\r\n{\r\nbtDisableCnt++;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], bt all counters=0, %d times!!\n",\r\nbtDisableCnt));\r\nif(btDisableCnt >= 2)\r\n{\r\nbBtDisabled = true;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_DISABLE, &bBtDisabled);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is disabled !!\n"));\r\nhalbtc8192e1ant_ActionWifiOnly(pBtCoexist);\r\n}\r\n}\r\nif(bPreBtDisabled != bBtDisabled)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is from %s to %s!!\n",\r\n(bPreBtDisabled ? "disabled":"enabled"),\r\n(bBtDisabled ? "disabled":"enabled")));\r\nbPreBtDisabled = bBtDisabled;\r\nif(!bBtDisabled)\r\n{\r\n}\r\nelse\r\n{\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_NORMAL_LPS, NULL);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionSco(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState;\r\nu4Byte wifiBw;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionHid(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState;\r\nu4Byte wifiBw;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,FALSE,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionA2dp(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState;\r\nu4Byte wifiBw;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionA2dpPanHs(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState, btInfoExt;\r\nu4Byte wifiBw;\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionPanEdr(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState;\r\nu4Byte wifiBw;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionPanHs(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState;\r\nu4Byte wifiBw;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionPanEdrA2dp(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState, btInfoExt;\r\nu4Byte wifiBw;\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionPanEdrHid(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState;\r\nu4Byte wifiBw;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionHidA2dpPanEdr(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState, btInfoExt;\r\nu4Byte wifiBw;\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionHidA2dp(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu1Byte wifiRssiState, btInfoExt;\r\nu4Byte wifiBw;\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nwifiRssiState = halbtc8192e1ant_WifiRssiState(pBtCoexist, 0, 2, 25, 0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,true,FALSE,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifiRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(wifiRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,true,true,FALSE,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionBtInquiry(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nBOOLEAN bWifiConnected=FALSE, bBtHsOn=FALSE;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(bBtHsOn)\r\nreturn;\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nelse if( (pBtLinkInfo->bScoExist) ||\r\n(pBtLinkInfo->bHidOnly) )\r\n{\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 32);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 1);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_LPS_ON, 0x50, 0x0);\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 30);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionBtScoHidOnlyBusy(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte wifiStatus\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nu1Byte btRssiState=BTC_RSSI_STATE_HIGH;\r\nif(BT_8192E_1ANT_WIFI_STATUS_NON_CONNECTED_ASSO_AUTH_SCAN == wifiStatus)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nelse\r\n{\r\nif(pBtLinkInfo->bHidOnly)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\nelse\r\n{\r\nbtRssiState = halbtc8192e1ant_BtRssiState(3, 34, 42);\r\nif( (btRssiState == BTC_RSSI_STATE_LOW) ||\r\n(btRssiState == BTC_RSSI_STATE_STAY_LOW) )\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nelse if( (btRssiState == BTC_RSSI_STATE_MEDIUM) ||\r\n(btRssiState == BTC_RSSI_STATE_STAY_MEDIUM) )\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\nelse if( (btRssiState == BTC_RSSI_STATE_HIGH) ||\r\n(btRssiState == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 6);\r\n}\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, true, 0xc);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 7);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionHs(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action for HS!!!\n"));\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nif(BT_8192E_1ANT_BT_STATUS_NON_CONNECTED_IDLE == pCoexDm->btStatus)\r\n{\r\npCoexDm->errorCondition = 1;\r\n}\r\nelse if(BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, true, 6);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 10);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nelse if(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus &&\r\n!pBtCoexist->bt_link_info.bHidOnly)\r\n{\r\nif(pCoexDm->curSsType == 1)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, true, 6);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 10);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_ActionBtScoHidOnlyBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_BUSY);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiConnectedBtAclBusy(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte wifiStatus\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nif(pBtLinkInfo->bHidOnly)\r\n{\r\nhalbtc8192e1ant_ActionBtScoHidOnlyBusy(pBtCoexist, wifiStatus);\r\npCoexDm->bAutoTdmaAdjust = FALSE;\r\nreturn;\r\n}\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nif( (pBtLinkInfo->bA2dpOnly) ||\r\n(pBtLinkInfo->bHidExist&&pBtLinkInfo->bA2dpExist) )\r\n{\r\nhalbtc8192e1ant_TdmaDurationAdjustForAcl(pBtCoexist, wifiStatus);\r\n}\r\nelse if( (pBtLinkInfo->bPanOnly) ||\r\n(pBtLinkInfo->bHidExist&&pBtLinkInfo->bPanExist) )\r\n{\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 3);\r\npCoexDm->bAutoTdmaAdjust = FALSE;\r\n}\r\nelse\r\n{\r\nif( (BT_8192E_1ANT_WIFI_STATUS_NON_CONNECTED_ASSO_AUTH_SCAN == wifiStatus) ||\r\n(BT_8192E_1ANT_WIFI_STATUS_CONNECTED_SCAN == wifiStatus) ||\r\n(BT_8192E_1ANT_WIFI_STATUS_CONNECTED_SPECIAL_PKT == wifiStatus) )\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 9);\r\nelse\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 11);\r\npCoexDm->bAutoTdmaAdjust = FALSE;\r\n}\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 1);\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiNotConnected(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiNotConnectedAssoAuthScan(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 0);\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiConnectedScan(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus && !pBtCoexist->bt_link_info.bHidOnly)\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_LPS_ON, 0x50, 0x0);\r\nelse\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedBtAclBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_SCAN);\r\n}\r\nelse if( (BT_8192E_1ANT_BT_STATUS_SCO_BUSY == pCoexDm->btStatus) ||\r\n(BT_8192E_1ANT_BT_STATUS_ACL_SCO_BUSY == pCoexDm->btStatus) )\r\n{\r\nhalbtc8192e1ant_ActionBtScoHidOnlyBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_SCAN);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiConnectedSpecialPacket(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus && !pBtCoexist->bt_link_info.bHidOnly)\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_LPS_ON, 0x50, 0x0);\r\nelse\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedBtAclBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_SPECIAL_PKT);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_ActionWifiConnected(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBOOLEAN bWifiConnected=FALSE, bWifiBusy=FALSE;\r\nBOOLEAN bScan=FALSE, bLink=FALSE, bRoam=FALSE;\r\nBOOLEAN bUnder4way=FALSE;\r\nu4Byte wifiBw;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect()===>\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(!bWifiConnected)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect(), return for wifi not connected<===\n"));\r\nreturn;\r\n}\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS, &bUnder4way);\r\nif(bUnder4way)\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedSpecialPacket(pBtCoexist);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect(), return for wifi is under 4way<===\n"));\r\nreturn;\r\n}\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\r\nif(bScan || bLink || bRoam)\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedScan(pBtCoexist);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect(), return for wifi is under scan<===\n"));\r\nreturn;\r\n}\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus && !pBtCoexist->bt_link_info.bHidOnly)\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_LPS_ON, 0x50, 0x0);\r\nelse\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\r\nif(!bWifiBusy)\r\n{\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedBtAclBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_IDLE);\r\n}\r\nelse if( (BT_8192E_1ANT_BT_STATUS_SCO_BUSY == pCoexDm->btStatus) ||\r\n(BT_8192E_1ANT_BT_STATUS_ACL_SCO_BUSY == pCoexDm->btStatus) )\r\n{\r\nhalbtc8192e1ant_ActionBtScoHidOnlyBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_IDLE);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\n}\r\nelse\r\n{\r\nif(BT_8192E_1ANT_BT_STATUS_NON_CONNECTED_IDLE == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 5);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\nelse if(BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, true, 5);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\nelse if(BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus)\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedBtAclBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_BUSY);\r\n}\r\nelse if( (BT_8192E_1ANT_BT_STATUS_SCO_BUSY == pCoexDm->btStatus) ||\r\n(BT_8192E_1ANT_BT_STATUS_ACL_SCO_BUSY == pCoexDm->btStatus) )\r\n{\r\nhalbtc8192e1ant_ActionBtScoHidOnlyBusy(pBtCoexist,\r\nBT_8192E_1ANT_WIFI_STATUS_CONNECTED_BUSY);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, NORMAL_EXEC, 0);\r\nhalbtc8192e1ant_DacSwing(pBtCoexist, NORMAL_EXEC, FALSE, 0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, NORMAL_EXEC, 2);\r\n}\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_RunSwCoexistMechanism(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBOOLEAN bWifiUnder5G=FALSE, bWifiBusy=FALSE, bWifiConnected=FALSE;\r\nu1Byte btInfoOriginal=0, btRetryCnt=0;\r\nu1Byte algorithm=0;\r\nreturn;\r\nalgorithm = halbtc8192e1ant_ActionAlgorithm(pBtCoexist);\r\npCoexDm->curAlgorithm = algorithm;\r\nif(halbtc8192e1ant_IsCommonAction(pBtCoexist))\r\n{\r\n}\r\nelse\r\n{\r\nswitch(pCoexDm->curAlgorithm)\r\n{\r\ncase BT_8192E_1ANT_COEX_ALGO_SCO:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = SCO.\n"));\r\nhalbtc8192e1ant_ActionSco(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_HID:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HID.\n"));\r\nhalbtc8192e1ant_ActionHid(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_A2DP:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = A2DP.\n"));\r\nhalbtc8192e1ant_ActionA2dp(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_A2DP_PANHS:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = A2DP+PAN(HS).\n"));\r\nhalbtc8192e1ant_ActionA2dpPanHs(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_PANEDR:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = PAN(EDR).\n"));\r\nhalbtc8192e1ant_ActionPanEdr(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_PANHS:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HS mode.\n"));\r\nhalbtc8192e1ant_ActionPanHs(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_PANEDR_A2DP:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = PAN+A2DP.\n"));\r\nhalbtc8192e1ant_ActionPanEdrA2dp(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_PANEDR_HID:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = PAN(EDR)+HID.\n"));\r\nhalbtc8192e1ant_ActionPanEdrHid(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_HID_A2DP_PANEDR:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HID+A2DP+PAN.\n"));\r\nhalbtc8192e1ant_ActionHidA2dpPanEdr(pBtCoexist);\r\nbreak;\r\ncase BT_8192E_1ANT_COEX_ALGO_HID_A2DP:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HID+A2DP.\n"));\r\nhalbtc8192e1ant_ActionHidA2dp(pBtCoexist);\r\nbreak;\r\ndefault:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = coexist All Off!!\n"));\r\nhalbtc8192e1ant_CoexAllOff(pBtCoexist);\r\nbreak;\r\n}\r\npCoexDm->preAlgorithm = pCoexDm->curAlgorithm;\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_RunCoexistMechanism(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nBOOLEAN bWifiConnected=FALSE, bBtHsOn=FALSE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism()===>\n"));\r\nif(pBtCoexist->manual_control)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism(), return for Manual CTRL <===\n"));\r\nreturn;\r\n}\r\nif(pBtCoexist->bStopCoexDm)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism(), return for Stop Coex DM <===\n"));\r\nreturn;\r\n}\r\nif(pCoexSta->bUnderIps)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi is under IPS !!!\n"));\r\nreturn;\r\n}\r\nhalbtc8192e1ant_RunSwCoexistMechanism(pBtCoexist);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(pCoexSta->bC2hBtInquiryPage)\r\n{\r\nhalbtc8192e1ant_ActionBtInquiry(pBtCoexist);\r\nreturn;\r\n}\r\nif(pBtLinkInfo->bScoExist)\r\n{\r\nhalbtc8192e1ant_SwitchSsType(pBtCoexist, NORMAL_EXEC, 1);\r\n}\r\nelse if(bBtHsOn)\r\n{\r\nif(pBtLinkInfo->bHidOnly)\r\nhalbtc8192e1ant_SwitchSsType(pBtCoexist, NORMAL_EXEC, 2);\r\nelse\r\nhalbtc8192e1ant_SwitchSsType(pBtCoexist, NORMAL_EXEC, 1);\r\n}\r\nelse\r\nhalbtc8192e1ant_SwitchSsType(pBtCoexist, NORMAL_EXEC, 2);\r\nif(bBtHsOn)\r\n{\r\nhalbtc8192e1ant_ActionHs(pBtCoexist);\r\nreturn;\r\n}\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(!bWifiConnected)\r\n{\r\nBOOLEAN bScan=FALSE, bLink=FALSE, bRoam=FALSE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi is non connected-idle !!!\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\r\nif(bScan || bLink || bRoam)\r\nhalbtc8192e1ant_ActionWifiNotConnectedAssoAuthScan(pBtCoexist);\r\nelse\r\nhalbtc8192e1ant_ActionWifiNotConnected(pBtCoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_ActionWifiConnected(pBtCoexist);\r\n}\r\n}\r\nVOID\r\nhalbtc8192e1ant_InitCoexDm(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nhalbtc8192e1ant_FwDacSwingLvl(pBtCoexist, FORCE_EXEC, 6);\r\nhalbtc8192e1ant_DecBtPwr(pBtCoexist, FORCE_EXEC, 0);\r\nhalbtc8192e1ant_SwMechanism1(pBtCoexist,FALSE,FALSE,FALSE,FALSE);\r\nhalbtc8192e1ant_SwMechanism2(pBtCoexist,FALSE,FALSE,FALSE,0x18);\r\nhalbtc8192e1ant_SwitchSsType(pBtCoexist, FORCE_EXEC, 2);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, FORCE_EXEC, FALSE, 8);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, FORCE_EXEC, 0);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_InitHwConfig(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nu4Byte u4Tmp=0;\r\nu16 u2Tmp=0;\r\nu1Byte u1Tmp=0;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], 1Ant Init HW Config!!\n"));\r\npCoexDm->btRf0x1eBackup =\r\npBtCoexist->btc_get_rf_reg(pBtCoexist, BTC_RF_A, 0x1e, 0xfffff);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x4f, 0x6);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x944, 0x24);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x930, 0x700700);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x92c, 0x20);\r\nif(pBtCoexist->chipInterface == BTC_INTF_USB)\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x64, 0x30430004);\r\nelse\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x64, 0x30030004);\r\nhalbtc8192e1ant_CoexTableWithType(pBtCoexist, FORCE_EXEC, 0);\r\npBtCoexist->btc_write_4byte(pBtCoexist, 0x858, 0x55555555);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x778, 0x1);\r\nu1Tmp = pBtCoexist->btc_read_1byte(pBtCoexist, 0x790);\r\nu1Tmp &= 0xc0;\r\nu1Tmp |= 0x5;\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x790, u1Tmp);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x76e, 0x4);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x40, 0x20);\r\nu2Tmp = pBtCoexist->btc_read_2byte(pBtCoexist, 0x40);\r\nu2Tmp |= BIT9;\r\npBtCoexist->btc_write_2byte(pBtCoexist, 0x40, u2Tmp);\r\nu1Tmp = pBtCoexist->btc_read_1byte(pBtCoexist, 0x101);\r\nu1Tmp |= BIT4;\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x101, u1Tmp);\r\nu1Tmp = pBtCoexist->btc_read_1byte(pBtCoexist, 0x93);\r\nu1Tmp |= BIT0;\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x93, u1Tmp);\r\nu1Tmp = pBtCoexist->btc_read_1byte(pBtCoexist, 0x7);\r\nu1Tmp |= BIT0;\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x7, u1Tmp);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_InitCoexDm(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], Coex Mechanism Init!!\n"));\r\npBtCoexist->bStopCoexDm = FALSE;\r\nhalbtc8192e1ant_InitCoexDm(pBtCoexist);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_DisplayCoexInfo(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstruct btc_board_info * pBoardInfo=&pBtCoexist->board_info;\r\nPBTC_STACK_INFO pStackInfo=&pBtCoexist->stack_info;\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\npu1Byte cliBuf=pBtCoexist->cli_buf;\r\nu1Byte u1Tmp[4], i, btInfoExt, psTdmaCase=0;\r\nu4Byte u4Tmp[4];\r\nBOOLEAN bRoam=FALSE, bScan=FALSE, bLink=FALSE, bWifiUnder5G=FALSE;\r\nBOOLEAN bBtHsOn=FALSE, bWifiBusy=FALSE;\r\ns4Byte wifiRssi=0, btHsRssi=0;\r\nu4Byte wifiBw, wifiTrafficDir;\r\nu1Byte wifiDot11Chnl, wifiHsChnl;\r\nu4Byte fwVer=0, btPatchVer=0;\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n ============[BT Coexist info]============");\r\nCL_PRINTF(cliBuf);\r\nif(pBtCoexist->manual_control)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n ============[Under Manual Control]============");\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n ==========================================");\r\nCL_PRINTF(cliBuf);\r\n}\r\nif(pBtCoexist->bStopCoexDm)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n ============[Coex is STOPPED]============");\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n ==========================================");\r\nCL_PRINTF(cliBuf);\r\n}\r\nif(!pBoardInfo->bt_exist)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n BT not exists !!!");\r\nCL_PRINTF(cliBuf);\r\nreturn;\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d ", "Ant PG number/ Ant mechanism:", \\r\npBoardInfo->pg_ant_num, pBoardInfo->btdm_ant_num);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s / %d", "BT stack/ hci ext ver", \\r\n((pStackInfo->bProfileNotified)? "Yes":"No"), pStackInfo->hciVersion);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_BT_PATCH_VER, &btPatchVer);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_FW_VER, &fwVer);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d_%d/ 0x%x/ 0x%x(%d)", "CoexVer/ FwVer/ PatchVer", \\r\nGLCoexVerDate8192e1Ant, GLCoexVer8192e1Ant, fwVer, btPatchVer, btPatchVer);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U1_WIFI_DOT11_CHNL, &wifiDot11Chnl);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U1_WIFI_HS_CHNL, &wifiHsChnl);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d / %d(%d)", "Dot11 channel / HsChnl(HsMode)", \\r\nwifiDot11Chnl, wifiHsChnl, bBtHsOn);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x ", "H2C Wifi inform bt chnl Info", \\r\npCoexDm->wifiChnlInfo[0], pCoexDm->wifiChnlInfo[1],\r\npCoexDm->wifiChnlInfo[2]);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_S4_WIFI_RSSI, &wifiRssi);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_S4_HS_RSSI, &btHsRssi);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "Wifi rssi/ HS rssi", \\r\nwifiRssi, btHsRssi);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_SCAN, &bScan);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_LINK, &bLink);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_ROAM, &bRoam);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d ", "Wifi bLink/ bRoam/ bScan", \\r\nbLink, bRoam, bScan);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_UNDER_5G, &bWifiUnder5G);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_BUSY, &bWifiBusy);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_TRAFFIC_DIRECTION, &wifiTrafficDir);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s / %s/ %s ", "Wifi status", \\r\n(bWifiUnder5G? "5G":"2.4G"),\r\n((BTC_WIFI_BW_LEGACY==wifiBw)? "Legacy": (((BTC_WIFI_BW_HT40==wifiBw)? "HT40":"HT20"))),\r\n((!bWifiBusy)? "idle": ((BTC_WIFI_TRAFFIC_TX==wifiTrafficDir)? "uplink":"downlink")));\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = [%s/ %d/ %d] ", "BT [status/ rssi/ retryCnt]", \\r\n((pBtCoexist->btInfo.bBtDisabled)? ("disabled"): ((pCoexSta->bC2hBtInquiryPage)?("inquiry/page scan"):((BT_8192E_1ANT_BT_STATUS_NON_CONNECTED_IDLE == pCoexDm->btStatus)? "non-connected idle":\r\n( (BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE == pCoexDm->btStatus)? "connected-idle":"busy")))),\r\npCoexSta->btRssi, pCoexSta->btRetryCnt);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d / %d / %d / %d", "SCO/HID/PAN/A2DP", \\r\npBtLinkInfo->bScoExist, pBtLinkInfo->bHidExist, pBtLinkInfo->bPanExist, pBtLinkInfo->bA2dpExist);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_disp_dbg_msg(pBtCoexist, BTC_DBG_DISP_BT_LINK_INFO);\r\nbtInfoExt = pCoexSta->btInfoExt;\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s", "BT Info A2DP rate", \\r\n(btInfoExt&BIT0)? "Basic rate":"EDR rate");\r\nCL_PRINTF(cliBuf);\r\nfor(i=0; i<BT_INFO_SRC_8192E_1ANT_MAX; i++)\r\n{\r\nif(pCoexSta->btInfoC2hCnt[i])\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x %02x %02x %02x %02x(%d)", GLBtInfoSrc8192e1Ant[i], \\r\npCoexSta->btInfoC2h[i][0], pCoexSta->btInfoC2h[i][1],\r\npCoexSta->btInfoC2h[i][2], pCoexSta->btInfoC2h[i][3],\r\npCoexSta->btInfoC2h[i][4], pCoexSta->btInfoC2h[i][5],\r\npCoexSta->btInfoC2h[i][6], pCoexSta->btInfoC2hCnt[i]);\r\nCL_PRINTF(cliBuf);\r\n}\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s/%s, (0x%x/0x%x)", "PS state, IPS/LPS, (lps/rpwm)", \\r\n((pCoexSta->bUnderIps? "IPS ON":"IPS OFF")),\r\n((pCoexSta->bUnderLps? "LPS ON":"LPS OFF")),\r\npBtCoexist->btInfo.lps1Ant,\r\npBtCoexist->btInfo.rpwm_1ant);\r\nCL_PRINTF(cliBuf);\r\npBtCoexist->btc_disp_dbg_msg(pBtCoexist, BTC_DBG_DISP_FW_PWR_MODE_CMD);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x ", "SS Type", \\r\npCoexDm->curSsType);\r\nCL_PRINTF(cliBuf);\r\nif(!pBtCoexist->manual_control)\r\n{\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Sw mechanism]============");\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d/ %d ", "SM1[ShRf/ LpRA/ LimDig/ btLna]", \\r\npCoexDm->bCurRfRxLpfShrink, pCoexDm->bCurLowPenaltyRa, pCoexDm->limited_dig, pCoexDm->bCurBtLnaConstrain);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d(0x%x) ", "SM2[AgcT/ AdcB/ SwDacSwing(lvl)]", \\r\npCoexDm->bCurAgcTableEn, pCoexDm->bCurAdcBackOff, pCoexDm->bCurDacSwingOn, pCoexDm->curDacSwingLvl);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s/ %s/ %d ", "DelBA/ BtCtrlAgg/ AggSize", \\r\n(pBtCoexist->btInfo.reject_agg_pkt? "Yes":"No"), (pBtCoexist->btInfo.b_bt_ctrl_agg_buf_size? "Yes":"No"),\r\npBtCoexist->btInfo.aggBufSize);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x ", "Rate Mask", \\r\npBtCoexist->btInfo.ra_mask);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Fw mechanism]============");\r\nCL_PRINTF(cliBuf);\r\npsTdmaCase = pCoexDm->curPsTdma;\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x %02x %02x case-%d (auto:%d)", "PS TDMA", \\r\npCoexDm->psTdmaPara[0], pCoexDm->psTdmaPara[1],\r\npCoexDm->psTdmaPara[2], pCoexDm->psTdmaPara[3],\r\npCoexDm->psTdmaPara[4], psTdmaCase, pCoexDm->bAutoTdmaAdjust);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x ", "Latest error condition(should be 0)", \\r\npCoexDm->errorCondition);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d ", "DecBtPwrLvl/ IgnWlanAct", \\r\npCoexDm->curBtDecPwrLvl, pCoexDm->bCurIgnoreWlanAct);\r\nCL_PRINTF(cliBuf);\r\n}\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Hw setting]============");\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "RF-A, 0x1e initVal", \\r\npCoexDm->btRf0x1eBackup);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xc04);\r\nu4Tmp[1] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xd04);\r\nu4Tmp[2] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x90c);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x/ 0x%x", "0xc04/ 0xd04/ 0x90c", \\r\nu4Tmp[0], u4Tmp[1], u4Tmp[2]);\r\nCL_PRINTF(cliBuf);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x778);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0x778", \\r\nu1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x92c);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x930);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x92c/ 0x930", \\r\n(u1Tmp[0]), u4Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x40);\r\nu1Tmp[1] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x4f);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x40/ 0x4f", \\r\nu1Tmp[0], u1Tmp[1]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x550);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x522);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x550(bcn ctrl)/0x522", \\r\nu4Tmp[0], u1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0xc50);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0xc50(dig)", \\r\nu4Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nu4Tmp[0] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x6c0);\r\nu4Tmp[1] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x6c4);\r\nu4Tmp[2] = pBtCoexist->btc_read_4byte(pBtCoexist, 0x6c8);\r\nu1Tmp[0] = pBtCoexist->btc_read_1byte(pBtCoexist, 0x6cc);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x/ 0x%x/ 0x%x", "0x6c0/0x6c4/0x6c8/0x6cc(coexTable)", \\r\nu4Tmp[0], u4Tmp[1], u4Tmp[2], u1Tmp[0]);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "0x770(hp rx[31:16]/tx[15:0])", \\r\npCoexSta->highPriorityRx, pCoexSta->highPriorityTx);\r\nCL_PRINTF(cliBuf);\r\nCL_SPRINTF(cliBuf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "0x774(lp rx[31:16]/tx[15:0])", \\r\npCoexSta->lowPriorityRx, pCoexSta->lowPriorityTx);\r\nCL_PRINTF(cliBuf);\r\n#if(BT_AUTO_REPORT_ONLY_8192E_1ANT == 1)\r\nhalbtc8192e1ant_MonitorBtCtr(pBtCoexist);\r\n#endif\r\npBtCoexist->btc_disp_dbg_msg(pBtCoexist, BTC_DBG_DISP_COEX_STATISTICS);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_IpsNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nu4Byte u4Tmp=0;\r\nif(pBtCoexist->manual_control || pBtCoexist->bStopCoexDm)\r\nreturn;\r\nif(BTC_IPS_ENTER == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], IPS ENTER notify\n"));\r\npCoexSta->bUnderIps = true;\r\nhalbtc8192e1ant_CoexAllOff(pBtCoexist);\r\n}\r\nelse if(BTC_IPS_LEAVE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], IPS LEAVE notify\n"));\r\npCoexSta->bUnderIps = FALSE;\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_LpsNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(pBtCoexist->manual_control || pBtCoexist->bStopCoexDm)\r\nreturn;\r\nif(BTC_LPS_ENABLE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], LPS ENABLE notify\n"));\r\npCoexSta->bUnderLps = true;\r\n}\r\nelse if(BTC_LPS_DISABLE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], LPS DISABLE notify\n"));\r\npCoexSta->bUnderLps = FALSE;\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_ScanNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nBOOLEAN bWifiConnected=FALSE, bBtHsOn=FALSE;\r\nif(pBtCoexist->manual_control ||\r\npBtCoexist->bStopCoexDm ||\r\npBtCoexist->btInfo.bBtDisabled )\r\nreturn;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(pCoexSta->bC2hBtInquiryPage)\r\n{\r\nhalbtc8192e1ant_ActionBtInquiry(pBtCoexist);\r\nreturn;\r\n}\r\nelse if(bBtHsOn)\r\n{\r\nhalbtc8192e1ant_ActionHs(pBtCoexist);\r\nreturn;\r\n}\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(BTC_SCAN_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], SCAN START notify\n"));\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8192e1ant_ActionWifiNotConnectedAssoAuthScan(pBtCoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_ActionWifiConnectedScan(pBtCoexist);\r\n}\r\n}\r\nelse if(BTC_SCAN_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], SCAN FINISH notify\n"));\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8192e1ant_ActionWifiNotConnected(pBtCoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_ActionWifiConnected(pBtCoexist);\r\n}\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_ConnectNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nBOOLEAN bWifiConnected=FALSE, bBtHsOn=FALSE;\r\nif(pBtCoexist->manual_control ||\r\npBtCoexist->bStopCoexDm ||\r\npBtCoexist->btInfo.bBtDisabled )\r\nreturn;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(pCoexSta->bC2hBtInquiryPage)\r\n{\r\nhalbtc8192e1ant_ActionBtInquiry(pBtCoexist);\r\nreturn;\r\n}\r\nelse if(bBtHsOn)\r\n{\r\nhalbtc8192e1ant_ActionHs(pBtCoexist);\r\nreturn;\r\n}\r\nif(BTC_ASSOCIATE_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], CONNECT START notify\n"));\r\nhalbtc8192e1ant_ActionWifiNotConnectedAssoAuthScan(pBtCoexist);\r\n}\r\nelse if(BTC_ASSOCIATE_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], CONNECT FINISH notify\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(!bWifiConnected)\r\n{\r\nhalbtc8192e1ant_ActionWifiNotConnected(pBtCoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_ActionWifiConnected(pBtCoexist);\r\n}\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_MediaStatusNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nu1Byte H2C_Parameter[3] ={0};\r\nu4Byte wifiBw;\r\nu1Byte wifiCentralChnl;\r\nif(pBtCoexist->manual_control ||\r\npBtCoexist->bStopCoexDm ||\r\npBtCoexist->btInfo.bBtDisabled )\r\nreturn;\r\nif(BTC_MEDIA_CONNECT == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], MEDIA connect notify\n"));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], MEDIA disconnect notify\n"));\r\n}\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U1_WIFI_CENTRAL_CHNL, &wifiCentralChnl);\r\nif( (BTC_MEDIA_CONNECT == type) &&\r\n(wifiCentralChnl <= 14) )\r\n{\r\nH2C_Parameter[0] = 0x1;\r\nH2C_Parameter[1] = wifiCentralChnl;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_BW, &wifiBw);\r\nif(BTC_WIFI_BW_HT40 == wifiBw)\r\nH2C_Parameter[2] = 0x30;\r\nelse\r\nH2C_Parameter[2] = 0x20;\r\n}\r\npCoexDm->wifiChnlInfo[0] = H2C_Parameter[0];\r\npCoexDm->wifiChnlInfo[1] = H2C_Parameter[1];\r\npCoexDm->wifiChnlInfo[2] = H2C_Parameter[2];\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], FW write 0x66=0x%x\n",\r\nH2C_Parameter[0]<<16|H2C_Parameter[1]<<8|H2C_Parameter[2]));\r\npBtCoexist->btc_fill_h2c(pBtCoexist, 0x66, 3, H2C_Parameter);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_SpecialPacketNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nBOOLEAN bBtHsOn=FALSE;\r\nif(pBtCoexist->manual_control ||\r\npBtCoexist->bStopCoexDm ||\r\npBtCoexist->btInfo.bBtDisabled )\r\nreturn;\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_HS_OPERATION, &bBtHsOn);\r\nif(pCoexSta->bC2hBtInquiryPage)\r\n{\r\nhalbtc8192e1ant_ActionBtInquiry(pBtCoexist);\r\nreturn;\r\n}\r\nelse if(bBtHsOn)\r\n{\r\nhalbtc8192e1ant_ActionHs(pBtCoexist);\r\nreturn;\r\n}\r\nif( BTC_PACKET_DHCP == type ||\r\nBTC_PACKET_EAPOL == type )\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], special Packet(%d) notify\n", type));\r\nhalbtc8192e1ant_ActionWifiConnectedSpecialPacket(pBtCoexist);\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_BtInfoNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN pu1Byte tmpBuf,\r\nIN u1Byte length\r\n)\r\n{\r\nPBTC_BT_LINK_INFO pBtLinkInfo=&pBtCoexist->bt_link_info;\r\nu1Byte btInfo=0;\r\nu1Byte i, rspSource=0;\r\nstatic u4Byte setBtPsdMode=0;\r\nBOOLEAN bBtBusy=FALSE, limited_dig=FALSE;\r\nBOOLEAN bWifiConnected=FALSE;\r\nBOOLEAN b_bt_ctrl_agg_buf_size=FALSE;\r\npCoexSta->bC2hBtInfoReqSent = FALSE;\r\nrspSource = tmpBuf[0]&0xf;\r\nif(rspSource >= BT_INFO_SRC_8192E_1ANT_MAX)\r\nrspSource = BT_INFO_SRC_8192E_1ANT_WIFI_FW;\r\npCoexSta->btInfoC2hCnt[rspSource]++;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Bt info[%d], length=%d, hex data=[", rspSource, length));\r\nfor(i=0; i<length; i++)\r\n{\r\npCoexSta->btInfoC2h[rspSource][i] = tmpBuf[i];\r\nif(i == 1)\r\nbtInfo = tmpBuf[i];\r\nif(i == length-1)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("0x%02x]\n", tmpBuf[i]));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("0x%02x, ", tmpBuf[i]));\r\n}\r\n}\r\nif(pBtCoexist->btInfo.bBtDisabled)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), return for BT is disabled <===\n"));\r\nreturn;\r\n}\r\nif(pBtCoexist->manual_control)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), return for Manual CTRL<===\n"));\r\nreturn;\r\n}\r\nif(pBtCoexist->bStopCoexDm)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), return for Coex STOPPED!!<===\n"));\r\nreturn;\r\n}\r\nif(BT_INFO_SRC_8192E_1ANT_WIFI_FW != rspSource)\r\n{\r\npCoexSta->btRetryCnt =\r\npCoexSta->btInfoC2h[rspSource][2]&0xf;\r\npCoexSta->btRssi =\r\npCoexSta->btInfoC2h[rspSource][3]*2+10;\r\npCoexSta->btInfoExt =\r\npCoexSta->btInfoC2h[rspSource][4];\r\nif( (pCoexSta->btInfoExt & BIT1) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BT ext info bit1 check, send wifi BW&Chnl to BT!!\n"));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_BL_WIFI_CONNECTED, &bWifiConnected);\r\nif(bWifiConnected)\r\n{\r\nEXhalbtc8192e1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_CONNECT);\r\n}\r\nelse\r\n{\r\nEXhalbtc8192e1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_DISCONNECT);\r\n}\r\nsetBtPsdMode = 0;\r\n}\r\nif(BT_INFO_SRC_8192E_1ANT_BT_RSP == rspSource)\r\n{\r\nif( (pCoexSta->btInfoExt & BIT3) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BT ext info bit3 check, set BT NOT to ignore Wlan active!!\n"));\r\nhalbtc8192e1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, FALSE);\r\n}\r\nelse\r\n{\r\n}\r\n#if(BT_AUTO_REPORT_ONLY_8192E_1ANT == 0)\r\nif( (pCoexSta->btInfoExt & BIT4) )\r\n{\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BT ext info bit4 check, set BT to enable Auto Report!!\n"));\r\nhalbtc8192e1ant_BtAutoReport(pBtCoexist, FORCE_EXEC, true);\r\n}\r\n#endif\r\n}\r\n}\r\nif(btInfo & BT_INFO_8192E_1ANT_B_INQ_PAGE)\r\npCoexSta->bC2hBtInquiryPage = true;\r\nelse\r\npCoexSta->bC2hBtInquiryPage = FALSE;\r\nif(!(btInfo&BT_INFO_8192E_1ANT_B_CONNECTION))\r\n{\r\npCoexSta->bBtLinkExist = FALSE;\r\npCoexSta->bPanExist = FALSE;\r\npCoexSta->bA2dpExist = FALSE;\r\npCoexSta->bHidExist = FALSE;\r\npCoexSta->bScoExist = FALSE;\r\n}\r\nelse\r\n{\r\npCoexSta->bBtLinkExist = true;\r\nif(btInfo & BT_INFO_8192E_1ANT_B_FTP)\r\npCoexSta->bPanExist = true;\r\nelse\r\npCoexSta->bPanExist = FALSE;\r\nif(btInfo & BT_INFO_8192E_1ANT_B_A2DP)\r\npCoexSta->bA2dpExist = true;\r\nelse\r\npCoexSta->bA2dpExist = FALSE;\r\nif(btInfo & BT_INFO_8192E_1ANT_B_HID)\r\npCoexSta->bHidExist = true;\r\nelse\r\npCoexSta->bHidExist = FALSE;\r\nif(btInfo & BT_INFO_8192E_1ANT_B_SCO_ESCO)\r\npCoexSta->bScoExist = true;\r\nelse\r\npCoexSta->bScoExist = FALSE;\r\n}\r\nhalbtc8192e1ant_UpdateBtLinkInfo(pBtCoexist);\r\nif(!(btInfo&BT_INFO_8192E_1ANT_B_CONNECTION))\r\n{\r\npCoexDm->btStatus = BT_8192E_1ANT_BT_STATUS_NON_CONNECTED_IDLE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt non-connected idle!!!\n"));\r\n}\r\nelse if(btInfo == BT_INFO_8192E_1ANT_B_CONNECTION)\r\n{\r\npCoexDm->btStatus = BT_8192E_1ANT_BT_STATUS_CONNECTED_IDLE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt connected-idle!!!\n"));\r\n}\r\nelse if((btInfo&BT_INFO_8192E_1ANT_B_SCO_ESCO) ||\r\n(btInfo&BT_INFO_8192E_1ANT_B_SCO_BUSY))\r\n{\r\npCoexDm->btStatus = BT_8192E_1ANT_BT_STATUS_SCO_BUSY;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt sco busy!!!\n"));\r\n}\r\nelse if( (btInfo&BT_INFO_8192E_1ANT_B_ACL_BUSY) ||\r\n(btInfo&BT_INFO_8192E_1ANT_B_A2DP) ||\r\n(btInfo&BT_INFO_8192E_1ANT_B_FTP) )\r\n{\r\nif(BT_8192E_1ANT_BT_STATUS_ACL_BUSY != pCoexDm->btStatus)\r\npCoexDm->bAutoTdmaAdjust = FALSE;\r\npCoexDm->btStatus = BT_8192E_1ANT_BT_STATUS_ACL_BUSY;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt acl busy!!!\n"));\r\n}\r\nelse\r\n{\r\npCoexDm->btStatus = BT_8192E_1ANT_BT_STATUS_MAX;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt non-defined state!!!\n"));\r\n}\r\nif(pBtLinkInfo->bScoExist || pBtLinkInfo->bHidExist)\r\n{\r\nhalbtc8192e1ant_Updatera_mask(pBtCoexist, NORMAL_EXEC, BTC_RATE_DISABLE, 0x00000003);\r\n}\r\nelse\r\n{\r\nhalbtc8192e1ant_Updatera_mask(pBtCoexist, NORMAL_EXEC, BTC_RATE_ENABLE, 0x00000003);\r\n}\r\nif( (BT_8192E_1ANT_BT_STATUS_ACL_BUSY == pCoexDm->btStatus) ||\r\n(BT_8192E_1ANT_BT_STATUS_SCO_BUSY == pCoexDm->btStatus) ||\r\n(BT_8192E_1ANT_BT_STATUS_ACL_SCO_BUSY == pCoexDm->btStatus) )\r\n{\r\nbBtBusy = true;\r\nlimited_dig = true;\r\nif(pBtLinkInfo->bHidExist)\r\nb_bt_ctrl_agg_buf_size = true;\r\n}\r\nelse\r\n{\r\nbBtBusy = FALSE;\r\nlimited_dig = FALSE;\r\n}\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bBtBusy);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_CTRL_AGG_SIZE, &b_bt_ctrl_agg_buf_size);\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_ACT_AGGREGATE_CTRL, NULL);\r\npCoexDm->limited_dig = limited_dig;\r\npBtCoexist->btc_set(pBtCoexist, BTC_SET_BL_BT_LIMITED_DIG, &limited_dig);\r\nhalbtc8192e1ant_RunCoexistMechanism(pBtCoexist);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_StackOperationNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte type\r\n)\r\n{\r\nif(BTC_STACK_OP_INQ_PAGE_PAIR_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], StackOP Inquiry/page/pair start notify\n"));\r\n}\r\nelse if(BTC_STACK_OP_INQ_PAGE_PAIR_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], StackOP Inquiry/page/pair finish notify\n"));\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_HaltNotify(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Halt notify\n"));\r\npBtCoexist->bStopCoexDm = true;\r\nhalbtc8192e1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, true);\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, FORCE_EXEC, FALSE, 0);\r\npBtCoexist->btc_write_1byte(pBtCoexist, 0x4f, 0xf);\r\nEXhalbtc8192e1ant_MediaStatusNotify(pBtCoexist, BTC_MEDIA_DISCONNECT);\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_PnpNotify(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte pnpState\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Pnp notify\n"));\r\nif(BTC_WIFI_PNP_SLEEP == pnpState)\r\n{\r\npBtCoexist->bStopCoexDm = true;\r\nhalbtc8192e1ant_IgnoreWlanAct(pBtCoexist, FORCE_EXEC, true);\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\n}\r\nelse if(BTC_WIFI_PNP_WAKE_UP == pnpState)\r\n{\r\n}\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_Periodical(\r\nIN PBTC_COEXIST pBtCoexist\r\n)\r\n{\r\nstatic u1Byte disVerInfoCnt=0;\r\nu4Byte fwVer=0, btPatchVer=0;\r\nstruct btc_board_info * pBoardInfo=&pBtCoexist->board_info;\r\nPBTC_STACK_INFO pStackInfo=&pBtCoexist->stack_info;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], ==========================Periodical===========================\n"));\r\nif(disVerInfoCnt <= 5)\r\n{\r\ndisVerInfoCnt += 1;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], ****************************************************************\n"));\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], Ant PG Num/ Ant Mech/ Ant Pos = %d/ %d/ %d\n", \\r\npBoardInfo->pg_ant_num, pBoardInfo->btdm_ant_num, pBoardInfo->btdm_ant_pos));\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], BT stack/ hci ext ver = %s / %d\n", \\r\n((pStackInfo->bProfileNotified)? "Yes":"No"), pStackInfo->hciVersion));\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_BT_PATCH_VER, &btPatchVer);\r\npBtCoexist->btc_get(pBtCoexist, BTC_GET_U4_WIFI_FW_VER, &fwVer);\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], CoexVer/ FwVer/ PatchVer = %d_%x/ 0x%x/ 0x%x(%d)\n", \\r\nGLCoexVerDate8192e1Ant, GLCoexVer8192e1Ant, fwVer, btPatchVer, btPatchVer));\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], ****************************************************************\n"));\r\n}\r\n#if(BT_AUTO_REPORT_ONLY_8192E_1ANT == 0)\r\nhalbtc8192e1ant_QueryBtInfo(pBtCoexist);\r\nhalbtc8192e1ant_MonitorBtCtr(pBtCoexist);\r\nhalbtc8192e1ant_MonitorBtEnableDisable(pBtCoexist);\r\n#else\r\nif( halbtc8192e1ant_IsWifiStatusChanged(pBtCoexist) ||\r\npCoexDm->bAutoTdmaAdjust)\r\n{\r\nhalbtc8192e1ant_RunCoexistMechanism(pBtCoexist);\r\n}\r\n#endif\r\n}\r\nVOID\r\nEXhalbtc8192e1ant_DbgControl(\r\nIN PBTC_COEXIST pBtCoexist,\r\nIN u1Byte opCode,\r\nIN u1Byte opLen,\r\nIN pu1Byte pData\r\n)\r\n{\r\nswitch(opCode)\r\n{\r\ncase BTC_DBG_SET_COEX_NORMAL:\r\npBtCoexist->manual_control = FALSE;\r\nhalbtc8192e1ant_InitCoexDm(pBtCoexist);\r\nbreak;\r\ncase BTC_DBG_SET_COEX_WIFI_ONLY:\r\npBtCoexist->manual_control = true;\r\nhalbtc8192e1ant_PowerSaveState(pBtCoexist, BTC_PS_WIFI_NATIVE, 0x0, 0x0);\r\nhalbtc8192e1ant_PsTdma(pBtCoexist, NORMAL_EXEC, FALSE, 9);\r\nbreak;\r\ncase BTC_DBG_SET_COEX_BT_ONLY:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}

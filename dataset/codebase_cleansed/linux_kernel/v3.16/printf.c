static int skip_atoi(const char **s)\r\n{\r\nint i = 0;\r\nwhile (isdigit(**s))\r\ni = i * 10 + *((*s)++) - '0';\r\nreturn i;\r\n}\r\nstatic char *number(char *str, long num, int base, int size, int precision,\r\nint type)\r\n{\r\nstatic const char digits[16] = "0123456789ABCDEF";\r\nchar tmp[66];\r\nchar c, sign, locase;\r\nint i;\r\nlocase = (type & SMALL);\r\nif (type & LEFT)\r\ntype &= ~ZEROPAD;\r\nif (base < 2 || base > 16)\r\nreturn NULL;\r\nc = (type & ZEROPAD) ? '0' : ' ';\r\nsign = 0;\r\nif (type & SIGN) {\r\nif (num < 0) {\r\nsign = '-';\r\nnum = -num;\r\nsize--;\r\n} else if (type & PLUS) {\r\nsign = '+';\r\nsize--;\r\n} else if (type & SPACE) {\r\nsign = ' ';\r\nsize--;\r\n}\r\n}\r\nif (type & SPECIAL) {\r\nif (base == 16)\r\nsize -= 2;\r\nelse if (base == 8)\r\nsize--;\r\n}\r\ni = 0;\r\nif (num == 0)\r\ntmp[i++] = '0';\r\nelse\r\nwhile (num != 0)\r\ntmp[i++] = (digits[__do_div(num, base)] | locase);\r\nif (i > precision)\r\nprecision = i;\r\nsize -= precision;\r\nif (!(type & (ZEROPAD + LEFT)))\r\nwhile (size-- > 0)\r\n*str++ = ' ';\r\nif (sign)\r\n*str++ = sign;\r\nif (type & SPECIAL) {\r\nif (base == 8)\r\n*str++ = '0';\r\nelse if (base == 16) {\r\n*str++ = '0';\r\n*str++ = ('X' | locase);\r\n}\r\n}\r\nif (!(type & LEFT))\r\nwhile (size-- > 0)\r\n*str++ = c;\r\nwhile (i < precision--)\r\n*str++ = '0';\r\nwhile (i-- > 0)\r\n*str++ = tmp[i];\r\nwhile (size-- > 0)\r\n*str++ = ' ';\r\nreturn str;\r\n}\r\nint vsprintf(char *buf, const char *fmt, va_list args)\r\n{\r\nint len;\r\nunsigned long num;\r\nint i, base;\r\nchar *str;\r\nconst char *s;\r\nint flags;\r\nint field_width;\r\nint precision;\r\nint qualifier;\r\nfor (str = buf; *fmt; ++fmt) {\r\nif (*fmt != '%') {\r\n*str++ = *fmt;\r\ncontinue;\r\n}\r\nflags = 0;\r\nrepeat:\r\n++fmt;\r\nswitch (*fmt) {\r\ncase '-':\r\nflags |= LEFT;\r\ngoto repeat;\r\ncase '+':\r\nflags |= PLUS;\r\ngoto repeat;\r\ncase ' ':\r\nflags |= SPACE;\r\ngoto repeat;\r\ncase '#':\r\nflags |= SPECIAL;\r\ngoto repeat;\r\ncase '0':\r\nflags |= ZEROPAD;\r\ngoto repeat;\r\n}\r\nfield_width = -1;\r\nif (isdigit(*fmt))\r\nfield_width = skip_atoi(&fmt);\r\nelse if (*fmt == '*') {\r\n++fmt;\r\nfield_width = va_arg(args, int);\r\nif (field_width < 0) {\r\nfield_width = -field_width;\r\nflags |= LEFT;\r\n}\r\n}\r\nprecision = -1;\r\nif (*fmt == '.') {\r\n++fmt;\r\nif (isdigit(*fmt))\r\nprecision = skip_atoi(&fmt);\r\nelse if (*fmt == '*') {\r\n++fmt;\r\nprecision = va_arg(args, int);\r\n}\r\nif (precision < 0)\r\nprecision = 0;\r\n}\r\nqualifier = -1;\r\nif (*fmt == 'h' || *fmt == 'l' || *fmt == 'L') {\r\nqualifier = *fmt;\r\n++fmt;\r\n}\r\nbase = 10;\r\nswitch (*fmt) {\r\ncase 'c':\r\nif (!(flags & LEFT))\r\nwhile (--field_width > 0)\r\n*str++ = ' ';\r\n*str++ = (unsigned char)va_arg(args, int);\r\nwhile (--field_width > 0)\r\n*str++ = ' ';\r\ncontinue;\r\ncase 's':\r\ns = va_arg(args, char *);\r\nlen = strnlen(s, precision);\r\nif (!(flags & LEFT))\r\nwhile (len < field_width--)\r\n*str++ = ' ';\r\nfor (i = 0; i < len; ++i)\r\n*str++ = *s++;\r\nwhile (len < field_width--)\r\n*str++ = ' ';\r\ncontinue;\r\ncase 'p':\r\nif (field_width == -1) {\r\nfield_width = 2 * sizeof(void *);\r\nflags |= ZEROPAD;\r\n}\r\nstr = number(str,\r\n(unsigned long)va_arg(args, void *), 16,\r\nfield_width, precision, flags);\r\ncontinue;\r\ncase 'n':\r\nif (qualifier == 'l') {\r\nlong *ip = va_arg(args, long *);\r\n*ip = (str - buf);\r\n} else {\r\nint *ip = va_arg(args, int *);\r\n*ip = (str - buf);\r\n}\r\ncontinue;\r\ncase '%':\r\n*str++ = '%';\r\ncontinue;\r\ncase 'o':\r\nbase = 8;\r\nbreak;\r\ncase 'x':\r\nflags |= SMALL;\r\ncase 'X':\r\nbase = 16;\r\nbreak;\r\ncase 'd':\r\ncase 'i':\r\nflags |= SIGN;\r\ncase 'u':\r\nbreak;\r\ndefault:\r\n*str++ = '%';\r\nif (*fmt)\r\n*str++ = *fmt;\r\nelse\r\n--fmt;\r\ncontinue;\r\n}\r\nif (qualifier == 'l')\r\nnum = va_arg(args, unsigned long);\r\nelse if (qualifier == 'h') {\r\nnum = (unsigned short)va_arg(args, int);\r\nif (flags & SIGN)\r\nnum = (short)num;\r\n} else if (flags & SIGN)\r\nnum = va_arg(args, int);\r\nelse\r\nnum = va_arg(args, unsigned int);\r\nstr = number(str, num, base, field_width, precision, flags);\r\n}\r\n*str = '\0';\r\nreturn str - buf;\r\n}\r\nint sprintf(char *buf, const char *fmt, ...)\r\n{\r\nva_list args;\r\nint i;\r\nva_start(args, fmt);\r\ni = vsprintf(buf, fmt, args);\r\nva_end(args);\r\nreturn i;\r\n}\r\nint printf(const char *fmt, ...)\r\n{\r\nchar printf_buf[1024];\r\nva_list args;\r\nint printed;\r\nva_start(args, fmt);\r\nprinted = vsprintf(printf_buf, fmt, args);\r\nva_end(args);\r\nputs(printf_buf);\r\nreturn printed;\r\n}

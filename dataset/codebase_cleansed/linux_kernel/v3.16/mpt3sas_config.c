static void\r\n_config_display_some_debug(struct MPT3SAS_ADAPTER *ioc, u16 smid,\r\nchar *calling_function_name, MPI2DefaultReply_t *mpi_reply)\r\n{\r\nMpi2ConfigRequest_t *mpi_request;\r\nchar *desc = NULL;\r\nif (!(ioc->logging_level & MPT_DEBUG_CONFIG))\r\nreturn;\r\nmpi_request = mpt3sas_base_get_msg_frame(ioc, smid);\r\nswitch (mpi_request->Header.PageType & MPI2_CONFIG_PAGETYPE_MASK) {\r\ncase MPI2_CONFIG_PAGETYPE_IO_UNIT:\r\ndesc = "io_unit";\r\nbreak;\r\ncase MPI2_CONFIG_PAGETYPE_IOC:\r\ndesc = "ioc";\r\nbreak;\r\ncase MPI2_CONFIG_PAGETYPE_BIOS:\r\ndesc = "bios";\r\nbreak;\r\ncase MPI2_CONFIG_PAGETYPE_RAID_VOLUME:\r\ndesc = "raid_volume";\r\nbreak;\r\ncase MPI2_CONFIG_PAGETYPE_MANUFACTURING:\r\ndesc = "manufaucturing";\r\nbreak;\r\ncase MPI2_CONFIG_PAGETYPE_RAID_PHYSDISK:\r\ndesc = "physdisk";\r\nbreak;\r\ncase MPI2_CONFIG_PAGETYPE_EXTENDED:\r\nswitch (mpi_request->ExtPageType) {\r\ncase MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT:\r\ndesc = "sas_io_unit";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER:\r\ndesc = "sas_expander";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE:\r\ndesc = "sas_device";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_SAS_PHY:\r\ndesc = "sas_phy";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_LOG:\r\ndesc = "log";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_ENCLOSURE:\r\ndesc = "enclosure";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_RAID_CONFIG:\r\ndesc = "raid_config";\r\nbreak;\r\ncase MPI2_CONFIG_EXTPAGETYPE_DRIVER_MAPPING:\r\ndesc = "driver_mapping";\r\nbreak;\r\n}\r\nbreak;\r\n}\r\nif (!desc)\r\nreturn;\r\npr_info(MPT3SAS_FMT\r\n"%s: %s(%d), action(%d), form(0x%08x), smid(%d)\n",\r\nioc->name, calling_function_name, desc,\r\nmpi_request->Header.PageNumber, mpi_request->Action,\r\nle32_to_cpu(mpi_request->PageAddress), smid);\r\nif (!mpi_reply)\r\nreturn;\r\nif (mpi_reply->IOCStatus || mpi_reply->IOCLogInfo)\r\npr_info(MPT3SAS_FMT\r\n"\tiocstatus(0x%04x), loginfo(0x%08x)\n",\r\nioc->name, le16_to_cpu(mpi_reply->IOCStatus),\r\nle32_to_cpu(mpi_reply->IOCLogInfo));\r\n}\r\nstatic int\r\n_config_alloc_config_dma_memory(struct MPT3SAS_ADAPTER *ioc,\r\nstruct config_request *mem)\r\n{\r\nint r = 0;\r\nif (mem->sz > ioc->config_page_sz) {\r\nmem->page = dma_alloc_coherent(&ioc->pdev->dev, mem->sz,\r\n&mem->page_dma, GFP_KERNEL);\r\nif (!mem->page) {\r\npr_err(MPT3SAS_FMT\r\n"%s: dma_alloc_coherent failed asking for (%d) bytes!!\n",\r\nioc->name, __func__, mem->sz);\r\nr = -ENOMEM;\r\n}\r\n} else {\r\nmem->page = ioc->config_page;\r\nmem->page_dma = ioc->config_page_dma;\r\n}\r\nreturn r;\r\n}\r\nstatic void\r\n_config_free_config_dma_memory(struct MPT3SAS_ADAPTER *ioc,\r\nstruct config_request *mem)\r\n{\r\nif (mem->sz > ioc->config_page_sz)\r\ndma_free_coherent(&ioc->pdev->dev, mem->sz, mem->page,\r\nmem->page_dma);\r\n}\r\nu8\r\nmpt3sas_config_done(struct MPT3SAS_ADAPTER *ioc, u16 smid, u8 msix_index,\r\nu32 reply)\r\n{\r\nMPI2DefaultReply_t *mpi_reply;\r\nif (ioc->config_cmds.status == MPT3_CMD_NOT_USED)\r\nreturn 1;\r\nif (ioc->config_cmds.smid != smid)\r\nreturn 1;\r\nioc->config_cmds.status |= MPT3_CMD_COMPLETE;\r\nmpi_reply = mpt3sas_base_get_reply_virt_addr(ioc, reply);\r\nif (mpi_reply) {\r\nioc->config_cmds.status |= MPT3_CMD_REPLY_VALID;\r\nmemcpy(ioc->config_cmds.reply, mpi_reply,\r\nmpi_reply->MsgLength*4);\r\n}\r\nioc->config_cmds.status &= ~MPT3_CMD_PENDING;\r\n#ifdef CONFIG_SCSI_MPT3SAS_LOGGING\r\n_config_display_some_debug(ioc, smid, "config_done", mpi_reply);\r\n#endif\r\nioc->config_cmds.smid = USHRT_MAX;\r\ncomplete(&ioc->config_cmds.done);\r\nreturn 1;\r\n}\r\nstatic int\r\n_config_request(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigRequest_t\r\n*mpi_request, Mpi2ConfigReply_t *mpi_reply, int timeout,\r\nvoid *config_page, u16 config_page_sz)\r\n{\r\nu16 smid;\r\nu32 ioc_state;\r\nunsigned long timeleft;\r\nMpi2ConfigRequest_t *config_request;\r\nint r;\r\nu8 retry_count, issue_host_reset = 0;\r\nu16 wait_state_count;\r\nstruct config_request mem;\r\nu32 ioc_status = UINT_MAX;\r\nmutex_lock(&ioc->config_cmds.mutex);\r\nif (ioc->config_cmds.status != MPT3_CMD_NOT_USED) {\r\npr_err(MPT3SAS_FMT "%s: config_cmd in use\n",\r\nioc->name, __func__);\r\nmutex_unlock(&ioc->config_cmds.mutex);\r\nreturn -EAGAIN;\r\n}\r\nretry_count = 0;\r\nmemset(&mem, 0, sizeof(struct config_request));\r\nmpi_request->VF_ID = 0;\r\nmpi_request->VP_ID = 0;\r\nif (config_page) {\r\nmpi_request->Header.PageVersion = mpi_reply->Header.PageVersion;\r\nmpi_request->Header.PageNumber = mpi_reply->Header.PageNumber;\r\nmpi_request->Header.PageType = mpi_reply->Header.PageType;\r\nmpi_request->Header.PageLength = mpi_reply->Header.PageLength;\r\nmpi_request->ExtPageLength = mpi_reply->ExtPageLength;\r\nmpi_request->ExtPageType = mpi_reply->ExtPageType;\r\nif (mpi_request->Header.PageLength)\r\nmem.sz = mpi_request->Header.PageLength * 4;\r\nelse\r\nmem.sz = le16_to_cpu(mpi_reply->ExtPageLength) * 4;\r\nr = _config_alloc_config_dma_memory(ioc, &mem);\r\nif (r != 0)\r\ngoto out;\r\nif (mpi_request->Action ==\r\nMPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT ||\r\nmpi_request->Action ==\r\nMPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM) {\r\nioc->base_add_sg_single(&mpi_request->PageBufferSGE,\r\nMPT3_CONFIG_COMMON_WRITE_SGLFLAGS | mem.sz,\r\nmem.page_dma);\r\nmemcpy(mem.page, config_page, min_t(u16, mem.sz,\r\nconfig_page_sz));\r\n} else {\r\nmemset(config_page, 0, config_page_sz);\r\nioc->base_add_sg_single(&mpi_request->PageBufferSGE,\r\nMPT3_CONFIG_COMMON_SGLFLAGS | mem.sz, mem.page_dma);\r\nmemset(mem.page, 0, min_t(u16, mem.sz, config_page_sz));\r\n}\r\n}\r\nretry_config:\r\nif (retry_count) {\r\nif (retry_count > 2) {\r\nr = -EFAULT;\r\ngoto free_mem;\r\n}\r\npr_info(MPT3SAS_FMT "%s: attempting retry (%d)\n",\r\nioc->name, __func__, retry_count);\r\n}\r\nwait_state_count = 0;\r\nioc_state = mpt3sas_base_get_iocstate(ioc, 1);\r\nwhile (ioc_state != MPI2_IOC_STATE_OPERATIONAL) {\r\nif (wait_state_count++ == MPT3_CONFIG_PAGE_DEFAULT_TIMEOUT) {\r\npr_err(MPT3SAS_FMT\r\n"%s: failed due to ioc not operational\n",\r\nioc->name, __func__);\r\nioc->config_cmds.status = MPT3_CMD_NOT_USED;\r\nr = -EFAULT;\r\ngoto free_mem;\r\n}\r\nssleep(1);\r\nioc_state = mpt3sas_base_get_iocstate(ioc, 1);\r\npr_info(MPT3SAS_FMT\r\n"%s: waiting for operational state(count=%d)\n",\r\nioc->name, __func__, wait_state_count);\r\n}\r\nif (wait_state_count)\r\npr_info(MPT3SAS_FMT "%s: ioc is operational\n",\r\nioc->name, __func__);\r\nsmid = mpt3sas_base_get_smid(ioc, ioc->config_cb_idx);\r\nif (!smid) {\r\npr_err(MPT3SAS_FMT "%s: failed obtaining a smid\n",\r\nioc->name, __func__);\r\nioc->config_cmds.status = MPT3_CMD_NOT_USED;\r\nr = -EAGAIN;\r\ngoto free_mem;\r\n}\r\nr = 0;\r\nmemset(mpi_reply, 0, sizeof(Mpi2ConfigReply_t));\r\nioc->config_cmds.status = MPT3_CMD_PENDING;\r\nconfig_request = mpt3sas_base_get_msg_frame(ioc, smid);\r\nioc->config_cmds.smid = smid;\r\nmemcpy(config_request, mpi_request, sizeof(Mpi2ConfigRequest_t));\r\n#ifdef CONFIG_SCSI_MPT3SAS_LOGGING\r\n_config_display_some_debug(ioc, smid, "config_request", NULL);\r\n#endif\r\ninit_completion(&ioc->config_cmds.done);\r\nmpt3sas_base_put_smid_default(ioc, smid);\r\ntimeleft = wait_for_completion_timeout(&ioc->config_cmds.done,\r\ntimeout*HZ);\r\nif (!(ioc->config_cmds.status & MPT3_CMD_COMPLETE)) {\r\npr_err(MPT3SAS_FMT "%s: timeout\n",\r\nioc->name, __func__);\r\n_debug_dump_mf(mpi_request,\r\nsizeof(Mpi2ConfigRequest_t)/4);\r\nretry_count++;\r\nif (ioc->config_cmds.smid == smid)\r\nmpt3sas_base_free_smid(ioc, smid);\r\nif ((ioc->shost_recovery) || (ioc->config_cmds.status &\r\nMPT3_CMD_RESET) || ioc->pci_error_recovery)\r\ngoto retry_config;\r\nissue_host_reset = 1;\r\nr = -EFAULT;\r\ngoto free_mem;\r\n}\r\nif (ioc->config_cmds.status & MPT3_CMD_REPLY_VALID) {\r\nmemcpy(mpi_reply, ioc->config_cmds.reply,\r\nsizeof(Mpi2ConfigReply_t));\r\nif ((mpi_request->Header.PageType & 0xF) !=\r\n(mpi_reply->Header.PageType & 0xF)) {\r\n_debug_dump_mf(mpi_request, ioc->request_sz/4);\r\n_debug_dump_reply(mpi_reply, ioc->request_sz/4);\r\npanic(KERN_WARNING MPT3SAS_FMT "%s: Firmware BUG:" \\r\n" mpi_reply mismatch: Requested PageType(0x%02x)" \\r\n" Reply PageType(0x%02x)\n", \\r\nioc->name, __func__,\r\n(mpi_request->Header.PageType & 0xF),\r\n(mpi_reply->Header.PageType & 0xF));\r\n}\r\nif (((mpi_request->Header.PageType & 0xF) ==\r\nMPI2_CONFIG_PAGETYPE_EXTENDED) &&\r\nmpi_request->ExtPageType != mpi_reply->ExtPageType) {\r\n_debug_dump_mf(mpi_request, ioc->request_sz/4);\r\n_debug_dump_reply(mpi_reply, ioc->request_sz/4);\r\npanic(KERN_WARNING MPT3SAS_FMT "%s: Firmware BUG:" \\r\n" mpi_reply mismatch: Requested ExtPageType(0x%02x)"\r\n" Reply ExtPageType(0x%02x)\n",\r\nioc->name, __func__, mpi_request->ExtPageType,\r\nmpi_reply->ExtPageType);\r\n}\r\nioc_status = le16_to_cpu(mpi_reply->IOCStatus)\r\n& MPI2_IOCSTATUS_MASK;\r\n}\r\nif (retry_count)\r\npr_info(MPT3SAS_FMT "%s: retry (%d) completed!!\n", \\r\nioc->name, __func__, retry_count);\r\nif ((ioc_status == MPI2_IOCSTATUS_SUCCESS) &&\r\nconfig_page && mpi_request->Action ==\r\nMPI2_CONFIG_ACTION_PAGE_READ_CURRENT) {\r\nu8 *p = (u8 *)mem.page;\r\nif (p) {\r\nif ((mpi_request->Header.PageType & 0xF) !=\r\n(p[3] & 0xF)) {\r\n_debug_dump_mf(mpi_request, ioc->request_sz/4);\r\n_debug_dump_reply(mpi_reply, ioc->request_sz/4);\r\n_debug_dump_config(p, min_t(u16, mem.sz,\r\nconfig_page_sz)/4);\r\npanic(KERN_WARNING MPT3SAS_FMT\r\n"%s: Firmware BUG:" \\r\n" config page mismatch:"\r\n" Requested PageType(0x%02x)"\r\n" Reply PageType(0x%02x)\n",\r\nioc->name, __func__,\r\n(mpi_request->Header.PageType & 0xF),\r\n(p[3] & 0xF));\r\n}\r\nif (((mpi_request->Header.PageType & 0xF) ==\r\nMPI2_CONFIG_PAGETYPE_EXTENDED) &&\r\n(mpi_request->ExtPageType != p[6])) {\r\n_debug_dump_mf(mpi_request, ioc->request_sz/4);\r\n_debug_dump_reply(mpi_reply, ioc->request_sz/4);\r\n_debug_dump_config(p, min_t(u16, mem.sz,\r\nconfig_page_sz)/4);\r\npanic(KERN_WARNING MPT3SAS_FMT\r\n"%s: Firmware BUG:" \\r\n" config page mismatch:"\r\n" Requested ExtPageType(0x%02x)"\r\n" Reply ExtPageType(0x%02x)\n",\r\nioc->name, __func__,\r\nmpi_request->ExtPageType, p[6]);\r\n}\r\n}\r\nmemcpy(config_page, mem.page, min_t(u16, mem.sz,\r\nconfig_page_sz));\r\n}\r\nfree_mem:\r\nif (config_page)\r\n_config_free_config_dma_memory(ioc, &mem);\r\nout:\r\nioc->config_cmds.status = MPT3_CMD_NOT_USED;\r\nmutex_unlock(&ioc->config_cmds.mutex);\r\nif (issue_host_reset)\r\nmpt3sas_base_hard_reset_handler(ioc, CAN_SLEEP,\r\nFORCE_BIG_HAMMER);\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_manufacturing_pg0(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2ManufacturingPage0_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_manufacturing_pg7(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2ManufacturingPage7_t *config_page,\r\nu16 sz)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\r\nmpi_request.Header.PageNumber = 7;\r\nmpi_request.Header.PageVersion = MPI2_MANUFACTURING7_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsz);\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_manufacturing_pg10(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply,\r\nstruct Mpi2ManufacturingPage10_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\r\nmpi_request.Header.PageNumber = 10;\r\nmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_manufacturing_pg11(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply,\r\nstruct Mpi2ManufacturingPage11_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\r\nmpi_request.Header.PageNumber = 11;\r\nmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_set_manufacturing_pg11(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply,\r\nstruct Mpi2ManufacturingPage11_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_MANUFACTURING;\r\nmpi_request.Header.PageNumber = 11;\r\nmpi_request.Header.PageVersion = MPI2_MANUFACTURING0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_bios_pg2(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2BiosPage2_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_BIOS;\r\nmpi_request.Header.PageNumber = 2;\r\nmpi_request.Header.PageVersion = MPI2_BIOSPAGE2_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_bios_pg3(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2BiosPage3_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_BIOS;\r\nmpi_request.Header.PageNumber = 3;\r\nmpi_request.Header.PageVersion = MPI2_BIOSPAGE3_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_iounit_pg0(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage0_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_IOUNITPAGE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage1_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_IOUNITPAGE1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_set_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2IOUnitPage1_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IO_UNIT;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_IOUNITPAGE1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_ioc_pg8(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2IOCPage8_t *config_page)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_IOC;\r\nmpi_request.Header.PageNumber = 8;\r\nmpi_request.Header.PageVersion = MPI2_IOCPAGE8_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_sas_device_pg0(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2SasDevicePage0_t *config_page,\r\nu32 form, u32 handle)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE;\r\nmpi_request.Header.PageVersion = MPI2_SASDEVICE0_PAGEVERSION;\r\nmpi_request.Header.PageNumber = 0;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_sas_device_pg1(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2SasDevicePage1_t *config_page,\r\nu32 form, u32 handle)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_DEVICE;\r\nmpi_request.Header.PageVersion = MPI2_SASDEVICE1_PAGEVERSION;\r\nmpi_request.Header.PageNumber = 1;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_number_hba_phys(struct MPT3SAS_ADAPTER *ioc, u8 *num_phys)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nu16 ioc_status;\r\nMpi2ConfigReply_t mpi_reply;\r\nMpi2SasIOUnitPage0_t config_page;\r\n*num_phys = 0;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, &mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, &mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, &config_page,\r\nsizeof(Mpi2SasIOUnitPage0_t));\r\nif (!r) {\r\nioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\r\nMPI2_IOCSTATUS_MASK;\r\nif (ioc_status == MPI2_IOCSTATUS_SUCCESS)\r\n*num_phys = config_page.NumPhys;\r\n}\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_sas_iounit_pg0(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2SasIOUnitPage0_t *config_page,\r\nu16 sz)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_sas_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2SasIOUnitPage1_t *config_page,\r\nu16 sz)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_set_sas_iounit_pg1(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2SasIOUnitPage1_t *config_page,\r\nu16 sz)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_IO_UNIT;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_SASIOUNITPAGE1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_CURRENT;\r\n_config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_WRITE_NVRAM;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_expander_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2ExpanderPage0_t *config_page, u32 form, u32 handle)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_SASEXPANDER0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_expander_pg1(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2ExpanderPage1_t *config_page, u32 phy_number,\r\nu16 handle)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_EXPANDER;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_SASEXPANDER1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress =\r\ncpu_to_le32(MPI2_SAS_EXPAND_PGAD_FORM_HNDL_PHY_NUM |\r\n(phy_number << MPI2_SAS_EXPAND_PGAD_PHYNUM_SHIFT) | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_enclosure_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2SasEnclosurePage0_t *config_page, u32 form, u32 handle)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_ENCLOSURE;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_SASENCLOSURE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_phy_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2SasPhyPage0_t *config_page, u32 phy_number)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_PHY;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_SASPHY0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress =\r\ncpu_to_le32(MPI2_SAS_PHY_PGAD_FORM_PHY_NUMBER | phy_number);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_phy_pg1(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2SasPhyPage1_t *config_page, u32 phy_number)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_SAS_PHY;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_SASPHY1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress =\r\ncpu_to_le32(MPI2_SAS_PHY_PGAD_FORM_PHY_NUMBER | phy_number);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_raid_volume_pg1(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2RaidVolPage1_t *config_page, u32 form,\r\nu32 handle)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_VOLUME;\r\nmpi_request.Header.PageNumber = 1;\r\nmpi_request.Header.PageVersion = MPI2_RAIDVOLPAGE1_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_number_pds(struct MPT3SAS_ADAPTER *ioc, u16 handle,\r\nu8 *num_pds)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nMpi2RaidVolPage0_t config_page;\r\nMpi2ConfigReply_t mpi_reply;\r\nint r;\r\nu16 ioc_status;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\n*num_pds = 0;\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_VOLUME;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_RAIDVOLPAGE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, &mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress =\r\ncpu_to_le32(MPI2_RAID_VOLUME_PGAD_FORM_HANDLE | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, &mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, &config_page,\r\nsizeof(Mpi2RaidVolPage0_t));\r\nif (!r) {\r\nioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\r\nMPI2_IOCSTATUS_MASK;\r\nif (ioc_status == MPI2_IOCSTATUS_SUCCESS)\r\n*num_pds = config_page.NumPhysDisks;\r\n}\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_raid_volume_pg0(struct MPT3SAS_ADAPTER *ioc,\r\nMpi2ConfigReply_t *mpi_reply, Mpi2RaidVolPage0_t *config_page, u32 form,\r\nu32 handle, u16 sz)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_VOLUME;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_RAIDVOLPAGE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | handle);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page, sz);\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_phys_disk_pg0(struct MPT3SAS_ADAPTER *ioc, Mpi2ConfigReply_t\r\n*mpi_reply, Mpi2RaidPhysDiskPage0_t *config_page, u32 form,\r\nu32 form_specific)\r\n{\r\nMpi2ConfigRequest_t mpi_request;\r\nint r;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_RAID_PHYSDISK;\r\nmpi_request.Header.PageNumber = 0;\r\nmpi_request.Header.PageVersion = MPI2_RAIDPHYSDISKPAGE0_PAGEVERSION;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.PageAddress = cpu_to_le32(form | form_specific);\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nr = _config_request(ioc, &mpi_request, mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nsizeof(*config_page));\r\nout:\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_volume_handle(struct MPT3SAS_ADAPTER *ioc, u16 pd_handle,\r\nu16 *volume_handle)\r\n{\r\nMpi2RaidConfigurationPage0_t *config_page = NULL;\r\nMpi2ConfigRequest_t mpi_request;\r\nMpi2ConfigReply_t mpi_reply;\r\nint r, i, config_page_sz;\r\nu16 ioc_status;\r\nint config_num;\r\nu16 element_type;\r\nu16 phys_disk_dev_handle;\r\n*volume_handle = 0;\r\nmemset(&mpi_request, 0, sizeof(Mpi2ConfigRequest_t));\r\nmpi_request.Function = MPI2_FUNCTION_CONFIG;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_HEADER;\r\nmpi_request.Header.PageType = MPI2_CONFIG_PAGETYPE_EXTENDED;\r\nmpi_request.ExtPageType = MPI2_CONFIG_EXTPAGETYPE_RAID_CONFIG;\r\nmpi_request.Header.PageVersion = MPI2_RAIDCONFIG0_PAGEVERSION;\r\nmpi_request.Header.PageNumber = 0;\r\nioc->build_zero_len_sge_mpi(ioc, &mpi_request.PageBufferSGE);\r\nr = _config_request(ioc, &mpi_request, &mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, NULL, 0);\r\nif (r)\r\ngoto out;\r\nmpi_request.Action = MPI2_CONFIG_ACTION_PAGE_READ_CURRENT;\r\nconfig_page_sz = (le16_to_cpu(mpi_reply.ExtPageLength) * 4);\r\nconfig_page = kmalloc(config_page_sz, GFP_KERNEL);\r\nif (!config_page) {\r\nr = -1;\r\ngoto out;\r\n}\r\nconfig_num = 0xff;\r\nwhile (1) {\r\nmpi_request.PageAddress = cpu_to_le32(config_num +\r\nMPI2_RAID_PGAD_FORM_GET_NEXT_CONFIGNUM);\r\nr = _config_request(ioc, &mpi_request, &mpi_reply,\r\nMPT3_CONFIG_PAGE_DEFAULT_TIMEOUT, config_page,\r\nconfig_page_sz);\r\nif (r)\r\ngoto out;\r\nr = -1;\r\nioc_status = le16_to_cpu(mpi_reply.IOCStatus) &\r\nMPI2_IOCSTATUS_MASK;\r\nif (ioc_status != MPI2_IOCSTATUS_SUCCESS)\r\ngoto out;\r\nfor (i = 0; i < config_page->NumElements; i++) {\r\nelement_type = le16_to_cpu(config_page->\r\nConfigElement[i].ElementFlags) &\r\nMPI2_RAIDCONFIG0_EFLAGS_MASK_ELEMENT_TYPE;\r\nif (element_type ==\r\nMPI2_RAIDCONFIG0_EFLAGS_VOL_PHYS_DISK_ELEMENT ||\r\nelement_type ==\r\nMPI2_RAIDCONFIG0_EFLAGS_OCE_ELEMENT) {\r\nphys_disk_dev_handle =\r\nle16_to_cpu(config_page->ConfigElement[i].\r\nPhysDiskDevHandle);\r\nif (phys_disk_dev_handle == pd_handle) {\r\n*volume_handle =\r\nle16_to_cpu(config_page->\r\nConfigElement[i].VolDevHandle);\r\nr = 0;\r\ngoto out;\r\n}\r\n} else if (element_type ==\r\nMPI2_RAIDCONFIG0_EFLAGS_HOT_SPARE_ELEMENT) {\r\n*volume_handle = 0;\r\nr = 0;\r\ngoto out;\r\n}\r\n}\r\nconfig_num = config_page->ConfigNum;\r\n}\r\nout:\r\nkfree(config_page);\r\nreturn r;\r\n}\r\nint\r\nmpt3sas_config_get_volume_wwid(struct MPT3SAS_ADAPTER *ioc, u16 volume_handle,\r\nu64 *wwid)\r\n{\r\nMpi2ConfigReply_t mpi_reply;\r\nMpi2RaidVolPage1_t raid_vol_pg1;\r\n*wwid = 0;\r\nif (!(mpt3sas_config_get_raid_volume_pg1(ioc, &mpi_reply,\r\n&raid_vol_pg1, MPI2_RAID_VOLUME_PGAD_FORM_HANDLE,\r\nvolume_handle))) {\r\n*wwid = le64_to_cpu(raid_vol_pg1.WWID);\r\nreturn 0;\r\n} else\r\nreturn -1;\r\n}

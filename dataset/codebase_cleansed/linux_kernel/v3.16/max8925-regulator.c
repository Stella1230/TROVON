static int max8925_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned char mask = rdev->desc->n_voltages - 1;\r\nreturn max8925_set_bits(info->i2c, info->vol_reg, mask, selector);\r\n}\r\nstatic int max8925_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned char data, mask;\r\nint ret;\r\nret = max8925_reg_read(info->i2c, info->vol_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nmask = rdev->desc->n_voltages - 1;\r\ndata = ret & mask;\r\nreturn data;\r\n}\r\nstatic int max8925_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->enable_reg,\r\nLDO_SEQ_MASK << LDO_SEQ_SHIFT |\r\nLDO_I2C_EN_MASK << LDO_I2C_EN_SHIFT,\r\nLDO_SEQ_I2C << LDO_SEQ_SHIFT |\r\nLDO_I2C_EN << LDO_I2C_EN_SHIFT);\r\n}\r\nstatic int max8925_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->enable_reg,\r\nLDO_SEQ_MASK << LDO_SEQ_SHIFT |\r\nLDO_I2C_EN_MASK << LDO_I2C_EN_SHIFT,\r\nLDO_SEQ_I2C << LDO_SEQ_SHIFT);\r\n}\r\nstatic int max8925_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nint ldo_seq, ret;\r\nret = max8925_reg_read(info->i2c, info->enable_reg);\r\nif (ret < 0)\r\nreturn ret;\r\nldo_seq = (ret >> LDO_SEQ_SHIFT) & LDO_SEQ_MASK;\r\nif (ldo_seq != LDO_SEQ_I2C)\r\nreturn 1;\r\nelse\r\nreturn ret & (LDO_I2C_EN_MASK << LDO_I2C_EN_SHIFT);\r\n}\r\nstatic int max8925_set_dvm_voltage(struct regulator_dev *rdev, int uV)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nunsigned char data, mask;\r\nif (uV < SD1_DVM_VMIN || uV > SD1_DVM_VMAX)\r\nreturn -EINVAL;\r\ndata = DIV_ROUND_UP(uV - SD1_DVM_VMIN, SD1_DVM_STEP);\r\ndata <<= SD1_DVM_SHIFT;\r\nmask = 3 << SD1_DVM_SHIFT;\r\nreturn max8925_set_bits(info->i2c, info->enable_reg, mask, data);\r\n}\r\nstatic int max8925_set_dvm_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->vol_reg, 1 << SD1_DVM_EN,\r\n1 << SD1_DVM_EN);\r\n}\r\nstatic int max8925_set_dvm_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8925_regulator_info *info = rdev_get_drvdata(rdev);\r\nreturn max8925_set_bits(info->i2c, info->vol_reg, 1 << SD1_DVM_EN, 0);\r\n}\r\nstatic int max8925_regulator_dt_init(struct platform_device *pdev,\r\nstruct regulator_config *config,\r\nint ridx)\r\n{\r\nstruct device_node *nproot, *np;\r\nint rcount;\r\nnproot = of_node_get(pdev->dev.parent->of_node);\r\nif (!nproot)\r\nreturn -ENODEV;\r\nnp = of_get_child_by_name(nproot, "regulators");\r\nif (!np) {\r\ndev_err(&pdev->dev, "failed to find regulators node\n");\r\nreturn -ENODEV;\r\n}\r\nrcount = of_regulator_match(&pdev->dev, np,\r\n&max8925_regulator_matches[ridx], 1);\r\nof_node_put(np);\r\nif (rcount < 0)\r\nreturn rcount;\r\nconfig->init_data = max8925_regulator_matches[ridx].init_data;\r\nconfig->of_node = max8925_regulator_matches[ridx].of_node;\r\nreturn 0;\r\n}\r\nstatic int max8925_regulator_probe(struct platform_device *pdev)\r\n{\r\nstruct max8925_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct regulator_init_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct regulator_config config = { };\r\nstruct max8925_regulator_info *ri;\r\nstruct resource *res;\r\nstruct regulator_dev *rdev;\r\nint i, regulator_idx;\r\nres = platform_get_resource(pdev, IORESOURCE_REG, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "No REG resource!\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(max8925_regulator_info); i++) {\r\nri = &max8925_regulator_info[i];\r\nif (ri->vol_reg == res->start) {\r\nregulator_idx = i;\r\nbreak;\r\n}\r\n}\r\nif (i == ARRAY_SIZE(max8925_regulator_info)) {\r\ndev_err(&pdev->dev, "Failed to find regulator %llu\n",\r\n(unsigned long long)res->start);\r\nreturn -EINVAL;\r\n}\r\nri->i2c = chip->i2c;\r\nconfig.dev = &pdev->dev;\r\nconfig.driver_data = ri;\r\nif (max8925_regulator_dt_init(pdev, &config, regulator_idx))\r\nif (pdata)\r\nconfig.init_data = pdata;\r\nrdev = devm_regulator_register(&pdev->dev, &ri->desc, &config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(&pdev->dev, "failed to register regulator %s\n",\r\nri->desc.name);\r\nreturn PTR_ERR(rdev);\r\n}\r\nplatform_set_drvdata(pdev, rdev);\r\nreturn 0;\r\n}\r\nstatic int __init max8925_regulator_init(void)\r\n{\r\nreturn platform_driver_register(&max8925_regulator_driver);\r\n}\r\nstatic void __exit max8925_regulator_exit(void)\r\n{\r\nplatform_driver_unregister(&max8925_regulator_driver);\r\n}

void gdbstub_io_init(void)\r\n{\r\n__UART(LCR) = UART_LCR_WLEN8;\r\n__UART(FCR) =\r\nUART_FCR_ENABLE_FIFO |\r\nUART_FCR_CLEAR_RCVR |\r\nUART_FCR_CLEAR_XMIT |\r\nUART_FCR_TRIGGER_1;\r\nFLOWCTL_CLEAR(DTR);\r\nFLOWCTL_SET(RTS);\r\n__UART(IER) = UART_IER_RDI | UART_IER_RLSI;\r\nmb();\r\n__set_IRR(6, __UART_IRR_NMI);\r\n}\r\nvoid gdbstub_set_baud(unsigned baud)\r\n{\r\nunsigned value, high, low;\r\nu8 lcr;\r\nvalue = __serial_clock_speed_HZ / 16 / baud;\r\nhigh = __serial_clock_speed_HZ / 16 / value;\r\nlow = __serial_clock_speed_HZ / 16 / (value + 1);\r\nif (low + (high - low) / 2 > baud)\r\nvalue++;\r\nlcr = __UART(LCR);\r\n__UART(LCR) |= UART_LCR_DLAB;\r\nmb();\r\n__UART(DLL) = value & 0xff;\r\n__UART(DLM) = (value >> 8) & 0xff;\r\nmb();\r\n__UART(LCR) = lcr;\r\nmb();\r\n}\r\nvoid gdbstub_do_rx(void)\r\n{\r\nunsigned ix, nix;\r\nix = gdbstub_rx_inp;\r\nwhile (__UART(LSR) & UART_LSR_DR) {\r\nnix = (ix + 2) & 0xfff;\r\nif (nix == gdbstub_rx_outp)\r\nbreak;\r\ngdbstub_rx_buffer[ix++] = __UART(LSR);\r\ngdbstub_rx_buffer[ix++] = __UART(RX);\r\nix = nix;\r\n}\r\ngdbstub_rx_inp = ix;\r\n__clr_RC(15);\r\n__clr_IRL();\r\n}\r\nint gdbstub_rx_char(unsigned char *_ch, int nonblock)\r\n{\r\nunsigned ix;\r\nu8 ch, st;\r\n*_ch = 0xff;\r\nif (gdbstub_rx_unget) {\r\n*_ch = gdbstub_rx_unget;\r\ngdbstub_rx_unget = 0;\r\nreturn 0;\r\n}\r\ntry_again:\r\ngdbstub_do_rx();\r\nix = gdbstub_rx_outp;\r\nif (ix == gdbstub_rx_inp) {\r\nif (nonblock)\r\nreturn -EAGAIN;\r\ngoto try_again;\r\n}\r\nst = gdbstub_rx_buffer[ix++];\r\nch = gdbstub_rx_buffer[ix++];\r\ngdbstub_rx_outp = ix & 0x00000fff;\r\nif (st & UART_LSR_BI) {\r\ngdbstub_proto("### GDB Rx Break Detected ###\n");\r\nreturn -EINTR;\r\n}\r\nelse if (st & (UART_LSR_FE|UART_LSR_OE|UART_LSR_PE)) {\r\ngdbstub_io("### GDB Rx Error (st=%02x) ###\n",st);\r\nreturn -EIO;\r\n}\r\nelse {\r\ngdbstub_io("### GDB Rx %02x (st=%02x) ###\n",ch,st);\r\n*_ch = ch & 0x7f;\r\nreturn 0;\r\n}\r\n}\r\nvoid gdbstub_tx_char(unsigned char ch)\r\n{\r\nFLOWCTL_SET(DTR);\r\nLSR_WAIT_FOR(THRE);\r\nif (ch == 0x0a) {\r\n__UART(TX) = 0x0d;\r\nmb();\r\nLSR_WAIT_FOR(THRE);\r\n}\r\n__UART(TX) = ch;\r\nmb();\r\nFLOWCTL_CLEAR(DTR);\r\n}\r\nvoid gdbstub_tx_flush(void)\r\n{\r\nLSR_WAIT_FOR(TEMT);\r\nLSR_WAIT_FOR(THRE);\r\nFLOWCTL_CLEAR(DTR);\r\n}

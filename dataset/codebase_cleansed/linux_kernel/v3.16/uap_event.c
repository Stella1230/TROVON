int mwifiex_process_uap_event(struct mwifiex_private *priv)\r\n{\r\nstruct mwifiex_adapter *adapter = priv->adapter;\r\nint len, i;\r\nu32 eventcause = adapter->event_cause;\r\nstruct station_info sinfo;\r\nstruct mwifiex_assoc_event *event;\r\nstruct mwifiex_sta_node *node;\r\nu8 *deauth_mac;\r\nstruct host_cmd_ds_11n_batimeout *ba_timeout;\r\nu16 ctrl;\r\nswitch (eventcause) {\r\ncase EVENT_UAP_STA_ASSOC:\r\nmemset(&sinfo, 0, sizeof(sinfo));\r\nevent = (struct mwifiex_assoc_event *)\r\n(adapter->event_body + MWIFIEX_UAP_EVENT_EXTRA_HEADER);\r\nif (le16_to_cpu(event->type) == TLV_TYPE_UAP_MGMT_FRAME) {\r\nlen = -1;\r\nif (ieee80211_is_assoc_req(event->frame_control))\r\nlen = 0;\r\nelse if (ieee80211_is_reassoc_req(event->frame_control))\r\nlen = ETH_ALEN;\r\nif (len != -1) {\r\nsinfo.filled = STATION_INFO_ASSOC_REQ_IES;\r\nsinfo.assoc_req_ies = &event->data[len];\r\nlen = (u8 *)sinfo.assoc_req_ies -\r\n(u8 *)&event->frame_control;\r\nsinfo.assoc_req_ies_len =\r\nle16_to_cpu(event->len) - (u16)len;\r\n}\r\n}\r\ncfg80211_new_sta(priv->netdev, event->sta_addr, &sinfo,\r\nGFP_KERNEL);\r\nnode = mwifiex_add_sta_entry(priv, event->sta_addr);\r\nif (!node) {\r\ndev_warn(adapter->dev,\r\n"could not create station entry!\n");\r\nreturn -1;\r\n}\r\nif (!priv->ap_11n_enabled)\r\nbreak;\r\nmwifiex_set_sta_ht_cap(priv, sinfo.assoc_req_ies,\r\nsinfo.assoc_req_ies_len, node);\r\nfor (i = 0; i < MAX_NUM_TID; i++) {\r\nif (node->is_11n_enabled)\r\nnode->ampdu_sta[i] =\r\npriv->aggr_prio_tbl[i].ampdu_user;\r\nelse\r\nnode->ampdu_sta[i] = BA_STREAM_NOT_ALLOWED;\r\n}\r\nmemset(node->rx_seq, 0xff, sizeof(node->rx_seq));\r\nbreak;\r\ncase EVENT_UAP_STA_DEAUTH:\r\ndeauth_mac = adapter->event_body +\r\nMWIFIEX_UAP_EVENT_EXTRA_HEADER;\r\ncfg80211_del_sta(priv->netdev, deauth_mac, GFP_KERNEL);\r\nif (priv->ap_11n_enabled) {\r\nmwifiex_11n_del_rx_reorder_tbl_by_ta(priv, deauth_mac);\r\nmwifiex_del_tx_ba_stream_tbl_by_ra(priv, deauth_mac);\r\n}\r\nmwifiex_del_sta_entry(priv, deauth_mac);\r\nbreak;\r\ncase EVENT_UAP_BSS_IDLE:\r\npriv->media_connected = false;\r\nif (netif_carrier_ok(priv->netdev))\r\nnetif_carrier_off(priv->netdev);\r\nmwifiex_stop_net_dev_queue(priv->netdev, adapter);\r\nmwifiex_clean_txrx(priv);\r\nmwifiex_del_all_sta_list(priv);\r\nbreak;\r\ncase EVENT_UAP_BSS_ACTIVE:\r\npriv->media_connected = true;\r\nif (!netif_carrier_ok(priv->netdev))\r\nnetif_carrier_on(priv->netdev);\r\nmwifiex_wake_up_net_dev_queue(priv->netdev, adapter);\r\nbreak;\r\ncase EVENT_UAP_BSS_START:\r\ndev_dbg(adapter->dev, "AP EVENT: event id: %#x\n", eventcause);\r\nmemcpy(priv->netdev->dev_addr, adapter->event_body + 2,\r\nETH_ALEN);\r\nbreak;\r\ncase EVENT_UAP_MIC_COUNTERMEASURES:\r\ndev_dbg(adapter->dev, "AP EVENT: event id: %#x\n", eventcause);\r\nbreak;\r\ncase EVENT_AMSDU_AGGR_CTRL:\r\nctrl = le16_to_cpu(*(__le16 *)adapter->event_body);\r\ndev_dbg(adapter->dev, "event: AMSDU_AGGR_CTRL %d\n", ctrl);\r\nif (priv->media_connected) {\r\nadapter->tx_buf_size =\r\nmin_t(u16, adapter->curr_tx_buf_size, ctrl);\r\ndev_dbg(adapter->dev, "event: tx_buf_size %d\n",\r\nadapter->tx_buf_size);\r\n}\r\nbreak;\r\ncase EVENT_ADDBA:\r\ndev_dbg(adapter->dev, "event: ADDBA Request\n");\r\nif (priv->media_connected)\r\nmwifiex_send_cmd(priv, HostCmd_CMD_11N_ADDBA_RSP,\r\nHostCmd_ACT_GEN_SET, 0,\r\nadapter->event_body, false);\r\nbreak;\r\ncase EVENT_DELBA:\r\ndev_dbg(adapter->dev, "event: DELBA Request\n");\r\nif (priv->media_connected)\r\nmwifiex_11n_delete_ba_stream(priv, adapter->event_body);\r\nbreak;\r\ncase EVENT_BA_STREAM_TIEMOUT:\r\ndev_dbg(adapter->dev, "event: BA Stream timeout\n");\r\nif (priv->media_connected) {\r\nba_timeout = (void *)adapter->event_body;\r\nmwifiex_11n_ba_stream_timeout(priv, ba_timeout);\r\n}\r\nbreak;\r\ncase EVENT_EXT_SCAN_REPORT:\r\ndev_dbg(adapter->dev, "event: EXT_SCAN Report\n");\r\nif (adapter->ext_scan)\r\nreturn mwifiex_handle_event_ext_scan_report(priv,\r\nadapter->event_skb->data);\r\nbreak;\r\ndefault:\r\ndev_dbg(adapter->dev, "event: unknown event id: %#x\n",\r\neventcause);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nvoid mwifiex_uap_del_sta_data(struct mwifiex_private *priv,\r\nstruct mwifiex_sta_node *node)\r\n{\r\nif (priv->ap_11n_enabled && node->is_11n_enabled) {\r\nmwifiex_11n_del_rx_reorder_tbl_by_ta(priv, node->mac_addr);\r\nmwifiex_del_tx_ba_stream_tbl_by_ra(priv, node->mac_addr);\r\n}\r\nmwifiex_del_sta_entry(priv, node->mac_addr);\r\nreturn;\r\n}

static int wf_lm87_read_reg(struct i2c_client *chip, int reg)\r\n{\r\nint rc, tries = 0;\r\nu8 buf;\r\nfor (;;) {\r\nbuf = (u8)reg;\r\nrc = i2c_master_send(chip, &buf, 1);\r\nif (rc <= 0)\r\ngoto error;\r\nrc = i2c_master_recv(chip, &buf, 1);\r\nif (rc <= 0)\r\ngoto error;\r\nreturn (int)buf;\r\nerror:\r\nDBG("wf_lm87: Error reading LM87, retrying...\n");\r\nif (++tries > 10) {\r\nprintk(KERN_ERR "wf_lm87: Error reading LM87 !\n");\r\nreturn -EIO;\r\n}\r\nmsleep(10);\r\n}\r\n}\r\nstatic int wf_lm87_get(struct wf_sensor *sr, s32 *value)\r\n{\r\nstruct wf_lm87_sensor *lm = sr->priv;\r\ns32 temp;\r\nif (lm->i2c == NULL)\r\nreturn -ENODEV;\r\n#define LM87_INT_TEMP 0x27\r\ntemp = wf_lm87_read_reg(lm->i2c, LM87_INT_TEMP);\r\nif (temp < 0)\r\nreturn temp;\r\n*value = temp << 16;\r\nreturn 0;\r\n}\r\nstatic void wf_lm87_release(struct wf_sensor *sr)\r\n{\r\nstruct wf_lm87_sensor *lm = wf_to_lm87(sr);\r\nkfree(lm);\r\n}\r\nstatic int wf_lm87_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct wf_lm87_sensor *lm;\r\nconst char *name = NULL, *loc;\r\nstruct device_node *np = NULL;\r\nint rc;\r\nwhile ((np = of_get_next_child(client->dev.of_node, np)) != NULL) {\r\nif (strcmp(np->name, "int-temp"))\r\ncontinue;\r\nloc = of_get_property(np, "location", NULL);\r\nif (!loc)\r\ncontinue;\r\nif (strstr(loc, "DIMM"))\r\nname = "dimms-temp";\r\nelse if (strstr(loc, "Processors"))\r\nname = "between-cpus-temp";\r\nif (name) {\r\nof_node_put(np);\r\nbreak;\r\n}\r\n}\r\nif (!name) {\r\npr_warning("wf_lm87: Unsupported sensor %s\n",\r\nclient->dev.of_node->full_name);\r\nreturn -ENODEV;\r\n}\r\nlm = kzalloc(sizeof(struct wf_lm87_sensor), GFP_KERNEL);\r\nif (lm == NULL)\r\nreturn -ENODEV;\r\nlm->i2c = client;\r\nlm->sens.name = name;\r\nlm->sens.ops = &wf_lm87_ops;\r\nlm->sens.priv = lm;\r\ni2c_set_clientdata(client, lm);\r\nrc = wf_register_sensor(&lm->sens);\r\nif (rc)\r\nkfree(lm);\r\nreturn rc;\r\n}\r\nstatic int wf_lm87_remove(struct i2c_client *client)\r\n{\r\nstruct wf_lm87_sensor *lm = i2c_get_clientdata(client);\r\nDBG("wf_lm87: i2c detatch called for %s\n", lm->sens.name);\r\nlm->i2c = NULL;\r\nwf_unregister_sensor(&lm->sens);\r\nreturn 0;\r\n}\r\nstatic int __init wf_lm87_sensor_init(void)\r\n{\r\nif (!of_machine_is_compatible("RackMac3,1"))\r\nreturn -ENODEV;\r\nreturn i2c_add_driver(&wf_lm87_driver);\r\n}\r\nstatic void __exit wf_lm87_sensor_exit(void)\r\n{\r\ni2c_del_driver(&wf_lm87_driver);\r\n}

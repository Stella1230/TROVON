void __init palm27x_mmc_init(int detect, int ro, int power,\r\nint power_inverted)\r\n{\r\npalm27x_mci_platform_data.gpio_card_detect = detect;\r\npalm27x_mci_platform_data.gpio_card_ro = ro;\r\npalm27x_mci_platform_data.gpio_power = power;\r\npalm27x_mci_platform_data.gpio_power_invert = power_inverted;\r\npxa_set_mci_info(&palm27x_mci_platform_data);\r\n}\r\nvoid __init palm27x_pm_init(unsigned long str_base)\r\n{\r\nstatic const unsigned long resume[] = {\r\n0xe3a00101,\r\n0xe380060f,\r\n0xe590f008,\r\n};\r\nmemcpy(phys_to_virt(str_base), resume, sizeof(resume));\r\n}\r\nstatic void palm27x_lcd_ctl(int on, struct fb_var_screeninfo *info)\r\n{\r\ngpio_set_value(palm27x_lcd_power, on);\r\n}\r\nvoid __init palm27x_lcd_init(int power, struct pxafb_mode_info *mode)\r\n{\r\npalm27x_lcd_screen.modes = mode;\r\nif (gpio_is_valid(power)) {\r\nif (!gpio_request(power, "LCD power")) {\r\npr_err("Palm27x: failed to claim lcd power gpio!\n");\r\nreturn;\r\n}\r\nif (!gpio_direction_output(power, 1)) {\r\npr_err("Palm27x: lcd power configuration failed!\n");\r\nreturn;\r\n}\r\npalm27x_lcd_power = power;\r\npalm27x_lcd_screen.pxafb_lcd_power = palm27x_lcd_ctl;\r\n}\r\npxa_set_fb_info(NULL, &palm27x_lcd_screen);\r\n}\r\nvoid __init palm27x_udc_init(int vbus, int pullup, int vbus_inverted)\r\n{\r\npalm27x_udc_info.gpio_vbus = vbus;\r\npalm27x_udc_info.gpio_pullup = pullup;\r\npalm27x_udc_info.gpio_vbus_inverted = vbus_inverted;\r\nif (!gpio_request(pullup, "USB Pullup")) {\r\ngpio_direction_output(pullup,\r\npalm27x_udc_info.gpio_vbus_inverted);\r\ngpio_free(pullup);\r\n} else\r\nreturn;\r\nplatform_device_register(&palm27x_gpio_vbus);\r\n}\r\nvoid __init palm27x_irda_init(int pwdn)\r\n{\r\npalm27x_ficp_platform_data.gpio_pwdown = pwdn;\r\npxa_set_ficp_info(&palm27x_ficp_platform_data);\r\n}\r\nvoid __init palm27x_ac97_init(int minv, int maxv, int jack, int reset)\r\n{\r\npalm27x_ac97_pdata.reset_gpio = reset;\r\npalm27x_asoc_pdata.jack_gpio = jack;\r\nif (minv < 0 || maxv < 0) {\r\npalm27x_ac97_pdata.codec_pdata[0] = NULL;\r\npxa_set_ac97_info(&palm27x_ac97_pdata);\r\n} else {\r\npalm27x_batt_pdata.min_voltage = minv,\r\npalm27x_batt_pdata.max_voltage = maxv,\r\npxa_set_ac97_info(&palm27x_ac97_pdata);\r\nplatform_device_register(&palm27x_asoc);\r\n}\r\n}\r\nstatic int palm27x_backlight_init(struct device *dev)\r\n{\r\nint ret;\r\nret = gpio_request(palm_bl_power, "BL POWER");\r\nif (ret)\r\ngoto err;\r\nret = gpio_direction_output(palm_bl_power, 0);\r\nif (ret)\r\ngoto err2;\r\nif (gpio_is_valid(palm_lcd_power)) {\r\nret = gpio_request(palm_lcd_power, "LCD POWER");\r\nif (ret)\r\ngoto err2;\r\nret = gpio_direction_output(palm_lcd_power, 0);\r\nif (ret)\r\ngoto err3;\r\n}\r\nreturn 0;\r\nerr3:\r\ngpio_free(palm_lcd_power);\r\nerr2:\r\ngpio_free(palm_bl_power);\r\nerr:\r\nreturn ret;\r\n}\r\nstatic int palm27x_backlight_notify(struct device *dev, int brightness)\r\n{\r\ngpio_set_value(palm_bl_power, brightness);\r\nif (gpio_is_valid(palm_lcd_power))\r\ngpio_set_value(palm_lcd_power, brightness);\r\nreturn brightness;\r\n}\r\nstatic void palm27x_backlight_exit(struct device *dev)\r\n{\r\ngpio_free(palm_bl_power);\r\nif (gpio_is_valid(palm_lcd_power))\r\ngpio_free(palm_lcd_power);\r\n}\r\nvoid __init palm27x_pwm_init(int bl, int lcd)\r\n{\r\npalm_bl_power = bl;\r\npalm_lcd_power = lcd;\r\nplatform_device_register(&palm27x_backlight);\r\n}\r\nstatic int palm27x_power_supply_init(struct device *dev)\r\n{\r\nint ret;\r\nret = gpio_request(palm_ac_state, "AC state");\r\nif (ret)\r\ngoto err1;\r\nret = gpio_direction_input(palm_ac_state);\r\nif (ret)\r\ngoto err2;\r\nif (gpio_is_valid(palm_usb_state)) {\r\nret = gpio_request(palm_usb_state, "USB state");\r\nif (ret)\r\ngoto err2;\r\nret = gpio_direction_input(palm_usb_state);\r\nif (ret)\r\ngoto err3;\r\n}\r\nreturn 0;\r\nerr3:\r\ngpio_free(palm_usb_state);\r\nerr2:\r\ngpio_free(palm_ac_state);\r\nerr1:\r\nreturn ret;\r\n}\r\nstatic void palm27x_power_supply_exit(struct device *dev)\r\n{\r\ngpio_free(palm_usb_state);\r\ngpio_free(palm_ac_state);\r\n}\r\nstatic int palm27x_is_ac_online(void)\r\n{\r\nreturn gpio_get_value(palm_ac_state);\r\n}\r\nstatic int palm27x_is_usb_online(void)\r\n{\r\nreturn !gpio_get_value(palm_usb_state);\r\n}\r\nvoid __init palm27x_power_init(int ac, int usb)\r\n{\r\npalm_ac_state = ac;\r\npalm_usb_state = usb;\r\nplatform_device_register(&palm27x_power_supply);\r\n}\r\nvoid __init palm27x_pmic_init(void)\r\n{\r\ni2c_register_board_info(1, ARRAY_AND_SIZE(palm27x_pi2c_board_info));\r\npxa27x_set_i2c_power_info(&palm27x_i2c_power_info);\r\n}

static int perf_do_probe_api(setup_probe_fn_t fn, int cpu, const char *str)\r\n{\r\nstruct perf_evlist *evlist;\r\nstruct perf_evsel *evsel;\r\nint err = -EAGAIN, fd;\r\nevlist = perf_evlist__new();\r\nif (!evlist)\r\nreturn -ENOMEM;\r\nif (parse_events(evlist, str))\r\ngoto out_delete;\r\nevsel = perf_evlist__first(evlist);\r\nfd = sys_perf_event_open(&evsel->attr, -1, cpu, -1, 0);\r\nif (fd < 0)\r\ngoto out_delete;\r\nclose(fd);\r\nfn(evsel);\r\nfd = sys_perf_event_open(&evsel->attr, -1, cpu, -1, 0);\r\nif (fd < 0) {\r\nif (errno == EINVAL)\r\nerr = -EINVAL;\r\ngoto out_delete;\r\n}\r\nclose(fd);\r\nerr = 0;\r\nout_delete:\r\nperf_evlist__delete(evlist);\r\nreturn err;\r\n}\r\nstatic bool perf_probe_api(setup_probe_fn_t fn)\r\n{\r\nconst char *try[] = {"cycles:u", "instructions:u", "cpu-clock", NULL};\r\nstruct cpu_map *cpus;\r\nint cpu, ret, i = 0;\r\ncpus = cpu_map__new(NULL);\r\nif (!cpus)\r\nreturn false;\r\ncpu = cpus->map[0];\r\ncpu_map__delete(cpus);\r\ndo {\r\nret = perf_do_probe_api(fn, cpu, try[i++]);\r\nif (!ret)\r\nreturn true;\r\n} while (ret == -EAGAIN && try[i]);\r\nreturn false;\r\n}\r\nstatic void perf_probe_sample_identifier(struct perf_evsel *evsel)\r\n{\r\nevsel->attr.sample_type |= PERF_SAMPLE_IDENTIFIER;\r\n}\r\nbool perf_can_sample_identifier(void)\r\n{\r\nreturn perf_probe_api(perf_probe_sample_identifier);\r\n}\r\nvoid perf_evlist__config(struct perf_evlist *evlist, struct record_opts *opts)\r\n{\r\nstruct perf_evsel *evsel;\r\nbool use_sample_identifier = false;\r\nif (opts->group)\r\nperf_evlist__set_leader(evlist);\r\nif (evlist->cpus->map[0] < 0)\r\nopts->no_inherit = true;\r\nevlist__for_each(evlist, evsel)\r\nperf_evsel__config(evsel, opts);\r\nif (evlist->nr_entries > 1) {\r\nstruct perf_evsel *first = perf_evlist__first(evlist);\r\nevlist__for_each(evlist, evsel) {\r\nif (evsel->attr.sample_type == first->attr.sample_type)\r\ncontinue;\r\nuse_sample_identifier = perf_can_sample_identifier();\r\nbreak;\r\n}\r\nevlist__for_each(evlist, evsel)\r\nperf_evsel__set_sample_id(evsel, use_sample_identifier);\r\n}\r\nperf_evlist__set_id_pos(evlist);\r\n}\r\nstatic int get_max_rate(unsigned int *rate)\r\n{\r\nchar path[PATH_MAX];\r\nconst char *procfs = procfs__mountpoint();\r\nif (!procfs)\r\nreturn -1;\r\nsnprintf(path, PATH_MAX,\r\n"%s/sys/kernel/perf_event_max_sample_rate", procfs);\r\nreturn filename__read_int(path, (int *) rate);\r\n}\r\nstatic int record_opts__config_freq(struct record_opts *opts)\r\n{\r\nbool user_freq = opts->user_freq != UINT_MAX;\r\nunsigned int max_rate;\r\nif (opts->user_interval != ULLONG_MAX)\r\nopts->default_interval = opts->user_interval;\r\nif (user_freq)\r\nopts->freq = opts->user_freq;\r\nif (opts->default_interval)\r\nopts->freq = 0;\r\nelse if (opts->freq) {\r\nopts->default_interval = opts->freq;\r\n} else {\r\npr_err("frequency and count are zero, aborting\n");\r\nreturn -1;\r\n}\r\nif (get_max_rate(&max_rate))\r\nreturn 0;\r\nif (user_freq && (max_rate < opts->freq)) {\r\npr_err("Maximum frequency rate (%u) reached.\n"\r\n"Please use -F freq option with lower value or consider\n"\r\n"tweaking /proc/sys/kernel/perf_event_max_sample_rate.\n",\r\nmax_rate);\r\nreturn -1;\r\n}\r\nif (max_rate < opts->freq) {\r\npr_warning("Lowering default frequency rate to %u.\n"\r\n"Please consider tweaking "\r\n"/proc/sys/kernel/perf_event_max_sample_rate.\n",\r\nmax_rate);\r\nopts->freq = max_rate;\r\n}\r\nreturn 0;\r\n}\r\nint record_opts__config(struct record_opts *opts)\r\n{\r\nreturn record_opts__config_freq(opts);\r\n}\r\nbool perf_evlist__can_select_event(struct perf_evlist *evlist, const char *str)\r\n{\r\nstruct perf_evlist *temp_evlist;\r\nstruct perf_evsel *evsel;\r\nint err, fd, cpu;\r\nbool ret = false;\r\ntemp_evlist = perf_evlist__new();\r\nif (!temp_evlist)\r\nreturn false;\r\nerr = parse_events(temp_evlist, str);\r\nif (err)\r\ngoto out_delete;\r\nevsel = perf_evlist__last(temp_evlist);\r\nif (!evlist || cpu_map__empty(evlist->cpus)) {\r\nstruct cpu_map *cpus = cpu_map__new(NULL);\r\ncpu = cpus ? cpus->map[0] : 0;\r\ncpu_map__delete(cpus);\r\n} else {\r\ncpu = evlist->cpus->map[0];\r\n}\r\nfd = sys_perf_event_open(&evsel->attr, -1, cpu, -1, 0);\r\nif (fd >= 0) {\r\nclose(fd);\r\nret = true;\r\n}\r\nout_delete:\r\nperf_evlist__delete(temp_evlist);\r\nreturn ret;\r\n}

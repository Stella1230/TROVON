static int ni_670x_ao_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct ni_670x_private *devpriv = dev->private;\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++) {\r\nwritel(((chan & 15) << 1) | ((chan & 16) >> 4),\r\ndevpriv->mite->daq_io_addr + AO_CHAN_OFFSET);\r\nwritel(data[i], devpriv->mite->daq_io_addr + AO_VALUE_OFFSET);\r\ndevpriv->ao_readback[chan] = data[i];\r\n}\r\nreturn i;\r\n}\r\nstatic int ni_670x_ao_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct ni_670x_private *devpriv = dev->private;\r\nint i;\r\nint chan = CR_CHAN(insn->chanspec);\r\nfor (i = 0; i < insn->n; i++)\r\ndata[i] = devpriv->ao_readback[chan];\r\nreturn i;\r\n}\r\nstatic int ni_670x_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct ni_670x_private *devpriv = dev->private;\r\nvoid __iomem *io_addr = devpriv->mite->daq_io_addr +\r\nDIO_PORT0_DATA_OFFSET;\r\nif (comedi_dio_update_state(s, data))\r\nwritel(s->state, io_addr);\r\ndata[1] = readl(io_addr);\r\nreturn insn->n;\r\n}\r\nstatic int ni_670x_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct ni_670x_private *devpriv = dev->private;\r\nint ret;\r\nret = comedi_dio_insn_config(dev, s, insn, data, 0);\r\nif (ret)\r\nreturn ret;\r\nwritel(s->io_bits, devpriv->mite->daq_io_addr + DIO_PORT0_DIR_OFFSET);\r\nreturn insn->n;\r\n}\r\nstatic int ni_670x_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct ni_670x_board *thisboard = NULL;\r\nstruct ni_670x_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\nint i;\r\nif (context < ARRAY_SIZE(ni_670x_boards))\r\nthisboard = &ni_670x_boards[context];\r\nif (!thisboard)\r\nreturn -ENODEV;\r\ndev->board_ptr = thisboard;\r\ndev->board_name = thisboard->name;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\ndevpriv->mite = mite_alloc(pcidev);\r\nif (!devpriv->mite)\r\nreturn -ENOMEM;\r\nret = mite_setup(devpriv->mite);\r\nif (ret < 0) {\r\ndev_warn(dev->class_dev, "error setting up mite\n");\r\nreturn ret;\r\n}\r\nret = comedi_alloc_subdevices(dev, 2);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = thisboard->ao_chans;\r\ns->maxdata = 0xffff;\r\nif (s->n_chan == 32) {\r\nconst struct comedi_lrange **range_table_list;\r\nrange_table_list = kmalloc(sizeof(struct comedi_lrange *) * 32,\r\nGFP_KERNEL);\r\nif (!range_table_list)\r\nreturn -ENOMEM;\r\ns->range_table_list = range_table_list;\r\nfor (i = 0; i < 16; i++) {\r\nrange_table_list[i] = &range_bipolar10;\r\nrange_table_list[16 + i] = &range_0_20mA;\r\n}\r\n} else {\r\ns->range_table = &range_bipolar10;\r\n}\r\ns->insn_write = &ni_670x_ao_winsn;\r\ns->insn_read = &ni_670x_ao_rinsn;\r\ns = &dev->subdevices[1];\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = 8;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = ni_670x_dio_insn_bits;\r\ns->insn_config = ni_670x_dio_insn_config;\r\nwritel(0x10, devpriv->mite->daq_io_addr + MISC_CONTROL_OFFSET);\r\nwritel(0x00, devpriv->mite->daq_io_addr + AO_CONTROL_OFFSET);\r\nreturn 0;\r\n}\r\nstatic void ni_670x_detach(struct comedi_device *dev)\r\n{\r\nstruct ni_670x_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s;\r\nif (dev->n_subdevices) {\r\ns = &dev->subdevices[0];\r\nif (s)\r\nkfree(s->range_table_list);\r\n}\r\nif (devpriv && devpriv->mite) {\r\nmite_unsetup(devpriv->mite);\r\nmite_free(devpriv->mite);\r\n}\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int ni_670x_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &ni_670x_driver, id->driver_data);\r\n}

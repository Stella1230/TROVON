static int exynos5250_rate_to_clk(unsigned long rate, u32 *reg)\r\n{\r\nswitch (rate) {\r\ncase 9600 * KHZ:\r\n*reg = EXYNOS_5250_FSEL_9MHZ6;\r\nbreak;\r\ncase 10 * MHZ:\r\n*reg = EXYNOS_5250_FSEL_10MHZ;\r\nbreak;\r\ncase 12 * MHZ:\r\n*reg = EXYNOS_5250_FSEL_12MHZ;\r\nbreak;\r\ncase 19200 * KHZ:\r\n*reg = EXYNOS_5250_FSEL_19MHZ2;\r\nbreak;\r\ncase 20 * MHZ:\r\n*reg = EXYNOS_5250_FSEL_20MHZ;\r\nbreak;\r\ncase 24 * MHZ:\r\n*reg = EXYNOS_5250_FSEL_24MHZ;\r\nbreak;\r\ncase 50 * MHZ:\r\n*reg = EXYNOS_5250_FSEL_50MHZ;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void exynos5250_isol(struct samsung_usb2_phy_instance *inst, bool on)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nu32 offset;\r\nu32 mask;\r\nswitch (inst->cfg->id) {\r\ncase EXYNOS5250_DEVICE:\r\noffset = EXYNOS_5250_USB_ISOL_OTG_OFFSET;\r\nmask = EXYNOS_5250_USB_ISOL_OTG;\r\nbreak;\r\ncase EXYNOS5250_HOST:\r\noffset = EXYNOS_5250_USB_ISOL_HOST_OFFSET;\r\nmask = EXYNOS_5250_USB_ISOL_HOST;\r\nbreak;\r\ndefault:\r\nreturn;\r\n};\r\nregmap_update_bits(drv->reg_pmu, offset, mask, on ? 0 : mask);\r\n}\r\nstatic int exynos5250_power_on(struct samsung_usb2_phy_instance *inst)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nu32 ctrl0;\r\nu32 otg;\r\nu32 ehci;\r\nu32 ohci;\r\nu32 hsic;\r\nswitch (inst->cfg->id) {\r\ncase EXYNOS5250_DEVICE:\r\nregmap_update_bits(drv->reg_sys,\r\nEXYNOS_5250_MODE_SWITCH_OFFSET,\r\nEXYNOS_5250_MODE_SWITCH_MASK,\r\nEXYNOS_5250_MODE_SWITCH_DEVICE);\r\notg = readl(drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\notg &= ~EXYNOS_5250_USBOTGSYS_FSEL_MASK;\r\notg |= drv->ref_reg_val << EXYNOS_5250_USBOTGSYS_FSEL_SHIFT;\r\notg &= ~(EXYNOS_5250_USBOTGSYS_FORCE_SUSPEND |\r\nEXYNOS_5250_USBOTGSYS_FORCE_SLEEP |\r\nEXYNOS_5250_USBOTGSYS_SIDDQ_UOTG);\r\notg |= EXYNOS_5250_USBOTGSYS_PHY_SW_RST |\r\nEXYNOS_5250_USBOTGSYS_PHYLINK_SW_RESET |\r\nEXYNOS_5250_USBOTGSYS_LINK_SW_RST_UOTG |\r\nEXYNOS_5250_USBOTGSYS_OTGDISABLE;\r\notg &= ~EXYNOS_5250_USBOTGSYS_REFCLKSEL_MASK;\r\notg |= EXYNOS_5250_REFCLKSEL_CLKCORE <<\r\nEXYNOS_5250_USBOTGSYS_REFCLKSEL_SHIFT;\r\nwritel(otg, drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\nudelay(100);\r\notg &= ~(EXYNOS_5250_USBOTGSYS_PHY_SW_RST |\r\nEXYNOS_5250_USBOTGSYS_LINK_SW_RST_UOTG |\r\nEXYNOS_5250_USBOTGSYS_PHYLINK_SW_RESET |\r\nEXYNOS_5250_USBOTGSYS_OTGDISABLE);\r\nwritel(otg, drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\nbreak;\r\ncase EXYNOS5250_HOST:\r\ncase EXYNOS5250_HSIC0:\r\ncase EXYNOS5250_HSIC1:\r\nctrl0 = readl(drv->reg_phy + EXYNOS_5250_HOSTPHYCTRL0);\r\nctrl0 &= ~EXYNOS_5250_HOSTPHYCTRL0_FSEL_MASK;\r\nctrl0 |= drv->ref_reg_val <<\r\nEXYNOS_5250_HOSTPHYCTRL0_FSEL_SHIFT;\r\nctrl0 &= ~(EXYNOS_5250_HOSTPHYCTRL0_PHYSWRST |\r\nEXYNOS_5250_HOSTPHYCTRL0_PHYSWRSTALL |\r\nEXYNOS_5250_HOSTPHYCTRL0_SIDDQ |\r\nEXYNOS_5250_HOSTPHYCTRL0_FORCESUSPEND |\r\nEXYNOS_5250_HOSTPHYCTRL0_FORCESLEEP);\r\nctrl0 |= EXYNOS_5250_HOSTPHYCTRL0_LINKSWRST |\r\nEXYNOS_5250_HOSTPHYCTRL0_UTMISWRST |\r\nEXYNOS_5250_HOSTPHYCTRL0_COMMON_ON_N;\r\nwritel(ctrl0, drv->reg_phy + EXYNOS_5250_HOSTPHYCTRL0);\r\nudelay(10);\r\nctrl0 &= ~(EXYNOS_5250_HOSTPHYCTRL0_LINKSWRST |\r\nEXYNOS_5250_HOSTPHYCTRL0_UTMISWRST);\r\nwritel(ctrl0, drv->reg_phy + EXYNOS_5250_HOSTPHYCTRL0);\r\notg = readl(drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\notg &= ~EXYNOS_5250_USBOTGSYS_FSEL_MASK;\r\notg |= drv->ref_reg_val << EXYNOS_5250_USBOTGSYS_FSEL_SHIFT;\r\notg &= ~(EXYNOS_5250_USBOTGSYS_FORCE_SUSPEND |\r\nEXYNOS_5250_USBOTGSYS_FORCE_SLEEP |\r\nEXYNOS_5250_USBOTGSYS_SIDDQ_UOTG);\r\notg |= EXYNOS_5250_USBOTGSYS_PHY_SW_RST |\r\nEXYNOS_5250_USBOTGSYS_PHYLINK_SW_RESET |\r\nEXYNOS_5250_USBOTGSYS_LINK_SW_RST_UOTG |\r\nEXYNOS_5250_USBOTGSYS_OTGDISABLE;\r\notg &= ~EXYNOS_5250_USBOTGSYS_REFCLKSEL_MASK;\r\notg |= EXYNOS_5250_REFCLKSEL_CLKCORE <<\r\nEXYNOS_5250_USBOTGSYS_REFCLKSEL_SHIFT;\r\nwritel(otg, drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\nudelay(10);\r\notg &= ~(EXYNOS_5250_USBOTGSYS_PHY_SW_RST |\r\nEXYNOS_5250_USBOTGSYS_LINK_SW_RST_UOTG |\r\nEXYNOS_5250_USBOTGSYS_PHYLINK_SW_RESET);\r\nhsic = (EXYNOS_5250_HSICPHYCTRLX_REFCLKDIV_12 |\r\nEXYNOS_5250_HSICPHYCTRLX_REFCLKSEL_DEFAULT |\r\nEXYNOS_5250_HSICPHYCTRLX_PHYSWRST);\r\nwritel(hsic, drv->reg_phy + EXYNOS_5250_HSICPHYCTRL1);\r\nwritel(hsic, drv->reg_phy + EXYNOS_5250_HSICPHYCTRL2);\r\nudelay(10);\r\nhsic &= ~EXYNOS_5250_HSICPHYCTRLX_PHYSWRST;\r\nwritel(hsic, drv->reg_phy + EXYNOS_5250_HSICPHYCTRL1);\r\nwritel(hsic, drv->reg_phy + EXYNOS_5250_HSICPHYCTRL2);\r\nudelay(80);\r\nehci = readl(drv->reg_phy + EXYNOS_5250_HOSTEHCICTRL);\r\nehci |= EXYNOS_5250_HOSTEHCICTRL_ENAINCRXALIGN |\r\nEXYNOS_5250_HOSTEHCICTRL_ENAINCR4 |\r\nEXYNOS_5250_HOSTEHCICTRL_ENAINCR8 |\r\nEXYNOS_5250_HOSTEHCICTRL_ENAINCR16;\r\nwritel(ehci, drv->reg_phy + EXYNOS_5250_HOSTEHCICTRL);\r\nohci = readl(drv->reg_phy + EXYNOS_5250_HOSTOHCICTRL);\r\nohci |= 0x1 << 3;\r\nwritel(ohci, drv->reg_phy + EXYNOS_5250_HOSTOHCICTRL);\r\nbreak;\r\n}\r\ninst->enabled = 1;\r\nexynos5250_isol(inst, 0);\r\nreturn 0;\r\n}\r\nstatic int exynos5250_power_off(struct samsung_usb2_phy_instance *inst)\r\n{\r\nstruct samsung_usb2_phy_driver *drv = inst->drv;\r\nu32 ctrl0;\r\nu32 otg;\r\nu32 hsic;\r\ninst->enabled = 0;\r\nexynos5250_isol(inst, 1);\r\nswitch (inst->cfg->id) {\r\ncase EXYNOS5250_DEVICE:\r\notg = readl(drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\notg |= (EXYNOS_5250_USBOTGSYS_FORCE_SUSPEND |\r\nEXYNOS_5250_USBOTGSYS_SIDDQ_UOTG |\r\nEXYNOS_5250_USBOTGSYS_FORCE_SLEEP);\r\nwritel(otg, drv->reg_phy + EXYNOS_5250_USBOTGSYS);\r\nbreak;\r\ncase EXYNOS5250_HOST:\r\nctrl0 = readl(drv->reg_phy + EXYNOS_5250_HOSTPHYCTRL0);\r\nctrl0 |= (EXYNOS_5250_HOSTPHYCTRL0_SIDDQ |\r\nEXYNOS_5250_HOSTPHYCTRL0_FORCESUSPEND |\r\nEXYNOS_5250_HOSTPHYCTRL0_FORCESLEEP |\r\nEXYNOS_5250_HOSTPHYCTRL0_PHYSWRST |\r\nEXYNOS_5250_HOSTPHYCTRL0_PHYSWRSTALL);\r\nwritel(ctrl0, drv->reg_phy + EXYNOS_5250_HOSTPHYCTRL0);\r\nbreak;\r\ncase EXYNOS5250_HSIC0:\r\ncase EXYNOS5250_HSIC1:\r\nhsic = (EXYNOS_5250_HSICPHYCTRLX_REFCLKDIV_12 |\r\nEXYNOS_5250_HSICPHYCTRLX_REFCLKSEL_DEFAULT |\r\nEXYNOS_5250_HSICPHYCTRLX_SIDDQ |\r\nEXYNOS_5250_HSICPHYCTRLX_FORCESLEEP |\r\nEXYNOS_5250_HSICPHYCTRLX_FORCESUSPEND\r\n);\r\nwritel(hsic, drv->reg_phy + EXYNOS_5250_HSICPHYCTRL1);\r\nwritel(hsic, drv->reg_phy + EXYNOS_5250_HSICPHYCTRL2);\r\nbreak;\r\n}\r\nreturn 0;\r\n}

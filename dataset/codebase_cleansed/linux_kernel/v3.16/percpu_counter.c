static int percpu_counter_fixup_free(void *addr, enum debug_obj_state state)\r\n{\r\nstruct percpu_counter *fbc = addr;\r\nswitch (state) {\r\ncase ODEBUG_STATE_ACTIVE:\r\npercpu_counter_destroy(fbc);\r\ndebug_object_free(fbc, &percpu_counter_debug_descr);\r\nreturn 1;\r\ndefault:\r\nreturn 0;\r\n}\r\n}\r\nstatic inline void debug_percpu_counter_activate(struct percpu_counter *fbc)\r\n{\r\ndebug_object_init(fbc, &percpu_counter_debug_descr);\r\ndebug_object_activate(fbc, &percpu_counter_debug_descr);\r\n}\r\nstatic inline void debug_percpu_counter_deactivate(struct percpu_counter *fbc)\r\n{\r\ndebug_object_deactivate(fbc, &percpu_counter_debug_descr);\r\ndebug_object_free(fbc, &percpu_counter_debug_descr);\r\n}\r\nstatic inline void debug_percpu_counter_activate(struct percpu_counter *fbc)\r\n{ }\r\nstatic inline void debug_percpu_counter_deactivate(struct percpu_counter *fbc)\r\n{ }\r\nvoid percpu_counter_set(struct percpu_counter *fbc, s64 amount)\r\n{\r\nint cpu;\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&fbc->lock, flags);\r\nfor_each_possible_cpu(cpu) {\r\ns32 *pcount = per_cpu_ptr(fbc->counters, cpu);\r\n*pcount = 0;\r\n}\r\nfbc->count = amount;\r\nraw_spin_unlock_irqrestore(&fbc->lock, flags);\r\n}\r\nvoid __percpu_counter_add(struct percpu_counter *fbc, s64 amount, s32 batch)\r\n{\r\ns64 count;\r\npreempt_disable();\r\ncount = __this_cpu_read(*fbc->counters) + amount;\r\nif (count >= batch || count <= -batch) {\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&fbc->lock, flags);\r\nfbc->count += count;\r\n__this_cpu_sub(*fbc->counters, count - amount);\r\nraw_spin_unlock_irqrestore(&fbc->lock, flags);\r\n} else {\r\nthis_cpu_add(*fbc->counters, amount);\r\n}\r\npreempt_enable();\r\n}\r\ns64 __percpu_counter_sum(struct percpu_counter *fbc)\r\n{\r\ns64 ret;\r\nint cpu;\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&fbc->lock, flags);\r\nret = fbc->count;\r\nfor_each_online_cpu(cpu) {\r\ns32 *pcount = per_cpu_ptr(fbc->counters, cpu);\r\nret += *pcount;\r\n}\r\nraw_spin_unlock_irqrestore(&fbc->lock, flags);\r\nreturn ret;\r\n}\r\nint __percpu_counter_init(struct percpu_counter *fbc, s64 amount,\r\nstruct lock_class_key *key)\r\n{\r\nraw_spin_lock_init(&fbc->lock);\r\nlockdep_set_class(&fbc->lock, key);\r\nfbc->count = amount;\r\nfbc->counters = alloc_percpu(s32);\r\nif (!fbc->counters)\r\nreturn -ENOMEM;\r\ndebug_percpu_counter_activate(fbc);\r\n#ifdef CONFIG_HOTPLUG_CPU\r\nINIT_LIST_HEAD(&fbc->list);\r\nspin_lock(&percpu_counters_lock);\r\nlist_add(&fbc->list, &percpu_counters);\r\nspin_unlock(&percpu_counters_lock);\r\n#endif\r\nreturn 0;\r\n}\r\nvoid percpu_counter_destroy(struct percpu_counter *fbc)\r\n{\r\nif (!fbc->counters)\r\nreturn;\r\ndebug_percpu_counter_deactivate(fbc);\r\n#ifdef CONFIG_HOTPLUG_CPU\r\nspin_lock(&percpu_counters_lock);\r\nlist_del(&fbc->list);\r\nspin_unlock(&percpu_counters_lock);\r\n#endif\r\nfree_percpu(fbc->counters);\r\nfbc->counters = NULL;\r\n}\r\nstatic void compute_batch_value(void)\r\n{\r\nint nr = num_online_cpus();\r\npercpu_counter_batch = max(32, nr*2);\r\n}\r\nstatic int percpu_counter_hotcpu_callback(struct notifier_block *nb,\r\nunsigned long action, void *hcpu)\r\n{\r\n#ifdef CONFIG_HOTPLUG_CPU\r\nunsigned int cpu;\r\nstruct percpu_counter *fbc;\r\ncompute_batch_value();\r\nif (action != CPU_DEAD && action != CPU_DEAD_FROZEN)\r\nreturn NOTIFY_OK;\r\ncpu = (unsigned long)hcpu;\r\nspin_lock(&percpu_counters_lock);\r\nlist_for_each_entry(fbc, &percpu_counters, list) {\r\ns32 *pcount;\r\nunsigned long flags;\r\nraw_spin_lock_irqsave(&fbc->lock, flags);\r\npcount = per_cpu_ptr(fbc->counters, cpu);\r\nfbc->count += *pcount;\r\n*pcount = 0;\r\nraw_spin_unlock_irqrestore(&fbc->lock, flags);\r\n}\r\nspin_unlock(&percpu_counters_lock);\r\n#endif\r\nreturn NOTIFY_OK;\r\n}\r\nint percpu_counter_compare(struct percpu_counter *fbc, s64 rhs)\r\n{\r\ns64 count;\r\ncount = percpu_counter_read(fbc);\r\nif (abs(count - rhs) > (percpu_counter_batch*num_online_cpus())) {\r\nif (count > rhs)\r\nreturn 1;\r\nelse\r\nreturn -1;\r\n}\r\ncount = percpu_counter_sum(fbc);\r\nif (count > rhs)\r\nreturn 1;\r\nelse if (count < rhs)\r\nreturn -1;\r\nelse\r\nreturn 0;\r\n}\r\nstatic int __init percpu_counter_startup(void)\r\n{\r\ncompute_batch_value();\r\nhotcpu_notifier(percpu_counter_hotcpu_callback, 0);\r\nreturn 0;\r\n}

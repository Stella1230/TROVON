static void ep93xx_wdt_timer_ping(unsigned long data)\r\n{\r\nif (time_before(jiffies, next_heartbeat))\r\nwritel(0x5555, mmio_base + EP93XX_WATCHDOG);\r\nmod_timer(&timer, jiffies + WDT_INTERVAL);\r\n}\r\nstatic int ep93xx_wdt_start(struct watchdog_device *wdd)\r\n{\r\nnext_heartbeat = jiffies + (timeout * HZ);\r\nwritel(0xaaaa, mmio_base + EP93XX_WATCHDOG);\r\nmod_timer(&timer, jiffies + WDT_INTERVAL);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_stop(struct watchdog_device *wdd)\r\n{\r\ndel_timer_sync(&timer);\r\nwritel(0xaa55, mmio_base + EP93XX_WATCHDOG);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_keepalive(struct watchdog_device *wdd)\r\n{\r\nnext_heartbeat = jiffies + (timeout * HZ);\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nunsigned long val;\r\nint err;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmmio_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(mmio_base))\r\nreturn PTR_ERR(mmio_base);\r\nif (timeout < 1 || timeout > 3600) {\r\ntimeout = WDT_TIMEOUT;\r\ndev_warn(&pdev->dev,\r\n"timeout value must be 1<=x<=3600, using %d\n",\r\ntimeout);\r\n}\r\nval = readl(mmio_base + EP93XX_WATCHDOG);\r\nep93xx_wdt_wdd.bootstatus = (val & 0x01) ? WDIOF_CARDRESET : 0;\r\nep93xx_wdt_wdd.timeout = timeout;\r\nwatchdog_set_nowayout(&ep93xx_wdt_wdd, nowayout);\r\nsetup_timer(&timer, ep93xx_wdt_timer_ping, 1);\r\nerr = watchdog_register_device(&ep93xx_wdt_wdd);\r\nif (err)\r\nreturn err;\r\ndev_info(&pdev->dev,\r\n"EP93XX watchdog, driver version " WDT_VERSION "%s\n",\r\n(val & 0x08) ? " (nCS1 disable detected)" : "");\r\nreturn 0;\r\n}\r\nstatic int ep93xx_wdt_remove(struct platform_device *pdev)\r\n{\r\nwatchdog_unregister_device(&ep93xx_wdt_wdd);\r\nreturn 0;\r\n}

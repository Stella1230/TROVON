int SM_SCSIIrp(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nint result;\r\nus->SrbStatus = SS_SUCCESS;\r\nswitch (srb->cmnd[0]) {\r\ncase TEST_UNIT_READY:\r\nresult = SM_SCSI_Test_Unit_Ready(us, srb);\r\nbreak;\r\ncase INQUIRY:\r\nresult = SM_SCSI_Inquiry(us, srb);\r\nbreak;\r\ncase MODE_SENSE:\r\nresult = SM_SCSI_Mode_Sense(us, srb);\r\nbreak;\r\ncase READ_CAPACITY:\r\nresult = SM_SCSI_Read_Capacity(us, srb);\r\nbreak;\r\ncase READ_10:\r\nresult = SM_SCSI_Read(us, srb);\r\nbreak;\r\ncase WRITE_10:\r\nresult = SM_SCSI_Write(us, srb);\r\nbreak;\r\ndefault:\r\nus->SrbStatus = SS_ILLEGAL_REQUEST;\r\nresult = USB_STOR_TRANSPORT_FAILED;\r\nbreak;\r\n}\r\nreturn result;\r\n}\r\nstatic int SM_SCSI_Test_Unit_Ready(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nif (us->SM_Status.Insert && us->SM_Status.Ready)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nelse {\r\nENE_SMInit(us);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int SM_SCSI_Inquiry(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nu8 data_ptr[36] = {0x00, 0x80, 0x02, 0x00, 0x1F, 0x00, 0x00, 0x00,\r\n0x55, 0x53, 0x42, 0x32, 0x2E, 0x30, 0x20,\r\n0x20, 0x43, 0x61, 0x72, 0x64, 0x52, 0x65,\r\n0x61, 0x64, 0x65, 0x72, 0x20, 0x20, 0x20,\r\n0x20, 0x20, 0x20, 0x30, 0x31, 0x30, 0x30};\r\nusb_stor_set_xfer_buf(us, data_ptr, 36, srb, TO_XFER_BUF);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int SM_SCSI_Mode_Sense(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nu8 mediaNoWP[12] = {0x0b, 0x00, 0x00, 0x08, 0x00, 0x00,\r\n0x71, 0xc0, 0x00, 0x00, 0x02, 0x00};\r\nu8 mediaWP[12] = {0x0b, 0x00, 0x80, 0x08, 0x00, 0x00,\r\n0x71, 0xc0, 0x00, 0x00, 0x02, 0x00};\r\nif (us->SM_Status.WtP)\r\nusb_stor_set_xfer_buf(us, mediaWP, 12, srb, TO_XFER_BUF);\r\nelse\r\nusb_stor_set_xfer_buf(us, mediaNoWP, 12, srb, TO_XFER_BUF);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int SM_SCSI_Read_Capacity(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nunsigned int offset = 0;\r\nstruct scatterlist *sg = NULL;\r\nu32 bl_num;\r\nu16 bl_len;\r\nu8 buf[8];\r\ndev_dbg(&us->pusb_dev->dev, "SM_SCSI_Read_Capacity\n");\r\nbl_len = 0x200;\r\nbl_num = Ssfdc.MaxLogBlocks * Ssfdc.MaxSectors * Ssfdc.MaxZones - 1;\r\nus->bl_num = bl_num;\r\ndev_dbg(&us->pusb_dev->dev, "bl_len = %x\n", bl_len);\r\ndev_dbg(&us->pusb_dev->dev, "bl_num = %x\n", bl_num);\r\nbuf[0] = (bl_num >> 24) & 0xff;\r\nbuf[1] = (bl_num >> 16) & 0xff;\r\nbuf[2] = (bl_num >> 8) & 0xff;\r\nbuf[3] = (bl_num >> 0) & 0xff;\r\nbuf[4] = (bl_len >> 24) & 0xff;\r\nbuf[5] = (bl_len >> 16) & 0xff;\r\nbuf[6] = (bl_len >> 8) & 0xff;\r\nbuf[7] = (bl_len >> 0) & 0xff;\r\nusb_stor_access_xfer_buf(us, buf, 8, srb, &sg, &offset, TO_XFER_BUF);\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int SM_SCSI_Read(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nint result = 0;\r\nu8 *Cdb = srb->cmnd;\r\nu32 bn = ((Cdb[2] << 24) & 0xff000000) |\r\n((Cdb[3] << 16) & 0x00ff0000) |\r\n((Cdb[4] << 8) & 0x0000ff00) |\r\n((Cdb[5] << 0) & 0x000000ff);\r\nu16 blen = ((Cdb[7] << 8) & 0xff00) | ((Cdb[8] << 0) & 0x00ff);\r\nu32 blenByte = blen * 0x200;\r\nvoid *buf;\r\nif (bn > us->bl_num)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nbuf = kmalloc(blenByte, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nresult = Media_D_ReadSector(us, bn, blen, buf);\r\nusb_stor_set_xfer_buf(us, buf, blenByte, srb, TO_XFER_BUF);\r\nkfree(buf);\r\nif (!result)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nelse\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}\r\nstatic int SM_SCSI_Write(struct us_data *us, struct scsi_cmnd *srb)\r\n{\r\nint result = 0;\r\nu8 *Cdb = srb->cmnd;\r\nu32 bn = ((Cdb[2] << 24) & 0xff000000) |\r\n((Cdb[3] << 16) & 0x00ff0000) |\r\n((Cdb[4] << 8) & 0x0000ff00) |\r\n((Cdb[5] << 0) & 0x000000ff);\r\nu16 blen = ((Cdb[7] << 8) & 0xff00) | ((Cdb[8] << 0) & 0x00ff);\r\nu32 blenByte = blen * 0x200;\r\nvoid *buf;\r\nif (bn > us->bl_num)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nbuf = kmalloc(blenByte, GFP_KERNEL);\r\nif (buf == NULL)\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nusb_stor_set_xfer_buf(us, buf, blenByte, srb, FROM_XFER_BUF);\r\nresult = Media_D_CopySector(us, bn, blen, buf);\r\nkfree(buf);\r\nif (!result)\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\nelse\r\nreturn USB_STOR_TRANSPORT_ERROR;\r\nreturn USB_STOR_TRANSPORT_GOOD;\r\n}

static int ir_rc5_sz_decode(struct rc_dev *dev, struct ir_raw_event ev)\r\n{\r\nstruct rc5_sz_dec *data = &dev->raw->rc5_sz;\r\nu8 toggle, command, system;\r\nu32 scancode;\r\nif (!rc_protocols_enabled(dev, RC_BIT_RC5_SZ))\r\nreturn 0;\r\nif (!is_timing_event(ev)) {\r\nif (ev.reset)\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nif (!geq_margin(ev.duration, RC5_UNIT, RC5_UNIT / 2))\r\ngoto out;\r\nagain:\r\nIR_dprintk(2, "RC5-sz decode started at state %i (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\nif (!geq_margin(ev.duration, RC5_UNIT, RC5_UNIT / 2))\r\nreturn 0;\r\nswitch (data->state) {\r\ncase STATE_INACTIVE:\r\nif (!ev.pulse)\r\nbreak;\r\ndata->state = STATE_BIT_START;\r\ndata->count = 1;\r\ndata->wanted_bits = RC5_SZ_NBITS;\r\ndecrease_duration(&ev, RC5_BIT_START);\r\ngoto again;\r\ncase STATE_BIT_START:\r\nif (!eq_margin(ev.duration, RC5_BIT_START, RC5_UNIT / 2))\r\nbreak;\r\ndata->bits <<= 1;\r\nif (!ev.pulse)\r\ndata->bits |= 1;\r\ndata->count++;\r\ndata->state = STATE_BIT_END;\r\nreturn 0;\r\ncase STATE_BIT_END:\r\nif (!is_transition(&ev, &dev->raw->prev_ev))\r\nbreak;\r\nif (data->count == data->wanted_bits)\r\ndata->state = STATE_FINISHED;\r\nelse\r\ndata->state = STATE_BIT_START;\r\ndecrease_duration(&ev, RC5_BIT_END);\r\ngoto again;\r\ncase STATE_FINISHED:\r\nif (ev.pulse)\r\nbreak;\r\ncommand = (data->bits & 0x0003F) >> 0;\r\nsystem = (data->bits & 0x02FC0) >> 6;\r\ntoggle = (data->bits & 0x01000) ? 1 : 0;\r\nscancode = system << 6 | command;\r\nIR_dprintk(1, "RC5-sz scancode 0x%04x (toggle: %u)\n",\r\nscancode, toggle);\r\nrc_keydown(dev, scancode, toggle);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nout:\r\nIR_dprintk(1, "RC5-sz decode failed at state %i (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\ndata->state = STATE_INACTIVE;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init ir_rc5_sz_decode_init(void)\r\n{\r\nir_raw_handler_register(&rc5_sz_handler);\r\nprintk(KERN_INFO "IR RC5 (streamzap) protocol handler initialized\n");\r\nreturn 0;\r\n}\r\nstatic void __exit ir_rc5_sz_decode_exit(void)\r\n{\r\nir_raw_handler_unregister(&rc5_sz_handler);\r\n}

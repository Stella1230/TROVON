static void __init autcpu12_adjust_parts(struct gpio_nand_platdata *pdata,\r\nsize_t sz)\r\n{\r\nswitch (sz) {\r\ncase SZ_16M:\r\ncase SZ_32M:\r\nbreak;\r\ncase SZ_64M:\r\ncase SZ_128M:\r\npdata->parts[0].size = SZ_16M;\r\nbreak;\r\ndefault:\r\npr_warn("Unsupported SmartMedia device size %u\n", sz);\r\nbreak;\r\n}\r\n}\r\nstatic void __init autcpu12_nvram_init(void)\r\n{\r\nvoid __iomem *nvram;\r\nunsigned int save[2];\r\nresource_size_t nvram_size = SZ_128K;\r\nnvram = ioremap(autcpu12_nvram_resource[0].start, SZ_128K);\r\nif (nvram) {\r\nsave[0] = readl(nvram + 0);\r\nsave[1] = readl(nvram + SZ_64K);\r\nwritel(~save[0], nvram + SZ_64K);\r\nif (readl(nvram + 0) != save[0]) {\r\nwritel(save[0], nvram + 0);\r\nnvram_size = SZ_32K;\r\n} else\r\nwritel(save[1], nvram + SZ_64K);\r\niounmap(nvram);\r\nautcpu12_nvram_resource[0].end =\r\nautcpu12_nvram_resource[0].start + nvram_size - 1;\r\nplatform_device_register(&autcpu12_nvram_pdev);\r\n} else\r\npr_err("Failed to remap NVRAM resource\n");\r\n}\r\nstatic void __init autcpu12_init(void)\r\n{\r\nclps711x_devices_init();\r\nplatform_device_register(&autcpu12_flash_pdev);\r\nplatform_device_register_simple("video-clps711x", 0, NULL, 0);\r\nplatform_device_register_simple("cs89x0", 0, autcpu12_cs8900_resource,\r\nARRAY_SIZE(autcpu12_cs8900_resource));\r\nplatform_device_register(&autcpu12_mmgpio_pdev);\r\nautcpu12_nvram_init();\r\n}\r\nstatic void __init autcpu12_init_late(void)\r\n{\r\ngpio_request_array(autcpu12_gpios, ARRAY_SIZE(autcpu12_gpios));\r\nplatform_device_register(&autcpu12_nand_pdev);\r\n}

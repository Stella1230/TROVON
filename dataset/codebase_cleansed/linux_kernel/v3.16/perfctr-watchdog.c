static inline unsigned int nmi_perfctr_msr_to_bit(unsigned int msr)\r\n{\r\nswitch (boot_cpu_data.x86_vendor) {\r\ncase X86_VENDOR_AMD:\r\nif (msr >= MSR_F15H_PERF_CTR)\r\nreturn (msr - MSR_F15H_PERF_CTR) >> 1;\r\nreturn msr - MSR_K7_PERFCTR0;\r\ncase X86_VENDOR_INTEL:\r\nif (cpu_has(&boot_cpu_data, X86_FEATURE_ARCH_PERFMON))\r\nreturn msr - MSR_ARCH_PERFMON_PERFCTR0;\r\nswitch (boot_cpu_data.x86) {\r\ncase 6:\r\nreturn msr - MSR_P6_PERFCTR0;\r\ncase 11:\r\nreturn msr - MSR_KNC_PERFCTR0;\r\ncase 15:\r\nreturn msr - MSR_P4_BPU_PERFCTR0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic inline unsigned int nmi_evntsel_msr_to_bit(unsigned int msr)\r\n{\r\nswitch (boot_cpu_data.x86_vendor) {\r\ncase X86_VENDOR_AMD:\r\nif (msr >= MSR_F15H_PERF_CTL)\r\nreturn (msr - MSR_F15H_PERF_CTL) >> 1;\r\nreturn msr - MSR_K7_EVNTSEL0;\r\ncase X86_VENDOR_INTEL:\r\nif (cpu_has(&boot_cpu_data, X86_FEATURE_ARCH_PERFMON))\r\nreturn msr - MSR_ARCH_PERFMON_EVENTSEL0;\r\nswitch (boot_cpu_data.x86) {\r\ncase 6:\r\nreturn msr - MSR_P6_EVNTSEL0;\r\ncase 11:\r\nreturn msr - MSR_KNC_EVNTSEL0;\r\ncase 15:\r\nreturn msr - MSR_P4_BSU_ESCR0;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nint avail_to_resrv_perfctr_nmi_bit(unsigned int counter)\r\n{\r\nBUG_ON(counter > NMI_MAX_COUNTER_BITS);\r\nreturn !test_bit(counter, perfctr_nmi_owner);\r\n}\r\nint reserve_perfctr_nmi(unsigned int msr)\r\n{\r\nunsigned int counter;\r\ncounter = nmi_perfctr_msr_to_bit(msr);\r\nif (counter > NMI_MAX_COUNTER_BITS)\r\nreturn 1;\r\nif (!test_and_set_bit(counter, perfctr_nmi_owner))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid release_perfctr_nmi(unsigned int msr)\r\n{\r\nunsigned int counter;\r\ncounter = nmi_perfctr_msr_to_bit(msr);\r\nif (counter > NMI_MAX_COUNTER_BITS)\r\nreturn;\r\nclear_bit(counter, perfctr_nmi_owner);\r\n}\r\nint reserve_evntsel_nmi(unsigned int msr)\r\n{\r\nunsigned int counter;\r\ncounter = nmi_evntsel_msr_to_bit(msr);\r\nif (counter > NMI_MAX_COUNTER_BITS)\r\nreturn 1;\r\nif (!test_and_set_bit(counter, evntsel_nmi_owner))\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid release_evntsel_nmi(unsigned int msr)\r\n{\r\nunsigned int counter;\r\ncounter = nmi_evntsel_msr_to_bit(msr);\r\nif (counter > NMI_MAX_COUNTER_BITS)\r\nreturn;\r\nclear_bit(counter, evntsel_nmi_owner);\r\n}

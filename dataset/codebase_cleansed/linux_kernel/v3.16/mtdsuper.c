static int get_sb_mtd_compare(struct super_block *sb, void *_mtd)\r\n{\r\nstruct mtd_info *mtd = _mtd;\r\nif (sb->s_mtd == mtd) {\r\npr_debug("MTDSB: Match on device %d (\"%s\")\n",\r\nmtd->index, mtd->name);\r\nreturn 1;\r\n}\r\npr_debug("MTDSB: No match, device %d (\"%s\"), device %d (\"%s\")\n",\r\nsb->s_mtd->index, sb->s_mtd->name, mtd->index, mtd->name);\r\nreturn 0;\r\n}\r\nstatic int get_sb_mtd_set(struct super_block *sb, void *_mtd)\r\n{\r\nstruct mtd_info *mtd = _mtd;\r\nsb->s_mtd = mtd;\r\nsb->s_dev = MKDEV(MTD_BLOCK_MAJOR, mtd->index);\r\nsb->s_bdi = mtd->backing_dev_info;\r\nreturn 0;\r\n}\r\nstatic struct dentry *mount_mtd_aux(struct file_system_type *fs_type, int flags,\r\nconst char *dev_name, void *data,\r\nstruct mtd_info *mtd,\r\nint (*fill_super)(struct super_block *, void *, int))\r\n{\r\nstruct super_block *sb;\r\nint ret;\r\nsb = sget(fs_type, get_sb_mtd_compare, get_sb_mtd_set, flags, mtd);\r\nif (IS_ERR(sb))\r\ngoto out_error;\r\nif (sb->s_root)\r\ngoto already_mounted;\r\npr_debug("MTDSB: New superblock for device %d (\"%s\")\n",\r\nmtd->index, mtd->name);\r\nret = fill_super(sb, data, flags & MS_SILENT ? 1 : 0);\r\nif (ret < 0) {\r\ndeactivate_locked_super(sb);\r\nreturn ERR_PTR(ret);\r\n}\r\nsb->s_flags |= MS_ACTIVE;\r\nreturn dget(sb->s_root);\r\nalready_mounted:\r\npr_debug("MTDSB: Device %d (\"%s\") is already mounted\n",\r\nmtd->index, mtd->name);\r\nput_mtd_device(mtd);\r\nreturn dget(sb->s_root);\r\nout_error:\r\nput_mtd_device(mtd);\r\nreturn ERR_CAST(sb);\r\n}\r\nstatic struct dentry *mount_mtd_nr(struct file_system_type *fs_type, int flags,\r\nconst char *dev_name, void *data, int mtdnr,\r\nint (*fill_super)(struct super_block *, void *, int))\r\n{\r\nstruct mtd_info *mtd;\r\nmtd = get_mtd_device(NULL, mtdnr);\r\nif (IS_ERR(mtd)) {\r\npr_debug("MTDSB: Device #%u doesn't appear to exist\n", mtdnr);\r\nreturn ERR_CAST(mtd);\r\n}\r\nreturn mount_mtd_aux(fs_type, flags, dev_name, data, mtd, fill_super);\r\n}\r\nstruct dentry *mount_mtd(struct file_system_type *fs_type, int flags,\r\nconst char *dev_name, void *data,\r\nint (*fill_super)(struct super_block *, void *, int))\r\n{\r\n#ifdef CONFIG_BLOCK\r\nstruct block_device *bdev;\r\nint ret, major;\r\n#endif\r\nint mtdnr;\r\nif (!dev_name)\r\nreturn ERR_PTR(-EINVAL);\r\npr_debug("MTDSB: dev_name \"%s\"\n", dev_name);\r\nif (dev_name[0] == 'm' && dev_name[1] == 't' && dev_name[2] == 'd') {\r\nif (dev_name[3] == ':') {\r\nstruct mtd_info *mtd;\r\npr_debug("MTDSB: mtd:%%s, name \"%s\"\n",\r\ndev_name + 4);\r\nmtd = get_mtd_device_nm(dev_name + 4);\r\nif (!IS_ERR(mtd))\r\nreturn mount_mtd_aux(\r\nfs_type, flags,\r\ndev_name, data, mtd,\r\nfill_super);\r\nprintk(KERN_NOTICE "MTD:"\r\n" MTD device with name \"%s\" not found.\n",\r\ndev_name + 4);\r\n} else if (isdigit(dev_name[3])) {\r\nchar *endptr;\r\nmtdnr = simple_strtoul(dev_name + 3, &endptr, 0);\r\nif (!*endptr) {\r\npr_debug("MTDSB: mtd%%d, mtdnr %d\n",\r\nmtdnr);\r\nreturn mount_mtd_nr(fs_type, flags,\r\ndev_name, data,\r\nmtdnr, fill_super);\r\n}\r\n}\r\n}\r\n#ifdef CONFIG_BLOCK\r\nbdev = lookup_bdev(dev_name);\r\nif (IS_ERR(bdev)) {\r\nret = PTR_ERR(bdev);\r\npr_debug("MTDSB: lookup_bdev() returned %d\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\npr_debug("MTDSB: lookup_bdev() returned 0\n");\r\nret = -EINVAL;\r\nmajor = MAJOR(bdev->bd_dev);\r\nmtdnr = MINOR(bdev->bd_dev);\r\nbdput(bdev);\r\nif (major != MTD_BLOCK_MAJOR)\r\ngoto not_an_MTD_device;\r\nreturn mount_mtd_nr(fs_type, flags, dev_name, data, mtdnr, fill_super);\r\nnot_an_MTD_device:\r\n#endif\r\nif (!(flags & MS_SILENT))\r\nprintk(KERN_NOTICE\r\n"MTD: Attempt to mount non-MTD device \"%s\"\n",\r\ndev_name);\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nvoid kill_mtd_super(struct super_block *sb)\r\n{\r\ngeneric_shutdown_super(sb);\r\nput_mtd_device(sb->s_mtd);\r\nsb->s_mtd = NULL;\r\n}

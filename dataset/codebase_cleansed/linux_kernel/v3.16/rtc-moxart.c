static void moxart_rtc_write_byte(struct device *dev, u8 data)\r\n{\r\nstruct moxart_rtc *moxart_rtc = dev_get_drvdata(dev);\r\nint i;\r\nfor (i = 0; i < 8; i++, data >>= 1) {\r\ngpio_set_value(moxart_rtc->gpio_sclk, 0);\r\ngpio_set_value(moxart_rtc->gpio_data, ((data & 1) == 1));\r\nudelay(GPIO_RTC_DELAY_TIME);\r\ngpio_set_value(moxart_rtc->gpio_sclk, 1);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\n}\r\n}\r\nstatic u8 moxart_rtc_read_byte(struct device *dev)\r\n{\r\nstruct moxart_rtc *moxart_rtc = dev_get_drvdata(dev);\r\nint i;\r\nu8 data = 0;\r\nfor (i = 0; i < 8; i++) {\r\ngpio_set_value(moxart_rtc->gpio_sclk, 0);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\ngpio_set_value(moxart_rtc->gpio_sclk, 1);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\nif (gpio_get_value(moxart_rtc->gpio_data))\r\ndata |= (1 << i);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\n}\r\nreturn data;\r\n}\r\nstatic u8 moxart_rtc_read_register(struct device *dev, u8 cmd)\r\n{\r\nstruct moxart_rtc *moxart_rtc = dev_get_drvdata(dev);\r\nu8 data;\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\ngpio_direction_output(moxart_rtc->gpio_data, 0);\r\ngpio_set_value(moxart_rtc->gpio_reset, 1);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\nmoxart_rtc_write_byte(dev, cmd);\r\ngpio_direction_input(moxart_rtc->gpio_data);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\ndata = moxart_rtc_read_byte(dev);\r\ngpio_set_value(moxart_rtc->gpio_sclk, 0);\r\ngpio_set_value(moxart_rtc->gpio_reset, 0);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\nlocal_irq_restore(flags);\r\nreturn data;\r\n}\r\nstatic void moxart_rtc_write_register(struct device *dev, u8 cmd, u8 data)\r\n{\r\nstruct moxart_rtc *moxart_rtc = dev_get_drvdata(dev);\r\nunsigned long flags;\r\nlocal_irq_save(flags);\r\ngpio_direction_output(moxart_rtc->gpio_data, 0);\r\ngpio_set_value(moxart_rtc->gpio_reset, 1);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\nmoxart_rtc_write_byte(dev, cmd);\r\nmoxart_rtc_write_byte(dev, data);\r\ngpio_set_value(moxart_rtc->gpio_sclk, 0);\r\ngpio_set_value(moxart_rtc->gpio_reset, 0);\r\nudelay(GPIO_RTC_DELAY_TIME);\r\nlocal_irq_restore(flags);\r\n}\r\nstatic int moxart_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct moxart_rtc *moxart_rtc = dev_get_drvdata(dev);\r\nspin_lock_irq(&moxart_rtc->rtc_lock);\r\nmoxart_rtc_write_register(dev, GPIO_RTC_PROTECT_W, 0);\r\nmoxart_rtc_write_register(dev, GPIO_RTC_YEAR_W,\r\n(((tm->tm_year - 100) / 10) << 4) |\r\n((tm->tm_year - 100) % 10));\r\nmoxart_rtc_write_register(dev, GPIO_RTC_MONTH_W,\r\n(((tm->tm_mon + 1) / 10) << 4) |\r\n((tm->tm_mon + 1) % 10));\r\nmoxart_rtc_write_register(dev, GPIO_RTC_DATE_W,\r\n((tm->tm_mday / 10) << 4) |\r\n(tm->tm_mday % 10));\r\nmoxart_rtc_write_register(dev, GPIO_RTC_HOURS_W,\r\n((tm->tm_hour / 10) << 4) |\r\n(tm->tm_hour % 10));\r\nmoxart_rtc_write_register(dev, GPIO_RTC_MINUTES_W,\r\n((tm->tm_min / 10) << 4) |\r\n(tm->tm_min % 10));\r\nmoxart_rtc_write_register(dev, GPIO_RTC_SECONDS_W,\r\n((tm->tm_sec / 10) << 4) |\r\n(tm->tm_sec % 10));\r\nmoxart_rtc_write_register(dev, GPIO_RTC_PROTECT_W, 0x80);\r\nspin_unlock_irq(&moxart_rtc->rtc_lock);\r\ndev_dbg(dev, "%s: success tm_year=%d tm_mon=%d\n"\r\n"tm_mday=%d tm_hour=%d tm_min=%d tm_sec=%d\n",\r\n__func__, tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int moxart_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct moxart_rtc *moxart_rtc = dev_get_drvdata(dev);\r\nunsigned char v;\r\nspin_lock_irq(&moxart_rtc->rtc_lock);\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_SECONDS_R);\r\ntm->tm_sec = (((v & 0x70) >> 4) * 10) + (v & 0x0F);\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_MINUTES_R);\r\ntm->tm_min = (((v & 0x70) >> 4) * 10) + (v & 0x0F);\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_HOURS_R);\r\nif (v & 0x80) {\r\ntm->tm_hour = (((v & 0x10) >> 4) * 10) + (v & 0x0F);\r\nif (v & 0x20) {\r\ntm->tm_hour += 12;\r\nif (tm->tm_hour >= 24)\r\ntm->tm_hour = 0;\r\n}\r\n} else {\r\ntm->tm_hour = (((v & 0x30) >> 4) * 10) + (v & 0x0F);\r\n}\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_DATE_R);\r\ntm->tm_mday = (((v & 0x30) >> 4) * 10) + (v & 0x0F);\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_MONTH_R);\r\ntm->tm_mon = (((v & 0x10) >> 4) * 10) + (v & 0x0F);\r\ntm->tm_mon--;\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_YEAR_R);\r\ntm->tm_year = (((v & 0xF0) >> 4) * 10) + (v & 0x0F);\r\ntm->tm_year += 100;\r\nif (tm->tm_year <= 69)\r\ntm->tm_year += 100;\r\nv = moxart_rtc_read_register(dev, GPIO_RTC_DAY_R);\r\ntm->tm_wday = (v & 0x0f) - 1;\r\ntm->tm_yday = day_of_year[tm->tm_mon];\r\ntm->tm_yday += (tm->tm_mday - 1);\r\nif (tm->tm_mon >= 2) {\r\nif (!(tm->tm_year % 4) && (tm->tm_year % 100))\r\ntm->tm_yday++;\r\n}\r\ntm->tm_isdst = 0;\r\nspin_unlock_irq(&moxart_rtc->rtc_lock);\r\nreturn 0;\r\n}\r\nstatic int moxart_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct moxart_rtc *moxart_rtc;\r\nint ret = 0;\r\nmoxart_rtc = devm_kzalloc(&pdev->dev, sizeof(*moxart_rtc), GFP_KERNEL);\r\nif (!moxart_rtc)\r\nreturn -ENOMEM;\r\nmoxart_rtc->gpio_data = of_get_named_gpio(pdev->dev.of_node,\r\n"gpio-rtc-data", 0);\r\nif (!gpio_is_valid(moxart_rtc->gpio_data)) {\r\ndev_err(&pdev->dev, "invalid gpio (data): %d\n",\r\nmoxart_rtc->gpio_data);\r\nreturn moxart_rtc->gpio_data;\r\n}\r\nmoxart_rtc->gpio_sclk = of_get_named_gpio(pdev->dev.of_node,\r\n"gpio-rtc-sclk", 0);\r\nif (!gpio_is_valid(moxart_rtc->gpio_sclk)) {\r\ndev_err(&pdev->dev, "invalid gpio (sclk): %d\n",\r\nmoxart_rtc->gpio_sclk);\r\nreturn moxart_rtc->gpio_sclk;\r\n}\r\nmoxart_rtc->gpio_reset = of_get_named_gpio(pdev->dev.of_node,\r\n"gpio-rtc-reset", 0);\r\nif (!gpio_is_valid(moxart_rtc->gpio_reset)) {\r\ndev_err(&pdev->dev, "invalid gpio (reset): %d\n",\r\nmoxart_rtc->gpio_reset);\r\nreturn moxart_rtc->gpio_reset;\r\n}\r\nspin_lock_init(&moxart_rtc->rtc_lock);\r\nplatform_set_drvdata(pdev, moxart_rtc);\r\nret = devm_gpio_request(&pdev->dev, moxart_rtc->gpio_data, "rtc_data");\r\nif (ret) {\r\ndev_err(&pdev->dev, "can't get rtc_data gpio\n");\r\nreturn ret;\r\n}\r\nret = devm_gpio_request_one(&pdev->dev, moxart_rtc->gpio_sclk,\r\nGPIOF_DIR_OUT, "rtc_sclk");\r\nif (ret) {\r\ndev_err(&pdev->dev, "can't get rtc_sclk gpio\n");\r\nreturn ret;\r\n}\r\nret = devm_gpio_request_one(&pdev->dev, moxart_rtc->gpio_reset,\r\nGPIOF_DIR_OUT, "rtc_reset");\r\nif (ret) {\r\ndev_err(&pdev->dev, "can't get rtc_reset gpio\n");\r\nreturn ret;\r\n}\r\nmoxart_rtc->rtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&moxart_rtc_ops,\r\nTHIS_MODULE);\r\nif (IS_ERR(moxart_rtc->rtc)) {\r\ndev_err(&pdev->dev, "devm_rtc_device_register failed\n");\r\nreturn PTR_ERR(moxart_rtc->rtc);\r\n}\r\nreturn 0;\r\n}

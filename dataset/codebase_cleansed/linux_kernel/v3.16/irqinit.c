int vector_used_by_percpu_irq(unsigned int vector)\r\n{\r\nint cpu;\r\nfor_each_online_cpu(cpu) {\r\nif (per_cpu(vector_irq, cpu)[vector] > VECTOR_UNDEFINED)\r\nreturn 1;\r\n}\r\nreturn 0;\r\n}\r\nvoid __init init_ISA_irqs(void)\r\n{\r\nstruct irq_chip *chip = legacy_pic->chip;\r\nconst char *name = chip->name;\r\nint i;\r\n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_LOCAL_APIC)\r\ninit_bsp_APIC();\r\n#endif\r\nlegacy_pic->init(0);\r\nfor (i = 0; i < legacy_pic->nr_legacy_irqs; i++)\r\nirq_set_chip_and_handler_name(i, chip, handle_level_irq, name);\r\n}\r\nvoid __init init_IRQ(void)\r\n{\r\nint i;\r\nx86_add_irq_domains();\r\nfor (i = 0; i < legacy_pic->nr_legacy_irqs; i++)\r\nper_cpu(vector_irq, 0)[IRQ0_VECTOR + i] = i;\r\nx86_init.irqs.intr_init();\r\n}\r\nvoid setup_vector_irq(int cpu)\r\n{\r\n#ifndef CONFIG_X86_IO_APIC\r\nint irq;\r\nfor (irq = 0; irq < legacy_pic->nr_legacy_irqs; irq++)\r\nper_cpu(vector_irq, cpu)[IRQ0_VECTOR + irq] = irq;\r\n#endif\r\n__setup_vector_irq(cpu);\r\n}\r\nstatic void __init smp_intr_init(void)\r\n{\r\n#ifdef CONFIG_SMP\r\n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_LOCAL_APIC)\r\nalloc_intr_gate(RESCHEDULE_VECTOR, reschedule_interrupt);\r\nalloc_intr_gate(CALL_FUNCTION_VECTOR, call_function_interrupt);\r\nalloc_intr_gate(CALL_FUNCTION_SINGLE_VECTOR,\r\ncall_function_single_interrupt);\r\nset_intr_gate(IRQ_MOVE_CLEANUP_VECTOR, irq_move_cleanup_interrupt);\r\nset_bit(IRQ_MOVE_CLEANUP_VECTOR, used_vectors);\r\nalloc_intr_gate(REBOOT_VECTOR, reboot_interrupt);\r\n#endif\r\n#endif\r\n}\r\nstatic void __init apic_intr_init(void)\r\n{\r\nsmp_intr_init();\r\n#ifdef CONFIG_X86_THERMAL_VECTOR\r\nalloc_intr_gate(THERMAL_APIC_VECTOR, thermal_interrupt);\r\n#endif\r\n#ifdef CONFIG_X86_MCE_THRESHOLD\r\nalloc_intr_gate(THRESHOLD_APIC_VECTOR, threshold_interrupt);\r\n#endif\r\n#if defined(CONFIG_X86_64) || defined(CONFIG_X86_LOCAL_APIC)\r\nalloc_intr_gate(LOCAL_TIMER_VECTOR, apic_timer_interrupt);\r\nalloc_intr_gate(X86_PLATFORM_IPI_VECTOR, x86_platform_ipi);\r\n#ifdef CONFIG_HAVE_KVM\r\nalloc_intr_gate(POSTED_INTR_VECTOR, kvm_posted_intr_ipi);\r\n#endif\r\nalloc_intr_gate(SPURIOUS_APIC_VECTOR, spurious_interrupt);\r\nalloc_intr_gate(ERROR_APIC_VECTOR, error_interrupt);\r\n# ifdef CONFIG_IRQ_WORK\r\nalloc_intr_gate(IRQ_WORK_VECTOR, irq_work_interrupt);\r\n# endif\r\n#endif\r\n}\r\nvoid __init native_init_IRQ(void)\r\n{\r\nint i;\r\nx86_init.irqs.pre_vector_init();\r\napic_intr_init();\r\ni = FIRST_EXTERNAL_VECTOR;\r\nfor_each_clear_bit_from(i, used_vectors, NR_VECTORS) {\r\nset_intr_gate(i, interrupt[i - FIRST_EXTERNAL_VECTOR]);\r\n}\r\nif (!acpi_ioapic && !of_ioapic)\r\nsetup_irq(2, &irq2);\r\n#ifdef CONFIG_X86_32\r\nirq_ctx_init(smp_processor_id());\r\n#endif\r\n}

int picolcd_raw_cir(struct picolcd_data *data,\r\nstruct hid_report *report, u8 *raw_data, int size)\r\n{\r\nunsigned long flags;\r\nint i, w, sz;\r\nDEFINE_IR_RAW_EVENT(rawir);\r\nspin_lock_irqsave(&data->lock, flags);\r\nif (!data->rc_dev || (data->status & PICOLCD_CIR_SHUN)) {\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nreturn 1;\r\n}\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nsz = size > 0 ? min((int)raw_data[0], size-1) : 0;\r\nfor (i = 0; i+1 < sz; i += 2) {\r\ninit_ir_raw_event(&rawir);\r\nw = (raw_data[i] << 8) | (raw_data[i+1]);\r\nrawir.pulse = !!(w & 0x8000);\r\nrawir.duration = US_TO_NS(rawir.pulse ? (65536 - w) : w);\r\nif (i == 0 && rawir.duration > 15000000)\r\nrawir.duration -= 15000000;\r\nir_raw_event_store(data->rc_dev, &rawir);\r\n}\r\nir_raw_event_handle(data->rc_dev);\r\nreturn 1;\r\n}\r\nstatic int picolcd_cir_open(struct rc_dev *dev)\r\n{\r\nstruct picolcd_data *data = dev->priv;\r\nunsigned long flags;\r\nspin_lock_irqsave(&data->lock, flags);\r\ndata->status &= ~PICOLCD_CIR_SHUN;\r\nspin_unlock_irqrestore(&data->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void picolcd_cir_close(struct rc_dev *dev)\r\n{\r\nstruct picolcd_data *data = dev->priv;\r\nunsigned long flags;\r\nspin_lock_irqsave(&data->lock, flags);\r\ndata->status |= PICOLCD_CIR_SHUN;\r\nspin_unlock_irqrestore(&data->lock, flags);\r\n}\r\nint picolcd_init_cir(struct picolcd_data *data, struct hid_report *report)\r\n{\r\nstruct rc_dev *rdev;\r\nint ret = 0;\r\nrdev = rc_allocate_device();\r\nif (!rdev)\r\nreturn -ENOMEM;\r\nrdev->priv = data;\r\nrdev->driver_type = RC_DRIVER_IR_RAW;\r\nrc_set_allowed_protocols(rdev, RC_BIT_ALL);\r\nrdev->open = picolcd_cir_open;\r\nrdev->close = picolcd_cir_close;\r\nrdev->input_name = data->hdev->name;\r\nrdev->input_phys = data->hdev->phys;\r\nrdev->input_id.bustype = data->hdev->bus;\r\nrdev->input_id.vendor = data->hdev->vendor;\r\nrdev->input_id.product = data->hdev->product;\r\nrdev->input_id.version = data->hdev->version;\r\nrdev->dev.parent = &data->hdev->dev;\r\nrdev->driver_name = PICOLCD_NAME;\r\nrdev->map_name = RC_MAP_RC6_MCE;\r\nrdev->timeout = MS_TO_NS(100);\r\nrdev->rx_resolution = US_TO_NS(1);\r\nret = rc_register_device(rdev);\r\nif (ret)\r\ngoto err;\r\ndata->rc_dev = rdev;\r\nreturn 0;\r\nerr:\r\nrc_free_device(rdev);\r\nreturn ret;\r\n}\r\nvoid picolcd_exit_cir(struct picolcd_data *data)\r\n{\r\nstruct rc_dev *rdev = data->rc_dev;\r\ndata->rc_dev = NULL;\r\nif (rdev)\r\nrc_unregister_device(rdev);\r\n}

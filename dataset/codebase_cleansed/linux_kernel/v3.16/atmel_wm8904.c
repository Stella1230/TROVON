static int atmel_asoc_wm8904_hw_params(struct snd_pcm_substream *substream,\r\nstruct snd_pcm_hw_params *params)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = substream->private_data;\r\nstruct snd_soc_dai *codec_dai = rtd->codec_dai;\r\nint ret;\r\nret = snd_soc_dai_set_pll(codec_dai, WM8904_FLL_MCLK, WM8904_FLL_MCLK,\r\n32768, params_rate(params) * 256);\r\nif (ret < 0) {\r\npr_err("%s - failed to set wm8904 codec PLL.", __func__);\r\nreturn ret;\r\n}\r\nret = snd_soc_dai_set_sysclk(codec_dai, WM8904_CLK_FLL,\r\n0, SND_SOC_CLOCK_IN);\r\nif (ret < 0) {\r\npr_err("%s -failed to set wm8904 SYSCLK\n", __func__);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int atmel_set_bias_level(struct snd_soc_card *card,\r\nstruct snd_soc_dapm_context *dapm,\r\nenum snd_soc_bias_level level)\r\n{\r\nif (dapm->bias_level == SND_SOC_BIAS_STANDBY) {\r\nswitch (level) {\r\ncase SND_SOC_BIAS_PREPARE:\r\nclk_prepare_enable(mclk);\r\nbreak;\r\ncase SND_SOC_BIAS_OFF:\r\nclk_disable_unprepare(mclk);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int atmel_asoc_wm8904_dt_init(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct device_node *codec_np, *cpu_np;\r\nstruct snd_soc_card *card = &atmel_asoc_wm8904_card;\r\nstruct snd_soc_dai_link *dailink = &atmel_asoc_wm8904_dailink;\r\nint ret;\r\nif (!np) {\r\ndev_err(&pdev->dev, "only device tree supported\n");\r\nreturn -EINVAL;\r\n}\r\nret = snd_soc_of_parse_card_name(card, "atmel,model");\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to parse card name\n");\r\nreturn ret;\r\n}\r\nret = snd_soc_of_parse_audio_routing(card, "atmel,audio-routing");\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to parse audio routing\n");\r\nreturn ret;\r\n}\r\ncpu_np = of_parse_phandle(np, "atmel,ssc-controller", 0);\r\nif (!cpu_np) {\r\ndev_err(&pdev->dev, "failed to get dai and pcm info\n");\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\ndailink->cpu_of_node = cpu_np;\r\ndailink->platform_of_node = cpu_np;\r\nof_node_put(cpu_np);\r\ncodec_np = of_parse_phandle(np, "atmel,audio-codec", 0);\r\nif (!codec_np) {\r\ndev_err(&pdev->dev, "failed to get codec info\n");\r\nret = -EINVAL;\r\nreturn ret;\r\n}\r\ndailink->codec_of_node = codec_np;\r\nof_node_put(codec_np);\r\nreturn 0;\r\n}\r\nstatic int atmel_asoc_wm8904_probe(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = &atmel_asoc_wm8904_card;\r\nstruct snd_soc_dai_link *dailink = &atmel_asoc_wm8904_dailink;\r\nstruct clk *clk_src;\r\nint id, ret;\r\ncard->dev = &pdev->dev;\r\nret = atmel_asoc_wm8904_dt_init(pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to init dt info\n");\r\nreturn ret;\r\n}\r\nid = of_alias_get_id((struct device_node *)dailink->cpu_of_node, "ssc");\r\nret = atmel_ssc_set_audio(id);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "failed to set SSC %d for audio\n", id);\r\nreturn ret;\r\n}\r\nmclk = clk_get(NULL, "pck0");\r\nif (IS_ERR(mclk)) {\r\ndev_err(&pdev->dev, "failed to get pck0\n");\r\nret = PTR_ERR(mclk);\r\ngoto err_set_audio;\r\n}\r\nclk_src = clk_get(NULL, "clk32k");\r\nif (IS_ERR(clk_src)) {\r\ndev_err(&pdev->dev, "failed to get clk32k\n");\r\nret = PTR_ERR(clk_src);\r\ngoto err_set_audio;\r\n}\r\nret = clk_set_parent(mclk, clk_src);\r\nclk_put(clk_src);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "failed to set MCLK parent\n");\r\ngoto err_set_audio;\r\n}\r\ndev_info(&pdev->dev, "setting pck0 to %dHz\n", MCLK_RATE);\r\nclk_set_rate(mclk, MCLK_RATE);\r\nret = snd_soc_register_card(card);\r\nif (ret) {\r\ndev_err(&pdev->dev, "snd_soc_register_card failed\n");\r\ngoto err_set_audio;\r\n}\r\nreturn 0;\r\nerr_set_audio:\r\natmel_ssc_put_audio(id);\r\nreturn ret;\r\n}\r\nstatic int atmel_asoc_wm8904_remove(struct platform_device *pdev)\r\n{\r\nstruct snd_soc_card *card = platform_get_drvdata(pdev);\r\nstruct snd_soc_dai_link *dailink = &atmel_asoc_wm8904_dailink;\r\nint id;\r\nid = of_alias_get_id((struct device_node *)dailink->cpu_of_node, "ssc");\r\nsnd_soc_unregister_card(card);\r\natmel_ssc_put_audio(id);\r\nreturn 0;\r\n}

static int stv6110x_read_reg(struct stv6110x_state *stv6110x, u8 reg, u8 *data)\r\n{\r\nint ret;\r\nconst struct stv6110x_config *config = stv6110x->config;\r\nu8 b0[] = { reg };\r\nu8 b1[] = { 0 };\r\nstruct i2c_msg msg[] = {\r\n{ .addr = config->addr, .flags = 0, .buf = b0, .len = 1 },\r\n{ .addr = config->addr, .flags = I2C_M_RD, .buf = b1, .len = 1 }\r\n};\r\nret = i2c_transfer(stv6110x->i2c, msg, 2);\r\nif (ret != 2) {\r\ndprintk(FE_ERROR, 1, "I/O Error");\r\nreturn -EREMOTEIO;\r\n}\r\n*data = b1[0];\r\nreturn 0;\r\n}\r\nstatic int stv6110x_write_regs(struct stv6110x_state *stv6110x, int start, u8 data[], int len)\r\n{\r\nint ret;\r\nconst struct stv6110x_config *config = stv6110x->config;\r\nu8 buf[MAX_XFER_SIZE];\r\nstruct i2c_msg msg = {\r\n.addr = config->addr,\r\n.flags = 0,\r\n.buf = buf,\r\n.len = len + 1\r\n};\r\nif (1 + len > sizeof(buf)) {\r\nprintk(KERN_WARNING\r\n"%s: i2c wr: len=%d is too big!\n",\r\nKBUILD_MODNAME, len);\r\nreturn -EINVAL;\r\n}\r\nif (start + len > 8)\r\nreturn -EINVAL;\r\nbuf[0] = start;\r\nmemcpy(&buf[1], data, len);\r\nret = i2c_transfer(stv6110x->i2c, &msg, 1);\r\nif (ret != 1) {\r\ndprintk(FE_ERROR, 1, "I/O Error");\r\nreturn -EREMOTEIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv6110x_write_reg(struct stv6110x_state *stv6110x, u8 reg, u8 data)\r\n{\r\nreturn stv6110x_write_regs(stv6110x, reg, &data, 1);\r\n}\r\nstatic int stv6110x_init(struct dvb_frontend *fe)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nint ret;\r\nret = stv6110x_write_regs(stv6110x, 0, stv6110x->regs,\r\nARRAY_SIZE(stv6110x->regs));\r\nif (ret < 0) {\r\ndprintk(FE_ERROR, 1, "Initialization failed");\r\nreturn -1;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv6110x_set_frequency(struct dvb_frontend *fe, u32 frequency)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nu32 rDiv, divider;\r\ns32 pVal, pCalc, rDivOpt = 0, pCalcOpt = 1000;\r\nu8 i;\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_K, (REFCLOCK_MHz - 16));\r\nif (frequency <= 1023000) {\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_DIV4SEL, 1);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_PRESC32_ON, 0);\r\npVal = 40;\r\n} else if (frequency <= 1300000) {\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_DIV4SEL, 1);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_PRESC32_ON, 1);\r\npVal = 40;\r\n} else if (frequency <= 2046000) {\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_DIV4SEL, 0);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_PRESC32_ON, 0);\r\npVal = 20;\r\n} else {\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_DIV4SEL, 0);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_PRESC32_ON, 1);\r\npVal = 20;\r\n}\r\nfor (rDiv = 0; rDiv <= 3; rDiv++) {\r\npCalc = (REFCLOCK_kHz / 100) / R_DIV(rDiv);\r\nif ((abs((s32)(pCalc - pVal))) < (abs((s32)(pCalcOpt - pVal))))\r\nrDivOpt = rDiv;\r\npCalcOpt = (REFCLOCK_kHz / 100) / R_DIV(rDivOpt);\r\n}\r\ndivider = (frequency * R_DIV(rDivOpt) * pVal) / REFCLOCK_kHz;\r\ndivider = (divider + 5) / 10;\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_R_DIV, rDivOpt);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG1], TNG1_N_DIV_11_8, MSB(divider));\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_TNG0], TNG0_N_DIV_7_0, LSB(divider));\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_STAT1], STAT1_CALVCO_STRT, 1);\r\nstv6110x_write_reg(stv6110x, STV6110x_CTRL1, stv6110x->regs[STV6110x_CTRL1]);\r\nstv6110x_write_reg(stv6110x, STV6110x_TNG1, stv6110x->regs[STV6110x_TNG1]);\r\nstv6110x_write_reg(stv6110x, STV6110x_TNG0, stv6110x->regs[STV6110x_TNG0]);\r\nstv6110x_write_reg(stv6110x, STV6110x_STAT1, stv6110x->regs[STV6110x_STAT1]);\r\nfor (i = 0; i < TRIALS; i++) {\r\nstv6110x_read_reg(stv6110x, STV6110x_STAT1, &stv6110x->regs[STV6110x_STAT1]);\r\nif (!STV6110x_GETFIELD(STAT1_CALVCO_STRT, stv6110x->regs[STV6110x_STAT1]))\r\nbreak;\r\nmsleep(1);\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv6110x_get_frequency(struct dvb_frontend *fe, u32 *frequency)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nstv6110x_read_reg(stv6110x, STV6110x_TNG1, &stv6110x->regs[STV6110x_TNG1]);\r\nstv6110x_read_reg(stv6110x, STV6110x_TNG0, &stv6110x->regs[STV6110x_TNG0]);\r\n*frequency = (MAKEWORD16(STV6110x_GETFIELD(TNG1_N_DIV_11_8, stv6110x->regs[STV6110x_TNG1]),\r\nSTV6110x_GETFIELD(TNG0_N_DIV_7_0, stv6110x->regs[STV6110x_TNG0]))) * REFCLOCK_kHz;\r\n*frequency /= (1 << (STV6110x_GETFIELD(TNG1_R_DIV, stv6110x->regs[STV6110x_TNG1]) +\r\nSTV6110x_GETFIELD(TNG1_DIV4SEL, stv6110x->regs[STV6110x_TNG1])));\r\n*frequency >>= 2;\r\nreturn 0;\r\n}\r\nstatic int stv6110x_set_bandwidth(struct dvb_frontend *fe, u32 bandwidth)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nu32 halfbw;\r\nu8 i;\r\nhalfbw = bandwidth >> 1;\r\nif (halfbw > 36000000)\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL3], CTRL3_CF, 31);\r\nelse if (halfbw < 5000000)\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL3], CTRL3_CF, 0);\r\nelse\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL3], CTRL3_CF, ((halfbw / 1000000) - 5));\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL3], CTRL3_RCCLK_OFF, 0x0);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_STAT1], STAT1_CALRC_STRT, 0x1);\r\nstv6110x_write_reg(stv6110x, STV6110x_CTRL3, stv6110x->regs[STV6110x_CTRL3]);\r\nstv6110x_write_reg(stv6110x, STV6110x_STAT1, stv6110x->regs[STV6110x_STAT1]);\r\nfor (i = 0; i < TRIALS; i++) {\r\nstv6110x_read_reg(stv6110x, STV6110x_STAT1, &stv6110x->regs[STV6110x_STAT1]);\r\nif (!STV6110x_GETFIELD(STAT1_CALRC_STRT, stv6110x->regs[STV6110x_STAT1]))\r\nbreak;\r\nmsleep(1);\r\n}\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL3], CTRL3_RCCLK_OFF, 0x1);\r\nstv6110x_write_reg(stv6110x, STV6110x_CTRL3, stv6110x->regs[STV6110x_CTRL3]);\r\nreturn 0;\r\n}\r\nstatic int stv6110x_get_bandwidth(struct dvb_frontend *fe, u32 *bandwidth)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nstv6110x_read_reg(stv6110x, STV6110x_CTRL3, &stv6110x->regs[STV6110x_CTRL3]);\r\n*bandwidth = (STV6110x_GETFIELD(CTRL3_CF, stv6110x->regs[STV6110x_CTRL3]) + 5) * 2000000;\r\nreturn 0;\r\n}\r\nstatic int stv6110x_set_refclock(struct dvb_frontend *fe, u32 refclock)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nswitch (refclock) {\r\ndefault:\r\ncase 1:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 0);\r\nbreak;\r\ncase 2:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 1);\r\nbreak;\r\ncase 4:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 2);\r\nbreak;\r\ncase 8:\r\ncase 0:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 3);\r\nbreak;\r\n}\r\nstv6110x_write_reg(stv6110x, STV6110x_CTRL2, stv6110x->regs[STV6110x_CTRL2]);\r\nreturn 0;\r\n}\r\nstatic int stv6110x_get_bbgain(struct dvb_frontend *fe, u32 *gain)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nstv6110x_read_reg(stv6110x, STV6110x_CTRL2, &stv6110x->regs[STV6110x_CTRL2]);\r\n*gain = 2 * STV6110x_GETFIELD(CTRL2_BBGAIN, stv6110x->regs[STV6110x_CTRL2]);\r\nreturn 0;\r\n}\r\nstatic int stv6110x_set_bbgain(struct dvb_frontend *fe, u32 gain)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_BBGAIN, gain / 2);\r\nstv6110x_write_reg(stv6110x, STV6110x_CTRL2, stv6110x->regs[STV6110x_CTRL2]);\r\nreturn 0;\r\n}\r\nstatic int stv6110x_set_mode(struct dvb_frontend *fe, enum tuner_mode mode)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nint ret;\r\nswitch (mode) {\r\ncase TUNER_SLEEP:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_SYN, 0);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_RX, 0);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_LPT, 0);\r\nbreak;\r\ncase TUNER_WAKE:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_SYN, 1);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_RX, 1);\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL1], CTRL1_LPT, 1);\r\nbreak;\r\n}\r\nret = stv6110x_write_reg(stv6110x, STV6110x_CTRL1, stv6110x->regs[STV6110x_CTRL1]);\r\nif (ret < 0) {\r\ndprintk(FE_ERROR, 1, "I/O Error");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int stv6110x_sleep(struct dvb_frontend *fe)\r\n{\r\nif (fe->tuner_priv)\r\nreturn stv6110x_set_mode(fe, TUNER_SLEEP);\r\nreturn 0;\r\n}\r\nstatic int stv6110x_get_status(struct dvb_frontend *fe, u32 *status)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nstv6110x_read_reg(stv6110x, STV6110x_STAT1, &stv6110x->regs[STV6110x_STAT1]);\r\nif (STV6110x_GETFIELD(STAT1_LOCK, stv6110x->regs[STV6110x_STAT1]))\r\n*status = TUNER_PHASELOCKED;\r\nelse\r\n*status = 0;\r\nreturn 0;\r\n}\r\nstatic int stv6110x_release(struct dvb_frontend *fe)\r\n{\r\nstruct stv6110x_state *stv6110x = fe->tuner_priv;\r\nfe->tuner_priv = NULL;\r\nkfree(stv6110x);\r\nreturn 0;\r\n}\r\nstruct stv6110x_devctl *stv6110x_attach(struct dvb_frontend *fe,\r\nconst struct stv6110x_config *config,\r\nstruct i2c_adapter *i2c)\r\n{\r\nstruct stv6110x_state *stv6110x;\r\nu8 default_regs[] = {0x07, 0x11, 0xdc, 0x85, 0x17, 0x01, 0xe6, 0x1e};\r\nstv6110x = kzalloc(sizeof (struct stv6110x_state), GFP_KERNEL);\r\nif (!stv6110x)\r\nreturn NULL;\r\nstv6110x->i2c = i2c;\r\nstv6110x->config = config;\r\nstv6110x->devctl = &stv6110x_ctl;\r\nmemcpy(stv6110x->regs, default_regs, 8);\r\nswitch (stv6110x->config->clk_div) {\r\ndefault:\r\ncase 1:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 0);\r\nbreak;\r\ncase 2:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 1);\r\nbreak;\r\ncase 4:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 2);\r\nbreak;\r\ncase 8:\r\ncase 0:\r\nSTV6110x_SETFIELD(stv6110x->regs[STV6110x_CTRL2], CTRL2_CO_DIV, 3);\r\nbreak;\r\n}\r\nfe->tuner_priv = stv6110x;\r\nfe->ops.tuner_ops = stv6110x_ops;\r\nprintk(KERN_INFO "%s: Attaching STV6110x\n", __func__);\r\nreturn stv6110x->devctl;\r\n}

static void *cache_first_page(struct squashfs_page_actor *actor)\r\n{\r\nactor->next_page = 1;\r\nreturn actor->buffer[0];\r\n}\r\nstatic void *cache_next_page(struct squashfs_page_actor *actor)\r\n{\r\nif (actor->next_page == actor->pages)\r\nreturn NULL;\r\nreturn actor->buffer[actor->next_page++];\r\n}\r\nstatic void cache_finish_page(struct squashfs_page_actor *actor)\r\n{\r\n}\r\nstruct squashfs_page_actor *squashfs_page_actor_init(void **buffer,\r\nint pages, int length)\r\n{\r\nstruct squashfs_page_actor *actor = kmalloc(sizeof(*actor), GFP_KERNEL);\r\nif (actor == NULL)\r\nreturn NULL;\r\nactor->length = length ? : pages * PAGE_CACHE_SIZE;\r\nactor->buffer = buffer;\r\nactor->pages = pages;\r\nactor->next_page = 0;\r\nactor->squashfs_first_page = cache_first_page;\r\nactor->squashfs_next_page = cache_next_page;\r\nactor->squashfs_finish_page = cache_finish_page;\r\nreturn actor;\r\n}\r\nstatic void *direct_first_page(struct squashfs_page_actor *actor)\r\n{\r\nactor->next_page = 1;\r\nreturn actor->pageaddr = kmap_atomic(actor->page[0]);\r\n}\r\nstatic void *direct_next_page(struct squashfs_page_actor *actor)\r\n{\r\nif (actor->pageaddr)\r\nkunmap_atomic(actor->pageaddr);\r\nreturn actor->pageaddr = actor->next_page == actor->pages ? NULL :\r\nkmap_atomic(actor->page[actor->next_page++]);\r\n}\r\nstatic void direct_finish_page(struct squashfs_page_actor *actor)\r\n{\r\nif (actor->pageaddr)\r\nkunmap_atomic(actor->pageaddr);\r\n}\r\nstruct squashfs_page_actor *squashfs_page_actor_init_special(struct page **page,\r\nint pages, int length)\r\n{\r\nstruct squashfs_page_actor *actor = kmalloc(sizeof(*actor), GFP_KERNEL);\r\nif (actor == NULL)\r\nreturn NULL;\r\nactor->length = length ? : pages * PAGE_CACHE_SIZE;\r\nactor->page = page;\r\nactor->pages = pages;\r\nactor->next_page = 0;\r\nactor->pageaddr = NULL;\r\nactor->squashfs_first_page = direct_first_page;\r\nactor->squashfs_next_page = direct_next_page;\r\nactor->squashfs_finish_page = direct_finish_page;\r\nreturn actor;\r\n}

static int zd1211b_al2230_finalize_rf(struct zd_chip *chip)\r\n{\r\nint r;\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR80, 0x30 }, { ZD_CR81, 0x30 }, { ZD_CR79, 0x58 },\r\n{ ZD_CR12, 0xf0 }, { ZD_CR77, 0x1b }, { ZD_CR78, 0x58 },\r\n{ ZD_CR203, 0x06 },\r\n{ },\r\n{ ZD_CR240, 0x80 },\r\n};\r\nr = zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\nif (r)\r\nreturn r;\r\nif (chip->new_phy_layout) {\r\nr = zd_iowrite16_locked(chip, 0xe1, ZD_CR9);\r\nif (r)\r\nreturn r;\r\n}\r\nreturn zd_iowrite16_locked(chip, 0x06, ZD_CR203);\r\n}\r\nstatic int zd1211_al2230_init_hw(struct zd_rf *rf)\r\n{\r\nint r;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs_init[] = {\r\n{ ZD_CR15, 0x20 }, { ZD_CR23, 0x40 }, { ZD_CR24, 0x20 },\r\n{ ZD_CR26, 0x11 }, { ZD_CR28, 0x3e }, { ZD_CR29, 0x00 },\r\n{ ZD_CR44, 0x33 }, { ZD_CR106, 0x2a }, { ZD_CR107, 0x1a },\r\n{ ZD_CR109, 0x09 }, { ZD_CR110, 0x27 }, { ZD_CR111, 0x2b },\r\n{ ZD_CR112, 0x2b }, { ZD_CR119, 0x0a }, { ZD_CR10, 0x89 },\r\n{ ZD_CR17, 0x28 },\r\n{ ZD_CR26, 0x93 }, { ZD_CR34, 0x30 },\r\n{ ZD_CR35, 0x3e },\r\n{ ZD_CR41, 0x24 }, { ZD_CR44, 0x32 },\r\n{ ZD_CR46, 0x96 },\r\n{ ZD_CR47, 0x1e }, { ZD_CR79, 0x58 }, { ZD_CR80, 0x30 },\r\n{ ZD_CR81, 0x30 }, { ZD_CR87, 0x0a }, { ZD_CR89, 0x04 },\r\n{ ZD_CR92, 0x0a }, { ZD_CR99, 0x28 }, { ZD_CR100, 0x00 },\r\n{ ZD_CR101, 0x13 }, { ZD_CR102, 0x27 }, { ZD_CR106, 0x24 },\r\n{ ZD_CR107, 0x2a }, { ZD_CR109, 0x09 }, { ZD_CR110, 0x13 },\r\n{ ZD_CR111, 0x1f }, { ZD_CR112, 0x1f }, { ZD_CR113, 0x27 },\r\n{ ZD_CR114, 0x27 },\r\n{ ZD_CR115, 0x24 },\r\n{ ZD_CR116, 0x24 }, { ZD_CR117, 0xf4 }, { ZD_CR118, 0xfc },\r\n{ ZD_CR119, 0x10 }, { ZD_CR120, 0x4f }, { ZD_CR121, 0x77 },\r\n{ ZD_CR122, 0xe0 }, { ZD_CR137, 0x88 }, { ZD_CR252, 0xff },\r\n{ ZD_CR253, 0xff },\r\n};\r\nstatic const struct zd_ioreq16 ioreqs_pll[] = {\r\n{ ZD_CR251, 0x2f },\r\n{ ZD_CR251, 0x3f },\r\n{ ZD_CR138, 0x28 }, { ZD_CR203, 0x06 },\r\n};\r\nstatic const u32 rv1[] = {\r\n0x03f790,\r\n0x033331,\r\n0x00000d,\r\n0x0b3331,\r\n0x03b812,\r\n0x00fff3,\r\n};\r\nstatic const u32 rv2[] = {\r\n0x000da4,\r\n0x0f4dc5,\r\n0x0805b6,\r\n0x011687,\r\n0x000688,\r\n0x0403b9,\r\n0x00dbba,\r\n0x00099b,\r\n0x0bdffc,\r\n0x00000d,\r\n0x00500f,\r\n};\r\nstatic const u32 rv3[] = {\r\n0x00d00f,\r\n0x004c0f,\r\n0x00540f,\r\n0x00700f,\r\n0x00500f,\r\n};\r\nr = zd_iowrite16a_locked(chip, ioreqs_init, ARRAY_SIZE(ioreqs_init));\r\nif (r)\r\nreturn r;\r\nif (IS_AL2230S(chip)) {\r\nr = zd_iowrite16a_locked(chip, ioreqs_init_al2230s,\r\nARRAY_SIZE(ioreqs_init_al2230s));\r\nif (r)\r\nreturn r;\r\n}\r\nr = zd_rfwritev_locked(chip, rv1, ARRAY_SIZE(rv1), RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nif (IS_AL2230S(chip))\r\nr = zd_rfwrite_locked(chip, 0x000824, RF_RV_BITS);\r\nelse\r\nr = zd_rfwrite_locked(chip, 0x0005a4, RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_locked(chip, rv2, ARRAY_SIZE(rv2), RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs_pll, ARRAY_SIZE(ioreqs_pll));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_locked(chip, rv3, ARRAY_SIZE(rv3), RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nreturn 0;\r\n}\r\nstatic int zd1211b_al2230_init_hw(struct zd_rf *rf)\r\n{\r\nint r;\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs1[] = {\r\n{ ZD_CR10, 0x89 }, { ZD_CR15, 0x20 },\r\n{ ZD_CR17, 0x2B },\r\n{ ZD_CR23, 0x40 }, { ZD_CR24, 0x20 }, { ZD_CR26, 0x93 },\r\n{ ZD_CR28, 0x3e }, { ZD_CR29, 0x00 },\r\n{ ZD_CR33, 0x28 },\r\n{ ZD_CR34, 0x30 },\r\n{ ZD_CR35, 0x3e },\r\n{ ZD_CR41, 0x24 }, { ZD_CR44, 0x32 },\r\n{ ZD_CR46, 0x99 },\r\n{ ZD_CR47, 0x1e },\r\n{ ZD_CR48, 0x06 }, { ZD_CR49, 0xf9 }, { ZD_CR51, 0x01 },\r\n{ ZD_CR52, 0x80 }, { ZD_CR53, 0x7e }, { ZD_CR65, 0x00 },\r\n{ ZD_CR66, 0x00 }, { ZD_CR67, 0x00 }, { ZD_CR68, 0x00 },\r\n{ ZD_CR69, 0x28 },\r\n{ ZD_CR79, 0x58 }, { ZD_CR80, 0x30 }, { ZD_CR81, 0x30 },\r\n{ ZD_CR87, 0x0a }, { ZD_CR89, 0x04 },\r\n{ ZD_CR91, 0x00 },\r\n{ ZD_CR92, 0x0a },\r\n{ ZD_CR98, 0x8d },\r\n{ ZD_CR99, 0x00 },\r\n{ ZD_CR101, 0x13 }, { ZD_CR102, 0x27 },\r\n{ ZD_CR106, 0x24 },\r\n{ ZD_CR107, 0x2a },\r\n{ ZD_CR109, 0x13 },\r\n{ ZD_CR110, 0x1f },\r\n{ ZD_CR111, 0x1f }, { ZD_CR112, 0x1f }, { ZD_CR113, 0x27 },\r\n{ ZD_CR114, 0x27 },\r\n{ ZD_CR115, 0x26 },\r\n{ ZD_CR116, 0x24 },\r\n{ ZD_CR117, 0xfa },\r\n{ ZD_CR118, 0xfa },\r\n{ ZD_CR119, 0x10 },\r\n{ ZD_CR120, 0x4f },\r\n{ ZD_CR121, 0x6c },\r\n{ ZD_CR122, 0xfc },\r\n{ ZD_CR123, 0x57 },\r\n{ ZD_CR125, 0xad },\r\n{ ZD_CR126, 0x6c },\r\n{ ZD_CR127, 0x03 },\r\n{ ZD_CR137, 0x50 },\r\n{ ZD_CR138, 0xa8 },\r\n{ ZD_CR144, 0xac },\r\n{ ZD_CR150, 0x0d }, { ZD_CR252, 0x34 }, { ZD_CR253, 0x34 },\r\n};\r\nstatic const u32 rv1[] = {\r\n0x8cccd0,\r\n0x481dc0,\r\n0xcfff00,\r\n0x25a000,\r\n};\r\nstatic const u32 rv2[] = {\r\n0x25a000,\r\n0xa3b2f0,\r\n0x6da010,\r\n0xe36280,\r\n0x116000,\r\n0x9dc020,\r\n0x5ddb00,\r\n0xd99000,\r\n0x3ffbd0,\r\n0xb00000,\r\n0xf01a00,\r\n};\r\nstatic const struct zd_ioreq16 ioreqs2[] = {\r\n{ ZD_CR251, 0x2f },\r\n{ ZD_CR251, 0x7f },\r\n};\r\nstatic const u32 rv3[] = {\r\n0xf01b00,\r\n0xf01e00,\r\n0xf01a00,\r\n};\r\nstatic const struct zd_ioreq16 ioreqs3[] = {\r\n{ ZD_CR128, 0x14 }, { ZD_CR129, 0x12 }, { ZD_CR130, 0x10 },\r\n};\r\nr = zd_iowrite16a_locked(chip, zd1211b_ioreqs_shared_1,\r\nARRAY_SIZE(zd1211b_ioreqs_shared_1));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs1, ARRAY_SIZE(ioreqs1));\r\nif (r)\r\nreturn r;\r\nif (IS_AL2230S(chip)) {\r\nr = zd_iowrite16a_locked(chip, ioreqs_init_al2230s,\r\nARRAY_SIZE(ioreqs_init_al2230s));\r\nif (r)\r\nreturn r;\r\n}\r\nr = zd_rfwritev_cr_locked(chip, zd1211b_al2230_table[0], 3);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv1, ARRAY_SIZE(rv1));\r\nif (r)\r\nreturn r;\r\nif (IS_AL2230S(chip))\r\nr = zd_rfwrite_locked(chip, 0x241000, RF_RV_BITS);\r\nelse\r\nr = zd_rfwrite_locked(chip, 0x25a000, RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv2, ARRAY_SIZE(rv2));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs2, ARRAY_SIZE(ioreqs2));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv3, ARRAY_SIZE(rv3));\r\nif (r)\r\nreturn r;\r\nr = zd_iowrite16a_locked(chip, ioreqs3, ARRAY_SIZE(ioreqs3));\r\nif (r)\r\nreturn r;\r\nreturn zd1211b_al2230_finalize_rf(chip);\r\n}\r\nstatic int zd1211_al2230_set_channel(struct zd_rf *rf, u8 channel)\r\n{\r\nint r;\r\nconst u32 *rv = zd1211_al2230_table[channel-1];\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR138, 0x28 },\r\n{ ZD_CR203, 0x06 },\r\n};\r\nr = zd_rfwritev_locked(chip, rv, 3, RF_RV_BITS);\r\nif (r)\r\nreturn r;\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int zd1211b_al2230_set_channel(struct zd_rf *rf, u8 channel)\r\n{\r\nint r;\r\nconst u32 *rv = zd1211b_al2230_table[channel-1];\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nr = zd_iowrite16a_locked(chip, zd1211b_ioreqs_shared_1,\r\nARRAY_SIZE(zd1211b_ioreqs_shared_1));\r\nif (r)\r\nreturn r;\r\nr = zd_rfwritev_cr_locked(chip, rv, 3);\r\nif (r)\r\nreturn r;\r\nreturn zd1211b_al2230_finalize_rf(chip);\r\n}\r\nstatic int zd1211_al2230_switch_radio_on(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x00 },\r\n{ ZD_CR251, 0x3f },\r\n};\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int zd1211b_al2230_switch_radio_on(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x00 },\r\n{ ZD_CR251, 0x7f },\r\n};\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nstatic int al2230_switch_radio_off(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nstatic const struct zd_ioreq16 ioreqs[] = {\r\n{ ZD_CR11, 0x04 },\r\n{ ZD_CR251, 0x2f },\r\n};\r\nreturn zd_iowrite16a_locked(chip, ioreqs, ARRAY_SIZE(ioreqs));\r\n}\r\nint zd_rf_init_al2230(struct zd_rf *rf)\r\n{\r\nstruct zd_chip *chip = zd_rf_to_chip(rf);\r\nrf->switch_radio_off = al2230_switch_radio_off;\r\nif (zd_chip_is_zd1211b(chip)) {\r\nrf->init_hw = zd1211b_al2230_init_hw;\r\nrf->set_channel = zd1211b_al2230_set_channel;\r\nrf->switch_radio_on = zd1211b_al2230_switch_radio_on;\r\n} else {\r\nrf->init_hw = zd1211_al2230_init_hw;\r\nrf->set_channel = zd1211_al2230_set_channel;\r\nrf->switch_radio_on = zd1211_al2230_switch_radio_on;\r\n}\r\nrf->patch_6m_band_edge = zd_rf_generic_patch_6m;\r\nrf->patch_cck_gain = 1;\r\nreturn 0;\r\n}

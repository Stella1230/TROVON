klinfo_t *find_component(lboard_t *brd, klinfo_t *kli, unsigned char struct_type)\r\n{\r\nint index, j;\r\nif (kli == (klinfo_t *)NULL) {\r\nindex = 0;\r\n} else {\r\nfor (j = 0; j < KLCF_NUM_COMPS(brd); j++)\r\nif (kli == KLCF_COMP(brd, j))\r\nbreak;\r\nindex = j;\r\nif (index == KLCF_NUM_COMPS(brd)) {\r\nprintk("find_component: Bad pointer: 0x%p\n", kli);\r\nreturn (klinfo_t *)NULL;\r\n}\r\nindex++;\r\n}\r\nfor (; index < KLCF_NUM_COMPS(brd); index++) {\r\nkli = KLCF_COMP(brd, index);\r\nif (KLCF_COMP_TYPE(kli) == struct_type)\r\nreturn kli;\r\n}\r\nreturn (klinfo_t *)NULL;\r\n}\r\nklinfo_t *find_first_component(lboard_t *brd, unsigned char struct_type)\r\n{\r\nreturn find_component(brd, (klinfo_t *)NULL, struct_type);\r\n}\r\nlboard_t *find_lboard(lboard_t *start, unsigned char brd_type)\r\n{\r\nwhile (start) {\r\nif (start->brd_type == brd_type)\r\nreturn start;\r\nstart = KLCF_NEXT(start);\r\n}\r\nreturn (lboard_t *)NULL;\r\n}\r\nlboard_t *find_lboard_class(lboard_t *start, unsigned char brd_type)\r\n{\r\nwhile (start) {\r\nif (KLCLASS(start->brd_type) == KLCLASS(brd_type))\r\nreturn start;\r\nstart = KLCF_NEXT(start);\r\n}\r\nreturn (lboard_t *)NULL;\r\n}\r\ncnodeid_t get_cpu_cnode(cpuid_t cpu)\r\n{\r\nreturn CPUID_TO_COMPACT_NODEID(cpu);\r\n}\r\nklcpu_t *nasid_slice_to_cpuinfo(nasid_t nasid, int slice)\r\n{\r\nlboard_t *brd;\r\nklcpu_t *acpu;\r\nif (!(brd = find_lboard((lboard_t *)KL_CONFIG_INFO(nasid), KLTYPE_IP27)))\r\nreturn (klcpu_t *)NULL;\r\nif (!(acpu = (klcpu_t *)find_first_component(brd, KLSTRUCT_CPU)))\r\nreturn (klcpu_t *)NULL;\r\ndo {\r\nif ((acpu->cpu_info.physid) == slice)\r\nreturn acpu;\r\n} while ((acpu = (klcpu_t *)find_component(brd, (klinfo_t *)acpu,\r\nKLSTRUCT_CPU)));\r\nreturn (klcpu_t *)NULL;\r\n}\r\nklcpu_t *sn_get_cpuinfo(cpuid_t cpu)\r\n{\r\nnasid_t nasid;\r\nint slice;\r\nklcpu_t *acpu;\r\ngda_t *gdap = GDA;\r\ncnodeid_t cnode;\r\nif (!(cpu < MAXCPUS)) {\r\nprintk("sn_get_cpuinfo: illegal cpuid 0x%lx\n", cpu);\r\nreturn NULL;\r\n}\r\ncnode = get_cpu_cnode(cpu);\r\nif (cnode == INVALID_CNODEID)\r\nreturn NULL;\r\nif ((nasid = gdap->g_nasidtable[cnode]) == INVALID_NASID)\r\nreturn NULL;\r\nfor (slice = 0; slice < CPUS_PER_NODE; slice++) {\r\nacpu = nasid_slice_to_cpuinfo(nasid, slice);\r\nif (acpu && acpu->cpu_info.virtid == cpu)\r\nreturn acpu;\r\n}\r\nreturn NULL;\r\n}\r\nint get_cpu_slice(cpuid_t cpu)\r\n{\r\nklcpu_t *acpu;\r\nif ((acpu = sn_get_cpuinfo(cpu)) == NULL)\r\nreturn -1;\r\nreturn acpu->cpu_info.physid;\r\n}

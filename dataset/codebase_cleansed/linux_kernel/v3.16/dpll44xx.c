int omap4_dpllmx_gatectrl_read(struct clk_hw_omap *clk)\r\n{\r\nu32 v;\r\nu32 mask;\r\nif (!clk || !clk->clksel_reg || !cpu_is_omap44xx())\r\nreturn -EINVAL;\r\nmask = clk->flags & CLOCK_CLKOUTX2 ?\r\nOMAP4430_DPLL_CLKOUTX2_GATE_CTRL_MASK :\r\nOMAP4430_DPLL_CLKOUT_GATE_CTRL_MASK;\r\nv = omap2_clk_readl(clk, clk->clksel_reg);\r\nv &= mask;\r\nv >>= __ffs(mask);\r\nreturn v;\r\n}\r\nvoid omap4_dpllmx_allow_gatectrl(struct clk_hw_omap *clk)\r\n{\r\nu32 v;\r\nu32 mask;\r\nif (!clk || !clk->clksel_reg || !cpu_is_omap44xx())\r\nreturn;\r\nmask = clk->flags & CLOCK_CLKOUTX2 ?\r\nOMAP4430_DPLL_CLKOUTX2_GATE_CTRL_MASK :\r\nOMAP4430_DPLL_CLKOUT_GATE_CTRL_MASK;\r\nv = omap2_clk_readl(clk, clk->clksel_reg);\r\nv &= ~mask;\r\nomap2_clk_writel(v, clk, clk->clksel_reg);\r\n}\r\nvoid omap4_dpllmx_deny_gatectrl(struct clk_hw_omap *clk)\r\n{\r\nu32 v;\r\nu32 mask;\r\nif (!clk || !clk->clksel_reg || !cpu_is_omap44xx())\r\nreturn;\r\nmask = clk->flags & CLOCK_CLKOUTX2 ?\r\nOMAP4430_DPLL_CLKOUTX2_GATE_CTRL_MASK :\r\nOMAP4430_DPLL_CLKOUT_GATE_CTRL_MASK;\r\nv = omap2_clk_readl(clk, clk->clksel_reg);\r\nv |= mask;\r\nomap2_clk_writel(v, clk, clk->clksel_reg);\r\n}\r\nstatic void omap4_dpll_lpmode_recalc(struct dpll_data *dd)\r\n{\r\nlong fint, fout;\r\nfint = __clk_get_rate(dd->clk_ref) / (dd->last_rounded_n + 1);\r\nfout = fint * dd->last_rounded_m;\r\nif ((fint < OMAP4_DPLL_LP_FINT_MAX) && (fout < OMAP4_DPLL_LP_FOUT_MAX))\r\ndd->last_rounded_lpmode = 1;\r\nelse\r\ndd->last_rounded_lpmode = 0;\r\n}\r\nunsigned long omap4_dpll_regm4xen_recalc(struct clk_hw *hw,\r\nunsigned long parent_rate)\r\n{\r\nstruct clk_hw_omap *clk = to_clk_hw_omap(hw);\r\nu32 v;\r\nunsigned long rate;\r\nstruct dpll_data *dd;\r\nif (!clk || !clk->dpll_data)\r\nreturn 0;\r\ndd = clk->dpll_data;\r\nrate = omap2_get_dpll_rate(clk);\r\nv = omap2_clk_readl(clk, dd->control_reg);\r\nif (v & OMAP4430_DPLL_REGM4XEN_MASK)\r\nrate *= OMAP4430_REGM4XEN_MULT;\r\nreturn rate;\r\n}\r\nlong omap4_dpll_regm4xen_round_rate(struct clk_hw *hw,\r\nunsigned long target_rate,\r\nunsigned long *parent_rate)\r\n{\r\nstruct clk_hw_omap *clk = to_clk_hw_omap(hw);\r\nstruct dpll_data *dd;\r\nlong r;\r\nif (!clk || !clk->dpll_data)\r\nreturn -EINVAL;\r\ndd = clk->dpll_data;\r\ndd->last_rounded_m4xen = 0;\r\nr = omap2_dpll_round_rate(hw, target_rate, NULL);\r\nif (r != ~0)\r\ngoto out;\r\nr = omap2_dpll_round_rate(hw, target_rate / OMAP4430_REGM4XEN_MULT,\r\nNULL);\r\nif (r == ~0)\r\nreturn r;\r\ndd->last_rounded_rate *= OMAP4430_REGM4XEN_MULT;\r\ndd->last_rounded_m4xen = 1;\r\nout:\r\nomap4_dpll_lpmode_recalc(dd);\r\nreturn dd->last_rounded_rate;\r\n}

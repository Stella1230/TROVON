static int l4_wait_ready(void)\r\n{\r\nunsigned int t = L4_TIMEOUT;\r\nwhile ((inb(L4_PORT) & L4_BUSY) && t > 0) t--;\r\nreturn -(t <= 0);\r\n}\r\nstatic int l4_cooked_read(struct gameport *gameport, int *axes, int *buttons)\r\n{\r\nstruct l4 *l4 = gameport->port_data;\r\nunsigned char status;\r\nint i, result = -1;\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\noutb(L4_SELECT_DIGITAL + (l4->port >> 2), L4_PORT);\r\nif (inb(L4_PORT) & L4_BUSY) goto fail;\r\noutb(l4->port & 3, L4_PORT);\r\nif (l4_wait_ready()) goto fail;\r\nstatus = inb(L4_PORT);\r\nfor (i = 0; i < 4; i++)\r\nif (status & (1 << i)) {\r\nif (l4_wait_ready()) goto fail;\r\naxes[i] = inb(L4_PORT);\r\nif (axes[i] > 252) axes[i] = -1;\r\n}\r\nif (status & 0x10) {\r\nif (l4_wait_ready()) goto fail;\r\n*buttons = inb(L4_PORT) & 0x0f;\r\n}\r\nresult = 0;\r\nfail: outb(L4_SELECT_ANALOG, L4_PORT);\r\nreturn result;\r\n}\r\nstatic int l4_open(struct gameport *gameport, int mode)\r\n{\r\nstruct l4 *l4 = gameport->port_data;\r\nif (l4->port != 0 && mode != GAMEPORT_MODE_COOKED)\r\nreturn -1;\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\nreturn 0;\r\n}\r\nstatic int l4_getcal(int port, int *cal)\r\n{\r\nint i, result = -1;\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\noutb(L4_SELECT_DIGITAL + (port >> 2), L4_PORT);\r\nif (inb(L4_PORT) & L4_BUSY)\r\ngoto out;\r\noutb(L4_CMD_GETCAL, L4_PORT);\r\nif (l4_wait_ready())\r\ngoto out;\r\nif (inb(L4_PORT) != L4_SELECT_DIGITAL + (port >> 2))\r\ngoto out;\r\nif (l4_wait_ready())\r\ngoto out;\r\noutb(port & 3, L4_PORT);\r\nfor (i = 0; i < 4; i++) {\r\nif (l4_wait_ready())\r\ngoto out;\r\ncal[i] = inb(L4_PORT);\r\n}\r\nresult = 0;\r\nout: outb(L4_SELECT_ANALOG, L4_PORT);\r\nreturn result;\r\n}\r\nstatic int l4_setcal(int port, int *cal)\r\n{\r\nint i, result = -1;\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\noutb(L4_SELECT_DIGITAL + (port >> 2), L4_PORT);\r\nif (inb(L4_PORT) & L4_BUSY)\r\ngoto out;\r\noutb(L4_CMD_SETCAL, L4_PORT);\r\nif (l4_wait_ready())\r\ngoto out;\r\nif (inb(L4_PORT) != L4_SELECT_DIGITAL + (port >> 2))\r\ngoto out;\r\nif (l4_wait_ready())\r\ngoto out;\r\noutb(port & 3, L4_PORT);\r\nfor (i = 0; i < 4; i++) {\r\nif (l4_wait_ready())\r\ngoto out;\r\noutb(cal[i], L4_PORT);\r\n}\r\nresult = 0;\r\nout: outb(L4_SELECT_ANALOG, L4_PORT);\r\nreturn result;\r\n}\r\nstatic int l4_calibrate(struct gameport *gameport, int *axes, int *max)\r\n{\r\nint i, t;\r\nint cal[4];\r\nstruct l4 *l4 = gameport->port_data;\r\nif (l4_getcal(l4->port, cal))\r\nreturn -1;\r\nfor (i = 0; i < 4; i++) {\r\nt = (max[i] * cal[i]) / 200;\r\nt = (t < 1) ? 1 : ((t > 255) ? 255 : t);\r\naxes[i] = (axes[i] < 0) ? -1 : (axes[i] * cal[i]) / t;\r\naxes[i] = (axes[i] > 252) ? 252 : axes[i];\r\ncal[i] = t;\r\n}\r\nif (l4_setcal(l4->port, cal))\r\nreturn -1;\r\nreturn 0;\r\n}\r\nstatic int __init l4_create_ports(int card_no)\r\n{\r\nstruct l4 *l4;\r\nstruct gameport *port;\r\nint i, idx;\r\nfor (i = 0; i < 4; i++) {\r\nidx = card_no * 4 + i;\r\nl4 = &l4_ports[idx];\r\nif (!(l4->gameport = port = gameport_allocate_port())) {\r\nprintk(KERN_ERR "lightning: Memory allocation failed\n");\r\nwhile (--i >= 0) {\r\ngameport_free_port(l4->gameport);\r\nl4->gameport = NULL;\r\n}\r\nreturn -ENOMEM;\r\n}\r\nl4->port = idx;\r\nport->port_data = l4;\r\nport->open = l4_open;\r\nport->cooked_read = l4_cooked_read;\r\nport->calibrate = l4_calibrate;\r\ngameport_set_name(port, "PDPI Lightning 4");\r\ngameport_set_phys(port, "isa%04x/gameport%d", L4_PORT, idx);\r\nif (idx == 0)\r\nport->io = L4_PORT;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init l4_add_card(int card_no)\r\n{\r\nint cal[4] = { 255, 255, 255, 255 };\r\nint i, rev, result;\r\nstruct l4 *l4;\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\noutb(L4_SELECT_DIGITAL + card_no, L4_PORT);\r\nif (inb(L4_PORT) & L4_BUSY)\r\nreturn -1;\r\noutb(L4_CMD_ID, L4_PORT);\r\nif (l4_wait_ready())\r\nreturn -1;\r\nif (inb(L4_PORT) != L4_SELECT_DIGITAL + card_no)\r\nreturn -1;\r\nif (l4_wait_ready())\r\nreturn -1;\r\nif (inb(L4_PORT) != L4_ID)\r\nreturn -1;\r\nif (l4_wait_ready())\r\nreturn -1;\r\nrev = inb(L4_PORT);\r\nif (!rev)\r\nreturn -1;\r\nresult = l4_create_ports(card_no);\r\nif (result)\r\nreturn result;\r\nprintk(KERN_INFO "gameport: PDPI Lightning 4 %s card v%d.%d at %#x\n",\r\ncard_no ? "secondary" : "primary", rev >> 4, rev, L4_PORT);\r\nfor (i = 0; i < 4; i++) {\r\nl4 = &l4_ports[card_no * 4 + i];\r\nif (rev > 0x28)\r\nl4_setcal(l4->port, cal);\r\ngameport_register_port(l4->gameport);\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init l4_init(void)\r\n{\r\nint i, cards = 0;\r\nif (!request_region(L4_PORT, 1, "lightning"))\r\nreturn -EBUSY;\r\nfor (i = 0; i < 2; i++)\r\nif (l4_add_card(i) == 0)\r\ncards++;\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\nif (!cards) {\r\nrelease_region(L4_PORT, 1);\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit l4_exit(void)\r\n{\r\nint i;\r\nint cal[4] = { 59, 59, 59, 59 };\r\nfor (i = 0; i < 8; i++)\r\nif (l4_ports[i].gameport) {\r\nl4_setcal(l4_ports[i].port, cal);\r\ngameport_unregister_port(l4_ports[i].gameport);\r\n}\r\noutb(L4_SELECT_ANALOG, L4_PORT);\r\nrelease_region(L4_PORT, 1);\r\n}

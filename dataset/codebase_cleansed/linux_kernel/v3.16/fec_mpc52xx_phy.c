static int mpc52xx_fec_mdio_transfer(struct mii_bus *bus, int phy_id,\r\nint reg, u32 value)\r\n{\r\nstruct mpc52xx_fec_mdio_priv *priv = bus->priv;\r\nstruct mpc52xx_fec __iomem *fec = priv->regs;\r\nint tries = 3;\r\nvalue |= (phy_id << FEC_MII_DATA_PA_SHIFT) & FEC_MII_DATA_PA_MSK;\r\nvalue |= (reg << FEC_MII_DATA_RA_SHIFT) & FEC_MII_DATA_RA_MSK;\r\nout_be32(&fec->ievent, FEC_IEVENT_MII);\r\nout_be32(&fec->mii_data, value);\r\nwhile (!(in_be32(&fec->ievent) & FEC_IEVENT_MII) && --tries)\r\nmsleep(1);\r\nif (!tries)\r\nreturn -ETIMEDOUT;\r\nreturn value & FEC_MII_DATA_OP_RD ?\r\nin_be32(&fec->mii_data) & FEC_MII_DATA_DATAMSK : 0;\r\n}\r\nstatic int mpc52xx_fec_mdio_read(struct mii_bus *bus, int phy_id, int reg)\r\n{\r\nreturn mpc52xx_fec_mdio_transfer(bus, phy_id, reg, FEC_MII_READ_FRAME);\r\n}\r\nstatic int mpc52xx_fec_mdio_write(struct mii_bus *bus, int phy_id, int reg,\r\nu16 data)\r\n{\r\nreturn mpc52xx_fec_mdio_transfer(bus, phy_id, reg,\r\ndata | FEC_MII_WRITE_FRAME);\r\n}\r\nstatic int mpc52xx_fec_mdio_probe(struct platform_device *of)\r\n{\r\nstruct device *dev = &of->dev;\r\nstruct device_node *np = of->dev.of_node;\r\nstruct mii_bus *bus;\r\nstruct mpc52xx_fec_mdio_priv *priv;\r\nstruct resource res;\r\nint err;\r\nbus = mdiobus_alloc();\r\nif (bus == NULL)\r\nreturn -ENOMEM;\r\npriv = kzalloc(sizeof(*priv), GFP_KERNEL);\r\nif (priv == NULL) {\r\nerr = -ENOMEM;\r\ngoto out_free;\r\n}\r\nbus->name = "mpc52xx MII bus";\r\nbus->read = mpc52xx_fec_mdio_read;\r\nbus->write = mpc52xx_fec_mdio_write;\r\nbus->irq = priv->mdio_irqs;\r\nerr = of_address_to_resource(np, 0, &res);\r\nif (err)\r\ngoto out_free;\r\npriv->regs = ioremap(res.start, resource_size(&res));\r\nif (priv->regs == NULL) {\r\nerr = -ENOMEM;\r\ngoto out_free;\r\n}\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%x", res.start);\r\nbus->priv = priv;\r\nbus->parent = dev;\r\ndev_set_drvdata(dev, bus);\r\nout_be32(&priv->regs->mii_speed,\r\n((mpc5xxx_get_bus_frequency(of->dev.of_node) >> 20) / 5) << 1);\r\nerr = of_mdiobus_register(bus, np);\r\nif (err)\r\ngoto out_unmap;\r\nreturn 0;\r\nout_unmap:\r\niounmap(priv->regs);\r\nout_free:\r\nkfree(priv);\r\nmdiobus_free(bus);\r\nreturn err;\r\n}\r\nstatic int mpc52xx_fec_mdio_remove(struct platform_device *of)\r\n{\r\nstruct mii_bus *bus = platform_get_drvdata(of);\r\nstruct mpc52xx_fec_mdio_priv *priv = bus->priv;\r\nmdiobus_unregister(bus);\r\niounmap(priv->regs);\r\nkfree(priv);\r\nmdiobus_free(bus);\r\nreturn 0;\r\n}

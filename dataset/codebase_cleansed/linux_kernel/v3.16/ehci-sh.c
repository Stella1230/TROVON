static int ehci_sh_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nehci->caps = hcd->regs;\r\nreturn ehci_setup(hcd);\r\n}\r\nstatic int ehci_hcd_sh_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct ehci_sh_priv *priv;\r\nstruct ehci_sh_platdata *pdata;\r\nstruct usb_hcd *hcd;\r\nint irq, ret;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no register addr. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nret = -ENODEV;\r\ngoto fail_create_hcd;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq <= 0) {\r\ndev_err(&pdev->dev,\r\n"Found HC with no IRQ. Check %s setup!\n",\r\ndev_name(&pdev->dev));\r\nret = -ENODEV;\r\ngoto fail_create_hcd;\r\n}\r\npdata = dev_get_platdata(&pdev->dev);\r\nhcd = usb_create_hcd(&ehci_sh_hc_driver, &pdev->dev,\r\ndev_name(&pdev->dev));\r\nif (!hcd) {\r\nret = -ENOMEM;\r\ngoto fail_create_hcd;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nhcd->regs = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(hcd->regs)) {\r\nret = PTR_ERR(hcd->regs);\r\ngoto fail_request_resource;\r\n}\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct ehci_sh_priv),\r\nGFP_KERNEL);\r\nif (!priv) {\r\ndev_dbg(&pdev->dev, "error allocating priv data\n");\r\nret = -ENOMEM;\r\ngoto fail_request_resource;\r\n}\r\npriv->fclk = devm_clk_get(&pdev->dev, "usb_fck");\r\nif (IS_ERR(priv->fclk))\r\npriv->fclk = NULL;\r\npriv->iclk = devm_clk_get(&pdev->dev, "usb_ick");\r\nif (IS_ERR(priv->iclk))\r\npriv->iclk = NULL;\r\nclk_enable(priv->fclk);\r\nclk_enable(priv->iclk);\r\nif (pdata && pdata->phy_init)\r\npdata->phy_init();\r\nret = usb_add_hcd(hcd, irq, IRQF_SHARED);\r\nif (ret != 0) {\r\ndev_err(&pdev->dev, "Failed to add hcd");\r\ngoto fail_add_hcd;\r\n}\r\ndevice_wakeup_enable(hcd->self.controller);\r\npriv->hcd = hcd;\r\nplatform_set_drvdata(pdev, priv);\r\nreturn ret;\r\nfail_add_hcd:\r\nclk_disable(priv->iclk);\r\nclk_disable(priv->fclk);\r\nfail_request_resource:\r\nusb_put_hcd(hcd);\r\nfail_create_hcd:\r\ndev_err(&pdev->dev, "init %s fail, %d\n", dev_name(&pdev->dev), ret);\r\nreturn ret;\r\n}\r\nstatic int ehci_hcd_sh_remove(struct platform_device *pdev)\r\n{\r\nstruct ehci_sh_priv *priv = platform_get_drvdata(pdev);\r\nstruct usb_hcd *hcd = priv->hcd;\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\nclk_disable(priv->fclk);\r\nclk_disable(priv->iclk);\r\nreturn 0;\r\n}\r\nstatic void ehci_hcd_sh_shutdown(struct platform_device *pdev)\r\n{\r\nstruct ehci_sh_priv *priv = platform_get_drvdata(pdev);\r\nstruct usb_hcd *hcd = priv->hcd;\r\nif (hcd->driver->shutdown)\r\nhcd->driver->shutdown(hcd);\r\n}

static __init int rndis_do_config(struct usb_configuration *c)\r\n{\r\nstruct fsg_opts *fsg_opts;\r\nint ret;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nf_rndis = usb_get_function(fi_rndis);\r\nif (IS_ERR(f_rndis))\r\nreturn PTR_ERR(f_rndis);\r\nret = usb_add_function(c, f_rndis);\r\nif (ret < 0)\r\ngoto err_func_rndis;\r\nf_acm_rndis = usb_get_function(fi_acm);\r\nif (IS_ERR(f_acm_rndis)) {\r\nret = PTR_ERR(f_acm_rndis);\r\ngoto err_func_acm;\r\n}\r\nret = usb_add_function(c, f_acm_rndis);\r\nif (ret)\r\ngoto err_conf;\r\nf_msg_rndis = usb_get_function(fi_msg);\r\nif (IS_ERR(f_msg_rndis)) {\r\nret = PTR_ERR(f_msg_rndis);\r\ngoto err_fsg;\r\n}\r\nfsg_opts = fsg_opts_from_func_inst(fi_msg);\r\nret = fsg_common_run_thread(fsg_opts->common);\r\nif (ret)\r\ngoto err_run;\r\nret = usb_add_function(c, f_msg_rndis);\r\nif (ret)\r\ngoto err_run;\r\nreturn 0;\r\nerr_run:\r\nusb_put_function(f_msg_rndis);\r\nerr_fsg:\r\nusb_remove_function(c, f_acm_rndis);\r\nerr_conf:\r\nusb_put_function(f_acm_rndis);\r\nerr_func_acm:\r\nusb_remove_function(c, f_rndis);\r\nerr_func_rndis:\r\nusb_put_function(f_rndis);\r\nreturn ret;\r\n}\r\nstatic __ref int rndis_config_register(struct usb_composite_dev *cdev)\r\n{\r\nstatic struct usb_configuration config = {\r\n.bConfigurationValue = MULTI_RNDIS_CONFIG_NUM,\r\n.bmAttributes = USB_CONFIG_ATT_SELFPOWER,\r\n};\r\nconfig.label = strings_dev[MULTI_STRING_RNDIS_CONFIG_IDX].s;\r\nconfig.iConfiguration = strings_dev[MULTI_STRING_RNDIS_CONFIG_IDX].id;\r\nreturn usb_add_config(cdev, &config, rndis_do_config);\r\n}\r\nstatic __ref int rndis_config_register(struct usb_composite_dev *cdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic __init int cdc_do_config(struct usb_configuration *c)\r\n{\r\nstruct fsg_opts *fsg_opts;\r\nint ret;\r\nif (gadget_is_otg(c->cdev->gadget)) {\r\nc->descriptors = otg_desc;\r\nc->bmAttributes |= USB_CONFIG_ATT_WAKEUP;\r\n}\r\nf_ecm = usb_get_function(fi_ecm);\r\nif (IS_ERR(f_ecm))\r\nreturn PTR_ERR(f_ecm);\r\nret = usb_add_function(c, f_ecm);\r\nif (ret < 0)\r\ngoto err_func_ecm;\r\nf_acm_multi = usb_get_function(fi_acm);\r\nif (IS_ERR(f_acm_multi)) {\r\nret = PTR_ERR(f_acm_multi);\r\ngoto err_func_acm;\r\n}\r\nret = usb_add_function(c, f_acm_multi);\r\nif (ret)\r\ngoto err_conf;\r\nf_msg_multi = usb_get_function(fi_msg);\r\nif (IS_ERR(f_msg_multi)) {\r\nret = PTR_ERR(f_msg_multi);\r\ngoto err_fsg;\r\n}\r\nfsg_opts = fsg_opts_from_func_inst(fi_msg);\r\nret = fsg_common_run_thread(fsg_opts->common);\r\nif (ret)\r\ngoto err_run;\r\nret = usb_add_function(c, f_msg_multi);\r\nif (ret)\r\ngoto err_run;\r\nreturn 0;\r\nerr_run:\r\nusb_put_function(f_msg_multi);\r\nerr_fsg:\r\nusb_remove_function(c, f_acm_multi);\r\nerr_conf:\r\nusb_put_function(f_acm_multi);\r\nerr_func_acm:\r\nusb_remove_function(c, f_ecm);\r\nerr_func_ecm:\r\nusb_put_function(f_ecm);\r\nreturn ret;\r\n}\r\nstatic __ref int cdc_config_register(struct usb_composite_dev *cdev)\r\n{\r\nstatic struct usb_configuration config = {\r\n.bConfigurationValue = MULTI_CDC_CONFIG_NUM,\r\n.bmAttributes = USB_CONFIG_ATT_SELFPOWER,\r\n};\r\nconfig.label = strings_dev[MULTI_STRING_CDC_CONFIG_IDX].s;\r\nconfig.iConfiguration = strings_dev[MULTI_STRING_CDC_CONFIG_IDX].id;\r\nreturn usb_add_config(cdev, &config, cdc_do_config);\r\n}\r\nstatic __ref int cdc_config_register(struct usb_composite_dev *cdev)\r\n{\r\nreturn 0;\r\n}\r\nstatic int __ref multi_bind(struct usb_composite_dev *cdev)\r\n{\r\nstruct usb_gadget *gadget = cdev->gadget;\r\n#ifdef CONFIG_USB_G_MULTI_CDC\r\nstruct f_ecm_opts *ecm_opts;\r\n#endif\r\n#ifdef USB_ETH_RNDIS\r\nstruct f_rndis_opts *rndis_opts;\r\n#endif\r\nstruct fsg_opts *fsg_opts;\r\nstruct fsg_config config;\r\nint status;\r\nif (!can_support_ecm(cdev->gadget)) {\r\ndev_err(&gadget->dev, "controller '%s' not usable\n",\r\ngadget->name);\r\nreturn -EINVAL;\r\n}\r\n#ifdef CONFIG_USB_G_MULTI_CDC\r\nfi_ecm = usb_get_function_instance("ecm");\r\nif (IS_ERR(fi_ecm))\r\nreturn PTR_ERR(fi_ecm);\r\necm_opts = container_of(fi_ecm, struct f_ecm_opts, func_inst);\r\ngether_set_qmult(ecm_opts->net, qmult);\r\nif (!gether_set_host_addr(ecm_opts->net, host_addr))\r\npr_info("using host ethernet address: %s", host_addr);\r\nif (!gether_set_dev_addr(ecm_opts->net, dev_addr))\r\npr_info("using self ethernet address: %s", dev_addr);\r\n#endif\r\n#ifdef USB_ETH_RNDIS\r\nfi_rndis = usb_get_function_instance("rndis");\r\nif (IS_ERR(fi_rndis)) {\r\nstatus = PTR_ERR(fi_rndis);\r\ngoto fail;\r\n}\r\nrndis_opts = container_of(fi_rndis, struct f_rndis_opts, func_inst);\r\ngether_set_qmult(rndis_opts->net, qmult);\r\nif (!gether_set_host_addr(rndis_opts->net, host_addr))\r\npr_info("using host ethernet address: %s", host_addr);\r\nif (!gether_set_dev_addr(rndis_opts->net, dev_addr))\r\npr_info("using self ethernet address: %s", dev_addr);\r\n#endif\r\n#if (defined CONFIG_USB_G_MULTI_CDC && defined USB_ETH_RNDIS)\r\ngether_set_gadget(ecm_opts->net, cdev->gadget);\r\nstatus = gether_register_netdev(ecm_opts->net);\r\nif (status)\r\ngoto fail0;\r\nrndis_borrow_net(fi_rndis, ecm_opts->net);\r\necm_opts->bound = true;\r\n#endif\r\nfi_acm = usb_get_function_instance("acm");\r\nif (IS_ERR(fi_acm)) {\r\nstatus = PTR_ERR(fi_acm);\r\ngoto fail0;\r\n}\r\nfi_msg = usb_get_function_instance("mass_storage");\r\nif (IS_ERR(fi_msg)) {\r\nstatus = PTR_ERR(fi_msg);\r\ngoto fail1;\r\n}\r\nfsg_config_from_params(&config, &fsg_mod_data, fsg_num_buffers);\r\nfsg_opts = fsg_opts_from_func_inst(fi_msg);\r\nfsg_opts->no_configfs = true;\r\nstatus = fsg_common_set_num_buffers(fsg_opts->common, fsg_num_buffers);\r\nif (status)\r\ngoto fail2;\r\nstatus = fsg_common_set_nluns(fsg_opts->common, config.nluns);\r\nif (status)\r\ngoto fail_set_nluns;\r\nstatus = fsg_common_set_cdev(fsg_opts->common, cdev, config.can_stall);\r\nif (status)\r\ngoto fail_set_cdev;\r\nfsg_common_set_sysfs(fsg_opts->common, true);\r\nstatus = fsg_common_create_luns(fsg_opts->common, &config);\r\nif (status)\r\ngoto fail_set_cdev;\r\nfsg_common_set_inquiry_string(fsg_opts->common, config.vendor_name,\r\nconfig.product_name);\r\nstatus = usb_string_ids_tab(cdev, strings_dev);\r\nif (unlikely(status < 0))\r\ngoto fail_string_ids;\r\ndevice_desc.iProduct = strings_dev[USB_GADGET_PRODUCT_IDX].id;\r\nstatus = rndis_config_register(cdev);\r\nif (unlikely(status < 0))\r\ngoto fail_string_ids;\r\nstatus = cdc_config_register(cdev);\r\nif (unlikely(status < 0))\r\ngoto fail_string_ids;\r\nusb_composite_overwrite_options(cdev, &coverwrite);\r\ndev_info(&gadget->dev, DRIVER_DESC "\n");\r\nreturn 0;\r\nfail_string_ids:\r\nfsg_common_remove_luns(fsg_opts->common);\r\nfail_set_cdev:\r\nfsg_common_free_luns(fsg_opts->common);\r\nfail_set_nluns:\r\nfsg_common_free_buffers(fsg_opts->common);\r\nfail2:\r\nusb_put_function_instance(fi_msg);\r\nfail1:\r\nusb_put_function_instance(fi_acm);\r\nfail0:\r\n#ifdef USB_ETH_RNDIS\r\nusb_put_function_instance(fi_rndis);\r\nfail:\r\n#endif\r\n#ifdef CONFIG_USB_G_MULTI_CDC\r\nusb_put_function_instance(fi_ecm);\r\n#endif\r\nreturn status;\r\n}\r\nstatic int __exit multi_unbind(struct usb_composite_dev *cdev)\r\n{\r\n#ifdef CONFIG_USB_G_MULTI_CDC\r\nusb_put_function(f_msg_multi);\r\n#endif\r\n#ifdef USB_ETH_RNDIS\r\nusb_put_function(f_msg_rndis);\r\n#endif\r\nusb_put_function_instance(fi_msg);\r\n#ifdef CONFIG_USB_G_MULTI_CDC\r\nusb_put_function(f_acm_multi);\r\n#endif\r\n#ifdef USB_ETH_RNDIS\r\nusb_put_function(f_acm_rndis);\r\n#endif\r\nusb_put_function_instance(fi_acm);\r\n#ifdef USB_ETH_RNDIS\r\nusb_put_function(f_rndis);\r\nusb_put_function_instance(fi_rndis);\r\n#endif\r\n#ifdef CONFIG_USB_G_MULTI_CDC\r\nusb_put_function(f_ecm);\r\nusb_put_function_instance(fi_ecm);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic int __init multi_init(void)\r\n{\r\nreturn usb_composite_probe(&multi_driver);\r\n}\r\nstatic void __exit multi_exit(void)\r\n{\r\nusb_composite_unregister(&multi_driver);\r\n}

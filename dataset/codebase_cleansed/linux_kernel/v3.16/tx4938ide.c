static void tx4938ide_tune_ebusc(unsigned int ebus_ch,\r\nunsigned int gbus_clock,\r\nu8 pio)\r\n{\r\nstruct ide_timing *t = ide_timing_find_mode(XFER_PIO_0 + pio);\r\nu64 cr = __raw_readq(&tx4938_ebuscptr->cr[ebus_ch]);\r\nunsigned int sp = (cr >> 4) & 3;\r\nunsigned int clock = gbus_clock / (4 - sp);\r\nunsigned int cycle = 1000000000 / clock;\r\nunsigned int shwt;\r\nint wt;\r\nwt = DIV_ROUND_UP(t->act8b, cycle) - 2;\r\nwt = max_t(int, wt, DIV_ROUND_UP(35, cycle));\r\nif (wt > 2 && (wt & 1))\r\nwt++;\r\nwt &= ~1;\r\nshwt = DIV_ROUND_UP(t->setup, cycle);\r\nwhile ((shwt * 4 + wt + (wt ? 2 : 3)) * cycle < t->cycle)\r\nshwt++;\r\nif (shwt > 7) {\r\npr_warning("tx4938ide: SHWT violation (%d)\n", shwt);\r\nshwt = 7;\r\n}\r\npr_debug("tx4938ide: ebus %d, bus cycle %dns, WT %d, SHWT %d\n",\r\nebus_ch, cycle, wt, shwt);\r\n__raw_writeq((cr & ~0x3f007ull) | (wt << 12) | shwt,\r\n&tx4938_ebuscptr->cr[ebus_ch]);\r\n}\r\nstatic void tx4938ide_set_pio_mode(ide_hwif_t *hwif, ide_drive_t *drive)\r\n{\r\nstruct tx4938ide_platform_info *pdata = dev_get_platdata(hwif->dev);\r\nu8 safe = drive->pio_mode - XFER_PIO_0;\r\nide_drive_t *pair;\r\npair = ide_get_pair_dev(drive);\r\nif (pair)\r\nsafe = min_t(u8, safe, pair->pio_mode - XFER_PIO_0);\r\ntx4938ide_tune_ebusc(pdata->ebus_ch, pdata->gbus_clock, safe);\r\n}\r\nstatic void tx4938ide_input_data_swap(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long port = drive->hwif->io_ports.data_addr;\r\nunsigned short *ptr = buf;\r\nunsigned int count = (len + 1) / 2;\r\nwhile (count--)\r\n*ptr++ = cpu_to_le16(__raw_readw((void __iomem *)port));\r\n__ide_flush_dcache_range((unsigned long)buf, roundup(len, 2));\r\n}\r\nstatic void tx4938ide_output_data_swap(ide_drive_t *drive, struct ide_cmd *cmd,\r\nvoid *buf, unsigned int len)\r\n{\r\nunsigned long port = drive->hwif->io_ports.data_addr;\r\nunsigned short *ptr = buf;\r\nunsigned int count = (len + 1) / 2;\r\nwhile (count--) {\r\n__raw_writew(le16_to_cpu(*ptr), (void __iomem *)port);\r\nptr++;\r\n}\r\n__ide_flush_dcache_range((unsigned long)buf, roundup(len, 2));\r\n}\r\nstatic int __init tx4938ide_probe(struct platform_device *pdev)\r\n{\r\nstruct ide_hw hw, *hws[] = { &hw };\r\nstruct ide_host *host;\r\nstruct resource *res;\r\nstruct tx4938ide_platform_info *pdata = dev_get_platdata(&pdev->dev);\r\nint irq, ret, i;\r\nunsigned long mapbase, mapctl;\r\nstruct ide_port_info d = tx4938ide_port_info;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0)\r\nreturn -ENODEV;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -ENODEV;\r\nif (!devm_request_mem_region(&pdev->dev, res->start,\r\nresource_size(res), "tx4938ide"))\r\nreturn -EBUSY;\r\nmapbase = (unsigned long)devm_ioremap(&pdev->dev, res->start,\r\n8 << pdata->ioport_shift);\r\nmapctl = (unsigned long)devm_ioremap(&pdev->dev,\r\nres->start + 0x10000 +\r\n(6 << pdata->ioport_shift),\r\n1 << pdata->ioport_shift);\r\nif (!mapbase || !mapctl)\r\nreturn -EBUSY;\r\nmemset(&hw, 0, sizeof(hw));\r\nif (pdata->ioport_shift) {\r\nunsigned long port = mapbase;\r\nunsigned long ctl = mapctl;\r\nhw.io_ports_array[0] = port;\r\n#ifdef __BIG_ENDIAN\r\nport++;\r\nctl++;\r\n#endif\r\nfor (i = 1; i <= 7; i++)\r\nhw.io_ports_array[i] =\r\nport + (i << pdata->ioport_shift);\r\nhw.io_ports.ctl_addr = ctl;\r\n} else\r\nide_std_init_ports(&hw, mapbase, mapctl);\r\nhw.irq = irq;\r\nhw.dev = &pdev->dev;\r\npr_info("TX4938 IDE interface (base %#lx, ctl %#lx, irq %d)\n",\r\nmapbase, mapctl, hw.irq);\r\nif (pdata->gbus_clock)\r\ntx4938ide_tune_ebusc(pdata->ebus_ch, pdata->gbus_clock, 0);\r\nelse\r\nd.port_ops = NULL;\r\nret = ide_host_add(&d, hws, 1, &host);\r\nif (!ret)\r\nplatform_set_drvdata(pdev, host);\r\nreturn ret;\r\n}\r\nstatic int __exit tx4938ide_remove(struct platform_device *pdev)\r\n{\r\nstruct ide_host *host = platform_get_drvdata(pdev);\r\nide_host_remove(host);\r\nreturn 0;\r\n}

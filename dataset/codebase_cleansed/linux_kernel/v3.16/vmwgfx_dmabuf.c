int vmw_dmabuf_to_placement(struct vmw_private *dev_priv,\r\nstruct vmw_dma_buffer *buf,\r\nstruct ttm_placement *placement,\r\nbool interruptible)\r\n{\r\nstruct ttm_buffer_object *bo = &buf->base;\r\nint ret;\r\nret = ttm_write_lock(&dev_priv->reservation_sem, interruptible);\r\nif (unlikely(ret != 0))\r\nreturn ret;\r\nvmw_execbuf_release_pinned_bo(dev_priv);\r\nret = ttm_bo_reserve(bo, interruptible, false, false, 0);\r\nif (unlikely(ret != 0))\r\ngoto err;\r\nret = ttm_bo_validate(bo, placement, interruptible, false);\r\nttm_bo_unreserve(bo);\r\nerr:\r\nttm_write_unlock(&dev_priv->reservation_sem);\r\nreturn ret;\r\n}\r\nint vmw_dmabuf_to_vram_or_gmr(struct vmw_private *dev_priv,\r\nstruct vmw_dma_buffer *buf,\r\nbool pin, bool interruptible)\r\n{\r\nstruct ttm_buffer_object *bo = &buf->base;\r\nstruct ttm_placement *placement;\r\nint ret;\r\nret = ttm_write_lock(&dev_priv->reservation_sem, interruptible);\r\nif (unlikely(ret != 0))\r\nreturn ret;\r\nif (pin)\r\nvmw_execbuf_release_pinned_bo(dev_priv);\r\nret = ttm_bo_reserve(bo, interruptible, false, false, 0);\r\nif (unlikely(ret != 0))\r\ngoto err;\r\nif (pin)\r\nplacement = &vmw_vram_gmr_ne_placement;\r\nelse\r\nplacement = &vmw_vram_gmr_placement;\r\nret = ttm_bo_validate(bo, placement, interruptible, false);\r\nif (likely(ret == 0) || ret == -ERESTARTSYS)\r\ngoto err_unreserve;\r\nif (pin)\r\nplacement = &vmw_vram_ne_placement;\r\nelse\r\nplacement = &vmw_vram_placement;\r\nret = ttm_bo_validate(bo, placement, interruptible, false);\r\nerr_unreserve:\r\nttm_bo_unreserve(bo);\r\nerr:\r\nttm_write_unlock(&dev_priv->reservation_sem);\r\nreturn ret;\r\n}\r\nint vmw_dmabuf_to_vram(struct vmw_private *dev_priv,\r\nstruct vmw_dma_buffer *buf,\r\nbool pin, bool interruptible)\r\n{\r\nstruct ttm_placement *placement;\r\nif (pin)\r\nplacement = &vmw_vram_ne_placement;\r\nelse\r\nplacement = &vmw_vram_placement;\r\nreturn vmw_dmabuf_to_placement(dev_priv, buf,\r\nplacement,\r\ninterruptible);\r\n}\r\nint vmw_dmabuf_to_start_of_vram(struct vmw_private *dev_priv,\r\nstruct vmw_dma_buffer *buf,\r\nbool pin, bool interruptible)\r\n{\r\nstruct ttm_buffer_object *bo = &buf->base;\r\nstruct ttm_placement placement;\r\nint ret = 0;\r\nif (pin)\r\nplacement = vmw_vram_ne_placement;\r\nelse\r\nplacement = vmw_vram_placement;\r\nplacement.lpfn = bo->num_pages;\r\nret = ttm_write_lock(&dev_priv->reservation_sem, interruptible);\r\nif (unlikely(ret != 0))\r\nreturn ret;\r\nif (pin)\r\nvmw_execbuf_release_pinned_bo(dev_priv);\r\nret = ttm_bo_reserve(bo, interruptible, false, false, 0);\r\nif (unlikely(ret != 0))\r\ngoto err_unlock;\r\nif (bo->mem.mem_type == TTM_PL_VRAM &&\r\nbo->mem.start < bo->num_pages &&\r\nbo->mem.start > 0)\r\n(void) ttm_bo_validate(bo, &vmw_sys_placement, false, false);\r\nret = ttm_bo_validate(bo, &placement, interruptible, false);\r\nWARN_ON(ret == 0 && bo->offset != 0);\r\nttm_bo_unreserve(bo);\r\nerr_unlock:\r\nttm_write_unlock(&dev_priv->reservation_sem);\r\nreturn ret;\r\n}\r\nint vmw_dmabuf_unpin(struct vmw_private *dev_priv,\r\nstruct vmw_dma_buffer *buf,\r\nbool interruptible)\r\n{\r\nreturn vmw_dmabuf_to_placement(dev_priv, buf,\r\n&vmw_evictable_placement,\r\ninterruptible);\r\n}\r\nvoid vmw_bo_get_guest_ptr(const struct ttm_buffer_object *bo,\r\nSVGAGuestPtr *ptr)\r\n{\r\nif (bo->mem.mem_type == TTM_PL_VRAM) {\r\nptr->gmrId = SVGA_GMR_FRAMEBUFFER;\r\nptr->offset = bo->offset;\r\n} else {\r\nptr->gmrId = bo->mem.start;\r\nptr->offset = 0;\r\n}\r\n}\r\nvoid vmw_bo_pin(struct ttm_buffer_object *bo, bool pin)\r\n{\r\nuint32_t pl_flags;\r\nstruct ttm_placement placement;\r\nuint32_t old_mem_type = bo->mem.mem_type;\r\nint ret;\r\nlockdep_assert_held(&bo->resv->lock.base);\r\npl_flags = TTM_PL_FLAG_VRAM | VMW_PL_FLAG_GMR | VMW_PL_FLAG_MOB\r\n| TTM_PL_FLAG_SYSTEM | TTM_PL_FLAG_CACHED;\r\nif (pin)\r\npl_flags |= TTM_PL_FLAG_NO_EVICT;\r\nmemset(&placement, 0, sizeof(placement));\r\nplacement.num_placement = 1;\r\nplacement.placement = &pl_flags;\r\nret = ttm_bo_validate(bo, &placement, false, true);\r\nBUG_ON(ret != 0 || bo->mem.mem_type != old_mem_type);\r\n}

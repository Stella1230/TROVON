static int __init imx_weim_gpr_setup(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct property *prop;\r\nconst __be32 *p;\r\nstruct regmap *gpr;\r\nu32 gprvals[4] = {\r\n05,\r\n033,\r\n0113,\r\n01111,\r\n};\r\nu32 gprval = 0;\r\nu32 val;\r\nint cs = 0;\r\nint i = 0;\r\ngpr = syscon_regmap_lookup_by_phandle(np, "fsl,weim-cs-gpr");\r\nif (IS_ERR(gpr)) {\r\ndev_dbg(&pdev->dev, "failed to find weim-cs-gpr\n");\r\nreturn 0;\r\n}\r\nof_property_for_each_u32(np, "ranges", prop, p, val) {\r\nif (i % 4 == 0) {\r\ncs = val;\r\n} else if (i % 4 == 3 && val) {\r\nval = (val / SZ_32M) | 1;\r\ngprval |= val << cs * 3;\r\n}\r\ni++;\r\n}\r\nif (i == 0 || i % 4)\r\ngoto err;\r\nfor (i = 0; i < ARRAY_SIZE(gprvals); i++) {\r\nif (gprval == gprvals[i]) {\r\nregmap_update_bits(gpr, IOMUXC_GPR1, 0xfff, gprval);\r\nreturn 0;\r\n}\r\n}\r\nerr:\r\ndev_err(&pdev->dev, "Invalid 'ranges' configuration\n");\r\nreturn -EINVAL;\r\n}\r\nstatic int __init weim_timing_setup(struct device_node *np, void __iomem *base,\r\nconst struct imx_weim_devtype *devtype)\r\n{\r\nu32 cs_idx, value[devtype->cs_regs_count];\r\nint i, ret;\r\nret = of_property_read_u32(np, "reg", &cs_idx);\r\nif (ret)\r\nreturn ret;\r\nif (cs_idx >= devtype->cs_count)\r\nreturn -EINVAL;\r\nret = of_property_read_u32_array(np, "fsl,weim-cs-timing",\r\nvalue, devtype->cs_regs_count);\r\nif (ret)\r\nreturn ret;\r\nfor (i = 0; i < devtype->cs_regs_count; i++)\r\nwritel(value[i], base + cs_idx * devtype->cs_stride + i * 4);\r\nreturn 0;\r\n}\r\nstatic int __init weim_parse_dt(struct platform_device *pdev,\r\nvoid __iomem *base)\r\n{\r\nconst struct of_device_id *of_id = of_match_device(weim_id_table,\r\n&pdev->dev);\r\nconst struct imx_weim_devtype *devtype = of_id->data;\r\nstruct device_node *child;\r\nint ret;\r\nif (devtype == &imx50_weim_devtype) {\r\nret = imx_weim_gpr_setup(pdev);\r\nif (ret)\r\nreturn ret;\r\n}\r\nfor_each_child_of_node(pdev->dev.of_node, child) {\r\nif (!child->name)\r\ncontinue;\r\nret = weim_timing_setup(child, base, devtype);\r\nif (ret) {\r\ndev_err(&pdev->dev, "%s set timing failed.\n",\r\nchild->full_name);\r\nreturn ret;\r\n}\r\n}\r\nret = of_platform_populate(pdev->dev.of_node, NULL, NULL, &pdev->dev);\r\nif (ret)\r\ndev_err(&pdev->dev, "%s fail to create devices.\n",\r\npdev->dev.of_node->full_name);\r\nreturn ret;\r\n}\r\nstatic int __init weim_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct clk *clk;\r\nvoid __iomem *base;\r\nint ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk))\r\nreturn PTR_ERR(clk);\r\nret = clk_prepare_enable(clk);\r\nif (ret)\r\nreturn ret;\r\nret = weim_parse_dt(pdev, base);\r\nif (ret)\r\nclk_disable_unprepare(clk);\r\nelse\r\ndev_info(&pdev->dev, "Driver registered.\n");\r\nreturn ret;\r\n}

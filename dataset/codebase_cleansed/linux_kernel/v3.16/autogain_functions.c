int gspca_expo_autogain(\r\nstruct gspca_dev *gspca_dev,\r\nint avg_lum,\r\nint desired_avg_lum,\r\nint deadzone,\r\nint gain_knee,\r\nint exposure_knee)\r\n{\r\ns32 gain, orig_gain, exposure, orig_exposure;\r\nint i, steps, retval = 0;\r\nif (v4l2_ctrl_g_ctrl(gspca_dev->autogain) == 0)\r\nreturn 0;\r\norig_gain = gain = v4l2_ctrl_g_ctrl(gspca_dev->gain);\r\norig_exposure = exposure = v4l2_ctrl_g_ctrl(gspca_dev->exposure);\r\nsteps = abs(desired_avg_lum - avg_lum) / deadzone;\r\nPDEBUG(D_FRAM, "autogain: lum: %d, desired: %d, steps: %d",\r\navg_lum, desired_avg_lum, steps);\r\nfor (i = 0; i < steps; i++) {\r\nif (avg_lum > desired_avg_lum) {\r\nif (gain > gain_knee)\r\ngain--;\r\nelse if (exposure > exposure_knee)\r\nexposure--;\r\nelse if (gain > gspca_dev->gain->default_value)\r\ngain--;\r\nelse if (exposure > gspca_dev->exposure->minimum)\r\nexposure--;\r\nelse if (gain > gspca_dev->gain->minimum)\r\ngain--;\r\nelse\r\nbreak;\r\n} else {\r\nif (gain < gspca_dev->gain->default_value)\r\ngain++;\r\nelse if (exposure < exposure_knee)\r\nexposure++;\r\nelse if (gain < gain_knee)\r\ngain++;\r\nelse if (exposure < gspca_dev->exposure->maximum)\r\nexposure++;\r\nelse if (gain < gspca_dev->gain->maximum)\r\ngain++;\r\nelse\r\nbreak;\r\n}\r\n}\r\nif (gain != orig_gain) {\r\nv4l2_ctrl_s_ctrl(gspca_dev->gain, gain);\r\nretval = 1;\r\n}\r\nif (exposure != orig_exposure) {\r\nv4l2_ctrl_s_ctrl(gspca_dev->exposure, exposure);\r\nretval = 1;\r\n}\r\nif (retval)\r\nPDEBUG(D_FRAM, "autogain: changed gain: %d, expo: %d",\r\ngain, exposure);\r\nreturn retval;\r\n}\r\nint gspca_coarse_grained_expo_autogain(\r\nstruct gspca_dev *gspca_dev,\r\nint avg_lum,\r\nint desired_avg_lum,\r\nint deadzone)\r\n{\r\ns32 gain_low, gain_high, gain, orig_gain, exposure, orig_exposure;\r\nint steps, retval = 0;\r\nif (v4l2_ctrl_g_ctrl(gspca_dev->autogain) == 0)\r\nreturn 0;\r\norig_gain = gain = v4l2_ctrl_g_ctrl(gspca_dev->gain);\r\norig_exposure = exposure = v4l2_ctrl_g_ctrl(gspca_dev->exposure);\r\ngain_low = (gspca_dev->gain->maximum - gspca_dev->gain->minimum) /\r\n5 * 2 + gspca_dev->gain->minimum;\r\ngain_high = (gspca_dev->gain->maximum - gspca_dev->gain->minimum) /\r\n5 * 4 + gspca_dev->gain->minimum;\r\nsteps = (desired_avg_lum - avg_lum) / deadzone;\r\nPDEBUG(D_FRAM, "autogain: lum: %d, desired: %d, steps: %d",\r\navg_lum, desired_avg_lum, steps);\r\nif ((gain + steps) > gain_high &&\r\nexposure < gspca_dev->exposure->maximum) {\r\ngain = gain_high;\r\ngspca_dev->exp_too_low_cnt++;\r\ngspca_dev->exp_too_high_cnt = 0;\r\n} else if ((gain + steps) < gain_low &&\r\nexposure > gspca_dev->exposure->minimum) {\r\ngain = gain_low;\r\ngspca_dev->exp_too_high_cnt++;\r\ngspca_dev->exp_too_low_cnt = 0;\r\n} else {\r\ngain += steps;\r\nif (gain > gspca_dev->gain->maximum)\r\ngain = gspca_dev->gain->maximum;\r\nelse if (gain < gspca_dev->gain->minimum)\r\ngain = gspca_dev->gain->minimum;\r\ngspca_dev->exp_too_high_cnt = 0;\r\ngspca_dev->exp_too_low_cnt = 0;\r\n}\r\nif (gspca_dev->exp_too_high_cnt > 3) {\r\nexposure--;\r\ngspca_dev->exp_too_high_cnt = 0;\r\n} else if (gspca_dev->exp_too_low_cnt > 3) {\r\nexposure++;\r\ngspca_dev->exp_too_low_cnt = 0;\r\n}\r\nif (gain != orig_gain) {\r\nv4l2_ctrl_s_ctrl(gspca_dev->gain, gain);\r\nretval = 1;\r\n}\r\nif (exposure != orig_exposure) {\r\nv4l2_ctrl_s_ctrl(gspca_dev->exposure, exposure);\r\nretval = 1;\r\n}\r\nif (retval)\r\nPDEBUG(D_FRAM, "autogain: changed gain: %d, expo: %d",\r\ngain, exposure);\r\nreturn retval;\r\n}

static int tegra_ion_probe(struct platform_device *pdev)\r\n{\r\nstruct ion_platform_data *pdata = pdev->dev.platform_data;\r\nint err;\r\nint i;\r\nnum_heaps = pdata->nr;\r\nheaps = devm_kzalloc(&pdev->dev,\r\nsizeof(struct ion_heap *) * pdata->nr,\r\nGFP_KERNEL);\r\nidev = ion_device_create(NULL);\r\nif (IS_ERR_OR_NULL(idev))\r\nreturn PTR_ERR(idev);\r\nfor (i = 0; i < num_heaps; i++) {\r\nstruct ion_platform_heap *heap_data = &pdata->heaps[i];\r\nheaps[i] = ion_heap_create(heap_data);\r\nif (IS_ERR_OR_NULL(heaps[i])) {\r\nerr = PTR_ERR(heaps[i]);\r\ngoto err;\r\n}\r\nion_device_add_heap(idev, heaps[i]);\r\n}\r\nplatform_set_drvdata(pdev, idev);\r\nreturn 0;\r\nerr:\r\nfor (i = 0; i < num_heaps; i++) {\r\nif (heaps[i])\r\nion_heap_destroy(heaps[i]);\r\n}\r\nreturn err;\r\n}\r\nstatic int tegra_ion_remove(struct platform_device *pdev)\r\n{\r\nstruct ion_device *idev = platform_get_drvdata(pdev);\r\nint i;\r\nion_device_destroy(idev);\r\nfor (i = 0; i < num_heaps; i++)\r\nion_heap_destroy(heaps[i]);\r\nreturn 0;\r\n}

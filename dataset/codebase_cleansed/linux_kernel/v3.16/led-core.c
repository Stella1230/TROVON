static void led_set_software_blink(struct led_classdev *led_cdev,\r\nunsigned long delay_on,\r\nunsigned long delay_off)\r\n{\r\nint current_brightness;\r\ncurrent_brightness = led_get_brightness(led_cdev);\r\nif (current_brightness)\r\nled_cdev->blink_brightness = current_brightness;\r\nif (!led_cdev->blink_brightness)\r\nled_cdev->blink_brightness = led_cdev->max_brightness;\r\nled_cdev->blink_delay_on = delay_on;\r\nled_cdev->blink_delay_off = delay_off;\r\nif (!delay_on) {\r\n__led_set_brightness(led_cdev, LED_OFF);\r\nreturn;\r\n}\r\nif (!delay_off) {\r\n__led_set_brightness(led_cdev, led_cdev->blink_brightness);\r\nreturn;\r\n}\r\nmod_timer(&led_cdev->blink_timer, jiffies + 1);\r\n}\r\nstatic void led_blink_setup(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nif (!(led_cdev->flags & LED_BLINK_ONESHOT) &&\r\nled_cdev->blink_set &&\r\n!led_cdev->blink_set(led_cdev, delay_on, delay_off))\r\nreturn;\r\nif (!*delay_on && !*delay_off)\r\n*delay_on = *delay_off = 500;\r\nled_set_software_blink(led_cdev, *delay_on, *delay_off);\r\n}\r\nvoid led_blink_set(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\ndel_timer_sync(&led_cdev->blink_timer);\r\nled_cdev->flags &= ~LED_BLINK_ONESHOT;\r\nled_cdev->flags &= ~LED_BLINK_ONESHOT_STOP;\r\nled_blink_setup(led_cdev, delay_on, delay_off);\r\n}\r\nvoid led_blink_set_oneshot(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off,\r\nint invert)\r\n{\r\nif ((led_cdev->flags & LED_BLINK_ONESHOT) &&\r\ntimer_pending(&led_cdev->blink_timer))\r\nreturn;\r\nled_cdev->flags |= LED_BLINK_ONESHOT;\r\nled_cdev->flags &= ~LED_BLINK_ONESHOT_STOP;\r\nif (invert)\r\nled_cdev->flags |= LED_BLINK_INVERT;\r\nelse\r\nled_cdev->flags &= ~LED_BLINK_INVERT;\r\nled_blink_setup(led_cdev, delay_on, delay_off);\r\n}\r\nvoid led_stop_software_blink(struct led_classdev *led_cdev)\r\n{\r\ndel_timer_sync(&led_cdev->blink_timer);\r\nled_cdev->blink_delay_on = 0;\r\nled_cdev->blink_delay_off = 0;\r\n}\r\nvoid led_set_brightness(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nif (led_cdev->blink_delay_on || led_cdev->blink_delay_off) {\r\nled_cdev->delayed_set_value = brightness;\r\nschedule_work(&led_cdev->set_brightness_work);\r\nreturn;\r\n}\r\n__led_set_brightness(led_cdev, brightness);\r\n}

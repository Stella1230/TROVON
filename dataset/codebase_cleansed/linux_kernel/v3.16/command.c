int get_card_from_id(int driver)\r\n{\r\nint i;\r\nfor (i = 0; i < cinst; i++) {\r\nif (sc_adapter[i]->driverId == driver)\r\nreturn i;\r\n}\r\nreturn -ENODEV;\r\n}\r\nint command(isdn_ctrl *cmd)\r\n{\r\nint card;\r\ncard = get_card_from_id(cmd->driver);\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nswitch (cmd->command) {\r\ncase ISDN_CMD_IOCTL:\r\n{\r\nunsigned long cmdptr;\r\nscs_ioctl ioc;\r\nmemcpy(&cmdptr, cmd->parm.num, sizeof(unsigned long));\r\nif (copy_from_user(&ioc, (scs_ioctl __user *)cmdptr,\r\nsizeof(scs_ioctl))) {\r\npr_debug("%s: Failed to verify user space 0x%lx\n",\r\nsc_adapter[card]->devicename, cmdptr);\r\nreturn -EFAULT;\r\n}\r\nreturn sc_ioctl(card, &ioc);\r\n}\r\ncase ISDN_CMD_DIAL:\r\nreturn dial(card, cmd->arg, cmd->parm.setup);\r\ncase ISDN_CMD_HANGUP:\r\nreturn hangup(card, cmd->arg);\r\ncase ISDN_CMD_ACCEPTD:\r\nreturn answer(card, cmd->arg);\r\ncase ISDN_CMD_ACCEPTB:\r\nreturn acceptb(card, cmd->arg);\r\ncase ISDN_CMD_CLREAZ:\r\nreturn clreaz(card, cmd->arg);\r\ncase ISDN_CMD_SETEAZ:\r\nreturn seteaz(card, cmd->arg, cmd->parm.num);\r\ncase ISDN_CMD_SETL2:\r\nreturn setl2(card, cmd->arg);\r\ncase ISDN_CMD_SETL3:\r\nreturn setl3(card, cmd->arg);\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nint startproc(int card)\r\n{\r\nint status;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nstatus = sendmessage(card, CMPID, cmReqType2,\r\ncmReqClass0,\r\ncmReqStartProc,\r\n0, 0, NULL);\r\npr_debug("%s: Sent startProc\n", sc_adapter[card]->devicename);\r\nreturn status;\r\n}\r\nstatic int dial(int card, unsigned long channel, setup_parm setup)\r\n{\r\nint status;\r\nchar Phone[48];\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nstrcpy(Phone, setup.phone);\r\nstatus = sendmessage(card, CEPID, ceReqTypePhy,\r\nceReqClass1,\r\nceReqPhyConnect,\r\n(unsigned char)channel + 1,\r\nstrlen(Phone),\r\n(unsigned int *)Phone);\r\npr_debug("%s: Dialing %s on channel %lu\n",\r\nsc_adapter[card]->devicename, Phone, channel + 1);\r\nreturn status;\r\n}\r\nstatic int answer(int card, unsigned long channel)\r\n{\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nif (setup_buffers(card, channel + 1)) {\r\nhangup(card, channel + 1);\r\nreturn -ENOBUFS;\r\n}\r\nindicate_status(card, ISDN_STAT_BCONN, channel, NULL);\r\npr_debug("%s: Answered incoming call on channel %lu\n",\r\nsc_adapter[card]->devicename, channel + 1);\r\nreturn 0;\r\n}\r\nstatic int hangup(int card, unsigned long channel)\r\n{\r\nint status;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nstatus = sendmessage(card, CEPID, ceReqTypePhy,\r\nceReqClass1,\r\nceReqPhyDisconnect,\r\n(unsigned char)channel + 1,\r\n0,\r\nNULL);\r\npr_debug("%s: Sent HANGUP message to channel %lu\n",\r\nsc_adapter[card]->devicename, channel + 1);\r\nreturn status;\r\n}\r\nstatic int setl2(int card, unsigned long arg)\r\n{\r\nint status = 0;\r\nint protocol, channel;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nprotocol = arg >> 8;\r\nchannel = arg & 0xff;\r\nsc_adapter[card]->channel[channel].l2_proto = protocol;\r\npr_debug("%s: Sending GetFrameFormat for channel %d\n",\r\nsc_adapter[card]->devicename, channel + 1);\r\nstatus = sendmessage(card, CEPID, ceReqTypeCall,\r\nceReqClass0,\r\nceReqCallGetFrameFormat,\r\n(unsigned char)channel + 1,\r\n1,\r\n(unsigned int *)protocol);\r\nif (status)\r\nreturn status;\r\nreturn 0;\r\n}\r\nstatic int setl3(int card, unsigned long channel)\r\n{\r\nint protocol = channel >> 8;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nsc_adapter[card]->channel[channel].l3_proto = protocol;\r\nreturn 0;\r\n}\r\nstatic int acceptb(int card, unsigned long channel)\r\n{\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nif (setup_buffers(card, channel + 1))\r\n{\r\nhangup(card, channel + 1);\r\nreturn -ENOBUFS;\r\n}\r\npr_debug("%s: B-Channel connection accepted on channel %lu\n",\r\nsc_adapter[card]->devicename, channel + 1);\r\nindicate_status(card, ISDN_STAT_BCONN, channel, NULL);\r\nreturn 0;\r\n}\r\nstatic int clreaz(int card, unsigned long arg)\r\n{\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nstrcpy(sc_adapter[card]->channel[arg].eazlist, "");\r\nsc_adapter[card]->channel[arg].eazclear = 1;\r\npr_debug("%s: EAZ List cleared for channel %lu\n",\r\nsc_adapter[card]->devicename, arg + 1);\r\nreturn 0;\r\n}\r\nstatic int seteaz(int card, unsigned long arg, char *num)\r\n{\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nstrcpy(sc_adapter[card]->channel[arg].eazlist, num);\r\nsc_adapter[card]->channel[arg].eazclear = 0;\r\npr_debug("%s: EAZ list for channel %lu set to: %s\n",\r\nsc_adapter[card]->devicename, arg + 1,\r\nsc_adapter[card]->channel[arg].eazlist);\r\nreturn 0;\r\n}\r\nint reset(int card)\r\n{\r\nunsigned long flags;\r\nif (!IS_VALID_CARD(card)) {\r\npr_debug("Invalid param: %d is not a valid card id\n", card);\r\nreturn -ENODEV;\r\n}\r\nindicate_status(card, ISDN_STAT_STOP, 0, NULL);\r\nif (sc_adapter[card]->EngineUp) {\r\ndel_timer(&sc_adapter[card]->stat_timer);\r\n}\r\nsc_adapter[card]->EngineUp = 0;\r\nspin_lock_irqsave(&sc_adapter[card]->lock, flags);\r\ninit_timer(&sc_adapter[card]->reset_timer);\r\nsc_adapter[card]->reset_timer.function = sc_check_reset;\r\nsc_adapter[card]->reset_timer.data = card;\r\nsc_adapter[card]->reset_timer.expires = jiffies + CHECKRESET_TIME;\r\nadd_timer(&sc_adapter[card]->reset_timer);\r\nspin_unlock_irqrestore(&sc_adapter[card]->lock, flags);\r\noutb(0x1, sc_adapter[card]->ioport[SFT_RESET]);\r\npr_debug("%s: Adapter Reset\n", sc_adapter[card]->devicename);\r\nreturn 0;\r\n}\r\nvoid flushreadfifo(int card)\r\n{\r\nwhile (inb(sc_adapter[card]->ioport[FIFO_STATUS]) & RF_HAS_DATA)\r\ninb(sc_adapter[card]->ioport[FIFO_READ]);\r\n}

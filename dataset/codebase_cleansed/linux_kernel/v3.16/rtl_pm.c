int rtl8192E_save_state(struct pci_dev *dev, pm_message_t state)\r\n{\r\nprintk(KERN_NOTICE "r8192E save state call (state %u).\n", state.event);\r\nreturn -EAGAIN;\r\n}\r\nint rtl8192E_suspend(struct pci_dev *pdev, pm_message_t state)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nu32 ulRegRead;\r\nprintk(KERN_INFO "============> r8192E suspend call.\n");\r\ndel_timer_sync(&priv->gpio_polling_timer);\r\ncancel_delayed_work(&priv->gpio_change_rf_wq);\r\npriv->polling_timer_on = 0;\r\nif (!netif_running(dev)) {\r\nprintk(KERN_INFO "RTL819XE:UI is open out of suspend "\r\n"function\n");\r\ngoto out_pci_suspend;\r\n}\r\nif (dev->netdev_ops->ndo_stop)\r\ndev->netdev_ops->ndo_stop(dev);\r\nnetif_device_detach(dev);\r\nif (!priv->rtllib->bSupportRemoteWakeUp) {\r\nMgntActSet_RF_State(dev, eRfOff, RF_CHANGE_BY_INIT, true);\r\nulRegRead = read_nic_dword(dev, CPU_GEN);\r\nulRegRead |= CPU_GEN_SYSTEM_RESET;\r\nwrite_nic_dword(dev, CPU_GEN, ulRegRead);\r\n} else {\r\nwrite_nic_dword(dev, WFCRC0, 0xffffffff);\r\nwrite_nic_dword(dev, WFCRC1, 0xffffffff);\r\nwrite_nic_dword(dev, WFCRC2, 0xffffffff);\r\nwrite_nic_byte(dev, PMR, 0x5);\r\nwrite_nic_byte(dev, MacBlkCtrl, 0xa);\r\n}\r\nout_pci_suspend:\r\nprintk("r8192E support WOL call??????????????????????\n");\r\nif (priv->rtllib->bSupportRemoteWakeUp)\r\nRT_TRACE(COMP_POWER, "r8192E support WOL call!!!!!!!"\r\n"!!!!!!!!!!!.\n");\r\npci_save_state(pdev);\r\npci_disable_device(pdev);\r\npci_enable_wake(pdev, pci_choose_state(pdev, state),\r\npriv->rtllib->bSupportRemoteWakeUp ? 1 : 0);\r\npci_set_power_state(pdev, pci_choose_state(pdev, state));\r\nmdelay(20);\r\nreturn 0;\r\n}\r\nint rtl8192E_resume(struct pci_dev *pdev)\r\n{\r\nstruct net_device *dev = pci_get_drvdata(pdev);\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nint err;\r\nu32 val;\r\nprintk(KERN_INFO "================>r8192E resume call.\n");\r\npci_set_power_state(pdev, PCI_D0);\r\nerr = pci_enable_device(pdev);\r\nif (err) {\r\nprintk(KERN_ERR "%s: pci_enable_device failed on resume\n",\r\ndev->name);\r\nreturn err;\r\n}\r\npci_restore_state(pdev);\r\npci_read_config_dword(pdev, 0x40, &val);\r\nif ((val & 0x0000ff00) != 0)\r\npci_write_config_dword(pdev, 0x40, val & 0xffff00ff);\r\npci_enable_wake(pdev, PCI_D0, 0);\r\nif (priv->polling_timer_on == 0)\r\ncheck_rfctrl_gpio_timer((unsigned long)dev);\r\nif (!netif_running(dev)) {\r\nprintk(KERN_INFO "RTL819XE:UI is open out of resume "\r\n"function\n");\r\ngoto out;\r\n}\r\nnetif_device_attach(dev);\r\nif (dev->netdev_ops->ndo_open)\r\ndev->netdev_ops->ndo_open(dev);\r\nif (!priv->rtllib->bSupportRemoteWakeUp)\r\nMgntActSet_RF_State(dev, eRfOn, RF_CHANGE_BY_INIT, true);\r\nout:\r\nRT_TRACE(COMP_POWER, "<================r8192E resume call.\n");\r\nreturn 0;\r\n}\r\nint rtl8192E_enable_wake(struct pci_dev *dev, pm_message_t state, int enable)\r\n{\r\nprintk(KERN_NOTICE "r8192E enable wake call (state %u, enable %d).\n",\r\nstate.event, enable);\r\nreturn -EAGAIN;\r\n}

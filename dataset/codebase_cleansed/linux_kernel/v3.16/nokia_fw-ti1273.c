void hci_h4p_ti1273_parse_fw_event(struct hci_h4p_info *info,\r\nstruct sk_buff *skb)\r\n{\r\nstruct sk_buff *fw_skb;\r\nunsigned long flags;\r\nif (skb->data[5] != 0x00) {\r\ndev_err(info->dev, "Firmware sending command failed 0x%.2x\n",\r\nskb->data[5]);\r\ninfo->fw_error = -EPROTO;\r\n}\r\nkfree_skb(skb);\r\nfw_skb = skb_dequeue(fw_q);\r\nif (fw_skb == NULL || info->fw_error) {\r\ncomplete(&info->fw_completion);\r\nreturn;\r\n}\r\nskb_queue_tail(&info->txq, fw_skb);\r\nspin_lock_irqsave(&info->lock, flags);\r\nhci_h4p_outb(info, UART_IER, hci_h4p_inb(info, UART_IER) |\r\nUART_IER_THRI);\r\nspin_unlock_irqrestore(&info->lock, flags);\r\n}\r\nint hci_h4p_ti1273_send_fw(struct hci_h4p_info *info,\r\nstruct sk_buff_head *fw_queue)\r\n{\r\nstruct sk_buff *skb;\r\nunsigned long flags, time;\r\ninfo->fw_error = 0;\r\nBT_DBG("Sending firmware");\r\ntime = jiffies;\r\nfw_q = fw_queue;\r\nskb = skb_dequeue(fw_queue);\r\nif (!skb)\r\nreturn -ENODATA;\r\nBT_DBG("Sending commands");\r\ninit_completion(&info->fw_completion);\r\nhci_h4p_smart_idle(info, 0);\r\nskb_queue_tail(&info->txq, skb);\r\nspin_lock_irqsave(&info->lock, flags);\r\nhci_h4p_outb(info, UART_IER, hci_h4p_inb(info, UART_IER) |\r\nUART_IER_THRI);\r\nspin_unlock_irqrestore(&info->lock, flags);\r\nif (!wait_for_completion_timeout(&info->fw_completion,\r\nmsecs_to_jiffies(2000))) {\r\ndev_err(info->dev, "No reply to fw command\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nif (info->fw_error) {\r\ndev_err(info->dev, "FW error\n");\r\nreturn -EPROTO;\r\n}\r\nBT_DBG("Firmware sent in %d msecs",\r\njiffies_to_msecs(jiffies-time));\r\nhci_h4p_set_auto_ctsrts(info, 0, UART_EFR_RTS);\r\nhci_h4p_set_rts(info, 0);\r\nhci_h4p_change_speed(info, BC4_MAX_BAUD_RATE);\r\nif (hci_h4p_wait_for_cts(info, 1, 100)) {\r\ndev_err(info->dev,\r\n"cts didn't go down after final speed change\n");\r\nreturn -ETIMEDOUT;\r\n}\r\nhci_h4p_set_auto_ctsrts(info, 1, UART_EFR_RTS);\r\nreturn 0;\r\n}

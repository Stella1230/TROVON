static inline void tauros2_clean_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c7, c11, 3" : : "r" (addr));\r\n}\r\nstatic inline void tauros2_clean_inv_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c7, c15, 3" : : "r" (addr));\r\n}\r\nstatic inline void tauros2_inv_pa(unsigned long addr)\r\n{\r\n__asm__("mcr p15, 1, %0, c7, c7, 3" : : "r" (addr));\r\n}\r\nstatic void tauros2_inv_range(unsigned long start, unsigned long end)\r\n{\r\nif (start & (CACHE_LINE_SIZE - 1)) {\r\ntauros2_clean_inv_pa(start & ~(CACHE_LINE_SIZE - 1));\r\nstart = (start | (CACHE_LINE_SIZE - 1)) + 1;\r\n}\r\nif (end & (CACHE_LINE_SIZE - 1)) {\r\ntauros2_clean_inv_pa(end & ~(CACHE_LINE_SIZE - 1));\r\nend &= ~(CACHE_LINE_SIZE - 1);\r\n}\r\nwhile (start < end) {\r\ntauros2_inv_pa(start);\r\nstart += CACHE_LINE_SIZE;\r\n}\r\ndsb();\r\n}\r\nstatic void tauros2_clean_range(unsigned long start, unsigned long end)\r\n{\r\nstart &= ~(CACHE_LINE_SIZE - 1);\r\nwhile (start < end) {\r\ntauros2_clean_pa(start);\r\nstart += CACHE_LINE_SIZE;\r\n}\r\ndsb();\r\n}\r\nstatic void tauros2_flush_range(unsigned long start, unsigned long end)\r\n{\r\nstart &= ~(CACHE_LINE_SIZE - 1);\r\nwhile (start < end) {\r\ntauros2_clean_inv_pa(start);\r\nstart += CACHE_LINE_SIZE;\r\n}\r\ndsb();\r\n}\r\nstatic void tauros2_disable(void)\r\n{\r\n__asm__ __volatile__ (\r\n"mcr p15, 1, %0, c7, c11, 0 @L2 Cache Clean All\n\t"\r\n"mrc p15, 0, %0, c1, c0, 0\n\t"\r\n"bic %0, %0, #(1 << 26)\n\t"\r\n"mcr p15, 0, %0, c1, c0, 0 @Disable L2 Cache\n\t"\r\n: : "r" (0x0));\r\n}\r\nstatic void tauros2_resume(void)\r\n{\r\n__asm__ __volatile__ (\r\n"mcr p15, 1, %0, c7, c7, 0 @L2 Cache Invalidate All\n\t"\r\n"mrc p15, 0, %0, c1, c0, 0\n\t"\r\n"orr %0, %0, #(1 << 26)\n\t"\r\n"mcr p15, 0, %0, c1, c0, 0 @Enable L2 Cache\n\t"\r\n: : "r" (0x0));\r\n}\r\nstatic inline u32 __init read_extra_features(void)\r\n{\r\nu32 u;\r\n__asm__("mrc p15, 1, %0, c15, c1, 0" : "=r" (u));\r\nreturn u;\r\n}\r\nstatic inline void __init write_extra_features(u32 u)\r\n{\r\n__asm__("mcr p15, 1, %0, c15, c1, 0" : : "r" (u));\r\n}\r\nstatic inline int __init cpuid_scheme(void)\r\n{\r\nreturn !!((processor_id & 0x000f0000) == 0x000f0000);\r\n}\r\nstatic inline u32 __init read_mmfr3(void)\r\n{\r\nu32 mmfr3;\r\n__asm__("mrc p15, 0, %0, c0, c1, 7\n" : "=r" (mmfr3));\r\nreturn mmfr3;\r\n}\r\nstatic inline u32 __init read_actlr(void)\r\n{\r\nu32 actlr;\r\n__asm__("mrc p15, 0, %0, c1, c0, 1\n" : "=r" (actlr));\r\nreturn actlr;\r\n}\r\nstatic inline void __init write_actlr(u32 actlr)\r\n{\r\n__asm__("mcr p15, 0, %0, c1, c0, 1\n" : : "r" (actlr));\r\n}\r\nstatic void enable_extra_feature(unsigned int features)\r\n{\r\nu32 u;\r\nu = read_extra_features();\r\nif (features & CACHE_TAUROS2_PREFETCH_ON)\r\nu &= ~0x01000000;\r\nelse\r\nu |= 0x01000000;\r\nprintk(KERN_INFO "Tauros2: %s L2 prefetch.\n",\r\n(features & CACHE_TAUROS2_PREFETCH_ON)\r\n? "Enabling" : "Disabling");\r\nif (features & CACHE_TAUROS2_LINEFILL_BURST8)\r\nu |= 0x00100000;\r\nelse\r\nu &= ~0x00100000;\r\nprintk(KERN_INFO "Tauros2: %s line fill burt8.\n",\r\n(features & CACHE_TAUROS2_LINEFILL_BURST8)\r\n? "Enabling" : "Disabling");\r\nwrite_extra_features(u);\r\n}\r\nstatic void __init tauros2_internal_init(unsigned int features)\r\n{\r\nchar *mode = NULL;\r\nenable_extra_feature(features);\r\n#ifdef CONFIG_CPU_32v5\r\nif ((processor_id & 0xff0f0000) == 0x56050000) {\r\nu32 feat;\r\nfeat = read_extra_features();\r\nif (!(feat & 0x00400000)) {\r\nprintk(KERN_INFO "Tauros2: Enabling L2 cache.\n");\r\nwrite_extra_features(feat | 0x00400000);\r\n}\r\nmode = "ARMv5";\r\nouter_cache.inv_range = tauros2_inv_range;\r\nouter_cache.clean_range = tauros2_clean_range;\r\nouter_cache.flush_range = tauros2_flush_range;\r\nouter_cache.disable = tauros2_disable;\r\nouter_cache.resume = tauros2_resume;\r\n}\r\n#endif\r\n#ifdef CONFIG_CPU_32v7\r\nif (cpuid_scheme() && (read_mmfr3() & 0xf) == 1) {\r\nu32 actlr;\r\nactlr = read_actlr();\r\nif (!(actlr & 0x00000002)) {\r\nprintk(KERN_INFO "Tauros2: Enabling L2 cache.\n");\r\nwrite_actlr(actlr | 0x00000002);\r\n}\r\nmode = "ARMv7";\r\n}\r\n#endif\r\nif (mode == NULL) {\r\nprintk(KERN_CRIT "Tauros2: Unable to detect CPU mode.\n");\r\nreturn;\r\n}\r\nprintk(KERN_INFO "Tauros2: L2 cache support initialised "\r\n"in %s mode.\n", mode);\r\n}\r\nvoid __init tauros2_init(unsigned int features)\r\n{\r\n#ifdef CONFIG_OF\r\nstruct device_node *node;\r\nint ret;\r\nunsigned int f;\r\nnode = of_find_matching_node(NULL, tauros2_ids);\r\nif (!node) {\r\npr_info("Not found marvell,tauros2-cache, disable it\n");\r\nreturn;\r\n}\r\nret = of_property_read_u32(node, "marvell,tauros2-cache-features", &f);\r\nif (ret) {\r\npr_info("Not found marvell,tauros-cache-features property, "\r\n"disable extra features\n");\r\nfeatures = 0;\r\n} else\r\nfeatures = f;\r\n#endif\r\ntauros2_internal_init(features);\r\n}

int msgdma_initialize(struct altera_tse_private *priv)\r\n{\r\nreturn 0;\r\n}\r\nvoid msgdma_uninitialize(struct altera_tse_private *priv)\r\n{\r\n}\r\nvoid msgdma_start_rxdma(struct altera_tse_private *priv)\r\n{\r\n}\r\nvoid msgdma_reset(struct altera_tse_private *priv)\r\n{\r\nint counter;\r\ncsrwr32(MSGDMA_CSR_STAT_MASK, priv->rx_dma_csr,\r\nmsgdma_csroffs(status));\r\ncsrwr32(MSGDMA_CSR_CTL_RESET, priv->rx_dma_csr,\r\nmsgdma_csroffs(control));\r\ncounter = 0;\r\nwhile (counter++ < ALTERA_TSE_SW_RESET_WATCHDOG_CNTR) {\r\nif (tse_bit_is_clear(priv->rx_dma_csr, msgdma_csroffs(status),\r\nMSGDMA_CSR_STAT_RESETTING))\r\nbreak;\r\nudelay(1);\r\n}\r\nif (counter >= ALTERA_TSE_SW_RESET_WATCHDOG_CNTR)\r\nnetif_warn(priv, drv, priv->dev,\r\n"TSE Rx mSGDMA resetting bit never cleared!\n");\r\ncsrwr32(MSGDMA_CSR_STAT_MASK, priv->rx_dma_csr, msgdma_csroffs(status));\r\ncsrwr32(MSGDMA_CSR_STAT_MASK, priv->tx_dma_csr,\r\nmsgdma_csroffs(status));\r\ncsrwr32(MSGDMA_CSR_CTL_RESET, priv->tx_dma_csr,\r\nmsgdma_csroffs(control));\r\ncounter = 0;\r\nwhile (counter++ < ALTERA_TSE_SW_RESET_WATCHDOG_CNTR) {\r\nif (tse_bit_is_clear(priv->tx_dma_csr, msgdma_csroffs(status),\r\nMSGDMA_CSR_STAT_RESETTING))\r\nbreak;\r\nudelay(1);\r\n}\r\nif (counter >= ALTERA_TSE_SW_RESET_WATCHDOG_CNTR)\r\nnetif_warn(priv, drv, priv->dev,\r\n"TSE Tx mSGDMA resetting bit never cleared!\n");\r\ncsrwr32(MSGDMA_CSR_STAT_MASK, priv->tx_dma_csr, msgdma_csroffs(status));\r\n}\r\nvoid msgdma_disable_rxirq(struct altera_tse_private *priv)\r\n{\r\ntse_clear_bit(priv->rx_dma_csr, msgdma_csroffs(control),\r\nMSGDMA_CSR_CTL_GLOBAL_INTR);\r\n}\r\nvoid msgdma_enable_rxirq(struct altera_tse_private *priv)\r\n{\r\ntse_set_bit(priv->rx_dma_csr, msgdma_csroffs(control),\r\nMSGDMA_CSR_CTL_GLOBAL_INTR);\r\n}\r\nvoid msgdma_disable_txirq(struct altera_tse_private *priv)\r\n{\r\ntse_clear_bit(priv->tx_dma_csr, msgdma_csroffs(control),\r\nMSGDMA_CSR_CTL_GLOBAL_INTR);\r\n}\r\nvoid msgdma_enable_txirq(struct altera_tse_private *priv)\r\n{\r\ntse_set_bit(priv->tx_dma_csr, msgdma_csroffs(control),\r\nMSGDMA_CSR_CTL_GLOBAL_INTR);\r\n}\r\nvoid msgdma_clear_rxirq(struct altera_tse_private *priv)\r\n{\r\ncsrwr32(MSGDMA_CSR_STAT_IRQ, priv->rx_dma_csr, msgdma_csroffs(status));\r\n}\r\nvoid msgdma_clear_txirq(struct altera_tse_private *priv)\r\n{\r\ncsrwr32(MSGDMA_CSR_STAT_IRQ, priv->tx_dma_csr, msgdma_csroffs(status));\r\n}\r\nint msgdma_tx_buffer(struct altera_tse_private *priv, struct tse_buffer *buffer)\r\n{\r\ncsrwr32(lower_32_bits(buffer->dma_addr), priv->tx_dma_desc,\r\nmsgdma_descroffs(read_addr_lo));\r\ncsrwr32(upper_32_bits(buffer->dma_addr), priv->tx_dma_desc,\r\nmsgdma_descroffs(read_addr_hi));\r\ncsrwr32(0, priv->tx_dma_desc, msgdma_descroffs(write_addr_lo));\r\ncsrwr32(0, priv->tx_dma_desc, msgdma_descroffs(write_addr_hi));\r\ncsrwr32(buffer->len, priv->tx_dma_desc, msgdma_descroffs(len));\r\ncsrwr32(0, priv->tx_dma_desc, msgdma_descroffs(burst_seq_num));\r\ncsrwr32(MSGDMA_DESC_TX_STRIDE, priv->tx_dma_desc,\r\nmsgdma_descroffs(stride));\r\ncsrwr32(MSGDMA_DESC_CTL_TX_SINGLE, priv->tx_dma_desc,\r\nmsgdma_descroffs(control));\r\nreturn 0;\r\n}\r\nu32 msgdma_tx_completions(struct altera_tse_private *priv)\r\n{\r\nu32 ready = 0;\r\nu32 inuse;\r\nu32 status;\r\ninuse = csrrd32(priv->tx_dma_csr, msgdma_csroffs(rw_fill_level))\r\n& 0xffff;\r\nif (inuse) {\r\nready = priv->tx_prod - priv->tx_cons - inuse - 1;\r\n} else {\r\nstatus = csrrd32(priv->tx_dma_csr, msgdma_csroffs(status));\r\nif (status & MSGDMA_CSR_STAT_BUSY)\r\nready = priv->tx_prod - priv->tx_cons - 1;\r\nelse\r\nready = priv->tx_prod - priv->tx_cons;\r\n}\r\nreturn ready;\r\n}\r\nvoid msgdma_add_rx_desc(struct altera_tse_private *priv,\r\nstruct tse_buffer *rxbuffer)\r\n{\r\nu32 len = priv->rx_dma_buf_sz;\r\ndma_addr_t dma_addr = rxbuffer->dma_addr;\r\nu32 control = (MSGDMA_DESC_CTL_END_ON_EOP\r\n| MSGDMA_DESC_CTL_END_ON_LEN\r\n| MSGDMA_DESC_CTL_TR_COMP_IRQ\r\n| MSGDMA_DESC_CTL_EARLY_IRQ\r\n| MSGDMA_DESC_CTL_TR_ERR_IRQ\r\n| MSGDMA_DESC_CTL_GO);\r\ncsrwr32(0, priv->rx_dma_desc, msgdma_descroffs(read_addr_lo));\r\ncsrwr32(0, priv->rx_dma_desc, msgdma_descroffs(read_addr_hi));\r\ncsrwr32(lower_32_bits(dma_addr), priv->rx_dma_desc,\r\nmsgdma_descroffs(write_addr_lo));\r\ncsrwr32(upper_32_bits(dma_addr), priv->rx_dma_desc,\r\nmsgdma_descroffs(write_addr_hi));\r\ncsrwr32(len, priv->rx_dma_desc, msgdma_descroffs(len));\r\ncsrwr32(0, priv->rx_dma_desc, msgdma_descroffs(burst_seq_num));\r\ncsrwr32(0x00010001, priv->rx_dma_desc, msgdma_descroffs(stride));\r\ncsrwr32(control, priv->rx_dma_desc, msgdma_descroffs(control));\r\n}\r\nu32 msgdma_rx_status(struct altera_tse_private *priv)\r\n{\r\nu32 rxstatus = 0;\r\nu32 pktlength;\r\nu32 pktstatus;\r\nif (csrrd32(priv->rx_dma_csr, msgdma_csroffs(resp_fill_level))\r\n& 0xffff) {\r\npktlength = csrrd32(priv->rx_dma_resp,\r\nmsgdma_respoffs(bytes_transferred));\r\npktstatus = csrrd32(priv->rx_dma_resp,\r\nmsgdma_respoffs(status));\r\nrxstatus = pktstatus;\r\nrxstatus = rxstatus << 16;\r\nrxstatus |= (pktlength & 0xffff);\r\n}\r\nreturn rxstatus;\r\n}

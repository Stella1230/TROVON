long nf_get_id(const char *feature_name)\r\n{\r\nchar name_copy[32];\r\nsize_t n;\r\nn = strlcpy(name_copy, feature_name, sizeof(name_copy));\r\nif (n >= sizeof(name_copy))\r\nreturn 0;\r\nreturn nf_get_id_phys(virt_to_phys(name_copy));\r\n}\r\nvoid nfprint(const char *fmt, ...)\r\n{\r\nstatic char buf[256];\r\nva_list ap;\r\nint n;\r\nva_start(ap, fmt);\r\nn = vsnprintf(buf, 256, fmt, ap);\r\nnf_call(nf_get_id("NF_STDERR"), virt_to_phys(buf));\r\nva_end(ap);\r\n}\r\nstatic void nf_poweroff(void)\r\n{\r\nlong id = nf_get_id("NF_SHUTDOWN");\r\nif (id)\r\nnf_call(id);\r\n}\r\nvoid __init nf_init(void)\r\n{\r\nunsigned long id, version;\r\nchar buf[256];\r\nid = nf_get_id("NF_VERSION");\r\nif (!id)\r\nreturn;\r\nversion = nf_call(id);\r\nid = nf_get_id("NF_NAME");\r\nif (!id)\r\nreturn;\r\nnf_call(id, virt_to_phys(buf), 256);\r\nbuf[255] = 0;\r\npr_info("NatFeats found (%s, %lu.%lu)\n", buf, version >> 16,\r\nversion & 0xffff);\r\nmach_power_off = nf_poweroff;\r\n}

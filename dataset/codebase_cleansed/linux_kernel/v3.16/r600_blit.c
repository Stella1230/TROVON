static __pure uint32_t int2float(uint32_t x)\r\n{\r\nuint32_t msb, exponent, fraction;\r\nif (!x) return 0;\r\nmsb = __fls(x);\r\nfraction = ror32(x, (msb - I2F_FRAC_BITS) & 0x1f) & I2F_MASK;\r\nexponent = (127 + msb) << I2F_FRAC_BITS;\r\nreturn fraction + exponent;\r\n}\r\nstatic void\r\nset_render_target(drm_radeon_private_t *dev_priv, int format, int w, int h, u64 gpu_addr)\r\n{\r\nu32 cb_color_info;\r\nint pitch, slice;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nh = ALIGN(h, 8);\r\nif (h < 8)\r\nh = 8;\r\ncb_color_info = ((format << 2) | (1 << 27));\r\npitch = (w / 8) - 1;\r\nslice = ((w * h) / 64) - 1;\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) > CHIP_R600) &&\r\n((dev_priv->flags & RADEON_FAMILY_MASK) < CHIP_RV770)) {\r\nBEGIN_RING(21 + 2);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_BASE - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(gpu_addr >> 8);\r\nOUT_RING(CP_PACKET3(R600_IT_SURFACE_BASE_UPDATE, 0));\r\nOUT_RING(2 << 0);\r\n} else {\r\nBEGIN_RING(21);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_BASE - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(gpu_addr >> 8);\r\n}\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_SIZE - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING((pitch << 0) | (slice << 10));\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_VIEW - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(0);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_INFO - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(cb_color_info);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_TILE - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(0);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_FRAG - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(0);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_CB_COLOR0_MASK - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(0);\r\nADVANCE_RING();\r\n}\r\nstatic void\r\ncp_set_surface_sync(drm_radeon_private_t *dev_priv,\r\nu32 sync_type, u32 size, u64 mc_addr)\r\n{\r\nu32 cp_coher_size;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nif (size == 0xffffffff)\r\ncp_coher_size = 0xffffffff;\r\nelse\r\ncp_coher_size = ((size + 255) >> 8);\r\nBEGIN_RING(5);\r\nOUT_RING(CP_PACKET3(R600_IT_SURFACE_SYNC, 3));\r\nOUT_RING(sync_type);\r\nOUT_RING(cp_coher_size);\r\nOUT_RING((mc_addr >> 8));\r\nOUT_RING(10);\r\nADVANCE_RING();\r\n}\r\nstatic void\r\nset_shaders(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nu64 gpu_addr;\r\nint i;\r\nu32 *vs, *ps;\r\nuint32_t sq_pgm_resources;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nvs = (u32 *) ((char *)dev->agp_buffer_map->handle + dev_priv->blit_vb->offset);\r\nps = (u32 *) ((char *)dev->agp_buffer_map->handle + dev_priv->blit_vb->offset + 256);\r\nfor (i = 0; i < r6xx_vs_size; i++)\r\nvs[i] = cpu_to_le32(r6xx_vs[i]);\r\nfor (i = 0; i < r6xx_ps_size; i++)\r\nps[i] = cpu_to_le32(r6xx_ps[i]);\r\ndev_priv->blit_vb->used = 512;\r\ngpu_addr = dev_priv->gart_buffers_offset + dev_priv->blit_vb->offset;\r\nsq_pgm_resources = (1 << 0);\r\nBEGIN_RING(9 + 12);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_START_VS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(gpu_addr >> 8);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_RESOURCES_VS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(sq_pgm_resources);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_CF_OFFSET_VS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(0);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_START_PS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING((gpu_addr + 256) >> 8);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_RESOURCES_PS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(sq_pgm_resources | (1 << 28));\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_EXPORTS_PS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(2);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 1));\r\nOUT_RING((R600_SQ_PGM_CF_OFFSET_PS - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING(0);\r\nADVANCE_RING();\r\ncp_set_surface_sync(dev_priv,\r\nR600_SH_ACTION_ENA, 512, gpu_addr);\r\n}\r\nstatic void\r\nset_vtx_resource(drm_radeon_private_t *dev_priv, u64 gpu_addr)\r\n{\r\nuint32_t sq_vtx_constant_word2;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nsq_vtx_constant_word2 = (((gpu_addr >> 32) & 0xff) | (16 << 8));\r\n#ifdef __BIG_ENDIAN\r\nsq_vtx_constant_word2 |= (2 << 30);\r\n#endif\r\nBEGIN_RING(9);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_RESOURCE, 7));\r\nOUT_RING(0x460);\r\nOUT_RING(gpu_addr & 0xffffffff);\r\nOUT_RING(48 - 1);\r\nOUT_RING(sq_vtx_constant_word2);\r\nOUT_RING(1 << 0);\r\nOUT_RING(0);\r\nOUT_RING(0);\r\nOUT_RING(R600_SQ_TEX_VTX_VALID_BUFFER << 30);\r\nADVANCE_RING();\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV610) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV620) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS780) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS880) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV710))\r\ncp_set_surface_sync(dev_priv,\r\nR600_TC_ACTION_ENA, 48, gpu_addr);\r\nelse\r\ncp_set_surface_sync(dev_priv,\r\nR600_VC_ACTION_ENA, 48, gpu_addr);\r\n}\r\nstatic void\r\nset_tex_resource(drm_radeon_private_t *dev_priv,\r\nint format, int w, int h, int pitch, u64 gpu_addr)\r\n{\r\nuint32_t sq_tex_resource_word0, sq_tex_resource_word1, sq_tex_resource_word4;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nif (h < 1)\r\nh = 1;\r\nsq_tex_resource_word0 = (1 << 0);\r\nsq_tex_resource_word0 |= ((((pitch >> 3) - 1) << 8) |\r\n((w - 1) << 19));\r\nsq_tex_resource_word1 = (format << 26);\r\nsq_tex_resource_word1 |= ((h - 1) << 0);\r\nsq_tex_resource_word4 = ((1 << 14) |\r\n(0 << 16) |\r\n(1 << 19) |\r\n(2 << 22) |\r\n(3 << 25));\r\nBEGIN_RING(9);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_RESOURCE, 7));\r\nOUT_RING(0);\r\nOUT_RING(sq_tex_resource_word0);\r\nOUT_RING(sq_tex_resource_word1);\r\nOUT_RING(gpu_addr >> 8);\r\nOUT_RING(gpu_addr >> 8);\r\nOUT_RING(sq_tex_resource_word4);\r\nOUT_RING(0);\r\nOUT_RING(R600_SQ_TEX_VTX_VALID_TEXTURE << 30);\r\nADVANCE_RING();\r\n}\r\nstatic void\r\nset_scissors(drm_radeon_private_t *dev_priv, int x1, int y1, int x2, int y2)\r\n{\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nBEGIN_RING(12);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 2));\r\nOUT_RING((R600_PA_SC_SCREEN_SCISSOR_TL - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING((x1 << 0) | (y1 << 16));\r\nOUT_RING((x2 << 0) | (y2 << 16));\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 2));\r\nOUT_RING((R600_PA_SC_GENERIC_SCISSOR_TL - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING((x1 << 0) | (y1 << 16) | (1 << 31));\r\nOUT_RING((x2 << 0) | (y2 << 16));\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONTEXT_REG, 2));\r\nOUT_RING((R600_PA_SC_WINDOW_SCISSOR_TL - R600_SET_CONTEXT_REG_OFFSET) >> 2);\r\nOUT_RING((x1 << 0) | (y1 << 16) | (1 << 31));\r\nOUT_RING((x2 << 0) | (y2 << 16));\r\nADVANCE_RING();\r\n}\r\nstatic void\r\ndraw_auto(drm_radeon_private_t *dev_priv)\r\n{\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nBEGIN_RING(10);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONFIG_REG, 1));\r\nOUT_RING((R600_VGT_PRIMITIVE_TYPE - R600_SET_CONFIG_REG_OFFSET) >> 2);\r\nOUT_RING(DI_PT_RECTLIST);\r\nOUT_RING(CP_PACKET3(R600_IT_INDEX_TYPE, 0));\r\n#ifdef __BIG_ENDIAN\r\nOUT_RING((2 << 2) | DI_INDEX_SIZE_16_BIT);\r\n#else\r\nOUT_RING(DI_INDEX_SIZE_16_BIT);\r\n#endif\r\nOUT_RING(CP_PACKET3(R600_IT_NUM_INSTANCES, 0));\r\nOUT_RING(1);\r\nOUT_RING(CP_PACKET3(R600_IT_DRAW_INDEX_AUTO, 1));\r\nOUT_RING(3);\r\nOUT_RING(DI_SRC_SEL_AUTO_INDEX);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\n}\r\nstatic void\r\nset_default_state(drm_radeon_private_t *dev_priv)\r\n{\r\nint i;\r\nu32 sq_config, sq_gpr_resource_mgmt_1, sq_gpr_resource_mgmt_2;\r\nu32 sq_thread_resource_mgmt, sq_stack_resource_mgmt_1, sq_stack_resource_mgmt_2;\r\nint num_ps_gprs, num_vs_gprs, num_temp_gprs, num_gs_gprs, num_es_gprs;\r\nint num_ps_threads, num_vs_threads, num_gs_threads, num_es_threads;\r\nint num_ps_stack_entries, num_vs_stack_entries, num_gs_stack_entries, num_es_stack_entries;\r\nRING_LOCALS;\r\nswitch ((dev_priv->flags & RADEON_FAMILY_MASK)) {\r\ncase CHIP_R600:\r\nnum_ps_gprs = 192;\r\nnum_vs_gprs = 56;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 136;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 128;\r\nnum_vs_stack_entries = 128;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\ncase CHIP_RV630:\r\ncase CHIP_RV635:\r\nnum_ps_gprs = 84;\r\nnum_vs_gprs = 36;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 144;\r\nnum_vs_threads = 40;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 40;\r\nnum_vs_stack_entries = 40;\r\nnum_gs_stack_entries = 32;\r\nnum_es_stack_entries = 16;\r\nbreak;\r\ncase CHIP_RV610:\r\ncase CHIP_RV620:\r\ncase CHIP_RS780:\r\ncase CHIP_RS880:\r\ndefault:\r\nnum_ps_gprs = 84;\r\nnum_vs_gprs = 36;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 136;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 40;\r\nnum_vs_stack_entries = 40;\r\nnum_gs_stack_entries = 32;\r\nnum_es_stack_entries = 16;\r\nbreak;\r\ncase CHIP_RV670:\r\nnum_ps_gprs = 144;\r\nnum_vs_gprs = 40;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 136;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 4;\r\nnum_es_threads = 4;\r\nnum_ps_stack_entries = 40;\r\nnum_vs_stack_entries = 40;\r\nnum_gs_stack_entries = 32;\r\nnum_es_stack_entries = 16;\r\nbreak;\r\ncase CHIP_RV770:\r\nnum_ps_gprs = 192;\r\nnum_vs_gprs = 56;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 188;\r\nnum_vs_threads = 60;\r\nnum_gs_threads = 0;\r\nnum_es_threads = 0;\r\nnum_ps_stack_entries = 256;\r\nnum_vs_stack_entries = 256;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\ncase CHIP_RV730:\r\ncase CHIP_RV740:\r\nnum_ps_gprs = 84;\r\nnum_vs_gprs = 36;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 188;\r\nnum_vs_threads = 60;\r\nnum_gs_threads = 0;\r\nnum_es_threads = 0;\r\nnum_ps_stack_entries = 128;\r\nnum_vs_stack_entries = 128;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\ncase CHIP_RV710:\r\nnum_ps_gprs = 192;\r\nnum_vs_gprs = 56;\r\nnum_temp_gprs = 4;\r\nnum_gs_gprs = 0;\r\nnum_es_gprs = 0;\r\nnum_ps_threads = 144;\r\nnum_vs_threads = 48;\r\nnum_gs_threads = 0;\r\nnum_es_threads = 0;\r\nnum_ps_stack_entries = 128;\r\nnum_vs_stack_entries = 128;\r\nnum_gs_stack_entries = 0;\r\nnum_es_stack_entries = 0;\r\nbreak;\r\n}\r\nif (((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV610) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV620) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS780) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RS880) ||\r\n((dev_priv->flags & RADEON_FAMILY_MASK) == CHIP_RV710))\r\nsq_config = 0;\r\nelse\r\nsq_config = R600_VC_ENABLE;\r\nsq_config |= (R600_DX9_CONSTS |\r\nR600_ALU_INST_PREFER_VECTOR |\r\nR600_PS_PRIO(0) |\r\nR600_VS_PRIO(1) |\r\nR600_GS_PRIO(2) |\r\nR600_ES_PRIO(3));\r\nsq_gpr_resource_mgmt_1 = (R600_NUM_PS_GPRS(num_ps_gprs) |\r\nR600_NUM_VS_GPRS(num_vs_gprs) |\r\nR600_NUM_CLAUSE_TEMP_GPRS(num_temp_gprs));\r\nsq_gpr_resource_mgmt_2 = (R600_NUM_GS_GPRS(num_gs_gprs) |\r\nR600_NUM_ES_GPRS(num_es_gprs));\r\nsq_thread_resource_mgmt = (R600_NUM_PS_THREADS(num_ps_threads) |\r\nR600_NUM_VS_THREADS(num_vs_threads) |\r\nR600_NUM_GS_THREADS(num_gs_threads) |\r\nR600_NUM_ES_THREADS(num_es_threads));\r\nsq_stack_resource_mgmt_1 = (R600_NUM_PS_STACK_ENTRIES(num_ps_stack_entries) |\r\nR600_NUM_VS_STACK_ENTRIES(num_vs_stack_entries));\r\nsq_stack_resource_mgmt_2 = (R600_NUM_GS_STACK_ENTRIES(num_gs_stack_entries) |\r\nR600_NUM_ES_STACK_ENTRIES(num_es_stack_entries));\r\nif ((dev_priv->flags & RADEON_FAMILY_MASK) >= CHIP_RV770) {\r\nBEGIN_RING(r7xx_default_size + 10);\r\nfor (i = 0; i < r7xx_default_size; i++)\r\nOUT_RING(r7xx_default_state[i]);\r\n} else {\r\nBEGIN_RING(r6xx_default_size + 10);\r\nfor (i = 0; i < r6xx_default_size; i++)\r\nOUT_RING(r6xx_default_state[i]);\r\n}\r\nOUT_RING(CP_PACKET3(R600_IT_EVENT_WRITE, 0));\r\nOUT_RING(R600_CACHE_FLUSH_AND_INV_EVENT);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONFIG_REG, 6));\r\nOUT_RING((R600_SQ_CONFIG - R600_SET_CONFIG_REG_OFFSET) >> 2);\r\nOUT_RING(sq_config);\r\nOUT_RING(sq_gpr_resource_mgmt_1);\r\nOUT_RING(sq_gpr_resource_mgmt_2);\r\nOUT_RING(sq_thread_resource_mgmt);\r\nOUT_RING(sq_stack_resource_mgmt_1);\r\nOUT_RING(sq_stack_resource_mgmt_2);\r\nADVANCE_RING();\r\n}\r\nstatic int r600_nomm_get_vb(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndev_priv->blit_vb = radeon_freelist_get(dev);\r\nif (!dev_priv->blit_vb) {\r\nDRM_ERROR("Unable to allocate vertex buffer for blit\n");\r\nreturn -EAGAIN;\r\n}\r\nreturn 0;\r\n}\r\nstatic void r600_nomm_put_vb(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\ndev_priv->blit_vb->used = 0;\r\nradeon_cp_discard_buffer(dev, dev_priv->blit_vb->file_priv->master, dev_priv->blit_vb);\r\n}\r\nstatic void *r600_nomm_get_vb_ptr(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nreturn (((char *)dev->agp_buffer_map->handle +\r\ndev_priv->blit_vb->offset + dev_priv->blit_vb->used));\r\n}\r\nint\r\nr600_prepare_blit_copy(struct drm_device *dev, struct drm_file *file_priv)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nint ret;\r\nDRM_DEBUG("\n");\r\nret = r600_nomm_get_vb(dev);\r\nif (ret)\r\nreturn ret;\r\ndev_priv->blit_vb->file_priv = file_priv;\r\nset_default_state(dev_priv);\r\nset_shaders(dev);\r\nreturn 0;\r\n}\r\nvoid\r\nr600_done_blit_copy(struct drm_device *dev)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nRING_LOCALS;\r\nDRM_DEBUG("\n");\r\nBEGIN_RING(5);\r\nOUT_RING(CP_PACKET3(R600_IT_EVENT_WRITE, 0));\r\nOUT_RING(R600_CACHE_FLUSH_AND_INV_EVENT);\r\nOUT_RING(CP_PACKET3(R600_IT_SET_CONFIG_REG, 1));\r\nOUT_RING((R600_WAIT_UNTIL - R600_SET_CONFIG_REG_OFFSET) >> 2);\r\nOUT_RING(RADEON_WAIT_3D_IDLE | RADEON_WAIT_3D_IDLECLEAN);\r\nADVANCE_RING();\r\nCOMMIT_RING();\r\nr600_nomm_put_vb(dev);\r\n}\r\nvoid\r\nr600_blit_copy(struct drm_device *dev,\r\nuint64_t src_gpu_addr, uint64_t dst_gpu_addr,\r\nint size_bytes)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nint max_bytes;\r\nu64 vb_addr;\r\nu32 *vb;\r\nvb = r600_nomm_get_vb_ptr(dev);\r\nif ((size_bytes & 3) || (src_gpu_addr & 3) || (dst_gpu_addr & 3)) {\r\nmax_bytes = 8192;\r\nwhile (size_bytes) {\r\nint cur_size = size_bytes;\r\nint src_x = src_gpu_addr & 255;\r\nint dst_x = dst_gpu_addr & 255;\r\nint h = 1;\r\nsrc_gpu_addr = src_gpu_addr & ~255;\r\ndst_gpu_addr = dst_gpu_addr & ~255;\r\nif (!src_x && !dst_x) {\r\nh = (cur_size / max_bytes);\r\nif (h > 8192)\r\nh = 8192;\r\nif (h == 0)\r\nh = 1;\r\nelse\r\ncur_size = max_bytes;\r\n} else {\r\nif (cur_size > max_bytes)\r\ncur_size = max_bytes;\r\nif (cur_size > (max_bytes - dst_x))\r\ncur_size = (max_bytes - dst_x);\r\nif (cur_size > (max_bytes - src_x))\r\ncur_size = (max_bytes - src_x);\r\n}\r\nif ((dev_priv->blit_vb->used + 48) > dev_priv->blit_vb->total) {\r\nr600_nomm_put_vb(dev);\r\nr600_nomm_get_vb(dev);\r\nif (!dev_priv->blit_vb)\r\nreturn;\r\nset_shaders(dev);\r\nvb = r600_nomm_get_vb_ptr(dev);\r\n}\r\nvb[0] = int2float(dst_x);\r\nvb[1] = 0;\r\nvb[2] = int2float(src_x);\r\nvb[3] = 0;\r\nvb[4] = int2float(dst_x);\r\nvb[5] = int2float(h);\r\nvb[6] = int2float(src_x);\r\nvb[7] = int2float(h);\r\nvb[8] = int2float(dst_x + cur_size);\r\nvb[9] = int2float(h);\r\nvb[10] = int2float(src_x + cur_size);\r\nvb[11] = int2float(h);\r\nset_tex_resource(dev_priv, FMT_8,\r\nsrc_x + cur_size, h, src_x + cur_size,\r\nsrc_gpu_addr);\r\ncp_set_surface_sync(dev_priv,\r\nR600_TC_ACTION_ENA, (src_x + cur_size * h), src_gpu_addr);\r\nset_render_target(dev_priv, COLOR_8,\r\ndst_x + cur_size, h,\r\ndst_gpu_addr);\r\nset_scissors(dev_priv, dst_x, 0, dst_x + cur_size, h);\r\nvb_addr = dev_priv->gart_buffers_offset +\r\ndev_priv->blit_vb->offset +\r\ndev_priv->blit_vb->used;\r\nset_vtx_resource(dev_priv, vb_addr);\r\ndraw_auto(dev_priv);\r\ncp_set_surface_sync(dev_priv,\r\nR600_CB_ACTION_ENA | R600_CB0_DEST_BASE_ENA,\r\ncur_size * h, dst_gpu_addr);\r\nvb += 12;\r\ndev_priv->blit_vb->used += 12 * 4;\r\nsrc_gpu_addr += cur_size * h;\r\ndst_gpu_addr += cur_size * h;\r\nsize_bytes -= cur_size * h;\r\n}\r\n} else {\r\nmax_bytes = 8192 * 4;\r\nwhile (size_bytes) {\r\nint cur_size = size_bytes;\r\nint src_x = (src_gpu_addr & 255);\r\nint dst_x = (dst_gpu_addr & 255);\r\nint h = 1;\r\nsrc_gpu_addr = src_gpu_addr & ~255;\r\ndst_gpu_addr = dst_gpu_addr & ~255;\r\nif (!src_x && !dst_x) {\r\nh = (cur_size / max_bytes);\r\nif (h > 8192)\r\nh = 8192;\r\nif (h == 0)\r\nh = 1;\r\nelse\r\ncur_size = max_bytes;\r\n} else {\r\nif (cur_size > max_bytes)\r\ncur_size = max_bytes;\r\nif (cur_size > (max_bytes - dst_x))\r\ncur_size = (max_bytes - dst_x);\r\nif (cur_size > (max_bytes - src_x))\r\ncur_size = (max_bytes - src_x);\r\n}\r\nif ((dev_priv->blit_vb->used + 48) > dev_priv->blit_vb->total) {\r\nr600_nomm_put_vb(dev);\r\nr600_nomm_get_vb(dev);\r\nif (!dev_priv->blit_vb)\r\nreturn;\r\nset_shaders(dev);\r\nvb = r600_nomm_get_vb_ptr(dev);\r\n}\r\nvb[0] = int2float(dst_x / 4);\r\nvb[1] = 0;\r\nvb[2] = int2float(src_x / 4);\r\nvb[3] = 0;\r\nvb[4] = int2float(dst_x / 4);\r\nvb[5] = int2float(h);\r\nvb[6] = int2float(src_x / 4);\r\nvb[7] = int2float(h);\r\nvb[8] = int2float((dst_x + cur_size) / 4);\r\nvb[9] = int2float(h);\r\nvb[10] = int2float((src_x + cur_size) / 4);\r\nvb[11] = int2float(h);\r\nset_tex_resource(dev_priv, FMT_8_8_8_8,\r\n(src_x + cur_size) / 4,\r\nh, (src_x + cur_size) / 4,\r\nsrc_gpu_addr);\r\ncp_set_surface_sync(dev_priv,\r\nR600_TC_ACTION_ENA, (src_x + cur_size * h), src_gpu_addr);\r\nset_render_target(dev_priv, COLOR_8_8_8_8,\r\n(dst_x + cur_size) / 4, h,\r\ndst_gpu_addr);\r\nset_scissors(dev_priv, (dst_x / 4), 0, (dst_x + cur_size / 4), h);\r\nvb_addr = dev_priv->gart_buffers_offset +\r\ndev_priv->blit_vb->offset +\r\ndev_priv->blit_vb->used;\r\nset_vtx_resource(dev_priv, vb_addr);\r\ndraw_auto(dev_priv);\r\ncp_set_surface_sync(dev_priv,\r\nR600_CB_ACTION_ENA | R600_CB0_DEST_BASE_ENA,\r\ncur_size * h, dst_gpu_addr);\r\nvb += 12;\r\ndev_priv->blit_vb->used += 12 * 4;\r\nsrc_gpu_addr += cur_size * h;\r\ndst_gpu_addr += cur_size * h;\r\nsize_bytes -= cur_size * h;\r\n}\r\n}\r\n}\r\nvoid\r\nr600_blit_swap(struct drm_device *dev,\r\nuint64_t src_gpu_addr, uint64_t dst_gpu_addr,\r\nint sx, int sy, int dx, int dy,\r\nint w, int h, int src_pitch, int dst_pitch, int cpp)\r\n{\r\ndrm_radeon_private_t *dev_priv = dev->dev_private;\r\nint cb_format, tex_format;\r\nint sx2, sy2, dx2, dy2;\r\nu64 vb_addr;\r\nu32 *vb;\r\nif ((dev_priv->blit_vb->used + 48) > dev_priv->blit_vb->total) {\r\nr600_nomm_put_vb(dev);\r\nr600_nomm_get_vb(dev);\r\nif (!dev_priv->blit_vb)\r\nreturn;\r\nset_shaders(dev);\r\n}\r\nvb = r600_nomm_get_vb_ptr(dev);\r\nsx2 = sx + w;\r\nsy2 = sy + h;\r\ndx2 = dx + w;\r\ndy2 = dy + h;\r\nvb[0] = int2float(dx);\r\nvb[1] = int2float(dy);\r\nvb[2] = int2float(sx);\r\nvb[3] = int2float(sy);\r\nvb[4] = int2float(dx);\r\nvb[5] = int2float(dy2);\r\nvb[6] = int2float(sx);\r\nvb[7] = int2float(sy2);\r\nvb[8] = int2float(dx2);\r\nvb[9] = int2float(dy2);\r\nvb[10] = int2float(sx2);\r\nvb[11] = int2float(sy2);\r\nswitch(cpp) {\r\ncase 4:\r\ncb_format = COLOR_8_8_8_8;\r\ntex_format = FMT_8_8_8_8;\r\nbreak;\r\ncase 2:\r\ncb_format = COLOR_5_6_5;\r\ntex_format = FMT_5_6_5;\r\nbreak;\r\ndefault:\r\ncb_format = COLOR_8;\r\ntex_format = FMT_8;\r\nbreak;\r\n}\r\nset_tex_resource(dev_priv, tex_format,\r\nsrc_pitch / cpp,\r\nsy2, src_pitch / cpp,\r\nsrc_gpu_addr);\r\ncp_set_surface_sync(dev_priv,\r\nR600_TC_ACTION_ENA, src_pitch * sy2, src_gpu_addr);\r\nset_render_target(dev_priv, cb_format,\r\ndst_pitch / cpp, dy2,\r\ndst_gpu_addr);\r\nset_scissors(dev_priv, dx, dy, dx2, dy2);\r\nvb_addr = dev_priv->gart_buffers_offset +\r\ndev_priv->blit_vb->offset +\r\ndev_priv->blit_vb->used;\r\nset_vtx_resource(dev_priv, vb_addr);\r\ndraw_auto(dev_priv);\r\ncp_set_surface_sync(dev_priv,\r\nR600_CB_ACTION_ENA | R600_CB0_DEST_BASE_ENA,\r\ndst_pitch * dy2, dst_gpu_addr);\r\ndev_priv->blit_vb->used += 12 * 4;\r\n}

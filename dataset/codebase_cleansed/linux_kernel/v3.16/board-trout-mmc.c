static void config_gpio_table(uint32_t *table, int len)\r\n{\r\nint n;\r\nunsigned id;\r\nfor(n = 0; n < len; n++) {\r\nid = table[n];\r\nmsm_proc_comm(PCOM_RPC_GPIO_TLMM_CONFIG_EX, &id, 0);\r\n}\r\n}\r\nstatic int __init trout_disablesdcard_setup(char *str)\r\n{\r\nint cal = simple_strtol(str, NULL, 0);\r\nopt_disable_sdcard = cal;\r\nreturn 1;\r\n}\r\nstatic uint32_t trout_sdslot_switchvdd(struct device *dev, unsigned int vdd)\r\n{\r\nint i, rc;\r\nBUG_ON(!vreg_sdslot);\r\nif (vdd == sdslot_vdd)\r\nreturn 0;\r\nsdslot_vdd = vdd;\r\nif (vdd == 0) {\r\n#if DEBUG_SDSLOT_VDD\r\nprintk("%s: Disabling SD slot power\n", __func__);\r\n#endif\r\nconfig_gpio_table(sdcard_off_gpio_table,\r\nARRAY_SIZE(sdcard_off_gpio_table));\r\nvreg_disable(vreg_sdslot);\r\nsdslot_vreg_enabled = 0;\r\nreturn 0;\r\n}\r\nif (!sdslot_vreg_enabled) {\r\nrc = vreg_enable(vreg_sdslot);\r\nif (rc) {\r\nprintk(KERN_ERR "%s: Error enabling vreg (%d)\n",\r\n__func__, rc);\r\n}\r\nconfig_gpio_table(sdcard_on_gpio_table,\r\nARRAY_SIZE(sdcard_on_gpio_table));\r\nsdslot_vreg_enabled = 1;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(mmc_vdd_table); i++) {\r\nif (mmc_vdd_table[i].mask == (1 << vdd)) {\r\n#if DEBUG_SDSLOT_VDD\r\nprintk("%s: Setting level to %u\n",\r\n__func__, mmc_vdd_table[i].level);\r\n#endif\r\nrc = vreg_set_level(vreg_sdslot,\r\nmmc_vdd_table[i].level);\r\nif (rc) {\r\nprintk(KERN_ERR\r\n"%s: Error setting vreg level (%d)\n",\r\n__func__, rc);\r\n}\r\nreturn 0;\r\n}\r\n}\r\nprintk(KERN_ERR "%s: Invalid VDD %d specified\n", __func__, vdd);\r\nreturn 0;\r\n}\r\nstatic unsigned int trout_sdslot_status(struct device *dev)\r\n{\r\nunsigned int status;\r\nstatus = (unsigned int) gpio_get_value(TROUT_GPIO_SDMC_CD_N);\r\nreturn (!status);\r\n}\r\nint __init trout_init_mmc(unsigned int sys_rev)\r\n{\r\nsdslot_vreg_enabled = 0;\r\nvreg_sdslot = vreg_get(0, "gp6");\r\nif (IS_ERR(vreg_sdslot))\r\nreturn PTR_ERR(vreg_sdslot);\r\nirq_set_irq_wake(TROUT_GPIO_TO_INT(TROUT_GPIO_SDMC_CD_N), 1);\r\nif (!opt_disable_sdcard)\r\nmsm_add_sdcc(2, &trout_sdslot_data,\r\nTROUT_GPIO_TO_INT(TROUT_GPIO_SDMC_CD_N), 0);\r\nelse\r\nprintk(KERN_INFO "trout: SD-Card interface disabled\n");\r\nreturn 0;\r\n}

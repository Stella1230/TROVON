static int mgc_setup(struct obd_device *obd, struct lustre_cfg *lcfg)\r\n{\r\nint rc;\r\nptlrpcd_addref();\r\nrc = client_obd_setup(obd, lcfg);\r\nif (rc)\r\nGOTO(err_decref, rc);\r\nobd->u.cli.cl_flvr_mgc.sf_rpc = SPTLRPC_FLVR_NULL;\r\nrc = obd_llog_init(obd, &obd->obd_olg, obd, NULL);\r\nif (rc) {\r\nCERROR("failed to setup llogging subsystems\n");\r\nGOTO(err_cleanup, rc);\r\n}\r\nreturn rc;\r\nerr_cleanup:\r\nclient_obd_cleanup(obd);\r\nerr_decref:\r\nptlrpcd_decref();\r\nreturn rc;\r\n}\r\nstatic int mgc_precleanup(struct obd_device *obd, enum obd_cleanup_stage stage)\r\n{\r\nint rc = 0;\r\nswitch (stage) {\r\ncase OBD_CLEANUP_EARLY:\r\ncase OBD_CLEANUP_EXPORTS:\r\nobd_cleanup_client_import(obd);\r\nrc = obd_llog_finish(obd, 0);\r\nif (rc != 0)\r\nCERROR("failed to cleanup llogging subsystems\n");\r\nbreak;\r\n}\r\nreturn rc;\r\n}\r\nstatic int mgc_cleanup(struct obd_device *obd)\r\n{\r\nint rc;\r\nptlrpcd_decref();\r\nrc = client_obd_cleanup(obd);\r\nreturn rc;\r\n}\r\nstatic int mgc_llog_init(struct obd_device *obd, struct obd_llog_group *olg,\r\nstruct obd_device *tgt, int *index)\r\n{\r\nstruct llog_ctxt *ctxt;\r\nint rc;\r\nLASSERT(olg == &obd->obd_olg);\r\nrc = llog_setup(NULL, obd, olg, LLOG_CONFIG_REPL_CTXT, tgt,\r\n&llog_client_ops);\r\nif (rc < 0)\r\nreturn rc;\r\nctxt = llog_group_get_ctxt(olg, LLOG_CONFIG_REPL_CTXT);\r\nllog_initiator_connect(ctxt);\r\nllog_ctxt_put(ctxt);\r\nreturn rc;\r\n}\r\nstatic int mgc_llog_finish(struct obd_device *obd, int count)\r\n{\r\nstruct llog_ctxt *ctxt;\r\nctxt = llog_get_context(obd, LLOG_CONFIG_REPL_CTXT);\r\nif (ctxt)\r\nllog_cleanup(NULL, ctxt);\r\nreturn 0;\r\n}\r\nint __init mgc_init(void)\r\n{\r\nreturn class_register_type(&mgc_obd_ops, NULL,\r\nNULL, LUSTRE_MGC_NAME, NULL);\r\n}

static int apci035_timer_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned int ui_Status;\r\nunsigned int ui_Command;\r\nunsigned int ui_Mode;\r\ni_Temp = 0;\r\ndevpriv->tsk_Current = current;\r\ndevpriv->b_TimerSelectMode = data[0];\r\ni_WatchdogNbr = data[1];\r\nif (data[0] == 0)\r\nui_Mode = 2;\r\nelse\r\nui_Mode = 0;\r\nui_Command = 0;\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\noutl(data[3], devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 4);\r\noutl(data[2], devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 8);\r\nif (data[0] == ADDIDATA_TIMER) {\r\nui_Command =\r\n(ui_Command & 0xFFF719E2UL) | ui_Mode << 13UL | 0x10UL;\r\n} else if (data[0] == ADDIDATA_WATCHDOG) {\r\nui_Command = ui_Command & 0xFFF819E2UL;\r\n} else {\r\ndev_err(dev->class_dev, "The parameter for Timer/watchdog selection is in error\n");\r\nreturn -EINVAL;\r\n}\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = ui_Command & 0xFFFFF89FUL;\r\nif (data[4] == ADDIDATA_ENABLE) {\r\nui_Command = ui_Command | (data[5] << 5);\r\n}\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = ui_Command & 0xFFFFF87FUL;\r\nif (data[6] == ADDIDATA_ENABLE) {\r\nui_Command = ui_Command | (data[7] << 7);\r\n}\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = ui_Command & 0xFFFFF9FBUL;\r\nui_Command = ui_Command | (data[8] << 2);\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nif (data[9] == ADDIDATA_ENABLE) {\r\noutl(data[11],\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 24);\r\noutl(data[10],\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 28);\r\n}\r\nui_Command = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = ui_Command & 0xFFFFF9F7UL;\r\nui_Command = ui_Command | (data[12] << 3);\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Status = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 16);\r\nui_Command = (ui_Command & 0xFFFFF9FDUL) | (data[13] << 1);\r\noutl(ui_Command, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nreturn insn->n;\r\n}\r\nstatic int apci035_timer_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned int ui_Command;\r\nint i_Count;\r\nif (data[0] == 1) {\r\nui_Command =\r\ninl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = (ui_Command & 0xFFFFF9FFUL) | 0x1UL;\r\noutl(ui_Command,\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\n}\r\nif (data[0] == 2) {\r\nui_Command =\r\ninl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\nui_Command = (ui_Command & 0xFFFFF9FFUL) | 0x200UL;\r\noutl(ui_Command,\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\n}\r\nif (data[0] == 0) {\r\nui_Command = 0;\r\noutl(ui_Command,\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 12);\r\n}\r\nif (data[0] == 3) {\r\nui_Command = 0;\r\nfor (i_Count = 1; i_Count <= 4; i_Count++) {\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG)\r\nui_Command = 0x2UL;\r\nelse\r\nui_Command = 0x10UL;\r\ni_WatchdogNbr = i_Count;\r\noutl(ui_Command,\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) +\r\n0);\r\n}\r\n}\r\nif (data[0] == 4) {\r\nui_Command = 0;\r\nfor (i_Count = 1; i_Count <= 4; i_Count++) {\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG)\r\nui_Command = 0x1UL;\r\nelse\r\nui_Command = 0x8UL;\r\ni_WatchdogNbr = i_Count;\r\noutl(ui_Command,\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) +\r\n0);\r\n}\r\n}\r\nif (data[0] == 5) {\r\nui_Command = 0;\r\nfor (i_Count = 1; i_Count <= 4; i_Count++) {\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_WATCHDOG)\r\nui_Command = 0x4UL;\r\nelse\r\nui_Command = 0x20UL;\r\ni_WatchdogNbr = i_Count;\r\noutl(ui_Command,\r\ndevpriv->iobase + ((i_WatchdogNbr - 1) * 32) +\r\n0);\r\n}\r\ni_Temp = 1;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic int apci035_timer_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned int ui_Status;\r\ni_WatchdogNbr = insn->unused[0];\r\nui_Status = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 16);\r\ndata[0] = ((ui_Status >> 1) & 1);\r\ndata[1] = ((ui_Status >> 2) & 1);\r\ndata[2] = ((ui_Status >> 3) & 1);\r\ndata[3] = ((ui_Status >> 0) & 1);\r\nif (devpriv->b_TimerSelectMode == ADDIDATA_TIMER)\r\ndata[4] = inl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 0);\r\nreturn insn->n;\r\n}\r\nstatic int apci035_ai_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\ndevpriv->tsk_Current = current;\r\noutl(0x200 | 0, devpriv->iobase + 128 + 0x4);\r\noutl(0, devpriv->iobase + 128 + 0);\r\noutl(0x300 | 0, devpriv->iobase + 128 + 0x4);\r\noutl((data[0] << 8), devpriv->iobase + 128 + 0);\r\noutl(0x200000UL, devpriv->iobase + 128 + 12);\r\nreturn insn->n;\r\n}\r\nstatic int apci035_ai_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned int ui_CommandRegister;\r\nui_CommandRegister = 0x80000;\r\noutl(ui_CommandRegister, devpriv->iobase + 128 + 8);\r\ndata[0] = inl(devpriv->iobase + 128 + 28);\r\nreturn insn->n;\r\n}\r\nstatic int apci035_reset(struct comedi_device *dev)\r\n{\r\nstruct addi_private *devpriv = dev->private;\r\nint i_Count;\r\nfor (i_Count = 1; i_Count <= 4; i_Count++) {\r\ni_WatchdogNbr = i_Count;\r\noutl(0x0, devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 0);\r\n}\r\noutl(0x0, devpriv->iobase + 128 + 12);\r\nreturn 0;\r\n}\r\nstatic void apci035_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct addi_private *devpriv = dev->private;\r\nunsigned int ui_StatusRegister1;\r\nunsigned int ui_StatusRegister2;\r\nunsigned int ui_ReadCommand;\r\nunsigned int ui_ChannelNumber;\r\nunsigned int ui_DigitalTemperature;\r\nif (i_Temp == 1) {\r\ni_WatchdogNbr = i_Flag;\r\ni_Flag = i_Flag + 1;\r\n}\r\nui_StatusRegister1 = inl(devpriv->iobase + 128 + 16);\r\nui_StatusRegister2 =\r\ninl(devpriv->iobase + ((i_WatchdogNbr - 1) * 32) + 20);\r\nif ((((ui_StatusRegister1) & 0x8) == 0x8)) {\r\nui_ReadCommand = inl(devpriv->iobase + 128 + 12);\r\nui_ReadCommand = ui_ReadCommand & 0xFFDF0000UL;\r\noutl(ui_ReadCommand, devpriv->iobase + 128 + 12);\r\nui_ChannelNumber = inl(devpriv->iobase + 128 + 60);\r\nui_DigitalTemperature = inl(devpriv->iobase + 128 + 60);\r\nsend_sig(SIGIO, devpriv->tsk_Current, 0);\r\n} else if ((ui_StatusRegister2 & 0x1) == 0x1) {\r\nsend_sig(SIGIO, devpriv->tsk_Current, 0);\r\n}\r\nreturn;\r\n}

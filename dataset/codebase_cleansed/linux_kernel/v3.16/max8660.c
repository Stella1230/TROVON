static int max8660_write(struct max8660 *max8660, u8 reg, u8 mask, u8 val)\r\n{\r\nstatic const u8 max8660_addresses[MAX8660_N_REGS] = {\r\n0x10, 0x12, 0x20, 0x23, 0x24, 0x29, 0x2a, 0x32, 0x33, 0x39, 0x80\r\n};\r\nint ret;\r\nu8 reg_val = (max8660->shadow_regs[reg] & mask) | val;\r\ndev_vdbg(&max8660->client->dev, "Writing reg %02x with %02x\n",\r\nmax8660_addresses[reg], reg_val);\r\nret = i2c_smbus_write_byte_data(max8660->client,\r\nmax8660_addresses[reg], reg_val);\r\nif (ret == 0)\r\nmax8660->shadow_regs[reg] = reg_val;\r\nreturn ret;\r\n}\r\nstatic int max8660_dcdc_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 val = max8660->shadow_regs[MAX8660_OVER1];\r\nu8 mask = (rdev_get_id(rdev) == MAX8660_V3) ? 1 : 4;\r\nreturn !!(val & mask);\r\n}\r\nstatic int max8660_dcdc_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 bit = (rdev_get_id(rdev) == MAX8660_V3) ? 1 : 4;\r\nreturn max8660_write(max8660, MAX8660_OVER1, 0xff, bit);\r\n}\r\nstatic int max8660_dcdc_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 mask = (rdev_get_id(rdev) == MAX8660_V3) ? ~1 : ~4;\r\nreturn max8660_write(max8660, MAX8660_OVER1, mask, 0);\r\n}\r\nstatic int max8660_dcdc_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 reg = (rdev_get_id(rdev) == MAX8660_V3) ? MAX8660_ADTV2 : MAX8660_SDTV2;\r\nu8 selector = max8660->shadow_regs[reg];\r\nreturn selector;\r\n}\r\nstatic int max8660_dcdc_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 reg, bits;\r\nint ret;\r\nreg = (rdev_get_id(rdev) == MAX8660_V3) ? MAX8660_ADTV2 : MAX8660_SDTV2;\r\nret = max8660_write(max8660, reg, 0, selector);\r\nif (ret)\r\nreturn ret;\r\nbits = (rdev_get_id(rdev) == MAX8660_V3) ? 0x03 : 0x30;\r\nreturn max8660_write(max8660, MAX8660_VCC1, 0xff, bits);\r\n}\r\nstatic int max8660_ldo5_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 selector = max8660->shadow_regs[MAX8660_MDTV2];\r\nreturn selector;\r\n}\r\nstatic int max8660_ldo5_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nint ret;\r\nret = max8660_write(max8660, MAX8660_MDTV2, 0, selector);\r\nif (ret)\r\nreturn ret;\r\nreturn max8660_write(max8660, MAX8660_VCC1, 0xff, 0xc0);\r\n}\r\nstatic int max8660_ldo67_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 val = max8660->shadow_regs[MAX8660_OVER2];\r\nu8 mask = (rdev_get_id(rdev) == MAX8660_V6) ? 2 : 4;\r\nreturn !!(val & mask);\r\n}\r\nstatic int max8660_ldo67_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 bit = (rdev_get_id(rdev) == MAX8660_V6) ? 2 : 4;\r\nreturn max8660_write(max8660, MAX8660_OVER2, 0xff, bit);\r\n}\r\nstatic int max8660_ldo67_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 mask = (rdev_get_id(rdev) == MAX8660_V6) ? ~2 : ~4;\r\nreturn max8660_write(max8660, MAX8660_OVER2, mask, 0);\r\n}\r\nstatic int max8660_ldo67_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nu8 shift = (rdev_get_id(rdev) == MAX8660_V6) ? 0 : 4;\r\nu8 selector = (max8660->shadow_regs[MAX8660_L12VCR] >> shift) & 0xf;\r\nreturn selector;\r\n}\r\nstatic int max8660_ldo67_set_voltage_sel(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nstruct max8660 *max8660 = rdev_get_drvdata(rdev);\r\nif (rdev_get_id(rdev) == MAX8660_V6)\r\nreturn max8660_write(max8660, MAX8660_L12VCR, 0xf0, selector);\r\nelse\r\nreturn max8660_write(max8660, MAX8660_L12VCR, 0x0f,\r\nselector << 4);\r\n}\r\nstatic int max8660_pdata_from_dt(struct device *dev,\r\nstruct device_node **of_node,\r\nstruct max8660_platform_data *pdata)\r\n{\r\nint matched, i;\r\nstruct device_node *np;\r\nstruct max8660_subdev_data *sub;\r\nstruct of_regulator_match rmatch[ARRAY_SIZE(max8660_reg)];\r\nnp = of_get_child_by_name(dev->of_node, "regulators");\r\nif (!np) {\r\ndev_err(dev, "missing 'regulators' subnode in DT\n");\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(rmatch); i++)\r\nrmatch[i].name = max8660_reg[i].name;\r\nmatched = of_regulator_match(dev, np, rmatch, ARRAY_SIZE(rmatch));\r\nof_node_put(np);\r\nif (matched <= 0)\r\nreturn matched;\r\npdata->subdevs = devm_kzalloc(dev, sizeof(struct max8660_subdev_data) *\r\nmatched, GFP_KERNEL);\r\nif (!pdata->subdevs)\r\nreturn -ENOMEM;\r\npdata->num_subdevs = matched;\r\nsub = pdata->subdevs;\r\nfor (i = 0; i < matched; i++) {\r\nsub->id = i;\r\nsub->name = rmatch[i].name;\r\nsub->platform_data = rmatch[i].init_data;\r\nof_node[i] = rmatch[i].of_node;\r\nsub++;\r\n}\r\nreturn 0;\r\n}\r\nstatic inline int max8660_pdata_from_dt(struct device *dev,\r\nstruct device_node **of_node,\r\nstruct max8660_platform_data *pdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic int max8660_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *i2c_id)\r\n{\r\nstruct device *dev = &client->dev;\r\nstruct max8660_platform_data *pdata = dev_get_platdata(dev);\r\nstruct regulator_config config = { };\r\nstruct max8660 *max8660;\r\nint boot_on, i, id, ret = -EINVAL;\r\nstruct device_node *of_node[MAX8660_V_END];\r\nunsigned long type;\r\nif (dev->of_node && !pdata) {\r\nconst struct of_device_id *id;\r\nstruct max8660_platform_data pdata_of;\r\nid = of_match_device(of_match_ptr(max8660_dt_ids), dev);\r\nif (!id)\r\nreturn -ENODEV;\r\nret = max8660_pdata_from_dt(dev, of_node, &pdata_of);\r\nif (ret < 0)\r\nreturn ret;\r\npdata = &pdata_of;\r\ntype = (unsigned long) id->data;\r\n} else {\r\ntype = i2c_id->driver_data;\r\nmemset(of_node, 0, sizeof(of_node));\r\n}\r\nif (pdata->num_subdevs > MAX8660_V_END) {\r\ndev_err(dev, "Too many regulators found!\n");\r\nreturn -EINVAL;\r\n}\r\nmax8660 = devm_kzalloc(dev, sizeof(struct max8660), GFP_KERNEL);\r\nif (!max8660)\r\nreturn -ENOMEM;\r\nmax8660->client = client;\r\nif (pdata->en34_is_high) {\r\nmax8660->shadow_regs[MAX8660_OVER1] = 5;\r\n} else {\r\nmax8660_dcdc_ops.enable = max8660_dcdc_enable;\r\nmax8660_dcdc_ops.disable = max8660_dcdc_disable;\r\n}\r\nmax8660->shadow_regs[MAX8660_ADTV1] =\r\nmax8660->shadow_regs[MAX8660_ADTV2] =\r\nmax8660->shadow_regs[MAX8660_SDTV1] =\r\nmax8660->shadow_regs[MAX8660_SDTV2] = 0x1b;\r\nmax8660->shadow_regs[MAX8660_MDTV1] =\r\nmax8660->shadow_regs[MAX8660_MDTV2] = 0x04;\r\nfor (i = 0; i < pdata->num_subdevs; i++) {\r\nif (!pdata->subdevs[i].platform_data)\r\nreturn ret;\r\nboot_on = pdata->subdevs[i].platform_data->constraints.boot_on;\r\nswitch (pdata->subdevs[i].id) {\r\ncase MAX8660_V3:\r\nif (boot_on)\r\nmax8660->shadow_regs[MAX8660_OVER1] |= 1;\r\nbreak;\r\ncase MAX8660_V4:\r\nif (boot_on)\r\nmax8660->shadow_regs[MAX8660_OVER1] |= 4;\r\nbreak;\r\ncase MAX8660_V5:\r\nbreak;\r\ncase MAX8660_V6:\r\nif (boot_on)\r\nmax8660->shadow_regs[MAX8660_OVER2] |= 2;\r\nbreak;\r\ncase MAX8660_V7:\r\nif (type == MAX8661) {\r\ndev_err(dev, "Regulator not on this chip!\n");\r\nreturn -EINVAL;\r\n}\r\nif (boot_on)\r\nmax8660->shadow_regs[MAX8660_OVER2] |= 4;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "invalid regulator %s\n",\r\npdata->subdevs[i].name);\r\nreturn ret;\r\n}\r\n}\r\nfor (i = 0; i < pdata->num_subdevs; i++) {\r\nstruct regulator_dev *rdev;\r\nid = pdata->subdevs[i].id;\r\nconfig.dev = dev;\r\nconfig.init_data = pdata->subdevs[i].platform_data;\r\nconfig.of_node = of_node[i];\r\nconfig.driver_data = max8660;\r\nrdev = devm_regulator_register(&client->dev,\r\n&max8660_reg[id], &config);\r\nif (IS_ERR(rdev)) {\r\nret = PTR_ERR(rdev);\r\ndev_err(&client->dev, "failed to register %s\n",\r\nmax8660_reg[id].name);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\ni2c_set_clientdata(client, max8660);\r\nreturn 0;\r\n}\r\nstatic int __init max8660_init(void)\r\n{\r\nreturn i2c_add_driver(&max8660_driver);\r\n}\r\nstatic void __exit max8660_exit(void)\r\n{\r\ni2c_del_driver(&max8660_driver);\r\n}

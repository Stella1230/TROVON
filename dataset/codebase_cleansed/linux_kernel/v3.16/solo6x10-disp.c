static void solo_vin_config(struct solo_dev *solo_dev)\r\n{\r\nsolo_dev->vin_hstart = 8;\r\nsolo_dev->vin_vstart = 2;\r\nsolo_reg_write(solo_dev, SOLO_SYS_VCLK,\r\nSOLO_VCLK_SELECT(2) |\r\nSOLO_VCLK_VIN1415_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN1213_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN1011_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN0809_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN0607_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN0405_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN0203_DELAY(SOLO_VCLK_DELAY) |\r\nSOLO_VCLK_VIN0001_DELAY(SOLO_VCLK_DELAY));\r\nsolo_reg_write(solo_dev, SOLO_VI_ACT_I_P,\r\nSOLO_VI_H_START(solo_dev->vin_hstart) |\r\nSOLO_VI_V_START(solo_dev->vin_vstart) |\r\nSOLO_VI_V_STOP(solo_dev->vin_vstart +\r\nsolo_dev->video_vsize));\r\nsolo_reg_write(solo_dev, SOLO_VI_ACT_I_S,\r\nSOLO_VI_H_START(solo_dev->vout_hstart) |\r\nSOLO_VI_V_START(solo_dev->vout_vstart) |\r\nSOLO_VI_V_STOP(solo_dev->vout_vstart +\r\nsolo_dev->video_vsize));\r\nsolo_reg_write(solo_dev, SOLO_VI_ACT_P,\r\nSOLO_VI_H_START(0) |\r\nSOLO_VI_V_START(1) |\r\nSOLO_VI_V_STOP(SOLO_PROGRESSIVE_VSIZE));\r\nsolo_reg_write(solo_dev, SOLO_VI_CH_FORMAT,\r\nSOLO_VI_FD_SEL_MASK(0) | SOLO_VI_PROG_MASK(0));\r\nif (solo_dev->type == SOLO_DEV_6010)\r\nsolo_reg_write(solo_dev, SOLO_VI_FMT_CFG, 0);\r\nelse\r\nsolo_reg_write(solo_dev, SOLO_VI_FMT_CFG, 16 << 22);\r\nsolo_reg_write(solo_dev, SOLO_VI_PAGE_SW, 2);\r\nif (solo_dev->video_type == SOLO_VO_FMT_TYPE_NTSC) {\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_CONFIG,\r\nSOLO_VI_PB_USER_MODE);\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_RANGE_HV,\r\nSOLO_VI_PB_HSIZE(858) | SOLO_VI_PB_VSIZE(246));\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_ACT_V,\r\nSOLO_VI_PB_VSTART(4) |\r\nSOLO_VI_PB_VSTOP(4 + 240));\r\n} else {\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_CONFIG,\r\nSOLO_VI_PB_USER_MODE | SOLO_VI_PB_PAL);\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_RANGE_HV,\r\nSOLO_VI_PB_HSIZE(864) | SOLO_VI_PB_VSIZE(294));\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_ACT_V,\r\nSOLO_VI_PB_VSTART(4) |\r\nSOLO_VI_PB_VSTOP(4 + 288));\r\n}\r\nsolo_reg_write(solo_dev, SOLO_VI_PB_ACT_H, SOLO_VI_PB_HSTART(16) |\r\nSOLO_VI_PB_HSTOP(16 + 720));\r\n}\r\nstatic void solo_vout_config_cursor(struct solo_dev *dev)\r\n{\r\nint i;\r\nfor (i = 0; i < 20; i++)\r\nsolo_reg_write(dev, SOLO_VO_CURSOR_MASK(i), 0);\r\nsolo_reg_write(dev, SOLO_VO_CURSOR_POS, 0);\r\nsolo_reg_write(dev, SOLO_VO_CURSOR_CLR,\r\n(0x80 << 24) | (0x80 << 16) | (0x10 << 8) | 0x80);\r\nsolo_reg_write(dev, SOLO_VO_CURSOR_CLR2, (0xe0 << 8) | 0x80);\r\n}\r\nstatic void solo_vout_config(struct solo_dev *solo_dev)\r\n{\r\nsolo_dev->vout_hstart = 6;\r\nsolo_dev->vout_vstart = 8;\r\nsolo_reg_write(solo_dev, SOLO_VO_FMT_ENC,\r\nsolo_dev->video_type |\r\nSOLO_VO_USER_COLOR_SET_NAV |\r\nSOLO_VO_USER_COLOR_SET_NAH |\r\nSOLO_VO_NA_COLOR_Y(0) |\r\nSOLO_VO_NA_COLOR_CB(0) |\r\nSOLO_VO_NA_COLOR_CR(0));\r\nsolo_reg_write(solo_dev, SOLO_VO_ACT_H,\r\nSOLO_VO_H_START(solo_dev->vout_hstart) |\r\nSOLO_VO_H_STOP(solo_dev->vout_hstart +\r\nsolo_dev->video_hsize));\r\nsolo_reg_write(solo_dev, SOLO_VO_ACT_V,\r\nSOLO_VO_V_START(solo_dev->vout_vstart) |\r\nSOLO_VO_V_STOP(solo_dev->vout_vstart +\r\nsolo_dev->video_vsize));\r\nsolo_reg_write(solo_dev, SOLO_VO_RANGE_HV,\r\nSOLO_VO_H_LEN(solo_dev->video_hsize) |\r\nSOLO_VO_V_LEN(solo_dev->video_vsize));\r\nsolo_reg_write(solo_dev, SOLO_VO_BORDER_LINE_COLOR,\r\n(0xa0 << 24) | (0x88 << 16) | (0xa0 << 8) | 0x88);\r\nsolo_reg_write(solo_dev, SOLO_VO_BORDER_FILL_COLOR,\r\n(0x10 << 24) | (0x8f << 16) | (0x10 << 8) | 0x8f);\r\nsolo_reg_write(solo_dev, SOLO_VO_BKG_COLOR,\r\n(16 << 24) | (128 << 16) | (16 << 8) | 128);\r\nsolo_reg_write(solo_dev, SOLO_VO_DISP_ERASE, SOLO_VO_DISP_ERASE_ON);\r\nsolo_reg_write(solo_dev, SOLO_VI_WIN_SW, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_ZOOM_CTRL, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_FREEZE_CTRL, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_DISP_CTRL, SOLO_VO_DISP_ON |\r\nSOLO_VO_DISP_ERASE_COUNT(8) |\r\nSOLO_VO_DISP_BASE(SOLO_DISP_EXT_ADDR));\r\nsolo_vout_config_cursor(solo_dev);\r\nsolo_reg_write(solo_dev, SOLO_VI_CH_ENA,\r\n(1 << solo_dev->nr_chans) - 1);\r\n}\r\nstatic int solo_dma_vin_region(struct solo_dev *solo_dev, u32 off,\r\nu16 val, int reg_size)\r\n{\r\nu16 *buf;\r\nconst int n = 64, size = n * sizeof(*buf);\r\nint i, ret = 0;\r\nbuf = kmalloc(size, GFP_KERNEL);\r\nif (!buf)\r\nreturn -ENOMEM;\r\nfor (i = 0; i < n; i++)\r\nbuf[i] = cpu_to_le16(val);\r\nfor (i = 0; i < reg_size; i += size) {\r\nret = solo_p2m_dma(solo_dev, 1, buf,\r\nSOLO_MOTION_EXT_ADDR(solo_dev) + off + i,\r\nsize, 0, 0);\r\nif (ret)\r\nbreak;\r\n}\r\nkfree(buf);\r\nreturn ret;\r\n}\r\nint solo_set_motion_threshold(struct solo_dev *solo_dev, u8 ch, u16 val)\r\n{\r\nif (ch > solo_dev->nr_chans)\r\nreturn -EINVAL;\r\nreturn solo_dma_vin_region(solo_dev, SOLO_MOT_FLAG_AREA +\r\n(ch * SOLO_MOT_THRESH_SIZE * 2),\r\nval, SOLO_MOT_THRESH_SIZE);\r\n}\r\nint solo_set_motion_block(struct solo_dev *solo_dev, u8 ch,\r\nconst struct solo_motion_thresholds *thresholds)\r\n{\r\nu32 off = SOLO_MOT_FLAG_AREA + ch * SOLO_MOT_THRESH_SIZE * 2;\r\nu16 buf[64];\r\nint x, y;\r\nint ret = 0;\r\nmemset(buf, 0, sizeof(buf));\r\nfor (y = 0; y < SOLO_MOTION_SZ; y++) {\r\nfor (x = 0; x < SOLO_MOTION_SZ; x++)\r\nbuf[x] = cpu_to_le16(thresholds->thresholds[y][x]);\r\nret |= solo_p2m_dma(solo_dev, 1, buf,\r\nSOLO_MOTION_EXT_ADDR(solo_dev) + off + y * sizeof(buf),\r\nsizeof(buf), 0, 0);\r\n}\r\nreturn ret;\r\n}\r\nstatic void solo_motion_config(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_dma_vin_region(solo_dev, i * SOLO_MOT_FLAG_SIZE, 0x0000,\r\nSOLO_MOT_FLAG_SIZE);\r\nsolo_dma_vin_region(solo_dev, SOLO_MOT_FLAG_AREA +\r\n(i * SOLO_MOT_THRESH_SIZE * 2) +\r\nSOLO_MOT_THRESH_SIZE, 0x0000,\r\nSOLO_MOT_THRESH_SIZE);\r\nsolo_set_motion_threshold(solo_dev, i, SOLO_DEF_MOT_THRESH);\r\n}\r\nsolo_reg_write(solo_dev, SOLO_VI_MOT_ADR, SOLO_VI_MOTION_EN(0) |\r\n(SOLO_MOTION_EXT_ADDR(solo_dev) >> 16));\r\nsolo_reg_write(solo_dev, SOLO_VI_MOT_CTRL,\r\nSOLO_VI_MOTION_FRAME_COUNT(3) |\r\nSOLO_VI_MOTION_SAMPLE_LENGTH(solo_dev->video_hsize / 16)\r\n| SOLO_VI_MOTION_SAMPLE_COUNT(10));\r\nsolo_reg_write(solo_dev, SOLO_VI_MOTION_BORDER, 0);\r\nsolo_reg_write(solo_dev, SOLO_VI_MOTION_BAR, 0);\r\n}\r\nint solo_disp_init(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nsolo_dev->video_hsize = 704;\r\nif (solo_dev->video_type == SOLO_VO_FMT_TYPE_NTSC) {\r\nsolo_dev->video_vsize = 240;\r\nsolo_dev->fps = 30;\r\n} else {\r\nsolo_dev->video_vsize = 288;\r\nsolo_dev->fps = 25;\r\n}\r\nsolo_vin_config(solo_dev);\r\nsolo_motion_config(solo_dev);\r\nsolo_vout_config(solo_dev);\r\nfor (i = 0; i < solo_dev->nr_chans; i++)\r\nsolo_reg_write(solo_dev, SOLO_VI_WIN_ON(i), 1);\r\nreturn 0;\r\n}\r\nvoid solo_disp_exit(struct solo_dev *solo_dev)\r\n{\r\nint i;\r\nsolo_reg_write(solo_dev, SOLO_VO_DISP_CTRL, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_ZOOM_CTRL, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_FREEZE_CTRL, 0);\r\nfor (i = 0; i < solo_dev->nr_chans; i++) {\r\nsolo_reg_write(solo_dev, SOLO_VI_WIN_CTRL0(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_VI_WIN_CTRL1(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_VI_WIN_ON(i), 0);\r\n}\r\nfor (i = 0; i < 5; i++)\r\nsolo_reg_write(solo_dev, SOLO_VO_BORDER_X(i), 0);\r\nfor (i = 0; i < 5; i++)\r\nsolo_reg_write(solo_dev, SOLO_VO_BORDER_Y(i), 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_BORDER_LINE_MASK, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_BORDER_FILL_MASK, 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_RECTANGLE_CTRL(0), 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_RECTANGLE_START(0), 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_RECTANGLE_STOP(0), 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_RECTANGLE_CTRL(1), 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_RECTANGLE_START(1), 0);\r\nsolo_reg_write(solo_dev, SOLO_VO_RECTANGLE_STOP(1), 0);\r\n}

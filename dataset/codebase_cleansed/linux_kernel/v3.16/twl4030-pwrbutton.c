static irqreturn_t powerbutton_irq(int irq, void *_pwr)\r\n{\r\nstruct input_dev *pwr = _pwr;\r\nint err;\r\nu8 value;\r\nerr = twl_i2c_read_u8(TWL_MODULE_PM_MASTER, &value, STS_HW_CONDITIONS);\r\nif (!err) {\r\npm_wakeup_event(pwr->dev.parent, 0);\r\ninput_report_key(pwr, KEY_POWER, value & PWR_PWRON_IRQ);\r\ninput_sync(pwr);\r\n} else {\r\ndev_err(pwr->dev.parent, "twl4030: i2c error %d while reading"\r\n" TWL4030 PM_MASTER STS_HW_CONDITIONS register\n", err);\r\n}\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int twl4030_pwrbutton_probe(struct platform_device *pdev)\r\n{\r\nstruct input_dev *pwr;\r\nint irq = platform_get_irq(pdev, 0);\r\nint err;\r\npwr = devm_input_allocate_device(&pdev->dev);\r\nif (!pwr) {\r\ndev_err(&pdev->dev, "Can't allocate power button\n");\r\nreturn -ENOMEM;\r\n}\r\npwr->evbit[0] = BIT_MASK(EV_KEY);\r\npwr->keybit[BIT_WORD(KEY_POWER)] = BIT_MASK(KEY_POWER);\r\npwr->name = "twl4030_pwrbutton";\r\npwr->phys = "twl4030_pwrbutton/input0";\r\npwr->dev.parent = &pdev->dev;\r\nerr = devm_request_threaded_irq(&pwr->dev, irq, NULL, powerbutton_irq,\r\nIRQF_TRIGGER_FALLING | IRQF_TRIGGER_RISING,\r\n"twl4030_pwrbutton", pwr);\r\nif (err < 0) {\r\ndev_err(&pdev->dev, "Can't get IRQ for pwrbutton: %d\n", err);\r\nreturn err;\r\n}\r\nerr = input_register_device(pwr);\r\nif (err) {\r\ndev_err(&pdev->dev, "Can't register power button: %d\n", err);\r\nreturn err;\r\n}\r\nplatform_set_drvdata(pdev, pwr);\r\nreturn 0;\r\n}

static int rcar_du_unload(struct drm_device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nif (rcdu->fbdev)\r\ndrm_fbdev_cma_fini(rcdu->fbdev);\r\ndrm_kms_helper_poll_fini(dev);\r\ndrm_mode_config_cleanup(dev);\r\ndrm_vblank_cleanup(dev);\r\ndev->irq_enabled = 0;\r\ndev->dev_private = NULL;\r\nreturn 0;\r\n}\r\nstatic int rcar_du_load(struct drm_device *dev, unsigned long flags)\r\n{\r\nstruct platform_device *pdev = dev->platformdev;\r\nstruct rcar_du_platform_data *pdata = pdev->dev.platform_data;\r\nstruct rcar_du_device *rcdu;\r\nstruct resource *mem;\r\nint ret;\r\nif (pdata == NULL) {\r\ndev_err(dev->dev, "no platform data\n");\r\nreturn -ENODEV;\r\n}\r\nrcdu = devm_kzalloc(&pdev->dev, sizeof(*rcdu), GFP_KERNEL);\r\nif (rcdu == NULL) {\r\ndev_err(dev->dev, "failed to allocate private data\n");\r\nreturn -ENOMEM;\r\n}\r\nrcdu->dev = &pdev->dev;\r\nrcdu->pdata = pdata;\r\nrcdu->info = (struct rcar_du_device_info *)pdev->id_entry->driver_data;\r\nrcdu->ddev = dev;\r\ndev->dev_private = rcdu;\r\nmem = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nrcdu->mmio = devm_ioremap_resource(&pdev->dev, mem);\r\nif (IS_ERR(rcdu->mmio))\r\nreturn PTR_ERR(rcdu->mmio);\r\nret = rcar_du_modeset_init(rcdu);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to initialize DRM/KMS\n");\r\ngoto done;\r\n}\r\nret = drm_vblank_init(dev, (1 << rcdu->num_crtcs) - 1);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "failed to initialize vblank\n");\r\ngoto done;\r\n}\r\ndev->irq_enabled = 1;\r\nplatform_set_drvdata(pdev, rcdu);\r\ndone:\r\nif (ret)\r\nrcar_du_unload(dev);\r\nreturn ret;\r\n}\r\nstatic void rcar_du_preclose(struct drm_device *dev, struct drm_file *file)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nunsigned int i;\r\nfor (i = 0; i < rcdu->num_crtcs; ++i)\r\nrcar_du_crtc_cancel_page_flip(&rcdu->crtcs[i], file);\r\n}\r\nstatic void rcar_du_lastclose(struct drm_device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\ndrm_fbdev_cma_restore_mode(rcdu->fbdev);\r\n}\r\nstatic int rcar_du_enable_vblank(struct drm_device *dev, int crtc)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nrcar_du_crtc_enable_vblank(&rcdu->crtcs[crtc], true);\r\nreturn 0;\r\n}\r\nstatic void rcar_du_disable_vblank(struct drm_device *dev, int crtc)\r\n{\r\nstruct rcar_du_device *rcdu = dev->dev_private;\r\nrcar_du_crtc_enable_vblank(&rcdu->crtcs[crtc], false);\r\n}\r\nstatic int rcar_du_pm_suspend(struct device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev_get_drvdata(dev);\r\ndrm_kms_helper_poll_disable(rcdu->ddev);\r\nreturn 0;\r\n}\r\nstatic int rcar_du_pm_resume(struct device *dev)\r\n{\r\nstruct rcar_du_device *rcdu = dev_get_drvdata(dev);\r\ndrm_kms_helper_poll_enable(rcdu->ddev);\r\nreturn 0;\r\n}\r\nstatic int rcar_du_probe(struct platform_device *pdev)\r\n{\r\nreturn drm_platform_init(&rcar_du_driver, pdev);\r\n}\r\nstatic int rcar_du_remove(struct platform_device *pdev)\r\n{\r\nstruct rcar_du_device *rcdu = platform_get_drvdata(pdev);\r\ndrm_put_dev(rcdu->ddev);\r\nreturn 0;\r\n}

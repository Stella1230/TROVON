static inline unsigned short from64to16(unsigned long x)\r\n{\r\nunion {\r\nunsigned long ul;\r\nunsigned int ui[2];\r\nunsigned short us[4];\r\n} in_v, tmp_v, out_v;\r\nin_v.ul = x;\r\ntmp_v.ul = (unsigned long) in_v.ui[0] + (unsigned long) in_v.ui[1];\r\nout_v.ul = (unsigned long) tmp_v.us[0] + (unsigned long) tmp_v.us[1]\r\n+ (unsigned long) tmp_v.us[2];\r\nreturn out_v.us[0] + out_v.us[1];\r\n}\r\nstatic inline unsigned long\r\ncsum_partial_cfu_aligned(const unsigned long __user *src, unsigned long *dst,\r\nlong len, unsigned long checksum,\r\nint *errp)\r\n{\r\nunsigned long carry = 0;\r\nint err = 0;\r\nwhile (len >= 0) {\r\nunsigned long word;\r\nerr |= __get_user(word, src);\r\nchecksum += carry;\r\nsrc++;\r\nchecksum += word;\r\nlen -= 8;\r\ncarry = checksum < word;\r\n*dst = word;\r\ndst++;\r\n}\r\nlen += 8;\r\nchecksum += carry;\r\nif (len) {\r\nunsigned long word, tmp;\r\nerr |= __get_user(word, src);\r\ntmp = *dst;\r\nmskql(word, len, word);\r\nchecksum += word;\r\nmskqh(tmp, len, tmp);\r\ncarry = checksum < word;\r\n*dst = word | tmp;\r\nchecksum += carry;\r\n}\r\nif (err && errp) *errp = err;\r\nreturn checksum;\r\n}\r\nstatic inline unsigned long\r\ncsum_partial_cfu_dest_aligned(const unsigned long __user *src,\r\nunsigned long *dst,\r\nunsigned long soff,\r\nlong len, unsigned long checksum,\r\nint *errp)\r\n{\r\nunsigned long first;\r\nunsigned long word, carry;\r\nunsigned long lastsrc = 7+len+(unsigned long)src;\r\nint err = 0;\r\nerr |= __get_user_u(first,src);\r\ncarry = 0;\r\nwhile (len >= 0) {\r\nunsigned long second;\r\nerr |= __get_user_u(second, src+1);\r\nextql(first, soff, word);\r\nlen -= 8;\r\nsrc++;\r\nextqh(second, soff, first);\r\nchecksum += carry;\r\nword |= first;\r\nfirst = second;\r\nchecksum += word;\r\n*dst = word;\r\ndst++;\r\ncarry = checksum < word;\r\n}\r\nlen += 8;\r\nchecksum += carry;\r\nif (len) {\r\nunsigned long tmp;\r\nunsigned long second;\r\nerr |= __get_user_u(second, lastsrc);\r\ntmp = *dst;\r\nextql(first, soff, word);\r\nextqh(second, soff, first);\r\nword |= first;\r\nmskql(word, len, word);\r\nchecksum += word;\r\nmskqh(tmp, len, tmp);\r\ncarry = checksum < word;\r\n*dst = word | tmp;\r\nchecksum += carry;\r\n}\r\nif (err && errp) *errp = err;\r\nreturn checksum;\r\n}\r\nstatic inline unsigned long\r\ncsum_partial_cfu_src_aligned(const unsigned long __user *src,\r\nunsigned long *dst,\r\nunsigned long doff,\r\nlong len, unsigned long checksum,\r\nunsigned long partial_dest,\r\nint *errp)\r\n{\r\nunsigned long carry = 0;\r\nunsigned long word;\r\nunsigned long second_dest;\r\nint err = 0;\r\nmskql(partial_dest, doff, partial_dest);\r\nwhile (len >= 0) {\r\nerr |= __get_user(word, src);\r\nlen -= 8;\r\ninsql(word, doff, second_dest);\r\nchecksum += carry;\r\nstq_u(partial_dest | second_dest, dst);\r\nsrc++;\r\nchecksum += word;\r\ninsqh(word, doff, partial_dest);\r\ncarry = checksum < word;\r\ndst++;\r\n}\r\nlen += 8;\r\nif (len) {\r\nchecksum += carry;\r\nerr |= __get_user(word, src);\r\nmskql(word, len, word);\r\nlen -= 8;\r\nchecksum += word;\r\ninsql(word, doff, second_dest);\r\nlen += doff;\r\ncarry = checksum < word;\r\npartial_dest |= second_dest;\r\nif (len >= 0) {\r\nstq_u(partial_dest, dst);\r\nif (!len) goto out;\r\ndst++;\r\ninsqh(word, doff, partial_dest);\r\n}\r\ndoff = len;\r\n}\r\nldq_u(second_dest, dst);\r\nmskqh(second_dest, doff, second_dest);\r\nstq_u(partial_dest | second_dest, dst);\r\nout:\r\nchecksum += carry;\r\nif (err && errp) *errp = err;\r\nreturn checksum;\r\n}\r\nstatic inline unsigned long\r\ncsum_partial_cfu_unaligned(const unsigned long __user * src,\r\nunsigned long * dst,\r\nunsigned long soff, unsigned long doff,\r\nlong len, unsigned long checksum,\r\nunsigned long partial_dest,\r\nint *errp)\r\n{\r\nunsigned long carry = 0;\r\nunsigned long first;\r\nunsigned long lastsrc;\r\nint err = 0;\r\nerr |= __get_user_u(first, src);\r\nlastsrc = 7+len+(unsigned long)src;\r\nmskql(partial_dest, doff, partial_dest);\r\nwhile (len >= 0) {\r\nunsigned long second, word;\r\nunsigned long second_dest;\r\nerr |= __get_user_u(second, src+1);\r\nextql(first, soff, word);\r\nchecksum += carry;\r\nlen -= 8;\r\nextqh(second, soff, first);\r\nsrc++;\r\nword |= first;\r\nfirst = second;\r\ninsql(word, doff, second_dest);\r\nchecksum += word;\r\nstq_u(partial_dest | second_dest, dst);\r\ncarry = checksum < word;\r\ninsqh(word, doff, partial_dest);\r\ndst++;\r\n}\r\nlen += doff;\r\nchecksum += carry;\r\nif (len >= 0) {\r\nunsigned long second, word;\r\nunsigned long second_dest;\r\nerr |= __get_user_u(second, lastsrc);\r\nextql(first, soff, word);\r\nextqh(second, soff, first);\r\nword |= first;\r\nfirst = second;\r\nmskql(word, len-doff, word);\r\nchecksum += word;\r\ninsql(word, doff, second_dest);\r\ncarry = checksum < word;\r\nstq_u(partial_dest | second_dest, dst);\r\nif (len) {\r\nldq_u(second_dest, dst+1);\r\ninsqh(word, doff, partial_dest);\r\nmskqh(second_dest, len, second_dest);\r\nstq_u(partial_dest | second_dest, dst+1);\r\n}\r\nchecksum += carry;\r\n} else {\r\nunsigned long second, word;\r\nunsigned long second_dest;\r\nerr |= __get_user_u(second, lastsrc);\r\nextql(first, soff, word);\r\nextqh(second, soff, first);\r\nword |= first;\r\nldq_u(second_dest, dst);\r\nmskql(word, len-doff, word);\r\nchecksum += word;\r\nmskqh(second_dest, len, second_dest);\r\ncarry = checksum < word;\r\ninsql(word, doff, word);\r\nstq_u(partial_dest | word | second_dest, dst);\r\nchecksum += carry;\r\n}\r\nif (err && errp) *errp = err;\r\nreturn checksum;\r\n}\r\n__wsum\r\ncsum_partial_copy_from_user(const void __user *src, void *dst, int len,\r\n__wsum sum, int *errp)\r\n{\r\nunsigned long checksum = (__force u32) sum;\r\nunsigned long soff = 7 & (unsigned long) src;\r\nunsigned long doff = 7 & (unsigned long) dst;\r\nif (len) {\r\nif (!access_ok(VERIFY_READ, src, len)) {\r\nif (errp) *errp = -EFAULT;\r\nmemset(dst, 0, len);\r\nreturn sum;\r\n}\r\nif (!doff) {\r\nif (!soff)\r\nchecksum = csum_partial_cfu_aligned(\r\n(const unsigned long __user *) src,\r\n(unsigned long *) dst,\r\nlen-8, checksum, errp);\r\nelse\r\nchecksum = csum_partial_cfu_dest_aligned(\r\n(const unsigned long __user *) src,\r\n(unsigned long *) dst,\r\nsoff, len-8, checksum, errp);\r\n} else {\r\nunsigned long partial_dest;\r\nldq_u(partial_dest, dst);\r\nif (!soff)\r\nchecksum = csum_partial_cfu_src_aligned(\r\n(const unsigned long __user *) src,\r\n(unsigned long *) dst,\r\ndoff, len-8, checksum,\r\npartial_dest, errp);\r\nelse\r\nchecksum = csum_partial_cfu_unaligned(\r\n(const unsigned long __user *) src,\r\n(unsigned long *) dst,\r\nsoff, doff, len-8, checksum,\r\npartial_dest, errp);\r\n}\r\nchecksum = from64to16 (checksum);\r\n}\r\nreturn (__force __wsum)checksum;\r\n}\r\n__wsum\r\ncsum_partial_copy_nocheck(const void *src, void *dst, int len, __wsum sum)\r\n{\r\n__wsum checksum;\r\nmm_segment_t oldfs = get_fs();\r\nset_fs(KERNEL_DS);\r\nchecksum = csum_partial_copy_from_user((__force const void __user *)src,\r\ndst, len, sum, NULL);\r\nset_fs(oldfs);\r\nreturn checksum;\r\n}

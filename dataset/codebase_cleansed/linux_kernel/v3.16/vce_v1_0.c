uint32_t vce_v1_0_get_rptr(struct radeon_device *rdev,\r\nstruct radeon_ring *ring)\r\n{\r\nif (ring->idx == TN_RING_TYPE_VCE1_INDEX)\r\nreturn RREG32(VCE_RB_RPTR);\r\nelse\r\nreturn RREG32(VCE_RB_RPTR2);\r\n}\r\nuint32_t vce_v1_0_get_wptr(struct radeon_device *rdev,\r\nstruct radeon_ring *ring)\r\n{\r\nif (ring->idx == TN_RING_TYPE_VCE1_INDEX)\r\nreturn RREG32(VCE_RB_WPTR);\r\nelse\r\nreturn RREG32(VCE_RB_WPTR2);\r\n}\r\nvoid vce_v1_0_set_wptr(struct radeon_device *rdev,\r\nstruct radeon_ring *ring)\r\n{\r\nif (ring->idx == TN_RING_TYPE_VCE1_INDEX)\r\nWREG32(VCE_RB_WPTR, ring->wptr);\r\nelse\r\nWREG32(VCE_RB_WPTR2, ring->wptr);\r\n}\r\nint vce_v1_0_start(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring;\r\nint i, j, r;\r\nWREG32_P(VCE_STATUS, 1, ~1);\r\nring = &rdev->ring[TN_RING_TYPE_VCE1_INDEX];\r\nWREG32(VCE_RB_RPTR, ring->wptr);\r\nWREG32(VCE_RB_WPTR, ring->wptr);\r\nWREG32(VCE_RB_BASE_LO, ring->gpu_addr);\r\nWREG32(VCE_RB_BASE_HI, upper_32_bits(ring->gpu_addr));\r\nWREG32(VCE_RB_SIZE, ring->ring_size / 4);\r\nring = &rdev->ring[TN_RING_TYPE_VCE2_INDEX];\r\nWREG32(VCE_RB_RPTR2, ring->wptr);\r\nWREG32(VCE_RB_WPTR2, ring->wptr);\r\nWREG32(VCE_RB_BASE_LO2, ring->gpu_addr);\r\nWREG32(VCE_RB_BASE_HI2, upper_32_bits(ring->gpu_addr));\r\nWREG32(VCE_RB_SIZE2, ring->ring_size / 4);\r\nWREG32_P(VCE_VCPU_CNTL, VCE_CLK_EN, ~VCE_CLK_EN);\r\nWREG32_P(VCE_SOFT_RESET,\r\nVCE_ECPU_SOFT_RESET |\r\nVCE_FME_SOFT_RESET, ~(\r\nVCE_ECPU_SOFT_RESET |\r\nVCE_FME_SOFT_RESET));\r\nmdelay(100);\r\nWREG32_P(VCE_SOFT_RESET, 0, ~(\r\nVCE_ECPU_SOFT_RESET |\r\nVCE_FME_SOFT_RESET));\r\nfor (i = 0; i < 10; ++i) {\r\nuint32_t status;\r\nfor (j = 0; j < 100; ++j) {\r\nstatus = RREG32(VCE_STATUS);\r\nif (status & 2)\r\nbreak;\r\nmdelay(10);\r\n}\r\nr = 0;\r\nif (status & 2)\r\nbreak;\r\nDRM_ERROR("VCE not responding, trying to reset the ECPU!!!\n");\r\nWREG32_P(VCE_SOFT_RESET, VCE_ECPU_SOFT_RESET, ~VCE_ECPU_SOFT_RESET);\r\nmdelay(10);\r\nWREG32_P(VCE_SOFT_RESET, 0, ~VCE_ECPU_SOFT_RESET);\r\nmdelay(10);\r\nr = -1;\r\n}\r\nWREG32_P(VCE_STATUS, 0, ~1);\r\nif (r) {\r\nDRM_ERROR("VCE not responding, giving up!!!\n");\r\nreturn r;\r\n}\r\nreturn 0;\r\n}\r\nint vce_v1_0_init(struct radeon_device *rdev)\r\n{\r\nstruct radeon_ring *ring;\r\nint r;\r\nr = vce_v1_0_start(rdev);\r\nif (r)\r\nreturn r;\r\nring = &rdev->ring[TN_RING_TYPE_VCE1_INDEX];\r\nring->ready = true;\r\nr = radeon_ring_test(rdev, TN_RING_TYPE_VCE1_INDEX, ring);\r\nif (r) {\r\nring->ready = false;\r\nreturn r;\r\n}\r\nring = &rdev->ring[TN_RING_TYPE_VCE2_INDEX];\r\nring->ready = true;\r\nr = radeon_ring_test(rdev, TN_RING_TYPE_VCE2_INDEX, ring);\r\nif (r) {\r\nring->ready = false;\r\nreturn r;\r\n}\r\nDRM_INFO("VCE initialized successfully.\n");\r\nreturn 0;\r\n}

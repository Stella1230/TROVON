static void watchdog_fire(int irq, void *dev_id)\r\n{\r\npr_crit("Would Reboot\n");\r\n*CSR_TIMER4_CNTL = 0;\r\n*CSR_TIMER4_CLR = 0;\r\n}\r\nstatic void watchdog_ping(void)\r\n{\r\n*CSR_TIMER4_LOAD = reload;\r\n}\r\nstatic int watchdog_open(struct inode *inode, struct file *file)\r\n{\r\nint ret;\r\nif (*CSR_SA110_CNTL & (1 << 13))\r\nreturn -EBUSY;\r\nif (test_and_set_bit(1, &timer_alive))\r\nreturn -EBUSY;\r\nreload = soft_margin * (mem_fclk_21285 / 256);\r\n*CSR_TIMER4_CLR = 0;\r\nwatchdog_ping();\r\n*CSR_TIMER4_CNTL = TIMER_CNTL_ENABLE | TIMER_CNTL_AUTORELOAD\r\n| TIMER_CNTL_DIV256;\r\n#ifdef ONLY_TESTING\r\nret = request_irq(IRQ_TIMER4, watchdog_fire, 0, "watchdog", NULL);\r\nif (ret) {\r\n*CSR_TIMER4_CNTL = 0;\r\nclear_bit(1, &timer_alive);\r\n}\r\n#else\r\n*CSR_SA110_CNTL |= 1 << 13;\r\nret = 0;\r\n#endif\r\nnonseekable_open(inode, file);\r\nreturn ret;\r\n}\r\nstatic int watchdog_release(struct inode *inode, struct file *file)\r\n{\r\n#ifdef ONLY_TESTING\r\nfree_irq(IRQ_TIMER4, NULL);\r\nclear_bit(1, &timer_alive);\r\n#endif\r\nreturn 0;\r\n}\r\nstatic ssize_t watchdog_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nif (len)\r\nwatchdog_ping();\r\nreturn len;\r\n}\r\nstatic long watchdog_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nint __user *int_arg = (int __user *)arg;\r\nint new_margin, ret = -ENOTTY;\r\nswitch (cmd) {\r\ncase WDIOC_GETSUPPORT:\r\nret = 0;\r\nif (copy_to_user((void __user *)arg, &ident, sizeof(ident)))\r\nret = -EFAULT;\r\nbreak;\r\ncase WDIOC_GETSTATUS:\r\ncase WDIOC_GETBOOTSTATUS:\r\nret = put_user(0, int_arg);\r\nbreak;\r\ncase WDIOC_KEEPALIVE:\r\nwatchdog_ping();\r\nret = 0;\r\nbreak;\r\ncase WDIOC_SETTIMEOUT:\r\nret = get_user(new_margin, int_arg);\r\nif (ret)\r\nbreak;\r\nif (new_margin < 0 || new_margin > 60) {\r\nret = -EINVAL;\r\nbreak;\r\n}\r\nsoft_margin = new_margin;\r\nreload = soft_margin * (mem_fclk_21285 / 256);\r\nwatchdog_ping();\r\ncase WDIOC_GETTIMEOUT:\r\nret = put_user(soft_margin, int_arg);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __init footbridge_watchdog_init(void)\r\n{\r\nint retval;\r\nif (machine_is_netwinder())\r\nreturn -ENODEV;\r\nretval = misc_register(&watchdog_miscdev);\r\nif (retval < 0)\r\nreturn retval;\r\npr_info("Footbridge Watchdog Timer: 0.01, timer margin: %d sec\n",\r\nsoft_margin);\r\nif (machine_is_cats())\r\npr_warn("Warning: Watchdog reset may not work on this machine\n");\r\nreturn 0;\r\n}\r\nstatic void __exit footbridge_watchdog_exit(void)\r\n{\r\nmisc_deregister(&watchdog_miscdev);\r\n}

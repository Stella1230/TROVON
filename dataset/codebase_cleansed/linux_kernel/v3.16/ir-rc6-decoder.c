static enum rc6_mode rc6_mode(struct rc6_dec *data)\r\n{\r\nswitch (data->header & RC6_MODE_MASK) {\r\ncase 0:\r\nreturn RC6_MODE_0;\r\ncase 6:\r\nif (!data->toggle)\r\nreturn RC6_MODE_6A;\r\ndefault:\r\nreturn RC6_MODE_UNKNOWN;\r\n}\r\n}\r\nstatic int ir_rc6_decode(struct rc_dev *dev, struct ir_raw_event ev)\r\n{\r\nstruct rc6_dec *data = &dev->raw->rc6;\r\nu32 scancode;\r\nu8 toggle;\r\nif (!rc_protocols_enabled(dev, RC_BIT_RC6_0 | RC_BIT_RC6_6A_20 |\r\nRC_BIT_RC6_6A_24 | RC_BIT_RC6_6A_32 |\r\nRC_BIT_RC6_MCE))\r\nreturn 0;\r\nif (!is_timing_event(ev)) {\r\nif (ev.reset)\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nif (!geq_margin(ev.duration, RC6_UNIT, RC6_UNIT / 2))\r\ngoto out;\r\nagain:\r\nIR_dprintk(2, "RC6 decode started at state %i (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\nif (!geq_margin(ev.duration, RC6_UNIT, RC6_UNIT / 2))\r\nreturn 0;\r\nswitch (data->state) {\r\ncase STATE_INACTIVE:\r\nif (!ev.pulse)\r\nbreak;\r\nif (!eq_margin(ev.duration, RC6_PREFIX_PULSE, RC6_UNIT))\r\nbreak;\r\ndata->state = STATE_PREFIX_SPACE;\r\ndata->count = 0;\r\nreturn 0;\r\ncase STATE_PREFIX_SPACE:\r\nif (ev.pulse)\r\nbreak;\r\nif (!eq_margin(ev.duration, RC6_PREFIX_SPACE, RC6_UNIT / 2))\r\nbreak;\r\ndata->state = STATE_HEADER_BIT_START;\r\ndata->header = 0;\r\nreturn 0;\r\ncase STATE_HEADER_BIT_START:\r\nif (!eq_margin(ev.duration, RC6_BIT_START, RC6_UNIT / 2))\r\nbreak;\r\ndata->header <<= 1;\r\nif (ev.pulse)\r\ndata->header |= 1;\r\ndata->count++;\r\ndata->state = STATE_HEADER_BIT_END;\r\nreturn 0;\r\ncase STATE_HEADER_BIT_END:\r\nif (!is_transition(&ev, &dev->raw->prev_ev))\r\nbreak;\r\nif (data->count == RC6_HEADER_NBITS)\r\ndata->state = STATE_TOGGLE_START;\r\nelse\r\ndata->state = STATE_HEADER_BIT_START;\r\ndecrease_duration(&ev, RC6_BIT_END);\r\ngoto again;\r\ncase STATE_TOGGLE_START:\r\nif (!eq_margin(ev.duration, RC6_TOGGLE_START, RC6_UNIT / 2))\r\nbreak;\r\ndata->toggle = ev.pulse;\r\ndata->state = STATE_TOGGLE_END;\r\nreturn 0;\r\ncase STATE_TOGGLE_END:\r\nif (!is_transition(&ev, &dev->raw->prev_ev) ||\r\n!geq_margin(ev.duration, RC6_TOGGLE_END, RC6_UNIT / 2))\r\nbreak;\r\nif (!(data->header & RC6_STARTBIT_MASK)) {\r\nIR_dprintk(1, "RC6 invalid start bit\n");\r\nbreak;\r\n}\r\ndata->state = STATE_BODY_BIT_START;\r\ndecrease_duration(&ev, RC6_TOGGLE_END);\r\ndata->count = 0;\r\ndata->body = 0;\r\nswitch (rc6_mode(data)) {\r\ncase RC6_MODE_0:\r\ndata->wanted_bits = RC6_0_NBITS;\r\nbreak;\r\ncase RC6_MODE_6A:\r\ndata->wanted_bits = RC6_6A_NBITS;\r\nbreak;\r\ndefault:\r\nIR_dprintk(1, "RC6 unknown mode\n");\r\ngoto out;\r\n}\r\ngoto again;\r\ncase STATE_BODY_BIT_START:\r\nif (eq_margin(ev.duration, RC6_BIT_START, RC6_UNIT / 2)) {\r\nif (data->count++ < CHAR_BIT * sizeof data->body) {\r\ndata->body <<= 1;\r\nif (ev.pulse)\r\ndata->body |= 1;\r\n}\r\ndata->state = STATE_BODY_BIT_END;\r\nreturn 0;\r\n} else if (RC6_MODE_6A == rc6_mode(data) && !ev.pulse &&\r\ngeq_margin(ev.duration, RC6_SUFFIX_SPACE, RC6_UNIT / 2)) {\r\ndata->state = STATE_FINISHED;\r\ngoto again;\r\n}\r\nbreak;\r\ncase STATE_BODY_BIT_END:\r\nif (!is_transition(&ev, &dev->raw->prev_ev))\r\nbreak;\r\nif (data->count == data->wanted_bits)\r\ndata->state = STATE_FINISHED;\r\nelse\r\ndata->state = STATE_BODY_BIT_START;\r\ndecrease_duration(&ev, RC6_BIT_END);\r\ngoto again;\r\ncase STATE_FINISHED:\r\nif (ev.pulse)\r\nbreak;\r\nswitch (rc6_mode(data)) {\r\ncase RC6_MODE_0:\r\nscancode = data->body;\r\ntoggle = data->toggle;\r\nIR_dprintk(1, "RC6(0) scancode 0x%04x (toggle: %u)\n",\r\nscancode, toggle);\r\nbreak;\r\ncase RC6_MODE_6A:\r\nif (data->count > CHAR_BIT * sizeof data->body) {\r\nIR_dprintk(1, "RC6 too many (%u) data bits\n",\r\ndata->count);\r\ngoto out;\r\n}\r\nscancode = data->body;\r\nif (data->count == RC6_6A_32_NBITS &&\r\n(scancode & RC6_6A_LCC_MASK) == RC6_6A_MCE_CC) {\r\ntoggle = (scancode & RC6_6A_MCE_TOGGLE_MASK) ? 1 : 0;\r\nscancode &= ~RC6_6A_MCE_TOGGLE_MASK;\r\n} else {\r\ntoggle = 0;\r\n}\r\nIR_dprintk(1, "RC6(6A) scancode 0x%08x (toggle: %u)\n",\r\nscancode, toggle);\r\nbreak;\r\ndefault:\r\nIR_dprintk(1, "RC6 unknown mode\n");\r\ngoto out;\r\n}\r\nrc_keydown(dev, scancode, toggle);\r\ndata->state = STATE_INACTIVE;\r\nreturn 0;\r\n}\r\nout:\r\nIR_dprintk(1, "RC6 decode failed at state %i (%uus %s)\n",\r\ndata->state, TO_US(ev.duration), TO_STR(ev.pulse));\r\ndata->state = STATE_INACTIVE;\r\nreturn -EINVAL;\r\n}\r\nstatic int __init ir_rc6_decode_init(void)\r\n{\r\nir_raw_handler_register(&rc6_handler);\r\nprintk(KERN_INFO "IR RC6 protocol handler initialized\n");\r\nreturn 0;\r\n}\r\nstatic void __exit ir_rc6_decode_exit(void)\r\n{\r\nir_raw_handler_unregister(&rc6_handler);\r\n}

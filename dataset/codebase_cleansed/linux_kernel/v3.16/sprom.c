int bcma_arch_register_fallback_sprom(int (*sprom_callback)(struct bcma_bus *bus,\r\nstruct ssb_sprom *out))\r\n{\r\nif (get_fallback_sprom)\r\nreturn -EEXIST;\r\nget_fallback_sprom = sprom_callback;\r\nreturn 0;\r\n}\r\nstatic int bcma_fill_sprom_with_fallback(struct bcma_bus *bus,\r\nstruct ssb_sprom *out)\r\n{\r\nint err;\r\nif (!get_fallback_sprom) {\r\nerr = -ENOENT;\r\ngoto fail;\r\n}\r\nerr = get_fallback_sprom(bus, out);\r\nif (err)\r\ngoto fail;\r\nbcma_debug(bus, "Using SPROM revision %d provided by platform.\n",\r\nbus->sprom.revision);\r\nreturn 0;\r\nfail:\r\nbcma_warn(bus, "Using fallback SPROM failed (err %d)\n", err);\r\nreturn err;\r\n}\r\nstatic void bcma_sprom_read(struct bcma_bus *bus, u16 offset, u16 *sprom,\r\nsize_t words)\r\n{\r\nint i;\r\nfor (i = 0; i < words; i++)\r\nsprom[i] = bcma_read16(bus->drv_cc.core, offset + (i * 2));\r\n}\r\nstatic inline u8 bcma_crc8(u8 crc, u8 data)\r\n{\r\nstatic const u8 t[] = {\r\n0x00, 0xF7, 0xB9, 0x4E, 0x25, 0xD2, 0x9C, 0x6B,\r\n0x4A, 0xBD, 0xF3, 0x04, 0x6F, 0x98, 0xD6, 0x21,\r\n0x94, 0x63, 0x2D, 0xDA, 0xB1, 0x46, 0x08, 0xFF,\r\n0xDE, 0x29, 0x67, 0x90, 0xFB, 0x0C, 0x42, 0xB5,\r\n0x7F, 0x88, 0xC6, 0x31, 0x5A, 0xAD, 0xE3, 0x14,\r\n0x35, 0xC2, 0x8C, 0x7B, 0x10, 0xE7, 0xA9, 0x5E,\r\n0xEB, 0x1C, 0x52, 0xA5, 0xCE, 0x39, 0x77, 0x80,\r\n0xA1, 0x56, 0x18, 0xEF, 0x84, 0x73, 0x3D, 0xCA,\r\n0xFE, 0x09, 0x47, 0xB0, 0xDB, 0x2C, 0x62, 0x95,\r\n0xB4, 0x43, 0x0D, 0xFA, 0x91, 0x66, 0x28, 0xDF,\r\n0x6A, 0x9D, 0xD3, 0x24, 0x4F, 0xB8, 0xF6, 0x01,\r\n0x20, 0xD7, 0x99, 0x6E, 0x05, 0xF2, 0xBC, 0x4B,\r\n0x81, 0x76, 0x38, 0xCF, 0xA4, 0x53, 0x1D, 0xEA,\r\n0xCB, 0x3C, 0x72, 0x85, 0xEE, 0x19, 0x57, 0xA0,\r\n0x15, 0xE2, 0xAC, 0x5B, 0x30, 0xC7, 0x89, 0x7E,\r\n0x5F, 0xA8, 0xE6, 0x11, 0x7A, 0x8D, 0xC3, 0x34,\r\n0xAB, 0x5C, 0x12, 0xE5, 0x8E, 0x79, 0x37, 0xC0,\r\n0xE1, 0x16, 0x58, 0xAF, 0xC4, 0x33, 0x7D, 0x8A,\r\n0x3F, 0xC8, 0x86, 0x71, 0x1A, 0xED, 0xA3, 0x54,\r\n0x75, 0x82, 0xCC, 0x3B, 0x50, 0xA7, 0xE9, 0x1E,\r\n0xD4, 0x23, 0x6D, 0x9A, 0xF1, 0x06, 0x48, 0xBF,\r\n0x9E, 0x69, 0x27, 0xD0, 0xBB, 0x4C, 0x02, 0xF5,\r\n0x40, 0xB7, 0xF9, 0x0E, 0x65, 0x92, 0xDC, 0x2B,\r\n0x0A, 0xFD, 0xB3, 0x44, 0x2F, 0xD8, 0x96, 0x61,\r\n0x55, 0xA2, 0xEC, 0x1B, 0x70, 0x87, 0xC9, 0x3E,\r\n0x1F, 0xE8, 0xA6, 0x51, 0x3A, 0xCD, 0x83, 0x74,\r\n0xC1, 0x36, 0x78, 0x8F, 0xE4, 0x13, 0x5D, 0xAA,\r\n0x8B, 0x7C, 0x32, 0xC5, 0xAE, 0x59, 0x17, 0xE0,\r\n0x2A, 0xDD, 0x93, 0x64, 0x0F, 0xF8, 0xB6, 0x41,\r\n0x60, 0x97, 0xD9, 0x2E, 0x45, 0xB2, 0xFC, 0x0B,\r\n0xBE, 0x49, 0x07, 0xF0, 0x9B, 0x6C, 0x22, 0xD5,\r\n0xF4, 0x03, 0x4D, 0xBA, 0xD1, 0x26, 0x68, 0x9F,\r\n};\r\nreturn t[crc ^ data];\r\n}\r\nstatic u8 bcma_sprom_crc(const u16 *sprom, size_t words)\r\n{\r\nint word;\r\nu8 crc = 0xFF;\r\nfor (word = 0; word < words - 1; word++) {\r\ncrc = bcma_crc8(crc, sprom[word] & 0x00FF);\r\ncrc = bcma_crc8(crc, (sprom[word] & 0xFF00) >> 8);\r\n}\r\ncrc = bcma_crc8(crc, sprom[words - 1] & 0x00FF);\r\ncrc ^= 0xFF;\r\nreturn crc;\r\n}\r\nstatic int bcma_sprom_check_crc(const u16 *sprom, size_t words)\r\n{\r\nu8 crc;\r\nu8 expected_crc;\r\nu16 tmp;\r\ncrc = bcma_sprom_crc(sprom, words);\r\ntmp = sprom[words - 1] & SSB_SPROM_REVISION_CRC;\r\nexpected_crc = tmp >> SSB_SPROM_REVISION_CRC_SHIFT;\r\nif (crc != expected_crc)\r\nreturn -EPROTO;\r\nreturn 0;\r\n}\r\nstatic int bcma_sprom_valid(struct bcma_bus *bus, const u16 *sprom,\r\nsize_t words)\r\n{\r\nu16 revision;\r\nint err;\r\nerr = bcma_sprom_check_crc(sprom, words);\r\nif (err)\r\nreturn err;\r\nrevision = sprom[words - 1] & SSB_SPROM_REVISION_REV;\r\nif (revision != 8 && revision != 9 && revision != 10) {\r\npr_err("Unsupported SPROM revision: %d\n", revision);\r\nreturn -ENOENT;\r\n}\r\nbus->sprom.revision = revision;\r\nbcma_debug(bus, "Found SPROM revision %d\n", revision);\r\nreturn 0;\r\n}\r\nstatic void bcma_sprom_extract_r8(struct bcma_bus *bus, const u16 *sprom)\r\n{\r\nu16 v, o;\r\nint i;\r\nu16 pwr_info_offset[] = {\r\nSSB_SROM8_PWR_INFO_CORE0, SSB_SROM8_PWR_INFO_CORE1,\r\nSSB_SROM8_PWR_INFO_CORE2, SSB_SROM8_PWR_INFO_CORE3\r\n};\r\nBUILD_BUG_ON(ARRAY_SIZE(pwr_info_offset) !=\r\nARRAY_SIZE(bus->sprom.core_pwr_info));\r\nfor (i = 0; i < 3; i++) {\r\nv = sprom[SPOFF(SSB_SPROM8_IL0MAC) + i];\r\n*(((__be16 *)bus->sprom.il0mac) + i) = cpu_to_be16(v);\r\n}\r\nSPEX(board_rev, SSB_SPROM8_BOARDREV, ~0, 0);\r\nSPEX(board_type, SSB_SPROM1_SPID, ~0, 0);\r\nSPEX(txpid2g[0], SSB_SPROM4_TXPID2G01, SSB_SPROM4_TXPID2G0,\r\nSSB_SPROM4_TXPID2G0_SHIFT);\r\nSPEX(txpid2g[1], SSB_SPROM4_TXPID2G01, SSB_SPROM4_TXPID2G1,\r\nSSB_SPROM4_TXPID2G1_SHIFT);\r\nSPEX(txpid2g[2], SSB_SPROM4_TXPID2G23, SSB_SPROM4_TXPID2G2,\r\nSSB_SPROM4_TXPID2G2_SHIFT);\r\nSPEX(txpid2g[3], SSB_SPROM4_TXPID2G23, SSB_SPROM4_TXPID2G3,\r\nSSB_SPROM4_TXPID2G3_SHIFT);\r\nSPEX(txpid5gl[0], SSB_SPROM4_TXPID5GL01, SSB_SPROM4_TXPID5GL0,\r\nSSB_SPROM4_TXPID5GL0_SHIFT);\r\nSPEX(txpid5gl[1], SSB_SPROM4_TXPID5GL01, SSB_SPROM4_TXPID5GL1,\r\nSSB_SPROM4_TXPID5GL1_SHIFT);\r\nSPEX(txpid5gl[2], SSB_SPROM4_TXPID5GL23, SSB_SPROM4_TXPID5GL2,\r\nSSB_SPROM4_TXPID5GL2_SHIFT);\r\nSPEX(txpid5gl[3], SSB_SPROM4_TXPID5GL23, SSB_SPROM4_TXPID5GL3,\r\nSSB_SPROM4_TXPID5GL3_SHIFT);\r\nSPEX(txpid5g[0], SSB_SPROM4_TXPID5G01, SSB_SPROM4_TXPID5G0,\r\nSSB_SPROM4_TXPID5G0_SHIFT);\r\nSPEX(txpid5g[1], SSB_SPROM4_TXPID5G01, SSB_SPROM4_TXPID5G1,\r\nSSB_SPROM4_TXPID5G1_SHIFT);\r\nSPEX(txpid5g[2], SSB_SPROM4_TXPID5G23, SSB_SPROM4_TXPID5G2,\r\nSSB_SPROM4_TXPID5G2_SHIFT);\r\nSPEX(txpid5g[3], SSB_SPROM4_TXPID5G23, SSB_SPROM4_TXPID5G3,\r\nSSB_SPROM4_TXPID5G3_SHIFT);\r\nSPEX(txpid5gh[0], SSB_SPROM4_TXPID5GH01, SSB_SPROM4_TXPID5GH0,\r\nSSB_SPROM4_TXPID5GH0_SHIFT);\r\nSPEX(txpid5gh[1], SSB_SPROM4_TXPID5GH01, SSB_SPROM4_TXPID5GH1,\r\nSSB_SPROM4_TXPID5GH1_SHIFT);\r\nSPEX(txpid5gh[2], SSB_SPROM4_TXPID5GH23, SSB_SPROM4_TXPID5GH2,\r\nSSB_SPROM4_TXPID5GH2_SHIFT);\r\nSPEX(txpid5gh[3], SSB_SPROM4_TXPID5GH23, SSB_SPROM4_TXPID5GH3,\r\nSSB_SPROM4_TXPID5GH3_SHIFT);\r\nSPEX(boardflags_lo, SSB_SPROM8_BFLLO, ~0, 0);\r\nSPEX(boardflags_hi, SSB_SPROM8_BFLHI, ~0, 0);\r\nSPEX(boardflags2_lo, SSB_SPROM8_BFL2LO, ~0, 0);\r\nSPEX(boardflags2_hi, SSB_SPROM8_BFL2HI, ~0, 0);\r\nSPEX(alpha2[0], SSB_SPROM8_CCODE, 0xff00, 8);\r\nSPEX(alpha2[1], SSB_SPROM8_CCODE, 0x00ff, 0);\r\nfor (i = 0; i < ARRAY_SIZE(pwr_info_offset); i++) {\r\no = pwr_info_offset[i];\r\nSPEX(core_pwr_info[i].itssi_2g, o + SSB_SROM8_2G_MAXP_ITSSI,\r\nSSB_SPROM8_2G_ITSSI, SSB_SPROM8_2G_ITSSI_SHIFT);\r\nSPEX(core_pwr_info[i].maxpwr_2g, o + SSB_SROM8_2G_MAXP_ITSSI,\r\nSSB_SPROM8_2G_MAXP, 0);\r\nSPEX(core_pwr_info[i].pa_2g[0], o + SSB_SROM8_2G_PA_0, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_2g[1], o + SSB_SROM8_2G_PA_1, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_2g[2], o + SSB_SROM8_2G_PA_2, ~0, 0);\r\nSPEX(core_pwr_info[i].itssi_5g, o + SSB_SROM8_5G_MAXP_ITSSI,\r\nSSB_SPROM8_5G_ITSSI, SSB_SPROM8_5G_ITSSI_SHIFT);\r\nSPEX(core_pwr_info[i].maxpwr_5g, o + SSB_SROM8_5G_MAXP_ITSSI,\r\nSSB_SPROM8_5G_MAXP, 0);\r\nSPEX(core_pwr_info[i].maxpwr_5gh, o + SSB_SPROM8_5GHL_MAXP,\r\nSSB_SPROM8_5GH_MAXP, 0);\r\nSPEX(core_pwr_info[i].maxpwr_5gl, o + SSB_SPROM8_5GHL_MAXP,\r\nSSB_SPROM8_5GL_MAXP, SSB_SPROM8_5GL_MAXP_SHIFT);\r\nSPEX(core_pwr_info[i].pa_5gl[0], o + SSB_SROM8_5GL_PA_0, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5gl[1], o + SSB_SROM8_5GL_PA_1, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5gl[2], o + SSB_SROM8_5GL_PA_2, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5g[0], o + SSB_SROM8_5G_PA_0, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5g[1], o + SSB_SROM8_5G_PA_1, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5g[2], o + SSB_SROM8_5G_PA_2, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5gh[0], o + SSB_SROM8_5GH_PA_0, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5gh[1], o + SSB_SROM8_5GH_PA_1, ~0, 0);\r\nSPEX(core_pwr_info[i].pa_5gh[2], o + SSB_SROM8_5GH_PA_2, ~0, 0);\r\n}\r\nSPEX(fem.ghz2.tssipos, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_TSSIPOS,\r\nSSB_SROM8_FEM_TSSIPOS_SHIFT);\r\nSPEX(fem.ghz2.extpa_gain, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_EXTPA_GAIN,\r\nSSB_SROM8_FEM_EXTPA_GAIN_SHIFT);\r\nSPEX(fem.ghz2.pdet_range, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_PDET_RANGE,\r\nSSB_SROM8_FEM_PDET_RANGE_SHIFT);\r\nSPEX(fem.ghz2.tr_iso, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_TR_ISO,\r\nSSB_SROM8_FEM_TR_ISO_SHIFT);\r\nSPEX(fem.ghz2.antswlut, SSB_SPROM8_FEM2G, SSB_SROM8_FEM_ANTSWLUT,\r\nSSB_SROM8_FEM_ANTSWLUT_SHIFT);\r\nSPEX(fem.ghz5.tssipos, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_TSSIPOS,\r\nSSB_SROM8_FEM_TSSIPOS_SHIFT);\r\nSPEX(fem.ghz5.extpa_gain, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_EXTPA_GAIN,\r\nSSB_SROM8_FEM_EXTPA_GAIN_SHIFT);\r\nSPEX(fem.ghz5.pdet_range, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_PDET_RANGE,\r\nSSB_SROM8_FEM_PDET_RANGE_SHIFT);\r\nSPEX(fem.ghz5.tr_iso, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_TR_ISO,\r\nSSB_SROM8_FEM_TR_ISO_SHIFT);\r\nSPEX(fem.ghz5.antswlut, SSB_SPROM8_FEM5G, SSB_SROM8_FEM_ANTSWLUT,\r\nSSB_SROM8_FEM_ANTSWLUT_SHIFT);\r\nSPEX(ant_available_a, SSB_SPROM8_ANTAVAIL, SSB_SPROM8_ANTAVAIL_A,\r\nSSB_SPROM8_ANTAVAIL_A_SHIFT);\r\nSPEX(ant_available_bg, SSB_SPROM8_ANTAVAIL, SSB_SPROM8_ANTAVAIL_BG,\r\nSSB_SPROM8_ANTAVAIL_BG_SHIFT);\r\nSPEX(maxpwr_bg, SSB_SPROM8_MAXP_BG, SSB_SPROM8_MAXP_BG_MASK, 0);\r\nSPEX(itssi_bg, SSB_SPROM8_MAXP_BG, SSB_SPROM8_ITSSI_BG,\r\nSSB_SPROM8_ITSSI_BG_SHIFT);\r\nSPEX(maxpwr_a, SSB_SPROM8_MAXP_A, SSB_SPROM8_MAXP_A_MASK, 0);\r\nSPEX(itssi_a, SSB_SPROM8_MAXP_A, SSB_SPROM8_ITSSI_A,\r\nSSB_SPROM8_ITSSI_A_SHIFT);\r\nSPEX(maxpwr_ah, SSB_SPROM8_MAXP_AHL, SSB_SPROM8_MAXP_AH_MASK, 0);\r\nSPEX(maxpwr_al, SSB_SPROM8_MAXP_AHL, SSB_SPROM8_MAXP_AL_MASK,\r\nSSB_SPROM8_MAXP_AL_SHIFT);\r\nSPEX(gpio0, SSB_SPROM8_GPIOA, SSB_SPROM8_GPIOA_P0, 0);\r\nSPEX(gpio1, SSB_SPROM8_GPIOA, SSB_SPROM8_GPIOA_P1,\r\nSSB_SPROM8_GPIOA_P1_SHIFT);\r\nSPEX(gpio2, SSB_SPROM8_GPIOB, SSB_SPROM8_GPIOB_P2, 0);\r\nSPEX(gpio3, SSB_SPROM8_GPIOB, SSB_SPROM8_GPIOB_P3,\r\nSSB_SPROM8_GPIOB_P3_SHIFT);\r\nSPEX(tri2g, SSB_SPROM8_TRI25G, SSB_SPROM8_TRI2G, 0);\r\nSPEX(tri5g, SSB_SPROM8_TRI25G, SSB_SPROM8_TRI5G,\r\nSSB_SPROM8_TRI5G_SHIFT);\r\nSPEX(tri5gl, SSB_SPROM8_TRI5GHL, SSB_SPROM8_TRI5GL, 0);\r\nSPEX(tri5gh, SSB_SPROM8_TRI5GHL, SSB_SPROM8_TRI5GH,\r\nSSB_SPROM8_TRI5GH_SHIFT);\r\nSPEX(rxpo2g, SSB_SPROM8_RXPO, SSB_SPROM8_RXPO2G,\r\nSSB_SPROM8_RXPO2G_SHIFT);\r\nSPEX(rxpo5g, SSB_SPROM8_RXPO, SSB_SPROM8_RXPO5G,\r\nSSB_SPROM8_RXPO5G_SHIFT);\r\nSPEX(rssismf2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISMF2G, 0);\r\nSPEX(rssismc2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISMC2G,\r\nSSB_SPROM8_RSSISMC2G_SHIFT);\r\nSPEX(rssisav2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_RSSISAV2G,\r\nSSB_SPROM8_RSSISAV2G_SHIFT);\r\nSPEX(bxa2g, SSB_SPROM8_RSSIPARM2G, SSB_SPROM8_BXA2G,\r\nSSB_SPROM8_BXA2G_SHIFT);\r\nSPEX(rssismf5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISMF5G, 0);\r\nSPEX(rssismc5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISMC5G,\r\nSSB_SPROM8_RSSISMC5G_SHIFT);\r\nSPEX(rssisav5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_RSSISAV5G,\r\nSSB_SPROM8_RSSISAV5G_SHIFT);\r\nSPEX(bxa5g, SSB_SPROM8_RSSIPARM5G, SSB_SPROM8_BXA5G,\r\nSSB_SPROM8_BXA5G_SHIFT);\r\nSPEX(pa0b0, SSB_SPROM8_PA0B0, ~0, 0);\r\nSPEX(pa0b1, SSB_SPROM8_PA0B1, ~0, 0);\r\nSPEX(pa0b2, SSB_SPROM8_PA0B2, ~0, 0);\r\nSPEX(pa1b0, SSB_SPROM8_PA1B0, ~0, 0);\r\nSPEX(pa1b1, SSB_SPROM8_PA1B1, ~0, 0);\r\nSPEX(pa1b2, SSB_SPROM8_PA1B2, ~0, 0);\r\nSPEX(pa1lob0, SSB_SPROM8_PA1LOB0, ~0, 0);\r\nSPEX(pa1lob1, SSB_SPROM8_PA1LOB1, ~0, 0);\r\nSPEX(pa1lob2, SSB_SPROM8_PA1LOB2, ~0, 0);\r\nSPEX(pa1hib0, SSB_SPROM8_PA1HIB0, ~0, 0);\r\nSPEX(pa1hib1, SSB_SPROM8_PA1HIB1, ~0, 0);\r\nSPEX(pa1hib2, SSB_SPROM8_PA1HIB2, ~0, 0);\r\nSPEX(cck2gpo, SSB_SPROM8_CCK2GPO, ~0, 0);\r\nSPEX32(ofdm2gpo, SSB_SPROM8_OFDM2GPO, ~0, 0);\r\nSPEX32(ofdm5glpo, SSB_SPROM8_OFDM5GLPO, ~0, 0);\r\nSPEX32(ofdm5gpo, SSB_SPROM8_OFDM5GPO, ~0, 0);\r\nSPEX32(ofdm5ghpo, SSB_SPROM8_OFDM5GHPO, ~0, 0);\r\nSPEX(antenna_gain.a0, SSB_SPROM8_AGAIN01,\r\nSSB_SPROM8_AGAIN0, SSB_SPROM8_AGAIN0_SHIFT);\r\nSPEX(antenna_gain.a1, SSB_SPROM8_AGAIN01,\r\nSSB_SPROM8_AGAIN1, SSB_SPROM8_AGAIN1_SHIFT);\r\nSPEX(antenna_gain.a2, SSB_SPROM8_AGAIN23,\r\nSSB_SPROM8_AGAIN2, SSB_SPROM8_AGAIN2_SHIFT);\r\nSPEX(antenna_gain.a3, SSB_SPROM8_AGAIN23,\r\nSSB_SPROM8_AGAIN3, SSB_SPROM8_AGAIN3_SHIFT);\r\nSPEX(leddc_on_time, SSB_SPROM8_LEDDC, SSB_SPROM8_LEDDC_ON,\r\nSSB_SPROM8_LEDDC_ON_SHIFT);\r\nSPEX(leddc_off_time, SSB_SPROM8_LEDDC, SSB_SPROM8_LEDDC_OFF,\r\nSSB_SPROM8_LEDDC_OFF_SHIFT);\r\nSPEX(txchain, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_TXCHAIN,\r\nSSB_SPROM8_TXRXC_TXCHAIN_SHIFT);\r\nSPEX(rxchain, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_RXCHAIN,\r\nSSB_SPROM8_TXRXC_RXCHAIN_SHIFT);\r\nSPEX(antswitch, SSB_SPROM8_TXRXC, SSB_SPROM8_TXRXC_SWITCH,\r\nSSB_SPROM8_TXRXC_SWITCH_SHIFT);\r\nSPEX(opo, SSB_SPROM8_OFDM2GPO, 0x00ff, 0);\r\nSPEX_ARRAY8(mcs2gpo, SSB_SPROM8_2G_MCSPO, ~0, 0);\r\nSPEX_ARRAY8(mcs5gpo, SSB_SPROM8_5G_MCSPO, ~0, 0);\r\nSPEX_ARRAY8(mcs5glpo, SSB_SPROM8_5GL_MCSPO, ~0, 0);\r\nSPEX_ARRAY8(mcs5ghpo, SSB_SPROM8_5GH_MCSPO, ~0, 0);\r\nSPEX(rawtempsense, SSB_SPROM8_RAWTS, SSB_SPROM8_RAWTS_RAWTEMP,\r\nSSB_SPROM8_RAWTS_RAWTEMP_SHIFT);\r\nSPEX(measpower, SSB_SPROM8_RAWTS, SSB_SPROM8_RAWTS_MEASPOWER,\r\nSSB_SPROM8_RAWTS_MEASPOWER_SHIFT);\r\nSPEX(tempsense_slope, SSB_SPROM8_OPT_CORRX,\r\nSSB_SPROM8_OPT_CORRX_TEMP_SLOPE,\r\nSSB_SPROM8_OPT_CORRX_TEMP_SLOPE_SHIFT);\r\nSPEX(tempcorrx, SSB_SPROM8_OPT_CORRX, SSB_SPROM8_OPT_CORRX_TEMPCORRX,\r\nSSB_SPROM8_OPT_CORRX_TEMPCORRX_SHIFT);\r\nSPEX(tempsense_option, SSB_SPROM8_OPT_CORRX,\r\nSSB_SPROM8_OPT_CORRX_TEMP_OPTION,\r\nSSB_SPROM8_OPT_CORRX_TEMP_OPTION_SHIFT);\r\nSPEX(freqoffset_corr, SSB_SPROM8_HWIQ_IQSWP,\r\nSSB_SPROM8_HWIQ_IQSWP_FREQ_CORR,\r\nSSB_SPROM8_HWIQ_IQSWP_FREQ_CORR_SHIFT);\r\nSPEX(iqcal_swp_dis, SSB_SPROM8_HWIQ_IQSWP,\r\nSSB_SPROM8_HWIQ_IQSWP_IQCAL_SWP,\r\nSSB_SPROM8_HWIQ_IQSWP_IQCAL_SWP_SHIFT);\r\nSPEX(hw_iqcal_en, SSB_SPROM8_HWIQ_IQSWP, SSB_SPROM8_HWIQ_IQSWP_HW_IQCAL,\r\nSSB_SPROM8_HWIQ_IQSWP_HW_IQCAL_SHIFT);\r\nSPEX(bw40po, SSB_SPROM8_BW40PO, ~0, 0);\r\nSPEX(cddpo, SSB_SPROM8_CDDPO, ~0, 0);\r\nSPEX(stbcpo, SSB_SPROM8_STBCPO, ~0, 0);\r\nSPEX(bwduppo, SSB_SPROM8_BWDUPPO, ~0, 0);\r\nSPEX(tempthresh, SSB_SPROM8_THERMAL, SSB_SPROM8_THERMAL_TRESH,\r\nSSB_SPROM8_THERMAL_TRESH_SHIFT);\r\nSPEX(tempoffset, SSB_SPROM8_THERMAL, SSB_SPROM8_THERMAL_OFFSET,\r\nSSB_SPROM8_THERMAL_OFFSET_SHIFT);\r\nSPEX(phycal_tempdelta, SSB_SPROM8_TEMPDELTA,\r\nSSB_SPROM8_TEMPDELTA_PHYCAL,\r\nSSB_SPROM8_TEMPDELTA_PHYCAL_SHIFT);\r\nSPEX(temps_period, SSB_SPROM8_TEMPDELTA, SSB_SPROM8_TEMPDELTA_PERIOD,\r\nSSB_SPROM8_TEMPDELTA_PERIOD_SHIFT);\r\nSPEX(temps_hysteresis, SSB_SPROM8_TEMPDELTA,\r\nSSB_SPROM8_TEMPDELTA_HYSTERESIS,\r\nSSB_SPROM8_TEMPDELTA_HYSTERESIS_SHIFT);\r\n}\r\nstatic bool bcma_sprom_ext_available(struct bcma_bus *bus)\r\n{\r\nu32 chip_status;\r\nu32 srom_control;\r\nu32 present_mask;\r\nif (bus->drv_cc.core->id.rev >= 31) {\r\nif (!(bus->drv_cc.capabilities & BCMA_CC_CAP_SPROM))\r\nreturn false;\r\nsrom_control = bcma_read32(bus->drv_cc.core,\r\nBCMA_CC_SROM_CONTROL);\r\nreturn srom_control & BCMA_CC_SROM_CONTROL_PRESENT;\r\n}\r\nchip_status = bcma_read32(bus->drv_cc.core, BCMA_CC_CHIPSTAT);\r\nswitch (bus->chipinfo.id) {\r\ncase BCMA_CHIP_ID_BCM4313:\r\npresent_mask = BCMA_CC_CHIPST_4313_SPROM_PRESENT;\r\nbreak;\r\ncase BCMA_CHIP_ID_BCM4331:\r\npresent_mask = BCMA_CC_CHIPST_4331_SPROM_PRESENT;\r\nbreak;\r\ndefault:\r\nreturn true;\r\n}\r\nreturn chip_status & present_mask;\r\n}\r\nstatic bool bcma_sprom_onchip_available(struct bcma_bus *bus)\r\n{\r\nu32 chip_status;\r\nu32 otpsize = 0;\r\nbool present;\r\nchip_status = bcma_read32(bus->drv_cc.core, BCMA_CC_CHIPSTAT);\r\nswitch (bus->chipinfo.id) {\r\ncase BCMA_CHIP_ID_BCM4313:\r\npresent = chip_status & BCMA_CC_CHIPST_4313_OTP_PRESENT;\r\nbreak;\r\ncase BCMA_CHIP_ID_BCM4331:\r\npresent = chip_status & BCMA_CC_CHIPST_4331_OTP_PRESENT;\r\nbreak;\r\ncase BCMA_CHIP_ID_BCM43142:\r\ncase BCMA_CHIP_ID_BCM43224:\r\ncase BCMA_CHIP_ID_BCM43225:\r\npresent = true;\r\nbreak;\r\ncase BCMA_CHIP_ID_BCM43227:\r\ncase BCMA_CHIP_ID_BCM43228:\r\ncase BCMA_CHIP_ID_BCM43428:\r\npresent = chip_status & BCMA_CC_CHIPST_43228_OTP_PRESENT;\r\nbreak;\r\ndefault:\r\npresent = false;\r\nbreak;\r\n}\r\nif (present) {\r\notpsize = bus->drv_cc.capabilities & BCMA_CC_CAP_OTPS;\r\notpsize >>= BCMA_CC_CAP_OTPS_SHIFT;\r\n}\r\nreturn otpsize != 0;\r\n}\r\nstatic int bcma_sprom_onchip_offset(struct bcma_bus *bus)\r\n{\r\nstruct bcma_device *cc = bus->drv_cc.core;\r\nu32 offset;\r\nif ((bcma_read32(cc, BCMA_CC_OTPS) & BCMA_CC_OTPS_GU_PROG_HW) == 0)\r\nreturn 0;\r\noffset = (bcma_read32(cc, BCMA_CC_OTPL) & BCMA_CC_OTPL_GURGN_OFFSET);\r\nreturn BCMA_CC_SPROM + (offset >> 3);\r\n}\r\nint bcma_sprom_get(struct bcma_bus *bus)\r\n{\r\nu16 offset = BCMA_CC_SPROM;\r\nu16 *sprom;\r\nsize_t sprom_sizes[] = { SSB_SPROMSIZE_WORDS_R4,\r\nSSB_SPROMSIZE_WORDS_R10, };\r\nint i, err = 0;\r\nif (!bus->drv_cc.core)\r\nreturn -EOPNOTSUPP;\r\nif (!bcma_sprom_ext_available(bus)) {\r\nbool sprom_onchip;\r\nsprom_onchip = bcma_sprom_onchip_available(bus);\r\nif (sprom_onchip) {\r\noffset = bcma_sprom_onchip_offset(bus);\r\n}\r\nif (!offset || !sprom_onchip) {\r\nerr = bcma_fill_sprom_with_fallback(bus, &bus->sprom);\r\nreturn err;\r\n}\r\n}\r\nif (bus->chipinfo.id == BCMA_CHIP_ID_BCM4331 ||\r\nbus->chipinfo.id == BCMA_CHIP_ID_BCM43431)\r\nbcma_chipco_bcm4331_ext_pa_lines_ctl(&bus->drv_cc, false);\r\nbcma_debug(bus, "SPROM offset 0x%x\n", offset);\r\nfor (i = 0; i < ARRAY_SIZE(sprom_sizes); i++) {\r\nsize_t words = sprom_sizes[i];\r\nsprom = kcalloc(words, sizeof(u16), GFP_KERNEL);\r\nif (!sprom)\r\nreturn -ENOMEM;\r\nbcma_sprom_read(bus, offset, sprom, words);\r\nerr = bcma_sprom_valid(bus, sprom, words);\r\nif (!err)\r\nbreak;\r\nkfree(sprom);\r\n}\r\nif (bus->chipinfo.id == BCMA_CHIP_ID_BCM4331 ||\r\nbus->chipinfo.id == BCMA_CHIP_ID_BCM43431)\r\nbcma_chipco_bcm4331_ext_pa_lines_ctl(&bus->drv_cc, true);\r\nif (err) {\r\nbcma_warn(bus, "Invalid SPROM read from the PCIe card, trying to use fallback SPROM\n");\r\nerr = bcma_fill_sprom_with_fallback(bus, &bus->sprom);\r\n} else {\r\nbcma_sprom_extract_r8(bus, sprom);\r\nkfree(sprom);\r\n}\r\nreturn err;\r\n}

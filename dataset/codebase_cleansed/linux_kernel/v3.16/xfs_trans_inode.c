void\r\nxfs_trans_ijoin(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *ip,\r\nuint lock_flags)\r\n{\r\nxfs_inode_log_item_t *iip;\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\nif (ip->i_itemp == NULL)\r\nxfs_inode_item_init(ip, ip->i_mount);\r\niip = ip->i_itemp;\r\nASSERT(iip->ili_lock_flags == 0);\r\niip->ili_lock_flags = lock_flags;\r\nxfs_trans_add_item(tp, &iip->ili_item);\r\n}\r\nvoid\r\nxfs_trans_ichgtime(\r\nstruct xfs_trans *tp,\r\nstruct xfs_inode *ip,\r\nint flags)\r\n{\r\nstruct inode *inode = VFS_I(ip);\r\ntimespec_t tv;\r\nASSERT(tp);\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\ntv = current_fs_time(inode->i_sb);\r\nif ((flags & XFS_ICHGTIME_MOD) &&\r\n!timespec_equal(&inode->i_mtime, &tv)) {\r\ninode->i_mtime = tv;\r\nip->i_d.di_mtime.t_sec = tv.tv_sec;\r\nip->i_d.di_mtime.t_nsec = tv.tv_nsec;\r\n}\r\nif ((flags & XFS_ICHGTIME_CHG) &&\r\n!timespec_equal(&inode->i_ctime, &tv)) {\r\ninode->i_ctime = tv;\r\nip->i_d.di_ctime.t_sec = tv.tv_sec;\r\nip->i_d.di_ctime.t_nsec = tv.tv_nsec;\r\n}\r\n}\r\nvoid\r\nxfs_trans_log_inode(\r\nxfs_trans_t *tp,\r\nxfs_inode_t *ip,\r\nuint flags)\r\n{\r\nASSERT(ip->i_itemp != NULL);\r\nASSERT(xfs_isilocked(ip, XFS_ILOCK_EXCL));\r\nif (!(ip->i_itemp->ili_item.li_desc->lid_flags & XFS_LID_DIRTY) &&\r\nIS_I_VERSION(VFS_I(ip))) {\r\nip->i_d.di_changecount = ++VFS_I(ip)->i_version;\r\nflags |= XFS_ILOG_CORE;\r\n}\r\ntp->t_flags |= XFS_TRANS_DIRTY;\r\nip->i_itemp->ili_item.li_desc->lid_flags |= XFS_LID_DIRTY;\r\nflags |= ip->i_itemp->ili_last_fields;\r\nip->i_itemp->ili_fields |= flags;\r\n}

static unsigned int kmp_find(struct ts_config *conf, struct ts_state *state)\r\n{\r\nstruct ts_kmp *kmp = ts_config_priv(conf);\r\nunsigned int i, q = 0, text_len, consumed = state->offset;\r\nconst u8 *text;\r\nconst int icase = conf->flags & TS_IGNORECASE;\r\nfor (;;) {\r\ntext_len = conf->get_next_block(consumed, &text, conf, state);\r\nif (unlikely(text_len == 0))\r\nbreak;\r\nfor (i = 0; i < text_len; i++) {\r\nwhile (q > 0 && kmp->pattern[q]\r\n!= (icase ? toupper(text[i]) : text[i]))\r\nq = kmp->prefix_tbl[q - 1];\r\nif (kmp->pattern[q]\r\n== (icase ? toupper(text[i]) : text[i]))\r\nq++;\r\nif (unlikely(q == kmp->pattern_len)) {\r\nstate->offset = consumed + i + 1;\r\nreturn state->offset - kmp->pattern_len;\r\n}\r\n}\r\nconsumed += text_len;\r\n}\r\nreturn UINT_MAX;\r\n}\r\nstatic inline void compute_prefix_tbl(const u8 *pattern, unsigned int len,\r\nunsigned int *prefix_tbl, int flags)\r\n{\r\nunsigned int k, q;\r\nconst u8 icase = flags & TS_IGNORECASE;\r\nfor (k = 0, q = 1; q < len; q++) {\r\nwhile (k > 0 && (icase ? toupper(pattern[k]) : pattern[k])\r\n!= (icase ? toupper(pattern[q]) : pattern[q]))\r\nk = prefix_tbl[k-1];\r\nif ((icase ? toupper(pattern[k]) : pattern[k])\r\n== (icase ? toupper(pattern[q]) : pattern[q]))\r\nk++;\r\nprefix_tbl[q] = k;\r\n}\r\n}\r\nstatic struct ts_config *kmp_init(const void *pattern, unsigned int len,\r\ngfp_t gfp_mask, int flags)\r\n{\r\nstruct ts_config *conf;\r\nstruct ts_kmp *kmp;\r\nint i;\r\nunsigned int prefix_tbl_len = len * sizeof(unsigned int);\r\nsize_t priv_size = sizeof(*kmp) + len + prefix_tbl_len;\r\nconf = alloc_ts_config(priv_size, gfp_mask);\r\nif (IS_ERR(conf))\r\nreturn conf;\r\nconf->flags = flags;\r\nkmp = ts_config_priv(conf);\r\nkmp->pattern_len = len;\r\ncompute_prefix_tbl(pattern, len, kmp->prefix_tbl, flags);\r\nkmp->pattern = (u8 *) kmp->prefix_tbl + prefix_tbl_len;\r\nif (flags & TS_IGNORECASE)\r\nfor (i = 0; i < len; i++)\r\nkmp->pattern[i] = toupper(((u8 *)pattern)[i]);\r\nelse\r\nmemcpy(kmp->pattern, pattern, len);\r\nreturn conf;\r\n}\r\nstatic void *kmp_get_pattern(struct ts_config *conf)\r\n{\r\nstruct ts_kmp *kmp = ts_config_priv(conf);\r\nreturn kmp->pattern;\r\n}\r\nstatic unsigned int kmp_get_pattern_len(struct ts_config *conf)\r\n{\r\nstruct ts_kmp *kmp = ts_config_priv(conf);\r\nreturn kmp->pattern_len;\r\n}\r\nstatic int __init init_kmp(void)\r\n{\r\nreturn textsearch_register(&kmp_ops);\r\n}\r\nstatic void __exit exit_kmp(void)\r\n{\r\ntextsearch_unregister(&kmp_ops);\r\n}

u1Byte\r\nhalbtc8812a1ant_BtRssiState(\r\nu1Byte level_num,\r\nu1Byte rssi_thresh,\r\nu1Byte rssi_thresh1\r\n)\r\n{\r\ns4Byte bt_rssi=0;\r\nu1Byte bt_rssi_state;\r\nbt_rssi = coex_sta->bt_rssi;\r\nif(level_num == 2)\r\n{\r\nif( (coex_sta->pre_bt_rssi_state == BTC_RSSI_STATE_LOW) ||\r\n(coex_sta->pre_bt_rssi_state == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(bt_rssi >= (rssi_thresh+BTC_RSSI_COEX_THRESH_TOL_8812A_1ANT))\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to High\n"));\r\n}\r\nelse\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at Low\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(bt_rssi < rssi_thresh)\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at High\n"));\r\n}\r\n}\r\n}\r\nelse if(level_num == 3)\r\n{\r\nif(rssi_thresh > rssi_thresh1)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi thresh error!!\n"));\r\nreturn coex_sta->pre_bt_rssi_state;\r\n}\r\nif( (coex_sta->pre_bt_rssi_state == BTC_RSSI_STATE_LOW) ||\r\n(coex_sta->pre_bt_rssi_state == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(bt_rssi >= (rssi_thresh+BTC_RSSI_COEX_THRESH_TOL_8812A_1ANT))\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at Low\n"));\r\n}\r\n}\r\nelse if( (coex_sta->pre_bt_rssi_state == BTC_RSSI_STATE_MEDIUM) ||\r\n(coex_sta->pre_bt_rssi_state == BTC_RSSI_STATE_STAY_MEDIUM))\r\n{\r\nif(bt_rssi >= (rssi_thresh1+BTC_RSSI_COEX_THRESH_TOL_8812A_1ANT))\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to High\n"));\r\n}\r\nelse if(bt_rssi < rssi_thresh)\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_STAY_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at Medium\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(bt_rssi < rssi_thresh1)\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nbt_rssi_state = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_RSSI_STATE, ("[BTCoex], BT Rssi state stay at High\n"));\r\n}\r\n}\r\n}\r\ncoex_sta->pre_bt_rssi_state = bt_rssi_state;\r\nreturn bt_rssi_state;\r\n}\r\nu1Byte\r\nhalbtc8812a1ant_WifiRssiState(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte index,\r\nu1Byte level_num,\r\nu1Byte rssi_thresh,\r\nu1Byte rssi_thresh1\r\n)\r\n{\r\ns4Byte wifi_rssi=0;\r\nu1Byte wifi_rssi_state;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_S4_WIFI_RSSI, &wifi_rssi);\r\nif(level_num == 2)\r\n{\r\nif( (coex_sta->pre_wifi_rssi_state[index] == BTC_RSSI_STATE_LOW) ||\r\n(coex_sta->pre_wifi_rssi_state[index] == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(wifi_rssi >= (rssi_thresh+BTC_RSSI_COEX_THRESH_TOL_8812A_1ANT))\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to High\n"));\r\n}\r\nelse\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at Low\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(wifi_rssi < rssi_thresh)\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at High\n"));\r\n}\r\n}\r\n}\r\nelse if(level_num == 3)\r\n{\r\nif(rssi_thresh > rssi_thresh1)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI thresh error!!\n"));\r\nreturn coex_sta->pre_wifi_rssi_state[index];\r\n}\r\nif( (coex_sta->pre_wifi_rssi_state[index] == BTC_RSSI_STATE_LOW) ||\r\n(coex_sta->pre_wifi_rssi_state[index] == BTC_RSSI_STATE_STAY_LOW))\r\n{\r\nif(wifi_rssi >= (rssi_thresh+BTC_RSSI_COEX_THRESH_TOL_8812A_1ANT))\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_STAY_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at Low\n"));\r\n}\r\n}\r\nelse if( (coex_sta->pre_wifi_rssi_state[index] == BTC_RSSI_STATE_MEDIUM) ||\r\n(coex_sta->pre_wifi_rssi_state[index] == BTC_RSSI_STATE_STAY_MEDIUM))\r\n{\r\nif(wifi_rssi >= (rssi_thresh1+BTC_RSSI_COEX_THRESH_TOL_8812A_1ANT))\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to High\n"));\r\n}\r\nelse if(wifi_rssi < rssi_thresh)\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_LOW;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Low\n"));\r\n}\r\nelse\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_STAY_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at Medium\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif(wifi_rssi < rssi_thresh1)\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_MEDIUM;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state switch to Medium\n"));\r\n}\r\nelse\r\n{\r\nwifi_rssi_state = BTC_RSSI_STATE_STAY_HIGH;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_WIFI_RSSI_STATE, ("[BTCoex], wifi RSSI state stay at High\n"));\r\n}\r\n}\r\n}\r\ncoex_sta->pre_wifi_rssi_state[index] = wifi_rssi_state;\r\nreturn wifi_rssi_state;\r\n}\r\nvoid\r\nhalbtc8812a1ant_MonitorBtEnableDisable(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nstatic BOOLEAN pre_bt_disabled=false;\r\nstatic u4Byte bt_disable_cnt=0;\r\nBOOLEAN bt_active=true, bt_disable_by68=false, bt_disabled=false;\r\nu4Byte u4_tmp=0;\r\nif( coex_sta->high_priority_tx == 0 &&\r\ncoex_sta->high_priority_rx == 0 &&\r\ncoex_sta->low_priority_tx == 0 &&\r\ncoex_sta->low_priority_rx == 0)\r\n{\r\nbt_active = false;\r\n}\r\nif( coex_sta->high_priority_tx == 0xffff &&\r\ncoex_sta->high_priority_rx == 0xffff &&\r\ncoex_sta->low_priority_tx == 0xffff &&\r\ncoex_sta->low_priority_rx == 0xffff)\r\n{\r\nbt_active = false;\r\n}\r\nif(bt_active)\r\n{\r\nbt_disable_cnt = 0;\r\nbt_disabled = false;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_DISABLE, &bt_disabled);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is enabled !!\n"));\r\n}\r\nelse\r\n{\r\nbt_disable_cnt++;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], bt all counters=0, %d times!!\n",\r\nbt_disable_cnt));\r\nif(bt_disable_cnt >= 2 ||bt_disable_by68)\r\n{\r\nbt_disabled = true;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_DISABLE, &bt_disabled);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is disabled !!\n"));\r\n}\r\n}\r\nif(pre_bt_disabled != bt_disabled)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], BT is from %s to %s!!\n",\r\n(pre_bt_disabled ? "disabled":"enabled"),\r\n(bt_disabled ? "disabled":"enabled")));\r\npre_bt_disabled = bt_disabled;\r\nif(!bt_disabled)\r\n{\r\n}\r\nelse\r\n{\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_MonitorBtCtr(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu4Byte reg_hp_tx_rx, reg_lp_tx_rx, u4_tmp;\r\nu4Byte reg_hp_tx=0, reg_hp_rx=0, reg_lp_tx=0, reg_lp_rx=0;\r\nu1Byte u1_tmp;\r\nreg_hp_tx_rx = 0x770;\r\nreg_lp_tx_rx = 0x774;\r\nu4_tmp = btcoexist->btc_read_4byte(btcoexist, reg_hp_tx_rx);\r\nreg_hp_tx = u4_tmp & bMaskLWord;\r\nreg_hp_rx = (u4_tmp & bMaskHWord)>>16;\r\nu4_tmp = btcoexist->btc_read_4byte(btcoexist, reg_lp_tx_rx);\r\nreg_lp_tx = u4_tmp & bMaskLWord;\r\nreg_lp_rx = (u4_tmp & bMaskHWord)>>16;\r\ncoex_sta->high_priority_tx = reg_hp_tx;\r\ncoex_sta->high_priority_rx = reg_hp_rx;\r\ncoex_sta->low_priority_tx = reg_lp_tx;\r\ncoex_sta->low_priority_rx = reg_lp_rx;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], High Priority Tx/Rx (reg 0x%x)=%x(%d)/%x(%d)\n",\r\nreg_hp_tx_rx, reg_hp_tx, reg_hp_tx, reg_hp_rx, reg_hp_rx));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_BT_MONITOR, ("[BTCoex], Low Priority Tx/Rx (reg 0x%x)=%x(%d)/%x(%d)\n",\r\nreg_lp_tx_rx, reg_lp_tx, reg_lp_tx, reg_lp_rx, reg_lp_rx));\r\nbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0xc);\r\n}\r\nvoid\r\nhalbtc8812a1ant_QueryBtInfo(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte dataLen=3;\r\nu1Byte buf[5] = {0};\r\nstatic u4Byte btInfoCnt=0;\r\nif(!btInfoCnt ||\r\n(coex_sta->bt_info_c2h_cnt[BT_INFO_SRC_8812A_1ANT_BT_RSP]-btInfoCnt)>2)\r\n{\r\nbuf[0] = dataLen;\r\nbuf[1] = 0x1;\r\nbuf[2] = 0x2;\r\nbuf[3] = 0x1;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_CTRL_BT_INFO, (PVOID)&buf[0]);\r\n}\r\nbtInfoCnt = coex_sta->bt_info_c2h_cnt[BT_INFO_SRC_8812A_1ANT_BT_RSP];\r\n}\r\nu1Byte\r\nhalbtc8812a1ant_ActionAlgorithm(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN bt_hs_on=false;\r\nu1Byte algorithm=BT_8812A_1ANT_COEX_ALGO_UNDEFINED;\r\nu1Byte num_of_diff_profile=0;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\r\nif(!stack_info->bt_link_exist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], No profile exists!!!\n"));\r\nreturn algorithm;\r\n}\r\nif(stack_info->sco_exist)\r\nnum_of_diff_profile++;\r\nif(stack_info->hid_exist)\r\nnum_of_diff_profile++;\r\nif(stack_info->pan_exist)\r\nnum_of_diff_profile++;\r\nif(stack_info->a2dp_exist)\r\nnum_of_diff_profile++;\r\nif(num_of_diff_profile == 1)\r\n{\r\nif(stack_info->sco_exist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO only\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse\r\n{\r\nif(stack_info->hid_exist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID only\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID;\r\n}\r\nelse if(stack_info->a2dp_exist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], A2DP only\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_A2DP;\r\n}\r\nelse if(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], PAN(HS) only\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANHS;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], PAN(EDR) only\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR;\r\n}\r\n}\r\n}\r\n}\r\nelse if(num_of_diff_profile == 2)\r\n{\r\nif(stack_info->sco_exist)\r\n{\r\nif(stack_info->hid_exist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID;\r\n}\r\nelse if(stack_info->a2dp_exist)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + A2DP ==> SCO\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse if(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + PAN(HS)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + PAN(EDR)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif( stack_info->hid_exist &&\r\nstack_info->a2dp_exist )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + A2DP\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse if( stack_info->hid_exist &&\r\nstack_info->pan_exist )\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + PAN(HS)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + PAN(EDR)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\nelse if( stack_info->pan_exist &&\r\nstack_info->a2dp_exist )\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], A2DP + PAN(HS)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_A2DP_PANHS;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], A2DP + PAN(EDR)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR_A2DP;\r\n}\r\n}\r\n}\r\n}\r\nelse if(num_of_diff_profile == 3)\r\n{\r\nif(stack_info->sco_exist)\r\n{\r\nif( stack_info->hid_exist &&\r\nstack_info->a2dp_exist )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + A2DP ==> HID\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID;\r\n}\r\nelse if( stack_info->hid_exist &&\r\nstack_info->pan_exist )\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + PAN(HS)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + PAN(EDR)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\nelse if( stack_info->pan_exist &&\r\nstack_info->a2dp_exist )\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + A2DP + PAN(HS)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_SCO;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + A2DP + PAN(EDR) ==> HID\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nif( stack_info->hid_exist &&\r\nstack_info->pan_exist &&\r\nstack_info->a2dp_exist )\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + A2DP + PAN(HS)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID_A2DP;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HID + A2DP + PAN(EDR)\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_HID_A2DP_PANEDR;\r\n}\r\n}\r\n}\r\n}\r\nelse if(num_of_diff_profile >= 3)\r\n{\r\nif(stack_info->sco_exist)\r\n{\r\nif( stack_info->hid_exist &&\r\nstack_info->pan_exist &&\r\nstack_info->a2dp_exist )\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Error!!! SCO + HID + A2DP + PAN(HS)\n"));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], SCO + HID + A2DP + PAN(EDR)==>PAN(EDR)+HID\n"));\r\nalgorithm = BT_8812A_1ANT_COEX_ALGO_PANEDR_HID;\r\n}\r\n}\r\n}\r\n}\r\nreturn algorithm;\r\n}\r\nBOOLEAN\r\nhalbtc8812a1ant_NeedToDecBtPwr(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBOOLEAN ret=false;\r\nBOOLEAN bt_hs_on=false, wifi_connected=false;\r\ns4Byte bt_hs_rssi=0;\r\nif(!btcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on))\r\nreturn false;\r\nif(!btcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected))\r\nreturn false;\r\nif(!btcoexist->btc_get(btcoexist, BTC_GET_S4_HS_RSSI, &bt_hs_rssi))\r\nreturn false;\r\nif(wifi_connected)\r\n{\r\nif(bt_hs_on)\r\n{\r\nif(bt_hs_rssi > 37)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], Need to decrease bt power for HS mode!!\n"));\r\nret = true;\r\n}\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], Need to decrease bt power for Wifi is connected!!\n"));\r\nret = true;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetFwDacSwingLevel(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte dac_swing_lvl\r\n)\r\n{\r\nu1Byte h2c_parameter[1] ={0};\r\nh2c_parameter[0] = dac_swing_lvl;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], Set Dac Swing Level=0x%x\n", dac_swing_lvl));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], FW write 0x64=0x%x\n", h2c_parameter[0]));\r\nbtcoexist->btc_fill_h2c(btcoexist, 0x64, 1, h2c_parameter);\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetFwDecBtPwr(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN dec_bt_pwr\r\n)\r\n{\r\nu1Byte dataLen=3;\r\nu1Byte buf[5] = {0};\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], decrease Bt Power : %s\n",\r\n(dec_bt_pwr? "Yes!!":"No!!")));\r\nbuf[0] = dataLen;\r\nbuf[1] = 0x3;\r\nbuf[2] = 0x1;\r\nif(dec_bt_pwr)\r\nbuf[3] = 0x1;\r\nelse\r\nbuf[3] = 0x0;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_CTRL_BT_COEX, (PVOID)&buf[0]);\r\n}\r\nvoid\r\nhalbtc8812a1ant_DecBtPwr(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN dec_bt_pwr\r\n)\r\n{\r\nreturn;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s Dec BT power = %s\n",\r\n(force_exec? "force to":""), ((dec_bt_pwr)? "ON":"OFF")));\r\ncoex_dm->cur_dec_bt_pwr = dec_bt_pwr;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_dec_bt_pwr=%d, cur_dec_bt_pwr=%d\n",\r\ncoex_dm->pre_dec_bt_pwr, coex_dm->cur_dec_bt_pwr));\r\nif(coex_dm->pre_dec_bt_pwr == coex_dm->cur_dec_bt_pwr)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetFwDecBtPwr(btcoexist, coex_dm->cur_dec_bt_pwr);\r\ncoex_dm->pre_dec_bt_pwr = coex_dm->cur_dec_bt_pwr;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetFwBtLnaConstrain(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN bt_lna_cons_on\r\n)\r\n{\r\nu1Byte dataLen=3;\r\nu1Byte buf[5] = {0};\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], set BT LNA Constrain: %s\n",\r\n(bt_lna_cons_on? "ON!!":"OFF!!")));\r\nbuf[0] = dataLen;\r\nbuf[1] = 0x2;\r\nbuf[2] = 0x1;\r\nif(bt_lna_cons_on)\r\nbuf[3] = 0x1;\r\nelse\r\nbuf[3] = 0x0;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_CTRL_BT_COEX, (PVOID)&buf[0]);\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetBtLnaConstrain(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN bt_lna_cons_on\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s BT Constrain = %s\n",\r\n(force_exec? "force":""), ((bt_lna_cons_on)? "ON":"OFF")));\r\ncoex_dm->bCurBtLnaConstrain = bt_lna_cons_on;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreBtLnaConstrain=%d, bCurBtLnaConstrain=%d\n",\r\ncoex_dm->bPreBtLnaConstrain, coex_dm->bCurBtLnaConstrain));\r\nif(coex_dm->bPreBtLnaConstrain == coex_dm->bCurBtLnaConstrain)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetFwBtLnaConstrain(btcoexist, coex_dm->bCurBtLnaConstrain);\r\ncoex_dm->bPreBtLnaConstrain = coex_dm->bCurBtLnaConstrain;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetFwBtPsdMode(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte bt_psd_mode\r\n)\r\n{\r\nu1Byte dataLen=3;\r\nu1Byte buf[5] = {0};\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], set BT PSD mode=0x%x\n",\r\nbt_psd_mode));\r\nbuf[0] = dataLen;\r\nbuf[1] = 0x4;\r\nbuf[2] = 0x1;\r\nbuf[3] = bt_psd_mode;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_CTRL_BT_COEX, (PVOID)&buf[0]);\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetBtPsdMode(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nu1Byte bt_psd_mode\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s BT PSD mode = 0x%x\n",\r\n(force_exec? "force":""), bt_psd_mode));\r\ncoex_dm->bCurBtPsdMode = bt_psd_mode;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], bPreBtPsdMode=0x%x, bCurBtPsdMode=0x%x\n",\r\ncoex_dm->bPreBtPsdMode, coex_dm->bCurBtPsdMode));\r\nif(coex_dm->bPreBtPsdMode == coex_dm->bCurBtPsdMode)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetFwBtPsdMode(btcoexist, coex_dm->bCurBtPsdMode);\r\ncoex_dm->bPreBtPsdMode = coex_dm->bCurBtPsdMode;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetBtAutoReport(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN enable_auto_report\r\n)\r\n{\r\n#if 0\r\nu1Byte h2c_parameter[1] ={0};\r\nh2c_parameter[0] = 0;\r\nif(enable_auto_report)\r\n{\r\nh2c_parameter[0] |= BIT0;\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], BT FW auto report : %s, FW write 0x68=0x%x\n",\r\n(enable_auto_report? "Enabled!!":"Disabled!!"), h2c_parameter[0]));\r\nbtcoexist->btc_fill_h2c(btcoexist, 0x68, 1, h2c_parameter);\r\n#else\r\n#endif\r\n}\r\nvoid\r\nhalbtc8812a1ant_BtAutoReport(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN enable_auto_report\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s BT Auto report = %s\n",\r\n(force_exec? "force to":""), ((enable_auto_report)? "Enabled":"Disabled")));\r\ncoex_dm->cur_bt_auto_report = enable_auto_report;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_bt_auto_report=%d, cur_bt_auto_report=%d\n",\r\ncoex_dm->pre_bt_auto_report, coex_dm->cur_bt_auto_report));\r\nif(coex_dm->pre_bt_auto_report == coex_dm->cur_bt_auto_report)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetBtAutoReport(btcoexist, coex_dm->cur_bt_auto_report);\r\ncoex_dm->pre_bt_auto_report = coex_dm->cur_bt_auto_report;\r\n}\r\nvoid\r\nhalbtc8812a1ant_FwDacSwingLvl(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nu1Byte fw_dac_swing_lvl\r\n)\r\n{\r\nreturn;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s set FW Dac Swing level = %d\n",\r\n(force_exec? "force to":""), fw_dac_swing_lvl));\r\ncoex_dm->cur_fw_dac_swing_lvl = fw_dac_swing_lvl;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_fw_dac_swing_lvl=%d, cur_fw_dac_swing_lvl=%d\n",\r\ncoex_dm->pre_fw_dac_swing_lvl, coex_dm->cur_fw_dac_swing_lvl));\r\nif(coex_dm->pre_fw_dac_swing_lvl == coex_dm->cur_fw_dac_swing_lvl)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetFwDacSwingLevel(btcoexist, coex_dm->cur_fw_dac_swing_lvl);\r\ncoex_dm->pre_fw_dac_swing_lvl = coex_dm->cur_fw_dac_swing_lvl;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetSwRfRxLpfCorner(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN rx_rf_shrink_on\r\n)\r\n{\r\nif(rx_rf_shrink_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Shrink RF Rx LPF corner!!\n"));\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x1e, 0xfffff, 0xf0ff7);\r\n}\r\nelse\r\n{\r\nif(btcoexist->bInitilized)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Resume RF Rx LPF corner!!\n"));\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x1e, 0xfffff, coex_dm->bt_rf0x1e_backup);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_RfShrink(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN rx_rf_shrink_on\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn Rx RF Shrink = %s\n",\r\n(force_exec? "force to":""), ((rx_rf_shrink_on)? "ON":"OFF")));\r\ncoex_dm->cur_rf_rx_lpf_shrink = rx_rf_shrink_on;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], pre_rf_rx_lpf_shrink=%d, cur_rf_rx_lpf_shrink=%d\n",\r\ncoex_dm->pre_rf_rx_lpf_shrink, coex_dm->cur_rf_rx_lpf_shrink));\r\nif(coex_dm->pre_rf_rx_lpf_shrink == coex_dm->cur_rf_rx_lpf_shrink)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetSwRfRxLpfCorner(btcoexist, coex_dm->cur_rf_rx_lpf_shrink);\r\ncoex_dm->pre_rf_rx_lpf_shrink = coex_dm->cur_rf_rx_lpf_shrink;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetSwPenaltyTxRateAdaptive(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN low_penalty_ra\r\n)\r\n{\r\nu1Byte u1_tmp;\r\nu1_tmp = btcoexist->btc_read_1byte(btcoexist, 0x4fd);\r\nu1_tmp |= BIT0;\r\nif(low_penalty_ra)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Tx rate adaptive, set low penalty!!\n"));\r\nu1_tmp &= ~BIT2;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Tx rate adaptive, set normal!!\n"));\r\nu1_tmp |= BIT2;\r\n}\r\nbtcoexist->btc_write_1byte(btcoexist, 0x4fd, u1_tmp);\r\n}\r\nvoid\r\nhalbtc8812a1ant_LowPenaltyRa(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN low_penalty_ra\r\n)\r\n{\r\nreturn;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn LowPenaltyRA = %s\n",\r\n(force_exec? "force to":""), ((low_penalty_ra)? "ON":"OFF")));\r\ncoex_dm->cur_low_penalty_ra = low_penalty_ra;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], pre_low_penalty_ra=%d, cur_low_penalty_ra=%d\n",\r\ncoex_dm->pre_low_penalty_ra, coex_dm->cur_low_penalty_ra));\r\nif(coex_dm->pre_low_penalty_ra == coex_dm->cur_low_penalty_ra)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetSwPenaltyTxRateAdaptive(btcoexist, coex_dm->cur_low_penalty_ra);\r\ncoex_dm->pre_low_penalty_ra = coex_dm->cur_low_penalty_ra;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetDacSwingReg(\r\nPBTC_COEXIST btcoexist,\r\nu4Byte level\r\n)\r\n{\r\nu1Byte val=(u1Byte)level;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Write SwDacSwing = 0x%x\n", level));\r\nbtcoexist->btc_write_1byte_bitmask(btcoexist, 0xc5b, 0x3e, val);\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetSwFullTimeDacSwing(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN sw_dac_swing_on,\r\nu4Byte sw_dac_swing_lvl\r\n)\r\n{\r\nif(sw_dac_swing_on)\r\n{\r\nhalbtc8812a1ant_SetDacSwingReg(btcoexist, sw_dac_swing_lvl);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SetDacSwingReg(btcoexist, 0x18);\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_DacSwing(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN dac_swing_on,\r\nu4Byte dac_swing_lvl\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn DacSwing=%s, dac_swing_lvl=0x%x\n",\r\n(force_exec? "force to":""), ((dac_swing_on)? "ON":"OFF"), dac_swing_lvl));\r\ncoex_dm->cur_dac_swing_on = dac_swing_on;\r\ncoex_dm->cur_dac_swing_lvl = dac_swing_lvl;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], pre_dac_swing_on=%d, pre_dac_swing_lvl=0x%x, cur_dac_swing_on=%d, cur_dac_swing_lvl=0x%x\n",\r\ncoex_dm->pre_dac_swing_on, coex_dm->pre_dac_swing_lvl,\r\ncoex_dm->cur_dac_swing_on, coex_dm->cur_dac_swing_lvl));\r\nif( (coex_dm->pre_dac_swing_on == coex_dm->cur_dac_swing_on) &&\r\n(coex_dm->pre_dac_swing_lvl == coex_dm->cur_dac_swing_lvl) )\r\nreturn;\r\n}\r\ndelay_ms(30);\r\nhalbtc8812a1ant_SetSwFullTimeDacSwing(btcoexist, dac_swing_on, dac_swing_lvl);\r\ncoex_dm->pre_dac_swing_on = coex_dm->cur_dac_swing_on;\r\ncoex_dm->pre_dac_swing_lvl = coex_dm->cur_dac_swing_lvl;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetAdcBackOff(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN adc_back_off\r\n)\r\n{\r\nif(adc_back_off)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], BB BackOff Level On!\n"));\r\nbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x8db, 0x60, 0x3);\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], BB BackOff Level Off!\n"));\r\nbtcoexist->btc_write_1byte_bitmask(btcoexist, 0x8db, 0x60, 0x1);\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_AdcBackOff(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN adc_back_off\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s turn AdcBackOff = %s\n",\r\n(force_exec? "force to":""), ((adc_back_off)? "ON":"OFF")));\r\ncoex_dm->cur_adc_back_off = adc_back_off;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], pre_adc_back_off=%d, cur_adc_back_off=%d\n",\r\ncoex_dm->pre_adc_back_off, coex_dm->cur_adc_back_off));\r\nif(coex_dm->pre_adc_back_off == coex_dm->cur_adc_back_off)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetAdcBackOff(btcoexist, coex_dm->cur_adc_back_off);\r\ncoex_dm->pre_adc_back_off = coex_dm->cur_adc_back_off;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetAgcTable(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN agc_table_en\r\n)\r\n{\r\nu1Byte rssi_adjust_val=0;\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0xef, 0xfffff, 0x02000);\r\nif(agc_table_en)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Agc Table On!\n"));\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x3b, 0xfffff, 0x3fa58);\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x3b, 0xfffff, 0x37a58);\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x3b, 0xfffff, 0x2fa58);\r\nrssi_adjust_val = 8;\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], Agc Table Off!\n"));\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x3b, 0xfffff, 0x39258);\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x3b, 0xfffff, 0x31258);\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0x3b, 0xfffff, 0x29258);\r\n}\r\nbtcoexist->btc_set_rf_reg(btcoexist, BTC_RF_A, 0xef, 0xfffff, 0x0);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_U1_RSSI_ADJ_VAL_FOR_AGC_TABLE_ON, &rssi_adjust_val);\r\n}\r\nvoid\r\nhalbtc8812a1ant_AgcTable(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN agc_table_en\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s %s Agc Table\n",\r\n(force_exec? "force to":""), ((agc_table_en)? "Enable":"Disable")));\r\ncoex_dm->cur_agc_table_en = agc_table_en;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], pre_agc_table_en=%d, cur_agc_table_en=%d\n",\r\ncoex_dm->pre_agc_table_en, coex_dm->cur_agc_table_en));\r\nif(coex_dm->pre_agc_table_en == coex_dm->cur_agc_table_en)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetAgcTable(btcoexist, agc_table_en);\r\ncoex_dm->pre_agc_table_en = coex_dm->cur_agc_table_en;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetCoexTable(\r\nPBTC_COEXIST btcoexist,\r\nu4Byte val0x6c0,\r\nu4Byte val0x6c4,\r\nu4Byte val0x6c8,\r\nu1Byte val0x6cc\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c0=0x%x\n", val0x6c0));\r\nbtcoexist->btc_write_4byte(btcoexist, 0x6c0, val0x6c0);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c4=0x%x\n", val0x6c4));\r\nbtcoexist->btc_write_4byte(btcoexist, 0x6c4, val0x6c4);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6c8=0x%x\n", val0x6c8));\r\nbtcoexist->btc_write_4byte(btcoexist, 0x6c8, val0x6c8);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_EXEC, ("[BTCoex], set coex table, set 0x6cc=0x%x\n", val0x6cc));\r\nbtcoexist->btc_write_1byte(btcoexist, 0x6cc, val0x6cc);\r\n}\r\nvoid\r\nhalbtc8812a1ant_CoexTable(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nu4Byte val0x6c0,\r\nu4Byte val0x6c4,\r\nu4Byte val0x6c8,\r\nu1Byte val0x6cc\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW, ("[BTCoex], %s write Coex Table 0x6c0=0x%x, 0x6c4=0x%x, 0x6c8=0x%x, 0x6cc=0x%x\n",\r\n(force_exec? "force to":""), val0x6c0, val0x6c4, val0x6c8, val0x6cc));\r\ncoex_dm->cur_val0x6c0 = val0x6c0;\r\ncoex_dm->cur_val0x6c4 = val0x6c4;\r\ncoex_dm->cur_val0x6c8 = val0x6c8;\r\ncoex_dm->cur_val0x6cc = val0x6cc;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], pre_val0x6c0=0x%x, pre_val0x6c4=0x%x, pre_val0x6c8=0x%x, pre_val0x6cc=0x%x !!\n",\r\ncoex_dm->pre_val0x6c0, coex_dm->pre_val0x6c4, coex_dm->pre_val0x6c8, coex_dm->pre_val0x6cc));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_SW_DETAIL, ("[BTCoex], cur_val0x6c0=0x%x, cur_val0x6c4=0x%x, cur_val0x6c8=0x%x, cur_val0x6cc=0x%x !!\n",\r\ncoex_dm->cur_val0x6c0, coex_dm->cur_val0x6c4, coex_dm->cur_val0x6c8, coex_dm->cur_val0x6cc));\r\nif( (coex_dm->pre_val0x6c0 == coex_dm->cur_val0x6c0) &&\r\n(coex_dm->pre_val0x6c4 == coex_dm->cur_val0x6c4) &&\r\n(coex_dm->pre_val0x6c8 == coex_dm->cur_val0x6c8) &&\r\n(coex_dm->pre_val0x6cc == coex_dm->cur_val0x6cc) )\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetCoexTable(btcoexist, val0x6c0, val0x6c4, val0x6c8, val0x6cc);\r\ncoex_dm->pre_val0x6c0 = coex_dm->cur_val0x6c0;\r\ncoex_dm->pre_val0x6c4 = coex_dm->cur_val0x6c4;\r\ncoex_dm->pre_val0x6c8 = coex_dm->cur_val0x6c8;\r\ncoex_dm->pre_val0x6cc = coex_dm->cur_val0x6cc;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetFwIgnoreWlanAct(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN enable\r\n)\r\n{\r\nu1Byte dataLen=3;\r\nu1Byte buf[5] = {0};\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], %s BT Ignore Wlan_Act\n",\r\n(enable? "Enable":"Disable")));\r\nbuf[0] = dataLen;\r\nbuf[1] = 0x1;\r\nbuf[2] = 0x1;\r\nif(enable)\r\nbuf[3] = 0x1;\r\nelse\r\nbuf[3] = 0x0;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_CTRL_BT_COEX, (PVOID)&buf[0]);\r\n}\r\nvoid\r\nhalbtc8812a1ant_IgnoreWlanAct(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN enable\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s turn Ignore WlanAct %s\n",\r\n(force_exec? "force to":""), (enable? "ON":"OFF")));\r\ncoex_dm->cur_ignore_wlan_act = enable;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_ignore_wlan_act = %d, cur_ignore_wlan_act = %d!!\n",\r\ncoex_dm->pre_ignore_wlan_act, coex_dm->cur_ignore_wlan_act));\r\nif(coex_dm->pre_ignore_wlan_act == coex_dm->cur_ignore_wlan_act)\r\nreturn;\r\n}\r\nhalbtc8812a1ant_SetFwIgnoreWlanAct(btcoexist, enable);\r\ncoex_dm->pre_ignore_wlan_act = coex_dm->cur_ignore_wlan_act;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetFwPstdma(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte byte1,\r\nu1Byte byte2,\r\nu1Byte byte3,\r\nu1Byte byte4,\r\nu1Byte byte5\r\n)\r\n{\r\nu1Byte h2c_parameter[5] ={0};\r\nh2c_parameter[0] = byte1;\r\nh2c_parameter[1] = byte2;\r\nh2c_parameter[2] = byte3;\r\nh2c_parameter[3] = byte4;\r\nh2c_parameter[4] = byte5;\r\ncoex_dm->ps_tdma_para[0] = byte1;\r\ncoex_dm->ps_tdma_para[1] = byte2;\r\ncoex_dm->ps_tdma_para[2] = byte3;\r\ncoex_dm->ps_tdma_para[3] = byte4;\r\ncoex_dm->ps_tdma_para[4] = byte5;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_EXEC, ("[BTCoex], FW write 0x60(5bytes)=0x%x%08x\n",\r\nh2c_parameter[0],\r\nh2c_parameter[1]<<24|h2c_parameter[2]<<16|h2c_parameter[3]<<8|h2c_parameter[4]));\r\nbtcoexist->btc_fill_h2c(btcoexist, 0x60, 5, h2c_parameter);\r\n}\r\nvoid\r\nhalbtc8812a1ant_SetLpsRpwm(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte lps_val,\r\nu1Byte rpwm_val\r\n)\r\n{\r\nu1Byte lps=lps_val;\r\nu1Byte rpwm=rpwm_val;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_U1_1ANT_LPS, &lps);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_U1_1ANT_RPWM, &rpwm);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_INC_FORCE_EXEC_PWR_CMD_CNT, NULL);\r\n}\r\nvoid\r\nhalbtc8812a1ant_LpsRpwm(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nu1Byte lps_val,\r\nu1Byte rpwm_val\r\n)\r\n{\r\nBOOLEAN bForceExecPwrCmd=false;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s set lps/rpwm=0x%x/0x%x \n",\r\n(force_exec? "force to":""), lps_val, rpwm_val));\r\ncoex_dm->cur_lps = lps_val;\r\ncoex_dm->cur_rpwm = rpwm_val;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_lps/cur_lps=0x%x/0x%x, pre_rpwm/cur_rpwm=0x%x/0x%x!!\n",\r\ncoex_dm->pre_lps, coex_dm->cur_lps, coex_dm->pre_rpwm, coex_dm->cur_rpwm));\r\nif( (coex_dm->pre_lps == coex_dm->cur_lps) &&\r\n(coex_dm->pre_rpwm == coex_dm->cur_rpwm) )\r\n{\r\nreturn;\r\n}\r\n}\r\nhalbtc8812a1ant_SetLpsRpwm(btcoexist, lps_val, rpwm_val);\r\ncoex_dm->pre_lps = coex_dm->cur_lps;\r\ncoex_dm->pre_rpwm = coex_dm->cur_rpwm;\r\n}\r\nvoid\r\nhalbtc8812a1ant_SwMechanism1(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN shrink_rx_lpf,\r\nBOOLEAN low_penalty_ra,\r\nBOOLEAN limited_dig,\r\nBOOLEAN bt_lna_constrain\r\n)\r\n{\r\n}\r\nvoid\r\nhalbtc8812a1ant_SwMechanism2(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN agc_table_shift,\r\nBOOLEAN adc_back_off,\r\nBOOLEAN sw_dac_swing,\r\nu4Byte dac_swing_lvl\r\n)\r\n{\r\n}\r\nvoid\r\nhalbtc8812a1ant_PsTdma(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN force_exec,\r\nBOOLEAN turn_on,\r\nu1Byte type\r\n)\r\n{\r\nBOOLEAN bTurnOnByCnt=false;\r\nu1Byte psTdmaTypeByCnt=0, rssi_adjust_val=0;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], %s turn %s PS TDMA, type=%d\n",\r\n(force_exec? "force to":""), (turn_on? "ON":"OFF"), type));\r\ncoex_dm->cur_ps_tdma_on = turn_on;\r\ncoex_dm->cur_ps_tdma = type;\r\nif(!force_exec)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_ps_tdma_on = %d, cur_ps_tdma_on = %d!!\n",\r\ncoex_dm->pre_ps_tdma_on, coex_dm->cur_ps_tdma_on));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], pre_ps_tdma = %d, cur_ps_tdma = %d!!\n",\r\ncoex_dm->pre_ps_tdma, coex_dm->cur_ps_tdma));\r\nif( (coex_dm->pre_ps_tdma_on == coex_dm->cur_ps_tdma_on) &&\r\n(coex_dm->pre_ps_tdma == coex_dm->cur_ps_tdma) )\r\nreturn;\r\n}\r\nif(turn_on)\r\n{\r\nswitch(type)\r\n{\r\ndefault:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x1a, 0x1a, 0x0, 0x58);\r\nbreak;\r\ncase 1:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x1a, 0x1a, 0x0, 0x48);\r\nrssi_adjust_val = 11;\r\nbreak;\r\ncase 2:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x12, 0x12, 0x0, 0x48);\r\nrssi_adjust_val = 14;\r\nbreak;\r\ncase 3:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x25, 0x3, 0x10, 0x40);\r\nbreak;\r\ncase 4:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x15, 0x3, 0x14, 0x0);\r\nrssi_adjust_val = 17;\r\nbreak;\r\ncase 5:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x61, 0x15, 0x3, 0x31, 0x0);\r\nbreak;\r\ncase 6:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x13, 0xa, 0x3, 0x0, 0x0);\r\nbreak;\r\ncase 7:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x13, 0xc, 0x5, 0x0, 0x0);\r\nbreak;\r\ncase 8:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nbreak;\r\ncase 9:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0xa, 0xa, 0x0, 0x48);\r\nrssi_adjust_val = 18;\r\nbreak;\r\ncase 10:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x13, 0xa, 0xa, 0x0, 0x40);\r\nbreak;\r\ncase 11:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x5, 0x5, 0x0, 0x48);\r\nrssi_adjust_val = 20;\r\nbreak;\r\ncase 12:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xeb, 0xa, 0x3, 0x31, 0x18);\r\nbreak;\r\ncase 15:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x13, 0xa, 0x3, 0x8, 0x0);\r\nbreak;\r\ncase 16:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x15, 0x3, 0x10, 0x0);\r\nrssi_adjust_val = 18;\r\nbreak;\r\ncase 18:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x25, 0x3, 0x10, 0x0);\r\nrssi_adjust_val = 14;\r\nbreak;\r\ncase 20:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x13, 0x25, 0x25, 0x0, 0x0);\r\nbreak;\r\ncase 21:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x20, 0x3, 0x10, 0x40);\r\nbreak;\r\ncase 22:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x13, 0x8, 0x8, 0x0, 0x40);\r\nbreak;\r\ncase 23:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xe3, 0x25, 0x3, 0x31, 0x18);\r\nrssi_adjust_val = 22;\r\nbreak;\r\ncase 24:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xe3, 0x15, 0x3, 0x31, 0x18);\r\nrssi_adjust_val = 22;\r\nbreak;\r\ncase 25:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xe3, 0xa, 0x3, 0x31, 0x18);\r\nrssi_adjust_val = 22;\r\nbreak;\r\ncase 26:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xe3, 0xa, 0x3, 0x31, 0x18);\r\nrssi_adjust_val = 22;\r\nbreak;\r\ncase 27:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xe3, 0x25, 0x3, 0x31, 0x98);\r\nrssi_adjust_val = 22;\r\nbreak;\r\ncase 28:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x69, 0x25, 0x3, 0x31, 0x0);\r\nbreak;\r\ncase 29:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xab, 0x1a, 0x1a, 0x1, 0x8);\r\nbreak;\r\ncase 30:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x93, 0x15, 0x3, 0x14, 0x0);\r\nbreak;\r\ncase 31:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x1a, 0x1a, 0, 0x58);\r\nbreak;\r\ncase 32:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xab, 0xa, 0x3, 0x31, 0x88);\r\nbreak;\r\ncase 33:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xa3, 0x25, 0x3, 0x30, 0x88);\r\nbreak;\r\ncase 34:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x1a, 0x1a, 0x0, 0x8);\r\nbreak;\r\ncase 35:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xe3, 0x1a, 0x1a, 0x0, 0x8);\r\nbreak;\r\ncase 36:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0xd3, 0x12, 0x3, 0x14, 0x58);\r\nbreak;\r\n}\r\n}\r\nelse\r\n{\r\nswitch(type)\r\n{\r\ncase 8:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x8, 0x0, 0x0, 0x0, 0x0);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x92c, 0x4);\r\nbreak;\r\ncase 0:\r\ndefault:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x0, 0x0, 0x0, 0x0, 0x0);\r\ndelay_ms(5);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x92c, 0x20);\r\nbreak;\r\ncase 9:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x0, 0x0, 0x0, 0x0, 0x0);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x92c, 0x4);\r\nbreak;\r\ncase 10:\r\nhalbtc8812a1ant_SetFwPstdma(btcoexist, 0x0, 0x0, 0x0, 0x8, 0x0);\r\ndelay_ms(5);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x92c, 0x20);\r\nbreak;\r\n}\r\n}\r\nrssi_adjust_val =0;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_U1_RSSI_ADJ_VAL_FOR_1ANT_COEX_TYPE, &rssi_adjust_val);\r\ncoex_dm->pre_ps_tdma_on = coex_dm->cur_ps_tdma_on;\r\ncoex_dm->pre_ps_tdma = coex_dm->cur_ps_tdma;\r\n}\r\nvoid\r\nhalbtc8812a1ant_CoexAllOff(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,false,false,false,false);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nvoid\r\nhalbtc8812a1ant_WifiParaAdjust(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN enable\r\n)\r\n{\r\nif(enable)\r\n{\r\nhalbtc8812a1ant_LowPenaltyRa(btcoexist, NORMAL_EXEC, true);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_LowPenaltyRa(btcoexist, NORMAL_EXEC, false);\r\n}\r\n}\r\nBOOLEAN\r\nhalbtc8812a1ant_IsCommonAction(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBOOLEAN common=false, wifi_connected=false, wifi_busy=false;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\r\nif(!wifi_connected &&\r\nBT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi non connected-idle + BT non connected-idle!!\n"));\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,false,false,false,false);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\ncommon = true;\r\n}\r\nelse if(wifi_connected &&\r\n(BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi connected + BT non connected-idle!!\n"));\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,false,false,false,false);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\ncommon = true;\r\n}\r\nelse if(!wifi_connected &&\r\n(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi non connected-idle + BT connected-idle!!\n"));\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,false,false,false,false);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\ncommon = true;\r\n}\r\nelse if(wifi_connected &&\r\n(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi connected + BT connected-idle!!\n"));\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,true,true,true,true);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\ncommon = true;\r\n}\r\nelse if(!wifi_connected &&\r\n(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE != coex_dm->bt_status) )\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Wifi non connected-idle + BT Busy!!\n"));\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,false,false,false,false);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\ncommon = true;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,true,true,true,true);\r\ncommon = false;\r\n}\r\nreturn common;\r\n}\r\nvoid\r\nhalbtc8812a1ant_TdmaDurationAdjustForAcl(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nstatic s4Byte up,dn,m,n,wait_count;\r\ns4Byte result;\r\nu1Byte retry_count=0, bt_info_ext;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW, ("[BTCoex], halbtc8812a1ant_TdmaDurationAdjustForAcl()\n"));\r\nif(coex_dm->reset_tdma_adjust)\r\n{\r\ncoex_dm->reset_tdma_adjust = false;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], first run TdmaDurationAdjust()!!\n"));\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\ncoex_dm->ps_tdma_du_adj_type = 2;\r\nup = 0;\r\ndn = 0;\r\nm = 1;\r\nn= 3;\r\nresult = 0;\r\nwait_count = 0;\r\n}\r\nelse\r\n{\r\nretry_count = coex_sta->bt_retry_cnt;\r\nbt_info_ext = coex_sta->bt_info_ext;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], retry_count = %d\n", retry_count));\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], up=%d, dn=%d, m=%d, n=%d, wait_count=%d\n",\r\nup, dn, m, n, wait_count));\r\nresult = 0;\r\nwait_count++;\r\nif(retry_count == 0)\r\n{\r\nup++;\r\ndn--;\r\nif (dn <= 0)\r\ndn = 0;\r\nif(up >= n)\r\n{\r\nwait_count = 0;\r\nn = 3;\r\nup = 0;\r\ndn = 0;\r\nresult = 1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], Increase wifi duration!!\n"));\r\n}\r\n}\r\nelse if (retry_count <= 3)\r\n{\r\nup--;\r\ndn++;\r\nif (up <= 0)\r\nup = 0;\r\nif (dn == 2)\r\n{\r\nif (wait_count <= 2)\r\nm++;\r\nelse\r\nm = 1;\r\nif ( m >= 20)\r\nm = 20;\r\nn = 3*m;\r\nup = 0;\r\ndn = 0;\r\nwait_count = 0;\r\nresult = -1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], Decrease wifi duration for retryCounter<3!!\n"));\r\n}\r\n}\r\nelse\r\n{\r\nif (wait_count == 1)\r\nm++;\r\nelse\r\nm = 1;\r\nif ( m >= 20)\r\nm = 20;\r\nn = 3*m;\r\nup = 0;\r\ndn = 0;\r\nwait_count = 0;\r\nresult = -1;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE_FW_DETAIL, ("[BTCoex], Decrease wifi duration for retryCounter>3!!\n"));\r\n}\r\nif(result == -1)\r\n{\r\nif( (BT_INFO_8812A_1ANT_A2DP_BASIC_RATE(bt_info_ext)) &&\r\n((coex_dm->cur_ps_tdma == 1) ||(coex_dm->cur_ps_tdma == 2)) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 9);\r\ncoex_dm->ps_tdma_du_adj_type = 9;\r\n}\r\nelse if(coex_dm->cur_ps_tdma == 1)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\ncoex_dm->ps_tdma_du_adj_type = 2;\r\n}\r\nelse if(coex_dm->cur_ps_tdma == 2)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 9);\r\ncoex_dm->ps_tdma_du_adj_type = 9;\r\n}\r\nelse if(coex_dm->cur_ps_tdma == 9)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 11);\r\ncoex_dm->ps_tdma_du_adj_type = 11;\r\n}\r\n}\r\nelse if(result == 1)\r\n{\r\nif( (BT_INFO_8812A_1ANT_A2DP_BASIC_RATE(bt_info_ext)) &&\r\n((coex_dm->cur_ps_tdma == 1) ||(coex_dm->cur_ps_tdma == 2)) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 9);\r\ncoex_dm->ps_tdma_du_adj_type = 9;\r\n}\r\nelse if(coex_dm->cur_ps_tdma == 11)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 9);\r\ncoex_dm->ps_tdma_du_adj_type = 9;\r\n}\r\nelse if(coex_dm->cur_ps_tdma == 9)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\ncoex_dm->ps_tdma_du_adj_type = 2;\r\n}\r\nelse if(coex_dm->cur_ps_tdma == 2)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 1);\r\ncoex_dm->ps_tdma_du_adj_type = 1;\r\n}\r\n}\r\nif( coex_dm->cur_ps_tdma != 1 &&\r\ncoex_dm->cur_ps_tdma != 2 &&\r\ncoex_dm->cur_ps_tdma != 9 &&\r\ncoex_dm->cur_ps_tdma != 11 )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, coex_dm->ps_tdma_du_adj_type);\r\n}\r\n}\r\n}\r\nu1Byte\r\nhalbtc8812a1ant_PsTdmaTypeByWifiRssi(\r\ns4Byte wifi_rssi,\r\ns4Byte pre_wifi_rssi,\r\nu1Byte wifi_rssi_thresh\r\n)\r\n{\r\nu1Byte ps_tdma_type=0;\r\nif(wifi_rssi > pre_wifi_rssi)\r\n{\r\nif(wifi_rssi > (wifi_rssi_thresh+5))\r\n{\r\nps_tdma_type = 26;\r\n}\r\nelse\r\n{\r\nps_tdma_type = 25;\r\n}\r\n}\r\nelse\r\n{\r\nif(wifi_rssi > wifi_rssi_thresh)\r\n{\r\nps_tdma_type = 26;\r\n}\r\nelse\r\n{\r\nps_tdma_type = 25;\r\n}\r\n}\r\nreturn ps_tdma_type;\r\n}\r\nvoid\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN new_ps_state\r\n)\r\n{\r\nu1Byte lps_mode=0x0;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U1_LPS_MODE, &lps_mode);\r\nif(lps_mode)\r\n{\r\nif(new_ps_state)\r\n{\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 0);\r\n}\r\n}\r\nelse\r\n{\r\nif(new_ps_state)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 0);\r\n}\r\nelse\r\n{\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionSco(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state;\r\nu4Byte wifi_bw;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 4);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionHid(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state;\r\nu4Byte wifi_bw;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,false,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionA2dp(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state;\r\nu4Byte wifi_bw;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionA2dpPanHs(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state, bt_info_ext;\r\nu4Byte wifi_bw;\r\nbt_info_ext = coex_sta->bt_info_ext;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionPanEdr(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state;\r\nu4Byte wifi_bw;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionPanHs(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state;\r\nu4Byte wifi_bw;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\n}\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\n}\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionPanEdrA2dp(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state, bt_info_ext;\r\nu4Byte wifi_bw;\r\nbt_info_ext = coex_sta->bt_info_ext;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionPanEdrHid(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state;\r\nu4Byte wifi_bw;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionHidA2dpPanEdr(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state, bt_info_ext;\r\nu4Byte wifi_bw;\r\nbt_info_ext = coex_sta->bt_info_ext;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, NORMAL_EXEC, 6);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionHidA2dp(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu1Byte wifi_rssi_state, bt_rssi_state, bt_info_ext;\r\nu4Byte wifi_bw;\r\nbt_info_ext = coex_sta->bt_info_ext;\r\nwifi_rssi_state = halbtc8812a1ant_WifiRssiState(btcoexist, 0, 2, 25, 0);\r\nbt_rssi_state = halbtc8812a1ant_BtRssiState(2, 50, 0);\r\nif(halbtc8812a1ant_NeedToDecBtPwr(btcoexist))\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, true);\r\nelse\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, NORMAL_EXEC, false);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,true,false,0x18);\r\n}\r\n}\r\nelse\r\n{\r\nif( (wifi_rssi_state == BTC_RSSI_STATE_HIGH) ||\r\n(wifi_rssi_state == BTC_RSSI_STATE_STAY_HIGH) )\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,true,true,false,0x18);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionHs(\r\nPBTC_COEXIST btcoexist,\r\nBOOLEAN hs_connecting\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action for HS, hs_connecting=%d!!!\n", hs_connecting));\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nif(hs_connecting)\r\n{\r\nhalbtc8812a1ant_CoexTable(btcoexist, FORCE_EXEC, 0xaaaaaaaa, 0xaaaaaaaa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nif((coex_sta->high_priority_tx+coex_sta->high_priority_rx+\r\ncoex_sta->low_priority_tx+coex_sta->low_priority_rx)<=1200)\r\nhalbtc8812a1ant_CoexTable(btcoexist, FORCE_EXEC, 0xaaaaaaaa, 0xaaaaaaaa, 0xffff, 0x3);\r\nelse\r\nhalbtc8812a1ant_CoexTable(btcoexist, FORCE_EXEC, 0xffffffff, 0xffffffff, 0xffff, 0x3);\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionWifiNotConnected(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBOOLEAN hs_connecting=false;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_CONNECTING, &hs_connecting);\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nif(hs_connecting)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HS is connecting!!!\n"));\r\nhalbtc8812a1ant_ActionHs(btcoexist, hs_connecting);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionWifiNotConnectedAssoAuthScan(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN hs_connecting=false;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_CONNECTING, &hs_connecting);\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nif(hs_connecting)\r\n{\r\nhalbtc8812a1ant_ActionHs(btcoexist, hs_connecting);\r\n}\r\nelse if(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_INQ_PAGE == coex_dm->bt_status)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 30);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 28);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status)\r\n{\r\nif(stack_info->hid_exist)\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 35);\r\nelse\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 29);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5aea5aea, 0x5aea5aea, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 1;\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionWifiConnectedScan(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], ActionConnectedScan()===>\n"));\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nif(BT_8812A_1ANT_BT_STATUS_INQ_PAGE == coex_dm->bt_status)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], ActionConnectedScan(), bt is under inquiry/page scan\n"));\r\nif(stack_info->sco_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 32);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 30);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 5);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status)\r\n{\r\nif(stack_info->hid_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 34);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 4);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 33);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 2;\r\n}\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], ActionConnectedScan()<===\n"));\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionWifiConnectedSpecialPacket(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nif(BT_8812A_1ANT_BT_STATUS_INQ_PAGE == coex_dm->bt_status)\r\n{\r\nif(stack_info->sco_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 32);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 30);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 28);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status)\r\n{\r\nif(stack_info->hid_exist)\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 35);\r\nelse\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 29);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5aea5aea, 0x5aea5aea, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 3;\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_ActionWifiConnected(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN wifi_connected=false, wifi_busy=false, bt_hs_on=false;\r\nBOOLEAN scan=false, link=false, roam=false;\r\nBOOLEAN hs_connecting=false, under4way=false;\r\nu4Byte wifi_bw;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect()===>\n"));\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nif(!wifi_connected)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect(), return for wifi not connected<===\n"));\r\nreturn;\r\n}\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_4_WAY_PROGRESS, &under4way);\r\nif(under4way)\r\n{\r\nhalbtc8812a1ant_ActionWifiConnectedSpecialPacket(btcoexist);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect(), return for wifi is under 4way<===\n"));\r\nreturn;\r\n}\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_CONNECTING, &hs_connecting);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_SCAN, &scan);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_LINK, &link);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_ROAM, &roam);\r\nif(scan || link || roam)\r\n{\r\nhalbtc8812a1ant_ActionWifiConnectedScan(btcoexist);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect(), return for wifi is under scan<===\n"));\r\nreturn;\r\n}\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\r\nif(!wifi_busy)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi associated-idle!!!\n"));\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nif(BT_8812A_1ANT_BT_STATUS_INQ_PAGE == coex_dm->bt_status)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], bt is under inquiry/page scan!!!\n"));\r\nif(stack_info->sco_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 32);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 30);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x26, 0x0);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x26, 0x0);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 0);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status)\r\n{\r\nif(stack_info->hid_exist && stack_info->numOfLink==1)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5fff5fff, 0x5fff5fff, 0xffff, 0x3);\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nif(stack_info->hid_exist)\r\n{\r\nif(stack_info->a2dp_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse if(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\n}\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 4;\r\n}\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse if(stack_info->a2dp_exist)\r\n{\r\nif(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 36);\r\n}\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_TdmaDurationAdjustForAcl(btcoexist);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\n}\r\nelse if(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\ncoex_dm->error_condition = 5;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse\r\n{\r\n}\r\n}\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5aea5aea, 0x5aea5aea, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 7;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi busy!!!\n"));\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HS is under progress!!!\n"));\r\nhalbtc8812a1ant_ActionHs(btcoexist, hs_connecting);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_INQ_PAGE == coex_dm->bt_status)\r\n{\r\nif(stack_info->sco_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 32);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 30);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 5);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5a5a5a5a, 0x5a5a5a5a, 0xffff, 0x3);\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nif(bt_hs_on)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], HS is under progress!!!\n"));\r\nhalbtc8812a1ant_ActionHs(btcoexist, hs_connecting);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 5);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5a5a5a5a, 0x5a5a5a5a, 0xffff, 0x3);\r\n}\r\n}\r\nelse if(BT_8812A_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status)\r\n{\r\nif(stack_info->hid_exist && stack_info->numOfLink==1)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5fff5fff, 0x5fff5fff, 0xffff, 0x3);\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nif(stack_info->hid_exist)\r\n{\r\nif(stack_info->a2dp_exist)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse if(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\n}\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 8;\r\n}\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse if(stack_info->a2dp_exist)\r\n{\r\nif(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 36);\r\n}\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_TdmaDurationAdjustForAcl(btcoexist);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\n}\r\nelse if(stack_info->pan_exist)\r\n{\r\nif(bt_hs_on)\r\n{\r\ncoex_dm->error_condition = 9;\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, true, 2);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x5afa5afa, 0xffff, 0x3);\r\n}\r\ncoex_dm->reset_tdma_adjust = true;\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 10;\r\n}\r\n}\r\n}\r\nelse if( (BT_8812A_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status) )\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 8);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x5aea5aea, 0x5aea5aea, 0xffff, 0x3);\r\n}\r\nelse\r\n{\r\ncoex_dm->error_condition = 11;\r\n}\r\n}\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], CoexForWifiConnect()<===\n"));\r\n}\r\nvoid\r\nhalbtc8812a1ant_RunSwCoexistMechanism(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN wifi_under5g=false, wifi_busy=false, wifi_connected=false;\r\nu1Byte bt_info_original=0, bt_retry_cnt=0;\r\nu1Byte algorithm=0;\r\nreturn;\r\nif(stack_info->bProfileNotified)\r\n{\r\nalgorithm = halbtc8812a1ant_ActionAlgorithm(btcoexist);\r\ncoex_dm->cur_algorithm = algorithm;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Algorithm = %d \n", coex_dm->cur_algorithm));\r\nif(halbtc8812a1ant_IsCommonAction(btcoexist))\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action common.\n"));\r\n}\r\nelse\r\n{\r\nswitch(coex_dm->cur_algorithm)\r\n{\r\ncase BT_8812A_1ANT_COEX_ALGO_SCO:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = SCO.\n"));\r\nhalbtc8812a1ant_ActionSco(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_HID:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HID.\n"));\r\nhalbtc8812a1ant_ActionHid(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_A2DP:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = A2DP.\n"));\r\nhalbtc8812a1ant_ActionA2dp(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_A2DP_PANHS:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = A2DP+PAN(HS).\n"));\r\nhalbtc8812a1ant_ActionA2dpPanHs(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_PANEDR:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = PAN(EDR).\n"));\r\nhalbtc8812a1ant_ActionPanEdr(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_PANHS:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HS mode.\n"));\r\nhalbtc8812a1ant_ActionPanHs(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_PANEDR_A2DP:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = PAN+A2DP.\n"));\r\nhalbtc8812a1ant_ActionPanEdrA2dp(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_PANEDR_HID:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = PAN(EDR)+HID.\n"));\r\nhalbtc8812a1ant_ActionPanEdrHid(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_HID_A2DP_PANEDR:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HID+A2DP+PAN.\n"));\r\nhalbtc8812a1ant_ActionHidA2dpPanEdr(btcoexist);\r\nbreak;\r\ncase BT_8812A_1ANT_COEX_ALGO_HID_A2DP:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = HID+A2DP.\n"));\r\nhalbtc8812a1ant_ActionHidA2dp(btcoexist);\r\nbreak;\r\ndefault:\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Action algorithm = coexist All Off!!\n"));\r\nhalbtc8812a1ant_CoexAllOff(btcoexist);\r\nbreak;\r\n}\r\ncoex_dm->pre_algorithm = coex_dm->cur_algorithm;\r\n}\r\n}\r\n}\r\nvoid\r\nhalbtc8812a1ant_RunCoexistMechanism(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN wifi_under5g=false, wifi_busy=false, wifi_connected=false;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism()===>\n"));\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_UNDER_5G, &wifi_under5g);\r\nif(wifi_under5g)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism(), return for 5G <===\n"));\r\nreturn;\r\n}\r\nif(btcoexist->manual_control)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism(), return for Manual CTRL <===\n"));\r\nreturn;\r\n}\r\nif(btcoexist->stop_coex_dm)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism(), return for Stop Coex DM <===\n"));\r\nreturn;\r\n}\r\nhalbtc8812a1ant_RunSwCoexistMechanism(btcoexist);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], bt is disabled!!!\n"));\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\r\nif(wifi_busy)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, true);\r\nhalbtc8812a1ant_LpsRpwm(btcoexist, NORMAL_EXEC, 0x0, 0x4);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_ENTER_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\n}\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nelse if(coex_sta->under_ips)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi is under IPS !!!\n"));\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 0);\r\nhalbtc8812a1ant_CoexTable(btcoexist, NORMAL_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\nhalbtc8812a1ant_WifiParaAdjust(btcoexist, false);\r\n}\r\nelse if(!wifi_connected)\r\n{\r\nBOOLEAN scan=false, link=false, roam=false;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi is non connected-idle !!!\n"));\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_SCAN, &scan);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_LINK, &link);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_ROAM, &roam);\r\nif(scan || link || roam)\r\nhalbtc8812a1ant_ActionWifiNotConnectedAssoAuthScan(btcoexist);\r\nelse\r\nhalbtc8812a1ant_ActionWifiNotConnected(btcoexist);\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], wifi is NOT under IPS!!!\n"));\r\nhalbtc8812a1ant_WifiParaAdjust(btcoexist, true);\r\nhalbtc8812a1ant_ActionWifiConnected(btcoexist);\r\n}\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], RunCoexistMechanism()<===\n"));\r\n}\r\nvoid\r\nhalbtc8812a1ant_InitCoexDm(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBOOLEAN wifi_connected=false;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nif(!wifi_connected)\r\n{\r\nhalbtc8812a1ant_ActionWifiNotConnected(btcoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_ActionWifiConnected(btcoexist);\r\n}\r\nhalbtc8812a1ant_FwDacSwingLvl(btcoexist, FORCE_EXEC, 6);\r\nhalbtc8812a1ant_DecBtPwr(btcoexist, FORCE_EXEC, false);\r\nhalbtc8812a1ant_SwMechanism1(btcoexist,false,false,false,false);\r\nhalbtc8812a1ant_SwMechanism2(btcoexist,false,false,false,0x18);\r\nhalbtc8812a1ant_CoexTable(btcoexist, FORCE_EXEC, 0x55555555, 0x55555555, 0xffff, 0x3);\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_InitHwConfig(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nu4Byte u4_tmp=0;\r\nu2Byte u2Tmp=0;\r\nu1Byte u1_tmp=0;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], 1Ant Init HW Config!!\n"));\r\ncoex_dm->bt_rf0x1e_backup =\r\nbtcoexist->btc_get_rf_reg(btcoexist, BTC_RF_A, 0x1e, 0xfffff);\r\nbtcoexist->btc_write_4byte(btcoexist, 0x900, 0x00000400);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x76d, 0x1);\r\nbtcoexist->btc_write_1byte(btcoexist, 0xcb3, 0x77);\r\nbtcoexist->btc_write_1byte(btcoexist, 0xcb7, 0x40);\r\nu1_tmp = btcoexist->btc_read_1byte(btcoexist, 0x790);\r\nu1_tmp &= 0xc0;\r\nu1_tmp |= 0x5;\r\nbtcoexist->btc_write_1byte(btcoexist, 0x790, u1_tmp);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x6cc, 0x0);\r\nbtcoexist->btc_write_4byte(btcoexist, 0x6c8, 0xffff);\r\nbtcoexist->btc_write_4byte(btcoexist, 0x6c4, 0x55555555);\r\nbtcoexist->btc_write_4byte(btcoexist, 0x6c0, 0x55555555);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x778, 0x1);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x76e, 0x4);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x40, 0x20);\r\nu1_tmp = btcoexist->btc_read_1byte(btcoexist, 0x4);\r\nu1_tmp |= BIT7;\r\nbtcoexist->btc_write_1byte(btcoexist, 0x4, u1_tmp);\r\nu1_tmp = btcoexist->btc_read_1byte(btcoexist, 0x7);\r\nu1_tmp |= BIT1;\r\nbtcoexist->btc_write_1byte(btcoexist, 0x7, u1_tmp);\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_InitCoexDm(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_INIT, ("[BTCoex], Coex Mechanism Init!!\n"));\r\nbtcoexist->stop_coex_dm = false;\r\nhalbtc8812a1ant_InitCoexDm(btcoexist);\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_DisplayCoexInfo(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nPBTC_BOARD_INFO board_info=&btcoexist->boardInfo;\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\npu1Byte cli_buf=btcoexist->cli_buf;\r\nu1Byte u1_tmp[4], i, bt_info_ext, psTdmaCase=0;\r\nu4Byte u4_tmp[4];\r\nBOOLEAN roam=false, scan=false, link=false, wifi_under5g=false;\r\nBOOLEAN bt_hs_on=false, wifi_busy=false;\r\ns4Byte wifi_rssi=0, bt_hs_rssi=0;\r\nu4Byte wifi_bw, wifiTrafficDir;\r\nu1Byte wifiDot11Chnl, wifiHsChnl;\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n ============[BT Coexist info]============");\r\nCL_PRINTF(cli_buf);\r\nif(btcoexist->manual_control)\r\n{\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n ============[Under Manual Control]============");\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n ==========================================");\r\nCL_PRINTF(cli_buf);\r\n}\r\nif(btcoexist->stop_coex_dm)\r\n{\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n ============[Coex is STOPPED]============");\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n ==========================================");\r\nCL_PRINTF(cli_buf);\r\n}\r\nif(!board_info->bBtExist)\r\n{\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n BT not exists !!!");\r\nCL_PRINTF(cli_buf);\r\nreturn;\r\n}\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d ", "Ant PG number/ Ant mechanism:", \\r\nboard_info->pgAntNum, board_info->btdmAntNum);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s / %d", "BT stack/ hci ext ver", \\r\n((stack_info->bProfileNotified)? "Yes":"No"), stack_info->hciVersion);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_BT_FW_VER);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_HS_OPERATION, &bt_hs_on);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U1_WIFI_DOT11_CHNL, &wifiDot11Chnl);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U1_WIFI_HS_CHNL, &wifiHsChnl);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d / %d(%d)", "Dot11 channel / HsChnl(HsMode)", \\r\nwifiDot11Chnl, wifiHsChnl, bt_hs_on);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x ", "H2C Wifi inform bt chnl Info", \\r\ncoex_dm->wifi_chnl_info[0], coex_dm->wifi_chnl_info[1],\r\ncoex_dm->wifi_chnl_info[2]);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_S4_WIFI_RSSI, &wifi_rssi);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_S4_HS_RSSI, &bt_hs_rssi);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "Wifi rssi/ HS rssi", \\r\nwifi_rssi, bt_hs_rssi);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_SCAN, &scan);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_LINK, &link);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_ROAM, &roam);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d ", "Wifi link/ roam/ scan", \\r\nlink, roam, scan);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_UNDER_5G, &wifi_under5g);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_BUSY, &wifi_busy);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_TRAFFIC_DIRECTION, &wifiTrafficDir);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s / %s/ %s ", "Wifi status", \\r\n(wifi_under5g? "5G":"2.4G"),\r\n((BTC_WIFI_BW_LEGACY==wifi_bw)? "Legacy": (((BTC_WIFI_BW_HT40==wifi_bw)? "HT40":"HT20"))),\r\n((!wifi_busy)? "idle": ((BTC_WIFI_TRAFFIC_TX==wifiTrafficDir)? "uplink":"downlink")));\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = [%s/ %d/ %d] ", "BT [status/ rssi/ retryCnt]", \\r\n((coex_sta->c2h_bt_inquiry_page)?("inquiry/page scan"):((BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE == coex_dm->bt_status)? "non-connected idle":\r\n( (BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE == coex_dm->bt_status)? "connected-idle":"busy"))),\r\ncoex_sta->bt_rssi, coex_sta->bt_retry_cnt);\r\nCL_PRINTF(cli_buf);\r\nif(stack_info->bProfileNotified)\r\n{\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d / %d / %d / %d", "SCO/HID/PAN/A2DP", \\r\nstack_info->sco_exist, stack_info->hid_exist, stack_info->pan_exist, stack_info->a2dp_exist);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_BT_LINK_INFO);\r\n}\r\nbt_info_ext = coex_sta->bt_info_ext;\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s", "BT Info A2DP rate", \\r\n(bt_info_ext&BIT0)? "Basic rate":"EDR rate");\r\nCL_PRINTF(cli_buf);\r\nfor(i=0; i<BT_INFO_SRC_8812A_1ANT_MAX; i++)\r\n{\r\nif(coex_sta->bt_info_c2h_cnt[i])\r\n{\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x %02x %02x %02x %02x(%d)", GLBtInfoSrc8812a1Ant[i], \\r\ncoex_sta->bt_info_c2h[i][0], coex_sta->bt_info_c2h[i][1],\r\ncoex_sta->bt_info_c2h[i][2], coex_sta->bt_info_c2h[i][3],\r\ncoex_sta->bt_info_c2h[i][4], coex_sta->bt_info_c2h[i][5],\r\ncoex_sta->bt_info_c2h[i][6], coex_sta->bt_info_c2h_cnt[i]);\r\nCL_PRINTF(cli_buf);\r\n}\r\n}\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %s/%s, (0x%x/0x%x)", "PS state, IPS/LPS, (lps/rpwm)", \\r\n((coex_sta->under_ips? "IPS ON":"IPS OFF")),\r\n((coex_sta->under_lps? "LPS ON":"LPS OFF")),\r\nbtcoexist->bt_info.lps1Ant,\r\nbtcoexist->bt_info.rpwm1Ant);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_FW_PWR_MODE_CMD);\r\nif(!btcoexist->manual_control)\r\n{\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Sw mechanism]============");\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d/ %d ", "SM1[ShRf/ LpRA/ LimDig/ btLna]", \\r\ncoex_dm->cur_rf_rx_lpf_shrink, coex_dm->cur_low_penalty_ra, coex_dm->limited_dig, coex_dm->bCurBtLnaConstrain);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d/ %d(0x%x) ", "SM2[AgcT/ AdcB/ SwDacSwing(lvl)]", \\r\ncoex_dm->cur_agc_table_en, coex_dm->cur_adc_back_off, coex_dm->cur_dac_swing_on, coex_dm->cur_dac_swing_lvl);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Fw mechanism]============");\r\nCL_PRINTF(cli_buf);\r\npsTdmaCase = coex_dm->cur_ps_tdma;\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %02x %02x %02x %02x %02x case-%d", "PS TDMA", \\r\ncoex_dm->ps_tdma_para[0], coex_dm->ps_tdma_para[1],\r\ncoex_dm->ps_tdma_para[2], coex_dm->ps_tdma_para[3],\r\ncoex_dm->ps_tdma_para[4], psTdmaCase);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x ", "Latest error condition(should be 0)", \\r\ncoex_dm->error_condition);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d ", "DecBtPwr/ IgnWlanAct", \\r\ncoex_dm->cur_dec_bt_pwr, coex_dm->cur_ignore_wlan_act);\r\nCL_PRINTF(cli_buf);\r\n}\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s", "============[Hw setting]============");\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "RF-A, 0x1e initVal", \\r\ncoex_dm->bt_rf0x1e_backup);\r\nCL_PRINTF(cli_buf);\r\nu1_tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x778);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0x778", \\r\nu1_tmp[0]);\r\nCL_PRINTF(cli_buf);\r\nu1_tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x92c);\r\nu4_tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x930);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x92c/ 0x930", \\r\n(u1_tmp[0]), u4_tmp[0]);\r\nCL_PRINTF(cli_buf);\r\nu1_tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x40);\r\nu1_tmp[1] = btcoexist->btc_read_1byte(btcoexist, 0x4f);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x40/ 0x4f", \\r\nu1_tmp[0], u1_tmp[1]);\r\nCL_PRINTF(cli_buf);\r\nu4_tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x550);\r\nu1_tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x522);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0x550(bcn ctrl)/0x522", \\r\nu4_tmp[0], u1_tmp[0]);\r\nCL_PRINTF(cli_buf);\r\nu4_tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0xc50);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x", "0xc50(dig)", \\r\nu4_tmp[0]);\r\nCL_PRINTF(cli_buf);\r\n#if 0\r\nu4_tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0xf48);\r\nu4_tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0xf4c);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x", "0xf48/ 0xf4c (FA cnt)", \\r\nu4_tmp[0], u4_tmp[1]);\r\nCL_PRINTF(cli_buf);\r\n#endif\r\nu4_tmp[0] = btcoexist->btc_read_4byte(btcoexist, 0x6c0);\r\nu4_tmp[1] = btcoexist->btc_read_4byte(btcoexist, 0x6c4);\r\nu4_tmp[2] = btcoexist->btc_read_4byte(btcoexist, 0x6c8);\r\nu1_tmp[0] = btcoexist->btc_read_1byte(btcoexist, 0x6cc);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = 0x%x/ 0x%x/ 0x%x/ 0x%x", "0x6c0/0x6c4/0x6c8/0x6cc(coexTable)", \\r\nu4_tmp[0], u4_tmp[1], u4_tmp[2], u1_tmp[0]);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "0x770(hp rx[31:16]/tx[15:0])", \\r\ncoex_sta->high_priority_rx, coex_sta->high_priority_tx);\r\nCL_PRINTF(cli_buf);\r\nCL_SPRINTF(cli_buf, BT_TMP_BUF_SIZE, "\r\n %-35s = %d/ %d", "0x774(lp rx[31:16]/tx[15:0])", \\r\ncoex_sta->low_priority_rx, coex_sta->low_priority_tx);\r\nCL_PRINTF(cli_buf);\r\nbtcoexist->btc_disp_dbg_msg(btcoexist, BTC_DBG_DISP_COEX_STATISTICS);\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_IpsNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nu4Byte u4_tmp=0;\r\nif(btcoexist->manual_control || btcoexist->stop_coex_dm)\r\nreturn;\r\nif(BTC_IPS_ENTER == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], IPS ENTER notify\n"));\r\ncoex_sta->under_ips = true;\r\nu4_tmp = btcoexist->btc_read_4byte(btcoexist, 0x4c);\r\nu4_tmp |= BIT23;\r\nbtcoexist->btc_write_4byte(btcoexist, 0x4c, u4_tmp);\r\nhalbtc8812a1ant_CoexAllOff(btcoexist);\r\n}\r\nelse if(BTC_IPS_LEAVE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], IPS LEAVE notify\n"));\r\ncoex_sta->under_ips = false;\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_LpsNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nif(btcoexist->manual_control || btcoexist->stop_coex_dm)\r\nreturn;\r\nif(BTC_LPS_ENABLE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], LPS ENABLE notify\n"));\r\ncoex_sta->under_lps = true;\r\n}\r\nelse if(BTC_IPS_LEAVE == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], LPS DISABLE notify\n"));\r\ncoex_sta->under_lps = false;\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_ScanNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN wifi_connected=false;\r\nif(btcoexist->manual_control ||btcoexist->stop_coex_dm)\r\nreturn;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nif(BTC_SCAN_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], SCAN START notify\n"));\r\nif(!wifi_connected)\r\n{\r\nhalbtc8812a1ant_ActionWifiNotConnectedAssoAuthScan(btcoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_ActionWifiConnectedScan(btcoexist);\r\n}\r\n}\r\nelse if(BTC_SCAN_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], SCAN FINISH notify\n"));\r\nif(!wifi_connected)\r\n{\r\nhalbtc8812a1ant_ActionWifiNotConnected(btcoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_ActionWifiConnected(btcoexist);\r\n}\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_ConnectNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nPBTC_STACK_INFO stack_info=&btcoexist->stack_info;\r\nBOOLEAN wifi_connected=false;\r\nif(btcoexist->manual_control ||btcoexist->stop_coex_dm)\r\nreturn;\r\nif(BTC_ASSOCIATE_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], CONNECT START notify\n"));\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_ActionWifiNotConnectedAssoAuthScan(btcoexist);\r\n}\r\n}\r\nelse if(BTC_ASSOCIATE_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], CONNECT FINISH notify\n"));\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nif(!wifi_connected)\r\n{\r\nhalbtc8812a1ant_ActionWifiNotConnected(btcoexist);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_ActionWifiConnected(btcoexist);\r\n}\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_MediaStatusNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nu1Byte dataLen=5;\r\nu1Byte buf[6] = {0};\r\nu1Byte h2c_parameter[3] ={0};\r\nBOOLEAN wifi_under5g=false;\r\nu4Byte wifi_bw;\r\nu1Byte wifi_central_chnl;\r\nif(btcoexist->manual_control ||btcoexist->stop_coex_dm)\r\nreturn;\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_UNDER_5G, &wifi_under5g);\r\nif(!wifi_under5g)\r\n{\r\nif(BTC_MEDIA_CONNECT == type)\r\n{\r\nh2c_parameter[0] = 0x1;\r\n}\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U4_WIFI_BW, &wifi_bw);\r\nbtcoexist->btc_get(btcoexist, BTC_GET_U1_WIFI_CENTRAL_CHNL, &wifi_central_chnl);\r\nh2c_parameter[1] = wifi_central_chnl;\r\nif(BTC_WIFI_BW_HT40 == wifi_bw)\r\nh2c_parameter[2] = 0x30;\r\nelse\r\nh2c_parameter[2] = 0x20;\r\n}\r\ncoex_dm->wifi_chnl_info[0] = h2c_parameter[0];\r\ncoex_dm->wifi_chnl_info[1] = h2c_parameter[1];\r\ncoex_dm->wifi_chnl_info[2] = h2c_parameter[2];\r\nbuf[0] = dataLen;\r\nbuf[1] = 0x5;\r\nbuf[2] = 0x3;\r\nbuf[3] = h2c_parameter[0];\r\nbuf[4] = h2c_parameter[1];\r\nbuf[5] = h2c_parameter[2];\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_CTRL_BT_COEX, (PVOID)&buf[0]);\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_SpecialPacketNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nBOOLEAN bSecurityLink=false;\r\nif(btcoexist->manual_control ||btcoexist->stop_coex_dm)\r\nreturn;\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], special Packet(%d) notify\n", type));\r\nif(btcoexist->bt_info.bt_disabled)\r\n{\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_ActionWifiConnectedSpecialPacket(btcoexist);\r\n}\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_BtInfoNotify(\r\nPBTC_COEXIST btcoexist,\r\npu1Byte tmp_buf,\r\nu1Byte length\r\n)\r\n{\r\nu1Byte bt_info=0;\r\nu1Byte i, rsp_source=0;\r\nstatic u4Byte set_bt_lna_cnt=0, set_bt_psd_mode=0;\r\nBOOLEAN bt_busy=false, limited_dig=false;\r\nBOOLEAN wifi_connected=false;\r\nBOOLEAN bRejApAggPkt=false;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify()===>\n"));\r\nrsp_source = tmp_buf[0]&0xf;\r\nif(rsp_source >= BT_INFO_SRC_8812A_1ANT_MAX)\r\nrsp_source = BT_INFO_SRC_8812A_1ANT_WIFI_FW;\r\ncoex_sta->bt_info_c2h_cnt[rsp_source]++;\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Bt info[%d], length=%d, hex data=[", rsp_source, length));\r\nfor(i=0; i<length; i++)\r\n{\r\ncoex_sta->bt_info_c2h[rsp_source][i] = tmp_buf[i];\r\nif(i == 1)\r\nbt_info = tmp_buf[i];\r\nif(i == length-1)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("0x%2x]\n", tmp_buf[i]));\r\n}\r\nelse\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("0x%2x, ", tmp_buf[i]));\r\n}\r\n}\r\nif(btcoexist->manual_control)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), return for Manual CTRL<===\n"));\r\nreturn;\r\n}\r\nif(btcoexist->stop_coex_dm)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), return for Coex STOPPED!!<===\n"));\r\nreturn;\r\n}\r\nif(BT_INFO_SRC_8812A_1ANT_WIFI_FW != rsp_source)\r\n{\r\ncoex_sta->bt_retry_cnt =\r\ncoex_sta->bt_info_c2h[rsp_source][2];\r\ncoex_sta->bt_rssi =\r\ncoex_sta->bt_info_c2h[rsp_source][3]*2+10;\r\ncoex_sta->bt_info_ext =\r\ncoex_sta->bt_info_c2h[rsp_source][4];\r\nif( (coex_sta->bt_info_ext & BIT1) )\r\n{\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_CONNECTED, &wifi_connected);\r\nif(wifi_connected)\r\n{\r\nEXhalbtc8812a1ant_MediaStatusNotify(btcoexist, BTC_MEDIA_CONNECT);\r\n}\r\nelse\r\n{\r\nEXhalbtc8812a1ant_MediaStatusNotify(btcoexist, BTC_MEDIA_DISCONNECT);\r\n}\r\nset_bt_psd_mode = 0;\r\n}\r\n#if 0\r\nif(set_bt_psd_mode <= 3)\r\n{\r\nhalbtc8812a1ant_SetBtPsdMode(btcoexist, FORCE_EXEC, 0xd);\r\nset_bt_psd_mode++;\r\n}\r\nif(coex_dm->bCurBtLnaConstrain)\r\n{\r\nif( (coex_sta->bt_info_ext & BIT2) )\r\n{\r\n}\r\nelse\r\n{\r\nif(set_bt_lna_cnt <= 3)\r\n{\r\nhalbtc8812a1ant_SetBtLnaConstrain(btcoexist, FORCE_EXEC, true);\r\nset_bt_lna_cnt++;\r\n}\r\n}\r\n}\r\nelse\r\n{\r\nset_bt_lna_cnt = 0;\r\n}\r\n#endif\r\nif(BT_INFO_SRC_8812A_1ANT_BT_RSP == rsp_source)\r\n{\r\nif( (coex_sta->bt_info_ext & BIT3) )\r\n{\r\n#if 0\r\nhalbtc8812a1ant_IgnoreWlanAct(btcoexist, FORCE_EXEC, false);\r\n#endif\r\n}\r\nelse\r\n{\r\n}\r\nif( (coex_sta->bt_info_ext & BIT4) )\r\n{\r\n}\r\nelse\r\n{\r\nhalbtc8812a1ant_BtAutoReport(btcoexist, FORCE_EXEC, true);\r\n}\r\n}\r\n}\r\nif(bt_info & BT_INFO_8812A_1ANT_B_INQ_PAGE)\r\n{\r\ncoex_sta->c2h_bt_inquiry_page = true;\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_INQ_PAGE;\r\n}\r\nelse\r\n{\r\ncoex_sta->c2h_bt_inquiry_page = false;\r\nif(!(bt_info&BT_INFO_8812A_1ANT_B_CONNECTION))\r\n{\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_NON_CONNECTED_IDLE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt non-connected idle!!!\n"));\r\n}\r\nelse if(bt_info == BT_INFO_8812A_1ANT_B_CONNECTION)\r\n{\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_CONNECTED_IDLE;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt connected-idle!!!\n"));\r\n}\r\nelse if((bt_info&BT_INFO_8812A_1ANT_B_SCO_ESCO) ||\r\n(bt_info&BT_INFO_8812A_1ANT_B_SCO_BUSY))\r\n{\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_SCO_BUSY;\r\nbRejApAggPkt = true;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt sco busy!!!\n"));\r\n}\r\nelse if(bt_info&BT_INFO_8812A_1ANT_B_ACL_BUSY)\r\n{\r\nif(BT_8812A_1ANT_BT_STATUS_ACL_BUSY != coex_dm->bt_status)\r\ncoex_dm->reset_tdma_adjust = true;\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_ACL_BUSY;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt acl busy!!!\n"));\r\n}\r\n#if 0\r\nelse if(bt_info&BT_INFO_8812A_1ANT_B_SCO_ESCO)\r\n{\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt acl/sco busy!!!\n"));\r\n}\r\n#endif\r\nelse\r\n{\r\ncoex_dm->bt_status = BT_8812A_1ANT_BT_STATUS_MAX;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify(), bt non-defined state!!!\n"));\r\n}\r\n}\r\nif( (BT_8812A_1ANT_BT_STATUS_ACL_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_SCO_BUSY == coex_dm->bt_status) ||\r\n(BT_8812A_1ANT_BT_STATUS_ACL_SCO_BUSY == coex_dm->bt_status) )\r\n{\r\nbt_busy = true;\r\n}\r\nelse\r\n{\r\nbt_busy = false;\r\n}\r\nbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_TRAFFIC_BUSY, &bt_busy);\r\nif(bt_busy)\r\n{\r\nlimited_dig = true;\r\n}\r\nelse\r\n{\r\nlimited_dig = false;\r\n}\r\ncoex_dm->limited_dig = limited_dig;\r\nbtcoexist->btc_set(btcoexist, BTC_SET_BL_BT_LIMITED_DIG, &limited_dig);\r\nhalbtc8812a1ant_RunCoexistMechanism(btcoexist);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], BtInfoNotify()<===\n"));\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_StackOperationNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte type\r\n)\r\n{\r\nif(BTC_STACK_OP_INQ_PAGE_PAIR_START == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], StackOP Inquiry/page/pair start notify\n"));\r\n}\r\nelse if(BTC_STACK_OP_INQ_PAGE_PAIR_FINISH == type)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], StackOP Inquiry/page/pair finish notify\n"));\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_HaltNotify(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Halt notify\n"));\r\nhalbtc8812a1ant_IgnoreWlanAct(btcoexist, FORCE_EXEC, true);\r\nhalbtc8812a1ant_PsTdma(btcoexist, FORCE_EXEC, false, 0);\r\nbtcoexist->btc_write_1byte(btcoexist, 0x4f, 0xf);\r\nhalbtc8812a1ant_WifiParaAdjust(btcoexist, false);\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_PnpNotify(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte pnpState\r\n)\r\n{\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], Pnp notify\n"));\r\nif(BTC_WIFI_PNP_SLEEP == pnpState)\r\n{\r\nbtcoexist->stop_coex_dm = true;\r\nhalbtc8812a1ant_IgnoreWlanAct(btcoexist, FORCE_EXEC, true);\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\n}\r\nelse if(BTC_WIFI_PNP_WAKE_UP == pnpState)\r\n{\r\n}\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_Periodical(\r\nPBTC_COEXIST btcoexist\r\n)\r\n{\r\nBOOLEAN wifi_under5g=false;\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Periodical()===>\n"));\r\nBTC_PRINT(BTC_MSG_INTERFACE, INTF_NOTIFY, ("[BTCoex], 1Ant Periodical!!\n"));\r\nbtcoexist->btc_get(btcoexist, BTC_GET_BL_WIFI_UNDER_5G, &wifi_under5g);\r\nif(wifi_under5g)\r\n{\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Periodical(), return for 5G<===\n"));\r\nhalbtc8812a1ant_CoexAllOff(btcoexist);\r\nreturn;\r\n}\r\nhalbtc8812a1ant_QueryBtInfo(btcoexist);\r\nhalbtc8812a1ant_MonitorBtCtr(btcoexist);\r\nhalbtc8812a1ant_MonitorBtEnableDisable(btcoexist);\r\nBTC_PRINT(BTC_MSG_ALGORITHM, ALGO_TRACE, ("[BTCoex], Periodical()<===\n"));\r\n}\r\nvoid\r\nEXhalbtc8812a1ant_DbgControl(\r\nPBTC_COEXIST btcoexist,\r\nu1Byte opCode,\r\nu1Byte opLen,\r\npu1Byte pData\r\n)\r\n{\r\nswitch(opCode)\r\n{\r\ncase BTC_DBG_SET_COEX_NORMAL:\r\nbtcoexist->manual_control = false;\r\nhalbtc8812a1ant_InitCoexDm(btcoexist);\r\nbreak;\r\ncase BTC_DBG_SET_COEX_WIFI_ONLY:\r\nbtcoexist->manual_control = true;\r\nhalbtc8812a1ant_PsTdmaCheckForPowerSaveState(btcoexist, false);\r\nbtcoexist->btc_set(btcoexist, BTC_SET_ACT_LEAVE_LPS, NULL);\r\nhalbtc8812a1ant_PsTdma(btcoexist, NORMAL_EXEC, false, 9);\r\nbreak;\r\ncase BTC_DBG_SET_COEX_BT_ONLY:\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}

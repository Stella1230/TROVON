static inline int max8925_read_device(struct i2c_client *i2c,\r\nint reg, int bytes, void *dest)\r\n{\r\nint ret;\r\nif (bytes > 1)\r\nret = i2c_smbus_read_i2c_block_data(i2c, reg, bytes, dest);\r\nelse {\r\nret = i2c_smbus_read_byte_data(i2c, reg);\r\nif (ret < 0)\r\nreturn ret;\r\n*(unsigned char *)dest = (unsigned char)ret;\r\n}\r\nreturn ret;\r\n}\r\nstatic inline int max8925_write_device(struct i2c_client *i2c,\r\nint reg, int bytes, void *src)\r\n{\r\nunsigned char buf[bytes + 1];\r\nint ret;\r\nbuf[0] = (unsigned char)reg;\r\nmemcpy(&buf[1], src, bytes);\r\nret = i2c_master_send(i2c, buf, bytes + 1);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nint max8925_reg_read(struct i2c_client *i2c, int reg)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char data = 0;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_read_device(i2c, reg, 1, &data);\r\nmutex_unlock(&chip->io_lock);\r\nif (ret < 0)\r\nreturn ret;\r\nelse\r\nreturn (int)data;\r\n}\r\nint max8925_reg_write(struct i2c_client *i2c, int reg,\r\nunsigned char data)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_write_device(i2c, reg, 1, &data);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint max8925_bulk_read(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_read_device(i2c, reg, count, buf);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint max8925_bulk_write(struct i2c_client *i2c, int reg,\r\nint count, unsigned char *buf)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_write_device(i2c, reg, count, buf);\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nint max8925_set_bits(struct i2c_client *i2c, int reg,\r\nunsigned char mask, unsigned char data)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(i2c);\r\nunsigned char value;\r\nint ret;\r\nmutex_lock(&chip->io_lock);\r\nret = max8925_read_device(i2c, reg, 1, &value);\r\nif (ret < 0)\r\ngoto out;\r\nvalue &= ~mask;\r\nvalue |= data;\r\nret = max8925_write_device(i2c, reg, 1, &value);\r\nout:\r\nmutex_unlock(&chip->io_lock);\r\nreturn ret;\r\n}\r\nstatic int max8925_dt_init(struct device_node *np, struct device *dev,\r\nstruct max8925_platform_data *pdata)\r\n{\r\nint ret;\r\nret = of_property_read_u32(np, "maxim,tsc-irq", &pdata->tsc_irq);\r\nif (ret) {\r\ndev_err(dev, "Not found maxim,tsc-irq property\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8925_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct max8925_platform_data *pdata = dev_get_platdata(&client->dev);\r\nstatic struct max8925_chip *chip;\r\nstruct device_node *node = client->dev.of_node;\r\nif (node && !pdata) {\r\npdata = devm_kzalloc(&client->dev,\r\nsizeof(struct max8925_platform_data),\r\nGFP_KERNEL);\r\nif (!pdata)\r\nreturn -ENOMEM;\r\nif (max8925_dt_init(node, &client->dev, pdata))\r\nreturn -EINVAL;\r\n} else if (!pdata) {\r\npr_info("%s: platform data is missing\n", __func__);\r\nreturn -EINVAL;\r\n}\r\nchip = devm_kzalloc(&client->dev,\r\nsizeof(struct max8925_chip), GFP_KERNEL);\r\nif (chip == NULL)\r\nreturn -ENOMEM;\r\nchip->i2c = client;\r\nchip->dev = &client->dev;\r\ni2c_set_clientdata(client, chip);\r\ndev_set_drvdata(chip->dev, chip);\r\nmutex_init(&chip->io_lock);\r\nchip->rtc = i2c_new_dummy(chip->i2c->adapter, RTC_I2C_ADDR);\r\nif (!chip->rtc) {\r\ndev_err(chip->dev, "Failed to allocate I2C device for RTC\n");\r\nreturn -ENODEV;\r\n}\r\ni2c_set_clientdata(chip->rtc, chip);\r\nchip->adc = i2c_new_dummy(chip->i2c->adapter, ADC_I2C_ADDR);\r\nif (!chip->adc) {\r\ndev_err(chip->dev, "Failed to allocate I2C device for ADC\n");\r\ni2c_unregister_device(chip->rtc);\r\nreturn -ENODEV;\r\n}\r\ni2c_set_clientdata(chip->adc, chip);\r\ndevice_init_wakeup(&client->dev, 1);\r\nmax8925_device_init(chip, pdata);\r\nreturn 0;\r\n}\r\nstatic int max8925_remove(struct i2c_client *client)\r\n{\r\nstruct max8925_chip *chip = i2c_get_clientdata(client);\r\nmax8925_device_exit(chip);\r\ni2c_unregister_device(chip->adc);\r\ni2c_unregister_device(chip->rtc);\r\nreturn 0;\r\n}\r\nstatic int max8925_suspend(struct device *dev)\r\n{\r\nstruct i2c_client *client = container_of(dev, struct i2c_client, dev);\r\nstruct max8925_chip *chip = i2c_get_clientdata(client);\r\nif (device_may_wakeup(dev) && chip->wakeup_flag)\r\nenable_irq_wake(chip->core_irq);\r\nreturn 0;\r\n}\r\nstatic int max8925_resume(struct device *dev)\r\n{\r\nstruct i2c_client *client = container_of(dev, struct i2c_client, dev);\r\nstruct max8925_chip *chip = i2c_get_clientdata(client);\r\nif (device_may_wakeup(dev) && chip->wakeup_flag)\r\ndisable_irq_wake(chip->core_irq);\r\nreturn 0;\r\n}\r\nstatic int __init max8925_i2c_init(void)\r\n{\r\nint ret;\r\nret = i2c_add_driver(&max8925_driver);\r\nif (ret != 0)\r\npr_err("Failed to register MAX8925 I2C driver: %d\n", ret);\r\nreturn ret;\r\n}\r\nstatic void __exit max8925_i2c_exit(void)\r\n{\r\ni2c_del_driver(&max8925_driver);\r\n}

static inline u8 ads7828_cmd_byte(u8 cmd, int ch)\r\n{\r\nreturn cmd | (((ch >> 1) | (ch & 0x01) << 2) << 4);\r\n}\r\nstatic struct ads7828_data *ads7828_update_device(struct device *dev)\r\n{\r\nstruct i2c_client *client = to_i2c_client(dev);\r\nstruct ads7828_data *data = i2c_get_clientdata(client);\r\nmutex_lock(&data->update_lock);\r\nif (time_after(jiffies, data->last_updated + HZ + HZ / 2)\r\n|| !data->valid) {\r\nunsigned int ch;\r\ndev_dbg(&client->dev, "Starting ads7828 update\n");\r\nfor (ch = 0; ch < ADS7828_NCH; ch++) {\r\nu8 cmd = ads7828_cmd_byte(data->cmd_byte, ch);\r\ndata->adc_input[ch] = data->read_channel(client, cmd);\r\n}\r\ndata->last_updated = jiffies;\r\ndata->valid = true;\r\n}\r\nmutex_unlock(&data->update_lock);\r\nreturn data;\r\n}\r\nstatic ssize_t ads7828_show_in(struct device *dev, struct device_attribute *da,\r\nchar *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(da);\r\nstruct ads7828_data *data = ads7828_update_device(dev);\r\nunsigned int value = DIV_ROUND_CLOSEST(data->adc_input[attr->index] *\r\ndata->lsb_resol, 1000);\r\nreturn sprintf(buf, "%d\n", value);\r\n}\r\nstatic int ads7828_remove(struct i2c_client *client)\r\n{\r\nstruct ads7828_data *data = i2c_get_clientdata(client);\r\nhwmon_device_unregister(data->hwmon_dev);\r\nsysfs_remove_group(&client->dev.kobj, &ads7828_group);\r\nreturn 0;\r\n}\r\nstatic int ads7828_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nstruct ads7828_platform_data *pdata = dev_get_platdata(&client->dev);\r\nstruct ads7828_data *data;\r\nint err;\r\ndata = devm_kzalloc(&client->dev, sizeof(struct ads7828_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nif (pdata) {\r\ndata->diff_input = pdata->diff_input;\r\ndata->ext_vref = pdata->ext_vref;\r\nif (data->ext_vref)\r\ndata->vref_mv = pdata->vref_mv;\r\n}\r\nif (data->vref_mv)\r\ndata->vref_mv = clamp_val(data->vref_mv,\r\nADS7828_EXT_VREF_MV_MIN,\r\nADS7828_EXT_VREF_MV_MAX);\r\nelse\r\ndata->vref_mv = ADS7828_INT_VREF_MV;\r\nif (id->driver_data == ads7828) {\r\ndata->lsb_resol = DIV_ROUND_CLOSEST(data->vref_mv * 1000, 4096);\r\ndata->read_channel = i2c_smbus_read_word_swapped;\r\n} else {\r\ndata->lsb_resol = DIV_ROUND_CLOSEST(data->vref_mv * 1000, 256);\r\ndata->read_channel = i2c_smbus_read_byte_data;\r\n}\r\ndata->cmd_byte = data->ext_vref ? ADS7828_CMD_PD1 : ADS7828_CMD_PD3;\r\nif (!data->diff_input)\r\ndata->cmd_byte |= ADS7828_CMD_SD_SE;\r\ni2c_set_clientdata(client, data);\r\nmutex_init(&data->update_lock);\r\nerr = sysfs_create_group(&client->dev.kobj, &ads7828_group);\r\nif (err)\r\nreturn err;\r\ndata->hwmon_dev = hwmon_device_register(&client->dev);\r\nif (IS_ERR(data->hwmon_dev)) {\r\nerr = PTR_ERR(data->hwmon_dev);\r\ngoto error;\r\n}\r\nreturn 0;\r\nerror:\r\nsysfs_remove_group(&client->dev.kobj, &ads7828_group);\r\nreturn err;\r\n}

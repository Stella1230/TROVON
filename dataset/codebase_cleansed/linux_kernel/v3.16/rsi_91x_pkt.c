int rsi_send_data_pkt(struct rsi_common *common, struct sk_buff *skb)\r\n{\r\nstruct rsi_hw *adapter = common->priv;\r\nstruct ieee80211_hdr *tmp_hdr = NULL;\r\nstruct ieee80211_tx_info *info;\r\nstruct skb_info *tx_params;\r\nstruct ieee80211_bss_conf *bss = NULL;\r\nint status = -EINVAL;\r\nu8 ieee80211_size = MIN_802_11_HDR_LEN;\r\nu8 extnd_size = 0;\r\n__le16 *frame_desc;\r\nu16 seq_num = 0;\r\ninfo = IEEE80211_SKB_CB(skb);\r\nbss = &info->control.vif->bss_conf;\r\ntx_params = (struct skb_info *)info->driver_data;\r\nif (!bss->assoc)\r\ngoto err;\r\ntmp_hdr = (struct ieee80211_hdr *)&skb->data[0];\r\nseq_num = (le16_to_cpu(tmp_hdr->seq_ctrl) >> 4);\r\nextnd_size = ((uintptr_t)skb->data & 0x3);\r\nif ((FRAME_DESC_SZ + extnd_size) > skb_headroom(skb)) {\r\nrsi_dbg(ERR_ZONE, "%s: Unable to send pkt\n", __func__);\r\nstatus = -ENOSPC;\r\ngoto err;\r\n}\r\nskb_push(skb, (FRAME_DESC_SZ + extnd_size));\r\nframe_desc = (__le16 *)&skb->data[0];\r\nmemset((u8 *)frame_desc, 0, FRAME_DESC_SZ);\r\nif (ieee80211_is_data_qos(tmp_hdr->frame_control)) {\r\nieee80211_size += 2;\r\nframe_desc[6] |= cpu_to_le16(BIT(12));\r\n}\r\nif ((!(info->flags & IEEE80211_TX_INTFL_DONT_ENCRYPT)) &&\r\n(common->secinfo.security_enable)) {\r\nif (rsi_is_cipher_wep(common))\r\nieee80211_size += 4;\r\nelse\r\nieee80211_size += 8;\r\nframe_desc[6] |= cpu_to_le16(BIT(15));\r\n}\r\nframe_desc[0] = cpu_to_le16((skb->len - FRAME_DESC_SZ) |\r\n(RSI_WIFI_DATA_Q << 12));\r\nframe_desc[2] = cpu_to_le16((extnd_size) | (ieee80211_size) << 8);\r\nif (common->min_rate != 0xffff) {\r\nframe_desc[3] = cpu_to_le16(RATE_INFO_ENABLE);\r\nframe_desc[4] = cpu_to_le16(common->min_rate);\r\n}\r\nframe_desc[6] |= cpu_to_le16(seq_num & 0xfff);\r\nframe_desc[7] = cpu_to_le16(((tx_params->tid & 0xf) << 4) |\r\n(skb->priority & 0xf) |\r\n(tx_params->sta_id << 8));\r\nstatus = adapter->host_intf_write_pkt(common->priv,\r\nskb->data,\r\nskb->len);\r\nif (status)\r\nrsi_dbg(ERR_ZONE, "%s: Failed to write pkt\n",\r\n__func__);\r\nerr:\r\n++common->tx_stats.total_tx_pkt_freed[skb->priority];\r\nrsi_indicate_tx_status(common->priv, skb, status);\r\nreturn status;\r\n}\r\nint rsi_send_mgmt_pkt(struct rsi_common *common,\r\nstruct sk_buff *skb)\r\n{\r\nstruct rsi_hw *adapter = common->priv;\r\nstruct ieee80211_hdr *wh = NULL;\r\nstruct ieee80211_tx_info *info;\r\nstruct ieee80211_bss_conf *bss = NULL;\r\nstruct skb_info *tx_params;\r\nint status = -E2BIG;\r\n__le16 *msg = NULL;\r\nu8 extnd_size = 0;\r\nu8 vap_id = 0;\r\ninfo = IEEE80211_SKB_CB(skb);\r\ntx_params = (struct skb_info *)info->driver_data;\r\nextnd_size = ((uintptr_t)skb->data & 0x3);\r\nif (tx_params->flags & INTERNAL_MGMT_PKT) {\r\nif ((extnd_size) > skb_headroom(skb)) {\r\nrsi_dbg(ERR_ZONE, "%s: Unable to send pkt\n", __func__);\r\ndev_kfree_skb(skb);\r\nreturn -ENOSPC;\r\n}\r\nskb_push(skb, extnd_size);\r\nskb->data[extnd_size + 4] = extnd_size;\r\nstatus = adapter->host_intf_write_pkt(common->priv,\r\n(u8 *)skb->data,\r\nskb->len);\r\nif (status) {\r\nrsi_dbg(ERR_ZONE,\r\n"%s: Failed to write the packet\n", __func__);\r\n}\r\ndev_kfree_skb(skb);\r\nreturn status;\r\n}\r\nbss = &info->control.vif->bss_conf;\r\nwh = (struct ieee80211_hdr *)&skb->data[0];\r\nif (FRAME_DESC_SZ > skb_headroom(skb))\r\ngoto err;\r\nskb_push(skb, FRAME_DESC_SZ);\r\nmemset(skb->data, 0, FRAME_DESC_SZ);\r\nmsg = (__le16 *)skb->data;\r\nif (skb->len > MAX_MGMT_PKT_SIZE) {\r\nrsi_dbg(INFO_ZONE, "%s: Dropping mgmt pkt > 512\n", __func__);\r\ngoto err;\r\n}\r\nmsg[0] = cpu_to_le16((skb->len - FRAME_DESC_SZ) |\r\n(RSI_WIFI_MGMT_Q << 12));\r\nmsg[1] = cpu_to_le16(TX_DOT11_MGMT);\r\nmsg[2] = cpu_to_le16(MIN_802_11_HDR_LEN << 8);\r\nmsg[3] = cpu_to_le16(RATE_INFO_ENABLE);\r\nmsg[6] = cpu_to_le16(le16_to_cpu(wh->seq_ctrl) >> 4);\r\nif (wh->addr1[0] & BIT(0))\r\nmsg[3] |= cpu_to_le16(RSI_BROADCAST_PKT);\r\nif (common->band == IEEE80211_BAND_2GHZ)\r\nmsg[4] = cpu_to_le16(RSI_11B_MODE);\r\nelse\r\nmsg[4] = cpu_to_le16((RSI_RATE_6 & 0x0f) | RSI_11G_MODE);\r\nif ((skb->data[16] == IEEE80211_STYPE_PROBE_REQ) && (!bss->assoc)) {\r\nmsg[1] |= cpu_to_le16(BIT(10));\r\nmsg[7] = cpu_to_le16(PROBEREQ_CONFIRM);\r\ncommon->mgmt_q_block = true;\r\n}\r\nmsg[7] |= cpu_to_le16(vap_id << 8);\r\nstatus = adapter->host_intf_write_pkt(common->priv,\r\n(u8 *)msg,\r\nskb->len);\r\nif (status)\r\nrsi_dbg(ERR_ZONE, "%s: Failed to write the packet\n", __func__);\r\nerr:\r\nrsi_indicate_tx_status(common->priv, skb, status);\r\nreturn status;\r\n}

void rtl8723ae_bt_coex_off_before_lps(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_ps_ctl *ppsc = rtl_psc(rtl_priv(hw));\r\nif (!rtlpcipriv->bt_coexist.bt_coexistence)\r\nreturn;\r\nif (ppsc->inactiveps) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BT][DM], Before enter IPS, turn off all Coexist DM\n");\r\nrtlpcipriv->bt_coexist.cstate = 0;\r\nrtlpcipriv->bt_coexist.previous_state = 0;\r\nrtlpcipriv->bt_coexist.cstate_h = 0;\r\nrtlpcipriv->bt_coexist.previous_state_h = 0;\r\nrtl8723ae_btdm_coex_all_off(hw);\r\n}\r\n}\r\nstatic enum _RT_MEDIA_STATUS mgnt_link_status_query(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_mac *mac = rtl_mac(rtl_priv(hw));\r\nenum _RT_MEDIA_STATUS m_status = RT_MEDIA_DISCONNECT;\r\nu8 bibss = (mac->opmode == NL80211_IFTYPE_ADHOC) ? 1 : 0;\r\nif (bibss || rtlpriv->mac80211.link_state >= MAC80211_LINKED)\r\nm_status = RT_MEDIA_CONNECT;\r\nreturn m_status;\r\n}\r\nvoid rtl_8723e_bt_wifi_media_status_notify(struct ieee80211_hw *hw,\r\nbool mstatus)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nu8 h2c_parameter[3] = {0};\r\nu8 chnl;\r\nif (!rtlpcipriv->bt_coexist.bt_coexistence)\r\nreturn;\r\nif (RT_MEDIA_CONNECT == mstatus)\r\nh2c_parameter[0] = 0x1;\r\nelse\r\nh2c_parameter[0] = 0x0;\r\nif (mgnt_link_status_query(hw)) {\r\nchnl = rtlphy->current_channel;\r\nh2c_parameter[1] = chnl;\r\n}\r\nif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40)\r\nh2c_parameter[2] = 0x30;\r\nelse\r\nh2c_parameter[2] = 0x20;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], FW write 0x19 = 0x%x\n",\r\nh2c_parameter[0]<<16|h2c_parameter[1]<<8|h2c_parameter[2]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x19, 3, h2c_parameter);\r\n}\r\nstatic bool rtl8723ae_dm_bt_is_wifi_busy(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (rtlpriv->link_info.busytraffic ||\r\nrtlpriv->link_info.rx_busy_traffic ||\r\nrtlpriv->link_info.tx_busy_traffic)\r\nreturn true;\r\nelse\r\nreturn false;\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_3a(struct ieee80211_hw *hw,\r\nu8 byte1, u8 byte2, u8 byte3,\r\nu8 byte4, u8 byte5)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter[5] = {0};\r\nh2c_parameter[0] = byte1;\r\nh2c_parameter[1] = byte2;\r\nh2c_parameter[2] = byte3;\r\nh2c_parameter[3] = byte4;\r\nh2c_parameter[4] = byte5;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], FW write 0x3a(4bytes) = 0x%x%8x\n",\r\nh2c_parameter[0], h2c_parameter[1]<<24 | h2c_parameter[2]<<16 |\r\nh2c_parameter[3]<<8 | h2c_parameter[4]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x3a, 5, h2c_parameter);\r\n}\r\nstatic bool rtl8723ae_dm_bt_need_to_dec_bt_pwr(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (mgnt_link_status_query(hw) == RT_MEDIA_CONNECT) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Need to decrease bt power\n");\r\nrtlpcipriv->bt_coexist.cstate |= BT_COEX_STATE_DEC_BT_POWER;\r\nreturn true;\r\n}\r\nrtlpcipriv->bt_coexist.cstate &= ~BT_COEX_STATE_DEC_BT_POWER;\r\nreturn false;\r\n}\r\nstatic bool rtl8723ae_dm_bt_is_same_coexist_state(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nif ((rtlpcipriv->bt_coexist.previous_state ==\r\nrtlpcipriv->bt_coexist.cstate) &&\r\n(rtlpcipriv->bt_coexist.previous_state_h ==\r\nrtlpcipriv->bt_coexist.cstate_h)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[DM][BT], Coexist state do not chang!!\n");\r\nreturn true;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[DM][BT], Coexist state changed!!\n");\r\nreturn false;\r\n}\r\n}\r\nstatic void rtl8723ae_dm_bt_set_coex_table(struct ieee80211_hw *hw,\r\nu32 val_0x6c0, u32 val_0x6c8,\r\nu32 val_0x6cc)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"set coex table, set 0x6c0 = 0x%x\n", val_0x6c0);\r\nrtl_write_dword(rtlpriv, 0x6c0, val_0x6c0);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"set coex table, set 0x6c8 = 0x%x\n", val_0x6c8);\r\nrtl_write_dword(rtlpriv, 0x6c8, val_0x6c8);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"set coex table, set 0x6cc = 0x%x\n", val_0x6cc);\r\nrtl_write_byte(rtlpriv, 0x6cc, val_0x6cc);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_hw_pta_mode(struct ieee80211_hw *hw, bool mode)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (BT_PTA_MODE_ON == mode) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE, "PTA mode on, ");\r\nrtl_write_byte(rtlpriv, 0x40, 0x20);\r\nrtlpcipriv->bt_coexist.hw_coexist_all_off = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE, "PTA mode off\n");\r\nrtl_write_byte(rtlpriv, 0x40, 0x0);\r\n}\r\n}\r\nstatic void rtl8723ae_dm_bt_set_sw_rf_rx_lpf_corner(struct ieee80211_hw *hw,\r\nu8 type)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (BT_RF_RX_LPF_CORNER_SHRINK == type) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"Shrink RF Rx LPF corner!!\n");\r\nrtl8723ae_phy_set_rf_reg(hw, RF90_PATH_A, 0x1e, 0xfffff,\r\n0xf0ff7);\r\nrtlpcipriv->bt_coexist.sw_coexist_all_off = false;\r\n} else if (BT_RF_RX_LPF_CORNER_RESUME == type) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"Resume RF Rx LPF corner!!\n");\r\nrtl8723ae_phy_set_rf_reg(hw, RF90_PATH_A, 0x1e, 0xfffff,\r\nrtlpcipriv->bt_coexist.bt_rfreg_origin_1e);\r\n}\r\n}\r\nstatic void rtl8723ae_bt_set_penalty_tx_rate_adap(struct ieee80211_hw *hw,\r\nu8 ra_type)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu8 tmu1;\r\ntmu1 = rtl_read_byte(rtlpriv, 0x4fd);\r\ntmu1 |= BIT(0);\r\nif (BT_TX_RATE_ADAPTIVE_LOW_PENALTY == ra_type) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"Tx rate adaptive, set low penalty!!\n");\r\ntmu1 &= ~BIT(2);\r\nrtlpcipriv->bt_coexist.sw_coexist_all_off = false;\r\n} else if (BT_TX_RATE_ADAPTIVE_NORMAL == ra_type) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"Tx rate adaptive, set normal!!\n");\r\ntmu1 |= BIT(2);\r\n}\r\nrtl_write_byte(rtlpriv, 0x4fd, tmu1);\r\n}\r\nstatic void rtl8723ae_dm_bt_btdm_structure_reload(struct ieee80211_hw *hw,\r\nstruct btdm_8723 *btdm)\r\n{\r\nbtdm->all_off = false;\r\nbtdm->agc_table_en = false;\r\nbtdm->adc_back_off_on = false;\r\nbtdm->b2_ant_hid_en = false;\r\nbtdm->low_penalty_rate_adaptive = false;\r\nbtdm->rf_rx_lpf_shrink = false;\r\nbtdm->reject_aggre_pkt = false;\r\nbtdm->tdma_on = false;\r\nbtdm->tdma_ant = TDMA_2ANT;\r\nbtdm->tdma_nav = TDMA_NAV_OFF;\r\nbtdm->tdma_dac_swing = TDMA_DAC_SWING_OFF;\r\nbtdm->fw_dac_swing_lvl = 0x20;\r\nbtdm->tra_tdma_on = false;\r\nbtdm->tra_tdma_ant = TDMA_2ANT;\r\nbtdm->tra_tdma_nav = TDMA_NAV_OFF;\r\nbtdm->ignore_wlan_act = false;\r\nbtdm->ps_tdma_on = false;\r\nbtdm->ps_tdma_byte[0] = 0x0;\r\nbtdm->ps_tdma_byte[1] = 0x0;\r\nbtdm->ps_tdma_byte[2] = 0x0;\r\nbtdm->ps_tdma_byte[3] = 0x8;\r\nbtdm->ps_tdma_byte[4] = 0x0;\r\nbtdm->pta_on = true;\r\nbtdm->val_0x6c0 = 0x5a5aaaaa;\r\nbtdm->val_0x6c8 = 0xcc;\r\nbtdm->val_0x6cc = 0x3;\r\nbtdm->sw_dac_swing_on = false;\r\nbtdm->sw_dac_swing_lvl = 0xc0;\r\nbtdm->wlan_act_hi = 0x20;\r\nbtdm->wlan_act_lo = 0x10;\r\nbtdm->bt_retry_index = 2;\r\nbtdm->dec_bt_pwr = false;\r\n}\r\nstatic void dm_bt_btdm_structure_reload_all_off(struct ieee80211_hw *hw,\r\nstruct btdm_8723 *btdm)\r\n{\r\nrtl8723ae_dm_bt_btdm_structure_reload(hw, btdm);\r\nbtdm->all_off = true;\r\nbtdm->pta_on = false;\r\nbtdm->wlan_act_hi = 0x10;\r\n}\r\nstatic bool rtl8723ae_dm_bt_is_2_ant_common_action(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct btdm_8723 btdm8723;\r\nbool common = false;\r\nrtl8723ae_dm_bt_btdm_structure_reload(hw, &btdm8723);\r\nif (!rtl8723ae_dm_bt_is_wifi_busy(hw)\r\n&& !rtlpcipriv->bt_coexist.bt_busy) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi idle + Bt idle, bt coex mechanism always off!!\n");\r\ndm_bt_btdm_structure_reload_all_off(hw, &btdm8723);\r\ncommon = true;\r\n} else if (rtl8723ae_dm_bt_is_wifi_busy(hw)\r\n&& !rtlpcipriv->bt_coexist.bt_busy) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi non-idle + Bt disabled/idle!!\n");\r\nbtdm8723.low_penalty_rate_adaptive = true;\r\nbtdm8723.rf_rx_lpf_shrink = false;\r\nbtdm8723.reject_aggre_pkt = false;\r\nbtdm8723.agc_table_en = false;\r\nbtdm8723.adc_back_off_on = false;\r\nbtdm8723.sw_dac_swing_on = false;\r\nbtdm8723.pta_on = true;\r\nbtdm8723.val_0x6c0 = 0x5a5aaaaa;\r\nbtdm8723.val_0x6c8 = 0xcccc;\r\nbtdm8723.val_0x6cc = 0x3;\r\nbtdm8723.tdma_on = false;\r\nbtdm8723.tdma_dac_swing = TDMA_DAC_SWING_OFF;\r\nbtdm8723.b2_ant_hid_en = false;\r\ncommon = true;\r\n} else if (rtlpcipriv->bt_coexist.bt_busy) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Bt non-idle!\n");\r\nif (mgnt_link_status_query(hw) == RT_MEDIA_CONNECT) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi connection exist\n");\r\ncommon = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"No Wifi connection!\n");\r\nbtdm8723.rf_rx_lpf_shrink = true;\r\nbtdm8723.low_penalty_rate_adaptive = false;\r\nbtdm8723.reject_aggre_pkt = false;\r\nbtdm8723.agc_table_en = false;\r\nbtdm8723.adc_back_off_on = false;\r\nbtdm8723.sw_dac_swing_on = false;\r\nbtdm8723.pta_on = true;\r\nbtdm8723.val_0x6c0 = 0x55555555;\r\nbtdm8723.val_0x6c8 = 0x0000ffff;\r\nbtdm8723.val_0x6cc = 0x3;\r\nbtdm8723.tdma_on = false;\r\nbtdm8723.tdma_dac_swing = TDMA_DAC_SWING_OFF;\r\nbtdm8723.b2_ant_hid_en = false;\r\ncommon = true;\r\n}\r\n}\r\nif (rtl8723ae_dm_bt_need_to_dec_bt_pwr(hw))\r\nbtdm8723.dec_bt_pwr = true;\r\nif (common)\r\nrtlpcipriv->bt_coexist.cstate |= BT_COEX_STATE_BTINFO_COMMON;\r\nif (common && rtl8723ae_dm_bt_is_coexist_state_changed(hw))\r\nrtl8723ae_dm_bt_set_bt_dm(hw, &btdm8723);\r\nreturn common;\r\n}\r\nstatic void rtl8723ae_dm_bt_set_sw_full_time_dac_swing(struct ieee80211_hw *hw,\r\nbool sw_dac_swing_on,\r\nu32 sw_dac_swing_lvl)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nif (sw_dac_swing_on) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], SwDacSwing = 0x%x\n", sw_dac_swing_lvl);\r\nrtl8723_phy_set_bb_reg(hw, 0x880, 0xff000000,\r\nsw_dac_swing_lvl);\r\nrtlpcipriv->bt_coexist.sw_coexist_all_off = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], SwDacSwing Off!\n");\r\nrtl8723_phy_set_bb_reg(hw, 0x880, 0xff000000, 0xc0);\r\n}\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_dec_bt_pwr(struct ieee80211_hw *hw,\r\nbool dec_bt_pwr)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nh2c_parameter[0] = 0;\r\nif (dec_bt_pwr) {\r\nh2c_parameter[0] |= BIT(1);\r\nrtlpcipriv->bt_coexist.fw_coexist_all_off = false;\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], decrease Bt Power : %s, write 0x21 = 0x%x\n",\r\n(dec_bt_pwr ? "Yes!!" : "No!!"), h2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x21, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_2_ant_hid(struct ieee80211_hw *hw,\r\nbool enable, bool dac_swing_on)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nif (enable) {\r\nh2c_parameter[0] |= BIT(0);\r\nrtlpcipriv->bt_coexist.fw_coexist_all_off = false;\r\n}\r\nif (dac_swing_on)\r\nh2c_parameter[0] |= BIT(1);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], turn 2-Ant+HID mode %s, DACSwing:%s, write 0x15 = 0x%x\n",\r\n(enable ? "ON!!" : "OFF!!"), (dac_swing_on ? "ON" : "OFF"),\r\nh2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x15, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_tdma_ctrl(struct ieee80211_hw *hw,\r\nbool enable, u8 ant_num, u8 nav_en,\r\nu8 dac_swing_en)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nu8 h2c_parameter1[1] = {0};\r\nh2c_parameter[0] = 0;\r\nh2c_parameter1[0] = 0;\r\nif (enable) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], set BT PTA update manager to trigger update!!\n");\r\nh2c_parameter1[0] |= BIT(0);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], turn TDMA mode ON!!\n");\r\nh2c_parameter[0] |= BIT(0);\r\nif (TDMA_1ANT == ant_num) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TDMA_1ANT\n");\r\nh2c_parameter[0] |= BIT(1);\r\n} else if (TDMA_2ANT == ant_num) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TDMA_2ANT\n");\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], Unknown Ant\n");\r\n}\r\nif (TDMA_NAV_OFF == nav_en) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TDMA_NAV_OFF\n");\r\n} else if (TDMA_NAV_ON == nav_en) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TDMA_NAV_ON\n");\r\nh2c_parameter[0] |= BIT(2);\r\n}\r\nif (TDMA_DAC_SWING_OFF == dac_swing_en) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TDMA_DAC_SWING_OFF\n");\r\n} else if (TDMA_DAC_SWING_ON == dac_swing_en) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TDMA_DAC_SWING_ON\n");\r\nh2c_parameter[0] |= BIT(4);\r\n}\r\nrtlpcipriv->bt_coexist.fw_coexist_all_off = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], set BT PTA update manager to no update!!\n");\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], turn TDMA mode OFF!!\n");\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], FW2AntTDMA, write 0x26 = 0x%x\n",\r\nh2c_parameter1[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x26, 1, h2c_parameter1);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], FW2AntTDMA, write 0x14 = 0x%x\n", h2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x14, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_ignore_wlan_act(struct ieee80211_hw *hw,\r\nbool enable)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nif (enable) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], BT Ignore Wlan_Act !!\n");\r\nh2c_parameter[0] |= BIT(0);\r\nrtlpcipriv->bt_coexist.fw_coexist_all_off = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], BT don't ignore Wlan_Act !!\n");\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], set FW for BT Ignore Wlan_Act, write 0x25 = 0x%x\n",\r\nh2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x25, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_tra_tdma_ctrl(struct ieee80211_hw *hw,\r\nbool enable, u8 ant_num,\r\nu8 nav_en)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nu8 h2c_parameter[2] = {0};\r\nif (IS_VENDOR_8723_A_CUT(rtlhal->version)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], not 8723B cut, don't set Traditional TDMA!!\n");\r\nreturn;\r\n}\r\nif (enable) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], turn TTDMA mode ON!!\n");\r\nh2c_parameter[0] |= BIT(0);\r\nif (TDMA_1ANT == ant_num) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TTDMA_1ANT\n");\r\nh2c_parameter[0] |= BIT(1);\r\n} else if (TDMA_2ANT == ant_num) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TTDMA_2ANT\n");\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], Unknown Ant\n");\r\n}\r\nif (TDMA_NAV_OFF == nav_en) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TTDMA_NAV_OFF\n");\r\n} else if (TDMA_NAV_ON == nav_en) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], TTDMA_NAV_ON\n");\r\nh2c_parameter[1] |= BIT(0);\r\n}\r\nrtlpcipriv->bt_coexist.fw_coexist_all_off = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], turn TTDMA mode OFF!!\n");\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], FW Traditional TDMA, write 0x33 = 0x%x\n",\r\nh2c_parameter[0] << 8 | h2c_parameter[1]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x33, 2, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_dac_swing_level(struct ieee80211_hw *hw,\r\nu8 dac_swing_lvl)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nh2c_parameter[0] = dac_swing_lvl;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], Set Dac Swing Level = 0x%x\n", dac_swing_lvl);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], write 0x29 = 0x%x\n", h2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x29, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_bt_hid_info(struct ieee80211_hw *hw,\r\nbool enable)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nh2c_parameter[0] = 0;\r\nif (enable) {\r\nh2c_parameter[0] |= BIT(0);\r\nrtlpcipriv->bt_coexist.fw_coexist_all_off = false;\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], Set BT HID information = 0x%x\n", enable);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], write 0x24 = 0x%x\n", h2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x24, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_bt_retry_index(struct ieee80211_hw *hw,\r\nu8 retry_index)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter[1] = {0};\r\nh2c_parameter[0] = retry_index;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], Set BT Retry Index=%d\n", retry_index);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], write 0x23 = 0x%x\n", h2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x23, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_set_fw_wlan_act(struct ieee80211_hw *hw,\r\nu8 wlan_act_hi, u8 wlan_act_lo)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nu8 h2c_parameter_hi[1] = {0};\r\nu8 h2c_parameter_lo[1] = {0};\r\nh2c_parameter_hi[0] = wlan_act_hi;\r\nh2c_parameter_lo[0] = wlan_act_lo;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], Set WLAN_ACT Hi:Lo = 0x%x/0x%x\n", wlan_act_hi,\r\nwlan_act_lo);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], write 0x22 = 0x%x\n", h2c_parameter_hi[0]);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], write 0x11 = 0x%x\n", h2c_parameter_lo[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x22, 1, h2c_parameter_hi);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x11, 1, h2c_parameter_lo);\r\n}\r\nvoid rtl8723ae_dm_bt_set_bt_dm(struct ieee80211_hw *hw, struct btdm_8723 *btdm)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct btdm_8723 *btdm_8723 = &rtlhal->hal_coex_8723.btdm;\r\nu8 i;\r\nbool fw_current_inpsmode = false;\r\nbool fw_ps_awake = true;\r\nrtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FW_PSMODE_STATUS,\r\n(u8 *)(&fw_current_inpsmode));\r\nrtlpriv->cfg->ops->get_hw_reg(hw, HW_VAR_FWLPS_RF_ON,\r\n(u8 *)(&fw_ps_awake));\r\nif (memcmp(btdm_8723, btdm, sizeof(struct btdm_8723)) == 0) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], the same coexist setting, return!!\n");\r\nreturn;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], UPDATE TO NEW COEX SETTING!!\n");\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bAllOff = 0x%x/ 0x%x\n",\r\nbtdm_8723->all_off, btdm->all_off);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new agc_table_en = 0x%x/ 0x%x\n",\r\nbtdm_8723->agc_table_en, btdm->agc_table_en);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new adc_back_off_on = 0x%x/ 0x%x\n",\r\nbtdm_8723->adc_back_off_on, btdm->adc_back_off_on);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new b2_ant_hid_en = 0x%x/ 0x%x\n",\r\nbtdm_8723->b2_ant_hid_en, btdm->b2_ant_hid_en);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bLowPenaltyRateAdaptive = 0x%x/ 0x%x\n",\r\nbtdm_8723->low_penalty_rate_adaptive,\r\nbtdm->low_penalty_rate_adaptive);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bRfRxLpfShrink = 0x%x/ 0x%x\n",\r\nbtdm_8723->rf_rx_lpf_shrink, btdm->rf_rx_lpf_shrink);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bRejectAggrePkt = 0x%x/ 0x%x\n",\r\nbtdm_8723->reject_aggre_pkt, btdm->reject_aggre_pkt);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new tdma_on = 0x%x/ 0x%x\n",\r\nbtdm_8723->tdma_on, btdm->tdma_on);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new tdmaAnt = 0x%x/ 0x%x\n",\r\nbtdm_8723->tdma_ant, btdm->tdma_ant);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new tdmaNav = 0x%x/ 0x%x\n",\r\nbtdm_8723->tdma_nav, btdm->tdma_nav);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new tdma_dac_swing = 0x%x/ 0x%x\n",\r\nbtdm_8723->tdma_dac_swing, btdm->tdma_dac_swing);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new fwDacSwingLvl = 0x%x/ 0x%x\n",\r\nbtdm_8723->fw_dac_swing_lvl, btdm->fw_dac_swing_lvl);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bTraTdmaOn = 0x%x/ 0x%x\n",\r\nbtdm_8723->tra_tdma_on, btdm->tra_tdma_on);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new traTdmaAnt = 0x%x/ 0x%x\n",\r\nbtdm_8723->tra_tdma_ant, btdm->tra_tdma_ant);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new traTdmaNav = 0x%x/ 0x%x\n",\r\nbtdm_8723->tra_tdma_nav, btdm->tra_tdma_nav);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bPsTdmaOn = 0x%x/ 0x%x\n",\r\nbtdm_8723->ps_tdma_on, btdm->ps_tdma_on);\r\nfor (i = 0; i < 5; i++) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new psTdmaByte[i] = 0x%x/ 0x%x\n",\r\nbtdm_8723->ps_tdma_byte[i],\r\nbtdm->ps_tdma_byte[i]);\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bIgnoreWlanAct = 0x%x/ 0x%x\n",\r\nbtdm_8723->ignore_wlan_act, btdm->ignore_wlan_act);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new bPtaOn = 0x%x/ 0x%x\n",\r\nbtdm_8723->pta_on, btdm->pta_on);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new val_0x6c0 = 0x%x/ 0x%x\n",\r\nbtdm_8723->val_0x6c0, btdm->val_0x6c0);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new val_0x6c8 = 0x%x/ 0x%x\n",\r\nbtdm_8723->val_0x6c8, btdm->val_0x6c8);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new val_0x6cc = 0x%x/ 0x%x\n",\r\nbtdm_8723->val_0x6cc, btdm->val_0x6cc);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new sw_dac_swing_on = 0x%x/ 0x%x\n",\r\nbtdm_8723->sw_dac_swing_on, btdm->sw_dac_swing_on);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new sw_dac_swing_lvl = 0x%x/ 0x%x\n",\r\nbtdm_8723->sw_dac_swing_lvl,\r\nbtdm->sw_dac_swing_lvl);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new wlanActHi = 0x%x/ 0x%x\n",\r\nbtdm_8723->wlan_act_hi, btdm->wlan_act_hi);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new wlanActLo = 0x%x/ 0x%x\n",\r\nbtdm_8723->wlan_act_lo, btdm->wlan_act_lo);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], original/new btRetryIndex = 0x%x/ 0x%x\n",\r\nbtdm_8723->bt_retry_index, btdm->bt_retry_index);\r\nmemcpy(btdm_8723, btdm, sizeof(struct btdm_8723));\r\n}\r\nif (rtlpcipriv->bt_coexist.hold_for_bt_operation) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], set to ignore wlanAct for BT OP!!\n");\r\nrtl8723ae_dm_bt_set_fw_ignore_wlan_act(hw, true);\r\nreturn;\r\n}\r\nif (btdm->all_off) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], disable all coexist mechanism !!\n");\r\nrtl8723ae_btdm_coex_all_off(hw);\r\nreturn;\r\n}\r\nrtl8723ae_dm_bt_reject_ap_aggregated_packet(hw, btdm->reject_aggre_pkt);\r\nif (btdm->low_penalty_rate_adaptive)\r\nrtl8723ae_bt_set_penalty_tx_rate_adap(hw,\r\nBT_TX_RATE_ADAPTIVE_LOW_PENALTY);\r\nelse\r\nrtl8723ae_bt_set_penalty_tx_rate_adap(hw,\r\nBT_TX_RATE_ADAPTIVE_NORMAL);\r\nif (btdm->rf_rx_lpf_shrink)\r\nrtl8723ae_dm_bt_set_sw_rf_rx_lpf_corner(hw,\r\nBT_RF_RX_LPF_CORNER_SHRINK);\r\nelse\r\nrtl8723ae_dm_bt_set_sw_rf_rx_lpf_corner(hw,\r\nBT_RF_RX_LPF_CORNER_RESUME);\r\nif (btdm->agc_table_en)\r\nrtl8723ae_dm_bt_agc_table(hw, BT_AGCTABLE_ON);\r\nelse\r\nrtl8723ae_dm_bt_agc_table(hw, BT_AGCTABLE_OFF);\r\nif (btdm->adc_back_off_on)\r\nrtl8723ae_dm_bt_bback_off_level(hw, BT_BB_BACKOFF_ON);\r\nelse\r\nrtl8723ae_dm_bt_bback_off_level(hw, BT_BB_BACKOFF_OFF);\r\nrtl8723ae_dm_bt_set_fw_bt_retry_index(hw, btdm->bt_retry_index);\r\nrtl8723ae_dm_bt_set_fw_dac_swing_level(hw, btdm->fw_dac_swing_lvl);\r\nrtl8723ae_dm_bt_set_fw_wlan_act(hw, btdm->wlan_act_hi,\r\nbtdm->wlan_act_lo);\r\nrtl8723ae_dm_bt_set_coex_table(hw, btdm->val_0x6c0,\r\nbtdm->val_0x6c8, btdm->val_0x6cc);\r\nrtl8723ae_dm_bt_set_hw_pta_mode(hw, btdm->pta_on);\r\nif (btdm->b2_ant_hid_en) {\r\nrtl8723ae_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\r\nbtdm->tra_tdma_ant,\r\nbtdm->tra_tdma_nav);\r\nrtl8723ae_dm_bt_set_fw_tdma_ctrl(hw, false, btdm->tdma_ant,\r\nbtdm->tdma_nav,\r\nbtdm->tdma_dac_swing);\r\nrtl8723ae_dm_bt_set_fw_ignore_wlan_act(hw,\r\nbtdm->ignore_wlan_act);\r\nrtl8723ae_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\r\nrtl8723ae_dm_bt_set_fw_bt_hid_info(hw, true);\r\nrtl8723ae_dm_bt_set_fw_2_ant_hid(hw, true, true);\r\n} else if (btdm->tdma_on) {\r\nrtl8723ae_dm_bt_set_fw_bt_hid_info(hw, false);\r\nrtl8723ae_dm_bt_set_fw_2_ant_hid(hw, false, false);\r\nrtl8723ae_dm_bt_set_fw_ignore_wlan_act(hw,\r\nbtdm->ignore_wlan_act);\r\nrtl8723ae_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\r\nrtl8723ae_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\r\nbtdm->tra_tdma_ant, btdm->tra_tdma_nav);\r\nrtl8723ae_dm_bt_set_fw_tdma_ctrl(hw, true, btdm->tdma_ant,\r\nbtdm->tdma_nav, btdm->tdma_dac_swing);\r\n} else if (btdm->ps_tdma_on) {\r\nrtl8723ae_dm_bt_set_fw_bt_hid_info(hw, false);\r\nrtl8723ae_dm_bt_set_fw_2_ant_hid(hw, false, false);\r\nrtl8723ae_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\r\nbtdm->tra_tdma_ant, btdm->tra_tdma_nav);\r\nrtl8723ae_dm_bt_set_fw_tdma_ctrl(hw, false, btdm->tdma_ant,\r\nbtdm->tdma_nav, btdm->tdma_dac_swing);\r\nrtl8723ae_dm_bt_set_fw_ignore_wlan_act(hw,\r\nbtdm->ignore_wlan_act);\r\nrtl8723ae_dm_bt_set_fw_3a(hw,\r\nbtdm->ps_tdma_byte[0],\r\nbtdm->ps_tdma_byte[1],\r\nbtdm->ps_tdma_byte[2],\r\nbtdm->ps_tdma_byte[3],\r\nbtdm->ps_tdma_byte[4]);\r\n} else {\r\nrtl8723ae_dm_bt_set_fw_bt_hid_info(hw, false);\r\nrtl8723ae_dm_bt_set_fw_2_ant_hid(hw, false, false);\r\nrtl8723ae_dm_bt_set_fw_tra_tdma_ctrl(hw, btdm->tra_tdma_on,\r\nbtdm->tra_tdma_ant, btdm->tra_tdma_nav);\r\nrtl8723ae_dm_bt_set_fw_tdma_ctrl(hw, false, btdm->tdma_ant,\r\nbtdm->tdma_nav, btdm->tdma_dac_swing);\r\nrtl8723ae_dm_bt_set_fw_ignore_wlan_act(hw,\r\nbtdm->ignore_wlan_act);\r\nrtl8723ae_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\r\n}\r\nmdelay(30);\r\nrtl8723ae_dm_bt_set_sw_full_time_dac_swing(hw,\r\nbtdm->sw_dac_swing_on, btdm->sw_dac_swing_lvl);\r\nrtl8723ae_dm_bt_set_fw_dec_bt_pwr(hw, btdm->dec_bt_pwr);\r\n}\r\nstatic u32 rtl8723ae_dm_bt_tx_rx_couter_h(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nu32 counters = 0;\r\ncounters = rtlhal->hal_coex_8723.high_priority_tx +\r\nrtlhal->hal_coex_8723.high_priority_rx;\r\nreturn counters;\r\n}\r\nstatic u32 rtl8723ae_dm_bt_tx_rx_couter_l(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_hal *rtlhal = rtl_hal(rtl_priv(hw));\r\nreturn rtlhal->hal_coex_8723.low_priority_tx +\r\nrtlhal->hal_coex_8723.low_priority_rx;\r\n}\r\nstatic u8 rtl8723ae_dm_bt_bt_tx_rx_counter_level(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu32 bt_tx_rx_cnt = 0;\r\nu8 bt_tx_rx_cnt_lvl = 0;\r\nbt_tx_rx_cnt = rtl8723ae_dm_bt_tx_rx_couter_h(hw) +\r\nrtl8723ae_dm_bt_tx_rx_couter_l(hw);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters = %d\n", bt_tx_rx_cnt);\r\nrtlpcipriv->bt_coexist.cstate_h &=\r\n~(BT_COEX_STATE_BT_CNT_LEVEL_0 | BT_COEX_STATE_BT_CNT_LEVEL_1 |\r\nBT_COEX_STATE_BT_CNT_LEVEL_2);\r\nif (bt_tx_rx_cnt >= BT_TXRX_CNT_THRES_3) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters at level 3\n");\r\nbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_3;\r\nrtlpcipriv->bt_coexist.cstate_h |= BT_COEX_STATE_BT_CNT_LEVEL_3;\r\n} else if (bt_tx_rx_cnt >= BT_TXRX_CNT_THRES_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters at level 2\n");\r\nbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_2;\r\nrtlpcipriv->bt_coexist.cstate_h |= BT_COEX_STATE_BT_CNT_LEVEL_2;\r\n} else if (bt_tx_rx_cnt >= BT_TXRX_CNT_THRES_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters at level 1\n");\r\nbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_1;\r\nrtlpcipriv->bt_coexist.cstate_h |= BT_COEX_STATE_BT_CNT_LEVEL_1;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters at level 0\n");\r\nbt_tx_rx_cnt_lvl = BT_TXRX_CNT_LEVEL_0;\r\nrtlpcipriv->bt_coexist.cstate_h |= BT_COEX_STATE_BT_CNT_LEVEL_0;\r\n}\r\nreturn bt_tx_rx_cnt_lvl;\r\n}\r\nstatic void rtl8723ae_dm_bt_2_ant_hid_sco_esco(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct btdm_8723 btdm8723;\r\nu8 bt_rssi_state, bt_rssi_state1;\r\nu8 bt_tx_rx_cnt_lvl;\r\nrtl8723ae_dm_bt_btdm_structure_reload(hw, &btdm8723);\r\nbtdm8723.rf_rx_lpf_shrink = true;\r\nbtdm8723.low_penalty_rate_adaptive = true;\r\nbtdm8723.reject_aggre_pkt = false;\r\nbt_tx_rx_cnt_lvl = rtl8723ae_dm_bt_bt_tx_rx_counter_level(hw);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters = %d\n", bt_tx_rx_cnt_lvl);\r\nif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG, "HT40\n");\r\nbtdm8723.val_0x6c0 = 0x55555555;\r\nbtdm8723.val_0x6c8 = 0xffff;\r\nbtdm8723.val_0x6cc = 0x3;\r\nbtdm8723.agc_table_en = false;\r\nbtdm8723.adc_back_off_on = false;\r\nbtdm8723.sw_dac_swing_on = false;\r\nbtdm8723.ps_tdma_on = true;\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"HT20 or Legacy\n");\r\nbt_rssi_state = rtl8723ae_dm_bt_check_coex_rssi_state(hw, 2,\r\n47, 0);\r\nbt_rssi_state1 = rtl8723ae_dm_bt_check_coex_rssi_state1(hw, 2,\r\n27, 0);\r\nbtdm8723.val_0x6c0 = 0x55555555;\r\nbtdm8723.val_0x6c8 = 0xffff;\r\nbtdm8723.val_0x6cc = 0x3;\r\nif ((bt_rssi_state == BT_RSSI_STATE_HIGH) ||\r\n(bt_rssi_state == BT_RSSI_STATE_STAY_HIGH)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi high\n");\r\nbtdm8723.agc_table_en = true;\r\nbtdm8723.adc_back_off_on = true;\r\nbtdm8723.sw_dac_swing_on = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi low\n");\r\nbtdm8723.agc_table_en = false;\r\nbtdm8723.adc_back_off_on = false;\r\nbtdm8723.sw_dac_swing_on = false;\r\n}\r\nbtdm8723.ps_tdma_on = true;\r\nif ((bt_rssi_state1 == BT_RSSI_STATE_HIGH) ||\r\n(bt_rssi_state1 == BT_RSSI_STATE_STAY_HIGH)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi-1 high\n");\r\nrtl_write_byte(rtlpriv, 0x883, 0x40);\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x83;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x83;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x83;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi-1 low\n");\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n}\r\n}\r\nif (rtl8723ae_dm_bt_need_to_dec_bt_pwr(hw))\r\nbtdm8723.dec_bt_pwr = true;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT btInqPageStartTime = 0x%x, btTxRxCntLvl = %d\n",\r\nrtlhal->hal_coex_8723.bt_inq_page_start_time,\r\nbt_tx_rx_cnt_lvl);\r\nif ((rtlhal->hal_coex_8723.bt_inq_page_start_time) ||\r\n(BT_TXRX_CNT_LEVEL_3 == bt_tx_rx_cnt_lvl)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], Set BT inquiry / page scan 0x3a setting\n");\r\nbtdm8723.ps_tdma_on = true;\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x2;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\nif (rtl8723ae_dm_bt_is_coexist_state_changed(hw))\r\nrtl8723ae_dm_bt_set_bt_dm(hw, &btdm8723);\r\n}\r\nstatic void rtl8723ae_dm_bt_2_ant_fta2dp(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_phy *rtlphy = &(rtlpriv->phy);\r\nstruct btdm_8723 btdm8723;\r\nu8 bt_rssi_state, bt_rssi_state1;\r\nu32 bt_tx_rx_cnt_lvl;\r\nrtl8723ae_dm_bt_btdm_structure_reload(hw, &btdm8723);\r\nbtdm8723.rf_rx_lpf_shrink = true;\r\nbtdm8723.low_penalty_rate_adaptive = true;\r\nbtdm8723.reject_aggre_pkt = false;\r\nbt_tx_rx_cnt_lvl = rtl8723ae_dm_bt_bt_tx_rx_counter_level(hw);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters = %d\n", bt_tx_rx_cnt_lvl);\r\nif (rtlphy->current_chan_bw == HT_CHANNEL_WIDTH_20_40) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG, "HT40\n");\r\nbt_rssi_state = rtl8723ae_dm_bt_check_coex_rssi_state(hw, 2,\r\n37, 0);\r\nbtdm8723.val_0x6c0 = 0x55555555;\r\nbtdm8723.val_0x6c8 = 0xffff;\r\nbtdm8723.val_0x6cc = 0x3;\r\nbtdm8723.agc_table_en = false;\r\nbtdm8723.adc_back_off_on = true;\r\nbtdm8723.sw_dac_swing_on = false;\r\nbtdm8723.ps_tdma_on = true;\r\nif ((bt_rssi_state == BT_RSSI_STATE_HIGH) ||\r\n(bt_rssi_state == BT_RSSI_STATE_STAY_HIGH)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi high\n");\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x81;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x81;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x81;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi low\n");\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x0;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x0;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x0;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n}\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"HT20 or Legacy\n");\r\nbt_rssi_state = rtl8723ae_dm_bt_check_coex_rssi_state(hw, 2,\r\n47, 0);\r\nbt_rssi_state1 = rtl8723ae_dm_bt_check_coex_rssi_state1(hw, 2,\r\n27, 0);\r\nbtdm8723.val_0x6c0 = 0x55555555;\r\nbtdm8723.val_0x6c8 = 0xffff;\r\nbtdm8723.val_0x6cc = 0x3;\r\nif ((bt_rssi_state == BT_RSSI_STATE_HIGH) ||\r\n(bt_rssi_state == BT_RSSI_STATE_STAY_HIGH)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi high\n");\r\nbtdm8723.agc_table_en = true;\r\nbtdm8723.adc_back_off_on = true;\r\nbtdm8723.sw_dac_swing_on = false;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi low\n");\r\nbtdm8723.agc_table_en = false;\r\nbtdm8723.adc_back_off_on = false;\r\nbtdm8723.sw_dac_swing_on = false;\r\n}\r\nbtdm8723.ps_tdma_on = true;\r\nif ((bt_rssi_state1 == BT_RSSI_STATE_HIGH) ||\r\n(bt_rssi_state1 == BT_RSSI_STATE_STAY_HIGH)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi-1 high\n");\r\nrtl_write_byte(rtlpriv, 0x883, 0x40);\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x81;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x81;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x81;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Wifi rssi-1 low\n");\r\nif (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x0;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else if (bt_tx_rx_cnt_lvl == BT_TXRX_CNT_LEVEL_1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters >= 1200 && < 1400\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xa;\r\nbtdm8723.ps_tdma_byte[2] = 0xa;\r\nbtdm8723.ps_tdma_byte[3] = 0x0;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT TxRx Counters < 1200\n");\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0xf;\r\nbtdm8723.ps_tdma_byte[2] = 0xf;\r\nbtdm8723.ps_tdma_byte[3] = 0x0;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\n}\r\n}\r\nif (rtl8723ae_dm_bt_need_to_dec_bt_pwr(hw))\r\nbtdm8723.dec_bt_pwr = true;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT btInqPageStartTime = 0x%x, btTxRxCntLvl = %d\n",\r\nrtlhal->hal_coex_8723.bt_inq_page_start_time,\r\nbt_tx_rx_cnt_lvl);\r\nif ((rtlhal->hal_coex_8723.bt_inq_page_start_time) ||\r\n(BT_TXRX_CNT_LEVEL_3 == bt_tx_rx_cnt_lvl)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], Set BT inquiry / page scan 0x3a setting\n");\r\nbtdm8723.ps_tdma_on = true;\r\nbtdm8723.ps_tdma_byte[0] = 0xa3;\r\nbtdm8723.ps_tdma_byte[1] = 0x5;\r\nbtdm8723.ps_tdma_byte[2] = 0x5;\r\nbtdm8723.ps_tdma_byte[3] = 0x83;\r\nbtdm8723.ps_tdma_byte[4] = 0x80;\r\n}\r\nif (rtl8723ae_dm_bt_is_coexist_state_changed(hw))\r\nrtl8723ae_dm_bt_set_bt_dm(hw, &btdm8723);\r\n}\r\nstatic void rtl8723ae_dm_bt_inq_page_monitor(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nu32 cur_time = jiffies;\r\nif (rtlhal->hal_coex_8723.c2h_bt_inquiry_page) {\r\nif (rtlhal->hal_coex_8723.bt_inq_page_start_time == 0) {\r\nrtlpcipriv->bt_coexist.cstate |=\r\nBT_COEX_STATE_BT_INQ_PAGE;\r\nrtlhal->hal_coex_8723.bt_inq_page_start_time = cur_time;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT Inquiry/page is started at time : 0x%x\n",\r\nrtlhal->hal_coex_8723.bt_inq_page_start_time);\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT Inquiry/page started time : 0x%x, cur_time : 0x%x\n",\r\nrtlhal->hal_coex_8723.bt_inq_page_start_time, cur_time);\r\nif (rtlhal->hal_coex_8723.bt_inq_page_start_time) {\r\nif ((((long)cur_time -\r\n(long)rtlhal->hal_coex_8723.bt_inq_page_start_time) / HZ) >=\r\n10) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BT Inquiry/page >= 10sec!!!");\r\nrtlhal->hal_coex_8723.bt_inq_page_start_time = 0;\r\nrtlpcipriv->bt_coexist.cstate &=\r\n~BT_COEX_STATE_BT_INQ_PAGE;\r\n}\r\n}\r\n}\r\nstatic void rtl8723ae_dm_bt_reset_action_profile_state(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nrtlpcipriv->bt_coexist.cstate &=\r\n~(BT_COEX_STATE_PROFILE_HID | BT_COEX_STATE_PROFILE_A2DP |\r\nBT_COEX_STATE_PROFILE_PAN | BT_COEX_STATE_PROFILE_SCO);\r\nrtlpcipriv->bt_coexist.cstate &=\r\n~(BT_COEX_STATE_BTINFO_COMMON |\r\nBT_COEX_STATE_BTINFO_B_HID_SCOESCO |\r\nBT_COEX_STATE_BTINFO_B_FTP_A2DP);\r\n}\r\nstatic void _rtl8723ae_dm_bt_coexist_2_ant(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu8 bt_info_original;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex] Get bt info by fw!!\n");\r\n_rtl8723_dm_bt_check_wifi_state(hw);\r\nif (rtlhal->hal_coex_8723.c2h_bt_info_req_sent) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex] c2h for btInfo not rcvd yet!!\n");\r\n}\r\nbt_info_original = rtlhal->hal_coex_8723.c2h_bt_info_original;\r\nrtl8723ae_dm_bt_inq_page_monitor(hw);\r\nrtl8723ae_dm_bt_reset_action_profile_state(hw);\r\nif (rtl8723ae_dm_bt_is_2_ant_common_action(hw)) {\r\nrtlpcipriv->bt_coexist.bt_profile_case = BT_COEX_MECH_COMMON;\r\nrtlpcipriv->bt_coexist.bt_profile_action = BT_COEX_MECH_COMMON;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Action 2-Ant common.\n");\r\n} else {\r\nif ((bt_info_original & BTINFO_B_HID) ||\r\n(bt_info_original & BTINFO_B_SCO_BUSY) ||\r\n(bt_info_original & BTINFO_B_SCO_ESCO)) {\r\nrtlpcipriv->bt_coexist.cstate |=\r\nBT_COEX_STATE_BTINFO_B_HID_SCOESCO;\r\nrtlpcipriv->bt_coexist.bt_profile_case =\r\nBT_COEX_MECH_HID_SCO_ESCO;\r\nrtlpcipriv->bt_coexist.bt_profile_action =\r\nBT_COEX_MECH_HID_SCO_ESCO;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BTInfo: bHid|bSCOBusy|bSCOeSCO\n");\r\nrtl8723ae_dm_bt_2_ant_hid_sco_esco(hw);\r\n} else if ((bt_info_original & BTINFO_B_FTP) ||\r\n(bt_info_original & BTINFO_B_A2DP)) {\r\nrtlpcipriv->bt_coexist.cstate |=\r\nBT_COEX_STATE_BTINFO_B_FTP_A2DP;\r\nrtlpcipriv->bt_coexist.bt_profile_case =\r\nBT_COEX_MECH_FTP_A2DP;\r\nrtlpcipriv->bt_coexist.bt_profile_action =\r\nBT_COEX_MECH_FTP_A2DP;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"BTInfo: bFTP|bA2DP\n");\r\nrtl8723ae_dm_bt_2_ant_fta2dp(hw);\r\n} else {\r\nrtlpcipriv->bt_coexist.cstate |=\r\nBT_COEX_STATE_BTINFO_B_HID_SCOESCO;\r\nrtlpcipriv->bt_coexist.bt_profile_case =\r\nBT_COEX_MECH_NONE;\r\nrtlpcipriv->bt_coexist.bt_profile_action =\r\nBT_COEX_MECH_NONE;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], BTInfo: undefined case!!!!\n");\r\nrtl8723ae_dm_bt_2_ant_hid_sco_esco(hw);\r\n}\r\n}\r\n}\r\nstatic void _rtl8723ae_dm_bt_coexist_1_ant(struct ieee80211_hw *hw)\r\n{\r\n}\r\nvoid rtl8723ae_dm_bt_hw_coex_all_off_8723a(struct ieee80211_hw *hw)\r\n{\r\nrtl8723ae_dm_bt_set_coex_table(hw, 0x5a5aaaaa, 0xcc, 0x3);\r\nrtl8723ae_dm_bt_set_hw_pta_mode(hw, true);\r\n}\r\nvoid rtl8723ae_dm_bt_fw_coex_all_off_8723a(struct ieee80211_hw *hw)\r\n{\r\nrtl8723ae_dm_bt_set_fw_ignore_wlan_act(hw, false);\r\nrtl8723ae_dm_bt_set_fw_3a(hw, 0x0, 0x0, 0x0, 0x8, 0x0);\r\nrtl8723ae_dm_bt_set_fw_2_ant_hid(hw, false, false);\r\nrtl8723ae_dm_bt_set_fw_tra_tdma_ctrl(hw, false,\r\nTDMA_2ANT, TDMA_NAV_OFF);\r\nrtl8723ae_dm_bt_set_fw_tdma_ctrl(hw, false, TDMA_2ANT,\r\nTDMA_NAV_OFF, TDMA_DAC_SWING_OFF);\r\nrtl8723ae_dm_bt_set_fw_dac_swing_level(hw, 0);\r\nrtl8723ae_dm_bt_set_fw_bt_hid_info(hw, false);\r\nrtl8723ae_dm_bt_set_fw_bt_retry_index(hw, 2);\r\nrtl8723ae_dm_bt_set_fw_wlan_act(hw, 0x10, 0x10);\r\nrtl8723ae_dm_bt_set_fw_dec_bt_pwr(hw, false);\r\n}\r\nvoid rtl8723ae_dm_bt_sw_coex_all_off_8723a(struct ieee80211_hw *hw)\r\n{\r\nrtl8723ae_dm_bt_agc_table(hw, BT_AGCTABLE_OFF);\r\nrtl8723ae_dm_bt_bback_off_level(hw, BT_BB_BACKOFF_OFF);\r\nrtl8723ae_dm_bt_reject_ap_aggregated_packet(hw, false);\r\nrtl8723ae_bt_set_penalty_tx_rate_adap(hw, BT_TX_RATE_ADAPTIVE_NORMAL);\r\nrtl8723ae_dm_bt_set_sw_rf_rx_lpf_corner(hw, BT_RF_RX_LPF_CORNER_RESUME);\r\nrtl8723ae_dm_bt_set_sw_full_time_dac_swing(hw, false, 0xc0);\r\n}\r\nstatic void rtl8723ae_dm_bt_query_bt_information(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nu8 h2c_parameter[1] = {0};\r\nrtlhal->hal_coex_8723.c2h_bt_info_req_sent = true;\r\nh2c_parameter[0] |= BIT(0);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"Query Bt information, write 0x38 = 0x%x\n",\r\nh2c_parameter[0]);\r\nrtl8723ae_fill_h2c_cmd(hw, 0x38, 1, h2c_parameter);\r\n}\r\nstatic void rtl8723ae_dm_bt_bt_hw_counters_monitor(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu32 reg_htx_rx, reg_ltx_rx, u32_tmp;\r\nu32 reg_htx, reg_hrx, reg_ltx, reg_lrx;\r\nreg_htx_rx = REG_HIGH_PRIORITY_TXRX;\r\nreg_ltx_rx = REG_LOW_PRIORITY_TXRX;\r\nu32_tmp = rtl_read_dword(rtlpriv, reg_htx_rx);\r\nreg_htx = u32_tmp & MASKLWORD;\r\nreg_hrx = (u32_tmp & MASKHWORD)>>16;\r\nu32_tmp = rtl_read_dword(rtlpriv, reg_ltx_rx);\r\nreg_ltx = u32_tmp & MASKLWORD;\r\nreg_lrx = (u32_tmp & MASKHWORD)>>16;\r\nif (rtlpcipriv->bt_coexist.lps_counter > 1) {\r\nreg_htx %= rtlpcipriv->bt_coexist.lps_counter;\r\nreg_hrx %= rtlpcipriv->bt_coexist.lps_counter;\r\nreg_ltx %= rtlpcipriv->bt_coexist.lps_counter;\r\nreg_lrx %= rtlpcipriv->bt_coexist.lps_counter;\r\n}\r\nrtlhal->hal_coex_8723.high_priority_tx = reg_htx;\r\nrtlhal->hal_coex_8723.high_priority_rx = reg_hrx;\r\nrtlhal->hal_coex_8723.low_priority_tx = reg_ltx;\r\nrtlhal->hal_coex_8723.low_priority_rx = reg_lrx;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"High Priority Tx/Rx (reg 0x%x)=%x(%d)/%x(%d)\n",\r\nreg_htx_rx, reg_htx, reg_htx, reg_hrx, reg_hrx);\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"Low Priority Tx/Rx (reg 0x%x)=%x(%d)/%x(%d)\n",\r\nreg_ltx_rx, reg_ltx, reg_ltx, reg_lrx, reg_lrx);\r\nrtlpcipriv->bt_coexist.lps_counter = 0;\r\n}\r\nstatic void rtl8723ae_dm_bt_bt_enable_disable_check(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nbool bt_alife = true;\r\nif (rtlhal->hal_coex_8723.high_priority_tx == 0 &&\r\nrtlhal->hal_coex_8723.high_priority_rx == 0 &&\r\nrtlhal->hal_coex_8723.low_priority_tx == 0 &&\r\nrtlhal->hal_coex_8723.low_priority_rx == 0)\r\nbt_alife = false;\r\nif (rtlhal->hal_coex_8723.high_priority_tx == 0xeaea &&\r\nrtlhal->hal_coex_8723.high_priority_rx == 0xeaea &&\r\nrtlhal->hal_coex_8723.low_priority_tx == 0xeaea &&\r\nrtlhal->hal_coex_8723.low_priority_rx == 0xeaea)\r\nbt_alife = false;\r\nif (rtlhal->hal_coex_8723.high_priority_tx == 0xffff &&\r\nrtlhal->hal_coex_8723.high_priority_rx == 0xffff &&\r\nrtlhal->hal_coex_8723.low_priority_tx == 0xffff &&\r\nrtlhal->hal_coex_8723.low_priority_rx == 0xffff)\r\nbt_alife = false;\r\nif (bt_alife) {\r\nrtlpcipriv->bt_coexist.bt_active_zero_cnt = 0;\r\nrtlpcipriv->bt_coexist.cur_bt_disabled = false;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"8723A BT is enabled !!\n");\r\n} else {\r\nrtlpcipriv->bt_coexist.bt_active_zero_cnt++;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"8723A bt all counters = 0, %d times!!\n",\r\nrtlpcipriv->bt_coexist.bt_active_zero_cnt);\r\nif (rtlpcipriv->bt_coexist.bt_active_zero_cnt >= 2) {\r\nrtlpcipriv->bt_coexist.cur_bt_disabled = true;\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"8723A BT is disabled !!\n");\r\n}\r\n}\r\nif (rtlpcipriv->bt_coexist.pre_bt_disabled !=\r\nrtlpcipriv->bt_coexist.cur_bt_disabled) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"8723A BT is from %s to %s!!\n",\r\n(rtlpcipriv->bt_coexist.pre_bt_disabled ?\r\n"disabled" : "enabled"),\r\n(rtlpcipriv->bt_coexist.cur_bt_disabled ?\r\n"disabled" : "enabled"));\r\nrtlpcipriv->bt_coexist.pre_bt_disabled\r\n= rtlpcipriv->bt_coexist.cur_bt_disabled;\r\n}\r\n}\r\nvoid rtl8723ae_dm_bt_coexist_8723(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nrtl8723ae_dm_bt_query_bt_information(hw);\r\nrtl8723ae_dm_bt_bt_hw_counters_monitor(hw);\r\nrtl8723ae_dm_bt_bt_enable_disable_check(hw);\r\nif (rtlpcipriv->bt_coexist.bt_ant_num == ANT_X2) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], 2 Ant mechanism\n");\r\n_rtl8723ae_dm_bt_coexist_2_ant(hw);\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"[BTCoex], 1 Ant mechanism\n");\r\n_rtl8723ae_dm_bt_coexist_1_ant(hw);\r\n}\r\nif (!rtl8723ae_dm_bt_is_same_coexist_state(hw)) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTCoex], Coexist State[bitMap] change from 0x%x%8x to 0x%x%8x\n",\r\nrtlpcipriv->bt_coexist.previous_state_h,\r\nrtlpcipriv->bt_coexist.previous_state,\r\nrtlpcipriv->bt_coexist.cstate_h,\r\nrtlpcipriv->bt_coexist.cstate);\r\nrtlpcipriv->bt_coexist.previous_state\r\n= rtlpcipriv->bt_coexist.cstate;\r\nrtlpcipriv->bt_coexist.previous_state_h\r\n= rtlpcipriv->bt_coexist.cstate_h;\r\n}\r\n}\r\nstatic void rtl8723ae_dm_bt_parse_bt_info(struct ieee80211_hw *hw,\r\nu8 *tmbuf, u8 len)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct rtl_hal *rtlhal = rtl_hal(rtlpriv);\r\nstruct rtl_pci_priv *rtlpcipriv = rtl_pcipriv(hw);\r\nu8 bt_info;\r\nu8 i;\r\nrtlhal->hal_coex_8723.c2h_bt_info_req_sent = false;\r\nrtlhal->hal_coex_8723.bt_retry_cnt = 0;\r\nfor (i = 0; i < len; i++) {\r\nif (i == 0)\r\nrtlhal->hal_coex_8723.c2h_bt_info_original = tmbuf[i];\r\nelse if (i == 1)\r\nrtlhal->hal_coex_8723.bt_retry_cnt = tmbuf[i];\r\nif (i == len-1) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"0x%2x]", tmbuf[i]);\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_TRACE,\r\n"0x%2x, ", tmbuf[i]);\r\n}\r\n}\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"BT info bt_info (Data)= 0x%x\n",\r\nrtlhal->hal_coex_8723.c2h_bt_info_original);\r\nbt_info = rtlhal->hal_coex_8723.c2h_bt_info_original;\r\nif (bt_info & BIT(2))\r\nrtlhal->hal_coex_8723.c2h_bt_inquiry_page = true;\r\nelse\r\nrtlhal->hal_coex_8723.c2h_bt_inquiry_page = false;\r\nif (bt_info & BTINFO_B_CONNECTION) {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTC2H], BTInfo: bConnect=true\n");\r\nrtlpcipriv->bt_coexist.bt_busy = true;\r\nrtlpcipriv->bt_coexist.cstate &= ~BT_COEX_STATE_BT_IDLE;\r\n} else {\r\nRT_TRACE(rtlpriv, COMP_BT_COEXIST, DBG_DMESG,\r\n"[BTC2H], BTInfo: bConnect=false\n");\r\nrtlpcipriv->bt_coexist.bt_busy = false;\r\nrtlpcipriv->bt_coexist.cstate |= BT_COEX_STATE_BT_IDLE;\r\n}\r\n}\r\nvoid rtl_8723e_c2h_command_handle(struct ieee80211_hw *hw)\r\n{\r\nstruct rtl_priv *rtlpriv = rtl_priv(hw);\r\nstruct c2h_evt_hdr c2h_event;\r\nu8 *ptmbuf;\r\nu8 index;\r\nu8 u1tmp;\r\nmemset(&c2h_event, 0, sizeof(c2h_event));\r\nu1tmp = rtl_read_byte(rtlpriv, REG_C2HEVT_MSG_NORMAL);\r\nRT_TRACE(rtlpriv, COMP_FW, DBG_DMESG,\r\n"&&&&&&: REG_C2HEVT_MSG_NORMAL is 0x%x\n", u1tmp);\r\nc2h_event.cmd_id = u1tmp & 0xF;\r\nc2h_event.cmd_len = (u1tmp & 0xF0) >> 4;\r\nc2h_event.cmd_seq = rtl_read_byte(rtlpriv, REG_C2HEVT_MSG_NORMAL + 1);\r\nRT_TRACE(rtlpriv, COMP_FW, DBG_DMESG,\r\n"cmd_id: %d, cmd_len: %d, cmd_seq: %d\n",\r\nc2h_event.cmd_id , c2h_event.cmd_len, c2h_event.cmd_seq);\r\nu1tmp = rtl_read_byte(rtlpriv, 0x01AF);\r\nif (u1tmp == C2H_EVT_HOST_CLOSE) {\r\nreturn;\r\n} else if (u1tmp != C2H_EVT_FW_CLOSE) {\r\nrtl_write_byte(rtlpriv, 0x1AF, 0x00);\r\nreturn;\r\n}\r\nptmbuf = kmalloc(c2h_event.cmd_len, GFP_KERNEL);\r\nif (ptmbuf == NULL) {\r\nRT_TRACE(rtlpriv, COMP_FW, DBG_TRACE,\r\n"malloc cmd buf failed\n");\r\nreturn;\r\n}\r\nfor (index = 0; index < c2h_event.cmd_len; index++)\r\nptmbuf[index] = rtl_read_byte(rtlpriv, REG_C2HEVT_MSG_NORMAL +\r\n2 + index);\r\nswitch (c2h_event.cmd_id) {\r\ncase C2H_BT_RSSI:\r\nbreak;\r\ncase C2H_BT_OP_MODE:\r\nbreak;\r\ncase BT_INFO:\r\nRT_TRACE(rtlpriv, COMP_FW, DBG_TRACE,\r\n"BT info Byte[0] (ID) is 0x%x\n", c2h_event.cmd_id);\r\nRT_TRACE(rtlpriv, COMP_FW, DBG_TRACE,\r\n"BT info Byte[1] (Seq) is 0x%x\n", c2h_event.cmd_seq);\r\nRT_TRACE(rtlpriv, COMP_FW, DBG_TRACE,\r\n"BT info Byte[2] (Data)= 0x%x\n", ptmbuf[0]);\r\nrtl8723ae_dm_bt_parse_bt_info(hw, ptmbuf, c2h_event.cmd_len);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nkfree(ptmbuf);\r\nrtl_write_byte(rtlpriv, 0x01AF, C2H_EVT_HOST_CLOSE);\r\n}

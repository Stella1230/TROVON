static int cs5535_mfd_res_enable(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "can't fetch device resource info\n");\r\nreturn -EIO;\r\n}\r\nif (!request_region(res->start, resource_size(res), DRV_NAME)) {\r\ndev_err(&pdev->dev, "can't request region\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int cs5535_mfd_res_disable(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nres = platform_get_resource(pdev, IORESOURCE_IO, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "can't fetch device resource info\n");\r\nreturn -EIO;\r\n}\r\nrelease_region(res->start, resource_size(res));\r\nreturn 0;\r\n}\r\nstatic void cs5535_clone_olpc_cells(void)\r\n{\r\nconst char *acpi_clones[] = { "olpc-xo1-pm-acpi", "olpc-xo1-sci-acpi" };\r\nif (!machine_is_olpc())\r\nreturn;\r\nmfd_clone_cell("cs5535-acpi", acpi_clones, ARRAY_SIZE(acpi_clones));\r\n}\r\nstatic void cs5535_clone_olpc_cells(void) { }\r\nstatic int cs5535_mfd_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *id)\r\n{\r\nint err, i;\r\nerr = pci_enable_device(pdev);\r\nif (err)\r\nreturn err;\r\nfor (i = 0; i < ARRAY_SIZE(cs5535_mfd_cells); i++) {\r\nint bar = cs5535_mfd_cells[i].id;\r\nstruct resource *r = &cs5535_mfd_resources[bar];\r\nr->flags = IORESOURCE_IO;\r\nr->start = pci_resource_start(pdev, bar);\r\nr->end = pci_resource_end(pdev, bar);\r\ncs5535_mfd_cells[i].id = 0;\r\n}\r\nerr = mfd_add_devices(&pdev->dev, -1, cs5535_mfd_cells,\r\nARRAY_SIZE(cs5535_mfd_cells), NULL, 0, NULL);\r\nif (err) {\r\ndev_err(&pdev->dev, "MFD add devices failed: %d\n", err);\r\ngoto err_disable;\r\n}\r\ncs5535_clone_olpc_cells();\r\ndev_info(&pdev->dev, "%zu devices registered.\n",\r\nARRAY_SIZE(cs5535_mfd_cells));\r\nreturn 0;\r\nerr_disable:\r\npci_disable_device(pdev);\r\nreturn err;\r\n}\r\nstatic void cs5535_mfd_remove(struct pci_dev *pdev)\r\n{\r\nmfd_remove_devices(&pdev->dev);\r\npci_disable_device(pdev);\r\n}

static int xfrm4_init_flags(struct xfrm_state *x)\r\n{\r\nif (xs_net(x)->ipv4.sysctl_ip_no_pmtu_disc)\r\nx->props.flags |= XFRM_STATE_NOPMTUDISC;\r\nreturn 0;\r\n}\r\nstatic void\r\n__xfrm4_init_tempsel(struct xfrm_selector *sel, const struct flowi *fl)\r\n{\r\nconst struct flowi4 *fl4 = &fl->u.ip4;\r\nsel->daddr.a4 = fl4->daddr;\r\nsel->saddr.a4 = fl4->saddr;\r\nsel->dport = xfrm_flowi_dport(fl, &fl4->uli);\r\nsel->dport_mask = htons(0xffff);\r\nsel->sport = xfrm_flowi_sport(fl, &fl4->uli);\r\nsel->sport_mask = htons(0xffff);\r\nsel->family = AF_INET;\r\nsel->prefixlen_d = 32;\r\nsel->prefixlen_s = 32;\r\nsel->proto = fl4->flowi4_proto;\r\nsel->ifindex = fl4->flowi4_oif;\r\n}\r\nstatic void\r\nxfrm4_init_temprop(struct xfrm_state *x, const struct xfrm_tmpl *tmpl,\r\nconst xfrm_address_t *daddr, const xfrm_address_t *saddr)\r\n{\r\nx->id = tmpl->id;\r\nif (x->id.daddr.a4 == 0)\r\nx->id.daddr.a4 = daddr->a4;\r\nx->props.saddr = tmpl->saddr;\r\nif (x->props.saddr.a4 == 0)\r\nx->props.saddr.a4 = saddr->a4;\r\nx->props.mode = tmpl->mode;\r\nx->props.reqid = tmpl->reqid;\r\nx->props.family = AF_INET;\r\n}\r\nint xfrm4_extract_header(struct sk_buff *skb)\r\n{\r\nconst struct iphdr *iph = ip_hdr(skb);\r\nXFRM_MODE_SKB_CB(skb)->ihl = sizeof(*iph);\r\nXFRM_MODE_SKB_CB(skb)->id = iph->id;\r\nXFRM_MODE_SKB_CB(skb)->frag_off = iph->frag_off;\r\nXFRM_MODE_SKB_CB(skb)->tos = iph->tos;\r\nXFRM_MODE_SKB_CB(skb)->ttl = iph->ttl;\r\nXFRM_MODE_SKB_CB(skb)->optlen = iph->ihl * 4 - sizeof(*iph);\r\nmemset(XFRM_MODE_SKB_CB(skb)->flow_lbl, 0,\r\nsizeof(XFRM_MODE_SKB_CB(skb)->flow_lbl));\r\nreturn 0;\r\n}\r\nvoid __init xfrm4_state_init(void)\r\n{\r\nxfrm_state_register_afinfo(&xfrm4_state_afinfo);\r\n}

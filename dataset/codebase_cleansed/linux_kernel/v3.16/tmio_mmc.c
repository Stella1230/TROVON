static int tmio_mmc_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nint ret;\r\nret = tmio_mmc_host_suspend(dev);\r\nif (!ret && cell->disable)\r\ncell->disable(pdev);\r\nreturn ret;\r\n}\r\nstatic int tmio_mmc_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nint ret = 0;\r\nif (cell->resume)\r\nret = cell->resume(pdev);\r\nif (!ret)\r\nret = tmio_mmc_host_resume(dev);\r\nreturn ret;\r\n}\r\nstatic int tmio_mmc_probe(struct platform_device *pdev)\r\n{\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nstruct tmio_mmc_data *pdata;\r\nstruct tmio_mmc_host *host;\r\nstruct resource *res;\r\nint ret = -EINVAL, irq;\r\nif (pdev->num_resources != 2)\r\ngoto out;\r\npdata = pdev->dev.platform_data;\r\nif (!pdata || !pdata->hclk)\r\ngoto out;\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\nret = irq;\r\ngoto out;\r\n}\r\nif (cell->enable) {\r\nret = cell->enable(pdev);\r\nif (ret)\r\ngoto out;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res)\r\nreturn -EINVAL;\r\npdata->bus_shift = resource_size(res) >> 10;\r\npdata->flags |= TMIO_MMC_HAVE_HIGH_REG;\r\nret = tmio_mmc_host_probe(&host, pdev, pdata);\r\nif (ret)\r\ngoto cell_disable;\r\nret = request_irq(irq, tmio_mmc_irq, IRQF_TRIGGER_FALLING,\r\ndev_name(&pdev->dev), host);\r\nif (ret)\r\ngoto host_remove;\r\npr_info("%s at 0x%08lx irq %d\n", mmc_hostname(host->mmc),\r\n(unsigned long)host->ctl, irq);\r\nreturn 0;\r\nhost_remove:\r\ntmio_mmc_host_remove(host);\r\ncell_disable:\r\nif (cell->disable)\r\ncell->disable(pdev);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int tmio_mmc_remove(struct platform_device *pdev)\r\n{\r\nconst struct mfd_cell *cell = mfd_get_cell(pdev);\r\nstruct mmc_host *mmc = platform_get_drvdata(pdev);\r\nif (mmc) {\r\nstruct tmio_mmc_host *host = mmc_priv(mmc);\r\nfree_irq(platform_get_irq(pdev, 0), host);\r\ntmio_mmc_host_remove(host);\r\nif (cell->disable)\r\ncell->disable(pdev);\r\n}\r\nreturn 0;\r\n}

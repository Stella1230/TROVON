static int denali_pci_probe(struct pci_dev *dev, const struct pci_device_id *id)\r\n{\r\nint ret = -ENODEV;\r\nresource_size_t csr_base, mem_base;\r\nunsigned long csr_len, mem_len;\r\nstruct denali_nand_info *denali;\r\ndenali = kzalloc(sizeof(*denali), GFP_KERNEL);\r\nif (!denali)\r\nreturn -ENOMEM;\r\nret = pci_enable_device(dev);\r\nif (ret) {\r\npr_err("Spectra: pci_enable_device failed.\n");\r\ngoto failed_alloc_memery;\r\n}\r\nif (id->driver_data == INTEL_CE4100) {\r\ndenali->platform = INTEL_CE4100;\r\nmem_base = pci_resource_start(dev, 0);\r\nmem_len = pci_resource_len(dev, 1);\r\ncsr_base = pci_resource_start(dev, 1);\r\ncsr_len = pci_resource_len(dev, 1);\r\n} else {\r\ndenali->platform = INTEL_MRST;\r\ncsr_base = pci_resource_start(dev, 0);\r\ncsr_len = pci_resource_len(dev, 0);\r\nmem_base = pci_resource_start(dev, 1);\r\nmem_len = pci_resource_len(dev, 1);\r\nif (!mem_len) {\r\nmem_base = csr_base + csr_len;\r\nmem_len = csr_len;\r\n}\r\n}\r\npci_set_master(dev);\r\ndenali->dev = &dev->dev;\r\ndenali->irq = dev->irq;\r\nret = pci_request_regions(dev, DENALI_NAND_NAME);\r\nif (ret) {\r\npr_err("Spectra: Unable to request memory regions\n");\r\ngoto failed_enable_dev;\r\n}\r\ndenali->flash_reg = ioremap_nocache(csr_base, csr_len);\r\nif (!denali->flash_reg) {\r\npr_err("Spectra: Unable to remap memory region\n");\r\nret = -ENOMEM;\r\ngoto failed_req_regions;\r\n}\r\ndenali->flash_mem = ioremap_nocache(mem_base, mem_len);\r\nif (!denali->flash_mem) {\r\npr_err("Spectra: ioremap_nocache failed!");\r\nret = -ENOMEM;\r\ngoto failed_remap_reg;\r\n}\r\nret = denali_init(denali);\r\nif (ret)\r\ngoto failed_remap_mem;\r\npci_set_drvdata(dev, denali);\r\nreturn 0;\r\nfailed_remap_mem:\r\niounmap(denali->flash_mem);\r\nfailed_remap_reg:\r\niounmap(denali->flash_reg);\r\nfailed_req_regions:\r\npci_release_regions(dev);\r\nfailed_enable_dev:\r\npci_disable_device(dev);\r\nfailed_alloc_memery:\r\nkfree(denali);\r\nreturn ret;\r\n}\r\nstatic void denali_pci_remove(struct pci_dev *dev)\r\n{\r\nstruct denali_nand_info *denali = pci_get_drvdata(dev);\r\ndenali_remove(denali);\r\niounmap(denali->flash_reg);\r\niounmap(denali->flash_mem);\r\npci_release_regions(dev);\r\npci_disable_device(dev);\r\nkfree(denali);\r\n}\r\nstatic int denali_init_pci(void)\r\n{\r\nreturn pci_register_driver(&denali_pci_driver);\r\n}\r\nstatic void denali_exit_pci(void)\r\n{\r\npci_unregister_driver(&denali_pci_driver);\r\n}

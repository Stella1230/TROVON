static inline void stac9460_put(struct snd_ice1712 *ice, int reg,\r\nunsigned char val)\r\n{\r\nsnd_vt1724_write_i2c(ice, STAC9460_I2C_ADDR, reg, val);\r\n}\r\nstatic inline unsigned char stac9460_get(struct snd_ice1712 *ice, int reg)\r\n{\r\nreturn snd_vt1724_read_i2c(ice, STAC9460_I2C_ADDR, reg);\r\n}\r\nstatic inline void stac9460_2_put(struct snd_ice1712 *ice, int reg,\r\nunsigned char val)\r\n{\r\nsnd_vt1724_write_i2c(ice, STAC9460_2_I2C_ADDR, reg, val);\r\n}\r\nstatic inline unsigned char stac9460_2_get(struct snd_ice1712 *ice, int reg)\r\n{\r\nreturn snd_vt1724_read_i2c(ice, STAC9460_2_I2C_ADDR, reg);\r\n}\r\nstatic int stac9460_dac_mute_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nint idx, id;\r\nif (kcontrol->private_value) {\r\nidx = STAC946X_MASTER_VOLUME;\r\nid = 0;\r\n} else {\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nidx = id + STAC946X_LF_VOLUME;\r\n}\r\nif (id < 6)\r\nval = stac9460_get(ice, idx);\r\nelse\r\nval = stac9460_2_get(ice, idx - 6);\r\nucontrol->value.integer.value[0] = (~val >> 7) & 0x1;\r\nreturn 0;\r\n}\r\nstatic int stac9460_dac_mute_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char new, old;\r\nint id, idx;\r\nint change;\r\nif (kcontrol->private_value) {\r\nidx = STAC946X_MASTER_VOLUME;\r\nold = stac9460_get(ice, idx);\r\nnew = (~ucontrol->value.integer.value[0] << 7 & 0x80) |\r\n(old & ~0x80);\r\nchange = (new != old);\r\nif (change) {\r\nstac9460_put(ice, idx, new);\r\nstac9460_2_put(ice, idx, new);\r\n}\r\n} else {\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nidx = id + STAC946X_LF_VOLUME;\r\nif (id < 6)\r\nold = stac9460_get(ice, idx);\r\nelse\r\nold = stac9460_2_get(ice, idx - 6);\r\nnew = (~ucontrol->value.integer.value[0] << 7 & 0x80) |\r\n(old & ~0x80);\r\nchange = (new != old);\r\nif (change) {\r\nif (id < 6)\r\nstac9460_put(ice, idx, new);\r\nelse\r\nstac9460_2_put(ice, idx - 6, new);\r\n}\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_dac_vol_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 1;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 0x7f;\r\nreturn 0;\r\n}\r\nstatic int stac9460_dac_vol_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint idx, id;\r\nunsigned char vol;\r\nif (kcontrol->private_value) {\r\nidx = STAC946X_MASTER_VOLUME;\r\nid = 0;\r\n} else {\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nidx = id + STAC946X_LF_VOLUME;\r\n}\r\nif (id < 6)\r\nvol = stac9460_get(ice, idx) & 0x7f;\r\nelse\r\nvol = stac9460_2_get(ice, idx - 6) & 0x7f;\r\nucontrol->value.integer.value[0] = 0x7f - vol;\r\nreturn 0;\r\n}\r\nstatic int stac9460_dac_vol_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint idx, id;\r\nunsigned char tmp, ovol, nvol;\r\nint change;\r\nif (kcontrol->private_value) {\r\nidx = STAC946X_MASTER_VOLUME;\r\nnvol = ucontrol->value.integer.value[0] & 0x7f;\r\ntmp = stac9460_get(ice, idx);\r\novol = 0x7f - (tmp & 0x7f);\r\nchange = (ovol != nvol);\r\nif (change) {\r\nstac9460_put(ice, idx, (0x7f - nvol) | (tmp & 0x80));\r\nstac9460_2_put(ice, idx, (0x7f - nvol) | (tmp & 0x80));\r\n}\r\n} else {\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nidx = id + STAC946X_LF_VOLUME;\r\nnvol = ucontrol->value.integer.value[0] & 0x7f;\r\nif (id < 6)\r\ntmp = stac9460_get(ice, idx);\r\nelse\r\ntmp = stac9460_2_get(ice, idx - 6);\r\novol = 0x7f - (tmp & 0x7f);\r\nchange = (ovol != nvol);\r\nif (change) {\r\nif (id < 6)\r\nstac9460_put(ice, idx, (0x7f - nvol) |\r\n(tmp & 0x80));\r\nelse\r\nstac9460_2_put(ice, idx-6, (0x7f - nvol) |\r\n(tmp & 0x80));\r\n}\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_adc_mute_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nint i, id;\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nif (id == 0) {\r\nfor (i = 0; i < 2; ++i) {\r\nval = stac9460_get(ice, STAC946X_MIC_L_VOLUME + i);\r\nucontrol->value.integer.value[i] = ~val>>7 & 0x1;\r\n}\r\n} else {\r\nfor (i = 0; i < 2; ++i) {\r\nval = stac9460_2_get(ice, STAC946X_MIC_L_VOLUME + i);\r\nucontrol->value.integer.value[i] = ~val>>7 & 0x1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int stac9460_adc_mute_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char new, old;\r\nint i, reg, id;\r\nint change;\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nif (id == 0) {\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nold = stac9460_get(ice, reg);\r\nnew = (~ucontrol->value.integer.value[i]<<7&0x80) |\r\n(old&~0x80);\r\nchange = (new != old);\r\nif (change)\r\nstac9460_put(ice, reg, new);\r\n}\r\n} else {\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nold = stac9460_2_get(ice, reg);\r\nnew = (~ucontrol->value.integer.value[i]<<7&0x80) |\r\n(old&~0x80);\r\nchange = (new != old);\r\nif (change)\r\nstac9460_2_put(ice, reg, new);\r\n}\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_adc_vol_info(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_info *uinfo)\r\n{\r\nuinfo->type = SNDRV_CTL_ELEM_TYPE_INTEGER;\r\nuinfo->count = 2;\r\nuinfo->value.integer.min = 0;\r\nuinfo->value.integer.max = 0x0f;\r\nreturn 0;\r\n}\r\nstatic int stac9460_adc_vol_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint i, reg, id;\r\nunsigned char vol;\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nif (id == 0) {\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nvol = stac9460_get(ice, reg) & 0x0f;\r\nucontrol->value.integer.value[i] = 0x0f - vol;\r\n}\r\n} else {\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nvol = stac9460_2_get(ice, reg) & 0x0f;\r\nucontrol->value.integer.value[i] = 0x0f - vol;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int stac9460_adc_vol_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nint i, reg, id;\r\nunsigned char ovol, nvol;\r\nint change;\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nif (id == 0) {\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nnvol = ucontrol->value.integer.value[i] & 0x0f;\r\novol = 0x0f - stac9460_get(ice, reg);\r\nchange = ((ovol & 0x0f) != nvol);\r\nif (change)\r\nstac9460_put(ice, reg, (0x0f - nvol) |\r\n(ovol & ~0x0f));\r\n}\r\n} else {\r\nfor (i = 0; i < 2; ++i) {\r\nreg = STAC946X_MIC_L_VOLUME + i;\r\nnvol = ucontrol->value.integer.value[i] & 0x0f;\r\novol = 0x0f - stac9460_2_get(ice, reg);\r\nchange = ((ovol & 0x0f) != nvol);\r\nif (change)\r\nstac9460_2_put(ice, reg, (0x0f - nvol) |\r\n(ovol & ~0x0f));\r\n}\r\n}\r\nreturn change;\r\n}\r\nstatic int stac9460_mic_sw_get(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char val;\r\nint id;\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nif (id == 0)\r\nval = stac9460_get(ice, STAC946X_GENERAL_PURPOSE);\r\nelse\r\nval = stac9460_2_get(ice, STAC946X_GENERAL_PURPOSE);\r\nucontrol->value.integer.value[0] = ~val>>7 & 0x1;\r\nreturn 0;\r\n}\r\nstatic int stac9460_mic_sw_put(struct snd_kcontrol *kcontrol,\r\nstruct snd_ctl_elem_value *ucontrol)\r\n{\r\nstruct snd_ice1712 *ice = snd_kcontrol_chip(kcontrol);\r\nunsigned char new, old;\r\nint change, id;\r\nid = snd_ctl_get_ioffidx(kcontrol, &ucontrol->id);\r\nif (id == 0)\r\nold = stac9460_get(ice, STAC946X_GENERAL_PURPOSE);\r\nelse\r\nold = stac9460_2_get(ice, STAC946X_GENERAL_PURPOSE);\r\nnew = (~ucontrol->value.integer.value[0] << 7 & 0x80) | (old & ~0x80);\r\nchange = (new != old);\r\nif (change) {\r\nif (id == 0)\r\nstac9460_put(ice, STAC946X_GENERAL_PURPOSE, new);\r\nelse\r\nstac9460_2_put(ice, STAC946X_GENERAL_PURPOSE, new);\r\n}\r\nreturn change;\r\n}\r\nstatic int wtm_add_controls(struct snd_ice1712 *ice)\r\n{\r\nunsigned int i;\r\nint err;\r\nfor (i = 0; i < ARRAY_SIZE(stac9640_controls); i++) {\r\nerr = snd_ctl_add(ice->card,\r\nsnd_ctl_new1(&stac9640_controls[i], ice));\r\nif (err < 0)\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int wtm_init(struct snd_ice1712 *ice)\r\n{\r\nstatic unsigned short stac_inits_prodigy[] = {\r\nSTAC946X_RESET, 0,\r\n(unsigned short)-1\r\n};\r\nunsigned short *p;\r\nice->num_total_dacs = 8;\r\nice->num_total_adcs = 4;\r\nice->force_rdma1 = 1;\r\np = stac_inits_prodigy;\r\nfor (; *p != (unsigned short)-1; p += 2) {\r\nstac9460_put(ice, p[0], p[1]);\r\nstac9460_2_put(ice, p[0], p[1]);\r\n}\r\nreturn 0;\r\n}

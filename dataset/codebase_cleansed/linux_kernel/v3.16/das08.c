static int das08_ai_eoc(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned long context)\r\n{\r\nunsigned int status;\r\nstatus = inb(dev->iobase + DAS08_STATUS);\r\nif ((status & DAS08_EOC) == 0)\r\nreturn 0;\r\nreturn -EBUSY;\r\n}\r\nstatic int das08_ai_rinsn(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nstruct das08_private_struct *devpriv = dev->private;\r\nint n;\r\nint chan;\r\nint range;\r\nint lsb, msb;\r\nint ret;\r\nchan = CR_CHAN(insn->chanspec);\r\nrange = CR_RANGE(insn->chanspec);\r\ninb(dev->iobase + DAS08_LSB);\r\ninb(dev->iobase + DAS08_MSB);\r\nspin_lock(&dev->spinlock);\r\ndevpriv->do_mux_bits &= ~DAS08_MUX_MASK;\r\ndevpriv->do_mux_bits |= DAS08_MUX(chan);\r\noutb(devpriv->do_mux_bits, dev->iobase + DAS08_CONTROL);\r\nspin_unlock(&dev->spinlock);\r\nif (s->range_table->length > 1) {\r\nrange = CR_RANGE(insn->chanspec);\r\noutb(devpriv->pg_gainlist[range],\r\ndev->iobase + DAS08AO_GAIN_CONTROL);\r\n}\r\nfor (n = 0; n < insn->n; n++) {\r\nif (thisboard->ai_nbits == 16)\r\nif (inb(dev->iobase + DAS08_MSB) & 0x80)\r\ndev_info(dev->class_dev, "over-range\n");\r\noutb_p(0, dev->iobase + DAS08_TRIG_12BIT);\r\nret = comedi_timeout(dev, s, insn, das08_ai_eoc, 0);\r\nif (ret)\r\nreturn ret;\r\nmsb = inb(dev->iobase + DAS08_MSB);\r\nlsb = inb(dev->iobase + DAS08_LSB);\r\nif (thisboard->ai_encoding == das08_encode12) {\r\ndata[n] = (lsb >> 4) | (msb << 4);\r\n} else if (thisboard->ai_encoding == das08_pcm_encode12) {\r\ndata[n] = (msb << 8) + lsb;\r\n} else if (thisboard->ai_encoding == das08_encode16) {\r\nif (msb & 0x80)\r\ndata[n] = (1 << 15) | lsb | ((msb & 0x7f) << 8);\r\nelse\r\ndata[n] = (1 << 15) - (lsb | (msb & 0x7f) << 8);\r\n} else {\r\ncomedi_error(dev, "bug! unknown ai encoding");\r\nreturn -1;\r\n}\r\n}\r\nreturn n;\r\n}\r\nstatic int das08_di_rbits(struct comedi_device *dev, struct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[0] = 0;\r\ndata[1] = DAS08_IP(inb(dev->iobase + DAS08_STATUS));\r\nreturn insn->n;\r\n}\r\nstatic int das08_do_wbits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct das08_private_struct *devpriv = dev->private;\r\nif (comedi_dio_update_state(s, data)) {\r\nspin_lock(&dev->spinlock);\r\ndevpriv->do_mux_bits &= ~DAS08_DO_MASK;\r\ndevpriv->do_mux_bits |= DAS08_OP(s->state);\r\noutb(devpriv->do_mux_bits, dev->iobase + DAS08_CONTROL);\r\nspin_unlock(&dev->spinlock);\r\n}\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic int das08jr_di_rbits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\ndata[0] = 0;\r\ndata[1] = inb(dev->iobase + DAS08JR_DIO);\r\nreturn insn->n;\r\n}\r\nstatic int das08jr_do_wbits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nif (comedi_dio_update_state(s, data))\r\noutb(s->state, dev->iobase + DAS08JR_DIO);\r\ndata[1] = s->state;\r\nreturn insn->n;\r\n}\r\nstatic void das08_ao_set_data(struct comedi_device *dev,\r\nunsigned int chan, unsigned int data)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nstruct das08_private_struct *devpriv = dev->private;\r\nunsigned char lsb;\r\nunsigned char msb;\r\nlsb = data & 0xff;\r\nmsb = (data >> 8) & 0xff;\r\nif (thisboard->is_jr) {\r\noutb(lsb, dev->iobase + DAS08JR_AO_LSB(chan));\r\noutb(msb, dev->iobase + DAS08JR_AO_MSB(chan));\r\ninb(dev->iobase + DAS08JR_DIO);\r\n} else {\r\noutb(lsb, dev->iobase + DAS08AO_AO_LSB(chan));\r\noutb(msb, dev->iobase + DAS08AO_AO_MSB(chan));\r\ninb(dev->iobase + DAS08AO_AO_UPDATE);\r\n}\r\ndevpriv->ao_readback[chan] = data;\r\n}\r\nstatic void das08_ao_initialize(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nint n;\r\nunsigned int data;\r\ndata = s->maxdata / 2;\r\nfor (n = 0; n < s->n_chan; n++)\r\ndas08_ao_set_data(dev, n, data);\r\n}\r\nstatic int das08_ao_winsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nunsigned int n;\r\nunsigned int chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++)\r\ndas08_ao_set_data(dev, chan, *data);\r\nreturn n;\r\n}\r\nstatic int das08_ao_rinsn(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nstruct das08_private_struct *devpriv = dev->private;\r\nunsigned int n;\r\nunsigned int chan;\r\nchan = CR_CHAN(insn->chanspec);\r\nfor (n = 0; n < insn->n; n++)\r\ndata[n] = devpriv->ao_readback[chan];\r\nreturn n;\r\n}\r\nstatic void i8254_initialize(struct comedi_device *dev)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nunsigned long i8254_iobase = dev->iobase + thisboard->i8254_offset;\r\nunsigned int mode = I8254_MODE0 | I8254_BINARY;\r\nint i;\r\nfor (i = 0; i < 3; ++i)\r\ni8254_set_mode(i8254_iobase, 0, i, mode);\r\n}\r\nstatic int das08_counter_read(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nunsigned long i8254_iobase = dev->iobase + thisboard->i8254_offset;\r\nint chan = insn->chanspec;\r\ndata[0] = i8254_read(i8254_iobase, 0, chan);\r\nreturn 1;\r\n}\r\nstatic int das08_counter_write(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nunsigned long i8254_iobase = dev->iobase + thisboard->i8254_offset;\r\nint chan = insn->chanspec;\r\ni8254_write(i8254_iobase, 0, chan, data[0]);\r\nreturn 1;\r\n}\r\nstatic int das08_counter_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn, unsigned int *data)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nunsigned long i8254_iobase = dev->iobase + thisboard->i8254_offset;\r\nint chan = insn->chanspec;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_SET_COUNTER_MODE:\r\ni8254_set_mode(i8254_iobase, 0, chan, data[1]);\r\nbreak;\r\ncase INSN_CONFIG_8254_READ_STATUS:\r\ndata[1] = i8254_status(i8254_iobase, 0, chan);\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\nbreak;\r\n}\r\nreturn 2;\r\n}\r\nint das08_common_attach(struct comedi_device *dev, unsigned long iobase)\r\n{\r\nconst struct das08_board_struct *thisboard = comedi_board(dev);\r\nstruct das08_private_struct *devpriv = dev->private;\r\nstruct comedi_subdevice *s;\r\nint ret;\r\ndev->iobase = iobase;\r\ndev->board_name = thisboard->name;\r\nret = comedi_alloc_subdevices(dev, 6);\r\nif (ret)\r\nreturn ret;\r\ns = &dev->subdevices[0];\r\nif (thisboard->ai_nbits) {\r\ns->type = COMEDI_SUBD_AI;\r\ns->subdev_flags = SDF_READABLE | SDF_GROUND;\r\ns->n_chan = 8;\r\ns->maxdata = (1 << thisboard->ai_nbits) - 1;\r\ns->range_table = das08_ai_lranges[thisboard->ai_pg];\r\ns->insn_read = das08_ai_rinsn;\r\ndevpriv->pg_gainlist = das08_gainlists[thisboard->ai_pg];\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[1];\r\nif (thisboard->ao_nbits) {\r\ns->type = COMEDI_SUBD_AO;\r\ns->subdev_flags = SDF_WRITABLE;\r\ns->n_chan = 2;\r\ns->maxdata = (1 << thisboard->ao_nbits) - 1;\r\ns->range_table = &range_bipolar5;\r\ns->insn_write = das08_ao_winsn;\r\ns->insn_read = das08_ao_rinsn;\r\ndas08_ao_initialize(dev, s);\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[2];\r\nif (thisboard->di_nchan) {\r\ns->type = COMEDI_SUBD_DI;\r\ns->subdev_flags = SDF_READABLE;\r\ns->n_chan = thisboard->di_nchan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits =\r\nthisboard->is_jr ? das08jr_di_rbits : das08_di_rbits;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[3];\r\nif (thisboard->do_nchan) {\r\ns->type = COMEDI_SUBD_DO;\r\ns->subdev_flags = SDF_WRITABLE | SDF_READABLE;\r\ns->n_chan = thisboard->do_nchan;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits =\r\nthisboard->is_jr ? das08jr_do_wbits : das08_do_wbits;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[4];\r\nif (thisboard->i8255_offset != 0) {\r\nret = subdev_8255_init(dev, s, NULL,\r\ndev->iobase + thisboard->i8255_offset);\r\nif (ret)\r\nreturn ret;\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\ns = &dev->subdevices[5];\r\nif (thisboard->i8254_offset != 0) {\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_WRITABLE | SDF_READABLE;\r\ns->n_chan = 3;\r\ns->maxdata = 0xFFFF;\r\ns->insn_read = das08_counter_read;\r\ns->insn_write = das08_counter_write;\r\ns->insn_config = das08_counter_config;\r\ni8254_initialize(dev);\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init das08_init(void)\r\n{\r\nreturn 0;\r\n}\r\nstatic void __exit das08_exit(void)\r\n{\r\n}

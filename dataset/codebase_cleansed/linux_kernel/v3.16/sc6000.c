static unsigned char sc6000_irq_to_softcfg(int irq)\r\n{\r\nunsigned char val = 0;\r\nswitch (irq) {\r\ncase 5:\r\nval = 0x28;\r\nbreak;\r\ncase 7:\r\nval = 0x8;\r\nbreak;\r\ncase 9:\r\nval = 0x10;\r\nbreak;\r\ncase 10:\r\nval = 0x18;\r\nbreak;\r\ncase 11:\r\nval = 0x20;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn val;\r\n}\r\nstatic unsigned char sc6000_dma_to_softcfg(int dma)\r\n{\r\nunsigned char val = 0;\r\nswitch (dma) {\r\ncase 0:\r\nval = 1;\r\nbreak;\r\ncase 1:\r\nval = 2;\r\nbreak;\r\ncase 3:\r\nval = 3;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn val;\r\n}\r\nstatic unsigned char sc6000_mpu_irq_to_softcfg(int mpu_irq)\r\n{\r\nunsigned char val = 0;\r\nswitch (mpu_irq) {\r\ncase 5:\r\nval = 4;\r\nbreak;\r\ncase 7:\r\nval = 0x44;\r\nbreak;\r\ncase 9:\r\nval = 0x84;\r\nbreak;\r\ncase 10:\r\nval = 0xc4;\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\nreturn val;\r\n}\r\nstatic int sc6000_wait_data(char __iomem *vport)\r\n{\r\nint loop = 1000;\r\nunsigned char val = 0;\r\ndo {\r\nval = ioread8(vport + DSP_DATAVAIL);\r\nif (val & 0x80)\r\nreturn 0;\r\ncpu_relax();\r\n} while (loop--);\r\nreturn -EAGAIN;\r\n}\r\nstatic int sc6000_read(char __iomem *vport)\r\n{\r\nif (sc6000_wait_data(vport))\r\nreturn -EBUSY;\r\nreturn ioread8(vport + DSP_READ);\r\n}\r\nstatic int sc6000_write(char __iomem *vport, int cmd)\r\n{\r\nunsigned char val;\r\nint loop = 500000;\r\ndo {\r\nval = ioread8(vport + DSP_STATUS);\r\nif (!(val & 0x80)) {\r\niowrite8(cmd, vport + DSP_COMMAND);\r\nreturn 0;\r\n}\r\ncpu_relax();\r\n} while (loop--);\r\nsnd_printk(KERN_ERR "DSP Command (0x%x) timeout.\n", cmd);\r\nreturn -EIO;\r\n}\r\nstatic int sc6000_dsp_get_answer(char __iomem *vport, int command,\r\nchar *data, int data_len)\r\n{\r\nint len = 0;\r\nif (sc6000_write(vport, command)) {\r\nsnd_printk(KERN_ERR "CMD 0x%x: failed!\n", command);\r\nreturn -EIO;\r\n}\r\ndo {\r\nint val = sc6000_read(vport);\r\nif (val < 0)\r\nbreak;\r\ndata[len++] = val;\r\n} while (len < data_len);\r\nreturn len ? len : -EIO;\r\n}\r\nstatic int sc6000_dsp_reset(char __iomem *vport)\r\n{\r\niowrite8(1, vport + DSP_RESET);\r\nudelay(10);\r\niowrite8(0, vport + DSP_RESET);\r\nudelay(20);\r\nif (sc6000_read(vport) == 0xaa)\r\nreturn 0;\r\nreturn -ENODEV;\r\n}\r\nstatic int sc6000_hw_cfg_write(char __iomem *vport, const int *cfg)\r\n{\r\nif (sc6000_write(vport, COMMAND_6C) < 0) {\r\nsnd_printk(KERN_WARNING "CMD 0x%x: failed!\n", COMMAND_6C);\r\nreturn -EIO;\r\n}\r\nif (sc6000_write(vport, COMMAND_5C) < 0) {\r\nsnd_printk(KERN_ERR "CMD 0x%x: failed!\n", COMMAND_5C);\r\nreturn -EIO;\r\n}\r\nif (sc6000_write(vport, cfg[0]) < 0) {\r\nsnd_printk(KERN_ERR "DATA 0x%x: failed!\n", cfg[0]);\r\nreturn -EIO;\r\n}\r\nif (sc6000_write(vport, cfg[1]) < 0) {\r\nsnd_printk(KERN_ERR "DATA 0x%x: failed!\n", cfg[1]);\r\nreturn -EIO;\r\n}\r\nif (sc6000_write(vport, COMMAND_C5) < 0) {\r\nsnd_printk(KERN_ERR "CMD 0x%x: failed!\n", COMMAND_C5);\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sc6000_cfg_write(char __iomem *vport, unsigned char softcfg)\r\n{\r\nif (sc6000_write(vport, WRITE_MDIRQ_CFG)) {\r\nsnd_printk(KERN_ERR "CMD 0x%x: failed!\n", WRITE_MDIRQ_CFG);\r\nreturn -EIO;\r\n}\r\nif (sc6000_write(vport, softcfg)) {\r\nsnd_printk(KERN_ERR "sc6000_cfg_write: failed!\n");\r\nreturn -EIO;\r\n}\r\nreturn 0;\r\n}\r\nstatic int sc6000_setup_board(char __iomem *vport, int config)\r\n{\r\nint loop = 10;\r\ndo {\r\nif (sc6000_write(vport, COMMAND_88)) {\r\nsnd_printk(KERN_ERR "CMD 0x%x: failed!\n",\r\nCOMMAND_88);\r\nreturn -EIO;\r\n}\r\n} while ((sc6000_wait_data(vport) < 0) && loop--);\r\nif (sc6000_read(vport) < 0) {\r\nsnd_printk(KERN_ERR "sc6000_read after CMD 0x%x: failed\n",\r\nCOMMAND_88);\r\nreturn -EIO;\r\n}\r\nif (sc6000_cfg_write(vport, config))\r\nreturn -ENODEV;\r\nreturn 0;\r\n}\r\nstatic int sc6000_init_mss(char __iomem *vport, int config,\r\nchar __iomem *vmss_port, int mss_config)\r\n{\r\nif (sc6000_write(vport, DSP_INIT_MSS)) {\r\nsnd_printk(KERN_ERR "sc6000_init_mss [0x%x]: failed!\n",\r\nDSP_INIT_MSS);\r\nreturn -EIO;\r\n}\r\nmsleep(10);\r\nif (sc6000_cfg_write(vport, config))\r\nreturn -EIO;\r\niowrite8(mss_config, vmss_port);\r\nreturn 0;\r\n}\r\nstatic void sc6000_hw_cfg_encode(char __iomem *vport, int *cfg,\r\nlong xport, long xmpu,\r\nlong xmss_port, int joystick)\r\n{\r\ncfg[0] = 0;\r\ncfg[1] = 0;\r\nif (xport == 0x240)\r\ncfg[0] |= 1;\r\nif (xmpu != SNDRV_AUTO_PORT) {\r\ncfg[0] |= (xmpu & 0x30) >> 2;\r\ncfg[1] |= 0x20;\r\n}\r\nif (xmss_port == 0xe80)\r\ncfg[0] |= 0x10;\r\ncfg[0] |= 0x40;\r\nif (!joystick)\r\ncfg[0] |= 0x02;\r\ncfg[1] |= 0x80;\r\ncfg[1] &= ~0x40;\r\nsnd_printd("hw cfg %x, %x\n", cfg[0], cfg[1]);\r\n}\r\nstatic int sc6000_init_board(char __iomem *vport,\r\nchar __iomem *vmss_port, int dev)\r\n{\r\nchar answer[15];\r\nchar version[2];\r\nint mss_config = sc6000_irq_to_softcfg(irq[dev]) |\r\nsc6000_dma_to_softcfg(dma[dev]);\r\nint config = mss_config |\r\nsc6000_mpu_irq_to_softcfg(mpu_irq[dev]);\r\nint err;\r\nint old = 0;\r\nerr = sc6000_dsp_reset(vport);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR "sc6000_dsp_reset: failed!\n");\r\nreturn err;\r\n}\r\nmemset(answer, 0, sizeof(answer));\r\nerr = sc6000_dsp_get_answer(vport, GET_DSP_COPYRIGHT, answer, 15);\r\nif (err <= 0) {\r\nsnd_printk(KERN_ERR "sc6000_dsp_copyright: failed!\n");\r\nreturn -ENODEV;\r\n}\r\nif (strncmp("SC-6000", answer, 7))\r\nsnd_printk(KERN_WARNING "Warning: non SC-6000 audio card!\n");\r\nif (sc6000_dsp_get_answer(vport, GET_DSP_VERSION, version, 2) < 2) {\r\nsnd_printk(KERN_ERR "sc6000_dsp_version: failed!\n");\r\nreturn -ENODEV;\r\n}\r\nprintk(KERN_INFO PFX "Detected model: %s, DSP version %d.%d\n",\r\nanswer, version[0], version[1]);\r\nsc6000_write(vport, COMMAND_5C);\r\nif (sc6000_read(vport) < 0)\r\nold = 1;\r\nif (!old) {\r\nint cfg[2];\r\nsc6000_hw_cfg_encode(vport, &cfg[0], port[dev], mpu_port[dev],\r\nmss_port[dev], joystick[dev]);\r\nif (sc6000_hw_cfg_write(vport, cfg) < 0) {\r\nsnd_printk(KERN_ERR "sc6000_hw_cfg_write: failed!\n");\r\nreturn -EIO;\r\n}\r\n}\r\nerr = sc6000_setup_board(vport, config);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR "sc6000_setup_board: failed!\n");\r\nreturn -ENODEV;\r\n}\r\nsc6000_dsp_reset(vport);\r\nif (!old) {\r\nsc6000_write(vport, COMMAND_60);\r\nsc6000_write(vport, 0x02);\r\nsc6000_dsp_reset(vport);\r\n}\r\nerr = sc6000_setup_board(vport, config);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR "sc6000_setup_board: failed!\n");\r\nreturn -ENODEV;\r\n}\r\nerr = sc6000_init_mss(vport, config, vmss_port, mss_config);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR "Cannot initialize "\r\n"Microsoft Sound System mode.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn 0;\r\n}\r\nstatic int snd_sc6000_mixer(struct snd_wss *chip)\r\n{\r\nstruct snd_card *card = chip->card;\r\nstruct snd_ctl_elem_id id1, id2;\r\nint err;\r\nmemset(&id1, 0, sizeof(id1));\r\nmemset(&id2, 0, sizeof(id2));\r\nid1.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nid2.iface = SNDRV_CTL_ELEM_IFACE_MIXER;\r\nstrcpy(id1.name, "Aux Playback Switch");\r\nstrcpy(id2.name, "FM Playback Switch");\r\nerr = snd_ctl_rename_id(card, &id1, &id2);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(id1.name, "Aux Playback Volume");\r\nstrcpy(id2.name, "FM Playback Volume");\r\nerr = snd_ctl_rename_id(card, &id1, &id2);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(id1.name, "Aux Playback Switch"); id1.index = 1;\r\nstrcpy(id2.name, "CD Playback Switch");\r\nerr = snd_ctl_rename_id(card, &id1, &id2);\r\nif (err < 0)\r\nreturn err;\r\nstrcpy(id1.name, "Aux Playback Volume");\r\nstrcpy(id2.name, "CD Playback Volume");\r\nerr = snd_ctl_rename_id(card, &id1, &id2);\r\nif (err < 0)\r\nreturn err;\r\nreturn 0;\r\n}\r\nstatic int snd_sc6000_match(struct device *devptr, unsigned int dev)\r\n{\r\nif (!enable[dev])\r\nreturn 0;\r\nif (port[dev] == SNDRV_AUTO_PORT) {\r\nprintk(KERN_ERR PFX "specify IO port\n");\r\nreturn 0;\r\n}\r\nif (mss_port[dev] == SNDRV_AUTO_PORT) {\r\nprintk(KERN_ERR PFX "specify MSS port\n");\r\nreturn 0;\r\n}\r\nif (port[dev] != 0x220 && port[dev] != 0x240) {\r\nprintk(KERN_ERR PFX "Port must be 0x220 or 0x240\n");\r\nreturn 0;\r\n}\r\nif (mss_port[dev] != 0x530 && mss_port[dev] != 0xe80) {\r\nprintk(KERN_ERR PFX "MSS port must be 0x530 or 0xe80\n");\r\nreturn 0;\r\n}\r\nif (irq[dev] != SNDRV_AUTO_IRQ && !sc6000_irq_to_softcfg(irq[dev])) {\r\nprintk(KERN_ERR PFX "invalid IRQ %d\n", irq[dev]);\r\nreturn 0;\r\n}\r\nif (dma[dev] != SNDRV_AUTO_DMA && !sc6000_dma_to_softcfg(dma[dev])) {\r\nprintk(KERN_ERR PFX "invalid DMA %d\n", dma[dev]);\r\nreturn 0;\r\n}\r\nif (mpu_port[dev] != SNDRV_AUTO_PORT &&\r\n(mpu_port[dev] & ~0x30L) != 0x300) {\r\nprintk(KERN_ERR PFX "invalid MPU-401 port %lx\n",\r\nmpu_port[dev]);\r\nreturn 0;\r\n}\r\nif (mpu_port[dev] != SNDRV_AUTO_PORT &&\r\nmpu_irq[dev] != SNDRV_AUTO_IRQ && mpu_irq[dev] != 0 &&\r\n!sc6000_mpu_irq_to_softcfg(mpu_irq[dev])) {\r\nprintk(KERN_ERR PFX "invalid MPU-401 IRQ %d\n", mpu_irq[dev]);\r\nreturn 0;\r\n}\r\nreturn 1;\r\n}\r\nstatic int snd_sc6000_probe(struct device *devptr, unsigned int dev)\r\n{\r\nstatic int possible_irqs[] = { 5, 7, 9, 10, 11, -1 };\r\nstatic int possible_dmas[] = { 1, 3, 0, -1 };\r\nint err;\r\nint xirq = irq[dev];\r\nint xdma = dma[dev];\r\nstruct snd_card *card;\r\nstruct snd_wss *chip;\r\nstruct snd_opl3 *opl3;\r\nchar __iomem **vport;\r\nchar __iomem *vmss_port;\r\nerr = snd_card_new(devptr, index[dev], id[dev], THIS_MODULE,\r\nsizeof(vport), &card);\r\nif (err < 0)\r\nreturn err;\r\nvport = card->private_data;\r\nif (xirq == SNDRV_AUTO_IRQ) {\r\nxirq = snd_legacy_find_free_irq(possible_irqs);\r\nif (xirq < 0) {\r\nsnd_printk(KERN_ERR PFX "unable to find a free IRQ\n");\r\nerr = -EBUSY;\r\ngoto err_exit;\r\n}\r\n}\r\nif (xdma == SNDRV_AUTO_DMA) {\r\nxdma = snd_legacy_find_free_dma(possible_dmas);\r\nif (xdma < 0) {\r\nsnd_printk(KERN_ERR PFX "unable to find a free DMA\n");\r\nerr = -EBUSY;\r\ngoto err_exit;\r\n}\r\n}\r\nif (!request_region(port[dev], 0x10, DRV_NAME)) {\r\nsnd_printk(KERN_ERR PFX\r\n"I/O port region is already in use.\n");\r\nerr = -EBUSY;\r\ngoto err_exit;\r\n}\r\n*vport = devm_ioport_map(devptr, port[dev], 0x10);\r\nif (*vport == NULL) {\r\nsnd_printk(KERN_ERR PFX\r\n"I/O port cannot be iomaped.\n");\r\nerr = -EBUSY;\r\ngoto err_unmap1;\r\n}\r\nif (!request_region(mss_port[dev], 4, DRV_NAME)) {\r\nsnd_printk(KERN_ERR PFX\r\n"SC-6000 port I/O port region is already in use.\n");\r\nerr = -EBUSY;\r\ngoto err_unmap1;\r\n}\r\nvmss_port = devm_ioport_map(devptr, mss_port[dev], 4);\r\nif (!vmss_port) {\r\nsnd_printk(KERN_ERR PFX\r\n"MSS port I/O cannot be iomaped.\n");\r\nerr = -EBUSY;\r\ngoto err_unmap2;\r\n}\r\nsnd_printd("Initializing BASE[0x%lx] IRQ[%d] DMA[%d] MIRQ[%d]\n",\r\nport[dev], xirq, xdma,\r\nmpu_irq[dev] == SNDRV_AUTO_IRQ ? 0 : mpu_irq[dev]);\r\nerr = sc6000_init_board(*vport, vmss_port, dev);\r\nif (err < 0)\r\ngoto err_unmap2;\r\nerr = snd_wss_create(card, mss_port[dev] + 4, -1, xirq, xdma, -1,\r\nWSS_HW_DETECT, 0, &chip);\r\nif (err < 0)\r\ngoto err_unmap2;\r\nerr = snd_wss_pcm(chip, 0, NULL);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR PFX\r\n"error creating new WSS PCM device\n");\r\ngoto err_unmap2;\r\n}\r\nerr = snd_wss_mixer(chip);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR PFX "error creating new WSS mixer\n");\r\ngoto err_unmap2;\r\n}\r\nerr = snd_sc6000_mixer(chip);\r\nif (err < 0) {\r\nsnd_printk(KERN_ERR PFX "the mixer rewrite failed\n");\r\ngoto err_unmap2;\r\n}\r\nif (snd_opl3_create(card,\r\n0x388, 0x388 + 2,\r\nOPL3_HW_AUTO, 0, &opl3) < 0) {\r\nsnd_printk(KERN_ERR PFX "no OPL device at 0x%x-0x%x ?\n",\r\n0x388, 0x388 + 2);\r\n} else {\r\nerr = snd_opl3_hwdep_new(opl3, 0, 1, NULL);\r\nif (err < 0)\r\ngoto err_unmap2;\r\n}\r\nif (mpu_port[dev] != SNDRV_AUTO_PORT) {\r\nif (mpu_irq[dev] == SNDRV_AUTO_IRQ)\r\nmpu_irq[dev] = -1;\r\nif (snd_mpu401_uart_new(card, 0,\r\nMPU401_HW_MPU401,\r\nmpu_port[dev], 0,\r\nmpu_irq[dev], NULL) < 0)\r\nsnd_printk(KERN_ERR "no MPU-401 device at 0x%lx ?\n",\r\nmpu_port[dev]);\r\n}\r\nstrcpy(card->driver, DRV_NAME);\r\nstrcpy(card->shortname, "SC-6000");\r\nsprintf(card->longname, "Gallant SC-6000 at 0x%lx, irq %d, dma %d",\r\nmss_port[dev], xirq, xdma);\r\nerr = snd_card_register(card);\r\nif (err < 0)\r\ngoto err_unmap2;\r\ndev_set_drvdata(devptr, card);\r\nreturn 0;\r\nerr_unmap2:\r\nsc6000_setup_board(*vport, 0);\r\nrelease_region(mss_port[dev], 4);\r\nerr_unmap1:\r\nrelease_region(port[dev], 0x10);\r\nerr_exit:\r\nsnd_card_free(card);\r\nreturn err;\r\n}\r\nstatic int snd_sc6000_remove(struct device *devptr, unsigned int dev)\r\n{\r\nstruct snd_card *card = dev_get_drvdata(devptr);\r\nchar __iomem **vport = card->private_data;\r\nif (sc6000_setup_board(*vport, 0) < 0)\r\nsnd_printk(KERN_WARNING "sc6000_setup_board failed on exit!\n");\r\nrelease_region(port[dev], 0x10);\r\nrelease_region(mss_port[dev], 4);\r\nsnd_card_free(card);\r\nreturn 0;\r\n}\r\nstatic int __init alsa_card_sc6000_init(void)\r\n{\r\nreturn isa_register_driver(&snd_sc6000_driver, SNDRV_CARDS);\r\n}\r\nstatic void __exit alsa_card_sc6000_exit(void)\r\n{\r\nisa_unregister_driver(&snd_sc6000_driver);\r\n}

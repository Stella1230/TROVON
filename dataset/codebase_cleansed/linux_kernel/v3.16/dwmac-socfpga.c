static int socfpga_dwmac_parse_data(struct socfpga_dwmac *dwmac, struct device *dev)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nstruct regmap *sys_mgr_base_addr;\r\nu32 reg_offset, reg_shift;\r\nint ret;\r\ndwmac->interface = of_get_phy_mode(np);\r\nsys_mgr_base_addr = syscon_regmap_lookup_by_phandle(np, "altr,sysmgr-syscon");\r\nif (IS_ERR(sys_mgr_base_addr)) {\r\ndev_info(dev, "No sysmgr-syscon node found\n");\r\nreturn PTR_ERR(sys_mgr_base_addr);\r\n}\r\nret = of_property_read_u32_index(np, "altr,sysmgr-syscon", 1, &reg_offset);\r\nif (ret) {\r\ndev_info(dev, "Could not read reg_offset from sysmgr-syscon!\n");\r\nreturn -EINVAL;\r\n}\r\nret = of_property_read_u32_index(np, "altr,sysmgr-syscon", 2, &reg_shift);\r\nif (ret) {\r\ndev_info(dev, "Could not read reg_shift from sysmgr-syscon!\n");\r\nreturn -EINVAL;\r\n}\r\ndwmac->reg_offset = reg_offset;\r\ndwmac->reg_shift = reg_shift;\r\ndwmac->sys_mgr_base_addr = sys_mgr_base_addr;\r\ndwmac->dev = dev;\r\nreturn 0;\r\n}\r\nstatic int socfpga_dwmac_setup(struct socfpga_dwmac *dwmac)\r\n{\r\nstruct regmap *sys_mgr_base_addr = dwmac->sys_mgr_base_addr;\r\nint phymode = dwmac->interface;\r\nu32 reg_offset = dwmac->reg_offset;\r\nu32 reg_shift = dwmac->reg_shift;\r\nu32 ctrl, val;\r\nswitch (phymode) {\r\ncase PHY_INTERFACE_MODE_RGMII:\r\nval = SYSMGR_EMACGRP_CTRL_PHYSEL_ENUM_RGMII;\r\nbreak;\r\ncase PHY_INTERFACE_MODE_MII:\r\ncase PHY_INTERFACE_MODE_GMII:\r\nval = SYSMGR_EMACGRP_CTRL_PHYSEL_ENUM_GMII_MII;\r\nbreak;\r\ndefault:\r\ndev_err(dwmac->dev, "bad phy mode %d\n", phymode);\r\nreturn -EINVAL;\r\n}\r\nregmap_read(sys_mgr_base_addr, reg_offset, &ctrl);\r\nctrl &= ~(SYSMGR_EMACGRP_CTRL_PHYSEL_MASK << reg_shift);\r\nctrl |= val << reg_shift;\r\nregmap_write(sys_mgr_base_addr, reg_offset, ctrl);\r\nreturn 0;\r\n}\r\nstatic void *socfpga_dwmac_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nint ret;\r\nstruct socfpga_dwmac *dwmac;\r\ndwmac = devm_kzalloc(dev, sizeof(*dwmac), GFP_KERNEL);\r\nif (!dwmac)\r\nreturn ERR_PTR(-ENOMEM);\r\nret = socfpga_dwmac_parse_data(dwmac, dev);\r\nif (ret) {\r\ndev_err(dev, "Unable to parse OF data\n");\r\nreturn ERR_PTR(ret);\r\n}\r\nret = socfpga_dwmac_setup(dwmac);\r\nif (ret) {\r\ndev_err(dev, "couldn't setup SoC glue (%d)\n", ret);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn dwmac;\r\n}

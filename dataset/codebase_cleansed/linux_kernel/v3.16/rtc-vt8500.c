static irqreturn_t vt8500_rtc_irq(int irq, void *dev_id)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = dev_id;\r\nu32 isr;\r\nunsigned long events = 0;\r\nspin_lock(&vt8500_rtc->lock);\r\nisr = readl(vt8500_rtc->regbase + VT8500_RTC_IS);\r\nwritel(isr, vt8500_rtc->regbase + VT8500_RTC_IS);\r\nspin_unlock(&vt8500_rtc->lock);\r\nif (isr & VT8500_RTC_IS_ALARM)\r\nevents |= RTC_AF | RTC_IRQF;\r\nrtc_update_irq(vt8500_rtc->rtc, 1, events);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int vt8500_rtc_read_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = dev_get_drvdata(dev);\r\nu32 date, time;\r\ndate = readl(vt8500_rtc->regbase + VT8500_RTC_DR);\r\ntime = readl(vt8500_rtc->regbase + VT8500_RTC_TR);\r\ntm->tm_sec = bcd2bin(time & TIME_SEC_MASK);\r\ntm->tm_min = bcd2bin((time & TIME_MIN_MASK) >> TIME_MIN_S);\r\ntm->tm_hour = bcd2bin((time & TIME_HOUR_MASK) >> TIME_HOUR_S);\r\ntm->tm_mday = bcd2bin(date & DATE_DAY_MASK);\r\ntm->tm_mon = bcd2bin((date & DATE_MONTH_MASK) >> DATE_MONTH_S) - 1;\r\ntm->tm_year = bcd2bin((date & DATE_YEAR_MASK) >> DATE_YEAR_S)\r\n+ ((date >> DATE_CENTURY_S) & 1 ? 200 : 100);\r\ntm->tm_wday = (time & TIME_DOW_MASK) >> TIME_DOW_S;\r\nreturn 0;\r\n}\r\nstatic int vt8500_rtc_set_time(struct device *dev, struct rtc_time *tm)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = dev_get_drvdata(dev);\r\nif (tm->tm_year < 100) {\r\ndev_warn(dev, "Only years 2000-2199 are supported by the "\r\n"hardware!\n");\r\nreturn -EINVAL;\r\n}\r\nwritel((bin2bcd(tm->tm_year % 100) << DATE_YEAR_S)\r\n| (bin2bcd(tm->tm_mon + 1) << DATE_MONTH_S)\r\n| (bin2bcd(tm->tm_mday))\r\n| ((tm->tm_year >= 200) << DATE_CENTURY_S),\r\nvt8500_rtc->regbase + VT8500_RTC_DS);\r\nwritel((bin2bcd(tm->tm_wday) << TIME_DOW_S)\r\n| (bin2bcd(tm->tm_hour) << TIME_HOUR_S)\r\n| (bin2bcd(tm->tm_min) << TIME_MIN_S)\r\n| (bin2bcd(tm->tm_sec)),\r\nvt8500_rtc->regbase + VT8500_RTC_TS);\r\nreturn 0;\r\n}\r\nstatic int vt8500_rtc_read_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = dev_get_drvdata(dev);\r\nu32 isr, alarm;\r\nalarm = readl(vt8500_rtc->regbase + VT8500_RTC_AS);\r\nisr = readl(vt8500_rtc->regbase + VT8500_RTC_IS);\r\nalrm->time.tm_mday = bcd2bin((alarm & ALARM_DAY_MASK) >> ALARM_DAY_S);\r\nalrm->time.tm_hour = bcd2bin((alarm & TIME_HOUR_MASK) >> TIME_HOUR_S);\r\nalrm->time.tm_min = bcd2bin((alarm & TIME_MIN_MASK) >> TIME_MIN_S);\r\nalrm->time.tm_sec = bcd2bin((alarm & TIME_SEC_MASK));\r\nalrm->enabled = (alarm & ALARM_ENABLE_MASK) ? 1 : 0;\r\nalrm->pending = (isr & VT8500_RTC_IS_ALARM) ? 1 : 0;\r\nreturn rtc_valid_tm(&alrm->time);\r\n}\r\nstatic int vt8500_rtc_set_alarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = dev_get_drvdata(dev);\r\nwritel((alrm->enabled ? ALARM_ENABLE_MASK : 0)\r\n| (bin2bcd(alrm->time.tm_mday) << ALARM_DAY_S)\r\n| (bin2bcd(alrm->time.tm_hour) << TIME_HOUR_S)\r\n| (bin2bcd(alrm->time.tm_min) << TIME_MIN_S)\r\n| (bin2bcd(alrm->time.tm_sec)),\r\nvt8500_rtc->regbase + VT8500_RTC_AS);\r\nreturn 0;\r\n}\r\nstatic int vt8500_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = dev_get_drvdata(dev);\r\nunsigned long tmp = readl(vt8500_rtc->regbase + VT8500_RTC_AS);\r\nif (enabled)\r\ntmp |= ALARM_ENABLE_MASK;\r\nelse\r\ntmp &= ~ALARM_ENABLE_MASK;\r\nwritel(tmp, vt8500_rtc->regbase + VT8500_RTC_AS);\r\nreturn 0;\r\n}\r\nstatic int vt8500_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc;\r\nstruct resource *res;\r\nint ret;\r\nvt8500_rtc = devm_kzalloc(&pdev->dev,\r\nsizeof(struct vt8500_rtc), GFP_KERNEL);\r\nif (!vt8500_rtc)\r\nreturn -ENOMEM;\r\nspin_lock_init(&vt8500_rtc->lock);\r\nplatform_set_drvdata(pdev, vt8500_rtc);\r\nvt8500_rtc->irq_alarm = platform_get_irq(pdev, 0);\r\nif (vt8500_rtc->irq_alarm < 0) {\r\ndev_err(&pdev->dev, "No alarm IRQ resource defined\n");\r\nreturn vt8500_rtc->irq_alarm;\r\n}\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nvt8500_rtc->regbase = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(vt8500_rtc->regbase))\r\nreturn PTR_ERR(vt8500_rtc->regbase);\r\nwritel(VT8500_RTC_CR_ENABLE,\r\nvt8500_rtc->regbase + VT8500_RTC_CR);\r\nvt8500_rtc->rtc = devm_rtc_device_register(&pdev->dev, "vt8500-rtc",\r\n&vt8500_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(vt8500_rtc->rtc)) {\r\nret = PTR_ERR(vt8500_rtc->rtc);\r\ndev_err(&pdev->dev,\r\n"Failed to register RTC device -> %d\n", ret);\r\ngoto err_return;\r\n}\r\nret = devm_request_irq(&pdev->dev, vt8500_rtc->irq_alarm,\r\nvt8500_rtc_irq, 0, "rtc alarm", vt8500_rtc);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "can't get irq %i, err %d\n",\r\nvt8500_rtc->irq_alarm, ret);\r\ngoto err_return;\r\n}\r\nreturn 0;\r\nerr_return:\r\nreturn ret;\r\n}\r\nstatic int vt8500_rtc_remove(struct platform_device *pdev)\r\n{\r\nstruct vt8500_rtc *vt8500_rtc = platform_get_drvdata(pdev);\r\nwritel(0, vt8500_rtc->regbase + VT8500_RTC_IS);\r\nreturn 0;\r\n}

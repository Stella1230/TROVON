static struct mdp4_kms *get_kms(struct drm_plane *plane)\r\n{\r\nstruct msm_drm_private *priv = plane->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic int mdp4_plane_update(struct drm_plane *plane,\r\nstruct drm_crtc *crtc, struct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nmdp4_plane->enabled = true;\r\nif (plane->fb)\r\ndrm_framebuffer_unreference(plane->fb);\r\ndrm_framebuffer_reference(fb);\r\nreturn mdp4_plane_mode_set(plane, crtc, fb,\r\ncrtc_x, crtc_y, crtc_w, crtc_h,\r\nsrc_x, src_y, src_w, src_h);\r\n}\r\nstatic int mdp4_plane_disable(struct drm_plane *plane)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nDBG("%s: disable", mdp4_plane->name);\r\nif (plane->crtc)\r\nmdp4_crtc_detach(plane->crtc, plane);\r\nreturn 0;\r\n}\r\nstatic void mdp4_plane_destroy(struct drm_plane *plane)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nmdp4_plane_disable(plane);\r\ndrm_plane_cleanup(plane);\r\nkfree(mdp4_plane);\r\n}\r\nvoid mdp4_plane_install_properties(struct drm_plane *plane,\r\nstruct drm_mode_object *obj)\r\n{\r\n}\r\nint mdp4_plane_set_property(struct drm_plane *plane,\r\nstruct drm_property *property, uint64_t val)\r\n{\r\nreturn -EINVAL;\r\n}\r\nvoid mdp4_plane_set_scanout(struct drm_plane *plane,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nstruct mdp4_kms *mdp4_kms = get_kms(plane);\r\nenum mdp4_pipe pipe = mdp4_plane->pipe;\r\nuint32_t iova;\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_STRIDE_A(pipe),\r\nMDP4_PIPE_SRC_STRIDE_A_P0(fb->pitches[0]) |\r\nMDP4_PIPE_SRC_STRIDE_A_P1(fb->pitches[1]));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_STRIDE_B(pipe),\r\nMDP4_PIPE_SRC_STRIDE_B_P2(fb->pitches[2]) |\r\nMDP4_PIPE_SRC_STRIDE_B_P3(fb->pitches[3]));\r\nmsm_gem_get_iova(msm_framebuffer_bo(fb, 0), mdp4_kms->id, &iova);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP0_BASE(pipe), iova);\r\nplane->fb = fb;\r\n}\r\nint mdp4_plane_mode_set(struct drm_plane *plane,\r\nstruct drm_crtc *crtc, struct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nstruct mdp4_kms *mdp4_kms = get_kms(plane);\r\nenum mdp4_pipe pipe = mdp4_plane->pipe;\r\nconst struct mdp_format *format;\r\nuint32_t op_mode = 0;\r\nuint32_t phasex_step = MDP4_VG_PHASE_STEP_DEFAULT;\r\nuint32_t phasey_step = MDP4_VG_PHASE_STEP_DEFAULT;\r\nsrc_x = src_x >> 16;\r\nsrc_y = src_y >> 16;\r\nsrc_w = src_w >> 16;\r\nsrc_h = src_h >> 16;\r\nDBG("%s: FB[%u] %u,%u,%u,%u -> CRTC[%u] %d,%d,%u,%u", mdp4_plane->name,\r\nfb->base.id, src_x, src_y, src_w, src_h,\r\ncrtc->base.id, crtc_x, crtc_y, crtc_w, crtc_h);\r\nif (src_w != crtc_w) {\r\nop_mode |= MDP4_PIPE_OP_MODE_SCALEX_EN;\r\n}\r\nif (src_h != crtc_h) {\r\nop_mode |= MDP4_PIPE_OP_MODE_SCALEY_EN;\r\n}\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_SIZE(pipe),\r\nMDP4_PIPE_SRC_SIZE_WIDTH(src_w) |\r\nMDP4_PIPE_SRC_SIZE_HEIGHT(src_h));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_XY(pipe),\r\nMDP4_PIPE_SRC_XY_X(src_x) |\r\nMDP4_PIPE_SRC_XY_Y(src_y));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_DST_SIZE(pipe),\r\nMDP4_PIPE_DST_SIZE_WIDTH(crtc_w) |\r\nMDP4_PIPE_DST_SIZE_HEIGHT(crtc_h));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_DST_XY(pipe),\r\nMDP4_PIPE_DST_XY_X(crtc_x) |\r\nMDP4_PIPE_DST_XY_Y(crtc_y));\r\nmdp4_plane_set_scanout(plane, fb);\r\nformat = to_mdp_format(msm_framebuffer_format(fb));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_FORMAT(pipe),\r\nMDP4_PIPE_SRC_FORMAT_A_BPC(format->bpc_a) |\r\nMDP4_PIPE_SRC_FORMAT_R_BPC(format->bpc_r) |\r\nMDP4_PIPE_SRC_FORMAT_G_BPC(format->bpc_g) |\r\nMDP4_PIPE_SRC_FORMAT_B_BPC(format->bpc_b) |\r\nCOND(format->alpha_enable, MDP4_PIPE_SRC_FORMAT_ALPHA_ENABLE) |\r\nMDP4_PIPE_SRC_FORMAT_CPP(format->cpp - 1) |\r\nMDP4_PIPE_SRC_FORMAT_UNPACK_COUNT(format->unpack_count - 1) |\r\nCOND(format->unpack_tight, MDP4_PIPE_SRC_FORMAT_UNPACK_TIGHT));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_UNPACK(pipe),\r\nMDP4_PIPE_SRC_UNPACK_ELEM0(format->unpack[0]) |\r\nMDP4_PIPE_SRC_UNPACK_ELEM1(format->unpack[1]) |\r\nMDP4_PIPE_SRC_UNPACK_ELEM2(format->unpack[2]) |\r\nMDP4_PIPE_SRC_UNPACK_ELEM3(format->unpack[3]));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_OP_MODE(pipe), op_mode);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_PHASEX_STEP(pipe), phasex_step);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_PHASEY_STEP(pipe), phasey_step);\r\nmdp4_crtc_attach(crtc, plane);\r\nreturn 0;\r\n}\r\nenum mdp4_pipe mdp4_plane_pipe(struct drm_plane *plane)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nreturn mdp4_plane->pipe;\r\n}\r\nstruct drm_plane *mdp4_plane_init(struct drm_device *dev,\r\nenum mdp4_pipe pipe_id, bool private_plane)\r\n{\r\nstruct drm_plane *plane = NULL;\r\nstruct mdp4_plane *mdp4_plane;\r\nint ret;\r\nenum drm_plane_type type;\r\nmdp4_plane = kzalloc(sizeof(*mdp4_plane), GFP_KERNEL);\r\nif (!mdp4_plane) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nplane = &mdp4_plane->base;\r\nmdp4_plane->pipe = pipe_id;\r\nmdp4_plane->name = pipe_names[pipe_id];\r\nmdp4_plane->nformats = mdp4_get_formats(pipe_id, mdp4_plane->formats,\r\nARRAY_SIZE(mdp4_plane->formats));\r\ntype = private_plane ? DRM_PLANE_TYPE_PRIMARY : DRM_PLANE_TYPE_OVERLAY;\r\ndrm_universal_plane_init(dev, plane, 0xff, &mdp4_plane_funcs,\r\nmdp4_plane->formats, mdp4_plane->nformats,\r\ntype);\r\nmdp4_plane_install_properties(plane, &plane->base);\r\nreturn plane;\r\nfail:\r\nif (plane)\r\nmdp4_plane_destroy(plane);\r\nreturn ERR_PTR(ret);\r\n}

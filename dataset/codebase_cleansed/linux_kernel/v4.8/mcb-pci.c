static int mcb_pci_get_irq(struct mcb_device *mdev)\r\n{\r\nstruct mcb_bus *mbus = mdev->bus;\r\nstruct device *dev = mbus->carrier;\r\nstruct pci_dev *pdev = to_pci_dev(dev);\r\nreturn pdev->irq;\r\n}\r\nstatic int mcb_pci_probe(struct pci_dev *pdev, const struct pci_device_id *id)\r\n{\r\nstruct resource *res;\r\nstruct priv *priv;\r\nint ret;\r\nunsigned long flags;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(struct priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nret = pci_enable_device(pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Failed to enable PCI device\n");\r\nreturn -ENODEV;\r\n}\r\npriv->mapbase = pci_resource_start(pdev, 0);\r\nif (!priv->mapbase) {\r\ndev_err(&pdev->dev, "No PCI resource\n");\r\nret = -ENODEV;\r\ngoto out_disable;\r\n}\r\nres = devm_request_mem_region(&pdev->dev, priv->mapbase,\r\nCHAM_HEADER_SIZE,\r\nKBUILD_MODNAME);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Failed to request PCI memory\n");\r\nret = -EBUSY;\r\ngoto out_disable;\r\n}\r\npriv->base = devm_ioremap(&pdev->dev, priv->mapbase, CHAM_HEADER_SIZE);\r\nif (!priv->base) {\r\ndev_err(&pdev->dev, "Cannot ioremap\n");\r\nret = -ENOMEM;\r\ngoto out_disable;\r\n}\r\nflags = pci_resource_flags(pdev, 0);\r\nif (flags & IORESOURCE_IO) {\r\nret = -ENOTSUPP;\r\ndev_err(&pdev->dev,\r\n"IO mapped PCI devices are not supported\n");\r\ngoto out_disable;\r\n}\r\npci_set_drvdata(pdev, priv);\r\npriv->bus = mcb_alloc_bus(&pdev->dev);\r\nif (IS_ERR(priv->bus)) {\r\nret = PTR_ERR(priv->bus);\r\ngoto out_disable;\r\n}\r\npriv->bus->get_irq = mcb_pci_get_irq;\r\nret = chameleon_parse_cells(priv->bus, priv->mapbase, priv->base);\r\nif (ret < 0)\r\ngoto out_mcb_bus;\r\ndev_dbg(&pdev->dev, "Found %d cells\n", ret);\r\nmcb_bus_add_devices(priv->bus);\r\nreturn 0;\r\nout_mcb_bus:\r\nmcb_release_bus(priv->bus);\r\nout_disable:\r\npci_disable_device(pdev);\r\nreturn ret;\r\n}\r\nstatic void mcb_pci_remove(struct pci_dev *pdev)\r\n{\r\nstruct priv *priv = pci_get_drvdata(pdev);\r\nmcb_release_bus(priv->bus);\r\npci_disable_device(pdev);\r\n}

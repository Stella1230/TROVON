static bool temp_above_thresh(void __iomem *base, int thresh_idx)\r\n{\r\nwritel(CMD_READ | thresh_idx << 8, base + TEMPSI_CMD);\r\nusleep_range(10, 20);\r\nwritel(CMD_READ | thresh_idx << 8, base + TEMPSI_CMD);\r\nreturn readl(base + TEMPSI_RES);\r\n}\r\nstatic int tango_get_temp(void *arg, int *res)\r\n{\r\nstruct tango_thermal_priv *priv = arg;\r\nint idx = priv->thresh_idx;\r\nif (temp_above_thresh(priv->base, idx)) {\r\nwhile (idx < IDX_MAX && temp_above_thresh(priv->base, ++idx))\r\ncpu_relax();\r\nidx = idx - 1;\r\n} else {\r\nwhile (idx > IDX_MIN && !temp_above_thresh(priv->base, --idx))\r\ncpu_relax();\r\n}\r\n*res = (idx * 9 / 2 - 38) * 1000;\r\npriv->thresh_idx = idx;\r\nreturn 0;\r\n}\r\nstatic int tango_thermal_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct tango_thermal_priv *priv;\r\nstruct thermal_zone_device *tzdev;\r\npriv = devm_kzalloc(&pdev->dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\npriv->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(priv->base))\r\nreturn PTR_ERR(priv->base);\r\npriv->thresh_idx = IDX_MIN;\r\nwritel(0, priv->base + TEMPSI_CFG);\r\nwritel(CMD_ON, priv->base + TEMPSI_CMD);\r\ntzdev = devm_thermal_zone_of_sensor_register(&pdev->dev, 0, priv, &ops);\r\nreturn PTR_ERR_OR_ZERO(tzdev);\r\n}

static void _rtl92e_hw_sleep(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&priv->rf_ps_lock, flags);\r\nif (priv->RFChangeInProgress) {\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_DBG,\r\n"_rtl92e_hw_sleep(): RF Change in progress!\n");\r\nreturn;\r\n}\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_DBG, "%s()============>come to sleep down\n", __func__);\r\nrtl92e_set_rf_state(dev, eRfSleep, RF_CHANGE_BY_PS);\r\n}\r\nvoid rtl92e_hw_sleep_wq(void *data)\r\n{\r\nstruct rtllib_device *ieee = container_of_dwork_rsl(data,\r\nstruct rtllib_device, hw_sleep_wq);\r\nstruct net_device *dev = ieee->dev;\r\n_rtl92e_hw_sleep(dev);\r\n}\r\nvoid rtl92e_hw_wakeup(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nunsigned long flags = 0;\r\nspin_lock_irqsave(&priv->rf_ps_lock, flags);\r\nif (priv->RFChangeInProgress) {\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_DBG,\r\n"rtl92e_hw_wakeup(): RF Change in progress!\n");\r\nschedule_delayed_work(&priv->rtllib->hw_wakeup_wq,\r\nmsecs_to_jiffies(10));\r\nreturn;\r\n}\r\nspin_unlock_irqrestore(&priv->rf_ps_lock, flags);\r\nRT_TRACE(COMP_PS, "%s()============>come to wake up\n", __func__);\r\nrtl92e_set_rf_state(dev, eRfOn, RF_CHANGE_BY_PS);\r\n}\r\nvoid rtl92e_hw_wakeup_wq(void *data)\r\n{\r\nstruct rtllib_device *ieee = container_of_dwork_rsl(data,\r\nstruct rtllib_device, hw_wakeup_wq);\r\nstruct net_device *dev = ieee->dev;\r\nrtl92e_hw_wakeup(dev);\r\n}\r\nvoid rtl92e_enter_sleep(struct net_device *dev, u64 time)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nu32 tmp;\r\nunsigned long flags;\r\nunsigned long timeout;\r\nspin_lock_irqsave(&priv->ps_lock, flags);\r\ntime -= msecs_to_jiffies(8 + 16 + 7);\r\ntimeout = jiffies + msecs_to_jiffies(MIN_SLEEP_TIME);\r\nif (time_before((unsigned long)time, timeout)) {\r\nspin_unlock_irqrestore(&priv->ps_lock, flags);\r\nnetdev_info(dev, "too short to sleep::%lld < %ld\n",\r\ntime - jiffies, msecs_to_jiffies(MIN_SLEEP_TIME));\r\nreturn;\r\n}\r\ntimeout = jiffies + msecs_to_jiffies(MAX_SLEEP_TIME);\r\nif (time_after((unsigned long)time, timeout)) {\r\nnetdev_info(dev, "========>too long to sleep:%lld > %ld\n",\r\ntime - jiffies, msecs_to_jiffies(MAX_SLEEP_TIME));\r\nspin_unlock_irqrestore(&priv->ps_lock, flags);\r\nreturn;\r\n}\r\ntmp = time - jiffies;\r\nschedule_delayed_work(&priv->rtllib->hw_wakeup_wq, tmp);\r\nschedule_delayed_work(&priv->rtllib->hw_sleep_wq, 0);\r\nspin_unlock_irqrestore(&priv->ps_lock, flags);\r\n}\r\nstatic void _rtl92e_ps_update_rf_state(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nRT_TRACE(COMP_PS, "_rtl92e_ps_update_rf_state() --------->\n");\r\npPSC->bSwRfProcessing = true;\r\nRT_TRACE(COMP_PS, "_rtl92e_ps_update_rf_state(): Set RF to %s.\n",\r\npPSC->eInactivePowerState == eRfOff ? "OFF" : "ON");\r\nrtl92e_set_rf_state(dev, pPSC->eInactivePowerState, RF_CHANGE_BY_IPS);\r\npPSC->bSwRfProcessing = false;\r\nRT_TRACE(COMP_PS, "_rtl92e_ps_update_rf_state() <---------\n");\r\n}\r\nvoid rtl92e_ips_enter(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nenum rt_rf_power_state rtState;\r\nif (pPSC->bInactivePs) {\r\nrtState = priv->rtllib->eRFPowerState;\r\nif (rtState == eRfOn && !pPSC->bSwRfProcessing &&\r\n(priv->rtllib->state != RTLLIB_LINKED) &&\r\n(priv->rtllib->iw_mode != IW_MODE_MASTER)) {\r\nRT_TRACE(COMP_PS, "rtl92e_ips_enter(): Turn off RF.\n");\r\npPSC->eInactivePowerState = eRfOff;\r\npriv->isRFOff = true;\r\npriv->bInPowerSaveMode = true;\r\n_rtl92e_ps_update_rf_state(dev);\r\n}\r\n}\r\n}\r\nvoid rtl92e_ips_leave(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nenum rt_rf_power_state rtState;\r\nif (pPSC->bInactivePs) {\r\nrtState = priv->rtllib->eRFPowerState;\r\nif (rtState != eRfOn && !pPSC->bSwRfProcessing &&\r\npriv->rtllib->RfOffReason <= RF_CHANGE_BY_IPS) {\r\nRT_TRACE(COMP_PS, "rtl92e_ips_leave(): Turn on RF.\n");\r\npPSC->eInactivePowerState = eRfOn;\r\npriv->bInPowerSaveMode = false;\r\n_rtl92e_ps_update_rf_state(dev);\r\n}\r\n}\r\n}\r\nvoid rtl92e_ips_leave_wq(void *data)\r\n{\r\nstruct rtllib_device *ieee = container_of_work_rsl(data,\r\nstruct rtllib_device, ips_leave_wq);\r\nstruct net_device *dev = ieee->dev;\r\nstruct r8192_priv *priv = (struct r8192_priv *)rtllib_priv(dev);\r\ndown(&priv->rtllib->ips_sem);\r\nrtl92e_ips_leave(dev);\r\nup(&priv->rtllib->ips_sem);\r\n}\r\nvoid rtl92e_rtllib_ips_leave_wq(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = (struct r8192_priv *)rtllib_priv(dev);\r\nenum rt_rf_power_state rtState;\r\nrtState = priv->rtllib->eRFPowerState;\r\nif (priv->rtllib->PowerSaveControl.bInactivePs) {\r\nif (rtState == eRfOff) {\r\nif (priv->rtllib->RfOffReason > RF_CHANGE_BY_IPS) {\r\nnetdev_warn(dev, "%s(): RF is OFF.\n",\r\n__func__);\r\nreturn;\r\n}\r\nnetdev_info(dev, "=========>%s(): rtl92e_ips_leave\n",\r\n__func__);\r\nschedule_work(&priv->rtllib->ips_leave_wq);\r\n}\r\n}\r\n}\r\nvoid rtl92e_rtllib_ips_leave(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = (struct r8192_priv *)rtllib_priv(dev);\r\ndown(&priv->rtllib->ips_sem);\r\nrtl92e_ips_leave(dev);\r\nup(&priv->rtllib->ips_sem);\r\n}\r\nstatic bool _rtl92e_ps_set_mode(struct net_device *dev, u8 rtPsMode)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nif (priv->rtllib->iw_mode == IW_MODE_ADHOC)\r\nreturn false;\r\nRT_TRACE(COMP_LPS, "%s(): set ieee->ps = %x\n", __func__, rtPsMode);\r\nif (!priv->ps_force)\r\npriv->rtllib->ps = rtPsMode;\r\nif (priv->rtllib->sta_sleep != LPS_IS_WAKE &&\r\nrtPsMode == RTLLIB_PS_DISABLED) {\r\nunsigned long flags;\r\nrtl92e_hw_wakeup(dev);\r\npriv->rtllib->sta_sleep = LPS_IS_WAKE;\r\nspin_lock_irqsave(&(priv->rtllib->mgmt_tx_lock), flags);\r\nRT_TRACE(COMP_DBG,\r\n"LPS leave: notify AP we are awaked ++++++++++ SendNullFunctionData\n");\r\nrtllib_sta_ps_send_null_frame(priv->rtllib, 0);\r\nspin_unlock_irqrestore(&(priv->rtllib->mgmt_tx_lock), flags);\r\n}\r\nreturn true;\r\n}\r\nvoid rtl92e_leisure_ps_enter(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nRT_TRACE(COMP_PS, "rtl92e_leisure_ps_enter()...\n");\r\nRT_TRACE(COMP_PS,\r\n"pPSC->bLeisurePs = %d, ieee->ps = %d,pPSC->LpsIdleCount is %d,RT_CHECK_FOR_HANG_PERIOD is %d\n",\r\npPSC->bLeisurePs, priv->rtllib->ps, pPSC->LpsIdleCount,\r\nRT_CHECK_FOR_HANG_PERIOD);\r\nif (!((priv->rtllib->iw_mode == IW_MODE_INFRA) &&\r\n(priv->rtllib->state == RTLLIB_LINKED))\r\n|| (priv->rtllib->iw_mode == IW_MODE_ADHOC) ||\r\n(priv->rtllib->iw_mode == IW_MODE_MASTER))\r\nreturn;\r\nif (pPSC->bLeisurePs) {\r\nif (pPSC->LpsIdleCount >= RT_CHECK_FOR_HANG_PERIOD) {\r\nif (priv->rtllib->ps == RTLLIB_PS_DISABLED) {\r\nRT_TRACE(COMP_LPS,\r\n"rtl92e_leisure_ps_enter(): Enter 802.11 power save mode...\n");\r\nif (!pPSC->bFwCtrlLPS) {\r\nif (priv->rtllib->SetFwCmdHandler)\r\npriv->rtllib->SetFwCmdHandler(\r\ndev, FW_CMD_LPS_ENTER);\r\n}\r\n_rtl92e_ps_set_mode(dev, RTLLIB_PS_MBCAST |\r\nRTLLIB_PS_UNICAST);\r\n}\r\n} else\r\npPSC->LpsIdleCount++;\r\n}\r\n}\r\nvoid rtl92e_leisure_ps_leave(struct net_device *dev)\r\n{\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nstruct rt_pwr_save_ctrl *pPSC = (struct rt_pwr_save_ctrl *)\r\n&(priv->rtllib->PowerSaveControl);\r\nRT_TRACE(COMP_PS, "rtl92e_leisure_ps_leave()...\n");\r\nRT_TRACE(COMP_PS, "pPSC->bLeisurePs = %d, ieee->ps = %d\n",\r\npPSC->bLeisurePs, priv->rtllib->ps);\r\nif (pPSC->bLeisurePs) {\r\nif (priv->rtllib->ps != RTLLIB_PS_DISABLED) {\r\nRT_TRACE(COMP_LPS,\r\n"rtl92e_leisure_ps_leave(): Busy Traffic , Leave 802.11 power save..\n");\r\n_rtl92e_ps_set_mode(dev, RTLLIB_PS_DISABLED);\r\nif (!pPSC->bFwCtrlLPS) {\r\nif (priv->rtllib->SetFwCmdHandler)\r\npriv->rtllib->SetFwCmdHandler(dev,\r\nFW_CMD_LPS_LEAVE);\r\n}\r\n}\r\n}\r\n}

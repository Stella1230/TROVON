static int micro_leds_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness value)\r\n{\r\nstruct ipaq_micro *micro = dev_get_drvdata(led_cdev->dev->parent->parent);\r\nstruct ipaq_micro_msg msg = {\r\n.id = MSG_NOTIFY_LED,\r\n.tx_len = 4,\r\n};\r\nmsg.tx_data[0] = LED_GREEN;\r\nmsg.tx_data[1] = 0;\r\nif (value) {\r\nmsg.tx_data[2] = 0;\r\nmsg.tx_data[3] = 1;\r\n} else {\r\nmsg.tx_data[2] = 1;\r\nmsg.tx_data[3] = 0;\r\n}\r\nreturn ipaq_micro_tx_msg_sync(micro, &msg);\r\n}\r\nstatic int micro_leds_blink_set(struct led_classdev *led_cdev,\r\nunsigned long *delay_on,\r\nunsigned long *delay_off)\r\n{\r\nstruct ipaq_micro *micro = dev_get_drvdata(led_cdev->dev->parent->parent);\r\nstruct ipaq_micro_msg msg = {\r\n.id = MSG_NOTIFY_LED,\r\n.tx_len = 4,\r\n};\r\nmsg.tx_data[0] = LED_GREEN;\r\nif (*delay_on > IPAQ_LED_MAX_DUTY ||\r\n*delay_off > IPAQ_LED_MAX_DUTY)\r\nreturn -EINVAL;\r\nif (*delay_on == 0 && *delay_off == 0) {\r\n*delay_on = 100;\r\n*delay_off = 100;\r\n}\r\nmsg.tx_data[1] = 0;\r\nif (*delay_on >= IPAQ_LED_MAX_DUTY)\r\nmsg.tx_data[2] = 0;\r\nelse\r\nmsg.tx_data[2] = (u8) DIV_ROUND_CLOSEST(*delay_on, 100);\r\nif (*delay_off >= IPAQ_LED_MAX_DUTY)\r\nmsg.tx_data[3] = 0;\r\nelse\r\nmsg.tx_data[3] = (u8) DIV_ROUND_CLOSEST(*delay_off, 100);\r\nreturn ipaq_micro_tx_msg_sync(micro, &msg);\r\n}\r\nstatic int micro_leds_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nret = devm_led_classdev_register(&pdev->dev, &micro_led);\r\nif (ret) {\r\ndev_err(&pdev->dev, "registering led failed: %d\n", ret);\r\nreturn ret;\r\n}\r\ndev_info(&pdev->dev, "iPAQ micro notification LED driver\n");\r\nreturn 0;\r\n}

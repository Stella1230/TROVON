static inline void bb_set(u32 __iomem *p, u32 m)\r\n{\r\nout_be32(p, in_be32(p) | m);\r\n}\r\nstatic inline void bb_clr(u32 __iomem *p, u32 m)\r\n{\r\nout_be32(p, in_be32(p) & ~m);\r\n}\r\nstatic inline int bb_read(u32 __iomem *p, u32 m)\r\n{\r\nreturn (in_be32(p) & m) != 0;\r\n}\r\nstatic inline void mdio_dir(struct mdiobb_ctrl *ctrl, int dir)\r\n{\r\nstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\r\nif (dir)\r\nbb_set(bitbang->dir, bitbang->mdio_msk);\r\nelse\r\nbb_clr(bitbang->dir, bitbang->mdio_msk);\r\nin_be32(bitbang->dir);\r\n}\r\nstatic inline int mdio_read(struct mdiobb_ctrl *ctrl)\r\n{\r\nstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\r\nreturn bb_read(bitbang->dat, bitbang->mdio_msk);\r\n}\r\nstatic inline void mdio(struct mdiobb_ctrl *ctrl, int what)\r\n{\r\nstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\r\nif (what)\r\nbb_set(bitbang->dat, bitbang->mdio_msk);\r\nelse\r\nbb_clr(bitbang->dat, bitbang->mdio_msk);\r\nin_be32(bitbang->dat);\r\n}\r\nstatic inline void mdc(struct mdiobb_ctrl *ctrl, int what)\r\n{\r\nstruct bb_info *bitbang = container_of(ctrl, struct bb_info, ctrl);\r\nif (what)\r\nbb_set(bitbang->dat, bitbang->mdc_msk);\r\nelse\r\nbb_clr(bitbang->dat, bitbang->mdc_msk);\r\nin_be32(bitbang->dat);\r\n}\r\nstatic int fs_mii_bitbang_init(struct mii_bus *bus, struct device_node *np)\r\n{\r\nstruct resource res;\r\nconst u32 *data;\r\nint mdio_pin, mdc_pin, len;\r\nstruct bb_info *bitbang = bus->priv;\r\nint ret = of_address_to_resource(np, 0, &res);\r\nif (ret)\r\nreturn ret;\r\nif (resource_size(&res) <= 13)\r\nreturn -ENODEV;\r\nsnprintf(bus->id, MII_BUS_ID_SIZE, "%x", res.start);\r\ndata = of_get_property(np, "fsl,mdio-pin", &len);\r\nif (!data || len != 4)\r\nreturn -ENODEV;\r\nmdio_pin = *data;\r\ndata = of_get_property(np, "fsl,mdc-pin", &len);\r\nif (!data || len != 4)\r\nreturn -ENODEV;\r\nmdc_pin = *data;\r\nbitbang->dir = ioremap(res.start, resource_size(&res));\r\nif (!bitbang->dir)\r\nreturn -ENOMEM;\r\nbitbang->dat = bitbang->dir + 4;\r\nbitbang->mdio_msk = 1 << (31 - mdio_pin);\r\nbitbang->mdc_msk = 1 << (31 - mdc_pin);\r\nreturn 0;\r\n}\r\nstatic int fs_enet_mdio_probe(struct platform_device *ofdev)\r\n{\r\nstruct mii_bus *new_bus;\r\nstruct bb_info *bitbang;\r\nint ret = -ENOMEM;\r\nbitbang = kzalloc(sizeof(struct bb_info), GFP_KERNEL);\r\nif (!bitbang)\r\ngoto out;\r\nbitbang->ctrl.ops = &bb_ops;\r\nnew_bus = alloc_mdio_bitbang(&bitbang->ctrl);\r\nif (!new_bus)\r\ngoto out_free_priv;\r\nnew_bus->name = "CPM2 Bitbanged MII",\r\nret = fs_mii_bitbang_init(new_bus, ofdev->dev.of_node);\r\nif (ret)\r\ngoto out_free_bus;\r\nnew_bus->phy_mask = ~0;\r\nnew_bus->parent = &ofdev->dev;\r\nplatform_set_drvdata(ofdev, new_bus);\r\nret = of_mdiobus_register(new_bus, ofdev->dev.of_node);\r\nif (ret)\r\ngoto out_unmap_regs;\r\nreturn 0;\r\nout_unmap_regs:\r\niounmap(bitbang->dir);\r\nout_free_bus:\r\nfree_mdio_bitbang(new_bus);\r\nout_free_priv:\r\nkfree(bitbang);\r\nout:\r\nreturn ret;\r\n}\r\nstatic int fs_enet_mdio_remove(struct platform_device *ofdev)\r\n{\r\nstruct mii_bus *bus = platform_get_drvdata(ofdev);\r\nstruct bb_info *bitbang = bus->priv;\r\nmdiobus_unregister(bus);\r\nfree_mdio_bitbang(bus);\r\niounmap(bitbang->dir);\r\nkfree(bitbang);\r\nreturn 0;\r\n}

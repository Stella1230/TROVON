static u32 find_nvram_size(void __iomem *end)\r\n{\r\nstruct nvram_header __iomem *header;\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(nvram_sizes); i++) {\r\nheader = (struct nvram_header *)(end - nvram_sizes[i]);\r\nif (header->magic == NVRAM_MAGIC)\r\nreturn nvram_sizes[i];\r\n}\r\nreturn 0;\r\n}\r\nstatic int nvram_find_and_copy(void __iomem *iobase, u32 lim)\r\n{\r\nstruct nvram_header __iomem *header;\r\nu32 off;\r\nu32 size;\r\nif (nvram_len) {\r\npr_warn("nvram already initialized\n");\r\nreturn -EEXIST;\r\n}\r\noff = FLASH_MIN;\r\nwhile (off <= lim) {\r\nsize = find_nvram_size(iobase + off);\r\nif (size) {\r\nheader = (struct nvram_header *)(iobase + off - size);\r\ngoto found;\r\n}\r\noff <<= 1;\r\n}\r\nheader = (struct nvram_header *)(iobase + 4096);\r\nif (header->magic == NVRAM_MAGIC) {\r\nsize = NVRAM_SPACE;\r\ngoto found;\r\n}\r\nheader = (struct nvram_header *)(iobase + 1024);\r\nif (header->magic == NVRAM_MAGIC) {\r\nsize = NVRAM_SPACE;\r\ngoto found;\r\n}\r\npr_err("no nvram found\n");\r\nreturn -ENXIO;\r\nfound:\r\n__ioread32_copy(nvram_buf, header, sizeof(*header) / 4);\r\nnvram_len = ((struct nvram_header *)(nvram_buf))->len;\r\nif (nvram_len > size) {\r\npr_err("The nvram size according to the header seems to be bigger than the partition on flash\n");\r\nnvram_len = size;\r\n}\r\nif (nvram_len >= NVRAM_SPACE) {\r\npr_err("nvram on flash (%i bytes) is bigger than the reserved space in memory, will just copy the first %i bytes\n",\r\nnvram_len, NVRAM_SPACE - 1);\r\nnvram_len = NVRAM_SPACE - 1;\r\n}\r\n__ioread32_copy(nvram_buf + sizeof(*header), header + 1,\r\nDIV_ROUND_UP(nvram_len, 4));\r\nnvram_buf[NVRAM_SPACE - 1] = '\0';\r\nreturn 0;\r\n}\r\nint bcm47xx_nvram_init_from_mem(u32 base, u32 lim)\r\n{\r\nvoid __iomem *iobase;\r\nint err;\r\niobase = ioremap_nocache(base, lim);\r\nif (!iobase)\r\nreturn -ENOMEM;\r\nerr = nvram_find_and_copy(iobase, lim);\r\niounmap(iobase);\r\nreturn err;\r\n}\r\nstatic int nvram_init(void)\r\n{\r\n#ifdef CONFIG_MTD\r\nstruct mtd_info *mtd;\r\nstruct nvram_header header;\r\nsize_t bytes_read;\r\nint err;\r\nmtd = get_mtd_device_nm("nvram");\r\nif (IS_ERR(mtd))\r\nreturn -ENODEV;\r\nerr = mtd_read(mtd, 0, sizeof(header), &bytes_read, (uint8_t *)&header);\r\nif (!err && header.magic == NVRAM_MAGIC &&\r\nheader.len > sizeof(header)) {\r\nnvram_len = header.len;\r\nif (nvram_len >= NVRAM_SPACE) {\r\npr_err("nvram on flash (%i bytes) is bigger than the reserved space in memory, will just copy the first %i bytes\n",\r\nheader.len, NVRAM_SPACE);\r\nnvram_len = NVRAM_SPACE - 1;\r\n}\r\nerr = mtd_read(mtd, 0, nvram_len, &nvram_len,\r\n(u8 *)nvram_buf);\r\nreturn err;\r\n}\r\n#endif\r\nreturn -ENXIO;\r\n}\r\nint bcm47xx_nvram_getenv(const char *name, char *val, size_t val_len)\r\n{\r\nchar *var, *value, *end, *eq;\r\nint err;\r\nif (!name)\r\nreturn -EINVAL;\r\nif (!nvram_len) {\r\nerr = nvram_init();\r\nif (err)\r\nreturn err;\r\n}\r\nvar = &nvram_buf[sizeof(struct nvram_header)];\r\nend = nvram_buf + sizeof(nvram_buf);\r\nwhile (var < end && *var) {\r\neq = strchr(var, '=');\r\nif (!eq)\r\nbreak;\r\nvalue = eq + 1;\r\nif (eq - var == strlen(name) &&\r\nstrncmp(var, name, eq - var) == 0)\r\nreturn snprintf(val, val_len, "%s", value);\r\nvar = value + strlen(value) + 1;\r\n}\r\nreturn -ENOENT;\r\n}\r\nint bcm47xx_nvram_gpio_pin(const char *name)\r\n{\r\nint i, err;\r\nchar nvram_var[] = "gpioXX";\r\nchar buf[NVRAM_MAX_GPIO_VALUE_LEN];\r\nfor (i = 0; i < NVRAM_MAX_GPIO_ENTRIES; i++) {\r\nerr = snprintf(nvram_var, sizeof(nvram_var), "gpio%i", i);\r\nif (err <= 0)\r\ncontinue;\r\nerr = bcm47xx_nvram_getenv(nvram_var, buf, sizeof(buf));\r\nif (err <= 0)\r\ncontinue;\r\nif (!strcmp(name, buf))\r\nreturn i;\r\n}\r\nreturn -ENOENT;\r\n}\r\nchar *bcm47xx_nvram_get_contents(size_t *nvram_size)\r\n{\r\nint err;\r\nchar *nvram;\r\nif (!nvram_len) {\r\nerr = nvram_init();\r\nif (err)\r\nreturn NULL;\r\n}\r\n*nvram_size = nvram_len - sizeof(struct nvram_header);\r\nnvram = vmalloc(*nvram_size);\r\nif (!nvram)\r\nreturn NULL;\r\nmemcpy(nvram, &nvram_buf[sizeof(struct nvram_header)], *nvram_size);\r\nreturn nvram;\r\n}

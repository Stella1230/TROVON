struct omap_dss_device *omap_encoder_get_dssdev(struct drm_encoder *encoder)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nreturn omap_encoder->dssdev;\r\n}\r\nstatic void omap_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(omap_encoder);\r\n}\r\nstatic void omap_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nstruct omap_dss_device *dssdev = omap_encoder->dssdev;\r\nstruct drm_connector *connector;\r\nbool hdmi_mode;\r\nint r;\r\nhdmi_mode = false;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head) {\r\nif (connector->encoder == encoder) {\r\nhdmi_mode = omap_connector_get_hdmi_mode(connector);\r\nbreak;\r\n}\r\n}\r\nif (dssdev->driver->set_hdmi_mode)\r\ndssdev->driver->set_hdmi_mode(dssdev, hdmi_mode);\r\nif (hdmi_mode && dssdev->driver->set_hdmi_infoframe) {\r\nstruct hdmi_avi_infoframe avi;\r\nr = drm_hdmi_avi_infoframe_from_display_mode(&avi, adjusted_mode);\r\nif (r == 0)\r\ndssdev->driver->set_hdmi_infoframe(dssdev, &avi);\r\n}\r\n}\r\nstatic void omap_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nstruct omap_dss_device *dssdev = omap_encoder->dssdev;\r\nstruct omap_dss_driver *dssdrv = dssdev->driver;\r\ndssdrv->disable(dssdev);\r\n}\r\nstatic int omap_encoder_update(struct drm_encoder *encoder,\r\nenum omap_channel channel,\r\nstruct omap_video_timings *timings)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nstruct omap_dss_device *dssdev = omap_encoder->dssdev;\r\nstruct omap_dss_driver *dssdrv = dssdev->driver;\r\nint ret;\r\nif (dssdrv->check_timings) {\r\nret = dssdrv->check_timings(dssdev, timings);\r\n} else {\r\nstruct omap_video_timings t = {0};\r\ndssdrv->get_timings(dssdev, &t);\r\nif (memcmp(timings, &t, sizeof(struct omap_video_timings)))\r\nret = -EINVAL;\r\nelse\r\nret = 0;\r\n}\r\nif (ret) {\r\ndev_err(dev->dev, "could not set timings: %d\n", ret);\r\nreturn ret;\r\n}\r\nif (dssdrv->set_timings)\r\ndssdrv->set_timings(dssdev, timings);\r\nreturn 0;\r\n}\r\nstatic void omap_encoder_enable(struct drm_encoder *encoder)\r\n{\r\nstruct omap_encoder *omap_encoder = to_omap_encoder(encoder);\r\nstruct omap_dss_device *dssdev = omap_encoder->dssdev;\r\nstruct omap_dss_driver *dssdrv = dssdev->driver;\r\nint r;\r\nomap_encoder_update(encoder, omap_crtc_channel(encoder->crtc),\r\nomap_crtc_timings(encoder->crtc));\r\nr = dssdrv->enable(dssdev);\r\nif (r)\r\ndev_err(encoder->dev->dev,\r\n"Failed to enable display '%s': %d\n",\r\ndssdev->name, r);\r\n}\r\nstatic int omap_encoder_atomic_check(struct drm_encoder *encoder,\r\nstruct drm_crtc_state *crtc_state,\r\nstruct drm_connector_state *conn_state)\r\n{\r\nreturn 0;\r\n}\r\nstruct drm_encoder *omap_encoder_init(struct drm_device *dev,\r\nstruct omap_dss_device *dssdev)\r\n{\r\nstruct drm_encoder *encoder = NULL;\r\nstruct omap_encoder *omap_encoder;\r\nomap_encoder = kzalloc(sizeof(*omap_encoder), GFP_KERNEL);\r\nif (!omap_encoder)\r\ngoto fail;\r\nomap_encoder->dssdev = dssdev;\r\nencoder = &omap_encoder->base;\r\ndrm_encoder_init(dev, encoder, &omap_encoder_funcs,\r\nDRM_MODE_ENCODER_TMDS, NULL);\r\ndrm_encoder_helper_add(encoder, &omap_encoder_helper_funcs);\r\nreturn encoder;\r\nfail:\r\nif (encoder)\r\nomap_encoder_destroy(encoder);\r\nreturn NULL;\r\n}

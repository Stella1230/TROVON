static int vmw_gmr2_bind(struct vmw_private *dev_priv,\r\nstruct vmw_piter *iter,\r\nunsigned long num_pages,\r\nint gmr_id)\r\n{\r\nSVGAFifoCmdDefineGMR2 define_cmd;\r\nSVGAFifoCmdRemapGMR2 remap_cmd;\r\nuint32_t *cmd;\r\nuint32_t *cmd_orig;\r\nuint32_t define_size = sizeof(define_cmd) + sizeof(*cmd);\r\nuint32_t remap_num = num_pages / VMW_PPN_PER_REMAP + ((num_pages % VMW_PPN_PER_REMAP) > 0);\r\nuint32_t remap_size = VMW_PPN_SIZE * num_pages + (sizeof(remap_cmd) + sizeof(*cmd)) * remap_num;\r\nuint32_t remap_pos = 0;\r\nuint32_t cmd_size = define_size + remap_size;\r\nuint32_t i;\r\ncmd_orig = cmd = vmw_fifo_reserve(dev_priv, cmd_size);\r\nif (unlikely(cmd == NULL))\r\nreturn -ENOMEM;\r\ndefine_cmd.gmrId = gmr_id;\r\ndefine_cmd.numPages = num_pages;\r\n*cmd++ = SVGA_CMD_DEFINE_GMR2;\r\nmemcpy(cmd, &define_cmd, sizeof(define_cmd));\r\ncmd += sizeof(define_cmd) / sizeof(*cmd);\r\nremap_cmd.gmrId = gmr_id;\r\nremap_cmd.flags = (VMW_PPN_SIZE > sizeof(*cmd)) ?\r\nSVGA_REMAP_GMR2_PPN64 : SVGA_REMAP_GMR2_PPN32;\r\nwhile (num_pages > 0) {\r\nunsigned long nr = min(num_pages, (unsigned long)VMW_PPN_PER_REMAP);\r\nremap_cmd.offsetPages = remap_pos;\r\nremap_cmd.numPages = nr;\r\n*cmd++ = SVGA_CMD_REMAP_GMR2;\r\nmemcpy(cmd, &remap_cmd, sizeof(remap_cmd));\r\ncmd += sizeof(remap_cmd) / sizeof(*cmd);\r\nfor (i = 0; i < nr; ++i) {\r\nif (VMW_PPN_SIZE <= 4)\r\n*cmd = vmw_piter_dma_addr(iter) >> PAGE_SHIFT;\r\nelse\r\n*((uint64_t *)cmd) = vmw_piter_dma_addr(iter) >>\r\nPAGE_SHIFT;\r\ncmd += VMW_PPN_SIZE / sizeof(*cmd);\r\nvmw_piter_next(iter);\r\n}\r\nnum_pages -= nr;\r\nremap_pos += nr;\r\n}\r\nBUG_ON(cmd != cmd_orig + cmd_size / sizeof(*cmd));\r\nvmw_fifo_commit(dev_priv, cmd_size);\r\nreturn 0;\r\n}\r\nstatic void vmw_gmr2_unbind(struct vmw_private *dev_priv,\r\nint gmr_id)\r\n{\r\nSVGAFifoCmdDefineGMR2 define_cmd;\r\nuint32_t define_size = sizeof(define_cmd) + 4;\r\nuint32_t *cmd;\r\ncmd = vmw_fifo_reserve(dev_priv, define_size);\r\nif (unlikely(cmd == NULL)) {\r\nDRM_ERROR("GMR2 unbind failed.\n");\r\nreturn;\r\n}\r\ndefine_cmd.gmrId = gmr_id;\r\ndefine_cmd.numPages = 0;\r\n*cmd++ = SVGA_CMD_DEFINE_GMR2;\r\nmemcpy(cmd, &define_cmd, sizeof(define_cmd));\r\nvmw_fifo_commit(dev_priv, define_size);\r\n}\r\nint vmw_gmr_bind(struct vmw_private *dev_priv,\r\nconst struct vmw_sg_table *vsgt,\r\nunsigned long num_pages,\r\nint gmr_id)\r\n{\r\nstruct vmw_piter data_iter;\r\nvmw_piter_start(&data_iter, vsgt, 0);\r\nif (unlikely(!vmw_piter_next(&data_iter)))\r\nreturn 0;\r\nif (unlikely(!(dev_priv->capabilities & SVGA_CAP_GMR2)))\r\nreturn -EINVAL;\r\nreturn vmw_gmr2_bind(dev_priv, &data_iter, num_pages, gmr_id);\r\n}\r\nvoid vmw_gmr_unbind(struct vmw_private *dev_priv, int gmr_id)\r\n{\r\nif (likely(dev_priv->capabilities & SVGA_CAP_GMR2))\r\nvmw_gmr2_unbind(dev_priv, gmr_id);\r\n}

static void wm8994_edge_irq_enable(struct irq_data *data)\r\n{\r\n}\r\nstatic void wm8994_edge_irq_disable(struct irq_data *data)\r\n{\r\n}\r\nstatic irqreturn_t wm8994_edge_irq(int irq, void *data)\r\n{\r\nstruct wm8994 *wm8994 = data;\r\nwhile (gpio_get_value_cansleep(wm8994->pdata.irq_gpio))\r\nhandle_nested_irq(irq_create_mapping(wm8994->edge_irq, 0));\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int wm8994_edge_irq_map(struct irq_domain *h, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nstruct wm8994 *wm8994 = h->host_data;\r\nirq_set_chip_data(virq, wm8994);\r\nirq_set_chip_and_handler(virq, &wm8994_edge_irq_chip, handle_edge_irq);\r\nirq_set_nested_thread(virq, 1);\r\nirq_set_noprobe(virq);\r\nreturn 0;\r\n}\r\nint wm8994_irq_init(struct wm8994 *wm8994)\r\n{\r\nint ret;\r\nunsigned long irqflags;\r\nstruct wm8994_pdata *pdata = &wm8994->pdata;\r\nif (!wm8994->irq) {\r\ndev_warn(wm8994->dev,\r\n"No interrupt specified, no interrupts\n");\r\nwm8994->irq_base = 0;\r\nreturn 0;\r\n}\r\nirqflags = IRQF_TRIGGER_HIGH | IRQF_ONESHOT;\r\nif (pdata->irq_flags)\r\nirqflags = pdata->irq_flags;\r\nif (irqflags & (IRQF_TRIGGER_RISING | IRQF_TRIGGER_FALLING)) {\r\nif (gpio_to_irq(pdata->irq_gpio) != wm8994->irq) {\r\ndev_warn(wm8994->dev, "IRQ %d is not GPIO %d (%d)\n",\r\nwm8994->irq, pdata->irq_gpio,\r\ngpio_to_irq(pdata->irq_gpio));\r\nwm8994->irq = gpio_to_irq(pdata->irq_gpio);\r\n}\r\nret = devm_gpio_request_one(wm8994->dev, pdata->irq_gpio,\r\nGPIOF_IN, "WM8994 IRQ");\r\nif (ret != 0) {\r\ndev_err(wm8994->dev, "Failed to get IRQ GPIO: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nwm8994->edge_irq = irq_domain_add_linear(NULL, 1,\r\n&wm8994_edge_irq_ops,\r\nwm8994);\r\nret = regmap_add_irq_chip(wm8994->regmap,\r\nirq_create_mapping(wm8994->edge_irq,\r\n0),\r\nIRQF_ONESHOT,\r\nwm8994->irq_base, &wm8994_irq_chip,\r\n&wm8994->irq_data);\r\nif (ret != 0) {\r\ndev_err(wm8994->dev, "Failed to get IRQ: %d\n",\r\nret);\r\nreturn ret;\r\n}\r\nret = request_threaded_irq(wm8994->irq,\r\nNULL, wm8994_edge_irq,\r\nirqflags,\r\n"WM8994 edge", wm8994);\r\n} else {\r\nret = regmap_add_irq_chip(wm8994->regmap, wm8994->irq,\r\nirqflags,\r\nwm8994->irq_base, &wm8994_irq_chip,\r\n&wm8994->irq_data);\r\n}\r\nif (ret != 0) {\r\ndev_err(wm8994->dev, "Failed to register IRQ chip: %d\n", ret);\r\nreturn ret;\r\n}\r\nwm8994_reg_write(wm8994, WM8994_INTERRUPT_CONTROL, 0);\r\nreturn 0;\r\n}\r\nvoid wm8994_irq_exit(struct wm8994 *wm8994)\r\n{\r\nregmap_del_irq_chip(wm8994->irq, wm8994->irq_data);\r\n}

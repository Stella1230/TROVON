static int sha256_init(struct shash_desc *desc)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA256_H0;\r\nsctx->state[1] = SHA256_H1;\r\nsctx->state[2] = SHA256_H2;\r\nsctx->state[3] = SHA256_H3;\r\nsctx->state[4] = SHA256_H4;\r\nsctx->state[5] = SHA256_H5;\r\nsctx->state[6] = SHA256_H6;\r\nsctx->state[7] = SHA256_H7;\r\nsctx->count = 0;\r\nsctx->func = CPACF_KIMD_SHA_256;\r\nreturn 0;\r\n}\r\nstatic int sha256_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nstruct sha256_state *octx = out;\r\noctx->count = sctx->count;\r\nmemcpy(octx->state, sctx->state, sizeof(octx->state));\r\nmemcpy(octx->buf, sctx->buf, sizeof(octx->buf));\r\nreturn 0;\r\n}\r\nstatic int sha256_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nconst struct sha256_state *ictx = in;\r\nsctx->count = ictx->count;\r\nmemcpy(sctx->state, ictx->state, sizeof(ictx->state));\r\nmemcpy(sctx->buf, ictx->buf, sizeof(ictx->buf));\r\nsctx->func = CPACF_KIMD_SHA_256;\r\nreturn 0;\r\n}\r\nstatic int sha224_init(struct shash_desc *desc)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA224_H0;\r\nsctx->state[1] = SHA224_H1;\r\nsctx->state[2] = SHA224_H2;\r\nsctx->state[3] = SHA224_H3;\r\nsctx->state[4] = SHA224_H4;\r\nsctx->state[5] = SHA224_H5;\r\nsctx->state[6] = SHA224_H6;\r\nsctx->state[7] = SHA224_H7;\r\nsctx->count = 0;\r\nsctx->func = CPACF_KIMD_SHA_256;\r\nreturn 0;\r\n}\r\nstatic int __init sha256_s390_init(void)\r\n{\r\nint ret;\r\nif (!cpacf_query(CPACF_KIMD, CPACF_KIMD_SHA_256))\r\nreturn -EOPNOTSUPP;\r\nret = crypto_register_shash(&sha256_alg);\r\nif (ret < 0)\r\ngoto out;\r\nret = crypto_register_shash(&sha224_alg);\r\nif (ret < 0)\r\ncrypto_unregister_shash(&sha256_alg);\r\nout:\r\nreturn ret;\r\n}\r\nstatic void __exit sha256_s390_fini(void)\r\n{\r\ncrypto_unregister_shash(&sha224_alg);\r\ncrypto_unregister_shash(&sha256_alg);\r\n}

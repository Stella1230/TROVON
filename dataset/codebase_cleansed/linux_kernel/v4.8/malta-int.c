static inline int mips_pcibios_iack(void)\r\n{\r\nint irq;\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nMSC_READ(MSC01_PCI_IACK, irq);\r\nirq &= 0xff;\r\nbreak;\r\ncase MIPS_REVISION_SCON_GT64120:\r\nirq = GT_READ(GT_PCI0_IACK_OFS);\r\nirq &= 0xff;\r\nbreak;\r\ncase MIPS_REVISION_SCON_BONITO:\r\nBONITO_PCIMAP_CFG = 0x20000;\r\n(void) BONITO_PCIMAP_CFG;\r\niob();\r\nirq = __raw_readl((u32 *)_pcictrl_bonito_pcicfg);\r\niob();\r\nirq &= 0xff;\r\nBONITO_PCIMAP_CFG = 0;\r\nbreak;\r\ndefault:\r\npr_emerg("Unknown system controller.\n");\r\nreturn -1;\r\n}\r\nreturn irq;\r\n}\r\nstatic inline int get_int(void)\r\n{\r\nunsigned long flags;\r\nint irq;\r\nraw_spin_lock_irqsave(&mips_irq_lock, flags);\r\nirq = mips_pcibios_iack();\r\nraw_spin_unlock_irqrestore(&mips_irq_lock, flags);\r\nreturn irq;\r\n}\r\nstatic void malta_hw0_irqdispatch(void)\r\n{\r\nint irq;\r\nirq = get_int();\r\nif (irq < 0) {\r\nreturn;\r\n}\r\ndo_IRQ(MALTA_INT_BASE + irq);\r\n#ifdef CONFIG_MIPS_VPE_APSP_API_MT\r\nif (aprp_hook)\r\naprp_hook();\r\n#endif\r\n}\r\nstatic irqreturn_t i8259_handler(int irq, void *dev_id)\r\n{\r\nmalta_hw0_irqdispatch();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void corehi_irqdispatch(void)\r\n{\r\nunsigned int intedge, intsteer, pcicmd, pcibadaddr;\r\nunsigned int pcimstat, intisr, inten, intpol;\r\nunsigned int intrcause, datalo, datahi;\r\nstruct pt_regs *regs = get_irq_regs();\r\npr_emerg("CoreHI interrupt, shouldn't happen, we die here!\n");\r\npr_emerg("epc : %08lx\nStatus: %08lx\n"\r\n"Cause : %08lx\nbadVaddr : %08lx\n",\r\nregs->cp0_epc, regs->cp0_status,\r\nregs->cp0_cause, regs->cp0_badvaddr);\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nll_msc_irq();\r\nbreak;\r\ncase MIPS_REVISION_SCON_GT64120:\r\nintrcause = GT_READ(GT_INTRCAUSE_OFS);\r\ndatalo = GT_READ(GT_CPUERR_ADDRLO_OFS);\r\ndatahi = GT_READ(GT_CPUERR_ADDRHI_OFS);\r\npr_emerg("GT_INTRCAUSE = %08x\n", intrcause);\r\npr_emerg("GT_CPUERR_ADDR = %02x%08x\n",\r\ndatahi, datalo);\r\nbreak;\r\ncase MIPS_REVISION_SCON_BONITO:\r\npcibadaddr = BONITO_PCIBADADDR;\r\npcimstat = BONITO_PCIMSTAT;\r\nintisr = BONITO_INTISR;\r\ninten = BONITO_INTEN;\r\nintpol = BONITO_INTPOL;\r\nintedge = BONITO_INTEDGE;\r\nintsteer = BONITO_INTSTEER;\r\npcicmd = BONITO_PCICMD;\r\npr_emerg("BONITO_INTISR = %08x\n", intisr);\r\npr_emerg("BONITO_INTEN = %08x\n", inten);\r\npr_emerg("BONITO_INTPOL = %08x\n", intpol);\r\npr_emerg("BONITO_INTEDGE = %08x\n", intedge);\r\npr_emerg("BONITO_INTSTEER = %08x\n", intsteer);\r\npr_emerg("BONITO_PCICMD = %08x\n", pcicmd);\r\npr_emerg("BONITO_PCIBADADDR = %08x\n", pcibadaddr);\r\npr_emerg("BONITO_PCIMSTAT = %08x\n", pcimstat);\r\nbreak;\r\n}\r\ndie("CoreHi interrupt", regs);\r\n}\r\nstatic irqreturn_t corehi_handler(int irq, void *dev_id)\r\n{\r\ncorehi_irqdispatch();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic void ipi_resched_dispatch(void)\r\n{\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + MIPS_CPU_IPI_RESCHED_IRQ);\r\n}\r\nstatic void ipi_call_dispatch(void)\r\n{\r\ndo_IRQ(MIPS_CPU_IRQ_BASE + MIPS_CPU_IPI_CALL_IRQ);\r\n}\r\nstatic irqreturn_t ipi_resched_interrupt(int irq, void *dev_id)\r\n{\r\n#ifdef CONFIG_MIPS_VPE_APSP_API_CMP\r\nif (aprp_hook)\r\naprp_hook();\r\n#endif\r\nscheduler_ipi();\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic irqreturn_t ipi_call_interrupt(int irq, void *dev_id)\r\n{\r\ngeneric_smp_call_function_interrupt();\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid __init arch_init_ipiirq(int irq, struct irqaction *action)\r\n{\r\nsetup_irq(irq, action);\r\nirq_set_handler(irq, handle_percpu_irq);\r\n}\r\nvoid __init arch_init_irq(void)\r\n{\r\nint corehi_irq, i8259_irq;\r\ninit_i8259_irqs();\r\nif (!cpu_has_veic)\r\nmips_cpu_irq_init();\r\nif (mips_cm_present()) {\r\nwrite_gcr_gic_base(GIC_BASE_ADDR | CM_GCR_GIC_BASE_GICEN_MSK);\r\ngic_present = 1;\r\n} else {\r\nif (mips_revision_sconid == MIPS_REVISION_SCON_ROCIT) {\r\n_msc01_biu_base = ioremap_nocache(MSC01_BIU_REG_BASE,\r\nMSC01_BIU_ADDRSPACE_SZ);\r\ngic_present =\r\n(__raw_readl(_msc01_biu_base + MSC01_SC_CFG_OFS) &\r\nMSC01_SC_CFG_GICPRES_MSK) >>\r\nMSC01_SC_CFG_GICPRES_SHF;\r\n}\r\n}\r\nif (gic_present)\r\npr_debug("GIC present\n");\r\nswitch (mips_revision_sconid) {\r\ncase MIPS_REVISION_SCON_SOCIT:\r\ncase MIPS_REVISION_SCON_ROCIT:\r\nif (cpu_has_veic)\r\ninit_msc_irqs(MIPS_MSC01_IC_REG_BASE,\r\nMSC01E_INT_BASE, msc_eicirqmap,\r\nmsc_nr_eicirqs);\r\nelse\r\ninit_msc_irqs(MIPS_MSC01_IC_REG_BASE,\r\nMSC01C_INT_BASE, msc_irqmap,\r\nmsc_nr_irqs);\r\nbreak;\r\ncase MIPS_REVISION_SCON_SOCITSC:\r\ncase MIPS_REVISION_SCON_SOCITSCP:\r\nif (cpu_has_veic)\r\ninit_msc_irqs(MIPS_SOCITSC_IC_REG_BASE,\r\nMSC01E_INT_BASE, msc_eicirqmap,\r\nmsc_nr_eicirqs);\r\nelse\r\ninit_msc_irqs(MIPS_SOCITSC_IC_REG_BASE,\r\nMSC01C_INT_BASE, msc_irqmap,\r\nmsc_nr_irqs);\r\n}\r\nif (gic_present) {\r\nint i;\r\ngic_init(GIC_BASE_ADDR, GIC_ADDRSPACE_SZ, MIPSCPU_INT_GIC,\r\nMIPS_GIC_IRQ_BASE);\r\nif (!mips_cm_present()) {\r\ni = __raw_readl(_msc01_biu_base + MSC01_SC_CFG_OFS);\r\n__raw_writel(i | (0x1 << MSC01_SC_CFG_GICENA_SHF),\r\n_msc01_biu_base + MSC01_SC_CFG_OFS);\r\npr_debug("GIC Enabled\n");\r\n}\r\ni8259_irq = MIPS_GIC_IRQ_BASE + GIC_INT_I8259A;\r\ncorehi_irq = MIPS_CPU_IRQ_BASE + MIPSCPU_INT_COREHI;\r\n} else {\r\n#if defined(CONFIG_MIPS_MT_SMP)\r\nif (cpu_has_veic) {\r\nset_vi_handler (MSC01E_INT_SW0, ipi_resched_dispatch);\r\nset_vi_handler (MSC01E_INT_SW1, ipi_call_dispatch);\r\ncpu_ipi_resched_irq = MSC01E_INT_SW0;\r\ncpu_ipi_call_irq = MSC01E_INT_SW1;\r\n} else {\r\ncpu_ipi_resched_irq = MIPS_CPU_IRQ_BASE +\r\nMIPS_CPU_IPI_RESCHED_IRQ;\r\ncpu_ipi_call_irq = MIPS_CPU_IRQ_BASE +\r\nMIPS_CPU_IPI_CALL_IRQ;\r\n}\r\narch_init_ipiirq(cpu_ipi_resched_irq, &irq_resched);\r\narch_init_ipiirq(cpu_ipi_call_irq, &irq_call);\r\n#endif\r\nif (cpu_has_veic) {\r\nset_vi_handler(MSC01E_INT_I8259A,\r\nmalta_hw0_irqdispatch);\r\nset_vi_handler(MSC01E_INT_COREHI,\r\ncorehi_irqdispatch);\r\ni8259_irq = MSC01E_INT_BASE + MSC01E_INT_I8259A;\r\ncorehi_irq = MSC01E_INT_BASE + MSC01E_INT_COREHI;\r\n} else {\r\ni8259_irq = MIPS_CPU_IRQ_BASE + MIPSCPU_INT_I8259A;\r\ncorehi_irq = MIPS_CPU_IRQ_BASE + MIPSCPU_INT_COREHI;\r\n}\r\n}\r\nsetup_irq(i8259_irq, &i8259irq);\r\nsetup_irq(corehi_irq, &corehi_irqaction);\r\n}\r\nvoid malta_be_init(void)\r\n{\r\n}\r\nint malta_be_handler(struct pt_regs *regs, int is_fixup)\r\n{\r\nint retval = is_fixup ? MIPS_BE_FIXUP : MIPS_BE_FATAL;\r\nmips_cm_error_report();\r\nreturn retval;\r\n}

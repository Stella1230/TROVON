static struct clk * __init\r\nr8a7778_cpg_register_clock(struct device_node *np, struct r8a7778_cpg *cpg,\r\nconst char *name)\r\n{\r\nif (!strcmp(name, "plla")) {\r\nreturn clk_register_fixed_factor(NULL, "plla",\r\nof_clk_get_parent_name(np, 0), 0,\r\nr8a7778_rates[cpg_mode_rates].plla_mult, 1);\r\n} else if (!strcmp(name, "pllb")) {\r\nreturn clk_register_fixed_factor(NULL, "pllb",\r\nof_clk_get_parent_name(np, 0), 0,\r\nr8a7778_rates[cpg_mode_rates].pllb_mult, 1);\r\n} else {\r\nunsigned int i;\r\nfor (i = 0; i < ARRAY_SIZE(r8a7778_divs); i++) {\r\nif (!strcmp(name, r8a7778_divs[i].name)) {\r\nreturn clk_register_fixed_factor(NULL,\r\nr8a7778_divs[i].name,\r\n"plla", 0, 1,\r\nr8a7778_divs[i].div[cpg_mode_divs]);\r\n}\r\n}\r\n}\r\nreturn ERR_PTR(-EINVAL);\r\n}\r\nstatic void __init r8a7778_cpg_clocks_init(struct device_node *np)\r\n{\r\nstruct r8a7778_cpg *cpg;\r\nstruct clk **clks;\r\nunsigned int i;\r\nint num_clks;\r\nnum_clks = of_property_count_strings(np, "clock-output-names");\r\nif (num_clks < 0) {\r\npr_err("%s: failed to count clocks\n", __func__);\r\nreturn;\r\n}\r\ncpg = kzalloc(sizeof(*cpg), GFP_KERNEL);\r\nclks = kcalloc(num_clks, sizeof(*clks), GFP_KERNEL);\r\nif (cpg == NULL || clks == NULL) {\r\nreturn;\r\n}\r\nspin_lock_init(&cpg->lock);\r\ncpg->data.clks = clks;\r\ncpg->data.clk_num = num_clks;\r\ncpg->reg = of_iomap(np, 0);\r\nif (WARN_ON(cpg->reg == NULL))\r\nreturn;\r\nfor (i = 0; i < num_clks; ++i) {\r\nconst char *name;\r\nstruct clk *clk;\r\nof_property_read_string_index(np, "clock-output-names", i,\r\n&name);\r\nclk = r8a7778_cpg_register_clock(np, cpg, name);\r\nif (IS_ERR(clk))\r\npr_err("%s: failed to register %s %s clock (%ld)\n",\r\n__func__, np->name, name, PTR_ERR(clk));\r\nelse\r\ncpg->data.clks[i] = clk;\r\n}\r\nof_clk_add_provider(np, of_clk_src_onecell_get, &cpg->data);\r\ncpg_mstp_add_clk_domain(np);\r\n}\r\nvoid __init r8a7778_clocks_init(u32 mode)\r\n{\r\nBUG_ON(!(mode & BIT(19)));\r\ncpg_mode_rates = (!!(mode & BIT(18)) << 2) |\r\n(!!(mode & BIT(12)) << 1) |\r\n(!!(mode & BIT(11)));\r\ncpg_mode_divs = (!!(mode & BIT(2)) << 1) |\r\n(!!(mode & BIT(1)));\r\nof_clk_init(NULL);\r\n}

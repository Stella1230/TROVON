const char *cu_find_realpath(Dwarf_Die *cu_die, const char *fname)\r\n{\r\nDwarf_Files *files;\r\nsize_t nfiles, i;\r\nconst char *src = NULL;\r\nint ret;\r\nif (!fname)\r\nreturn NULL;\r\nret = dwarf_getsrcfiles(cu_die, &files, &nfiles);\r\nif (ret != 0)\r\nreturn NULL;\r\nfor (i = 0; i < nfiles; i++) {\r\nsrc = dwarf_filesrc(files, i, NULL, NULL);\r\nif (strtailcmp(src, fname) == 0)\r\nbreak;\r\n}\r\nif (i == nfiles)\r\nreturn NULL;\r\nreturn src;\r\n}\r\nconst char *cu_get_comp_dir(Dwarf_Die *cu_die)\r\n{\r\nDwarf_Attribute attr;\r\nif (dwarf_attr(cu_die, DW_AT_comp_dir, &attr) == NULL)\r\nreturn NULL;\r\nreturn dwarf_formstring(&attr);\r\n}\r\nint cu_find_lineinfo(Dwarf_Die *cu_die, unsigned long addr,\r\nconst char **fname, int *lineno)\r\n{\r\nDwarf_Line *line;\r\nDwarf_Addr laddr;\r\nline = dwarf_getsrc_die(cu_die, (Dwarf_Addr)addr);\r\nif (line && dwarf_lineaddr(line, &laddr) == 0 &&\r\naddr == (unsigned long)laddr && dwarf_lineno(line, lineno) == 0) {\r\n*fname = dwarf_linesrc(line, NULL, NULL);\r\nif (!*fname)\r\n*lineno = 0;\r\n}\r\nreturn *lineno ?: -ENOENT;\r\n}\r\nint cu_walk_functions_at(Dwarf_Die *cu_die, Dwarf_Addr addr,\r\nint (*callback)(Dwarf_Die *, void *), void *data)\r\n{\r\nDwarf_Die die_mem;\r\nDwarf_Die *sc_die;\r\nint ret = -ENOENT;\r\nfor (sc_die = die_find_realfunc(cu_die, addr, &die_mem);\r\nsc_die != NULL;\r\nsc_die = die_find_child(sc_die, __die_find_inline_cb, &addr,\r\n&die_mem)) {\r\nret = callback(sc_die, data);\r\nif (ret)\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nbool die_compare_name(Dwarf_Die *dw_die, const char *tname)\r\n{\r\nconst char *name;\r\nname = dwarf_diename(dw_die);\r\nreturn name ? (strcmp(tname, name) == 0) : false;\r\n}\r\nbool die_match_name(Dwarf_Die *dw_die, const char *glob)\r\n{\r\nconst char *name;\r\nname = dwarf_diename(dw_die);\r\nreturn name ? strglobmatch(name, glob) : false;\r\n}\r\nint die_get_call_lineno(Dwarf_Die *in_die)\r\n{\r\nDwarf_Attribute attr;\r\nDwarf_Word ret;\r\nif (!dwarf_attr(in_die, DW_AT_call_line, &attr))\r\nreturn -ENOENT;\r\ndwarf_formudata(&attr, &ret);\r\nreturn (int)ret;\r\n}\r\nDwarf_Die *die_get_type(Dwarf_Die *vr_die, Dwarf_Die *die_mem)\r\n{\r\nDwarf_Attribute attr;\r\nif (dwarf_attr_integrate(vr_die, DW_AT_type, &attr) &&\r\ndwarf_formref_die(&attr, die_mem))\r\nreturn die_mem;\r\nelse\r\nreturn NULL;\r\n}\r\nstatic Dwarf_Die *__die_get_real_type(Dwarf_Die *vr_die, Dwarf_Die *die_mem)\r\n{\r\nint tag;\r\ndo {\r\nvr_die = die_get_type(vr_die, die_mem);\r\nif (!vr_die)\r\nbreak;\r\ntag = dwarf_tag(vr_die);\r\n} while (tag == DW_TAG_const_type ||\r\ntag == DW_TAG_restrict_type ||\r\ntag == DW_TAG_volatile_type ||\r\ntag == DW_TAG_shared_type);\r\nreturn vr_die;\r\n}\r\nDwarf_Die *die_get_real_type(Dwarf_Die *vr_die, Dwarf_Die *die_mem)\r\n{\r\ndo {\r\nvr_die = __die_get_real_type(vr_die, die_mem);\r\n} while (vr_die && dwarf_tag(vr_die) == DW_TAG_typedef);\r\nreturn vr_die;\r\n}\r\nstatic int die_get_attr_udata(Dwarf_Die *tp_die, unsigned int attr_name,\r\nDwarf_Word *result)\r\n{\r\nDwarf_Attribute attr;\r\nif (dwarf_attr(tp_die, attr_name, &attr) == NULL ||\r\ndwarf_formudata(&attr, result) != 0)\r\nreturn -ENOENT;\r\nreturn 0;\r\n}\r\nstatic int die_get_attr_sdata(Dwarf_Die *tp_die, unsigned int attr_name,\r\nDwarf_Sword *result)\r\n{\r\nDwarf_Attribute attr;\r\nif (dwarf_attr(tp_die, attr_name, &attr) == NULL ||\r\ndwarf_formsdata(&attr, result) != 0)\r\nreturn -ENOENT;\r\nreturn 0;\r\n}\r\nbool die_is_signed_type(Dwarf_Die *tp_die)\r\n{\r\nDwarf_Word ret;\r\nif (die_get_attr_udata(tp_die, DW_AT_encoding, &ret))\r\nreturn false;\r\nreturn (ret == DW_ATE_signed_char || ret == DW_ATE_signed ||\r\nret == DW_ATE_signed_fixed);\r\n}\r\nbool die_is_func_def(Dwarf_Die *dw_die)\r\n{\r\nDwarf_Attribute attr;\r\nreturn (dwarf_tag(dw_die) == DW_TAG_subprogram &&\r\ndwarf_attr(dw_die, DW_AT_declaration, &attr) == NULL);\r\n}\r\nbool die_is_func_instance(Dwarf_Die *dw_die)\r\n{\r\nDwarf_Addr tmp;\r\nreturn !dwarf_func_inline(dw_die) && dwarf_entrypc(dw_die, &tmp) == 0;\r\n}\r\nint die_get_data_member_location(Dwarf_Die *mb_die, Dwarf_Word *offs)\r\n{\r\nDwarf_Attribute attr;\r\nDwarf_Op *expr;\r\nsize_t nexpr;\r\nint ret;\r\nif (dwarf_attr(mb_die, DW_AT_data_member_location, &attr) == NULL)\r\nreturn -ENOENT;\r\nif (dwarf_formudata(&attr, offs) != 0) {\r\nret = dwarf_getlocation(&attr, &expr, &nexpr);\r\nif (ret < 0 || nexpr == 0)\r\nreturn -ENOENT;\r\nif (expr[0].atom != DW_OP_plus_uconst || nexpr != 1) {\r\npr_debug("Unable to get offset:Unexpected OP %x (%zd)\n",\r\nexpr[0].atom, nexpr);\r\nreturn -ENOTSUP;\r\n}\r\n*offs = (Dwarf_Word)expr[0].number;\r\n}\r\nreturn 0;\r\n}\r\nstatic int die_get_call_fileno(Dwarf_Die *in_die)\r\n{\r\nDwarf_Sword idx;\r\nif (die_get_attr_sdata(in_die, DW_AT_call_file, &idx) == 0)\r\nreturn (int)idx;\r\nelse\r\nreturn -ENOENT;\r\n}\r\nstatic int die_get_decl_fileno(Dwarf_Die *pdie)\r\n{\r\nDwarf_Sword idx;\r\nif (die_get_attr_sdata(pdie, DW_AT_decl_file, &idx) == 0)\r\nreturn (int)idx;\r\nelse\r\nreturn -ENOENT;\r\n}\r\nconst char *die_get_call_file(Dwarf_Die *in_die)\r\n{\r\nDwarf_Die cu_die;\r\nDwarf_Files *files;\r\nint idx;\r\nidx = die_get_call_fileno(in_die);\r\nif (idx < 0 || !dwarf_diecu(in_die, &cu_die, NULL, NULL) ||\r\ndwarf_getsrcfiles(&cu_die, &files, NULL) != 0)\r\nreturn NULL;\r\nreturn dwarf_filesrc(files, idx, NULL, NULL);\r\n}\r\nDwarf_Die *die_find_child(Dwarf_Die *rt_die,\r\nint (*callback)(Dwarf_Die *, void *),\r\nvoid *data, Dwarf_Die *die_mem)\r\n{\r\nDwarf_Die child_die;\r\nint ret;\r\nret = dwarf_child(rt_die, die_mem);\r\nif (ret != 0)\r\nreturn NULL;\r\ndo {\r\nret = callback(die_mem, data);\r\nif (ret == DIE_FIND_CB_END)\r\nreturn die_mem;\r\nif ((ret & DIE_FIND_CB_CHILD) &&\r\ndie_find_child(die_mem, callback, data, &child_die)) {\r\nmemcpy(die_mem, &child_die, sizeof(Dwarf_Die));\r\nreturn die_mem;\r\n}\r\n} while ((ret & DIE_FIND_CB_SIBLING) &&\r\ndwarf_siblingof(die_mem, die_mem) == 0);\r\nreturn NULL;\r\n}\r\nstatic int __die_search_func_tail_cb(Dwarf_Die *fn_die, void *data)\r\n{\r\nstruct __addr_die_search_param *ad = data;\r\nDwarf_Addr addr = 0;\r\nif (dwarf_tag(fn_die) == DW_TAG_subprogram &&\r\n!dwarf_highpc(fn_die, &addr) &&\r\naddr == ad->addr) {\r\nmemcpy(ad->die_mem, fn_die, sizeof(Dwarf_Die));\r\nreturn DWARF_CB_ABORT;\r\n}\r\nreturn DWARF_CB_OK;\r\n}\r\nDwarf_Die *die_find_tailfunc(Dwarf_Die *cu_die, Dwarf_Addr addr,\r\nDwarf_Die *die_mem)\r\n{\r\nstruct __addr_die_search_param ad;\r\nad.addr = addr;\r\nad.die_mem = die_mem;\r\nif (!dwarf_getfuncs(cu_die, __die_search_func_tail_cb, &ad, 0))\r\nreturn NULL;\r\nelse\r\nreturn die_mem;\r\n}\r\nstatic int __die_search_func_cb(Dwarf_Die *fn_die, void *data)\r\n{\r\nstruct __addr_die_search_param *ad = data;\r\nif (dwarf_tag(fn_die) == DW_TAG_subprogram &&\r\ndwarf_haspc(fn_die, ad->addr)) {\r\nmemcpy(ad->die_mem, fn_die, sizeof(Dwarf_Die));\r\nreturn DWARF_CB_ABORT;\r\n}\r\nreturn DWARF_CB_OK;\r\n}\r\nDwarf_Die *die_find_realfunc(Dwarf_Die *cu_die, Dwarf_Addr addr,\r\nDwarf_Die *die_mem)\r\n{\r\nstruct __addr_die_search_param ad;\r\nad.addr = addr;\r\nad.die_mem = die_mem;\r\nif (!dwarf_getfuncs(cu_die, __die_search_func_cb, &ad, 0))\r\nreturn NULL;\r\nelse\r\nreturn die_mem;\r\n}\r\nstatic int __die_find_inline_cb(Dwarf_Die *die_mem, void *data)\r\n{\r\nDwarf_Addr *addr = data;\r\nif (dwarf_tag(die_mem) == DW_TAG_inlined_subroutine &&\r\ndwarf_haspc(die_mem, *addr))\r\nreturn DIE_FIND_CB_END;\r\nreturn DIE_FIND_CB_CONTINUE;\r\n}\r\nDwarf_Die *die_find_top_inlinefunc(Dwarf_Die *sp_die, Dwarf_Addr addr,\r\nDwarf_Die *die_mem)\r\n{\r\nreturn die_find_child(sp_die, __die_find_inline_cb, &addr, die_mem);\r\n}\r\nDwarf_Die *die_find_inlinefunc(Dwarf_Die *sp_die, Dwarf_Addr addr,\r\nDwarf_Die *die_mem)\r\n{\r\nDwarf_Die tmp_die;\r\nsp_die = die_find_child(sp_die, __die_find_inline_cb, &addr, &tmp_die);\r\nif (!sp_die)\r\nreturn NULL;\r\nwhile (sp_die) {\r\nmemcpy(die_mem, sp_die, sizeof(Dwarf_Die));\r\nsp_die = die_find_child(sp_die, __die_find_inline_cb, &addr,\r\n&tmp_die);\r\n}\r\nreturn die_mem;\r\n}\r\nstatic int __die_walk_instances_cb(Dwarf_Die *inst, void *data)\r\n{\r\nstruct __instance_walk_param *iwp = data;\r\nDwarf_Attribute attr_mem;\r\nDwarf_Die origin_mem;\r\nDwarf_Attribute *attr;\r\nDwarf_Die *origin;\r\nint tmp;\r\nattr = dwarf_attr(inst, DW_AT_abstract_origin, &attr_mem);\r\nif (attr == NULL)\r\nreturn DIE_FIND_CB_CONTINUE;\r\norigin = dwarf_formref_die(attr, &origin_mem);\r\nif (origin == NULL || origin->addr != iwp->addr)\r\nreturn DIE_FIND_CB_CONTINUE;\r\nif (dwarf_tag(inst) == DW_TAG_inlined_subroutine) {\r\ndwarf_decl_line(origin, &tmp);\r\nif (die_get_call_lineno(inst) == tmp) {\r\ntmp = die_get_decl_fileno(origin);\r\nif (die_get_call_fileno(inst) == tmp)\r\nreturn DIE_FIND_CB_CONTINUE;\r\n}\r\n}\r\niwp->retval = iwp->callback(inst, iwp->data);\r\nreturn (iwp->retval) ? DIE_FIND_CB_END : DIE_FIND_CB_CONTINUE;\r\n}\r\nint die_walk_instances(Dwarf_Die *or_die, int (*callback)(Dwarf_Die *, void *),\r\nvoid *data)\r\n{\r\nDwarf_Die cu_die;\r\nDwarf_Die die_mem;\r\nstruct __instance_walk_param iwp = {\r\n.addr = or_die->addr,\r\n.callback = callback,\r\n.data = data,\r\n.retval = -ENOENT,\r\n};\r\nif (dwarf_diecu(or_die, &cu_die, NULL, NULL) == NULL)\r\nreturn -ENOENT;\r\ndie_find_child(&cu_die, __die_walk_instances_cb, &iwp, &die_mem);\r\nreturn iwp.retval;\r\n}\r\nstatic int __die_walk_funclines_cb(Dwarf_Die *in_die, void *data)\r\n{\r\nstruct __line_walk_param *lw = data;\r\nDwarf_Addr addr = 0;\r\nconst char *fname;\r\nint lineno;\r\nif (dwarf_tag(in_die) == DW_TAG_inlined_subroutine) {\r\nfname = die_get_call_file(in_die);\r\nlineno = die_get_call_lineno(in_die);\r\nif (fname && lineno > 0 && dwarf_entrypc(in_die, &addr) == 0) {\r\nlw->retval = lw->callback(fname, lineno, addr, lw->data);\r\nif (lw->retval != 0)\r\nreturn DIE_FIND_CB_END;\r\n}\r\n}\r\nif (!lw->recursive)\r\nreturn DIE_FIND_CB_SIBLING;\r\nif (addr) {\r\nfname = dwarf_decl_file(in_die);\r\nif (fname && dwarf_decl_line(in_die, &lineno) == 0) {\r\nlw->retval = lw->callback(fname, lineno, addr, lw->data);\r\nif (lw->retval != 0)\r\nreturn DIE_FIND_CB_END;\r\n}\r\n}\r\nreturn DIE_FIND_CB_CONTINUE;\r\n}\r\nstatic int __die_walk_funclines(Dwarf_Die *sp_die, bool recursive,\r\nline_walk_callback_t callback, void *data)\r\n{\r\nstruct __line_walk_param lw = {\r\n.recursive = recursive,\r\n.callback = callback,\r\n.data = data,\r\n.retval = 0,\r\n};\r\nDwarf_Die die_mem;\r\nDwarf_Addr addr;\r\nconst char *fname;\r\nint lineno;\r\nfname = dwarf_decl_file(sp_die);\r\nif (fname && dwarf_decl_line(sp_die, &lineno) == 0 &&\r\ndwarf_entrypc(sp_die, &addr) == 0) {\r\nlw.retval = callback(fname, lineno, addr, data);\r\nif (lw.retval != 0)\r\ngoto done;\r\n}\r\ndie_find_child(sp_die, __die_walk_funclines_cb, &lw, &die_mem);\r\ndone:\r\nreturn lw.retval;\r\n}\r\nstatic int __die_walk_culines_cb(Dwarf_Die *sp_die, void *data)\r\n{\r\nstruct __line_walk_param *lw = data;\r\nlw->retval = __die_walk_funclines(sp_die, true, lw->callback, lw->data);\r\nif (lw->retval != 0)\r\nreturn DWARF_CB_ABORT;\r\nreturn DWARF_CB_OK;\r\n}\r\nint die_walk_lines(Dwarf_Die *rt_die, line_walk_callback_t callback, void *data)\r\n{\r\nDwarf_Lines *lines;\r\nDwarf_Line *line;\r\nDwarf_Addr addr;\r\nconst char *fname, *decf = NULL;\r\nint lineno, ret = 0;\r\nint decl = 0, inl;\r\nDwarf_Die die_mem, *cu_die;\r\nsize_t nlines, i;\r\nif (dwarf_tag(rt_die) != DW_TAG_compile_unit) {\r\ncu_die = dwarf_diecu(rt_die, &die_mem, NULL, NULL);\r\ndwarf_decl_line(rt_die, &decl);\r\ndecf = dwarf_decl_file(rt_die);\r\n} else\r\ncu_die = rt_die;\r\nif (!cu_die) {\r\npr_debug2("Failed to get CU from given DIE.\n");\r\nreturn -EINVAL;\r\n}\r\nif (dwarf_getsrclines(cu_die, &lines, &nlines) != 0) {\r\npr_debug2("Failed to get source lines on this CU.\n");\r\nreturn -ENOENT;\r\n}\r\npr_debug2("Get %zd lines from this CU\n", nlines);\r\nfor (i = 0; i < nlines; i++) {\r\nline = dwarf_onesrcline(lines, i);\r\nif (line == NULL ||\r\ndwarf_lineno(line, &lineno) != 0 ||\r\ndwarf_lineaddr(line, &addr) != 0) {\r\npr_debug2("Failed to get line info. "\r\n"Possible error in debuginfo.\n");\r\ncontinue;\r\n}\r\nif (rt_die != cu_die) {\r\nif (!dwarf_haspc(rt_die, addr))\r\ncontinue;\r\nif (die_find_inlinefunc(rt_die, addr, &die_mem)) {\r\ndwarf_decl_line(&die_mem, &inl);\r\nif (inl != decl ||\r\ndecf != dwarf_decl_file(&die_mem))\r\ncontinue;\r\n}\r\n}\r\nfname = dwarf_linesrc(line, NULL, NULL);\r\nret = callback(fname, lineno, addr, data);\r\nif (ret != 0)\r\nreturn ret;\r\n}\r\nif (rt_die != cu_die)\r\nret = __die_walk_funclines(rt_die, false, callback, data);\r\nelse {\r\nstruct __line_walk_param param = {\r\n.callback = callback,\r\n.data = data,\r\n.retval = 0,\r\n};\r\ndwarf_getfuncs(cu_die, __die_walk_culines_cb, &param, 0);\r\nret = param.retval;\r\n}\r\nreturn ret;\r\n}\r\nstatic int __die_find_variable_cb(Dwarf_Die *die_mem, void *data)\r\n{\r\nstruct __find_variable_param *fvp = data;\r\nDwarf_Attribute attr;\r\nint tag;\r\ntag = dwarf_tag(die_mem);\r\nif ((tag == DW_TAG_formal_parameter ||\r\ntag == DW_TAG_variable) &&\r\ndie_compare_name(die_mem, fvp->name) &&\r\n(dwarf_attr(die_mem, DW_AT_external, &attr) ||\r\ndwarf_attr(die_mem, DW_AT_location, &attr)))\r\nreturn DIE_FIND_CB_END;\r\nif (dwarf_haspc(die_mem, fvp->addr))\r\nreturn DIE_FIND_CB_CONTINUE;\r\nelse\r\nreturn DIE_FIND_CB_SIBLING;\r\n}\r\nDwarf_Die *die_find_variable_at(Dwarf_Die *sp_die, const char *name,\r\nDwarf_Addr addr, Dwarf_Die *die_mem)\r\n{\r\nstruct __find_variable_param fvp = { .name = name, .addr = addr};\r\nreturn die_find_child(sp_die, __die_find_variable_cb, (void *)&fvp,\r\ndie_mem);\r\n}\r\nstatic int __die_find_member_cb(Dwarf_Die *die_mem, void *data)\r\n{\r\nconst char *name = data;\r\nif (dwarf_tag(die_mem) == DW_TAG_member) {\r\nif (die_compare_name(die_mem, name))\r\nreturn DIE_FIND_CB_END;\r\nelse if (!dwarf_diename(die_mem)) {\r\nDwarf_Die type_die, tmp_die;\r\nif (die_get_type(die_mem, &type_die) &&\r\ndie_find_member(&type_die, name, &tmp_die))\r\nreturn DIE_FIND_CB_END;\r\n}\r\n}\r\nreturn DIE_FIND_CB_SIBLING;\r\n}\r\nDwarf_Die *die_find_member(Dwarf_Die *st_die, const char *name,\r\nDwarf_Die *die_mem)\r\n{\r\nreturn die_find_child(st_die, __die_find_member_cb, (void *)name,\r\ndie_mem);\r\n}\r\nint die_get_typename(Dwarf_Die *vr_die, struct strbuf *buf)\r\n{\r\nDwarf_Die type;\r\nint tag, ret;\r\nconst char *tmp = "";\r\nif (__die_get_real_type(vr_die, &type) == NULL)\r\nreturn -ENOENT;\r\ntag = dwarf_tag(&type);\r\nif (tag == DW_TAG_array_type || tag == DW_TAG_pointer_type)\r\ntmp = "*";\r\nelse if (tag == DW_TAG_subroutine_type) {\r\nreturn strbuf_add(buf, "(function_type)", 15);\r\n} else {\r\nif (!dwarf_diename(&type))\r\nreturn -ENOENT;\r\nif (tag == DW_TAG_union_type)\r\ntmp = "union ";\r\nelse if (tag == DW_TAG_structure_type)\r\ntmp = "struct ";\r\nelse if (tag == DW_TAG_enumeration_type)\r\ntmp = "enum ";\r\nreturn strbuf_addf(buf, "%s%s", tmp, dwarf_diename(&type));\r\n}\r\nret = die_get_typename(&type, buf);\r\nreturn ret ? ret : strbuf_addstr(buf, tmp);\r\n}\r\nint die_get_varname(Dwarf_Die *vr_die, struct strbuf *buf)\r\n{\r\nint ret;\r\nret = die_get_typename(vr_die, buf);\r\nif (ret < 0) {\r\npr_debug("Failed to get type, make it unknown.\n");\r\nret = strbuf_add(buf, " (unknown_type)", 14);\r\n}\r\nreturn ret < 0 ? ret : strbuf_addf(buf, "\t%s", dwarf_diename(vr_die));\r\n}\r\nstatic int die_get_var_innermost_scope(Dwarf_Die *sp_die, Dwarf_Die *vr_die,\r\nstruct strbuf *buf)\r\n{\r\nDwarf_Die *scopes;\r\nint count;\r\nsize_t offset = 0;\r\nDwarf_Addr base;\r\nDwarf_Addr start, end;\r\nDwarf_Addr entry;\r\nint ret;\r\nbool first = true;\r\nconst char *name;\r\nret = dwarf_entrypc(sp_die, &entry);\r\nif (ret)\r\nreturn ret;\r\nname = dwarf_diename(sp_die);\r\nif (!name)\r\nreturn -ENOENT;\r\ncount = dwarf_getscopes_die(vr_die, &scopes);\r\nif (count <= 1) {\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nwhile ((offset = dwarf_ranges(&scopes[1], offset, &base,\r\n&start, &end)) > 0) {\r\nstart -= entry;\r\nend -= entry;\r\nif (first) {\r\nret = strbuf_addf(buf, "@<%s+[%" PRIu64 "-%" PRIu64,\r\nname, start, end);\r\nfirst = false;\r\n} else {\r\nret = strbuf_addf(buf, ",%" PRIu64 "-%" PRIu64,\r\nstart, end);\r\n}\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nif (!first)\r\nret = strbuf_add(buf, "]>", 2);\r\nout:\r\nfree(scopes);\r\nreturn ret;\r\n}\r\nint die_get_var_range(Dwarf_Die *sp_die, Dwarf_Die *vr_die, struct strbuf *buf)\r\n{\r\nint ret = 0;\r\nDwarf_Addr base;\r\nDwarf_Addr start, end;\r\nDwarf_Addr entry;\r\nDwarf_Op *op;\r\nsize_t nops;\r\nsize_t offset = 0;\r\nDwarf_Attribute attr;\r\nbool first = true;\r\nconst char *name;\r\nret = dwarf_entrypc(sp_die, &entry);\r\nif (ret)\r\nreturn ret;\r\nname = dwarf_diename(sp_die);\r\nif (!name)\r\nreturn -ENOENT;\r\nif (dwarf_attr(vr_die, DW_AT_location, &attr) == NULL)\r\nreturn -EINVAL;\r\nwhile ((offset = dwarf_getlocations(&attr, offset, &base,\r\n&start, &end, &op, &nops)) > 0) {\r\nif (start == 0) {\r\nret = die_get_var_innermost_scope(sp_die, vr_die, buf);\r\ngoto out;\r\n}\r\nstart -= entry;\r\nend -= entry;\r\nif (first) {\r\nret = strbuf_addf(buf, "@<%s+[%" PRIu64 "-%" PRIu64,\r\nname, start, end);\r\nfirst = false;\r\n} else {\r\nret = strbuf_addf(buf, ",%" PRIu64 "-%" PRIu64,\r\nstart, end);\r\n}\r\nif (ret < 0)\r\ngoto out;\r\n}\r\nif (!first)\r\nret = strbuf_add(buf, "]>", 2);\r\nout:\r\nreturn ret;\r\n}\r\nint die_get_var_range(Dwarf_Die *sp_die __maybe_unused,\r\nDwarf_Die *vr_die __maybe_unused,\r\nstruct strbuf *buf __maybe_unused)\r\n{\r\nreturn -ENOTSUP;\r\n}

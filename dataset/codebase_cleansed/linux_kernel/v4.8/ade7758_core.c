int ade7758_spi_write_reg_8(struct device *dev, u8 reg_address, u8 val)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7758_WRITE_REG(reg_address);\r\nst->tx[1] = val;\r\nret = spi_write(st->us, st->tx, 2);\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7758_spi_write_reg_16(struct device *dev, u8 reg_address,\r\nu16 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n}\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7758_WRITE_REG(reg_address);\r\nst->tx[1] = (value >> 8) & 0xFF;\r\nst->tx[2] = value & 0xFF;\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7758_spi_write_reg_24(struct device *dev, u8 reg_address,\r\nu32 value)\r\n{\r\nint ret;\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 4,\r\n}\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7758_WRITE_REG(reg_address);\r\nst->tx[1] = (value >> 16) & 0xFF;\r\nst->tx[2] = (value >> 8) & 0xFF;\r\nst->tx[3] = value & 0xFF;\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nint ade7758_spi_read_reg_8(struct device *dev, u8 reg_address, u8 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 1,\r\n.delay_usecs = 4,\r\n},\r\n{\r\n.tx_buf = &st->tx[1],\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 1,\r\n},\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7758_READ_REG(reg_address);\r\nst->tx[1] = 0;\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nif (ret) {\r\ndev_err(&st->us->dev, "problem when reading 8 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = st->rx[0];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7758_spi_read_reg_16(struct device *dev, u8 reg_address,\r\nu16 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 1,\r\n.delay_usecs = 4,\r\n},\r\n{\r\n.tx_buf = &st->tx[1],\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 2,\r\n},\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7758_READ_REG(reg_address);\r\nst->tx[1] = 0;\r\nst->tx[2] = 0;\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nif (ret) {\r\ndev_err(&st->us->dev, "problem when reading 16 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = (st->rx[0] << 8) | st->rx[1];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic int ade7758_spi_read_reg_24(struct device *dev, u8 reg_address,\r\nu32 *val)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nint ret;\r\nstruct spi_transfer xfers[] = {\r\n{\r\n.tx_buf = st->tx,\r\n.bits_per_word = 8,\r\n.len = 1,\r\n.delay_usecs = 4,\r\n},\r\n{\r\n.tx_buf = &st->tx[1],\r\n.rx_buf = st->rx,\r\n.bits_per_word = 8,\r\n.len = 3,\r\n},\r\n};\r\nmutex_lock(&st->buf_lock);\r\nst->tx[0] = ADE7758_READ_REG(reg_address);\r\nst->tx[1] = 0;\r\nst->tx[2] = 0;\r\nst->tx[3] = 0;\r\nret = spi_sync_transfer(st->us, xfers, ARRAY_SIZE(xfers));\r\nif (ret) {\r\ndev_err(&st->us->dev, "problem when reading 24 bit register 0x%02X",\r\nreg_address);\r\ngoto error_ret;\r\n}\r\n*val = (st->rx[0] << 16) | (st->rx[1] << 8) | st->rx[2];\r\nerror_ret:\r\nmutex_unlock(&st->buf_lock);\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7758_read_8bit(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint ret;\r\nu8 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7758_spi_read_reg_8(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7758_read_16bit(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint ret;\r\nu16 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7758_spi_read_reg_16(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val);\r\n}\r\nstatic ssize_t ade7758_read_24bit(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint ret;\r\nu32 val = 0;\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nret = ade7758_spi_read_reg_24(dev, this_attr->address, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn sprintf(buf, "%u\n", val & 0xFFFFFF);\r\n}\r\nstatic ssize_t ade7758_write_8bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nu8 val;\r\nret = kstrtou8(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = ade7758_spi_write_reg_8(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic ssize_t ade7758_write_16bit(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct iio_dev_attr *this_attr = to_iio_dev_attr(attr);\r\nint ret;\r\nu16 val;\r\nret = kstrtou16(buf, 10, &val);\r\nif (ret)\r\ngoto error_ret;\r\nret = ade7758_spi_write_reg_16(dev, this_attr->address, val);\r\nerror_ret:\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7758_reset(struct device *dev)\r\n{\r\nint ret;\r\nu8 val;\r\nret = ade7758_spi_read_reg_8(dev, ADE7758_OPMODE, &val);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read opmode reg\n");\r\nreturn ret;\r\n}\r\nval |= BIT(6);\r\nret = ade7758_spi_write_reg_8(dev, ADE7758_OPMODE, val);\r\nif (ret < 0)\r\ndev_err(dev, "Failed to write opmode reg\n");\r\nreturn ret;\r\n}\r\nint ade7758_set_irq(struct device *dev, bool enable)\r\n{\r\nint ret;\r\nu32 irqen;\r\nret = ade7758_spi_read_reg_24(dev, ADE7758_MASK, &irqen);\r\nif (ret)\r\nreturn ret;\r\nif (enable)\r\nirqen |= BIT(16);\r\nelse\r\nirqen &= ~BIT(16);\r\nret = ade7758_spi_write_reg_24(dev, ADE7758_MASK, irqen);\r\nreturn ret;\r\n}\r\nstatic int ade7758_stop_device(struct device *dev)\r\n{\r\nint ret;\r\nu8 val;\r\nret = ade7758_spi_read_reg_8(dev, ADE7758_OPMODE, &val);\r\nif (ret < 0) {\r\ndev_err(dev, "Failed to read opmode reg\n");\r\nreturn ret;\r\n}\r\nval |= 7 << 3;\r\nret = ade7758_spi_write_reg_8(dev, ADE7758_OPMODE, val);\r\nif (ret < 0)\r\ndev_err(dev, "Failed to write opmode reg\n");\r\nreturn ret;\r\n}\r\nstatic int ade7758_initial_setup(struct iio_dev *indio_dev)\r\n{\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\nstruct device *dev = &indio_dev->dev;\r\nint ret;\r\nst->us->mode = SPI_MODE_1;\r\nspi_setup(st->us);\r\nret = ade7758_set_irq(dev, false);\r\nif (ret) {\r\ndev_err(dev, "disable irq failed");\r\ngoto err_ret;\r\n}\r\nade7758_reset(dev);\r\nmsleep(ADE7758_STARTUP_DELAY);\r\nerr_ret:\r\nreturn ret;\r\n}\r\nstatic ssize_t ade7758_read_frequency(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nint ret;\r\nu8 t;\r\nint sps;\r\nret = ade7758_spi_read_reg_8(dev, ADE7758_WAVMODE, &t);\r\nif (ret)\r\nreturn ret;\r\nt = (t >> 5) & 0x3;\r\nsps = 26040 / (1 << t);\r\nreturn sprintf(buf, "%d SPS\n", sps);\r\n}\r\nstatic ssize_t ade7758_write_frequency(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t len)\r\n{\r\nstruct iio_dev *indio_dev = dev_to_iio_dev(dev);\r\nu16 val;\r\nint ret;\r\nu8 reg, t;\r\nret = kstrtou16(buf, 10, &val);\r\nif (ret)\r\nreturn ret;\r\nmutex_lock(&indio_dev->mlock);\r\nswitch (val) {\r\ncase 26040:\r\nt = 0;\r\nbreak;\r\ncase 13020:\r\nt = 1;\r\nbreak;\r\ncase 6510:\r\nt = 2;\r\nbreak;\r\ncase 3255:\r\nt = 3;\r\nbreak;\r\ndefault:\r\nret = -EINVAL;\r\ngoto out;\r\n}\r\nret = ade7758_spi_read_reg_8(dev, ADE7758_WAVMODE, &reg);\r\nif (ret)\r\ngoto out;\r\nreg &= ~(5 << 3);\r\nreg |= t << 5;\r\nret = ade7758_spi_write_reg_8(dev, ADE7758_WAVMODE, reg);\r\nout:\r\nmutex_unlock(&indio_dev->mlock);\r\nreturn ret ? ret : len;\r\n}\r\nstatic int ade7758_probe(struct spi_device *spi)\r\n{\r\nint ret;\r\nstruct ade7758_state *st;\r\nstruct iio_dev *indio_dev;\r\nindio_dev = devm_iio_device_alloc(&spi->dev, sizeof(*st));\r\nif (!indio_dev)\r\nreturn -ENOMEM;\r\nst = iio_priv(indio_dev);\r\nspi_set_drvdata(spi, indio_dev);\r\nst->rx = kcalloc(ADE7758_MAX_RX, sizeof(*st->rx), GFP_KERNEL);\r\nif (!st->rx)\r\nreturn -ENOMEM;\r\nst->tx = kcalloc(ADE7758_MAX_TX, sizeof(*st->tx), GFP_KERNEL);\r\nif (!st->tx) {\r\nret = -ENOMEM;\r\ngoto error_free_rx;\r\n}\r\nst->us = spi;\r\nmutex_init(&st->buf_lock);\r\nindio_dev->name = spi->dev.driver->name;\r\nindio_dev->dev.parent = &spi->dev;\r\nindio_dev->info = &ade7758_info;\r\nindio_dev->modes = INDIO_DIRECT_MODE;\r\nindio_dev->channels = ade7758_channels;\r\nindio_dev->num_channels = ARRAY_SIZE(ade7758_channels);\r\nret = ade7758_configure_ring(indio_dev);\r\nif (ret)\r\ngoto error_free_tx;\r\nret = ade7758_initial_setup(indio_dev);\r\nif (ret)\r\ngoto error_unreg_ring_funcs;\r\nif (spi->irq) {\r\nret = ade7758_probe_trigger(indio_dev);\r\nif (ret)\r\ngoto error_unreg_ring_funcs;\r\n}\r\nret = iio_device_register(indio_dev);\r\nif (ret)\r\ngoto error_remove_trigger;\r\nreturn 0;\r\nerror_remove_trigger:\r\nif (spi->irq)\r\nade7758_remove_trigger(indio_dev);\r\nerror_unreg_ring_funcs:\r\nade7758_unconfigure_ring(indio_dev);\r\nerror_free_tx:\r\nkfree(st->tx);\r\nerror_free_rx:\r\nkfree(st->rx);\r\nreturn ret;\r\n}\r\nstatic int ade7758_remove(struct spi_device *spi)\r\n{\r\nstruct iio_dev *indio_dev = spi_get_drvdata(spi);\r\nstruct ade7758_state *st = iio_priv(indio_dev);\r\niio_device_unregister(indio_dev);\r\nade7758_stop_device(&indio_dev->dev);\r\nade7758_remove_trigger(indio_dev);\r\nade7758_unconfigure_ring(indio_dev);\r\nkfree(st->tx);\r\nkfree(st->rx);\r\nreturn 0;\r\n}

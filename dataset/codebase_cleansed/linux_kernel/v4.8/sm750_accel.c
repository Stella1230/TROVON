static inline void write_dpr(struct lynx_accel *accel, int offset, u32 regValue)\r\n{\r\nwritel(regValue, accel->dprBase + offset);\r\n}\r\nstatic inline u32 read_dpr(struct lynx_accel *accel, int offset)\r\n{\r\nreturn readl(accel->dprBase + offset);\r\n}\r\nstatic inline void write_dpPort(struct lynx_accel *accel, u32 data)\r\n{\r\nwritel(data, accel->dpPortBase);\r\n}\r\nvoid hw_de_init(struct lynx_accel *accel)\r\n{\r\nu32 reg, clr;\r\nwrite_dpr(accel, DE_MASKS, 0xFFFFFFFF);\r\nreg = 0x3;\r\nclr = DE_STRETCH_FORMAT_PATTERN_XY | DE_STRETCH_FORMAT_PATTERN_Y_MASK |\r\nDE_STRETCH_FORMAT_PATTERN_X_MASK |\r\nDE_STRETCH_FORMAT_ADDRESSING_MASK |\r\nDE_STRETCH_FORMAT_SOURCE_HEIGHT_MASK;\r\nwrite_dpr(accel, DE_STRETCH_FORMAT,\r\n(read_dpr(accel, DE_STRETCH_FORMAT) & ~clr) | reg);\r\nwrite_dpr(accel, DE_CLIP_TL, 0);\r\nwrite_dpr(accel, DE_CLIP_BR, 0);\r\nwrite_dpr(accel, DE_COLOR_COMPARE_MASK, 0);\r\nwrite_dpr(accel, DE_COLOR_COMPARE, 0);\r\nclr = DE_CONTROL_TRANSPARENCY | DE_CONTROL_TRANSPARENCY_MATCH |\r\nDE_CONTROL_TRANSPARENCY_SELECT;\r\nwrite_dpr(accel, DE_CONTROL, read_dpr(accel, DE_CONTROL) & ~clr);\r\n}\r\nvoid hw_set2dformat(struct lynx_accel *accel, int fmt)\r\n{\r\nu32 reg;\r\nreg = read_dpr(accel, DE_STRETCH_FORMAT);\r\nreg &= ~DE_STRETCH_FORMAT_PIXEL_FORMAT_MASK;\r\nreg |= ((fmt << DE_STRETCH_FORMAT_PIXEL_FORMAT_SHIFT) &\r\nDE_STRETCH_FORMAT_PIXEL_FORMAT_MASK);\r\nwrite_dpr(accel, DE_STRETCH_FORMAT, reg);\r\n}\r\nint hw_fillrect(struct lynx_accel *accel,\r\nu32 base, u32 pitch, u32 Bpp,\r\nu32 x, u32 y, u32 width, u32 height,\r\nu32 color, u32 rop)\r\n{\r\nu32 deCtrl;\r\nif (accel->de_wait() != 0) {\r\npr_debug("De engine always busy\n");\r\nreturn -1;\r\n}\r\nwrite_dpr(accel, DE_WINDOW_DESTINATION_BASE, base);\r\nwrite_dpr(accel, DE_PITCH,\r\n((pitch / Bpp << DE_PITCH_DESTINATION_SHIFT) &\r\nDE_PITCH_DESTINATION_MASK) |\r\n(pitch / Bpp & DE_PITCH_SOURCE_MASK));\r\nwrite_dpr(accel, DE_WINDOW_WIDTH,\r\n((pitch / Bpp << DE_WINDOW_WIDTH_DST_SHIFT) &\r\nDE_WINDOW_WIDTH_DST_MASK) |\r\n(pitch / Bpp & DE_WINDOW_WIDTH_SRC_MASK));\r\nwrite_dpr(accel, DE_FOREGROUND, color);\r\nwrite_dpr(accel, DE_DESTINATION,\r\n((x << DE_DESTINATION_X_SHIFT) & DE_DESTINATION_X_MASK) |\r\n(y & DE_DESTINATION_Y_MASK));\r\nwrite_dpr(accel, DE_DIMENSION,\r\n((width << DE_DIMENSION_X_SHIFT) & DE_DIMENSION_X_MASK) |\r\n(height & DE_DIMENSION_Y_ET_MASK));\r\ndeCtrl = DE_CONTROL_STATUS | DE_CONTROL_LAST_PIXEL |\r\nDE_CONTROL_COMMAND_RECTANGLE_FILL | DE_CONTROL_ROP_SELECT |\r\n(rop & DE_CONTROL_ROP_MASK);\r\nwrite_dpr(accel, DE_CONTROL, deCtrl);\r\nreturn 0;\r\n}\r\nint hw_copyarea(\r\nstruct lynx_accel *accel,\r\nunsigned int sBase,\r\nunsigned int sPitch,\r\nunsigned int sx,\r\nunsigned int sy,\r\nunsigned int dBase,\r\nunsigned int dPitch,\r\nunsigned int Bpp,\r\nunsigned int dx,\r\nunsigned int dy,\r\nunsigned int width,\r\nunsigned int height,\r\nunsigned int rop2)\r\n{\r\nunsigned int nDirection, de_ctrl;\r\nint opSign;\r\nnDirection = LEFT_TO_RIGHT;\r\nopSign = 1;\r\nde_ctrl = 0;\r\nif (sBase == dBase && sPitch == dPitch) {\r\nif (sy < dy) {\r\nnDirection = BOTTOM_TO_TOP;\r\n} else if (sy > dy) {\r\nnDirection = TOP_TO_BOTTOM;\r\n} else {\r\nif (sx <= dx) {\r\nnDirection = RIGHT_TO_LEFT;\r\n} else {\r\nnDirection = LEFT_TO_RIGHT;\r\n}\r\n}\r\n}\r\nif ((nDirection == BOTTOM_TO_TOP) || (nDirection == RIGHT_TO_LEFT)) {\r\nsx += width - 1;\r\nsy += height - 1;\r\ndx += width - 1;\r\ndy += height - 1;\r\nopSign = (-1);\r\n}\r\nwrite_dpr(accel, DE_WINDOW_SOURCE_BASE, sBase);\r\nwrite_dpr(accel, DE_WINDOW_DESTINATION_BASE, dBase);\r\nwrite_dpr(accel, DE_PITCH,\r\n((dPitch / Bpp << DE_PITCH_DESTINATION_SHIFT) &\r\nDE_PITCH_DESTINATION_MASK) |\r\n(sPitch / Bpp & DE_PITCH_SOURCE_MASK));\r\nwrite_dpr(accel, DE_WINDOW_WIDTH,\r\n((dPitch / Bpp << DE_WINDOW_WIDTH_DST_SHIFT) &\r\nDE_WINDOW_WIDTH_DST_MASK) |\r\n(sPitch / Bpp & DE_WINDOW_WIDTH_SRC_MASK));\r\nif (accel->de_wait() != 0)\r\nreturn -1;\r\n{\r\nwrite_dpr(accel, DE_SOURCE,\r\n((sx << DE_SOURCE_X_K1_SHIFT) & DE_SOURCE_X_K1_MASK) |\r\n(sy & DE_SOURCE_Y_K2_MASK));\r\nwrite_dpr(accel, DE_DESTINATION,\r\n((dx << DE_DESTINATION_X_SHIFT) & DE_DESTINATION_X_MASK) |\r\n(dy & DE_DESTINATION_Y_MASK));\r\nwrite_dpr(accel, DE_DIMENSION,\r\n((width << DE_DIMENSION_X_SHIFT) & DE_DIMENSION_X_MASK) |\r\n(height & DE_DIMENSION_Y_ET_MASK));\r\nde_ctrl = (rop2 & DE_CONTROL_ROP_MASK) | DE_CONTROL_ROP_SELECT |\r\n((nDirection == RIGHT_TO_LEFT) ? DE_CONTROL_DIRECTION : 0) |\r\nDE_CONTROL_COMMAND_BITBLT | DE_CONTROL_STATUS;\r\nwrite_dpr(accel, DE_CONTROL, de_ctrl);\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int deGetTransparency(struct lynx_accel *accel)\r\n{\r\nunsigned int de_ctrl;\r\nde_ctrl = read_dpr(accel, DE_CONTROL);\r\nde_ctrl &= (DE_CONTROL_TRANSPARENCY_MATCH |\r\nDE_CONTROL_TRANSPARENCY_SELECT | DE_CONTROL_TRANSPARENCY);\r\nreturn de_ctrl;\r\n}\r\nint hw_imageblit(struct lynx_accel *accel,\r\nconst char *pSrcbuf,\r\nu32 srcDelta,\r\nu32 startBit,\r\nu32 dBase,\r\nu32 dPitch,\r\nu32 bytePerPixel,\r\nu32 dx,\r\nu32 dy,\r\nu32 width,\r\nu32 height,\r\nu32 fColor,\r\nu32 bColor,\r\nu32 rop2)\r\n{\r\nunsigned int ulBytesPerScan;\r\nunsigned int ul4BytesPerScan;\r\nunsigned int ulBytesRemain;\r\nunsigned int de_ctrl = 0;\r\nunsigned char ajRemain[4];\r\nint i, j;\r\nstartBit &= 7;\r\nulBytesPerScan = (width + startBit + 7) / 8;\r\nul4BytesPerScan = ulBytesPerScan & ~3;\r\nulBytesRemain = ulBytesPerScan & 3;\r\nif (accel->de_wait() != 0)\r\nreturn -1;\r\nwrite_dpr(accel, DE_WINDOW_SOURCE_BASE, 0);\r\nwrite_dpr(accel, DE_WINDOW_DESTINATION_BASE, dBase);\r\nwrite_dpr(accel, DE_PITCH,\r\n((dPitch / bytePerPixel << DE_PITCH_DESTINATION_SHIFT) &\r\nDE_PITCH_DESTINATION_MASK) |\r\n(dPitch / bytePerPixel & DE_PITCH_SOURCE_MASK));\r\nwrite_dpr(accel, DE_WINDOW_WIDTH,\r\n((dPitch / bytePerPixel << DE_WINDOW_WIDTH_DST_SHIFT) &\r\nDE_WINDOW_WIDTH_DST_MASK) |\r\n(dPitch / bytePerPixel & DE_WINDOW_WIDTH_SRC_MASK));\r\nwrite_dpr(accel, DE_SOURCE,\r\n(startBit << DE_SOURCE_X_K1_SHIFT) &\r\nDE_SOURCE_X_K1_MONO_MASK);\r\nwrite_dpr(accel, DE_DESTINATION,\r\n((dx << DE_DESTINATION_X_SHIFT) & DE_DESTINATION_X_MASK) |\r\n(dy & DE_DESTINATION_Y_MASK));\r\nwrite_dpr(accel, DE_DIMENSION,\r\n((width << DE_DIMENSION_X_SHIFT) & DE_DIMENSION_X_MASK) |\r\n(height & DE_DIMENSION_Y_ET_MASK));\r\nwrite_dpr(accel, DE_FOREGROUND, fColor);\r\nwrite_dpr(accel, DE_BACKGROUND, bColor);\r\nde_ctrl = (rop2 & DE_CONTROL_ROP_MASK) |\r\nDE_CONTROL_ROP_SELECT | DE_CONTROL_COMMAND_HOST_WRITE |\r\nDE_CONTROL_HOST | DE_CONTROL_STATUS;\r\nwrite_dpr(accel, DE_CONTROL, de_ctrl | deGetTransparency(accel));\r\nfor (i = 0; i < height; i++) {\r\nfor (j = 0; j < (ul4BytesPerScan/4); j++)\r\nwrite_dpPort(accel, *(unsigned int *)(pSrcbuf + (j * 4)));\r\nif (ulBytesRemain) {\r\nmemcpy(ajRemain, pSrcbuf+ul4BytesPerScan, ulBytesRemain);\r\nwrite_dpPort(accel, *(unsigned int *)ajRemain);\r\n}\r\npSrcbuf += srcDelta;\r\n}\r\nreturn 0;\r\n}

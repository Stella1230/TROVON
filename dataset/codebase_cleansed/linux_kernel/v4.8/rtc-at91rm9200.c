static void at91_rtc_write_ier(u32 mask)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&at91_rtc_lock, flags);\r\nat91_rtc_shadow_imr |= mask;\r\nat91_rtc_write(AT91_RTC_IER, mask);\r\nspin_unlock_irqrestore(&at91_rtc_lock, flags);\r\n}\r\nstatic void at91_rtc_write_idr(u32 mask)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&at91_rtc_lock, flags);\r\nat91_rtc_write(AT91_RTC_IDR, mask);\r\nat91_rtc_read(AT91_RTC_SR);\r\nat91_rtc_shadow_imr &= ~mask;\r\nspin_unlock_irqrestore(&at91_rtc_lock, flags);\r\n}\r\nstatic u32 at91_rtc_read_imr(void)\r\n{\r\nunsigned long flags;\r\nu32 mask;\r\nif (at91_rtc_config->use_shadow_imr) {\r\nspin_lock_irqsave(&at91_rtc_lock, flags);\r\nmask = at91_rtc_shadow_imr;\r\nspin_unlock_irqrestore(&at91_rtc_lock, flags);\r\n} else {\r\nmask = at91_rtc_read(AT91_RTC_IMR);\r\n}\r\nreturn mask;\r\n}\r\nstatic void at91_rtc_decodetime(unsigned int timereg, unsigned int calreg,\r\nstruct rtc_time *tm)\r\n{\r\nunsigned int time, date;\r\ndo {\r\ntime = at91_rtc_read(timereg);\r\ndate = at91_rtc_read(calreg);\r\n} while ((time != at91_rtc_read(timereg)) ||\r\n(date != at91_rtc_read(calreg)));\r\ntm->tm_sec = bcd2bin((time & AT91_RTC_SEC) >> 0);\r\ntm->tm_min = bcd2bin((time & AT91_RTC_MIN) >> 8);\r\ntm->tm_hour = bcd2bin((time & AT91_RTC_HOUR) >> 16);\r\ntm->tm_year = bcd2bin(date & AT91_RTC_CENT) * 100;\r\ntm->tm_year += bcd2bin((date & AT91_RTC_YEAR) >> 8);\r\ntm->tm_wday = bcd2bin((date & AT91_RTC_DAY) >> 21) - 1;\r\ntm->tm_mon = bcd2bin((date & AT91_RTC_MONTH) >> 16) - 1;\r\ntm->tm_mday = bcd2bin((date & AT91_RTC_DATE) >> 24);\r\n}\r\nstatic int at91_rtc_readtime(struct device *dev, struct rtc_time *tm)\r\n{\r\nat91_rtc_decodetime(AT91_RTC_TIMR, AT91_RTC_CALR, tm);\r\ntm->tm_yday = rtc_year_days(tm->tm_mday, tm->tm_mon, tm->tm_year);\r\ntm->tm_year = tm->tm_year - 1900;\r\ndev_dbg(dev, "%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\n1900 + tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_settime(struct device *dev, struct rtc_time *tm)\r\n{\r\nunsigned long cr;\r\ndev_dbg(dev, "%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\n1900 + tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nwait_for_completion(&at91_rtc_upd_rdy);\r\ncr = at91_rtc_read(AT91_RTC_CR);\r\nat91_rtc_write(AT91_RTC_CR, cr | AT91_RTC_UPDCAL | AT91_RTC_UPDTIM);\r\nat91_rtc_write_ier(AT91_RTC_ACKUPD);\r\nwait_for_completion(&at91_rtc_updated);\r\nat91_rtc_write_idr(AT91_RTC_ACKUPD);\r\nat91_rtc_write(AT91_RTC_TIMR,\r\nbin2bcd(tm->tm_sec) << 0\r\n| bin2bcd(tm->tm_min) << 8\r\n| bin2bcd(tm->tm_hour) << 16);\r\nat91_rtc_write(AT91_RTC_CALR,\r\nbin2bcd((tm->tm_year + 1900) / 100)\r\n| bin2bcd(tm->tm_year % 100) << 8\r\n| bin2bcd(tm->tm_mon + 1) << 16\r\n| bin2bcd(tm->tm_wday + 1) << 21\r\n| bin2bcd(tm->tm_mday) << 24);\r\ncr = at91_rtc_read(AT91_RTC_CR);\r\nat91_rtc_write(AT91_RTC_SCCR, AT91_RTC_SECEV);\r\nat91_rtc_write(AT91_RTC_CR, cr & ~(AT91_RTC_UPDCAL | AT91_RTC_UPDTIM));\r\nat91_rtc_write_ier(AT91_RTC_SECEV);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_readalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rtc_time *tm = &alrm->time;\r\nat91_rtc_decodetime(AT91_RTC_TIMALR, AT91_RTC_CALALR, tm);\r\ntm->tm_yday = rtc_year_days(tm->tm_mday, tm->tm_mon, tm->tm_year);\r\ntm->tm_year = at91_alarm_year - 1900;\r\nalrm->enabled = (at91_rtc_read_imr() & AT91_RTC_ALARM)\r\n? 1 : 0;\r\ndev_dbg(dev, "%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\n1900 + tm->tm_year, tm->tm_mon, tm->tm_mday,\r\ntm->tm_hour, tm->tm_min, tm->tm_sec);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_setalarm(struct device *dev, struct rtc_wkalrm *alrm)\r\n{\r\nstruct rtc_time tm;\r\nat91_rtc_decodetime(AT91_RTC_TIMR, AT91_RTC_CALR, &tm);\r\nat91_alarm_year = tm.tm_year;\r\ntm.tm_mon = alrm->time.tm_mon;\r\ntm.tm_mday = alrm->time.tm_mday;\r\ntm.tm_hour = alrm->time.tm_hour;\r\ntm.tm_min = alrm->time.tm_min;\r\ntm.tm_sec = alrm->time.tm_sec;\r\nat91_rtc_write_idr(AT91_RTC_ALARM);\r\nat91_rtc_write(AT91_RTC_TIMALR,\r\nbin2bcd(tm.tm_sec) << 0\r\n| bin2bcd(tm.tm_min) << 8\r\n| bin2bcd(tm.tm_hour) << 16\r\n| AT91_RTC_HOUREN | AT91_RTC_MINEN | AT91_RTC_SECEN);\r\nat91_rtc_write(AT91_RTC_CALALR,\r\nbin2bcd(tm.tm_mon + 1) << 16\r\n| bin2bcd(tm.tm_mday) << 24\r\n| AT91_RTC_DATEEN | AT91_RTC_MTHEN);\r\nif (alrm->enabled) {\r\nat91_rtc_write(AT91_RTC_SCCR, AT91_RTC_ALARM);\r\nat91_rtc_write_ier(AT91_RTC_ALARM);\r\n}\r\ndev_dbg(dev, "%s(): %4d-%02d-%02d %02d:%02d:%02d\n", __func__,\r\nat91_alarm_year, tm.tm_mon, tm.tm_mday, tm.tm_hour,\r\ntm.tm_min, tm.tm_sec);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_alarm_irq_enable(struct device *dev, unsigned int enabled)\r\n{\r\ndev_dbg(dev, "%s(): cmd=%08x\n", __func__, enabled);\r\nif (enabled) {\r\nat91_rtc_write(AT91_RTC_SCCR, AT91_RTC_ALARM);\r\nat91_rtc_write_ier(AT91_RTC_ALARM);\r\n} else\r\nat91_rtc_write_idr(AT91_RTC_ALARM);\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_proc(struct device *dev, struct seq_file *seq)\r\n{\r\nunsigned long imr = at91_rtc_read_imr();\r\nseq_printf(seq, "update_IRQ\t: %s\n",\r\n(imr & AT91_RTC_ACKUPD) ? "yes" : "no");\r\nseq_printf(seq, "periodic_IRQ\t: %s\n",\r\n(imr & AT91_RTC_SECEV) ? "yes" : "no");\r\nreturn 0;\r\n}\r\nstatic irqreturn_t at91_rtc_interrupt(int irq, void *dev_id)\r\n{\r\nstruct platform_device *pdev = dev_id;\r\nstruct rtc_device *rtc = platform_get_drvdata(pdev);\r\nunsigned int rtsr;\r\nunsigned long events = 0;\r\nint ret = IRQ_NONE;\r\nspin_lock(&suspended_lock);\r\nrtsr = at91_rtc_read(AT91_RTC_SR) & at91_rtc_read_imr();\r\nif (rtsr) {\r\nif (rtsr & AT91_RTC_ALARM)\r\nevents |= (RTC_AF | RTC_IRQF);\r\nif (rtsr & AT91_RTC_SECEV) {\r\ncomplete(&at91_rtc_upd_rdy);\r\nat91_rtc_write_idr(AT91_RTC_SECEV);\r\n}\r\nif (rtsr & AT91_RTC_ACKUPD)\r\ncomplete(&at91_rtc_updated);\r\nat91_rtc_write(AT91_RTC_SCCR, rtsr);\r\nif (!suspended) {\r\nrtc_update_irq(rtc, 1, events);\r\ndev_dbg(&pdev->dev, "%s(): num=%ld, events=0x%02lx\n",\r\n__func__, events >> 8, events & 0x000000FF);\r\n} else {\r\ncached_events |= events;\r\nat91_rtc_write_idr(at91_rtc_imr);\r\npm_system_wakeup();\r\n}\r\nret = IRQ_HANDLED;\r\n}\r\nspin_unlock(&suspended_lock);\r\nreturn ret;\r\n}\r\nstatic const struct at91_rtc_config *\r\nat91_rtc_get_config(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *match;\r\nif (pdev->dev.of_node) {\r\nmatch = of_match_node(at91_rtc_dt_ids, pdev->dev.of_node);\r\nif (!match)\r\nreturn NULL;\r\nreturn (const struct at91_rtc_config *)match->data;\r\n}\r\nreturn &at91rm9200_config;\r\n}\r\nstatic int __init at91_rtc_probe(struct platform_device *pdev)\r\n{\r\nstruct rtc_device *rtc;\r\nstruct resource *regs;\r\nint ret = 0;\r\nat91_rtc_config = at91_rtc_get_config(pdev);\r\nif (!at91_rtc_config)\r\nreturn -ENODEV;\r\nregs = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!regs) {\r\ndev_err(&pdev->dev, "no mmio resource defined\n");\r\nreturn -ENXIO;\r\n}\r\nirq = platform_get_irq(pdev, 0);\r\nif (irq < 0) {\r\ndev_err(&pdev->dev, "no irq resource defined\n");\r\nreturn -ENXIO;\r\n}\r\nat91_rtc_regs = devm_ioremap(&pdev->dev, regs->start,\r\nresource_size(regs));\r\nif (!at91_rtc_regs) {\r\ndev_err(&pdev->dev, "failed to map registers, aborting.\n");\r\nreturn -ENOMEM;\r\n}\r\nsclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(sclk))\r\nreturn PTR_ERR(sclk);\r\nret = clk_prepare_enable(sclk);\r\nif (ret) {\r\ndev_err(&pdev->dev, "Could not enable slow clock\n");\r\nreturn ret;\r\n}\r\nat91_rtc_write(AT91_RTC_CR, 0);\r\nat91_rtc_write(AT91_RTC_MR, 0);\r\nat91_rtc_write_idr(AT91_RTC_ACKUPD | AT91_RTC_ALARM |\r\nAT91_RTC_SECEV | AT91_RTC_TIMEV |\r\nAT91_RTC_CALEV);\r\nret = devm_request_irq(&pdev->dev, irq, at91_rtc_interrupt,\r\nIRQF_SHARED | IRQF_COND_SUSPEND,\r\n"at91_rtc", pdev);\r\nif (ret) {\r\ndev_err(&pdev->dev, "IRQ %d already in use.\n", irq);\r\ngoto err_clk;\r\n}\r\nif (!device_can_wakeup(&pdev->dev))\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nrtc = devm_rtc_device_register(&pdev->dev, pdev->name,\r\n&at91_rtc_ops, THIS_MODULE);\r\nif (IS_ERR(rtc)) {\r\nret = PTR_ERR(rtc);\r\ngoto err_clk;\r\n}\r\nplatform_set_drvdata(pdev, rtc);\r\nat91_rtc_write_ier(AT91_RTC_SECEV);\r\ndev_info(&pdev->dev, "AT91 Real Time Clock driver.\n");\r\nreturn 0;\r\nerr_clk:\r\nclk_disable_unprepare(sclk);\r\nreturn ret;\r\n}\r\nstatic int __exit at91_rtc_remove(struct platform_device *pdev)\r\n{\r\nat91_rtc_write_idr(AT91_RTC_ACKUPD | AT91_RTC_ALARM |\r\nAT91_RTC_SECEV | AT91_RTC_TIMEV |\r\nAT91_RTC_CALEV);\r\nclk_disable_unprepare(sclk);\r\nreturn 0;\r\n}\r\nstatic void at91_rtc_shutdown(struct platform_device *pdev)\r\n{\r\nat91_rtc_write(AT91_RTC_IDR, AT91_RTC_ACKUPD | AT91_RTC_ALARM |\r\nAT91_RTC_SECEV | AT91_RTC_TIMEV |\r\nAT91_RTC_CALEV);\r\n}\r\nstatic int at91_rtc_suspend(struct device *dev)\r\n{\r\nat91_rtc_write(AT91_RTC_SCCR, AT91_RTC_ALARM);\r\nat91_rtc_imr = at91_rtc_read_imr()\r\n& (AT91_RTC_ALARM|AT91_RTC_SECEV);\r\nif (at91_rtc_imr) {\r\nif (device_may_wakeup(dev)) {\r\nunsigned long flags;\r\nenable_irq_wake(irq);\r\nspin_lock_irqsave(&suspended_lock, flags);\r\nsuspended = true;\r\nspin_unlock_irqrestore(&suspended_lock, flags);\r\n} else {\r\nat91_rtc_write_idr(at91_rtc_imr);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int at91_rtc_resume(struct device *dev)\r\n{\r\nstruct rtc_device *rtc = dev_get_drvdata(dev);\r\nif (at91_rtc_imr) {\r\nif (device_may_wakeup(dev)) {\r\nunsigned long flags;\r\nspin_lock_irqsave(&suspended_lock, flags);\r\nif (cached_events) {\r\nrtc_update_irq(rtc, 1, cached_events);\r\ncached_events = 0;\r\n}\r\nsuspended = false;\r\nspin_unlock_irqrestore(&suspended_lock, flags);\r\ndisable_irq_wake(irq);\r\n}\r\nat91_rtc_write_ier(at91_rtc_imr);\r\n}\r\nreturn 0;\r\n}

static int ehci_msm_reset(struct usb_hcd *hcd)\r\n{\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nint retval;\r\nehci->caps = USB_CAPLENGTH;\r\nhcd->has_tt = 1;\r\nretval = ehci_setup(hcd);\r\nif (retval)\r\nreturn retval;\r\nwritel(PORTSC_PTS_ULPI, USB_PORTSC);\r\nwritel(0, USB_AHBBURST);\r\nwritel(0x8, USB_AHBMODE);\r\nwritel(0x13, USB_USBMODE);\r\nwritel(readl(USB_GENCONFIG_2) & ~ULPI_TX_PKT_EN_CLR_FIX, USB_GENCONFIG_2);\r\nreturn 0;\r\n}\r\nstatic int ehci_msm_probe(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd;\r\nstruct resource *res;\r\nstruct usb_phy *phy;\r\nint ret;\r\ndev_dbg(&pdev->dev, "ehci_msm proble\n");\r\nhcd = usb_create_hcd(&msm_hc_driver, &pdev->dev, dev_name(&pdev->dev));\r\nif (!hcd) {\r\ndev_err(&pdev->dev, "Unable to create HCD\n");\r\nreturn -ENOMEM;\r\n}\r\nret = platform_get_irq(pdev, 0);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Unable to get IRQ resource\n");\r\ngoto put_hcd;\r\n}\r\nhcd->irq = ret;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Unable to get memory resource\n");\r\nret = -ENODEV;\r\ngoto put_hcd;\r\n}\r\nhcd->rsrc_start = res->start;\r\nhcd->rsrc_len = resource_size(res);\r\nhcd->regs = devm_ioremap(&pdev->dev, hcd->rsrc_start, hcd->rsrc_len);\r\nif (!hcd->regs) {\r\ndev_err(&pdev->dev, "ioremap failed\n");\r\nret = -ENOMEM;\r\ngoto put_hcd;\r\n}\r\nif (pdev->dev.of_node)\r\nphy = devm_usb_get_phy_by_phandle(&pdev->dev, "usb-phy", 0);\r\nelse\r\nphy = devm_usb_get_phy(&pdev->dev, USB_PHY_TYPE_USB2);\r\nif (IS_ERR(phy)) {\r\nif (PTR_ERR(phy) == -EPROBE_DEFER) {\r\ndev_err(&pdev->dev, "unable to find transceiver\n");\r\nret = -EPROBE_DEFER;\r\ngoto put_hcd;\r\n}\r\nphy = NULL;\r\n}\r\nhcd->usb_phy = phy;\r\ndevice_init_wakeup(&pdev->dev, 1);\r\nif (phy && phy->otg) {\r\nret = otg_set_host(phy->otg, &hcd->self);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "unable to register with transceiver\n");\r\ngoto put_hcd;\r\n}\r\npm_runtime_no_callbacks(&pdev->dev);\r\npm_runtime_enable(&pdev->dev);\r\n} else {\r\nret = usb_add_hcd(hcd, hcd->irq, IRQF_SHARED);\r\nif (ret)\r\ngoto put_hcd;\r\n}\r\nreturn 0;\r\nput_hcd:\r\nusb_put_hcd(hcd);\r\nreturn ret;\r\n}\r\nstatic int ehci_msm_remove(struct platform_device *pdev)\r\n{\r\nstruct usb_hcd *hcd = platform_get_drvdata(pdev);\r\ndevice_init_wakeup(&pdev->dev, 0);\r\npm_runtime_disable(&pdev->dev);\r\npm_runtime_set_suspended(&pdev->dev);\r\nif (hcd->usb_phy && hcd->usb_phy->otg)\r\notg_set_host(hcd->usb_phy->otg, NULL);\r\nelse\r\nusb_remove_hcd(hcd);\r\nusb_put_hcd(hcd);\r\nreturn 0;\r\n}\r\nstatic int ehci_msm_pm_suspend(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\nbool do_wakeup = device_may_wakeup(dev);\r\ndev_dbg(dev, "ehci-msm PM suspend\n");\r\nif (ehci->sbrn)\r\nreturn ehci_suspend(hcd, do_wakeup);\r\nreturn 0;\r\n}\r\nstatic int ehci_msm_pm_resume(struct device *dev)\r\n{\r\nstruct usb_hcd *hcd = dev_get_drvdata(dev);\r\nstruct ehci_hcd *ehci = hcd_to_ehci(hcd);\r\ndev_dbg(dev, "ehci-msm PM resume\n");\r\nif (ehci->sbrn)\r\nehci_resume(hcd, false);\r\nreturn 0;\r\n}\r\nstatic int __init ehci_msm_init(void)\r\n{\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\npr_info("%s: " DRIVER_DESC "\n", hcd_name);\r\nehci_init_driver(&msm_hc_driver, &msm_overrides);\r\nreturn platform_driver_register(&ehci_msm_driver);\r\n}\r\nstatic void __exit ehci_msm_cleanup(void)\r\n{\r\nplatform_driver_unregister(&ehci_msm_driver);\r\n}

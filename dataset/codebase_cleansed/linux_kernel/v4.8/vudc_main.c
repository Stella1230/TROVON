static int __init init(void)\r\n{\r\nint retval = -ENOMEM;\r\nint i;\r\nstruct vudc_device *udc_dev = NULL, *udc_dev2 = NULL;\r\nif (usb_disabled())\r\nreturn -ENODEV;\r\nif (vudc_number < 1) {\r\npr_err("Number of emulated UDC must be no less than 1");\r\nreturn -EINVAL;\r\n}\r\nretval = platform_driver_register(&vudc_driver);\r\nif (retval < 0)\r\ngoto out;\r\nfor (i = 0; i < vudc_number; i++) {\r\nudc_dev = alloc_vudc_device(i);\r\nif (!udc_dev) {\r\nretval = -ENOMEM;\r\ngoto cleanup;\r\n}\r\nretval = platform_device_add(udc_dev->pdev);\r\nif (retval < 0) {\r\nput_vudc_device(udc_dev);\r\ngoto cleanup;\r\n}\r\nlist_add_tail(&udc_dev->dev_entry, &vudc_devices);\r\nif (!platform_get_drvdata(udc_dev->pdev)) {\r\nretval = -EINVAL;\r\ngoto cleanup;\r\n}\r\n}\r\ngoto out;\r\ncleanup:\r\nlist_for_each_entry_safe(udc_dev, udc_dev2, &vudc_devices, dev_entry) {\r\nlist_del(&udc_dev->dev_entry);\r\nplatform_device_del(udc_dev->pdev);\r\nput_vudc_device(udc_dev);\r\n}\r\nplatform_driver_unregister(&vudc_driver);\r\nout:\r\nreturn retval;\r\n}\r\nstatic void __exit cleanup(void)\r\n{\r\nstruct vudc_device *udc_dev = NULL, *udc_dev2 = NULL;\r\nlist_for_each_entry_safe(udc_dev, udc_dev2, &vudc_devices, dev_entry) {\r\nlist_del(&udc_dev->dev_entry);\r\nplatform_device_unregister(udc_dev->pdev);\r\nput_vudc_device(udc_dev);\r\n}\r\nplatform_driver_unregister(&vudc_driver);\r\n}

static irqreturn_t\r\nscdrv_event_interrupt(int irq, void *subch_data)\r\n{\r\nstruct subch_data_s *sd = subch_data;\r\nunsigned long flags;\r\nint status;\r\nspin_lock_irqsave(&sd->sd_rlock, flags);\r\nstatus = ia64_sn_irtr_intr(sd->sd_nasid, sd->sd_subch);\r\nif ((status > 0) && (status & SAL_IROUTER_INTR_RECV)) {\r\ntasklet_schedule(&sn_sysctl_event);\r\n}\r\nspin_unlock_irqrestore(&sd->sd_rlock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int\r\nscdrv_parse_event(char *event, int *src, int *code, int *esp_code, char *desc)\r\n{\r\nchar *desc_end;\r\n*src = get_unaligned_be32(event);\r\nevent += 4;\r\n*code = get_unaligned_be32(event);\r\nevent += 4;\r\nif (*event++ != 2) {\r\nreturn -1;\r\n}\r\nif (*event++ != IR_ARG_INT) {\r\nreturn -1;\r\n}\r\n*esp_code = get_unaligned_be32(event);\r\nevent += 4;\r\nif (*event++ != IR_ARG_ASCII) {\r\nreturn -1;\r\n}\r\nevent[CHUNKSIZE-1] = '\0';\r\nevent += 2;\r\ndesc_end = desc + sprintf(desc, "%s", event);\r\nfor (desc_end--;\r\n(desc_end != desc) && ((*desc_end == 0xd) || (*desc_end == 0xa));\r\ndesc_end--) {\r\n*desc_end = '\0';\r\n}\r\nreturn 0;\r\n}\r\nstatic char *\r\nscdrv_event_severity(int code)\r\n{\r\nint ev_class = (code & EV_CLASS_MASK);\r\nint ev_severity = (code & EV_SEVERITY_MASK);\r\nchar *pk_severity = KERN_NOTICE;\r\nswitch (ev_class) {\r\ncase EV_CLASS_POWER:\r\nswitch (ev_severity) {\r\ncase EV_SEVERITY_POWER_LOW_WARNING:\r\ncase EV_SEVERITY_POWER_HIGH_WARNING:\r\npk_severity = KERN_WARNING;\r\nbreak;\r\ncase EV_SEVERITY_POWER_HIGH_FAULT:\r\ncase EV_SEVERITY_POWER_LOW_FAULT:\r\npk_severity = KERN_ALERT;\r\nbreak;\r\n}\r\nbreak;\r\ncase EV_CLASS_FAN:\r\nswitch (ev_severity) {\r\ncase EV_SEVERITY_FAN_WARNING:\r\npk_severity = KERN_WARNING;\r\nbreak;\r\ncase EV_SEVERITY_FAN_FAULT:\r\npk_severity = KERN_CRIT;\r\nbreak;\r\n}\r\nbreak;\r\ncase EV_CLASS_TEMP:\r\nswitch (ev_severity) {\r\ncase EV_SEVERITY_TEMP_ADVISORY:\r\npk_severity = KERN_WARNING;\r\nbreak;\r\ncase EV_SEVERITY_TEMP_CRITICAL:\r\npk_severity = KERN_CRIT;\r\nbreak;\r\ncase EV_SEVERITY_TEMP_FAULT:\r\npk_severity = KERN_ALERT;\r\nbreak;\r\n}\r\nbreak;\r\ncase EV_CLASS_ENV:\r\npk_severity = KERN_ALERT;\r\nbreak;\r\ncase EV_CLASS_TEST_FAULT:\r\npk_severity = KERN_ALERT;\r\nbreak;\r\ncase EV_CLASS_TEST_WARNING:\r\npk_severity = KERN_WARNING;\r\nbreak;\r\ncase EV_CLASS_PWRD_NOTIFY:\r\npk_severity = KERN_ALERT;\r\nbreak;\r\n}\r\nreturn pk_severity;\r\n}\r\nstatic void\r\nscdrv_dispatch_event(char *event, int len)\r\n{\r\nstatic int snsc_shutting_down = 0;\r\nint code, esp_code, src, class;\r\nchar desc[CHUNKSIZE];\r\nchar *severity;\r\nif (scdrv_parse_event(event, &src, &code, &esp_code, desc) < 0) {\r\nreturn;\r\n}\r\nseverity = scdrv_event_severity(code);\r\nclass = (code & EV_CLASS_MASK);\r\nif (class == EV_CLASS_PWRD_NOTIFY || code == ENV_PWRDN_PEND) {\r\nif (snsc_shutting_down)\r\nreturn;\r\nsnsc_shutting_down = 1;\r\nif (class == EV_CLASS_PWRD_NOTIFY)\r\nprintk(KERN_NOTICE "Power off indication received."\r\n" Sending SIGPWR to init...\n");\r\nelse if (code == ENV_PWRDN_PEND)\r\nprintk(KERN_CRIT "WARNING: Shutting down the system"\r\n" due to a critical environmental condition."\r\n" Sending SIGPWR to init...\n");\r\nkill_cad_pid(SIGPWR, 0);\r\n} else {\r\nprintk("%s|$(0x%x)%s\n", severity, esp_code, desc);\r\n}\r\n}\r\nvoid\r\nscdrv_event(unsigned long dummy)\r\n{\r\nint status;\r\nint len;\r\nunsigned long flags;\r\nstruct subch_data_s *sd = event_sd;\r\nlen = CHUNKSIZE;\r\nspin_lock_irqsave(&sd->sd_rlock, flags);\r\nstatus = ia64_sn_irtr_recv(sd->sd_nasid, sd->sd_subch,\r\nsd->sd_rb, &len);\r\nwhile (!(status < 0)) {\r\nspin_unlock_irqrestore(&sd->sd_rlock, flags);\r\nscdrv_dispatch_event(sd->sd_rb, len);\r\nlen = CHUNKSIZE;\r\nspin_lock_irqsave(&sd->sd_rlock, flags);\r\nstatus = ia64_sn_irtr_recv(sd->sd_nasid, sd->sd_subch,\r\nsd->sd_rb, &len);\r\n}\r\nspin_unlock_irqrestore(&sd->sd_rlock, flags);\r\n}\r\nvoid\r\nscdrv_event_init(struct sysctl_data_s *scd)\r\n{\r\nint rv;\r\nevent_sd = kzalloc(sizeof (struct subch_data_s), GFP_KERNEL);\r\nif (event_sd == NULL) {\r\nprintk(KERN_WARNING "%s: couldn't allocate subchannel info"\r\n" for event monitoring\n", __func__);\r\nreturn;\r\n}\r\nevent_sd->sd_nasid = scd->scd_nasid;\r\nspin_lock_init(&event_sd->sd_rlock);\r\nevent_sd->sd_subch = ia64_sn_sysctl_event_init(scd->scd_nasid);\r\nif (event_sd->sd_subch < 0) {\r\nkfree(event_sd);\r\nprintk(KERN_WARNING "%s: couldn't open event subchannel\n",\r\n__func__);\r\nreturn;\r\n}\r\nrv = request_irq(SGI_UART_VECTOR, scdrv_event_interrupt,\r\nIRQF_SHARED, "system controller events", event_sd);\r\nif (rv) {\r\nprintk(KERN_WARNING "%s: irq request failed (%d)\n",\r\n__func__, rv);\r\nia64_sn_irtr_close(event_sd->sd_nasid, event_sd->sd_subch);\r\nkfree(event_sd);\r\nreturn;\r\n}\r\n}

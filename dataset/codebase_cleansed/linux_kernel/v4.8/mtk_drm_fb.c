struct drm_gem_object *mtk_fb_get_gem_obj(struct drm_framebuffer *fb)\r\n{\r\nstruct mtk_drm_fb *mtk_fb = to_mtk_fb(fb);\r\nreturn mtk_fb->gem_obj;\r\n}\r\nstatic int mtk_drm_fb_create_handle(struct drm_framebuffer *fb,\r\nstruct drm_file *file_priv,\r\nunsigned int *handle)\r\n{\r\nstruct mtk_drm_fb *mtk_fb = to_mtk_fb(fb);\r\nreturn drm_gem_handle_create(file_priv, mtk_fb->gem_obj, handle);\r\n}\r\nstatic void mtk_drm_fb_destroy(struct drm_framebuffer *fb)\r\n{\r\nstruct mtk_drm_fb *mtk_fb = to_mtk_fb(fb);\r\ndrm_framebuffer_cleanup(fb);\r\ndrm_gem_object_unreference_unlocked(mtk_fb->gem_obj);\r\nkfree(mtk_fb);\r\n}\r\nstatic struct mtk_drm_fb *mtk_drm_framebuffer_init(struct drm_device *dev,\r\nconst struct drm_mode_fb_cmd2 *mode,\r\nstruct drm_gem_object *obj)\r\n{\r\nstruct mtk_drm_fb *mtk_fb;\r\nint ret;\r\nif (drm_format_num_planes(mode->pixel_format) != 1)\r\nreturn ERR_PTR(-EINVAL);\r\nmtk_fb = kzalloc(sizeof(*mtk_fb), GFP_KERNEL);\r\nif (!mtk_fb)\r\nreturn ERR_PTR(-ENOMEM);\r\ndrm_helper_mode_fill_fb_struct(&mtk_fb->base, mode);\r\nmtk_fb->gem_obj = obj;\r\nret = drm_framebuffer_init(dev, &mtk_fb->base, &mtk_drm_fb_funcs);\r\nif (ret) {\r\nDRM_ERROR("failed to initialize framebuffer\n");\r\nkfree(mtk_fb);\r\nreturn ERR_PTR(ret);\r\n}\r\nreturn mtk_fb;\r\n}\r\nint mtk_fb_wait(struct drm_framebuffer *fb)\r\n{\r\nstruct drm_gem_object *gem;\r\nstruct reservation_object *resv;\r\nlong ret;\r\nif (!fb)\r\nreturn 0;\r\ngem = mtk_fb_get_gem_obj(fb);\r\nif (!gem || !gem->dma_buf || !gem->dma_buf->resv)\r\nreturn 0;\r\nresv = gem->dma_buf->resv;\r\nret = reservation_object_wait_timeout_rcu(resv, false, true,\r\nMAX_SCHEDULE_TIMEOUT);\r\nif (WARN_ON(ret < 0))\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstruct drm_framebuffer *mtk_drm_mode_fb_create(struct drm_device *dev,\r\nstruct drm_file *file,\r\nconst struct drm_mode_fb_cmd2 *cmd)\r\n{\r\nstruct mtk_drm_fb *mtk_fb;\r\nstruct drm_gem_object *gem;\r\nunsigned int width = cmd->width;\r\nunsigned int height = cmd->height;\r\nunsigned int size, bpp;\r\nint ret;\r\nif (drm_format_num_planes(cmd->pixel_format) != 1)\r\nreturn ERR_PTR(-EINVAL);\r\ngem = drm_gem_object_lookup(file, cmd->handles[0]);\r\nif (!gem)\r\nreturn ERR_PTR(-ENOENT);\r\nbpp = drm_format_plane_cpp(cmd->pixel_format, 0);\r\nsize = (height - 1) * cmd->pitches[0] + width * bpp;\r\nsize += cmd->offsets[0];\r\nif (gem->size < size) {\r\nret = -EINVAL;\r\ngoto unreference;\r\n}\r\nmtk_fb = mtk_drm_framebuffer_init(dev, cmd, gem);\r\nif (IS_ERR(mtk_fb)) {\r\nret = PTR_ERR(mtk_fb);\r\ngoto unreference;\r\n}\r\nreturn &mtk_fb->base;\r\nunreference:\r\ndrm_gem_object_unreference_unlocked(gem);\r\nreturn ERR_PTR(ret);\r\n}

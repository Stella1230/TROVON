static inline void\r\ni8259_update_irq_hw(unsigned int irq, unsigned long mask)\r\n{\r\nint port = 0x21;\r\nif (irq & 8) mask >>= 8;\r\nif (irq & 8) port = 0xA1;\r\noutb(mask, port);\r\n}\r\ninline void\r\ni8259a_enable_irq(struct irq_data *d)\r\n{\r\nspin_lock(&i8259_irq_lock);\r\ni8259_update_irq_hw(d->irq, cached_irq_mask &= ~(1 << d->irq));\r\nspin_unlock(&i8259_irq_lock);\r\n}\r\nstatic inline void\r\n__i8259a_disable_irq(unsigned int irq)\r\n{\r\ni8259_update_irq_hw(irq, cached_irq_mask |= 1 << irq);\r\n}\r\nvoid\r\ni8259a_disable_irq(struct irq_data *d)\r\n{\r\nspin_lock(&i8259_irq_lock);\r\n__i8259a_disable_irq(d->irq);\r\nspin_unlock(&i8259_irq_lock);\r\n}\r\nvoid\r\ni8259a_mask_and_ack_irq(struct irq_data *d)\r\n{\r\nunsigned int irq = d->irq;\r\nspin_lock(&i8259_irq_lock);\r\n__i8259a_disable_irq(irq);\r\nif (irq >= 8) {\r\noutb(0xE0 | (irq - 8), 0xa0);\r\nirq = 2;\r\n}\r\noutb(0xE0 | irq, 0x20);\r\nspin_unlock(&i8259_irq_lock);\r\n}\r\nvoid __init\r\ninit_i8259a_irqs(void)\r\n{\r\nstatic struct irqaction cascade = {\r\n.handler = no_action,\r\n.name = "cascade",\r\n};\r\nlong i;\r\noutb(0xff, 0x21);\r\noutb(0xff, 0xA1);\r\nfor (i = 0; i < 16; i++) {\r\nirq_set_chip_and_handler(i, &i8259a_irq_type, handle_level_irq);\r\n}\r\nsetup_irq(2, &cascade);\r\n}\r\nvoid\r\nisa_device_interrupt(unsigned long vector)\r\n{\r\nint j = *(vuip) IACK_SC;\r\nj &= 0xff;\r\nhandle_irq(j);\r\n}\r\nvoid\r\nisa_no_iack_sc_device_interrupt(unsigned long vector)\r\n{\r\nunsigned long pic;\r\npic = inb(0x20) | (inb(0xA0) << 8);\r\npic &= 0xFFFB;\r\nwhile (pic) {\r\nint j = ffz(~pic);\r\npic &= pic - 1;\r\nhandle_irq(j);\r\n}\r\n}

static u8 ems_pci_v1_readb(struct ems_pci_card *card, unsigned int port)\r\n{\r\nreturn readb(card->base_addr + (port * 4));\r\n}\r\nstatic u8 ems_pci_v1_read_reg(const struct sja1000_priv *priv, int port)\r\n{\r\nreturn readb(priv->reg_base + (port * 4));\r\n}\r\nstatic void ems_pci_v1_write_reg(const struct sja1000_priv *priv,\r\nint port, u8 val)\r\n{\r\nwriteb(val, priv->reg_base + (port * 4));\r\n}\r\nstatic void ems_pci_v1_post_irq(const struct sja1000_priv *priv)\r\n{\r\nstruct ems_pci_card *card = (struct ems_pci_card *)priv->priv;\r\nwritel(PITA2_ICR_INT0_EN | PITA2_ICR_INT0,\r\ncard->conf_addr + PITA2_ICR);\r\n}\r\nstatic u8 ems_pci_v2_read_reg(const struct sja1000_priv *priv, int port)\r\n{\r\nreturn readb(priv->reg_base + port);\r\n}\r\nstatic void ems_pci_v2_write_reg(const struct sja1000_priv *priv,\r\nint port, u8 val)\r\n{\r\nwriteb(val, priv->reg_base + port);\r\n}\r\nstatic void ems_pci_v2_post_irq(const struct sja1000_priv *priv)\r\n{\r\nstruct ems_pci_card *card = (struct ems_pci_card *)priv->priv;\r\nwritel(PLX_ICSR_ENA_CLR, card->conf_addr + PLX_ICSR);\r\n}\r\nstatic inline int ems_pci_check_chan(const struct sja1000_priv *priv)\r\n{\r\nunsigned char res;\r\npriv->write_reg(priv, SJA1000_MOD, 1);\r\npriv->write_reg(priv, SJA1000_CDR, CDR_PELICAN);\r\nres = priv->read_reg(priv, SJA1000_CDR);\r\nif (res == CDR_PELICAN)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nstatic void ems_pci_del_card(struct pci_dev *pdev)\r\n{\r\nstruct ems_pci_card *card = pci_get_drvdata(pdev);\r\nstruct net_device *dev;\r\nint i = 0;\r\nfor (i = 0; i < card->channels; i++) {\r\ndev = card->net_dev[i];\r\nif (!dev)\r\ncontinue;\r\ndev_info(&pdev->dev, "Removing %s.\n", dev->name);\r\nunregister_sja1000dev(dev);\r\nfree_sja1000dev(dev);\r\n}\r\nif (card->base_addr != NULL)\r\npci_iounmap(card->pci_dev, card->base_addr);\r\nif (card->conf_addr != NULL)\r\npci_iounmap(card->pci_dev, card->conf_addr);\r\nkfree(card);\r\npci_disable_device(pdev);\r\n}\r\nstatic void ems_pci_card_reset(struct ems_pci_card *card)\r\n{\r\nwriteb(0, card->base_addr);\r\n}\r\nstatic int ems_pci_add_card(struct pci_dev *pdev,\r\nconst struct pci_device_id *ent)\r\n{\r\nstruct sja1000_priv *priv;\r\nstruct net_device *dev;\r\nstruct ems_pci_card *card;\r\nint max_chan, conf_size, base_bar;\r\nint err, i;\r\nif (pci_enable_device(pdev) < 0) {\r\ndev_err(&pdev->dev, "Enabling PCI device failed\n");\r\nreturn -ENODEV;\r\n}\r\ncard = kzalloc(sizeof(struct ems_pci_card), GFP_KERNEL);\r\nif (card == NULL) {\r\npci_disable_device(pdev);\r\nreturn -ENOMEM;\r\n}\r\npci_set_drvdata(pdev, card);\r\ncard->pci_dev = pdev;\r\ncard->channels = 0;\r\nif (pdev->vendor == PCI_VENDOR_ID_PLX) {\r\ncard->version = 2;\r\nmax_chan = EMS_PCI_V2_MAX_CHAN;\r\nbase_bar = EMS_PCI_V2_BASE_BAR;\r\nconf_size = EMS_PCI_V2_CONF_SIZE;\r\n} else {\r\ncard->version = 1;\r\nmax_chan = EMS_PCI_V1_MAX_CHAN;\r\nbase_bar = EMS_PCI_V1_BASE_BAR;\r\nconf_size = EMS_PCI_V1_CONF_SIZE;\r\n}\r\ncard->conf_addr = pci_iomap(pdev, 0, conf_size);\r\nif (card->conf_addr == NULL) {\r\nerr = -ENOMEM;\r\ngoto failure_cleanup;\r\n}\r\ncard->base_addr = pci_iomap(pdev, base_bar, EMS_PCI_BASE_SIZE);\r\nif (card->base_addr == NULL) {\r\nerr = -ENOMEM;\r\ngoto failure_cleanup;\r\n}\r\nif (card->version == 1) {\r\nwritel(PITA2_MISC_CONFIG, card->conf_addr + PITA2_MISC);\r\nif (ems_pci_v1_readb(card, 0) != 0x55 ||\r\nems_pci_v1_readb(card, 1) != 0xAA ||\r\nems_pci_v1_readb(card, 2) != 0x01 ||\r\nems_pci_v1_readb(card, 3) != 0xCB ||\r\nems_pci_v1_readb(card, 4) != 0x11) {\r\ndev_err(&pdev->dev,\r\n"Not EMS Dr. Thomas Wuensche interface\n");\r\nerr = -ENODEV;\r\ngoto failure_cleanup;\r\n}\r\n}\r\nems_pci_card_reset(card);\r\nfor (i = 0; i < max_chan; i++) {\r\ndev = alloc_sja1000dev(0);\r\nif (dev == NULL) {\r\nerr = -ENOMEM;\r\ngoto failure_cleanup;\r\n}\r\ncard->net_dev[i] = dev;\r\npriv = netdev_priv(dev);\r\npriv->priv = card;\r\npriv->irq_flags = IRQF_SHARED;\r\ndev->irq = pdev->irq;\r\npriv->reg_base = card->base_addr + EMS_PCI_CAN_BASE_OFFSET\r\n+ (i * EMS_PCI_CAN_CTRL_SIZE);\r\nif (card->version == 1) {\r\npriv->read_reg = ems_pci_v1_read_reg;\r\npriv->write_reg = ems_pci_v1_write_reg;\r\npriv->post_irq = ems_pci_v1_post_irq;\r\n} else {\r\npriv->read_reg = ems_pci_v2_read_reg;\r\npriv->write_reg = ems_pci_v2_write_reg;\r\npriv->post_irq = ems_pci_v2_post_irq;\r\n}\r\nif (ems_pci_check_chan(priv)) {\r\npriv->can.clock.freq = EMS_PCI_CAN_CLOCK;\r\npriv->ocr = EMS_PCI_OCR;\r\npriv->cdr = EMS_PCI_CDR;\r\nSET_NETDEV_DEV(dev, &pdev->dev);\r\ndev->dev_id = i;\r\nif (card->version == 1)\r\nwritel(PITA2_ICR_INT0_EN | PITA2_ICR_INT0,\r\ncard->conf_addr + PITA2_ICR);\r\nelse\r\nwritel(PLX_ICSR_ENA_CLR,\r\ncard->conf_addr + PLX_ICSR);\r\nerr = register_sja1000dev(dev);\r\nif (err) {\r\ndev_err(&pdev->dev, "Registering device failed "\r\n"(err=%d)\n", err);\r\nfree_sja1000dev(dev);\r\ngoto failure_cleanup;\r\n}\r\ncard->channels++;\r\ndev_info(&pdev->dev, "Channel #%d at 0x%p, irq %d\n",\r\ni + 1, priv->reg_base, dev->irq);\r\n} else {\r\nfree_sja1000dev(dev);\r\n}\r\n}\r\nreturn 0;\r\nfailure_cleanup:\r\ndev_err(&pdev->dev, "Error: %d. Cleaning Up.\n", err);\r\nems_pci_del_card(pdev);\r\nreturn err;\r\n}

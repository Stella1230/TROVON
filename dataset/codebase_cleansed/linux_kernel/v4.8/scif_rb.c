void scif_rb_init(struct scif_rb *rb, u32 *read_ptr, u32 *write_ptr,\r\nvoid *rb_base, u8 size)\r\n{\r\nrb->rb_base = rb_base;\r\nrb->size = (1 << size);\r\nrb->read_ptr = read_ptr;\r\nrb->write_ptr = write_ptr;\r\nrb->current_read_offset = *read_ptr;\r\nrb->current_write_offset = *write_ptr;\r\n}\r\nstatic void memcpy_torb(struct scif_rb *rb, void *header,\r\nvoid *msg, u32 size)\r\n{\r\nu32 size1, size2;\r\nif (header + size >= rb->rb_base + rb->size) {\r\nsize1 = (u32)(rb->rb_base + rb->size - header);\r\nsize2 = size - size1;\r\nmemcpy_toio((void __iomem __force *)header, msg, size1);\r\nmemcpy_toio((void __iomem __force *)rb->rb_base,\r\nmsg + size1, size2);\r\n} else {\r\nmemcpy_toio((void __iomem __force *)header, msg, size);\r\n}\r\n}\r\nstatic void memcpy_fromrb(struct scif_rb *rb, void *header,\r\nvoid *msg, u32 size)\r\n{\r\nu32 size1, size2;\r\nif (header + size >= rb->rb_base + rb->size) {\r\nsize1 = (u32)(rb->rb_base + rb->size - header);\r\nsize2 = size - size1;\r\nmemcpy_fromio(msg, (void __iomem __force *)header, size1);\r\nmemcpy_fromio(msg + size1,\r\n(void __iomem __force *)rb->rb_base, size2);\r\n} else {\r\nmemcpy_fromio(msg, (void __iomem __force *)header, size);\r\n}\r\n}\r\nu32 scif_rb_space(struct scif_rb *rb)\r\n{\r\nrb->current_read_offset = *rb->read_ptr;\r\nmb();\r\nreturn scif_rb_ring_space(rb->current_write_offset,\r\nrb->current_read_offset, rb->size);\r\n}\r\nint scif_rb_write(struct scif_rb *rb, void *msg, u32 size)\r\n{\r\nvoid *header;\r\nif (scif_rb_space(rb) < size)\r\nreturn -ENOMEM;\r\nheader = rb->rb_base + rb->current_write_offset;\r\nmemcpy_torb(rb, header, msg, size);\r\nrb->current_write_offset =\r\n(rb->current_write_offset + size) & (rb->size - 1);\r\nreturn 0;\r\n}\r\nvoid scif_rb_commit(struct scif_rb *rb)\r\n{\r\nwmb();\r\nACCESS_ONCE(*rb->write_ptr) = rb->current_write_offset;\r\n#ifdef CONFIG_INTEL_MIC_CARD\r\nACCESS_ONCE(*rb->write_ptr) = rb->current_write_offset;\r\n#endif\r\n}\r\nstatic void *scif_rb_get(struct scif_rb *rb, u32 size)\r\n{\r\nvoid *header = NULL;\r\nif (scif_rb_count(rb, size) >= size)\r\nheader = rb->rb_base + rb->current_read_offset;\r\nreturn header;\r\n}\r\nu32 scif_rb_get_next(struct scif_rb *rb, void *msg, u32 size)\r\n{\r\nvoid *header = NULL;\r\nint read_size = 0;\r\nheader = scif_rb_get(rb, size);\r\nif (header) {\r\nu32 next_cmd_offset =\r\n(rb->current_read_offset + size) & (rb->size - 1);\r\nread_size = size;\r\nrb->current_read_offset = next_cmd_offset;\r\nmemcpy_fromrb(rb, header, msg, size);\r\n}\r\nreturn read_size;\r\n}\r\nvoid scif_rb_update_read_ptr(struct scif_rb *rb)\r\n{\r\nu32 new_offset;\r\nnew_offset = rb->current_read_offset;\r\nmb();\r\nACCESS_ONCE(*rb->read_ptr) = new_offset;\r\n#ifdef CONFIG_INTEL_MIC_CARD\r\nACCESS_ONCE(*rb->read_ptr) = new_offset;\r\n#endif\r\n}\r\nu32 scif_rb_count(struct scif_rb *rb, u32 size)\r\n{\r\nif (scif_rb_ring_cnt(rb->current_write_offset,\r\nrb->current_read_offset,\r\nrb->size) < size) {\r\nrb->current_write_offset = *rb->write_ptr;\r\nsmp_rmb();\r\n}\r\nreturn scif_rb_ring_cnt(rb->current_write_offset,\r\nrb->current_read_offset,\r\nrb->size);\r\n}

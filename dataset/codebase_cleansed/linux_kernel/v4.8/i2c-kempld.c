static int kempld_i2c_process(struct kempld_i2c_data *i2c)\r\n{\r\nstruct kempld_device_data *pld = i2c->pld;\r\nu8 stat = kempld_read8(pld, KEMPLD_I2C_STAT);\r\nstruct i2c_msg *msg = i2c->msg;\r\nu8 addr;\r\nif (stat & I2C_STAT_TIP)\r\nreturn -EBUSY;\r\nif (i2c->state == STATE_DONE || i2c->state == STATE_ERROR) {\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_IACK);\r\nif (i2c->state == STATE_ERROR)\r\nreturn -EIO;\r\nreturn 0;\r\n}\r\nif (stat & I2C_STAT_ARBLOST) {\r\ni2c->state = STATE_ERROR;\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_STOP);\r\nreturn -EAGAIN;\r\n}\r\nif (i2c->state == STATE_INIT) {\r\nif (stat & I2C_STAT_BUSY)\r\nreturn -EBUSY;\r\ni2c->state = STATE_ADDR;\r\n}\r\nif (i2c->state == STATE_ADDR) {\r\nif (i2c->msg->flags & I2C_M_TEN) {\r\naddr = 0xf0 | ((i2c->msg->addr >> 7) & 0x6);\r\ni2c->state = STATE_ADDR10;\r\n} else {\r\naddr = (i2c->msg->addr << 1);\r\ni2c->state = STATE_START;\r\n}\r\naddr |= (i2c->msg->flags & I2C_M_RD) ? 1 : 0;\r\nkempld_write8(pld, KEMPLD_I2C_DATA, addr);\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_START);\r\nreturn 0;\r\n}\r\nif (i2c->state == STATE_ADDR10) {\r\nkempld_write8(pld, KEMPLD_I2C_DATA, i2c->msg->addr & 0xff);\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_WRITE);\r\ni2c->state = STATE_START;\r\nreturn 0;\r\n}\r\nif (i2c->state == STATE_START || i2c->state == STATE_WRITE) {\r\ni2c->state = (msg->flags & I2C_M_RD) ? STATE_READ : STATE_WRITE;\r\nif (stat & I2C_STAT_NACK) {\r\ni2c->state = STATE_ERROR;\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_STOP);\r\nreturn -ENXIO;\r\n}\r\n} else {\r\nmsg->buf[i2c->pos++] = kempld_read8(pld, KEMPLD_I2C_DATA);\r\n}\r\nif (i2c->pos >= msg->len) {\r\ni2c->nmsgs--;\r\ni2c->msg++;\r\ni2c->pos = 0;\r\nmsg = i2c->msg;\r\nif (i2c->nmsgs) {\r\nif (!(msg->flags & I2C_M_NOSTART)) {\r\ni2c->state = STATE_ADDR;\r\nreturn 0;\r\n} else {\r\ni2c->state = (msg->flags & I2C_M_RD)\r\n? STATE_READ : STATE_WRITE;\r\n}\r\n} else {\r\ni2c->state = STATE_DONE;\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_STOP);\r\nreturn 0;\r\n}\r\n}\r\nif (i2c->state == STATE_READ) {\r\nkempld_write8(pld, KEMPLD_I2C_CMD, i2c->pos == (msg->len - 1) ?\r\nI2C_CMD_READ_NACK : I2C_CMD_READ_ACK);\r\n} else {\r\nkempld_write8(pld, KEMPLD_I2C_DATA, msg->buf[i2c->pos++]);\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_WRITE);\r\n}\r\nreturn 0;\r\n}\r\nstatic int kempld_i2c_xfer(struct i2c_adapter *adap, struct i2c_msg *msgs,\r\nint num)\r\n{\r\nstruct kempld_i2c_data *i2c = i2c_get_adapdata(adap);\r\nstruct kempld_device_data *pld = i2c->pld;\r\nunsigned long timeout = jiffies + HZ;\r\nint ret;\r\ni2c->msg = msgs;\r\ni2c->pos = 0;\r\ni2c->nmsgs = num;\r\ni2c->state = STATE_INIT;\r\nwhile (time_before(jiffies, timeout)) {\r\nkempld_get_mutex(pld);\r\nret = kempld_i2c_process(i2c);\r\nkempld_release_mutex(pld);\r\nif (i2c->state == STATE_DONE || i2c->state == STATE_ERROR)\r\nreturn (i2c->state == STATE_DONE) ? num : ret;\r\nif (ret == 0)\r\ntimeout = jiffies + HZ;\r\nusleep_range(5, 15);\r\n}\r\ni2c->state = STATE_ERROR;\r\nreturn -ETIMEDOUT;\r\n}\r\nstatic void kempld_i2c_device_init(struct kempld_i2c_data *i2c)\r\n{\r\nstruct kempld_device_data *pld = i2c->pld;\r\nu16 prescale_corr;\r\nlong prescale;\r\nu8 ctrl;\r\nu8 stat;\r\nu8 cfg;\r\nctrl = kempld_read8(pld, KEMPLD_I2C_CTRL);\r\nctrl &= ~(I2C_CTRL_EN | I2C_CTRL_IEN);\r\nkempld_write8(pld, KEMPLD_I2C_CTRL, ctrl);\r\nif (bus_frequency > KEMPLD_I2C_FREQ_MAX)\r\nbus_frequency = KEMPLD_I2C_FREQ_MAX;\r\nif (pld->info.spec_major == 1)\r\nprescale = pld->pld_clock / (bus_frequency * 5) - 1000;\r\nelse\r\nprescale = pld->pld_clock / (bus_frequency * 4) - 3000;\r\nif (prescale < 0)\r\nprescale = 0;\r\nprescale_corr = prescale / 1000;\r\nif (prescale % 1000 >= 500)\r\nprescale_corr++;\r\nkempld_write8(pld, KEMPLD_I2C_PRELOW, prescale_corr & 0xff);\r\nkempld_write8(pld, KEMPLD_I2C_PREHIGH, prescale_corr >> 8);\r\ncfg = kempld_read8(pld, KEMPLD_CFG);\r\nif (i2c_gpio_mux)\r\ncfg |= KEMPLD_CFG_GPIO_I2C_MUX;\r\nelse\r\ncfg &= ~KEMPLD_CFG_GPIO_I2C_MUX;\r\nkempld_write8(pld, KEMPLD_CFG, cfg);\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_IACK);\r\nctrl |= I2C_CTRL_EN;\r\nkempld_write8(pld, KEMPLD_I2C_CTRL, ctrl);\r\nstat = kempld_read8(pld, KEMPLD_I2C_STAT);\r\nif (stat & I2C_STAT_BUSY)\r\nkempld_write8(pld, KEMPLD_I2C_CMD, I2C_CMD_STOP);\r\n}\r\nstatic u32 kempld_i2c_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_10BIT_ADDR | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int kempld_i2c_probe(struct platform_device *pdev)\r\n{\r\nstruct kempld_device_data *pld = dev_get_drvdata(pdev->dev.parent);\r\nstruct kempld_i2c_data *i2c;\r\nint ret;\r\nu8 ctrl;\r\ni2c = devm_kzalloc(&pdev->dev, sizeof(*i2c), GFP_KERNEL);\r\nif (!i2c)\r\nreturn -ENOMEM;\r\ni2c->pld = pld;\r\ni2c->dev = &pdev->dev;\r\ni2c->adap = kempld_i2c_adapter;\r\ni2c->adap.dev.parent = i2c->dev;\r\ni2c_set_adapdata(&i2c->adap, i2c);\r\nplatform_set_drvdata(pdev, i2c);\r\nkempld_get_mutex(pld);\r\nctrl = kempld_read8(pld, KEMPLD_I2C_CTRL);\r\nif (ctrl & I2C_CTRL_EN)\r\ni2c->was_active = true;\r\nkempld_i2c_device_init(i2c);\r\nkempld_release_mutex(pld);\r\nif (i2c_bus >= -1)\r\ni2c->adap.nr = i2c_bus;\r\nret = i2c_add_numbered_adapter(&i2c->adap);\r\nif (ret)\r\nreturn ret;\r\ndev_info(i2c->dev, "I2C bus initialized at %dkHz\n",\r\nbus_frequency);\r\nreturn 0;\r\n}\r\nstatic int kempld_i2c_remove(struct platform_device *pdev)\r\n{\r\nstruct kempld_i2c_data *i2c = platform_get_drvdata(pdev);\r\nstruct kempld_device_data *pld = i2c->pld;\r\nu8 ctrl;\r\nkempld_get_mutex(pld);\r\nif (!i2c->was_active) {\r\nctrl = kempld_read8(pld, KEMPLD_I2C_CTRL);\r\nctrl &= ~I2C_CTRL_EN;\r\nkempld_write8(pld, KEMPLD_I2C_CTRL, ctrl);\r\n}\r\nkempld_release_mutex(pld);\r\ni2c_del_adapter(&i2c->adap);\r\nreturn 0;\r\n}\r\nstatic int kempld_i2c_suspend(struct platform_device *pdev, pm_message_t state)\r\n{\r\nstruct kempld_i2c_data *i2c = platform_get_drvdata(pdev);\r\nstruct kempld_device_data *pld = i2c->pld;\r\nu8 ctrl;\r\nkempld_get_mutex(pld);\r\nctrl = kempld_read8(pld, KEMPLD_I2C_CTRL);\r\nctrl &= ~I2C_CTRL_EN;\r\nkempld_write8(pld, KEMPLD_I2C_CTRL, ctrl);\r\nkempld_release_mutex(pld);\r\nreturn 0;\r\n}\r\nstatic int kempld_i2c_resume(struct platform_device *pdev)\r\n{\r\nstruct kempld_i2c_data *i2c = platform_get_drvdata(pdev);\r\nstruct kempld_device_data *pld = i2c->pld;\r\nkempld_get_mutex(pld);\r\nkempld_i2c_device_init(i2c);\r\nkempld_release_mutex(pld);\r\nreturn 0;\r\n}

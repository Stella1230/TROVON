static int wf_max6690_get(struct wf_sensor *sr, s32 *value)\r\n{\r\nstruct wf_6690_sensor *max = wf_to_6690(sr);\r\ns32 data;\r\nif (max->i2c == NULL)\r\nreturn -ENODEV;\r\ndata = i2c_smbus_read_byte_data(max->i2c, MAX6690_EXTERNAL_TEMP);\r\nif (data < 0)\r\nreturn data;\r\n*value = data << 16;\r\nreturn 0;\r\n}\r\nstatic void wf_max6690_release(struct wf_sensor *sr)\r\n{\r\nstruct wf_6690_sensor *max = wf_to_6690(sr);\r\nkfree(max);\r\n}\r\nstatic int wf_max6690_probe(struct i2c_client *client,\r\nconst struct i2c_device_id *id)\r\n{\r\nconst char *name, *loc;\r\nstruct wf_6690_sensor *max;\r\nint rc;\r\nloc = of_get_property(client->dev.of_node, "hwsensor-location", NULL);\r\nif (!loc) {\r\ndev_warn(&client->dev, "Missing hwsensor-location property!\n");\r\nreturn -ENXIO;\r\n}\r\nif (!strcmp(loc, "BACKSIDE") || !strcmp(loc, "SYS CTRLR AMBIENT"))\r\nname = "backside-temp";\r\nelse if (!strcmp(loc, "NB Ambient"))\r\nname = "north-bridge-temp";\r\nelse if (!strcmp(loc, "GPU Ambient"))\r\nname = "gpu-temp";\r\nelse\r\nreturn -ENXIO;\r\nmax = kzalloc(sizeof(struct wf_6690_sensor), GFP_KERNEL);\r\nif (max == NULL) {\r\nprintk(KERN_ERR "windfarm: Couldn't create MAX6690 sensor: "\r\n"no memory\n");\r\nreturn -ENOMEM;\r\n}\r\nmax->i2c = client;\r\nmax->sens.name = name;\r\nmax->sens.ops = &wf_max6690_ops;\r\ni2c_set_clientdata(client, max);\r\nrc = wf_register_sensor(&max->sens);\r\nif (rc)\r\nkfree(max);\r\nreturn rc;\r\n}\r\nstatic int wf_max6690_remove(struct i2c_client *client)\r\n{\r\nstruct wf_6690_sensor *max = i2c_get_clientdata(client);\r\nmax->i2c = NULL;\r\nwf_unregister_sensor(&max->sens);\r\nreturn 0;\r\n}

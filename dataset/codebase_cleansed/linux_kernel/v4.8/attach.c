static int ath5k_hw_post(struct ath5k_hw *ah)\r\n{\r\nstatic const u32 static_pattern[4] = {\r\n0x55555555, 0xaaaaaaaa,\r\n0x66666666, 0x99999999\r\n};\r\nstatic const u16 regs[2] = { AR5K_STA_ID0, AR5K_PHY(8) };\r\nint i, c;\r\nu16 cur_reg;\r\nu32 var_pattern;\r\nu32 init_val;\r\nu32 cur_val;\r\nfor (c = 0; c < 2; c++) {\r\ncur_reg = regs[c];\r\ninit_val = ath5k_hw_reg_read(ah, cur_reg);\r\nfor (i = 0; i < 256; i++) {\r\nvar_pattern = i << 16 | i;\r\nath5k_hw_reg_write(ah, var_pattern, cur_reg);\r\ncur_val = ath5k_hw_reg_read(ah, cur_reg);\r\nif (cur_val != var_pattern) {\r\nATH5K_ERR(ah, "POST Failed !!!\n");\r\nreturn -EAGAIN;\r\n}\r\nvar_pattern = 0x0039080f;\r\nath5k_hw_reg_write(ah, var_pattern, cur_reg);\r\n}\r\nfor (i = 0; i < 4; i++) {\r\nvar_pattern = static_pattern[i];\r\nath5k_hw_reg_write(ah, var_pattern, cur_reg);\r\ncur_val = ath5k_hw_reg_read(ah, cur_reg);\r\nif (cur_val != var_pattern) {\r\nATH5K_ERR(ah, "POST Failed !!!\n");\r\nreturn -EAGAIN;\r\n}\r\nvar_pattern = 0x003b080f;\r\nath5k_hw_reg_write(ah, var_pattern, cur_reg);\r\n}\r\nath5k_hw_reg_write(ah, init_val, cur_reg);\r\n}\r\nreturn 0;\r\n}\r\nint ath5k_hw_init(struct ath5k_hw *ah)\r\n{\r\nstatic const u8 zero_mac[ETH_ALEN] = { };\r\nstruct ath_common *common = ath5k_hw_common(ah);\r\nstruct pci_dev *pdev = ah->pdev;\r\nstruct ath5k_eeprom_info *ee;\r\nint ret;\r\nu32 srev;\r\nah->ah_bwmode = AR5K_BWMODE_DEFAULT;\r\nah->ah_txpower.txp_tpc = AR5K_TUNE_TPC_TXPOWER;\r\nah->ah_imr = 0;\r\nah->ah_retry_short = AR5K_INIT_RETRY_SHORT;\r\nah->ah_retry_long = AR5K_INIT_RETRY_LONG;\r\nah->ah_ant_mode = AR5K_ANTMODE_DEFAULT;\r\nah->ah_noise_floor = -95;\r\nah->ani_state.ani_mode = ATH5K_ANI_MODE_AUTO;\r\nah->ah_current_channel = &ah->channels[0];\r\nath5k_hw_read_srev(ah);\r\nsrev = ah->ah_mac_srev;\r\nif (srev < AR5K_SREV_AR5311)\r\nah->ah_version = AR5K_AR5210;\r\nelse if (srev < AR5K_SREV_AR5212)\r\nah->ah_version = AR5K_AR5211;\r\nelse\r\nah->ah_version = AR5K_AR5212;\r\nah->ah_mac_version = AR5K_REG_MS(srev, AR5K_SREV_VER);\r\nret = ath5k_hw_init_desc_functions(ah);\r\nif (ret)\r\ngoto err;\r\nret = ath5k_hw_nic_wakeup(ah, NULL);\r\nif (ret)\r\ngoto err;\r\nah->ah_phy_revision = ath5k_hw_reg_read(ah, AR5K_PHY_CHIP_ID) &\r\n0xffffffff;\r\nah->ah_radio_5ghz_revision = ath5k_hw_radio_revision(ah,\r\nNL80211_BAND_5GHZ);\r\nswitch (ah->ah_radio_5ghz_revision & 0xf0) {\r\ncase AR5K_SREV_RAD_5111:\r\nah->ah_radio = AR5K_RF5111;\r\nah->ah_single_chip = false;\r\nah->ah_radio_2ghz_revision = ath5k_hw_radio_revision(ah,\r\nNL80211_BAND_2GHZ);\r\nbreak;\r\ncase AR5K_SREV_RAD_5112:\r\ncase AR5K_SREV_RAD_2112:\r\nah->ah_radio = AR5K_RF5112;\r\nah->ah_single_chip = false;\r\nah->ah_radio_2ghz_revision = ath5k_hw_radio_revision(ah,\r\nNL80211_BAND_2GHZ);\r\nbreak;\r\ncase AR5K_SREV_RAD_2413:\r\nah->ah_radio = AR5K_RF2413;\r\nah->ah_single_chip = true;\r\nbreak;\r\ncase AR5K_SREV_RAD_5413:\r\nah->ah_radio = AR5K_RF5413;\r\nah->ah_single_chip = true;\r\nbreak;\r\ncase AR5K_SREV_RAD_2316:\r\nah->ah_radio = AR5K_RF2316;\r\nah->ah_single_chip = true;\r\nbreak;\r\ncase AR5K_SREV_RAD_2317:\r\nah->ah_radio = AR5K_RF2317;\r\nah->ah_single_chip = true;\r\nbreak;\r\ncase AR5K_SREV_RAD_5424:\r\nif (ah->ah_mac_version == AR5K_SREV_AR2425 ||\r\nah->ah_mac_version == AR5K_SREV_AR2417) {\r\nah->ah_radio = AR5K_RF2425;\r\nah->ah_single_chip = true;\r\n} else {\r\nah->ah_radio = AR5K_RF5413;\r\nah->ah_single_chip = true;\r\n}\r\nbreak;\r\ndefault:\r\nif (ah->ah_version == AR5K_AR5210) {\r\nah->ah_radio = AR5K_RF5110;\r\nah->ah_single_chip = false;\r\n} else if (ah->ah_version == AR5K_AR5211) {\r\nah->ah_radio = AR5K_RF5111;\r\nah->ah_single_chip = false;\r\nah->ah_radio_2ghz_revision = ath5k_hw_radio_revision(ah,\r\nNL80211_BAND_2GHZ);\r\n} else if (ah->ah_mac_version == (AR5K_SREV_AR2425 >> 4) ||\r\nah->ah_mac_version == (AR5K_SREV_AR2417 >> 4) ||\r\nah->ah_phy_revision == AR5K_SREV_PHY_2425) {\r\nah->ah_radio = AR5K_RF2425;\r\nah->ah_single_chip = true;\r\nah->ah_radio_5ghz_revision = AR5K_SREV_RAD_2425;\r\n} else if (srev == AR5K_SREV_AR5213A &&\r\nah->ah_phy_revision == AR5K_SREV_PHY_5212B) {\r\nah->ah_radio = AR5K_RF5112;\r\nah->ah_single_chip = false;\r\nah->ah_radio_5ghz_revision = AR5K_SREV_RAD_5112B;\r\n} else if (ah->ah_mac_version == (AR5K_SREV_AR2415 >> 4) ||\r\nah->ah_mac_version == (AR5K_SREV_AR2315_R6 >> 4)) {\r\nah->ah_radio = AR5K_RF2316;\r\nah->ah_single_chip = true;\r\nah->ah_radio_5ghz_revision = AR5K_SREV_RAD_2316;\r\n} else if (ah->ah_mac_version == (AR5K_SREV_AR5414 >> 4) ||\r\nah->ah_phy_revision == AR5K_SREV_PHY_5413) {\r\nah->ah_radio = AR5K_RF5413;\r\nah->ah_single_chip = true;\r\nah->ah_radio_5ghz_revision = AR5K_SREV_RAD_5413;\r\n} else if (ah->ah_mac_version == (AR5K_SREV_AR2414 >> 4) ||\r\nah->ah_phy_revision == AR5K_SREV_PHY_2413) {\r\nah->ah_radio = AR5K_RF2413;\r\nah->ah_single_chip = true;\r\nah->ah_radio_5ghz_revision = AR5K_SREV_RAD_2413;\r\n} else {\r\nATH5K_ERR(ah, "Couldn't identify radio revision.\n");\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\n}\r\nif ((srev >= AR5K_SREV_AR5416) && (srev < AR5K_SREV_AR2425)) {\r\nATH5K_ERR(ah, "Device not yet supported.\n");\r\nret = -ENODEV;\r\ngoto err;\r\n}\r\nret = ath5k_hw_post(ah);\r\nif (ret)\r\ngoto err;\r\nif (srev >= AR5K_SREV_AR5213A)\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_PCICFG, AR5K_PCICFG_RETRY_FIX);\r\nret = ath5k_eeprom_init(ah);\r\nif (ret) {\r\nATH5K_ERR(ah, "unable to init EEPROM\n");\r\ngoto err;\r\n}\r\nee = &ah->ah_capabilities.cap_eeprom;\r\nif ((ah->ah_version == AR5K_AR5212) && pdev && (pci_is_pcie(pdev))) {\r\nath5k_hw_reg_write(ah, 0x9248fc00, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x24924924, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x28000039, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x53160824, AR5K_PCIE_SERDES);\r\nif (ee->ee_serdes)\r\nath5k_hw_reg_write(ah, 0xe5980579, AR5K_PCIE_SERDES);\r\nelse\r\nath5k_hw_reg_write(ah, 0xf6800579, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x001defff, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x1aaabe40, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0xbe105554, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x000e3007, AR5K_PCIE_SERDES);\r\nath5k_hw_reg_write(ah, 0x00000000, AR5K_PCIE_SERDES_RESET);\r\nusleep_range(1000, 1500);\r\n}\r\nret = ath5k_hw_set_capabilities(ah);\r\nif (ret) {\r\nATH5K_ERR(ah, "unable to get device capabilities\n");\r\ngoto err;\r\n}\r\ncommon->keymax = (ah->ah_version == AR5K_AR5210 ?\r\nAR5K_KEYTABLE_SIZE_5210 : AR5K_KEYTABLE_SIZE_5211);\r\nif (srev >= AR5K_SREV_AR5212_V4 &&\r\n(ee->ee_version < AR5K_EEPROM_VERSION_5_0 ||\r\n!AR5K_EEPROM_AES_DIS(ee->ee_misc5)))\r\ncommon->crypt_caps |= ATH_CRYPT_CAP_CIPHER_AESCCM;\r\nif (srev >= AR5K_SREV_AR2414) {\r\ncommon->crypt_caps |= ATH_CRYPT_CAP_MIC_COMBINED;\r\nAR5K_REG_ENABLE_BITS(ah, AR5K_MISC_MODE,\r\nAR5K_MISC_MODE_COMBINED_MIC);\r\n}\r\nath5k_hw_set_lladdr(ah, zero_mac);\r\nmemcpy(common->curbssid, ath_bcast_mac, ETH_ALEN);\r\nath5k_hw_set_bssid(ah);\r\nath5k_hw_set_opmode(ah, ah->opmode);\r\nath5k_hw_rfgain_opt_init(ah);\r\nath5k_hw_init_nfcal_hist(ah);\r\nath5k_hw_set_ledstate(ah, AR5K_LED_INIT);\r\nreturn 0;\r\nerr:\r\nreturn ret;\r\n}\r\nvoid ath5k_hw_deinit(struct ath5k_hw *ah)\r\n{\r\n__set_bit(ATH_STAT_INVALID, ah->status);\r\nkfree(ah->ah_rf_banks);\r\nath5k_eeprom_detach(ah);\r\n}

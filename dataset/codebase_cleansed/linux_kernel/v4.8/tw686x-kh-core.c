static irqreturn_t tw686x_irq(int irq, void *dev_id)\r\n{\r\nstruct tw686x_dev *dev = (struct tw686x_dev *)dev_id;\r\nu32 int_status = reg_read(dev, INT_STATUS);\r\nunsigned long flags;\r\nunsigned int handled = 0;\r\nif (int_status) {\r\nspin_lock_irqsave(&dev->irq_lock, flags);\r\ndev->dma_requests |= int_status;\r\nspin_unlock_irqrestore(&dev->irq_lock, flags);\r\nif (int_status & 0xFF0000FF)\r\nhandled = tw686x_kh_video_irq(dev);\r\n}\r\nreturn IRQ_RETVAL(handled);\r\n}\r\nstatic int tw686x_probe(struct pci_dev *pci_dev,\r\nconst struct pci_device_id *pci_id)\r\n{\r\nstruct tw686x_dev *dev;\r\nint err;\r\ndev = devm_kzalloc(&pci_dev->dev, sizeof(*dev) +\r\n(pci_id->driver_data & TYPE_MAX_CHANNELS) *\r\nsizeof(dev->video_channels[0]), GFP_KERNEL);\r\nif (!dev)\r\nreturn -ENOMEM;\r\nsprintf(dev->name, "TW%04X", pci_dev->device);\r\ndev->type = pci_id->driver_data;\r\npr_info("%s: PCI %s, IRQ %d, MMIO 0x%lx\n", dev->name,\r\npci_name(pci_dev), pci_dev->irq,\r\n(unsigned long)pci_resource_start(pci_dev, 0));\r\ndev->pci_dev = pci_dev;\r\nif (pcim_enable_device(pci_dev))\r\nreturn -EIO;\r\npci_set_master(pci_dev);\r\nif (pci_set_dma_mask(pci_dev, DMA_BIT_MASK(32))) {\r\npr_err("%s: 32-bit PCI DMA not supported\n", dev->name);\r\nreturn -EIO;\r\n}\r\nerr = pci_request_regions(pci_dev, dev->name);\r\nif (err < 0) {\r\npr_err("%s: Unable to get MMIO region\n", dev->name);\r\nreturn err;\r\n}\r\ndev->mmio = pci_ioremap_bar(pci_dev, 0);\r\nif (!dev->mmio) {\r\npr_err("%s: Unable to remap MMIO region\n", dev->name);\r\nreturn -EIO;\r\n}\r\nreg_write(dev, SYS_SOFT_RST, 0x0F);\r\nmdelay(1);\r\nreg_write(dev, SRST[0], 0x3F);\r\nif (max_channels(dev) > 4)\r\nreg_write(dev, SRST[1], 0x3F);\r\nreg_write(dev, DMA_CMD, 0);\r\nreg_write(dev, DMA_CHANNEL_ENABLE, 0);\r\nreg_write(dev, DMA_CHANNEL_TIMEOUT, 0x3EFF0FF0);\r\nreg_write(dev, DMA_TIMER_INTERVAL, 0x38000);\r\nreg_write(dev, DMA_CONFIG, 0xFFFFFF04);\r\nspin_lock_init(&dev->irq_lock);\r\nerr = devm_request_irq(&pci_dev->dev, pci_dev->irq, tw686x_irq,\r\nIRQF_SHARED, dev->name, dev);\r\nif (err < 0) {\r\npr_err("%s: Unable to get IRQ\n", dev->name);\r\nreturn err;\r\n}\r\nerr = tw686x_kh_video_init(dev);\r\nif (err)\r\nreturn err;\r\npci_set_drvdata(pci_dev, dev);\r\nreturn 0;\r\n}\r\nstatic void tw686x_remove(struct pci_dev *pci_dev)\r\n{\r\nstruct tw686x_dev *dev = pci_get_drvdata(pci_dev);\r\ntw686x_kh_video_free(dev);\r\n}

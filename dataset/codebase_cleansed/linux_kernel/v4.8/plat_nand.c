static int plat_nand_probe(struct platform_device *pdev)\r\n{\r\nstruct platform_nand_data *pdata = dev_get_platdata(&pdev->dev);\r\nstruct plat_nand_data *data;\r\nstruct mtd_info *mtd;\r\nstruct resource *res;\r\nconst char **part_types;\r\nint err = 0;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "platform_nand_data is missing\n");\r\nreturn -EINVAL;\r\n}\r\nif (pdata->chip.nr_chips < 1) {\r\ndev_err(&pdev->dev, "invalid number of chips specified\n");\r\nreturn -EINVAL;\r\n}\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct plat_nand_data),\r\nGFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\ndata->io_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(data->io_base))\r\nreturn PTR_ERR(data->io_base);\r\nnand_set_flash_node(&data->chip, pdev->dev.of_node);\r\nmtd = nand_to_mtd(&data->chip);\r\nmtd->dev.parent = &pdev->dev;\r\ndata->chip.IO_ADDR_R = data->io_base;\r\ndata->chip.IO_ADDR_W = data->io_base;\r\ndata->chip.cmd_ctrl = pdata->ctrl.cmd_ctrl;\r\ndata->chip.dev_ready = pdata->ctrl.dev_ready;\r\ndata->chip.select_chip = pdata->ctrl.select_chip;\r\ndata->chip.write_buf = pdata->ctrl.write_buf;\r\ndata->chip.read_buf = pdata->ctrl.read_buf;\r\ndata->chip.read_byte = pdata->ctrl.read_byte;\r\ndata->chip.chip_delay = pdata->chip.chip_delay;\r\ndata->chip.options |= pdata->chip.options;\r\ndata->chip.bbt_options |= pdata->chip.bbt_options;\r\ndata->chip.ecc.hwctl = pdata->ctrl.hwcontrol;\r\ndata->chip.ecc.mode = NAND_ECC_SOFT;\r\ndata->chip.ecc.algo = NAND_ECC_HAMMING;\r\nplatform_set_drvdata(pdev, data);\r\nif (pdata->ctrl.probe) {\r\nerr = pdata->ctrl.probe(pdev);\r\nif (err)\r\ngoto out;\r\n}\r\nif (nand_scan(mtd, pdata->chip.nr_chips)) {\r\nerr = -ENXIO;\r\ngoto out;\r\n}\r\npart_types = pdata->chip.part_probe_types;\r\nerr = mtd_device_parse_register(mtd, part_types, NULL,\r\npdata->chip.partitions,\r\npdata->chip.nr_partitions);\r\nif (!err)\r\nreturn err;\r\nnand_release(mtd);\r\nout:\r\nif (pdata->ctrl.remove)\r\npdata->ctrl.remove(pdev);\r\nreturn err;\r\n}\r\nstatic int plat_nand_remove(struct platform_device *pdev)\r\n{\r\nstruct plat_nand_data *data = platform_get_drvdata(pdev);\r\nstruct platform_nand_data *pdata = dev_get_platdata(&pdev->dev);\r\nnand_release(nand_to_mtd(&data->chip));\r\nif (pdata->ctrl.remove)\r\npdata->ctrl.remove(pdev);\r\nreturn 0;\r\n}

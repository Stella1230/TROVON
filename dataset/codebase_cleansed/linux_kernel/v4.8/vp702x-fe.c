static int vp702x_fe_refresh_state(struct vp702x_fe_state *st)\r\n{\r\nstruct vp702x_device_state *dst = st->d->priv;\r\nu8 *buf;\r\nif (time_after(jiffies, st->next_status_check)) {\r\nmutex_lock(&dst->buf_mutex);\r\nbuf = dst->buf;\r\nvp702x_usb_in_op(st->d, READ_STATUS, 0, 0, buf, 10);\r\nst->lock = buf[4];\r\nvp702x_usb_in_op(st->d, READ_TUNER_REG_REQ, 0x11, 0, buf, 1);\r\nst->snr = buf[0];\r\nvp702x_usb_in_op(st->d, READ_TUNER_REG_REQ, 0x15, 0, buf, 1);\r\nst->sig = buf[0];\r\nmutex_unlock(&dst->buf_mutex);\r\nst->next_status_check = jiffies + (st->status_check_interval*HZ)/1000;\r\n}\r\nreturn 0;\r\n}\r\nstatic u8 vp702x_chksum(u8 *buf,int f, int count)\r\n{\r\nu8 s = 0;\r\nint i;\r\nfor (i = f; i < f+count; i++)\r\ns += buf[i];\r\nreturn ~s+1;\r\n}\r\nstatic int vp702x_fe_read_status(struct dvb_frontend *fe,\r\nenum fe_status *status)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nvp702x_fe_refresh_state(st);\r\ndeb_fe("%s\n",__func__);\r\nif (st->lock == 0)\r\n*status = FE_HAS_LOCK | FE_HAS_SYNC | FE_HAS_VITERBI | FE_HAS_SIGNAL | FE_HAS_CARRIER;\r\nelse\r\n*status = 0;\r\nif (*status & FE_HAS_LOCK)\r\nst->status_check_interval = 1000;\r\nelse\r\nst->status_check_interval = 250;\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_read_ber(struct dvb_frontend* fe, u32 *ber)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nvp702x_fe_refresh_state(st);\r\n*ber = 0;\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_read_unc_blocks(struct dvb_frontend* fe, u32 *unc)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nvp702x_fe_refresh_state(st);\r\n*unc = 0;\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_read_signal_strength(struct dvb_frontend* fe, u16 *strength)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nvp702x_fe_refresh_state(st);\r\n*strength = (st->sig << 8) | st->sig;\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_read_snr(struct dvb_frontend* fe, u16 *snr)\r\n{\r\nu8 _snr;\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nvp702x_fe_refresh_state(st);\r\n_snr = (st->snr & 0x1f) * 0xff / 0x1f;\r\n*snr = (_snr << 8) | _snr;\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_get_tune_settings(struct dvb_frontend* fe, struct dvb_frontend_tune_settings *tune)\r\n{\r\ndeb_fe("%s\n",__func__);\r\ntune->min_delay_ms = 2000;\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_set_frontend(struct dvb_frontend *fe)\r\n{\r\nstruct dtv_frontend_properties *fep = &fe->dtv_property_cache;\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nstruct vp702x_device_state *dst = st->d->priv;\r\nu32 freq = fep->frequency/1000;\r\nu64 sr;\r\nu8 *cmd;\r\nmutex_lock(&dst->buf_mutex);\r\ncmd = dst->buf;\r\nmemset(cmd, 0, 10);\r\ncmd[0] = (freq >> 8) & 0x7f;\r\ncmd[1] = freq & 0xff;\r\ncmd[2] = 1;\r\nsr = (u64) (fep->symbol_rate/1000) << 20;\r\ndo_div(sr,88000);\r\ncmd[3] = (sr >> 12) & 0xff;\r\ncmd[4] = (sr >> 4) & 0xff;\r\ncmd[5] = (sr << 4) & 0xf0;\r\ndeb_fe("setting frontend to: %u -> %u (%x) LNB-based GHz, symbolrate: %d -> %lu (%lx)\n",\r\nfep->frequency, freq, freq, fep->symbol_rate,\r\n(unsigned long) sr, (unsigned long) sr);\r\nif (st->voltage == SEC_VOLTAGE_18)\r\ncmd[6] |= 0x40;\r\ncmd[7] = vp702x_chksum(cmd,0,7);\r\nst->status_check_interval = 250;\r\nst->next_status_check = jiffies;\r\nvp702x_usb_inout_op(st->d, cmd, 8, cmd, 10, 100);\r\nif (cmd[2] == 0 && cmd[3] == 0)\r\ndeb_fe("tuning failed.\n");\r\nelse\r\ndeb_fe("tuning succeeded.\n");\r\nmutex_unlock(&dst->buf_mutex);\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_init(struct dvb_frontend *fe)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\ndeb_fe("%s\n",__func__);\r\nvp702x_usb_in_op(st->d, RESET_TUNER, 0, 0, NULL, 0);\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_sleep(struct dvb_frontend *fe)\r\n{\r\ndeb_fe("%s\n",__func__);\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_send_diseqc_msg (struct dvb_frontend* fe,\r\nstruct dvb_diseqc_master_cmd *m)\r\n{\r\nu8 *cmd;\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nstruct vp702x_device_state *dst = st->d->priv;\r\ndeb_fe("%s\n",__func__);\r\nif (m->msg_len > 4)\r\nreturn -EINVAL;\r\nmutex_lock(&dst->buf_mutex);\r\ncmd = dst->buf;\r\ncmd[1] = SET_DISEQC_CMD;\r\ncmd[2] = m->msg_len;\r\nmemcpy(&cmd[3], m->msg, m->msg_len);\r\ncmd[7] = vp702x_chksum(cmd, 0, 7);\r\nvp702x_usb_inout_op(st->d, cmd, 8, cmd, 10, 100);\r\nif (cmd[2] == 0 && cmd[3] == 0)\r\ndeb_fe("diseqc cmd failed.\n");\r\nelse\r\ndeb_fe("diseqc cmd succeeded.\n");\r\nmutex_unlock(&dst->buf_mutex);\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_send_diseqc_burst(struct dvb_frontend *fe,\r\nenum fe_sec_mini_cmd burst)\r\n{\r\ndeb_fe("%s\n",__func__);\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_set_tone(struct dvb_frontend *fe,\r\nenum fe_sec_tone_mode tone)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nstruct vp702x_device_state *dst = st->d->priv;\r\nu8 *buf;\r\ndeb_fe("%s\n",__func__);\r\nst->tone_mode = tone;\r\nif (tone == SEC_TONE_ON)\r\nst->lnb_buf[2] = 0x02;\r\nelse\r\nst->lnb_buf[2] = 0x00;\r\nst->lnb_buf[7] = vp702x_chksum(st->lnb_buf, 0, 7);\r\nmutex_lock(&dst->buf_mutex);\r\nbuf = dst->buf;\r\nmemcpy(buf, st->lnb_buf, 8);\r\nvp702x_usb_inout_op(st->d, buf, 8, buf, 10, 100);\r\nif (buf[2] == 0 && buf[3] == 0)\r\ndeb_fe("set_tone cmd failed.\n");\r\nelse\r\ndeb_fe("set_tone cmd succeeded.\n");\r\nmutex_unlock(&dst->buf_mutex);\r\nreturn 0;\r\n}\r\nstatic int vp702x_fe_set_voltage(struct dvb_frontend *fe,\r\nenum fe_sec_voltage voltage)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nstruct vp702x_device_state *dst = st->d->priv;\r\nu8 *buf;\r\ndeb_fe("%s\n",__func__);\r\nst->voltage = voltage;\r\nif (voltage != SEC_VOLTAGE_OFF)\r\nst->lnb_buf[4] = 0x01;\r\nelse\r\nst->lnb_buf[4] = 0x00;\r\nst->lnb_buf[7] = vp702x_chksum(st->lnb_buf, 0, 7);\r\nmutex_lock(&dst->buf_mutex);\r\nbuf = dst->buf;\r\nmemcpy(buf, st->lnb_buf, 8);\r\nvp702x_usb_inout_op(st->d, buf, 8, buf, 10, 100);\r\nif (buf[2] == 0 && buf[3] == 0)\r\ndeb_fe("set_voltage cmd failed.\n");\r\nelse\r\ndeb_fe("set_voltage cmd succeeded.\n");\r\nmutex_unlock(&dst->buf_mutex);\r\nreturn 0;\r\n}\r\nstatic void vp702x_fe_release(struct dvb_frontend* fe)\r\n{\r\nstruct vp702x_fe_state *st = fe->demodulator_priv;\r\nkfree(st);\r\n}\r\nstruct dvb_frontend * vp702x_fe_attach(struct dvb_usb_device *d)\r\n{\r\nstruct vp702x_fe_state *s = kzalloc(sizeof(struct vp702x_fe_state), GFP_KERNEL);\r\nif (s == NULL)\r\ngoto error;\r\ns->d = d;\r\nmemcpy(&s->fe.ops,&vp702x_fe_ops,sizeof(struct dvb_frontend_ops));\r\ns->fe.demodulator_priv = s;\r\ns->lnb_buf[1] = SET_LNB_POWER;\r\ns->lnb_buf[3] = 0xff;\r\nreturn &s->fe;\r\nerror:\r\nreturn NULL;\r\n}

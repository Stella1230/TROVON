static struct device_node *find_dcr_parent(struct device_node *node)\r\n{\r\nstruct device_node *par, *tmp;\r\nconst u32 *p;\r\nfor (par = of_node_get(node); par;) {\r\nif (of_get_property(par, "dcr-controller", NULL))\r\nbreak;\r\np = of_get_property(par, "dcr-parent", NULL);\r\ntmp = par;\r\nif (p == NULL)\r\npar = of_get_parent(par);\r\nelse\r\npar = of_find_node_by_phandle(*p);\r\nof_node_put(tmp);\r\n}\r\nreturn par;\r\n}\r\nbool dcr_map_ok_generic(dcr_host_t host)\r\n{\r\nif (host.type == DCR_HOST_NATIVE)\r\nreturn dcr_map_ok_native(host.host.native);\r\nelse if (host.type == DCR_HOST_MMIO)\r\nreturn dcr_map_ok_mmio(host.host.mmio);\r\nelse\r\nreturn false;\r\n}\r\ndcr_host_t dcr_map_generic(struct device_node *dev,\r\nunsigned int dcr_n,\r\nunsigned int dcr_c)\r\n{\r\ndcr_host_t host;\r\nstruct device_node *dp;\r\nconst char *prop;\r\nhost.type = DCR_HOST_INVALID;\r\ndp = find_dcr_parent(dev);\r\nif (dp == NULL)\r\nreturn host;\r\nprop = of_get_property(dp, "dcr-access-method", NULL);\r\npr_debug("dcr_map_generic(dcr-access-method = %s)\n", prop);\r\nif (!strcmp(prop, "native")) {\r\nhost.type = DCR_HOST_NATIVE;\r\nhost.host.native = dcr_map_native(dev, dcr_n, dcr_c);\r\n} else if (!strcmp(prop, "mmio")) {\r\nhost.type = DCR_HOST_MMIO;\r\nhost.host.mmio = dcr_map_mmio(dev, dcr_n, dcr_c);\r\n}\r\nof_node_put(dp);\r\nreturn host;\r\n}\r\nvoid dcr_unmap_generic(dcr_host_t host, unsigned int dcr_c)\r\n{\r\nif (host.type == DCR_HOST_NATIVE)\r\ndcr_unmap_native(host.host.native, dcr_c);\r\nelse if (host.type == DCR_HOST_MMIO)\r\ndcr_unmap_mmio(host.host.mmio, dcr_c);\r\nelse\r\nWARN_ON(true);\r\n}\r\nu32 dcr_read_generic(dcr_host_t host, unsigned int dcr_n)\r\n{\r\nif (host.type == DCR_HOST_NATIVE)\r\nreturn dcr_read_native(host.host.native, dcr_n);\r\nelse if (host.type == DCR_HOST_MMIO)\r\nreturn dcr_read_mmio(host.host.mmio, dcr_n);\r\nelse\r\nWARN_ON(true);\r\nreturn 0;\r\n}\r\nvoid dcr_write_generic(dcr_host_t host, unsigned int dcr_n, u32 value)\r\n{\r\nif (host.type == DCR_HOST_NATIVE)\r\ndcr_write_native(host.host.native, dcr_n, value);\r\nelse if (host.type == DCR_HOST_MMIO)\r\ndcr_write_mmio(host.host.mmio, dcr_n, value);\r\nelse\r\nWARN_ON(true);\r\n}\r\nunsigned int dcr_resource_start(const struct device_node *np,\r\nunsigned int index)\r\n{\r\nunsigned int ds;\r\nconst u32 *dr = of_get_property(np, "dcr-reg", &ds);\r\nif (dr == NULL || ds & 1 || index >= (ds / 8))\r\nreturn 0;\r\nreturn dr[index * 2];\r\n}\r\nunsigned int dcr_resource_len(const struct device_node *np, unsigned int index)\r\n{\r\nunsigned int ds;\r\nconst u32 *dr = of_get_property(np, "dcr-reg", &ds);\r\nif (dr == NULL || ds & 1 || index >= (ds / 8))\r\nreturn 0;\r\nreturn dr[index * 2 + 1];\r\n}\r\nstatic u64 of_translate_dcr_address(struct device_node *dev,\r\nunsigned int dcr_n,\r\nunsigned int *out_stride)\r\n{\r\nstruct device_node *dp;\r\nconst u32 *p;\r\nunsigned int stride;\r\nu64 ret = OF_BAD_ADDR;\r\ndp = find_dcr_parent(dev);\r\nif (dp == NULL)\r\nreturn OF_BAD_ADDR;\r\np = of_get_property(dp, "dcr-mmio-stride", NULL);\r\nstride = (p == NULL) ? 0x10 : *p;\r\np = of_get_property(dp, "dcr-mmio-range", NULL);\r\nif (p == NULL)\r\np = of_get_property(dp, "dcr-mmio-space", NULL);\r\nif (p == NULL)\r\ngoto done;\r\nret = of_translate_address(dp, p);\r\nif (ret != OF_BAD_ADDR)\r\nret += (u64)(stride) * (u64)dcr_n;\r\nif (out_stride)\r\n*out_stride = stride;\r\ndone:\r\nof_node_put(dp);\r\nreturn ret;\r\n}\r\ndcr_host_mmio_t dcr_map_mmio(struct device_node *dev,\r\nunsigned int dcr_n,\r\nunsigned int dcr_c)\r\n{\r\ndcr_host_mmio_t ret = { .token = NULL, .stride = 0, .base = dcr_n };\r\nu64 addr;\r\npr_debug("dcr_map(%s, 0x%x, 0x%x)\n",\r\ndev->full_name, dcr_n, dcr_c);\r\naddr = of_translate_dcr_address(dev, dcr_n, &ret.stride);\r\npr_debug("translates to addr: 0x%llx, stride: 0x%x\n",\r\n(unsigned long long) addr, ret.stride);\r\nif (addr == OF_BAD_ADDR)\r\nreturn ret;\r\npr_debug("mapping 0x%x bytes\n", dcr_c * ret.stride);\r\nret.token = ioremap(addr, dcr_c * ret.stride);\r\nif (ret.token == NULL)\r\nreturn ret;\r\npr_debug("mapped at 0x%p -> base is 0x%p\n",\r\nret.token, ret.token - dcr_n * ret.stride);\r\nret.token -= dcr_n * ret.stride;\r\nreturn ret;\r\n}\r\nvoid dcr_unmap_mmio(dcr_host_mmio_t host, unsigned int dcr_c)\r\n{\r\ndcr_host_mmio_t h = host;\r\nif (h.token == NULL)\r\nreturn;\r\nh.token += host.base * h.stride;\r\niounmap(h.token);\r\nh.token = NULL;\r\n}

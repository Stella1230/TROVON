static irqreturn_t fmn_message_handler(int irq, void *data)\r\n{\r\nstruct fmn_message_handler *hndlr;\r\nint bucket, rv;\r\nint size = 0, code = 0, src_stnid = 0;\r\nstruct nlm_fmn_msg msg;\r\nuint32_t mflags, bkt_status;\r\nmflags = nlm_cop2_enable_irqsave();\r\nnlm_fmn_setup_intr(irq, 0);\r\nwhile (1) {\r\nbkt_status = (nlm_read_c2_status0() >> 24) & 0xff;\r\nif (bkt_status == 0xff)\r\nbreak;\r\nfor (bucket = 0; bucket < 8; bucket++) {\r\nif (bkt_status & (1 << bucket))\r\ncontinue;\r\nrv = nlm_fmn_receive(bucket, &size, &code, &src_stnid,\r\n&msg);\r\nif (rv != 0)\r\ncontinue;\r\nhndlr = &msg_handlers[src_stnid];\r\nif (hndlr->action == NULL)\r\npr_warn("No msgring handler for stnid %d\n",\r\nsrc_stnid);\r\nelse {\r\nnlm_cop2_disable_irqrestore(mflags);\r\nhndlr->action(bucket, src_stnid, size, code,\r\n&msg, hndlr->arg);\r\nmflags = nlm_cop2_enable_irqsave();\r\n}\r\n}\r\n};\r\nnlm_fmn_setup_intr(irq, (1 << nlm_threads_per_core) - 1);\r\nnlm_cop2_disable_irqrestore(mflags);\r\nreturn IRQ_HANDLED;\r\n}\r\nvoid xlr_percpu_fmn_init(void)\r\n{\r\nstruct xlr_fmn_info *cpu_fmn_info;\r\nint *bucket_sizes;\r\nuint32_t flags;\r\nint id;\r\nBUG_ON(nlm_thread_id() != 0);\r\nid = nlm_core_id();\r\nbucket_sizes = xlr_board_fmn_config.bucket_size;\r\ncpu_fmn_info = &xlr_board_fmn_config.cpu[id];\r\nflags = nlm_cop2_enable_irqsave();\r\nnlm_write_c2_bucksize(0, bucket_sizes[id * 8 + 0]);\r\nnlm_write_c2_bucksize(1, bucket_sizes[id * 8 + 1]);\r\nnlm_write_c2_bucksize(2, bucket_sizes[id * 8 + 2]);\r\nnlm_write_c2_bucksize(3, bucket_sizes[id * 8 + 3]);\r\nnlm_write_c2_bucksize(4, bucket_sizes[id * 8 + 4]);\r\nnlm_write_c2_bucksize(5, bucket_sizes[id * 8 + 5]);\r\nnlm_write_c2_bucksize(6, bucket_sizes[id * 8 + 6]);\r\nnlm_write_c2_bucksize(7, bucket_sizes[id * 8 + 7]);\r\nCOP2_CC_INIT_CPU_DEST(0, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(1, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(2, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(3, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(4, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(5, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(6, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(7, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(8, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(9, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(10, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(11, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(12, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(13, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(14, cpu_fmn_info->credit_config);\r\nCOP2_CC_INIT_CPU_DEST(15, cpu_fmn_info->credit_config);\r\nnlm_fmn_setup_intr(IRQ_FMN, (1 << nlm_threads_per_core) - 1);\r\nnlm_cop2_disable_irqrestore(flags);\r\n}\r\nint nlm_register_fmn_handler(int start_stnid, int end_stnid,\r\nvoid (*action)(int, int, int, int, struct nlm_fmn_msg *, void *),\r\nvoid *arg)\r\n{\r\nint sstnid;\r\nfor (sstnid = start_stnid; sstnid <= end_stnid; sstnid++) {\r\nmsg_handlers[sstnid].arg = arg;\r\nsmp_wmb();\r\nmsg_handlers[sstnid].action = action;\r\n}\r\npr_debug("Registered FMN msg handler for stnid %d-%d\n",\r\nstart_stnid, end_stnid);\r\nreturn 0;\r\n}\r\nvoid nlm_setup_fmn_irq(void)\r\n{\r\nuint32_t flags;\r\nsetup_irq(IRQ_FMN, &fmn_irqaction);\r\nflags = nlm_cop2_enable_irqsave();\r\nnlm_fmn_setup_intr(IRQ_FMN, (1 << nlm_threads_per_core) - 1);\r\nnlm_cop2_disable_irqrestore(flags);\r\n}

static inline void max8997_set_gpio(struct max8997_data *max8997)\r\n{\r\nint set3 = (max8997->buck125_gpioindex) & 0x1;\r\nint set2 = ((max8997->buck125_gpioindex) >> 1) & 0x1;\r\nint set1 = ((max8997->buck125_gpioindex) >> 2) & 0x1;\r\ngpio_set_value(max8997->buck125_gpios[0], set1);\r\ngpio_set_value(max8997->buck125_gpios[1], set2);\r\ngpio_set_value(max8997->buck125_gpios[2], set3);\r\n}\r\nstatic int max8997_list_voltage_charger_cv(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nint rid = rdev_get_id(rdev);\r\nif (rid != MAX8997_CHARGER_CV)\r\ngoto err;\r\nswitch (selector) {\r\ncase 0x00:\r\nreturn 4200000;\r\ncase 0x01 ... 0x0E:\r\nreturn 4000000 + 20000 * (selector - 0x01);\r\ncase 0x0F:\r\nreturn 4350000;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerr:\r\nreturn -EINVAL;\r\n}\r\nstatic int max8997_list_voltage(struct regulator_dev *rdev,\r\nunsigned int selector)\r\n{\r\nconst struct voltage_map_desc *desc;\r\nint rid = rdev_get_id(rdev);\r\nint val;\r\nif (rid >= ARRAY_SIZE(reg_voltage_map) ||\r\nrid < 0)\r\nreturn -EINVAL;\r\ndesc = reg_voltage_map[rid];\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nval = desc->min + desc->step * selector;\r\nif (val > desc->max)\r\nreturn -EINVAL;\r\nreturn val;\r\n}\r\nstatic int max8997_get_enable_register(struct regulator_dev *rdev,\r\nint *reg, int *mask, int *pattern)\r\n{\r\nint rid = rdev_get_id(rdev);\r\nswitch (rid) {\r\ncase MAX8997_LDO1 ... MAX8997_LDO21:\r\n*reg = MAX8997_REG_LDO1CTRL + (rid - MAX8997_LDO1);\r\n*mask = 0xC0;\r\n*pattern = 0xC0;\r\nbreak;\r\ncase MAX8997_BUCK1:\r\n*reg = MAX8997_REG_BUCK1CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_BUCK2:\r\n*reg = MAX8997_REG_BUCK2CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_BUCK3:\r\n*reg = MAX8997_REG_BUCK3CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_BUCK4:\r\n*reg = MAX8997_REG_BUCK4CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_BUCK5:\r\n*reg = MAX8997_REG_BUCK5CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_BUCK6:\r\n*reg = MAX8997_REG_BUCK6CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_BUCK7:\r\n*reg = MAX8997_REG_BUCK7CTRL;\r\n*mask = 0x01;\r\n*pattern = 0x01;\r\nbreak;\r\ncase MAX8997_EN32KHZ_AP ... MAX8997_EN32KHZ_CP:\r\n*reg = MAX8997_REG_MAINCON1;\r\n*mask = 0x01 << (rid - MAX8997_EN32KHZ_AP);\r\n*pattern = 0x01 << (rid - MAX8997_EN32KHZ_AP);\r\nbreak;\r\ncase MAX8997_ENVICHG:\r\n*reg = MAX8997_REG_MBCCTRL1;\r\n*mask = 0x80;\r\n*pattern = 0x80;\r\nbreak;\r\ncase MAX8997_ESAFEOUT1 ... MAX8997_ESAFEOUT2:\r\n*reg = MAX8997_REG_SAFEOUTCTRL;\r\n*mask = 0x40 << (rid - MAX8997_ESAFEOUT1);\r\n*pattern = 0x40 << (rid - MAX8997_ESAFEOUT1);\r\nbreak;\r\ncase MAX8997_CHARGER:\r\n*reg = MAX8997_REG_MBCCTRL2;\r\n*mask = 0x40;\r\n*pattern = 0x40;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8997_reg_is_enabled(struct regulator_dev *rdev)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint ret, reg, mask, pattern;\r\nu8 val;\r\nret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\r\nif (ret)\r\nreturn ret;\r\nret = max8997_read_reg(i2c, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nreturn (val & mask) == pattern;\r\n}\r\nstatic int max8997_reg_enable(struct regulator_dev *rdev)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint ret, reg, mask, pattern;\r\nret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\r\nif (ret)\r\nreturn ret;\r\nreturn max8997_update_reg(i2c, reg, pattern, mask);\r\n}\r\nstatic int max8997_reg_disable(struct regulator_dev *rdev)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint ret, reg, mask, pattern;\r\nret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\r\nif (ret)\r\nreturn ret;\r\nreturn max8997_update_reg(i2c, reg, ~pattern, mask);\r\n}\r\nstatic int max8997_get_voltage_register(struct regulator_dev *rdev,\r\nint *_reg, int *_shift, int *_mask)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nint rid = rdev_get_id(rdev);\r\nint reg, shift = 0, mask = 0x3f;\r\nswitch (rid) {\r\ncase MAX8997_LDO1 ... MAX8997_LDO21:\r\nreg = MAX8997_REG_LDO1CTRL + (rid - MAX8997_LDO1);\r\nbreak;\r\ncase MAX8997_BUCK1:\r\nreg = MAX8997_REG_BUCK1DVS1;\r\nif (max8997->buck1_gpiodvs)\r\nreg += max8997->buck125_gpioindex;\r\nbreak;\r\ncase MAX8997_BUCK2:\r\nreg = MAX8997_REG_BUCK2DVS1;\r\nif (max8997->buck2_gpiodvs)\r\nreg += max8997->buck125_gpioindex;\r\nbreak;\r\ncase MAX8997_BUCK3:\r\nreg = MAX8997_REG_BUCK3DVS;\r\nbreak;\r\ncase MAX8997_BUCK4:\r\nreg = MAX8997_REG_BUCK4DVS;\r\nbreak;\r\ncase MAX8997_BUCK5:\r\nreg = MAX8997_REG_BUCK5DVS1;\r\nif (max8997->buck5_gpiodvs)\r\nreg += max8997->buck125_gpioindex;\r\nbreak;\r\ncase MAX8997_BUCK7:\r\nreg = MAX8997_REG_BUCK7DVS;\r\nbreak;\r\ncase MAX8997_ESAFEOUT1 ... MAX8997_ESAFEOUT2:\r\nreg = MAX8997_REG_SAFEOUTCTRL;\r\nshift = (rid == MAX8997_ESAFEOUT2) ? 2 : 0;\r\nmask = 0x3;\r\nbreak;\r\ncase MAX8997_CHARGER_CV:\r\nreg = MAX8997_REG_MBCCTRL3;\r\nshift = 0;\r\nmask = 0xf;\r\nbreak;\r\ncase MAX8997_CHARGER:\r\nreg = MAX8997_REG_MBCCTRL4;\r\nshift = 0;\r\nmask = 0xf;\r\nbreak;\r\ncase MAX8997_CHARGER_TOPOFF:\r\nreg = MAX8997_REG_MBCCTRL5;\r\nshift = 0;\r\nmask = 0xf;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n*_reg = reg;\r\n*_shift = shift;\r\n*_mask = mask;\r\nreturn 0;\r\n}\r\nstatic int max8997_get_voltage_sel(struct regulator_dev *rdev)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint reg, shift, mask, ret;\r\nu8 val;\r\nret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nret = max8997_read_reg(i2c, reg, &val);\r\nif (ret)\r\nreturn ret;\r\nval >>= shift;\r\nval &= mask;\r\nreturn val;\r\n}\r\nstatic inline int max8997_get_voltage_proper_val(\r\nconst struct voltage_map_desc *desc,\r\nint min_vol, int max_vol)\r\n{\r\nint i;\r\nif (desc == NULL)\r\nreturn -EINVAL;\r\nif (max_vol < desc->min || min_vol > desc->max)\r\nreturn -EINVAL;\r\nif (min_vol < desc->min)\r\nmin_vol = desc->min;\r\ni = DIV_ROUND_UP(min_vol - desc->min, desc->step);\r\nif (desc->min + desc->step * i > max_vol)\r\nreturn -EINVAL;\r\nreturn i;\r\n}\r\nstatic int max8997_set_voltage_charger_cv(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint rid = rdev_get_id(rdev);\r\nint lb, ub;\r\nint reg, shift = 0, mask, ret = 0;\r\nu8 val = 0x0;\r\nif (rid != MAX8997_CHARGER_CV)\r\nreturn -EINVAL;\r\nret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nif (max_uV < 4000000 || min_uV > 4350000)\r\nreturn -EINVAL;\r\nif (min_uV <= 4000000) {\r\nif (max_uV >= 4000000)\r\nreturn -EINVAL;\r\nelse\r\nval = 0x1;\r\n} else if (min_uV <= 4200000 && max_uV >= 4200000)\r\nval = 0x0;\r\nelse {\r\nlb = (min_uV - 4000001) / 20000 + 2;\r\nub = (max_uV - 4000000) / 20000 + 1;\r\nif (lb > ub)\r\nreturn -EINVAL;\r\nif (lb < 0xf)\r\nval = lb;\r\nelse {\r\nif (ub >= 0xf)\r\nval = 0xf;\r\nelse\r\nreturn -EINVAL;\r\n}\r\n}\r\n*selector = val;\r\nret = max8997_update_reg(i2c, reg, val << shift, mask);\r\nreturn ret;\r\n}\r\nstatic int max8997_set_voltage_ldobuck(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nconst struct voltage_map_desc *desc;\r\nint rid = rdev_get_id(rdev);\r\nint i, reg, shift, mask, ret;\r\nswitch (rid) {\r\ncase MAX8997_LDO1 ... MAX8997_LDO21:\r\nbreak;\r\ncase MAX8997_BUCK1 ... MAX8997_BUCK5:\r\nbreak;\r\ncase MAX8997_BUCK6:\r\nreturn -EINVAL;\r\ncase MAX8997_BUCK7:\r\nbreak;\r\ncase MAX8997_CHARGER:\r\nbreak;\r\ncase MAX8997_CHARGER_TOPOFF:\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndesc = reg_voltage_map[rid];\r\ni = max8997_get_voltage_proper_val(desc, min_uV, max_uV);\r\nif (i < 0)\r\nreturn i;\r\nret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nret = max8997_update_reg(i2c, reg, i << shift, mask << shift);\r\n*selector = i;\r\nreturn ret;\r\n}\r\nstatic int max8997_set_voltage_buck_time_sel(struct regulator_dev *rdev,\r\nunsigned int old_selector,\r\nunsigned int new_selector)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nint rid = rdev_get_id(rdev);\r\nconst struct voltage_map_desc *desc = reg_voltage_map[rid];\r\nif (old_selector >= new_selector)\r\nreturn 0;\r\nswitch (rid) {\r\ncase MAX8997_BUCK1:\r\nif (max8997->buck1_gpiodvs)\r\nreturn 0;\r\nbreak;\r\ncase MAX8997_BUCK2:\r\nif (max8997->buck2_gpiodvs)\r\nreturn 0;\r\nbreak;\r\ncase MAX8997_BUCK5:\r\nif (max8997->buck5_gpiodvs)\r\nreturn 0;\r\nbreak;\r\n}\r\nswitch (rid) {\r\ncase MAX8997_BUCK1:\r\ncase MAX8997_BUCK2:\r\ncase MAX8997_BUCK4:\r\ncase MAX8997_BUCK5:\r\nreturn DIV_ROUND_UP(desc->step * (new_selector - old_selector),\r\nmax8997->ramp_delay * 1000);\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8997_assess_side_effect(struct regulator_dev *rdev,\r\nu8 new_val, int *best)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nint rid = rdev_get_id(rdev);\r\nu8 *buckx_val[3];\r\nbool buckx_gpiodvs[3];\r\nint side_effect[8];\r\nint min_side_effect = INT_MAX;\r\nint i;\r\n*best = -1;\r\nswitch (rid) {\r\ncase MAX8997_BUCK1:\r\nrid = 0;\r\nbreak;\r\ncase MAX8997_BUCK2:\r\nrid = 1;\r\nbreak;\r\ncase MAX8997_BUCK5:\r\nrid = 2;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nbuckx_val[0] = max8997->buck1_vol;\r\nbuckx_val[1] = max8997->buck2_vol;\r\nbuckx_val[2] = max8997->buck5_vol;\r\nbuckx_gpiodvs[0] = max8997->buck1_gpiodvs;\r\nbuckx_gpiodvs[1] = max8997->buck2_gpiodvs;\r\nbuckx_gpiodvs[2] = max8997->buck5_gpiodvs;\r\nfor (i = 0; i < 8; i++) {\r\nint others;\r\nif (new_val != (buckx_val[rid])[i]) {\r\nside_effect[i] = -1;\r\ncontinue;\r\n}\r\nside_effect[i] = 0;\r\nfor (others = 0; others < 3; others++) {\r\nint diff;\r\nif (others == rid)\r\ncontinue;\r\nif (buckx_gpiodvs[others] == false)\r\ncontinue;\r\ndiff = (buckx_val[others])[i] -\r\n(buckx_val[others])[max8997->buck125_gpioindex];\r\nif (diff > 0)\r\nside_effect[i] += diff;\r\nelse if (diff < 0)\r\nside_effect[i] -= diff;\r\n}\r\nif (side_effect[i] == 0) {\r\n*best = i;\r\nreturn 0;\r\n}\r\nif (side_effect[i] < min_side_effect) {\r\nmin_side_effect = side_effect[i];\r\n*best = i;\r\n}\r\n}\r\nif (*best == -1)\r\nreturn -EINVAL;\r\nreturn side_effect[*best];\r\n}\r\nstatic int max8997_set_voltage_buck(struct regulator_dev *rdev,\r\nint min_uV, int max_uV, unsigned *selector)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nint rid = rdev_get_id(rdev);\r\nconst struct voltage_map_desc *desc;\r\nint new_val, new_idx, damage, tmp_val, tmp_idx, tmp_dmg;\r\nbool gpio_dvs_mode = false;\r\nif (rid < MAX8997_BUCK1 || rid > MAX8997_BUCK7)\r\nreturn -EINVAL;\r\nswitch (rid) {\r\ncase MAX8997_BUCK1:\r\nif (max8997->buck1_gpiodvs)\r\ngpio_dvs_mode = true;\r\nbreak;\r\ncase MAX8997_BUCK2:\r\nif (max8997->buck2_gpiodvs)\r\ngpio_dvs_mode = true;\r\nbreak;\r\ncase MAX8997_BUCK5:\r\nif (max8997->buck5_gpiodvs)\r\ngpio_dvs_mode = true;\r\nbreak;\r\n}\r\nif (!gpio_dvs_mode)\r\nreturn max8997_set_voltage_ldobuck(rdev, min_uV, max_uV,\r\nselector);\r\ndesc = reg_voltage_map[rid];\r\nnew_val = max8997_get_voltage_proper_val(desc, min_uV, max_uV);\r\nif (new_val < 0)\r\nreturn new_val;\r\ntmp_dmg = INT_MAX;\r\ntmp_idx = -1;\r\ntmp_val = -1;\r\ndo {\r\ndamage = max8997_assess_side_effect(rdev, new_val, &new_idx);\r\nif (damage == 0)\r\ngoto out;\r\nif (tmp_dmg > damage) {\r\ntmp_idx = new_idx;\r\ntmp_val = new_val;\r\ntmp_dmg = damage;\r\n}\r\nnew_val++;\r\n} while (desc->min + desc->step * new_val <= desc->max);\r\nnew_idx = tmp_idx;\r\nnew_val = tmp_val;\r\nif (max8997->ignore_gpiodvs_side_effect == false)\r\nreturn -EINVAL;\r\ndev_warn(&rdev->dev,\r\n"MAX8997 GPIO-DVS Side Effect Warning: GPIO SET: %d -> %d\n",\r\nmax8997->buck125_gpioindex, tmp_idx);\r\nout:\r\nif (new_idx < 0 || new_val < 0)\r\nreturn -EINVAL;\r\nmax8997->buck125_gpioindex = new_idx;\r\nmax8997_set_gpio(max8997);\r\n*selector = new_val;\r\nreturn 0;\r\n}\r\nstatic int max8997_set_voltage_safeout_sel(struct regulator_dev *rdev,\r\nunsigned selector)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint rid = rdev_get_id(rdev);\r\nint reg, shift = 0, mask, ret;\r\nif (rid != MAX8997_ESAFEOUT1 && rid != MAX8997_ESAFEOUT2)\r\nreturn -EINVAL;\r\nret = max8997_get_voltage_register(rdev, &reg, &shift, &mask);\r\nif (ret)\r\nreturn ret;\r\nreturn max8997_update_reg(i2c, reg, selector << shift, mask << shift);\r\n}\r\nstatic int max8997_reg_disable_suspend(struct regulator_dev *rdev)\r\n{\r\nstruct max8997_data *max8997 = rdev_get_drvdata(rdev);\r\nstruct i2c_client *i2c = max8997->iodev->i2c;\r\nint ret, reg, mask, pattern;\r\nint rid = rdev_get_id(rdev);\r\nret = max8997_get_enable_register(rdev, &reg, &mask, &pattern);\r\nif (ret)\r\nreturn ret;\r\nmax8997_read_reg(i2c, reg, &max8997->saved_states[rid]);\r\nif (rid == MAX8997_LDO1 ||\r\nrid == MAX8997_LDO10 ||\r\nrid == MAX8997_LDO21) {\r\ndev_dbg(&rdev->dev, "Conditional Power-Off for %s\n",\r\nrdev->desc->name);\r\nreturn max8997_update_reg(i2c, reg, 0x40, mask);\r\n}\r\ndev_dbg(&rdev->dev, "Full Power-Off for %s (%xh -> %xh)\n",\r\nrdev->desc->name, max8997->saved_states[rid] & mask,\r\n(~pattern) & mask);\r\nreturn max8997_update_reg(i2c, reg, ~pattern, mask);\r\n}\r\nstatic int max8997_set_current_limit(struct regulator_dev *rdev,\r\nint min_uA, int max_uA)\r\n{\r\nunsigned dummy;\r\nint rid = rdev_get_id(rdev);\r\nif (rid != MAX8997_CHARGER && rid != MAX8997_CHARGER_TOPOFF)\r\nreturn -EINVAL;\r\nreturn max8997_set_voltage_ldobuck(rdev, min_uA, max_uA, &dummy);\r\n}\r\nstatic int max8997_get_current_limit(struct regulator_dev *rdev)\r\n{\r\nint sel, rid = rdev_get_id(rdev);\r\nif (rid != MAX8997_CHARGER && rid != MAX8997_CHARGER_TOPOFF)\r\nreturn -EINVAL;\r\nsel = max8997_get_voltage_sel(rdev);\r\nif (sel < 0)\r\nreturn sel;\r\nreturn max8997_list_voltage(rdev, sel);\r\n}\r\nstatic int max8997_pmic_dt_parse_dvs_gpio(struct platform_device *pdev,\r\nstruct max8997_platform_data *pdata,\r\nstruct device_node *pmic_np)\r\n{\r\nint i, gpio;\r\nfor (i = 0; i < 3; i++) {\r\ngpio = of_get_named_gpio(pmic_np,\r\n"max8997,pmic-buck125-dvs-gpios", i);\r\nif (!gpio_is_valid(gpio)) {\r\ndev_err(&pdev->dev, "invalid gpio[%d]: %d\n", i, gpio);\r\nreturn -EINVAL;\r\n}\r\npdata->buck125_gpios[i] = gpio;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8997_pmic_dt_parse_pdata(struct platform_device *pdev,\r\nstruct max8997_platform_data *pdata)\r\n{\r\nstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct device_node *pmic_np, *regulators_np, *reg_np;\r\nstruct max8997_regulator_data *rdata;\r\nunsigned int i, dvs_voltage_nr = 1, ret;\r\npmic_np = iodev->dev->of_node;\r\nif (!pmic_np) {\r\ndev_err(&pdev->dev, "could not find pmic sub-node\n");\r\nreturn -ENODEV;\r\n}\r\nregulators_np = of_get_child_by_name(pmic_np, "regulators");\r\nif (!regulators_np) {\r\ndev_err(&pdev->dev, "could not find regulators sub-node\n");\r\nreturn -EINVAL;\r\n}\r\npdata->num_regulators = of_get_child_count(regulators_np);\r\nrdata = devm_kzalloc(&pdev->dev, sizeof(*rdata) *\r\npdata->num_regulators, GFP_KERNEL);\r\nif (!rdata) {\r\nof_node_put(regulators_np);\r\nreturn -ENOMEM;\r\n}\r\npdata->regulators = rdata;\r\nfor_each_child_of_node(regulators_np, reg_np) {\r\nfor (i = 0; i < ARRAY_SIZE(regulators); i++)\r\nif (!of_node_cmp(reg_np->name, regulators[i].name))\r\nbreak;\r\nif (i == ARRAY_SIZE(regulators)) {\r\ndev_warn(&pdev->dev, "don't know how to configure regulator %s\n",\r\nreg_np->name);\r\ncontinue;\r\n}\r\nrdata->id = i;\r\nrdata->initdata = of_get_regulator_init_data(&pdev->dev,\r\nreg_np,\r\n&regulators[i]);\r\nrdata->reg_node = reg_np;\r\nrdata++;\r\n}\r\nof_node_put(regulators_np);\r\nif (of_get_property(pmic_np, "max8997,pmic-buck1-uses-gpio-dvs", NULL))\r\npdata->buck1_gpiodvs = true;\r\nif (of_get_property(pmic_np, "max8997,pmic-buck2-uses-gpio-dvs", NULL))\r\npdata->buck2_gpiodvs = true;\r\nif (of_get_property(pmic_np, "max8997,pmic-buck5-uses-gpio-dvs", NULL))\r\npdata->buck5_gpiodvs = true;\r\nif (pdata->buck1_gpiodvs || pdata->buck2_gpiodvs ||\r\npdata->buck5_gpiodvs) {\r\nret = max8997_pmic_dt_parse_dvs_gpio(pdev, pdata, pmic_np);\r\nif (ret)\r\nreturn -EINVAL;\r\nif (of_property_read_u32(pmic_np,\r\n"max8997,pmic-buck125-default-dvs-idx",\r\n&pdata->buck125_default_idx)) {\r\npdata->buck125_default_idx = 0;\r\n} else {\r\nif (pdata->buck125_default_idx >= 8) {\r\npdata->buck125_default_idx = 0;\r\ndev_info(&pdev->dev, "invalid value for default dvs index, using 0 instead\n");\r\n}\r\n}\r\nif (of_get_property(pmic_np,\r\n"max8997,pmic-ignore-gpiodvs-side-effect", NULL))\r\npdata->ignore_gpiodvs_side_effect = true;\r\ndvs_voltage_nr = 8;\r\n}\r\nif (of_property_read_u32_array(pmic_np,\r\n"max8997,pmic-buck1-dvs-voltage",\r\npdata->buck1_voltage, dvs_voltage_nr)) {\r\ndev_err(&pdev->dev, "buck1 voltages not specified\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32_array(pmic_np,\r\n"max8997,pmic-buck2-dvs-voltage",\r\npdata->buck2_voltage, dvs_voltage_nr)) {\r\ndev_err(&pdev->dev, "buck2 voltages not specified\n");\r\nreturn -EINVAL;\r\n}\r\nif (of_property_read_u32_array(pmic_np,\r\n"max8997,pmic-buck5-dvs-voltage",\r\npdata->buck5_voltage, dvs_voltage_nr)) {\r\ndev_err(&pdev->dev, "buck5 voltages not specified\n");\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max8997_pmic_dt_parse_pdata(struct platform_device *pdev,\r\nstruct max8997_platform_data *pdata)\r\n{\r\nreturn 0;\r\n}\r\nstatic int max8997_pmic_probe(struct platform_device *pdev)\r\n{\r\nstruct max8997_dev *iodev = dev_get_drvdata(pdev->dev.parent);\r\nstruct max8997_platform_data *pdata = iodev->pdata;\r\nstruct regulator_config config = { };\r\nstruct regulator_dev *rdev;\r\nstruct max8997_data *max8997;\r\nstruct i2c_client *i2c;\r\nint i, ret, nr_dvs;\r\nu8 max_buck1 = 0, max_buck2 = 0, max_buck5 = 0;\r\nif (!pdata) {\r\ndev_err(&pdev->dev, "No platform init data supplied.\n");\r\nreturn -ENODEV;\r\n}\r\nif (iodev->dev->of_node) {\r\nret = max8997_pmic_dt_parse_pdata(pdev, pdata);\r\nif (ret)\r\nreturn ret;\r\n}\r\nmax8997 = devm_kzalloc(&pdev->dev, sizeof(struct max8997_data),\r\nGFP_KERNEL);\r\nif (!max8997)\r\nreturn -ENOMEM;\r\nmax8997->dev = &pdev->dev;\r\nmax8997->iodev = iodev;\r\nmax8997->num_regulators = pdata->num_regulators;\r\nplatform_set_drvdata(pdev, max8997);\r\ni2c = max8997->iodev->i2c;\r\nmax8997->buck125_gpioindex = pdata->buck125_default_idx;\r\nmax8997->buck1_gpiodvs = pdata->buck1_gpiodvs;\r\nmax8997->buck2_gpiodvs = pdata->buck2_gpiodvs;\r\nmax8997->buck5_gpiodvs = pdata->buck5_gpiodvs;\r\nmemcpy(max8997->buck125_gpios, pdata->buck125_gpios, sizeof(int) * 3);\r\nmax8997->ignore_gpiodvs_side_effect = pdata->ignore_gpiodvs_side_effect;\r\nnr_dvs = (pdata->buck1_gpiodvs || pdata->buck2_gpiodvs ||\r\npdata->buck5_gpiodvs) ? 8 : 1;\r\nfor (i = 0; i < nr_dvs; i++) {\r\nmax8997->buck1_vol[i] = ret =\r\nmax8997_get_voltage_proper_val(\r\n&buck1245_voltage_map_desc,\r\npdata->buck1_voltage[i],\r\npdata->buck1_voltage[i] +\r\nbuck1245_voltage_map_desc.step);\r\nif (ret < 0)\r\nreturn ret;\r\nmax8997->buck2_vol[i] = ret =\r\nmax8997_get_voltage_proper_val(\r\n&buck1245_voltage_map_desc,\r\npdata->buck2_voltage[i],\r\npdata->buck2_voltage[i] +\r\nbuck1245_voltage_map_desc.step);\r\nif (ret < 0)\r\nreturn ret;\r\nmax8997->buck5_vol[i] = ret =\r\nmax8997_get_voltage_proper_val(\r\n&buck1245_voltage_map_desc,\r\npdata->buck5_voltage[i],\r\npdata->buck5_voltage[i] +\r\nbuck1245_voltage_map_desc.step);\r\nif (ret < 0)\r\nreturn ret;\r\nif (max_buck1 < max8997->buck1_vol[i])\r\nmax_buck1 = max8997->buck1_vol[i];\r\nif (max_buck2 < max8997->buck2_vol[i])\r\nmax_buck2 = max8997->buck2_vol[i];\r\nif (max_buck5 < max8997->buck5_vol[i])\r\nmax_buck5 = max8997->buck5_vol[i];\r\n}\r\nfor (i = 0; i < 8; i++) {\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK1DVS1 + i,\r\nmax_buck1, 0x3f);\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK2DVS1 + i,\r\nmax_buck2, 0x3f);\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK5DVS1 + i,\r\nmax_buck5, 0x3f);\r\n}\r\nfor (i = 0; i < nr_dvs; i++) {\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK1DVS1 + i,\r\nmax8997->buck1_vol[i],\r\n0x3f);\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK2DVS1 + i,\r\nmax8997->buck2_vol[i],\r\n0x3f);\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK5DVS1 + i,\r\nmax8997->buck5_vol[i],\r\n0x3f);\r\n}\r\nif (pdata->buck1_gpiodvs || pdata->buck2_gpiodvs ||\r\npdata->buck5_gpiodvs) {\r\nif (!gpio_is_valid(pdata->buck125_gpios[0]) ||\r\n!gpio_is_valid(pdata->buck125_gpios[1]) ||\r\n!gpio_is_valid(pdata->buck125_gpios[2])) {\r\ndev_err(&pdev->dev, "GPIO NOT VALID\n");\r\nreturn -EINVAL;\r\n}\r\nret = devm_gpio_request(&pdev->dev, pdata->buck125_gpios[0],\r\n"MAX8997 SET1");\r\nif (ret)\r\nreturn ret;\r\nret = devm_gpio_request(&pdev->dev, pdata->buck125_gpios[1],\r\n"MAX8997 SET2");\r\nif (ret)\r\nreturn ret;\r\nret = devm_gpio_request(&pdev->dev, pdata->buck125_gpios[2],\r\n"MAX8997 SET3");\r\nif (ret)\r\nreturn ret;\r\ngpio_direction_output(pdata->buck125_gpios[0],\r\n(max8997->buck125_gpioindex >> 2)\r\n& 0x1);\r\ngpio_direction_output(pdata->buck125_gpios[1],\r\n(max8997->buck125_gpioindex >> 1)\r\n& 0x1);\r\ngpio_direction_output(pdata->buck125_gpios[2],\r\n(max8997->buck125_gpioindex >> 0)\r\n& 0x1);\r\n}\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK1CTRL, (pdata->buck1_gpiodvs) ?\r\n(1 << 1) : (0 << 1), 1 << 1);\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK2CTRL, (pdata->buck2_gpiodvs) ?\r\n(1 << 1) : (0 << 1), 1 << 1);\r\nmax8997_update_reg(i2c, MAX8997_REG_BUCK5CTRL, (pdata->buck5_gpiodvs) ?\r\n(1 << 1) : (0 << 1), 1 << 1);\r\nmax8997->ramp_delay = 10;\r\nmax8997_write_reg(i2c, MAX8997_REG_BUCKRAMP, (0xf << 4) | 0x9);\r\nfor (i = 0; i < pdata->num_regulators; i++) {\r\nconst struct voltage_map_desc *desc;\r\nint id = pdata->regulators[i].id;\r\ndesc = reg_voltage_map[id];\r\nif (desc) {\r\nregulators[id].n_voltages =\r\n(desc->max - desc->min) / desc->step + 1;\r\n} else if (id == MAX8997_ESAFEOUT1 || id == MAX8997_ESAFEOUT2) {\r\nregulators[id].volt_table = safeoutvolt;\r\nregulators[id].n_voltages = ARRAY_SIZE(safeoutvolt);\r\n} else if (id == MAX8997_CHARGER_CV) {\r\nregulators[id].n_voltages = 16;\r\n}\r\nconfig.dev = max8997->dev;\r\nconfig.init_data = pdata->regulators[i].initdata;\r\nconfig.driver_data = max8997;\r\nconfig.of_node = pdata->regulators[i].reg_node;\r\nrdev = devm_regulator_register(&pdev->dev, &regulators[id],\r\n&config);\r\nif (IS_ERR(rdev)) {\r\ndev_err(max8997->dev, "regulator init failed for %d\n",\r\nid);\r\nreturn PTR_ERR(rdev);\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int __init max8997_pmic_init(void)\r\n{\r\nreturn platform_driver_register(&max8997_pmic_driver);\r\n}\r\nstatic void __exit max8997_pmic_cleanup(void)\r\n{\r\nplatform_driver_unregister(&max8997_pmic_driver);\r\n}

static void xor_set_src(struct ioat_raw_descriptor *descs[2],\r\ndma_addr_t addr, u32 offset, int idx)\r\n{\r\nstruct ioat_raw_descriptor *raw = descs[xor_idx_to_desc >> idx & 1];\r\nraw->field[xor_idx_to_field[idx]] = addr + offset;\r\n}\r\nstatic dma_addr_t pq_get_src(struct ioat_raw_descriptor *descs[2], int idx)\r\n{\r\nstruct ioat_raw_descriptor *raw = descs[pq_idx_to_desc >> idx & 1];\r\nreturn raw->field[pq_idx_to_field[idx]];\r\n}\r\nstatic dma_addr_t pq16_get_src(struct ioat_raw_descriptor *desc[3], int idx)\r\n{\r\nstruct ioat_raw_descriptor *raw = desc[pq16_idx_to_desc[idx]];\r\nreturn raw->field[pq16_idx_to_field[idx]];\r\n}\r\nstatic void pq_set_src(struct ioat_raw_descriptor *descs[2],\r\ndma_addr_t addr, u32 offset, u8 coef, int idx)\r\n{\r\nstruct ioat_pq_descriptor *pq = (struct ioat_pq_descriptor *) descs[0];\r\nstruct ioat_raw_descriptor *raw = descs[pq_idx_to_desc >> idx & 1];\r\nraw->field[pq_idx_to_field[idx]] = addr + offset;\r\npq->coef[idx] = coef;\r\n}\r\nstatic void pq16_set_src(struct ioat_raw_descriptor *desc[3],\r\ndma_addr_t addr, u32 offset, u8 coef, unsigned idx)\r\n{\r\nstruct ioat_pq_descriptor *pq = (struct ioat_pq_descriptor *)desc[0];\r\nstruct ioat_pq16a_descriptor *pq16 =\r\n(struct ioat_pq16a_descriptor *)desc[1];\r\nstruct ioat_raw_descriptor *raw = desc[pq16_idx_to_desc[idx]];\r\nraw->field[pq16_idx_to_field[idx]] = addr + offset;\r\nif (idx < 8)\r\npq->coef[idx] = coef;\r\nelse\r\npq16->coef[idx - 8] = coef;\r\n}\r\nstatic struct ioat_sed_ent *\r\nioat3_alloc_sed(struct ioatdma_device *ioat_dma, unsigned int hw_pool)\r\n{\r\nstruct ioat_sed_ent *sed;\r\ngfp_t flags = __GFP_ZERO | GFP_ATOMIC;\r\nsed = kmem_cache_alloc(ioat_sed_cache, flags);\r\nif (!sed)\r\nreturn NULL;\r\nsed->hw_pool = hw_pool;\r\nsed->hw = dma_pool_alloc(ioat_dma->sed_hw_pool[hw_pool],\r\nflags, &sed->dma);\r\nif (!sed->hw) {\r\nkmem_cache_free(ioat_sed_cache, sed);\r\nreturn NULL;\r\n}\r\nreturn sed;\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_dma_prep_memcpy_lock(struct dma_chan *c, dma_addr_t dma_dest,\r\ndma_addr_t dma_src, size_t len, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(c);\r\nstruct ioat_dma_descriptor *hw;\r\nstruct ioat_ring_ent *desc;\r\ndma_addr_t dst = dma_dest;\r\ndma_addr_t src = dma_src;\r\nsize_t total_len = len;\r\nint num_descs, idx, i;\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nnum_descs = ioat_xferlen_to_descs(ioat_chan, len);\r\nif (likely(num_descs) &&\r\nioat_check_space_lock(ioat_chan, num_descs) == 0)\r\nidx = ioat_chan->head;\r\nelse\r\nreturn NULL;\r\ni = 0;\r\ndo {\r\nsize_t copy = min_t(size_t, len, 1 << ioat_chan->xfercap_log);\r\ndesc = ioat_get_ring_ent(ioat_chan, idx + i);\r\nhw = desc->hw;\r\nhw->size = copy;\r\nhw->ctl = 0;\r\nhw->src_addr = src;\r\nhw->dst_addr = dst;\r\nlen -= copy;\r\ndst += copy;\r\nsrc += copy;\r\ndump_desc_dbg(ioat_chan, desc);\r\n} while (++i < num_descs);\r\ndesc->txd.flags = flags;\r\ndesc->len = total_len;\r\nhw->ctl_f.int_en = !!(flags & DMA_PREP_INTERRUPT);\r\nhw->ctl_f.fence = !!(flags & DMA_PREP_FENCE);\r\nhw->ctl_f.compl_write = 1;\r\ndump_desc_dbg(ioat_chan, desc);\r\nreturn &desc->txd;\r\n}\r\nstatic struct dma_async_tx_descriptor *\r\n__ioat_prep_xor_lock(struct dma_chan *c, enum sum_check_flags *result,\r\ndma_addr_t dest, dma_addr_t *src, unsigned int src_cnt,\r\nsize_t len, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(c);\r\nstruct ioat_ring_ent *compl_desc;\r\nstruct ioat_ring_ent *desc;\r\nstruct ioat_ring_ent *ext;\r\nsize_t total_len = len;\r\nstruct ioat_xor_descriptor *xor;\r\nstruct ioat_xor_ext_descriptor *xor_ex = NULL;\r\nstruct ioat_dma_descriptor *hw;\r\nint num_descs, with_ext, idx, i;\r\nu32 offset = 0;\r\nu8 op = result ? IOAT_OP_XOR_VAL : IOAT_OP_XOR;\r\nBUG_ON(src_cnt < 2);\r\nnum_descs = ioat_xferlen_to_descs(ioat_chan, len);\r\nif (src_cnt > 5) {\r\nwith_ext = 1;\r\nnum_descs *= 2;\r\n} else\r\nwith_ext = 0;\r\nif (likely(num_descs) &&\r\nioat_check_space_lock(ioat_chan, num_descs+1) == 0)\r\nidx = ioat_chan->head;\r\nelse\r\nreturn NULL;\r\ni = 0;\r\ndo {\r\nstruct ioat_raw_descriptor *descs[2];\r\nsize_t xfer_size = min_t(size_t,\r\nlen, 1 << ioat_chan->xfercap_log);\r\nint s;\r\ndesc = ioat_get_ring_ent(ioat_chan, idx + i);\r\nxor = desc->xor;\r\next = ioat_get_ring_ent(ioat_chan, idx + i + 1);\r\nxor_ex = ext->xor_ex;\r\ndescs[0] = (struct ioat_raw_descriptor *) xor;\r\ndescs[1] = (struct ioat_raw_descriptor *) xor_ex;\r\nfor (s = 0; s < src_cnt; s++)\r\nxor_set_src(descs, src[s], offset, s);\r\nxor->size = xfer_size;\r\nxor->dst_addr = dest + offset;\r\nxor->ctl = 0;\r\nxor->ctl_f.op = op;\r\nxor->ctl_f.src_cnt = src_cnt_to_hw(src_cnt);\r\nlen -= xfer_size;\r\noffset += xfer_size;\r\ndump_desc_dbg(ioat_chan, desc);\r\n} while ((i += 1 + with_ext) < num_descs);\r\ndesc->txd.flags = flags;\r\ndesc->len = total_len;\r\nif (result)\r\ndesc->result = result;\r\nxor->ctl_f.fence = !!(flags & DMA_PREP_FENCE);\r\ncompl_desc = ioat_get_ring_ent(ioat_chan, idx + i);\r\ncompl_desc->txd.flags = flags & DMA_PREP_INTERRUPT;\r\nhw = compl_desc->hw;\r\nhw->ctl = 0;\r\nhw->ctl_f.null = 1;\r\nhw->ctl_f.int_en = !!(flags & DMA_PREP_INTERRUPT);\r\nhw->ctl_f.compl_write = 1;\r\nhw->size = NULL_DESC_BUFFER_SIZE;\r\ndump_desc_dbg(ioat_chan, compl_desc);\r\nreturn &compl_desc->txd;\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_xor(struct dma_chan *chan, dma_addr_t dest, dma_addr_t *src,\r\nunsigned int src_cnt, size_t len, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(chan);\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nreturn __ioat_prep_xor_lock(chan, NULL, dest, src, src_cnt, len, flags);\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_xor_val(struct dma_chan *chan, dma_addr_t *src,\r\nunsigned int src_cnt, size_t len,\r\nenum sum_check_flags *result, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(chan);\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\n*result = 0;\r\nreturn __ioat_prep_xor_lock(chan, result, src[0], &src[1],\r\nsrc_cnt - 1, len, flags);\r\n}\r\nstatic void\r\ndump_pq_desc_dbg(struct ioatdma_chan *ioat_chan, struct ioat_ring_ent *desc,\r\nstruct ioat_ring_ent *ext)\r\n{\r\nstruct device *dev = to_dev(ioat_chan);\r\nstruct ioat_pq_descriptor *pq = desc->pq;\r\nstruct ioat_pq_ext_descriptor *pq_ex = ext ? ext->pq_ex : NULL;\r\nstruct ioat_raw_descriptor *descs[] = { (void *) pq, (void *) pq_ex };\r\nint src_cnt = src_cnt_to_sw(pq->ctl_f.src_cnt);\r\nint i;\r\ndev_dbg(dev, "desc[%d]: (%#llx->%#llx) flags: %#x"\r\n" sz: %#10.8x ctl: %#x (op: %#x int: %d compl: %d pq: '%s%s'"\r\n" src_cnt: %d)\n",\r\ndesc_id(desc), (unsigned long long) desc->txd.phys,\r\n(unsigned long long) (pq_ex ? pq_ex->next : pq->next),\r\ndesc->txd.flags, pq->size, pq->ctl, pq->ctl_f.op,\r\npq->ctl_f.int_en, pq->ctl_f.compl_write,\r\npq->ctl_f.p_disable ? "" : "p", pq->ctl_f.q_disable ? "" : "q",\r\npq->ctl_f.src_cnt);\r\nfor (i = 0; i < src_cnt; i++)\r\ndev_dbg(dev, "\tsrc[%d]: %#llx coef: %#x\n", i,\r\n(unsigned long long) pq_get_src(descs, i), pq->coef[i]);\r\ndev_dbg(dev, "\tP: %#llx\n", pq->p_addr);\r\ndev_dbg(dev, "\tQ: %#llx\n", pq->q_addr);\r\ndev_dbg(dev, "\tNEXT: %#llx\n", pq->next);\r\n}\r\nstatic void dump_pq16_desc_dbg(struct ioatdma_chan *ioat_chan,\r\nstruct ioat_ring_ent *desc)\r\n{\r\nstruct device *dev = to_dev(ioat_chan);\r\nstruct ioat_pq_descriptor *pq = desc->pq;\r\nstruct ioat_raw_descriptor *descs[] = { (void *)pq,\r\n(void *)pq,\r\n(void *)pq };\r\nint src_cnt = src16_cnt_to_sw(pq->ctl_f.src_cnt);\r\nint i;\r\nif (desc->sed) {\r\ndescs[1] = (void *)desc->sed->hw;\r\ndescs[2] = (void *)desc->sed->hw + 64;\r\n}\r\ndev_dbg(dev, "desc[%d]: (%#llx->%#llx) flags: %#x"\r\n" sz: %#x ctl: %#x (op: %#x int: %d compl: %d pq: '%s%s'"\r\n" src_cnt: %d)\n",\r\ndesc_id(desc), (unsigned long long) desc->txd.phys,\r\n(unsigned long long) pq->next,\r\ndesc->txd.flags, pq->size, pq->ctl,\r\npq->ctl_f.op, pq->ctl_f.int_en,\r\npq->ctl_f.compl_write,\r\npq->ctl_f.p_disable ? "" : "p", pq->ctl_f.q_disable ? "" : "q",\r\npq->ctl_f.src_cnt);\r\nfor (i = 0; i < src_cnt; i++) {\r\ndev_dbg(dev, "\tsrc[%d]: %#llx coef: %#x\n", i,\r\n(unsigned long long) pq16_get_src(descs, i),\r\npq->coef[i]);\r\n}\r\ndev_dbg(dev, "\tP: %#llx\n", pq->p_addr);\r\ndev_dbg(dev, "\tQ: %#llx\n", pq->q_addr);\r\n}\r\nstatic struct dma_async_tx_descriptor *\r\n__ioat_prep_pq_lock(struct dma_chan *c, enum sum_check_flags *result,\r\nconst dma_addr_t *dst, const dma_addr_t *src,\r\nunsigned int src_cnt, const unsigned char *scf,\r\nsize_t len, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(c);\r\nstruct ioatdma_device *ioat_dma = ioat_chan->ioat_dma;\r\nstruct ioat_ring_ent *compl_desc;\r\nstruct ioat_ring_ent *desc;\r\nstruct ioat_ring_ent *ext;\r\nsize_t total_len = len;\r\nstruct ioat_pq_descriptor *pq;\r\nstruct ioat_pq_ext_descriptor *pq_ex = NULL;\r\nstruct ioat_dma_descriptor *hw;\r\nu32 offset = 0;\r\nu8 op = result ? IOAT_OP_PQ_VAL : IOAT_OP_PQ;\r\nint i, s, idx, with_ext, num_descs;\r\nint cb32 = (ioat_dma->version < IOAT_VER_3_3) ? 1 : 0;\r\ndev_dbg(to_dev(ioat_chan), "%s\n", __func__);\r\nBUG_ON(src_cnt + dmaf_continue(flags) < 2);\r\nnum_descs = ioat_xferlen_to_descs(ioat_chan, len);\r\nif (src_cnt + dmaf_p_disabled_continue(flags) > 3 ||\r\n(dmaf_continue(flags) && !dmaf_p_disabled_continue(flags))) {\r\nwith_ext = 1;\r\nnum_descs *= 2;\r\n} else\r\nwith_ext = 0;\r\nif (likely(num_descs) &&\r\nioat_check_space_lock(ioat_chan, num_descs + cb32) == 0)\r\nidx = ioat_chan->head;\r\nelse\r\nreturn NULL;\r\ni = 0;\r\ndo {\r\nstruct ioat_raw_descriptor *descs[2];\r\nsize_t xfer_size = min_t(size_t, len,\r\n1 << ioat_chan->xfercap_log);\r\ndesc = ioat_get_ring_ent(ioat_chan, idx + i);\r\npq = desc->pq;\r\next = ioat_get_ring_ent(ioat_chan, idx + i + with_ext);\r\npq_ex = ext->pq_ex;\r\ndescs[0] = (struct ioat_raw_descriptor *) pq;\r\ndescs[1] = (struct ioat_raw_descriptor *) pq_ex;\r\nfor (s = 0; s < src_cnt; s++)\r\npq_set_src(descs, src[s], offset, scf[s], s);\r\nif (dmaf_p_disabled_continue(flags))\r\npq_set_src(descs, dst[1], offset, 1, s++);\r\nelse if (dmaf_continue(flags)) {\r\npq_set_src(descs, dst[0], offset, 0, s++);\r\npq_set_src(descs, dst[1], offset, 1, s++);\r\npq_set_src(descs, dst[1], offset, 0, s++);\r\n}\r\npq->size = xfer_size;\r\npq->p_addr = dst[0] + offset;\r\npq->q_addr = dst[1] + offset;\r\npq->ctl = 0;\r\npq->ctl_f.op = op;\r\nif (ioat_dma->cap & IOAT_CAP_DWBES)\r\npq->ctl_f.wb_en = result ? 1 : 0;\r\npq->ctl_f.src_cnt = src_cnt_to_hw(s);\r\npq->ctl_f.p_disable = !!(flags & DMA_PREP_PQ_DISABLE_P);\r\npq->ctl_f.q_disable = !!(flags & DMA_PREP_PQ_DISABLE_Q);\r\nlen -= xfer_size;\r\noffset += xfer_size;\r\n} while ((i += 1 + with_ext) < num_descs);\r\ndesc->txd.flags = flags;\r\ndesc->len = total_len;\r\nif (result)\r\ndesc->result = result;\r\npq->ctl_f.fence = !!(flags & DMA_PREP_FENCE);\r\ndump_pq_desc_dbg(ioat_chan, desc, ext);\r\nif (!cb32) {\r\npq->ctl_f.int_en = !!(flags & DMA_PREP_INTERRUPT);\r\npq->ctl_f.compl_write = 1;\r\ncompl_desc = desc;\r\n} else {\r\ncompl_desc = ioat_get_ring_ent(ioat_chan, idx + i);\r\ncompl_desc->txd.flags = flags & DMA_PREP_INTERRUPT;\r\nhw = compl_desc->hw;\r\nhw->ctl = 0;\r\nhw->ctl_f.null = 1;\r\nhw->ctl_f.int_en = !!(flags & DMA_PREP_INTERRUPT);\r\nhw->ctl_f.compl_write = 1;\r\nhw->size = NULL_DESC_BUFFER_SIZE;\r\ndump_desc_dbg(ioat_chan, compl_desc);\r\n}\r\nreturn &compl_desc->txd;\r\n}\r\nstatic struct dma_async_tx_descriptor *\r\n__ioat_prep_pq16_lock(struct dma_chan *c, enum sum_check_flags *result,\r\nconst dma_addr_t *dst, const dma_addr_t *src,\r\nunsigned int src_cnt, const unsigned char *scf,\r\nsize_t len, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(c);\r\nstruct ioatdma_device *ioat_dma = ioat_chan->ioat_dma;\r\nstruct ioat_ring_ent *desc;\r\nsize_t total_len = len;\r\nstruct ioat_pq_descriptor *pq;\r\nu32 offset = 0;\r\nu8 op;\r\nint i, s, idx, num_descs;\r\nop = result ? IOAT_OP_PQ_VAL_16S : IOAT_OP_PQ_16S;\r\ndev_dbg(to_dev(ioat_chan), "%s\n", __func__);\r\nnum_descs = ioat_xferlen_to_descs(ioat_chan, len);\r\nif (num_descs && ioat_check_space_lock(ioat_chan, num_descs) == 0)\r\nidx = ioat_chan->head;\r\nelse\r\nreturn NULL;\r\ni = 0;\r\ndo {\r\nstruct ioat_raw_descriptor *descs[4];\r\nsize_t xfer_size = min_t(size_t, len,\r\n1 << ioat_chan->xfercap_log);\r\ndesc = ioat_get_ring_ent(ioat_chan, idx + i);\r\npq = desc->pq;\r\ndescs[0] = (struct ioat_raw_descriptor *) pq;\r\ndesc->sed = ioat3_alloc_sed(ioat_dma, (src_cnt-2) >> 3);\r\nif (!desc->sed) {\r\ndev_err(to_dev(ioat_chan),\r\n"%s: no free sed entries\n", __func__);\r\nreturn NULL;\r\n}\r\npq->sed_addr = desc->sed->dma;\r\ndesc->sed->parent = desc;\r\ndescs[1] = (struct ioat_raw_descriptor *)desc->sed->hw;\r\ndescs[2] = (void *)descs[1] + 64;\r\nfor (s = 0; s < src_cnt; s++)\r\npq16_set_src(descs, src[s], offset, scf[s], s);\r\nif (dmaf_p_disabled_continue(flags))\r\npq16_set_src(descs, dst[1], offset, 1, s++);\r\nelse if (dmaf_continue(flags)) {\r\npq16_set_src(descs, dst[0], offset, 0, s++);\r\npq16_set_src(descs, dst[1], offset, 1, s++);\r\npq16_set_src(descs, dst[1], offset, 0, s++);\r\n}\r\npq->size = xfer_size;\r\npq->p_addr = dst[0] + offset;\r\npq->q_addr = dst[1] + offset;\r\npq->ctl = 0;\r\npq->ctl_f.op = op;\r\npq->ctl_f.src_cnt = src16_cnt_to_hw(s);\r\nif (ioat_dma->cap & IOAT_CAP_DWBES)\r\npq->ctl_f.wb_en = result ? 1 : 0;\r\npq->ctl_f.p_disable = !!(flags & DMA_PREP_PQ_DISABLE_P);\r\npq->ctl_f.q_disable = !!(flags & DMA_PREP_PQ_DISABLE_Q);\r\nlen -= xfer_size;\r\noffset += xfer_size;\r\n} while (++i < num_descs);\r\ndesc->txd.flags = flags;\r\ndesc->len = total_len;\r\nif (result)\r\ndesc->result = result;\r\npq->ctl_f.fence = !!(flags & DMA_PREP_FENCE);\r\npq->ctl_f.int_en = !!(flags & DMA_PREP_INTERRUPT);\r\npq->ctl_f.compl_write = 1;\r\ndump_pq16_desc_dbg(ioat_chan, desc);\r\nreturn &desc->txd;\r\n}\r\nstatic int src_cnt_flags(unsigned int src_cnt, unsigned long flags)\r\n{\r\nif (dmaf_p_disabled_continue(flags))\r\nreturn src_cnt + 1;\r\nelse if (dmaf_continue(flags))\r\nreturn src_cnt + 3;\r\nelse\r\nreturn src_cnt;\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_pq(struct dma_chan *chan, dma_addr_t *dst, dma_addr_t *src,\r\nunsigned int src_cnt, const unsigned char *scf, size_t len,\r\nunsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(chan);\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nif (flags & DMA_PREP_PQ_DISABLE_P)\r\ndst[0] = dst[1];\r\nif (flags & DMA_PREP_PQ_DISABLE_Q)\r\ndst[1] = dst[0];\r\nif ((flags & DMA_PREP_PQ_DISABLE_P) && src_cnt == 1) {\r\ndma_addr_t single_source[2];\r\nunsigned char single_source_coef[2];\r\nBUG_ON(flags & DMA_PREP_PQ_DISABLE_Q);\r\nsingle_source[0] = src[0];\r\nsingle_source[1] = src[0];\r\nsingle_source_coef[0] = scf[0];\r\nsingle_source_coef[1] = 0;\r\nreturn src_cnt_flags(src_cnt, flags) > 8 ?\r\n__ioat_prep_pq16_lock(chan, NULL, dst, single_source,\r\n2, single_source_coef, len,\r\nflags) :\r\n__ioat_prep_pq_lock(chan, NULL, dst, single_source, 2,\r\nsingle_source_coef, len, flags);\r\n} else {\r\nreturn src_cnt_flags(src_cnt, flags) > 8 ?\r\n__ioat_prep_pq16_lock(chan, NULL, dst, src, src_cnt,\r\nscf, len, flags) :\r\n__ioat_prep_pq_lock(chan, NULL, dst, src, src_cnt,\r\nscf, len, flags);\r\n}\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_pq_val(struct dma_chan *chan, dma_addr_t *pq, dma_addr_t *src,\r\nunsigned int src_cnt, const unsigned char *scf, size_t len,\r\nenum sum_check_flags *pqres, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(chan);\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nif (flags & DMA_PREP_PQ_DISABLE_P)\r\npq[0] = pq[1];\r\nif (flags & DMA_PREP_PQ_DISABLE_Q)\r\npq[1] = pq[0];\r\n*pqres = 0;\r\nreturn src_cnt_flags(src_cnt, flags) > 8 ?\r\n__ioat_prep_pq16_lock(chan, pqres, pq, src, src_cnt, scf, len,\r\nflags) :\r\n__ioat_prep_pq_lock(chan, pqres, pq, src, src_cnt, scf, len,\r\nflags);\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_pqxor(struct dma_chan *chan, dma_addr_t dst, dma_addr_t *src,\r\nunsigned int src_cnt, size_t len, unsigned long flags)\r\n{\r\nunsigned char scf[MAX_SCF];\r\ndma_addr_t pq[2];\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(chan);\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nif (src_cnt > MAX_SCF)\r\nreturn NULL;\r\nmemset(scf, 0, src_cnt);\r\npq[0] = dst;\r\nflags |= DMA_PREP_PQ_DISABLE_Q;\r\npq[1] = dst;\r\nreturn src_cnt_flags(src_cnt, flags) > 8 ?\r\n__ioat_prep_pq16_lock(chan, NULL, pq, src, src_cnt, scf, len,\r\nflags) :\r\n__ioat_prep_pq_lock(chan, NULL, pq, src, src_cnt, scf, len,\r\nflags);\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_pqxor_val(struct dma_chan *chan, dma_addr_t *src,\r\nunsigned int src_cnt, size_t len,\r\nenum sum_check_flags *result, unsigned long flags)\r\n{\r\nunsigned char scf[MAX_SCF];\r\ndma_addr_t pq[2];\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(chan);\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nif (src_cnt > MAX_SCF)\r\nreturn NULL;\r\n*result = 0;\r\nmemset(scf, 0, src_cnt);\r\npq[0] = src[0];\r\nflags |= DMA_PREP_PQ_DISABLE_Q;\r\npq[1] = pq[0];\r\nreturn src_cnt_flags(src_cnt, flags) > 8 ?\r\n__ioat_prep_pq16_lock(chan, result, pq, &src[1], src_cnt - 1,\r\nscf, len, flags) :\r\n__ioat_prep_pq_lock(chan, result, pq, &src[1], src_cnt - 1,\r\nscf, len, flags);\r\n}\r\nstruct dma_async_tx_descriptor *\r\nioat_prep_interrupt_lock(struct dma_chan *c, unsigned long flags)\r\n{\r\nstruct ioatdma_chan *ioat_chan = to_ioat_chan(c);\r\nstruct ioat_ring_ent *desc;\r\nstruct ioat_dma_descriptor *hw;\r\nif (test_bit(IOAT_CHAN_DOWN, &ioat_chan->state))\r\nreturn NULL;\r\nif (ioat_check_space_lock(ioat_chan, 1) == 0)\r\ndesc = ioat_get_ring_ent(ioat_chan, ioat_chan->head);\r\nelse\r\nreturn NULL;\r\nhw = desc->hw;\r\nhw->ctl = 0;\r\nhw->ctl_f.null = 1;\r\nhw->ctl_f.int_en = 1;\r\nhw->ctl_f.fence = !!(flags & DMA_PREP_FENCE);\r\nhw->ctl_f.compl_write = 1;\r\nhw->size = NULL_DESC_BUFFER_SIZE;\r\nhw->src_addr = 0;\r\nhw->dst_addr = 0;\r\ndesc->txd.flags = flags;\r\ndesc->len = 1;\r\ndump_desc_dbg(ioat_chan, desc);\r\nreturn &desc->txd;\r\n}

static void *simple_malloc(unsigned long size)\r\n{\r\nunsigned long i;\r\nstruct alloc_info *p = alloc_tbl;\r\nif (size == 0)\r\ngoto err_out;\r\nsize = _ALIGN_UP(size, alloc_min);\r\nfor (i=0; i<tbl_entries; i++, p++)\r\nif (!(p->flags & ENTRY_BEEN_USED)) {\r\nif (size <= space_left) {\r\np->base = next_base;\r\np->size = size;\r\np->flags = ENTRY_BEEN_USED | ENTRY_IN_USE;\r\nnext_base += size;\r\nspace_left -= size;\r\nreturn (void *)p->base;\r\n}\r\ngoto err_out;\r\n}\r\nelse if (!(p->flags & ENTRY_IN_USE) && (size <= p->size)) {\r\np->flags |= ENTRY_IN_USE;\r\nreturn (void *)p->base;\r\n}\r\nerr_out:\r\nreturn NULL;\r\n}\r\nstatic struct alloc_info *simple_find_entry(void *ptr)\r\n{\r\nunsigned long i;\r\nstruct alloc_info *p = alloc_tbl;\r\nfor (i=0; i<tbl_entries; i++,p++) {\r\nif (!(p->flags & ENTRY_BEEN_USED))\r\nbreak;\r\nif ((p->flags & ENTRY_IN_USE) &&\r\n(p->base == (unsigned long)ptr))\r\nreturn p;\r\n}\r\nreturn NULL;\r\n}\r\nstatic void simple_free(void *ptr)\r\n{\r\nstruct alloc_info *p = simple_find_entry(ptr);\r\nif (p != NULL)\r\np->flags &= ~ENTRY_IN_USE;\r\n}\r\nstatic void *simple_realloc(void *ptr, unsigned long size)\r\n{\r\nstruct alloc_info *p;\r\nvoid *new;\r\nif (size == 0) {\r\nsimple_free(ptr);\r\nreturn NULL;\r\n}\r\nif (ptr == NULL)\r\nreturn simple_malloc(size);\r\np = simple_find_entry(ptr);\r\nif (p == NULL)\r\nreturn NULL;\r\nif (size <= p->size)\r\nreturn ptr;\r\nnew = simple_malloc(size);\r\nmemcpy(new, ptr, p->size);\r\nsimple_free(ptr);\r\nreturn new;\r\n}\r\nvoid *simple_alloc_init(char *base, unsigned long heap_size,\r\nunsigned long granularity, unsigned long max_allocs)\r\n{\r\nunsigned long heap_base, tbl_size;\r\nheap_size = _ALIGN_UP(heap_size, granularity);\r\nalloc_min = granularity;\r\ntbl_entries = max_allocs;\r\ntbl_size = tbl_entries * sizeof(struct alloc_info);\r\nalloc_tbl = (struct alloc_info *)_ALIGN_UP((unsigned long)base, 8);\r\nmemset(alloc_tbl, 0, tbl_size);\r\nheap_base = _ALIGN_UP((unsigned long)alloc_tbl + tbl_size, alloc_min);\r\nnext_base = heap_base;\r\nspace_left = heap_size;\r\nplatform_ops.malloc = simple_malloc;\r\nplatform_ops.free = simple_free;\r\nplatform_ops.realloc = simple_realloc;\r\nreturn (void *)(heap_base + heap_size);\r\n}

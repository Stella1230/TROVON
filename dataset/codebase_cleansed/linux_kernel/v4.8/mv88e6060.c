static int reg_read(struct dsa_switch *ds, int addr, int reg)\r\n{\r\nstruct mv88e6060_priv *priv = ds_to_priv(ds);\r\nreturn mdiobus_read_nested(priv->bus, priv->sw_addr + addr, reg);\r\n}\r\nstatic int reg_write(struct dsa_switch *ds, int addr, int reg, u16 val)\r\n{\r\nstruct mv88e6060_priv *priv = ds_to_priv(ds);\r\nreturn mdiobus_write_nested(priv->bus, priv->sw_addr + addr, reg, val);\r\n}\r\nstatic const char *mv88e6060_get_name(struct mii_bus *bus, int sw_addr)\r\n{\r\nint ret;\r\nret = mdiobus_read(bus, sw_addr + REG_PORT(0), PORT_SWITCH_ID);\r\nif (ret >= 0) {\r\nif (ret == PORT_SWITCH_ID_6060)\r\nreturn "Marvell 88E6060 (A0)";\r\nif (ret == PORT_SWITCH_ID_6060_R1 ||\r\nret == PORT_SWITCH_ID_6060_R2)\r\nreturn "Marvell 88E6060 (B0)";\r\nif ((ret & PORT_SWITCH_ID_6060_MASK) == PORT_SWITCH_ID_6060)\r\nreturn "Marvell 88E6060";\r\n}\r\nreturn NULL;\r\n}\r\nstatic const char *mv88e6060_drv_probe(struct device *dsa_dev,\r\nstruct device *host_dev, int sw_addr,\r\nvoid **_priv)\r\n{\r\nstruct mii_bus *bus = dsa_host_dev_to_mii_bus(host_dev);\r\nstruct mv88e6060_priv *priv;\r\nconst char *name;\r\nname = mv88e6060_get_name(bus, sw_addr);\r\nif (name) {\r\npriv = devm_kzalloc(dsa_dev, sizeof(*priv), GFP_KERNEL);\r\nif (!priv)\r\nreturn NULL;\r\n*_priv = priv;\r\npriv->bus = bus;\r\npriv->sw_addr = sw_addr;\r\n}\r\nreturn name;\r\n}\r\nstatic int mv88e6060_switch_reset(struct dsa_switch *ds)\r\n{\r\nint i;\r\nint ret;\r\nunsigned long timeout;\r\nfor (i = 0; i < MV88E6060_PORTS; i++) {\r\nret = REG_READ(REG_PORT(i), PORT_CONTROL);\r\nREG_WRITE(REG_PORT(i), PORT_CONTROL,\r\nret & ~PORT_CONTROL_STATE_MASK);\r\n}\r\nusleep_range(2000, 4000);\r\nREG_WRITE(REG_GLOBAL, GLOBAL_ATU_CONTROL,\r\nGLOBAL_ATU_CONTROL_SWRESET |\r\nGLOBAL_ATU_CONTROL_ATUSIZE_1024 |\r\nGLOBAL_ATU_CONTROL_ATE_AGE_5MIN);\r\ntimeout = jiffies + 1 * HZ;\r\nwhile (time_before(jiffies, timeout)) {\r\nret = REG_READ(REG_GLOBAL, GLOBAL_STATUS);\r\nif (ret & GLOBAL_STATUS_INIT_READY)\r\nbreak;\r\nusleep_range(1000, 2000);\r\n}\r\nif (time_after(jiffies, timeout))\r\nreturn -ETIMEDOUT;\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_setup_global(struct dsa_switch *ds)\r\n{\r\nREG_WRITE(REG_GLOBAL, GLOBAL_CONTROL, GLOBAL_CONTROL_MAX_FRAME_1536);\r\nREG_WRITE(REG_GLOBAL, GLOBAL_ATU_CONTROL,\r\nGLOBAL_ATU_CONTROL_ATUSIZE_1024 |\r\nGLOBAL_ATU_CONTROL_ATE_AGE_5MIN);\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_setup_port(struct dsa_switch *ds, int p)\r\n{\r\nint addr = REG_PORT(p);\r\nREG_WRITE(addr, PORT_CONTROL,\r\ndsa_is_cpu_port(ds, p) ?\r\nPORT_CONTROL_TRAILER |\r\nPORT_CONTROL_INGRESS_MODE |\r\nPORT_CONTROL_STATE_FORWARDING :\r\nPORT_CONTROL_STATE_FORWARDING);\r\nREG_WRITE(addr, PORT_VLAN_MAP,\r\n((p & 0xf) << PORT_VLAN_MAP_DBNUM_SHIFT) |\r\n(dsa_is_cpu_port(ds, p) ?\r\nds->enabled_port_mask :\r\nBIT(ds->dst->cpu_port)));\r\nREG_WRITE(addr, PORT_ASSOC_VECTOR, BIT(p));\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_setup(struct dsa_switch *ds)\r\n{\r\nint ret;\r\nint i;\r\nret = mv88e6060_switch_reset(ds);\r\nif (ret < 0)\r\nreturn ret;\r\nret = mv88e6060_setup_global(ds);\r\nif (ret < 0)\r\nreturn ret;\r\nfor (i = 0; i < MV88E6060_PORTS; i++) {\r\nret = mv88e6060_setup_port(ds, i);\r\nif (ret < 0)\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_set_addr(struct dsa_switch *ds, u8 *addr)\r\n{\r\nREG_WRITE(REG_GLOBAL, GLOBAL_MAC_01, (addr[0] << 9) | addr[1]);\r\nREG_WRITE(REG_GLOBAL, GLOBAL_MAC_23, (addr[2] << 8) | addr[3]);\r\nREG_WRITE(REG_GLOBAL, GLOBAL_MAC_45, (addr[4] << 8) | addr[5]);\r\nreturn 0;\r\n}\r\nstatic int mv88e6060_port_to_phy_addr(int port)\r\n{\r\nif (port >= 0 && port < MV88E6060_PORTS)\r\nreturn port;\r\nreturn -1;\r\n}\r\nstatic int mv88e6060_phy_read(struct dsa_switch *ds, int port, int regnum)\r\n{\r\nint addr;\r\naddr = mv88e6060_port_to_phy_addr(port);\r\nif (addr == -1)\r\nreturn 0xffff;\r\nreturn reg_read(ds, addr, regnum);\r\n}\r\nstatic int\r\nmv88e6060_phy_write(struct dsa_switch *ds, int port, int regnum, u16 val)\r\n{\r\nint addr;\r\naddr = mv88e6060_port_to_phy_addr(port);\r\nif (addr == -1)\r\nreturn 0xffff;\r\nreturn reg_write(ds, addr, regnum, val);\r\n}\r\nstatic int __init mv88e6060_init(void)\r\n{\r\nregister_switch_driver(&mv88e6060_switch_driver);\r\nreturn 0;\r\n}\r\nstatic void __exit mv88e6060_cleanup(void)\r\n{\r\nunregister_switch_driver(&mv88e6060_switch_driver);\r\n}

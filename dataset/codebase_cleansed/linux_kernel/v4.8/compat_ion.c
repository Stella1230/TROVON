static int compat_get_ion_allocation_data(\r\nstruct compat_ion_allocation_data __user *data32,\r\nstruct ion_allocation_data __user *data)\r\n{\r\ncompat_size_t s;\r\ncompat_uint_t u;\r\ncompat_int_t i;\r\nint err;\r\nerr = get_user(s, &data32->len);\r\nerr |= put_user(s, &data->len);\r\nerr |= get_user(s, &data32->align);\r\nerr |= put_user(s, &data->align);\r\nerr |= get_user(u, &data32->heap_id_mask);\r\nerr |= put_user(u, &data->heap_id_mask);\r\nerr |= get_user(u, &data32->flags);\r\nerr |= put_user(u, &data->flags);\r\nerr |= get_user(i, &data32->handle);\r\nerr |= put_user(i, &data->handle);\r\nreturn err;\r\n}\r\nstatic int compat_get_ion_handle_data(\r\nstruct compat_ion_handle_data __user *data32,\r\nstruct ion_handle_data __user *data)\r\n{\r\ncompat_int_t i;\r\nint err;\r\nerr = get_user(i, &data32->handle);\r\nerr |= put_user(i, &data->handle);\r\nreturn err;\r\n}\r\nstatic int compat_put_ion_allocation_data(\r\nstruct compat_ion_allocation_data __user *data32,\r\nstruct ion_allocation_data __user *data)\r\n{\r\ncompat_size_t s;\r\ncompat_uint_t u;\r\ncompat_int_t i;\r\nint err;\r\nerr = get_user(s, &data->len);\r\nerr |= put_user(s, &data32->len);\r\nerr |= get_user(s, &data->align);\r\nerr |= put_user(s, &data32->align);\r\nerr |= get_user(u, &data->heap_id_mask);\r\nerr |= put_user(u, &data32->heap_id_mask);\r\nerr |= get_user(u, &data->flags);\r\nerr |= put_user(u, &data32->flags);\r\nerr |= get_user(i, &data->handle);\r\nerr |= put_user(i, &data32->handle);\r\nreturn err;\r\n}\r\nstatic int compat_get_ion_custom_data(\r\nstruct compat_ion_custom_data __user *data32,\r\nstruct ion_custom_data __user *data)\r\n{\r\ncompat_uint_t cmd;\r\ncompat_ulong_t arg;\r\nint err;\r\nerr = get_user(cmd, &data32->cmd);\r\nerr |= put_user(cmd, &data->cmd);\r\nerr |= get_user(arg, &data32->arg);\r\nerr |= put_user(arg, &data->arg);\r\nreturn err;\r\n}\r\nlong compat_ion_ioctl(struct file *filp, unsigned int cmd, unsigned long arg)\r\n{\r\nlong ret;\r\nif (!filp->f_op->unlocked_ioctl)\r\nreturn -ENOTTY;\r\nswitch (cmd) {\r\ncase COMPAT_ION_IOC_ALLOC:\r\n{\r\nstruct compat_ion_allocation_data __user *data32;\r\nstruct ion_allocation_data __user *data;\r\nint err;\r\ndata32 = compat_ptr(arg);\r\ndata = compat_alloc_user_space(sizeof(*data));\r\nif (!data)\r\nreturn -EFAULT;\r\nerr = compat_get_ion_allocation_data(data32, data);\r\nif (err)\r\nreturn err;\r\nret = filp->f_op->unlocked_ioctl(filp, ION_IOC_ALLOC,\r\n(unsigned long)data);\r\nerr = compat_put_ion_allocation_data(data32, data);\r\nreturn ret ? ret : err;\r\n}\r\ncase COMPAT_ION_IOC_FREE:\r\n{\r\nstruct compat_ion_handle_data __user *data32;\r\nstruct ion_handle_data __user *data;\r\nint err;\r\ndata32 = compat_ptr(arg);\r\ndata = compat_alloc_user_space(sizeof(*data));\r\nif (!data)\r\nreturn -EFAULT;\r\nerr = compat_get_ion_handle_data(data32, data);\r\nif (err)\r\nreturn err;\r\nreturn filp->f_op->unlocked_ioctl(filp, ION_IOC_FREE,\r\n(unsigned long)data);\r\n}\r\ncase COMPAT_ION_IOC_CUSTOM: {\r\nstruct compat_ion_custom_data __user *data32;\r\nstruct ion_custom_data __user *data;\r\nint err;\r\ndata32 = compat_ptr(arg);\r\ndata = compat_alloc_user_space(sizeof(*data));\r\nif (!data)\r\nreturn -EFAULT;\r\nerr = compat_get_ion_custom_data(data32, data);\r\nif (err)\r\nreturn err;\r\nreturn filp->f_op->unlocked_ioctl(filp, ION_IOC_CUSTOM,\r\n(unsigned long)data);\r\n}\r\ncase ION_IOC_SHARE:\r\ncase ION_IOC_MAP:\r\ncase ION_IOC_IMPORT:\r\ncase ION_IOC_SYNC:\r\nreturn filp->f_op->unlocked_ioctl(filp, cmd,\r\n(unsigned long)compat_ptr(arg));\r\ndefault:\r\nreturn -ENOIOCTLCMD;\r\n}\r\n}

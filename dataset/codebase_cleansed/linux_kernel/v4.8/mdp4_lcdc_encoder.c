static struct mdp4_kms *get_kms(struct drm_encoder *encoder)\r\n{\r\nstruct msm_drm_private *priv = encoder->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic void bs_init(struct mdp4_lcdc_encoder *mdp4_lcdc_encoder)\r\n{\r\nstruct drm_device *dev = mdp4_lcdc_encoder->base.dev;\r\nstruct lcdc_platform_data *lcdc_pdata = mdp4_find_pdata("lvds.0");\r\nif (!lcdc_pdata) {\r\ndev_err(dev->dev, "could not find lvds pdata\n");\r\nreturn;\r\n}\r\nif (lcdc_pdata->bus_scale_table) {\r\nmdp4_lcdc_encoder->bsc = msm_bus_scale_register_client(\r\nlcdc_pdata->bus_scale_table);\r\nDBG("lvds : bus scale client: %08x", mdp4_lcdc_encoder->bsc);\r\n}\r\n}\r\nstatic void bs_fini(struct mdp4_lcdc_encoder *mdp4_lcdc_encoder)\r\n{\r\nif (mdp4_lcdc_encoder->bsc) {\r\nmsm_bus_scale_unregister_client(mdp4_lcdc_encoder->bsc);\r\nmdp4_lcdc_encoder->bsc = 0;\r\n}\r\n}\r\nstatic void bs_set(struct mdp4_lcdc_encoder *mdp4_lcdc_encoder, int idx)\r\n{\r\nif (mdp4_lcdc_encoder->bsc) {\r\nDBG("set bus scaling: %d", idx);\r\nmsm_bus_scale_client_update_request(mdp4_lcdc_encoder->bsc, idx);\r\n}\r\n}\r\nstatic void bs_init(struct mdp4_lcdc_encoder *mdp4_lcdc_encoder) {}\r\nstatic void bs_fini(struct mdp4_lcdc_encoder *mdp4_lcdc_encoder) {}\r\nstatic void bs_set(struct mdp4_lcdc_encoder *mdp4_lcdc_encoder, int idx) {}\r\nstatic void mdp4_lcdc_encoder_destroy(struct drm_encoder *encoder)\r\n{\r\nstruct mdp4_lcdc_encoder *mdp4_lcdc_encoder =\r\nto_mdp4_lcdc_encoder(encoder);\r\nbs_fini(mdp4_lcdc_encoder);\r\ndrm_encoder_cleanup(encoder);\r\nkfree(mdp4_lcdc_encoder);\r\n}\r\nstruct drm_connector *get_connector(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct drm_connector *connector;\r\nlist_for_each_entry(connector, &dev->mode_config.connector_list, head)\r\nif (connector->encoder == encoder)\r\nreturn connector;\r\nreturn NULL;\r\n}\r\nstatic void setup_phy(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct drm_connector *connector = get_connector(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nuint32_t lvds_intf = 0, lvds_phy_cfg0 = 0;\r\nint bpp, nchan, swap;\r\nif (!connector)\r\nreturn;\r\nbpp = 3 * connector->display_info.bpc;\r\nif (!bpp)\r\nbpp = 18;\r\nnchan = 1;\r\nswap = 0;\r\nswitch (bpp) {\r\ncase 24:\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(0),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x08) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x05) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x04) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x03));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(0),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x02) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x01) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x00));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(1),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x11) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x10) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x0d) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x0c));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(1),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x0b) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x0a) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x09));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(2),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x1a) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x19) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x18) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x15));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(2),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x14) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x13) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x12));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(3),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x1b) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x17) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x16) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x0f));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(3),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x0e) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x07) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x06));\r\nif (nchan == 2) {\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE3_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE2_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE1_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE0_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE3_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE2_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE1_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE0_EN;\r\n} else {\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE3_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE2_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE1_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE0_EN;\r\n}\r\nbreak;\r\ncase 18:\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(0),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x0a) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x07) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x06) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x05));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(0),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x04) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x03) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x02));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(1),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x13) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x12) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x0f) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x0e));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(1),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x0d) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x0c) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x0b));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_3_TO_0(2),\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT0(0x1a) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT1(0x19) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT2(0x18) |\r\nMDP4_LCDC_LVDS_MUX_CTL_3_TO_0_BIT3(0x17));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_MUX_CTL_6_TO_4(2),\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT4(0x16) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT5(0x15) |\r\nMDP4_LCDC_LVDS_MUX_CTL_6_TO_4_BIT6(0x14));\r\nif (nchan == 2) {\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE2_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE1_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH2_DATA_LANE0_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE2_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE1_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE0_EN;\r\n} else {\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE2_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE1_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_DATA_LANE0_EN;\r\n}\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_RGB_OUT;\r\nbreak;\r\ndefault:\r\ndev_err(dev->dev, "unknown bpp: %d\n", bpp);\r\nreturn;\r\n}\r\nswitch (nchan) {\r\ncase 1:\r\nlvds_phy_cfg0 = MDP4_LVDS_PHY_CFG0_CHANNEL0;\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH1_CLK_LANE_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_MODE_SEL;\r\nbreak;\r\ncase 2:\r\nlvds_phy_cfg0 = MDP4_LVDS_PHY_CFG0_CHANNEL0 |\r\nMDP4_LVDS_PHY_CFG0_CHANNEL1;\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH2_CLK_LANE_EN |\r\nMDP4_LCDC_LVDS_INTF_CTL_CH1_CLK_LANE_EN;\r\nbreak;\r\ndefault:\r\ndev_err(dev->dev, "unknown # of channels: %d\n", nchan);\r\nreturn;\r\n}\r\nif (swap)\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_CH_SWAP;\r\nlvds_intf |= MDP4_LCDC_LVDS_INTF_CTL_ENABLE;\r\nmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_CFG0, lvds_phy_cfg0);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_LVDS_INTF_CTL, lvds_intf);\r\nmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_CFG2, 0x30);\r\nmb();\r\nudelay(1);\r\nlvds_phy_cfg0 |= MDP4_LVDS_PHY_CFG0_SERIALIZATION_ENBLE;\r\nmdp4_write(mdp4_kms, REG_MDP4_LVDS_PHY_CFG0, lvds_phy_cfg0);\r\n}\r\nstatic void mdp4_lcdc_encoder_mode_set(struct drm_encoder *encoder,\r\nstruct drm_display_mode *mode,\r\nstruct drm_display_mode *adjusted_mode)\r\n{\r\nstruct mdp4_lcdc_encoder *mdp4_lcdc_encoder =\r\nto_mdp4_lcdc_encoder(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nuint32_t lcdc_hsync_skew, vsync_period, vsync_len, ctrl_pol;\r\nuint32_t display_v_start, display_v_end;\r\nuint32_t hsync_start_x, hsync_end_x;\r\nmode = adjusted_mode;\r\nDBG("set mode: %d:\"%s\" %d %d %d %d %d %d %d %d %d %d 0x%x 0x%x",\r\nmode->base.id, mode->name,\r\nmode->vrefresh, mode->clock,\r\nmode->hdisplay, mode->hsync_start,\r\nmode->hsync_end, mode->htotal,\r\nmode->vdisplay, mode->vsync_start,\r\nmode->vsync_end, mode->vtotal,\r\nmode->type, mode->flags);\r\nmdp4_lcdc_encoder->pixclock = mode->clock * 1000;\r\nDBG("pixclock=%lu", mdp4_lcdc_encoder->pixclock);\r\nctrl_pol = 0;\r\nif (mode->flags & DRM_MODE_FLAG_NHSYNC)\r\nctrl_pol |= MDP4_LCDC_CTRL_POLARITY_HSYNC_LOW;\r\nif (mode->flags & DRM_MODE_FLAG_NVSYNC)\r\nctrl_pol |= MDP4_LCDC_CTRL_POLARITY_VSYNC_LOW;\r\nlcdc_hsync_skew = 0;\r\nhsync_start_x = (mode->htotal - mode->hsync_start);\r\nhsync_end_x = mode->htotal - (mode->hsync_start - mode->hdisplay) - 1;\r\nvsync_period = mode->vtotal * mode->htotal;\r\nvsync_len = (mode->vsync_end - mode->vsync_start) * mode->htotal;\r\ndisplay_v_start = (mode->vtotal - mode->vsync_start) * mode->htotal + lcdc_hsync_skew;\r\ndisplay_v_end = vsync_period - ((mode->vsync_start - mode->vdisplay) * mode->htotal) + lcdc_hsync_skew - 1;\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_HSYNC_CTRL,\r\nMDP4_LCDC_HSYNC_CTRL_PULSEW(mode->hsync_end - mode->hsync_start) |\r\nMDP4_LCDC_HSYNC_CTRL_PERIOD(mode->htotal));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_VSYNC_PERIOD, vsync_period);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_VSYNC_LEN, vsync_len);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_DISPLAY_HCTRL,\r\nMDP4_LCDC_DISPLAY_HCTRL_START(hsync_start_x) |\r\nMDP4_LCDC_DISPLAY_HCTRL_END(hsync_end_x));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_DISPLAY_VSTART, display_v_start);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_DISPLAY_VEND, display_v_end);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_BORDER_CLR, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_UNDERFLOW_CLR,\r\nMDP4_LCDC_UNDERFLOW_CLR_ENABLE_RECOVERY |\r\nMDP4_LCDC_UNDERFLOW_CLR_COLOR(0xff));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_HSYNC_SKEW, lcdc_hsync_skew);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_CTRL_POLARITY, ctrl_pol);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_ACTIVE_HCTL,\r\nMDP4_LCDC_ACTIVE_HCTL_START(0) |\r\nMDP4_LCDC_ACTIVE_HCTL_END(0));\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_ACTIVE_VSTART, 0);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_ACTIVE_VEND, 0);\r\n}\r\nstatic void mdp4_lcdc_encoder_disable(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct mdp4_lcdc_encoder *mdp4_lcdc_encoder =\r\nto_mdp4_lcdc_encoder(encoder);\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nstruct drm_panel *panel;\r\nint i, ret;\r\nif (WARN_ON(!mdp4_lcdc_encoder->enabled))\r\nreturn;\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_ENABLE, 0);\r\npanel = of_drm_find_panel(mdp4_lcdc_encoder->panel_node);\r\nif (panel) {\r\ndrm_panel_disable(panel);\r\ndrm_panel_unprepare(panel);\r\n}\r\nmdp_irq_wait(&mdp4_kms->base, MDP4_IRQ_PRIMARY_VSYNC);\r\nclk_disable_unprepare(mdp4_lcdc_encoder->lcdc_clk);\r\nfor (i = 0; i < ARRAY_SIZE(mdp4_lcdc_encoder->regs); i++) {\r\nret = regulator_disable(mdp4_lcdc_encoder->regs[i]);\r\nif (ret)\r\ndev_err(dev->dev, "failed to disable regulator: %d\n", ret);\r\n}\r\nbs_set(mdp4_lcdc_encoder, 0);\r\nmdp4_lcdc_encoder->enabled = false;\r\n}\r\nstatic void mdp4_lcdc_encoder_enable(struct drm_encoder *encoder)\r\n{\r\nstruct drm_device *dev = encoder->dev;\r\nstruct mdp4_lcdc_encoder *mdp4_lcdc_encoder =\r\nto_mdp4_lcdc_encoder(encoder);\r\nunsigned long pc = mdp4_lcdc_encoder->pixclock;\r\nstruct mdp4_kms *mdp4_kms = get_kms(encoder);\r\nstruct drm_panel *panel;\r\nint i, ret;\r\nif (WARN_ON(mdp4_lcdc_encoder->enabled))\r\nreturn;\r\nmdp4_crtc_set_config(encoder->crtc,\r\nMDP4_DMA_CONFIG_R_BPC(BPC6) |\r\nMDP4_DMA_CONFIG_G_BPC(BPC6) |\r\nMDP4_DMA_CONFIG_B_BPC(BPC6) |\r\nMDP4_DMA_CONFIG_PACK_ALIGN_MSB |\r\nMDP4_DMA_CONFIG_PACK(0x21) |\r\nMDP4_DMA_CONFIG_DEFLKR_EN |\r\nMDP4_DMA_CONFIG_DITHER_EN);\r\nmdp4_crtc_set_intf(encoder->crtc, INTF_LCDC_DTV, 0);\r\nbs_set(mdp4_lcdc_encoder, 1);\r\nfor (i = 0; i < ARRAY_SIZE(mdp4_lcdc_encoder->regs); i++) {\r\nret = regulator_enable(mdp4_lcdc_encoder->regs[i]);\r\nif (ret)\r\ndev_err(dev->dev, "failed to enable regulator: %d\n", ret);\r\n}\r\nDBG("setting lcdc_clk=%lu", pc);\r\nret = clk_set_rate(mdp4_lcdc_encoder->lcdc_clk, pc);\r\nif (ret)\r\ndev_err(dev->dev, "failed to configure lcdc_clk: %d\n", ret);\r\nret = clk_prepare_enable(mdp4_lcdc_encoder->lcdc_clk);\r\nif (ret)\r\ndev_err(dev->dev, "failed to enable lcdc_clk: %d\n", ret);\r\npanel = of_drm_find_panel(mdp4_lcdc_encoder->panel_node);\r\nif (panel) {\r\ndrm_panel_prepare(panel);\r\ndrm_panel_enable(panel);\r\n}\r\nsetup_phy(encoder);\r\nmdp4_write(mdp4_kms, REG_MDP4_LCDC_ENABLE, 1);\r\nmdp4_lcdc_encoder->enabled = true;\r\n}\r\nlong mdp4_lcdc_round_pixclk(struct drm_encoder *encoder, unsigned long rate)\r\n{\r\nstruct mdp4_lcdc_encoder *mdp4_lcdc_encoder =\r\nto_mdp4_lcdc_encoder(encoder);\r\nreturn clk_round_rate(mdp4_lcdc_encoder->lcdc_clk, rate);\r\n}\r\nstruct drm_encoder *mdp4_lcdc_encoder_init(struct drm_device *dev,\r\nstruct device_node *panel_node)\r\n{\r\nstruct drm_encoder *encoder = NULL;\r\nstruct mdp4_lcdc_encoder *mdp4_lcdc_encoder;\r\nstruct regulator *reg;\r\nint ret;\r\nmdp4_lcdc_encoder = kzalloc(sizeof(*mdp4_lcdc_encoder), GFP_KERNEL);\r\nif (!mdp4_lcdc_encoder) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nmdp4_lcdc_encoder->panel_node = panel_node;\r\nencoder = &mdp4_lcdc_encoder->base;\r\ndrm_encoder_init(dev, encoder, &mdp4_lcdc_encoder_funcs,\r\nDRM_MODE_ENCODER_LVDS, NULL);\r\ndrm_encoder_helper_add(encoder, &mdp4_lcdc_encoder_helper_funcs);\r\nmdp4_lcdc_encoder->lcdc_clk = mpd4_lvds_pll_init(dev);\r\nif (IS_ERR(mdp4_lcdc_encoder->lcdc_clk)) {\r\ndev_err(dev->dev, "failed to get lvds_clk\n");\r\nret = PTR_ERR(mdp4_lcdc_encoder->lcdc_clk);\r\ngoto fail;\r\n}\r\nreg = devm_regulator_get(dev->dev, "lvds-vccs-3p3v");\r\nif (IS_ERR(reg)) {\r\nret = PTR_ERR(reg);\r\ndev_err(dev->dev, "failed to get lvds-vccs-3p3v: %d\n", ret);\r\ngoto fail;\r\n}\r\nmdp4_lcdc_encoder->regs[0] = reg;\r\nreg = devm_regulator_get(dev->dev, "lvds-pll-vdda");\r\nif (IS_ERR(reg)) {\r\nret = PTR_ERR(reg);\r\ndev_err(dev->dev, "failed to get lvds-pll-vdda: %d\n", ret);\r\ngoto fail;\r\n}\r\nmdp4_lcdc_encoder->regs[1] = reg;\r\nreg = devm_regulator_get(dev->dev, "lvds-vdda");\r\nif (IS_ERR(reg)) {\r\nret = PTR_ERR(reg);\r\ndev_err(dev->dev, "failed to get lvds-vdda: %d\n", ret);\r\ngoto fail;\r\n}\r\nmdp4_lcdc_encoder->regs[2] = reg;\r\nbs_init(mdp4_lcdc_encoder);\r\nreturn encoder;\r\nfail:\r\nif (encoder)\r\nmdp4_lcdc_encoder_destroy(encoder);\r\nreturn ERR_PTR(ret);\r\n}

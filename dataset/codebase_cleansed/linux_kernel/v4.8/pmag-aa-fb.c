static int aafb_cursor(struct fb_info *info, struct fb_cursor *cursor)\r\n{\r\nstruct aafb_par *par = info->par;\r\nif (cursor->image.height > BT431_CURSOR_SIZE ||\r\ncursor->image.width > BT431_CURSOR_SIZE) {\r\nbt431_erase_cursor(par->bt431);\r\nreturn -EINVAL;\r\n}\r\nif (!cursor->enable)\r\nbt431_erase_cursor(par->bt431);\r\nif (cursor->set & FB_CUR_SETPOS)\r\nbt431_position_cursor(par->bt431,\r\ncursor->image.dx, cursor->image.dy);\r\nif (cursor->set & FB_CUR_SETCMAP) {\r\nu8 fg = cursor->image.fg_color ? 0xf : 0x0;\r\nu8 bg = cursor->image.bg_color ? 0xf : 0x0;\r\nbt455_write_cmap_entry(par->bt455, 8, bg);\r\nbt455_write_cmap_next(par->bt455, bg);\r\nbt455_write_ovly_next(par->bt455, fg);\r\n}\r\nif (cursor->set & (FB_CUR_SETSIZE | FB_CUR_SETSHAPE | FB_CUR_SETIMAGE))\r\nbt431_set_cursor(par->bt431,\r\ncursor->image.data, cursor->mask, cursor->rop,\r\ncursor->image.width, cursor->image.height);\r\nif (cursor->enable)\r\nbt431_enable_cursor(par->bt431);\r\nreturn 0;\r\n}\r\nstatic int aafb_blank(int blank, struct fb_info *info)\r\n{\r\nstruct aafb_par *par = info->par;\r\nu8 val = blank ? 0x00 : 0x0f;\r\nbt455_write_cmap_entry(par->bt455, 1, val);\r\nreturn 0;\r\n}\r\nstatic int pmagaafb_probe(struct device *dev)\r\n{\r\nstruct tc_dev *tdev = to_tc_dev(dev);\r\nresource_size_t start, len;\r\nstruct fb_info *info;\r\nstruct aafb_par *par;\r\nint err;\r\ninfo = framebuffer_alloc(sizeof(struct aafb_par), dev);\r\nif (!info) {\r\nprintk(KERN_ERR "%s: Cannot allocate memory\n", dev_name(dev));\r\nreturn -ENOMEM;\r\n}\r\npar = info->par;\r\ndev_set_drvdata(dev, info);\r\ninfo->fbops = &aafb_ops;\r\ninfo->fix = aafb_fix;\r\ninfo->var = aafb_defined;\r\ninfo->flags = FBINFO_DEFAULT;\r\nstart = tdev->resource.start;\r\nlen = tdev->resource.end - start + 1;\r\nif (!request_mem_region(start, len, dev_name(dev))) {\r\nprintk(KERN_ERR "%s: Cannot reserve FB region\n",\r\ndev_name(dev));\r\nerr = -EBUSY;\r\ngoto err_alloc;\r\n}\r\ninfo->fix.mmio_start = start + PMAG_AA_BT455_OFFSET;\r\npar->mmio = ioremap_nocache(info->fix.mmio_start, info->fix.mmio_len);\r\nif (!par->mmio) {\r\nprintk(KERN_ERR "%s: Cannot map MMIO\n", dev_name(dev));\r\nerr = -ENOMEM;\r\ngoto err_resource;\r\n}\r\npar->bt455 = par->mmio - PMAG_AA_BT455_OFFSET + PMAG_AA_BT455_OFFSET;\r\npar->bt431 = par->mmio - PMAG_AA_BT455_OFFSET + PMAG_AA_BT431_OFFSET;\r\ninfo->fix.smem_start = start + PMAG_AA_ONBOARD_FBMEM_OFFSET;\r\ninfo->screen_base = ioremap_nocache(info->fix.smem_start,\r\ninfo->fix.smem_len);\r\nif (!info->screen_base) {\r\nprintk(KERN_ERR "%s: Cannot map FB\n", dev_name(dev));\r\nerr = -ENOMEM;\r\ngoto err_mmio_map;\r\n}\r\ninfo->screen_size = info->fix.smem_len;\r\nbt455_write_cmap_entry(par->bt455, 0, 0x0);\r\nbt455_write_cmap_next(par->bt455, 0xf);\r\nbt431_erase_cursor(par->bt431);\r\nbt431_init_cursor(par->bt431);\r\nerr = register_framebuffer(info);\r\nif (err < 0) {\r\nprintk(KERN_ERR "%s: Cannot register framebuffer\n",\r\ndev_name(dev));\r\ngoto err_smem_map;\r\n}\r\nget_device(dev);\r\npr_info("fb%d: %s frame buffer device at %s\n",\r\ninfo->node, info->fix.id, dev_name(dev));\r\nreturn 0;\r\nerr_smem_map:\r\niounmap(info->screen_base);\r\nerr_mmio_map:\r\niounmap(par->mmio);\r\nerr_resource:\r\nrelease_mem_region(start, len);\r\nerr_alloc:\r\nframebuffer_release(info);\r\nreturn err;\r\n}\r\nstatic int __exit pmagaafb_remove(struct device *dev)\r\n{\r\nstruct tc_dev *tdev = to_tc_dev(dev);\r\nstruct fb_info *info = dev_get_drvdata(dev);\r\nstruct aafb_par *par = info->par;\r\nresource_size_t start, len;\r\nput_device(dev);\r\nunregister_framebuffer(info);\r\niounmap(info->screen_base);\r\niounmap(par->mmio);\r\nstart = tdev->resource.start;\r\nlen = tdev->resource.end - start + 1;\r\nrelease_mem_region(start, len);\r\nframebuffer_release(info);\r\nreturn 0;\r\n}\r\nstatic int __init pmagaafb_init(void)\r\n{\r\n#ifndef MODULE\r\nif (fb_get_options("pmagaafb", NULL))\r\nreturn -ENXIO;\r\n#endif\r\nreturn tc_register_driver(&pmagaafb_driver);\r\n}\r\nstatic void __exit pmagaafb_exit(void)\r\n{\r\ntc_unregister_driver(&pmagaafb_driver);\r\n}

acpi_status __init acpi_load_tables(void)\r\n{\r\nacpi_status status;\r\nACPI_FUNCTION_TRACE(acpi_load_tables);\r\nstatus = acpi_ev_install_region_handlers();\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"During Region initialization"));\r\nreturn_ACPI_STATUS(status);\r\n}\r\nstatus = acpi_tb_load_namespace();\r\nif (status == AE_CTRL_TERMINATE) {\r\nstatus = AE_OK;\r\n}\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"While loading namespace from ACPI tables"));\r\n}\r\nif (!acpi_gbl_group_module_level_code) {\r\nstatus = acpi_ns_initialize_objects();\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\n}\r\nacpi_gbl_namespace_initialized = TRUE;\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_tb_load_namespace(void)\r\n{\r\nacpi_status status;\r\nu32 i;\r\nstruct acpi_table_header *new_dsdt;\r\nstruct acpi_table_desc *table;\r\nu32 tables_loaded = 0;\r\nu32 tables_failed = 0;\r\nACPI_FUNCTION_TRACE(tb_load_namespace);\r\n(void)acpi_ut_acquire_mutex(ACPI_MTX_TABLES);\r\ntable = &acpi_gbl_root_table_list.tables[acpi_gbl_dsdt_index];\r\nif (!acpi_gbl_root_table_list.current_table_count ||\r\n!ACPI_COMPARE_NAME(table->signature.ascii, ACPI_SIG_DSDT) ||\r\nACPI_FAILURE(acpi_tb_validate_table(table))) {\r\nstatus = AE_NO_ACPI_TABLES;\r\ngoto unlock_and_exit;\r\n}\r\nacpi_gbl_DSDT = table->pointer;\r\nif (acpi_gbl_copy_dsdt_locally) {\r\nnew_dsdt = acpi_tb_copy_dsdt(acpi_gbl_dsdt_index);\r\nif (new_dsdt) {\r\nacpi_gbl_DSDT = new_dsdt;\r\n}\r\n}\r\nmemcpy(&acpi_gbl_original_dsdt_header, acpi_gbl_DSDT,\r\nsizeof(struct acpi_table_header));\r\n(void)acpi_ut_release_mutex(ACPI_MTX_TABLES);\r\nstatus = acpi_ns_load_table(acpi_gbl_dsdt_index, acpi_gbl_root_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status, "[DSDT] table load failed"));\r\ntables_failed++;\r\n} else {\r\ntables_loaded++;\r\n}\r\n(void)acpi_ut_acquire_mutex(ACPI_MTX_TABLES);\r\nfor (i = 0; i < acpi_gbl_root_table_list.current_table_count; ++i) {\r\ntable = &acpi_gbl_root_table_list.tables[i];\r\nif (!acpi_gbl_root_table_list.tables[i].address ||\r\n(!ACPI_COMPARE_NAME(table->signature.ascii, ACPI_SIG_SSDT)\r\n&& !ACPI_COMPARE_NAME(table->signature.ascii,\r\nACPI_SIG_PSDT)\r\n&& !ACPI_COMPARE_NAME(table->signature.ascii,\r\nACPI_SIG_OSDT))\r\n|| ACPI_FAILURE(acpi_tb_validate_table(table))) {\r\ncontinue;\r\n}\r\n(void)acpi_ut_release_mutex(ACPI_MTX_TABLES);\r\nstatus = acpi_ns_load_table(i, acpi_gbl_root_node);\r\nif (ACPI_FAILURE(status)) {\r\nACPI_EXCEPTION((AE_INFO, status,\r\n"(%4.4s:%8.8s) while loading table",\r\ntable->signature.ascii,\r\ntable->pointer->oem_table_id));\r\ntables_failed++;\r\nACPI_DEBUG_PRINT_RAW((ACPI_DB_INIT,\r\n"Table [%4.4s:%8.8s] (id FF) - Table namespace load failed\n\n",\r\ntable->signature.ascii,\r\ntable->pointer->oem_table_id));\r\n} else {\r\ntables_loaded++;\r\n}\r\n(void)acpi_ut_acquire_mutex(ACPI_MTX_TABLES);\r\n}\r\nif (!tables_failed) {\r\nACPI_INFO(("%u ACPI AML tables successfully acquired and loaded\n", tables_loaded));\r\n} else {\r\nACPI_ERROR((AE_INFO,\r\n"%u table load failures, %u successful",\r\ntables_failed, tables_loaded));\r\nstatus = AE_CTRL_TERMINATE;\r\n}\r\nunlock_and_exit:\r\n(void)acpi_ut_release_mutex(ACPI_MTX_TABLES);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status __init\r\nacpi_install_table(acpi_physical_address address, u8 physical)\r\n{\r\nacpi_status status;\r\nu8 flags;\r\nu32 table_index;\r\nACPI_FUNCTION_TRACE(acpi_install_table);\r\nif (physical) {\r\nflags = ACPI_TABLE_ORIGIN_INTERNAL_PHYSICAL;\r\n} else {\r\nflags = ACPI_TABLE_ORIGIN_EXTERNAL_VIRTUAL;\r\n}\r\nstatus = acpi_tb_install_standard_table(address, flags,\r\nFALSE, FALSE, &table_index);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_load_table(struct acpi_table_header *table)\r\n{\r\nacpi_status status;\r\nu32 table_index;\r\nACPI_FUNCTION_TRACE(acpi_load_table);\r\nif (!table) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_INTERPRETER);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nACPI_INFO(("Host-directed Dynamic ACPI Table Load:"));\r\n(void)acpi_ut_acquire_mutex(ACPI_MTX_TABLES);\r\nstatus = acpi_tb_install_standard_table(ACPI_PTR_TO_PHYSADDR(table),\r\nACPI_TABLE_ORIGIN_EXTERNAL_VIRTUAL,\r\nTRUE, FALSE, &table_index);\r\n(void)acpi_ut_release_mutex(ACPI_MTX_TABLES);\r\nif (ACPI_FAILURE(status)) {\r\ngoto unlock_and_exit;\r\n}\r\nstatus =\r\nacpi_tb_validate_table(&acpi_gbl_root_table_list.\r\ntables[table_index]);\r\nif (ACPI_FAILURE(status)) {\r\ngoto unlock_and_exit;\r\n}\r\nstatus = acpi_ns_load_table(table_index, acpi_gbl_root_node);\r\nif (acpi_gbl_table_handler) {\r\n(void)acpi_gbl_table_handler(ACPI_TABLE_EVENT_LOAD, table,\r\nacpi_gbl_table_handler_context);\r\n}\r\nunlock_and_exit:\r\n(void)acpi_ut_release_mutex(ACPI_MTX_INTERPRETER);\r\nreturn_ACPI_STATUS(status);\r\n}\r\nacpi_status acpi_unload_parent_table(acpi_handle object)\r\n{\r\nstruct acpi_namespace_node *node =\r\nACPI_CAST_PTR(struct acpi_namespace_node, object);\r\nacpi_status status = AE_NOT_EXIST;\r\nacpi_owner_id owner_id;\r\nu32 i;\r\nACPI_FUNCTION_TRACE(acpi_unload_parent_table);\r\nif (!object) {\r\nreturn_ACPI_STATUS(AE_BAD_PARAMETER);\r\n}\r\nowner_id = node->owner_id;\r\nif (!owner_id) {\r\nreturn_ACPI_STATUS(AE_TYPE);\r\n}\r\nstatus = acpi_ut_acquire_mutex(ACPI_MTX_INTERPRETER);\r\nif (ACPI_FAILURE(status)) {\r\nreturn_ACPI_STATUS(status);\r\n}\r\nfor (i = 0; i < acpi_gbl_root_table_list.current_table_count; i++) {\r\nif (owner_id != acpi_gbl_root_table_list.tables[i].owner_id) {\r\ncontinue;\r\n}\r\nif (ACPI_COMPARE_NAME\r\n(acpi_gbl_root_table_list.tables[i].signature.ascii,\r\nACPI_SIG_DSDT)) {\r\nstatus = AE_TYPE;\r\nbreak;\r\n}\r\nif (!acpi_tb_is_table_loaded(i)) {\r\nstatus = AE_NOT_EXIST;\r\nbreak;\r\n}\r\nif (acpi_gbl_table_handler) {\r\n(void)acpi_gbl_table_handler(ACPI_TABLE_EVENT_UNLOAD,\r\nacpi_gbl_root_table_list.\r\ntables[i].pointer,\r\nacpi_gbl_table_handler_context);\r\n}\r\nstatus = acpi_tb_delete_namespace_by_owner(i);\r\nif (ACPI_FAILURE(status)) {\r\nbreak;\r\n}\r\nstatus = acpi_tb_release_owner_id(i);\r\nacpi_tb_set_table_loaded_flag(i, FALSE);\r\nbreak;\r\n}\r\n(void)acpi_ut_release_mutex(ACPI_MTX_INTERPRETER);\r\nreturn_ACPI_STATUS(status);\r\n}

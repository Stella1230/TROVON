static struct menf21bmc_hwmon *menf21bmc_hwmon_update(struct device *dev)\r\n{\r\nint i;\r\nint val;\r\nstruct menf21bmc_hwmon *drv_data = dev_get_drvdata(dev);\r\nstruct menf21bmc_hwmon *data_ret = drv_data;\r\nif (time_after(jiffies, drv_data->last_update + HZ)\r\n|| !drv_data->valid) {\r\nfor (i = 0; i < BMC_VOLT_COUNT; i++) {\r\nval = i2c_smbus_read_word_data(drv_data->i2c_client,\r\nIDX_TO_VOLT_INP_CMD(i));\r\nif (val < 0) {\r\ndata_ret = ERR_PTR(val);\r\ngoto abort;\r\n}\r\ndrv_data->in_val[i] = val;\r\n}\r\ndrv_data->last_update = jiffies;\r\ndrv_data->valid = true;\r\n}\r\nabort:\r\nreturn data_ret;\r\n}\r\nstatic int menf21bmc_hwmon_get_volt_limits(struct menf21bmc_hwmon *drv_data)\r\n{\r\nint i, val;\r\nfor (i = 0; i < BMC_VOLT_COUNT; i++) {\r\nval = i2c_smbus_read_word_data(drv_data->i2c_client,\r\nIDX_TO_VOLT_MIN_CMD(i));\r\nif (val < 0)\r\nreturn val;\r\ndrv_data->in_min[i] = val;\r\nval = i2c_smbus_read_word_data(drv_data->i2c_client,\r\nIDX_TO_VOLT_MAX_CMD(i));\r\nif (val < 0)\r\nreturn val;\r\ndrv_data->in_max[i] = val;\r\n}\r\nreturn 0;\r\n}\r\nstatic ssize_t\r\nshow_label(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nreturn sprintf(buf, "%s\n", input_names[attr->index]);\r\n}\r\nstatic ssize_t\r\nshow_in(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct menf21bmc_hwmon *drv_data = menf21bmc_hwmon_update(dev);\r\nif (IS_ERR(drv_data))\r\nreturn PTR_ERR(drv_data);\r\nreturn sprintf(buf, "%d\n", drv_data->in_val[attr->index]);\r\n}\r\nstatic ssize_t\r\nshow_min(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct menf21bmc_hwmon *drv_data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", drv_data->in_min[attr->index]);\r\n}\r\nstatic ssize_t\r\nshow_max(struct device *dev, struct device_attribute *devattr, char *buf)\r\n{\r\nstruct sensor_device_attribute *attr = to_sensor_dev_attr(devattr);\r\nstruct menf21bmc_hwmon *drv_data = dev_get_drvdata(dev);\r\nreturn sprintf(buf, "%d\n", drv_data->in_max[attr->index]);\r\n}\r\nstatic int menf21bmc_hwmon_probe(struct platform_device *pdev)\r\n{\r\nint ret;\r\nstruct menf21bmc_hwmon *drv_data;\r\nstruct i2c_client *i2c_client = to_i2c_client(pdev->dev.parent);\r\nstruct device *hwmon_dev;\r\ndrv_data = devm_kzalloc(&pdev->dev, sizeof(struct menf21bmc_hwmon),\r\nGFP_KERNEL);\r\nif (!drv_data)\r\nreturn -ENOMEM;\r\ndrv_data->i2c_client = i2c_client;\r\nret = menf21bmc_hwmon_get_volt_limits(drv_data);\r\nif (ret) {\r\ndev_err(&pdev->dev, "failed to read sensor limits");\r\nreturn ret;\r\n}\r\nhwmon_dev = devm_hwmon_device_register_with_groups(&pdev->dev,\r\n"menf21bmc", drv_data,\r\nmenf21bmc_hwmon_groups);\r\nif (IS_ERR(hwmon_dev))\r\nreturn PTR_ERR(hwmon_dev);\r\ndev_info(&pdev->dev, "MEN 14F021P00 BMC hwmon device enabled");\r\nreturn 0;\r\n}

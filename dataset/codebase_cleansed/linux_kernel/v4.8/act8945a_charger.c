static int act8945a_get_charger_state(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status, state;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nif (state == APCH_STATE_CSTATE_EOC) {\r\nif (status & APCH_STATUS_CHGDAT)\r\n*val = POWER_SUPPLY_STATUS_FULL;\r\nelse\r\n*val = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\n} else if ((state == APCH_STATE_CSTATE_FAST) ||\r\n(state == APCH_STATE_CSTATE_PRE)) {\r\n*val = POWER_SUPPLY_STATUS_CHARGING;\r\n} else {\r\n*val = POWER_SUPPLY_STATUS_NOT_CHARGING;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_get_charge_type(struct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int state;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATE, &state);\r\nif (ret < 0)\r\nreturn ret;\r\nstate &= APCH_STATE_CSTATE;\r\nstate >>= APCH_STATE_CSTATE_SHIFT;\r\nswitch (state) {\r\ncase APCH_STATE_CSTATE_PRE:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_TRICKLE;\r\nbreak;\r\ncase APCH_STATE_CSTATE_FAST:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_FAST;\r\nbreak;\r\ncase APCH_STATE_CSTATE_EOC:\r\ncase APCH_STATE_CSTATE_DISABLED:\r\ndefault:\r\n*val = POWER_SUPPLY_CHARGE_TYPE_NONE;\r\n}\r\nreturn 0;\r\n}\r\nstatic int act8945a_get_battery_health(struct act8945a_charger *charger,\r\nstruct regmap *regmap, int *val)\r\n{\r\nint ret;\r\nunsigned int status;\r\nret = regmap_read(regmap, ACT8945A_APCH_STATUS, &status);\r\nif (ret < 0)\r\nreturn ret;\r\nif (charger->battery_temperature && !(status & APCH_STATUS_TEMPDAT))\r\n*val = POWER_SUPPLY_HEALTH_OVERHEAT;\r\nelse if (!(status & APCH_STATUS_INDAT))\r\n*val = POWER_SUPPLY_HEALTH_OVERVOLTAGE;\r\nelse if (status & APCH_STATUS_TIMRDAT)\r\n*val = POWER_SUPPLY_HEALTH_SAFETY_TIMER_EXPIRE;\r\nelse\r\n*val = POWER_SUPPLY_HEALTH_GOOD;\r\nreturn 0;\r\n}\r\nstatic int act8945a_charger_get_property(struct power_supply *psy,\r\nenum power_supply_property prop,\r\nunion power_supply_propval *val)\r\n{\r\nstruct act8945a_charger *charger = power_supply_get_drvdata(psy);\r\nstruct regmap *regmap = charger->regmap;\r\nint ret = 0;\r\nswitch (prop) {\r\ncase POWER_SUPPLY_PROP_STATUS:\r\nret = act8945a_get_charger_state(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_CHARGE_TYPE:\r\nret = act8945a_get_charge_type(regmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_TECHNOLOGY:\r\nval->intval = POWER_SUPPLY_TECHNOLOGY_LION;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_HEALTH:\r\nret = act8945a_get_battery_health(charger,\r\nregmap, &val->intval);\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MODEL_NAME:\r\nval->strval = act8945a_charger_model;\r\nbreak;\r\ncase POWER_SUPPLY_PROP_MANUFACTURER:\r\nval->strval = act8945a_charger_manufacturer;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic int act8945a_charger_config(struct device *dev,\r\nstruct act8945a_charger *charger)\r\n{\r\nstruct device_node *np = dev->of_node;\r\nenum of_gpio_flags flags;\r\nstruct regmap *regmap = charger->regmap;\r\nu32 total_time_out;\r\nu32 pre_time_out;\r\nu32 input_voltage_threshold;\r\nint chglev_pin;\r\nunsigned int value = 0;\r\nif (!np) {\r\ndev_err(dev, "no charger of node\n");\r\nreturn -EINVAL;\r\n}\r\ncharger->battery_temperature = of_property_read_bool(np,\r\n"active-semi,check-battery-temperature");\r\nchglev_pin = of_get_named_gpio_flags(np,\r\n"active-semi,chglev-gpios", 0, &flags);\r\nif (gpio_is_valid(chglev_pin)) {\r\ngpio_set_value(chglev_pin,\r\n((flags == OF_GPIO_ACTIVE_LOW) ? 0 : 1));\r\n}\r\nif (of_property_read_u32(np,\r\n"active-semi,input-voltage-threshold-microvolt",\r\n&input_voltage_threshold))\r\ninput_voltage_threshold = DEFAULT_INPUT_OVP_THRESHOLD;\r\nif (of_property_read_u32(np,\r\n"active-semi,precondition-timeout",\r\n&pre_time_out))\r\npre_time_out = DEFAULT_PRE_TIME_OUT;\r\nif (of_property_read_u32(np, "active-semi,total-timeout",\r\n&total_time_out))\r\ntotal_time_out = DEFAULT_TOTAL_TIME_OUT;\r\nswitch (input_voltage_threshold) {\r\ncase 8000:\r\nvalue |= APCH_CFG_OVPSET_8V;\r\nbreak;\r\ncase 7500:\r\nvalue |= APCH_CFG_OVPSET_7V5;\r\nbreak;\r\ncase 7000:\r\nvalue |= APCH_CFG_OVPSET_7V;\r\nbreak;\r\ncase 6600:\r\ndefault:\r\nvalue |= APCH_CFG_OVPSET_6V6;\r\nbreak;\r\n}\r\nswitch (pre_time_out) {\r\ncase 60:\r\nvalue |= APCH_CFG_PRETIMO_60_MIN;\r\nbreak;\r\ncase 80:\r\nvalue |= APCH_CFG_PRETIMO_80_MIN;\r\nbreak;\r\ncase 0:\r\nvalue |= APCH_CFG_PRETIMO_DISABLED;\r\nbreak;\r\ncase 40:\r\ndefault:\r\nvalue |= APCH_CFG_PRETIMO_40_MIN;\r\nbreak;\r\n}\r\nswitch (total_time_out) {\r\ncase 4:\r\nvalue |= APCH_CFG_TOTTIMO_4_HOUR;\r\nbreak;\r\ncase 5:\r\nvalue |= APCH_CFG_TOTTIMO_5_HOUR;\r\nbreak;\r\ncase 0:\r\nvalue |= APCH_CFG_TOTTIMO_DISABLED;\r\nbreak;\r\ncase 3:\r\ndefault:\r\nvalue |= APCH_CFG_TOTTIMO_3_HOUR;\r\nbreak;\r\n}\r\nreturn regmap_write(regmap, ACT8945A_APCH_CFG, value);\r\n}\r\nstatic int act8945a_charger_probe(struct platform_device *pdev)\r\n{\r\nstruct act8945a_charger *charger;\r\nstruct power_supply *psy;\r\nstruct power_supply_config psy_cfg = {};\r\nint ret;\r\ncharger = devm_kzalloc(&pdev->dev, sizeof(*charger), GFP_KERNEL);\r\nif (!charger)\r\nreturn -ENOMEM;\r\ncharger->regmap = dev_get_regmap(pdev->dev.parent, NULL);\r\nif (!charger->regmap) {\r\ndev_err(&pdev->dev, "Parent did not provide regmap\n");\r\nreturn -EINVAL;\r\n}\r\nret = act8945a_charger_config(pdev->dev.parent, charger);\r\nif (ret)\r\nreturn ret;\r\npsy_cfg.of_node = pdev->dev.parent->of_node;\r\npsy_cfg.drv_data = charger;\r\npsy = devm_power_supply_register(&pdev->dev,\r\n&act8945a_charger_desc,\r\n&psy_cfg);\r\nif (IS_ERR(psy)) {\r\ndev_err(&pdev->dev, "failed to register power supply\n");\r\nreturn PTR_ERR(psy);\r\n}\r\nreturn 0;\r\n}

static inline u64 Ch(u64 x, u64 y, u64 z)\r\n{\r\nreturn z ^ (x & (y ^ z));\r\n}\r\nstatic inline u64 Maj(u64 x, u64 y, u64 z)\r\n{\r\nreturn (x & y) | (z & (x | y));\r\n}\r\nstatic inline void LOAD_OP(int I, u64 *W, const u8 *input)\r\n{\r\nW[I] = get_unaligned_be64((__u64 *)input + I);\r\n}\r\nstatic inline void BLEND_OP(int I, u64 *W)\r\n{\r\nW[I & 15] += s1(W[(I-2) & 15]) + W[(I-7) & 15] + s0(W[(I-15) & 15]);\r\n}\r\nstatic void\r\nsha512_transform(u64 *state, const u8 *input)\r\n{\r\nu64 a, b, c, d, e, f, g, h, t1, t2;\r\nint i;\r\nu64 W[16];\r\na=state[0]; b=state[1]; c=state[2]; d=state[3];\r\ne=state[4]; f=state[5]; g=state[6]; h=state[7];\r\nfor (i=0; i<80; i+=8) {\r\nif (!(i & 8)) {\r\nint j;\r\nif (i < 16) {\r\nfor (j = 0; j < 16; j++)\r\nLOAD_OP(i + j, W, input);\r\n} else {\r\nfor (j = 0; j < 16; j++) {\r\nBLEND_OP(i + j, W);\r\n}\r\n}\r\n}\r\nt1 = h + e1(e) + Ch(e,f,g) + sha512_K[i ] + W[(i & 15)];\r\nt2 = e0(a) + Maj(a,b,c); d+=t1; h=t1+t2;\r\nt1 = g + e1(d) + Ch(d,e,f) + sha512_K[i+1] + W[(i & 15) + 1];\r\nt2 = e0(h) + Maj(h,a,b); c+=t1; g=t1+t2;\r\nt1 = f + e1(c) + Ch(c,d,e) + sha512_K[i+2] + W[(i & 15) + 2];\r\nt2 = e0(g) + Maj(g,h,a); b+=t1; f=t1+t2;\r\nt1 = e + e1(b) + Ch(b,c,d) + sha512_K[i+3] + W[(i & 15) + 3];\r\nt2 = e0(f) + Maj(f,g,h); a+=t1; e=t1+t2;\r\nt1 = d + e1(a) + Ch(a,b,c) + sha512_K[i+4] + W[(i & 15) + 4];\r\nt2 = e0(e) + Maj(e,f,g); h+=t1; d=t1+t2;\r\nt1 = c + e1(h) + Ch(h,a,b) + sha512_K[i+5] + W[(i & 15) + 5];\r\nt2 = e0(d) + Maj(d,e,f); g+=t1; c=t1+t2;\r\nt1 = b + e1(g) + Ch(g,h,a) + sha512_K[i+6] + W[(i & 15) + 6];\r\nt2 = e0(c) + Maj(c,d,e); f+=t1; b=t1+t2;\r\nt1 = a + e1(f) + Ch(f,g,h) + sha512_K[i+7] + W[(i & 15) + 7];\r\nt2 = e0(b) + Maj(b,c,d); e+=t1; a=t1+t2;\r\n}\r\nstate[0] += a; state[1] += b; state[2] += c; state[3] += d;\r\nstate[4] += e; state[5] += f; state[6] += g; state[7] += h;\r\na = b = c = d = e = f = g = h = t1 = t2 = 0;\r\n}\r\nstatic void sha512_generic_block_fn(struct sha512_state *sst, u8 const *src,\r\nint blocks)\r\n{\r\nwhile (blocks--) {\r\nsha512_transform(sst->state, src);\r\nsrc += SHA512_BLOCK_SIZE;\r\n}\r\n}\r\nint crypto_sha512_update(struct shash_desc *desc, const u8 *data,\r\nunsigned int len)\r\n{\r\nreturn sha512_base_do_update(desc, data, len, sha512_generic_block_fn);\r\n}\r\nstatic int sha512_final(struct shash_desc *desc, u8 *hash)\r\n{\r\nsha512_base_do_finalize(desc, sha512_generic_block_fn);\r\nreturn sha512_base_finish(desc, hash);\r\n}\r\nint crypto_sha512_finup(struct shash_desc *desc, const u8 *data,\r\nunsigned int len, u8 *hash)\r\n{\r\nsha512_base_do_update(desc, data, len, sha512_generic_block_fn);\r\nreturn sha512_final(desc, hash);\r\n}\r\nstatic int __init sha512_generic_mod_init(void)\r\n{\r\nreturn crypto_register_shashes(sha512_algs, ARRAY_SIZE(sha512_algs));\r\n}\r\nstatic void __exit sha512_generic_mod_fini(void)\r\n{\r\ncrypto_unregister_shashes(sha512_algs, ARRAY_SIZE(sha512_algs));\r\n}

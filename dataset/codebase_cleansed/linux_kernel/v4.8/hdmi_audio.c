static const struct hdmi_msm_audio_arcs *get_arcs(unsigned long int pixclock)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(acr_lut); i++) {\r\nconst struct hdmi_msm_audio_arcs *arcs = &acr_lut[i];\r\nif (arcs->pixclock == pixclock)\r\nreturn arcs;\r\n}\r\nreturn NULL;\r\n}\r\nint msm_hdmi_audio_update(struct hdmi *hdmi)\r\n{\r\nstruct hdmi_audio *audio = &hdmi->audio;\r\nstruct hdmi_audio_infoframe *info = &audio->infoframe;\r\nconst struct hdmi_msm_audio_arcs *arcs = NULL;\r\nbool enabled = audio->enabled;\r\nuint32_t acr_pkt_ctrl, vbi_pkt_ctrl, aud_pkt_ctrl;\r\nuint32_t infofrm_ctrl, audio_config;\r\nDBG("audio: enabled=%d, channels=%d, channel_allocation=0x%x, "\r\n"level_shift_value=%d, downmix_inhibit=%d, rate=%d",\r\naudio->enabled, info->channels, info->channel_allocation,\r\ninfo->level_shift_value, info->downmix_inhibit, audio->rate);\r\nDBG("video: power_on=%d, pixclock=%lu", hdmi->power_on, hdmi->pixclock);\r\nif (enabled && !(hdmi->power_on && hdmi->pixclock)) {\r\nDBG("disabling audio: no video");\r\nenabled = false;\r\n}\r\nif (enabled) {\r\narcs = get_arcs(hdmi->pixclock);\r\nif (!arcs) {\r\nDBG("disabling audio: unsupported pixclock: %lu",\r\nhdmi->pixclock);\r\nenabled = false;\r\n}\r\n}\r\nacr_pkt_ctrl = hdmi_read(hdmi, REG_HDMI_ACR_PKT_CTRL);\r\nvbi_pkt_ctrl = hdmi_read(hdmi, REG_HDMI_VBI_PKT_CTRL);\r\naud_pkt_ctrl = hdmi_read(hdmi, REG_HDMI_AUDIO_PKT_CTRL1);\r\ninfofrm_ctrl = hdmi_read(hdmi, REG_HDMI_INFOFRAME_CTRL0);\r\naudio_config = hdmi_read(hdmi, REG_HDMI_AUDIO_CFG);\r\nacr_pkt_ctrl &= ~HDMI_ACR_PKT_CTRL_SELECT__MASK;\r\nif (enabled) {\r\nuint32_t n, cts, multiplier;\r\nenum hdmi_acr_cts select;\r\nuint8_t buf[14];\r\nn = arcs->lut[audio->rate].n;\r\ncts = arcs->lut[audio->rate].cts;\r\nif ((MSM_HDMI_SAMPLE_RATE_192KHZ == audio->rate) ||\r\n(MSM_HDMI_SAMPLE_RATE_176_4KHZ == audio->rate)) {\r\nmultiplier = 4;\r\nn >>= 2;\r\n} else if ((MSM_HDMI_SAMPLE_RATE_96KHZ == audio->rate) ||\r\n(MSM_HDMI_SAMPLE_RATE_88_2KHZ == audio->rate)) {\r\nmultiplier = 2;\r\nn >>= 1;\r\n} else {\r\nmultiplier = 1;\r\n}\r\nDBG("n=%u, cts=%u, multiplier=%u", n, cts, multiplier);\r\nacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_SOURCE;\r\nacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_AUDIO_PRIORITY;\r\nacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_N_MULTIPLIER(multiplier);\r\nif ((MSM_HDMI_SAMPLE_RATE_48KHZ == audio->rate) ||\r\n(MSM_HDMI_SAMPLE_RATE_96KHZ == audio->rate) ||\r\n(MSM_HDMI_SAMPLE_RATE_192KHZ == audio->rate))\r\nselect = ACR_48;\r\nelse if ((MSM_HDMI_SAMPLE_RATE_44_1KHZ == audio->rate) ||\r\n(MSM_HDMI_SAMPLE_RATE_88_2KHZ == audio->rate) ||\r\n(MSM_HDMI_SAMPLE_RATE_176_4KHZ == audio->rate))\r\nselect = ACR_44;\r\nelse\r\nselect = ACR_32;\r\nacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_SELECT(select);\r\nhdmi_write(hdmi, REG_HDMI_ACR_0(select - 1),\r\nHDMI_ACR_0_CTS(cts));\r\nhdmi_write(hdmi, REG_HDMI_ACR_1(select - 1),\r\nHDMI_ACR_1_N(n));\r\nhdmi_write(hdmi, REG_HDMI_AUDIO_PKT_CTRL2,\r\nCOND(info->channels != 2, HDMI_AUDIO_PKT_CTRL2_LAYOUT) |\r\nHDMI_AUDIO_PKT_CTRL2_OVERRIDE);\r\nacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_CONT;\r\nacr_pkt_ctrl |= HDMI_ACR_PKT_CTRL_SEND;\r\nhdmi_audio_infoframe_pack(info, buf, sizeof(buf));\r\nhdmi_write(hdmi, REG_HDMI_AUDIO_INFO0,\r\n(buf[3] << 0) || (buf[4] << 8) ||\r\n(buf[5] << 16) || (buf[6] << 24));\r\nhdmi_write(hdmi, REG_HDMI_AUDIO_INFO1,\r\n(buf[7] << 0) || (buf[8] << 8));\r\nhdmi_write(hdmi, REG_HDMI_GC, 0);\r\nvbi_pkt_ctrl |= HDMI_VBI_PKT_CTRL_GC_ENABLE;\r\nvbi_pkt_ctrl |= HDMI_VBI_PKT_CTRL_GC_EVERY_FRAME;\r\naud_pkt_ctrl |= HDMI_AUDIO_PKT_CTRL1_AUDIO_SAMPLE_SEND;\r\ninfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SEND;\r\ninfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_CONT;\r\ninfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SOURCE;\r\ninfofrm_ctrl |= HDMI_INFOFRAME_CTRL0_AUDIO_INFO_UPDATE;\r\naudio_config &= ~HDMI_AUDIO_CFG_FIFO_WATERMARK__MASK;\r\naudio_config |= HDMI_AUDIO_CFG_FIFO_WATERMARK(4);\r\naudio_config |= HDMI_AUDIO_CFG_ENGINE_ENABLE;\r\n} else {\r\nacr_pkt_ctrl &= ~HDMI_ACR_PKT_CTRL_CONT;\r\nacr_pkt_ctrl &= ~HDMI_ACR_PKT_CTRL_SEND;\r\nvbi_pkt_ctrl &= ~HDMI_VBI_PKT_CTRL_GC_ENABLE;\r\nvbi_pkt_ctrl &= ~HDMI_VBI_PKT_CTRL_GC_EVERY_FRAME;\r\naud_pkt_ctrl &= ~HDMI_AUDIO_PKT_CTRL1_AUDIO_SAMPLE_SEND;\r\ninfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SEND;\r\ninfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_CONT;\r\ninfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_SOURCE;\r\ninfofrm_ctrl &= ~HDMI_INFOFRAME_CTRL0_AUDIO_INFO_UPDATE;\r\naudio_config &= ~HDMI_AUDIO_CFG_ENGINE_ENABLE;\r\n}\r\nhdmi_write(hdmi, REG_HDMI_ACR_PKT_CTRL, acr_pkt_ctrl);\r\nhdmi_write(hdmi, REG_HDMI_VBI_PKT_CTRL, vbi_pkt_ctrl);\r\nhdmi_write(hdmi, REG_HDMI_AUDIO_PKT_CTRL1, aud_pkt_ctrl);\r\nhdmi_write(hdmi, REG_HDMI_INFOFRAME_CTRL0, infofrm_ctrl);\r\nhdmi_write(hdmi, REG_HDMI_AUD_INT,\r\nCOND(enabled, HDMI_AUD_INT_AUD_FIFO_URUN_INT) |\r\nCOND(enabled, HDMI_AUD_INT_AUD_SAM_DROP_INT));\r\nhdmi_write(hdmi, REG_HDMI_AUDIO_CFG, audio_config);\r\nDBG("audio %sabled", enabled ? "en" : "dis");\r\nreturn 0;\r\n}\r\nint msm_hdmi_audio_info_setup(struct hdmi *hdmi, bool enabled,\r\nuint32_t num_of_channels, uint32_t channel_allocation,\r\nuint32_t level_shift, bool down_mix)\r\n{\r\nstruct hdmi_audio *audio;\r\nif (!hdmi)\r\nreturn -ENXIO;\r\naudio = &hdmi->audio;\r\nif (num_of_channels >= ARRAY_SIZE(nchannels))\r\nreturn -EINVAL;\r\naudio->enabled = enabled;\r\naudio->infoframe.channels = nchannels[num_of_channels];\r\naudio->infoframe.channel_allocation = channel_allocation;\r\naudio->infoframe.level_shift_value = level_shift;\r\naudio->infoframe.downmix_inhibit = down_mix;\r\nreturn msm_hdmi_audio_update(hdmi);\r\n}\r\nvoid msm_hdmi_audio_set_sample_rate(struct hdmi *hdmi, int rate)\r\n{\r\nstruct hdmi_audio *audio;\r\nif (!hdmi)\r\nreturn;\r\naudio = &hdmi->audio;\r\nif ((rate < 0) || (rate >= MSM_HDMI_SAMPLE_RATE_MAX))\r\nreturn;\r\naudio->rate = rate;\r\nmsm_hdmi_audio_update(hdmi);\r\n}

int squashfs_max_decompressors(void)\r\n{\r\nreturn MAX_DECOMPRESSOR;\r\n}\r\nstatic void put_decomp_stream(struct decomp_stream *decomp_strm,\r\nstruct squashfs_stream *stream)\r\n{\r\nmutex_lock(&stream->mutex);\r\nlist_add(&decomp_strm->list, &stream->strm_list);\r\nmutex_unlock(&stream->mutex);\r\nwake_up(&stream->wait);\r\n}\r\nvoid *squashfs_decompressor_create(struct squashfs_sb_info *msblk,\r\nvoid *comp_opts)\r\n{\r\nstruct squashfs_stream *stream;\r\nstruct decomp_stream *decomp_strm = NULL;\r\nint err = -ENOMEM;\r\nstream = kzalloc(sizeof(*stream), GFP_KERNEL);\r\nif (!stream)\r\ngoto out;\r\nstream->comp_opts = comp_opts;\r\nmutex_init(&stream->mutex);\r\nINIT_LIST_HEAD(&stream->strm_list);\r\ninit_waitqueue_head(&stream->wait);\r\ndecomp_strm = kmalloc(sizeof(*decomp_strm), GFP_KERNEL);\r\nif (!decomp_strm)\r\ngoto out;\r\ndecomp_strm->stream = msblk->decompressor->init(msblk,\r\nstream->comp_opts);\r\nif (IS_ERR(decomp_strm->stream)) {\r\nerr = PTR_ERR(decomp_strm->stream);\r\ngoto out;\r\n}\r\nlist_add(&decomp_strm->list, &stream->strm_list);\r\nstream->avail_decomp = 1;\r\nreturn stream;\r\nout:\r\nkfree(decomp_strm);\r\nkfree(stream);\r\nreturn ERR_PTR(err);\r\n}\r\nvoid squashfs_decompressor_destroy(struct squashfs_sb_info *msblk)\r\n{\r\nstruct squashfs_stream *stream = msblk->stream;\r\nif (stream) {\r\nstruct decomp_stream *decomp_strm;\r\nwhile (!list_empty(&stream->strm_list)) {\r\ndecomp_strm = list_entry(stream->strm_list.prev,\r\nstruct decomp_stream, list);\r\nlist_del(&decomp_strm->list);\r\nmsblk->decompressor->free(decomp_strm->stream);\r\nkfree(decomp_strm);\r\nstream->avail_decomp--;\r\n}\r\nWARN_ON(stream->avail_decomp);\r\nkfree(stream->comp_opts);\r\nkfree(stream);\r\n}\r\n}\r\nstatic struct decomp_stream *get_decomp_stream(struct squashfs_sb_info *msblk,\r\nstruct squashfs_stream *stream)\r\n{\r\nstruct decomp_stream *decomp_strm;\r\nwhile (1) {\r\nmutex_lock(&stream->mutex);\r\nif (!list_empty(&stream->strm_list)) {\r\ndecomp_strm = list_entry(stream->strm_list.prev,\r\nstruct decomp_stream, list);\r\nlist_del(&decomp_strm->list);\r\nmutex_unlock(&stream->mutex);\r\nbreak;\r\n}\r\nif (stream->avail_decomp >= MAX_DECOMPRESSOR)\r\ngoto wait;\r\ndecomp_strm = kmalloc(sizeof(*decomp_strm), GFP_KERNEL);\r\nif (!decomp_strm)\r\ngoto wait;\r\ndecomp_strm->stream = msblk->decompressor->init(msblk,\r\nstream->comp_opts);\r\nif (IS_ERR(decomp_strm->stream)) {\r\nkfree(decomp_strm);\r\ngoto wait;\r\n}\r\nstream->avail_decomp++;\r\nWARN_ON(stream->avail_decomp > MAX_DECOMPRESSOR);\r\nmutex_unlock(&stream->mutex);\r\nbreak;\r\nwait:\r\nmutex_unlock(&stream->mutex);\r\nwait_event(stream->wait,\r\n!list_empty(&stream->strm_list));\r\n}\r\nreturn decomp_strm;\r\n}\r\nint squashfs_decompress(struct squashfs_sb_info *msblk, struct buffer_head **bh,\r\nint b, int offset, int length, struct squashfs_page_actor *output)\r\n{\r\nint res;\r\nstruct squashfs_stream *stream = msblk->stream;\r\nstruct decomp_stream *decomp_stream = get_decomp_stream(msblk, stream);\r\nres = msblk->decompressor->decompress(msblk, decomp_stream->stream,\r\nbh, b, offset, length, output);\r\nput_decomp_stream(decomp_stream, stream);\r\nif (res < 0)\r\nERROR("%s decompression failed, data probably corrupt\n",\r\nmsblk->decompressor->name);\r\nreturn res;\r\n}

unsigned int omap_rev(void)\r\n{\r\nreturn omap_revision;\r\n}\r\nstatic u16 __init omap_get_jtag_id(void)\r\n{\r\nu32 prod_id, omap_id;\r\nprod_id = omap_readl(OMAP_PRODUCTION_ID_1);\r\nomap_id = omap_readl(OMAP32_ID_1);\r\nif (((prod_id >> 20) == 0) || (prod_id == omap_id))\r\nprod_id = 0;\r\nelse\r\nprod_id &= 0xffff;\r\nif (prod_id)\r\nreturn prod_id;\r\nprod_id = ((omap_id >> 12) & 0xffff);\r\nreturn prod_id;\r\n}\r\nstatic u8 __init omap_get_die_rev(void)\r\n{\r\nu32 die_rev;\r\ndie_rev = omap_readl(OMAP_DIE_ID_1);\r\nif (((die_rev >> 12) & 0xffff) == omap_get_jtag_id())\r\ndie_rev = 0;\r\ndie_rev = (die_rev >> 17) & 0xf;\r\nif (die_rev)\r\nreturn die_rev;\r\ndie_rev = (omap_readl(OMAP32_ID_1) >> 28) & 0xf;\r\nreturn die_rev;\r\n}\r\nvoid __init omap_check_revision(void)\r\n{\r\nint i;\r\nu16 jtag_id;\r\nu8 die_rev;\r\nu32 omap_id;\r\nu8 cpu_type;\r\njtag_id = omap_get_jtag_id();\r\ndie_rev = omap_get_die_rev();\r\nomap_id = omap_readl(OMAP32_ID_0);\r\n#ifdef DEBUG\r\nprintk(KERN_DEBUG "OMAP_DIE_ID_0: 0x%08x\n", omap_readl(OMAP_DIE_ID_0));\r\nprintk(KERN_DEBUG "OMAP_DIE_ID_1: 0x%08x DIE_REV: %i\n",\r\nomap_readl(OMAP_DIE_ID_1),\r\n(omap_readl(OMAP_DIE_ID_1) >> 17) & 0xf);\r\nprintk(KERN_DEBUG "OMAP_PRODUCTION_ID_0: 0x%08x\n",\r\nomap_readl(OMAP_PRODUCTION_ID_0));\r\nprintk(KERN_DEBUG "OMAP_PRODUCTION_ID_1: 0x%08x JTAG_ID: 0x%04x\n",\r\nomap_readl(OMAP_PRODUCTION_ID_1),\r\nomap_readl(OMAP_PRODUCTION_ID_1) & 0xffff);\r\nprintk(KERN_DEBUG "OMAP32_ID_0: 0x%08x\n", omap_readl(OMAP32_ID_0));\r\nprintk(KERN_DEBUG "OMAP32_ID_1: 0x%08x\n", omap_readl(OMAP32_ID_1));\r\nprintk(KERN_DEBUG "JTAG_ID: 0x%04x DIE_REV: %i\n", jtag_id, die_rev);\r\n#endif\r\nsystem_serial_high = omap_readl(OMAP_DIE_ID_0);\r\nsystem_serial_low = omap_readl(OMAP_DIE_ID_1);\r\nfor (i = 0; i < ARRAY_SIZE(omap_ids); i++) {\r\nif (jtag_id == (omap_ids[i].jtag_id)) {\r\nomap_revision = omap_ids[i].type;\r\nbreak;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(omap_ids); i++) {\r\nif (jtag_id == omap_ids[i].jtag_id && die_rev == omap_ids[i].die_rev) {\r\nomap_revision = omap_ids[i].type;\r\nbreak;\r\n}\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(omap_ids); i++) {\r\nif (jtag_id == omap_ids[i].jtag_id\r\n&& die_rev == omap_ids[i].die_rev\r\n&& omap_id == omap_ids[i].omap_id) {\r\nomap_revision = omap_ids[i].type;\r\nbreak;\r\n}\r\n}\r\ncpu_type = omap_revision >> 24;\r\nswitch (cpu_type) {\r\ncase 0x07:\r\ncase 0x08:\r\nomap_revision |= 0x07;\r\nbreak;\r\ncase 0x03:\r\ncase 0x15:\r\nomap_revision |= 0x15;\r\nbreak;\r\ncase 0x16:\r\ncase 0x17:\r\nomap_revision |= 0x16;\r\nbreak;\r\ndefault:\r\nprintk(KERN_INFO "Unknown OMAP cpu type: 0x%02x\n", cpu_type);\r\n}\r\nprintk(KERN_INFO "OMAP%04x", omap_revision >> 16);\r\nif ((omap_revision >> 8) & 0xff)\r\nprintk(KERN_INFO "%x", (omap_revision >> 8) & 0xff);\r\nprintk(KERN_INFO " revision %i handled as %02xxx id: %08x%08x\n",\r\ndie_rev, omap_revision & 0xff, system_serial_low,\r\nsystem_serial_high);\r\n}

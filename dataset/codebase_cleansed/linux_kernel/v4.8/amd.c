static void\r\namd_get_mtrr(unsigned int reg, unsigned long *base,\r\nunsigned long *size, mtrr_type *type)\r\n{\r\nunsigned long low, high;\r\nrdmsr(MSR_K6_UWCCR, low, high);\r\nif (reg == 1)\r\nlow = high;\r\n*base = (low & 0xFFFE0000) >> PAGE_SHIFT;\r\n*type = 0;\r\nif (low & 1)\r\n*type = MTRR_TYPE_UNCACHABLE;\r\nif (low & 2)\r\n*type = MTRR_TYPE_WRCOMB;\r\nif (!(low & 3)) {\r\n*size = 0;\r\nreturn;\r\n}\r\nlow = (~low) & 0x1FFFC;\r\n*size = (low + 4) << (15 - PAGE_SHIFT);\r\n}\r\nstatic void\r\namd_set_mtrr(unsigned int reg, unsigned long base, unsigned long size, mtrr_type type)\r\n{\r\nu32 regs[2];\r\nrdmsr(MSR_K6_UWCCR, regs[0], regs[1]);\r\nif (size == 0) {\r\nregs[reg] = 0;\r\n} else {\r\nregs[reg] = (-size >> (15 - PAGE_SHIFT) & 0x0001FFFC)\r\n| (base << PAGE_SHIFT) | (type + 1);\r\n}\r\nwbinvd();\r\nwrmsr(MSR_K6_UWCCR, regs[0], regs[1]);\r\n}\r\nstatic int\r\namd_validate_add_page(unsigned long base, unsigned long size, unsigned int type)\r\n{\r\nif (type > MTRR_TYPE_WRCOMB || size < (1 << (17 - PAGE_SHIFT))\r\n|| (size & ~(size - 1)) - size || (base & (size - 1)))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nint __init amd_init_mtrr(void)\r\n{\r\nset_mtrr_ops(&amd_mtrr_ops);\r\nreturn 0;\r\n}

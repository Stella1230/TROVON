static int dac124s085_set_brightness(struct led_classdev *ldev,\r\nenum led_brightness brightness)\r\n{\r\nstruct dac124s085_led *led = container_of(ldev, struct dac124s085_led,\r\nldev);\r\nu16 word;\r\nint ret;\r\nmutex_lock(&led->mutex);\r\nword = cpu_to_le16(((led->id) << 14) | REG_WRITE_UPDATE |\r\n(brightness & 0xfff));\r\nret = spi_write(led->spi, (const u8 *)&word, sizeof(word));\r\nmutex_unlock(&led->mutex);\r\nreturn ret;\r\n}\r\nstatic int dac124s085_probe(struct spi_device *spi)\r\n{\r\nstruct dac124s085 *dac;\r\nstruct dac124s085_led *led;\r\nint i, ret;\r\ndac = devm_kzalloc(&spi->dev, sizeof(*dac), GFP_KERNEL);\r\nif (!dac)\r\nreturn -ENOMEM;\r\nspi->bits_per_word = 16;\r\nfor (i = 0; i < ARRAY_SIZE(dac->leds); i++) {\r\nled = dac->leds + i;\r\nled->id = i;\r\nled->spi = spi;\r\nsnprintf(led->name, sizeof(led->name), "dac124s085-%d", i);\r\nmutex_init(&led->mutex);\r\nled->ldev.name = led->name;\r\nled->ldev.brightness = LED_OFF;\r\nled->ldev.max_brightness = 0xfff;\r\nled->ldev.brightness_set_blocking = dac124s085_set_brightness;\r\nret = led_classdev_register(&spi->dev, &led->ldev);\r\nif (ret < 0)\r\ngoto eledcr;\r\n}\r\nspi_set_drvdata(spi, dac);\r\nreturn 0;\r\neledcr:\r\nwhile (i--)\r\nled_classdev_unregister(&dac->leds[i].ldev);\r\nreturn ret;\r\n}\r\nstatic int dac124s085_remove(struct spi_device *spi)\r\n{\r\nstruct dac124s085 *dac = spi_get_drvdata(spi);\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(dac->leds); i++)\r\nled_classdev_unregister(&dac->leds[i].ldev);\r\nreturn 0;\r\n}

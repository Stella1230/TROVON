phys_addr_t mips_cpc_default_phys_base(void)\r\n{\r\npanic("Cannot detect cpc address");\r\n}\r\nvoid __init ralink_clk_init(void)\r\n{\r\nint cpu_fdiv = 0;\r\nint cpu_ffrac = 0;\r\nint fbdiv = 0;\r\nu32 clk_sts, syscfg;\r\nu8 clk_sel = 0, xtal_mode;\r\nu32 cpu_clk;\r\nif ((rt_sysc_r32(SYSC_REG_CPLL_CLKCFG0) & CPU_CLK_SEL) != 0)\r\nclk_sel = 1;\r\nswitch (clk_sel) {\r\ncase 0:\r\nclk_sts = rt_sysc_r32(SYSC_REG_CUR_CLK_STS);\r\ncpu_fdiv = ((clk_sts >> 8) & 0x1F);\r\ncpu_ffrac = (clk_sts & 0x1F);\r\ncpu_clk = (500 * cpu_ffrac / cpu_fdiv) * 1000 * 1000;\r\nbreak;\r\ncase 1:\r\nfbdiv = ((rt_sysc_r32(0x648) >> 4) & 0x7F) + 1;\r\nsyscfg = rt_sysc_r32(SYSC_REG_SYSCFG);\r\nxtal_mode = (syscfg >> 6) & 0x7;\r\nif (xtal_mode >= 6) {\r\ncpu_clk = 25 * fbdiv * 1000 * 1000;\r\n} else if (xtal_mode >= 3) {\r\ncpu_clk = 40 * fbdiv * 1000 * 1000;\r\n} else {\r\ncpu_clk = 20 * fbdiv * 1000 * 1000;\r\n}\r\nbreak;\r\n}\r\n}\r\nvoid __init ralink_of_remap(void)\r\n{\r\nrt_sysc_membase = plat_of_remap_node("mtk,mt7621-sysc");\r\nrt_memc_membase = plat_of_remap_node("mtk,mt7621-memc");\r\nif (!rt_sysc_membase || !rt_memc_membase)\r\npanic("Failed to remap core resources");\r\n}\r\nvoid prom_soc_init(struct ralink_soc_info *soc_info)\r\n{\r\nvoid __iomem *sysc = (void __iomem *) KSEG1ADDR(MT7621_SYSC_BASE);\r\nunsigned char *name = NULL;\r\nu32 n0;\r\nu32 n1;\r\nu32 rev;\r\nn0 = __raw_readl(sysc + SYSC_REG_CHIP_NAME0);\r\nn1 = __raw_readl(sysc + SYSC_REG_CHIP_NAME1);\r\nif (n0 == MT7621_CHIP_NAME0 && n1 == MT7621_CHIP_NAME1) {\r\nname = "MT7621";\r\nsoc_info->compatible = "mtk,mt7621-soc";\r\n} else {\r\npanic("mt7621: unknown SoC, n0:%08x n1:%08x\n", n0, n1);\r\n}\r\nrev = __raw_readl(sysc + SYSC_REG_CHIP_REV);\r\nsnprintf(soc_info->sys_type, RAMIPS_SYS_TYPE_LEN,\r\n"MediaTek %s ver:%u eco:%u",\r\nname,\r\n(rev >> CHIP_REV_VER_SHIFT) & CHIP_REV_VER_MASK,\r\n(rev & CHIP_REV_ECO_MASK));\r\nsoc_info->mem_size_min = MT7621_DDR2_SIZE_MIN;\r\nsoc_info->mem_size_max = MT7621_DDR2_SIZE_MAX;\r\nsoc_info->mem_base = MT7621_DRAM_BASE;\r\nrt2880_pinmux_data = mt7621_pinmux_data;\r\nmips_cm_probe();\r\nmips_cpc_probe();\r\nif (mips_cm_numiocu()) {\r\nwrite_gcr_reg0_base(MT7621_PALMBUS_BASE);\r\nwrite_gcr_reg0_mask(~MT7621_PALMBUS_SIZE |\r\nCM_GCR_REGn_MASK_CMTGT_IOCU0);\r\n}\r\nif (!register_cps_smp_ops())\r\nreturn;\r\nif (!register_cmp_smp_ops())\r\nreturn;\r\nif (!register_vsmp_smp_ops())\r\nreturn;\r\n}

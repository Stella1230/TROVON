static void xilly_dma_sync_single_for_cpu_of(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\ndma_sync_single_for_cpu(ep->dev, dma_handle, size, direction);\r\n}\r\nstatic void xilly_dma_sync_single_for_device_of(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\ndma_sync_single_for_device(ep->dev, dma_handle, size, direction);\r\n}\r\nstatic void xilly_dma_sync_single_nop(struct xilly_endpoint *ep,\r\ndma_addr_t dma_handle,\r\nsize_t size,\r\nint direction)\r\n{\r\n}\r\nstatic void xilly_of_unmap(void *ptr)\r\n{\r\nstruct xilly_mapping *data = ptr;\r\ndma_unmap_single(data->device, data->dma_addr,\r\ndata->size, data->direction);\r\nkfree(ptr);\r\n}\r\nstatic int xilly_map_single_of(struct xilly_endpoint *ep,\r\nvoid *ptr,\r\nsize_t size,\r\nint direction,\r\ndma_addr_t *ret_dma_handle\r\n)\r\n{\r\ndma_addr_t addr;\r\nstruct xilly_mapping *this;\r\nthis = kzalloc(sizeof(*this), GFP_KERNEL);\r\nif (!this)\r\nreturn -ENOMEM;\r\naddr = dma_map_single(ep->dev, ptr, size, direction);\r\nif (dma_mapping_error(ep->dev, addr)) {\r\nkfree(this);\r\nreturn -ENODEV;\r\n}\r\nthis->device = ep->dev;\r\nthis->dma_addr = addr;\r\nthis->size = size;\r\nthis->direction = direction;\r\n*ret_dma_handle = addr;\r\nreturn devm_add_action_or_reset(ep->dev, xilly_of_unmap, this);\r\n}\r\nstatic int xilly_drv_probe(struct platform_device *op)\r\n{\r\nstruct device *dev = &op->dev;\r\nstruct xilly_endpoint *endpoint;\r\nint rc;\r\nint irq;\r\nstruct resource res;\r\nstruct xilly_endpoint_hardware *ephw = &of_hw;\r\nif (of_property_read_bool(dev->of_node, "dma-coherent"))\r\nephw = &of_hw_coherent;\r\nendpoint = xillybus_init_endpoint(NULL, dev, ephw);\r\nif (!endpoint)\r\nreturn -ENOMEM;\r\ndev_set_drvdata(dev, endpoint);\r\nrc = of_address_to_resource(dev->of_node, 0, &res);\r\nendpoint->registers = devm_ioremap_resource(dev, &res);\r\nif (IS_ERR(endpoint->registers))\r\nreturn PTR_ERR(endpoint->registers);\r\nirq = irq_of_parse_and_map(dev->of_node, 0);\r\nrc = devm_request_irq(dev, irq, xillybus_isr, 0, xillyname, endpoint);\r\nif (rc) {\r\ndev_err(endpoint->dev,\r\n"Failed to register IRQ handler. Aborting.\n");\r\nreturn -ENODEV;\r\n}\r\nreturn xillybus_endpoint_discovery(endpoint);\r\n}\r\nstatic int xilly_drv_remove(struct platform_device *op)\r\n{\r\nstruct device *dev = &op->dev;\r\nstruct xilly_endpoint *endpoint = dev_get_drvdata(dev);\r\nxillybus_endpoint_remove(endpoint);\r\nreturn 0;\r\n}

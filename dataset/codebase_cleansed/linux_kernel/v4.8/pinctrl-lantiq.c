static int ltq_get_group_count(struct pinctrl_dev *pctrldev)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nreturn info->num_grps;\r\n}\r\nstatic const char *ltq_get_group_name(struct pinctrl_dev *pctrldev,\r\nunsigned selector)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nif (selector >= info->num_grps)\r\nreturn NULL;\r\nreturn info->grps[selector].name;\r\n}\r\nstatic int ltq_get_group_pins(struct pinctrl_dev *pctrldev,\r\nunsigned selector,\r\nconst unsigned **pins,\r\nunsigned *num_pins)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nif (selector >= info->num_grps)\r\nreturn -EINVAL;\r\n*pins = info->grps[selector].pins;\r\n*num_pins = info->grps[selector].npins;\r\nreturn 0;\r\n}\r\nstatic void ltq_pinctrl_dt_free_map(struct pinctrl_dev *pctldev,\r\nstruct pinctrl_map *map, unsigned num_maps)\r\n{\r\nint i;\r\nfor (i = 0; i < num_maps; i++)\r\nif (map[i].type == PIN_MAP_TYPE_CONFIGS_PIN ||\r\nmap[i].type == PIN_MAP_TYPE_CONFIGS_GROUP)\r\nkfree(map[i].data.configs.configs);\r\nkfree(map);\r\n}\r\nstatic void ltq_pinctrl_pin_dbg_show(struct pinctrl_dev *pctldev,\r\nstruct seq_file *s,\r\nunsigned offset)\r\n{\r\nseq_printf(s, " %s", dev_name(pctldev->dev));\r\n}\r\nstatic void ltq_pinctrl_dt_subnode_to_map(struct pinctrl_dev *pctldev,\r\nstruct device_node *np,\r\nstruct pinctrl_map **map)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctldev);\r\nstruct property *pins = of_find_property(np, "lantiq,pins", NULL);\r\nstruct property *groups = of_find_property(np, "lantiq,groups", NULL);\r\nunsigned long configs[3];\r\nunsigned num_configs = 0;\r\nstruct property *prop;\r\nconst char *group, *pin;\r\nconst char *function;\r\nint ret, i;\r\nif (!pins && !groups) {\r\ndev_err(pctldev->dev, "%s defines neither pins nor groups\n",\r\nnp->name);\r\nreturn;\r\n}\r\nif (pins && groups) {\r\ndev_err(pctldev->dev, "%s defines both pins and groups\n",\r\nnp->name);\r\nreturn;\r\n}\r\nret = of_property_read_string(np, "lantiq,function", &function);\r\nif (groups && !ret) {\r\nof_property_for_each_string(np, "lantiq,groups", prop, group) {\r\n(*map)->type = PIN_MAP_TYPE_MUX_GROUP;\r\n(*map)->name = function;\r\n(*map)->data.mux.group = group;\r\n(*map)->data.mux.function = function;\r\n(*map)++;\r\n}\r\n}\r\nfor (i = 0; i < info->num_params; i++) {\r\nu32 val;\r\nint ret = of_property_read_u32(np,\r\ninfo->params[i].property, &val);\r\nif (!ret)\r\nconfigs[num_configs++] =\r\nLTQ_PINCONF_PACK(info->params[i].param,\r\nval);\r\n}\r\nif (!num_configs)\r\nreturn;\r\nof_property_for_each_string(np, "lantiq,pins", prop, pin) {\r\n(*map)->data.configs.configs = kmemdup(configs,\r\nnum_configs * sizeof(unsigned long),\r\nGFP_KERNEL);\r\n(*map)->type = PIN_MAP_TYPE_CONFIGS_PIN;\r\n(*map)->name = pin;\r\n(*map)->data.configs.group_or_pin = pin;\r\n(*map)->data.configs.num_configs = num_configs;\r\n(*map)++;\r\n}\r\nof_property_for_each_string(np, "lantiq,groups", prop, group) {\r\n(*map)->data.configs.configs = kmemdup(configs,\r\nnum_configs * sizeof(unsigned long),\r\nGFP_KERNEL);\r\n(*map)->type = PIN_MAP_TYPE_CONFIGS_GROUP;\r\n(*map)->name = group;\r\n(*map)->data.configs.group_or_pin = group;\r\n(*map)->data.configs.num_configs = num_configs;\r\n(*map)++;\r\n}\r\n}\r\nstatic int ltq_pinctrl_dt_subnode_size(struct device_node *np)\r\n{\r\nint ret;\r\nret = of_property_count_strings(np, "lantiq,groups");\r\nif (ret < 0)\r\nret = of_property_count_strings(np, "lantiq,pins");\r\nreturn ret;\r\n}\r\nstatic int ltq_pinctrl_dt_node_to_map(struct pinctrl_dev *pctldev,\r\nstruct device_node *np_config,\r\nstruct pinctrl_map **map,\r\nunsigned *num_maps)\r\n{\r\nstruct pinctrl_map *tmp;\r\nstruct device_node *np;\r\nint max_maps = 0;\r\nfor_each_child_of_node(np_config, np)\r\nmax_maps += ltq_pinctrl_dt_subnode_size(np);\r\n*map = kzalloc(max_maps * sizeof(struct pinctrl_map) * 2, GFP_KERNEL);\r\nif (!*map)\r\nreturn -ENOMEM;\r\ntmp = *map;\r\nfor_each_child_of_node(np_config, np)\r\nltq_pinctrl_dt_subnode_to_map(pctldev, np, &tmp);\r\n*num_maps = ((int)(tmp - *map));\r\nreturn 0;\r\n}\r\nstatic int ltq_pmx_func_count(struct pinctrl_dev *pctrldev)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nreturn info->num_funcs;\r\n}\r\nstatic const char *ltq_pmx_func_name(struct pinctrl_dev *pctrldev,\r\nunsigned selector)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nif (selector >= info->num_funcs)\r\nreturn NULL;\r\nreturn info->funcs[selector].name;\r\n}\r\nstatic int ltq_pmx_get_groups(struct pinctrl_dev *pctrldev,\r\nunsigned func,\r\nconst char * const **groups,\r\nunsigned * const num_groups)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\n*groups = info->funcs[func].groups;\r\n*num_groups = info->funcs[func].num_groups;\r\nreturn 0;\r\n}\r\nstatic int match_mux(const struct ltq_mfp_pin *mfp, unsigned mux)\r\n{\r\nint i;\r\nfor (i = 0; i < LTQ_MAX_MUX; i++) {\r\nif (mfp->func[i] == mux)\r\nbreak;\r\n}\r\nif (i >= LTQ_MAX_MUX)\r\nreturn -EINVAL;\r\nreturn i;\r\n}\r\nstatic int match_mfp(const struct ltq_pinmux_info *info, int pin)\r\n{\r\nint i;\r\nfor (i = 0; i < info->num_mfp; i++) {\r\nif (info->mfp[i].pin == pin)\r\nreturn i;\r\n}\r\nreturn -1;\r\n}\r\nstatic int match_group_mux(const struct ltq_pin_group *grp,\r\nconst struct ltq_pinmux_info *info,\r\nunsigned mux)\r\n{\r\nint i, pin, ret = 0;\r\nfor (i = 0; i < grp->npins; i++) {\r\npin = match_mfp(info, grp->pins[i]);\r\nif (pin < 0) {\r\ndev_err(info->dev, "could not find mfp for pin %d\n",\r\ngrp->pins[i]);\r\nreturn -EINVAL;\r\n}\r\nret = match_mux(&info->mfp[pin], mux);\r\nif (ret < 0) {\r\ndev_err(info->dev, "Can't find mux %d on pin%d\n",\r\nmux, pin);\r\nbreak;\r\n}\r\n}\r\nreturn ret;\r\n}\r\nstatic int ltq_pmx_set(struct pinctrl_dev *pctrldev,\r\nunsigned func,\r\nunsigned group)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nconst struct ltq_pin_group *pin_grp = &info->grps[group];\r\nint i, pin, pin_func, ret;\r\nif (!pin_grp->npins ||\r\n(match_group_mux(pin_grp, info, pin_grp->mux) < 0)) {\r\ndev_err(info->dev, "Failed to set the pin group: %s\n",\r\ninfo->grps[group].name);\r\nreturn -EINVAL;\r\n}\r\nfor (i = 0; i < pin_grp->npins; i++) {\r\npin = match_mfp(info, pin_grp->pins[i]);\r\nif (pin < 0) {\r\ndev_err(info->dev, "could not find mfp for pin %d\n",\r\npin_grp->pins[i]);\r\nreturn -EINVAL;\r\n}\r\npin_func = match_mux(&info->mfp[pin], pin_grp->mux);\r\nret = info->apply_mux(pctrldev, pin, pin_func);\r\nif (ret) {\r\ndev_err(info->dev,\r\n"failed to apply mux %d for pin %d\n",\r\npin_func, pin);\r\nreturn ret;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int ltq_pmx_gpio_request_enable(struct pinctrl_dev *pctrldev,\r\nstruct pinctrl_gpio_range *range,\r\nunsigned pin)\r\n{\r\nstruct ltq_pinmux_info *info = pinctrl_dev_get_drvdata(pctrldev);\r\nint mfp = match_mfp(info, pin);\r\nint pin_func;\r\nif (mfp < 0) {\r\ndev_err(info->dev, "could not find mfp for pin %d\n", pin);\r\nreturn -EINVAL;\r\n}\r\npin_func = match_mux(&info->mfp[mfp], 0);\r\nif (pin_func < 0) {\r\ndev_err(info->dev, "No GPIO function on pin%d\n", mfp);\r\nreturn -EINVAL;\r\n}\r\nreturn info->apply_mux(pctrldev, mfp, pin_func);\r\n}\r\nint ltq_pinctrl_register(struct platform_device *pdev,\r\nstruct ltq_pinmux_info *info)\r\n{\r\nstruct pinctrl_desc *desc;\r\nif (!info)\r\nreturn -EINVAL;\r\ndesc = info->desc;\r\ndesc->pctlops = &ltq_pctrl_ops;\r\ndesc->pmxops = &ltq_pmx_ops;\r\ninfo->dev = &pdev->dev;\r\ninfo->pctrl = devm_pinctrl_register(&pdev->dev, desc, info);\r\nif (IS_ERR(info->pctrl)) {\r\ndev_err(&pdev->dev, "failed to register LTQ pinmux driver\n");\r\nreturn PTR_ERR(info->pctrl);\r\n}\r\nplatform_set_drvdata(pdev, info);\r\nreturn 0;\r\n}

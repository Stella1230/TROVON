static int powernow_k6_get_cpu_multiplier(void)\r\n{\r\nunsigned long invalue = 0;\r\nu32 msrval;\r\nlocal_irq_disable();\r\nmsrval = POWERNOW_IOPORT + 0x1;\r\nwrmsr(MSR_K6_EPMR, msrval, 0);\r\ninvalue = inl(POWERNOW_IOPORT + 0x8);\r\nmsrval = POWERNOW_IOPORT + 0x0;\r\nwrmsr(MSR_K6_EPMR, msrval, 0);\r\nlocal_irq_enable();\r\nreturn clock_ratio[register_to_index[(invalue >> 5)&7]].driver_data;\r\n}\r\nstatic void powernow_k6_set_cpu_multiplier(unsigned int best_i)\r\n{\r\nunsigned long outvalue, invalue;\r\nunsigned long msrval;\r\nunsigned long cr0;\r\nlocal_irq_disable();\r\ncr0 = read_cr0();\r\nwrite_cr0(cr0 | X86_CR0_CD);\r\nwbinvd();\r\noutvalue = (1<<12) | (1<<10) | (1<<9) | (index_to_register[best_i]<<5);\r\nmsrval = POWERNOW_IOPORT + 0x1;\r\nwrmsr(MSR_K6_EPMR, msrval, 0);\r\ninvalue = inl(POWERNOW_IOPORT + 0x8);\r\ninvalue = invalue & 0x1f;\r\noutvalue = outvalue | invalue;\r\noutl(outvalue, (POWERNOW_IOPORT + 0x8));\r\nmsrval = POWERNOW_IOPORT + 0x0;\r\nwrmsr(MSR_K6_EPMR, msrval, 0);\r\nwrite_cr0(cr0);\r\nlocal_irq_enable();\r\n}\r\nstatic int powernow_k6_target(struct cpufreq_policy *policy,\r\nunsigned int best_i)\r\n{\r\nif (clock_ratio[best_i].driver_data > max_multiplier) {\r\npr_err("invalid target frequency\n");\r\nreturn -EINVAL;\r\n}\r\npowernow_k6_set_cpu_multiplier(best_i);\r\nreturn 0;\r\n}\r\nstatic int powernow_k6_cpu_init(struct cpufreq_policy *policy)\r\n{\r\nstruct cpufreq_frequency_table *pos;\r\nunsigned int i, f;\r\nunsigned khz;\r\nif (policy->cpu != 0)\r\nreturn -ENODEV;\r\nmax_multiplier = 0;\r\nkhz = cpu_khz;\r\nfor (i = 0; i < ARRAY_SIZE(usual_frequency_table); i++) {\r\nif (khz >= usual_frequency_table[i].freq - FREQ_RANGE &&\r\nkhz <= usual_frequency_table[i].freq + FREQ_RANGE) {\r\nkhz = usual_frequency_table[i].freq;\r\nmax_multiplier = usual_frequency_table[i].mult;\r\nbreak;\r\n}\r\n}\r\nif (param_max_multiplier) {\r\ncpufreq_for_each_entry(pos, clock_ratio)\r\nif (pos->driver_data == param_max_multiplier) {\r\nmax_multiplier = param_max_multiplier;\r\ngoto have_max_multiplier;\r\n}\r\npr_err("invalid max_multiplier parameter, valid parameters 20, 30, 35, 40, 45, 50, 55, 60\n");\r\nreturn -EINVAL;\r\n}\r\nif (!max_multiplier) {\r\npr_warn("unknown frequency %u, cannot determine current multiplier\n",\r\nkhz);\r\npr_warn("use module parameters max_multiplier and bus_frequency\n");\r\nreturn -EOPNOTSUPP;\r\n}\r\nhave_max_multiplier:\r\nparam_max_multiplier = max_multiplier;\r\nif (param_busfreq) {\r\nif (param_busfreq >= 50000 && param_busfreq <= 150000) {\r\nbusfreq = param_busfreq / 10;\r\ngoto have_busfreq;\r\n}\r\npr_err("invalid bus_frequency parameter, allowed range 50000 - 150000 kHz\n");\r\nreturn -EINVAL;\r\n}\r\nbusfreq = khz / max_multiplier;\r\nhave_busfreq:\r\nparam_busfreq = busfreq * 10;\r\ncpufreq_for_each_entry(pos, clock_ratio) {\r\nf = pos->driver_data;\r\nif (f > max_multiplier)\r\npos->frequency = CPUFREQ_ENTRY_INVALID;\r\nelse\r\npos->frequency = busfreq * f;\r\n}\r\npolicy->cpuinfo.transition_latency = 500000;\r\nreturn cpufreq_table_validate_and_show(policy, clock_ratio);\r\n}\r\nstatic int powernow_k6_cpu_exit(struct cpufreq_policy *policy)\r\n{\r\nunsigned int i;\r\nfor (i = 0; (clock_ratio[i].frequency != CPUFREQ_TABLE_END); i++) {\r\nif (clock_ratio[i].driver_data == max_multiplier) {\r\nstruct cpufreq_freqs freqs;\r\nfreqs.old = policy->cur;\r\nfreqs.new = clock_ratio[i].frequency;\r\nfreqs.flags = 0;\r\ncpufreq_freq_transition_begin(policy, &freqs);\r\npowernow_k6_target(policy, i);\r\ncpufreq_freq_transition_end(policy, &freqs, 0);\r\nbreak;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic unsigned int powernow_k6_get(unsigned int cpu)\r\n{\r\nunsigned int ret;\r\nret = (busfreq * powernow_k6_get_cpu_multiplier());\r\nreturn ret;\r\n}\r\nstatic int __init powernow_k6_init(void)\r\n{\r\nif (!x86_match_cpu(powernow_k6_ids))\r\nreturn -ENODEV;\r\nif (!request_region(POWERNOW_IOPORT, 16, "PowerNow!")) {\r\npr_info("PowerNow IOPORT region already used\n");\r\nreturn -EIO;\r\n}\r\nif (cpufreq_register_driver(&powernow_k6_driver)) {\r\nrelease_region(POWERNOW_IOPORT, 16);\r\nreturn -EINVAL;\r\n}\r\nreturn 0;\r\n}\r\nstatic void __exit powernow_k6_exit(void)\r\n{\r\ncpufreq_unregister_driver(&powernow_k6_driver);\r\nrelease_region(POWERNOW_IOPORT, 16);\r\n}

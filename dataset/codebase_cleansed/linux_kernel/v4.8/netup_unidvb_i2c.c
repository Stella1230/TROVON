irqreturn_t netup_i2c_interrupt(struct netup_i2c *i2c)\r\n{\r\nu16 reg, tmp;\r\nunsigned long flags;\r\nirqreturn_t iret = IRQ_HANDLED;\r\nspin_lock_irqsave(&i2c->lock, flags);\r\nreg = readw(&i2c->regs->twi_ctrl0_stat);\r\nwritew(reg & ~TWI_IRQEN, &i2c->regs->twi_ctrl0_stat);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): twi_ctrl0_state 0x%x\n", __func__, reg);\r\nif ((reg & TWI_IRQEN_COMPL) != 0 && (reg & TWI_IRQ_COMPL)) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): TWI_IRQEN_COMPL\n", __func__);\r\ni2c->state = STATE_DONE;\r\ngoto irq_ok;\r\n}\r\nif ((reg & TWI_IRQEN_ANACK) != 0 && (reg & TWI_IRQ_ANACK)) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): TWI_IRQEN_ANACK\n", __func__);\r\ni2c->state = STATE_ERROR;\r\ngoto irq_ok;\r\n}\r\nif ((reg & TWI_IRQEN_DNACK) != 0 && (reg & TWI_IRQ_DNACK)) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): TWI_IRQEN_DNACK\n", __func__);\r\ni2c->state = STATE_ERROR;\r\ngoto irq_ok;\r\n}\r\nif ((reg & TWI_IRQ_RX) != 0) {\r\ntmp = readw(&i2c->regs->rx_fifo.stat_ctrl);\r\nwritew(tmp & ~FIFO_IRQEN, &i2c->regs->rx_fifo.stat_ctrl);\r\ni2c->state = STATE_WANT_READ;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): want read\n", __func__);\r\ngoto irq_ok;\r\n}\r\nif ((reg & TWI_IRQ_TX) != 0) {\r\ntmp = readw(&i2c->regs->tx_fifo.stat_ctrl);\r\nwritew(tmp & ~FIFO_IRQEN, &i2c->regs->tx_fifo.stat_ctrl);\r\ni2c->state = STATE_WANT_WRITE;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): want write\n", __func__);\r\ngoto irq_ok;\r\n}\r\ndev_warn(&i2c->adap.dev, "%s(): not mine interrupt\n", __func__);\r\niret = IRQ_NONE;\r\nirq_ok:\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\nif (iret == IRQ_HANDLED)\r\nwake_up(&i2c->wq);\r\nreturn iret;\r\n}\r\nstatic void netup_i2c_reset(struct netup_i2c *i2c)\r\n{\r\ndev_dbg(i2c->adap.dev.parent, "%s()\n", __func__);\r\ni2c->state = STATE_DONE;\r\nwritew(TWI_SOFT_RESET, &i2c->regs->twi_addr_ctrl1);\r\nwritew(TWI_CLKDIV, &i2c->regs->clkdiv);\r\nwritew(FIFO_RESET, &i2c->regs->tx_fifo.stat_ctrl);\r\nwritew(FIFO_RESET, &i2c->regs->rx_fifo.stat_ctrl);\r\nwritew(0x800, &i2c->regs->tx_fifo.stat_ctrl);\r\nwritew(0x800, &i2c->regs->rx_fifo.stat_ctrl);\r\n}\r\nstatic void netup_i2c_fifo_tx(struct netup_i2c *i2c)\r\n{\r\nu8 data;\r\nu32 fifo_space = FIFO_SIZE -\r\n(readw(&i2c->regs->tx_fifo.stat_ctrl) & 0x3f);\r\nu32 msg_length = i2c->msg->len - i2c->xmit_size;\r\nmsg_length = (msg_length < fifo_space ? msg_length : fifo_space);\r\nwhile (msg_length--) {\r\ndata = i2c->msg->buf[i2c->xmit_size++];\r\nwriteb(data, &i2c->regs->tx_fifo.data8);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): write 0x%02x\n", __func__, data);\r\n}\r\nif (i2c->xmit_size < i2c->msg->len) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): TX IRQ enabled\n", __func__);\r\nwritew(readw(&i2c->regs->tx_fifo.stat_ctrl) | FIFO_IRQEN,\r\n&i2c->regs->tx_fifo.stat_ctrl);\r\n}\r\n}\r\nstatic void netup_i2c_fifo_rx(struct netup_i2c *i2c)\r\n{\r\nu8 data;\r\nu32 fifo_size = readw(&i2c->regs->rx_fifo.stat_ctrl) & 0x3f;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): RX fifo size %d\n", __func__, fifo_size);\r\nwhile (fifo_size--) {\r\ndata = readb(&i2c->regs->rx_fifo.data8);\r\nif ((i2c->msg->flags & I2C_M_RD) != 0 &&\r\ni2c->xmit_size < i2c->msg->len) {\r\ni2c->msg->buf[i2c->xmit_size++] = data;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): read 0x%02x\n", __func__, data);\r\n}\r\n}\r\nif (i2c->xmit_size < i2c->msg->len) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): RX IRQ enabled\n", __func__);\r\nwritew(readw(&i2c->regs->rx_fifo.stat_ctrl) | FIFO_IRQEN,\r\n&i2c->regs->rx_fifo.stat_ctrl);\r\n}\r\n}\r\nstatic void netup_i2c_start_xfer(struct netup_i2c *i2c)\r\n{\r\nu16 rdflag = ((i2c->msg->flags & I2C_M_RD) ? 1 : 0);\r\nu16 reg = readw(&i2c->regs->twi_ctrl0_stat);\r\nwritew(TWI_IRQEN | reg, &i2c->regs->twi_ctrl0_stat);\r\nwritew(i2c->msg->len, &i2c->regs->length);\r\nwritew(TWI_TRANSFER | (i2c->msg->addr << 1) | rdflag,\r\n&i2c->regs->twi_addr_ctrl1);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): length %d twi_addr_ctrl1 0x%x twi_ctrl0_stat 0x%x\n",\r\n__func__, readw(&i2c->regs->length),\r\nreadw(&i2c->regs->twi_addr_ctrl1),\r\nreadw(&i2c->regs->twi_ctrl0_stat));\r\ni2c->state = STATE_WAIT;\r\ni2c->xmit_size = 0;\r\nif (!rdflag)\r\nnetup_i2c_fifo_tx(i2c);\r\nelse\r\nwritew(FIFO_IRQEN | readw(&i2c->regs->rx_fifo.stat_ctrl),\r\n&i2c->regs->rx_fifo.stat_ctrl);\r\n}\r\nstatic int netup_i2c_xfer(struct i2c_adapter *adap,\r\nstruct i2c_msg *msgs, int num)\r\n{\r\nunsigned long flags;\r\nint i, trans_done, res = num;\r\nstruct netup_i2c *i2c = i2c_get_adapdata(adap);\r\nu16 reg;\r\nif (num <= 0) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): num == %d\n", __func__, num);\r\nreturn -EINVAL;\r\n}\r\nspin_lock_irqsave(&i2c->lock, flags);\r\nif (i2c->state != STATE_DONE) {\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): i2c->state == %d, resetting I2C\n",\r\n__func__, i2c->state);\r\nnetup_i2c_reset(i2c);\r\n}\r\ndev_dbg(i2c->adap.dev.parent, "%s() num %d\n", __func__, num);\r\nfor (i = 0; i < num; i++) {\r\ni2c->msg = &msgs[i];\r\nnetup_i2c_start_xfer(i2c);\r\ntrans_done = 0;\r\nwhile (!trans_done) {\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\nif (wait_event_timeout(i2c->wq,\r\ni2c->state != STATE_WAIT,\r\nmsecs_to_jiffies(NETUP_I2C_TIMEOUT))) {\r\nspin_lock_irqsave(&i2c->lock, flags);\r\nswitch (i2c->state) {\r\ncase STATE_WANT_READ:\r\nnetup_i2c_fifo_rx(i2c);\r\nbreak;\r\ncase STATE_WANT_WRITE:\r\nnetup_i2c_fifo_tx(i2c);\r\nbreak;\r\ncase STATE_DONE:\r\nif ((i2c->msg->flags & I2C_M_RD) != 0 &&\r\ni2c->xmit_size != i2c->msg->len)\r\nnetup_i2c_fifo_rx(i2c);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): msg %d OK\n",\r\n__func__, i);\r\ntrans_done = 1;\r\nbreak;\r\ncase STATE_ERROR:\r\nres = -EIO;\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): error state\n",\r\n__func__);\r\ngoto done;\r\ndefault:\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): invalid state %d\n",\r\n__func__, i2c->state);\r\nres = -EINVAL;\r\ngoto done;\r\n}\r\nif (!trans_done) {\r\ni2c->state = STATE_WAIT;\r\nreg = readw(\r\n&i2c->regs->twi_ctrl0_stat);\r\nwritew(TWI_IRQEN | reg,\r\n&i2c->regs->twi_ctrl0_stat);\r\n}\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\n} else {\r\nspin_lock_irqsave(&i2c->lock, flags);\r\ndev_dbg(i2c->adap.dev.parent,\r\n"%s(): wait timeout\n", __func__);\r\nres = -ETIMEDOUT;\r\ngoto done;\r\n}\r\nspin_lock_irqsave(&i2c->lock, flags);\r\n}\r\n}\r\ndone:\r\nspin_unlock_irqrestore(&i2c->lock, flags);\r\ndev_dbg(i2c->adap.dev.parent, "%s(): result %d\n", __func__, res);\r\nreturn res;\r\n}\r\nstatic u32 netup_i2c_func(struct i2c_adapter *adap)\r\n{\r\nreturn I2C_FUNC_I2C | I2C_FUNC_SMBUS_EMUL;\r\n}\r\nstatic int netup_i2c_init(struct netup_unidvb_dev *ndev, int bus_num)\r\n{\r\nint ret;\r\nstruct netup_i2c *i2c;\r\nif (bus_num < 0 || bus_num > 1) {\r\ndev_err(&ndev->pci_dev->dev,\r\n"%s(): invalid bus_num %d\n", __func__, bus_num);\r\nreturn -EINVAL;\r\n}\r\ni2c = &ndev->i2c[bus_num];\r\nspin_lock_init(&i2c->lock);\r\ninit_waitqueue_head(&i2c->wq);\r\ni2c->regs = (struct netup_i2c_regs __iomem *)(ndev->bmmio0 +\r\n(bus_num == 0 ? NETUP_I2C_BUS0_ADDR : NETUP_I2C_BUS1_ADDR));\r\nnetup_i2c_reset(i2c);\r\ni2c->adap = netup_i2c_adapter;\r\ni2c->adap.dev.parent = &ndev->pci_dev->dev;\r\ni2c_set_adapdata(&i2c->adap, i2c);\r\nret = i2c_add_adapter(&i2c->adap);\r\nif (ret) {\r\ndev_err(&ndev->pci_dev->dev,\r\n"%s(): failed to add I2C adapter\n", __func__);\r\nreturn ret;\r\n}\r\ndev_info(&ndev->pci_dev->dev,\r\n"%s(): registered I2C bus %d at 0x%x\n",\r\n__func__,\r\nbus_num, (bus_num == 0 ?\r\nNETUP_I2C_BUS0_ADDR :\r\nNETUP_I2C_BUS1_ADDR));\r\nreturn 0;\r\n}\r\nstatic void netup_i2c_remove(struct netup_unidvb_dev *ndev, int bus_num)\r\n{\r\nstruct netup_i2c *i2c;\r\nif (bus_num < 0 || bus_num > 1) {\r\ndev_err(&ndev->pci_dev->dev,\r\n"%s(): invalid bus number %d\n", __func__, bus_num);\r\nreturn;\r\n}\r\ni2c = &ndev->i2c[bus_num];\r\nnetup_i2c_reset(i2c);\r\ni2c_del_adapter(&i2c->adap);\r\ndev_info(&ndev->pci_dev->dev,\r\n"netup_i2c_remove: unregistered I2C bus %d\n", bus_num);\r\n}\r\nint netup_i2c_register(struct netup_unidvb_dev *ndev)\r\n{\r\nint ret;\r\nret = netup_i2c_init(ndev, 0);\r\nif (ret)\r\nreturn ret;\r\nret = netup_i2c_init(ndev, 1);\r\nif (ret) {\r\nnetup_i2c_remove(ndev, 0);\r\nreturn ret;\r\n}\r\nreturn 0;\r\n}\r\nvoid netup_i2c_unregister(struct netup_unidvb_dev *ndev)\r\n{\r\nnetup_i2c_remove(ndev, 0);\r\nnetup_i2c_remove(ndev, 1);\r\n}

static void funnel_enable_hw(struct funnel_drvdata *drvdata, int port)\r\n{\r\nu32 functl;\r\nCS_UNLOCK(drvdata->base);\r\nfunctl = readl_relaxed(drvdata->base + FUNNEL_FUNCTL);\r\nfunctl &= ~FUNNEL_HOLDTIME_MASK;\r\nfunctl |= FUNNEL_HOLDTIME;\r\nfunctl |= (1 << port);\r\nwritel_relaxed(functl, drvdata->base + FUNNEL_FUNCTL);\r\nwritel_relaxed(drvdata->priority, drvdata->base + FUNNEL_PRICTL);\r\nCS_LOCK(drvdata->base);\r\n}\r\nstatic int funnel_enable(struct coresight_device *csdev, int inport,\r\nint outport)\r\n{\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(csdev->dev.parent);\r\nfunnel_enable_hw(drvdata, inport);\r\ndev_info(drvdata->dev, "FUNNEL inport %d enabled\n", inport);\r\nreturn 0;\r\n}\r\nstatic void funnel_disable_hw(struct funnel_drvdata *drvdata, int inport)\r\n{\r\nu32 functl;\r\nCS_UNLOCK(drvdata->base);\r\nfunctl = readl_relaxed(drvdata->base + FUNNEL_FUNCTL);\r\nfunctl &= ~(1 << inport);\r\nwritel_relaxed(functl, drvdata->base + FUNNEL_FUNCTL);\r\nCS_LOCK(drvdata->base);\r\n}\r\nstatic void funnel_disable(struct coresight_device *csdev, int inport,\r\nint outport)\r\n{\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(csdev->dev.parent);\r\nfunnel_disable_hw(drvdata, inport);\r\ndev_info(drvdata->dev, "FUNNEL inport %d disabled\n", inport);\r\n}\r\nstatic ssize_t priority_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nunsigned long val = drvdata->priority;\r\nreturn sprintf(buf, "%#lx\n", val);\r\n}\r\nstatic ssize_t priority_store(struct device *dev,\r\nstruct device_attribute *attr,\r\nconst char *buf, size_t size)\r\n{\r\nint ret;\r\nunsigned long val;\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\nret = kstrtoul(buf, 16, &val);\r\nif (ret)\r\nreturn ret;\r\ndrvdata->priority = val;\r\nreturn size;\r\n}\r\nstatic u32 get_funnel_ctrl_hw(struct funnel_drvdata *drvdata)\r\n{\r\nu32 functl;\r\nCS_UNLOCK(drvdata->base);\r\nfunctl = readl_relaxed(drvdata->base + FUNNEL_FUNCTL);\r\nCS_LOCK(drvdata->base);\r\nreturn functl;\r\n}\r\nstatic ssize_t funnel_ctrl_show(struct device *dev,\r\nstruct device_attribute *attr, char *buf)\r\n{\r\nu32 val;\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(dev->parent);\r\npm_runtime_get_sync(drvdata->dev);\r\nval = get_funnel_ctrl_hw(drvdata);\r\npm_runtime_put(drvdata->dev);\r\nreturn sprintf(buf, "%#x\n", val);\r\n}\r\nstatic int funnel_probe(struct amba_device *adev, const struct amba_id *id)\r\n{\r\nint ret;\r\nvoid __iomem *base;\r\nstruct device *dev = &adev->dev;\r\nstruct coresight_platform_data *pdata = NULL;\r\nstruct funnel_drvdata *drvdata;\r\nstruct resource *res = &adev->res;\r\nstruct coresight_desc *desc;\r\nstruct device_node *np = adev->dev.of_node;\r\nif (np) {\r\npdata = of_get_coresight_platform_data(dev, np);\r\nif (IS_ERR(pdata))\r\nreturn PTR_ERR(pdata);\r\nadev->dev.platform_data = pdata;\r\n}\r\ndrvdata = devm_kzalloc(dev, sizeof(*drvdata), GFP_KERNEL);\r\nif (!drvdata)\r\nreturn -ENOMEM;\r\ndrvdata->dev = &adev->dev;\r\ndrvdata->atclk = devm_clk_get(&adev->dev, "atclk");\r\nif (!IS_ERR(drvdata->atclk)) {\r\nret = clk_prepare_enable(drvdata->atclk);\r\nif (ret)\r\nreturn ret;\r\n}\r\ndev_set_drvdata(dev, drvdata);\r\nbase = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(base))\r\nreturn PTR_ERR(base);\r\ndrvdata->base = base;\r\npm_runtime_put(&adev->dev);\r\ndesc = devm_kzalloc(dev, sizeof(*desc), GFP_KERNEL);\r\nif (!desc)\r\nreturn -ENOMEM;\r\ndesc->type = CORESIGHT_DEV_TYPE_LINK;\r\ndesc->subtype.link_subtype = CORESIGHT_DEV_SUBTYPE_LINK_MERG;\r\ndesc->ops = &funnel_cs_ops;\r\ndesc->pdata = pdata;\r\ndesc->dev = dev;\r\ndesc->groups = coresight_funnel_groups;\r\ndrvdata->csdev = coresight_register(desc);\r\nif (IS_ERR(drvdata->csdev))\r\nreturn PTR_ERR(drvdata->csdev);\r\nreturn 0;\r\n}\r\nstatic int funnel_runtime_suspend(struct device *dev)\r\n{\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(dev);\r\nif (drvdata && !IS_ERR(drvdata->atclk))\r\nclk_disable_unprepare(drvdata->atclk);\r\nreturn 0;\r\n}\r\nstatic int funnel_runtime_resume(struct device *dev)\r\n{\r\nstruct funnel_drvdata *drvdata = dev_get_drvdata(dev);\r\nif (drvdata && !IS_ERR(drvdata->atclk))\r\nclk_prepare_enable(drvdata->atclk);\r\nreturn 0;\r\n}

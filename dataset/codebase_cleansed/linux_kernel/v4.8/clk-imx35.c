static void __init _mx35_clocks_init(void)\r\n{\r\nvoid __iomem *base;\r\nu32 pdr0, consumer_sel, hsp_sel;\r\nstruct arm_ahb_div *aad;\r\nunsigned char *hsp_div;\r\nbase = ioremap(MX35_CCM_BASE_ADDR, SZ_4K);\r\nBUG_ON(!base);\r\npdr0 = __raw_readl(base + MXC_CCM_PDR0);\r\nconsumer_sel = (pdr0 >> 16) & 0xf;\r\naad = &clk_consumer[consumer_sel];\r\nif (!aad->arm) {\r\npr_err("i.MX35 clk: illegal consumer mux selection 0x%x\n", consumer_sel);\r\naad = &clk_consumer[0];\r\n}\r\nclk[ckih] = imx_clk_fixed("ckih", 24000000);\r\nclk[ckil] = imx_clk_fixed("ckih", 32768);\r\nclk[mpll] = imx_clk_pllv1(IMX_PLLV1_IMX35, "mpll", "ckih", base + MX35_CCM_MPCTL);\r\nclk[ppll] = imx_clk_pllv1(IMX_PLLV1_IMX35, "ppll", "ckih", base + MX35_CCM_PPCTL);\r\nclk[mpll] = imx_clk_fixed_factor("mpll_075", "mpll", 3, 4);\r\nif (aad->sel)\r\nclk[arm] = imx_clk_fixed_factor("arm", "mpll_075", 1, aad->arm);\r\nelse\r\nclk[arm] = imx_clk_fixed_factor("arm", "mpll", 1, aad->arm);\r\nif (clk_get_rate(clk[arm]) > 400000000)\r\nhsp_div = hsp_div_532;\r\nelse\r\nhsp_div = hsp_div_400;\r\nhsp_sel = (pdr0 >> 20) & 0x3;\r\nif (!hsp_div[hsp_sel]) {\r\npr_err("i.MX35 clk: illegal hsp clk selection 0x%x\n", hsp_sel);\r\nhsp_sel = 0;\r\n}\r\nclk[hsp] = imx_clk_fixed_factor("hsp", "arm", 1, hsp_div[hsp_sel]);\r\nclk[ahb] = imx_clk_fixed_factor("ahb", "arm", 1, aad->ahb);\r\nclk[ipg] = imx_clk_fixed_factor("ipg", "ahb", 1, 2);\r\nclk[arm_per_div] = imx_clk_divider("arm_per_div", "arm", base + MX35_CCM_PDR4, 16, 6);\r\nclk[ahb_per_div] = imx_clk_divider("ahb_per_div", "ahb", base + MXC_CCM_PDR0, 12, 3);\r\nclk[ipg_per] = imx_clk_mux("ipg_per", base + MXC_CCM_PDR0, 26, 1, ipg_per_sel, ARRAY_SIZE(ipg_per_sel));\r\nclk[uart_sel] = imx_clk_mux("uart_sel", base + MX35_CCM_PDR3, 14, 1, std_sel, ARRAY_SIZE(std_sel));\r\nclk[uart_div] = imx_clk_divider("uart_div", "uart_sel", base + MX35_CCM_PDR4, 10, 6);\r\nclk[esdhc_sel] = imx_clk_mux("esdhc_sel", base + MX35_CCM_PDR4, 9, 1, std_sel, ARRAY_SIZE(std_sel));\r\nclk[esdhc1_div] = imx_clk_divider("esdhc1_div", "esdhc_sel", base + MX35_CCM_PDR3, 0, 6);\r\nclk[esdhc2_div] = imx_clk_divider("esdhc2_div", "esdhc_sel", base + MX35_CCM_PDR3, 8, 6);\r\nclk[esdhc3_div] = imx_clk_divider("esdhc3_div", "esdhc_sel", base + MX35_CCM_PDR3, 16, 6);\r\nclk[spdif_sel] = imx_clk_mux("spdif_sel", base + MX35_CCM_PDR3, 22, 1, std_sel, ARRAY_SIZE(std_sel));\r\nclk[spdif_div_pre] = imx_clk_divider("spdif_div_pre", "spdif_sel", base + MX35_CCM_PDR3, 29, 3);\r\nclk[spdif_div_post] = imx_clk_divider("spdif_div_post", "spdif_div_pre", base + MX35_CCM_PDR3, 23, 6);\r\nclk[ssi_sel] = imx_clk_mux("ssi_sel", base + MX35_CCM_PDR2, 6, 1, std_sel, ARRAY_SIZE(std_sel));\r\nclk[ssi1_div_pre] = imx_clk_divider("ssi1_div_pre", "ssi_sel", base + MX35_CCM_PDR2, 24, 3);\r\nclk[ssi1_div_post] = imx_clk_divider("ssi1_div_post", "ssi1_div_pre", base + MX35_CCM_PDR2, 0, 6);\r\nclk[ssi2_div_pre] = imx_clk_divider("ssi2_div_pre", "ssi_sel", base + MX35_CCM_PDR2, 27, 3);\r\nclk[ssi2_div_post] = imx_clk_divider("ssi2_div_post", "ssi2_div_pre", base + MX35_CCM_PDR2, 8, 6);\r\nclk[usb_sel] = imx_clk_mux("usb_sel", base + MX35_CCM_PDR4, 9, 1, std_sel, ARRAY_SIZE(std_sel));\r\nclk[usb_div] = imx_clk_divider("usb_div", "usb_sel", base + MX35_CCM_PDR4, 22, 6);\r\nclk[nfc_div] = imx_clk_divider("nfc_div", "ahb", base + MX35_CCM_PDR4, 28, 4);\r\nclk[csi_sel] = imx_clk_mux("csi_sel", base + MX35_CCM_PDR2, 7, 1, std_sel, ARRAY_SIZE(std_sel));\r\nclk[csi_div] = imx_clk_divider("csi_div", "csi_sel", base + MX35_CCM_PDR2, 16, 6);\r\nclk[asrc_gate] = imx_clk_gate2("asrc_gate", "ipg", base + MX35_CCM_CGR0, 0);\r\nclk[pata_gate] = imx_clk_gate2("pata_gate", "ipg", base + MX35_CCM_CGR0, 2);\r\nclk[audmux_gate] = imx_clk_gate2("audmux_gate", "ipg", base + MX35_CCM_CGR0, 4);\r\nclk[can1_gate] = imx_clk_gate2("can1_gate", "ipg", base + MX35_CCM_CGR0, 6);\r\nclk[can2_gate] = imx_clk_gate2("can2_gate", "ipg", base + MX35_CCM_CGR0, 8);\r\nclk[cspi1_gate] = imx_clk_gate2("cspi1_gate", "ipg", base + MX35_CCM_CGR0, 10);\r\nclk[cspi2_gate] = imx_clk_gate2("cspi2_gate", "ipg", base + MX35_CCM_CGR0, 12);\r\nclk[ect_gate] = imx_clk_gate2("ect_gate", "ipg", base + MX35_CCM_CGR0, 14);\r\nclk[edio_gate] = imx_clk_gate2("edio_gate", "ipg", base + MX35_CCM_CGR0, 16);\r\nclk[emi_gate] = imx_clk_gate2("emi_gate", "ipg", base + MX35_CCM_CGR0, 18);\r\nclk[epit1_gate] = imx_clk_gate2("epit1_gate", "ipg", base + MX35_CCM_CGR0, 20);\r\nclk[epit2_gate] = imx_clk_gate2("epit2_gate", "ipg", base + MX35_CCM_CGR0, 22);\r\nclk[esai_gate] = imx_clk_gate2("esai_gate", "ipg", base + MX35_CCM_CGR0, 24);\r\nclk[esdhc1_gate] = imx_clk_gate2("esdhc1_gate", "esdhc1_div", base + MX35_CCM_CGR0, 26);\r\nclk[esdhc2_gate] = imx_clk_gate2("esdhc2_gate", "esdhc2_div", base + MX35_CCM_CGR0, 28);\r\nclk[esdhc3_gate] = imx_clk_gate2("esdhc3_gate", "esdhc3_div", base + MX35_CCM_CGR0, 30);\r\nclk[fec_gate] = imx_clk_gate2("fec_gate", "ipg", base + MX35_CCM_CGR1, 0);\r\nclk[gpio1_gate] = imx_clk_gate2("gpio1_gate", "ipg", base + MX35_CCM_CGR1, 2);\r\nclk[gpio2_gate] = imx_clk_gate2("gpio2_gate", "ipg", base + MX35_CCM_CGR1, 4);\r\nclk[gpio3_gate] = imx_clk_gate2("gpio3_gate", "ipg", base + MX35_CCM_CGR1, 6);\r\nclk[gpt_gate] = imx_clk_gate2("gpt_gate", "ipg", base + MX35_CCM_CGR1, 8);\r\nclk[i2c1_gate] = imx_clk_gate2("i2c1_gate", "ipg_per", base + MX35_CCM_CGR1, 10);\r\nclk[i2c2_gate] = imx_clk_gate2("i2c2_gate", "ipg_per", base + MX35_CCM_CGR1, 12);\r\nclk[i2c3_gate] = imx_clk_gate2("i2c3_gate", "ipg_per", base + MX35_CCM_CGR1, 14);\r\nclk[iomuxc_gate] = imx_clk_gate2("iomuxc_gate", "ipg", base + MX35_CCM_CGR1, 16);\r\nclk[ipu_gate] = imx_clk_gate2("ipu_gate", "hsp", base + MX35_CCM_CGR1, 18);\r\nclk[kpp_gate] = imx_clk_gate2("kpp_gate", "ipg", base + MX35_CCM_CGR1, 20);\r\nclk[mlb_gate] = imx_clk_gate2("mlb_gate", "ahb", base + MX35_CCM_CGR1, 22);\r\nclk[mshc_gate] = imx_clk_gate2("mshc_gate", "dummy", base + MX35_CCM_CGR1, 24);\r\nclk[owire_gate] = imx_clk_gate2("owire_gate", "ipg_per", base + MX35_CCM_CGR1, 26);\r\nclk[pwm_gate] = imx_clk_gate2("pwm_gate", "ipg_per", base + MX35_CCM_CGR1, 28);\r\nclk[rngc_gate] = imx_clk_gate2("rngc_gate", "ipg", base + MX35_CCM_CGR1, 30);\r\nclk[rtc_gate] = imx_clk_gate2("rtc_gate", "ipg", base + MX35_CCM_CGR2, 0);\r\nclk[rtic_gate] = imx_clk_gate2("rtic_gate", "ahb", base + MX35_CCM_CGR2, 2);\r\nclk[scc_gate] = imx_clk_gate2("scc_gate", "ipg", base + MX35_CCM_CGR2, 4);\r\nclk[sdma_gate] = imx_clk_gate2("sdma_gate", "ahb", base + MX35_CCM_CGR2, 6);\r\nclk[spba_gate] = imx_clk_gate2("spba_gate", "ipg", base + MX35_CCM_CGR2, 8);\r\nclk[spdif_gate] = imx_clk_gate2("spdif_gate", "spdif_div_post", base + MX35_CCM_CGR2, 10);\r\nclk[ssi1_gate] = imx_clk_gate2("ssi1_gate", "ssi1_div_post", base + MX35_CCM_CGR2, 12);\r\nclk[ssi2_gate] = imx_clk_gate2("ssi2_gate", "ssi2_div_post", base + MX35_CCM_CGR2, 14);\r\nclk[uart1_gate] = imx_clk_gate2("uart1_gate", "uart_div", base + MX35_CCM_CGR2, 16);\r\nclk[uart2_gate] = imx_clk_gate2("uart2_gate", "uart_div", base + MX35_CCM_CGR2, 18);\r\nclk[uart3_gate] = imx_clk_gate2("uart3_gate", "uart_div", base + MX35_CCM_CGR2, 20);\r\nclk[usbotg_gate] = imx_clk_gate2("usbotg_gate", "ahb", base + MX35_CCM_CGR2, 22);\r\nclk[wdog_gate] = imx_clk_gate2("wdog_gate", "ipg", base + MX35_CCM_CGR2, 24);\r\nclk[max_gate] = imx_clk_gate2("max_gate", "dummy", base + MX35_CCM_CGR2, 26);\r\nclk[admux_gate] = imx_clk_gate2("admux_gate", "ipg", base + MX35_CCM_CGR2, 30);\r\nclk[csi_gate] = imx_clk_gate2("csi_gate", "csi_div", base + MX35_CCM_CGR3, 0);\r\nclk[iim_gate] = imx_clk_gate2("iim_gate", "ipg", base + MX35_CCM_CGR3, 2);\r\nclk[gpu2d_gate] = imx_clk_gate2("gpu2d_gate", "ahb", base + MX35_CCM_CGR3, 4);\r\nimx_check_clocks(clk, ARRAY_SIZE(clk));\r\nclk_prepare_enable(clk[spba_gate]);\r\nclk_prepare_enable(clk[gpio1_gate]);\r\nclk_prepare_enable(clk[gpio2_gate]);\r\nclk_prepare_enable(clk[gpio3_gate]);\r\nclk_prepare_enable(clk[iim_gate]);\r\nclk_prepare_enable(clk[emi_gate]);\r\nclk_prepare_enable(clk[max_gate]);\r\nclk_prepare_enable(clk[iomuxc_gate]);\r\nclk_prepare_enable(clk[scc_gate]);\r\nimx_register_uart_clocks(uart_clks);\r\nimx_print_silicon_rev("i.MX35", mx35_revision());\r\n}\r\nint __init mx35_clocks_init(void)\r\n{\r\n_mx35_clocks_init();\r\nclk_register_clkdev(clk[pata_gate], NULL, "pata_imx");\r\nclk_register_clkdev(clk[can1_gate], NULL, "flexcan.0");\r\nclk_register_clkdev(clk[can2_gate], NULL, "flexcan.1");\r\nclk_register_clkdev(clk[cspi1_gate], "per", "imx35-cspi.0");\r\nclk_register_clkdev(clk[cspi1_gate], "ipg", "imx35-cspi.0");\r\nclk_register_clkdev(clk[cspi2_gate], "per", "imx35-cspi.1");\r\nclk_register_clkdev(clk[cspi2_gate], "ipg", "imx35-cspi.1");\r\nclk_register_clkdev(clk[epit1_gate], NULL, "imx-epit.0");\r\nclk_register_clkdev(clk[epit2_gate], NULL, "imx-epit.1");\r\nclk_register_clkdev(clk[esdhc1_gate], "per", "sdhci-esdhc-imx35.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "sdhci-esdhc-imx35.0");\r\nclk_register_clkdev(clk[ahb], "ahb", "sdhci-esdhc-imx35.0");\r\nclk_register_clkdev(clk[esdhc2_gate], "per", "sdhci-esdhc-imx35.1");\r\nclk_register_clkdev(clk[ipg], "ipg", "sdhci-esdhc-imx35.1");\r\nclk_register_clkdev(clk[ahb], "ahb", "sdhci-esdhc-imx35.1");\r\nclk_register_clkdev(clk[esdhc3_gate], "per", "sdhci-esdhc-imx35.2");\r\nclk_register_clkdev(clk[ipg], "ipg", "sdhci-esdhc-imx35.2");\r\nclk_register_clkdev(clk[ahb], "ahb", "sdhci-esdhc-imx35.2");\r\nclk_register_clkdev(clk[fec_gate], NULL, "imx27-fec.0");\r\nclk_register_clkdev(clk[gpt_gate], "per", "imx-gpt.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx-gpt.0");\r\nclk_register_clkdev(clk[i2c1_gate], NULL, "imx21-i2c.0");\r\nclk_register_clkdev(clk[i2c2_gate], NULL, "imx21-i2c.1");\r\nclk_register_clkdev(clk[i2c3_gate], NULL, "imx21-i2c.2");\r\nclk_register_clkdev(clk[ipu_gate], NULL, "ipu-core");\r\nclk_register_clkdev(clk[ipu_gate], NULL, "mx3_sdc_fb");\r\nclk_register_clkdev(clk[kpp_gate], NULL, "imx-keypad");\r\nclk_register_clkdev(clk[owire_gate], NULL, "mxc_w1");\r\nclk_register_clkdev(clk[sdma_gate], NULL, "imx35-sdma");\r\nclk_register_clkdev(clk[ssi1_gate], NULL, "imx-ssi.0");\r\nclk_register_clkdev(clk[ssi2_gate], NULL, "imx-ssi.1");\r\nclk_register_clkdev(clk[uart1_gate], "per", "imx21-uart.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.0");\r\nclk_register_clkdev(clk[uart2_gate], "per", "imx21-uart.1");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.1");\r\nclk_register_clkdev(clk[uart3_gate], "per", "imx21-uart.2");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx21-uart.2");\r\nclk_register_clkdev(clk[ckil], "ref", "imx21-rtc");\r\nclk_register_clkdev(clk[rtc_gate], "ipg", "imx21-rtc");\r\nclk_register_clkdev(clk[usb_div], "per", "mxc-ehci.0");\r\nclk_register_clkdev(clk[ipg], "ipg", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usbotg_gate], "ahb", "mxc-ehci.0");\r\nclk_register_clkdev(clk[usb_div], "per", "mxc-ehci.1");\r\nclk_register_clkdev(clk[ipg], "ipg", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usbotg_gate], "ahb", "mxc-ehci.1");\r\nclk_register_clkdev(clk[usb_div], "per", "mxc-ehci.2");\r\nclk_register_clkdev(clk[ipg], "ipg", "mxc-ehci.2");\r\nclk_register_clkdev(clk[usbotg_gate], "ahb", "mxc-ehci.2");\r\nclk_register_clkdev(clk[usb_div], "per", "imx-udc-mx27");\r\nclk_register_clkdev(clk[ipg], "ipg", "imx-udc-mx27");\r\nclk_register_clkdev(clk[usbotg_gate], "ahb", "imx-udc-mx27");\r\nclk_register_clkdev(clk[wdog_gate], NULL, "imx2-wdt.0");\r\nclk_register_clkdev(clk[nfc_div], NULL, "imx25-nand.0");\r\nclk_register_clkdev(clk[csi_gate], NULL, "mx3-camera.0");\r\nclk_register_clkdev(clk[admux_gate], "audmux", NULL);\r\nmxc_timer_init(MX35_GPT1_BASE_ADDR, MX35_INT_GPT, GPT_TYPE_IMX31);\r\nreturn 0;\r\n}\r\nstatic void __init mx35_clocks_init_dt(struct device_node *ccm_node)\r\n{\r\n_mx35_clocks_init();\r\nclk_data.clks = clk;\r\nclk_data.clk_num = ARRAY_SIZE(clk);\r\nof_clk_add_provider(ccm_node, of_clk_src_onecell_get, &clk_data);\r\n}

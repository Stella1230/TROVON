static int led_power_set(struct pm860x_chip *chip, int port, int on)\r\n{\r\nint ret = -EINVAL;\r\nswitch (port) {\r\ncase 0:\r\ncase 1:\r\ncase 2:\r\nret = on ? pm8606_osc_enable(chip, RGB1_ENABLE) :\r\npm8606_osc_disable(chip, RGB1_ENABLE);\r\nbreak;\r\ncase 3:\r\ncase 4:\r\ncase 5:\r\nret = on ? pm8606_osc_enable(chip, RGB2_ENABLE) :\r\npm8606_osc_disable(chip, RGB2_ENABLE);\r\nbreak;\r\n}\r\nreturn ret;\r\n}\r\nstatic int pm860x_led_set(struct led_classdev *cdev,\r\nenum led_brightness value)\r\n{\r\nstruct pm860x_led *led = container_of(cdev, struct pm860x_led, cdev);\r\nstruct pm860x_chip *chip;\r\nunsigned char buf[3];\r\nint ret;\r\nchip = led->chip;\r\nmutex_lock(&led->lock);\r\nled->brightness = value >> 3;\r\nif ((led->current_brightness == 0) && led->brightness) {\r\nled_power_set(chip, led->port, 1);\r\nif (led->iset) {\r\npm860x_set_bits(led->i2c, led->reg_control,\r\nLED_CURRENT_MASK, led->iset);\r\n}\r\npm860x_set_bits(led->i2c, led->reg_blink,\r\nLED_BLINK_MASK, LED_ON_CONTINUOUS);\r\npm860x_set_bits(led->i2c, PM8606_WLED3B, led->blink_mask,\r\nled->blink_mask);\r\n}\r\npm860x_set_bits(led->i2c, led->reg_control, LED_PWM_MASK,\r\nled->brightness);\r\nif (led->brightness == 0) {\r\npm860x_bulk_read(led->i2c, led->reg_control, 3, buf);\r\nret = buf[0] & LED_PWM_MASK;\r\nret |= buf[1] & LED_PWM_MASK;\r\nret |= buf[2] & LED_PWM_MASK;\r\nif (ret == 0) {\r\npm860x_set_bits(led->i2c, led->reg_control,\r\nLED_CURRENT_MASK, 0);\r\npm860x_set_bits(led->i2c, PM8606_WLED3B,\r\nled->blink_mask, 0);\r\nled_power_set(chip, led->port, 0);\r\n}\r\n}\r\nled->current_brightness = led->brightness;\r\ndev_dbg(chip->dev, "Update LED. (reg:%d, brightness:%d)\n",\r\nled->reg_control, led->brightness);\r\nmutex_unlock(&led->lock);\r\nreturn 0;\r\n}\r\nstatic int pm860x_led_dt_init(struct platform_device *pdev,\r\nstruct pm860x_led *data)\r\n{\r\nstruct device_node *nproot, *np;\r\nint iset = 0;\r\nif (!pdev->dev.parent->of_node)\r\nreturn -ENODEV;\r\nnproot = of_get_child_by_name(pdev->dev.parent->of_node, "leds");\r\nif (!nproot) {\r\ndev_err(&pdev->dev, "failed to find leds node\n");\r\nreturn -ENODEV;\r\n}\r\nfor_each_child_of_node(nproot, np) {\r\nif (!of_node_cmp(np->name, data->name)) {\r\nof_property_read_u32(np, "marvell,88pm860x-iset",\r\n&iset);\r\ndata->iset = PM8606_LED_CURRENT(iset);\r\nof_node_put(np);\r\nbreak;\r\n}\r\n}\r\nof_node_put(nproot);\r\nreturn 0;\r\n}\r\nstatic int pm860x_led_probe(struct platform_device *pdev)\r\n{\r\nstruct pm860x_chip *chip = dev_get_drvdata(pdev->dev.parent);\r\nstruct pm860x_led_pdata *pdata = dev_get_platdata(&pdev->dev);\r\nstruct pm860x_led *data;\r\nstruct resource *res;\r\nint ret = 0;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(struct pm860x_led), GFP_KERNEL);\r\nif (data == NULL)\r\nreturn -ENOMEM;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_REG, "control");\r\nif (!res) {\r\ndev_err(&pdev->dev, "No REG resource for control\n");\r\nreturn -ENXIO;\r\n}\r\ndata->reg_control = res->start;\r\nres = platform_get_resource_byname(pdev, IORESOURCE_REG, "blink");\r\nif (!res) {\r\ndev_err(&pdev->dev, "No REG resource for blink\n");\r\nreturn -ENXIO;\r\n}\r\ndata->reg_blink = res->start;\r\nmemset(data->name, 0, MFD_NAME_SIZE);\r\nswitch (pdev->id) {\r\ncase 0:\r\ndata->blink_mask = LED1_BLINK_EN;\r\nsprintf(data->name, "led0-red");\r\nbreak;\r\ncase 1:\r\ndata->blink_mask = LED1_BLINK_EN;\r\nsprintf(data->name, "led0-green");\r\nbreak;\r\ncase 2:\r\ndata->blink_mask = LED1_BLINK_EN;\r\nsprintf(data->name, "led0-blue");\r\nbreak;\r\ncase 3:\r\ndata->blink_mask = LED2_BLINK_EN;\r\nsprintf(data->name, "led1-red");\r\nbreak;\r\ncase 4:\r\ndata->blink_mask = LED2_BLINK_EN;\r\nsprintf(data->name, "led1-green");\r\nbreak;\r\ncase 5:\r\ndata->blink_mask = LED2_BLINK_EN;\r\nsprintf(data->name, "led1-blue");\r\nbreak;\r\n}\r\ndata->chip = chip;\r\ndata->i2c = (chip->id == CHIP_PM8606) ? chip->client : chip->companion;\r\ndata->port = pdev->id;\r\nif (pm860x_led_dt_init(pdev, data))\r\nif (pdata)\r\ndata->iset = pdata->iset;\r\ndata->current_brightness = 0;\r\ndata->cdev.name = data->name;\r\ndata->cdev.brightness_set_blocking = pm860x_led_set;\r\nmutex_init(&data->lock);\r\nret = devm_led_classdev_register(chip->dev, &data->cdev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "Failed to register LED: %d\n", ret);\r\nreturn ret;\r\n}\r\npm860x_led_set(&data->cdev, 0);\r\nreturn 0;\r\n}

void __hyp_text __debug_save_state(struct kvm_vcpu *vcpu,\r\nstruct kvm_guest_debug_arch *dbg,\r\nstruct kvm_cpu_context *ctxt)\r\n{\r\nu64 aa64dfr0;\r\nint brps, wrps;\r\nif (!(vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY))\r\nreturn;\r\naa64dfr0 = read_sysreg(id_aa64dfr0_el1);\r\nbrps = (aa64dfr0 >> 12) & 0xf;\r\nwrps = (aa64dfr0 >> 20) & 0xf;\r\nsave_debug(dbg->dbg_bcr, dbgbcr, brps);\r\nsave_debug(dbg->dbg_bvr, dbgbvr, brps);\r\nsave_debug(dbg->dbg_wcr, dbgwcr, wrps);\r\nsave_debug(dbg->dbg_wvr, dbgwvr, wrps);\r\nctxt->sys_regs[MDCCINT_EL1] = read_sysreg(mdccint_el1);\r\n}\r\nvoid __hyp_text __debug_restore_state(struct kvm_vcpu *vcpu,\r\nstruct kvm_guest_debug_arch *dbg,\r\nstruct kvm_cpu_context *ctxt)\r\n{\r\nu64 aa64dfr0;\r\nint brps, wrps;\r\nif (!(vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY))\r\nreturn;\r\naa64dfr0 = read_sysreg(id_aa64dfr0_el1);\r\nbrps = (aa64dfr0 >> 12) & 0xf;\r\nwrps = (aa64dfr0 >> 20) & 0xf;\r\nrestore_debug(dbg->dbg_bcr, dbgbcr, brps);\r\nrestore_debug(dbg->dbg_bvr, dbgbvr, brps);\r\nrestore_debug(dbg->dbg_wcr, dbgwcr, wrps);\r\nrestore_debug(dbg->dbg_wvr, dbgwvr, wrps);\r\nwrite_sysreg(ctxt->sys_regs[MDCCINT_EL1], mdccint_el1);\r\n}\r\nvoid __hyp_text __debug_cond_save_host_state(struct kvm_vcpu *vcpu)\r\n{\r\nif ((vcpu->arch.ctxt.sys_regs[MDSCR_EL1] & DBG_MDSCR_KDE) ||\r\n(vcpu->arch.ctxt.sys_regs[MDSCR_EL1] & DBG_MDSCR_MDE))\r\nvcpu->arch.debug_flags |= KVM_ARM64_DEBUG_DIRTY;\r\n__debug_save_state(vcpu, &vcpu->arch.host_debug_state,\r\nkern_hyp_va(vcpu->arch.host_cpu_context));\r\n}\r\nvoid __hyp_text __debug_cond_restore_host_state(struct kvm_vcpu *vcpu)\r\n{\r\n__debug_restore_state(vcpu, &vcpu->arch.host_debug_state,\r\nkern_hyp_va(vcpu->arch.host_cpu_context));\r\nif (vcpu->arch.debug_flags & KVM_ARM64_DEBUG_DIRTY)\r\nvcpu->arch.debug_flags &= ~KVM_ARM64_DEBUG_DIRTY;\r\n}\r\nstatic u32 __hyp_text __debug_read_mdcr_el2(void)\r\n{\r\nreturn read_sysreg(mdcr_el2);\r\n}

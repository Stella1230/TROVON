static void qnap_power_off(void)\r\n{\r\nconst unsigned divisor = ((tclk + (8 * cfg->baud)) / (16 * cfg->baud));\r\npr_err("%s: triggering power-off...\n", __func__);\r\nwritel(0x83, UART1_REG(LCR));\r\nwritel(divisor & 0xff, UART1_REG(DLL));\r\nwritel((divisor >> 8) & 0xff, UART1_REG(DLM));\r\nwritel(0x03, UART1_REG(LCR));\r\nwritel(0x00, UART1_REG(IER));\r\nwritel(0x00, UART1_REG(FCR));\r\nwritel(0x00, UART1_REG(MCR));\r\nwritel(cfg->cmd, UART1_REG(TX));\r\n}\r\nstatic int qnap_power_off_probe(struct platform_device *pdev)\r\n{\r\nstruct device_node *np = pdev->dev.of_node;\r\nstruct resource *res;\r\nstruct clk *clk;\r\nchar symname[KSYM_NAME_LEN];\r\nconst struct of_device_id *match =\r\nof_match_node(qnap_power_off_of_match_table, np);\r\ncfg = match->data;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nif (!res) {\r\ndev_err(&pdev->dev, "Missing resource");\r\nreturn -EINVAL;\r\n}\r\nbase = devm_ioremap(&pdev->dev, res->start, resource_size(res));\r\nif (!base) {\r\ndev_err(&pdev->dev, "Unable to map resource");\r\nreturn -EINVAL;\r\n}\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Clk missing");\r\nreturn PTR_ERR(clk);\r\n}\r\ntclk = clk_get_rate(clk);\r\nif (pm_power_off) {\r\nlookup_symbol_name((ulong)pm_power_off, symname);\r\ndev_err(&pdev->dev,\r\n"pm_power_off already claimed %p %s",\r\npm_power_off, symname);\r\nreturn -EBUSY;\r\n}\r\npm_power_off = qnap_power_off;\r\nreturn 0;\r\n}\r\nstatic int qnap_power_off_remove(struct platform_device *pdev)\r\n{\r\npm_power_off = NULL;\r\nreturn 0;\r\n}

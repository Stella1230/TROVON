void msp7120_reset(void)\r\n{\r\nvoid *start, *end, *iptr;\r\nlocal_irq_disable();\r\n#ifdef CONFIG_SYS_SUPPORTS_MULTITHREADING\r\ndvpe();\r\n#endif\r\n__asm__ __volatile__ (\r\n" .set push \n"\r\n" .set arch=r4000 \n"\r\n" la %0,startpoint \n"\r\n" la %1,endpoint \n"\r\n" .set pop \n"\r\n: "=r" (start), "=r" (end)\r\n:\r\n);\r\nfor (iptr = (void *)((unsigned int)start & ~(L1_CACHE_BYTES - 1));\r\niptr < end; iptr += L1_CACHE_BYTES)\r\ncache_op(Fill, iptr);\r\n__asm__ __volatile__ (\r\n"startpoint: \n"\r\n);\r\nDDRC_INDIRECT_WRITE(DDRC_CTL(10), 0xb, 1 << 16);\r\nmdelay(125);\r\n#if defined(CONFIG_PMC_MSP7120_GW)\r\nset_value_reg32(GPIO_CFG3_REG, 0xf000, 0x8000);\r\nset_reg32(GPIO_DATA3_REG, 8);\r\n#endif\r\n*RST_SET_REG = 0x00000001;\r\n__asm__ __volatile__ (\r\n"endpoint: \n"\r\n);\r\n}\r\nvoid msp_restart(char *command)\r\n{\r\nprintk(KERN_WARNING "Now rebooting .......\n");\r\n#if defined(CONFIG_PMC_MSP7120_EVAL) || \\r\ndefined(CONFIG_PMC_MSP7120_GW) || \\r\ndefined(CONFIG_PMC_MSP7120_FPGA)\r\nmsp7120_reset();\r\n#else\r\nset_c0_status(ST0_BEV | ST0_ERL);\r\nchange_c0_config(CONF_CM_CMASK, CONF_CM_UNCACHED);\r\n__flush_cache_all();\r\nwrite_c0_wired(0);\r\n__asm__ __volatile__("jr\t%0"::"r"(0xbfc00000));\r\n#endif\r\n}\r\nvoid msp_halt(void)\r\n{\r\nprintk(KERN_WARNING "\n** You can safely turn off the power\n");\r\nwhile (1)\r\nif (cpu_wait)\r\n(*cpu_wait)();\r\nelse\r\n__asm__(".set\tmips3\n\t" "wait\n\t" ".set\tmips0");\r\n}\r\nvoid msp_power_off(void)\r\n{\r\nmsp_halt();\r\n}\r\nvoid __init plat_mem_setup(void)\r\n{\r\n_machine_restart = msp_restart;\r\n_machine_halt = msp_halt;\r\npm_power_off = msp_power_off;\r\n}\r\nvoid __init prom_init(void)\r\n{\r\nunsigned long family;\r\nunsigned long revision;\r\nprom_argc = fw_arg0;\r\nprom_argv = (char **)fw_arg1;\r\nprom_envp = (char **)fw_arg2;\r\nfamily = identify_family();\r\nrevision = identify_revision();\r\nswitch (family) {\r\ncase FAMILY_FPGA:\r\nif (FPGA_IS_MSP4200(revision)) {\r\nmips_machtype = MACH_MSP4200_FPGA;\r\n} else {\r\nmips_machtype = MACH_MSP_OTHER;\r\n}\r\nbreak;\r\ncase FAMILY_MSP4200:\r\n#if defined(CONFIG_PMC_MSP4200_EVAL)\r\nmips_machtype = MACH_MSP4200_EVAL;\r\n#elif defined(CONFIG_PMC_MSP4200_GW)\r\nmips_machtype = MACH_MSP4200_GW;\r\n#else\r\nmips_machtype = MACH_MSP_OTHER;\r\n#endif\r\nbreak;\r\ncase FAMILY_MSP4200_FPGA:\r\nmips_machtype = MACH_MSP4200_FPGA;\r\nbreak;\r\ncase FAMILY_MSP7100:\r\n#if defined(CONFIG_PMC_MSP7120_EVAL)\r\nmips_machtype = MACH_MSP7120_EVAL;\r\n#elif defined(CONFIG_PMC_MSP7120_GW)\r\nmips_machtype = MACH_MSP7120_GW;\r\n#else\r\nmips_machtype = MACH_MSP_OTHER;\r\n#endif\r\nbreak;\r\ncase FAMILY_MSP7100_FPGA:\r\nmips_machtype = MACH_MSP7120_FPGA;\r\nbreak;\r\ndefault:\r\nmips_machtype = MACH_UNKNOWN;\r\npanic("***Bogosity factor five***, exiting");\r\nbreak;\r\n}\r\nprom_init_cmdline();\r\nprom_meminit();\r\nmsp_serial_setup();\r\nregister_vsmp_smp_ops();\r\n}

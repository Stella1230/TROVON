static void disable_8259A_irq(struct irq_data *d)\r\n{\r\nunsigned int mask, irq = d->irq - I8259A_IRQ_BASE;\r\nunsigned long flags;\r\nmask = 1 << irq;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\ncached_irq_mask |= mask;\r\nif (irq & 8)\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nelse\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic void enable_8259A_irq(struct irq_data *d)\r\n{\r\nunsigned int mask, irq = d->irq - I8259A_IRQ_BASE;\r\nunsigned long flags;\r\nmask = ~(1 << irq);\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\ncached_irq_mask &= mask;\r\nif (irq & 8)\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nelse\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nint i8259A_irq_pending(unsigned int irq)\r\n{\r\nunsigned int mask;\r\nunsigned long flags;\r\nint ret;\r\nirq -= I8259A_IRQ_BASE;\r\nmask = 1 << irq;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\nif (irq < 8)\r\nret = inb(PIC_MASTER_CMD) & mask;\r\nelse\r\nret = inb(PIC_SLAVE_CMD) & (mask >> 8);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\nreturn ret;\r\n}\r\nvoid make_8259A_irq(unsigned int irq)\r\n{\r\ndisable_irq_nosync(irq);\r\nirq_set_chip_and_handler(irq, &i8259A_chip, handle_level_irq);\r\nenable_irq(irq);\r\n}\r\nstatic inline int i8259A_irq_real(unsigned int irq)\r\n{\r\nint value;\r\nint irqmask = 1 << irq;\r\nif (irq < 8) {\r\noutb(0x0B, PIC_MASTER_CMD);\r\nvalue = inb(PIC_MASTER_CMD) & irqmask;\r\noutb(0x0A, PIC_MASTER_CMD);\r\nreturn value;\r\n}\r\noutb(0x0B, PIC_SLAVE_CMD);\r\nvalue = inb(PIC_SLAVE_CMD) & (irqmask >> 8);\r\noutb(0x0A, PIC_SLAVE_CMD);\r\nreturn value;\r\n}\r\nstatic void mask_and_ack_8259A(struct irq_data *d)\r\n{\r\nunsigned int irqmask, irq = d->irq - I8259A_IRQ_BASE;\r\nunsigned long flags;\r\nirqmask = 1 << irq;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\nif (cached_irq_mask & irqmask)\r\ngoto spurious_8259A_irq;\r\ncached_irq_mask |= irqmask;\r\nhandle_real_irq:\r\nif (irq & 8) {\r\ninb(PIC_SLAVE_IMR);\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\noutb(0x60+(irq&7), PIC_SLAVE_CMD);\r\noutb(0x60+PIC_CASCADE_IR, PIC_MASTER_CMD);\r\n} else {\r\ninb(PIC_MASTER_IMR);\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\noutb(0x60+irq, PIC_MASTER_CMD);\r\n}\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\nreturn;\r\nspurious_8259A_irq:\r\nif (i8259A_irq_real(irq))\r\ngoto handle_real_irq;\r\n{\r\nstatic int spurious_irq_mask;\r\nif (!(spurious_irq_mask & irqmask)) {\r\nprintk(KERN_DEBUG "spurious 8259A interrupt: IRQ%d.\n", irq);\r\nspurious_irq_mask |= irqmask;\r\n}\r\natomic_inc(&irq_err_count);\r\ngoto handle_real_irq;\r\n}\r\n}\r\nstatic void i8259A_resume(void)\r\n{\r\nif (i8259A_auto_eoi >= 0)\r\ninit_8259A(i8259A_auto_eoi);\r\n}\r\nstatic void i8259A_shutdown(void)\r\n{\r\nif (i8259A_auto_eoi >= 0) {\r\noutb(0xff, PIC_MASTER_IMR);\r\noutb(0xff, PIC_SLAVE_IMR);\r\n}\r\n}\r\nstatic int __init i8259A_init_sysfs(void)\r\n{\r\nregister_syscore_ops(&i8259_syscore_ops);\r\nreturn 0;\r\n}\r\nstatic void init_8259A(int auto_eoi)\r\n{\r\nunsigned long flags;\r\ni8259A_auto_eoi = auto_eoi;\r\nraw_spin_lock_irqsave(&i8259A_lock, flags);\r\noutb(0xff, PIC_MASTER_IMR);\r\noutb(0xff, PIC_SLAVE_IMR);\r\noutb_p(0x11, PIC_MASTER_CMD);\r\noutb_p(I8259A_IRQ_BASE + 0, PIC_MASTER_IMR);\r\noutb_p(1U << PIC_CASCADE_IR, PIC_MASTER_IMR);\r\nif (auto_eoi)\r\noutb_p(MASTER_ICW4_DEFAULT | PIC_ICW4_AEOI, PIC_MASTER_IMR);\r\nelse\r\noutb_p(MASTER_ICW4_DEFAULT, PIC_MASTER_IMR);\r\noutb_p(0x11, PIC_SLAVE_CMD);\r\noutb_p(I8259A_IRQ_BASE + 8, PIC_SLAVE_IMR);\r\noutb_p(PIC_CASCADE_IR, PIC_SLAVE_IMR);\r\noutb_p(SLAVE_ICW4_DEFAULT, PIC_SLAVE_IMR);\r\nif (auto_eoi)\r\ni8259A_chip.irq_mask_ack = disable_8259A_irq;\r\nelse\r\ni8259A_chip.irq_mask_ack = mask_and_ack_8259A;\r\nudelay(100);\r\noutb(cached_master_mask, PIC_MASTER_IMR);\r\noutb(cached_slave_mask, PIC_SLAVE_IMR);\r\nraw_spin_unlock_irqrestore(&i8259A_lock, flags);\r\n}\r\nstatic int i8259A_irq_domain_map(struct irq_domain *d, unsigned int virq,\r\nirq_hw_number_t hw)\r\n{\r\nirq_set_chip_and_handler(virq, &i8259A_chip, handle_level_irq);\r\nirq_set_probe(virq);\r\nreturn 0;\r\n}\r\nstruct irq_domain * __init __init_i8259_irqs(struct device_node *node)\r\n{\r\nstruct irq_domain *domain;\r\ninsert_resource(&ioport_resource, &pic1_io_resource);\r\ninsert_resource(&ioport_resource, &pic2_io_resource);\r\ninit_8259A(0);\r\ndomain = irq_domain_add_legacy(node, 16, I8259A_IRQ_BASE, 0,\r\n&i8259A_ops, NULL);\r\nif (!domain)\r\npanic("Failed to add i8259 IRQ domain");\r\nsetup_irq(I8259A_IRQ_BASE + PIC_CASCADE_IR, &irq2);\r\nreturn domain;\r\n}\r\nvoid __init init_i8259_irqs(void)\r\n{\r\n__init_i8259_irqs(NULL);\r\n}\r\nstatic void i8259_irq_dispatch(struct irq_desc *desc)\r\n{\r\nstruct irq_domain *domain = irq_desc_get_handler_data(desc);\r\nint hwirq = i8259_irq();\r\nunsigned int irq;\r\nif (hwirq < 0)\r\nreturn;\r\nirq = irq_linear_revmap(domain, hwirq);\r\ngeneric_handle_irq(irq);\r\n}\r\nint __init i8259_of_init(struct device_node *node, struct device_node *parent)\r\n{\r\nstruct irq_domain *domain;\r\nunsigned int parent_irq;\r\nparent_irq = irq_of_parse_and_map(node, 0);\r\nif (!parent_irq) {\r\npr_err("Failed to map i8259 parent IRQ\n");\r\nreturn -ENODEV;\r\n}\r\ndomain = __init_i8259_irqs(node);\r\nirq_set_chained_handler_and_data(parent_irq, i8259_irq_dispatch,\r\ndomain);\r\nreturn 0;\r\n}

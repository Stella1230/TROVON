static int __init scu_a9_enable(void)\r\n{\r\nunsigned long config_base;\r\nvoid __iomem *scu_base;\r\nunsigned int i, ncores;\r\nif (!scu_a9_has_base()) {\r\npr_err("no configuration base address register!\n");\r\nreturn -ENXIO;\r\n}\r\nconfig_base = scu_a9_get_base();\r\nif (!config_base) {\r\npr_err("hardware reports only one core\n");\r\nreturn -ENOENT;\r\n}\r\nscu_base = ioremap((phys_addr_t)config_base, CORTEX_A9_SCU_SIZE);\r\nif (!scu_base) {\r\npr_err("failed to remap config base (%lu/%u) for SCU\n",\r\nconfig_base, CORTEX_A9_SCU_SIZE);\r\nreturn -ENOMEM;\r\n}\r\nscu_enable(scu_base);\r\nncores = scu_base ? scu_get_core_count(scu_base) : 1;\r\nif (ncores > nr_cpu_ids) {\r\npr_warn("SMP: %u cores greater than maximum (%u), clipping\n",\r\nncores, nr_cpu_ids);\r\nncores = nr_cpu_ids;\r\n}\r\n#ifdef CONFIG_VFP\r\nif (ncores > 1) {\r\npr_warn("SMP: secondary CPUs lack VFP unit, disabling VFP\n");\r\nvfp_disable();\r\n#ifdef CONFIG_KERNEL_MODE_NEON\r\nWARN(1, "SMP: kernel-mode NEON enabled, restricting to UP\n");\r\nncores = 1;\r\n#endif\r\n}\r\n#endif\r\nfor (i = 0; i < ncores; i++)\r\nset_cpu_possible(i, true);\r\niounmap(scu_base);\r\nreturn 0;\r\n}\r\nstatic int bcm63138_smp_boot_secondary(unsigned int cpu,\r\nstruct task_struct *idle)\r\n{\r\nvoid __iomem *bootlut_base;\r\nstruct device_node *dn;\r\nint ret = 0;\r\nu32 val;\r\ndn = of_find_matching_node(NULL, bcm63138_bootlut_ids);\r\nif (!dn) {\r\npr_err("SMP: unable to find bcm63138 boot LUT node\n");\r\nreturn -ENODEV;\r\n}\r\nbootlut_base = of_iomap(dn, 0);\r\nof_node_put(dn);\r\nif (!bootlut_base) {\r\npr_err("SMP: unable to remap boot LUT base register\n");\r\nreturn -ENOMEM;\r\n}\r\ndn = of_get_cpu_node(cpu, NULL);\r\nif (!dn) {\r\npr_err("SMP: failed to locate secondary CPU%d node\n", cpu);\r\nret = -ENODEV;\r\ngoto out;\r\n}\r\nval = virt_to_phys(secondary_startup);\r\nwritel_relaxed(val, bootlut_base + BOOTLUT_RESET_VECT);\r\nret = bcm63xx_pmb_power_on_cpu(dn);\r\nif (ret)\r\ngoto out;\r\nout:\r\niounmap(bootlut_base);\r\nreturn ret;\r\n}\r\nstatic void __init bcm63138_smp_prepare_cpus(unsigned int max_cpus)\r\n{\r\nint ret;\r\nret = scu_a9_enable();\r\nif (ret) {\r\npr_warn("SMP: Cortex-A9 SCU setup failed\n");\r\nreturn;\r\n}\r\n}

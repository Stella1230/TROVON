static int siu_pcm_stmwrite_stop(struct siu_port *port_info)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nu32 __iomem *base = info->reg;\r\nstruct siu_stream *siu_stream = &port_info->playback;\r\nu32 stfifo;\r\nif (!siu_stream->rw_flg)\r\nreturn -EPERM;\r\nstfifo = siu_read32(base + SIU_STFIFO);\r\nsiu_write32(base + SIU_STFIFO, stfifo & ~0x0c180c18);\r\npr_debug("%s: STFIFO %x -> %x\n", __func__,\r\nstfifo, stfifo & ~0x0c180c18);\r\nsiu_stream->rw_flg = 0;\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_stmwrite_start(struct siu_port *port_info)\r\n{\r\nstruct siu_stream *siu_stream = &port_info->playback;\r\nif (siu_stream->rw_flg)\r\nreturn -EPERM;\r\nport_info->playback.cur_period = 0;\r\nsiu_stream->rw_flg = RWF_STM_WT;\r\ntasklet_schedule(&siu_stream->tasklet);\r\nreturn 0;\r\n}\r\nstatic void siu_dma_tx_complete(void *arg)\r\n{\r\nstruct siu_stream *siu_stream = arg;\r\nif (!siu_stream->rw_flg)\r\nreturn;\r\nif (++siu_stream->cur_period >=\r\nGET_MAX_PERIODS(siu_stream->buf_bytes,\r\nsiu_stream->period_bytes))\r\nsiu_stream->cur_period = 0;\r\npr_debug("%s: done period #%d (%u/%u bytes), cookie %d\n",\r\n__func__, siu_stream->cur_period,\r\nsiu_stream->cur_period * siu_stream->period_bytes,\r\nsiu_stream->buf_bytes, siu_stream->cookie);\r\ntasklet_schedule(&siu_stream->tasklet);\r\nsnd_pcm_period_elapsed(siu_stream->substream);\r\n}\r\nstatic int siu_pcm_wr_set(struct siu_port *port_info,\r\ndma_addr_t buff, u32 size)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nu32 __iomem *base = info->reg;\r\nstruct siu_stream *siu_stream = &port_info->playback;\r\nstruct snd_pcm_substream *substream = siu_stream->substream;\r\nstruct device *dev = substream->pcm->card->dev;\r\nstruct dma_async_tx_descriptor *desc;\r\ndma_cookie_t cookie;\r\nstruct scatterlist sg;\r\nu32 stfifo;\r\nsg_init_table(&sg, 1);\r\nsg_set_page(&sg, pfn_to_page(PFN_DOWN(buff)),\r\nsize, offset_in_page(buff));\r\nsg_dma_len(&sg) = size;\r\nsg_dma_address(&sg) = buff;\r\ndesc = dmaengine_prep_slave_sg(siu_stream->chan,\r\n&sg, 1, DMA_MEM_TO_DEV, DMA_PREP_INTERRUPT | DMA_CTRL_ACK);\r\nif (!desc) {\r\ndev_err(dev, "Failed to allocate a dma descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\ndesc->callback = siu_dma_tx_complete;\r\ndesc->callback_param = siu_stream;\r\ncookie = dmaengine_submit(desc);\r\nif (cookie < 0) {\r\ndev_err(dev, "Failed to submit a dma transfer\n");\r\nreturn cookie;\r\n}\r\nsiu_stream->tx_desc = desc;\r\nsiu_stream->cookie = cookie;\r\ndma_async_issue_pending(siu_stream->chan);\r\nstfifo = siu_read32(base + SIU_STFIFO);\r\nsiu_write32(base + SIU_STFIFO, stfifo | (port_info->stfifo & 0x0c180c18));\r\ndev_dbg(dev, "%s: STFIFO %x -> %x\n", __func__,\r\nstfifo, stfifo | (port_info->stfifo & 0x0c180c18));\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_rd_set(struct siu_port *port_info,\r\ndma_addr_t buff, size_t size)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nu32 __iomem *base = info->reg;\r\nstruct siu_stream *siu_stream = &port_info->capture;\r\nstruct snd_pcm_substream *substream = siu_stream->substream;\r\nstruct device *dev = substream->pcm->card->dev;\r\nstruct dma_async_tx_descriptor *desc;\r\ndma_cookie_t cookie;\r\nstruct scatterlist sg;\r\nu32 stfifo;\r\ndev_dbg(dev, "%s: %u@%llx\n", __func__, size, (unsigned long long)buff);\r\nsg_init_table(&sg, 1);\r\nsg_set_page(&sg, pfn_to_page(PFN_DOWN(buff)),\r\nsize, offset_in_page(buff));\r\nsg_dma_len(&sg) = size;\r\nsg_dma_address(&sg) = buff;\r\ndesc = dmaengine_prep_slave_sg(siu_stream->chan,\r\n&sg, 1, DMA_DEV_TO_MEM, DMA_PREP_INTERRUPT | DMA_CTRL_ACK);\r\nif (!desc) {\r\ndev_err(dev, "Failed to allocate dma descriptor\n");\r\nreturn -ENOMEM;\r\n}\r\ndesc->callback = siu_dma_tx_complete;\r\ndesc->callback_param = siu_stream;\r\ncookie = dmaengine_submit(desc);\r\nif (cookie < 0) {\r\ndev_err(dev, "Failed to submit dma descriptor\n");\r\nreturn cookie;\r\n}\r\nsiu_stream->tx_desc = desc;\r\nsiu_stream->cookie = cookie;\r\ndma_async_issue_pending(siu_stream->chan);\r\nstfifo = siu_read32(base + SIU_STFIFO);\r\nsiu_write32(base + SIU_STFIFO, siu_read32(base + SIU_STFIFO) |\r\n(port_info->stfifo & 0x13071307));\r\ndev_dbg(dev, "%s: STFIFO %x -> %x\n", __func__,\r\nstfifo, stfifo | (port_info->stfifo & 0x13071307));\r\nreturn 0;\r\n}\r\nstatic void siu_io_tasklet(unsigned long data)\r\n{\r\nstruct siu_stream *siu_stream = (struct siu_stream *)data;\r\nstruct snd_pcm_substream *substream = siu_stream->substream;\r\nstruct device *dev = substream->pcm->card->dev;\r\nstruct snd_pcm_runtime *rt = substream->runtime;\r\nstruct siu_port *port_info = siu_port_info(substream);\r\ndev_dbg(dev, "%s: flags %x\n", __func__, siu_stream->rw_flg);\r\nif (!siu_stream->rw_flg) {\r\ndev_dbg(dev, "%s: stream inactive\n", __func__);\r\nreturn;\r\n}\r\nif (substream->stream == SNDRV_PCM_STREAM_CAPTURE) {\r\ndma_addr_t buff;\r\nsize_t count;\r\nu8 *virt;\r\nbuff = (dma_addr_t)PERIOD_OFFSET(rt->dma_addr,\r\nsiu_stream->cur_period,\r\nsiu_stream->period_bytes);\r\nvirt = PERIOD_OFFSET(rt->dma_area,\r\nsiu_stream->cur_period,\r\nsiu_stream->period_bytes);\r\ncount = siu_stream->period_bytes;\r\nsiu_pcm_rd_set(port_info, buff, count);\r\n} else {\r\nsiu_pcm_wr_set(port_info,\r\n(dma_addr_t)PERIOD_OFFSET(rt->dma_addr,\r\nsiu_stream->cur_period,\r\nsiu_stream->period_bytes),\r\nsiu_stream->period_bytes);\r\n}\r\n}\r\nstatic int siu_pcm_stmread_start(struct siu_port *port_info)\r\n{\r\nstruct siu_stream *siu_stream = &port_info->capture;\r\nif (siu_stream->xfer_cnt > 0x1000000)\r\nreturn -EINVAL;\r\nif (siu_stream->rw_flg)\r\nreturn -EPERM;\r\nsiu_stream->cur_period = 0;\r\nsiu_stream->rw_flg = RWF_STM_RD;\r\ntasklet_schedule(&siu_stream->tasklet);\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_stmread_stop(struct siu_port *port_info)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nu32 __iomem *base = info->reg;\r\nstruct siu_stream *siu_stream = &port_info->capture;\r\nstruct device *dev = siu_stream->substream->pcm->card->dev;\r\nu32 stfifo;\r\nif (!siu_stream->rw_flg)\r\nreturn -EPERM;\r\nstfifo = siu_read32(base + SIU_STFIFO);\r\nsiu_write32(base + SIU_STFIFO, stfifo & ~0x13071307);\r\ndev_dbg(dev, "%s: STFIFO %x -> %x\n", __func__,\r\nstfifo, stfifo & ~0x13071307);\r\nsiu_stream->rw_flg = 0;\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_hw_params(struct snd_pcm_substream *ss,\r\nstruct snd_pcm_hw_params *hw_params)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct device *dev = ss->pcm->card->dev;\r\nint ret;\r\ndev_dbg(dev, "%s: port=%d\n", __func__, info->port_id);\r\nret = snd_pcm_lib_malloc_pages(ss, params_buffer_bytes(hw_params));\r\nif (ret < 0)\r\ndev_err(dev, "snd_pcm_lib_malloc_pages() failed\n");\r\nreturn ret;\r\n}\r\nstatic int siu_pcm_hw_free(struct snd_pcm_substream *ss)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct siu_port *port_info = siu_port_info(ss);\r\nstruct device *dev = ss->pcm->card->dev;\r\nstruct siu_stream *siu_stream;\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsiu_stream = &port_info->playback;\r\nelse\r\nsiu_stream = &port_info->capture;\r\ndev_dbg(dev, "%s: port=%d\n", __func__, info->port_id);\r\nreturn snd_pcm_lib_free_pages(ss);\r\n}\r\nstatic bool filter(struct dma_chan *chan, void *slave)\r\n{\r\nstruct sh_dmae_slave *param = slave;\r\npr_debug("%s: slave ID %d\n", __func__, param->shdma_slave.slave_id);\r\nchan->private = &param->shdma_slave;\r\nreturn true;\r\n}\r\nstatic int siu_pcm_open(struct snd_pcm_substream *ss)\r\n{\r\nstruct snd_soc_pcm_runtime *rtd = ss->private_data;\r\nstruct siu_platform *pdata = rtd->platform->dev->platform_data;\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct siu_port *port_info = siu_port_info(ss);\r\nstruct siu_stream *siu_stream;\r\nu32 port = info->port_id;\r\nstruct device *dev = ss->pcm->card->dev;\r\ndma_cap_mask_t mask;\r\nstruct sh_dmae_slave *param;\r\ndma_cap_zero(mask);\r\ndma_cap_set(DMA_SLAVE, mask);\r\ndev_dbg(dev, "%s, port=%d@%p\n", __func__, port, port_info);\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK) {\r\nsiu_stream = &port_info->playback;\r\nparam = &siu_stream->param;\r\nparam->shdma_slave.slave_id = port ? pdata->dma_slave_tx_b :\r\npdata->dma_slave_tx_a;\r\n} else {\r\nsiu_stream = &port_info->capture;\r\nparam = &siu_stream->param;\r\nparam->shdma_slave.slave_id = port ? pdata->dma_slave_rx_b :\r\npdata->dma_slave_rx_a;\r\n}\r\nsiu_stream->chan = dma_request_channel(mask, filter, param);\r\nif (!siu_stream->chan) {\r\ndev_err(dev, "DMA channel allocation failed!\n");\r\nreturn -EBUSY;\r\n}\r\nsiu_stream->substream = ss;\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_close(struct snd_pcm_substream *ss)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct device *dev = ss->pcm->card->dev;\r\nstruct siu_port *port_info = siu_port_info(ss);\r\nstruct siu_stream *siu_stream;\r\ndev_dbg(dev, "%s: port=%d\n", __func__, info->port_id);\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsiu_stream = &port_info->playback;\r\nelse\r\nsiu_stream = &port_info->capture;\r\ndma_release_channel(siu_stream->chan);\r\nsiu_stream->chan = NULL;\r\nsiu_stream->substream = NULL;\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_prepare(struct snd_pcm_substream *ss)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct siu_port *port_info = siu_port_info(ss);\r\nstruct device *dev = ss->pcm->card->dev;\r\nstruct snd_pcm_runtime *rt = ss->runtime;\r\nstruct siu_stream *siu_stream;\r\nsnd_pcm_sframes_t xfer_cnt;\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsiu_stream = &port_info->playback;\r\nelse\r\nsiu_stream = &port_info->capture;\r\nrt = siu_stream->substream->runtime;\r\nsiu_stream->buf_bytes = snd_pcm_lib_buffer_bytes(ss);\r\nsiu_stream->period_bytes = snd_pcm_lib_period_bytes(ss);\r\ndev_dbg(dev, "%s: port=%d, %d channels, period=%u bytes\n", __func__,\r\ninfo->port_id, rt->channels, siu_stream->period_bytes);\r\nif (siu_stream->buf_bytes % siu_stream->period_bytes) {\r\ndev_err(dev, "%s() - buffer=%d not multiple of period=%d\n",\r\n__func__, siu_stream->buf_bytes,\r\nsiu_stream->period_bytes);\r\nreturn -EINVAL;\r\n}\r\nxfer_cnt = bytes_to_frames(rt, siu_stream->period_bytes);\r\nif (!xfer_cnt || xfer_cnt > 0x1000000)\r\nreturn -EINVAL;\r\nsiu_stream->format = rt->format;\r\nsiu_stream->xfer_cnt = xfer_cnt;\r\ndev_dbg(dev, "port=%d buf=%lx buf_bytes=%d period_bytes=%d "\r\n"format=%d channels=%d xfer_cnt=%d\n", info->port_id,\r\n(unsigned long)rt->dma_addr, siu_stream->buf_bytes,\r\nsiu_stream->period_bytes,\r\nsiu_stream->format, rt->channels, (int)xfer_cnt);\r\nreturn 0;\r\n}\r\nstatic int siu_pcm_trigger(struct snd_pcm_substream *ss, int cmd)\r\n{\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct device *dev = ss->pcm->card->dev;\r\nstruct siu_port *port_info = siu_port_info(ss);\r\nint ret;\r\ndev_dbg(dev, "%s: port=%d@%p, cmd=%d\n", __func__,\r\ninfo->port_id, port_info, cmd);\r\nswitch (cmd) {\r\ncase SNDRV_PCM_TRIGGER_START:\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nret = siu_pcm_stmwrite_start(port_info);\r\nelse\r\nret = siu_pcm_stmread_start(port_info);\r\nif (ret < 0)\r\ndev_warn(dev, "%s: start failed on port=%d\n",\r\n__func__, info->port_id);\r\nbreak;\r\ncase SNDRV_PCM_TRIGGER_STOP:\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsiu_pcm_stmwrite_stop(port_info);\r\nelse\r\nsiu_pcm_stmread_stop(port_info);\r\nret = 0;\r\nbreak;\r\ndefault:\r\ndev_err(dev, "%s() unsupported cmd=%d\n", __func__, cmd);\r\nret = -EINVAL;\r\n}\r\nreturn ret;\r\n}\r\nstatic snd_pcm_uframes_t siu_pcm_pointer_dma(struct snd_pcm_substream *ss)\r\n{\r\nstruct device *dev = ss->pcm->card->dev;\r\nstruct siu_info *info = siu_i2s_data;\r\nu32 __iomem *base = info->reg;\r\nstruct siu_port *port_info = siu_port_info(ss);\r\nstruct snd_pcm_runtime *rt = ss->runtime;\r\nsize_t ptr;\r\nstruct siu_stream *siu_stream;\r\nif (ss->stream == SNDRV_PCM_STREAM_PLAYBACK)\r\nsiu_stream = &port_info->playback;\r\nelse\r\nsiu_stream = &port_info->capture;\r\nptr = PERIOD_OFFSET(rt->dma_addr,\r\nsiu_stream->cur_period,\r\nsiu_stream->period_bytes) - rt->dma_addr;\r\ndev_dbg(dev,\r\n"%s: port=%d, events %x, FSTS %x, xferred %u/%u, cookie %d\n",\r\n__func__, info->port_id, siu_read32(base + SIU_EVNTC),\r\nsiu_read32(base + SIU_SBFSTS), ptr, siu_stream->buf_bytes,\r\nsiu_stream->cookie);\r\nif (ptr >= siu_stream->buf_bytes)\r\nptr = 0;\r\nreturn bytes_to_frames(ss->runtime, ptr);\r\n}\r\nstatic int siu_pcm_new(struct snd_soc_pcm_runtime *rtd)\r\n{\r\nstruct snd_card *card = rtd->card->snd_card;\r\nstruct snd_pcm *pcm = rtd->pcm;\r\nstruct siu_info *info = siu_i2s_data;\r\nstruct platform_device *pdev = to_platform_device(card->dev);\r\nint ret;\r\nint i;\r\nif (pdev->id < 0 || pdev->id >= SIU_PORT_NUM)\r\nreturn -EINVAL;\r\ninfo->port_id = pdev->id;\r\nfor (i = pdev->id; i < pdev->id + 1; i++) {\r\nstruct siu_port **port_info = &siu_ports[i];\r\nret = siu_init_port(i, port_info, card);\r\nif (ret < 0)\r\nreturn ret;\r\nret = snd_pcm_lib_preallocate_pages_for_all(pcm,\r\nSNDRV_DMA_TYPE_DEV, NULL,\r\nSIU_BUFFER_BYTES_MAX, SIU_BUFFER_BYTES_MAX);\r\nif (ret < 0) {\r\ndev_err(card->dev,\r\n"snd_pcm_lib_preallocate_pages_for_all() err=%d",\r\nret);\r\ngoto fail;\r\n}\r\n(*port_info)->pcm = pcm;\r\ntasklet_init(&(*port_info)->playback.tasklet, siu_io_tasklet,\r\n(unsigned long)&(*port_info)->playback);\r\ntasklet_init(&(*port_info)->capture.tasklet, siu_io_tasklet,\r\n(unsigned long)&(*port_info)->capture);\r\n}\r\ndev_info(card->dev, "SuperH SIU driver initialized.\n");\r\nreturn 0;\r\nfail:\r\nsiu_free_port(siu_ports[pdev->id]);\r\ndev_err(card->dev, "SIU: failed to initialize.\n");\r\nreturn ret;\r\n}\r\nstatic void siu_pcm_free(struct snd_pcm *pcm)\r\n{\r\nstruct platform_device *pdev = to_platform_device(pcm->card->dev);\r\nstruct siu_port *port_info = siu_ports[pdev->id];\r\ntasklet_kill(&port_info->capture.tasklet);\r\ntasklet_kill(&port_info->playback.tasklet);\r\nsiu_free_port(port_info);\r\ndev_dbg(pcm->card->dev, "%s\n", __func__);\r\n}

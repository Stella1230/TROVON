static void read_bitstream(char *bitdata, char *buf, int *offset, int rdsize)\r\n{\r\nmemcpy(buf, bitdata + *offset, rdsize);\r\n*offset += rdsize;\r\n}\r\nstatic void readinfo_bitstream(char *bitdata, char *buf, int *offset)\r\n{\r\nchar tbuf[64];\r\ns32 len;\r\nread_bitstream(bitdata, tbuf, offset, 1);\r\nread_bitstream(bitdata, tbuf, offset, 2);\r\nlen = tbuf[0] << 8 | tbuf[1];\r\nread_bitstream(bitdata, buf, offset, len);\r\nbuf[len] = '\0';\r\n}\r\nstatic int readlength_bitstream(char *bitdata, int *lendata, int *offset)\r\n{\r\nchar tbuf[64];\r\nread_bitstream(bitdata, tbuf, offset, 1);\r\nif (tbuf[0] != 'e') {\r\npr_err("error: length section is not 'e', but %c\n", tbuf[0]);\r\nreturn -1;\r\n}\r\nread_bitstream(bitdata, tbuf, offset, 4);\r\n*lendata = tbuf[0] << 24 | tbuf[1] << 16 |\r\ntbuf[2] << 8 | tbuf[3];\r\nreturn 0;\r\n}\r\nstatic int readmagic_bitstream(char *bitdata, int *offset)\r\n{\r\nchar buf[13];\r\nint r;\r\nread_bitstream(bitdata, buf, offset, 13);\r\nr = memcmp(buf, bits_magic, 13);\r\nif (r) {\r\npr_err("error: corrupted header");\r\nreturn -1;\r\n}\r\npr_info("bitstream file magic number Ok\n");\r\n*offset = 13;\r\nreturn 0;\r\n}\r\nstatic enum fmt_image get_imageformat(struct fpgaimage *fimage)\r\n{\r\nreturn f_bit;\r\n}\r\nstatic void gs_print_header(struct fpgaimage *fimage)\r\n{\r\npr_info("file: %s\n", fimage->filename);\r\npr_info("part: %s\n", fimage->part);\r\npr_info("date: %s\n", fimage->date);\r\npr_info("time: %s\n", fimage->time);\r\npr_info("lendata: %d\n", fimage->lendata);\r\n}\r\nstatic void gs_read_bitstream(struct fpgaimage *fimage)\r\n{\r\nchar *bitdata;\r\nint offset;\r\noffset = 0;\r\nbitdata = (char *)fimage->fw_entry->data;\r\nreadmagic_bitstream(bitdata, &offset);\r\nreadinfo_bitstream(bitdata, fimage->filename, &offset);\r\nreadinfo_bitstream(bitdata, fimage->part, &offset);\r\nreadinfo_bitstream(bitdata, fimage->date, &offset);\r\nreadinfo_bitstream(bitdata, fimage->time, &offset);\r\nreadlength_bitstream(bitdata, &fimage->lendata, &offset);\r\nfimage->fpgadata = bitdata + offset;\r\n}\r\nstatic int gs_read_image(struct fpgaimage *fimage)\r\n{\r\nint img_fmt;\r\nimg_fmt = get_imageformat(fimage);\r\nswitch (img_fmt) {\r\ncase f_bit:\r\npr_info("image is bitstream format\n");\r\ngs_read_bitstream(fimage);\r\nbreak;\r\ndefault:\r\npr_err("unsupported fpga image format\n");\r\nreturn -1;\r\n}\r\ngs_print_header(fimage);\r\nreturn 0;\r\n}\r\nstatic int gs_load_image(struct fpgaimage *fimage, char *fw_file)\r\n{\r\nint err;\r\npr_info("load fpgaimage %s\n", fw_file);\r\nerr = request_firmware(&fimage->fw_entry, fw_file, &firmware_pdev->dev);\r\nif (err != 0) {\r\npr_err("firmware %s is missing, cannot continue.\n", fw_file);\r\nreturn err;\r\n}\r\nreturn 0;\r\n}\r\nstatic int gs_download_image(struct fpgaimage *fimage, enum wbus bus_bytes)\r\n{\r\nchar *bitdata;\r\nint size, i, cnt;\r\ncnt = 0;\r\nbitdata = (char *)fimage->fpgadata;\r\nsize = fimage->lendata;\r\n#ifdef DEBUG_FPGA\r\nprint_hex_dump_bytes("bitfile sample: ", DUMP_PREFIX_OFFSET,\r\nbitdata, 0x100);\r\n#endif\r\nif (!xl_supported_prog_bus_width(bus_bytes)) {\r\npr_err("unsupported program bus width %d\n",\r\nbus_bytes);\r\nreturn -1;\r\n}\r\nxl_program_b(1);\r\nxl_rdwr_b(0);\r\nxl_csi_b(0);\r\nxl_program_b(0);\r\nmsleep(20);\r\nxl_program_b(1);\r\nwhile (xl_get_init_b() == 0)\r\n;\r\npr_info("device init done\n");\r\nfor (i = 0; i < size; i += bus_bytes)\r\nxl_shift_bytes_out(bus_bytes, bitdata + i);\r\npr_info("program done\n");\r\nif (xl_get_init_b() == 0) {\r\npr_err("init_b 0\n");\r\nreturn -1;\r\n}\r\nwhile (xl_get_done_b() == 0) {\r\nif (cnt++ > MAX_WAIT_DONE) {\r\npr_err("init_B %d\n", xl_get_init_b());\r\nbreak;\r\n}\r\n}\r\nif (cnt > MAX_WAIT_DONE) {\r\npr_err("fpga download fail\n");\r\nreturn -1;\r\n}\r\npr_info("download fpgaimage\n");\r\nxl_shift_cclk(8);\r\nreturn 0;\r\n}\r\nstatic int gs_release_image(struct fpgaimage *fimage)\r\n{\r\nrelease_firmware(fimage->fw_entry);\r\npr_info("release fpgaimage\n");\r\nreturn 0;\r\n}\r\nstatic int gs_set_download_method(struct fpgaimage *fimage)\r\n{\r\npr_info("set program method\n");\r\nfimage->dmethod = m_systemmap;\r\npr_info("systemmap program method\n");\r\nreturn 0;\r\n}\r\nstatic int init_driver(void)\r\n{\r\nfirmware_pdev = platform_device_register_simple("fpgaboot", -1,\r\nNULL, 0);\r\nreturn PTR_ERR_OR_ZERO(firmware_pdev);\r\n}\r\nstatic int gs_fpgaboot(void)\r\n{\r\nint err;\r\nstruct fpgaimage *fimage;\r\nfimage = kmalloc(sizeof(*fimage), GFP_KERNEL);\r\nif (!fimage)\r\nreturn -ENOMEM;\r\nerr = gs_load_image(fimage, file);\r\nif (err) {\r\npr_err("gs_load_image error\n");\r\ngoto err_out1;\r\n}\r\nerr = gs_read_image(fimage);\r\nif (err) {\r\npr_err("gs_read_image error\n");\r\ngoto err_out2;\r\n}\r\nerr = gs_set_download_method(fimage);\r\nif (err) {\r\npr_err("gs_set_download_method error\n");\r\ngoto err_out2;\r\n}\r\nerr = gs_download_image(fimage, bus_2byte);\r\nif (err) {\r\npr_err("gs_download_image error\n");\r\ngoto err_out2;\r\n}\r\nerr = gs_release_image(fimage);\r\nif (err) {\r\npr_err("gs_release_image error\n");\r\ngoto err_out1;\r\n}\r\nkfree(fimage);\r\nreturn 0;\r\nerr_out2:\r\nerr = gs_release_image(fimage);\r\nif (err)\r\npr_err("gs_release_image error\n");\r\nerr_out1:\r\nkfree(fimage);\r\nreturn -1;\r\n}\r\nstatic int __init gs_fpgaboot_init(void)\r\n{\r\nint err;\r\npr_info("FPGA DOWNLOAD --->\n");\r\npr_info("FPGA image file name: %s\n", file);\r\nerr = init_driver();\r\nif (err) {\r\npr_err("FPGA DRIVER INIT FAIL!!\n");\r\nreturn err;\r\n}\r\nerr = xl_init_io();\r\nif (err) {\r\npr_err("GPIO INIT FAIL!!\n");\r\ngoto errout;\r\n}\r\nerr = gs_fpgaboot();\r\nif (err) {\r\npr_err("FPGA DOWNLOAD FAIL!!\n");\r\ngoto errout;\r\n}\r\npr_info("FPGA DOWNLOAD DONE <---\n");\r\nreturn 0;\r\nerrout:\r\nplatform_device_unregister(firmware_pdev);\r\nreturn err;\r\n}\r\nstatic void __exit gs_fpgaboot_exit(void)\r\n{\r\nplatform_device_unregister(firmware_pdev);\r\npr_info("FPGA image download module removed\n");\r\n}

static int sha1_init(struct shash_desc *desc)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nsctx->state[0] = SHA1_H0;\r\nsctx->state[1] = SHA1_H1;\r\nsctx->state[2] = SHA1_H2;\r\nsctx->state[3] = SHA1_H3;\r\nsctx->state[4] = SHA1_H4;\r\nsctx->count = 0;\r\nsctx->func = CPACF_KIMD_SHA_1;\r\nreturn 0;\r\n}\r\nstatic int sha1_export(struct shash_desc *desc, void *out)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nstruct sha1_state *octx = out;\r\noctx->count = sctx->count;\r\nmemcpy(octx->state, sctx->state, sizeof(octx->state));\r\nmemcpy(octx->buffer, sctx->buf, sizeof(octx->buffer));\r\nreturn 0;\r\n}\r\nstatic int sha1_import(struct shash_desc *desc, const void *in)\r\n{\r\nstruct s390_sha_ctx *sctx = shash_desc_ctx(desc);\r\nconst struct sha1_state *ictx = in;\r\nsctx->count = ictx->count;\r\nmemcpy(sctx->state, ictx->state, sizeof(ictx->state));\r\nmemcpy(sctx->buf, ictx->buffer, sizeof(ictx->buffer));\r\nsctx->func = CPACF_KIMD_SHA_1;\r\nreturn 0;\r\n}\r\nstatic int __init sha1_s390_init(void)\r\n{\r\nif (!cpacf_query(CPACF_KIMD, CPACF_KIMD_SHA_1))\r\nreturn -EOPNOTSUPP;\r\nreturn crypto_register_shash(&alg);\r\n}\r\nstatic void __exit sha1_s390_fini(void)\r\n{\r\ncrypto_unregister_shash(&alg);\r\n}

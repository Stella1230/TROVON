static void bcm7038_wdt_set_timeout_reg(struct watchdog_device *wdog)\r\n{\r\nstruct bcm7038_watchdog *wdt = watchdog_get_drvdata(wdog);\r\nu32 timeout;\r\ntimeout = wdt->rate * wdog->timeout;\r\nwritel(timeout, wdt->base + WDT_TIMEOUT_REG);\r\n}\r\nstatic int bcm7038_wdt_ping(struct watchdog_device *wdog)\r\n{\r\nstruct bcm7038_watchdog *wdt = watchdog_get_drvdata(wdog);\r\nwritel(WDT_START_1, wdt->base + WDT_CMD_REG);\r\nwritel(WDT_START_2, wdt->base + WDT_CMD_REG);\r\nreturn 0;\r\n}\r\nstatic int bcm7038_wdt_start(struct watchdog_device *wdog)\r\n{\r\nbcm7038_wdt_set_timeout_reg(wdog);\r\nbcm7038_wdt_ping(wdog);\r\nreturn 0;\r\n}\r\nstatic int bcm7038_wdt_stop(struct watchdog_device *wdog)\r\n{\r\nstruct bcm7038_watchdog *wdt = watchdog_get_drvdata(wdog);\r\nwritel(WDT_STOP_1, wdt->base + WDT_CMD_REG);\r\nwritel(WDT_STOP_2, wdt->base + WDT_CMD_REG);\r\nreturn 0;\r\n}\r\nstatic int bcm7038_wdt_set_timeout(struct watchdog_device *wdog,\r\nunsigned int t)\r\n{\r\nbcm7038_wdt_stop(wdog);\r\nwdog->timeout = t;\r\nbcm7038_wdt_start(wdog);\r\nreturn 0;\r\n}\r\nstatic unsigned int bcm7038_wdt_get_timeleft(struct watchdog_device *wdog)\r\n{\r\nstruct bcm7038_watchdog *wdt = watchdog_get_drvdata(wdog);\r\nu32 time_left;\r\ntime_left = readl(wdt->base + WDT_CMD_REG);\r\nreturn time_left / wdt->rate;\r\n}\r\nstatic int bcm7038_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct device *dev = &pdev->dev;\r\nstruct bcm7038_watchdog *wdt;\r\nstruct resource *res;\r\nint err;\r\nwdt = devm_kzalloc(dev, sizeof(*wdt), GFP_KERNEL);\r\nif (!wdt)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, wdt);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nwdt->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(wdt->base))\r\nreturn PTR_ERR(wdt->base);\r\nwdt->clk = devm_clk_get(dev, NULL);\r\nif (!IS_ERR(wdt->clk)) {\r\nclk_prepare_enable(wdt->clk);\r\nwdt->rate = clk_get_rate(wdt->clk);\r\nif (!wdt->rate)\r\nwdt->rate = WDT_DEFAULT_RATE;\r\n} else {\r\nwdt->rate = WDT_DEFAULT_RATE;\r\nwdt->clk = NULL;\r\n}\r\nwdt->wdd.info = &bcm7038_wdt_info;\r\nwdt->wdd.ops = &bcm7038_wdt_ops;\r\nwdt->wdd.min_timeout = WDT_MIN_TIMEOUT;\r\nwdt->wdd.timeout = WDT_DEFAULT_TIMEOUT;\r\nwdt->wdd.max_timeout = 0xffffffff / wdt->rate;\r\nwdt->wdd.parent = dev;\r\nwatchdog_set_drvdata(&wdt->wdd, wdt);\r\nerr = watchdog_register_device(&wdt->wdd);\r\nif (err) {\r\ndev_err(dev, "Failed to register watchdog device\n");\r\nclk_disable_unprepare(wdt->clk);\r\nreturn err;\r\n}\r\ndev_info(dev, "Registered BCM7038 Watchdog\n");\r\nreturn 0;\r\n}\r\nstatic int bcm7038_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct bcm7038_watchdog *wdt = platform_get_drvdata(pdev);\r\nif (!nowayout)\r\nbcm7038_wdt_stop(&wdt->wdd);\r\nwatchdog_unregister_device(&wdt->wdd);\r\nclk_disable_unprepare(wdt->clk);\r\nreturn 0;\r\n}\r\nstatic int bcm7038_wdt_suspend(struct device *dev)\r\n{\r\nstruct bcm7038_watchdog *wdt = dev_get_drvdata(dev);\r\nif (watchdog_active(&wdt->wdd))\r\nreturn bcm7038_wdt_stop(&wdt->wdd);\r\nreturn 0;\r\n}\r\nstatic int bcm7038_wdt_resume(struct device *dev)\r\n{\r\nstruct bcm7038_watchdog *wdt = dev_get_drvdata(dev);\r\nif (watchdog_active(&wdt->wdd))\r\nreturn bcm7038_wdt_start(&wdt->wdd);\r\nreturn 0;\r\n}\r\nstatic void bcm7038_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct bcm7038_watchdog *wdt = platform_get_drvdata(pdev);\r\nif (watchdog_active(&wdt->wdd))\r\nbcm7038_wdt_stop(&wdt->wdd);\r\n}

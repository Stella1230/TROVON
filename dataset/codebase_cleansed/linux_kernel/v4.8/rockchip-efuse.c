static int rockchip_efuse_read(void *context, unsigned int offset,\r\nvoid *val, size_t bytes)\r\n{\r\nstruct rockchip_efuse_chip *efuse = context;\r\nu8 *buf = val;\r\nint ret;\r\nret = clk_prepare_enable(efuse->clk);\r\nif (ret < 0) {\r\ndev_err(efuse->dev, "failed to prepare/enable efuse clk\n");\r\nreturn ret;\r\n}\r\nwritel(EFUSE_LOAD | EFUSE_PGENB, efuse->base + REG_EFUSE_CTRL);\r\nudelay(1);\r\nwhile (bytes--) {\r\nwritel(readl(efuse->base + REG_EFUSE_CTRL) &\r\n(~(EFUSE_A_MASK << EFUSE_A_SHIFT)),\r\nefuse->base + REG_EFUSE_CTRL);\r\nwritel(readl(efuse->base + REG_EFUSE_CTRL) |\r\n((offset++ & EFUSE_A_MASK) << EFUSE_A_SHIFT),\r\nefuse->base + REG_EFUSE_CTRL);\r\nudelay(1);\r\nwritel(readl(efuse->base + REG_EFUSE_CTRL) |\r\nEFUSE_STROBE, efuse->base + REG_EFUSE_CTRL);\r\nudelay(1);\r\n*buf++ = readb(efuse->base + REG_EFUSE_DOUT);\r\nwritel(readl(efuse->base + REG_EFUSE_CTRL) &\r\n(~EFUSE_STROBE), efuse->base + REG_EFUSE_CTRL);\r\nudelay(1);\r\n}\r\nwritel(EFUSE_PGENB | EFUSE_CSB, efuse->base + REG_EFUSE_CTRL);\r\nclk_disable_unprepare(efuse->clk);\r\nreturn 0;\r\n}\r\nstatic int rockchip_efuse_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res;\r\nstruct nvmem_device *nvmem;\r\nstruct rockchip_efuse_chip *efuse;\r\nefuse = devm_kzalloc(&pdev->dev, sizeof(struct rockchip_efuse_chip),\r\nGFP_KERNEL);\r\nif (!efuse)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nefuse->base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(efuse->base))\r\nreturn PTR_ERR(efuse->base);\r\nefuse->clk = devm_clk_get(&pdev->dev, "pclk_efuse");\r\nif (IS_ERR(efuse->clk))\r\nreturn PTR_ERR(efuse->clk);\r\nefuse->dev = &pdev->dev;\r\neconfig.size = resource_size(res);\r\neconfig.reg_read = rockchip_efuse_read;\r\neconfig.priv = efuse;\r\neconfig.dev = efuse->dev;\r\nnvmem = nvmem_register(&econfig);\r\nif (IS_ERR(nvmem))\r\nreturn PTR_ERR(nvmem);\r\nplatform_set_drvdata(pdev, nvmem);\r\nreturn 0;\r\n}\r\nstatic int rockchip_efuse_remove(struct platform_device *pdev)\r\n{\r\nstruct nvmem_device *nvmem = platform_get_drvdata(pdev);\r\nreturn nvmem_unregister(nvmem);\r\n}

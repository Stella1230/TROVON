static int __init\r\nlasi700_probe(struct parisc_device *dev)\r\n{\r\nunsigned long base = dev->hpa.start + LASI_SCSI_CORE_OFFSET;\r\nstruct NCR_700_Host_Parameters *hostdata;\r\nstruct Scsi_Host *host;\r\nhostdata = kzalloc(sizeof(*hostdata), GFP_KERNEL);\r\nif (!hostdata) {\r\ndev_printk(KERN_ERR, &dev->dev, "Failed to allocate host data\n");\r\nreturn -ENOMEM;\r\n}\r\nhostdata->dev = &dev->dev;\r\ndma_set_mask(&dev->dev, DMA_BIT_MASK(32));\r\nhostdata->base = ioremap_nocache(base, 0x100);\r\nhostdata->differential = 0;\r\nif (dev->id.sversion == LASI_700_SVERSION) {\r\nhostdata->clock = LASI700_CLOCK;\r\nhostdata->force_le_on_be = 1;\r\n} else {\r\nhostdata->clock = LASI710_CLOCK;\r\nhostdata->force_le_on_be = 0;\r\nhostdata->chip710 = 1;\r\nhostdata->dmode_extra = DMODE_FC2;\r\nhostdata->burst_length = 8;\r\n}\r\nhost = NCR_700_detect(&lasi700_template, hostdata, &dev->dev);\r\nif (!host)\r\ngoto out_kfree;\r\nhost->this_id = 7;\r\nhost->base = base;\r\nhost->irq = dev->irq;\r\nif(request_irq(dev->irq, NCR_700_intr, IRQF_SHARED, "lasi700", host)) {\r\nprintk(KERN_ERR "lasi700: request_irq failed!\n");\r\ngoto out_put_host;\r\n}\r\ndev_set_drvdata(&dev->dev, host);\r\nscsi_scan_host(host);\r\nreturn 0;\r\nout_put_host:\r\nscsi_host_put(host);\r\nout_kfree:\r\niounmap(hostdata->base);\r\nkfree(hostdata);\r\nreturn -ENODEV;\r\n}\r\nstatic int __exit\r\nlasi700_driver_remove(struct parisc_device *dev)\r\n{\r\nstruct Scsi_Host *host = dev_get_drvdata(&dev->dev);\r\nstruct NCR_700_Host_Parameters *hostdata =\r\n(struct NCR_700_Host_Parameters *)host->hostdata[0];\r\nscsi_remove_host(host);\r\nNCR_700_release(host);\r\nfree_irq(host->irq, host);\r\niounmap(hostdata->base);\r\nkfree(hostdata);\r\nreturn 0;\r\n}\r\nstatic int __init\r\nlasi700_init(void)\r\n{\r\nreturn register_parisc_driver(&lasi700_driver);\r\n}\r\nstatic void __exit\r\nlasi700_exit(void)\r\n{\r\nunregister_parisc_driver(&lasi700_driver);\r\n}

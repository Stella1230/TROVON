static int get_common_field(struct scripting_context *context,\r\nint *offset, int *size, const char *type)\r\n{\r\nstruct pevent *pevent = context->pevent;\r\nstruct event_format *event;\r\nstruct format_field *field;\r\nif (!*size) {\r\nif (!pevent->events)\r\nreturn 0;\r\nevent = pevent->events[0];\r\nfield = pevent_find_common_field(event, type);\r\nif (!field)\r\nreturn 0;\r\n*offset = field->offset;\r\n*size = field->size;\r\n}\r\nreturn pevent_read_number(pevent, context->event_data + *offset, *size);\r\n}\r\nint common_lock_depth(struct scripting_context *context)\r\n{\r\nstatic int offset;\r\nstatic int size;\r\nint ret;\r\nret = get_common_field(context, &size, &offset,\r\n"common_lock_depth");\r\nif (ret < 0)\r\nreturn -1;\r\nreturn ret;\r\n}\r\nint common_flags(struct scripting_context *context)\r\n{\r\nstatic int offset;\r\nstatic int size;\r\nint ret;\r\nret = get_common_field(context, &size, &offset,\r\n"common_flags");\r\nif (ret < 0)\r\nreturn -1;\r\nreturn ret;\r\n}\r\nint common_pc(struct scripting_context *context)\r\n{\r\nstatic int offset;\r\nstatic int size;\r\nint ret;\r\nret = get_common_field(context, &size, &offset,\r\n"common_preempt_count");\r\nif (ret < 0)\r\nreturn -1;\r\nreturn ret;\r\n}\r\nunsigned long long\r\nraw_field_value(struct event_format *event, const char *name, void *data)\r\n{\r\nstruct format_field *field;\r\nunsigned long long val;\r\nfield = pevent_find_any_field(event, name);\r\nif (!field)\r\nreturn 0ULL;\r\npevent_read_number_field(field, data, &val);\r\nreturn val;\r\n}\r\nunsigned long long read_size(struct event_format *event, void *ptr, int size)\r\n{\r\nreturn pevent_read_number(event->pevent, ptr, size);\r\n}\r\nvoid event_format__fprintf(struct event_format *event,\r\nint cpu, void *data, int size, FILE *fp)\r\n{\r\nstruct pevent_record record;\r\nstruct trace_seq s;\r\nmemset(&record, 0, sizeof(record));\r\nrecord.cpu = cpu;\r\nrecord.size = size;\r\nrecord.data = data;\r\ntrace_seq_init(&s);\r\npevent_event_info(&s, event, &record);\r\ntrace_seq_do_fprintf(&s, fp);\r\ntrace_seq_destroy(&s);\r\n}\r\nvoid event_format__print(struct event_format *event,\r\nint cpu, void *data, int size)\r\n{\r\nreturn event_format__fprintf(event, cpu, data, size, stdout);\r\n}\r\nvoid parse_ftrace_printk(struct pevent *pevent,\r\nchar *file, unsigned int size __maybe_unused)\r\n{\r\nunsigned long long addr;\r\nchar *printk;\r\nchar *line;\r\nchar *next = NULL;\r\nchar *addr_str;\r\nchar *fmt = NULL;\r\nline = strtok_r(file, "\n", &next);\r\nwhile (line) {\r\naddr_str = strtok_r(line, ":", &fmt);\r\nif (!addr_str) {\r\nwarning("printk format with empty entry");\r\nbreak;\r\n}\r\naddr = strtoull(addr_str, NULL, 16);\r\nprintk = strdup(fmt+1);\r\nline = strtok_r(NULL, "\n", &next);\r\npevent_register_print_string(pevent, printk, addr);\r\n}\r\n}\r\nint parse_ftrace_file(struct pevent *pevent, char *buf, unsigned long size)\r\n{\r\nreturn pevent_parse_event(pevent, buf, size, "ftrace");\r\n}\r\nint parse_event_file(struct pevent *pevent,\r\nchar *buf, unsigned long size, char *sys)\r\n{\r\nreturn pevent_parse_event(pevent, buf, size, sys);\r\n}\r\nstruct event_format *trace_find_next_event(struct pevent *pevent,\r\nstruct event_format *event)\r\n{\r\nstatic int idx;\r\nif (!pevent || !pevent->events)\r\nreturn NULL;\r\nif (!event) {\r\nidx = 0;\r\nreturn pevent->events[0];\r\n}\r\nif (idx < pevent->nr_events && event == pevent->events[idx]) {\r\nidx++;\r\nif (idx == pevent->nr_events)\r\nreturn NULL;\r\nreturn pevent->events[idx];\r\n}\r\nfor (idx = 1; idx < pevent->nr_events; idx++) {\r\nif (event == pevent->events[idx - 1])\r\nreturn pevent->events[idx];\r\n}\r\nreturn NULL;\r\n}\r\nunsigned long long eval_flag(const char *flag)\r\n{\r\nint i;\r\nif (isdigit(flag[0]))\r\nreturn strtoull(flag, NULL, 0);\r\nfor (i = 0; i < (int)(sizeof(flags)/sizeof(flags[0])); i++)\r\nif (strcmp(flags[i].name, flag) == 0)\r\nreturn flags[i].value;\r\nreturn 0;\r\n}

int metag_mmap_check(unsigned long addr, unsigned long len,\r\nunsigned long flags)\r\n{\r\nif ((flags & MAP_FIXED) && (addr < TASK_UNMAPPED_BASE))\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nasmlinkage long sys_mmap2(unsigned long addr, unsigned long len,\r\nunsigned long prot, unsigned long flags,\r\nunsigned long fd, unsigned long pgoff)\r\n{\r\nif (pgoff & ((1 << (PAGE_SHIFT - 12)) - 1))\r\nreturn -EINVAL;\r\npgoff >>= PAGE_SHIFT - 12;\r\nreturn sys_mmap_pgoff(addr, len, prot, flags, fd, pgoff);\r\n}\r\nasmlinkage int sys_metag_setglobalbit(char __user *addr, int mask)\r\n{\r\nchar tmp;\r\nint ret = 0;\r\nunsigned int flags;\r\nif (!((__force unsigned int)addr >= LINCORE_BASE))\r\nreturn -EFAULT;\r\n__global_lock2(flags);\r\nmetag_data_cache_flush((__force void *)addr, sizeof(mask));\r\nret = __get_user(tmp, addr);\r\nif (ret)\r\ngoto out;\r\ntmp |= mask;\r\nret = __put_user(tmp, addr);\r\nmetag_data_cache_flush((__force void *)addr, sizeof(mask));\r\nout:\r\n__global_unlock2(flags);\r\nreturn ret;\r\n}\r\nasmlinkage void sys_metag_set_fpu_flags(unsigned int flags)\r\n{\r\nunsigned int temp;\r\nflags &= TXDEFR_FPU_MASK;\r\ntemp = __core_reg_get(TXDEFR);\r\ntemp &= ~TXDEFR_FPU_MASK;\r\ntemp |= flags;\r\n__core_reg_set(TXDEFR, temp);\r\n}\r\nasmlinkage int sys_metag_set_tls(void __user *ptr)\r\n{\r\ncurrent->thread.tls_ptr = ptr;\r\nset_gateway_tls(ptr);\r\nreturn 0;\r\n}\r\nasmlinkage void *sys_metag_get_tls(void)\r\n{\r\nreturn (__force void *)current->thread.tls_ptr;\r\n}\r\nasmlinkage long sys_truncate64_metag(const char __user *path, unsigned long lo,\r\nunsigned long hi)\r\n{\r\nreturn sys_truncate64(path, merge_64(hi, lo));\r\n}\r\nasmlinkage long sys_ftruncate64_metag(unsigned int fd, unsigned long lo,\r\nunsigned long hi)\r\n{\r\nreturn sys_ftruncate64(fd, merge_64(hi, lo));\r\n}\r\nasmlinkage long sys_fadvise64_64_metag(int fd, unsigned long offs_lo,\r\nunsigned long offs_hi,\r\nunsigned long len_lo,\r\nunsigned long len_hi, int advice)\r\n{\r\nreturn sys_fadvise64_64(fd, merge_64(offs_hi, offs_lo),\r\nmerge_64(len_hi, len_lo), advice);\r\n}\r\nasmlinkage long sys_readahead_metag(int fd, unsigned long lo, unsigned long hi,\r\nsize_t count)\r\n{\r\nreturn sys_readahead(fd, merge_64(hi, lo), count);\r\n}\r\nasmlinkage ssize_t sys_pread64_metag(unsigned long fd, char __user *buf,\r\nsize_t count, unsigned long lo,\r\nunsigned long hi)\r\n{\r\nreturn sys_pread64(fd, buf, count, merge_64(hi, lo));\r\n}\r\nasmlinkage ssize_t sys_pwrite64_metag(unsigned long fd, char __user *buf,\r\nsize_t count, unsigned long lo,\r\nunsigned long hi)\r\n{\r\nreturn sys_pwrite64(fd, buf, count, merge_64(hi, lo));\r\n}\r\nasmlinkage long sys_sync_file_range_metag(int fd, unsigned long offs_lo,\r\nunsigned long offs_hi,\r\nunsigned long len_lo,\r\nunsigned long len_hi,\r\nunsigned int flags)\r\n{\r\nreturn sys_sync_file_range(fd, merge_64(offs_hi, offs_lo),\r\nmerge_64(len_hi, len_lo), flags);\r\n}

static int call_site_handler(struct trace_seq *s, struct pevent_record *record,\r\nstruct event_format *event, void *context)\r\n{\r\nstruct format_field *field;\r\nunsigned long long val, addr;\r\nvoid *data = record->data;\r\nconst char *func;\r\nfield = pevent_find_field(event, "call_site");\r\nif (!field)\r\nreturn 1;\r\nif (pevent_read_number_field(field, data, &val))\r\nreturn 1;\r\nfunc = pevent_find_function(event->pevent, val);\r\nif (!func)\r\nreturn 1;\r\naddr = pevent_find_function_address(event->pevent, val);\r\ntrace_seq_printf(s, "(%s+0x%x) ", func, (int)(val - addr));\r\nreturn 1;\r\n}\r\nint PEVENT_PLUGIN_LOADER(struct pevent *pevent)\r\n{\r\npevent_register_event_handler(pevent, -1, "kmem", "kfree",\r\ncall_site_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kmem", "kmalloc",\r\ncall_site_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kmem", "kmalloc_node",\r\ncall_site_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kmem", "kmem_cache_alloc",\r\ncall_site_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kmem",\r\n"kmem_cache_alloc_node",\r\ncall_site_handler, NULL);\r\npevent_register_event_handler(pevent, -1, "kmem", "kmem_cache_free",\r\ncall_site_handler, NULL);\r\nreturn 0;\r\n}\r\nvoid PEVENT_PLUGIN_UNLOADER(struct pevent *pevent)\r\n{\r\npevent_unregister_event_handler(pevent, -1, "kmem", "kfree",\r\ncall_site_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kmem", "kmalloc",\r\ncall_site_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kmem", "kmalloc_node",\r\ncall_site_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kmem", "kmem_cache_alloc",\r\ncall_site_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kmem",\r\n"kmem_cache_alloc_node",\r\ncall_site_handler, NULL);\r\npevent_unregister_event_handler(pevent, -1, "kmem", "kmem_cache_free",\r\ncall_site_handler, NULL);\r\n}

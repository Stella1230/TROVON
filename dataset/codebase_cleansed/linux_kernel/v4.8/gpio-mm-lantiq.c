static void ltq_mm_apply(struct ltq_mm *chip)\r\n{\r\nunsigned long flags;\r\nspin_lock_irqsave(&ebu_lock, flags);\r\nltq_ebu_w32(LTQ_EBU_BUSCON, LTQ_EBU_BUSCON1);\r\n__raw_writew(chip->shadow, chip->mmchip.regs);\r\nltq_ebu_w32(LTQ_EBU_BUSCON | LTQ_EBU_WP, LTQ_EBU_BUSCON1);\r\nspin_unlock_irqrestore(&ebu_lock, flags);\r\n}\r\nstatic void ltq_mm_set(struct gpio_chip *gc, unsigned offset, int value)\r\n{\r\nstruct ltq_mm *chip = gpiochip_get_data(gc);\r\nif (value)\r\nchip->shadow |= (1 << offset);\r\nelse\r\nchip->shadow &= ~(1 << offset);\r\nltq_mm_apply(chip);\r\n}\r\nstatic int ltq_mm_dir_out(struct gpio_chip *gc, unsigned offset, int value)\r\n{\r\nltq_mm_set(gc, offset, value);\r\nreturn 0;\r\n}\r\nstatic void ltq_mm_save_regs(struct of_mm_gpio_chip *mm_gc)\r\n{\r\nstruct ltq_mm *chip =\r\ncontainer_of(mm_gc, struct ltq_mm, mmchip);\r\nltq_ebu_w32(CPHYSADDR(chip->mmchip.regs) | 0x1, LTQ_EBU_ADDRSEL1);\r\nltq_mm_apply(chip);\r\n}\r\nstatic int ltq_mm_probe(struct platform_device *pdev)\r\n{\r\nstruct ltq_mm *chip;\r\nu32 shadow;\r\nchip = devm_kzalloc(&pdev->dev, sizeof(*chip), GFP_KERNEL);\r\nif (!chip)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, chip);\r\nchip->mmchip.gc.ngpio = 16;\r\nchip->mmchip.gc.direction_output = ltq_mm_dir_out;\r\nchip->mmchip.gc.set = ltq_mm_set;\r\nchip->mmchip.save_regs = ltq_mm_save_regs;\r\nif (!of_property_read_u32(pdev->dev.of_node, "lantiq,shadow", &shadow))\r\nchip->shadow = shadow;\r\nreturn of_mm_gpiochip_add_data(pdev->dev.of_node, &chip->mmchip, chip);\r\n}\r\nstatic int ltq_mm_remove(struct platform_device *pdev)\r\n{\r\nstruct ltq_mm *chip = platform_get_drvdata(pdev);\r\nof_mm_gpiochip_remove(&chip->mmchip);\r\nreturn 0;\r\n}\r\nstatic int __init ltq_mm_init(void)\r\n{\r\nreturn platform_driver_register(&ltq_mm_driver);\r\n}\r\nstatic void __exit ltq_mm_exit(void)\r\n{\r\nplatform_driver_unregister(&ltq_mm_driver);\r\n}

bool rtl92e_send_cmd_pkt(struct net_device *dev, u32 type, const void *data,\r\nu32 len)\r\n{\r\nbool rt_status = true;\r\nstruct r8192_priv *priv = rtllib_priv(dev);\r\nu16 frag_length = 0, frag_offset = 0;\r\nstruct sk_buff *skb;\r\nunsigned char *seg_ptr;\r\nstruct cb_desc *tcb_desc;\r\nu8 bLastIniPkt;\r\nstruct tx_fwinfo_8190pci *pTxFwInfo = NULL;\r\nRT_TRACE(COMP_CMDPKT, "%s(),buffer_len is %d\n", __func__, len);\r\ndo {\r\nif ((len - frag_offset) > CMDPACKET_FRAG_SIZE) {\r\nfrag_length = CMDPACKET_FRAG_SIZE;\r\nbLastIniPkt = 0;\r\n} else {\r\nfrag_length = (u16)(len - frag_offset);\r\nbLastIniPkt = 1;\r\n}\r\nif (type == DESC_PACKET_TYPE_NORMAL)\r\nskb = dev_alloc_skb(frag_length +\r\npriv->rtllib->tx_headroom + 4);\r\nelse\r\nskb = dev_alloc_skb(frag_length + 4);\r\nif (skb == NULL) {\r\nrt_status = false;\r\ngoto Failed;\r\n}\r\nmemcpy((unsigned char *)(skb->cb), &dev, sizeof(dev));\r\ntcb_desc = (struct cb_desc *)(skb->cb + MAX_DEV_ADDR_SIZE);\r\ntcb_desc->queue_index = TXCMD_QUEUE;\r\ntcb_desc->bCmdOrInit = type;\r\ntcb_desc->bLastIniPkt = bLastIniPkt;\r\nif (type == DESC_PACKET_TYPE_NORMAL) {\r\ntcb_desc->pkt_size = frag_length;\r\nseg_ptr = skb_put(skb, priv->rtllib->tx_headroom);\r\npTxFwInfo = (struct tx_fwinfo_8190pci *)seg_ptr;\r\nmemset(pTxFwInfo, 0, sizeof(struct tx_fwinfo_8190pci));\r\nmemset(pTxFwInfo, 0x12, 8);\r\n} else {\r\ntcb_desc->txbuf_size = (u16)frag_length;\r\n}\r\nseg_ptr = skb_put(skb, frag_length);\r\nmemcpy(seg_ptr, data, (u32)frag_length);\r\nif (type == DESC_PACKET_TYPE_INIT &&\r\n(!priv->rtllib->check_nic_enough_desc(dev, TXCMD_QUEUE) ||\r\n(!skb_queue_empty(&priv->rtllib->skb_waitQ[TXCMD_QUEUE])) ||\r\n(priv->rtllib->queue_stop))) {\r\nskb_queue_tail(&priv->rtllib->skb_waitQ[TXCMD_QUEUE],\r\nskb);\r\n} else {\r\npriv->rtllib->softmac_hard_start_xmit(skb, dev);\r\n}\r\ndata += frag_length;\r\nfrag_offset += frag_length;\r\n} while (frag_offset < len);\r\nrtl92e_writeb(dev, TPPoll, TPPoll_CQ);\r\nFailed:\r\nreturn rt_status;\r\n}

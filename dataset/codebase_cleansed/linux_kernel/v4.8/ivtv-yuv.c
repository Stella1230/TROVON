static int ivtv_yuv_prep_user_dma(struct ivtv *itv, struct ivtv_user_dma *dma,\r\nstruct ivtv_dma_frame *args)\r\n{\r\nstruct ivtv_dma_page_info y_dma;\r\nstruct ivtv_dma_page_info uv_dma;\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nu8 frame = yi->draw_frame;\r\nstruct yuv_frame_info *f = &yi->new_frame_info[frame];\r\nint i;\r\nint y_pages, uv_pages;\r\nunsigned long y_buffer_offset, uv_buffer_offset;\r\nint y_decode_height, uv_decode_height, y_size;\r\ny_buffer_offset = IVTV_DECODER_OFFSET + yuv_offset[frame];\r\nuv_buffer_offset = y_buffer_offset + IVTV_YUV_BUFFER_UV_OFFSET;\r\ny_decode_height = uv_decode_height = f->src_h + f->src_y;\r\nif (f->offset_y)\r\ny_buffer_offset += 720 * 16;\r\nif (y_decode_height & 15)\r\ny_decode_height = (y_decode_height + 16) & ~15;\r\nif (uv_decode_height & 31)\r\nuv_decode_height = (uv_decode_height + 32) & ~31;\r\ny_size = 720 * y_decode_height;\r\nif (dma->SG_length || dma->page_count) {\r\nIVTV_DEBUG_WARN\r\n("prep_user_dma: SG_length %d page_count %d still full?\n",\r\ndma->SG_length, dma->page_count);\r\nreturn -EBUSY;\r\n}\r\nivtv_udma_get_page_info (&y_dma, (unsigned long)args->y_source, 720 * y_decode_height);\r\nivtv_udma_get_page_info (&uv_dma, (unsigned long)args->uv_source, 360 * uv_decode_height);\r\ny_pages = get_user_pages_unlocked(y_dma.uaddr,\r\ny_dma.page_count, 0, 1, &dma->map[0]);\r\nuv_pages = 0;\r\nif (y_pages == y_dma.page_count) {\r\nuv_pages = get_user_pages_unlocked(uv_dma.uaddr,\r\nuv_dma.page_count, 0, 1, &dma->map[y_pages]);\r\n}\r\nif (y_pages != y_dma.page_count || uv_pages != uv_dma.page_count) {\r\nint rc = -EFAULT;\r\nif (y_pages == y_dma.page_count) {\r\nIVTV_DEBUG_WARN\r\n("failed to map uv user pages, returned %d "\r\n"expecting %d\n", uv_pages, uv_dma.page_count);\r\nif (uv_pages >= 0) {\r\nfor (i = 0; i < uv_pages; i++)\r\nput_page(dma->map[y_pages + i]);\r\nrc = -EFAULT;\r\n} else {\r\nrc = uv_pages;\r\n}\r\n} else {\r\nIVTV_DEBUG_WARN\r\n("failed to map y user pages, returned %d "\r\n"expecting %d\n", y_pages, y_dma.page_count);\r\n}\r\nif (y_pages >= 0) {\r\nfor (i = 0; i < y_pages; i++)\r\nput_page(dma->map[i]);\r\n} else {\r\nrc = y_pages;\r\n}\r\nreturn rc;\r\n}\r\ndma->page_count = y_pages + uv_pages;\r\nif (ivtv_udma_fill_sg_list (dma, &uv_dma, ivtv_udma_fill_sg_list (dma, &y_dma, 0)) < 0) {\r\nIVTV_DEBUG_WARN("could not allocate bounce buffers for highmem userspace buffers\n");\r\nfor (i = 0; i < dma->page_count; i++) {\r\nput_page(dma->map[i]);\r\n}\r\ndma->page_count = 0;\r\nreturn -ENOMEM;\r\n}\r\ndma->SG_length = pci_map_sg(itv->pdev, dma->SGlist, dma->page_count, PCI_DMA_TODEVICE);\r\nivtv_udma_fill_sg_array(dma, y_buffer_offset, uv_buffer_offset, y_size);\r\nif (f->offset_y && yi->blanking_dmaptr) {\r\ndma->SGarray[dma->SG_length].size = cpu_to_le32(720*16);\r\ndma->SGarray[dma->SG_length].src = cpu_to_le32(yi->blanking_dmaptr);\r\ndma->SGarray[dma->SG_length].dst = cpu_to_le32(IVTV_DECODER_OFFSET + yuv_offset[frame]);\r\ndma->SG_length++;\r\n}\r\ndma->SGarray[dma->SG_length - 1].size |= cpu_to_le32(0x80000000);\r\nivtv_udma_sync_for_device(itv);\r\nreturn 0;\r\n}\r\nint ivtv_yuv_filter_check(struct ivtv *itv)\r\n{\r\nint i, y, uv;\r\nfor (i = 0, y = 16, uv = 4; i < 16; i++, y += 24, uv += 12) {\r\nif ((read_dec(IVTV_YUV_HORIZONTAL_FILTER_OFFSET + y) != i << 16) ||\r\n(read_dec(IVTV_YUV_VERTICAL_FILTER_OFFSET + uv) != i << 16)) {\r\nIVTV_WARN ("YUV filter table not found in firmware.\n");\r\nreturn -1;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void ivtv_yuv_filter(struct ivtv *itv, int h_filter, int v_filter_1, int v_filter_2)\r\n{\r\nu32 i, line;\r\nif (h_filter > -1) {\r\nif (h_filter > 4)\r\nh_filter = 4;\r\ni = IVTV_YUV_HORIZONTAL_FILTER_OFFSET + (h_filter * 384);\r\nfor (line = 0; line < 16; line++) {\r\nwrite_reg(read_dec(i), 0x02804);\r\nwrite_reg(read_dec(i), 0x0281c);\r\ni += 4;\r\nwrite_reg(read_dec(i), 0x02808);\r\nwrite_reg(read_dec(i), 0x02820);\r\ni += 4;\r\nwrite_reg(read_dec(i), 0x0280c);\r\nwrite_reg(read_dec(i), 0x02824);\r\ni += 4;\r\nwrite_reg(read_dec(i), 0x02810);\r\nwrite_reg(read_dec(i), 0x02828);\r\ni += 4;\r\nwrite_reg(read_dec(i), 0x02814);\r\nwrite_reg(read_dec(i), 0x0282c);\r\ni += 8;\r\nwrite_reg(0, 0x02818);\r\nwrite_reg(0, 0x02830);\r\n}\r\nIVTV_DEBUG_YUV("h_filter -> %d\n", h_filter);\r\n}\r\nif (v_filter_1 > -1) {\r\nif (v_filter_1 > 4)\r\nv_filter_1 = 4;\r\ni = IVTV_YUV_VERTICAL_FILTER_OFFSET + (v_filter_1 * 192);\r\nfor (line = 0; line < 16; line++) {\r\nwrite_reg(read_dec(i), 0x02900);\r\ni += 4;\r\nwrite_reg(read_dec(i), 0x02904);\r\ni += 8;\r\nwrite_reg(0, 0x02908);\r\n}\r\nIVTV_DEBUG_YUV("v_filter_1 -> %d\n", v_filter_1);\r\n}\r\nif (v_filter_2 > -1) {\r\nif (v_filter_2 > 4)\r\nv_filter_2 = 4;\r\ni = IVTV_YUV_VERTICAL_FILTER_OFFSET + (v_filter_2 * 192);\r\nfor (line = 0; line < 16; line++) {\r\nwrite_reg(read_dec(i), 0x0290c);\r\ni += 4;\r\nwrite_reg(read_dec(i), 0x02910);\r\ni += 8;\r\nwrite_reg(0, 0x02914);\r\n}\r\nIVTV_DEBUG_YUV("v_filter_2 -> %d\n", v_filter_2);\r\n}\r\n}\r\nstatic void ivtv_yuv_handle_horizontal(struct ivtv *itv, struct yuv_frame_info *f)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nu32 reg_2834, reg_2838, reg_283c;\r\nu32 reg_2844, reg_2854, reg_285c;\r\nu32 reg_2864, reg_2874, reg_2890;\r\nu32 reg_2870, reg_2870_base, reg_2870_offset;\r\nint x_cutoff;\r\nint h_filter;\r\nu32 master_width;\r\nIVTV_DEBUG_WARN\r\n("Adjust to width %d src_w %d dst_w %d src_x %d dst_x %d\n",\r\nf->tru_w, f->src_w, f->dst_w, f->src_x, f->dst_x);\r\nx_cutoff = f->src_w + f->src_x;\r\nreg_2834 = f->dst_w;\r\nreg_2838 = reg_2834;\r\nreg_2890 = f->dst_x;\r\nreg_2870 = 0;\r\nif (f->vis_w == 720) {\r\nif ((f->tru_x - f->pan_x > -1) && (f->tru_x - f->pan_x <= 40) && (f->dst_w >= 680))\r\nreg_2870 = 10 - (f->tru_x - f->pan_x) / 4;\r\nelse if ((f->tru_x - f->pan_x < 0) && (f->tru_x - f->pan_x >= -20) && (f->dst_w >= 660))\r\nreg_2870 = (10 + (f->tru_x - f->pan_x) / 2);\r\nif (f->dst_w >= f->src_w)\r\nreg_2870 = reg_2870 << 16 | reg_2870;\r\nelse\r\nreg_2870 = ((reg_2870 & ~1) << 15) | (reg_2870 & ~1);\r\n}\r\nif (f->dst_w < f->src_w)\r\nreg_2870 = 0x000d000e - reg_2870;\r\nelse\r\nreg_2870 = 0x0012000e - reg_2870;\r\nreg_2870_offset = (f->src_x * ((f->dst_w << 21) / f->src_w)) >> 19;\r\nif (f->dst_w >= f->src_w) {\r\nx_cutoff &= ~1;\r\nmaster_width = (f->src_w * 0x00200000) / (f->dst_w);\r\nif (master_width * f->dst_w != f->src_w * 0x00200000)\r\nmaster_width++;\r\nreg_2834 = (reg_2834 << 16) | x_cutoff;\r\nreg_2838 = (reg_2838 << 16) | x_cutoff;\r\nreg_283c = master_width >> 2;\r\nreg_2844 = master_width >> 2;\r\nreg_2854 = master_width;\r\nreg_285c = master_width >> 1;\r\nreg_2864 = master_width >> 1;\r\nif (f->dst_w > f->src_w)\r\nreg_2870_base = ((f->dst_w - f->src_w)<<16) / (f->src_w <<14);\r\nelse\r\nreg_2870_base = 0;\r\nreg_2870 += (((reg_2870_offset << 14) & 0xFFFF0000) | reg_2870_offset >> 2) + (reg_2870_base << 17 | reg_2870_base);\r\nreg_2874 = 0;\r\n} else if (f->dst_w < f->src_w / 2) {\r\nmaster_width = (f->src_w * 0x00080000) / f->dst_w;\r\nif (master_width * f->dst_w != f->src_w * 0x00080000)\r\nmaster_width++;\r\nreg_2834 = (reg_2834 << 16) | x_cutoff;\r\nreg_2838 = (reg_2838 << 16) | x_cutoff;\r\nreg_283c = master_width >> 2;\r\nreg_2844 = master_width >> 1;\r\nreg_2854 = master_width;\r\nreg_285c = master_width >> 1;\r\nreg_2864 = master_width >> 1;\r\nreg_2870 += ((reg_2870_offset << 15) & 0xFFFF0000) | reg_2870_offset;\r\nreg_2870 += (5 - (((f->src_w + f->src_w / 2) - 1) / f->dst_w)) << 16;\r\nreg_2874 = 0x00000012;\r\n} else {\r\nmaster_width = (f->src_w * 0x00100000) / f->dst_w;\r\nif (master_width * f->dst_w != f->src_w * 0x00100000)\r\nmaster_width++;\r\nreg_2834 = (reg_2834 << 16) | x_cutoff;\r\nreg_2838 = (reg_2838 << 16) | x_cutoff;\r\nreg_283c = master_width >> 2;\r\nreg_2844 = master_width >> 1;\r\nreg_2854 = master_width;\r\nreg_285c = master_width >> 1;\r\nreg_2864 = master_width >> 1;\r\nreg_2870 += ((reg_2870_offset << 14) & 0xFFFF0000) | reg_2870_offset >> 1;\r\nreg_2870 += (5 - (((f->src_w * 3) - 1) / f->dst_w)) << 16;\r\nreg_2874 = 0x00000001;\r\n}\r\nif (f->src_w == f->dst_w) {\r\nh_filter = 0;\r\n} else {\r\nh_filter = ((f->src_w << 16) / f->dst_w) >> 15;\r\nh_filter = (h_filter >> 1) + (h_filter & 1);\r\nh_filter += !h_filter;\r\n}\r\nwrite_reg(reg_2834, 0x02834);\r\nwrite_reg(reg_2838, 0x02838);\r\nIVTV_DEBUG_YUV("Update reg 0x2834 %08x->%08x 0x2838 %08x->%08x\n",\r\nyi->reg_2834, reg_2834, yi->reg_2838, reg_2838);\r\nwrite_reg(reg_283c, 0x0283c);\r\nwrite_reg(reg_2844, 0x02844);\r\nIVTV_DEBUG_YUV("Update reg 0x283c %08x->%08x 0x2844 %08x->%08x\n",\r\nyi->reg_283c, reg_283c, yi->reg_2844, reg_2844);\r\nwrite_reg(0x00080514, 0x02840);\r\nwrite_reg(0x00100514, 0x02848);\r\nIVTV_DEBUG_YUV("Update reg 0x2840 %08x->%08x 0x2848 %08x->%08x\n",\r\nyi->reg_2840, 0x00080514, yi->reg_2848, 0x00100514);\r\nwrite_reg(reg_2854, 0x02854);\r\nIVTV_DEBUG_YUV("Update reg 0x2854 %08x->%08x \n",\r\nyi->reg_2854, reg_2854);\r\nwrite_reg(reg_285c, 0x0285c);\r\nwrite_reg(reg_2864, 0x02864);\r\nIVTV_DEBUG_YUV("Update reg 0x285c %08x->%08x 0x2864 %08x->%08x\n",\r\nyi->reg_285c, reg_285c, yi->reg_2864, reg_2864);\r\nwrite_reg(reg_2874, 0x02874);\r\nIVTV_DEBUG_YUV("Update reg 0x2874 %08x->%08x\n",\r\nyi->reg_2874, reg_2874);\r\nwrite_reg(reg_2870, 0x02870);\r\nIVTV_DEBUG_YUV("Update reg 0x2870 %08x->%08x\n",\r\nyi->reg_2870, reg_2870);\r\nwrite_reg(reg_2890, 0x02890);\r\nIVTV_DEBUG_YUV("Update reg 0x2890 %08x->%08x\n",\r\nyi->reg_2890, reg_2890);\r\nif (h_filter != yi->h_filter) {\r\nivtv_yuv_filter(itv, h_filter, -1, -1);\r\nyi->h_filter = h_filter;\r\n}\r\n}\r\nstatic void ivtv_yuv_handle_vertical(struct ivtv *itv, struct yuv_frame_info *f)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nu32 master_height;\r\nu32 reg_2918, reg_291c, reg_2920, reg_2928;\r\nu32 reg_2930, reg_2934, reg_293c;\r\nu32 reg_2940, reg_2944, reg_294c;\r\nu32 reg_2950, reg_2954, reg_2958, reg_295c;\r\nu32 reg_2960, reg_2964, reg_2968, reg_296c;\r\nu32 reg_289c;\r\nu32 src_major_y, src_minor_y;\r\nu32 src_major_uv, src_minor_uv;\r\nu32 reg_2964_base, reg_2968_base;\r\nint v_filter_1, v_filter_2;\r\nIVTV_DEBUG_WARN\r\n("Adjust to height %d src_h %d dst_h %d src_y %d dst_y %d\n",\r\nf->tru_h, f->src_h, f->dst_h, f->src_y, f->dst_y);\r\nIVTV_DEBUG_YUV("Scaling mode Y: %s\n",\r\nf->interlaced_y ? "Interlaced" : "Progressive");\r\nIVTV_DEBUG_YUV("Scaling mode UV: %s\n",\r\nf->interlaced_uv ? "Interlaced" : "Progressive");\r\nIVTV_DEBUG_WARN("Source video: %s\n",\r\nf->interlaced ? "Interlaced" : "Progressive");\r\nif (f->src_y < 8) {\r\nsrc_minor_uv = f->src_y;\r\nsrc_major_uv = 0;\r\n} else {\r\nsrc_minor_uv = 8;\r\nsrc_major_uv = f->src_y - 8;\r\n}\r\nsrc_minor_y = src_minor_uv;\r\nsrc_major_y = src_major_uv;\r\nif (f->offset_y)\r\nsrc_minor_y += 16;\r\nif (f->interlaced_y)\r\nreg_2918 = (f->dst_h << 16) | (f->src_h + src_minor_y);\r\nelse\r\nreg_2918 = (f->dst_h << 16) | ((f->src_h + src_minor_y) << 1);\r\nif (f->interlaced_uv)\r\nreg_291c = (f->dst_h << 16) | ((f->src_h + src_minor_uv) >> 1);\r\nelse\r\nreg_291c = (f->dst_h << 16) | (f->src_h + src_minor_uv);\r\nreg_2964_base = (src_minor_y * ((f->dst_h << 16) / f->src_h)) >> 14;\r\nreg_2968_base = (src_minor_uv * ((f->dst_h << 16) / f->src_h)) >> 14;\r\nif (f->dst_h / 2 >= f->src_h && !f->interlaced_y) {\r\nmaster_height = (f->src_h * 0x00400000) / f->dst_h;\r\nif ((f->src_h * 0x00400000) - (master_height * f->dst_h) >= f->dst_h / 2)\r\nmaster_height++;\r\nreg_2920 = master_height >> 2;\r\nreg_2928 = master_height >> 3;\r\nreg_2930 = master_height;\r\nreg_2940 = master_height >> 1;\r\nreg_2964_base >>= 3;\r\nreg_2968_base >>= 3;\r\nreg_296c = 0x00000000;\r\n} else if (f->dst_h >= f->src_h) {\r\nmaster_height = (f->src_h * 0x00400000) / f->dst_h;\r\nmaster_height = (master_height >> 1) + (master_height & 1);\r\nreg_2920 = master_height >> 2;\r\nreg_2928 = master_height >> 2;\r\nreg_2930 = master_height;\r\nreg_2940 = master_height >> 1;\r\nreg_296c = 0x00000000;\r\nif (f->interlaced_y) {\r\nreg_2964_base >>= 3;\r\n} else {\r\nreg_296c++;\r\nreg_2964_base >>= 2;\r\n}\r\nif (f->interlaced_uv)\r\nreg_2928 >>= 1;\r\nreg_2968_base >>= 3;\r\n} else if (f->dst_h >= f->src_h / 2) {\r\nmaster_height = (f->src_h * 0x00200000) / f->dst_h;\r\nmaster_height = (master_height >> 1) + (master_height & 1);\r\nreg_2920 = master_height >> 2;\r\nreg_2928 = master_height >> 2;\r\nreg_2930 = master_height;\r\nreg_2940 = master_height;\r\nreg_296c = 0x00000101;\r\nif (f->interlaced_y) {\r\nreg_2964_base >>= 2;\r\n} else {\r\nreg_296c++;\r\nreg_2964_base >>= 1;\r\n}\r\nif (f->interlaced_uv)\r\nreg_2928 >>= 1;\r\nreg_2968_base >>= 2;\r\n} else {\r\nmaster_height = (f->src_h * 0x00100000) / f->dst_h;\r\nmaster_height = (master_height >> 1) + (master_height & 1);\r\nreg_2920 = master_height >> 2;\r\nreg_2928 = master_height >> 2;\r\nreg_2930 = master_height;\r\nreg_2940 = master_height;\r\nreg_2964_base >>= 1;\r\nreg_2968_base >>= 2;\r\nreg_296c = 0x00000102;\r\n}\r\nif (f->src_h == f->dst_h) {\r\nreg_2934 = 0x00020000;\r\nreg_293c = 0x00100000;\r\nreg_2944 = 0x00040000;\r\nreg_294c = 0x000b0000;\r\n} else {\r\nreg_2934 = 0x00000FF0;\r\nreg_293c = 0x00000FF0;\r\nreg_2944 = 0x00000FF0;\r\nreg_294c = 0x00000FF0;\r\n}\r\nreg_2950 = 0x00010000 + src_major_y;\r\nif (f->interlaced_y)\r\nreg_2950 += 0x00010000;\r\nreg_2954 = reg_2950 + 1;\r\nreg_2958 = 0x00010000 + (src_major_y >> 1);\r\nif (f->interlaced_uv)\r\nreg_2958 += 0x00010000;\r\nreg_295c = reg_2958 + 1;\r\nif (yi->decode_height == 480)\r\nreg_289c = 0x011e0017;\r\nelse\r\nreg_289c = 0x01500017;\r\nif (f->dst_y < 0)\r\nreg_289c = (reg_289c - ((f->dst_y & ~1)<<15))-(f->dst_y >>1);\r\nelse\r\nreg_289c = (reg_289c + ((f->dst_y & ~1)<<15))+(f->dst_y >>1);\r\nreg_2960 = ((src_minor_y + f->src_h + src_major_y) - 1) |\r\n(((src_minor_uv + f->src_h + src_major_uv - 1) & ~1) << 15);\r\nif (f->src_h == f->dst_h) {\r\nreg_2964 = 1;\r\n} else {\r\nreg_2964 = 2 + ((f->dst_h << 1) / f->src_h);\r\nreg_2964 = (reg_2964 >> 1) + (reg_2964 & 1);\r\n}\r\nreg_2968 = (reg_2964 << 16) + reg_2964 + (reg_2964 >> 1);\r\nreg_2964 = (reg_2964 << 16) + reg_2964 + (reg_2964 * 46 / 94);\r\nreg_2964 = 0x00010001 + ((reg_2964 & 0x0000FFFF) - (reg_2964 >> 16));\r\nreg_2968 = 0x00010001 + ((reg_2968 & 0x0000FFFF) - (reg_2968 >> 16));\r\nif ((reg_2964 != 0x00010001) && (f->dst_h / 2 <= f->src_h))\r\nreg_2964 = (reg_2964 & 0xFFFF0000) + ((reg_2964 & 0x0000FFFF) / 2);\r\nif (!f->interlaced_y)\r\nreg_2964 -= 0x00010001;\r\nif (!f->interlaced_uv)\r\nreg_2968 -= 0x00010001;\r\nreg_2964 += ((reg_2964_base << 16) | reg_2964_base);\r\nreg_2968 += ((reg_2968_base << 16) | reg_2968_base);\r\nif (f->src_h == f->dst_h) {\r\nv_filter_1 = 0;\r\nv_filter_2 = 1;\r\n} else {\r\nv_filter_1 = ((f->src_h << 16) / f->dst_h) >> 15;\r\nv_filter_1 = (v_filter_1 >> 1) + (v_filter_1 & 1);\r\nv_filter_1 += !v_filter_1;\r\nv_filter_2 = v_filter_1;\r\n}\r\nwrite_reg(reg_2934, 0x02934);\r\nwrite_reg(reg_293c, 0x0293c);\r\nIVTV_DEBUG_YUV("Update reg 0x2934 %08x->%08x 0x293c %08x->%08x\n",\r\nyi->reg_2934, reg_2934, yi->reg_293c, reg_293c);\r\nwrite_reg(reg_2944, 0x02944);\r\nwrite_reg(reg_294c, 0x0294c);\r\nIVTV_DEBUG_YUV("Update reg 0x2944 %08x->%08x 0x294c %08x->%08x\n",\r\nyi->reg_2944, reg_2944, yi->reg_294c, reg_294c);\r\nwrite_reg(reg_2930, 0x02938);\r\nwrite_reg(reg_2930, 0x02930);\r\nIVTV_DEBUG_YUV("Update reg 0x2930 %08x->%08x 0x2938 %08x->%08x\n",\r\nyi->reg_2930, reg_2930, yi->reg_2938, reg_2930);\r\nwrite_reg(reg_2928, 0x02928);\r\nwrite_reg(reg_2928 + 0x514, 0x0292C);\r\nIVTV_DEBUG_YUV("Update reg 0x2928 %08x->%08x 0x292c %08x->%08x\n",\r\nyi->reg_2928, reg_2928, yi->reg_292c, reg_2928 + 0x514);\r\nwrite_reg(reg_2920, 0x02920);\r\nwrite_reg(reg_2920 + 0x514, 0x02924);\r\nIVTV_DEBUG_YUV("Update reg 0x2920 %08x->%08x 0x2924 %08x->%08x\n",\r\nyi->reg_2920, reg_2920, yi->reg_2924, reg_2920 + 0x514);\r\nwrite_reg(reg_2918, 0x02918);\r\nwrite_reg(reg_291c, 0x0291C);\r\nIVTV_DEBUG_YUV("Update reg 0x2918 %08x->%08x 0x291C %08x->%08x\n",\r\nyi->reg_2918, reg_2918, yi->reg_291c, reg_291c);\r\nwrite_reg(reg_296c, 0x0296c);\r\nIVTV_DEBUG_YUV("Update reg 0x296c %08x->%08x\n",\r\nyi->reg_296c, reg_296c);\r\nwrite_reg(reg_2940, 0x02948);\r\nwrite_reg(reg_2940, 0x02940);\r\nIVTV_DEBUG_YUV("Update reg 0x2940 %08x->%08x 0x2948 %08x->%08x\n",\r\nyi->reg_2940, reg_2940, yi->reg_2948, reg_2940);\r\nwrite_reg(reg_2950, 0x02950);\r\nwrite_reg(reg_2954, 0x02954);\r\nIVTV_DEBUG_YUV("Update reg 0x2950 %08x->%08x 0x2954 %08x->%08x\n",\r\nyi->reg_2950, reg_2950, yi->reg_2954, reg_2954);\r\nwrite_reg(reg_2958, 0x02958);\r\nwrite_reg(reg_295c, 0x0295C);\r\nIVTV_DEBUG_YUV("Update reg 0x2958 %08x->%08x 0x295C %08x->%08x\n",\r\nyi->reg_2958, reg_2958, yi->reg_295c, reg_295c);\r\nwrite_reg(reg_2960, 0x02960);\r\nIVTV_DEBUG_YUV("Update reg 0x2960 %08x->%08x \n",\r\nyi->reg_2960, reg_2960);\r\nwrite_reg(reg_2964, 0x02964);\r\nwrite_reg(reg_2968, 0x02968);\r\nIVTV_DEBUG_YUV("Update reg 0x2964 %08x->%08x 0x2968 %08x->%08x\n",\r\nyi->reg_2964, reg_2964, yi->reg_2968, reg_2968);\r\nwrite_reg(reg_289c, 0x0289c);\r\nIVTV_DEBUG_YUV("Update reg 0x289c %08x->%08x\n",\r\nyi->reg_289c, reg_289c);\r\nif (v_filter_1 != yi->v_filter_1) {\r\nivtv_yuv_filter(itv, -1, v_filter_1, -1);\r\nyi->v_filter_1 = v_filter_1;\r\n}\r\nif (v_filter_2 != yi->v_filter_2) {\r\nivtv_yuv_filter(itv, -1, -1, v_filter_2);\r\nyi->v_filter_2 = v_filter_2;\r\n}\r\n}\r\nstatic u32 ivtv_yuv_window_setup(struct ivtv *itv, struct yuv_frame_info *f)\r\n{\r\nstruct yuv_frame_info *of = &itv->yuv_info.old_frame_info;\r\nint osd_crop;\r\nu32 osd_scale;\r\nu32 yuv_update = 0;\r\nif (f->src_x < 0)\r\nf->src_x = 0;\r\nif (f->src_y < 0)\r\nf->src_y = 0;\r\nif ((osd_crop = f->src_w - 4 * f->dst_w) > 0) {\r\nf->src_x += osd_crop / 2;\r\nf->src_w = (f->src_w - osd_crop) & ~3;\r\nf->dst_w = f->src_w / 4;\r\nf->dst_w += f->dst_w & 1;\r\n}\r\nif (f->src_h / f->dst_h >= 2) {\r\nf->interlaced_y = 1;\r\nif ((osd_crop = f->src_h - 4 * f->dst_h) > 0) {\r\nf->src_y += osd_crop / 2;\r\nf->src_h = (f->src_h - osd_crop) & ~3;\r\nf->dst_h = f->src_h / 4;\r\nf->dst_h += f->dst_h & 1;\r\n}\r\n}\r\nif ((int)f->dst_w <= 2 || (int)f->dst_h <= 2 ||\r\n(int)f->src_w <= 2 || (int)f->src_h <= 2) {\r\nreturn IVTV_YUV_UPDATE_INVALID;\r\n}\r\nosd_scale = (f->src_h << 16) / f->dst_h;\r\nif ((osd_crop = f->pan_y - f->dst_y) > 0) {\r\nf->src_y += (osd_scale * osd_crop) >> 16;\r\nf->src_h -= (osd_scale * osd_crop) >> 16;\r\nf->dst_h -= osd_crop;\r\nf->dst_y = 0;\r\n} else {\r\nf->dst_y -= f->pan_y;\r\n}\r\nif ((osd_crop = f->dst_h + f->dst_y - f->vis_h) > 0) {\r\nf->dst_h -= osd_crop;\r\nf->src_h -= (osd_scale * osd_crop) >> 16;\r\n}\r\nosd_scale = (f->src_w << 16) / f->dst_w;\r\nif ((osd_crop = f->pan_x - f->dst_x) > 0) {\r\nf->src_x += (osd_scale * osd_crop) >> 16;\r\nf->src_w -= (osd_scale * osd_crop) >> 16;\r\nf->dst_w -= osd_crop;\r\nf->dst_x = 0;\r\n} else {\r\nf->dst_x -= f->pan_x;\r\n}\r\nif ((osd_crop = f->dst_w + f->dst_x - f->vis_w) > 0) {\r\nf->dst_w -= osd_crop;\r\nf->src_w -= (osd_scale * osd_crop) >> 16;\r\n}\r\nif (itv->yuv_info.track_osd) {\r\nf->dst_x += itv->yuv_info.osd_x_offset;\r\nf->dst_y += itv->yuv_info.osd_y_offset;\r\n}\r\nf->dst_w &= ~1;\r\nf->dst_x &= ~1;\r\nf->src_w += f->src_x & 1;\r\nf->src_x &= ~1;\r\nf->src_w &= ~1;\r\nf->dst_w &= ~1;\r\nf->dst_h &= ~1;\r\nf->dst_y &= ~1;\r\nf->src_h += f->src_y & 1;\r\nf->src_y &= ~1;\r\nf->src_h &= ~1;\r\nf->dst_h &= ~1;\r\nif (f->dst_w < f->src_w / 4) {\r\nf->src_w &= ~3;\r\nf->dst_w = f->src_w / 4;\r\nf->dst_w += f->dst_w & 1;\r\n}\r\nif (f->dst_h < f->src_h / 4) {\r\nf->src_h &= ~3;\r\nf->dst_h = f->src_h / 4;\r\nf->dst_h += f->dst_h & 1;\r\n}\r\nif ((int)f->dst_w <= 2 || (int)f->dst_h <= 2 ||\r\n(int)f->src_w <= 2 || (int)f->src_h <= 2) {\r\nreturn IVTV_YUV_UPDATE_INVALID;\r\n}\r\nif ((of->dst_w != f->dst_w) || (of->src_w != f->src_w) ||\r\n(of->dst_x != f->dst_x) || (of->src_x != f->src_x) ||\r\n(of->pan_x != f->pan_x) || (of->vis_w != f->vis_w)) {\r\nyuv_update |= IVTV_YUV_UPDATE_HORIZONTAL;\r\n}\r\nif ((of->src_h != f->src_h) || (of->dst_h != f->dst_h) ||\r\n(of->dst_y != f->dst_y) || (of->src_y != f->src_y) ||\r\n(of->pan_y != f->pan_y) || (of->vis_h != f->vis_h) ||\r\n(of->lace_mode != f->lace_mode) ||\r\n(of->interlaced_y != f->interlaced_y) ||\r\n(of->interlaced_uv != f->interlaced_uv)) {\r\nyuv_update |= IVTV_YUV_UPDATE_VERTICAL;\r\n}\r\nreturn yuv_update;\r\n}\r\nvoid ivtv_yuv_work_handler(struct ivtv *itv)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nstruct yuv_frame_info f;\r\nint frame = yi->update_frame;\r\nu32 yuv_update;\r\nIVTV_DEBUG_YUV("Update yuv registers for frame %d\n", frame);\r\nf = yi->new_frame_info[frame];\r\nif (yi->track_osd) {\r\nf.pan_x = yi->osd_x_pan;\r\nf.pan_y = yi->osd_y_pan;\r\nf.vis_w = yi->osd_vis_w;\r\nf.vis_h = yi->osd_vis_h;\r\n} else {\r\nf.pan_x = 0;\r\nf.pan_y = 0;\r\nf.vis_w = 720;\r\nf.vis_h = yi->decode_height;\r\n}\r\nif (!(yuv_update = ivtv_yuv_window_setup(itv, &f)))\r\nreturn;\r\nif (yuv_update & IVTV_YUV_UPDATE_INVALID) {\r\nwrite_reg(0x01008080, 0x2898);\r\n} else if (yuv_update) {\r\nwrite_reg(0x00108080, 0x2898);\r\nif (yuv_update & IVTV_YUV_UPDATE_HORIZONTAL)\r\nivtv_yuv_handle_horizontal(itv, &f);\r\nif (yuv_update & IVTV_YUV_UPDATE_VERTICAL)\r\nivtv_yuv_handle_vertical(itv, &f);\r\n}\r\nyi->old_frame_info = f;\r\n}\r\nstatic void ivtv_yuv_init(struct ivtv *itv)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nIVTV_DEBUG_YUV("ivtv_yuv_init\n");\r\nyi->reg_2834 = read_reg(0x02834);\r\nyi->reg_2838 = read_reg(0x02838);\r\nyi->reg_283c = read_reg(0x0283c);\r\nyi->reg_2840 = read_reg(0x02840);\r\nyi->reg_2844 = read_reg(0x02844);\r\nyi->reg_2848 = read_reg(0x02848);\r\nyi->reg_2854 = read_reg(0x02854);\r\nyi->reg_285c = read_reg(0x0285c);\r\nyi->reg_2864 = read_reg(0x02864);\r\nyi->reg_2870 = read_reg(0x02870);\r\nyi->reg_2874 = read_reg(0x02874);\r\nyi->reg_2898 = read_reg(0x02898);\r\nyi->reg_2890 = read_reg(0x02890);\r\nyi->reg_289c = read_reg(0x0289c);\r\nyi->reg_2918 = read_reg(0x02918);\r\nyi->reg_291c = read_reg(0x0291c);\r\nyi->reg_2920 = read_reg(0x02920);\r\nyi->reg_2924 = read_reg(0x02924);\r\nyi->reg_2928 = read_reg(0x02928);\r\nyi->reg_292c = read_reg(0x0292c);\r\nyi->reg_2930 = read_reg(0x02930);\r\nyi->reg_2934 = read_reg(0x02934);\r\nyi->reg_2938 = read_reg(0x02938);\r\nyi->reg_293c = read_reg(0x0293c);\r\nyi->reg_2940 = read_reg(0x02940);\r\nyi->reg_2944 = read_reg(0x02944);\r\nyi->reg_2948 = read_reg(0x02948);\r\nyi->reg_294c = read_reg(0x0294c);\r\nyi->reg_2950 = read_reg(0x02950);\r\nyi->reg_2954 = read_reg(0x02954);\r\nyi->reg_2958 = read_reg(0x02958);\r\nyi->reg_295c = read_reg(0x0295c);\r\nyi->reg_2960 = read_reg(0x02960);\r\nyi->reg_2964 = read_reg(0x02964);\r\nyi->reg_2968 = read_reg(0x02968);\r\nyi->reg_296c = read_reg(0x0296c);\r\nyi->reg_2970 = read_reg(0x02970);\r\nyi->v_filter_1 = -1;\r\nyi->v_filter_2 = -1;\r\nyi->h_filter = -1;\r\nyi->osd_x_offset = read_reg(0x02a04) & 0x00000FFF;\r\nyi->osd_y_offset = (read_reg(0x02a04) >> 16) & 0x00000FFF;\r\nif (read_reg(0x2878) & 4)\r\nyi->decode_height = 576;\r\nelse\r\nyi->decode_height = 480;\r\nif (!itv->osd_info) {\r\nyi->osd_vis_w = 720 - yi->osd_x_offset;\r\nyi->osd_vis_h = yi->decode_height - yi->osd_y_offset;\r\n} else {\r\nif (!yi->osd_vis_w)\r\nyi->osd_vis_w = 720 - yi->osd_x_offset;\r\nif (!yi->osd_vis_h) {\r\nyi->osd_vis_h = yi->decode_height - yi->osd_y_offset;\r\n} else if (yi->osd_vis_h + yi->osd_y_offset > yi->decode_height) {\r\nIVTV_DEBUG_WARN("Clipping yuv output - fb size (%d) exceeds video standard limit (%d)\n",\r\nyi->osd_vis_h + yi->osd_y_offset,\r\nyi->decode_height);\r\nyi->osd_vis_h = yi->decode_height - yi->osd_y_offset;\r\n}\r\n}\r\nyi->blanking_ptr = kzalloc(720 * 16, GFP_KERNEL|__GFP_NOWARN);\r\nif (yi->blanking_ptr) {\r\nyi->blanking_dmaptr = pci_map_single(itv->pdev, yi->blanking_ptr, 720*16, PCI_DMA_TODEVICE);\r\n} else {\r\nyi->blanking_dmaptr = 0;\r\nIVTV_DEBUG_WARN("Failed to allocate yuv blanking buffer\n");\r\n}\r\nwrite_reg_sync(0x01, IVTV_REG_VDM);\r\nset_bit(IVTV_F_I_DECODING_YUV, &itv->i_flags);\r\natomic_set(&yi->next_dma_frame, 0);\r\n}\r\nstatic void ivtv_yuv_next_free(struct ivtv *itv)\r\n{\r\nint draw, display;\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nif (atomic_read(&yi->next_dma_frame) == -1)\r\nivtv_yuv_init(itv);\r\ndraw = atomic_read(&yi->next_fill_frame);\r\ndisplay = atomic_read(&yi->next_dma_frame);\r\nif (display > draw)\r\ndisplay -= IVTV_YUV_BUFFERS;\r\nif (draw - display >= yi->max_frames_buffered)\r\ndraw = (u8)(draw - 1) % IVTV_YUV_BUFFERS;\r\nelse\r\nyi->new_frame_info[draw].update = 0;\r\nyi->draw_frame = draw;\r\n}\r\nstatic void ivtv_yuv_setup_frame(struct ivtv *itv, struct ivtv_dma_frame *args)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nu8 frame = yi->draw_frame;\r\nu8 last_frame = (u8)(frame - 1) % IVTV_YUV_BUFFERS;\r\nstruct yuv_frame_info *nf = &yi->new_frame_info[frame];\r\nstruct yuv_frame_info *of = &yi->new_frame_info[last_frame];\r\nint lace_threshold = yi->lace_threshold;\r\nint update = nf->update;\r\nnf->src_x = args->src.left;\r\nnf->src_y = args->src.top;\r\nnf->src_w = args->src.width;\r\nnf->src_h = args->src.height;\r\nnf->dst_x = args->dst.left;\r\nnf->dst_y = args->dst.top;\r\nnf->dst_w = args->dst.width;\r\nnf->dst_h = args->dst.height;\r\nnf->tru_x = args->dst.left;\r\nnf->tru_w = args->src_width;\r\nnf->tru_h = args->src_height;\r\nnf->offset_y = (nf->tru_h + nf->src_x < 512 - 16) ? 1 : 0;\r\nnf->update = 0;\r\nnf->interlaced_y = 0;\r\nnf->interlaced_uv = 0;\r\nnf->delay = 0;\r\nnf->sync_field = 0;\r\nnf->lace_mode = yi->lace_mode & IVTV_YUV_MODE_MASK;\r\nif (lace_threshold < 0)\r\nlace_threshold = yi->decode_height - 1;\r\nswitch (nf->lace_mode) {\r\ncase IVTV_YUV_MODE_PROGRESSIVE:\r\nnf->interlaced = 0;\r\nif (nf->tru_h < 512 || (nf->tru_h > 576 && nf->tru_h < 1021))\r\nnf->interlaced_y = 0;\r\nelse\r\nnf->interlaced_y = 1;\r\nif (nf->tru_h < 1021 && (nf->dst_h >= nf->src_h / 2))\r\nnf->interlaced_uv = 0;\r\nelse\r\nnf->interlaced_uv = 1;\r\nbreak;\r\ncase IVTV_YUV_MODE_AUTO:\r\nif (nf->tru_h <= lace_threshold || nf->tru_h > 576 || nf->tru_w > 720) {\r\nnf->interlaced = 0;\r\nif ((nf->tru_h < 512) ||\r\n(nf->tru_h > 576 && nf->tru_h < 1021) ||\r\n(nf->tru_w > 720 && nf->tru_h < 1021))\r\nnf->interlaced_y = 0;\r\nelse\r\nnf->interlaced_y = 1;\r\nif (nf->tru_h < 1021 && (nf->dst_h >= nf->src_h / 2))\r\nnf->interlaced_uv = 0;\r\nelse\r\nnf->interlaced_uv = 1;\r\n} else {\r\nnf->interlaced = 1;\r\nnf->interlaced_y = 1;\r\nnf->interlaced_uv = 1;\r\n}\r\nbreak;\r\ncase IVTV_YUV_MODE_INTERLACED:\r\ndefault:\r\nnf->interlaced = 1;\r\nnf->interlaced_y = 1;\r\nnf->interlaced_uv = 1;\r\nbreak;\r\n}\r\nif (memcmp(&yi->old_frame_info_args, nf, sizeof(*nf))) {\r\nyi->old_frame_info_args = *nf;\r\nnf->update = 1;\r\nIVTV_DEBUG_YUV("Requesting reg update for frame %d\n", frame);\r\n}\r\nnf->update |= update;\r\nnf->sync_field = yi->lace_sync_field;\r\nnf->delay = nf->sync_field != of->sync_field;\r\n}\r\nvoid ivtv_yuv_frame_complete(struct ivtv *itv)\r\n{\r\natomic_set(&itv->yuv_info.next_fill_frame,\r\n(itv->yuv_info.draw_frame + 1) % IVTV_YUV_BUFFERS);\r\n}\r\nstatic int ivtv_yuv_udma_frame(struct ivtv *itv, struct ivtv_dma_frame *args)\r\n{\r\nDEFINE_WAIT(wait);\r\nint rc = 0;\r\nint got_sig = 0;\r\nmutex_lock(&itv->udma.lock);\r\nif ((rc = ivtv_yuv_prep_user_dma(itv, &itv->udma, args)) != 0) {\r\nmutex_unlock(&itv->udma.lock);\r\nreturn rc;\r\n}\r\nivtv_udma_prepare(itv);\r\nprepare_to_wait(&itv->dma_waitq, &wait, TASK_INTERRUPTIBLE);\r\nwhile (test_bit(IVTV_F_I_UDMA_PENDING, &itv->i_flags) ||\r\ntest_bit(IVTV_F_I_UDMA, &itv->i_flags)) {\r\ngot_sig = signal_pending(current);\r\nif (got_sig && test_and_clear_bit(IVTV_F_I_UDMA_PENDING, &itv->i_flags))\r\nbreak;\r\ngot_sig = 0;\r\nschedule();\r\n}\r\nfinish_wait(&itv->dma_waitq, &wait);\r\nivtv_udma_unmap(itv);\r\nif (got_sig) {\r\nIVTV_DEBUG_INFO("User stopped YUV UDMA\n");\r\nmutex_unlock(&itv->udma.lock);\r\nreturn -EINTR;\r\n}\r\nivtv_yuv_frame_complete(itv);\r\nmutex_unlock(&itv->udma.lock);\r\nreturn rc;\r\n}\r\nvoid ivtv_yuv_setup_stream_frame(struct ivtv *itv)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nstruct ivtv_dma_frame dma_args;\r\nivtv_yuv_next_free(itv);\r\ndma_args.y_source = NULL;\r\ndma_args.uv_source = NULL;\r\ndma_args.src.left = 0;\r\ndma_args.src.top = 0;\r\ndma_args.src.width = yi->v4l2_src_w;\r\ndma_args.src.height = yi->v4l2_src_h;\r\ndma_args.dst = yi->main_rect;\r\ndma_args.src_width = yi->v4l2_src_w;\r\ndma_args.src_height = yi->v4l2_src_h;\r\nivtv_yuv_setup_frame(itv, &dma_args);\r\nif (!itv->dma_data_req_offset)\r\nitv->dma_data_req_offset = yuv_offset[yi->draw_frame];\r\n}\r\nint ivtv_yuv_udma_stream_frame(struct ivtv *itv, void __user *src)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nstruct ivtv_dma_frame dma_args;\r\nint res;\r\nivtv_yuv_setup_stream_frame(itv);\r\ndma_args.y_source = src;\r\ndma_args.uv_source = src + 720 * ((yi->v4l2_src_h + 31) & ~31);\r\nmutex_unlock(&itv->serialize_lock);\r\nres = ivtv_yuv_udma_frame(itv, &dma_args);\r\nmutex_lock(&itv->serialize_lock);\r\nreturn res;\r\n}\r\nint ivtv_yuv_prep_frame(struct ivtv *itv, struct ivtv_dma_frame *args)\r\n{\r\nint res;\r\nivtv_yuv_next_free(itv);\r\nivtv_yuv_setup_frame(itv, args);\r\nmutex_unlock(&itv->serialize_lock);\r\nres = ivtv_yuv_udma_frame(itv, args);\r\nmutex_lock(&itv->serialize_lock);\r\nreturn res;\r\n}\r\nvoid ivtv_yuv_close(struct ivtv *itv)\r\n{\r\nstruct yuv_playback_info *yi = &itv->yuv_info;\r\nint h_filter, v_filter_1, v_filter_2;\r\nIVTV_DEBUG_YUV("ivtv_yuv_close\n");\r\nmutex_unlock(&itv->serialize_lock);\r\nivtv_waitq(&itv->vsync_waitq);\r\nmutex_lock(&itv->serialize_lock);\r\nyi->running = 0;\r\natomic_set(&yi->next_dma_frame, -1);\r\natomic_set(&yi->next_fill_frame, 0);\r\nwrite_reg(yi->reg_2898 | 0x01000000, 0x2898);\r\nwrite_reg(yi->reg_2834, 0x02834);\r\nwrite_reg(yi->reg_2838, 0x02838);\r\nwrite_reg(yi->reg_283c, 0x0283c);\r\nwrite_reg(yi->reg_2840, 0x02840);\r\nwrite_reg(yi->reg_2844, 0x02844);\r\nwrite_reg(yi->reg_2848, 0x02848);\r\nwrite_reg(yi->reg_2854, 0x02854);\r\nwrite_reg(yi->reg_285c, 0x0285c);\r\nwrite_reg(yi->reg_2864, 0x02864);\r\nwrite_reg(yi->reg_2870, 0x02870);\r\nwrite_reg(yi->reg_2874, 0x02874);\r\nwrite_reg(yi->reg_2890, 0x02890);\r\nwrite_reg(yi->reg_289c, 0x0289c);\r\nwrite_reg(yi->reg_2918, 0x02918);\r\nwrite_reg(yi->reg_291c, 0x0291c);\r\nwrite_reg(yi->reg_2920, 0x02920);\r\nwrite_reg(yi->reg_2924, 0x02924);\r\nwrite_reg(yi->reg_2928, 0x02928);\r\nwrite_reg(yi->reg_292c, 0x0292c);\r\nwrite_reg(yi->reg_2930, 0x02930);\r\nwrite_reg(yi->reg_2934, 0x02934);\r\nwrite_reg(yi->reg_2938, 0x02938);\r\nwrite_reg(yi->reg_293c, 0x0293c);\r\nwrite_reg(yi->reg_2940, 0x02940);\r\nwrite_reg(yi->reg_2944, 0x02944);\r\nwrite_reg(yi->reg_2948, 0x02948);\r\nwrite_reg(yi->reg_294c, 0x0294c);\r\nwrite_reg(yi->reg_2950, 0x02950);\r\nwrite_reg(yi->reg_2954, 0x02954);\r\nwrite_reg(yi->reg_2958, 0x02958);\r\nwrite_reg(yi->reg_295c, 0x0295c);\r\nwrite_reg(yi->reg_2960, 0x02960);\r\nwrite_reg(yi->reg_2964, 0x02964);\r\nwrite_reg(yi->reg_2968, 0x02968);\r\nwrite_reg(yi->reg_296c, 0x0296c);\r\nwrite_reg(yi->reg_2970, 0x02970);\r\nif ((yi->reg_2834 & 0x0000FFFF) == (yi->reg_2834 >> 16)) {\r\nh_filter = 0;\r\n} else {\r\nh_filter = ((yi->reg_2834 << 16) / (yi->reg_2834 >> 16)) >> 15;\r\nh_filter = (h_filter >> 1) + (h_filter & 1);\r\nh_filter += !h_filter;\r\n}\r\nif ((yi->reg_2918 & 0x0000FFFF) == (yi->reg_2918 >> 16)) {\r\nv_filter_1 = 0;\r\nv_filter_2 = 1;\r\n} else {\r\nv_filter_1 = ((yi->reg_2918 << 16) / (yi->reg_2918 >> 16)) >> 15;\r\nv_filter_1 = (v_filter_1 >> 1) + (v_filter_1 & 1);\r\nv_filter_1 += !v_filter_1;\r\nv_filter_2 = v_filter_1;\r\n}\r\nivtv_yuv_filter(itv, h_filter, v_filter_1, v_filter_2);\r\nwrite_reg(0, 0x02814);\r\nwrite_reg(0, 0x0282c);\r\nwrite_reg(0, 0x02904);\r\nwrite_reg(0, 0x02910);\r\nif (yi->blanking_ptr) {\r\nkfree(yi->blanking_ptr);\r\nyi->blanking_ptr = NULL;\r\npci_unmap_single(itv->pdev, yi->blanking_dmaptr, 720*16, PCI_DMA_TODEVICE);\r\n}\r\nyi->old_frame_info.src_w = 0;\r\nyi->old_frame_info.src_h = 0;\r\nyi->old_frame_info_args.src_w = 0;\r\nyi->old_frame_info_args.src_h = 0;\r\nclear_bit(IVTV_F_I_DECODING_YUV, &itv->i_flags);\r\n}

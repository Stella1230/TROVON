void hfi1_put_txreq(struct verbs_txreq *tx)\r\n{\r\nstruct hfi1_ibdev *dev;\r\nstruct rvt_qp *qp;\r\nunsigned long flags;\r\nunsigned int seq;\r\nstruct hfi1_qp_priv *priv;\r\nqp = tx->qp;\r\ndev = to_idev(qp->ibqp.device);\r\nif (tx->mr)\r\nrvt_put_mr(tx->mr);\r\nsdma_txclean(dd_from_dev(dev), &tx->txreq);\r\nkmem_cache_free(dev->verbs_txreq_cache, tx);\r\ndo {\r\nseq = read_seqbegin(&dev->iowait_lock);\r\nif (!list_empty(&dev->txwait)) {\r\nstruct iowait *wait;\r\nwrite_seqlock_irqsave(&dev->iowait_lock, flags);\r\nwait = list_first_entry(&dev->txwait, struct iowait,\r\nlist);\r\nqp = iowait_to_qp(wait);\r\npriv = qp->priv;\r\nlist_del_init(&priv->s_iowait.list);\r\nwrite_sequnlock_irqrestore(&dev->iowait_lock, flags);\r\nhfi1_qp_wakeup(qp, RVT_S_WAIT_TX);\r\nbreak;\r\n}\r\n} while (read_seqretry(&dev->iowait_lock, seq));\r\n}\r\nstruct verbs_txreq *__get_txreq(struct hfi1_ibdev *dev,\r\nstruct rvt_qp *qp)\r\n__must_hold(&qp->s_lock\r\nstatic void verbs_txreq_kmem_cache_ctor(void *obj)\r\n{\r\nstruct verbs_txreq *tx = (struct verbs_txreq *)obj;\r\nmemset(tx, 0, sizeof(*tx));\r\n}\r\nint verbs_txreq_init(struct hfi1_ibdev *dev)\r\n{\r\nchar buf[TXREQ_LEN];\r\nstruct hfi1_devdata *dd = dd_from_dev(dev);\r\nsnprintf(buf, sizeof(buf), "hfi1_%u_vtxreq_cache", dd->unit);\r\ndev->verbs_txreq_cache = kmem_cache_create(buf,\r\nsizeof(struct verbs_txreq),\r\n0, SLAB_HWCACHE_ALIGN,\r\nverbs_txreq_kmem_cache_ctor);\r\nif (!dev->verbs_txreq_cache)\r\nreturn -ENOMEM;\r\nreturn 0;\r\n}\r\nvoid verbs_txreq_exit(struct hfi1_ibdev *dev)\r\n{\r\nkmem_cache_destroy(dev->verbs_txreq_cache);\r\ndev->verbs_txreq_cache = NULL;\r\n}

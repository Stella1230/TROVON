static u8 *udl_get_edid(struct udl_device *udl)\r\n{\r\nu8 *block;\r\nchar *rbuf;\r\nint ret, i;\r\nblock = kmalloc(EDID_LENGTH, GFP_KERNEL);\r\nif (block == NULL)\r\nreturn NULL;\r\nrbuf = kmalloc(2, GFP_KERNEL);\r\nif (rbuf == NULL)\r\ngoto error;\r\nfor (i = 0; i < EDID_LENGTH; i++) {\r\nret = usb_control_msg(udl->udev,\r\nusb_rcvctrlpipe(udl->udev, 0), (0x02),\r\n(0x80 | (0x02 << 5)), i << 8, 0xA1, rbuf, 2,\r\nHZ);\r\nif (ret < 1) {\r\nDRM_ERROR("Read EDID byte %d failed err %x\n", i, ret);\r\ngoto error;\r\n}\r\nblock[i] = rbuf[1];\r\n}\r\nkfree(rbuf);\r\nreturn block;\r\nerror:\r\nkfree(block);\r\nkfree(rbuf);\r\nreturn NULL;\r\n}\r\nstatic int udl_get_modes(struct drm_connector *connector)\r\n{\r\nstruct udl_device *udl = connector->dev->dev_private;\r\nstruct edid *edid;\r\nint ret;\r\nedid = (struct edid *)udl_get_edid(udl);\r\nif (!edid) {\r\ndrm_mode_connector_update_edid_property(connector, NULL);\r\nreturn 0;\r\n}\r\nedid->checksum += edid->extensions;\r\nedid->extensions = 0;\r\ndrm_mode_connector_update_edid_property(connector, edid);\r\nret = drm_add_edid_modes(connector, edid);\r\nkfree(edid);\r\nreturn ret;\r\n}\r\nstatic int udl_mode_valid(struct drm_connector *connector,\r\nstruct drm_display_mode *mode)\r\n{\r\nstruct udl_device *udl = connector->dev->dev_private;\r\nif (!udl->sku_pixel_limit)\r\nreturn 0;\r\nif (mode->vdisplay * mode->hdisplay > udl->sku_pixel_limit)\r\nreturn MODE_VIRTUAL_Y;\r\nreturn 0;\r\n}\r\nstatic enum drm_connector_status\r\nudl_detect(struct drm_connector *connector, bool force)\r\n{\r\nif (drm_device_is_unplugged(connector->dev))\r\nreturn connector_status_disconnected;\r\nreturn connector_status_connected;\r\n}\r\nstatic struct drm_encoder*\r\nudl_best_single_encoder(struct drm_connector *connector)\r\n{\r\nint enc_id = connector->encoder_ids[0];\r\nreturn drm_encoder_find(connector->dev, enc_id);\r\n}\r\nstatic int udl_connector_set_property(struct drm_connector *connector,\r\nstruct drm_property *property,\r\nuint64_t val)\r\n{\r\nreturn 0;\r\n}\r\nstatic void udl_connector_destroy(struct drm_connector *connector)\r\n{\r\ndrm_connector_unregister(connector);\r\ndrm_connector_cleanup(connector);\r\nkfree(connector);\r\n}\r\nint udl_connector_init(struct drm_device *dev, struct drm_encoder *encoder)\r\n{\r\nstruct drm_connector *connector;\r\nconnector = kzalloc(sizeof(struct drm_connector), GFP_KERNEL);\r\nif (!connector)\r\nreturn -ENOMEM;\r\ndrm_connector_init(dev, connector, &udl_connector_funcs, DRM_MODE_CONNECTOR_DVII);\r\ndrm_connector_helper_add(connector, &udl_connector_helper_funcs);\r\ndrm_connector_register(connector);\r\ndrm_mode_connector_attach_encoder(connector, encoder);\r\ndrm_object_attach_property(&connector->base,\r\ndev->mode_config.dirty_info_property,\r\n1);\r\nreturn 0;\r\n}

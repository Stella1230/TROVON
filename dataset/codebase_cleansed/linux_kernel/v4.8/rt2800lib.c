static inline bool rt2800_is_305x_soc(struct rt2x00_dev *rt2x00dev)\r\n{\r\nif (!rt2x00_is_soc(rt2x00dev) ||\r\n!rt2x00_rt(rt2x00dev, RT2872))\r\nreturn false;\r\nif (rt2x00_rf(rt2x00dev, RF3020) ||\r\nrt2x00_rf(rt2x00dev, RF3021) ||\r\nrt2x00_rf(rt2x00dev, RF3022))\r\nreturn true;\r\nrt2x00_warn(rt2x00dev, "Unknown RF chipset on rt305x\n");\r\nreturn false;\r\n}\r\nstatic void rt2800_bbp_write(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int word, const u8 value)\r\n{\r\nu32 reg;\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nif (WAIT_FOR_BBP(rt2x00dev, &reg)) {\r\nreg = 0;\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_VALUE, value);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_REGNUM, word);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_BUSY, 1);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_READ_CONTROL, 0);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_BBP_RW_MODE, 1);\r\nrt2800_register_write_lock(rt2x00dev, BBP_CSR_CFG, reg);\r\n}\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nstatic void rt2800_bbp_read(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int word, u8 *value)\r\n{\r\nu32 reg;\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nif (WAIT_FOR_BBP(rt2x00dev, &reg)) {\r\nreg = 0;\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_REGNUM, word);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_BUSY, 1);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_READ_CONTROL, 1);\r\nrt2x00_set_field32(&reg, BBP_CSR_CFG_BBP_RW_MODE, 1);\r\nrt2800_register_write_lock(rt2x00dev, BBP_CSR_CFG, reg);\r\nWAIT_FOR_BBP(rt2x00dev, &reg);\r\n}\r\n*value = rt2x00_get_field32(reg, BBP_CSR_CFG_VALUE);\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nstatic void rt2800_rfcsr_write(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int word, const u8 value)\r\n{\r\nu32 reg;\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nif (WAIT_FOR_RFCSR(rt2x00dev, &reg)) {\r\nreg = 0;\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_DATA, value);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_REGNUM, word);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_WRITE, 1);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_BUSY, 1);\r\nrt2800_register_write_lock(rt2x00dev, RF_CSR_CFG, reg);\r\n}\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nstatic void rt2800_rfcsr_read(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int word, u8 *value)\r\n{\r\nu32 reg;\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nif (WAIT_FOR_RFCSR(rt2x00dev, &reg)) {\r\nreg = 0;\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_REGNUM, word);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_WRITE, 0);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG_BUSY, 1);\r\nrt2800_register_write_lock(rt2x00dev, RF_CSR_CFG, reg);\r\nWAIT_FOR_RFCSR(rt2x00dev, &reg);\r\n}\r\n*value = rt2x00_get_field32(reg, RF_CSR_CFG_DATA);\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nstatic void rt2800_rf_write(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int word, const u32 value)\r\n{\r\nu32 reg;\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nif (WAIT_FOR_RF(rt2x00dev, &reg)) {\r\nreg = 0;\r\nrt2x00_set_field32(&reg, RF_CSR_CFG0_REG_VALUE_BW, value);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG0_STANDBYMODE, 0);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG0_SEL, 0);\r\nrt2x00_set_field32(&reg, RF_CSR_CFG0_BUSY, 1);\r\nrt2800_register_write_lock(rt2x00dev, RF_CSR_CFG0, reg);\r\nrt2x00_rf_write(rt2x00dev, word, value);\r\n}\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nstatic unsigned int rt2800_eeprom_word_index(struct rt2x00_dev *rt2x00dev,\r\nconst enum rt2800_eeprom_word word)\r\n{\r\nconst unsigned int *map;\r\nunsigned int index;\r\nif (WARN_ONCE(word >= EEPROM_WORD_COUNT,\r\n"%s: invalid EEPROM word %d\n",\r\nwiphy_name(rt2x00dev->hw->wiphy), word))\r\nreturn 0;\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nmap = rt2800_eeprom_map_ext;\r\nelse\r\nmap = rt2800_eeprom_map;\r\nindex = map[word];\r\nWARN_ONCE(word != EEPROM_CHIP_ID && index == 0,\r\n"%s: invalid access of EEPROM word %d\n",\r\nwiphy_name(rt2x00dev->hw->wiphy), word);\r\nreturn index;\r\n}\r\nstatic void *rt2800_eeprom_addr(struct rt2x00_dev *rt2x00dev,\r\nconst enum rt2800_eeprom_word word)\r\n{\r\nunsigned int index;\r\nindex = rt2800_eeprom_word_index(rt2x00dev, word);\r\nreturn rt2x00_eeprom_addr(rt2x00dev, index);\r\n}\r\nstatic void rt2800_eeprom_read(struct rt2x00_dev *rt2x00dev,\r\nconst enum rt2800_eeprom_word word, u16 *data)\r\n{\r\nunsigned int index;\r\nindex = rt2800_eeprom_word_index(rt2x00dev, word);\r\nrt2x00_eeprom_read(rt2x00dev, index, data);\r\n}\r\nstatic void rt2800_eeprom_write(struct rt2x00_dev *rt2x00dev,\r\nconst enum rt2800_eeprom_word word, u16 data)\r\n{\r\nunsigned int index;\r\nindex = rt2800_eeprom_word_index(rt2x00dev, word);\r\nrt2x00_eeprom_write(rt2x00dev, index, data);\r\n}\r\nstatic void rt2800_eeprom_read_from_array(struct rt2x00_dev *rt2x00dev,\r\nconst enum rt2800_eeprom_word array,\r\nunsigned int offset,\r\nu16 *data)\r\n{\r\nunsigned int index;\r\nindex = rt2800_eeprom_word_index(rt2x00dev, array);\r\nrt2x00_eeprom_read(rt2x00dev, index + offset, data);\r\n}\r\nstatic int rt2800_enable_wlan_rt3290(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nint i, count;\r\nrt2800_register_read(rt2x00dev, WLAN_FUN_CTRL, &reg);\r\nif (rt2x00_get_field32(reg, WLAN_EN))\r\nreturn 0;\r\nrt2x00_set_field32(&reg, WLAN_GPIO_OUT_OE_BIT_ALL, 0xff);\r\nrt2x00_set_field32(&reg, FRC_WL_ANT_SET, 1);\r\nrt2x00_set_field32(&reg, WLAN_CLK_EN, 0);\r\nrt2x00_set_field32(&reg, WLAN_EN, 1);\r\nrt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\r\nudelay(REGISTER_BUSY_DELAY);\r\ncount = 0;\r\ndo {\r\nfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\r\nrt2800_register_read(rt2x00dev, CMB_CTRL, &reg);\r\nif (rt2x00_get_field32(reg, PLL_LD) &&\r\nrt2x00_get_field32(reg, XTAL_RDY))\r\nbreak;\r\nudelay(REGISTER_BUSY_DELAY);\r\n}\r\nif (i >= REGISTER_BUSY_COUNT) {\r\nif (count >= 10)\r\nreturn -EIO;\r\nrt2800_register_write(rt2x00dev, 0x58, 0x018);\r\nudelay(REGISTER_BUSY_DELAY);\r\nrt2800_register_write(rt2x00dev, 0x58, 0x418);\r\nudelay(REGISTER_BUSY_DELAY);\r\nrt2800_register_write(rt2x00dev, 0x58, 0x618);\r\nudelay(REGISTER_BUSY_DELAY);\r\ncount++;\r\n} else {\r\ncount = 0;\r\n}\r\nrt2800_register_read(rt2x00dev, WLAN_FUN_CTRL, &reg);\r\nrt2x00_set_field32(&reg, PCIE_APP0_CLK_REQ, 0);\r\nrt2x00_set_field32(&reg, WLAN_CLK_EN, 1);\r\nrt2x00_set_field32(&reg, WLAN_RESET, 1);\r\nrt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\r\nudelay(10);\r\nrt2x00_set_field32(&reg, WLAN_RESET, 0);\r\nrt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\r\nudelay(10);\r\nrt2800_register_write(rt2x00dev, INT_SOURCE_CSR, 0x7fffffff);\r\n} while (count != 0);\r\nreturn 0;\r\n}\r\nvoid rt2800_mcu_request(struct rt2x00_dev *rt2x00dev,\r\nconst u8 command, const u8 token,\r\nconst u8 arg0, const u8 arg1)\r\n{\r\nu32 reg;\r\nif (rt2x00_is_soc(rt2x00dev))\r\nreturn;\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nif (WAIT_FOR_MCU(rt2x00dev, &reg)) {\r\nrt2x00_set_field32(&reg, H2M_MAILBOX_CSR_OWNER, 1);\r\nrt2x00_set_field32(&reg, H2M_MAILBOX_CSR_CMD_TOKEN, token);\r\nrt2x00_set_field32(&reg, H2M_MAILBOX_CSR_ARG0, arg0);\r\nrt2x00_set_field32(&reg, H2M_MAILBOX_CSR_ARG1, arg1);\r\nrt2800_register_write_lock(rt2x00dev, H2M_MAILBOX_CSR, reg);\r\nreg = 0;\r\nrt2x00_set_field32(&reg, HOST_CMD_CSR_HOST_COMMAND, command);\r\nrt2800_register_write_lock(rt2x00dev, HOST_CMD_CSR, reg);\r\n}\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nint rt2800_wait_csr_ready(struct rt2x00_dev *rt2x00dev)\r\n{\r\nunsigned int i = 0;\r\nu32 reg;\r\nfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\r\nrt2800_register_read(rt2x00dev, MAC_CSR0, &reg);\r\nif (reg && reg != ~0)\r\nreturn 0;\r\nmsleep(1);\r\n}\r\nrt2x00_err(rt2x00dev, "Unstable hardware\n");\r\nreturn -EBUSY;\r\n}\r\nint rt2800_wait_wpdma_ready(struct rt2x00_dev *rt2x00dev)\r\n{\r\nunsigned int i;\r\nu32 reg;\r\nfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\r\nrt2800_register_read(rt2x00dev, WPDMA_GLO_CFG, &reg);\r\nif (!rt2x00_get_field32(reg, WPDMA_GLO_CFG_TX_DMA_BUSY) &&\r\n!rt2x00_get_field32(reg, WPDMA_GLO_CFG_RX_DMA_BUSY))\r\nreturn 0;\r\nmsleep(10);\r\n}\r\nrt2x00_err(rt2x00dev, "WPDMA TX/RX busy [0x%08x]\n", reg);\r\nreturn -EACCES;\r\n}\r\nvoid rt2800_disable_wpdma(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, WPDMA_GLO_CFG, &reg);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_TX_DMA, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_DMA_BUSY, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_RX_DMA, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_RX_DMA_BUSY, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_WRITEBACK_DONE, 1);\r\nrt2800_register_write(rt2x00dev, WPDMA_GLO_CFG, reg);\r\n}\r\nvoid rt2800_get_txwi_rxwi_size(struct rt2x00_dev *rt2x00dev,\r\nunsigned short *txwi_size,\r\nunsigned short *rxwi_size)\r\n{\r\nswitch (rt2x00dev->chip.rt) {\r\ncase RT3593:\r\n*txwi_size = TXWI_DESC_SIZE_4WORDS;\r\n*rxwi_size = RXWI_DESC_SIZE_5WORDS;\r\nbreak;\r\ncase RT5592:\r\n*txwi_size = TXWI_DESC_SIZE_5WORDS;\r\n*rxwi_size = RXWI_DESC_SIZE_6WORDS;\r\nbreak;\r\ndefault:\r\n*txwi_size = TXWI_DESC_SIZE_4WORDS;\r\n*rxwi_size = RXWI_DESC_SIZE_4WORDS;\r\nbreak;\r\n}\r\n}\r\nstatic bool rt2800_check_firmware_crc(const u8 *data, const size_t len)\r\n{\r\nu16 fw_crc;\r\nu16 crc;\r\nfw_crc = (data[len - 2] << 8 | data[len - 1]);\r\ncrc = crc_ccitt(~0, data, len - 2);\r\ncrc = swab16(crc);\r\nreturn fw_crc == crc;\r\n}\r\nint rt2800_check_firmware(struct rt2x00_dev *rt2x00dev,\r\nconst u8 *data, const size_t len)\r\n{\r\nsize_t offset = 0;\r\nsize_t fw_len;\r\nbool multiple;\r\nif (rt2x00_is_usb(rt2x00dev) || rt2x00_rt(rt2x00dev, RT3290))\r\nfw_len = 4096;\r\nelse\r\nfw_len = 8192;\r\nmultiple = true;\r\nif (len != fw_len && (!multiple || (len % fw_len) != 0))\r\nreturn FW_BAD_LENGTH;\r\nif (rt2x00_is_usb(rt2x00dev) &&\r\n!rt2x00_rt(rt2x00dev, RT2860) &&\r\n!rt2x00_rt(rt2x00dev, RT2872) &&\r\n!rt2x00_rt(rt2x00dev, RT3070) &&\r\n((len / fw_len) == 1))\r\nreturn FW_BAD_VERSION;\r\nwhile (offset < len) {\r\nif (!rt2800_check_firmware_crc(data + offset, fw_len))\r\nreturn FW_BAD_CRC;\r\noffset += fw_len;\r\n}\r\nreturn FW_OK;\r\n}\r\nint rt2800_load_firmware(struct rt2x00_dev *rt2x00dev,\r\nconst u8 *data, const size_t len)\r\n{\r\nunsigned int i;\r\nu32 reg;\r\nint retval;\r\nif (rt2x00_rt(rt2x00dev, RT3290)) {\r\nretval = rt2800_enable_wlan_rt3290(rt2x00dev);\r\nif (retval)\r\nreturn -EBUSY;\r\n}\r\nrt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, 0x00000000);\r\nif (rt2800_wait_csr_ready(rt2x00dev))\r\nreturn -EBUSY;\r\nif (rt2x00_is_pci(rt2x00dev)) {\r\nif (rt2x00_rt(rt2x00dev, RT3290) ||\r\nrt2x00_rt(rt2x00dev, RT3572) ||\r\nrt2x00_rt(rt2x00dev, RT5390) ||\r\nrt2x00_rt(rt2x00dev, RT5392)) {\r\nrt2800_register_read(rt2x00dev, AUX_CTRL, &reg);\r\nrt2x00_set_field32(&reg, AUX_CTRL_FORCE_PCIE_CLK, 1);\r\nrt2x00_set_field32(&reg, AUX_CTRL_WAKE_PCIE_EN, 1);\r\nrt2800_register_write(rt2x00dev, AUX_CTRL, reg);\r\n}\r\nrt2800_register_write(rt2x00dev, PWR_PIN_CFG, 0x00000002);\r\n}\r\nrt2800_disable_wpdma(rt2x00dev);\r\nrt2800_drv_write_firmware(rt2x00dev, data, len);\r\nfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\r\nrt2800_register_read(rt2x00dev, PBF_SYS_CTRL, &reg);\r\nif (rt2x00_get_field32(reg, PBF_SYS_CTRL_READY))\r\nbreak;\r\nmsleep(1);\r\n}\r\nif (i == REGISTER_BUSY_COUNT) {\r\nrt2x00_err(rt2x00dev, "PBF system register not ready\n");\r\nreturn -EBUSY;\r\n}\r\nrt2800_disable_wpdma(rt2x00dev);\r\nrt2800_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\r\nrt2800_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\r\nif (rt2x00_is_usb(rt2x00dev)) {\r\nrt2800_register_write(rt2x00dev, H2M_INT_SRC, 0);\r\nrt2800_mcu_request(rt2x00dev, MCU_BOOT_SIGNAL, 0, 0, 0);\r\n}\r\nmsleep(1);\r\nreturn 0;\r\n}\r\nvoid rt2800_write_tx_data(struct queue_entry *entry,\r\nstruct txentry_desc *txdesc)\r\n{\r\n__le32 *txwi = rt2800_drv_get_txwi(entry);\r\nu32 word;\r\nint i;\r\nrt2x00_desc_read(txwi, 0, &word);\r\nrt2x00_set_field32(&word, TXWI_W0_FRAG,\r\ntest_bit(ENTRY_TXD_MORE_FRAG, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W0_MIMO_PS,\r\ntest_bit(ENTRY_TXD_HT_MIMO_PS, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W0_CF_ACK, 0);\r\nrt2x00_set_field32(&word, TXWI_W0_TS,\r\ntest_bit(ENTRY_TXD_REQ_TIMESTAMP, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W0_AMPDU,\r\ntest_bit(ENTRY_TXD_HT_AMPDU, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W0_MPDU_DENSITY,\r\ntxdesc->u.ht.mpdu_density);\r\nrt2x00_set_field32(&word, TXWI_W0_TX_OP, txdesc->u.ht.txop);\r\nrt2x00_set_field32(&word, TXWI_W0_MCS, txdesc->u.ht.mcs);\r\nrt2x00_set_field32(&word, TXWI_W0_BW,\r\ntest_bit(ENTRY_TXD_HT_BW_40, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W0_SHORT_GI,\r\ntest_bit(ENTRY_TXD_HT_SHORT_GI, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W0_STBC, txdesc->u.ht.stbc);\r\nrt2x00_set_field32(&word, TXWI_W0_PHYMODE, txdesc->rate_mode);\r\nrt2x00_desc_write(txwi, 0, word);\r\nrt2x00_desc_read(txwi, 1, &word);\r\nrt2x00_set_field32(&word, TXWI_W1_ACK,\r\ntest_bit(ENTRY_TXD_ACK, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W1_NSEQ,\r\ntest_bit(ENTRY_TXD_GENERATE_SEQ, &txdesc->flags));\r\nrt2x00_set_field32(&word, TXWI_W1_BW_WIN_SIZE, txdesc->u.ht.ba_size);\r\nrt2x00_set_field32(&word, TXWI_W1_WIRELESS_CLI_ID,\r\ntest_bit(ENTRY_TXD_ENCRYPT, &txdesc->flags) ?\r\ntxdesc->key_idx : txdesc->u.ht.wcid);\r\nrt2x00_set_field32(&word, TXWI_W1_MPDU_TOTAL_BYTE_COUNT,\r\ntxdesc->length);\r\nrt2x00_set_field32(&word, TXWI_W1_PACKETID_QUEUE, entry->queue->qid);\r\nrt2x00_set_field32(&word, TXWI_W1_PACKETID_ENTRY, (entry->entry_idx % 3) + 1);\r\nrt2x00_desc_write(txwi, 1, word);\r\nfor (i = 2; i < entry->queue->winfo_size / sizeof(__le32); i++)\r\n_rt2x00_desc_write(txwi, i, 0);\r\n}\r\nstatic int rt2800_agc_to_rssi(struct rt2x00_dev *rt2x00dev, u32 rxwi_w2)\r\n{\r\ns8 rssi0 = rt2x00_get_field32(rxwi_w2, RXWI_W2_RSSI0);\r\ns8 rssi1 = rt2x00_get_field32(rxwi_w2, RXWI_W2_RSSI1);\r\ns8 rssi2 = rt2x00_get_field32(rxwi_w2, RXWI_W2_RSSI2);\r\nu16 eeprom;\r\nu8 offset0;\r\nu8 offset1;\r\nu8 offset2;\r\nif (rt2x00dev->curr_band == NL80211_BAND_2GHZ) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG, &eeprom);\r\noffset0 = rt2x00_get_field16(eeprom, EEPROM_RSSI_BG_OFFSET0);\r\noffset1 = rt2x00_get_field16(eeprom, EEPROM_RSSI_BG_OFFSET1);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG2, &eeprom);\r\noffset2 = rt2x00_get_field16(eeprom, EEPROM_RSSI_BG2_OFFSET2);\r\n} else {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A, &eeprom);\r\noffset0 = rt2x00_get_field16(eeprom, EEPROM_RSSI_A_OFFSET0);\r\noffset1 = rt2x00_get_field16(eeprom, EEPROM_RSSI_A_OFFSET1);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A2, &eeprom);\r\noffset2 = rt2x00_get_field16(eeprom, EEPROM_RSSI_A2_OFFSET2);\r\n}\r\nrssi0 = (rssi0) ? (-12 - offset0 - rt2x00dev->lna_gain - rssi0) : -128;\r\nrssi1 = (rssi1) ? (-12 - offset1 - rt2x00dev->lna_gain - rssi1) : -128;\r\nrssi2 = (rssi2) ? (-12 - offset2 - rt2x00dev->lna_gain - rssi2) : -128;\r\nrssi0 = max(rssi0, rssi1);\r\nreturn (int)max(rssi0, rssi2);\r\n}\r\nvoid rt2800_process_rxwi(struct queue_entry *entry,\r\nstruct rxdone_entry_desc *rxdesc)\r\n{\r\n__le32 *rxwi = (__le32 *) entry->skb->data;\r\nu32 word;\r\nrt2x00_desc_read(rxwi, 0, &word);\r\nrxdesc->cipher = rt2x00_get_field32(word, RXWI_W0_UDF);\r\nrxdesc->size = rt2x00_get_field32(word, RXWI_W0_MPDU_TOTAL_BYTE_COUNT);\r\nrt2x00_desc_read(rxwi, 1, &word);\r\nif (rt2x00_get_field32(word, RXWI_W1_SHORT_GI))\r\nrxdesc->flags |= RX_FLAG_SHORT_GI;\r\nif (rt2x00_get_field32(word, RXWI_W1_BW))\r\nrxdesc->flags |= RX_FLAG_40MHZ;\r\nrxdesc->dev_flags |= RXDONE_SIGNAL_MCS;\r\nrxdesc->signal = rt2x00_get_field32(word, RXWI_W1_MCS);\r\nrxdesc->rate_mode = rt2x00_get_field32(word, RXWI_W1_PHYMODE);\r\nif (rxdesc->rate_mode == RATE_MODE_CCK)\r\nrxdesc->signal &= ~0x8;\r\nrt2x00_desc_read(rxwi, 2, &word);\r\nrxdesc->rssi = rt2800_agc_to_rssi(entry->queue->rt2x00dev, word);\r\nskb_pull(entry->skb, entry->queue->winfo_size);\r\n}\r\nvoid rt2800_txdone_entry(struct queue_entry *entry, u32 status, __le32 *txwi)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = entry->queue->rt2x00dev;\r\nstruct skb_frame_desc *skbdesc = get_skb_frame_desc(entry->skb);\r\nstruct txdone_entry_desc txdesc;\r\nu32 word;\r\nu16 mcs, real_mcs;\r\nint aggr, ampdu;\r\ntxdesc.flags = 0;\r\nrt2x00_desc_read(txwi, 0, &word);\r\nmcs = rt2x00_get_field32(word, TXWI_W0_MCS);\r\nampdu = rt2x00_get_field32(word, TXWI_W0_AMPDU);\r\nreal_mcs = rt2x00_get_field32(status, TX_STA_FIFO_MCS);\r\naggr = rt2x00_get_field32(status, TX_STA_FIFO_TX_AGGRE);\r\nif (unlikely(aggr == 1 && ampdu == 0 && real_mcs != mcs)) {\r\nskbdesc->tx_rate_idx = real_mcs;\r\nmcs = real_mcs;\r\n}\r\nif (aggr == 1 || ampdu == 1)\r\n__set_bit(TXDONE_AMPDU, &txdesc.flags);\r\nif (rt2x00_get_field32(status, TX_STA_FIFO_TX_SUCCESS)) {\r\n__set_bit(TXDONE_SUCCESS, &txdesc.flags);\r\ntxdesc.retry = ((mcs > real_mcs) ? mcs - real_mcs : 0);\r\n} else {\r\n__set_bit(TXDONE_FAILURE, &txdesc.flags);\r\ntxdesc.retry = rt2x00dev->long_retry;\r\n}\r\nif (txdesc.retry)\r\n__set_bit(TXDONE_FALLBACK, &txdesc.flags);\r\nrt2x00lib_txdone(entry, &txdesc);\r\n}\r\nstatic unsigned int rt2800_hw_beacon_base(struct rt2x00_dev *rt2x00dev,\r\nunsigned int index)\r\n{\r\nreturn HW_BEACON_BASE(index);\r\n}\r\nstatic inline u8 rt2800_get_beacon_offset(struct rt2x00_dev *rt2x00dev,\r\nunsigned int index)\r\n{\r\nreturn BEACON_BASE_TO_OFFSET(rt2800_hw_beacon_base(rt2x00dev, index));\r\n}\r\nstatic void rt2800_update_beacons_setup(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct data_queue *queue = rt2x00dev->bcn;\r\nstruct queue_entry *entry;\r\nint i, bcn_num = 0;\r\nu64 off, reg = 0;\r\nu32 bssid_dw1;\r\nfor (i = 0; i < queue->limit; i++) {\r\nentry = &queue->entries[i];\r\nif (!test_bit(ENTRY_BCN_ENABLED, &entry->flags))\r\ncontinue;\r\noff = rt2800_get_beacon_offset(rt2x00dev, entry->entry_idx);\r\nreg |= off << (8 * bcn_num);\r\nbcn_num++;\r\n}\r\nWARN_ON_ONCE(bcn_num != rt2x00dev->intf_beaconing);\r\nrt2800_register_write(rt2x00dev, BCN_OFFSET0, (u32) reg);\r\nrt2800_register_write(rt2x00dev, BCN_OFFSET1, (u32) (reg >> 32));\r\nrt2800_register_read(rt2x00dev, MAC_BSSID_DW1, &bssid_dw1);\r\nrt2x00_set_field32(&bssid_dw1, MAC_BSSID_DW1_BSS_BCN_NUM,\r\nbcn_num > 0 ? bcn_num - 1 : 0);\r\nrt2800_register_write(rt2x00dev, MAC_BSSID_DW1, bssid_dw1);\r\n}\r\nvoid rt2800_write_beacon(struct queue_entry *entry, struct txentry_desc *txdesc)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = entry->queue->rt2x00dev;\r\nstruct skb_frame_desc *skbdesc = get_skb_frame_desc(entry->skb);\r\nunsigned int beacon_base;\r\nunsigned int padding_len;\r\nu32 orig_reg, reg;\r\nconst int txwi_desc_size = entry->queue->winfo_size;\r\nrt2800_register_read(rt2x00dev, BCN_TIME_CFG, &reg);\r\norig_reg = reg;\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_GEN, 0);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\r\nmemset(skb_push(entry->skb, txwi_desc_size), 0, txwi_desc_size);\r\nskbdesc->flags |= SKBDESC_DESC_IN_SKB;\r\nskbdesc->desc = entry->skb->data;\r\nskbdesc->desc_len = txwi_desc_size;\r\nrt2800_write_tx_data(entry, txdesc);\r\nrt2x00debug_dump_frame(rt2x00dev, DUMP_FRAME_BEACON, entry->skb);\r\npadding_len = roundup(entry->skb->len, 4) - entry->skb->len;\r\nif (padding_len && skb_pad(entry->skb, padding_len)) {\r\nrt2x00_err(rt2x00dev, "Failure padding beacon, aborting\n");\r\nentry->skb = NULL;\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, orig_reg);\r\nreturn;\r\n}\r\nbeacon_base = rt2800_hw_beacon_base(rt2x00dev, entry->entry_idx);\r\nrt2800_register_multiwrite(rt2x00dev, beacon_base, entry->skb->data,\r\nentry->skb->len + padding_len);\r\n__set_bit(ENTRY_BCN_ENABLED, &entry->flags);\r\nrt2800_update_beacons_setup(rt2x00dev);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, orig_reg);\r\ndev_kfree_skb_any(entry->skb);\r\nentry->skb = NULL;\r\n}\r\nstatic inline void rt2800_clear_beacon_register(struct rt2x00_dev *rt2x00dev,\r\nunsigned int index)\r\n{\r\nint i;\r\nconst int txwi_desc_size = rt2x00dev->bcn->winfo_size;\r\nunsigned int beacon_base;\r\nbeacon_base = rt2800_hw_beacon_base(rt2x00dev, index);\r\nfor (i = 0; i < txwi_desc_size; i += sizeof(__le32))\r\nrt2800_register_write(rt2x00dev, beacon_base + i, 0);\r\n}\r\nvoid rt2800_clear_beacon(struct queue_entry *entry)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = entry->queue->rt2x00dev;\r\nu32 orig_reg, reg;\r\nrt2800_register_read(rt2x00dev, BCN_TIME_CFG, &orig_reg);\r\nreg = orig_reg;\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_GEN, 0);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\r\nrt2800_clear_beacon_register(rt2x00dev, entry->entry_idx);\r\n__clear_bit(ENTRY_BCN_ENABLED, &entry->flags);\r\nrt2800_update_beacons_setup(rt2x00dev);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, orig_reg);\r\n}\r\nint rt2800_rfkill_poll(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nif (rt2x00_rt(rt2x00dev, RT3290)) {\r\nrt2800_register_read(rt2x00dev, WLAN_FUN_CTRL, &reg);\r\nreturn rt2x00_get_field32(reg, WLAN_GPIO_IN_BIT0);\r\n} else {\r\nrt2800_register_read(rt2x00dev, GPIO_CTRL, &reg);\r\nreturn rt2x00_get_field32(reg, GPIO_CTRL_VAL2);\r\n}\r\n}\r\nstatic void rt2800_brightness_set(struct led_classdev *led_cdev,\r\nenum led_brightness brightness)\r\n{\r\nstruct rt2x00_led *led =\r\ncontainer_of(led_cdev, struct rt2x00_led, led_dev);\r\nunsigned int enabled = brightness != LED_OFF;\r\nunsigned int bg_mode =\r\n(enabled && led->rt2x00dev->curr_band == NL80211_BAND_2GHZ);\r\nunsigned int polarity =\r\nrt2x00_get_field16(led->rt2x00dev->led_mcu_reg,\r\nEEPROM_FREQ_LED_POLARITY);\r\nunsigned int ledmode =\r\nrt2x00_get_field16(led->rt2x00dev->led_mcu_reg,\r\nEEPROM_FREQ_LED_MODE);\r\nu32 reg;\r\nif (rt2x00_is_soc(led->rt2x00dev)) {\r\nrt2800_register_read(led->rt2x00dev, LED_CFG, &reg);\r\nrt2x00_set_field32(&reg, LED_CFG_LED_POLAR, polarity);\r\nif (led->type == LED_TYPE_RADIO) {\r\nrt2x00_set_field32(&reg, LED_CFG_G_LED_MODE,\r\nenabled ? 3 : 0);\r\n} else if (led->type == LED_TYPE_ASSOC) {\r\nrt2x00_set_field32(&reg, LED_CFG_Y_LED_MODE,\r\nenabled ? 3 : 0);\r\n} else if (led->type == LED_TYPE_QUALITY) {\r\nrt2x00_set_field32(&reg, LED_CFG_R_LED_MODE,\r\nenabled ? 3 : 0);\r\n}\r\nrt2800_register_write(led->rt2x00dev, LED_CFG, reg);\r\n} else {\r\nif (led->type == LED_TYPE_RADIO) {\r\nrt2800_mcu_request(led->rt2x00dev, MCU_LED, 0xff, ledmode,\r\nenabled ? 0x20 : 0);\r\n} else if (led->type == LED_TYPE_ASSOC) {\r\nrt2800_mcu_request(led->rt2x00dev, MCU_LED, 0xff, ledmode,\r\nenabled ? (bg_mode ? 0x60 : 0xa0) : 0x20);\r\n} else if (led->type == LED_TYPE_QUALITY) {\r\nrt2800_mcu_request(led->rt2x00dev, MCU_LED_STRENGTH, 0xff,\r\n(1 << brightness / (LED_FULL / 6)) - 1,\r\npolarity);\r\n}\r\n}\r\n}\r\nstatic void rt2800_init_led(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00_led *led, enum led_type type)\r\n{\r\nled->rt2x00dev = rt2x00dev;\r\nled->type = type;\r\nled->led_dev.brightness_set = rt2800_brightness_set;\r\nled->flags = LED_INITIALIZED;\r\n}\r\nstatic void rt2800_config_wcid(struct rt2x00_dev *rt2x00dev,\r\nconst u8 *address,\r\nint wcid)\r\n{\r\nstruct mac_wcid_entry wcid_entry;\r\nu32 offset;\r\noffset = MAC_WCID_ENTRY(wcid);\r\nmemset(&wcid_entry, 0xff, sizeof(wcid_entry));\r\nif (address)\r\nmemcpy(wcid_entry.mac, address, ETH_ALEN);\r\nrt2800_register_multiwrite(rt2x00dev, offset,\r\n&wcid_entry, sizeof(wcid_entry));\r\n}\r\nstatic void rt2800_delete_wcid_attr(struct rt2x00_dev *rt2x00dev, int wcid)\r\n{\r\nu32 offset;\r\noffset = MAC_WCID_ATTR_ENTRY(wcid);\r\nrt2800_register_write(rt2x00dev, offset, 0);\r\n}\r\nstatic void rt2800_config_wcid_attr_bssidx(struct rt2x00_dev *rt2x00dev,\r\nint wcid, u32 bssidx)\r\n{\r\nu32 offset = MAC_WCID_ATTR_ENTRY(wcid);\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_BSS_IDX, (bssidx & 0x7));\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_BSS_IDX_EXT,\r\n(bssidx & 0x8) >> 3);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\n}\r\nstatic void rt2800_config_wcid_attr_cipher(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_crypto *crypto,\r\nstruct ieee80211_key_conf *key)\r\n{\r\nstruct mac_iveiv_entry iveiv_entry;\r\nu32 offset;\r\nu32 reg;\r\noffset = MAC_WCID_ATTR_ENTRY(key->hw_key_idx);\r\nif (crypto->cmd == SET_KEY) {\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB,\r\n!!(key->flags & IEEE80211_KEY_FLAG_PAIRWISE));\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER,\r\n(crypto->cipher & 0x7));\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER_EXT,\r\n(crypto->cipher & 0x8) >> 3);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, crypto->cipher);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\n} else {\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_KEYTAB, 0);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER, 0);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_CIPHER_EXT, 0);\r\nrt2x00_set_field32(&reg, MAC_WCID_ATTRIBUTE_RX_WIUDF, 0);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\n}\r\noffset = MAC_IVEIV_ENTRY(key->hw_key_idx);\r\nmemset(&iveiv_entry, 0, sizeof(iveiv_entry));\r\nif ((crypto->cipher == CIPHER_TKIP) ||\r\n(crypto->cipher == CIPHER_TKIP_NO_MIC) ||\r\n(crypto->cipher == CIPHER_AES))\r\niveiv_entry.iv[3] |= 0x20;\r\niveiv_entry.iv[3] |= key->keyidx << 6;\r\nrt2800_register_multiwrite(rt2x00dev, offset,\r\n&iveiv_entry, sizeof(iveiv_entry));\r\n}\r\nint rt2800_config_shared_key(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_crypto *crypto,\r\nstruct ieee80211_key_conf *key)\r\n{\r\nstruct hw_key_entry key_entry;\r\nstruct rt2x00_field32 field;\r\nu32 offset;\r\nu32 reg;\r\nif (crypto->cmd == SET_KEY) {\r\nkey->hw_key_idx = (4 * crypto->bssidx) + key->keyidx;\r\nmemcpy(key_entry.key, crypto->key,\r\nsizeof(key_entry.key));\r\nmemcpy(key_entry.tx_mic, crypto->tx_mic,\r\nsizeof(key_entry.tx_mic));\r\nmemcpy(key_entry.rx_mic, crypto->rx_mic,\r\nsizeof(key_entry.rx_mic));\r\noffset = SHARED_KEY_ENTRY(key->hw_key_idx);\r\nrt2800_register_multiwrite(rt2x00dev, offset,\r\n&key_entry, sizeof(key_entry));\r\n}\r\nfield.bit_offset = 4 * (key->hw_key_idx % 8);\r\nfield.bit_mask = 0x7 << field.bit_offset;\r\noffset = SHARED_KEY_MODE_ENTRY(key->hw_key_idx / 8);\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2x00_set_field32(&reg, field,\r\n(crypto->cmd == SET_KEY) * crypto->cipher);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\nrt2800_config_wcid(rt2x00dev, crypto->address, key->hw_key_idx);\r\nrt2800_config_wcid_attr_bssidx(rt2x00dev, key->hw_key_idx,\r\ncrypto->bssidx);\r\nrt2800_config_wcid_attr_cipher(rt2x00dev, crypto, key);\r\nreturn 0;\r\n}\r\nint rt2800_config_pairwise_key(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_crypto *crypto,\r\nstruct ieee80211_key_conf *key)\r\n{\r\nstruct hw_key_entry key_entry;\r\nu32 offset;\r\nif (crypto->cmd == SET_KEY) {\r\nif (crypto->wcid > WCID_END)\r\nreturn -ENOSPC;\r\nkey->hw_key_idx = crypto->wcid;\r\nmemcpy(key_entry.key, crypto->key,\r\nsizeof(key_entry.key));\r\nmemcpy(key_entry.tx_mic, crypto->tx_mic,\r\nsizeof(key_entry.tx_mic));\r\nmemcpy(key_entry.rx_mic, crypto->rx_mic,\r\nsizeof(key_entry.rx_mic));\r\noffset = PAIRWISE_KEY_ENTRY(key->hw_key_idx);\r\nrt2800_register_multiwrite(rt2x00dev, offset,\r\n&key_entry, sizeof(key_entry));\r\n}\r\nrt2800_config_wcid_attr_cipher(rt2x00dev, crypto, key);\r\nreturn 0;\r\n}\r\nint rt2800_sta_add(struct rt2x00_dev *rt2x00dev, struct ieee80211_vif *vif,\r\nstruct ieee80211_sta *sta)\r\n{\r\nint wcid;\r\nstruct rt2x00_sta *sta_priv = sta_to_rt2x00_sta(sta);\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nwcid = find_first_zero_bit(drv_data->sta_ids, STA_IDS_SIZE) + WCID_START;\r\nsta_priv->wcid = wcid;\r\nif (wcid > WCID_END)\r\nreturn 0;\r\n__set_bit(wcid - WCID_START, drv_data->sta_ids);\r\nrt2800_delete_wcid_attr(rt2x00dev, wcid);\r\nrt2800_config_wcid(rt2x00dev, sta->addr, wcid);\r\nrt2800_config_wcid_attr_bssidx(rt2x00dev, wcid,\r\nrt2x00lib_get_bssidx(rt2x00dev, vif));\r\nreturn 0;\r\n}\r\nint rt2800_sta_remove(struct rt2x00_dev *rt2x00dev, int wcid)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nif (wcid > WCID_END)\r\nreturn 0;\r\nrt2800_config_wcid(rt2x00dev, NULL, wcid);\r\n__clear_bit(wcid - WCID_START, drv_data->sta_ids);\r\nreturn 0;\r\n}\r\nvoid rt2800_config_filter(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int filter_flags)\r\n{\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, RX_FILTER_CFG, &reg);\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CRC_ERROR,\r\n!(filter_flags & FIF_FCSFAIL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_PHY_ERROR,\r\n!(filter_flags & FIF_PLCPFAIL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_NOT_TO_ME,\r\n!test_bit(CONFIG_MONITORING, &rt2x00dev->flags));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_NOT_MY_BSSD, 0);\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_VER_ERROR, 1);\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_MULTICAST,\r\n!(filter_flags & FIF_ALLMULTI));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_BROADCAST, 0);\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_DUPLICATE, 1);\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CF_END_ACK,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CF_END,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_ACK,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CTS,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_RTS,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_PSPOLL,\r\n!(filter_flags & FIF_PSPOLL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_BA, 0);\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_BAR,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2x00_set_field32(&reg, RX_FILTER_CFG_DROP_CNTL,\r\n!(filter_flags & FIF_CONTROL));\r\nrt2800_register_write(rt2x00dev, RX_FILTER_CFG, reg);\r\n}\r\nvoid rt2800_config_intf(struct rt2x00_dev *rt2x00dev, struct rt2x00_intf *intf,\r\nstruct rt2x00intf_conf *conf, const unsigned int flags)\r\n{\r\nu32 reg;\r\nbool update_bssid = false;\r\nif (flags & CONFIG_UPDATE_TYPE) {\r\nrt2800_register_read(rt2x00dev, BCN_TIME_CFG, &reg);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_TSF_SYNC, conf->sync);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\r\nif (conf->sync == TSF_SYNC_AP_NONE) {\r\nrt2800_register_read(rt2x00dev, TBTT_SYNC_CFG, &reg);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_CWMIN, 0);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_AIFSN, 1);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_EXP_WIN, 32);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_TBTT_ADJUST, 0);\r\nrt2800_register_write(rt2x00dev, TBTT_SYNC_CFG, reg);\r\n} else {\r\nrt2800_register_read(rt2x00dev, TBTT_SYNC_CFG, &reg);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_CWMIN, 4);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_AIFSN, 2);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_BCN_EXP_WIN, 32);\r\nrt2x00_set_field32(&reg, TBTT_SYNC_CFG_TBTT_ADJUST, 16);\r\nrt2800_register_write(rt2x00dev, TBTT_SYNC_CFG, reg);\r\n}\r\n}\r\nif (flags & CONFIG_UPDATE_MAC) {\r\nif (flags & CONFIG_UPDATE_TYPE &&\r\nconf->sync == TSF_SYNC_AP_NONE) {\r\nmemcpy(conf->bssid, conf->mac, sizeof(conf->mac));\r\nupdate_bssid = true;\r\n}\r\nif (!is_zero_ether_addr((const u8 *)conf->mac)) {\r\nreg = le32_to_cpu(conf->mac[1]);\r\nrt2x00_set_field32(&reg, MAC_ADDR_DW1_UNICAST_TO_ME_MASK, 0xff);\r\nconf->mac[1] = cpu_to_le32(reg);\r\n}\r\nrt2800_register_multiwrite(rt2x00dev, MAC_ADDR_DW0,\r\nconf->mac, sizeof(conf->mac));\r\n}\r\nif ((flags & CONFIG_UPDATE_BSSID) || update_bssid) {\r\nif (!is_zero_ether_addr((const u8 *)conf->bssid)) {\r\nreg = le32_to_cpu(conf->bssid[1]);\r\nrt2x00_set_field32(&reg, MAC_BSSID_DW1_BSS_ID_MASK, 3);\r\nrt2x00_set_field32(&reg, MAC_BSSID_DW1_BSS_BCN_NUM, 0);\r\nconf->bssid[1] = cpu_to_le32(reg);\r\n}\r\nrt2800_register_multiwrite(rt2x00dev, MAC_BSSID_DW0,\r\nconf->bssid, sizeof(conf->bssid));\r\n}\r\n}\r\nstatic void rt2800_config_ht_opmode(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_erp *erp)\r\n{\r\nbool any_sta_nongf = !!(erp->ht_opmode &\r\nIEEE80211_HT_OP_MODE_NON_GF_STA_PRSNT);\r\nu8 protection = erp->ht_opmode & IEEE80211_HT_OP_MODE_PROTECTION;\r\nu8 mm20_mode, mm40_mode, gf20_mode, gf40_mode;\r\nu16 mm20_rate, mm40_rate, gf20_rate, gf40_rate;\r\nu32 reg;\r\nmm20_rate = gf20_rate = 0x4004;\r\nmm40_rate = gf40_rate = 0x4084;\r\nswitch (protection) {\r\ncase IEEE80211_HT_OP_MODE_PROTECTION_NONE:\r\nmm20_mode = mm40_mode = gf20_mode = gf40_mode = 0;\r\nbreak;\r\ncase IEEE80211_HT_OP_MODE_PROTECTION_20MHZ:\r\nmm20_mode = gf20_mode = 0;\r\nmm40_mode = gf40_mode = 2;\r\nbreak;\r\ncase IEEE80211_HT_OP_MODE_PROTECTION_NONMEMBER:\r\ncase IEEE80211_HT_OP_MODE_PROTECTION_NONHT_MIXED:\r\nmm20_mode = mm40_mode = gf20_mode = gf40_mode = 2;\r\nif (erp->cts_protection) {\r\nmm20_rate = mm40_rate = 0x0003;\r\ngf20_rate = gf40_rate = 0x0003;\r\n}\r\nbreak;\r\n}\r\nif (any_sta_nongf)\r\ngf20_mode = gf40_mode = 2;\r\nrt2800_register_read(rt2x00dev, MM20_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_RATE, mm20_rate);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_CTRL, mm20_mode);\r\nrt2800_register_write(rt2x00dev, MM20_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MM40_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_RATE, mm40_rate);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_CTRL, mm40_mode);\r\nrt2800_register_write(rt2x00dev, MM40_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, GF20_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_RATE, gf20_rate);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_CTRL, gf20_mode);\r\nrt2800_register_write(rt2x00dev, GF20_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, GF40_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_RATE, gf40_rate);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_CTRL, gf40_mode);\r\nrt2800_register_write(rt2x00dev, GF40_PROT_CFG, reg);\r\n}\r\nvoid rt2800_config_erp(struct rt2x00_dev *rt2x00dev, struct rt2x00lib_erp *erp,\r\nu32 changed)\r\n{\r\nu32 reg;\r\nif (changed & BSS_CHANGED_ERP_PREAMBLE) {\r\nrt2800_register_read(rt2x00dev, AUTO_RSP_CFG, &reg);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_BAC_ACK_POLICY,\r\n!!erp->short_preamble);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_AR_PREAMBLE,\r\n!!erp->short_preamble);\r\nrt2800_register_write(rt2x00dev, AUTO_RSP_CFG, reg);\r\n}\r\nif (changed & BSS_CHANGED_ERP_CTS_PROT) {\r\nrt2800_register_read(rt2x00dev, OFDM_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_CTRL,\r\nerp->cts_protection ? 2 : 0);\r\nrt2800_register_write(rt2x00dev, OFDM_PROT_CFG, reg);\r\n}\r\nif (changed & BSS_CHANGED_BASIC_RATES) {\r\nrt2800_register_write(rt2x00dev, LEGACY_BASIC_RATE,\r\nerp->basic_rates);\r\nrt2800_register_write(rt2x00dev, HT_BASIC_RATE, 0x00008003);\r\n}\r\nif (changed & BSS_CHANGED_ERP_SLOT) {\r\nrt2800_register_read(rt2x00dev, BKOFF_SLOT_CFG, &reg);\r\nrt2x00_set_field32(&reg, BKOFF_SLOT_CFG_SLOT_TIME,\r\nerp->slot_time);\r\nrt2800_register_write(rt2x00dev, BKOFF_SLOT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, XIFS_TIME_CFG, &reg);\r\nrt2x00_set_field32(&reg, XIFS_TIME_CFG_EIFS, erp->eifs);\r\nrt2800_register_write(rt2x00dev, XIFS_TIME_CFG, reg);\r\n}\r\nif (changed & BSS_CHANGED_BEACON_INT) {\r\nrt2800_register_read(rt2x00dev, BCN_TIME_CFG, &reg);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_INTERVAL,\r\nerp->beacon_int * 16);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\r\n}\r\nif (changed & BSS_CHANGED_HT)\r\nrt2800_config_ht_opmode(rt2x00dev, erp);\r\n}\r\nstatic void rt2800_config_3572bt_ant(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nu16 eeprom;\r\nu8 led_ctrl, led_g_mode, led_r_mode;\r\nrt2800_register_read(rt2x00dev, GPIO_SWITCH, &reg);\r\nif (rt2x00dev->curr_band == NL80211_BAND_5GHZ) {\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_0, 1);\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_1, 1);\r\n} else {\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_0, 0);\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_1, 0);\r\n}\r\nrt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\r\nrt2800_register_read(rt2x00dev, LED_CFG, &reg);\r\nled_g_mode = rt2x00_get_field32(reg, LED_CFG_LED_POLAR) ? 3 : 0;\r\nled_r_mode = rt2x00_get_field32(reg, LED_CFG_LED_POLAR) ? 0 : 3;\r\nif (led_g_mode != rt2x00_get_field32(reg, LED_CFG_G_LED_MODE) ||\r\nled_r_mode != rt2x00_get_field32(reg, LED_CFG_R_LED_MODE)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_FREQ, &eeprom);\r\nled_ctrl = rt2x00_get_field16(eeprom, EEPROM_FREQ_LED_MODE);\r\nif (led_ctrl == 0 || led_ctrl > 0x40) {\r\nrt2x00_set_field32(&reg, LED_CFG_G_LED_MODE, led_g_mode);\r\nrt2x00_set_field32(&reg, LED_CFG_R_LED_MODE, led_r_mode);\r\nrt2800_register_write(rt2x00dev, LED_CFG, reg);\r\n} else {\r\nrt2800_mcu_request(rt2x00dev, MCU_BAND_SELECT, 0xff,\r\n(led_g_mode << 2) | led_r_mode, 1);\r\n}\r\n}\r\n}\r\nstatic void rt2800_set_ant_diversity(struct rt2x00_dev *rt2x00dev,\r\nenum antenna ant)\r\n{\r\nu32 reg;\r\nu8 eesk_pin = (ant == ANTENNA_A) ? 1 : 0;\r\nu8 gpio_bit3 = (ant == ANTENNA_A) ? 0 : 1;\r\nif (rt2x00_is_pci(rt2x00dev)) {\r\nrt2800_register_read(rt2x00dev, E2PROM_CSR, &reg);\r\nrt2x00_set_field32(&reg, E2PROM_CSR_DATA_CLOCK, eesk_pin);\r\nrt2800_register_write(rt2x00dev, E2PROM_CSR, reg);\r\n} else if (rt2x00_is_usb(rt2x00dev))\r\nrt2800_mcu_request(rt2x00dev, MCU_ANT_SELECT, 0xff,\r\neesk_pin, 0);\r\nrt2800_register_read(rt2x00dev, GPIO_CTRL, &reg);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR3, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL3, gpio_bit3);\r\nrt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\r\n}\r\nvoid rt2800_config_ant(struct rt2x00_dev *rt2x00dev, struct antenna_setup *ant)\r\n{\r\nu8 r1;\r\nu8 r3;\r\nu16 eeprom;\r\nrt2800_bbp_read(rt2x00dev, 1, &r1);\r\nrt2800_bbp_read(rt2x00dev, 3, &r3);\r\nif (rt2x00_rt(rt2x00dev, RT3572) &&\r\nrt2x00_has_cap_bt_coexist(rt2x00dev))\r\nrt2800_config_3572bt_ant(rt2x00dev);\r\nswitch (ant->tx_chain_num) {\r\ncase 1:\r\nrt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 0);\r\nbreak;\r\ncase 2:\r\nif (rt2x00_rt(rt2x00dev, RT3572) &&\r\nrt2x00_has_cap_bt_coexist(rt2x00dev))\r\nrt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 1);\r\nelse\r\nrt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 2);\r\nbreak;\r\ncase 3:\r\nrt2x00_set_field8(&r1, BBP1_TX_ANTENNA, 2);\r\nbreak;\r\n}\r\nswitch (ant->rx_chain_num) {\r\ncase 1:\r\nif (rt2x00_rt(rt2x00dev, RT3070) ||\r\nrt2x00_rt(rt2x00dev, RT3090) ||\r\nrt2x00_rt(rt2x00dev, RT3352) ||\r\nrt2x00_rt(rt2x00dev, RT3390)) {\r\nrt2800_eeprom_read(rt2x00dev,\r\nEEPROM_NIC_CONF1, &eeprom);\r\nif (rt2x00_get_field16(eeprom,\r\nEEPROM_NIC_CONF1_ANT_DIVERSITY))\r\nrt2800_set_ant_diversity(rt2x00dev,\r\nrt2x00dev->default_ant.rx);\r\n}\r\nrt2x00_set_field8(&r3, BBP3_RX_ANTENNA, 0);\r\nbreak;\r\ncase 2:\r\nif (rt2x00_rt(rt2x00dev, RT3572) &&\r\nrt2x00_has_cap_bt_coexist(rt2x00dev)) {\r\nrt2x00_set_field8(&r3, BBP3_RX_ADC, 1);\r\nrt2x00_set_field8(&r3, BBP3_RX_ANTENNA,\r\nrt2x00dev->curr_band == NL80211_BAND_5GHZ);\r\nrt2800_set_ant_diversity(rt2x00dev, ANTENNA_B);\r\n} else {\r\nrt2x00_set_field8(&r3, BBP3_RX_ANTENNA, 1);\r\n}\r\nbreak;\r\ncase 3:\r\nrt2x00_set_field8(&r3, BBP3_RX_ANTENNA, 2);\r\nbreak;\r\n}\r\nrt2800_bbp_write(rt2x00dev, 3, r3);\r\nrt2800_bbp_write(rt2x00dev, 1, r1);\r\nif (rt2x00_rt(rt2x00dev, RT3593)) {\r\nif (ant->rx_chain_num == 1)\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 86, 0x46);\r\n}\r\n}\r\nstatic void rt2800_config_lna_gain(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_conf *libconf)\r\n{\r\nu16 eeprom;\r\nshort lna_gain;\r\nif (libconf->rf.channel <= 14) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_LNA, &eeprom);\r\nlna_gain = rt2x00_get_field16(eeprom, EEPROM_LNA_BG);\r\n} else if (libconf->rf.channel <= 64) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_LNA, &eeprom);\r\nlna_gain = rt2x00_get_field16(eeprom, EEPROM_LNA_A0);\r\n} else if (libconf->rf.channel <= 128) {\r\nif (rt2x00_rt(rt2x00dev, RT3593)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_EXT_LNA2, &eeprom);\r\nlna_gain = rt2x00_get_field16(eeprom,\r\nEEPROM_EXT_LNA2_A1);\r\n} else {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG2, &eeprom);\r\nlna_gain = rt2x00_get_field16(eeprom,\r\nEEPROM_RSSI_BG2_LNA_A1);\r\n}\r\n} else {\r\nif (rt2x00_rt(rt2x00dev, RT3593)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_EXT_LNA2, &eeprom);\r\nlna_gain = rt2x00_get_field16(eeprom,\r\nEEPROM_EXT_LNA2_A2);\r\n} else {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A2, &eeprom);\r\nlna_gain = rt2x00_get_field16(eeprom,\r\nEEPROM_RSSI_A2_LNA_A2);\r\n}\r\n}\r\nrt2x00dev->lna_gain = lna_gain;\r\n}\r\nstatic void rt2800_adjust_freq_offset(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 freq_offset, prev_freq_offset;\r\nu8 rfcsr, prev_rfcsr;\r\nfreq_offset = rt2x00_get_field8(rt2x00dev->freq_offset, RFCSR17_CODE);\r\nfreq_offset = min_t(u8, freq_offset, FREQ_OFFSET_BOUND);\r\nrt2800_rfcsr_read(rt2x00dev, 17, &rfcsr);\r\nprev_rfcsr = rfcsr;\r\nrt2x00_set_field8(&rfcsr, RFCSR17_CODE, freq_offset);\r\nif (rfcsr == prev_rfcsr)\r\nreturn;\r\nif (rt2x00_is_usb(rt2x00dev)) {\r\nrt2800_mcu_request(rt2x00dev, MCU_FREQ_OFFSET, 0xff,\r\nfreq_offset, prev_rfcsr);\r\nreturn;\r\n}\r\nprev_freq_offset = rt2x00_get_field8(prev_rfcsr, RFCSR17_CODE);\r\nwhile (prev_freq_offset != freq_offset) {\r\nif (prev_freq_offset < freq_offset)\r\nprev_freq_offset++;\r\nelse\r\nprev_freq_offset--;\r\nrt2x00_set_field8(&rfcsr, RFCSR17_CODE, prev_freq_offset);\r\nrt2800_rfcsr_write(rt2x00dev, 17, rfcsr);\r\nusleep_range(1000, 1500);\r\n}\r\n}\r\nstatic void rt2800_config_channel_rf2xxx(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nrt2x00_set_field32(&rf->rf4, RF4_FREQ_OFFSET, rt2x00dev->freq_offset);\r\nif (rt2x00dev->default_ant.tx_chain_num == 1)\r\nrt2x00_set_field32(&rf->rf2, RF2_ANTENNA_TX1, 1);\r\nif (rt2x00dev->default_ant.rx_chain_num == 1) {\r\nrt2x00_set_field32(&rf->rf2, RF2_ANTENNA_RX1, 1);\r\nrt2x00_set_field32(&rf->rf2, RF2_ANTENNA_RX2, 1);\r\n} else if (rt2x00dev->default_ant.rx_chain_num == 2)\r\nrt2x00_set_field32(&rf->rf2, RF2_ANTENNA_RX2, 1);\r\nif (rf->channel > 14) {\r\nrt2x00_set_field32(&rf->rf3, RF3_TXPOWER_A_7DBM_BOOST,\r\n(info->default_power1 >= 0));\r\nif (info->default_power1 < 0)\r\ninfo->default_power1 += 7;\r\nrt2x00_set_field32(&rf->rf3, RF3_TXPOWER_A, info->default_power1);\r\nrt2x00_set_field32(&rf->rf4, RF4_TXPOWER_A_7DBM_BOOST,\r\n(info->default_power2 >= 0));\r\nif (info->default_power2 < 0)\r\ninfo->default_power2 += 7;\r\nrt2x00_set_field32(&rf->rf4, RF4_TXPOWER_A, info->default_power2);\r\n} else {\r\nrt2x00_set_field32(&rf->rf3, RF3_TXPOWER_G, info->default_power1);\r\nrt2x00_set_field32(&rf->rf4, RF4_TXPOWER_G, info->default_power2);\r\n}\r\nrt2x00_set_field32(&rf->rf4, RF4_HT40, conf_is_ht40(conf));\r\nrt2800_rf_write(rt2x00dev, 1, rf->rf1);\r\nrt2800_rf_write(rt2x00dev, 2, rf->rf2);\r\nrt2800_rf_write(rt2x00dev, 3, rf->rf3 & ~0x00000004);\r\nrt2800_rf_write(rt2x00dev, 4, rf->rf4);\r\nudelay(200);\r\nrt2800_rf_write(rt2x00dev, 1, rf->rf1);\r\nrt2800_rf_write(rt2x00dev, 2, rf->rf2);\r\nrt2800_rf_write(rt2x00dev, 3, rf->rf3 | 0x00000004);\r\nrt2800_rf_write(rt2x00dev, 4, rf->rf4);\r\nudelay(200);\r\nrt2800_rf_write(rt2x00dev, 1, rf->rf1);\r\nrt2800_rf_write(rt2x00dev, 2, rf->rf2);\r\nrt2800_rf_write(rt2x00dev, 3, rf->rf3 & ~0x00000004);\r\nrt2800_rf_write(rt2x00dev, 4, rf->rf4);\r\n}\r\nstatic void rt2800_config_channel_rf3xxx(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu8 rfcsr, calib_tx, calib_rx;\r\nrt2800_rfcsr_write(rt2x00dev, 2, rf->rf1);\r\nrt2800_rfcsr_read(rt2x00dev, 3, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_K, rf->rf3);\r\nrt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 6, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR6_R1, rf->rf2);\r\nrt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 12, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR12_TX_POWER, info->default_power1);\r\nrt2800_rfcsr_write(rt2x00dev, 12, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 13, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR13_TX_POWER, info->default_power2);\r\nrt2800_rfcsr_write(rt2x00dev, 13, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD,\r\nrt2x00dev->default_ant.rx_chain_num <= 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD,\r\nrt2x00dev->default_ant.rx_chain_num <= 2);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD,\r\nrt2x00dev->default_ant.tx_chain_num <= 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD,\r\nrt2x00dev->default_ant.tx_chain_num <= 2);\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 23, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR23_FREQ_OFFSET, rt2x00dev->freq_offset);\r\nrt2800_rfcsr_write(rt2x00dev, 23, rfcsr);\r\nif (rt2x00_rt(rt2x00dev, RT3390)) {\r\ncalib_tx = conf_is_ht40(conf) ? 0x68 : 0x4f;\r\ncalib_rx = conf_is_ht40(conf) ? 0x6f : 0x4f;\r\n} else {\r\nif (conf_is_ht40(conf)) {\r\ncalib_tx = drv_data->calibration_bw40;\r\ncalib_rx = drv_data->calibration_bw40;\r\n} else {\r\ncalib_tx = drv_data->calibration_bw20;\r\ncalib_rx = drv_data->calibration_bw20;\r\n}\r\n}\r\nrt2800_rfcsr_read(rt2x00dev, 24, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR24_TX_CALIB, calib_tx);\r\nrt2800_rfcsr_write(rt2x00dev, 24, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 31, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR31_RX_CALIB, calib_rx);\r\nrt2800_rfcsr_write(rt2x00dev, 31, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 7, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 30, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_RF_CALIBRATION, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\r\nmsleep(1);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_RF_CALIBRATION, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\r\n}\r\nstatic void rt2800_config_channel_rf3052(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu8 rfcsr;\r\nu32 reg;\r\nif (rf->channel <= 14) {\r\nrt2800_bbp_write(rt2x00dev, 25, drv_data->bbp25);\r\nrt2800_bbp_write(rt2x00dev, 26, drv_data->bbp26);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 25, 0x09);\r\nrt2800_bbp_write(rt2x00dev, 26, 0xff);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 2, rf->rf1);\r\nrt2800_rfcsr_write(rt2x00dev, 3, rf->rf3);\r\nrt2800_rfcsr_read(rt2x00dev, 6, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR6_R1, rf->rf2);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR6_TXDIV, 2);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR6_TXDIV, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 5, &rfcsr);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR5_R1, 1);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR5_R1, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 5, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 12, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrt2x00_set_field8(&rfcsr, RFCSR12_DR0, 3);\r\nrt2x00_set_field8(&rfcsr, RFCSR12_TX_POWER,\r\ninfo->default_power1);\r\n} else {\r\nrt2x00_set_field8(&rfcsr, RFCSR12_DR0, 7);\r\nrt2x00_set_field8(&rfcsr, RFCSR12_TX_POWER,\r\n(info->default_power1 & 0x3) |\r\n((info->default_power1 & 0xC) << 1));\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 12, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 13, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrt2x00_set_field8(&rfcsr, RFCSR13_DR0, 3);\r\nrt2x00_set_field8(&rfcsr, RFCSR13_TX_POWER,\r\ninfo->default_power2);\r\n} else {\r\nrt2x00_set_field8(&rfcsr, RFCSR13_DR0, 7);\r\nrt2x00_set_field8(&rfcsr, RFCSR13_TX_POWER,\r\n(info->default_power2 & 0x3) |\r\n((info->default_power2 & 0xC) << 1));\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 13, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\r\nif (rt2x00_has_cap_bt_coexist(rt2x00dev)) {\r\nif (rf->channel <= 14) {\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\r\n}\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\r\n} else {\r\nswitch (rt2x00dev->default_ant.tx_chain_num) {\r\ncase 1:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\r\ncase 2:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\r\nbreak;\r\n}\r\nswitch (rt2x00dev->default_ant.rx_chain_num) {\r\ncase 1:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\r\ncase 2:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\r\nbreak;\r\n}\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 23, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR23_FREQ_OFFSET, rt2x00dev->freq_offset);\r\nrt2800_rfcsr_write(rt2x00dev, 23, rfcsr);\r\nif (conf_is_ht40(conf)) {\r\nrt2800_rfcsr_write(rt2x00dev, 24, drv_data->calibration_bw40);\r\nrt2800_rfcsr_write(rt2x00dev, 31, drv_data->calibration_bw40);\r\n} else {\r\nrt2800_rfcsr_write(rt2x00dev, 24, drv_data->calibration_bw20);\r\nrt2800_rfcsr_write(rt2x00dev, 31, drv_data->calibration_bw20);\r\n}\r\nif (rf->channel <= 14) {\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0xd8);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0xc3);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0xb9);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x53);\r\nrfcsr = 0x4c;\r\nrt2x00_set_field8(&rfcsr, RFCSR16_TXMIXER_GAIN,\r\ndrv_data->txmixer_gain_24g);\r\nrt2800_rfcsr_write(rt2x00dev, 16, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 17, 0x23);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x93);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xb3);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x15);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x85);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x9b);\r\n} else {\r\nrt2800_rfcsr_read(rt2x00dev, 7, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_BIT2, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_BIT3, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_BIT4, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_BITS67, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0xc0);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x43);\r\nrfcsr = 0x7a;\r\nrt2x00_set_field8(&rfcsr, RFCSR16_TXMIXER_GAIN,\r\ndrv_data->txmixer_gain_5g);\r\nrt2800_rfcsr_write(rt2x00dev, 16, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 17, 0x23);\r\nif (rf->channel <= 64) {\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0xb7);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xf6);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x3d);\r\n} else if (rf->channel <= 128) {\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x74);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xf4);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x01);\r\n} else {\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x72);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xf3);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x01);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x87);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x01);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x9f);\r\n}\r\nrt2800_register_read(rt2x00dev, GPIO_CTRL, &reg);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR7, 0);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL7, 1);\r\nelse\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL7, 0);\r\nrt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\r\nrt2800_rfcsr_read(rt2x00dev, 7, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\r\n}\r\nstatic void rt2800_config_channel_rf3053(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu8 txrx_agc_fc;\r\nu8 txrx_h20m;\r\nu8 rfcsr;\r\nu8 bbp;\r\nconst bool txbf_enabled = false;\r\nrt2800_bbp_read(rt2x00dev, 109, &bbp);\r\nrt2x00_set_field8(&bbp, BBP109_TX0_POWER, 0);\r\nrt2x00_set_field8(&bbp, BBP109_TX1_POWER, 0);\r\nrt2800_bbp_write(rt2x00dev, 109, bbp);\r\nrt2800_bbp_read(rt2x00dev, 110, &bbp);\r\nrt2x00_set_field8(&bbp, BBP110_TX2_POWER, 0);\r\nrt2800_bbp_write(rt2x00dev, 110, bbp);\r\nif (rf->channel <= 14) {\r\nrt2800_bbp_write(rt2x00dev, 25, drv_data->bbp25);\r\nrt2800_bbp_write(rt2x00dev, 26, drv_data->bbp26);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 25, 0x09);\r\nrt2800_bbp_write(rt2x00dev, 26, 0xff);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\r\nrt2800_rfcsr_write(rt2x00dev, 9, rf->rf3 & 0xf);\r\nrt2800_rfcsr_read(rt2x00dev, 11, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR11_R, (rf->rf2 & 0x3));\r\nrt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 11, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR11_PLL_IDOH, 1);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR11_PLL_MOD, 1);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR11_PLL_MOD, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 53, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrfcsr = 0;\r\nrt2x00_set_field8(&rfcsr, RFCSR53_TX_POWER,\r\ninfo->default_power1 & 0x1f);\r\n} else {\r\nif (rt2x00_is_usb(rt2x00dev))\r\nrfcsr = 0x40;\r\nrt2x00_set_field8(&rfcsr, RFCSR53_TX_POWER,\r\n((info->default_power1 & 0x18) << 1) |\r\n(info->default_power1 & 7));\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 53, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 55, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrfcsr = 0;\r\nrt2x00_set_field8(&rfcsr, RFCSR55_TX_POWER,\r\ninfo->default_power2 & 0x1f);\r\n} else {\r\nif (rt2x00_is_usb(rt2x00dev))\r\nrfcsr = 0x40;\r\nrt2x00_set_field8(&rfcsr, RFCSR55_TX_POWER,\r\n((info->default_power2 & 0x18) << 1) |\r\n(info->default_power2 & 7));\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 55, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 54, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrfcsr = 0;\r\nrt2x00_set_field8(&rfcsr, RFCSR54_TX_POWER,\r\ninfo->default_power3 & 0x1f);\r\n} else {\r\nif (rt2x00_is_usb(rt2x00dev))\r\nrfcsr = 0x40;\r\nrt2x00_set_field8(&rfcsr, RFCSR54_TX_POWER,\r\n((info->default_power3 & 0x18) << 1) |\r\n(info->default_power3 & 7));\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 54, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\r\nswitch (rt2x00dev->default_ant.tx_chain_num) {\r\ncase 3:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 1);\r\ncase 2:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\r\ncase 1:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\r\nbreak;\r\n}\r\nswitch (rt2x00dev->default_ant.rx_chain_num) {\r\ncase 3:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 1);\r\ncase 2:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\r\ncase 1:\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\r\nbreak;\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nif (conf_is_ht40(conf)) {\r\ntxrx_agc_fc = rt2x00_get_field8(drv_data->calibration_bw40,\r\nRFCSR24_TX_AGC_FC);\r\ntxrx_h20m = rt2x00_get_field8(drv_data->calibration_bw40,\r\nRFCSR24_TX_H20M);\r\n} else {\r\ntxrx_agc_fc = rt2x00_get_field8(drv_data->calibration_bw20,\r\nRFCSR24_TX_AGC_FC);\r\ntxrx_h20m = rt2x00_get_field8(drv_data->calibration_bw20,\r\nRFCSR24_TX_H20M);\r\n}\r\nrt2800_rfcsr_read(rt2x00dev, 32, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR32_TX_AGC_FC, txrx_agc_fc);\r\nif (rf->channel <= 14)\r\nrfcsr = 0xa0;\r\nelse\r\nrfcsr = 0x80;\r\nrt2800_rfcsr_write(rt2x00dev, 31, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 30, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_TX_H20M, txrx_h20m);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_RX_H20M, txrx_h20m);\r\nrt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 36, &rfcsr);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR36_RF_BS, 1);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR36_RF_BS, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 36, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 34, &rfcsr);\r\nif (rf->channel <= 14)\r\nrfcsr = 0x3c;\r\nelse\r\nrfcsr = 0x20;\r\nrt2800_rfcsr_write(rt2x00dev, 34, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 12, &rfcsr);\r\nif (rf->channel <= 14)\r\nrfcsr = 0x1a;\r\nelse\r\nrfcsr = 0x12;\r\nrt2800_rfcsr_write(rt2x00dev, 12, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 6, &rfcsr);\r\nif (rf->channel >= 1 && rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 1);\r\nelse if (rf->channel >= 36 && rf->channel <= 64)\r\nrt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 2);\r\nelse if (rf->channel >= 100 && rf->channel <= 128)\r\nrt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 2);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR6_VCO_IC, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 30, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_RX_VCM, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x60);\r\nif (rf->channel <= 14) {\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xd3);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x12);\r\n} else {\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xd8);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x23);\r\n}\r\nrt2800_rfcsr_read(rt2x00dev, 51, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR51_BITS01, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 51, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 51, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrt2x00_set_field8(&rfcsr, RFCSR51_BITS24, 5);\r\nrt2x00_set_field8(&rfcsr, RFCSR51_BITS57, 3);\r\n} else {\r\nrt2x00_set_field8(&rfcsr, RFCSR51_BITS24, 4);\r\nrt2x00_set_field8(&rfcsr, RFCSR51_BITS57, 2);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 51, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 49, &rfcsr);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX_LO1_IC, 3);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX_LO1_IC, 2);\r\nif (txbf_enabled)\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX_DIV, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 50, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR50_TX_LO1_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 57, &rfcsr);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field8(&rfcsr, RFCSR57_DRV_CC, 0x1b);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR57_DRV_CC, 0x0f);\r\nrt2800_rfcsr_write(rt2x00dev, 57, rfcsr);\r\nif (rf->channel <= 14) {\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x93);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x45);\r\n} else {\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x9b);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x05);\r\n}\r\nrt2800_rfcsr_read(rt2x00dev, 3, &rfcsr);\r\nif (rf->channel <= 14) {\r\nrt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\r\n} else {\r\nrt2x00_set_field8(&rfcsr, RFCSR3_BIT1, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_BIT2, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_BIT3, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_BIT4, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_BIT5, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\r\nif (rf->channel >= 1 && rf->channel <= 14) {\r\nrfcsr = 0x23;\r\nif (txbf_enabled)\r\nrt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xbb);\r\n} else if (rf->channel >= 36 && rf->channel <= 64) {\r\nrfcsr = 0x36;\r\nif (txbf_enabled)\r\nrt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x36);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xeb);\r\n} else if (rf->channel >= 100 && rf->channel <= 128) {\r\nrfcsr = 0x32;\r\nif (txbf_enabled)\r\nrt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xb3);\r\n} else {\r\nrfcsr = 0x30;\r\nif (txbf_enabled)\r\nrt2x00_set_field8(&rfcsr, RFCSR39_RX_DIV, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0x9b);\r\n}\r\n}\r\nstatic void rt2800_config_channel_rf3290(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nu8 rfcsr;\r\nrt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\r\nrt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\r\nrt2800_rfcsr_read(rt2x00dev, 11, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR11_R, rf->rf2);\r\nrt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 49, &rfcsr);\r\nif (info->default_power1 > POWER_BOUND)\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX, POWER_BOUND);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX, info->default_power1);\r\nrt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nif (rf->channel <= 14) {\r\nif (rf->channel == 6)\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0c);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0b);\r\nif (rf->channel >= 1 && rf->channel <= 6)\r\nrt2800_bbp_write(rt2x00dev, 59, 0x0f);\r\nelse if (rf->channel >= 7 && rf->channel <= 11)\r\nrt2800_bbp_write(rt2x00dev, 59, 0x0e);\r\nelse if (rf->channel >= 12 && rf->channel <= 14)\r\nrt2800_bbp_write(rt2x00dev, 59, 0x0d);\r\n}\r\n}\r\nstatic void rt2800_config_channel_rf3322(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nu8 rfcsr;\r\nrt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\r\nrt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x1c);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x00);\r\nif (info->default_power1 > POWER_BOUND)\r\nrt2800_rfcsr_write(rt2x00dev, 47, POWER_BOUND);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 47, info->default_power1);\r\nif (info->default_power2 > POWER_BOUND)\r\nrt2800_rfcsr_write(rt2x00dev, 48, POWER_BOUND);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 48, info->default_power2);\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\r\nif ( rt2x00dev->default_ant.tx_chain_num == 2 )\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 0);\r\nif ( rt2x00dev->default_ant.rx_chain_num == 2 )\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 80);\r\n}\r\nstatic void rt2800_config_channel_rf53xx(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nu8 rfcsr;\r\nrt2800_rfcsr_write(rt2x00dev, 8, rf->rf1);\r\nrt2800_rfcsr_write(rt2x00dev, 9, rf->rf3);\r\nrt2800_rfcsr_read(rt2x00dev, 11, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR11_R, rf->rf2);\r\nrt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 49, &rfcsr);\r\nif (info->default_power1 > POWER_BOUND)\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX, POWER_BOUND);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX, info->default_power1);\r\nrt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\r\nif (rt2x00_rt(rt2x00dev, RT5392)) {\r\nrt2800_rfcsr_read(rt2x00dev, 50, &rfcsr);\r\nif (info->default_power2 > POWER_BOUND)\r\nrt2x00_set_field8(&rfcsr, RFCSR50_TX, POWER_BOUND);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR50_TX,\r\ninfo->default_power2);\r\nrt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\r\n}\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nif (rt2x00_rt(rt2x00dev, RT5392)) {\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\r\n}\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nif (rf->channel <= 14) {\r\nint idx = rf->channel-1;\r\nif (rt2x00_has_cap_bt_coexist(rt2x00dev)) {\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F)) {\r\nstatic const char r55_bt_rev[] = {0x83, 0x83,\r\n0x83, 0x73, 0x73, 0x63, 0x53, 0x53,\r\n0x53, 0x43, 0x43, 0x43, 0x43, 0x43};\r\nstatic const char r59_bt_rev[] = {0x0e, 0x0e,\r\n0x0e, 0x0e, 0x0e, 0x0b, 0x0a, 0x09,\r\n0x07, 0x07, 0x07, 0x07, 0x07, 0x07};\r\nrt2800_rfcsr_write(rt2x00dev, 55,\r\nr55_bt_rev[idx]);\r\nrt2800_rfcsr_write(rt2x00dev, 59,\r\nr59_bt_rev[idx]);\r\n} else {\r\nstatic const char r59_bt[] = {0x8b, 0x8b, 0x8b,\r\n0x8b, 0x8b, 0x8b, 0x8b, 0x8a, 0x89,\r\n0x88, 0x88, 0x86, 0x85, 0x84};\r\nrt2800_rfcsr_write(rt2x00dev, 59, r59_bt[idx]);\r\n}\r\n} else {\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F)) {\r\nstatic const char r55_nonbt_rev[] = {0x23, 0x23,\r\n0x23, 0x23, 0x13, 0x13, 0x03, 0x03,\r\n0x03, 0x03, 0x03, 0x03, 0x03, 0x03};\r\nstatic const char r59_nonbt_rev[] = {0x07, 0x07,\r\n0x07, 0x07, 0x07, 0x07, 0x07, 0x07,\r\n0x07, 0x07, 0x06, 0x05, 0x04, 0x04};\r\nrt2800_rfcsr_write(rt2x00dev, 55,\r\nr55_nonbt_rev[idx]);\r\nrt2800_rfcsr_write(rt2x00dev, 59,\r\nr59_nonbt_rev[idx]);\r\n} else if (rt2x00_rt(rt2x00dev, RT5390) ||\r\nrt2x00_rt(rt2x00dev, RT5392)) {\r\nstatic const char r59_non_bt[] = {0x8f, 0x8f,\r\n0x8f, 0x8f, 0x8f, 0x8f, 0x8f, 0x8d,\r\n0x8a, 0x88, 0x88, 0x87, 0x87, 0x86};\r\nrt2800_rfcsr_write(rt2x00dev, 59,\r\nr59_non_bt[idx]);\r\n}\r\n}\r\n}\r\n}\r\nstatic void rt2800_config_channel_rf55xx(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nu8 rfcsr, ep_reg;\r\nu32 reg;\r\nint power_bound;\r\nconst bool is_11b = false;\r\nconst bool is_type_ep = false;\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL,\r\n(rf->channel > 14 || conf_is_ht40(conf)) ? 5 : 0);\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\nrt2800_rfcsr_write(rt2x00dev, 8, rf->rf1 & 0xff);\r\nrt2800_rfcsr_read(rt2x00dev, 9, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR9_K, rf->rf2 & 0xf);\r\nrt2x00_set_field8(&rfcsr, RFCSR9_N, (rf->rf1 & 0x100) >> 8);\r\nrt2x00_set_field8(&rfcsr, RFCSR9_MOD, ((rf->rf3 - 8) & 0x4) >> 2);\r\nrt2800_rfcsr_write(rt2x00dev, 9, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 11, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR11_R, rf->rf4 - 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR11_MOD, (rf->rf3 - 8) & 0x3);\r\nrt2800_rfcsr_write(rt2x00dev, 11, rfcsr);\r\nif (rf->channel <= 14) {\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x90);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x4A);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x52);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x4A);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 36, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 37, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x89);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x1B);\r\nrt2800_rfcsr_write(rt2x00dev, 40, 0x0D);\r\nrt2800_rfcsr_write(rt2x00dev, 41, 0x9B);\r\nrt2800_rfcsr_write(rt2x00dev, 42, 0xD5);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x72);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x0E);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xA2);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x6B);\r\nrt2800_rfcsr_write(rt2x00dev, 48, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0x3E);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x48);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0x38);\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xA1);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x39);\r\nrt2800_rfcsr_write(rt2x00dev, 60, 0x45);\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0x91);\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x39);\r\nrfcsr = rf->channel <= 10 ? 0x07 : 0x06;\r\nrt2800_rfcsr_write(rt2x00dev, 23, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 59, rfcsr);\r\nif (is_11b) {\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0xF8);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0xC0);\r\nif (is_type_ep)\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x06);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x47);\r\n} else {\r\nif (is_type_ep)\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x03);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x43);\r\n}\r\npower_bound = POWER_BOUND;\r\nep_reg = 0x2;\r\n} else {\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x97);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0xBF);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 36, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 37, 0x04);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x85);\r\nrt2800_rfcsr_write(rt2x00dev, 40, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 41, 0xBB);\r\nrt2800_rfcsr_write(rt2x00dev, 42, 0xD7);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0x41);\r\nrt2800_rfcsr_write(rt2x00dev, 48, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x77);\r\nrt2800_rfcsr_write(rt2x00dev, 60, 0x05);\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0x01);\r\nif (rf->channel >= 36 && rf->channel <= 64) {\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x2E);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x22);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x60);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x7F);\r\nif (rf->channel <= 50)\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x09);\r\nelse if (rf->channel >= 52)\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x07);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x1C);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x5B);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0X40);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0X00);\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0xFE);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x0C);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0xF8);\r\nif (rf->channel <= 50) {\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x06),\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xD3);\r\n} else if (rf->channel >= 52) {\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x04);\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xBB);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x15);\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x7F);\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x15);\r\n} else if (rf->channel >= 100 && rf->channel <= 165) {\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x0E);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x40);\r\nif (rf->channel <= 153) {\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x3C);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x06);\r\n} else if (rf->channel >= 155) {\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x38);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x05);\r\n}\r\nif (rf->channel <= 138) {\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x1A);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x3B);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x18);\r\n} else if (rf->channel >= 140) {\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x18);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x1B);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0X08);\r\n}\r\nif (rf->channel <= 124)\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0xFC);\r\nelse if (rf->channel >= 126)\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0xEC);\r\nif (rf->channel <= 138)\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x06);\r\nelse if (rf->channel >= 140)\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x06);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0xEB);\r\nif (rf->channel <= 138)\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x01);\r\nelse if (rf->channel >= 140)\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x00);\r\nif (rf->channel <= 128)\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xBB);\r\nelse if (rf->channel >= 130)\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xAB);\r\nif (rf->channel <= 116)\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x1D);\r\nelse if (rf->channel >= 118)\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x15);\r\nif (rf->channel <= 138)\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x3F);\r\nelse if (rf->channel >= 140)\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x7C);\r\nif (rf->channel <= 116)\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x1D);\r\nelse if (rf->channel >= 118)\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x15);\r\n}\r\npower_bound = POWER_BOUND_5G;\r\nep_reg = 0x3;\r\n}\r\nrt2800_rfcsr_read(rt2x00dev, 49, &rfcsr);\r\nif (info->default_power1 > power_bound)\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX, power_bound);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR49_TX, info->default_power1);\r\nif (is_type_ep)\r\nrt2x00_set_field8(&rfcsr, RFCSR49_EP, ep_reg);\r\nrt2800_rfcsr_write(rt2x00dev, 49, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 50, &rfcsr);\r\nif (info->default_power2 > power_bound)\r\nrt2x00_set_field8(&rfcsr, RFCSR50_TX, power_bound);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR50_TX, info->default_power2);\r\nif (is_type_ep)\r\nrt2x00_set_field8(&rfcsr, RFCSR50_EP, ep_reg);\r\nrt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD,\r\nrt2x00dev->default_ant.tx_chain_num >= 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD,\r\nrt2x00dev->default_ant.tx_chain_num == 2);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX2_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD,\r\nrt2x00dev->default_ant.rx_chain_num >= 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD,\r\nrt2x00dev->default_ant.rx_chain_num == 2);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX2_PD, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0xe4);\r\nif (conf_is_ht40(conf))\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x16);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x10);\r\nif (!is_11b) {\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0x80);\r\n}\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nrt2800_rfcsr_read(rt2x00dev, 3, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\r\nrt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 79, (rf->channel <= 14) ? 0x1C : 0x18);\r\nrt2800_bbp_write(rt2x00dev, 80, (rf->channel <= 14) ? 0x0E : 0x08);\r\nrt2800_bbp_write(rt2x00dev, 81, (rf->channel <= 14) ? 0x3A : 0x38);\r\nrt2800_bbp_write(rt2x00dev, 82, (rf->channel <= 14) ? 0x62 : 0x92);\r\nrt2800_bbp_write(rt2x00dev, 195, 128);\r\nrt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0xE0 : 0xF0);\r\nrt2800_bbp_write(rt2x00dev, 195, 129);\r\nrt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x1F : 0x1E);\r\nrt2800_bbp_write(rt2x00dev, 195, 130);\r\nrt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x38 : 0x28);\r\nrt2800_bbp_write(rt2x00dev, 195, 131);\r\nrt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x32 : 0x20);\r\nrt2800_bbp_write(rt2x00dev, 195, 133);\r\nrt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x28 : 0x7F);\r\nrt2800_bbp_write(rt2x00dev, 195, 124);\r\nrt2800_bbp_write(rt2x00dev, 196, (rf->channel <= 14) ? 0x19 : 0x7F);\r\n}\r\nstatic void rt2800_bbp_write_with_rx_chain(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int word,\r\nconst u8 value)\r\n{\r\nu8 chain, reg;\r\nfor (chain = 0; chain < rt2x00dev->default_ant.rx_chain_num; chain++) {\r\nrt2800_bbp_read(rt2x00dev, 27, &reg);\r\nrt2x00_set_field8(&reg, BBP27_RX_CHAIN_SEL, chain);\r\nrt2800_bbp_write(rt2x00dev, 27, reg);\r\nrt2800_bbp_write(rt2x00dev, word, value);\r\n}\r\n}\r\nstatic void rt2800_iq_calibrate(struct rt2x00_dev *rt2x00dev, int channel)\r\n{\r\nu8 cal;\r\nrt2800_bbp_write(rt2x00dev, 158, 0x2c);\r\nif (channel <= 14)\r\ncal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_GAIN_CAL_TX0_2G);\r\nelse if (channel >= 36 && channel <= 64)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_GAIN_CAL_TX0_CH36_TO_CH64_5G);\r\nelse if (channel >= 100 && channel <= 138)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_GAIN_CAL_TX0_CH100_TO_CH138_5G);\r\nelse if (channel >= 140 && channel <= 165)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_GAIN_CAL_TX0_CH140_TO_CH165_5G);\r\nelse\r\ncal = 0;\r\nrt2800_bbp_write(rt2x00dev, 159, cal);\r\nrt2800_bbp_write(rt2x00dev, 158, 0x2d);\r\nif (channel <= 14)\r\ncal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_PHASE_CAL_TX0_2G);\r\nelse if (channel >= 36 && channel <= 64)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_PHASE_CAL_TX0_CH36_TO_CH64_5G);\r\nelse if (channel >= 100 && channel <= 138)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_PHASE_CAL_TX0_CH100_TO_CH138_5G);\r\nelse if (channel >= 140 && channel <= 165)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_PHASE_CAL_TX0_CH140_TO_CH165_5G);\r\nelse\r\ncal = 0;\r\nrt2800_bbp_write(rt2x00dev, 159, cal);\r\nrt2800_bbp_write(rt2x00dev, 158, 0x4a);\r\nif (channel <= 14)\r\ncal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_GAIN_CAL_TX1_2G);\r\nelse if (channel >= 36 && channel <= 64)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_GAIN_CAL_TX1_CH36_TO_CH64_5G);\r\nelse if (channel >= 100 && channel <= 138)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_GAIN_CAL_TX1_CH100_TO_CH138_5G);\r\nelse if (channel >= 140 && channel <= 165)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_GAIN_CAL_TX1_CH140_TO_CH165_5G);\r\nelse\r\ncal = 0;\r\nrt2800_bbp_write(rt2x00dev, 159, cal);\r\nrt2800_bbp_write(rt2x00dev, 158, 0x4b);\r\nif (channel <= 14)\r\ncal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_IQ_PHASE_CAL_TX1_2G);\r\nelse if (channel >= 36 && channel <= 64)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_PHASE_CAL_TX1_CH36_TO_CH64_5G);\r\nelse if (channel >= 100 && channel <= 138)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_PHASE_CAL_TX1_CH100_TO_CH138_5G);\r\nelse if (channel >= 140 && channel <= 165)\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_IQ_PHASE_CAL_TX1_CH140_TO_CH165_5G);\r\nelse\r\ncal = 0;\r\nrt2800_bbp_write(rt2x00dev, 159, cal);\r\nrt2800_bbp_write(rt2x00dev, 158, 0x04);\r\ncal = rt2x00_eeprom_byte(rt2x00dev, EEPROM_RF_IQ_COMPENSATION_CONTROL);\r\nrt2800_bbp_write(rt2x00dev, 159, cal != 0xff ? cal : 0);\r\nrt2800_bbp_write(rt2x00dev, 158, 0x03);\r\ncal = rt2x00_eeprom_byte(rt2x00dev,\r\nEEPROM_RF_IQ_IMBALANCE_COMPENSATION_CONTROL);\r\nrt2800_bbp_write(rt2x00dev, 159, cal != 0xff ? cal : 0);\r\n}\r\nstatic char rt2800_txpower_to_dev(struct rt2x00_dev *rt2x00dev,\r\nunsigned int channel,\r\nchar txpower)\r\n{\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\ntxpower = rt2x00_get_field8(txpower, EEPROM_TXPOWER_ALC);\r\nif (channel <= 14)\r\nreturn clamp_t(char, txpower, MIN_G_TXPOWER, MAX_G_TXPOWER);\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nreturn clamp_t(char, txpower, MIN_A_TXPOWER_3593,\r\nMAX_A_TXPOWER_3593);\r\nelse\r\nreturn clamp_t(char, txpower, MIN_A_TXPOWER, MAX_A_TXPOWER);\r\n}\r\nstatic void rt2800_config_channel(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_conf *conf,\r\nstruct rf_channel *rf,\r\nstruct channel_info *info)\r\n{\r\nu32 reg;\r\nunsigned int tx_pin;\r\nu8 bbp, rfcsr;\r\ninfo->default_power1 = rt2800_txpower_to_dev(rt2x00dev, rf->channel,\r\ninfo->default_power1);\r\ninfo->default_power2 = rt2800_txpower_to_dev(rt2x00dev, rf->channel,\r\ninfo->default_power2);\r\nif (rt2x00dev->default_ant.tx_chain_num > 2)\r\ninfo->default_power3 =\r\nrt2800_txpower_to_dev(rt2x00dev, rf->channel,\r\ninfo->default_power3);\r\nswitch (rt2x00dev->chip.rf) {\r\ncase RF2020:\r\ncase RF3020:\r\ncase RF3021:\r\ncase RF3022:\r\ncase RF3320:\r\nrt2800_config_channel_rf3xxx(rt2x00dev, conf, rf, info);\r\nbreak;\r\ncase RF3052:\r\nrt2800_config_channel_rf3052(rt2x00dev, conf, rf, info);\r\nbreak;\r\ncase RF3053:\r\nrt2800_config_channel_rf3053(rt2x00dev, conf, rf, info);\r\nbreak;\r\ncase RF3290:\r\nrt2800_config_channel_rf3290(rt2x00dev, conf, rf, info);\r\nbreak;\r\ncase RF3322:\r\nrt2800_config_channel_rf3322(rt2x00dev, conf, rf, info);\r\nbreak;\r\ncase RF3070:\r\ncase RF5360:\r\ncase RF5362:\r\ncase RF5370:\r\ncase RF5372:\r\ncase RF5390:\r\ncase RF5392:\r\nrt2800_config_channel_rf53xx(rt2x00dev, conf, rf, info);\r\nbreak;\r\ncase RF5592:\r\nrt2800_config_channel_rf55xx(rt2x00dev, conf, rf, info);\r\nbreak;\r\ndefault:\r\nrt2800_config_channel_rf2xxx(rt2x00dev, conf, rf, info);\r\n}\r\nif (rt2x00_rf(rt2x00dev, RF3070) ||\r\nrt2x00_rf(rt2x00dev, RF3290) ||\r\nrt2x00_rf(rt2x00dev, RF3322) ||\r\nrt2x00_rf(rt2x00dev, RF5360) ||\r\nrt2x00_rf(rt2x00dev, RF5362) ||\r\nrt2x00_rf(rt2x00dev, RF5370) ||\r\nrt2x00_rf(rt2x00dev, RF5372) ||\r\nrt2x00_rf(rt2x00dev, RF5390) ||\r\nrt2x00_rf(rt2x00dev, RF5392)) {\r\nrt2800_rfcsr_read(rt2x00dev, 30, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_TX_H20M, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_RX_H20M, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 3, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\r\n}\r\nif (rt2x00_rt(rt2x00dev, RT3352)) {\r\nrt2800_bbp_write(rt2x00dev, 27, 0x0);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x26 + rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 27, 0x20);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x26 + rt2x00dev->lna_gain);\r\n} else if (rt2x00_rt(rt2x00dev, RT3593)) {\r\nif (rf->channel > 14) {\r\nrt2800_bbp_write(rt2x00dev, 70, 0x00);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\n}\r\nif (conf_is_ht40(conf))\r\nrt2800_bbp_write(rt2x00dev, 105, 0x04);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 105, 0x34);\r\nrt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 77, 0x98);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 62, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 63, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 64, 0x37 - rt2x00dev->lna_gain);\r\nrt2800_bbp_write(rt2x00dev, 86, 0);\r\n}\r\nif (rf->channel <= 14) {\r\nif (!rt2x00_rt(rt2x00dev, RT5390) &&\r\n!rt2x00_rt(rt2x00dev, RT5392)) {\r\nif (rt2x00_has_cap_external_lna_bg(rt2x00dev)) {\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 75, 0x46);\r\n} else {\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 82, 0x84);\r\nrt2800_bbp_write(rt2x00dev, 75, 0x50);\r\n}\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nrt2800_bbp_write(rt2x00dev, 83, 0x8a);\r\n}\r\n} else {\r\nif (rt2x00_rt(rt2x00dev, RT3572))\r\nrt2800_bbp_write(rt2x00dev, 82, 0x94);\r\nelse if (rt2x00_rt(rt2x00dev, RT3593))\r\nrt2800_bbp_write(rt2x00dev, 82, 0x82);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 82, 0xf2);\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nrt2800_bbp_write(rt2x00dev, 83, 0x9a);\r\nif (rt2x00_has_cap_external_lna_a(rt2x00dev))\r\nrt2800_bbp_write(rt2x00dev, 75, 0x46);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 75, 0x50);\r\n}\r\nrt2800_register_read(rt2x00dev, TX_BAND_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_BAND_CFG_HT40_MINUS, conf_is_ht40_minus(conf));\r\nrt2x00_set_field32(&reg, TX_BAND_CFG_A, rf->channel > 14);\r\nrt2x00_set_field32(&reg, TX_BAND_CFG_BG, rf->channel <= 14);\r\nrt2800_register_write(rt2x00dev, TX_BAND_CFG, reg);\r\nif (rt2x00_rt(rt2x00dev, RT3572))\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0);\r\ntx_pin = 0;\r\nswitch (rt2x00dev->default_ant.tx_chain_num) {\r\ncase 3:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A2_EN,\r\nrf->channel > 14);\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G2_EN,\r\nrf->channel <= 14);\r\ncase 2:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A1_EN,\r\nrf->channel > 14);\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G1_EN,\r\nrf->channel <= 14);\r\ncase 1:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A0_EN,\r\nrf->channel > 14);\r\nif (rt2x00_has_cap_bt_coexist(rt2x00dev))\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G0_EN, 1);\r\nelse\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G0_EN,\r\nrf->channel <= 14);\r\nbreak;\r\n}\r\nswitch (rt2x00dev->default_ant.rx_chain_num) {\r\ncase 3:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_A2_EN, 1);\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_G2_EN, 1);\r\ncase 2:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_A1_EN, 1);\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_G1_EN, 1);\r\ncase 1:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_A0_EN, 1);\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_LNA_PE_G0_EN, 1);\r\nbreak;\r\n}\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_RFTR_EN, 1);\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_TRSW_EN, 1);\r\nrt2800_register_write(rt2x00dev, TX_PIN_CFG, tx_pin);\r\nif (rt2x00_rt(rt2x00dev, RT3572)) {\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0x80);\r\nif (rf->channel <= 14)\r\nreg = 0x1c + (2 * rt2x00dev->lna_gain);\r\nelse\r\nreg = 0x22 + ((rt2x00dev->lna_gain * 5) / 3);\r\nrt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\r\n}\r\nif (rt2x00_rt(rt2x00dev, RT3593)) {\r\nrt2800_register_read(rt2x00dev, GPIO_CTRL, &reg);\r\nif (rt2x00_is_usb(rt2x00dev) ||\r\nrt2x00_is_pcie(rt2x00dev)) {\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR8, 0);\r\nif (rf->channel <= 14)\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL8, 1);\r\nelse\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL8, 0);\r\n}\r\nif (rt2x00_is_usb(rt2x00dev)) {\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR4, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR7, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL4, 1);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL7, 1);\r\n} else if (rt2x00_is_pcie(rt2x00dev)) {\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR4, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL4, 1);\r\n}\r\nrt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\r\nif (rf->channel <= 14)\r\nreg = 0x1c + 2 * rt2x00dev->lna_gain;\r\nelse\r\nreg = 0x22 + ((rt2x00dev->lna_gain * 5) / 3);\r\nrt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\r\nusleep_range(1000, 1500);\r\n}\r\nif (rt2x00_rt(rt2x00dev, RT5592)) {\r\nrt2800_bbp_write(rt2x00dev, 195, 141);\r\nrt2800_bbp_write(rt2x00dev, 196, conf_is_ht40(conf) ? 0x10 : 0x1a);\r\nreg = (rf->channel <= 14 ? 0x1c : 0x24) + 2 * rt2x00dev->lna_gain;\r\nrt2800_bbp_write_with_rx_chain(rt2x00dev, 66, reg);\r\nrt2800_iq_calibrate(rt2x00dev, rf->channel);\r\n}\r\nrt2800_bbp_read(rt2x00dev, 4, &bbp);\r\nrt2x00_set_field8(&bbp, BBP4_BANDWIDTH, 2 * conf_is_ht40(conf));\r\nrt2800_bbp_write(rt2x00dev, 4, bbp);\r\nrt2800_bbp_read(rt2x00dev, 3, &bbp);\r\nrt2x00_set_field8(&bbp, BBP3_HT40_MINUS, conf_is_ht40_minus(conf));\r\nrt2800_bbp_write(rt2x00dev, 3, bbp);\r\nif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860C)) {\r\nif (conf_is_ht40(conf)) {\r\nrt2800_bbp_write(rt2x00dev, 69, 0x1a);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x16);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 69, 0x16);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x11);\r\n}\r\n}\r\nmsleep(1);\r\nrt2800_register_read(rt2x00dev, CH_IDLE_STA, &reg);\r\nrt2800_register_read(rt2x00dev, CH_BUSY_STA, &reg);\r\nrt2800_register_read(rt2x00dev, CH_BUSY_STA_SEC, &reg);\r\nif (rt2x00_rt(rt2x00dev, RT3352)) {\r\nrt2800_bbp_read(rt2x00dev, 49, &bbp);\r\nrt2x00_set_field8(&bbp, BBP49_UPDATE_FLAG, 0);\r\nrt2800_bbp_write(rt2x00dev, 49, bbp);\r\n}\r\n}\r\nstatic int rt2800_get_gain_calibration_delta(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 tssi_bounds[9];\r\nu8 current_tssi;\r\nu16 eeprom;\r\nu8 step;\r\nint i;\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1, &eeprom);\r\nif (!rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_EXTERNAL_TX_ALC))\r\nreturn 0;\r\nif (rt2x00dev->curr_band == NL80211_BAND_2GHZ) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG1, &eeprom);\r\ntssi_bounds[0] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG1_MINUS4);\r\ntssi_bounds[1] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG1_MINUS3);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG2, &eeprom);\r\ntssi_bounds[2] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG2_MINUS2);\r\ntssi_bounds[3] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG2_MINUS1);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG3, &eeprom);\r\ntssi_bounds[4] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG3_REF);\r\ntssi_bounds[5] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG3_PLUS1);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG4, &eeprom);\r\ntssi_bounds[6] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG4_PLUS2);\r\ntssi_bounds[7] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG4_PLUS3);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_BG5, &eeprom);\r\ntssi_bounds[8] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG5_PLUS4);\r\nstep = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_BG5_AGC_STEP);\r\n} else {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A1, &eeprom);\r\ntssi_bounds[0] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A1_MINUS4);\r\ntssi_bounds[1] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A1_MINUS3);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A2, &eeprom);\r\ntssi_bounds[2] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A2_MINUS2);\r\ntssi_bounds[3] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A2_MINUS1);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A3, &eeprom);\r\ntssi_bounds[4] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A3_REF);\r\ntssi_bounds[5] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A3_PLUS1);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A4, &eeprom);\r\ntssi_bounds[6] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A4_PLUS2);\r\ntssi_bounds[7] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A4_PLUS3);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TSSI_BOUND_A5, &eeprom);\r\ntssi_bounds[8] = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A5_PLUS4);\r\nstep = rt2x00_get_field16(eeprom,\r\nEEPROM_TSSI_BOUND_A5_AGC_STEP);\r\n}\r\nif (tssi_bounds[4] == 0xff || step == 0xff)\r\nreturn 0;\r\nrt2800_bbp_read(rt2x00dev, 49, &current_tssi);\r\nfor (i = 0; i <= 3; i++) {\r\nif (current_tssi > tssi_bounds[i])\r\nbreak;\r\n}\r\nif (i == 4) {\r\nfor (i = 8; i >= 5; i--) {\r\nif (current_tssi < tssi_bounds[i])\r\nbreak;\r\n}\r\n}\r\nreturn (i - 4) * step;\r\n}\r\nstatic int rt2800_get_txpower_bw_comp(struct rt2x00_dev *rt2x00dev,\r\nenum nl80211_band band)\r\n{\r\nu16 eeprom;\r\nu8 comp_en;\r\nu8 comp_type;\r\nint comp_value = 0;\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TXPOWER_DELTA, &eeprom);\r\nif (eeprom == 0xffff ||\r\n!test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags))\r\nreturn 0;\r\nif (band == NL80211_BAND_2GHZ) {\r\ncomp_en = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_DELTA_ENABLE_2G);\r\nif (comp_en) {\r\ncomp_type = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_DELTA_TYPE_2G);\r\ncomp_value = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_DELTA_VALUE_2G);\r\nif (!comp_type)\r\ncomp_value = -comp_value;\r\n}\r\n} else {\r\ncomp_en = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_DELTA_ENABLE_5G);\r\nif (comp_en) {\r\ncomp_type = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_DELTA_TYPE_5G);\r\ncomp_value = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_DELTA_VALUE_5G);\r\nif (!comp_type)\r\ncomp_value = -comp_value;\r\n}\r\n}\r\nreturn comp_value;\r\n}\r\nstatic int rt2800_get_txpower_reg_delta(struct rt2x00_dev *rt2x00dev,\r\nint power_level, int max_power)\r\n{\r\nint delta;\r\nif (rt2x00_has_cap_power_limit(rt2x00dev))\r\nreturn 0;\r\ndelta = power_level - max_power;\r\nreturn min(delta, 0);\r\n}\r\nstatic u8 rt2800_compensate_txpower(struct rt2x00_dev *rt2x00dev, int is_rate_b,\r\nenum nl80211_band band, int power_level,\r\nu8 txpower, int delta)\r\n{\r\nu16 eeprom;\r\nu8 criterion;\r\nu8 eirp_txpower;\r\nu8 eirp_txpower_criterion;\r\nu8 reg_limit;\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nreturn min_t(u8, txpower, 0xc);\r\nif (rt2x00_has_cap_power_limit(rt2x00dev)) {\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\n1, &eeprom);\r\ncriterion = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE0);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_EIRP_MAX_TX_POWER,\r\n&eeprom);\r\nif (band == NL80211_BAND_2GHZ)\r\neirp_txpower_criterion = rt2x00_get_field16(eeprom,\r\nEEPROM_EIRP_MAX_TX_POWER_2GHZ);\r\nelse\r\neirp_txpower_criterion = rt2x00_get_field16(eeprom,\r\nEEPROM_EIRP_MAX_TX_POWER_5GHZ);\r\neirp_txpower = eirp_txpower_criterion + (txpower - criterion) +\r\n(is_rate_b ? 4 : 0) + delta;\r\nreg_limit = (eirp_txpower > power_level) ?\r\n(eirp_txpower - power_level) : 0;\r\n} else\r\nreg_limit = 0;\r\ntxpower = max(0, txpower + delta - reg_limit);\r\nreturn min_t(u8, txpower, 0xc);\r\n}\r\nstatic void rt2800_config_txpower_rt3593(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_channel *chan,\r\nint power_level)\r\n{\r\nu8 txpower;\r\nu16 eeprom;\r\nu32 regs[TX_PWR_CFG_IDX_COUNT];\r\nunsigned int offset;\r\nenum nl80211_band band = chan->band;\r\nint delta;\r\nint i;\r\nmemset(regs, '\0', sizeof(regs));\r\ndelta = rt2800_get_gain_calibration_delta(rt2x00dev);\r\nif (band == NL80211_BAND_5GHZ)\r\noffset = 16;\r\nelse\r\noffset = 0;\r\nif (test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags))\r\noffset += 8;\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 1, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_CCK1_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_CCK1_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\r\nTX_PWR_CFG_0_EXT_CCK1_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 1, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_CCK5_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_CCK5_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\r\nTX_PWR_CFG_0_EXT_CCK5_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_OFDM6_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_OFDM6_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\r\nTX_PWR_CFG_0_EXT_OFDM6_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_OFDM12_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_IDX],\r\nTX_PWR_CFG_0_OFDM12_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_0_EXT_IDX],\r\nTX_PWR_CFG_0_EXT_OFDM12_CH2, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 1, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_OFDM24_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_OFDM24_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\r\nTX_PWR_CFG_1_EXT_OFDM24_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_OFDM48_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_OFDM48_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\r\nTX_PWR_CFG_1_EXT_OFDM48_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\r\nTX_PWR_CFG_7_OFDM54_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\r\nTX_PWR_CFG_7_OFDM54_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\r\nTX_PWR_CFG_7_OFDM54_CH2, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 2, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_MCS0_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_MCS0_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\r\nTX_PWR_CFG_1_EXT_MCS0_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_MCS2_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_IDX],\r\nTX_PWR_CFG_1_MCS2_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_1_EXT_IDX],\r\nTX_PWR_CFG_1_EXT_MCS2_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS4_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS4_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\r\nTX_PWR_CFG_2_EXT_MCS4_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS6_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS6_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\r\nTX_PWR_CFG_2_EXT_MCS6_CH2, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 3, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\r\nTX_PWR_CFG_7_MCS7_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\r\nTX_PWR_CFG_7_MCS7_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_7_IDX],\r\nTX_PWR_CFG_7_MCS7_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS8_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS8_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\r\nTX_PWR_CFG_2_EXT_MCS8_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS10_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_IDX],\r\nTX_PWR_CFG_2_MCS10_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_2_EXT_IDX],\r\nTX_PWR_CFG_2_EXT_MCS10_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_MCS12_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_MCS12_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\r\nTX_PWR_CFG_3_EXT_MCS12_CH2, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 4, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_MCS14_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_MCS14_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\r\nTX_PWR_CFG_3_EXT_MCS14_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\r\nTX_PWR_CFG_8_MCS15_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\r\nTX_PWR_CFG_8_MCS15_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\r\nTX_PWR_CFG_8_MCS15_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\r\nTX_PWR_CFG_5_MCS16_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\r\nTX_PWR_CFG_5_MCS16_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\r\nTX_PWR_CFG_5_MCS16_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\r\nTX_PWR_CFG_5_MCS18_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\r\nTX_PWR_CFG_5_MCS18_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_5_IDX],\r\nTX_PWR_CFG_5_MCS18_CH2, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 5, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\r\nTX_PWR_CFG_6_MCS20_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\r\nTX_PWR_CFG_6_MCS20_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\r\nTX_PWR_CFG_6_MCS20_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\r\nTX_PWR_CFG_6_MCS22_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\r\nTX_PWR_CFG_6_MCS22_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_6_IDX],\r\nTX_PWR_CFG_6_MCS22_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\r\nTX_PWR_CFG_8_MCS23_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\r\nTX_PWR_CFG_8_MCS23_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_8_IDX],\r\nTX_PWR_CFG_8_MCS23_CH2, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 6, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_STBC0_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_STBC0_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\r\nTX_PWR_CFG_3_EXT_STBC0_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_STBC2_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_IDX],\r\nTX_PWR_CFG_3_STBC2_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_3_EXT_IDX],\r\nTX_PWR_CFG_3_EXT_STBC2_CH2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_4_EXT_IDX], TX_PWR_CFG_RATE0,\r\ntxpower);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE2, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_4_IDX], TX_PWR_CFG_RATE3, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_4_EXT_IDX], TX_PWR_CFG_RATE2,\r\ntxpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\noffset + 7, &eeprom);\r\ntxpower = rt2x00_get_field16(eeprom, EEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, 0, band, power_level,\r\ntxpower, delta);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_9_IDX],\r\nTX_PWR_CFG_9_STBC7_CH0, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_9_IDX],\r\nTX_PWR_CFG_9_STBC7_CH1, txpower);\r\nrt2x00_set_field32(&regs[TX_PWR_CFG_9_IDX],\r\nTX_PWR_CFG_9_STBC7_CH2, txpower);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_0, regs[TX_PWR_CFG_0_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_1, regs[TX_PWR_CFG_1_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_2, regs[TX_PWR_CFG_2_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_3, regs[TX_PWR_CFG_3_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_4, regs[TX_PWR_CFG_4_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_5, regs[TX_PWR_CFG_5_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_6, regs[TX_PWR_CFG_6_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_7, regs[TX_PWR_CFG_7_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_8, regs[TX_PWR_CFG_8_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_9, regs[TX_PWR_CFG_9_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_0_EXT,\r\nregs[TX_PWR_CFG_0_EXT_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_1_EXT,\r\nregs[TX_PWR_CFG_1_EXT_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_2_EXT,\r\nregs[TX_PWR_CFG_2_EXT_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_3_EXT,\r\nregs[TX_PWR_CFG_3_EXT_IDX]);\r\nrt2800_register_write(rt2x00dev, TX_PWR_CFG_4_EXT,\r\nregs[TX_PWR_CFG_4_EXT_IDX]);\r\nfor (i = 0; i < TX_PWR_CFG_IDX_COUNT; i++)\r\nrt2x00_dbg(rt2x00dev,\r\n"band:%cGHz, BW:%c0MHz, TX_PWR_CFG_%d%s = %08lx\n",\r\n(band == NL80211_BAND_5GHZ) ? '5' : '2',\r\n(test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags)) ?\r\n'4' : '2',\r\n(i > TX_PWR_CFG_9_IDX) ?\r\n(i - TX_PWR_CFG_9_IDX - 1) : i,\r\n(i > TX_PWR_CFG_9_IDX) ? "_EXT" : "",\r\n(unsigned long) regs[i]);\r\n}\r\nstatic void rt2800_config_txpower_rt28xx(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_channel *chan,\r\nint power_level)\r\n{\r\nu8 txpower, r1;\r\nu16 eeprom;\r\nu32 reg, offset;\r\nint i, is_rate_b, delta, power_ctrl;\r\nenum nl80211_band band = chan->band;\r\ndelta = rt2800_get_txpower_bw_comp(rt2x00dev, band);\r\nswitch (rt2x00dev->chip.rt) {\r\ncase RT2860:\r\ncase RT2872:\r\ncase RT2883:\r\ncase RT3070:\r\ncase RT3071:\r\ncase RT3090:\r\ncase RT3572:\r\ndelta += rt2800_get_gain_calibration_delta(rt2x00dev);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\ndelta += rt2800_get_txpower_reg_delta(rt2x00dev, power_level,\r\nchan->max_power);\r\nif (delta <= -12) {\r\npower_ctrl = 2;\r\ndelta += 12;\r\n} else if (delta <= -6) {\r\npower_ctrl = 1;\r\ndelta += 6;\r\n} else {\r\npower_ctrl = 0;\r\n}\r\nrt2800_bbp_read(rt2x00dev, 1, &r1);\r\nrt2x00_set_field8(&r1, BBP1_TX_POWER_CTRL, power_ctrl);\r\nrt2800_bbp_write(rt2x00dev, 1, r1);\r\noffset = TX_PWR_CFG_0;\r\nfor (i = 0; i < EEPROM_TXPOWER_BYRATE_SIZE; i += 2) {\r\nif (offset > TX_PWR_CFG_4)\r\nbreak;\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\ni, &eeprom);\r\nis_rate_b = i ? 0 : 1;\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE0, txpower);\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE1, txpower);\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE2, txpower);\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE3, txpower);\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_TXPOWER_BYRATE,\r\ni + 1, &eeprom);\r\nis_rate_b = 0;\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE0);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE4, txpower);\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE1);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE5, txpower);\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE2);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE6, txpower);\r\ntxpower = rt2x00_get_field16(eeprom,\r\nEEPROM_TXPOWER_BYRATE_RATE3);\r\ntxpower = rt2800_compensate_txpower(rt2x00dev, is_rate_b, band,\r\npower_level, txpower, delta);\r\nrt2x00_set_field32(&reg, TX_PWR_CFG_RATE7, txpower);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\noffset += 4;\r\n}\r\n}\r\nstatic void rt2800_config_txpower(struct rt2x00_dev *rt2x00dev,\r\nstruct ieee80211_channel *chan,\r\nint power_level)\r\n{\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nrt2800_config_txpower_rt3593(rt2x00dev, chan, power_level);\r\nelse\r\nrt2800_config_txpower_rt28xx(rt2x00dev, chan, power_level);\r\n}\r\nvoid rt2800_gain_calibration(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_config_txpower(rt2x00dev, rt2x00dev->hw->conf.chandef.chan,\r\nrt2x00dev->tx_power);\r\n}\r\nvoid rt2800_vco_calibration(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 tx_pin;\r\nu8 rfcsr;\r\nrt2800_register_read(rt2x00dev, TX_PIN_CFG, &tx_pin);\r\ntx_pin &= TX_PIN_CFG_PA_PE_DISABLE;\r\nrt2800_register_write(rt2x00dev, TX_PIN_CFG, tx_pin);\r\nswitch (rt2x00dev->chip.rf) {\r\ncase RF2020:\r\ncase RF3020:\r\ncase RF3021:\r\ncase RF3022:\r\ncase RF3320:\r\ncase RF3052:\r\nrt2800_rfcsr_read(rt2x00dev, 7, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR7_RF_TUNING, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 7, rfcsr);\r\nbreak;\r\ncase RF3053:\r\ncase RF3070:\r\ncase RF3290:\r\ncase RF5360:\r\ncase RF5362:\r\ncase RF5370:\r\ncase RF5372:\r\ncase RF5390:\r\ncase RF5392:\r\nrt2800_rfcsr_read(rt2x00dev, 3, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR3_VCOCAL_EN, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 3, rfcsr);\r\nbreak;\r\ndefault:\r\nreturn;\r\n}\r\nmdelay(1);\r\nrt2800_register_read(rt2x00dev, TX_PIN_CFG, &tx_pin);\r\nif (rt2x00dev->rf_channel <= 14) {\r\nswitch (rt2x00dev->default_ant.tx_chain_num) {\r\ncase 3:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G2_EN, 1);\r\ncase 2:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G1_EN, 1);\r\ncase 1:\r\ndefault:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_G0_EN, 1);\r\nbreak;\r\n}\r\n} else {\r\nswitch (rt2x00dev->default_ant.tx_chain_num) {\r\ncase 3:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A2_EN, 1);\r\ncase 2:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A1_EN, 1);\r\ncase 1:\r\ndefault:\r\nrt2x00_set_field32(&tx_pin, TX_PIN_CFG_PA_PE_A0_EN, 1);\r\nbreak;\r\n}\r\n}\r\nrt2800_register_write(rt2x00dev, TX_PIN_CFG, tx_pin);\r\n}\r\nstatic void rt2800_config_retry_limit(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_conf *libconf)\r\n{\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, TX_RTY_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_SHORT_RTY_LIMIT,\r\nlibconf->conf->short_frame_max_tx_count);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_LONG_RTY_LIMIT,\r\nlibconf->conf->long_frame_max_tx_count);\r\nrt2800_register_write(rt2x00dev, TX_RTY_CFG, reg);\r\n}\r\nstatic void rt2800_config_ps(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_conf *libconf)\r\n{\r\nenum dev_state state =\r\n(libconf->conf->flags & IEEE80211_CONF_PS) ?\r\nSTATE_SLEEP : STATE_AWAKE;\r\nu32 reg;\r\nif (state == STATE_SLEEP) {\r\nrt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, 0);\r\nrt2800_register_read(rt2x00dev, AUTOWAKEUP_CFG, &reg);\r\nrt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTO_LEAD_TIME, 5);\r\nrt2x00_set_field32(&reg, AUTOWAKEUP_CFG_TBCN_BEFORE_WAKE,\r\nlibconf->conf->listen_interval - 1);\r\nrt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTOWAKE, 1);\r\nrt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, reg);\r\nrt2x00dev->ops->lib->set_device_state(rt2x00dev, state);\r\n} else {\r\nrt2800_register_read(rt2x00dev, AUTOWAKEUP_CFG, &reg);\r\nrt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTO_LEAD_TIME, 0);\r\nrt2x00_set_field32(&reg, AUTOWAKEUP_CFG_TBCN_BEFORE_WAKE, 0);\r\nrt2x00_set_field32(&reg, AUTOWAKEUP_CFG_AUTOWAKE, 0);\r\nrt2800_register_write(rt2x00dev, AUTOWAKEUP_CFG, reg);\r\nrt2x00dev->ops->lib->set_device_state(rt2x00dev, state);\r\n}\r\n}\r\nvoid rt2800_config(struct rt2x00_dev *rt2x00dev,\r\nstruct rt2x00lib_conf *libconf,\r\nconst unsigned int flags)\r\n{\r\nrt2800_config_lna_gain(rt2x00dev, libconf);\r\nif (flags & IEEE80211_CONF_CHANGE_CHANNEL) {\r\nrt2800_config_channel(rt2x00dev, libconf->conf,\r\n&libconf->rf, &libconf->channel);\r\nrt2800_config_txpower(rt2x00dev, libconf->conf->chandef.chan,\r\nlibconf->conf->power_level);\r\n}\r\nif (flags & IEEE80211_CONF_CHANGE_POWER)\r\nrt2800_config_txpower(rt2x00dev, libconf->conf->chandef.chan,\r\nlibconf->conf->power_level);\r\nif (flags & IEEE80211_CONF_CHANGE_RETRY_LIMITS)\r\nrt2800_config_retry_limit(rt2x00dev, libconf);\r\nif (flags & IEEE80211_CONF_CHANGE_PS)\r\nrt2800_config_ps(rt2x00dev, libconf);\r\n}\r\nvoid rt2800_link_stats(struct rt2x00_dev *rt2x00dev, struct link_qual *qual)\r\n{\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, RX_STA_CNT0, &reg);\r\nqual->rx_failed = rt2x00_get_field32(reg, RX_STA_CNT0_CRC_ERR);\r\n}\r\nstatic u8 rt2800_get_default_vgc(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 vgc;\r\nif (rt2x00dev->curr_band == NL80211_BAND_2GHZ) {\r\nif (rt2x00_rt(rt2x00dev, RT3070) ||\r\nrt2x00_rt(rt2x00dev, RT3071) ||\r\nrt2x00_rt(rt2x00dev, RT3090) ||\r\nrt2x00_rt(rt2x00dev, RT3290) ||\r\nrt2x00_rt(rt2x00dev, RT3390) ||\r\nrt2x00_rt(rt2x00dev, RT3572) ||\r\nrt2x00_rt(rt2x00dev, RT3593) ||\r\nrt2x00_rt(rt2x00dev, RT5390) ||\r\nrt2x00_rt(rt2x00dev, RT5392) ||\r\nrt2x00_rt(rt2x00dev, RT5592))\r\nvgc = 0x1c + (2 * rt2x00dev->lna_gain);\r\nelse\r\nvgc = 0x2e + rt2x00dev->lna_gain;\r\n} else {\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nvgc = 0x20 + (rt2x00dev->lna_gain * 5) / 3;\r\nelse if (rt2x00_rt(rt2x00dev, RT5592))\r\nvgc = 0x24 + (2 * rt2x00dev->lna_gain);\r\nelse {\r\nif (!test_bit(CONFIG_CHANNEL_HT40, &rt2x00dev->flags))\r\nvgc = 0x32 + (rt2x00dev->lna_gain * 5) / 3;\r\nelse\r\nvgc = 0x3a + (rt2x00dev->lna_gain * 5) / 3;\r\n}\r\n}\r\nreturn vgc;\r\n}\r\nstatic inline void rt2800_set_vgc(struct rt2x00_dev *rt2x00dev,\r\nstruct link_qual *qual, u8 vgc_level)\r\n{\r\nif (qual->vgc_level != vgc_level) {\r\nif (rt2x00_rt(rt2x00dev, RT3572) ||\r\nrt2x00_rt(rt2x00dev, RT3593)) {\r\nrt2800_bbp_write_with_rx_chain(rt2x00dev, 66,\r\nvgc_level);\r\n} else if (rt2x00_rt(rt2x00dev, RT5592)) {\r\nrt2800_bbp_write(rt2x00dev, 83, qual->rssi > -65 ? 0x4a : 0x7a);\r\nrt2800_bbp_write_with_rx_chain(rt2x00dev, 66, vgc_level);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 66, vgc_level);\r\n}\r\nqual->vgc_level = vgc_level;\r\nqual->vgc_level_reg = vgc_level;\r\n}\r\n}\r\nvoid rt2800_reset_tuner(struct rt2x00_dev *rt2x00dev, struct link_qual *qual)\r\n{\r\nrt2800_set_vgc(rt2x00dev, qual, rt2800_get_default_vgc(rt2x00dev));\r\n}\r\nvoid rt2800_link_tuner(struct rt2x00_dev *rt2x00dev, struct link_qual *qual,\r\nconst u32 count)\r\n{\r\nu8 vgc;\r\nif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860C))\r\nreturn;\r\nvgc = rt2800_get_default_vgc(rt2x00dev);\r\nswitch (rt2x00dev->chip.rt) {\r\ncase RT3572:\r\ncase RT3593:\r\nif (qual->rssi > -65) {\r\nif (rt2x00dev->curr_band == NL80211_BAND_2GHZ)\r\nvgc += 0x20;\r\nelse\r\nvgc += 0x10;\r\n}\r\nbreak;\r\ncase RT5592:\r\nif (qual->rssi > -65)\r\nvgc += 0x20;\r\nbreak;\r\ndefault:\r\nif (qual->rssi > -80)\r\nvgc += 0x10;\r\nbreak;\r\n}\r\nrt2800_set_vgc(rt2x00dev, qual, vgc);\r\n}\r\nstatic int rt2800_init_registers(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nu16 eeprom;\r\nunsigned int i;\r\nint ret;\r\nrt2800_disable_wpdma(rt2x00dev);\r\nret = rt2800_drv_init_registers(rt2x00dev);\r\nif (ret)\r\nreturn ret;\r\nrt2800_register_write(rt2x00dev, LEGACY_BASIC_RATE, 0x0000013f);\r\nrt2800_register_write(rt2x00dev, HT_BASIC_RATE, 0x00008003);\r\nrt2800_register_write(rt2x00dev, MAC_SYS_CTRL, 0x00000000);\r\nrt2800_register_read(rt2x00dev, BCN_TIME_CFG, &reg);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_INTERVAL, 1600);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_TSF_TICKING, 0);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_TSF_SYNC, 0);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_TBTT_ENABLE, 0);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_BEACON_GEN, 0);\r\nrt2x00_set_field32(&reg, BCN_TIME_CFG_TX_TIME_COMPENSATE, 0);\r\nrt2800_register_write(rt2x00dev, BCN_TIME_CFG, reg);\r\nrt2800_config_filter(rt2x00dev, FIF_ALLMULTI);\r\nrt2800_register_read(rt2x00dev, BKOFF_SLOT_CFG, &reg);\r\nrt2x00_set_field32(&reg, BKOFF_SLOT_CFG_SLOT_TIME, 9);\r\nrt2x00_set_field32(&reg, BKOFF_SLOT_CFG_CC_DELAY_TIME, 2);\r\nrt2800_register_write(rt2x00dev, BKOFF_SLOT_CFG, reg);\r\nif (rt2x00_rt(rt2x00dev, RT3290)) {\r\nrt2800_register_read(rt2x00dev, WLAN_FUN_CTRL, &reg);\r\nif (rt2x00_get_field32(reg, WLAN_EN) == 1) {\r\nrt2x00_set_field32(&reg, PCIE_APP0_CLK_REQ, 1);\r\nrt2800_register_write(rt2x00dev, WLAN_FUN_CTRL, reg);\r\n}\r\nrt2800_register_read(rt2x00dev, CMB_CTRL, &reg);\r\nif (!(rt2x00_get_field32(reg, LDO0_EN) == 1)) {\r\nrt2x00_set_field32(&reg, LDO0_EN, 1);\r\nrt2x00_set_field32(&reg, LDO_BGSEL, 3);\r\nrt2800_register_write(rt2x00dev, CMB_CTRL, reg);\r\n}\r\nrt2800_register_read(rt2x00dev, OSC_CTRL, &reg);\r\nrt2x00_set_field32(&reg, OSC_ROSC_EN, 1);\r\nrt2x00_set_field32(&reg, OSC_CAL_REQ, 1);\r\nrt2x00_set_field32(&reg, OSC_REF_CYCLE, 0x27);\r\nrt2800_register_write(rt2x00dev, OSC_CTRL, reg);\r\nrt2800_register_read(rt2x00dev, COEX_CFG0, &reg);\r\nrt2x00_set_field32(&reg, COEX_CFG_ANT, 0x5e);\r\nrt2800_register_write(rt2x00dev, COEX_CFG0, reg);\r\nrt2800_register_read(rt2x00dev, COEX_CFG2, &reg);\r\nrt2x00_set_field32(&reg, BT_COEX_CFG1, 0x00);\r\nrt2x00_set_field32(&reg, BT_COEX_CFG0, 0x17);\r\nrt2x00_set_field32(&reg, WL_COEX_CFG1, 0x93);\r\nrt2x00_set_field32(&reg, WL_COEX_CFG0, 0x7f);\r\nrt2800_register_write(rt2x00dev, COEX_CFG2, reg);\r\nrt2800_register_read(rt2x00dev, PLL_CTRL, &reg);\r\nrt2x00_set_field32(&reg, PLL_CONTROL, 1);\r\nrt2800_register_write(rt2x00dev, PLL_CTRL, reg);\r\n}\r\nif (rt2x00_rt(rt2x00dev, RT3071) ||\r\nrt2x00_rt(rt2x00dev, RT3090) ||\r\nrt2x00_rt(rt2x00dev, RT3290) ||\r\nrt2x00_rt(rt2x00dev, RT3390)) {\r\nif (rt2x00_rt(rt2x00dev, RT3290))\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0,\r\n0x00000404);\r\nelse\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0,\r\n0x00000400);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3390, REV_RT3390E)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1,\r\n&eeprom);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_DAC_TEST))\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2,\r\n0x0000002c);\r\nelse\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2,\r\n0x0000000f);\r\n} else {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\r\n}\r\n} else if (rt2x00_rt(rt2x00dev, RT3070)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000400);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x0000002c);\r\n} else {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\r\n}\r\n} else if (rt2800_is_305x_soc(rt2x00dev)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000400);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000030);\r\n} else if (rt2x00_rt(rt2x00dev, RT3352)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000402);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\r\n} else if (rt2x00_rt(rt2x00dev, RT3572)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000400);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\r\n} else if (rt2x00_rt(rt2x00dev, RT3593)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000402);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00000000);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3593, REV_RT3593E)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1,\r\n&eeprom);\r\nif (rt2x00_get_field16(eeprom,\r\nEEPROM_NIC_CONF1_DAC_TEST))\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2,\r\n0x0000001f);\r\nelse\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2,\r\n0x0000000f);\r\n} else {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2,\r\n0x00000000);\r\n}\r\n} else if (rt2x00_rt(rt2x00dev, RT5390) ||\r\nrt2x00_rt(rt2x00dev, RT5392) ||\r\nrt2x00_rt(rt2x00dev, RT5592)) {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000404);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG2, 0x00000000);\r\n} else {\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG0, 0x00000000);\r\nrt2800_register_write(rt2x00dev, TX_SW_CFG1, 0x00080606);\r\n}\r\nrt2800_register_read(rt2x00dev, TX_LINK_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_MFB_LIFETIME, 32);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_MFB_ENABLE, 0);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_UMFS_ENABLE, 0);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_TX_MRQ_EN, 0);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_TX_RDG_EN, 0);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_TX_CF_ACK_EN, 1);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_MFB, 0);\r\nrt2x00_set_field32(&reg, TX_LINK_CFG_REMOTE_MFS, 0);\r\nrt2800_register_write(rt2x00dev, TX_LINK_CFG, reg);\r\nrt2800_register_read(rt2x00dev, TX_TIMEOUT_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_TIMEOUT_CFG_MPDU_LIFETIME, 9);\r\nrt2x00_set_field32(&reg, TX_TIMEOUT_CFG_RX_ACK_TIMEOUT, 32);\r\nrt2x00_set_field32(&reg, TX_TIMEOUT_CFG_TX_OP_TIMEOUT, 10);\r\nrt2800_register_write(rt2x00dev, TX_TIMEOUT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MAX_LEN_CFG, &reg);\r\nrt2x00_set_field32(&reg, MAX_LEN_CFG_MAX_MPDU, AGGREGATION_SIZE);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT2872, REV_RT2872E) ||\r\nrt2x00_rt(rt2x00dev, RT2883) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070E))\r\nrt2x00_set_field32(&reg, MAX_LEN_CFG_MAX_PSDU, 2);\r\nelse\r\nrt2x00_set_field32(&reg, MAX_LEN_CFG_MAX_PSDU, 1);\r\nrt2x00_set_field32(&reg, MAX_LEN_CFG_MIN_PSDU, 0);\r\nrt2x00_set_field32(&reg, MAX_LEN_CFG_MIN_MPDU, 0);\r\nrt2800_register_write(rt2x00dev, MAX_LEN_CFG, reg);\r\nrt2800_register_read(rt2x00dev, LED_CFG, &reg);\r\nrt2x00_set_field32(&reg, LED_CFG_ON_PERIOD, 70);\r\nrt2x00_set_field32(&reg, LED_CFG_OFF_PERIOD, 30);\r\nrt2x00_set_field32(&reg, LED_CFG_SLOW_BLINK_PERIOD, 3);\r\nrt2x00_set_field32(&reg, LED_CFG_R_LED_MODE, 3);\r\nrt2x00_set_field32(&reg, LED_CFG_G_LED_MODE, 3);\r\nrt2x00_set_field32(&reg, LED_CFG_Y_LED_MODE, 3);\r\nrt2x00_set_field32(&reg, LED_CFG_LED_POLAR, 1);\r\nrt2800_register_write(rt2x00dev, LED_CFG, reg);\r\nrt2800_register_write(rt2x00dev, PBF_MAX_PCNT, 0x1f3fbf9f);\r\nrt2800_register_read(rt2x00dev, TX_RTY_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_SHORT_RTY_LIMIT, 15);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_LONG_RTY_LIMIT, 31);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_LONG_RTY_THRE, 2000);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_NON_AGG_RTY_MODE, 0);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_AGG_RTY_MODE, 0);\r\nrt2x00_set_field32(&reg, TX_RTY_CFG_TX_AUTO_FB_ENABLE, 1);\r\nrt2800_register_write(rt2x00dev, TX_RTY_CFG, reg);\r\nrt2800_register_read(rt2x00dev, AUTO_RSP_CFG, &reg);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_AUTORESPONDER, 1);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_BAC_ACK_POLICY, 1);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_CTS_40_MMODE, 0);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_CTS_40_MREF, 0);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_AR_PREAMBLE, 1);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_DUAL_CTS_EN, 0);\r\nrt2x00_set_field32(&reg, AUTO_RSP_CFG_ACK_CTS_PSM_BIT, 0);\r\nrt2800_register_write(rt2x00dev, AUTO_RSP_CFG, reg);\r\nrt2800_register_read(rt2x00dev, CCK_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_PROTECT_RATE, 3);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_PROTECT_CTRL, 0);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_PROTECT_NAV_SHORT, 1);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_CCK, 1);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_MM20, 1);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_MM40, 0);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_GF20, 1);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_TX_OP_ALLOW_GF40, 0);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_RTS_TH_EN, 1);\r\nrt2800_register_write(rt2x00dev, CCK_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, OFDM_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_RATE, 3);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_CTRL, 0);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_PROTECT_NAV_SHORT, 1);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_CCK, 1);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_MM20, 1);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_MM40, 0);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_GF20, 1);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_TX_OP_ALLOW_GF40, 0);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_RTS_TH_EN, 1);\r\nrt2800_register_write(rt2x00dev, OFDM_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MM20_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_RATE, 0x4004);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_CTRL, 0);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_PROTECT_NAV_SHORT, 1);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_CCK, 1);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_MM20, 1);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_MM40, 0);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_GF20, 1);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_TX_OP_ALLOW_GF40, 0);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_RTS_TH_EN, 0);\r\nrt2800_register_write(rt2x00dev, MM20_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MM40_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_RATE, 0x4084);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_CTRL, 0);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_PROTECT_NAV_SHORT, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_CCK, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_MM20, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_MM40, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_GF20, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_TX_OP_ALLOW_GF40, 1);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_RTS_TH_EN, 0);\r\nrt2800_register_write(rt2x00dev, MM40_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, GF20_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_RATE, 0x4004);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_CTRL, 0);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_PROTECT_NAV_SHORT, 1);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_CCK, 1);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_MM20, 1);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_MM40, 0);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_GF20, 1);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_TX_OP_ALLOW_GF40, 0);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_RTS_TH_EN, 0);\r\nrt2800_register_write(rt2x00dev, GF20_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, GF40_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_RATE, 0x4084);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_CTRL, 0);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_PROTECT_NAV_SHORT, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_CCK, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_OFDM, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_MM20, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_MM40, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_GF20, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_TX_OP_ALLOW_GF40, 1);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_RTS_TH_EN, 0);\r\nrt2800_register_write(rt2x00dev, GF40_PROT_CFG, reg);\r\nif (rt2x00_is_usb(rt2x00dev)) {\r\nrt2800_register_write(rt2x00dev, PBF_CFG, 0xf40006);\r\nrt2800_register_read(rt2x00dev, WPDMA_GLO_CFG, &reg);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_TX_DMA, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_DMA_BUSY, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_RX_DMA, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_RX_DMA_BUSY, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_WP_DMA_BURST_SIZE, 3);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_WRITEBACK_DONE, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_BIG_ENDIAN, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_RX_HDR_SCATTER, 0);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_HDR_SEG_LEN, 0);\r\nrt2800_register_write(rt2x00dev, WPDMA_GLO_CFG, reg);\r\n}\r\nrt2800_register_read(rt2x00dev, TXOP_CTRL_CFG, &reg);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_TIMEOUT_TRUN_EN, 1);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_AC_TRUN_EN, 1);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_TXRATEGRP_TRUN_EN, 1);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_USER_MODE_TRUN_EN, 1);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_MIMO_PS_TRUN_EN, 1);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_RESERVED_TRUN_EN, 1);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_LSIG_TXOP_EN, 0);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_EXT_CCA_EN, 0);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_EXT_CCA_DLY, 88);\r\nrt2x00_set_field32(&reg, TXOP_CTRL_CFG_EXT_CWMIN, 0);\r\nrt2800_register_write(rt2x00dev, TXOP_CTRL_CFG, reg);\r\nreg = rt2x00_rt(rt2x00dev, RT5592) ? 0x00000082 : 0x00000002;\r\nrt2800_register_write(rt2x00dev, TXOP_HLDR_ET, reg);\r\nrt2800_register_read(rt2x00dev, TX_RTS_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_RTS_CFG_AUTO_RTS_RETRY_LIMIT, 32);\r\nrt2x00_set_field32(&reg, TX_RTS_CFG_RTS_THRES,\r\nIEEE80211_MAX_RTS_THRESHOLD);\r\nrt2x00_set_field32(&reg, TX_RTS_CFG_RTS_FBK_EN, 0);\r\nrt2800_register_write(rt2x00dev, TX_RTS_CFG, reg);\r\nrt2800_register_write(rt2x00dev, EXP_ACK_TIME, 0x002400ca);\r\nrt2800_register_read(rt2x00dev, XIFS_TIME_CFG, &reg);\r\nrt2x00_set_field32(&reg, XIFS_TIME_CFG_CCKM_SIFS_TIME, 16);\r\nrt2x00_set_field32(&reg, XIFS_TIME_CFG_OFDM_SIFS_TIME, 16);\r\nrt2x00_set_field32(&reg, XIFS_TIME_CFG_OFDM_XIFS_TIME, 4);\r\nrt2x00_set_field32(&reg, XIFS_TIME_CFG_EIFS, 314);\r\nrt2x00_set_field32(&reg, XIFS_TIME_CFG_BB_RXEND_ENABLE, 1);\r\nrt2800_register_write(rt2x00dev, XIFS_TIME_CFG, reg);\r\nrt2800_register_write(rt2x00dev, PWR_PIN_CFG, 0x00000003);\r\nfor (i = 0; i < 4; i++)\r\nrt2800_register_write(rt2x00dev,\r\nSHARED_KEY_MODE_ENTRY(i), 0);\r\nfor (i = 0; i < 256; i++) {\r\nrt2800_config_wcid(rt2x00dev, NULL, i);\r\nrt2800_delete_wcid_attr(rt2x00dev, i);\r\nrt2800_register_write(rt2x00dev, MAC_IVEIV_ENTRY(i), 0);\r\n}\r\nfor (i = 0; i < 8; i++)\r\nrt2800_clear_beacon_register(rt2x00dev, i);\r\nif (rt2x00_is_usb(rt2x00dev)) {\r\nrt2800_register_read(rt2x00dev, US_CYC_CNT, &reg);\r\nrt2x00_set_field32(&reg, US_CYC_CNT_CLOCK_CYCLE, 30);\r\nrt2800_register_write(rt2x00dev, US_CYC_CNT, reg);\r\n} else if (rt2x00_is_pcie(rt2x00dev)) {\r\nrt2800_register_read(rt2x00dev, US_CYC_CNT, &reg);\r\nrt2x00_set_field32(&reg, US_CYC_CNT_CLOCK_CYCLE, 125);\r\nrt2800_register_write(rt2x00dev, US_CYC_CNT, reg);\r\n}\r\nrt2800_register_read(rt2x00dev, HT_FBK_CFG0, &reg);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS0FBK, 0);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS1FBK, 0);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS2FBK, 1);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS3FBK, 2);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS4FBK, 3);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS5FBK, 4);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS6FBK, 5);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG0_HTMCS7FBK, 6);\r\nrt2800_register_write(rt2x00dev, HT_FBK_CFG0, reg);\r\nrt2800_register_read(rt2x00dev, HT_FBK_CFG1, &reg);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS8FBK, 8);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS9FBK, 8);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS10FBK, 9);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS11FBK, 10);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS12FBK, 11);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS13FBK, 12);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS14FBK, 13);\r\nrt2x00_set_field32(&reg, HT_FBK_CFG1_HTMCS15FBK, 14);\r\nrt2800_register_write(rt2x00dev, HT_FBK_CFG1, reg);\r\nrt2800_register_read(rt2x00dev, LG_FBK_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS0FBK, 8);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS1FBK, 8);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS2FBK, 9);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS3FBK, 10);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS4FBK, 11);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS5FBK, 12);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS6FBK, 13);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_OFDMMCS7FBK, 14);\r\nrt2800_register_write(rt2x00dev, LG_FBK_CFG0, reg);\r\nrt2800_register_read(rt2x00dev, LG_FBK_CFG1, &reg);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS0FBK, 0);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS1FBK, 0);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS2FBK, 1);\r\nrt2x00_set_field32(&reg, LG_FBK_CFG0_CCKMCS3FBK, 2);\r\nrt2800_register_write(rt2x00dev, LG_FBK_CFG1, reg);\r\nrt2800_register_read(rt2x00dev, AMPDU_BA_WINSIZE, &reg);\r\nrt2x00_set_field32(&reg, AMPDU_BA_WINSIZE_FORCE_WINSIZE_ENABLE, 0);\r\nrt2x00_set_field32(&reg, AMPDU_BA_WINSIZE_FORCE_WINSIZE, 0);\r\nrt2800_register_write(rt2x00dev, AMPDU_BA_WINSIZE, reg);\r\nrt2800_register_read(rt2x00dev, RX_STA_CNT0, &reg);\r\nrt2800_register_read(rt2x00dev, RX_STA_CNT1, &reg);\r\nrt2800_register_read(rt2x00dev, RX_STA_CNT2, &reg);\r\nrt2800_register_read(rt2x00dev, TX_STA_CNT0, &reg);\r\nrt2800_register_read(rt2x00dev, TX_STA_CNT1, &reg);\r\nrt2800_register_read(rt2x00dev, TX_STA_CNT2, &reg);\r\nrt2800_register_read(rt2x00dev, INT_TIMER_CFG, &reg);\r\nrt2x00_set_field32(&reg, INT_TIMER_CFG_PRE_TBTT_TIMER, 6 << 4);\r\nrt2800_register_write(rt2x00dev, INT_TIMER_CFG, reg);\r\nrt2800_register_read(rt2x00dev, CH_TIME_CFG, &reg);\r\nrt2x00_set_field32(&reg, CH_TIME_CFG_EIFS_BUSY, 1);\r\nrt2x00_set_field32(&reg, CH_TIME_CFG_NAV_BUSY, 1);\r\nrt2x00_set_field32(&reg, CH_TIME_CFG_RX_BUSY, 1);\r\nrt2x00_set_field32(&reg, CH_TIME_CFG_TX_BUSY, 1);\r\nrt2x00_set_field32(&reg, CH_TIME_CFG_TMR_EN, 1);\r\nrt2800_register_write(rt2x00dev, CH_TIME_CFG, reg);\r\nreturn 0;\r\n}\r\nstatic int rt2800_wait_bbp_rf_ready(struct rt2x00_dev *rt2x00dev)\r\n{\r\nunsigned int i;\r\nu32 reg;\r\nfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\r\nrt2800_register_read(rt2x00dev, MAC_STATUS_CFG, &reg);\r\nif (!rt2x00_get_field32(reg, MAC_STATUS_CFG_BBP_RF_BUSY))\r\nreturn 0;\r\nudelay(REGISTER_BUSY_DELAY);\r\n}\r\nrt2x00_err(rt2x00dev, "BBP/RF register access failed, aborting\n");\r\nreturn -EACCES;\r\n}\r\nstatic int rt2800_wait_bbp_ready(struct rt2x00_dev *rt2x00dev)\r\n{\r\nunsigned int i;\r\nu8 value;\r\nrt2800_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\r\nrt2800_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\r\nmsleep(1);\r\nfor (i = 0; i < REGISTER_BUSY_COUNT; i++) {\r\nrt2800_bbp_read(rt2x00dev, 0, &value);\r\nif ((value != 0xff) && (value != 0x00))\r\nreturn 0;\r\nudelay(REGISTER_BUSY_DELAY);\r\n}\r\nrt2x00_err(rt2x00dev, "BBP register access failed, aborting\n");\r\nreturn -EACCES;\r\n}\r\nstatic void rt2800_bbp4_mac_if_ctrl(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 value;\r\nrt2800_bbp_read(rt2x00dev, 4, &value);\r\nrt2x00_set_field8(&value, BBP4_MAC_IF_CTRL, 1);\r\nrt2800_bbp_write(rt2x00dev, 4, value);\r\n}\r\nstatic void rt2800_init_freq_calibration(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 142, 1);\r\nrt2800_bbp_write(rt2x00dev, 143, 57);\r\n}\r\nstatic void rt2800_init_bbp_5592_glrt(struct rt2x00_dev *rt2x00dev)\r\n{\r\nconst u8 glrt_table[] = {\r\n0xE0, 0x1F, 0X38, 0x32, 0x08, 0x28, 0x19, 0x0A, 0xFF, 0x00,\r\n0x16, 0x10, 0x10, 0x0B, 0x36, 0x2C, 0x26, 0x24, 0x42, 0x36,\r\n0x30, 0x2D, 0x4C, 0x46, 0x3D, 0x40, 0x3E, 0x42, 0x3D, 0x40,\r\n0X3C, 0x34, 0x2C, 0x2F, 0x3C, 0x35, 0x2E, 0x2A, 0x49, 0x41,\r\n0x36, 0x31, 0x30, 0x30, 0x0E, 0x0D, 0x28, 0x21, 0x1C, 0x16,\r\n0x50, 0x4A, 0x43, 0x40, 0x10, 0x10, 0x10, 0x10, 0x00, 0x00,\r\n0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,\r\n0x00, 0x00, 0x7D, 0x14, 0x32, 0x2C, 0x36, 0x4C, 0x43, 0x2C,\r\n0x2E, 0x36, 0x30, 0x6E,\r\n};\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(glrt_table); i++) {\r\nrt2800_bbp_write(rt2x00dev, 195, 128 + i);\r\nrt2800_bbp_write(rt2x00dev, 196, glrt_table[i]);\r\n}\r\n}\r\nstatic void rt2800_init_bbp_early(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2C);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0B);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x10);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x37);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6A);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 103, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\n}\r\nstatic void rt2800_disable_unused_dac_adc(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu16 eeprom;\r\nu8 value;\r\nrt2800_bbp_read(rt2x00dev, 138, &value);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0, &eeprom);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH) == 1)\r\nvalue |= 0x20;\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH) == 1)\r\nvalue &= ~0x02;\r\nrt2800_bbp_write(rt2x00dev, 138, value);\r\n}\r\nstatic void rt2800_init_bbp_305x_soc(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x10);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 78, 0x0e);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x01);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\n}\r\nstatic void rt2800_init_bbp_28xx(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860C)) {\r\nrt2800_bbp_write(rt2x00dev, 69, 0x16);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x12);\r\n} else {\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x10);\r\n}\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x37);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6a);\r\nif (rt2x00_rt_rev(rt2x00dev, RT2860, REV_RT2860D))\r\nrt2800_bbp_write(rt2x00dev, 84, 0x19);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 103, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\n}\r\nstatic void rt2800_init_bbp_30xx(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x10);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 79, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x33);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x00);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT3070, REV_RT3070F) ||\r\nrt2x00_rt_rev_gte(rt2x00dev, RT3071, REV_RT3071E) ||\r\nrt2x00_rt_rev_gte(rt2x00dev, RT3090, REV_RT3090E))\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 103, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\nif (rt2x00_rt(rt2x00dev, RT3071) ||\r\nrt2x00_rt(rt2x00dev, RT3090))\r\nrt2800_disable_unused_dac_adc(rt2x00dev);\r\n}\r\nstatic void rt2800_init_bbp_3290(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 value;\r\nrt2800_bbp4_mac_if_ctrl(rt2x00dev);\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0b);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 75, 0x46);\r\nrt2800_bbp_write(rt2x00dev, 76, 0x28);\r\nrt2800_bbp_write(rt2x00dev, 77, 0x58);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 74, 0x0b);\r\nrt2800_bbp_write(rt2x00dev, 79, 0x18);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x09);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x33);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x7a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x9a);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x02);\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nrt2800_bbp_write(rt2x00dev, 104, 0x92);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x1c);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x03);\r\nrt2800_bbp_write(rt2x00dev, 128, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 67, 0x24);\r\nrt2800_bbp_write(rt2x00dev, 143, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 142, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 150, 0x30);\r\nrt2800_bbp_write(rt2x00dev, 151, 0x2e);\r\nrt2800_bbp_write(rt2x00dev, 152, 0x20);\r\nrt2800_bbp_write(rt2x00dev, 153, 0x34);\r\nrt2800_bbp_write(rt2x00dev, 154, 0x40);\r\nrt2800_bbp_write(rt2x00dev, 155, 0x3b);\r\nrt2800_bbp_write(rt2x00dev, 253, 0x04);\r\nrt2800_bbp_read(rt2x00dev, 47, &value);\r\nrt2x00_set_field8(&value, BBP47_TSSI_ADC6, 1);\r\nrt2800_bbp_write(rt2x00dev, 47, value);\r\nrt2800_bbp_read(rt2x00dev, 3, &value);\r\nrt2x00_set_field8(&value, BBP3_ADC_MODE_SWITCH, 1);\r\nrt2x00_set_field8(&value, BBP3_ADC_INIT_MODE, 1);\r\nrt2800_bbp_write(rt2x00dev, 3, value);\r\n}\r\nstatic void rt2800_init_bbp_3352(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 3, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 4, 0x50);\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 47, 0x48);\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0b);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 75, 0x46);\r\nrt2800_bbp_write(rt2x00dev, 76, 0x28);\r\nrt2800_bbp_write(rt2x00dev, 77, 0x59);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 78, 0x0e);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x37);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 88, 0x90);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x02);\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nrt2800_bbp_write(rt2x00dev, 104, 0x92);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x34);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 120, 0x50);\r\nrt2800_bbp_write(rt2x00dev, 137, 0x0f);\r\nrt2800_bbp_write(rt2x00dev, 163, 0xbd);\r\nrt2800_bbp_write(rt2x00dev, 179, 0x02);\r\nrt2800_bbp_write(rt2x00dev, 180, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 182, 0x40);\r\nrt2800_bbp_write(rt2x00dev, 180, 0x01);\r\nrt2800_bbp_write(rt2x00dev, 182, 0x9c);\r\nrt2800_bbp_write(rt2x00dev, 179, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 142, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 143, 0x3b);\r\nrt2800_bbp_write(rt2x00dev, 142, 0x06);\r\nrt2800_bbp_write(rt2x00dev, 143, 0xa0);\r\nrt2800_bbp_write(rt2x00dev, 142, 0x07);\r\nrt2800_bbp_write(rt2x00dev, 143, 0xa1);\r\nrt2800_bbp_write(rt2x00dev, 142, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 143, 0xa2);\r\nrt2800_bbp_write(rt2x00dev, 148, 0xc8);\r\n}\r\nstatic void rt2800_init_bbp_3390(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x10);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 79, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x33);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x00);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT3390, REV_RT3390E))\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 103, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\nrt2800_disable_unused_dac_adc(rt2x00dev);\r\n}\r\nstatic void rt2800_init_bbp_3572(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x10);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 79, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x33);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x6a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x99);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x00);\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\nrt2800_disable_unused_dac_adc(rt2x00dev);\r\n}\r\nstatic void rt2800_init_bbp_3593(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_init_bbp_early(rt2x00dev);\r\nrt2800_bbp_write(rt2x00dev, 79, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x33);\r\nrt2800_bbp_write(rt2x00dev, 137, 0x0f);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x19);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT3593, REV_RT3593E))\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\n}\r\nstatic void rt2800_init_bbp_53xx(struct rt2x00_dev *rt2x00dev)\r\n{\r\nint ant, div_mode;\r\nu16 eeprom;\r\nu8 value;\r\nrt2800_bbp4_mac_if_ctrl(rt2x00dev);\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2c);\r\nrt2800_bbp_write(rt2x00dev, 66, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0b);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 75, 0x46);\r\nrt2800_bbp_write(rt2x00dev, 76, 0x28);\r\nrt2800_bbp_write(rt2x00dev, 77, 0x59);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x0a);\r\nrt2800_bbp_write(rt2x00dev, 79, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 80, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 81, 0x33);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x62);\r\nrt2800_bbp_write(rt2x00dev, 83, 0x7a);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x9a);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x38);\r\nif (rt2x00_rt(rt2x00dev, RT5392))\r\nrt2800_bbp_write(rt2x00dev, 88, 0x90);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x02);\r\nif (rt2x00_rt(rt2x00dev, RT5392)) {\r\nrt2800_bbp_write(rt2x00dev, 95, 0x9a);\r\nrt2800_bbp_write(rt2x00dev, 98, 0x12);\r\n}\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nrt2800_bbp_write(rt2x00dev, 104, 0x92);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x3c);\r\nif (rt2x00_rt(rt2x00dev, RT5390))\r\nrt2800_bbp_write(rt2x00dev, 106, 0x03);\r\nelse if (rt2x00_rt(rt2x00dev, RT5392))\r\nrt2800_bbp_write(rt2x00dev, 106, 0x12);\r\nelse\r\nWARN_ON(1);\r\nrt2800_bbp_write(rt2x00dev, 128, 0x12);\r\nif (rt2x00_rt(rt2x00dev, RT5392)) {\r\nrt2800_bbp_write(rt2x00dev, 134, 0xd0);\r\nrt2800_bbp_write(rt2x00dev, 135, 0xf6);\r\n}\r\nrt2800_disable_unused_dac_adc(rt2x00dev);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1, &eeprom);\r\ndiv_mode = rt2x00_get_field16(eeprom,\r\nEEPROM_NIC_CONF1_ANT_DIVERSITY);\r\nant = (div_mode == 3) ? 1 : 0;\r\nif (rt2x00_has_cap_bt_coexist(rt2x00dev)) {\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, GPIO_CTRL, &reg);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR3, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR6, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL3, 0);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL6, 0);\r\nif (ant == 0)\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL3, 1);\r\nelse if (ant == 1)\r\nrt2x00_set_field32(&reg, GPIO_CTRL_VAL6, 1);\r\nrt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\r\n}\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390R)) {\r\nrt2800_bbp_write(rt2x00dev, 150, 0);\r\nrt2800_bbp_write(rt2x00dev, 151, 0);\r\nrt2800_bbp_write(rt2x00dev, 154, 0);\r\n}\r\nrt2800_bbp_read(rt2x00dev, 152, &value);\r\nif (ant == 0)\r\nrt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 1);\r\nelse\r\nrt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 0);\r\nrt2800_bbp_write(rt2x00dev, 152, value);\r\nrt2800_init_freq_calibration(rt2x00dev);\r\n}\r\nstatic void rt2800_init_bbp_5592(struct rt2x00_dev *rt2x00dev)\r\n{\r\nint ant, div_mode;\r\nu16 eeprom;\r\nu8 value;\r\nrt2800_init_bbp_early(rt2x00dev);\r\nrt2800_bbp_read(rt2x00dev, 105, &value);\r\nrt2x00_set_field8(&value, BBP105_MLD,\r\nrt2x00dev->default_ant.rx_chain_num == 2);\r\nrt2800_bbp_write(rt2x00dev, 105, value);\r\nrt2800_bbp4_mac_if_ctrl(rt2x00dev);\r\nrt2800_bbp_write(rt2x00dev, 20, 0x06);\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 65, 0x2C);\r\nrt2800_bbp_write(rt2x00dev, 68, 0xDD);\r\nrt2800_bbp_write(rt2x00dev, 69, 0x1A);\r\nrt2800_bbp_write(rt2x00dev, 70, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 73, 0x13);\r\nrt2800_bbp_write(rt2x00dev, 74, 0x0F);\r\nrt2800_bbp_write(rt2x00dev, 75, 0x4F);\r\nrt2800_bbp_write(rt2x00dev, 76, 0x28);\r\nrt2800_bbp_write(rt2x00dev, 77, 0x59);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x9A);\r\nrt2800_bbp_write(rt2x00dev, 86, 0x38);\r\nrt2800_bbp_write(rt2x00dev, 88, 0x90);\r\nrt2800_bbp_write(rt2x00dev, 91, 0x04);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x02);\r\nrt2800_bbp_write(rt2x00dev, 95, 0x9a);\r\nrt2800_bbp_write(rt2x00dev, 98, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 103, 0xC0);\r\nrt2800_bbp_write(rt2x00dev, 104, 0x92);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x3C);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x35);\r\nrt2800_bbp_write(rt2x00dev, 128, 0x12);\r\nrt2800_bbp_write(rt2x00dev, 134, 0xD0);\r\nrt2800_bbp_write(rt2x00dev, 135, 0xF6);\r\nrt2800_bbp_write(rt2x00dev, 137, 0x0F);\r\nrt2800_init_bbp_5592_glrt(rt2x00dev);\r\nrt2800_bbp4_mac_if_ctrl(rt2x00dev);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1, &eeprom);\r\ndiv_mode = rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_ANT_DIVERSITY);\r\nant = (div_mode == 3) ? 1 : 0;\r\nrt2800_bbp_read(rt2x00dev, 152, &value);\r\nif (ant == 0) {\r\nrt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 1);\r\n} else {\r\nrt2x00_set_field8(&value, BBP152_RX_DEFAULT_ANT, 0);\r\n}\r\nrt2800_bbp_write(rt2x00dev, 152, value);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5592, REV_RT5592C)) {\r\nrt2800_bbp_read(rt2x00dev, 254, &value);\r\nrt2x00_set_field8(&value, BBP254_BIT7, 1);\r\nrt2800_bbp_write(rt2x00dev, 254, value);\r\n}\r\nrt2800_init_freq_calibration(rt2x00dev);\r\nrt2800_bbp_write(rt2x00dev, 84, 0x19);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5592, REV_RT5592C))\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\n}\r\nstatic void rt2800_init_bbp(struct rt2x00_dev *rt2x00dev)\r\n{\r\nunsigned int i;\r\nu16 eeprom;\r\nu8 reg_id;\r\nu8 value;\r\nif (rt2800_is_305x_soc(rt2x00dev))\r\nrt2800_init_bbp_305x_soc(rt2x00dev);\r\nswitch (rt2x00dev->chip.rt) {\r\ncase RT2860:\r\ncase RT2872:\r\ncase RT2883:\r\nrt2800_init_bbp_28xx(rt2x00dev);\r\nbreak;\r\ncase RT3070:\r\ncase RT3071:\r\ncase RT3090:\r\nrt2800_init_bbp_30xx(rt2x00dev);\r\nbreak;\r\ncase RT3290:\r\nrt2800_init_bbp_3290(rt2x00dev);\r\nbreak;\r\ncase RT3352:\r\nrt2800_init_bbp_3352(rt2x00dev);\r\nbreak;\r\ncase RT3390:\r\nrt2800_init_bbp_3390(rt2x00dev);\r\nbreak;\r\ncase RT3572:\r\nrt2800_init_bbp_3572(rt2x00dev);\r\nbreak;\r\ncase RT3593:\r\nrt2800_init_bbp_3593(rt2x00dev);\r\nreturn;\r\ncase RT5390:\r\ncase RT5392:\r\nrt2800_init_bbp_53xx(rt2x00dev);\r\nbreak;\r\ncase RT5592:\r\nrt2800_init_bbp_5592(rt2x00dev);\r\nreturn;\r\n}\r\nfor (i = 0; i < EEPROM_BBP_SIZE; i++) {\r\nrt2800_eeprom_read_from_array(rt2x00dev, EEPROM_BBP_START, i,\r\n&eeprom);\r\nif (eeprom != 0xffff && eeprom != 0x0000) {\r\nreg_id = rt2x00_get_field16(eeprom, EEPROM_BBP_REG_ID);\r\nvalue = rt2x00_get_field16(eeprom, EEPROM_BBP_VALUE);\r\nrt2800_bbp_write(rt2x00dev, reg_id, value);\r\n}\r\n}\r\n}\r\nstatic void rt2800_led_open_drain_enable(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, OPT_14_CSR, &reg);\r\nrt2x00_set_field32(&reg, OPT_14_CSR_BIT0, 1);\r\nrt2800_register_write(rt2x00dev, OPT_14_CSR, reg);\r\n}\r\nstatic u8 rt2800_init_rx_filter(struct rt2x00_dev *rt2x00dev, bool bw40,\r\nu8 filter_target)\r\n{\r\nunsigned int i;\r\nu8 bbp;\r\nu8 rfcsr;\r\nu8 passband;\r\nu8 stopband;\r\nu8 overtuned = 0;\r\nu8 rfcsr24 = (bw40) ? 0x27 : 0x07;\r\nrt2800_rfcsr_write(rt2x00dev, 24, rfcsr24);\r\nrt2800_bbp_read(rt2x00dev, 4, &bbp);\r\nrt2x00_set_field8(&bbp, BBP4_BANDWIDTH, 2 * bw40);\r\nrt2800_bbp_write(rt2x00dev, 4, bbp);\r\nrt2800_rfcsr_read(rt2x00dev, 31, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR31_RX_H20M, bw40);\r\nrt2800_rfcsr_write(rt2x00dev, 31, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 22, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR22_BASEBAND_LOOPBACK, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 22, rfcsr);\r\nrt2800_bbp_write(rt2x00dev, 24, 0);\r\nfor (i = 0; i < 100; i++) {\r\nrt2800_bbp_write(rt2x00dev, 25, 0x90);\r\nmsleep(1);\r\nrt2800_bbp_read(rt2x00dev, 55, &passband);\r\nif (passband)\r\nbreak;\r\n}\r\nrt2800_bbp_write(rt2x00dev, 24, 0x06);\r\nfor (i = 0; i < 100; i++) {\r\nrt2800_bbp_write(rt2x00dev, 25, 0x90);\r\nmsleep(1);\r\nrt2800_bbp_read(rt2x00dev, 55, &stopband);\r\nif ((passband - stopband) <= filter_target) {\r\nrfcsr24++;\r\novertuned += ((passband - stopband) == filter_target);\r\n} else\r\nbreak;\r\nrt2800_rfcsr_write(rt2x00dev, 24, rfcsr24);\r\n}\r\nrfcsr24 -= !!overtuned;\r\nrt2800_rfcsr_write(rt2x00dev, 24, rfcsr24);\r\nreturn rfcsr24;\r\n}\r\nstatic void rt2800_rf_init_calibration(struct rt2x00_dev *rt2x00dev,\r\nconst unsigned int rf_reg)\r\n{\r\nu8 rfcsr;\r\nrt2800_rfcsr_read(rt2x00dev, rf_reg, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, FIELD8(0x80), 1);\r\nrt2800_rfcsr_write(rt2x00dev, rf_reg, rfcsr);\r\nmsleep(1);\r\nrt2x00_set_field8(&rfcsr, FIELD8(0x80), 0);\r\nrt2800_rfcsr_write(rt2x00dev, rf_reg, rfcsr);\r\n}\r\nstatic void rt2800_rx_filter_calibration(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu8 filter_tgt_bw20;\r\nu8 filter_tgt_bw40;\r\nu8 rfcsr, bbp;\r\nif (rt2x00_rt(rt2x00dev, RT3070)) {\r\nfilter_tgt_bw20 = 0x16;\r\nfilter_tgt_bw40 = 0x19;\r\n} else {\r\nfilter_tgt_bw20 = 0x13;\r\nfilter_tgt_bw40 = 0x15;\r\n}\r\ndrv_data->calibration_bw20 =\r\nrt2800_init_rx_filter(rt2x00dev, false, filter_tgt_bw20);\r\ndrv_data->calibration_bw40 =\r\nrt2800_init_rx_filter(rt2x00dev, true, filter_tgt_bw40);\r\nrt2800_bbp_read(rt2x00dev, 25, &drv_data->bbp25);\r\nrt2800_bbp_read(rt2x00dev, 26, &drv_data->bbp26);\r\nrt2800_bbp_write(rt2x00dev, 24, 0);\r\nrt2800_rfcsr_read(rt2x00dev, 22, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR22_BASEBAND_LOOPBACK, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 22, rfcsr);\r\nrt2800_bbp_read(rt2x00dev, 4, &bbp);\r\nrt2x00_set_field8(&bbp, BBP4_BANDWIDTH, 0);\r\nrt2800_bbp_write(rt2x00dev, 4, bbp);\r\n}\r\nstatic void rt2800_normal_mode_setup_3xxx(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu8 min_gain, rfcsr, bbp;\r\nu16 eeprom;\r\nrt2800_rfcsr_read(rt2x00dev, 17, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR17_TX_LO1_EN, 0);\r\nif (rt2x00_rt(rt2x00dev, RT3070) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3390, REV_RT3390E)) {\r\nif (!rt2x00_has_cap_external_lna_bg(rt2x00dev))\r\nrt2x00_set_field8(&rfcsr, RFCSR17_R, 1);\r\n}\r\nmin_gain = rt2x00_rt(rt2x00dev, RT3070) ? 1 : 2;\r\nif (drv_data->txmixer_gain_24g >= min_gain) {\r\nrt2x00_set_field8(&rfcsr, RFCSR17_TXMIXER_GAIN,\r\ndrv_data->txmixer_gain_24g);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 17, rfcsr);\r\nif (rt2x00_rt(rt2x00dev, RT3090)) {\r\nrt2800_bbp_read(rt2x00dev, 138, &bbp);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0, &eeprom);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH) == 1)\r\nrt2x00_set_field8(&bbp, BBP138_RX_ADC1, 0);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH) == 1)\r\nrt2x00_set_field8(&bbp, BBP138_TX_DAC1, 1);\r\nrt2800_bbp_write(rt2x00dev, 138, bbp);\r\n}\r\nif (rt2x00_rt(rt2x00dev, RT3070)) {\r\nrt2800_rfcsr_read(rt2x00dev, 27, &rfcsr);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F))\r\nrt2x00_set_field8(&rfcsr, RFCSR27_R1, 3);\r\nelse\r\nrt2x00_set_field8(&rfcsr, RFCSR27_R1, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR27_R2, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR27_R3, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR27_R4, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 27, rfcsr);\r\n} else if (rt2x00_rt(rt2x00dev, RT3071) ||\r\nrt2x00_rt(rt2x00dev, RT3090) ||\r\nrt2x00_rt(rt2x00dev, RT3390)) {\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX0_PD, 0);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RX1_PD, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_TX1_PD, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 15, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR15_TX_LO2_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 15, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 20, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR20_RX_LO1_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 20, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 21, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR21_RX_LO2_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 21, rfcsr);\r\n}\r\n}\r\nstatic void rt2800_normal_mode_setup_3593(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu8 rfcsr;\r\nu8 tx_gain;\r\nrt2800_rfcsr_read(rt2x00dev, 50, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR50_TX_LO2_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 50, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 51, &rfcsr);\r\ntx_gain = rt2x00_get_field8(drv_data->txmixer_gain_24g,\r\nRFCSR17_TXMIXER_GAIN);\r\nrt2x00_set_field8(&rfcsr, RFCSR51_BITS24, tx_gain);\r\nrt2800_rfcsr_write(rt2x00dev, 51, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 38, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR38_RX_LO1_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 38, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 39, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR39_RX_LO2_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 39, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 1, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_RF_BLOCK_EN, 1);\r\nrt2x00_set_field8(&rfcsr, RFCSR1_PLL_PD, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 1, rfcsr);\r\nrt2800_rfcsr_read(rt2x00dev, 30, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR30_RX_VCM, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 30, rfcsr);\r\n}\r\nstatic void rt2800_normal_mode_setup_5xxx(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 reg;\r\nu16 eeprom;\r\nrt2800_bbp_read(rt2x00dev, 138, &reg);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0, &eeprom);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH) == 1)\r\nrt2x00_set_field8(&reg, BBP138_RX_ADC1, 0);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH) == 1)\r\nrt2x00_set_field8(&reg, BBP138_TX_DAC1, 1);\r\nrt2800_bbp_write(rt2x00dev, 138, reg);\r\nrt2800_rfcsr_read(rt2x00dev, 38, &reg);\r\nrt2x00_set_field8(&reg, RFCSR38_RX_LO1_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 38, reg);\r\nrt2800_rfcsr_read(rt2x00dev, 39, &reg);\r\nrt2x00_set_field8(&reg, RFCSR39_RX_LO2_EN, 0);\r\nrt2800_rfcsr_write(rt2x00dev, 39, reg);\r\nrt2800_bbp4_mac_if_ctrl(rt2x00dev);\r\nrt2800_rfcsr_read(rt2x00dev, 30, &reg);\r\nrt2x00_set_field8(&reg, RFCSR30_RX_VCM, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 30, reg);\r\n}\r\nstatic void rt2800_init_rfcsr_305x_soc(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_rf_init_calibration(rt2x00dev, 30);\r\nrt2800_rfcsr_write(rt2x00dev, 0, 0x50);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x01);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0xf7);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x75);\r\nrt2800_rfcsr_write(rt2x00dev, 4, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x50);\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0x39);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0x0f);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x60);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x21);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x75);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x75);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x90);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x58);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0xb3);\r\nrt2800_rfcsr_write(rt2x00dev, 17, 0x92);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x2c);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xba);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0xdb);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x31);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x01);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x25);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x23);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x13);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x83);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x00);\r\n}\r\nstatic void rt2800_init_rfcsr_30xx(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 rfcsr;\r\nu16 eeprom;\r\nu32 reg;\r\nrt2800_rf_init_calibration(rt2x00dev, 30);\r\nrt2800_rfcsr_write(rt2x00dev, 4, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x60);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0x0f);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x41);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x21);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x7b);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x90);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x58);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0xb3);\r\nrt2800_rfcsr_write(rt2x00dev, 17, 0x92);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x2c);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xba);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0xdb);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x16);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x1f);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F)) {\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\n} else if (rt2x00_rt(rt2x00dev, RT3071) ||\r\nrt2x00_rt(rt2x00dev, RT3090)) {\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x14);\r\nrt2800_rfcsr_read(rt2x00dev, 6, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR6_R2, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1,\r\n&eeprom);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_DAC_TEST))\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\r\nelse\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 0);\r\n}\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\nrt2800_register_read(rt2x00dev, GPIO_SWITCH, &reg);\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_5, 0);\r\nrt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\r\n}\r\nrt2800_rx_filter_calibration(rt2x00dev);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3070, REV_RT3070F) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3071, REV_RT3071E) ||\r\nrt2x00_rt_rev_lt(rt2x00dev, RT3090, REV_RT3090E))\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x03);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\nrt2800_normal_mode_setup_3xxx(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_3290(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 rfcsr;\r\nrt2800_rf_init_calibration(rt2x00dev, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x0f);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 4, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0xa0);\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0xf3);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x53);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x46);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x83);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x82);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x09);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 33, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 34, 0x05);\r\nrt2800_rfcsr_write(rt2x00dev, 35, 0x12);\r\nrt2800_rfcsr_write(rt2x00dev, 36, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x85);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\r\nrt2800_rfcsr_write(rt2x00dev, 40, 0x0b);\r\nrt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\r\nrt2800_rfcsr_write(rt2x00dev, 42, 0xd5);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x7b);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x0e);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xa2);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x73);\r\nrt2800_rfcsr_write(rt2x00dev, 47, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 48, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 49, 0x98);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x38);\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0x78);\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x43);\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x7f);\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x09);\r\nrt2800_rfcsr_write(rt2x00dev, 60, 0x45);\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0xc1);\r\nrt2800_rfcsr_read(rt2x00dev, 29, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR29_RSSI_GAIN, 3);\r\nrt2800_rfcsr_write(rt2x00dev, 29, rfcsr);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\nrt2800_normal_mode_setup_3xxx(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_3352(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_rf_init_calibration(rt2x00dev, 30);\r\nrt2800_rfcsr_write(rt2x00dev, 0, 0xf0);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x23);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0x50);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x18);\r\nrt2800_rfcsr_write(rt2x00dev, 4, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0x33);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xd2);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x1c);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x5a);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0x01);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x45);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 33, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 34, 0x01);\r\nrt2800_rfcsr_write(rt2x00dev, 35, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 36, 0xbd);\r\nrt2800_rfcsr_write(rt2x00dev, 37, 0x3c);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x5f);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0xc5);\r\nrt2800_rfcsr_write(rt2x00dev, 40, 0x33);\r\nrt2800_rfcsr_write(rt2x00dev, 41, 0x5b);\r\nrt2800_rfcsr_write(rt2x00dev, 42, 0x5b);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0xdb);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0xdb);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xdb);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0xdd);\r\nrt2800_rfcsr_write(rt2x00dev, 47, 0x0d);\r\nrt2800_rfcsr_write(rt2x00dev, 48, 0x14);\r\nrt2800_rfcsr_write(rt2x00dev, 49, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 50, 0x2d);\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0x7f);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x52);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0x1b);\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x7f);\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x52);\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x1b);\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 60, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 63, 0x00);\r\nrt2800_rx_filter_calibration(rt2x00dev);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\nrt2800_normal_mode_setup_3xxx(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_3390(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nrt2800_rf_init_calibration(rt2x00dev, 30);\r\nrt2800_rfcsr_write(rt2x00dev, 0, 0xa0);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0xe1);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x62);\r\nrt2800_rfcsr_write(rt2x00dev, 4, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x8b);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0x42);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x34);\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0xc0);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x61);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x21);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x3b);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0xe0);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x90);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x53);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0xe0);\r\nrt2800_rfcsr_write(rt2x00dev, 17, 0x94);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x5c);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x4a);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xb2);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0xf6);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x14);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x3d);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x85);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x41);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x8f);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x0f);\r\nrt2800_register_read(rt2x00dev, GPIO_SWITCH, &reg);\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_5, 0);\r\nrt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\r\nrt2800_rx_filter_calibration(rt2x00dev);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT3390, REV_RT3390E))\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x03);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\nrt2800_normal_mode_setup_3xxx(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_3572(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 rfcsr;\r\nu32 reg;\r\nrt2800_rf_init_calibration(rt2x00dev, 30);\r\nrt2800_rfcsr_write(rt2x00dev, 0, 0x70);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x81);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 4, 0x4c);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x05);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0x4a);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0xd8);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0xc3);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0xb9);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x70);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x65);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0xa0);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x53);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0x4c);\r\nrt2800_rfcsr_write(rt2x00dev, 17, 0x23);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0xac);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x93);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0xb3);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0xd0);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x3c);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x16);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x15);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x85);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x9b);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x09);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x10);\r\nrt2800_rfcsr_read(rt2x00dev, 6, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR6_R2, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 6, rfcsr);\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\r\nrt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\nmsleep(1);\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 0);\r\nrt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\nrt2800_rx_filter_calibration(rt2x00dev);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\nrt2800_normal_mode_setup_3xxx(rt2x00dev);\r\n}\r\nstatic void rt3593_post_bbp_init(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu8 bbp;\r\nbool txbf_enabled = false;\r\nrt2800_bbp_read(rt2x00dev, 105, &bbp);\r\nif (rt2x00dev->default_ant.rx_chain_num == 1)\r\nrt2x00_set_field8(&bbp, BBP105_MLD, 0);\r\nelse\r\nrt2x00_set_field8(&bbp, BBP105_MLD, 1);\r\nrt2800_bbp_write(rt2x00dev, 105, bbp);\r\nrt2800_bbp4_mac_if_ctrl(rt2x00dev);\r\nrt2800_bbp_write(rt2x00dev, 92, 0x02);\r\nrt2800_bbp_write(rt2x00dev, 82, 0x82);\r\nrt2800_bbp_write(rt2x00dev, 106, 0x05);\r\nrt2800_bbp_write(rt2x00dev, 104, 0x92);\r\nrt2800_bbp_write(rt2x00dev, 88, 0x90);\r\nrt2800_bbp_write(rt2x00dev, 148, 0xc8);\r\nrt2800_bbp_write(rt2x00dev, 47, 0x48);\r\nrt2800_bbp_write(rt2x00dev, 120, 0x50);\r\nif (txbf_enabled)\r\nrt2800_bbp_write(rt2x00dev, 163, 0xbd);\r\nelse\r\nrt2800_bbp_write(rt2x00dev, 163, 0x9d);\r\nrt2800_bbp_write(rt2x00dev, 142, 6);\r\nrt2800_bbp_write(rt2x00dev, 143, 160);\r\nrt2800_bbp_write(rt2x00dev, 142, 7);\r\nrt2800_bbp_write(rt2x00dev, 143, 161);\r\nrt2800_bbp_write(rt2x00dev, 142, 8);\r\nrt2800_bbp_write(rt2x00dev, 143, 162);\r\nrt2800_bbp_write(rt2x00dev, 31, 0x08);\r\nrt2800_bbp_write(rt2x00dev, 68, 0x0b);\r\nrt2800_bbp_write(rt2x00dev, 105, 0x04);\r\n}\r\nstatic void rt2800_init_rfcsr_3593(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu32 reg;\r\nu8 rfcsr;\r\nrt2800_register_read(rt2x00dev, GPIO_SWITCH, &reg);\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_4, 0);\r\nrt2x00_set_field32(&reg, GPIO_SWITCH_7, 0);\r\nrt2800_register_write(rt2x00dev, GPIO_SWITCH, reg);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 8, 0xf1);\r\nrt2800_rfcsr_write(rt2x00dev, 9, 0x02);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0xd3);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x4e);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x12);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x40);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0x78);\r\nrt2800_rfcsr_write(rt2x00dev, 33, 0x3b);\r\nrt2800_rfcsr_write(rt2x00dev, 34, 0x3c);\r\nrt2800_rfcsr_write(rt2x00dev, 35, 0xe0);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x86);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x23);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0xd3);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xbb);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x60);\r\nrt2800_rfcsr_write(rt2x00dev, 49, 0x8e);\r\nrt2800_rfcsr_write(rt2x00dev, 50, 0x86);\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0x75);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x45);\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x18);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0x18);\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x18);\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xdb);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x6e);\r\nrt2800_rfcsr_read(rt2x00dev, 2, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR2_RESCAL_EN, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 2, rfcsr);\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nrt2800_rfcsr_read(rt2x00dev, 18, &rfcsr);\r\nrt2x00_set_field8(&rfcsr, RFCSR18_XO_TUNE_BYPASS, 1);\r\nrt2800_rfcsr_write(rt2x00dev, 18, rfcsr);\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 3);\r\nrt2x00_set_field32(&reg, LDO_CFG0_BGSEL, 1);\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\nusleep_range(1000, 1500);\r\nrt2800_register_read(rt2x00dev, LDO_CFG0, &reg);\r\nrt2x00_set_field32(&reg, LDO_CFG0_LDO_CORE_VLEVEL, 0);\r\nrt2800_register_write(rt2x00dev, LDO_CFG0, reg);\r\ndrv_data->calibration_bw20 = 0x1f;\r\ndrv_data->calibration_bw40 = 0x2f;\r\nrt2800_bbp_read(rt2x00dev, 25, &drv_data->bbp25);\r\nrt2800_bbp_read(rt2x00dev, 26, &drv_data->bbp26);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\nrt2800_normal_mode_setup_3593(rt2x00dev);\r\nrt3593_post_bbp_init(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_5390(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_rf_init_calibration(rt2x00dev, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x0f);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x88);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x10);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0xe0);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0xa0);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x53);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x46);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x00);\r\nif (rt2x00_is_usb(rt2x00dev) &&\r\nrt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x80);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0xc0);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x09);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 33, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 34, 0x07);\r\nrt2800_rfcsr_write(rt2x00dev, 35, 0x12);\r\nrt2800_rfcsr_write(rt2x00dev, 36, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 37, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x85);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\r\nrt2800_rfcsr_write(rt2x00dev, 40, 0x0b);\r\nrt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\r\nrt2800_rfcsr_write(rt2x00dev, 42, 0xd2);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x9a);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x0e);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xa2);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x73);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x7b);\r\nrt2800_rfcsr_write(rt2x00dev, 47, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 48, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 49, 0x94);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x38);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x00);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x84);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0x78);\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x44);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F))\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0x42);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0x22);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x7f);\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x8f);\r\nrt2800_rfcsr_write(rt2x00dev, 60, 0x45);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390F)) {\r\nif (rt2x00_is_usb(rt2x00dev))\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0xd1);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0xd5);\r\n} else {\r\nif (rt2x00_is_usb(rt2x00dev))\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0xdd);\r\nelse\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0xb5);\r\n}\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 63, 0x00);\r\nrt2800_normal_mode_setup_5xxx(rt2x00dev);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_5392(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_rf_init_calibration(rt2x00dev, 2);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x17);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x88);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0xe0);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 10, 0x53);\r\nrt2800_rfcsr_write(rt2x00dev, 11, 0x4a);\r\nrt2800_rfcsr_write(rt2x00dev, 12, 0x46);\r\nrt2800_rfcsr_write(rt2x00dev, 13, 0x9f);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x4d);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0x8d);\r\nrt2800_rfcsr_write(rt2x00dev, 22, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 23, 0x0b);\r\nrt2800_rfcsr_write(rt2x00dev, 24, 0x44);\r\nrt2800_rfcsr_write(rt2x00dev, 25, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x82);\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x09);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 30, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 31, 0x80);\r\nrt2800_rfcsr_write(rt2x00dev, 32, 0x20);\r\nrt2800_rfcsr_write(rt2x00dev, 33, 0xC0);\r\nrt2800_rfcsr_write(rt2x00dev, 34, 0x07);\r\nrt2800_rfcsr_write(rt2x00dev, 35, 0x12);\r\nrt2800_rfcsr_write(rt2x00dev, 36, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 37, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 38, 0x89);\r\nrt2800_rfcsr_write(rt2x00dev, 39, 0x1b);\r\nrt2800_rfcsr_write(rt2x00dev, 40, 0x0f);\r\nrt2800_rfcsr_write(rt2x00dev, 41, 0xbb);\r\nrt2800_rfcsr_write(rt2x00dev, 42, 0xd5);\r\nrt2800_rfcsr_write(rt2x00dev, 43, 0x9b);\r\nrt2800_rfcsr_write(rt2x00dev, 44, 0x0e);\r\nrt2800_rfcsr_write(rt2x00dev, 45, 0xa2);\r\nrt2800_rfcsr_write(rt2x00dev, 46, 0x73);\r\nrt2800_rfcsr_write(rt2x00dev, 47, 0x0c);\r\nrt2800_rfcsr_write(rt2x00dev, 48, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 49, 0x94);\r\nrt2800_rfcsr_write(rt2x00dev, 50, 0x94);\r\nrt2800_rfcsr_write(rt2x00dev, 51, 0x3a);\r\nrt2800_rfcsr_write(rt2x00dev, 52, 0x48);\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x44);\r\nrt2800_rfcsr_write(rt2x00dev, 54, 0x38);\r\nrt2800_rfcsr_write(rt2x00dev, 55, 0x43);\r\nrt2800_rfcsr_write(rt2x00dev, 56, 0xa1);\r\nrt2800_rfcsr_write(rt2x00dev, 57, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 58, 0x39);\r\nrt2800_rfcsr_write(rt2x00dev, 59, 0x07);\r\nrt2800_rfcsr_write(rt2x00dev, 60, 0x45);\r\nrt2800_rfcsr_write(rt2x00dev, 61, 0x91);\r\nrt2800_rfcsr_write(rt2x00dev, 62, 0x39);\r\nrt2800_rfcsr_write(rt2x00dev, 63, 0x07);\r\nrt2800_normal_mode_setup_5xxx(rt2x00dev);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr_5592(struct rt2x00_dev *rt2x00dev)\r\n{\r\nrt2800_rf_init_calibration(rt2x00dev, 30);\r\nrt2800_rfcsr_write(rt2x00dev, 1, 0x3F);\r\nrt2800_rfcsr_write(rt2x00dev, 3, 0x08);\r\nrt2800_rfcsr_write(rt2x00dev, 5, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 6, 0xE4);\r\nrt2800_rfcsr_write(rt2x00dev, 7, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 14, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 15, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 16, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 18, 0x03);\r\nrt2800_rfcsr_write(rt2x00dev, 19, 0x4D);\r\nrt2800_rfcsr_write(rt2x00dev, 20, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 21, 0x8D);\r\nrt2800_rfcsr_write(rt2x00dev, 26, 0x82);\r\nrt2800_rfcsr_write(rt2x00dev, 28, 0x00);\r\nrt2800_rfcsr_write(rt2x00dev, 29, 0x10);\r\nrt2800_rfcsr_write(rt2x00dev, 33, 0xC0);\r\nrt2800_rfcsr_write(rt2x00dev, 34, 0x07);\r\nrt2800_rfcsr_write(rt2x00dev, 35, 0x12);\r\nrt2800_rfcsr_write(rt2x00dev, 47, 0x0C);\r\nrt2800_rfcsr_write(rt2x00dev, 53, 0x22);\r\nrt2800_rfcsr_write(rt2x00dev, 63, 0x07);\r\nrt2800_rfcsr_write(rt2x00dev, 2, 0x80);\r\nmsleep(1);\r\nrt2800_adjust_freq_offset(rt2x00dev);\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5592, REV_RT5592C))\r\nrt2800_bbp_write(rt2x00dev, 103, 0xc0);\r\nrt2800_normal_mode_setup_5xxx(rt2x00dev);\r\nif (rt2x00_rt_rev_lt(rt2x00dev, RT5592, REV_RT5592C))\r\nrt2800_rfcsr_write(rt2x00dev, 27, 0x03);\r\nrt2800_led_open_drain_enable(rt2x00dev);\r\n}\r\nstatic void rt2800_init_rfcsr(struct rt2x00_dev *rt2x00dev)\r\n{\r\nif (rt2800_is_305x_soc(rt2x00dev)) {\r\nrt2800_init_rfcsr_305x_soc(rt2x00dev);\r\nreturn;\r\n}\r\nswitch (rt2x00dev->chip.rt) {\r\ncase RT3070:\r\ncase RT3071:\r\ncase RT3090:\r\nrt2800_init_rfcsr_30xx(rt2x00dev);\r\nbreak;\r\ncase RT3290:\r\nrt2800_init_rfcsr_3290(rt2x00dev);\r\nbreak;\r\ncase RT3352:\r\nrt2800_init_rfcsr_3352(rt2x00dev);\r\nbreak;\r\ncase RT3390:\r\nrt2800_init_rfcsr_3390(rt2x00dev);\r\nbreak;\r\ncase RT3572:\r\nrt2800_init_rfcsr_3572(rt2x00dev);\r\nbreak;\r\ncase RT3593:\r\nrt2800_init_rfcsr_3593(rt2x00dev);\r\nbreak;\r\ncase RT5390:\r\nrt2800_init_rfcsr_5390(rt2x00dev);\r\nbreak;\r\ncase RT5392:\r\nrt2800_init_rfcsr_5392(rt2x00dev);\r\nbreak;\r\ncase RT5592:\r\nrt2800_init_rfcsr_5592(rt2x00dev);\r\nbreak;\r\n}\r\n}\r\nint rt2800_enable_radio(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nu16 word;\r\nif (unlikely(rt2800_wait_wpdma_ready(rt2x00dev) ||\r\nrt2800_init_registers(rt2x00dev)))\r\nreturn -EIO;\r\nif (unlikely(rt2800_wait_bbp_rf_ready(rt2x00dev)))\r\nreturn -EIO;\r\nrt2800_register_write(rt2x00dev, H2M_BBP_AGENT, 0);\r\nrt2800_register_write(rt2x00dev, H2M_MAILBOX_CSR, 0);\r\nif (rt2x00_is_usb(rt2x00dev))\r\nrt2800_register_write(rt2x00dev, H2M_INT_SRC, 0);\r\nrt2800_mcu_request(rt2x00dev, MCU_BOOT_SIGNAL, 0, 0, 0);\r\nmsleep(1);\r\nif (unlikely(rt2800_wait_bbp_ready(rt2x00dev)))\r\nreturn -EIO;\r\nrt2800_init_bbp(rt2x00dev);\r\nrt2800_init_rfcsr(rt2x00dev);\r\nif (rt2x00_is_usb(rt2x00dev) &&\r\n(rt2x00_rt(rt2x00dev, RT3070) ||\r\nrt2x00_rt(rt2x00dev, RT3071) ||\r\nrt2x00_rt(rt2x00dev, RT3572))) {\r\nudelay(200);\r\nrt2800_mcu_request(rt2x00dev, MCU_CURRENT, 0, 0, 0);\r\nudelay(10);\r\n}\r\nrt2800_register_read(rt2x00dev, MAC_SYS_CTRL, &reg);\r\nrt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_TX, 1);\r\nrt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_RX, 0);\r\nrt2800_register_write(rt2x00dev, MAC_SYS_CTRL, reg);\r\nudelay(50);\r\nrt2800_register_read(rt2x00dev, WPDMA_GLO_CFG, &reg);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_TX_DMA, 1);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_ENABLE_RX_DMA, 1);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_WP_DMA_BURST_SIZE, 2);\r\nrt2x00_set_field32(&reg, WPDMA_GLO_CFG_TX_WRITEBACK_DONE, 1);\r\nrt2800_register_write(rt2x00dev, WPDMA_GLO_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MAC_SYS_CTRL, &reg);\r\nrt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_TX, 1);\r\nrt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_RX, 1);\r\nrt2800_register_write(rt2x00dev, MAC_SYS_CTRL, reg);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_LED_AG_CONF, &word);\r\nrt2800_mcu_request(rt2x00dev, MCU_LED_AG_CONF, 0xff,\r\nword & 0xff, (word >> 8) & 0xff);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_LED_ACT_CONF, &word);\r\nrt2800_mcu_request(rt2x00dev, MCU_LED_ACT_CONF, 0xff,\r\nword & 0xff, (word >> 8) & 0xff);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_LED_POLARITY, &word);\r\nrt2800_mcu_request(rt2x00dev, MCU_LED_LED_POLARITY, 0xff,\r\nword & 0xff, (word >> 8) & 0xff);\r\nreturn 0;\r\n}\r\nvoid rt2800_disable_radio(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nrt2800_disable_wpdma(rt2x00dev);\r\nrt2800_wait_wpdma_ready(rt2x00dev);\r\nrt2800_register_read(rt2x00dev, MAC_SYS_CTRL, &reg);\r\nrt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_TX, 0);\r\nrt2x00_set_field32(&reg, MAC_SYS_CTRL_ENABLE_RX, 0);\r\nrt2800_register_write(rt2x00dev, MAC_SYS_CTRL, reg);\r\n}\r\nint rt2800_efuse_detect(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nu16 efuse_ctrl_reg;\r\nif (rt2x00_rt(rt2x00dev, RT3290))\r\nefuse_ctrl_reg = EFUSE_CTRL_3290;\r\nelse\r\nefuse_ctrl_reg = EFUSE_CTRL;\r\nrt2800_register_read(rt2x00dev, efuse_ctrl_reg, &reg);\r\nreturn rt2x00_get_field32(reg, EFUSE_CTRL_PRESENT);\r\n}\r\nstatic void rt2800_efuse_read(struct rt2x00_dev *rt2x00dev, unsigned int i)\r\n{\r\nu32 reg;\r\nu16 efuse_ctrl_reg;\r\nu16 efuse_data0_reg;\r\nu16 efuse_data1_reg;\r\nu16 efuse_data2_reg;\r\nu16 efuse_data3_reg;\r\nif (rt2x00_rt(rt2x00dev, RT3290)) {\r\nefuse_ctrl_reg = EFUSE_CTRL_3290;\r\nefuse_data0_reg = EFUSE_DATA0_3290;\r\nefuse_data1_reg = EFUSE_DATA1_3290;\r\nefuse_data2_reg = EFUSE_DATA2_3290;\r\nefuse_data3_reg = EFUSE_DATA3_3290;\r\n} else {\r\nefuse_ctrl_reg = EFUSE_CTRL;\r\nefuse_data0_reg = EFUSE_DATA0;\r\nefuse_data1_reg = EFUSE_DATA1;\r\nefuse_data2_reg = EFUSE_DATA2;\r\nefuse_data3_reg = EFUSE_DATA3;\r\n}\r\nmutex_lock(&rt2x00dev->csr_mutex);\r\nrt2800_register_read_lock(rt2x00dev, efuse_ctrl_reg, &reg);\r\nrt2x00_set_field32(&reg, EFUSE_CTRL_ADDRESS_IN, i);\r\nrt2x00_set_field32(&reg, EFUSE_CTRL_MODE, 0);\r\nrt2x00_set_field32(&reg, EFUSE_CTRL_KICK, 1);\r\nrt2800_register_write_lock(rt2x00dev, efuse_ctrl_reg, reg);\r\nrt2800_regbusy_read(rt2x00dev, efuse_ctrl_reg, EFUSE_CTRL_KICK, &reg);\r\nrt2800_register_read_lock(rt2x00dev, efuse_data3_reg, &reg);\r\n*(u32 *)&rt2x00dev->eeprom[i] = cpu_to_le32(reg);\r\nrt2800_register_read_lock(rt2x00dev, efuse_data2_reg, &reg);\r\n*(u32 *)&rt2x00dev->eeprom[i + 2] = cpu_to_le32(reg);\r\nrt2800_register_read_lock(rt2x00dev, efuse_data1_reg, &reg);\r\n*(u32 *)&rt2x00dev->eeprom[i + 4] = cpu_to_le32(reg);\r\nrt2800_register_read_lock(rt2x00dev, efuse_data0_reg, &reg);\r\n*(u32 *)&rt2x00dev->eeprom[i + 6] = cpu_to_le32(reg);\r\nmutex_unlock(&rt2x00dev->csr_mutex);\r\n}\r\nint rt2800_read_eeprom_efuse(struct rt2x00_dev *rt2x00dev)\r\n{\r\nunsigned int i;\r\nfor (i = 0; i < EEPROM_SIZE / sizeof(u16); i += 8)\r\nrt2800_efuse_read(rt2x00dev, i);\r\nreturn 0;\r\n}\r\nstatic u8 rt2800_get_txmixer_gain_24g(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu16 word;\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nreturn 0;\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TXMIXER_GAIN_BG, &word);\r\nif ((word & 0x00ff) != 0x00ff)\r\nreturn rt2x00_get_field16(word, EEPROM_TXMIXER_GAIN_BG_VAL);\r\nreturn 0;\r\n}\r\nstatic u8 rt2800_get_txmixer_gain_5g(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu16 word;\r\nif (rt2x00_rt(rt2x00dev, RT3593))\r\nreturn 0;\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_TXMIXER_GAIN_A, &word);\r\nif ((word & 0x00ff) != 0x00ff)\r\nreturn rt2x00_get_field16(word, EEPROM_TXMIXER_GAIN_A_VAL);\r\nreturn 0;\r\n}\r\nstatic int rt2800_validate_eeprom(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct rt2800_drv_data *drv_data = rt2x00dev->drv_data;\r\nu16 word;\r\nu8 *mac;\r\nu8 default_lna_gain;\r\nint retval;\r\nretval = rt2800_read_eeprom(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\nmac = rt2800_eeprom_addr(rt2x00dev, EEPROM_MAC_ADDR_0);\r\nif (!is_valid_ether_addr(mac)) {\r\neth_random_addr(mac);\r\nrt2x00_eeprom_dbg(rt2x00dev, "MAC: %pM\n", mac);\r\n}\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0, &word);\r\nif (word == 0xffff) {\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF0_RXPATH, 2);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF0_TXPATH, 1);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF0_RF_TYPE, RF2820);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_NIC_CONF0, word);\r\nrt2x00_eeprom_dbg(rt2x00dev, "Antenna: 0x%04x\n", word);\r\n} else if (rt2x00_rt(rt2x00dev, RT2860) ||\r\nrt2x00_rt(rt2x00dev, RT2872)) {\r\nif (rt2x00_get_field16(word, EEPROM_NIC_CONF0_RXPATH) > 2)\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF0_RXPATH, 2);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_NIC_CONF0, word);\r\n}\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1, &word);\r\nif (word == 0xffff) {\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_HW_RADIO, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_EXTERNAL_TX_ALC, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_EXTERNAL_LNA_2G, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_EXTERNAL_LNA_5G, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_CARDBUS_ACCEL, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_SB_2G, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_SB_5G, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_WPS_PBC, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_2G, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_BW40M_5G, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_BROADBAND_EXT_LNA, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_ANT_DIVERSITY, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_INTERNAL_TX_ALC, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_BT_COEXIST, 0);\r\nrt2x00_set_field16(&word, EEPROM_NIC_CONF1_DAC_TEST, 0);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_NIC_CONF1, word);\r\nrt2x00_eeprom_dbg(rt2x00dev, "NIC: 0x%04x\n", word);\r\n}\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_FREQ, &word);\r\nif ((word & 0x00ff) == 0x00ff) {\r\nrt2x00_set_field16(&word, EEPROM_FREQ_OFFSET, 0);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_FREQ, word);\r\nrt2x00_eeprom_dbg(rt2x00dev, "Freq: 0x%04x\n", word);\r\n}\r\nif ((word & 0xff00) == 0xff00) {\r\nrt2x00_set_field16(&word, EEPROM_FREQ_LED_MODE,\r\nLED_MODE_TXRX_ACTIVITY);\r\nrt2x00_set_field16(&word, EEPROM_FREQ_LED_POLARITY, 0);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_FREQ, word);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_LED_AG_CONF, 0x5555);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_LED_ACT_CONF, 0x2221);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_LED_POLARITY, 0xa9f8);\r\nrt2x00_eeprom_dbg(rt2x00dev, "Led Mode: 0x%04x\n", word);\r\n}\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_LNA, &word);\r\ndefault_lna_gain = rt2x00_get_field16(word, EEPROM_LNA_A0);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG, &word);\r\nif (abs(rt2x00_get_field16(word, EEPROM_RSSI_BG_OFFSET0)) > 10)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_BG_OFFSET0, 0);\r\nif (abs(rt2x00_get_field16(word, EEPROM_RSSI_BG_OFFSET1)) > 10)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_BG_OFFSET1, 0);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_BG, word);\r\ndrv_data->txmixer_gain_24g = rt2800_get_txmixer_gain_24g(rt2x00dev);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_BG2, &word);\r\nif (abs(rt2x00_get_field16(word, EEPROM_RSSI_BG2_OFFSET2)) > 10)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_BG2_OFFSET2, 0);\r\nif (!rt2x00_rt(rt2x00dev, RT3593)) {\r\nif (rt2x00_get_field16(word, EEPROM_RSSI_BG2_LNA_A1) == 0x00 ||\r\nrt2x00_get_field16(word, EEPROM_RSSI_BG2_LNA_A1) == 0xff)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_BG2_LNA_A1,\r\ndefault_lna_gain);\r\n}\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_BG2, word);\r\ndrv_data->txmixer_gain_5g = rt2800_get_txmixer_gain_5g(rt2x00dev);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A, &word);\r\nif (abs(rt2x00_get_field16(word, EEPROM_RSSI_A_OFFSET0)) > 10)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_A_OFFSET0, 0);\r\nif (abs(rt2x00_get_field16(word, EEPROM_RSSI_A_OFFSET1)) > 10)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_A_OFFSET1, 0);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_A, word);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_RSSI_A2, &word);\r\nif (abs(rt2x00_get_field16(word, EEPROM_RSSI_A2_OFFSET2)) > 10)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_A2_OFFSET2, 0);\r\nif (!rt2x00_rt(rt2x00dev, RT3593)) {\r\nif (rt2x00_get_field16(word, EEPROM_RSSI_A2_LNA_A2) == 0x00 ||\r\nrt2x00_get_field16(word, EEPROM_RSSI_A2_LNA_A2) == 0xff)\r\nrt2x00_set_field16(&word, EEPROM_RSSI_A2_LNA_A2,\r\ndefault_lna_gain);\r\n}\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_RSSI_A2, word);\r\nif (rt2x00_rt(rt2x00dev, RT3593)) {\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_EXT_LNA2, &word);\r\nif (rt2x00_get_field16(word, EEPROM_EXT_LNA2_A1) == 0x00 ||\r\nrt2x00_get_field16(word, EEPROM_EXT_LNA2_A1) == 0xff)\r\nrt2x00_set_field16(&word, EEPROM_EXT_LNA2_A1,\r\ndefault_lna_gain);\r\nif (rt2x00_get_field16(word, EEPROM_EXT_LNA2_A2) == 0x00 ||\r\nrt2x00_get_field16(word, EEPROM_EXT_LNA2_A2) == 0xff)\r\nrt2x00_set_field16(&word, EEPROM_EXT_LNA2_A1,\r\ndefault_lna_gain);\r\nrt2800_eeprom_write(rt2x00dev, EEPROM_EXT_LNA2, word);\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt2800_init_eeprom(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu16 value;\r\nu16 eeprom;\r\nu16 rf;\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF0, &eeprom);\r\nif (rt2x00_rt(rt2x00dev, RT3290) ||\r\nrt2x00_rt(rt2x00dev, RT5390) ||\r\nrt2x00_rt(rt2x00dev, RT5392))\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_CHIP_ID, &rf);\r\nelse\r\nrf = rt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RF_TYPE);\r\nswitch (rf) {\r\ncase RF2820:\r\ncase RF2850:\r\ncase RF2720:\r\ncase RF2750:\r\ncase RF3020:\r\ncase RF2020:\r\ncase RF3021:\r\ncase RF3022:\r\ncase RF3052:\r\ncase RF3053:\r\ncase RF3070:\r\ncase RF3290:\r\ncase RF3320:\r\ncase RF3322:\r\ncase RF5360:\r\ncase RF5362:\r\ncase RF5370:\r\ncase RF5372:\r\ncase RF5390:\r\ncase RF5392:\r\ncase RF5592:\r\nbreak;\r\ndefault:\r\nrt2x00_err(rt2x00dev, "Invalid RF chipset 0x%04x detected\n",\r\nrf);\r\nreturn -ENODEV;\r\n}\r\nrt2x00_set_rf(rt2x00dev, rf);\r\nrt2x00dev->default_ant.tx_chain_num =\r\nrt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_TXPATH);\r\nrt2x00dev->default_ant.rx_chain_num =\r\nrt2x00_get_field16(eeprom, EEPROM_NIC_CONF0_RXPATH);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_NIC_CONF1, &eeprom);\r\nif (rt2x00_rt(rt2x00dev, RT3070) ||\r\nrt2x00_rt(rt2x00dev, RT3090) ||\r\nrt2x00_rt(rt2x00dev, RT3352) ||\r\nrt2x00_rt(rt2x00dev, RT3390)) {\r\nvalue = rt2x00_get_field16(eeprom,\r\nEEPROM_NIC_CONF1_ANT_DIVERSITY);\r\nswitch (value) {\r\ncase 0:\r\ncase 1:\r\ncase 2:\r\nrt2x00dev->default_ant.tx = ANTENNA_A;\r\nrt2x00dev->default_ant.rx = ANTENNA_A;\r\nbreak;\r\ncase 3:\r\nrt2x00dev->default_ant.tx = ANTENNA_A;\r\nrt2x00dev->default_ant.rx = ANTENNA_B;\r\nbreak;\r\n}\r\n} else {\r\nrt2x00dev->default_ant.tx = ANTENNA_A;\r\nrt2x00dev->default_ant.rx = ANTENNA_A;\r\n}\r\nif (rt2x00_rt_rev_gte(rt2x00dev, RT5390, REV_RT5390R)) {\r\nrt2x00dev->default_ant.tx = ANTENNA_HW_DIVERSITY;\r\nrt2x00dev->default_ant.rx = ANTENNA_HW_DIVERSITY;\r\n}\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_EXTERNAL_LNA_5G))\r\n__set_bit(CAPABILITY_EXTERNAL_LNA_A, &rt2x00dev->cap_flags);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_EXTERNAL_LNA_2G))\r\n__set_bit(CAPABILITY_EXTERNAL_LNA_BG, &rt2x00dev->cap_flags);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_HW_RADIO))\r\n__set_bit(CAPABILITY_HW_BUTTON, &rt2x00dev->cap_flags);\r\nif (rt2x00_get_field16(eeprom, EEPROM_NIC_CONF1_BT_COEXIST))\r\n__set_bit(CAPABILITY_BT_COEXIST, &rt2x00dev->cap_flags);\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_FREQ, &eeprom);\r\nrt2x00dev->freq_offset = rt2x00_get_field16(eeprom, EEPROM_FREQ_OFFSET);\r\n#ifdef CONFIG_RT2X00_LIB_LEDS\r\nrt2800_init_led(rt2x00dev, &rt2x00dev->led_radio, LED_TYPE_RADIO);\r\nrt2800_init_led(rt2x00dev, &rt2x00dev->led_assoc, LED_TYPE_ASSOC);\r\nrt2800_init_led(rt2x00dev, &rt2x00dev->led_qual, LED_TYPE_QUALITY);\r\nrt2x00dev->led_mcu_reg = eeprom;\r\n#endif\r\nrt2800_eeprom_read(rt2x00dev, EEPROM_EIRP_MAX_TX_POWER, &eeprom);\r\nif (rt2x00_get_field16(eeprom, EEPROM_EIRP_MAX_TX_POWER_2GHZ) <\r\nEIRP_MAX_TX_POWER_LIMIT)\r\n__set_bit(CAPABILITY_POWER_LIMIT, &rt2x00dev->cap_flags);\r\nreturn 0;\r\n}\r\nstatic int rt2800_probe_hw_mode(struct rt2x00_dev *rt2x00dev)\r\n{\r\nstruct hw_mode_spec *spec = &rt2x00dev->spec;\r\nstruct channel_info *info;\r\nchar *default_power1;\r\nchar *default_power2;\r\nchar *default_power3;\r\nunsigned int i;\r\nu32 reg;\r\nrt2x00dev->hw->wiphy->flags &= ~WIPHY_FLAG_PS_ON_BY_DEFAULT;\r\nieee80211_hw_set(rt2x00dev->hw, SUPPORTS_HT_CCK_RATES);\r\nieee80211_hw_set(rt2x00dev->hw, REPORTS_TX_ACK_STATUS);\r\nieee80211_hw_set(rt2x00dev->hw, AMPDU_AGGREGATION);\r\nieee80211_hw_set(rt2x00dev->hw, PS_NULLFUNC_STACK);\r\nieee80211_hw_set(rt2x00dev->hw, SIGNAL_DBM);\r\nieee80211_hw_set(rt2x00dev->hw, SUPPORTS_PS);\r\nif (!rt2x00_is_usb(rt2x00dev))\r\nieee80211_hw_set(rt2x00dev->hw, HOST_BROADCAST_PS_BUFFERING);\r\nif (rt2800_hwcrypt_disabled(rt2x00dev))\r\nieee80211_hw_set(rt2x00dev->hw, MFP_CAPABLE);\r\nSET_IEEE80211_DEV(rt2x00dev->hw, rt2x00dev->dev);\r\nSET_IEEE80211_PERM_ADDR(rt2x00dev->hw,\r\nrt2800_eeprom_addr(rt2x00dev,\r\nEEPROM_MAC_ADDR_0));\r\nrt2x00dev->hw->max_rates = 1;\r\nrt2x00dev->hw->max_report_rates = 7;\r\nrt2x00dev->hw->max_rate_tries = 1;\r\nspec->supported_rates = SUPPORT_RATE_CCK | SUPPORT_RATE_OFDM;\r\nswitch (rt2x00dev->chip.rf) {\r\ncase RF2720:\r\ncase RF2820:\r\nspec->num_channels = 14;\r\nspec->channels = rf_vals;\r\nbreak;\r\ncase RF2750:\r\ncase RF2850:\r\nspec->num_channels = ARRAY_SIZE(rf_vals);\r\nspec->channels = rf_vals;\r\nbreak;\r\ncase RF2020:\r\ncase RF3020:\r\ncase RF3021:\r\ncase RF3022:\r\ncase RF3070:\r\ncase RF3290:\r\ncase RF3320:\r\ncase RF3322:\r\ncase RF5360:\r\ncase RF5362:\r\ncase RF5370:\r\ncase RF5372:\r\ncase RF5390:\r\ncase RF5392:\r\nspec->num_channels = 14;\r\nspec->channels = rf_vals_3x;\r\nbreak;\r\ncase RF3052:\r\ncase RF3053:\r\nspec->num_channels = ARRAY_SIZE(rf_vals_3x);\r\nspec->channels = rf_vals_3x;\r\nbreak;\r\ncase RF5592:\r\nrt2800_register_read(rt2x00dev, MAC_DEBUG_INDEX, &reg);\r\nif (rt2x00_get_field32(reg, MAC_DEBUG_INDEX_XTAL)) {\r\nspec->num_channels = ARRAY_SIZE(rf_vals_5592_xtal40);\r\nspec->channels = rf_vals_5592_xtal40;\r\n} else {\r\nspec->num_channels = ARRAY_SIZE(rf_vals_5592_xtal20);\r\nspec->channels = rf_vals_5592_xtal20;\r\n}\r\nbreak;\r\n}\r\nif (WARN_ON_ONCE(!spec->channels))\r\nreturn -ENODEV;\r\nspec->supported_bands = SUPPORT_BAND_2GHZ;\r\nif (spec->num_channels > 14)\r\nspec->supported_bands |= SUPPORT_BAND_5GHZ;\r\nif (!rt2x00_rf(rt2x00dev, RF2020))\r\nspec->ht.ht_supported = true;\r\nelse\r\nspec->ht.ht_supported = false;\r\nspec->ht.cap =\r\nIEEE80211_HT_CAP_SUP_WIDTH_20_40 |\r\nIEEE80211_HT_CAP_GRN_FLD |\r\nIEEE80211_HT_CAP_SGI_20 |\r\nIEEE80211_HT_CAP_SGI_40;\r\nif (rt2x00dev->default_ant.tx_chain_num >= 2)\r\nspec->ht.cap |= IEEE80211_HT_CAP_TX_STBC;\r\nspec->ht.cap |= rt2x00dev->default_ant.rx_chain_num <<\r\nIEEE80211_HT_CAP_RX_STBC_SHIFT;\r\nspec->ht.ampdu_factor = 3;\r\nspec->ht.ampdu_density = 4;\r\nspec->ht.mcs.tx_params =\r\nIEEE80211_HT_MCS_TX_DEFINED |\r\nIEEE80211_HT_MCS_TX_RX_DIFF |\r\n((rt2x00dev->default_ant.tx_chain_num - 1) <<\r\nIEEE80211_HT_MCS_TX_MAX_STREAMS_SHIFT);\r\nswitch (rt2x00dev->default_ant.rx_chain_num) {\r\ncase 3:\r\nspec->ht.mcs.rx_mask[2] = 0xff;\r\ncase 2:\r\nspec->ht.mcs.rx_mask[1] = 0xff;\r\ncase 1:\r\nspec->ht.mcs.rx_mask[0] = 0xff;\r\nspec->ht.mcs.rx_mask[4] = 0x1;\r\nbreak;\r\n}\r\ninfo = kcalloc(spec->num_channels, sizeof(*info), GFP_KERNEL);\r\nif (!info)\r\nreturn -ENOMEM;\r\nspec->channels_info = info;\r\ndefault_power1 = rt2800_eeprom_addr(rt2x00dev, EEPROM_TXPOWER_BG1);\r\ndefault_power2 = rt2800_eeprom_addr(rt2x00dev, EEPROM_TXPOWER_BG2);\r\nif (rt2x00dev->default_ant.tx_chain_num > 2)\r\ndefault_power3 = rt2800_eeprom_addr(rt2x00dev,\r\nEEPROM_EXT_TXPOWER_BG3);\r\nelse\r\ndefault_power3 = NULL;\r\nfor (i = 0; i < 14; i++) {\r\ninfo[i].default_power1 = default_power1[i];\r\ninfo[i].default_power2 = default_power2[i];\r\nif (default_power3)\r\ninfo[i].default_power3 = default_power3[i];\r\n}\r\nif (spec->num_channels > 14) {\r\ndefault_power1 = rt2800_eeprom_addr(rt2x00dev,\r\nEEPROM_TXPOWER_A1);\r\ndefault_power2 = rt2800_eeprom_addr(rt2x00dev,\r\nEEPROM_TXPOWER_A2);\r\nif (rt2x00dev->default_ant.tx_chain_num > 2)\r\ndefault_power3 =\r\nrt2800_eeprom_addr(rt2x00dev,\r\nEEPROM_EXT_TXPOWER_A3);\r\nelse\r\ndefault_power3 = NULL;\r\nfor (i = 14; i < spec->num_channels; i++) {\r\ninfo[i].default_power1 = default_power1[i - 14];\r\ninfo[i].default_power2 = default_power2[i - 14];\r\nif (default_power3)\r\ninfo[i].default_power3 = default_power3[i - 14];\r\n}\r\n}\r\nswitch (rt2x00dev->chip.rf) {\r\ncase RF2020:\r\ncase RF3020:\r\ncase RF3021:\r\ncase RF3022:\r\ncase RF3320:\r\ncase RF3052:\r\ncase RF3053:\r\ncase RF3070:\r\ncase RF3290:\r\ncase RF5360:\r\ncase RF5362:\r\ncase RF5370:\r\ncase RF5372:\r\ncase RF5390:\r\ncase RF5392:\r\n__set_bit(CAPABILITY_VCO_RECALIBRATION, &rt2x00dev->cap_flags);\r\nbreak;\r\n}\r\nreturn 0;\r\n}\r\nstatic int rt2800_probe_rt(struct rt2x00_dev *rt2x00dev)\r\n{\r\nu32 reg;\r\nu32 rt;\r\nu32 rev;\r\nif (rt2x00_rt(rt2x00dev, RT3290))\r\nrt2800_register_read(rt2x00dev, MAC_CSR0_3290, &reg);\r\nelse\r\nrt2800_register_read(rt2x00dev, MAC_CSR0, &reg);\r\nrt = rt2x00_get_field32(reg, MAC_CSR0_CHIPSET);\r\nrev = rt2x00_get_field32(reg, MAC_CSR0_REVISION);\r\nswitch (rt) {\r\ncase RT2860:\r\ncase RT2872:\r\ncase RT2883:\r\ncase RT3070:\r\ncase RT3071:\r\ncase RT3090:\r\ncase RT3290:\r\ncase RT3352:\r\ncase RT3390:\r\ncase RT3572:\r\ncase RT3593:\r\ncase RT5390:\r\ncase RT5392:\r\ncase RT5592:\r\nbreak;\r\ndefault:\r\nrt2x00_err(rt2x00dev, "Invalid RT chipset 0x%04x, rev %04x detected\n",\r\nrt, rev);\r\nreturn -ENODEV;\r\n}\r\nrt2x00_set_rt(rt2x00dev, rt, rev);\r\nreturn 0;\r\n}\r\nint rt2800_probe_hw(struct rt2x00_dev *rt2x00dev)\r\n{\r\nint retval;\r\nu32 reg;\r\nretval = rt2800_probe_rt(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\nretval = rt2800_validate_eeprom(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\nretval = rt2800_init_eeprom(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\nrt2800_register_read(rt2x00dev, GPIO_CTRL, &reg);\r\nrt2x00_set_field32(&reg, GPIO_CTRL_DIR2, 1);\r\nrt2800_register_write(rt2x00dev, GPIO_CTRL, reg);\r\nretval = rt2800_probe_hw_mode(rt2x00dev);\r\nif (retval)\r\nreturn retval;\r\n__set_bit(CAPABILITY_CONTROL_FILTERS, &rt2x00dev->cap_flags);\r\n__set_bit(CAPABILITY_CONTROL_FILTER_PSPOLL, &rt2x00dev->cap_flags);\r\nif (!rt2x00_is_usb(rt2x00dev))\r\n__set_bit(CAPABILITY_PRE_TBTT_INTERRUPT, &rt2x00dev->cap_flags);\r\nif (!rt2x00_is_soc(rt2x00dev))\r\n__set_bit(REQUIRE_FIRMWARE, &rt2x00dev->cap_flags);\r\n__set_bit(REQUIRE_L2PAD, &rt2x00dev->cap_flags);\r\n__set_bit(REQUIRE_TXSTATUS_FIFO, &rt2x00dev->cap_flags);\r\nif (!rt2800_hwcrypt_disabled(rt2x00dev))\r\n__set_bit(CAPABILITY_HW_CRYPTO, &rt2x00dev->cap_flags);\r\n__set_bit(CAPABILITY_LINK_TUNING, &rt2x00dev->cap_flags);\r\n__set_bit(REQUIRE_HT_TX_DESC, &rt2x00dev->cap_flags);\r\nif (rt2x00_is_usb(rt2x00dev))\r\n__set_bit(REQUIRE_PS_AUTOWAKE, &rt2x00dev->cap_flags);\r\nelse {\r\n__set_bit(REQUIRE_DMA, &rt2x00dev->cap_flags);\r\n__set_bit(REQUIRE_TASKLET_CONTEXT, &rt2x00dev->cap_flags);\r\n}\r\nrt2x00dev->rssi_offset = DEFAULT_RSSI_OFFSET;\r\nreturn 0;\r\n}\r\nvoid rt2800_get_key_seq(struct ieee80211_hw *hw,\r\nstruct ieee80211_key_conf *key,\r\nstruct ieee80211_key_seq *seq)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nstruct mac_iveiv_entry iveiv_entry;\r\nu32 offset;\r\nif (key->cipher != WLAN_CIPHER_SUITE_TKIP)\r\nreturn;\r\noffset = MAC_IVEIV_ENTRY(key->hw_key_idx);\r\nrt2800_register_multiread(rt2x00dev, offset,\r\n&iveiv_entry, sizeof(iveiv_entry));\r\nmemcpy(&seq->tkip.iv16, &iveiv_entry.iv[0], 2);\r\nmemcpy(&seq->tkip.iv32, &iveiv_entry.iv[4], 4);\r\n}\r\nint rt2800_set_rts_threshold(struct ieee80211_hw *hw, u32 value)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nu32 reg;\r\nbool enabled = (value < IEEE80211_MAX_RTS_THRESHOLD);\r\nrt2800_register_read(rt2x00dev, TX_RTS_CFG, &reg);\r\nrt2x00_set_field32(&reg, TX_RTS_CFG_RTS_THRES, value);\r\nrt2800_register_write(rt2x00dev, TX_RTS_CFG, reg);\r\nrt2800_register_read(rt2x00dev, CCK_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, CCK_PROT_CFG_RTS_TH_EN, enabled);\r\nrt2800_register_write(rt2x00dev, CCK_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, OFDM_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, OFDM_PROT_CFG_RTS_TH_EN, enabled);\r\nrt2800_register_write(rt2x00dev, OFDM_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MM20_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, MM20_PROT_CFG_RTS_TH_EN, enabled);\r\nrt2800_register_write(rt2x00dev, MM20_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, MM40_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, MM40_PROT_CFG_RTS_TH_EN, enabled);\r\nrt2800_register_write(rt2x00dev, MM40_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, GF20_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, GF20_PROT_CFG_RTS_TH_EN, enabled);\r\nrt2800_register_write(rt2x00dev, GF20_PROT_CFG, reg);\r\nrt2800_register_read(rt2x00dev, GF40_PROT_CFG, &reg);\r\nrt2x00_set_field32(&reg, GF40_PROT_CFG_RTS_TH_EN, enabled);\r\nrt2800_register_write(rt2x00dev, GF40_PROT_CFG, reg);\r\nreturn 0;\r\n}\r\nint rt2800_conf_tx(struct ieee80211_hw *hw,\r\nstruct ieee80211_vif *vif, u16 queue_idx,\r\nconst struct ieee80211_tx_queue_params *params)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nstruct data_queue *queue;\r\nstruct rt2x00_field32 field;\r\nint retval;\r\nu32 reg;\r\nu32 offset;\r\nretval = rt2x00mac_conf_tx(hw, vif, queue_idx, params);\r\nif (retval)\r\nreturn retval;\r\nif (queue_idx >= 4)\r\nreturn 0;\r\nqueue = rt2x00queue_get_tx_queue(rt2x00dev, queue_idx);\r\noffset = WMM_TXOP0_CFG + (sizeof(u32) * (!!(queue_idx & 2)));\r\nfield.bit_offset = (queue_idx & 1) * 16;\r\nfield.bit_mask = 0xffff << field.bit_offset;\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2x00_set_field32(&reg, field, queue->txop);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\nfield.bit_offset = queue_idx * 4;\r\nfield.bit_mask = 0xf << field.bit_offset;\r\nrt2800_register_read(rt2x00dev, WMM_AIFSN_CFG, &reg);\r\nrt2x00_set_field32(&reg, field, queue->aifs);\r\nrt2800_register_write(rt2x00dev, WMM_AIFSN_CFG, reg);\r\nrt2800_register_read(rt2x00dev, WMM_CWMIN_CFG, &reg);\r\nrt2x00_set_field32(&reg, field, queue->cw_min);\r\nrt2800_register_write(rt2x00dev, WMM_CWMIN_CFG, reg);\r\nrt2800_register_read(rt2x00dev, WMM_CWMAX_CFG, &reg);\r\nrt2x00_set_field32(&reg, field, queue->cw_max);\r\nrt2800_register_write(rt2x00dev, WMM_CWMAX_CFG, reg);\r\noffset = EDCA_AC0_CFG + (sizeof(u32) * queue_idx);\r\nrt2800_register_read(rt2x00dev, offset, &reg);\r\nrt2x00_set_field32(&reg, EDCA_AC0_CFG_TX_OP, queue->txop);\r\nrt2x00_set_field32(&reg, EDCA_AC0_CFG_AIFSN, queue->aifs);\r\nrt2x00_set_field32(&reg, EDCA_AC0_CFG_CWMIN, queue->cw_min);\r\nrt2x00_set_field32(&reg, EDCA_AC0_CFG_CWMAX, queue->cw_max);\r\nrt2800_register_write(rt2x00dev, offset, reg);\r\nreturn 0;\r\n}\r\nu64 rt2800_get_tsf(struct ieee80211_hw *hw, struct ieee80211_vif *vif)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nu64 tsf;\r\nu32 reg;\r\nrt2800_register_read(rt2x00dev, TSF_TIMER_DW1, &reg);\r\ntsf = (u64) rt2x00_get_field32(reg, TSF_TIMER_DW1_HIGH_WORD) << 32;\r\nrt2800_register_read(rt2x00dev, TSF_TIMER_DW0, &reg);\r\ntsf |= rt2x00_get_field32(reg, TSF_TIMER_DW0_LOW_WORD);\r\nreturn tsf;\r\n}\r\nint rt2800_ampdu_action(struct ieee80211_hw *hw, struct ieee80211_vif *vif,\r\nstruct ieee80211_ampdu_params *params)\r\n{\r\nstruct ieee80211_sta *sta = params->sta;\r\nenum ieee80211_ampdu_mlme_action action = params->action;\r\nu16 tid = params->tid;\r\nstruct rt2x00_sta *sta_priv = (struct rt2x00_sta *)sta->drv_priv;\r\nint ret = 0;\r\nif (sta_priv->wcid > WCID_END)\r\nreturn 1;\r\nswitch (action) {\r\ncase IEEE80211_AMPDU_RX_START:\r\ncase IEEE80211_AMPDU_RX_STOP:\r\nbreak;\r\ncase IEEE80211_AMPDU_TX_START:\r\nieee80211_start_tx_ba_cb_irqsafe(vif, sta->addr, tid);\r\nbreak;\r\ncase IEEE80211_AMPDU_TX_STOP_CONT:\r\ncase IEEE80211_AMPDU_TX_STOP_FLUSH:\r\ncase IEEE80211_AMPDU_TX_STOP_FLUSH_CONT:\r\nieee80211_stop_tx_ba_cb_irqsafe(vif, sta->addr, tid);\r\nbreak;\r\ncase IEEE80211_AMPDU_TX_OPERATIONAL:\r\nbreak;\r\ndefault:\r\nrt2x00_warn((struct rt2x00_dev *)hw->priv,\r\n"Unknown AMPDU action\n");\r\n}\r\nreturn ret;\r\n}\r\nint rt2800_get_survey(struct ieee80211_hw *hw, int idx,\r\nstruct survey_info *survey)\r\n{\r\nstruct rt2x00_dev *rt2x00dev = hw->priv;\r\nstruct ieee80211_conf *conf = &hw->conf;\r\nu32 idle, busy, busy_ext;\r\nif (idx != 0)\r\nreturn -ENOENT;\r\nsurvey->channel = conf->chandef.chan;\r\nrt2800_register_read(rt2x00dev, CH_IDLE_STA, &idle);\r\nrt2800_register_read(rt2x00dev, CH_BUSY_STA, &busy);\r\nrt2800_register_read(rt2x00dev, CH_BUSY_STA_SEC, &busy_ext);\r\nif (idle || busy) {\r\nsurvey->filled = SURVEY_INFO_TIME |\r\nSURVEY_INFO_TIME_BUSY |\r\nSURVEY_INFO_TIME_EXT_BUSY;\r\nsurvey->time = (idle + busy) / 1000;\r\nsurvey->time_busy = busy / 1000;\r\nsurvey->time_ext_busy = busy_ext / 1000;\r\n}\r\nif (!(hw->conf.flags & IEEE80211_CONF_OFFCHANNEL))\r\nsurvey->filled |= SURVEY_INFO_IN_USE;\r\nreturn 0;\r\n}

static void xlr_nand_ctrl(struct mtd_info *mtd, int cmd,\r\nunsigned int ctrl)\r\n{\r\nif (ctrl & NAND_CLE)\r\nnlm_write_reg(nand_priv.flash_mmio,\r\nFLASH_NAND_CLE(nand_priv.cs), cmd);\r\nelse if (ctrl & NAND_ALE)\r\nnlm_write_reg(nand_priv.flash_mmio,\r\nFLASH_NAND_ALE(nand_priv.cs), cmd);\r\n}\r\nstatic void setup_flash_resource(uint64_t flash_mmio,\r\nuint64_t flash_map_base, int cs, struct resource *res)\r\n{\r\nu32 base, mask;\r\nbase = nlm_read_reg(flash_mmio, FLASH_CSBASE_ADDR(cs));\r\nmask = nlm_read_reg(flash_mmio, FLASH_CSADDR_MASK(cs));\r\nres->start = flash_map_base + ((unsigned long)base << 16);\r\nres->end = res->start + (mask + 1) * 64 * 1024;\r\n}\r\nstatic int __init xlr_flash_init(void)\r\n{\r\nuint64_t gpio_mmio, flash_mmio, flash_map_base;\r\nu32 gpio_resetcfg, flash_bar;\r\nint cs, boot_nand, boot_nor;\r\nflash_bar = nlm_read_reg(nlm_io_base, BRIDGE_FLASH_BAR);\r\nflash_map_base = (flash_bar & 0xffff0000) << 8;\r\ngpio_mmio = nlm_mmio_base(NETLOGIC_IO_GPIO_OFFSET);\r\nflash_mmio = nlm_mmio_base(NETLOGIC_IO_FLASH_OFFSET);\r\ngpio_resetcfg = nlm_read_reg(gpio_mmio, GPIO_PWRON_RESET_CFG_REG);\r\nboot_nor = boot_nand = 0;\r\nif (nlm_chip_is_xls()) {\r\nif (gpio_resetcfg & (1 << 16))\r\nboot_nand = 1;\r\nif ((gpio_resetcfg & (1 << 15)) == 0)\r\nboot_nor = 1;\r\n} else {\r\nif ((gpio_resetcfg & (1 << 16)) == 0)\r\nboot_nor = 1;\r\n}\r\ncs = 0;\r\nif (boot_nand) {\r\nnand_priv.cs = cs;\r\nnand_priv.flash_mmio = flash_mmio;\r\nsetup_flash_resource(flash_mmio, flash_map_base, cs,\r\nxlr_nand_res);\r\nnlm_write_reg(flash_mmio, FLASH_CSDEV_PARM(cs),\r\nFLASH_NAND_CSDEV_PARAM);\r\nnlm_write_reg(flash_mmio, FLASH_CSTIME_PARMA(cs),\r\nFLASH_NAND_CSTIME_PARAMA);\r\nnlm_write_reg(flash_mmio, FLASH_CSTIME_PARMB(cs),\r\nFLASH_NAND_CSTIME_PARAMB);\r\npr_info("ChipSelect %d: NAND Flash %pR\n", cs, xlr_nand_res);\r\nreturn platform_device_register(&xlr_nand_dev);\r\n}\r\nif (boot_nor) {\r\nsetup_flash_resource(flash_mmio, flash_map_base, cs,\r\nxlr_nor_res);\r\npr_info("ChipSelect %d: NOR Flash %pR\n", cs, xlr_nor_res);\r\nreturn platform_device_register(&xlr_nor_dev);\r\n}\r\nreturn 0;\r\n}

void drain_openssl_errors(void)\r\n{\r\nconst char *file;\r\nint line;\r\nif (ERR_peek_error() == 0)\r\nreturn;\r\nwhile (ERR_get_error_line(&file, &line)) {}\r\n}\r\nstatic void write_cert(X509 *x509)\r\n{\r\nchar buf[200];\r\nif (!wb) {\r\nwb = BIO_new_file(cert_dst, "wb");\r\nERR(!wb, "%s", cert_dst);\r\n}\r\nX509_NAME_oneline(X509_get_subject_name(x509), buf, sizeof(buf));\r\nERR(!i2d_X509_bio(wb, x509), "%s", cert_dst);\r\nif (kbuild_verbose)\r\nfprintf(stderr, "Extracted cert: %s\n", buf);\r\n}\r\nint main(int argc, char **argv)\r\n{\r\nchar *cert_src;\r\nOpenSSL_add_all_algorithms();\r\nERR_load_crypto_strings();\r\nERR_clear_error();\r\nkbuild_verbose = atoi(getenv("KBUILD_VERBOSE")?:"0");\r\nkey_pass = getenv("KBUILD_SIGN_PIN");\r\nif (argc != 3)\r\nformat();\r\ncert_src = argv[1];\r\ncert_dst = argv[2];\r\nif (!cert_src[0]) {\r\nFILE *f = fopen(cert_dst, "wb");\r\nERR(!f, "%s", cert_dst);\r\nfclose(f);\r\nexit(0);\r\n} else if (!strncmp(cert_src, "pkcs11:", 7)) {\r\nENGINE *e;\r\nstruct {\r\nconst char *cert_id;\r\nX509 *cert;\r\n} parms;\r\nparms.cert_id = cert_src;\r\nparms.cert = NULL;\r\nENGINE_load_builtin_engines();\r\ndrain_openssl_errors();\r\ne = ENGINE_by_id("pkcs11");\r\nERR(!e, "Load PKCS#11 ENGINE");\r\nif (ENGINE_init(e))\r\ndrain_openssl_errors();\r\nelse\r\nERR(1, "ENGINE_init");\r\nif (key_pass)\r\nERR(!ENGINE_ctrl_cmd_string(e, "PIN", key_pass, 0), "Set PKCS#11 PIN");\r\nENGINE_ctrl_cmd(e, "LOAD_CERT_CTRL", 0, &parms, NULL, 1);\r\nERR(!parms.cert, "Get X.509 from PKCS#11");\r\nwrite_cert(parms.cert);\r\n} else {\r\nBIO *b;\r\nX509 *x509;\r\nb = BIO_new_file(cert_src, "rb");\r\nERR(!b, "%s", cert_src);\r\nwhile (1) {\r\nx509 = PEM_read_bio_X509(b, NULL, NULL, NULL);\r\nif (wb && !x509) {\r\nunsigned long err = ERR_peek_last_error();\r\nif (ERR_GET_LIB(err) == ERR_LIB_PEM &&\r\nERR_GET_REASON(err) == PEM_R_NO_START_LINE) {\r\nERR_clear_error();\r\nbreak;\r\n}\r\n}\r\nERR(!x509, "%s", cert_src);\r\nwrite_cert(x509);\r\n}\r\n}\r\nBIO_free(wb);\r\nreturn 0;\r\n}

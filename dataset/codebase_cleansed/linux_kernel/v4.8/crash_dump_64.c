ssize_t copy_oldmem_page(unsigned long pfn, char *buf,\r\nsize_t csize, unsigned long offset, int userbuf)\r\n{\r\nvoid *vaddr;\r\nif (!csize)\r\nreturn 0;\r\nvaddr = ioremap_cache(pfn << PAGE_SHIFT, PAGE_SIZE);\r\nif (!vaddr)\r\nreturn -ENOMEM;\r\nif (userbuf) {\r\nif (copy_to_user(buf, vaddr + offset, csize)) {\r\niounmap(vaddr);\r\nreturn -EFAULT;\r\n}\r\n} else\r\nmemcpy(buf, vaddr + offset, csize);\r\nset_iounmap_nonlazy();\r\niounmap(vaddr);\r\nreturn csize;\r\n}

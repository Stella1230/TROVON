struct ib_pd *rvt_alloc_pd(struct ib_device *ibdev,\r\nstruct ib_ucontext *context,\r\nstruct ib_udata *udata)\r\n{\r\nstruct rvt_dev_info *dev = ib_to_rvt(ibdev);\r\nstruct rvt_pd *pd;\r\nstruct ib_pd *ret;\r\npd = kmalloc(sizeof(*pd), GFP_KERNEL);\r\nif (!pd) {\r\nret = ERR_PTR(-ENOMEM);\r\ngoto bail;\r\n}\r\nspin_lock(&dev->n_pds_lock);\r\nif (dev->n_pds_allocated == dev->dparms.props.max_pd) {\r\nspin_unlock(&dev->n_pds_lock);\r\nkfree(pd);\r\nret = ERR_PTR(-ENOMEM);\r\ngoto bail;\r\n}\r\ndev->n_pds_allocated++;\r\nspin_unlock(&dev->n_pds_lock);\r\npd->user = udata ? 1 : 0;\r\nret = &pd->ibpd;\r\nbail:\r\nreturn ret;\r\n}\r\nint rvt_dealloc_pd(struct ib_pd *ibpd)\r\n{\r\nstruct rvt_pd *pd = ibpd_to_rvtpd(ibpd);\r\nstruct rvt_dev_info *dev = ib_to_rvt(ibpd->device);\r\nspin_lock(&dev->n_pds_lock);\r\ndev->n_pds_allocated--;\r\nspin_unlock(&dev->n_pds_lock);\r\nkfree(pd);\r\nreturn 0;\r\n}

static void refresh_text_box(WINDOW *dialog, WINDOW *box, int boxh, int boxw,\r\nint cur_y, int cur_x, update_text_fn update_text,\r\nvoid *data)\r\n{\r\nprint_page(box, boxh, boxw, update_text, data);\r\nprint_position(dialog);\r\nwmove(dialog, cur_y, cur_x);\r\nwrefresh(dialog);\r\n}\r\nint dialog_textbox(const char *title, char *tbuf, int initial_height,\r\nint initial_width, int *keys, int *_vscroll, int *_hscroll,\r\nupdate_text_fn update_text, void *data)\r\n{\r\nint i, x, y, cur_x, cur_y, key = 0;\r\nint height, width, boxh, boxw;\r\nWINDOW *dialog, *box;\r\nbool done = false;\r\nbegin_reached = 1;\r\nend_reached = 0;\r\npage_length = 0;\r\nhscroll = 0;\r\nbuf = tbuf;\r\npage = buf;\r\nif (_vscroll && *_vscroll) {\r\nbegin_reached = 0;\r\nfor (i = 0; i < *_vscroll; i++)\r\nget_line();\r\n}\r\nif (_hscroll)\r\nhscroll = *_hscroll;\r\ndo_resize:\r\ngetmaxyx(stdscr, height, width);\r\nif (height < TEXTBOX_HEIGTH_MIN || width < TEXTBOX_WIDTH_MIN)\r\nreturn -ERRDISPLAYTOOSMALL;\r\nif (initial_height != 0)\r\nheight = initial_height;\r\nelse\r\nif (height > 4)\r\nheight -= 4;\r\nelse\r\nheight = 0;\r\nif (initial_width != 0)\r\nwidth = initial_width;\r\nelse\r\nif (width > 5)\r\nwidth -= 5;\r\nelse\r\nwidth = 0;\r\nx = (getmaxx(stdscr) - width) / 2;\r\ny = (getmaxy(stdscr) - height) / 2;\r\ndraw_shadow(stdscr, y, x, height, width);\r\ndialog = newwin(height, width, y, x);\r\nkeypad(dialog, TRUE);\r\nboxh = height - 4;\r\nboxw = width - 2;\r\nbox = subwin(dialog, boxh, boxw, y + 1, x + 1);\r\nwattrset(box, dlg.dialog.atr);\r\nwbkgdset(box, dlg.dialog.atr & A_COLOR);\r\nkeypad(box, TRUE);\r\ndraw_box(dialog, 0, 0, height, width,\r\ndlg.dialog.atr, dlg.border.atr);\r\nwattrset(dialog, dlg.border.atr);\r\nmvwaddch(dialog, height - 3, 0, ACS_LTEE);\r\nfor (i = 0; i < width - 2; i++)\r\nwaddch(dialog, ACS_HLINE);\r\nwattrset(dialog, dlg.dialog.atr);\r\nwbkgdset(dialog, dlg.dialog.atr & A_COLOR);\r\nwaddch(dialog, ACS_RTEE);\r\nprint_title(dialog, title, width);\r\nprint_button(dialog, gettext(" Exit "), height - 2, width / 2 - 4, TRUE);\r\nwnoutrefresh(dialog);\r\ngetyx(dialog, cur_y, cur_x);\r\nattr_clear(box, boxh, boxw, dlg.dialog.atr);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y, cur_x, update_text,\r\ndata);\r\nwhile (!done) {\r\nkey = wgetch(dialog);\r\nswitch (key) {\r\ncase 'E':\r\ncase 'e':\r\ncase 'X':\r\ncase 'x':\r\ncase 'q':\r\ncase '\n':\r\ndone = true;\r\nbreak;\r\ncase 'g':\r\ncase KEY_HOME:\r\nif (!begin_reached) {\r\nbegin_reached = 1;\r\npage = buf;\r\nrefresh_text_box(dialog, box, boxh, boxw,\r\ncur_y, cur_x, update_text,\r\ndata);\r\n}\r\nbreak;\r\ncase 'G':\r\ncase KEY_END:\r\nend_reached = 1;\r\npage = buf + strlen(buf);\r\nback_lines(boxh);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase 'K':\r\ncase 'k':\r\ncase KEY_UP:\r\nif (begin_reached)\r\nbreak;\r\nback_lines(page_length + 1);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase 'B':\r\ncase 'b':\r\ncase 'u':\r\ncase KEY_PPAGE:\r\nif (begin_reached)\r\nbreak;\r\nback_lines(page_length + boxh);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase 'J':\r\ncase 'j':\r\ncase KEY_DOWN:\r\nif (end_reached)\r\nbreak;\r\nback_lines(page_length - 1);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase KEY_NPAGE:\r\ncase ' ':\r\ncase 'd':\r\nif (end_reached)\r\nbreak;\r\nbegin_reached = 0;\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase '0':\r\ncase 'H':\r\ncase 'h':\r\ncase KEY_LEFT:\r\nif (hscroll <= 0)\r\nbreak;\r\nif (key == '0')\r\nhscroll = 0;\r\nelse\r\nhscroll--;\r\nback_lines(page_length);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase 'L':\r\ncase 'l':\r\ncase KEY_RIGHT:\r\nif (hscroll >= MAX_LEN)\r\nbreak;\r\nhscroll++;\r\nback_lines(page_length);\r\nrefresh_text_box(dialog, box, boxh, boxw, cur_y,\r\ncur_x, update_text, data);\r\nbreak;\r\ncase KEY_ESC:\r\nif (on_key_esc(dialog) == KEY_ESC)\r\ndone = true;\r\nbreak;\r\ncase KEY_RESIZE:\r\nback_lines(height);\r\ndelwin(box);\r\ndelwin(dialog);\r\non_key_resize();\r\ngoto do_resize;\r\ndefault:\r\nfor (i = 0; keys[i]; i++) {\r\nif (key == keys[i]) {\r\ndone = true;\r\nbreak;\r\n}\r\n}\r\n}\r\n}\r\ndelwin(box);\r\ndelwin(dialog);\r\nif (_vscroll) {\r\nconst char *s;\r\ns = buf;\r\n*_vscroll = 0;\r\nback_lines(page_length);\r\nwhile (s < page && (s = strchr(s, '\n'))) {\r\n(*_vscroll)++;\r\ns++;\r\n}\r\n}\r\nif (_hscroll)\r\n*_hscroll = hscroll;\r\nreturn key;\r\n}\r\nstatic void back_lines(int n)\r\n{\r\nint i;\r\nbegin_reached = 0;\r\nfor (i = 0; i < n; i++) {\r\nif (*page == '\0') {\r\nif (end_reached) {\r\nend_reached = 0;\r\ncontinue;\r\n}\r\n}\r\nif (page == buf) {\r\nbegin_reached = 1;\r\nreturn;\r\n}\r\npage--;\r\ndo {\r\nif (page == buf) {\r\nbegin_reached = 1;\r\nreturn;\r\n}\r\npage--;\r\n} while (*page != '\n');\r\npage++;\r\n}\r\n}\r\nstatic void print_page(WINDOW *win, int height, int width, update_text_fn\r\nupdate_text, void *data)\r\n{\r\nint i, passed_end = 0;\r\nif (update_text) {\r\nchar *end;\r\nfor (i = 0; i < height; i++)\r\nget_line();\r\nend = page;\r\nback_lines(height);\r\nupdate_text(buf, page - buf, end - buf, data);\r\n}\r\npage_length = 0;\r\nfor (i = 0; i < height; i++) {\r\nprint_line(win, i, width);\r\nif (!passed_end)\r\npage_length++;\r\nif (end_reached && !passed_end)\r\npassed_end = 1;\r\n}\r\nwnoutrefresh(win);\r\n}\r\nstatic void print_line(WINDOW * win, int row, int width)\r\n{\r\nchar *line;\r\nline = get_line();\r\nline += MIN(strlen(line), hscroll);\r\nwmove(win, row, 0);\r\nwaddch(win, ' ');\r\nwaddnstr(win, line, MIN(strlen(line), width - 2));\r\n#if OLD_NCURSES\r\n{\r\nint x = getcurx(win);\r\nint i;\r\nfor (i = 0; i < width - x; i++)\r\nwaddch(win, ' ');\r\n}\r\n#else\r\nwclrtoeol(win);\r\n#endif\r\n}\r\nstatic char *get_line(void)\r\n{\r\nint i = 0;\r\nstatic char line[MAX_LEN + 1];\r\nend_reached = 0;\r\nwhile (*page != '\n') {\r\nif (*page == '\0') {\r\nend_reached = 1;\r\nbreak;\r\n} else if (i < MAX_LEN)\r\nline[i++] = *(page++);\r\nelse {\r\nif (i == MAX_LEN)\r\nline[i++] = '\0';\r\npage++;\r\n}\r\n}\r\nif (i <= MAX_LEN)\r\nline[i] = '\0';\r\nif (!end_reached)\r\npage++;\r\nreturn line;\r\n}\r\nstatic void print_position(WINDOW * win)\r\n{\r\nint percent;\r\nwattrset(win, dlg.position_indicator.atr);\r\nwbkgdset(win, dlg.position_indicator.atr & A_COLOR);\r\npercent = (page - buf) * 100 / strlen(buf);\r\nwmove(win, getmaxy(win) - 3, getmaxx(win) - 9);\r\nwprintw(win, "(%3d%%)", percent);\r\n}

static int translated_ioctl(struct file *file, unsigned int cmd,\r\nunsigned long arg)\r\n{\r\nif (file->f_op->unlocked_ioctl)\r\nreturn file->f_op->unlocked_ioctl(file, cmd, arg);\r\nreturn -ENOTTY;\r\n}\r\nstatic int compat_chaninfo(struct file *file, unsigned long arg)\r\n{\r\nstruct comedi_chaninfo __user *chaninfo;\r\nstruct comedi32_chaninfo_struct __user *chaninfo32;\r\nint err;\r\nunion {\r\nunsigned int uint;\r\ncompat_uptr_t uptr;\r\n} temp;\r\nchaninfo32 = compat_ptr(arg);\r\nchaninfo = compat_alloc_user_space(sizeof(*chaninfo));\r\nif (!access_ok(VERIFY_READ, chaninfo32, sizeof(*chaninfo32)) ||\r\n!access_ok(VERIFY_WRITE, chaninfo, sizeof(*chaninfo)))\r\nreturn -EFAULT;\r\nerr = 0;\r\nerr |= __get_user(temp.uint, &chaninfo32->subdev);\r\nerr |= __put_user(temp.uint, &chaninfo->subdev);\r\nerr |= __get_user(temp.uptr, &chaninfo32->maxdata_list);\r\nerr |= __put_user(compat_ptr(temp.uptr), &chaninfo->maxdata_list);\r\nerr |= __get_user(temp.uptr, &chaninfo32->flaglist);\r\nerr |= __put_user(compat_ptr(temp.uptr), &chaninfo->flaglist);\r\nerr |= __get_user(temp.uptr, &chaninfo32->rangelist);\r\nerr |= __put_user(compat_ptr(temp.uptr), &chaninfo->rangelist);\r\nif (err)\r\nreturn -EFAULT;\r\nreturn translated_ioctl(file, COMEDI_CHANINFO, (unsigned long)chaninfo);\r\n}\r\nstatic int compat_rangeinfo(struct file *file, unsigned long arg)\r\n{\r\nstruct comedi_rangeinfo __user *rangeinfo;\r\nstruct comedi32_rangeinfo_struct __user *rangeinfo32;\r\nint err;\r\nunion {\r\nunsigned int uint;\r\ncompat_uptr_t uptr;\r\n} temp;\r\nrangeinfo32 = compat_ptr(arg);\r\nrangeinfo = compat_alloc_user_space(sizeof(*rangeinfo));\r\nif (!access_ok(VERIFY_READ, rangeinfo32, sizeof(*rangeinfo32)) ||\r\n!access_ok(VERIFY_WRITE, rangeinfo, sizeof(*rangeinfo)))\r\nreturn -EFAULT;\r\nerr = 0;\r\nerr |= __get_user(temp.uint, &rangeinfo32->range_type);\r\nerr |= __put_user(temp.uint, &rangeinfo->range_type);\r\nerr |= __get_user(temp.uptr, &rangeinfo32->range_ptr);\r\nerr |= __put_user(compat_ptr(temp.uptr), &rangeinfo->range_ptr);\r\nif (err)\r\nreturn -EFAULT;\r\nreturn translated_ioctl(file, COMEDI_RANGEINFO,\r\n(unsigned long)rangeinfo);\r\n}\r\nstatic int get_compat_cmd(struct comedi_cmd __user *cmd,\r\nstruct comedi32_cmd_struct __user *cmd32)\r\n{\r\nint err;\r\nunion {\r\nunsigned int uint;\r\ncompat_uptr_t uptr;\r\n} temp;\r\nif (!access_ok(VERIFY_READ, cmd32, sizeof(*cmd32)) ||\r\n!access_ok(VERIFY_WRITE, cmd, sizeof(*cmd)))\r\nreturn -EFAULT;\r\nerr = 0;\r\nerr |= __get_user(temp.uint, &cmd32->subdev);\r\nerr |= __put_user(temp.uint, &cmd->subdev);\r\nerr |= __get_user(temp.uint, &cmd32->flags);\r\nerr |= __put_user(temp.uint, &cmd->flags);\r\nerr |= __get_user(temp.uint, &cmd32->start_src);\r\nerr |= __put_user(temp.uint, &cmd->start_src);\r\nerr |= __get_user(temp.uint, &cmd32->start_arg);\r\nerr |= __put_user(temp.uint, &cmd->start_arg);\r\nerr |= __get_user(temp.uint, &cmd32->scan_begin_src);\r\nerr |= __put_user(temp.uint, &cmd->scan_begin_src);\r\nerr |= __get_user(temp.uint, &cmd32->scan_begin_arg);\r\nerr |= __put_user(temp.uint, &cmd->scan_begin_arg);\r\nerr |= __get_user(temp.uint, &cmd32->convert_src);\r\nerr |= __put_user(temp.uint, &cmd->convert_src);\r\nerr |= __get_user(temp.uint, &cmd32->convert_arg);\r\nerr |= __put_user(temp.uint, &cmd->convert_arg);\r\nerr |= __get_user(temp.uint, &cmd32->scan_end_src);\r\nerr |= __put_user(temp.uint, &cmd->scan_end_src);\r\nerr |= __get_user(temp.uint, &cmd32->scan_end_arg);\r\nerr |= __put_user(temp.uint, &cmd->scan_end_arg);\r\nerr |= __get_user(temp.uint, &cmd32->stop_src);\r\nerr |= __put_user(temp.uint, &cmd->stop_src);\r\nerr |= __get_user(temp.uint, &cmd32->stop_arg);\r\nerr |= __put_user(temp.uint, &cmd->stop_arg);\r\nerr |= __get_user(temp.uptr, &cmd32->chanlist);\r\nerr |= __put_user((unsigned int __force *)compat_ptr(temp.uptr),\r\n&cmd->chanlist);\r\nerr |= __get_user(temp.uint, &cmd32->chanlist_len);\r\nerr |= __put_user(temp.uint, &cmd->chanlist_len);\r\nerr |= __get_user(temp.uptr, &cmd32->data);\r\nerr |= __put_user(compat_ptr(temp.uptr), &cmd->data);\r\nerr |= __get_user(temp.uint, &cmd32->data_len);\r\nerr |= __put_user(temp.uint, &cmd->data_len);\r\nreturn err ? -EFAULT : 0;\r\n}\r\nstatic int put_compat_cmd(struct comedi32_cmd_struct __user *cmd32,\r\nstruct comedi_cmd __user *cmd)\r\n{\r\nint err;\r\nunsigned int temp;\r\nif (!access_ok(VERIFY_READ, cmd, sizeof(*cmd)) ||\r\n!access_ok(VERIFY_WRITE, cmd32, sizeof(*cmd32)))\r\nreturn -EFAULT;\r\nerr = 0;\r\nerr |= __get_user(temp, &cmd->subdev);\r\nerr |= __put_user(temp, &cmd32->subdev);\r\nerr |= __get_user(temp, &cmd->flags);\r\nerr |= __put_user(temp, &cmd32->flags);\r\nerr |= __get_user(temp, &cmd->start_src);\r\nerr |= __put_user(temp, &cmd32->start_src);\r\nerr |= __get_user(temp, &cmd->start_arg);\r\nerr |= __put_user(temp, &cmd32->start_arg);\r\nerr |= __get_user(temp, &cmd->scan_begin_src);\r\nerr |= __put_user(temp, &cmd32->scan_begin_src);\r\nerr |= __get_user(temp, &cmd->scan_begin_arg);\r\nerr |= __put_user(temp, &cmd32->scan_begin_arg);\r\nerr |= __get_user(temp, &cmd->convert_src);\r\nerr |= __put_user(temp, &cmd32->convert_src);\r\nerr |= __get_user(temp, &cmd->convert_arg);\r\nerr |= __put_user(temp, &cmd32->convert_arg);\r\nerr |= __get_user(temp, &cmd->scan_end_src);\r\nerr |= __put_user(temp, &cmd32->scan_end_src);\r\nerr |= __get_user(temp, &cmd->scan_end_arg);\r\nerr |= __put_user(temp, &cmd32->scan_end_arg);\r\nerr |= __get_user(temp, &cmd->stop_src);\r\nerr |= __put_user(temp, &cmd32->stop_src);\r\nerr |= __get_user(temp, &cmd->stop_arg);\r\nerr |= __put_user(temp, &cmd32->stop_arg);\r\nerr |= __get_user(temp, &cmd->chanlist_len);\r\nerr |= __put_user(temp, &cmd32->chanlist_len);\r\nerr |= __get_user(temp, &cmd->data_len);\r\nerr |= __put_user(temp, &cmd32->data_len);\r\nreturn err ? -EFAULT : 0;\r\n}\r\nstatic int compat_cmd(struct file *file, unsigned long arg)\r\n{\r\nstruct comedi_cmd __user *cmd;\r\nstruct comedi32_cmd_struct __user *cmd32;\r\nint rc, err;\r\ncmd32 = compat_ptr(arg);\r\ncmd = compat_alloc_user_space(sizeof(*cmd));\r\nrc = get_compat_cmd(cmd, cmd32);\r\nif (rc)\r\nreturn rc;\r\nrc = translated_ioctl(file, COMEDI_CMD, (unsigned long)cmd);\r\nif (rc == -EAGAIN) {\r\nerr = put_compat_cmd(cmd32, cmd);\r\nif (err)\r\nrc = err;\r\n}\r\nreturn rc;\r\n}\r\nstatic int compat_cmdtest(struct file *file, unsigned long arg)\r\n{\r\nstruct comedi_cmd __user *cmd;\r\nstruct comedi32_cmd_struct __user *cmd32;\r\nint rc, err;\r\ncmd32 = compat_ptr(arg);\r\ncmd = compat_alloc_user_space(sizeof(*cmd));\r\nrc = get_compat_cmd(cmd, cmd32);\r\nif (rc)\r\nreturn rc;\r\nrc = translated_ioctl(file, COMEDI_CMDTEST, (unsigned long)cmd);\r\nif (rc < 0)\r\nreturn rc;\r\nerr = put_compat_cmd(cmd32, cmd);\r\nif (err)\r\nrc = err;\r\nreturn rc;\r\n}\r\nstatic int get_compat_insn(struct comedi_insn __user *insn,\r\nstruct comedi32_insn_struct __user *insn32)\r\n{\r\nint err;\r\nunion {\r\nunsigned int uint;\r\ncompat_uptr_t uptr;\r\n} temp;\r\nerr = 0;\r\nif (!access_ok(VERIFY_READ, insn32, sizeof(*insn32)) ||\r\n!access_ok(VERIFY_WRITE, insn, sizeof(*insn)))\r\nreturn -EFAULT;\r\nerr |= __get_user(temp.uint, &insn32->insn);\r\nerr |= __put_user(temp.uint, &insn->insn);\r\nerr |= __get_user(temp.uint, &insn32->n);\r\nerr |= __put_user(temp.uint, &insn->n);\r\nerr |= __get_user(temp.uptr, &insn32->data);\r\nerr |= __put_user(compat_ptr(temp.uptr), &insn->data);\r\nerr |= __get_user(temp.uint, &insn32->subdev);\r\nerr |= __put_user(temp.uint, &insn->subdev);\r\nerr |= __get_user(temp.uint, &insn32->chanspec);\r\nerr |= __put_user(temp.uint, &insn->chanspec);\r\nreturn err ? -EFAULT : 0;\r\n}\r\nstatic int compat_insnlist(struct file *file, unsigned long arg)\r\n{\r\nstruct combined_insnlist {\r\nstruct comedi_insnlist insnlist;\r\nstruct comedi_insn insn[1];\r\n} __user *s;\r\nstruct comedi32_insnlist_struct __user *insnlist32;\r\nstruct comedi32_insn_struct __user *insn32;\r\ncompat_uptr_t uptr;\r\nunsigned int n_insns, n;\r\nint err, rc;\r\ninsnlist32 = compat_ptr(arg);\r\nif (!access_ok(VERIFY_READ, insnlist32, sizeof(*insnlist32)))\r\nreturn -EFAULT;\r\nerr = 0;\r\nerr |= __get_user(n_insns, &insnlist32->n_insns);\r\nerr |= __get_user(uptr, &insnlist32->insns);\r\ninsn32 = compat_ptr(uptr);\r\nif (err)\r\nreturn -EFAULT;\r\ns = compat_alloc_user_space(offsetof(struct combined_insnlist,\r\ninsn[n_insns]));\r\nif (!access_ok(VERIFY_WRITE, &s->insnlist, sizeof(s->insnlist)))\r\nreturn -EFAULT;\r\nerr |= __put_user(n_insns, &s->insnlist.n_insns);\r\nerr |= __put_user(&s->insn[0], &s->insnlist.insns);\r\nif (err)\r\nreturn -EFAULT;\r\nfor (n = 0; n < n_insns; n++) {\r\nrc = get_compat_insn(&s->insn[n], &insn32[n]);\r\nif (rc)\r\nreturn rc;\r\n}\r\nreturn translated_ioctl(file, COMEDI_INSNLIST,\r\n(unsigned long)&s->insnlist);\r\n}\r\nstatic int compat_insn(struct file *file, unsigned long arg)\r\n{\r\nstruct comedi_insn __user *insn;\r\nstruct comedi32_insn_struct __user *insn32;\r\nint rc;\r\ninsn32 = compat_ptr(arg);\r\ninsn = compat_alloc_user_space(sizeof(*insn));\r\nrc = get_compat_insn(insn, insn32);\r\nif (rc)\r\nreturn rc;\r\nreturn translated_ioctl(file, COMEDI_INSN, (unsigned long)insn);\r\n}\r\nlong comedi_compat_ioctl(struct file *file, unsigned int cmd, unsigned long arg)\r\n{\r\nint rc;\r\nswitch (cmd) {\r\ncase COMEDI_DEVCONFIG:\r\ncase COMEDI_DEVINFO:\r\ncase COMEDI_SUBDINFO:\r\ncase COMEDI_BUFCONFIG:\r\ncase COMEDI_BUFINFO:\r\narg = (unsigned long)compat_ptr(arg);\r\nrc = translated_ioctl(file, cmd, arg);\r\nbreak;\r\ncase COMEDI_LOCK:\r\ncase COMEDI_UNLOCK:\r\ncase COMEDI_CANCEL:\r\ncase COMEDI_POLL:\r\ncase COMEDI_SETRSUBD:\r\ncase COMEDI_SETWSUBD:\r\nrc = translated_ioctl(file, cmd, arg);\r\nbreak;\r\ncase COMEDI32_CHANINFO:\r\nrc = compat_chaninfo(file, arg);\r\nbreak;\r\ncase COMEDI32_RANGEINFO:\r\nrc = compat_rangeinfo(file, arg);\r\nbreak;\r\ncase COMEDI32_CMD:\r\nrc = compat_cmd(file, arg);\r\nbreak;\r\ncase COMEDI32_CMDTEST:\r\nrc = compat_cmdtest(file, arg);\r\nbreak;\r\ncase COMEDI32_INSNLIST:\r\nrc = compat_insnlist(file, arg);\r\nbreak;\r\ncase COMEDI32_INSN:\r\nrc = compat_insn(file, arg);\r\nbreak;\r\ndefault:\r\nrc = -ENOIOCTLCMD;\r\nbreak;\r\n}\r\nreturn rc;\r\n}

static int __init cmp_fake_mem(const void *x1, const void *x2)\r\n{\r\nconst struct fake_mem *m1 = x1;\r\nconst struct fake_mem *m2 = x2;\r\nif (m1->range.start < m2->range.start)\r\nreturn -1;\r\nif (m1->range.start > m2->range.start)\r\nreturn 1;\r\nreturn 0;\r\n}\r\nvoid __init efi_fake_memmap(void)\r\n{\r\nu64 start, end, m_start, m_end, m_attr;\r\nint new_nr_map = efi.memmap.nr_map;\r\nefi_memory_desc_t *md;\r\nphys_addr_t new_memmap_phy;\r\nvoid *new_memmap;\r\nvoid *old, *new;\r\nint i;\r\nif (!nr_fake_mem || !efi_enabled(EFI_MEMMAP))\r\nreturn;\r\nfor_each_efi_memory_desc(md) {\r\nstart = md->phys_addr;\r\nend = start + (md->num_pages << EFI_PAGE_SHIFT) - 1;\r\nfor (i = 0; i < nr_fake_mem; i++) {\r\nm_start = fake_mems[i].range.start;\r\nm_end = fake_mems[i].range.end;\r\nif (m_start <= start) {\r\nif (start < m_end && m_end < end)\r\nnew_nr_map++;\r\n}\r\nif (start < m_start && m_start < end) {\r\nif (m_end < end)\r\nnew_nr_map += 2;\r\nif (end <= m_end)\r\nnew_nr_map++;\r\n}\r\n}\r\n}\r\nnew_memmap_phy = memblock_alloc(efi.memmap.desc_size * new_nr_map,\r\nPAGE_SIZE);\r\nif (!new_memmap_phy)\r\nreturn;\r\nnew_memmap = early_memremap(new_memmap_phy,\r\nefi.memmap.desc_size * new_nr_map);\r\nif (!new_memmap) {\r\nmemblock_free(new_memmap_phy, efi.memmap.desc_size * new_nr_map);\r\nreturn;\r\n}\r\nfor (old = efi.memmap.map, new = new_memmap;\r\nold < efi.memmap.map_end;\r\nold += efi.memmap.desc_size, new += efi.memmap.desc_size) {\r\nmemcpy(new, old, efi.memmap.desc_size);\r\nmd = new;\r\nstart = md->phys_addr;\r\nend = md->phys_addr + (md->num_pages << EFI_PAGE_SHIFT) - 1;\r\nfor (i = 0; i < nr_fake_mem; i++) {\r\nm_start = fake_mems[i].range.start;\r\nm_end = fake_mems[i].range.end;\r\nm_attr = fake_mems[i].attribute;\r\nif (m_start <= start && end <= m_end)\r\nmd->attribute |= m_attr;\r\nif (m_start <= start &&\r\n(start < m_end && m_end < end)) {\r\nmd->attribute |= m_attr;\r\nmd->num_pages = (m_end - md->phys_addr + 1) >>\r\nEFI_PAGE_SHIFT;\r\nnew += efi.memmap.desc_size;\r\nmemcpy(new, old, efi.memmap.desc_size);\r\nmd = new;\r\nmd->phys_addr = m_end + 1;\r\nmd->num_pages = (end - md->phys_addr + 1) >>\r\nEFI_PAGE_SHIFT;\r\n}\r\nif ((start < m_start && m_start < end) && m_end < end) {\r\nmd->num_pages = (m_start - md->phys_addr) >>\r\nEFI_PAGE_SHIFT;\r\nnew += efi.memmap.desc_size;\r\nmemcpy(new, old, efi.memmap.desc_size);\r\nmd = new;\r\nmd->attribute |= m_attr;\r\nmd->phys_addr = m_start;\r\nmd->num_pages = (m_end - m_start + 1) >>\r\nEFI_PAGE_SHIFT;\r\nnew += efi.memmap.desc_size;\r\nmemcpy(new, old, efi.memmap.desc_size);\r\nmd = new;\r\nmd->phys_addr = m_end + 1;\r\nmd->num_pages = (end - m_end) >>\r\nEFI_PAGE_SHIFT;\r\n}\r\nif ((start < m_start && m_start < end) &&\r\n(end <= m_end)) {\r\nmd->num_pages = (m_start - md->phys_addr) >>\r\nEFI_PAGE_SHIFT;\r\nnew += efi.memmap.desc_size;\r\nmemcpy(new, old, efi.memmap.desc_size);\r\nmd = new;\r\nmd->phys_addr = m_start;\r\nmd->num_pages = (end - md->phys_addr + 1) >>\r\nEFI_PAGE_SHIFT;\r\nmd->attribute |= m_attr;\r\n}\r\n}\r\n}\r\nefi_unmap_memmap();\r\nefi.memmap.map = new_memmap;\r\nefi.memmap.phys_map = new_memmap_phy;\r\nefi.memmap.nr_map = new_nr_map;\r\nefi.memmap.map_end = efi.memmap.map + efi.memmap.nr_map * efi.memmap.desc_size;\r\nset_bit(EFI_MEMMAP, &efi.flags);\r\nefi_print_memmap();\r\n}\r\nstatic int __init setup_fake_mem(char *p)\r\n{\r\nu64 start = 0, mem_size = 0, attribute = 0;\r\nint i;\r\nif (!p)\r\nreturn -EINVAL;\r\nwhile (*p != '\0') {\r\nmem_size = memparse(p, &p);\r\nif (*p == '@')\r\nstart = memparse(p+1, &p);\r\nelse\r\nbreak;\r\nif (*p == ':')\r\nattribute = simple_strtoull(p+1, &p, 0);\r\nelse\r\nbreak;\r\nif (nr_fake_mem >= EFI_MAX_FAKEMEM)\r\nbreak;\r\nfake_mems[nr_fake_mem].range.start = start;\r\nfake_mems[nr_fake_mem].range.end = start + mem_size - 1;\r\nfake_mems[nr_fake_mem].attribute = attribute;\r\nnr_fake_mem++;\r\nif (*p == ',')\r\np++;\r\n}\r\nsort(fake_mems, nr_fake_mem, sizeof(struct fake_mem),\r\ncmp_fake_mem, NULL);\r\nfor (i = 0; i < nr_fake_mem; i++)\r\npr_info("efi_fake_mem: add attr=0x%016llx to [mem 0x%016llx-0x%016llx]",\r\nfake_mems[i].attribute, fake_mems[i].range.start,\r\nfake_mems[i].range.end);\r\nreturn *p == '\0' ? 0 : -EINVAL;\r\n}

static int its_fsl_mc_msi_prepare(struct irq_domain *msi_domain,\r\nstruct device *dev,\r\nint nvec, msi_alloc_info_t *info)\r\n{\r\nstruct fsl_mc_device *mc_bus_dev;\r\nstruct msi_domain_info *msi_info;\r\nif (WARN_ON(dev->bus != &fsl_mc_bus_type))\r\nreturn -EINVAL;\r\nmc_bus_dev = to_fsl_mc_device(dev);\r\nif (WARN_ON(!(mc_bus_dev->flags & FSL_MC_IS_DPRC)))\r\nreturn -EINVAL;\r\ninfo->scratchpad[0].ul = mc_bus_dev->icid;\r\nmsi_info = msi_get_domain_info(msi_domain->parent);\r\nreturn msi_info->ops->msi_prepare(msi_domain->parent, dev, nvec, info);\r\n}\r\nint __init its_fsl_mc_msi_init(void)\r\n{\r\nstruct device_node *np;\r\nstruct irq_domain *parent;\r\nstruct irq_domain *mc_msi_domain;\r\nfor (np = of_find_matching_node(NULL, its_device_id); np;\r\nnp = of_find_matching_node(np, its_device_id)) {\r\nif (!of_property_read_bool(np, "msi-controller"))\r\ncontinue;\r\nparent = irq_find_matching_host(np, DOMAIN_BUS_NEXUS);\r\nif (!parent || !msi_get_domain_info(parent)) {\r\npr_err("%s: unable to locate ITS domain\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\nmc_msi_domain = fsl_mc_msi_create_irq_domain(\r\nof_node_to_fwnode(np),\r\n&its_fsl_mc_msi_domain_info,\r\nparent);\r\nif (!mc_msi_domain) {\r\npr_err("%s: unable to create fsl-mc domain\n",\r\nnp->full_name);\r\ncontinue;\r\n}\r\nWARN_ON(mc_msi_domain->\r\nhost_data != &its_fsl_mc_msi_domain_info);\r\npr_info("fsl-mc MSI: %s domain created\n", np->full_name);\r\n}\r\nreturn 0;\r\n}\r\nvoid its_fsl_mc_msi_cleanup(void)\r\n{\r\nstruct device_node *np;\r\nfor (np = of_find_matching_node(NULL, its_device_id); np;\r\nnp = of_find_matching_node(np, its_device_id)) {\r\nstruct irq_domain *mc_msi_domain = irq_find_matching_host(\r\nnp,\r\nDOMAIN_BUS_FSL_MC_MSI);\r\nif (!of_property_read_bool(np, "msi-controller"))\r\ncontinue;\r\nif (mc_msi_domain &&\r\nmc_msi_domain->host_data == &its_fsl_mc_msi_domain_info)\r\nirq_domain_remove(mc_msi_domain);\r\n}\r\n}

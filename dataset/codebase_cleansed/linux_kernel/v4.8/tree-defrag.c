int btrfs_defrag_leaves(struct btrfs_trans_handle *trans,\r\nstruct btrfs_root *root)\r\n{\r\nstruct btrfs_path *path = NULL;\r\nstruct btrfs_key key;\r\nint ret = 0;\r\nint wret;\r\nint level;\r\nint next_key_ret = 0;\r\nu64 last_ret = 0;\r\nu64 min_trans = 0;\r\nif (root->fs_info->extent_root == root) {\r\ngoto out;\r\n}\r\nif (!test_bit(BTRFS_ROOT_REF_COWS, &root->state))\r\ngoto out;\r\npath = btrfs_alloc_path();\r\nif (!path)\r\nreturn -ENOMEM;\r\nlevel = btrfs_header_level(root->node);\r\nif (level == 0)\r\ngoto out;\r\nif (root->defrag_progress.objectid == 0) {\r\nstruct extent_buffer *root_node;\r\nu32 nritems;\r\nroot_node = btrfs_lock_root_node(root);\r\nbtrfs_set_lock_blocking(root_node);\r\nnritems = btrfs_header_nritems(root_node);\r\nroot->defrag_max.objectid = 0;\r\nbtrfs_node_key_to_cpu(root_node, &root->defrag_max,\r\nnritems - 1);\r\nbtrfs_tree_unlock(root_node);\r\nfree_extent_buffer(root_node);\r\nmemset(&key, 0, sizeof(key));\r\n} else {\r\nmemcpy(&key, &root->defrag_progress, sizeof(key));\r\n}\r\npath->keep_locks = 1;\r\nret = btrfs_search_forward(root, &key, path, min_trans);\r\nif (ret < 0)\r\ngoto out;\r\nif (ret > 0) {\r\nret = 0;\r\ngoto out;\r\n}\r\nbtrfs_release_path(path);\r\npath->lowest_level = 1;\r\nwret = btrfs_search_slot(trans, root, &key, path, 0, 1);\r\nif (wret < 0) {\r\nret = wret;\r\ngoto out;\r\n}\r\nif (!path->nodes[1]) {\r\nret = 0;\r\ngoto out;\r\n}\r\nBUG_ON(path->locks[1] == 0);\r\nret = btrfs_realloc_node(trans, root,\r\npath->nodes[1], 0,\r\n&last_ret,\r\n&root->defrag_progress);\r\nif (ret) {\r\nWARN_ON(ret == -EAGAIN);\r\ngoto out;\r\n}\r\npath->slots[1] = btrfs_header_nritems(path->nodes[1]);\r\nnext_key_ret = btrfs_find_next_key(root, path, &key, 1,\r\nmin_trans);\r\nif (next_key_ret == 0) {\r\nmemcpy(&root->defrag_progress, &key, sizeof(key));\r\nret = -EAGAIN;\r\n}\r\nout:\r\nbtrfs_free_path(path);\r\nif (ret == -EAGAIN) {\r\nif (root->defrag_max.objectid > root->defrag_progress.objectid)\r\ngoto done;\r\nif (root->defrag_max.type > root->defrag_progress.type)\r\ngoto done;\r\nif (root->defrag_max.offset > root->defrag_progress.offset)\r\ngoto done;\r\nret = 0;\r\n}\r\ndone:\r\nif (ret != -EAGAIN) {\r\nmemset(&root->defrag_progress, 0,\r\nsizeof(root->defrag_progress));\r\nroot->defrag_trans_start = trans->transid;\r\n}\r\nreturn ret;\r\n}

static void firmware_load(const struct firmware *fw, void *context)\r\n{\r\nstruct spi_device *spi = (struct spi_device *)context;\r\nstruct fpga_data *data = spi_get_drvdata(spi);\r\nu8 *buffer;\r\nint ret;\r\nu8 txbuf[8];\r\nu8 rxbuf[8];\r\nint rx_len = 8;\r\nint i;\r\nu32 jedec_id;\r\nu32 status;\r\nif (fw == NULL) {\r\ndev_err(&spi->dev, "Cannot load firmware, aborting\n");\r\nreturn;\r\n}\r\nif (fw->size == 0) {\r\ndev_err(&spi->dev, "Error: Firmware size is 0!\n");\r\nreturn;\r\n}\r\ntxbuf[1] = 0x00;\r\ntxbuf[2] = 0x00;\r\ntxbuf[3] = 0x00;\r\ntxbuf[0] = FPGA_CMD_READ_ID;\r\nret = spi_write_then_read(spi, txbuf, 8, rxbuf, rx_len);\r\njedec_id = get_unaligned_be32(&rxbuf[4]);\r\ndev_dbg(&spi->dev, "FPGA JTAG ID=%08x\n", jedec_id);\r\nfor (i = 0; i < ARRAY_SIZE(ecp3_dev); i++) {\r\nif (jedec_id == ecp3_dev[i].jedec_id)\r\nbreak;\r\n}\r\nif (i == ARRAY_SIZE(ecp3_dev)) {\r\ndev_err(&spi->dev,\r\n"Error: No supported FPGA detected (JEDEC_ID=%08x)!\n",\r\njedec_id);\r\nreturn;\r\n}\r\ndev_info(&spi->dev, "FPGA %s detected\n", ecp3_dev[i].name);\r\ntxbuf[0] = FPGA_CMD_READ_STATUS;\r\nret = spi_write_then_read(spi, txbuf, 8, rxbuf, rx_len);\r\nstatus = get_unaligned_be32(&rxbuf[4]);\r\ndev_dbg(&spi->dev, "FPGA Status=%08x\n", status);\r\nbuffer = kzalloc(fw->size + 8, GFP_KERNEL);\r\nif (!buffer) {\r\ndev_err(&spi->dev, "Error: Can't allocate memory!\n");\r\nreturn;\r\n}\r\nbuffer[0] = FPGA_CMD_WRITE_INC;\r\nbuffer[1] = 0xff;\r\nbuffer[2] = 0xff;\r\nbuffer[3] = 0xff;\r\nmemcpy(buffer + 4, fw->data, fw->size);\r\ntxbuf[0] = FPGA_CMD_REFRESH;\r\nret = spi_write(spi, txbuf, 4);\r\ntxbuf[0] = FPGA_CMD_WRITE_EN;\r\nret = spi_write(spi, txbuf, 4);\r\ntxbuf[0] = FPGA_CMD_CLEAR;\r\nret = spi_write(spi, txbuf, 4);\r\nfor (i = 0; i < FPGA_CLEAR_LOOP_COUNT; i++) {\r\ntxbuf[0] = FPGA_CMD_READ_STATUS;\r\nret = spi_write_then_read(spi, txbuf, 8, rxbuf, rx_len);\r\nstatus = get_unaligned_be32(&rxbuf[4]);\r\nif (status == FPGA_STATUS_CLEARED)\r\nbreak;\r\nmsleep(FPGA_CLEAR_MSLEEP);\r\n}\r\nif (i == FPGA_CLEAR_LOOP_COUNT) {\r\ndev_err(&spi->dev,\r\n"Error: Timeout waiting for FPGA to clear (status=%08x)!\n",\r\nstatus);\r\nkfree(buffer);\r\nreturn;\r\n}\r\ndev_info(&spi->dev, "Configuring the FPGA...\n");\r\nret = spi_write(spi, buffer, fw->size + 8);\r\ntxbuf[0] = FPGA_CMD_WRITE_DIS;\r\nret = spi_write(spi, txbuf, 4);\r\ntxbuf[0] = FPGA_CMD_READ_STATUS;\r\nret = spi_write_then_read(spi, txbuf, 8, rxbuf, rx_len);\r\nstatus = get_unaligned_be32(&rxbuf[4]);\r\ndev_dbg(&spi->dev, "FPGA Status=%08x\n", status);\r\nif (status & FPGA_STATUS_DONE)\r\ndev_info(&spi->dev, "FPGA successfully configured!\n");\r\nelse\r\ndev_info(&spi->dev, "FPGA not configured (DONE not set)\n");\r\nrelease_firmware(fw);\r\nkfree(buffer);\r\ncomplete(&data->fw_loaded);\r\n}\r\nstatic int lattice_ecp3_probe(struct spi_device *spi)\r\n{\r\nstruct fpga_data *data;\r\nint err;\r\ndata = devm_kzalloc(&spi->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data) {\r\ndev_err(&spi->dev, "Memory allocation for fpga_data failed\n");\r\nreturn -ENOMEM;\r\n}\r\nspi_set_drvdata(spi, data);\r\ninit_completion(&data->fw_loaded);\r\nerr = request_firmware_nowait(THIS_MODULE, FW_ACTION_HOTPLUG,\r\nFIRMWARE_NAME, &spi->dev,\r\nGFP_KERNEL, spi, firmware_load);\r\nif (err) {\r\ndev_err(&spi->dev, "Firmware loading failed with %d!\n", err);\r\nreturn err;\r\n}\r\ndev_info(&spi->dev, "FPGA bitstream configuration driver registered\n");\r\nreturn 0;\r\n}\r\nstatic int lattice_ecp3_remove(struct spi_device *spi)\r\n{\r\nstruct fpga_data *data = spi_get_drvdata(spi);\r\nwait_for_completion(&data->fw_loaded);\r\nreturn 0;\r\n}

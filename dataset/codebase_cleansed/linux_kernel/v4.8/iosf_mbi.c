static inline u32 iosf_mbi_form_mcr(u8 op, u8 port, u8 offset)\r\n{\r\nreturn (op << 24) | (port << 16) | (offset << 8) | MBI_ENABLE;\r\n}\r\nstatic int iosf_mbi_pci_read_mdr(u32 mcrx, u32 mcr, u32 *mdr)\r\n{\r\nint result;\r\nif (!mbi_pdev)\r\nreturn -ENODEV;\r\nif (mcrx) {\r\nresult = pci_write_config_dword(mbi_pdev, MBI_MCRX_OFFSET,\r\nmcrx);\r\nif (result < 0)\r\ngoto fail_read;\r\n}\r\nresult = pci_write_config_dword(mbi_pdev, MBI_MCR_OFFSET, mcr);\r\nif (result < 0)\r\ngoto fail_read;\r\nresult = pci_read_config_dword(mbi_pdev, MBI_MDR_OFFSET, mdr);\r\nif (result < 0)\r\ngoto fail_read;\r\nreturn 0;\r\nfail_read:\r\ndev_err(&mbi_pdev->dev, "PCI config access failed with %d\n", result);\r\nreturn result;\r\n}\r\nstatic int iosf_mbi_pci_write_mdr(u32 mcrx, u32 mcr, u32 mdr)\r\n{\r\nint result;\r\nif (!mbi_pdev)\r\nreturn -ENODEV;\r\nresult = pci_write_config_dword(mbi_pdev, MBI_MDR_OFFSET, mdr);\r\nif (result < 0)\r\ngoto fail_write;\r\nif (mcrx) {\r\nresult = pci_write_config_dword(mbi_pdev, MBI_MCRX_OFFSET,\r\nmcrx);\r\nif (result < 0)\r\ngoto fail_write;\r\n}\r\nresult = pci_write_config_dword(mbi_pdev, MBI_MCR_OFFSET, mcr);\r\nif (result < 0)\r\ngoto fail_write;\r\nreturn 0;\r\nfail_write:\r\ndev_err(&mbi_pdev->dev, "PCI config access failed with %d\n", result);\r\nreturn result;\r\n}\r\nint iosf_mbi_read(u8 port, u8 opcode, u32 offset, u32 *mdr)\r\n{\r\nu32 mcr, mcrx;\r\nunsigned long flags;\r\nint ret;\r\nif (port == BT_MBI_UNIT_GFX) {\r\nWARN_ON(1);\r\nreturn -EPERM;\r\n}\r\nmcr = iosf_mbi_form_mcr(opcode, port, offset & MBI_MASK_LO);\r\nmcrx = offset & MBI_MASK_HI;\r\nspin_lock_irqsave(&iosf_mbi_lock, flags);\r\nret = iosf_mbi_pci_read_mdr(mcrx, mcr, mdr);\r\nspin_unlock_irqrestore(&iosf_mbi_lock, flags);\r\nreturn ret;\r\n}\r\nint iosf_mbi_write(u8 port, u8 opcode, u32 offset, u32 mdr)\r\n{\r\nu32 mcr, mcrx;\r\nunsigned long flags;\r\nint ret;\r\nif (port == BT_MBI_UNIT_GFX) {\r\nWARN_ON(1);\r\nreturn -EPERM;\r\n}\r\nmcr = iosf_mbi_form_mcr(opcode, port, offset & MBI_MASK_LO);\r\nmcrx = offset & MBI_MASK_HI;\r\nspin_lock_irqsave(&iosf_mbi_lock, flags);\r\nret = iosf_mbi_pci_write_mdr(mcrx, mcr, mdr);\r\nspin_unlock_irqrestore(&iosf_mbi_lock, flags);\r\nreturn ret;\r\n}\r\nint iosf_mbi_modify(u8 port, u8 opcode, u32 offset, u32 mdr, u32 mask)\r\n{\r\nu32 mcr, mcrx;\r\nu32 value;\r\nunsigned long flags;\r\nint ret;\r\nif (port == BT_MBI_UNIT_GFX) {\r\nWARN_ON(1);\r\nreturn -EPERM;\r\n}\r\nmcr = iosf_mbi_form_mcr(opcode, port, offset & MBI_MASK_LO);\r\nmcrx = offset & MBI_MASK_HI;\r\nspin_lock_irqsave(&iosf_mbi_lock, flags);\r\nret = iosf_mbi_pci_read_mdr(mcrx, mcr & MBI_RD_MASK, &value);\r\nif (ret < 0) {\r\nspin_unlock_irqrestore(&iosf_mbi_lock, flags);\r\nreturn ret;\r\n}\r\nvalue &= ~mask;\r\nmdr &= mask;\r\nvalue |= mdr;\r\nret = iosf_mbi_pci_write_mdr(mcrx, mcr | MBI_WR_MASK, value);\r\nspin_unlock_irqrestore(&iosf_mbi_lock, flags);\r\nreturn ret;\r\n}\r\nbool iosf_mbi_available(void)\r\n{\r\nreturn mbi_pdev;\r\n}\r\nstatic int mcr_get(void *data, u64 *val)\r\n{\r\n*val = *(u32 *)data;\r\nreturn 0;\r\n}\r\nstatic int mcr_set(void *data, u64 val)\r\n{\r\nu8 command = ((u32)val & 0xFF000000) >> 24,\r\nport = ((u32)val & 0x00FF0000) >> 16,\r\noffset = ((u32)val & 0x0000FF00) >> 8;\r\nint err;\r\n*(u32 *)data = val;\r\nif (!capable(CAP_SYS_RAWIO))\r\nreturn -EACCES;\r\nif (command & 1u)\r\nerr = iosf_mbi_write(port,\r\ncommand,\r\ndbg_mcrx | offset,\r\ndbg_mdr);\r\nelse\r\nerr = iosf_mbi_read(port,\r\ncommand,\r\ndbg_mcrx | offset,\r\n&dbg_mdr);\r\nreturn err;\r\n}\r\nstatic void iosf_sideband_debug_init(void)\r\n{\r\nstruct dentry *d;\r\niosf_dbg = debugfs_create_dir("iosf_sb", NULL);\r\nif (IS_ERR_OR_NULL(iosf_dbg))\r\nreturn;\r\nd = debugfs_create_x32("mdr", 0660, iosf_dbg, &dbg_mdr);\r\nif (!d)\r\ngoto cleanup;\r\nd = debugfs_create_x32("mcrx", 0660, iosf_dbg, &dbg_mcrx);\r\nif (!d)\r\ngoto cleanup;\r\nd = debugfs_create_file("mcr", 0660, iosf_dbg, &dbg_mcr, &iosf_mcr_fops);\r\nif (!d)\r\ngoto cleanup;\r\nreturn;\r\ncleanup:\r\ndebugfs_remove_recursive(d);\r\n}\r\nstatic void iosf_debugfs_init(void)\r\n{\r\niosf_sideband_debug_init();\r\n}\r\nstatic void iosf_debugfs_remove(void)\r\n{\r\ndebugfs_remove_recursive(iosf_dbg);\r\n}\r\nstatic inline void iosf_debugfs_init(void) { }\r\nstatic inline void iosf_debugfs_remove(void) { }\r\nstatic int iosf_mbi_probe(struct pci_dev *pdev,\r\nconst struct pci_device_id *unused)\r\n{\r\nint ret;\r\nret = pci_enable_device(pdev);\r\nif (ret < 0) {\r\ndev_err(&pdev->dev, "error: could not enable device\n");\r\nreturn ret;\r\n}\r\nmbi_pdev = pci_dev_get(pdev);\r\nreturn 0;\r\n}\r\nstatic int __init iosf_mbi_init(void)\r\n{\r\niosf_debugfs_init();\r\nreturn pci_register_driver(&iosf_mbi_pci_driver);\r\n}\r\nstatic void __exit iosf_mbi_exit(void)\r\n{\r\niosf_debugfs_remove();\r\npci_unregister_driver(&iosf_mbi_pci_driver);\r\npci_dev_put(mbi_pdev);\r\nmbi_pdev = NULL;\r\n}

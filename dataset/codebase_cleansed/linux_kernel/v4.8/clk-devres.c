static void devm_clk_release(struct device *dev, void *res)\r\n{\r\nclk_put(*(struct clk **)res);\r\n}\r\nstruct clk *devm_clk_get(struct device *dev, const char *id)\r\n{\r\nstruct clk **ptr, *clk;\r\nptr = devres_alloc(devm_clk_release, sizeof(*ptr), GFP_KERNEL);\r\nif (!ptr)\r\nreturn ERR_PTR(-ENOMEM);\r\nclk = clk_get(dev, id);\r\nif (!IS_ERR(clk)) {\r\n*ptr = clk;\r\ndevres_add(dev, ptr);\r\n} else {\r\ndevres_free(ptr);\r\n}\r\nreturn clk;\r\n}\r\nstatic int devm_clk_match(struct device *dev, void *res, void *data)\r\n{\r\nstruct clk **c = res;\r\nif (!c || !*c) {\r\nWARN_ON(!c || !*c);\r\nreturn 0;\r\n}\r\nreturn *c == data;\r\n}\r\nvoid devm_clk_put(struct device *dev, struct clk *clk)\r\n{\r\nint ret;\r\nret = devres_release(dev, devm_clk_release, devm_clk_match, clk);\r\nWARN_ON(ret);\r\n}

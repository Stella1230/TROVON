static int rng_dev_open (struct inode *inode, struct file *filp)\r\n{\r\nif ((filp->f_mode & FMODE_READ) == 0)\r\nreturn -EINVAL;\r\nif ((filp->f_mode & FMODE_WRITE) != 0)\r\nreturn -EINVAL;\r\nreturn 0;\r\n}\r\nstatic ssize_t rng_dev_read (struct file *filp, char __user *buf, size_t size,\r\nloff_t *offp)\r\n{\r\nu32 data;\r\nint n, ret = 0, have_data;\r\nwhile (size) {\r\nn = os_read_file(random_fd, &data, sizeof(data));\r\nif (n > 0) {\r\nhave_data = n;\r\nwhile (have_data && size) {\r\nif (put_user((u8) data, buf++)) {\r\nret = ret ? : -EFAULT;\r\nbreak;\r\n}\r\nsize--;\r\nret++;\r\nhave_data--;\r\ndata >>= 8;\r\n}\r\n}\r\nelse if (n == -EAGAIN) {\r\nDECLARE_WAITQUEUE(wait, current);\r\nif (filp->f_flags & O_NONBLOCK)\r\nreturn ret ? : -EAGAIN;\r\natomic_inc(&host_sleep_count);\r\nreactivate_fd(random_fd, RANDOM_IRQ);\r\nadd_sigio_fd(random_fd);\r\nadd_wait_queue(&host_read_wait, &wait);\r\nset_task_state(current, TASK_INTERRUPTIBLE);\r\nschedule();\r\nremove_wait_queue(&host_read_wait, &wait);\r\nif (atomic_dec_and_test(&host_sleep_count)) {\r\nignore_sigio_fd(random_fd);\r\ndeactivate_fd(random_fd, RANDOM_IRQ);\r\n}\r\n}\r\nelse\r\nreturn n;\r\nif (signal_pending (current))\r\nreturn ret ? : -ERESTARTSYS;\r\n}\r\nreturn ret;\r\n}\r\nstatic irqreturn_t random_interrupt(int irq, void *data)\r\n{\r\nwake_up(&host_read_wait);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int __init rng_init (void)\r\n{\r\nint err;\r\nerr = os_open_file("/dev/random", of_read(OPENFLAGS()), 0);\r\nif (err < 0)\r\ngoto out;\r\nrandom_fd = err;\r\nerr = um_request_irq(RANDOM_IRQ, random_fd, IRQ_READ, random_interrupt,\r\n0, "random", NULL);\r\nif (err)\r\ngoto err_out_cleanup_hw;\r\nsigio_broken(random_fd, 1);\r\nerr = misc_register (&rng_miscdev);\r\nif (err) {\r\nprintk (KERN_ERR RNG_MODULE_NAME ": misc device register "\r\n"failed\n");\r\ngoto err_out_cleanup_hw;\r\n}\r\nout:\r\nreturn err;\r\nerr_out_cleanup_hw:\r\nos_close_file(random_fd);\r\nrandom_fd = -1;\r\ngoto out;\r\n}\r\nstatic void __exit rng_cleanup (void)\r\n{\r\nos_close_file(random_fd);\r\nmisc_deregister (&rng_miscdev);\r\n}

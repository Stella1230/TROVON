static inline\r\nenum mdp4_frame_format mdp4_get_frame_format(struct drm_framebuffer *fb)\r\n{\r\nbool is_tile = false;\r\nif (fb->modifier[1] == DRM_FORMAT_MOD_SAMSUNG_64_32_TILE)\r\nis_tile = true;\r\nif (fb->pixel_format == DRM_FORMAT_NV12 && is_tile)\r\nreturn FRAME_TILE_YCBCR_420;\r\nreturn FRAME_LINEAR;\r\n}\r\nstatic struct mdp4_kms *get_kms(struct drm_plane *plane)\r\n{\r\nstruct msm_drm_private *priv = plane->dev->dev_private;\r\nreturn to_mdp4_kms(to_mdp_kms(priv->kms));\r\n}\r\nstatic void mdp4_plane_destroy(struct drm_plane *plane)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\ndrm_plane_helper_disable(plane);\r\ndrm_plane_cleanup(plane);\r\nkfree(mdp4_plane);\r\n}\r\nstatic void mdp4_plane_install_properties(struct drm_plane *plane,\r\nstruct drm_mode_object *obj)\r\n{\r\n}\r\nint mdp4_plane_set_property(struct drm_plane *plane,\r\nstruct drm_property *property, uint64_t val)\r\n{\r\nreturn -EINVAL;\r\n}\r\nstatic int mdp4_plane_prepare_fb(struct drm_plane *plane,\r\nconst struct drm_plane_state *new_state)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nstruct mdp4_kms *mdp4_kms = get_kms(plane);\r\nstruct drm_framebuffer *fb = new_state->fb;\r\nif (!fb)\r\nreturn 0;\r\nDBG("%s: prepare: FB[%u]", mdp4_plane->name, fb->base.id);\r\nreturn msm_framebuffer_prepare(fb, mdp4_kms->id);\r\n}\r\nstatic void mdp4_plane_cleanup_fb(struct drm_plane *plane,\r\nconst struct drm_plane_state *old_state)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nstruct mdp4_kms *mdp4_kms = get_kms(plane);\r\nstruct drm_framebuffer *fb = old_state->fb;\r\nif (!fb)\r\nreturn;\r\nDBG("%s: cleanup: FB[%u]", mdp4_plane->name, fb->base.id);\r\nmsm_framebuffer_cleanup(fb, mdp4_kms->id);\r\n}\r\nstatic int mdp4_plane_atomic_check(struct drm_plane *plane,\r\nstruct drm_plane_state *state)\r\n{\r\nreturn 0;\r\n}\r\nstatic void mdp4_plane_atomic_update(struct drm_plane *plane,\r\nstruct drm_plane_state *old_state)\r\n{\r\nstruct drm_plane_state *state = plane->state;\r\nint ret;\r\nret = mdp4_plane_mode_set(plane,\r\nstate->crtc, state->fb,\r\nstate->crtc_x, state->crtc_y,\r\nstate->crtc_w, state->crtc_h,\r\nstate->src_x, state->src_y,\r\nstate->src_w, state->src_h);\r\nWARN_ON(ret < 0);\r\n}\r\nstatic void mdp4_plane_set_scanout(struct drm_plane *plane,\r\nstruct drm_framebuffer *fb)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nstruct mdp4_kms *mdp4_kms = get_kms(plane);\r\nenum mdp4_pipe pipe = mdp4_plane->pipe;\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_STRIDE_A(pipe),\r\nMDP4_PIPE_SRC_STRIDE_A_P0(fb->pitches[0]) |\r\nMDP4_PIPE_SRC_STRIDE_A_P1(fb->pitches[1]));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_STRIDE_B(pipe),\r\nMDP4_PIPE_SRC_STRIDE_B_P2(fb->pitches[2]) |\r\nMDP4_PIPE_SRC_STRIDE_B_P3(fb->pitches[3]));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP0_BASE(pipe),\r\nmsm_framebuffer_iova(fb, mdp4_kms->id, 0));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP1_BASE(pipe),\r\nmsm_framebuffer_iova(fb, mdp4_kms->id, 1));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP2_BASE(pipe),\r\nmsm_framebuffer_iova(fb, mdp4_kms->id, 2));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRCP3_BASE(pipe),\r\nmsm_framebuffer_iova(fb, mdp4_kms->id, 3));\r\nplane->fb = fb;\r\n}\r\nstatic void mdp4_write_csc_config(struct mdp4_kms *mdp4_kms,\r\nenum mdp4_pipe pipe, struct csc_cfg *csc)\r\n{\r\nint i;\r\nfor (i = 0; i < ARRAY_SIZE(csc->matrix); i++) {\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_MV(pipe, i),\r\ncsc->matrix[i]);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(csc->post_bias) ; i++) {\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_PRE_BV(pipe, i),\r\ncsc->pre_bias[i]);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_POST_BV(pipe, i),\r\ncsc->post_bias[i]);\r\n}\r\nfor (i = 0; i < ARRAY_SIZE(csc->post_clamp) ; i++) {\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_PRE_LV(pipe, i),\r\ncsc->pre_clamp[i]);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_CSC_POST_LV(pipe, i),\r\ncsc->post_clamp[i]);\r\n}\r\n}\r\nstatic int mdp4_plane_mode_set(struct drm_plane *plane,\r\nstruct drm_crtc *crtc, struct drm_framebuffer *fb,\r\nint crtc_x, int crtc_y,\r\nunsigned int crtc_w, unsigned int crtc_h,\r\nuint32_t src_x, uint32_t src_y,\r\nuint32_t src_w, uint32_t src_h)\r\n{\r\nstruct drm_device *dev = plane->dev;\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nstruct mdp4_kms *mdp4_kms = get_kms(plane);\r\nenum mdp4_pipe pipe = mdp4_plane->pipe;\r\nconst struct mdp_format *format;\r\nuint32_t op_mode = 0;\r\nuint32_t phasex_step = MDP4_VG_PHASE_STEP_DEFAULT;\r\nuint32_t phasey_step = MDP4_VG_PHASE_STEP_DEFAULT;\r\nenum mdp4_frame_format frame_type;\r\nif (!(crtc && fb)) {\r\nDBG("%s: disabled!", mdp4_plane->name);\r\nreturn 0;\r\n}\r\nframe_type = mdp4_get_frame_format(fb);\r\nsrc_x = src_x >> 16;\r\nsrc_y = src_y >> 16;\r\nsrc_w = src_w >> 16;\r\nsrc_h = src_h >> 16;\r\nDBG("%s: FB[%u] %u,%u,%u,%u -> CRTC[%u] %d,%d,%u,%u", mdp4_plane->name,\r\nfb->base.id, src_x, src_y, src_w, src_h,\r\ncrtc->base.id, crtc_x, crtc_y, crtc_w, crtc_h);\r\nformat = to_mdp_format(msm_framebuffer_format(fb));\r\nif (src_w > (crtc_w * DOWN_SCALE_MAX)) {\r\ndev_err(dev->dev, "Width down scaling exceeds limits!\n");\r\nreturn -ERANGE;\r\n}\r\nif (src_h > (crtc_h * DOWN_SCALE_MAX)) {\r\ndev_err(dev->dev, "Height down scaling exceeds limits!\n");\r\nreturn -ERANGE;\r\n}\r\nif (crtc_w > (src_w * UP_SCALE_MAX)) {\r\ndev_err(dev->dev, "Width up scaling exceeds limits!\n");\r\nreturn -ERANGE;\r\n}\r\nif (crtc_h > (src_h * UP_SCALE_MAX)) {\r\ndev_err(dev->dev, "Height up scaling exceeds limits!\n");\r\nreturn -ERANGE;\r\n}\r\nif (src_w != crtc_w) {\r\nuint32_t sel_unit = SCALE_FIR;\r\nop_mode |= MDP4_PIPE_OP_MODE_SCALEX_EN;\r\nif (MDP_FORMAT_IS_YUV(format)) {\r\nif (crtc_w > src_w)\r\nsel_unit = SCALE_PIXEL_RPT;\r\nelse if (crtc_w <= (src_w / 4))\r\nsel_unit = SCALE_MN_PHASE;\r\nop_mode |= MDP4_PIPE_OP_MODE_SCALEX_UNIT_SEL(sel_unit);\r\nphasex_step = mult_frac(MDP4_VG_PHASE_STEP_DEFAULT,\r\nsrc_w, crtc_w);\r\n}\r\n}\r\nif (src_h != crtc_h) {\r\nuint32_t sel_unit = SCALE_FIR;\r\nop_mode |= MDP4_PIPE_OP_MODE_SCALEY_EN;\r\nif (MDP_FORMAT_IS_YUV(format)) {\r\nif (crtc_h > src_h)\r\nsel_unit = SCALE_PIXEL_RPT;\r\nelse if (crtc_h <= (src_h / 4))\r\nsel_unit = SCALE_MN_PHASE;\r\nop_mode |= MDP4_PIPE_OP_MODE_SCALEY_UNIT_SEL(sel_unit);\r\nphasey_step = mult_frac(MDP4_VG_PHASE_STEP_DEFAULT,\r\nsrc_h, crtc_h);\r\n}\r\n}\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_SIZE(pipe),\r\nMDP4_PIPE_SRC_SIZE_WIDTH(src_w) |\r\nMDP4_PIPE_SRC_SIZE_HEIGHT(src_h));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_XY(pipe),\r\nMDP4_PIPE_SRC_XY_X(src_x) |\r\nMDP4_PIPE_SRC_XY_Y(src_y));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_DST_SIZE(pipe),\r\nMDP4_PIPE_DST_SIZE_WIDTH(crtc_w) |\r\nMDP4_PIPE_DST_SIZE_HEIGHT(crtc_h));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_DST_XY(pipe),\r\nMDP4_PIPE_DST_XY_X(crtc_x) |\r\nMDP4_PIPE_DST_XY_Y(crtc_y));\r\nmdp4_plane_set_scanout(plane, fb);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_FORMAT(pipe),\r\nMDP4_PIPE_SRC_FORMAT_A_BPC(format->bpc_a) |\r\nMDP4_PIPE_SRC_FORMAT_R_BPC(format->bpc_r) |\r\nMDP4_PIPE_SRC_FORMAT_G_BPC(format->bpc_g) |\r\nMDP4_PIPE_SRC_FORMAT_B_BPC(format->bpc_b) |\r\nCOND(format->alpha_enable, MDP4_PIPE_SRC_FORMAT_ALPHA_ENABLE) |\r\nMDP4_PIPE_SRC_FORMAT_CPP(format->cpp - 1) |\r\nMDP4_PIPE_SRC_FORMAT_UNPACK_COUNT(format->unpack_count - 1) |\r\nMDP4_PIPE_SRC_FORMAT_FETCH_PLANES(format->fetch_type) |\r\nMDP4_PIPE_SRC_FORMAT_CHROMA_SAMP(format->chroma_sample) |\r\nMDP4_PIPE_SRC_FORMAT_FRAME_FORMAT(frame_type) |\r\nCOND(format->unpack_tight, MDP4_PIPE_SRC_FORMAT_UNPACK_TIGHT));\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SRC_UNPACK(pipe),\r\nMDP4_PIPE_SRC_UNPACK_ELEM0(format->unpack[0]) |\r\nMDP4_PIPE_SRC_UNPACK_ELEM1(format->unpack[1]) |\r\nMDP4_PIPE_SRC_UNPACK_ELEM2(format->unpack[2]) |\r\nMDP4_PIPE_SRC_UNPACK_ELEM3(format->unpack[3]));\r\nif (MDP_FORMAT_IS_YUV(format)) {\r\nstruct csc_cfg *csc = mdp_get_default_csc_cfg(CSC_YUV2RGB);\r\nop_mode |= MDP4_PIPE_OP_MODE_SRC_YCBCR;\r\nop_mode |= MDP4_PIPE_OP_MODE_CSC_EN;\r\nmdp4_write_csc_config(mdp4_kms, pipe, csc);\r\n}\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_OP_MODE(pipe), op_mode);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_PHASEX_STEP(pipe), phasex_step);\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_PHASEY_STEP(pipe), phasey_step);\r\nif (frame_type != FRAME_LINEAR)\r\nmdp4_write(mdp4_kms, REG_MDP4_PIPE_SSTILE_FRAME_SIZE(pipe),\r\nMDP4_PIPE_SSTILE_FRAME_SIZE_WIDTH(src_w) |\r\nMDP4_PIPE_SSTILE_FRAME_SIZE_HEIGHT(src_h));\r\nreturn 0;\r\n}\r\nenum mdp4_pipe mdp4_plane_pipe(struct drm_plane *plane)\r\n{\r\nstruct mdp4_plane *mdp4_plane = to_mdp4_plane(plane);\r\nreturn mdp4_plane->pipe;\r\n}\r\nstruct drm_plane *mdp4_plane_init(struct drm_device *dev,\r\nenum mdp4_pipe pipe_id, bool private_plane)\r\n{\r\nstruct drm_plane *plane = NULL;\r\nstruct mdp4_plane *mdp4_plane;\r\nint ret;\r\nenum drm_plane_type type;\r\nmdp4_plane = kzalloc(sizeof(*mdp4_plane), GFP_KERNEL);\r\nif (!mdp4_plane) {\r\nret = -ENOMEM;\r\ngoto fail;\r\n}\r\nplane = &mdp4_plane->base;\r\nmdp4_plane->pipe = pipe_id;\r\nmdp4_plane->name = pipe_names[pipe_id];\r\nmdp4_plane->caps = mdp4_pipe_caps(pipe_id);\r\nmdp4_plane->nformats = mdp_get_formats(mdp4_plane->formats,\r\nARRAY_SIZE(mdp4_plane->formats),\r\n!pipe_supports_yuv(mdp4_plane->caps));\r\ntype = private_plane ? DRM_PLANE_TYPE_PRIMARY : DRM_PLANE_TYPE_OVERLAY;\r\nret = drm_universal_plane_init(dev, plane, 0xff, &mdp4_plane_funcs,\r\nmdp4_plane->formats, mdp4_plane->nformats,\r\ntype, NULL);\r\nif (ret)\r\ngoto fail;\r\ndrm_plane_helper_add(plane, &mdp4_plane_helper_funcs);\r\nmdp4_plane_install_properties(plane, &plane->base);\r\nreturn plane;\r\nfail:\r\nif (plane)\r\nmdp4_plane_destroy(plane);\r\nreturn ERR_PTR(ret);\r\n}

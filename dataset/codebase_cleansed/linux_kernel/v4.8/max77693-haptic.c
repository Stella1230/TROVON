static int max77693_haptic_set_duty_cycle(struct max77693_haptic *haptic)\r\n{\r\nstruct pwm_args pargs;\r\nint delta;\r\nint error;\r\npwm_get_args(haptic->pwm_dev, &pargs);\r\ndelta = (pargs.period + haptic->pwm_duty) / 2;\r\nerror = pwm_config(haptic->pwm_dev, delta, pargs.period);\r\nif (error) {\r\ndev_err(haptic->dev, "failed to configure pwm: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77843_haptic_bias(struct max77693_haptic *haptic, bool on)\r\n{\r\nint error;\r\nif (haptic->dev_type != TYPE_MAX77843)\r\nreturn 0;\r\nerror = regmap_update_bits(haptic->regmap_haptic,\r\nMAX77843_SYS_REG_MAINCTRL1,\r\nMAX77843_MAINCTRL1_BIASEN_MASK,\r\non << MAINCTRL1_BIASEN_SHIFT);\r\nif (error) {\r\ndev_err(haptic->dev, "failed to %s bias: %d\n",\r\non ? "enable" : "disable", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77693_haptic_configure(struct max77693_haptic *haptic,\r\nbool enable)\r\n{\r\nunsigned int value, config_reg;\r\nint error;\r\nswitch (haptic->dev_type) {\r\ncase TYPE_MAX77693:\r\nvalue = ((haptic->type << MAX77693_CONFIG2_MODE) |\r\n(enable << MAX77693_CONFIG2_MEN) |\r\n(haptic->mode << MAX77693_CONFIG2_HTYP) |\r\nMAX77693_HAPTIC_PWM_DIVISOR_128);\r\nconfig_reg = MAX77693_HAPTIC_REG_CONFIG2;\r\nbreak;\r\ncase TYPE_MAX77843:\r\nvalue = (haptic->type << MCONFIG_MODE_SHIFT) |\r\n(enable << MCONFIG_MEN_SHIFT) |\r\nMAX77693_HAPTIC_PWM_DIVISOR_128;\r\nconfig_reg = MAX77843_HAP_REG_MCONFIG;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nerror = regmap_write(haptic->regmap_haptic,\r\nconfig_reg, value);\r\nif (error) {\r\ndev_err(haptic->dev,\r\n"failed to update haptic config: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic int max77693_haptic_lowsys(struct max77693_haptic *haptic, bool enable)\r\n{\r\nint error;\r\nif (haptic->dev_type != TYPE_MAX77693)\r\nreturn 0;\r\nerror = regmap_update_bits(haptic->regmap_pmic,\r\nMAX77693_PMIC_REG_LSCNFG,\r\nMAX77693_PMIC_LOW_SYS_MASK,\r\nenable << MAX77693_PMIC_LOW_SYS_SHIFT);\r\nif (error) {\r\ndev_err(haptic->dev, "cannot update pmic regmap: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic void max77693_haptic_enable(struct max77693_haptic *haptic)\r\n{\r\nint error;\r\nif (haptic->enabled)\r\nreturn;\r\nerror = pwm_enable(haptic->pwm_dev);\r\nif (error) {\r\ndev_err(haptic->dev,\r\n"failed to enable haptic pwm device: %d\n", error);\r\nreturn;\r\n}\r\nerror = max77693_haptic_lowsys(haptic, true);\r\nif (error)\r\ngoto err_enable_lowsys;\r\nerror = max77693_haptic_configure(haptic, true);\r\nif (error)\r\ngoto err_enable_config;\r\nhaptic->enabled = true;\r\nreturn;\r\nerr_enable_config:\r\nmax77693_haptic_lowsys(haptic, false);\r\nerr_enable_lowsys:\r\npwm_disable(haptic->pwm_dev);\r\n}\r\nstatic void max77693_haptic_disable(struct max77693_haptic *haptic)\r\n{\r\nint error;\r\nif (!haptic->enabled)\r\nreturn;\r\nerror = max77693_haptic_configure(haptic, false);\r\nif (error)\r\nreturn;\r\nerror = max77693_haptic_lowsys(haptic, false);\r\nif (error)\r\ngoto err_disable_lowsys;\r\npwm_disable(haptic->pwm_dev);\r\nhaptic->enabled = false;\r\nreturn;\r\nerr_disable_lowsys:\r\nmax77693_haptic_configure(haptic, true);\r\n}\r\nstatic void max77693_haptic_play_work(struct work_struct *work)\r\n{\r\nstruct max77693_haptic *haptic =\r\ncontainer_of(work, struct max77693_haptic, work);\r\nint error;\r\nerror = max77693_haptic_set_duty_cycle(haptic);\r\nif (error) {\r\ndev_err(haptic->dev, "failed to set duty cycle: %d\n", error);\r\nreturn;\r\n}\r\nif (haptic->magnitude)\r\nmax77693_haptic_enable(haptic);\r\nelse\r\nmax77693_haptic_disable(haptic);\r\n}\r\nstatic int max77693_haptic_play_effect(struct input_dev *dev, void *data,\r\nstruct ff_effect *effect)\r\n{\r\nstruct max77693_haptic *haptic = input_get_drvdata(dev);\r\nstruct pwm_args pargs;\r\nu64 period_mag_multi;\r\nhaptic->magnitude = effect->u.rumble.strong_magnitude;\r\nif (!haptic->magnitude)\r\nhaptic->magnitude = effect->u.rumble.weak_magnitude;\r\npwm_get_args(haptic->pwm_dev, &pargs);\r\nperiod_mag_multi = (u64)pargs.period * haptic->magnitude;\r\nhaptic->pwm_duty = (unsigned int)(period_mag_multi >>\r\nMAX_MAGNITUDE_SHIFT);\r\nschedule_work(&haptic->work);\r\nreturn 0;\r\n}\r\nstatic int max77693_haptic_open(struct input_dev *dev)\r\n{\r\nstruct max77693_haptic *haptic = input_get_drvdata(dev);\r\nint error;\r\nerror = max77843_haptic_bias(haptic, true);\r\nif (error)\r\nreturn error;\r\nerror = regulator_enable(haptic->motor_reg);\r\nif (error) {\r\ndev_err(haptic->dev,\r\n"failed to enable regulator: %d\n", error);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic void max77693_haptic_close(struct input_dev *dev)\r\n{\r\nstruct max77693_haptic *haptic = input_get_drvdata(dev);\r\nint error;\r\ncancel_work_sync(&haptic->work);\r\nmax77693_haptic_disable(haptic);\r\nerror = regulator_disable(haptic->motor_reg);\r\nif (error)\r\ndev_err(haptic->dev,\r\n"failed to disable regulator: %d\n", error);\r\nmax77843_haptic_bias(haptic, false);\r\n}\r\nstatic int max77693_haptic_probe(struct platform_device *pdev)\r\n{\r\nstruct max77693_dev *max77693 = dev_get_drvdata(pdev->dev.parent);\r\nstruct max77693_haptic *haptic;\r\nint error;\r\nhaptic = devm_kzalloc(&pdev->dev, sizeof(*haptic), GFP_KERNEL);\r\nif (!haptic)\r\nreturn -ENOMEM;\r\nhaptic->regmap_pmic = max77693->regmap;\r\nhaptic->dev = &pdev->dev;\r\nhaptic->type = MAX77693_HAPTIC_LRA;\r\nhaptic->mode = MAX77693_HAPTIC_EXTERNAL_MODE;\r\nhaptic->suspend_state = false;\r\nhaptic->dev_type = platform_get_device_id(pdev)->driver_data;\r\nswitch (haptic->dev_type) {\r\ncase TYPE_MAX77693:\r\nhaptic->regmap_haptic = max77693->regmap_haptic;\r\nbreak;\r\ncase TYPE_MAX77843:\r\nhaptic->regmap_haptic = max77693->regmap;\r\nbreak;\r\ndefault:\r\ndev_err(&pdev->dev, "unsupported device type: %u\n",\r\nhaptic->dev_type);\r\nreturn -EINVAL;\r\n}\r\nINIT_WORK(&haptic->work, max77693_haptic_play_work);\r\nhaptic->pwm_dev = devm_pwm_get(&pdev->dev, NULL);\r\nif (IS_ERR(haptic->pwm_dev)) {\r\ndev_err(&pdev->dev, "failed to get pwm device\n");\r\nreturn PTR_ERR(haptic->pwm_dev);\r\n}\r\npwm_apply_args(haptic->pwm_dev);\r\nhaptic->motor_reg = devm_regulator_get(&pdev->dev, "haptic");\r\nif (IS_ERR(haptic->motor_reg)) {\r\ndev_err(&pdev->dev, "failed to get regulator\n");\r\nreturn PTR_ERR(haptic->motor_reg);\r\n}\r\nhaptic->input_dev = devm_input_allocate_device(&pdev->dev);\r\nif (!haptic->input_dev) {\r\ndev_err(&pdev->dev, "failed to allocate input device\n");\r\nreturn -ENOMEM;\r\n}\r\nhaptic->input_dev->name = "max77693-haptic";\r\nhaptic->input_dev->id.version = 1;\r\nhaptic->input_dev->dev.parent = &pdev->dev;\r\nhaptic->input_dev->open = max77693_haptic_open;\r\nhaptic->input_dev->close = max77693_haptic_close;\r\ninput_set_drvdata(haptic->input_dev, haptic);\r\ninput_set_capability(haptic->input_dev, EV_FF, FF_RUMBLE);\r\nerror = input_ff_create_memless(haptic->input_dev, NULL,\r\nmax77693_haptic_play_effect);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to create force-feedback\n");\r\nreturn error;\r\n}\r\nerror = input_register_device(haptic->input_dev);\r\nif (error) {\r\ndev_err(&pdev->dev, "failed to register input device\n");\r\nreturn error;\r\n}\r\nplatform_set_drvdata(pdev, haptic);\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused max77693_haptic_suspend(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max77693_haptic *haptic = platform_get_drvdata(pdev);\r\nif (haptic->enabled) {\r\nmax77693_haptic_disable(haptic);\r\nhaptic->suspend_state = true;\r\n}\r\nreturn 0;\r\n}\r\nstatic int __maybe_unused max77693_haptic_resume(struct device *dev)\r\n{\r\nstruct platform_device *pdev = to_platform_device(dev);\r\nstruct max77693_haptic *haptic = platform_get_drvdata(pdev);\r\nif (haptic->suspend_state) {\r\nmax77693_haptic_enable(haptic);\r\nhaptic->suspend_state = false;\r\n}\r\nreturn 0;\r\n}

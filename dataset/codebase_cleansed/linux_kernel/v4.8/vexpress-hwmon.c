static ssize_t vexpress_hwmon_label_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nconst char *label = of_get_property(dev->of_node, "label", NULL);\r\nreturn snprintf(buffer, PAGE_SIZE, "%s\n", label);\r\n}\r\nstatic ssize_t vexpress_hwmon_u32_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nstruct vexpress_hwmon_data *data = dev_get_drvdata(dev);\r\nint err;\r\nu32 value;\r\nerr = regmap_read(data->reg, 0, &value);\r\nif (err)\r\nreturn err;\r\nreturn snprintf(buffer, PAGE_SIZE, "%u\n", value /\r\nto_sensor_dev_attr(dev_attr)->index);\r\n}\r\nstatic ssize_t vexpress_hwmon_u64_show(struct device *dev,\r\nstruct device_attribute *dev_attr, char *buffer)\r\n{\r\nstruct vexpress_hwmon_data *data = dev_get_drvdata(dev);\r\nint err;\r\nu32 value_hi, value_lo;\r\nerr = regmap_read(data->reg, 0, &value_lo);\r\nif (err)\r\nreturn err;\r\nerr = regmap_read(data->reg, 1, &value_hi);\r\nif (err)\r\nreturn err;\r\nreturn snprintf(buffer, PAGE_SIZE, "%llu\n",\r\ndiv_u64(((u64)value_hi << 32) | value_lo,\r\nto_sensor_dev_attr(dev_attr)->index));\r\n}\r\nstatic umode_t vexpress_hwmon_attr_is_visible(struct kobject *kobj,\r\nstruct attribute *attr, int index)\r\n{\r\nstruct device *dev = kobj_to_dev(kobj);\r\nstruct device_attribute *dev_attr = container_of(attr,\r\nstruct device_attribute, attr);\r\nif (dev_attr->show == vexpress_hwmon_label_show &&\r\n!of_get_property(dev->of_node, "label", NULL))\r\nreturn 0;\r\nreturn attr->mode;\r\n}\r\nstatic int vexpress_hwmon_probe(struct platform_device *pdev)\r\n{\r\nconst struct of_device_id *match;\r\nstruct vexpress_hwmon_data *data;\r\nconst struct vexpress_hwmon_type *type;\r\ndata = devm_kzalloc(&pdev->dev, sizeof(*data), GFP_KERNEL);\r\nif (!data)\r\nreturn -ENOMEM;\r\nplatform_set_drvdata(pdev, data);\r\nmatch = of_match_device(vexpress_hwmon_of_match, &pdev->dev);\r\nif (!match)\r\nreturn -ENODEV;\r\ntype = match->data;\r\ndata->reg = devm_regmap_init_vexpress_config(&pdev->dev);\r\nif (IS_ERR(data->reg))\r\nreturn PTR_ERR(data->reg);\r\ndata->hwmon_dev = devm_hwmon_device_register_with_groups(&pdev->dev,\r\ntype->name, data, type->attr_groups);\r\nreturn PTR_ERR_OR_ZERO(data->hwmon_dev);\r\n}

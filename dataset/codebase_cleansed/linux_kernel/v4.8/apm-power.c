static void system_power_event(unsigned int keycode)\r\n{\r\nswitch (keycode) {\r\ncase KEY_SUSPEND:\r\napm_queue_event(APM_USER_SUSPEND);\r\npr_info("Requesting system suspend...\n");\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic void apmpower_event(struct input_handle *handle, unsigned int type,\r\nunsigned int code, int value)\r\n{\r\nif (value != 1)\r\nreturn;\r\nswitch (type) {\r\ncase EV_PWR:\r\nsystem_power_event(code);\r\nbreak;\r\ndefault:\r\nbreak;\r\n}\r\n}\r\nstatic int apmpower_connect(struct input_handler *handler,\r\nstruct input_dev *dev,\r\nconst struct input_device_id *id)\r\n{\r\nstruct input_handle *handle;\r\nint error;\r\nhandle = kzalloc(sizeof(struct input_handle), GFP_KERNEL);\r\nif (!handle)\r\nreturn -ENOMEM;\r\nhandle->dev = dev;\r\nhandle->handler = handler;\r\nhandle->name = "apm-power";\r\nerror = input_register_handle(handle);\r\nif (error) {\r\npr_err("Failed to register input power handler, error %d\n",\r\nerror);\r\nkfree(handle);\r\nreturn error;\r\n}\r\nerror = input_open_device(handle);\r\nif (error) {\r\npr_err("Failed to open input power device, error %d\n", error);\r\ninput_unregister_handle(handle);\r\nkfree(handle);\r\nreturn error;\r\n}\r\nreturn 0;\r\n}\r\nstatic void apmpower_disconnect(struct input_handle *handle)\r\n{\r\ninput_close_device(handle);\r\ninput_unregister_handle(handle);\r\nkfree(handle);\r\n}\r\nstatic int __init apmpower_init(void)\r\n{\r\nreturn input_register_handler(&apmpower_handler);\r\n}\r\nstatic void __exit apmpower_exit(void)\r\n{\r\ninput_unregister_handler(&apmpower_handler);\r\n}

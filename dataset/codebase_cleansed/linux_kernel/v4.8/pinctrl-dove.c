static int dove_mpp_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nreturn default_mpp_ctrl_get(mpp_base, pid, config);\r\n}\r\nstatic int dove_mpp_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nreturn default_mpp_ctrl_set(mpp_base, pid, config);\r\n}\r\nstatic int dove_pmu_mpp_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nunsigned off = (pid / MVEBU_MPPS_PER_REG) * MVEBU_MPP_BITS;\r\nunsigned shift = (pid % MVEBU_MPPS_PER_REG) * MVEBU_MPP_BITS;\r\nunsigned long pmu = readl(mpp_base + PMU_MPP_GENERAL_CTRL);\r\nunsigned long func;\r\nif ((pmu & BIT(pid)) == 0)\r\nreturn default_mpp_ctrl_get(mpp_base, pid, config);\r\nfunc = readl(pmu_base + PMU_SIGNAL_SELECT_0 + off);\r\n*config = (func >> shift) & MVEBU_MPP_MASK;\r\n*config |= CONFIG_PMU;\r\nreturn 0;\r\n}\r\nstatic int dove_pmu_mpp_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nunsigned off = (pid / MVEBU_MPPS_PER_REG) * MVEBU_MPP_BITS;\r\nunsigned shift = (pid % MVEBU_MPPS_PER_REG) * MVEBU_MPP_BITS;\r\nunsigned long pmu = readl(mpp_base + PMU_MPP_GENERAL_CTRL);\r\nunsigned long func;\r\nif ((config & CONFIG_PMU) == 0) {\r\nwritel(pmu & ~BIT(pid), mpp_base + PMU_MPP_GENERAL_CTRL);\r\nreturn default_mpp_ctrl_set(mpp_base, pid, config);\r\n}\r\nwritel(pmu | BIT(pid), mpp_base + PMU_MPP_GENERAL_CTRL);\r\nfunc = readl(pmu_base + PMU_SIGNAL_SELECT_0 + off);\r\nfunc &= ~(MVEBU_MPP_MASK << shift);\r\nfunc |= (config & MVEBU_MPP_MASK) << shift;\r\nwritel(func, pmu_base + PMU_SIGNAL_SELECT_0 + off);\r\nreturn 0;\r\n}\r\nstatic int dove_mpp4_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nunsigned long mpp4 = readl(mpp4_base);\r\nunsigned long mask;\r\nswitch (pid) {\r\ncase 24:\r\nmask = CAM_GPIO_SEL;\r\nbreak;\r\ncase 40:\r\nmask = SD0_GPIO_SEL;\r\nbreak;\r\ncase 46:\r\nmask = SD1_GPIO_SEL;\r\nbreak;\r\ncase 58:\r\nmask = SPI_GPIO_SEL;\r\nbreak;\r\ncase 62:\r\nmask = UART1_GPIO_SEL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\n*config = ((mpp4 & mask) != 0);\r\nreturn 0;\r\n}\r\nstatic int dove_mpp4_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nunsigned long mpp4 = readl(mpp4_base);\r\nunsigned long mask;\r\nswitch (pid) {\r\ncase 24:\r\nmask = CAM_GPIO_SEL;\r\nbreak;\r\ncase 40:\r\nmask = SD0_GPIO_SEL;\r\nbreak;\r\ncase 46:\r\nmask = SD1_GPIO_SEL;\r\nbreak;\r\ncase 58:\r\nmask = SPI_GPIO_SEL;\r\nbreak;\r\ncase 62:\r\nmask = UART1_GPIO_SEL;\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nmpp4 &= ~mask;\r\nif (config)\r\nmpp4 |= mask;\r\nwritel(mpp4, mpp4_base);\r\nreturn 0;\r\n}\r\nstatic int dove_nand_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nunsigned int gmpp;\r\nregmap_read(gconfmap, MPP_GENERAL_CONFIG, &gmpp);\r\n*config = ((gmpp & NAND_GPIO_EN) != 0);\r\nreturn 0;\r\n}\r\nstatic int dove_nand_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nregmap_update_bits(gconfmap, MPP_GENERAL_CONFIG,\r\nNAND_GPIO_EN,\r\n(config) ? NAND_GPIO_EN : 0);\r\nreturn 0;\r\n}\r\nstatic int dove_audio0_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nunsigned long pmu = readl(mpp_base + PMU_MPP_GENERAL_CTRL);\r\n*config = ((pmu & AU0_AC97_SEL) != 0);\r\nreturn 0;\r\n}\r\nstatic int dove_audio0_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nunsigned long pmu = readl(mpp_base + PMU_MPP_GENERAL_CTRL);\r\npmu &= ~AU0_AC97_SEL;\r\nif (config)\r\npmu |= AU0_AC97_SEL;\r\nwritel(pmu, mpp_base + PMU_MPP_GENERAL_CTRL);\r\nreturn 0;\r\n}\r\nstatic int dove_audio1_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nunsigned int mpp4 = readl(mpp4_base);\r\nunsigned int sspc1;\r\nunsigned int gmpp;\r\nunsigned int gcfg2;\r\nregmap_read(gconfmap, SSP_CTRL_STATUS_1, &sspc1);\r\nregmap_read(gconfmap, MPP_GENERAL_CONFIG, &gmpp);\r\nregmap_read(gconfmap, GLOBAL_CONFIG_2, &gcfg2);\r\n*config = 0;\r\nif (mpp4 & AU1_GPIO_SEL)\r\n*config |= BIT(3);\r\nif (sspc1 & SSP_ON_AU1)\r\n*config |= BIT(2);\r\nif (gmpp & AU1_SPDIFO_GPIO_EN)\r\n*config |= BIT(1);\r\nif (gcfg2 & TWSI_OPTION3_GPIO)\r\n*config |= BIT(0);\r\nif ((*config & BIT(3)) == 0)\r\n*config &= ~(BIT(2) | BIT(0));\r\nif ((*config & BIT(1)) == 0)\r\n*config &= ~BIT(0);\r\nreturn 0;\r\n}\r\nstatic int dove_audio1_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nunsigned int mpp4 = readl(mpp4_base);\r\nmpp4 &= ~AU1_GPIO_SEL;\r\nif (config & BIT(3))\r\nmpp4 |= AU1_GPIO_SEL;\r\nwritel(mpp4, mpp4_base);\r\nregmap_update_bits(gconfmap, SSP_CTRL_STATUS_1,\r\nSSP_ON_AU1,\r\n(config & BIT(2)) ? SSP_ON_AU1 : 0);\r\nregmap_update_bits(gconfmap, MPP_GENERAL_CONFIG,\r\nAU1_SPDIFO_GPIO_EN,\r\n(config & BIT(1)) ? AU1_SPDIFO_GPIO_EN : 0);\r\nregmap_update_bits(gconfmap, GLOBAL_CONFIG_2,\r\nTWSI_OPTION3_GPIO,\r\n(config & BIT(0)) ? TWSI_OPTION3_GPIO : 0);\r\nreturn 0;\r\n}\r\nstatic int dove_audio1_ctrl_gpio_req(unsigned pid)\r\n{\r\nunsigned long config;\r\ndove_audio1_ctrl_get(pid, &config);\r\nswitch (config) {\r\ncase 0x02:\r\ncase 0x0e:\r\nif (pid >= 56)\r\nreturn 0;\r\nreturn -ENOTSUPP;\r\ncase 0x08:\r\ncase 0x0b:\r\nif (pid <= 55)\r\nreturn 0;\r\nreturn -ENOTSUPP;\r\ncase 0x0a:\r\nreturn 0;\r\n}\r\nreturn -ENOTSUPP;\r\n}\r\nstatic int dove_audio1_ctrl_gpio_dir(unsigned pid, bool input)\r\n{\r\nif (pid < 52 || pid > 57)\r\nreturn -ENOTSUPP;\r\nreturn 0;\r\n}\r\nstatic int dove_twsi_ctrl_get(unsigned pid, unsigned long *config)\r\n{\r\nunsigned int gcfg1;\r\nunsigned int gcfg2;\r\nregmap_read(gconfmap, GLOBAL_CONFIG_1, &gcfg1);\r\nregmap_read(gconfmap, GLOBAL_CONFIG_2, &gcfg2);\r\n*config = 0;\r\nif (gcfg1 & TWSI_ENABLE_OPTION1)\r\n*config = 1;\r\nelse if (gcfg2 & TWSI_ENABLE_OPTION2)\r\n*config = 2;\r\nelse if (gcfg2 & TWSI_ENABLE_OPTION3)\r\n*config = 3;\r\nreturn 0;\r\n}\r\nstatic int dove_twsi_ctrl_set(unsigned pid, unsigned long config)\r\n{\r\nunsigned int gcfg1 = 0;\r\nunsigned int gcfg2 = 0;\r\nswitch (config) {\r\ncase 1:\r\ngcfg1 = TWSI_ENABLE_OPTION1;\r\nbreak;\r\ncase 2:\r\ngcfg2 = TWSI_ENABLE_OPTION2;\r\nbreak;\r\ncase 3:\r\ngcfg2 = TWSI_ENABLE_OPTION3;\r\nbreak;\r\n}\r\nregmap_update_bits(gconfmap, GLOBAL_CONFIG_1,\r\nTWSI_ENABLE_OPTION1,\r\ngcfg1);\r\nregmap_update_bits(gconfmap, GLOBAL_CONFIG_2,\r\nTWSI_ENABLE_OPTION2 | TWSI_ENABLE_OPTION3,\r\ngcfg2);\r\nreturn 0;\r\n}\r\nstatic int dove_pinctrl_probe(struct platform_device *pdev)\r\n{\r\nstruct resource *res, *mpp_res;\r\nstruct resource fb_res;\r\nconst struct of_device_id *match =\r\nof_match_device(dove_pinctrl_of_match, &pdev->dev);\r\npdev->dev.platform_data = (void *)match->data;\r\nclk = devm_clk_get(&pdev->dev, NULL);\r\nif (IS_ERR(clk)) {\r\ndev_err(&pdev->dev, "Unable to get pdma clock");\r\nreturn PTR_ERR(clk);\r\n}\r\nclk_prepare_enable(clk);\r\nmpp_res = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nmpp_base = devm_ioremap_resource(&pdev->dev, mpp_res);\r\nif (IS_ERR(mpp_base))\r\nreturn PTR_ERR(mpp_base);\r\nmemcpy(&fb_res, mpp_res, sizeof(struct resource));\r\nfb_res.start = 0;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 1);\r\nif (!res) {\r\ndev_warn(&pdev->dev, "falling back to hardcoded MPP4 resource\n");\r\nadjust_resource(&fb_res,\r\n(mpp_res->start & INT_REGS_MASK) + MPP4_REGS_OFFS, 0x4);\r\nres = &fb_res;\r\n}\r\nmpp4_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(mpp4_base))\r\nreturn PTR_ERR(mpp4_base);\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 2);\r\nif (!res) {\r\ndev_warn(&pdev->dev, "falling back to hardcoded PMU resource\n");\r\nadjust_resource(&fb_res,\r\n(mpp_res->start & INT_REGS_MASK) + PMU_REGS_OFFS, 0x8);\r\nres = &fb_res;\r\n}\r\npmu_base = devm_ioremap_resource(&pdev->dev, res);\r\nif (IS_ERR(pmu_base))\r\nreturn PTR_ERR(pmu_base);\r\ngconfmap = syscon_regmap_lookup_by_compatible("marvell,dove-global-config");\r\nif (IS_ERR(gconfmap)) {\r\nvoid __iomem *gc_base;\r\ndev_warn(&pdev->dev, "falling back to hardcoded global registers\n");\r\nadjust_resource(&fb_res,\r\n(mpp_res->start & INT_REGS_MASK) + GC_REGS_OFFS, 0x14);\r\ngc_base = devm_ioremap_resource(&pdev->dev, &fb_res);\r\nif (IS_ERR(gc_base))\r\nreturn PTR_ERR(gc_base);\r\ngconfmap = devm_regmap_init_mmio(&pdev->dev,\r\ngc_base, &gc_regmap_config);\r\nif (IS_ERR(gconfmap))\r\nreturn PTR_ERR(gconfmap);\r\n}\r\nif (fb_res.start)\r\ndev_warn(&pdev->dev, FW_BUG "Missing pinctrl regs in DTB. Please update your firmware.\n");\r\nreturn mvebu_pinctrl_probe(pdev);\r\n}\r\nstatic int dove_pinctrl_remove(struct platform_device *pdev)\r\n{\r\nif (!IS_ERR(clk))\r\nclk_disable_unprepare(clk);\r\nreturn 0;\r\n}

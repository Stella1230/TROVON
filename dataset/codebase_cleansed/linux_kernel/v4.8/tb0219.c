static inline char get_led(void)\r\n{\r\nreturn (char)tb0219_read(TB0219_LED);\r\n}\r\nstatic inline char get_gpio_input_pin(unsigned int pin)\r\n{\r\nuint16_t values;\r\nvalues = tb0219_read(TB0219_GPIO_INPUT);\r\nif (values & (1 << pin))\r\nreturn '1';\r\nreturn '0';\r\n}\r\nstatic inline char get_gpio_output_pin(unsigned int pin)\r\n{\r\nuint16_t values;\r\nvalues = tb0219_read(TB0219_GPIO_OUTPUT);\r\nif (values & (1 << pin))\r\nreturn '1';\r\nreturn '0';\r\n}\r\nstatic inline char get_dip_switch(unsigned int pin)\r\n{\r\nuint16_t values;\r\nvalues = tb0219_read(TB0219_DIP_SWITCH);\r\nif (values & (1 << pin))\r\nreturn '1';\r\nreturn '0';\r\n}\r\nstatic inline int set_led(char command)\r\n{\r\ntb0219_write(TB0219_LED, command);\r\nreturn 0;\r\n}\r\nstatic inline int set_gpio_output_pin(unsigned int pin, char command)\r\n{\r\nunsigned long flags;\r\nuint16_t value;\r\nif (command != '0' && command != '1')\r\nreturn -EINVAL;\r\nspin_lock_irqsave(&tb0219_lock, flags);\r\nvalue = tb0219_read(TB0219_GPIO_OUTPUT);\r\nif (command == '0')\r\nvalue &= ~(1 << pin);\r\nelse\r\nvalue |= 1 << pin;\r\ntb0219_write(TB0219_GPIO_OUTPUT, value);\r\nspin_unlock_irqrestore(&tb0219_lock, flags);\r\nreturn 0;\r\n}\r\nstatic ssize_t tanbac_tb0219_read(struct file *file, char __user *buf, size_t len,\r\nloff_t *ppos)\r\n{\r\nunsigned int minor;\r\nchar value;\r\nminor = iminor(file_inode(file));\r\nswitch (minor) {\r\ncase 0:\r\nvalue = get_led();\r\nbreak;\r\ncase 16 ... 23:\r\nvalue = get_gpio_input_pin(minor - 16);\r\nbreak;\r\ncase 32 ... 39:\r\nvalue = get_gpio_output_pin(minor - 32);\r\nbreak;\r\ncase 48 ... 55:\r\nvalue = get_dip_switch(minor - 48);\r\nbreak;\r\ndefault:\r\nreturn -EBADF;\r\n}\r\nif (len <= 0)\r\nreturn -EFAULT;\r\nif (put_user(value, buf))\r\nreturn -EFAULT;\r\nreturn 1;\r\n}\r\nstatic ssize_t tanbac_tb0219_write(struct file *file, const char __user *data,\r\nsize_t len, loff_t *ppos)\r\n{\r\nunsigned int minor;\r\ntb0219_type_t type;\r\nsize_t i;\r\nint retval = 0;\r\nchar c;\r\nminor = iminor(file_inode(file));\r\nswitch (minor) {\r\ncase 0:\r\ntype = TYPE_LED;\r\nbreak;\r\ncase 32 ... 39:\r\ntype = TYPE_GPIO_OUTPUT;\r\nbreak;\r\ndefault:\r\nreturn -EBADF;\r\n}\r\nfor (i = 0; i < len; i++) {\r\nif (get_user(c, data + i))\r\nreturn -EFAULT;\r\nswitch (type) {\r\ncase TYPE_LED:\r\nretval = set_led(c);\r\nbreak;\r\ncase TYPE_GPIO_OUTPUT:\r\nretval = set_gpio_output_pin(minor - 32, c);\r\nbreak;\r\n}\r\nif (retval < 0)\r\nbreak;\r\n}\r\nreturn i;\r\n}\r\nstatic int tanbac_tb0219_open(struct inode *inode, struct file *file)\r\n{\r\nunsigned int minor;\r\nminor = iminor(inode);\r\nswitch (minor) {\r\ncase 0:\r\ncase 16 ... 23:\r\ncase 32 ... 39:\r\ncase 48 ... 55:\r\nreturn nonseekable_open(inode, file);\r\ndefault:\r\nbreak;\r\n}\r\nreturn -EBADF;\r\n}\r\nstatic int tanbac_tb0219_release(struct inode *inode, struct file *file)\r\n{\r\nreturn 0;\r\n}\r\nstatic void tb0219_restart(char *command)\r\n{\r\ntb0219_write(TB0219_RESET, 0);\r\n}\r\nstatic void tb0219_pci_irq_init(void)\r\n{\r\nvr41xx_set_irq_trigger(TB0219_PCI_SLOT1_PIN, IRQ_TRIGGER_LEVEL, IRQ_SIGNAL_THROUGH);\r\nvr41xx_set_irq_level(TB0219_PCI_SLOT1_PIN, IRQ_LEVEL_LOW);\r\nvr41xx_set_irq_trigger(TB0219_PCI_SLOT2_PIN, IRQ_TRIGGER_LEVEL, IRQ_SIGNAL_THROUGH);\r\nvr41xx_set_irq_level(TB0219_PCI_SLOT2_PIN, IRQ_LEVEL_LOW);\r\nvr41xx_set_irq_trigger(TB0219_PCI_SLOT3_PIN, IRQ_TRIGGER_LEVEL, IRQ_SIGNAL_THROUGH);\r\nvr41xx_set_irq_level(TB0219_PCI_SLOT3_PIN, IRQ_LEVEL_LOW);\r\n}\r\nstatic int tb0219_probe(struct platform_device *dev)\r\n{\r\nint retval;\r\nif (request_mem_region(TB0219_START, TB0219_SIZE, "TB0219") == NULL)\r\nreturn -EBUSY;\r\ntb0219_base = ioremap(TB0219_START, TB0219_SIZE);\r\nif (tb0219_base == NULL) {\r\nrelease_mem_region(TB0219_START, TB0219_SIZE);\r\nreturn -ENOMEM;\r\n}\r\nretval = register_chrdev(major, "TB0219", &tb0219_fops);\r\nif (retval < 0) {\r\niounmap(tb0219_base);\r\ntb0219_base = NULL;\r\nrelease_mem_region(TB0219_START, TB0219_SIZE);\r\nreturn retval;\r\n}\r\nold_machine_restart = _machine_restart;\r\n_machine_restart = tb0219_restart;\r\ntb0219_pci_irq_init();\r\nif (major == 0) {\r\nmajor = retval;\r\nprintk(KERN_INFO "TB0219: major number %d\n", major);\r\n}\r\nreturn 0;\r\n}\r\nstatic int tb0219_remove(struct platform_device *dev)\r\n{\r\n_machine_restart = old_machine_restart;\r\niounmap(tb0219_base);\r\ntb0219_base = NULL;\r\nrelease_mem_region(TB0219_START, TB0219_SIZE);\r\nreturn 0;\r\n}\r\nstatic int __init tanbac_tb0219_init(void)\r\n{\r\nint retval;\r\ntb0219_platform_device = platform_device_alloc("TB0219", -1);\r\nif (!tb0219_platform_device)\r\nreturn -ENOMEM;\r\nretval = platform_device_add(tb0219_platform_device);\r\nif (retval < 0) {\r\nplatform_device_put(tb0219_platform_device);\r\nreturn retval;\r\n}\r\nretval = platform_driver_register(&tb0219_device_driver);\r\nif (retval < 0)\r\nplatform_device_unregister(tb0219_platform_device);\r\nreturn retval;\r\n}\r\nstatic void __exit tanbac_tb0219_exit(void)\r\n{\r\nplatform_driver_unregister(&tb0219_device_driver);\r\nplatform_device_unregister(tb0219_platform_device);\r\n}

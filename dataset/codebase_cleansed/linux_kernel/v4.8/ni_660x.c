static void ni_660x_write(struct comedi_device *dev, unsigned int chip,\r\nunsigned int bits, unsigned int reg)\r\n{\r\nunsigned int addr = (chip * NI660X_CHIP_OFFSET) +\r\nni_660x_reg_data[reg].offset;\r\nif (ni_660x_reg_data[reg].size == 2)\r\nwritew(bits, dev->mmio + addr);\r\nelse\r\nwritel(bits, dev->mmio + addr);\r\n}\r\nstatic unsigned int ni_660x_read(struct comedi_device *dev,\r\nunsigned int chip, unsigned int reg)\r\n{\r\nunsigned int addr = (chip * NI660X_CHIP_OFFSET) +\r\nni_660x_reg_data[reg].offset;\r\nif (ni_660x_reg_data[reg].size == 2)\r\nreturn readw(dev->mmio + addr);\r\nreturn readl(dev->mmio + addr);\r\n}\r\nstatic void ni_660x_gpct_write(struct ni_gpct *counter, unsigned int bits,\r\nenum ni_gpct_register reg)\r\n{\r\nstruct comedi_device *dev = counter->counter_dev->dev;\r\nni_660x_write(dev, counter->chip_index, bits, reg);\r\n}\r\nstatic unsigned int ni_660x_gpct_read(struct ni_gpct *counter,\r\nenum ni_gpct_register reg)\r\n{\r\nstruct comedi_device *dev = counter->counter_dev->dev;\r\nreturn ni_660x_read(dev, counter->chip_index, reg);\r\n}\r\nstatic inline void ni_660x_set_dma_channel(struct comedi_device *dev,\r\nunsigned int mite_channel,\r\nstruct ni_gpct *counter)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned int chip = counter->chip_index;\r\ndevpriv->dma_cfg[chip] &= ~NI660X_DMA_CFG_SEL_MASK(mite_channel);\r\ndevpriv->dma_cfg[chip] |= NI660X_DMA_CFG_SEL(mite_channel,\r\ncounter->counter_index);\r\nni_660x_write(dev, chip, devpriv->dma_cfg[chip] |\r\nNI660X_DMA_CFG_RESET(mite_channel),\r\nNI660X_DMA_CFG);\r\nmmiowb();\r\n}\r\nstatic inline void ni_660x_unset_dma_channel(struct comedi_device *dev,\r\nunsigned int mite_channel,\r\nstruct ni_gpct *counter)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned int chip = counter->chip_index;\r\ndevpriv->dma_cfg[chip] &= ~NI660X_DMA_CFG_SEL_MASK(mite_channel);\r\ndevpriv->dma_cfg[chip] |= NI660X_DMA_CFG_SEL_NONE(mite_channel);\r\nni_660x_write(dev, chip, devpriv->dma_cfg[chip], NI660X_DMA_CFG);\r\nmmiowb();\r\n}\r\nstatic int ni_660x_request_mite_channel(struct comedi_device *dev,\r\nstruct ni_gpct *counter,\r\nenum comedi_io_direction direction)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nstruct mite_ring *ring;\r\nstruct mite_channel *mite_chan;\r\nunsigned long flags;\r\nspin_lock_irqsave(&devpriv->mite_channel_lock, flags);\r\nring = devpriv->ring[counter->chip_index][counter->counter_index];\r\nmite_chan = mite_request_channel(devpriv->mite, ring);\r\nif (!mite_chan) {\r\nspin_unlock_irqrestore(&devpriv->mite_channel_lock, flags);\r\ndev_err(dev->class_dev,\r\n"failed to reserve mite dma channel for counter\n");\r\nreturn -EBUSY;\r\n}\r\nmite_chan->dir = direction;\r\nni_tio_set_mite_channel(counter, mite_chan);\r\nni_660x_set_dma_channel(dev, mite_chan->channel, counter);\r\nspin_unlock_irqrestore(&devpriv->mite_channel_lock, flags);\r\nreturn 0;\r\n}\r\nstatic void ni_660x_release_mite_channel(struct comedi_device *dev,\r\nstruct ni_gpct *counter)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned long flags;\r\nspin_lock_irqsave(&devpriv->mite_channel_lock, flags);\r\nif (counter->mite_chan) {\r\nstruct mite_channel *mite_chan = counter->mite_chan;\r\nni_660x_unset_dma_channel(dev, mite_chan->channel, counter);\r\nni_tio_set_mite_channel(counter, NULL);\r\nmite_release_channel(mite_chan);\r\n}\r\nspin_unlock_irqrestore(&devpriv->mite_channel_lock, flags);\r\n}\r\nstatic int ni_660x_cmd(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nstruct ni_gpct *counter = s->private;\r\nint retval;\r\nretval = ni_660x_request_mite_channel(dev, counter, COMEDI_INPUT);\r\nif (retval) {\r\ndev_err(dev->class_dev,\r\n"no dma channel available for use by counter\n");\r\nreturn retval;\r\n}\r\nni_tio_acknowledge(counter);\r\nreturn ni_tio_cmd(dev, s);\r\n}\r\nstatic int ni_660x_cancel(struct comedi_device *dev, struct comedi_subdevice *s)\r\n{\r\nstruct ni_gpct *counter = s->private;\r\nint retval;\r\nretval = ni_tio_cancel(counter);\r\nni_660x_release_mite_channel(dev, counter);\r\nreturn retval;\r\n}\r\nstatic void set_tio_counterswap(struct comedi_device *dev, int chip)\r\n{\r\nunsigned int bits = 0;\r\nif (chip)\r\nbits = NI660X_CLK_CFG_COUNTER_SWAP;\r\nni_660x_write(dev, chip, bits, NI660X_CLK_CFG);\r\n}\r\nstatic void ni_660x_handle_gpct_interrupt(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_gpct *counter = s->private;\r\nni_tio_handle_interrupt(counter, s);\r\ncomedi_handle_events(dev, s);\r\n}\r\nstatic irqreturn_t ni_660x_interrupt(int irq, void *d)\r\n{\r\nstruct comedi_device *dev = d;\r\nstruct ni_660x_private *devpriv = dev->private;\r\nstruct comedi_subdevice *s;\r\nunsigned int i;\r\nunsigned long flags;\r\nif (!dev->attached)\r\nreturn IRQ_NONE;\r\nsmp_mb();\r\nspin_lock_irqsave(&devpriv->interrupt_lock, flags);\r\nfor (i = 0; i < dev->n_subdevices; ++i) {\r\ns = &dev->subdevices[i];\r\nif (s->type == COMEDI_SUBD_COUNTER)\r\nni_660x_handle_gpct_interrupt(dev, s);\r\n}\r\nspin_unlock_irqrestore(&devpriv->interrupt_lock, flags);\r\nreturn IRQ_HANDLED;\r\n}\r\nstatic int ni_660x_input_poll(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nstruct ni_gpct *counter = s->private;\r\nunsigned long flags;\r\nspin_lock_irqsave(&devpriv->interrupt_lock, flags);\r\nmite_sync_dma(counter->mite_chan, s);\r\nspin_unlock_irqrestore(&devpriv->interrupt_lock, flags);\r\nreturn comedi_buf_read_n_available(s);\r\n}\r\nstatic int ni_660x_buf_change(struct comedi_device *dev,\r\nstruct comedi_subdevice *s)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nstruct ni_gpct *counter = s->private;\r\nstruct mite_ring *ring;\r\nint ret;\r\nring = devpriv->ring[counter->chip_index][counter->counter_index];\r\nret = mite_buf_change(ring, s);\r\nif (ret < 0)\r\nreturn ret;\r\nreturn 0;\r\n}\r\nstatic int ni_660x_allocate_private(struct comedi_device *dev)\r\n{\r\nstruct ni_660x_private *devpriv;\r\nunsigned int i;\r\ndevpriv = comedi_alloc_devpriv(dev, sizeof(*devpriv));\r\nif (!devpriv)\r\nreturn -ENOMEM;\r\nspin_lock_init(&devpriv->mite_channel_lock);\r\nspin_lock_init(&devpriv->interrupt_lock);\r\nfor (i = 0; i < NI660X_NUM_PFI_CHANNELS; ++i)\r\ndevpriv->io_cfg[i] = NI_660X_PFI_OUTPUT_COUNTER;\r\nreturn 0;\r\n}\r\nstatic int ni_660x_alloc_mite_rings(struct comedi_device *dev)\r\n{\r\nconst struct ni_660x_board *board = dev->board_ptr;\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned int i;\r\nunsigned int j;\r\nfor (i = 0; i < board->n_chips; ++i) {\r\nfor (j = 0; j < NI660X_COUNTERS_PER_CHIP; ++j) {\r\ndevpriv->ring[i][j] = mite_alloc_ring(devpriv->mite);\r\nif (!devpriv->ring[i][j])\r\nreturn -ENOMEM;\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic void ni_660x_free_mite_rings(struct comedi_device *dev)\r\n{\r\nconst struct ni_660x_board *board = dev->board_ptr;\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned int i;\r\nunsigned int j;\r\nfor (i = 0; i < board->n_chips; ++i) {\r\nfor (j = 0; j < NI660X_COUNTERS_PER_CHIP; ++j)\r\nmite_free_ring(devpriv->ring[i][j]);\r\n}\r\n}\r\nstatic int ni_660x_dio_insn_bits(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nunsigned int shift = CR_CHAN(insn->chanspec);\r\nunsigned int mask = data[0] << shift;\r\nunsigned int bits = data[1] << shift;\r\nif (mask) {\r\ns->state &= ~mask;\r\ns->state |= (bits & mask);\r\nni_660x_write(dev, 0, s->state, NI660X_DIO32_OUTPUT);\r\n}\r\ndata[1] = ni_660x_read(dev, 0, NI660X_DIO32_INPUT) >> shift;\r\nreturn insn->n;\r\n}\r\nstatic void ni_660x_select_pfi_output(struct comedi_device *dev,\r\nunsigned int chan, unsigned int out_sel)\r\n{\r\nconst struct ni_660x_board *board = dev->board_ptr;\r\nunsigned int active_chip = 0;\r\nunsigned int idle_chip = 0;\r\nunsigned int bits;\r\nif (board->n_chips > 1) {\r\nif (out_sel == NI_660X_PFI_OUTPUT_COUNTER &&\r\nchan >= 8 && chan <= 23) {\r\nactive_chip = 1;\r\nidle_chip = 0;\r\n} else {\r\nactive_chip = 0;\r\nidle_chip = 1;\r\n}\r\n}\r\nif (idle_chip != active_chip) {\r\nbits = ni_660x_read(dev, idle_chip, NI660X_IO_CFG(chan));\r\nbits &= ~NI660X_IO_CFG_OUT_SEL_MASK(chan);\r\nbits |= NI660X_IO_CFG_OUT_SEL(chan, 0);\r\nni_660x_write(dev, idle_chip, bits, NI660X_IO_CFG(chan));\r\n}\r\nbits = ni_660x_read(dev, active_chip, NI660X_IO_CFG(chan));\r\nbits &= ~NI660X_IO_CFG_OUT_SEL_MASK(chan);\r\nbits |= NI660X_IO_CFG_OUT_SEL(chan, out_sel);\r\nni_660x_write(dev, active_chip, bits, NI660X_IO_CFG(chan));\r\n}\r\nstatic int ni_660x_set_pfi_routing(struct comedi_device *dev,\r\nunsigned int chan, unsigned int source)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nswitch (source) {\r\ncase NI_660X_PFI_OUTPUT_COUNTER:\r\nif (chan < 8)\r\nreturn -EINVAL;\r\nbreak;\r\ncase NI_660X_PFI_OUTPUT_DIO:\r\nif (chan > 31)\r\nreturn -EINVAL;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\ndevpriv->io_cfg[chan] = source;\r\nif (devpriv->io_dir & (1ULL << chan))\r\nni_660x_select_pfi_output(dev, chan, devpriv->io_cfg[chan]);\r\nreturn 0;\r\n}\r\nstatic int ni_660x_dio_insn_config(struct comedi_device *dev,\r\nstruct comedi_subdevice *s,\r\nstruct comedi_insn *insn,\r\nunsigned int *data)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned int chan = CR_CHAN(insn->chanspec);\r\nu64 bit = 1ULL << chan;\r\nunsigned int val;\r\nint ret;\r\nswitch (data[0]) {\r\ncase INSN_CONFIG_DIO_OUTPUT:\r\ndevpriv->io_dir |= bit;\r\nni_660x_select_pfi_output(dev, chan, devpriv->io_cfg[chan]);\r\nbreak;\r\ncase INSN_CONFIG_DIO_INPUT:\r\ndevpriv->io_dir &= ~bit;\r\nni_660x_select_pfi_output(dev, chan, 0);\r\nbreak;\r\ncase INSN_CONFIG_DIO_QUERY:\r\ndata[1] = (devpriv->io_dir & bit) ? COMEDI_OUTPUT\r\n: COMEDI_INPUT;\r\nbreak;\r\ncase INSN_CONFIG_SET_ROUTING:\r\nret = ni_660x_set_pfi_routing(dev, chan, data[1]);\r\nif (ret)\r\nreturn ret;\r\nbreak;\r\ncase INSN_CONFIG_GET_ROUTING:\r\ndata[1] = devpriv->io_cfg[chan];\r\nbreak;\r\ncase INSN_CONFIG_FILTER:\r\nval = ni_660x_read(dev, 0, NI660X_IO_CFG(chan));\r\nval &= ~NI660X_IO_CFG_IN_SEL_MASK(chan);\r\nval |= NI660X_IO_CFG_IN_SEL(chan, data[1]);\r\nni_660x_write(dev, 0, val, NI660X_IO_CFG(chan));\r\nbreak;\r\ndefault:\r\nreturn -EINVAL;\r\n}\r\nreturn insn->n;\r\n}\r\nstatic void ni_660x_init_tio_chips(struct comedi_device *dev,\r\nunsigned int n_chips)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nunsigned int chip;\r\nunsigned int chan;\r\nni_660x_write(dev, 0, 0, NI660X_STC_DIO_CONTROL);\r\nfor (chip = 0; chip < n_chips; ++chip) {\r\ndevpriv->dma_cfg[chip] = 0;\r\nfor (chan = 0; chan < NI660X_MAX_DMA_CHANNEL; ++chan)\r\ndevpriv->dma_cfg[chip] |= NI660X_DMA_CFG_SEL_NONE(chan);\r\nni_660x_write(dev, chip, devpriv->dma_cfg[chip],\r\nNI660X_DMA_CFG);\r\nfor (chan = 0; chan < NI660X_NUM_PFI_CHANNELS; ++chan)\r\nni_660x_write(dev, chip, 0, NI660X_IO_CFG(chan));\r\n}\r\n}\r\nstatic int ni_660x_auto_attach(struct comedi_device *dev,\r\nunsigned long context)\r\n{\r\nstruct pci_dev *pcidev = comedi_to_pci_dev(dev);\r\nconst struct ni_660x_board *board = NULL;\r\nstruct ni_660x_private *devpriv;\r\nstruct comedi_subdevice *s;\r\nstruct ni_gpct_device *gpct_dev;\r\nunsigned int n_counters;\r\nint subdev;\r\nint ret;\r\nunsigned int i;\r\nunsigned int global_interrupt_config_bits;\r\nif (context < ARRAY_SIZE(ni_660x_boards))\r\nboard = &ni_660x_boards[context];\r\nif (!board)\r\nreturn -ENODEV;\r\ndev->board_ptr = board;\r\ndev->board_name = board->name;\r\nret = comedi_pci_enable(dev);\r\nif (ret)\r\nreturn ret;\r\nret = ni_660x_allocate_private(dev);\r\nif (ret < 0)\r\nreturn ret;\r\ndevpriv = dev->private;\r\ndevpriv->mite = mite_attach(dev, true);\r\nif (!devpriv->mite)\r\nreturn -ENOMEM;\r\nret = ni_660x_alloc_mite_rings(dev);\r\nif (ret < 0)\r\nreturn ret;\r\nni_660x_init_tio_chips(dev, board->n_chips);\r\nn_counters = board->n_chips * NI660X_COUNTERS_PER_CHIP;\r\ngpct_dev = ni_gpct_device_construct(dev,\r\nni_660x_gpct_write,\r\nni_660x_gpct_read,\r\nni_gpct_variant_660x,\r\nn_counters);\r\nif (!gpct_dev)\r\nreturn -ENOMEM;\r\ndevpriv->counter_dev = gpct_dev;\r\nret = comedi_alloc_subdevices(dev, 2 + NI660X_MAX_COUNTERS);\r\nif (ret)\r\nreturn ret;\r\nsubdev = 0;\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_UNUSED;\r\ns = &dev->subdevices[subdev++];\r\ns->type = COMEDI_SUBD_DIO;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE;\r\ns->n_chan = NI660X_NUM_PFI_CHANNELS;\r\ns->maxdata = 1;\r\ns->range_table = &range_digital;\r\ns->insn_bits = ni_660x_dio_insn_bits;\r\ns->insn_config = ni_660x_dio_insn_config;\r\nfor (i = 0; i < s->n_chan; ++i) {\r\nunsigned int source = (i < 8) ? NI_660X_PFI_OUTPUT_DIO\r\n: NI_660X_PFI_OUTPUT_COUNTER;\r\nni_660x_set_pfi_routing(dev, i, source);\r\nni_660x_select_pfi_output(dev, i, 0);\r\n}\r\nfor (i = 0; i < NI660X_MAX_COUNTERS; ++i) {\r\ns = &dev->subdevices[subdev++];\r\nif (i < n_counters) {\r\nstruct ni_gpct *counter = &gpct_dev->counters[i];\r\ncounter->chip_index = i / NI660X_COUNTERS_PER_CHIP;\r\ncounter->counter_index = i % NI660X_COUNTERS_PER_CHIP;\r\ns->type = COMEDI_SUBD_COUNTER;\r\ns->subdev_flags = SDF_READABLE | SDF_WRITABLE |\r\nSDF_LSAMPL | SDF_CMD_READ;\r\ns->n_chan = 3;\r\ns->maxdata = 0xffffffff;\r\ns->insn_read = ni_tio_insn_read;\r\ns->insn_write = ni_tio_insn_write;\r\ns->insn_config = ni_tio_insn_config;\r\ns->len_chanlist = 1;\r\ns->do_cmd = ni_660x_cmd;\r\ns->do_cmdtest = ni_tio_cmdtest;\r\ns->cancel = ni_660x_cancel;\r\ns->poll = ni_660x_input_poll;\r\ns->buf_change = ni_660x_buf_change;\r\ns->async_dma_dir = DMA_BIDIRECTIONAL;\r\ns->private = counter;\r\nni_tio_init_counter(counter);\r\n} else {\r\ns->type = COMEDI_SUBD_UNUSED;\r\n}\r\n}\r\nfor (i = 0; i < board->n_chips; ++i)\r\nset_tio_counterswap(dev, i);\r\nret = request_irq(pcidev->irq, ni_660x_interrupt, IRQF_SHARED,\r\ndev->board_name, dev);\r\nif (ret < 0) {\r\ndev_warn(dev->class_dev, " irq not available\n");\r\nreturn ret;\r\n}\r\ndev->irq = pcidev->irq;\r\nglobal_interrupt_config_bits = NI660X_GLOBAL_INT_GLOBAL;\r\nif (board->n_chips > 1)\r\nglobal_interrupt_config_bits |= NI660X_GLOBAL_INT_CASCADE;\r\nni_660x_write(dev, 0, global_interrupt_config_bits,\r\nNI660X_GLOBAL_INT_CFG);\r\nreturn 0;\r\n}\r\nstatic void ni_660x_detach(struct comedi_device *dev)\r\n{\r\nstruct ni_660x_private *devpriv = dev->private;\r\nif (dev->irq) {\r\nni_660x_write(dev, 0, 0, NI660X_GLOBAL_INT_CFG);\r\nfree_irq(dev->irq, dev);\r\n}\r\nif (devpriv) {\r\nni_gpct_device_destroy(devpriv->counter_dev);\r\nni_660x_free_mite_rings(dev);\r\nmite_detach(devpriv->mite);\r\n}\r\nif (dev->mmio)\r\niounmap(dev->mmio);\r\ncomedi_pci_disable(dev);\r\n}\r\nstatic int ni_660x_pci_probe(struct pci_dev *dev,\r\nconst struct pci_device_id *id)\r\n{\r\nreturn comedi_pci_auto_config(dev, &ni_660x_driver, id->driver_data);\r\n}

static int lpc18xx_wdt_feed(struct watchdog_device *wdt_dev)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = watchdog_get_drvdata(wdt_dev);\r\nunsigned long flags;\r\nspin_lock_irqsave(&lpc18xx_wdt->lock, flags);\r\nwritel(LPC18XX_WDT_FEED_MAGIC1, lpc18xx_wdt->base + LPC18XX_WDT_FEED);\r\nwritel(LPC18XX_WDT_FEED_MAGIC2, lpc18xx_wdt->base + LPC18XX_WDT_FEED);\r\nspin_unlock_irqrestore(&lpc18xx_wdt->lock, flags);\r\nreturn 0;\r\n}\r\nstatic void lpc18xx_wdt_timer_feed(unsigned long data)\r\n{\r\nstruct watchdog_device *wdt_dev = (struct watchdog_device *)data;\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = watchdog_get_drvdata(wdt_dev);\r\nlpc18xx_wdt_feed(wdt_dev);\r\nmod_timer(&lpc18xx_wdt->timer, jiffies +\r\nmsecs_to_jiffies((wdt_dev->timeout * MSEC_PER_SEC) / 2));\r\n}\r\nstatic int lpc18xx_wdt_stop(struct watchdog_device *wdt_dev)\r\n{\r\nlpc18xx_wdt_timer_feed((unsigned long)wdt_dev);\r\nreturn 0;\r\n}\r\nstatic void __lpc18xx_wdt_set_timeout(struct lpc18xx_wdt_dev *lpc18xx_wdt)\r\n{\r\nunsigned int val;\r\nval = DIV_ROUND_UP(lpc18xx_wdt->wdt_dev.timeout * lpc18xx_wdt->clk_rate,\r\nLPC18XX_WDT_CLK_DIV);\r\nwritel(val, lpc18xx_wdt->base + LPC18XX_WDT_TC);\r\n}\r\nstatic int lpc18xx_wdt_set_timeout(struct watchdog_device *wdt_dev,\r\nunsigned int new_timeout)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = watchdog_get_drvdata(wdt_dev);\r\nlpc18xx_wdt->wdt_dev.timeout = new_timeout;\r\n__lpc18xx_wdt_set_timeout(lpc18xx_wdt);\r\nreturn 0;\r\n}\r\nstatic unsigned int lpc18xx_wdt_get_timeleft(struct watchdog_device *wdt_dev)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = watchdog_get_drvdata(wdt_dev);\r\nunsigned int val;\r\nval = readl(lpc18xx_wdt->base + LPC18XX_WDT_TV);\r\nreturn (val * LPC18XX_WDT_CLK_DIV) / lpc18xx_wdt->clk_rate;\r\n}\r\nstatic int lpc18xx_wdt_start(struct watchdog_device *wdt_dev)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = watchdog_get_drvdata(wdt_dev);\r\nunsigned int val;\r\nif (timer_pending(&lpc18xx_wdt->timer))\r\ndel_timer(&lpc18xx_wdt->timer);\r\nval = readl(lpc18xx_wdt->base + LPC18XX_WDT_MOD);\r\nval |= LPC18XX_WDT_MOD_WDEN;\r\nval |= LPC18XX_WDT_MOD_WDRESET;\r\nwritel(val, lpc18xx_wdt->base + LPC18XX_WDT_MOD);\r\nlpc18xx_wdt_feed(wdt_dev);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_wdt_restart(struct watchdog_device *wdt_dev,\r\nunsigned long action, void *data)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = watchdog_get_drvdata(wdt_dev);\r\nunsigned long flags;\r\nint val;\r\nspin_lock_irqsave(&lpc18xx_wdt->lock, flags);\r\nval = readl(lpc18xx_wdt->base + LPC18XX_WDT_MOD);\r\nval |= LPC18XX_WDT_MOD_WDEN;\r\nval |= LPC18XX_WDT_MOD_WDRESET;\r\nwritel(val, lpc18xx_wdt->base + LPC18XX_WDT_MOD);\r\nwritel(LPC18XX_WDT_FEED_MAGIC1, lpc18xx_wdt->base + LPC18XX_WDT_FEED);\r\nwritel(LPC18XX_WDT_FEED_MAGIC2, lpc18xx_wdt->base + LPC18XX_WDT_FEED);\r\nwritel(LPC18XX_WDT_FEED_MAGIC1, lpc18xx_wdt->base + LPC18XX_WDT_FEED);\r\nwritel(LPC18XX_WDT_FEED_MAGIC1, lpc18xx_wdt->base + LPC18XX_WDT_FEED);\r\nspin_unlock_irqrestore(&lpc18xx_wdt->lock, flags);\r\nreturn 0;\r\n}\r\nstatic int lpc18xx_wdt_probe(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt;\r\nstruct device *dev = &pdev->dev;\r\nstruct resource *res;\r\nint ret;\r\nlpc18xx_wdt = devm_kzalloc(dev, sizeof(*lpc18xx_wdt), GFP_KERNEL);\r\nif (!lpc18xx_wdt)\r\nreturn -ENOMEM;\r\nres = platform_get_resource(pdev, IORESOURCE_MEM, 0);\r\nlpc18xx_wdt->base = devm_ioremap_resource(dev, res);\r\nif (IS_ERR(lpc18xx_wdt->base))\r\nreturn PTR_ERR(lpc18xx_wdt->base);\r\nlpc18xx_wdt->reg_clk = devm_clk_get(dev, "reg");\r\nif (IS_ERR(lpc18xx_wdt->reg_clk)) {\r\ndev_err(dev, "failed to get the reg clock\n");\r\nreturn PTR_ERR(lpc18xx_wdt->reg_clk);\r\n}\r\nlpc18xx_wdt->wdt_clk = devm_clk_get(dev, "wdtclk");\r\nif (IS_ERR(lpc18xx_wdt->wdt_clk)) {\r\ndev_err(dev, "failed to get the wdt clock\n");\r\nreturn PTR_ERR(lpc18xx_wdt->wdt_clk);\r\n}\r\nret = clk_prepare_enable(lpc18xx_wdt->reg_clk);\r\nif (ret) {\r\ndev_err(dev, "could not prepare or enable sys clock\n");\r\nreturn ret;\r\n}\r\nret = clk_prepare_enable(lpc18xx_wdt->wdt_clk);\r\nif (ret) {\r\ndev_err(dev, "could not prepare or enable wdt clock\n");\r\ngoto disable_reg_clk;\r\n}\r\nlpc18xx_wdt->clk_rate = clk_get_rate(lpc18xx_wdt->wdt_clk);\r\nif (lpc18xx_wdt->clk_rate == 0) {\r\ndev_err(dev, "failed to get clock rate\n");\r\nret = -EINVAL;\r\ngoto disable_wdt_clk;\r\n}\r\nlpc18xx_wdt->wdt_dev.info = &lpc18xx_wdt_info;\r\nlpc18xx_wdt->wdt_dev.ops = &lpc18xx_wdt_ops;\r\nlpc18xx_wdt->wdt_dev.min_timeout = DIV_ROUND_UP(LPC18XX_WDT_TC_MIN *\r\nLPC18XX_WDT_CLK_DIV, lpc18xx_wdt->clk_rate);\r\nlpc18xx_wdt->wdt_dev.max_timeout = (LPC18XX_WDT_TC_MAX *\r\nLPC18XX_WDT_CLK_DIV) / lpc18xx_wdt->clk_rate;\r\nlpc18xx_wdt->wdt_dev.timeout = min(lpc18xx_wdt->wdt_dev.max_timeout,\r\nLPC18XX_WDT_DEF_TIMEOUT);\r\nspin_lock_init(&lpc18xx_wdt->lock);\r\nlpc18xx_wdt->wdt_dev.parent = dev;\r\nwatchdog_set_drvdata(&lpc18xx_wdt->wdt_dev, lpc18xx_wdt);\r\nret = watchdog_init_timeout(&lpc18xx_wdt->wdt_dev, heartbeat, dev);\r\n__lpc18xx_wdt_set_timeout(lpc18xx_wdt);\r\nsetup_timer(&lpc18xx_wdt->timer, lpc18xx_wdt_timer_feed,\r\n(unsigned long)&lpc18xx_wdt->wdt_dev);\r\nwatchdog_set_nowayout(&lpc18xx_wdt->wdt_dev, nowayout);\r\nwatchdog_set_restart_priority(&lpc18xx_wdt->wdt_dev, 128);\r\nplatform_set_drvdata(pdev, lpc18xx_wdt);\r\nret = watchdog_register_device(&lpc18xx_wdt->wdt_dev);\r\nif (ret)\r\ngoto disable_wdt_clk;\r\nreturn 0;\r\ndisable_wdt_clk:\r\nclk_disable_unprepare(lpc18xx_wdt->wdt_clk);\r\ndisable_reg_clk:\r\nclk_disable_unprepare(lpc18xx_wdt->reg_clk);\r\nreturn ret;\r\n}\r\nstatic void lpc18xx_wdt_shutdown(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = platform_get_drvdata(pdev);\r\nlpc18xx_wdt_stop(&lpc18xx_wdt->wdt_dev);\r\n}\r\nstatic int lpc18xx_wdt_remove(struct platform_device *pdev)\r\n{\r\nstruct lpc18xx_wdt_dev *lpc18xx_wdt = platform_get_drvdata(pdev);\r\ndev_warn(&pdev->dev, "I quit now, hardware will probably reboot!\n");\r\ndel_timer(&lpc18xx_wdt->timer);\r\nwatchdog_unregister_device(&lpc18xx_wdt->wdt_dev);\r\nclk_disable_unprepare(lpc18xx_wdt->wdt_clk);\r\nclk_disable_unprepare(lpc18xx_wdt->reg_clk);\r\nreturn 0;\r\n}

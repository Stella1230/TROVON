int radeon_ib_get(struct radeon_device *rdev, int ring,\r\nstruct radeon_ib *ib, struct radeon_vm *vm,\r\nunsigned size)\r\n{\r\nint r;\r\nr = radeon_sa_bo_new(rdev, &rdev->ring_tmp_bo, &ib->sa_bo, size, 256);\r\nif (r) {\r\ndev_err(rdev->dev, "failed to get a new IB (%d)\n", r);\r\nreturn r;\r\n}\r\nradeon_sync_create(&ib->sync);\r\nib->ring = ring;\r\nib->fence = NULL;\r\nib->ptr = radeon_sa_bo_cpu_addr(ib->sa_bo);\r\nib->vm = vm;\r\nif (vm) {\r\nib->gpu_addr = ib->sa_bo->soffset + RADEON_VA_IB_OFFSET;\r\n} else {\r\nib->gpu_addr = radeon_sa_bo_gpu_addr(ib->sa_bo);\r\n}\r\nib->is_const_ib = false;\r\nreturn 0;\r\n}\r\nvoid radeon_ib_free(struct radeon_device *rdev, struct radeon_ib *ib)\r\n{\r\nradeon_sync_free(rdev, &ib->sync, ib->fence);\r\nradeon_sa_bo_free(rdev, &ib->sa_bo, ib->fence);\r\nradeon_fence_unref(&ib->fence);\r\n}\r\nint radeon_ib_schedule(struct radeon_device *rdev, struct radeon_ib *ib,\r\nstruct radeon_ib *const_ib, bool hdp_flush)\r\n{\r\nstruct radeon_ring *ring = &rdev->ring[ib->ring];\r\nint r = 0;\r\nif (!ib->length_dw || !ring->ready) {\r\ndev_err(rdev->dev, "couldn't schedule ib\n");\r\nreturn -EINVAL;\r\n}\r\nr = radeon_ring_lock(rdev, ring, 64 + RADEON_NUM_SYNCS * 8);\r\nif (r) {\r\ndev_err(rdev->dev, "scheduling IB failed (%d).\n", r);\r\nreturn r;\r\n}\r\nif (ib->vm) {\r\nstruct radeon_fence *vm_id_fence;\r\nvm_id_fence = radeon_vm_grab_id(rdev, ib->vm, ib->ring);\r\nradeon_sync_fence(&ib->sync, vm_id_fence);\r\n}\r\nr = radeon_sync_rings(rdev, &ib->sync, ib->ring);\r\nif (r) {\r\ndev_err(rdev->dev, "failed to sync rings (%d)\n", r);\r\nradeon_ring_unlock_undo(rdev, ring);\r\nreturn r;\r\n}\r\nif (ib->vm)\r\nradeon_vm_flush(rdev, ib->vm, ib->ring,\r\nib->sync.last_vm_update);\r\nif (const_ib) {\r\nradeon_ring_ib_execute(rdev, const_ib->ring, const_ib);\r\nradeon_sync_free(rdev, &const_ib->sync, NULL);\r\n}\r\nradeon_ring_ib_execute(rdev, ib->ring, ib);\r\nr = radeon_fence_emit(rdev, &ib->fence, ib->ring);\r\nif (r) {\r\ndev_err(rdev->dev, "failed to emit fence for new IB (%d)\n", r);\r\nradeon_ring_unlock_undo(rdev, ring);\r\nreturn r;\r\n}\r\nif (const_ib) {\r\nconst_ib->fence = radeon_fence_ref(ib->fence);\r\n}\r\nif (ib->vm)\r\nradeon_vm_fence(rdev, ib->vm, ib->fence);\r\nradeon_ring_unlock_commit(rdev, ring, hdp_flush);\r\nreturn 0;\r\n}\r\nint radeon_ib_pool_init(struct radeon_device *rdev)\r\n{\r\nint r;\r\nif (rdev->ib_pool_ready) {\r\nreturn 0;\r\n}\r\nif (rdev->family >= CHIP_BONAIRE) {\r\nr = radeon_sa_bo_manager_init(rdev, &rdev->ring_tmp_bo,\r\nRADEON_IB_POOL_SIZE*64*1024,\r\nRADEON_GPU_PAGE_SIZE,\r\nRADEON_GEM_DOMAIN_GTT,\r\nRADEON_GEM_GTT_WC);\r\n} else {\r\nr = radeon_sa_bo_manager_init(rdev, &rdev->ring_tmp_bo,\r\nRADEON_IB_POOL_SIZE*64*1024,\r\nRADEON_GPU_PAGE_SIZE,\r\nRADEON_GEM_DOMAIN_GTT, 0);\r\n}\r\nif (r) {\r\nreturn r;\r\n}\r\nr = radeon_sa_bo_manager_start(rdev, &rdev->ring_tmp_bo);\r\nif (r) {\r\nreturn r;\r\n}\r\nrdev->ib_pool_ready = true;\r\nif (radeon_debugfs_sa_init(rdev)) {\r\ndev_err(rdev->dev, "failed to register debugfs file for SA\n");\r\n}\r\nreturn 0;\r\n}\r\nvoid radeon_ib_pool_fini(struct radeon_device *rdev)\r\n{\r\nif (rdev->ib_pool_ready) {\r\nradeon_sa_bo_manager_suspend(rdev, &rdev->ring_tmp_bo);\r\nradeon_sa_bo_manager_fini(rdev, &rdev->ring_tmp_bo);\r\nrdev->ib_pool_ready = false;\r\n}\r\n}\r\nint radeon_ib_ring_tests(struct radeon_device *rdev)\r\n{\r\nunsigned i;\r\nint r;\r\nfor (i = 0; i < RADEON_NUM_RINGS; ++i) {\r\nstruct radeon_ring *ring = &rdev->ring[i];\r\nif (!ring->ready)\r\ncontinue;\r\nr = radeon_ib_test(rdev, i, ring);\r\nif (r) {\r\nradeon_fence_driver_force_completion(rdev, i);\r\nring->ready = false;\r\nrdev->needs_reset = false;\r\nif (i == RADEON_RING_TYPE_GFX_INDEX) {\r\nDRM_ERROR("radeon: failed testing IB on GFX ring (%d).\n", r);\r\nrdev->accel_working = false;\r\nreturn r;\r\n} else {\r\nDRM_ERROR("radeon: failed testing IB on ring %d (%d).\n", i, r);\r\n}\r\n}\r\n}\r\nreturn 0;\r\n}\r\nstatic int radeon_debugfs_sa_info(struct seq_file *m, void *data)\r\n{\r\nstruct drm_info_node *node = (struct drm_info_node *) m->private;\r\nstruct drm_device *dev = node->minor->dev;\r\nstruct radeon_device *rdev = dev->dev_private;\r\nradeon_sa_bo_dump_debug_info(&rdev->ring_tmp_bo, m);\r\nreturn 0;\r\n}\r\nstatic int radeon_debugfs_sa_init(struct radeon_device *rdev)\r\n{\r\n#if defined(CONFIG_DEBUG_FS)\r\nreturn radeon_debugfs_add_files(rdev, radeon_debugfs_sa_list, 1);\r\n#else\r\nreturn 0;\r\n#endif\r\n}

struct sg_table *amdgpu_gem_prime_get_sg_table(struct drm_gem_object *obj)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(obj);\r\nint npages = bo->tbo.num_pages;\r\nreturn drm_prime_pages_to_sg(bo->tbo.ttm->pages, npages);\r\n}\r\nvoid *amdgpu_gem_prime_vmap(struct drm_gem_object *obj)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(obj);\r\nint ret;\r\nret = ttm_bo_kmap(&bo->tbo, 0, bo->tbo.num_pages,\r\n&bo->dma_buf_vmap);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nreturn bo->dma_buf_vmap.virtual;\r\n}\r\nvoid amdgpu_gem_prime_vunmap(struct drm_gem_object *obj, void *vaddr)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(obj);\r\nttm_bo_kunmap(&bo->dma_buf_vmap);\r\n}\r\nstruct drm_gem_object *\r\namdgpu_gem_prime_import_sg_table(struct drm_device *dev,\r\nstruct dma_buf_attachment *attach,\r\nstruct sg_table *sg)\r\n{\r\nstruct reservation_object *resv = attach->dmabuf->resv;\r\nstruct amdgpu_device *adev = dev->dev_private;\r\nstruct amdgpu_bo *bo;\r\nint ret;\r\nww_mutex_lock(&resv->lock, NULL);\r\nret = amdgpu_bo_create(adev, attach->dmabuf->size, PAGE_SIZE, false,\r\nAMDGPU_GEM_DOMAIN_GTT, 0, sg, resv, &bo);\r\nww_mutex_unlock(&resv->lock);\r\nif (ret)\r\nreturn ERR_PTR(ret);\r\nreturn &bo->gem_base;\r\n}\r\nint amdgpu_gem_prime_pin(struct drm_gem_object *obj)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(obj);\r\nint ret = 0;\r\nret = amdgpu_bo_reserve(bo, false);\r\nif (unlikely(ret != 0))\r\nreturn ret;\r\nret = amdgpu_bo_pin(bo, AMDGPU_GEM_DOMAIN_GTT, NULL);\r\namdgpu_bo_unreserve(bo);\r\nreturn ret;\r\n}\r\nvoid amdgpu_gem_prime_unpin(struct drm_gem_object *obj)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(obj);\r\nint ret = 0;\r\nret = amdgpu_bo_reserve(bo, false);\r\nif (unlikely(ret != 0))\r\nreturn;\r\namdgpu_bo_unpin(bo);\r\namdgpu_bo_unreserve(bo);\r\n}\r\nstruct reservation_object *amdgpu_gem_prime_res_obj(struct drm_gem_object *obj)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(obj);\r\nreturn bo->tbo.resv;\r\n}\r\nstruct dma_buf *amdgpu_gem_prime_export(struct drm_device *dev,\r\nstruct drm_gem_object *gobj,\r\nint flags)\r\n{\r\nstruct amdgpu_bo *bo = gem_to_amdgpu_bo(gobj);\r\nif (amdgpu_ttm_tt_get_usermm(bo->tbo.ttm))\r\nreturn ERR_PTR(-EPERM);\r\nreturn drm_gem_prime_export(dev, gobj, flags);\r\n}

void __hyp_text __timer_save_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct arch_timer_cpu *timer = &vcpu->arch.timer_cpu;\r\nu64 val;\r\nif (timer->enabled) {\r\ntimer->cntv_ctl = read_sysreg_el0(cntv_ctl);\r\ntimer->cntv_cval = read_sysreg_el0(cntv_cval);\r\n}\r\nwrite_sysreg_el0(0, cntv_ctl);\r\nval = read_sysreg(cnthctl_el2);\r\nval |= CNTHCTL_EL1PCTEN | CNTHCTL_EL1PCEN;\r\nwrite_sysreg(val, cnthctl_el2);\r\nwrite_sysreg(0, cntvoff_el2);\r\n}\r\nvoid __hyp_text __timer_restore_state(struct kvm_vcpu *vcpu)\r\n{\r\nstruct kvm *kvm = kern_hyp_va(vcpu->kvm);\r\nstruct arch_timer_cpu *timer = &vcpu->arch.timer_cpu;\r\nu64 val;\r\nval = read_sysreg(cnthctl_el2);\r\nval &= ~CNTHCTL_EL1PCEN;\r\nval |= CNTHCTL_EL1PCTEN;\r\nwrite_sysreg(val, cnthctl_el2);\r\nif (timer->enabled) {\r\nwrite_sysreg(kvm->arch.timer.cntvoff, cntvoff_el2);\r\nwrite_sysreg_el0(timer->cntv_cval, cntv_cval);\r\nisb();\r\nwrite_sysreg_el0(timer->cntv_ctl, cntv_ctl);\r\n}\r\n}

int __cvmx_helper_spi_enumerate(int interface)\r\n{\r\nif ((cvmx_sysinfo_get()->board_type != CVMX_BOARD_TYPE_SIM) &&\r\ncvmx_spi4000_is_present(interface)) {\r\nreturn 10;\r\n} else {\r\nreturn 16;\r\n}\r\n}\r\nint __cvmx_helper_spi_probe(int interface)\r\n{\r\nint num_ports = 0;\r\nif ((cvmx_sysinfo_get()->board_type != CVMX_BOARD_TYPE_SIM) &&\r\ncvmx_spi4000_is_present(interface)) {\r\nnum_ports = 10;\r\n} else {\r\nunion cvmx_pko_reg_crc_enable enable;\r\nnum_ports = 16;\r\nenable.u64 = cvmx_read_csr(CVMX_PKO_REG_CRC_ENABLE);\r\nenable.s.enable |= 0xffff << (interface * 16);\r\ncvmx_write_csr(CVMX_PKO_REG_CRC_ENABLE, enable.u64);\r\n}\r\n__cvmx_helper_setup_gmx(interface, num_ports);\r\nreturn num_ports;\r\n}\r\nint __cvmx_helper_spi_enable(int interface)\r\n{\r\nint num_ports = cvmx_helper_ports_on_interface(interface);\r\nint ipd_port;\r\nfor (ipd_port = interface * 16; ipd_port < interface * 16 + num_ports;\r\nipd_port++) {\r\nunion cvmx_pip_prt_cfgx port_config;\r\nport_config.u64 = cvmx_read_csr(CVMX_PIP_PRT_CFGX(ipd_port));\r\nport_config.s.crc_en = 1;\r\ncvmx_write_csr(CVMX_PIP_PRT_CFGX(ipd_port), port_config.u64);\r\n}\r\nif (cvmx_sysinfo_get()->board_type != CVMX_BOARD_TYPE_SIM) {\r\ncvmx_spi_start_interface(interface, CVMX_SPI_MODE_DUPLEX,\r\nCVMX_HELPER_SPI_TIMEOUT, num_ports);\r\nif (cvmx_spi4000_is_present(interface))\r\ncvmx_spi4000_initialize(interface);\r\n}\r\n__cvmx_interrupt_spxx_int_msk_enable(interface);\r\n__cvmx_interrupt_stxx_int_msk_enable(interface);\r\n__cvmx_interrupt_gmxx_enable(interface);\r\nreturn 0;\r\n}\r\ncvmx_helper_link_info_t __cvmx_helper_spi_link_get(int ipd_port)\r\n{\r\ncvmx_helper_link_info_t result;\r\nint interface = cvmx_helper_get_interface_num(ipd_port);\r\nint index = cvmx_helper_get_interface_index_num(ipd_port);\r\nresult.u64 = 0;\r\nif (cvmx_sysinfo_get()->board_type == CVMX_BOARD_TYPE_SIM) {\r\nresult.s.link_up = 1;\r\nresult.s.full_duplex = 1;\r\nresult.s.speed = 10000;\r\n} else if (cvmx_spi4000_is_present(interface)) {\r\nunion cvmx_gmxx_rxx_rx_inbnd inband =\r\ncvmx_spi4000_check_speed(interface, index);\r\nresult.s.link_up = inband.s.status;\r\nresult.s.full_duplex = inband.s.duplex;\r\nswitch (inband.s.speed) {\r\ncase 0:\r\nresult.s.speed = 10;\r\nbreak;\r\ncase 1:\r\nresult.s.speed = 100;\r\nbreak;\r\ncase 2:\r\nresult.s.speed = 1000;\r\nbreak;\r\ncase 3:\r\nresult.s.speed = 0;\r\nresult.s.link_up = 0;\r\nbreak;\r\n}\r\n} else {\r\nresult.s.link_up = 1;\r\nresult.s.full_duplex = 1;\r\nresult.s.speed = 10000;\r\n}\r\nreturn result;\r\n}\r\nint __cvmx_helper_spi_link_set(int ipd_port, cvmx_helper_link_info_t link_info)\r\n{\r\nreturn 0;\r\n}

static bool\r\nebt_limit_mt(const struct sk_buff *skb, struct xt_action_param *par)\r\n{\r\nstruct ebt_limit_info *info = (void *)par->matchinfo;\r\nunsigned long now = jiffies;\r\nspin_lock_bh(&limit_lock);\r\ninfo->credit += (now - xchg(&info->prev, now)) * CREDITS_PER_JIFFY;\r\nif (info->credit > info->credit_cap)\r\ninfo->credit = info->credit_cap;\r\nif (info->credit >= info->cost) {\r\ninfo->credit -= info->cost;\r\nspin_unlock_bh(&limit_lock);\r\nreturn true;\r\n}\r\nspin_unlock_bh(&limit_lock);\r\nreturn false;\r\n}\r\nstatic u_int32_t\r\nuser2credits(u_int32_t user)\r\n{\r\nif (user > 0xFFFFFFFF / (HZ*CREDITS_PER_JIFFY))\r\nreturn (user / EBT_LIMIT_SCALE) * HZ * CREDITS_PER_JIFFY;\r\nreturn (user * HZ * CREDITS_PER_JIFFY) / EBT_LIMIT_SCALE;\r\n}\r\nstatic int ebt_limit_mt_check(const struct xt_mtchk_param *par)\r\n{\r\nstruct ebt_limit_info *info = par->matchinfo;\r\nif (info->burst == 0 ||\r\nuser2credits(info->avg * info->burst) < user2credits(info->avg)) {\r\npr_info("overflow, try lower: %u/%u\n",\r\ninfo->avg, info->burst);\r\nreturn -EINVAL;\r\n}\r\ninfo->prev = jiffies;\r\ninfo->credit = user2credits(info->avg * info->burst);\r\ninfo->credit_cap = user2credits(info->avg * info->burst);\r\ninfo->cost = user2credits(info->avg);\r\nreturn 0;\r\n}\r\nstatic int __init ebt_limit_init(void)\r\n{\r\nreturn xt_register_match(&ebt_limit_mt_reg);\r\n}\r\nstatic void __exit ebt_limit_fini(void)\r\n{\r\nxt_unregister_match(&ebt_limit_mt_reg);\r\n}
